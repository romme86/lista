// Auto-generated. Do not edit.
const chunks = ["MTAxNTU4CnsidmVyc2lvbiI6MCwiaWQiOiJkYzYyMDNlYTdkMzIxZDA0ZDhlOGE1ZDA3YmFmMmE1MTI5NjQxMGZiYWU1NzViNGIxMzE2MzZmNTYyZGZhNTZiIiwibWFpbiI6Ii9iYWNrZW5kL2JhY2tlbmQubWpzIiwiaW1wb3J0cyI6e30sInJlc29sdXRpb25zIjp7Ii9iYWNrZW5kL2JhY2tlbmQubWpzIjp7IiNwYWNrYWdlIjoiL3BhY2thZ2UuanNvbiIsIi4uL3JwYy1jb21tYW5kcy5tanMiOiIvcnBjLWNvbW1hbmRzLm1qcyIsIi4vbGliL2F1dG9iYXNlLm1qcyI6Ii9iYWNrZW5kL2xpYi9hdXRvYmFzZS5tanMiLCIuL2xpYi9lcnJvcnMubWpzIjoiL2JhY2tlbmQvbGliL2Vycm9ycy5tanMiLCIuL2xpYi9pdGVtcy5tanMiOiIvYmFja2VuZC9saWIvaXRlbXMubWpzIiwiLi9saWIva2V5cy5tanMiOiIvYmFja2VuZC9saWIva2V5cy5tanMiLCIuL2xpYi9zdGF0ZS5tanMiOiIvYmFja2VuZC9saWIvc3RhdGUubWpzIiwiLi9saWIvc3RvcmFnZS5tanMiOiIvYmFja2VuZC9saWIvc3RvcmFnZS5tanMiLCIuL2xpYi91dGlscy5tanMiOiIvYmFja2VuZC9saWIvdXRpbHMubWpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJiYXJlLXJwYyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvaW5kZXguanMiLCJiYXJlLXVybCI6Ii9ub2RlX21vZHVsZXMvYmFyZS11cmwvaW5kZXguanMifSwiL2JhY2tlbmQvbGliL2F1dG9iYXNlLm1qcyI6eyIjcGFja2FnZSI6Ii9wYWNrYWdlLmpzb24iLCIuLi8uLi9ycGMtY29tbWFuZHMubWpzIjoiL3JwYy1jb21tYW5kcy5tanMiLCIuL2Vycm9ycy5tanMiOiIvYmFja2VuZC9saWIvZXJyb3JzLm1qcyIsIi4vaXRlbXMubWpzIjoiL2JhY2tlbmQvbGliL2l0ZW1zLm1qcyIsIi4va2V5cy5tanMiOiIvYmFja2VuZC9saWIva2V5cy5tanMiLCIuL25ldHdvcmtpbmcubWpzIjoiL2JhY2tlbmQvbGliL25ldHdvcmtpbmcubWpzIiwiLi9zdGF0ZS5tanMiOiIvYmFja2VuZC9saWIvc3RhdGUubWpzIiwiLi9zdG9yYWdlLm1qcyI6Ii9iYWNrZW5kL2xpYi9zdG9yYWdlLm1qcyIsIi4vdXRpbHMubWpzIjoiL2JhY2tlbmQvbGliL3V0aWxzLm1qcyIsImF1dG9iYXNlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9pbmRleC5qcyIsImJhcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9pbmRleC5qcyIsImJhcmUtZnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvaW5kZXguanMiLCJjb3Jlc3RvcmUiOiIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9pbmRleC5qcyIsImh5cGVyc3dhcm0iOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vaW5kZXguanMifSwiL2JhY2tlbmQvbGliL2Vycm9ycy5tanMiOnsiI3BhY2thZ2UiOiIvcGFja2FnZS5qc29uIiwiLi4vLi4vcnBjLWNvbW1hbmRzLm1qcyI6Ii9ycGMtY29tbWFuZHMubWpzIiwiLi9zdGF0ZS5tanMiOiIvYmFja2VuZC9saWIvc3RhdGUubWpzIiwiLi9zdG9yYWdlLm1qcyI6Ii9iYWNrZW5kL2xpYi9zdG9yYWdlLm1qcyIsIi4vdXRpbHMubWpzIjoiL2JhY2tlbmQvbGliL3V0aWxzLm1qcyJ9LCIvYmFja2VuZC9saWIvaXRlbXMubWpzIjp7IiNwYWNrYWdlIjoiL3BhY2thZ2UuanNvbiIsIi4uLy4uL3JwYy1jb21tYW5kcy5tanMiOiIvcnBjLWNvbW1hbmRzLm1qcyIsIi4vZXJyb3JzLm1qcyI6Ii9iYWNrZW5kL2xpYi9lcnJvcnMubWpzIiwiLi9zdGF0ZS5tanMiOiIvYmFja2VuZC9saWIvc3RhdGUubWpzIiwiLi91dGlscy5tanMiOiIvYmFja2VuZC9saWIvdXRpbHMubWpzIn0sIi9iYWNrZW5kL2xpYi9rZXlzLm1qcyI6eyIjcGFja2FnZSI6Ii9wYWNrYWdlLmpzb24iLCIuL3N0b3JhZ2UubWpzIjoiL2JhY2tlbmQvbGliL3N0b3JhZ2UubWpzIiwiLi91dGlscy5tanMiOiIvYmFja2VuZC9saWIvdXRpbHMubWpzIiwiYmFyZS1mcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9pbmRleC5qcyJ9LCIvYmFja2VuZC9saWIvbmV0d29ya2luZy5tanMiOnsiI3BhY2thZ2UiOiIvcGFja2FnZS5qc29uIiwiLi4vLi4vcnBjLWNvbW1hbmRzLm1qcyI6Ii9ycGMtY29tbWFuZHMubWpzIiwiLi9hdXRvYmFzZS5tanMiOiIvYmFja2VuZC9saWIvYXV0b2Jhc2UubWpzIiwiLi9lcnJvcnMubWpzIjoiL2JhY2tlbmQvbGliL2Vycm9ycy5tanMiLCIuL3N0YXRlLm1qcyI6Ii9iYWNrZW5kL2xpYi9zdGF0ZS5tanMiLCIuL3V0aWxzLm1qcyI6Ii9iYWNrZW5kL2xpYi91dGlscy5tanMiLCJoeXBlcnN3YXJtIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2luZGV4LmpzIn0sIi9iYWNrZW5kL2xpYi9zdGF0ZS5tanMiOnsiI3BhY2thZ2UiOiIvcGFja2FnZS5qc29uIn0sIi9iYWNrZW5kL2xpYi9zdG9yYWdlLm1qcyI6eyIjcGFja2FnZSI6Ii9wYWNrYWdlLmpzb24iLCIuL3N0YXRlLm1qcyI6Ii9iYWNrZW5kL2xpYi9zdGF0ZS5tanMiLCIuL3V0aWxzLm1qcyI6Ii9iYWNrZW5kL2xpYi91dGlscy5tanMiLCJiYXJlLWZzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2luZGV4LmpzIiwiYmFyZS1wYXRoIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvaW5kZXguanMiLCJjb3Jlc3RvcmUiOiIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9pbmRleC5qcyJ9LCIvYmFja2VuZC9saWIvdXRpbHMubWpzIjp7IiNwYWNrYWdlIjoiL3BhY2thZ2UuanNvbiIsImJhcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vcGFja2FnZS5qc29uIiwiLi9saWIvYnJpZGdlIjoiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL2xpYi9icmlkZ2UuanMiLCIuL2xpYi9oYW5kc2hha2UiOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vbGliL2hhbmRzaGFrZS5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsInNvZGl1bS1zZWNyZXRzdHJlYW0iOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS1zZWNyZXRzdHJlYW0vaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyIsInRpbWVvdXQtcmVmcmVzaCI6Ii9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL2luZGV4LmpzIiwidW5zbGFiIjoiL25vZGVfbW9kdWxlcy91bnNsYWIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL2xpYi9icmlkZ2UuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vcGFja2FnZS5qc29uIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vbGliL2hhbmRzaGFrZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsIm5vaXNlLWN1cnZlLWVkIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1jdXJ2ZS1lZC9pbmRleC5qcyIsIm5vaXNlLWhhbmRzaGFrZSI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL25vaXNlLmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9lbmNvZGluZy9sZWdhY3kuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJpbmRleC1lbmNvZGVyIjoiL25vZGVfbW9kdWxlcy9pbmRleC1lbmNvZGVyL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvZW5jb2Rpbmcvc3BlYy9hdXRvYmFzZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi4vLi4vbGVnYWN5LmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9lbmNvZGluZy9sZWdhY3kuanMiLCJoeXBlcnNjaGVtYS9ydW50aW1lIjoiL25vZGVfbW9kdWxlcy9oeXBlcnNjaGVtYS9ydW50aW1lLmNqcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL2xpYi9hY3RpdmUtd3JpdGVycy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FjdGl2ZS13cml0ZXJzLmpzIiwiLi9saWIvYXBwZW5kLWJhdGNoLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwZW5kLWJhdGNoLmpzIiwiLi9saWIvYXBwbHktY2FsbHMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9hcHBseS1jYWxscy5qcyIsIi4vbGliL2FwcGx5LXN0YXRlLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwbHktc3RhdGUuanMiLCIuL2xpYi9ib290LmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYm9vdC5qcyIsIi4vbGliL2NhcHMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jYXBzLmpzIiwiLi9saWIvZW5jcnlwdGlvbi5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2VuY3J5cHRpb24uanMiLCIuL2xpYi9mYXN0LWZvcndhcmQuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9mYXN0LWZvcndhcmQuanMiLCIuL2xpYi9saW5lYXJpemVyLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbGluZWFyaXplci5qcyIsIi4vbGliL2xvY2FsLXN0YXRlLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbG9jYWwtc3RhdGUuanMiLCIuL2xpYi9tZXNzYWdlcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL21lc3NhZ2VzLmpzIiwiLi9saWIvc3RvcmUuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9zdG9yZS5qcyIsIi4vbGliL3N5c3RlbS5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N5c3RlbS5qcyIsIi4vbGliL3RpbWVyLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdGltZXIuanMiLCIuL2xpYi91cGRhdGVzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdXBkYXRlcy5qcyIsIi4vbGliL3ZhbHVlcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3ZhbHVlcy5qcyIsIi4vbGliL3dha2V1cC5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3dha2V1cC5qcyIsIi4vbGliL3dyaXRlci5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3dyaXRlci5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImNvcmUtY291cGxlciI6Ii9ub2RlX21vZHVsZXMvY29yZS1jb3VwbGVyL2luZGV4LmpzIiwiZGVib3VuY2VpZnkiOiIvbm9kZV9tb2R1bGVzL2RlYm91bmNlaWZ5L2luZGV4LmpzIiwiaHlwZXJjb3JlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvaW5kZXguanMiLCJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1pZC1lbmNvZGluZy9pbmRleC5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMiLCJwcm90b211eC13YWtldXAiOiIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9pbmRleC5qcyIsInJlYWR5LXJlc291cmNlIjoiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9pbmRleC5qcyIsInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyIsInNjb3BlLWxvY2siOiIvbm9kZV9tb2R1bGVzL3Njb3BlLWxvY2svaW5kZXguanMiLCJzaWduYWwtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvc2lnbmFsLXByb21pc2UvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYWN0aXZlLXdyaXRlcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FwcGVuZC1iYXRjaC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwic2lnbmFsLXByb21pc2UiOiIvbm9kZV9tb2R1bGVzL3NpZ25hbC1wcm9taXNlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FwcGx5LWNhbGxzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwbHktc3RhdGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vYXBwbHktY2FsbHMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9hcHBseS1jYWxscy5qcyIsIi4vY2Fwcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2NhcHMuanMiLCIuL2VuY3J5cHRpb24uanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9lbmNyeXB0aW9uLmpzIiwiLi9mb3JrLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvZm9yay5qcyIsIi4vbG9jYWwtc3RhdGUuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9sb2NhbC1zdGF0ZS5qcyIsIi4vbWVzc2FnZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9tZXNzYWdlcy5qcyIsIi4vc3lzdGVtLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvc3lzdGVtLmpzIiwiLi91cGRhdGVzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdXBkYXRlcy5qcyIsIi4vdmFsdWVzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdmFsdWVzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsImh5cGVyY29yZS9saWIvbXVsdGlzaWcuanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXVsdGlzaWcuanMiLCJuYW5vYXNzZXJ0IjoiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYm9vdC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9tZXNzYWdlcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL21lc3NhZ2VzLmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jYXBzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Nsb2NrLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCJ0aW55LWJ1ZmZlci1tYXAiOiIvbm9kZV9tb2R1bGVzL3RpbnktYnVmZmVyLW1hcC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jb25zZW5zdXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vY2xvY2suanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jbG9jay5qcyIsInRpbnktYnVmZmVyLW1hcCI6Ii9ub2RlX21vZHVsZXMvdGlueS1idWZmZXItbWFwL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2VuY3J5cHRpb24uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vY2Fwcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2NhcHMuanMiLCIuL21lc3NhZ2VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiLCIuL3N5c3RlbS5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N5c3RlbS5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJoeXBlcmNvcmUvbGliL2RlZmF1bHQtZW5jcnlwdGlvbi5qcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9kZWZhdWx0LWVuY3J5cHRpb24uanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJyZXNvbHZlLXJlamVjdC1wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9yZXNvbHZlLXJlamVjdC1wcm9taXNlL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9mYXN0LWZvcndhcmQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vZW5jcnlwdGlvbi5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2VuY3J5cHRpb24uanMiLCIuL3N5c3RlbS5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N5c3RlbS5qcyIsInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9mb3JrLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL2VuY3J5cHRpb24uanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9lbmNyeXB0aW9uLmpzIiwiLi9tZXNzYWdlcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL21lc3NhZ2VzLmpzIiwiLi9zeXN0ZW0uanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9zeXN0ZW0uanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2xpbmVhcml6ZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vY2xvY2suanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jbG9jay5qcyIsIi4vY29uc2Vuc3VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY29uc2Vuc3VzLmpzIiwiLi90b3BvbGlzdC5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3RvcG9saXN0LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJuYW5vYXNzZXJ0IjoiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2xvY2FsLXN0YXRlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL21lc3NhZ2VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4uL2VuY29kaW5nL3NwZWMvYXV0b2Jhc2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2VuY29kaW5nL3NwZWMvYXV0b2Jhc2UvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbm9kZS1idWZmZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9zdG9yZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9tZXNzYWdlcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL21lc3NhZ2VzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiaHlwZXJjb3JlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N5c3RlbS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9jYXBzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY2Fwcy5qcyIsIi4vbWVzc2FnZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImh5cGVyYmVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJzdWItZW5jb2RlciI6Ii9ub2RlX21vZHVsZXMvc3ViLWVuY29kZXIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdGltZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3RvcG9saXN0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdXBkYXRlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3ZhbHVlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9jYXBzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY2Fwcy5qcyIsIi4vZW5jcnlwdGlvbi5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2VuY3J5cHRpb24uanMiLCIuL21lc3NhZ2VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3dha2V1cC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvd3JpdGVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL2xpbmVhcml6ZXIuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9saW5lYXJpemVyLmpzIiwiLi9ub2RlLWJ1ZmZlci5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL25vZGUtYnVmZmVyLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwibmFub2Fzc2VydCI6Ii9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyIsInJlYWR5LXJlc291cmNlIjoiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9pbmRleC5qcyIsInNpZ25hbC1wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iNGEvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYjRhL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLiI6ImxpbmtlZDpiYXJlLWNyeXB0by4xLjEyLjAuZnJhbWV3b3JrL2JhcmUtY3J5cHRvLjEuMTIuMCJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuL2xpYi9jaXBoZXIiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jaXBoZXIuanMiLCIuL2xpYi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jb25zdGFudHMuanMiLCIuL2xpYi9oYXNoIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvaGFzaC5qcyIsIi4vbGliL2htYWMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9obWFjLmpzIiwiLi9saWIva2V5IjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIva2V5LmpzIiwiLi9saWIvcGJrZGYyIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvcGJrZGYyLmpzIiwiLi9saWIvcmFuZG9tIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvcmFuZG9tLmpzIiwiLi9saWIvc2lnbmF0dXJlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvc2lnbmF0dXJlLmpzIiwiLi93ZWIiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3dlYi5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jaXBoZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2JpbmRpbmcuanMiLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NvbnN0YW50cy5qcyIsImJhcmUtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jb25zdGFudHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2JpbmRpbmcuanMiLCIuL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2Vycm9ycy5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9lcnJvcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9oYXNoLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jb25zdGFudHMuanMiLCJiYXJlLXN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1zdHJlYW0vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvaG1hYy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvY29uc3RhbnRzLmpzIiwiYmFyZS1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2tleS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvY29uc3RhbnRzLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3Bia2RmMi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvY29uc3RhbnRzLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3JhbmRvbS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9zaWduYXR1cmUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2JpbmRpbmcuanMiLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NvbnN0YW50cy5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL2VkMjU1MTkuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4uLy4uLy4uIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9pbmRleC5qcyIsIi4uLy4uLy4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2JpbmRpbmcuanMiLCIuLi8uLi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9lcnJvcnMuanMiLCIuLi8uLi9rZXkiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9rZXkuanMiLCIuLi9jcnlwdG8ta2V5IjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2NyeXB0by1rZXkuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2FsZ29yaXRobS9obWFjLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi8uLi8uLiI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vaW5kZXguanMiLCIuLi8uLi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9lcnJvcnMuanMiLCIuLi9jcnlwdG8ta2V5IjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2NyeXB0by1rZXkuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2FsZ29yaXRobS9wYmtkZjIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4uLy4uLy4uIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9pbmRleC5qcyIsIi4uLy4uL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2Vycm9ycy5qcyIsIi4uL2NyeXB0by1rZXkiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvY3J5cHRvLWtleS5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL3NoYS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vLi4vLi4iOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9jcnlwdG8ta2V5LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3dlYi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLiI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vaW5kZXguanMiLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9lcnJvcnMuanMiLCIuL2xpYi93ZWIvYWxnb3JpdGhtL2VkMjU1MTkiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL2VkMjU1MTkuanMiLCIuL2xpYi93ZWIvYWxnb3JpdGhtL2htYWMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL2htYWMuanMiLCIuL2xpYi93ZWIvYWxnb3JpdGhtL3Bia2RmMiI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vcGJrZGYyLmpzIiwiLi9saWIvd2ViL2FsZ29yaXRobS9zaGEiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL3NoYS5qcyIsIi4vbGliL3dlYi9jcnlwdG8ta2V5IjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2NyeXB0by1rZXkuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvcGFja2FnZS5qc29uIiwiLi9saWIvZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9saWIvZXJyb3JzLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvbGliL2Vycm9ycy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2JpbmRpbmcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvcGFja2FnZS5qc29uIiwiLiI6ImxpbmtlZDpiYXJlLWZzLjQuNS4yLmZyYW1ld29yay9iYXJlLWZzLjQuNS4yIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9wYWNrYWdlLmpzb24iLCIuL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvYmluZGluZy5qcyIsIi4vbGliL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9saWIvY29uc3RhbnRzLmpzIiwiLi9saWIvZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2xpYi9lcnJvcnMuanMiLCIuL3Byb21pc2VzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL3Byb21pc2VzLmpzIiwiYmFyZS1ldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIiwiYmFyZS1wYXRoIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvaW5kZXguanMiLCJiYXJlLXN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1zdHJlYW0vaW5kZXguanMiLCJiYXJlLXVybCI6Ii9ub2RlX21vZHVsZXMvYmFyZS11cmwvaW5kZXguanMiLCJmYXN0LWZpZm8iOiIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvbGliL2NvbnN0YW50cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2JpbmRpbmcuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2xpYi9lcnJvcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvcGFja2FnZS5qc29uIiwiYmFyZS1vcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iYXJlLWZzL3Byb21pc2VzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL3BhY2thZ2UuanNvbiIsIi4iOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvaW5kZXguanMiLCJiYXJlLWV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2JpbmRpbmcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvcGFja2FnZS5qc29uIiwiLiI6ImxpbmtlZDpiYXJlLW9zLjMuNi4yLmZyYW1ld29yay9iYXJlLW9zLjMuNi4yIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1vcy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9wYWNrYWdlLmpzb24iLCIuL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvYmluZGluZy5qcyIsIi4vbGliL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9saWIvY29uc3RhbnRzLmpzIiwiLi9saWIvZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2xpYi9lcnJvcnMuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2xpYi9jb25zdGFudHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9iaW5kaW5nLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1vcy9saWIvZXJyb3JzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9wYWNrYWdlLmpzb24iLCIuL2xpYi9wb3NpeCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9wb3NpeC5qcyIsIi4vbGliL3dpbjMyIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3dpbjMyLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9jb25zdGFudHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3Bvc2l4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvY29uc3RhbnRzLmpzIiwiLi9zaGFyZWQiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvc2hhcmVkLmpzIiwiLi93aW4zMiI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi93aW4zMi5qcyIsImJhcmUtb3MiOiIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3NoYXJlZC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL2NvbnN0YW50cy5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvd2luMzIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9jb25zdGFudHMuanMiLCIuL3Bvc2l4IjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3Bvc2l4LmpzIiwiLi9zaGFyZWQiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvc2hhcmVkLmpzIiwiYmFyZS1vcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24iLCIuL2xpYi9jb21tYW5kLXJvdXRlciI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2NvbW1hbmQtcm91dGVyLmpzIiwiLi9saWIvY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvY29uc3RhbnRzLmpzIiwiLi9saWIvaW5jb21pbmctcmVxdWVzdCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2luY29taW5nLXJlcXVlc3QuanMiLCIuL2xpYi9pbmNvbWluZy1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9pbmNvbWluZy1zdHJlYW0uanMiLCIuL2xpYi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL21lc3NhZ2VzLmpzIiwiLi9saWIvb3V0Z29pbmctcmVxdWVzdCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL291dGdvaW5nLXJlcXVlc3QuanMiLCIuL2xpYi9vdXRnb2luZy1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9vdXRnb2luZy1zdHJlYW0uanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9jb21tYW5kLXJvdXRlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvcGFja2FnZS5qc29uIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9jb25zdGFudHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9lcnJvcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9pbmNvbWluZy1yZXF1ZXN0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24iLCIuL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2Vycm9ycy5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvaW5jb21pbmctc3RyZWFtLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2NvbnN0YW50cy5qcyIsImJhcmUtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9tZXNzYWdlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9jb25zdGFudHMuanMiLCIuL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2Vycm9ycy5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvb3V0Z29pbmctcmVxdWVzdC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvcGFja2FnZS5qc29uIiwiLi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9lcnJvcnMuanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL291dGdvaW5nLXN0cmVhbS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9jb25zdGFudHMuanMiLCJiYXJlLXN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1zdHJlYW0vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9wYWNrYWdlLmpzb24iLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1zdHJlYW0vcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOmJhcmUtdXJsLjIuMy4yLmZyYW1ld29yay9iYXJlLXVybC4yLjMuMiJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9wYWNrYWdlLmpzb24iLCIuL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2JpbmRpbmcuanMiLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2xpYi9lcnJvcnMuanMiLCIuL2xpYi91cmwtc2VhcmNoLXBhcmFtcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS11cmwvbGliL3VybC1zZWFyY2gtcGFyYW1zLmpzIiwiYmFyZS1wYXRoIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9saWIvZXJyb3JzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9saWIvdXJsLXNlYXJjaC1wYXJhbXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmlnLXNwYXJzZS1hcnJheS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmlnLXNwYXJzZS1hcnJheS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9iaWctc3BhcnNlLWFycmF5L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYml0cy10by1ieXRlcy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYml0cy10by1ieXRlcy9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JpdHMtdG8tYnl0ZXMvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9ibGluZC1yZWxheS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmxpbmQtcmVsYXkvcGFja2FnZS5qc29uIiwiLi9saWIvZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9ibGluZC1yZWxheS9saWIvZXJyb3JzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJiaXRzLXRvLWJ5dGVzIjoiL25vZGVfbW9kdWxlcy9iaXRzLXRvLWJ5dGVzL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmctYml0ZmllbGQiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctYml0ZmllbGQvaW5kZXguanMiLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIiwicHJvdG9tdXgiOiIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4L2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyIsInN0cmVhbXgiOiIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ibGluZC1yZWxheS9saWIvZXJyb3JzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ibGluZC1yZWxheS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9ibGluZC1yZWxheS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2JvZ29uL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ib2dvbi9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nLW5ldCI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1uZXQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ib2dvbi9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2NvZGVjcy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvY29kZWNzL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvY29kZWNzL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZC9wYWNrYWdlLmpzb24iLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctbmV0L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLW5ldC9wYWNrYWdlLmpzb24iLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1uZXQvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2VuZGlhbi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL3BhY2thZ2UuanNvbiIsIi4vZW5kaWFuIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2VuZGlhbi5qcyIsIi4vbGV4aW50IjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2xleGludC5qcyIsIi4vcmF3IjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL3Jhdy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9sZXhpbnQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvcmF3LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL3BhY2thZ2UuanNvbiIsIi4vZW5kaWFuIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2VuZGlhbi5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvY29yZS1jb3VwbGVyL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9jb3JlLWNvdXBsZXIvcGFja2FnZS5qc29uIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9jb3JlLWNvdXBsZXIvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9wYWNrYWdlLmpzb24iLCIuL2xpYi9hdWRpdC5qcyI6Ii9ub2RlX21vZHVsZXMvY29yZXN0b3JlL2xpYi9hdWRpdC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiaHlwZXJjb3JlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwiaHlwZXJjb3JlLWVycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9pbmRleC5qcyIsImh5cGVyY29yZS1pZC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWlkLWVuY29kaW5nL2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyIsIndoaWNoLXJ1bnRpbWUiOiIvbm9kZV9tb2R1bGVzL3doaWNoLXJ1bnRpbWUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvbGliL2F1ZGl0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvY29yZXN0b3JlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvZGVib3VuY2VpZnkvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2RlYm91bmNlaWZ5L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2RlYm91bmNlaWZ5L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvZGV2aWNlLWZpbGUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2RldmljZS1maWxlL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZmQtbG9jayI6Ii9ub2RlX21vZHVsZXMvZmQtbG9jay9pbmRleC5qcyIsImZzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2luZGV4LmpzIiwiZnMtbmF0aXZlLWV4dGVuc2lvbnMiOiIvbm9kZV9tb2R1bGVzL2ZzLW5hdGl2ZS1leHRlbnNpb25zL2luZGV4LmpzIiwicGF0aCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvZGV2aWNlLWZpbGUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL3BhY2thZ2UuanNvbiIsIi4vbGliL2NvbW1hbmRzIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9jb21tYW5kcy5qcyIsIi4vbGliL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvZXJyb3JzLmpzIiwiLi9saWIvaW8iOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2lvLmpzIiwiLi9saWIvcGVlciI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvcGVlci5qcyIsIi4vbGliL3F1ZXJ5IjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9xdWVyeS5qcyIsIi4vbGliL3Nlc3Npb24iOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL3Nlc3Npb24uanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIiwia2FkZW1saWEtcm91dGluZy10YWJsZSI6Ii9ub2RlX21vZHVsZXMva2FkZW1saWEtcm91dGluZy10YWJsZS9pbmRleC5qcyIsIm5hdC1zYW1wbGVyIjoiL25vZGVfbW9kdWxlcy9uYXQtc2FtcGxlci9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMiLCJ0aW1lLW9yZGVyZWQtc2V0IjoiL25vZGVfbW9kdWxlcy90aW1lLW9yZGVyZWQtc2V0L2luZGV4LmpzIiwidWR4LW5hdGl2ZSI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvdWR4LmpzIn0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvY29tbWFuZHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvZXJyb3JzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2lvLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL3BhY2thZ2UuanNvbiIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9lcnJvcnMuanMiLCIuL3BlZXIiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL3BlZXIuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJmYXN0LWZpZm8iOiIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9wZWVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmctbmV0IjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLW5ldC9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9xdWVyeS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9wYWNrYWdlLmpzb24iLCIuL2NvbW1hbmRzIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9jb21tYW5kcy5qcyIsIi4vcGVlciI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvcGVlci5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL3Nlc3Npb24uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2V2ZW50cy11bml2ZXJzYWwvYmFyZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZXZlbnRzLXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iLCJiYXJlLWV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ldmVudHMtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvZmFzdC1maWZvL2ZpeGVkLXNpemUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9wYWNrYWdlLmpzb24iLCIuL2ZpeGVkLXNpemUiOiIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9maXhlZC1zaXplLmpzIn0sIi9ub2RlX21vZHVsZXMvZmFzdC1maWZvL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvZmQtbG9jay9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZmQtbG9jay9wYWNrYWdlLmpzb24iLCJmcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9pbmRleC5qcyIsImZzLW5hdGl2ZS1leHRlbnNpb25zIjoiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9pbmRleC5qcyIsInJlYWR5LXJlc291cmNlIjoiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9pbmRleC5qcyIsInJlc291cmNlLW9uLWV4aXQiOiIvbm9kZV9tb2R1bGVzL3Jlc291cmNlLW9uLWV4aXQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9mZC1sb2NrL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvZmxhdC10cmVlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvYmluZGluZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvcGFja2FnZS5qc29uIiwiLiI6ImxpbmtlZDpmcy1uYXRpdmUtZXh0ZW5zaW9ucy4xLjQuNS5mcmFtZXdvcmsvZnMtbmF0aXZlLWV4dGVuc2lvbnMuMS40LjUiLCJyZXF1aXJlLWFkZG9uIjoiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL2xpYi9iYXJlLmpzIn0sIi9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2ZzLW5hdGl2ZS1leHRlbnNpb25zL3BhY2thZ2UuanNvbiIsIi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvYmluZGluZy5qcyIsIndoaWNoLXJ1bnRpbWUiOiIvbm9kZV9tb2R1bGVzL3doaWNoLXJ1bnRpbWUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9wYWNrYWdlLmpzb24iLCIuL2l0ZXJhdG9ycy9kaWZmIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvZGlmZi5qcyIsIi4vaXRlcmF0b3JzL2hpc3RvcnkiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9oaXN0b3J5LmpzIiwiLi9pdGVyYXRvcnMvbG9jYWwiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9sb2NhbC5qcyIsIi4vaXRlcmF0b3JzL3JhbmdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvcmFuZ2UuanMiLCIuL2xpYi9leHRlbnNpb24iOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2xpYi9leHRlbnNpb24uanMiLCIuL2xpYi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvbGliL21lc3NhZ2VzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb2RlY3MiOiIvbm9kZV9tb2R1bGVzL2NvZGVjcy9pbmRleC5qcyIsImRlYm91bmNlaWZ5IjoiL25vZGVfbW9kdWxlcy9kZWJvdW5jZWlmeS9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJtdXRleGlmeS9wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9wcm9taXNlLmpzIiwicmFjaGUiOiIvbm9kZV9tb2R1bGVzL3JhY2hlL2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL2RpZmYuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL2hpc3RvcnkuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9sb2NhbC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL3JhbmdlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2xpYi9leHRlbnNpb24uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL3BhY2thZ2UuanNvbiIsIi4vbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2xpYi9tZXNzYWdlcy5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2xpYi9tZXNzYWdlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJwcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncyI6Ii9ub2RlX21vZHVsZXMvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL3BhY2thZ2UuanNvbiIsImh5cGVyY29yZS1pZC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWlkLWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1pZC1lbmNvZGluZy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWlkLWVuY29kaW5nL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiejMyIjoiL25vZGVfbW9kdWxlcy96MzIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvcGFja2FnZS5qc29uIiwiLi9saWIva2V5cy5qcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL2tleXMuanMiLCIuL2xpYi9zdHJlYW1zLmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvc3RyZWFtcy5qcyIsIi4vbGliL3R4LmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvdHguanMiLCIuL2xpYi92aWV3LmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvdmlldy5qcyIsIi4vbWlncmF0aW9ucy8wIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9taWdyYXRpb25zLzAvaW5kZXguanMiLCJkZXZpY2UtZmlsZSI6Ii9ub2RlX21vZHVsZXMvZGV2aWNlLWZpbGUvaW5kZXguanMiLCJmcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9pbmRleC5qcyIsInBhdGgiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9pbmRleC5qcyIsInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvaW5kZXguanMiLCJyb2Nrc2RiLW5hdGl2ZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvaW5kZXguanMiLCJzY29wZS1sb2NrIjoiL25vZGVfbW9kdWxlcy9zY29wZS1sb2NrL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL2Jsb2NrLWRlcGVuZGVuY3ktc3RyZWFtLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCIuL2tleXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9rZXlzLmpzIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9jbG9zZS1lcnJvci1zdHJlYW0uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiIsInN0cmVhbXgiOiIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIva2V5cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiaW5kZXgtZW5jb2RlciI6Ii9ub2RlX21vZHVsZXMvaW5kZXgtZW5jb2Rlci9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9zdHJlYW1zLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCIuLi9zcGVjL2h5cGVyc2NoZW1hIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9zcGVjL2h5cGVyc2NoZW1hL2luZGV4LmpzIiwiLi9ibG9jay1kZXBlbmRlbmN5LXN0cmVhbS5qcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL2Jsb2NrLWRlcGVuZGVuY3ktc3RyZWFtLmpzIiwiLi9rZXlzLmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIva2V5cy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3R4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCIuLi9zcGVjL2h5cGVyc2NoZW1hIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9zcGVjL2h5cGVyc2NoZW1hL2luZGV4LmpzIiwiLi9rZXlzLmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIva2V5cy5qcyIsIi4vdmlldy5qcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3ZpZXcuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3ZpZXcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiIsIi4vY2xvc2UtZXJyb3Itc3RyZWFtLmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvY2xvc2UtZXJyb3Itc3RyZWFtLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbWlncmF0aW9ucy8wL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCIuLi8uLi9saWIvdHguanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi90eC5qcyIsIi4uLy4uL2xpYi92aWV3LmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvdmlldy5qcyIsIi4vbWVzc2FnZXMuanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL21pZ3JhdGlvbnMvMC9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIiwiZnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwicGF0aCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2luZGV4LmpzIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL21pZ3JhdGlvbnMvMC9tZXNzYWdlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9zcGVjL2h5cGVyc2NoZW1hL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCJoeXBlcnNjaGVtYS9ydW50aW1lIjoiL25vZGVfbW9kdWxlcy9oeXBlcnNjaGVtYS9ydW50aW1lLmNqcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vbGliL2NhcHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY2Fwcy5qcyIsIi4vbGliL2NvcmUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY29yZS5qcyIsIi4vbGliL2RlZmF1bHQtZW5jcnlwdGlvbiI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9kZWZhdWx0LWVuY3J5cHRpb24uanMiLCIuL2xpYi9kb3dubG9hZCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9kb3dubG9hZC5qcyIsIi4vbGliL2luZm8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvaW5mby5qcyIsIi4vbGliL2luc3BlY3QiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvaW5zcGVjdC5qcyIsIi4vbGliL21lcmtsZS10cmVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lcmtsZS10cmVlLmpzIiwiLi9saWIvcmVwbGljYXRvciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZXBsaWNhdG9yLmpzIiwiLi9saWIvc3RyZWFtcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9zdHJlYW1zLmpzIiwiLi9saWIvdmVyaWZpZXIiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvdmVyaWZpZXIuanMiLCJAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL2luZGV4LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJoeXBlcmNvcmUtZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL2luZGV4LmpzIiwiaHlwZXJjb3JlLWlkLWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvaW5kZXguanMiLCJoeXBlcmNvcmUtc3RvcmFnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvaW5kZXguanMiLCJpcy1vcHRpb25zIjoiL25vZGVfbW9kdWxlcy9pcy1vcHRpb25zL2luZGV4LmpzIiwicHJvdG9tdXgiOiIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4L2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvYXVkaXQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL21lcmtsZS10cmVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lcmtsZS10cmVlLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJmbGF0LXRyZWUiOiIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2JpdC1pbnRlcmx1ZGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2NvbXBhdCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb21wYXQuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvYml0ZmllbGQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2NvbXBhdCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb21wYXQuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImJpZy1zcGFyc2UtYXJyYXkiOiIvbm9kZV9tb2R1bGVzL2JpZy1zcGFyc2UtYXJyYXkvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NhcHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY29tcGF0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwicXVpY2tiaXQtdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvaW5kZXguanMiLCJxdWlja2JpdC11bml2ZXJzYWwvZmFsbGJhY2siOiIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9mYWxsYmFjay5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY29weS1wcm9sb2d1ZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vYml0ZmllbGQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvYml0ZmllbGQuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsInF1aWNrYml0LXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb3JlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiLi9hdWRpdCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9hdWRpdC5qcyIsIi4vYml0LWludGVybHVkZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9iaXQtaW50ZXJsdWRlLmpzIiwiLi9iaXRmaWVsZCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9iaXRmaWVsZC5qcyIsIi4vY29weS1wcm9sb2d1ZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb3B5LXByb2xvZ3VlLmpzIiwiLi9tZXJrbGUtdHJlZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXJrbGUtdHJlZS5qcyIsIi4vbXV0ZXgiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXV0ZXguanMiLCIuL3JlbW90ZS1iaXRmaWVsZCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZW1vdGUtYml0ZmllbGQuanMiLCIuL3JlcGxpY2F0b3IiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVwbGljYXRvci5qcyIsIi4vc2Vzc2lvbi1zdGF0ZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9zZXNzaW9uLXN0YXRlLmpzIiwiLi92ZXJpZmllciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi92ZXJpZmllci5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyIsInozMiI6Ii9ub2RlX21vZHVsZXMvejMyL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9kZWZhdWx0LWVuY3J5cHRpb24uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2NhcHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY2Fwcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2Rvd25sb2FkLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9ob3Rzd2FwLXF1ZXVlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9pbmZvLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9pbnNwZWN0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lcmtsZS10cmVlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiLi9jYXBzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NhcHMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVzc2FnZXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2NhcHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY2Fwcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXVsdGlzaWcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL21lcmtsZS10cmVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lcmtsZS10cmVlLmpzIiwiLi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tdXRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVjZWl2ZXItcXVldWUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCJmYXN0LWZpZm8iOiIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVtb3RlLWJpdGZpZWxkLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiLi9jb21wYXQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY29tcGF0LmpzIiwiYmlnLXNwYXJzZS1hcnJheSI6Ii9ub2RlX21vZHVsZXMvYmlnLXNwYXJzZS1hcnJheS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVwbGljYXRvci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vY2FwcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jYXBzLmpzIiwiLi9ob3Rzd2FwLXF1ZXVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2hvdHN3YXAtcXVldWUuanMiLCIuL21lcmtsZS10cmVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lcmtsZS10cmVlLmpzIiwiLi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXNzYWdlcy5qcyIsIi4vbXV0ZXgiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXV0ZXguanMiLCIuL3JlY2VpdmVyLXF1ZXVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3JlY2VpdmVyLXF1ZXVlLmpzIiwiLi9yZW1vdGUtYml0ZmllbGQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVtb3RlLWJpdGZpZWxkLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJmbGF0LXRyZWUiOiIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJyYW5kb20tYXJyYXktaXRlcmF0b3IiOiIvbm9kZV9tb2R1bGVzL3JhbmRvbS1hcnJheS1pdGVyYXRvci9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9zZXNzaW9uLXN0YXRlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiLi9iaXRmaWVsZCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9iaXRmaWVsZC5qcyIsIi4vbWVya2xlLXRyZWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVya2xlLXRyZWUuanMiLCIuL211dGV4IjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL211dGV4LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJmbGF0LXRyZWUiOiIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJoeXBlcmNvcmUtZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL2luZGV4LmpzIiwibmFub2Fzc2VydCI6Ii9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyIsInF1aWNrYml0LXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9zdHJlYW1zLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvdmVyaWZpZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2NhcHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY2Fwcy5qcyIsIi4vbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVzc2FnZXMuanMiLCIuL211bHRpc2lnIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL211bHRpc2lnLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiZmxhdC10cmVlIjoiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwiaHlwZXJjb3JlLWVycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vbGliL2Nvbm5lY3QiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25uZWN0LmpzIiwiLi9saWIvY29ubmVjdGlvbi1wb29sIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29ubmVjdGlvbi1wb29sLmpzIiwiLi9saWIvY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIiwiLi9saWIvY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY3J5cHRvLmpzIiwiLi9saWIvZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZXJyb3JzLmpzIiwiLi9saWIvbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9tZXNzYWdlcy5qcyIsIi4vbGliL3BlcnNpc3RlbnQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9wZXJzaXN0ZW50LmpzIiwiLi9saWIvcmF3LXN0cmVhbS1zZXQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9yYXctc3RyZWFtLXNldC5qcyIsIi4vbGliL3JvdXRlciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3JvdXRlci5qcyIsIi4vbGliL3NlcnZlciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NlcnZlci5qcyIsIi4vbGliL3NvY2tldC1wb29sIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc29ja2V0LXBvb2wuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJkaHQtcnBjIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2luZGV4LmpzIiwiaHlwZXJjb3JlLWlkLWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMiLCJ4YWNoZSI6Ii9ub2RlX21vZHVsZXMveGFjaGUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvYW5ub3VuY2VyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2NvbnN0YW50cy5qcyIsIi4vZW5jb2RlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZW5jb2RlLmpzIiwiLi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL21lc3NhZ2VzLmpzIiwiLi9wZXJzaXN0ZW50IjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvcGVyc2lzdGVudC5qcyIsIi4vc2xlZXBlciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NsZWVwZXIuanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiLCJzaWduYWwtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvc2lnbmFsLXByb21pc2UvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29ubmVjdC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiLCIuL2NyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2NyeXB0by5qcyIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZXJyb3JzLmpzIiwiLi9ob2xlcHVuY2hlciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2hvbGVwdW5jaGVyLmpzIiwiLi9ub2lzZS13cmFwIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbm9pc2Utd3JhcC5qcyIsIi4vc2VjdXJlLXBheWxvYWQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zZWN1cmUtcGF5bG9hZC5qcyIsIi4vc2VtYXBob3JlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VtYXBob3JlLmpzIiwiLi9zbGVlcGVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2xlZXBlci5qcyIsIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vaW5kZXguanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImJsaW5kLXJlbGF5IjoiL25vZGVfbW9kdWxlcy9ibGluZC1yZWxheS9pbmRleC5qcyIsImJvZ29uIjoiL25vZGVfbW9kdWxlcy9ib2dvbi9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIiwidW5zbGFiIjoiL25vZGVfbW9kdWxlcy91bnNsYWIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29ubmVjdGlvbi1wb29sLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCIuL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Vycm9ycy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY3J5cHRvLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZW5jb2RlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZXJyb3JzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvaG9sZXB1bmNoZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIiwiLi9uYXQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9uYXQuanMiLCIuL3NsZWVwZXIiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zbGVlcGVyLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbWVzc2FnZXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nLW5ldCI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1uZXQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbmF0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCIuLi9saWIvY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL25vaXNlLXdyYXAuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIiwiLi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lcnJvcnMuanMiLCIuL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbWVzc2FnZXMuanMiLCJAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL2luZGV4LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwibm9pc2UtY3VydmUtZWQiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWN1cnZlLWVkL2luZGV4LmpzIiwibm9pc2UtaGFuZHNoYWtlIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2Uvbm9pc2UuanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3BlcnNpc3RlbnQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIiwiLi9lbmNvZGUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lbmNvZGUuanMiLCIuL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbWVzc2FnZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJyZWNvcmQtY2FjaGUiOiIvbm9kZV9tb2R1bGVzL3JlY29yZC1jYWNoZS9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyIsInhhY2hlIjoiL25vZGVfbW9kdWxlcy94YWNoZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9yYXctc3RyZWFtLXNldC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3JvdXRlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiLCIuL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Vycm9ycy5qcyIsIi4vbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIiwieGFjaGUiOiIvbm9kZV9tb2R1bGVzL3hhY2hlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NlY3VyZS1wYXlsb2FkLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCIuL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbWVzc2FnZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VtYXBob3JlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VydmVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCIuL2Fubm91bmNlciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Fubm91bmNlci5qcyIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIiwiLi9jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jcnlwdG8uanMiLCIuL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Vycm9ycy5qcyIsIi4vaG9sZXB1bmNoZXIiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9ob2xlcHVuY2hlci5qcyIsIi4vbm9pc2Utd3JhcCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL25vaXNlLXdyYXAuanMiLCIuL3NlY3VyZS1wYXlsb2FkIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VjdXJlLXBheWxvYWQuanMiLCJAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL2luZGV4LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJibGluZC1yZWxheSI6Ii9ub2RlX21vZHVsZXMvYmxpbmQtcmVsYXkvaW5kZXguanMiLCJib2dvbiI6Ii9ub2RlX21vZHVsZXMvYm9nb24vaW5kZXguanMiLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2xlZXBlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NvY2tldC1wb29sLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvaHlwZXJzY2hlbWEvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9oeXBlcnNjaGVtYS9ydW50aW1lLmNqcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzY2hlbWEvcGFja2FnZS5qc29uIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vcGFja2FnZS5qc29uIiwiLi9saWIvY29ubmVjdGlvbi1zZXQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL2Nvbm5lY3Rpb24tc2V0LmpzIiwiLi9saWIvcGVlci1kaXNjb3ZlcnkiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL3BlZXItZGlzY292ZXJ5LmpzIiwiLi9saWIvcGVlci1pbmZvIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9wZWVyLWluZm8uanMiLCIuL2xpYi9yZXRyeS10aW1lciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvcmV0cnktdGltZXIuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMiLCJoeXBlcmRodCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvaW5kZXguanMiLCJzaHVmZmxlZC1wcmlvcml0eS1xdWV1ZSI6Ii9ub2RlX21vZHVsZXMvc2h1ZmZsZWQtcHJpb3JpdHktcXVldWUvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIiwidW5zbGFiIjoiL25vZGVfbW9kdWxlcy91bnNsYWIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9idWxrLXRpbWVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL2Nvbm5lY3Rpb24tc2V0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvcGVlci1kaXNjb3ZlcnkuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL3BlZXItaW5mby5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL3JldHJ5LXRpbWVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL3BhY2thZ2UuanNvbiIsIi4vYnVsay10aW1lciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvYnVsay10aW1lci5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9pbmRleC1lbmNvZGVyL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9pbmRleC1lbmNvZGVyL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaW5kZXgtZW5jb2Rlci9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2lzLW9wdGlvbnMvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2lzLW9wdGlvbnMvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9pcy1vcHRpb25zL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMva2FkZW1saWEtcm91dGluZy10YWJsZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMva2FkZW1saWEtcm91dGluZy10YWJsZS9wYWNrYWdlLmpzb24iLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMva2FkZW1saWEtcm91dGluZy10YWJsZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9wYWNrYWdlLmpzb24iLCJxdWV1ZS10aWNrIjoiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3Byb2Nlc3MtbmV4dC10aWNrLmpzIn0sIi9ub2RlX21vZHVsZXMvbXV0ZXhpZnkvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9wcm9taXNlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9wYWNrYWdlLmpzb24iLCIuIjoiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL25hdC1zYW1wbGVyL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9uYXQtc2FtcGxlci9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9uYXQtc2FtcGxlci9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWN1cnZlLWVkL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1jdXJ2ZS1lZC9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvbm9pc2UtY3VydmUtZWQvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvY2lwaGVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2RoLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJuYW5vYXNzZXJ0IjoiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9oa2RmLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvcGFja2FnZS5qc29uIiwiLi9obWFjIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvaG1hYy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2htYWMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2Uvbm9pc2UuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iLCIuL2hrZGYiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9oa2RmLmpzIiwiLi9zeW1tZXRyaWMtc3RhdGUiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9zeW1tZXRyaWMtc3RhdGUuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2Uvc3ltbWV0cmljLXN0YXRlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvcGFja2FnZS5qc29uIiwiLi9jaXBoZXIiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9jaXBoZXIuanMiLCIuL2RoIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvZGguanMiLCIuL2hrZGYiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9oa2RmLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJuYW5vYXNzZXJ0IjoiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3Byb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9wcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncy9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInNpZ25lZC12YXJpbnQiOiIvbm9kZV9tb2R1bGVzL3NpZ25lZC12YXJpbnQvaW5kZXguanMiLCJ2YXJpbnQiOiIvbm9kZV9tb2R1bGVzL3ZhcmludC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3Byb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcHJvdG9tdXgtd2FrZXVwL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9wcm90b211eC13YWtldXAvcGFja2FnZS5qc29uIiwiLi9zcGVjL2h5cGVyc2NoZW1hIjoiL25vZGVfbW9kdWxlcy9wcm90b211eC13YWtldXAvc3BlYy9oeXBlcnNjaGVtYS9pbmRleC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsInByb3RvbXV4IjoiL25vZGVfbW9kdWxlcy9wcm90b211eC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9zcGVjL2h5cGVyc2NoZW1hL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9wcm90b211eC13YWtldXAvcGFja2FnZS5qc29uIiwiaHlwZXJzY2hlbWEvcnVudGltZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzY2hlbWEvcnVudGltZS5janMifSwiL25vZGVfbW9kdWxlcy9wcm90b211eC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcHJvdG9tdXgvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwicXVldWUtdGljayI6Ii9ub2RlX21vZHVsZXMvcXVldWUtdGljay9wcm9jZXNzLW5leHQtdGljay5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIiwidW5zbGFiIjoiL25vZGVfbW9kdWxlcy91bnNsYWIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9wcm90b211eC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3Byb2Nlc3MtbmV4dC10aWNrLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3BhY2thZ2UuanNvbiIsIi4vcXVldWUtbWljcm90YXNrIjoiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3F1ZXVlLW1pY3JvdGFzay5qcyJ9LCIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcXVldWUtbWljcm90YXNrLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LW5hdGl2ZS9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC1uYXRpdmUvcGFja2FnZS5qc29uIiwiLiI6ImxpbmtlZDpxdWlja2JpdC1uYXRpdmUuMi40LjguZnJhbWV3b3JrL3F1aWNrYml0LW5hdGl2ZS4yLjQuOCIsInJlcXVpcmUtYWRkb24iOiIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vbGliL2JhcmUuanMifSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC1uYXRpdmUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LW5hdGl2ZS9iaW5kaW5nLmpzIn0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtbmF0aXZlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL2ZhbGxiYWNrLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvcGFja2FnZS5qc29uIiwic2ltZGxlLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiIsIi4vZmFsbGJhY2siOiIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9mYWxsYmFjay5qcyIsInF1aWNrYml0LW5hdGl2ZSI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtbmF0aXZlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcmFjaGUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3JhY2hlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3JhY2hlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcmFuZG9tLWFycmF5LWl0ZXJhdG9yL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yYW5kb20tYXJyYXktaXRlcmF0b3IvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvcmFuZG9tLWFycmF5LWl0ZXJhdG9yL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL3BhY2thZ2UuanNvbiIsImV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3JlY29yZC1jYWNoZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcmVjb3JkLWNhY2hlL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvcmVjb3JkLWNhY2hlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcmVmY291bnRlci9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcmVmY291bnRlci9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9yZWZjb3VudGVyL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcmVxdWlyZS1hZGRvbi9saWIvYmFyZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcmVxdWlyZS1hZGRvbi9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9yZXNvbHZlLXJlamVjdC1wcm9taXNlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcmVzb3VyY2Utb24tZXhpdC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcmVzb3VyY2Utb24tZXhpdC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9yZXNvdXJjZS1vbi1leGl0L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvYmluZGluZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvcGFja2FnZS5qc29uIiwiLiI6ImxpbmtlZDpyb2Nrc2RiLW5hdGl2ZS4zLjExLjQuZnJhbWV3b3JrL3JvY2tzZGItbmF0aXZlLjMuMTEuNCIsInJlcXVpcmUtYWRkb24iOiIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vbGliL2JhcmUuanMifSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvcGFja2FnZS5qc29uIiwiLi9saWIvY29sdW1uLWZhbWlseSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2NvbHVtbi1mYW1pbHkuanMiLCIuL2xpYi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9jb25zdGFudHMuanMiLCIuL2xpYi9maWx0ZXItcG9saWN5IjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvZmlsdGVyLXBvbGljeS5qcyIsIi4vbGliL2l0ZXJhdG9yIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvaXRlcmF0b3IuanMiLCIuL2xpYi9zbmFwc2hvdCI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL3NuYXBzaG90LmpzIiwiLi9saWIvc3RhdGUiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9zdGF0ZS5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9iYXRjaC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvYmluZGluZy5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvY29sdW1uLWZhbWlseS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvYmluZGluZy5qcyIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvY29uc3RhbnRzLmpzIiwiLi9maWx0ZXItcG9saWN5IjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvZmlsdGVyLXBvbGljeS5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9jb25zdGFudHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9maWx0ZXItcG9saWN5LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvaXRlcmF0b3IuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2JpbmRpbmcuanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9zbmFwc2hvdC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvYmluZGluZy5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9zdGF0ZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvYmluZGluZy5qcyIsIi4vYmF0Y2giOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9iYXRjaC5qcyIsIi4vY29sdW1uLWZhbWlseSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2NvbHVtbi1mYW1pbHkuanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwicmVmY291bnRlciI6Ii9ub2RlX21vZHVsZXMvcmVmY291bnRlci9pbmRleC5qcyIsInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvaW5kZXguanMiLCJzaWduYWwtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvc2lnbmFsLXByb21pc2UvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3Njb3BlLWxvY2svaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3Njb3BlLWxvY2svcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvc2NvcGUtbG9jay9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NodWZmbGVkLXByaW9yaXR5LXF1ZXVlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zaHVmZmxlZC1wcmlvcml0eS1xdWV1ZS9wYWNrYWdlLmpzb24iLCJ1bm9yZGVyZWQtc2V0IjoiL25vZGVfbW9kdWxlcy91bm9yZGVyZWQtc2V0L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvc2h1ZmZsZWQtcHJpb3JpdHktcXVldWUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc2lnbmFsLXByb21pc2UvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvc2lnbmFsLXByb21pc2UvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9zaWduZWQtdmFyaW50L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zaWduZWQtdmFyaW50L3BhY2thZ2UuanNvbiIsInZhcmludCI6Ii9ub2RlX21vZHVsZXMvdmFyaW50L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvc2lnbmVkLXZhcmludC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS1uYXRpdmUvYmluZGluZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOnNpbWRsZS1uYXRpdmUuMS4zLjkuZnJhbWV3b3JrL3NpbWRsZS1uYXRpdmUuMS4zLjkiLCJyZXF1aXJlLWFkZG9uIjoiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL2xpYi9iYXJlLmpzIn0sIi9ub2RlX21vZHVsZXMvc2ltZGxlLW5hdGl2ZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL3NpbWRsZS1uYXRpdmUvYmluZGluZy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvc2ltZGxlLW5hdGl2ZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvZmFsbGJhY2suanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvcGFja2FnZS5qc29uIiwiLi9zY2FsYXIiOiIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvc2NhbGFyLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtdW5pdmVyc2FsL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zaW1kbGUtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiIsIi4vZmFsbGJhY2siOiIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvZmFsbGJhY2suanMiLCJzaW1kbGUtbmF0aXZlIjoiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvc2NhbGFyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zaW1kbGUtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS1uYXRpdmUvYmluZGluZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOnNvZGl1bS1uYXRpdmUuNS4wLjEwLmZyYW1ld29yay9zb2RpdW0tbmF0aXZlLjUuMC4xMCIsInJlcXVpcmUtYWRkb24iOiIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vbGliL2JhcmUuanMifSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tbmF0aXZlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9iaW5kaW5nLmpzIiwid2hpY2gtcnVudGltZSI6Ii9ub2RlX21vZHVsZXMvd2hpY2gtcnVudGltZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS1uYXRpdmUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tc2VjcmV0c3RyZWFtL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tc2VjcmV0c3RyZWFtL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS1zZWNyZXRzdHJlYW0vcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL3BhY2thZ2UuanNvbiIsInNvZGl1bS1uYXRpdmUiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS1uYXRpdmUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9wYWNrYWdlLmpzb24iLCJldmVudHMtdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9ldmVudHMtdW5pdmVyc2FsL2JhcmUuanMiLCJmYXN0LWZpZm8iOiIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9pbmRleC5qcyIsInRleHQtZGVjb2RlciI6Ii9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvc3RyZWFteC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3N1Yi1lbmNvZGVyL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zdWItZW5jb2Rlci9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvZGVjcyI6Ii9ub2RlX21vZHVsZXMvY29kZWNzL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvc3ViLWVuY29kZXIvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9wYWNrYWdlLmpzb24iLCIuL2xpYi9wYXNzLXRocm91Z2gtZGVjb2RlciI6Ii9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL2xpYi9wYXNzLXRocm91Z2gtZGVjb2Rlci5qcyIsIi4vbGliL3V0ZjgtZGVjb2RlciI6Ii9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL2xpYi91dGY4LWRlY29kZXIuanMifSwiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvbGliL3Bhc3MtdGhyb3VnaC1kZWNvZGVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvbGliL3V0ZjgtZGVjb2Rlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvdGltZS1vcmRlcmVkLXNldC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdGltZS1vcmRlcmVkLXNldC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy90aW1lLW9yZGVyZWQtc2V0L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL2Jyb3dzZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9wYWNrYWdlLmpzb24iLCIuL2Jyb3dzZXIiOiIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9icm93c2VyLmpzIiwiLi9ub2RlIjoiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvbm9kZS5qcyJ9LCIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9ub2RlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvdGlueS1idWZmZXItbWFwL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy90aW55LWJ1ZmZlci1tYXAvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy90aW55LWJ1ZmZlci1tYXAvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2JpbmRpbmcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvcGFja2FnZS5qc29uIiwiLiI6ImxpbmtlZDp1ZHgtbmF0aXZlLjEuMTkuMi5mcmFtZXdvcmsvdWR4LW5hdGl2ZS4xLjE5LjIiLCJyZXF1aXJlLWFkZG9uIjoiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL2xpYi9iYXJlLmpzIn0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvaXAuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvbmV0d29yay1pbnRlcmZhY2VzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvYmluZGluZy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL3NvY2tldC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2JpbmRpbmcuanMiLCIuL2lwIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9pcC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL3N0cmVhbS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2JpbmRpbmcuanMiLCIuL2lwIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9pcC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL3VkeC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2JpbmRpbmcuanMiLCIuL2lwIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9pcC5qcyIsIi4vbmV0d29yay1pbnRlcmZhY2VzIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9uZXR3b3JrLWludGVyZmFjZXMuanMiLCIuL3NvY2tldCI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvc29ja2V0LmpzIiwiLi9zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL3N0cmVhbS5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3Vub3JkZXJlZC1zZXQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3Vub3JkZXJlZC1zZXQvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvdW5vcmRlcmVkLXNldC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvdW5zbGFiL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvdmFyaW50L2RlY29kZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdmFyaW50L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3ZhcmludC9lbmNvZGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3ZhcmludC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy92YXJpbnQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3ZhcmludC9wYWNrYWdlLmpzb24iLCIuL2RlY29kZS5qcyI6Ii9ub2RlX21vZHVsZXMvdmFyaW50L2RlY29kZS5qcyIsIi4vZW5jb2RlLmpzIjoiL25vZGVfbW9kdWxlcy92YXJpbnQvZW5jb2RlLmpzIiwiLi9sZW5ndGguanMiOiIvbm9kZV9tb2R1bGVzL3ZhcmludC9sZW5ndGguanMifSwiL25vZGVfbW9kdWxlcy92YXJpbnQvbGVuZ3RoLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy92YXJpbnQvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvdmFyaW50L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvd2hpY2gtcnVudGltZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvd2hpY2gtcnVudGltZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy93aGljaC1ydW50aW1lL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMveGFjaGUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3hhY2hlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3hhY2hlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvejMyL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy96MzIvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy96MzIvcGFja2FnZS5qc29uIjp7fSwiL3BhY2thZ2UuanNvbiI6e30sIi9ycGMtY29tbWFuZHMubWpzIjp7IiNwYWNrYWdlIjoiL3BhY2thZ2UuanNvbiJ9fSwiYWRkb25zIjpbImxpbmtlZDpiYXJlLWNyeXB0by4xLjEyLjAuZnJhbWV3b3JrL2JhcmUtY3J5cHRvLjEuMTIuMCIsImxpbmtlZDpiYXJlLWZzLjQuNS4yLmZyYW1ld29yay9iYXJlLWZzLjQuNS4yIiwibGlua2VkOmJhcmUtb3MuMy42LjIuZnJhbWV3b3JrL2JhcmUtb3MuMy42LjIiLCJsaW5rZWQ6YmFyZS11cmwuMi4zLjIuZnJhbWV3b3JrL2JhcmUtdXJsLjIuMy4yIiwibGlua2VkOmZzLW5hdGl2ZS1leHRlbnNpb25zLjEuNC41LmZyYW1ld29yay9mcy1uYXRpdmUtZXh0ZW5zaW9ucy4xLjQuNSIsImxpbmtlZDpxdWlja2JpdC1uYXRpdmUuMi40LjguZnJhbWV3b3JrL3F1aWNrYml0LW5hdGl2ZS4yLjQuOCIsImxpbmtlZDpyb2Nrc2RiLW5hdGl2ZS4zLjExLjQuZnJhbWV3b3JrL3JvY2tzZGItbmF0aXZlLjMuMTEuNCIsImxpbmtlZDpzaW1kbGUtbmF0aXZlLjEuMy45LmZyYW1ld29yay9zaW1kbGUtbmF0aXZlLjEuMy45IiwibGlua2VkOnNvZGl1bS1uYXRpdmUuNS4wLjEwLmZyYW1ld29yay9zb2RpdW0tbmF0aXZlLjUuMC4xMCIsImxpbmtlZDp1ZHgtbmF0aXZlLjEuMTkuMi5mcmFtZXdvcmsvdWR4LW5hdGl2ZS4xLjE5LjIiXSwiYXNzZXRzIjpbXSwiZmlsZXMiOnsiL2JhY2tlbmQvYmFja2VuZC5tanMiOnsib2Zmc2V0IjowLCJsZW5ndGgiOjY3ODksIm1vZGUiOjQyMH0sIi9iYWNrZW5kL2xpYi9hdXRvYmFzZS5tanMiOnsib2Zmc2V0Ijo2Nzg5LCJsZW5ndGgiOjI0NTM2LCJtb2RlIjo0MjB9LCIvYmFja2VuZC9saWIvZXJyb3JzLm1qcyI6eyJvZmZzZXQiOjMxMzI1LCJsZW5ndGgiOjExNjM1LCJtb2RlIjo0MjB9LCIvYmFja2VuZC9saWIvaXRlbXMubWpzIjp7Im9mZnNldCI6NDI5NjAsImxlbmd0aCI6OTMwNywibW9kZSI6NDIwfSwiL2JhY2tlbmQvbGliL2tleXMubWpzIjp7Im9mZnNldCI6NTIyNjcsImxlbmd0aCI6MTgzNiwibW9kZSI6NDIwfSwiL2JhY2tlbmQvbGliL25ldHdvcmtpbmcubWpzIjp7Im9mZnNldCI6NTQxMDMsImxlbmd0aCI6MTAxNjAsIm1vZGUiOjQyMH0sIi9iYWNrZW5kL2xpYi9zdGF0ZS5tanMiOnsib2Zmc2V0Ijo2NDI2MywibGVuZ3RoIjoxNzM4LCJtb2RlIjo0MjB9LCIvYmFja2VuZC9saWIvc3RvcmFnZS5tanMiOnsib2Zmc2V0Ijo2NjAwMSwibGVuZ3RoIjo3NjUwLCJtb2RlIjo0MjB9LCIvYmFja2VuZC9saWIvdXRpbHMubWpzIjp7Im9mZnNldCI6NzM2NTEsImxlbmd0aCI6NDQzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vaW5kZXguanMiOnsib2Zmc2V0Ijo3NDA5NCwibGVuZ3RoIjoxNjcyMiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL2xpYi9icmlkZ2UuanMiOnsib2Zmc2V0Ijo5MDgxNiwibGVuZ3RoIjoxMjczLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vbGliL2hhbmRzaGFrZS5qcyI6eyJvZmZzZXQiOjkyMDg5LCJsZW5ndGgiOjE5NTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo5NDAzOSwibGVuZ3RoIjoxMTMyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2VuY29kaW5nL2xlZ2FjeS5qcyI6eyJvZmZzZXQiOjk1MTcxLCJsZW5ndGgiOjg4NDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvZW5jb2Rpbmcvc3BlYy9hdXRvYmFzZS9pbmRleC5qcyI6eyJvZmZzZXQiOjEwNDAxOSwibGVuZ3RoIjoxODkxOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9pbmRleC5qcyI6eyJvZmZzZXQiOjEyMjkzNywibGVuZ3RoIjo1ODE0OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYWN0aXZlLXdyaXRlcnMuanMiOnsib2Zmc2V0IjoxODEwODUsImxlbmd0aCI6NzM2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9hcHBlbmQtYmF0Y2guanMiOnsib2Zmc2V0IjoxODE4MjEsImxlbmd0aCI6MTQyNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwbHktY2FsbHMuanMiOnsib2Zmc2V0IjoxODMyNDcsImxlbmd0aCI6MjI3NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwbHktc3RhdGUuanMiOnsib2Zmc2V0IjoxODU1MjIsImxlbmd0aCI6NDUyMzYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Jvb3QuanMiOnsib2Zmc2V0IjoyMzA3NTgsImxlbmd0aCI6MzQ2MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY2Fwcy5qcyI6eyJvZmZzZXQiOjIzNDIxOSwibGVuZ3RoIjo1MDUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Nsb2NrLmpzIjp7Im9mZnNldCI6MjM0NzI0LCJsZW5ndGgiOjc0OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY29uc2Vuc3VzLmpzIjp7Im9mZnNldCI6MjM1NDczLCJsZW5ndGgiOjExNzU0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9lbmNyeXB0aW9uLmpzIjp7Im9mZnNldCI6MjQ3MjI3LCJsZW5ndGgiOjk0NDQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Zhc3QtZm9yd2FyZC5qcyI6eyJvZmZzZXQiOjI1NjY3MSwibGVuZ3RoIjo1NzE0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9mb3JrLmpzIjp7Im9mZnNldCI6MjYyMzg1LCJsZW5ndGgiOjQyMzAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2xpbmVhcml6ZXIuanMiOnsib2Zmc2V0IjoyNjY2MTUsImxlbmd0aCI6OTY5NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbG9jYWwtc3RhdGUuanMiOnsib2Zmc2V0IjoyNzYzMTEsImxlbmd0aCI6MjAxMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiOnsib2Zmc2V0IjoyNzgzMjQsImxlbmd0aCI6ODI3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9ub2RlLWJ1ZmZlci5qcyI6eyJvZmZzZXQiOjI3OTE1MSwibGVuZ3RoIjoxNTYzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9zdG9yZS5qcyI6eyJvZmZzZXQiOjI4MDcxNCwibGVuZ3RoIjoxNDEwNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvc3lzdGVtLmpzIjp7Im9mZnNldCI6Mjk0ODIxLCJsZW5ndGgiOjIwMTc2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi90aW1lci5qcyI6eyJvZmZzZXQiOjMxNDk5NywibGVuZ3RoIjoyOTM3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi90b3BvbGlzdC5qcyI6eyJvZmZzZXQiOjMxNzkzNCwibGVuZ3RoIjo1MTA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi91cGRhdGVzLmpzIjp7Im9mZnNldCI6MzIzMDQyLCJsZW5ndGgiOjExNDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3ZhbHVlcy5qcyI6eyJvZmZzZXQiOjMyNDE5MCwibGVuZ3RoIjoxNTM5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi93YWtldXAuanMiOnsib2Zmc2V0IjozMjU3MjksImxlbmd0aCI6NDAzNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvd3JpdGVyLmpzIjp7Im9mZnNldCI6MzI5NzYzLCJsZW5ndGgiOjg5MDEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MzM4NjY0LCJsZW5ndGgiOjIyNDksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIjp7Im9mZnNldCI6MzQwOTEzLCJsZW5ndGgiOjQwNTQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYjRhL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjM0NDk2NywibGVuZ3RoIjoxMTQwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2JpbmRpbmcuanMiOnsib2Zmc2V0IjozNDYxMDcsImxlbmd0aCI6MzMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vaW5kZXguanMiOnsib2Zmc2V0IjozNDYxNDAsImxlbmd0aCI6MTYxMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvY2lwaGVyLmpzIjp7Im9mZnNldCI6MzQ3NzUxLCJsZW5ndGgiOjczNjYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NvbnN0YW50cy5qcyI6eyJvZmZzZXQiOjM1NTExNywibGVuZ3RoIjoyMzEzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9lcnJvcnMuanMiOnsib2Zmc2V0IjozNTc0MzAsImxlbmd0aCI6OTU3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9oYXNoLmpzIjp7Im9mZnNldCI6MzU4Mzg3LCJsZW5ndGgiOjgyOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvaG1hYy5qcyI6eyJvZmZzZXQiOjM1OTIxNiwibGVuZ3RoIjoxMDE1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9rZXkuanMiOnsib2Zmc2V0IjozNjAyMzEsImxlbmd0aCI6MTA2NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvcGJrZGYyLmpzIjp7Im9mZnNldCI6MzYxMjk4LCJsZW5ndGgiOjcxMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvcmFuZG9tLmpzIjp7Im9mZnNldCI6MzYyMDExLCJsZW5ndGgiOjE3MDcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3NpZ25hdHVyZS5qcyI6eyJvZmZzZXQiOjM2MzcxOCwibGVuZ3RoIjoxMDEwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL2VkMjU1MTkuanMiOnsib2Zmc2V0IjozNjQ3MjgsImxlbmd0aCI6NjkxOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2FsZ29yaXRobS9obWFjLmpzIjp7Im9mZnNldCI6MzcxNjQ2LCJsZW5ndGgiOjQ5MjUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vcGJrZGYyLmpzIjp7Im9mZnNldCI6Mzc2NTcxLCJsZW5ndGgiOjE0NjcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vc2hhLmpzIjp7Im9mZnNldCI6Mzc4MDM4LCJsZW5ndGgiOjI5OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2NyeXB0by1rZXkuanMiOnsib2Zmc2V0IjozNzgzMzcsImxlbmd0aCI6OTcwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjM3OTMwNywibGVuZ3RoIjoxNDc1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3dlYi5qcyI6eyJvZmZzZXQiOjM4MDc4MiwibGVuZ3RoIjo3MzkzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIjp7Im9mZnNldCI6Mzg4MTc1LCJsZW5ndGgiOjgwMzMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvbGliL2Vycm9ycy5qcyI6eyJvZmZzZXQiOjM5NjIwOCwibGVuZ3RoIjo2NzEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6Mzk2ODc5LCJsZW5ndGgiOjEzOTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9iaW5kaW5nLmpzIjp7Im9mZnNldCI6Mzk4Mjc4LCJsZW5ndGgiOjMzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvaW5kZXguanMiOnsib2Zmc2V0IjozOTgzMTEsImxlbmd0aCI6NDgyNjcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9saWIvY29uc3RhbnRzLmpzIjp7Im9mZnNldCI6NDQ2NTc4LCJsZW5ndGgiOjE0OTQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9saWIvZXJyb3JzLmpzIjp7Im9mZnNldCI6NDQ4MDcyLCJsZW5ndGgiOjExNjMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo0NDkyMzUsImxlbmd0aCI6MTU0NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWZzL3Byb21pc2VzLmpzIjp7Im9mZnNldCI6NDUwNzgxLCJsZW5ndGgiOjE4NjYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1vcy9iaW5kaW5nLmpzIjp7Im9mZnNldCI6NDUyNjQ3LCJsZW5ndGgiOjMzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvaW5kZXguanMiOnsib2Zmc2V0Ijo0NTI2ODAsImxlbmd0aCI6MjQzMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2xpYi9jb25zdGFudHMuanMiOnsib2Zmc2V0Ijo0NTUxMTMsImxlbmd0aCI6MTEzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvbGliL2Vycm9ycy5qcyI6eyJvZmZzZXQiOjQ1NTIyNiwibGVuZ3RoIjo0NzksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1vcy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo0NTU3MDUsImxlbmd0aCI6MTAyMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvaW5kZXguanMiOnsib2Zmc2V0Ijo0NTY3MjgsImxlbmd0aCI6MzA2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvY29uc3RhbnRzLmpzIjp7Im9mZnNldCI6NDU3MDM0LCJsZW5ndGgiOjI0NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3Bvc2l4LmpzIjp7Im9mZnNldCI6NDU3MjgxLCJsZW5ndGgiOjU5OTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9zaGFyZWQuanMiOnsib2Zmc2V0Ijo0NjMyNzIsImxlbmd0aCI6MTg4OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3dpbjMyLmpzIjp7Im9mZnNldCI6NDY1MTYwLCJsZW5ndGgiOjEzNDI3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo0Nzg1ODcsImxlbmd0aCI6Nzk2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2luZGV4LmpzIjp7Im9mZnNldCI6NDc5MzgzLCJsZW5ndGgiOjEwMTk5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9jb21tYW5kLXJvdXRlci5qcyI6eyJvZmZzZXQiOjQ4OTU4MiwibGVuZ3RoIjoxMDczLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9jb25zdGFudHMuanMiOnsib2Zmc2V0Ijo0OTA2NTUsImxlbmd0aCI6MjcwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9lcnJvcnMuanMiOnsib2Zmc2V0Ijo0OTA5MjUsImxlbmd0aCI6NTk3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9pbmNvbWluZy1yZXF1ZXN0LmpzIjp7Im9mZnNldCI6NDkxNTIyLCJsZW5ndGgiOjEyNDEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2luY29taW5nLXN0cmVhbS5qcyI6eyJvZmZzZXQiOjQ5Mjc2MywibGVuZ3RoIjoxMjYzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9tZXNzYWdlcy5qcyI6eyJvZmZzZXQiOjQ5NDAyNiwibGVuZ3RoIjozOTM0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9vdXRnb2luZy1yZXF1ZXN0LmpzIjp7Im9mZnNldCI6NDk3OTYwLCJsZW5ndGgiOjE2NzAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL291dGdvaW5nLXN0cmVhbS5qcyI6eyJvZmZzZXQiOjQ5OTYzMCwibGVuZ3RoIjoyMzc0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjUwMjAwNCwibGVuZ3RoIjoxMjA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL2luZGV4LmpzIjp7Im9mZnNldCI6NTAzMjEyLCJsZW5ndGgiOjc2NTgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1zdHJlYW0vcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTEwODcwLCJsZW5ndGgiOjEzMDcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS11cmwvYmluZGluZy5qcyI6eyJvZmZzZXQiOjUxMjE3NywibGVuZ3RoIjozMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9pbmRleC5qcyI6eyJvZmZzZXQiOjUxMjIxMCwibGVuZ3RoIjo5MjYxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2xpYi9lcnJvcnMuanMiOnsib2Zmc2V0Ijo1MjE0NzEsImxlbmd0aCI6Nzc4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2xpYi91cmwtc2VhcmNoLXBhcmFtcy5qcyI6eyJvZmZzZXQiOjUyMjI0OSwibGVuZ3RoIjozODY3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjUyNjExNiwibGVuZ3RoIjoxMTA1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JpZy1zcGFyc2UtYXJyYXkvaW5kZXguanMiOnsib2Zmc2V0Ijo1MjcyMjEsImxlbmd0aCI6MjQ3MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iaWctc3BhcnNlLWFycmF5L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjUyOTY5MiwibGVuZ3RoIjo2MzYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYml0cy10by1ieXRlcy9pbmRleC5qcyI6eyJvZmZzZXQiOjUzMDMyOCwibGVuZ3RoIjozMDgzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JpdHMtdG8tYnl0ZXMvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTMzNDExLCJsZW5ndGgiOjcwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ibGluZC1yZWxheS9pbmRleC5qcyI6eyJvZmZzZXQiOjUzNDExOSwibGVuZ3RoIjoxMDg1MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ibGluZC1yZWxheS9saWIvZXJyb3JzLmpzIjp7Im9mZnNldCI6NTQ0OTcwLCJsZW5ndGgiOjEwNDMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmxpbmQtcmVsYXkvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTQ2MDEzLCJsZW5ndGgiOjEwNDYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYm9nb24vaW5kZXguanMiOnsib2Zmc2V0Ijo1NDcwNTksImxlbmd0aCI6Mzk2MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ib2dvbi9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo1NTEwMjAsImxlbmd0aCI6NjU3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvZGVjcy9pbmRleC5qcyI6eyJvZmZzZXQiOjU1MTY3NywibGVuZ3RoIjoyNDE2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvZGVjcy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo1NTQwOTMsImxlbmd0aCI6NjU1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctYml0ZmllbGQvaW5kZXguanMiOnsib2Zmc2V0Ijo1NTQ3NDgsImxlbmd0aCI6MTk2MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjU1NjcxMSwibGVuZ3RoIjo4MjcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1uZXQvaW5kZXguanMiOnsib2Zmc2V0Ijo1NTc1MzgsImxlbmd0aCI6NDEwOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLW5ldC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo1NjE2NDcsImxlbmd0aCI6NzM0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvZW5kaWFuLmpzIjp7Im9mZnNldCI6NTYyMzgxLCJsZW5ndGgiOjEwNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIjp7Im9mZnNldCI6NTYyNDg2LCJsZW5ndGgiOjIzNjM0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvbGV4aW50LmpzIjp7Im9mZnNldCI6NTg2MTIwLCJsZW5ndGgiOjI4NTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo1ODg5NzEsImxlbmd0aCI6ODAxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvcmF3LmpzIjp7Im9mZnNldCI6NTg5NzcyLCJsZW5ndGgiOjQwOTMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29yZS1jb3VwbGVyL2luZGV4LmpzIjp7Im9mZnNldCI6NTkzODY1LCJsZW5ndGgiOjIyNDMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29yZS1jb3VwbGVyL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjU5NjEwOCwibGVuZ3RoIjo1OTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29yZXN0b3JlL2luZGV4LmpzIjp7Im9mZnNldCI6NTk2NzA3LCJsZW5ndGgiOjE3ODYyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9saWIvYXVkaXQuanMiOnsib2Zmc2V0Ijo2MTQ1NjksImxlbmd0aCI6NDc1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo2MTUwNDQsImxlbmd0aCI6MTA4NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kZWJvdW5jZWlmeS9pbmRleC5qcyI6eyJvZmZzZXQiOjYxNjEyOSwibGVuZ3RoIjo1ODUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGVib3VuY2VpZnkvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NjE2NzE0LCJsZW5ndGgiOjU2NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kZXZpY2UtZmlsZS9pbmRleC5qcyI6eyJvZmZzZXQiOjYxNzI4MSwibGVuZ3RoIjo1OTAwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RldmljZS1maWxlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjYyMzE4MSwibGVuZ3RoIjoxMDYzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvaW5kZXguanMiOnsib2Zmc2V0Ijo2MjQyNDQsImxlbmd0aCI6MjU0MDMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvY29tbWFuZHMuanMiOnsib2Zmc2V0Ijo2NDk2NDcsImxlbmd0aCI6ODIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvZXJyb3JzLmpzIjp7Im9mZnNldCI6NjQ5NzI5LCJsZW5ndGgiOjcxOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9pby5qcyI6eyJvZmZzZXQiOjY1MDQ0OCwibGVuZ3RoIjoxNTkyNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9wZWVyLmpzIjp7Im9mZnNldCI6NjY2Mzc0LCJsZW5ndGgiOjYzMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9xdWVyeS5qcyI6eyJvZmZzZXQiOjY2NzAwNSwibGVuZ3RoIjo5OTEzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL3Nlc3Npb24uanMiOnsib2Zmc2V0Ijo2NzY5MTgsImxlbmd0aCI6MTEwMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjY3ODAyMSwibGVuZ3RoIjoxMzU2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2V2ZW50cy11bml2ZXJzYWwvYmFyZS5qcyI6eyJvZmZzZXQiOjY3OTM3NywibGVuZ3RoIjo0MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ldmVudHMtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjY3OTQxNywibGVuZ3RoIjo5MDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZmFzdC1maWZvL2ZpeGVkLXNpemUuanMiOnsib2Zmc2V0Ijo2ODAzMjUsImxlbmd0aCI6ODc1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9pbmRleC5qcyI6eyJvZmZzZXQiOjY4MTIwMCwibGVuZ3RoIjo5NzIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZmFzdC1maWZvL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjY4MjE3MiwibGVuZ3RoIjo2ODIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZmQtbG9jay9pbmRleC5qcyI6eyJvZmZzZXQiOjY4Mjg1NCwibGVuZ3RoIjoxNjYxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2ZkLWxvY2svcGFja2FnZS5qc29uIjp7Im9mZnNldCI6Njg0NTE1LCJsZW5ndGgiOjEwOTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIjp7Im9mZnNldCI6Njg1NjE0LCJsZW5ndGgiOjgxNjQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZmxhdC10cmVlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjY5Mzc3OCwibGVuZ3RoIjo2MzEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvYmluZGluZy5qcyI6eyJvZmZzZXQiOjY5NDQwOSwibGVuZ3RoIjo5MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9pbmRleC5qcyI6eyJvZmZzZXQiOjY5NDQ5OSwibGVuZ3RoIjo1NzE4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2ZzLW5hdGl2ZS1leHRlbnNpb25zL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjcwMDIxNywibGVuZ3RoIjoxNjk5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2luZGV4LmpzIjp7Im9mZnNldCI6NzAxOTE2LCJsZW5ndGgiOjQ2MTIwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9kaWZmLmpzIjp7Im9mZnNldCI6NzQ4MDM2LCJsZW5ndGgiOjUzNjgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL2hpc3RvcnkuanMiOnsib2Zmc2V0Ijo3NTM0MDQsImxlbmd0aCI6MTY0MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvbG9jYWwuanMiOnsib2Zmc2V0Ijo3NTUwNDYsImxlbmd0aCI6MTE4MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvcmFuZ2UuanMiOnsib2Zmc2V0Ijo3NTYyMjYsImxlbmd0aCI6NDczNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9saWIvZXh0ZW5zaW9uLmpzIjp7Im9mZnNldCI6NzYwOTYwLCJsZW5ndGgiOjM0NDUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvbGliL21lc3NhZ2VzLmpzIjp7Im9mZnNldCI6NzY0NDA1LCJsZW5ndGgiOjI4MTYyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjc5MjU2NywibGVuZ3RoIjoxMjE2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiOnsib2Zmc2V0Ijo3OTM3ODMsImxlbmd0aCI6NTA0MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjc5ODgyMywibGVuZ3RoIjo3NzEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9pbmRleC5qcyI6eyJvZmZzZXQiOjc5OTU5NCwibGVuZ3RoIjo0ODk2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6ODA0NDkwLCJsZW5ndGgiOjY4OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvaW5kZXguanMiOnsib2Zmc2V0Ijo4MDUxNzgsImxlbmd0aCI6OTIzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1pZC1lbmNvZGluZy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo4MDYxMDEsImxlbmd0aCI6Nzk5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2luZGV4LmpzIjp7Im9mZnNldCI6ODA2OTAwLCJsZW5ndGgiOjI3NTUxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9ibG9jay1kZXBlbmRlbmN5LXN0cmVhbS5qcyI6eyJvZmZzZXQiOjgzNDQ1MSwibGVuZ3RoIjoyNTU3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9jbG9zZS1lcnJvci1zdHJlYW0uanMiOnsib2Zmc2V0Ijo4MzcwMDgsImxlbmd0aCI6Mjc2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9rZXlzLmpzIjp7Im9mZnNldCI6ODM3Mjg0LCJsZW5ndGgiOjc0NTQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3N0cmVhbXMuanMiOnsib2Zmc2V0Ijo4NDQ3MzgsImxlbmd0aCI6NDgyMCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvdHguanMiOnsib2Zmc2V0Ijo4NDk1NTgsImxlbmd0aCI6ODQxNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvdmlldy5qcyI6eyJvZmZzZXQiOjg1Nzk3NCwibGVuZ3RoIjo4Mzc4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL21pZ3JhdGlvbnMvMC9pbmRleC5qcyI6eyJvZmZzZXQiOjg2NjM1MiwibGVuZ3RoIjoyMDEyNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9taWdyYXRpb25zLzAvbWVzc2FnZXMuanMiOnsib2Zmc2V0Ijo4ODY0NzcsImxlbmd0aCI6MjYyMTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6OTEyNjg3LCJsZW5ndGgiOjEyNDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2Uvc3BlYy9oeXBlcnNjaGVtYS9pbmRleC5qcyI6eyJvZmZzZXQiOjkxMzkzNSwibGVuZ3RoIjoxMzEwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvaW5kZXguanMiOnsib2Zmc2V0Ijo5MjcwNDMsImxlbmd0aCI6MzM4NTUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9hdWRpdC5qcyI6eyJvZmZzZXQiOjk2MDg5OCwibGVuZ3RoIjozODM0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvYml0LWludGVybHVkZS5qcyI6eyJvZmZzZXQiOjk2NDczMiwibGVuZ3RoIjo0MjU3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvYml0ZmllbGQuanMiOnsib2Zmc2V0Ijo5Njg5ODksImxlbmd0aCI6MTE4NTQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jYXBzLmpzIjp7Im9mZnNldCI6OTgwODQzLCJsZW5ndGgiOjE1MzcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb21wYXQuanMiOnsib2Zmc2V0Ijo5ODIzODAsImxlbmd0aCI6NDc3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY29weS1wcm9sb2d1ZS5qcyI6eyJvZmZzZXQiOjk4Mjg1NywibGVuZ3RoIjo1OTk5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY29yZS5qcyI6eyJvZmZzZXQiOjk4ODg1NiwibGVuZ3RoIjoyNDQxOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2RlZmF1bHQtZW5jcnlwdGlvbi5qcyI6eyJvZmZzZXQiOjEwMTMyNzUsImxlbmd0aCI6MzQ1MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2Rvd25sb2FkLmpzIjp7Im9mZnNldCI6MTAxNjcyOCwibGVuZ3RoIjoxMjc4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvaG90c3dhcC1xdWV1ZS5qcyI6eyJvZmZzZXQiOjEwMTgwMDYsImxlbmd0aCI6MTQ5OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2luZm8uanMiOnsib2Zmc2V0IjoxMDE5NTA0LCJsZW5ndGgiOjE1MTcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9pbnNwZWN0LmpzIjp7Im9mZnNldCI6MTAyMTAyMSwibGVuZ3RoIjoxOTgzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVya2xlLXRyZWUuanMiOnsib2Zmc2V0IjoxMDIzMDA0LCJsZW5ndGgiOjMzOTEwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVzc2FnZXMuanMiOnsib2Zmc2V0IjoxMDU2OTE0LCJsZW5ndGgiOjI3NjMzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXVsdGlzaWcuanMiOnsib2Zmc2V0IjoxMDg0NTQ3LCJsZW5ndGgiOjI4NTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tdXRleC5qcyI6eyJvZmZzZXQiOjEwODczOTgsImxlbmd0aCI6MTAyOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3JlY2VpdmVyLXF1ZXVlLmpzIjp7Im9mZnNldCI6MTA4ODQyNiwibGVuZ3RoIjoxNDEzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVtb3RlLWJpdGZpZWxkLmpzIjp7Im9mZnNldCI6MTA4OTgzOSwibGVuZ3RoIjo4MDc5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVwbGljYXRvci5qcyI6eyJvZmZzZXQiOjEwOTc5MTgsImxlbmd0aCI6ODA3ODEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9zZXNzaW9uLXN0YXRlLmpzIjp7Im9mZnNldCI6MTE3ODY5OSwibGVuZ3RoIjozMjIyNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3N0cmVhbXMuanMiOnsib2Zmc2V0IjoxMjEwOTI0LCJsZW5ndGgiOjMwMzQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi92ZXJpZmllci5qcyI6eyJvZmZzZXQiOjEyMTM5NTgsImxlbmd0aCI6OTY3OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTIyMzYzNiwibGVuZ3RoIjoyMTk3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2luZGV4LmpzIjp7Im9mZnNldCI6MTIyNTgzMywibGVuZ3RoIjoxNjA5OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvYW5ub3VuY2VyLmpzIjp7Im9mZnNldCI6MTI0MTkzMiwibGVuZ3RoIjo3NTMzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25uZWN0LmpzIjp7Im9mZnNldCI6MTI0OTQ2NSwibGVuZ3RoIjoyMzY2OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29ubmVjdGlvbi1wb29sLmpzIjp7Im9mZnNldCI6MTI3MzEzMywibGVuZ3RoIjozMDUwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiOnsib2Zmc2V0IjoxMjc2MTgzLCJsZW5ndGgiOjEyMTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2NyeXB0by5qcyI6eyJvZmZzZXQiOjEyNzczOTQsImxlbmd0aCI6NjMyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lbmNvZGUuanMiOnsib2Zmc2V0IjoxMjc4MDI2LCJsZW5ndGgiOjQ0NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZXJyb3JzLmpzIjp7Im9mZnNldCI6MTI3ODQ3MiwibGVuZ3RoIjozNzEyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9ob2xlcHVuY2hlci5qcyI6eyJvZmZzZXQiOjEyODIxODQsImxlbmd0aCI6MTAwMDMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL21lc3NhZ2VzLmpzIjp7Im9mZnNldCI6MTI5MjE4NywibGVuZ3RoIjoxMTI2NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbmF0LmpzIjp7Im9mZnNldCI6MTMwMzQ1MywibGVuZ3RoIjo0NzE0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9ub2lzZS13cmFwLmpzIjp7Im9mZnNldCI6MTMwODE2NywibGVuZ3RoIjoxNjY5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9wZXJzaXN0ZW50LmpzIjp7Im9mZnNldCI6MTMwOTgzNiwibGVuZ3RoIjo4MDg2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9yYXctc3RyZWFtLXNldC5qcyI6eyJvZmZzZXQiOjEzMTc5MjIsImxlbmd0aCI6MTUxMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvcm91dGVyLmpzIjp7Im9mZnNldCI6MTMxOTQzMywibGVuZ3RoIjo2OTc4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zZWN1cmUtcGF5bG9hZC5qcyI6eyJvZmZzZXQiOjEzMjY0MTEsImxlbmd0aCI6MTQ5MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VtYXBob3JlLmpzIjp7Im9mZnNldCI6MTMyNzkwMiwibGVuZ3RoIjoxNTc3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zZXJ2ZXIuanMiOnsib2Zmc2V0IjoxMzI5NDc5LCJsZW5ndGgiOjIxMTU2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zbGVlcGVyLmpzIjp7Im9mZnNldCI6MTM1MDYzNSwibGVuZ3RoIjo2OTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NvY2tldC1wb29sLmpzIjp7Im9mZnNldCI6MTM1MTMyNSwibGVuZ3RoIjo0MzQzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjEzNTU2NjgsImxlbmd0aCI6MjAxMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcnNjaGVtYS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxMzU3Njc5LCJsZW5ndGgiOjE1NTYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJzY2hlbWEvcnVudGltZS5janMiOnsib2Zmc2V0IjoxMzU5MjM1LCJsZW5ndGgiOjU0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vaW5kZXguanMiOnsib2Zmc2V0IjoxMzU5Mjg5LCJsZW5ndGgiOjE4NDI5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL2J1bGstdGltZXIuanMiOnsib2Zmc2V0IjoxMzc3NzE4LCJsZW5ndGgiOjcyOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9jb25uZWN0aW9uLXNldC5qcyI6eyJvZmZzZXQiOjEzNzg0NDYsImxlbmd0aCI6ODIzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL3BlZXItZGlzY292ZXJ5LmpzIjp7Im9mZnNldCI6MTM3OTI2OSwibGVuZ3RoIjo5Mjg2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL3BlZXItaW5mby5qcyI6eyJvZmZzZXQiOjEzODg1NTUsImxlbmd0aCI6MjY4OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9yZXRyeS10aW1lci5qcyI6eyJvZmZzZXQiOjEzOTEyNDMsImxlbmd0aCI6MTg4OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjEzOTMxMzIsImxlbmd0aCI6MTIyOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9pbmRleC1lbmNvZGVyL2luZGV4LmpzIjp7Im9mZnNldCI6MTM5NDM2MCwibGVuZ3RoIjo2NzYyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2luZGV4LWVuY29kZXIvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQwMTEyMiwibGVuZ3RoIjo3MjksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaXMtb3B0aW9ucy9pbmRleC5qcyI6eyJvZmZzZXQiOjE0MDE4NTEsImxlbmd0aCI6MTQwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2lzLW9wdGlvbnMvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQwMTk5MSwibGVuZ3RoIjo2MDUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMva2FkZW1saWEtcm91dGluZy10YWJsZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE0MDI1OTYsImxlbmd0aCI6NDE0NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0MDY3NDEsImxlbmd0aCI6OTY3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L2luZGV4LmpzIjp7Im9mZnNldCI6MTQwNzcwOCwibGVuZ3RoIjo1MzYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbXV0ZXhpZnkvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQwODI0NCwibGVuZ3RoIjo2NzksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbXV0ZXhpZnkvcHJvbWlzZS5qcyI6eyJvZmZzZXQiOjE0MDg5MjMsImxlbmd0aCI6MzI0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMiOnsib2Zmc2V0IjoxNDA5MjQ3LCJsZW5ndGgiOjQzOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0MDk2ODUsImxlbmd0aCI6NjQ3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25hdC1zYW1wbGVyL2luZGV4LmpzIjp7Im9mZnNldCI6MTQxMDMzMiwibGVuZ3RoIjoxNTUwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25hdC1zYW1wbGVyL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0MTE4ODIsImxlbmd0aCI6NjA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWN1cnZlLWVkL2luZGV4LmpzIjp7Im9mZnNldCI6MTQxMjQ5MCwibGVuZ3RoIjoxNjQyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWN1cnZlLWVkL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0MTQxMzIsImxlbmd0aCI6ODA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9jaXBoZXIuanMiOnsib2Zmc2V0IjoxNDE0OTQwLCJsZW5ndGgiOjI4MTcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2RoLmpzIjp7Im9mZnNldCI6MTQxNzc1NywibGVuZ3RoIjoxNDM5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9oa2RmLmpzIjp7Im9mZnNldCI6MTQxOTE5NiwibGVuZ3RoIjoxMDkyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9obWFjLmpzIjp7Im9mZnNldCI6MTQyMDI4OCwibGVuZ3RoIjoxMjczLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9ub2lzZS5qcyI6eyJvZmZzZXQiOjE0MjE1NjEsImxlbmd0aCI6NjQzNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQyNzk5OCwibGVuZ3RoIjo2MzgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL3N5bW1ldHJpYy1zdGF0ZS5qcyI6eyJvZmZzZXQiOjE0Mjg2MzYsImxlbmd0aCI6MjIwNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9wcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncy9pbmRleC5qcyI6eyJvZmZzZXQiOjE0MzA4NDIsImxlbmd0aCI6NjQ4OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9wcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDM3MzMxLCJsZW5ndGgiOjcxOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9wcm90b211eC13YWtldXAvaW5kZXguanMiOnsib2Zmc2V0IjoxNDM4MDUwLCJsZW5ndGgiOjE2ODI0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDU0ODc0LCJsZW5ndGgiOjk3MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9wcm90b211eC13YWtldXAvc3BlYy9oeXBlcnNjaGVtYS9pbmRleC5qcyI6eyJvZmZzZXQiOjE0NTU4NDYsImxlbmd0aCI6MzMzNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9wcm90b211eC9pbmRleC5qcyI6eyJvZmZzZXQiOjE0NTkxODEsImxlbmd0aCI6MTg5OTYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcHJvdG9tdXgvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQ3ODE3NywibGVuZ3RoIjo4MTYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcXVldWUtdGljay9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDc4OTkzLCJsZW5ndGgiOjY2OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3Byb2Nlc3MtbmV4dC10aWNrLmpzIjp7Im9mZnNldCI6MTQ3OTY2MiwibGVuZ3RoIjoxNjAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcXVldWUtdGljay9xdWV1ZS1taWNyb3Rhc2suanMiOnsib2Zmc2V0IjoxNDc5ODIyLCJsZW5ndGgiOjEwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC1uYXRpdmUvYmluZGluZy5qcyI6eyJvZmZzZXQiOjE0Nzk5MzAsImxlbmd0aCI6OTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtbmF0aXZlL2luZGV4LmpzIjp7Im9mZnNldCI6MTQ4MDAyMCwibGVuZ3RoIjo0NjgzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LW5hdGl2ZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDg0NzAzLCJsZW5ndGgiOjExMDQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL2ZhbGxiYWNrLmpzIjp7Im9mZnNldCI6MTQ4NTgwNywibGVuZ3RoIjoxMDIwNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvaW5kZXguanMiOnsib2Zmc2V0IjoxNDk2MDExLCJsZW5ndGgiOjQ0MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQ5NjQ1MywibGVuZ3RoIjo5MDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmFjaGUvaW5kZXguanMiOnsib2Zmc2V0IjoxNDk3MzYxLCJsZW5ndGgiOjI0NjMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmFjaGUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQ5OTgyNCwibGVuZ3RoIjo2MDIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmFuZG9tLWFycmF5LWl0ZXJhdG9yL2luZGV4LmpzIjp7Im9mZnNldCI6MTUwMDQyNiwibGVuZ3RoIjoxMDAxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JhbmRvbS1hcnJheS1pdGVyYXRvci9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTAxNDI3LCJsZW5ndGgiOjcwMCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE1MDIxMjcsImxlbmd0aCI6MTA5MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTAzMjE4LCJsZW5ndGgiOjgxMiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZWNvcmQtY2FjaGUvaW5kZXguanMiOnsib2Zmc2V0IjoxNTA0MDMwLCJsZW5ndGgiOjM2NjgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVjb3JkLWNhY2hlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MDc2OTgsImxlbmd0aCI6NjEyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JlZmNvdW50ZXIvaW5kZXguanMiOnsib2Zmc2V0IjoxNTA4MzEwLCJsZW5ndGgiOjYxMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZWZjb3VudGVyL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MDg5MjEsImxlbmd0aCI6NDUxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vbGliL2JhcmUuanMiOnsib2Zmc2V0IjoxNTA5MzcyLCJsZW5ndGgiOjQ1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTUwOTQxNywibGVuZ3RoIjoxNDQ5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvaW5kZXguanMiOnsib2Zmc2V0IjoxNTEwODY2LCJsZW5ndGgiOjQ0MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZXNvbHZlLXJlamVjdC1wcm9taXNlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MTEzMDksImxlbmd0aCI6NTgxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Jlc291cmNlLW9uLWV4aXQvaW5kZXguanMiOnsib2Zmc2V0IjoxNTExODkwLCJsZW5ndGgiOjM2MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZXNvdXJjZS1vbi1leGl0L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MTIyNTEsImxlbmd0aCI6NDk2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2JpbmRpbmcuanMiOnsib2Zmc2V0IjoxNTEyNzQ3LCJsZW5ndGgiOjkwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2luZGV4LmpzIjp7Im9mZnNldCI6MTUxMjgzNywibGVuZ3RoIjo0NzA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9iYXRjaC5qcyI6eyJvZmZzZXQiOjE1MTc1NDUsImxlbmd0aCI6ODgxMiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvY29sdW1uLWZhbWlseS5qcyI6eyJvZmZzZXQiOjE1MjYzNTcsImxlbmd0aCI6MjY3NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvY29uc3RhbnRzLmpzIjp7Im9mZnNldCI6MTUyOTAzMSwibGVuZ3RoIjo5NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvZmlsdGVyLXBvbGljeS5qcyI6eyJvZmZzZXQiOjE1MjkxMjUsImxlbmd0aCI6NDM3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9pdGVyYXRvci5qcyI6eyJvZmZzZXQiOjE1Mjk1NjIsImxlbmd0aCI6NDMxMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvc25hcHNob3QuanMiOnsib2Zmc2V0IjoxNTMzODczLCJsZW5ndGgiOjUwMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvc3RhdGUuanMiOnsib2Zmc2V0IjoxNTM0Mzc2LCJsZW5ndGgiOjk3NjIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTU0NDEzOCwibGVuZ3RoIjoxNTM5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyI6eyJvZmZzZXQiOjE1NDU2NzcsImxlbmd0aCI6NTA2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTQ2MTgzLCJsZW5ndGgiOjU0NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zY29wZS1sb2NrL2luZGV4LmpzIjp7Im9mZnNldCI6MTU0NjczMCwibGVuZ3RoIjoxODIxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Njb3BlLWxvY2svcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTU0ODU1MSwibGVuZ3RoIjo2MTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2h1ZmZsZWQtcHJpb3JpdHktcXVldWUvaW5kZXguanMiOnsib2Zmc2V0IjoxNTQ5MTYyLCJsZW5ndGgiOjI2MDcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2h1ZmZsZWQtcHJpb3JpdHktcXVldWUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTU1MTc2OSwibGVuZ3RoIjo2OTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2lnbmFsLXByb21pc2UvaW5kZXguanMiOnsib2Zmc2V0IjoxNTUyNDYwLCJsZW5ndGgiOjEyNTIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2lnbmFsLXByb21pc2UvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTU1MzcxMiwibGVuZ3RoIjo1MDMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2lnbmVkLXZhcmludC9pbmRleC5qcyI6eyJvZmZzZXQiOjE1NTQyMTUsImxlbmd0aCI6NDM1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpZ25lZC12YXJpbnQvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTU1NDY1MCwibGVuZ3RoIjo1MjMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2ltZGxlLW5hdGl2ZS9iaW5kaW5nLmpzIjp7Im9mZnNldCI6MTU1NTE3MywibGVuZ3RoIjo5MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL2luZGV4LmpzIjp7Im9mZnNldCI6MTU1NTI2MywibGVuZ3RoIjozNDc0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS1uYXRpdmUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTU1ODczNywibGVuZ3RoIjoxMTE1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvZmFsbGJhY2suanMiOnsib2Zmc2V0IjoxNTU5ODUyLCJsZW5ndGgiOjUxMzcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9pbmRleC5qcyI6eyJvZmZzZXQiOjE1NjQ5ODksImxlbmd0aCI6MTAzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTU2NTA5MiwibGVuZ3RoIjo4NzksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9zY2FsYXIuanMiOnsib2Zmc2V0IjoxNTY1OTcxLCJsZW5ndGgiOjQ2OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tbmF0aXZlL2JpbmRpbmcuanMiOnsib2Zmc2V0IjoxNTY2NDQwLCJsZW5ndGgiOjg5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS1uYXRpdmUvaW5kZXguanMiOnsib2Zmc2V0IjoxNTY2NTI5LCJsZW5ndGgiOjY2MzI4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS1uYXRpdmUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTYzMjg1NywibGVuZ3RoIjoxMzU2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS1zZWNyZXRzdHJlYW0vaW5kZXguanMiOnsib2Zmc2V0IjoxNjM0MjEzLCJsZW5ndGgiOjIyNTcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc29kaXVtLXNlY3JldHN0cmVhbS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjM2NDcwLCJsZW5ndGgiOjY1NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIjp7Im9mZnNldCI6MTYzNzEyNywibGVuZ3RoIjo0MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2MzcxNjksImxlbmd0aCI6MTIxNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIjp7Im9mZnNldCI6MTYzODM4NiwibGVuZ3RoIjozMzM1MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zdHJlYW14L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2NzE3MzYsImxlbmd0aCI6ODM2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3N1Yi1lbmNvZGVyL2luZGV4LmpzIjp7Im9mZnNldCI6MTY3MjU3MiwibGVuZ3RoIjoxOTY4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3N1Yi1lbmNvZGVyL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2NzQ1NDAsImxlbmd0aCI6OTA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9pbmRleC5qcyI6eyJvZmZzZXQiOjE2NzU0NDgsImxlbmd0aCI6MTM3OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvbGliL3Bhc3MtdGhyb3VnaC1kZWNvZGVyLmpzIjp7Im9mZnNldCI6MTY3NjgyNiwibGVuZ3RoIjoyNzMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL2xpYi91dGY4LWRlY29kZXIuanMiOnsib2Zmc2V0IjoxNjc3MDk5LCJsZW5ndGgiOjI1MjksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2Nzk2MjgsImxlbmd0aCI6OTg3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RpbWUtb3JkZXJlZC1zZXQvaW5kZXguanMiOnsib2Zmc2V0IjoxNjgwNjE1LCJsZW5ndGgiOjE0NDQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGltZS1vcmRlcmVkLXNldC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjgyMDU5LCJsZW5ndGgiOjY2NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvYnJvd3Nlci5qcyI6eyJvZmZzZXQiOjE2ODI3MjUsImxlbmd0aCI6MTA5OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvaW5kZXguanMiOnsib2Zmc2V0IjoxNjgzODIzLCJsZW5ndGgiOjE4NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvbm9kZS5qcyI6eyJvZmZzZXQiOjE2ODQwMDcsImxlbmd0aCI6OTI4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjg0OTM1LCJsZW5ndGgiOjYxOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90aW55LWJ1ZmZlci1tYXAvaW5kZXguanMiOnsib2Zmc2V0IjoxNjg1NTU0LCJsZW5ndGgiOjkzNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90aW55LWJ1ZmZlci1tYXAvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTY4NjQ5MCwibGVuZ3RoIjo2NTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9iaW5kaW5nLmpzIjp7Im9mZnNldCI6MTY4NzE0MCwibGVuZ3RoIjo5MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9pcC5qcyI6eyJvZmZzZXQiOjE2ODcyMzAsImxlbmd0aCI6MjIwNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9uZXR3b3JrLWludGVyZmFjZXMuanMiOnsib2Zmc2V0IjoxNjg5NDM0LCJsZW5ndGgiOjEzNDEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvc29ja2V0LmpzIjp7Im9mZnNldCI6MTY5MDc3NSwibGVuZ3RoIjo3NTU3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL3N0cmVhbS5qcyI6eyJvZmZzZXQiOjE2OTgzMzIsImxlbmd0aCI6MTI3MDYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvdWR4LmpzIjp7Im9mZnNldCI6MTcxMTAzOCwibGVuZ3RoIjoyODY4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTcxMzkwNiwibGVuZ3RoIjoxNjE1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Vub3JkZXJlZC1zZXQvaW5kZXguanMiOnsib2Zmc2V0IjoxNzE1NTIxLCJsZW5ndGgiOjY3NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91bm9yZGVyZWQtc2V0L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE3MTYxOTgsImxlbmd0aCI6NjU0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyI6eyJvZmZzZXQiOjE3MTY4NTIsImxlbmd0aCI6OTEzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNzE3NzY1LCJsZW5ndGgiOjYxMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy92YXJpbnQvZGVjb2RlLmpzIjp7Im9mZnNldCI6MTcxODM3OCwibGVuZ3RoIjo1MDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdmFyaW50L2VuY29kZS5qcyI6eyJvZmZzZXQiOjE3MTg4ODYsImxlbmd0aCI6NDUyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3ZhcmludC9pbmRleC5qcyI6eyJvZmZzZXQiOjE3MTkzMzgsImxlbmd0aCI6MTM0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3ZhcmludC9sZW5ndGguanMiOnsib2Zmc2V0IjoxNzE5NDcyLCJsZW5ndGgiOjQ3MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy92YXJpbnQvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTcxOTk0MywibGVuZ3RoIjo1MTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvd2hpY2gtcnVudGltZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE3MjA0NTQsImxlbmd0aCI6MTIzMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy93aGljaC1ydW50aW1lL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE3MjE2ODUsImxlbmd0aCI6NjAyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3hhY2hlL2luZGV4LmpzIjp7Im9mZnNldCI6MTcyMjI4NywibGVuZ3RoIjoyMzc4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3hhY2hlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE3MjQ2NjUsImxlbmd0aCI6NTg0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3ozMi9pbmRleC5qcyI6eyJvZmZzZXQiOjE3MjUyNDksImxlbmd0aCI6MjY1NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy96MzIvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTcyNzkwMywibGVuZ3RoIjo3MDEsIm1vZGUiOjQyMH0sIi9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNzI4NjA0LCJsZW5ndGgiOjIyMjksIm1vZGUiOjQyMH0sIi9ycGMtY29tbWFuZHMubWpzIjp7Im9mZnNldCI6MTczMDgzMywibGVuZ3RoIjozNzksIm1vZGUiOjQyMH19fQovLyBCYWNrZW5kIG1haW4gZW50cnkgcG9pbnQKLy8gSW5pdGlhbGl6ZXMgc2hhcmVkIHN0YXRlLCBzZXRzIHVwIFJQQyBoYW5kbGVycywgYW5kIHN0YXJ0cyBhdXRvYmFzZQoKaW1wb3J0IFJQQyBmcm9tICdiYXJlLXJwYycKaW1wb3J0IFVSTCBmcm9tICdiYXJlLXVybCcKaW1wb3J0IGI0YSBmcm9tICdiNGEnCmNvbnN0IHsgSVBDIH0gPSBCYXJlS2l0CgovLyBSUEMgY29tbWFuZHMKaW1wb3J0IHsKICAgIFJQQ19VUERBVEUsCiAgICBSUENfQURELAogICAgUlBDX0RFTEVURSwKICAgIFJQQ19HRVRfS0VZLAogICAgUlBDX0pPSU5fS0VZLAogICAgUlBDX1JFUVVFU1RfU1lOQwp9IGZyb20gJy4uL3JwYy1jb21tYW5kcy5tanMnCgovLyBJbXBvcnQgbW9kdWxlcwppbXBvcnQgeyBsb2cgfSBmcm9tICcuL2xpYi91dGlscy5tanMnCmltcG9ydCB7CiAgICBhdXRvYmFzZSwgc3RvcmUsIHN3YXJtLCBjaGF0U3dhcm0sIGRpc2NvdmVyeSwKICAgIHNldFJwYywgc2V0QmFzZUtleQp9IGZyb20gJy4vbGliL3N0YXRlLm1qcycKaW1wb3J0IHsgaW5pdFN0b3JhZ2VQYXRocywgdmFsaWRhdGVTdG9yYWdlSW50ZWdyaXR5IH0gZnJvbSAnLi9saWIvc3RvcmFnZS5tanMnCmltcG9ydCB7IGxvYWRBdXRvYmFzZUtleSwgbG9hZExvY2FsV3JpdGVyS2V5IH0gZnJvbSAnLi9saWIva2V5cy5tanMnCmltcG9ydCB7CiAgICBub3RpZnlVc2VyRXJyb3IsIGlzVHJhbnNpZW50UmVwbGljYXRpb25FcnJvciwgaXNTdGF0ZU1pc21hdGNoRXJyb3IsCiAgICByZXNldENvcnJ1cHRlZFN0YXRlLCBoYW5kbGVUcmFuc2llbnRFcnJvcgp9IGZyb20gJy4vbGliL2Vycm9ycy5tanMnCmltcG9ydCB7IGluaXRBdXRvYmFzZSwgam9pbk5ld0Jhc2UsIHN5bmNMaXN0VG9Gcm9udGVuZCB9IGZyb20gJy4vbGliL2F1dG9iYXNlLm1qcycKaW1wb3J0IHsgYWRkSXRlbSwgdXBkYXRlSXRlbSwgZGVsZXRlSXRlbSB9IGZyb20gJy4vbGliL2l0ZW1zLm1qcycKCmxvZygnPT09IEJBQ0tFTkQgU1RBUlRFRCA9PT0nKQpsb2coJ2JhcmUgYmFja2VuZCBpcyByb2NraW5nLicpCgovLyBQYXJzZSBiYXNlIGRpcmVjdG9yeSBmcm9tIElQQyBVUkwKbGV0IGxvZ0Jhc2VEaXIgPSBudWxsCnRyeSB7CiAgICBjb25zdCBpcGNVcmwgPSB0eXBlb2YgSVBDID09PSAnb2JqZWN0JyAmJiBJUEMudXJsID8gSVBDLnVybCA6IG51bGwKICAgIGlmIChpcGNVcmwpIHsKICAgICAgICBjb25zdCBwYXJzZWQgPSBuZXcgVVJMKGlwY1VybCkKICAgICAgICBsb2dCYXNlRGlyID0gcGFyc2VkLnNlYXJjaFBhcmFtcz8uZ2V0KCdiYXNlRGlyJykgfHwgbnVsbAogICAgfQp9IGNhdGNoIChlKSB7CiAgICBsb2coJ0ZhaWxlZCB0byBwYXJzZSBJUEMgVVJMIGZvciBiYXNlRGlyOicsIGUpCn0KCi8vIEZhbGxiYWNrOiB0cnkgdG8gZ2V0IGZyb20gQmFyZS5hcmd2IGlmIGF2YWlsYWJsZQppZiAoIWxvZ0Jhc2VEaXIgJiYgdHlwZW9mIEJhcmUgIT09ICd1bmRlZmluZWQnICYmIEJhcmUuYXJndiAmJiBCYXJlLmFyZ3YubGVuZ3RoID4gMykgewogICAgbG9nQmFzZURpciA9IEJhcmUuYXJndlszXSB8fCBudWxsCn0KCi8vIEluaXRpYWxpemUgc3RvcmFnZSBwYXRocyB3aXRoIGJhc2UgZGlyZWN0b3J5CmluaXRTdG9yYWdlUGF0aHMobG9nQmFzZURpcikKCi8vIFBhcnNlIGNvbW1hbmQgbGluZSBhcmd1bWVudHMKY29uc3QgcGVlcktleXNTdHJpbmcgPSBCYXJlLmFyZ3ZbMV0gfHwgJycgLy8gQ29tbWEtc2VwYXJhdGVkIHBlZXIga2V5cwpjb25zdCBiYXNlS2V5SGV4ID0gQmFyZS5hcmd2WzJdIHx8ICcnIC8vIE9wdGlvbmFsIEF1dG9iYXNlIGtleSAodG8gam9pbiBhbiBleGlzdGluZyBiYXNlKQoKLy8gUGFyc2UgaW5pdGlhbCBiYXNlIGtleSBmcm9tIGFyZ3Ygb3IgbG9hZCBmcm9tIGZpbGUKbGV0IGluaXRpYWxCYXNlS2V5ID0gbnVsbAppZiAoYmFzZUtleUhleCkgewogICAgdHJ5IHsKICAgICAgICBpbml0aWFsQmFzZUtleSA9IEJ1ZmZlci5mcm9tKGJhc2VLZXlIZXgudHJpbSgpLCAnaGV4JykKICAgICAgICBsb2coJ1VzaW5nIGV4aXN0aW5nIEF1dG9iYXNlIGtleSBmcm9tIGFyZ3ZbMl06JywgYmFzZUtleUhleC50cmltKCkpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBsb2coJ0ludmFsaWQgYmFzZSBrZXkgaGV4LCBjcmVhdGluZyBuZXcgYmFzZSBpbnN0ZWFkOicsIGVyci5tZXNzYWdlKQogICAgICAgIGluaXRpYWxCYXNlS2V5ID0gbnVsbAogICAgfQp9CgovLyBJZiBubyBrZXkgZnJvbSBhcmd2LCB0cnkgbG9hZGluZyBmcm9tIGZpbGUKaWYgKCFpbml0aWFsQmFzZUtleSkgewogICAgaW5pdGlhbEJhc2VLZXkgPSBsb2FkQXV0b2Jhc2VLZXkoKQp9CgpzZXRCYXNlS2V5KGluaXRpYWxCYXNlS2V5KQoKLy8gQ3JlYXRlIFJQQyBzZXJ2ZXIKY29uc3QgcnBjID0gbmV3IFJQQyhJUEMsIGFzeW5jIChyZXEsIGVycm9yKSA9PiB7CiAgICBsb2coJ1JQQyByZXF1ZXN0IGZyb20gZnJvbnRlbmQsIGNvbW1hbmQ6JywgcmVxLmNvbW1hbmQpCiAgICBpZiAoZXJyb3IpIHsKICAgICAgICBsb2coJ2dvdCBhbiBlcnJvciBmcm9tIHJlYWN0JywgZXJyb3IpCiAgICB9CgogICAgLy8gQ3JlYXRlIGJvdW5kIGluaXRBdXRvYmFzZSBmdW5jdGlvbiBmb3IgY2FsbGJhY2tzCiAgICBjb25zdCBpbml0QXV0b2Jhc2VGbiA9IChrZXkpID0+IGluaXRBdXRvYmFzZShrZXksIHBlZXJLZXlzU3RyaW5nKQoKICAgIHRyeSB7CiAgICAgICAgc3dpdGNoIChyZXEuY29tbWFuZCkgewogICAgICAgICAgICBjYXNlIFJQQ19BREQ6IHsKICAgICAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnBhcnNlKGI0YS50b1N0cmluZyhyZXEuZGF0YSkpCiAgICAgICAgICAgICAgICBhd2FpdCBhZGRJdGVtKHRleHQsIG51bGwsIGluaXRBdXRvYmFzZUZuKQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJQQ19VUERBVEU6IHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKHJlcS5kYXRhLnRvU3RyaW5nKCkpCiAgICAgICAgICAgICAgICBhd2FpdCB1cGRhdGVJdGVtKGRhdGEuaXRlbSwgaW5pdEF1dG9iYXNlRm4pCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUlBDX0RFTEVURTogewogICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UocmVxLmRhdGEudG9TdHJpbmcoKSkKICAgICAgICAgICAgICAgIGF3YWl0IGRlbGV0ZUl0ZW0oZGF0YS5pdGVtLCBpbml0QXV0b2Jhc2VGbikKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSUENfR0VUX0tFWTogewogICAgICAgICAgICAgICAgbG9nKCdjb21tYW5kIFJQQ19HRVRfS0VZJykKICAgICAgICAgICAgICAgIGlmICghYXV0b2Jhc2UpIHsKICAgICAgICAgICAgICAgICAgICBsb2coJ1JQQ19HRVRfS0VZIHJlcXVlc3RlZCBiZWZvcmUgQXV0b2Jhc2UgaXMgcmVhZHknKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCBrZXlSZXEgPSBycGMucmVxdWVzdChSUENfR0VUX0tFWSkKICAgICAgICAgICAgICAgIGtleVJlcS5zZW5kKGF1dG9iYXNlLmxvY2FsLmtleS50b1N0cmluZygnaGV4JykpCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUlBDX0pPSU5fS0VZOiB7CiAgICAgICAgICAgICAgICBsb2coJ2NvbW1hbmQgUlBDX0pPSU5fS0VZJykKICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKHJlcS5kYXRhLnRvU3RyaW5nKCkpCiAgICAgICAgICAgICAgICBsb2coJ0pvaW5pbmcgbmV3IGJhc2Uga2V5IGZyb20gUlBDOicsIGRhdGEua2V5KQogICAgICAgICAgICAgICAgYXdhaXQgam9pbk5ld0Jhc2UoZGF0YS5rZXksIHBlZXJLZXlzU3RyaW5nKQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJQQ19SRVFVRVNUX1NZTkM6IHsKICAgICAgICAgICAgICAgIGxvZygnY29tbWFuZCBSUENfUkVRVUVTVF9TWU5DIC0gZnJvbnRlbmQgcmVxdWVzdGluZyBjdXJyZW50IGxpc3QnKQogICAgICAgICAgICAgICAgc3luY0xpc3RUb0Zyb250ZW5kKCkKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBsb2coJ0Vycm9yIGhhbmRsaW5nIFJQQyByZXF1ZXN0OicsIGVycikKICAgIH0KfSkKCi8vIFN0b3JlIFJQQyBpbnN0YW5jZSBpbiBzaGFyZWQgc3RhdGUKc2V0UnBjKHJwYykKCi8vIEdsb2JhbCB1bmhhbmRsZWQgcmVqZWN0aW9uIGhhbmRsZXIgZm9yIGFzeW5jIGVycm9ycwpCYXJlLm9uKCd1bmhhbmRsZWRSZWplY3Rpb24nLCBhc3luYyAoZXJyb3IpID0+IHsKICAgIGxvZygnVW5oYW5kbGVkIHByb21pc2UgcmVqZWN0aW9uOicsIGVycm9yKQoKICAgIGNvbnN0IGluaXRBdXRvYmFzZUZuID0gKGtleSkgPT4gaW5pdEF1dG9iYXNlKGtleSwgcGVlcktleXNTdHJpbmcpCiAgICBjb25zdCByZXNldEZuID0gKG1zZywgaW5pdEZuKSA9PiByZXNldENvcnJ1cHRlZFN0YXRlKG1zZywgaW5pdEZuKQoKICAgIGlmIChpc1RyYW5zaWVudFJlcGxpY2F0aW9uRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgYXdhaXQgaGFuZGxlVHJhbnNpZW50RXJyb3IoZXJyb3IsIGluaXRBdXRvYmFzZUZuLCByZXNldEZuKQogICAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChpc1N0YXRlTWlzbWF0Y2hFcnJvcihlcnJvcikpIHsKICAgICAgICBsb2coJ0RldGVjdGVkIHN0YXRlIG1pc21hdGNoIGVycm9yLCBpbml0aWF0aW5nIHJlc2V0Li4uJykKICAgICAgICBhd2FpdCByZXNldENvcnJ1cHRlZFN0YXRlKGVycm9yLm1lc3NhZ2UgfHwgU3RyaW5nKGVycm9yKSwgaW5pdEF1dG9iYXNlRm4pCiAgICB9Cn0pCgovLyBHbG9iYWwgdW5jYXVnaHQgZXhjZXB0aW9uIGhhbmRsZXIgZm9yIHN5bmMgZXJyb3JzCkJhcmUub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgYXN5bmMgKGVycm9yKSA9PiB7CiAgICBsb2coJ1VuY2F1Z2h0IGV4Y2VwdGlvbjonLCBlcnJvcikKCiAgICBjb25zdCBpbml0QXV0b2Jhc2VGbiA9IChrZXkpID0+IGluaXRBdXRvYmFzZShrZXksIHBlZXJLZXlzU3RyaW5nKQoKICAgIGlmIChpc1RyYW5zaWVudFJlcGxpY2F0aW9uRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgLy8gTGV0IHRoZSByZWplY3Rpb24gaGFuZGxlciBtYW5hZ2UgdGhlIHNvZnQgcmVpbml0IGxvZ2ljCiAgICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKGlzU3RhdGVNaXNtYXRjaEVycm9yKGVycm9yKSkgewogICAgICAgIGxvZygnRGV0ZWN0ZWQgc3RhdGUgbWlzbWF0Y2ggZXJyb3IgZnJvbSBleGNlcHRpb24sIGluaXRpYXRpbmcgcmVzZXQuLi4nKQogICAgICAgIGF3YWl0IHJlc2V0Q29ycnVwdGVkU3RhdGUoZXJyb3IubWVzc2FnZSB8fCBTdHJpbmcoZXJyb3IpLCBpbml0QXV0b2Jhc2VGbikKICAgIH0KfSkKCi8vIFZhbGlkYXRlIHN0b3JhZ2UgaW50ZWdyaXR5IGJlZm9yZSBpbml0aWFsaXppbmcKYXdhaXQgdmFsaWRhdGVTdG9yYWdlSW50ZWdyaXR5KG5vdGlmeVVzZXJFcnJvciwgbG9hZExvY2FsV3JpdGVyS2V5KQoKLy8gSW5pdGlhbGl6ZSBBdXRvYmFzZSB3aXRoIGluaXRpYWwga2V5CmF3YWl0IGluaXRBdXRvYmFzZShpbml0aWFsQmFzZUtleSwgcGVlcktleXNTdHJpbmcpLnRoZW4oKCkgPT4gewogICAgbG9nKCdCYWNrZW5kIHJlYWR5JykKfSkuY2F0Y2goYXN5bmMgKGVycikgPT4gewogICAgbG9nKCdpbml0QXV0b2Jhc2UgZmFpbGVkIGF0IHN0YXJ0dXA6JywgZXJyKQogICAgaWYgKGlzU3RhdGVNaXNtYXRjaEVycm9yKGVycikpIHsKICAgICAgICBsb2coJ0RldGVjdGVkIHN0YXRlIGNvcnJ1cHRpb24gZHVyaW5nIGluaXQsIHJlc2V0dGluZy4uLicpCiAgICAgICAgY29uc3QgaW5pdEF1dG9iYXNlRm4gPSAoa2V5KSA9PiBpbml0QXV0b2Jhc2Uoa2V5LCBwZWVyS2V5c1N0cmluZykKICAgICAgICBhd2FpdCByZXNldENvcnJ1cHRlZFN0YXRlKGVyci5tZXNzYWdlIHx8IFN0cmluZyhlcnIpLCBpbml0QXV0b2Jhc2VGbikKICAgIH0KfSkKCi8vIEJhY2tlbmQgcmVhZHkKbG9nKCdCYWNrZW5kIHJlYWR5JykKCi8vIENsZWFudXAgb24gdGVhcmRvd24KQmFyZS5vbigndGVhcmRvd24nLCBhc3luYyAoKSA9PiB7CiAgICBsb2coJ0JhY2tlbmQgc2h1dHRpbmcgZG93bi4uLicpCiAgICB0cnkgewogICAgICAgIGlmIChzd2FybSkgYXdhaXQgc3dhcm0uZGVzdHJveSgpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgbG9nKCdFcnJvciBkZXN0cm95aW5nIHJlcGxpY2F0aW9uIHN3YXJtOicsIGUpCiAgICB9CiAgICBpZiAoY2hhdFN3YXJtKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgY2hhdFN3YXJtLmRlc3Ryb3koKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgbG9nKCdFcnJvciBkZXN0cm95aW5nIGNoYXQgc3dhcm06JywgZSkKICAgICAgICB9CiAgICB9CiAgICBpZiAoZGlzY292ZXJ5KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgZGlzY292ZXJ5LmRlc3Ryb3koKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgbG9nKCdFcnJvciBkZXN0cm95aW5nIGRpc2NvdmVyeTonLCBlKQogICAgICAgIH0KICAgIH0KICAgIHRyeSB7CiAgICAgICAgaWYgKHN0b3JlKSBhd2FpdCBzdG9yZS5jbG9zZSgpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgbG9nKCdFcnJvciBjbG9zaW5nIHN0b3JlOicsIGUpCiAgICB9CiAgICBsb2coJ0JhY2tlbmQgc2h1dGRvd24gY29tcGxldGUnKQp9KQovLyBBdXRvYmFzZSBpbml0aWFsaXphdGlvbiwgYXBwbHksIG9wZW4sIGFuZCByZWJ1aWxkIGZ1bmN0aW9ucwoKaW1wb3J0IEF1dG9iYXNlIGZyb20gJ2F1dG9iYXNlJwppbXBvcnQgQ29yZXN0b3JlIGZyb20gJ2NvcmVzdG9yZScKaW1wb3J0IEh5cGVyc3dhcm0gZnJvbSAnaHlwZXJzd2FybScKaW1wb3J0IGZzIGZyb20gJ2JhcmUtZnMnCmltcG9ydCB7IHJhbmRvbUJ5dGVzIH0gZnJvbSAnYmFyZS1jcnlwdG8nCmltcG9ydCB7IGxvZywgZ2VuZXJhdGVJZCB9IGZyb20gJy4vdXRpbHMubWpzJwppbXBvcnQgewogICAgYXV0b2Jhc2UsIHN0b3JlLCBycGMsIGJhc2VLZXksIGN1cnJlbnRMaXN0LCBhZGRlZFN0YXRpY1BlZXJzLAogICAgc2V0QXV0b2Jhc2UsIHNldFN0b3JlLCBzZXRTd2FybSwgc2V0RGlzY292ZXJ5LCBzZXRCYXNlS2V5LAogICAgc2V0Q3VycmVudExpc3QsIHNldFBlZXJDb3VudCwgc2V0QWRkZWRTdGF0aWNQZWVycywga25vd25Xcml0ZXJzCn0gZnJvbSAnLi9zdGF0ZS5tanMnCmltcG9ydCB7IHN0b3JhZ2VQYXRoIH0gZnJvbSAnLi9zdG9yYWdlLm1qcycKaW1wb3J0IHsgc2F2ZUF1dG9iYXNlS2V5LCBsb2FkQXV0b2Jhc2VLZXksIHNhdmVMb2NhbFdyaXRlcktleSwgbG9hZExvY2FsV3JpdGVyS2V5IH0gZnJvbSAnLi9rZXlzLm1qcycKaW1wb3J0IHsgaXNUcmFuc2llbnRSZXBsaWNhdGlvbkVycm9yLCBpc1N0YXRlTWlzbWF0Y2hFcnJvciwgcmV0cnlXaXRoQmFja29mZiwgcmVzZXRDb3JydXB0ZWRTdGF0ZSB9IGZyb20gJy4vZXJyb3JzLm1qcycKaW1wb3J0IHsgc2V0dXBDaGF0U3dhcm0sIGJyb2FkY2FzdFBlZXJDb3VudCwgY3JlYXRlUmVwbGljYXRpb25Td2FybSB9IGZyb20gJy4vbmV0d29ya2luZy5tanMnCmltcG9ydCB7IHZhbGlkYXRlSXRlbSB9IGZyb20gJy4vaXRlbXMubWpzJwppbXBvcnQgewogICAgUlBDX0dFVF9LRVksIFNZTkNfTElTVCwKICAgIFJQQ19BRERfRlJPTV9CQUNLRU5ELCBSUENfVVBEQVRFX0ZST01fQkFDS0VORCwgUlBDX0RFTEVURV9GUk9NX0JBQ0tFTkQKfSBmcm9tICcuLi8uLi9ycGMtY29tbWFuZHMubWpzJwoKLy8gRGVmYXVsdCBsaXN0IGl0ZW1zIGZvciBmaXJzdC10aW1lIHVzZXJzCmNvbnN0IERFRkFVTFRfTElTVCA9IFsKICAgIHsgdGV4dDogJ1RhcCB0byBtYXJrIGFzIGRvbmUnLCBpc0RvbmU6IGZhbHNlLCB0aW1lT2ZDb21wbGV0aW9uOiAwIH0sCiAgICB7IHRleHQ6ICdEb3VibGUgdGFwIHRvIGFkZCBuZXcnLCBpc0RvbmU6IGZhbHNlLCB0aW1lT2ZDb21wbGV0aW9uOiAwIH0sCiAgICB7IHRleHQ6ICdTbGlkZSByaWdodCBzbG93bHkgdG8gZGVsZXRlJywgaXNEb25lOiBmYWxzZSwgdGltZU9mQ29tcGxldGlvbjogMCB9LApdCgovLyBTZW5kIGN1cnJlbnQgbGlzdCB0byBmcm9udGVuZApleHBvcnQgZnVuY3Rpb24gc3luY0xpc3RUb0Zyb250ZW5kKCkgewogICAgaWYgKCFycGMpIHJldHVybgogICAgdHJ5IHsKICAgICAgICBjb25zdCByZXEgPSBycGMucmVxdWVzdChTWU5DX0xJU1QpCiAgICAgICAgcmVxLnNlbmQoSlNPTi5zdHJpbmdpZnkoY3VycmVudExpc3QpKQogICAgICAgIGxvZygnU3luY2VkIGxpc3QgdG8gZnJvbnRlbmQ6JywgY3VycmVudExpc3QubGVuZ3RoLCAnaXRlbXMnKQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGxvZygnRmFpbGVkIHRvIHN5bmMgbGlzdCB0byBmcm9udGVuZDonLCBlKQogICAgfQp9CgovLyBTdG9yZSBvcGVuZXIgZnVuY3Rpb24gZm9yIGF1dG9iYXNlCmV4cG9ydCBmdW5jdGlvbiBvcGVuKGNvcmVzdG9yZSkgewogICAgY29uc3QgdmlldyA9IGNvcmVzdG9yZS5nZXQoewogICAgICAgIG5hbWU6ICd0ZXN0JywKICAgICAgICB2YWx1ZUVuY29kaW5nOiAnanNvbicKICAgIH0pCiAgICBsb2coJ29wZW5pbmcgc3RvcmUuLi4nLCB2aWV3KQogICAgcmV0dXJuIHZpZXcKfQoKLy8gQXBwbHkgZnVuY3Rpb24gZm9yIHByb2Nlc3NpbmcgYXV0b2Jhc2Ugbm9kZXMKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGFwcGx5KG5vZGVzLCB2aWV3LCBob3N0LCBpbml0QXV0b2Jhc2VGbikgewogICAgbG9nKGA9PT0gQVBQTFk6IFByb2Nlc3NpbmcgJHtub2Rlcy5sZW5ndGh9IG5vZGVzID09PWApCiAgICBsb2coYCAgVmlldyBsZW5ndGggYmVmb3JlOiAke3ZpZXcubGVuZ3RofWApCiAgICBsb2coYCAgQ3VycmVudCBsaXN0IGl0ZW1zOiAke2N1cnJlbnRMaXN0Lmxlbmd0aH1gKQoKICAgIC8vIEdldCBhIHJlZmVyZW5jZSB0byBjdXJyZW50IHN0b3JlIGZvciB3cml0ZXIgY29yZSBvcGVyYXRpb25zCiAgICBjb25zdCBjdXJyZW50U3RvcmUgPSBzdG9yZQoKICAgIGZvciAoY29uc3QgeyB2YWx1ZSB9IG9mIG5vZGVzKSB7CiAgICAgICAgaWYgKCF2YWx1ZSkgY29udGludWUKCiAgICAgICAgLy8gSGFuZGxlIHdyaXRlciBtZW1iZXJzaGlwIHVwZGF0ZXMgY29taW5nIGZyb20gaGFuZHNoYWtlCiAgICAgICAgaWYgKHZhbHVlLnR5cGUgPT09ICdhZGQtd3JpdGVyJyAmJiB0eXBlb2YgdmFsdWUua2V5ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3Qgd3JpdGVyS2V5ID0gQnVmZmVyLmZyb20odmFsdWUua2V5LCAnaGV4JykKICAgICAgICAgICAgICAgIGF3YWl0IGhvc3QuYWRkV3JpdGVyKHdyaXRlcktleSwgeyBpbmRleGVyOiBmYWxzZSB9KQogICAgICAgICAgICAgICAgbG9nKCdBZGRlZCB3cml0ZXIgZnJvbSBhZGQtd3JpdGVyIG9wOicsIHZhbHVlLmtleSkKCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhlIHdyaXRlcidzIGNvcmUgaXMgb3BlbmVkIGluIHRoZSBzdG9yZQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRTdG9yZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdyaXRlckNvcmUgPSBjdXJyZW50U3RvcmUuZ2V0KHsga2V5OiB3cml0ZXJLZXkgfSkKICAgICAgICAgICAgICAgICAgICBhd2FpdCB3cml0ZXJDb3JlLnJlYWR5KCkKICAgICAgICAgICAgICAgICAgICBsb2coJ1dyaXRlciBjb3JlIG9wZW5lZCwgbGVuZ3RoOicsIHdyaXRlckNvcmUubGVuZ3RoLCAna2V5OicsIHZhbHVlLmtleS5zbGljZSgwLCAxNikgKyAnLi4uJykKCiAgICAgICAgICAgICAgICAgICAgLy8gTGlzdGVuIGZvciBuZXcgZGF0YSBvbiB0aGlzIHdyaXRlcidzIGNvcmUKICAgICAgICAgICAgICAgICAgICB3cml0ZXJDb3JlLm9uKCdhcHBlbmQnLCBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZygnV3JpdGVyIGNvcmUgYXBwZW5kIGV2ZW50LCB0cmlnZ2VyaW5nIHVwZGF0ZS4uLicpCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXV0b2Jhc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCByZXRyeVdpdGhCYWNrb2ZmKGFzeW5jICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgYXV0b2Jhc2UudXBkYXRlKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAnd3JpdGVyQ29yZS5hcHBlbmQudXBkYXRlJywgMywgMTAwLCBpbml0QXV0b2Jhc2VGbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nKCdFcnJvciB1cGRhdGluZyBvbiB3cml0ZXIgYXBwZW5kOicsIGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzVHJhbnNpZW50UmVwbGljYXRpb25FcnJvcihlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgbG9nKCdGYWlsZWQgdG8gYWRkIHdyaXRlciBmcm9tIGFkZC13cml0ZXIgb3A6JywgZXJyKQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIElNUE9SVEFOVDogQXBwZW5kIHRvIHZpZXcgdG8gbWFpbnRhaW4gY2hlY2twb2ludCBzeW5jCiAgICAgICAgICAgIGF3YWl0IHZpZXcuYXBwZW5kKHsgdHlwZTogJ2FkZC13cml0ZXInLCBrZXk6IHZhbHVlLmtleSB9KQogICAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbHVlLnR5cGUgPT09ICdhZGQnKSB7CiAgICAgICAgICAgIGlmICghdmFsaWRhdGVJdGVtKHZhbHVlLnZhbHVlKSkgewogICAgICAgICAgICAgICAgbG9nKCdJbnZhbGlkIGl0ZW0gc2NoZW1hIGluIGFkZCBvcGVyYXRpb246JywgdmFsdWUudmFsdWUpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvZygnQXBwbHlpbmcgYWRkIG9wZXJhdGlvbiBmb3IgaXRlbTonLCB2YWx1ZS52YWx1ZS50ZXh0KQogICAgICAgICAgICAvLyBVcGRhdGUgaW4tbWVtb3J5IGxpc3QKICAgICAgICAgICAgc2V0Q3VycmVudExpc3QoW3ZhbHVlLnZhbHVlLCAuLi5jdXJyZW50TGlzdC5maWx0ZXIoaSA9PiBpLnRleHQgIT09IHZhbHVlLnZhbHVlLnRleHQpXSkKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IGFkZFJlcSA9IHJwYy5yZXF1ZXN0KFJQQ19BRERfRlJPTV9CQUNLRU5EKQogICAgICAgICAgICAgICAgYWRkUmVxLnNlbmQoSlNPTi5zdHJpbmdpZnkodmFsdWUudmFsdWUpKQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBsb2coJ0ZhaWxlZCB0byBzZW5kIGFkZCBub3RpZmljYXRpb24gdG8gZnJvbnRlbmQ6JywgZSkKICAgICAgICAgICAgfQogICAgICAgICAgICBhd2FpdCB2aWV3LmFwcGVuZCh2YWx1ZSkKICAgICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIGlmICh2YWx1ZS50eXBlID09PSAnZGVsZXRlJykgewogICAgICAgICAgICBpZiAoIXZhbGlkYXRlSXRlbSh2YWx1ZS52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGxvZygnSW52YWxpZCBpdGVtIHNjaGVtYSBpbiBkZWxldGUgb3BlcmF0aW9uOicsIHZhbHVlLnZhbHVlKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgfQogICAgICAgICAgICBsb2coJ0FwcGx5aW5nIGRlbGV0ZSBvcGVyYXRpb24gZm9yIGl0ZW06JywgdmFsdWUudmFsdWUudGV4dCkKICAgICAgICAgICAgc2V0Q3VycmVudExpc3QoY3VycmVudExpc3QuZmlsdGVyKGkgPT4gaS50ZXh0ICE9PSB2YWx1ZS52YWx1ZS50ZXh0KSkKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IGRlbGV0ZVJlcSA9IHJwYy5yZXF1ZXN0KFJQQ19ERUxFVEVfRlJPTV9CQUNLRU5EKQogICAgICAgICAgICAgICAgZGVsZXRlUmVxLnNlbmQoSlNPTi5zdHJpbmdpZnkodmFsdWUudmFsdWUpKQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBsb2coJ0ZhaWxlZCB0byBzZW5kIGRlbGV0ZSBub3RpZmljYXRpb24gdG8gZnJvbnRlbmQ6JywgZSkKICAgICAgICAgICAgfQogICAgICAgICAgICBhd2FpdCB2aWV3LmFwcGVuZCh2YWx1ZSkKICAgICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIGlmICh2YWx1ZS50eXBlID09PSAndXBkYXRlJykgewogICAgICAgICAgICBpZiAoIXZhbGlkYXRlSXRlbSh2YWx1ZS52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGxvZygnSW52YWxpZCBpdGVtIHNjaGVtYSBpbiB1cGRhdGUgb3BlcmF0aW9uOicsIHZhbHVlLnZhbHVlKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgfQogICAgICAgICAgICBsb2coJ0FwcGx5aW5nIHVwZGF0ZSBvcGVyYXRpb24gZm9yIGl0ZW06JywgdmFsdWUudmFsdWUudGV4dCkKICAgICAgICAgICAgc2V0Q3VycmVudExpc3QoY3VycmVudExpc3QubWFwKGkgPT4KICAgICAgICAgICAgICAgIGkudGV4dCA9PT0gdmFsdWUudmFsdWUudGV4dCA/IHZhbHVlLnZhbHVlIDogaQogICAgICAgICAgICApKQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgdXBkYXRlUmVxID0gcnBjLnJlcXVlc3QoUlBDX1VQREFURV9GUk9NX0JBQ0tFTkQpCiAgICAgICAgICAgICAgICB1cGRhdGVSZXEuc2VuZChKU09OLnN0cmluZ2lmeSh2YWx1ZS52YWx1ZSkpCiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGxvZygnRmFpbGVkIHRvIHNlbmQgdXBkYXRlIG5vdGlmaWNhdGlvbiB0byBmcm9udGVuZDonLCBlKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGF3YWl0IHZpZXcuYXBwZW5kKHZhbHVlKQogICAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbHVlLnR5cGUgPT09ICdsaXN0JykgewogICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUudmFsdWUpKSB7CiAgICAgICAgICAgICAgICBsb2coJ0ludmFsaWQgbGlzdCBvcGVyYXRpb24gcGF5bG9hZCwgZXhwZWN0ZWQgYXJyYXk6JywgdmFsdWUudmFsdWUpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvZygnQXBwbHlpbmcgbGlzdCBvcGVyYXRpb24gZm9yIGl0ZW1zOicsIHZhbHVlLnZhbHVlLmxlbmd0aCkKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHVwZGF0ZVJlcSA9IHJwYy5yZXF1ZXN0KFNZTkNfTElTVCkKICAgICAgICAgICAgICAgIHVwZGF0ZVJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHZhbHVlLnZhbHVlKSkKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgbG9nKCdGYWlsZWQgdG8gc2VuZCBsaXN0IHN5bmMgdG8gZnJvbnRlbmQ6JywgZSkKICAgICAgICAgICAgfQogICAgICAgICAgICBhd2FpdCB2aWV3LmFwcGVuZCh2YWx1ZSkKICAgICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIC8vIEFsbCBvdGhlciB2YWx1ZXMgYXJlIGFwcGVuZGVkIHRvIHRoZSB2aWV3CiAgICAgICAgbG9nKGAgIEFwcGx5aW5nIHVua25vd24gb3BlcmF0aW9uIHR5cGU6ICR7dmFsdWUudHlwZX1gKQogICAgICAgIGF3YWl0IHZpZXcuYXBwZW5kKHZhbHVlKQogICAgfQogICAgbG9nKGA9PT0gQVBQTFkgQ09NUExFVEU6IFZpZXcgbGVuZ3RoIG5vdzogJHt2aWV3Lmxlbmd0aH0sIExpc3QgaXRlbXM6ICR7Y3VycmVudExpc3QubGVuZ3RofSA9PT1gKQp9CgovLyBWZXJpZnkgc3RhcnR1cCBpbnRlZ3JpdHkgLSBlbnN1cmVzIHRoZSBjb3JyZWN0IGh5cGVyY29yZSBpcyBsb2FkZWQgb24gcmVzdGFydApleHBvcnQgYXN5bmMgZnVuY3Rpb24gdmVyaWZ5U3RhcnR1cEludGVncml0eShzYXZlZExvY2FsV3JpdGVyS2V5LCBzYXZlZEJhc2VLZXkpIHsKICAgIGxvZygnPT09IFNUQVJUVVAgSU5URUdSSVRZIENIRUNLID09PScpCgogICAgaWYgKCFhdXRvYmFzZSkgewogICAgICAgIGxvZygnSU5URUdSSVRZIENIRUNLOiBGQUlMRUQgLSBhdXRvYmFzZSBub3QgaW5pdGlhbGl6ZWQnKQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnN0IGNoZWNrcyA9IFtdCgogICAgLy8gMS4gVmVyaWZ5IGxvY2FsIHdyaXRlciBrZXkgbWF0Y2hlcyBzYXZlZCBrZXkgKGlmIHdlIGhhZCBvbmUpCiAgICBpZiAoc2F2ZWRMb2NhbFdyaXRlcktleSkgewogICAgICAgIGNvbnN0IGxvYWRlZExvY2FsS2V5SGV4ID0gYXV0b2Jhc2UubG9jYWw/LmtleT8udG9TdHJpbmcoJ2hleCcpCiAgICAgICAgY29uc3Qgc2F2ZWRMb2NhbEtleUhleCA9IHNhdmVkTG9jYWxXcml0ZXJLZXkudG9TdHJpbmcoJ2hleCcpCiAgICAgICAgY29uc3QgbG9jYWxLZXlNYXRjaCA9IGxvYWRlZExvY2FsS2V5SGV4ID09PSBzYXZlZExvY2FsS2V5SGV4CgogICAgICAgIGNoZWNrcy5wdXNoKHsKICAgICAgICAgICAgbmFtZTogJ0xvY2FsIHdyaXRlciBrZXkgbWF0Y2gnLAogICAgICAgICAgICBwYXNzZWQ6IGxvY2FsS2V5TWF0Y2gsCiAgICAgICAgICAgIGV4cGVjdGVkOiBzYXZlZExvY2FsS2V5SGV4LnNsaWNlKDAsIDE2KSArICcuLi4nLAogICAgICAgICAgICBhY3R1YWw6IGxvYWRlZExvY2FsS2V5SGV4Py5zbGljZSgwLCAxNikgKyAnLi4uJwogICAgICAgIH0pCiAgICB9CgogICAgLy8gMi4gVmVyaWZ5IGF1dG9iYXNlIGtleSBtYXRjaGVzIHNhdmVkIGtleSAoaWYgd2UgaGFkIG9uZSkKICAgIGlmIChzYXZlZEJhc2VLZXkpIHsKICAgICAgICBjb25zdCBsb2FkZWRCYXNlS2V5SGV4ID0gYXV0b2Jhc2Uua2V5Py50b1N0cmluZygnaGV4JykKICAgICAgICBjb25zdCBzYXZlZEJhc2VLZXlIZXggPSBzYXZlZEJhc2VLZXkudG9TdHJpbmcoJ2hleCcpCiAgICAgICAgY29uc3QgYmFzZUtleU1hdGNoID0gbG9hZGVkQmFzZUtleUhleCA9PT0gc2F2ZWRCYXNlS2V5SGV4CgogICAgICAgIGNoZWNrcy5wdXNoKHsKICAgICAgICAgICAgbmFtZTogJ0F1dG9iYXNlIGtleSBtYXRjaCcsCiAgICAgICAgICAgIHBhc3NlZDogYmFzZUtleU1hdGNoLAogICAgICAgICAgICBleHBlY3RlZDogc2F2ZWRCYXNlS2V5SGV4LnNsaWNlKDAsIDE2KSArICcuLi4nLAogICAgICAgICAgICBhY3R1YWw6IGxvYWRlZEJhc2VLZXlIZXg/LnNsaWNlKDAsIDE2KSArICcuLi4nCiAgICAgICAgfSkKICAgIH0KCiAgICAvLyAzLiBWZXJpZnkgbG9jYWwgaHlwZXJjb3JlIGhhcyBkYXRhIChpZiBpdCdzIGEgcmVzdGFydCkKICAgIGlmIChzYXZlZExvY2FsV3JpdGVyS2V5ICYmIGF1dG9iYXNlLmxvY2FsKSB7CiAgICAgICAgYXdhaXQgYXV0b2Jhc2UubG9jYWwucmVhZHkoKQogICAgICAgIGNvbnN0IGhhc0RhdGEgPSBhdXRvYmFzZS5sb2NhbC5sZW5ndGggPiAwCgogICAgICAgIGNoZWNrcy5wdXNoKHsKICAgICAgICAgICAgbmFtZTogJ0xvY2FsIGh5cGVyY29yZSBoYXMgcGVyc2lzdGVkIGRhdGEnLAogICAgICAgICAgICBwYXNzZWQ6IGhhc0RhdGEsCiAgICAgICAgICAgIGV4cGVjdGVkOiAnPiAwIGVudHJpZXMnLAogICAgICAgICAgICBhY3R1YWw6IGAke2F1dG9iYXNlLmxvY2FsLmxlbmd0aH0gZW50cmllc2AKICAgICAgICB9KQogICAgfQoKICAgIC8vIDQuIFZlcmlmeSBzdG9yYWdlIHBhdGggaXMgYWNjZXNzaWJsZQogICAgdHJ5IHsKICAgICAgICBjb25zdCBzdG9yYWdlRXhpc3RzID0gZnMuZXhpc3RzU3luYyhzdG9yYWdlUGF0aCkKICAgICAgICBjaGVja3MucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICdTdG9yYWdlIHBhdGggZXhpc3RzJywKICAgICAgICAgICAgcGFzc2VkOiBzdG9yYWdlRXhpc3RzLAogICAgICAgICAgICBleHBlY3RlZDogJ3RydWUnLAogICAgICAgICAgICBhY3R1YWw6IFN0cmluZyhzdG9yYWdlRXhpc3RzKQogICAgICAgIH0pCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY2hlY2tzLnB1c2goewogICAgICAgICAgICBuYW1lOiAnU3RvcmFnZSBwYXRoIGV4aXN0cycsCiAgICAgICAgICAgIHBhc3NlZDogZmFsc2UsCiAgICAgICAgICAgIGV4cGVjdGVkOiAndHJ1ZScsCiAgICAgICAgICAgIGFjdHVhbDogYGVycm9yOiAke2UubWVzc2FnZX1gCiAgICAgICAgfSkKICAgIH0KCiAgICAvLyBMb2cgYWxsIGNoZWNrcwogICAgbGV0IGFsbFBhc3NlZCA9IHRydWUKICAgIGZvciAoY29uc3QgY2hlY2sgb2YgY2hlY2tzKSB7CiAgICAgICAgY29uc3Qgc3RhdHVzID0gY2hlY2sucGFzc2VkID8gJ1BBU1MnIDogJ0ZBSUwnCiAgICAgICAgbG9nKGAgIFske3N0YXR1c31dICR7Y2hlY2submFtZX06IGV4cGVjdGVkPSR7Y2hlY2suZXhwZWN0ZWR9LCBhY3R1YWw9JHtjaGVjay5hY3R1YWx9YCkKICAgICAgICBpZiAoIWNoZWNrLnBhc3NlZCkgYWxsUGFzc2VkID0gZmFsc2UKICAgIH0KCiAgICBsb2coYD09PSBJTlRFR1JJVFkgQ0hFQ0sgJHthbGxQYXNzZWQgPyAnUEFTU0VEJyA6ICdGQUlMRUQnfSA9PT1gKQogICAgbG9nKGBTdG9yYWdlIHBhdGg6ICR7c3RvcmFnZVBhdGh9YCkKICAgIGxvZyhgQXV0b2Jhc2Uga2V5OiAke2F1dG9iYXNlLmtleT8udG9TdHJpbmcoJ2hleCcpfWApCiAgICBsb2coYExvY2FsIHdyaXRlciBrZXk6ICR7YXV0b2Jhc2UubG9jYWw/LmtleT8udG9TdHJpbmcoJ2hleCcpfWApCiAgICBsb2coYExvY2FsIHdyaXRlciBsZW5ndGg6ICR7YXV0b2Jhc2UubG9jYWw/Lmxlbmd0aH1gKQogICAgbG9nKGBBdXRvYmFzZSB3cml0YWJsZTogJHthdXRvYmFzZS53cml0YWJsZX1gKQoKICAgIHJldHVybiBhbGxQYXNzZWQKfQoKLy8gUmVidWlsZCBjdXJyZW50TGlzdCBieSByZXBsYXlpbmcgYWxsIHBlcnNpc3RlZCBvcGVyYXRpb25zIGZyb20gdGhlIGxvY2FsIGh5cGVyY29yZQpleHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVidWlsZExpc3RGcm9tUGVyc2lzdGVkT3BzKCkgewogICAgaWYgKCFhdXRvYmFzZSB8fCAhYXV0b2Jhc2UubG9jYWwpIHsKICAgICAgICBsb2coJ3JlYnVpbGRMaXN0RnJvbVBlcnNpc3RlZE9wczogYXV0b2Jhc2Ugb3IgbG9jYWwgY29yZSBub3QgYXZhaWxhYmxlJykKICAgICAgICByZXR1cm4gW10KICAgIH0KCiAgICBjb25zdCByZWJ1aWx0TGlzdCA9IFtdCiAgICBjb25zdCBsZW5ndGggPSBhdXRvYmFzZS5sb2NhbC5sZW5ndGgKCiAgICBsb2coYHJlYnVpbGRMaXN0RnJvbVBlcnNpc3RlZE9wczogcmVhZGluZyAke2xlbmd0aH0gZW50cmllcyBmcm9tIGxvY2FsIGh5cGVyY29yZS4uLmApCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGVudHJ5ID0gYXdhaXQgYXV0b2Jhc2UubG9jYWwuZ2V0KGkpCiAgICAgICAgICAgIGlmICghZW50cnkpIHsKICAgICAgICAgICAgICAgIGxvZyhgICBlbnRyeSAke2l9OiBudWxsL3VuZGVmaW5lZGApCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvYmFzZSBzdG9yZXMgZW50cmllcyBpbiBpbnRlcm5hbCBmb3JtYXQKICAgICAgICAgICAgbGV0IG9wID0gbnVsbAoKICAgICAgICAgICAgaWYgKGVudHJ5Lm5vZGUgJiYgZW50cnkubm9kZS52YWx1ZSkgewogICAgICAgICAgICAgICAgY29uc3QgdmFsdWVPYmogPSBlbnRyeS5ub2RlLnZhbHVlCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ5dGVzID0gT2JqZWN0LnZhbHVlcyh2YWx1ZU9iaikKICAgICAgICAgICAgICAgICAgICBjb25zdCBqc29uU3RyID0gQnVmZmVyLmZyb20oYnl0ZXMpLnRvU3RyaW5nKCd1dGY4JykKICAgICAgICAgICAgICAgICAgICBvcCA9IEpTT04ucGFyc2UoanNvblN0cikKICAgICAgICAgICAgICAgICAgICBsb2coYCAgZW50cnkgJHtpfTogZXh0cmFjdGVkIG9wIHR5cGU9JHtvcC50eXBlfWApCiAgICAgICAgICAgICAgICB9IGNhdGNoIChwYXJzZUVycikgewogICAgICAgICAgICAgICAgICAgIGxvZyhgICBlbnRyeSAke2l9OiBmYWlsZWQgdG8gcGFyc2Ugbm9kZS52YWx1ZTogJHtwYXJzZUVyci5tZXNzYWdlfWApCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChCdWZmZXIuaXNCdWZmZXIoZW50cnkpKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIG9wID0gSlNPTi5wYXJzZShlbnRyeS50b1N0cmluZygpKQogICAgICAgICAgICAgICAgICAgIGxvZyhgICBlbnRyeSAke2l9OiBwYXJzZWQgZnJvbSBidWZmZXIsIHR5cGU9JHtvcC50eXBlfWApCiAgICAgICAgICAgICAgICB9IGNhdGNoIChwYXJzZUVycikgewogICAgICAgICAgICAgICAgICAgIGxvZyhgICBlbnRyeSAke2l9OiBmYWlsZWQgdG8gcGFyc2UgYnVmZmVyOiAke3BhcnNlRXJyLm1lc3NhZ2V9YCkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbnRyeSA9PT0gJ29iamVjdCcgJiYgZW50cnkudHlwZSkgewogICAgICAgICAgICAgICAgb3AgPSBlbnRyeQogICAgICAgICAgICAgICAgbG9nKGAgIGVudHJ5ICR7aX06IGRpcmVjdCBvYmplY3QsIHR5cGU9JHtvcC50eXBlfWApCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsb2coYCAgZW50cnkgJHtpfTogdW5rbm93biBmb3JtYXQsIGtleXM9JHtPYmplY3Qua2V5cyhlbnRyeSkuam9pbignLCcpfWApCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIW9wIHx8ICFvcC50eXBlKSB7CiAgICAgICAgICAgICAgICBsb2coYCAgZW50cnkgJHtpfTogbm8gdmFsaWQgb3AgZXh0cmFjdGVkYCkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNraXAgYWRkLXdyaXRlciBvcGVyYXRpb25zIChub3QgbGlzdCBkYXRhKQogICAgICAgICAgICBpZiAob3AudHlwZSA9PT0gJ2FkZC13cml0ZXInKSB7CiAgICAgICAgICAgICAgICBsb2coYCAgZW50cnkgJHtpfTogc2tpcHBlZCBhZGQtd3JpdGVyIG9wYCkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcC50eXBlID09PSAnYWRkJyAmJiBvcC52YWx1ZSAmJiB2YWxpZGF0ZUl0ZW0ob3AudmFsdWUpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXJlZCA9IHJlYnVpbHRMaXN0LmZpbHRlcihpdGVtID0+IGl0ZW0udGV4dCAhPT0gb3AudmFsdWUudGV4dCkKICAgICAgICAgICAgICAgIGZpbHRlcmVkLnVuc2hpZnQob3AudmFsdWUpCiAgICAgICAgICAgICAgICByZWJ1aWx0TGlzdC5sZW5ndGggPSAwCiAgICAgICAgICAgICAgICByZWJ1aWx0TGlzdC5wdXNoKC4uLmZpbHRlcmVkKQogICAgICAgICAgICAgICAgbG9nKGAgICAgLT4gYWRkZWQgaXRlbTogJHtvcC52YWx1ZS50ZXh0fWApCiAgICAgICAgICAgIH0gZWxzZSBpZiAob3AudHlwZSA9PT0gJ3VwZGF0ZScgJiYgb3AudmFsdWUgJiYgdmFsaWRhdGVJdGVtKG9wLnZhbHVlKSkgewogICAgICAgICAgICAgICAgY29uc3QgaWR4ID0gcmVidWlsdExpc3QuZmluZEluZGV4KGl0ZW0gPT4gaXRlbS50ZXh0ID09PSBvcC52YWx1ZS50ZXh0KQogICAgICAgICAgICAgICAgaWYgKGlkeCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICByZWJ1aWx0TGlzdFtpZHhdID0gb3AudmFsdWUKICAgICAgICAgICAgICAgICAgICBsb2coYCAgICAtPiB1cGRhdGVkIGl0ZW06ICR7b3AudmFsdWUudGV4dH1gKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wLnR5cGUgPT09ICdkZWxldGUnICYmIG9wLnZhbHVlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBpZHggPSByZWJ1aWx0TGlzdC5maW5kSW5kZXgoaXRlbSA9PiBpdGVtLnRleHQgPT09IG9wLnZhbHVlLnRleHQpCiAgICAgICAgICAgICAgICBpZiAoaWR4ICE9PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHJlYnVpbHRMaXN0LnNwbGljZShpZHgsIDEpCiAgICAgICAgICAgICAgICAgICAgbG9nKGAgICAgLT4gZGVsZXRlZCBpdGVtOiAke29wLnZhbHVlLnRleHR9YCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxvZyhgICAgIC0+IHNraXBwZWQgKHR5cGU9JHtvcC50eXBlfSwgaGFzVmFsdWU9JHshIW9wLnZhbHVlfSwgdmFsaWQ9JHtvcC52YWx1ZSA/IHZhbGlkYXRlSXRlbShvcC52YWx1ZSkgOiAnTi9BJ30pYCkKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgbG9nKGByZWJ1aWxkTGlzdEZyb21QZXJzaXN0ZWRPcHM6IGVycm9yIHJlYWRpbmcgZW50cnkgJHtpfTpgLCBlLm1lc3NhZ2UpCiAgICAgICAgfQogICAgfQoKICAgIGxvZyhgcmVidWlsZExpc3RGcm9tUGVyc2lzdGVkT3BzOiByZWJ1aWx0IGxpc3Qgd2l0aCAke3JlYnVpbHRMaXN0Lmxlbmd0aH0gaXRlbXNgKQogICAgcmV0dXJuIHJlYnVpbHRMaXN0Cn0KCi8vIEluaXRpYWxpemUgQXV0b2Jhc2UKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGluaXRBdXRvYmFzZShuZXdCYXNlS2V5LCBwZWVyS2V5c1N0cmluZyA9ICcnKSB7CiAgICAvLyBDcmVhdGUgYSBib3VuZCByZWZlcmVuY2UgdG8gdGhpcyBmdW5jdGlvbiBmb3IgY2FsbGJhY2tzCiAgICBjb25zdCBpbml0QXV0b2Jhc2VGbiA9IChrZXkpID0+IGluaXRBdXRvYmFzZShrZXksIHBlZXJLZXlzU3RyaW5nKQoKICAgIC8vIDEuIENsZWFuIHVwIHByZXZpb3VzIEF1dG9iYXNlIGluc3RhbmNlIChpZiBhbnkpCiAgICBpZiAoYXV0b2Jhc2UpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBhdXRvYmFzZS5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2FwcGVuZCcpCiAgICAgICAgICAgIGlmICh0eXBlb2YgYXV0b2Jhc2UuY2xvc2UgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGxvZygnQ2xvc2luZyBwcmV2aW91cyBBdXRvYmFzZSBpbnN0YW5jZS4uLicpCiAgICAgICAgICAgICAgICBhd2FpdCBhdXRvYmFzZS5jbG9zZSgpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsb2coJ1ByZXZpb3VzIEF1dG9iYXNlIGhhcyBubyBjbG9zZSgpIG1ldGhvZCwgc2tpcHBpbmcgY2xvc2UnKQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBsb2coJ0Vycm9yIHdoaWxlIGNsb3NpbmcgcHJldmlvdXMgQXV0b2Jhc2U6JywgZSkKICAgICAgICB9CiAgICAgICAgc2V0QXV0b2Jhc2UobnVsbCkKICAgIH0KCiAgICAvLyAyLiBUZWFyIGRvd24gbmV0d29ya2luZyBib3VuZCB0byBvbGQgc3RvcmUKICAgIGNvbnN0IHsgZGlzY292ZXJ5LCBjaGF0U3dhcm0gfSA9IGF3YWl0IGltcG9ydCgnLi9zdGF0ZS5tanMnKQogICAgaWYgKGRpc2NvdmVyeSkgewogICAgICAgIHRyeSB7IGF3YWl0IGRpc2NvdmVyeS5kZXN0cm95KCkgfSBjYXRjaCAoZSkgeyBsb2coZSkgfQogICAgICAgIHNldERpc2NvdmVyeShudWxsKQogICAgfQogICAgaWYgKGNoYXRTd2FybSkgewogICAgICAgIHRyeSB7IGF3YWl0IGNoYXRTd2FybS5kZXN0cm95KCkgfSBjYXRjaCAoZSkgeyBsb2coZSkgfQogICAgfQoKICAgIC8vIDMuIENsb3NlIG9sZCBzdG9yZQogICAgaWYgKHN0b3JlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgc3RvcmUuY2xvc2UoKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgbG9nKCdFcnJvciBjbG9zaW5nIENvcmVzdG9yZTonLCBlKQogICAgICAgIH0KICAgIH0KCiAgICAvLyA0LiBDcmVhdGUgZnJlc2ggQ29yZXN0b3JlCiAgICBjb25zdCBuZXdTdG9yZSA9IG5ldyBDb3Jlc3RvcmUoc3RvcmFnZVBhdGgpCiAgICBhd2FpdCBuZXdTdG9yZS5yZWFkeSgpCiAgICBzZXRTdG9yZShuZXdTdG9yZSkKCiAgICAvLyBEZXRlcm1pbmUgaWYgd2UncmUgam9pbmluZyBhIERJRkZFUkVOVCBiYXNlIHRoYW4gYmVmb3JlCiAgICBjb25zdCBzYXZlZEJhc2VLZXkgPSBsb2FkQXV0b2Jhc2VLZXkoKQogICAgY29uc3QgaXNKb2luaW5nRGlmZmVyZW50QmFzZSA9IG5ld0Jhc2VLZXkgJiYgc2F2ZWRCYXNlS2V5ICYmCiAgICAgICAgbmV3QmFzZUtleS50b1N0cmluZygnaGV4JykgIT09IHNhdmVkQmFzZUtleS50b1N0cmluZygnaGV4JykKCiAgICBzZXRCYXNlS2V5KG5ld0Jhc2VLZXkgfHwgbnVsbCkKICAgIGxvZygKICAgICAgICAnaW5pdGlhbGl6aW5nIGEgbmV3IGF1dG9iYXNlIHdpdGgga2V5OicsCiAgICAgICAgbmV3QmFzZUtleSA/IG5ld0Jhc2VLZXkudG9TdHJpbmcoJ2hleCcpIDogJyhuZXcgYmFzZSknLAogICAgICAgICdpc0pvaW5pbmdEaWZmZXJlbnRCYXNlOicsIGlzSm9pbmluZ0RpZmZlcmVudEJhc2UKICAgICkKCiAgICAvLyBUcnkgdG8gbG9hZCBleGlzdGluZyBsb2NhbCB3cml0ZXIgZm9yIHBlcnNpc3RlbmNlCiAgICBsZXQgbG9jYWxJbnB1dCA9IG51bGwKICAgIGNvbnN0IHNhdmVkTG9jYWxXcml0ZXJLZXkgPSBsb2FkTG9jYWxXcml0ZXJLZXkoKQoKICAgIGlmIChpc0pvaW5pbmdEaWZmZXJlbnRCYXNlKSB7CiAgICAgICAgbG9nKCdKb2luaW5nIGRpZmZlcmVudCBiYXNlIC0gY3JlYXRpbmcgZnJlc2ggbG9jYWwgd3JpdGVyIChvbGQgaXRlbXMgd2lsbCBiZSBkaXNjYXJkZWQpJykKICAgICAgICBsb2NhbElucHV0ID0gbnVsbAogICAgfSBlbHNlIGlmIChzYXZlZExvY2FsV3JpdGVyS2V5KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbG9jYWxJbnB1dCA9IG5ld1N0b3JlLmdldCh7IGtleTogc2F2ZWRMb2NhbFdyaXRlcktleSB9KQogICAgICAgICAgICBhd2FpdCBsb2NhbElucHV0LnJlYWR5KCkKICAgICAgICAgICAgbG9nKCdMb2FkZWQgZXhpc3RpbmcgbG9jYWwgd3JpdGVyIGZyb20gY29yZXN0b3JlOicsIHNhdmVkTG9jYWxXcml0ZXJLZXkudG9TdHJpbmcoJ2hleCcpKQogICAgICAgICAgICBsb2coJyAgLT4gTG9jYWwgd3JpdGVyIGNvcmUgbGVuZ3RoOicsIGxvY2FsSW5wdXQubGVuZ3RoKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgbG9nKCdGYWlsZWQgdG8gbG9hZCBsb2NhbCB3cml0ZXIsIHdpbGwgY3JlYXRlIG5ldyBvbmU6JywgZSkKICAgICAgICAgICAgbG9jYWxJbnB1dCA9IG51bGwKICAgICAgICB9CiAgICB9CgogICAgLy8gQ3JlYXRlIEF1dG9iYXNlIHdpdGggbG9jYWxJbnB1dCBpZiB3ZSBoYXZlIG9uZQogICAgY29uc3QgYXV0b2Jhc2VPcHRzID0gewogICAgICAgIGFwcGx5OiAobm9kZXMsIHZpZXcsIGhvc3QpID0+IGFwcGx5KG5vZGVzLCB2aWV3LCBob3N0LCBpbml0QXV0b2Jhc2VGbiksCiAgICAgICAgb3BlbiwKICAgICAgICB2YWx1ZUVuY29kaW5nOiAnanNvbicKICAgIH0KICAgIGlmIChsb2NhbElucHV0KSB7CiAgICAgICAgYXV0b2Jhc2VPcHRzLmxvY2FsSW5wdXQgPSBsb2NhbElucHV0CiAgICB9CiAgICBjb25zdCBuZXdBdXRvYmFzZSA9IG5ldyBBdXRvYmFzZShuZXdTdG9yZSwgbmV3QmFzZUtleSwgYXV0b2Jhc2VPcHRzKQogICAgc2V0QXV0b2Jhc2UobmV3QXV0b2Jhc2UpCgogICAgbG9nKCdDYWxsaW5nIGF1dG9iYXNlLnJlYWR5KCkuLi4nKQogICAgYXdhaXQgbmV3QXV0b2Jhc2UucmVhZHkoKQoKICAgIC8vIERldGVybWluZSByb2xlCiAgICBjb25zdCBpc0hvc3QgPSBuZXdBdXRvYmFzZS53cml0YWJsZQogICAgY29uc3QgYXV0b2Jhc2VLZXlIZXggPSBuZXdBdXRvYmFzZS5rZXk/LnRvU3RyaW5nKCdoZXgnKQogICAgY29uc3QgbG9jYWxXcml0ZXJLZXlIZXggPSBuZXdBdXRvYmFzZS5sb2NhbD8ua2V5Py50b1N0cmluZygnaGV4JykKICAgIGNvbnN0IGlzT3duZXIgPSBhdXRvYmFzZUtleUhleCA9PT0gbG9jYWxXcml0ZXJLZXlIZXgKCiAgICBsb2coJz09PSBBVVRPQkFTRSBJTklUSUFMSVpBVElPTiBDT01QTEVURSA9PT0nKQogICAgbG9nKGAgIFJvbGU6ICR7aXNIb3N0ID8gJ0hPU1QgKHdyaXRhYmxlKScgOiAnR1VFU1QgKHdhaXRpbmcgdG8gYmUgYWRkZWQgYXMgd3JpdGVyKSd9YCkKICAgIGxvZyhgICBBdXRvYmFzZSBrZXk6ICR7YXV0b2Jhc2VLZXlIZXh9YCkKICAgIGxvZyhgICBMb2NhbCB3cml0ZXIga2V5OiAke2xvY2FsV3JpdGVyS2V5SGV4fWApCiAgICBsb2coYCAgSXMgb3duZXIgKGtleXMgbWF0Y2gpOiAke2lzT3duZXJ9YCkKICAgIGxvZyhgICBXcml0YWJsZTogJHtuZXdBdXRvYmFzZS53cml0YWJsZX1gKQoKICAgIGlmICghaXNIb3N0KSB7CiAgICAgICAgbG9nKGAgIE5PVEU6IFRoaXMgZGV2aWNlIGlzIGEgR1VFU1QgLSBpdCB3aWxsIHJlcXVlc3QgdG8gYmUgYWRkZWQgYXMgYSB3cml0ZXIgYnkgdGhlIGhvc3RgKQoKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBib290c3RyYXBDb3JlID0gbmV3U3RvcmUuZ2V0KHsga2V5OiBuZXdBdXRvYmFzZS5rZXkgfSkKICAgICAgICAgICAgYXdhaXQgYm9vdHN0cmFwQ29yZS5yZWFkeSgpCiAgICAgICAgICAgIGxvZyhgICBCb290c3RyYXAgY29yZSBvcGVuZWQsIGxlbmd0aDogJHtib290c3RyYXBDb3JlLmxlbmd0aH1gKQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdBdXRvYmFzZS5hZGRJbnB1dCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgYXdhaXQgbmV3QXV0b2Jhc2UuYWRkSW5wdXQoYm9vdHN0cmFwQ29yZSkKICAgICAgICAgICAgICAgIGxvZyhgICBBZGRlZCBib290c3RyYXAgY29yZSBhcyBpbnB1dCB0byBhdXRvYmFzZWApCiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGxvZyhgICBFcnJvciBzZXR0aW5nIHVwIGJvb3RzdHJhcCBjb3JlIGlucHV0OiAke2UubWVzc2FnZX1gKQogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbG9nKGAgIE5PVEU6IFRoaXMgZGV2aWNlIGlzIHRoZSBIT1NUIC0gaXQgY2FuIGFkZCBvdGhlciB3cml0ZXJzYCkKICAgIH0KCiAgICAvLyBTdGFydHVwIHZlcmlmaWNhdGlvbgogICAgaWYgKCFpc0pvaW5pbmdEaWZmZXJlbnRCYXNlKSB7CiAgICAgICAgYXdhaXQgdmVyaWZ5U3RhcnR1cEludGVncml0eShzYXZlZExvY2FsV3JpdGVyS2V5LCBuZXdCYXNlS2V5KQogICAgfQoKICAgIC8vIFNhdmUga2V5cyBmb3IgcGVyc2lzdGVuY2UKICAgIGlmIChuZXdBdXRvYmFzZS5rZXkpIHsKICAgICAgICBzYXZlQXV0b2Jhc2VLZXkobmV3QXV0b2Jhc2Uua2V5KQogICAgfQogICAgaWYgKG5ld0F1dG9iYXNlLmxvY2FsPy5rZXkpIHsKICAgICAgICBzYXZlTG9jYWxXcml0ZXJLZXkobmV3QXV0b2Jhc2UubG9jYWwua2V5KQogICAgfQoKICAgIGlmIChuZXdBdXRvYmFzZSAmJiBycGMpIHsKICAgICAgICBjb25zdCByZXEgPSBycGMucmVxdWVzdChSUENfR0VUX0tFWSkKICAgICAgICByZXEuc2VuZChuZXdBdXRvYmFzZS5rZXk/LnRvU3RyaW5nKCdoZXgnKSkKICAgIH0KCiAgICAvLyBSZXNldCBpbi1tZW1vcnkgbGlzdCBmb3IgZnJlc2ggYmFzZQogICAgc2V0Q3VycmVudExpc3QoW10pCgogICAgLy8gVXBkYXRlIGF1dG9iYXNlIHRvIHByb2Nlc3MgcGVuZGluZyBvcGVyYXRpb25zCiAgICB0cnkgewogICAgICAgIGF3YWl0IG5ld0F1dG9iYXNlLnVwZGF0ZSgpCiAgICAgICAgbG9nKCdBdXRvYmFzZSB1cGRhdGUoKSBjb21wbGV0ZWQnKQoKICAgICAgICBpZiAoaXNKb2luaW5nRGlmZmVyZW50QmFzZSkgewogICAgICAgICAgICBsb2coJ0pvaW5lZCBkaWZmZXJlbnQgYmFzZSAtIGxpc3Qgd2lsbCBiZSBwb3B1bGF0ZWQgdmlhIHJlcGxpY2F0aW9uJykKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCByZWJ1aWx0TGlzdCA9IGF3YWl0IHJlYnVpbGRMaXN0RnJvbVBlcnNpc3RlZE9wcygpCiAgICAgICAgICAgIHNldEN1cnJlbnRMaXN0KHJlYnVpbHRMaXN0KQogICAgICAgICAgICBsb2coJ1JlYnVpbHQgY3VycmVudExpc3QgZnJvbSBwZXJzaXN0ZWQgb3BzOicsIHJlYnVpbHRMaXN0Lmxlbmd0aCwgJ2l0ZW1zJykKCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgd2l0aCBkZWZhdWx0IGxpc3QgaWYgZW1wdHkKICAgICAgICAgICAgaWYgKHJlYnVpbHRMaXN0Lmxlbmd0aCA9PT0gMCAmJiBuZXdBdXRvYmFzZS5sb2NhbC5sZW5ndGggPT09IDAgJiYgbmV3QXV0b2Jhc2Uud3JpdGFibGUpIHsKICAgICAgICAgICAgICAgIGxvZygnQXV0b2Jhc2UgaXMgZW1wdHkgKGZpcnN0IHJ1biksIGluaXRpYWxpemluZyB3aXRoIGRlZmF1bHQgbGlzdCBpdGVtcy4uLicpCiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgREVGQVVMVF9MSVNUKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3AgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdhZGQnLAogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGdlbmVyYXRlSWQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IGl0ZW0udGV4dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzRG9uZTogaXRlbS5pc0RvbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0SWQ6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lT2ZDb21wbGV0aW9uOiBpdGVtLnRpbWVPZkNvbXBsZXRpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkQXQ6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgbmV3QXV0b2Jhc2UuYXBwZW5kKG9wKQogICAgICAgICAgICAgICAgICAgIGxvZygnQWRkZWQgZGVmYXVsdCBpdGVtOicsIGl0ZW0udGV4dCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IG5ld0xpc3QgPSBhd2FpdCByZWJ1aWxkTGlzdEZyb21QZXJzaXN0ZWRPcHMoKQogICAgICAgICAgICAgICAgc2V0Q3VycmVudExpc3QobmV3TGlzdCkKICAgICAgICAgICAgICAgIGxvZygnRGVmYXVsdCBpdGVtcyBhZGRlZCwgY3VycmVudExpc3Qgbm93IGhhcycsIG5ld0xpc3QubGVuZ3RoLCAnaXRlbXMnKQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzeW5jTGlzdFRvRnJvbnRlbmQoKQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGxvZygnRXJyb3IgdXBkYXRpbmcgYXV0b2Jhc2U6JywgZSkKICAgICAgICBzeW5jTGlzdFRvRnJvbnRlbmQoKQogICAgfQoKICAgIC8vIFJlLWF0dGFjaCB0aGUgYXBwZW5kIGxpc3RlbmVyCiAgICBuZXdBdXRvYmFzZS5vbignYXBwZW5kJywgYXN5bmMgKCkgPT4gewogICAgICAgIGxvZygnPT09IEFVVE9CQVNFIEFQUEVORCBFVkVOVCAobmV3IGRhdGEgZGV0ZWN0ZWQpID09PScpCiAgICAgICAgbG9nKGAgIExvY2FsIGNvcmUgbGVuZ3RoOiAke25ld0F1dG9iYXNlLmxvY2FsPy5sZW5ndGh9YCkKICAgICAgICBsb2coYCAgVmlldyBsZW5ndGg6ICR7bmV3QXV0b2Jhc2Uudmlldz8ubGVuZ3RofWApCiAgICAgICAgbG9nKGAgIFdyaXRhYmxlOiAke25ld0F1dG9iYXNlLndyaXRhYmxlfWApCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbG9nKCcgIENhbGxpbmcgYXV0b2Jhc2UudXBkYXRlKCkgdG8gcHJvY2VzcyBuZXcgZGF0YS4uLicpCiAgICAgICAgICAgIGF3YWl0IHJldHJ5V2l0aEJhY2tvZmYoYXN5bmMgKCkgPT4gewogICAgICAgICAgICAgICAgYXdhaXQgbmV3QXV0b2Jhc2UudXBkYXRlKCkKICAgICAgICAgICAgfSwgJ2F1dG9iYXNlLmFwcGVuZC51cGRhdGUnLCAzLCAxMDAsIGluaXRBdXRvYmFzZUZuKQogICAgICAgICAgICBsb2coYCAgVXBkYXRlIGNvbXBsZXRlLiBWaWV3IGxlbmd0aCBub3c6ICR7bmV3QXV0b2Jhc2Uudmlldz8ubGVuZ3RofWApCiAgICAgICAgICAgIHN5bmNMaXN0VG9Gcm9udGVuZCgpCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBsb2coJ0Vycm9yIHVwZGF0aW5nIG9uIGFwcGVuZDonLCBlKQogICAgICAgICAgICBpZiAoIWlzVHJhbnNpZW50UmVwbGljYXRpb25FcnJvcihlKSkgewogICAgICAgICAgICAgICAgdGhyb3cgZQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSkKCiAgICAvLyBMaXN0ZW4gZm9yIHZpZXcgdXBkYXRlcwogICAgdHJ5IHsKICAgICAgICBuZXdBdXRvYmFzZS52aWV3Lm9uKCdhcHBlbmQnLCAoKSA9PiB7CiAgICAgICAgICAgIGxvZygnVmlldyB1cGRhdGVkLCBzeW5jaW5nIHRvIGZyb250ZW5kLi4uJykKICAgICAgICAgICAgc3luY0xpc3RUb0Zyb250ZW5kKCkKICAgICAgICB9KQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGxvZygnRXJyb3Igc2V0dGluZyB1cCB2aWV3IGxpc3RlbmVyOicsIGUpCiAgICAgICAgaWYgKGlzU3RhdGVNaXNtYXRjaEVycm9yKGUpKSB7CiAgICAgICAgICAgIHJlc2V0Q29ycnVwdGVkU3RhdGUoZS5tZXNzYWdlIHx8IFN0cmluZyhlKSwgaW5pdEF1dG9iYXNlRm4pCiAgICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgIH0KCiAgICAvLyBBZGQgc3RhdGljIHBlZXJzIG9ubHkgb25jZQogICAgaWYgKCFhZGRlZFN0YXRpY1BlZXJzICYmIHBlZXJLZXlzU3RyaW5nKSB7CiAgICAgICAgY29uc3QgcGVlcktleXMgPSBwZWVyS2V5c1N0cmluZy5zcGxpdCgnLCcpLmZpbHRlcihrID0+IGsudHJpbSgpKQogICAgICAgIGZvciAoY29uc3Qga2V5SGV4IG9mIHBlZXJLZXlzKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb25zdCBwZWVyS2V5ID0gQnVmZmVyLmZyb20oa2V5SGV4LnRyaW0oKSwgJ2hleCcpCiAgICAgICAgICAgICAgICBjb25zdCBwZWVyQ29yZSA9IG5ld1N0b3JlLmdldCh7IGtleTogcGVlcktleSB9KQogICAgICAgICAgICAgICAgYXdhaXQgcGVlckNvcmUucmVhZHkoKQogICAgICAgICAgICAgICAgYXdhaXQgbmV3QXV0b2Jhc2UuYWRkSW5wdXQocGVlckNvcmUpCiAgICAgICAgICAgICAgICBsb2coJ0FkZGVkIHBlZXIgd3JpdGVyIGZyb20gYXJndlsxXTonLCBrZXlIZXgudHJpbSgpKQogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgIGxvZygnRmFpbGVkIHRvIGFkZCBwZWVyIGZyb20gYXJndlsxXTonLCBrZXlIZXgsIGVyci5tZXNzYWdlKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHNldEFkZGVkU3RhdGljUGVlcnModHJ1ZSkKICAgIH0KCiAgICAvLyBSZXNldCBwZWVyIGNvdW50IG9uIG5ldyBiYXNlCiAgICBzZXRQZWVyQ291bnQoMCkKICAgIGJyb2FkY2FzdFBlZXJDb3VudCgpCgogICAgLy8gU2V0dXAgcmVwbGljYXRpb24gc3dhcm0KICAgIGNvbnN0IGZpcnN0TG9jYWxBdXRvYmFzZUtleSA9IHJhbmRvbUJ5dGVzKDMyKQogICAgY29uc3QgdG9waWMgPSBuZXdBdXRvYmFzZS5rZXkgfHwgZmlyc3RMb2NhbEF1dG9iYXNlS2V5CiAgICBsb2coJ0Rpc2NvdmVyeSB0b3BpYyAocmVwbGljYXRpb24gc3dhcm0pOicsIHRvcGljLnRvU3RyaW5nKCdoZXgnKSkKCiAgICAvLyBHZXQgY3VycmVudCBkaXNjb3ZlcnkgcmVmIGFuZCBkZXN0cm95IGl0CiAgICBjb25zdCB7IGRpc2NvdmVyeTogY3VycmVudERpc2NvdmVyeSB9ID0gYXdhaXQgaW1wb3J0KCcuL3N0YXRlLm1qcycpCiAgICBpZiAoY3VycmVudERpc2NvdmVyeSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IGN1cnJlbnREaXNjb3ZlcnkuZGVzdHJveSgpCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBsb2coJ0Vycm9yIGRlc3Ryb3lpbmcgcHJldmlvdXMgZGlzY292ZXJ5OicsIGUpCiAgICAgICAgfQogICAgfQoKICAgIGNvbnN0IHJlc2V0Rm4gPSAobXNnLCBpbml0Rm4pID0+IHJlc2V0Q29ycnVwdGVkU3RhdGUobXNnLCBpbml0Rm4pCiAgICBjb25zdCBzd2FybSA9IGNyZWF0ZVJlcGxpY2F0aW9uU3dhcm0ocmVzZXRGbiwgaW5pdEF1dG9iYXNlRm4pCiAgICBzZXRTd2FybShzd2FybSkKCiAgICBjb25zdCBuZXdEaXNjb3ZlcnkgPSBzd2FybS5qb2luKHRvcGljLCB7IHNlcnZlcjogdHJ1ZSwgY2xpZW50OiB0cnVlIH0pCiAgICBhd2FpdCBuZXdEaXNjb3ZlcnkuZmx1c2hlZCgpCiAgICBzZXREaXNjb3ZlcnkobmV3RGlzY292ZXJ5KQogICAgbG9nKCdKb2luZWQgcmVwbGljYXRpb24gc3dhcm0gZm9yIGN1cnJlbnQgYmFzZScpCgogICAgLy8gUmVzdGFydCBjaGF0IHN3YXJtCiAgICBjb25zdCB7IGNoYXRTd2FybTogY3VycmVudENoYXRTd2FybSB9ID0gYXdhaXQgaW1wb3J0KCcuL3N0YXRlLm1qcycpCiAgICBpZiAoY3VycmVudENoYXRTd2FybSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IGN1cnJlbnRDaGF0U3dhcm0uZGVzdHJveSgpCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBsb2coJ0Vycm9yIGRlc3Ryb3lpbmcgcHJldmlvdXMgY2hhdCBzd2FybTonLCBlKQogICAgICAgIH0KICAgIH0KICAgIHNldHVwQ2hhdFN3YXJtKG5ld0Jhc2VLZXkgIT0gbnVsbCA/IG5ld0Jhc2VLZXkgOiBuZXdBdXRvYmFzZS5rZXkpCn0KCi8vIEpvaW4gYSBuZXcgYmFzZSBhdCBydW50aW1lCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBqb2luTmV3QmFzZShiYXNlS2V5SGV4U3RyLCBwZWVyS2V5c1N0cmluZyA9ICcnKSB7CiAgICBpZiAoIWJhc2VLZXlIZXhTdHIgfHwgdHlwZW9mIGJhc2VLZXlIZXhTdHIgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgbG9nKCdqb2luTmV3QmFzZTogaW52YWxpZCBiYXNlS2V5JywgYmFzZUtleUhleFN0cikKICAgICAgICByZXR1cm4KICAgIH0KCiAgICB0cnkgewogICAgICAgIGNvbnN0IG5ld0tleSA9IEJ1ZmZlci5mcm9tKGJhc2VLZXlIZXhTdHIudHJpbSgpLCAnaGV4JykKICAgICAgICBpZiAobmV3S2V5Lmxlbmd0aCAhPT0gMzIpIHsKICAgICAgICAgICAgbG9nKCdqb2luTmV3QmFzZTogYmFzZUtleSBtdXN0IGJlIDMyIGJ5dGVzLCBnb3QnLCBuZXdLZXkubGVuZ3RoKQogICAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgbG9nKCdKb2luaW5nIG5ldyBBdXRvYmFzZSBrZXkgYXQgcnVudGltZTonLCBiYXNlS2V5SGV4U3RyLnRyaW0oKSkKICAgICAgICBhd2FpdCBpbml0QXV0b2Jhc2UobmV3S2V5LCBwZWVyS2V5c1N0cmluZykudGhlbigoKSA9PiB7CiAgICAgICAgICAgIGxvZygnQmFja2VuZCByZWFkeScpCiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4gewogICAgICAgICAgICBsb2coJ2luaXRBdXRvYmFzZSBmYWlsZWQgYXQgc3RhcnR1cDonLCBlcnIpCiAgICAgICAgfSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBsb2coJ2pvaW5OZXdCYXNlIGZhaWxlZDonLCBlKQogICAgfQp9Ci8vIEVycm9yIGRldGVjdGlvbiwgcmV0cnkgbG9naWMsIGFuZCByZXNldCBmdW5jdGlvbmFsaXR5CgppbXBvcnQgeyBsb2csIHNsZWVwIH0gZnJvbSAnLi91dGlscy5tanMnCmltcG9ydCB7CiAgICBhdXRvYmFzZSwgc3RvcmUsIHN3YXJtLCBjaGF0U3dhcm0sIGRpc2NvdmVyeSwgcnBjLCBiYXNlS2V5LAogICAgc2V0QXV0b2Jhc2UsIHNldFN0b3JlLCBzZXRTd2FybSwgc2V0Q2hhdFN3YXJtLCBzZXREaXNjb3ZlcnksCiAgICBzZXRCYXNlS2V5LCBzZXRDdXJyZW50TGlzdCwgc2V0UGVlckNvdW50LCBzZXRBZGRlZFN0YXRpY1BlZXJzLAogICAgaXNSZXNldHRpbmdTdGF0ZSwgc2V0SXNSZXNldHRpbmdTdGF0ZSwgY2xlYXJLbm93bldyaXRlcnMsCiAgICB0cmFuc2llbnRFcnJvckNvdW50LCBzZXRUcmFuc2llbnRFcnJvckNvdW50LAogICAgbGFzdFRyYW5zaWVudEVycm9yVGltZSwgc2V0TGFzdFRyYW5zaWVudEVycm9yVGltZSwKICAgIE1BWF9UUkFOU0lFTlRfRVJST1JTCn0gZnJvbSAnLi9zdGF0ZS5tanMnCmltcG9ydCB7CiAgICBkZWxldGVTdG9yYWdlV2l0aFJldHJ5LCBkZWxldGVTdG9yYWdlU3luYywKICAgIGNyZWF0ZVZlcnNpb25NYXJrZXIsIHdyaXRlUmVzZXRNYXJrZXIsIFZFUlNJT05fTUFSS0VSX0ZJTEUsIGdldEJhc2VEaXIKfSBmcm9tICcuL3N0b3JhZ2UubWpzJwppbXBvcnQgewogICAgUlBDX01FU1NBR0UKfSBmcm9tICcuLi8uLi9ycGMtY29tbWFuZHMubWpzJwoKLy8gU2VuZCBlcnJvciBub3RpZmljYXRpb24gdG8gZnJvbnRlbmQKZXhwb3J0IGZ1bmN0aW9uIG5vdGlmeVVzZXJFcnJvcih0aXRsZSwgbWVzc2FnZSkgewogICAgaWYgKCFycGMpIHJldHVybgogICAgdHJ5IHsKICAgICAgICBjb25zdCByZXEgPSBycGMucmVxdWVzdChSUENfTUVTU0FHRSkKICAgICAgICByZXEuc2VuZChKU09OLnN0cmluZ2lmeSh7IHR5cGU6ICdlcnJvci1ub3RpZmljYXRpb24nLCB0aXRsZSwgbWVzc2FnZSB9KSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBsb2coJ0ZhaWxlZCB0byBzZW5kIGVycm9yIG5vdGlmaWNhdGlvbjonLCBlKQogICAgfQp9CgovLyBDaGVjayBpZiBlcnJvciBpcyBhIHRyYW5zaWVudCByZXBsaWNhdGlvbiBlcnJvciAocmV0cnktYWJsZSkKZXhwb3J0IGZ1bmN0aW9uIGlzVHJhbnNpZW50UmVwbGljYXRpb25FcnJvcihlcnJvcikgewogICAgaWYgKCFlcnJvcikgcmV0dXJuIGZhbHNlCiAgICBjb25zdCBlcnJvclN0ciA9IFN0cmluZyhlcnJvcikKICAgIC8vICJJbnZhbGlkIGNoZWNrb3V0IFggZm9yIGJhdGNoLCBsZW5ndGggaXMgWSIgLSByZXBsaWNhdGlvbiBub3QgY29tcGxldGUgeWV0CiAgICByZXR1cm4gZXJyb3JTdHIuaW5jbHVkZXMoJ0ludmFsaWQgY2hlY2tvdXQnKSAmJiBlcnJvclN0ci5pbmNsdWRlcygnbGVuZ3RoIGlzJykKfQoKLy8gQ2hlY2sgaWYgZXJyb3IgaXMgYSBIeXBlcmNvcmUgc3RhdGUgY29ycnVwdGlvbiBlcnJvciAocmVxdWlyZXMgcmVzZXQpCmV4cG9ydCBmdW5jdGlvbiBpc1N0YXRlTWlzbWF0Y2hFcnJvcihlcnJvcikgewogICAgaWYgKCFlcnJvcikgcmV0dXJuIGZhbHNlCiAgICBjb25zdCBlcnJvclN0ciA9IFN0cmluZyhlcnJvcikKICAgIGNvbnN0IGVycm9yQ29kZSA9IGVycm9yLmNvZGUgfHwgJycKCiAgICAvLyBEb24ndCB0cmVhdCB0cmFuc2llbnQgcmVwbGljYXRpb24gZXJyb3JzIGFzIGNvcnJ1cHRpb24KICAgIGlmIChpc1RyYW5zaWVudFJlcGxpY2F0aW9uRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgcmV0dXJuICgKICAgICAgICBlcnJvclN0ci5pbmNsdWRlcygnQ09SUlVQVElPTicpIHx8CiAgICAgICAgZXJyb3JTdHIuaW5jbHVkZXMoJ3N0YXRlIG1pc21hdGNoJykgfHwKICAgICAgICAoZXJyb3JDb2RlID09PSAnRVJSX0FTU0VSVElPTicgJiYgIWVycm9yU3RyLmluY2x1ZGVzKCdJbnZhbGlkIGNoZWNrb3V0JykpCiAgICApCn0KCi8vIFJlc2V0IGNvcnJ1cHRlZCBzdGF0ZSBhbmQgcmVpbml0aWFsaXplCi8vIGluaXRBdXRvYmFzZUZuIGlzIHBhc3NlZCB0byBhdm9pZCBjaXJjdWxhciBkZXBlbmRlbmN5CmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZXNldENvcnJ1cHRlZFN0YXRlKGVycm9yTWVzc2FnZSwgaW5pdEF1dG9iYXNlRm4pIHsKICAgIGlmIChpc1Jlc2V0dGluZ1N0YXRlKSB7CiAgICAgICAgbG9nKCdBbHJlYWR5IHJlc2V0dGluZyBzdGF0ZSwgc2tpcHBpbmcuLi4nKQogICAgICAgIHJldHVybgogICAgfQogICAgc2V0SXNSZXNldHRpbmdTdGF0ZSh0cnVlKQoKICAgIGxvZygnPT09IFJFU0VUVElORyBDT1JSVVBURUQgU1RBVEUgPT09JykKICAgIGxvZygnRXJyb3IgdGhhdCB0cmlnZ2VyZWQgcmVzZXQ6JywgZXJyb3JNZXNzYWdlKQoKICAgIC8vIE5vdGlmeSB1c2VyCiAgICBub3RpZnlVc2VyRXJyb3IoCiAgICAgICAgJ0RhdGEgUmVzZXQgUmVxdWlyZWQnLAogICAgICAgIGBUaGUgYXBwIGVuY291bnRlcmVkIGEgZGF0YSBpbmNvbnNpc3RlbmN5IGFuZCBuZWVkcyB0byByZXNldC4gWW91ciBsb2NhbCBkYXRhIHdpbGwgYmUgY2xlYXJlZC4gRXJyb3I6ICR7ZXJyb3JNZXNzYWdlfWAKICAgICkKCiAgICB0cnkgewogICAgICAgIC8vIDEuIENsb3NlIGFsbCBzd2FybXMgZmlyc3QgKHN0b3AgbmV0d29yayBhY3Rpdml0eSkKICAgICAgICBsb2coJ1N0ZXAgMTogQ2xvc2luZyBuZXR3b3JrIGNvbm5lY3Rpb25zLi4uJykKICAgICAgICBpZiAoc3dhcm0pIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGF3YWl0IHN3YXJtLmRlc3Ryb3koKQogICAgICAgICAgICAgICAgbG9nKCdSZXBsaWNhdGlvbiBzd2FybSBkZXN0cm95ZWQnKQogICAgICAgICAgICB9IGNhdGNoIChlKSB7IGxvZygnRXJyb3IgZGVzdHJveWluZyBzd2FybTonLCBlKSB9CiAgICAgICAgICAgIHNldFN3YXJtKG51bGwpCiAgICAgICAgfQogICAgICAgIGlmIChjaGF0U3dhcm0pIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGF3YWl0IGNoYXRTd2FybS5kZXN0cm95KCkKICAgICAgICAgICAgICAgIGxvZygnQ2hhdCBzd2FybSBkZXN0cm95ZWQnKQogICAgICAgICAgICB9IGNhdGNoIChlKSB7IGxvZygnRXJyb3IgZGVzdHJveWluZyBjaGF0IHN3YXJtOicsIGUpIH0KICAgICAgICAgICAgc2V0Q2hhdFN3YXJtKG51bGwpCiAgICAgICAgfQogICAgICAgIGlmIChkaXNjb3ZlcnkpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGF3YWl0IGRpc2NvdmVyeS5kZXN0cm95KCkKICAgICAgICAgICAgICAgIGxvZygnRGlzY292ZXJ5IGRlc3Ryb3llZCcpCiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgbG9nKCdFcnJvciBkZXN0cm95aW5nIGRpc2NvdmVyeTonLCBlKSB9CiAgICAgICAgICAgIHNldERpc2NvdmVyeShudWxsKQogICAgICAgIH0KCiAgICAgICAgLy8gU21hbGwgZGVsYXkgdG8gbGV0IG5ldHdvcmsgY2xvc2UgcHJvcGVybHkKICAgICAgICBhd2FpdCBzbGVlcCgxMDApCgogICAgICAgIC8vIDIuIFJlbW92ZSBhbGwgbGlzdGVuZXJzIGFuZCBjbG9zZSBhdXRvYmFzZQogICAgICAgIGxvZygnU3RlcCAyOiBDbG9zaW5nIGF1dG9iYXNlLi4uJykKICAgICAgICBpZiAoYXV0b2Jhc2UpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBsaXN0ZW5lcnMgZmlyc3QKICAgICAgICAgICAgICAgIGF1dG9iYXNlLnJlbW92ZUFsbExpc3RlbmVycygnYXBwZW5kJykKICAgICAgICAgICAgICAgIGlmIChhdXRvYmFzZS52aWV3KSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgYXV0b2Jhc2Uudmlldy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2FwcGVuZCcpCiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgeyAvKiBpZ25vcmUgKi8gfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENsb3NlIGF1dG9iYXNlICh0aGlzIHNob3VsZCBjbG9zZSBpdHMgaW50ZXJuYWwgY29yZXMpCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGF1dG9iYXNlLmNsb3NlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgYXV0b2Jhc2UuY2xvc2UoKQogICAgICAgICAgICAgICAgICAgIGxvZygnQXV0b2Jhc2UgY2xvc2VkJykKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZSkgeyBsb2coJ0Vycm9yIGNsb3NpbmcgYXV0b2Jhc2U6JywgZSkgfQogICAgICAgICAgICBzZXRBdXRvYmFzZShudWxsKQogICAgICAgIH0KCiAgICAgICAgLy8gMy4gQ2xvc2UgY29yZXN0b3JlICh0aGlzIHJlbGVhc2VzIHRoZSBSb2Nrc0RCIGxvY2spCiAgICAgICAgbG9nKCdTdGVwIDM6IENsb3NpbmcgY29yZXN0b3JlLi4uJykKICAgICAgICBpZiAoc3RvcmUpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGF3YWl0IHN0b3JlLmNsb3NlKCkKICAgICAgICAgICAgICAgIGxvZygnQ29yZXN0b3JlIGNsb3NlZCcpCiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgbG9nKCdFcnJvciBjbG9zaW5nIHN0b3JlOicsIGUpIH0KICAgICAgICAgICAgc2V0U3RvcmUobnVsbCkKICAgICAgICB9CgogICAgICAgIC8vIDQuIERlbGV0ZSBzdG9yZWQga2V5cyBhbmQgZGF0YSB3aXRoIHJldHJ5IGxvZ2ljCiAgICAgICAgbG9nKCdTdGVwIDQ6IERlbGV0aW5nIHN0b3JhZ2Ugd2l0aCByZXRyeS4uLicpCiAgICAgICAgY29uc3QgZGVsZXRlZCA9IGF3YWl0IGRlbGV0ZVN0b3JhZ2VXaXRoUmV0cnkoNSwgMzAwKQoKICAgICAgICBpZiAoIWRlbGV0ZWQpIHsKICAgICAgICAgICAgLy8gSWYgZGVsZXRpb24gZmFpbGVkLCBtYXJrIGZvciByZXNldCBvbiBuZXh0IHJlc3RhcnQKICAgICAgICAgICAgbG9nKCdTdG9yYWdlIGRlbGV0aW9uIGZhaWxlZCAtIG1hcmtpbmcgZm9yIHJlc2V0IG9uIG5leHQgcmVzdGFydCcpCiAgICAgICAgICAgIHdyaXRlUmVzZXRNYXJrZXIoZXJyb3JNZXNzYWdlKQoKICAgICAgICAgICAgbm90aWZ5VXNlckVycm9yKAogICAgICAgICAgICAgICAgJ1Jlc2V0IEluY29tcGxldGUnLAogICAgICAgICAgICAgICAgJ0NvdWxkIG5vdCBmdWxseSByZXNldCBhcHAgZGF0YS4gUGxlYXNlIGNsb3NlIGFuZCByZXN0YXJ0IHRoZSBhcHAgdG8gY29tcGxldGUgdGhlIHJlc2V0LicKICAgICAgICAgICAgKQoKICAgICAgICAgICAgc2V0SXNSZXNldHRpbmdTdGF0ZShmYWxzZSkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgfQoKICAgICAgICAvLyA1LiBSZXNldCBpbi1tZW1vcnkgc3RhdGUKICAgICAgICBsb2coJ1N0ZXAgNTogUmVzZXR0aW5nIGluLW1lbW9yeSBzdGF0ZS4uLicpCiAgICAgICAgc2V0QmFzZUtleShudWxsKQogICAgICAgIHNldEN1cnJlbnRMaXN0KFtdKQogICAgICAgIHNldFBlZXJDb3VudCgwKQogICAgICAgIGNsZWFyS25vd25Xcml0ZXJzKCkKICAgICAgICBzZXRBZGRlZFN0YXRpY1BlZXJzKGZhbHNlKQoKICAgICAgICAvLyA2LiBSZWluaXRpYWxpemUgd2l0aCBmcmVzaCBzdGF0ZQogICAgICAgIGxvZygnU3RlcCA2OiBSZWluaXRpYWxpemluZyB3aXRoIGZyZXNoIHN0YXRlLi4uJykKICAgICAgICBpZiAoaW5pdEF1dG9iYXNlRm4pIHsKICAgICAgICAgICAgYXdhaXQgaW5pdEF1dG9iYXNlRm4obnVsbCkKICAgICAgICB9CgogICAgICAgIGxvZygnPT09IFNUQVRFIFJFU0VUIENPTVBMRVRFID09PScpCgogICAgICAgIG5vdGlmeVVzZXJFcnJvcigKICAgICAgICAgICAgJ1Jlc2V0IENvbXBsZXRlJywKICAgICAgICAgICAgJ0FwcCBkYXRhIGhhcyBiZWVuIHJlc2V0IHN1Y2Nlc3NmdWxseS4gWW91IGNhbiBjb250aW51ZSB1c2luZyB0aGUgYXBwLicKICAgICAgICApCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgbG9nKCdFcnJvciBkdXJpbmcgc3RhdGUgcmVzZXQ6JywgZSkKICAgICAgICBub3RpZnlVc2VyRXJyb3IoJ1Jlc2V0IEZhaWxlZCcsIGBGYWlsZWQgdG8gcmVzZXQgYXBwIHN0YXRlOiAke2UubWVzc2FnZX0uIFBsZWFzZSByZXN0YXJ0IHRoZSBhcHAuYCkKICAgIH0gZmluYWxseSB7CiAgICAgICAgc2V0SXNSZXNldHRpbmdTdGF0ZShmYWxzZSkKICAgIH0KfQoKLy8gU29mdCByZWluaXRpYWxpemUgYXV0b2Jhc2UgLSB0cnkgcmVpbml0IGZpcnN0LCBpZiB0aGF0IGZhaWxzIGRvIGZ1bGwgY2xlYW51cAovLyBpbml0QXV0b2Jhc2VGbiBpcyBwYXNzZWQgdG8gYXZvaWQgY2lyY3VsYXIgZGVwZW5kZW5jeQpleHBvcnQgYXN5bmMgZnVuY3Rpb24gc29mdFJlaW5pdEF1dG9iYXNlKGluaXRBdXRvYmFzZUZuKSB7CiAgICBsb2coJz09PSBTT0ZUIFJFSU5JVElBTElaRSBBVVRPQkFTRSA9PT0nKQoKICAgIC8vIFNhdmUgY3VycmVudCBiYXNlS2V5IGJlZm9yZSBjbG9zaW5nCiAgICBjb25zdCBjdXJyZW50QmFzZUtleSA9IGF1dG9iYXNlPy5rZXkgPyBCdWZmZXIuZnJvbShhdXRvYmFzZS5rZXkpIDogYmFzZUtleQoKICAgIGlmICghY3VycmVudEJhc2VLZXkpIHsKICAgICAgICBsb2coJ05vIGJhc2VLZXkgYXZhaWxhYmxlIGZvciBzb2Z0IHJlaW5pdCwgc2tpcHBpbmcnKQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIHRyeSB7CiAgICAgICAgLy8gRmlyc3QgdHJ5OiBqdXN0IHJlaW5pdGlhbGl6ZSB3aXRoIHRoZSBzYW1lIGJhc2VLZXkKICAgICAgICBpZiAoaW5pdEF1dG9iYXNlRm4pIHsKICAgICAgICAgICAgYXdhaXQgaW5pdEF1dG9iYXNlRm4oY3VycmVudEJhc2VLZXkpCiAgICAgICAgfQogICAgICAgIGxvZygnU29mdCByZWluaXRpYWxpemUgY29tcGxldGVkIHN1Y2Nlc3NmdWxseScpCiAgICAgICAgcmV0dXJuIHRydWUKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBsb2coJ1NvZnQgcmVpbml0aWFsaXplIGZhaWxlZDonLCBlKQoKICAgICAgICAvLyBJZiByZWluaXQgZmFpbGVkLCB0aGUgc3RvcmFnZSBpcyBsaWtlbHkgY29ycnVwdGVkCiAgICAgICAgLy8gRG8gYSBmdWxsIGNsZWFudXAgYW5kIHN0YXJ0IGZyZXNoCiAgICAgICAgaWYgKGlzVHJhbnNpZW50UmVwbGljYXRpb25FcnJvcihlKSB8fCBTdHJpbmcoZSkuaW5jbHVkZXMoJ0ludmFsaWQgY2hlY2tvdXQnKSkgewogICAgICAgICAgICBsb2coJ0RldGVjdGVkIGNoZWNrcG9pbnQgY29ycnVwdGlvbiwgZG9pbmcgZnVsbCBzdG9yYWdlIGNsZWFudXAuLi4nKQoKICAgICAgICAgICAgLy8gQ2xvc2UgZXZlcnl0aGluZwogICAgICAgICAgICBpZiAoYXV0b2Jhc2UpIHsKICAgICAgICAgICAgICAgIHRyeSB7IGF1dG9iYXNlLnJlbW92ZUFsbExpc3RlbmVycygnYXBwZW5kJykgfSBjYXRjaCAoX2UpIHt9CiAgICAgICAgICAgICAgICB0cnkgeyBpZiAoYXV0b2Jhc2UuY2xvc2UpIGF3YWl0IGF1dG9iYXNlLmNsb3NlKCkgfSBjYXRjaCAoX2UpIHt9CiAgICAgICAgICAgICAgICBzZXRBdXRvYmFzZShudWxsKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdG9yZSkgewogICAgICAgICAgICAgICAgdHJ5IHsgYXdhaXQgc3RvcmUuY2xvc2UoKSB9IGNhdGNoIChfZSkge30KICAgICAgICAgICAgICAgIHNldFN0b3JlKG51bGwpCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERlbGV0ZSBjb3JydXB0ZWQgc3RvcmFnZQogICAgICAgICAgICBhd2FpdCBzbGVlcCgyMDApCiAgICAgICAgICAgIGRlbGV0ZVN0b3JhZ2VTeW5jKCkKCiAgICAgICAgICAgIC8vIFJlY3JlYXRlIHZlcnNpb24gbWFya2VyCiAgICAgICAgICAgIGNyZWF0ZVZlcnNpb25NYXJrZXIoKQoKICAgICAgICAgICAgLy8gUmVpbml0aWFsaXplIGZyZXNoICh3aWxsIGNyZWF0ZSBuZXcgYXV0b2Jhc2Ugd2l0aG91dCB0aGUgb2xkIGJhc2VLZXkpCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpZiAoaW5pdEF1dG9iYXNlRm4pIHsKICAgICAgICAgICAgICAgICAgICBhd2FpdCBpbml0QXV0b2Jhc2VGbihudWxsKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbG9nKCdGdWxsIGNsZWFudXAgYW5kIHJlaW5pdCBjb21wbGV0ZWQnKQoKICAgICAgICAgICAgICAgIC8vIE5vdGlmeSB1c2VyCiAgICAgICAgICAgICAgICBub3RpZnlVc2VyRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgJ0RhdGEgUmVzZXQnLAogICAgICAgICAgICAgICAgICAgICdUaGUgYXBwIGhhZCB0byByZXNldCBkdWUgdG8gZGF0YSBjb3JydXB0aW9uLiBZb3VyIGRhdGEgd2lsbCBzeW5jIGZyb20gY29ubmVjdGVkIHBlZXJzLicKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgICAgIH0gY2F0Y2ggKGUyKSB7CiAgICAgICAgICAgICAgICBsb2coJ0Z1bGwgY2xlYW51cCByZWluaXQgYWxzbyBmYWlsZWQ6JywgZTIpCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9Cn0KCi8vIFJldHJ5IGFuIGFzeW5jIG9wZXJhdGlvbiB3aXRoIGV4cG9uZW50aWFsIGJhY2tvZmYKLy8gSWYgdmlldyBpcyBicm9rZW4gKGNoZWNrb3V0IGVycm9yIHBlcnNpc3RzKSwgdHJpZXMgc29mdCByZWluaXQKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJldHJ5V2l0aEJhY2tvZmYob3BlcmF0aW9uLCBvcGVyYXRpb25OYW1lLCBtYXhSZXRyaWVzID0gMywgaW5pdGlhbERlbGF5TXMgPSAxMDAsIGluaXRBdXRvYmFzZUZuID0gbnVsbCkgewogICAgbGV0IGxhc3RFcnJvciA9IG51bGwKICAgIGxldCBzb2Z0UmVpbml0QXR0ZW1wdGVkID0gZmFsc2UKCiAgICBmb3IgKGxldCBhdHRlbXB0ID0gMTsgYXR0ZW1wdCA8PSBtYXhSZXRyaWVzOyBhdHRlbXB0KyspIHsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gYXdhaXQgb3BlcmF0aW9uKCkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGxhc3RFcnJvciA9IGUKCiAgICAgICAgICAgIGlmIChpc1RyYW5zaWVudFJlcGxpY2F0aW9uRXJyb3IoZSkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRlbGF5TXMgPSBpbml0aWFsRGVsYXlNcyAqIE1hdGgucG93KDIsIGF0dGVtcHQgLSAxKQogICAgICAgICAgICAgICAgbG9nKGAke29wZXJhdGlvbk5hbWV9OiB2aWV3IGVycm9yIG9uIGF0dGVtcHQgJHthdHRlbXB0fS8ke21heFJldHJpZXN9LCB3YWl0aW5nICR7ZGVsYXlNc31tcy4uLmApCiAgICAgICAgICAgICAgICBsb2coYCAgRXJyb3I6ICR7ZS5tZXNzYWdlIHx8IGV9YCkKICAgICAgICAgICAgICAgIGF3YWl0IHNsZWVwKGRlbGF5TXMpCgogICAgICAgICAgICAgICAgLy8gQWZ0ZXIgMiBmYWlsZWQgYXR0ZW1wdHMsIHRyeSBzb2Z0IHJlaW5pdCB0byByZWNyZWF0ZSB0aGUgdmlldwogICAgICAgICAgICAgICAgaWYgKGF0dGVtcHQgPj0gMiAmJiAhc29mdFJlaW5pdEF0dGVtcHRlZCAmJiBpbml0QXV0b2Jhc2VGbikgewogICAgICAgICAgICAgICAgICAgIGxvZyhgJHtvcGVyYXRpb25OYW1lfTogYXR0ZW1wdGluZyBzb2Z0IHJlaW5pdGlhbGl6ZSB0byBmaXggYnJva2VuIHZpZXcuLi5gKQogICAgICAgICAgICAgICAgICAgIHNvZnRSZWluaXRBdHRlbXB0ZWQgPSB0cnVlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVpbml0U3VjY2VzcyA9IGF3YWl0IHNvZnRSZWluaXRBdXRvYmFzZShpbml0QXV0b2Jhc2VGbikKICAgICAgICAgICAgICAgICAgICBpZiAocmVpbml0U3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgICAgICBsb2coYCR7b3BlcmF0aW9uTmFtZX06IHNvZnQgcmVpbml0IHN1Y2NlZWRlZCwgcmV0cnlpbmcgb3BlcmF0aW9uLi4uYCkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR2l2ZSBpdCBhIG1vbWVudCB0byBzdGFiaWxpemUKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgc2xlZXAoNTAwKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE5vbi10cmFuc2llbnQgZXJyb3IsIGRvbid0IHJldHJ5CiAgICAgICAgICAgICAgICB0aHJvdyBlCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gQWxsIHJldHJpZXMgZmFpbGVkIC0gaWYgd2UgaGF2ZW4ndCB0cmllZCBzb2Z0IHJlaW5pdCB5ZXQsIHRyeSBpdCBhcyBsYXN0IHJlc29ydAogICAgaWYgKCFzb2Z0UmVpbml0QXR0ZW1wdGVkICYmIGluaXRBdXRvYmFzZUZuKSB7CiAgICAgICAgbG9nKGAke29wZXJhdGlvbk5hbWV9OiBmaW5hbCBhdHRlbXB0IC0gdHJ5aW5nIHNvZnQgcmVpbml0aWFsaXplLi4uYCkKICAgICAgICBjb25zdCByZWluaXRTdWNjZXNzID0gYXdhaXQgc29mdFJlaW5pdEF1dG9iYXNlKGluaXRBdXRvYmFzZUZuKQogICAgICAgIGlmIChyZWluaXRTdWNjZXNzKSB7CiAgICAgICAgICAgIGF3YWl0IHNsZWVwKDUwMCkKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBvcGVyYXRpb24oKQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBsb2coYCR7b3BlcmF0aW9uTmFtZX06IG9wZXJhdGlvbiBzdGlsbCBmYWlsZWQgYWZ0ZXIgc29mdCByZWluaXQ6YCwgZS5tZXNzYWdlKQogICAgICAgICAgICAgICAgbGFzdEVycm9yID0gZQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGxvZyhgJHtvcGVyYXRpb25OYW1lfTogRkFJTEVEIGFmdGVyICR7bWF4UmV0cmllc30gcmV0cmllcyBhbmQgc29mdCByZWluaXRgKQogICAgdGhyb3cgbGFzdEVycm9yCn0KCi8vIEhhbmRsZSB0cmFuc2llbnQgZXJyb3JzIGZvciBnbG9iYWwgZXJyb3IgaGFuZGxlcnMKLy8gUmV0dXJucyB0cnVlIGlmIGVycm9yIHdhcyBoYW5kbGVkLCBmYWxzZSBpZiBpdCBuZWVkcyBmdXJ0aGVyIGFjdGlvbgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlVHJhbnNpZW50RXJyb3IoZXJyb3IsIGluaXRBdXRvYmFzZUZuLCByZXNldENvcnJ1cHRlZFN0YXRlRm4pIHsKICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCkKICAgIGlmIChub3cgLSBsYXN0VHJhbnNpZW50RXJyb3JUaW1lID4gMzAwMDApIHsKICAgICAgICBzZXRUcmFuc2llbnRFcnJvckNvdW50KDApCiAgICB9CiAgICBzZXRUcmFuc2llbnRFcnJvckNvdW50KHRyYW5zaWVudEVycm9yQ291bnQgKyAxKQogICAgc2V0TGFzdFRyYW5zaWVudEVycm9yVGltZShub3cpCgogICAgbG9nKGBWaWV3L3JlcGxpY2F0aW9uIGVycm9yIChjb3VudDogJHt0cmFuc2llbnRFcnJvckNvdW50fS8ke01BWF9UUkFOU0lFTlRfRVJST1JTfSlgKQoKICAgIC8vIEFmdGVyIDUgZXJyb3JzLCB0cnkgc29mdCByZWluaXQ7IGFmdGVyIDEwLCBkbyBmdWxsIHJlc2V0CiAgICBpZiAodHJhbnNpZW50RXJyb3JDb3VudCA9PT0gNSkgewogICAgICAgIGxvZygnTXVsdGlwbGUgdmlldyBlcnJvcnMsIGF0dGVtcHRpbmcgc29mdCByZWluaXRpYWxpemUuLi4nKQogICAgICAgIGF3YWl0IHNvZnRSZWluaXRBdXRvYmFzZShpbml0QXV0b2Jhc2VGbikKICAgIH0gZWxzZSBpZiAodHJhbnNpZW50RXJyb3JDb3VudCA+PSBNQVhfVFJBTlNJRU5UX0VSUk9SUykgewogICAgICAgIGxvZygnVG9vIG1hbnkgZXJyb3JzIGV2ZW4gYWZ0ZXIgc29mdCByZWluaXQsIGluaXRpYXRpbmcgZnVsbCByZXNldC4uLicpCiAgICAgICAgc2V0VHJhbnNpZW50RXJyb3JDb3VudCgwKQogICAgICAgIGF3YWl0IHJlc2V0Q29ycnVwdGVkU3RhdGVGbihlcnJvci5tZXNzYWdlIHx8IFN0cmluZyhlcnJvciksIGluaXRBdXRvYmFzZUZuKQogICAgfQogICAgcmV0dXJuIHRydWUKfQovLyBJdGVtIG9wZXJhdGlvbnMgLSBhZGRJdGVtLCB1cGRhdGVJdGVtLCBkZWxldGVJdGVtLCB2YWxpZGF0ZUl0ZW0KCmltcG9ydCB7IGxvZywgZ2VuZXJhdGVJZCB9IGZyb20gJy4vdXRpbHMubWpzJwppbXBvcnQgeyBhdXRvYmFzZSwgc3RvcmUsIHJwYyB9IGZyb20gJy4vc3RhdGUubWpzJwppbXBvcnQgeyByZXRyeVdpdGhCYWNrb2ZmIH0gZnJvbSAnLi9lcnJvcnMubWpzJwppbXBvcnQgewogICAgUlBDX01FU1NBR0UKfSBmcm9tICcuLi8uLi9ycGMtY29tbWFuZHMubWpzJwoKLy8gU2ltcGxlIGlubGluZSBzY2hlbWEgdmFsaWRhdGlvbiBtYXRjaGluZyB0aGUgbW9iaWxlIExpc3RFbnRyeQpleHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVJdGVtKGl0ZW0pIHsKICAgIGlmICh0eXBlb2YgaXRlbSAhPT0gJ29iamVjdCcgfHwgaXRlbSA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCiAgICBpZiAodHlwZW9mIGl0ZW0udGV4dCAhPT0gJ3N0cmluZycpIHJldHVybiBmYWxzZQogICAgaWYgKHR5cGVvZiBpdGVtLmlzRG9uZSAhPT0gJ2Jvb2xlYW4nKSByZXR1cm4gZmFsc2UKICAgIGlmICh0eXBlb2YgaXRlbS50aW1lT2ZDb21wbGV0aW9uICE9PSAnbnVtYmVyJykgcmV0dXJuIGZhbHNlCiAgICByZXR1cm4gdHJ1ZQp9CgovLyBDaGVjayBpZiBhdXRvYmFzZSBpcyBpbiBhIHZhbGlkIHN0YXRlIGZvciBvcGVyYXRpb25zCmV4cG9ydCBmdW5jdGlvbiBpc0F1dG9iYXNlUmVhZHkoKSB7CiAgICBpZiAoIWF1dG9iYXNlKSB7CiAgICAgICAgbG9nKCdpc0F1dG9iYXNlUmVhZHk6IGF1dG9iYXNlIGlzIG51bGwnKQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQogICAgaWYgKCFhdXRvYmFzZS5sb2NhbCkgewogICAgICAgIGxvZygnaXNBdXRvYmFzZVJlYWR5OiBhdXRvYmFzZS5sb2NhbCBpcyBudWxsJykKICAgICAgICByZXR1cm4gZmFsc2UKICAgIH0KICAgIGlmIChhdXRvYmFzZS5jbG9zaW5nIHx8IGF1dG9iYXNlLmNsb3NlZCkgewogICAgICAgIGxvZygnaXNBdXRvYmFzZVJlYWR5OiBhdXRvYmFzZSBpcyBjbG9zaW5nL2Nsb3NlZCcpCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgICByZXR1cm4gdHJ1ZQp9CgovLyBQZXJzaXN0IGFuZCB2ZXJpZnkgdGhhdCBhbiBvcGVyYXRpb24gd2FzIHdyaXR0ZW4gdG8gZGlzawpleHBvcnQgYXN5bmMgZnVuY3Rpb24gcGVyc2lzdEFuZFZlcmlmeShleHBlY3RlZExlbmd0aCwgb3BlcmF0aW9uVHlwZSkgewogICAgaWYgKCFhdXRvYmFzZSB8fCAhYXV0b2Jhc2UubG9jYWwgfHwgIXN0b3JlKSB7CiAgICAgICAgbG9nKGBwZXJzaXN0QW5kVmVyaWZ5ICgke29wZXJhdGlvblR5cGV9KTogYXV0b2Jhc2UsIGxvY2FsIGNvcmUsIG9yIHN0b3JlIG5vdCBhdmFpbGFibGVgKQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIHRyeSB7CiAgICAgICAgLy8gRm9yY2Ugd3JpdGUgdG8gZGlzayB2aWEgQ29yZXN0b3JlIC0gdGhpcyBmbHVzaGVzIGFsbCBjb3JlcyB0byBzdG9yYWdlCiAgICAgICAgaWYgKHR5cGVvZiBzdG9yZS5mbHVzaCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBhd2FpdCBzdG9yZS5mbHVzaCgpCiAgICAgICAgfQoKICAgICAgICBjb25zdCBhY3R1YWxMZW5ndGggPSBhdXRvYmFzZS5sb2NhbC5sZW5ndGgKICAgICAgICBjb25zdCBrZXlIZXggPSBhdXRvYmFzZS5sb2NhbC5rZXkudG9TdHJpbmcoJ2hleCcpLnNsaWNlKDAsIDE2KQoKICAgICAgICBpZiAoYWN0dWFsTGVuZ3RoID49IGV4cGVjdGVkTGVuZ3RoKSB7CiAgICAgICAgICAgIGxvZyhgcGVyc2lzdEFuZFZlcmlmeSAoJHtvcGVyYXRpb25UeXBlfSk6IFNVQ0NFU1MgLSBmbHVzaGVkIHRvIGRpc2ssIGNvcmUgJHtrZXlIZXh9Li4uIGxlbmd0aD0ke2FjdHVhbExlbmd0aH1gKQogICAgICAgICAgICByZXR1cm4gdHJ1ZQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxvZyhgcGVyc2lzdEFuZFZlcmlmeSAoJHtvcGVyYXRpb25UeXBlfSk6IExFTkdUSCBNSVNNQVRDSCAtIGNvcmUgJHtrZXlIZXh9Li4uIGxlbmd0aD0ke2FjdHVhbExlbmd0aH0sIGV4cGVjdGVkID49ICR7ZXhwZWN0ZWRMZW5ndGh9YCkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGxvZyhgcGVyc2lzdEFuZFZlcmlmeSAoJHtvcGVyYXRpb25UeXBlfSk6IEZMVVNIIEZBSUxFRCAtYCwgZS5tZXNzYWdlKQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQp9CgovLyBBZGQgaXRlbSBvcGVyYXRpb24gKGJhY2tlbmQgY3JlYXRlcyB0aGUgY2Fub25pY2FsIGl0ZW0pCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhZGRJdGVtKHRleHQsIGxpc3RJZCwgaW5pdEF1dG9iYXNlRm4pIHsKICAgIGlmICghaXNBdXRvYmFzZVJlYWR5KCkpIHsKICAgICAgICBsb2coJ2FkZEl0ZW0gY2FsbGVkIGJ1dCBhdXRvYmFzZSBpcyBub3QgcmVhZHknKQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmICghYXV0b2Jhc2Uud3JpdGFibGUpIHsKICAgICAgICBsb2coJ2FkZEl0ZW0gY2FsbGVkIGJ1dCBhdXRvYmFzZSBpcyBub3Qgd3JpdGFibGUgeWV0IC0gd2FpdGluZyB0byBiZSBhZGRlZCBhcyB3cml0ZXInKQogICAgICAgIC8vIE5vdGlmeSBmcm9udGVuZCBhYm91dCBub3QgYmVpbmcgd3JpdGFibGUKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCByZXEgPSBycGMucmVxdWVzdChSUENfTUVTU0FHRSkKICAgICAgICAgICAgcmVxLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyB0eXBlOiAnbm90LXdyaXRhYmxlJywgbWVzc2FnZTogJ1dhaXRpbmcgdG8gYmUgYWRkZWQgYXMgYSB3cml0ZXIgYnkgdGhlIGhvc3QuLi4nIH0pKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgbG9nKCdGYWlsZWQgdG8gc2VuZCBub3Qtd3JpdGFibGUgbWVzc2FnZTonLCBlKQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBsb2coJ2NvbW1hbmQgUlBDX0FERCBhZGRJdGVtIHRleHQnLCB0ZXh0KQoKICAgIGNvbnN0IGl0ZW0gPSB7CiAgICAgICAgaWQ6IGdlbmVyYXRlSWQoKSwKICAgICAgICB0ZXh0LAogICAgICAgIGlzRG9uZTogZmFsc2UsCiAgICAgICAgbGlzdElkOiBsaXN0SWQgfHwgbnVsbCwKICAgICAgICB0aW1lT2ZDb21wbGV0aW9uOiAwLAogICAgICAgIHVwZGF0ZWRBdDogRGF0ZS5ub3coKSwKICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICB9CgogICAgY29uc3Qgb3AgPSB7CiAgICAgICAgdHlwZTogJ2FkZCcsCiAgICAgICAgdmFsdWU6IGl0ZW0KICAgIH0KCiAgICB0cnkgewogICAgICAgIC8vIEVuc3VyZSBhdXRvYmFzZSBpcyBmdWxseSByZWFkeSBiZWZvcmUgYXBwZW5kCiAgICAgICAgYXdhaXQgYXV0b2Jhc2UucmVhZHkoKQoKICAgICAgICAvLyBEb3VibGUtY2hlY2sgc3RhdGUgYWZ0ZXIgcmVhZHkoKQogICAgICAgIGlmICghaXNBdXRvYmFzZVJlYWR5KCkgfHwgIWF1dG9iYXNlLndyaXRhYmxlKSB7CiAgICAgICAgICAgIGxvZygnYWRkSXRlbTogYXV0b2Jhc2Ugc3RhdGUgY2hhbmdlZCBkdXJpbmcgcmVhZHkoKSwgYWJvcnRpbmcnKQogICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CgogICAgICAgIC8vIEdldCBsZW5ndGggYmVmb3JlIGFwcGVuZCB0byB2ZXJpZnkgaXQgaW5jcmVhc2VzCiAgICAgICAgY29uc3QgbGVuZ3RoQmVmb3JlID0gYXV0b2Jhc2UubG9jYWwubGVuZ3RoCgogICAgICAgIC8vIFVzZSByZXRyeSBsb2dpYyBpbiBjYXNlIG9mIHRyYW5zaWVudCByZXBsaWNhdGlvbiBlcnJvcnMKICAgICAgICBhd2FpdCByZXRyeVdpdGhCYWNrb2ZmKGFzeW5jICgpID0+IHsKICAgICAgICAgICAgaWYgKCFpc0F1dG9iYXNlUmVhZHkoKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdXRvYmFzZSBiZWNhbWUgdW5hdmFpbGFibGUgZHVyaW5nIHJldHJ5JykKICAgICAgICAgICAgfQogICAgICAgICAgICBhd2FpdCBhdXRvYmFzZS5hcHBlbmQob3ApCiAgICAgICAgfSwgJ2FkZEl0ZW0uYXBwZW5kJywgMywgMTAwLCBpbml0QXV0b2Jhc2VGbikKCiAgICAgICAgLy8gRmx1c2ggdG8gZGlzayBhbmQgdmVyaWZ5IHBlcnNpc3RlbmNlCiAgICAgICAgY29uc3QgcGVyc2lzdGVkID0gYXdhaXQgcGVyc2lzdEFuZFZlcmlmeShsZW5ndGhCZWZvcmUgKyAxLCAnQUREJykKICAgICAgICBpZiAoIXBlcnNpc3RlZCkgewogICAgICAgICAgICBsb2coJ1dBUk5JTkc6IEFkZCBvcGVyYXRpb24gbWF5IG5vdCBoYXZlIGJlZW4gcGVyc2lzdGVkIHRvIGRpc2shJykKICAgICAgICB9CgogICAgICAgIGxvZygnQWRkZWQgaXRlbTonLCB0ZXh0LCAnLSBwZXJzaXN0ZWQ6JywgcGVyc2lzdGVkKQogICAgICAgIHJldHVybiBwZXJzaXN0ZWQKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBsb2coJ2FkZEl0ZW0gZmFpbGVkIGFmdGVyIHJldHJpZXM6JywgZSkKICAgICAgICAvLyBOb3RpZnkgZnJvbnRlbmQgYWJvdXQgdGhlIGVycm9yCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgcmVxID0gcnBjLnJlcXVlc3QoUlBDX01FU1NBR0UpCiAgICAgICAgICAgIHJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgICAgIHR5cGU6ICdvcGVyYXRpb24tZmFpbGVkJywKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBGYWlsZWQgdG8gYWRkIGl0ZW06ICR7ZS5tZXNzYWdlfS4gUGxlYXNlIHRyeSBhZ2Fpbi5gCiAgICAgICAgICAgIH0pKQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICBsb2coJ0ZhaWxlZCB0byBzZW5kIG9wZXJhdGlvbi1mYWlsZWQgbWVzc2FnZTonLCBlcnIpCiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQp9CgovLyBVcGRhdGUgaXRlbSBvcGVyYXRpb24KZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUl0ZW0oaXRlbSwgaW5pdEF1dG9iYXNlRm4pIHsKICAgIGlmICghaXNBdXRvYmFzZVJlYWR5KCkpIHsKICAgICAgICBsb2coJ3VwZGF0ZUl0ZW0gY2FsbGVkIGJ1dCBhdXRvYmFzZSBpcyBub3QgcmVhZHknKQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmICghYXV0b2Jhc2Uud3JpdGFibGUpIHsKICAgICAgICBsb2coJ3VwZGF0ZUl0ZW0gY2FsbGVkIGJ1dCBhdXRvYmFzZSBpcyBub3Qgd3JpdGFibGUgeWV0JykKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCByZXEgPSBycGMucmVxdWVzdChSUENfTUVTU0FHRSkKICAgICAgICAgICAgcmVxLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyB0eXBlOiAnbm90LXdyaXRhYmxlJywgbWVzc2FnZTogJ1dhaXRpbmcgdG8gYmUgYWRkZWQgYXMgYSB3cml0ZXIgYnkgdGhlIGhvc3QuLi4nIH0pKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgbG9nKCdGYWlsZWQgdG8gc2VuZCBub3Qtd3JpdGFibGUgbWVzc2FnZTonLCBlKQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBsb2coJ2NvbW1hbmQgUlBDX1VQREFURSB1cGRhdGVJdGVtIGl0ZW0nLCBpdGVtKQoKICAgIGNvbnN0IG9wID0gewogICAgICAgIHR5cGU6ICd1cGRhdGUnLAogICAgICAgIHZhbHVlOiBpdGVtCiAgICB9CgogICAgdHJ5IHsKICAgICAgICAvLyBFbnN1cmUgYXV0b2Jhc2UgaXMgZnVsbHkgcmVhZHkgYmVmb3JlIGFwcGVuZAogICAgICAgIGF3YWl0IGF1dG9iYXNlLnJlYWR5KCkKCiAgICAgICAgLy8gRG91YmxlLWNoZWNrIHN0YXRlIGFmdGVyIHJlYWR5KCkKICAgICAgICBpZiAoIWlzQXV0b2Jhc2VSZWFkeSgpIHx8ICFhdXRvYmFzZS53cml0YWJsZSkgewogICAgICAgICAgICBsb2coJ3VwZGF0ZUl0ZW06IGF1dG9iYXNlIHN0YXRlIGNoYW5nZWQgZHVyaW5nIHJlYWR5KCksIGFib3J0aW5nJykKICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQoKICAgICAgICAvLyBHZXQgbGVuZ3RoIGJlZm9yZSBhcHBlbmQgdG8gdmVyaWZ5IGl0IGluY3JlYXNlcwogICAgICAgIGNvbnN0IGxlbmd0aEJlZm9yZSA9IGF1dG9iYXNlLmxvY2FsLmxlbmd0aAoKICAgICAgICAvLyBVc2UgcmV0cnkgbG9naWMgaW4gY2FzZSBvZiB0cmFuc2llbnQgcmVwbGljYXRpb24gZXJyb3JzCiAgICAgICAgYXdhaXQgcmV0cnlXaXRoQmFja29mZihhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGlmICghaXNBdXRvYmFzZVJlYWR5KCkpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQXV0b2Jhc2UgYmVjYW1lIHVuYXZhaWxhYmxlIGR1cmluZyByZXRyeScpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXdhaXQgYXV0b2Jhc2UuYXBwZW5kKG9wKQogICAgICAgIH0sICd1cGRhdGVJdGVtLmFwcGVuZCcsIDMsIDEwMCwgaW5pdEF1dG9iYXNlRm4pCgogICAgICAgIC8vIEZsdXNoIHRvIGRpc2sgYW5kIHZlcmlmeSBwZXJzaXN0ZW5jZQogICAgICAgIGNvbnN0IHBlcnNpc3RlZCA9IGF3YWl0IHBlcnNpc3RBbmRWZXJpZnkobGVuZ3RoQmVmb3JlICsgMSwgJ1VQREFURScpCiAgICAgICAgaWYgKCFwZXJzaXN0ZWQpIHsKICAgICAgICAgICAgbG9nKCdXQVJOSU5HOiBVcGRhdGUgb3BlcmF0aW9uIG1heSBub3QgaGF2ZSBiZWVuIHBlcnNpc3RlZCB0byBkaXNrIScpCiAgICAgICAgfQoKICAgICAgICBsb2coJ1VwZGF0ZWQgaXRlbTonLCBpdGVtLnRleHQsICctIHBlcnNpc3RlZDonLCBwZXJzaXN0ZWQpCiAgICAgICAgcmV0dXJuIHBlcnNpc3RlZAogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGxvZygndXBkYXRlSXRlbSBmYWlsZWQgYWZ0ZXIgcmV0cmllczonLCBlKQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHJwYy5yZXF1ZXN0KFJQQ19NRVNTQUdFKQogICAgICAgICAgICByZXEuc2VuZChKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgICAgICB0eXBlOiAnb3BlcmF0aW9uLWZhaWxlZCcsCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBgRmFpbGVkIHRvIHVwZGF0ZSBpdGVtOiAke2UubWVzc2FnZX0uIFBsZWFzZSB0cnkgYWdhaW4uYAogICAgICAgICAgICB9KSkKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgbG9nKCdGYWlsZWQgdG8gc2VuZCBvcGVyYXRpb24tZmFpbGVkIG1lc3NhZ2U6JywgZXJyKQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2UKICAgIH0KfQoKLy8gRGVsZXRlIGl0ZW0gb3BlcmF0aW9uCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWxldGVJdGVtKGl0ZW0sIGluaXRBdXRvYmFzZUZuKSB7CiAgICBpZiAoIWlzQXV0b2Jhc2VSZWFkeSgpKSB7CiAgICAgICAgbG9nKCdkZWxldGVJdGVtIGNhbGxlZCBidXQgYXV0b2Jhc2UgaXMgbm90IHJlYWR5JykKICAgICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBpZiAoIWF1dG9iYXNlLndyaXRhYmxlKSB7CiAgICAgICAgbG9nKCdkZWxldGVJdGVtIGNhbGxlZCBidXQgYXV0b2Jhc2UgaXMgbm90IHdyaXRhYmxlIHlldCcpCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgcmVxID0gcnBjLnJlcXVlc3QoUlBDX01FU1NBR0UpCiAgICAgICAgICAgIHJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHsgdHlwZTogJ25vdC13cml0YWJsZScsIG1lc3NhZ2U6ICdXYWl0aW5nIHRvIGJlIGFkZGVkIGFzIGEgd3JpdGVyIGJ5IHRoZSBob3N0Li4uJyB9KSkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGxvZygnRmFpbGVkIHRvIHNlbmQgbm90LXdyaXRhYmxlIG1lc3NhZ2U6JywgZSkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgbG9nKCdjb21tYW5kIFJQQ19ERUxFVEUgZGVsZXRlSXRlbSBpdGVtJywgaXRlbSkKCiAgICBjb25zdCBvcCA9IHsKICAgICAgICB0eXBlOiAnZGVsZXRlJywKICAgICAgICB2YWx1ZTogaXRlbQogICAgfQoKICAgIHRyeSB7CiAgICAgICAgLy8gRW5zdXJlIGF1dG9iYXNlIGlzIGZ1bGx5IHJlYWR5IGJlZm9yZSBhcHBlbmQKICAgICAgICBhd2FpdCBhdXRvYmFzZS5yZWFkeSgpCgogICAgICAgIC8vIERvdWJsZS1jaGVjayBzdGF0ZSBhZnRlciByZWFkeSgpCiAgICAgICAgaWYgKCFpc0F1dG9iYXNlUmVhZHkoKSB8fCAhYXV0b2Jhc2Uud3JpdGFibGUpIHsKICAgICAgICAgICAgbG9nKCdkZWxldGVJdGVtOiBhdXRvYmFzZSBzdGF0ZSBjaGFuZ2VkIGR1cmluZyByZWFkeSgpLCBhYm9ydGluZycpCiAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KCiAgICAgICAgLy8gR2V0IGxlbmd0aCBiZWZvcmUgYXBwZW5kIHRvIHZlcmlmeSBpdCBpbmNyZWFzZXMKICAgICAgICBjb25zdCBsZW5ndGhCZWZvcmUgPSBhdXRvYmFzZS5sb2NhbC5sZW5ndGgKCiAgICAgICAgLy8gVXNlIHJldHJ5IGxvZ2ljIGluIGNhc2Ugb2YgdHJhbnNpZW50IHJlcGxpY2F0aW9uIGVycm9ycwogICAgICAgIGF3YWl0IHJldHJ5V2l0aEJhY2tvZmYoYXN5bmMgKCkgPT4gewogICAgICAgICAgICBpZiAoIWlzQXV0b2Jhc2VSZWFkeSgpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F1dG9iYXNlIGJlY2FtZSB1bmF2YWlsYWJsZSBkdXJpbmcgcmV0cnknKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGF3YWl0IGF1dG9iYXNlLmFwcGVuZChvcCkKICAgICAgICB9LCAnZGVsZXRlSXRlbS5hcHBlbmQnLCAzLCAxMDAsIGluaXRBdXRvYmFzZUZuKQoKICAgICAgICAvLyBGbHVzaCB0byBkaXNrIGFuZCB2ZXJpZnkgcGVyc2lzdGVuY2UKICAgICAgICBjb25zdCBwZXJzaXN0ZWQgPSBhd2FpdCBwZXJzaXN0QW5kVmVyaWZ5KGxlbmd0aEJlZm9yZSArIDEsICdERUxFVEUnKQogICAgICAgIGlmICghcGVyc2lzdGVkKSB7CiAgICAgICAgICAgIGxvZygnV0FSTklORzogRGVsZXRlIG9wZXJhdGlvbiBtYXkgbm90IGhhdmUgYmVlbiBwZXJzaXN0ZWQgdG8gZGlzayEnKQogICAgICAgIH0KCiAgICAgICAgbG9nKCdEZWxldGVkIGl0ZW06JywgaXRlbS50ZXh0LCAnLSBwZXJzaXN0ZWQ6JywgcGVyc2lzdGVkKQogICAgICAgIHJldHVybiBwZXJzaXN0ZWQKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBsb2coJ2RlbGV0ZUl0ZW0gZmFpbGVkIGFmdGVyIHJldHJpZXM6JywgZSkKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCByZXEgPSBycGMucmVxdWVzdChSUENfTUVTU0FHRSkKICAgICAgICAgICAgcmVxLnNlbmQoSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICAgICAgdHlwZTogJ29wZXJhdGlvbi1mYWlsZWQnLAogICAgICAgICAgICAgICAgbWVzc2FnZTogYEZhaWxlZCB0byBkZWxldGUgaXRlbTogJHtlLm1lc3NhZ2V9LiBQbGVhc2UgdHJ5IGFnYWluLmAKICAgICAgICAgICAgfSkpCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGxvZygnRmFpbGVkIHRvIHNlbmQgb3BlcmF0aW9uLWZhaWxlZCBtZXNzYWdlOicsIGVycikKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9Cn0KLy8gS2V5IG1hbmFnZW1lbnQgLSBzYXZlL2xvYWQgYXV0b2Jhc2UgYW5kIHdyaXRlciBrZXlzCgppbXBvcnQgZnMgZnJvbSAnYmFyZS1mcycKaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi91dGlscy5tanMnCmltcG9ydCB7IGtleUZpbGVQYXRoLCBsb2NhbFdyaXRlcktleUZpbGVQYXRoIH0gZnJvbSAnLi9zdG9yYWdlLm1qcycKCi8vIFNhdmUgYXV0b2Jhc2Uga2V5IHRvIGZpbGUgZm9yIHBlcnNpc3RlbmNlIGFjcm9zcyByZXN0YXJ0cwpleHBvcnQgZnVuY3Rpb24gc2F2ZUF1dG9iYXNlS2V5KGtleSkgewogICAgdHJ5IHsKICAgICAgICBjb25zdCBrZXlIZXggPSBrZXkudG9TdHJpbmcoJ2hleCcpCiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhrZXlGaWxlUGF0aCwga2V5SGV4KQogICAgICAgIGxvZygnU2F2ZWQgYXV0b2Jhc2Uga2V5IHRvIGZpbGU6Jywga2V5SGV4KQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGxvZygnRmFpbGVkIHRvIHNhdmUgYXV0b2Jhc2Uga2V5OicsIGUpCiAgICB9Cn0KCi8vIExvYWQgYXV0b2Jhc2Uga2V5IGZyb20gZmlsZSBpZiBpdCBleGlzdHMKZXhwb3J0IGZ1bmN0aW9uIGxvYWRBdXRvYmFzZUtleSgpIHsKICAgIHRyeSB7CiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoa2V5RmlsZVBhdGgpKSB7CiAgICAgICAgICAgIGNvbnN0IGtleUhleCA9IGZzLnJlYWRGaWxlU3luYyhrZXlGaWxlUGF0aCwgJ3V0ZjgnKS50cmltKCkKICAgICAgICAgICAgaWYgKGtleUhleCAmJiBrZXlIZXgubGVuZ3RoID09PSA2NCkgewogICAgICAgICAgICAgICAgbG9nKCdMb2FkZWQgYXV0b2Jhc2Uga2V5IGZyb20gZmlsZTonLCBrZXlIZXgpCiAgICAgICAgICAgICAgICByZXR1cm4gQnVmZmVyLmZyb20oa2V5SGV4LCAnaGV4JykKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBsb2coJ0ZhaWxlZCB0byBsb2FkIGF1dG9iYXNlIGtleTonLCBlKQogICAgfQogICAgcmV0dXJuIG51bGwKfQoKLy8gU2F2ZSBsb2NhbCB3cml0ZXIga2V5IHRvIGZpbGUgZm9yIHBlcnNpc3RlbmNlCmV4cG9ydCBmdW5jdGlvbiBzYXZlTG9jYWxXcml0ZXJLZXkoa2V5KSB7CiAgICB0cnkgewogICAgICAgIGNvbnN0IGtleUhleCA9IGtleS50b1N0cmluZygnaGV4JykKICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGxvY2FsV3JpdGVyS2V5RmlsZVBhdGgsIGtleUhleCkKICAgICAgICBsb2coJ1NhdmVkIGxvY2FsIHdyaXRlciBrZXkgdG8gZmlsZTonLCBrZXlIZXgpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgbG9nKCdGYWlsZWQgdG8gc2F2ZSBsb2NhbCB3cml0ZXIga2V5OicsIGUpCiAgICB9Cn0KCi8vIExvYWQgbG9jYWwgd3JpdGVyIGtleSBmcm9tIGZpbGUgaWYgaXQgZXhpc3RzCmV4cG9ydCBmdW5jdGlvbiBsb2FkTG9jYWxXcml0ZXJLZXkoKSB7CiAgICB0cnkgewogICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGxvY2FsV3JpdGVyS2V5RmlsZVBhdGgpKSB7CiAgICAgICAgICAgIGNvbnN0IGtleUhleCA9IGZzLnJlYWRGaWxlU3luYyhsb2NhbFdyaXRlcktleUZpbGVQYXRoLCAndXRmOCcpLnRyaW0oKQogICAgICAgICAgICBpZiAoa2V5SGV4ICYmIGtleUhleC5sZW5ndGggPT09IDY0KSB7CiAgICAgICAgICAgICAgICBsb2coJ0xvYWRlZCBsb2NhbCB3cml0ZXIga2V5IGZyb20gZmlsZTonLCBrZXlIZXgpCiAgICAgICAgICAgICAgICByZXR1cm4gQnVmZmVyLmZyb20oa2V5SGV4LCAnaGV4JykKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBsb2coJ0ZhaWxlZCB0byBsb2FkIGxvY2FsIHdyaXRlciBrZXk6JywgZSkKICAgIH0KICAgIHJldHVybiBudWxsCn0KLy8gTmV0d29ya2luZyAtIHN3YXJtIHNldHVwLCBoYW5kc2hha2UsIGFuZCByZXBsaWNhdGlvbgoKaW1wb3J0IEh5cGVyc3dhcm0gZnJvbSAnaHlwZXJzd2FybScKaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi91dGlscy5tanMnCmltcG9ydCB7CiAgICBhdXRvYmFzZSwgc3RvcmUsIHJwYywgcGVlckNvdW50LCBrbm93bldyaXRlcnMsIGN1cnJlbnRMaXN0LAogICAgc2V0Q2hhdFN3YXJtLCBzZXRQZWVyQ291bnQsIHNldEN1cnJlbnRMaXN0Cn0gZnJvbSAnLi9zdGF0ZS5tanMnCmltcG9ydCB7IGlzU3RhdGVNaXNtYXRjaEVycm9yLCBpc1RyYW5zaWVudFJlcGxpY2F0aW9uRXJyb3IsIHJldHJ5V2l0aEJhY2tvZmYgfSBmcm9tICcuL2Vycm9ycy5tanMnCmltcG9ydCB7IHN5bmNMaXN0VG9Gcm9udGVuZCB9IGZyb20gJy4vYXV0b2Jhc2UubWpzJwppbXBvcnQgewogICAgUlBDX01FU1NBR0UKfSBmcm9tICcuLi8uLi9ycGMtY29tbWFuZHMubWpzJwoKLy8gU2VuZCBoYW5kc2hha2UgbWVzc2FnZSBvdmVyIGNvbm5lY3Rpb24KZXhwb3J0IGZ1bmN0aW9uIHNlbmRIYW5kc2hha2VNZXNzYWdlKGNvbm4sIG1zZykgewogICAgY29uc3QgbGluZSA9IEpTT04uc3RyaW5naWZ5KG1zZykgKyAnXG4nCiAgICBjb25uLndyaXRlKGxpbmUpCn0KCi8vIEhhbmRsZSBpbmNvbWluZyBoYW5kc2hha2UgbWVzc2FnZQpleHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlSGFuZHNoYWtlTWVzc2FnZShtc2cpIHsKICAgIGlmICghYXV0b2Jhc2UpIHJldHVybgogICAgaWYgKCFtc2cgfHwgbXNnLnR5cGUgIT09ICd3cml0ZXIta2V5JykgcmV0dXJuCgogICAgY29uc3QgcmVtb3RlS2V5SGV4ID0gbXNnLmtleQogICAgaWYgKCFyZW1vdGVLZXlIZXggfHwgdHlwZW9mIHJlbW90ZUtleUhleCAhPT0gJ3N0cmluZycpIHJldHVybgoKICAgIGxvZyhgPT09IFJFQ0VJVkVEIFdSSVRFUiBLRVkgZnJvbSBwZWVyOiAke3JlbW90ZUtleUhleC5zbGljZSgwLCAxNil9Li4uID09PWApCiAgICBsb2coYCAgT3VyIHdyaXRhYmxlIHN0YXR1czogJHthdXRvYmFzZS53cml0YWJsZX1gKQogICAgbG9nKGAgIEtub3duIHdyaXRlcnMgY291bnQ6ICR7a25vd25Xcml0ZXJzLnNpemV9YCkKCiAgICBpZiAoa25vd25Xcml0ZXJzLmhhcyhyZW1vdGVLZXlIZXgpKSB7CiAgICAgICAgbG9nKGAgIEFscmVhZHkga25vd24gd3JpdGVyLCBza2lwcGluZ2ApCiAgICAgICAgcmV0dXJuCiAgICB9CiAgICBrbm93bldyaXRlcnMuYWRkKHJlbW90ZUtleUhleCkKICAgIGxvZyhgICBBZGRlZCB0byBrbm93biB3cml0ZXJzIHNldGApCgogICAgLy8gT25seSBhIHdyaXRlciAoaG9zdCkgY2FuIGFkZCBvdGhlciB3cml0ZXJzCiAgICBpZiAoIWF1dG9iYXNlLndyaXRhYmxlKSB7CiAgICAgICAgbG9nKCcgIFdlIGFyZSBOT1Qgd3JpdGFibGUgKGd1ZXN0KSAtIGNhbm5vdCBhZGQgcmVtb3RlIHdyaXRlciwgd2FpdGluZyBmb3IgaG9zdCB0byBhZGQgdXMnKQogICAgICAgIHJldHVybgogICAgfQoKICAgIGxvZyhgICBXZSBBUkUgd3JpdGFibGUgKGhvc3QpIC0gYWRkaW5nIHJlbW90ZSB3cml0ZXIgdmlhIGF1dG9iYXNlIGFwcGVuZC4uLmApCgogICAgdHJ5IHsKICAgICAgICBhd2FpdCBhdXRvYmFzZS5hcHBlbmQoewogICAgICAgICAgICB0eXBlOiAnYWRkLXdyaXRlcicsCiAgICAgICAgICAgIGtleTogcmVtb3RlS2V5SGV4CiAgICAgICAgfSkKICAgICAgICBsb2coYCAgU1VDQ0VTUzogQWRkZWQgcmVtb3RlIHdyaXRlciAke3JlbW90ZUtleUhleC5zbGljZSgwLCAxNil9Li4uIHRvIGF1dG9iYXNlYCkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBsb2coYCAgRkFJTEVEIHRvIGFkZCByZW1vdGUgd3JpdGVyOiAke2UubWVzc2FnZX1gKQogICAgfQp9CgovLyBTZXR1cCBoYW5kc2hha2UgY2hhbm5lbCBvbiBjb25uZWN0aW9uCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZXR1cEhhbmRzaGFrZUNoYW5uZWwoY29ubikgewogICAgaWYgKCFhdXRvYmFzZSkgewogICAgICAgIGxvZygnc2V0dXBIYW5kc2hha2VDaGFubmVsIGNhbGxlZCBiZWZvcmUgQXV0b2Jhc2UgaXMgaW5pdGlhbGl6ZWQnKQogICAgICAgIHJldHVybgogICAgfQoKICAgIC8vIFNlbmQgb3VyIHdyaXRlciBrZXkgaW1tZWRpYXRlbHkKICAgIGF3YWl0IGF1dG9iYXNlLnJlYWR5KCkKICAgIGNvbnN0IG15V3JpdGVyS2V5SGV4ID0gYXV0b2Jhc2UubG9jYWwua2V5LnRvU3RyaW5nKCdoZXgnKQogICAgbG9nKGA9PT0gU0VORElORyBPVVIgV1JJVEVSIEtFWSB0byBwZWVyOiAke215V3JpdGVyS2V5SGV4LnNsaWNlKDAsIDE2KX0uLi4gPT09YCkKICAgIGxvZyhgICBXZSBhcmUgd3JpdGFibGUgKGhvc3QpOiAke2F1dG9iYXNlLndyaXRhYmxlfWApCiAgICBzZW5kSGFuZHNoYWtlTWVzc2FnZShjb25uLCB7CiAgICAgICAgdHlwZTogJ3dyaXRlci1rZXknLAogICAgICAgIGtleTogbXlXcml0ZXJLZXlIZXgKICAgIH0pCiAgICBsb2coYCAgV3JpdGVyIGtleSBzZW50IHZpYSBoYW5kc2hha2UgY2hhbm5lbGApCgogICAgbGV0IGJ1ZmZlciA9ICcnCiAgICBjb25uLm9uKCdkYXRhJywgKGNodW5rKSA9PiB7CiAgICAgICAgYnVmZmVyICs9IGNodW5rLnRvU3RyaW5nKCkKICAgICAgICBsZXQgaWR4CiAgICAgICAgd2hpbGUgKChpZHggPSBidWZmZXIuaW5kZXhPZignXG4nKSkgIT09IC0xKSB7CiAgICAgICAgICAgIGNvbnN0IGxpbmUgPSBidWZmZXIuc2xpY2UoMCwgaWR4KQogICAgICAgICAgICBidWZmZXIgPSBidWZmZXIuc2xpY2UoaWR4ICsgMSkKICAgICAgICAgICAgaWYgKCFsaW5lLnRyaW0oKSkgY29udGludWUKCiAgICAgICAgICAgIC8vIEZhc3QtcGF0aDogaHlwZXJjb3JlIHByb3RvY29sIGZyYW1lcyBhbmQgb3RoZXIgYmluYXJ5IGdhcmJhZ2UKICAgICAgICAgICAgLy8gYXJlIG5vdCBnb2luZyB0byBzdGFydCB3aXRoICd7Jywgc28ganVzdCBpZ25vcmUgdGhlbS4KICAgICAgICAgICAgaWYgKGxpbmVbMF0gIT09ICd7JykgewogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IG1zZwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgbXNnID0gSlNPTi5wYXJzZShsaW5lKQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ2ludmFsaWQgSlNPTiBmcm9tIHBlZXIgKGhhbmRzaGFrZSwgaWdub3JlZCk6JywgbGluZSkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGhhbmRsZUhhbmRzaGFrZU1lc3NhZ2UobXNnKQogICAgICAgIH0KICAgIH0pCn0KCi8vIFNldHVwIGNoYXQgc3dhcm0gZm9yIGhhbmRzaGFrZS93cml0ZXIga2V5IGV4Y2hhbmdlCmV4cG9ydCBmdW5jdGlvbiBzZXR1cENoYXRTd2FybSh0b3BpYykgewogICAgaWYgKCFhdXRvYmFzZSkgewogICAgICAgIGxvZygnc2V0dXBDaGF0U3dhcm0gY2FsbGVkIGJlZm9yZSBBdXRvYmFzZSBpcyBpbml0aWFsaXplZCcpCiAgICAgICAgcmV0dXJuIG51bGwKICAgIH0KICAgIGNvbnN0IGNoYXRTd2FybSA9IG5ldyBIeXBlcnN3YXJtKCkKICAgIGxvZygnc2V0dGluZyB1cCBjaGF0IHN3YXJtIHdpdGggdG9waWM6JywgdG9waWMudG9TdHJpbmcoJ2hleCcpKQogICAgY2hhdFN3YXJtLm9uKCdjb25uZWN0aW9uJywgKGNvbm4sIGluZm8pID0+IHsKICAgICAgICBsb2coJ0hhbmRzaGFrZSBjb25uZWN0aW9uIChjaGF0IHN3YXJtKSB3aXRoIHBlZXInLCBpbmZvPy5wZWVyLCBpbmZvPy5wdWJsaWNLZXk/LnRvU3RyaW5nKCdoZXgnKSwgaW5mbz8udG9waWNzLCBpbmZvPy5wcmlvcml0aXplZCkKICAgICAgICBjb25uLm9uKCdlcnJvcicsIChlcnIpID0+IHsKICAgICAgICAgICAgbG9nKCdDaGF0IHN3YXJtIGNvbm5lY3Rpb24gZXJyb3I6JywgZXJyKQogICAgICAgIH0pCiAgICAgICAgc2V0dXBIYW5kc2hha2VDaGFubmVsKGNvbm4pCiAgICB9KQoKICAgIGNoYXRTd2FybS5vbignZXJyb3InLCAoZXJyKSA9PiB7CiAgICAgICAgbG9nKCdDaGF0IHN3YXJtIGVycm9yOicsIGVycikKICAgIH0pCgogICAgY2hhdFN3YXJtLmpvaW4odG9waWMsIHsgc2VydmVyOiB0cnVlLCBjbGllbnQ6IHRydWUgfSkKICAgIGxvZygnSGFuZHNoYWtlIGNoYXQgc3dhcm0gam9pbmVkIG9uIHRvcGljOicsIHRvcGljLnRvU3RyaW5nKCdoZXgnKSkKCiAgICBzZXRDaGF0U3dhcm0oY2hhdFN3YXJtKQogICAgcmV0dXJuIGNoYXRTd2FybQp9CgovLyBCcm9hZGNhc3QgcGVlciBjb3VudCB0byBmcm9udGVuZApleHBvcnQgZnVuY3Rpb24gYnJvYWRjYXN0UGVlckNvdW50KCkgewogICAgaWYgKCFycGMpIHJldHVybgogICAgdHJ5IHsKICAgICAgICBjb25zdCByZXEgPSBycGMucmVxdWVzdChSUENfTUVTU0FHRSkKICAgICAgICByZXEuc2VuZChKU09OLnN0cmluZ2lmeSh7IHR5cGU6ICdwZWVyLWNvdW50JywgY291bnQ6IHBlZXJDb3VudCB9KSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBsb2coJ0ZhaWxlZCB0byBicm9hZGNhc3QgcGVlciBjb3VudCcsIGUpCiAgICB9Cn0KCi8vIEhhbmRsZSByZXBsaWNhdGlvbiBzd2FybSBjb25uZWN0aW9uCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVSZXBsaWNhdGlvbkNvbm5lY3Rpb24oY29ubiwgcmVzZXRDb3JydXB0ZWRTdGF0ZUZuLCBpbml0QXV0b2Jhc2VGbikgewogICAgY29uc3QgcGVlcklkU2hvcnQgPSBjb25uLnB1YmxpY0tleSA/IGNvbm4ucHVibGljS2V5LnRvU3RyaW5nKCdoZXgnKS5zbGljZSgwLCAxMikgOiAndW5rbm93bicKICAgIHRyeSB7CiAgICAgICAgbG9nKGA9PT0gTkVXIFBFRVIgQ09OTkVDVEVEIChyZXBsaWNhdGlvbikgcGVlcj0ke3BlZXJJZFNob3J0fS4uLiA9PT1gKQogICAgICAgIGxvZyhgICBMb2NhbCBhdXRvYmFzZSBrZXk6ICR7YXV0b2Jhc2U/LmtleT8udG9TdHJpbmcoJ2hleCcpPy5zbGljZSgwLCAxNil9Li4uYCkKICAgICAgICBsb2coYCAgTG9jYWwgd3JpdGVyIGtleTogJHthdXRvYmFzZT8ubG9jYWw/LmtleT8udG9TdHJpbmcoJ2hleCcpPy5zbGljZSgwLCAxNil9Li4uYCkKICAgICAgICBsb2coYCAgTG9jYWwgd3JpdGFibGU6ICR7YXV0b2Jhc2U/LndyaXRhYmxlfWApCgogICAgICAgIGNvbm4ub24oJ2Vycm9yJywgKGVycikgPT4gewogICAgICAgICAgICBsb2coYFtQRUVSICR7cGVlcklkU2hvcnR9XSBSZXBsaWNhdGlvbiBjb25uZWN0aW9uIGVycm9yOmAsIGVycikKICAgICAgICAgICAgaWYgKGlzU3RhdGVNaXNtYXRjaEVycm9yKGVycikpIHsKICAgICAgICAgICAgICAgIHJlc2V0Q29ycnVwdGVkU3RhdGVGbihlcnIubWVzc2FnZSB8fCBTdHJpbmcoZXJyKSwgaW5pdEF1dG9iYXNlRm4pCiAgICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIHNldFBlZXJDb3VudChwZWVyQ291bnQgKyAxKQogICAgICAgIGJyb2FkY2FzdFBlZXJDb3VudCgpCgogICAgICAgIGNvbm4ub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICAgICAgICBsb2coYFtQRUVSICR7cGVlcklkU2hvcnR9XSBDb25uZWN0aW9uIGNsb3NlZGApCiAgICAgICAgICAgIHNldFBlZXJDb3VudChNYXRoLm1heCgwLCBwZWVyQ291bnQgLSAxKSkKICAgICAgICAgICAgYnJvYWRjYXN0UGVlckNvdW50KCkKICAgICAgICB9KQoKICAgICAgICAvLyBHdWFyZDogY2hlY2sgaWYgc3RvcmUgaXMgdmFsaWQgYW5kIG5vdCBjbG9zZWQgYmVmb3JlIHJlcGxpY2F0aW5nCiAgICAgICAgaWYgKGF1dG9iYXNlICYmIHN0b3JlICYmICFzdG9yZS5jbG9zZWQpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIC8vIFVzZSBzdG9yZS5yZXBsaWNhdGUoKSB3aGljaCBoYW5kbGVzIEFMTCBjb3JlcyBpbmNsdWRpbmcgb25lcyBhZGRlZCBsYXRlcgogICAgICAgICAgICAgICAgY29uc3QgcmVwbGljYXRpb25TdHJlYW0gPSBzdG9yZS5yZXBsaWNhdGUoY29ubikKCiAgICAgICAgICAgICAgICByZXBsaWNhdGlvblN0cmVhbS5vbignZXJyb3InLCAoZXJyKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgbG9nKGBbUEVFUiAke3BlZXJJZFNob3J0fV0gUmVwbGljYXRpb24gc3RyZWFtIGVycm9yOmAsIGVycikKICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdGF0ZU1pc21hdGNoRXJyb3IoZXJyKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXNldENvcnJ1cHRlZFN0YXRlRm4oZXJyLm1lc3NhZ2UgfHwgU3RyaW5nKGVyciksIGluaXRBdXRvYmFzZUZuKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgbG9nKGBbUEVFUiAke3BlZXJJZFNob3J0fV0gQ29yZXN0b3JlIHJlcGxpY2F0aW9uIHNldCB1cCBzdWNjZXNzZnVsbHlgKQoKICAgICAgICAgICAgICAgIC8vIENSSVRJQ0FMOiBGb3IgZ3Vlc3RzLCBleHBsaWNpdGx5IGRvd25sb2FkIHRoZSBib290c3RyYXAgY29yZSAoaG9zdCdzIGRhdGEpCiAgICAgICAgICAgICAgICAvLyBhbmQgdHJpZ2dlciB1cGRhdGVzIHdoZW4gZGF0YSBhcnJpdmVzCiAgICAgICAgICAgICAgICBpZiAoIWF1dG9iYXNlLndyaXRhYmxlICYmIGF1dG9iYXNlLmtleSkgewogICAgICAgICAgICAgICAgICAgIGxvZyhgW1BFRVIgJHtwZWVySWRTaG9ydH1dIFdlIGFyZSBHVUVTVCAtIHNldHRpbmcgdXAgYm9vdHN0cmFwIGNvcmUgc3luYy4uLmApCgogICAgICAgICAgICAgICAgICAgIC8vIEdldCB0aGUgYm9vdHN0cmFwIGNvcmUgKHRoaXMgaXMgdGhlIGhvc3QncyB3cml0ZXIgY29yZSkKICAgICAgICAgICAgICAgICAgICBjb25zdCBib290c3RyYXBDb3JlID0gc3RvcmUuZ2V0KHsga2V5OiBhdXRvYmFzZS5rZXkgfSkKICAgICAgICAgICAgICAgICAgICBhd2FpdCBib290c3RyYXBDb3JlLnJlYWR5KCkKICAgICAgICAgICAgICAgICAgICBsb2coYFtQRUVSICR7cGVlcklkU2hvcnR9XSBCb290c3RyYXAgY29yZSByZWFkeSwgbGVuZ3RoOiAke2Jvb3RzdHJhcENvcmUubGVuZ3RofWApCgogICAgICAgICAgICAgICAgICAgIC8vIERvd25sb2FkIGFsbCBkYXRhIGZyb20gdGhlIGJvb3RzdHJhcCBjb3JlCiAgICAgICAgICAgICAgICAgICAgaWYgKGJvb3RzdHJhcENvcmUubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBsb2coYFtQRUVSICR7cGVlcklkU2hvcnR9XSBEb3dubG9hZGluZyAke2Jvb3RzdHJhcENvcmUubGVuZ3RofSBibG9ja3MgZnJvbSBib290c3RyYXAuLi5gKQogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBib290c3RyYXBDb3JlLmRvd25sb2FkKHsgc3RhcnQ6IDAsIGVuZDogYm9vdHN0cmFwQ29yZS5sZW5ndGggfSkuZG9uZSgpCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZyhgW1BFRVIgJHtwZWVySWRTaG9ydH1dIEJvb3RzdHJhcCBkb3dubG9hZCBjb21wbGV0ZWApCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBMaXN0ZW4gZm9yIG5ldyBkYXRhIG9uIHRoZSBib290c3RyYXAgY29yZQogICAgICAgICAgICAgICAgICAgIGJvb3RzdHJhcENvcmUub24oJ2FwcGVuZCcsIGFzeW5jICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nKGBbUEVFUiAke3BlZXJJZFNob3J0fV0gQm9vdHN0cmFwIGNvcmUgcmVjZWl2ZWQgbmV3IGRhdGEsIGxlbmd0aDogJHtib290c3RyYXBDb3JlLmxlbmd0aH1gKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBEb3dubG9hZCB0aGUgbmV3IGRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgYm9vdHN0cmFwQ29yZS5kb3dubG9hZCh7IHN0YXJ0OiAwLCBlbmQ6IGJvb3RzdHJhcENvcmUubGVuZ3RoIH0pLmRvbmUoKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIGF1dG9iYXNlIHVwZGF0ZSB0byBwcm9jZXNzIHRoZSBuZXcgZGF0YQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXV0b2Jhc2UgJiYgIWF1dG9iYXNlLmNsb3NlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2coYFtQRUVSICR7cGVlcklkU2hvcnR9XSBUcmlnZ2VyaW5nIGF1dG9iYXNlIHVwZGF0ZSBhZnRlciBib290c3RyYXAgc3luYy4uLmApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgYXV0b2Jhc2UudXBkYXRlKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2coYFtQRUVSICR7cGVlcklkU2hvcnR9XSBBdXRvYmFzZSB1cGRhdGUgY29tcGxldGUsIHZpZXcgbGVuZ3RoOiAke2F1dG9iYXNlLnZpZXc/Lmxlbmd0aH1gKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN5bmNMaXN0VG9Gcm9udGVuZCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nKGBbUEVFUiAke3BlZXJJZFNob3J0fV0gRXJyb3IgdXBkYXRpbmcgYXV0b2Jhc2U6YCwgZS5tZXNzYWdlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciBpbml0aWFsIHVwZGF0ZSBhZnRlciBjb25uZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChhc3luYyAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhdXRvYmFzZSAmJiAhYXV0b2Jhc2UuY2xvc2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZyhgW1BFRVIgJHtwZWVySWRTaG9ydH1dIERlbGF5ZWQgYXV0b2Jhc2UgdXBkYXRlIGZvciBpbml0aWFsIHN5bmMuLi5gKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGF1dG9iYXNlLnVwZGF0ZSgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nKGBbUEVFUiAke3BlZXJJZFNob3J0fV0gSW5pdGlhbCBzeW5jIGNvbXBsZXRlLCB2aWV3IGxlbmd0aDogJHthdXRvYmFzZS52aWV3Py5sZW5ndGh9LCBsaXN0IGl0ZW1zOiAke2N1cnJlbnRMaXN0Lmxlbmd0aH1gKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN5bmNMaXN0VG9Gcm9udGVuZCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nKGBbUEVFUiAke3BlZXJJZFNob3J0fV0gRXJyb3IgaW4gZGVsYXllZCB1cGRhdGU6YCwgZS5tZXNzYWdlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgMTAwMCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAocmVwbEVycikgewogICAgICAgICAgICAgICAgbG9nKGBbUEVFUiAke3BlZXJJZFNob3J0fV0gRmFpbGVkIHRvIHNldCB1cCByZXBsaWNhdGlvbjpgLCByZXBsRXJyLm1lc3NhZ2UpCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsb2coYFtQRUVSICR7cGVlcklkU2hvcnR9XSBTa2lwcGluZyByZXBsaWNhdGlvbiAtIHN0b3JlIG5vdCByZWFkeSBvciBjbG9zZWRgKQogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBsb2coYFtQRUVSICR7cGVlcklkU2hvcnR9XSBFcnJvciBpbiBzd2FybSBjb25uZWN0aW9uIGhhbmRsZXI6YCwgZSkKICAgICAgICBpZiAoaXNTdGF0ZU1pc21hdGNoRXJyb3IoZSkpIHsKICAgICAgICAgICAgcmVzZXRDb3JydXB0ZWRTdGF0ZUZuKGUubWVzc2FnZSB8fCBTdHJpbmcoZSksIGluaXRBdXRvYmFzZUZuKQogICAgICAgIH0KICAgIH0KfQoKLy8gQ3JlYXRlIGFuZCBzZXR1cCByZXBsaWNhdGlvbiBzd2FybQpleHBvcnQgZnVuY3Rpb24gY3JlYXRlUmVwbGljYXRpb25Td2FybShyZXNldENvcnJ1cHRlZFN0YXRlRm4sIGluaXRBdXRvYmFzZUZuKSB7CiAgICBjb25zdCBzd2FybSA9IG5ldyBIeXBlcnN3YXJtKCkKICAgIHN3YXJtLm9uKCdlcnJvcicsIChlcnIpID0+IHsKICAgICAgICBsb2coJ1JlcGxpY2F0aW9uIHN3YXJtIGVycm9yOicsIGVycikKICAgIH0pCgogICAgc3dhcm0ub24oJ2Nvbm5lY3Rpb24nLCBhc3luYyAoY29ubikgPT4gewogICAgICAgIGF3YWl0IGhhbmRsZVJlcGxpY2F0aW9uQ29ubmVjdGlvbihjb25uLCByZXNldENvcnJ1cHRlZFN0YXRlRm4sIGluaXRBdXRvYmFzZUZuKQogICAgfSkKCiAgICByZXR1cm4gc3dhcm0KfQovLyBTaGFyZWQgbXV0YWJsZSBzdGF0ZSBleHBvcnRzCi8vIEFsbCBtb2R1bGVzIGltcG9ydCBmcm9tIGhlcmUgYW5kIHVzZSBzZXR0ZXJzIHRvIG1vZGlmeSBzdGF0ZQoKLy8gQ29yZSBQMlAgaW5zdGFuY2VzCmV4cG9ydCBsZXQgYXV0b2Jhc2UgPSBudWxsCmV4cG9ydCBsZXQgc3RvcmUgPSBudWxsCmV4cG9ydCBsZXQgc3dhcm0gPSBudWxsCmV4cG9ydCBsZXQgY2hhdFN3YXJtID0gbnVsbApleHBvcnQgbGV0IGRpc2NvdmVyeSA9IG51bGwKCi8vIFJQQyBpbnN0YW5jZQpleHBvcnQgbGV0IHJwYyA9IG51bGwKCi8vIEtleXMgYW5kIHRvcGljcwpleHBvcnQgbGV0IGJhc2VLZXkgPSBudWxsCmV4cG9ydCBsZXQgY3VycmVudFRvcGljID0gbnVsbApleHBvcnQgbGV0IGNoYXRUb3BpYyA9IG51bGwKCi8vIEluLW1lbW9yeSBkYXRhCmV4cG9ydCBsZXQgY3VycmVudExpc3QgPSBbXQpleHBvcnQgbGV0IHBlZXJDb3VudCA9IDAKCi8vIFdyaXRlciB0cmFja2luZwpleHBvcnQgY29uc3Qga25vd25Xcml0ZXJzID0gbmV3IFNldCgpCmV4cG9ydCBsZXQgYWRkZWRTdGF0aWNQZWVycyA9IGZhbHNlCgovLyBTdGF0ZSBmbGFncwpleHBvcnQgbGV0IGlzUmVzZXR0aW5nU3RhdGUgPSBmYWxzZQoKLy8gVHJhbnNpZW50IGVycm9yIHRyYWNraW5nCmV4cG9ydCBsZXQgdHJhbnNpZW50RXJyb3JDb3VudCA9IDAKZXhwb3J0IGxldCBsYXN0VHJhbnNpZW50RXJyb3JUaW1lID0gMApleHBvcnQgY29uc3QgTUFYX1RSQU5TSUVOVF9FUlJPUlMgPSAxMAoKLy8gU2V0dGVycyBmb3IgbXV0YWJsZSBzdGF0ZQpleHBvcnQgZnVuY3Rpb24gc2V0QXV0b2Jhc2UodmFsKSB7IGF1dG9iYXNlID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldFN0b3JlKHZhbCkgeyBzdG9yZSA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRTd2FybSh2YWwpIHsgc3dhcm0gPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0Q2hhdFN3YXJtKHZhbCkgeyBjaGF0U3dhcm0gPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0RGlzY292ZXJ5KHZhbCkgeyBkaXNjb3ZlcnkgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0UnBjKHZhbCkgeyBycGMgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0QmFzZUtleSh2YWwpIHsgYmFzZUtleSA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRDdXJyZW50VG9waWModmFsKSB7IGN1cnJlbnRUb3BpYyA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRDaGF0VG9waWModmFsKSB7IGNoYXRUb3BpYyA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRDdXJyZW50TGlzdCh2YWwpIHsgY3VycmVudExpc3QgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0UGVlckNvdW50KHZhbCkgeyBwZWVyQ291bnQgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0QWRkZWRTdGF0aWNQZWVycyh2YWwpIHsgYWRkZWRTdGF0aWNQZWVycyA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRJc1Jlc2V0dGluZ1N0YXRlKHZhbCkgeyBpc1Jlc2V0dGluZ1N0YXRlID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldFRyYW5zaWVudEVycm9yQ291bnQodmFsKSB7IHRyYW5zaWVudEVycm9yQ291bnQgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0TGFzdFRyYW5zaWVudEVycm9yVGltZSh2YWwpIHsgbGFzdFRyYW5zaWVudEVycm9yVGltZSA9IHZhbCB9CgovLyBIZWxwZXIgdG8gY2xlYXIga25vd24gd3JpdGVycwpleHBvcnQgZnVuY3Rpb24gY2xlYXJLbm93bldyaXRlcnMoKSB7IGtub3duV3JpdGVycy5jbGVhcigpIH0KLy8gU3RvcmFnZSBwYXRocyBhbmQgZmlsZSBtYW5hZ2VtZW50CgppbXBvcnQgZnMgZnJvbSAnYmFyZS1mcycKaW1wb3J0IHsgam9pbiB9IGZyb20gJ2JhcmUtcGF0aCcKaW1wb3J0IENvcmVzdG9yZSBmcm9tICdjb3Jlc3RvcmUnCmltcG9ydCB7IGxvZywgc2xlZXAgfSBmcm9tICcuL3V0aWxzLm1qcycKaW1wb3J0IHsgc2V0QmFzZUtleSB9IGZyb20gJy4vc3RhdGUubWpzJwoKLy8gU3RvcmFnZSBwYXRocyAtIGNvbXB1dGVkIGZyb20gYmFzZSBkaXJlY3RvcnkKbGV0IGJhc2VEaXIgPSBudWxsCmV4cG9ydCBsZXQgc3RvcmFnZVBhdGggPSAnLi9kYXRhJwpleHBvcnQgbGV0IGtleUZpbGVQYXRoID0gJy4vYXV0b2Jhc2Uta2V5LnR4dCcKZXhwb3J0IGxldCBsb2NhbFdyaXRlcktleUZpbGVQYXRoID0gJy4vbG9jYWwtd3JpdGVyLWtleS50eHQnCmV4cG9ydCBsZXQgVkVSU0lPTl9NQVJLRVJfRklMRSA9IG51bGwKCi8vIEluaXRpYWxpemUgc3RvcmFnZSBwYXRocyBmcm9tIGJhc2UgZGlyZWN0b3J5CmV4cG9ydCBmdW5jdGlvbiBpbml0U3RvcmFnZVBhdGhzKGJhc2VEaXJQYXRoKSB7CiAgICBiYXNlRGlyID0gYmFzZURpclBhdGgKICAgIHN0b3JhZ2VQYXRoID0gYmFzZURpciA/IGpvaW4oYmFzZURpciwgJ2xpc3RhJykgOiAnLi9kYXRhJwogICAga2V5RmlsZVBhdGggPSBiYXNlRGlyID8gam9pbihiYXNlRGlyLCAnbGlzdGEtYXV0b2Jhc2Uta2V5LnR4dCcpIDogJy4vYXV0b2Jhc2Uta2V5LnR4dCcKICAgIGxvY2FsV3JpdGVyS2V5RmlsZVBhdGggPSBiYXNlRGlyID8gam9pbihiYXNlRGlyLCAnbGlzdGEtbG9jYWwtd3JpdGVyLWtleS50eHQnKSA6ICcuL2xvY2FsLXdyaXRlci1rZXkudHh0JwogICAgVkVSU0lPTl9NQVJLRVJfRklMRSA9IGJhc2VEaXIgPyBqb2luKGJhc2VEaXIsICcubGlzdGEtc3RvcmFnZS12MicpIDogbnVsbAoKICAgIGxvZygnU3RvcmFnZSBwYXRocyBpbml0aWFsaXplZDonKQogICAgbG9nKCcgIGJhc2VEaXI6JywgYmFzZURpcikKICAgIGxvZygnICBzdG9yYWdlUGF0aDonLCBzdG9yYWdlUGF0aCkKICAgIGxvZygnICBrZXlGaWxlUGF0aDonLCBrZXlGaWxlUGF0aCkKICAgIGxvZygnICBsb2NhbFdyaXRlcktleUZpbGVQYXRoOicsIGxvY2FsV3JpdGVyS2V5RmlsZVBhdGgpCn0KCmV4cG9ydCBmdW5jdGlvbiBnZXRCYXNlRGlyKCkgewogICAgcmV0dXJuIGJhc2VEaXIKfQoKLy8gU3luY2hyb25vdXMgY2xlYW51cCBoZWxwZXIgdG8gZGVsZXRlIGNvcnJ1cHRlZCBzdG9yYWdlCmV4cG9ydCBmdW5jdGlvbiBkZWxldGVTdG9yYWdlU3luYygpIHsKICAgIGxvZygnUGVyZm9ybWluZyBzeW5jaHJvbm91cyBzdG9yYWdlIGNsZWFudXAuLi4nKQogICAgdHJ5IHsKICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhrZXlGaWxlUGF0aCkpIHsKICAgICAgICAgICAgZnMudW5saW5rU3luYyhrZXlGaWxlUGF0aCkKICAgICAgICAgICAgbG9nKCdEZWxldGVkIGF1dG9iYXNlIGtleSBmaWxlJykKICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7IGxvZygnRXJyb3IgZGVsZXRpbmcga2V5IGZpbGU6JywgZSkgfQoKICAgIHRyeSB7CiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMobG9jYWxXcml0ZXJLZXlGaWxlUGF0aCkpIHsKICAgICAgICAgICAgZnMudW5saW5rU3luYyhsb2NhbFdyaXRlcktleUZpbGVQYXRoKQogICAgICAgICAgICBsb2coJ0RlbGV0ZWQgbG9jYWwgd3JpdGVyIGtleSBmaWxlJykKICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7IGxvZygnRXJyb3IgZGVsZXRpbmcgbG9jYWwgd3JpdGVyIGtleSBmaWxlOicsIGUpIH0KCiAgICB0cnkgewogICAgICAgIGlmIChmcy5leGlzdHNTeW5jKHN0b3JhZ2VQYXRoKSkgewogICAgICAgICAgICBjb25zdCBkZWxldGVGb2xkZXJSZWN1cnNpdmUgPSAocGF0aCkgPT4gewogICAgICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMocGF0aCkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKHBhdGgpCiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1clBhdGggPSBqb2luKHBhdGgsIGZpbGUpCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXQgPSBmcy5zdGF0U3luYyhjdXJQYXRoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdC5pc0RpcmVjdG9yeSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGVGb2xkZXJSZWN1cnNpdmUoY3VyUGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZzLnVubGlua1N5bmMoY3VyUGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmcy5ybWRpclN5bmMocGF0aCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGVGb2xkZXJSZWN1cnNpdmUoc3RvcmFnZVBhdGgpCiAgICAgICAgICAgIGxvZygnRGVsZXRlZCBzdG9yYWdlIGRpcmVjdG9yeTonLCBzdG9yYWdlUGF0aCkKICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7IGxvZygnRXJyb3IgZGVsZXRpbmcgc3RvcmFnZTonLCBlKSB9Cn0KCi8vIERlbGV0ZSBzdG9yYWdlIHdpdGggcmV0cnkgbG9naWMgYW5kIGRlbGF5cwpleHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlU3RvcmFnZVdpdGhSZXRyeShtYXhSZXRyaWVzID0gMywgaW5pdGlhbERlbGF5TXMgPSA1MDApIHsKICAgIGZvciAobGV0IGF0dGVtcHQgPSAxOyBhdHRlbXB0IDw9IG1heFJldHJpZXM7IGF0dGVtcHQrKykgewogICAgICAgIGNvbnN0IGRlbGF5TXMgPSBpbml0aWFsRGVsYXlNcyAqIGF0dGVtcHQKICAgICAgICBsb2coYGRlbGV0ZVN0b3JhZ2VXaXRoUmV0cnk6IGF0dGVtcHQgJHthdHRlbXB0fS8ke21heFJldHJpZXN9LCB3YWl0aW5nICR7ZGVsYXlNc31tcyBiZWZvcmUgZGVsZXRlLi4uYCkKCiAgICAgICAgYXdhaXQgc2xlZXAoZGVsYXlNcykKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZGVsZXRlU3RvcmFnZVN5bmMoKQogICAgICAgICAgICBsb2coYGRlbGV0ZVN0b3JhZ2VXaXRoUmV0cnk6IFNVQ0NFU1Mgb24gYXR0ZW1wdCAke2F0dGVtcHR9YCkKICAgICAgICAgICAgcmV0dXJuIHRydWUKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnN0IGVycm9yU3RyID0gU3RyaW5nKGUpCiAgICAgICAgICAgIGlmIChlcnJvclN0ci5pbmNsdWRlcygnbG9jaycpIHx8IGVycm9yU3RyLmluY2x1ZGVzKCdMT0NLJykgfHwgZXJyb3JTdHIuaW5jbHVkZXMoJ05vIGxvY2tzIGF2YWlsYWJsZScpKSB7CiAgICAgICAgICAgICAgICBsb2coYGRlbGV0ZVN0b3JhZ2VXaXRoUmV0cnk6IGxvY2sgc3RpbGwgaGVsZCBvbiBhdHRlbXB0ICR7YXR0ZW1wdH0sIHdpbGwgcmV0cnkuLi5gKQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbG9nKGBkZWxldGVTdG9yYWdlV2l0aFJldHJ5OiBlcnJvciBvbiBhdHRlbXB0ICR7YXR0ZW1wdH06YCwgZSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGF0dGVtcHQgPT09IG1heFJldHJpZXMpIHsKICAgICAgICAgICAgICAgIGxvZygnZGVsZXRlU3RvcmFnZVdpdGhSZXRyeTogRkFJTEVEIGFmdGVyIGFsbCByZXRyaWVzJykKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlCn0KCi8vIENoZWNrIGZvciB2ZXJzaW9uIG1hcmtlciB0byBkZXRlY3Qgc3RvcmFnZSBmcm9tIG9sZCBjb2RlIHZlcnNpb25zCmV4cG9ydCBmdW5jdGlvbiBjaGVja1N0b3JhZ2VWZXJzaW9uKCkgewogICAgaWYgKCFWRVJTSU9OX01BUktFUl9GSUxFKSByZXR1cm4gdHJ1ZQoKICAgIC8vIElmIHZlcnNpb24gbWFya2VyIGV4aXN0cywgc3RvcmFnZSBpcyBmcm9tIGN1cnJlbnQgY29kZSB2ZXJzaW9uCiAgICBpZiAoZnMuZXhpc3RzU3luYyhWRVJTSU9OX01BUktFUl9GSUxFKSkgewogICAgICAgIGxvZygnU3RvcmFnZSB2ZXJzaW9uIG1hcmtlciBmb3VuZCwgc3RvcmFnZSBpcyBjb21wYXRpYmxlJykKICAgICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIC8vIElmIHN0b3JhZ2UgZXhpc3RzIGJ1dCBubyB2ZXJzaW9uIG1hcmtlciwgaXQncyBmcm9tIG9sZCBjb2RlIHdpdGggY2hlY2twb2ludCBidWdzCiAgICBpZiAoZnMuZXhpc3RzU3luYyhzdG9yYWdlUGF0aCkgfHwgZnMuZXhpc3RzU3luYyhrZXlGaWxlUGF0aCkpIHsKICAgICAgICBsb2coJz09PSBERVRFQ1RFRCBPTEQgU1RPUkFHRSBWRVJTSU9OID09PScpCiAgICAgICAgbG9nKCdTdG9yYWdlIHdhcyBjcmVhdGVkIGJ5IG9sZGVyIGNvZGUgd2l0aCBjaGVja3BvaW50IGJ1Z3MuJykKICAgICAgICBsb2coJ0NsZWFuaW5nIHVwIHRvIGVuc3VyZSBmcmVzaCwgdW5jb3JydXB0ZWQgc3RhdGUuLi4nKQoKICAgICAgICAvLyBDbGVhbiB1cCBvbGQgc3RvcmFnZQogICAgICAgIGRlbGV0ZVN0b3JhZ2VTeW5jKCkKCiAgICAgICAgLy8gQ1JJVElDQUw6IEFsc28gY2xlYXIgYmFzZUtleSBzbyB0aGUgaG9zdCBjcmVhdGVzIGEgRlJFU0ggYXV0b2Jhc2UgYXMgb3duZXIKICAgICAgICBzZXRCYXNlS2V5KG51bGwpCiAgICAgICAgbG9nKCdDbGVhcmVkIGJhc2VLZXkgLSBob3N0IHdpbGwgY3JlYXRlIGZyZXNoIGF1dG9iYXNlIGFzIG93bmVyJykKCiAgICAgICAgLy8gQ3JlYXRlIHZlcnNpb24gbWFya2VyIGZvciBuZXcgc3RvcmFnZQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoVkVSU0lPTl9NQVJLRVJfRklMRSwgYHYyOiR7RGF0ZS5ub3coKX1gKQogICAgICAgICAgICBsb2coJ0NyZWF0ZWQgc3RvcmFnZSB2ZXJzaW9uIG1hcmtlcicpCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBsb2coJ0ZhaWxlZCB0byBjcmVhdGUgdmVyc2lvbiBtYXJrZXI6JywgZSkKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZSAvLyBTdG9yYWdlIHdhcyBjbGVhbmVkCiAgICB9CgogICAgLy8gTm8gc3RvcmFnZSBleGlzdHMgLSBjcmVhdGUgdmVyc2lvbiBtYXJrZXIgZm9yIG5ldyBpbnN0YWxscwogICAgdHJ5IHsKICAgICAgICBmcy53cml0ZUZpbGVTeW5jKFZFUlNJT05fTUFSS0VSX0ZJTEUsIGB2Mjoke0RhdGUubm93KCl9YCkKICAgICAgICBsb2coJ0NyZWF0ZWQgc3RvcmFnZSB2ZXJzaW9uIG1hcmtlciBmb3IgZnJlc2ggaW5zdGFsbCcpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgbG9nKCdGYWlsZWQgdG8gY3JlYXRlIHZlcnNpb24gbWFya2VyOicsIGUpCiAgICB9CgogICAgcmV0dXJuIHRydWUKfQoKLy8gVmFsaWRhdGUgc3RvcmFnZSBpbnRlZ3JpdHkgYmVmb3JlIGluaXRpYWxpemluZwovLyBsb2FkTG9jYWxXcml0ZXJLZXlGbiBpcyBwYXNzZWQgdG8gYXZvaWQgY2lyY3VsYXIgZGVwZW5kZW5jeQpleHBvcnQgYXN5bmMgZnVuY3Rpb24gdmFsaWRhdGVTdG9yYWdlSW50ZWdyaXR5KG5vdGlmeVVzZXJFcnJvciwgbG9hZExvY2FsV3JpdGVyS2V5Rm4pIHsKICAgIGxvZygnPT09IFZBTElEQVRJTkcgU1RPUkFHRSBJTlRFR1JJVFkgPT09JykKCiAgICAvLyBGaXJzdCBjaGVjayBzdG9yYWdlIHZlcnNpb24gLSBjbGVhbiB1cCBpZiBmcm9tIG9sZCBidWdneSBjb2RlCiAgICBjaGVja1N0b3JhZ2VWZXJzaW9uKCkKCiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoc3RvcmFnZVBhdGgpKSB7CiAgICAgICAgbG9nKCdTdG9yYWdlIGRvZXMgbm90IGV4aXN0LCBmcmVzaCBzdGFydCcpCiAgICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICB0cnkgewogICAgICAgIC8vIFRyeSB0byBvcGVuIHRoZSBjb3Jlc3RvcmUgYW5kIGNoZWNrIGJhc2ljIGludGVncml0eQogICAgICAgIGNvbnN0IHRlc3RTdG9yZSA9IG5ldyBDb3Jlc3RvcmUoc3RvcmFnZVBhdGgpCiAgICAgICAgYXdhaXQgdGVzdFN0b3JlLnJlYWR5KCkKCiAgICAgICAgLy8gVHJ5IHRvIGxvYWQgdGhlIGxvY2FsIHdyaXRlciBrZXkgYW5kIGFjY2VzcyB0aGF0IGNvcmUKICAgICAgICBjb25zdCBzYXZlZExvY2FsV3JpdGVyS2V5ID0gbG9hZExvY2FsV3JpdGVyS2V5Rm4gPyBsb2FkTG9jYWxXcml0ZXJLZXlGbigpIDogbnVsbAogICAgICAgIGlmIChzYXZlZExvY2FsV3JpdGVyS2V5KSB7CiAgICAgICAgICAgIGNvbnN0IHRlc3RDb3JlID0gdGVzdFN0b3JlLmdldCh7IGtleTogc2F2ZWRMb2NhbFdyaXRlcktleSB9KQogICAgICAgICAgICBhd2FpdCB0ZXN0Q29yZS5yZWFkeSgpCiAgICAgICAgICAgIC8vIFRyeSB0byByZWFkIGZpcnN0IGVudHJ5IHRvIHZlcmlmeSBkYXRhIGludGVncml0eQogICAgICAgICAgICBpZiAodGVzdENvcmUubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgYXdhaXQgdGVzdENvcmUuZ2V0KDApCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGF3YWl0IHRlc3RTdG9yZS5jbG9zZSgpCiAgICAgICAgbG9nKCdTdG9yYWdlIGludGVncml0eSBjaGVjayBQQVNTRUQnKQogICAgICAgIHJldHVybiB0cnVlCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgbG9nKCdTdG9yYWdlIGludGVncml0eSBjaGVjayBGQUlMRUQ6JywgZS5tZXNzYWdlKQoKICAgICAgICAvLyBOb3RpZnkgdXNlcgogICAgICAgIGlmIChub3RpZnlVc2VyRXJyb3IpIHsKICAgICAgICAgICAgbm90aWZ5VXNlckVycm9yKAogICAgICAgICAgICAgICAgJ0RhdGEgQ29ycnVwdGlvbiBEZXRlY3RlZCcsCiAgICAgICAgICAgICAgICBgVGhlIGFwcCBkZXRlY3RlZCBjb3JydXB0ZWQgZGF0YSBhbmQgd2lsbCByZXNldC4gRXJyb3I6ICR7ZS5tZXNzYWdlfWAKICAgICAgICAgICAgKQogICAgICAgIH0KCiAgICAgICAgLy8gQ2xlYW4gdXAgY29ycnVwdGVkIHN0b3JhZ2Ugc3luY2hyb25vdXNseQogICAgICAgIGRlbGV0ZVN0b3JhZ2VTeW5jKCkKCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9Cn0KCi8vIENyZWF0ZSB2ZXJzaW9uIG1hcmtlciBmaWxlCmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVWZXJzaW9uTWFya2VyKCkgewogICAgaWYgKFZFUlNJT05fTUFSS0VSX0ZJTEUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKFZFUlNJT05fTUFSS0VSX0ZJTEUsIGB2Mjoke0RhdGUubm93KCl9YCkKICAgICAgICB9IGNhdGNoIChfZSkge30KICAgIH0KfQoKLy8gV3JpdGUgcmVzZXQgbWFya2VyIGZvciBpbmNvbXBsZXRlIHJlc2V0CmV4cG9ydCBmdW5jdGlvbiB3cml0ZVJlc2V0TWFya2VyKGVycm9yTWVzc2FnZSkgewogICAgdHJ5IHsKICAgICAgICBjb25zdCByZXNldE1hcmtlclBhdGggPSBiYXNlRGlyID8gam9pbihiYXNlRGlyLCAnLmxpc3RhLXJlc2V0LXBlbmRpbmcnKSA6IG51bGwKICAgICAgICBpZiAocmVzZXRNYXJrZXJQYXRoKSB7CiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMocmVzZXRNYXJrZXJQYXRoLCBgcmVzZXQtcmVxdWVzdGVkOiR7RGF0ZS5ub3coKX06JHtlcnJvck1lc3NhZ2V9YCkKICAgICAgICAgICAgbG9nKCdSZXNldCBtYXJrZXIgd3JpdHRlbiB0bzonLCByZXNldE1hcmtlclBhdGgpCiAgICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGxvZygnRmFpbGVkIHRvIHdyaXRlIHJlc2V0IG1hcmtlcjonLCBlKQogICAgfQogICAgcmV0dXJuIGZhbHNlCn0KLy8gVXRpbGl0eSBmdW5jdGlvbnMgLSBubyBkZXBlbmRlbmNpZXMgb24gb3RoZXIgbW9kdWxlcwoKaW1wb3J0IHsgcmFuZG9tQnl0ZXMgfSBmcm9tICdiYXJlLWNyeXB0bycKCi8vIENvbnNvbGUgbG9nZ2luZyAodXNlcyBzdGRlcnIgdG8gYXZvaWQgbWl4aW5nIHdpdGggc3Rkb3V0KQpleHBvcnQgZnVuY3Rpb24gbG9nKC4uLmFyZ3MpIHsKICAgIGNvbnNvbGUuZXJyb3IoLi4uYXJncykKfQoKLy8gQXN5bmMgZGVsYXkgdXRpbGl0eQpleHBvcnQgZnVuY3Rpb24gc2xlZXAobXMpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKQp9CgovLyBHZW5lcmF0ZSB1bmlxdWUgSUQgZm9yIGl0ZW1zCmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZUlkKCkgewogICAgcmV0dXJuIHJhbmRvbUJ5dGVzKDE2KS50b1N0cmluZygnaGV4JykKfQpjb25zdCB7IFB1bGwsIFB1c2gsIEhFQURFUkJZVEVTLCBLRVlCWVRFUywgQUJZVEVTIH0gPSByZXF1aXJlKCdzb2RpdW0tc2VjcmV0c3RyZWFtJykKY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCB7IER1cGxleCwgV3JpdGFibGUsIGdldFN0cmVhbUVycm9yIH0gPSByZXF1aXJlKCdzdHJlYW14JykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgVGltZW91dCA9IHJlcXVpcmUoJ3RpbWVvdXQtcmVmcmVzaCcpCmNvbnN0IHVuc2xhYiA9IHJlcXVpcmUoJ3Vuc2xhYicpCmNvbnN0IEJyaWRnZSA9IHJlcXVpcmUoJy4vbGliL2JyaWRnZScpCmNvbnN0IEhhbmRzaGFrZSA9IHJlcXVpcmUoJy4vbGliL2hhbmRzaGFrZScpCgpjb25zdCBJREhFQURFUkJZVEVTID0gSEVBREVSQllURVMgKyAzMgpjb25zdCBbTlNfSU5JVElBVE9SLCBOU19SRVNQT05ERVIsIE5TX1NFTkRdID0gY3J5cHRvLm5hbWVzcGFjZSgnaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtJywgMykKY29uc3QgTUFYX0FUT01JQ19XUklURSA9IDI1NiAqIDI1NiAqIDI1NiAtIDEKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgTm9pc2VTZWNyZXRTdHJlYW0gZXh0ZW5kcyBEdXBsZXggewogIGNvbnN0cnVjdG9yKGlzSW5pdGlhdG9yLCByYXdTdHJlYW0sIG9wdHMgPSB7fSkgewogICAgc3VwZXIoeyBtYXBXcml0YWJsZTogdG9CdWZmZXIgfSkKCiAgICBpZiAodHlwZW9mIGlzSW5pdGlhdG9yICE9PSAnYm9vbGVhbicpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdpc0luaXRpYXRvciBzaG91bGQgYmUgYSBib29sZWFuJykKICAgIH0KCiAgICB0aGlzLm5vaXNlU3RyZWFtID0gdGhpcwogICAgdGhpcy5pc0luaXRpYXRvciA9IGlzSW5pdGlhdG9yCiAgICB0aGlzLnJhd1N0cmVhbSA9IG51bGwKCiAgICB0aGlzLnB1YmxpY0tleSA9IG9wdHMucHVibGljS2V5IHx8IG51bGwKICAgIHRoaXMucmVtb3RlUHVibGljS2V5ID0gb3B0cy5yZW1vdGVQdWJsaWNLZXkgfHwgbnVsbAogICAgdGhpcy5oYW5kc2hha2VIYXNoID0gbnVsbAogICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZQogICAgdGhpcy5rZWVwQWxpdmUgPSBvcHRzLmtlZXBBbGl2ZSB8fCAwCiAgICB0aGlzLnRpbWVvdXQgPSAwCiAgICB0aGlzLmVuYWJsZVNlbmQgPSBvcHRzLmVuYWJsZVNlbmQgIT09IGZhbHNlCgogICAgLy8gcG9pbnRlciBmb3IgdXBzdHJlYW0gdG8gc2V0IGRhdGEgaGVyZSBpZiB0aGV5IHdhbnQKICAgIHRoaXMudXNlckRhdGEgPSBudWxsCgogICAgbGV0IG9wZW5lZERvbmUgPSBudWxsCiAgICB0aGlzLm9wZW5lZCA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgIG9wZW5lZERvbmUgPSByZXNvbHZlCiAgICB9KQoKICAgIHRoaXMucmF3Qnl0ZXNXcml0dGVuID0gMAogICAgdGhpcy5yYXdCeXRlc1JlYWQgPSAwCgogICAgLy8gbWV0YWRhdGEgdXNlZCBieSAnaHlwZXJkaHQnCiAgICB0aGlzLnJlbGF5ID0gbnVsbAogICAgdGhpcy5wdW5jaGVyID0gbnVsbAoKICAgIC8vIHVud3JhcHBlZCByYXcgc3RyZWFtCiAgICB0aGlzLl9yYXdTdHJlYW0gPSBudWxsCgogICAgLy8gaGFuZHNoYWtlIHN0YXRlCiAgICB0aGlzLl9oYW5kc2hha2UgPSBudWxsCiAgICB0aGlzLl9oYW5kc2hha2VQYXR0ZXJuID0gb3B0cy5wYXR0ZXJuIHx8IG51bGwKICAgIHRoaXMuX2hhbmRzaGFrZURvbmUgPSBudWxsCgogICAgLy8gbWVzc2FnZSBwYXJzaW5nIHN0YXRlCiAgICB0aGlzLl9zdGF0ZSA9IDAKICAgIHRoaXMuX2xlbiA9IDAKICAgIHRoaXMuX3RtcCA9IDEKICAgIHRoaXMuX21lc3NhZ2UgPSBudWxsCgogICAgdGhpcy5fb3BlbmVkRG9uZSA9IG9wZW5lZERvbmUKICAgIHRoaXMuX3N0YXJ0RG9uZSA9IG51bGwKICAgIHRoaXMuX2RyYWluRG9uZSA9IG51bGwKICAgIHRoaXMuX291dGdvaW5nUGxhaW4gPSBudWxsCiAgICB0aGlzLl9vdXRnb2luZ1dyYXBwZWQgPSBudWxsCiAgICB0aGlzLl91dHAgPSBudWxsCiAgICB0aGlzLl9zZXR1cCA9IHRydWUKICAgIHRoaXMuX2VuZGVkID0gMgogICAgdGhpcy5fZW5jcnlwdCA9IG51bGwKICAgIHRoaXMuX2RlY3J5cHQgPSBudWxsCiAgICB0aGlzLl90aW1lb3V0VGltZXIgPSBudWxsCiAgICB0aGlzLl9rZWVwQWxpdmVUaW1lciA9IG51bGwKICAgIHRoaXMuX3NlbmRTdGF0ZSA9IG51bGwKCiAgICBpZiAob3B0cy5hdXRvU3RhcnQgIT09IGZhbHNlKSB0aGlzLnN0YXJ0KHJhd1N0cmVhbSwgb3B0cykKCiAgICAvLyB3aWdnbGUgaXQgdG8gdHJpZ2dlciBvcGVuIGltbWVkaWF0ZWx5IChUT0RPIGFkZCBzdHJlYW14IG9wdGlvbiBmb3IgdGhpcykKICAgIHRoaXMucmVzdW1lKCkKICAgIHRoaXMucGF1c2UoKQogIH0KCiAgc3RhdGljIGtleVBhaXIoc2VlZCkgewogICAgcmV0dXJuIEhhbmRzaGFrZS5rZXlQYWlyKHNlZWQpCiAgfQoKICBzdGF0aWMgaWQoaGFuZHNoYWtlSGFzaCwgaXNJbml0aWF0b3IsIGlkKSB7CiAgICByZXR1cm4gc3RyZWFtSWQoaGFuZHNoYWtlSGFzaCwgaXNJbml0aWF0b3IsIGlkKQogIH0KCiAgc2V0VGltZW91dChtcykgewogICAgaWYgKCFtcykgbXMgPSAwCgogICAgdGhpcy5fY2xlYXJUaW1lb3V0KCkKICAgIHRoaXMudGltZW91dCA9IG1zCgogICAgaWYgKCFtcyB8fCB0aGlzLnJhd1N0cmVhbSA9PT0gbnVsbCkgcmV0dXJuCgogICAgdGhpcy5fdGltZW91dFRpbWVyID0gVGltZW91dC5vbmNlKG1zLCBkZXN0cm95VGltZW91dCwgdGhpcykKICAgIHRoaXMuX3RpbWVvdXRUaW1lci51bnJlZigpCiAgfQoKICBzZXRLZWVwQWxpdmUobXMpIHsKICAgIGlmICghbXMpIG1zID0gMAoKICAgIHRoaXMuX2NsZWFyS2VlcEFsaXZlKCkKCiAgICB0aGlzLmtlZXBBbGl2ZSA9IG1zCgogICAgaWYgKCFtcyB8fCB0aGlzLnJhd1N0cmVhbSA9PT0gbnVsbCkgcmV0dXJuCgogICAgdGhpcy5fa2VlcEFsaXZlVGltZXIgPSBUaW1lb3V0Lm9uKG1zLCBzZW5kS2VlcEFsaXZlLCB0aGlzKQogICAgdGhpcy5fa2VlcEFsaXZlVGltZXIudW5yZWYoKQogIH0KCiAgc2VuZEtlZXBBbGl2ZSgpIHsKICAgIGNvbnN0IGVtcHR5ID0gdGhpcy5hbGxvYygwKQogICAgdGhpcy53cml0ZShlbXB0eSkKICB9CgogIHN0YXJ0KHJhd1N0cmVhbSwgb3B0cyA9IHt9KSB7CiAgICBpZiAocmF3U3RyZWFtKSB7CiAgICAgIHRoaXMucmF3U3RyZWFtID0gcmF3U3RyZWFtCiAgICAgIHRoaXMuX3Jhd1N0cmVhbSA9IHJhd1N0cmVhbQogICAgICBpZiAodHlwZW9mIHRoaXMucmF3U3RyZWFtLnNldENvbnRlbnRTaXplID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhpcy5fdXRwID0gcmF3U3RyZWFtCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucmF3U3RyZWFtID0gbmV3IEJyaWRnZSh0aGlzKQogICAgICB0aGlzLl9yYXdTdHJlYW0gPSB0aGlzLnJhd1N0cmVhbS5yZXZlcnNlCiAgICB9CgogICAgdGhpcy5yYXdTdHJlYW0ub24oJ2Vycm9yJywgdGhpcy5fb25yYXdlcnJvci5iaW5kKHRoaXMpKQogICAgdGhpcy5yYXdTdHJlYW0ub24oJ2Nsb3NlJywgdGhpcy5fb25yYXdjbG9zZS5iaW5kKHRoaXMpKQoKICAgIHRoaXMuX3N0YXJ0SGFuZHNoYWtlKG9wdHMuaGFuZHNoYWtlLCBvcHRzLmtleVBhaXIgfHwgbnVsbCkKICAgIHRoaXMuX2NvbnRpbnVlT3BlbihudWxsKQoKICAgIGlmICh0aGlzLmRlc3Ryb3lpbmcpIHJldHVybgoKICAgIGlmIChvcHRzLmRhdGEpIHRoaXMuX29ucmF3ZGF0YShvcHRzLmRhdGEpCiAgICBpZiAob3B0cy5lbmRlZCkgdGhpcy5fb25yYXdlbmQoKQoKICAgIGlmICh0aGlzLmtlZXBBbGl2ZSA+IDAgJiYgdGhpcy5fa2VlcEFsaXZlVGltZXIgPT09IG51bGwpIHsKICAgICAgdGhpcy5zZXRLZWVwQWxpdmUodGhpcy5rZWVwQWxpdmUpCiAgICB9CgogICAgaWYgKHRoaXMudGltZW91dCA+IDAgJiYgdGhpcy5fdGltZW91dFRpbWVyID09PSBudWxsKSB7CiAgICAgIHRoaXMuc2V0VGltZW91dCh0aGlzLnRpbWVvdXQpCiAgICB9CiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGlmICgoYXdhaXQgdGhpcy5vcGVuZWQpID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlCiAgICBpZiAoKGF3YWl0IFdyaXRhYmxlLmRyYWluZWQodGhpcykpID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlCiAgICBpZiAodGhpcy5kZXN0cm95aW5nKSByZXR1cm4gZmFsc2UKCiAgICBpZiAodGhpcy5yYXdTdHJlYW0gIT09IG51bGwgJiYgdGhpcy5yYXdTdHJlYW0uZmx1c2gpIHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucmF3U3RyZWFtLmZsdXNoKCkKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX2NvbnRpbnVlT3BlbihlcnIpIHsKICAgIGlmIChlcnIpIHRoaXMuZGVzdHJveShlcnIpCiAgICBpZiAodGhpcy5fc3RhcnREb25lID09PSBudWxsKSByZXR1cm4KICAgIGNvbnN0IGRvbmUgPSB0aGlzLl9zdGFydERvbmUKICAgIHRoaXMuX3N0YXJ0RG9uZSA9IG51bGwKICAgIHRoaXMuX29wZW4oZG9uZSkKICB9CgogIF9vbmtleXBhaXJwcm9taXNlKHApIHsKICAgIGNvbnN0IHNlbGYgPSB0aGlzCiAgICBjb25zdCBjb250ID0gdGhpcy5fY29udGludWVPcGVuLmJpbmQodGhpcykKCiAgICBwLnRoZW4ob25rZXlwYWlyLCBjb250KQoKICAgIGZ1bmN0aW9uIG9ua2V5cGFpcihrcCkgewogICAgICBzZWxmLl9vbmtleXBhaXIoa3ApCiAgICAgIGNvbnQobnVsbCkKICAgIH0KICB9CgogIF9vbmtleXBhaXIoa2V5UGFpcikgewogICAgY29uc3QgcGF0dGVybiA9IHRoaXMuX2hhbmRzaGFrZVBhdHRlcm4gfHwgJ1hYJwogICAgY29uc3QgcmVtb3RlUHVibGljS2V5ID0gdGhpcy5yZW1vdGVQdWJsaWNLZXkKCiAgICB0aGlzLl9oYW5kc2hha2UgPSBuZXcgSGFuZHNoYWtlKHRoaXMuaXNJbml0aWF0b3IsIGtleVBhaXIsIHJlbW90ZVB1YmxpY0tleSwgcGF0dGVybikKICAgIHRoaXMucHVibGljS2V5ID0gdGhpcy5faGFuZHNoYWtlLmtleVBhaXIucHVibGljS2V5CiAgfQoKICBfc3RhcnRIYW5kc2hha2UoaGFuZHNoYWtlLCBrZXlQYWlyKSB7CiAgICBpZiAoaGFuZHNoYWtlKSB7CiAgICAgIGNvbnN0IHsgdHgsIHJ4LCBoYXNoLCBwdWJsaWNLZXksIHJlbW90ZVB1YmxpY0tleSB9ID0gaGFuZHNoYWtlCiAgICAgIHRoaXMuX3NldHVwU2VjcmV0U3RyZWFtKHR4LCByeCwgaGFzaCwgcHVibGljS2V5LCByZW1vdGVQdWJsaWNLZXkpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICgha2V5UGFpcikga2V5UGFpciA9IEhhbmRzaGFrZS5rZXlQYWlyKCkKCiAgICBpZiAodHlwZW9mIGtleVBhaXIudGhlbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICB0aGlzLl9vbmtleXBhaXJwcm9taXNlKGtleVBhaXIpCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9vbmtleXBhaXIoa2V5UGFpcikKICAgIH0KICB9CgogIF9vbnJhd2Vycm9yKGVycikgewogICAgdGhpcy5kZXN0cm95KGVycikKICB9CgogIF9vbnJhd2Nsb3NlKCkgewogICAgaWYgKHRoaXMuX2VuZGVkICE9PSAwKSB0aGlzLmRlc3Ryb3koKQogIH0KCiAgX29ucmF3ZGF0YShkYXRhKSB7CiAgICBsZXQgb2Zmc2V0ID0gMAoKICAgIGlmICh0aGlzLl90aW1lb3V0VGltZXIgIT09IG51bGwpIHsKICAgICAgdGhpcy5fdGltZW91dFRpbWVyLnJlZnJlc2goKQogICAgfQoKICAgIGRvIHsKICAgICAgc3dpdGNoICh0aGlzLl9zdGF0ZSkgewogICAgICAgIGNhc2UgMDogewogICAgICAgICAgd2hpbGUgKHRoaXMuX3RtcCAhPT0gMHgxMDAwMDAwICYmIG9mZnNldCA8IGRhdGEuYnl0ZUxlbmd0aCkgewogICAgICAgICAgICBjb25zdCB2ID0gZGF0YVtvZmZzZXQrK10KICAgICAgICAgICAgdGhpcy5fbGVuICs9IHRoaXMuX3RtcCAqIHYKICAgICAgICAgICAgdGhpcy5fdG1wICo9IDI1NgogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0aGlzLl90bXAgPT09IDB4MTAwMDAwMCkgewogICAgICAgICAgICB0aGlzLl90bXAgPSAwCiAgICAgICAgICAgIHRoaXMuX3N0YXRlID0gMQogICAgICAgICAgICBjb25zdCB1bnByb2Nlc3NlZCA9IGRhdGEuYnl0ZUxlbmd0aCAtIG9mZnNldAogICAgICAgICAgICBpZiAodW5wcm9jZXNzZWQgPCB0aGlzLl9sZW4gJiYgdGhpcy5fdXRwICE9PSBudWxsKQogICAgICAgICAgICAgIHRoaXMuX3V0cC5zZXRDb250ZW50U2l6ZSh0aGlzLl9sZW4gLSB1bnByb2Nlc3NlZCkKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhawogICAgICAgIH0KCiAgICAgICAgY2FzZSAxOiB7CiAgICAgICAgICBjb25zdCBtaXNzaW5nID0gdGhpcy5fbGVuIC0gdGhpcy5fdG1wCiAgICAgICAgICBjb25zdCBlbmQgPSBtaXNzaW5nICsgb2Zmc2V0CgogICAgICAgICAgaWYgKHRoaXMuX21lc3NhZ2UgPT09IG51bGwgJiYgZW5kIDw9IGRhdGEuYnl0ZUxlbmd0aCkgewogICAgICAgICAgICB0aGlzLl9tZXNzYWdlID0gZGF0YS5zdWJhcnJheShvZmZzZXQsIGVuZCkKICAgICAgICAgICAgb2Zmc2V0ICs9IG1pc3NpbmcKICAgICAgICAgICAgdGhpcy5faW5jb21pbmcoKQogICAgICAgICAgICBicmVhawogICAgICAgICAgfQoKICAgICAgICAgIGNvbnN0IHVucHJvY2Vzc2VkID0gZGF0YS5ieXRlTGVuZ3RoIC0gb2Zmc2V0CgogICAgICAgICAgaWYgKHRoaXMuX21lc3NhZ2UgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhpcy5fbWVzc2FnZSA9IGI0YS5hbGxvY1Vuc2FmZSh0aGlzLl9sZW4pCiAgICAgICAgICB9CgogICAgICAgICAgYjRhLmNvcHkoZGF0YSwgdGhpcy5fbWVzc2FnZSwgdGhpcy5fdG1wLCBvZmZzZXQpCiAgICAgICAgICB0aGlzLl90bXAgKz0gdW5wcm9jZXNzZWQKCiAgICAgICAgICBpZiAoZW5kIDw9IGRhdGEuYnl0ZUxlbmd0aCkgewogICAgICAgICAgICBvZmZzZXQgKz0gbWlzc2luZwogICAgICAgICAgICB0aGlzLl9pbmNvbWluZygpCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvZmZzZXQgKz0gdW5wcm9jZXNzZWQKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQogICAgfSB3aGlsZSAob2Zmc2V0IDwgZGF0YS5ieXRlTGVuZ3RoICYmICF0aGlzLmRlc3Ryb3lpbmcpCiAgfQoKICBfb25yYXdlbmQoKSB7CiAgICB0aGlzLl9lbmRlZC0tCiAgICB0aGlzLnB1c2gobnVsbCkKICB9CgogIF9vbnJhd2RyYWluKCkgewogICAgY29uc3QgZHJhaW4gPSB0aGlzLl9kcmFpbkRvbmUKICAgIGlmIChkcmFpbiA9PT0gbnVsbCkgcmV0dXJuCiAgICB0aGlzLl9kcmFpbkRvbmUgPSBudWxsCiAgICBkcmFpbigpCiAgfQoKICBfcmVhZChjYikgewogICAgdGhpcy5yYXdTdHJlYW0ucmVzdW1lKCkKICAgIGNiKG51bGwpCiAgfQoKICBfaW5jb21pbmcoKSB7CiAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5fbWVzc2FnZQoKICAgIHRoaXMuX3N0YXRlID0gMAogICAgdGhpcy5fbGVuID0gMAogICAgdGhpcy5fdG1wID0gMQogICAgdGhpcy5fbWVzc2FnZSA9IG51bGwKCiAgICBpZiAodGhpcy5fc2V0dXAgPT09IHRydWUpIHsKICAgICAgaWYgKHRoaXMuX2hhbmRzaGFrZSkgewogICAgICAgIHRoaXMuX29uaGFuZHNoYWtlcnQodGhpcy5faGFuZHNoYWtlLnJlY3YobWVzc2FnZSkpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKG1lc3NhZ2UuYnl0ZUxlbmd0aCAhPT0gSURIRUFERVJCWVRFUykgewogICAgICAgICAgdGhpcy5kZXN0cm95KG5ldyBFcnJvcignSW52YWxpZCBoZWFkZXIgbWVzc2FnZSByZWNlaXZlZCcpKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQoKICAgICAgICBjb25zdCByZW1vdGVJZCA9IG1lc3NhZ2Uuc3ViYXJyYXkoMCwgMzIpCiAgICAgICAgY29uc3QgZXhwZWN0ZWRJZCA9IHN0cmVhbUlkKHRoaXMuaGFuZHNoYWtlSGFzaCwgIXRoaXMuaXNJbml0aWF0b3IpCiAgICAgICAgY29uc3QgaGVhZGVyID0gbWVzc2FnZS5zdWJhcnJheSgzMikKCiAgICAgICAgaWYgKCFiNGEuZXF1YWxzKGV4cGVjdGVkSWQsIHJlbW90ZUlkKSkgewogICAgICAgICAgdGhpcy5kZXN0cm95KG5ldyBFcnJvcignSW52YWxpZCBoZWFkZXIgcmVjZWl2ZWQnKSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgdGhpcy5fZGVjcnlwdC5pbml0KGhlYWRlcikKICAgICAgICB0aGlzLl9zZXR1cCA9IGZhbHNlIC8vIHNldHVwIGlzIG5vdyBkb25lCiAgICAgIH0KICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKG1lc3NhZ2UuYnl0ZUxlbmd0aCA8IEFCWVRFUykgewogICAgICB0aGlzLmRlc3Ryb3kobmV3IEVycm9yKCdJbnZhbGlkIG1lc3NhZ2UgcmVjZWl2ZWQnKSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5yYXdCeXRlc1JlYWQgKz0gbWVzc2FnZS5ieXRlTGVuZ3RoCgogICAgY29uc3QgcGxhaW4gPSBtZXNzYWdlLnN1YmFycmF5KDEsIG1lc3NhZ2UuYnl0ZUxlbmd0aCAtIEFCWVRFUyArIDEpCgogICAgdHJ5IHsKICAgICAgdGhpcy5fZGVjcnlwdC5uZXh0KG1lc3NhZ2UsIHBsYWluKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuZGVzdHJveShlcnIpCiAgICAgIHJldHVybgogICAgfQoKICAgIC8vIElmIGtlZXAgYWxpdmUgaXMgc2VsZWN0aXZlLCBlYXQgdGhlIGVtcHR5IGJ1ZmZlcnMgKGllIGFzc3VtZSB0aGUgb3RoZXIgc2lkZSBoYXMgaXQgZW5hYmxlZCBhbHNvKQogICAgaWYgKHBsYWluLmJ5dGVMZW5ndGggPT09IDAgJiYgdGhpcy5rZWVwQWxpdmUgIT09IDApIHJldHVybgoKICAgIGlmICh0aGlzLnB1c2gocGxhaW4pID09PSBmYWxzZSkgewogICAgICB0aGlzLnJhd1N0cmVhbS5wYXVzZSgpCiAgICB9CiAgfQoKICBfb25oYW5kc2hha2VydChoKSB7CiAgICBpZiAodGhpcy5faGFuZHNoYWtlRG9uZSA9PT0gbnVsbCkgcmV0dXJuCgogICAgaWYgKGggIT09IG51bGwpIHsKICAgICAgaWYgKGguZGF0YSkgdGhpcy5fcmF3U3RyZWFtLndyaXRlKGguZGF0YSkKICAgICAgaWYgKCFoLnR4KSByZXR1cm4KICAgIH0KCiAgICBjb25zdCBkb25lID0gdGhpcy5faGFuZHNoYWtlRG9uZQogICAgY29uc3QgcHVibGljS2V5ID0gdGhpcy5faGFuZHNoYWtlLmtleVBhaXIucHVibGljS2V5CgogICAgdGhpcy5faGFuZHNoYWtlRG9uZSA9IG51bGwKICAgIHRoaXMuX2hhbmRzaGFrZSA9IG51bGwKCiAgICBpZiAoaCA9PT0gbnVsbCkgcmV0dXJuIGRvbmUobmV3IEVycm9yKCdOb2lzZSBoYW5kc2hha2UgZmFpbGVkJykpCgogICAgdGhpcy5fc2V0dXBTZWNyZXRTdHJlYW0oaC50eCwgaC5yeCwgaC5oYXNoLCBwdWJsaWNLZXksIGgucmVtb3RlUHVibGljS2V5KQogICAgdGhpcy5fcmVzb2x2ZU9wZW5lZCh0cnVlKQogICAgZG9uZShudWxsKQogIH0KCiAgX3NldHVwU2VjcmV0U3RyZWFtKHR4LCByeCwgaGFuZHNoYWtlSGFzaCwgcHVibGljS2V5LCByZW1vdGVQdWJsaWNLZXkpIHsKICAgIGNvbnN0IGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coMyArIElESEVBREVSQllURVMpCiAgICB3cml0ZVVpbnQyNGxlKElESEVBREVSQllURVMsIGJ1ZikKCiAgICB0aGlzLl9lbmNyeXB0ID0gbmV3IFB1c2godW5zbGFiKHR4LnN1YmFycmF5KDAsIEtFWUJZVEVTKSksIHVuZGVmaW5lZCwgYnVmLnN1YmFycmF5KDMgKyAzMikpCiAgICB0aGlzLl9kZWNyeXB0ID0gbmV3IFB1bGwodW5zbGFiKHJ4LnN1YmFycmF5KDAsIEtFWUJZVEVTKSkpCgogICAgdGhpcy5wdWJsaWNLZXkgPSBwdWJsaWNLZXkKICAgIHRoaXMucmVtb3RlUHVibGljS2V5ID0gcmVtb3RlUHVibGljS2V5CiAgICB0aGlzLmhhbmRzaGFrZUhhc2ggPSBoYW5kc2hha2VIYXNoCgogICAgY29uc3QgaWQgPSBidWYuc3ViYXJyYXkoMywgMyArIDMyKQogICAgc3RyZWFtSWQoaGFuZHNoYWtlSGFzaCwgdGhpcy5pc0luaXRpYXRvciwgaWQpCgogICAgLy8gaW5pdGlhbGl6ZSBzZWNyZXRib3ggc3RhdGUgZm9yIHVub3JkZXJlZCBtZXNzYWdlcwogICAgdGhpcy5fc2V0dXBTZWNyZXRTZW5kKGhhbmRzaGFrZUhhc2gpCgogICAgdGhpcy5lbWl0KCdoYW5kc2hha2UnKQogICAgLy8gaWYgcmF3U3RyZWFtIGlzIGEgYnJpZGdlLCBhbHNvIGVtaXQgaXQgdGhlcmUKICAgIGlmICh0aGlzLnJhd1N0cmVhbSAhPT0gdGhpcy5fcmF3U3RyZWFtKSB0aGlzLnJhd1N0cmVhbS5lbWl0KCdoYW5kc2hha2UnKQoKICAgIGlmICh0aGlzLmRlc3Ryb3lpbmcpIHJldHVybgoKICAgIHRoaXMuX3Jhd1N0cmVhbS53cml0ZShidWYpCiAgfQoKICBfc2V0dXBTZWNyZXRTZW5kKGhhbmRzaGFrZUhhc2gpIHsKICAgIHRoaXMuX3NlbmRTdGF0ZSA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coMzIgKyAzMiArIDggKyA4KQogICAgY29uc3QgZW5jcnlwdCA9IHRoaXMuX3NlbmRTdGF0ZS5zdWJhcnJheSgwLCAzMikgLy8gc2VjcmV0cwogICAgY29uc3QgZGVjcnlwdCA9IHRoaXMuX3NlbmRTdGF0ZS5zdWJhcnJheSgzMiwgNjQpCiAgICBjb25zdCBjb3VudGVyID0gdGhpcy5fc2VuZFN0YXRlLnN1YmFycmF5KDY0LCA3MikgLy8gbm9uY2UKICAgIGNvbnN0IGluaXRpYWwgPSB0aGlzLl9zZW5kU3RhdGUuc3ViYXJyYXkoNzIpCgogICAgY29uc3QgaW5wdXRzID0gdGhpcy5pc0luaXRpYXRvcgogICAgICA/IFsKICAgICAgICAgIFtOU19JTklUSUFUT1IsIE5TX1NFTkRdLAogICAgICAgICAgW05TX1JFU1BPTkRFUiwgTlNfU0VORF0KICAgICAgICBdCiAgICAgIDogWwogICAgICAgICAgW05TX1JFU1BPTkRFUiwgTlNfU0VORF0sCiAgICAgICAgICBbTlNfSU5JVElBVE9SLCBOU19TRU5EXQogICAgICAgIF0KCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKGVuY3J5cHQsIGlucHV0c1swXSwgaGFuZHNoYWtlSGFzaCkKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2goZGVjcnlwdCwgaW5wdXRzWzFdLCBoYW5kc2hha2VIYXNoKQoKICAgIHNvZGl1bS5yYW5kb21ieXRlc19idWYoaW5pdGlhbCkKICAgIGNvdW50ZXIuc2V0KGluaXRpYWwpCiAgfQoKICBfb3BlbihjYikgewogICAgLy8gbm8gYXV0b3N0YXJ0IG9yIG5vIGhhbmRzaGFrZSB5ZXQKICAgIGlmICh0aGlzLl9yYXdTdHJlYW0gPT09IG51bGwgfHwgKHRoaXMuX2hhbmRzaGFrZSA9PT0gbnVsbCAmJiB0aGlzLl9lbmNyeXB0ID09PSBudWxsKSkgewogICAgICB0aGlzLl9zdGFydERvbmUgPSBjYgogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLl9yYXdTdHJlYW0ub24oJ2RhdGEnLCB0aGlzLl9vbnJhd2RhdGEuYmluZCh0aGlzKSkKICAgIHRoaXMuX3Jhd1N0cmVhbS5vbignZW5kJywgdGhpcy5fb25yYXdlbmQuYmluZCh0aGlzKSkKICAgIHRoaXMuX3Jhd1N0cmVhbS5vbignZHJhaW4nLCB0aGlzLl9vbnJhd2RyYWluLmJpbmQodGhpcykpCgogICAgaWYgKHRoaXMuZW5hYmxlU2VuZCkgdGhpcy5fcmF3U3RyZWFtLm9uKCdtZXNzYWdlJywgdGhpcy5fb25tZXNzYWdlLmJpbmQodGhpcykpCgogICAgaWYgKHRoaXMuX2VuY3J5cHQgIT09IG51bGwpIHsKICAgICAgdGhpcy5fcmVzb2x2ZU9wZW5lZCh0cnVlKQogICAgICByZXR1cm4gY2IobnVsbCkKICAgIH0KCiAgICB0aGlzLl9oYW5kc2hha2VEb25lID0gY2IKCiAgICBpZiAodGhpcy5pc0luaXRpYXRvcikgdGhpcy5fb25oYW5kc2hha2VydCh0aGlzLl9oYW5kc2hha2Uuc2VuZCgpKQogIH0KCiAgX3ByZWRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5yYXdTdHJlYW0pIHsKICAgICAgY29uc3QgZXJyb3IgPSBnZXRTdHJlYW1FcnJvcih0aGlzKQogICAgICB0aGlzLnJhd1N0cmVhbS5kZXN0cm95KGVycm9yKQogICAgfQoKICAgIGlmICh0aGlzLl9zdGFydERvbmUgIT09IG51bGwpIHsKICAgICAgY29uc3QgZG9uZSA9IHRoaXMuX3N0YXJ0RG9uZQogICAgICB0aGlzLl9zdGFydERvbmUgPSBudWxsCiAgICAgIGRvbmUobmV3IEVycm9yKCdTdHJlYW0gZGVzdHJveWVkJykpCiAgICB9CgogICAgaWYgKHRoaXMuX2hhbmRzaGFrZURvbmUgIT09IG51bGwpIHsKICAgICAgY29uc3QgZG9uZSA9IHRoaXMuX2hhbmRzaGFrZURvbmUKICAgICAgdGhpcy5faGFuZHNoYWtlRG9uZSA9IG51bGwKICAgICAgZG9uZShuZXcgRXJyb3IoJ1N0cmVhbSBkZXN0cm95ZWQnKSkKICAgIH0KCiAgICBpZiAodGhpcy5fZHJhaW5Eb25lICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IGRvbmUgPSB0aGlzLl9kcmFpbkRvbmUKICAgICAgdGhpcy5fZHJhaW5Eb25lID0gbnVsbAogICAgICBkb25lKG5ldyBFcnJvcignU3RyZWFtIGRlc3Ryb3llZCcpKQogICAgfQogIH0KCiAgX3dyaXRlKGRhdGEsIGNiKSB7CiAgICBsZXQgd3JhcHBlZCA9IHRoaXMuX291dGdvaW5nV3JhcHBlZAoKICAgIGlmIChkYXRhICE9PSB0aGlzLl9vdXRnb2luZ1BsYWluKSB7CiAgICAgIHdyYXBwZWQgPSBiNGEuYWxsb2NVbnNhZmUoZGF0YS5ieXRlTGVuZ3RoICsgMyArIEFCWVRFUykKICAgICAgd3JhcHBlZC5zZXQoZGF0YSwgNCkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX291dGdvaW5nV3JhcHBlZCA9IHRoaXMuX291dGdvaW5nUGxhaW4gPSBudWxsCiAgICB9CgogICAgaWYgKHdyYXBwZWQuYnl0ZUxlbmd0aCAtIDMgPiBNQVhfQVRPTUlDX1dSSVRFKSB7CiAgICAgIHJldHVybiBjYigKICAgICAgICBuZXcgRXJyb3IoCiAgICAgICAgICAnTWVzc2FnZSBpcyB0b28gbGFyZ2UgZm9yIGFuIGF0b21pYyB3cml0ZS4gTWF4IHNpemUgaXMgJyArIE1BWF9BVE9NSUNfV1JJVEUgKyAnIGJ5dGVzLicKICAgICAgICApCiAgICAgICkKICAgIH0KICAgIHRoaXMucmF3Qnl0ZXNXcml0dGVuICs9IHdyYXBwZWQuYnl0ZUxlbmd0aAoKICAgIHdyaXRlVWludDI0bGUod3JhcHBlZC5ieXRlTGVuZ3RoIC0gMywgd3JhcHBlZCkKICAgIC8vIG9mZnNldCA0IHNvIHdlIGNhbiBkbyBpdCBpbi1wbGFjZQogICAgdGhpcy5fZW5jcnlwdC5uZXh0KHdyYXBwZWQuc3ViYXJyYXkoNCwgNCArIGRhdGEuYnl0ZUxlbmd0aCksIHdyYXBwZWQuc3ViYXJyYXkoMykpCgogICAgaWYgKHRoaXMuX2tlZXBBbGl2ZVRpbWVyICE9PSBudWxsKSB0aGlzLl9rZWVwQWxpdmVUaW1lci5yZWZyZXNoKCkKCiAgICBpZiAodGhpcy5fcmF3U3RyZWFtLndyaXRlKHdyYXBwZWQpID09PSBmYWxzZSkgewogICAgICB0aGlzLl9kcmFpbkRvbmUgPSBjYgogICAgfSBlbHNlIHsKICAgICAgY2IobnVsbCkKICAgIH0KICB9CgogIF9maW5hbChjYikgewogICAgdGhpcy5fY2xlYXJLZWVwQWxpdmUoKQogICAgdGhpcy5fZW5kZWQtLQogICAgdGhpcy5fcmF3U3RyZWFtLmVuZCgpCiAgICBjYihudWxsKQogIH0KCiAgX3Jlc29sdmVPcGVuZWQodmFsKSB7CiAgICBpZiAodGhpcy5fb3BlbmVkRG9uZSA9PT0gbnVsbCkgcmV0dXJuCiAgICBjb25zdCBvcGVuZWQgPSB0aGlzLl9vcGVuZWREb25lCiAgICB0aGlzLl9vcGVuZWREb25lID0gbnVsbAogICAgb3BlbmVkKHZhbCkKICAgIGlmICghdmFsKSByZXR1cm4KICAgIHRoaXMuY29ubmVjdGVkID0gdHJ1ZQogICAgdGhpcy5lbWl0KCdjb25uZWN0JykKICB9CgogIF9jbGVhclRpbWVvdXQoKSB7CiAgICBpZiAodGhpcy5fdGltZW91dFRpbWVyID09PSBudWxsKSByZXR1cm4KICAgIHRoaXMuX3RpbWVvdXRUaW1lci5kZXN0cm95KCkKICAgIHRoaXMuX3RpbWVvdXRUaW1lciA9IG51bGwKICAgIHRoaXMudGltZW91dCA9IDAKICB9CgogIF9jbGVhcktlZXBBbGl2ZSgpIHsKICAgIGlmICh0aGlzLl9rZWVwQWxpdmVUaW1lciA9PT0gbnVsbCkgcmV0dXJuCiAgICB0aGlzLl9rZWVwQWxpdmVUaW1lci5kZXN0cm95KCkKICAgIHRoaXMuX2tlZXBBbGl2ZVRpbWVyID0gbnVsbAogICAgdGhpcy5rZWVwQWxpdmUgPSAwCiAgfQoKICBfZGVzdHJveShjYikgewogICAgdGhpcy5fY2xlYXJLZWVwQWxpdmUoKQogICAgdGhpcy5fY2xlYXJUaW1lb3V0KCkKICAgIHRoaXMuX3Jlc29sdmVPcGVuZWQoZmFsc2UpCiAgICBjYihudWxsKQogIH0KCiAgX2JveE1lc3NhZ2UoYnVmZmVyKSB7CiAgICBjb25zdCBNQiA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0Ym94X01BQ0JZVEVTIC8vIDE2CiAgICBjb25zdCBOQiA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0Ym94X05PTkNFQllURVMgLy8gMjQKCiAgICBjb25zdCBjb3VudGVyID0gdGhpcy5fc2VuZFN0YXRlLnN1YmFycmF5KDY0LCA3MikKICAgIHNvZGl1bS5zb2RpdW1faW5jcmVtZW50KGNvdW50ZXIpCiAgICBpZiAoYjRhLmVxdWFscyhjb3VudGVyLCB0aGlzLl9zZW5kU3RhdGUuc3ViYXJyYXkoNzIpKSkgewogICAgICB0aGlzLmRlc3Ryb3kobmV3IEVycm9yKCd1ZHAgc2VuZCBub25jZSBleGNoYXVzdGVkJykpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IHNlY3JldCA9IHRoaXMuX3NlbmRTdGF0ZS5zdWJhcnJheSgwLCAzMikKICAgIGNvbnN0IGVudmVsb3BlID0gYjRhLmFsbG9jVW5zYWZlKDggKyBNQiArIGJ1ZmZlci5ieXRlTGVuZ3RoKQogICAgY29uc3Qgbm9uY2UgPSBlbnZlbG9wZS5zdWJhcnJheSgwLCBOQikKICAgIGNvbnN0IGNpcGhlcnRleHQgPSBlbnZlbG9wZS5zdWJhcnJheSg4KQoKICAgIGI0YS5maWxsKG5vbmNlLCAwKSAvLyBwYWQgc3VmZml4CiAgICBub25jZS5zZXQoY291bnRlcikKCiAgICBzb2RpdW0uY3J5cHRvX3NlY3JldGJveF9lYXN5KGNpcGhlcnRleHQsIGJ1ZmZlciwgbm9uY2UsIHNlY3JldCkKICAgIHJldHVybiBlbnZlbG9wZQogIH0KCiAgc2VuZChidWZmZXIpIHsKICAgIGlmICghdGhpcy5fc2VuZFN0YXRlKSByZXR1cm4KICAgIGlmICghdGhpcy5yYXdTdHJlYW0/LnNlbmQpIHJldHVybiAvLyB1ZHgtc3RyZWFtIGV4cGVjdGVkCgogICAgY29uc3QgbWVzc2FnZSA9IHRoaXMuX2JveE1lc3NhZ2UoYnVmZmVyKQogICAgcmV0dXJuIHRoaXMucmF3U3RyZWFtLnNlbmQobWVzc2FnZSkKICB9CgogIHRyeVNlbmQoYnVmZmVyKSB7CiAgICBpZiAoIXRoaXMuX3NlbmRTdGF0ZSkgcmV0dXJuCiAgICBpZiAoIXRoaXMucmF3U3RyZWFtPy50cnlTZW5kKSByZXR1cm4gLy8gdWR4LXN0cmVhbSBleHBlY3RlZAoKICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLl9ib3hNZXNzYWdlKGJ1ZmZlcikKICAgIHRoaXMucmF3U3RyZWFtLnRyeVNlbmQobWVzc2FnZSkKICB9CgogIF9vbm1lc3NhZ2UoYnVmZmVyKSB7CiAgICBpZiAoIXRoaXMuX3NlbmRTdGF0ZSkgcmV0dXJuIC8vIG1lc3NhZ2VzIGJlZm9yZSBoYW5kc2hha2UgYXJlIGRyb3BwZWQKCiAgICBjb25zdCBNQiA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0Ym94X01BQ0JZVEVTIC8vIDE2CiAgICBjb25zdCBOQiA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0Ym94X05PTkNFQllURVMgLy8gMjQKCiAgICBpZiAoYnVmZmVyLmJ5dGVMZW5ndGggPCBOQikgcmV0dXJuIC8vIEludmFsaWQgbWVzc2FnZQoKICAgIGNvbnN0IG5vbmNlID0gYjRhLmFsbG9jVW5zYWZlKE5CKQogICAgYjRhLmZpbGwobm9uY2UsIDApCiAgICBub25jZS5zZXQoYnVmZmVyLnN1YmFycmF5KDAsIDgpKQoKICAgIGNvbnN0IHNlY3JldCA9IHRoaXMuX3NlbmRTdGF0ZS5zdWJhcnJheSgzMiwgNjQpCiAgICBjb25zdCBjaXBoZXJ0ZXh0ID0gYnVmZmVyLnN1YmFycmF5KDgpCiAgICBjb25zdCBwbGFpbiA9IGJ1ZmZlci5zdWJhcnJheSg4LCBidWZmZXIuYnl0ZUxlbmd0aCAtIE1CKQoKICAgIGlmIChjaXBoZXJ0ZXh0LmJ5dGVMZW5ndGggPCBNQikgcmV0dXJuIC8vIGludmFsaWQgbWVzc2FnZQoKICAgIGNvbnN0IHN1Y2Nlc3MgPSBzb2RpdW0uY3J5cHRvX3NlY3JldGJveF9vcGVuX2Vhc3kocGxhaW4sIGNpcGhlcnRleHQsIG5vbmNlLCBzZWNyZXQpCgogICAgaWYgKHN1Y2Nlc3MpIHRoaXMuZW1pdCgnbWVzc2FnZScsIHBsYWluKQogIH0KCiAgYWxsb2MobGVuKSB7CiAgICBjb25zdCBidWYgPSBiNGEuYWxsb2NVbnNhZmUobGVuICsgMyArIEFCWVRFUykKICAgIHRoaXMuX291dGdvaW5nV3JhcHBlZCA9IGJ1ZgogICAgdGhpcy5fb3V0Z29pbmdQbGFpbiA9IGJ1Zi5zdWJhcnJheSg0LCBidWYuYnl0ZUxlbmd0aCAtIEFCWVRFUyArIDEpCiAgICByZXR1cm4gdGhpcy5fb3V0Z29pbmdQbGFpbgogIH0KCiAgdG9KU09OKCkgewogICAgcmV0dXJuIHsKICAgICAgaXNJbml0aWF0b3I6IHRoaXMuaXNJbml0aWF0b3IsCiAgICAgIHB1YmxpY0tleTogdGhpcy5wdWJsaWNLZXkgJiYgYjRhLnRvU3RyaW5nKHRoaXMucHVibGljS2V5LCAnaGV4JyksCiAgICAgIHJlbW90ZVB1YmxpY0tleTogdGhpcy5yZW1vdGVQdWJsaWNLZXkgJiYgYjRhLnRvU3RyaW5nKHRoaXMucmVtb3RlUHVibGljS2V5LCAnaGV4JyksCiAgICAgIGNvbm5lY3RlZDogdGhpcy5jb25uZWN0ZWQsCiAgICAgIGRlc3Ryb3lpbmc6IHRoaXMuZGVzdHJveWluZywKICAgICAgZGVzdHJveWVkOiB0aGlzLmRlc3Ryb3llZCwKICAgICAgcmF3U3RyZWFtOiB0aGlzLnJhd1N0cmVhbSAmJiB0aGlzLnJhd1N0cmVhbS50b0pTT04gPyB0aGlzLnJhd1N0cmVhbS50b0pTT04oKSA6IG51bGwKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHdyaXRlVWludDI0bGUobiwgYnVmKSB7CiAgYnVmWzBdID0gbiAmIDI1NQogIGJ1ZlsxXSA9IChuID4+PiA4KSAmIDI1NQogIGJ1ZlsyXSA9IChuID4+PiAxNikgJiAyNTUKfQoKZnVuY3Rpb24gc3RyZWFtSWQoaGFuZHNoYWtlSGFzaCwgaXNJbml0aWF0b3IsIG91dCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikpIHsKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKG91dCwgaXNJbml0aWF0b3IgPyBOU19JTklUSUFUT1IgOiBOU19SRVNQT05ERVIsIGhhbmRzaGFrZUhhc2gpCiAgcmV0dXJuIG91dAp9CgpmdW5jdGlvbiB0b0J1ZmZlcihkYXRhKSB7CiAgcmV0dXJuIHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJyA/IGI0YS5mcm9tKGRhdGEpIDogZGF0YQp9CgpmdW5jdGlvbiBkZXN0cm95VGltZW91dCgpIHsKICB0aGlzLmRlc3Ryb3kobmV3IEVycm9yKCdTdHJlYW0gdGltZWQgb3V0JykpCn0KCmZ1bmN0aW9uIHNlbmRLZWVwQWxpdmUoKSB7CiAgY29uc3QgZW1wdHkgPSB0aGlzLmFsbG9jKDApCiAgdGhpcy53cml0ZShlbXB0eSkKfQpjb25zdCB7IER1cGxleCwgV3JpdGFibGUgfSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQoKY2xhc3MgUmV2ZXJzZVBhc3NUaHJvdWdoIGV4dGVuZHMgRHVwbGV4IHsKICBjb25zdHJ1Y3RvcihzKSB7CiAgICBzdXBlcigpCiAgICB0aGlzLl9zdHJlYW0gPSBzCiAgICB0aGlzLl9vbmRyYWluID0gbnVsbAogIH0KCiAgX3dyaXRlKGRhdGEsIGNiKSB7CiAgICBpZiAodGhpcy5fc3RyZWFtLnB1c2goZGF0YSkgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMuX3N0cmVhbS5fb25kcmFpbiA9IGNiCiAgICB9IGVsc2UgewogICAgICBjYihudWxsKQogICAgfQogIH0KCiAgX2ZpbmFsKGNiKSB7CiAgICB0aGlzLl9zdHJlYW0ucHVzaChudWxsKQogICAgY2IobnVsbCkKICB9CgogIF9yZWFkKGNiKSB7CiAgICBjb25zdCBvbmRyYWluID0gdGhpcy5fb25kcmFpbgogICAgdGhpcy5fb25kcmFpbiA9IG51bGwKICAgIGlmIChvbmRyYWluKSBvbmRyYWluKCkKICAgIGNiKG51bGwpCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEJyaWRnZSBleHRlbmRzIER1cGxleCB7CiAgY29uc3RydWN0b3Iobm9pc2VTdHJlYW0pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLm5vaXNlU3RyZWFtID0gbm9pc2VTdHJlYW0KCiAgICB0aGlzLl9vbmRyYWluID0gbnVsbAogICAgdGhpcy5yZXZlcnNlID0gbmV3IFJldmVyc2VQYXNzVGhyb3VnaCh0aGlzKQogIH0KCiAgZ2V0IHB1YmxpY0tleSgpIHsKICAgIHJldHVybiB0aGlzLm5vaXNlU3RyZWFtLnB1YmxpY0tleQogIH0KCiAgZ2V0IHJlbW90ZVB1YmxpY0tleSgpIHsKICAgIHJldHVybiB0aGlzLm5vaXNlU3RyZWFtLnJlbW90ZVB1YmxpY0tleQogIH0KCiAgZ2V0IGhhbmRzaGFrZUhhc2goKSB7CiAgICByZXR1cm4gdGhpcy5ub2lzZVN0cmVhbS5oYW5kc2hha2VIYXNoCiAgfQoKICBmbHVzaCgpIHsKICAgIHJldHVybiBXcml0YWJsZS5kcmFpbmVkKHRoaXMpCiAgfQoKICBfcmVhZChjYikgewogICAgY29uc3Qgb25kcmFpbiA9IHRoaXMuX29uZHJhaW4KICAgIHRoaXMuX29uZHJhaW4gPSBudWxsCiAgICBpZiAob25kcmFpbikgb25kcmFpbigpCiAgICBjYihudWxsKQogIH0KCiAgX3dyaXRlKGRhdGEsIGNiKSB7CiAgICBpZiAodGhpcy5yZXZlcnNlLnB1c2goZGF0YSkgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMucmV2ZXJzZS5fb25kcmFpbiA9IGNiCiAgICB9IGVsc2UgewogICAgICBjYihudWxsKQogICAgfQogIH0KCiAgX2ZpbmFsKGNiKSB7CiAgICB0aGlzLnJldmVyc2UucHVzaChudWxsKQogICAgY2IobnVsbCkKICB9Cn0KY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGN1cnZlID0gcmVxdWlyZSgnbm9pc2UtY3VydmUtZWQnKQpjb25zdCBOb2lzZSA9IHJlcXVpcmUoJ25vaXNlLWhhbmRzaGFrZScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBFTVBUWSA9IGI0YS5hbGxvYygwKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBIYW5kc2hha2UgewogIGNvbnN0cnVjdG9yKGlzSW5pdGlhdG9yLCBrZXlQYWlyLCByZW1vdGVQdWJsaWNLZXksIHBhdHRlcm4pIHsKICAgIHRoaXMuaXNJbml0aWF0b3IgPSBpc0luaXRpYXRvcgogICAgdGhpcy5rZXlQYWlyID0ga2V5UGFpcgogICAgdGhpcy5ub2lzZSA9IG5ldyBOb2lzZShwYXR0ZXJuLCBpc0luaXRpYXRvciwga2V5UGFpciwgeyBjdXJ2ZSB9KQogICAgdGhpcy5ub2lzZS5pbml0aWFsaXNlKEVNUFRZLCByZW1vdGVQdWJsaWNLZXkpCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCiAgfQoKICBzdGF0aWMga2V5UGFpcihzZWVkKSB7CiAgICBjb25zdCBwdWJsaWNLZXkgPSBiNGEuYWxsb2MoMzIpCiAgICBjb25zdCBzZWNyZXRLZXkgPSBiNGEuYWxsb2MoNjQpCiAgICBpZiAoc2VlZCkgc29kaXVtLmNyeXB0b19zaWduX3NlZWRfa2V5cGFpcihwdWJsaWNLZXksIHNlY3JldEtleSwgc2VlZCkKICAgIGVsc2Ugc29kaXVtLmNyeXB0b19zaWduX2tleXBhaXIocHVibGljS2V5LCBzZWNyZXRLZXkpCiAgICByZXR1cm4geyBwdWJsaWNLZXksIHNlY3JldEtleSB9CiAgfQoKICByZWN2KGRhdGEpIHsKICAgIHRyeSB7CiAgICAgIHRoaXMubm9pc2UucmVjdihkYXRhKQogICAgICBpZiAodGhpcy5ub2lzZS5jb21wbGV0ZSkgcmV0dXJuIHRoaXMuX3JldHVybihudWxsKQogICAgICByZXR1cm4gdGhpcy5zZW5kKCkKICAgIH0gY2F0Y2ggewogICAgICB0aGlzLmRlc3Ryb3koKQogICAgICByZXR1cm4gbnVsbAogICAgfQogIH0KCiAgLy8gbm90ZSB0aGF0IHRoZSBkYXRhIHJldHVybmVkIGhlcmUgaXMgZnJhbWVkIHNvIHdlIGRvbid0IGhhdmUgdG8gZG8gYW4gZXh0cmEgY29weQogIC8vIHdoZW4gc2VuZGluZyBpdC4uLgogIHNlbmQoKSB7CiAgICB0cnkgewogICAgICBjb25zdCBkYXRhID0gdGhpcy5ub2lzZS5zZW5kKCkKICAgICAgY29uc3Qgd3JhcCA9IGI0YS5hbGxvY1Vuc2FmZShkYXRhLmJ5dGVMZW5ndGggKyAzKQoKICAgICAgd3JpdGVVaW50MjRsZShkYXRhLmJ5dGVMZW5ndGgsIHdyYXApCiAgICAgIHdyYXAuc2V0KGRhdGEsIDMpCgogICAgICByZXR1cm4gdGhpcy5fcmV0dXJuKHdyYXApCiAgICB9IGNhdGNoIHsKICAgICAgdGhpcy5kZXN0cm95KCkKICAgICAgcmV0dXJuIG51bGwKICAgIH0KICB9CgogIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCiAgfQoKICBfcmV0dXJuKGRhdGEpIHsKICAgIGNvbnN0IHR4ID0gdGhpcy5ub2lzZS5jb21wbGV0ZSA/IGI0YS50b0J1ZmZlcih0aGlzLm5vaXNlLnR4KSA6IG51bGwKICAgIGNvbnN0IHJ4ID0gdGhpcy5ub2lzZS5jb21wbGV0ZSA/IGI0YS50b0J1ZmZlcih0aGlzLm5vaXNlLnJ4KSA6IG51bGwKICAgIGNvbnN0IGhhc2ggPSB0aGlzLm5vaXNlLmNvbXBsZXRlID8gYjRhLnRvQnVmZmVyKHRoaXMubm9pc2UuaGFzaCkgOiBudWxsCiAgICBjb25zdCByZW1vdGVQdWJsaWNLZXkgPSB0aGlzLm5vaXNlLmNvbXBsZXRlID8gYjRhLnRvQnVmZmVyKHRoaXMubm9pc2UucnMpIDogbnVsbAoKICAgIHJldHVybiB7CiAgICAgIGRhdGEsCiAgICAgIHJlbW90ZVB1YmxpY0tleSwKICAgICAgaGFzaCwKICAgICAgdHgsCiAgICAgIHJ4CiAgICB9CiAgfQp9CgpmdW5jdGlvbiB3cml0ZVVpbnQyNGxlKG4sIGJ1ZikgewogIGJ1ZlswXSA9IG4gJiAyNTUKICBidWZbMV0gPSAobiA+Pj4gOCkgJiAyNTUKICBidWZbMl0gPSAobiA+Pj4gMTYpICYgMjU1Cn0KewogICJuYW1lIjogIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iLAogICJ2ZXJzaW9uIjogIjYuOS4xIiwKICAiZGVzY3JpcHRpb24iOiAiU2VjcmV0IHN0cmVhbSBiYWNrZWQgYnkgTm9pc2UgYW5kIGxpYnNvZGl1bSdzIHNlY3JldHN0cmVhbSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibGliLyoqLmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuMS4wIiwKICAgICJoeXBlcmNvcmUtY3J5cHRvIjogIl4zLjMuMSIsCiAgICAibm9pc2UtY3VydmUtZWQiOiAiXjIuMC4xIiwKICAgICJub2lzZS1oYW5kc2hha2UiOiAiXjQuMC4wIiwKICAgICJzb2RpdW0tc2VjcmV0c3RyZWFtIjogIl4xLjEuMCIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjAiLAogICAgInN0cmVhbXgiOiAiXjIuMTQuMCIsCiAgICAidGltZW91dC1yZWZyZXNoIjogIl4yLjAuMCIsCiAgICAidW5zbGFiIjogIl4xLjMuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4zLjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiLAogICAgInVkeC1uYXRpdmUiOiAiXjEuMTMuMiIKICB9LAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuIiwKICAgICJ0ZXN0IjogImJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyc3dhcm0tc2VjcmV0LXN0cmVhbS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJzd2FybS1zZWNyZXQtc3RyZWFtL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJzd2FybS1zZWNyZXQtc3RyZWFtIgp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgSW5kZXhFbmNvZGVyID0gcmVxdWlyZSgnaW5kZXgtZW5jb2RlcicpCgpjb25zdCBDaGVja291dCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGtleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IENsb2NrID0gYy5hcnJheShDaGVja291dCkKCmNvbnN0IEluZGV4Q2hlY2twb2ludCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQ2NC5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQ2NC5lbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHNpZ25hdHVyZTogYy5maXhlZDY0LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IEtleVYwID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ua2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBrZXk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IC0xCiAgICB9CiAgfQp9Cgpjb25zdCBLZXlzVjAgPSBjLmFycmF5KEtleVYwKQoKY29uc3QgV2FrZXVwVjAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCAwKSAvLyB2ZXJzaW9uCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnR5cGUpCgogICAgaWYgKG0udHlwZSA9PT0gMSkgewogICAgICBLZXlzVjAucHJlZW5jb2RlKHN0YXRlLCBtLndyaXRlcnMpCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApIC8vIHZlcnNpb24KICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udHlwZSkKCiAgICBpZiAobS50eXBlID09PSAxKSB7CiAgICAgIEtleXNWMC5lbmNvZGUoc3RhdGUsIG0ud3JpdGVycykKICAgIH0KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgdiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAodiAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uOiAnICsgdikKCiAgICBjb25zdCB0eXBlID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IG0gPSB7IHZlcnNpb246IDAsIHR5cGUsIHdyaXRlcnM6IG51bGwgfQoKICAgIGlmIChtLnR5cGUgPT09IDEpIHsKICAgICAgbS53cml0ZXJzID0gS2V5c1YwLmRlY29kZShzdGF0ZSkKICAgIH0KCiAgICByZXR1cm4gbQogIH0KfQoKY29uc3QgV2FrZXVwID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgaWYgKG0udmVyc2lvbiA9PT0gMCkgcmV0dXJuIFdha2V1cFYwLnByZWVuY29kZShzdGF0ZSwgbSkKCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCAxKSAvLyB2ZXJzaW9uCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnR5cGUpCgogICAgaWYgKG0udHlwZSA9PT0gMSkgewogICAgICBDbG9jay5wcmVlbmNvZGUoc3RhdGUsIG0ud3JpdGVycykKICAgIH0KICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgaWYgKG0udmVyc2lvbiA9PT0gMCkgcmV0dXJuIFdha2V1cFYwLmVuY29kZShzdGF0ZSwgbSkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKSAvLyB2ZXJzaW9uCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnR5cGUpCgogICAgaWYgKG0udHlwZSA9PT0gMSkgewogICAgICBDbG9jay5lbmNvZGUoc3RhdGUsIG0ud3JpdGVycykKICAgIH0KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogICAgY29uc3QgdiA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgaWYgKHYgPiAxKSB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb246ICcgKyB2KQoKICAgIGlmICh2ID09PSAwKSB7CiAgICAgIHN0YXRlLnN0YXJ0ID0gc3RhcnQKICAgICAgcmV0dXJuIFdha2V1cFYwLmRlY29kZShzdGF0ZSkKICAgIH0KCiAgICBjb25zdCB0eXBlID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IG0gPSB7IHZlcnNpb246IDEsIHR5cGUsIHdyaXRlcnM6IG51bGwgfQoKICAgIGlmIChtLnR5cGUgPT09IDEpIHsKICAgICAgbS53cml0ZXJzID0gQ2xvY2suZGVjb2RlKHN0YXRlKQogICAgfQoKICAgIHJldHVybiBtCiAgfQp9Cgpjb25zdCBCb290UmVjb3JkVjAgPSB7CiAgcHJlZW5jb2RlKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCd2ZXJzaW9uIDAgcmVjb3JkcyBjYW5ub3QgYmUgZW5jb2RlZCcpCiAgfSwKICBlbmNvZGUoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ3ZlcnNpb24gMCByZWNvcmRzIGNhbm5vdCBiZSBlbmNvZGVkJykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgaW5kZXhlZCA9IENoZWNrb3V0LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGhlYWRzID0gQ2xvY2suZGVjb2RlKHN0YXRlKQoKICAgIC8vIG9uZSBjYXVzZSBpbml0aWFsIHJlY292ZXIgaXMgbm90IGZmIHJlY292ZXJ5CiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiAwLAogICAgICBrZXk6IGluZGV4ZWQua2V5LAogICAgICBzeXN0ZW1MZW5ndGg6IGluZGV4ZWQubGVuZ3RoLAogICAgICBpbmRleGVyc1VwZGF0ZWQ6IGZhbHNlLAogICAgICBmYXN0Rm9yd2FyZGluZzogZmFsc2UsCiAgICAgIHJlY292ZXJpZXM6IDEsCiAgICAgIG1pZ3JhdGluZzogZmFsc2UsCiAgICAgIGhlYWRzCiAgICB9CiAgfQp9Cgpjb25zdCBDaGVja3BvaW50ZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBpZHgpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGlkeC5jaGVja3BvaW50ZXIpCiAgICBpZiAoaWR4LmNoZWNrcG9pbnQgIT09IG51bGwpIEluZGV4Q2hlY2twb2ludC5wcmVlbmNvZGUoc3RhdGUsIGlkeC5jaGVja3BvaW50KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBpZHgpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGlkeC5jaGVja3BvaW50ZXIpCiAgICBpZiAoaWR4LmNoZWNrcG9pbnQgIT09IG51bGwpIEluZGV4Q2hlY2twb2ludC5lbmNvZGUoc3RhdGUsIGlkeC5jaGVja3BvaW50KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBjaGVja3BvaW50ZXIgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgY2hlY2twb2ludCA9IGNoZWNrcG9pbnRlciA/IG51bGwgOiBJbmRleENoZWNrcG9pbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGNoZWNrcG9pbnRlciwKICAgICAgY2hlY2twb2ludAogICAgfQogIH0KfQoKY29uc3QgQ2hlY2twb2ludGVyQXJyYXkgPSBjLmFycmF5KENoZWNrcG9pbnRlcikKCmNvbnN0IEluZGV4ZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ubmFtZXNwYWNlKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc2lnbmF0dXJlOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbmFtZXNwYWNlOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgcHVibGljS2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgSW5kZXhlcnMgPSBjLmFycmF5KEluZGV4ZXIpCgpjb25zdCBEaWdlc3RWMCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucG9pbnRlcikKICAgIGlmIChtLnBvaW50ZXIgPT09IDApIHsKICAgICAgSW5kZXhlcnMucHJlZW5jb2RlKHN0YXRlLCBtLmluZGV4ZXJzKQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnBvaW50ZXIpCiAgICBpZiAobS5wb2ludGVyID09PSAwKSB7CiAgICAgIEluZGV4ZXJzLmVuY29kZShzdGF0ZSwgbS5pbmRleGVycykKICAgIH0KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcG9pbnRlciA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBwb2ludGVyLAogICAgICBpbmRleGVyczogcG9pbnRlciA9PT0gMCA/IEluZGV4ZXJzLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBEaWdlc3QgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnBvaW50ZXIpCiAgICBpZiAobS5wb2ludGVyID09PSAwKSB7CiAgICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnBvaW50ZXIpCiAgICBpZiAobS5wb2ludGVyID09PSAwKSB7CiAgICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBwb2ludGVyID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIHBvaW50ZXIsCiAgICAgIGtleTogcG9pbnRlciA9PT0gMCA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKY29uc3QgTm9kZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIENsb2NrLnByZWVuY29kZShzdGF0ZSwgbS5oZWFkcykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uYmF0Y2gpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0udmFsdWUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIENsb2NrLmVuY29kZShzdGF0ZSwgbS5oZWFkcykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uYmF0Y2gpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0udmFsdWUpCiAgfSwKICBkZWNvZGUoc3RhdGUsIG0pIHsKICAgIHJldHVybiB7CiAgICAgIGhlYWRzOiBDbG9jay5kZWNvZGUoc3RhdGUpLAogICAgICBiYXRjaDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHZhbHVlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBBZGRpdGlvbmFsID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5wb2ludGVyKQogICAgaWYgKG0ucG9pbnRlciA9PT0gMCkgewogICAgICBBZGRpdGlvbmFsRGF0YS5wcmVlbmNvZGUoc3RhdGUsIG0uZGF0YSkKICAgIH0KICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5wb2ludGVyKQogICAgaWYgKG0ucG9pbnRlciA9PT0gMCkgewogICAgICBBZGRpdGlvbmFsRGF0YS5lbmNvZGUoc3RhdGUsIG0uZGF0YSkKICAgIH0KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcG9pbnRlciA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBwb2ludGVyLAogICAgICBkYXRhOiBwb2ludGVyID09PSAwID8gQWRkaXRpb25hbERhdGEuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IEFkZGl0aW9uYWxEYXRhID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgMCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkgLy8gZW1wdHkgZm9yIG5vdywgZm9yIHRoZSBmdXR1cmUKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgZW5jcnlwdGlvbklkOiBmbGFncyAmIDEgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwsIC8vIHRvIGhlbHAgdmFsaWRhdGUgdGhlIGVuY3J5cHRpb24ga2V5IHVzZWQKICAgICAgYWJpOiBmbGFncyAmIDIgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCmNvbnN0IE9wbG9nTWVzc2FnZVYxID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdFbmNvZGluZyBub3Qgc3VwcG9ydGVkJykKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdFbmNvZGluZyBub3Qgc3VwcG9ydGVkJykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgbWF4U3VwcG9ydGVkVmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGNvbnN0IGlzQ2hlY2twb2ludGVyID0gKGZsYWdzICYgMSkgIT09IDAKCiAgICBjb25zdCBjaGsgPSBpc0NoZWNrcG9pbnRlciA/IENoZWNrcG9pbnRlckFycmF5LmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICBjb25zdCBkaWdlc3QgPSBpc0NoZWNrcG9pbnRlciA/IERpZ2VzdC5kZWNvZGUoc3RhdGUpIDogbnVsbAoKICAgIGNvbnN0IG5vZGUgPSBOb2RlLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiAxLAogICAgICBtYXhTdXBwb3J0ZWRWZXJzaW9uLAogICAgICBkaWdlc3QsCiAgICAgIGNoZWNrcG9pbnQ6IGNoayA/IHsgc3lzdGVtOiBjaGtbMF0sIGVuY3J5cHRpb246IG51bGwsIHVzZXI6IGNoay5zbGljZSgxKSB9IDogbnVsbCwKICAgICAgb3B0aW1pc3RpYzogKGZsYWdzICYgMikgIT09IDAsCiAgICAgIG5vZGUKICAgIH0KICB9Cn0KCmNvbnN0IE9wbG9nTWVzc2FnZVYwID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdFbmNvZGluZyBub3Qgc3VwcG9ydGVkJykKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdFbmNvZGluZyBub3Qgc3VwcG9ydGVkJykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGNvbnN0IGlzQ2hlY2twb2ludGVyID0gKGZsYWdzICYgMSkgIT09IDAKCiAgICBpZiAoaXNDaGVja3BvaW50ZXIpIERpZ2VzdFYwLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGNoayA9IGlzQ2hlY2twb2ludGVyID8gQ2hlY2twb2ludGVyQXJyYXkuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIGNvbnN0IG5vZGUgPSBOb2RlLmRlY29kZShzdGF0ZSkKICAgIEFkZGl0aW9uYWwuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgbWF4U3VwcG9ydGVkVmVyc2lvbiA9IHN0YXRlLnN0YXJ0IDwgc3RhdGUuZW5kID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogMCwKICAgICAgbWF4U3VwcG9ydGVkVmVyc2lvbiwKICAgICAgZGlnZXN0OiBudWxsLAogICAgICBjaGVja3BvaW50OiBjaGsgPyB7IHN5c3RlbTogY2hrWzBdLCBlbmNyeXB0aW9uOiBudWxsLCB1c2VyOiBjaGsuc2xpY2UoMSkgfSA6IG51bGwsCiAgICAgIG9wdGltaXN0aWM6IG51bGwsCiAgICAgIG5vZGUKICAgIH0KICB9Cn0KCi8vIHByZWZpeCAwIGlzIHJlc2VydmVkIGZvciBmdXR1cmUgbWFuaWZlc3QKY29uc3QgTElORUFSSVpFUl9QUkVGSVggPSAxCgpjb25zdCBMaW5lYXJpemVyS2V5ID0gewogIHByZWVuY29kZShzdGF0ZSwgc2VxKSB7CiAgICBJbmRleEVuY29kZXIuVUlOVC5wcmVlbmNvZGUoc3RhdGUsIExJTkVBUklaRVJfUFJFRklYKQogICAgSW5kZXhFbmNvZGVyLlVJTlQucHJlZW5jb2RlKHN0YXRlLCBzZXEpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHNlcSkgewogICAgSW5kZXhFbmNvZGVyLlVJTlQuZW5jb2RlKHN0YXRlLCBMSU5FQVJJWkVSX1BSRUZJWCkKICAgIEluZGV4RW5jb2Rlci5VSU5ULmVuY29kZShzdGF0ZSwgc2VxKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBJbmRleEVuY29kZXIuVUlOVC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gSW5kZXhFbmNvZGVyLlVJTlQuZGVjb2RlKHN0YXRlKQogIH0KfQoKZnVuY3Rpb24gaW5mb0xlZ2FjeU1hcChpbmZvKSB7CiAgcmV0dXJuIHsKICAgIHZlcnNpb246IGluZm8udmVyc2lvbiwKICAgIG1lbWJlcnM6IGluZm8ubWVtYmVycywKICAgIHBlbmRpbmdJbmRleGVyczogaW5mby5wZW5kaW5nSW5kZXhlcnMsCiAgICBpbmRleGVyczogaW5mby5pbmRleGVycywKICAgIGhlYWRzOiBpbmZvLmhlYWRzLAogICAgdmlld3M6IGluZm8udmlld3MsCiAgICBlbmNyeXB0aW9uTGVuZ3RoOiAwLAogICAgZW50cm9weTogbnVsbAogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgV2FrZXVwLAogIEJvb3RSZWNvcmRWMCwKICBPcGxvZ01lc3NhZ2VWMCwKICBPcGxvZ01lc3NhZ2VWMSwKICBMaW5lYXJpemVyS2V5LAogIGluZm9MZWdhY3lNYXAKfQovLyBUaGlzIGZpbGUgaXMgYXV0b2dlbmVyYXRlZCBieSB0aGUgaHlwZXJzY2hlbWEgY29tcGlsZXIKLy8gU2NoZW1hIFZlcnNpb246IDEKLyogZXNsaW50LWRpc2FibGUgY2FtZWxjYXNlICovCi8qIGVzbGludC1kaXNhYmxlIHF1b3RlcyAqLwoKY29uc3QgeyBjIH0gPSByZXF1aXJlKCdoeXBlcnNjaGVtYS9ydW50aW1lJykKY29uc3QgZXh0ZXJuYWwwID0gcmVxdWlyZSgnLi4vLi4vbGVnYWN5LmpzJykKCmNvbnN0IFZFUlNJT04gPSAxCgovLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLXZhcnMKbGV0IHZlcnNpb24gPSBWRVJTSU9OCgovLyBAYXV0b2Jhc2UvY2hlY2tvdXQKY29uc3QgZW5jb2RpbmcwID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGtleTogcjAsCiAgICAgIGxlbmd0aDogcjEKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9jbG9jawpjb25zdCBlbmNvZGluZzEgPSBjLmFycmF5KGVuY29kaW5nMCkKCi8vIEBhdXRvYmFzZS9pbmRleC1jaGVja3BvaW50CmNvbnN0IGVuY29kaW5nMiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQ2NC5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQ2NC5lbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy5maXhlZDY0LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBzaWduYXR1cmU6IHIwLAogICAgICBsZW5ndGg6IHIxCiAgICB9CiAgfQp9Cgpjb25zdCBlbmNvZGluZzMgPSBleHRlcm5hbDAuV2FrZXVwCgpjb25zdCBlbmNvZGluZzQgPSBleHRlcm5hbDAuQm9vdFJlY29yZFYwCgovLyBAYXV0b2Jhc2UvYm9vdC1yZWNvcmQtcmF3CmNvbnN0IGVuY29kaW5nNSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zeXN0ZW1MZW5ndGgpCiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyA0IHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLnJlY292ZXJpZXMpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVjb3ZlcmllcykKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSAobS5pbmRleGVyc1VwZGF0ZWQgPyAxIDogMCkgfCAobS5mYXN0Rm9yd2FyZGluZyA/IDIgOiAwKSB8IChtLnJlY292ZXJpZXMgPyA0IDogMCkKCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3lzdGVtTGVuZ3RoKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0ucmVjb3ZlcmllcykgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZWNvdmVyaWVzKQogIH0sCiAgZGVjb2RlKHN0YXRlLCB2ZXJzaW9uKSB7CiAgICBpZiAodmVyc2lvbiA9PT0gdW5kZWZpbmVkKSB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIwID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICBrZXk6IHIwLAogICAgICBzeXN0ZW1MZW5ndGg6IHIxLAogICAgICBpbmRleGVyc1VwZGF0ZWQ6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBmYXN0Rm9yd2FyZGluZzogKGZsYWdzICYgMikgIT09IDAsCiAgICAgIHJlY292ZXJpZXM6IChmbGFncyAmIDQpICE9PSAwID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvYm9vdC1yZWNvcmQKY29uc3QgZW5jb2Rpbmc2ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgc3dpdGNoIChtLnZlcnNpb24pIHsKICAgICAgY2FzZSAwOgogICAgICAgIGVuY29kaW5nNC5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAxOgogICAgICBjYXNlIDI6CiAgICAgIGNhc2UgMzoKICAgICAgICBlbmNvZGluZzUucHJlZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uJykKICAgIH0KICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgc3dpdGNoIChtLnZlcnNpb24pIHsKICAgICAgY2FzZSAwOgogICAgICAgIGVuY29kaW5nNC5lbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAxOgogICAgICBjYXNlIDI6CiAgICAgIGNhc2UgMzoKICAgICAgICBlbmNvZGluZzUuZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uJykKICAgIH0KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBzd2l0Y2ggKHZlcnNpb24pIHsKICAgICAgY2FzZSAwOiB7CiAgICAgICAgY29uc3QgZGVjb2RlZCA9IGVuY29kaW5nNC5kZWNvZGUoc3RhdGUsIHZlcnNpb24pCiAgICAgICAgcmV0dXJuIGRlY29kZWQKICAgICAgfQogICAgICBjYXNlIDE6CiAgICAgIGNhc2UgMjoKICAgICAgY2FzZSAzOiB7CiAgICAgICAgY29uc3QgZGVjb2RlZCA9IGVuY29kaW5nNS5kZWNvZGUoc3RhdGUsIHZlcnNpb24pCiAgICAgICAgcmV0dXJuIGRlY29kZWQKICAgICAgfQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbicpCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvY2hlY2twb2ludGVyCmNvbnN0IGVuY29kaW5nNyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDIgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0uY2hlY2twb2ludGVyKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmNoZWNrcG9pbnRlcikKICAgIGlmIChtLmNoZWNrcG9pbnQpIGVuY29kaW5nMi5wcmVlbmNvZGUoc3RhdGUsIG0uY2hlY2twb2ludCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSAobS5jaGVja3BvaW50ZXIgPyAxIDogMCkgfCAobS5jaGVja3BvaW50ID8gMiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0uY2hlY2twb2ludGVyKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmNoZWNrcG9pbnRlcikKICAgIGlmIChtLmNoZWNrcG9pbnQpIGVuY29kaW5nMi5lbmNvZGUoc3RhdGUsIG0uY2hlY2twb2ludCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGNoZWNrcG9pbnRlcjogKGZsYWdzICYgMSkgIT09IDAgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAsCiAgICAgIGNoZWNrcG9pbnQ6IChmbGFncyAmIDIpICE9PSAwID8gZW5jb2RpbmcyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvY2hlY2twb2ludC51c2VyCmNvbnN0IGVuY29kaW5nOF8yID0gYy5hcnJheShlbmNvZGluZzcpCgovLyBAYXV0b2Jhc2UvY2hlY2twb2ludApjb25zdCBlbmNvZGluZzggPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyA0IHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLnN5c3RlbSkgZW5jb2Rpbmc3LnByZWVuY29kZShzdGF0ZSwgbS5zeXN0ZW0pCiAgICBpZiAobS5lbmNyeXB0aW9uKSBlbmNvZGluZzcucHJlZW5jb2RlKHN0YXRlLCBtLmVuY3J5cHRpb24pCiAgICBpZiAobS51c2VyKSBlbmNvZGluZzhfMi5wcmVlbmNvZGUoc3RhdGUsIG0udXNlcikKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSAobS5zeXN0ZW0gPyAxIDogMCkgfCAobS5lbmNyeXB0aW9uID8gMiA6IDApIHwgKG0udXNlciA/IDQgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLnN5c3RlbSkgZW5jb2Rpbmc3LmVuY29kZShzdGF0ZSwgbS5zeXN0ZW0pCiAgICBpZiAobS5lbmNyeXB0aW9uKSBlbmNvZGluZzcuZW5jb2RlKHN0YXRlLCBtLmVuY3J5cHRpb24pCiAgICBpZiAobS51c2VyKSBlbmNvZGluZzhfMi5lbmNvZGUoc3RhdGUsIG0udXNlcikKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHN5c3RlbTogKGZsYWdzICYgMSkgIT09IDAgPyBlbmNvZGluZzcuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGVuY3J5cHRpb246IChmbGFncyAmIDIpICE9PSAwID8gZW5jb2Rpbmc3LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB1c2VyOiAoZmxhZ3MgJiA0KSAhPT0gMCA/IGVuY29kaW5nOF8yLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvZGlnZXN0CmNvbnN0IGVuY29kaW5nOSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDIgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0ucG9pbnRlcikgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5wb2ludGVyKQogICAgaWYgKG0ua2V5KSBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmtleSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSAobS5wb2ludGVyID8gMSA6IDApIHwgKG0ua2V5ID8gMiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0ucG9pbnRlcikgYy51aW50LmVuY29kZShzdGF0ZSwgbS5wb2ludGVyKQogICAgaWYgKG0ua2V5KSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmtleSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHBvaW50ZXI6IChmbGFncyAmIDEpICE9PSAwID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwLAogICAgICBrZXk6IChmbGFncyAmIDIpICE9PSAwID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2Uvbm9kZQpjb25zdCBlbmNvZGluZzEwID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgZW5jb2RpbmcxLnByZWVuY29kZShzdGF0ZSwgbS5oZWFkcykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uYmF0Y2gpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0udmFsdWUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGVuY29kaW5nMS5lbmNvZGUoc3RhdGUsIG0uaGVhZHMpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmJhdGNoKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnZhbHVlKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGVuY29kaW5nMS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMiA9IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBoZWFkczogcjAsCiAgICAgIGJhdGNoOiByMSwKICAgICAgdmFsdWU6IHIyCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvdHJhY2Uuc3lzdGVtCmNvbnN0IGVuY29kaW5nMTFfMCA9IGMuYXJyYXkoYy51aW50KQovLyBAYXV0b2Jhc2UvdHJhY2UuZW5jcnlwdGlvbgpjb25zdCBlbmNvZGluZzExXzEgPSBlbmNvZGluZzExXzAKCi8vIEBhdXRvYmFzZS90cmFjZQpjb25zdCBlbmNvZGluZzExID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgZW5jb2RpbmcxMV8wLnByZWVuY29kZShzdGF0ZSwgbS5zeXN0ZW0pCiAgICBlbmNvZGluZzExXzEucHJlZW5jb2RlKHN0YXRlLCBtLmVuY3J5cHRpb24pCiAgICBlbmNvZGluZzExXzIucHJlZW5jb2RlKHN0YXRlLCBtLnVzZXIpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGVuY29kaW5nMTFfMC5lbmNvZGUoc3RhdGUsIG0uc3lzdGVtKQogICAgZW5jb2RpbmcxMV8xLmVuY29kZShzdGF0ZSwgbS5lbmNyeXB0aW9uKQogICAgZW5jb2RpbmcxMV8yLmVuY29kZShzdGF0ZSwgbS51c2VyKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGVuY29kaW5nMTFfMC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGVuY29kaW5nMTFfMS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMiA9IGVuY29kaW5nMTFfMi5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgc3lzdGVtOiByMCwKICAgICAgZW5jcnlwdGlvbjogcjEsCiAgICAgIHVzZXI6IHIyCiAgICB9CiAgfQp9Cgpjb25zdCBlbmNvZGluZzEyID0gZXh0ZXJuYWwwLk9wbG9nTWVzc2FnZVYwCgpjb25zdCBlbmNvZGluZzEzID0gZXh0ZXJuYWwwLk9wbG9nTWVzc2FnZVYxCgovLyBAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZS12Mi5jaGVja3BvaW50CmNvbnN0IGVuY29kaW5nMTRfMSA9IGMuZnJhbWUoZW5jb2Rpbmc4KQovLyBAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZS12Mi5kaWdlc3QKY29uc3QgZW5jb2RpbmcxNF8yID0gYy5mcmFtZShlbmNvZGluZzkpCi8vIEBhdXRvYmFzZS9vcGxvZy1tZXNzYWdlLXYyLnRyYWNlCmNvbnN0IGVuY29kaW5nMTRfNCA9IGMuZnJhbWUoZW5jb2RpbmcxMSkKCi8vIEBhdXRvYmFzZS9vcGxvZy1tZXNzYWdlLXYyCmNvbnN0IGVuY29kaW5nMTQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBlbmNvZGluZzEwLnByZWVuY29kZShzdGF0ZSwgbS5ub2RlKQogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgOCBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5jaGVja3BvaW50KSBlbmNvZGluZzE0XzEucHJlZW5jb2RlKHN0YXRlLCBtLmNoZWNrcG9pbnQpCiAgICBpZiAobS5kaWdlc3QpIGVuY29kaW5nMTRfMi5wcmVlbmNvZGUoc3RhdGUsIG0uZGlnZXN0KQogICAgaWYgKG0udHJhY2UpIGVuY29kaW5nMTRfNC5wcmVlbmNvZGUoc3RhdGUsIG0udHJhY2UpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0KICAgICAgKG0uY2hlY2twb2ludCA/IDEgOiAwKSB8IChtLmRpZ2VzdCA/IDIgOiAwKSB8IChtLm9wdGltaXN0aWMgPyA0IDogMCkgfCAobS50cmFjZSA/IDggOiAwKQoKICAgIGVuY29kaW5nMTAuZW5jb2RlKHN0YXRlLCBtLm5vZGUpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5jaGVja3BvaW50KSBlbmNvZGluZzE0XzEuZW5jb2RlKHN0YXRlLCBtLmNoZWNrcG9pbnQpCiAgICBpZiAobS5kaWdlc3QpIGVuY29kaW5nMTRfMi5lbmNvZGUoc3RhdGUsIG0uZGlnZXN0KQogICAgaWYgKG0udHJhY2UpIGVuY29kaW5nMTRfNC5lbmNvZGUoc3RhdGUsIG0udHJhY2UpCiAgfSwKICBkZWNvZGUoc3RhdGUsIHZlcnNpb24pIHsKICAgIGlmICh2ZXJzaW9uID09PSB1bmRlZmluZWQpIHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjAgPSBlbmNvZGluZzEwLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICBub2RlOiByMCwKICAgICAgY2hlY2twb2ludDogKGZsYWdzICYgMSkgIT09IDAgPyBlbmNvZGluZzE0XzEuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGRpZ2VzdDogKGZsYWdzICYgMikgIT09IDAgPyBlbmNvZGluZzE0XzIuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIG9wdGltaXN0aWM6IChmbGFncyAmIDQpICE9PSAwLAogICAgICB0cmFjZTogKGZsYWdzICYgOCkgIT09IDAgPyBlbmNvZGluZzE0XzQuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9vcGxvZy1tZXNzYWdlCmNvbnN0IGVuY29kaW5nMTUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBzd2l0Y2ggKG0udmVyc2lvbikgewogICAgICBjYXNlIDA6CiAgICAgICAgZW5jb2RpbmcxMi5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAxOgogICAgICAgIGVuY29kaW5nMTMucHJlZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgMjoKICAgICAgICBlbmNvZGluZzE0LnByZWVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbicpCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIHN3aXRjaCAobS52ZXJzaW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICBlbmNvZGluZzEyLmVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBjYXNlIDE6CiAgICAgICAgZW5jb2RpbmcxMy5lbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAyOgogICAgICAgIGVuY29kaW5nMTQuZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uJykKICAgIH0KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBzd2l0Y2ggKHZlcnNpb24pIHsKICAgICAgY2FzZSAwOiB7CiAgICAgICAgY29uc3QgZGVjb2RlZCA9IGVuY29kaW5nMTIuZGVjb2RlKHN0YXRlLCB2ZXJzaW9uKQogICAgICAgIHJldHVybiBkZWNvZGVkCiAgICAgIH0KICAgICAgY2FzZSAxOiB7CiAgICAgICAgY29uc3QgZGVjb2RlZCA9IGVuY29kaW5nMTMuZGVjb2RlKHN0YXRlLCB2ZXJzaW9uKQogICAgICAgIHJldHVybiBkZWNvZGVkCiAgICAgIH0KICAgICAgY2FzZSAyOiB7CiAgICAgICAgY29uc3QgZGVjb2RlZCA9IGVuY29kaW5nMTQuZGVjb2RlKHN0YXRlLCB2ZXJzaW9uKQogICAgICAgIHJldHVybiBkZWNvZGVkCiAgICAgIH0KICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb24nKQogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL2luZm8tdjEucGVuZGluZ0luZGV4ZXJzCmNvbnN0IGVuY29kaW5nMTZfMSA9IGMuYXJyYXkoYy5maXhlZDMyKQoKLy8gQGF1dG9iYXNlL2luZm8tdjEKY29uc3QgZW5jb2RpbmcxNiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubWVtYmVycykKICAgIGVuY29kaW5nMTZfMS5wcmVlbmNvZGUoc3RhdGUsIG0ucGVuZGluZ0luZGV4ZXJzKQogICAgZW5jb2RpbmcxLnByZWVuY29kZShzdGF0ZSwgbS5pbmRleGVycykKICAgIGVuY29kaW5nMS5wcmVlbmNvZGUoc3RhdGUsIG0uaGVhZHMpCiAgICBlbmNvZGluZzEucHJlZW5jb2RlKHN0YXRlLCBtLnZpZXdzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLm1lbWJlcnMpCiAgICBlbmNvZGluZzE2XzEuZW5jb2RlKHN0YXRlLCBtLnBlbmRpbmdJbmRleGVycykKICAgIGVuY29kaW5nMS5lbmNvZGUoc3RhdGUsIG0uaW5kZXhlcnMpCiAgICBlbmNvZGluZzEuZW5jb2RlKHN0YXRlLCBtLmhlYWRzKQogICAgZW5jb2RpbmcxLmVuY29kZShzdGF0ZSwgbS52aWV3cykKICB9LAogIGRlY29kZShzdGF0ZSwgdmVyc2lvbikgewogICAgaWYgKHZlcnNpb24gPT09IHVuZGVmaW5lZCkgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGVuY29kaW5nMTZfMS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMiA9IGVuY29kaW5nMS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMyA9IGVuY29kaW5nMS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByNCA9IGVuY29kaW5nMS5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbiwKICAgICAgbWVtYmVyczogcjAsCiAgICAgIHBlbmRpbmdJbmRleGVyczogcjEsCiAgICAgIGluZGV4ZXJzOiByMiwKICAgICAgaGVhZHM6IHIzLAogICAgICB2aWV3czogcjQKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9pbmZvLXYyLnBlbmRpbmdJbmRleGVycwpjb25zdCBlbmNvZGluZzE3XzEgPSBlbmNvZGluZzE2XzEKCi8vIEBhdXRvYmFzZS9pbmZvLXYyCmNvbnN0IGVuY29kaW5nMTcgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLm1lbWJlcnMpCiAgICBlbmNvZGluZzE3XzEucHJlZW5jb2RlKHN0YXRlLCBtLnBlbmRpbmdJbmRleGVycykKICAgIGVuY29kaW5nMS5wcmVlbmNvZGUoc3RhdGUsIG0uaW5kZXhlcnMpCiAgICBlbmNvZGluZzEucHJlZW5jb2RlKHN0YXRlLCBtLmhlYWRzKQogICAgZW5jb2RpbmcxLnByZWVuY29kZShzdGF0ZSwgbS52aWV3cykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZW5jcnlwdGlvbkxlbmd0aCkKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDEgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0uZW50cm9weSkgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5lbnRyb3B5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IG0uZW50cm9weSA/IDEgOiAwCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5tZW1iZXJzKQogICAgZW5jb2RpbmcxN18xLmVuY29kZShzdGF0ZSwgbS5wZW5kaW5nSW5kZXhlcnMpCiAgICBlbmNvZGluZzEuZW5jb2RlKHN0YXRlLCBtLmluZGV4ZXJzKQogICAgZW5jb2RpbmcxLmVuY29kZShzdGF0ZSwgbS5oZWFkcykKICAgIGVuY29kaW5nMS5lbmNvZGUoc3RhdGUsIG0udmlld3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmVuY3J5cHRpb25MZW5ndGgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5lbnRyb3B5KSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmVudHJvcHkpCiAgfSwKICBkZWNvZGUoc3RhdGUsIHZlcnNpb24pIHsKICAgIGlmICh2ZXJzaW9uID09PSB1bmRlZmluZWQpIHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBlbmNvZGluZzE3XzEuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjIgPSBlbmNvZGluZzEuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjMgPSBlbmNvZGluZzEuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjQgPSBlbmNvZGluZzEuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjUgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb24sCiAgICAgIG1lbWJlcnM6IHIwLAogICAgICBwZW5kaW5nSW5kZXhlcnM6IHIxLAogICAgICBpbmRleGVyczogcjIsCiAgICAgIGhlYWRzOiByMywKICAgICAgdmlld3M6IHI0LAogICAgICBlbmNyeXB0aW9uTGVuZ3RoOiByNSwKICAgICAgZW50cm9weTogKGZsYWdzICYgMSkgIT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9pbmZvCmNvbnN0IGVuY29kaW5nMTggPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBzd2l0Y2ggKG0udmVyc2lvbikgewogICAgICBjYXNlIDA6CiAgICAgIGNhc2UgMToKICAgICAgICBlbmNvZGluZzE2LnByZWVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBjYXNlIDI6CiAgICAgICAgZW5jb2RpbmcxNy5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb24nKQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBzd2l0Y2ggKG0udmVyc2lvbikgewogICAgICBjYXNlIDA6CiAgICAgIGNhc2UgMToKICAgICAgICBlbmNvZGluZzE2LmVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBjYXNlIDI6CiAgICAgICAgZW5jb2RpbmcxNy5lbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb24nKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHN3aXRjaCAodmVyc2lvbikgewogICAgICBjYXNlIDA6CiAgICAgIGNhc2UgMTogewogICAgICAgIGNvbnN0IGRlY29kZWQgPSBlbmNvZGluZzE2LmRlY29kZShzdGF0ZSwgdmVyc2lvbikKICAgICAgICBjb25zdCBtYXAgPSBleHRlcm5hbDAuaW5mb0xlZ2FjeU1hcAogICAgICAgIHJldHVybiBtYXAoZGVjb2RlZCkKICAgICAgfQogICAgICBjYXNlIDI6IHsKICAgICAgICBjb25zdCBkZWNvZGVkID0gZW5jb2RpbmcxNy5kZWNvZGUoc3RhdGUsIHZlcnNpb24pCiAgICAgICAgcmV0dXJuIGRlY29kZWQKICAgICAgfQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbicpCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvbWVtYmVyCmNvbnN0IGVuY29kaW5nMTkgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAyIHNvIGFsd2F5cyBvbmUgYnl0ZQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gKG0uaXNJbmRleGVyID8gMSA6IDApIHwgKG0uaXNSZW1vdmVkID8gMiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGlzSW5kZXhlcjogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIGlzUmVtb3ZlZDogKGZsYWdzICYgMikgIT09IDAsCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGVuY29kaW5nMjAgPSBleHRlcm5hbDAuTGluZWFyaXplcktleQoKLy8gQGF1dG9iYXNlL2xpbmVhcml6ZXItdXBkYXRlCmNvbnN0IGVuY29kaW5nMjEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5iYXRjaCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3lzdGVtTGVuZ3RoKQogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMSBzbyBhbHdheXMgb25lIGJ5dGUKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSBtLmluZGV4ZXJzID8gMSA6IDAKCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5iYXRjaCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3lzdGVtTGVuZ3RoKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIyID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBrZXk6IHIwLAogICAgICBsZW5ndGg6IHIxLAogICAgICBiYXRjaDogcjIsCiAgICAgIHN5c3RlbUxlbmd0aDogcjMsCiAgICAgIGluZGV4ZXJzOiAoZmxhZ3MgJiAxKSAhPT0gMAogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL2VuY3J5cHRpb24tZGVzY3JpcHRvcgpjb25zdCBlbmNvZGluZzIyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS50eXBlKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnBheWxvYWQpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udHlwZSkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS5wYXlsb2FkKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB0eXBlOiByMCwKICAgICAgcGF5bG9hZDogcjEKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9tYW5pZmVzdC1kYXRhCmNvbnN0IGVuY29kaW5nMjMgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAyIHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLmxlZ2FjeUJsb2NrcykgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZWdhY3lCbG9ja3MpCiAgICBpZiAobS5uYW1lc3BhY2UpIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ubmFtZXNwYWNlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLmxlZ2FjeUJsb2NrcyA/IDEgOiAwKSB8IChtLm5hbWVzcGFjZSA/IDIgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLmxlZ2FjeUJsb2NrcykgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZWdhY3lCbG9ja3MpCiAgICBpZiAobS5uYW1lc3BhY2UpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ubmFtZXNwYWNlKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogcjAsCiAgICAgIGxlZ2FjeUJsb2NrczogKGZsYWdzICYgMSkgIT09IDAgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAsCiAgICAgIG5hbWVzcGFjZTogKGZsYWdzICYgMikgIT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS91c2VyLXZpZXctdHJhY2UuYmxvY2tzCmNvbnN0IGVuY29kaW5nMjRfMSA9IGVuY29kaW5nMTFfMAoKLy8gQGF1dG9iYXNlL3VzZXItdmlldy10cmFjZQpjb25zdCBlbmNvZGluZzI0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS52aWV3KQogICAgZW5jb2RpbmcyNF8xLnByZWVuY29kZShzdGF0ZSwgbS5ibG9ja3MpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udmlldykKICAgIGVuY29kaW5nMjRfMS5lbmNvZGUoc3RhdGUsIG0uYmxvY2tzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGVuY29kaW5nMjRfMS5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmlldzogcjAsCiAgICAgIGJsb2NrczogcjEKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS90cmFjZS51c2VyLCBkZWZlcnJlZCBkdWUgdG8gcmVjdXNpdmUgdXNlCmNvbnN0IGVuY29kaW5nMTFfMiA9IGMuYXJyYXkoZW5jb2RpbmcyNCkKCmZ1bmN0aW9uIHNldFZlcnNpb24odikgewogIHZlcnNpb24gPSB2Cn0KCmZ1bmN0aW9uIGVuY29kZShuYW1lLCB2YWx1ZSwgdiA9IFZFUlNJT04pIHsKICB2ZXJzaW9uID0gdgogIHJldHVybiBjLmVuY29kZShnZXRFbmNvZGluZyhuYW1lKSwgdmFsdWUpCn0KCmZ1bmN0aW9uIGRlY29kZShuYW1lLCBidWZmZXIsIHYgPSBWRVJTSU9OKSB7CiAgdmVyc2lvbiA9IHYKICByZXR1cm4gYy5kZWNvZGUoZ2V0RW5jb2RpbmcobmFtZSksIGJ1ZmZlcikKfQoKZnVuY3Rpb24gZ2V0RW51bShuYW1lKSB7CiAgc3dpdGNoIChuYW1lKSB7CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VudW0gbm90IGZvdW5kICcgKyBuYW1lKQogIH0KfQoKZnVuY3Rpb24gZ2V0RW5jb2RpbmcobmFtZSkgewogIHN3aXRjaCAobmFtZSkgewogICAgY2FzZSAnQGF1dG9iYXNlL2NoZWNrb3V0JzoKICAgICAgcmV0dXJuIGVuY29kaW5nMAogICAgY2FzZSAnQGF1dG9iYXNlL2Nsb2NrJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMQogICAgY2FzZSAnQGF1dG9iYXNlL2luZGV4LWNoZWNrcG9pbnQnOgogICAgICByZXR1cm4gZW5jb2RpbmcyCiAgICBjYXNlICdAYXV0b2Jhc2Uvd2FrZXVwJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMwogICAgY2FzZSAnQGF1dG9iYXNlL2Jvb3QtcmVjb3JkLXYwJzoKICAgICAgcmV0dXJuIGVuY29kaW5nNAogICAgY2FzZSAnQGF1dG9iYXNlL2Jvb3QtcmVjb3JkLXJhdyc6CiAgICAgIHJldHVybiBlbmNvZGluZzUKICAgIGNhc2UgJ0BhdXRvYmFzZS9ib290LXJlY29yZCc6CiAgICAgIHJldHVybiBlbmNvZGluZzYKICAgIGNhc2UgJ0BhdXRvYmFzZS9jaGVja3BvaW50ZXInOgogICAgICByZXR1cm4gZW5jb2Rpbmc3CiAgICBjYXNlICdAYXV0b2Jhc2UvY2hlY2twb2ludCc6CiAgICAgIHJldHVybiBlbmNvZGluZzgKICAgIGNhc2UgJ0BhdXRvYmFzZS9kaWdlc3QnOgogICAgICByZXR1cm4gZW5jb2Rpbmc5CiAgICBjYXNlICdAYXV0b2Jhc2Uvbm9kZSc6CiAgICAgIHJldHVybiBlbmNvZGluZzEwCiAgICBjYXNlICdAYXV0b2Jhc2UvdHJhY2UnOgogICAgICByZXR1cm4gZW5jb2RpbmcxMQogICAgY2FzZSAnQGF1dG9iYXNlL29wbG9nLW1lc3NhZ2UtdjAnOgogICAgICByZXR1cm4gZW5jb2RpbmcxMgogICAgY2FzZSAnQGF1dG9iYXNlL29wbG9nLW1lc3NhZ2UtdjEnOgogICAgICByZXR1cm4gZW5jb2RpbmcxMwogICAgY2FzZSAnQGF1dG9iYXNlL29wbG9nLW1lc3NhZ2UtdjInOgogICAgICByZXR1cm4gZW5jb2RpbmcxNAogICAgY2FzZSAnQGF1dG9iYXNlL29wbG9nLW1lc3NhZ2UnOgogICAgICByZXR1cm4gZW5jb2RpbmcxNQogICAgY2FzZSAnQGF1dG9iYXNlL2luZm8tdjEnOgogICAgICByZXR1cm4gZW5jb2RpbmcxNgogICAgY2FzZSAnQGF1dG9iYXNlL2luZm8tdjInOgogICAgICByZXR1cm4gZW5jb2RpbmcxNwogICAgY2FzZSAnQGF1dG9iYXNlL2luZm8nOgogICAgICByZXR1cm4gZW5jb2RpbmcxOAogICAgY2FzZSAnQGF1dG9iYXNlL21lbWJlcic6CiAgICAgIHJldHVybiBlbmNvZGluZzE5CiAgICBjYXNlICdAYXV0b2Jhc2UvbGluZWFyaXplci1rZXknOgogICAgICByZXR1cm4gZW5jb2RpbmcyMAogICAgY2FzZSAnQGF1dG9iYXNlL2xpbmVhcml6ZXItdXBkYXRlJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMjEKICAgIGNhc2UgJ0BhdXRvYmFzZS9lbmNyeXB0aW9uLWRlc2NyaXB0b3InOgogICAgICByZXR1cm4gZW5jb2RpbmcyMgogICAgY2FzZSAnQGF1dG9iYXNlL21hbmlmZXN0LWRhdGEnOgogICAgICByZXR1cm4gZW5jb2RpbmcyMwogICAgY2FzZSAnQGF1dG9iYXNlL3VzZXItdmlldy10cmFjZSc6CiAgICAgIHJldHVybiBlbmNvZGluZzI0CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY29kZXIgbm90IGZvdW5kICcgKyBuYW1lKQogIH0KfQoKZnVuY3Rpb24gZ2V0U3RydWN0KG5hbWUsIHYgPSBWRVJTSU9OKSB7CiAgY29uc3QgZW5jID0gZ2V0RW5jb2RpbmcobmFtZSkKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIHZlcnNpb24gPSB2CiAgICAgIGVuYy5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIHZlcnNpb24gPSB2CiAgICAgIGVuYy5lbmNvZGUoc3RhdGUsIG0pCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIHZlcnNpb24gPSB2CiAgICAgIHJldHVybiBlbmMuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVzb2x2ZVN0cnVjdCA9IGdldFN0cnVjdCAvLyBjb21wYXQKCm1vZHVsZS5leHBvcnRzID0gewogIHJlc29sdmVTdHJ1Y3QsCiAgZ2V0U3RydWN0LAogIGdldEVudW0sCiAgZ2V0RW5jb2RpbmcsCiAgZW5jb2RlLAogIGRlY29kZSwKICBzZXRWZXJzaW9uLAogIHZlcnNpb24KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBSZWFkeVJlc291cmNlID0gcmVxdWlyZSgncmVhZHktcmVzb3VyY2UnKQpjb25zdCBkZWJvdW5jZWlmeSA9IHJlcXVpcmUoJ2RlYm91bmNlaWZ5JykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IGh5cGVyY29yZUlkID0gcmVxdWlyZSgnaHlwZXJjb3JlLWlkLWVuY29kaW5nJykKY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnbmFub2Fzc2VydCcpCmNvbnN0IFNpZ25hbFByb21pc2UgPSByZXF1aXJlKCdzaWduYWwtcHJvbWlzZScpCmNvbnN0IENvcmVDb3VwbGVyID0gcmVxdWlyZSgnY29yZS1jb3VwbGVyJykKY29uc3QgUHJvdG9tdXhXYWtldXAgPSByZXF1aXJlKCdwcm90b211eC13YWtldXAnKQpjb25zdCBycnAgPSByZXF1aXJlKCdyZXNvbHZlLXJlamVjdC1wcm9taXNlJykKY29uc3QgSHlwZXJjb3JlID0gcmVxdWlyZSgnaHlwZXJjb3JlJykKY29uc3QgU2NvcGVMb2NrID0gcmVxdWlyZSgnc2NvcGUtbG9jaycpCgpjb25zdCBMb2NhbFN0YXRlID0gcmVxdWlyZSgnLi9saWIvbG9jYWwtc3RhdGUuanMnKQpjb25zdCBMaW5lYXJpemVyID0gcmVxdWlyZSgnLi9saWIvbGluZWFyaXplci5qcycpCmNvbnN0IFN5c3RlbVZpZXcgPSByZXF1aXJlKCcuL2xpYi9zeXN0ZW0uanMnKQpjb25zdCB7IEVuY3J5cHRpb25WaWV3IH0gPSByZXF1aXJlKCcuL2xpYi9lbmNyeXB0aW9uLmpzJykKY29uc3QgVXBkYXRlQ2hhbmdlcyA9IHJlcXVpcmUoJy4vbGliL3VwZGF0ZXMuanMnKQpjb25zdCBtZXNzYWdlcyA9IHJlcXVpcmUoJy4vbGliL21lc3NhZ2VzLmpzJykKY29uc3QgVGltZXIgPSByZXF1aXJlKCcuL2xpYi90aW1lci5qcycpCmNvbnN0IFdyaXRlciA9IHJlcXVpcmUoJy4vbGliL3dyaXRlci5qcycpCmNvbnN0IHsgZW5jb2RlVmFsdWUsIGRlY29kZVZhbHVlIH0gPSByZXF1aXJlKCcuL2xpYi92YWx1ZXMuanMnKQpjb25zdCBBY3RpdmVXcml0ZXJzID0gcmVxdWlyZSgnLi9saWIvYWN0aXZlLXdyaXRlcnMuanMnKQpjb25zdCBBdXRvV2FrZXVwID0gcmVxdWlyZSgnLi9saWIvd2FrZXVwLmpzJykKCmNvbnN0IEZhc3RGb3J3YXJkID0gcmVxdWlyZSgnLi9saWIvZmFzdC1mb3J3YXJkLmpzJykKY29uc3QgQXV0b1N0b3JlID0gcmVxdWlyZSgnLi9saWIvc3RvcmUuanMnKQpjb25zdCBBcHBseVN0YXRlID0gcmVxdWlyZSgnLi9saWIvYXBwbHktc3RhdGUuanMnKQpjb25zdCBBcHBlbmRCYXRjaCA9IHJlcXVpcmUoJy4vbGliL2FwcGVuZC1iYXRjaC5qcycpCmNvbnN0IHsgUHVibGljQXBwbHlDYWxscyB9ID0gcmVxdWlyZSgnLi9saWIvYXBwbHktY2FsbHMuanMnKQpjb25zdCBib290ID0gcmVxdWlyZSgnLi9saWIvYm9vdC5qcycpCmNvbnN0IHsgTUFYX0FVVE9CQVNFX1ZFUlNJT04sIEJPT1RfUkVDT1JEX1ZFUlNJT04gfSA9IHJlcXVpcmUoJy4vbGliL2NhcHMuanMnKQoKY29uc3QgaW5zcGVjdCA9IFN5bWJvbC5mb3IoJ25vZGVqcy51dGlsLmluc3BlY3QuY3VzdG9tJykKY29uc3QgSU5URVJSVVBUID0gbmV3IEVycm9yKCdBcHBseSBpbnRlcnJ1cHRlZCcpCmNvbnN0IEJJTkFSWV9FTkNPRElORyA9IGMuZnJvbSgnYmluYXJ5JykKCmNvbnN0IFJFQ09WRVJJRVMgPSAzCgovLyBkZWZhdWx0IGlzIHRvIGF1dG9tYXRpY2FsbHkgYWNrCmNvbnN0IERFRkFVTFRfQUNLX0lOVEVSVkFMID0gMTBfMDAwCmNvbnN0IERFRkFVTFRfQUNLX1RIUkVTSE9MRCA9IDQKCmNvbnN0IFJFTU9URV9BRERfQkFUQ0ggPSA2NApjb25zdCBSRU1PVEVfQUREX0JBVENIX1NBTklUWSA9IDQwOTYKY29uc3QgTUlOX0ZGX1dBSVQgPSAzMDBfMDAwIC8vIHdhaXQgYXQgbGVhc3QgNW1pbiBiZWZvcmUgYXR0ZW1wdGluZyB0byBmZiBhZ2FpbiBhZnRlciBmYWlsdXJlCgpjbGFzcyBXYWtldXBIYW5kbGVyIHsKICBjb25zdHJ1Y3RvcihiYXNlLCBkaXNjb3ZlcnlLZXkpIHsKICAgIHRoaXMuYWN0aXZlID0gdHJ1ZQogICAgdGhpcy5kaXNjb3ZlcnlLZXkgPSBkaXNjb3ZlcnlLZXkKICAgIHRoaXMuYmFzZSA9IGJhc2UKICB9CgogIG9ucGVlcmFjdGl2ZShwZWVyLCBzZXNzaW9uKSB7CiAgICB0aGlzLmJhc2UuX2J1bXBXYWtldXBQZWVyKHBlZXIpCiAgfQoKICBvbmxvb2t1cChyZXEsIHBlZXIsIHNlc3Npb24pIHsKICAgIGNvbnN0IHdha2V1cCA9IHRoaXMuYmFzZS5fZ2V0V2FrZXVwKCkKICAgIGlmICh3YWtldXAubGVuZ3RoID09PSAwKSByZXR1cm4KICAgIHNlc3Npb24uYW5ub3VuY2UocGVlciwgd2FrZXVwKQogIH0KCiAgb25hbm5vdW5jZSh3YWtldXAsIHBlZXIsIHNlc3Npb24pIHsKICAgIGlmICh0aGlzLmJhc2UuaXNGYXN0Rm9yd2FyZGluZygpKSB7CiAgICAgIHRoaXMuYmFzZS5fbmVlZHNXYWtldXBSZXF1ZXN0ID0gdHJ1ZQogICAgICByZXR1cm4KICAgIH0KICAgIHRoaXMuYmFzZS5oaW50V2FrZXVwKHdha2V1cCkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQXV0b2Jhc2UgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvcihzdG9yZSwgYm9vdHN0cmFwLCBoYW5kbGVycyA9IHt9KSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShib290c3RyYXApKSBib290c3RyYXAgPSBib290c3RyYXBbMF0gLy8gVE9ETzoganVzdCBhIHF1aWNrIGNvbXBhdCwgbGV0cyByZW1vdmUgc29vbgoKICAgIGlmIChib290c3RyYXAgJiYgdHlwZW9mIGJvb3RzdHJhcCAhPT0gJ3N0cmluZycgJiYgIWI0YS5pc0J1ZmZlcihib290c3RyYXApKSB7CiAgICAgIGhhbmRsZXJzID0gYm9vdHN0cmFwCiAgICAgIGJvb3RzdHJhcCA9IG51bGwKICAgIH0KCiAgICBzdXBlcigpCgogICAgY29uc3Qga2V5ID0gYm9vdHN0cmFwID8gdG9LZXkoYm9vdHN0cmFwKSA6IG51bGwKCiAgICB0aGlzLmlkID0gbnVsbAogICAgdGhpcy5rZXkgPSBrZXkKICAgIHRoaXMuZGlzY292ZXJ5S2V5ID0gbnVsbAogICAgdGhpcy5iYWNrb2ZmID0gaGFuZGxlcnMuYmFja29mZiB8fCBudWxsCgogICAgdGhpcy5rZXlQYWlyID0gbnVsbAogICAgdGhpcy52YWx1ZUVuY29kaW5nID0gYy5mcm9tKGhhbmRsZXJzLnZhbHVlRW5jb2RpbmcgfHwgJ2JpbmFyeScpCiAgICB0aGlzLnN0b3JlID0gc3RvcmUKICAgIHRoaXMuZ2xvYmFsQ2FjaGUgPSBzdG9yZS5nbG9iYWxDYWNoZSB8fCBudWxsCiAgICB0aGlzLm1pZ3JhdGVkID0gZmFsc2UKCiAgICB0aGlzLmVuY3J5cHRlZCA9IGhhbmRsZXJzLmVuY3J5cHRlZCB8fCAhIWhhbmRsZXJzLmVuY3J5cHRpb25LZXkKICAgIHRoaXMuZW5jcnlwdCA9ICEhaGFuZGxlcnMuZW5jcnlwdAogICAgdGhpcy5lbmNyeXB0aW9uS2V5ID0gbnVsbAogICAgdGhpcy5lbmNyeXB0aW9uID0gbnVsbAoKICAgIHRoaXMuYWN0aXZlQmF0Y2ggPSBudWxsIC8vIG1haW50YWluZWQgYnkgdGhlIGFwcGVuZC1iYXRjaAoKICAgIHRoaXMubG9jYWwgPSBudWxsCiAgICB0aGlzLmxvY2FsV3JpdGVyID0gbnVsbAogICAgdGhpcy5pc0luZGV4ZXIgPSBmYWxzZQoKICAgIHRoaXMuYWN0aXZlV3JpdGVycyA9IG5ldyBBY3RpdmVXcml0ZXJzKCkKICAgIHRoaXMubGluZWFyaXplciA9IG51bGwKICAgIHRoaXMudXBkYXRpbmcgPSBmYWxzZQoKICAgIHRoaXMubnVrZVRpcCA9ICEhaGFuZGxlcnMubnVrZVRpcAoKICAgIHRoaXMud2FrZXVwT3duZXIgPSAhaGFuZGxlcnMud2FrZXVwCiAgICB0aGlzLndha2V1cENhcGFiaWxpdHkgPSBudWxsCiAgICB0aGlzLndha2V1cFByb3RvY29sID0gaGFuZGxlcnMud2FrZXVwIHx8IG5ldyBQcm90b211eFdha2V1cCgpCiAgICB0aGlzLndha2V1cFNlc3Npb24gPSBudWxsCgogICAgdGhpcy5fcHJpbWFyeUJvb3RzdHJhcCA9IG51bGwKCiAgICB0aGlzLmZhc3RGb3J3YXJkRW5hYmxlZCA9IGhhbmRsZXJzLmZhc3RGb3J3YXJkICE9PSBmYWxzZQogICAgdGhpcy5mYXN0Rm9yd2FyZGluZyA9IG51bGwKICAgIHRoaXMuZmFzdEZvcndhcmRUbyA9IG51bGwKICAgIHRoaXMuZmFzdEZvcndhcmRGYWlsZWRBdCA9IDAKICAgIHRoaXMuZmFzdEZvcndhcmRNaW5pbXVtID0gRmFzdEZvcndhcmQuTUlOSU1VTQoKICAgIHRoaXMuYmlnQmF0Y2hlcyA9ICEhaGFuZGxlcnMuYmlnQmF0Y2hlcwoKICAgIHRoaXMuX2Jvb3RzdHJhcFdyaXRlcnMgPSBbXSAvLyBtaWdodCBjb250YWluIGR1cHMsIGJ1dCB0aGF0cyBvawogICAgdGhpcy5fYm9vdHN0cmFwV3JpdGVyc0NoYW5nZWQgPSBmYWxzZQoKICAgIHRoaXMuX2ZsdXNoU2lnbmFsID0gbmV3IFNpZ25hbFByb21pc2UoKQogICAgdGhpcy5fZmx1c2hpbmcgPSAwCgogICAgdGhpcy5fY2hlY2tXcml0ZXJzID0gW10KICAgIHRoaXMuX29wdGltaXN0aWMgPSAtMQogICAgdGhpcy5fYXBwZW5kZWQgPSAwCiAgICB0aGlzLl9hcHBlbmRpbmcgPSBudWxsCiAgICB0aGlzLl93YWtldXAgPSBuZXcgQXV0b1dha2V1cCh0aGlzKQogICAgdGhpcy5fd2FrZXVwSGludHMgPSBuZXcgTWFwKCkKICAgIHRoaXMuX3dha2V1cFBlZXJCb3VuZCA9IHRoaXMuX3dha2V1cFBlZXIuYmluZCh0aGlzKQogICAgdGhpcy5fY291cGxlciA9IG51bGwKCiAgICB0aGlzLl91cGRhdGVMb2NhbENvcmUgPSBudWxsCiAgICB0aGlzLl9sb2NrID0gbmV3IFNjb3BlTG9jaygpCgogICAgdGhpcy5fbmVlZHNXYWtldXBSZXF1ZXN0ID0gZmFsc2UKICAgIHRoaXMuX25lZWRzV2FrZXVwID0gdHJ1ZQogICAgdGhpcy5fbmVlZHNXYWtldXBIZWFkcyA9IHRydWUKCiAgICB0aGlzLl91cGRhdGVzID0gW10KICAgIHRoaXMuX2hhbmRsZXJzID0gaGFuZGxlcnMgfHwge30KICAgIHRoaXMuX3dhcm4gPSBlbWl0V2FybmluZy5iaW5kKHRoaXMpCiAgICB0aGlzLl9sYXN0RXJyb3IgPSBudWxsCgogICAgdGhpcy5fZHJhaW5pbmcgPSBmYWxzZQogICAgdGhpcy5fd3JpdGFibGUgPSBudWxsCiAgICB0aGlzLl9hZHZhbmNpbmcgPSBudWxsCiAgICB0aGlzLl9pbnRlcnJ1cHRpbmcgPSBmYWxzZQogICAgdGhpcy5fY2F1Z2h0dXAgPSBmYWxzZQoKICAgIHRoaXMucGF1c2VkID0gZmFsc2UKCiAgICB0aGlzLl9idW1wID0gZGVib3VuY2VpZnkoKCkgPT4gewogICAgICB0aGlzLl9hZHZhbmNpbmcgPSB0aGlzLl9hZHZhbmNlKCkKICAgICAgcmV0dXJuIHRoaXMuX2FkdmFuY2luZwogICAgfSkKCiAgICB0aGlzLl9vbnJlbW90ZXdyaXRlcmNoYW5nZUJvdW5kID0gdGhpcy5fb25yZW1vdGV3cml0ZXJjaGFuZ2UuYmluZCh0aGlzKQogICAgdGhpcy5fb25sb2NhbHdyaXRlcmNoYW5nZUJvdW5kID0gdGhpcy5fb25sb2NhbHdyaXRlcmNoYW5nZS5iaW5kKHRoaXMpCgogICAgdGhpcy5fcHJlb3BlbiA9IG51bGwKCiAgICB0aGlzLl9oYXNPcGVuID0gISF0aGlzLl9oYW5kbGVycy5vcGVuCiAgICB0aGlzLl9oYXNBcHBseSA9ICEhdGhpcy5faGFuZGxlcnMuYXBwbHkKICAgIHRoaXMuX2hhc09wdGltaXN0aWNBcHBseSA9ICEhdGhpcy5faGFuZGxlcnMub3B0aW1pc3RpYwogICAgdGhpcy5faGFzVXBkYXRlID0gISF0aGlzLl9oYW5kbGVycy51cGRhdGUKICAgIHRoaXMuX2hhc0Nsb3NlID0gISF0aGlzLl9oYW5kbGVycy5jbG9zZQoKICAgIHRoaXMuX3ZpZXdTdG9yZSA9IG5ldyBBdXRvU3RvcmUodGhpcykKICAgIHRoaXMuX2FwcGx5U3RhdGUgPSBudWxsCgogICAgdGhpcy52aWV3ID0gbnVsbAogICAgdGhpcy5jb3JlID0gbnVsbAogICAgdGhpcy52ZXJzaW9uID0gLTEKICAgIHRoaXMuaW50ZXJydXB0ZWQgPSBudWxsCiAgICB0aGlzLnJlY292ZXJpZXMgPSBSRUNPVkVSSUVTCgogICAgY29uc3QgeyBhY2tJbnRlcnZhbCA9IERFRkFVTFRfQUNLX0lOVEVSVkFMLCBhY2tUaHJlc2hvbGQgPSBERUZBVUxUX0FDS19USFJFU0hPTEQgfSA9IGhhbmRsZXJzCgogICAgdGhpcy5fYWNrSW50ZXJ2YWwgPSBhY2tJbnRlcnZhbAogICAgdGhpcy5fYWNrVGhyZXNob2xkID0gYWNrVGhyZXNob2xkCiAgICB0aGlzLl9hY2tUaWNrVGhyZXNob2xkID0gYWNrVGhyZXNob2xkCiAgICB0aGlzLl9hY2tUaWNrID0gMAoKICAgIHRoaXMuX2Fja1RpbWVyID0gbnVsbAogICAgdGhpcy5fYWNraW5nID0gZmFsc2UKCiAgICB0aGlzLl93YWl0aW5nID0gbmV3IFNpZ25hbFByb21pc2UoKQoKICAgIHRoaXMudmlldyA9IHRoaXMuX2hhc09wZW4KICAgICAgPyB0aGlzLl9oYW5kbGVycy5vcGVuKHRoaXMuX3ZpZXdTdG9yZSwgbmV3IFB1YmxpY0FwcGx5Q2FsbHModGhpcykpCiAgICAgIDogbnVsbAogICAgdGhpcy5jb3JlID0gdGhpcy5fdmlld1N0b3JlLmdldCh7IG5hbWU6ICdfc3lzdGVtJyB9KQoKICAgIGlmICh0aGlzLmZhc3RGb3J3YXJkRW5hYmxlZCAmJiBpc09iamVjdChoYW5kbGVycy5mYXN0Rm9yd2FyZCkpIHsKICAgICAgdGhpcy5fcnVuRmFzdEZvcndhcmQoCiAgICAgICAgbmV3IEZhc3RGb3J3YXJkKHRoaXMsIGhhbmRsZXJzLmZhc3RGb3J3YXJkLmtleSwgeyB2ZXJpZmllZDogZmFsc2UgfSkKICAgICAgKS5jYXRjaChub29wKQogICAgfQoKICAgIHRoaXMucmVhZHkoKS5jYXRjaChzYWZldHlDYXRjaCkKICB9CgogIFtpbnNwZWN0XShkZXB0aCwgb3B0cykgewogICAgbGV0IGluZGVudCA9ICcnCiAgICBpZiAodHlwZW9mIG9wdHMuaW5kZW50YXRpb25MdmwgPT09ICdudW1iZXInKSB7CiAgICAgIHdoaWxlIChpbmRlbnQubGVuZ3RoIDwgb3B0cy5pbmRlbnRhdGlvbkx2bCkgaW5kZW50ICs9ICcgJwogICAgfQoKICAgIHJldHVybiBpbmRlbnQgKyAnQXV0b2Jhc2UgeyAuLi4gfScKICB9CgogIC8vIGp1c3QgY29tcGF0LCB1c2UgLmtleQogIGdldCBib290c3RyYXAoKSB7CiAgICByZXR1cm4gdGhpcy5rZXkKICB9CgogIC8vIFRPRE86IGNvbXBhdCwgd2lsbCBiZSByZW1vdmVkCiAgZ2V0IGJvb3RzdHJhcHMoKSB7CiAgICByZXR1cm4gW3RoaXMuYm9vdHN0cmFwXQogIH0KCiAgZ2V0IGFwcGVuZGluZygpIHsKICAgIHJldHVybiB0aGlzLl9hcHBlbmRpbmcgIT09IG51bGwgJiYgdGhpcy5fYXBwZW5kaW5nLmxlbmd0aCA+IDAKICB9CgogIGdldCB3cml0YWJsZSgpIHsKICAgIHJldHVybiB0aGlzLmxvY2FsV3JpdGVyICE9PSBudWxsICYmICF0aGlzLmxvY2FsV3JpdGVyLmlzUmVtb3ZlZAogIH0KCiAgZ2V0IGFja2FibGUoKSB7CiAgICByZXR1cm4gdGhpcy5sb2NhbFdyaXRlciAhPT0gbnVsbCAmJiB0aGlzLmxvY2FsV3JpdGVyLmlzQWN0aXZlSW5kZXhlcgogIH0KCiAgZ2V0IHNpZ25lZExlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUuc2lnbmVkTGVuZ3RoCiAgfQoKICBnZXQgaW5kZXhlZExlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLl9hcHBseVN0YXRlID8gdGhpcy5fYXBwbHlTdGF0ZS5pbmRleGVkTGVuZ3RoIDogMAogIH0KCiAgZ2V0IGxlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUubGVuZ3RoCiAgfQoKICBnZXQgZmx1c2hpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5fZmx1c2hpbmcgPiAwCiAgfQoKICBoYXNoKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS50cmVlSGFzaCgpCiAgfQoKICAvLyBkZXByZWNhdGVkLCB1c2UgLmNvcmUua2V5CiAgZ2V0U3lzdGVtS2V5KCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5rZXkKICB9CgogIGdldCBzeXN0ZW0oKSB7CiAgICByZXR1cm4gdGhpcy5fYXBwbHlTdGF0ZSAmJiB0aGlzLl9hcHBseVN0YXRlLnN5c3RlbQogIH0KCiAgLy8gZGVwcmVjYXRlZAogIGFzeW5jIGdldEluZGV4ZWRJbmZvKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICByZXR1cm4gKAogICAgICB0aGlzLl9hcHBseVN0YXRlICYmIHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmdldEluZGV4ZWRJbmZvKHRoaXMuX2FwcGx5U3RhdGUuaW5kZXhlZExlbmd0aCkKICAgICkKICB9CgogIF9pc0FjdGl2ZUluZGV4ZXIoKSB7CiAgICByZXR1cm4gdGhpcy5sb2NhbFdyaXRlciA/IHRoaXMubG9jYWxXcml0ZXIuaXNBY3RpdmVJbmRleGVyIDogZmFsc2UKICB9CgogIHJlcGxpY2F0ZShpc0luaXRpYXRvciwgb3B0cykgewogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdG9yZS5yZXBsaWNhdGUoaXNJbml0aWF0b3IsIG9wdHMpCiAgICB0aGlzLndha2V1cFByb3RvY29sLmFkZFN0cmVhbShzdHJlYW0pCiAgICByZXR1cm4gc3RyZWFtCiAgfQoKICBoZWFkcygpIHsKICAgIGlmICghdGhpcy5fYXBwbHlTdGF0ZSB8fCAhdGhpcy5fYXBwbHlTdGF0ZS5vcGVuZWQpIHJldHVybiBbXQogICAgY29uc3Qgbm9kZXMgPSBuZXcgQXJyYXkodGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uaGVhZHMubGVuZ3RoKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5oZWFkcy5sZW5ndGg7IGkrKykKICAgICAgbm9kZXNbaV0gPSB0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5oZWFkc1tpXQogICAgcmV0dXJuIG5vZGVzLnNvcnQoY29tcGFyZU5vZGVzKQogIH0KCiAgYXN5bmMgZXhwb3J0KCkgewogICAgY29uc3QgZXhwb3J0aW5nID0gW3RoaXMuc3RvcmUuc3RvcmFnZS5leHBvcnQodGhpcy5sb2NhbC5kaXNjb3ZlcnlLZXkpLCB0aGlzLl92aWV3U3RvcmUuZXhwb3J0KCldCgogICAgY29uc3QgW2xvY2FsLCB2aWV3c10gPSBhd2FpdCBQcm9taXNlLmFsbChleHBvcnRpbmcpCgogICAgcmV0dXJuIHsKICAgICAgbG9jYWwsCiAgICAgIHZpZXdzCiAgICB9CiAgfQoKICBoaW50V2FrZXVwKGhpbnRzKSB7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkoaGludHMpKSBoaW50cyA9IFtoaW50c10KICAgIGZvciAoY29uc3QgeyBrZXksIGxlbmd0aCB9IG9mIGhpbnRzKSB7CiAgICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQogICAgICBjb25zdCBwcmV2ID0gdGhpcy5fd2FrZXVwSGludHMuZ2V0KGhleCkKICAgICAgaWYgKCFwcmV2IHx8IGxlbmd0aCA9PT0gLTEgfHwgcHJldiA8IGxlbmd0aCkgdGhpcy5fd2FrZXVwSGludHMuc2V0KGhleCwgbGVuZ3RoKQogICAgfQogICAgdGhpcy5fcXVldWVCdW1wKCkKICB9CgogIHNldEJpZ0JhdGNoZXMoYm9vbCA9IHRydWUpIHsKICAgIHRoaXMuYmlnQmF0Y2hlcyA9IGJvb2wKICB9CgogIF9xdWV1ZUJ1bXAoKSB7CiAgICB0aGlzLl9idW1wKCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgfQoKICBhc3luYyBfcnVuUHJlT3BlbigpIHsKICAgIGlmICh0aGlzLl9oYW5kbGVycy53YWl0KSBhd2FpdCB0aGlzLl9oYW5kbGVycy53YWl0KCkKCiAgICBhd2FpdCB0aGlzLnN0b3JlLnJlYWR5KCkKCiAgICB0aGlzLmtleVBhaXIgPSAoYXdhaXQgdGhpcy5faGFuZGxlcnMua2V5UGFpcikgfHwgbnVsbAoKICAgIGlmICh0aGlzLl9oYW5kbGVycy5lbmNyeXB0aW9uS2V5ICE9PSBudWxsKSB7CiAgICAgIHRoaXMuZW5jcnlwdGlvbktleSA9IGF3YWl0IHRoaXMuX2hhbmRsZXJzLmVuY3J5cHRpb25LZXkKICAgIH0KCiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBib290KHRoaXMuc3RvcmUsIHRoaXMua2V5LCB7CiAgICAgIGVuY3J5cHRpb25LZXk6IHRoaXMuZW5jcnlwdGlvbktleSwKICAgICAgZW5jcnlwdDogdGhpcy5lbmNyeXB0LAogICAgICBrZXlQYWlyOiB0aGlzLmtleVBhaXIKICAgIH0pCgogICAgdGhpcy5fcHJpbWFyeUJvb3RzdHJhcCA9IHJlc3VsdC5ib290c3RyYXAKICAgIHRoaXMubG9jYWwgPSByZXN1bHQubG9jYWwKCiAgICB0aGlzLmtleSA9IHJlc3VsdC5ib290c3RyYXAua2V5CiAgICB0aGlzLmRpc2NvdmVyeUtleSA9IHJlc3VsdC5ib290c3RyYXAuZGlzY292ZXJ5S2V5CiAgICB0aGlzLmlkID0gcmVzdWx0LmJvb3RzdHJhcC5pZAoKICAgIHRoaXMuZW5jcnlwdGlvbktleSA9IHJlc3VsdC5lbmNyeXB0aW9uS2V5CgogICAgaWYgKHRoaXMuZW5jcnlwdGVkKSB7CiAgICAgIGFzc2VydCh0aGlzLmVuY3J5cHRpb25LZXkgIT09IG51bGwsICdFbmNyeXB0aW9uIGtleSBpcyBleHBlY3RlZCcpCiAgICB9CgogICAgaWYgKHRoaXMuZW5jcnlwdGlvbktleSkgewogICAgICB0aGlzLmVuY3J5cHRpb24gPSBuZXcgRW5jcnlwdGlvblZpZXcodGhpcywgbnVsbCkKCiAgICAgIHRoaXMubG9jYWwuc2V0RW5jcnlwdGlvbih0aGlzLmdldFdyaXRlckVuY3J5cHRpb24oKSkKICAgICAgdGhpcy5fcHJpbWFyeUJvb3RzdHJhcC5zZXRFbmNyeXB0aW9uKHRoaXMuZ2V0V3JpdGVyRW5jcnlwdGlvbigpKQogICAgfQoKICAgIGlmICh0aGlzLm51a2VUaXApIGF3YWl0IHRoaXMuX251a2VUaXAoKQoKICAgIHRoaXMubG9jYWwub24oJ2FwcGVuZCcsIHRoaXMuX29ubG9jYWx3cml0ZXJjaGFuZ2VCb3VuZCkKCiAgICB0aGlzLndha2V1cENhcGFiaWxpdHkgPSAoYXdhaXQgdGhpcy5faGFuZGxlcnMud2FrZXVwQ2FwYWJpbGl0eSkgfHwgewogICAgICBrZXk6IHRoaXMua2V5LAogICAgICBkaXNjb3ZlcnlLZXk6IHRoaXMuZGlzY292ZXJ5S2V5CiAgICB9CiAgICB0aGlzLnNldFdha2V1cCh0aGlzLndha2V1cENhcGFiaWxpdHkua2V5LCB0aGlzLndha2V1cENhcGFiaWxpdHkuZGlzY292ZXJ5S2V5KQogIH0KCiAgYXN5bmMgX251a2VUaXBCYXRjaChrZXksIGxlbmd0aCkgewogICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsga2V5LCBhY3RpdmU6IGZhbHNlIH0pCiAgICBhd2FpdCBjb3JlLnJlYWR5KCkKCiAgICBjb25zdCBiYXRjaCA9IGNvcmUuc2Vzc2lvbih7IG5hbWU6ICdiYXRjaCcgfSkKICAgIGF3YWl0IGJhdGNoLnJlYWR5KCkKICAgIGlmIChiYXRjaC5sZW5ndGggPiBsZW5ndGgpIGF3YWl0IGJhdGNoLnRydW5jYXRlKGxlbmd0aCkKICAgIGF3YWl0IGJhdGNoLmNsb3NlKCkKCiAgICBhd2FpdCBjb3JlLmNsb3NlKCkKICB9CgogIC8vIFRPRE86IG5vdCBhdG9taWMgYXRtLCBzbyBtb3JlIG9mIGEgKHZlcnkgdXNlZnVsKSBkZWJ1ZyBoZWxwZXIKICBhc3luYyBfbnVrZVRpcCgpIHsKICAgIGNvbnN0IHBvaW50ZXIgPSBhd2FpdCB0aGlzLmxvY2FsLmdldFVzZXJEYXRhKCdhdXRvYmFzZS9ib290JykKICAgIGlmICghcG9pbnRlcikgcmV0dXJuCgogICAgY29uc3QgYm9vdCA9IGMuZGVjb2RlKG1lc3NhZ2VzLkJvb3RSZWNvcmQsIHBvaW50ZXIpCgogICAgYXdhaXQgTG9jYWxTdGF0ZS5jbGVhcih0aGlzLmxvY2FsKQoKICAgIGF3YWl0IHRoaXMuX251a2VUaXBCYXRjaChib290LmtleSwgYm9vdC5zeXN0ZW1MZW5ndGgpCgogICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsga2V5OiBib290LmtleSwgYWN0aXZlOiBmYWxzZSwgZW5jcnlwdGlvbjogbnVsbCB9KQogICAgY29uc3QgZW5jQ29yZSA9IGF3YWl0IEVuY3J5cHRpb25WaWV3LnNldFN5c3RlbUVuY3J5cHRpb24odGhpcywgY29yZSkKCiAgICBjb25zdCBiYXRjaCA9IGNvcmUuc2Vzc2lvbih7IG5hbWU6ICdiYXRjaCcgfSkKICAgIGF3YWl0IGJhdGNoLnJlYWR5KCkKCiAgICBjb25zdCBpbmZvID0gYXdhaXQgU3lzdGVtVmlldy5nZXRJbmRleGVkSW5mbyhiYXRjaCwgYm9vdC5zeXN0ZW1MZW5ndGgpCiAgICBhd2FpdCBiYXRjaC5jbG9zZSgpCgogICAgZm9yIChjb25zdCB2aWV3IG9mIGluZm8udmlld3MpIHsKICAgICAgLy8gZW5zdXJlIGFueSB2aWV3cyByZWYnZWQgYnkgc3lzdGVtIGFyZSBjb25zaXN0ZW50IGFzIHdlbGwKICAgICAgYXdhaXQgdGhpcy5fbnVrZVRpcEJhdGNoKHZpZXcua2V5LCB2aWV3Lmxlbmd0aCkKICAgIH0KCiAgICBpZiAoYm9vdC5oZWFkcykgdGhpcy5oaW50V2FrZXVwKGJvb3QuaGVhZHMpCiAgICBpZiAodGhpcy5sb2NhbC5sZW5ndGgpIHRoaXMuaGludFdha2V1cChbeyBrZXk6IHRoaXMubG9jYWwua2V5LCBsZW5ndGg6IHRoaXMubG9jYWwubGVuZ3RoIH1dKQoKICAgIGF3YWl0IGNvcmUuY2xvc2UoKQogICAgaWYgKGVuY0NvcmUpIGF3YWl0IGVuY0NvcmUuY2xvc2UoKQogIH0KCiAgX2J1bXBXYWtldXBQZWVyKHBlZXIpIHsKICAgIGlmICh0aGlzLl9jb3VwbGVyKSB0aGlzLl9jb3VwbGVyLnVwZGF0ZShwZWVyLnN0cmVhbSkKICB9CgogIGFzeW5jIF9yb3RhdGVMb2NhbFdyaXRlcihuZXdMb2NhbCkgewogICAgYXNzZXJ0KCF0aGlzLmFwcGVuZGluZywgJ0Nhbm5vdCByb3RhdGUgYSBuZXdMb2NhbCB3cml0ZXIgaWYgYW4gYXBwZW5kIGlzIGluIHByb2dyZXNzJykKCiAgICBjb25zdCBvbGRMb2NhbCA9IHRoaXMubG9jYWwKCiAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZSkgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5jbG9zZSgpCgogICAgdGhpcy5sb2NhbCA9IG5ld0xvY2FsCiAgICB0aGlzLmxvY2FsLm9uKCdhcHBlbmQnLCB0aGlzLl9vbmxvY2Fsd3JpdGVyY2hhbmdlQm91bmQpCgogICAgdGhpcy5sb2NhbFdyaXRlciA9IG51bGwKICAgIHRoaXMuX3VwZGF0ZUxvY2FsQ29yZSA9IG51bGwKCiAgICBjb25zdCBzdG9yZSA9IHRoaXMuX3ZpZXdTdG9yZS5hdG9taXplKCkKCiAgICBjb25zdCBsb2NhbCA9IHN0b3JlLmdldExvY2FsKCkKICAgIGF3YWl0IGxvY2FsLnJlYWR5KCkKCiAgICBhd2FpdCBMb2NhbFN0YXRlLm1vdmVUbyhvbGRMb2NhbCwgbG9jYWwpCgogICAgYXdhaXQgbG9jYWwuc2V0VXNlckRhdGEoJ3JlZmVycmVyJywgdGhpcy5rZXkpCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uS2V5KSBhd2FpdCBsb2NhbC5zZXRVc2VyRGF0YSgnYXV0b2Jhc2UvZW5jcnlwdGlvbicsIHRoaXMuZW5jcnlwdGlvbktleSkKCiAgICBhd2FpdCBzdG9yZS5mbHVzaCgpCiAgICBhd2FpdCBzdG9yZS5jbG9zZSgpCgogICAgYXdhaXQgdGhpcy5fcHJpbWFyeUJvb3RzdHJhcC5zZXRVc2VyRGF0YSgnYXV0b2Jhc2UvbG9jYWwnLCBsb2NhbC5rZXkpCgogICAgYXdhaXQgdGhpcy5fY2xlYXJXcml0ZXJzKCkKICAgIGF3YWl0IG9sZExvY2FsLmNsb3NlKCkKCiAgICAvLyBkb25lLCBzb2Z0IHJlYm9vdAoKICAgIGF3YWl0IHRoaXMuX3ZpZXdTdG9yZS51cGRhdGVMb2NhbCgpCgogICAgYXdhaXQgdGhpcy5fY2xlYXJXcml0ZXJzKCkKCiAgICB0aGlzLl9hcHBseVN0YXRlID0gbmV3IEFwcGx5U3RhdGUodGhpcykKICAgIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUucmVhZHkoKQogICAgYXdhaXQgdGhpcy5fbWFrZUxpbmVhcml6ZXJGcm9tVmlld1N0YXRlKCkKCiAgICB0aGlzLl9jYXVnaHR1cCA9IGZhbHNlCgogICAgdGhpcy5fcmVib290ZWQoKQoKICAgIHRoaXMuZW1pdCgncm90YXRlLWxvY2FsLXdyaXRlcicpCiAgfQoKICBhc3luYyBzZXRMb2NhbChrZXksIHsga2V5UGFpciB9ID0ge30pIHsKICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIGNvbnN0IG1hbmlmZXN0ID0ga2V5UGFpcgogICAgICA/IHsgdmVyc2lvbjogdGhpcy5zdG9yZS5tYW5pZmVzdFZlcnNpb24sIHNpZ25lcnM6IFt7IHB1YmxpY0tleToga2V5UGFpci5wdWJsaWNLZXkgfV0gfQogICAgICA6IG51bGwKICAgIGlmICgha2V5KSBrZXkgPSBIeXBlcmNvcmUua2V5KG1hbmlmZXN0KQogICAgLy8gSWYgdGhlIGtleXMgYXJlIHRoZSBzYW1lLCBubyBuZWVkIHRvIHJvdGF0ZQogICAgaWYgKGI0YS5lcXVhbHMoa2V5LCB0aGlzLmxvY2FsLmtleSkpIHJldHVybgoKICAgIGNvbnN0IGVuY3J5cHRpb24gPSB0aGlzLmVuY3J5cHRpb25LZXkgPyB0aGlzLmdldFdyaXRlckVuY3J5cHRpb24oKSA6IG51bGwKCiAgICBjb25zdCBsb2NhbCA9IHRoaXMuc3RvcmUuZ2V0KHsKICAgICAga2V5LAogICAgICBtYW5pZmVzdCwKICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgZXhjbHVzaXZlOiB0cnVlLAogICAgICBlbmNyeXB0aW9uLAogICAgICB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UKICAgIH0pCiAgICBhd2FpdCBsb2NhbC5yZWFkeSgpCgogICAgdGhpcy5fdXBkYXRlTG9jYWxDb3JlID0gbG9jYWwKCiAgICBsZXQgcnVucyA9IDAKICAgIHdoaWxlICghdGhpcy5faW50ZXJydXB0aW5nICYmIHRoaXMuYXBwZW5kaW5nICYmIHJ1bnMrKyA8IDE2KSBhd2FpdCB0aGlzLnVwZGF0ZSgpCiAgICBhd2FpdCB0aGlzLl9idW1wKCkKICB9CgogIHNldFdha2V1cChjYXAsIGRpc2NvdmVyeUtleSkgewogICAgaWYgKHRoaXMud2FrZXVwU2Vzc2lvbikgdGhpcy53YWtldXBTZXNzaW9uLmRlc3Ryb3koKQogICAgaWYgKCFkaXNjb3ZlcnlLZXkgJiYgYjRhLmVxdWFscyhjYXAsIHRoaXMua2V5KSkgZGlzY292ZXJ5S2V5ID0gdGhpcy5kaXNjb3ZlcnlLZXkKICAgIHRoaXMud2FrZXVwU2Vzc2lvbiA9IHRoaXMud2FrZXVwUHJvdG9jb2wuc2Vzc2lvbigKICAgICAgY2FwLAogICAgICBuZXcgV2FrZXVwSGFuZGxlcih0aGlzLCBkaXNjb3ZlcnlLZXkgfHwgbnVsbCkKICAgICkKCiAgICAvLyBpbmNhc2UgdGhpcyBzZXNzaW9uIGhhcyBhY3RpdmUgcGVlcnMgYWxyZWFkeSwgYnVtcCB0aGUgY291cGxlcgogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMud2FrZXVwU2Vzc2lvbi5wZWVycykgewogICAgICBpZiAocGVlci5hY3RpdmUpIHRoaXMuX2J1bXBXYWtldXBQZWVyKHBlZXIpCiAgICB9CiAgfQoKICBhc3luYyBfZ2V0TWlncmF0aW9uUG9pbnRlcihrZXksIGxlbmd0aCkgewogICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsga2V5LCBhY3RpdmU6IGZhbHNlLCBlbmNyeXB0aW9uOiBudWxsIH0pCiAgICBjb25zdCBlbmNDb3JlID0gYXdhaXQgRW5jcnlwdGlvblZpZXcuc2V0U3lzdGVtRW5jcnlwdGlvbih0aGlzLCBjb3JlKQoKICAgIGNvbnN0IG1pbiA9IGNvcmUubWFuaWZlc3QgJiYgY29yZS5tYW5pZmVzdC5wcm9sb2d1ZSA/IGNvcmUubWFuaWZlc3QucHJvbG9ndWUubGVuZ3RoIDogMAoKICAgIGZvciAobGV0IGkgPSBsZW5ndGggLSAxOyBpID49IG1pbjsgaS0tKSB7CiAgICAgIGlmICghKGF3YWl0IGNvcmUuaGFzKGkpKSkgY29udGludWUKCiAgICAgIGNvbnN0IHN5cyA9IG5ldyBTeXN0ZW1WaWV3KGNvcmUsIHsgY2hlY2tvdXQ6IGkgKyAxIH0pCiAgICAgIGF3YWl0IHN5cy5yZWFkeSgpCgogICAgICBsZXQgZ29vZCA9IHRydWUKCiAgICAgIGZvciAoY29uc3QgdiBvZiBzeXMudmlld3MpIHsKICAgICAgICBjb25zdCB2YyA9IHRoaXMuc3RvcmUuZ2V0KHsga2V5OiB2LmtleSwgYWN0aXZlOiBmYWxzZSB9KQogICAgICAgIGF3YWl0IHZjLnJlYWR5KCkKICAgICAgICBpZiAodmMubGVuZ3RoIDwgdi5sZW5ndGgpIGdvb2QgPSBmYWxzZQogICAgICAgIGF3YWl0IHZjLmNsb3NlKCkKICAgICAgfQoKICAgICAgYXdhaXQgc3lzLmNsb3NlKCkKICAgICAgaWYgKCFnb29kKSBjb250aW51ZQoKICAgICAgcmV0dXJuIGkgKyAxCiAgICB9CgogICAgYXdhaXQgY29yZS5jbG9zZSgpCiAgICBpZiAoZW5jQ29yZSkgYXdhaXQgZW5jQ29yZS5jbG9zZSgpCgogICAgcmV0dXJuIG1pbgogIH0KCiAgLy8gbWlncmF0aW5nIGZyb20gNiAtPiBsYXRlc3QKICBhc3luYyBfbWlncmF0ZTYoa2V5LCBsZW5ndGgpIHsKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7IGtleSwgYWN0aXZlOiBmYWxzZSB9KQogICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICBjb25zdCBiYXRjaCA9IGNvcmUuc2Vzc2lvbih7IG5hbWU6ICdiYXRjaCcsIG92ZXJ3cml0ZTogdHJ1ZSwgY2hlY2tvdXQ6IGxlbmd0aCB9KQogICAgYXdhaXQgYmF0Y2gucmVhZHkoKQogICAgYXdhaXQgYmF0Y2guY2xvc2UoKQogICAgYXdhaXQgY29yZS5jbG9zZSgpCiAgfQoKICAvLyBjYWxsZWQgYnkgdmlldy1zdG9yZSBmb3IgYm9vdHN0cmFwcGluZwogIGFzeW5jIF9nZXRTeXN0ZW1JbmZvKCkgewogICAgY29uc3QgYm9vdCA9IGF3YWl0IHRoaXMuX2dldEJvb3RSZWNvcmQoKQogICAgaWYgKCFib290LmtleSkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBtaWdyYXRlZCA9ICEhYm9vdC5oZWFkcwogICAgY29uc3QgaW5kZXhlZExlbmd0aCA9IGJvb3Quc3lzdGVtTGVuZ3RoCgogICAgaWYgKG1pZ3JhdGVkKSB7CiAgICAgIC8vIGVuc3VyZSBzeXN0ZW0gYmF0Y2ggaXMgY29uc2lzdGVudCBvbiBpbml0aWFsIG1pZ3JhdGlvbgogICAgICBhd2FpdCB0aGlzLl9taWdyYXRlNihib290LmtleSwgaW5kZXhlZExlbmd0aCkKICAgIH0KCiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoeyBrZXk6IGJvb3Qua2V5LCBlbmNyeXB0aW9uOiBudWxsLCBhY3RpdmU6IGZhbHNlIH0pCiAgICBhd2FpdCBjb3JlLnJlYWR5KCkKCiAgICBjb25zdCBiYXRjaCA9IGNvcmUuc2Vzc2lvbih7IG5hbWU6ICdiYXRjaCcgfSkKICAgIGNvbnN0IGVuY0NvcmUgPSBhd2FpdCBFbmNyeXB0aW9uVmlldy5zZXRTeXN0ZW1FbmNyeXB0aW9uKHRoaXMsIGJhdGNoKQoKICAgIGNvbnN0IGluZm8gPSBhd2FpdCBTeXN0ZW1WaWV3LmdldEluZGV4ZWRJbmZvKGJhdGNoLCBpbmRleGVkTGVuZ3RoKQoKICAgIGlmIChlbmNDb3JlKSBhd2FpdCBlbmNDb3JlLmNsb3NlKCkKICAgIGF3YWl0IGJhdGNoLmNsb3NlKCkKICAgIGF3YWl0IGNvcmUuY2xvc2UoKQoKICAgIGlmIChpbmZvLnZlcnNpb24gPiBNQVhfQVVUT0JBU0VfVkVSU0lPTikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F1dG9iYXNlIHVwZ3JhZGUgcmVxdWlyZWQuJykKICAgIH0KCiAgICAvLyBqdXN0IGNvbXBhdAogICAgaWYgKG1pZ3JhdGVkKSB7CiAgICAgIHRoaXMubWlncmF0ZWQgPSB0cnVlCgogICAgICBmb3IgKGNvbnN0IHZpZXcgb2YgaW5mby52aWV3cykgewogICAgICAgIC8vIGVuc3VyZSBhbnkgdmlld3MgcmVmJ2VkIGJ5IHN5c3RlbSBhcmUgY29uc2lzdGVudCBhcyB3ZWxsCiAgICAgICAgYXdhaXQgdGhpcy5fbWlncmF0ZTYodmlldy5rZXksIHZpZXcubGVuZ3RoKQogICAgICB9CgogICAgICBpZiAoYm9vdC5oZWFkcykgdGhpcy5oaW50V2FrZXVwKGJvb3QuaGVhZHMpCiAgICAgIGlmICh0aGlzLmxvY2FsLmxlbmd0aCkgdGhpcy5oaW50V2FrZXVwKFt7IGtleTogdGhpcy5sb2NhbC5rZXksIGxlbmd0aDogdGhpcy5sb2NhbC5sZW5ndGggfV0pCiAgICB9CgogICAgcmV0dXJuIHsKICAgICAga2V5OiBib290LmtleSwKICAgICAgaW5kZXhlcnM6IGluZm8uaW5kZXhlcnMsCiAgICAgIHZpZXdzOiBpbmZvLnZpZXdzLAogICAgICBlbnRyb3B5OiBpbmZvLmVudHJvcHkKICAgIH0KICB9CgogIC8vIGNhbGxlZCBieSB0aGUgYXBwbHkgc3RhdGUgZm9yIGJvb3RzdHJhcHBpbmcKICBhc3luYyBfZ2V0Qm9vdFJlY29yZCgpIHsKICAgIGF3YWl0IHRoaXMuX3ByZW9wZW4KCiAgICBjb25zdCBwb2ludGVyID0gYXdhaXQgdGhpcy5sb2NhbC5nZXRVc2VyRGF0YSgnYXV0b2Jhc2UvYm9vdCcpCgogICAgY29uc3QgYm9vdCA9IHBvaW50ZXIKICAgICAgPyBjLmRlY29kZShtZXNzYWdlcy5Cb290UmVjb3JkLCBwb2ludGVyKQogICAgICA6IHsKICAgICAgICAgIHZlcnNpb246IEJPT1RfUkVDT1JEX1ZFUlNJT04sCiAgICAgICAgICBrZXk6IG51bGwsCiAgICAgICAgICBzeXN0ZW1MZW5ndGg6IDAsCiAgICAgICAgICBpbmRleGVyc1VwZGF0ZWQ6IGZhbHNlLAogICAgICAgICAgZmFzdEZvcndhcmRpbmc6IGZhbHNlLAogICAgICAgICAgcmVjb3ZlcmllczogUkVDT1ZFUklFUywKICAgICAgICAgIGhlYWRzOiBudWxsCiAgICAgICAgfQoKICAgIGlmIChib290LmhlYWRzKSB7CiAgICAgIGNvbnN0IGxlbiA9IGF3YWl0IHRoaXMuX2dldE1pZ3JhdGlvblBvaW50ZXIoYm9vdC5rZXksIGJvb3Quc3lzdGVtTGVuZ3RoKQogICAgICBpZiAobGVuICE9PSBib290LnN5c3RlbUxlbmd0aCkKICAgICAgICB0aGlzLl93YXJuKAogICAgICAgICAgbmV3IEVycm9yKAogICAgICAgICAgICAnSW52YWxpZCBwb2ludGVyIGluIG1pZ3JhdGlvbiwgY29ycmVjdGluZyAoJyArIGxlbiArICcgdnMgJyArIGJvb3Quc3lzdGVtTGVuZ3RoICsgJyknCiAgICAgICAgICApCiAgICAgICAgKQogICAgICBib290LnN5c3RlbUxlbmd0aCA9IGxlbgogICAgfQoKICAgIHJldHVybiBib290CiAgfQoKICBzdGF0aWMgYXN5bmMgZ2V0Qm9vdFJlY29yZChzdG9yZSwga2V5KSB7CiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBib290KHN0b3JlLCBrZXksIHsgZXhjbHVzaXZlOiBmYWxzZSB9KQogICAgYXdhaXQgcmVzdWx0LmJvb3RzdHJhcC5jbG9zZSgpCiAgICBhd2FpdCByZXN1bHQubG9jYWwuY2xvc2UoKQogICAgcmV0dXJuIHJlc3VsdC5ib290CiAgfQoKICBfaW50ZXJydXB0KHJlYXNvbikgewogICAgYXNzZXJ0KCEhdGhpcy5fYXBwbHlTdGF0ZS5hcHBseWluZywgJ0ludGVycnVwdCBpcyBvbmx5IGFsbG93ZWQgaW4gYXBwbHknKQogICAgdGhpcy5faW50ZXJydXB0aW5nID0gdHJ1ZQogICAgaWYgKHJlYXNvbikgdGhpcy5pbnRlcnJ1cHRlZCA9IHJlYXNvbgogICAgdGhyb3cgSU5URVJSVVBUCiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGlmICh0aGlzLl9mbHVzaGluZyA9PT0gMCkgcmV0dXJuCiAgICByZXR1cm4gdGhpcy5fZmx1c2hTaWduYWwud2FpdCgpCiAgfQoKICBhc3luYyBhZHZhbmNlKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBhd2FpdCB0aGlzLl9hZHZhbmNpbmcKICB9CgogIHJlY291cGxlKCkgewogICAgaWYgKHRoaXMuX2NvdXBsZXIpIHRoaXMuX2NvdXBsZXIuZGVzdHJveSgpCiAgICBjb25zdCBjb3JlID0gdGhpcy5fdmlld1N0b3JlLmdldFN5c3RlbUNvcmUoKQogICAgdGhpcy5fY291cGxlciA9IG5ldyBDb3JlQ291cGxlcihjb3JlLCB0aGlzLl93YWtldXBQZWVyQm91bmQpCiAgfQoKICBfdXBkYXRlQm9vdHN0cmFwV3JpdGVycygpIHsKICAgIGNvbnN0IHdyaXRlcnMgPSB0aGlzLmxpbmVhcml6ZXIuZ2V0Qm9vdHN0cmFwV3JpdGVycygpCgogICAgLy8gZmlyc3QgY2xlYXIgYWxsLCBidXQgd2l0aG91dCBhcHBseWluZyBpdCBmb3IgY2h1cm4gcmVhc29ucwogICAgZm9yIChjb25zdCB3cml0ZXIgb2YgdGhpcy5fYm9vdHN0cmFwV3JpdGVycykgewogICAgICB3cml0ZXIuaXNCb290c3RyYXAgPSBmYWxzZQogICAgICB3cml0ZXIuaXNDb3VwbGVkID0gZmFsc2UKICAgIH0KCiAgICAvLyBhbGwgcGFzc2VkIGFyZSBib290c3RyYXBzCiAgICBmb3IgKGNvbnN0IHdyaXRlciBvZiB3cml0ZXJzKSB7CiAgICAgIHdyaXRlci5pc0NvdXBsZWQgPSB0cnVlCiAgICAgIHdyaXRlci5zZXRCb290c3RyYXAodHJ1ZSkKICAgIH0KCiAgICAvLyByZXNldCBhY3Rpdml0eSBvbiBvbGQgb25lcywgYWxsIHNob3VsZCBiZSBpbiBzeW5jIG5vdwogICAgZm9yIChjb25zdCB3cml0ZXIgb2YgdGhpcy5fYm9vdHN0cmFwV3JpdGVycykgewogICAgICBpZiAod3JpdGVyLmlzQm9vdHN0cmFwID09PSBmYWxzZSkgd3JpdGVyLnNldEJvb3RzdHJhcChmYWxzZSkKICAgIH0KCiAgICB0aGlzLl9ib290c3RyYXBXcml0ZXJzID0gd3JpdGVycwogICAgdGhpcy5fYm9vdHN0cmFwV3JpdGVyc0NoYW5nZWQgPSBmYWxzZQogIH0KCiAgYXN5bmMgX29wZW5MaW5lYXJpemVyKCkgewogICAgaWYgKHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmJvb3RzdHJhcHBpbmcpIHsKICAgICAgYXdhaXQgdGhpcy5fbWFrZUxpbmVhcml6ZXIobnVsbCkKICAgICAgdGhpcy5fYm9vdHN0cmFwTGluZWFyaXplcigpCiAgICAgIHJldHVybgogICAgfQoKICAgIGF3YWl0IHRoaXMuX21ha2VMaW5lYXJpemVyRnJvbVZpZXdTdGF0ZSgpCiAgfQoKICBhc3luYyBfY2F0Y2h1cEFwcGx5U3RhdGUoKSB7CiAgICBpZiAoYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5zaG91bGRNaWdyYXRlKCkpIHsKICAgICAgYXdhaXQgdGhpcy5fbWlncmF0ZSgpCiAgICB9IGVsc2UgaWYgKCEoYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5jYXRjaHVwKHRoaXMubGluZWFyaXplcikpKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIHRoaXMuX2NhdWdodHVwID0gdHJ1ZQogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgdGhpcy5fcHJlb3BlbiA9IHRoaXMuX3J1blByZU9wZW4oKQogICAgYXdhaXQgdGhpcy5fcHJlb3BlbgoKICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybgoKICAgIHRoaXMuX2FwcGx5U3RhdGUgPSBuZXcgQXBwbHlTdGF0ZSh0aGlzKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUucmVhZHkoKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybgoKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmNsb3NlKCkKICAgICAgfSBjYXRjaCB7fQoKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQogICAgICB9IGNhdGNoIHt9CgogICAgICB0aGlzLl9hcHBseVN0YXRlID0gbnVsbAogICAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4KCiAgICAgIHRocm93IGVycgogICAgfQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX29wZW5MaW5lYXJpemVyKCkKICAgICAgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKICAgICAgYXdhaXQgdGhpcy5fd2FrZXVwLnJlYWR5KCkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4KICAgICAgdGhyb3cgZXJyCiAgICB9CgogICAgaWYgKHRoaXMuY29yZS5sZW5ndGggLSB0aGlzLl9hcHBseVN0YXRlLmluZGV4ZWRMZW5ndGggPiB0aGlzLl9hY2tUaWNrVGhyZXNob2xkKSB7CiAgICAgIHRoaXMuX2Fja1RpY2sgPSB0aGlzLl9hY2tUaWNrVGhyZXNob2xkCiAgICB9CiAgICBpZiAodGhpcy5sb2NhbFdyaXRlciAmJiB0aGlzLl9hY2tJbnRlcnZhbCkgewogICAgICB0aGlzLl9zdGFydEFja1RpbWVyKCkKICAgIH0KCiAgICB0aGlzLl91cGRhdGVCb290c3RyYXBXcml0ZXJzKCkKCiAgICB0aGlzLnJlY291cGxlKCkKICAgIHRoaXMuX3F1ZXVlRmFzdEZvcndhcmQoKQoKICAgIC8vIHF1ZXVlIGEgZnVsbCBidW1wIHRoYXQgaGFuZGxlcyB3YWtldXAgZXRjIChub3QgbGVnYWwgdG8gd2FpdCBmb3IgdGhhdCBoZXJlKQogICAgdGhpcy5fcXVldWVCdW1wKCkKICB9CgogIGFzeW5jIF9jbG9zZSgpIHsKICAgIGF3YWl0IHRoaXMuZmx1c2goKSAvLyBmbHVzaCBhbGwgcGVuZGluZyBub24gbmV0d29yayBpbwogICAgdGhpcy5faW50ZXJydXB0aW5nID0gdHJ1ZQogICAgYXdhaXQgUHJvbWlzZS5yZXNvbHZlKCkgLy8gZGVmZXIgb25lIHRpY2sKCiAgICBpZiAodGhpcy53YWtldXBTZXNzaW9uKSB0aGlzLndha2V1cFNlc3Npb24uZGVzdHJveSgpCiAgICBpZiAodGhpcy53YWtldXBPd25lcikgdGhpcy53YWtldXBQcm90b2NvbC5kZXN0cm95KCkKCiAgICBpZiAodGhpcy5mYXN0Rm9yd2FyZGluZykgYXdhaXQgdGhpcy5mYXN0Rm9yd2FyZGluZy5jbG9zZSgpCgogICAgaWYgKHRoaXMuX2NvdXBsZXIpIHRoaXMuX2NvdXBsZXIuZGVzdHJveSgpCiAgICB0aGlzLl9jb3VwbGVyID0gbnVsbAogICAgdGhpcy5fd2FpdGluZy5ub3RpZnkobnVsbCkKCiAgICBhd2FpdCB0aGlzLmFjdGl2ZVdyaXRlcnMuY2xlYXIoKQoKICAgIGNvbnN0IGNsb3NpbmcgPSB0aGlzLl9hZHZhbmNpbmcgPyB0aGlzLl9hZHZhbmNpbmcuY2F0Y2goc2FmZXR5Q2F0Y2gpIDogbnVsbAoKICAgIGF3YWl0IHRoaXMuX2NsZWFyV3JpdGVycygpCiAgICBpZiAodGhpcy5fcHJpbWFyeUJvb3RzdHJhcCkgYXdhaXQgdGhpcy5fcHJpbWFyeUJvb3RzdHJhcC5jbG9zZSgpCiAgICBhd2FpdCB0aGlzLmxvY2FsLmNsb3NlKCkKCiAgICBpZiAodGhpcy5fYWNrVGltZXIpIHsKICAgICAgdGhpcy5fYWNrVGltZXIuc3RvcCgpCiAgICAgIGF3YWl0IHRoaXMuX2Fja1RpbWVyLmZsdXNoKCkKICAgIH0KCiAgICBhd2FpdCB0aGlzLl93YWtldXAuY2xvc2UoKQoKICAgIGlmICh0aGlzLl9oYXNDbG9zZSkgYXdhaXQgdGhpcy5faGFuZGxlcnMuY2xvc2UodGhpcy52aWV3KQogICAgaWYgKHRoaXMuX2FwcGx5U3RhdGUpIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuY2xvc2UoKQoKICAgIGF3YWl0IHRoaXMuX3ZpZXdTdG9yZS5jbG9zZSgpCiAgICBhd2FpdCB0aGlzLmNvcmUuY2xvc2UoKQogICAgYXdhaXQgdGhpcy5zdG9yZS5jbG9zZSgpCgogICAgaWYgKHRoaXMuX3dyaXRhYmxlKSB0aGlzLl93cml0YWJsZS5yZXNvbHZlKGZhbHNlKQoKICAgIGF3YWl0IGNsb3NpbmcKICB9CgogIGdldExhc3RFcnJvcigpIHsKICAgIHJldHVybiB0aGlzLl9sYXN0RXJyb3IKICB9CgogIF9vbkVycm9yKGVycikgewogICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuCgogICAgdGhpcy5fbGFzdEVycm9yID0gZXJyCgogICAgaWYgKGVyciA9PT0gSU5URVJSVVBUKSB7CiAgICAgIHRoaXMuZW1pdCgnaW50ZXJydXB0JywgdGhpcy5pbnRlcnJ1cHRlZCkKICAgICAgdGhpcy5lbWl0KCd1cGRhdGUnKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLmNsb3NlKCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCgogICAgLy8gaWYgbm8gb25lIGlzIGxpc3RlbmluZyB3ZSBzaG91bGQgY3Jhc2ghIHdlIGNhbm5vdCByZWx5IG9uIHRoZSBFRSBoZXJlCiAgICAvLyBhcyB0aGlzIGlzIHdyYXBwZWQgaW4gYSBwcm9taXNlIHNvIGluc3RlYWQgb2YgbmV4dFRpY2sgdGhyb3cgaXQKICAgIGlmIChSZWFkeVJlc291cmNlLmxpc3RlbmVyQ291bnQodGhpcywgJ2Vycm9yJykgPT09IDApIHsKICAgICAgY3Jhc2hTb29uKGVycikKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5lbWl0KCdlcnJvcicsIGVycikKICB9CgogIGFzeW5jIF9jbG9zZVdyaXRlcih3KSB7CiAgICB0aGlzLmFjdGl2ZVdyaXRlcnMuZGVsZXRlKHcpCiAgICBhd2FpdCB3LmNsb3NlKCkKICB9CgogIGFzeW5jIF9nY1dyaXRlcnMoKSB7CiAgICAvLyBqdXN0IHJldHVybiBlYXJseSwgd2h5IG5vdAogICAgaWYgKHRoaXMuX2NoZWNrV3JpdGVycy5sZW5ndGggPT09IDApIHJldHVybgoKICAgIHdoaWxlICh0aGlzLl9jaGVja1dyaXRlcnMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCB3ID0gdGhpcy5fY2hlY2tXcml0ZXJzLnBvcCgpCgogICAgICAvLyBkb2VzbnQgaHVydAogICAgICB3LnVwZGF0ZUFjdGl2aXR5KCkKCiAgICAgIGlmICghdy5mbHVzaGVkKCkpIGNvbnRpbnVlCgogICAgICBjb25zdCB1bnF1ZXVlZCA9IHRoaXMuX3dha2V1cC51bnF1ZXVlKHcuY29yZS5rZXksIHcuY29yZS5sZW5ndGgpCgogICAgICBpZiAoIXVucXVldWVkIHx8IHcuaXNBY3RpdmVJbmRleGVyKSBjb250aW51ZQogICAgICBpZiAodGhpcy5sb2NhbFdyaXRlciA9PT0gdykgY29udGludWUKCiAgICAgIGF3YWl0IHRoaXMuX2Nsb3NlV3JpdGVyKHcpCiAgICB9CgogICAgYXdhaXQgdGhpcy5fd2FrZXVwLmZsdXNoKCkKICB9CgogIF9zdGFydEFja1RpbWVyKCkgewogICAgaWYgKHRoaXMuX2Fja1RpbWVyKSByZXR1cm4KICAgIHRoaXMuX2Fja1RpbWVyID0gbmV3IFRpbWVyKHRoaXMuX2JhY2tncm91bmRBY2suYmluZCh0aGlzKSwgdGhpcy5fYWNrSW50ZXJ2YWwpCiAgICB0aGlzLl9idW1wQWNrVGltZXIoKQogIH0KCiAgX2J1bXBBY2tUaW1lcigpIHsKICAgIGlmICghdGhpcy5fYWNrVGltZXIpIHJldHVybgogICAgdGhpcy5fYWNrVGltZXIuYnVtcCgpCiAgfQoKICBhc3luYyB1cGRhdGUoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9idW1wKCkKICAgICAgaWYgKHRoaXMuX2Fja2luZykgYXdhaXQgdGhpcy5fYnVtcCgpIC8vIGlmIGFja2luZyBqdXN0IHJlYnVtcCBpbmNhc2UgaXQgd2FzIHRyaWdnZXJlZCBmcm9tIGFib3ZlLi4uCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKHRoaXMuX2ludGVycnVwdGluZykgcmV0dXJuCiAgICAgIHRocm93IGVycgogICAgfQogIH0KCiAgLy8gcnVucyBpbiBiZywgbm90IGFsbG93ZWQgdG8gdGhyb3cKICAvLyBUT0RPOiByZWZhY3RvciBzbyB0aGlzIG9ubHkgbW92ZXMgdGhlIHdyaXRlciBhZmZlY3RlZCB0byBhIHVwZGF0ZWQgc2V0CiAgYXN5bmMgX29ucmVtb3Rld3JpdGVyY2hhbmdlKCkgewogICAgdGhpcy5fYnVtcEFja1RpbWVyKCkKCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9idW1wKCkKICAgIH0gY2F0Y2gge30KICB9CgogIF9vbmxvY2Fsd3JpdGVyY2hhbmdlKCkgewogICAgaWYgKCF0aGlzLmxvY2FsV3JpdGVyIHx8IHRoaXMubG9jYWxXcml0ZXIuaXNSZW1vdmVkKSB0aGlzLl9xdWV1ZUJ1bXAoKQogIH0KCiAgX29ud2FrZXVwKCkgewogICAgdGhpcy5fbmVlZHNXYWtldXAgPSB0cnVlCiAgICB0aGlzLl9xdWV1ZUJ1bXAoKQogIH0KCiAgaXNGYXN0Rm9yd2FyZGluZygpIHsKICAgIGlmICh0aGlzLmZhc3RGb3J3YXJkVG8gIT09IG51bGwpIHJldHVybiB0cnVlCiAgICByZXR1cm4gdGhpcy5mYXN0Rm9yd2FyZEVuYWJsZWQgJiYgdGhpcy5mYXN0Rm9yd2FyZGluZyAhPT0gbnVsbAogIH0KCiAgX2JhY2tncm91bmRBY2soKSB7CiAgICByZXR1cm4gdGhpcy5hY2sodHJ1ZSkKICB9CgogIGFzeW5jIGFjayhiZyA9IGZhbHNlKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyID09PSBudWxsIHx8IHRoaXMuX2Fja2luZyB8fCB0aGlzLl9pbnRlcnJ1cHRpbmcgfHwgdGhpcy5fYXBwZW5kaW5nICE9PSBudWxsKQogICAgICByZXR1cm4KCiAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZSA9PT0gbnVsbCkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuX2J1bXAoKQogICAgICB9IGNhdGNoIHt9CiAgICAgIGlmICh0aGlzLl9hcHBseVN0YXRlID09PSBudWxsIHx8IHRoaXMuX2ludGVycnVwdGluZykgcmV0dXJuCiAgICB9CgogICAgY29uc3QgYXBwbHlTdGF0ZSA9IHRoaXMuX2FwcGx5U3RhdGUKICAgIGlmIChhcHBseVN0YXRlLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IGFwcGx5U3RhdGUucmVhZHkoKQoKICAgIGNvbnN0IGlzUGVuZGluZ0luZGV4ZXIgPSBhcHBseVN0YXRlLmlzTG9jYWxQZW5kaW5nSW5kZXhlcigpCgogICAgLy8gaWYgbm8gb25lIGlzIHdhaXRpbmcgZm9yIG91ciBpbmRleCBtYW5pZmVzdCwgd2FpdCBmb3IgRkYgYmVmb3JlIHB1c2hpbmcgYW4gYWNrCiAgICBpZiAoKCFpc1BlbmRpbmdJbmRleGVyICYmIHRoaXMuaXNGYXN0Rm9yd2FyZGluZygpKSB8fCB0aGlzLl9pbnRlcnJ1cHRpbmcpIHJldHVybgoKICAgIGNvbnN0IGlzSW5kZXhlciA9IGFwcGx5U3RhdGUuaXNMb2NhbEluZGV4ZXIoKSB8fCBpc1BlbmRpbmdJbmRleGVyCiAgICBpZiAoIWlzSW5kZXhlcikgcmV0dXJuCgogICAgdGhpcy5fYWNraW5nID0gdHJ1ZQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2J1bXAoKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmICghdGhpcy5faW50ZXJydXB0aW5nKSB0aHJvdyBlcnIKICAgIH0KCiAgICBpZiAodGhpcy5faW50ZXJydXB0aW5nIHx8ICF0aGlzLmxvY2FsV3JpdGVyIHx8IHRoaXMubG9jYWxXcml0ZXIuY2xvc2VkKSB7CiAgICAgIHRoaXMuX2Fja2luZyA9IGZhbHNlCiAgICAgIHJldHVybgogICAgfQoKICAgIC8vIGF2b2lkIGx1bXBpbmcgYWNrcyB0b2dldGhlciBkdWUgdG8gdGhlIGJ1bXAgd2FpdCBoZXJlCiAgICBpZiAodGhpcy5fYWNrVGltZXIgJiYgYmcpIGF3YWl0IHRoaXMuX2Fja1RpbWVyLmFzYXBTdGFuZGFsb25lKCkKICAgIGlmICh0aGlzLl9pbnRlcnJ1cHRpbmcgfHwgYXBwbHlTdGF0ZS5jbG9zaW5nKSB7CiAgICAgIHRoaXMuX2Fja2luZyA9IGZhbHNlCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IGFsd2F5c1dyaXRlID0gaXNQZW5kaW5nSW5kZXhlciB8fCAoYXdhaXQgYXBwbHlTdGF0ZS5zaG91bGRXcml0ZSgpKQogICAgaWYgKHRoaXMuX2ludGVycnVwdGluZyB8fCBhcHBseVN0YXRlLmNsb3NpbmcpIHsKICAgICAgdGhpcy5fYWNraW5nID0gZmFsc2UKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgaGFzUGVuZGluZ0luZGV4ZXJzID0gYXBwbHlTdGF0ZS5zeXN0ZW0uaW5kZXhlcnMubGVuZ3RoID4gdGhpcy5saW5lYXJpemVyLmluZGV4ZXJzLmxlbmd0aAoKICAgIGlmIChhbHdheXNXcml0ZSB8fCB0aGlzLmxpbmVhcml6ZXIuc2hvdWxkQWNrKHRoaXMubG9jYWxXcml0ZXIsIGhhc1BlbmRpbmdJbmRleGVycykpIHsKICAgICAgdHJ5IHsKICAgICAgICBpZiAodGhpcy5sb2NhbFdyaXRlciAmJiAhdGhpcy5sb2NhbFdyaXRlci5jbG9zZWQpIGF3YWl0IHRoaXMuYXBwZW5kKG51bGwpCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmICghdGhpcy5faW50ZXJydXB0aW5nKSB0aHJvdyBlcnIKICAgICAgfQogICAgfQoKICAgIGlmICghdGhpcy5faW50ZXJydXB0aW5nKSB7CiAgICAgIHRoaXMuX3VwZGF0ZUFja1RocmVzaG9sZCgpCiAgICAgIHRoaXMuX2J1bXBBY2tUaW1lcigpCiAgICB9CgogICAgdGhpcy5fYWNraW5nID0gZmFsc2UKICB9CgogIHZpZXdzKCkgewogICAgaWYgKHRoaXMuX2FwcGx5U3RhdGUpIHJldHVybiB0aGlzLl9hcHBseVN0YXRlLnN0b3JlLmxpc3RWaWV3cygpCiAgICByZXR1cm4gdGhpcy5fdmlld1N0b3JlLmxpc3RWaWV3cygpCiAgfQoKICBiYXRjaCgpIHsKICAgIHJldHVybiBuZXcgQXBwZW5kQmF0Y2godGhpcykKICB9CgogIGFzeW5jIGFwcGVuZCh2YWx1ZSwgb3B0cykgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAodGhpcy5fYWR2YW5jaW5nICE9PSBudWxsKSBhd2FpdCB0aGlzLl9hZHZhbmNpbmcKICAgIHdoaWxlICh0aGlzLmFjdGl2ZUJhdGNoKSBhd2FpdCB0aGlzLmFjdGl2ZUJhdGNoLmZsdXNoZWQoKQogICAgcmV0dXJuIHRoaXMuX2FwcGVuZEJhdGNoKHZhbHVlLCBvcHRzKQogIH0KCiAgYXN5bmMgX2FwcGVuZEJhdGNoKHZhbHVlLCBvcHRzKSB7CiAgICBpZiAodGhpcy5faW50ZXJydXB0aW5nKSB0aHJvdyBuZXcgRXJyb3IoJ0F1dG9iYXNlIGlzIGNsb3NpbmcnKQogICAgaWYgKHZhbHVlICYmIHRoaXMudmFsdWVFbmNvZGluZyAhPT0gQklOQVJZX0VOQ09ESU5HKQogICAgICB2YWx1ZSA9IG5vcm1hbGl6ZSh0aGlzLnZhbHVlRW5jb2RpbmcsIHZhbHVlKQoKICAgIGNvbnN0IG9wdGltaXN0aWMgPSAhIW9wdHMgJiYgISFvcHRzLm9wdGltaXN0aWMgJiYgISF2YWx1ZQoKICAgIC8vIHdlIHdhbm5hIGFsbG93IGFja3Mgc28gaW50ZXJkZXhlcnMgY2FuIGZsdXNoCiAgICBpZiAoCiAgICAgICFvcHRpbWlzdGljICYmCiAgICAgICh0aGlzLmxvY2FsV3JpdGVyID09PSBudWxsIHx8ICh0aGlzLmxvY2FsV3JpdGVyLmlzUmVtb3ZlZCAmJiB2YWx1ZSAhPT0gbnVsbCkpCiAgICApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdOb3Qgd3JpdGFibGUnKQogICAgfQoKICAgIGlmICh0aGlzLl9hcHBlbmRpbmcgPT09IG51bGwpIHRoaXMuX2FwcGVuZGluZyA9IFtdCgogICAgbGV0IGxlbiA9IDAKICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICBmb3IgKGNvbnN0IHYgb2YgdmFsdWUpIGxlbiA9IHRoaXMuX2FwcGVuZCh2KQogICAgfSBlbHNlIHsKICAgICAgbGVuID0gdGhpcy5fYXBwZW5kKHZhbHVlKQogICAgfQoKICAgIGNvbnN0IGxvY2FsTGVuZ3RoID0gdGhpcy5sb2NhbC5sZW5ndGgKCiAgICBpZiAob3B0aW1pc3RpYykgdGhpcy5fb3B0aW1pc3RpYyA9IHRoaXMuX2FwcGVuZGluZy5sZW5ndGggLSAxCiAgICBjb25zdCB0YXJnZXQgPSB0aGlzLl9hcHBlbmRlZCArIHRoaXMuX2FwcGVuZGluZy5sZW5ndGgKCiAgICAvLyBhd2FpdCBpbiBjYXNlIGFwcGVuZCBpcyBpbiBjdXJyZW50IHRpY2sKICAgIGlmICh0aGlzLl9hZHZhbmNpbmcpIGF3YWl0IHRoaXMuX2FkdmFuY2luZwoKICAgIGxldCBydW5zID0gMAoKICAgIC8vIGJ1bXAgdW50aWwgd2UndmUgZmx1c2hlZCB0aGUgbm9kZXMKICAgIHdoaWxlICh0aGlzLl9hcHBlbmRlZCA8IHRhcmdldCAmJiAhdGhpcy5faW50ZXJydXB0aW5nKSB7CiAgICAgIGF3YWl0IHRoaXMuX2J1bXAoKQogICAgICAvLyBzYWZldHkKICAgICAgaWYgKHJ1bnMrKyA+PSAxNiAmJiB0aGlzLmxvY2FsV3JpdGVyICYmIHRoaXMubG9jYWxXcml0ZXIuaWRsZSgpKSBicmVhawogICAgfQoKICAgIGlmICh0aGlzLl9hZHZhbmNpbmcpIGF3YWl0IHRoaXMuX2FkdmFuY2luZwogICAgaWYgKHRoaXMuX2ludGVycnVwdGluZykgdGhyb3cgbmV3IEVycm9yKCdBdXRvYmFzZSBpcyBjbG9zaW5nJykKCiAgICByZXR1cm4gbG9jYWxMZW5ndGggKyBsZW4KICB9CgogIF9hcHBlbmQodmFsdWUpIHsKICAgIC8vIGlmIHByZXYgdmFsdWUgaXMgYW4gYWNrIHRoYXQgaGFzbnQgYmVlbiBmbHVzaGVkLCBza2lwIGl0CiAgICBpZiAodGhpcy5fYXBwZW5kaW5nLmxlbmd0aCA+IDApIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsKSByZXR1cm4gdGhpcy5fYXBwZW5kaW5nLmxlbmd0aAogICAgICBpZiAodGhpcy5fYXBwZW5kaW5nW3RoaXMuX2FwcGVuZGluZy5sZW5ndGggLSAxXSA9PT0gbnVsbCkgewogICAgICAgIHRoaXMuX2FwcGVuZGluZy5wb3AoKQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpcy5fYXBwZW5kaW5nLnB1c2godmFsdWUpCiAgfQoKICBzdGF0aWMgZGVjb2RlVmFsdWUodmFsdWUsIG9wdHMpIHsKICAgIHJldHVybiBkZWNvZGVWYWx1ZSh2YWx1ZSwgb3B0cykKICB9CgogIHN0YXRpYyBlbmNvZGVWYWx1ZSh2YWx1ZSwgb3B0cykgewogICAgcmV0dXJuIGVuY29kZVZhbHVlKHZhbHVlLCBvcHRzKQogIH0KCiAgc3RhdGljIGFzeW5jIGdldExvY2FsS2V5KHN0b3JlLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IGNvcmUgPSBvcHRzLmtleVBhaXIKICAgICAgPyBzdG9yZS5nZXQoeyAuLi5vcHRzLCBhY3RpdmU6IGZhbHNlIH0pCiAgICAgIDogc3RvcmUuZ2V0KHsgLi4ub3B0cywgbmFtZTogJ2xvY2FsJywgYWN0aXZlOiBmYWxzZSB9KQogICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICBjb25zdCBrZXkgPSBjb3JlLmtleQogICAgYXdhaXQgY29yZS5jbG9zZSgpCiAgICByZXR1cm4ga2V5CiAgfQoKICBzdGF0aWMgZ2V0TG9jYWxDb3JlKHN0b3JlLCBoYW5kbGVycywgZW5jcnlwdGlvbktleSkgewogICAgY29uc3QgZW5jcnlwdGlvbiA9ICFlbmNyeXB0aW9uS2V5ID8gbnVsbCA6IHsga2V5OiBlbmNyeXB0aW9uS2V5IH0KICAgIGNvbnN0IG9wdHMgPSB7CiAgICAgIC4uLmhhbmRsZXJzLAogICAgICBjb21wYXQ6IGZhbHNlLAogICAgICBhY3RpdmU6IGZhbHNlLAogICAgICBleGNsdXNpdmU6IHRydWUsCiAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZSwKICAgICAgZW5jcnlwdGlvbgogICAgfQogICAgcmV0dXJuIG9wdHMua2V5UGFpciA/IHN0b3JlLmdldChvcHRzKSA6IHN0b3JlLmdldCh7IC4uLm9wdHMsIG5hbWU6ICdsb2NhbCcgfSkKICB9CgogIHN0YXRpYyBhc3luYyBnZXRVc2VyRGF0YShjb3JlKSB7CiAgICBjb25zdCB2aWV3ID0gYXdhaXQgY29yZS5nZXRVc2VyRGF0YSgnYXV0b2Jhc2UvdmlldycpCgogICAgcmV0dXJuIHsKICAgICAgcmVmZXJyZXI6IGF3YWl0IGNvcmUuZ2V0VXNlckRhdGEoJ3JlZmVycmVyJyksCiAgICAgIHZpZXc6IHZpZXcgPyBiNGEudG9TdHJpbmcodmlldykgOiBudWxsCiAgICB9CiAgfQoKICBzdGF0aWMgYXN5bmMgaXNBdXRvYmFzZShjb3JlLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IGJsb2NrID0gYXdhaXQgY29yZS5nZXQoMCwgb3B0cykKICAgIGlmICghYmxvY2spIHRocm93IG5ldyBFcnJvcignQ29yZSBpcyBlbXB0eS4nKQogICAgaWYgKCFiNGEuaXNCdWZmZXIoYmxvY2spKSByZXR1cm4gaXNBdXRvYmFzZU1lc3NhZ2UoYmxvY2spCgogICAgdHJ5IHsKICAgICAgY29uc3QgbSA9IGMuZGVjb2RlKG1lc3NhZ2VzLk9wbG9nTWVzc2FnZSwgYmxvY2spCiAgICAgIHJldHVybiBpc0F1dG9iYXNlTWVzc2FnZShtKQogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0KCiAgLy8gbm8gZ3VhcmFudGVlcyB3aGVyZSB0aGUgdXNlciBkYXRhIGlzIHN0b3JlZCwganVzdCB0aGF0IGl0cyBhc3NvY2lhdGVkIHdpdGggdGhlIGJhc2UKICBhc3luYyBzZXRVc2VyRGF0YShrZXksIHZhbCkgewogICAgYXdhaXQgdGhpcy5fcHJlb3BlbgogICAgY29uc3QgY29yZSA9IHRoaXMuX3ByaW1hcnlCb290c3RyYXAgPT09IG51bGwgPyB0aGlzLmxvY2FsIDogdGhpcy5fcHJpbWFyeUJvb3RzdHJhcAoKICAgIGF3YWl0IGNvcmUuc2V0VXNlckRhdGEoa2V5LCB2YWwpCiAgfQoKICBhc3luYyBnZXRVc2VyRGF0YShrZXkpIHsKICAgIGF3YWl0IHRoaXMuX3ByZW9wZW4KICAgIGNvbnN0IGNvcmUgPSB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwID09PSBudWxsID8gdGhpcy5sb2NhbCA6IHRoaXMuX3ByaW1hcnlCb290c3RyYXAKCiAgICByZXR1cm4gYXdhaXQgY29yZS5nZXRVc2VyRGF0YShrZXkpCiAgfQoKICBfbmVlZHNMb2NhbFdyaXRlcigpIHsKICAgIHJldHVybiB0aGlzLmxvY2FsV3JpdGVyID09PSBudWxsIHx8IHRoaXMubG9jYWxXcml0ZXIuY2xvc2VkCiAgfQoKICAvLyBubyBndWFyYW50ZWVzIGFib3V0IHdyaXRlci5pc0FjdGl2ZUluZGV4ZXIgcHJvcGVydHkgaGVyZQogIGFzeW5jIF9nZXRXcml0ZXJCeUtleShrZXksIGxlbiwgc2VlbiwgYWxsb3dHQywgaXNBZGRlZCwgc3lzdGVtKSB7CiAgICBhc3NlcnQodGhpcy5fZHJhaW5pbmcgPT09IHRydWUgfHwgKHRoaXMub3BlbmluZyAmJiAhdGhpcy5vcGVuZWQpIHx8IHRoaXMuX29wdGltaXN0aWMgPiAtMSkKCiAgICBhd2FpdCB0aGlzLl9sb2NrLmxvY2soKQoKICAgIGlmICh0aGlzLl9pbnRlcnJ1cHRpbmcpIHsKICAgICAgdGhpcy5fbG9jay51bmxvY2soKQogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F1dG9iYXNlIGlzIGNsb3NpbmcnKQogICAgfQoKICAgIHRyeSB7CiAgICAgIGxldCB3ID0gdGhpcy5hY3RpdmVXcml0ZXJzLmdldChrZXkpCgogICAgICBjb25zdCBhbHJlYWR5QWN0aXZlID0gISF3CiAgICAgIGNvbnN0IHN5cyA9IHN5c3RlbSB8fCB0aGlzLl9hcHBseVN0YXRlLnN5c3RlbQogICAgICBjb25zdCB3cml0ZXJJbmZvID0gYXdhaXQgc3lzLmdldChrZXkpCgogICAgICBpZiAobGVuID09PSAtMSkgewogICAgICAgIGlmICghYWxsb3dHQyAmJiB3cml0ZXJJbmZvID09PSBudWxsKSB7CiAgICAgICAgICBpZiAodykgdy5pc1JlbW92ZWQgPSAhaXNBZGRlZAogICAgICAgICAgcmV0dXJuIG51bGwKICAgICAgICB9CgogICAgICAgIGxlbiA9IHdyaXRlckluZm8gPT09IG51bGwgPyAwIDogd3JpdGVySW5mby5sZW5ndGgKICAgICAgfQoKICAgICAgY29uc3QgaXNBY3RpdmUgPSB3cml0ZXJJbmZvICE9PSBudWxsICYmIChpc0FkZGVkIHx8ICF3cml0ZXJJbmZvLmlzUmVtb3ZlZCkKICAgICAgY29uc3QgaXNSZW1vdmVkID0gIWlzQWN0aXZlCgogICAgICBpZiAodykgewogICAgICAgIHcuaXNSZW1vdmVkID0gaXNSZW1vdmVkCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdyA9IHRoaXMuX21ha2VXcml0ZXIoa2V5LCBsZW4sIGlzQWN0aXZlLCBpc1JlbW92ZWQpCiAgICAgICAgaWYgKCF3KSByZXR1cm4gbnVsbAogICAgICB9CgogICAgICBpZiAoaXNSZW1vdmVkICYmIHN5cy5ib290c3RyYXBwaW5nICYmIGI0YS5lcXVhbHMody5jb3JlLmtleSwgdGhpcy5rZXkpKSB7CiAgICAgICAgdy5pc1JlbW92ZWQgPSBmYWxzZQogICAgICB9CgogICAgICBpZiAodGhpcy5faXNMb2NhbENvcmUody5jb3JlKSAmJiB0aGlzLl9uZWVkc0xvY2FsV3JpdGVyKCkpIHsKICAgICAgICB0aGlzLl9zZXRMb2NhbFdyaXRlcih3KQogICAgICB9CgogICAgICB3LnNlZW4oc2VlbikKCiAgICAgIGlmIChhbHJlYWR5QWN0aXZlKSByZXR1cm4gdwoKICAgICAgYXdhaXQgdy5yZWFkeSgpCgogICAgICBpZiAodGhpcy5faXNMb2NhbENvcmUody5jb3JlKSAmJiB0aGlzLl9uZWVkc0xvY2FsV3JpdGVyKCkpIHsKICAgICAgICB0aGlzLl9zZXRMb2NhbFdyaXRlcih3KQogICAgICB9CgogICAgICBpZiAoYWxsb3dHQyAmJiB3LmZsdXNoZWQoKSkgewogICAgICAgIHRoaXMuX3dha2V1cC51bnF1ZXVlKGtleSwgbGVuKQogICAgICAgIGlmICh3ICE9PSB0aGlzLmxvY2FsV3JpdGVyKSB7CiAgICAgICAgICBhd2FpdCB3LmNsb3NlKCkKICAgICAgICAgIHJldHVybiB3CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmFjdGl2ZVdyaXRlcnMuYWRkKHcpCiAgICAgIHRoaXMuX2NoZWNrV3JpdGVycy5wdXNoKHcpCgogICAgICBhc3NlcnQody5vcGVuZWQpCiAgICAgIGFzc2VydCghdy5jbG9zZWQpCgogICAgICB3LnVwZGF0ZUFjdGl2aXR5KCkKICAgICAgcmV0dXJuIHcKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX2xvY2sudW5sb2NrKCkKICAgIH0KICB9CgogIF91cGRhdGVBbGwoKSB7CiAgICBjb25zdCBwID0gW10KICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLmFjdGl2ZVdyaXRlcnMpIHAucHVzaCh3LnVwZGF0ZShudWxsKS5jYXRjaChzYWZldHlDYXRjaCkpCiAgICByZXR1cm4gUHJvbWlzZS5hbGwocCkKICB9CgogIGdldFdyaXRlckVuY3J5cHRpb24oKSB7CiAgICBpZiAoIXRoaXMuZW5jcnlwdGlvbktleSkgcmV0dXJuIG51bGwKICAgIHJldHVybiB0aGlzLmVuY3J5cHRpb24uZ2V0V3JpdGVyRW5jcnlwdGlvbigpCiAgfQoKICBfbWFrZVdyaXRlckNvcmUoa2V5KSB7CiAgICBpZiAodGhpcy5jbG9zaW5nKSB0aHJvdyBuZXcgRXJyb3IoJ0F1dG9iYXNlIGlzIGNsb3NpbmcnKQogICAgaWYgKHRoaXMuX2ludGVycnVwdGluZykgdGhyb3cgSU5URVJSVVBUKCkKCiAgICBjb25zdCBsb2NhbCA9IGI0YS5lcXVhbHMoa2V5LCB0aGlzLmxvY2FsLmtleSkKICAgIGNvbnN0IGVuY3J5cHRpb24gPSB0aGlzLmdldFdyaXRlckVuY3J5cHRpb24oKQoKICAgIGNvbnN0IGNvcmUgPSBsb2NhbAogICAgICA/IHRoaXMubG9jYWwuc2Vzc2lvbih7IHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZSwgZW5jcnlwdGlvbiwgYWN0aXZlOiBmYWxzZSB9KQogICAgICA6IHRoaXMuc3RvcmUuZ2V0KHsKICAgICAgICAgIGtleSwKICAgICAgICAgIGNvbXBhdDogZmFsc2UsCiAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UsCiAgICAgICAgICBlbmNyeXB0aW9uLAogICAgICAgICAgYWN0aXZlOiBmYWxzZQogICAgICAgIH0pCgogICAgcmV0dXJuIGNvcmUKICB9CgogIF9tYWtlV3JpdGVyKGtleSwgbGVuZ3RoLCBpc0FjdGl2ZSwgaXNSZW1vdmVkKSB7CiAgICBjb25zdCBjb3JlID0gdGhpcy5fbWFrZVdyaXRlckNvcmUoa2V5KQogICAgY29uc3QgdyA9IG5ldyBXcml0ZXIodGhpcywgY29yZSwgbGVuZ3RoLCBpc1JlbW92ZWQpCgogICAgaWYgKHRoaXMuX2lzTG9jYWxDb3JlKGNvcmUpKSB7CiAgICAgIGlmIChpc0FjdGl2ZSkgdGhpcy5fc2V0TG9jYWxXcml0ZXIodykgLy8gb25seSBzZXQgYWN0aXZlIHdyaXRlcgogICAgICByZXR1cm4gdwogICAgfQoKICAgIGNvcmUub24oJ2FwcGVuZCcsIHRoaXMuX29ucmVtb3Rld3JpdGVyY2hhbmdlQm91bmQpCiAgICBjb3JlLm9uKCdkb3dubG9hZCcsIHRoaXMuX29ucmVtb3Rld3JpdGVyY2hhbmdlQm91bmQpCiAgICBjb3JlLm9uKCdtYW5pZmVzdCcsIHRoaXMuX29ucmVtb3Rld3JpdGVyY2hhbmdlQm91bmQpCgogICAgcmV0dXJuIHcKICB9CgogIF91cGRhdGVMaW5lYXJpemVyKGluZGV4ZXJzLCBoZWFkcykgewogICAgLy8gb25seSBjdXJyZW50IGFjdGl2ZSBpbmRleGVycyBhcmUgcmVzZXQgdG8gdHJ1ZSBiZWxvdwogICAgZm9yIChjb25zdCB3IG9mIHRoaXMuYWN0aXZlV3JpdGVycykgdy5pc0FjdGl2ZUluZGV4ZXIgPSBmYWxzZQogICAgaWYgKHRoaXMubG9jYWxXcml0ZXIpIHRoaXMubG9jYWxXcml0ZXIuaXNBY3RpdmVJbmRleGVyID0gZmFsc2UKCiAgICBmb3IgKGNvbnN0IHdyaXRlciBvZiBpbmRleGVycykgd3JpdGVyLmlzQWN0aXZlSW5kZXhlciA9IHRydWUKCiAgICBpZiAodGhpcy5faXNBY3RpdmVJbmRleGVyKCkgJiYgIXRoaXMuaXNJbmRleGVyKSB7CiAgICAgIHRoaXMuX3NldExvY2FsSW5kZXhlcigpCiAgICB9IGVsc2UgaWYgKCF0aGlzLl9pc0FjdGl2ZUluZGV4ZXIoKSAmJiB0aGlzLmlzSW5kZXhlcikgewogICAgICB0aGlzLl9jbGVhckxvY2FsSW5kZXhlcigpCiAgICB9CgogICAgdGhpcy5saW5lYXJpemVyID0gbmV3IExpbmVhcml6ZXIoaW5kZXhlcnMsIHsgaGVhZHMsIHdyaXRlcnM6IHRoaXMuYWN0aXZlV3JpdGVycyB9KQoKICAgIHRoaXMuX3VwZGF0ZUFja1RocmVzaG9sZCgpCiAgfQoKICBhc3luYyBfdXBkYXRlTG9jYWxXcml0ZXIoc3lzKSB7CiAgICBpZiAodGhpcy5sb2NhbFdyaXRlciAhPT0gbnVsbCAmJiAhdGhpcy5sb2NhbFdyaXRlci5jbG9zZWQpIHJldHVybgogICAgYXdhaXQgdGhpcy5fZ2V0V3JpdGVyQnlLZXkodGhpcy5sb2NhbC5rZXksIC0xLCAwLCB0cnVlLCBmYWxzZSwgc3lzKQogIH0KCiAgYXN5bmMgX2Jvb3RzdHJhcExpbmVhcml6ZXIoKSB7CiAgICBjb25zdCBib290c3RyYXAgPSB0aGlzLl9tYWtlV3JpdGVyKHRoaXMua2V5LCAwLCB0cnVlLCBmYWxzZSkKCiAgICB0aGlzLmFjdGl2ZVdyaXRlcnMuYWRkKGJvb3RzdHJhcCkKICAgIHRoaXMuX2NoZWNrV3JpdGVycy5wdXNoKGJvb3RzdHJhcCkKICAgIGF3YWl0IGJvb3RzdHJhcC5yZWFkeSgpCiAgICB0aGlzLl9lbnN1cmVXYWtldXAoYm9vdHN0cmFwKQoKICAgIHRoaXMuX3VwZGF0ZUxpbmVhcml6ZXIoW2Jvb3RzdHJhcF0sIFtdKQogIH0KCiAgYXN5bmMgX21ha2VMaW5lYXJpemVyKHN5cykgewogICAgaWYgKHN5cyA9PT0gbnVsbCkgewogICAgICByZXR1cm4gdGhpcy5fYm9vdHN0cmFwTGluZWFyaXplcigpCiAgICB9CgogICAgaWYgKHRoaXMub3BlbmVkIHx8IChhd2FpdCBzeXMuaGFzTG9jYWwodGhpcy5sb2NhbC5rZXkpKSkgewogICAgICBhd2FpdCB0aGlzLl91cGRhdGVMb2NhbFdyaXRlcihzeXMpCiAgICB9CgogICAgY29uc3QgaW5kZXhlcnMgPSBbXQoKICAgIGZvciAoY29uc3QgaGVhZCBvZiBzeXMuaW5kZXhlcnMpIHsKICAgICAgY29uc3Qgd3JpdGVyID0gYXdhaXQgdGhpcy5fZ2V0V3JpdGVyQnlLZXkoaGVhZC5rZXksIGhlYWQubGVuZ3RoLCAwLCBmYWxzZSwgZmFsc2UsIHN5cykKICAgICAgaW5kZXhlcnMucHVzaCh3cml0ZXIpCiAgICB9CgogICAgaWYgKCF0aGlzLl9pc0FjdGl2ZUluZGV4ZXIoKSkgewogICAgICBmb3IgKGNvbnN0IGtleSBvZiBzeXMucGVuZGluZ0luZGV4ZXJzKSB7CiAgICAgICAgaWYgKGI0YS5lcXVhbHMoa2V5LCB0aGlzLmxvY2FsLmtleSkpIHsKICAgICAgICAgIHRoaXMuX3NldExvY2FsSW5kZXhlcigpCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHRoaXMuX3VwZGF0ZUxpbmVhcml6ZXIoaW5kZXhlcnMsIHN5cy5oZWFkcykKCiAgICBmb3IgKGNvbnN0IHsga2V5LCBsZW5ndGggfSBvZiBzeXMuaGVhZHMpIHsKICAgICAgYXdhaXQgdGhpcy5fZ2V0V3JpdGVyQnlLZXkoa2V5LCBsZW5ndGgsIDAsIGZhbHNlLCBmYWxzZSwgc3lzKQogICAgfQogIH0KCiAgYXN5bmMgX2NsZWFyV3JpdGVycygpIHsKICAgIGF3YWl0IHRoaXMuYWN0aXZlV3JpdGVycy5jbGVhcigpCiAgICBpZiAodGhpcy5sb2NhbFdyaXRlciAhPT0gbnVsbCkgYXdhaXQgdGhpcy5sb2NhbFdyaXRlci5jbG9zZSgpCiAgICB0aGlzLl9jaGVja1dyaXRlcnMgPSBbXQogIH0KCiAgYXN5bmMgX21ha2VMaW5lYXJpemVyRnJvbVZpZXdTdGF0ZSgpIHsKICAgIGNvbnN0IHN5cyA9IGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuZ2V0SW5kZXhlZFN5c3RlbSgpCiAgICBhd2FpdCB0aGlzLl9tYWtlTGluZWFyaXplcihzeXMpCiAgICBhd2FpdCBzeXMuY2xvc2UoKQogIH0KCiAgYXN5bmMgX3J1bkZvcmNlRmFzdEZvcndhcmQoKSB7CiAgICBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQogICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuCiAgICBjb25zdCByZWMgPSB0aGlzLl9hcHBseVN0YXRlID8gYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5yZWNvdmVyQXQoKSA6IG51bGwKICAgIGF3YWl0IHRoaXMuX3J1bkZhc3RGb3J3YXJkKAogICAgICBuZXcgRmFzdEZvcndhcmQodGhpcywgdGhpcy5jb3JlLmtleSwgeyBmb3JjZTogdHJ1ZSwgbGVuZ3RoOiByZWMgPyByZWMubGVuZ3RoIDogMCB9KQogICAgKQogIH0KCiAgLy8gZ2VuZXJhbCByZXBhaXIgbWV0aG9kIGZvciB0cnlpbmcgdG8gcmVjb3ZlcgogIGFzeW5jIHJlcGFpcigpIHsKICAgIGF3YWl0IHRoaXMuZm9yY2VGYXN0Rm9yd2FyZCgpCiAgfQoKICBhc3luYyBmb3JjZUZhc3RGb3J3YXJkKCkgewogICAgaWYgKHRoaXMuaXNGYXN0Rm9yd2FyZGluZygpKSByZXR1cm4KICAgIGF3YWl0IHRoaXMuX3J1bkZvcmNlRmFzdEZvcndhcmQoKQogICAgYXdhaXQgdGhpcy51cGRhdGUoKQogIH0KCiAgYXN5bmMgX2FwcGx5RmFzdEZvcndhcmQoKSB7CiAgICBpZiAoCiAgICAgICF0aGlzLmZhc3RGb3J3YXJkVG8uZm9yY2UgJiYKICAgICAgdGhpcy5mYXN0Rm9yd2FyZFRvLmxlbmd0aCA8IHRoaXMuY29yZS5sZW5ndGggKyB0aGlzLmZhc3RGb3J3YXJkVG8ubWluaW11bQogICAgKSB7CiAgICAgIHRoaXMuZmFzdEZvcndhcmRUbyA9IG51bGwKICAgICAgdGhpcy5fdXBkYXRlQWN0aXZpdHkoKQogICAgICAvLyBzdGlsbCBub3Qgd29ydGggaXQKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgY2hhbmdlcyA9IHRoaXMuX2hhc1VwZGF0ZSA/IG5ldyBVcGRhdGVDaGFuZ2VzKHRoaXMpIDogbnVsbAogICAgaWYgKGNoYW5nZXMpIGNoYW5nZXMudHJhY2sodGhpcy5fYXBwbHlTdGF0ZSkKCiAgICAvLyBjbG9zZSBleGlzdGluZyBzdGF0ZQogICAgaWYgKHRoaXMuX2FwcGx5U3RhdGUpIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuY2xvc2UoKQoKICAgIGNvbnN0IHsga2V5LCBsZW5ndGgsIHZpZXdzLCBpbmRleGVycywgbWFuaWZlc3RWZXJzaW9uLCBlbnRyb3B5IH0gPSB0aGlzLmZhc3RGb3J3YXJkVG8KCiAgICBjb25zdCBmcm9tID0gdGhpcy5jb3JlLnNpZ25lZExlbmd0aAogICAgY29uc3QgZmZlZCA9IG5ldyBTZXQoKQoKICAgIHRoaXMuX2ZsdXNoaW5nKysKICAgIHRyeSB7CiAgICAgIGNvbnN0IHN0b3JlID0gdGhpcy5fdmlld1N0b3JlLmF0b21pemUoKQoKICAgICAgY29uc3QgbWlncmF0ZWQgPSAhYjRhLmVxdWFscyhrZXksIHRoaXMuY29yZS5rZXkpCgogICAgICBjb25zdCBzeXN0ZW1SZWYgPSBhd2FpdCB0aGlzLl92aWV3U3RvcmUuZmluZFZpZXdCeUtleShrZXksIGluZGV4ZXJzLCBtYW5pZmVzdFZlcnNpb24sIGVudHJvcHkpCiAgICAgIGZmZWQuYWRkKHN5c3RlbVJlZikKCiAgICAgIGlmIChtaWdyYXRlZCkgewogICAgICAgIGF3YWl0IHRoaXMuX2FwcGx5RmFzdEZvcndhcmRNaWdyYXRpb24oc3lzdGVtUmVmLCB7IGtleSwgbGVuZ3RoIH0pCiAgICAgIH0gZWxzZSB7CiAgICAgICAgYXdhaXQgc3lzdGVtUmVmLmNhdGNodXAoc3RvcmUuYXRvbSwgbGVuZ3RoKQogICAgICB9CgogICAgICBmb3IgKGNvbnN0IHYgb2Ygdmlld3MpIHsKICAgICAgICBjb25zdCByZWYgPSBhd2FpdCB0aGlzLl92aWV3U3RvcmUuZmluZFZpZXdCeUtleSh2LmtleSwgaW5kZXhlcnMsIG1hbmlmZXN0VmVyc2lvbiwgZW50cm9weSkKICAgICAgICBpZiAoIXJlZikgY29udGludWUgLy8gdW5rbm93biwgdmlldyBpZ25vcmVkCiAgICAgICAgZmZlZC5hZGQocmVmKQoKICAgICAgICBpZiAobWlncmF0ZWQpIHsKICAgICAgICAgIGF3YWl0IHRoaXMuX2FwcGx5RmFzdEZvcndhcmRNaWdyYXRpb24ocmVmLCB2KQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhd2FpdCByZWYuY2F0Y2h1cChzdG9yZS5hdG9tLCB2Lmxlbmd0aCkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChmZmVkLnNpemUgIT09IHN0b3JlLmdldFZpZXdDb3VudCgpKSB7CiAgICAgICAgZm9yIChjb25zdCByZWYgb2Ygc3RvcmUuZ2V0Vmlld3MoKSkgewogICAgICAgICAgaWYgKGZmZWQuaGFzKHJlZikpIGNvbnRpbnVlCiAgICAgICAgICBhd2FpdCByZWYuY2F0Y2h1cChzdG9yZS5hdG9tLCAwKSAvLyBpdHMgZ29uZQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gbWlncmF0ZSB6ZXJvIGxlbmd0aCBjb3JlcwogICAgICBpZiAobWlncmF0ZWQpIHsKICAgICAgICBjb25zdCBtYW5pZmVzdHMgPSBhd2FpdCB0aGlzLl92aWV3U3RvcmUuZ2V0SW5kZXhlck1hbmlmZXN0cyhpbmRleGVycykKCiAgICAgICAgZm9yIChjb25zdCBbbmFtZSwgcmVmXSBvZiB0aGlzLl92aWV3U3RvcmUuYnlOYW1lKSB7CiAgICAgICAgICBpZiAoZmZlZC5oYXMocmVmKSkgY29udGludWUKICAgICAgICAgIGF3YWl0IHRoaXMuX21pZ3JhdGVWaWV3KG1hbmlmZXN0cywgbnVsbCwgbmFtZSwgMCwgbWFuaWZlc3RWZXJzaW9uLCBlbnRyb3B5LCBbXSwgbnVsbCkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IHZhbHVlID0gYy5lbmNvZGUobWVzc2FnZXMuQm9vdFJlY29yZCwgewogICAgICAgIHZlcnNpb246IEJPT1RfUkVDT1JEX1ZFUlNJT04sCiAgICAgICAga2V5LAogICAgICAgIHN5c3RlbUxlbmd0aDogbGVuZ3RoLAogICAgICAgIGluZGV4ZXJzVXBkYXRlZDogZmFsc2UsCiAgICAgICAgZmFzdEZvcndhcmRpbmc6IHRydWUsCiAgICAgICAgcmVjb3ZlcmllczogUkVDT1ZFUklFUwogICAgICB9KQoKICAgICAgY29uc3QgbG9jYWwgPSBzdG9yZS5nZXRMb2NhbCgpCiAgICAgIGF3YWl0IGxvY2FsLnJlYWR5KCkKICAgICAgYXdhaXQgbG9jYWwuc2V0VXNlckRhdGEoJ2F1dG9iYXNlL2Jvb3QnLCB2YWx1ZSkKCiAgICAgIGF3YWl0IExvY2FsU3RhdGUuY2xlYXIobG9jYWwpCgogICAgICBpZiAoY2hhbmdlcykgY2hhbmdlcy5maW5hbGlzZSgpCgogICAgICBhd2FpdCBzdG9yZS5mbHVzaCgpCiAgICAgIGF3YWl0IHN0b3JlLmNsb3NlKCkKICAgIH0gZmluYWxseSB7CiAgICAgIGlmICgtLXRoaXMuX2ZsdXNoaW5nID09PSAwKSB0aGlzLl9mbHVzaFNpZ25hbC5ub3RpZnkoKQogICAgfQoKICAgIGNvbnN0IHRvID0gdGhpcy5jb3JlLnNpZ25lZExlbmd0aAoKICAgIGZvciAoY29uc3QgcmVmIG9mIGZmZWQpIGF3YWl0IHJlZi5yZWxlYXNlKCkKCiAgICB0aGlzLnJlY292ZXJpZXMgPSBSRUNPVkVSSUVTCiAgICB0aGlzLmZhc3RGb3J3YXJkVG8gPSBudWxsCiAgICB0aGlzLl9xdWV1ZUZhc3RGb3J3YXJkKCkKCiAgICBhd2FpdCB0aGlzLl9jbGVhcldyaXRlcnMoKQoKICAgIHRoaXMuX2FwcGx5U3RhdGUgPSBuZXcgQXBwbHlTdGF0ZSh0aGlzKQogICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5yZWFkeSgpCgogICAgaWYgKGNoYW5nZXMpIGF3YWl0IHRoaXMuX2hhbmRsZXJzLnVwZGF0ZSh0aGlzLl9hcHBseVN0YXRlLnZpZXcsIGNoYW5nZXMpCgogICAgaWYgKGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuc2hvdWxkTWlncmF0ZSgpKSB7CiAgICAgIGF3YWl0IHRoaXMuX21pZ3JhdGUoKQogICAgfSBlbHNlIHsKICAgICAgYXdhaXQgdGhpcy5fbWFrZUxpbmVhcml6ZXJGcm9tVmlld1N0YXRlKCkKICAgICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5jYXRjaHVwKHRoaXMubGluZWFyaXplcikKICAgIH0KCiAgICBpZiAoIXRoaXMubG9jYWxXcml0ZXIgfHwgdGhpcy5sb2NhbFdyaXRlci5jbG9zZWQpIHsKICAgICAgYXdhaXQgdGhpcy5fdXBkYXRlTG9jYWxXcml0ZXIodGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0pCiAgICB9CgogICAgdGhpcy5fY2F1Z2h0dXAgPSB0cnVlCgogICAgdGhpcy5fcmVib290ZWQoKQogICAgdGhpcy5lbWl0KCdmYXN0LWZvcndhcmQnLCB0bywgZnJvbSkKICB9CgogIC8vIFRPRE86IG5vdCBhdG9taWMgaW4gcmVnYXJkcyB0byB0aGUgZmYsIGZpeCB0aGF0CiAgYXN5bmMgX2FwcGx5RmFzdEZvcndhcmRNaWdyYXRpb24ocmVmLCB2KSB7CiAgICBjb25zdCBuZXh0ID0gdGhpcy5zdG9yZS5nZXQodi5rZXkpCiAgICBhd2FpdCBuZXh0LnJlYWR5KCkKCiAgICBjb25zdCBwcm9sb2d1ZSA9IG5leHQubWFuaWZlc3QgJiYgbmV4dC5tYW5pZmVzdC5wcm9sb2d1ZQoKICAgIGlmIChwcm9sb2d1ZSAmJiBwcm9sb2d1ZS5sZW5ndGggPiAwICYmIHJlZi5jb3JlLmxlbmd0aCA+PSBwcm9sb2d1ZS5sZW5ndGgpIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCBuZXh0LmNvcmUuY29weVByb2xvZ3VlKHJlZi5jb3JlLnN0YXRlKQogICAgICB9IGNhdGNoIHsKICAgICAgICAvLyB3ZSBtaWdodCBiZSBtaXNzaW5nIHNvbWUgbm9kZXMgZm9yIHRoaXMsIGp1c3QgaWdub3JlLCBvbmx5IGFuIG9wdGltaXNhdGlvbgogICAgICB9CiAgICB9CgogICAgY29uc3QgYmF0Y2ggPSBuZXh0LnNlc3Npb24oeyBuYW1lOiAnYmF0Y2gnLCBvdmVyd3JpdGU6IHRydWUsIGNoZWNrb3V0OiB2Lmxlbmd0aCB9KQogICAgYXdhaXQgYmF0Y2gucmVhZHkoKQoKICAgIC8vIHJlbWFrZSB0aGUgYmF0Y2gsIHJlc2V0IGZyb20gb3VyIHByb2xvZ3VlIGluIGNhc2UgaXQgcmVwbGljYXRlZCBpbmJldHdlZW4KICAgIC8vIFRPRE86IHdlIHNob3VsZCByZWFsbHkgaGF2ZSBhbiBIQyBmdW5jdGlvbiBmb3IgdGhpcwoKICAgIGF3YWl0IHJlZi5iYXRjaC5zdGF0ZS5tb3ZlVG8oYmF0Y2gsIGJhdGNoLmxlbmd0aCkKICAgIGF3YWl0IGJhdGNoLmNsb3NlKCkKCiAgICByZWYubWlncmF0ZWQodGhpcywgbmV4dCkKICB9CgogIGFzeW5jIF9taWdyYXRlVmlldygKICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICBzb3VyY2UsCiAgICBuYW1lLAogICAgaW5kZXhlZExlbmd0aCwKICAgIG1hbmlmZXN0VmVyc2lvbiwKICAgIGVudHJvcHksCiAgICBsaW5rZWQsCiAgICBtYW5pZmVzdERhdGEKICApIHsKICAgIGNvbnN0IHJlZiA9IHRoaXMuX3ZpZXdTdG9yZS5ieU5hbWUuZ2V0KG5hbWUpCgogICAgY29uc3QgcHJvbG9ndWUgPQogICAgICBpbmRleGVkTGVuZ3RoID09PSAwCiAgICAgICAgPyBudWxsCiAgICAgICAgOiB7IGxlbmd0aDogaW5kZXhlZExlbmd0aCwgaGFzaDogYXdhaXQgc291cmNlLnRyZWVIYXNoKGluZGV4ZWRMZW5ndGgpIH0KCiAgICBpZiAobWFuaWZlc3REYXRhID09PSBudWxsICYmIHJlZi5jb3JlLm1hbmlmZXN0LnVzZXJEYXRhICE9PSBudWxsKSB7CiAgICAgIG1hbmlmZXN0RGF0YSA9IHJlZi5jb3JlLm1hbmlmZXN0LnVzZXJEYXRhCiAgICB9CgogICAgY29uc3QgbmV4dCA9IHRoaXMuX3ZpZXdTdG9yZS5nZXRWaWV3Q29yZSgKICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgbmFtZSwKICAgICAgcHJvbG9ndWUsCiAgICAgIG1hbmlmZXN0VmVyc2lvbiwKICAgICAgZW50cm9weSwKICAgICAgbGlua2VkLAogICAgICBtYW5pZmVzdERhdGEKICAgICkKICAgIGF3YWl0IG5leHQucmVhZHkoKQoKICAgIGlmIChpbmRleGVkTGVuZ3RoID4gMCkgewogICAgICBhd2FpdCBuZXh0LmNvcmUuY29weVByb2xvZ3VlKHNvdXJjZS5zdGF0ZSkKICAgIH0KCiAgICAvLyByZW1ha2UgdGhlIGJhdGNoLCByZXNldCBmcm9tIG91ciBwcm9sb2d1ZSBpbiBjYXNlIGl0IHJlcGxpY2F0ZWQgaW5iZXR3ZWVuCiAgICAvLyBUT0RPOiB3ZSBzaG91bGQgcmVhbGx5IGhhdmUgYW4gSEMgZnVuY3Rpb24gZm9yIHRoaXMKICAgIGNvbnN0IGJhdGNoID0gbmV4dC5zZXNzaW9uKHsgbmFtZTogJ2JhdGNoJywgb3ZlcndyaXRlOiB0cnVlLCBjaGVja291dDogaW5kZXhlZExlbmd0aCB9KQogICAgYXdhaXQgYmF0Y2gucmVhZHkoKQoKICAgIGlmIChzb3VyY2UgIT09IG51bGwpIHsKICAgICAgd2hpbGUgKGJhdGNoLmxlbmd0aCA8IHNvdXJjZS5sZW5ndGgpIHsKICAgICAgICBhd2FpdCBiYXRjaC5hcHBlbmQoYXdhaXQgc291cmNlLmdldChiYXRjaC5sZW5ndGgpKQogICAgICB9CiAgICB9CgogICAgYXdhaXQgcmVmLmJhdGNoLnN0YXRlLm1vdmVUbyhiYXRjaCwgYmF0Y2gubGVuZ3RoKQogICAgYXdhaXQgYmF0Y2guY2xvc2UoKQoKICAgIHJlZi5taWdyYXRlZCh0aGlzLCBuZXh0KQoKICAgIHJldHVybiByZWYKICB9CgogIGFzeW5jIF9wcmVtaWdyYXRlKCkgewogICAgdGhpcy5fZmx1c2hpbmcrKwogICAgdHJ5IHsKICAgICAgY29uc3QgbGVuZ3RoID0gdGhpcy5fYXBwbHlTdGF0ZS5pbmRleGVkTGVuZ3RoCiAgICAgIGNvbnN0IHN5c3RlbSA9IHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtCgogICAgICBjb25zdCBpbmZvID0gYXdhaXQgc3lzdGVtLmdldEluZGV4ZWRJbmZvKGxlbmd0aCkKICAgICAgY29uc3QgaW5kZXhlck1hbmlmZXN0cyA9IGF3YWl0IHRoaXMuX3ZpZXdTdG9yZS5nZXRJbmRleGVyTWFuaWZlc3RzKGluZm8uaW5kZXhlcnMpCgogICAgICBjb25zdCB7IHZpZXdzLCBzeXN0ZW1WaWV3LCBlbmNyeXB0aW9uVmlldyB9ID0gdGhpcy5fYXBwbHlTdGF0ZQoKICAgICAgY29uc3QgbWFuaWZlc3RWZXJzaW9uID0gdGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uY29yZS5tYW5pZmVzdC52ZXJzaW9uCgogICAgICBmb3IgKGNvbnN0IHZpZXcgb2Ygdmlld3MpIHsKICAgICAgICBjb25zdCB2ID0gdGhpcy5fYXBwbHlTdGF0ZS5nZXRWaWV3RnJvbVN5c3RlbSh2aWV3LCBpbmZvKQogICAgICAgIGNvbnN0IGluZGV4ZWRMZW5ndGggPSB2ID8gdi5sZW5ndGggOiAwCgogICAgICAgIGNvbnN0IHJlZiA9IHRoaXMuX3ZpZXdTdG9yZS5nZXRWaWV3QnlOYW1lKHZpZXcubmFtZSkKICAgICAgICBjb25zdCBzb3VyY2UgPSByZWYuZ2V0Q29yZSgpCiAgICAgICAgYXdhaXQgc291cmNlLnJlYWR5KCkKCiAgICAgICAgYXdhaXQgdGhpcy5fbWlncmF0ZVZpZXcoCiAgICAgICAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgICAgICAgc291cmNlLAogICAgICAgICAgdmlldy5uYW1lLAogICAgICAgICAgaW5kZXhlZExlbmd0aCwKICAgICAgICAgIG1hbmlmZXN0VmVyc2lvbiwKICAgICAgICAgIGluZm8uZW50cm9weSwKICAgICAgICAgIG51bGwsCiAgICAgICAgICBudWxsCiAgICAgICAgKQogICAgICB9CgogICAgICBjb25zdCBzb3VyY2UgPSBlbmNyeXB0aW9uVmlldy5yZWYuZ2V0Q29yZSgpCiAgICAgIGF3YWl0IHNvdXJjZS5yZWFkeSgpCgogICAgICBjb25zdCBlbmMgPSBhd2FpdCB0aGlzLl9taWdyYXRlVmlldygKICAgICAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgICAgIHNvdXJjZSwKICAgICAgICAnX2VuY3J5cHRpb24nLAogICAgICAgIGluZm8uZW5jcnlwdGlvbkxlbmd0aCwKICAgICAgICBtYW5pZmVzdFZlcnNpb24sCiAgICAgICAgaW5mby5lbnRyb3B5LAogICAgICAgIG51bGwsCiAgICAgICAgbnVsbAogICAgICApCgogICAgICBjb25zdCBsaW5rZWQgPSBbZW5jLmNvcmUua2V5XQoKICAgICAgY29uc3Qgc3lzQ29yZSA9IHN5c3RlbVZpZXcucmVmLmdldENvcmUoKQogICAgICBjb25zdCByZWYgPSBhd2FpdCB0aGlzLl9taWdyYXRlVmlldygKICAgICAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgICAgIHN5c0NvcmUsCiAgICAgICAgJ19zeXN0ZW0nLAogICAgICAgIGxlbmd0aCwKICAgICAgICBtYW5pZmVzdFZlcnNpb24sCiAgICAgICAgaW5mby5lbnRyb3B5LAogICAgICAgIGxpbmtlZCwKICAgICAgICBudWxsLAogICAgICAgIG51bGwKICAgICAgKQoKICAgICAgcmV0dXJuIHJlZi5jb3JlLmtleQogICAgfSBmaW5hbGx5IHsKICAgICAgaWYgKC0tdGhpcy5fZmx1c2hpbmcgPT09IDApIHRoaXMuX2ZsdXNoU2lnbmFsLm5vdGlmeSgpCiAgICB9CiAgfQoKICBhc3luYyBfbWlncmF0ZSgpIHsKICAgIHJldHVybiB0aGlzLl9yZWJvb3QoYXdhaXQgdGhpcy5fcHJlbWlncmF0ZSgpKQogIH0KCiAgYXN5bmMgX3JlYm9vdChrZXkpIHsKICAgIGF3YWl0IHRoaXMuX2NsZWFyV3JpdGVycygpCiAgICBhd2FpdCB0aGlzLl9tYWtlTGluZWFyaXplckZyb21WaWV3U3RhdGUoKQoKICAgIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuZmluYWxpemUoa2V5KQoKICAgIHRoaXMuX2FwcGx5U3RhdGUgPSBuZXcgQXBwbHlTdGF0ZSh0aGlzKQoKICAgIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUucmVhZHkoKQogICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5jYXRjaHVwKHRoaXMubGluZWFyaXplcikKCiAgICAvLyBlbmQgc29mdCBzaHV0ZG93bgoKICAgIHRoaXMuX3F1ZXVlRmFzdEZvcndhcmQoKQoKICAgIHRoaXMuX3JlYm9vdGVkKCkKICB9CgogIF9yZWJvb3RlZCgpIHsKICAgIHRoaXMucmVjb3VwbGUoKQogICAgdGhpcy5fdXBkYXRlQWN0aXZpdHkoKQoKICAgIHRoaXMuZW1pdCgncmVib290JykKCiAgICAvLyBlbnN1cmUgd2UgcmUtZXZhbHV0ZSBvdXIgc3RhdGUKICAgIHRoaXMuX2Jvb3RzdHJhcFdyaXRlcnNDaGFuZ2VkID0gdHJ1ZQogICAgdGhpcy5fbmVlZHNXYWtldXAgPSB0cnVlCgogICAgdGhpcy51cGRhdGluZyA9IHRydWUKICAgIHRoaXMuX3F1ZXVlQnVtcCgpCiAgfQoKICBfc2V0TG9jYWxXcml0ZXIodykgewogICAgdGhpcy5sb2NhbFdyaXRlciA9IHcKICAgIGlmICh0aGlzLl9hY2tJbnRlcnZhbCkgdGhpcy5fc3RhcnRBY2tUaW1lcigpCiAgfQoKICBfdW5zZXRMb2NhbFdyaXRlcigpIHsKICAgIGlmICghdGhpcy5sb2NhbFdyaXRlcikgcmV0dXJuCgogICAgdGhpcy5fY2xvc2VXcml0ZXIodGhpcy5sb2NhbFdyaXRlcikKICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgdGhpcy5fY2xlYXJMb2NhbEluZGV4ZXIoKQoKICAgIHRoaXMubG9jYWxXcml0ZXIgPSBudWxsCiAgfQoKICBfc2V0TG9jYWxJbmRleGVyKCkgewogICAgYXNzZXJ0KHRoaXMubG9jYWxXcml0ZXIgIT09IG51bGwpCgogICAgdGhpcy5pc0luZGV4ZXIgPSB0cnVlCiAgICB0aGlzLmVtaXQoJ2lzLWluZGV4ZXInKQogIH0KCiAgX2NsZWFyTG9jYWxJbmRleGVyKCkgewogICAgYXNzZXJ0KHRoaXMubG9jYWxXcml0ZXIgIT09IG51bGwpCgogICAgaWYgKHRoaXMuX2Fja1RpbWVyKSB0aGlzLl9hY2tUaW1lci5zdG9wKCkKCiAgICB0aGlzLmlzSW5kZXhlciA9IGZhbHNlCiAgICB0aGlzLl9hY2tUaW1lciA9IG51bGwKCiAgICB0aGlzLmVtaXQoJ2lzLW5vbi1pbmRleGVyJykKICB9CgogIF9pc0xvY2FsQ29yZShjb3JlKSB7CiAgICByZXR1cm4gY29yZS53cml0YWJsZSAmJiBjb3JlLmlkID09PSB0aGlzLmxvY2FsLmlkCiAgfQoKICBfYWRkTG9jYWxIZWFkcygpIHsKICAgIC8vIG5vdCB3cml0YWJsZSBhdG0sIHdpbGwgcHJvcCBiZSB3cml0YWJsZSBpbiBhIHN1YnNlcXVlbnQgYnVtcCB0aG8KICAgIGlmICghdGhpcy5sb2NhbFdyaXRlciB8fCB0aGlzLmxvY2FsV3JpdGVyLmNsb3NlZCkgcmV0dXJuIG51bGwKICAgIC8vIHNhZmV0eSwgbG9jYWx3cml0ZXIgaXMgc3RpbGwgcHJvY2Vzc2luZywgc2hvdWxkIHByb3AgYmUgYW4gYXNzZXJ0aW9uCiAgICBpZiAoIXRoaXMubG9jYWxXcml0ZXIuaWRsZSgpKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuX29wdGltaXN0aWMgPT09IC0xID8gdGhpcy5fYXBwZW5kaW5nLmxlbmd0aCA6IHRoaXMuX29wdGltaXN0aWMgfHwgMQoKICAgIGNvbnN0IG5vZGVzID0gbmV3IEFycmF5KGxlbmd0aCkKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgaGVhZHMgPSB0aGlzLmxpbmVhcml6ZXIuZ2V0SGVhZHMoKQogICAgICBjb25zdCBkZXBzID0gbmV3IFNldCh0aGlzLmxpbmVhcml6ZXIuaGVhZHMpCiAgICAgIGNvbnN0IGJhdGNoID0gbGVuZ3RoIC0gaQogICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuX2FwcGVuZGluZ1tpXQoKICAgICAgY29uc3Qgbm9kZSA9IHRoaXMubG9jYWxXcml0ZXIuYXBwZW5kKHZhbHVlLCBoZWFkcywgYmF0Y2gsIGRlcHMsIHRoaXMuX29wdGltaXN0aWMgPT09IDApCgogICAgICB0aGlzLmxpbmVhcml6ZXIuYWRkSGVhZChub2RlKQogICAgICBub2Rlc1tpXSA9IG5vZGUKICAgIH0KCiAgICByZXR1cm4gbm9kZXMKICB9CgogIF9mbHVzaExvY2FsSGVhZHMobGVuZ3RoKSB7CiAgICB0aGlzLl9hcHBlbmRpbmcgPSBsZW5ndGggPT09IHRoaXMuX2FwcGVuZGluZy5sZW5ndGggPyBudWxsIDogdGhpcy5fYXBwZW5kaW5nLnNsaWNlKGxlbmd0aCkKICAgIHRoaXMuX2FwcGVuZGVkICs9IGxlbmd0aAoKICAgIGlmICh0aGlzLl9vcHRpbWlzdGljID4gLTEgJiYgdGhpcy5fb3B0aW1pc3RpYyA8IGxlbmd0aCkgdGhpcy5fb3B0aW1pc3RpYyA9IC0xCiAgfQoKICBhc3luYyBfYWRkUmVtb3RlSGVhZHMoKSB7CiAgICBsZXQgYWRkZWQgPSAwCgogICAgd2hpbGUgKAogICAgICBhZGRlZCA8IFJFTU9URV9BRERfQkFUQ0ggfHwKICAgICAgKHRoaXMuYmlnQmF0Y2hlcyAmJiAhdGhpcy5faW5kZXhlcnNJZGxlKCkgJiYgYWRkZWQgPCBSRU1PVEVfQUREX0JBVENIX1NBTklUWSkKICAgICkgewogICAgICBhd2FpdCB0aGlzLl91cGRhdGVBbGwoKQoKICAgICAgbGV0IGFkdmFuY2VkID0gMAoKICAgICAgZm9yIChjb25zdCB3IG9mIHRoaXMuYWN0aXZlV3JpdGVycykgewogICAgICAgIGxldCBub2RlID0gdy5hZHZhbmNlKCkKICAgICAgICBpZiAobm9kZSA9PT0gbnVsbCkgY29udGludWUKCiAgICAgICAgYWR2YW5jZWQgKz0gbm9kZS5iYXRjaAoKICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgdGhpcy5saW5lYXJpemVyLmFkZEhlYWQobm9kZSkKICAgICAgICAgIGlmIChub2RlLmJhdGNoID09PSAxKSBicmVhawogICAgICAgICAgbm9kZSA9IHcuYWR2YW5jZSgpCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoYWR2YW5jZWQgPT09IDApIHsKICAgICAgICBpZiAodGhpcy5iaWdCYXRjaGVzICYmICF0aGlzLl9pbmRleGVyc0lkbGUoKSAmJiAoYXdhaXQgdGhpcy5fd2FpdEZvckluZGV4ZXJzKCkpKSBjb250aW51ZQogICAgICAgIGJyZWFrCiAgICAgIH0KCiAgICAgIGFkZGVkICs9IGFkdmFuY2VkCiAgICB9CgogICAgcmV0dXJuIGFkZGVkCiAgfQoKICBhc3luYyBfd2FpdEZvckluZGV4ZXJzKCkgewogICAgY29uc3QgcHJvbWlzZXMgPSBbXQoKICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLmxpbmVhcml6ZXIuaW5kZXhlcnMpIHsKICAgICAgaWYgKHcuaWRsZSgpKSBjb250aW51ZQogICAgICBpZiAoYXdhaXQgdy5jb3JlLmhhcyh3Lmxlbmd0aCkpIGNvbnRpbnVlCiAgICAgIHByb21pc2VzLnB1c2gody5jb3JlLmdldCh3Lmxlbmd0aCwgeyB0aW1lb3V0OiAzMDAwIH0pKQogICAgfQoKICAgIGZvciAoY29uc3QgcmVzdWx0IG9mIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChwcm9taXNlcykpIHsKICAgICAgaWYgKHJlc3VsdC5zdGF0dXMgIT09ICdyZWplY3RlZCcpIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBfaW5kZXhlcnNJZGxlKCkgewogICAgZm9yIChjb25zdCB3IG9mIHRoaXMubGluZWFyaXplci5pbmRleGVycykgewogICAgICBpZiAoIXcuaWRsZSgpKSByZXR1cm4gZmFsc2UKICAgIH0KICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBfZHJhaW4oKSB7CiAgICBjb25zdCB3cml0YWJsZSA9IHRoaXMud3JpdGFibGUKCiAgICB3aGlsZSAoIXRoaXMuX2ludGVycnVwdGluZyAmJiAhdGhpcy5wYXVzZWQpIHsKICAgICAgaWYgKHRoaXMuZmFzdEZvcndhcmRUbyAhPT0gbnVsbCkgewogICAgICAgIGF3YWl0IHRoaXMuX2FwcGx5RmFzdEZvcndhcmQoKQogICAgICAgIGNvbnRpbnVlIC8vIHJldmFsdWF0ZSBjb25kaXRpb25zLi4uCiAgICAgIH0KCiAgICAgIC8vIHdlIGRlZmVyIHRoaXMgdG8gcG9zdCByZWFkeSBzbyBpdHMgbm90IGJsb2NraW5nIHJlYWRpbmcgdGhlIHZpZXdzCiAgICAgIGlmICh0aGlzLl9jYXVnaHR1cCA9PT0gZmFsc2UpIHsKICAgICAgICAvLyBpZiB0aGUgY2F0Y2h1cCBmYWlscywganVzdCBmb3JjZSBmZiBpdCB0byByZWNvdmVyLCBsZXNzIHVzZXIgcGFpbgogICAgICAgIGlmICghKGF3YWl0IHRoaXMuX2NhdGNodXBBcHBseVN0YXRlKCkpKSB7CiAgICAgICAgICBhd2FpdCB0aGlzLl9ydW5Gb3JjZUZhc3RGb3J3YXJkKCkKICAgICAgICB9CiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgY29uc3QgcmVtb3RlQWRkZWQgPSBhd2FpdCB0aGlzLl9hZGRSZW1vdGVIZWFkcygpCiAgICAgIGNvbnN0IGxvY2FsTm9kZXMgPSB0aGlzLl9hcHBlbmRpbmcgIT09IG51bGwgPyB0aGlzLl9hZGRMb2NhbEhlYWRzKCkgOiBudWxsCgogICAgICBpZiAodGhpcy5faW50ZXJydXB0aW5nKSByZXR1cm4KCiAgICAgIGlmIChyZW1vdGVBZGRlZCA+IDAgfHwgbG9jYWxOb2RlcyAhPT0gbnVsbCkgewogICAgICAgIHRoaXMudXBkYXRpbmcgPSB0cnVlCiAgICAgIH0KCiAgICAgIGNvbnN0IHUgPSB0aGlzLmxpbmVhcml6ZXIudXBkYXRlKCkKICAgICAgY29uc3QgdXBkYXRlID0gdQogICAgICAgID8gYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS51cGRhdGUodSwgbG9jYWxOb2RlcykKICAgICAgICA6IHsgcmVib290OiBmYWxzZSwgbWlncmF0ZWQ6IGZhbHNlIH0KCiAgICAgIGlmIChsb2NhbE5vZGVzKSB0aGlzLl9mbHVzaExvY2FsSGVhZHMobG9jYWxOb2Rlcy5sZW5ndGgpCgogICAgICBpZiAoIXVwZGF0ZS5yZWJvb3QpIHsKICAgICAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZS5zaG91bGRGbHVzaCgpKSB7CiAgICAgICAgICBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmZsdXNoKCkKICAgICAgICAgIHRoaXMudXBkYXRpbmcgPSB0cnVlCiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fY2hlY2tXcml0ZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGF3YWl0IHRoaXMuX2djV3JpdGVycygpCiAgICAgICAgICBjb250aW51ZSAvLyByZXJ1biB0aGUgdXBkYXRlIGxvb3AgYXMgYSB3cml0ZXIgbWlnaHQgaGF2ZSBiZWVuIGFkZGVkCiAgICAgICAgfQogICAgICAgIGlmIChyZW1vdGVBZGRlZCA+PSBSRU1PVEVfQUREX0JBVENIKSBjb250aW51ZQogICAgICAgIGJyZWFrCiAgICAgIH0KCiAgICAgIGF3YWl0IHRoaXMuX2djV3JpdGVycygpCiAgICAgIGF3YWl0IHRoaXMuX3JlYm9vdCh0aGlzLl9hcHBseVN0YXRlLmtleSkKICAgIH0KCiAgICAvLyBlbWl0IHN0YXRlIGNoYW5nZXMgcG9zdCBkcmFpbgogICAgaWYgKHdyaXRhYmxlICE9PSB0aGlzLndyaXRhYmxlKSB7CiAgICAgIGlmICh0aGlzLndyaXRhYmxlICYmIHRoaXMuX3dyaXRhYmxlKSB0aGlzLl93cml0YWJsZS5yZXNvbHZlKHRydWUpCiAgICAgIHRoaXMuZW1pdCh3cml0YWJsZSA/ICd1bndyaXRhYmxlJyA6ICd3cml0YWJsZScpCiAgICB9CiAgfQoKICBfd2FrZXVwUGVlcihzdHJlYW0pIHsKICAgIGlmICghdGhpcy53YWtldXBTZXNzaW9uKSByZXR1cm4KICAgIGNvbnN0IHdha2V1cCA9IHRoaXMuX2dldFdha2V1cCgpCiAgICBpZiAod2FrZXVwLmxlbmd0aCA9PT0gMCkgcmV0dXJuCiAgICB0aGlzLndha2V1cFNlc3Npb24uYW5ub3VuY2VCeVN0cmVhbShzdHJlYW0sIHdha2V1cCkKICB9CgogIF9nZXRXYWtldXAoKSB7CiAgICBjb25zdCB3cml0ZXJzID0gW10KCiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5hY3RpdmVXcml0ZXJzKSB7CiAgICAgIGlmICh3LmlzQWN0aXZlSW5kZXhlciB8fCB3LmZsdXNoZWQoKSkgY29udGludWUKICAgICAgd3JpdGVycy5wdXNoKHsga2V5OiB3LmNvcmUua2V5LCBsZW5ndGg6IHcubGVuZ3RoIH0pCiAgICB9CgogICAgcmV0dXJuIHdyaXRlcnMKICB9CgogIGFzeW5jIF93YWtldXBXcml0ZXIoa2V5LCBsZW5ndGgpIHsKICAgIHRoaXMuX2Vuc3VyZVdha2V1cChhd2FpdCB0aGlzLl9nZXRXcml0ZXJCeUtleShrZXksIC0xLCBsZW5ndGgsIHRydWUsIGZhbHNlLCBudWxsKSkKICB9CgogIC8vIGVuc3VyZSB3YWtldXAgb24gYW4gZXhpc3Rpbmcgd3JpdGVyICh0aGUgd3JpdGVyIGNhbGxzIHRoaXMgaW4gYWRkaXRpb24gdG8gYWJvdmUpCiAgX2Vuc3VyZVdha2V1cCh3KSB7CiAgICBpZiAodyA9PT0gbnVsbCB8fCB3LmlzQm9vdHN0cmFwID09PSB0cnVlKSByZXR1cm4KICAgIHcuc2V0Qm9vdHN0cmFwKHRydWUpIC8vIGV2ZW4gaWYgdHVybiBmYWxzZSBhdCBlbmQgb2YgZHJhaW4sIGh5cGVyY29yZSBtYWtlcyB0aGVtIGxpbmdlciBhIGJpdCBzbyBubyBjaHVybgogICAgdGhpcy5fYm9vdHN0cmFwV3JpdGVycy5wdXNoKHcpCiAgICB0aGlzLl9ib290c3RyYXBXcml0ZXJzQ2hhbmdlZCA9IHRydWUKICB9CgogIGFzeW5jIF9kcmFpbldha2V1cCgpIHsKICAgIGNvbnN0IHByb21pc2VzID0gW10KCiAgICAvLyB3YXJtdXAgYWxsIHRoZSBiZWxvdyBnZXRzCiAgICBpZiAodGhpcy5fbmVlZHNXYWtldXApIHsKICAgICAgZm9yIChjb25zdCB7IGtleSwgbGVuZ3RoIH0gb2YgdGhpcy5fd2FrZXVwKSB7CiAgICAgICAgY29uc3QgdyA9IHRoaXMuYWN0aXZlV3JpdGVycy5nZXQoa2V5KQogICAgICAgIGlmICh3KSB7CiAgICAgICAgICBpZiAody5sZW5ndGggPCBsZW5ndGgpIHcuc2VlbihsZW5ndGgpCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAgICAgICBwcm9taXNlcy5wdXNoKHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmdldChrZXkpKQogICAgICB9CgogICAgICBpZiAodGhpcy5fbmVlZHNXYWtldXBIZWFkcykgewogICAgICAgIGZvciAoY29uc3QgeyBrZXkgfSBvZiBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5oZWFkcykgewogICAgICAgICAgaWYgKHRoaXMuYWN0aXZlV3JpdGVycy5oYXMoa2V5KSkgY29udGludWUKICAgICAgICAgIHByb21pc2VzLnB1c2godGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uZ2V0KGtleSkpCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmb3IgKGNvbnN0IFtoZXgsIGxlbmd0aF0gb2YgdGhpcy5fd2FrZXVwSGludHMpIHsKICAgICAgY29uc3Qga2V5ID0gYjRhLmZyb20oaGV4LCAnaGV4JykKICAgICAgaWYgKGxlbmd0aCAhPT0gLTEpIHsKICAgICAgICBjb25zdCB3ID0gdGhpcy5hY3RpdmVXcml0ZXJzLmdldChrZXkpCiAgICAgICAgaWYgKHcpIHsKICAgICAgICAgIGlmICh3Lmxlbmd0aCA8IGxlbmd0aCkgdy5zZWVuKGxlbmd0aCkKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogICAgICB9CiAgICAgIHByb21pc2VzLnB1c2godGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uZ2V0KGtleSkpCiAgICB9CgogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHByb21pc2VzKQoKICAgIGlmICh0aGlzLl9uZWVkc1dha2V1cCA9PT0gdHJ1ZSkgewogICAgICB0aGlzLl9uZWVkc1dha2V1cCA9IGZhbHNlCgogICAgICBmb3IgKGNvbnN0IHsga2V5LCBsZW5ndGggfSBvZiB0aGlzLl93YWtldXApIHsKICAgICAgICBpZiAodGhpcy5hY3RpdmVXcml0ZXJzLmhhcyhrZXkpKSBjb250aW51ZQogICAgICAgIGF3YWl0IHRoaXMuX3dha2V1cFdyaXRlcihrZXksIGxlbmd0aCkKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX25lZWRzV2FrZXVwSGVhZHMgPT09IHRydWUpIHsKICAgICAgICB0aGlzLl9uZWVkc1dha2V1cEhlYWRzID0gZmFsc2UKCiAgICAgICAgZm9yIChjb25zdCB7IGtleSB9IG9mIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmhlYWRzKSB7CiAgICAgICAgICBpZiAodGhpcy5hY3RpdmVXcml0ZXJzLmhhcyhrZXkpKSBjb250aW51ZQogICAgICAgICAgYXdhaXQgdGhpcy5fd2FrZXVwV3JpdGVyKGtleSwgMCkKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmb3IgKGNvbnN0IFtoZXgsIGxlbmd0aF0gb2YgdGhpcy5fd2FrZXVwSGludHMpIHsKICAgICAgY29uc3Qga2V5ID0gYjRhLmZyb20oaGV4LCAnaGV4JykKICAgICAgaWYgKHRoaXMuYWN0aXZlV3JpdGVycy5oYXMoa2V5KSkgY29udGludWUKICAgICAgaWYgKGxlbmd0aCAhPT0gLTEpIHsKICAgICAgICBjb25zdCBpbmZvID0gYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uZ2V0KGtleSkKICAgICAgICBpZiAoaW5mbyAmJiBsZW5ndGggPD0gaW5mby5sZW5ndGgpIGNvbnRpbnVlIC8vIHN0YWxlIGhpbnQKICAgICAgfQogICAgICBhd2FpdCB0aGlzLl93YWtldXBXcml0ZXIoa2V5LCBsZW5ndGggPT09IC0xID8gMCA6IGxlbmd0aCkKICAgIH0KCiAgICB0aGlzLl93YWtldXBIaW50cy5jbGVhcigpCiAgfQoKICBwYXVzZSgpIHsKICAgIHRoaXMucGF1c2VkID0gdHJ1ZQogIH0KCiAgcmVzdW1lKCkgewogICAgdGhpcy5wYXVzZWQgPSBmYWxzZQogICAgdGhpcy5fcXVldWVCdW1wKCkKICB9CgogIHdhaXRGb3JXcml0YWJsZSgpIHsKICAgIGlmICh0aGlzLndyaXRhYmxlKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRydWUpCiAgICBpZiAoIXRoaXMuX3dyaXRhYmxlKSB0aGlzLl93cml0YWJsZSA9IHJycCgpCiAgICByZXR1cm4gdGhpcy5fd3JpdGFibGUucHJvbWlzZQogIH0KCiAgYXN5bmMgX2RyYWluV2l0aEludGVydXB0KCkgewogICAgd2hpbGUgKHRydWUpIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLl9kcmFpbigpCiAgICAgICAgcmV0dXJuCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmICh0aGlzLmNsb3NpbmcgfHwgIXRoaXMuZmFzdEZvcndhcmRUbykgdGhyb3cgZXJyCiAgICAgICAgaWYgKERhdGUubm93KCkgLSB0aGlzLmZhc3RGb3J3YXJkRmFpbGVkQXQgPCBNSU5fRkZfV0FJVCkgdGhyb3cgZXJyCiAgICAgICAgdGhpcy5mYXN0Rm9yd2FyZEZhaWxlZEF0ID0gRGF0ZS5ub3coKQogICAgICAgIC8vIGlmIGFuIEZGIGlzIGVuYWJsZWQgcmV0cnkKICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgX2FkdmFuY2UoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmICh0aGlzLnBhdXNlZCB8fCB0aGlzLl9pbnRlcnJ1cHRpbmcpIHJldHVybgoKICAgIHRoaXMuX2RyYWluaW5nID0gdHJ1ZQoKICAgIGlmICh0aGlzLl91cGRhdGVMb2NhbENvcmUgIT09IG51bGwpIHsKICAgICAgYXdhaXQgdGhpcy5fcm90YXRlTG9jYWxXcml0ZXIodGhpcy5fdXBkYXRlTG9jYWxDb3JlKQogICAgfQoKICAgIGNvbnN0IGxvY2FsID0gdGhpcy5sb2NhbC5sZW5ndGgKCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9kcmFpbldpdGhJbnRlcnVwdCgpCgogICAgICAvLyBtdXN0IHJ1biBwb3N0IGRyYWluIHNvIHRoZSBsaW5lYXJpemVyIGlzIGNhdWdodCB1cAogICAgICBpZiAodGhpcy5fY2F1Z2h0dXAgJiYgKHRoaXMuX25lZWRzV2FrZXVwID09PSB0cnVlIHx8IHRoaXMuX3dha2V1cEhpbnRzLnNpemUgPiAwKSkKICAgICAgICBhd2FpdCB0aGlzLl9kcmFpbldha2V1cCgpCgogICAgICAvLyBjaGVjayBpZiB3ZSBzaG91bGQgdXBkYXRlIGxvY2FsIHdyaXRlcgogICAgICBpZiAoIXRoaXMubG9jYWxXcml0ZXIgfHwgdGhpcy5sb2NhbFdyaXRlci5jbG9zZWQpIHsKICAgICAgICBhd2FpdCB0aGlzLl91cGRhdGVMb2NhbFdyaXRlcih0aGlzLl9hcHBseVN0YXRlLnN5c3RlbSkKICAgICAgfQoKICAgICAgdGhpcy5fZHJhaW5pbmcgPSBmYWxzZQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuX29uRXJyb3IoZXJyKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5faW50ZXJydXB0aW5nKSByZXR1cm4KCiAgICBpZiAodGhpcy5sb2NhbFdyaXRlciAmJiAhdGhpcy5sb2NhbFdyaXRlci5jbG9zZWQpIHsKICAgICAgaWYgKHRoaXMuX2FwcGx5U3RhdGUuaXNMb2NhbFBlbmRpbmdJbmRleGVyKCkpIHRoaXMuYWNrKCkuY2F0Y2gobm9vcCkKICAgICAgZWxzZSBpZiAodGhpcy5fdHJpZ2dlckFja0FzYXAoKSkgdGhpcy5fYWNrVGltZXIuYXNhcCgpCiAgICB9CgogICAgLy8ga2VlcCBib290c3RyYXBzIGluIHN5bmMgd2l0aCBsaW5lYXJpemVyCiAgICBpZiAodGhpcy51cGRhdGluZyA9PT0gdHJ1ZSB8fCB0aGlzLl9ib290c3RyYXBXcml0ZXJzQ2hhbmdlZCA9PT0gdHJ1ZSkgewogICAgICB0aGlzLl91cGRhdGVCb290c3RyYXBXcml0ZXJzKCkKICAgIH0KCiAgICBpZiAodGhpcy51cGRhdGluZyA9PT0gdHJ1ZSkgewogICAgICB0aGlzLnVwZGF0aW5nID0gZmFsc2UKCiAgICAgIGlmIChsb2NhbCAhPT0gdGhpcy5sb2NhbC5sZW5ndGgpIHRoaXMuX3Jlc2V0QWNrVGljaygpCiAgICAgIGVsc2UgdGhpcy5fYWNrVGljaysrCgogICAgICBpZiAoIXRoaXMuX2ludGVycnVwdGluZykgdGhpcy5lbWl0KCd1cGRhdGUnKQogICAgICB0aGlzLl93YWl0aW5nLm5vdGlmeShudWxsKQogICAgfQoKICAgIGlmICghdGhpcy5faW50ZXJydXB0aW5nKSBhd2FpdCB0aGlzLl9nY1dyaXRlcnMoKQogIH0KCiAgX3RyaWdnZXJBY2tBc2FwKCkgewogICAgaWYgKCF0aGlzLl9hY2tUaW1lcikgcmV0dXJuIGZhbHNlCgogICAgLy8gZmx1c2ggaWYgdGhyZXNob2xkIGlzIHJlYWNoZWQgYW5kIHdlIGFyZSBub3QgYWxyZWFkeSBhY2tpbmcKICAgIGlmICh0aGlzLl9hY2tUaWNrVGhyZXNob2xkICYmICF0aGlzLl9hY2tpbmcgJiYgdGhpcy5fYWNrVGljayA+PSB0aGlzLl9hY2tUaWNrVGhyZXNob2xkKSB7CiAgICAgIGlmICh0aGlzLl9hY2tUaW1lcikgewogICAgICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLmxpbmVhcml6ZXIuaW5kZXhlcnMpIHsKICAgICAgICAgIGlmICh3LmNvcmUubGVuZ3RoID4gdy5sZW5ndGgpIHJldHVybiBmYWxzZSAvLyB3YWl0IGZvciB0aGUgbm9ybWFsIGFjayBjeWNsZSBpbiB0aGlzIGNhc2UKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBfcXVldWVGYXN0Rm9yd2FyZCgpIHsKICAgIGlmICghdGhpcy5jb3JlLm9wZW5lZCkgcmV0dXJuCiAgICAvLyBzaG91bGQgaGF2ZSBhIGJldHRlciB3YXkgdG8gZ2V0IHRoaXMKICAgIGNvbnN0IGxhdGVzdFNpZ25lZExlbmd0aCA9IHRoaXMuY29yZS5jb3JlLnN0YXRlLmxlbmd0aAoKICAgIGlmICghdGhpcy5mYXN0Rm9yd2FyZEVuYWJsZWQgfHwgdGhpcy5mYXN0Rm9yd2FyZGluZyAhPT0gbnVsbCB8fCB0aGlzLl9pbnRlcnJ1cHRpbmcpIHJldHVybgoKICAgIGlmIChsYXRlc3RTaWduZWRMZW5ndGggLSB0aGlzLmNvcmUubGVuZ3RoIDwgdGhpcy5mYXN0Rm9yd2FyZE1pbmltdW0pIHJldHVybgogICAgaWYgKHRoaXMuZmFzdEZvcndhcmRUbyAhPT0gbnVsbCkgcmV0dXJuCiAgICBpZiAoRGF0ZS5ub3coKSAtIHRoaXMuZmFzdEZvcndhcmRGYWlsZWRBdCA8IE1JTl9GRl9XQUlUKSByZXR1cm4KCiAgICB0aGlzLl9ydW5GYXN0Rm9yd2FyZCgKICAgICAgbmV3IEZhc3RGb3J3YXJkKHRoaXMsIHRoaXMuY29yZS5rZXksIHsgbWluaW11bTogdGhpcy5mYXN0Rm9yd2FyZE1pbmltdW0gfSkKICAgICkuY2F0Y2gobm9vcCkKICB9CgogIF9xdWV1ZVN0YXRpY0Zhc3RGb3J3YXJkKGtleSkgewogICAgaWYgKCF0aGlzLmZhc3RGb3J3YXJkRW5hYmxlZCB8fCB0aGlzLmZhc3RGb3J3YXJkaW5nICE9PSBudWxsIHx8IHRoaXMuX2ludGVycnVwdGluZykgcmV0dXJuCiAgICBpZiAodGhpcy5mYXN0Rm9yd2FyZFRvICE9PSBudWxsKSByZXR1cm4KICAgIGlmIChEYXRlLm5vdygpIC0gdGhpcy5mYXN0Rm9yd2FyZEZhaWxlZEF0IDwgTUlOX0ZGX1dBSVQpIHJldHVybgoKICAgIHRoaXMuX3J1bkZhc3RGb3J3YXJkKG5ldyBGYXN0Rm9yd2FyZCh0aGlzLCBrZXksIHsgdmVyaWZpZWQ6IGZhbHNlIH0pKS5jYXRjaChub29wKQogIH0KCiAgX3VwZGF0ZUFjdGl2aXR5KCkgewogICAgdGhpcy5hY3RpdmVXcml0ZXJzLnVwZGF0ZUFjdGl2aXR5KCkKICAgIGlmICh0aGlzLl9hcHBseVN0YXRlKSB7CiAgICAgIGlmICh0aGlzLmlzRmFzdEZvcndhcmRpbmcoKSkgdGhpcy5fYXBwbHlTdGF0ZS5wYXVzZSgpCiAgICAgIGVsc2UgdGhpcy5fYXBwbHlTdGF0ZS5yZXN1bWUoKQogICAgfQoKICAgIC8vIGluIGNhc2Ugd2UgaWdub3JlZCB3YWtldXBzIGNhc2Ugd2Ugd2VyZSBmYXN0IGZvcndhcmRpbmcsIHJlcXVlc3QgdGhlbSBub3cgaWYgbm90CiAgICBpZiAodGhpcy5fbmVlZHNXYWtldXBSZXF1ZXN0ICYmICF0aGlzLmlzRmFzdEZvcndhcmRpbmcoKSAmJiB0aGlzLndha2V1cFNlc3Npb24pIHsKICAgICAgdGhpcy5fbmVlZHNXYWtldXBSZXF1ZXN0ID0gZmFsc2UKCiAgICAgIHRoaXMud2FrZXVwU2Vzc2lvbi5icm9hZGNhc3RMb29rdXAoe30pCiAgICB9CiAgfQoKICBfcHJlZmVyRmFzdEZvcndhcmQoKSB7CiAgICB0aGlzLmZhc3RGb3J3YXJkTWluaW11bSA9IDEKICAgIHRoaXMuX3F1ZXVlRmFzdEZvcndhcmQoKQogIH0KCiAgX3Bvc3RBcHBseSgpIHsKICAgIHRoaXMuZmFzdEZvcndhcmRNaW5pbXVtID0gRmFzdEZvcndhcmQuTUlOSU1VTQogIH0KCiAgYXN5bmMgX3J1bkZhc3RGb3J3YXJkKGZmKSB7CiAgICB0aGlzLmZhc3RGb3J3YXJkaW5nID0gZmYKCiAgICB0aGlzLl91cGRhdGVBY3Rpdml0eSgpCgogICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZmYudXBncmFkZSgpCiAgICBhd2FpdCBmZi5jbG9zZSgpCgogICAgaWYgKHRoaXMuZmFzdEZvcndhcmRpbmcgPT09IGZmKSB0aGlzLmZhc3RGb3J3YXJkaW5nID0gbnVsbAoKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIGlmIChmZi5mYWlsZWQpIHRoaXMuZmFzdEZvcndhcmRGYWlsZWRBdCA9IERhdGUubm93KCkKICAgICAgZWxzZSB0aGlzLl9xdWV1ZUZhc3RGb3J3YXJkKCkKICAgICAgdGhpcy5fdXBkYXRlQWN0aXZpdHkoKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLmZhc3RGb3J3YXJkRmFpbGVkQXQgPSAwCiAgICB0aGlzLmZhc3RGb3J3YXJkVG8gPSByZXN1bHQKCiAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZSAmJiB0aGlzLl9hcHBseVN0YXRlLmFwcGx5aW5nICYmIHRoaXMuZmFzdEZvcndhcmRNaW5pbXVtID09PSAxKSB7CiAgICAgIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuY2xvc2UoKQogICAgfQoKICAgIHRoaXMuX2J1bXBBY2tUaW1lcigpCiAgICB0aGlzLl9xdWV1ZUJ1bXAoKQogIH0KCiAgLy8gdHJpZ2dlcmVkIGZyb20gYXBwbHkKICBhc3luYyBfYWRkV3JpdGVyKGtleSwgc3lzKSB7CiAgICAvLyBqdXN0IGNvbXBhdCBmb3Igb2xkIHZlcnNpb24KICAgIGFzc2VydCghIXRoaXMuX2FwcGx5U3RhdGUuYXBwbHlpbmcsICdTeXN0ZW0gY2hhbmdlcyBhcmUgb25seSBhbGxvd2VkIGluIGFwcGx5JykKCiAgICBjb25zdCB3cml0ZXIgPQogICAgICAoYXdhaXQgdGhpcy5fZ2V0V3JpdGVyQnlLZXkoa2V5LCAtMSwgMCwgZmFsc2UsIHRydWUsIHN5cykpIHx8CiAgICAgIHRoaXMuX21ha2VXcml0ZXIoa2V5LCAwLCB0cnVlLCBmYWxzZSkKICAgIGF3YWl0IHdyaXRlci5yZWFkeSgpCgogICAgaWYgKCF0aGlzLmFjdGl2ZVdyaXRlcnMuaGFzKGtleSkpIHsKICAgICAgdGhpcy5hY3RpdmVXcml0ZXJzLmFkZCh3cml0ZXIpCiAgICAgIHRoaXMuX2NoZWNrV3JpdGVycy5wdXNoKHdyaXRlcikKICAgICAgdGhpcy5fZW5zdXJlV2FrZXVwKHdyaXRlcikKICAgIH0KCiAgICAvLyBmZXRjaCBhbnkgbm9kZXMgbmVlZGVkIGZvciBkZXBlbmRlbnRzCiAgICB0aGlzLl9xdWV1ZUJ1bXAoKQogIH0KCiAgLy8gdHJpZ2dlcmVkIGZyb20gYXBwbHkKICBfcmVtb3ZlV3JpdGVyKGtleSkgewogICAgLy8ganVzdCBjb21wYXQgZm9yIG9sZCB2ZXJzaW9uCiAgICBjb25zdCB3ID0gdGhpcy5hY3RpdmVXcml0ZXJzLmdldChrZXkpCiAgICBpZiAodykgdy5pc1JlbW92ZWQgPSB0cnVlCgogICAgdGhpcy5fcXVldWVCdW1wKCkKICB9CgogIHJlbW92ZWFibGUoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5fYXBwbHlTdGF0ZSA/IHRoaXMuX2FwcGx5U3RhdGUucmVtb3ZlYWJsZShrZXkpIDogZmFsc2UKICB9CgogIF91cGRhdGVBY2tUaHJlc2hvbGQoKSB7CiAgICBpZiAodGhpcy5fYWNrVGhyZXNob2xkID09PSAwKSByZXR1cm4KICAgIGlmICh0aGlzLl9hY2tUaW1lcikgdGhpcy5fYWNrVGltZXIuYmF1KCkKICAgIHRoaXMuX2Fja1RpY2sgPSAwCiAgICB0aGlzLl9hY2tUaWNrVGhyZXNob2xkID0gcmFuZG9tMm92ZXIxKHRoaXMubGluZWFyaXplci5pbmRleGVycy5sZW5ndGggKiB0aGlzLl9hY2tUaHJlc2hvbGQpCiAgfQoKICBfcmVzZXRBY2tUaWNrKCkgewogICAgdGhpcy5fYWNrVGljayA9IDAKICAgIGlmICh0aGlzLl9hY2tUaW1lcikgdGhpcy5fYWNrVGltZXIuYmF1KCkKICB9CgogIF9zaGlmdFdyaXRlcih3KSB7CiAgICB3LnNoaWZ0KCkKICAgIGlmICh3LmZsdXNoZWQoKSkgdGhpcy5fY2hlY2tXcml0ZXJzLnB1c2godykKICB9Cn0KCmZ1bmN0aW9uIHRvS2V5KGspIHsKICByZXR1cm4gYjRhLmlzQnVmZmVyKGspID8gayA6IGh5cGVyY29yZUlkLmRlY29kZShrKQp9CgpmdW5jdGlvbiBpc0F1dG9iYXNlTWVzc2FnZShtc2cpIHsKICByZXR1cm4gbXNnLmNoZWNrcG9pbnQgPyBtc2cuY2hlY2twb2ludC5sZW5ndGggPiAwIDogbXNnLmNoZWNrcG9pbnQgPT09IG51bGwKfQoKZnVuY3Rpb24gY29tcGFyZU5vZGVzKGEsIGIpIHsKICByZXR1cm4gYjRhLmNvbXBhcmUoYS5rZXksIGIua2V5KQp9CgpmdW5jdGlvbiByYW5kb20yb3ZlcjEobikgewogIHJldHVybiBNYXRoLmZsb29yKG4gKyBNYXRoLnJhbmRvbSgpICogbikKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CgpmdW5jdGlvbiBjcmFzaFNvb24oZXJyKSB7CiAgcXVldWVNaWNyb3Rhc2soKCkgPT4gewogICAgdGhyb3cgZXJyCiAgfSkKICB0aHJvdyBlcnIKfQoKZnVuY3Rpb24gaXNPYmplY3Qob2JqKSB7CiAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdvYmplY3QnICYmIG9iaiAhPT0gbnVsbAp9CgpmdW5jdGlvbiBlbWl0V2FybmluZyhlcnIpIHsKICBzYWZldHlDYXRjaChlcnIpCiAgdGhpcy5lbWl0KCd3YXJuaW5nJywgZXJyKQp9CgpmdW5jdGlvbiBub3JtYWxpemUodmFsdWVFbmNvZGluZywgdmFsdWUpIHsKICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyOiBudWxsLCBzdGFydDogMCwgZW5kOiAwIH0KICB2YWx1ZUVuY29kaW5nLnByZWVuY29kZShzdGF0ZSwgdmFsdWUpCiAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHN0YXRlLmVuZCkKICB2YWx1ZUVuY29kaW5nLmVuY29kZShzdGF0ZSwgdmFsdWUpCiAgc3RhdGUuc3RhcnQgPSAwCiAgcmV0dXJuIHZhbHVlRW5jb2RpbmcuZGVjb2RlKHN0YXRlKQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEFjdGl2ZVdyaXRlcnMgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5tYXAgPSBuZXcgTWFwKCkKICB9CgogIGdldCBzaXplKCkgewogICAgcmV0dXJuIHRoaXMubWFwLnNpemUKICB9CgogIFtTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgcmV0dXJuIHRoaXMubWFwLnZhbHVlcygpCiAgfQoKICBnZXQoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5tYXAuZ2V0KGI0YS50b1N0cmluZyhrZXksICdoZXgnKSkgfHwgbnVsbAogIH0KCiAgaGFzKGtleSkgewogICAgcmV0dXJuIHRoaXMuZ2V0KGtleSkgIT09IG51bGwKICB9CgogIGFkZCh3cml0ZXIpIHsKICAgIHRoaXMubWFwLnNldChiNGEudG9TdHJpbmcod3JpdGVyLmNvcmUua2V5LCAnaGV4JyksIHdyaXRlcikKICB9CgogIGRlbGV0ZSh3cml0ZXIpIHsKICAgIHRoaXMubWFwLmRlbGV0ZShiNGEudG9TdHJpbmcod3JpdGVyLmNvcmUua2V5LCAnaGV4JykpCiAgfQoKICB1cGRhdGVBY3Rpdml0eSgpIHsKICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLm1hcC52YWx1ZXMoKSkgdy51cGRhdGVBY3Rpdml0eSgpCiAgfQoKICBjbGVhcigpIHsKICAgIGNvbnN0IHAgPSBbXQogICAgZm9yIChjb25zdCB3IG9mIHRoaXMubWFwLnZhbHVlcygpKSBwLnB1c2gody5jbG9zZSgpKQogICAgdGhpcy5tYXAuY2xlYXIoKQoKICAgIHJldHVybiBQcm9taXNlLmFsbChwKQogIH0KfQpjb25zdCBTaWduYWxQcm9taXNlID0gcmVxdWlyZSgnc2lnbmFsLXByb21pc2UnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBBcHBlbmRCYXRjaCB7CiAgY29uc3RydWN0b3IoYmFzZSkgewogICAgdGhpcy5iYXNlID0gYmFzZQogICAgdGhpcy5ibG9ja3MgPSBbXQogICAgdGhpcy5jbG9zZWQgPSBmYWxzZQogICAgdGhpcy5mbHVzaGluZyA9IGZhbHNlCiAgICB0aGlzLl9mbHVzaGVkID0gbnVsbAogIH0KCiAgYXN5bmMgX2FjcXVpcmUoKSB7CiAgICB3aGlsZSAodGhpcy5iYXNlLmFjdGl2ZUJhdGNoICE9PSBudWxsICYmIHRoaXMuYmFzZS5hY3RpdmVCYXRjaCAhPT0gdGhpcykKICAgICAgYXdhaXQgdGhpcy5iYXNlLmFjdGl2ZUJhdGNoLmZsdXNoZWQoKQogICAgdGhpcy5iYXNlLmFjdGl2ZUJhdGNoID0gdGhpcwogIH0KCiAgYXN5bmMgYXBwZW5kKHZhbHVlKSB7CiAgICBpZiAodGhpcy5iYXNlLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMuYmFzZS5yZWFkeSgpCiAgICBpZiAodGhpcy5iYXNlLl9hZHZhbmNpbmcgIT09IG51bGwpIGF3YWl0IHRoaXMuYmFzZS5fYWR2YW5jaW5nCgogICAgaWYgKHRoaXMuY2xvc2VkKSB0aHJvdyBuZXcgRXJyb3IoJ0JhdGNoIGlzIGNsb3NlZCcpCiAgICBpZiAodGhpcy5iYXNlLmFjdGl2ZUJhdGNoICE9PSB0aGlzKSBhd2FpdCB0aGlzLl9hY3F1aXJlKCkKICAgIGlmICh0aGlzLmNsb3NlZCkgdGhyb3cgbmV3IEVycm9yKCdCYXRjaCBpcyBjbG9zZWQnKQoKICAgIHRoaXMuYmxvY2tzLnB1c2godmFsdWUpCiAgICByZXR1cm4gdGhpcy5iYXNlLmxvY2FsLmxlbmd0aCArIHRoaXMuYmxvY2tzLmxlbmd0aAogIH0KCiAgYXN5bmMgZmx1c2goKSB7CiAgICBpZiAodGhpcy5jbG9zZWQpIHRocm93IG5ldyBFcnJvcignQmF0Y2ggaXMgY2xvc2VkJykKICAgIGlmICh0aGlzLmZsdXNoaW5nKSByZXR1cm4gdGhpcy5mbHVzaGVkKCkKICAgIHRoaXMuZmx1c2hpbmcgPSB0cnVlCiAgICBpZiAodGhpcy5ibG9ja3MubGVuZ3RoKSBhd2FpdCB0aGlzLmJhc2UuX2FwcGVuZEJhdGNoKHRoaXMuYmxvY2tzKQogICAgcmV0dXJuIHRoaXMuY2xvc2UoKQogIH0KCiAgZmx1c2hlZCgpIHsKICAgIGlmICh0aGlzLmNsb3NlZCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCiAgICBpZiAodGhpcy5fZmx1c2hlZCkgcmV0dXJuIHRoaXMuX2ZsdXNoZWQud2FpdCgpCiAgICB0aGlzLl9mbHVzaGVkID0gbmV3IFNpZ25hbFByb21pc2UoKQogICAgcmV0dXJuIHRoaXMuX2ZsdXNoZWQud2FpdCgpCiAgfQoKICBjbG9zZSgpIHsKICAgIGlmICh0aGlzLmJhc2UuYWN0aXZlQmF0Y2ggIT09IHRoaXMpIHJldHVybgogICAgdGhpcy5iYXNlLmFjdGl2ZUJhdGNoID0gbnVsbAogICAgdGhpcy5jbG9zZWQgPSB0cnVlCiAgICBpZiAodGhpcy5fZmx1c2hlZCkgdGhpcy5fZmx1c2hlZC5ub3RpZnkobnVsbCkKICB9Cn0KY2xhc3MgUHVibGljQXBwbHlDYWxscyB7CiAgY29uc3RydWN0b3IoYmFzZSkgewogICAgdGhpcy5iYXNlID0gYmFzZQogICAgdGhpcy5pbnRlcm5hbCA9IGZhbHNlCiAgfQoKICBnZXQgZGlzY292ZXJ5S2V5KCkgewogICAgcmV0dXJuIHRoaXMuYmFzZS5kaXNjb3ZlcnlLZXkKICB9CgogIGdldCBrZXkoKSB7CiAgICByZXR1cm4gdGhpcy5iYXNlLmtleQogIH0KCiAgZ2V0IGlkKCkgewogICAgcmV0dXJuIHRoaXMuYmFzZS5pZAogIH0KCiAgYXN5bmMgYWRkV3JpdGVyKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgYWxsb3dlZCBvbiB0aGUgcHVibGljIHZpZXcnKQogIH0KCiAgYXN5bmMgYWNrV3JpdGVyKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgYWxsb3dlZCBvbiB0aGUgcHVibGljIHZpZXcnKQogIH0KCiAgYXN5bmMgcmVtb3ZlV3JpdGVyKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgYWxsb3dlZCBvbiB0aGUgcHVibGljIHZpZXcnKQogIH0KCiAgcHJlZmVyRmFzdEZvcndhcmQoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhbGxvd2VkIG9uIHRoZSBwdWJsaWMgdmlldycpCiAgfQoKICBpbnRlcnJ1cHQoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhbGxvd2VkIG9uIHRoZSBwdWJsaWMgdmlldycpCiAgfQoKICByZW1vdmVhYmxlKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgYWxsb3dlZCBvbiB0aGUgcHVibGljIHZpZXcnKQogIH0KCiAgZm9yaygpIHsKICAgIHRocm93IG5ldyBFcnJvcignTm90IGFsbG93ZWQgb24gdGhlIHB1YmxpYyB2aWV3JykKICB9CgogIGFuY2hvcigpIHsKICAgIHRocm93IG5ldyBFcnJvcignTm90IGFsbG93ZWQgb24gdGhlIHB1YmxpYyB2aWV3JykKICB9Cn0KCmNsYXNzIFByaXZhdGVBcHBseUNhbGxzIGV4dGVuZHMgUHVibGljQXBwbHlDYWxscyB7CiAgY29uc3RydWN0b3Ioc3RhdGUpIHsKICAgIHN1cGVyKHN0YXRlLmJhc2UpCiAgICB0aGlzLnN0YXRlID0gc3RhdGUKICAgIHRoaXMuaW50ZXJuYWwgPSB0cnVlCiAgfQoKICBnZXQgc3lzdGVtKCkgewogICAgcmV0dXJuIHRoaXMuc3RhdGUuc3lzdGVtCiAgfQoKICBhc3luYyBhZGRXcml0ZXIoa2V5LCB7IGluZGV4ZXIgPSB0cnVlLCBpc0luZGV4ZXIgPSBpbmRleGVyIH0gPSB7fSkgewogICAgLy8ganVzdCBjb21wYXQgZm9yIG9sZCB2ZXJzaW9uCiAgICBhd2FpdCB0aGlzLnN0YXRlLnN5c3RlbS5hZGQoa2V5LCB7IGlzSW5kZXhlciB9KQogICAgYXdhaXQgdGhpcy5iYXNlLl9hZGRXcml0ZXIoa2V5LCB0aGlzLnN0YXRlLnN5c3RlbSkKICB9CgogIGFzeW5jIGFja1dyaXRlcihrZXkpIHsKICAgIGF3YWl0IHRoaXMuc3RhdGUuc3lzdGVtLmFjayhrZXkpCiAgfQoKICBhc3luYyByZW1vdmVXcml0ZXIoa2V5KSB7CiAgICAvLyBqdXN0IGNvbXBhdCBmb3Igb2xkIHZlcnNpb24KICAgIGlmICghdGhpcy5zdGF0ZS5yZW1vdmVhYmxlKGtleSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgYWxsb3dlZCB0byByZW1vdmUgdGhlIGxhc3QgaW5kZXhlcicpCiAgICB9CgogICAgYXdhaXQgdGhpcy5zdGF0ZS5zeXN0ZW0ucmVtb3ZlKGtleSkKICAgIHRoaXMuYmFzZS5fcmVtb3ZlV3JpdGVyKGtleSkKICB9CgogIHByZWZlckZhc3RGb3J3YXJkKCkgewogICAgdGhpcy5iYXNlLl9wcmVmZXJGYXN0Rm9yd2FyZCgpCiAgfQoKICBpbnRlcnJ1cHQocmVhc29uKSB7CiAgICB0aGlzLmJhc2UuX2ludGVycnVwdChyZWFzb24pCiAgfQoKICByZW1vdmVhYmxlKGtleSkgewogICAgcmV0dXJuIHRoaXMuc3RhdGUucmVtb3ZlYWJsZShrZXkpCiAgfQoKICBhc3luYyBmb3JrKGluZGV4ZXJLZXlzLCBzeXN0ZW0pIHsKICAgIGlmICghKGF3YWl0IHRoaXMuc3RhdGUudmFsaWRhdGVGb3JrKGluZGV4ZXJLZXlzLCBzeXN0ZW0pKSkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgaW5kZXhlcnMgPSBpbmRleGVyS2V5cy5tYXAodG9JbmRleGVyKQoKICAgIHRoaXMuc3RhdGUucGVuZGluZ0ZvcmsgPSB7IGluZGV4ZXJzLCBsZW5ndGg6IHN5c3RlbS5sZW5ndGggfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBjcmVhdGVBbmNob3IoKSB7CiAgICByZXR1cm4gYXdhaXQgdGhpcy5zdGF0ZS5jcmVhdGVBbmNob3IoKQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSB7IFB1YmxpY0FwcGx5Q2FsbHMsIFByaXZhdGVBcHBseUNhbGxzIH0KCmZ1bmN0aW9uIHRvSW5kZXhlcihrZXkpIHsKICByZXR1cm4geyBrZXksIGxlbmd0aDogMCB9IC8vIGxlbmd0aCBpcyBub3QgdXNlZCwganVzdCBmb3IgYXBpIGNvbXBhdAp9CmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ25hbm9hc3NlcnQnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCgpjb25zdCB7IHBhcnRpYWxTaWduYXR1cmUgfSA9IHJlcXVpcmUoJ2h5cGVyY29yZS9saWIvbXVsdGlzaWcuanMnKQoKY29uc3QgU3lzdGVtVmlldyA9IHJlcXVpcmUoJy4vc3lzdGVtLmpzJykKY29uc3QgeyBBdXRvYmFzZUVuY3J5cHRpb24gfSA9IHJlcXVpcmUoJy4vZW5jcnlwdGlvbi5qcycpCmNvbnN0IFVwZGF0ZUNoYW5nZXMgPSByZXF1aXJlKCcuL3VwZGF0ZXMuanMnKQpjb25zdCBtZXNzYWdlcyA9IHJlcXVpcmUoJy4vbWVzc2FnZXMuanMnKQpjb25zdCB7IFByaXZhdGVBcHBseUNhbGxzIH0gPSByZXF1aXJlKCcuL2FwcGx5LWNhbGxzLmpzJykKY29uc3QgeyBlbmNvZGVWYWx1ZSB9ID0gcmVxdWlyZSgnLi92YWx1ZXMuanMnKQpjb25zdCBGb3JrID0gcmVxdWlyZSgnLi9mb3JrLmpzJykKY29uc3QgTG9jYWxTdGF0ZSA9IHJlcXVpcmUoJy4vbG9jYWwtc3RhdGUuanMnKQpjb25zdCB7IE9QTE9HX1ZFUlNJT04sIEJPT1RfUkVDT1JEX1ZFUlNJT04gfSA9IHJlcXVpcmUoJy4vY2Fwcy5qcycpCgovLyB0b2RvOiBleHBvc2UgdGhpcyBhcyBhbiBvcHRpb24KY29uc3QgU0hPVUxEX1NJR05fVEhSRVNIT0xEID0gMAoKY2xhc3MgQ2hlY2twb2ludENvcmUgewogIGNvbnN0cnVjdG9yKHZpZXcsIGNvcmUsIHNpZ25lciwgcGF1c2VkKSB7CiAgICB0aGlzLnZpZXcgPSB2aWV3CiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICB0aGlzLnNpZ25lciA9IHNpZ25lcgogICAgdGhpcy5sZW5ndGggPSAwCiAgICB0aGlzLmRpZ2VzdCA9IG51bGwKICAgIHRoaXMuc2lnbmF0dXJlcyA9IHsgc3lzdGVtOiBudWxsLCBlbmNyeXB0aW9uOiBudWxsLCB1c2VyOiBbXSB9CiAgICB0aGlzLmNsb3NlZCA9IGZhbHNlCiAgICB0aGlzLnBhdXNlZCA9IHBhdXNlZAogIH0KCiAgcGF1c2UoKSB7CiAgICB0aGlzLnBhdXNlZCA9IHRydWUKICB9CgogIHJlc3VtZSgpIHsKICAgIGlmICghdGhpcy5wYXVzZWQpIHJldHVybgogICAgdGhpcy5wYXVzZWQgPSBmYWxzZQogICAgdGhpcy51cGRhdGVCYWNrZ3JvdW5kKCkKICB9CgogIGFzeW5jIHVwZGF0ZSgpIHsKICAgIGlmIChhd2FpdCB0aGlzLnVwZGF0ZUNoZWNrcG9pbnRzKCkpIGF3YWl0IHRoaXMudmlldy5tYXliZVNpZ25lZCgpCiAgfQoKICBhc3luYyB1cGRhdGVDaGVja3BvaW50cygpIHsKICAgIGlmICh0aGlzLmNvcmUubGVuZ3RoIDw9IHRoaXMubGVuZ3RoIHx8IHRoaXMuY2xvc2VkIHx8IHRoaXMucGF1c2VkKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBsZW5ndGggPSB0aGlzLmNvcmUubGVuZ3RoCiAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IHRoaXMuY29yZS5nZXQobGVuZ3RoIC0gMSkKCiAgICBpZiAobGVuZ3RoIDw9IHRoaXMubGVuZ3RoIHx8IHRoaXMuY2xvc2VkIHx8ICF2YWx1ZS5kaWdlc3QgfHwgdGhpcy5wYXVzZWQpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IFtkaWdlc3QsIGNoZWNrcG9pbnRzXSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgICAgdGhpcy5faW5mbGF0ZURpZ2VzdChsZW5ndGgsIHZhbHVlLmRpZ2VzdCksCiAgICAgIHRoaXMuX2luZmxhdGVBbGxDaGVja3BvaW50cyhsZW5ndGgsIHZhbHVlLmNoZWNrcG9pbnQpCiAgICBdKQoKICAgIGlmIChsZW5ndGggPD0gdGhpcy5sZW5ndGggfHwgdGhpcy5jbG9zZWQgfHwgIWRpZ2VzdCB8fCAhY2hlY2twb2ludHMgfHwgdGhpcy5wYXVzZWQpIHJldHVybiBmYWxzZQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGVja3BvaW50cy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoY2hlY2twb2ludHNbaV0gPT09IG51bGwpIHJldHVybiBmYWxzZQogICAgfQoKICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLmRpZ2VzdCA9IGRpZ2VzdAogICAgdGhpcy5zaWduYXR1cmVzID0gY2hlY2twb2ludHMKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgdXBkYXRlQmFja2dyb3VuZCgpIHsKICAgIHJldHVybiB0aGlzLnVwZGF0ZSgpLmNhdGNoKHNhZmV0eUNhdGNoKQogIH0KCiAgdXBkYXRlSW50ZXJuYWxTaWduYXR1cmVzKGxlbmd0aCwgc2lnbmF0dXJlcykgewogICAgdGhpcy5zaWduYXR1cmVzLnN5c3RlbSA9IHVwZGF0ZVNpZ25hdHVyZShsZW5ndGgsIHNpZ25hdHVyZXMuc3lzdGVtLCB0aGlzLnNpZ25hdHVyZXMuc3lzdGVtKQogICAgdGhpcy5zaWduYXR1cmVzLmVuY3J5cHRpb24gPSB1cGRhdGVTaWduYXR1cmUoCiAgICAgIGxlbmd0aCwKICAgICAgc2lnbmF0dXJlcy5lbmNyeXB0aW9uLAogICAgICB0aGlzLnNpZ25hdHVyZXMuZW5jcnlwdGlvbgogICAgKQogIH0KCiAgdXBkYXRlVXNlclNpZ25hdHVyZXMobGVuZ3RoLCBzaWduYXR1cmVzKSB7CiAgICB0aGlzLnNpZ25hdHVyZXMudXNlciA9IHVwZGF0ZVNpZ25hdHVyZXMobGVuZ3RoLCBzaWduYXR1cmVzLCB0aGlzLnNpZ25hdHVyZXMudXNlcikKICB9CgogIG1ha2VDaGVja3BvaW50cyhsZW5ndGgpIHsKICAgIHJldHVybiB7CiAgICAgIHN5c3RlbTogbWFrZUNoZWNrcG9pbnQobGVuZ3RoLCB0aGlzLnNpZ25hdHVyZXMuc3lzdGVtKSwKICAgICAgZW5jcnlwdGlvbjogbWFrZUNoZWNrcG9pbnQobGVuZ3RoLCB0aGlzLnNpZ25hdHVyZXMuZW5jcnlwdGlvbiksCiAgICAgIHVzZXI6IG1ha2VDaGVja3BvaW50cyhsZW5ndGgsIHRoaXMuc2lnbmF0dXJlcy51c2VyKQogICAgfQogIH0KCiAgbWFrZURpZ2VzdChsZW5ndGgsIGtleSkgewogICAgaWYgKHRoaXMuZGlnZXN0ICYmICh0aGlzLmRpZ2VzdC5rZXkgPT09IGtleSB8fCBiNGEuZXF1YWxzKHRoaXMuZGlnZXN0LmtleSwga2V5KSkpIHsKICAgICAgcmV0dXJuIHsga2V5OiBudWxsLCBwb2ludGVyOiBsZW5ndGggLSB0aGlzLmRpZ2VzdC5hdCB9CiAgICB9CiAgICB0aGlzLmRpZ2VzdCA9IHsga2V5LCBhdDogbGVuZ3RoIH0KICAgIHJldHVybiB7IGtleSwgcG9pbnRlcjogMCB9CiAgfQoKICBhc3luYyByZWFkeSgpIHsKICAgIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCiAgICB0aGlzLmNvcmUub24oJ2FwcGVuZCcsIHRoaXMudXBkYXRlQmFja2dyb3VuZC5iaW5kKHRoaXMpKQogICAgaWYgKHRoaXMuY29yZS53cml0YWJsZSkgYXdhaXQgdGhpcy51cGRhdGVDaGVja3BvaW50cygpCiAgICB0aGlzLnVwZGF0ZUJhY2tncm91bmQoKQogIH0KCiAgc2lnbmVkTGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuc2lnbmF0dXJlcy5zeXN0ZW0gPyB0aGlzLnNpZ25hdHVyZXMuc3lzdGVtLmxlbmd0aCA6IDAKICB9CgogIGNsb3NlKCkgewogICAgdGhpcy5jbG9zZWQgPSB0cnVlCiAgICByZXR1cm4gdGhpcy5jb3JlLmNsb3NlKCkKICB9CgogIGFzeW5jIF9pbmZsYXRlRGlnZXN0KGxlbmd0aCwgZGlnKSB7CiAgICBpZiAoIWRpZykgcmV0dXJuIG51bGwKCiAgICBpZiAoZGlnLnBvaW50ZXIgPT09IDApIHsKICAgICAgcmV0dXJuIHsga2V5OiBkaWcua2V5LCBhdDogbGVuZ3RoIH0KICAgIH0KCiAgICBjb25zdCBsZW4gPSBsZW5ndGggLSBkaWcucG9pbnRlcgoKICAgIGlmICh0aGlzLmRpZ2VzdCAmJiBsZW4gPT09IHRoaXMuZGlnZXN0LmF0KSByZXR1cm4gdGhpcy5kaWdlc3QKICAgIGlmIChsZW4gPD0gMCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCB7IGRpZ2VzdCB9ID0gYXdhaXQgdGhpcy5jb3JlLmdldChsZW4gLSAxKQogICAgaWYgKCFkaWdlc3QgfHwgIWRpZ2VzdC5rZXkpIHJldHVybiBudWxsCgogICAgcmV0dXJuIHsga2V5OiBkaWdlc3Qua2V5LCBhdDogbGVuIH0KICB9CgogIF9zYW1lU2lnbmF0dXJlcyhiLCBhKSB7CiAgICByZXR1cm4gKAogICAgICBzYW1lU2lnbmF0dXJlKGEuc3lzdGVtLCBiLnN5c3RlbSkgJiYKICAgICAgc2FtZVNpZ25hdHVyZShhLmVuY3J5cHRpb24sIGIuZW5jcnlwdGlvbikgJiYKICAgICAgc2FtZVNpZ25hdHVyZXMoYS51c2VyLCBiLnVzZXIpCiAgICApCiAgfQoKICBhc3luYyBfaW5mbGF0ZUFsbENoZWNrcG9pbnRzKGxlbmd0aCwgY2hlY2twb2ludHMpIHsKICAgIGlmICghY2hlY2twb2ludHMpIHJldHVybiB7IHN5c3RlbTogbnVsbCwgZW5jcnlwdGlvbjogbnVsbCwgdXNlcjogW10gfQogICAgaWYgKHRoaXMuX3NhbWVTaWduYXR1cmVzKGNoZWNrcG9pbnRzLCB0aGlzLnNpZ25hdHVyZXMpKSByZXR1cm4gdGhpcy5zaWduYXR1cmVzCgogICAgY29uc3Qgc3lzdGVtID0gdGhpcy5faW5mbGF0ZVN5c3RlbUNoZWNrcG9pbnQoY2hlY2twb2ludHMuc3lzdGVtLCBsZW5ndGgpCiAgICBjb25zdCBlbmNyeXB0aW9uID0gdGhpcy5faW5mbGF0ZUVuY3J5cHRpb25DaGVja3BvaW50KGNoZWNrcG9pbnRzLmVuY3J5cHRpb24sIGxlbmd0aCkKCiAgICBjb25zdCB1c2VyID0gY2hlY2twb2ludHMudXNlciA/IG5ldyBBcnJheShjaGVja3BvaW50cy51c2VyLmxlbmd0aCkgOiBbXQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdXNlci5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjaGsgPSBjaGVja3BvaW50cy51c2VyW2ldCiAgICAgIHVzZXJbaV0gPSB0aGlzLl9pbmZsYXRlVXNlckNoZWNrcG9pbnQoY2hrLCBpLCBsZW5ndGgpCiAgICB9CgogICAgY29uc3QgW3N5c3RlbUNoZWNrcG9pbnQsIGVuY3J5cHRpb25DaGVja3BvaW50LCB1c2VyQ2hlY2twb2ludHNdID0gYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgICBzeXN0ZW0sCiAgICAgIGVuY3J5cHRpb24sCiAgICAgIFByb21pc2UuYWxsKHVzZXIpCiAgICBdKQoKICAgIHJldHVybiB7CiAgICAgIHN5c3RlbTogc3lzdGVtQ2hlY2twb2ludCwKICAgICAgZW5jcnlwdGlvbjogZW5jcnlwdGlvbkNoZWNrcG9pbnQsCiAgICAgIHVzZXI6IHVzZXJDaGVja3BvaW50cwogICAgfQogIH0KCiAgYXN5bmMgX2luZmxhdGVTeXN0ZW1DaGVja3BvaW50KGNoaywgY29yZUxlbmd0aCkgewogICAgaWYgKGNoay5jaGVja3BvaW50KSB7CiAgICAgIGNvbnN0IHsgc2lnbmF0dXJlLCBsZW5ndGggfSA9IGNoay5jaGVja3BvaW50CiAgICAgIHJldHVybiB7IHNpZ25hdHVyZSwgbGVuZ3RoLCBhdDogY29yZUxlbmd0aCB9CiAgICB9CgogICAgY29uc3QgbGVuID0gY29yZUxlbmd0aCAtIGNoay5jaGVja3BvaW50ZXIKICAgIGlmICh0aGlzLnNpZ25hdHVyZXMuc3lzdGVtICYmIHRoaXMuc2lnbmF0dXJlcy5zeXN0ZW0uYXQgPT09IGxlbikgewogICAgICByZXR1cm4gdGhpcy5zaWduYXR1cmVzLnN5c3RlbQogICAgfQoKICAgIGlmIChsZW4gPD0gMCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCB7IGNoZWNrcG9pbnQgfSA9IGF3YWl0IHRoaXMuY29yZS5nZXQobGVuIC0gMSkKICAgIGlmICghY2hlY2twb2ludCB8fCAhY2hlY2twb2ludC5zeXN0ZW0gfHwgIWNoZWNrcG9pbnQuc3lzdGVtLmNoZWNrcG9pbnQpIHJldHVybiBudWxsCgogICAgY29uc3QgeyBzaWduYXR1cmUsIGxlbmd0aCB9ID0gY2hlY2twb2ludC5zeXN0ZW0uY2hlY2twb2ludAogICAgcmV0dXJuIHsgc2lnbmF0dXJlLCBsZW5ndGgsIGF0OiBsZW4gfQogIH0KCiAgYXN5bmMgX2luZmxhdGVFbmNyeXB0aW9uQ2hlY2twb2ludChjaGssIGNvcmVMZW5ndGgpIHsKICAgIGlmICghY2hrKSByZXR1cm4geyBsZW5ndGg6IDAsIHNpZ25hdHVyZTogbnVsbCwgYXQ6IDAgfQoKICAgIGlmIChjaGsuY2hlY2twb2ludCkgewogICAgICBjb25zdCB7IHNpZ25hdHVyZSwgbGVuZ3RoIH0gPSBjaGsuY2hlY2twb2ludAogICAgICByZXR1cm4geyBzaWduYXR1cmUsIGxlbmd0aCwgYXQ6IGNvcmVMZW5ndGggfQogICAgfQoKICAgIGNvbnN0IGxlbiA9IGNvcmVMZW5ndGggLSBjaGsuY2hlY2twb2ludGVyCiAgICBpZiAodGhpcy5zaWduYXR1cmVzLmVuY3J5cHRpb24gJiYgdGhpcy5zaWduYXR1cmVzLmVuY3J5cHRpb24uYXQgPT09IGxlbikgewogICAgICByZXR1cm4gdGhpcy5zaWduYXR1cmVzLmVuY3J5cHRpb24KICAgIH0KCiAgICBpZiAobGVuIDw9IDApIHJldHVybiBudWxsCgogICAgY29uc3QgeyBjaGVja3BvaW50IH0gPSBhd2FpdCB0aGlzLmNvcmUuZ2V0KGxlbiAtIDEpCiAgICBpZiAoIWNoZWNrcG9pbnQgfHwgIWNoZWNrcG9pbnQuZW5jcnlwdGlvbiB8fCAhY2hlY2twb2ludC5lbmNyeXB0aW9uLmNoZWNrcG9pbnQpIHJldHVybiBudWxsCgogICAgY29uc3QgeyBzaWduYXR1cmUsIGxlbmd0aCB9ID0gY2hlY2twb2ludC5lbmNyeXB0aW9uLmNoZWNrcG9pbnQKICAgIHJldHVybiB7IHNpZ25hdHVyZSwgbGVuZ3RoLCBhdDogbGVuIH0KICB9CgogIGFzeW5jIF9pbmZsYXRlVXNlckNoZWNrcG9pbnQoY2hrLCBpLCBjb3JlTGVuZ3RoKSB7CiAgICBpZiAoY2hrLmNoZWNrcG9pbnQpIHsKICAgICAgY29uc3QgeyBzaWduYXR1cmUsIGxlbmd0aCB9ID0gY2hrLmNoZWNrcG9pbnQKICAgICAgcmV0dXJuIHsgc2lnbmF0dXJlLCBsZW5ndGgsIGF0OiBjb3JlTGVuZ3RoIH0KICAgIH0KCiAgICBjb25zdCBsZW4gPSBjb3JlTGVuZ3RoIC0gY2hrLmNoZWNrcG9pbnRlcgogICAgaWYgKGkgPCB0aGlzLnNpZ25hdHVyZXMudXNlci5sZW5ndGggJiYgdGhpcy5zaWduYXR1cmVzLnVzZXJbaV0uYXQgPT09IGxlbikgewogICAgICByZXR1cm4gdGhpcy5zaWduYXR1cmVzLnVzZXJbaV0KICAgIH0KCiAgICBpZiAobGVuIDw9IDApIHJldHVybiBudWxsCgogICAgY29uc3QgeyBjaGVja3BvaW50IH0gPSBhd2FpdCB0aGlzLmNvcmUuZ2V0KGxlbiAtIDEpCiAgICBpZiAoIWNoZWNrcG9pbnQgfHwgaSA+PSBjaGVja3BvaW50LnVzZXIubGVuZ3RoIHx8ICFjaGVja3BvaW50LnVzZXJbaV0uY2hlY2twb2ludCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCB7IHNpZ25hdHVyZSwgbGVuZ3RoIH0gPSBjaGVja3BvaW50LnVzZXJbaV0uY2hlY2twb2ludAogICAgcmV0dXJuIHsgc2lnbmF0dXJlLCBsZW5ndGgsIGF0OiBsZW4gfQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBBcHBseVN0YXRlIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IoYmFzZSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuYmFzZSA9IGJhc2UKICAgIHRoaXMuZW5jcnlwdGlvbiA9IHRoaXMuYmFzZS5lbmNyeXB0aW9uCiAgICB0aGlzLnZhbHVlRW5jb2RpbmcgPSBiYXNlLnZhbHVlRW5jb2RpbmcKICAgIHRoaXMuc3RvcmUgPSBiYXNlLl92aWV3U3RvcmUuYXRvbWl6ZSgpCiAgICB0aGlzLmtleSA9IG51bGwKICAgIHRoaXMuc3lzdGVtID0gbnVsbAogICAgdGhpcy52aWV3ID0gbnVsbAogICAgdGhpcy52aWV3cyA9IFtdCiAgICB0aGlzLnN5c3RlbVZpZXcgPSBudWxsCiAgICB0aGlzLmVuY3J5cHRpb25WaWV3ID0gbnVsbAogICAgdGhpcy5ob3N0Y2FsbHMgPSBudWxsCiAgICB0aGlzLmNoYW5nZXMgPSBiYXNlLl9oYXNVcGRhdGUgPyBuZXcgVXBkYXRlQ2hhbmdlcyhiYXNlKSA6IG51bGwKCiAgICB0aGlzLnVwZGF0ZXMgPSBbXQoKICAgIHRoaXMubG9jYWwgPSBudWxsCiAgICB0aGlzLmxvY2FsU3RhdGUgPSBudWxsCgogICAgdGhpcy5mYXN0Rm9yd2FyZGluZyA9IGZhbHNlCiAgICB0aGlzLmluZGV4ZXJzVXBkYXRlZCA9IGZhbHNlCiAgICB0aGlzLnF1b3J1bSA9IDAKICAgIHRoaXMubmVlZHNJbmRleGVkTGVuZ3RoVXBkYXRlID0gZmFsc2UKICAgIHRoaXMuaW50ZXJydXB0ZWQgPSBmYWxzZQogICAgdGhpcy5hcHBseWluZyA9IG51bGwKICAgIHRoaXMuYXBwbHlCYXRjaCA9IG51bGwKCiAgICB0aGlzLmxvY2FsQ2hlY2twb2ludCA9IG51bGwKICAgIHRoaXMubG9jYWxJbmRleGVyID0gZmFsc2UKCiAgICB0aGlzLnN5c3RlbVVwZ3JhZGUgPSBudWxsCgogICAgdGhpcy5jaGVja3BvaW50cyA9IFtdCiAgICB0aGlzLnBlbmRpbmdWaWV3cyA9IG51bGwKICAgIHRoaXMucGVuZGluZ0ZvcmsgPSBudWxsCiAgICB0aGlzLmRpcnR5ID0gZmFsc2UKICB9CgogIHNob3VsZEZsdXNoKCkgewogICAgcmV0dXJuIHRoaXMuZGlydHkKICB9CgogIGFzeW5jIHNob3VsZFdyaXRlKCkgewogICAgaWYgKCF0aGlzLmxvY2FsSW5kZXhlciB8fCAhdGhpcy5sb2NhbENoZWNrcG9pbnQgfHwgIXRoaXMubG9jYWxDaGVja3BvaW50LmNvcmUub3BlbmVkKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnN0IGluZm8gPSBhd2FpdCB0aGlzLnN5c3RlbS5nZXRJbmRleGVkSW5mbyh0aGlzLmluZGV4ZWRMZW5ndGgpCiAgICBpZiAoIWluZm8udmlld3MubGVuZ3RoKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCB7IGVuY3J5cHRpb24sIHVzZXIgfSA9IHRoaXMubG9jYWxDaGVja3BvaW50LnNpZ25hdHVyZXMKCiAgICAvLyB0b2RvOiBkb2VzIHRoaXMgY29uZGl0aW9uIGhvbGQgZm9yIHNvZnQtZm9yaz8KICAgIGlmIChpbmZvLnZpZXdzLmxlbmd0aCA+IHVzZXIubGVuZ3RoKSByZXR1cm4gdHJ1ZQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5mby52aWV3cy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodXNlcltpXS5sZW5ndGggKyBTSE9VTERfU0lHTl9USFJFU0hPTEQgPCBpbmZvLnZpZXdzW2ldLmxlbmd0aCkgcmV0dXJuIHRydWUKICAgIH0KCiAgICAvLyBhbHdheXMgZmx1c2ggZW5jcnlwdGlvbiBzaWduYXR1cmUKICAgIGlmIChpbmZvLmVuY3J5cHRpb25MZW5ndGggIT09IDApIHsKICAgICAgaWYgKCFlbmNyeXB0aW9uIHx8IGVuY3J5cHRpb24ubGVuZ3RoIDwgaW5mby5lbmNyeXB0aW9uTGVuZ3RoKSByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgZ2V0IGluZGV4ZWRMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5zeXN0ZW1WaWV3ID8gdGhpcy5zeXN0ZW1WaWV3LmluZGV4ZWRMZW5ndGggOiAwCiAgfQoKICBnZXQgc3lzdGVtUmVmKCkgewogICAgcmV0dXJuIHRoaXMuc3lzdGVtVmlldyA/IHRoaXMuc3lzdGVtVmlldy5yZWYgOiBudWxsCiAgfQoKICBhc3luYyB2YWxpZGF0ZUZvcmsoaW5kZXhlcktleXMsIHN5c3RlbSkgewogICAgaWYgKCFiNGEuZXF1YWxzKHN5c3RlbS5rZXksIHRoaXMuc3lzdGVtLmNvcmUua2V5KSkgcmV0dXJuIGZhbHNlCiAgICBpZiAodGhpcy5wZW5kaW5nSW5kZXhlZExlbmd0aCgpIDwgc3lzdGVtLmxlbmd0aCkgcmV0dXJuIGZhbHNlCiAgICBmb3IgKGNvbnN0IGtleSBvZiBpbmRleGVyS2V5cykgewogICAgICBjb25zdCBpbmZvID0gYXdhaXQgdGhpcy5zeXN0ZW0uZ2V0KGtleSkKCiAgICAgIC8vIHdyaXRlciBzaG91bGQgYmUgYWN0aXZlIGFuZCB3ZSBuZWVkIG1hbmlmZXN0CiAgICAgIGlmICghaW5mbyB8fCAhaW5mby5sZW5ndGggfHwgaW5mby5pc1JlbW92ZWQpIHJldHVybiBmYWxzZQogICAgfQogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIHNob3VsZE1pZ3JhdGUoKSB7CiAgICBpZiAoIXRoaXMuZmFzdEZvcndhcmRpbmcgJiYgIXRoaXMuaW5kZXhlcnNVcGRhdGVkKSByZXR1cm4gZmFsc2UKICAgIGlmICh0aGlzLnN5c3RlbS5pbmRleGVycy5sZW5ndGggPT09IDApIHJldHVybiBmYWxzZSAvLyBnZW5lc2lzCgogICAgLy8gc2FuaXR5LCBwcmVmZXIgbWlncmF0aW9uCiAgICBpZiAoIXRoaXMuc3lzdGVtLmNvcmUubWFuaWZlc3QgfHwgIXRoaXMuc3lzdGVtLmNvcmUubWFuaWZlc3Quc2lnbmVycykgcmV0dXJuIHRydWUKCiAgICAvLyBlYXN5IG1vZGUKICAgIGlmICh0aGlzLnN5c3RlbS5pbmRleGVycy5sZW5ndGggIT09IHRoaXMuc3lzdGVtLmNvcmUubWFuaWZlc3Quc2lnbmVycy5sZW5ndGgpIHsKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBjb25zdCBtYW5pZmVzdHMgPSBhd2FpdCB0aGlzLnN0b3JlLmdldEluZGV4ZXJNYW5pZmVzdHModGhpcy5zeXN0ZW0uaW5kZXhlcnMpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnN5c3RlbS5jb3JlLm1hbmlmZXN0LnNpZ25lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgeyBwdWJsaWNLZXkgfSA9IHRoaXMuc3lzdGVtLmNvcmUubWFuaWZlc3Quc2lnbmVyc1tpXQogICAgICBpZiAoIWI0YS5lcXVhbHMocHVibGljS2V5LCBtYW5pZmVzdHNbaV0uc2lnbmVyc1swXS5wdWJsaWNLZXkpKSByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgaXNMb2NhbFBlbmRpbmdJbmRleGVyKCkgewogICAgaWYgKHRoaXMuc3lzdGVtLnBlbmRpbmdJbmRleGVycy5sZW5ndGggPT09IDApIHJldHVybiBmYWxzZQogICAgY29uc3Qga2V5ID0gdGhpcy5iYXNlLmxvY2FsLmtleQogICAgZm9yIChjb25zdCBrIG9mIHRoaXMuc3lzdGVtLnBlbmRpbmdJbmRleGVycykgewogICAgICBpZiAoYjRhLmVxdWFscyhrLCBrZXkpKSByZXR1cm4gIWI0YS5lcXVhbHModGhpcy5iYXNlLmtleSwga2V5KSAmJiB0aGlzLmJhc2UubG9jYWwubGVuZ3RoID09PSAwCiAgICB9CiAgICByZXR1cm4gZmFsc2UKICB9CgogIHJlbW92ZWFibGUoa2V5KSB7CiAgICBpZiAodGhpcy5zeXN0ZW0uaW5kZXhlcnMubGVuZ3RoICE9PSAxKSByZXR1cm4gdHJ1ZQogICAgcmV0dXJuICFiNGEuZXF1YWxzKHRoaXMuc3lzdGVtLmluZGV4ZXJzWzBdLmtleSwga2V5KQogIH0KCiAgaXNMb2NhbEluZGV4ZXIoKSB7CiAgICByZXR1cm4gISF0aGlzLmxvY2FsQ2hlY2twb2ludAogIH0KCiAgX2NyZWF0ZUNoZWNrcG9pbnRDb3JlKGtleSwgYWN0aXZlLCBzaWduZXIsIHBhdXNlZCkgewogICAgY29uc3QgZW5jcnlwdGlvbiA9IHRoaXMuYmFzZS5nZXRXcml0ZXJFbmNyeXB0aW9uKGtleSkKCiAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5iYXNlLnN0b3JlLmdldCh7CiAgICAgIGtleSwKICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlLAogICAgICBlbmNyeXB0aW9uLAogICAgICBhY3RpdmUKICAgIH0pCgogICAgcmV0dXJuIG5ldyBDaGVja3BvaW50Q29yZSh0aGlzLCBzZXNzaW9uLCBzaWduZXIsIHBhdXNlZCkKICB9CgogIGFzeW5jIF9vcGVuSW50ZXJuYWxWaWV3KG5hbWUsIGluZGV4ZWRMZW5ndGgpIHsKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7IG5hbWUgfSkKICAgIGF3YWl0IGNvcmUucmVhZHkoKQogICAgYXdhaXQgY29yZS5zZXRVc2VyRGF0YSgncmVmZXJyZXInLCB0aGlzLmJhc2Uua2V5KQogICAgYXdhaXQgY29yZS5zZXRVc2VyRGF0YSgnYXV0b2Jhc2UvdmlldycsIGI0YS5mcm9tKG5hbWUpKQoKICAgIGNvbnN0IHJlZiA9IHRoaXMuc3RvcmUuZ2V0Vmlld0J5TmFtZShuYW1lKQoKICAgIHJldHVybiB7IHJlZiwgY29yZSwgaW5kZXhlZExlbmd0aCB9CiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2Jvb3QoKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGF3YWl0IHRoaXMuX2ZyZWUoKQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIGFzeW5jIF9ib290KCkgewogICAgY29uc3QgYm9vdCA9IGF3YWl0IHRoaXMuYmFzZS5fZ2V0Qm9vdFJlY29yZCgpCgogICAgdGhpcy5zeXN0ZW1WaWV3ID0gYXdhaXQgdGhpcy5fb3BlbkludGVybmFsVmlldygnX3N5c3RlbScsIGJvb3Quc3lzdGVtTGVuZ3RoKQogICAgdGhpcy5lbmNyeXB0aW9uVmlldyA9IGF3YWl0IHRoaXMuX29wZW5JbnRlcm5hbFZpZXcoJ19lbmNyeXB0aW9uJywgLTEpCgogICAgY29uc3Qgc3lzQ29yZSA9IHRoaXMuc3lzdGVtVmlldy5jb3JlCiAgICBpZiAoc3lzQ29yZS5tYW5pZmVzdC52ZXJzaW9uID49IDIpIHsKICAgICAgaWYgKHRoaXMuZW5jcnlwdGlvbiAhPT0gbnVsbCkgYXdhaXQgdGhpcy5lbmNyeXB0aW9uLnJlbG9hZCh0aGlzLmVuY3J5cHRpb25WaWV3LmNvcmUpCiAgICB9CgogICAgY29uc3Qgc3lzdGVtID0gbmV3IFN5c3RlbVZpZXcoc3lzQ29yZSkKICAgIGF3YWl0IHN5c3RlbS5yZWFkeSgpCgogICAgLy8gcmVzZXQgc28gd2UgZG9udCB0cmFjayBfc3lzdGVtIG9yIF9lbmNyeXB0aW9uCiAgICB0aGlzLnN0b3JlLm9wZW5lZCA9IFtdCgogICAgdGhpcy5ob3N0Y2FsbHMgPSBuZXcgUHJpdmF0ZUFwcGx5Q2FsbHModGhpcykKICAgIGNvbnN0IHZpZXcgPSB0aGlzLmJhc2UuX2hhc09wZW4gPyB0aGlzLmJhc2UuX2hhbmRsZXJzLm9wZW4odGhpcy5zdG9yZSwgdGhpcy5ob3N0Y2FsbHMpIDogbnVsbAoKICAgIHRoaXMudmlldyA9IHZpZXcKICAgIHRoaXMuc3lzdGVtID0gc3lzdGVtCgogICAgLy8gZW5zdXJlIGFsbCBhcmUgcmVhZHkKICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLnN0b3JlLm9wZW5lZCkgYXdhaXQgdi5hdG9taWNCYXRjaC5yZWFkeSgpCgogICAgdGhpcy5rZXkgPSBzeXN0ZW0uY29yZS5rZXkKCiAgICB0aGlzLmZhc3RGb3J3YXJkaW5nID0gYm9vdC5mYXN0Rm9yd2FyZGluZwogICAgdGhpcy5pbmRleGVyc1VwZGF0ZWQgPSBib290LmluZGV4ZXJzVXBkYXRlZAogICAgdGhpcy5xdW9ydW0gPSBzeXNDb3JlLm1hbmlmZXN0ID8gc3lzQ29yZS5tYW5pZmVzdC5xdW9ydW0gOiAwCgogICAgY29uc3QgYWRkZWQgPSBuZXcgU2V0KCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN5c3RlbS52aWV3cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB7IGtleSwgbGVuZ3RoIH0gPSBzeXN0ZW0udmlld3NbaV0KICAgICAgY29uc3QgdiA9IGF3YWl0IHRoaXMuc3RvcmUuZmluZFZpZXdCeUtleSgKICAgICAgICBrZXksCiAgICAgICAgc3lzdGVtLmluZGV4ZXJzLAogICAgICAgIHN5c0NvcmUubWFuaWZlc3QudmVyc2lvbiwKICAgICAgICBzeXN0ZW0uZW50cm9weQogICAgICApCgogICAgICBpZiAodiA9PT0gbnVsbCkgewogICAgICAgIHRoaXMudmlld3MucHVzaCh7IG5hbWU6IG51bGwsIGtleSwgbGVuZ3RoLCBjb3JlOiBudWxsLCByZWY6IG51bGwsIG1hcHBlZEluZGV4OiBpIH0pCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgYXdhaXQgdi5hdG9taWNCYXRjaC5yZWFkeSgpCiAgICAgIGF3YWl0IHYuY29yZS5zZXRVc2VyRGF0YSgncmVmZXJyZXInLCB0aGlzLmJhc2Uua2V5KQogICAgICBhd2FpdCB2LmNvcmUuc2V0VXNlckRhdGEoJ2F1dG9iYXNlL3ZpZXcnLCBiNGEuZnJvbSh2Lm5hbWUpKQoKICAgICAgdGhpcy52aWV3cy5wdXNoKHsgbmFtZTogdi5uYW1lLCBrZXksIGxlbmd0aCwgY29yZTogdi5hdG9taWNCYXRjaCwgcmVmOiB2LCBtYXBwZWRJbmRleDogaSB9KQoKICAgICAgYWRkZWQuYWRkKHYpCiAgICB9CgogICAgZm9yIChjb25zdCB2IG9mIHRoaXMuc3RvcmUub3BlbmVkKSB7CiAgICAgIGlmIChhZGRlZC5oYXModikpIGNvbnRpbnVlCiAgICAgIGNvbnN0IGNvcmUgPSB2LmF0b21pY0JhdGNoCgogICAgICB0aGlzLnZpZXdzLnB1c2goewogICAgICAgIG5hbWU6IHYubmFtZSwKICAgICAgICBrZXk6IGNvcmUua2V5LAogICAgICAgIGxlbmd0aDogY29yZS5sZW5ndGgsCiAgICAgICAgY29yZSwKICAgICAgICByZWY6IHYsCiAgICAgICAgbWFwcGVkSW5kZXg6IC0xCiAgICAgIH0pCiAgICB9CgogICAgdGhpcy5sb2NhbCA9IHRoaXMuc3RvcmUuZ2V0TG9jYWwoKQogICAgYXdhaXQgdGhpcy5sb2NhbC5yZWFkeSgpCgogICAgdGhpcy5sb2NhbFN0YXRlID0gbmV3IExvY2FsU3RhdGUodGhpcy5sb2NhbCkKCiAgICBsZXQgaXNMb2NhbEluZGV4ZXIgPSBmYWxzZQoKICAgIGNvbnN0IHBhdXNlZCA9IHRoaXMuYmFzZS5pc0Zhc3RGb3J3YXJkaW5nKCkKICAgIGNvbnN0IGluZiA9IGF3YWl0IHRoaXMuc3lzdGVtLmdldEluZGV4ZWRJbmZvKCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZi5pbmRleGVycy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBpZHggPSBpbmYuaW5kZXhlcnNbaV0KICAgICAgY29uc3QgY2hrID0gdGhpcy5fY3JlYXRlQ2hlY2twb2ludENvcmUoaWR4LmtleSwgdHJ1ZSwgaSwgcGF1c2VkKQogICAgICBhd2FpdCBjaGsucmVhZHkoKQogICAgICB0aGlzLmNoZWNrcG9pbnRzLnB1c2goY2hrKQogICAgICBpZiAoYjRhLmVxdWFscyhpZHgua2V5LCB0aGlzLmJhc2UubG9jYWwua2V5KSkgaXNMb2NhbEluZGV4ZXIgPSB0cnVlCiAgICB9CgogICAgY29uc3Qgc2hvdWxkU2lnbiA9IHRoaXMucXVvcnVtID4gMCAmJiBpc0xvY2FsSW5kZXhlcgoKICAgIGlmIChzaG91bGRTaWduKSB7CiAgICAgIHRoaXMubG9jYWxJbmRleGVyID0gdHJ1ZQogICAgICBhd2FpdCB0aGlzLl9zdGFydExvY2FsQ2hlY2twb2ludCgpCiAgICB9CgogICAgYXdhaXQgdGhpcy5fcmVmcmVzaFdyaXRlcnMoKQoKICAgIC8vIGRlZmVycmVkCiAgICB0aGlzLm1heWJlU2lnbmVkKCkuY2F0Y2gobm9vcCkKICB9CgogIGFzeW5jIF9zdGFydExvY2FsQ2hlY2twb2ludCgpIHsKICAgIGZvciAoY29uc3QgY2hrIG9mIHRoaXMuY2hlY2twb2ludHMpIHsKICAgICAgaWYgKGNoay5jb3JlLmlkID09PSB0aGlzLmJhc2UubG9jYWwuaWQpIHsKICAgICAgICB0aGlzLmxvY2FsQ2hlY2twb2ludCA9IGNoawogICAgICAgIHJldHVybgogICAgICB9CiAgICB9CgogICAgdGhpcy5sb2NhbENoZWNrcG9pbnQgPSB0aGlzLl9jcmVhdGVDaGVja3BvaW50Q29yZSh0aGlzLmJhc2UubG9jYWwua2V5LCBmYWxzZSwgMCwgZmFsc2UpCiAgICBhd2FpdCB0aGlzLmxvY2FsQ2hlY2twb2ludC5yZWFkeSgpCiAgfQoKICBpbnRlcnJ1cHQoKSB7CiAgICB0aGlzLmludGVycnVwdGVkID0gdHJ1ZQogICAgdGhpcy5wYXVzZSgpCiAgfQoKICBwYXVzZSgpIHsKICAgIGZvciAoY29uc3QgY2hrIG9mIHRoaXMuY2hlY2twb2ludHMpIHsKICAgICAgaWYgKGNoayAhPT0gdGhpcy5sb2NhbENoZWNrcG9pbnQpIGNoay5wYXVzZSgpCiAgICB9CiAgfQoKICByZXN1bWUoKSB7CiAgICBmb3IgKGNvbnN0IGNoayBvZiB0aGlzLmNoZWNrcG9pbnRzKSB7CiAgICAgIGlmIChjaGsgIT09IHRoaXMubG9jYWxDaGVja3BvaW50KSBjaGsucmVzdW1lKCkKICAgIH0KICB9CgogIF9jaGVja1N5c3RlbVVwZ3JhZGUoKSB7CiAgICBpZiAodGhpcy5zeXN0ZW1VcGdyYWRlKSByZXR1cm4KCiAgICBjb25zdCB0YWxseSA9IG5ldyBNYXAoKQoKICAgIGZvciAoY29uc3QgY2hrIG9mIHRoaXMuY2hlY2twb2ludHMpIHsKICAgICAgaWYgKGNoay5zaWduZWRMZW5ndGgoKSA8PSB0aGlzLnN5c3RlbS5jb3JlLnNpZ25lZExlbmd0aCkgY29udGludWUKICAgICAgaWYgKCFjaGsuZGlnZXN0KSBjb250aW51ZQoKICAgICAgY29uc3QgaWQgPSBiNGEudG9TdHJpbmcoY2hrLmRpZ2VzdC5rZXksICdoZXgnKQogICAgICBjb25zdCBjbnQgPSAodGFsbHkuZ2V0KGlkKSB8fCAwKSArIDEKCiAgICAgIGlmIChjbnQgPj0gdGhpcy5xdW9ydW0pIHsKICAgICAgICB0aGlzLnN5c3RlbVVwZ3JhZGUgPSBjaGsuZGlnZXN0LmtleQogICAgICAgIHRoaXMuYmFzZS5fcXVldWVTdGF0aWNGYXN0Rm9yd2FyZCh0aGlzLnN5c3RlbVVwZ3JhZGUpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIHRhbGx5LnNldChpZCwgY250KQogICAgfQogIH0KCiAgbWFwSW5kZXhUb1ZpZXcoaW5kZXgpIHsKICAgIGZvciAoY29uc3QgeyBtYXBwZWRJbmRleCwgcmVmIH0gb2YgdGhpcy52aWV3cykgewogICAgICBpZiAobWFwcGVkSW5kZXggPT09IGluZGV4KSByZXR1cm4gcmVmCiAgICB9CiAgfQoKICBhc3luYyBtYXliZVNpZ25lZCgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKHRoaXMuaW50ZXJydXB0ZWQpIHJldHVybgoKICAgIGNvbnN0IHRocmVzID0gdGhpcy5jaGVja3BvaW50cy5sZW5ndGggLSB0aGlzLnF1b3J1bQogICAgaWYgKHRocmVzIDwgMCB8fCB0aGlzLmNoZWNrcG9pbnRzLmxlbmd0aCA8PSB0aHJlcykgcmV0dXJuCgogICAgdGhpcy5jaGVja3BvaW50cy5zb3J0KGNtcENoZWNrcG9pbnRzKQoKICAgIGNvbnN0IHNpZ25hYmxlTGVuZ3RoID0gdGhpcy5jaGVja3BvaW50c1t0aHJlc10uc2lnbmVkTGVuZ3RoKCkKICAgIGlmIChzaWduYWJsZUxlbmd0aCA8PSB0aGlzLnN5c3RlbS5jb3JlLnNpZ25lZExlbmd0aCkgcmV0dXJuCgogICAgY29uc3QgZXhwZWN0ZWQgPSB0aGlzLnN5c3RlbS5jb3JlLmtleQoKICAgIGlmIChzaWduYWJsZUxlbmd0aCA+IHRoaXMuaW5kZXhlZExlbmd0aCkgewogICAgICBpZiAoIWI0YS5lcXVhbHMoZXhwZWN0ZWQsIHRoaXMuY2hlY2twb2ludHNbdGhyZXNdLmRpZ2VzdC5rZXkpKSB0aGlzLl9jaGVja1N5c3RlbVVwZ3JhZGUoKQogICAgICB0aGlzLm5lZWRzSW5kZXhlZExlbmd0aFVwZGF0ZSA9IHRydWUKICAgICAgcmV0dXJuCiAgICB9CgogICAgZm9yIChsZXQgaSA9IHRocmVzOyBpIDwgdGhpcy5jaGVja3BvaW50cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjaGsgPSB0aGlzLmNoZWNrcG9pbnRzW2ldCiAgICAgIC8vIHdlIG11c3QgYWdyZWUgb24gd2hhdCB0aGUgc3lzdGVtIGlzIG9idnMKICAgICAgaWYgKCFiNGEuZXF1YWxzKGV4cGVjdGVkLCBjaGsuZGlnZXN0LmtleSkpIHsKICAgICAgICB0aGlzLl9jaGVja1N5c3RlbVVwZ3JhZGUoKQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIC8vIGlmIHdlIGRvbnQgaGF2ZSB0aGUgaW5kZXhlZCBzdGF0ZSBvdXJzZWxmLCB0aGVuIG5vIHdheSBmb3IgdXMgdG8gdmVyaWZ5IC8gcGF0Y2gKICAgICAgaWYgKCFjaGsuc2lnbmF0dXJlcy5zeXN0ZW0gfHwgY2hrLnNpZ25hdHVyZXMuc3lzdGVtLmxlbmd0aCA+IHRoaXMuaW5kZXhlZExlbmd0aCkgewogICAgICAgIHRoaXMubmVlZHNJbmRleGVkTGVuZ3RoVXBkYXRlID0gdHJ1ZQogICAgICAgIHJldHVybgogICAgICB9CiAgICB9CgogICAgdGhpcy5uZWVkc0luZGV4ZWRMZW5ndGhVcGRhdGUgPSBmYWxzZQoKICAgIGNvbnN0IGNoayA9IFtdCiAgICBmb3IgKGxldCBpID0gdGhyZXM7IGkgPCB0aGlzLmNoZWNrcG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNoay5wdXNoKHsgc2lnbmVyOiB0aGlzLmNoZWNrcG9pbnRzW2ldLnNpZ25lciwgc2lnbmF0dXJlczogdGhpcy5jaGVja3BvaW50c1tpXS5zaWduYXR1cmVzIH0pCiAgICB9CgogICAgY29uc3QgeyBzeXN0ZW0gfSA9IHRoaXMuY2hlY2twb2ludHNbdGhyZXNdLnNpZ25hdHVyZXMKCiAgICBhd2FpdCB0aGlzLl9hc3NlbWJsZU11bHRpc2lnKHN5c3RlbS5sZW5ndGgsIGNoaykKICB9CgogIGFzeW5jIF9hc3NlbWJsZU11bHRpc2lnKHNpZ25hYmxlTGVuZ3RoLCBjaGVja3BvaW50cykgewogICAgY29uc3Qgdmlld3MgPSBuZXcgQXJyYXkodGhpcy52aWV3cy5sZW5ndGggKyAyKSAvLyArMiBpcyBzeXN0ZW0gKyBlbmNyeXB0aW9uCgogICAgY29uc3Qgc3lzID0gYXdhaXQgdGhpcy5zeXN0ZW0uZ2V0SW5kZXhlZEluZm8oc2lnbmFibGVMZW5ndGgpCgogICAgaWYgKHRoaXMuaW50ZXJydXB0ZWQpIHJldHVybgoKICAgIGlmICh0aGlzLnBlbmRpbmdWaWV3cyAmJiB0aGlzLnBlbmRpbmdWaWV3c1swXS5sZW5ndGggPj0gc2lnbmFibGVMZW5ndGgpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgdmlld3NbMF0gPSBjcmVhdGVDaGVja3BvaW50U2lnbmF0dXJlKHNpZ25hYmxlTGVuZ3RoLCB0aGlzLnN5c3RlbVZpZXcsIGNoZWNrcG9pbnRzLmxlbmd0aCkKCiAgICBpZiAoc3lzLmVuY3J5cHRpb25MZW5ndGgpIHsKICAgICAgdmlld3NbMV0gPSBjcmVhdGVDaGVja3BvaW50U2lnbmF0dXJlKAogICAgICAgIHN5cy5lbmNyeXB0aW9uTGVuZ3RoLAogICAgICAgIHRoaXMuZW5jcnlwdGlvblZpZXcsCiAgICAgICAgY2hlY2twb2ludHMubGVuZ3RoCiAgICAgICkKICAgIH0KCiAgICBjb25zdCBvZmZzZXQgPSAyIC8vIHN5c3RlbSArIGVuY3J5cHRpb24KCiAgICBmb3IgKGxldCBpID0gb2Zmc2V0OyBpIDwgdmlld3MubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgdmlldyA9IHRoaXMudmlld3NbaSAtIG9mZnNldF0KICAgICAgY29uc3QgY29yZSA9IHZpZXcuY29yZQoKICAgICAgY29uc3QgdiA9IHRoaXMuZ2V0Vmlld0Zyb21TeXN0ZW0odmlldywgc3lzKQogICAgICBjb25zdCBsZW5ndGggPSB2ID8gdi5sZW5ndGggOiAwCgogICAgICBpZiAoIWNvcmUgfHwgbGVuZ3RoIDw9IGNvcmUuc2lnbmVkTGVuZ3RoKSBjb250aW51ZQoKICAgICAgY29uc3Qgdmlld0luZGV4ID0gdmlldy5tYXBwZWRJbmRleCArIG9mZnNldAogICAgICB2aWV3c1t2aWV3SW5kZXhdID0gY3JlYXRlQ2hlY2twb2ludFNpZ25hdHVyZShsZW5ndGgsIHZpZXcsIGNoZWNrcG9pbnRzLmxlbmd0aCkKICAgIH0KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoZWNrcG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGFkZENoZWNrcG9pbnRTaWduYXR1cmVzKHZpZXdzLCBjaGVja3BvaW50cywgaSkKICAgIH0KCiAgICBjb25zdCBwcm9taXNlcyA9IFtdCiAgICBmb3IgKGNvbnN0IHZpZXcgb2Ygdmlld3MpIHsKICAgICAgaWYgKCF2aWV3KSBjb250aW51ZQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2aWV3LnNpZ25hdHVyZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBwcm9taXNlcy5wdXNoKHNldFBhcnRpYWxTaWduYXR1cmUodmlldywgaSkpCiAgICAgIH0KICAgIH0KCiAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcykKCiAgICAvLyBjaGVjayB0aGF0IHRoZSBzdGF0ZSBzdGlsbCBsb29rcyBnb29kLCBjb3VwbGUgcmVwbGljYXRlIGluYmV0d2Vlbi4uLgogICAgZm9yIChjb25zdCB2IG9mIHZpZXdzKSB7CiAgICAgIGlmICghdikgY29udGludWUKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdi5zaWduYXR1cmVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKCF2LnBhcnRpYWxzW2ldKSByZXR1cm4KICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLmludGVycnVwdGVkKSByZXR1cm4KCiAgICBpZiAodGhpcy5wZW5kaW5nVmlld3MgJiYgdGhpcy5wZW5kaW5nVmlld3NbMF0ubGVuZ3RoID49IHNpZ25hYmxlTGVuZ3RoKSB7CiAgICAgIHJldHVybgogICAgfQogICAgLy8gc2tpcHBlZCBzeXN0ZW0gZm9yIHdoYXRldmVyIHJlYXNvbi4uLgogICAgaWYgKCF2aWV3c1swXSkgcmV0dXJuCgogICAgdGhpcy5wZW5kaW5nVmlld3MgPSB2aWV3cwogICAgdGhpcy5kaXJ0eSA9IHRydWUKCiAgICAvLyBUT0RPOiBvbmx5IG5lZWRlZCBpZiBub3QgdXBkYXRpbmcsIHdvbnQgY3Jhc2ggc28ga2VlcGluZyBmb3Igbm93LCBqdXN0IGxlc3MgZWZmaWNpZW50CiAgICB0aGlzLmJhc2UuX3F1ZXVlQnVtcCgpCiAgfQoKICBfY2xvc2UoKSB7CiAgICBpZiAodGhpcy5pbnRlcnJ1cHRlZCkgcmV0dXJuCiAgICByZXR1cm4gdGhpcy5fZnJlZSgpCiAgfQoKICBhc3luYyBfZnJlZSgpIHsKICAgIHRoaXMuaW50ZXJydXB0ZWQgPSB0cnVlCiAgICBpZiAodGhpcy5hcHBseWluZykgdGhpcy5fcG9zdEFwcGx5KCkKICAgIGZvciAoY29uc3QgY2hrIG9mIHRoaXMuY2hlY2twb2ludHMpIGF3YWl0IGNoay5jbG9zZSgpCiAgICBpZiAodGhpcy5sb2NhbENoZWNrcG9pbnQpIGF3YWl0IHRoaXMubG9jYWxDaGVja3BvaW50LmNsb3NlKCkKICAgIGlmICh0aGlzLnZpZXcgJiYgdGhpcy5iYXNlLl9oYXNDbG9zZSkgYXdhaXQgdGhpcy5iYXNlLl9oYW5kbGVycy5jbG9zZSh0aGlzLnZpZXcpCiAgICBpZiAodGhpcy5zeXN0ZW0pIGF3YWl0IHRoaXMuc3lzdGVtLmNsb3NlKCkKCiAgICBjb25zdCBwcm9taXNlcyA9IFtdCiAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy52aWV3cykgewogICAgICBpZiAodi5yZWYpIHByb21pc2VzLnB1c2godi5yZWYucmVsZWFzZSgpKQogICAgfQoKICAgIGlmICh0aGlzLnN5c3RlbVZpZXcpIHByb21pc2VzLnB1c2godGhpcy5zeXN0ZW1WaWV3LnJlZi5yZWxlYXNlKCkpCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uVmlldykgcHJvbWlzZXMucHVzaCh0aGlzLmVuY3J5cHRpb25WaWV3LnJlZi5yZWxlYXNlKCkpCgogICAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpCiAgICBhd2FpdCB0aGlzLnN0b3JlLmNsb3NlKCkKICB9CgogIF9wdXNoVXBkYXRlKHUpIHsKICAgIHUudmVyc2lvbiA9IDEKICAgIHUuc2VxID0gdGhpcy51cGRhdGVzLmxlbmd0aCA9PT0gMCA/IDAgOiB0aGlzLnVwZGF0ZXNbdGhpcy51cGRhdGVzLmxlbmd0aCAtIDFdLnNlcSArIDEKICAgIHUuc3lzdGVtTGVuZ3RoID0gdGhpcy5zeXN0ZW1WaWV3LmNvcmUubGVuZ3RoCiAgICB0aGlzLnVwZGF0ZXMucHVzaCh1KQogICAgdGhpcy5sb2NhbFN0YXRlLmluc2VydFVwZGF0ZSh1KQogIH0KCiAgYXN5bmMgY2F0Y2h1cChsaW5lYXJpemVyKSB7CiAgICBpZiAoIXRoaXMub3BlbmVkKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmICghdGhpcy5zeXN0ZW0uaGVhZHMubGVuZ3RoKSByZXR1cm4gdHJ1ZQoKICAgIGNvbnN0IHdyaXRlcnMgPSBuZXcgTWFwKCkKCiAgICAvLyBsb2FkIGxpbmVhcml6ZXIuLi4KICAgIGNvbnN0IHVwZGF0ZXMgPSBhd2FpdCB0aGlzLmxvY2FsU3RhdGUubGlzdFVwZGF0ZXMoKQogICAgY29uc3Qgc3lzID0gYXdhaXQgdGhpcy5zeXN0ZW0uY2hlY2tvdXQodGhpcy5pbmRleGVkTGVuZ3RoKQoKICAgIGZvciAoY29uc3Qgbm9kZSBvZiB1cGRhdGVzKSB7CiAgICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhub2RlLmtleSwgJ2hleCcpCgogICAgICBsZXQgdyA9IHdyaXRlcnMuZ2V0KGhleCkKCiAgICAgIGlmICh3ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAvLyBUT0RPOiB3ZSBhY3R1YWxseSBoYXZlIGFsbCB0aGUgd3JpdGVyIGluZm8gYWxyZWFkeSBidXQgb3VyIGN1cnJlbnQgbWV0aG9kcyBtYWtlIGl0IGhhcmQgdG8gcmV1c2UgdGhhdAogICAgICAgIHcgPSBhd2FpdCB0aGlzLmJhc2UuX2dldFdyaXRlckJ5S2V5KG5vZGUua2V5LCAtMSwgMCwgdHJ1ZSwgZmFsc2UsIHN5cykKICAgICAgICB3cml0ZXJzLnNldChoZXgsIHcpCiAgICAgIH0KCiAgICAgIGlmICh3Lmxlbmd0aCA+PSBub2RlLmxlbmd0aCkgewogICAgICAgIHRoaXMuYmFzZS5fd2FybihuZXcgRXJyb3IoJ1VwZGF0ZSBleHBlY3RzIHdyaXRlciB0byBiZSBjb25zdW1lZCBoZXJlJykpCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgIH0KCiAgICAgIHdoaWxlICh3Lmxlbmd0aCA8IG5vZGUubGVuZ3RoKSB7CiAgICAgICAgYXdhaXQgdy51cGRhdGUoc3lzKQoKICAgICAgICBjb25zdCBuZXh0ID0gdy5hZHZhbmNlKCkKICAgICAgICBpZiAoIW5leHQpIHsKICAgICAgICAgIHRoaXMuYmFzZS5fd2FybihuZXcgRXJyb3IoJ05vZGUgbXVzdCBleGlzdCBmb3IgY2F0Y2h1cCcpKQogICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQoKICAgICAgICBsaW5lYXJpemVyLmFkZEhlYWQobmV4dCkKICAgICAgfQogICAgfQoKICAgIGF3YWl0IHN5cy5jbG9zZSgpCgogICAgdGhpcy51cGRhdGVzID0gdXBkYXRlcwoKICAgIGlmICh0aGlzLmluZGV4ZXJzVXBkYXRlZCkgewogICAgICB0aGlzLmluZGV4ZXJzVXBkYXRlZCA9IGZhbHNlCiAgICAgIC8vIGlmIHdlIHVwZGF0ZWQgdGhlIGluZGV4ZXJzLCBpbnZhbGlkYXRlIGFsbCB0aGUgaW50ZXJuYWwgc3RhdGUgYW5kIHJlYXBwbHkgaXQKICAgICAgYXdhaXQgdGhpcy50cnVuY2F0ZSh0aGlzLmluZGV4ZWRMZW5ndGgpCiAgICAgIGF3YWl0IHRoaXMuX3JvbGxiYWNrVmlld3MoKQoKICAgICAgaWYgKHRoaXMudHggPT09IG51bGwpIHRoaXMudHggPSB0aGlzLmxvY2FsLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQoKICAgICAgd2hpbGUgKAogICAgICAgIHRoaXMudXBkYXRlcy5sZW5ndGggPiAwICYmCiAgICAgICAgdGhpcy51cGRhdGVzW3RoaXMudXBkYXRlcy5sZW5ndGggLSAxXS5zeXN0ZW1MZW5ndGggPj0gdGhpcy5pbmRleGVkTGVuZ3RoCiAgICAgICkgewogICAgICAgIGNvbnN0IHUgPSB0aGlzLnVwZGF0ZXMucG9wKCkKICAgICAgICB0aGlzLmxvY2FsU3RhdGUuZGVsZXRlVXBkYXRlKHUpCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIG90aGVyd2lzZSB3ZSBrbm93IHRoZSBpbnRlcm5hbCBzdGF0ZSBpcyBjb3JyZWN0LCBzbyB3ZSBjYXJyeSBvbgogICAgICBsaW5lYXJpemVyLnVwZGF0ZSgpCiAgICB9CgogICAgLy8gbXVzdCByZWZyZXNoIHRoZSB3cml0ZXJzIGhlcmUgc28gaXNSZW1vdmVkIGlzIHVwIHRvIGRhdGUKICAgIGF3YWl0IHRoaXMuX3JlZnJlc2hXcml0ZXJzKCkKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBnZXRJbmRleGVkU3lzdGVtKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgY29uc3QgaW5kZXhlZExlbmd0aCA9IHRoaXMucGVuZGluZ0ZvcmsgPyB0aGlzLnBlbmRpbmdGb3JrLmxlbmd0aCA6IHRoaXMuaW5kZXhlZExlbmd0aAoKICAgIGNvbnN0IHN5cyA9IGF3YWl0IHRoaXMuc3lzdGVtLmNoZWNrb3V0KGluZGV4ZWRMZW5ndGgpCiAgICBhd2FpdCBzeXMucmVhZHkoKQogICAgcmV0dXJuIHN5cwogIH0KCiAgZ2V0Vmlld0Zyb21TeXN0ZW0odmlldywgc3lzID0gdGhpcy5zeXN0ZW0pIHsKICAgIGlmICh2aWV3Lm1hcHBlZEluZGV4ID09PSAtMSB8fCB2aWV3Lm1hcHBlZEluZGV4ID49IHN5cy52aWV3cy5sZW5ndGgpIHJldHVybiBudWxsCiAgICByZXR1cm4gc3lzLnZpZXdzW3ZpZXcubWFwcGVkSW5kZXhdCiAgfQoKICBhc3luYyByZWNvdmVyQXQoKSB7CiAgICBpZiAoIXRoaXMuc3lzdGVtUmVmKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICBhd2FpdCB0aGlzLnN5c3RlbVJlZi5jb3JlLnJlYWR5KCkKCiAgICBjb25zdCBsdCA9IHRoaXMuc3lzdGVtUmVmLmNvcmUuY29yZS5zdGF0ZS5sZW5ndGgKCiAgICBmb3IgYXdhaXQgKGNvbnN0IHsgbGVuZ3RoLCBpbmZvIH0gb2YgU3lzdGVtVmlldy5mbHVzaGVzKHRoaXMuc3lzdGVtUmVmLmNvcmUuc2Vzc2lvbigpLCB7CiAgICAgIHJldmVyc2U6IHRydWUsCiAgICAgIGx0CiAgICB9KSkgewogICAgICBsZXQgY29uc2lzdGVudCA9IHRydWUKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5mby52aWV3cy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChpID49IHRoaXMudmlld3MubGVuZ3RoKSBjb250aW51ZQogICAgICAgIGlmICghYjRhLmVxdWFscyhpbmZvLnZpZXdzW2ldLmtleSwgdGhpcy52aWV3c1tpXS5rZXkpKSBjb250aW51ZQoKICAgICAgICBpZiAoaW5mby52aWV3c1tpXS5sZW5ndGggPiB0aGlzLnZpZXdzW2ldLmNvcmUuY29yZS5zdGF0ZS5sZW5ndGgpIHsKICAgICAgICAgIGNvbnNpc3RlbnQgPSBmYWxzZQogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChjb25zaXN0ZW50KSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGxlbmd0aCwKICAgICAgICAgIGZvcmNlOiB0cnVlLAogICAgICAgICAga2V5OiB0aGlzLnN5c3RlbS5jb3JlLmtleSwKICAgICAgICAgIGluZGV4ZXJzOiBpbmZvLmluZGV4ZXJzLAogICAgICAgICAgdmlld3M6IGluZm8udmlld3MKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgYm9vdHN0cmFwKCkgewogICAgcmV0dXJuIHRoaXMuc3lzdGVtLmFkZCh0aGlzLmJhc2Uua2V5LCB7IGlzSW5kZXhlcjogdHJ1ZSwgaXNQZW5kaW5nOiBmYWxzZSB9KQogIH0KCiAgYXN5bmMgdW5kbyhwb3BwZWQpIHsKICAgIGlmICghcG9wcGVkKSByZXR1cm4KCiAgICBsZXQgaW5kZXhlcnNVcGRhdGVkID0gZmFsc2UKICAgIHdoaWxlIChwb3BwZWQgPiAwKSB7CiAgICAgIGNvbnN0IHUgPSB0aGlzLnVwZGF0ZXMucG9wKCkKICAgICAgdGhpcy5sb2NhbFN0YXRlLmRlbGV0ZVVwZGF0ZSh1KQogICAgICBwb3BwZWQgLT0gdS5iYXRjaAogICAgICBpZiAodS5pbmRleGVycykgaW5kZXhlcnNVcGRhdGVkID0gdHJ1ZQogICAgfQoKICAgIGNvbnN0IHUgPSB0aGlzLnVwZGF0ZXMubGVuZ3RoID09PSAwID8gbnVsbCA6IHRoaXMudXBkYXRlc1t0aGlzLnVwZGF0ZXMubGVuZ3RoIC0gMV0KICAgIGNvbnN0IHN5c3RlbUxlbmd0aCA9IHUgPyB1LnN5c3RlbUxlbmd0aCA6IHRoaXMuaW5kZXhlZExlbmd0aAoKICAgIGF3YWl0IHRoaXMudHJ1bmNhdGUoc3lzdGVtTGVuZ3RoKQogICAgaWYgKGluZGV4ZXJzVXBkYXRlZCkgYXdhaXQgdGhpcy5fcm9sbGJhY2tWaWV3cygpCiAgfQoKICBhc3luYyB0cnVuY2F0ZShzeXN0ZW1MZW5ndGgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKHN5c3RlbUxlbmd0aCA9PT0gdGhpcy5zeXN0ZW0uY29yZS5sZW5ndGgpIHJldHVybgoKICAgIGF3YWl0IHRoaXMuc3lzdGVtLmNvcmUudHJ1bmNhdGUoc3lzdGVtTGVuZ3RoKQoKICAgIGNvbnN0IG1pZ3JhdGVkID0gYXdhaXQgdGhpcy5zeXN0ZW0udXBkYXRlKCkKCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uVmlldy5jb3JlLmxlbmd0aCAhPT0gdGhpcy5zeXN0ZW0uZW5jcnlwdGlvbkxlbmd0aCkgewogICAgICBhd2FpdCB0aGlzLmVuY3J5cHRpb25WaWV3LmNvcmUudHJ1bmNhdGUodGhpcy5zeXN0ZW0uZW5jcnlwdGlvbkxlbmd0aCkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHZpZXcgb2YgdGhpcy52aWV3cykgewogICAgICBpZiAoIXZpZXcuY29yZSkgY29udGludWUKCiAgICAgIGNvbnN0IHYgPSB0aGlzLmdldFZpZXdGcm9tU3lzdGVtKHZpZXcpCgogICAgICBpZiAodiAmJiB2aWV3LmNvcmUubGVuZ3RoID09PSB2Lmxlbmd0aCkgY29udGludWUKICAgICAgaWYgKHYgPT09IG51bGwpIHZpZXcubWFwcGVkSW5kZXggPSAtMSAvLyB1bm1hcAoKICAgICAgYXdhaXQgdmlldy5jb3JlLnRydW5jYXRlKHYgPyB2Lmxlbmd0aCA6IDApCiAgICB9CgogICAgaWYgKCFtaWdyYXRlZCkgcmV0dXJuCgogICAgYXdhaXQgdGhpcy5fcmVmcmVzaFdyaXRlcnMoKQogICAgYXdhaXQgdGhpcy5fcm9sbGJhY2tWaWV3cygpCiAgfQoKICBhc3luYyBfcmVmcmVzaFdyaXRlcnMoKSB7CiAgICAvLyBUT0RPOiBhZGQgdGhlIHNlcSBhdCB3aGljaCB3ZSB1cGRhdGVkIHRoZSBzdGF0ZSB0byB0aGUgd3JpdGVyIGluc3RhbmNlLgogICAgLy8gdGhlbiB3ZSBrbm93IGlmIGl0IHdhcyB0cnVuY2F0ZWQgb3V0IHdpdGhvdXQgdGhlIGxvb2t1cCwgbWVhbmluZyBmYXN0ZXIgdHJ1bmNhdGlvbnMKICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLmJhc2UuYWN0aXZlV3JpdGVycykgewogICAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5zeXN0ZW0uZ2V0KHcuY29yZS5rZXkpCiAgICAgIGNvbnN0IGJvb3RzdHJhcHBlciA9IHRoaXMuc3lzdGVtLmNvcmUubGVuZ3RoID09PSAwICYmIGI0YS5lcXVhbHMody5jb3JlLmtleSwgdGhpcy5iYXNlLmtleSkKICAgICAgY29uc3QgaXNSZW1vdmVkID0gZGF0YSA/IGRhdGEuaXNSZW1vdmVkIDogIWJvb3RzdHJhcHBlcgogICAgICB3LmlzUmVtb3ZlZCA9IGlzUmVtb3ZlZAogICAgfQogIH0KCiAgYXN5bmMgX3VwZGF0ZVN5c3RlbSgpIHsKICAgIGlmICghKGF3YWl0IHRoaXMuc3lzdGVtLnVwZGF0ZSgpKSkgcmV0dXJuCiAgICBhd2FpdCB0aGlzLl9yZWZyZXNoV3JpdGVycygpCiAgICBhd2FpdCB0aGlzLl9yb2xsYmFja1ZpZXdzKCkKICB9CgogIGFzeW5jIF9zaWduVmlld0NvcmUoY29yZSwgbGVuZ3RoKSB7CiAgICBjb25zdCBzID0gYXdhaXQgY29yZS5zaWduYWJsZShsZW5ndGgsIDApCiAgICBjb25zdCBzaWduYXR1cmUgPSBjcnlwdG8uc2lnbihzLCB0aGlzLmJhc2UubG9jYWwua2V5UGFpci5zZWNyZXRLZXkpCiAgICByZXR1cm4geyBzaWduYXR1cmUsIGxlbmd0aCB9CiAgfQoKICBhc3luYyBfc2lnbkludGVybmFsVmlld0NvcmVzKHN5cykgewogICAgcmV0dXJuIHsKICAgICAgc3lzdGVtOiBhd2FpdCB0aGlzLl9zaWduVmlld0NvcmUodGhpcy5zeXN0ZW1WaWV3LmNvcmUsIHRoaXMuc3lzdGVtVmlldy5pbmRleGVkTGVuZ3RoKSwKICAgICAgZW5jcnlwdGlvbjogYXdhaXQgdGhpcy5fc2lnblZpZXdDb3JlKHRoaXMuZW5jcnlwdGlvblZpZXcuY29yZSwgc3lzLmVuY3J5cHRpb25MZW5ndGgpCiAgICB9CiAgfQoKICBhc3luYyBfc2lnblVzZXJWaWV3Q29yZXMoc3lzKSB7CiAgICBjb25zdCBwcm9taXNlcyA9IG5ldyBBcnJheShzeXMudmlld3MubGVuZ3RoKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy52aWV3cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB2aWV3ID0gdGhpcy52aWV3c1tpXQoKICAgICAgY29uc3QgdiA9IHRoaXMuZ2V0Vmlld0Zyb21TeXN0ZW0odmlldywgc3lzKQogICAgICBjb25zdCBpbmRleGVkTGVuZ3RoID0gdiA/IHYubGVuZ3RoIDogMAoKICAgICAgaWYgKCFpbmRleGVkTGVuZ3RoKSBjb250aW51ZQoKICAgICAgY29uc3Qgdmlld0luZGV4ID0gdmlldy5tYXBwZWRJbmRleAogICAgICBwcm9taXNlc1t2aWV3SW5kZXhdID0gdGhpcy5fc2lnblZpZXdDb3JlKHZpZXcucmVmLmF0b21pY0JhdGNoLCBpbmRleGVkTGVuZ3RoKQogICAgfQoKICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcykKICB9CgogIGFzeW5jIGZpbmFsaXplKGtleSkgewogICAgdGhpcy5sb2NhbFN0YXRlLnNldEJvb3RSZWNvcmQoewogICAgICB2ZXJzaW9uOiBCT09UX1JFQ09SRF9WRVJTSU9OLAogICAgICBrZXksCiAgICAgIHN5c3RlbUxlbmd0aDogdGhpcy5zeXN0ZW1WaWV3LmluZGV4ZWRMZW5ndGgsCiAgICAgIGluZGV4ZXJzVXBkYXRlZDogdHJ1ZSwKICAgICAgZmFzdEZvcndhcmRpbmc6IGZhbHNlLAogICAgICByZWNvdmVyaWVzOiB0aGlzLmJhc2UucmVjb3ZlcmllcwogICAgfSkKCiAgICBhd2FpdCB0aGlzLmxvY2FsU3RhdGUuZmx1c2goKQoKICAgIGF3YWl0IHRoaXMuc3RvcmUuZmx1c2goKQogICAgYXdhaXQgdGhpcy5jbG9zZSgpCiAgfQoKICBhc3luYyBfZmx1c2gobG9jYWxOb2RlcykgewogICAgaWYgKGxvY2FsTm9kZXMpIGF3YWl0IHRoaXMuX2FwcGVuZExvY2FsTm9kZXMobG9jYWxOb2RlcykKCiAgICB0aGlzLmxvY2FsU3RhdGUuc2V0Qm9vdFJlY29yZCh7CiAgICAgIHZlcnNpb246IEJPT1RfUkVDT1JEX1ZFUlNJT04sCiAgICAgIGtleTogdGhpcy5rZXksCiAgICAgIHN5c3RlbUxlbmd0aDogdGhpcy5zeXN0ZW1WaWV3LmluZGV4ZWRMZW5ndGgsCiAgICAgIGluZGV4ZXJzVXBkYXRlZDogZmFsc2UsCiAgICAgIGZhc3RGb3J3YXJkaW5nOiBmYWxzZSwKICAgICAgcmVjb3ZlcmllczogdGhpcy5iYXNlLnJlY292ZXJpZXMKICAgIH0pCgogICAgYXdhaXQgdGhpcy5sb2NhbFN0YXRlLmZsdXNoKCkKCiAgICBpZiAodGhpcy5sb2NhbENoZWNrcG9pbnQpIHsKICAgICAgLy8gd2UgaGF2ZSB0byBmbHVzaCBoZXJlIHNvIHRoZSBjaGtwb2ludCBjYW4gdXBkYXRlCiAgICAgIC8vIGNvdWxkIHJ1biB0aGUgY2hlY2twb2ludCBvbiB0aGUgYmF0Y2ggYnV0IGFsc28gbm8gYmlnIGRlYWQKICAgICAgLy8gYXMgdGhlICJzaG91bGQgd2Ugc2lnbiIgY2hlY2sgaXMgcmVydW4gb24gYm9vdC4uLgogICAgICBhd2FpdCB0aGlzLnN0b3JlLmZsdXNoKCkKICAgICAgYXdhaXQgdGhpcy5sb2NhbENoZWNrcG9pbnQudXBkYXRlKCkKICAgIH0KCiAgICBpZiAodGhpcy5wZW5kaW5nVmlld3MpIHsKICAgICAgY29uc3Qgdmlld3MgPSB0aGlzLnBlbmRpbmdWaWV3cwogICAgICB0aGlzLnBlbmRpbmdWaWV3cyA9IG51bGwKCiAgICAgIGZvciAobGV0IGkgPSB2aWV3cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGNvbnN0IHYgPSB2aWV3c1tpXQogICAgICAgIGlmICghdiB8fCB2Lmxlbmd0aCA8PSB2LmNvcmUuc2lnbmVkTGVuZ3RoKSBjb250aW51ZQogICAgICAgIGNvbnN0IHNpZ25hdHVyZSA9IHYuY29yZS5jb3JlLnZlcmlmaWVyLmFzc2VtYmxlKHYucGFydGlhbHMpCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF3YWl0IHYucmVmLmNvbW1pdCh0aGlzLnN0b3JlLmF0b20sIHYubGVuZ3RoLCBzaWduYXR1cmUpCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAvLyBUT0RPOiB3ZSBzaG91bGQgcHJldmFsaWRhdGUgYWxsIHNpZ25hdHVyZXMgaW5zdGVhZCBvZiBkdXJpbmcgY29tbWl0IHNvIGl0IGNhbiBiZSBhbGwgb3Igbm90aGluZywganVzdCBzbGlnaGx5CiAgICAgICAgICAvLyBmcmllbmRsaWVyIHV4LiBtaXNzaW5nIGhjIGFwaSBmb3IgdGhhdAogICAgICAgICAgaWYgKCF0aGlzLmJhc2UuY2xvc2luZykgdGhpcy5iYXNlLl93YXJuKGVycikKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgYXdhaXQgdGhpcy5zdG9yZS5mbHVzaCgpCgogICAgdGhpcy5mYXN0Rm9yd2FyZGluZyA9IGZhbHNlCiAgICBpZiAodGhpcy5wZW5kaW5nVmlld3MgPT09IG51bGwpIHRoaXMuZGlydHkgPSBmYWxzZQogIH0KCiAgX2luZGV4VXBkYXRlcyhpbmRleGVkKSB7CiAgICBsZXQgc2hpZnQgPSAwCiAgICB3aGlsZSAoaW5kZXhlZCA+IDApIGluZGV4ZWQgLT0gdGhpcy51cGRhdGVzW3NoaWZ0KytdLmJhdGNoCgogICAgY29uc3QgbGFzdCA9IHRoaXMudXBkYXRlc1tzaGlmdCAtIDFdCgogICAgdGhpcy5zeXN0ZW1WaWV3LmluZGV4ZWRMZW5ndGggPSBsYXN0LnN5c3RlbUxlbmd0aAoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2hpZnQ7IGkrKykgdGhpcy5sb2NhbFN0YXRlLmRlbGV0ZVVwZGF0ZSh0aGlzLnVwZGF0ZXNbaV0pCiAgICB0aGlzLnVwZGF0ZXMuc3BsaWNlKDAsIHNoaWZ0KQoKICAgIGlmICghdGhpcy5uZWVkc0luZGV4ZWRMZW5ndGhVcGRhdGUpIHJldHVybgogICAgdGhpcy5tYXliZVNpZ25lZCgpLmNhdGNoKG5vb3ApCiAgfQoKICBwZW5kaW5nSW5kZXhlZExlbmd0aCgpIHsKICAgIGxldCBpbmRleGVkID0gdGhpcy5hcHBseWluZy5pbmRleGVkLmxlbmd0aAogICAgaWYgKCF0aGlzLmFwcGx5aW5nIHx8ICF0aGlzLnVwZGF0ZXMubGVuZ3RoIHx8ICFpbmRleGVkKSByZXR1cm4gdGhpcy5pbmRleGVkTGVuZ3RoCgogICAgbGV0IHBvcyA9IDAKICAgIHdoaWxlIChpbmRleGVkID4gMCAmJiBwb3MgPCB0aGlzLnVwZGF0ZXMubGVuZ3RoKSB7CiAgICAgIGluZGV4ZWQgLT0gdGhpcy51cGRhdGVzW3BvcysrXS5iYXRjaAogICAgfQoKICAgIGNvbnN0IGxhc3QgPSB0aGlzLnVwZGF0ZXNbcG9zIC0gMV0KICAgIHJldHVybiBsYXN0LnN5c3RlbUxlbmd0aAogIH0KCiAgYXN5bmMgX2Fzc2VydE5vZGUobm9kZSwgYmF0Y2gpIHsKICAgIC8vIGhlbHBmdWwgZGFnIGhlbHBlciwgc28ga2VwdCBoZXJlCgogICAgY29uc3QgdiA9IChhd2FpdCB0aGlzLnN5c3RlbS5nZXQobm9kZS53cml0ZXIuY29yZS5rZXkpKSB8fCB7IGxlbmd0aDogMCwgaXNSZW1vdmVkOiBmYWxzZSB9CiAgICBjb25zdCBleHBlY3RlZCA9IHYubGVuZ3RoICsgYmF0Y2gKICAgIGlmIChub2RlLmxlbmd0aCA9PT0gZXhwZWN0ZWQpIHJldHVybgoKICAgIGNvbnNvbGUudHJhY2UoCiAgICAgICdJTlZBTElEX0lOU0VSVElPTicsCiAgICAgICdsZW5ndGg9JywKICAgICAgbm9kZS5sZW5ndGgsCiAgICAgICdrZXk9JywKICAgICAgbm9kZS53cml0ZXIuY29yZS5rZXksCiAgICAgICdsb2NhbD0nLAogICAgICBub2RlLndyaXRlci5jb3JlLndyaXRhYmxlLAogICAgICAnYmF0Y2g9JywKICAgICAgYmF0Y2gsCiAgICAgICdkYWc9JywKICAgICAgdgogICAgKQoKICAgIHByb2Nlc3MuZXhpdCgxKQogIH0KCiAgX3Bvc3RBcHBseSgpIHsKICAgIHRoaXMuYXBwbHlCYXRjaCA9IHRoaXMuYXBwbHlpbmcgPSBudWxsCiAgICB0aGlzLmJhc2UuX3Bvc3RBcHBseSgpCiAgfQoKICBhc3luYyBfb3B0aW1pc3RpY0FwcGx5KHUsIG5vZGUsIGluZGV4ZWQpIHsKICAgIGNvbnN0IGNoZWNrcG9pbnQgPSB0aGlzLnN5c3RlbS5jaGVja3BvaW50KCkKCiAgICB0aGlzLnN5c3RlbS5hZGRIZWFkKG5vZGUpCgogICAgY29uc3QgYXBwbHlCYXRjaCA9IFtdCiAgICBjb25zdCBrZXkgPSBub2RlLndyaXRlci5jb3JlLmtleQoKICAgIGFwcGx5QmF0Y2gucHVzaCh7CiAgICAgIGluZGV4ZWQsCiAgICAgIG9wdGltaXN0aWM6IHRydWUsCiAgICAgIGZyb206IG5vZGUud3JpdGVyLmNvcmUsCiAgICAgIGxlbmd0aDogbm9kZS5sZW5ndGgsCiAgICAgIHZhbHVlOiBub2RlLnZhbHVlLAogICAgICBoZWFkczogbm9kZS5hY3R1YWxIZWFkcwogICAgfSkKCiAgICBjb25zdCBwcmUgPSBhd2FpdCB0aGlzLnN5c3RlbS5nZXQoa2V5KQogICAgY29uc3QgcHJlTGVuZ3RoID0gcHJlID8gcHJlLmxlbmd0aCA6IDAKCiAgICBsZXQgZmFpbGVkID0gZmFsc2UKCiAgICB0aGlzLmFwcGx5aW5nID0gdQogICAgdGhpcy5hcHBseUJhdGNoID0gYXBwbHlCYXRjaAogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5iYXNlLl9oYW5kbGVycy5hcHBseShhcHBseUJhdGNoLCB0aGlzLnZpZXcsIHRoaXMuaG9zdGNhbGxzKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmICh0aGlzLmJhc2UuY2xvc2luZykgdGhyb3cgZXJyCiAgICAgIGZhaWxlZCA9IHRydWUKICAgIH0KICAgIHRoaXMuX3Bvc3RBcHBseSgpCgogICAgaWYgKCFmYWlsZWQpIHsKICAgICAgY29uc3QgcG9zdCA9IGF3YWl0IHRoaXMuc3lzdGVtLmdldChrZXkpCiAgICAgIC8vIGNoZWNrIGlmIGFja2VkIGJ5IGFkZFdyaXRlci9yZW1vdmVXcml0ZXIvYWNrV3JpdGVyCiAgICAgIGlmICghcG9zdCB8fCBwcmVMZW5ndGggPT09IHBvc3QubGVuZ3RoKSBmYWlsZWQgPSB0cnVlCiAgICB9CgogICAgaWYgKCFmYWlsZWQpIHsKICAgICAgLy8gdGVjaG5pY2FsbHkgd2Ugb25seSBuZWVkIHRvIHRvIHRoaXMgaXMgdGhlIHdyaXRlciB3YXMgcmVtb3ZlZCwgYnV0IGhleSwgdHJpY2t5IGxvZ2ljCiAgICAgIGF3YWl0IHRoaXMuX3JlZnJlc2hXcml0ZXJzKCkKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICAvLyBpdCBmYWlsZWQhIHJvbGxiYWNrLi4uCgogICAgdGhpcy5zeXN0ZW0uYXBwbHlDaGVja3BvaW50KGNoZWNrcG9pbnQpCgogICAgaWYgKHRoaXMuZW5jcnlwdGlvblZpZXcuY29yZS5sZW5ndGggIT09IHRoaXMuc3lzdGVtLmVuY3J5cHRpb25MZW5ndGgpIHsKICAgICAgYXdhaXQgdGhpcy5lbmNyeXB0aW9uVmlldy5jb3JlLnRydW5jYXRlKHRoaXMuc3lzdGVtLmVuY3J5cHRpb25MZW5ndGgpCiAgICB9CgogICAgZm9yIChjb25zdCB2aWV3IG9mIHRoaXMudmlld3MpIHsKICAgICAgY29uc3Qgdmlld0xlbmd0aCA9IHZpZXcuY29yZSA/IHZpZXcuY29yZS5sZW5ndGggOiB2aWV3Lmxlbmd0aAogICAgICBjb25zdCB2aWV3TG9va3VwID0gdGhpcy5nZXRWaWV3RnJvbVN5c3RlbSh2aWV3KQogICAgICBjb25zdCB2aWV3U3lzdGVtTGVuZ3RoID0gdmlld0xvb2t1cCA/IHZpZXdMb29rdXAubGVuZ3RoIDogMAogICAgICBpZiAodmlld1N5c3RlbUxlbmd0aCA9PT0gdmlld0xlbmd0aCkgY29udGludWUKICAgICAgYXdhaXQgdmlldy5jb3JlLnRydW5jYXRlKHZpZXdTeXN0ZW1MZW5ndGgpCiAgICB9CgogICAgYXdhaXQgdGhpcy5fcmVmcmVzaFdyaXRlcnMoKQoKICAgIGF3YWl0IHRoaXMuX3JvbGxiYWNrVmlld3MoKQogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBfc3RhcnRUcmFjZShub2RlKSB7CiAgICB0aGlzLnN5c3RlbVJlZi50cmFjZXIuc3RhcnQoKQogICAgdGhpcy5lbmNyeXB0aW9uVmlldy5yZWYudHJhY2VyLnN0YXJ0KCkKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy52aWV3cy5sZW5ndGg7IGkrKykgdGhpcy52aWV3c1tpXS5yZWYudHJhY2VyLnN0YXJ0KCkKICB9CgogIF9lbmRUcmFjZShub2RlKSB7CiAgICBjb25zdCB0cmFjZSA9IHsKICAgICAgc3lzdGVtOiB0aGlzLnN5c3RlbVJlZi50cmFjZXIuZW5kKCksCiAgICAgIGVuY3J5cHRpb246IHRoaXMuZW5jcnlwdGlvblZpZXcucmVmLnRyYWNlci5lbmQoKSwKICAgICAgdXNlcjogW10KICAgIH0KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudmlld3MubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYmxvY2tzID0gdGhpcy52aWV3c1tpXS5yZWYudHJhY2VyLmVuZCgpCiAgICAgIGlmIChibG9ja3MubGVuZ3RoKSB0cmFjZS51c2VyLnB1c2goeyB2aWV3OiBpLCBibG9ja3MgfSkKICAgIH0KCiAgICBpZiAodHJhY2Uuc3lzdGVtLmxlbmd0aCB8fCB0cmFjZS5lbmNyeXB0aW9uLmxlbmd0aCB8fCB0cmFjZS51c2VyLmxlbmd0aCkgbm9kZS50cmFjZSA9IHRyYWNlCiAgfQoKICBhc3luYyB1cGRhdGUodSwgbG9jYWxOb2RlcykgewogICAgaWYgKHRoaXMuY2hhbmdlcyAhPT0gbnVsbCkgdGhpcy5jaGFuZ2VzLnRyYWNrKHRoaXMpCgogICAgbGV0IGJhdGNoID0gMAogICAgbGV0IGFwcGx5QmF0Y2ggPSBbXQogICAgbGV0IGluZGV4ZXJzVXBkYXRlZCA9IDAKCiAgICBsZXQgaiA9IDAKICAgIGxldCBpID0gMAogICAgbGV0IGZvcmtlZEF0ID0gLTEKCiAgICB3aGlsZSAoaSA8IE1hdGgubWluKHUuaW5kZXhlZC5sZW5ndGgsIHUuc2hhcmVkKSkgewogICAgICBjb25zdCBub2RlID0gdS5pbmRleGVkW2krK10KCiAgICAgIGlmIChub2RlLmJhdGNoID4gMSkgY29udGludWUKICAgICAgdGhpcy5iYXNlLl9zaGlmdFdyaXRlcihub2RlLndyaXRlcikKCiAgICAgIGNvbnN0IHVwZGF0ZSA9IHRoaXMudXBkYXRlc1tqKytdCgogICAgICBpZiAodXBkYXRlLmluZGV4ZXJzKSB7CiAgICAgICAgaW5kZXhlcnNVcGRhdGVkID0gaQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KCiAgICBpZiAodS51bmRvKSBhd2FpdCB0aGlzLnVuZG8odS51bmRvKQoKICAgIGlmICh0aGlzLnN5c3RlbS5ib290c3RyYXBwaW5nKSBhd2FpdCB0aGlzLmJvb3RzdHJhcCgpCgogICAgYXdhaXQgdGhpcy5fdXBkYXRlU3lzdGVtKCkKCiAgICAvLyBPcmdhbml6ZSBieSB2aWV3CiAgICBjb25zdCB3YXJtdXBTeXN0ZW1WaWV3ID0gW10KICAgIGNvbnN0IHdhcm11cEVuY3J5cHRpb25WaWV3ID0gW10KICAgIGNvbnN0IHdhcm11cFVzZXJWaWV3ID0gbmV3IEFycmF5KHRoaXMudmlld3MubGVuZ3RoKQoKICAgIGZvciAobGV0IGsgPSB1LnNoYXJlZDsgayA8IHUubGVuZ3RoOyBrKyspIHsKICAgICAgY29uc3QgaW5kZXhlZCA9IGsgPCB1LmluZGV4ZWQubGVuZ3RoCiAgICAgIGNvbnN0IG5vZGUgPSBpbmRleGVkID8gdS5pbmRleGVkW2tdIDogdS50aXBbayAtIHUuaW5kZXhlZC5sZW5ndGhdCiAgICAgIGlmICghbm9kZS50cmFjZSkgY29udGludWUKCiAgICAgIGlmIChub2RlLnRyYWNlLnN5c3RlbS5sZW5ndGgpIHdhcm11cFN5c3RlbVZpZXcucHVzaCguLi5ub2RlLnRyYWNlLnN5c3RlbSkKICAgICAgaWYgKG5vZGUudHJhY2UuZW5jcnlwdGlvbi5sZW5ndGgpIHdhcm11cEVuY3J5cHRpb25WaWV3LnB1c2goLi4ubm9kZS50cmFjZS5lbmNyeXB0aW9uKQoKICAgICAgZm9yIChjb25zdCB0cmFjZSBvZiBub2RlLnRyYWNlLnVzZXIpIHsKICAgICAgICAvLyBBc3NlcnQgKGFzIHdhcm5pbmcpIHRoYXQgdHJhY2UgdmlldyBzaG91bGQgb25seSBiZSBjdXJyZW50bHkgaW5kZXhlZCB2aWV3cwogICAgICAgIGlmICh0cmFjZS52aWV3ID49IHRoaXMudmlld3MubGVuZ3RoKSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oCiAgICAgICAgICAgICdPcGxvZyBibG9jayB0cmFjZSBjb250YWlucyBPT0IgdmlldyBpbmRleCcsCiAgICAgICAgICAgICd0cmFjZSB2aWV3JywKICAgICAgICAgICAgdHJhY2UudmlldywKICAgICAgICAgICAgJ3ZpZXdzLmxlbmd0aCcsCiAgICAgICAgICAgIHRoaXMudmlld3MubGVuZ3RoCiAgICAgICAgICApCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgd2FybXVwVXNlclZpZXdbdHJhY2Uudmlld10gPSB3YXJtdXBVc2VyVmlld1t0cmFjZS52aWV3XSB8fCBbXQogICAgICAgIHdhcm11cFVzZXJWaWV3W3RyYWNlLnZpZXddLnB1c2goLi4udHJhY2UuYmxvY2tzKQogICAgICB9CiAgICB9CgogICAgLy8gUmVxdWVzdCBwZXIgdmlldwogICAgaWYgKHdhcm11cFN5c3RlbVZpZXcubGVuZ3RoKSB0aGlzLnN5c3RlbVZpZXcuY29yZS5kb3dubG9hZCh7IGJsb2Nrczogd2FybXVwU3lzdGVtVmlldyB9KQogICAgaWYgKHdhcm11cEVuY3J5cHRpb25WaWV3Lmxlbmd0aCkKICAgICAgdGhpcy5lbmNyeXB0aW9uVmlldy5jb3JlLmRvd25sb2FkKHsgYmxvY2tzOiB3YXJtdXBFbmNyeXB0aW9uVmlldyB9KQogICAgZm9yIChsZXQgayA9IDA7IGsgPCB3YXJtdXBVc2VyVmlldy5sZW5ndGg7IGsrKykgewogICAgICBjb25zdCBibG9ja3MgPSB3YXJtdXBVc2VyVmlld1trXQogICAgICBpZiAoIWJsb2NrcykgY29udGludWUKCiAgICAgIGNvbnN0IHZpZXcgPSB0aGlzLnZpZXdzW2tdCiAgICAgIHZpZXcuY29yZS5kb3dubG9hZCh7IGJsb2NrcyB9KQogICAgfQoKICAgIGZvciAoaSA9IHUuc2hhcmVkOyBpIDwgdS5sZW5ndGg7IGkrKykgewogICAgICBpZiAodGhpcy5iYXNlLmJhY2tvZmYgIT09IG51bGwgJiYgdGhpcy5iYXNlLmJhY2tvZmYuYmFja29mZigpKSBhd2FpdCB0aGlzLmJhc2UuYmFja29mZi53YWl0KCkKCiAgICAgIGNvbnN0IGluZGV4ZWQgPSBpIDwgdS5pbmRleGVkLmxlbmd0aAogICAgICBjb25zdCBub2RlID0gaW5kZXhlZCA/IHUuaW5kZXhlZFtpXSA6IHUudGlwW2kgLSB1LmluZGV4ZWQubGVuZ3RoXQoKICAgICAgYmF0Y2grKwoKICAgICAgaWYgKG5vZGUud3JpdGVyLmNvcmUud3JpdGFibGUpIHRoaXMuX3N0YXJ0VHJhY2Uobm9kZSkKCiAgICAgIGNvbnN0IG9wdGltaXN0ID0KICAgICAgICBub2RlLndyaXRlci5pc1JlbW92ZWQgJiYKICAgICAgICBub2RlLm9wdGltaXN0aWMgJiYKICAgICAgICBiYXRjaCA9PT0gMSAmJgogICAgICAgIHRoaXMuYmFzZS5faGFzT3B0aW1pc3RpY0FwcGx5ID09PSB0cnVlICYmCiAgICAgICAgKGF3YWl0IHRoaXMuX29wdGltaXN0aWNBcHBseSh1LCBub2RlLCBpbmRleGVkKSkKCiAgICAgIGlmICghb3B0aW1pc3QpIHsKICAgICAgICBpZiAobm9kZS53cml0ZXIuaXNSZW1vdmVkICYmICFub2RlLndyaXRlci5pc0FjdGl2ZUluZGV4ZXIpIHsKICAgICAgICAgIGlmIChub2RlLmJhdGNoID4gMSkgY29udGludWUKICAgICAgICAgIC8vIGluIGNhc2Ugc29tZW9uZSBpcyBsaW5raW5nIHRoaXMgbm9kZSBhbmQgdGhleSBhcmUgbm90IHJlbW92ZWQKICAgICAgICAgIGNvbnN0IHUgPSB7CiAgICAgICAgICAgIHNlcTogMCwKICAgICAgICAgICAga2V5OiBub2RlLndyaXRlci5jb3JlLmtleSwKICAgICAgICAgICAgbGVuZ3RoOiBub2RlLmxlbmd0aCwKICAgICAgICAgICAgYmF0Y2gsCiAgICAgICAgICAgIHN5c3RlbUxlbmd0aDogMCwKICAgICAgICAgICAgaW5kZXhlcnM6IGZhbHNlCiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9wdXNoVXBkYXRlKHUpCiAgICAgICAgICBiYXRjaCA9IDAKICAgICAgICAgIGFzc2VydChhcHBseUJhdGNoLmxlbmd0aCA9PT0gMCwgJ0FwcGx5IGJhdGNoIHNob3VsZCBub3QgaGF2ZSBiZWVuIG1vZGlmaWVkJykKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQoKICAgICAgICAvLyBpbiBwcm9kIHdlIHByb3AgbmVlZCB0byBkaXNhYmxlIHRoaXMgYXNzZXJ0aW9uIGFzIGl0cyBwcmV0dHkgZXhwZW5zaXZlLAogICAgICAgIC8vIGJ1dCBpdCBjYXRjaGVzIGEgbG90IG9mIGJ1Z3MsIHNvIGhlcmUgZm9yIGRlYnVncwogICAgICAgIC8vIGF3YWl0IHRoaXMuX2Fzc2VydE5vZGUobm9kZSwgYmF0Y2gpCgogICAgICAgIGNvbnN0IGRlcHMgPSBub2RlLmNhdXNhbERlcGVuZGVuY2llcygpCgogICAgICAgIC8vIG9sZGVzdCAtPiBuZXdlc3QKICAgICAgICBmb3IgKGxldCBpID0gZGVwcy5sZW5ndGggLSAxOyBpID49IDE7IGktLSkgewogICAgICAgICAgY29uc3QgZCA9IGRlcHNbaV0KICAgICAgICAgIGlmIChhd2FpdCB0aGlzLnN5c3RlbS5saW5rYWJsZShkLndyaXRlci5jb3JlLmtleSwgZC5sZW5ndGgpKSB7CiAgICAgICAgICAgIHRoaXMuc3lzdGVtLmFkZEhlYWQoZGVwc1tpXSkKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuc3lzdGVtLmFkZEhlYWQoZGVwc1swXSkKCiAgICAgICAgaWYgKG5vZGUudmFsdWUgIT09IG51bGwgJiYgIW5vZGUud3JpdGVyLmlzUmVtb3ZlZCkgewogICAgICAgICAgYXBwbHlCYXRjaC5wdXNoKHsKICAgICAgICAgICAgaW5kZXhlZCwKICAgICAgICAgICAgb3B0aW1pc3RpYzogZmFsc2UsCiAgICAgICAgICAgIGZyb206IG5vZGUud3JpdGVyLmNvcmUsCiAgICAgICAgICAgIGxlbmd0aDogbm9kZS5sZW5ndGgsCiAgICAgICAgICAgIHZhbHVlOiBub2RlLnZhbHVlLAogICAgICAgICAgICBoZWFkczogbm9kZS5hY3R1YWxIZWFkcwogICAgICAgICAgfSkKICAgICAgICB9CgogICAgICAgIGlmIChub2RlLmJhdGNoID4gMSkgY29udGludWUKCiAgICAgICAgaWYgKGFwcGx5QmF0Y2gubGVuZ3RoICYmIHRoaXMuYmFzZS5faGFzQXBwbHkgPT09IHRydWUpIHsKICAgICAgICAgIHRoaXMuYXBwbHlpbmcgPSB1CiAgICAgICAgICB0aGlzLmFwcGx5QmF0Y2ggPSBhcHBseUJhdGNoCiAgICAgICAgICBhd2FpdCB0aGlzLmJhc2UuX2hhbmRsZXJzLmFwcGx5KGFwcGx5QmF0Y2gsIHRoaXMudmlldywgdGhpcy5ob3N0Y2FsbHMpCiAgICAgICAgICBpZiAoZm9ya2VkQXQgPT09IC0xICYmIHRoaXMucGVuZGluZ0ZvcmspIGZvcmtlZEF0ID0gaQogICAgICAgICAgdGhpcy5fcG9zdEFwcGx5KCkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IHVwZGF0ZSA9IHsKICAgICAgICBzZXE6IDAsCiAgICAgICAga2V5OiBub2RlLndyaXRlci5jb3JlLmtleSwKICAgICAgICBsZW5ndGg6IG5vZGUubGVuZ3RoLAogICAgICAgIGJhdGNoLAogICAgICAgIHN5c3RlbUxlbmd0aDogMCwKICAgICAgICBpbmRleGVyczogZmFsc2UKICAgICAgfQoKICAgICAgdXBkYXRlLmluZGV4ZXJzID0gISF0aGlzLnN5c3RlbS5pbmRleGVyVXBkYXRlCgogICAgICBpZiAodGhpcy5zeXN0ZW0uaW5kZXhlclVwZGF0ZSkgYXdhaXQgdGhpcy5fZ2VuZXJhdGVOZXh0Vmlld3MoKQoKICAgICAgYXdhaXQgdGhpcy5zeXN0ZW0uZmx1c2godGhpcy52aWV3cykKICAgICAgYXdhaXQgdGhpcy5zeXN0ZW0udXBkYXRlKCkKCiAgICAgIGlmIChub2RlLndyaXRlci5jb3JlLndyaXRhYmxlKSB0aGlzLl9lbmRUcmFjZShub2RlKQoKICAgICAgYmF0Y2ggPSAwCiAgICAgIGFwcGx5QmF0Y2ggPSBbXQoKICAgICAgdGhpcy5fcHVzaFVwZGF0ZSh1cGRhdGUpCgogICAgICBpZiAoIWluZGV4ZWQgfHwgaW5kZXhlcnNVcGRhdGVkKSBjb250aW51ZQoKICAgICAgdGhpcy5iYXNlLl9zaGlmdFdyaXRlcihub2RlLndyaXRlcikKCiAgICAgIGlmICh1cGRhdGUuaW5kZXhlcnMpIHsKICAgICAgICBpbmRleGVyc1VwZGF0ZWQgPSBpICsgMQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMucGVuZGluZ0ZvcmspIHsKICAgICAgY29uc3QgcGVuZGluZyA9IHRoaXMucGVuZGluZ0ZvcmsKICAgICAgaWYgKHBlbmRpbmcubGVuZ3RoID4gdGhpcy5pbmRleGVkTGVuZ3RoKSB0aGlzLl9pbmRleFVwZGF0ZXModS5pbmRleGVkLmxlbmd0aCkKCiAgICAgIGNvbnN0IGZvcmsgPSBuZXcgRm9yayh0aGlzLmJhc2UsIHRoaXMuc3RvcmUsIHRoaXMsIHBlbmRpbmcpCiAgICAgIGNvbnN0IGZvcmtlZCA9IGF3YWl0IGZvcmsudXBncmFkZSgpCgogICAgICBpZiAoIWZvcmtlZCkgdGhyb3cgbmV3IEVycm9yKCdGb3JrIGZhaWxlZCcpCgogICAgICBhd2FpdCB0aGlzLl9mbHVzaChsb2NhbE5vZGVzKQoKICAgICAgcmV0dXJuIHsKICAgICAgICByZWJvb3Q6IHRydWUsCiAgICAgICAgbWlncmF0ZWQ6IGZhbHNlCiAgICAgIH0KICAgIH0KCiAgICBpZiAodS5pbmRleGVkLmxlbmd0aCkgewogICAgICB0aGlzLl9pbmRleFVwZGF0ZXMoaW5kZXhlcnNVcGRhdGVkIHx8IHUuaW5kZXhlZC5sZW5ndGgpCiAgICB9CgogICAgY29uc3QgbWlncmF0ZWQgPSBpbmRleGVyc1VwZGF0ZWQgIT09IDAKICAgIGlmIChtaWdyYXRlZCkgdGhpcy5rZXkgPSBhd2FpdCB0aGlzLmJhc2UuX3ByZW1pZ3JhdGUoKQoKICAgIGlmICh0aGlzLmNoYW5nZXMgIT09IG51bGwpIHsKICAgICAgdGhpcy5jaGFuZ2VzLmZpbmFsaXNlKCkKICAgICAgYXdhaXQgdGhpcy5iYXNlLl9oYW5kbGVycy51cGRhdGUodGhpcy52aWV3LCB0aGlzLmNoYW5nZXMpCiAgICB9CgogICAgYXdhaXQgdGhpcy5fZmx1c2gobG9jYWxOb2RlcykKCiAgICByZXR1cm4gewogICAgICByZWJvb3Q6IG1pZ3JhdGVkLAogICAgICBtaWdyYXRlZAogICAgfQogIH0KCiAgZmx1c2goKSB7CiAgICByZXR1cm4gdGhpcy5fZmx1c2gobnVsbCkKICB9CgogIGFzeW5jIF9hcHBlbmRMb2NhbE5vZGVzKGxvY2FsTm9kZXMpIHsKICAgIGlmIChsb2NhbE5vZGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIC8vIGp1c3QgaW4gY2FzZQoKICAgIGNvbnN0IGJsb2NrcyA9IG5ldyBBcnJheShsb2NhbE5vZGVzLmxlbmd0aCkKICAgIGNvbnN0IGxvY2FsID0gdGhpcy5sb2NhbAoKICAgIGlmICghbG9jYWwub3BlbmVkKSBhd2FpdCBsb2NhbC5yZWFkeSgpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBibG9ja3MubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgeyB2YWx1ZSwgaGVhZHMsIGJhdGNoLCBvcHRpbWlzdGljLCB0cmFjZSB9ID0gbG9jYWxOb2Rlc1tpXQoKICAgICAgYmxvY2tzW2ldID0gewogICAgICAgIHZlcnNpb246IE9QTE9HX1ZFUlNJT04sCiAgICAgICAgbWF4U3VwcG9ydGVkVmVyc2lvbjogdGhpcy5iYXNlLm1heFN1cHBvcnRlZFZlcnNpb24sCiAgICAgICAgY2hlY2twb2ludDogbnVsbCwKICAgICAgICBkaWdlc3Q6IG51bGwsCiAgICAgICAgb3B0aW1pc3RpYywKICAgICAgICBub2RlOiB7CiAgICAgICAgICBoZWFkcywKICAgICAgICAgIGJhdGNoLAogICAgICAgICAgdmFsdWU6IHZhbHVlID09PSBudWxsID8gbnVsbCA6IGMuZW5jb2RlKHRoaXMuYmFzZS52YWx1ZUVuY29kaW5nLCB2YWx1ZSkKICAgICAgICB9LAogICAgICAgIHRyYWNlCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5sb2NhbEluZGV4ZXIpIHsKICAgICAgY29uc3Qgc2lnbmVkTGVuZ3RoID0gdGhpcy5sb2NhbENoZWNrcG9pbnQuc2lnbmVkTGVuZ3RoKCkKICAgICAgY29uc3QgbG9jYWwgPSB0aGlzLmxvY2FsCgogICAgICBsZXQgc2lnbmVkQXQgPSAwCiAgICAgIGxldCBpbnRlcm5hbFNpZ25hdHVyZXMgPSBudWxsCiAgICAgIGxldCBzaWduYXR1cmVzID0gbnVsbAoKICAgICAgaWYgKHRoaXMuaW5kZXhlZExlbmd0aCA+IHNpZ25lZExlbmd0aCkgewogICAgICAgIGNvbnN0IHN5cyA9IGF3YWl0IHRoaXMuc3lzdGVtLmdldEluZGV4ZWRJbmZvKHRoaXMuaW5kZXhlZExlbmd0aCkKICAgICAgICBpbnRlcm5hbFNpZ25hdHVyZXMgPSBhd2FpdCB0aGlzLl9zaWduSW50ZXJuYWxWaWV3Q29yZXMoc3lzKQogICAgICAgIHNpZ25hdHVyZXMgPSBhd2FpdCB0aGlzLl9zaWduVXNlclZpZXdDb3JlcyhzeXMpCiAgICAgICAgc2lnbmVkQXQgPSBsb2NhbC5sZW5ndGggKyBibG9ja3MubGVuZ3RoCiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gbG9jYWwubGVuZ3RoICsgaSArIDEKICAgICAgICBpZiAobGVuZ3RoID09PSBzaWduZWRBdCkgewogICAgICAgICAgdGhpcy5sb2NhbENoZWNrcG9pbnQudXBkYXRlSW50ZXJuYWxTaWduYXR1cmVzKGxlbmd0aCwgaW50ZXJuYWxTaWduYXR1cmVzKQogICAgICAgICAgdGhpcy5sb2NhbENoZWNrcG9pbnQudXBkYXRlVXNlclNpZ25hdHVyZXMobGVuZ3RoLCBzaWduYXR1cmVzKQogICAgICAgIH0KCiAgICAgICAgY29uc3QgYmxrID0gYmxvY2tzW2ldCgogICAgICAgIGJsay5jaGVja3BvaW50ID0gdGhpcy5sb2NhbENoZWNrcG9pbnQubWFrZUNoZWNrcG9pbnRzKGxlbmd0aCkKICAgICAgICBibGsuZGlnZXN0ID0gdGhpcy5sb2NhbENoZWNrcG9pbnQubWFrZURpZ2VzdChsZW5ndGgsIHRoaXMua2V5KQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoIXRoaXMubG9jYWxDaGVja3BvaW50KSBhd2FpdCB0aGlzLl9zdGFydExvY2FsQ2hlY2twb2ludCgpCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJsb2Nrcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGxlbmd0aCA9IGxvY2FsLmxlbmd0aCArIGkgKyAxCiAgICAgICAgYmxvY2tzW2ldLmRpZ2VzdCA9IHRoaXMubG9jYWxDaGVja3BvaW50Lm1ha2VEaWdlc3QobGVuZ3RoLCB0aGlzLmtleSkKICAgICAgfQogICAgfQoKICAgIGF3YWl0IGxvY2FsLmFwcGVuZChibG9ja3MpCiAgfQoKICBhc3luYyBfcm9sbGJhY2tWaWV3cygpIHsKICAgIC8vIGVuY3J5cHRpb24gdmlldyBrZXkgaXMgbm90IGluIHN5c3RlbSBzbyBubyBuZWVkIHRvIGhhbmRsZSBoZXJlCiAgICBmb3IgKGNvbnN0IHZpZXcgb2YgdGhpcy52aWV3cykgewogICAgICBjb25zdCB2ID0gdGhpcy5nZXRWaWV3RnJvbVN5c3RlbSh2aWV3KQoKICAgICAgaWYgKHYpIHsKICAgICAgICB2aWV3LmtleSA9IHYua2V5CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYXdhaXQgdGhpcy5fcmVzZXRWaWV3KHZpZXcpCiAgICAgIH0KICAgIH0KICB9CgogIGFzeW5jIGNyZWF0ZUFuY2hvcigpIHsKICAgIGNvbnN0IG5vZGUgPSB0aGlzLmFwcGx5QmF0Y2hbdGhpcy5hcHBseUJhdGNoLmxlbmd0aCAtIDFdCiAgICBjb25zdCBrZXkgPSBub2RlLmZyb20ua2V5CiAgICBjb25zdCBsZW5ndGggPSBub2RlLmxlbmd0aAoKICAgIGNvbnN0IGluZm8gPSBhd2FpdCB0aGlzLnN5c3RlbS5nZXQoa2V5LCB7IHVuZmx1c2hlZDogdHJ1ZSB9KQoKICAgIGlmICghaW5mbyB8fCBpbmZvLmxlbmd0aCA8IGxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdBbmNob3Igbm9kZSBpcyBub3QgaW4gc3lzdGVtJykKCiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogNDAsIGJ1ZmZlcjogYjRhLmFsbG9jKDQwKSB9CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBrZXkpCiAgICBjLnVpbnQ2NC5lbmNvZGUoc3RhdGUsIGxlbmd0aCkKCiAgICBjb25zdCBuYW1lc3BhY2UgPSBjcnlwdG8uaGFzaChzdGF0ZS5idWZmZXIpCiAgICBjb25zdCBtYW5pZmVzdERhdGEgPSBjLmVuY29kZShtZXNzYWdlcy5NYW5pZmVzdERhdGEsIHsgdmVyc2lvbjogMCwgbGVnYWN5QmxvY2tzOiAwLCBuYW1lc3BhY2UgfSkKCiAgICBjb25zdCBwYWRkaW5nID0gdGhpcy5lbmNyeXB0aW9uID8gQXV0b2Jhc2VFbmNyeXB0aW9uLlBBRERJTkcgOiAwCiAgICBjb25zdCBibG9jayA9IGVuY29kZVZhbHVlKG51bGwsIHsgaGVhZHM6IFt7IGtleSwgbGVuZ3RoIH1dLCBwYWRkaW5nIH0pCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uKSBhd2FpdCB0aGlzLmVuY3J5cHRpb24uZW5jcnlwdEFuY2hvcihibG9jaywgbmFtZXNwYWNlKQoKICAgIGNvbnN0IHJvb3QgPSB7IGluZGV4OiAwLCBzaXplOiBibG9jay5ieXRlTGVuZ3RoLCBoYXNoOiBjcnlwdG8uZGF0YShibG9jaykgfQogICAgY29uc3QgaGFzaCA9IGNyeXB0by50cmVlKFtyb290XSkKICAgIGNvbnN0IHByb2xvZ3VlID0geyBoYXNoLCBsZW5ndGg6IDEgfQoKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmNyZWF0ZUFuY2hvckNvcmUocHJvbG9ndWUsIG1hbmlmZXN0RGF0YSkKICAgIGF3YWl0IGNvcmUucmVhZHkoKQoKICAgIGlmIChjb3JlLmxlbmd0aCA9PT0gMCkgYXdhaXQgY29yZS5hcHBlbmQoYmxvY2ssIHsgd3JpdGFibGU6IHRydWUsIG1heExlbmd0aDogMSB9KQoKICAgIGF3YWl0IHRoaXMuc3lzdGVtLmFkZChjb3JlLmtleSwgeyBpc0luZGV4ZXI6IGZhbHNlLCBsZW5ndGg6IDAgfSkKICAgIGF3YWl0IHRoaXMuYmFzZS5fYWRkV3JpdGVyKGNvcmUua2V5LCB0aGlzLnN5c3RlbSkKCiAgICBjb25zdCBhbmNob3IgPSB7IGtleTogY29yZS5rZXksIGxlbmd0aDogY29yZS5sZW5ndGggfQoKICAgIGF3YWl0IGNvcmUuY2xvc2UoKQogICAgYXdhaXQgdGhpcy5iYXNlLmhpbnRXYWtldXAoYW5jaG9yKQoKICAgIHJldHVybiBhbmNob3IKICB9CgogIGFzeW5jIF9yZXNldFZpZXcodmlldykgewogICAgY29uc3QgbWFuaWZlc3RzID0gYXdhaXQgdGhpcy5zdG9yZS5nZXRJbmRleGVyTWFuaWZlc3RzKHRoaXMuc3lzdGVtLmluZGV4ZXJzKQoKICAgIGNvbnN0IG1hbmlmZXN0RGF0YSA9IHZpZXcuY29yZSA/IHZpZXcuY29yZS5tYW5pZmVzdC51c2VyRGF0YSA6IG51bGwKICAgIHZpZXcua2V5ID0gYXdhaXQgdGhpcy5zdG9yZS5jcmVhdGVWaWV3KAogICAgICBtYW5pZmVzdHMsCiAgICAgIHZpZXcubmFtZSwKICAgICAgbnVsbCwKICAgICAgdGhpcy5zeXN0ZW0uY29yZS5tYW5pZmVzdC52ZXJzaW9uLAogICAgICB0aGlzLnN5c3RlbS5lbnRyb3B5LAogICAgICBudWxsLAogICAgICBtYW5pZmVzdERhdGEKICAgICkgLy8gd2lsbCBuZXZlciBiZSBzeXN0ZW0gc28gbm8gbGlua2VkCiAgICB2aWV3Lmxlbmd0aCA9IDAKICB9CgogIGFzeW5jIF9nZW5lcmF0ZU5leHRWaWV3cygpIHsKICAgIGNvbnN0IHN5cyA9IHRoaXMuc3lzdGVtCgogICAgLy8gbm90ZSwgdGhpcyBpcyB2ZXJ5IHN0YXRlIGRlcGVuZGVudCBzbyBjYW4gT05MWSBiZSBjYWxsZWQgYXQgdGhlIGV4YWN0IHRpbWUgYW4gaW5kZXhlciB1cGdyYWRlIG9jY3VycwogICAgY29uc3QgbWFuaWZlc3RzID0gYXdhaXQgdGhpcy5zdG9yZS5nZXRJbmRleGVyTWFuaWZlc3RzKHN5cy5pbmRleGVycykKICAgIGNvbnN0IGVudHJvcHkgPSBzeXMudmVyc2lvbiA8IDIgPyBudWxsIDogc3lzLmdldEVudHJvcHkoc3lzLmluZGV4ZXJzLCBzeXMuZmx1c2hMZW5ndGgoKSkKCiAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy52aWV3cykgewogICAgICBjb25zdCBtYW5pZmVzdERhdGEgPSB2LmNvcmUgPyB2LmNvcmUubWFuaWZlc3QudXNlckRhdGEgOiBudWxsCgogICAgICBjb25zdCBwcm9sb2d1ZSA9IGF3YWl0IGdldFByb2xvZ3VlKHYpCiAgICAgIGNvbnN0IGtleSA9IGF3YWl0IHRoaXMuc3RvcmUuY3JlYXRlVmlldygKICAgICAgICBtYW5pZmVzdHMsCiAgICAgICAgdi5uYW1lLAogICAgICAgIHByb2xvZ3VlLAogICAgICAgIHN5cy5jb3JlLm1hbmlmZXN0LnZlcnNpb24sCiAgICAgICAgZW50cm9weSwKICAgICAgICBudWxsLAogICAgICAgIG1hbmlmZXN0RGF0YQogICAgICApCgogICAgICB2LmtleSA9IGtleQogICAgfQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZ2V0UHJvbG9ndWUodmlldykgewogIGNvbnN0IGxlbmd0aCA9IHZpZXcuY29yZSA/IHZpZXcuY29yZS5sZW5ndGggOiB2aWV3Lmxlbmd0aAogIGlmICghbGVuZ3RoKSByZXR1cm4gbnVsbAoKICBjb25zdCBoYXNoID0gYXdhaXQgdmlldy5jb3JlLnRyZWVIYXNoKGxlbmd0aCkKCiAgcmV0dXJuIHsKICAgIGhhc2gsCiAgICBsZW5ndGgKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gY21wQ2hlY2twb2ludHMoYSwgYikgewogIHJldHVybiBhLnNpZ25lZExlbmd0aCgpIC0gYi5zaWduZWRMZW5ndGgoKQp9CgpmdW5jdGlvbiBzYW1lU2lnbmF0dXJlKGEsIGIpIHsKICBpZiAoIWEgfHwgIWIpIHJldHVybiBhID09PSBiCiAgcmV0dXJuIGEubGVuZ3RoID09PSBiLmxlbmd0aAp9CgpmdW5jdGlvbiBzYW1lU2lnbmF0dXJlcyhhLCBiKSB7CiAgaWYgKCFhIHx8ICFiKSByZXR1cm4gYSA9PT0gYgogIGlmIChhLmxlbmd0aCAhPT0gYi5sZW5ndGgpIHJldHVybiBmYWxzZQogIGZvciAobGV0IGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkrKykgewogICAgaWYgKGFbaV0ubGVuZ3RoICE9PSBiW2ldLmxlbmd0aCkgcmV0dXJuIGZhbHNlCiAgfQogIHJldHVybiB0cnVlCn0KCmZ1bmN0aW9uIGNyZWF0ZUNoZWNrcG9pbnRTaWduYXR1cmUobGVuZ3RoLCB2aWV3LCBjaGVja3BvaW50cykgewogIHJldHVybiB7CiAgICBsZW5ndGgsCiAgICBjb3JlOiB2aWV3LmNvcmUsCiAgICByZWY6IHZpZXcucmVmLAogICAgc2lnbmF0dXJlczogbmV3IEFycmF5KGNoZWNrcG9pbnRzKSwKICAgIHBhcnRpYWxzOiBuZXcgQXJyYXkoY2hlY2twb2ludHMpCiAgfQp9CgpmdW5jdGlvbiBhZGRDaGVja3BvaW50U2lnbmF0dXJlcyhwZW5kaW5nLCBjaGVja3BvaW50cywgaW5kZXgpIHsKICBjb25zdCB7IHNpZ25lciwgc2lnbmF0dXJlcyB9ID0gY2hlY2twb2ludHNbaW5kZXhdCgogIHBlbmRpbmdbMF0uc2lnbmF0dXJlc1tpbmRleF0gPSB7CiAgICBzaWduYXR1cmU6IHNpZ25hdHVyZXMuc3lzdGVtLnNpZ25hdHVyZSwKICAgIGxlbmd0aDogc2lnbmF0dXJlcy5zeXN0ZW0ubGVuZ3RoLAogICAgc2lnbmVyCiAgfQoKICBpZiAocGVuZGluZ1sxXSkgewogICAgcGVuZGluZ1sxXS5zaWduYXR1cmVzW2luZGV4XSA9IHsKICAgICAgc2lnbmF0dXJlOiBzaWduYXR1cmVzLmVuY3J5cHRpb24uc2lnbmF0dXJlLAogICAgICBsZW5ndGg6IHNpZ25hdHVyZXMuZW5jcnlwdGlvbi5sZW5ndGgsCiAgICAgIHNpZ25lcgogICAgfQogIH0KCiAgZm9yIChsZXQgaSA9IDI7IGkgPCBwZW5kaW5nLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoIXBlbmRpbmdbaV0pIGNvbnRpbnVlCgogICAgY29uc3QgeyBsZW5ndGgsIHNpZ25hdHVyZSB9ID0gc2lnbmF0dXJlcy51c2VyW2kgLSAyXQoKICAgIHBlbmRpbmdbaV0uc2lnbmF0dXJlc1tpbmRleF0gPSB7CiAgICAgIHNpZ25hdHVyZSwKICAgICAgbGVuZ3RoLAogICAgICBzaWduZXIKICAgIH0KICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHNldFBhcnRpYWxTaWduYXR1cmUodmlldywgaW5kZXgpIHsKICBjb25zdCBzaWcgPSB2aWV3LnNpZ25hdHVyZXNbaW5kZXhdCiAgaWYgKHNpZy5sZW5ndGggPCB2aWV3Lmxlbmd0aCAmJiBzaWcubGVuZ3RoID4gMCkgYXdhaXQgdmlldy5jb3JlLmdldChzaWcubGVuZ3RoIC0gMSkKCiAgdmlldy5wYXJ0aWFsc1tpbmRleF0gPSBhd2FpdCBwYXJ0aWFsU2lnbmF0dXJlKAogICAgdmlldy5jb3JlLAogICAgc2lnLnNpZ25lciwKICAgIHZpZXcubGVuZ3RoLAogICAgc2lnLmxlbmd0aCwKICAgIHNpZy5zaWduYXR1cmUKICApCn0KCmZ1bmN0aW9uIHVwZGF0ZVNpZ25hdHVyZShsZW5ndGgsIHNpZywgZXhpc3RpbmcpIHsKICByZXR1cm4gc2lnID8geyBzaWduYXR1cmU6IHNpZy5zaWduYXR1cmUsIGxlbmd0aDogc2lnLmxlbmd0aCwgYXQ6IGxlbmd0aCB9IDogZXhpc3RpbmcKfQoKZnVuY3Rpb24gdXBkYXRlU2lnbmF0dXJlcyhsZW5ndGgsIHNpZ25hdHVyZXMsIGV4aXN0aW5nKSB7CiAgY29uc3QgdXBkYXRlZCA9IG5ldyBBcnJheShzaWduYXR1cmVzLmxlbmd0aCkKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCB1cGRhdGVkLmxlbmd0aDsgaSsrKSB7CiAgICB1cGRhdGVkW2ldID0gdXBkYXRlU2lnbmF0dXJlKGxlbmd0aCwgc2lnbmF0dXJlc1tpXSwgaSA8IGV4aXN0aW5nLmxlbmd0aCA/IGV4aXN0aW5nW2ldIDogbnVsbCkKICB9CgogIHJldHVybiB1cGRhdGVkCn0KCmZ1bmN0aW9uIG1ha2VDaGVja3BvaW50KGxlbmd0aCwgY2hrKSB7CiAgaWYgKCFjaGspIHJldHVybiBudWxsCgogIGNvbnN0IGNoZWNrcG9pbnRlciA9IGxlbmd0aCAtIGNoay5hdAoKICByZXR1cm4gewogICAgY2hlY2twb2ludGVyLAogICAgY2hlY2twb2ludDogY2hlY2twb2ludGVyID09PSAwID8geyBzaWduYXR1cmU6IGNoay5zaWduYXR1cmUsIGxlbmd0aDogY2hrLmxlbmd0aCB9IDogbnVsbAogIH0KfQoKZnVuY3Rpb24gbWFrZUNoZWNrcG9pbnRzKGxlbmd0aCwgc2lnbmF0dXJlcykgewogIGlmICghc2lnbmF0dXJlcy5sZW5ndGgpIHJldHVybiBudWxsCgogIGNvbnN0IGNoZWNrcG9pbnRzID0gbmV3IEFycmF5KHNpZ25hdHVyZXMubGVuZ3RoKQoKICBmb3IgKGxldCBpID0gMDsgaSA8IHNpZ25hdHVyZXMubGVuZ3RoOyBpKyspIHsKICAgIGNoZWNrcG9pbnRzW2ldID0gbWFrZUNoZWNrcG9pbnQobGVuZ3RoLCBzaWduYXR1cmVzW2ldKQogIH0KCiAgcmV0dXJuIGNoZWNrcG9pbnRzCn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBtZXNzYWdlcyA9IHJlcXVpcmUoJy4vbWVzc2FnZXMuanMnKQoKbW9kdWxlLmV4cG9ydHMgPSBhc3luYyBmdW5jdGlvbiBib290KAogIGNvcmVzdG9yZSwKICBrZXksCiAgeyBlbmNyeXB0LCBlbmNyeXB0aW9uS2V5LCBrZXlQYWlyLCBleGNsdXNpdmUgPSB0cnVlIH0gPSB7fQopIHsKICBjb25zdCByZXN1bHQgPSB7CiAgICBrZXk6IG51bGwsCiAgICBsb2NhbDogbnVsbCwKICAgIGJvb3RzdHJhcDogbnVsbCwKICAgIGVuY3J5cHRpb25LZXk6IG51bGwsCiAgICBib290OiBudWxsCiAgfQoKICBjb25zdCBtYW5pZmVzdCA9IGtleVBhaXIKICAgID8geyB2ZXJzaW9uOiBjb3Jlc3RvcmUubWFuaWZlc3RWZXJzaW9uLCBzaWduZXJzOiBbeyBwdWJsaWNLZXk6IGtleVBhaXIucHVibGljS2V5IH1dIH0KICAgIDogbnVsbAoKICBpZiAoa2V5KSB7CiAgICByZXN1bHQua2V5ID0ga2V5CgogICAgY29uc3QgYm9vdHN0cmFwID0gY29yZXN0b3JlLmdldCh7IGtleSwgYWN0aXZlOiBmYWxzZSwgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlIH0pCiAgICBhd2FpdCBib290c3RyYXAucmVhZHkoKQoKICAgIGNvbnN0IGxvY2FsS2V5ID0gYXdhaXQgYm9vdHN0cmFwLmdldFVzZXJEYXRhKCdhdXRvYmFzZS9sb2NhbCcpCgogICAgaWYgKGtleVBhaXIpIHsKICAgICAgcmVzdWx0LmxvY2FsID0gY29yZXN0b3JlLmdldCh7CiAgICAgICAga2V5UGFpciwKICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgIGV4Y2x1c2l2ZSwKICAgICAgICB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UsCiAgICAgICAgbWFuaWZlc3QKICAgICAgfSkKICAgIH0gZWxzZSB7CiAgICAgIGlmIChib290c3RyYXAud3JpdGFibGUgJiYgIWxvY2FsS2V5KSB7CiAgICAgICAgcmVzdWx0LmxvY2FsID0gYm9vdHN0cmFwLnNlc3Npb24oewogICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgIGV4Y2x1c2l2ZSwKICAgICAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZQogICAgICAgIH0pCiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgbG9jYWwgPSBsb2NhbEtleQogICAgICAgICAgPyBjb3Jlc3RvcmUuZ2V0KHsKICAgICAgICAgICAgICBrZXk6IGxvY2FsS2V5LAogICAgICAgICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgICAgICAgZXhjbHVzaXZlLAogICAgICAgICAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZQogICAgICAgICAgICB9KQogICAgICAgICAgOiBjb3Jlc3RvcmUuZ2V0KHsKICAgICAgICAgICAgICBuYW1lOiAnbG9jYWwnLAogICAgICAgICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgICAgICAgZXhjbHVzaXZlLAogICAgICAgICAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZQogICAgICAgICAgICB9KQoKICAgICAgICBhd2FpdCBsb2NhbC5yZWFkeSgpCiAgICAgICAgcmVzdWx0LmxvY2FsID0gbG9jYWwKICAgICAgfQogICAgfQoKICAgIHJlc3VsdC5ib290c3RyYXAgPSBib290c3RyYXAKICB9IGVsc2UgewogICAgcmVzdWx0LmxvY2FsID0ga2V5UGFpcgogICAgICA/IGNvcmVzdG9yZS5nZXQoewogICAgICAgICAga2V5UGFpciwKICAgICAgICAgIG1hbmlmZXN0LAogICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgIGV4Y2x1c2l2ZSwKICAgICAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZQogICAgICAgIH0pCiAgICAgIDogY29yZXN0b3JlLmdldCh7CiAgICAgICAgICBuYW1lOiAnbG9jYWwnLAogICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgIGV4Y2x1c2l2ZSwKICAgICAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZQogICAgICAgIH0pCiAgICBhd2FpdCByZXN1bHQubG9jYWwucmVhZHkoKQoKICAgIGNvbnN0IGtleSA9IGF3YWl0IHJlc3VsdC5sb2NhbC5nZXRVc2VyRGF0YSgncmVmZXJyZXInKQogICAgaWYgKGtleSkgewogICAgICByZXN1bHQua2V5ID0ga2V5CiAgICAgIHJlc3VsdC5ib290c3RyYXAgPSBjb3Jlc3RvcmUuZ2V0KHsga2V5LCBhY3RpdmU6IGZhbHNlLCB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UgfSkKICAgICAgYXdhaXQgcmVzdWx0LmJvb3RzdHJhcC5yZWFkeSgpCiAgICB9IGVsc2UgewogICAgICByZXN1bHQua2V5ID0gcmVzdWx0LmxvY2FsLmtleQogICAgICByZXN1bHQuYm9vdHN0cmFwID0gcmVzdWx0LmxvY2FsLnNlc3Npb24oewogICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlCiAgICAgIH0pCiAgICAgIGF3YWl0IHJlc3VsdC5ib290c3RyYXAuc2V0VXNlckRhdGEoJ2F1dG9iYXNlL2xvY2FsJywgcmVzdWx0LmxvY2FsLmtleSkKICAgIH0KICB9CgogIGlmIChrZXkgfHwga2V5UGFpcikgewogICAgYXdhaXQgcmVzdWx0LmJvb3RzdHJhcC5zZXRVc2VyRGF0YSgncmVmZXJyZXInLCByZXN1bHQua2V5KQogICAgYXdhaXQgcmVzdWx0LmJvb3RzdHJhcC5zZXRVc2VyRGF0YSgnYXV0b2Jhc2UvbG9jYWwnLCByZXN1bHQubG9jYWwua2V5KQogICAgYXdhaXQgcmVzdWx0LmxvY2FsLnNldFVzZXJEYXRhKCdyZWZlcnJlcicsIHJlc3VsdC5rZXkpCiAgfQoKICBjb25zdCBbZW5jcnlwdGlvbktleUJ1ZmZlciwgcG9pbnRlcl0gPSBhd2FpdCBQcm9taXNlLmFsbChbCiAgICByZXN1bHQubG9jYWwuZ2V0VXNlckRhdGEoJ2F1dG9iYXNlL2VuY3J5cHRpb24nKSwKICAgIHJlc3VsdC5sb2NhbC5nZXRVc2VyRGF0YSgnYXV0b2Jhc2UvYm9vdCcpCiAgXSkKCiAgaWYgKHBvaW50ZXIpIHsKICAgIHJlc3VsdC5ib290ID0gYy5kZWNvZGUobWVzc2FnZXMuQm9vdFJlY29yZCwgcG9pbnRlcikKICB9CgogIGlmIChlbmNyeXB0aW9uS2V5QnVmZmVyKSB7CiAgICByZXN1bHQuZW5jcnlwdGlvbktleSA9IGVuY3J5cHRpb25LZXlCdWZmZXIKICB9CgogIGlmICghcmVzdWx0LmVuY3J5cHRpb25LZXkgJiYgKGVuY3J5cHRpb25LZXkgfHwgZW5jcnlwdCkpIHsKICAgIGlmICghZW5jcnlwdGlvbktleSkKICAgICAgZW5jcnlwdGlvbktleSA9IChhd2FpdCBjb3Jlc3RvcmUuY3JlYXRlS2V5UGFpcignYXV0b2Jhc2UvZW5jcnlwdGlvbicpKS5zZWNyZXRLZXkuc3ViYXJyYXkoCiAgICAgICAgMCwKICAgICAgICAzMgogICAgICApCiAgICBhd2FpdCByZXN1bHQuYm9vdHN0cmFwLnNldFVzZXJEYXRhKCdhdXRvYmFzZS9lbmNyeXB0aW9uJywgZW5jcnlwdGlvbktleSkgLy8gbGVnYWN5IHN1cHBvcnQKICAgIGF3YWl0IHJlc3VsdC5sb2NhbC5zZXRVc2VyRGF0YSgnYXV0b2Jhc2UvZW5jcnlwdGlvbicsIGVuY3J5cHRpb25LZXkpCiAgICByZXN1bHQuZW5jcnlwdGlvbktleSA9IGVuY3J5cHRpb25LZXkKICB9CgogIHJldHVybiByZXN1bHQKfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKCmNvbnN0IE9QTE9HX1ZFUlNJT04gPSAyCmNvbnN0IERFRkFVTFRfQVVUT0JBU0VfVkVSU0lPTiA9IDEgLy8gZGVmYXVsdApjb25zdCBNQVhfQVVUT0JBU0VfVkVSU0lPTiA9IDIgLy8gb3B0aW9uYWwgZm9yayBzdXBwb3J0CmNvbnN0IEJPT1RfUkVDT1JEX1ZFUlNJT04gPSAzCgpjb25zdCBbTlNfU0lHTkVSX05BTUVTUEFDRSwgTlNfVklFV19CTE9DS19LRVksIE5TX0hBU0hfS0VZLCBOU19FTkNSWVBUSU9OXSA9IGNyeXB0by5uYW1lc3BhY2UoCiAgJ2F1dG9iYXNlJywKICA0CikKCm1vZHVsZS5leHBvcnRzID0gewogIE9QTE9HX1ZFUlNJT04sCiAgREVGQVVMVF9BVVRPQkFTRV9WRVJTSU9OLAogIE1BWF9BVVRPQkFTRV9WRVJTSU9OLAogIEJPT1RfUkVDT1JEX1ZFUlNJT04sCiAgTlNfU0lHTkVSX05BTUVTUEFDRSwKICBOU19WSUVXX0JMT0NLX0tFWSwKICBOU19IQVNIX0tFWSwKICBOU19FTkNSWVBUSU9OCn0KY29uc3QgQnVmZmVyTWFwID0gcmVxdWlyZSgndGlueS1idWZmZXItbWFwJykKCi8vIFRoaXMgaXMgYmFzaWNhbGx5IGp1c3QgYSBNYXAgYXRtLCBidXQgbGVhdmluZyBpdCBhcyBhbiBhYnN0cmFjdGlvbiBmb3Igbm93Ci8vIGluIGNhc2Ugd2Ugd2FubmEgb3B0aW1pemUgaXQgZm9yIG91ciBleGFjdCB1c2VjYXNlCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENsb2NrIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuc2VlbiA9IG5ldyBCdWZmZXJNYXAoKQogIH0KCiAgZ2V0IHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5zZWVuLnNpemUKICB9CgogIGhhcyhrZXkpIHsKICAgIHJldHVybiB0aGlzLnNlZW4uaGFzKGtleSkKICB9CgogIGluY2x1ZGVzKGtleSwgbGVuZ3RoKSB7CiAgICByZXR1cm4gdGhpcy5zZWVuLmhhcyhrZXkpICYmIHRoaXMuc2Vlbi5nZXQoa2V5KSA+PSBsZW5ndGgKICB9CgogIGdldChrZXkpIHsKICAgIHJldHVybiB0aGlzLnNlZW4uZ2V0KGtleSkgfHwgMAogIH0KCiAgc2V0KGtleSwgbGVuKSB7CiAgICB0aGlzLnNlZW4uc2V0KGtleSwgbGVuKQogICAgcmV0dXJuIGxlbgogIH0KCiAgYWRkKGNsb2NrKSB7CiAgICBmb3IgKGNvbnN0IFtrZXksIGxdIG9mIGNsb2NrKSB7CiAgICAgIGlmICh0aGlzLmdldChrZXkpIDwgbCkgdGhpcy5zZXQoa2V5LCBsKQogICAgfQogIH0KCiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy5zZWVuW1N5bWJvbC5pdGVyYXRvcl0oKQogIH0KfQpjb25zdCBCdWZmZXJNYXAgPSByZXF1aXJlKCd0aW55LWJ1ZmZlci1tYXAnKQoKY29uc3QgQ2xvY2sgPSByZXF1aXJlKCcuL2Nsb2NrLmpzJykKCmNvbnN0IFVOU0VFTiA9IDAKY29uc3QgTkVXRVIgPSAxCmNvbnN0IEFDS0VEID0gMgoKLy8gQ29uc2Vuc3VzIG1hY2hpbmUgZm9yIEF1dG9iYXNlLiBTb3J0IERBRyBub2RlcyB1c2luZwovLyB2ZWN0b3IgY2xvY2tzIHRvIGRldGVybWluZSBhIGdsb2JhbGx5IGNvbnNpc3RlbnQgdmlldwoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBDb25zZW5zdXMgewogIGNvbnN0cnVjdG9yKGluZGV4ZXJzKSB7CiAgICB0aGlzLm1lcmdlcyA9IG5ldyBTZXQoKQogICAgdGhpcy5tYWpvcml0eSA9IChpbmRleGVycy5sZW5ndGggPj4+IDEpICsgMQogICAgdGhpcy5pbmRleGVycyA9IGluZGV4ZXJzCiAgICB0aGlzLnJlbW92ZWQgPSBuZXcgQ2xvY2soKQogICAgdGhpcy51cGRhdGVkID0gZmFsc2UKCiAgICB0aGlzLndyaXRlcnMgPSBuZXcgQnVmZmVyTWFwKCkKICAgIGZvciAoY29uc3QgaWR4IG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgdGhpcy53cml0ZXJzLnNldChpZHguY29yZS5rZXksIGlkeCkKICAgIH0KICB9CgogIGFkZEhlYWQobm9kZSkgewogICAgaWYgKCFub2RlLndyaXRlci5pc0FjdGl2ZUluZGV4ZXIpIHJldHVybgogICAgaWYgKHRoaXMuX2lzTWVyZ2Uobm9kZSkpIHRoaXMubWVyZ2VzLmFkZChub2RlKQogICAgdGhpcy51cGRhdGVkID0gdHJ1ZQogICAgcmV0dXJuIG5vZGUKICB9CgogIC8qIEluZGV4ZXIgT25seSBEQUcgbWV0aG9kcyAqLwoKICBfdGFpbHMobm9kZSwgdGFpbHMpIHsKICAgIGNvbnN0IHRhaWxTZXQgPSBuZXcgU2V0KCkKICAgIGZvciAoY29uc3QgdCBvZiB0YWlscykgewogICAgICBpZiAobm9kZS5jbG9jay5pbmNsdWRlcyh0LndyaXRlci5jb3JlLmtleSwgdC5sZW5ndGgpKSB0YWlsU2V0LmFkZCh0KQogICAgfQoKICAgIHJldHVybiB0YWlsU2V0CiAgfQoKICBfdGFpbHNBbmRNZXJnZXMobm9kZSwgdGFpbHMpIHsKICAgIGNvbnN0IGFsbCA9IHRoaXMuX3RhaWxzKG5vZGUsIHRhaWxzKQogICAgZm9yIChjb25zdCBtIG9mIHRoaXMubWVyZ2VzKSB7CiAgICAgIGlmIChtICE9PSBub2RlICYmIG5vZGUuY2xvY2suaW5jbHVkZXMobS53cml0ZXIuY29yZS5rZXksIG0ubGVuZ3RoKSkgewogICAgICAgIGFsbC5hZGQobSkKICAgICAgfQogICAgfQogICAgcmV0dXJuIGFsbAogIH0KCiAgX2lzTWVyZ2Uobm9kZSkgewogICAgaWYgKCFub2RlLndyaXRlci5pc0FjdGl2ZUluZGV4ZXIpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGRlcHMgPSBbXQoKICAgIGZvciAoY29uc3QgaWR4IG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgbGV0IHNlcSA9IG5vZGUuY2xvY2suZ2V0KGlkeC5jb3JlLmtleSkgLSAxCgogICAgICBpZiAoaWR4ID09PSBub2RlLndyaXRlcikgc2VxLS0KCiAgICAgIGNvbnN0IGhlYWQgPSBpZHguZ2V0KHNlcSkKICAgICAgaWYgKCFoZWFkIHx8IHRoaXMucmVtb3ZlZC5pbmNsdWRlcyhoZWFkLndyaXRlci5jb3JlLmtleSwgaGVhZC5sZW5ndGgpKSBjb250aW51ZQoKICAgICAgbGV0IGlzRGVwID0gdHJ1ZQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRlcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBkID0gZGVwc1tpXQogICAgICAgIGlmIChkID09PSBoZWFkKSBjb250aW51ZQoKICAgICAgICBpZiAoZC5jbG9jay5pbmNsdWRlcyhoZWFkLndyaXRlci5jb3JlLmtleSwgaGVhZC5sZW5ndGgpKSB7CiAgICAgICAgICBpc0RlcCA9IGZhbHNlCiAgICAgICAgICBicmVhawogICAgICAgIH0KCiAgICAgICAgaWYgKGhlYWQuY2xvY2suaW5jbHVkZXMoZC53cml0ZXIuY29yZS5rZXksIGQubGVuZ3RoKSkgewogICAgICAgICAgY29uc3QgcG9wcGVkID0gZGVwcy5wb3AoKQogICAgICAgICAgaWYgKGQgPT09IHBvcHBlZCkgY29udGludWUKICAgICAgICAgIGRlcHNbaS0tXSA9IHBvcHBlZAogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGlzRGVwKSBkZXBzLnB1c2goaGVhZCkKICAgIH0KCiAgICByZXR1cm4gZGVwcy5sZW5ndGggPiAxCiAgfQoKICBfaW5kZXhlclRhaWxzKCkgewogICAgY29uc3QgdGFpbHMgPSBuZXcgU2V0KCkKICAgIGZvciAoY29uc3QgaWR4IG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgY29uc3QgbGVuZ3RoID0gdGhpcy5yZW1vdmVkLmhhcyhpZHguY29yZS5rZXkpID8gdGhpcy5yZW1vdmVkLmdldChpZHguY29yZS5rZXkpIDogaWR4LmluZGV4ZWQKCiAgICAgIGNvbnN0IGhlYWQgPSBpZHguZ2V0KGxlbmd0aCkKICAgICAgaWYgKCFoZWFkIHx8IHRoaXMucmVtb3ZlZC5pbmNsdWRlcyhoZWFkLndyaXRlci5jb3JlLmtleSwgaGVhZC5sZW5ndGgpKSBjb250aW51ZQoKICAgICAgbGV0IGlzVGFpbCA9IHRydWUKICAgICAgZm9yIChjb25zdCB0IG9mIHRhaWxzKSB7CiAgICAgICAgaWYgKGhlYWQuY2xvY2suaW5jbHVkZXModC53cml0ZXIuY29yZS5rZXksIHQubGVuZ3RoKSkgewogICAgICAgICAgaXNUYWlsID0gZmFsc2UKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQoKICAgICAgICBpZiAodC5jbG9jay5pbmNsdWRlcyhoZWFkLndyaXRlci5jb3JlLmtleSwgaGVhZC5sZW5ndGgpKSB7CiAgICAgICAgICB0YWlscy5kZWxldGUodCkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChpc1RhaWwpIHRhaWxzLmFkZChoZWFkKQogICAgfQoKICAgIHJldHVybiB0YWlscwogIH0KCiAgLy8gcGFyZW50IGlzIG5ld2VyIGlmIGZvciBhbnkgbm9kZSBpbiBwYXJlbnQncyB2aWV3LAogIC8vIGVpdGhlciBub2RlIGNhbiBzZWUgb2JqZWN0IG9yIG9iamVjdCBjYW4gc2VlIG5vZGUKICBfc3RyaWN0bHlOZXdlcihvYmplY3QsIHBhcmVudCkgewogICAgaWYgKCFwYXJlbnQuY2xvY2suaW5jbHVkZXMob2JqZWN0LndyaXRlci5jb3JlLmtleSwgb2JqZWN0Lmxlbmd0aCkpIHJldHVybiBmYWxzZQoKICAgIGZvciAoY29uc3QgW2tleSwgbGF0ZXN0XSBvZiBwYXJlbnQuY2xvY2spIHsKICAgICAgY29uc3Qgb2xkZXN0ID0gdGhpcy5yZW1vdmVkLmdldChrZXkpCiAgICAgIGlmIChsYXRlc3QgPD0gb2xkZXN0KSBjb250aW51ZSAvLyBjaGVjayBxdWlja2x5IGlmIHdlIHJlbW92ZWQgaXQKCiAgICAgIC8vIGdldCB0aGUgTkVYVCBub2RlIGZyb20gdGhlIHdyaXRlciBmcm9tIHRoZSBvYmplY3RzIHBvdiwgYWRqdXN0IGlmIGl0cyByZW1vdmVkCiAgICAgIGxldCBsZW5ndGggPSBvYmplY3QuY2xvY2suZ2V0KGtleSkKICAgICAgaWYgKGxlbmd0aCA8PSBvbGRlc3QpIGxlbmd0aCA9IG9sZGVzdAoKICAgICAgLy8gc2FuaXR5IGNoZWNrLCBsaWtlbHkgbm90IG5lZWRlZCBhcyBzb21lb25lIGhhcyBjaGVja2VkIHRoaXMgYmVmb3JlLCBidXQgaXQncyBmcmVlCiAgICAgIGlmIChsYXRlc3QgPCBsZW5ndGgpIHJldHVybiBmYWxzZQoKICAgICAgLy8gaWYgdGhlIHNhbWUsIHRoZXkgaGF2ZSBib3RoIHNlZW4gaXQsIGNvbnRpbnVlCiAgICAgIGlmIChsYXRlc3QgPT09IGxlbmd0aCkgY29udGludWUKCiAgICAgIGNvbnN0IHdyaXRlciA9IHRoaXMud3JpdGVycy5nZXQoa2V5KQoKICAgICAgLy8gbWlnaHQgbm90IGJlIGluIHRoZSByZW1vdmVkIHNldCBidXQgdGhlIHdyaXRlciBjYW4gdGVsbCB1cyBpZiBpdCB3YXMgaW5kZXhlZC4uLgogICAgICBjb25zdCBuZXh0ID0gd3JpdGVyICYmIHdyaXRlci5nZXQobGVuZ3RoID49IHdyaXRlci5pbmRleGVkID8gbGVuZ3RoIDogd3JpdGVyLmluZGV4ZWQpCgogICAgICAvLyBubyBuZXh0LCBpdHMgYmVlbiBpbmRleGVkLCBib3RoIHNlZW4gaXQKICAgICAgaWYgKCFuZXh0KSBjb250aW51ZQoKICAgICAgLy8gaWYgdGhlIE5FWFQgbm9kZSBoYXMgc2VlbiB0aGUgb2JqZWN0IGl0cyBmaW5lIC0gbmV3ZXIKICAgICAgaWYgKG5leHQuY2xvY2suaW5jbHVkZXMob2JqZWN0LndyaXRlci5jb3JlLmtleSwgb2JqZWN0Lmxlbmd0aCkpIGNvbnRpbnVlCgogICAgICAvLyBvdGhlcndpc2UgdGhlIHBhcmVudCBtdXN0IGFsc28gTk9UIGhhdmUgc2VlbiB0aGUgbmV4dCBub2RlCiAgICAgIGlmIChsYXRlc3QgPCBuZXh0Lmxlbmd0aCkgY29udGludWUKCiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfYWNrcyh0YXJnZXQpIHsKICAgIGNvbnN0IGFja3MgPSB0YXJnZXQud3JpdGVyLmlzQWN0aXZlSW5kZXhlciA/IFt0YXJnZXRdIDogW10gLy8gVE9ETzogY2FuIGJlIGNhY2hlZCBvbiB0aGUgdGFyZ2V0IG5vZGUgaW4gZnV0dXJlIChpZSBpZiB3ZSBhZGQgb25lIHdlIGRvbnQgaGF2ZSB0byBjaGVjayBpdCBhZ2FpbikKCiAgICBmb3IgKGNvbnN0IGlkeCBvZiB0aGlzLmluZGV4ZXJzKSB7CiAgICAgIGlmIChpZHggPT09IHRhcmdldC53cml0ZXIpIGNvbnRpbnVlCgogICAgICBsZXQgbmV4dCA9IHRhcmdldC5jbG9jay5nZXQoaWR4LmNvcmUua2V5KQogICAgICBpZiAobmV4dCA8IGlkeC5ub2Rlcy5vZmZzZXQpIG5leHQgPSBpZHgubm9kZXMub2Zmc2V0CgogICAgICBjb25zdCBuZXh0SW5kZXhOb2RlID0gaWR4LmdldChuZXh0ID49IGlkeC5pbmRleGVkID8gbmV4dCA6IGlkeC5pbmRleGVkKQoKICAgICAgLy8gbm8gbm9kZSAtIG5vIGFjawogICAgICBpZiAoIW5leHRJbmRleE5vZGUpIGNvbnRpbnVlCgogICAgICAvLyBpZiB0aGUgbmV4dCBpbmRleCBub2RlIGRvZXMgbm90IHNlZSB0aGUgdGFyZ2V0LCBubyBhY2sKICAgICAgaWYgKCFuZXh0SW5kZXhOb2RlLmNsb2NrLmluY2x1ZGVzKHRhcmdldC53cml0ZXIuY29yZS5rZXksIHRhcmdldC5sZW5ndGgpKSBjb250aW51ZQoKICAgICAgLy8gaWYgdGhlIG5leHQgaW5kZXggbm9kZSBpcyBub3Qgc3RyaWN0bHkgbmV3ZXIsIHNraXAgdG8gYXZvaWQgYW1iaWcuLi4KICAgICAgaWYgKCF0aGlzLl9zdHJpY3RseU5ld2VyKHRhcmdldCwgbmV4dEluZGV4Tm9kZSkpIGNvbnRpbnVlCgogICAgICBhY2tzLnB1c2gobmV4dEluZGV4Tm9kZSkKICAgIH0KCiAgICByZXR1cm4gYWNrcwogIH0KCiAgYWNrc0Zyb21Ob2RlKHRhcmdldCwgdmlldykgewogICAgY29uc3QgYWNrcyA9IG5ldyBTZXQoKQoKICAgIGlmICghdmlldyB8fCAhdmlldy5jbG9jay5pbmNsdWRlcyh0YXJnZXQud3JpdGVyLmNvcmUua2V5LCB0YXJnZXQubGVuZ3RoKSkgcmV0dXJuIGFja3MKCiAgICBhY2tzLmFkZCh2aWV3LndyaXRlcikKCiAgICBmb3IgKGNvbnN0IGlkeCBvZiB0aGlzLmluZGV4ZXJzKSB7CiAgICAgIGlmIChpZHggPT09IHZpZXcud3JpdGVyKSBjb250aW51ZQoKICAgICAgY29uc3QgbGVuZ3RoID0gdmlldy5jbG9jay5nZXQoaWR4LmNvcmUua2V5KQogICAgICBpZiAoIWxlbmd0aCkgY29udGludWUKCiAgICAgIGlmICh0YXJnZXQuY2xvY2suaW5jbHVkZXMoaWR4LmNvcmUua2V5LCBsZW5ndGgpKSBjb250aW51ZQoKICAgICAgY29uc3QgaGVhZCA9IGlkeC5nZXQobGVuZ3RoIC0gMSkKICAgICAgaWYgKCFoZWFkKSBjb250aW51ZQoKICAgICAgaWYgKGhlYWQuY2xvY2suaW5jbHVkZXModGFyZ2V0LndyaXRlci5jb3JlLmtleSwgdGFyZ2V0Lmxlbmd0aCkpIHsKICAgICAgICBhY2tzLmFkZChpZHgpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYWNrcwogIH0KCiAgX2Fja2VkQXQoYWNrcywgcGFyZW50KSB7CiAgICBsZXQgc2VlbiA9IDAKICAgIGxldCBtaXNzaW5nID0gYWNrcy5sZW5ndGgKCiAgICBmb3IgKGNvbnN0IG5vZGUgb2YgYWNrcykgewogICAgICBtaXNzaW5nLS0KCiAgICAgIGlmICghcGFyZW50LmNsb2NrLmluY2x1ZGVzKG5vZGUud3JpdGVyLmNvcmUua2V5LCBub2RlLmxlbmd0aCkpIHsKICAgICAgICBpZiAoc2VlbiArIG1pc3NpbmcgPCB0aGlzLm1ham9yaXR5KSByZXR1cm4gZmFsc2UKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBpZiAoKytzZWVuID49IHRoaXMubWFqb3JpdHkpIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBjb25maXJtcyhpbmRleGVyLCB0YXJnZXQsIGFja3MsIGxlbmd0aCkgewogICAgaWYgKCFsZW5ndGggfHwgdGhpcy5yZW1vdmVkLmdldChpbmRleGVyLmNvcmUua2V5KSA+PSBsZW5ndGgpIHJldHVybiBVTlNFRU4KICAgIC8vIGRlZiBmZWVscyBsaWtlIHRoZXJlIGlzIGEgc21hcnRlciB3YXkgb2YgZG9pbmcgdGhpcyBwYXJ0CiAgICAvLyBpZSB3ZSBqdXN0IHdhbm5hIGZpbmQgYSBub2RlIGZyb20gdGhlIGluZGV4ZXIgdGhhdCBpcyBzdHJpY3RseSBuZXdlciB0aGFuIHRhcmdldAogICAgLy8gYW5kIHNlZW5zIGEgbWFqIG9mIHRoZSBhY2tzIC0gdGhhdHMgaXQKCiAgICBsZXQganVtcCA9IHRydWUKICAgIGxldCBuZXdlciA9IHRydWUKCiAgICBmb3IgKGxldCBpID0gbGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgaGVhZCA9IGluZGV4ZXIuZ2V0KGkpCiAgICAgIGlmIChoZWFkID09PSBudWxsKSByZXR1cm4gVU5TRUVOCgogICAgICBsZXQgc2VlbiA9IDAKCiAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiBhY2tzKSB7CiAgICAgICAgLy8gaWYgKG5vZGUud3JpdGVyID09PSBpbmRleGVyKSBjb250aW51ZQogICAgICAgIGlmICghaGVhZC5jbG9jay5pbmNsdWRlcyhub2RlLndyaXRlci5jb3JlLmtleSwgbm9kZS5sZW5ndGgpKSBjb250aW51ZQogICAgICAgIGlmICgrK3NlZW4gPj0gdGhpcy5tYWpvcml0eSkgYnJlYWsKICAgICAgfQoKICAgICAgaWYgKCFuZXdlciAmJiBzZWVuIDwgdGhpcy5tYWpvcml0eSkgewogICAgICAgIGJyZWFrCiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5fc3RyaWN0bHlOZXdlcih0YXJnZXQsIGhlYWQpKSB7CiAgICAgICAgLy8gYWxsIHN0cmljdGx5IG5ld2VyIG5vZGVzIGFyZSBjbHVzdGVyZWQgdG9nZXRoZXIgc28gYmlzZWN0IHVudGlsIHdlIGZpbmQgdGhlIGNsdXN0ZXIKICAgICAgICBpZiAoanVtcCkgewogICAgICAgICAganVtcCA9IGZhbHNlCgogICAgICAgICAgbGV0IHQgPSBsZW5ndGggLSAxCiAgICAgICAgICBsZXQgYiA9IDAKCiAgICAgICAgICB3aGlsZSAodCA+IGIpIHsKICAgICAgICAgICAgY29uc3QgbWlkID0gKHQgKyBiKSA+Pj4gMQogICAgICAgICAgICBjb25zdCBub2RlID0gaW5kZXhlci5nZXQobWlkKQoKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIG5vZGUgPT09IG51bGwgfHwKICAgICAgICAgICAgICAhbm9kZS5jbG9jay5pbmNsdWRlcyh0YXJnZXQud3JpdGVyLmNvcmUua2V5LCB0YXJnZXQubGVuZ3RoKSB8fAogICAgICAgICAgICAgIHRoaXMuX3N0cmljdGx5TmV3ZXIodGFyZ2V0LCBub2RlKQogICAgICAgICAgICApIHsKICAgICAgICAgICAgICBiID0gbWlkICsgMQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHQgPSBtaWQgLSAxCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyArIDIgaW4gY2FzZSB3ZSBhcmUgb2ZmIGJ5IG9uZSBhbmQgdGhlIGktLS4gaXRzIGZpbmUsIGp1c3QgYW4gb3B0aW1pc2F0aW9uCiAgICAgICAgICBpZiAoYiArIDEgPCBpKSBpID0gYiArIDIKICAgICAgICB9CgogICAgICAgIG5ld2VyID0gZmFsc2UKICAgICAgICBjb250aW51ZQogICAgICB9IGVsc2UgaWYgKHNlZW4gPCB0aGlzLm1ham9yaXR5KSB7CiAgICAgICAgcmV0dXJuIE5FV0VSCiAgICAgIH0KCiAgICAgIHJldHVybiBBQ0tFRAogICAgfQoKICAgIHJldHVybiBVTlNFRU4KICB9CgogIF9pc0NvbmZpcm1lZCh0YXJnZXQsIHBhcmVudCA9IG51bGwpIHsKICAgIGNvbnN0IGFja3MgPSB0aGlzLl9hY2tzKHRhcmdldCkKICAgIGNvbnN0IGNvbmZzID0gbmV3IFNldCgpCgogICAgaWYgKGFja3MubGVuZ3RoIDwgdGhpcy5tYWpvcml0eSkgcmV0dXJuIGZhbHNlCiAgICBsZXQgYWxsTmV3ZXIgPSB0cnVlCgogICAgZm9yIChjb25zdCBpbmRleGVyIG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgY29uc3QgbGVuZ3RoID0gcGFyZW50CiAgICAgICAgPyBwYXJlbnQud3JpdGVyID09PSBpbmRleGVyCiAgICAgICAgICA/IHBhcmVudC5sZW5ndGggLSAxCiAgICAgICAgICA6IHBhcmVudC5jbG9jay5nZXQoaW5kZXhlci5jb3JlLmtleSkKICAgICAgICA6IGluZGV4ZXIubGVuZ3RoCgogICAgICBjb25zdCByZXN1bHQgPSB0aGlzLmNvbmZpcm1zKGluZGV4ZXIsIHRhcmdldCwgYWNrcywgbGVuZ3RoKQoKICAgICAgaWYgKHJlc3VsdCA9PT0gQUNLRUQpIHsKICAgICAgICBjb25mcy5hZGQoaW5kZXhlcikKICAgICAgICBpZiAoY29uZnMuc2l6ZSA+PSB0aGlzLm1ham9yaXR5KSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHJlc3VsdCA9PT0gVU5TRUVOKSBhbGxOZXdlciA9IGZhbHNlCiAgICB9CgogICAgaWYgKHBhcmVudCkgcmV0dXJuIHRoaXMuX2lzQ29uZmlybWFibGVBdCh0YXJnZXQsIHBhcmVudCwgYWNrcywgY29uZnMpCgogICAgcmV0dXJuIGFsbE5ld2VyCiAgfQoKICBfaXNDb25maXJtYWJsZUF0KHRhcmdldCwgcGFyZW50LCBhY2tzLCBjb25mcykgewogICAgaWYgKCF0aGlzLl9hY2tlZEF0KGFja3MsIHBhcmVudCkpIHJldHVybiBmYWxzZQoKICAgIGxldCBwb3RlbnRpYWwgPSBjb25mcy5zaXplCgogICAgZm9yIChjb25zdCBpbmRleGVyIG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgaWYgKGNvbmZzLmhhcyhpbmRleGVyKSkgY29udGludWUKCiAgICAgIGNvbnN0IGxlbmd0aCA9IHBhcmVudC5jbG9jay5nZXQoaW5kZXhlci5jb3JlLmtleSkKICAgICAgY29uc3QgaXNTZWVuID0gdGFyZ2V0LmNsb2NrLmluY2x1ZGVzKGluZGV4ZXIuY29yZS5rZXksIGxlbmd0aCkKCiAgICAgIC8vIGlmIHRoZSB0YXJnZXQgaGFzIHNlZW4gdGhlIGxhdGVzdCBub2RlLCBpdCBjYW4gZnJlZWx5IGJlIHVzZWQgdG8gY29uZmlybSB0aGUgdGFyZ2V0IGxhdGVyCiAgICAgIC8vIG90aGVyd2lzZSwgY2hlY2sgaWYgYSBuZXdlciBub2RlIGlzIHN0cmljdGx5IG5ld2VyLi4uCiAgICAgIGlmICghaXNTZWVuKSB7CiAgICAgICAgY29uc3QgaGVhZCA9IGluZGV4ZXIuZ2V0KGxlbmd0aCAtIDEpCgogICAgICAgIC8vIHRoZSBuZXh0IGluZGV4ZXIgaGVhZCBIQVMgdG8gYmUgc3RyaWN0bHkgbmV3ZXIgLSBtZWFuaW5nIHRoZSBjdXJyZW50IG9uZSBoYXMgdG8gYmUgYWxzby4KICAgICAgICBpZiAoCiAgICAgICAgICBoZWFkICYmCiAgICAgICAgICAhdGhpcy5yZW1vdmVkLmluY2x1ZGVzKGhlYWQud3JpdGVyLmNvcmUua2V5LCBoZWFkLmxlbmd0aCkgJiYKICAgICAgICAgICF0aGlzLl9zdHJpY3RseU5ld2VyKHRhcmdldCwgaGVhZCkKICAgICAgICApIHsKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoKytwb3RlbnRpYWwgPj0gdGhpcy5tYWpvcml0eSkgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIC8vIHRoaXMgY2FuIGdldCBjYWxsZWQgbXVsdGlwbGUgdGltZXMgZm9yIHNhbWUgbm9kZQogIHJlbW92ZShub2RlKSB7CiAgICB0aGlzLm1lcmdlcy5kZWxldGUobm9kZSkKICAgIHRoaXMucmVtb3ZlZC5zZXQobm9kZS53cml0ZXIuY29yZS5rZXksIG5vZGUubGVuZ3RoKQogICAgcmV0dXJuIG5vZGUKICB9CgogIHNoaWZ0KCkgewogICAgaWYgKCF0aGlzLnVwZGF0ZWQpIHJldHVybiBbXQoKICAgIGNvbnN0IHRhaWxzID0gdGhpcy5faW5kZXhlclRhaWxzKCkKCiAgICBmb3IgKGNvbnN0IHRhaWwgb2YgdGFpbHMpIHsKICAgICAgaWYgKHRoaXMuX2lzQ29uZmlybWVkKHRhaWwpKSB7CiAgICAgICAgcmV0dXJuIFt0aGlzLnJlbW92ZSh0YWlsKV0KICAgICAgfQogICAgfQoKICAgIGZvciAoY29uc3QgbWVyZ2Ugb2YgdGhpcy5tZXJnZXMpIHsKICAgICAgaWYgKHRoaXMuX2lzQ29uZmlybWVkKG1lcmdlKSkgewogICAgICAgIHJldHVybiB0aGlzLl95aWVsZE5leHQobWVyZ2UsIHRhaWxzKQogICAgICB9CiAgICB9CgogICAgdGhpcy51cGRhdGVkID0gZmFsc2UKICAgIHJldHVybiBbXQogIH0KCiAgLy8geWllbGRzIG5leHQgaW5kZXhlciBub2RlCiAgX3lpZWxkTmV4dChub2RlLCB0YWlscykgewogICAgLy8gb25seSBzdG9wIHdoZW4gd2UgZmluZCBhIHRhaWwKICAgIHdoaWxlICghdGFpbHMuaGFzKG5vZGUpKSB7CiAgICAgIGxldCBuZXh0ID0gbnVsbAoKICAgICAgLy8gZm9yIG1lcmdlcyBjaGVjayBpZiBvbmUgZm9yayBpcyBjb25maXJtZWQKICAgICAgZm9yIChjb25zdCB0IG9mIHRoaXMuX3RhaWxzQW5kTWVyZ2VzKG5vZGUsIHRhaWxzKSkgewogICAgICAgIGlmICh0aGlzLl9pc0NvbmZpcm1lZCh0LCBub2RlKSkgewogICAgICAgICAgbmV4dCA9IHQKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAobmV4dCkgewogICAgICAgIG5vZGUgPSBuZXh0CiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgLy8gb3RoZXJ3aXNlIHlpZWxkIGFsbCB0YWlscwogICAgICBjb25zdCB0YWlsU2V0ID0gW10KICAgICAgZm9yIChjb25zdCB0IG9mIHRoaXMuX3RhaWxzKG5vZGUsIHRhaWxzKSkgewogICAgICAgIHRhaWxTZXQucHVzaCh0aGlzLnJlbW92ZSh0KSkKICAgICAgfQoKICAgICAgcmV0dXJuIHRhaWxTZXQKICAgIH0KCiAgICByZXR1cm4gW3RoaXMucmVtb3ZlKG5vZGUpXQogIH0KCiAgc2hvdWxkQWNrKHdyaXRlcikgewogICAgZm9yIChjb25zdCB0IG9mIHRoaXMuX2luZGV4ZXJUYWlscygpKSB7CiAgICAgIGlmICh0LndyaXRlciA9PT0gd3JpdGVyKSBjb250aW51ZQogICAgICBpZiAodGhpcy5fc2hvdWxkQWNrTm9kZSh0LCB3cml0ZXIpKSByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX3Nob3VsZEFja05vZGUodGFyZ2V0LCB3cml0ZXIpIHsKICAgIGNvbnN0IGhlYWQgPSB3cml0ZXIuaGVhZCgpCiAgICBjb25zdCBuZXh0ID0gdGFyZ2V0LmNsb2NrLmdldCh3cml0ZXIuY29yZS5rZXkpCiAgICBjb25zdCBuZXh0SW5kZXhOb2RlID0gd3JpdGVyLmdldChuZXh0ID49IHdyaXRlci5pbmRleGVkID8gbmV4dCA6IHdyaXRlci5pbmRleGVkKQoKICAgIC8vIGlmIHdlIGhhdmUgbm8gbmV4dCBub2RlIGFuZCB3ZSBkaWRuJ3Qgd3JpdGUgdGFyZ2V0IHRoZW4gYWNrCiAgICBpZiAoIW5leHRJbmRleE5vZGUgJiYgd3JpdGVyICE9PSB0YXJnZXQud3JpdGVyKSByZXR1cm4gdHJ1ZQoKICAgIC8vIHNob3J0Y3V0cyBpZiB3ZSBoYXZlIG5leHQgbm9kZQogICAgaWYgKG5leHRJbmRleE5vZGUpIHsKICAgICAgLy8gaWYgdGhlIG5leHQgbm9kZSBkb2VzIG5vdCBzZWUgdGhlIHRhcmdldCwgc2hvdWxkIGFjawogICAgICBpZiAoIW5leHRJbmRleE5vZGUuY2xvY2suaW5jbHVkZXModGFyZ2V0LndyaXRlci5jb3JlLmtleSwgdGFyZ2V0Lmxlbmd0aCkpIHsKICAgICAgICByZXR1cm4gIWhlYWQuY2xvY2suaW5jbHVkZXModGFyZ2V0LndyaXRlci5jb3JlLmtleSwgdGFyZ2V0Lmxlbmd0aCkKICAgICAgfQoKICAgICAgLy8gaWYgdGhlIG5leHQgbm9kZSBpcyBub3Qgc3RyaWN0bHkgbmV3ZXIsIG5vIHBvaW50IGFja2luZwogICAgICBpZiAoIXRoaXMuX3N0cmljdGx5TmV3ZXIodGFyZ2V0LCBuZXh0SW5kZXhOb2RlKSkgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgLy8gbm93IGNoZWNrIGlmIHdlIGNhbiBkb3VibGUgY29uZmlybQogICAgY29uc3QgYWNrcyA9IHRoaXMuX2Fja3ModGFyZ2V0KQoKICAgIC8vIG5lZWQgZW5vdWdoIHRvIGRvdWJsZSBjb25maXJtCiAgICBpZiAoYWNrcy5sZW5ndGggPj0gdGhpcy5tYWpvcml0eSkgewogICAgICByZXR1cm4gdGhpcy5jb25maXJtcyh3cml0ZXIsIHRhcmdldCwgYWNrcywgd3JpdGVyLmxlbmd0aCkgPT09IFVOU0VFTgogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KfQpjb25zdCBIeXBlcmNvcmVFbmNyeXB0aW9uID0gcmVxdWlyZSgnaHlwZXJjb3JlL2xpYi9kZWZhdWx0LWVuY3J5cHRpb24uanMnKQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgcnJwID0gcmVxdWlyZSgncmVzb2x2ZS1yZWplY3QtcHJvbWlzZScpCmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCgpjb25zdCBTeXN0ZW1WaWV3ID0gcmVxdWlyZSgnLi9zeXN0ZW0uanMnKQpjb25zdCB7IEVuY3J5cHRpb25EZXNjcmlwdG9yLCBNYW5pZmVzdERhdGEgfSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMuanMnKQpjb25zdCB7IE5TX1ZJRVdfQkxPQ0tfS0VZLCBOU19IQVNIX0tFWSwgTlNfRU5DUllQVElPTiB9ID0gcmVxdWlyZSgnLi9jYXBzLmpzJykKCmNvbnN0IG5vbmNlID0gYjRhLmFsbG9jKHNvZGl1bS5jcnlwdG9fc3RyZWFtX05PTkNFQllURVMpCmNvbnN0IGhhc2ggPSBub25jZS5zdWJhcnJheSgwLCBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX0JZVEVTX01JTikKCmNsYXNzIEF1dG9iYXNlRW5jcnlwdGlvbiB7CiAgc3RhdGljIFBBRERJTkcgPSA4CgogIGNvbnN0cnVjdG9yKGVuY3J5cHRpb24pIHsKICAgIHRoaXMuZW5jcnlwdGlvbiA9IGVuY3J5cHRpb24KCiAgICB0aGlzLmNvbXBhdCA9IG51bGwKICAgIHRoaXMua2V5cyA9IG51bGwKICAgIHRoaXMua2V5c0J5SWQgPSBuZXcgTWFwKCkKICB9CgogIGdldCBpZCgpIHsKICAgIHJldHVybiB0aGlzLmtleXMgPyB0aGlzLmtleXMuaWQgOiAwCiAgfQoKICBwYWRkaW5nKCkgewogICAgcmV0dXJuIEF1dG9iYXNlRW5jcnlwdGlvbi5QQURESU5HCiAgfQoKICBpc0NvbXBhdCgpIHsKICAgIHJldHVybiBmYWxzZQogIH0KCiAgbG9hZChrZXlzKSB7CiAgICBpZiAodGhpcy5rZXlzID09PSBudWxsKSB0aGlzLmtleXMgPSBrZXlzCiAgfQoKICBhc3luYyB1cGRhdGUoY3R4KSB7CiAgICBpZiAodGhpcy5pZCAhPT0gMCAmJiB0aGlzLmlkID09PSB0aGlzLmVuY3J5cHRpb24uaWQpIHJldHVybgogICAgY29uc3Qga2V5cyA9IGF3YWl0IHRoaXMuZ2V0KHRoaXMuZW5jcnlwdGlvbi5pZCwgY3R4KQogICAgaWYgKGtleXMpIHRoaXMua2V5cyA9IGtleXMKICB9CgogIGFzeW5jIGdldChpZCwgY3R4KSB7CiAgICBpZiAodGhpcy5rZXlzQnlJZC5oYXMoaWQpKSByZXR1cm4gdGhpcy5rZXlzQnlJZC5nZXQoaWQpCgogICAgY29uc3Qga2V5cyA9IGF3YWl0IHRoaXMuZ2V0S2V5cyhpZCwgY3R4KQogICAgdGhpcy5rZXlzQnlJZC5zZXQoaWQsIGtleXMpCgogICAgcmV0dXJuIGtleXMKICB9CgogIGFzeW5jIGdldEtleXMoaWQsIGN0eCkgewogICAgY29uc3QgZW50cm9weSA9IGF3YWl0IHRoaXMuZW5jcnlwdGlvbi5nZXQoaWQpCiAgICBpZiAoIWVudHJvcHkpIHJldHVybiBudWxsCgogICAgY29uc3QgYmxvY2sgPSB0aGlzLmJsb2NrS2V5KGVudHJvcHksIGN0eCkKICAgIGNvbnN0IGhhc2ggPSBjcnlwdG8uaGFzaChbTlNfSEFTSF9LRVksIGJsb2NrXSkKCiAgICByZXR1cm4gewogICAgICBpZCwKICAgICAgYmxvY2ssCiAgICAgIGhhc2gKICAgIH0KICB9CgogIGJsb2NrS2V5KGVudHJvcHksIGN0eCkgewogICAgcmV0dXJuIHRoaXMuZW5jcnlwdGlvbi5ibG9ja0tleShlbnRyb3B5LCBjdHgpCiAgfQoKICBhc3luYyBfZW5zdXJlQ29tcGF0KGN0eCkgewogICAgaWYgKCF0aGlzLmNvbXBhdCkgdGhpcy5jb21wYXQgPSB0aGlzLmNvbXBhdEtleXMoY3R4KQogIH0KCiAgY29tcGF0S2V5cygpIHsKICAgIHRocm93IG5ldyBFcnJvcignQ29tcGF0YWJpbGl0eSBtZXRob2QgaXMgbm90IHNwZWNpZmllZCcpCiAgfQoKICBhc3luYyBlbmNyeXB0KGluZGV4LCBibG9jaywgZm9yaywgY3R4KSB7CiAgICBpZiAodGhpcy5pc0NvbXBhdChjdHgsIGluZGV4KSkgewogICAgICB0aGlzLl9lbnN1cmVDb21wYXQoY3R4KQogICAgICByZXR1cm4gSHlwZXJjb3JlRW5jcnlwdGlvbi5lbmNyeXB0KAogICAgICAgIGluZGV4LAogICAgICAgIGJsb2NrLAogICAgICAgIGZvcmssCiAgICAgICAgdGhpcy5jb21wYXQuYmxvY2ssCiAgICAgICAgdGhpcy5jb21wYXQuYmxpbmRpbmcKICAgICAgKQogICAgfQoKICAgIGF3YWl0IHRoaXMudXBkYXRlKGN0eCkKCiAgICBlbmNyeXB0QmxvY2soaW5kZXgsIGJsb2NrLCB0aGlzLmtleXMuaWQsIHRoaXMua2V5cy5ibG9jaywgdGhpcy5rZXlzLmhhc2gpCiAgfQoKICBhc3luYyBkZWNyeXB0KGluZGV4LCBibG9jaywgY3R4KSB7CiAgICBpZiAodGhpcy5pc0NvbXBhdChjdHgsIGluZGV4KSkgewogICAgICB0aGlzLl9lbnN1cmVDb21wYXQoY3R4KQogICAgICByZXR1cm4gSHlwZXJjb3JlRW5jcnlwdGlvbi5kZWNyeXB0KGluZGV4LCBibG9jaywgdGhpcy5jb21wYXQuYmxvY2spCiAgICB9CgogICAgY29uc3QgcGFkZGluZyA9IGJsb2NrLnN1YmFycmF5KDAsIEF1dG9iYXNlRW5jcnlwdGlvbi5QQURESU5HKQogICAgYmxvY2sgPSBibG9jay5zdWJhcnJheShBdXRvYmFzZUVuY3J5cHRpb24uUEFERElORykKCiAgICBjb25zdCB0eXBlID0gcGFkZGluZ1swXQogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICByZXR1cm4gYmxvY2sgLy8gdW5lbmNyeXB0ZWQKCiAgICAgIGNhc2UgMToKICAgICAgICBicmVhawoKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VucmVjb2duaXNlZCBlbmNyeXB0aW9uIHR5cGUnKQogICAgfQoKICAgIGNvbnN0IGlkID0gYy51aW50MzIuZGVjb2RlKHsgc3RhcnQ6IDQsIGVuZDogOCwgYnVmZmVyOiBwYWRkaW5nIH0pCgogICAgY29uc3Qga2V5cyA9IGF3YWl0IHRoaXMuZ2V0KGlkLCBjdHgpCgogICAgYy51aW50NjQuZW5jb2RlKHsgc3RhcnQ6IDAsIGVuZDogOCwgYnVmZmVyOiBub25jZSB9LCBpbmRleCkKICAgIG5vbmNlLnNldChwYWRkaW5nLCA4LCAxNikKCiAgICAvLyBEZWNyeXB0IHRoZSBibG9jayB1c2luZyB0aGUgZnVsbCBub25jZQogICAgZGVjcnlwdChibG9jaywgbm9uY2UsIGtleXMuYmxvY2spCiAgfQp9CgpjbGFzcyBWaWV3RW5jcnlwdGlvbiBleHRlbmRzIEF1dG9iYXNlRW5jcnlwdGlvbiB7CiAgY29uc3RydWN0b3IoZW5jcnlwdGlvbiwgbmFtZSkgewogICAgc3VwZXIoZW5jcnlwdGlvbikKICAgIHRoaXMubmFtZSA9IG5hbWUKICB9CgogIGlzQ29tcGF0KGN0eCwgaW5kZXgpIHsKICAgIGlmIChjdHgubWFuaWZlc3QudmVyc2lvbiA8PSAxKSByZXR1cm4gdHJ1ZQogICAgaWYgKCFjdHgubWFuaWZlc3QudXNlckRhdGEpIHJldHVybiBmYWxzZQogICAgY29uc3QgeyBsZWdhY3lCbG9ja3MgfSA9IGMuZGVjb2RlKE1hbmlmZXN0RGF0YSwgY3R4Lm1hbmlmZXN0LnVzZXJEYXRhKQogICAgcmV0dXJuIGluZGV4IDwgbGVnYWN5QmxvY2tzCiAgfQoKICBjb21wYXRLZXlzKCkgewogICAgY29uc3QgeyBib290c3RyYXAsIGVuY3J5cHRpb25LZXkgfSA9IHRoaXMuZW5jcnlwdGlvbi5iYXNlCiAgICBjb25zdCBibG9jayA9IGdldENvbXBhdEJsb2NrS2V5KGJvb3RzdHJhcCwgZW5jcnlwdGlvbktleSwgdGhpcy5uYW1lKQogICAgcmV0dXJuIHsKICAgICAgYmxvY2ssCiAgICAgIGJsaW5kaW5nOiBjcnlwdG8uaGFzaChibG9jaykKICAgIH0KICB9CgogIGJsb2NrS2V5KGVudHJvcHkpIHsKICAgIHJldHVybiBnZXRDb21wYXRCbG9ja0tleSh0aGlzLmVuY3J5cHRpb24uYmFzZS5ib290c3RyYXAsIGVudHJvcHksIHRoaXMubmFtZSkKICB9Cn0KCmNsYXNzIFdyaXRlckVuY3J5cHRpb24gZXh0ZW5kcyBBdXRvYmFzZUVuY3J5cHRpb24gewogIGlzQ29tcGF0KGN0eCkgewogICAgcmV0dXJuIGN0eC5tYW5pZmVzdC52ZXJzaW9uIDw9IDEKICB9CgogIGNvbXBhdEtleXMoY3R4KSB7CiAgICByZXR1cm4gSHlwZXJjb3JlRW5jcnlwdGlvbi5kZXJpdmVLZXlzKHRoaXMuZW5jcnlwdGlvbi5iYXNlLmVuY3J5cHRpb25LZXksIGN0eC5rZXkpCiAgfQoKICBibG9ja0tleShlbnRyb3B5LCBjdHgpIHsKICAgIGlmIChjdHgubWFuaWZlc3QudXNlckRhdGEpIHsKICAgICAgY29uc3QgdXNlckRhdGEgPSBjLmRlY29kZShNYW5pZmVzdERhdGEsIGN0eC5tYW5pZmVzdC51c2VyRGF0YSkKICAgICAgaWYgKHVzZXJEYXRhLm5hbWVzcGFjZSAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiB0aGlzLmVuY3J5cHRpb24uYmxvY2tLZXkoZW50cm9weSwgeyBrZXk6IHVzZXJEYXRhLm5hbWVzcGFjZSB9KQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXMuZW5jcnlwdGlvbi5ibG9ja0tleShlbnRyb3B5LCBjdHgpCiAgfQp9CgpjbGFzcyBFbmNyeXB0aW9uVmlldyBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yKGJhc2UsIGNvcmUpIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgICB0aGlzLmNvcmUgPSBjb3JlIHx8IG51bGwKCiAgICB0aGlzLnNlc3Npb25zID0gbmV3IE1hcCgpCgogICAgdGhpcy5faW5pdGlhbGlzaW5nID0gbnVsbAogIH0KCiAgYXN5bmMgX29wZW4oKSB7CiAgICBhd2FpdCB0aGlzLmluaXRpYWxpc2VkKCkKICAgIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCiAgfQoKICBpbml0aWFsaXNlZCgpIHsKICAgIGlmICh0aGlzLmNvcmUgIT09IG51bGwpIHJldHVybiB0aGlzLmNvcmUucmVhZHkoKQogICAgaWYgKHRoaXMuX2luaXRpYWxpc2luZykgcmV0dXJuIHRoaXMuX2luaXRpYWxpc2luZwoKICAgIHRoaXMuX2luaXRpYWxpc2luZyA9IHJycCgpCgogICAgcmV0dXJuIHRoaXMuX2luaXRpYWxpc2luZy5wcm9taXNlCiAgfQoKICBfY2xvc2UoKSB7CiAgICBpZiAodGhpcy5faW5pdGlhbGlzaW5nKSB7CiAgICAgIHRoaXMuX2luaXRpYWxpc2luZy5yZWplY3QobmV3IEVycm9yKCdFbmNyeXB0aW9uIGNsb3NlZCcpKQogICAgICB0aGlzLl9pbml0aWFsaXNpbmcgPSBudWxsCiAgICB9CgogICAgaWYgKHRoaXMuY29yZSkgcmV0dXJuIHRoaXMuY29yZS5jbG9zZSgpCiAgfQoKICBnZXQgYm9vdHN0cmFwcGVkKCkgewogICAgcmV0dXJuICEhKHRoaXMuY29yZSAmJiB0aGlzLmNvcmUubGVuZ3RoID4gMCkKICB9CgogIGdldCBpZCgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUgPyB0aGlzLmNvcmUubGVuZ3RoIDogMAogIH0KCiAgX2NyZWF0ZVBheWxvYWQoa2V5KSB7CiAgICByZXR1cm4ga2V5CiAgfQoKICBhc3luYyByZWxvYWQoY29yZSkgewogICAgaWYgKHRoaXMuY29yZSkgYXdhaXQgdGhpcy5jb3JlLmNsb3NlKCkKCiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQoKICAgIGlmICh0aGlzLl9pbml0aWFsaXNpbmcpIHsKICAgICAgdGhpcy5faW5pdGlhbGlzaW5nLnJlc29sdmUoKQogICAgICB0aGlzLl9pbml0aWFsaXNpbmcgPSBudWxsCiAgICB9CiAgfQoKICB1bnBhY2sodHlwZSwgcGF5bG9hZCkgewogICAgaWYgKHR5cGUgPiAwKSB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb24nKQogICAgcmV0dXJuIHBheWxvYWQKICB9CgogIGFzeW5jIHVwZGF0ZShrZXkpIHsKICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCB0aGlzLl9jcmVhdGVQYXlsb2FkKGtleSkKICAgIGNvbnN0IGRlc2MgPSB7IHR5cGU6IDAsIHBheWxvYWQgfQoKICAgIGF3YWl0IHRoaXMuY29yZS5hcHBlbmQoYy5lbmNvZGUoRW5jcnlwdGlvbkRlc2NyaXB0b3IsIGRlc2MpKQogIH0KCiAgYXN5bmMgX3ByZWxvYWQoKSB7CiAgICBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIHJldHVybiB0aGlzLmlkKCkKICB9CgogIGdldFZpZXdFbmNyeXB0aW9uKG5hbWUpIHsKICAgIGlmICh0aGlzLnNlc3Npb25zLmhhcyhuYW1lKSkgcmV0dXJuIHRoaXMuc2Vzc2lvbnMuZ2V0KG5hbWUpCgogICAgY29uc3QgZW5jcnlwdGlvbiA9IG5ldyBWaWV3RW5jcnlwdGlvbih0aGlzLCBuYW1lKQogICAgdGhpcy5zZXNzaW9ucy5zZXQobmFtZSwgZW5jcnlwdGlvbikKCiAgICByZXR1cm4gZW5jcnlwdGlvbgogIH0KCiAgZ2V0V3JpdGVyRW5jcnlwdGlvbigpIHsKICAgIHJldHVybiBuZXcgV3JpdGVyRW5jcnlwdGlvbih0aGlzKQogIH0KCiAgYXN5bmMgZW5jcnlwdEFuY2hvcihibG9jaywgbmFtZXNwYWNlKSB7CiAgICBjb25zdCBlbnRyb3B5ID0gYXdhaXQgdGhpcy5nZXQodGhpcy5pZCkKICAgIGlmICghZW50cm9weSkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBibG9ja0tleSA9IHRoaXMuYmxvY2tLZXkoZW50cm9weSwgeyBrZXk6IG5hbWVzcGFjZSB9KQogICAgY29uc3QgaGFzaEtleSA9IGNyeXB0by5oYXNoKFtOU19IQVNIX0tFWSwgYmxvY2tdKQoKICAgIGVuY3J5cHRCbG9jaygwLCBibG9jaywgdGhpcy5pZCwgYmxvY2tLZXksIGhhc2hLZXkpCiAgfQoKICBibG9ja0tleShlbnRyb3B5LCBjdHgpIHsKICAgIHJldHVybiBnZXRCbG9ja0tleSh0aGlzLmJhc2UuYm9vdHN0cmFwLCB0aGlzLmJhc2UuZW5jcnlwdGlvbktleSwgZW50cm9weSwgY3R4LmtleSkKICB9CgogIGFzeW5jIGdldChlbmNyeXB0aW9uSWQpIHsKICAgIGlmIChlbmNyeXB0aW9uSWQgPT09IDApIHJldHVybiBTeXN0ZW1WaWV3LkdFTkVTSVNfRU5UUk9QWQoKICAgIGlmICghdGhpcy5jb3JlKSBhd2FpdCB0aGlzLmluaXRpYWxpc2VkKCkKCiAgICBjb25zdCBpbmRleCA9IGVuY3J5cHRpb25JZCAtIDEKICAgIGNvbnN0IGRlc2MgPSBhd2FpdCB0aGlzLmNvcmUuZ2V0KGluZGV4KQogICAgY29uc3QgeyB0eXBlLCBwYXlsb2FkIH0gPSBjLmRlY29kZShFbmNyeXB0aW9uRGVzY3JpcHRvciwgZGVzYykKCiAgICBjb25zdCBrZXkgPSB0aGlzLnVucGFjayh0eXBlLCBwYXlsb2FkKQogICAgcmV0dXJuIGtleQogIH0KCiAgZ2V0U3lzdGVtRW5jcnlwdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmdldFZpZXdFbmNyeXB0aW9uKCdfc3lzdGVtJykKICB9CgogIHN0YXRpYyBuYW1lc3BhY2UoZW50cm9weSkgewogICAgcmV0dXJuIGNyeXB0by5oYXNoKFtOU19FTkNSWVBUSU9OLCBlbnRyb3B5XSkKICB9CgogIHN0YXRpYyBnZXRCbG9ja0tleShib290c3RyYXAsIGVuY3J5cHRpb25LZXksIGVudHJvcHksIGh5cGVyY29yZUtleSkgewogICAgcmV0dXJuIGdldEJsb2NrS2V5KGJvb3RzdHJhcCwgZW5jcnlwdGlvbktleSwgZW50cm9weSwgaHlwZXJjb3JlS2V5KQogIH0KCiAgc3RhdGljIGdldFN5c3RlbUVuY3J5cHRpb24oYmFzZSwgY29yZSkgewogICAgY29uc3QgdmlldyA9IG5ldyBFbmNyeXB0aW9uVmlldyhiYXNlLCBjb3JlKQogICAgcmV0dXJuIHZpZXcuZ2V0U3lzdGVtRW5jcnlwdGlvbigpCiAgfQoKICBzdGF0aWMgYXN5bmMgc2V0U3lzdGVtRW5jcnlwdGlvbihiYXNlLCBjb3JlLCBvcHRzKSB7CiAgICBpZiAoYmFzZS5lbmNyeXB0aW9uS2V5ID09PSBudWxsKSByZXR1cm4gbnVsbAoKICAgIGF3YWl0IGNvcmUucmVhZHkoKQogICAgaWYgKGNvcmUubWFuaWZlc3QudmVyc2lvbiA9PT0gMSkgewogICAgICBjb25zdCBrZXkgPSBnZXRDb21wYXRCbG9ja0tleShiYXNlLmJvb3RzdHJhcCwgYmFzZS5lbmNyeXB0aW9uS2V5LCAnX3N5c3RlbScpCiAgICAgIHJldHVybiBjb3JlLnNldEVuY3J5cHRpb25LZXkoa2V5LCB7IGJsb2NrOiB0cnVlIH0pCiAgICB9CgogICAgaWYgKCFjb3JlLm1hbmlmZXN0LmxpbmtlZC5sZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdTeXN0ZW0gbWFuaWZlc3QgZG9lcyBub3QgbGluayBlbmNyeXB0aW9uIHZpZXcnKQogICAgfQoKICAgIGNvbnN0IGVuYyA9IGJhc2Uuc3RvcmUuZ2V0KHsga2V5OiBjb3JlLm1hbmlmZXN0LmxpbmtlZFswXSwgYWN0aXZlOiBmYWxzZSB9KQogICAgY29uc3QgZW5jcnlwdGlvbiA9IEVuY3J5cHRpb25WaWV3LmdldFN5c3RlbUVuY3J5cHRpb24oYmFzZSwgZW5jKQoKICAgIGF3YWl0IGNvcmUuc2V0RW5jcnlwdGlvbihlbmNyeXB0aW9uLCBvcHRzKQoKICAgIHJldHVybiBlbmMKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gewogIEF1dG9iYXNlRW5jcnlwdGlvbiwKICBFbmNyeXB0aW9uVmlldwp9CgpmdW5jdGlvbiBlbmNyeXB0KGJsb2NrLCBub25jZSwga2V5KSB7CiAgc29kaXVtLmNyeXB0b19zdHJlYW1feG9yKGJsb2NrLCBibG9jaywgbm9uY2UsIGtleSkKfQoKZnVuY3Rpb24gZGVjcnlwdChibG9jaywgbm9uY2UsIGtleSkgewogIHJldHVybiBlbmNyeXB0KGJsb2NrLCBub25jZSwga2V5KSAvLyBzeW1tZXRyaWMKfQoKZnVuY3Rpb24gZ2V0QmxvY2tLZXkoYm9vdHN0cmFwLCBlbmNyeXB0aW9uS2V5LCBlbnRyb3B5LCBoeXBlcmNvcmVLZXkpIHsKICByZXR1cm4gKAogICAgZW5jcnlwdGlvbktleSAmJgogICAgY3J5cHRvLmhhc2goW05TX1ZJRVdfQkxPQ0tfS0VZLCBib290c3RyYXAsIGVuY3J5cHRpb25LZXksIGVudHJvcHksIGh5cGVyY29yZUtleV0pCiAgKQp9CgpmdW5jdGlvbiBnZXRDb21wYXRCbG9ja0tleShib290c3RyYXAsIGVuY3J5cHRpb25LZXksIG5hbWUpIHsKICBpZiAodHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnKSByZXR1cm4gZ2V0Q29tcGF0QmxvY2tLZXkoYm9vdHN0cmFwLCBlbmNyeXB0aW9uS2V5LCBiNGEuZnJvbShuYW1lKSkKICByZXR1cm4gZW5jcnlwdGlvbktleSAmJiBjcnlwdG8uaGFzaChbTlNfVklFV19CTE9DS19LRVksIGJvb3RzdHJhcCwgZW5jcnlwdGlvbktleSwgbmFtZV0pCn0KCmZ1bmN0aW9uIGJsb2NraGFzaChibG9jaywgcGFkZGluZywgaGFzaEtleSkgewogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goaGFzaCwgYmxvY2ssIGhhc2hLZXkpCiAgcGFkZGluZy5zZXQoaGFzaC5zdWJhcnJheSgwLCA4KSkgLy8gY29weSBmaXJzdCA4IGJ5dGVzIG9mIGhhc2gKICBoYXNoLmZpbGwoMCkgLy8gY2xlYXIgbm9uY2UgYnVmZmVyCn0KCmZ1bmN0aW9uIGVuY3J5cHRCbG9jayhpbmRleCwgYmxvY2ssIGlkLCBibG9ja0tleSwgaGFzaEtleSkgewogIGNvbnN0IHBhZGRpbmcgPSBibG9jay5zdWJhcnJheSgwLCBBdXRvYmFzZUVuY3J5cHRpb24uUEFERElORykKICBibG9jayA9IGJsb2NrLnN1YmFycmF5KEF1dG9iYXNlRW5jcnlwdGlvbi5QQURESU5HKQoKICBibG9ja2hhc2goYmxvY2ssIHBhZGRpbmcsIGhhc2hLZXkpCiAgYy51aW50MzIuZW5jb2RlKHsgc3RhcnQ6IDQsIGVuZDogOCwgYnVmZmVyOiBwYWRkaW5nIH0sIGlkKQoKICBjLnVpbnQ2NC5lbmNvZGUoeyBzdGFydDogMCwgZW5kOiA4LCBidWZmZXI6IG5vbmNlIH0sIGluZGV4KQoKICBwYWRkaW5nWzBdID0gMSAvLyB2ZXJzaW9uIGluIHBsYWludGV4dAoKICBub25jZS5zZXQocGFkZGluZywgOCwgMTYpCgogIC8vIFRoZSBjb21iaW5hdGlvbiBvZiBpbmRleCwga2V5IGlkLCBmb3JrIGlkIGFuZCBibG9jayBoYXNoIGlzIHZlcnkgbGlrZWx5CiAgLy8gdG8gYmUgdW5pcXVlIGZvciBhIGdpdmVuIEh5cGVyY29yZSBhbmQgdGhlcmVmb3JlIG91ciBub25jZSBpcyBzdWl0YWJsZQogIGVuY3J5cHQoYmxvY2ssIG5vbmNlLCBibG9ja0tleSkKfQpjb25zdCBycnAgPSByZXF1aXJlKCdyZXNvbHZlLXJlamVjdC1wcm9taXNlJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQoKY29uc3QgU3lzdGVtVmlldyA9IHJlcXVpcmUoJy4vc3lzdGVtLmpzJykKY29uc3QgeyBFbmNyeXB0aW9uVmlldyB9ID0gcmVxdWlyZSgnLi9lbmNyeXB0aW9uLmpzJykKCmNvbnN0IERFRkFVTFRfT1BfVElNRU9VVCA9IDVfMDAwCmNvbnN0IERFRkFVTFRfTUlOX0ZGID0gMTYKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgRmFzdEZvcndhcmQgewogIGNvbnN0cnVjdG9yKAogICAgYmFzZSwKICAgIGtleSwKICAgIHsKICAgICAgdGltZW91dCA9IERFRkFVTFRfT1BfVElNRU9VVCwKICAgICAgdmVyaWZpZWQgPSB0cnVlLAogICAgICBtaW5pbXVtID0gREVGQVVMVF9NSU5fRkYsCiAgICAgIGZvcmNlID0gZmFsc2UsCiAgICAgIGxlbmd0aCA9IDAKICAgIH0gPSB7fQogICkgewogICAgdGhpcy5iYXNlID0gYmFzZQogICAgdGhpcy5rZXkgPSBrZXkKICAgIHRoaXMudGltZW91dCA9IHRpbWVvdXQKICAgIHRoaXMuZm9yY2UgPSBmb3JjZQogICAgdGhpcy5jb3JlID0gYmFzZS5zdG9yZS5nZXQoeyBrZXksIGFjdGl2ZTogdHJ1ZSwgZW5jcnlwdGlvbjogbnVsbCB9KQogICAgdGhpcy5sZW5ndGggPSBsZW5ndGgKICAgIHRoaXMudmlld3MgPSBbXQogICAgdGhpcy5lbmNyeXB0aW9uID0gbnVsbAogICAgdGhpcy5lbnRyb3B5ID0gbnVsbAogICAgdGhpcy5pbmRleGVycyA9IFtdCiAgICB0aGlzLm1pbmltdW0gPSBtaW5pbXVtCiAgICB0aGlzLnZlcmlmaWVkID0gdmVyaWZpZWQKICAgIHRoaXMud2FpdGluZyA9IG5ldyBTZXQoKQogICAgdGhpcy5jb3JlcyA9IFt0aGlzLmNvcmVdCiAgICB0aGlzLnN5c3RlbSA9IG51bGwKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICAgIHRoaXMudXBncmFkaW5nID0gbnVsbAogICAgdGhpcy5mYWlsZWQgPSBmYWxzZQogIH0KCiAgc3RhdGljIE1JTklNVU0gPSBERUZBVUxUX01JTl9GRgoKICBhc3luYyB1cGdyYWRlKCkgewogICAgdHJ5IHsKICAgICAgaWYgKCF0aGlzLnVwZ3JhZGluZykgdGhpcy51cGdyYWRpbmcgPSB0aGlzLl91cGdyYWRlKCkKCiAgICAgIGlmICghKGF3YWl0IHRoaXMudXBncmFkaW5nKSkgcmV0dXJuIG51bGwKCiAgICAgIHJldHVybiB7CiAgICAgICAgbGVuZ3RoOiB0aGlzLmxlbmd0aCwKICAgICAgICBmb3JjZTogdGhpcy5mb3JjZSwKICAgICAgICBrZXk6IHRoaXMua2V5LAogICAgICAgIGluZGV4ZXJzOiB0aGlzLmluZGV4ZXJzLAogICAgICAgIHZpZXdzOiB0aGlzLnZpZXdzLAogICAgICAgIGVudHJvcHk6IHRoaXMuZW50cm9weSwKICAgICAgICBtYW5pZmVzdFZlcnNpb246IHRoaXMuY29yZS5tYW5pZmVzdC52ZXJzaW9uLAogICAgICAgIG1pbmltdW06IHRoaXMubWluaW11bQogICAgICB9CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgICB0aGlzLmZhaWxlZCA9IHRydWUKICAgICAgcmV0dXJuIG51bGwKICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IHRoaXMuY2xvc2UoKQogICAgfQogIH0KCiAgX3dhaXRGb3JBcHBlbmQoY29yZSkgewogICAgaWYgKGNvcmUubGVuZ3RoID4gMCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCgogICAgY29uc3QgcHJvbWlzZSA9IHJycCgpCiAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dCh0aGlzLmNsb3NlLmJpbmQodGhpcyksIHRoaXMudGltZW91dCkKICAgIGNvbnN0IHdhaXQgPSB7IHByb21pc2UsIHRpbWVvdXQgfQoKICAgIHRoaXMud2FpdGluZy5hZGQod2FpdCkKCiAgICBjb3JlLm9uY2UoJ2FwcGVuZCcsICgpID0+IHsKICAgICAgdGhpcy53YWl0aW5nLmRlbGV0ZSh3YWl0KQogICAgICBjbGVhclRpbWVvdXQodGltZW91dCkKICAgICAgcHJvbWlzZS5yZXNvbHZlKCkKICAgIH0pCgogICAgcmV0dXJuIHByb21pc2UucHJvbWlzZQogIH0KCiAgX21pbkxlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLmJhc2UuY29yZS5sZW5ndGggKyB0aGlzLm1pbmltdW0KICB9CgogIGFzeW5jIF91cGdyYWRlKCkgewogICAgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKCiAgICBpZiAoIXRoaXMudmVyaWZpZWQpIGF3YWl0IHRoaXMuX3dhaXRGb3JBcHBlbmQodGhpcy5jb3JlKQogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4gZmFsc2UKCiAgICBpZiAodGhpcy5jb3JlLm1hbmlmZXN0LmxpbmtlZCkgewogICAgICBjb25zdCBhcHBlbmRzID0gW10KCiAgICAgIGZvciAoY29uc3Qga2V5IG9mIHRoaXMuY29yZS5tYW5pZmVzdC5saW5rZWQpIHsKICAgICAgICBjb25zdCBjb3JlID0gdGhpcy5iYXNlLnN0b3JlLmdldCh7IGtleSwgYWN0aXZlOiB0cnVlIH0pCiAgICAgICAgdGhpcy5jb3Jlcy5wdXNoKGNvcmUpCgogICAgICAgIGF3YWl0IGNvcmUucmVhZHkoKQogICAgICAgIGFwcGVuZHMucHVzaCh0aGlzLl93YWl0Rm9yQXBwZW5kKGNvcmUpKQogICAgICB9CgogICAgICBhd2FpdCBQcm9taXNlLmFsbChhcHBlbmRzKQogICAgfQoKICAgIGlmICh0aGlzLmxlbmd0aCA9PT0gMCkgdGhpcy5sZW5ndGggPSB0aGlzLmNvcmUubGVuZ3RoCgogICAgLy8gbm90ZSB3ZSB1c2UgdGhlIHBlcnNpc3RlZCBsZW5ndGggaGVyZSwgYXMgd2UgbWlnaHQgYXMgd2VsbCBjb250aW51ZSB0aGF0IHdvcmsgYXMgdGhhdHMgfiB0aGUgc2FtZSBsZW5ndGgKICAgIGlmICghdGhpcy5mb3JjZSAmJiB0aGlzLmxlbmd0aCA8IHRoaXMuX21pbkxlbmd0aCgpKSByZXR1cm4gZmFsc2UKICAgIGlmICh0aGlzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGZhbHNlCgogICAgYXdhaXQgdGhpcy5jb3JlLmdldCh0aGlzLmxlbmd0aCAtIDEsIHsgdGltZW91dDogdGhpcy50aW1lb3V0IH0pCiAgICBhd2FpdCB0aGlzLmJhc2UucmVhZHkoKQoKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuIGZhbHNlCgogICAgaWYgKHRoaXMuYmFzZS5lbmNyeXB0aW9uS2V5ICYmICEoYXdhaXQgdGhpcy5fZW5zdXJlRW5jcnlwdGlvbigpKSkgcmV0dXJuIGZhbHNlCiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybiBmYWxzZQoKICAgIHRoaXMuc3lzdGVtID0gbmV3IFN5c3RlbVZpZXcodGhpcy5jb3JlLCB7IGNoZWNrb3V0OiB0aGlzLmxlbmd0aCB9KQogICAgYXdhaXQgdGhpcy5zeXN0ZW0ucmVhZHkoKQogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4gZmFsc2UKCiAgICB0aGlzLmVudHJvcHkgPSB0aGlzLnN5c3RlbS5lbnRyb3B5CgogICAgaWYgKHRoaXMuY29yZS5tYW5pZmVzdC52ZXJzaW9uID49IDIpIHsKICAgICAgY29uc3QgbGlua2VkID0gdGhpcy5jb3JlLm1hbmlmZXN0LmxpbmtlZAoKICAgICAgaWYgKHRoaXMuc3lzdGVtLmVuY3J5cHRpb25MZW5ndGggPT09IDAgfHwgbGlua2VkID09PSBudWxsIHx8ICFsaW5rZWQubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgIH0KCiAgICAgIC8vIHRlY2huaWNhbGx5IGRpdmVyZ2VzIGZyb20gc3lzdGVtLnZpZXdzIHRvIGluY2x1ZGUgZW5jcnlwdGlvbiBoZXJlLCBidXQgbWFrZXMgc2Vuc2UKICAgICAgdGhpcy52aWV3cy5wdXNoKHsKICAgICAgICBrZXk6IGxpbmtlZFswXSwKICAgICAgICBsZW5ndGg6IHRoaXMuc3lzdGVtLmVuY3J5cHRpb25MZW5ndGgKICAgICAgfSkKICAgIH0KCiAgICBjb25zdCBwcm9taXNlcyA9IFtdCgogICAgLy8gZW5zdXJlIGxvY2FsIGtleSBpcyBsb2NhbGx5IGF2YWlsYWJsZSBhbHdheXMKICAgIHByb21pc2VzLnB1c2godGhpcy5zeXN0ZW0uZ2V0KHRoaXMuYmFzZS5sb2NhbC5rZXksIHsgdGltZW91dDogdGhpcy50aW1lb3V0IH0pKQoKICAgIGlmICh0aGlzLmVuY3J5cHRpb24gJiYgdGhpcy5lbmNyeXB0aW9uLmNvcmUpIHsKICAgICAgcHJvbWlzZXMucHVzaCgKICAgICAgICB0aGlzLmVuY3J5cHRpb24uY29yZS5nZXQodGhpcy5zeXN0ZW0uZW5jcnlwdGlvbkxlbmd0aCAtIDEsIHsgdGltZW91dDogdGhpcy50aW1lb3V0IH0pCiAgICAgICkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy5zeXN0ZW0udmlld3MpIHsKICAgICAgdGhpcy52aWV3cy5wdXNoKHYpCiAgICAgIGNvbnN0IGNvcmUgPSB0aGlzLmJhc2Uuc3RvcmUuZ2V0KHsga2V5OiB2LmtleSwgYWN0aXZlOiB0cnVlIH0pCiAgICAgIHRoaXMuY29yZXMucHVzaChjb3JlKQogICAgICBpZiAoIXYubGVuZ3RoKSBjb250aW51ZSAvLyBlbmNyeXB0aW9uIHZpZXcgY2FuIGJlIDAgbGVuZ3RoCiAgICAgIHByb21pc2VzLnB1c2goY29yZS5nZXQodi5sZW5ndGggLSAxLCB7IHRpbWVvdXQ6IHRoaXMudGltZW91dCB9KSkKICAgIH0KCiAgICBmb3IgKGNvbnN0IGlkeCBvZiB0aGlzLnN5c3RlbS5pbmRleGVycykgewogICAgICB0aGlzLmluZGV4ZXJzLnB1c2goaWR4KQogICAgICBpZiAoaWR4Lmxlbmd0aCA9PT0gMCkgY29udGludWUgLy8gbmVlZCB0byBtYWtlIHN1cmUgd2UgaGF2ZSBtYW5pZmVzdC4uLgogICAgICBjb25zdCBjb3JlID0gdGhpcy5iYXNlLnN0b3JlLmdldCh7IGtleTogaWR4LmtleSwgYWN0aXZlOiB0cnVlIH0pCiAgICAgIHRoaXMuY29yZXMucHVzaChjb3JlKQogICAgICBwcm9taXNlcy5wdXNoKGNvcmUuZ2V0KGlkeC5sZW5ndGggLSAxLCB7IHRpbWVvdXQ6IHRoaXMudGltZW91dCB9KSkKICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLnN5c3RlbS5nZXQoaWR4LmtleSwgeyB0aW1lb3V0OiB0aGlzLnRpbWVvdXQgfSkpCiAgICB9CgogICAgZm9yIChjb25zdCBoZWFkIG9mIHRoaXMuc3lzdGVtLmhlYWRzKSB7CiAgICAgIHByb21pc2VzLnB1c2godGhpcy5zeXN0ZW0uZ2V0KGhlYWQua2V5LCB7IHRpbWVvdXQ6IHRoaXMudGltZW91dCB9KSkKICAgIH0KCiAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcykKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuIGZhbHNlCgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIF9lbnN1cmVFbmNyeXB0aW9uKCkgewogICAgLy8gb25seSBuZWVkIGVuY3J5cHRpb24gaWYgd2UgbWlncmF0ZWQKICAgIGlmICh0aGlzLmNvcmUuZW5jcnlwdGlvbiAhPT0gbnVsbCkgcmV0dXJuIHRydWUKCiAgICBjb25zdCBlbmNDb3JlID0gdGhpcy5jb3JlLm1hbmlmZXN0LnZlcnNpb24gPD0gMSA/IG51bGwgOiB0aGlzLmNvcmVzWzFdCgogICAgLy8gZXhwZWN0cyBpbnRlcm5hbCB2aWV3cyB0byBiZSBsb2FkZWQgaW4gb3JkZXIKICAgIHRoaXMuZW5jcnlwdGlvbiA9IG5ldyBFbmNyeXB0aW9uVmlldyh0aGlzLmJhc2UsIGVuY0NvcmUpCiAgICBjb25zdCBlbmNyeXB0aW9uID0gdGhpcy5lbmNyeXB0aW9uLmdldFZpZXdFbmNyeXB0aW9uKCdfc3lzdGVtJykKCiAgICBhd2FpdCB0aGlzLmNvcmUuc2V0RW5jcnlwdGlvbihlbmNyeXB0aW9uKQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBjbG9zZSgpIHsKICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQogICAgZm9yIChjb25zdCB7IHByb21pc2UsIHRpbWVvdXQgfSBvZiB0aGlzLndhaXRpbmcpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpCiAgICAgIHByb21pc2UucmVzb2x2ZSgpIC8vIHNpbGVudGx5IGJhaWwKICAgIH0KICAgIGlmICh0aGlzLnN5c3RlbSkgYXdhaXQgdGhpcy5zeXN0ZW0uY2xvc2UoKQogICAgaWYgKHRoaXMuZW5jcnlwdGlvbikgYXdhaXQgdGhpcy5lbmNyeXB0aW9uLmNsb3NlKCkKICAgIGZvciAoY29uc3QgY29yZSBvZiB0aGlzLmNvcmVzKSBhd2FpdCBjb3JlLmNsb3NlKCkKICAgIGF3YWl0IHRoaXMuY29yZS5jbG9zZSgpCiAgfQp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKCmNvbnN0IFN5c3RlbVZpZXcgPSByZXF1aXJlKCcuL3N5c3RlbS5qcycpCmNvbnN0IHsgRW5jcnlwdGlvblZpZXcgfSA9IHJlcXVpcmUoJy4vZW5jcnlwdGlvbi5qcycpCmNvbnN0IHsgTWFuaWZlc3REYXRhIH0gPSByZXF1aXJlKCcuL21lc3NhZ2VzLmpzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgRm9yayB7CiAgY29uc3RydWN0b3IoYmFzZSwgc3RvcmUsIHN0YXRlLCBmb3JrKSB7CiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgICB0aGlzLnN0b3JlID0gc3RvcmUKICAgIHRoaXMuc3RhdGUgPSBzdGF0ZQogICAgdGhpcy5pbmRleGVycyA9IGZvcmsuaW5kZXhlcnMKICAgIHRoaXMubGVuZ3RoID0gZm9yay5sZW5ndGgKICAgIHRoaXMuc3lzdGVtID0gbnVsbAogICAgdGhpcy5lbmNyeXB0aW9uID0gbnVsbAogICAgdGhpcy5tYW5pZmVzdHMgPSBudWxsCiAgICB0aGlzLmNvcmVzID0gW10KICB9CgogIGFzeW5jIHVwZ3JhZGUoKSB7CiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl91cGdyYWRlKCkKICAgICAgcmV0dXJuIHRydWUKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gZmFsc2UKICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IHRoaXMuY2xvc2UoKQogICAgfQogIH0KCiAgYXN5bmMgX3VwZ3JhZGUoKSB7CiAgICB0aGlzLm1hbmlmZXN0cyA9IGF3YWl0IHRoaXMuc3RvcmUuZ2V0SW5kZXhlck1hbmlmZXN0cyh0aGlzLmluZGV4ZXJzKQoKICAgIHRoaXMuc3lzdGVtID0gbmV3IFN5c3RlbVZpZXcoYXdhaXQgdGhpcy5fZ2V0KCdfc3lzdGVtJywgdGhpcy5sZW5ndGgpKQogICAgdGhpcy5lbmNyeXB0aW9uID0gbmV3IEVuY3J5cHRpb25WaWV3KHRoaXMsIGF3YWl0IHRoaXMuX2dldCgnX2VuY3J5cHRpb24nLCAtMSkpCgogICAgYXdhaXQgdGhpcy5zeXN0ZW0ucmVhZHkoKQogICAgYXdhaXQgdGhpcy5lbmNyeXB0aW9uLnJlYWR5KCkKCiAgICB0aGlzLmVudHJvcHkgPSB0aGlzLnN5c3RlbS5nZXRFbnRyb3B5KHRoaXMuaW5kZXhlcnMsIHRoaXMubGVuZ3RoKQogICAgdGhpcy5tYW5pZmVzdFZlcnNpb24gPSBNYXRoLm1heCh0aGlzLnN5c3RlbS5jb3JlLm1hbmlmZXN0LnZlcnNpb24sIDIpIC8vID49IDIgdG8gc2lnbmFsIG5ldyBlbmNyeXB0aW9uCgogICAgY29uc3Qgdmlld3MgPSBbXQogICAgZm9yIChjb25zdCB2aWV3IG9mIHRoaXMuc3RhdGUudmlld3MpIHsKICAgICAgY29uc3QgdiA9IHRoaXMuZ2V0Vmlld0Zyb21TeXN0ZW0odmlldywgdGhpcy5zeXN0ZW0pCiAgICAgIGNvbnN0IGluZGV4ZWRMZW5ndGggPSB2ID8gdi5sZW5ndGggOiAwCgogICAgICBjb25zdCBzZXNzaW9uID0gYXdhaXQgdGhpcy5fZ2V0KHZpZXcubmFtZSwgaW5kZXhlZExlbmd0aCkKICAgICAgYXdhaXQgc2Vzc2lvbi5yZWFkeSgpCgogICAgICBjb25zdCBuZXh0ID0gYXdhaXQgdGhpcy5jcmVhdGVWaWV3KHZpZXcubmFtZSwgc2Vzc2lvbiwgbnVsbCkKICAgICAgYXdhaXQgbmV4dC5yZWFkeSgpCgogICAgICBhd2FpdCB0aGlzLl9taWdyYXRlKHZpZXcucmVmLCBuZXh0LCB2aWV3LmNvcmUsIGluZGV4ZWRMZW5ndGgpCgogICAgICAvLyB1cGRhdGUga2V5CiAgICAgIHZpZXdzLnB1c2goeyBrZXk6IG5leHQua2V5LCBsZW5ndGg6IGluZGV4ZWRMZW5ndGggfSkKICAgIH0KCiAgICAvLyBpbnRlcm5hbCB2aWV3cyBhcmUgZXhwbGljaXRseSBtaWdyYXRlZAoKICAgIGNvbnN0IGVudHJvcHkgPSBFbmNyeXB0aW9uVmlldy5uYW1lc3BhY2UodGhpcy5lbnRyb3B5KQogICAgYXdhaXQgdGhpcy5lbmNyeXB0aW9uLnVwZGF0ZShlbnRyb3B5KQoKICAgIGNvbnN0IHN5c3RlbSA9IHRoaXMuc3RvcmUuZ2V0Vmlld0J5TmFtZSgnX3N5c3RlbScpCiAgICBjb25zdCBlbmNyeXB0aW9uID0gdGhpcy5zdG9yZS5nZXRWaWV3QnlOYW1lKCdfZW5jcnlwdGlvbicpCgogICAgY29uc3QgZW5jID0gYXdhaXQgdGhpcy5jcmVhdGVWaWV3KCdfZW5jcnlwdGlvbicsIHRoaXMuZW5jcnlwdGlvbi5jb3JlLCBudWxsKQogICAgYXdhaXQgZW5jLnJlYWR5KCkKCiAgICBhd2FpdCB0aGlzLl9taWdyYXRlKGVuY3J5cHRpb24sIGVuYywgdGhpcy5lbmNyeXB0aW9uLmNvcmUsIHRoaXMuZW5jcnlwdGlvbi5jb3JlLmxlbmd0aCkKCiAgICBhd2FpdCB0aGlzLnN5c3RlbS5mb3JrKHRoaXMuaW5kZXhlcnMsIHRoaXMubWFuaWZlc3RzLCB0aGlzLmVuY3J5cHRpb24uY29yZS5sZW5ndGgsIHZpZXdzKQoKICAgIGNvbnN0IHN5cyA9IGF3YWl0IHRoaXMuY3JlYXRlVmlldygnX3N5c3RlbScsIHRoaXMuc3lzdGVtLmNvcmUsIFtlbmMua2V5XSkKICAgIGF3YWl0IHN5cy5yZWFkeSgpCgogICAgYXdhaXQgdGhpcy5fbWlncmF0ZShzeXN0ZW0sIHN5cywgdGhpcy5zeXN0ZW0uY29yZSwgdGhpcy5zeXN0ZW0uY29yZS5sZW5ndGgpCiAgfQoKICBhc3luYyBjcmVhdGVWaWV3KG5hbWUsIGNvcmUsIGxpbmtlZCkgewogICAgY29uc3QgcHJvbG9ndWUgPSBhd2FpdCBnZXRQcm9sb2d1ZShjb3JlKQogICAgY29uc3QgbWFuaWZlc3REYXRhID0gdGhpcy5fbWFuaWZlc3REYXRhKGNvcmUpCgogICAgcmV0dXJuIHRoaXMuc3RvcmUuZ2V0Vmlld0NvcmUoCiAgICAgIHRoaXMubWFuaWZlc3RzLAogICAgICBuYW1lLAogICAgICBwcm9sb2d1ZSwKICAgICAgdGhpcy5tYW5pZmVzdFZlcnNpb24sCiAgICAgIHRoaXMuZW50cm9weSwKICAgICAgbGlua2VkLAogICAgICBtYW5pZmVzdERhdGEKICAgICkKICB9CgogIGFzeW5jIF9nZXQobmFtZSwgbGVuZ3RoKSB7CiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoeyBuYW1lIH0pCiAgICB0aGlzLmNvcmVzLnB1c2goY29yZSkKCiAgICBpZiAobGVuZ3RoICE9PSAtMSkgYXdhaXQgY29yZS50cnVuY2F0ZShsZW5ndGgpCgogICAgcmV0dXJuIGNvcmUKICB9CgogIGdldFZpZXdGcm9tU3lzdGVtKHZpZXcpIHsKICAgIGlmICh2aWV3Lm1hcHBlZEluZGV4ID09PSAtMSB8fCB2aWV3Lm1hcHBlZEluZGV4ID49IHRoaXMuc3lzdGVtLnZpZXdzLmxlbmd0aCkgcmV0dXJuIG51bGwKICAgIHJldHVybiB0aGlzLnN5c3RlbS52aWV3c1t2aWV3Lm1hcHBlZEluZGV4XQogIH0KCiAgX21hbmlmZXN0RGF0YShzZXNzaW9uKSB7CiAgICBpZiAoc2Vzc2lvbi5tYW5pZmVzdC52ZXJzaW9uID4gMSkgcmV0dXJuIHNlc3Npb24ubWFuaWZlc3QudXNlckRhdGEKICAgIHJldHVybiBjLmVuY29kZShNYW5pZmVzdERhdGEsIHsgdmVyc2lvbjogMCwgbGVnYWN5QmxvY2tzOiBzZXNzaW9uLmxlbmd0aCB9KQogIH0KCiAgYXN5bmMgX21pZ3JhdGUocmVmLCBuZXh0LCBzb3VyY2UsIGxlbmd0aCkgewogICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgYXdhaXQgbmV4dC5jb3JlLmNvcHlQcm9sb2d1ZShzb3VyY2Uuc3RhdGUpCiAgICB9CgogICAgLy8gcmVtYWtlIHRoZSBiYXRjaCwgcmVzZXQgZnJvbSBvdXIgcHJvbG9ndWUgaW4gY2FzZSBpdCByZXBsaWNhdGVkIGluYmV0d2VlbgogICAgLy8gVE9ETzogd2Ugc2hvdWxkIHJlYWxseSBoYXZlIGFuIEhDIGZ1bmN0aW9uIGZvciB0aGlzCiAgICBjb25zdCBiYXRjaCA9IG5leHQuc2Vzc2lvbih7IG5hbWU6ICdiYXRjaCcsIG92ZXJ3cml0ZTogdHJ1ZSwgY2hlY2tvdXQ6IGxlbmd0aCB9KQogICAgYXdhaXQgYmF0Y2gucmVhZHkoKQoKICAgIGlmIChzb3VyY2UgIT09IG51bGwpIHsKICAgICAgd2hpbGUgKGJhdGNoLmxlbmd0aCA8IHNvdXJjZS5sZW5ndGgpIHsKICAgICAgICBhd2FpdCBiYXRjaC5hcHBlbmQoYXdhaXQgc291cmNlLmdldChiYXRjaC5sZW5ndGgpKQogICAgICB9CiAgICB9CgogICAgYXdhaXQgcmVmLmJhdGNoLnN0YXRlLm1vdmVUbyhiYXRjaCwgYmF0Y2gubGVuZ3RoKQogICAgYXdhaXQgYmF0Y2guY2xvc2UoKQoKICAgIHJlZi5taWdyYXRlZCh0aGlzLmJhc2UsIG5leHQpCiAgfQoKICBhc3luYyBjbG9zZSgpIHsKICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQogICAgaWYgKHRoaXMuc3lzdGVtKSBhd2FpdCB0aGlzLnN5c3RlbS5jbG9zZSgpCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uKSBhd2FpdCB0aGlzLmVuY3J5cHRpb24uY2xvc2UoKQogICAgZm9yIChjb25zdCBjb3JlIG9mIHRoaXMuY29yZXMpIGF3YWl0IGNvcmUuY2xvc2UoKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZ2V0UHJvbG9ndWUoY29yZSkgewogIGlmICghY29yZS5sZW5ndGgpIHJldHVybiBudWxsCgogIHJldHVybiB7CiAgICBoYXNoOiBhd2FpdCBjb3JlLnRyZWVIYXNoKCksCiAgICBsZW5ndGg6IGNvcmUubGVuZ3RoCiAgfQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ25hbm9hc3NlcnQnKQoKY29uc3QgQ2xvY2sgPSByZXF1aXJlKCcuL2Nsb2NrLmpzJykKY29uc3QgQ29uc2Vuc3VzID0gcmVxdWlyZSgnLi9jb25zZW5zdXMuanMnKQpjb25zdCBUb3BvbGlzdCA9IHJlcXVpcmUoJy4vdG9wb2xpc3QuanMnKQoKY2xhc3MgTm9kZSB7CiAgY29uc3RydWN0b3Iod3JpdGVyLCBsZW5ndGgsIHZhbHVlLCBoZWFkcywgYmF0Y2gsIGRlcGVuZGVuY2llcywgb3B0aW1pc3RpYywgdHJhY2UpIHsKICAgIHRoaXMud3JpdGVyID0gd3JpdGVyCiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aAogICAgdGhpcy52YWx1ZSA9IHZhbHVlCiAgICB0aGlzLmhlYWRzID0gaGVhZHMKICAgIHRoaXMuYWN0dWFsSGVhZHMgPSBoZWFkcy5zbGljZSgwKSAvLyBUT0RPOiB3ZSBzaG91bGQgcmVtb3ZlIHRoaXMgYW5kIGp1c3Qgbm90IG11dGF0ZSBoZWFkcy4uLgoKICAgIHRoaXMuZGVwZW5kZW50cyA9IG5ldyBTZXQoKQogICAgdGhpcy5kZXBlbmRlbmNpZXMgPSBkZXBlbmRlbmNpZXMKICAgIHRoaXMuaW5kZXggPSAwIC8vIHVzZWQgYnkgdG9wb2xpc3QKCiAgICB0aGlzLm9wdGltaXN0aWMgPSBvcHRpbWlzdGljICYmIGJhdGNoID09PSAxICYmICEhdmFsdWUKCiAgICB0aGlzLmJhdGNoID0gYmF0Y2gKICAgIHRoaXMuZHJvcHBlZCA9IDAKICAgIHRoaXMudHJhY2UgPSB0cmFjZQoKICAgIHRoaXMuY2xvY2sgPSBuZXcgQ2xvY2soKQoKICAgIHRoaXMueWllbGRlZCA9IGZhbHNlCiAgICB0aGlzLnlpZWxkaW5nID0gZmFsc2UKICB9CgogIGlzVGFpbCgpIHsKICAgIHJldHVybiB0aGlzLmRlcGVuZGVuY2llcy5zaXplID09PSB0aGlzLmRyb3BwZWQKICB9CgogIGNhdXNhbERlcGVuZGVuY2llcyhpZHgpIHsKICAgIGNvbnN0IG9yZGVyID0gW3RoaXNdCiAgICBjb25zdCBzdGFjayA9IFt0aGlzXQoKICAgIGxldCB2aXNpdGVkID0gbnVsbAoKICAgIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG5vZGUgPSBzdGFjay5wb3AoKQogICAgICBmb3IgKGNvbnN0IGRlcCBvZiBub2RlLmRlcGVuZGVuY2llcykgewogICAgICAgIGlmICghZGVwLndyaXRlci5pc1JlbW92ZWQgfHwgZGVwLndyaXRlci5pc0FjdGl2ZUluZGV4ZXIpIGNvbnRpbnVlCgogICAgICAgIC8vIFRPRE86IHJlcGxhY2Ugd2l0aCAiY29sb3JpbmciIGJ1dCBvayBmb3Igbm93LCB0aW55IHNldAogICAgICAgIGlmICh2aXNpdGVkID09PSBudWxsKSB2aXNpdGVkID0gbmV3IFNldCgpCiAgICAgICAgaWYgKHZpc2l0ZWQuaGFzKGRlcCkpIGNvbnRpbnVlCiAgICAgICAgdmlzaXRlZC5hZGQoZGVwKQoKICAgICAgICBzdGFjay5wdXNoKGRlcCkKICAgICAgICBvcmRlci5wdXNoKGRlcCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBvcmRlcgogIH0KCiAgY2xlYXIoKSB7CiAgICB0aGlzLmNsb2NrID0gbnVsbAogICAgdGhpcy5kZXBlbmRlbnRzID0gbnVsbAogICAgcmV0dXJuIHRoaXMKICB9CgogIHJlc2V0KCkgewogICAgdGhpcy55aWVsZGVkID0gZmFsc2UKICAgIHRoaXMueWllbGRpbmcgPSBmYWxzZQogICAgZm9yIChjb25zdCBkZXAgb2YgdGhpcy5kZXBlbmRlbnRzKSBkZXAuZGVwZW5kZW5jaWVzLmFkZCh0aGlzKQogICAgdGhpcy5kZXBlbmRlbnRzLmNsZWFyKCkKICB9CgogIGFjdGl2ZSgpIHsKICAgIGZvciAoY29uc3QgZGVwIG9mIHRoaXMuZGVwZW5kZW5jaWVzKSB7CiAgICAgIGlmIChkZXAueWllbGRlZCkgewogICAgICAgIHRoaXMuZGVwZW5kZW5jaWVzLmRlbGV0ZShkZXApIC8vIG5vZGVzIG1pZ2h0IGJlIHlpZWxkZWQgZHVyaW5nIGJ1ZmZlcmluZwogICAgICB9IGVsc2UgewogICAgICAgIGRlcC5kZXBlbmRlbnRzLmFkZCh0aGlzKQogICAgICAgIHRoaXMuY2xvY2suYWRkKGRlcC5jbG9jaykKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLndyaXRlci5pc0FjdGl2ZUluZGV4ZXIpIHRoaXMuY2xvY2suc2V0KHRoaXMud3JpdGVyLmNvcmUua2V5LCB0aGlzLmxlbmd0aCkKICB9CgogIHRpZUJyZWFrKG5vZGUpIHsKICAgIHJldHVybiB0aWVCcmVhayh0aGlzLCBub2RlKQogIH0KCiAgaGFzRGVwZW5kZW5jeShkZXApIHsKICAgIGZvciAoY29uc3QgaCBvZiB0aGlzLmFjdHVhbEhlYWRzKSB7CiAgICAgIGlmIChzYW1lTm9kZShoLCBkZXApKSByZXR1cm4gdHJ1ZQogICAgfQogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBnZXQgcmVmKCkgewogICAgcmV0dXJuIHRoaXMud3JpdGVyLmNvcmUua2V5LnRvU3RyaW5nKCdoZXgnKS5zbGljZSgwLCAyKSArICc6JyArIHRoaXMubGVuZ3RoCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIExpbmVhcml6ZXIgewogIGNvbnN0cnVjdG9yKGluZGV4ZXJzLCB7IGhlYWRzID0gW10sIHdyaXRlcnMgPSBuZXcgTWFwKCkgfSA9IHt9KSB7CiAgICB0aGlzLmhlYWRzID0gbmV3IFNldCgpCiAgICB0aGlzLnRhaWxzID0gbmV3IFNldCgpCiAgICB0aGlzLnRpcCA9IG5ldyBUb3BvbGlzdCgpCiAgICB0aGlzLnNpemUgPSAwIC8vIHVzZWZ1bCBmb3IgZGVidWdnaW5nCiAgICB0aGlzLnVwZGF0ZWQgPSBmYWxzZQogICAgdGhpcy5pbmRleGVyc1VwZGF0ZWQgPSBmYWxzZQogICAgdGhpcy53cml0ZXJzID0gd3JpdGVycwoKICAgIHRoaXMuY29uc2Vuc3VzID0gbmV3IENvbnNlbnN1cyhpbmRleGVycykKICAgIHRoaXMuX2luaXRpYWxIZWFkcyA9IGhlYWRzLnNsaWNlKDApCiAgICB0aGlzLl9zdHJpY3RseUFkZGVkID0gbnVsbAoKICAgIGZvciAoY29uc3QgeyBrZXksIGxlbmd0aCB9IG9mIGhlYWRzKSB7CiAgICAgIHRoaXMuY29uc2Vuc3VzLnJlbW92ZWQuc2V0KGtleSwgbGVuZ3RoKQogICAgfQogIH0KCiAgZ2V0IGluZGV4ZXJzKCkgewogICAgcmV0dXJuIHRoaXMuY29uc2Vuc3VzLmluZGV4ZXJzCiAgfQoKICBzdGF0aWMgY3JlYXRlTm9kZSh3cml0ZXIsIGxlbmd0aCwgdmFsdWUsIGhlYWRzLCBiYXRjaCwgZGVwZW5kZW5jaWVzLCBvcHRpbWlzdGljLCB0cmFjZSkgewogICAgcmV0dXJuIG5ldyBOb2RlKHdyaXRlciwgbGVuZ3RoLCB2YWx1ZSwgaGVhZHMsIGJhdGNoLCBkZXBlbmRlbmNpZXMsIG9wdGltaXN0aWMsIHRyYWNlKQogIH0KCiAgLy8gcmV0dXJucyB0aGUgZ2xvYmFsIGxpbmtzIG9mIHRoZSBkYWcsIHVzZSB0aGlzIHRvIGxpbmsgYWdhaW5zdCB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgZGFnCiAgLy8gVE9ETzogcmVuYW1lIHRvIGhlYWRzKCkgYW5kIG1vdmUgdGhlIHNldHMgdG8gXyBwcm9wcwogIGdldEhlYWRzKCkgewogICAgY29uc3QgaGVhZHMgPSB0aGlzLl9pbml0aWFsSGVhZHMuc2xpY2UoMCkKICAgIGZvciAoY29uc3Qgbm9kZSBvZiB0aGlzLmhlYWRzKSBoZWFkcy5wdXNoKHsga2V5OiBub2RlLndyaXRlci5jb3JlLmtleSwgbGVuZ3RoOiBub2RlLmxlbmd0aCB9KQogICAgcmV0dXJuIGhlYWRzCiAgfQoKICAvLyBUT0RPOiBtaWdodCBjb250YWluIGR1cHMgYXRtLCBuYmQgZm9yIGhvdyB3ZSB1c2UgaXQsIHJldHVybnMgYW4gYXJyYXkgb2Ygd3JpdGVycyB5b3UgY2FuICJwdWxsIgogIC8vIHRvIGdldCB0aGUgZnVsbCBkYWcgdmlldyBhdCBhbnkgdGltZQogIGdldEJvb3RzdHJhcFdyaXRlcnMoKSB7CiAgICBjb25zdCB3cml0ZXJzID0gW10KCiAgICBmb3IgKGNvbnN0IGhlYWQgb2YgdGhpcy5oZWFkcykgd3JpdGVycy5wdXNoKGhlYWQud3JpdGVyKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNvbnNlbnN1cy5pbmRleGVycy5sZW5ndGg7IGkrKykKICAgICAgd3JpdGVycy5wdXNoKHRoaXMuY29uc2Vuc3VzLmluZGV4ZXJzW2ldKQoKICAgIHJldHVybiB3cml0ZXJzCiAgfQoKICBhZGRIZWFkKG5vZGUpIHsKICAgIG5vZGUuYWN0aXZlKCkKCiAgICAvLyA5OS45OSUgb2YgdGhlIHRpbWUgX2luaXRpYWxIZWFkcyBpcyBlbXB0eS4uLgogICAgaWYgKHRoaXMuX2luaXRpYWxIZWFkcy5sZW5ndGggPiAwKSB0aGlzLl91cGRhdGVJbml0aWFsSGVhZHMobm9kZSkKCiAgICBpZiAobm9kZS5pc1RhaWwoKSkgewogICAgICB0aGlzLnRhaWxzLmFkZChub2RlKQogICAgfQoKICAgIGZvciAoY29uc3QgaGVhZCBvZiB0aGlzLmhlYWRzKSB7CiAgICAgIGlmIChub2RlLmhhc0RlcGVuZGVuY3koaGVhZCkpIHsKICAgICAgICB0aGlzLmhlYWRzLmRlbGV0ZShoZWFkKQogICAgICB9CiAgICB9CgogICAgdGhpcy50aXAuYWRkKG5vZGUpCiAgICBpZiAobm9kZS53cml0ZXIuaXNBY3RpdmVJbmRleGVyKSB0aGlzLmNvbnNlbnN1cy5hZGRIZWFkKG5vZGUpCgogICAgdGhpcy5zaXplKysKICAgIHRoaXMuaGVhZHMuYWRkKG5vZGUpCgogICAgdGhpcy51cGRhdGVkID0gdHJ1ZQoKICAgIHJldHVybiBub2RlCiAgfQoKICB1cGRhdGUoKSB7CiAgICBpZiAoIXRoaXMudXBkYXRlZCkgcmV0dXJuIG51bGwKICAgIHRoaXMudXBkYXRlZCA9IGZhbHNlCgogICAgLy8gZ2V0IHRoZSBpbmRleGVkIG5vZGVzCiAgICBjb25zdCBpbmRleGVkID0gW10KICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGNvbnN0IG5vZGVzID0gdGhpcy5jb25zZW5zdXMuc2hpZnQoKQogICAgICBpZiAoIW5vZGVzLmxlbmd0aCkgYnJlYWsKCiAgICAgIHRoaXMuX3lpZWxkKG5vZGVzLCBpbmRleGVkKQogICAgfQoKICAgIHJldHVybiB0aGlzLnRpcC5mbHVzaChpbmRleGVkKQogIH0KCiAgX3VwZGF0ZUluaXRpYWxIZWFkcyhub2RlKSB7CiAgICBmb3IgKGNvbnN0IGhlYWQgb2Ygbm9kZS5hY3R1YWxIZWFkcykgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX2luaXRpYWxIZWFkcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHsga2V5LCBsZW5ndGggfSA9IHRoaXMuX2luaXRpYWxIZWFkc1tpXQogICAgICAgIGlmIChsZW5ndGggIT09IGhlYWQubGVuZ3RoIHx8ICFiNGEuZXF1YWxzKGtleSwgaGVhZC5rZXkpKSBjb250aW51ZQogICAgICAgIHRoaXMuX2luaXRpYWxIZWFkcy5zcGxpY2UoaS0tLCAxKQogICAgICB9CiAgICB9CiAgfQoKICAvKiBBY2sgbWV0aG9kcyAqLwoKICBzaG91bGRBY2sod3JpdGVyLCBwZW5kaW5nID0gZmFsc2UpIHsKICAgIGlmICghd3JpdGVyIHx8ICF3cml0ZXIuaXNBY3RpdmVJbmRleGVyKSByZXR1cm4gZmFsc2UKCiAgICAvLyBhbGwgaW5kZXhlcnMgaGF2ZSB0byBmbHVzaGVkIHRvIHRoZSBkYWcgYmVmb3JlIHdlIGFjayBhcyBhIHF1aWNrICJkZWJvdW5jZSIKICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLmluZGV4ZXJzKSB7CiAgICAgIGlmICh3Lmxlbmd0aCAhPT0gdy5hdmFpbGFibGUpIHJldHVybiBmYWxzZQogICAgfQoKICAgIGxldCBpc0hlYWQgPSBmYWxzZQoKICAgIC8vIGlmIEFOWSBoZWFkIGlzIG5vdCBhbiBpbmRleGVyIGFjawogICAgZm9yIChjb25zdCBoZWFkIG9mIHRoaXMuaGVhZHMpIHsKICAgICAgaWYgKCFoZWFkLndyaXRlci5pc0FjdGl2ZUluZGV4ZXIpIHJldHVybiB0cnVlCiAgICAgIGlmIChoZWFkLndyaXRlciA9PT0gd3JpdGVyKSBpc0hlYWQgPSB0cnVlCiAgICB9CgogICAgaWYgKHRoaXMuaGVhZHMuc2l6ZSA9PT0gMSAmJiBpc0hlYWQpIHsKICAgICAgcmV0dXJuIGZhbHNlIC8vIG5ldmVyIHNlbGYtYWNrIQogICAgfQoKICAgIGNvbnN0IHZpc2l0ZWQgPSBuZXcgU2V0KCkKCiAgICAvLyBjaGVjayBpZiB0aGVyZSBpcyBub24tbnVsbCB2YWx1ZQogICAgbGV0IHZhbHVlQ2hlY2sgPSBmYWxzZQoKICAgIGZvciAoY29uc3QgdGFpbCBvZiB0aGlzLnRhaWxzKSB7CiAgICAgIGlmIChwZW5kaW5nIHx8IHRoaXMuX25vbk51bGwodGFpbCwgdmlzaXRlZCkpIHsKICAgICAgICB2YWx1ZUNoZWNrID0gdHJ1ZQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KCiAgICBpZiAoIXZhbHVlQ2hlY2spIHJldHVybiBmYWxzZQoKICAgIGlmICh0aGlzLmNvbnNlbnN1cy5zaG91bGRBY2sod3JpdGVyKSkgcmV0dXJuIHRydWUKCiAgICByZXR1cm4gdGhpcy5fc2hvdWxkQWNrSGVhZHMod3JpdGVyLCBwZW5kaW5nKQogIH0KCiAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgYW55IHZhbHVlIGFib3ZlIHRoaXMgbm9kZQogIF9ub25OdWxsKHRhcmdldCwgdmlzaXRlZCkgewogICAgY29uc3Qgc3RhY2sgPSBbdGFyZ2V0XQoKICAgIHdoaWxlIChzdGFjay5sZW5ndGgpIHsKICAgICAgY29uc3Qgbm9kZSA9IHN0YWNrLnBvcCgpCgogICAgICBpZiAodmlzaXRlZC5oYXMobm9kZSkpIGNvbnRpbnVlCiAgICAgIGlmIChub2RlLnZhbHVlICE9PSBudWxsKSByZXR1cm4gdHJ1ZQoKICAgICAgdmlzaXRlZC5hZGQobm9kZSkKCiAgICAgIGZvciAoY29uc3QgZGVwIG9mIG5vZGUuZGVwZW5kZW50cykgewogICAgICAgIHN0YWNrLnB1c2goZGVwKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICAvLyBhY2sgaWYgYW55IGhlYWQgaXMgY2xvc2VyIHRvIGNvbmZpcm1pbmcgYSB2YWx1ZQogIF9zaG91bGRBY2tIZWFkcyh3cml0ZXIsIHBlbmRpbmcpIHsKICAgIGNvbnN0IHByZXYgPSB3cml0ZXIuaGVhZCgpCgogICAgZm9yIChjb25zdCBoZWFkIG9mIHRoaXMuaGVhZHMpIHsKICAgICAgLy8gb25seSBjaGVjayBvdGhlciB3cml0ZXJzIGhlYWRzCiAgICAgIGlmIChoZWFkLndyaXRlciA9PT0gd3JpdGVyKSBjb250aW51ZQoKICAgICAgY29uc3Qgc3RhY2sgPSBbaGVhZF0KICAgICAgY29uc3QgdmlzaXRlZCA9IG5ldyBTZXQoKQoKICAgICAgd2hpbGUgKHN0YWNrLmxlbmd0aCkgewogICAgICAgIGNvbnN0IG5vZGUgPSBzdGFjay5wb3AoKQoKICAgICAgICBpZiAodmlzaXRlZC5oYXMobm9kZSkpIGNvbnRpbnVlCiAgICAgICAgdmlzaXRlZC5hZGQobm9kZSkKCiAgICAgICAgaWYgKHBlbmRpbmcgfHwgbm9kZS52YWx1ZSAhPT0gbnVsbCkgewogICAgICAgICAgY29uc3QgYWNrcyA9IHRoaXMuY29uc2Vuc3VzLmFja3NGcm9tTm9kZShub2RlLCBoZWFkKQogICAgICAgICAgY29uc3QgcHJldkFja3MgPSB0aGlzLmNvbnNlbnN1cy5hY2tzRnJvbU5vZGUobm9kZSwgcHJldikKCiAgICAgICAgICAvLyBoZWFkIHNlZXMgbW9yZSBhY2tzCiAgICAgICAgICBpZiAoYWNrcy5zaXplID4gcHJldkFja3Muc2l6ZSkgcmV0dXJuIHRydWUKCiAgICAgICAgICBmb3IgKGNvbnN0IGlkeCBvZiBhY2tzKSB7CiAgICAgICAgICAgIC8vIGhlYWQgc2VlcyBhY2tzIHRoYXQgd3JpdGVyIGRvZXMgbm90CiAgICAgICAgICAgIGlmICghcHJldkFja3MuaGFzKGlkeCkpIHJldHVybiB0cnVlCiAgICAgICAgICB9CgogICAgICAgICAgLy8gYm90aCBzZWVuLCBubyBwb2ludCBnb2luZyBhbnkgZnVydGhlciBkb3duCiAgICAgICAgICBpZiAocHJldkFja3Muc2l6ZSAmJiBhY2tzLnNpemUpIGNvbnRpbnVlCiAgICAgICAgfQoKICAgICAgICBzdGFjay5wdXNoKC4uLm5vZGUuZGVwZW5kZW5jaWVzKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICAvKiBGdWxsIERBRyBtZXRob2RzICovCgogIF95aWVsZChub2RlcywgaW5kZXhlZCA9IFtdKSB7CiAgICBjb25zdCBvZmZzZXQgPSBpbmRleGVkLmxlbmd0aAogICAgY29uc3QgdGFpbHMgPSBbXQoKICAgIC8vIGRldGVybWluZSB3aGljaCBub2RlcyBhcmUgeWllbGRlZAogICAgd2hpbGUgKG5vZGVzLmxlbmd0aCkgewogICAgICBjb25zdCBub2RlID0gbm9kZXMucG9wKCkKCiAgICAgIGlmIChub2RlLnlpZWxkaW5nKSBjb250aW51ZQogICAgICBub2RlLnlpZWxkaW5nID0gdHJ1ZQoKICAgICAgaWYgKG5vZGUuaXNUYWlsKCkpIHRhaWxzLnB1c2gobm9kZSkKCiAgICAgIG5vZGVzLnB1c2goLi4ubm9kZS5kZXBlbmRlbmNpZXMpCiAgICB9CgogICAgd2hpbGUgKHRhaWxzLmxlbmd0aCkgewogICAgICBsZXQgdGFpbCA9IHRhaWxzLnBvcCgpCgogICAgICBmb3IgKHRhaWwgb2YgdGhpcy5fcmVtb3ZlQmF0Y2godGFpbCkpIHsKICAgICAgICBUb3BvbGlzdC5hZGQodGFpbCwgaW5kZXhlZCwgb2Zmc2V0KQogICAgICB9CgogICAgICBmb3IgKGNvbnN0IGRlcCBvZiB0YWlsLmRlcGVuZGVudHMpIHsKICAgICAgICBpZiAoZGVwLmlzVGFpbCgpICYmIGRlcC55aWVsZGluZykgdGFpbHMucHVzaChkZXApCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gaW5kZXhlZAogIH0KCiAgX2lzRnV0dXJlVGFpbChub2RlKSB7CiAgICBsZXQgZHJvcHBlZCA9IG5vZGUuZHJvcHBlZAoKICAgIC8vIGEgdGFpbCBoYXMgbm8gdW55aWVsZGVkIGRlcGVuZGVuY2llcwogICAgZm9yIChjb25zdCBkZXAgb2Ygbm9kZS5kZXBlbmRlbmNpZXMpIHsKICAgICAgaWYgKGRlcC55aWVsZGVkKSBjb250aW51ZQogICAgICBpZiAoZHJvcHBlZCA9PT0gMCkgcmV0dXJuIGZhbHNlCiAgICAgIGRyb3BwZWQtLQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfcmVtb3ZlTm9kZShub2RlKSB7CiAgICB0aGlzLnRhaWxzLmRlbGV0ZShub2RlKQogICAgdGhpcy5oZWFkcy5kZWxldGUobm9kZSkKICAgIHRoaXMuY29uc2Vuc3VzLnJlbW92ZShub2RlKQoKICAgIC8vIHVwZGF0ZSB0aGUgdGFpbHNldAogICAgZm9yIChjb25zdCBkIG9mIG5vZGUuZGVwZW5kZW50cykgewogICAgICBpZiAoZC55aWVsZGluZyAmJiBkLmRlcGVuZGVuY2llcy5oYXMobm9kZSkpCiAgICAgICAgZC5kcm9wcGVkKysgLy8ga2VlcCBsaW5rcyBmb3IgdGhlIGluZGV4ZWQgYmF0Y2gKICAgICAgZWxzZSBkLmRlcGVuZGVuY2llcy5kZWxldGUobm9kZSkKICAgICAgaWYgKHRoaXMuX2lzRnV0dXJlVGFpbChkKSkgdGhpcy50YWlscy5hZGQoZCkKICAgIH0KCiAgICBub2RlLnlpZWxkZWQgPSB0cnVlCiAgICB0aGlzLnNpemUtLQoKICAgIGlmICh0aGlzLmhlYWRzLnNpemUgPT09IDApIHsKICAgICAgLy8gaW4gY2FzZSBvZiBhIHNpbmdsZSB3cml0ZXIgdGhlIGRhZyBtaWdodCBkcmFpbiBpbW1lZGlhdGVseS4uLgogICAgICB0aGlzLl9pbml0aWFsSGVhZHMucHVzaCh7IGtleTogbm9kZS53cml0ZXIuY29yZS5rZXksIGxlbmd0aDogbm9kZS5sZW5ndGggfSkKICAgIH0KCiAgICByZXR1cm4gbm9kZQogIH0KCiAgX3JlbW92ZUJhdGNoKG5vZGUpIHsKICAgIGNvbnN0IGJhdGNoID0gW3RoaXMuX3JlbW92ZU5vZGUobm9kZSldCgogICAgd2hpbGUgKG5vZGUuYmF0Y2ggIT09IDEpIHsKICAgICAgLy8gaXRzIGEgYmF0Y2ghCiAgICAgIGlmIChub2RlLmRlcGVuZGVudHMuc2l6ZSA9PT0gMCkgewogICAgICAgIC8vIGJhZCBiYXRjaCBub2RlLCBhdXRvIGNvcnJlY3QKICAgICAgICBjb25zdCBuZXh0ID0gbm9kZS53cml0ZXIuZ2V0KG5vZGUubGVuZ3RoKQogICAgICAgIGlmIChuZXh0ICYmIG5leHQuYmF0Y2ggPT09IG5vZGUuYmF0Y2ggLSAxKSBub2RlLmRlcGVuZGVudHMuYWRkKG5leHQpCiAgICAgIH0KCiAgICAgIGFzc2VydChub2RlLmRlcGVuZGVudHMuc2l6ZSA9PT0gMSwgJ0JhdGNoIGlzIGxpbmtlZCBwYXJ0aWFsbHksIHdoaWNoIGlzIG5vdCBhbGxvd2VkJykKCiAgICAgIG5vZGUgPSBnZXRGaXJzdChub2RlLmRlcGVuZGVudHMpCiAgICAgIGJhdGNoLnB1c2godGhpcy5fcmVtb3ZlTm9kZShub2RlKSkKICAgIH0KCiAgICByZXR1cm4gYmF0Y2gKICB9Cn0KCmZ1bmN0aW9uIHRpZUJyZWFrKGEsIGIpIHsKICByZXR1cm4gVG9wb2xpc3QuY29tcGFyZShhLCBiKSA8IDAgLy8gbG93ZXN0IGtleSB3aXMKfQoKZnVuY3Rpb24gZ2V0Rmlyc3Qoc2V0KSB7CiAgcmV0dXJuIHNldFtTeW1ib2wuaXRlcmF0b3JdKCkubmV4dCgpLnZhbHVlCn0KCmZ1bmN0aW9uIHNhbWVOb2RlKGEsIGIpIHsKICByZXR1cm4gYjRhLmVxdWFscyhhLmtleSwgYi53cml0ZXIuY29yZS5rZXkpICYmIGEubGVuZ3RoID09PSBiLmxlbmd0aAp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IG1lc3NhZ2VzID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCgpjb25zdCBHVEUgPSBiNGEuZnJvbShbbWVzc2FnZXMuTElORUFSSVpFUl9QUkVGSVhdKQpjb25zdCBMVCA9IGI0YS5mcm9tKFttZXNzYWdlcy5MSU5FQVJJWkVSX1BSRUZJWCArIDFdKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBMb2NhbFN0YXRlIHsKICBjb25zdHJ1Y3Rvcihjb3JlKSB7CiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICB0aGlzLnR4ID0gbnVsbAogIH0KCiAgc3RhdGljIGNsZWFyKGNvcmUpIHsKICAgIGNvbnN0IHR4ID0gY29yZS5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKICAgIHR4LmRlbGV0ZUxvY2FsUmFuZ2UoR1RFLCBMVCkKICAgIHJldHVybiB0eC5mbHVzaCgpCiAgfQoKICBzdGF0aWMgYXN5bmMgbW92ZVRvKHNyYywgZHN0KSB7CiAgICBjb25zdCBib290ID0gYXdhaXQgc3JjLmdldFVzZXJEYXRhKCdhdXRvYmFzZS9ib290JykKICAgIGNvbnN0IHR4ID0gZHN0LnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQoKICAgIHR4LmRlbGV0ZUxvY2FsUmFuZ2UoR1RFLCBMVCkKCiAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2Ygc3JjLnN0YXRlLnN0b3JhZ2UuY3JlYXRlTG9jYWxTdHJlYW0oeyBndGU6IEdURSwgbHQ6IExUIH0pKSB7CiAgICAgIHR4LnB1dExvY2FsKGRhdGEua2V5LCBkYXRhLnZhbHVlKQogICAgfQoKICAgIHR4LnB1dFVzZXJEYXRhKCdhdXRvYmFzZS9ib290JywgYm9vdCkKCiAgICBhd2FpdCB0eC5mbHVzaCgpCiAgfQoKICBzZXRCb290UmVjb3JkKGJvb3QpIHsKICAgIGlmICh0aGlzLnR4ID09PSBudWxsKSB0aGlzLnR4ID0gdGhpcy5jb3JlLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQoKICAgIHRoaXMudHgucHV0VXNlckRhdGEoJ2F1dG9iYXNlL2Jvb3QnLCBjLmVuY29kZShtZXNzYWdlcy5Cb290UmVjb3JkLCBib290KSkKICB9CgogIGFzeW5jIGxpc3RVcGRhdGVzKCkgewogICAgY29uc3QgdXBkYXRlcyA9IFtdCgogICAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIHRoaXMuY29yZS5zdGF0ZS5zdG9yYWdlLmNyZWF0ZUxvY2FsU3RyZWFtKHsgZ3RlOiBHVEUsIGx0OiBMVCB9KSkgewogICAgICBjb25zdCB1cGRhdGUgPSBjLmRlY29kZShtZXNzYWdlcy5MaW5lYXJpemVyVXBkYXRlLCBkYXRhLnZhbHVlKQogICAgICBjb25zdCBzZXEgPSBjLmRlY29kZShtZXNzYWdlcy5MaW5lYXJpemVyS2V5LCBkYXRhLmtleSkKICAgICAgdXBkYXRlLnNlcSA9IHNlcQogICAgICB1cGRhdGVzLnB1c2godXBkYXRlKQogICAgfQoKICAgIHJldHVybiB1cGRhdGVzCiAgfQoKICBjbGVhclVwZGF0ZXMoKSB7CiAgICBpZiAodGhpcy50eCA9PT0gbnVsbCkgdGhpcy50eCA9IHRoaXMuY29yZS5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKCiAgICB0aGlzLnR4LmRlbGV0ZUxvY2FsUmFuZ2UoR1RFLCBMVCkKICB9CgogIGRlbGV0ZVVwZGF0ZSh1cGRhdGUpIHsKICAgIGlmICh0aGlzLnR4ID09PSBudWxsKSB0aGlzLnR4ID0gdGhpcy5jb3JlLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQoKICAgIHRoaXMudHguZGVsZXRlTG9jYWwoYy5lbmNvZGUobWVzc2FnZXMuTGluZWFyaXplcktleSwgdXBkYXRlLnNlcSkpCiAgfQoKICBpbnNlcnRVcGRhdGUodXBkYXRlKSB7CiAgICBpZiAodGhpcy50eCA9PT0gbnVsbCkgdGhpcy50eCA9IHRoaXMuY29yZS5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKCiAgICB0aGlzLnR4LnB1dExvY2FsKAogICAgICBjLmVuY29kZShtZXNzYWdlcy5MaW5lYXJpemVyS2V5LCB1cGRhdGUuc2VxKSwKICAgICAgYy5lbmNvZGUobWVzc2FnZXMuTGluZWFyaXplclVwZGF0ZSwgdXBkYXRlKQogICAgKQogIH0KCiAgZmx1c2goKSB7CiAgICBpZiAoIXRoaXMudHgpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQoKICAgIGNvbnN0IGZsdXNoaW5nID0gdGhpcy50eC5mbHVzaCgpCiAgICB0aGlzLnR4ID0gbnVsbAogICAgcmV0dXJuIGZsdXNoaW5nCiAgfQp9CmNvbnN0IHNjaGVtYSA9IHJlcXVpcmUoJy4uL2VuY29kaW5nL3NwZWMvYXV0b2Jhc2UnKQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgV2FrZXVwOiBzY2hlbWEucmVzb2x2ZVN0cnVjdCgnQGF1dG9iYXNlL3dha2V1cCcpLAogIENsb2NrOiBzY2hlbWEucmVzb2x2ZVN0cnVjdCgnQGF1dG9iYXNlL2Nsb2NrJyksCiAgQ2hlY2tvdXQ6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvY2hlY2tvdXQnKSwKICBCb290UmVjb3JkOiBzY2hlbWEucmVzb2x2ZVN0cnVjdCgnQGF1dG9iYXNlL2Jvb3QtcmVjb3JkJyksCiAgT3Bsb2dNZXNzYWdlOiBzY2hlbWEucmVzb2x2ZVN0cnVjdCgnQGF1dG9iYXNlL29wbG9nLW1lc3NhZ2UnKSwKICBDaGVja3BvaW50OiBzY2hlbWEucmVzb2x2ZVN0cnVjdCgnQGF1dG9iYXNlL2NoZWNrcG9pbnQnKSwKICBJbmZvOiBzY2hlbWEucmVzb2x2ZVN0cnVjdCgnQGF1dG9iYXNlL2luZm8nKSwKICBNZW1iZXI6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvbWVtYmVyJyksCiAgTWFuaWZlc3REYXRhOiBzY2hlbWEucmVzb2x2ZVN0cnVjdCgnQGF1dG9iYXNlL21hbmlmZXN0LWRhdGEnKSwKICBMSU5FQVJJWkVSX1BSRUZJWDogMSwKICBMaW5lYXJpemVyS2V5OiBzY2hlbWEucmVzb2x2ZVN0cnVjdCgnQGF1dG9iYXNlL2xpbmVhcml6ZXIta2V5JyksCiAgTGluZWFyaXplclVwZGF0ZTogc2NoZW1hLnJlc29sdmVTdHJ1Y3QoJ0BhdXRvYmFzZS9saW5lYXJpemVyLXVwZGF0ZScpLAogIEVuY3J5cHRpb25EZXNjcmlwdG9yOiBzY2hlbWEucmVzb2x2ZVN0cnVjdCgnQGF1dG9iYXNlL2VuY3J5cHRpb24tZGVzY3JpcHRvcicpCn0KY29uc3QgREVGQVVMVF9TSVpFID0gMzIKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgTm9kZUJ1ZmZlciB7CiAgY29uc3RydWN0b3Iob2Zmc2V0LCBod20pIHsKICAgIHRoaXMuaHdtID0gaHdtIHx8IERFRkFVTFRfU0laRQogICAgdGhpcy5kZWZhdWx0SHdtID0gdGhpcy5od20KICAgIHRoaXMubWFzayA9IHRoaXMuaHdtIC0gMQogICAgdGhpcy50b3AgPSAwCiAgICB0aGlzLmJ0bSA9IDAKICAgIHRoaXMuYnVmZmVyID0gbmV3IEFycmF5KHRoaXMuaHdtKQogICAgdGhpcy5vZmZzZXQgPSBvZmZzZXQgfHwgMAogICAgdGhpcy5sZW5ndGggPSB0aGlzLm9mZnNldAogIH0KCiAgZ2V0IHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5sZW5ndGggLSB0aGlzLm9mZnNldAogIH0KCiAgaXNFbXB0eSgpIHsKICAgIHJldHVybiB0aGlzLmxlbmd0aCA9PT0gdGhpcy5vZmZzZXQKICB9CgogIGlzRnVsbCgpIHsKICAgIHJldHVybiB0aGlzLnNpemUgPT09IHRoaXMuYnVmZmVyLmxlbmd0aAogIH0KCiAgZ3JvdygpIHsKICAgIHRoaXMuaHdtIDw8PSAxCgogICAgY29uc3Qgc2l6ZSA9IHRoaXMuc2l6ZQogICAgY29uc3QgYnVmZmVyID0gbmV3IEFycmF5KHRoaXMuaHdtKQogICAgY29uc3QgbWFzayA9IHRoaXMuaHdtIC0gMQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7CiAgICAgIGJ1ZmZlcltpXSA9IHRoaXMuYnVmZmVyWyh0aGlzLmJ0bSArIGkpICYgdGhpcy5tYXNrXQogICAgfQoKICAgIHRoaXMubWFzayA9IG1hc2sKICAgIHRoaXMudG9wID0gc2l6ZQogICAgdGhpcy5idG0gPSAwCiAgICB0aGlzLmJ1ZmZlciA9IGJ1ZmZlcgogIH0KCiAgcHVzaChkYXRhKSB7CiAgICBpZiAodGhpcy5pc0Z1bGwoKSkgdGhpcy5ncm93KCkKCiAgICB0aGlzLmJ1ZmZlclt0aGlzLnRvcF0gPSBkYXRhCiAgICB0aGlzLnRvcCA9ICh0aGlzLnRvcCArIDEpICYgdGhpcy5tYXNrCgogICAgcmV0dXJuIHRoaXMubGVuZ3RoKysKICB9CgogIHNoaWZ0KCkgewogICAgaWYgKHRoaXMuaXNFbXB0eSgpKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IGxhc3QgPSB0aGlzLmJ1ZmZlclt0aGlzLmJ0bV0KCiAgICB0aGlzLmJ1ZmZlclt0aGlzLmJ0bV0gPSB1bmRlZmluZWQKICAgIHRoaXMuYnRtID0gKHRoaXMuYnRtICsgMSkgJiB0aGlzLm1hc2sKICAgIHRoaXMub2Zmc2V0KysKCiAgICAvLyByZXNldCBvbiBlbXB0eQogICAgaWYgKHRoaXMuaXNFbXB0eSgpICYmIHRoaXMuaHdtICE9PSB0aGlzLmRlZmF1bHRId20pIHsKICAgICAgdGhpcy5idWZmZXIgPSBuZXcgQXJyYXkodGhpcy5kZWZhdWx0SHdtKQogICAgICB0aGlzLmh3bSA9IHRoaXMuYnVmZmVyLmxlbmd0aAogICAgICB0aGlzLm1hc2sgPSB0aGlzLmh3bSAtIDEKICAgICAgdGhpcy50b3AgPSB0aGlzLmJ0bSA9IDAKICAgIH0KCiAgICByZXR1cm4gbGFzdAogIH0KCiAgZ2V0KHNlcSkgewogICAgaWYgKHNlcSA8IHRoaXMub2Zmc2V0IHx8IHNlcSA+PSB0aGlzLmxlbmd0aCkgcmV0dXJuIG51bGwKICAgIHJldHVybiB0aGlzLmJ1ZmZlclsodGhpcy5idG0gKyAoc2VxIC0gdGhpcy5vZmZzZXQpKSAmIHRoaXMubWFza10KICB9Cn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgSHlwZXJjb3JlID0gcmVxdWlyZSgnaHlwZXJjb3JlJykKCmNvbnN0IG1lc3NhZ2VzID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCgpjb25zdCBERUZBVUxUX01BTklGRVNUX1ZFUlNJT04gPSAxCmNvbnN0IElOREVYX1ZFUlNJT04gPSAxCmNvbnN0IE1BWF9UUkFDRV9QRVJfVklFVyA9IDI1NgoKY29uc3QgRU1QVFkgPSBiNGEuYWxsb2MoMCkKCmNvbnN0IFtOU19TSUdORVJfTkFNRVNQQUNFXSA9IGNyeXB0by5uYW1lc3BhY2UoJ2F1dG9iYXNlJywgMSkKCmNsYXNzIFZpZXdDb3JlIHsKICBjb25zdHJ1Y3RvcihuYW1lLCBjb3JlLCBiYXNlKSB7CiAgICB0aGlzLm5hbWUgPSBuYW1lCiAgICB0aGlzLmNvcmUgPSBudWxsCiAgICB0aGlzLmJhdGNoID0gbnVsbAogICAgdGhpcy5hdG9taWNCYXRjaCA9IG51bGwKICAgIHRoaXMudHJhY2VyID0gbmV3IFRyYWNlcigpCgogICAgdGhpcy5taWdyYXRlZChiYXNlLCBjb3JlKQogIH0KCiAgZ2V0Q29yZSgpIHsKICAgIHJldHVybiB0aGlzLmF0b21pY0JhdGNoIHx8IHRoaXMuYmF0Y2ggfHwgdGhpcy5jb3JlCiAgfQoKICBtaWdyYXRlZChiYXNlLCBjb3JlKSB7CiAgICAvLyBUT0RPOiBjbG9zZSBvbGQgY29yZSBpZiBwcmVzZW50LCBmb3Igbm93IHdlIGp1c3QgY2xvc2Ugd2hlbiB0aGUgYXV0b2Jhc2UgaXMgY2xvc2VkIGluZGlyZWN0bHkKICAgIC8vIGF0bSBpdHMgdW5zYWZlIHRvIGRvIGFzIG1vdmVUbyBoYXMgYSBidWcgZHVlIHRvIGEgbWlzc2luZyByZWFkIGxvY2sgaW4gaGMKICAgIHRoaXMuY29yZSA9IGNvcmUKCiAgICBpZiAodGhpcy5uYW1lID09PSAnX3N5c3RlbScpIHsKICAgICAgY29uc3QgZmYgPSBiYXNlLl9xdWV1ZUZhc3RGb3J3YXJkLmJpbmQoYmFzZSkKICAgICAgdGhpcy5jb3JlLm9uKCdhcHBlbmQnLCBmZikKICAgICAgdGhpcy5jb3JlLnJlYWR5KCkudGhlbihmZiwgZmYpCiAgICB9CiAgfQoKICBhc3luYyBtYXRjaGVzS2V5KGtleSkgewogICAgaWYgKCF0aGlzLmNvcmUub3BlbmVkKSBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQogICAgcmV0dXJuIGI0YS5lcXVhbHModGhpcy5jb3JlLmtleSwga2V5KQogIH0KCiAgYXN5bmMgbWF0Y2hlc05hbWVzcGFjZSh0YXJnZXQpIHsKICAgIGlmICghdGhpcy5jb3JlLm9wZW5lZCkgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKCiAgICBpZiAodGhpcy5jb3JlLm1hbmlmZXN0ICYmIHRoaXMuY29yZS5tYW5pZmVzdC5zaWduZXJzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgbnMgPSB0aGlzLmNvcmUubWFuaWZlc3Quc2lnbmVyc1swXS5uYW1lc3BhY2UKICAgICAgaWYgKGI0YS5lcXVhbHMobnMsIHRhcmdldCkpIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBhc3luYyBjb21taXQoYXRvbSwgbGVuZ3RoLCBzaWduYXR1cmUpIHsKICAgIC8vIFRPRE86IGlzIHRoaXMgaG93IGl0cyBzdXBwb3NlZCBiZSBkb25lIGF0b21pYyB3aXNlPwogICAgYXdhaXQgdGhpcy5jb3JlLmNvbW1pdCh0aGlzLl9nZXRBdG9taWNCYXRjaChhdG9tKSwgeyBsZW5ndGgsIHNpZ25hdHVyZSB9KQogIH0KCiAgYXN5bmMgcmVsZWFzZSgpIHsKICAgIGlmICghdGhpcy5hdG9taWNCYXRjaCkgcmV0dXJuCiAgICBhd2FpdCB0aGlzLmF0b21pY0JhdGNoLnJlYWR5KCkKICAgIGNvbnN0IHNlc3Npb25zID0gdGhpcy5hdG9taWNCYXRjaC5zdGF0ZS5zZXNzaW9ucwogICAgZm9yIChsZXQgaSA9IHNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGlmICghc2Vzc2lvbnNbaV0pIGJyZWFrIC8vIGNsb3NlZCBiZWZvcmUgdXMKICAgICAgYXdhaXQgc2Vzc2lvbnNbaV0uY2xvc2UoKQogICAgfQogICAgYXdhaXQgdGhpcy5hdG9taWNCYXRjaC5jbG9zZSgpCiAgICB0aGlzLmF0b21pY0JhdGNoID0gbnVsbAogIH0KCiAgX2dldEF0b21pY0JhdGNoKGF0b20pIHsKICAgIGlmICh0aGlzLmF0b21pY0JhdGNoID09PSBudWxsKSB7CiAgICAgIHRoaXMuYXRvbWljQmF0Y2ggPSB0aGlzLmJhdGNoLnNlc3Npb24oeyBhdG9tLCB3cml0YWJsZTogdHJ1ZSB9KQogICAgfQoKICAgIHJldHVybiB0aGlzLmF0b21pY0JhdGNoCiAgfQoKICBhc3luYyBjYXRjaHVwKGF0b20sIGxlbmd0aCkgewogICAgYXdhaXQgdGhpcy5yZWxlYXNlKCkKICAgIGNvbnN0IGJhdGNoID0gdGhpcy5fZ2V0QXRvbWljQmF0Y2goYXRvbSkKICAgIGF3YWl0IGJhdGNoLnJlYWR5KCkKICAgIGF3YWl0IGJhdGNoLnN0YXRlLmNhdGNodXAobGVuZ3RoKQogIH0KCiAgY3JlYXRlU2Vzc2lvbihhdG9tLCB2YWx1ZUVuY29kaW5nKSB7CiAgICBpZiAodGhpcy5iYXRjaCA9PT0gbnVsbCkgewogICAgICB0aGlzLmJhdGNoID0gdGhpcy5jb3JlLnNlc3Npb24oeyBuYW1lOiAnYmF0Y2gnLCB3cml0YWJsZTogdHJ1ZSB9KQogICAgfQoKICAgIGNvbnN0IHMgPSBhdG9tCiAgICAgID8gdGhpcy5fZ2V0QXRvbWljQmF0Y2goYXRvbSkuc2Vzc2lvbih7CiAgICAgICAgICB2YWx1ZUVuY29kaW5nLAogICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICBvbnNlcTogdGhpcy50cmFjZXIub25zZXEuYmluZCh0aGlzLnRyYWNlcikKICAgICAgICB9KQogICAgICA6IHRoaXMuYmF0Y2guc2Vzc2lvbih7IHZhbHVlRW5jb2RpbmcsIHdyaXRhYmxlOiBmYWxzZSB9KQoKICAgIHJldHVybiBzCiAgfQp9CgpjbGFzcyBUcmFjZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5lbmFibGVkID0gZmFsc2UKICAgIHRoaXMuc2VlbiA9IG5ldyBTZXQoKQogIH0KCiAgc3RhcnQoKSB7CiAgICB0aGlzLmVuYWJsZWQgPSB0cnVlCiAgICB0aGlzLnNlZW4uY2xlYXIoKQogIH0KCiAgZW5kKCkgewogICAgdGhpcy5lbmFibGVkID0gZmFsc2UKICAgIHJldHVybiBbLi4udGhpcy5zZWVuLnZhbHVlcygpXQogIH0KCiAgb25zZXEoc2VxLCBjb3JlKSB7CiAgICBpZiAoIXRoaXMuZW5hYmxlZCkgcmV0dXJuCiAgICBpZiAodGhpcy5zZWVuLnNpemUgPj0gTUFYX1RSQUNFX1BFUl9WSUVXKSByZXR1cm4KICAgIGlmIChzZXEgPj0gY29yZS5zaWduZWRMZW5ndGgpIHJldHVybgoKICAgIHRoaXMuc2Vlbi5hZGQoc2VxKQogIH0KfQoKY2xhc3MgQXV0b1N0b3JlIHsKICBjb25zdHJ1Y3RvcihiYXNlLCBieU5hbWUpIHsKICAgIHRoaXMuYmFzZSA9IGJhc2UKICAgIHRoaXMuc3RvcmUgPSBiYXNlLnN0b3JlCiAgICB0aGlzLmJ5TmFtZSA9IGJ5TmFtZSB8fCBuZXcgTWFwKCkKICAgIHRoaXMub3BlbmVkID0gW10KICAgIHRoaXMuYXRvbSA9IG51bGwKICAgIHRoaXMubG9jYWwgPSBudWxsCiAgfQoKICBhc3luYyBjbG9zZSgpIHsKICAgIGlmICh0aGlzLmxvY2FsKSBhd2FpdCB0aGlzLmxvY2FsLmNsb3NlKCkKICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLmJ5TmFtZS52YWx1ZXMoKSkgewogICAgICBhd2FpdCB2LnJlbGVhc2UoKQogICAgfQogICAgaWYgKHRoaXMuYXRvbSkgcmV0dXJuCiAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy5ieU5hbWUudmFsdWVzKCkpIHsKICAgICAgaWYgKHYuY29yZSkgYXdhaXQgdi5jb3JlLmNsb3NlKCkKICAgICAgaWYgKHYuYmF0Y2gpIGF3YWl0IHYuYmF0Y2guY2xvc2UoKQogICAgfQogIH0KCiAgYXN5bmMgZXhwb3J0KCkgewogICAgY29uc3Qgdmlld3MgPSBbXQoKICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiB0aGlzLmJ5TmFtZSkgewogICAgICBjb25zdCBjb3JlID0gYXdhaXQgdGhpcy5zdG9yZS5zdG9yYWdlLmV4cG9ydCh2YWx1ZS5jb3JlLmRpc2NvdmVyeUtleSwgeyBiYXRjaGVzOiB0cnVlIH0pCiAgICAgIHZpZXdzLnB1c2goeyBuYW1lLCBjb3JlIH0pCiAgICB9CgogICAgcmV0dXJuIHZpZXdzCiAgfQoKICBhdG9taXplKCkgewogICAgY29uc3Qgc3RvcmUgPSBuZXcgQXV0b1N0b3JlKHRoaXMuYmFzZSwgdGhpcy5ieU5hbWUpCiAgICBzdG9yZS5hdG9tID0gdGhpcy5zdG9yZS5zdG9yYWdlLmNyZWF0ZUF0b20oKQogICAgcmV0dXJuIHN0b3JlCiAgfQoKICBhc3luYyB1cGRhdGVMb2NhbCgpIHsKICAgIGlmICghdGhpcy5sb2NhbCkgcmV0dXJuCiAgICBhd2FpdCB0aGlzLmxvY2FsLmNsb3NlKCkKICAgIHRoaXMubG9jYWwgPSBudWxsCiAgfQoKICBmbHVzaCgpIHsKICAgIHJldHVybiB0aGlzLmF0b20gPyB0aGlzLmF0b20uZmx1c2goKSA6IFByb21pc2UucmVzb2x2ZSgpCiAgfQoKICBnZXQob3B0cywgbW9yZU9wdHMpIHsKICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IG5hbWU6IG9wdHMgfQogICAgaWYgKG1vcmVPcHRzKSBvcHRzID0geyAuLi5vcHRzLCAuLi5tb3JlT3B0cyB9CgogICAgY29uc3QgeyBuYW1lLCB2YWx1ZUVuY29kaW5nID0gbnVsbCB9ID0gb3B0cwoKICAgIGlmICghbmFtZSkgdGhyb3cgbmV3IEVycm9yKCduYW1lIGlzIHJlcXVpcmVkJykKICAgIHJldHVybiB0aGlzLmdldFZpZXdCeU5hbWUobmFtZSkuY3JlYXRlU2Vzc2lvbih0aGlzLmF0b20sIHZhbHVlRW5jb2RpbmcpCiAgfQoKICBnZXRWaWV3QnlOYW1lKG5hbWUpIHsKICAgIGxldCB2aWV3ID0gdGhpcy5ieU5hbWUuZ2V0KG5hbWUpCgogICAgaWYgKCF2aWV3KSB7CiAgICAgIGNvbnN0IHByZWxvYWQgPSB0aGlzLl9wcmVsb2FkKG5hbWUpCiAgICAgIGNvbnN0IGNvcmUgPSB0aGlzLmJhc2Uuc3RvcmUuZ2V0KHsgcHJlbG9hZCB9KQogICAgICB2aWV3ID0gbmV3IFZpZXdDb3JlKG5hbWUsIGNvcmUsIHRoaXMuYmFzZSkKICAgICAgdGhpcy5ieU5hbWUuc2V0KG5hbWUsIHZpZXcpCiAgICB9CgogICAgaWYgKHRoaXMub3BlbmVkLmluZGV4T2YodmlldykgPT09IC0xKSB7CiAgICAgIHRoaXMub3BlbmVkLnB1c2godmlldykKICAgIH0KCiAgICByZXR1cm4gdmlldwogIH0KCiAgZ2V0TG9jYWwoKSB7CiAgICBpZiAodGhpcy5sb2NhbCAhPT0gbnVsbCkgcmV0dXJuIHRoaXMubG9jYWwKCiAgICB0aGlzLmxvY2FsID0gdGhpcy5iYXNlLmxvY2FsLnNlc3Npb24oewogICAgICBhdG9tOiB0aGlzLmF0b20sCiAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZSwKICAgICAgZW5jcnlwdGlvbjogdGhpcy5iYXNlLmdldFdyaXRlckVuY3J5cHRpb24odGhpcy5iYXNlLmxvY2FsLmtleSksCiAgICAgIGFjdGl2ZTogZmFsc2UKICAgIH0pCgogICAgcmV0dXJuIHRoaXMubG9jYWwKICB9CgogIGdldFZpZXdzKCkgewogICAgcmV0dXJuIFsuLi50aGlzLmJ5TmFtZS52YWx1ZXMoKV0KICB9CgogIGdldFZpZXdDb3VudCgpIHsKICAgIHJldHVybiB0aGlzLmJ5TmFtZS5zaXplCiAgfQoKICBnZXRTeXN0ZW1WaWV3KCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Vmlld0J5TmFtZSgnX3N5c3RlbScpCiAgfQoKICBnZXRTeXN0ZW1Db3JlKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3lzdGVtVmlldygpLmNvcmUKICB9CgogIGdldEVuY3J5cHRpb24obmFtZSkgewogICAgaWYgKCF0aGlzLmJhc2UuZW5jcnlwdGlvbktleSkgcmV0dXJuIG51bGwKICAgIGlmIChuYW1lID09PSAnX2VuY3J5cHRpb24nKSByZXR1cm4gbnVsbAoKICAgIHJldHVybiB0aGlzLmJhc2UuZW5jcnlwdGlvbi5nZXRWaWV3RW5jcnlwdGlvbihuYW1lKQogIH0KCiAgYXN5bmMgZ2V0SW5kZXhlck1hbmlmZXN0cyhlbnRyaWVzKSB7CiAgICBjb25zdCBtYW5pZmVzdHMgPSBbXQogICAgZm9yIChjb25zdCB7IGtleSB9IG9mIGVudHJpZXMpIHsKICAgICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsga2V5LCBhY3RpdmU6IGZhbHNlIH0pCiAgICAgIGF3YWl0IGNvcmUucmVhZHkoKQogICAgICBpZiAoIWNvcmUubWFuaWZlc3QpIGNvbnRpbnVlIC8vIGRhbmdlciBidXQgb25seSBmb3IgYm9vdHN0cmFwcGluZy4uLgogICAgICBtYW5pZmVzdHMucHVzaChjb3JlLm1hbmlmZXN0KQogICAgICBhd2FpdCBjb3JlLmNsb3NlKCkKICAgIH0KICAgIHJldHVybiBtYW5pZmVzdHMKICB9CgogIGdldFZpZXdDb3JlKGluZGV4ZXJNYW5pZmVzdHMsIG5hbWUsIHByb2xvZ3VlLCBtYW5pZmVzdFZlcnNpb24sIGVudHJvcHksIGxpbmtlZCwgbWFuaWZlc3REYXRhKSB7CiAgICBjb25zdCBtYW5pZmVzdCA9IHRoaXMuX2NyZWF0ZU1hbmlmZXN0KAogICAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgICBuYW1lLAogICAgICBwcm9sb2d1ZSwKICAgICAgbWFuaWZlc3RWZXJzaW9uLAogICAgICBlbnRyb3B5LAogICAgICBsaW5rZWQsCiAgICAgIG1hbmlmZXN0RGF0YQogICAgKQoKICAgIHJldHVybiB0aGlzLmJhc2Uuc3RvcmUuZ2V0KHsKICAgICAgbWFuaWZlc3QsCiAgICAgIGV4Y2x1c2l2ZTogZmFsc2UsCiAgICAgIGVuY3J5cHRpb246IHRoaXMuZ2V0RW5jcnlwdGlvbihuYW1lKQogICAgfSkKICB9CgogIGxpc3RWaWV3cygpIHsKICAgIGNvbnN0IHZpZXdzID0gW10KICAgIGZvciAoY29uc3QgW25hbWUsIHJlZl0gb2YgdGhpcy5ieU5hbWUpIHsKICAgICAgY29uc3QgY29yZSA9IHJlZi5iYXRjaCB8fCByZWYuY29yZQogICAgICB2aWV3cy5wdXNoKHsgbmFtZSwga2V5OiBjb3JlLmtleSwgbGVuZ3RoOiBjb3JlLmxlbmd0aCwgc2lnbmVkTGVuZ3RoOiBjb3JlLnNpZ25lZExlbmd0aCB9KQogICAgfQogICAgcmV0dXJuIHZpZXdzCiAgfQoKICBjcmVhdGVBbmNob3JDb3JlKHByb2xvZ3VlLCBtYW5pZmVzdERhdGEpIHsKICAgIGNvbnN0IG1hbmlmZXN0ID0gewogICAgICB2ZXJzaW9uOiAyLAogICAgICBoYXNoOiAnYmxha2UyYicsCiAgICAgIHByb2xvZ3VlLAogICAgICBhbGxvd1BhdGNoOiBmYWxzZSwKICAgICAgcXVvcnVtOiAwLAogICAgICBzaWduZXJzOiBbXSwKICAgICAgdXNlckRhdGE6IG1hbmlmZXN0RGF0YSwKICAgICAgbGlua2VkOiBudWxsCiAgICB9CgogICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsKICAgICAgbWFuaWZlc3QsCiAgICAgIGFjdGl2ZTogZmFsc2UKICAgIH0pCgogICAgcmV0dXJuIGNvcmUKICB9CgogIGFzeW5jIGNyZWF0ZVZpZXcoCiAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgbmFtZSwKICAgIHByb2xvZ3VlLAogICAgbWFuaWZlc3RWZXJzaW9uLAogICAgZW50cm9weSwKICAgIGxpbmtlZCwKICAgIG1hbmlmZXN0RGF0YQogICkgewogICAgY29uc3QgbWFuaWZlc3QgPSB0aGlzLl9jcmVhdGVNYW5pZmVzdCgKICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgbmFtZSwKICAgICAgcHJvbG9ndWUsCiAgICAgIG1hbmlmZXN0VmVyc2lvbiwKICAgICAgZW50cm9weSwKICAgICAgbGlua2VkLAogICAgICBtYW5pZmVzdERhdGEKICAgICkKCiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoewogICAgICBrZXk6IEh5cGVyY29yZS5rZXkobWFuaWZlc3QpLAogICAgICBtYW5pZmVzdCwKICAgICAgYWN0aXZlOiBmYWxzZQogICAgfSkKCiAgICBhd2FpdCBjb3JlLnJlYWR5KCkKICAgIGNvbnN0IGtleSA9IGNvcmUua2V5CgogICAgYXdhaXQgY29yZS5jbG9zZSgpCiAgICByZXR1cm4ga2V5CiAgfQoKICBhc3luYyBfcHJlbG9hZChuYW1lKSB7CiAgICBhd2FpdCBQcm9taXNlLnJlc29sdmUoKQoKICAgIGlmICghdGhpcy5iYXNlLm9wZW5pbmcpIHRocm93IG5ldyBFcnJvcignQXV0b2Jhc2UgZmFpbGVkIHRvIG9wZW4nKQogICAgYXdhaXQgdGhpcy5iYXNlLl9wcmVvcGVuCgogICAgY29uc3QgYm9vdCA9IChhd2FpdCB0aGlzLmJhc2UuX2dldFN5c3RlbUluZm8oKSkgfHwgewogICAgICBrZXk6IHRoaXMuZ2V0Qm9vdHN0cmFwU3lzdGVtS2V5KCksCiAgICAgIGluZGV4ZXJzOiBbXSwKICAgICAgdmlld3M6IFtdLAogICAgICBlbnRyb3B5OiBudWxsCiAgICB9CiAgICBjb25zdCBpbmRleGVyTWFuaWZlc3RzID0gYXdhaXQgdGhpcy5nZXRJbmRleGVyTWFuaWZlc3RzKGJvb3QuaW5kZXhlcnMpCgogICAgLy8gbm8gc3lzdGVtLCBldmVyeXRoaW5nIGlzIGZyZXNoCiAgICBpZiAoYm9vdC5pbmRleGVycy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHRoaXMuX2ZyZXNoQ29yZVByZWxvYWQoaW5kZXhlck1hbmlmZXN0cywgbmFtZSwgYm9vdC5lbnRyb3B5KQogICAgfQoKICAgIC8vIGFza2luZyBmb3IgdGhlIHN5c3RlbSwganVzdCByZXR1cm4gaXQsIGVhc3kKICAgIGlmIChuYW1lID09PSAnX3N5c3RlbScpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBrZXk6IGJvb3Qua2V5LAogICAgICAgIGV4Y2x1c2l2ZTogZmFsc2UsCiAgICAgICAgZW5jcnlwdGlvbjogdGhpcy5nZXRFbmNyeXB0aW9uKG5hbWUpCiAgICAgIH0KICAgIH0KCiAgICBpZiAobmFtZSA9PT0gJ19lbmNyeXB0aW9uJykgewogICAgICBjb25zdCBjb3JlID0gdGhpcy5nZXRTeXN0ZW1Db3JlKCkKICAgICAgYXdhaXQgY29yZS5yZWFkeSgpCgogICAgICBpZiAoIWNvcmUubWFuaWZlc3QubGlua2VkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ZyZXNoQ29yZVByZWxvYWQoaW5kZXhlck1hbmlmZXN0cywgbmFtZSwgYm9vdC5lbnRyb3B5KQogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGtleTogY29yZS5tYW5pZmVzdC5saW5rZWRbMF0sCiAgICAgICAgZXhjbHVzaXZlOiBmYWxzZSwKICAgICAgICBlbmNyeXB0aW9uOiBudWxsCiAgICAgIH0KICAgIH0KCiAgICAvLyBpbmZlciB3aGljaCB2aWV3CiAgICBjb25zdCB2ID0gYXdhaXQgdGhpcy5maW5kVmlld0J5TmFtZShpbmRleGVyTWFuaWZlc3RzLCBib290LnZpZXdzLCBuYW1lLCBib290LmVudHJvcHkpCgogICAgLy8gbmV3IHZpZXcsIGZyZXNoCiAgICBpZiAodiA9PT0gbnVsbCkgewogICAgICByZXR1cm4gdGhpcy5fZnJlc2hDb3JlUHJlbG9hZChpbmRleGVyTWFuaWZlc3RzLCBuYW1lLCBib290LmVudHJvcHkpCiAgICB9CgogICAgcmV0dXJuIHsKICAgICAga2V5OiB2LmtleSwKICAgICAgZXhjbHVzaXZlOiBmYWxzZSwKICAgICAgZW5jcnlwdGlvbjogdGhpcy5nZXRFbmNyeXB0aW9uKG5hbWUpCiAgICB9CiAgfQoKICBfZnJlc2hDb3JlUHJlbG9hZChpbmRleGVyTWFuaWZlc3RzLCBuYW1lLCBlbnRyb3B5KSB7CiAgICBpZiAobmFtZSA9PT0gJ19zeXN0ZW0nKSByZXR1cm4gdGhpcy5fZnJlc2hTeXN0ZW1QcmVsb2FkKGluZGV4ZXJNYW5pZmVzdHMsIGVudHJvcHkpCgogICAgcmV0dXJuIHsKICAgICAgbWFuaWZlc3Q6IHRoaXMuX2NyZWF0ZU1hbmlmZXN0KAogICAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgICAgbmFtZSwKICAgICAgICBudWxsLAogICAgICAgIERFRkFVTFRfTUFOSUZFU1RfVkVSU0lPTiwKICAgICAgICBlbnRyb3B5LAogICAgICAgIFtdLAogICAgICAgIG51bGwKICAgICAgKSwKICAgICAgZXhjbHVzaXZlOiB0cnVlLAogICAgICBlbmNyeXB0aW9uOiB0aGlzLmdldEVuY3J5cHRpb24obmFtZSkKICAgIH0KICB9CgogIF9mcmVzaFN5c3RlbVByZWxvYWQoaW5kZXhlck1hbmlmZXN0cywgZW50cm9weSkgewogICAgcmV0dXJuIHsKICAgICAgbWFuaWZlc3Q6IHRoaXMuX2NyZWF0ZVN5c3RlbU1hbmlmZXN0KAogICAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgICAgbnVsbCwKICAgICAgICBERUZBVUxUX01BTklGRVNUX1ZFUlNJT04sCiAgICAgICAgZW50cm9weSwKICAgICAgICBudWxsCiAgICAgICksCiAgICAgIGV4Y2x1c2l2ZTogdHJ1ZSwKICAgICAgZW5jcnlwdGlvbjogdGhpcy5nZXRFbmNyeXB0aW9uKCdfc3lzdGVtJykKICAgIH0KICB9CgogIF9kZXJpdmVTdGF0aWNIYXNoKG5hbWUpIHsKICAgIC8vIGtleSBkb2VzbnQgbWF0dGVyLi4uCiAgICByZXR1cm4gY3J5cHRvLmhhc2goW3RoaXMuYmFzZS5rZXksIGI0YS5mcm9tKG5hbWUpXSkKICB9CgogIF9kZXJpdmVOYW1lc3BhY2UobmFtZSwgZW50cm9weSkgewogICAgY29uc3QgZW5jcnlwdGlvbklkID0gY3J5cHRvLmhhc2godGhpcy5iYXNlLmVuY3J5cHRpb25LZXkgfHwgRU1QVFkpCiAgICBjb25zdCB2ZXJzaW9uID0gYy5lbmNvZGUoYy51aW50LCBJTkRFWF9WRVJTSU9OKQogICAgY29uc3QgYm9vdHN0cmFwID0gdGhpcy5iYXNlLmtleQoKICAgIHJldHVybiBjcnlwdG8uaGFzaChbCiAgICAgIE5TX1NJR05FUl9OQU1FU1BBQ0UsCiAgICAgIHZlcnNpb24sCiAgICAgIGJvb3RzdHJhcCwKICAgICAgZW5jcnlwdGlvbklkLAogICAgICBlbnRyb3B5LAogICAgICBiNGEuZnJvbShuYW1lKQogICAgXSkKICB9CgogIGFzeW5jIF9nZXRDb3JlTWFuaWZlc3Qoa2V5KSB7CiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoeyBrZXksIGFjdGl2ZTogZmFsc2UgfSkKICAgIGF3YWl0IGNvcmUucmVhZHkoKQogICAgY29uc3QgbWFuaWZlc3QgPSBjb3JlLm1hbmlmZXN0CiAgICBhd2FpdCBjb3JlLmNsb3NlKCkKICAgIHJldHVybiBtYW5pZmVzdAogIH0KCiAgZ2V0Qm9vdHN0cmFwU3lzdGVtS2V5KCkgewogICAgcmV0dXJuIEh5cGVyY29yZS5rZXkodGhpcy5fY3JlYXRlU3lzdGVtTWFuaWZlc3QoW10sIG51bGwsIERFRkFVTFRfTUFOSUZFU1RfVkVSU0lPTiwgbnVsbCkpCiAgfQoKICBhc3luYyBmaW5kVmlld0J5S2V5KGtleSwgaW5kZXhlcnMsIG1hbmlmZXN0VmVyc2lvbiwgZW50cm9weSkgewogICAgZm9yIChjb25zdCB2IG9mIHRoaXMuYnlOYW1lLnZhbHVlcygpKSB7CiAgICAgIGlmIChhd2FpdCB2Lm1hdGNoZXNLZXkoa2V5KSkgcmV0dXJuIHYKICAgIH0KCiAgICBjb25zdCBtYW5pZmVzdCA9IGF3YWl0IHRoaXMuX2dldENvcmVNYW5pZmVzdChrZXkpCiAgICBjb25zdCB0YXJnZXQgPSBtYW5pZmVzdCAmJiBtYW5pZmVzdC5zaWduZXJzLmxlbmd0aCA/IG1hbmlmZXN0LnNpZ25lcnNbMF0ubmFtZXNwYWNlIDogbnVsbAoKICAgIGlmICh0YXJnZXQpIHsKICAgICAgZm9yIChjb25zdCB2IG9mIHRoaXMuYnlOYW1lLnZhbHVlcygpKSB7CiAgICAgICAgaWYgKGF3YWl0IHYubWF0Y2hlc05hbWVzcGFjZSh0YXJnZXQpKSByZXR1cm4gdgogICAgICB9CiAgICB9CgogICAgY29uc3QgaW5kZXhlck1hbmlmZXN0cyA9IGF3YWl0IHRoaXMuZ2V0SW5kZXhlck1hbmlmZXN0cyhpbmRleGVycykKCiAgICBpZiAoZW50cm9weSA9PT0gbnVsbCkgewogICAgICBlbnRyb3B5ID0gaW5kZXhlck1hbmlmZXN0c1swXS5zaWduZXJzWzBdLm5hbWVzcGFjZQogICAgfQoKICAgIGlmICh0YXJnZXQpIHsKICAgICAgZm9yIChjb25zdCB2IG9mIHRoaXMuYnlOYW1lLnZhbHVlcygpKSB7CiAgICAgICAgY29uc3QgbmFtZXNwYWNlID0gdGhpcy5fZGVyaXZlTmFtZXNwYWNlKHYubmFtZSwgZW50cm9weSkKICAgICAgICBpZiAoYjRhLmVxdWFscyhuYW1lc3BhY2UsIHRhcmdldCkpIHJldHVybiB2CiAgICAgIH0KICAgIH0KCiAgICAvLyBwcm9iIHRoZSBlbXB0eSBwcm9sb2d1ZSwgd2UgZG9udCBoYXZlIG1hbmlmZXN0IGZvciB0aG9zZSBpbiBGRiBpZiBsZW49MAogICAgZm9yIChjb25zdCB2IG9mIHRoaXMuYnlOYW1lLnZhbHVlcygpKSB7CiAgICAgIGNvbnN0IG1hbmlmZXN0RGF0YSA9IHYuY29yZSA/IHYuY29yZS5tYW5pZmVzdC51c2VyRGF0YSA6IG51bGwKICAgICAgY29uc3QgbWFuaWZlc3QgPSB0aGlzLl9jcmVhdGVNYW5pZmVzdCgKICAgICAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgICAgIHYubmFtZSwKICAgICAgICBudWxsLAogICAgICAgIG1hbmlmZXN0VmVyc2lvbiwKICAgICAgICBlbnRyb3B5LAogICAgICAgIFtdLAogICAgICAgIG1hbmlmZXN0RGF0YQogICAgICApCiAgICAgIGNvbnN0IG1hbmlmZXN0S2V5ID0gSHlwZXJjb3JlLmtleShtYW5pZmVzdCkKCiAgICAgIGlmICghYjRhLmVxdWFscyhtYW5pZmVzdEtleSwga2V5KSkgY29udGludWUKCiAgICAgIC8vIHdlIGRpZG50IGhhdmUgdGhlIGNvcmUhIHRoaXMgaXMgYmVjYXVzZSBpdCBpcyBlbXB0eSwgZW5zdXJlIGl0cyBvbiBkaXNrCiAgICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7IGtleTogbWFuaWZlc3RLZXksIG1hbmlmZXN0LCBhY3RpdmU6IGZhbHNlIH0pCiAgICAgIGF3YWl0IGNvcmUucmVhZHkoKQogICAgICBhd2FpdCBjb3JlLmNsb3NlKCkKCiAgICAgIHJldHVybiB2CiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIGFzeW5jIGZpbmRWaWV3QnlOYW1lKGluZGV4ZXJNYW5pZmVzdHMsIHZpZXdzLCBuYW1lLCBlbnRyb3B5KSB7CiAgICBpZiAoaW5kZXhlck1hbmlmZXN0cy5sZW5ndGggPT09IDApIHJldHVybiBudWxsCgogICAgaWYgKGVudHJvcHkgPT09IG51bGwpIGVudHJvcHkgPSBpbmRleGVyTWFuaWZlc3RzWzBdLnNpZ25lcnNbMF0ubmFtZXNwYWNlCiAgICBjb25zdCBuYW1lc3BhY2UgPSB0aGlzLl9kZXJpdmVOYW1lc3BhY2UobmFtZSwgZW50cm9weSkKCiAgICBmb3IgKGNvbnN0IHYgb2Ygdmlld3MpIHsKICAgICAgY29uc3QgbWFuaWZlc3QgPSBhd2FpdCB0aGlzLl9nZXRDb3JlTWFuaWZlc3Qodi5rZXkpCiAgICAgIGlmIChtYW5pZmVzdC5zaWduZXJzLmxlbmd0aCA9PT0gMCkgY29udGludWUKCiAgICAgIGNvbnN0IHNpZ25lciA9IG1hbmlmZXN0LnNpZ25lcnNbMF0KCiAgICAgIGlmIChiNGEuZXF1YWxzKHNpZ25lci5uYW1lc3BhY2UsIG5hbWVzcGFjZSkpIHJldHVybiB2CiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIF9jcmVhdGVNYW5pZmVzdChpbmRleGVyTWFuaWZlc3RzLCBuYW1lLCBwcm9sb2d1ZSwgdmVyc2lvbiwgZW50cm9weSwgbGlua2VkLCBtYW5pZmVzdERhdGEpIHsKICAgIGlmICghaW5kZXhlck1hbmlmZXN0cy5sZW5ndGgpIHsKICAgICAgcHJvbG9ndWUgPSB7CiAgICAgICAgaGFzaDogdGhpcy5fZGVyaXZlU3RhdGljSGFzaChuYW1lKSwKICAgICAgICBsZW5ndGg6IDAKICAgICAgfQogICAgfSBlbHNlIGlmIChwcm9sb2d1ZSAmJiBwcm9sb2d1ZS5sZW5ndGggPT09IDApIHsKICAgICAgLy8ganVzdCBpbiBjYXNlCiAgICAgIHByb2xvZ3VlID0gbnVsbAogICAgfQoKICAgIGNvbnN0IHNpZ25lcnMgPSBbXQoKICAgIGlmIChpbmRleGVyTWFuaWZlc3RzLmxlbmd0aCAmJiBlbnRyb3B5ID09PSBudWxsKSB7CiAgICAgIGVudHJvcHkgPSBpbmRleGVyTWFuaWZlc3RzWzBdLnNpZ25lcnNbMF0ubmFtZXNwYWNlCiAgICB9CgogICAgZm9yIChjb25zdCBtYW5pZmVzdCBvZiBpbmRleGVyTWFuaWZlc3RzKSB7CiAgICAgIGNvbnN0IHNpZ25lciA9IG1hbmlmZXN0LnNpZ25lcnNbMF0KCiAgICAgIHNpZ25lcnMucHVzaCh7CiAgICAgICAgbmFtZXNwYWNlOiB0aGlzLl9kZXJpdmVOYW1lc3BhY2UobmFtZSwgZW50cm9weSksCiAgICAgICAgc2lnbmF0dXJlOiAnZWQyNTUxOScsCiAgICAgICAgcHVibGljS2V5OiBzaWduZXIucHVibGljS2V5CiAgICAgIH0pCiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbiwKICAgICAgaGFzaDogJ2JsYWtlMmInLAogICAgICBwcm9sb2d1ZSwKICAgICAgYWxsb3dQYXRjaDogdHJ1ZSwKICAgICAgcXVvcnVtOiBNYXRoLm1pbihzaWduZXJzLmxlbmd0aCwgKHNpZ25lcnMubGVuZ3RoID4+IDEpICsgMSksCiAgICAgIHNpZ25lcnMsCiAgICAgIHVzZXJEYXRhOiBtYW5pZmVzdERhdGEsCiAgICAgIGxpbmtlZDogdmVyc2lvbiA+IDEgPyBsaW5rZWQgOiBudWxsCiAgICB9CiAgfQoKICBfY3JlYXRlU3lzdGVtTWFuaWZlc3QoaW5kZXhlck1hbmlmZXN0cywgcHJvbG9ndWUsIHZlcnNpb24sIGVudHJvcHksIG1hbmlmZXN0RGF0YSkgewogICAgaWYgKHByb2xvZ3VlICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ0NhbiBvbmx5IGRlcml2ZSBmcmVzaCBzeXN0ZW0gY29yZScpCgogICAgY29uc3QgbGlua2VkID0gW10KCiAgICBpZiAodmVyc2lvbiA+IERFRkFVTFRfTUFOSUZFU1RfVkVSU0lPTikgewogICAgICBjb25zdCBlbmNNYW5pZmVzdCA9IHRoaXMuX2NyZWF0ZU1hbmlmZXN0KAogICAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgICAgJ19lbmNyeXB0aW9uJywKICAgICAgICBudWxsLAogICAgICAgIHZlcnNpb24sCiAgICAgICAgZW50cm9weSwKICAgICAgICBbXSwKICAgICAgICBtYW5pZmVzdERhdGEKICAgICAgKQogICAgICBsaW5rZWQucHVzaChIeXBlcmNvcmUua2V5KGVuY01hbmlmZXN0KSkKICAgIH0KCiAgICByZXR1cm4gdGhpcy5fY3JlYXRlTWFuaWZlc3QoCiAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgICdfc3lzdGVtJywKICAgICAgbnVsbCwKICAgICAgdmVyc2lvbiwKICAgICAgZW50cm9weSwKICAgICAgbGlua2VkLAogICAgICBtYW5pZmVzdERhdGEKICAgICkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gQXV0b1N0b3JlCmNvbnN0IEh5cGVyYmVlID0gcmVxdWlyZSgnaHlwZXJiZWUnKQpjb25zdCBTdWJFbmNvZGVyID0gcmVxdWlyZSgnc3ViLWVuY29kZXInKQpjb25zdCBSZWFkeVJlc291cmNlID0gcmVxdWlyZSgncmVhZHktcmVzb3VyY2UnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQoKY29uc3QgeyBJbmZvLCBNZW1iZXIgfSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMuanMnKQpjb25zdCB7IERFRkFVTFRfQVVUT0JBU0VfVkVSU0lPTiB9ID0gcmVxdWlyZSgnLi9jYXBzLmpzJykKCmNvbnN0IHN1YnMgPSBuZXcgU3ViRW5jb2RlcigpCgpjb25zdCBESUdFU1QgPSBzdWJzLnN1YihiNGEuZnJvbShbMF0pKQpjb25zdCBNRU1CRVJTID0gc3Vicy5zdWIoYjRhLmZyb20oWzFdKSkKCmNvbnN0IElORk9fS0VZID0gRElHRVNULmVuY29kZSgnaW5mbycpCgpjb25zdCBbR0VORVNJU19FTlRST1BZLCBOU19FTlRST1BZXSA9IGNyeXB0by5uYW1lc3BhY2UoJ2F1dG9iYXNlL2VudHJvcHknLCAyKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBTeXN0ZW1WaWV3IGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IoY29yZSwgeyBjaGVja291dCA9IDAsIGVtcHR5ID0gZmFsc2UgfSA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5jb3JlID0gY29yZQoKICAgIC8vIHNlc3Npb25zIGlzIGEgd29ya2Fyb3VuZCBmb3IgYmF0Y2hlcyBub3QgaGF2aW5nIHNlc3Npb25zIGF0bS4uLgogICAgdGhpcy5kYiA9IG5ldyBIeXBlcmJlZShjb3JlLCB7CiAgICAgIGtleUVuY29kaW5nOiAnYmluYXJ5JywKICAgICAgZXh0ZW5zaW9uOiBmYWxzZSwKICAgICAgY2hlY2tvdXQsCiAgICAgIHNlc3Npb25zOiB0eXBlb2YgY29yZS5zZXNzaW9uID09PSAnZnVuY3Rpb24nCiAgICB9KQoKICAgIHRoaXMudmVyc2lvbiA9IERFRkFVTFRfQVVUT0JBU0VfVkVSU0lPTgogICAgdGhpcy5tZW1iZXJzID0gMAogICAgdGhpcy5wZW5kaW5nSW5kZXhlcnMgPSBbXQogICAgdGhpcy5pbmRleGVycyA9IFtdCiAgICB0aGlzLmhlYWRzID0gW10KICAgIHRoaXMudmlld3MgPSBbXQogICAgdGhpcy5lbmNyeXB0aW9uTGVuZ3RoID0gMAogICAgdGhpcy5lbnRyb3B5ID0gbnVsbAoKICAgIHRoaXMuaW5kZXhlclVwZGF0ZSA9IGZhbHNlCgogICAgdGhpcy5fZW1wdHkgPSBlbXB0eQogICAgdGhpcy5fZm9yayA9IDAKICAgIHRoaXMuX2xlbmd0aCA9IDAKICAgIHRoaXMuX2NoYW5nZXMgPSBbXQogICAgdGhpcy5faW5kZXhlck1hcCA9IG5ldyBNYXAoKQogICAgdGhpcy5fY2xvY2tVcGRhdGVzID0gbmV3IE1hcCgpCiAgfQoKICBzdGF0aWMgR0VORVNJU19FTlRST1BZID0gR0VORVNJU19FTlRST1BZCgogIHN0YXRpYyBhc3luYyBnZXRJbmRleGVkSW5mbyhjb3JlLCBsZW5ndGgpIHsKICAgIGNvbnN0IHN5cyA9IG5ldyB0aGlzKGNvcmUuc2Vzc2lvbigpKQoKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCBzeXMuZ2V0SW5kZXhlZEluZm8obGVuZ3RoKQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgc3lzLmNsb3NlKCkKICAgIH0KICB9CgogIHN0YXRpYyBhc3luYyAqZmx1c2hlcyhjb3JlLCB7IHJldmVyc2UsIGx0ID0gY29yZS5sZW5ndGgsIGd0ZSA9IDAsIHdhaXQgPSB0cnVlIH0gPSB7fSkgewogICAgaWYgKGx0IDw9IDApIHJldHVybgoKICAgIC8vIGVuc3VyZSBibG9jawogICAgYXdhaXQgY29yZS5nZXQobHQgLSAxKQogICAgY29uc3Qgc3lzID0gbmV3IFN5c3RlbVZpZXcoY29yZSkKCiAgICB0cnkgewogICAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2Ygc3lzLmRiLmNyZWF0ZUhpc3RvcnlTdHJlYW0oeyBsdCwgZ3RlLCB3YWl0LCByZXZlcnNlOiB0cnVlIH0pKSB7CiAgICAgICAgaWYgKCFiNGEuZXF1YWxzKGRhdGEua2V5LCBJTkZPX0tFWSkpIGNvbnRpbnVlCiAgICAgICAgY29uc3QgaW5mbyA9IGMuZGVjb2RlKEluZm8sIGRhdGEudmFsdWUpCiAgICAgICAgeWllbGQgeyBsZW5ndGg6IGRhdGEuc2VxICsgMSwgaW5mbyB9CiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IHN5cy5jbG9zZSgpCiAgICB9CiAgfQoKICBnZXQgYm9vdHN0cmFwcGluZygpIHsKICAgIHJldHVybiB0aGlzLm1lbWJlcnMgPT09IDAKICB9CgogIGFzeW5jIGNoZWNrb3V0KGxlbmd0aCkgewogICAgY29uc3QgY2hlY2tvdXQgPSBuZXcgU3lzdGVtVmlldyh0aGlzLmNvcmUuc2Vzc2lvbigpLCB7CiAgICAgIGNoZWNrb3V0OiBsZW5ndGgsCiAgICAgIGVtcHR5OiBsZW5ndGggPT09IDAKICAgIH0pCgogICAgYXdhaXQgY2hlY2tvdXQucmVhZHkoKQoKICAgIHJldHVybiBjaGVja291dAogIH0KCiAgYXN5bmMgX29wZW4oKSB7CiAgICAvLyB0aGlzIHNob3VsZCBORVZFUiBmYWlsLCBpZiBzbyB3ZSBoYXZlIGEgYnVnIGVsc2V3aGVyZSAoc2hvdWxkIGFsd2F5cyBiZSBjb25zaXN0ZW50KQogICAgY29uc3QgaW5mbyA9IHRoaXMuX2VtcHR5CiAgICAgID8gbnVsbAogICAgICA6IGF3YWl0IHRoaXMuZGIuZ2V0KCdpbmZvJywgewogICAgICAgICAgdmFsdWVFbmNvZGluZzogSW5mbywKICAgICAgICAgIGtleUVuY29kaW5nOiBESUdFU1QsCiAgICAgICAgICB1cGRhdGU6IGZhbHNlLAogICAgICAgICAgd2FpdDogZmFsc2UKICAgICAgICB9KQogICAgYXdhaXQgdGhpcy5fcmVzZXQoaW5mbykKICB9CgogIGFzeW5jIF9jbG9zZSgpIHsKICAgIGF3YWl0IHRoaXMuZGIuY2xvc2UoKQogIH0KCiAgYXN5bmMgZ2V0SW5kZXhlZEluZm8obGVuZ3RoID0gdGhpcy5jb3JlLnNpZ25lZExlbmd0aCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgaWYgKGxlbmd0aCA9PT0gdGhpcy5jb3JlLmxlbmd0aCkgewogICAgICByZXR1cm4gewogICAgICAgIHZlcnNpb246IHRoaXMudmVyc2lvbiwKICAgICAgICBtZW1iZXJzOiB0aGlzLm1lbWJlcnMsCiAgICAgICAgcGVuZGluZ0luZGV4ZXJzOiB0aGlzLnBlbmRpbmdJbmRleGVycywKICAgICAgICBpbmRleGVyczogdGhpcy5pbmRleGVycywKICAgICAgICBoZWFkczogdGhpcy5oZWFkcywKICAgICAgICB2aWV3czogdGhpcy52aWV3cywKICAgICAgICBlbmNyeXB0aW9uTGVuZ3RoOiB0aGlzLmVuY3J5cHRpb25MZW5ndGgsCiAgICAgICAgZW50cm9weTogdGhpcy5lbnRyb3B5CiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBub2RlID0gbGVuZ3RoID09PSAwID8gbnVsbCA6IGF3YWl0IHRoaXMuZGIuZ2V0QnlTZXEobGVuZ3RoIC0gMSkKICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmVyc2lvbjogREVGQVVMVF9BVVRPQkFTRV9WRVJTSU9OLAogICAgICAgIG1lbWJlcnM6IDAsCiAgICAgICAgcGVuZGluZ0luZGV4ZXJzOiBbXSwKICAgICAgICBpbmRleGVyczogW10sCiAgICAgICAgaGVhZHM6IFtdLAogICAgICAgIHZpZXdzOiBbXSwKICAgICAgICBlbmNyeXB0aW9uTGVuZ3RoOiAwLAogICAgICAgIGVudHJvcHk6IG51bGwKICAgICAgfQogICAgfQoKICAgIHJldHVybiBjLmRlY29kZShJbmZvLCBub2RlLnZhbHVlKQogIH0KCiAgc3RhdGljIHNhbWVJbmRleGVycyhhLCBiKSB7CiAgICBpZiAoYS5sZW5ndGggIT09IGIubGVuZ3RoKSByZXR1cm4gZmFsc2UKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKCFiNGEuZXF1YWxzKGFbaV0ua2V5LCBiW2ldLmNvcmUua2V5KSkgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIHNhbWVJbmRleGVycyhpbmRleGVycykgewogICAgcmV0dXJuIFN5c3RlbVZpZXcuc2FtZUluZGV4ZXJzKHRoaXMuaW5kZXhlcnMsIGluZGV4ZXJzKQogIH0KCiAgYXN5bmMgaGlzdG9yeShzaW5jZSkgewogICAgY29uc3QgY2hlY2tvdXQgPSB0aGlzLmRiLmNoZWNrb3V0KHNpbmNlKQogICAgY29uc3Qgc2VlbiA9IG5ldyBNYXAoKQoKICAgIGNvbnN0IG5vZGVzID0gW10KICAgIGNvbnN0IHVwZGF0ZXMgPSBbXQoKICAgIGNvbnN0IGNoZWNrb3V0Tm9kZSA9IHNpbmNlID09PSAwID8gbnVsbCA6IGF3YWl0IHRoaXMuZGIuZ2V0QnlTZXEoc2luY2UgLSAxKQoKICAgIGxldCBwcmV2SW5mbyA9IGNoZWNrb3V0Tm9kZSA9PT0gbnVsbCA/IG51bGwgOiBjLmRlY29kZShJbmZvLCBjaGVja291dE5vZGUudmFsdWUpCiAgICBsZXQgdXBkYXRlQmF0Y2ggPSAwCgogICAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIHRoaXMuZGIuY3JlYXRlSGlzdG9yeVN0cmVhbSh7IGd0ZTogc2luY2UgfSkpIHsKICAgICAgaWYgKGI0YS5lcXVhbHMoZGF0YS5rZXksIElORk9fS0VZKSkgewogICAgICAgIGNvbnN0IGluZm8gPSBjLmRlY29kZShJbmZvLCBkYXRhLnZhbHVlKQoKICAgICAgICB1cGRhdGVzLnB1c2goewogICAgICAgICAgYmF0Y2g6IHVwZGF0ZUJhdGNoLAogICAgICAgICAgaW5kZXhlcnM6IHByZXZJbmZvID09PSBudWxsIHx8ICFzYW1lSW5kZXhlcnMoaW5mbywgcHJldkluZm8pLAogICAgICAgICAgc3lzdGVtTGVuZ3RoOiBkYXRhLnNlcSArIDEKICAgICAgICB9KQoKICAgICAgICBwcmV2SW5mbyA9IGluZm8KICAgICAgICB1cGRhdGVCYXRjaCA9IDAKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBjb25zdCBrZXkgPSBkYXRhLmtleS5zdWJhcnJheSgyKQogICAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykKICAgICAgY29uc3QgbGVuID0gYy5kZWNvZGUoTWVtYmVyLCBkYXRhLnZhbHVlKS5sZW5ndGgKCiAgICAgIGlmICghc2Vlbi5oYXMoaGV4KSkgewogICAgICAgIGNvbnN0IG5vZGUgPSBhd2FpdCBjaGVja291dC5nZXQoZGF0YS5rZXkpCiAgICAgICAgaWYgKG5vZGUgPT09IG51bGwpIHsKICAgICAgICAgIHNlZW4uc2V0KGhleCwgMCkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgeyBsZW5ndGggfSA9IGMuZGVjb2RlKE1lbWJlciwgbm9kZS52YWx1ZSkKICAgICAgICAgIHNlZW4uc2V0KGhleCwgbGVuZ3RoKQogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgcHJldiA9IHNlZW4uZ2V0KGhleCkKICAgICAgY29uc3QgYmF0Y2ggPSBsZW4gLSBwcmV2CiAgICAgIHNlZW4uc2V0KGhleCwgbGVuKQoKICAgICAgaWYgKGJhdGNoID09PSAwKSBjb250aW51ZQoKICAgICAgdXBkYXRlQmF0Y2ggKz0gYmF0Y2gKCiAgICAgIGlmIChub2Rlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgdG9wID0gbm9kZXNbbm9kZXMubGVuZ3RoIC0gMV0KICAgICAgICBpZiAoYjRhLmVxdWFscyh0b3Aua2V5LCBrZXkpKSB7CiAgICAgICAgICB0b3AubGVuZ3RoID0gbGVuCiAgICAgICAgICB0b3AuYmF0Y2ggKz0gYmF0Y2gKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogICAgICB9CgogICAgICBub2Rlcy5wdXNoKHsKICAgICAgICBrZXksCiAgICAgICAgbGVuZ3RoOiBsZW4sCiAgICAgICAgYmF0Y2gKICAgICAgfSkKICAgIH0KCiAgICBhd2FpdCBjaGVja291dC5jbG9zZSgpCgogICAgcmV0dXJuIHsgdXBkYXRlcywgbm9kZXMgfQogIH0KCiAgYXN5bmMgdXBkYXRlKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgaWYgKHRoaXMuX2ZvcmsgPT09IHRoaXMuY29yZS5mb3JrICYmIHRoaXMuX2xlbmd0aCA9PT0gdGhpcy5jb3JlLmxlbmd0aCkgcmV0dXJuIGZhbHNlCgogICAgYXdhaXQgdGhpcy5fcmVzZXQoCiAgICAgIHRoaXMuX2VtcHR5ID8gbnVsbCA6IGF3YWl0IHRoaXMuZGIuZ2V0KCdpbmZvJywgeyB2YWx1ZUVuY29kaW5nOiBJbmZvLCBrZXlFbmNvZGluZzogRElHRVNUIH0pCiAgICApCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgX3Jlc2V0KGluZm8pIHsKICAgIHRoaXMudmVyc2lvbiA9IGluZm8gPT09IG51bGwgPyBERUZBVUxUX0FVVE9CQVNFX1ZFUlNJT04gOiBpbmZvLnZhbHVlLnZlcnNpb24KICAgIHRoaXMubWVtYmVycyA9IGluZm8gPT09IG51bGwgPyAwIDogaW5mby52YWx1ZS5tZW1iZXJzCiAgICB0aGlzLnBlbmRpbmdJbmRleGVycyA9IGluZm8gPT09IG51bGwgPyBbXSA6IGluZm8udmFsdWUucGVuZGluZ0luZGV4ZXJzCiAgICB0aGlzLmluZGV4ZXJzID0gaW5mbyA9PT0gbnVsbCA/IFtdIDogaW5mby52YWx1ZS5pbmRleGVycwogICAgdGhpcy5oZWFkcyA9IGluZm8gPT09IG51bGwgPyBbXSA6IGluZm8udmFsdWUuaGVhZHMKICAgIHRoaXMudmlld3MgPSBpbmZvID09PSBudWxsID8gW10gOiBpbmZvLnZhbHVlLnZpZXdzCiAgICB0aGlzLmVuY3J5cHRpb25MZW5ndGggPSBpbmZvID09PSBudWxsID8gMCA6IGluZm8udmFsdWUuZW5jcnlwdGlvbkxlbmd0aAogICAgdGhpcy5lbnRyb3B5ID0gaW5mbyA9PT0gbnVsbCA/IG51bGwgOiBpbmZvLnZhbHVlLmVudHJvcHkKCiAgICB0aGlzLmluZGV4ZXJVcGRhdGUgPSBmYWxzZQogICAgdGhpcy5faW5kZXhlck1hcC5jbGVhcigpCiAgICB0aGlzLl9jbG9ja1VwZGF0ZXMuY2xlYXIoKQogICAgdGhpcy5fbGVuZ3RoID0gdGhpcy5jb3JlLmxlbmd0aAogICAgdGhpcy5fZm9yayA9IHRoaXMuY29yZS5mb3JrCiAgICB0aGlzLl9jaGFuZ2VzID0gW10KCiAgICBmb3IgKGNvbnN0IGlkeCBvZiB0aGlzLmluZGV4ZXJzKSB7CiAgICAgIHRoaXMuX2luZGV4ZXJNYXAuc2V0KGI0YS50b1N0cmluZyhpZHgua2V5LCAnaGV4JyksIGlkeCkKICAgIH0KICB9CgogIC8vIGhlbHBlciB1c2VkIGJ5IGFwcGx5LXN0YXRlCiAgZmx1c2hMZW5ndGgoKSB7CiAgICBjb25zdCBoZWFkZXIgPSB0aGlzLmNvcmUubGVuZ3RoID8gMCA6IDEgLy8gYWNjb3VudCBmb3IgaGVhZGVyCgogICAgbGV0IHVwZGF0ZXMgPSB0aGlzLl9jaGFuZ2VzLmxlbmd0aCArIHRoaXMuX2Nsb2NrVXBkYXRlcy5zaXplCiAgICBmb3IgKGNvbnN0IHsga2V5IH0gb2YgdGhpcy5fY2hhbmdlcykgewogICAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykKICAgICAgaWYgKHRoaXMuX2Nsb2NrVXBkYXRlcy5oYXMoaGV4KSkgdXBkYXRlcy0tIC8vIHNoYXJlZCBhcmUgc2tpcHBlZAogICAgfQoKICAgIHJldHVybiBoZWFkZXIgKyB0aGlzLmNvcmUubGVuZ3RoICsgdXBkYXRlcyArIDEKICB9CgogIGFzeW5jIGZsdXNoKHZpZXdzKSB7CiAgICBjb25zdCBiYXRjaCA9IHRoaXMuZGIuYmF0Y2goeyB1cGRhdGU6IGZhbHNlIH0pCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9jaGFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGMgPSB0aGlzLl9jaGFuZ2VzW2ldCiAgICAgIGlmICh0aGlzLl9jbG9ja1VwZGF0ZXMuaGFzKGI0YS50b1N0cmluZyhjLmtleSwgJ2hleCcpKSkgY29udGludWUKICAgICAgYXdhaXQgYmF0Y2gucHV0KGMua2V5LCBjLnZhbHVlLCB7IHZhbHVlRW5jb2Rpbmc6IE1lbWJlciwga2V5RW5jb2Rpbmc6IE1FTUJFUlMgfSkKICAgIH0KCiAgICBmb3IgKGNvbnN0IFtoZXgsIGxlbmd0aF0gb2YgdGhpcy5fY2xvY2tVcGRhdGVzKSB7CiAgICAgIGNvbnN0IGlzSW5kZXhlciA9IHRoaXMuX2luZGV4ZXJNYXAuZ2V0KGhleCkgIT09IHVuZGVmaW5lZAogICAgICBjb25zdCBrZXkgPSBiNGEuZnJvbShoZXgsICdoZXgnKQoKICAgICAgY29uc3QgaW5mbyA9IGF3YWl0IHRoaXMuX2dldChrZXksIDApCgogICAgICBjb25zdCB2YWx1ZSA9IHsgaXNJbmRleGVyLCBpc1JlbW92ZWQ6IGluZm8gPyBpbmZvLmlzUmVtb3ZlZCA6IHRydWUsIGxlbmd0aCB9CiAgICAgIGF3YWl0IGJhdGNoLnB1dChrZXksIHZhbHVlLCB7IHZhbHVlRW5jb2Rpbmc6IE1lbWJlciwga2V5RW5jb2Rpbmc6IE1FTUJFUlMgfSkKICAgIH0KCiAgICBpZiAodGhpcy5pbmRleGVyVXBkYXRlKSB7CiAgICAgIHRoaXMuX3JlZnJlc2hFbnRyb3B5KHRoaXMuY29yZS5sZW5ndGggKyBiYXRjaC5sZW5ndGggKyAxKQogICAgfQoKICAgIHRoaXMuX2Nsb2NrVXBkYXRlcy5jbGVhcigpCgogICAgbGV0IG1heEluZGV4ID0gLTEKICAgIGZvciAoY29uc3QgdmlldyBvZiB2aWV3cykgewogICAgICBpZiAodmlldy5tYXBwZWRJbmRleCA+IG1heEluZGV4KSBtYXhJbmRleCA9IHZpZXcubWFwcGVkSW5kZXgKICAgIH0KCiAgICB3aGlsZSAodGhpcy52aWV3cy5sZW5ndGggPiBtYXhJbmRleCArIDEpIHRoaXMudmlld3MucG9wKCkKCiAgICBmb3IgKGNvbnN0IHZpZXcgb2Ygdmlld3MpIHsKICAgICAgY29uc3QgbGVuZ3RoID0gdmlldy5jb3JlID8gdmlldy5jb3JlLmxlbmd0aCA6IHZpZXcubGVuZ3RoCiAgICAgIGlmICghbGVuZ3RoKSBjb250aW51ZQoKICAgICAgY29uc3QgdiA9IHsga2V5OiB2aWV3LmtleSwgbGVuZ3RoIH0KCiAgICAgIGlmICh2aWV3Lm1hcHBlZEluZGV4ICE9PSAtMSkgewogICAgICAgIHRoaXMudmlld3Nbdmlldy5tYXBwZWRJbmRleF0gPSB2CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmlldy5tYXBwZWRJbmRleCA9IHRoaXMudmlld3MucHVzaCh2KSAtIDEKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGluZm8gPSB7CiAgICAgIHZlcnNpb246IHRoaXMudmVyc2lvbiwKICAgICAgbWVtYmVyczogdGhpcy5tZW1iZXJzLAogICAgICBwZW5kaW5nSW5kZXhlcnM6IHRoaXMucGVuZGluZ0luZGV4ZXJzLAogICAgICBpbmRleGVyczogdGhpcy5pbmRleGVycywKICAgICAgaGVhZHM6IHRoaXMuaGVhZHMsCiAgICAgIHZpZXdzOiB0aGlzLnZpZXdzLAogICAgICBlbmNyeXB0aW9uTGVuZ3RoOiB0aGlzLmVuY3J5cHRpb25MZW5ndGgsCiAgICAgIGVudHJvcHk6IHRoaXMuZW50cm9weQogICAgfQoKICAgIGF3YWl0IGJhdGNoLnB1dCgnaW5mbycsIGluZm8sIHsgdmFsdWVFbmNvZGluZzogSW5mbywga2V5RW5jb2Rpbmc6IERJR0VTVCB9KQogICAgYXdhaXQgYmF0Y2guZmx1c2goKQoKICAgIHRoaXMuX2xlbmd0aCA9IHRoaXMuY29yZS5sZW5ndGggLy8gc2hvdWxkIGJlIG9rCiAgICB0aGlzLl9jaGFuZ2VzID0gW10KCiAgICBpZiAodGhpcy5pbmRleGVyVXBkYXRlKSB0aGlzLmluZGV4ZXJVcGRhdGUgPSBmYWxzZQogIH0KCiAgZ2V0RW50cm9weShpbmRleGVycywgbGVuZ3RoKSB7CiAgICByZXR1cm4gZ2VuZXJhdGVFbnRyb3B5KGluZGV4ZXJzLCBsZW5ndGgsIHRoaXMuZW50cm9weSkKICB9CgogIF9yZWZyZXNoRW50cm9weShsZW5ndGgpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPCAyKSByZXR1cm4KICAgIHRoaXMuZW50cm9weSA9IHRoaXMuZ2V0RW50cm9weSh0aGlzLmluZGV4ZXJzLCBsZW5ndGgpCiAgfQoKICBjaGVja3BvaW50KCkgewogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogdGhpcy52ZXJzaW9uLAogICAgICBtZW1iZXJzOiB0aGlzLm1lbWJlcnMsCiAgICAgIHBlbmRpbmdJbmRleGVyczogdGhpcy5wZW5kaW5nSW5kZXhlcnMuc2xpY2UoMCksCiAgICAgIGluZGV4ZXJzOiBjbG9uZU5vZGVzKHRoaXMuaW5kZXhlcnMpLAogICAgICBoZWFkczogY2xvbmVOb2Rlcyh0aGlzLmhlYWRzKSwKICAgICAgdmlld3M6IGNsb25lTm9kZXModGhpcy52aWV3cyksCiAgICAgIGluZGV4ZXJVcGRhdGU6IHRoaXMuaW5kZXhlclVwZGF0ZSwKICAgICAgZW5jcnlwdGlvbkxlbmd0aDogdGhpcy5lbmNyeXB0aW9uTGVuZ3RoLAogICAgICBlbnRyb3B5OiB0aGlzLmVudHJvcHkgPyBiNGEuZnJvbSh0aGlzLmVudHJvcHkpIDogbnVsbCwKICAgICAgY2hhbmdlczogdGhpcy5fY2hhbmdlcy5zbGljZSgwKSwKICAgICAgY2xvY2tVcGRhdGVzOiBuZXcgTWFwKFsuLi50aGlzLl9jbG9ja1VwZGF0ZXNdKQogICAgfQogIH0KCiAgYXBwbHlDaGVja3BvaW50KGNoZWNrcG9pbnQpIHsKICAgIHRoaXMudmVyc2lvbiA9IGNoZWNrcG9pbnQudmVyc2lvbgogICAgdGhpcy5tZW1iZXJzID0gY2hlY2twb2ludC5tZW1iZXJzCiAgICB0aGlzLnBlbmRpbmdJbmRleGVycyA9IGNoZWNrcG9pbnQucGVuZGluZ0luZGV4ZXJzCiAgICB0aGlzLmluZGV4ZXJzID0gY2hlY2twb2ludC5pbmRleGVycwogICAgdGhpcy5oZWFkcyA9IGNoZWNrcG9pbnQuaGVhZHMKICAgIHRoaXMudmlld3MgPSBjaGVja3BvaW50LnZpZXdzCiAgICB0aGlzLmluZGV4ZXJVcGRhdGUgPSBjaGVja3BvaW50LmluZGV4ZXJVcGRhdGUKICAgIHRoaXMuZW5jcnlwdGlvbkxlbmd0aCA9IGNoZWNrcG9pbnQuZW5jcnlwdGlvbkxlbmd0aAogICAgdGhpcy5lbnRyb3B5ID0gY2hlY2twb2ludC5lbnRyb3B5CgogICAgdGhpcy5fY2hhbmdlcyA9IGNoZWNrcG9pbnQuY2hhbmdlcwogICAgdGhpcy5fY2xvY2tVcGRhdGVzID0gY2hlY2twb2ludC5jbG9ja1VwZGF0ZXMKCiAgICB0aGlzLl9pbmRleGVyTWFwID0gbmV3IE1hcCgpCiAgICBmb3IgKGNvbnN0IGlkeCBvZiB0aGlzLmluZGV4ZXJzKSB7CiAgICAgIHRoaXMuX2luZGV4ZXJNYXAuc2V0KGI0YS50b1N0cmluZyhpZHgua2V5LCAnaGV4JyksIGlkeCkKICAgIH0KICB9CgogIGFkZEhlYWQobm9kZSkgewogICAgY29uc3QgaCA9IHsga2V5OiBub2RlLndyaXRlci5jb3JlLmtleSwgbGVuZ3RoOiBub2RlLmxlbmd0aCB9CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmhlYWRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGhlYWQgPSB0aGlzLmhlYWRzW2ldCgogICAgICBpZiAoIWhhc0RlcGVuZGVuY3kobm9kZSwgaGVhZCkpIHsKICAgICAgICBpZiAoIWI0YS5lcXVhbHMobm9kZS53cml0ZXIuY29yZS5rZXksIGhlYWQua2V5KSkgY29udGludWUKCiAgICAgICAgLy8gdG9kbzogcmVtb3ZlIGluIG5leHQgbWFqb3IgYmVjYXVzZSBidWcgd2FzIGZpeGVkIGhlcmU6CiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2F1dG9iYXNlLW5leHQvcHVsbC8yMzcKCiAgICAgICAgLy8gZmlsdGVyIG91dCBhbnkgYmFkIGhlYWRzIGludHJvZHVjZWQgYnkgYSBidWcgdG8KICAgICAgICAvLyBwcmV2ZW50IGluY29uc2lzdGVuY2llcyBiZWluZyB3cml0dGVuIHRvIHRoZSBvcGxvZwogICAgICAgIGlmIChoZWFkLmxlbmd0aCA+IGgubGVuZ3RoKSByZXR1cm4gZmFsc2UKICAgICAgfQoKICAgICAgY29uc3QgcG9wcGVkID0gdGhpcy5oZWFkcy5wb3AoKQogICAgICBpZiAocG9wcGVkICE9PSBoZWFkKSB0aGlzLmhlYWRzW2ktLV0gPSBwb3BwZWQKICAgIH0KCiAgICB0aGlzLmhlYWRzLnB1c2goaCkKCiAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcoaC5rZXksICdoZXgnKQoKICAgIHRoaXMuX2Nsb2NrVXBkYXRlcy5zZXQoaGV4LCBoLmxlbmd0aCkKCiAgICBpZiAodGhpcy5wZW5kaW5nSW5kZXhlcnMubGVuZ3RoID4gMCkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGVuZGluZ0luZGV4ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKCFiNGEuZXF1YWxzKHRoaXMucGVuZGluZ0luZGV4ZXJzW2ldLCBoLmtleSkpIGNvbnRpbnVlCiAgICAgICAgdGhpcy5fdXBkYXRlSW5kZXhlcihoLmtleSwgaC5sZW5ndGgsIHRydWUsIGkpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGlkeCA9IHRoaXMuX2luZGV4ZXJNYXAuZ2V0KGhleCkKICAgIGlmIChpZHggIT09IHVuZGVmaW5lZCkgewogICAgICBpZHgubGVuZ3RoID0gaC5sZW5ndGgKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF91cGRhdGVJbmRleGVyKGtleSwgbGVuZ3RoLCBpc0luZGV4ZXIsIGkpIHsKICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQoKICAgIGlmICghaXNJbmRleGVyKSB7CiAgICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5faW5kZXhlck1hcC5nZXQoaGV4KQogICAgICBpZiAoZXhpc3RpbmcpIHsKICAgICAgICB0aGlzLmluZGV4ZXJVcGRhdGUgPSB0cnVlCiAgICAgICAgdGhpcy5pbmRleGVycy5zcGxpY2UodGhpcy5pbmRleGVycy5pbmRleE9mKGV4aXN0aW5nKSwgMSkKICAgICAgICB0aGlzLl9pbmRleGVyTWFwLmRlbGV0ZShoZXgpCiAgICAgIH0KICAgICAgcmV0dXJuCiAgICB9CgogICAgZm9yICg7IGkgPCB0aGlzLnBlbmRpbmdJbmRleGVycy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoYjRhLmVxdWFscyh0aGlzLnBlbmRpbmdJbmRleGVyc1tpXSwga2V5KSkgewogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KCiAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgIGlmIChpID49IHRoaXMucGVuZGluZ0luZGV4ZXJzLmxlbmd0aCkgdGhpcy5wZW5kaW5nSW5kZXhlcnMucHVzaChrZXkpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChpIDwgdGhpcy5wZW5kaW5nSW5kZXhlcnMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IHRvcCA9IHRoaXMucGVuZGluZ0luZGV4ZXJzLnBvcCgpCiAgICAgIGlmIChpIDwgdGhpcy5wZW5kaW5nSW5kZXhlcnMubGVuZ3RoKSB0aGlzLnBlbmRpbmdJbmRleGVyc1tpXSA9IHRvcAogICAgfQoKICAgIGNvbnN0IGlkeCA9IHRoaXMuX2luZGV4ZXJNYXAuZ2V0KGhleCkKCiAgICBpZiAoaWR4ID09PSB1bmRlZmluZWQpIHsKICAgICAgY29uc3QgbmV3SWR4ID0geyBrZXksIGxlbmd0aCB9CiAgICAgIHRoaXMuX2luZGV4ZXJNYXAuc2V0KGhleCwgbmV3SWR4KQogICAgICB0aGlzLmluZGV4ZXJzLnB1c2gobmV3SWR4KQoKICAgICAgLy8gYm9vdHN0cmFwIGlzICJzaWxlbnRseSIgYWRkZWQgc28gdGhhdCBpbml0aWFsIHZpZXdzIGhhdmUgbm8gcHJvbG9ndWUKICAgICAgaWYgKCF0aGlzLmJvb3RzdHJhcHBpbmcpIHRoaXMuaW5kZXhlclVwZGF0ZSA9IHRydWUKICAgIH0gZWxzZSB7CiAgICAgIGlkeC5sZW5ndGggPSBsZW5ndGgKICAgIH0KICB9CgogIF9zZWVuTGVuZ3RoKGtleSkgewogICAgcmV0dXJuIHRoaXMuX2Nsb2NrVXBkYXRlcy5nZXQoYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpKSB8fCAwCiAgfQoKICBhc3luYyBhY2soa2V5KSB7CiAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IHRoaXMuX2dldChrZXksIDApCiAgICBjb25zdCBsZW5ndGggPSB0aGlzLl9zZWVuTGVuZ3RoKGtleSkKICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS5sZW5ndGggPT09IGxlbmd0aCkgcmV0dXJuCgogICAgY29uc3QgaXNJbmRleGVyID0gdmFsdWUgPyB2YWx1ZS5pc0luZGV4ZXIgOiBmYWxzZQogICAgY29uc3QgaXNSZW1vdmVkID0gdmFsdWUgPyB2YWx1ZS5pc1JlbW92ZWQgOiB0cnVlCgogICAgdGhpcy5fY2hhbmdlcy5wdXNoKHsga2V5LCB2YWx1ZTogeyBpc0luZGV4ZXIsIGlzUmVtb3ZlZCwgbGVuZ3RoIH0gfSkKICB9CgogIGFzeW5jIGFkZChrZXksIHsgaXNJbmRleGVyID0gZmFsc2UsIGxlbmd0aCA9IHRoaXMuX3NlZW5MZW5ndGgoa2V5KSB9ID0ge30pIHsKICAgIGxldCB2YWx1ZSA9IG51bGwKICAgIGxldCBmb3VuZCA9IGZhbHNlCiAgICBsZXQgY2hhbmdlZCA9IHRydWUKCiAgICBmb3IgKGxldCBpID0gdGhpcy5fY2hhbmdlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBjID0gdGhpcy5fY2hhbmdlc1tpXQogICAgICBpZiAoYjRhLmVxdWFscyhrZXksIGMua2V5KSkgewogICAgICAgIHZhbHVlID0gYy52YWx1ZQogICAgICAgIGZvdW5kID0gdHJ1ZQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KCiAgICBpZiAoIWZvdW5kKSB7CiAgICAgIGNvbnN0IG5vZGUgPSBhd2FpdCB0aGlzLmRiLmdldChrZXksIHsgdmFsdWVFbmNvZGluZzogTWVtYmVyLCBrZXlFbmNvZGluZzogTUVNQkVSUyB9KQoKICAgICAgaWYgKG5vZGUpIHsKICAgICAgICB2YWx1ZSA9IG5vZGUudmFsdWUKICAgICAgICBmb3VuZCA9IHRydWUKICAgICAgfQogICAgfQoKICAgIGxldCB3YXNUcmFja2VkID0gZmFsc2UKICAgIGxldCB3YXNJbmRleGVyID0gZmFsc2UKCiAgICBpZiAoZm91bmQpIHsKICAgICAgaWYgKCF2YWx1ZS5pc1JlbW92ZWQpIHdhc1RyYWNrZWQgPSB0cnVlCiAgICAgIGlmICh2YWx1ZS5pc0luZGV4ZXIpIHdhc0luZGV4ZXIgPSB0cnVlCiAgICAgIGlmIChsZW5ndGggPCB2YWx1ZS5sZW5ndGgpIGxlbmd0aCA9IHZhbHVlLmxlbmd0aAogICAgICBpZiAodmFsdWUubGVuZ3RoID09PSBsZW5ndGggJiYgdmFsdWUuaXNJbmRleGVyID09PSBpc0luZGV4ZXIgJiYgdmFsdWUuaXNSZW1vdmVkID09PSBmYWxzZSkKICAgICAgICBjaGFuZ2VkID0gZmFsc2UKICAgIH0KCiAgICBpZiAoY2hhbmdlZCkgewogICAgICB0aGlzLl9jaGFuZ2VzLnB1c2goeyBrZXksIHZhbHVlOiB7IGlzSW5kZXhlciwgaXNSZW1vdmVkOiBmYWxzZSwgbGVuZ3RoIH0gfSkKICAgIH0KCiAgICBpZiAoIXdhc1RyYWNrZWQpIHRoaXMubWVtYmVycysrCiAgICBpZiAod2FzSW5kZXhlciB8fCBpc0luZGV4ZXIpIHRoaXMuX3VwZGF0ZUluZGV4ZXIoa2V5LCBsZW5ndGgsIGlzSW5kZXhlciwgMCkKICB9CgogIGFzeW5jIHJlbW92ZShrZXkpIHsKICAgIGxldCBpc0luZGV4ZXIgPSBmYWxzZQoKICAgIGZvciAoY29uc3QgaWR4IG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgaXNJbmRleGVyID0gYjRhLmVxdWFscyhpZHgua2V5LCBrZXkpCiAgICAgIGlmIChpc0luZGV4ZXIpIGJyZWFrCiAgICB9CgogICAgaWYgKGlzSW5kZXhlcikgdGhpcy5fdXBkYXRlSW5kZXhlcihrZXksIG51bGwsIGZhbHNlLCAwKQoKICAgIGxldCB2YWx1ZSA9IG51bGwKICAgIGxldCBmb3VuZCA9IGZhbHNlCgogICAgZm9yIChsZXQgaSA9IHRoaXMuX2NoYW5nZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgYyA9IHRoaXMuX2NoYW5nZXNbaV0KICAgICAgaWYgKGI0YS5lcXVhbHMoa2V5LCBjLmtleSkpIHsKICAgICAgICB2YWx1ZSA9IGMudmFsdWUKICAgICAgICBmb3VuZCA9IHRydWUKICAgICAgICBicmVhawogICAgICB9CiAgICB9CgogICAgaWYgKCFmb3VuZCkgewogICAgICBjb25zdCBub2RlID0gYXdhaXQgdGhpcy5kYi5nZXQoa2V5LCB7IHZhbHVlRW5jb2Rpbmc6IE1lbWJlciwga2V5RW5jb2Rpbmc6IE1FTUJFUlMgfSkKICAgICAgaWYgKG5vZGUpIHsKICAgICAgICB2YWx1ZSA9IG5vZGUudmFsdWUKICAgICAgICBmb3VuZCA9IHRydWUKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGNoYW5nZWQgPSAhZm91bmQgfHwgIXZhbHVlLmlzUmVtb3ZlZAogICAgY29uc3Qgd2FzVHJhY2tlZCA9IGZvdW5kICYmICF2YWx1ZS5pc1JlbW92ZWQKICAgIGNvbnN0IGxlbmd0aCA9IGZvdW5kID8gdmFsdWUubGVuZ3RoIDogMAoKICAgIGlmIChjaGFuZ2VkKSB7CiAgICAgIHRoaXMuX2NoYW5nZXMucHVzaCh7IGtleSwgdmFsdWU6IHsgaXNJbmRleGVyOiBmYWxzZSwgaXNSZW1vdmVkOiB0cnVlLCBsZW5ndGggfSB9KQogICAgfQoKICAgIGlmICh3YXNUcmFja2VkKSB0aGlzLm1lbWJlcnMtLQoKICAgIHJldHVybiBpc0luZGV4ZXIKICB9CgogIGFzeW5jIGxpbmthYmxlKGtleSwgbGVuZ3RoKSB7CiAgICBjb25zdCBsZW4gPSB0aGlzLl9zZWVuTGVuZ3RoKGtleSkKICAgIGlmIChsZW4gPiAwKSByZXR1cm4gbGVuZ3RoID4gbGVuCgogICAgY29uc3QgaW5mbyA9IGF3YWl0IHRoaXMuX2dldChrZXksIDApCiAgICBjb25zdCBwcmV2TGVuZ3RoID0gaW5mbyA/IGluZm8ubGVuZ3RoIDogMAoKICAgIHJldHVybiBsZW5ndGggPiBwcmV2TGVuZ3RoCiAgfQoKICBhc3luYyBoYXMoa2V5LCBvcHRzKSB7CiAgICAvLyBjb3VsZCBiZSBvcHRpbWlzZWQuLi4KICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXQoa2V5LCBvcHRzKSkgIT09IG51bGwKICB9CgogIGFzeW5jIF9nZXQoa2V5LCB0aW1lb3V0KSB7CiAgICBsZXQgdmFsdWUgPSBudWxsCiAgICBsZXQgZm91bmQgPSBmYWxzZQoKICAgIGZvciAobGV0IGkgPSB0aGlzLl9jaGFuZ2VzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IGMgPSB0aGlzLl9jaGFuZ2VzW2ldCiAgICAgIGlmIChiNGEuZXF1YWxzKGtleSwgYy5rZXkpKSB7CiAgICAgICAgdmFsdWUgPSBjLnZhbHVlCiAgICAgICAgZm91bmQgPSB0cnVlCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIGlmICghZm91bmQpIHsKICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IHRoaXMuZGIuZ2V0KGtleSwgeyB0aW1lb3V0LCB2YWx1ZUVuY29kaW5nOiBNZW1iZXIsIGtleUVuY29kaW5nOiBNRU1CRVJTIH0pCiAgICAgIGlmIChub2RlKSB7CiAgICAgICAgdmFsdWUgPSBub2RlLnZhbHVlCiAgICAgICAgZm91bmQgPSB0cnVlCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZm91bmQgPyB2YWx1ZSA6IG51bGwKICB9CgogIGFzeW5jIGdldChrZXksIG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMuX2VtcHR5KSByZXR1cm4gbnVsbAoKICAgIGxldCB2YWx1ZSA9IGF3YWl0IHRoaXMuX2dldChrZXksIG9wdHMudGltZW91dCB8fCAwKQoKICAgIGlmIChvcHRzLnVuZmx1c2hlZCkgewogICAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykKCiAgICAgIGZvciAobGV0IGkgPSB0aGlzLl9jaGFuZ2VzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgY29uc3QgYyA9IHRoaXMuX2NoYW5nZXNbaV0KICAgICAgICBpZiAoYjRhLmVxdWFscyhjLmtleSwga2V5KSkgdmFsdWUgPSBjLnZhbHVlCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9jbG9ja1VwZGF0ZXMuaGFzKGhleCkpIHZhbHVlLmxlbmd0aCA9IHRoaXMuX2Nsb2NrVXBkYXRlcy5nZXQoaGV4KQogICAgfQoKICAgIHJldHVybiBvcHRzLm9ubHlBY3RpdmUgIT09IGZhbHNlIHx8ICF2YWx1ZS5pc1JlbW92ZWQgPyB2YWx1ZSA6IG51bGwKICB9CgogIGFzeW5jIGhhc0xvY2FsKGtleSkgewogICAgaWYgKHRoaXMuX2VtcHR5KSByZXR1cm4gZmFsc2UKICAgIHRyeSB7CiAgICAgIGNvbnN0IG5vZGUgPSBhd2FpdCB0aGlzLmRiLmdldChrZXksIHsKICAgICAgICB2YWx1ZUVuY29kaW5nOiBNZW1iZXIsCiAgICAgICAga2V5RW5jb2Rpbmc6IE1FTUJFUlMsCiAgICAgICAgdXBkYXRlOiBmYWxzZSwKICAgICAgICB3YWl0OiBmYWxzZQogICAgICB9KQogICAgICByZXR1cm4gbm9kZSAhPT0gbnVsbAogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0KCiAgYXN5bmMgZ2V0TG9jYWxMZW5ndGgoa2V5KSB7CiAgICBpZiAodGhpcy5fZW1wdHkpIHJldHVybiAwCiAgICB0cnkgewogICAgICBjb25zdCBub2RlID0gYXdhaXQgdGhpcy5kYi5nZXQoa2V5LCB7CiAgICAgICAgdmFsdWVFbmNvZGluZzogTWVtYmVyLAogICAgICAgIGtleUVuY29kaW5nOiBNRU1CRVJTLAogICAgICAgIHVwZGF0ZTogZmFsc2UsCiAgICAgICAgd2FpdDogZmFsc2UKICAgICAgfSkKICAgICAgcmV0dXJuIG5vZGUgPT09IG51bGwgPyAwIDogbm9kZS52YWx1ZS5sZW5ndGgKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gMAogICAgfQogIH0KCiAgbGlzdCgpIHsKICAgIC8vIG5vdGUsIE5PVCBzYWZlIHRvIHVzZSBkdXJpbmcgYXBwbHkgYXRtCiAgICByZXR1cm4gdGhpcy5kYi5jcmVhdGVSZWFkU3RyZWFtKHsKICAgICAgdmFsdWVFbmNvZGluZzogTWVtYmVyLAogICAgICBrZXlFbmNvZGluZzogTUVNQkVSUwogICAgfSkKICB9CgogIGFzeW5jIGlzSW5kZXhlZChrZXksIGxlbmd0aCkgewogICAgY29uc3QgY28gPSB0aGlzLmRiLmNoZWNrb3V0KHRoaXMuY29yZS5pbmRleGVkTGVuZ3RoKQogICAgdHJ5IHsKICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IGNvLmdldChrZXksIHsgdmFsdWVFbmNvZGluZzogTWVtYmVyLCBrZXlFbmNvZGluZzogTUVNQkVSUyB9KQogICAgICByZXR1cm4gbm9kZSAhPT0gbnVsbCAmJiBub2RlLnZhbHVlLmxlbmd0aCA+PSBsZW5ndGgKICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IGNvLmNsb3NlKCkKICAgIH0KICB9CgogIGFzeW5jIGZvcmsoaW5kZXhlcnMsIG1hbmlmZXN0cywgZW5jcnlwdGlvbkxlbmd0aCwgdmlld3MpIHsKICAgIHRoaXMuaW5kZXhlcnMgPSBbXQogICAgdGhpcy5wZW5kaW5nSW5kZXhlcnMgPSBbXQogICAgdGhpcy52aWV3cyA9IHZpZXdzCgogICAgaWYgKHRoaXMudmVyc2lvbiA8IDIpIHRoaXMudmVyc2lvbiA9IDIgLy8gYnVtcCB0byBlbmFibGUgZW50cm9weQoKICAgIGZvciAoY29uc3QgeyBrZXkgfSBvZiBpbmRleGVycykgewogICAgICAvLyB0b2RvOiBwcm9iYWJseSBuZWVkIHRvIGNoZWNrIGlzUmVtb3ZlZCBldGMKICAgICAgY29uc3QgeyBsZW5ndGggfSA9IGF3YWl0IHRoaXMuZ2V0KGtleSkKICAgICAgdGhpcy5pbmRleGVycy5wdXNoKHsga2V5LCBsZW5ndGggfSkKICAgIH0KCiAgICB0aGlzLl9yZWZyZXNoRW50cm9weSh0aGlzLmNvcmUubGVuZ3RoKQoKICAgIGNvbnN0IGJsb2NrcyA9IFtdCgogICAgLy8gdHJ1bmNhdGUgbmVlZHMgdG8gcmVzcGVjdCBoeXBlcmNvcmUgYmF0Y2gKICAgIGxldCB0cnVuY2F0ZSA9IHRoaXMuY29yZS5sZW5ndGggLSAxCiAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgdGhpcy5kYi5jcmVhdGVIaXN0b3J5U3RyZWFtKHsgbHQ6IHRydW5jYXRlLCByZXZlcnNlOiB0cnVlIH0pKSB7CiAgICAgIGlmIChiNGEuZXF1YWxzKGRhdGEua2V5LCBJTkZPX0tFWSkpIHsKICAgICAgICB0cnVuY2F0ZSA9IGRhdGEuc2VxICsgMQogICAgICAgIGJyZWFrCiAgICAgIH0KCiAgICAgIGJsb2Nrcy5wdXNoKGRhdGEpCiAgICB9CgogICAgYXdhaXQgdGhpcy5jb3JlLnRydW5jYXRlKHRydW5jYXRlLCB0aGlzLmNvcmUuZm9yaykKCiAgICBjb25zdCBiYXRjaCA9IHRoaXMuZGIuYmF0Y2goeyB1cGRhdGU6IGZhbHNlIH0pCiAgICBhd2FpdCBiYXRjaC5yZWFkeSgpCgogICAgZm9yIChjb25zdCB7IGtleSwgdmFsdWUgfSBvZiBibG9ja3MpIHsKICAgICAgYXdhaXQgYmF0Y2gucHV0KGtleSwgdmFsdWUpCiAgICB9CgogICAgY29uc3QgaW5mbyA9IHsKICAgICAgdmVyc2lvbjogdGhpcy52ZXJzaW9uLAogICAgICBtZW1iZXJzOiB0aGlzLm1lbWJlcnMsCiAgICAgIHBlbmRpbmdJbmRleGVyczogdGhpcy5wZW5kaW5nSW5kZXhlcnMsCiAgICAgIGluZGV4ZXJzOiB0aGlzLmluZGV4ZXJzLAogICAgICBoZWFkczogdGhpcy5oZWFkcywKICAgICAgdmlld3M6IHRoaXMudmlld3MsCiAgICAgIGVuY3J5cHRpb25MZW5ndGgsCiAgICAgIGVudHJvcHk6IHRoaXMuZW50cm9weQogICAgfQoKICAgIGF3YWl0IGJhdGNoLnB1dCgnaW5mbycsIGluZm8sIHsgdmFsdWVFbmNvZGluZzogSW5mbywga2V5RW5jb2Rpbmc6IERJR0VTVCB9KQogICAgYXdhaXQgYmF0Y2guZmx1c2goKQoKICAgIGF3YWl0IHRoaXMuX3Jlc2V0KGF3YWl0IHRoaXMuZGIuZ2V0KCdpbmZvJywgeyB2YWx1ZUVuY29kaW5nOiBJbmZvLCBrZXlFbmNvZGluZzogRElHRVNUIH0pKQoKICAgIHJldHVybiB0cnVuY2F0ZQogIH0KfQoKZnVuY3Rpb24gaGFzRGVwZW5kZW5jeShub2RlLCBkZXApIHsKICBmb3IgKGNvbnN0IGggb2Ygbm9kZS5hY3R1YWxIZWFkcykgewogICAgaWYgKHNhbWVOb2RlKGgsIGRlcCkpIHJldHVybiB0cnVlCiAgfQogIHJldHVybiBmYWxzZQp9CgpmdW5jdGlvbiBzYW1lTm9kZShhLCBiKSB7CiAgcmV0dXJuIGI0YS5lcXVhbHMoYS5rZXksIGIua2V5KSAmJiBhLmxlbmd0aCA9PT0gYi5sZW5ndGgKfQoKZnVuY3Rpb24gc2FtZUluZGV4ZXJzKGEsIGIpIHsKICBpZiAoYS52aWV3cy5sZW5ndGggPiAwICYmIGIudmlld3MubGVuZ3RoID4gMCkgcmV0dXJuIGI0YS5lcXVhbHMoYS52aWV3c1swXS5rZXksIGIudmlld3NbMF0ua2V5KQogIGlmIChhLmluZGV4ZXJzLmxlbmd0aCAhPT0gYi5pbmRleGVycy5sZW5ndGgpIHJldHVybiBmYWxzZQoKICBmb3IgKGxldCBpID0gMDsgaSA8IGEuaW5kZXhlcnMubGVuZ3RoOyBpKyspIHsKICAgIGlmICghYjRhLmVxdWFscyhhLmluZGV4ZXJzW2ldLmtleSwgYi5pbmRleGVyc1tpXS5rZXkpKSByZXR1cm4gZmFsc2UKICB9CgogIHJldHVybiB0cnVlCn0KCmZ1bmN0aW9uIGNsb25lTm9kZXMoYXJyKSB7CiAgY29uc3QgYyA9IFtdCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgIGMucHVzaCh7IGtleTogYXJyW2ldLmtleSwgbGVuZ3RoOiBhcnJbaV0ubGVuZ3RoIH0pCiAgfQogIHJldHVybiBjCn0KCmZ1bmN0aW9uIGdlbmVyYXRlRW50cm9weShpbmRleGVycywgbGVuZ3RoLCBlbnRyb3B5KSB7CiAgY29uc3QgYnVmZmVyID0gYjRhLmFsbG9jKDggKyAzMiArIGluZGV4ZXJzLmxlbmd0aCAqIDMyKQogIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCwgYnVmZmVyIH0KCiAgYy51aW50NjQuZW5jb2RlKHN0YXRlLCBsZW5ndGgpCiAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgZW50cm9weSB8fCBHRU5FU0lTX0VOVFJPUFkpCiAgZm9yIChjb25zdCB7IGtleSB9IG9mIGluZGV4ZXJzKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBrZXkpCgogIHJldHVybiBjcnlwdG8uaGFzaChbTlNfRU5UUk9QWSwgYnVmZmVyXSkKfQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCgpjb25zdCBNQVhfV0FJVCA9IDIgKiA2MCAqIDEwMDAKY29uc3QgREVGQVVMVF9JTlRFUlZBTCA9IDEwICogMTAwMAoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBUaW1lciB7CiAgY29uc3RydWN0b3IoaGFuZGxlciwgaW50ZXJ2YWwsIG9wdHMgPSB7fSkgewogICAgdGhpcy5oYW5kbGVyID0gaGFuZGxlciB8fCBub29wCiAgICB0aGlzLmludGVydmFsID0gaW50ZXJ2YWwgfHwgREVGQVVMVF9JTlRFUlZBTAogICAgdGhpcy5saW1pdCA9IG9wdHMubGltaXQgfHwgTUFYX1dBSVQKCiAgICB0aGlzLl9leGVjdXRpbmcgPSBudWxsCgogICAgdGhpcy5fbGltaXQgPSByYW5kb20yb3ZlcjEodGhpcy5saW1pdCkKICAgIHRoaXMuX3RpbWVyID0gbnVsbAogICAgdGhpcy5fcmVzb2x2ZSA9IG51bGwKICAgIHRoaXMuX3N0YXJ0ID0gMAogICAgdGhpcy5fc3RvcHBlZCA9IGZhbHNlCiAgICB0aGlzLl9hc2FwID0gZmFsc2UKICAgIHRoaXMuX3N0YW5kYWxvbmUgPSBuZXcgU2V0KCkKCiAgICB0aGlzLl91bnJlZiA9IG9wdHMudW5yZWYgIT09IGZhbHNlCiAgICB0aGlzLl90aW1lckNhbGxiYWNrID0gdGhpcy5fZXhlY3V0ZUJhY2tncm91bmQuYmluZCh0aGlzKQogIH0KCiAgX2V4ZWN1dGVCYWNrZ3JvdW5kKCkgewogICAgdGhpcy5fZXhlY3V0aW5nID0gdGhpcy5fZXhlY3V0ZSgpCiAgICB0aGlzLl9leGVjdXRpbmcuY2F0Y2goc2FmZXR5Q2F0Y2gpIC8vIG1ha2Ugc3VyZSBpdCBkb2VzbnQgY3Jhc2ggaW4gdGhlIGJnCiAgfQoKICBhc3luYyBfZXhlY3V0ZSgpIHsKICAgIHRoaXMuX2FzYXAgPSBmYWxzZQogICAgYXdhaXQgdGhpcy5oYW5kbGVyKCkKICAgIHRoaXMuX3N0YXJ0ID0gMAogICAgdGhpcy5fZXhlY3V0aW5nID0gbnVsbAogICAgdGhpcy5idW1wKCkKICB9CgogIGJ1bXAoKSB7CiAgICBpZiAodGhpcy5fc3RvcHBlZCB8fCB0aGlzLl9leGVjdXRpbmcgfHwgdGhpcy5fYXNhcCkgcmV0dXJuCgogICAgaWYgKCF0aGlzLl9zdGFydCkgdGhpcy5fc3RhcnQgPSBEYXRlLm5vdygpCiAgICBlbHNlIGlmIChEYXRlLm5vdygpIC0gdGhpcy5fc3RhcnQgPiB0aGlzLl9saW1pdCkgcmV0dXJuCgogICAgY29uc3QgaW50ZXJ2YWwgPSByYW5kb20yb3ZlcjEodGhpcy5pbnRlcnZhbCkKCiAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZXIpCiAgICB0aGlzLl90aW1lciA9IHNldFRpbWVvdXQodGhpcy5fdGltZXJDYWxsYmFjaywgaW50ZXJ2YWwpCiAgICBpZiAodGhpcy5fdW5yZWYgJiYgdGhpcy5fdGltZXIudW5yZWYpIHRoaXMuX3RpbWVyLnVucmVmKCkKICB9CgogIGFzeW5jIHRyaWdnZXIoKSB7CiAgICBpZiAodGhpcy5fc3RvcHBlZCkgcmV0dXJuCiAgICBpZiAodGhpcy5fZXhlY3V0aW5nKSBhd2FpdCB0aGlzLl9leGVjdXRpbmcKICAgIGlmICh0aGlzLl9zdG9wcGVkKSByZXR1cm4KCiAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZXIpCiAgICB0aGlzLl90aW1lciA9IG51bGwKCiAgICB0aGlzLl9leGVjdXRlQmFja2dyb3VuZCgpCiAgICBhd2FpdCB0aGlzLl9leGVjdXRpbmcKICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgaWYgKHRoaXMuX2V4ZWN1dGluZykgYXdhaXQgdGhpcy5fZXhlY3V0aW5nCiAgfQoKICAvLyBidXNpbmVzcy1hcy11c3VhbAogIGJhdSgpIHsKICAgIGlmICghdGhpcy5fYXNhcCkgcmV0dXJuCiAgICB0aGlzLl9hc2FwID0gZmFsc2UKICAgIHRoaXMuYnVtcCgpCiAgfQoKICBhc2FwKCkgewogICAgaWYgKHRoaXMuX2FzYXApIHJldHVybgogICAgdGhpcy5fYXNhcCA9IHRydWUKCiAgICBjb25zdCBpbnRlcnZhbCA9IE1hdGguZmxvb3IoKE1hdGgucmFuZG9tKCkgKiB0aGlzLmludGVydmFsKSAvIDMpCiAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZXIpCiAgICB0aGlzLl90aW1lciA9IHNldFRpbWVvdXQodGhpcy5fdGltZXJDYWxsYmFjaywgaW50ZXJ2YWwpCiAgICBpZiAodGhpcy5fdW5yZWYgJiYgdGhpcy5fdGltZXIudW5yZWYpIHRoaXMuX3RpbWVyLnVucmVmKCkKICB9CgogIHN0b3AoKSB7CiAgICBpZiAodGhpcy5fdGltZXIpIGNsZWFyVGltZW91dCh0aGlzLl90aW1lcikKICAgIHRoaXMuX3RpbWVyID0gbnVsbAogICAgdGhpcy5fc3RhcnQgPSAwCiAgICB0aGlzLl9hc2FwID0gZmFsc2UKICAgIHRoaXMuX3N0b3BwZWQgPSB0cnVlCgogICAgZm9yIChjb25zdCB7IHRpbWVyLCByZXNvbHZlIH0gb2YgdGhpcy5fc3RhbmRhbG9uZSkgewogICAgICBjbGVhclRpbWVvdXQodGltZXIpCiAgICAgIHJlc29sdmUoKQogICAgfQoKICAgIHRoaXMuX3N0YW5kYWxvbmUuY2xlYXIoKQogIH0KCiAgYXNhcFN0YW5kYWxvbmUoKSB7CiAgICBjb25zdCBpbnRlcnZhbCA9IE1hdGguZmxvb3IoKE1hdGgucmFuZG9tKCkgKiB0aGlzLmludGVydmFsKSAvIDMpCiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgY29uc3QgcmVmID0geyB0aW1lcjogbnVsbCwgcmVzb2x2ZSB9CiAgICAgIHJlZi50aW1lciA9IHNldFRpbWVvdXQocmVzb2x2ZVN0YW5kYWxvbmUsIGludGVydmFsLCByZWYsIHRoaXMuX3N0YW5kYWxvbmUpCiAgICAgIGlmIChyZWYudGltZXIudW5yZWYpIHJlZi50aW1lci51bnJlZigpCiAgICAgIHRoaXMuX3N0YW5kYWxvbmUuYWRkKHJlZikKICAgIH0pCiAgfQoKICB1bnJlZigpIHsKICAgIGlmICh0aGlzLl90aW1lciAmJiB0aGlzLl90aW1lci51bnJlZikgdGhpcy5fdGltZXIudW5yZWYoKQogIH0KfQoKZnVuY3Rpb24gcmVzb2x2ZVN0YW5kYWxvbmUocmVmLCBzZXQpIHsKICBzZXQuZGVsZXRlKHJlZikKICByZWYucmVzb2x2ZSgpCn0KCi8vIHJhbmRvbSB2YWx1ZSB4IGJldHdlZW4gbiA8PSB4IDwgMm4KZnVuY3Rpb24gcmFuZG9tMm92ZXIxKG4pIHsKICByZXR1cm4gTWF0aC5mbG9vcihuICsgTWF0aC5yYW5kb20oKSAqIG4pCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBhc3NlcnQgPSByZXF1aXJlKCduYW5vYXNzZXJ0JykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVG9wb0xpc3QgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy50aXAgPSBbXQogICAgdGhpcy51bmRvID0gMAogICAgdGhpcy5zaGFyZWQgPSAwCiAgfQoKICBzdGF0aWMgY29tcGFyZShhLCBiKSB7CiAgICByZXR1cm4gY21wKGEsIGIpCiAgfQoKICBzdGF0aWMgYWRkKG5vZGUsIGluZGV4ZWQsIG9mZnNldCkgewogICAgYWRkU29ydGVkKG5vZGUsIGluZGV4ZWQsIG9mZnNldCkKICB9CgogIG1hcmsoKSB7CiAgICB0aGlzLnNoYXJlZCA9IHRoaXMudGlwLmxlbmd0aAogICAgdGhpcy51bmRvID0gMAogIH0KCiAgLy8gdG9kbzogYnVtcCB0byBuZXcgYXBpIHRoYXQganVzdCB0cmFja3MgdW5kbwogIGZsdXNoKGluZGV4ZWQgPSBbXSkgewogICAgaWYgKGluZGV4ZWQubGVuZ3RoKSB0aGlzLl9hcHBseUluZGV4ZWQoaW5kZXhlZCkKCiAgICBjb25zdCB1ID0gewogICAgICBzaGFyZWQ6IHRoaXMuc2hhcmVkLAogICAgICB1bmRvOiB0aGlzLnVuZG8sCiAgICAgIGxlbmd0aDogaW5kZXhlZC5sZW5ndGggKyB0aGlzLnRpcC5sZW5ndGgsCiAgICAgIGluZGV4ZWQsCiAgICAgIHRpcDogdGhpcy50aXAKICAgIH0KCiAgICB0aGlzLm1hcmsoKQoKICAgIHJldHVybiB1CiAgfQoKICBwcmludCgpIHsKICAgIHJldHVybiB0aGlzLnRpcC5tYXAoKG4pID0+IG4ud3JpdGVyLmNvcmUua2V5LnRvU3RyaW5nKCkgKyBuLmxlbmd0aCkKICB9CgogIF9hcHBseUluZGV4ZWQobm9kZXMpIHsKICAgIGFzc2VydChub2Rlcy5sZW5ndGggPD0gdGhpcy50aXAubGVuZ3RoLCAnSW5kZXhlZCBiYXRjaCBjYW5ub3QgZXhjZWVkIHRpcCcpCgogICAgbGV0IHNoYXJlZCA9IDAKCiAgICBmb3IgKDsgc2hhcmVkIDwgbm9kZXMubGVuZ3RoOyBzaGFyZWQrKykgewogICAgICBpZiAodGhpcy50aXBbc2hhcmVkXSAhPT0gbm9kZXNbc2hhcmVkXSkgYnJlYWsKICAgIH0KCiAgICAvLyByZW9yZGVyaW5nCiAgICBpZiAoc2hhcmVkIDwgbm9kZXMubGVuZ3RoKSB0aGlzLl90cmFjayhzaGFyZWQpCgogICAgY29uc3QgdGlwID0gW10KCiAgICBmb3IgKGxldCBpID0gc2hhcmVkOyBpIDwgdGhpcy50aXAubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qgbm9kZSA9IHRoaXMudGlwW2ldCiAgICAgIGlmIChub2RlLnlpZWxkZWQpIGNvbnRpbnVlCiAgICAgIGNvbnN0IHMgPSBhZGRTb3J0ZWQobm9kZSwgdGlwLCAwKQogICAgICBpZiAocyA9PT0gdGlwLmxlbmd0aCAtIDEpIGNvbnRpbnVlCiAgICAgIHRoaXMuX3RyYWNrKHNoYXJlZCArIHMpCiAgICB9CgogICAgdGhpcy50aXAgPSB0aXAKICB9CgogIGFkZChub2RlKSB7CiAgICBjb25zdCBzaGFyZWQgPSBhZGRTb3J0ZWQobm9kZSwgdGhpcy50aXAsIDApCiAgICB0aGlzLl90cmFjayhzaGFyZWQpCiAgfQoKICBfdHJhY2soc2hhcmVkKSB7CiAgICBpZiAoc2hhcmVkIDwgdGhpcy5zaGFyZWQpIHsKICAgICAgdGhpcy51bmRvICs9IHRoaXMuc2hhcmVkIC0gc2hhcmVkCiAgICAgIHRoaXMuc2hhcmVkID0gc2hhcmVkCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBoYXNPcHRpbWlzdGljRGVwcyhub2RlKSB7CiAgZm9yIChjb25zdCBkIG9mIG5vZGUuZGVwZW5kZW5jaWVzKSB7CiAgICBpZiAoZC5vcHRpbWlzdGljKSByZXR1cm4gdHJ1ZQogIH0KICByZXR1cm4gZmFsc2UKfQoKLy8gdGhpcyBjYW4gYmUgb3B0aW1pc2VkIHRvIG9ubHkgcmV0dXJuIG9wdGltaXN0aWMgbm9kZXMgdGhhdCB3ZSB3aWxsICJ0b3VjaCIgd2hlbiBtb3ZpbmcgZG93biB0aGUgbm9kZQpmdW5jdGlvbiBnZXRPcHRpbWlzdGljRGVwcyhub2RlLCBsaXN0KSB7CiAgY29uc3QgZGVwcyA9IG5ldyBTZXQoKQogIGNvbnN0IHN0YWNrID0gW25vZGVdCgogIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7CiAgICBjb25zdCBuZXh0ID0gc3RhY2sucG9wKCkKICAgIGlmIChkZXBzLmhhcyhuZXh0KSkgY29udGludWUKICAgIGlmIChuZXh0Lm9wdGltaXN0aWMgJiYgbmV4dCAhPT0gbm9kZSkgZGVwcy5hZGQobmV4dCkKICAgIGZvciAoY29uc3QgZCBvZiBuZXh0LmRlcGVuZGVuY2llcykgewogICAgICBpZiAoZC5vcHRpbWlzdGljKSBzdGFjay5wdXNoKGQpCiAgICB9CiAgfQoKICBjb25zdCByZXN1bHQgPSBbXQoKICBmb3IgKGxldCBpID0gbGlzdC5sZW5ndGggLSAxOyBkZXBzLnNpemUgIT09IHJlc3VsdC5sZW5ndGggJiYgaSA+PSAwOyBpLS0pIHsKICAgIGNvbnN0IG4gPSBsaXN0W2ldCiAgICBpZiAoZGVwcy5oYXMobikpIHJlc3VsdC5wdXNoKG4pCiAgfQoKICByZXR1cm4gcmVzdWx0LnJldmVyc2UoKQp9CgpmdW5jdGlvbiBhZGRTb3J0ZWRPcHRpbWlzdGljKG5vZGUsIGxpc3QsIG9mZnNldCkgewogIGNvbnN0IG9wdCA9IGdldE9wdGltaXN0aWNEZXBzKG5vZGUsIGxpc3QpCiAgY29uc3QgcG9zID0gbmV3IFVpbnQzMkFycmF5KG9wdC5sZW5ndGgpCgogIGZvciAobGV0IGkgPSAwOyBpIDwgb3B0Lmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBuID0gb3B0W2ldCiAgICBwb3NbaV0gPSBuLmluZGV4CiAgICBtb3ZlRG93bihuLCBsaXN0LCBvZmZzZXQpCiAgfQoKICBtb3ZlRG93bkFuZFVwKG5vZGUsIGxpc3QsIG9mZnNldCkKCiAgZm9yIChsZXQgaSA9IG9wdC5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgbW92ZU9wdGltaXN0aWNVcChvcHRbaV0sIGxpc3QsIG9mZnNldCkKICB9CgogIGxldCBzaGFyZWQgPSBub2RlLmluZGV4CgogIGZvciAobGV0IGkgPSAwOyBpIDwgb3B0Lmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBpZHggPSBwb3NbaV0KICAgIGNvbnN0IG4gPSBvcHRbaV0KCiAgICBpZiAoaWR4ID09PSBuLmluZGV4KSBjb250aW51ZQoKICAgIGlmIChpZHggPCBzaGFyZWQpIHNoYXJlZCA9IGlkeAogICAgaWYgKG4uaW5kZXggPCBzaGFyZWQpIHNoYXJlZCA9IG4uaW5kZXgKICB9CgogIHJldHVybiBzaGFyZWQKfQoKZnVuY3Rpb24gYWRkU29ydGVkKG5vZGUsIGxpc3QsIG9mZnNldCkgewogIGxpc3QucHVzaChub2RlKQogIG5vZGUuaW5kZXggPSBsaXN0Lmxlbmd0aCAtIDEKCiAgLy8gInNsb3ciIHBhdGgsIDElIG9mIG5vZGVzCiAgaWYgKGhhc09wdGltaXN0aWNEZXBzKG5vZGUpKSByZXR1cm4gYWRkU29ydGVkT3B0aW1pc3RpYyhub2RlLCBsaXN0LCBvZmZzZXQpCgogIG1vdmVEb3duQW5kVXAobm9kZSwgbGlzdCwgb2Zmc2V0KQogIHJldHVybiBub2RlLmluZGV4Cn0KCmZ1bmN0aW9uIG1vdmVEb3duKG5vZGUsIGxpc3QsIG9mZnNldCkgewogIHdoaWxlIChub2RlLmluZGV4ID4gb2Zmc2V0KSB7CiAgICBjb25zdCBwcmV2ID0gbGlzdFtub2RlLmluZGV4IC0gMV0KICAgIGlmIChsaW5rcyhub2RlLCBwcmV2KSkgYnJlYWsKICAgIGxpc3RbKHByZXYuaW5kZXggPSBub2RlLmluZGV4KV0gPSBwcmV2CiAgICBsaXN0Wy0tbm9kZS5pbmRleF0gPSBub2RlCiAgfQp9CgpmdW5jdGlvbiBtb3ZlT3B0aW1pc3RpY1VwKG5vZGUsIGxpc3QsIG9mZnNldCkgewogIC8vIGlmIG9wdGltaXN0aWMgbW92ZSBhbGwgdGhlIHdheSB1cAogIHdoaWxlIChub2RlLmluZGV4IDwgbGlzdC5sZW5ndGggLSAxKSB7CiAgICBjb25zdCBuZXh0ID0gbGlzdFtub2RlLmluZGV4ICsgMV0KICAgIGlmIChsaW5rcyhuZXh0LCBub2RlKSkgYnJlYWsKICAgIGxpc3RbKG5leHQuaW5kZXggPSBub2RlLmluZGV4KV0gPSBuZXh0CiAgICBsaXN0Wysrbm9kZS5pbmRleF0gPSBub2RlCiAgfQoKICAvLyBzdGFibGUgc29ydCBpbiBjYXNlIG11bHRpcGxlIGNoaWxkcmVuCiAgd2hpbGUgKG5vZGUuaW5kZXggPiBvZmZzZXQpIHsKICAgIGNvbnN0IHByZXYgPSBsaXN0W25vZGUuaW5kZXggLSAxXQogICAgaWYgKCFwcmV2Lm9wdGltaXN0aWMpIGJyZWFrCiAgICBjb25zdCBjID0gY21wKHByZXYsIG5vZGUpCiAgICBpZiAoYyA8PSAwKSBicmVhawogICAgbGlzdFsocHJldi5pbmRleCA9IG5vZGUuaW5kZXgpXSA9IHByZXYKICAgIGxpc3RbLS1ub2RlLmluZGV4XSA9IG5vZGUKICB9Cn0KCmZ1bmN0aW9uIG1vdmVOb25PcHRpbWlzdGljVXAobm9kZSwgbGlzdCwgb2Zmc2V0KSB7CiAgLy8gc3RhYmxlIHNvcnQgYWdhaW5zdCBuZXh0IG5vbiBvcHRpbWlzdGljIG5vZGUKICB3aGlsZSAobm9kZS5pbmRleCA8IGxpc3QubGVuZ3RoIC0gMSkgewogICAgY29uc3QgbmV4dCA9IGxpc3Rbbm9kZS5pbmRleCArIDFdCiAgICBjb25zdCBjID0gY21wTm9uT3B0aW1pc3RpYyhub2RlLCBuZXh0LCBsaXN0KQogICAgaWYgKGMgPD0gMCkgYnJlYWsKICAgIGxpc3RbKG5leHQuaW5kZXggPSBub2RlLmluZGV4KV0gPSBuZXh0CiAgICBsaXN0Wysrbm9kZS5pbmRleF0gPSBub2RlCiAgfQp9CgpmdW5jdGlvbiBtb3ZlRG93bkFuZFVwKG5vZGUsIGxpc3QsIG9mZnNldCkgewogIG1vdmVEb3duKG5vZGUsIGxpc3QsIG9mZnNldCkKCiAgaWYgKG5vZGUub3B0aW1pc3RpYykgbW92ZU9wdGltaXN0aWNVcChub2RlLCBsaXN0LCBvZmZzZXQpCiAgZWxzZSBtb3ZlTm9uT3B0aW1pc3RpY1VwKG5vZGUsIGxpc3QsIG9mZnNldCkKfQoKZnVuY3Rpb24gbGlua3MoYSwgYikgewogIGlmIChiLmRlcGVuZGVudHMuaGFzKGEpKSByZXR1cm4gdHJ1ZQogIHJldHVybiBhLmxlbmd0aCA+IDAgJiYgYi5sZW5ndGggPT09IGEubGVuZ3RoIC0gMSAmJiBhLndyaXRlciA9PT0gYi53cml0ZXIKfQoKZnVuY3Rpb24gY21wTm9uT3B0aW1pc3RpYyhhLCBiLCBsaXN0KSB7CiAgaWYgKCFiLm9wdGltaXN0aWMpIHJldHVybiBjbXAoYSwgYikKCiAgZm9yIChsZXQgaSA9IGIuaW5kZXggKyAxOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgY29uc3Qgbm9kZSA9IGxpc3RbaV0KICAgIGlmICghbm9kZS5vcHRpbWlzdGljKSByZXR1cm4gY21wKGEsIG5vZGUpCiAgfQoKICByZXR1cm4gLTEKfQoKZnVuY3Rpb24gY21wKGEsIGIpIHsKICByZXR1cm4gbGlua3MoYiwgYSkgPyAtMSA6IGNtcFVubGlua2VkKGEsIGIpCn0KCmZ1bmN0aW9uIGNtcFVubGlua2VkKGEsIGIpIHsKICBjb25zdCBjID0gYjRhLmNvbXBhcmUoYS53cml0ZXIuY29yZS5rZXksIGIud3JpdGVyLmNvcmUua2V5KQogIHJldHVybiBjID09PSAwID8gKGEubGVuZ3RoIDwgYi5sZW5ndGggPyAtMSA6IDEpIDogYwp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVXBkYXRlQ2hhbmdlcyB7CiAgY29uc3RydWN0b3IoYmFzZSkgewogICAgdGhpcy5iYXNlID0gYmFzZQogICAgdGhpcy5ieU5hbWUgPSBuZXcgTWFwKCkKICAgIHRoaXMudHJhY2tpbmcgPSBudWxsCiAgfQoKICBnZXQgZGlzY292ZXJ5S2V5KCkgewogICAgcmV0dXJuIHRoaXMuYmFzZS5kaXNjb3ZlcnlLZXkKICB9CgogIGdldCBrZXkoKSB7CiAgICByZXR1cm4gdGhpcy5iYXNlLmtleQogIH0KCiAgZ2V0IGlkKCkgewogICAgcmV0dXJuIHRoaXMuYmFzZS5pZAogIH0KCiAgZ2V0IHN5c3RlbSgpIHsKICAgIHJldHVybiB0aGlzLmJhc2Uuc3lzdGVtCiAgfQoKICB0cmFjayhzdGF0ZSkgewogICAgdGhpcy50cmFja2luZyA9IFtdCiAgICB0aGlzLmJ5TmFtZS5jbGVhcigpCgogICAgaWYgKCFzdGF0ZSkgcmV0dXJuCgogICAgZm9yIChjb25zdCB2IG9mIHN0YXRlLnZpZXdzKSB7CiAgICAgIGlmICh2LnJlZikgdGhpcy5fYWRkKHYucmVmKQogICAgfQoKICAgIHRoaXMuX2FkZChzdGF0ZS5zeXN0ZW1WaWV3LnJlZikKICAgIHRoaXMuX2FkZChzdGF0ZS5lbmNyeXB0aW9uVmlldy5yZWYpCiAgfQoKICBfYWRkKHJlZikgewogICAgdGhpcy50cmFja2luZy5wdXNoKHsgcmVmLCBmcm9tOiByZWYuYXRvbWljQmF0Y2ggPyByZWYuYXRvbWljQmF0Y2gubGVuZ3RoIDogMCB9KQogIH0KCiAgZmluYWxpc2UoKSB7CiAgICBpZiAodGhpcy50cmFja2luZyA9PT0gbnVsbCkgcmV0dXJuCgogICAgZm9yIChjb25zdCB7IHJlZiwgZnJvbSB9IG9mIHRoaXMudHJhY2tpbmcpIHsKICAgICAgY29uc3QgY29yZSA9IHJlZi5hdG9taWNCYXRjaCB8fCByZWYuYmF0Y2gKICAgICAgY29uc3QgdHJ1bmMgPSByZWYuYXRvbWljQmF0Y2ggPyByZWYuYXRvbWljQmF0Y2guc3RhdGUubGFzdFRydW5jYXRpb24gOiBudWxsCgogICAgICB0aGlzLmJ5TmFtZS5zZXQocmVmLm5hbWUsIHsKICAgICAgICBmcm9tLAogICAgICAgIHRvOiBjb3JlID8gY29yZS5sZW5ndGggOiBmcm9tLAogICAgICAgIHNoYXJlZDogdHJ1bmMgPyB0cnVuYy50byA6IGZyb20KICAgICAgfSkKICAgIH0KCiAgICB0aGlzLnRyYWNraW5nID0gbnVsbAogIH0KCiAgZ2V0KG5hbWUpIHsKICAgIHJldHVybiB0aGlzLmJ5TmFtZS5nZXQobmFtZSkKICB9Cn0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IHsgT1BMT0dfVkVSU0lPTiB9ID0gcmVxdWlyZSgnLi9jYXBzLmpzJykKY29uc3QgeyBPcGxvZ01lc3NhZ2UgfSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMuanMnKQpjb25zdCB7IEVuY3J5cHRpb25WaWV3IH0gPSByZXF1aXJlKCcuL2VuY3J5cHRpb24uanMnKQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgZW5jb2RlVmFsdWUsCiAgZGVjb2RlVmFsdWUKfQoKZnVuY3Rpb24gZW5jb2RlVmFsdWUodmFsdWUsIG9wdHMgPSB7fSkgewogIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiAwLCBidWZmZXI6IG51bGwgfQoKICBjb25zdCBtZXNzYWdlID0gewogICAgdmVyc2lvbjogb3B0cy52ZXJzaW9uIHx8IE9QTE9HX1ZFUlNJT04sCiAgICBkaWdlc3Q6IG51bGwsCiAgICBjaGVja3BvaW50OiBudWxsLAogICAgb3B0aW1pc3RpYzogISFvcHRzLm9wdGltaXN0aWMsCiAgICBub2RlOiB7CiAgICAgIGhlYWRzOiBvcHRzLmhlYWRzIHx8IFtdLAogICAgICBiYXRjaDogMSwKICAgICAgdmFsdWUKICAgIH0KICB9CgogIE9wbG9nTWVzc2FnZS5wcmVlbmNvZGUoc3RhdGUsIG1lc3NhZ2UpCgogIGlmIChvcHRzLnBhZGRpbmcpIHsKICAgIHN0YXRlLnN0YXJ0ID0gb3B0cy5wYWRkaW5nCiAgICBzdGF0ZS5lbmQgKz0gb3B0cy5wYWRkaW5nCiAgfQoKICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2Moc3RhdGUuZW5kKQoKICBPcGxvZ01lc3NhZ2UuZW5jb2RlKHN0YXRlLCBtZXNzYWdlKQoKICBpZiAoIW9wdHMuZW5jcnlwdGVkKSByZXR1cm4gc3RhdGUuYnVmZmVyCgogIGlmICghb3B0cy5vcHRpbWlzdGljKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY29kaW5nIGFuIGVuY3J5cHRlZCB2YWx1ZSBpcyBub3Qgc3VwcG9ydGVkJykKICB9CgogIGNvbnN0IHBhZGRpbmcgPSBiNGEuYWxsb2MoMTYpIC8vIG1pbiBoYXNoIGxlbmd0aCBpcyAxNgogIGNyeXB0by5oYXNoKHN0YXRlLmJ1ZmZlciwgcGFkZGluZykKICBwYWRkaW5nWzBdID0gMAoKICByZXR1cm4gYjRhLmNvbmNhdChbcGFkZGluZy5zdWJhcnJheSgwLCA4KSwgc3RhdGUuYnVmZmVyXSkKfQoKYXN5bmMgZnVuY3Rpb24gZGVjb2RlVmFsdWUodmFsdWUsIHsgYXV0b2Jhc2UsIGVuY3J5cHRpb25LZXksIGtleSwgbWFuaWZlc3QsIGluZGV4ID0gMCB9ID0ge30pIHsKICBpZiAoZW5jcnlwdGlvbktleSkgewogICAgY29uc3QgZSA9IG5ldyBFbmNyeXB0aW9uVmlldyh7IGVuY3J5cHRpb25LZXksIGJvb3RzdHJhcDogYXV0b2Jhc2UgfSkKICAgIGNvbnN0IHcgPSBlLmdldFdyaXRlckVuY3J5cHRpb24oKQoKICAgIGF3YWl0IHcuZGVjcnlwdChpbmRleCwgdmFsdWUsIHsga2V5LCBtYW5pZmVzdCB9KQogICAgdmFsdWUgPSB2YWx1ZS5zdWJhcnJheSg4KQogIH0KCiAgY29uc3Qgb3AgPSBjLmRlY29kZShPcGxvZ01lc3NhZ2UsIHZhbHVlKQogIHJldHVybiBvcC5ub2RlLnZhbHVlCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCgpjb25zdCBXYWtldXBFbnRyeSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGtleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQXV0b1dha2V1cCBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yKGJhc2UpIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgICB0aGlzLmZsdXNoaW5nID0gbnVsbAoKICAgIHRoaXMuX3Jvb3RTdG9yZSA9IHRoaXMuYmFzZS5zdG9yZQogICAgdGhpcy5fYWRkQm91bmQgPSB0aGlzLmFkZC5iaW5kKHRoaXMpCiAgICB0aGlzLl9wcmV1cGRhdGVCb3VuZCA9IHRoaXMuX3ByZXVwZGF0ZS5iaW5kKHRoaXMpCiAgICB0aGlzLl9uZWVkc0ZsdXNoID0gZmFsc2UKICAgIHRoaXMuX21hcCA9IG5ldyBNYXAoKQogIH0KCiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy5fbWFwLnZhbHVlcygpCiAgfQoKICBhc3luYyBfcHJldXBkYXRlKGJhdGNoLCBrZXkpIHsKICAgIHRoaXMucXVldWUoa2V5LCBiYXRjaC5sZW5ndGgpCiAgICBhd2FpdCB0aGlzLmZsdXNoKCkKICAgIHRoaXMuYmFzZS5fb253YWtldXAoKQogIH0KCiAgYXN5bmMgX3NhdmUoKSB7CiAgICBjb25zdCBzbGFiID0gYjRhLmFsbG9jVW5zYWZlKDggKyB0aGlzLl9tYXAuc2l6ZSAqIDQwKSAvLyAzMiArIDgKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiAwLCBidWZmZXI6IHNsYWIgfQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHRoaXMuX21hcC5zaXplKQogICAgZm9yIChjb25zdCBtIG9mIHRoaXMuX21hcC52YWx1ZXMoKSkgV2FrZXVwRW50cnkuZW5jb2RlKHN0YXRlLCBtKQoKICAgIGF3YWl0IHRoaXMuYmFzZS5sb2NhbC5zZXRVc2VyRGF0YSgnYXV0b2Jhc2Uvd2FrZXVwJywgc2xhYi5zdWJhcnJheSgwLCBzdGF0ZS5zdGFydCkpCiAgfQoKICBhc3luYyBfbG9hZCgpIHsKICAgIGNvbnN0IGJ1ZmZlciA9IGF3YWl0IHRoaXMuYmFzZS5sb2NhbC5nZXRVc2VyRGF0YSgnYXV0b2Jhc2Uvd2FrZXVwJykKICAgIGlmICghYnVmZmVyKSByZXR1cm4KCiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGgsIGJ1ZmZlciB9CgogICAgbGV0IGxlbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB3aGlsZSAobGVuLS0gPiAwKSB7CiAgICAgIGNvbnN0IG0gPSBXYWtldXBFbnRyeS5kZWNvZGUoc3RhdGUpCiAgICAgIHRoaXMuX21hcC5zZXQoYjRhLnRvU3RyaW5nKG0ua2V5LCAnaGV4JyksIG0pCiAgICB9CiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIGF3YWl0IHRoaXMuX2xvYWQoKQoKICAgIHRoaXMuX3Jvb3RTdG9yZS53YXRjaCh0aGlzLl9hZGRCb3VuZCkKCiAgICBmb3IgKGNvbnN0IGNvcmUgb2YgdGhpcy5fcm9vdFN0b3JlLmNvcmVzKSB7CiAgICAgIGlmIChjb3JlLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IGNvcmUucmVhZHkoKS5jYXRjaChub29wKQogICAgICBpZiAoIWNvcmUuY2xvc2luZykgdGhpcy5hZGQoY29yZSkKICAgIH0KICB9CgogIGFzeW5jIF9jbG9zZSgpIHsKICAgIHRoaXMuX3Jvb3RTdG9yZS51bndhdGNoKHRoaXMuX2FkZEJvdW5kKQoKICAgIGZvciAoY29uc3QgY29yZSBvZiB0aGlzLl9yb290U3RvcmUuY29yZXMpIHsKICAgICAgaWYgKGNvcmUub3BlbmVkICYmICFjb3JlLmNsb3NpbmcpIHRoaXMucmVtb3ZlKGNvcmUpCiAgICB9CgogICAgdGhpcy5fbWFwLmNsZWFyKCkKCiAgICB3aGlsZSAodGhpcy5mbHVzaGluZykgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuZmx1c2hpbmcKICAgICAgfSBjYXRjaCB7fQogICAgfQogIH0KCiAgcXVldWUoa2V5LCBsZW5ndGgpIHsKICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQogICAgY29uc3QgbSA9IHRoaXMuX21hcC5nZXQoaGV4KQoKICAgIGlmIChtICYmIG0ubGVuZ3RoID4gbGVuZ3RoKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIHRoaXMuX25lZWRzRmx1c2ggPSB0cnVlCiAgICB0aGlzLl9tYXAuc2V0KGhleCwgeyBrZXksIGxlbmd0aCB9KQoKICAgIHJldHVybiB0cnVlCiAgfQoKICB1bnF1ZXVlKGtleSwgbGVuZ3RoKSB7CiAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykKICAgIGNvbnN0IG0gPSB0aGlzLl9tYXAuZ2V0KGhleCkKCiAgICBpZiAoIW0pIHJldHVybiB0cnVlCiAgICBpZiAobS5sZW5ndGggPiBsZW5ndGgpIHJldHVybiBmYWxzZQoKICAgIHRoaXMuX25lZWRzRmx1c2ggPSB0cnVlCiAgICB0aGlzLl9tYXAuZGVsZXRlKGhleCkKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgZmx1c2goKSB7CiAgICBpZiAodGhpcy5jbG9zaW5nKSB0aHJvdyBuZXcgRXJyb3IoJ0Nsb3NpbmcnKQoKICAgIC8vIHdhaXQgZm9yIHNvbWVvbmUKICAgIGlmICh0aGlzLmZsdXNoaW5nKSBhd2FpdCB0aGlzLmZsdXNoaW5nCgogICAgLy8gaWYgYW5vdGhlciBzdGlsbCBhY3RpdmUgdGhleSBmbHVzaGVkIHVzCiAgICBpZiAodGhpcy5mbHVzaGluZykgcmV0dXJuIHRoaXMuZmx1c2hpbmcKCiAgICBpZiAodGhpcy5fbmVlZHNGbHVzaCA9PT0gZmFsc2UpIHJldHVybgogICAgdGhpcy5fbmVlZHNGbHVzaCA9IGZhbHNlCgogICAgdHJ5IHsKICAgICAgdGhpcy5mbHVzaGluZyA9IHRoaXMuX3NhdmUoKQogICAgICByZXR1cm4gYXdhaXQgdGhpcy5mbHVzaGluZwogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5mbHVzaGluZyA9IG51bGwKICAgIH0KICB9CgogIGFkZChjb3JlKSB7CiAgICByZXR1cm4gdGhpcy5fYWRkKGNvcmUpLmNhdGNoKHNhZmV0eUNhdGNoKQogIH0KCiAgcmVtb3ZlKGNvcmUpIHsKICAgIHJldHVybiB0aGlzLl9yZW1vdmUoY29yZSkKICB9CgogIGFzeW5jIF9hZGQoY29yZSkgewogICAgaWYgKGNvcmUub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgY29yZS5yZWFkeSgpCiAgICBpZiAoY29yZS5jbG9zaW5nKSByZXR1cm4gZmFsc2UKCiAgICAvLyBsb2NhbCB3cml0ZXIsIG5vIG5lZWQKICAgIGlmIChjb3JlID09PSB0aGlzLmJhc2UubG9jYWwuY29yZSkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgcnggPSBjb3JlLnN0b3JhZ2UucmVhZCgpCgogICAgY29uc3QgcmVmZXJyZXJQcm9taXNlID0gcnguZ2V0VXNlckRhdGEoJ3JlZmVycmVyJykKICAgIGNvbnN0IHZpZXdQcm9taXNlID0gcnguZ2V0VXNlckRhdGEoJ2F1dG9iYXNlL3ZpZXcnKQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBbcmVmZXJyZXIsIHZpZXddID0gYXdhaXQgUHJvbWlzZS5hbGwoW3JlZmVycmVyUHJvbWlzZSwgdmlld1Byb21pc2VdKQogICAgaWYgKHZpZXcpIHJldHVybiBmYWxzZQoKICAgIGlmIChyZWZlcnJlciA9PT0gbnVsbCB8fCAhYjRhLmVxdWFscyhyZWZlcnJlciwgdGhpcy5iYXNlLmtleSkpIHJldHVybiBmYWxzZQoKICAgIGNvcmUucHJldXBkYXRlID0gdGhpcy5fcHJldXBkYXRlQm91bmQKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3JlbW92ZShjb3JlKSB7CiAgICBpZiAoY29yZS5wcmV1cGRhdGUgIT09IHRoaXMuX3ByZXVwZGF0ZUJvdW5kKSByZXR1cm4gZmFsc2UKICAgIGNvcmUucHJldXBkYXRlID0gbnVsbAogICAgcmV0dXJuIHRydWUKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ25hbm9hc3NlcnQnKQpjb25zdCBTaWduYWxQcm9taXNlID0gcmVxdWlyZSgnc2lnbmFsLXByb21pc2UnKQoKY29uc3QgTGluZWFyaXplciA9IHJlcXVpcmUoJy4vbGluZWFyaXplci5qcycpCmNvbnN0IE5vZGVCdWZmZXIgPSByZXF1aXJlKCcuL25vZGUtYnVmZmVyLmpzJykKCmNvbnN0IE1BWF9QUkVMT0FEID0gNApjb25zdCBNQVhfUFJFRkVUQ0ggPSAyNTYKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgV3JpdGVyIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IoYmFzZSwgY29yZSwgbGVuZ3RoLCBpc1JlbW92ZWQpIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICB0aGlzLmlzUmVtb3ZlZCA9IGlzUmVtb3ZlZAogICAgdGhpcy51cGRhdGVkID0gZmFsc2UKICAgIHRoaXMucmFuZ2UgPSBudWxsCiAgICB0aGlzLm5vZGVzID0gbmV3IE5vZGVCdWZmZXIobGVuZ3RoKQogICAgdGhpcy5ub2RlID0gbnVsbAogICAgdGhpcy5pc0FjdGl2ZSA9IGZhbHNlCiAgICB0aGlzLmlzQ3VycmVudGx5Q291cGxlZCA9IGZhbHNlCiAgICB0aGlzLmlzQ291cGxlZCA9IGZhbHNlIC8vIG1haW50YWluZWQgYnkgdXBkYXRlQm9vdHN0cmFwV3JpdGVycwogICAgdGhpcy5pc0Jvb3RzdHJhcCA9IGZhbHNlIC8vIG1haW50YWluZWQgYnkgdXBkYXRlQm9vdHN0cmFwV3JpdGVycwogICAgdGhpcy5pc0FjdGl2ZUluZGV4ZXIgPSBmYWxzZQogICAgdGhpcy5hdmFpbGFibGUgPSBsZW5ndGgKICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLnNlZW5MZW5ndGggPSAwCiAgICB0aGlzLnJlY292ZXIgPSBmYWxzZQogICAgdGhpcy5mcm96ZW4gPSBmYWxzZQoKICAgIHRoaXMuc3luY1NpZ25hbCA9IG51bGwKICB9CgogIF9wYXVzZSgpIHsKICAgIGlmICghdGhpcy5yYW5nZSkgcmV0dXJuCiAgICB0aGlzLnJhbmdlLmRlc3Ryb3koKQogICAgdGhpcy5yYW5nZSA9IG51bGwKICB9CgogIF9yZXN1bWUoKSB7CiAgICBpZiAodGhpcy5yYW5nZSkgewogICAgICAvLyBpZiB3ZSBkaWRudCBmaWxsIHVwIHRoZSBwcmVsb2FkIGJ1ZmZlciB5ZXQsIGRvIG5vdCBjb21taXQgdG8gbW9yZSB3b3JrCiAgICAgIGlmICh0aGlzLnJhbmdlLnJhbmdlLmVuZCA9PT0gdGhpcy5ub2Rlcy5sZW5ndGggKyBNQVhfUFJFRkVUQ0gpIHJldHVybgogICAgICB0aGlzLnJhbmdlLmRlc3Ryb3koKQogICAgfQogICAgdGhpcy5yYW5nZSA9IHRoaXMuY29yZS5kb3dubG9hZCh7CiAgICAgIHN0YXJ0OiB0aGlzLm5vZGVzLmxlbmd0aCwKICAgICAgZW5kOiB0aGlzLm5vZGVzLmxlbmd0aCArIE1BWF9QUkVGRVRDSCwKICAgICAgbGluZWFyOiB0cnVlCiAgICB9KQogIH0KCiAgX3VwZGF0ZUNvdXBsaW5nKCkgewogICAgaWYgKCF0aGlzLmJhc2UuX2NvdXBsZXIgfHwgdGhpcy5pc0NvdXBsZWQgPT09IHRoaXMuaXNDdXJyZW50bHlDb3VwbGVkKSByZXR1cm4KCiAgICBpZiAodGhpcy5pc0N1cnJlbnRseUNvdXBsZWQpIHRoaXMuYmFzZS5fY291cGxlci5yZW1vdmUodGhpcy5jb3JlKQogICAgZWxzZSB0aGlzLmJhc2UuX2NvdXBsZXIuYWRkKHRoaXMuY29yZSkKCiAgICB0aGlzLmlzQ3VycmVudGx5Q291cGxlZCA9IHRoaXMuaXNDb3VwbGVkCiAgfQoKICBfcmVtb3ZlQ291cGxlKCkgewogICAgaWYgKHRoaXMuYmFzZS5fY291cGxlciAmJiAhdGhpcy5pc0NvdXBsZWQgJiYgdGhpcy5pc0N1cnJlbnRseUNvdXBsZWQpIHsKICAgICAgdGhpcy5pc0N1cnJlbnRseUNvdXBsZWQgPSBmYWxzZQogICAgICB0aGlzLmJhc2UuX2NvdXBsZXIucmVtb3ZlKHRoaXMuY29yZSkKICAgIH0KICB9CgogIHVwZGF0ZUFjdGl2aXR5KCkgewogICAgaWYgKCF0aGlzLmNvcmUub3BlbmVkKSByZXR1cm4KCiAgICBpZiAodGhpcy5zZWVuTGVuZ3RoID4gdGhpcy5jb3JlLmxlbmd0aCB8fCB0aGlzLmxlbmd0aCA8IHRoaXMuY29yZS5sZW5ndGggfHwgdGhpcy5pc0Jvb3RzdHJhcCkgewogICAgICAvLyBpZiB3ZSBoYXZlIHNlZW4gYSBsYXRlciBjb3JlLCBvciBpZiB3ZSBhcmUgYmVoaW5kLCBvciBpZiBib290c3RyYXAKICAgICAgdGhpcy5pc0FjdGl2ZSA9IHRydWUKICAgICAgdGhpcy5jb3JlLnNldEFjdGl2ZSh0cnVlKQogICAgfSBlbHNlIGlmICh0aGlzLmxlbmd0aCA9PT0gdGhpcy5jb3JlLmxlbmd0aCkgewogICAgICAvLyB0aGluZ3MgbG9vayBzdGVhZHkKICAgICAgdGhpcy5pc0FjdGl2ZSA9IGZhbHNlCiAgICAgIHRoaXMuY29yZS5zZXRBY3RpdmUoZmFsc2UpCiAgICB9CgogICAgdGhpcy5fdXBkYXRlQ291cGxpbmcoKQoKICAgIGlmICh0aGlzLmNvcmUud3JpdGFibGUpIHJldHVybgoKICAgIGlmICh0aGlzLmJhc2UuaXNGYXN0Rm9yd2FyZGluZygpIHx8ICF0aGlzLmlzQWN0aXZlKSB7CiAgICAgIHRoaXMuX3BhdXNlKCkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3Jlc3VtZSgpCiAgICB9CiAgfQoKICBzZXRCb290c3RyYXAoYm9vbCkgewogICAgdGhpcy5pc0Jvb3RzdHJhcCA9IGJvb2wKICAgIHRoaXMudXBkYXRlQWN0aXZpdHkoKQogIH0KCiAgc2VlbihsZW5ndGgpIHsKICAgIGlmIChsZW5ndGggPiB0aGlzLnNlZW5MZW5ndGgpIHRoaXMuc2Vlbkxlbmd0aCA9IGxlbmd0aAogICAgdGhpcy51cGRhdGVBY3Rpdml0eSgpCiAgfQoKICB3YWl0Rm9yU3luY2VkKCkgewogICAgaWYgKHRoaXMuY29yZS5sZW5ndGggPT09IHRoaXMubGVuZ3RoKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKICAgIGlmICh0aGlzLnN5bmNTaWduYWwgPT09IG51bGwpIHRoaXMuc3luY1NpZ25hbCA9IG5ldyBTaWduYWxQcm9taXNlKCkKICAgIHJldHVybiB0aGlzLnN5bmNTaWduYWwud2FpdCgpCiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCiAgICBhd2FpdCB0aGlzLmNvcmUuc2V0VXNlckRhdGEoJ3JlZmVycmVyJywgdGhpcy5iYXNlLmtleSkKCiAgICAvLyBiYXNlIG1pZ2h0IGJlIGNsb3NpbmcgaGVyZQogICAgaWYgKHRoaXMuYmFzZS5jbG9zaW5nKSByZXR1cm4KCiAgICAvLyByZW1vdmUgbGF0ZXIKICAgIHRoaXMucmVjb3ZlciA9IGF1dG9SZWNvdmVyKHRoaXMuY29yZSkKCiAgICAvLyBhZGQgaXQgYWdhaW4gaW5jYXNlIGl0IHdhc24ndCByZWFkaWVkIGJlZm9yZSwgb25seSBuZWVkZWQgaWYgdGhpcyBpcyB0aGUgZmlyc3QgdGltZSB3ZSBzZXQgdGhlIHJlZmVycmVyLi4uCiAgICBhd2FpdCB0aGlzLmJhc2UuX3dha2V1cC5hZGQodGhpcy5jb3JlLmNvcmUpCgogICAgdGhpcy51cGRhdGVBY3Rpdml0eSgpCgogICAgaWYgKHRoaXMuY29yZS5sZW5ndGggPiB0aGlzLmxlbmd0aCkgdGhpcy5iYXNlLl9xdWV1ZUJ1bXAoKQoKICAgIHRoaXMuYmFzZS5lbWl0KCd3cml0ZXInLCB0aGlzKQogIH0KCiAgX2Nsb3NlKCkgewogICAgaWYgKHRoaXMuc3luY1NpZ25hbCAhPT0gbnVsbCkgdGhpcy5zeW5jU2lnbmFsLm5vdGlmeSgpCiAgICByZXR1cm4gdGhpcy5jb3JlLmNsb3NlKCkKICB9CgogIGdldCBpbmRleGVkKCkgewogICAgcmV0dXJuIHRoaXMubm9kZXMub2Zmc2V0CiAgfQoKICBpZGxlKCkgewogICAgcmV0dXJuIHRoaXMubGVuZ3RoID09PSB0aGlzLmF2YWlsYWJsZSAmJiB0aGlzLmxlbmd0aCA9PT0gdGhpcy5jb3JlLmxlbmd0aCAmJiB0aGlzLmNvcmUub3BlbmVkCiAgfQoKICBmbHVzaGVkKCkgewogICAgLy8gVE9ETzogcHJvcCBhIGNsZWFuZXIgd2F5IHRvIGV4cHJlc3MgdGhpcy4uLgogICAgcmV0dXJuICgKICAgICAgdGhpcy5zZWVuTGVuZ3RoIDw9IHRoaXMubGVuZ3RoICYmCiAgICAgIHRoaXMubGVuZ3RoID09PSB0aGlzLmF2YWlsYWJsZSAmJgogICAgICB0aGlzLmxlbmd0aCA9PT0gdGhpcy5jb3JlLmxlbmd0aCAmJgogICAgICB0aGlzLnNoaWZ0YWJsZSgpID09PSBmYWxzZSAmJgogICAgICAhdGhpcy5jb3JlLmNvcmUudXBncmFkaW5nICYmCiAgICAgIHRoaXMuY29yZS5vcGVuZWQKICAgICkKICB9CgogIGNvbXBhcmUod3JpdGVyKSB7CiAgICByZXR1cm4gYjRhLmNvbXBhcmUodGhpcy5jb3JlLmtleSwgd3JpdGVyLmNvcmUua2V5KQogIH0KCiAgaGVhZCgpIHsKICAgIHJldHVybiB0aGlzLm5vZGVzLmdldCh0aGlzLmxlbmd0aCAtIDEpCiAgfQoKICBhZHZhbmNlKCkgewogICAgaWYgKHRoaXMuc3luY1NpZ25hbCAhPT0gbnVsbCAmJiB0aGlzLmxlbmd0aCArIDEgPT09IHRoaXMuY29yZS5sZW5ndGgpIHRoaXMuc3luY1NpZ25hbC5ub3RpZnkoKQogICAgcmV0dXJuIHRoaXMubGVuZ3RoIDwgdGhpcy5hdmFpbGFibGUgPyB0aGlzLm5vZGVzLmdldCh0aGlzLmxlbmd0aCsrKSA6IG51bGwKICB9CgogIHNoaWZ0YWJsZSgpIHsKICAgIHJldHVybiB0aGlzLmxlbmd0aCA+IHRoaXMubm9kZXMub2Zmc2V0CiAgfQoKICBzaGlmdCgpIHsKICAgIGlmICh0aGlzLnNoaWZ0YWJsZSgpID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlCgogICAgbGV0IG5vZGUgPSB0aGlzLl9zaGlmdEFuZENsZWFyKCkKICAgIHdoaWxlIChub2RlLmJhdGNoID4gMSkgbm9kZSA9IHRoaXMuX3NoaWZ0QW5kQ2xlYXIoKQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBnZXQoc2VxKSB7CiAgICByZXR1cm4gc2VxIDwgdGhpcy5sZW5ndGggPyB0aGlzLm5vZGVzLmdldChzZXEpIDogbnVsbAogIH0KCiAgYXBwZW5kKHZhbHVlLCBoZWFkcywgYmF0Y2gsIGRlcGVuZGVuY2llcywgb3B0aW1pc3RpYykgewogICAgY29uc3Qgbm9kZSA9IExpbmVhcml6ZXIuY3JlYXRlTm9kZSgKICAgICAgdGhpcywKICAgICAgdGhpcy5ub2Rlcy5sZW5ndGggKyAxLAogICAgICB2YWx1ZSwKICAgICAgaGVhZHMsCiAgICAgIGJhdGNoLAogICAgICBkZXBlbmRlbmNpZXMsCiAgICAgIG9wdGltaXN0aWMKICAgICkKCiAgICBub2RlLmFjdHVhbEhlYWRzID0gbm9kZS5oZWFkcy5zbGljZSgwKQoKICAgIHRoaXMubm9kZXMucHVzaChub2RlKQogICAgdGhpcy5hdmFpbGFibGUrKwogICAgdGhpcy5sZW5ndGgrKwoKICAgIHJldHVybiBub2RlCiAgfQoKICBhc3luYyB1cGRhdGUoYm9vdCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAodGhpcy5mcm96ZW4pIHJldHVybiBmYWxzZQoKICAgIC8vIGlmIHRoaXMgaXMgYSBib290IG5vZGUsIERPIE5PVCwgcHJlbG9hZCBhcyB0aGF0IHdpbGwgbWFrZSBpdCBsb2FkCiAgICAvLyBhbmQgcmVqZWN0IG5vZGVzIGJhc2VkIG9uIHRoZSB0bXAgc3RhdGUgb2YgdGhlIHN5c3RlbS4KICAgIC8vIHByb3AgbmVlZHMgYSBiZXR0ZXIgc29sdXRpb24gYnV0IHRoaXMgd29ya3MgZm9yIG5vdwogICAgY29uc3QgcHJlbG9hZCA9IGJvb3QgPyAxIDogTUFYX1BSRUxPQUQKCiAgICB3aGlsZSAodGhpcy5hdmFpbGFibGUgLSB0aGlzLmxlbmd0aCA8IHByZWxvYWQpIHsKICAgICAgLy8gcXVpY2sgc2FuaXR5IGNoZWNrCiAgICAgIGlmICh0aGlzLm5vZGVzLmxlbmd0aCA9PT0gdGhpcy5jb3JlLmxlbmd0aCB8fCB0aGlzLmNvcmUubGVuZ3RoID09PSAwKSBicmVhawoKICAgICAgLy8gbG9hZCBuZXh0IG5vZGUKICAgICAgaWYgKHRoaXMubm9kZSA9PT0gbnVsbCAmJiAhKGF3YWl0IHRoaXMuX2xvYWROZXh0Tm9kZSgpKSkgYnJlYWsKICAgICAgaWYgKCEoYXdhaXQgdGhpcy5fZW5zdXJlTm9kZURlcGVuZGVuY2llcyhib290KSkpIGJyZWFrCgogICAgICBpZiAodGhpcy5yZWNvdmVyKSB0aGlzLm5vZGUudmFsdWUgPSBudWxsCgogICAgICB0aGlzLm5vZGVzLnB1c2godGhpcy5ub2RlKQogICAgICBpZiAodGhpcy5ub2RlLmJhdGNoID09PSAxKSB0aGlzLmF2YWlsYWJsZSA9IHRoaXMubm9kZXMubGVuZ3RoCiAgICAgIHRoaXMubm9kZSA9IG51bGwKICAgIH0KCiAgICB0aGlzLnVwZGF0ZUFjdGl2aXR5KCkKCiAgICByZXR1cm4gdGhpcy5sZW5ndGggPCB0aGlzLmF2YWlsYWJsZQogIH0KCiAgX3NoaWZ0QW5kQ2xlYXIoKSB7CiAgICBjb25zdCBub2RlID0gdGhpcy5ub2Rlcy5zaGlmdCgpCiAgICBub2RlLmNsZWFyKCkKICAgIHJldHVybiBub2RlCiAgfQoKICBhc3luYyBfbG9hZE5leHROb2RlKCkgewogICAgY29uc3Qgc2VxID0gdGhpcy5ub2Rlcy5sZW5ndGgKCiAgICBpZiAoIShhd2FpdCB0aGlzLmNvcmUuaGFzKHNlcSkpKSByZXR1cm4gZmFsc2UKCiAgICB0cnkgewogICAgICBjb25zdCB7IG5vZGUsIG9wdGltaXN0aWMsIHRyYWNlIH0gPSBhd2FpdCB0aGlzLmNvcmUuZ2V0KHNlcSwgeyB3YWl0OiBmYWxzZSB9KQoKICAgICAgY29uc3QgdmFsdWUgPSBub2RlLnZhbHVlID09IG51bGwgPyBudWxsIDogYy5kZWNvZGUodGhpcy5iYXNlLnZhbHVlRW5jb2RpbmcsIG5vZGUudmFsdWUpCiAgICAgIHRoaXMubm9kZSA9IExpbmVhcml6ZXIuY3JlYXRlTm9kZSgKICAgICAgICB0aGlzLAogICAgICAgIHNlcSArIDEsCiAgICAgICAgdmFsdWUsCiAgICAgICAgbm9kZS5oZWFkcywKICAgICAgICBub2RlLmJhdGNoLAogICAgICAgIG5ldyBTZXQoKSwKICAgICAgICBvcHRpbWlzdGljLAogICAgICAgIHRyYWNlCiAgICAgICkKICAgICAgcmV0dXJuIHRydWUKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLmZyb3plbiA9IHRydWUKICAgICAgdGhyb3cgZXJyCiAgICB9CiAgfQoKICBhc3luYyBfZW5zdXJlTm9kZURlcGVuZGVuY2llcyhib290KSB7CiAgICB3aGlsZSAodGhpcy5ub2RlLmRlcGVuZGVuY2llcy5zaXplIDwgdGhpcy5ub2RlLmhlYWRzLmxlbmd0aCkgewogICAgICBjb25zdCByYXdIZWFkID0gdGhpcy5ub2RlLmhlYWRzW3RoaXMubm9kZS5kZXBlbmRlbmNpZXMuc2l6ZV0KCiAgICAgIGNvbnN0IGhlYWRXcml0ZXIgPSBhd2FpdCB0aGlzLmJhc2UuX2dldFdyaXRlckJ5S2V5KAogICAgICAgIHJhd0hlYWQua2V5LAogICAgICAgIC0xLAogICAgICAgIHJhd0hlYWQubGVuZ3RoLAogICAgICAgIHRydWUsCiAgICAgICAgZmFsc2UsCiAgICAgICAgYm9vdAogICAgICApCgogICAgICBpZiAoaGVhZFdyaXRlciAhPT0gdGhpcyAmJiAoaGVhZFdyaXRlciA9PT0gbnVsbCB8fCBoZWFkV3JpdGVyLmxlbmd0aCA8IHJhd0hlYWQubGVuZ3RoKSkgewogICAgICAgIGlmICghYm9vdCkgdGhpcy5iYXNlLl9lbnN1cmVXYWtldXAoaGVhZFdyaXRlcikKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQoKICAgICAgbGV0IGhlYWROb2RlID0gaGVhZFdyaXRlci5ub2Rlcy5nZXQocmF3SGVhZC5sZW5ndGggLSAxKQoKICAgICAgLy8gY291bGQgYmUgYSBzdHViIG5vZGUKICAgICAgaWYgKCFoZWFkTm9kZSkgewogICAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiB0aGlzLmJhc2UubGluZWFyaXplci5oZWFkcykgewogICAgICAgICAgaWYgKCFjb21wYXJlSGVhZChub2RlLCByYXdIZWFkKSkgY29udGludWUKICAgICAgICAgIGhlYWROb2RlID0gbm9kZQogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFRPRE86IGdlbmVyYWxpc2UgREFHIHZhbGlkYXRpb24gYW5kIGZyZWV6ZSB0aGUgd3JpdGVyCiAgICAgIGFzc2VydCghdGhpcy5ub2RlLmRlcGVuZGVuY2llcy5oYXMoaGVhZE5vZGUpLCAnQ29ycnVwdGVkIERBRycpCgogICAgICAvLyBUT0RPOiBiZXR0ZXIgd2F5IHRvIHNvbHZlIHRoZSBzdHViIGNoZWNrIGlzIHRvIG5ldmVyIG11dGF0ZSBoZWFkcyBiZWxvdwogICAgICBpZiAoaGVhZE5vZGUgPT09IG51bGwpIHsKICAgICAgICAvLyBhbHJlYWR5IHlpZWxkZWQKICAgICAgICB0aGlzLm5vZGUuaGVhZHMuc3BsaWNlKHRoaXMubm9kZS5kZXBlbmRlbmNpZXMuc2l6ZSwgMSkKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICB0aGlzLm5vZGUuZGVwZW5kZW5jaWVzLmFkZChoZWFkTm9kZSkKICAgIH0KCiAgICAvLyBhbHdheXMgbGluayBwcmV2aW91cyBub2RlIGlmIGl0J3Mgbm90IGluZGV4ZWQKICAgIGNvbnN0IG9mZnNldCA9IHRoaXMubm9kZS5sZW5ndGggLSAxCiAgICBpZiAob2Zmc2V0ID4gdGhpcy5pbmRleGVkKSB7CiAgICAgIHRoaXMubm9kZS5kZXBlbmRlbmNpZXMuYWRkKHRoaXMubm9kZXMuZ2V0KG9mZnNldCAtIDEpKQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQp9CgpmdW5jdGlvbiBjb21wYXJlSGVhZChub2RlLCBoZWFkKSB7CiAgaWYgKG5vZGUubGVuZ3RoICE9PSBoZWFkLmxlbmd0aCkgcmV0dXJuIGZhbHNlCiAgcmV0dXJuIGI0YS5lcXVhbHMobm9kZS53cml0ZXIuY29yZS5rZXksIGhlYWQua2V5KQp9CgovLyB0aGlzIGlzIGEgbGlzdCBvZiBwZWVycyB3ZSBidWdnZWQgaW4gdGhlIGJ0YyBhbmQgcGxhbmIgcm9vbS4KLy8gYWRkaW5nIHRoZW0gaGVyZSBzbyBtaWdyYXRpb24gY2FuIHJ1biwgY2FuIGJlIHJlbW92ZWQgaW4gYSBtb250aCBvciBzbyBmcm9tIHRpbWUgb2YgY29tbWl0Ci8vIG5vdGUsIG5vIHNlY3VyaXR5IGltcGxpY2F0aW9ucyBvZiB0aGlzLCB3ZSBqdXN0IG51bGwgdGhlbSBvdXQuCgpmdW5jdGlvbiBhdXRvUmVjb3Zlcihjb3JlKSB7CiAgYXNzZXJ0KGNvcmUub3BlbmVkKQoKICBzd2l0Y2ggKGNvcmUuaWQpIHsKICAgIGNhc2UgJ2docnBleGFib3V0ZG00Nm9tYnFobzdtcm94a25hc3NubnRyeHgzY3ViZnV4NHFpNnc2aHknOgogICAgY2FzZSAncW9hYW5hbzcxczRoZTFyY2QxOTdkMzM2cWVweWtrNDQ2N2dlbzF1cThjd256bXBiNzg2byc6CiAgICBjYXNlICdmb21oZHhnbjRqNHR6anF5Nnk3aXNraGZmaW16b2t0N2tyYWRkeWQ4b3JjaHQzcjhxNjFvJzoKICAgIGNhc2UgJ2Q4ZjV0YXh4cml0NTFhcGZ0b2kzOGU1Yjg2aGI5OGNnZmQ3ZGZwM3VvMXVvaDk1cXQ0OW8nOgogICAgY2FzZSAnb2JqeWY3NXVnZ3NxcGpjdXQ2OXhkZ2o0NmtzOHI3MWpqcnE3b3hkZnN6OTVzc3RjaGtubyc6CiAgICAgIHJldHVybiB0cnVlCiAgfQoKICByZXR1cm4gZmFsc2UKfQp7CiAgIm5hbWUiOiAiYXV0b2Jhc2UiLAogICJ2ZXJzaW9uIjogIjcuMjQuMCIsCiAgImRlc2NyaXB0aW9uIjogIkEgbXVsdGl3cml0ZXIgZGF0YSBzdHJ1Y3R1cmUgZm9yIEh5cGVyY29yZSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAuIC0td3JpdGUiLAogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJyaXR0bGUgdGVzdC9hbGwuanMiLAogICAgInRlc3Q6ZW5jcnlwdGVkIjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBicml0dGxlIHRlc3QvYWxsLmpzIC0tZW5jcnlwdC1hbGwiLAogICAgInRlc3Q6Zml4dHVyZXMiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJyaXR0bGUgdGVzdC9maXh0dXJlcy90ZXN0cy8qLmpzIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0L2FsbC5qcyIsCiAgICAiZnV6ejpnZW5lcmF0ZWQiOiAiYnJpdHRsZSB0ZXN0L3JlZmVyZW5jZS9mdXp6L2dlbmVyYXRlZC8qLmpzIiwKICAgICJmdXp6Om1haW4iOiAibm9kZSB0ZXN0L2Z1enovaW5kZXguanMiLAogICAgImZ1enoiOiAibm9kZSB0ZXN0L3JlZmVyZW5jZS9mdXp6L2Z1enouanMiLAogICAgImdlbmVyYXRlLWZpeHR1cmVzIjogIm5vZGUgdGVzdC9maXh0dXJlcy9nZW5lcmF0ZS9hbGwuanMiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYi8qKiIsCiAgICAiZW5jb2RpbmcvKioiCiAgXSwKICAiaW1wb3J0cyI6IHsKICAgICJldmVudHMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZXZlbnRzIiwKICAgICAgImRlZmF1bHQiOiAiZXZlbnRzIgogICAgfQogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2F1dG9iYXNlLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2F1dG9iYXNlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYXV0b2Jhc2UjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjEiLAogICAgImJhcmUtZXZlbnRzIjogIl4yLjIuMCIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xNi4wIiwKICAgICJjb3JlLWNvdXBsZXIiOiAiXjIuMC4wIiwKICAgICJkZWJvdW5jZWlmeSI6ICJeMS4wLjAiLAogICAgImh5cGVyYmVlIjogIl4yLjIyLjAiLAogICAgImh5cGVyY29yZSI6ICJeMTEuNC4wIiwKICAgICJoeXBlcmNvcmUtY3J5cHRvIjogIl4zLjQuMCIsCiAgICAiaHlwZXJjb3JlLWlkLWVuY29kaW5nIjogIl4xLjIuMCIsCiAgICAiaHlwZXJzY2hlbWEiOiAiXjEuMTIuMSIsCiAgICAiaW5kZXgtZW5jb2RlciI6ICJeMy4zLjIiLAogICAgIm5hbm9hc3NlcnQiOiAiXjIuMC4wIiwKICAgICJwcm90b211eC13YWtldXAiOiAiXjIuMC4wIiwKICAgICJyZWFkeS1yZXNvdXJjZSI6ICJeMS4wLjAiLAogICAgInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiAiXjEuMS4wIiwKICAgICJzYWZldHktY2F0Y2giOiAiXjEuMC4yIiwKICAgICJzY29wZS1sb2NrIjogIl4xLjIuNCIsCiAgICAic2lnbmFsLXByb21pc2UiOiAiXjEuMC4zIiwKICAgICJzb2RpdW0tdW5pdmVyc2FsIjogIl41LjAuMSIsCiAgICAic3ViLWVuY29kZXIiOiAiXjIuMS4xIiwKICAgICJ0aW55LWJ1ZmZlci1tYXAiOiAiXjEuMS4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJhdXRvYmFzZS10ZXN0LWhlbHBlcnMiOiAiXjMuMC4wIiwKICAgICJicml0dGxlIjogIl4zLjEuMSIsCiAgICAiY29yZXN0b3JlIjogIl43LjAuMTUiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiLAogICAgInJhY2hlIjogIl4xLjAuMCIsCiAgICAic2FtZS1kYXRhIjogIl4xLjAuMCIsCiAgICAidGFzay1iYWNrb2ZmIjogIl4xLjAuMCIsCiAgICAidGVzdC10bXAiOiAiXjEuMi4wIiwKICAgICJ1bmNhdWdodHMiOiAiXjEuMS4wIgogIH0sCiAgInN0YW5kYXJkIjogewogICAgImlnbm9yZSI6IFsKICAgICAgIioqL3Rlc3QvZnV6ei9nZW5lcmF0ZWQvKioiLAogICAgICAiKiovdGVzdC9yZWZlcmVuY2UvKioiLAogICAgICAiZXhhbXBsZS5tanMiCiAgICBdCiAgfQp9CmZ1bmN0aW9uIGlzQnVmZmVyKHZhbHVlKSB7CiAgcmV0dXJuIEJ1ZmZlci5pc0J1ZmZlcih2YWx1ZSkgfHwgdmFsdWUgaW5zdGFuY2VvZiBVaW50OEFycmF5Cn0KCmZ1bmN0aW9uIGlzRW5jb2RpbmcoZW5jb2RpbmcpIHsKICByZXR1cm4gQnVmZmVyLmlzRW5jb2RpbmcoZW5jb2RpbmcpCn0KCmZ1bmN0aW9uIGFsbG9jKHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CiAgcmV0dXJuIEJ1ZmZlci5hbGxvYyhzaXplLCBmaWxsLCBlbmNvZGluZykKfQoKZnVuY3Rpb24gYWxsb2NVbnNhZmUoc2l6ZSkgewogIHJldHVybiBCdWZmZXIuYWxsb2NVbnNhZmUoc2l6ZSkKfQoKZnVuY3Rpb24gYWxsb2NVbnNhZmVTbG93KHNpemUpIHsKICByZXR1cm4gQnVmZmVyLmFsbG9jVW5zYWZlU2xvdyhzaXplKQp9CgpmdW5jdGlvbiBieXRlTGVuZ3RoKHN0cmluZywgZW5jb2RpbmcpIHsKICByZXR1cm4gQnVmZmVyLmJ5dGVMZW5ndGgoc3RyaW5nLCBlbmNvZGluZykKfQoKZnVuY3Rpb24gY29tcGFyZShhLCBiKSB7CiAgcmV0dXJuIEJ1ZmZlci5jb21wYXJlKGEsIGIpCn0KCmZ1bmN0aW9uIGNvbmNhdChidWZmZXJzLCB0b3RhbExlbmd0aCkgewogIHJldHVybiBCdWZmZXIuY29uY2F0KGJ1ZmZlcnMsIHRvdGFsTGVuZ3RoKQp9CgpmdW5jdGlvbiBjb3B5KHNvdXJjZSwgdGFyZ2V0LCB0YXJnZXRTdGFydCwgc3RhcnQsIGVuZCkgewogIHJldHVybiB0b0J1ZmZlcihzb3VyY2UpLmNvcHkodGFyZ2V0LCB0YXJnZXRTdGFydCwgc3RhcnQsIGVuZCkKfQoKZnVuY3Rpb24gZXF1YWxzKGEsIGIpIHsKICByZXR1cm4gdG9CdWZmZXIoYSkuZXF1YWxzKGIpCn0KCmZ1bmN0aW9uIGZpbGwoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0LCBlbmQsIGVuY29kaW5nKSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikuZmlsbCh2YWx1ZSwgb2Zmc2V0LCBlbmQsIGVuY29kaW5nKQp9CgpmdW5jdGlvbiBmcm9tKHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpIHsKICByZXR1cm4gQnVmZmVyLmZyb20odmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKfQoKZnVuY3Rpb24gaW5jbHVkZXMoYnVmZmVyLCB2YWx1ZSwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5pbmNsdWRlcyh2YWx1ZSwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpCn0KCmZ1bmN0aW9uIGluZGV4T2YoYnVmZmVyLCB2YWx1ZSwgYnlmZU9mZnNldCwgZW5jb2RpbmcpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5pbmRleE9mKHZhbHVlLCBieWZlT2Zmc2V0LCBlbmNvZGluZykKfQoKZnVuY3Rpb24gbGFzdEluZGV4T2YoYnVmZmVyLCB2YWx1ZSwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5sYXN0SW5kZXhPZih2YWx1ZSwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpCn0KCmZ1bmN0aW9uIHN3YXAxNihidWZmZXIpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5zd2FwMTYoKQp9CgpmdW5jdGlvbiBzd2FwMzIoYnVmZmVyKSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikuc3dhcDMyKCkKfQoKZnVuY3Rpb24gc3dhcDY0KGJ1ZmZlcikgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnN3YXA2NCgpCn0KCmZ1bmN0aW9uIHRvQnVmZmVyKGJ1ZmZlcikgewogIGlmIChCdWZmZXIuaXNCdWZmZXIoYnVmZmVyKSkgcmV0dXJuIGJ1ZmZlcgogIHJldHVybiBCdWZmZXIuZnJvbShidWZmZXIuYnVmZmVyLCBidWZmZXIuYnl0ZU9mZnNldCwgYnVmZmVyLmJ5dGVMZW5ndGgpCn0KCmZ1bmN0aW9uIHRvU3RyaW5nKGJ1ZmZlciwgZW5jb2RpbmcsIHN0YXJ0LCBlbmQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS50b1N0cmluZyhlbmNvZGluZywgc3RhcnQsIGVuZCkKfQoKZnVuY3Rpb24gd3JpdGUoYnVmZmVyLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoLCBlbmNvZGluZykgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLndyaXRlKHN0cmluZywgb2Zmc2V0LCBsZW5ndGgsIGVuY29kaW5nKQp9CgpmdW5jdGlvbiByZWFkRG91YmxlQkUoYnVmZmVyLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5yZWFkRG91YmxlQkUob2Zmc2V0KQp9CgpmdW5jdGlvbiByZWFkRG91YmxlTEUoYnVmZmVyLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5yZWFkRG91YmxlTEUob2Zmc2V0KQp9CgpmdW5jdGlvbiByZWFkRmxvYXRCRShidWZmZXIsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnJlYWRGbG9hdEJFKG9mZnNldCkKfQoKZnVuY3Rpb24gcmVhZEZsb2F0TEUoYnVmZmVyLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5yZWFkRmxvYXRMRShvZmZzZXQpCn0KCmZ1bmN0aW9uIHJlYWRJbnQzMkJFKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikucmVhZEludDMyQkUob2Zmc2V0KQp9CgpmdW5jdGlvbiByZWFkSW50MzJMRShidWZmZXIsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnJlYWRJbnQzMkxFKG9mZnNldCkKfQoKZnVuY3Rpb24gcmVhZFVJbnQzMkJFKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikucmVhZFVJbnQzMkJFKG9mZnNldCkKfQoKZnVuY3Rpb24gcmVhZFVJbnQzMkxFKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikucmVhZFVJbnQzMkxFKG9mZnNldCkKfQoKZnVuY3Rpb24gd3JpdGVEb3VibGVCRShidWZmZXIsIHZhbHVlLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS53cml0ZURvdWJsZUJFKHZhbHVlLCBvZmZzZXQpCn0KCmZ1bmN0aW9uIHdyaXRlRG91YmxlTEUoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikud3JpdGVEb3VibGVMRSh2YWx1ZSwgb2Zmc2V0KQp9CgpmdW5jdGlvbiB3cml0ZUZsb2F0QkUoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikud3JpdGVGbG9hdEJFKHZhbHVlLCBvZmZzZXQpCn0KCmZ1bmN0aW9uIHdyaXRlRmxvYXRMRShidWZmZXIsIHZhbHVlLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS53cml0ZUZsb2F0TEUodmFsdWUsIG9mZnNldCkKfQoKZnVuY3Rpb24gd3JpdGVJbnQzMkJFKGJ1ZmZlciwgdmFsdWUsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLndyaXRlSW50MzJCRSh2YWx1ZSwgb2Zmc2V0KQp9CgpmdW5jdGlvbiB3cml0ZUludDMyTEUoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikud3JpdGVJbnQzMkxFKHZhbHVlLCBvZmZzZXQpCn0KCmZ1bmN0aW9uIHdyaXRlVUludDMyQkUoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikud3JpdGVVSW50MzJCRSh2YWx1ZSwgb2Zmc2V0KQp9CgpmdW5jdGlvbiB3cml0ZVVJbnQzMkxFKGJ1ZmZlciwgdmFsdWUsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLndyaXRlVUludDMyTEUodmFsdWUsIG9mZnNldCkKfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgaXNCdWZmZXIsCiAgaXNFbmNvZGluZywKICBhbGxvYywKICBhbGxvY1Vuc2FmZSwKICBhbGxvY1Vuc2FmZVNsb3csCiAgYnl0ZUxlbmd0aCwKICBjb21wYXJlLAogIGNvbmNhdCwKICBjb3B5LAogIGVxdWFscywKICBmaWxsLAogIGZyb20sCiAgaW5jbHVkZXMsCiAgaW5kZXhPZiwKICBsYXN0SW5kZXhPZiwKICBzd2FwMTYsCiAgc3dhcDMyLAogIHN3YXA2NCwKICB0b0J1ZmZlciwKICB0b1N0cmluZywKICB3cml0ZSwKICByZWFkRG91YmxlQkUsCiAgcmVhZERvdWJsZUxFLAogIHJlYWRGbG9hdEJFLAogIHJlYWRGbG9hdExFLAogIHJlYWRJbnQzMkJFLAogIHJlYWRJbnQzMkxFLAogIHJlYWRVSW50MzJCRSwKICByZWFkVUludDMyTEUsCiAgd3JpdGVEb3VibGVCRSwKICB3cml0ZURvdWJsZUxFLAogIHdyaXRlRmxvYXRCRSwKICB3cml0ZUZsb2F0TEUsCiAgd3JpdGVJbnQzMkJFLAogIHdyaXRlSW50MzJMRSwKICB3cml0ZVVJbnQzMkJFLAogIHdyaXRlVUludDMyTEUKfQp7CiAgIm5hbWUiOiAiYjRhIiwKICAidmVyc2lvbiI6ICIxLjcuMyIsCiAgImRlc2NyaXB0aW9uIjogIkJyaWRnaW5nIHRoZSBnYXAgYmV0d2VlbiBidWZmZXJzIGFuZCB0eXBlZCBhcnJheXMiLAogICJleHBvcnRzIjogewogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLiI6IHsKICAgICAgInJlYWN0LW5hdGl2ZSI6ICIuL3JlYWN0LW5hdGl2ZS5qcyIsCiAgICAgICJicm93c2VyIjogIi4vYnJvd3Nlci5qcyIsCiAgICAgICJkZWZhdWx0IjogIi4vaW5kZXguanMiCiAgICB9CiAgfSwKICAiZmlsZXMiOiBbCiAgICAiYnJvd3Nlci5qcyIsCiAgICAiaW5kZXguanMiLAogICAgInJlYWN0LW5hdGl2ZS5qcyIsCiAgICAibGliIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJucG0gcnVuIGxpbnQgJiYgbnBtIHJ1biB0ZXN0OmJhcmUgJiYgbnBtIHJ1biB0ZXN0Om5vZGUiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QubWpzIiwKICAgICJ0ZXN0Om5vZGUiOiAibm9kZSB0ZXN0Lm1qcyIsCiAgICAibGludCI6ICJwcmV0dGllciAuIC0tY2hlY2siCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYjRhLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2I0YS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2I0YSNyZWFkbWUiLAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy41LjIiLAogICAgIm5hbm9iZW5jaCI6ICJeMy4wLjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMS4wLjAiCiAgfSwKICAicGVlckRlcGVuZGVuY2llcyI6IHsKICAgICJyZWFjdC1uYXRpdmUtYjRhIjogIioiCiAgfSwKICAicGVlckRlcGVuZGVuY2llc01ldGEiOiB7CiAgICAicmVhY3QtbmF0aXZlLWI0YSI6IHsKICAgICAgIm9wdGlvbmFsIjogdHJ1ZQogICAgfQogIH0KfQptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUuYWRkb24oKQpjb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2xpYi9jb25zdGFudHMnKQpjb25zdCBIYXNoID0gcmVxdWlyZSgnLi9saWIvaGFzaCcpCmNvbnN0IEhtYWMgPSByZXF1aXJlKCcuL2xpYi9obWFjJykKY29uc3QgeyBDaXBoZXJpdiwgRGVjaXBoZXJpdiB9ID0gcmVxdWlyZSgnLi9saWIvY2lwaGVyJykKY29uc3QgeyByYW5kb21CeXRlcywgcmFuZG9tRmlsbCwgcmFuZG9tVVVJRCB9ID0gcmVxdWlyZSgnLi9saWIvcmFuZG9tJykKY29uc3QgcGJrZGYyID0gcmVxdWlyZSgnLi9saWIvcGJrZGYyJykKY29uc3QgeyBnZW5lcmF0ZUtleVBhaXIgfSA9IHJlcXVpcmUoJy4vbGliL2tleScpCmNvbnN0IHsgc2lnbiwgdmVyaWZ5IH0gPSByZXF1aXJlKCcuL2xpYi9zaWduYXR1cmUnKQoKZXhwb3J0cy5jb25zdGFudHMgPSBjb25zdGFudHMKCmV4cG9ydHMuSGFzaCA9IEhhc2gKCmV4cG9ydHMuY3JlYXRlSGFzaCA9IGZ1bmN0aW9uIGNyZWF0ZUhhc2goYWxnb3JpdGhtLCBvcHRzKSB7CiAgcmV0dXJuIG5ldyBIYXNoKGFsZ29yaXRobSwgb3B0cykKfQoKZXhwb3J0cy5IbWFjID0gSG1hYwoKZXhwb3J0cy5jcmVhdGVIbWFjID0gZnVuY3Rpb24gY3JlYXRlSG1hYyhhbGdvcml0aG0sIGtleSwgb3B0cykgewogIHJldHVybiBuZXcgSG1hYyhhbGdvcml0aG0sIGtleSwgb3B0cykKfQoKZXhwb3J0cy5DaXBoZXJpdiA9IENpcGhlcml2CgpleHBvcnRzLmNyZWF0ZUNpcGhlcml2ID0gZnVuY3Rpb24gY3JlYXRlQ2lwaGVyaXYoYWxnb3JpdGhtLCBrZXksIGl2LCBvcHRzKSB7CiAgcmV0dXJuIG5ldyBDaXBoZXJpdihhbGdvcml0aG0sIGtleSwgaXYsIG9wdHMpCn0KCmV4cG9ydHMuRGVjaXBoZXJpdiA9IERlY2lwaGVyaXYKCmV4cG9ydHMuY3JlYXRlRGVjaXBoZXJpdiA9IGZ1bmN0aW9uIGNyZWF0ZURlY2lwaGVyaXYoYWxnb3JpdGhtLCBrZXksIGl2LCBvcHRzKSB7CiAgcmV0dXJuIG5ldyBEZWNpcGhlcml2KGFsZ29yaXRobSwga2V5LCBpdiwgb3B0cykKfQoKZXhwb3J0cy5yYW5kb21CeXRlcyA9IHJhbmRvbUJ5dGVzCgpleHBvcnRzLnJhbmRvbUZpbGwgPSByYW5kb21GaWxsCgovLyBGb3IgTm9kZS5qcyBjb21wYXRpYmlsaXR5CmV4cG9ydHMucmFuZG9tRmlsbFN5bmMgPSBmdW5jdGlvbiByYW5kb21GaWxsU3luYyhidWZmZXIsIG9mZnNldCwgc2l6ZSkgewogIHJldHVybiBleHBvcnRzLnJhbmRvbUZpbGwoYnVmZmVyLCBvZmZzZXQsIHNpemUpCn0KCmV4cG9ydHMucmFuZG9tVVVJRCA9IHJhbmRvbVVVSUQKCmV4cG9ydHMucGJrZGYyID0gcGJrZGYyCgovLyBGb3IgTm9kZS5qcyBjb21wYXRpYmlsaXR5CmV4cG9ydHMucGJrZGYyU3luYyA9IGZ1bmN0aW9uIHBia2RmMlN5bmMocGFzc3dvcmQsIHNhbHQsIGl0ZXJhdGlvbnMsIGtleWxlbiwgZGlnZXN0KSB7CiAgcmV0dXJuIGV4cG9ydHMucGJrZGYyKHBhc3N3b3JkLCBzYWx0LCBpdGVyYXRpb25zLCBrZXlsZW4sIGRpZ2VzdCkKfQoKZXhwb3J0cy5nZW5lcmF0ZUtleVBhaXIgPSBnZW5lcmF0ZUtleVBhaXIKCmV4cG9ydHMuc2lnbiA9IHNpZ24KCmV4cG9ydHMudmVyaWZ5ID0gdmVyaWZ5CgovLyBGb3IgTm9kZS5qcyBjb21wYXRpYmlsaXR5CmV4cG9ydHMud2ViY3J5cHRvID0gcmVxdWlyZSgnLi93ZWInKQpjb25zdCB7IFRyYW5zZm9ybSB9ID0gcmVxdWlyZSgnYmFyZS1zdHJlYW0nKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCmNvbnN0IHsKICBjaXBoZXI6IHsKICAgIEFFUzEyOEVDQiwKICAgIEFFUzEyOENCQywKICAgIEFFUzEyOENUUiwKICAgIEFFUzEyOE9GQiwKICAgIEFFUzI1NkVDQiwKICAgIEFFUzI1NkNCQywKICAgIEFFUzI1NkNUUiwKICAgIEFFUzI1Nk9GQiwKICAgIEFFUzEyOEdDTSwKICAgIEFFUzI1NkdDTSwKICAgIENIQUNIQTIwUE9MWTEzMDUsCiAgICBYQ0hBQ0hBMjBQT0xZMTMwNQogIH0KfSA9IGNvbnN0YW50cwoKY2xhc3MgQ3J5cHRvQ2lwaGVyIHsKICBjb25zdHJ1Y3RvcihhbGdvcml0aG0sIGtleSwgaXYsIGVuY3J5cHQsIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyBlbmNvZGluZyA9ICd1dGY4JyB9ID0gb3B0cwoKICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJykga2V5ID0gQnVmZmVyLmZyb20oa2V5LCBlbmNvZGluZykKICAgIGlmICh0eXBlb2YgaXYgPT09ICdzdHJpbmcnKSBpdiA9IEJ1ZmZlci5mcm9tKGl2LCBlbmNvZGluZykKCiAgICBpZiAoa2V5LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY2lwaGVyS2V5TGVuZ3RoKGFsZ29yaXRobSkpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0ludmFsaWQga2V5IGxlbmd0aCcpCiAgICB9CgogICAgaWYgKGl2LmJ5dGVMZW5ndGggPCBiaW5kaW5nLmNpcGhlcklWTGVuZ3RoKGFsZ29yaXRobSkpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0ludmFsaWQgaXYgbGVuZ3RoJykKICAgIH0KCiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLmNpcGhlckluaXQoCiAgICAgIGFsZ29yaXRobSwKICAgICAga2V5LmJ1ZmZlciwKICAgICAga2V5LmJ5dGVPZmZzZXQsCiAgICAgIGtleS5ieXRlTGVuZ3RoLAogICAgICBpdi5idWZmZXIsCiAgICAgIGl2LmJ5dGVPZmZzZXQsCiAgICAgIGl2LmJ5dGVMZW5ndGgsCiAgICAgIGVuY3J5cHQKICAgICkKICB9CgogIHVwZGF0ZShkYXRhLCBpbnB1dEVuY29kaW5nID0gJ3V0ZjgnLCBvdXRwdXRFbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEsIGlucHV0RW5jb2RpbmcpCgogICAgY29uc3Qgb3V0ID0gbmV3IEFycmF5QnVmZmVyKGJpbmRpbmcuY2lwaGVyQmxvY2tTaXplKHRoaXMuX2hhbmRsZSkpCgogICAgY29uc3Qgd3JpdHRlbiA9IGJpbmRpbmcuY2lwaGVyVXBkYXRlKAogICAgICB0aGlzLl9oYW5kbGUsCiAgICAgIGRhdGEuYnVmZmVyLAogICAgICBkYXRhLmJ5dGVPZmZzZXQsCiAgICAgIGRhdGEuYnl0ZUxlbmd0aCwKICAgICAgb3V0CiAgICApCgogICAgY29uc3QgcmVzdWx0ID0gQnVmZmVyLmZyb20ob3V0LCAwLCB3cml0dGVuKQoKICAgIHJldHVybiBvdXRwdXRFbmNvZGluZyA/IHJlc3VsdC50b1N0cmluZyhvdXRwdXRFbmNvZGluZykgOiByZXN1bHQKICB9CgogIGZpbmFsKG91dHB1dEVuY29kaW5nKSB7CiAgICBjb25zdCBvdXQgPSBuZXcgQXJyYXlCdWZmZXIoYmluZGluZy5jaXBoZXJCbG9ja1NpemUodGhpcy5faGFuZGxlKSkKCiAgICBjb25zdCB3cml0dGVuID0gYmluZGluZy5jaXBoZXJGaW5hbCh0aGlzLl9oYW5kbGUsIG91dCkKCiAgICBjb25zdCByZXN1bHQgPSBCdWZmZXIuZnJvbShvdXQsIDAsIHdyaXR0ZW4pCgogICAgcmV0dXJuIG91dHB1dEVuY29kaW5nID8gcmVzdWx0LnRvU3RyaW5nKG91dHB1dEVuY29kaW5nKSA6IHJlc3VsdAogIH0KCiAgc2V0QXV0b1BhZGRpbmcocGFkKSB7CiAgICBiaW5kaW5nLmNpcGhlclNldFBhZGRpbmcocGFkKQogIH0KfQoKY2xhc3MgQ3J5cHRvQXV0aGVudGljYXRlZENpcGhlciB7CiAgY29uc3RydWN0b3IoYWxnb3JpdGhtLCBrZXksIG5vbmNlLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgZW5jb2RpbmcgPSAndXRmOCcsIGF1dGhUYWdMZW5ndGggPSAxNiB9ID0gb3B0cwoKICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJykga2V5ID0gQnVmZmVyLmZyb20oa2V5LCBlbmNvZGluZykKICAgIGlmICh0eXBlb2Ygbm9uY2UgPT09ICdzdHJpbmcnKSBub25jZSA9IEJ1ZmZlci5mcm9tKG5vbmNlLCBlbmNvZGluZykKCiAgICBpZiAoa2V5LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuYWVhZEtleUxlbmd0aChhbGdvcml0aG0pKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbnZhbGlkIGtleSBsZW5ndGgnKQogICAgfQoKICAgIGlmIChub25jZS5ieXRlTGVuZ3RoIDwgYmluZGluZy5hZWFkTm9uY2VMZW5ndGgoYWxnb3JpdGhtKSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW52YWxpZCBub25jZSBsZW5ndGgnKQogICAgfQoKICAgIHRoaXMuX2J1ZmZlciA9IFtdCiAgICB0aGlzLl9ub25jZSA9IG5vbmNlCiAgICB0aGlzLl9hdXRoVGFnID0gbnVsbAogICAgdGhpcy5fYXV0aFRhZ0xlbmd0aCA9IGF1dGhUYWdMZW5ndGgKICAgIHRoaXMuX2FkZGl0aW9uYWxEYXRhID0gbnVsbAoKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcuYWVhZEluaXQoCiAgICAgIGFsZ29yaXRobSwKICAgICAga2V5LmJ1ZmZlciwKICAgICAga2V5LmJ5dGVPZmZzZXQsCiAgICAgIGtleS5ieXRlTGVuZ3RoLAogICAgICBhdXRoVGFnTGVuZ3RoCiAgICApCiAgfQoKICB1cGRhdGUoZGF0YSwgaW5wdXRFbmNvZGluZyA9ICd1dGY4Jywgb3V0cHV0RW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIGRhdGEgPSBCdWZmZXIuZnJvbShkYXRhLCBpbnB1dEVuY29kaW5nKQoKICAgIHRoaXMuX2J1ZmZlci5wdXNoKGRhdGEpCgogICAgcmV0dXJuIG91dHB1dEVuY29kaW5nID8gJycgOiBCdWZmZXIuYWxsb2MoMCkKICB9CgogIHNldEFBRChidWZmZXIsIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyBlbmNvZGluZyA9ICd1dGY4JyB9ID0gb3B0cwoKICAgIGlmICh0eXBlb2YgYnVmZmVyID09PSAnc3RyaW5nJykgYnVmZmVyID0gQnVmZmVyLmZyb20oYnVmZmVyLCBlbmNvZGluZykKCiAgICB0aGlzLl9hZGRpdGlvbmFsRGF0YSA9IGJ1ZmZlcgogIH0KCiAgZ2V0QXV0aFRhZygpIHsKICAgIHJldHVybiB0aGlzLl9hdXRoVGFnCiAgfQoKICBzZXRBdXRoVGFnKGF1dGhUYWcsIGVuY29kaW5nKSB7CiAgICBpZiAodHlwZW9mIGF1dGhUYWcgPT09ICdzdHJpbmcnKSBhdXRoVGFnID0gQnVmZmVyLmZyb20oYXV0aFRhZywgZW5jb2RpbmcpCgogICAgdGhpcy5fYXV0aFRhZyA9IGF1dGhUYWcKICB9Cn0KCmNsYXNzIENyeXB0b0F1dGhlbnRpY2F0ZWRTZWFsIGV4dGVuZHMgQ3J5cHRvQXV0aGVudGljYXRlZENpcGhlciB7CiAgZmluYWwob3V0cHV0RW5jb2RpbmcpIHsKICAgIGNvbnN0IGRhdGEgPSB0aGlzLl9idWZmZXIubGVuZ3RoID09PSAxID8gdGhpcy5fYnVmZmVyWzBdIDogQnVmZmVyLmNvbmNhdCh0aGlzLl9idWZmZXIpCgogICAgY29uc3Qgbm9uY2UgPSB0aGlzLl9ub25jZQogICAgY29uc3QgYWQgPSB0aGlzLl9hZGRpdGlvbmFsRGF0YSB8fCBCdWZmZXIuYWxsb2MoMCkKCiAgICBjb25zdCBvdXQgPSBuZXcgQXJyYXlCdWZmZXIoZGF0YS5ieXRlTGVuZ3RoICsgYmluZGluZy5hZWFkTWF4T3ZlcmhlYWQodGhpcy5faGFuZGxlKSkKCiAgICBiaW5kaW5nLmFlYWRTZWFsKAogICAgICB0aGlzLl9oYW5kbGUsCiAgICAgIGRhdGEuYnVmZmVyLAogICAgICBkYXRhLmJ5dGVPZmZzZXQsCiAgICAgIGRhdGEuYnl0ZUxlbmd0aCwKICAgICAgbm9uY2UuYnVmZmVyLAogICAgICBub25jZS5ieXRlT2Zmc2V0LAogICAgICBub25jZS5ieXRlTGVuZ3RoLAogICAgICBhZC5idWZmZXIsCiAgICAgIGFkLmJ5dGVPZmZzZXQsCiAgICAgIGFkLmJ5dGVMZW5ndGgsCiAgICAgIG91dAogICAgKQoKICAgIGNvbnN0IHdyaXR0ZW4gPSBvdXQuYnl0ZUxlbmd0aCAtIHRoaXMuX2F1dGhUYWdMZW5ndGgKCiAgICB0aGlzLl9hdXRoVGFnID0gQnVmZmVyLmZyb20ob3V0LCB3cml0dGVuKQoKICAgIGNvbnN0IHJlc3VsdCA9IEJ1ZmZlci5mcm9tKG91dCwgMCwgd3JpdHRlbikKCiAgICByZXR1cm4gb3V0cHV0RW5jb2RpbmcgPyByZXN1bHQudG9TdHJpbmcob3V0cHV0RW5jb2RpbmcpIDogcmVzdWx0CiAgfQp9CgpjbGFzcyBDcnlwdG9BdXRoZW50aWNhdGVkT3BlbiBleHRlbmRzIENyeXB0b0F1dGhlbnRpY2F0ZWRDaXBoZXIgewogIGZpbmFsKG91dHB1dEVuY29kaW5nKSB7CiAgICB0aGlzLl9idWZmZXIucHVzaCh0aGlzLl9hdXRoVGFnKQoKICAgIGNvbnN0IGRhdGEgPSBCdWZmZXIuY29uY2F0KHRoaXMuX2J1ZmZlcikKCiAgICBjb25zdCBub25jZSA9IHRoaXMuX25vbmNlCiAgICBjb25zdCBhZCA9IHRoaXMuX2FkZGl0aW9uYWxEYXRhIHx8IEJ1ZmZlci5hbGxvYygwKQoKICAgIGNvbnN0IG91dCA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhLmJ5dGVMZW5ndGgpCgogICAgYmluZGluZy5hZWFkT3BlbigKICAgICAgdGhpcy5faGFuZGxlLAogICAgICBkYXRhLmJ1ZmZlciwKICAgICAgZGF0YS5ieXRlT2Zmc2V0LAogICAgICBkYXRhLmJ5dGVMZW5ndGgsCiAgICAgIG5vbmNlLmJ1ZmZlciwKICAgICAgbm9uY2UuYnl0ZU9mZnNldCwKICAgICAgbm9uY2UuYnl0ZUxlbmd0aCwKICAgICAgYWQuYnVmZmVyLAogICAgICBhZC5ieXRlT2Zmc2V0LAogICAgICBhZC5ieXRlTGVuZ3RoLAogICAgICBvdXQKICAgICkKCiAgICBjb25zdCB3cml0dGVuID0gb3V0LmJ5dGVMZW5ndGggLSB0aGlzLl9hdXRoVGFnTGVuZ3RoCgogICAgY29uc3QgcmVzdWx0ID0gQnVmZmVyLmZyb20ob3V0LCAwLCB3cml0dGVuKQoKICAgIHJldHVybiBvdXRwdXRFbmNvZGluZyA/IHJlc3VsdC50b1N0cmluZyhvdXRwdXRFbmNvZGluZykgOiByZXN1bHQKICB9Cn0KCmV4cG9ydHMuQ2lwaGVyaXYgPSBjbGFzcyBDcnlwdG9DaXBoZXJpdiBleHRlbmRzIFRyYW5zZm9ybSB7CiAgY29uc3RydWN0b3IoYWxnb3JpdGhtLCBrZXksIGl2LCBvcHRzID0ge30pIHsKICAgIHN1cGVyKG9wdHMpCgogICAgYWxnb3JpdGhtID0gY29uc3RhbnRzLnRvQ2lwaGVyKGFsZ29yaXRobSkKCiAgICBzd2l0Y2ggKGFsZ29yaXRobSkgewogICAgICBjYXNlIEFFUzEyOEVDQjoKICAgICAgY2FzZSBBRVMxMjhDQkM6CiAgICAgIGNhc2UgQUVTMTI4Q1RSOgogICAgICBjYXNlIEFFUzEyOE9GQjoKICAgICAgY2FzZSBBRVMyNTZFQ0I6CiAgICAgIGNhc2UgQUVTMjU2Q0JDOgogICAgICBjYXNlIEFFUzI1NkNUUjoKICAgICAgY2FzZSBBRVMyNTZPRkI6CiAgICAgICAgdGhpcy5fY2lwaGVyID0gbmV3IENyeXB0b0NpcGhlcihhbGdvcml0aG0sIGtleSwgaXYsIHRydWUsIG9wdHMpCiAgICAgICAgYnJlYWsKCiAgICAgIGNhc2UgQUVTMTI4R0NNOgogICAgICBjYXNlIEFFUzI1NkdDTToKICAgICAgY2FzZSBDSEFDSEEyMFBPTFkxMzA1OgogICAgICBjYXNlIFhDSEFDSEEyMFBPTFkxMzA1OgogICAgICAgIHRoaXMuX2NpcGhlciA9IG5ldyBDcnlwdG9BdXRoZW50aWNhdGVkU2VhbChhbGdvcml0aG0sIGtleSwgaXYsIG9wdHMpCiAgICAgICAgYnJlYWsKICAgIH0KICB9CgogIHVwZGF0ZShkYXRhLCBpbnB1dEVuY29kaW5nLCBvdXRwdXRFbmNvZGluZykgewogICAgcmV0dXJuIHRoaXMuX2NpcGhlci51cGRhdGUoZGF0YSwgaW5wdXRFbmNvZGluZywgb3V0cHV0RW5jb2RpbmcpCiAgfQoKICBmaW5hbChvdXRwdXRFbmNvZGluZykgewogICAgcmV0dXJuIHRoaXMuX2NpcGhlci5maW5hbChvdXRwdXRFbmNvZGluZykKICB9CgogIHNldEF1dG9QYWRkaW5nKHBhZCkgewogICAgdGhpcy5fY2lwaGVyLnNldEF1dG9QYWRkaW5nKHBhZCkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgc2V0QUFEKGJ1ZmZlciwgb3B0cykgewogICAgdGhpcy5fY2lwaGVyLnNldEFBRChidWZmZXIsIG9wdHMpCgogICAgcmV0dXJuIHRoaXMKICB9CgogIGdldEF1dGhUYWcoKSB7CiAgICByZXR1cm4gdGhpcy5fY2lwaGVyLmdldEF1dGhUYWcoKQogIH0KCiAgX3RyYW5zZm9ybShkYXRhLCBlbmNvZGluZywgY2IpIHsKICAgIHRoaXMudXBkYXRlKGRhdGEpCgogICAgY2IobnVsbCkKICB9CgogIF9mbHVzaChjYikgewogICAgdGhpcy5wdXNoKHRoaXMuZGlnZXN0KCkpCgogICAgY2IobnVsbCkKICB9Cn0KCmV4cG9ydHMuRGVjaXBoZXJpdiA9IGNsYXNzIENyeXB0b0RlaXBoZXJpdiBleHRlbmRzIFRyYW5zZm9ybSB7CiAgY29uc3RydWN0b3IoYWxnb3JpdGhtLCBrZXksIGl2LCBvcHRzID0ge30pIHsKICAgIHN1cGVyKG9wdHMpCgogICAgYWxnb3JpdGhtID0gY29uc3RhbnRzLnRvQ2lwaGVyKGFsZ29yaXRobSkKCiAgICBzd2l0Y2ggKGFsZ29yaXRobSkgewogICAgICBjYXNlIEFFUzEyOEVDQjoKICAgICAgY2FzZSBBRVMxMjhDQkM6CiAgICAgIGNhc2UgQUVTMTI4Q1RSOgogICAgICBjYXNlIEFFUzEyOE9GQjoKICAgICAgY2FzZSBBRVMyNTZFQ0I6CiAgICAgIGNhc2UgQUVTMjU2Q0JDOgogICAgICBjYXNlIEFFUzI1NkNUUjoKICAgICAgY2FzZSBBRVMyNTZPRkI6CiAgICAgICAgdGhpcy5fY2lwaGVyID0gbmV3IENyeXB0b0NpcGhlcihhbGdvcml0aG0sIGtleSwgaXYsIGZhbHNlLCBvcHRzKQogICAgICAgIGJyZWFrCgogICAgICBjYXNlIEFFUzEyOEdDTToKICAgICAgY2FzZSBBRVMyNTZHQ006CiAgICAgIGNhc2UgQ0hBQ0hBMjBQT0xZMTMwNToKICAgICAgY2FzZSBYQ0hBQ0hBMjBQT0xZMTMwNToKICAgICAgICB0aGlzLl9jaXBoZXIgPSBuZXcgQ3J5cHRvQXV0aGVudGljYXRlZE9wZW4oYWxnb3JpdGhtLCBrZXksIGl2LCBvcHRzKQogICAgICAgIGJyZWFrCiAgICB9CiAgfQoKICB1cGRhdGUoZGF0YSwgaW5wdXRFbmNvZGluZywgb3V0cHV0RW5jb2RpbmcpIHsKICAgIHJldHVybiB0aGlzLl9jaXBoZXIudXBkYXRlKGRhdGEsIGlucHV0RW5jb2RpbmcsIG91dHB1dEVuY29kaW5nKQogIH0KCiAgZmluYWwob3V0cHV0RW5jb2RpbmcpIHsKICAgIHJldHVybiB0aGlzLl9jaXBoZXIuZmluYWwob3V0cHV0RW5jb2RpbmcpCiAgfQoKICBzZXRBdXRvUGFkZGluZyhwYWQpIHsKICAgIHRoaXMuX2NpcGhlci5zZXRBdXRvUGFkZGluZyhwYWQpCgogICAgcmV0dXJuIHRoaXMKICB9CgogIHNldEFBRChidWZmZXIsIG9wdHMpIHsKICAgIHRoaXMuX2NpcGhlci5zZXRBQUQoYnVmZmVyLCBvcHRzKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBzZXRBdXRoVGFnKGF1dGhUYWcsIGVuY29kaW5nKSB7CiAgICB0aGlzLl9jaXBoZXIuc2V0QXV0aFRhZyhhdXRoVGFnLCBlbmNvZGluZykKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgX3RyYW5zZm9ybShkYXRhLCBlbmNvZGluZywgY2IpIHsKICAgIHRoaXMudXBkYXRlKGRhdGEpCgogICAgY2IobnVsbCkKICB9CgogIF9mbHVzaChjYikgewogICAgdGhpcy5wdXNoKHRoaXMuZGlnZXN0KCkpCgogICAgY2IobnVsbCkKICB9Cn0KY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuL2Vycm9ycycpCgptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSB7CiAgaGFzaDogewogICAgTUQ1OiBiaW5kaW5nLk1ENSwKICAgIFNIQTE6IGJpbmRpbmcuU0hBMSwKICAgIFNIQTI1NjogYmluZGluZy5TSEEyNTYsCiAgICBTSEE1MTI6IGJpbmRpbmcuU0hBNTEyLAogICAgQkxBS0UyQjI1NjogYmluZGluZy5CTEFLRTJCMjU2CiAgfSwKICBzaWduYXR1cmU6IHsKICAgIEVEMjU1MTk6IGJpbmRpbmcuRUQyNTUxOQogIH0sCiAgY2lwaGVyOiB7CiAgICBBRVMxMjhFQ0I6IGJpbmRpbmcuQUVTMTI4RUNCLAogICAgQUVTMTI4Q0JDOiBiaW5kaW5nLkFFUzEyOENCQywKICAgIEFFUzEyOENUUjogYmluZGluZy5BRVMxMjhDVFIsCiAgICBBRVMxMjhPRkI6IGJpbmRpbmcuQUVTMTI4T0ZCLAogICAgQUVTMjU2RUNCOiBiaW5kaW5nLkFFUzI1NkVDQiwKICAgIEFFUzI1NkNCQzogYmluZGluZy5BRVMyNTZDQkMsCiAgICBBRVMyNTZDVFI6IGJpbmRpbmcuQUVTMjU2Q1RSLAogICAgQUVTMjU2T0ZCOiBiaW5kaW5nLkFFUzI1Nk9GQiwKICAgIEFFUzEyOEdDTTogYmluZGluZy5BRVMxMjhHQ00sCiAgICBBRVMyNTZHQ006IGJpbmRpbmcuQUVTMjU2R0NNLAogICAgQ0hBQ0hBMjBQT0xZMTMwNTogYmluZGluZy5DSEFDSEEyMFBPTFkxMzA1LAogICAgWENIQUNIQTIwUE9MWTEzMDU6IGJpbmRpbmcuWENIQUNIQTIwUE9MWTEzMDUKICB9LAogIGtleVR5cGU6IHsKICAgIEVEMjU1MTk6IGJpbmRpbmcuRUQyNTUxOQogIH0KfQoKZXhwb3J0cy50b0hhc2ggPSBmdW5jdGlvbiB0b0hhc2goaGFzaCkgewogIGlmICh0eXBlb2YgaGFzaCA9PT0gJ251bWJlcicpIHJldHVybiBoYXNoCgogIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3N0cmluZycpIHsKICAgIGhhc2ggPSBoYXNoLnJlcGxhY2UoLy0vZywgJycpCgogICAgaWYgKGhhc2ggaW4gZXhwb3J0cy5oYXNoID09PSBmYWxzZSkgewogICAgICBoYXNoID0gaGFzaC50b1VwcGVyQ2FzZSgpCgogICAgICBpZiAoaGFzaCBpbiBleHBvcnRzLmhhc2ggPT09IGZhbHNlKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLlVOS05PV05fSEFTSChgVW5rbm93biBoYXNoICcke2hhc2h9J2ApCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZXhwb3J0cy5oYXNoW2hhc2hdCiAgfQoKICB0aHJvdyBuZXcgVHlwZUVycm9yKGBIYXNoIG11c3QgYmUgYSBudW1iZXIgb3Igc3RyaW5nLiBSZWNlaXZlZCAke3R5cGVvZiBoYXNofSAoJHtoYXNofSlgKQp9CgpleHBvcnRzLnRvQ2lwaGVyID0gZnVuY3Rpb24gdG9DaXBlcihjaXBoZXIpIHsKICBpZiAodHlwZW9mIGNpcGhlciA9PT0gJ251bWJlcicpIHJldHVybiBjaXBoZXIKCiAgaWYgKHR5cGVvZiBjaXBoZXIgPT09ICdzdHJpbmcnKSB7CiAgICBjaXBoZXIgPSBjaXBoZXIucmVwbGFjZSgvLS9nLCAnJykKCiAgICBpZiAoY2lwaGVyIGluIGV4cG9ydHMuY2lwaGVyID09PSBmYWxzZSkgewogICAgICBjaXBoZXIgPSBjaXBoZXIudG9VcHBlckNhc2UoKQoKICAgICAgaWYgKGNpcGhlciBpbiBleHBvcnRzLmNpcGhlciA9PT0gZmFsc2UpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuVU5LTk9XTl9DSVBIRVIoYFVua25vd24gY2lwaGVyICcke2NpcGhlcn0nYCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBleHBvcnRzLmNpcGhlcltjaXBoZXJdCiAgfQoKICB0aHJvdyBuZXcgVHlwZUVycm9yKGBDaXBoZXIgbXVzdCBiZSBhIG51bWJlciBvciBzdHJpbmcuIFJlY2VpdmVkICR7dHlwZW9mIGNpcGhlcn0gKCR7Y2lwaGVyfSlgKQp9CgpleHBvcnRzLnRvS2V5VHlwZSA9IGZ1bmN0aW9uIHRvS2V5VHlwZSh0eXBlKSB7CiAgaWYgKHR5cGVvZiB0eXBlID09PSAnbnVtYmVyJykgcmV0dXJuIHR5cGUKCiAgaWYgKHR5cGVvZiB0eXBlID09PSAnc3RyaW5nJykgewogICAgdHlwZSA9IHR5cGUucmVwbGFjZSgvLS9nLCAnJykKCiAgICBpZiAodHlwZSBpbiBleHBvcnRzLmtleVR5cGUgPT09IGZhbHNlKSB7CiAgICAgIHR5cGUgPSB0eXBlLnRvVXBwZXJDYXNlKCkKCiAgICAgIGlmICh0eXBlIGluIGV4cG9ydHMua2V5VHlwZSA9PT0gZmFsc2UpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuVU5LTk9XTl9LRVlfVFlQRShgVW5rbm93biBrZXkgdHlwZSAnJHt0eXBlfSdgKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGV4cG9ydHMua2V5VHlwZVt0eXBlXQogIH0KCiAgdGhyb3cgbmV3IFR5cGVFcnJvcihgS2V5IHR5cGUgbXVzdCBiZSBhIG51bWJlciBvciBzdHJpbmcuIFJlY2VpdmVkICR7dHlwZW9mIHR5cGV9ICgke3R5cGV9KWApCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBDcnlwdG9FcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3Rvcihtc2csIGZuID0gQ3J5cHRvRXJyb3IsIGNvZGUgPSBmbi5uYW1lKSB7CiAgICBzdXBlcihgJHtjb2RlfTogJHttc2d9YCkKICAgIHRoaXMuY29kZSA9IGNvZGUKCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgZm4pCiAgICB9CiAgfQoKICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiAnQ3J5cHRvRXJyb3InCiAgfQoKICBzdGF0aWMgVU5LTk9XTl9IQVNIKG1zZykgewogICAgcmV0dXJuIG5ldyBDcnlwdG9FcnJvcihtc2csIENyeXB0b0Vycm9yLlVOS05PV05fSEFTSCkKICB9CgogIHN0YXRpYyBVTktOT1dOX0NJUEhFUihtc2cpIHsKICAgIHJldHVybiBuZXcgQ3J5cHRvRXJyb3IobXNnLCBDcnlwdG9FcnJvci5VTktOT1dOX0NJUEhFUikKICB9CgogIHN0YXRpYyBVTktOT1dOX0tFWV9UWVBFKG1zZykgewogICAgcmV0dXJuIG5ldyBDcnlwdG9FcnJvcihtc2csIENyeXB0b0Vycm9yLlVOS05PV05fS0VZX1RZUEUpCiAgfQoKICBzdGF0aWMgSU5WQUxJRF9BQ0NFU1MobXNnKSB7CiAgICByZXR1cm4gbmV3IENyeXB0b0Vycm9yKG1zZywgQ3J5cHRvRXJyb3IuSU5WQUxJRF9BQ0NFU1MpCiAgfQoKICBzdGF0aWMgSU5WQUxJRF9EQVRBKG1zZykgewogICAgcmV0dXJuIG5ldyBDcnlwdG9FcnJvcihtc2csIENyeXB0b0Vycm9yLklOVkFMSURfREFUQSkKICB9CgogIHN0YXRpYyBPUEVSQVRJT05fRVJST1IobXNnKSB7CiAgICByZXR1cm4gbmV3IENyeXB0b0Vycm9yKG1zZywgQ3J5cHRvRXJyb3IuT1BFUkFUSU9OX0VSUk9SKQogIH0KCiAgc3RhdGljIE5PVF9TVVBQT1JURUQobXNnKSB7CiAgICByZXR1cm4gbmV3IENyeXB0b0Vycm9yKG1zZywgQ3J5cHRvRXJyb3IuTk9UX1NVUFBPUlRFRCkKICB9Cn0KY29uc3QgeyBUcmFuc2Zvcm0gfSA9IHJlcXVpcmUoJ2JhcmUtc3RyZWFtJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQpjb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENyeXB0b0hhc2ggZXh0ZW5kcyBUcmFuc2Zvcm0gewogIGNvbnN0cnVjdG9yKGFsZ29yaXRobSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcihvcHRzKQoKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcuaGFzaEluaXQoY29uc3RhbnRzLnRvSGFzaChhbGdvcml0aG0pKQogIH0KCiAgdXBkYXRlKGRhdGEsIGVuY29kaW5nID0gJ3V0ZjgnKSB7CiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSBkYXRhID0gQnVmZmVyLmZyb20oZGF0YSwgZW5jb2RpbmcpCgogICAgYmluZGluZy5oYXNoVXBkYXRlKHRoaXMuX2hhbmRsZSwgZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCwgZGF0YS5ieXRlTGVuZ3RoKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBkaWdlc3QoZW5jb2RpbmcpIHsKICAgIGNvbnN0IGRpZ2VzdCA9IEJ1ZmZlci5mcm9tKGJpbmRpbmcuaGFzaEZpbmFsKHRoaXMuX2hhbmRsZSkpCgogICAgcmV0dXJuIGVuY29kaW5nICYmIGVuY29kaW5nICE9PSAnYnVmZmVyJyA/IGRpZ2VzdC50b1N0cmluZyhlbmNvZGluZykgOiBkaWdlc3QKICB9CgogIF90cmFuc2Zvcm0oZGF0YSwgZW5jb2RpbmcsIGNiKSB7CiAgICB0aGlzLnVwZGF0ZShkYXRhKQoKICAgIGNiKG51bGwpCiAgfQoKICBfZmx1c2goY2IpIHsKICAgIHRoaXMucHVzaCh0aGlzLmRpZ2VzdCgpKQoKICAgIGNiKG51bGwpCiAgfQp9CmNvbnN0IHsgVHJhbnNmb3JtIH0gPSByZXF1aXJlKCdiYXJlLXN0cmVhbScpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBDcnlwdG9IbWFjIGV4dGVuZHMgVHJhbnNmb3JtIHsKICBjb25zdHJ1Y3RvcihhbGdvcml0aG0sIGtleSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcihvcHRzKQoKICAgIGNvbnN0IHsgZW5jb2RpbmcgPSAndXRmOCcgfSA9IG9wdHMKCiAgICBpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycpIGtleSA9IEJ1ZmZlci5mcm9tKGtleSwgZW5jb2RpbmcpCgogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5obWFjSW5pdCgKICAgICAgY29uc3RhbnRzLnRvSGFzaChhbGdvcml0aG0pLAogICAgICBrZXkuYnVmZmVyLAogICAgICBrZXkuYnl0ZU9mZnNldCwKICAgICAga2V5LmJ5dGVMZW5ndGgKICAgICkKICB9CgogIHVwZGF0ZShkYXRhLCBlbmNvZGluZyA9ICd1dGY4JykgewogICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEsIGVuY29kaW5nKQoKICAgIGJpbmRpbmcuaG1hY1VwZGF0ZSh0aGlzLl9oYW5kbGUsIGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQsIGRhdGEuYnl0ZUxlbmd0aCkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgZGlnZXN0KGVuY29kaW5nKSB7CiAgICBjb25zdCBkaWdlc3QgPSBCdWZmZXIuZnJvbShiaW5kaW5nLmhtYWNGaW5hbCh0aGlzLl9oYW5kbGUpKQoKICAgIHJldHVybiBlbmNvZGluZyAmJiBlbmNvZGluZyAhPT0gJ2J1ZmZlcicgPyBkaWdlc3QudG9TdHJpbmcoZW5jb2RpbmcpIDogZGlnZXN0CiAgfQoKICBfdHJhbnNmb3JtKGRhdGEsIGVuY29kaW5nLCBjYikgewogICAgdGhpcy51cGRhdGUoZGF0YSkKCiAgICBjYihudWxsKQogIH0KCiAgX2ZsdXNoKGNiKSB7CiAgICB0aGlzLnB1c2godGhpcy5kaWdlc3QoKSkKCiAgICBjYihudWxsKQogIH0KfQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCmNvbnN0IHsKICBrZXlUeXBlOiB7IEVEMjU1MTkgfQp9ID0gY29uc3RhbnRzCgpjbGFzcyBDcnlwdG9LZXkgewogIGNvbnN0cnVjdG9yKGtleVR5cGUpIHsKICAgIHRoaXMuX2tleVR5cGUgPSBrZXlUeXBlCiAgfQp9CgpleHBvcnRzLktleSA9IENyeXB0b0tleQoKY2xhc3MgQ3J5cHRvRWQyNTUxOUtleSBleHRlbmRzIENyeXB0b0tleSB7CiAgY29uc3RydWN0b3Ioa2V5KSB7CiAgICBzdXBlcihFRDI1NTE5KQoKICAgIHRoaXMuX2tleSA9IGtleQogIH0KCiAgZ2V0IGFzeW1tZXRyaWNLZXlUeXBlKCkgewogICAgcmV0dXJuICdlZDI1NTE5JwogIH0KfQoKY2xhc3MgQ3J5cHRvRWQyNTUxOVB1YmxpY0tleSBleHRlbmRzIENyeXB0b0VkMjU1MTlLZXkgewogIGdldCB0eXBlKCkgewogICAgcmV0dXJuICdwdWJsaWMnCiAgfQp9CgpleHBvcnRzLkVkMjU1MTlQdWJsaWNLZXkgPSBDcnlwdG9FZDI1NTE5UHVibGljS2V5CgpjbGFzcyBDcnlwdG9FZDI1NTE5UHJpdmF0ZUtleSBleHRlbmRzIENyeXB0b0VkMjU1MTlLZXkgewogIGdldCB0eXBlKCkgewogICAgcmV0dXJuICdwcml2YXRlJwogIH0KfQoKZXhwb3J0cy5FZDI1NTE5UHJpdmF0ZUtleSA9IENyeXB0b0VkMjU1MTlQcml2YXRlS2V5CgpleHBvcnRzLmdlbmVyYXRlS2V5UGFpciA9IGZ1bmN0aW9uIGdlbmVyYXRlS2V5UGFpcih0eXBlLCBvcHRzID0ge30pIHsKICB0eXBlID0gY29uc3RhbnRzLnRvS2V5VHlwZSh0eXBlKQoKICBzd2l0Y2ggKHR5cGUpIHsKICAgIGNhc2UgRUQyNTUxOTogewogICAgICBjb25zdCB7IHB1YmxpY0tleSwgcHJpdmF0ZUtleSB9ID0gYmluZGluZy5lZDI1NTE5R2VuZXJhdGVLZXlwYWlyKCkKCiAgICAgIHJldHVybiB7CiAgICAgICAgcHVibGljS2V5OiBuZXcgQ3J5cHRvRWQyNTUxOVB1YmxpY0tleShwdWJsaWNLZXkpLAogICAgICAgIHByaXZhdGVLZXk6IG5ldyBDcnlwdG9FZDI1NTE5UHJpdmF0ZUtleShwcml2YXRlS2V5KQogICAgICB9CiAgICB9CiAgfQp9CmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBwYmtkZjIocGFzc3dvcmQsIHNhbHQsIGl0ZXJhdGlvbnMsIGtleWxlbiwgZGlnZXN0LCBjYikgewogIGlmIChpdGVyYXRpb25zIDw9IDApIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdpdGVyYXRpb25zIGlzIG91dCBvZiByYW5nZScpCiAgfQoKICBpZiAodHlwZW9mIHBhc3N3b3JkID09PSAnc3RyaW5nJykgcGFzc3dvcmQgPSBCdWZmZXIuZnJvbShwYXNzd29yZCkKICBpZiAodHlwZW9mIHNhbHQgPT09ICdzdHJpbmcnKSBzYWx0ID0gQnVmZmVyLmZyb20oc2FsdCkKCiAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmZyb20oCiAgICBiaW5kaW5nLnBia2RmMigKICAgICAgcGFzc3dvcmQuYnVmZmVyLAogICAgICBwYXNzd29yZC5ieXRlT2Zmc2V0LAogICAgICBwYXNzd29yZC5ieXRlTGVuZ3RoLAogICAgICBzYWx0LmJ1ZmZlciwKICAgICAgc2FsdC5ieXRlT2Zmc2V0LAogICAgICBzYWx0LmJ5dGVMZW5ndGgsCiAgICAgIGl0ZXJhdGlvbnMsCiAgICAgIGNvbnN0YW50cy50b0hhc2goZGlnZXN0KSwKICAgICAga2V5bGVuCiAgICApCiAgKQoKICBpZiAoY2IpIHF1ZXVlTWljcm90YXNrKCgpID0+IGNiKG51bGwsIGJ1ZmZlcikpCiAgZWxzZSByZXR1cm4gYnVmZmVyCn0KY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQoKZXhwb3J0cy5yYW5kb21CeXRlcyA9IGZ1bmN0aW9uIHJhbmRvbUJ5dGVzKHNpemUsIGNiKSB7CiAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKHNpemUpCiAgZXhwb3J0cy5yYW5kb21GaWxsKGJ1ZmZlcikKICBpZiAoY2IpIHF1ZXVlTWljcm90YXNrKCgpID0+IGNiKG51bGwsIGJ1ZmZlcikpCiAgZWxzZSByZXR1cm4gYnVmZmVyCn0KCmV4cG9ydHMucmFuZG9tRmlsbCA9IGZ1bmN0aW9uIHJhbmRvbUZpbGwoYnVmZmVyLCBvZmZzZXQsIHNpemUsIGNiKSB7CiAgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb2Zmc2V0CiAgICBvZmZzZXQgPSB1bmRlZmluZWQKICB9IGVsc2UgaWYgKHR5cGVvZiBzaXplID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IHNpemUKICAgIHNpemUgPSB1bmRlZmluZWQKICB9CgogIGNvbnN0IGVsZW1lbnRTaXplID0gYnVmZmVyLkJZVEVTX1BFUl9FTEVNRU5UIHx8IDEKCiAgaWYgKG9mZnNldCA9PT0gdW5kZWZpbmVkKSBvZmZzZXQgPSAwCiAgZWxzZSBvZmZzZXQgKj0gZWxlbWVudFNpemUKCiAgaWYgKHNpemUgPT09IHVuZGVmaW5lZCkgc2l6ZSA9IGJ1ZmZlci5ieXRlTGVuZ3RoIC0gb2Zmc2V0CiAgZWxzZSBzaXplICo9IGVsZW1lbnRTaXplCgogIGlmIChvZmZzZXQgPCAwIHx8IG9mZnNldCA+IGJ1ZmZlci5ieXRlTGVuZ3RoKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignb2Zmc2V0IGlzIG91dCBvZiByYW5nZScpCiAgfQoKICBpZiAoc2l6ZSA8IDAgfHwgc2l6ZSA+IGJ1ZmZlci5ieXRlTGVuZ3RoKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignc2l6ZSBpcyBvdXQgb2YgcmFuZ2UnKQogIH0KCiAgaWYgKG9mZnNldCArIHNpemUgPiBidWZmZXIuYnl0ZUxlbmd0aCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ29mZnNldCArIHNpemUgaXMgb3V0IG9mIHJhbmdlJykKICB9CgogIGxldCBhcnJheWJ1ZmZlcgoKICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KGJ1ZmZlcikpIHsKICAgIG9mZnNldCArPSBidWZmZXIuYnl0ZU9mZnNldAogICAgYXJyYXlidWZmZXIgPSBidWZmZXIuYnVmZmVyCiAgfSBlbHNlIHsKICAgIGFycmF5YnVmZmVyID0gYnVmZmVyCiAgfQoKICBiaW5kaW5nLnJhbmRvbUZpbGwoYXJyYXlidWZmZXIsIG9mZnNldCwgc2l6ZSkKCiAgaWYgKGNiKSBxdWV1ZU1pY3JvdGFzaygoKSA9PiBjYihudWxsLCBidWZmZXIpKQogIGVsc2UgcmV0dXJuIGJ1ZmZlcgp9CgpleHBvcnRzLnJhbmRvbVVVSUQgPSBmdW5jdGlvbiByYW5kb21VVUlEKCkgewogIGNvbnN0IHV1aWQgPSBleHBvcnRzLnJhbmRvbUJ5dGVzKDE2KQoKICB1dWlkWzZdID0gKHV1aWRbNl0gPj4+IDQpIHwgMGIwMTAwMDAwMAogIHV1aWRbOF0gPSAodXVpZFs4XSA+Pj4gMikgfCAwYjEwMDAwMDAwCgogIHJldHVybiAoCiAgICB1dWlkLnN1YmFycmF5KDAsIDQpLnRvU3RyaW5nKCdoZXgnKSArCiAgICAnLScgKwogICAgdXVpZC5zdWJhcnJheSg0LCA2KS50b1N0cmluZygnaGV4JykgKwogICAgJy0nICsKICAgIHV1aWQuc3ViYXJyYXkoNiwgOCkudG9TdHJpbmcoJ2hleCcpICsKICAgICctJyArCiAgICB1dWlkLnN1YmFycmF5KDgsIDEwKS50b1N0cmluZygnaGV4JykgKwogICAgJy0nICsKICAgIHV1aWQuc3ViYXJyYXkoMTAsIDE2KS50b1N0cmluZygnaGV4JykKICApCn0KY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQpjb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgpjb25zdCB7CiAga2V5VHlwZTogeyBFRDI1NTE5IH0KfSA9IGNvbnN0YW50cwoKZXhwb3J0cy5zaWduID0gZnVuY3Rpb24gc2lnbihhbGdvcml0aG0sIGRhdGEsIGtleSkgewogIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoZGF0YSkpIHsKICAgIGRhdGEgPSBCdWZmZXIuY29lcmNlKGRhdGEpCiAgfSBlbHNlIHsKICAgIGRhdGEgPSBCdWZmZXIuZnJvbShkYXRhKQogIH0KCiAgc3dpdGNoIChrZXkuX2tleVR5cGUpIHsKICAgIGNhc2UgRUQyNTUxOToKICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKAogICAgICAgIGJpbmRpbmcuZWQyNTUxOVNpZ24oZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCwgZGF0YS5ieXRlTGVuZ3RoLCBrZXkuX2tleSkKICAgICAgKQogIH0KfQoKZXhwb3J0cy52ZXJpZnkgPSBmdW5jdGlvbiB2ZXJpZnkoYWxnb3JpdGhtLCBkYXRhLCBrZXksIHNpZ25hdHVyZSkgewogIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoZGF0YSkpIHsKICAgIGRhdGEgPSBCdWZmZXIuY29lcmNlKGRhdGEpCiAgfSBlbHNlIHsKICAgIGRhdGEgPSBCdWZmZXIuZnJvbShkYXRhKQogIH0KCiAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhzaWduYXR1cmUpKSB7CiAgICBzaWduYXR1cmUgPSBCdWZmZXIuY29lcmNlKHNpZ25hdHVyZSkKICB9IGVsc2UgewogICAgc2lnbmF0dXJlID0gQnVmZmVyLmZyb20oc2lnbmF0dXJlKQogIH0KCiAgc3dpdGNoIChrZXkuX2tleVR5cGUpIHsKICAgIGNhc2UgRUQyNTUxOToKICAgICAgcmV0dXJuIGJpbmRpbmcuZWQyNTUxOVZlcmlmeSgKICAgICAgICBkYXRhLmJ1ZmZlciwKICAgICAgICBkYXRhLmJ5dGVPZmZzZXQsCiAgICAgICAgZGF0YS5ieXRlTGVuZ3RoLAogICAgICAgIHNpZ25hdHVyZS5idWZmZXIsCiAgICAgICAgc2lnbmF0dXJlLmJ5dGVPZmZzZXQsCiAgICAgICAga2V5Ll9rZXkKICAgICAgKQogIH0KfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCcuLi8uLi8uLicpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi8uLi8uLi9iaW5kaW5nJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi4vLi4vZXJyb3JzJykKY29uc3QgeyBFZDI1NTE5UHVibGljS2V5LCBFZDI1NTE5UHJpdmF0ZUtleSB9ID0gcmVxdWlyZSgnLi4vLi4va2V5JykKY29uc3QgQ3J5cHRvS2V5ID0gcmVxdWlyZSgnLi4vY3J5cHRvLWtleScpCgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNlZDI1NTE5CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNlZDI1NTE5LW9wZXJhdGlvbnMtc2lnbgpleHBvcnRzLnNpZ24gPSBmdW5jdGlvbiBzaWduKGFsZ29yaXRobSwga2V5LCBkYXRhKSB7CiAgaWYgKGtleS50eXBlICE9PSAncHJpdmF0ZScpIHsKICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUygnTXVzdCBwYXNzIHByaXZhdGUga2V5IGZvciBFZDI1NTE5IHNpZ25pbmcnKQogIH0KCiAgY29uc3Qgc2lnbmF0dXJlID0gY3J5cHRvLnNpZ24obnVsbCwgZGF0YSwga2V5Ll9oYW5kbGUpCgogIHJldHVybiBzaWduYXR1cmUuYnVmZmVyLnNsaWNlKDAsIHNpZ25hdHVyZS5ieXRlTGVuZ3RoKQp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNlZDI1NTE5LW9wZXJhdGlvbnMtdmVyaWZ5CmV4cG9ydHMudmVyaWZ5ID0gZnVuY3Rpb24gdmVyaWZ5KGFsZ29yaXRobSwga2V5LCBzaWduYXR1cmUsIGRhdGEpIHsKICBpZiAoa2V5LnR5cGUgIT09ICdwdWJsaWMnKSB7CiAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoJ011c3QgcGFzcyBwdWJsaWMga2V5IGZvciBFZDI1NTE5IHZlcmlmaWNhdGlvbicpCiAgfQoKICByZXR1cm4gY3J5cHRvLnZlcmlmeShudWxsLCBkYXRhLCBrZXkuX2hhbmRsZSwgc2lnbmF0dXJlKQp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNlZDI1NTE5LW9wZXJhdGlvbnMtZ2VuZXJhdGUta2V5CmV4cG9ydHMuZ2VuZXJhdGVLZXkgPSBmdW5jdGlvbiBnZW5lcmF0ZUtleShhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpIHsKICBmb3IgKGNvbnN0IHVzYWdlIG9mIHVzYWdlcykgewogICAgaWYgKHVzYWdlICE9PSAnc2lnbicgJiYgdXNhZ2UgIT09ICd2ZXJpZnknKSB7CiAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcigKICAgICAgICBgVXNhZ2UgJyR7dXNhZ2V9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEVkMjU1MTkgZ2VuZXJhdGVLZXkoKSBvcGVyYXRpb25gCiAgICAgICkKICAgIH0KICB9CgogIGNvbnN0IGtleXMgPSBjcnlwdG8uZ2VuZXJhdGVLZXlQYWlyKCdlZDI1NTE5JykKCiAgYWxnb3JpdGhtID0geyBuYW1lOiAnRWQyNTUxOScgfQoKICByZXR1cm4gewogICAgcHVibGljS2V5OiBuZXcgQ3J5cHRvS2V5KCdwdWJsaWMnLCB0cnVlLCBhbGdvcml0aG0sIFsndmVyaWZ5J10sIGtleXMucHVibGljS2V5KSwKICAgIHByaXZhdGVLZXk6IG5ldyBDcnlwdG9LZXkoJ3ByaXZhdGUnLCBleHRyYWN0YWJsZSwgYWxnb3JpdGhtLCBbJ3NpZ24nXSwga2V5cy5wcml2YXRlS2V5KQogIH0KfQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jZWQyNTUxOS1vcGVyYXRpb25zLWltcG9ydC1rZXkKZXhwb3J0cy5pbXBvcnRLZXkgPSBmdW5jdGlvbiBpbXBvcnRLZXkoZm9ybWF0LCBrZXlEYXRhLCBhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpIHsKICBzd2l0Y2ggKGZvcm1hdCkgewogICAgY2FzZSAnc3BraSc6CiAgICAgIGZvciAoY29uc3QgdXNhZ2Ugb2YgdXNhZ2VzKSB7CiAgICAgICAgaWYgKHVzYWdlICE9PSAndmVyaWZ5JykgewogICAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKAogICAgICAgICAgICBgVXNhZ2UgJyR7dXNhZ2V9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEVkMjU1MTkgaW1wb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICAgICAgKQogICAgICAgIH0KICAgICAgfQoKICAgICAga2V5RGF0YSA9IGJpbmRpbmcuZWQyNTUxOUZyb21TUEtJKGtleURhdGEuYnVmZmVyLCBrZXlEYXRhLmJ5dGVPZmZzZXQsIGtleURhdGEuYnl0ZUxlbmd0aCkKCiAgICAgIHJldHVybiBuZXcgQ3J5cHRvS2V5KAogICAgICAgICdwdWJsaWMnLAogICAgICAgIGV4dHJhY3RhYmxlLAogICAgICAgIHsKICAgICAgICAgIG5hbWU6ICdFZDI1NTE5JwogICAgICAgIH0sCiAgICAgICAgdXNhZ2VzLAogICAgICAgIG5ldyBFZDI1NTE5UHVibGljS2V5KGtleURhdGEpCiAgICAgICkKICAgIGNhc2UgJ3BrY3M4JzoKICAgICAgZm9yIChjb25zdCB1c2FnZSBvZiB1c2FnZXMpIHsKICAgICAgICBpZiAodXNhZ2UgIT09ICdzaWduJykgewogICAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKAogICAgICAgICAgICBgVXNhZ2UgJyR7dXNhZ2V9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEVkMjU1MTkgaW1wb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICAgICAgKQogICAgICAgIH0KICAgICAgfQoKICAgICAga2V5RGF0YSA9IGJpbmRpbmcuZWQyNTUxOUZyb21QS0NTOChrZXlEYXRhLmJ1ZmZlciwga2V5RGF0YS5ieXRlT2Zmc2V0LCBrZXlEYXRhLmJ5dGVMZW5ndGgpCgogICAgICByZXR1cm4gbmV3IENyeXB0b0tleSgKICAgICAgICAncHJpdmF0ZScsCiAgICAgICAgZXh0cmFjdGFibGUsCiAgICAgICAgewogICAgICAgICAgbmFtZTogJ0VkMjU1MTknCiAgICAgICAgfSwKICAgICAgICB1c2FnZXMsCiAgICAgICAgbmV3IEVkMjU1MTlQcml2YXRlS2V5KGtleURhdGEpCiAgICAgICkKICAgIGNhc2UgJ3Jhdyc6CiAgICAgIGZvciAoY29uc3QgdXNhZ2Ugb2YgdXNhZ2VzKSB7CiAgICAgICAgaWYgKHVzYWdlICE9PSAndmVyaWZ5JykgewogICAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKAogICAgICAgICAgICBgVXNhZ2UgJyR7dXNhZ2V9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEVkMjU1MTkgaW1wb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICAgICAgKQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGtleURhdGEuYnl0ZUxlbmd0aCAqIDggIT09IDI1NikgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0tleSBtdXN0IGJlIDI1NiBiaXRzJykKICAgICAgfQoKICAgICAgcmV0dXJuIG5ldyBDcnlwdG9LZXkoCiAgICAgICAgJ3B1YmxpYycsCiAgICAgICAgZXh0cmFjdGFibGUsCiAgICAgICAgewogICAgICAgICAgbmFtZTogJ0VkMjU1MTknCiAgICAgICAgfSwKICAgICAgICB1c2FnZXMsCiAgICAgICAgbmV3IEVkMjU1MTlQdWJsaWNLZXkoa2V5RGF0YS5idWZmZXIpCiAgICAgICkKICAgIGNhc2UgJ2p3ayc6CiAgICAgIGNvbnN0IGp3ayA9IGtleURhdGEKCiAgICAgIGlmICgnZCcgaW4gandrKSB7CiAgICAgICAgaWYgKHVzYWdlcy5zb21lKCh1c2FnZSkgPT4gdXNhZ2UgIT09ICdzaWduJykpIHsKICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcignSldLIG11c3QgYmUgdmFsaWQgZm9yIHNpZ25pbmcnKQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodXNhZ2VzLnNvbWUoKHVzYWdlKSA9PiB1c2FnZSAhPT0gJ3ZlcmlmeScpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoJ0pXSyBtdXN0IGJlIHZhbGlkIGZvciB2ZXJpZmljYXRpb24nKQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGp3ay5rdHkgIT09ICdPS1AnKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnSldLIGtleSBtdXN0IGJlIGFuIG9jdGV0IGtleS1wYWlyJykKICAgICAgfQoKICAgICAgaWYgKGp3ay5jcnYgIT09ICdFZDI1NTE5JykgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0pXSyBtdXN0IHVzZSB0aGUgRWQyNTUxOSBjdXJ2ZScpCiAgICAgIH0KCiAgICAgIGlmICgnYWxnJyBpbiBqd2sgJiYgandrLmFsZyAhPT0gJ0VkMjU1MTknICYmIGp3ay5hbGcgIT09ICdFZERTQScpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdKV0sgbXVzdCB1c2UgdGhlIEVkMjU1MTkgY3VydmUnKQogICAgICB9CgogICAgICBpZiAodXNhZ2VzLmxlbmd0aCAmJiAndXNlJyBpbiBqd2sgJiYgandrLnVzZSAhPT0gJ3NpZycpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdKV0sgY2Fubm90IGJlIHVzZWQgZm9yIHNpZ25hdHVyZXMnKQogICAgICB9CgogICAgICBpZiAoJ2V4dCcgaW4gandrICYmIGp3ay5leHQgIT09IGV4dHJhY3RhYmxlICYmIGV4dHJhY3RhYmxlKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnSldLIGlzIG5vdCBleHRyYWN0YWJsZScpCiAgICAgIH0KCiAgICAgIGlmICgnZCcgaW4gandrKSB7CiAgICAgICAgY29uc3Qga2V5ID0gQnVmZmVyLmNvbmNhdChbCiAgICAgICAgICBCdWZmZXIuZnJvbShqd2suZCwgJ2Jhc2U2NHVybCcpLAogICAgICAgICAgQnVmZmVyLmZyb20oandrLngsICdiYXNlNjR1cmwnKQogICAgICAgIF0pCgogICAgICAgIGlmIChrZXkuYnl0ZUxlbmd0aCAqIDggIT09IDUxMikgewogICAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnS2V5IG11c3QgYmUgNTEyIGJpdHMnKQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG5ldyBDcnlwdG9LZXkoCiAgICAgICAgICAncHJpdmF0ZScsCiAgICAgICAgICBleHRyYWN0YWJsZSwKICAgICAgICAgIHsKICAgICAgICAgICAgbmFtZTogJ0VkMjU1MTknCiAgICAgICAgICB9LAogICAgICAgICAgdXNhZ2VzLAogICAgICAgICAgbmV3IEVkMjU1MTlQcml2YXRlS2V5KGtleS5idWZmZXIpCiAgICAgICAgKQogICAgICB9CgogICAgICBjb25zdCBrZXkgPSBCdWZmZXIuZnJvbShqd2sueCwgJ2Jhc2U2NHVybCcpCgogICAgICBpZiAoa2V5LmJ5dGVMZW5ndGggKiA4ICE9PSAyNTYpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdLZXkgbXVzdCBiZSAyNTYgYml0cycpCiAgICAgIH0KCiAgICAgIHJldHVybiBuZXcgQ3J5cHRvS2V5KAogICAgICAgICdwdWJsaWMnLAogICAgICAgIGV4dHJhY3RhYmxlLAogICAgICAgIHsKICAgICAgICAgIG5hbWU6ICdFZDI1NTE5JwogICAgICAgIH0sCiAgICAgICAgdXNhZ2VzLAogICAgICAgIG5ldyBFZDI1NTE5UHVibGljS2V5KGtleS5idWZmZXIpCiAgICAgICkKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgIGBGb3JtYXQgJyR7Zm9ybWF0fScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBFZDI1NTE5IGltcG9ydEtleSgpIG9wZXJhdGlvbmAKICAgICAgKQogIH0KfQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jZWQyNTUxOS1vcGVyYXRpb25zLWV4cG9ydC1rZXkKZXhwb3J0cy5leHBvcnRLZXkgPSBmdW5jdGlvbiBleHBvcnRLZXkoZm9ybWF0LCBrZXkpIHsKICBjb25zdCBkYXRhID0ga2V5Ll9oYW5kbGUKCiAgc3dpdGNoIChmb3JtYXQpIHsKICAgIGNhc2UgJ3Nwa2knOgogICAgICBpZiAoa2V5LnR5cGUgIT09ICdwdWJsaWMnKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKAogICAgICAgICAgYEtleSBvZiB0eXBlICcke2tleS50eXBlfScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBFZDI1NTE5IGV4cG9ydEtleSgpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICAgIH0KCiAgICAgIHJldHVybiBiaW5kaW5nLmVkMjU1MTlUb1NQS0koZGF0YS5fa2V5KQogICAgY2FzZSAncGtjczgnOgogICAgICBpZiAoa2V5LnR5cGUgIT09ICdwcml2YXRlJykgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUygKICAgICAgICAgIGBLZXkgb2YgdHlwZSAnJHtrZXkudHlwZX0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgRWQyNTUxOSBleHBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgICB9CgogICAgICByZXR1cm4gYmluZGluZy5lZDI1NTE5VG9QS0NTOChkYXRhLl9rZXkpCiAgICBjYXNlICdyYXcnOiB7CiAgICAgIGlmIChrZXkudHlwZSAhPT0gJ3B1YmxpYycpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoCiAgICAgICAgICBgS2V5IG9mIHR5cGUgJyR7a2V5LnR5cGV9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEVkMjU1MTkgZXhwb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgICAgfQoKICAgICAgcmV0dXJuIGRhdGEuX2tleS5zbGljZSgpCiAgICB9CiAgICBjYXNlICdqd2snOiB7CiAgICAgIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5mcm9tKGRhdGEuX2tleSkKCiAgICAgIGlmIChrZXkudHlwZSA9PT0gJ3ByaXZhdGUnKSB7CiAgICAgICAgY29uc3QgZCA9IGJ1ZmZlci5zdWJhcnJheSgwLCAzMikudG9TdHJpbmcoJ2Jhc2U2NHVybCcpCiAgICAgICAgY29uc3QgeCA9IGJ1ZmZlci5zdWJhcnJheSgzMikudG9TdHJpbmcoJ2Jhc2U2NHVybCcpCgogICAgICAgIHJldHVybiB7CiAgICAgICAgICBrdHk6ICdPS1AnLAogICAgICAgICAgYWxnOiAnRWQyNTUxOScsCiAgICAgICAgICBjcnY6ICdFZDI1NTE5JywKICAgICAgICAgIHgsCiAgICAgICAgICBkLAogICAgICAgICAga2V5X29wczoga2V5LnVzYWdlcywKICAgICAgICAgIGV4dDoga2V5LmV4dHJhY3RhYmxlCiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGt0eTogJ09LUCcsCiAgICAgICAgYWxnOiAnRWQyNTUxOScsCiAgICAgICAgY3J2OiAnRWQyNTUxOScsCiAgICAgICAgeDogYnVmZmVyLnRvU3RyaW5nKCdiYXNlNjR1cmwnKSwKICAgICAgICBrZXlfb3BzOiBrZXkudXNhZ2VzLAogICAgICAgIGV4dDoga2V5LmV4dHJhY3RhYmxlCiAgICAgIH0KICAgIH0KICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgIGBGb3JtYXQgJyR7Zm9ybWF0fScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBITUFDIGV4cG9ydEtleSgpIG9wZXJhdGlvbmAKICAgICAgKQogIH0KfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCcuLi8uLi8uLicpCmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4uLy4uL2Vycm9ycycpCmNvbnN0IENyeXB0b0tleSA9IHJlcXVpcmUoJy4uL2NyeXB0by1rZXknKQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jaG1hYwoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jaG1hYy1vcGVyYXRpb25zLXNpZ24KZXhwb3J0cy5zaWduID0gZnVuY3Rpb24gc2lnbihhbGdvcml0aG0sIGtleSwgZGF0YSkgewogIGNvbnN0IGRpZ2VzdCA9IGNyeXB0by5jcmVhdGVIbWFjKGtleS5hbGdvcml0aG0uaGFzaC5uYW1lLCBrZXkuX2hhbmRsZSkudXBkYXRlKGRhdGEpLmRpZ2VzdCgpCgogIHJldHVybiBkaWdlc3QuYnVmZmVyLnNsaWNlKDAsIGRpZ2VzdC5ieXRlTGVuZ3RoKQp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNobWFjLW9wZXJhdGlvbnMtdmVyaWZ5CmV4cG9ydHMudmVyaWZ5ID0gZnVuY3Rpb24gdmVyaWZ5KGFsZ29yaXRobSwga2V5LCBzaWduYXR1cmUsIGRhdGEpIHsKICBjb25zdCBkaWdlc3QgPSBjcnlwdG8uY3JlYXRlSG1hYyhrZXkuYWxnb3JpdGhtLmhhc2gubmFtZSwga2V5Ll9oYW5kbGUpLnVwZGF0ZShkYXRhKS5kaWdlc3QoKQoKICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KHNpZ25hdHVyZSkpIHsKICAgIHNpZ25hdHVyZSA9IEJ1ZmZlci5jb2VyY2Uoc2lnbmF0dXJlKQogIH0gZWxzZSB7CiAgICBzaWduYXR1cmUgPSBCdWZmZXIuZnJvbShzaWduYXR1cmUpCiAgfQoKICByZXR1cm4gc2lnbmF0dXJlLmVxdWFscyhkaWdlc3QpCn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2htYWMtb3BlcmF0aW9ucy1nZW5lcmF0ZS1rZXkKZXhwb3J0cy5nZW5lcmF0ZUtleSA9IGZ1bmN0aW9uIGdlbmVyYXRlS2V5KGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykgewogIGZvciAoY29uc3QgdXNhZ2Ugb2YgdXNhZ2VzKSB7CiAgICBpZiAodXNhZ2UgIT09ICdzaWduJyAmJiB1c2FnZSAhPT0gJ3ZlcmlmeScpIHsKICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKGBVc2FnZSAnJHt1c2FnZX0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgSE1BQyBnZW5lcmF0ZUtleSgpIG9wZXJhdGlvbmApCiAgICB9CiAgfQoKICBjb25zdCB7IGxlbmd0aCA9IGV4cG9ydHMuZ2V0S2V5TGVuZ3RoKGFsZ29yaXRobSkgfSA9IGFsZ29yaXRobS5sZW5ndGgKCiAgbGV0IGhhc2ggPSBhbGdvcml0aG0uaGFzaAoKICBpZiAodHlwZW9mIGhhc2ggPT09ICdzdHJpbmcnKSBoYXNoID0geyBuYW1lOiBoYXNoIH0KCiAgY29uc3Qga2V5ID0gY3J5cHRvLmNyZWF0ZUhtYWMoaGFzaC5uYW1lLCBjcnlwdG8ucmFuZG9tQnl0ZXMobGVuZ3RoKSkuZGlnZXN0KCkKCiAgcmV0dXJuIG5ldyBDcnlwdG9LZXkoCiAgICAnc2VjcmV0JywKICAgIGV4dHJhY3RhYmxlLAogICAgewogICAgICBuYW1lOiAnSE1BQycsCiAgICAgIGxlbmd0aCwKICAgICAgaGFzaDogewogICAgICAgIG5hbWU6IGhhc2gubmFtZS50b1VwcGVyQ2FzZSgpCiAgICAgIH0KICAgIH0sCiAgICB1c2FnZXMsCiAgICBrZXkKICApCn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2htYWMtb3BlcmF0aW9ucy1pbXBvcnQta2V5CmV4cG9ydHMuaW1wb3J0S2V5ID0gZnVuY3Rpb24gaW1wb3J0S2V5KGZvcm1hdCwga2V5RGF0YSwgYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKSB7CiAgZm9yIChjb25zdCB1c2FnZSBvZiB1c2FnZXMpIHsKICAgIGlmICh1c2FnZSAhPT0gJ3NpZ24nICYmIHVzYWdlICE9PSAndmVyaWZ5JykgewogICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYEludmFsaWQgdXNhZ2UgJHt1c2FnZX1gKQogICAgfQogIH0KCiAgbGV0IGhhc2ggPSBhbGdvcml0aG0uaGFzaAoKICBpZiAodHlwZW9mIGhhc2ggPT09ICdzdHJpbmcnKSBoYXNoID0geyBuYW1lOiBoYXNoIH0KCiAgbGV0IGRhdGEKCiAgc3dpdGNoIChmb3JtYXQpIHsKICAgIGNhc2UgJ3Jhdyc6CiAgICAgIGRhdGEgPSBrZXlEYXRhCiAgICAgIGJyZWFrCiAgICBjYXNlICdqd2snOgogICAgICBjb25zdCBqd2sgPSBrZXlEYXRhCgogICAgICBpZiAoandrLmt0eSAhPT0gJ29jdCcpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdKV0sga2V5IG11c3QgYmUgYW4gb2N0ZXQgc2VxdWVuY2UnKQogICAgICB9CgogICAgICBkYXRhID0gQnVmZmVyLmZyb20oandrLmssICdiYXNlNjR1cmwnKQoKICAgICAgc3dpdGNoIChoYXNoLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICAgIGNhc2UgJ3NoYS0xJzoKICAgICAgICAgIGlmIChqd2suYWxnID09PSAnSFMxJykgYnJlYWsKICAgICAgICAgIGVsc2UgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnSW52YWxpZCBKV0sga2V5IGFsZ29yaXRobScpCiAgICAgICAgY2FzZSAnc2hhLTI1Nic6CiAgICAgICAgICBpZiAoandrLmFsZyA9PT0gJ0hTMjU2JykgYnJlYWsKICAgICAgICAgIGVsc2UgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnSW52YWxpZCBKV0sga2V5IGFsZ29yaXRobScpCiAgICAgICAgY2FzZSAnc2hhLTM4NCc6CiAgICAgICAgICBpZiAoandrLmFsZyA9PT0gJ0hTMzg0JykgYnJlYWsKICAgICAgICAgIGVsc2UgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnSW52YWxpZCBKV0sga2V5IGFsZ29yaXRobScpCiAgICAgICAgY2FzZSAnc2hhLTUxMic6CiAgICAgICAgICBpZiAoandrLmFsZyA9PT0gJ0hTNTEyJykgYnJlYWsKICAgICAgICAgIGVsc2UgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnSW52YWxpZCBKV0sga2V5IGFsZ29yaXRobScpCiAgICAgIH0KCiAgICAgIGlmICh1c2FnZXMubGVuZ3RoICYmICd1c2UnIGluIGp3ayAmJiBqd2sudXNlICE9PSAnc2lnbicpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdKV0sgY2Fubm90IGJlIHVzZWQgZm9yIHNpZ25pbmcnKQogICAgICB9CgogICAgICBpZiAoJ2V4dCcgaW4gandrICYmIGp3ay5leHQgIT09IGV4dHJhY3RhYmxlICYmIGV4dHJhY3RhYmxlKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnSldLIGlzIG5vdCBleHRyYWN0YWJsZScpCiAgICAgIH0KICAgICAgYnJlYWsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgIGBGb3JtYXQgJyR7Zm9ybWF0fScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBITUFDIGltcG9ydEtleSgpIG9wZXJhdGlvbmAKICAgICAgKQogIH0KCiAgY29uc3QgbGVuZ3RoID0gZGF0YS5ieXRlTGVuZ3RoICogOAoKICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdLZXkgY2Fubm90IGJlIGVtcHR5JykKICB9CgogIHJldHVybiBuZXcgQ3J5cHRvS2V5KAogICAgJ3NlY3JldCcsCiAgICBleHRyYWN0YWJsZSwKICAgIHsKICAgICAgbmFtZTogJ0hNQUMnLAogICAgICBsZW5ndGgsCiAgICAgIGhhc2g6IHsKICAgICAgICBuYW1lOiBoYXNoLm5hbWUudG9VcHBlckNhc2UoKQogICAgICB9CiAgICB9LAogICAgdXNhZ2VzLAogICAgZGF0YQogICkKfQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jaG1hYy1vcGVyYXRpb25zLWV4cG9ydC1rZXkKZXhwb3J0cy5leHBvcnRLZXkgPSBmdW5jdGlvbiBleHBvcnRLZXkoZm9ybWF0LCBrZXkpIHsKICBjb25zdCBkYXRhID0ga2V5Ll9oYW5kbGUKCiAgc3dpdGNoIChmb3JtYXQpIHsKICAgIGNhc2UgJ3Jhdyc6CiAgICAgIHJldHVybiBkYXRhLmJ1ZmZlci5zbGljZSgwLCBkYXRhLmJ5dGVMZW5ndGgpCiAgICBjYXNlICdqd2snOiB7CiAgICAgIGNvbnN0IGp3ayA9IHsKICAgICAgICBrdHk6ICdvY3QnLAogICAgICAgIGs6IGRhdGEudG9TdHJpbmcoJ2Jhc2U2NHVybCcpLAogICAgICAgIGFsZzogbnVsbCwKICAgICAgICBrZXlfb3BzOiBrZXkudXNhZ2VzLAogICAgICAgIGV4dDoga2V5LmV4dHJhY3RhYmxlCiAgICAgIH0KCiAgICAgIHN3aXRjaCAoa2V5LmFsZ29yaXRobS5oYXNoLm5hbWUpIHsKICAgICAgICBjYXNlICdTSEEtMSc6CiAgICAgICAgICBqd2suYWxnID0gJ0hTMScKICAgICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAnU0hBLTI1Nic6CiAgICAgICAgICBqd2suYWxnID0gJ0hTMjU2JwogICAgICAgICAgYnJlYWsKICAgICAgICBjYXNlICdTSEEtMzg0JzoKICAgICAgICAgIGp3ay5hbGcgPSAnSFMzODQnCiAgICAgICAgICBicmVhawogICAgICAgIGNhc2UgJ1NIQS01MTInOgogICAgICAgICAgandrLmFsZyA9ICdIUzUxMicKICAgICAgICAgIGJyZWFrCiAgICAgIH0KCiAgICAgIHJldHVybiBqd2sKICAgIH0KICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgIGBGb3JtYXQgJyR7Zm9ybWF0fScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBITUFDIGV4cG9ydEtleSgpIG9wZXJhdGlvbmAKICAgICAgKQogIH0KfQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jaG1hYy1vcGVyYXRpb25zLWdldC1rZXktbGVuZ3RoCmV4cG9ydHMuZ2V0S2V5TGVuZ3RoID0gZnVuY3Rpb24gZ2V0S2V5TGVuZ3RoKGFsZ29yaXRobSkgewogIGNvbnN0IHsgbGVuZ3RoLCBoYXNoIH0gPSBhbGdvcml0aG0KCiAgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkKSB7CiAgICBpZiAoaGFzaCA9PT0gJ1NIQS0xJyB8fCBoYXNoID09PSAnU0hBLTI1NicpIHJldHVybiA1MTIKICAgIGlmIChoYXNoID09PSAnU0hBLTUxMicpIHJldHVybiAxMDI0CgogICAgdGhyb3cgZXJyb3JzLk9QRVJBVElPTl9FUlJPUihgSW52YWxpZCBoYXNoICcke2hhc2h9J2ApCiAgfQoKICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICB0aHJvdyBlcnJvcnMuT1BFUkFUSU9OX0VSUk9SKGBJbnZhbGlkIGxlbmd0aCAke2xlbmd0aH1gKQogIH0KCiAgcmV0dXJuIGxlbmd0aAp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJy4uLy4uLy4uJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi4vLi4vZXJyb3JzJykKY29uc3QgQ3J5cHRvS2V5ID0gcmVxdWlyZSgnLi4vY3J5cHRvLWtleScpCgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNwYmtkZjIKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI3Bia2RmMi1vcGVyYXRpb25zLWRlcml2ZS1iaXRzCmV4cG9ydHMuZGVyaXZlQml0cyA9IGZ1bmN0aW9uIGRlcml2ZUJpdHMoYWxnb3JpdGhtLCBrZXksIGxlbmd0aCkgewogIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCB8fCBsZW5ndGggJSA4KSB7CiAgICB0aHJvdyBlcnJvcnMuT1BFUkFUSU9OX0VSUk9SKCdMZW5ndGggbXVzdCBiZSBtdWx0aXBsZSBvZiA4JykKICB9CgogIGlmIChhbGdvcml0aG0uaXRlcmF0aW9ucyA9PT0gMCkgewogICAgdGhyb3cgZXJyb3JzLk9QRVJBVElPTl9FUlJPUignSXRlcmF0aW9ucyBtdXN0IGJlIG5vbi0wJykKICB9CgogIGlmIChsZW5ndGggPT09IDApIHsKICAgIHJldHVybiBuZXcgQXJyYXlCdWZmZXIoMCkKICB9CgogIGxldCBoYXNoID0gYWxnb3JpdGhtLmhhc2gKCiAgaWYgKHR5cGVvZiBoYXNoID09PSAnc3RyaW5nJykgaGFzaCA9IHsgbmFtZTogaGFzaCB9CgogIGNvbnN0IHJlc3VsdCA9IGNyeXB0by5wYmtkZjIoCiAgICBrZXkuX2hhbmRsZSwKICAgIGFsZ29yaXRobS5zYWx0LAogICAgYWxnb3JpdGhtLml0ZXJhdGlvbnMsCiAgICBsZW5ndGggLyA4LAogICAgaGFzaC5uYW1lCiAgKQoKICByZXR1cm4gcmVzdWx0LmJ1ZmZlcgp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNwYmtkZjItb3BlcmF0aW9ucy1pbXBvcnQta2V5CmV4cG9ydHMuaW1wb3J0S2V5ID0gZnVuY3Rpb24gaW1wb3J0S2V5KGZvcm1hdCwga2V5RGF0YSwgYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKSB7CiAgaWYgKGZvcm1hdCAhPT0gJ3JhdycpIHsKICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICBgRm9ybWF0ICcke2Zvcm1hdH0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgUEJLREYyIGltcG9ydEtleSgpIG9wZXJhdGlvbmAKICAgICkKICB9CgogIGZvciAoY29uc3QgdXNhZ2Ugb2YgdXNhZ2VzKSB7CiAgICBpZiAodXNhZ2UgIT09ICdkZXJpdmVLZXknICYmIHVzYWdlICE9PSAnZGVyaXZlQml0cycpIHsKICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKGBJbnZhbGlkIHVzYWdlICR7dXNhZ2V9YCkKICAgIH0KICB9CgogIGlmIChleHRyYWN0YWJsZSkgewogICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKCdFeHRyYWN0YWJsZSBtdXN0IGJlIGZhbHNlJykKICB9CgogIHJldHVybiBuZXcgQ3J5cHRvS2V5KAogICAgJ3NlY3JldCcsCiAgICBleHRyYWN0YWJsZSwKICAgIHsKICAgICAgbmFtZTogJ1BCS0RGMicKICAgIH0sCiAgICB1c2FnZXMsCiAgICBrZXlEYXRhCiAgKQp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJy4uLy4uLy4uJykKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI3NoYQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jc2hhLW9wZXJhdGlvbnMtZGlnZXN0CmV4cG9ydHMuZGlnZXN0ID0gZnVuY3Rpb24gZGlnZXN0KG5hbWUsIGRhdGEpIHsKICBjb25zdCBkaWdlc3QgPSBjcnlwdG8uY3JlYXRlSGFzaChuYW1lKS51cGRhdGUoZGF0YSkuZGlnZXN0KCkKCiAgcmV0dXJuIGRpZ2VzdC5idWZmZXIuc2xpY2UoMCwgZGlnZXN0LmJ5dGVMZW5ndGgpCn0KLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jY3J5cHRva2V5LWludGVyZmFjZQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENyeXB0b0tleSB7CiAgY29uc3RydWN0b3IodHlwZSwgZXh0cmFjdGFibGUsIGFsZ29yaXRobSwgdXNhZ2VzLCBoYW5kbGUgPSBudWxsKSB7CiAgICB0aGlzLl90eXBlID0gdHlwZQogICAgdGhpcy5fZXh0cmFjdGFibGUgPSBleHRyYWN0YWJsZQogICAgdGhpcy5fYWxnb3JpdGhtID0gYWxnb3JpdGhtCiAgICB0aGlzLl91c2FnZXMgPSB1c2FnZXMKICAgIHRoaXMuX2hhbmRsZSA9IGhhbmRsZQogIH0KCiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jZG9tLWNyeXB0b2tleS10eXBlCiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gdGhpcy5fdHlwZQogIH0KCiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jZG9tLWNyeXB0b2tleS1leHRyYWN0YWJsZQogIGdldCBleHRyYWN0YWJsZSgpIHsKICAgIHJldHVybiB0aGlzLl9leHRyYWN0YWJsZQogIH0KCiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jZG9tLWNyeXB0b2tleS1hbGdvcml0aG0KICBnZXQgYWxnb3JpdGhtKCkgewogICAgcmV0dXJuIHRoaXMuX2FsZ29yaXRobQogIH0KCiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jZG9tLWNyeXB0b2tleS11c2FnZXMKICBnZXQgdXNhZ2VzKCkgewogICAgcmV0dXJuIHRoaXMuX3VzYWdlcwogIH0KCiAgW1N5bWJvbC5mb3IoJ2JhcmUuaW5zcGVjdCcpXSgpIHsKICAgIHJldHVybiB7CiAgICAgIF9fcHJvdG9fXzogeyBjb25zdHJ1Y3RvcjogQ3J5cHRvS2V5IH0sCgogICAgICB0eXBlOiB0aGlzLnR5cGUsCiAgICAgIGV4dHJhY3RhYmxlOiB0aGlzLmV4dHJhY3RhYmxlLAogICAgICBhbGdvcml0aG06IHRoaXMuYWxnb3JpdGhtLAogICAgICB1c2FnZXM6IHRoaXMudXNhZ2VzCiAgICB9CiAgfQp9CnsKICAibmFtZSI6ICJiYXJlLWNyeXB0byIsCiAgInZlcnNpb24iOiAiMS4xMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiQ3J5cHRvZ3JhcGhpYyBwcmltaXRpdmVzIGZvciBKYXZhU2NyaXB0IiwKICAiZXhwb3J0cyI6IHsKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4iOiB7CiAgICAgICJ0eXBlcyI6ICIuL2luZGV4LmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2luZGV4LmpzIgogICAgfSwKICAgICIuL3dlYiI6IHsKICAgICAgInR5cGVzIjogIi4vd2ViLmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL3dlYi5qcyIKICAgIH0sCiAgICAiLi9nbG9iYWwiOiB7CiAgICAgICJ0eXBlcyI6ICIuL2dsb2JhbC5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9nbG9iYWwuanMiCiAgICB9LAogICAgIi4vY29uc3RhbnRzIjogIi4vbGliL2NvbnN0YW50cy5qcyIsCiAgICAiLi9lcnJvcnMiOiAiLi9saWIvZXJyb3JzLmpzIgogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJpbmRleC5kLnRzIiwKICAgICJ3ZWIuanMiLAogICAgIndlYi5kLnRzIiwKICAgICJnbG9iYWwuanMiLAogICAgImdsb2JhbC5kLnRzIiwKICAgICJiaW5kaW5nLmMiLAogICAgImJpbmRpbmcuanMiLAogICAgIkNNYWtlTGlzdHMudHh0IiwKICAgICJsaWIiLAogICAgInByZWJ1aWxkcyIKICBdLAogICJhZGRvbiI6IHRydWUsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYmFyZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtY3J5cHRvLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtY3J5cHRvL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1jcnlwdG8jcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtc3RyZWFtIjogIl4yLjYuMyIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1idWZmZXIiOiAiXjMuMC4xIiwKICAgICJicml0dGxlIjogIl4zLjUuMCIsCiAgICAiY21ha2UtYmFyZSI6ICJeMS4xLjYiLAogICAgImNtYWtlLWZldGNoIjogIl4xLjAuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNC4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYnVmZmVyIjogIioiCiAgfSwKICAicGVlckRlcGVuZGVuY2llc01ldGEiOiB7CiAgICAiYmFyZS1idWZmZXIiOiB7CiAgICAgICJvcHRpb25hbCI6IHRydWUKICAgIH0KICB9Cn0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnLicpCmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4vbGliL2Vycm9ycycpCmNvbnN0IENyeXB0b0tleSA9IHJlcXVpcmUoJy4vbGliL3dlYi9jcnlwdG8ta2V5JykKY29uc3QgaG1hYyA9IHJlcXVpcmUoJy4vbGliL3dlYi9hbGdvcml0aG0vaG1hYycpCmNvbnN0IHBia2RmMiA9IHJlcXVpcmUoJy4vbGliL3dlYi9hbGdvcml0aG0vcGJrZGYyJykKY29uc3QgZWQyNTUxOSA9IHJlcXVpcmUoJy4vbGliL3dlYi9hbGdvcml0aG0vZWQyNTUxOScpCmNvbnN0IHNoYSA9IHJlcXVpcmUoJy4vbGliL3dlYi9hbGdvcml0aG0vc2hhJykKCmV4cG9ydHMuQ3J5cHRvS2V5ID0gQ3J5cHRvS2V5CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNDcnlwdG8tbWV0aG9kLWdldFJhbmRvbVZhbHVlcwpleHBvcnRzLmdldFJhbmRvbVZhbHVlcyA9IGZ1bmN0aW9uIGdldFJhbmRvbVZhbHVlcyhhcnJheSkgewogIHJldHVybiBjcnlwdG8ucmFuZG9tRmlsbFN5bmMoYXJyYXkpCn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2Rmbi1DcnlwdG8tbWV0aG9kLXJhbmRvbVVVSUQKZXhwb3J0cy5yYW5kb21VVUlEID0gY3J5cHRvLnJhbmRvbVVVSUQKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI3N1YnRsZWNyeXB0by1pbnRlcmZhY2UKZXhwb3J0cy5TdWJ0bGVDcnlwdG8gPSBjbGFzcyBTdWJ0bGVDcnlwdG8gewogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI1N1YnRsZUNyeXB0by1tZXRob2QtZ2VuZXJhdGVLZXkKICBhc3luYyBnZW5lcmF0ZUtleShhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpIHsKICAgIGlmICh0eXBlb2YgYWxnb3JpdGhtID09PSAnc3RyaW5nJykgYWxnb3JpdGhtID0geyBuYW1lOiBhbGdvcml0aG0gfQoKICAgIHN3aXRjaCAoYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdobWFjJzoKICAgICAgICByZXR1cm4gaG1hYy5nZW5lcmF0ZUtleShhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpCiAgICAgIGNhc2UgJ2VkMjU1MTknOgogICAgICAgIHJldHVybiBlZDI1NTE5LmdlbmVyYXRlS2V5KGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICAgIGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBzdXBwb3J0IHRoZSBnZW5lcmF0ZUtleSgpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICB9CiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNTdWJ0bGVDcnlwdG8tbWV0aG9kLWltcG9ydEtleQogIGFzeW5jIGltcG9ydEtleShmb3JtYXQsIGtleURhdGEsIGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykgewogICAgaWYgKHR5cGVvZiBhbGdvcml0aG0gPT09ICdzdHJpbmcnKSBhbGdvcml0aG0gPSB7IG5hbWU6IGFsZ29yaXRobSB9CgogICAgc3dpdGNoIChmb3JtYXQpIHsKICAgICAgY2FzZSAncmF3JzoKICAgICAgY2FzZSAncGtjczgnOgogICAgICBjYXNlICdzcGtpJzoKICAgICAgICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KGtleURhdGEpKSB7CiAgICAgICAgICBrZXlEYXRhID0gQnVmZmVyLmZyb20oa2V5RGF0YSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAga2V5RGF0YSA9IEJ1ZmZlci5mcm9tKGtleURhdGEuc2xpY2UoKSkKICAgICAgICB9CiAgICAgICAgYnJlYWsKICAgIH0KCiAgICBzd2l0Y2ggKGFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAnaG1hYyc6CiAgICAgICAgcmV0dXJuIGhtYWMuaW1wb3J0S2V5KGZvcm1hdCwga2V5RGF0YSwgYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKQogICAgICBjYXNlICdlZDI1NTE5JzoKICAgICAgICByZXR1cm4gZWQyNTUxOS5pbXBvcnRLZXkoZm9ybWF0LCBrZXlEYXRhLCBhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpCiAgICAgIGNhc2UgJ3Bia2RmMic6CiAgICAgICAgcmV0dXJuIHBia2RmMi5pbXBvcnRLZXkoZm9ybWF0LCBrZXlEYXRhLCBhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgICBgQWxnb3JpdGhtICcke2FsZ29yaXRobS5uYW1lfScgZG9lcyBub3Qgc3VwcG9ydCB0aGUgaW1wb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgIH0KICB9CgogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI1N1YnRsZUNyeXB0by1tZXRob2QtZXhwb3J0S2V5CiAgYXN5bmMgZXhwb3J0S2V5KGZvcm1hdCwga2V5KSB7CiAgICBpZiAoIWtleS5leHRyYWN0YWJsZSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoJ0tleSBpcyBub3QgZXh0cmFjdGFibGUnKQogICAgfQoKICAgIHN3aXRjaCAoa2V5LmFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAnaG1hYyc6CiAgICAgICAgcmV0dXJuIGhtYWMuZXhwb3J0S2V5KGZvcm1hdCwga2V5KQogICAgICBjYXNlICdlZDI1NTE5JzoKICAgICAgICByZXR1cm4gZWQyNTUxOS5leHBvcnRLZXkoZm9ybWF0LCBrZXkpCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgICBgQWxnb3JpdGhtICcke2tleS5hbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IHN1cHBvcnQgdGhlIGV4cG9ydEtleSgpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICB9CiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNTdWJ0bGVDcnlwdG8tbWV0aG9kLXNpZ24KICBhc3luYyBzaWduKGFsZ29yaXRobSwga2V5LCBkYXRhKSB7CiAgICBpZiAodHlwZW9mIGFsZ29yaXRobSA9PT0gJ3N0cmluZycpIGFsZ29yaXRobSA9IHsgbmFtZTogYWxnb3JpdGhtIH0KCiAgICBpZiAoYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSAhPT0ga2V5LmFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBtYXRjaCBrZXknYCkKICAgIH0KCiAgICBpZiAoIWtleS51c2FnZXMuaW5jbHVkZXMoJ3NpZ24nKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoJ0tleSBjYW5ub3QgYmUgdXNlZCBmb3Igc2lnbmluZycpCiAgICB9CgogICAgc3dpdGNoIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIGNhc2UgJ2htYWMnOgogICAgICAgIHJldHVybiBobWFjLnNpZ24oYWxnb3JpdGhtLCBrZXksIGRhdGEpCiAgICAgIGNhc2UgJ2VkMjU1MTknOgogICAgICAgIHJldHVybiBlZDI1NTE5LnNpZ24oYWxnb3JpdGhtLCBrZXksIGRhdGEpCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgICBgQWxnb3JpdGhtICcke2FsZ29yaXRobS5uYW1lfScgZG9lcyBub3Qgc3VwcG9ydCB0aGUgc2lnbigpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICB9CiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNTdWJ0bGVDcnlwdG8tbWV0aG9kLXZlcmlmeQogIGFzeW5jIHZlcmlmeShhbGdvcml0aG0sIGtleSwgc2lnbmF0dXJlLCBkYXRhKSB7CiAgICBpZiAodHlwZW9mIGFsZ29yaXRobSA9PT0gJ3N0cmluZycpIGFsZ29yaXRobSA9IHsgbmFtZTogYWxnb3JpdGhtIH0KCiAgICBpZiAoYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSAhPT0ga2V5LmFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBtYXRjaCBrZXknYCkKICAgIH0KCiAgICBpZiAoIWtleS51c2FnZXMuaW5jbHVkZXMoJ3ZlcmlmeScpKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUygnS2V5IGNhbm5vdCBiZSB1c2VkIGZvciB2ZXJpZmljYXRpb24nKQogICAgfQoKICAgIHN3aXRjaCAoYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdobWFjJzoKICAgICAgICByZXR1cm4gaG1hYy52ZXJpZnkoYWxnb3JpdGhtLCBrZXksIHNpZ25hdHVyZSwgZGF0YSkKICAgICAgY2FzZSAnZWQyNTUxOSc6CiAgICAgICAgcmV0dXJuIGVkMjU1MTkudmVyaWZ5KGFsZ29yaXRobSwga2V5LCBzaWduYXR1cmUsIGRhdGEpCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgICBgQWxnb3JpdGhtICcke2FsZ29yaXRobS5uYW1lfScgZG9lcyBub3Qgc3VwcG9ydCB0aGUgdmVyaWZ5KCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgIH0KICB9CgogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI1N1YnRsZUNyeXB0by1tZXRob2QtZGVyaXZlQml0cwogIGFzeW5jIGRlcml2ZUJpdHMoYWxnb3JpdGhtLCBrZXksIGxlbmd0aCkgewogICAgaWYgKHR5cGVvZiBhbGdvcml0aG0gPT09ICdzdHJpbmcnKSBhbGdvcml0aG0gPSB7IG5hbWU6IGFsZ29yaXRobSB9CgogICAgaWYgKGFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkgIT09IGtleS5hbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUyhgQWxnb3JpdGhtICcke2FsZ29yaXRobS5uYW1lfScgZG9lcyBub3QgbWF0Y2gga2V5J2ApCiAgICB9CgogICAgaWYgKCFrZXkudXNhZ2VzLmluY2x1ZGVzKCdkZXJpdmVCaXRzJykpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKCdLZXkgY2Fubm90IGJlIHVzZWQgdG8gZGVyaXZlIGJpdHMnKQogICAgfQoKICAgIHN3aXRjaCAoYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdwYmtkZjInOgogICAgICAgIHJldHVybiBwYmtkZjIuZGVyaXZlQml0cyhhbGdvcml0aG0sIGtleSwgbGVuZ3RoKQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgICAgYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IHN1cHBvcnQgdGhlIGRlcml2ZUJpdHMoKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgfQogIH0KCiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jU3VidGxlQ3J5cHRvLW1ldGhvZC1kZXJpdmVLZXkKICBhc3luYyBkZXJpdmVLZXkoYWxnb3JpdGhtLCBiYXNlS2V5LCBkZXJpdmVkS2V5VHlwZSwgZXh0cmFjdGFibGUsIHVzYWdlcykgewogICAgaWYgKHR5cGVvZiBhbGdvcml0aG0gPT09ICdzdHJpbmcnKSBhbGdvcml0aG0gPSB7IG5hbWU6IGFsZ29yaXRobSB9CgogICAgaWYgKHR5cGVvZiBkZXJpdmVkS2V5VHlwZSA9PT0gJ3N0cmluZycpIHsKICAgICAgZGVyaXZlZEtleVR5cGUgPSB7IG5hbWU6IGRlcml2ZWRLZXlUeXBlIH0KICAgIH0KCiAgICBpZiAoYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSAhPT0gYmFzZUtleS5hbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUyhgQWxnb3JpdGhtICcke2FsZ29yaXRobS5uYW1lfScgZG9lcyBub3QgbWF0Y2gga2V5J2ApCiAgICB9CgogICAgaWYgKCFiYXNlS2V5LnVzYWdlcy5pbmNsdWRlcygnZGVyaXZlS2V5JykpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKCdLZXkgY2Fubm90IGJlIHVzZWQgdG8gZGVyaXZlIGtleScpCiAgICB9CgogICAgbGV0IGxlbmd0aAoKICAgIHN3aXRjaCAoZGVyaXZlZEtleVR5cGUubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIGNhc2UgJ2htYWMnOgogICAgICAgIGxlbmd0aCA9IGhtYWMuZ2V0S2V5TGVuZ3RoKGRlcml2ZWRLZXlUeXBlKQogICAgICAgIGJyZWFrCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgICBgQWxnb3JpdGhtICcke2Rlcml2ZWRLZXlUeXBlLm5hbWV9JyBkb2VzIG5vdCBzdXBwb3J0IHRoZSBnZXRLZXlMZW5ndGgoKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgfQoKICAgIGxldCBzZWNyZXQKCiAgICBzd2l0Y2ggKGFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAncGJrZGYyJzoKICAgICAgICBzZWNyZXQgPSBwYmtkZjIuZGVyaXZlQml0cyhhbGdvcml0aG0sIGJhc2VLZXksIGxlbmd0aCkKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgICAgYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IHN1cHBvcnQgdGhlIGRlcml2ZUJpdHMoKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgfQoKICAgIHJldHVybiB0aGlzLmltcG9ydEtleSgncmF3Jywgc2VjcmV0LCBkZXJpdmVkS2V5VHlwZSwgZXh0cmFjdGFibGUsIHVzYWdlcykKICB9CgogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI1N1YnRsZUNyeXB0by1tZXRob2QtZGlnZXN0CiAgYXN5bmMgZGlnZXN0KGFsZ29yaXRobSwgZGF0YSkgewogICAgaWYgKHR5cGVvZiBhbGdvcml0aG0gPT09ICdzdHJpbmcnKSBhbGdvcml0aG0gPSB7IG5hbWU6IGFsZ29yaXRobSB9CgogICAgc3dpdGNoIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIGNhc2UgJ3NoYS0xJzoKICAgICAgICByZXR1cm4gc2hhLmRpZ2VzdCgnc2hhMScsIGRhdGEpCiAgICAgIGNhc2UgJ3NoYS0yNTYnOgogICAgICAgIHJldHVybiBzaGEuZGlnZXN0KCdzaGEyNTYnLCBkYXRhKQogICAgICBjYXNlICdzaGEtNTEyJzoKICAgICAgICByZXR1cm4gc2hhLmRpZ2VzdCgnc2hhNTEyJywgZGF0YSkKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICAgIGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBzdXBwb3J0IHRoZSBkaWdlc3QoKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgfQogIH0KfQoKZXhwb3J0cy5zdWJ0bGUgPSBuZXcgZXhwb3J0cy5TdWJ0bGVDcnlwdG8oKQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jY3J5cHRvLWludGVyZmFjZQpleHBvcnRzLkNyeXB0byA9IGNsYXNzIENyeXB0byB7CiAgZ2V0IHN1YnRsZSgpIHsKICAgIHJldHVybiBleHBvcnRzLnN1YnRsZQogIH0KCiAgZ2V0UmFuZG9tVmFsdWVzKGFycmF5KSB7CiAgICByZXR1cm4gZXhwb3J0cy5nZXRSYW5kb21WYWx1ZXMoYXJyYXkpCiAgfQoKICByYW5kb21VVUlEKCkgewogICAgcmV0dXJuIGV4cG9ydHMucmFuZG9tVVVJRCgpCiAgfQp9CmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4vbGliL2Vycm9ycycpCgpjbGFzcyBFdmVudExpc3RlbmVyIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMubGlzdCA9IFtdCiAgICB0aGlzLmNvdW50ID0gMAogIH0KCiAgYXBwZW5kKGN0eCwgbmFtZSwgZm4sIG9uY2UpIHsKICAgIHRoaXMuY291bnQrKwogICAgY3R4LmVtaXQoJ25ld0xpc3RlbmVyJywgbmFtZSwgZm4pIC8vIEVtaXQgQkVGT1JFIGFkZGluZwogICAgdGhpcy5saXN0LnB1c2goW2ZuLCBvbmNlXSkKICB9CgogIHByZXBlbmQoY3R4LCBuYW1lLCBmbiwgb25jZSkgewogICAgdGhpcy5jb3VudCsrCiAgICBjdHguZW1pdCgnbmV3TGlzdGVuZXInLCBuYW1lLCBmbikgLy8gRW1pdCBCRUZPUkUgYWRkaW5nCiAgICB0aGlzLmxpc3QudW5zaGlmdChbZm4sIG9uY2VdKQogIH0KCiAgcmVtb3ZlKGN0eCwgbmFtZSwgZm4pIHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gdGhpcy5saXN0Lmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCBsID0gdGhpcy5saXN0W2ldCgogICAgICBpZiAobFswXSA9PT0gZm4pIHsKICAgICAgICB0aGlzLmxpc3Quc3BsaWNlKGksIDEpCgogICAgICAgIGlmICh0aGlzLmNvdW50ID09PSAxKSBkZWxldGUgY3R4Ll9ldmVudHNbbmFtZV0KCiAgICAgICAgY3R4LmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgbmFtZSwgZm4pIC8vIEVtaXQgQUZURVIgcmVtb3ZpbmcKCiAgICAgICAgdGhpcy5jb3VudC0tCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0KICB9CgogIHJlbW92ZUFsbChjdHgsIG5hbWUpIHsKICAgIGNvbnN0IGxpc3QgPSBbLi4udGhpcy5saXN0XQogICAgdGhpcy5saXN0ID0gW10KCiAgICBpZiAodGhpcy5jb3VudCA9PT0gbGlzdC5sZW5ndGgpIGRlbGV0ZSBjdHguX2V2ZW50c1tuYW1lXQoKICAgIGZvciAobGV0IGkgPSBsaXN0Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGN0eC5lbWl0KCdyZW1vdmVMaXN0ZW5lcicsIG5hbWUsIGxpc3RbaV1bMF0pIC8vIEVtaXQgQUZURVIgcmVtb3ZpbmcKICAgIH0KCiAgICB0aGlzLmNvdW50IC09IGxpc3QubGVuZ3RoCiAgfQoKICBlbWl0KGN0eCwgbmFtZSwgLi4uYXJncykgewogICAgY29uc3QgbGlzdCA9IFsuLi50aGlzLmxpc3RdCgogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBsaXN0Lmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCBsID0gbGlzdFtpXQoKICAgICAgaWYgKGxbMV0gPT09IHRydWUpIHRoaXMucmVtb3ZlKGN0eCwgbmFtZSwgbFswXSkKCiAgICAgIFJlZmxlY3QuYXBwbHkobFswXSwgY3R4LCBhcmdzKQogICAgfQoKICAgIHJldHVybiBsaXN0Lmxlbmd0aCA+IDAKICB9Cn0KCmZ1bmN0aW9uIGFwcGVuZExpc3RlbmVyKGN0eCwgbmFtZSwgZm4sIG9uY2UpIHsKICBpZiAoY3R4Ll9ldmVudHMgPT09IHVuZGVmaW5lZCkgY3R4Ll9ldmVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpCiAgY29uc3QgZSA9IGN0eC5fZXZlbnRzW25hbWVdIHx8IChjdHguX2V2ZW50c1tuYW1lXSA9IG5ldyBFdmVudExpc3RlbmVyKCkpCiAgZS5hcHBlbmQoY3R4LCBuYW1lLCBmbiwgb25jZSkKICByZXR1cm4gY3R4Cn0KCmZ1bmN0aW9uIHByZXBlbmRMaXN0ZW5lcihjdHgsIG5hbWUsIGZuLCBvbmNlKSB7CiAgaWYgKGN0eC5fZXZlbnRzID09PSB1bmRlZmluZWQpIGN0eC5fZXZlbnRzID0gT2JqZWN0LmNyZWF0ZShudWxsKQogIGNvbnN0IGUgPSBjdHguX2V2ZW50c1tuYW1lXSB8fCAoY3R4Ll9ldmVudHNbbmFtZV0gPSBuZXcgRXZlbnRMaXN0ZW5lcigpKQogIGUucHJlcGVuZChjdHgsIG5hbWUsIGZuLCBvbmNlKQogIHJldHVybiBjdHgKfQoKZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIoY3R4LCBuYW1lLCBmbikgewogIGlmIChjdHguX2V2ZW50cyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gY3R4CiAgY29uc3QgZSA9IGN0eC5fZXZlbnRzW25hbWVdCiAgaWYgKGUgIT09IHVuZGVmaW5lZCkgZS5yZW1vdmUoY3R4LCBuYW1lLCBmbikKICByZXR1cm4gY3R4Cn0KCmZ1bmN0aW9uIHRocm93VW5oYW5kbGVkRXJyb3IoLi4uYXJncykgewogIGxldCBlcnIKCiAgaWYgKGFyZ3MubGVuZ3RoID4gMCkgZXJyID0gYXJnc1swXQoKICBpZiAoZXJyIGluc3RhbmNlb2YgRXJyb3IgPT09IGZhbHNlKSBlcnIgPSBlcnJvcnMuVU5IQU5ETEVEX0VSUk9SKGVycikKCiAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZShlcnIsIGV4cG9ydHMucHJvdG90eXBlLmVtaXQpCiAgfQoKICBxdWV1ZU1pY3JvdGFzaygoKSA9PiB7CiAgICB0aHJvdyBlcnIKICB9KQp9Cgptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBjbGFzcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5fZXZlbnRzID0gT2JqZWN0LmNyZWF0ZShudWxsKQogIH0KCiAgYWRkTGlzdGVuZXIobmFtZSwgZm4pIHsKICAgIHJldHVybiBhcHBlbmRMaXN0ZW5lcih0aGlzLCBuYW1lLCBmbiwgZmFsc2UpCiAgfQoKICBhZGRPbmNlTGlzdGVuZXIobmFtZSwgZm4pIHsKICAgIHJldHVybiBhcHBlbmRMaXN0ZW5lcih0aGlzLCBuYW1lLCBmbiwgdHJ1ZSkKICB9CgogIHByZXBlbmRMaXN0ZW5lcihuYW1lLCBmbikgewogICAgcmV0dXJuIHByZXBlbmRMaXN0ZW5lcih0aGlzLCBuYW1lLCBmbiwgZmFsc2UpCiAgfQoKICBwcmVwZW5kT25jZUxpc3RlbmVyKG5hbWUsIGZuKSB7CiAgICByZXR1cm4gcHJlcGVuZExpc3RlbmVyKHRoaXMsIG5hbWUsIGZuLCB0cnVlKQogIH0KCiAgcmVtb3ZlTGlzdGVuZXIobmFtZSwgZm4pIHsKICAgIHJldHVybiByZW1vdmVMaXN0ZW5lcih0aGlzLCBuYW1lLCBmbikKICB9CgogIG9uKG5hbWUsIGZuKSB7CiAgICByZXR1cm4gYXBwZW5kTGlzdGVuZXIodGhpcywgbmFtZSwgZm4sIGZhbHNlKQogIH0KCiAgb25jZShuYW1lLCBmbikgewogICAgcmV0dXJuIGFwcGVuZExpc3RlbmVyKHRoaXMsIG5hbWUsIGZuLCB0cnVlKQogIH0KCiAgb2ZmKG5hbWUsIGZuKSB7CiAgICByZXR1cm4gcmVtb3ZlTGlzdGVuZXIodGhpcywgbmFtZSwgZm4pCiAgfQoKICBlbWl0KG5hbWUsIC4uLmFyZ3MpIHsKICAgIGlmIChuYW1lID09PSAnZXJyb3InICYmIHRoaXMuX2V2ZW50cyAhPT0gdW5kZWZpbmVkICYmIHRoaXMuX2V2ZW50cy5lcnJvciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRocm93VW5oYW5kbGVkRXJyb3IoLi4uYXJncykKICAgIH0KCiAgICBpZiAodGhpcy5fZXZlbnRzID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZQogICAgY29uc3QgZSA9IHRoaXMuX2V2ZW50c1tuYW1lXQogICAgcmV0dXJuIGUgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogZS5lbWl0KHRoaXMsIG5hbWUsIC4uLmFyZ3MpCiAgfQoKICBsaXN0ZW5lcnMobmFtZSkgewogICAgaWYgKHRoaXMuX2V2ZW50cyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gW10KICAgIGNvbnN0IGUgPSB0aGlzLl9ldmVudHNbbmFtZV0KICAgIHJldHVybiBlID09PSB1bmRlZmluZWQgPyBbXSA6IFsuLi5lLmxpc3RdCiAgfQoKICBsaXN0ZW5lckNvdW50KG5hbWUpIHsKICAgIGlmICh0aGlzLl9ldmVudHMgPT09IHVuZGVmaW5lZCkgcmV0dXJuIDAKICAgIGNvbnN0IGUgPSB0aGlzLl9ldmVudHNbbmFtZV0KICAgIHJldHVybiBlID09PSB1bmRlZmluZWQgPyAwIDogZS5saXN0Lmxlbmd0aAogIH0KCiAgZ2V0TWF4TGlzdGVuZXJzKCkgewogICAgcmV0dXJuIEV2ZW50RW1pdHRlci5kZWZhdWx0TWF4TGlzdGVuZXJzCiAgfQoKICBzZXRNYXhMaXN0ZW5lcnMobikge30KCiAgcmVtb3ZlQWxsTGlzdGVuZXJzKG5hbWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7CiAgICAgIGZvciAoY29uc3Qga2V5IG9mIFJlZmxlY3Qub3duS2V5cyh0aGlzLl9ldmVudHMpKSB7CiAgICAgICAgaWYgKGtleSA9PT0gJ3JlbW92ZUxpc3RlbmVyJykgY29udGludWUKICAgICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycyhrZXkpCiAgICAgIH0KICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3JlbW92ZUxpc3RlbmVyJykKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGUgPSB0aGlzLl9ldmVudHNbbmFtZV0KICAgICAgaWYgKGUgIT09IHVuZGVmaW5lZCkgZS5yZW1vdmVBbGwodGhpcywgbmFtZSkKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQp9CgpleHBvcnRzLkV2ZW50RW1pdHRlciA9IGV4cG9ydHMKCmV4cG9ydHMuZXJyb3JzID0gZXJyb3JzCgpleHBvcnRzLmRlZmF1bHRNYXhMaXN0ZW5lcnMgPSAxMAoKZXhwb3J0cy5vbiA9IGZ1bmN0aW9uIG9uKGVtaXR0ZXIsIG5hbWUsIG9wdHMgPSB7fSkgewogIGNvbnN0IHsgc2lnbmFsIH0gPSBvcHRzCgogIGlmIChzaWduYWwgJiYgc2lnbmFsLmFib3J0ZWQpIHsKICAgIHRocm93IGVycm9ycy5PUEVSQVRJT05fQUJPUlRFRChzaWduYWwucmVhc29uKQogIH0KCiAgbGV0IGVycm9yID0gbnVsbAogIGxldCBkb25lID0gZmFsc2UKCiAgY29uc3QgZXZlbnRzID0gW10KICBjb25zdCBwcm9taXNlcyA9IFtdCgogIGlmIChuYW1lICE9PSAnZXJyb3InKSBlbWl0dGVyLm9uKCdlcnJvcicsIG9uZXJyb3IpCgogIGlmIChzaWduYWwpIHNpZ25hbC5hZGRFdmVudExpc3RlbmVyKCdhYm9ydCcsIG9uYWJvcnQpCgogIGVtaXR0ZXIub24obmFtZSwgb25ldmVudCkKCiAgcmV0dXJuIHsKICAgIG5leHQoKSB7CiAgICAgIGlmIChldmVudHMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHZhbHVlOiBldmVudHMuc2hpZnQoKSwgZG9uZTogZmFsc2UgfSkKICAgICAgfQoKICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgY29uc3QgZXJyID0gZXJyb3IKCiAgICAgICAgZXJyb3IgPSBudWxsCgogICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpCiAgICAgIH0KCiAgICAgIGlmIChkb25lKSByZXR1cm4gb25jbG9zZSgpCgogICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gcHJvbWlzZXMucHVzaCh7IHJlc29sdmUsIHJlamVjdCB9KSkKICAgIH0sCgogICAgcmV0dXJuKCkgewogICAgICByZXR1cm4gb25jbG9zZSgpCiAgICB9LAoKICAgIHRocm93KGVycikgewogICAgICByZXR1cm4gb25lcnJvcihlcnIpCiAgICB9LAoKICAgIFtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7CiAgICAgIHJldHVybiB0aGlzCiAgICB9CiAgfQoKICBmdW5jdGlvbiBvbmV2ZW50KC4uLmFyZ3MpIHsKICAgIGlmIChwcm9taXNlcy5sZW5ndGgpIHsKICAgICAgcHJvbWlzZXMuc2hpZnQoKS5yZXNvbHZlKHsgdmFsdWU6IGFyZ3MsIGRvbmU6IGZhbHNlIH0pCiAgICB9IGVsc2UgewogICAgICBldmVudHMucHVzaChhcmdzKQogICAgfQogIH0KCiAgZnVuY3Rpb24gb25lcnJvcihlcnIpIHsKICAgIGVtaXR0ZXIub2ZmKG5hbWUsIG9uZXZlbnQpLm9mZignZXJyb3InLCBvbmVycm9yKQoKICAgIGlmIChwcm9taXNlcy5sZW5ndGgpIHsKICAgICAgcHJvbWlzZXMuc2hpZnQoKS5yZWplY3QoZXJyKQogICAgfSBlbHNlIHsKICAgICAgZXJyb3IgPSBlcnIKICAgIH0KCiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgZG9uZTogdHJ1ZSB9KQogIH0KCiAgZnVuY3Rpb24gb25hYm9ydCgpIHsKICAgIHNpZ25hbC5yZW1vdmVFdmVudExpc3RlbmVyKCdhYm9ydCcsIG9uYWJvcnQpCgogICAgb25lcnJvcihlcnJvcnMuT1BFUkFUSU9OX0FCT1JURUQoc2lnbmFsLnJlYXNvbikpCiAgfQoKICBmdW5jdGlvbiBvbmNsb3NlKCkgewogICAgZW1pdHRlci5vZmYobmFtZSwgb25ldmVudCkKCiAgICBpZiAobmFtZSAhPT0gJ2Vycm9yJykgZW1pdHRlci5vZmYoJ2Vycm9yJywgb25lcnJvcikKCiAgICBpZiAoc2lnbmFsKSBzaWduYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBvbmFib3J0KQoKICAgIGRvbmUgPSB0cnVlCgogICAgaWYgKHByb21pc2VzLmxlbmd0aCkgcHJvbWlzZXMuc2hpZnQoKS5yZXNvbHZlKHsgZG9uZTogdHJ1ZSB9KQoKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBkb25lOiB0cnVlIH0pCiAgfQp9CgpleHBvcnRzLm9uY2UgPSBmdW5jdGlvbiBvbmNlKGVtaXR0ZXIsIG5hbWUsIG9wdHMgPSB7fSkgewogIGNvbnN0IHsgc2lnbmFsIH0gPSBvcHRzCgogIGlmIChzaWduYWwgJiYgc2lnbmFsLmFib3J0ZWQpIHsKICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcnMuT1BFUkFUSU9OX0FCT1JURUQoc2lnbmFsLnJlYXNvbikpCiAgfQoKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgaWYgKG5hbWUgIT09ICdlcnJvcicpIGVtaXR0ZXIub24oJ2Vycm9yJywgb25lcnJvcikKCiAgICBpZiAoc2lnbmFsKSBzaWduYWwuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBvbmFib3J0KQoKICAgIGVtaXR0ZXIub25jZShuYW1lLCBvbmV2ZW50KQoKICAgIGZ1bmN0aW9uIG9uZXZlbnQoLi4uYXJncykgewogICAgICBpZiAobmFtZSAhPT0gJ2Vycm9yJykgZW1pdHRlci5vZmYoJ2Vycm9yJywgb25lcnJvcikKCiAgICAgIGlmIChzaWduYWwpIHNpZ25hbC5yZW1vdmVFdmVudExpc3RlbmVyKCdhYm9ydCcsIG9uYWJvcnQpCgogICAgICByZXNvbHZlKGFyZ3MpCiAgICB9CgogICAgZnVuY3Rpb24gb25lcnJvcihlcnIpIHsKICAgICAgZW1pdHRlci5vZmYobmFtZSwgb25ldmVudCkKCiAgICAgIGlmIChuYW1lICE9PSAnZXJyb3InKSBlbWl0dGVyLm9mZignZXJyb3InLCBvbmVycm9yKQoKICAgICAgcmVqZWN0KGVycikKICAgIH0KCiAgICBmdW5jdGlvbiBvbmFib3J0KCkgewogICAgICBzaWduYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBvbmFib3J0KQoKICAgICAgb25lcnJvcihlcnJvcnMuT1BFUkFUSU9OX0FCT1JURUQoc2lnbmFsLnJlYXNvbikpCiAgICB9CiAgfSkKfQoKZXhwb3J0cy5mb3J3YXJkID0gZnVuY3Rpb24gZm9yd2FyZChmcm9tLCB0bywgbmFtZXMsIG9wdHMgPSB7fSkgewogIGlmICh0eXBlb2YgbmFtZXMgPT09ICdzdHJpbmcnKSBuYW1lcyA9IFtuYW1lc10KCiAgY29uc3QgeyBlbWl0ID0gdG8uZW1pdC5iaW5kKHRvKSB9ID0gb3B0cwoKICBjb25zdCBsaXN0ZW5lcnMgPSBuYW1lcy5tYXAoCiAgICAobmFtZSkgPT4KICAgICAgZnVuY3Rpb24gb25ldmVudCguLi5hcmdzKSB7CiAgICAgICAgZW1pdChuYW1lLCAuLi5hcmdzKQogICAgICB9CiAgKQoKICB0by5vbignbmV3TGlzdGVuZXInLCAobmFtZSkgPT4gewogICAgY29uc3QgaSA9IG5hbWVzLmluZGV4T2YobmFtZSkKCiAgICBpZiAoaSAhPT0gLTEgJiYgdG8ubGlzdGVuZXJDb3VudChuYW1lKSA9PT0gMCkgewogICAgICBmcm9tLm9uKG5hbWUsIGxpc3RlbmVyc1tpXSkKICAgIH0KICB9KS5vbigncmVtb3ZlTGlzdGVuZXInLCAobmFtZSkgPT4gewogICAgY29uc3QgaSA9IG5hbWVzLmluZGV4T2YobmFtZSkKCiAgICBpZiAoaSAhPT0gLTEgJiYgdG8ubGlzdGVuZXJDb3VudChuYW1lKSA9PT0gMCkgewogICAgICBmcm9tLm9mZihuYW1lLCBsaXN0ZW5lcnNbaV0pCiAgICB9CiAgfSkKfQoKZXhwb3J0cy5saXN0ZW5lckNvdW50ID0gZnVuY3Rpb24gbGlzdGVuZXJDb3VudChlbWl0dGVyLCBuYW1lKSB7CiAgcmV0dXJuIGVtaXR0ZXIubGlzdGVuZXJDb3VudChuYW1lKQp9CgpleHBvcnRzLmdldE1heExpc3RlbmVycyA9IGZ1bmN0aW9uIGdldE1heExpc3RlbmVycyhlbWl0dGVyKSB7CiAgaWYgKHR5cGVvZiBlbWl0dGVyLmdldE1heExpc3RlbmVycyA9PT0gJ2Z1bmN0aW9uJykgewogICAgcmV0dXJuIGVtaXR0ZXIuZ2V0TWF4TGlzdGVuZXJzKCkKICB9CgogIHJldHVybiBleHBvcnRzLmRlZmF1bHRNYXhMaXN0ZW5lcnMKfQoKZXhwb3J0cy5zZXRNYXhMaXN0ZW5lcnMgPSBmdW5jdGlvbiBzZXRNYXhMaXN0ZW5lcnMobiwgLi4uZW1pdHRlcnMpIHsKICBpZiAoZW1pdHRlcnMubGVuZ3RoID09PSAwKSBleHBvcnRzLmRlZmF1bHRNYXhMaXN0ZW5lcnMgPSBuCiAgZWxzZSB7CiAgICBmb3IgKGNvbnN0IGVtaXR0ZXIgb2YgZW1pdHRlcnMpIHsKICAgICAgaWYgKHR5cGVvZiBlbWl0dGVyLnNldE1heExpc3RlbmVycyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGVtaXR0ZXIuc2V0TWF4TGlzdGVuZXJzKG4pCiAgICAgIH0KICAgIH0KICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBFdmVudEVtaXR0ZXJFcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3Rvcihtc2csIGNvZGUsIGZuID0gRXZlbnRFbWl0dGVyRXJyb3IsIG9wdHMpIHsKICAgIHN1cGVyKGAke2NvZGV9OiAke21zZ31gLCBvcHRzKQogICAgdGhpcy5jb2RlID0gY29kZQoKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBmbikKICAgIH0KICB9CgogIGdldCBuYW1lKCkgewogICAgcmV0dXJuICdFdmVudEVtaXR0ZXJFcnJvcicKICB9CgogIHN0YXRpYyBPUEVSQVRJT05fQUJPUlRFRChjYXVzZSwgbXNnID0gJ09wZXJhdGlvbiBhYm9ydGVkJykgewogICAgcmV0dXJuIG5ldyBFdmVudEVtaXR0ZXJFcnJvcihtc2csICdPUEVSQVRJT05fQUJPUlRFRCcsIEV2ZW50RW1pdHRlckVycm9yLk9QRVJBVElPTl9BQk9SVEVELCB7CiAgICAgIGNhdXNlCiAgICB9KQogIH0KCiAgc3RhdGljIFVOSEFORExFRF9FUlJPUihjYXVzZSwgbXNnID0gJ1VuaGFuZGxlZCBlcnJvcicpIHsKICAgIHJldHVybiBuZXcgRXZlbnRFbWl0dGVyRXJyb3IobXNnLCAnVU5IQU5ETEVEX0VSUk9SJywgRXZlbnRFbWl0dGVyRXJyb3IuVU5IQU5ETEVEX0VSUk9SLCB7CiAgICAgIGNhdXNlCiAgICB9KQogIH0KfQp7CiAgIm5hbWUiOiAiYmFyZS1ldmVudHMiLAogICJ2ZXJzaW9uIjogIjIuOC4yIiwKICAiZGVzY3JpcHRpb24iOiAiRXZlbnQgZW1pdHRlcnMgZm9yIEphdmFTY3JpcHQiLAogICJleHBvcnRzIjogewogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLiI6IHsKICAgICAgInR5cGVzIjogIi4vaW5kZXguZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vaW5kZXguanMiCiAgICB9LAogICAgIi4vZ2xvYmFsIjogewogICAgICAidHlwZXMiOiAiLi9nbG9iYWwuZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vZ2xvYmFsLmpzIgogICAgfSwKICAgICIuL3dlYiI6IHsKICAgICAgInR5cGVzIjogIi4vd2ViLmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL3dlYi5qcyIKICAgIH0sCiAgICAiLi9lcnJvcnMiOiAiLi9saWIvZXJyb3JzLmpzIgogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJpbmRleC5kLnRzIiwKICAgICJnbG9iYWwuanMiLAogICAgImdsb2JhbC5kLnRzIiwKICAgICJ3ZWIuanMiLAogICAgIndlYi5kLnRzIiwKICAgICJsaWIiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogIm5wbSBydW4gbGludCAmJiBucG0gcnVuIHRlc3Q6YmFyZSAmJiBucG0gcnVuIHRlc3Q6bm9kZSIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC5qcyIsCiAgICAidGVzdDpub2RlIjogIm5vZGUgdGVzdC5qcyIsCiAgICAibGludCI6ICJwcmV0dGllciAuIC0tY2hlY2siCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1ldmVudHMuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1ldmVudHMvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLWV2ZW50cyNyZWFkbWUiLAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1hYm9ydC1jb250cm9sbGVyIjogIl4xLjAuMCIsCiAgICAiYnJpdHRsZSI6ICJeMy4zLjIiLAogICAgInByZXR0aWVyIjogIl4zLjQuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiLAogICAgInVuY2F1Z2h0cyI6ICJeMS4xLjEiCiAgfSwKICAicGVlckRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWFib3J0LWNvbnRyb2xsZXIiOiAiKiIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzTWV0YSI6IHsKICAgICJiYXJlLWFib3J0LWNvbnRyb2xsZXIiOiB7CiAgICAgICJvcHRpb25hbCI6IHRydWUKICAgIH0KICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCkKY29uc3QgRklGTyA9IHJlcXVpcmUoJ2Zhc3QtZmlmbycpCmNvbnN0IEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2JhcmUtZXZlbnRzJykKY29uc3QgcGF0aCA9IHJlcXVpcmUoJ2JhcmUtcGF0aCcpCmNvbnN0IHsgZmlsZVVSTFRvUGF0aCB9ID0gcmVxdWlyZSgnYmFyZS11cmwnKQpjb25zdCB7IFJlYWRhYmxlLCBXcml0YWJsZSB9ID0gcmVxdWlyZSgnYmFyZS1zdHJlYW0nKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi9iaW5kaW5nJykKY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9saWIvY29uc3RhbnRzJykKY29uc3QgRmlsZUVycm9yID0gcmVxdWlyZSgnLi9saWIvZXJyb3JzJykKCmNvbnN0IGlzV2luZG93cyA9IEJhcmUucGxhdGZvcm0gPT09ICd3aW4zMicKCmV4cG9ydHMuY29uc3RhbnRzID0gY29uc3RhbnRzCgpjbGFzcyBGaWxlUmVxdWVzdCB7CiAgc3RhdGljIF9mcmVlID0gW10KCiAgc3RhdGljIGJvcnJvdygpIHsKICAgIGlmICh0aGlzLl9mcmVlLmxlbmd0aCA+IDApIHJldHVybiB0aGlzLl9mcmVlLnBvcCgpCiAgICByZXR1cm4gbmV3IEZpbGVSZXF1ZXN0KCkKICB9CgogIHN0YXRpYyByZXR1cm4ocmVxKSB7CiAgICBpZiAodGhpcy5fZnJlZS5sZW5ndGggPCAzMikgdGhpcy5fZnJlZS5wdXNoKHJlcS5yZXNldCgpKQogICAgZWxzZSByZXEuZGVzdHJveSgpCiAgfQoKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuX3Jlc2V0KCkKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcucmVxdWVzdEluaXQodGhpcywgdGhpcy5fb25yZXN1bHQpCiAgfQoKICBnZXQgaGFuZGxlKCkgewogICAgcmV0dXJuIHRoaXMuX2hhbmRsZQogIH0KCiAgcmV0YWluKHZhbHVlKSB7CiAgICB0aGlzLl9yZXRhaW4gPSB2YWx1ZSAvLyBUaWUgdGhlIGxpZmV0aW1lIG9mIGB2YWx1ZWAgdG8gdGhlIGxpZmV0aW1lIG9mIGB0aGlzYAogIH0KCiAgcmVzZXQoKSB7CiAgICBpZiAodGhpcy5faGFuZGxlID09PSBudWxsKSByZXR1cm4gdGhpcwoKICAgIGJpbmRpbmcucmVxdWVzdFJlc2V0KHRoaXMuX2hhbmRsZSkKCiAgICB0aGlzLl9yZXNldCgpCgogICAgcmV0dXJuIHRoaXMKICB9CgogIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5faGFuZGxlID09PSBudWxsKSByZXR1cm4gdGhpcwoKICAgIGJpbmRpbmcucmVxdWVzdERlc3Ryb3kodGhpcy5faGFuZGxlKQoKICAgIHRoaXMuX3Jlc2V0KCkKICAgIHRoaXMuX2hhbmRsZSA9IG51bGwKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgdGhlbihyZXNvbHZlLCByZWplY3QpIHsKICAgIHJldHVybiB0aGlzLl9wcm9taXNlLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KQogIH0KCiAgcmV0dXJuKCkgewogICAgaWYgKHRoaXMuX2hhbmRsZSA9PT0gbnVsbCkgcmV0dXJuIHRoaXMKCiAgICBGaWxlUmVxdWVzdC5yZXR1cm4odGhpcykKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgW1N5bWJvbC5kaXNwb3NlXSgpIHsKICAgIHRoaXMucmV0dXJuKCkKICB9CgogIF9yZXNldCgpIHsKICAgIGNvbnN0IHsgcHJvbWlzZSwgcmVzb2x2ZSwgcmVqZWN0IH0gPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKQoKICAgIHRoaXMuX3Byb21pc2UgPSBwcm9taXNlCiAgICB0aGlzLl9yZXNvbHZlID0gcmVzb2x2ZQogICAgdGhpcy5fcmVqZWN0ID0gcmVqZWN0CiAgICB0aGlzLl9yZXRhaW4gPSBudWxsCiAgfQoKICBfb25yZXN1bHQoZXJyLCBzdGF0dXMpIHsKICAgIGlmIChlcnIpIHRoaXMuX3JlamVjdChlcnIpCiAgICBlbHNlIHRoaXMuX3Jlc29sdmUoc3RhdHVzKQogIH0KfQoKZnVuY3Rpb24gb2socmVzdWx0LCBjYikgewogIGlmICh0eXBlb2YgcmVzdWx0ID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IHJlc3VsdAogICAgcmVzdWx0ID0gdW5kZWZpbmVkCiAgfQoKICBpZiAoY2IpIGNiKG51bGwsIHJlc3VsdCkKICBlbHNlIHJldHVybiByZXN1bHQKfQoKZnVuY3Rpb24gZmFpbChlcnIsIGNiKSB7CiAgaWYgKGNiKSBjYihlcnIpCiAgZWxzZSB0aHJvdyBlcnIKfQoKZnVuY3Rpb24gZG9uZShlcnIsIHJlc3VsdCwgY2IpIHsKICBpZiAodHlwZW9mIHJlc3VsdCA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSByZXN1bHQKICAgIHJlc3VsdCA9IHVuZGVmaW5lZAogIH0KCiAgaWYgKGVycikgZmFpbChlcnIsIGNiKQogIGVsc2UgcmV0dXJuIG9rKHJlc3VsdCwgY2IpCn0KCmFzeW5jIGZ1bmN0aW9uIG9wZW4oZmlsZXBhdGgsIGZsYWdzID0gJ3InLCBtb2RlID0gMG82NjYsIGNiKSB7CiAgaWYgKHR5cGVvZiBmbGFncyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBmbGFncwogICAgZmxhZ3MgPSAncicKICAgIG1vZGUgPSAwbzY2NgogIH0gZWxzZSBpZiAodHlwZW9mIG1vZGUgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gbW9kZQogICAgbW9kZSA9IDBvNjY2CiAgfQoKICBpZiAodHlwZW9mIGZsYWdzID09PSAnc3RyaW5nJykgZmxhZ3MgPSB0b0ZsYWdzKGZsYWdzKQogIGlmICh0eXBlb2YgbW9kZSA9PT0gJ3N0cmluZycpIG1vZGUgPSB0b01vZGUobW9kZSkKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZmQKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLm9wZW4ocmVxLmhhbmRsZSwgZmlsZXBhdGgsIGZsYWdzLCBtb2RlKQoKICAgIGZkID0gYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnb3BlbicsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGZkLCBjYikKfQoKZnVuY3Rpb24gb3BlblN5bmMoZmlsZXBhdGgsIGZsYWdzID0gJ3InLCBtb2RlID0gMG82NjYpIHsKICBpZiAodHlwZW9mIGZsYWdzID09PSAnc3RyaW5nJykgZmxhZ3MgPSB0b0ZsYWdzKGZsYWdzKQogIGlmICh0eXBlb2YgbW9kZSA9PT0gJ3N0cmluZycpIG1vZGUgPSB0b01vZGUobW9kZSkKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgcmV0dXJuIGJpbmRpbmcub3BlblN5bmMocmVxLmhhbmRsZSwgZmlsZXBhdGgsIGZsYWdzLCBtb2RlKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ29wZW4nLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gY2xvc2UoZmQsIGNiKSB7CiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5jbG9zZShyZXEuaGFuZGxlLCBmZCkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdjbG9zZScsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIGNsb3NlU3luYyhmZCkgewogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLmNsb3NlU3luYyhyZXEuaGFuZGxlLCBmZCkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdjbG9zZScsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGFjY2VzcyhmaWxlcGF0aCwgbW9kZSA9IGNvbnN0YW50cy5GX09LLCBjYikgewogIGlmICh0eXBlb2YgbW9kZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBtb2RlCiAgICBtb2RlID0gY29uc3RhbnRzLkZfT0sKICB9CgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5hY2Nlc3MocmVxLmhhbmRsZSwgZmlsZXBhdGgsIG1vZGUpCgogICAgYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnYWNjZXNzJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIGFjY2Vzc1N5bmMoZmlsZXBhdGgsIG1vZGUgPSBjb25zdGFudHMuRl9PSykgewogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcuYWNjZXNzU3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCwgbW9kZSkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdhY2Nlc3MnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZXhpc3RzKGZpbGVwYXRoLCBjYikgewogIGxldCBvayA9IHRydWUKICB0cnkgewogICAgYXdhaXQgYWNjZXNzKGZpbGVwYXRoKQogIH0gY2F0Y2ggewogICAgb2sgPSBmYWxzZQogIH0KCiAgcmV0dXJuIGRvbmUobnVsbCwgb2ssIGNiKQp9CgpmdW5jdGlvbiBleGlzdHNTeW5jKGZpbGVwYXRoKSB7CiAgdHJ5IHsKICAgIGFjY2Vzc1N5bmMoZmlsZXBhdGgpCiAgfSBjYXRjaCB7CiAgICByZXR1cm4gZmFsc2UKICB9CgogIHJldHVybiB0cnVlCn0KCmFzeW5jIGZ1bmN0aW9uIHJlYWQoZmQsIGJ1ZmZlciwgb2Zmc2V0ID0gMCwgbGVuID0gYnVmZmVyLmJ5dGVMZW5ndGggLSBvZmZzZXQsIHBvcyA9IC0xLCBjYikgewogIGlmICh0eXBlb2Ygb2Zmc2V0ID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9mZnNldAogICAgb2Zmc2V0ID0gMAogICAgbGVuID0gYnVmZmVyLmJ5dGVMZW5ndGgKICAgIHBvcyA9IC0xCiAgfSBlbHNlIGlmICh0eXBlb2YgbGVuID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IGxlbgogICAgbGVuID0gYnVmZmVyLmJ5dGVMZW5ndGggLSBvZmZzZXQKICAgIHBvcyA9IC0xCiAgfSBlbHNlIGlmICh0eXBlb2YgcG9zID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IHBvcwogICAgcG9zID0gLTEKICB9CgogIGlmICh0eXBlb2YgcG9zICE9PSAnbnVtYmVyJykgcG9zID0gLTEKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGJ5dGVzCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5yZWFkKHJlcS5oYW5kbGUsIGZkLCBidWZmZXIsIG9mZnNldCwgbGVuLCBwb3MpCgogICAgYnl0ZXMgPSBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdyZWFkJywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBieXRlcywgY2IpCn0KCmZ1bmN0aW9uIHJlYWRTeW5jKGZkLCBidWZmZXIsIG9mZnNldCA9IDAsIGxlbiA9IGJ1ZmZlci5ieXRlTGVuZ3RoIC0gb2Zmc2V0LCBwb3MgPSAtMSkgewogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICByZXR1cm4gYmluZGluZy5yZWFkU3luYyhyZXEuaGFuZGxlLCBmZCwgYnVmZmVyLCBvZmZzZXQsIGxlbiwgcG9zKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ3JlYWQnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiByZWFkdihmZCwgYnVmZmVycywgcG9zID0gLTEsIGNiKSB7CiAgaWYgKHR5cGVvZiBwb3MgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gcG9zCiAgICBwb3MgPSAtMQogIH0KCiAgaWYgKHR5cGVvZiBwb3MgIT09ICdudW1iZXInKSBwb3MgPSAtMQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgYnl0ZXMKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnJlYWR2KHJlcS5oYW5kbGUsIGZkLCBidWZmZXJzLCBwb3MpCgogICAgYnl0ZXMgPSBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdyZWFkdicsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgYnl0ZXMsIGNiKQp9CgpmdW5jdGlvbiByZWFkdlN5bmMoZmQsIGJ1ZmZlcnMsIHBvcyA9IC0xKSB7CiAgaWYgKHR5cGVvZiBwb3MgIT09ICdudW1iZXInKSBwb3MgPSAtMQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgcmV0dXJuIGJpbmRpbmcucmVhZHZTeW5jKHJlcS5oYW5kbGUsIGZkLCBidWZmZXJzLCBwb3MpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAncmVhZHYnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiB3cml0ZShmZCwgZGF0YSwgb2Zmc2V0ID0gMCwgbGVuLCBwb3MgPSAtMSwgY2IpIHsKICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICBsZXQgZW5jb2RpbmcgPSBsZW4KICAgIGNiID0gcG9zCiAgICBwb3MgPSBvZmZzZXQKCiAgICBpZiAodHlwZW9mIHBvcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IHBvcwogICAgICBwb3MgPSAtMQogICAgICBlbmNvZGluZyA9ICd1dGY4JwogICAgfSBlbHNlIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSBlbmNvZGluZwogICAgICBlbmNvZGluZyA9ICd1dGY4JwogICAgfQoKICAgIGlmICh0eXBlb2YgcG9zID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IHBvcwogICAgICBwb3MgPSAtMQogICAgfQoKICAgIGRhdGEgPSBCdWZmZXIuZnJvbShkYXRhLCBlbmNvZGluZykKICAgIG9mZnNldCA9IDAKICAgIGxlbiA9IGRhdGEuYnl0ZUxlbmd0aAogIH0gZWxzZSBpZiAodHlwZW9mIG9mZnNldCA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvZmZzZXQKICAgIG9mZnNldCA9IDAKICAgIGxlbiA9IGRhdGEuYnl0ZUxlbmd0aAogICAgcG9zID0gLTEKICB9IGVsc2UgaWYgKHR5cGVvZiBsZW4gPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gbGVuCiAgICBsZW4gPSBkYXRhLmJ5dGVMZW5ndGggLSBvZmZzZXQKICAgIHBvcyA9IC0xCiAgfSBlbHNlIGlmICh0eXBlb2YgcG9zID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IHBvcwogICAgcG9zID0gLTEKICB9CgogIGlmICh0eXBlb2YgbGVuICE9PSAnbnVtYmVyJykgbGVuID0gZGF0YS5ieXRlTGVuZ3RoIC0gb2Zmc2V0CiAgaWYgKHR5cGVvZiBwb3MgIT09ICdudW1iZXInKSBwb3MgPSAtMQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgYnl0ZXMKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLndyaXRlKHJlcS5oYW5kbGUsIGZkLCBkYXRhLCBvZmZzZXQsIGxlbiwgcG9zKQoKICAgIGJ5dGVzID0gYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnd3JpdGUnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGJ5dGVzLCBjYikKfQoKZnVuY3Rpb24gd3JpdGVTeW5jKGZkLCBkYXRhLCBvZmZzZXQgPSAwLCBsZW4sIHBvcyA9IC0xKSB7CiAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgbGV0IGVuY29kaW5nID0gbGVuCiAgICBwb3MgPSBvZmZzZXQKCiAgICBpZiAodHlwZW9mIHBvcyA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBwb3MKICAgICAgcG9zID0gLTEKICAgIH0KCiAgICBkYXRhID0gQnVmZmVyLmZyb20oZGF0YSwgZW5jb2RpbmcpCiAgICBvZmZzZXQgPSAwCiAgICBsZW4gPSBkYXRhLmJ5dGVMZW5ndGgKICB9CgogIGlmICh0eXBlb2YgbGVuICE9PSAnbnVtYmVyJykgbGVuID0gZGF0YS5ieXRlTGVuZ3RoIC0gb2Zmc2V0CiAgaWYgKHR5cGVvZiBwb3MgIT09ICdudW1iZXInKSBwb3MgPSAtMQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgcmV0dXJuIGJpbmRpbmcud3JpdGVTeW5jKHJlcS5oYW5kbGUsIGZkLCBkYXRhLCBvZmZzZXQsIGxlbiwgcG9zKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ3dyaXRlJywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gd3JpdGV2KGZkLCBidWZmZXJzLCBwb3MgPSAtMSwgY2IpIHsKICBpZiAodHlwZW9mIHBvcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBwb3MKICAgIHBvcyA9IC0xCiAgfQoKICBpZiAodHlwZW9mIHBvcyAhPT0gJ251bWJlcicpIHBvcyA9IC0xCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBieXRlcwogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcud3JpdGV2KHJlcS5oYW5kbGUsIGZkLCBidWZmZXJzLCBwb3MpCgogICAgYnl0ZXMgPSBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICd3cml0ZXYnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGJ5dGVzLCBjYikKfQoKZnVuY3Rpb24gd3JpdGV2U3luYyhmZCwgYnVmZmVycywgcG9zID0gLTEpIHsKICBpZiAodHlwZW9mIHBvcyAhPT0gJ251bWJlcicpIHBvcyA9IC0xCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICByZXR1cm4gYmluZGluZy53cml0ZXZTeW5jKHJlcS5oYW5kbGUsIGZkLCBidWZmZXJzLCBwb3MpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnd3JpdGV2JywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gc3RhdChmaWxlcGF0aCwgY2IpIHsKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBzdAogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcuc3RhdChyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICBhd2FpdCByZXEKCiAgICBzdCA9IG5ldyBTdGF0cyguLi5iaW5kaW5nLnJlcXVlc3RSZXN1bHRTdGF0KHJlcS5oYW5kbGUpKQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3N0YXQnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBzdCwgY2IpCn0KCmZ1bmN0aW9uIHN0YXRTeW5jKGZpbGVwYXRoKSB7CiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5zdGF0U3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICByZXR1cm4gbmV3IFN0YXRzKC4uLmJpbmRpbmcucmVxdWVzdFJlc3VsdFN0YXQocmVxLmhhbmRsZSkpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnc3RhdCcsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBsc3RhdChmaWxlcGF0aCwgY2IpIHsKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBzdAogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcubHN0YXQocmVxLmhhbmRsZSwgZmlsZXBhdGgpCgogICAgYXdhaXQgcmVxCgogICAgc3QgPSBuZXcgU3RhdHMoLi4uYmluZGluZy5yZXF1ZXN0UmVzdWx0U3RhdChyZXEuaGFuZGxlKSkKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdsc3RhdCcsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIHN0LCBjYikKfQoKZnVuY3Rpb24gbHN0YXRTeW5jKGZpbGVwYXRoKSB7CiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5sc3RhdFN5bmMocmVxLmhhbmRsZSwgZmlsZXBhdGgpCgogICAgcmV0dXJuIG5ldyBTdGF0cyguLi5iaW5kaW5nLnJlcXVlc3RSZXN1bHRTdGF0KHJlcS5oYW5kbGUpKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ2xzdGF0JywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGZzdGF0KGZkLCBjYikgewogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBzdAogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcuZnN0YXQocmVxLmhhbmRsZSwgZmQpCgogICAgYXdhaXQgcmVxCgogICAgc3QgPSBuZXcgU3RhdHMoLi4uYmluZGluZy5yZXF1ZXN0UmVzdWx0U3RhdChyZXEuaGFuZGxlKSkKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdmc3RhdCcsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgc3QsIGNiKQp9CgpmdW5jdGlvbiBmc3RhdFN5bmMoZmQpIHsKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5mc3RhdFN5bmMocmVxLmhhbmRsZSwgZmQpCgogICAgcmV0dXJuIG5ldyBTdGF0cyguLi5iaW5kaW5nLnJlcXVlc3RSZXN1bHRTdGF0KHJlcS5oYW5kbGUpKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ2ZzdGF0JywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZnRydW5jYXRlKGZkLCBsZW4gPSAwLCBjYikgewogIGlmICh0eXBlb2YgbGVuID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IGxlbgogICAgbGVuID0gMAogIH0KCiAgaWYgKHR5cGVvZiBsZW4gIT09ICdudW1iZXInKSBsZW4gPSAwCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcuZnRydW5jYXRlKHJlcS5oYW5kbGUsIGZkLCBsZW4pCgogICAgYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnZnRydW5jYXRlJywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gZnRydW5jYXRlU3luYyhmZCwgbGVuID0gMCkgewogIGlmICh0eXBlb2YgbGVuICE9PSAnbnVtYmVyJykgbGVuID0gMAoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5mdHJ1bmNhdGVTeW5jKHJlcS5oYW5kbGUsIGZkLCBsZW4pCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnZnRydW5jYXRlJywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gY2htb2QoZmlsZXBhdGgsIG1vZGUsIGNiKSB7CiAgaWYgKHR5cGVvZiBtb2RlID09PSAnc3RyaW5nJykgbW9kZSA9IHRvTW9kZShtb2RlKQoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcuY2htb2QocmVxLmhhbmRsZSwgZmlsZXBhdGgsIG1vZGUpCgogICAgYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnY2htb2QnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gY2htb2RTeW5jKGZpbGVwYXRoLCBtb2RlKSB7CiAgaWYgKHR5cGVvZiBtb2RlID09PSAnc3RyaW5nJykgbW9kZSA9IHRvTW9kZShtb2RlKQoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLmNobW9kU3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCwgbW9kZSkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdjaG1vZCcsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBmY2htb2QoZmQsIG1vZGUsIGNiKSB7CiAgaWYgKHR5cGVvZiBtb2RlID09PSAnc3RyaW5nJykgbW9kZSA9IHRvTW9kZShtb2RlKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLmZjaG1vZChyZXEuaGFuZGxlLCBmZCwgbW9kZSkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdmY2htb2QnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiBmY2htb2RTeW5jKGZkLCBtb2RlKSB7CiAgaWYgKHR5cGVvZiBtb2RlID09PSAnc3RyaW5nJykgbW9kZSA9IHRvTW9kZShtb2RlKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5mY2htb2RTeW5jKHJlcS5oYW5kbGUsIGZkLCBtb2RlKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ2ZjaG1vZCcsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHV0aW1lcyhmaWxlcGF0aCwgYXRpbWUsIG10aW1lLCBjYikgewogIGlmICh0eXBlb2YgYXRpbWUgIT09ICdudW1iZXInKSBhdGltZSA9IGF0aW1lLmdldFRpbWUoKSAvIDEwMDAKICBpZiAodHlwZW9mIG10aW1lICE9PSAnbnVtYmVyJykgbXRpbWUgPSBtdGltZS5nZXRUaW1lKCkgLyAxMDAwCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy51dGltZXMocmVxLmhhbmRsZSwgZmlsZXBhdGgsIGF0aW1lLCBtdGltZSkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICd1dGltZXMnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gdXRpbWVzU3luYyhmaWxlcGF0aCwgYXRpbWUsIG10aW1lKSB7CiAgaWYgKHR5cGVvZiBhdGltZSAhPT0gJ251bWJlcicpIGF0aW1lID0gYXRpbWUuZ2V0VGltZSgpIC8gMTAwMAogIGlmICh0eXBlb2YgbXRpbWUgIT09ICdudW1iZXInKSBtdGltZSA9IG10aW1lLmdldFRpbWUoKSAvIDEwMDAKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy51dGltZXNTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoLCBhdGltZSwgbXRpbWUpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAndXRpbWVzJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIG1rZGlyKGZpbGVwYXRoLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0geyBtb2RlOiAwbzc3NyB9CiAgfQoKICBpZiAodHlwZW9mIG9wdHMgPT09ICdudW1iZXInKSBvcHRzID0geyBtb2RlOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGNvbnN0IG1vZGUgPSB0eXBlb2Ygb3B0cy5tb2RlID09PSAnbnVtYmVyJyA/IG9wdHMubW9kZSA6IDBvNzc3CgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgaWYgKG9wdHMucmVjdXJzaXZlKSB7CiAgICBsZXQgZXJyID0gbnVsbAogICAgdHJ5IHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCBta2RpcihmaWxlcGF0aCwgeyBtb2RlIH0pCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmIChlcnIuY29kZSAhPT0gJ0VOT0VOVCcpIHsKICAgICAgICAgIGlmICghKGF3YWl0IHN0YXQoZmlsZXBhdGgpKS5pc0RpcmVjdG9yeSgpKSB0aHJvdyBlcnIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd2hpbGUgKGZpbGVwYXRoLmVuZHNXaXRoKHBhdGguc2VwKSkgZmlsZXBhdGggPSBmaWxlcGF0aC5zbGljZSgwLCAtMSkKICAgICAgICAgIGNvbnN0IGkgPSBmaWxlcGF0aC5sYXN0SW5kZXhPZihwYXRoLnNlcCkKICAgICAgICAgIGlmIChpIDw9IDApIHRocm93IGVycgoKICAgICAgICAgIGF3YWl0IG1rZGlyKGZpbGVwYXRoLnNsaWNlKDAsIGkpLCB7IG1vZGUsIHJlY3Vyc2l2ZTogdHJ1ZSB9KQoKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IG1rZGlyKGZpbGVwYXRoLCB7IG1vZGUgfSkKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICBpZiAoIShhd2FpdCBzdGF0KGZpbGVwYXRoKSkuaXNEaXJlY3RvcnkoKSkgdGhyb3cgZXJyCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGVyciA9IGUKICAgIH0KCiAgICByZXR1cm4gZG9uZShlcnIsIGNiKQogIH0KCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5ta2RpcihyZXEuaGFuZGxlLCBmaWxlcGF0aCwgbW9kZSkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdta2RpcicsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiBta2RpclN5bmMoZmlsZXBhdGgsIG9wdHMpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdudW1iZXInKSBvcHRzID0geyBtb2RlOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGNvbnN0IG1vZGUgPSB0eXBlb2Ygb3B0cy5tb2RlID09PSAnbnVtYmVyJyA/IG9wdHMubW9kZSA6IDBvNzc3CgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgaWYgKG9wdHMucmVjdXJzaXZlKSB7CiAgICB0cnkgewogICAgICBta2RpclN5bmMoZmlsZXBhdGgsIHsgbW9kZSB9KQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmIChlcnIuY29kZSAhPT0gJ0VOT0VOVCcpIHsKICAgICAgICBpZiAoIXN0YXRTeW5jKGZpbGVwYXRoKS5pc0RpcmVjdG9yeSgpKSB0aHJvdyBlcnIKICAgICAgfSBlbHNlIHsKICAgICAgICB3aGlsZSAoZmlsZXBhdGguZW5kc1dpdGgocGF0aC5zZXApKSBmaWxlcGF0aCA9IGZpbGVwYXRoLnNsaWNlKDAsIC0xKQogICAgICAgIGNvbnN0IGkgPSBmaWxlcGF0aC5sYXN0SW5kZXhPZihwYXRoLnNlcCkKICAgICAgICBpZiAoaSA8PSAwKSB0aHJvdyBlcnIKCiAgICAgICAgbWtkaXJTeW5jKGZpbGVwYXRoLnNsaWNlKDAsIGkpLCB7IG1vZGUsIHJlY3Vyc2l2ZTogdHJ1ZSB9KQoKICAgICAgICB0cnkgewogICAgICAgICAgbWtkaXJTeW5jKGZpbGVwYXRoLCB7IG1vZGUgfSkKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIGlmICghc3RhdFN5bmMoZmlsZXBhdGgpLmlzRGlyZWN0b3J5KCkpIHRocm93IGVycgogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybgogIH0KCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcubWtkaXJTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoLCBtb2RlKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ21rZGlyJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJtZGlyKGZpbGVwYXRoLCBjYikgewogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5ybWRpcihyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdybWRpcicsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiBybWRpclN5bmMoZmlsZXBhdGgpIHsKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLnJtZGlyU3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdybWRpcicsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBybShmaWxlcGF0aCwgb3B0cywgY2IpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb3B0cwogICAgb3B0cyA9IHt9CiAgfQoKICBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGNvbnN0IHN0ID0gYXdhaXQgbHN0YXQoZmlsZXBhdGgpCgogICAgaWYgKHN0LmlzRGlyZWN0b3J5KCkpIHsKICAgICAgaWYgKG9wdHMucmVjdXJzaXZlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF3YWl0IHJtZGlyKGZpbGVwYXRoKQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgaWYgKGVyci5jb2RlICE9PSAnRU5PVEVNUFRZJykgdGhyb3cgZXJyCgogICAgICAgICAgY29uc3QgZmlsZXMgPSBhd2FpdCByZWFkZGlyKGZpbGVwYXRoKQoKICAgICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykgewogICAgICAgICAgICBhd2FpdCBybShmaWxlcGF0aCArIHBhdGguc2VwICsgZmlsZSwgb3B0cykKICAgICAgICAgIH0KCiAgICAgICAgICBhd2FpdCBybWRpcihmaWxlcGF0aCkKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEZpbGVFcnJvcignaXMgYSBkaXJlY3RvcnknLCB7CiAgICAgICAgICBvcGVyYXRpb246ICdybScsCiAgICAgICAgICBjb2RlOiAnRUlTRElSJywKICAgICAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICAgICAgfSkKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgYXdhaXQgdW5saW5rKGZpbGVwYXRoKQogICAgfQogIH0gY2F0Y2ggKGUpIHsKICAgIGlmIChlLmNvZGUgIT09ICdFTk9FTlQnIHx8ICFvcHRzLmZvcmNlKSBlcnIgPSBlCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiBybVN5bmMoZmlsZXBhdGgsIG9wdHMpIHsKICBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHRyeSB7CiAgICBjb25zdCBzdCA9IGxzdGF0U3luYyhmaWxlcGF0aCkKCiAgICBpZiAoc3QuaXNEaXJlY3RvcnkoKSkgewogICAgICBpZiAob3B0cy5yZWN1cnNpdmUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgcm1kaXJTeW5jKGZpbGVwYXRoKQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgaWYgKGVyci5jb2RlICE9PSAnRU5PVEVNUFRZJykgdGhyb3cgZXJyCgogICAgICAgICAgY29uc3QgZmlsZXMgPSByZWFkZGlyU3luYyhmaWxlcGF0aCkKCiAgICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHsKICAgICAgICAgICAgcm1TeW5jKGZpbGVwYXRoICsgcGF0aC5zZXAgKyBmaWxlLCBvcHRzKQogICAgICAgICAgfQoKICAgICAgICAgIHJtZGlyU3luYyhmaWxlcGF0aCkKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEZpbGVFcnJvcignaXMgYSBkaXJlY3RvcnknLCB7CiAgICAgICAgICBvcGVyYXRpb246ICdybScsCiAgICAgICAgICBjb2RlOiAnRUlTRElSJywKICAgICAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICAgICAgfSkKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdW5saW5rU3luYyhmaWxlcGF0aCkKICAgIH0KICB9IGNhdGNoIChlcnIpIHsKICAgIGlmIChlcnIuY29kZSAhPT0gJ0VOT0VOVCcgfHwgIW9wdHMuZm9yY2UpIHRocm93IGVycgogIH0KfQoKYXN5bmMgZnVuY3Rpb24gdW5saW5rKGZpbGVwYXRoLCBjYikgewogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy51bmxpbmsocmVxLmhhbmRsZSwgZmlsZXBhdGgpCgogICAgYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAndW5saW5rJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIHVubGlua1N5bmMoZmlsZXBhdGgpIHsKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLnVubGlua1N5bmMocmVxLmhhbmRsZSwgZmlsZXBhdGgpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAndW5saW5rJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJlbmFtZShzcmMsIGRzdCwgY2IpIHsKICBzcmMgPSB0b05hbWVzcGFjZWRQYXRoKHNyYykKICBkc3QgPSB0b05hbWVzcGFjZWRQYXRoKGRzdCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5yZW5hbWUocmVxLmhhbmRsZSwgc3JjLCBkc3QpCgogICAgYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAncmVuYW1lJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBzcmMsCiAgICAgIGRlc3RpbmF0aW9uOiBkc3QKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiByZW5hbWVTeW5jKHNyYywgZHN0KSB7CiAgc3JjID0gdG9OYW1lc3BhY2VkUGF0aChzcmMpCiAgZHN0ID0gdG9OYW1lc3BhY2VkUGF0aChkc3QpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLnJlbmFtZVN5bmMocmVxLmhhbmRsZSwgc3JjLCBkc3QpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAncmVuYW1lJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBzcmMsCiAgICAgIGRlc3RpbmF0aW9uOiBkc3QKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBjb3B5RmlsZShzcmMsIGRzdCwgbW9kZSA9IDAsIGNiKSB7CiAgaWYgKHR5cGVvZiBtb2RlID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG1vZGUKICAgIG1vZGUgPSAwCiAgfQoKICBzcmMgPSB0b05hbWVzcGFjZWRQYXRoKHNyYykKICBkc3QgPSB0b05hbWVzcGFjZWRQYXRoKGRzdCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5jb3B5ZmlsZShyZXEuaGFuZGxlLCBzcmMsIGRzdCwgbW9kZSkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdjb3B5ZmlsZScsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogc3JjLAogICAgICBkZXN0aW5hdGlvbjogZHN0CiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gY29weUZpbGVTeW5jKHNyYywgZHN0LCBtb2RlID0gMCkgewogIHNyYyA9IHRvTmFtZXNwYWNlZFBhdGgoc3JjKQogIGRzdCA9IHRvTmFtZXNwYWNlZFBhdGgoZHN0KQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5jb3B5ZmlsZVN5bmMocmVxLmhhbmRsZSwgc3JjLCBkc3QsIG1vZGUpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnY29weWZpbGUnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IHNyYywKICAgICAgZGVzdGluYXRpb246IGRzdAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGNwKHNyYywgZHN0LCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICghb3B0cykgb3B0cyA9IHt9CgogIHNyYyA9IHRvTmFtZXNwYWNlZFBhdGgoc3JjKQogIGRzdCA9IHRvTmFtZXNwYWNlZFBhdGgoZHN0KQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBjb25zdCBzdCA9IGF3YWl0IGxzdGF0KHNyYykKCiAgICBpZiAoc3QuaXNEaXJlY3RvcnkoKSkgewogICAgICBpZiAob3B0cy5yZWN1cnNpdmUgIT09IHRydWUpIHsKICAgICAgICB0aHJvdyBuZXcgRmlsZUVycm9yKCdpcyBhIGRpcmVjdG9yeScsIHsKICAgICAgICAgIG9wZXJhdGlvbjogJ2NwJywKICAgICAgICAgIGNvZGU6ICdFSVNESVInLAogICAgICAgICAgcGF0aDogc3JjCiAgICAgICAgfSkKICAgICAgfQoKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCBsc3RhdChkc3QpCiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAoZS5jb2RlID09PSAnRU5PRU5UJykgewogICAgICAgICAgYXdhaXQgbWtkaXIoZHN0LCB7IG1vZGU6IHN0Lm1vZGUsIHJlY3Vyc2l2ZTogdHJ1ZSB9KQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBlCiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCBkaXIgPSBhd2FpdCBvcGVuZGlyKHNyYykKICAgICAgZm9yIGF3YWl0IChjb25zdCB7IG5hbWUgfSBvZiBkaXIpIHsKICAgICAgICBhd2FpdCBjcChwYXRoLmpvaW4oc3JjLCBuYW1lKSwgcGF0aC5qb2luKGRzdCwgbmFtZSksIG9wdHMpCiAgICAgIH0KICAgIH0gZWxzZSBpZiAoc3QuaXNGaWxlKCkpIHsKICAgICAgYXdhaXQgY29weUZpbGUoc3JjLCBkc3QpCiAgICAgIGF3YWl0IGNobW9kKGRzdCwgc3QubW9kZSkKICAgIH0KICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBlCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9Cgphc3luYyBmdW5jdGlvbiByZWFscGF0aChmaWxlcGF0aCwgb3B0cywgY2IpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb3B0cwogICAgb3B0cyA9IHt9CiAgfQoKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBjb25zdCB7IGVuY29kaW5nID0gJ3V0ZjgnIH0gPSBvcHRzCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IHJlcwogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcucmVhbHBhdGgocmVxLmhhbmRsZSwgZmlsZXBhdGgpCgogICAgYXdhaXQgcmVxCgogICAgcmVzID0gQnVmZmVyLmZyb20oYmluZGluZy5yZXF1ZXN0UmVzdWx0U3RyaW5nKHJlcS5oYW5kbGUpKQoKICAgIGlmIChlbmNvZGluZyAhPT0gJ2J1ZmZlcicpIHJlcyA9IHJlcy50b1N0cmluZyhlbmNvZGluZykKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdyZWFscGF0aCcsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIHJlcywgY2IpCn0KCmZ1bmN0aW9uIHJlYWxwYXRoU3luYyhmaWxlcGF0aCwgb3B0cykgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGNvbnN0IHsgZW5jb2RpbmcgPSAndXRmOCcgfSA9IG9wdHMKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5yZWFscGF0aFN5bmMocmVxLmhhbmRsZSwgZmlsZXBhdGgpCgogICAgbGV0IHJlcyA9IEJ1ZmZlci5mcm9tKGJpbmRpbmcucmVxdWVzdFJlc3VsdFN0cmluZyhyZXEuaGFuZGxlKSkKCiAgICBpZiAoZW5jb2RpbmcgIT09ICdidWZmZXInKSByZXMgPSByZXMudG9TdHJpbmcoZW5jb2RpbmcpCgogICAgcmV0dXJuIHJlcwogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3JlYWxwYXRoJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJlYWRsaW5rKGZpbGVwYXRoLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGNvbnN0IHsgZW5jb2RpbmcgPSAndXRmOCcgfSA9IG9wdHMKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgcmVzCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5yZWFkbGluayhyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICBhd2FpdCByZXEKCiAgICByZXMgPSBCdWZmZXIuZnJvbShiaW5kaW5nLnJlcXVlc3RSZXN1bHRTdHJpbmcocmVxLmhhbmRsZSkpCgogICAgaWYgKGVuY29kaW5nICE9PSAnYnVmZmVyJykgcmVzID0gcmVzLnRvU3RyaW5nKGVuY29kaW5nKQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3JlYWRsaW5rJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgcmVzLCBjYikKfQoKZnVuY3Rpb24gcmVhZGxpbmtTeW5jKGZpbGVwYXRoLCBvcHRzKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgeyBlbmNvZGluZyA9ICd1dGY4JyB9ID0gb3B0cwoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLnJlYWRsaW5rU3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICBsZXQgcmVzID0gQnVmZmVyLmZyb20oYmluZGluZy5yZXF1ZXN0UmVzdWx0U3RyaW5nKHJlcS5oYW5kbGUpKQoKICAgIGlmIChlbmNvZGluZyAhPT0gJ2J1ZmZlcicpIHJlcyA9IHJlcy50b1N0cmluZyhlbmNvZGluZykKCiAgICByZXR1cm4gcmVzCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAncmVhZGxpbmsnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKZnVuY3Rpb24gbm9ybWFsaXplU3ltbGlua1RhcmdldCh0YXJnZXQsIHR5cGUsIGZpbGVwYXRoKSB7CiAgaWYgKGlzV2luZG93cykgewogICAgaWYgKHR5cGUgPT09ICdqdW5jdGlvbicpIHRhcmdldCA9IHBhdGgucmVzb2x2ZShmaWxlcGF0aCwgJy4uJywgdGFyZ2V0KQoKICAgIGlmIChwYXRoLmlzQWJzb2x1dGUodGFyZ2V0KSkgcmV0dXJuIHBhdGgudG9OYW1lc3BhY2VkUGF0aCh0YXJnZXQpCgogICAgcmV0dXJuIHRhcmdldC5yZXBsYWNlKC9cLy9nLCBwYXRoLnNlcCkKICB9CgogIHJldHVybiB0YXJnZXQKfQoKYXN5bmMgZnVuY3Rpb24gc3ltbGluayh0YXJnZXQsIGZpbGVwYXRoLCB0eXBlLCBjYikgewogIGlmICh0eXBlb2YgdHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSB0eXBlCiAgICB0eXBlID0gbnVsbAogIH0KCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICBpZiAodHlwZW9mIHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSAnZmlsZSc6CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdHlwZSA9IDAKICAgICAgICBicmVhawogICAgICBjYXNlICdkaXInOgogICAgICAgIHR5cGUgPSBjb25zdGFudHMuVVZfRlNfU1lNTElOS19ESVIKICAgICAgICBicmVhawogICAgICBjYXNlICdqdW5jdGlvbic6CiAgICAgICAgdHlwZSA9IGNvbnN0YW50cy5VVl9GU19TWU1MSU5LX0pVTkNUSU9OCiAgICAgICAgYnJlYWsKICAgIH0KICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlICE9PSAnbnVtYmVyJykgewogICAgaWYgKGlzV2luZG93cykgewogICAgICB0YXJnZXQgPSBwYXRoLnJlc29sdmUoZmlsZXBhdGgsICcuLicsIHRhcmdldCkKCiAgICAgIHRyeSB7CiAgICAgICAgdHlwZSA9IChhd2FpdCBzdGF0KHRhcmdldCkpLmlzRGlyZWN0b3J5KCkKICAgICAgICAgID8gY29uc3RhbnRzLlVWX0ZTX1NZTUxJTktfRElSCiAgICAgICAgICA6IGNvbnN0YW50cy5VVl9GU19TWU1MSU5LX0pVTkNUSU9OCiAgICAgIH0gY2F0Y2ggewogICAgICAgIHR5cGUgPSAwCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHR5cGUgPSAwCiAgICB9CiAgfQoKICB0YXJnZXQgPSBub3JtYWxpemVTeW1saW5rVGFyZ2V0KHRhcmdldCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5zeW1saW5rKHJlcS5oYW5kbGUsIHRhcmdldCwgZmlsZXBhdGgsIHR5cGUpCgogICAgYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnc3ltbGluaycsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogdGFyZ2V0LAogICAgICBkZXN0aW5hdGlvbjogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiBzeW1saW5rU3luYyh0YXJnZXQsIGZpbGVwYXRoLCB0eXBlKSB7CiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICBpZiAodHlwZW9mIHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSAnZmlsZSc6CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdHlwZSA9IDAKICAgICAgICBicmVhawogICAgICBjYXNlICdkaXInOgogICAgICAgIHR5cGUgPSBjb25zdGFudHMuVVZfRlNfU1lNTElOS19ESVIKICAgICAgICBicmVhawogICAgICBjYXNlICdqdW5jdGlvbic6CiAgICAgICAgdHlwZSA9IGNvbnN0YW50cy5VVl9GU19TWU1MSU5LX0pVTkNUSU9OCiAgICAgICAgYnJlYWsKICAgIH0KICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlICE9PSAnbnVtYmVyJykgewogICAgaWYgKGlzV2luZG93cykgewogICAgICB0YXJnZXQgPSBwYXRoLnJlc29sdmUoZmlsZXBhdGgsICcuLicsIHRhcmdldCkKCiAgICAgIHRyeSB7CiAgICAgICAgdHlwZSA9IHN0YXRTeW5jKHRhcmdldCkuaXNEaXJlY3RvcnkoKQogICAgICAgICAgPyBjb25zdGFudHMuVVZfRlNfU1lNTElOS19ESVIKICAgICAgICAgIDogY29uc3RhbnRzLlVWX0ZTX1NZTUxJTktfSlVOQ1RJT04KICAgICAgfSBjYXRjaCB7CiAgICAgICAgdHlwZSA9IDAKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdHlwZSA9IDAKICAgIH0KICB9CgogIHRhcmdldCA9IG5vcm1hbGl6ZVN5bWxpbmtUYXJnZXQodGFyZ2V0KQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5zeW1saW5rU3luYyhyZXEuaGFuZGxlLCB0YXJnZXQsIGZpbGVwYXRoLCB0eXBlKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3N5bWxpbmsnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IHRhcmdldCwKICAgICAgZGVzdGluYXRpb246IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gb3BlbmRpcihmaWxlcGF0aCwgb3B0cywgY2IpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb3B0cwogICAgb3B0cyA9IHt9CiAgfQoKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBkaXIKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLm9wZW5kaXIocmVxLmhhbmRsZSwgZmlsZXBhdGgpCgogICAgYXdhaXQgcmVxCgogICAgZGlyID0gbmV3IERpcihmaWxlcGF0aCwgYmluZGluZy5yZXF1ZXN0UmVzdWx0RGlyKHJlcS5oYW5kbGUpLCBvcHRzKQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ29wZW5kaXInLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBkaXIsIGNiKQp9CgpmdW5jdGlvbiBvcGVuZGlyU3luYyhmaWxlcGF0aCwgb3B0cykgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcub3BlbmRpclN5bmMocmVxLmhhbmRsZSwgZmlsZXBhdGgpCgogICAgcmV0dXJuIG5ldyBEaXIoZmlsZXBhdGgsIGJpbmRpbmcucmVxdWVzdFJlc3VsdERpcihyZXEuaGFuZGxlKSwgb3B0cykKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdvcGVuZGlyJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJlYWRkaXIoZmlsZXBhdGgsIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7fQogIH0KCiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgeyB3aXRoRmlsZVR5cGVzID0gZmFsc2UgfSA9IG9wdHMKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICBsZXQgcmVzdWx0ID0gW10KICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBjb25zdCBkaXIgPSBhd2FpdCBvcGVuZGlyKGZpbGVwYXRoKQoKICAgIGZvciBhd2FpdCAoY29uc3QgZW50cnkgb2YgZGlyKSB7CiAgICAgIHJlc3VsdC5wdXNoKHdpdGhGaWxlVHlwZXMgPyBlbnRyeSA6IGVudHJ5Lm5hbWUpCiAgICB9CiAgfSBjYXRjaCAoZSkgewogICAgcmVzdWx0ID0gW10KICAgIGVyciA9IGUKICB9CgogIHJldHVybiBkb25lKGVyciwgcmVzdWx0LCBjYikKfQoKZnVuY3Rpb24gcmVhZGRpclN5bmMoZmlsZXBhdGgsIG9wdHMpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBjb25zdCB7IHdpdGhGaWxlVHlwZXMgPSBmYWxzZSB9ID0gb3B0cwoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIGNvbnN0IGRpciA9IG9wZW5kaXJTeW5jKGZpbGVwYXRoLCBvcHRzKQogIGNvbnN0IHJlc3VsdCA9IFtdCgogIGZvciAoY29uc3QgZW50cnkgb2YgZGlyKSB7CiAgICByZXN1bHQucHVzaCh3aXRoRmlsZVR5cGVzID8gZW50cnkgOiBlbnRyeS5uYW1lKQogIH0KCiAgcmV0dXJuIHJlc3VsdAp9Cgphc3luYyBmdW5jdGlvbiByZWFkRmlsZShmaWxlcGF0aCwgb3B0cywgY2IpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb3B0cwogICAgb3B0cyA9IHt9CiAgfQoKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBjb25zdCB7IGVuY29kaW5nID0gJ2J1ZmZlcicgfSA9IG9wdHMKCiAgbGV0IGZkID0gLTEKICBsZXQgYnVmZmVyID0gbnVsbAogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGZkID0gYXdhaXQgb3BlbihmaWxlcGF0aCwgb3B0cy5mbGFnIHx8ICdyJykKCiAgICBjb25zdCBzdCA9IGF3YWl0IGZzdGF0KGZkKQoKICAgIGxldCBsZW4gPSAwCgogICAgaWYgKHN0LnNpemUgPT09IDApIHsKICAgICAgY29uc3QgYnVmZmVycyA9IFtdCgogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSg4MTkyKQogICAgICAgIGNvbnN0IHIgPSBhd2FpdCByZWFkKGZkLCBidWZmZXIpCiAgICAgICAgbGVuICs9IHIKICAgICAgICBpZiAociA9PT0gMCkgYnJlYWsKICAgICAgICBidWZmZXJzLnB1c2goYnVmZmVyLnN1YmFycmF5KDAsIHIpKQogICAgICB9CgogICAgICBidWZmZXIgPSBCdWZmZXIuY29uY2F0KGJ1ZmZlcnMpCiAgICB9IGVsc2UgewogICAgICBidWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUoc3Quc2l6ZSkKCiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgY29uc3QgciA9IGF3YWl0IHJlYWQoZmQsIGxlbiA/IGJ1ZmZlci5zdWJhcnJheShsZW4pIDogYnVmZmVyKQogICAgICAgIGxlbiArPSByCiAgICAgICAgaWYgKHIgPT09IDAgfHwgbGVuID09PSBidWZmZXIuYnl0ZUxlbmd0aCkgYnJlYWsKICAgICAgfQoKICAgICAgaWYgKGxlbiAhPT0gYnVmZmVyLmJ5dGVMZW5ndGgpIGJ1ZmZlciA9IGJ1ZmZlci5zdWJhcnJheSgwLCBsZW4pCiAgICB9CgogICAgaWYgKGVuY29kaW5nICE9PSAnYnVmZmVyJykgYnVmZmVyID0gYnVmZmVyLnRvU3RyaW5nKGVuY29kaW5nKQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IGUKICB9IGZpbmFsbHkgewogICAgaWYgKGZkICE9PSAtMSkgYXdhaXQgY2xvc2UoZmQpCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGJ1ZmZlciwgY2IpCn0KCmZ1bmN0aW9uIHJlYWRGaWxlU3luYyhmaWxlcGF0aCwgb3B0cykgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGNvbnN0IHsgZW5jb2RpbmcgPSAnYnVmZmVyJyB9ID0gb3B0cwoKICBsZXQgZmQgPSAtMQogIHRyeSB7CiAgICBmZCA9IG9wZW5TeW5jKGZpbGVwYXRoLCBvcHRzLmZsYWcgfHwgJ3InKQoKICAgIGNvbnN0IHN0ID0gZnN0YXRTeW5jKGZkKQoKICAgIGxldCBidWZmZXIKICAgIGxldCBsZW4gPSAwCgogICAgaWYgKHN0LnNpemUgPT09IDApIHsKICAgICAgY29uc3QgYnVmZmVycyA9IFtdCgogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSg4MTkyKQogICAgICAgIGNvbnN0IHIgPSByZWFkU3luYyhmZCwgYnVmZmVyKQogICAgICAgIGxlbiArPSByCiAgICAgICAgaWYgKHIgPT09IDApIGJyZWFrCiAgICAgICAgYnVmZmVycy5wdXNoKGJ1ZmZlci5zdWJhcnJheSgwLCByKSkKICAgICAgfQoKICAgICAgYnVmZmVyID0gQnVmZmVyLmNvbmNhdChidWZmZXJzKQogICAgfSBlbHNlIHsKICAgICAgYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKHN0LnNpemUpCgogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGNvbnN0IHIgPSByZWFkU3luYyhmZCwgbGVuID8gYnVmZmVyLnN1YmFycmF5KGxlbikgOiBidWZmZXIpCiAgICAgICAgbGVuICs9IHIKICAgICAgICBpZiAociA9PT0gMCB8fCBsZW4gPT09IGJ1ZmZlci5ieXRlTGVuZ3RoKSBicmVhawogICAgICB9CgogICAgICBpZiAobGVuICE9PSBidWZmZXIuYnl0ZUxlbmd0aCkgYnVmZmVyID0gYnVmZmVyLnN1YmFycmF5KDAsIGxlbikKICAgIH0KCiAgICBpZiAoZW5jb2RpbmcgIT09ICdidWZmZXInKSBidWZmZXIgPSBidWZmZXIudG9TdHJpbmcoZW5jb2RpbmcpCgogICAgcmV0dXJuIGJ1ZmZlcgogIH0gZmluYWxseSB7CiAgICBpZiAoZmQgIT09IC0xKSBjbG9zZVN5bmMoZmQpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiB3cml0ZUZpbGUoZmlsZXBhdGgsIGRhdGEsIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7fQogIH0KCiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEsIG9wdHMuZW5jb2RpbmcpCgogIGxldCBmZCA9IC0xCiAgbGV0IGxlbiA9IDAKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBmZCA9IGF3YWl0IG9wZW4oZmlsZXBhdGgsIG9wdHMuZmxhZyB8fCAndycsIG9wdHMubW9kZSB8fCAwbzY2NikKCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBsZW4gKz0gYXdhaXQgd3JpdGUoZmQsIGxlbiA/IGRhdGEuc3ViYXJyYXkobGVuKSA6IGRhdGEpCiAgICAgIGlmIChsZW4gPT09IGRhdGEuYnl0ZUxlbmd0aCkgYnJlYWsKICAgIH0KICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBlCiAgfSBmaW5hbGx5IHsKICAgIGlmIChmZCAhPT0gLTEpIGF3YWl0IGNsb3NlKGZkKQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBsZW4sIGNiKQp9CgpmdW5jdGlvbiB3cml0ZUZpbGVTeW5jKGZpbGVwYXRoLCBkYXRhLCBvcHRzKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEsIG9wdHMuZW5jb2RpbmcpCgogIGxldCBmZCA9IC0xCiAgdHJ5IHsKICAgIGZkID0gb3BlblN5bmMoZmlsZXBhdGgsIG9wdHMuZmxhZyB8fCAndycsIG9wdHMubW9kZSB8fCAwbzY2NikKCiAgICBsZXQgbGVuID0gMAoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGxlbiArPSB3cml0ZVN5bmMoZmQsIGxlbiA/IGRhdGEuc3ViYXJyYXkobGVuKSA6IGRhdGEpCiAgICAgIGlmIChsZW4gPT09IGRhdGEuYnl0ZUxlbmd0aCkgYnJlYWsKICAgIH0KICB9IGZpbmFsbHkgewogICAgaWYgKGZkICE9PSAtMSkgY2xvc2VTeW5jKGZkKQogIH0KfQoKZnVuY3Rpb24gYXBwZW5kRmlsZShmaWxlcGF0aCwgZGF0YSwgb3B0cywgY2IpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb3B0cwogICAgb3B0cyA9IHt9CiAgfQoKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBpZiAoIW9wdHMuZmxhZykgb3B0cyA9IHsgLi4ub3B0cywgZmxhZzogJ2EnIH0KCiAgcmV0dXJuIHdyaXRlRmlsZShmaWxlcGF0aCwgZGF0YSwgb3B0cywgY2IpCn0KCmZ1bmN0aW9uIGFwcGVuZEZpbGVTeW5jKGZpbGVwYXRoLCBkYXRhLCBvcHRzKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgaWYgKCFvcHRzLmZsYWcpIG9wdHMgPSB7IC4uLm9wdHMsIGZsYWc6ICdhJyB9CgogIHJldHVybiB3cml0ZUZpbGVTeW5jKGZpbGVwYXRoLCBkYXRhLCBvcHRzKQp9CgpmdW5jdGlvbiB3YXRjaChmaWxlcGF0aCwgb3B0cywgY2IpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb3B0cwogICAgb3B0cyA9IHt9CiAgfQoKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHJldHVybiBuZXcgV2F0Y2hlcihmaWxlcGF0aCwgb3B0cywgY2IpCn0KCmNsYXNzIFN0YXRzIHsKICBjb25zdHJ1Y3RvcigKICAgIGRldiwKICAgIG1vZGUsCiAgICBubGluaywKICAgIHVpZCwKICAgIGdpZCwKICAgIHJkZXYsCiAgICBibGtzaXplLAogICAgaW5vLAogICAgc2l6ZSwKICAgIGJsb2NrcywKICAgIGF0aW1lTXMsCiAgICBtdGltZU1zLAogICAgY3RpbWVNcywKICAgIGJpcnRodGltZU1zCiAgKSB7CiAgICB0aGlzLmRldiA9IGRldgogICAgdGhpcy5tb2RlID0gbW9kZQogICAgdGhpcy5ubGluayA9IG5saW5rCiAgICB0aGlzLnVpZCA9IHVpZAogICAgdGhpcy5naWQgPSBnaWQKICAgIHRoaXMucmRldiA9IHJkZXYKICAgIHRoaXMuYmxrc2l6ZSA9IGJsa3NpemUKICAgIHRoaXMuaW5vID0gaW5vCiAgICB0aGlzLnNpemUgPSBzaXplCiAgICB0aGlzLmJsb2NrcyA9IGJsb2NrcwogICAgdGhpcy5hdGltZU1zID0gYXRpbWVNcwogICAgdGhpcy5tdGltZU1zID0gbXRpbWVNcwogICAgdGhpcy5jdGltZU1zID0gY3RpbWVNcwogICAgdGhpcy5iaXJ0aHRpbWVNcyA9IGJpcnRodGltZU1zCiAgICB0aGlzLmF0aW1lID0gbmV3IERhdGUoYXRpbWVNcykKICAgIHRoaXMubXRpbWUgPSBuZXcgRGF0ZShtdGltZU1zKQogICAgdGhpcy5jdGltZSA9IG5ldyBEYXRlKGN0aW1lTXMpCiAgICB0aGlzLmJpcnRodGltZSA9IG5ldyBEYXRlKGJpcnRodGltZU1zKQogIH0KCiAgaXNEaXJlY3RvcnkoKSB7CiAgICByZXR1cm4gKHRoaXMubW9kZSAmIGNvbnN0YW50cy5TX0lGTVQpID09PSBjb25zdGFudHMuU19JRkRJUgogIH0KCiAgaXNGaWxlKCkgewogICAgcmV0dXJuICh0aGlzLm1vZGUgJiBjb25zdGFudHMuU19JRk1UKSA9PT0gY29uc3RhbnRzLlNfSUZSRUcKICB9CgogIGlzQmxvY2tEZXZpY2UoKSB7CiAgICByZXR1cm4gKHRoaXMubW9kZSAmIGNvbnN0YW50cy5TX0lGTVQpID09PSBjb25zdGFudHMuU19JRkJMSwogIH0KCiAgaXNDaGFyYWN0ZXJEZXZpY2UoKSB7CiAgICByZXR1cm4gKHRoaXMubW9kZSAmIGNvbnN0YW50cy5TX0lGQ0hSKSA9PT0gY29uc3RhbnRzLlNfSUZDSFIKICB9CgogIGlzRklGTygpIHsKICAgIHJldHVybiAodGhpcy5tb2RlICYgY29uc3RhbnRzLlNfSUZNVCkgPT09IGNvbnN0YW50cy5TX0lGSUZPCiAgfQoKICBpc1N5bWJvbGljTGluaygpIHsKICAgIHJldHVybiAodGhpcy5tb2RlICYgY29uc3RhbnRzLlNfSUZNVCkgPT09IGNvbnN0YW50cy5TX0lGTE5LCiAgfQoKICBpc1NvY2tldCgpIHsKICAgIHJldHVybiAodGhpcy5tb2RlICYgY29uc3RhbnRzLlNfSUZNVCkgPT09IGNvbnN0YW50cy5TX0lGU09DSwogIH0KfQoKY2xhc3MgRGlyIHsKICBjb25zdHJ1Y3RvcihwYXRoLCBoYW5kbGUsIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyBlbmNvZGluZyA9ICd1dGY4JywgYnVmZmVyU2l6ZSA9IDMyIH0gPSBvcHRzCgogICAgdGhpcy5wYXRoID0gcGF0aAoKICAgIHRoaXMuX2VuY29kaW5nID0gZW5jb2RpbmcKICAgIHRoaXMuX2NhcGFjaXR5ID0gYnVmZmVyU2l6ZQogICAgdGhpcy5fYnVmZmVyID0gbmV3IEZJRk8oKQogICAgdGhpcy5fZW5kZWQgPSBmYWxzZQogICAgdGhpcy5faGFuZGxlID0gaGFuZGxlCiAgfQoKICBhc3luYyByZWFkKGNiKSB7CiAgICBpZiAodGhpcy5fYnVmZmVyLmxlbmd0aCkgcmV0dXJuIG9rKHRoaXMuX2J1ZmZlci5zaGlmdCgpLCBjYikKICAgIGlmICh0aGlzLl9lbmRlZCkgcmV0dXJuIG9rKG51bGwsIGNiKQoKICAgIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogICAgbGV0IGVudHJpZXMKICAgIGxldCBlcnIgPSBudWxsCiAgICB0cnkgewogICAgICByZXEucmV0YWluKGJpbmRpbmcucmVhZGRpcihyZXEuaGFuZGxlLCB0aGlzLl9oYW5kbGUsIHRoaXMuX2NhcGFjaXR5KSkKCiAgICAgIGF3YWl0IHJlcQoKICAgICAgZW50cmllcyA9IGJpbmRpbmcucmVxdWVzdFJlc3VsdERpcmVudHMocmVxLmhhbmRsZSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgICBvcGVyYXRpb246ICdyZWFkZGlyJywKICAgICAgICBjb2RlOiBlLmNvZGUsCiAgICAgICAgcGF0aDogdGhpcy5wYXRoCiAgICAgIH0pCiAgICB9CgogICAgaWYgKGVycikgcmV0dXJuIGZhaWwoZXJyLCBjYikKCiAgICBpZiAoZW50cmllcy5sZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5fZW5kZWQgPSB0cnVlCgogICAgICByZXR1cm4gb2sobnVsbCwgY2IpCiAgICB9CgogICAgZm9yIChjb25zdCBlbnRyeSBvZiBlbnRyaWVzKSB7CiAgICAgIGxldCBuYW1lID0gQnVmZmVyLmZyb20oZW50cnkubmFtZSkKCiAgICAgIGlmICh0aGlzLl9lbmNvZGluZyAhPT0gJ2J1ZmZlcicpIG5hbWUgPSBuYW1lLnRvU3RyaW5nKHRoaXMuX2VuY29kaW5nKQoKICAgICAgdGhpcy5fYnVmZmVyLnB1c2gobmV3IERpcmVudCh0aGlzLnBhdGgsIG5hbWUsIGVudHJ5LnR5cGUpKQogICAgfQoKICAgIHJldHVybiBvayh0aGlzLl9idWZmZXIuc2hpZnQoKSwgY2IpCiAgfQoKICByZWFkU3luYygpIHsKICAgIGlmICh0aGlzLl9idWZmZXIubGVuZ3RoKSByZXR1cm4gdGhpcy5fYnVmZmVyLnNoaWZ0KCkKICAgIGlmICh0aGlzLl9lbmRlZCkgcmV0dXJuIG51bGwKCiAgICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICAgIGxldCBlbnRyaWVzCiAgICB0cnkgewogICAgICByZXEucmV0YWluKGJpbmRpbmcucmVhZGRpclN5bmMocmVxLmhhbmRsZSwgdGhpcy5faGFuZGxlLCB0aGlzLl9jYXBhY2l0eSkpCgogICAgICBlbnRyaWVzID0gYmluZGluZy5yZXF1ZXN0UmVzdWx0RGlyZW50cyhyZXEuaGFuZGxlKQogICAgfSBjYXRjaCAoZSkgewogICAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICAgIG9wZXJhdGlvbjogJ3JlYWRkaXInLAogICAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgICBwYXRoOiB0aGlzLnBhdGgKICAgICAgfSkKICAgIH0KCiAgICBpZiAoZW50cmllcy5sZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5fZW5kZWQgPSB0cnVlCgogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGZvciAoY29uc3QgZW50cnkgb2YgZW50cmllcykgewogICAgICBsZXQgbmFtZSA9IEJ1ZmZlci5mcm9tKGVudHJ5Lm5hbWUpCgogICAgICBpZiAodGhpcy5fZW5jb2RpbmcgIT09ICdidWZmZXInKSBuYW1lID0gbmFtZS50b1N0cmluZyh0aGlzLl9lbmNvZGluZykKCiAgICAgIHRoaXMuX2J1ZmZlci5wdXNoKG5ldyBEaXJlbnQodGhpcy5wYXRoLCBuYW1lLCBlbnRyeS50eXBlKSkKICAgIH0KCiAgICByZXR1cm4gdGhpcy5fYnVmZmVyLnNoaWZ0KCkKICB9CgogIGFzeW5jIGNsb3NlKGNiKSB7CiAgICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICAgIGxldCBlcnIgPSBudWxsCiAgICB0cnkgewogICAgICBiaW5kaW5nLmNsb3NlZGlyKHJlcS5oYW5kbGUsIHRoaXMuX2hhbmRsZSkKCiAgICAgIGF3YWl0IHJlcQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICAgIG9wZXJhdGlvbjogJ2Nsb3NlZGlyJywKICAgICAgICBjb2RlOiBlLmNvZGUsCiAgICAgICAgcGF0aDogdGhpcy5wYXRoCiAgICAgIH0pCiAgICB9CgogICAgdGhpcy5faGFuZGxlID0gbnVsbAoKICAgIHJldHVybiBkb25lKGVyciwgY2IpCiAgfQoKICBjbG9zZVN5bmMoKSB7CiAgICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICAgIHRyeSB7CiAgICAgIGJpbmRpbmcuY2xvc2VkaXJTeW5jKHJlcS5oYW5kbGUsIHRoaXMuX2hhbmRsZSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgICBvcGVyYXRpb246ICdjbG9zZWRpcicsCiAgICAgICAgY29kZTogZS5jb2RlLAogICAgICAgIHBhdGg6IHRoaXMucGF0aAogICAgICB9KQogICAgfQoKICAgIHRoaXMuX2hhbmRsZSA9IG51bGwKICB9CgogIFtTeW1ib2wuZGlzcG9zZV0oKSB7CiAgICB0aGlzLmNsb3NlU3luYygpCiAgfQoKICBhc3luYyBbU3ltYm9sLmFzeW5jRGlzcG9zZV0oKSB7CiAgICBhd2FpdCB0aGlzLmNsb3NlKCkKICB9CgogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5yZWFkU3luYygpCiAgICAgIGlmIChlbnRyeSA9PT0gbnVsbCkgYnJlYWsKICAgICAgeWllbGQgZW50cnkKICAgIH0KCiAgICB0aGlzLmNsb3NlU3luYygpCiAgfQoKICBhc3luYyAqW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGNvbnN0IGVudHJ5ID0gYXdhaXQgdGhpcy5yZWFkKCkKICAgICAgaWYgKGVudHJ5ID09PSBudWxsKSBicmVhawogICAgICB5aWVsZCBlbnRyeQogICAgfQoKICAgIGF3YWl0IHRoaXMuY2xvc2UoKQogIH0KfQoKY2xhc3MgRGlyZW50IHsKICBjb25zdHJ1Y3RvcihwYXJlbnRQYXRoLCBuYW1lLCB0eXBlKSB7CiAgICB0aGlzLnBhcmVudFBhdGggPSBwYXJlbnRQYXRoCiAgICB0aGlzLm5hbWUgPSBuYW1lCiAgICB0aGlzLnR5cGUgPSB0eXBlCiAgfQoKICBpc0ZpbGUoKSB7CiAgICByZXR1cm4gdGhpcy50eXBlID09PSBjb25zdGFudHMuVVZfRElSRU5UX0ZJTEUKICB9CgogIGlzRGlyZWN0b3J5KCkgewogICAgcmV0dXJuIHRoaXMudHlwZSA9PT0gY29uc3RhbnRzLlVWX0RJUkVOVF9ESVIKICB9CgogIGlzU3ltYm9saWNMaW5rKCkgewogICAgcmV0dXJuIHRoaXMudHlwZSA9PT0gY29uc3RhbnRzLlVWX0RJUkVOVF9MSU5LCiAgfQoKICBpc0ZJRk8oKSB7CiAgICByZXR1cm4gdGhpcy50eXBlID09PSBjb25zdGFudHMuVVZfRElSRU5UX0ZJRk8KICB9CgogIGlzU29ja2V0KCkgewogICAgcmV0dXJuIHRoaXMudHlwZSA9PT0gY29uc3RhbnRzLlVWX0RJUkVOVF9TT0NLRVQKICB9CgogIGlzQ2hhcmFjdGVyRGV2aWNlKCkgewogICAgcmV0dXJuIHRoaXMudHlwZSA9PT0gY29uc3RhbnRzLlVWX0RJUkVOVF9DSEFSCiAgfQoKICBpc0Jsb2NrRGV2aWNlKCkgewogICAgcmV0dXJuIHRoaXMudHlwZSA9PT0gY29uc3RhbnRzLlVWX0RJUkVOVF9CTE9DSwogIH0KfQoKY2xhc3MgRmlsZVJlYWRTdHJlYW0gZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3IocGF0aCwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IGVhZ2VyT3BlbiA9IHRydWUgfSA9IG9wdHMKCiAgICBzdXBlcih7IGVhZ2VyT3BlbiwgLi4ub3B0cyB9KQoKICAgIHRoaXMucGF0aCA9IHBhdGgKICAgIHRoaXMuZmQgPSB0eXBlb2Ygb3B0cy5mZCA9PT0gJ251bWJlcicgPyBvcHRzLmZkIDogLTEKICAgIHRoaXMuZmxhZ3MgPSBvcHRzLmZsYWdzIHx8ICdyJwogICAgdGhpcy5tb2RlID0gb3B0cy5tb2RlIHx8IDBvNjY2CgogICAgdGhpcy5fb2Zmc2V0ID0gb3B0cy5zdGFydCB8fCAwCiAgICB0aGlzLl9taXNzaW5nID0gMAoKICAgIGlmIChvcHRzLmxlbmd0aCkgewogICAgICB0aGlzLl9taXNzaW5nID0gb3B0cy5sZW5ndGgKICAgIH0gZWxzZSBpZiAodHlwZW9mIG9wdHMuZW5kID09PSAnbnVtYmVyJykgewogICAgICB0aGlzLl9taXNzaW5nID0gb3B0cy5lbmQgLSB0aGlzLl9vZmZzZXQgKyAxCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9taXNzaW5nID0gLTEKICAgIH0KICB9CgogIGFzeW5jIF9vcGVuKGNiKSB7CiAgICBsZXQgZXJyCgogICAgaWYgKHRoaXMuZmQgPT09IC0xKSB7CiAgICAgIGVyciA9IG51bGwKICAgICAgdHJ5IHsKICAgICAgICB0aGlzLmZkID0gYXdhaXQgb3Blbih0aGlzLnBhdGgsIHRoaXMuZmxhZ3MsIHRoaXMubW9kZSkKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGVyciA9IGUKICAgICAgfQoKICAgICAgaWYgKGVycikgcmV0dXJuIGNiKGVycikKICAgIH0KCiAgICBsZXQgc3QKICAgIGVyciA9IG51bGwKICAgIHRyeSB7CiAgICAgIHN0ID0gYXdhaXQgZnN0YXQodGhpcy5mZCkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyID0gZQogICAgfQoKICAgIGlmIChlcnIpIHJldHVybiBjYihlcnIpCgogICAgaWYgKHRoaXMuX21pc3NpbmcgPT09IC0xKSB0aGlzLl9taXNzaW5nID0gc3Quc2l6ZQoKICAgIGlmIChzdC5zaXplIDwgdGhpcy5fb2Zmc2V0KSB7CiAgICAgIHRoaXMuX29mZnNldCA9IHN0LnNpemUKICAgICAgdGhpcy5fbWlzc2luZyA9IDAKICAgIH0gZWxzZSBpZiAoc3Quc2l6ZSA8IHRoaXMuX29mZnNldCArIHRoaXMuX21pc3NpbmcpIHsKICAgICAgdGhpcy5fbWlzc2luZyA9IHN0LnNpemUgLSB0aGlzLl9vZmZzZXQKICAgIH0KCiAgICBjYihudWxsKQogIH0KCiAgYXN5bmMgX3JlYWQoc2l6ZSkgewogICAgaWYgKHRoaXMuX21pc3NpbmcgPD0gMCkgcmV0dXJuIHRoaXMucHVzaChudWxsKQoKICAgIGNvbnN0IGRhdGEgPSBCdWZmZXIuYWxsb2NVbnNhZmUoTWF0aC5taW4odGhpcy5fbWlzc2luZywgc2l6ZSkpCgogICAgbGV0IGxlbgogICAgbGV0IGVyciA9IG51bGwKICAgIHRyeSB7CiAgICAgIGxlbiA9IGF3YWl0IHJlYWQodGhpcy5mZCwgZGF0YSwgMCwgZGF0YS5ieXRlTGVuZ3RoLCB0aGlzLl9vZmZzZXQpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGVyciA9IGUKICAgIH0KCiAgICBpZiAoZXJyKSByZXR1cm4gdGhpcy5kZXN0cm95KGVycikKCiAgICBpZiAobGVuID09PSAwKSByZXR1cm4gdGhpcy5wdXNoKG51bGwpCgogICAgaWYgKHRoaXMuX21pc3NpbmcgPCBsZW4pIGxlbiA9IHRoaXMuX21pc3NpbmcKCiAgICB0aGlzLl9taXNzaW5nIC09IGxlbgogICAgdGhpcy5fb2Zmc2V0ICs9IGxlbgoKICAgIHRoaXMucHVzaChkYXRhLnN1YmFycmF5KDAsIGxlbikpCiAgfQoKICBhc3luYyBfZGVzdHJveShlcnIsIGNiKSB7CiAgICBpZiAodGhpcy5mZCA9PT0gLTEpIHJldHVybiBjYihlcnIpCgogICAgZXJyID0gbnVsbAogICAgdHJ5IHsKICAgICAgYXdhaXQgY2xvc2UodGhpcy5mZCkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyID0gZQogICAgfQoKICAgIGNiKGVycikKICB9Cn0KCmNsYXNzIEZpbGVXcml0ZVN0cmVhbSBleHRlbmRzIFdyaXRhYmxlIHsKICBjb25zdHJ1Y3RvcihwYXRoLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgZWFnZXJPcGVuID0gdHJ1ZSB9ID0gb3B0cwoKICAgIHN1cGVyKHsgZWFnZXJPcGVuLCAuLi5vcHRzIH0pCgogICAgdGhpcy5wYXRoID0gcGF0aAogICAgdGhpcy5mZCA9IHR5cGVvZiBvcHRzLmZkID09PSAnbnVtYmVyJyA/IG9wdHMuZmQgOiAtMQogICAgdGhpcy5mbGFncyA9IG9wdHMuZmxhZ3MgfHwgJ3cnCiAgICB0aGlzLm1vZGUgPSBvcHRzLm1vZGUgfHwgMG82NjYKICB9CgogIGFzeW5jIF9vcGVuKGNiKSB7CiAgICBpZiAodGhpcy5mZCAhPT0gLTEpIHJldHVybiBjYihudWxsKQoKICAgIGxldCBlcnIgPSBudWxsCiAgICB0cnkgewogICAgICB0aGlzLmZkID0gYXdhaXQgb3Blbih0aGlzLnBhdGgsIHRoaXMuZmxhZ3MsIHRoaXMubW9kZSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyID0gZQogICAgfQoKICAgIGNiKGVycikKICB9CgogIGFzeW5jIF93cml0ZXYoYmF0Y2gsIGNiKSB7CiAgICBsZXQgZXJyID0gbnVsbAogICAgdHJ5IHsKICAgICAgYXdhaXQgd3JpdGV2KAogICAgICAgIHRoaXMuZmQsCiAgICAgICAgYmF0Y2gubWFwKCh7IGNodW5rIH0pID0+IGNodW5rKQogICAgICApCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGVyciA9IGUKICAgIH0KCiAgICBjYihlcnIpCiAgfQoKICBhc3luYyBfZGVzdHJveShlcnIsIGNiKSB7CiAgICBpZiAodGhpcy5mZCA9PT0gLTEpIHJldHVybiBjYihlcnIpCgogICAgZXJyID0gbnVsbAogICAgdHJ5IHsKICAgICAgYXdhaXQgY2xvc2UodGhpcy5mZCkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyID0gZQogICAgfQoKICAgIGNiKGVycikKICB9Cn0KCmNsYXNzIFdhdGNoZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKHBhdGgsIG9wdHMsIG9uY2hhbmdlKSB7CiAgICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgb25jaGFuZ2UgPSBvcHRzCiAgICAgIG9wdHMgPSB7fQogICAgfQoKICAgIGlmICghb3B0cykgb3B0cyA9IHt9CgogICAgY29uc3QgeyBwZXJzaXN0ZW50ID0gdHJ1ZSwgcmVjdXJzaXZlID0gZmFsc2UsIGVuY29kaW5nID0gJ3V0ZjgnIH0gPSBvcHRzCgogICAgc3VwZXIoKQoKICAgIHRoaXMuX2Nsb3NlZCA9IGZhbHNlCiAgICB0aGlzLl9lbmNvZGluZyA9IGVuY29kaW5nCiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLndhdGNoZXJJbml0KHBhdGgsIHJlY3Vyc2l2ZSwgdGhpcywgdGhpcy5fb25ldmVudCwgdGhpcy5fb25jbG9zZSkKCiAgICBpZiAoIXBlcnNpc3RlbnQpIHRoaXMudW5yZWYoKQoKICAgIGlmIChvbmNoYW5nZSkgdGhpcy5vbignY2hhbmdlJywgb25jaGFuZ2UpCiAgfQoKICBjbG9zZSgpIHsKICAgIGlmICh0aGlzLl9jbG9zZWQpIHJldHVybgogICAgdGhpcy5fY2xvc2VkID0gdHJ1ZQoKICAgIGJpbmRpbmcud2F0Y2hlckNsb3NlKHRoaXMuX2hhbmRsZSkKICB9CgogIHJlZigpIHsKICAgIGlmICh0aGlzLl9oYW5kbGUpIGJpbmRpbmcud2F0Y2hlclJlZih0aGlzLl9oYW5kbGUpCiAgICByZXR1cm4gdGhpcwogIH0KCiAgdW5yZWYoKSB7CiAgICBpZiAodGhpcy5faGFuZGxlKSBiaW5kaW5nLndhdGNoZXJVbnJlZih0aGlzLl9oYW5kbGUpCiAgICByZXR1cm4gdGhpcwogIH0KCiAgW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHsKICAgIGNvbnN0IGJ1ZmZlciA9IFtdCiAgICBsZXQgZG9uZSA9IGZhbHNlCiAgICBsZXQgZXJyb3IgPSBudWxsCiAgICBsZXQgbmV4dCA9IG51bGwKCiAgICB0aGlzLm9uKCdjaGFuZ2UnLCAoZXZlbnRUeXBlLCBmaWxlbmFtZSkgPT4gewogICAgICBpZiAobmV4dCkgewogICAgICAgIG5leHQucmVzb2x2ZSh7IGRvbmU6IGZhbHNlLCB2YWx1ZTogeyBldmVudFR5cGUsIGZpbGVuYW1lIH0gfSkKICAgICAgICBuZXh0ID0gbnVsbAogICAgICB9IGVsc2UgewogICAgICAgIGJ1ZmZlci5wdXNoKHsgZXZlbnRUeXBlLCBmaWxlbmFtZSB9KQogICAgICB9CiAgICB9KQogICAgICAub24oJ2Vycm9yJywgKGVycikgPT4gewogICAgICAgIGRvbmUgPSB0cnVlCiAgICAgICAgZXJyb3IgPSBlcnIKCiAgICAgICAgaWYgKG5leHQpIHsKICAgICAgICAgIG5leHQucmVqZWN0KGVycm9yKQogICAgICAgICAgbmV4dCA9IG51bGwKICAgICAgICB9CiAgICAgIH0pCiAgICAgIC5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgICAgZG9uZSA9IHRydWUKCiAgICAgICAgaWYgKG5leHQpIHsKICAgICAgICAgIG5leHQucmVzb2x2ZSh7IGRvbmUgfSkKICAgICAgICAgIG5leHQgPSBudWxsCiAgICAgICAgfQogICAgICB9KQoKICAgIHJldHVybiB7CiAgICAgIG5leHQ6ICgpID0+CiAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgICAgaWYgKGVycm9yKSByZXR1cm4gcmVqZWN0KGVycm9yKQoKICAgICAgICAgIGlmIChidWZmZXIubGVuZ3RoKSByZXR1cm4gcmVzb2x2ZSh7IGRvbmU6IGZhbHNlLCB2YWx1ZTogYnVmZmVyLnNoaWZ0KCkgfSkKCiAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuIHJlc29sdmUoeyBkb25lIH0pCgogICAgICAgICAgbmV4dCA9IHsgcmVzb2x2ZSwgcmVqZWN0IH0KICAgICAgICB9KQogICAgfQogIH0KCiAgX29uZXZlbnQoZXJyLCBldmVudHMsIGZpbGVuYW1lKSB7CiAgICBpZiAoZXJyKSB7CiAgICAgIHRoaXMuY2xvc2UoKQogICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyKQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgcGF0aCA9CiAgICAgICAgdGhpcy5fZW5jb2RpbmcgPT09ICdidWZmZXInCiAgICAgICAgICA/IEJ1ZmZlci5mcm9tKGZpbGVuYW1lKQogICAgICAgICAgOiBCdWZmZXIuZnJvbShmaWxlbmFtZSkudG9TdHJpbmcodGhpcy5fZW5jb2RpbmcpCgogICAgICBpZiAoZXZlbnRzICYgYmluZGluZy5VVl9SRU5BTUUpIHsKICAgICAgICB0aGlzLmVtaXQoJ2NoYW5nZScsICdyZW5hbWUnLCBwYXRoKQogICAgICB9CgogICAgICBpZiAoZXZlbnRzICYgYmluZGluZy5VVl9DSEFOR0UpIHsKICAgICAgICB0aGlzLmVtaXQoJ2NoYW5nZScsICdjaGFuZ2UnLCBwYXRoKQogICAgICB9CiAgICB9CiAgfQoKICBfb25jbG9zZSgpIHsKICAgIHRoaXMuX2hhbmRsZSA9IG51bGwKCiAgICB0aGlzLmVtaXQoJ2Nsb3NlJykKICB9Cn0KCmV4cG9ydHMuYWNjZXNzID0gYWNjZXNzCmV4cG9ydHMuYXBwZW5kRmlsZSA9IGFwcGVuZEZpbGUKZXhwb3J0cy5jaG1vZCA9IGNobW9kCi8vIGV4cG9ydHMuY2hvd24gPSBjaG93biBUT0RPCmV4cG9ydHMuY2xvc2UgPSBjbG9zZQpleHBvcnRzLmNvcHlGaWxlID0gY29weUZpbGUKZXhwb3J0cy5jcCA9IGNwCmV4cG9ydHMuZXhpc3RzID0gZXhpc3RzCmV4cG9ydHMuZmNobW9kID0gZmNobW9kCi8vIGV4cG9ydHMuZmNob3duID0gZmNob3duIFRPRE8KLy8gZXhwb3J0cy5mZGF0YXN5bmMgPSBmZGF0YXN5bmMgVE9ETwpleHBvcnRzLmZzdGF0ID0gZnN0YXQKLy8gZXhwb3J0cy5mc3luYyA9IGZzeW5jIFRPRE8KZXhwb3J0cy5mdHJ1bmNhdGUgPSBmdHJ1bmNhdGUKLy8gZXhwb3J0cy5mdXRpbWVzID0gZnV0aW1lcyBUT0RPCi8vIGV4cG9ydHMubGNobW9kID0gbGNobW9kIFRPRE8KLy8gZXhwb3J0cy5sY2hvd24gPSBsY2hvd24gVE9ETwovLyBleHBvcnRzLmx1dGltZXMgPSBsdXRpbWVzIFRPRE8KLy8gZXhwb3J0cy5saW5rID0gbGluayBUT0RPCmV4cG9ydHMubHN0YXQgPSBsc3RhdApleHBvcnRzLm1rZGlyID0gbWtkaXIKLy8gZXhwb3J0cy5ta2R0ZW1wID0gbWtkdGVtcCBUT0RPCmV4cG9ydHMub3BlbiA9IG9wZW4KZXhwb3J0cy5vcGVuZGlyID0gb3BlbmRpcgpleHBvcnRzLnJlYWQgPSByZWFkCmV4cG9ydHMucmVhZEZpbGUgPSByZWFkRmlsZQpleHBvcnRzLnJlYWRkaXIgPSByZWFkZGlyCmV4cG9ydHMucmVhZGxpbmsgPSByZWFkbGluawpleHBvcnRzLnJlYWR2ID0gcmVhZHYKZXhwb3J0cy5yZWFscGF0aCA9IHJlYWxwYXRoCmV4cG9ydHMucmVuYW1lID0gcmVuYW1lCmV4cG9ydHMucm0gPSBybQpleHBvcnRzLnJtZGlyID0gcm1kaXIKZXhwb3J0cy5zdGF0ID0gc3RhdAovLyBleHBvcnRzLnN0YXRmcyA9IHN0YXRmcyBUT0RPCmV4cG9ydHMuc3ltbGluayA9IHN5bWxpbmsKLy8gZXhwb3J0cy50cnVuY2F0ZSA9IHRydW5jYXRlIFRPRE8KZXhwb3J0cy51bmxpbmsgPSB1bmxpbmsKZXhwb3J0cy51dGltZXMgPSB1dGltZXMKZXhwb3J0cy53YXRjaCA9IHdhdGNoCmV4cG9ydHMud3JpdGUgPSB3cml0ZQpleHBvcnRzLndyaXRlRmlsZSA9IHdyaXRlRmlsZQpleHBvcnRzLndyaXRldiA9IHdyaXRldgoKZXhwb3J0cy5hY2Nlc3NTeW5jID0gYWNjZXNzU3luYwpleHBvcnRzLmFwcGVuZEZpbGVTeW5jID0gYXBwZW5kRmlsZVN5bmMKZXhwb3J0cy5jaG1vZFN5bmMgPSBjaG1vZFN5bmMKLy8gZXhwb3J0cy5jaG93blN5bmMgPSBjaG93blN5bmMgVE9ETwpleHBvcnRzLmNsb3NlU3luYyA9IGNsb3NlU3luYwpleHBvcnRzLmNvcHlGaWxlU3luYyA9IGNvcHlGaWxlU3luYwpleHBvcnRzLmV4aXN0c1N5bmMgPSBleGlzdHNTeW5jCmV4cG9ydHMuZmNobW9kU3luYyA9IGZjaG1vZFN5bmMKLy8gZXhwb3J0cy5mY2hvd25TeW5jID0gZmNob3duU3luYyBUT0RPCi8vIGV4cG9ydHMuZmRhdGFzeW5jU3luYyA9IGZkYXRhc3luY1N5bmMgVE9ETwpleHBvcnRzLmZzdGF0U3luYyA9IGZzdGF0U3luYwovLyBleHBvcnRzLmZzeW5jU3luYyA9IGZzeW5jU3luYyBUT0RPCmV4cG9ydHMuZnRydW5jYXRlU3luYyA9IGZ0cnVuY2F0ZVN5bmMKLy8gZXhwb3J0cy5mdXRpbWVzU3luYyA9IGZ1dGltZXNTeW5jIFRPRE8KLy8gZXhwb3J0cy5sY2htb2RTeW5jID0gbGNobW9kU3luYyBUT0RPCi8vIGV4cG9ydHMubGNob3duU3luYyA9IGxjaG93blN5bmMgVE9ETwovLyBleHBvcnRzLmx1dGltZXNTeW5jID0gbHV0aW1lc1N5bmMgVE9ETwovLyBleHBvcnRzLmxpbmtTeW5jID0gbGlua1N5bmMgVE9ETwpleHBvcnRzLmxzdGF0U3luYyA9IGxzdGF0U3luYwpleHBvcnRzLm1rZGlyU3luYyA9IG1rZGlyU3luYwovLyBleHBvcnRzLm1rZHRlbXBTeW5jID0gbWtkdGVtcFN5bmMgVE9ETwpleHBvcnRzLm9wZW5TeW5jID0gb3BlblN5bmMKZXhwb3J0cy5vcGVuZGlyU3luYyA9IG9wZW5kaXJTeW5jCmV4cG9ydHMucmVhZEZpbGVTeW5jID0gcmVhZEZpbGVTeW5jCmV4cG9ydHMucmVhZFN5bmMgPSByZWFkU3luYwpleHBvcnRzLnJlYWRkaXJTeW5jID0gcmVhZGRpclN5bmMKZXhwb3J0cy5yZWFkbGlua1N5bmMgPSByZWFkbGlua1N5bmMKZXhwb3J0cy5yZWFkdlN5bmMgPSByZWFkdlN5bmMKZXhwb3J0cy5yZWFscGF0aFN5bmMgPSByZWFscGF0aFN5bmMKZXhwb3J0cy5yZW5hbWVTeW5jID0gcmVuYW1lU3luYwpleHBvcnRzLnJtU3luYyA9IHJtU3luYwpleHBvcnRzLnJtZGlyU3luYyA9IHJtZGlyU3luYwpleHBvcnRzLnN0YXRTeW5jID0gc3RhdFN5bmMKLy8gZXhwb3J0cy5zdGF0ZnNTeW5jID0gc3RhdGZzU3luYyBUT0RPCmV4cG9ydHMuc3ltbGlua1N5bmMgPSBzeW1saW5rU3luYwovLyBleHBvcnRzLnRydW5jYXRlU3luYyA9IHRydW5jYXRlU3luYyBUT0RPCmV4cG9ydHMudW5saW5rU3luYyA9IHVubGlua1N5bmMKZXhwb3J0cy51dGltZXNTeW5jID0gdXRpbWVzU3luYwpleHBvcnRzLndyaXRlRmlsZVN5bmMgPSB3cml0ZUZpbGVTeW5jCmV4cG9ydHMud3JpdGVTeW5jID0gd3JpdGVTeW5jCmV4cG9ydHMud3JpdGV2U3luYyA9IHdyaXRldlN5bmMKCmV4cG9ydHMucHJvbWlzZXMgPSByZXF1aXJlKCcuL3Byb21pc2VzJykKCmV4cG9ydHMuU3RhdHMgPSBTdGF0cwpleHBvcnRzLkRpciA9IERpcgpleHBvcnRzLkRpcmVudCA9IERpcmVudApleHBvcnRzLldhdGNoZXIgPSBXYXRjaGVyCgpleHBvcnRzLlJlYWRTdHJlYW0gPSBGaWxlUmVhZFN0cmVhbQoKZXhwb3J0cy5jcmVhdGVSZWFkU3RyZWFtID0gZnVuY3Rpb24gY3JlYXRlUmVhZFN0cmVhbShwYXRoLCBvcHRzKSB7CiAgcmV0dXJuIG5ldyBGaWxlUmVhZFN0cmVhbShwYXRoLCBvcHRzKQp9CgpleHBvcnRzLldyaXRlU3RyZWFtID0gRmlsZVdyaXRlU3RyZWFtCgpleHBvcnRzLmNyZWF0ZVdyaXRlU3RyZWFtID0gZnVuY3Rpb24gY3JlYXRlV3JpdGVTdHJlYW0ocGF0aCwgb3B0cykgewogIHJldHVybiBuZXcgRmlsZVdyaXRlU3RyZWFtKHBhdGgsIG9wdHMpCn0KCmZ1bmN0aW9uIHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpIHsKICBpZiAodHlwZW9mIGZpbGVwYXRoICE9PSAnc3RyaW5nJykgewogICAgaWYgKFVSTC5pc1VSTChmaWxlcGF0aCkpIGZpbGVwYXRoID0gZmlsZVVSTFRvUGF0aChmaWxlcGF0aCkKICAgIGVsc2UgZmlsZXBhdGggPSBmaWxlcGF0aC50b1N0cmluZygpCiAgfQoKICByZXR1cm4gcGF0aC50b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQp9CgpmdW5jdGlvbiB0b0ZsYWdzKGZsYWdzKSB7CiAgc3dpdGNoIChmbGFncykgewogICAgY2FzZSAncic6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19SRE9OTFkKICAgIGNhc2UgJ3JzJzogLy8gRmFsbCB0aHJvdWdoLgogICAgY2FzZSAnc3InOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fUkRPTkxZIHwgY29uc3RhbnRzLk9fU1lOQwogICAgY2FzZSAncisnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fUkRXUgogICAgY2FzZSAncnMrJzogLy8gRmFsbCB0aHJvdWdoLgogICAgY2FzZSAnc3IrJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX1JEV1IgfCBjb25zdGFudHMuT19TWU5DCgogICAgY2FzZSAndyc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19UUlVOQyB8IGNvbnN0YW50cy5PX0NSRUFUIHwgY29uc3RhbnRzLk9fV1JPTkxZCiAgICBjYXNlICd3eCc6IC8vIEZhbGwgdGhyb3VnaC4KICAgIGNhc2UgJ3h3JzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX1RSVU5DIHwgY29uc3RhbnRzLk9fQ1JFQVQgfCBjb25zdGFudHMuT19XUk9OTFkgfCBjb25zdGFudHMuT19FWENMCgogICAgY2FzZSAndysnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fVFJVTkMgfCBjb25zdGFudHMuT19DUkVBVCB8IGNvbnN0YW50cy5PX1JEV1IKICAgIGNhc2UgJ3d4Kyc6IC8vIEZhbGwgdGhyb3VnaC4KICAgIGNhc2UgJ3h3Kyc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19UUlVOQyB8IGNvbnN0YW50cy5PX0NSRUFUIHwgY29uc3RhbnRzLk9fUkRXUiB8IGNvbnN0YW50cy5PX0VYQ0wKCiAgICBjYXNlICdhJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX0FQUEVORCB8IGNvbnN0YW50cy5PX0NSRUFUIHwgY29uc3RhbnRzLk9fV1JPTkxZCiAgICBjYXNlICdheCc6IC8vIEZhbGwgdGhyb3VnaC4KICAgIGNhc2UgJ3hhJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX0FQUEVORCB8IGNvbnN0YW50cy5PX0NSRUFUIHwgY29uc3RhbnRzLk9fV1JPTkxZIHwgY29uc3RhbnRzLk9fRVhDTAogICAgY2FzZSAnYXMnOiAvLyBGYWxsIHRocm91Z2guCiAgICBjYXNlICdzYSc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19BUFBFTkQgfCBjb25zdGFudHMuT19DUkVBVCB8IGNvbnN0YW50cy5PX1dST05MWSB8IGNvbnN0YW50cy5PX1NZTkMKCiAgICBjYXNlICdhKyc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19BUFBFTkQgfCBjb25zdGFudHMuT19DUkVBVCB8IGNvbnN0YW50cy5PX1JEV1IKICAgIGNhc2UgJ2F4Kyc6IC8vIEZhbGwgdGhyb3VnaC4KICAgIGNhc2UgJ3hhKyc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19BUFBFTkQgfCBjb25zdGFudHMuT19DUkVBVCB8IGNvbnN0YW50cy5PX1JEV1IgfCBjb25zdGFudHMuT19FWENMCiAgICBjYXNlICdhcysnOiAvLyBGYWxsIHRocm91Z2guCiAgICBjYXNlICdzYSsnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fQVBQRU5EIHwgY29uc3RhbnRzLk9fQ1JFQVQgfCBjb25zdGFudHMuT19SRFdSIHwgY29uc3RhbnRzLk9fU1lOQwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIDAKICB9Cn0KCmZ1bmN0aW9uIHRvTW9kZShtb2RlKSB7CiAgcmV0dXJuIHBhcnNlSW50KG1vZGUsIDgpCn0KY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgT19SRFdSOiBiaW5kaW5nLk9fUkRXUiwKICBPX1JET05MWTogYmluZGluZy5PX1JET05MWSwKICBPX1dST05MWTogYmluZGluZy5PX1dST05MWSwKICBPX0NSRUFUOiBiaW5kaW5nLk9fQ1JFQVQsCiAgT19UUlVOQzogYmluZGluZy5PX1RSVU5DLAogIE9fQVBQRU5EOiBiaW5kaW5nLk9fQVBQRU5ELAoKICBGX09LOiBiaW5kaW5nLkZfT0sgfHwgMCwKICBSX09LOiBiaW5kaW5nLlJfT0sgfHwgMCwKICBXX09LOiBiaW5kaW5nLldfT0sgfHwgMCwKICBYX09LOiBiaW5kaW5nLlhfT0sgfHwgMCwKCiAgU19JRk1UOiBiaW5kaW5nLlNfSUZNVCwKICBTX0lGUkVHOiBiaW5kaW5nLlNfSUZSRUcsCiAgU19JRkRJUjogYmluZGluZy5TX0lGRElSLAogIFNfSUZDSFI6IGJpbmRpbmcuU19JRkNIUiwKICBTX0lGTE5LOiBiaW5kaW5nLlNfSUZMTkssCiAgU19JRkJMSzogYmluZGluZy5TX0lGQkxLIHx8IDAsCiAgU19JRklGTzogYmluZGluZy5TX0lGSUZPIHx8IDAsCiAgU19JRlNPQ0s6IGJpbmRpbmcuU19JRlNPQ0sgfHwgMCwKCiAgU19JUlVTUjogYmluZGluZy5TX0lSVVNSIHx8IDAsCiAgU19JV1VTUjogYmluZGluZy5TX0lXVVNSIHx8IDAsCiAgU19JWFVTUjogYmluZGluZy5TX0lYVVNSIHx8IDAsCiAgU19JUkdSUDogYmluZGluZy5TX0lSR1JQIHx8IDAsCiAgU19JV0dSUDogYmluZGluZy5TX0lXR1JQIHx8IDAsCiAgU19JWEdSUDogYmluZGluZy5TX0lYR1JQIHx8IDAsCiAgU19JUk9USDogYmluZGluZy5TX0lST1RIIHx8IDAsCiAgU19JV09USDogYmluZGluZy5TX0lXT1RIIHx8IDAsCiAgU19JWE9USDogYmluZGluZy5TX0lYT1RIIHx8IDAsCgogIFVWX0RJUkVOVF9VTktOT1dOOiBiaW5kaW5nLlVWX0RJUkVOVF9VTktOT1dOLAogIFVWX0RJUkVOVF9GSUxFOiBiaW5kaW5nLlVWX0RJUkVOVF9GSUxFLAogIFVWX0RJUkVOVF9ESVI6IGJpbmRpbmcuVVZfRElSRU5UX0RJUiwKICBVVl9ESVJFTlRfTElOSzogYmluZGluZy5VVl9ESVJFTlRfTElOSywKICBVVl9ESVJFTlRfRklGTzogYmluZGluZy5VVl9ESVJFTlRfRklGTywKICBVVl9ESVJFTlRfU09DS0VUOiBiaW5kaW5nLlVWX0RJUkVOVF9TT0NLRVQsCiAgVVZfRElSRU5UX0NIQVI6IGJpbmRpbmcuVVZfRElSRU5UX0NIQVIsCiAgVVZfRElSRU5UX0JMT0NLOiBiaW5kaW5nLlVWX0RJUkVOVF9CTE9DSywKCiAgQ09QWUZJTEVfRVhDTDogYmluZGluZy5VVl9GU19DT1BZRklMRV9FWENMLAogIENPUFlGSUxFX0ZJQ0xPTkU6IGJpbmRpbmcuVVZfRlNfQ09QWUZJTEVfRklDTE9ORSwKICBDT1BZRklMRV9GSUNMT05FX0ZPUkNFOiBiaW5kaW5nLlVWX0ZTX0NPUFlGSUxFX0ZJQ0xPTkVfRk9SQ0UsCiAgVVZfRlNfU1lNTElOS19ESVI6IGJpbmRpbmcuVVZfRlNfU1lNTElOS19ESVIsCiAgVVZfRlNfU1lNTElOS19KVU5DVElPTjogYmluZGluZy5VVl9GU19TWU1MSU5LX0pVTkNUSU9OCn0KY29uc3Qgb3MgPSByZXF1aXJlKCdiYXJlLW9zJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgRmlsZUVycm9yIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yKG1zZywgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IGNvZGUsIG9wZXJhdGlvbiA9IG51bGwsIHBhdGggPSBudWxsLCBkZXN0aW5hdGlvbiA9IG51bGwsIGZkID0gLTEgfSA9IG9wdHMKCiAgICBpZiAob3BlcmF0aW9uICE9PSBudWxsKSBtc2cgKz0gZGVzY3JpYmUob3BlcmF0aW9uLCBvcHRzKQoKICAgIHN1cGVyKGAke2NvZGV9OiAke21zZ31gKQoKICAgIHRoaXMuY29kZSA9IGNvZGUKCiAgICBpZiAob3BlcmF0aW9uICE9PSBudWxsKSB0aGlzLm9wZXJhdGlvbiA9IG9wZXJhdGlvbgogICAgaWYgKHBhdGggIT09IG51bGwpIHRoaXMucGF0aCA9IHBhdGgKICAgIGlmIChkZXN0aW5hdGlvbiAhPT0gbnVsbCkgdGhpcy5kZXN0aW5hdGlvbiA9IGRlc3RpbmF0aW9uCiAgICBpZiAoZmQgIT09IC0xKSB0aGlzLmZkID0gZmQKICB9CgogIGdldCBuYW1lKCkgewogICAgcmV0dXJuICdGaWxlRXJyb3InCiAgfQoKICAvLyBGb3IgTm9kZS5qcyBjb21wYXRpYmlsaXR5CiAgZ2V0IGVycm5vKCkgewogICAgcmV0dXJuIG9zLmNvbnN0YW50cy5lcnJub3NbdGhpcy5jb2RlXQogIH0KCiAgLy8gRm9yIE5vZGUuanMgY29tcGF0aWJpbGl0eQogIGdldCBzeXNjYWxsKCkgewogICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uCiAgfQoKICAvLyBGb3IgTm9kZS5qcyBjb21wYXRpYmlsaXR5CiAgZ2V0IGRlc3QoKSB7CiAgICByZXR1cm4gdGhpcy5kZXN0aW5hdGlvbgogIH0KfQoKZnVuY3Rpb24gZGVzY3JpYmUob3BlcmF0aW9uLCBvcHRzKSB7CiAgY29uc3QgeyBwYXRoID0gbnVsbCwgZGVzdGluYXRpb24gPSBudWxsLCBmZCA9IC0xIH0gPSBvcHRzCgogIGxldCByZXN1bHQgPSBgLCAke29wZXJhdGlvbn1gCgogIGlmIChwYXRoICE9PSBudWxsKSB7CiAgICByZXN1bHQgKz0gYCAke0pTT04uc3RyaW5naWZ5KHBhdGgpfWAKCiAgICBpZiAoZGVzdGluYXRpb24gIT09IG51bGwpIHsKICAgICAgcmVzdWx0ICs9IGAgLT4gJHtKU09OLnN0cmluZ2lmeShkZXN0aW5hdGlvbil9YAogICAgfQogIH0gZWxzZSBpZiAoZmQgIT09IC0xKSB7CiAgICByZXN1bHQgKz0gYCAke2ZkfWAKICB9CgogIHJldHVybiByZXN1bHQKfQp7CiAgIm5hbWUiOiAiYmFyZS1mcyIsCiAgInZlcnNpb24iOiAiNC41LjIiLAogICJkZXNjcmlwdGlvbiI6ICJOYXRpdmUgZmlsZSBzeXN0ZW0gb3BlcmF0aW9ucyBmb3IgSmF2YXNjcmlwdCIsCiAgImV4cG9ydHMiOiB7CiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuIjogewogICAgICAidHlwZXMiOiAiLi9pbmRleC5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9pbmRleC5qcyIKICAgIH0sCiAgICAiLi9wcm9taXNlcyI6IHsKICAgICAgInR5cGVzIjogIi4vcHJvbWlzZXMuZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vcHJvbWlzZXMuanMiCiAgICB9LAogICAgIi4vY29uc3RhbnRzIjogewogICAgICAidHlwZXMiOiAiLi9saWIvY29uc3RhbnRzLmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2xpYi9jb25zdGFudHMuanMiCiAgICB9CiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImluZGV4LmQudHMiLAogICAgInByb21pc2VzLmpzIiwKICAgICJwcm9taXNlcy5kLnRzIiwKICAgICJiaW5kaW5nLmMiLAogICAgImJpbmRpbmcuanMiLAogICAgIkNNYWtlTGlzdHMudHh0IiwKICAgICJsaWIiLAogICAgInByZWJ1aWxkcyIKICBdLAogICJhZGRvbiI6IHRydWUsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYmFyZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtZnMuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1mcy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtZnMjcmVhZG1lIiwKICAiZW5naW5lcyI6IHsKICAgICJiYXJlIjogIj49MS4xNi4wIgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWV2ZW50cyI6ICJeMi41LjQiLAogICAgImJhcmUtcGF0aCI6ICJeMy4wLjAiLAogICAgImJhcmUtc3RyZWFtIjogIl4yLjYuNCIsCiAgICAiYmFyZS11cmwiOiAiXjIuMi4yIiwKICAgICJmYXN0LWZpZm8iOiAiXjEuMy4yIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWJ1ZmZlciI6ICJeMy4wLjIiLAogICAgImJhcmUtY3J5cHRvIjogIl4xLjExLjIiLAogICAgImJyaXR0bGUiOiAiXjMuMS4xIiwKICAgICJjbWFrZS1iYXJlIjogIl4xLjEuNyIsCiAgICAicHJldHRpZXIiOiAiXjMuNC4xIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYnVmZmVyIjogIioiCiAgfSwKICAicGVlckRlcGVuZGVuY2llc01ldGEiOiB7CiAgICAiYmFyZS1idWZmZXIiOiB7CiAgICAgICJvcHRpb25hbCI6IHRydWUKICAgIH0KICB9Cn0KY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnYmFyZS1ldmVudHMnKQpjb25zdCBmcyA9IHJlcXVpcmUoJy4nKQoKY2xhc3MgRmlsZUhhbmRsZSBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IoZmQpIHsKICAgIHRoaXMuZmQgPSBmZAogIH0KCiAgYXN5bmMgY2xvc2UoKSB7CiAgICBhd2FpdCBmcy5jbG9zZShmZCkKCiAgICB0aGlzLmZkID0gLTEKICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogIH0KCiAgYXN5bmMgcmVhZChidWZmZXIsIC4uLmFyZ3MpIHsKICAgIHJldHVybiB7CiAgICAgIGJ5dGVzUmVhZDogYXdhaXQgZnMucmVhZCh0aGlzLmZkLCBidWZmZXIsIC4uLmFyZ3MpLAogICAgICBidWZmZXIKICAgIH0KICB9CgogIGFzeW5jIHJlYWR2KGJ1ZmZlcnMsIC4uLmFyZ3MpIHsKICAgIHJldHVybiB7CiAgICAgIGJ5dGVzUmVhZDogYXdhaXQgZnMucmVhZHYodGhpcy5mZCwgYnVmZmVycywgLi4uYXJncyksCiAgICAgIGJ1ZmZlcnMKICAgIH0KICB9CgogIGFzeW5jIHdyaXRlKGJ1ZmZlciwgLi4uYXJncykgewogICAgcmV0dXJuIHsKICAgICAgYnl0ZXNXcml0dGVuOiBhd2FpdCBmcy53cml0ZSh0aGlzLmZkLCBidWZmZXIsIC4uLmFyZ3MpLAogICAgICBidWZmZXIKICAgIH0KICB9CgogIGFzeW5jIHdyaXRldihidWZmZXJzLCAuLi5hcmdzKSB7CiAgICByZXR1cm4gewogICAgICBieXRlc1dyaXR0ZW46IGF3YWl0IGZzLndyaXRldih0aGlzLmZkLCBidWZmZXJzLCAuLi5hcmdzKSwKICAgICAgYnVmZmVycwogICAgfQogIH0KCiAgYXN5bmMgc3RhdCgpIHsKICAgIHJldHVybiBmcy5mc3RhdCh0aGlzLmZkKQogIH0KCiAgYXN5bmMgY2htb2QobW9kZSkgewogICAgYXdhaXQgZnMuZmNobW9kKHRoaXMuZmQsIG1vZGUpCiAgfQoKICBjcmVhdGVSZWFkU3RyZWFtKG9wdHMpIHsKICAgIHJldHVybiBmcy5jcmVhdGVSZWFkU3RyZWFtKG51bGwsIHsgLi4ub3B0cywgZmQ6IHRoaXMuZmQgfSkKICB9CgogIGNyZWF0ZVdyaXRlU3RyZWFtKG9wdHMpIHsKICAgIHJldHVybiBmcy5jcmVhdGVXcml0ZVN0cmVhbShudWxsLCB7IC4uLm9wdHMsIGZkOiB0aGlzLmZkIH0pCiAgfQoKICBhc3luYyBbU3ltYm9sLmFzeW5jRGlzcG9zZV0oKSB7CiAgICBhd2FpdCB0aGlzLmNsb3NlKCkKICB9Cn0KCmV4cG9ydHMub3BlbiA9IGFzeW5jIGZ1bmN0aW9uIG9wZW4oZmlsZXBhdGgsIGZsYWdzLCBtb2RlKSB7CiAgcmV0dXJuIG5ldyBGaWxlSGFuZGxlKGF3YWl0IGZzLm9wZW4oZmlsZXBhdGgsIGZsYWdzLCBtb2RlKSkKfQoKZXhwb3J0cy5hY2Nlc3MgPSBmcy5hY2Nlc3MKZXhwb3J0cy5hcHBlbmRGaWxlID0gZnMuYXBwZW5kRmlsZQpleHBvcnRzLmNobW9kID0gZnMuY2htb2QKZXhwb3J0cy5jb25zdGFudHMgPSBmcy5jb25zdGFudHMKZXhwb3J0cy5jb3B5RmlsZSA9IGZzLmNvcHlGaWxlCmV4cG9ydHMuY3AgPSBmcy5jcApleHBvcnRzLmxzdGF0ID0gZnMubHN0YXQKZXhwb3J0cy5ta2RpciA9IGZzLm1rZGlyCmV4cG9ydHMub3BlbmRpciA9IGZzLm9wZW5kaXIKZXhwb3J0cy5yZWFkRmlsZSA9IGZzLnJlYWRGaWxlCmV4cG9ydHMucmVhZGRpciA9IGZzLnJlYWRkaXIKZXhwb3J0cy5yZWFkbGluayA9IGZzLnJlYWRsaW5rCmV4cG9ydHMucmVhbHBhdGggPSBmcy5yZWFscGF0aApleHBvcnRzLnJlbmFtZSA9IGZzLnJlbmFtZQpleHBvcnRzLnJtID0gZnMucm0KZXhwb3J0cy5ybWRpciA9IGZzLnJtZGlyCmV4cG9ydHMuc3RhdCA9IGZzLnN0YXQKZXhwb3J0cy5zeW1saW5rID0gZnMuc3ltbGluawpleHBvcnRzLnVubGluayA9IGZzLnVubGluawpleHBvcnRzLnV0aW1lcyA9IGZzLnV0aW1lcwpleHBvcnRzLndhdGNoID0gZnMud2F0Y2gKZXhwb3J0cy53cml0ZUZpbGUgPSBmcy53cml0ZUZpbGUKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCkKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4vYmluZGluZycpCmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4vbGliL2Vycm9ycycpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vbGliL2NvbnN0YW50cycpCgpleHBvcnRzLmNvbnN0YW50cyA9IGNvbnN0YW50cwoKZXhwb3J0cy5FT0wgPSBiaW5kaW5nLnBsYXRmb3JtID09PSAnd2luMzInID8gJ1xyXG4nIDogJ1xuJwoKZXhwb3J0cy5wbGF0Zm9ybSA9IGZ1bmN0aW9uIHBsYXRmb3JtKCkgewogIHJldHVybiBiaW5kaW5nLnBsYXRmb3JtCn0KCmV4cG9ydHMuYXJjaCA9IGZ1bmN0aW9uIGFyY2goKSB7CiAgcmV0dXJuIGJpbmRpbmcuYXJjaAp9CgpleHBvcnRzLnR5cGUgPSBiaW5kaW5nLnR5cGUKZXhwb3J0cy52ZXJzaW9uID0gYmluZGluZy52ZXJzaW9uCmV4cG9ydHMucmVsZWFzZSA9IGJpbmRpbmcucmVsZWFzZQpleHBvcnRzLm1hY2hpbmUgPSBiaW5kaW5nLm1hY2hpbmUKZXhwb3J0cy5leGVjUGF0aCA9IGJpbmRpbmcuZXhlY1BhdGgKZXhwb3J0cy5waWQgPSBiaW5kaW5nLnBpZApleHBvcnRzLnBwaWQgPSBiaW5kaW5nLnBwaWQKZXhwb3J0cy5jd2QgPSBiaW5kaW5nLmN3ZApleHBvcnRzLmNoZGlyID0gYmluZGluZy5jaGRpcgpleHBvcnRzLnRtcGRpciA9IGJpbmRpbmcudG1wZGlyCmV4cG9ydHMuaG9tZWRpciA9IGJpbmRpbmcuaG9tZWRpcgpleHBvcnRzLmhvc3RuYW1lID0gYmluZGluZy5ob3N0bmFtZQpleHBvcnRzLnVzZXJJbmZvID0gYmluZGluZy51c2VySW5mbwoKZXhwb3J0cy5raWxsID0gZnVuY3Rpb24ga2lsbChwaWQsIHNpZ25hbCA9IGNvbnN0YW50cy5zaWduYWxzLlNJR1RFUk0pIHsKICBpZiAodHlwZW9mIHNpZ25hbCA9PT0gJ3N0cmluZycpIHsKICAgIGlmIChzaWduYWwgaW4gY29uc3RhbnRzLnNpZ25hbHMgPT09IGZhbHNlKSB7CiAgICAgIHRocm93IGVycm9ycy5VTktOT1dOX1NJR05BTCgnVW5rbm93biBzaWduYWw6ICcgKyBzaWduYWwpCiAgICB9CgogICAgc2lnbmFsID0gY29uc3RhbnRzLnNpZ25hbHNbc2lnbmFsXQogIH0KCiAgYmluZGluZy5raWxsKHBpZCwgc2lnbmFsKQp9CgpleHBvcnRzLmVuZGlhbm5lc3MgPSBmdW5jdGlvbiBlbmRpYW5uZXNzKCkgewogIHJldHVybiBiaW5kaW5nLmlzTGl0dGxlRW5kaWFuID8gJ0xFJyA6ICdCRScKfQoKZXhwb3J0cy5hdmFpbGFibGVQYXJhbGxlbGlzbSA9IGJpbmRpbmcuYXZhaWxhYmxlUGFyYWxsZWxpc20KCmV4cG9ydHMuY3B1VXNhZ2UgPSBmdW5jdGlvbiBjcHVVc2FnZShwcmV2aW91cykgewogIGNvbnN0IGN1cnJlbnQgPSBiaW5kaW5nLmNwdVVzYWdlKCkKCiAgaWYgKHByZXZpb3VzKSB7CiAgICByZXR1cm4gewogICAgICB1c2VyOiBjdXJyZW50LnVzZXIgLSBwcmV2aW91cy51c2VyLAogICAgICBzeXN0ZW06IGN1cnJlbnQuc3lzdGVtIC0gcHJldmlvdXMuc3lzdGVtCiAgICB9CiAgfQoKICByZXR1cm4gY3VycmVudAp9CgpleHBvcnRzLnRocmVhZENwdVVzYWdlID0gZnVuY3Rpb24gdGhyZWFkQ3B1VXNhZ2UocHJldmlvdXMpIHsKICBjb25zdCBjdXJyZW50ID0gYmluZGluZy50aHJlYWRDcHVVc2FnZSgpCgogIGlmIChwcmV2aW91cykgewogICAgcmV0dXJuIHsKICAgICAgdXNlcjogY3VycmVudC51c2VyIC0gcHJldmlvdXMudXNlciwKICAgICAgc3lzdGVtOiBjdXJyZW50LnN5c3RlbSAtIHByZXZpb3VzLnN5c3RlbQogICAgfQogIH0KCiAgcmV0dXJuIGN1cnJlbnQKfQoKZXhwb3J0cy5yZXNvdXJjZVVzYWdlID0gYmluZGluZy5yZXNvdXJjZVVzYWdlCmV4cG9ydHMubWVtb3J5VXNhZ2UgPSBiaW5kaW5nLm1lbW9yeVVzYWdlCmV4cG9ydHMuZnJlZW1lbSA9IGJpbmRpbmcuZnJlZW1lbQpleHBvcnRzLnRvdGFsbWVtID0gYmluZGluZy50b3RhbG1lbQpleHBvcnRzLnVwdGltZSA9IGJpbmRpbmcudXB0aW1lCmV4cG9ydHMubG9hZGF2ZyA9IGJpbmRpbmcubG9hZGF2ZwpleHBvcnRzLmNwdXMgPSBiaW5kaW5nLmNwdXMKCmV4cG9ydHMuZ2V0UHJvY2Vzc1RpdGxlID0gYmluZGluZy5nZXRQcm9jZXNzVGl0bGUKCmV4cG9ydHMuc2V0UHJvY2Vzc1RpdGxlID0gZnVuY3Rpb24gc2V0UHJvY2Vzc1RpdGxlKHRpdGxlKSB7CiAgaWYgKHR5cGVvZiB0aXRsZSAhPT0gJ3N0cmluZycpIHRpdGxlID0gdGl0bGUudG9TdHJpbmcoKQoKICBpZiAodGl0bGUubGVuZ3RoID49IDI1NikgewogICAgdGhyb3cgZXJyb3JzLlRJVExFX09WRVJGTE9XKCdQcm9jZXNzIHRpdGxlIGlzIHRvbyBsb25nJykKICB9CgogIGJpbmRpbmcuc2V0UHJvY2Vzc1RpdGxlKHRpdGxlKQp9CgpleHBvcnRzLmdldEVudktleXMgPSBiaW5kaW5nLmdldEVudktleXMKZXhwb3J0cy5nZXRFbnYgPSBiaW5kaW5nLmdldEVudgpleHBvcnRzLmhhc0VudiA9IGJpbmRpbmcuaGFzRW52CmV4cG9ydHMuc2V0RW52ID0gYmluZGluZy5zZXRFbnYKZXhwb3J0cy51bnNldEVudiA9IGJpbmRpbmcudW5zZXRFbnYKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgc2lnbmFsczogYmluZGluZy5zaWduYWxzLAogIGVycm5vczogYmluZGluZy5lcnJub3MKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIE9TRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobXNnLCBjb2RlLCBmbiA9IE9TRXJyb3IpIHsKICAgIHN1cGVyKGAke2NvZGV9OiAke21zZ31gKQogICAgdGhpcy5jb2RlID0gY29kZQoKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBmbikKICAgIH0KICB9CgogIGdldCBuYW1lKCkgewogICAgcmV0dXJuICdPU0Vycm9yJwogIH0KCiAgc3RhdGljIFVOS05PV05fU0lHTkFMKG1zZykgewogICAgcmV0dXJuIG5ldyBPU0Vycm9yKG1zZywgJ1VOS05PV05fU0lHTkFMJywgT1NFcnJvci5VTktOT1dOX1NJR05BTCkKICB9CgogIHN0YXRpYyBUSVRMRV9PVkVSRkxPVyhtc2cpIHsKICAgIHJldHVybiBuZXcgT1NFcnJvcihtc2csICdUSVRMRV9PVkVSRkxPVycsIE9TRXJyb3IuVElUTEVfT1ZFUkZMT1cpCiAgfQp9CnsKICAibmFtZSI6ICJiYXJlLW9zIiwKICAidmVyc2lvbiI6ICIzLjYuMiIsCiAgImRlc2NyaXB0aW9uIjogIk9wZXJhdGluZyBzeXN0ZW0gdXRpbGl0aWVzIGZvciBKYXZhc2NyaXB0IiwKICAiZXhwb3J0cyI6IHsKICAgICIuIjogewogICAgICAidHlwZXMiOiAiLi9pbmRleC5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9pbmRleC5qcyIKICAgIH0sCiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuL2NvbnN0YW50cyI6ICIuL2xpYi9jb25zdGFudHMuanMiLAogICAgIi4vZXJyb3JzIjogIi4vbGliL2Vycm9ycy5qcyIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiaW5kZXguZC50cyIsCiAgICAiYmluZGluZy5jIiwKICAgICJiaW5kaW5nLmpzIiwKICAgICJDTWFrZUxpc3RzLnR4dCIsCiAgICAibGliIiwKICAgICJwcmVidWlsZHMiCiAgXSwKICAiYWRkb24iOiB0cnVlLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJhcmUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLW9zLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtb3MvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLW9zI3JlYWRtZSIsCiAgImVuZ2luZXMiOiB7CiAgICAiYmFyZSI6ICI+PTEuMTQuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4xLjEiLAogICAgImNtYWtlLWJhcmUiOiAiXjEuMS42IiwKICAgICJwcmV0dGllciI6ICJeMy40LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1zdGFuZGFyZCI6ICJeNy4wLjAiCiAgfQp9Ci8qIGdsb2JhbCBCYXJlICovCgovLyBUaGlzIGV4cG9ydCBTSE9VTEQgTk9UIGJlIHNob3J0ZW5lZCBpbiBhbnkgd2F5IGFzIGhhdmluZyB0aGUgZnVsbAovLyBgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKC4uLilgIHN0YXRlbWVudCBpcyBjcnVjaWFsIGZvciBzeW50aGVzaXppbmcKLy8gRVNNIGV4cG9ydHMuCgppZiAoQmFyZS5wbGF0Zm9ybSA9PT0gJ3dpbjMyJykgewogIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi9saWIvd2luMzInKQp9IGVsc2UgewogIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi9saWIvcG9zaXgnKQp9Cm1vZHVsZS5leHBvcnRzID0gewogIENIQVJfVVBQRVJDQVNFX0E6IDB4NDEsCiAgQ0hBUl9MT1dFUkNBU0VfQTogMHg2MSwKICBDSEFSX1VQUEVSQ0FTRV9aOiAweDVhLAogIENIQVJfTE9XRVJDQVNFX1o6IDB4N2EsCiAgQ0hBUl9ET1Q6IDB4MmUsCiAgQ0hBUl9GT1JXQVJEX1NMQVNIOiAweDJmLAogIENIQVJfQkFDS1dBUkRfU0xBU0g6IDB4NWMsCiAgQ0hBUl9DT0xPTjogMHgzYSwKICBDSEFSX1FVRVNUSU9OX01BUks6IDB4M2YKfQpjb25zdCBvcyA9IHJlcXVpcmUoJ2JhcmUtb3MnKQoKY29uc3QgeyBub3JtYWxpemVTdHJpbmcgfSA9IHJlcXVpcmUoJy4vc2hhcmVkJykKY29uc3QgewogIENIQVJfRE9ULAogIENIQVJfRk9SV0FSRF9TTEFTSAp9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKZnVuY3Rpb24gaXNQb3NpeFBhdGhTZXBhcmF0b3IgKGNvZGUpIHsKICByZXR1cm4gY29kZSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNICn0KCmV4cG9ydHMud2luMzIgPSByZXF1aXJlKCcuL3dpbjMyJykKZXhwb3J0cy5wb3NpeCA9IGV4cG9ydHMKCmV4cG9ydHMuc2VwID0gJy8nCmV4cG9ydHMuZGVsaW1pdGVyID0gJzonCgpleHBvcnRzLnJlc29sdmUgPSBmdW5jdGlvbiByZXNvbHZlICguLi5hcmdzKSB7CiAgbGV0IHJlc29sdmVkUGF0aCA9ICcnCiAgbGV0IHJlc29sdmVkQWJzb2x1dGUgPSBmYWxzZQoKICBmb3IgKGxldCBpID0gYXJncy5sZW5ndGggLSAxOyBpID49IC0xICYmICFyZXNvbHZlZEFic29sdXRlOyBpLS0pIHsKICAgIGNvbnN0IHBhdGggPSBpID49IDAgPyBhcmdzW2ldIDogb3MuY3dkKCkKCiAgICBpZiAocGF0aC5sZW5ndGggPT09IDApIHsKICAgICAgY29udGludWUKICAgIH0KCiAgICByZXNvbHZlZFBhdGggPSBgJHtwYXRofS8ke3Jlc29sdmVkUGF0aH1gCiAgICByZXNvbHZlZEFic29sdXRlID0gcGF0aC5jaGFyQ29kZUF0KDApID09PSBDSEFSX0ZPUldBUkRfU0xBU0gKICB9CgogIHJlc29sdmVkUGF0aCA9IG5vcm1hbGl6ZVN0cmluZyhyZXNvbHZlZFBhdGgsICFyZXNvbHZlZEFic29sdXRlLCAnLycsIGlzUG9zaXhQYXRoU2VwYXJhdG9yKQoKICBpZiAocmVzb2x2ZWRBYnNvbHV0ZSkgewogICAgcmV0dXJuIGAvJHtyZXNvbHZlZFBhdGh9YAogIH0KCiAgcmV0dXJuIHJlc29sdmVkUGF0aC5sZW5ndGggPiAwID8gcmVzb2x2ZWRQYXRoIDogJy4nCn0KCmV4cG9ydHMubm9ybWFsaXplID0gZnVuY3Rpb24gbm9ybWFsaXplIChwYXRoKSB7CiAgaWYgKHBhdGgubGVuZ3RoID09PSAwKSByZXR1cm4gJy4nCgogIGNvbnN0IGlzQWJzb2x1dGUgPSBwYXRoLmNoYXJDb2RlQXQoMCkgPT09IENIQVJfRk9SV0FSRF9TTEFTSAogIGNvbnN0IHRyYWlsaW5nU2VwYXJhdG9yID0gcGF0aC5jaGFyQ29kZUF0KHBhdGgubGVuZ3RoIC0gMSkgPT09IENIQVJfRk9SV0FSRF9TTEFTSAoKICBwYXRoID0gbm9ybWFsaXplU3RyaW5nKHBhdGgsICFpc0Fic29sdXRlLCAnLycsIGlzUG9zaXhQYXRoU2VwYXJhdG9yKQoKICBpZiAocGF0aC5sZW5ndGggPT09IDApIHsKICAgIGlmIChpc0Fic29sdXRlKSByZXR1cm4gJy8nCiAgICByZXR1cm4gdHJhaWxpbmdTZXBhcmF0b3IgPyAnLi8nIDogJy4nCiAgfQoKICBpZiAodHJhaWxpbmdTZXBhcmF0b3IpIHBhdGggKz0gJy8nCgogIHJldHVybiBpc0Fic29sdXRlID8gYC8ke3BhdGh9YCA6IHBhdGgKfQoKZXhwb3J0cy5pc0Fic29sdXRlID0gZnVuY3Rpb24gaXNBYnNvbHV0ZSAocGF0aCkgewogIHJldHVybiBwYXRoLmxlbmd0aCA+IDAgJiYgcGF0aC5jaGFyQ29kZUF0KDApID09PSBDSEFSX0ZPUldBUkRfU0xBU0gKfQoKZXhwb3J0cy5qb2luID0gZnVuY3Rpb24gam9pbiAoLi4uYXJncykgewogIGlmIChhcmdzLmxlbmd0aCA9PT0gMCkgcmV0dXJuICcuJwogIGxldCBqb2luZWQKICBmb3IgKGxldCBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyArK2kpIHsKICAgIGNvbnN0IGFyZyA9IGFyZ3NbaV0KICAgIGlmIChhcmcubGVuZ3RoID4gMCkgewogICAgICBpZiAoam9pbmVkID09PSB1bmRlZmluZWQpIGpvaW5lZCA9IGFyZwogICAgICBlbHNlIGpvaW5lZCArPSBgLyR7YXJnfWAKICAgIH0KICB9CiAgaWYgKGpvaW5lZCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gJy4nCiAgcmV0dXJuIGV4cG9ydHMubm9ybWFsaXplKGpvaW5lZCkKfQoKZXhwb3J0cy5yZWxhdGl2ZSA9IGZ1bmN0aW9uIHJlbGF0aXZlIChmcm9tLCB0bykgewogIGlmIChmcm9tID09PSB0bykgcmV0dXJuICcnCgogIGZyb20gPSBleHBvcnRzLnJlc29sdmUoZnJvbSkKICB0byA9IGV4cG9ydHMucmVzb2x2ZSh0bykKCiAgaWYgKGZyb20gPT09IHRvKSByZXR1cm4gJycKCiAgY29uc3QgZnJvbVN0YXJ0ID0gMQogIGNvbnN0IGZyb21FbmQgPSBmcm9tLmxlbmd0aAogIGNvbnN0IGZyb21MZW4gPSBmcm9tRW5kIC0gZnJvbVN0YXJ0CiAgY29uc3QgdG9TdGFydCA9IDEKICBjb25zdCB0b0xlbiA9IHRvLmxlbmd0aCAtIHRvU3RhcnQKCiAgY29uc3QgbGVuZ3RoID0gKGZyb21MZW4gPCB0b0xlbiA/IGZyb21MZW4gOiB0b0xlbikKICBsZXQgbGFzdENvbW1vblNlcCA9IC0xCiAgbGV0IGkgPSAwCiAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgY29uc3QgZnJvbUNvZGUgPSBmcm9tLmNoYXJDb2RlQXQoZnJvbVN0YXJ0ICsgaSkKICAgIGlmIChmcm9tQ29kZSAhPT0gdG8uY2hhckNvZGVBdCh0b1N0YXJ0ICsgaSkpIHsKICAgICAgYnJlYWsKICAgIH0gZWxzZSBpZiAoZnJvbUNvZGUgPT09IENIQVJfRk9SV0FSRF9TTEFTSCkgewogICAgICBsYXN0Q29tbW9uU2VwID0gaQogICAgfQogIH0KICBpZiAoaSA9PT0gbGVuZ3RoKSB7CiAgICBpZiAodG9MZW4gPiBsZW5ndGgpIHsKICAgICAgaWYgKHRvLmNoYXJDb2RlQXQodG9TdGFydCArIGkpID09PSBDSEFSX0ZPUldBUkRfU0xBU0gpIHsKICAgICAgICByZXR1cm4gdG8uc3Vic3RyaW5nKHRvU3RhcnQgKyBpICsgMSkKICAgICAgfQogICAgICBpZiAoaSA9PT0gMCkgewogICAgICAgIHJldHVybiB0by5zdWJzdHJpbmcodG9TdGFydCArIGkpCiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZnJvbUxlbiA+IGxlbmd0aCkgewogICAgICBpZiAoZnJvbS5jaGFyQ29kZUF0KGZyb21TdGFydCArIGkpID09PSBDSEFSX0ZPUldBUkRfU0xBU0gpIHsKICAgICAgICBsYXN0Q29tbW9uU2VwID0gaQogICAgICB9IGVsc2UgaWYgKGkgPT09IDApIHsKICAgICAgICBsYXN0Q29tbW9uU2VwID0gMAogICAgICB9CiAgICB9CiAgfQoKICBsZXQgb3V0ID0gJycKICBmb3IgKGkgPSBmcm9tU3RhcnQgKyBsYXN0Q29tbW9uU2VwICsgMTsgaSA8PSBmcm9tRW5kOyArK2kpIHsKICAgIGlmIChpID09PSBmcm9tRW5kIHx8IGZyb20uY2hhckNvZGVBdChpKSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNIKSB7CiAgICAgIG91dCArPSBvdXQubGVuZ3RoID09PSAwID8gJy4uJyA6ICcvLi4nCiAgICB9CiAgfQoKICByZXR1cm4gYCR7b3V0fSR7dG8uc3Vic3RyaW5nKHRvU3RhcnQgKyBsYXN0Q29tbW9uU2VwKX1gCn0KCmV4cG9ydHMudG9OYW1lc3BhY2VkUGF0aCA9IGZ1bmN0aW9uIHRvTmFtZXNwYWNlZFBhdGggKHBhdGgpIHsKICByZXR1cm4gcGF0aAp9CgpleHBvcnRzLmRpcm5hbWUgPSBmdW5jdGlvbiBkaXJuYW1lIChwYXRoKSB7CiAgaWYgKHBhdGgubGVuZ3RoID09PSAwKSByZXR1cm4gJy4nCiAgY29uc3QgaGFzUm9vdCA9IHBhdGguY2hhckNvZGVBdCgwKSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNICiAgbGV0IGVuZCA9IC0xCiAgbGV0IG1hdGNoZWRTbGFzaCA9IHRydWUKICBmb3IgKGxldCBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDE7IC0taSkgewogICAgaWYgKHBhdGguY2hhckNvZGVBdChpKSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNIKSB7CiAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgZW5kID0gaQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIG1hdGNoZWRTbGFzaCA9IGZhbHNlCiAgICB9CiAgfQoKICBpZiAoZW5kID09PSAtMSkgcmV0dXJuIGhhc1Jvb3QgPyAnLycgOiAnLicKICBpZiAoaGFzUm9vdCAmJiBlbmQgPT09IDEpIHJldHVybiAnLy8nCiAgcmV0dXJuIHBhdGguc3Vic3RyaW5nKDAsIGVuZCkKfQoKZXhwb3J0cy5iYXNlbmFtZSA9IGZ1bmN0aW9uIGJhc2VuYW1lIChwYXRoLCBzdWZmaXgpIHsKICBsZXQgc3RhcnQgPSAwCiAgbGV0IGVuZCA9IC0xCiAgbGV0IG1hdGNoZWRTbGFzaCA9IHRydWUKCiAgaWYgKHN1ZmZpeCAhPT0gdW5kZWZpbmVkICYmIHN1ZmZpeC5sZW5ndGggPiAwICYmIHN1ZmZpeC5sZW5ndGggPD0gcGF0aC5sZW5ndGgpIHsKICAgIGlmIChzdWZmaXggPT09IHBhdGgpIHsgcmV0dXJuICcnIH0KICAgIGxldCBleHRJZHggPSBzdWZmaXgubGVuZ3RoIC0gMQogICAgbGV0IGZpcnN0Tm9uU2xhc2hFbmQgPSAtMQogICAgZm9yIChsZXQgaSA9IHBhdGgubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgY29uc3QgY29kZSA9IHBhdGguY2hhckNvZGVBdChpKQogICAgICBpZiAoY29kZSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNIKSB7CiAgICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICAgIHN0YXJ0ID0gaSArIDEKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChmaXJzdE5vblNsYXNoRW5kID09PSAtMSkgewogICAgICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2UKICAgICAgICAgIGZpcnN0Tm9uU2xhc2hFbmQgPSBpICsgMQogICAgICAgIH0KICAgICAgICBpZiAoZXh0SWR4ID49IDApIHsKICAgICAgICAgIGlmIChjb2RlID09PSBzdWZmaXguY2hhckNvZGVBdChleHRJZHgpKSB7CiAgICAgICAgICAgIGlmICgtLWV4dElkeCA9PT0gLTEpIHsKICAgICAgICAgICAgICBlbmQgPSBpCiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4dElkeCA9IC0xCiAgICAgICAgICAgIGVuZCA9IGZpcnN0Tm9uU2xhc2hFbmQKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAoc3RhcnQgPT09IGVuZCkgZW5kID0gZmlyc3ROb25TbGFzaEVuZAogICAgZWxzZSBpZiAoZW5kID09PSAtMSkgZW5kID0gcGF0aC5sZW5ndGgKICAgIHJldHVybiBwYXRoLnN1YnN0cmluZyhzdGFydCwgZW5kKQogIH0KCiAgZm9yIChsZXQgaSA9IHBhdGgubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgIGlmIChwYXRoLmNoYXJDb2RlQXQoaSkgPT09IENIQVJfRk9SV0FSRF9TTEFTSCkgewogICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgIHN0YXJ0ID0gaSArIDEKICAgICAgICBicmVhawogICAgICB9CiAgICB9IGVsc2UgaWYgKGVuZCA9PT0gLTEpIHsKICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2UKICAgICAgZW5kID0gaSArIDEKICAgIH0KICB9CgogIGlmIChlbmQgPT09IC0xKSByZXR1cm4gJycKICByZXR1cm4gcGF0aC5zdWJzdHJpbmcoc3RhcnQsIGVuZCkKfQoKZXhwb3J0cy5leHRuYW1lID0gZnVuY3Rpb24gZXh0bmFtZSAocGF0aCkgewogIGxldCBzdGFydERvdCA9IC0xCiAgbGV0IHN0YXJ0UGFydCA9IDAKICBsZXQgZW5kID0gLTEKICBsZXQgbWF0Y2hlZFNsYXNoID0gdHJ1ZQogIGxldCBwcmVEb3RTdGF0ZSA9IDAKICBmb3IgKGxldCBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgY29uc3QgY29kZSA9IHBhdGguY2hhckNvZGVBdChpKQogICAgaWYgKGNvZGUgPT09IENIQVJfRk9SV0FSRF9TTEFTSCkgewogICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgIHN0YXJ0UGFydCA9IGkgKyAxCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgICBjb250aW51ZQogICAgfQogICAgaWYgKGVuZCA9PT0gLTEpIHsKICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2UKICAgICAgZW5kID0gaSArIDEKICAgIH0KICAgIGlmIChjb2RlID09PSBDSEFSX0RPVCkgewogICAgICBpZiAoc3RhcnREb3QgPT09IC0xKSBzdGFydERvdCA9IGkKICAgICAgZWxzZSBpZiAocHJlRG90U3RhdGUgIT09IDEpIHByZURvdFN0YXRlID0gMQogICAgfSBlbHNlIGlmIChzdGFydERvdCAhPT0gLTEpIHsKICAgICAgcHJlRG90U3RhdGUgPSAtMQogICAgfQogIH0KCiAgaWYgKHN0YXJ0RG90ID09PSAtMSB8fCBlbmQgPT09IC0xIHx8IHByZURvdFN0YXRlID09PSAwIHx8IChwcmVEb3RTdGF0ZSA9PT0gMSAmJiBzdGFydERvdCA9PT0gZW5kIC0gMSAmJiBzdGFydERvdCA9PT0gc3RhcnRQYXJ0ICsgMSkpIHsKICAgIHJldHVybiAnJwogIH0KICByZXR1cm4gcGF0aC5zdWJzdHJpbmcoc3RhcnREb3QsIGVuZCkKfQpjb25zdCB7CiAgQ0hBUl9ET1QsCiAgQ0hBUl9GT1JXQVJEX1NMQVNICn0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgpleHBvcnRzLm5vcm1hbGl6ZVN0cmluZyA9IGZ1bmN0aW9uIG5vcm1hbGl6ZVN0cmluZyAocGF0aCwgYWxsb3dBYm92ZVJvb3QsIHNlcGFyYXRvciwgaXNQYXRoU2VwYXJhdG9yKSB7CiAgbGV0IHJlcyA9ICcnCiAgbGV0IGxhc3RTZWdtZW50TGVuZ3RoID0gMAogIGxldCBsYXN0U2xhc2ggPSAtMQogIGxldCBkb3RzID0gMAogIGxldCBjb2RlID0gMAogIGZvciAobGV0IGkgPSAwOyBpIDw9IHBhdGgubGVuZ3RoOyArK2kpIHsKICAgIGlmIChpIDwgcGF0aC5sZW5ndGgpIHsKICAgICAgY29kZSA9IHBhdGguY2hhckNvZGVBdChpKQogICAgfSBlbHNlIGlmIChpc1BhdGhTZXBhcmF0b3IoY29kZSkpIHsKICAgICAgYnJlYWsKICAgIH0gZWxzZSB7CiAgICAgIGNvZGUgPSBDSEFSX0ZPUldBUkRfU0xBU0gKICAgIH0KCiAgICBpZiAoaXNQYXRoU2VwYXJhdG9yKGNvZGUpKSB7CiAgICAgIGlmIChsYXN0U2xhc2ggPT09IGkgLSAxIHx8IGRvdHMgPT09IDEpIDsKICAgICAgZWxzZSBpZiAoZG90cyA9PT0gMikgewogICAgICAgIGlmIChyZXMubGVuZ3RoIDwgMiB8fCBsYXN0U2VnbWVudExlbmd0aCAhPT0gMiB8fCByZXMuY2hhckNvZGVBdChyZXMubGVuZ3RoIC0gMSkgIT09IENIQVJfRE9UIHx8IHJlcy5jaGFyQ29kZUF0KHJlcy5sZW5ndGggLSAyKSAhPT0gQ0hBUl9ET1QpIHsKICAgICAgICAgIGlmIChyZXMubGVuZ3RoID4gMikgewogICAgICAgICAgICBjb25zdCBsYXN0U2xhc2hJbmRleCA9IHJlcy5sYXN0SW5kZXhPZihzZXBhcmF0b3IpCiAgICAgICAgICAgIGlmIChsYXN0U2xhc2hJbmRleCA9PT0gLTEpIHsKICAgICAgICAgICAgICByZXMgPSAnJwogICAgICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gMAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlcyA9IHJlcy5zdWJzdHJpbmcoMCwgbGFzdFNsYXNoSW5kZXgpCiAgICAgICAgICAgICAgbGFzdFNlZ21lbnRMZW5ndGggPQogICAgICAgICAgICAgICAgcmVzLmxlbmd0aCAtIDEgLSByZXMubGFzdEluZGV4T2Yoc2VwYXJhdG9yKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhc3RTbGFzaCA9IGkKICAgICAgICAgICAgZG90cyA9IDAKICAgICAgICAgICAgY29udGludWUKICAgICAgICAgIH0gZWxzZSBpZiAocmVzLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICByZXMgPSAnJwogICAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IDAKICAgICAgICAgICAgbGFzdFNsYXNoID0gaQogICAgICAgICAgICBkb3RzID0gMAogICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoYWxsb3dBYm92ZVJvb3QpIHsKICAgICAgICAgIHJlcyArPSByZXMubGVuZ3RoID4gMCA/IGAke3NlcGFyYXRvcn0uLmAgOiAnLi4nCiAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IDIKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHJlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICByZXMgKz0gYCR7c2VwYXJhdG9yfSR7cGF0aC5zdWJzdHJpbmcobGFzdFNsYXNoICsgMSwgaSl9YAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXMgPSBwYXRoLnN1YnN0cmluZyhsYXN0U2xhc2ggKyAxLCBpKQogICAgICAgIH0KICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IGkgLSBsYXN0U2xhc2ggLSAxCiAgICAgIH0KICAgICAgbGFzdFNsYXNoID0gaQogICAgICBkb3RzID0gMAogICAgfSBlbHNlIGlmIChjb2RlID09PSBDSEFSX0RPVCAmJiBkb3RzICE9PSAtMSkgewogICAgICArK2RvdHMKICAgIH0gZWxzZSB7CiAgICAgIGRvdHMgPSAtMQogICAgfQogIH0KICByZXR1cm4gcmVzCn0KY29uc3Qgb3MgPSByZXF1aXJlKCdiYXJlLW9zJykKCmNvbnN0IHsgbm9ybWFsaXplU3RyaW5nIH0gPSByZXF1aXJlKCcuL3NoYXJlZCcpCmNvbnN0IHsKICBDSEFSX1VQUEVSQ0FTRV9BLAogIENIQVJfTE9XRVJDQVNFX0EsCiAgQ0hBUl9VUFBFUkNBU0VfWiwKICBDSEFSX0xPV0VSQ0FTRV9aLAogIENIQVJfRE9ULAogIENIQVJfRk9SV0FSRF9TTEFTSCwKICBDSEFSX0JBQ0tXQVJEX1NMQVNILAogIENIQVJfQ09MT04sCiAgQ0hBUl9RVUVTVElPTl9NQVJLCn0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgpmdW5jdGlvbiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yIChjb2RlKSB7CiAgcmV0dXJuIGNvZGUgPT09IENIQVJfRk9SV0FSRF9TTEFTSCB8fCBjb2RlID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNICn0KCmZ1bmN0aW9uIGlzV2luZG93c0RldmljZVJvb3QgKGNvZGUpIHsKICByZXR1cm4gKGNvZGUgPj0gQ0hBUl9VUFBFUkNBU0VfQSAmJiBjb2RlIDw9IENIQVJfVVBQRVJDQVNFX1opIHx8CiAgICAgICAgIChjb2RlID49IENIQVJfTE9XRVJDQVNFX0EgJiYgY29kZSA8PSBDSEFSX0xPV0VSQ0FTRV9aKQp9CgpleHBvcnRzLnBvc2l4ID0gcmVxdWlyZSgnLi9wb3NpeCcpCmV4cG9ydHMud2luMzIgPSBleHBvcnRzCgpleHBvcnRzLnNlcCA9ICdcXCcKZXhwb3J0cy5kZWxpbWl0ZXIgPSAnOycKCmV4cG9ydHMucmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmUgKC4uLmFyZ3MpIHsKICBsZXQgcmVzb2x2ZWREZXZpY2UgPSAnJwogIGxldCByZXNvbHZlZFRhaWwgPSAnJwogIGxldCByZXNvbHZlZEFic29sdXRlID0gZmFsc2UKCiAgZm9yIChsZXQgaSA9IGFyZ3MubGVuZ3RoIC0gMTsgaSA+PSAtMTsgaS0tKSB7CiAgICBsZXQgcGF0aAogICAgaWYgKGkgPj0gMCkgewogICAgICBwYXRoID0gYXJnc1tpXQoKICAgICAgaWYgKHBhdGgubGVuZ3RoID09PSAwKSBjb250aW51ZQogICAgfSBlbHNlIGlmIChyZXNvbHZlZERldmljZS5sZW5ndGggPT09IDApIHsKICAgICAgcGF0aCA9IG9zLmN3ZCgpCiAgICB9IGVsc2UgewogICAgICBwYXRoID0gb3MuZ2V0RW52KGA9JHtyZXNvbHZlZERldmljZX1gKSB8fCBvcy5jd2QoKQoKICAgICAgaWYgKHBhdGggPT09IHVuZGVmaW5lZCB8fCAocGF0aC5zdWJzdHJpbmcoMCwgMikudG9Mb3dlckNhc2UoKSAhPT0gcmVzb2x2ZWREZXZpY2UudG9Mb3dlckNhc2UoKSAmJiBwYXRoLmNoYXJDb2RlQXQoMikgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpKSB7CiAgICAgICAgcGF0aCA9IGAke3Jlc29sdmVkRGV2aWNlfVxcYAogICAgICB9CiAgICB9CgogICAgY29uc3QgbGVuID0gcGF0aC5sZW5ndGgKICAgIGxldCByb290RW5kID0gMAogICAgbGV0IGRldmljZSA9ICcnCiAgICBsZXQgaXNBYnNvbHV0ZSA9IGZhbHNlCiAgICBjb25zdCBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KDApCgogICAgaWYgKGxlbiA9PT0gMSkgewogICAgICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihjb2RlKSkgewogICAgICAgIHJvb3RFbmQgPSAxCiAgICAgICAgaXNBYnNvbHV0ZSA9IHRydWUKICAgICAgfQogICAgfSBlbHNlIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGNvZGUpKSB7CiAgICAgIGlzQWJzb2x1dGUgPSB0cnVlCgogICAgICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoMSkpKSB7CiAgICAgICAgbGV0IGogPSAyCiAgICAgICAgbGV0IGxhc3QgPSBqCiAgICAgICAgd2hpbGUgKGogPCBsZW4gJiYgIWlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGopKSkgewogICAgICAgICAgaisrCiAgICAgICAgfQogICAgICAgIGlmIChqIDwgbGVuICYmIGogIT09IGxhc3QpIHsKICAgICAgICAgIGNvbnN0IGZpcnN0UGFydCA9IHBhdGguc3Vic3RyaW5nKGxhc3QsIGopCiAgICAgICAgICBsYXN0ID0gagogICAgICAgICAgd2hpbGUgKGogPCBsZW4gJiYgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaikpKSB7CiAgICAgICAgICAgIGorKwogICAgICAgICAgfQogICAgICAgICAgaWYgKGogPCBsZW4gJiYgaiAhPT0gbGFzdCkgewogICAgICAgICAgICBsYXN0ID0gagogICAgICAgICAgICB3aGlsZSAoaiA8IGxlbiAmJiAhaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaikpKSB7CiAgICAgICAgICAgICAgaisrCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGogPT09IGxlbiB8fCBqICE9PSBsYXN0KSB7CiAgICAgICAgICAgICAgZGV2aWNlID0gYFxcXFwke2ZpcnN0UGFydH1cXCR7cGF0aC5zdWJzdHJpbmcobGFzdCwgail9YAogICAgICAgICAgICAgIHJvb3RFbmQgPSBqCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcm9vdEVuZCA9IDEKICAgICAgfQogICAgfSBlbHNlIGlmIChpc1dpbmRvd3NEZXZpY2VSb290KGNvZGUpICYmIHBhdGguY2hhckNvZGVBdCgxKSA9PT0gQ0hBUl9DT0xPTikgewogICAgICBkZXZpY2UgPSBwYXRoLnN1YnN0cmluZygwLCAyKQogICAgICByb290RW5kID0gMgogICAgICBpZiAobGVuID4gMiAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdCgyKSkpIHsKICAgICAgICBpc0Fic29sdXRlID0gdHJ1ZQogICAgICAgIHJvb3RFbmQgPSAzCiAgICAgIH0KICAgIH0KCiAgICBpZiAoZGV2aWNlLmxlbmd0aCA+IDApIHsKICAgICAgaWYgKHJlc29sdmVkRGV2aWNlLmxlbmd0aCA+IDApIHsKICAgICAgICBpZiAoZGV2aWNlLnRvTG93ZXJDYXNlKCkgIT09IHJlc29sdmVkRGV2aWNlLnRvTG93ZXJDYXNlKCkpIHsgY29udGludWUgfQogICAgICB9IGVsc2UgewogICAgICAgIHJlc29sdmVkRGV2aWNlID0gZGV2aWNlCiAgICAgIH0KICAgIH0KCiAgICBpZiAocmVzb2x2ZWRBYnNvbHV0ZSkgewogICAgICBpZiAocmVzb2x2ZWREZXZpY2UubGVuZ3RoID4gMCkgeyBicmVhayB9CiAgICB9IGVsc2UgewogICAgICByZXNvbHZlZFRhaWwgPSBgJHtwYXRoLnN1YnN0cmluZyhyb290RW5kKX1cXCR7cmVzb2x2ZWRUYWlsfWAKICAgICAgcmVzb2x2ZWRBYnNvbHV0ZSA9IGlzQWJzb2x1dGUKICAgICAgaWYgKGlzQWJzb2x1dGUgJiYgcmVzb2x2ZWREZXZpY2UubGVuZ3RoID4gMCkgewogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KICB9CgogIHJlc29sdmVkVGFpbCA9IG5vcm1hbGl6ZVN0cmluZyhyZXNvbHZlZFRhaWwsICFyZXNvbHZlZEFic29sdXRlLCAnXFwnLCBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKQoKICByZXR1cm4gcmVzb2x2ZWRBYnNvbHV0ZSA/IGAke3Jlc29sdmVkRGV2aWNlfVxcJHtyZXNvbHZlZFRhaWx9YCA6IGAke3Jlc29sdmVkRGV2aWNlfSR7cmVzb2x2ZWRUYWlsfWAgfHwgJy4nCn0KCmV4cG9ydHMubm9ybWFsaXplID0gZnVuY3Rpb24gbm9ybWFsaXplIChwYXRoKSB7CiAgY29uc3QgbGVuID0gcGF0aC5sZW5ndGgKICBpZiAobGVuID09PSAwKSByZXR1cm4gJy4nCiAgbGV0IHJvb3RFbmQgPSAwCiAgbGV0IGRldmljZQogIGxldCBpc0Fic29sdXRlID0gZmFsc2UKICBjb25zdCBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KDApCgogIGlmIChsZW4gPT09IDEpIHsKICAgIHJldHVybiBjb2RlID09PSBDSEFSX0ZPUldBUkRfU0xBU0ggPyAnXFwnIDogcGF0aAogIH0KCiAgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IoY29kZSkpIHsKICAgIGlzQWJzb2x1dGUgPSB0cnVlCgogICAgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KDEpKSkgewogICAgICBsZXQgaiA9IDIKICAgICAgbGV0IGxhc3QgPSBqCiAgICAgIHdoaWxlIChqIDwgbGVuICYmICFpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChqKSkpIHsKICAgICAgICBqKysKICAgICAgfQogICAgICBpZiAoaiA8IGxlbiAmJiBqICE9PSBsYXN0KSB7CiAgICAgICAgY29uc3QgZmlyc3RQYXJ0ID0gcGF0aC5zdWJzdHJpbmcobGFzdCwgaikKICAgICAgICBsYXN0ID0gagogICAgICAgIHdoaWxlIChqIDwgbGVuICYmIGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGopKSkgewogICAgICAgICAgaisrCiAgICAgICAgfQogICAgICAgIGlmIChqIDwgbGVuICYmIGogIT09IGxhc3QpIHsKICAgICAgICAgIGxhc3QgPSBqCiAgICAgICAgICB3aGlsZSAoaiA8IGxlbiAmJiAhaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaikpKSB7CiAgICAgICAgICAgIGorKwogICAgICAgICAgfQogICAgICAgICAgaWYgKGogPT09IGxlbikgewogICAgICAgICAgICByZXR1cm4gYFxcXFwke2ZpcnN0UGFydH1cXCR7cGF0aC5zdWJzdHJpbmcobGFzdCl9XFxgCiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaiAhPT0gbGFzdCkgewogICAgICAgICAgICBkZXZpY2UgPSBgXFxcXCR7Zmlyc3RQYXJ0fVxcJHtwYXRoLnN1YnN0cmluZyhsYXN0LCBqKX1gCiAgICAgICAgICAgIHJvb3RFbmQgPSBqCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICByb290RW5kID0gMQogICAgfQogIH0gZWxzZSBpZiAoaXNXaW5kb3dzRGV2aWNlUm9vdChjb2RlKSAmJiBwYXRoLmNoYXJDb2RlQXQoMSkgPT09IENIQVJfQ09MT04pIHsKICAgIGRldmljZSA9IHBhdGguc3Vic3RyaW5nKDAsIDIpCiAgICByb290RW5kID0gMgogICAgaWYgKGxlbiA+IDIgJiYgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoMikpKSB7CiAgICAgIGlzQWJzb2x1dGUgPSB0cnVlCiAgICAgIHJvb3RFbmQgPSAzCiAgICB9CiAgfQoKICBsZXQgdGFpbCA9IHJvb3RFbmQgPCBsZW4gPyBub3JtYWxpemVTdHJpbmcocGF0aC5zdWJzdHJpbmcocm9vdEVuZCksICFpc0Fic29sdXRlLCAnXFwnLCBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKSA6ICcnCiAgaWYgKHRhaWwubGVuZ3RoID09PSAwICYmICFpc0Fic29sdXRlKSB7CiAgICB0YWlsID0gJy4nCiAgfQogIGlmICh0YWlsLmxlbmd0aCA+IDAgJiYgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQobGVuIC0gMSkpKSB7CiAgICB0YWlsICs9ICdcXCcKICB9CiAgaWYgKGRldmljZSA9PT0gdW5kZWZpbmVkKSB7CiAgICByZXR1cm4gaXNBYnNvbHV0ZSA/IGBcXCR7dGFpbH1gIDogdGFpbAogIH0KICByZXR1cm4gaXNBYnNvbHV0ZSA/IGAke2RldmljZX1cXCR7dGFpbH1gIDogYCR7ZGV2aWNlfSR7dGFpbH1gCn0KCmV4cG9ydHMuaXNBYnNvbHV0ZSA9IGZ1bmN0aW9uIGlzQWJzb2x1dGUgKHBhdGgpIHsKICBjb25zdCBsZW4gPSBwYXRoLmxlbmd0aAogIGlmIChsZW4gPT09IDApIHJldHVybiBmYWxzZQoKICBjb25zdCBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KDApCgogIHJldHVybiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGNvZGUpIHx8IChsZW4gPiAyICYmIGlzV2luZG93c0RldmljZVJvb3QoY29kZSkgJiYgcGF0aC5jaGFyQ29kZUF0KDEpID09PSBDSEFSX0NPTE9OICYmIGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KDIpKSkKfQoKZXhwb3J0cy5qb2luID0gZnVuY3Rpb24gam9pbiAoLi4uYXJncykgewogIGlmIChhcmdzLmxlbmd0aCA9PT0gMCkgcmV0dXJuICcuJwoKICBsZXQgam9pbmVkCiAgbGV0IGZpcnN0UGFydAogIGZvciAobGV0IGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7ICsraSkgewogICAgY29uc3QgYXJnID0gYXJnc1tpXQogICAgaWYgKGFyZy5sZW5ndGggPiAwKSB7CiAgICAgIGlmIChqb2luZWQgPT09IHVuZGVmaW5lZCkgam9pbmVkID0gZmlyc3RQYXJ0ID0gYXJnCiAgICAgIGVsc2Ugam9pbmVkICs9IGBcXCR7YXJnfWAKICAgIH0KICB9CgogIGlmIChqb2luZWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuICcuJwoKICBsZXQgbmVlZHNSZXBsYWNlID0gdHJ1ZQogIGxldCBzbGFzaENvdW50ID0gMAogIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGZpcnN0UGFydC5jaGFyQ29kZUF0KDApKSkgewogICAgKytzbGFzaENvdW50CiAgICBjb25zdCBmaXJzdExlbiA9IGZpcnN0UGFydC5sZW5ndGgKICAgIGlmIChmaXJzdExlbiA+IDEgJiYgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihmaXJzdFBhcnQuY2hhckNvZGVBdCgxKSkpIHsKICAgICAgKytzbGFzaENvdW50CiAgICAgIGlmIChmaXJzdExlbiA+IDIpIHsKICAgICAgICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihmaXJzdFBhcnQuY2hhckNvZGVBdCgyKSkpIHsKICAgICAgICAgICsrc2xhc2hDb3VudAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBuZWVkc1JlcGxhY2UgPSBmYWxzZQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICBpZiAobmVlZHNSZXBsYWNlKSB7CiAgICB3aGlsZSAoc2xhc2hDb3VudCA8IGpvaW5lZC5sZW5ndGggJiYgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihqb2luZWQuY2hhckNvZGVBdChzbGFzaENvdW50KSkpIHsKICAgICAgc2xhc2hDb3VudCsrCiAgICB9CgogICAgaWYgKHNsYXNoQ291bnQgPj0gMikgewogICAgICBqb2luZWQgPSBgXFwke2pvaW5lZC5zdWJzdHJpbmcoc2xhc2hDb3VudCl9YAogICAgfQogIH0KCiAgcmV0dXJuIGV4cG9ydHMubm9ybWFsaXplKGpvaW5lZCkKfQoKZXhwb3J0cy5yZWxhdGl2ZSA9IGZ1bmN0aW9uIHJlbGF0aXZlIChmcm9tLCB0bykgewogIGlmIChmcm9tID09PSB0bykgcmV0dXJuICcnCgogIGNvbnN0IGZyb21PcmlnID0gZXhwb3J0cy5yZXNvbHZlKGZyb20pCiAgY29uc3QgdG9PcmlnID0gZXhwb3J0cy5yZXNvbHZlKHRvKQoKICBpZiAoZnJvbU9yaWcgPT09IHRvT3JpZykgcmV0dXJuICcnCgogIGZyb20gPSBmcm9tT3JpZy50b0xvd2VyQ2FzZSgpCiAgdG8gPSB0b09yaWcudG9Mb3dlckNhc2UoKQoKICBpZiAoZnJvbSA9PT0gdG8pIHJldHVybiAnJwoKICBsZXQgZnJvbVN0YXJ0ID0gMAogIHdoaWxlIChmcm9tU3RhcnQgPCBmcm9tLmxlbmd0aCAmJiBmcm9tLmNoYXJDb2RlQXQoZnJvbVN0YXJ0KSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkgewogICAgZnJvbVN0YXJ0KysKICB9CiAgbGV0IGZyb21FbmQgPSBmcm9tLmxlbmd0aAogIHdoaWxlIChmcm9tRW5kIC0gMSA+IGZyb21TdGFydCAmJiBmcm9tLmNoYXJDb2RlQXQoZnJvbUVuZCAtIDEpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICBmcm9tRW5kLS0KICB9CiAgY29uc3QgZnJvbUxlbiA9IGZyb21FbmQgLSBmcm9tU3RhcnQKCiAgbGV0IHRvU3RhcnQgPSAwCiAgd2hpbGUgKHRvU3RhcnQgPCB0by5sZW5ndGggJiYgdG8uY2hhckNvZGVBdCh0b1N0YXJ0KSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkgewogICAgdG9TdGFydCsrCiAgfQogIGxldCB0b0VuZCA9IHRvLmxlbmd0aAogIHdoaWxlICh0b0VuZCAtIDEgPiB0b1N0YXJ0ICYmIHRvLmNoYXJDb2RlQXQodG9FbmQgLSAxKSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkgewogICAgdG9FbmQtLQogIH0KICBjb25zdCB0b0xlbiA9IHRvRW5kIC0gdG9TdGFydAoKICBjb25zdCBsZW5ndGggPSBmcm9tTGVuIDwgdG9MZW4gPyBmcm9tTGVuIDogdG9MZW4KICBsZXQgbGFzdENvbW1vblNlcCA9IC0xCiAgbGV0IGkgPSAwCiAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgY29uc3QgZnJvbUNvZGUgPSBmcm9tLmNoYXJDb2RlQXQoZnJvbVN0YXJ0ICsgaSkKICAgIGlmIChmcm9tQ29kZSAhPT0gdG8uY2hhckNvZGVBdCh0b1N0YXJ0ICsgaSkpIHsKICAgICAgYnJlYWsKICAgIH0gZWxzZSBpZiAoZnJvbUNvZGUgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpIHsKICAgICAgbGFzdENvbW1vblNlcCA9IGkKICAgIH0KICB9CgogIGlmIChpICE9PSBsZW5ndGgpIHsKICAgIGlmIChsYXN0Q29tbW9uU2VwID09PSAtMSkgcmV0dXJuIHRvT3JpZwogIH0gZWxzZSB7CiAgICBpZiAodG9MZW4gPiBsZW5ndGgpIHsKICAgICAgaWYgKHRvLmNoYXJDb2RlQXQodG9TdGFydCArIGkpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICAgICAgcmV0dXJuIHRvT3JpZy5zdWJzdHJpbmcodG9TdGFydCArIGkgKyAxKQogICAgICB9CiAgICAgIGlmIChpID09PSAyKSB7CiAgICAgICAgcmV0dXJuIHRvT3JpZy5zdWJzdHJpbmcodG9TdGFydCArIGkpCiAgICAgIH0KICAgIH0KICAgIGlmIChmcm9tTGVuID4gbGVuZ3RoKSB7CiAgICAgIGlmIChmcm9tLmNoYXJDb2RlQXQoZnJvbVN0YXJ0ICsgaSkgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpIHsKICAgICAgICBsYXN0Q29tbW9uU2VwID0gaQogICAgICB9IGVsc2UgaWYgKGkgPT09IDIpIHsKICAgICAgICBsYXN0Q29tbW9uU2VwID0gMwogICAgICB9CiAgICB9CiAgICBpZiAobGFzdENvbW1vblNlcCA9PT0gLTEpIGxhc3RDb21tb25TZXAgPSAwCiAgfQoKICBsZXQgb3V0ID0gJycKICBmb3IgKGkgPSBmcm9tU3RhcnQgKyBsYXN0Q29tbW9uU2VwICsgMTsgaSA8PSBmcm9tRW5kOyArK2kpIHsKICAgIGlmIChpID09PSBmcm9tRW5kIHx8IGZyb20uY2hhckNvZGVBdChpKSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkgewogICAgICBvdXQgKz0gb3V0Lmxlbmd0aCA9PT0gMCA/ICcuLicgOiAnXFwuLicKICAgIH0KICB9CgogIHRvU3RhcnQgKz0gbGFzdENvbW1vblNlcAoKICBpZiAob3V0Lmxlbmd0aCA+IDApIHsKICAgIHJldHVybiBgJHtvdXR9JHt0b09yaWcuc3Vic3RyaW5nKHRvU3RhcnQsIHRvRW5kKX1gCiAgfQogIGlmICh0b09yaWcuY2hhckNvZGVBdCh0b1N0YXJ0KSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkgewogICAgKyt0b1N0YXJ0CiAgfQogIHJldHVybiB0b09yaWcuc3Vic3RyaW5nKHRvU3RhcnQsIHRvRW5kKQp9CgpleHBvcnRzLnRvTmFtZXNwYWNlZFBhdGggPSBmdW5jdGlvbiB0b05hbWVzcGFjZWRQYXRoIChwYXRoKSB7CiAgaWYgKHBhdGgubGVuZ3RoID09PSAwKSByZXR1cm4gcGF0aAoKICBjb25zdCByZXNvbHZlZFBhdGggPSBleHBvcnRzLnJlc29sdmUocGF0aCkKCiAgaWYgKHJlc29sdmVkUGF0aC5sZW5ndGggPD0gMikgcmV0dXJuIHBhdGgKCiAgaWYgKHJlc29sdmVkUGF0aC5jaGFyQ29kZUF0KDApID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICBpZiAocmVzb2x2ZWRQYXRoLmNoYXJDb2RlQXQoMSkgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpIHsKICAgICAgY29uc3QgY29kZSA9IHJlc29sdmVkUGF0aC5jaGFyQ29kZUF0KDIpCiAgICAgIGlmIChjb2RlICE9PSBDSEFSX1FVRVNUSU9OX01BUksgJiYgY29kZSAhPT0gQ0hBUl9ET1QpIHsKICAgICAgICByZXR1cm4gYFxcXFw/XFxVTkNcXCR7cmVzb2x2ZWRQYXRoLnN1YnN0cmluZygyKX1gCiAgICAgIH0KICAgIH0KICB9IGVsc2UgaWYgKAogICAgaXNXaW5kb3dzRGV2aWNlUm9vdChyZXNvbHZlZFBhdGguY2hhckNvZGVBdCgwKSkgJiYKICAgICAgcmVzb2x2ZWRQYXRoLmNoYXJDb2RlQXQoMSkgPT09IENIQVJfQ09MT04gJiYKICAgICAgcmVzb2x2ZWRQYXRoLmNoYXJDb2RlQXQoMikgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gKICApIHsKICAgIHJldHVybiBgXFxcXD9cXCR7cmVzb2x2ZWRQYXRofWAKICB9CgogIHJldHVybiBwYXRoCn0KCmV4cG9ydHMuZGlybmFtZSA9IGZ1bmN0aW9uIGRpcm5hbWUgKHBhdGgpIHsKICBjb25zdCBsZW4gPSBwYXRoLmxlbmd0aAogIGlmIChsZW4gPT09IDApIHJldHVybiAnLicKICBsZXQgcm9vdEVuZCA9IC0xCiAgbGV0IG9mZnNldCA9IDAKICBjb25zdCBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KDApCgogIGlmIChsZW4gPT09IDEpIHsKICAgIHJldHVybiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGNvZGUpID8gcGF0aCA6ICcuJwogIH0KCiAgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IoY29kZSkpIHsKICAgIHJvb3RFbmQgPSBvZmZzZXQgPSAxCgogICAgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KDEpKSkgewogICAgICBsZXQgaiA9IDIKICAgICAgbGV0IGxhc3QgPSBqCiAgICAgIHdoaWxlIChqIDwgbGVuICYmICFpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChqKSkpIHsKICAgICAgICBqKysKICAgICAgfQogICAgICBpZiAoaiA8IGxlbiAmJiBqICE9PSBsYXN0KSB7CiAgICAgICAgbGFzdCA9IGoKICAgICAgICB3aGlsZSAoaiA8IGxlbiAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChqKSkpIHsKICAgICAgICAgIGorKwogICAgICAgIH0KICAgICAgICBpZiAoaiA8IGxlbiAmJiBqICE9PSBsYXN0KSB7CiAgICAgICAgICBsYXN0ID0gagogICAgICAgICAgd2hpbGUgKGogPCBsZW4gJiYgIWlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGopKSkgewogICAgICAgICAgICBqKysKICAgICAgICAgIH0KICAgICAgICAgIGlmIChqID09PSBsZW4pIHsKICAgICAgICAgICAgcmV0dXJuIHBhdGgKICAgICAgICAgIH0KICAgICAgICAgIGlmIChqICE9PSBsYXN0KSB7CiAgICAgICAgICAgIHJvb3RFbmQgPSBvZmZzZXQgPSBqICsgMQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0gZWxzZSBpZiAoaXNXaW5kb3dzRGV2aWNlUm9vdChjb2RlKSAmJiBwYXRoLmNoYXJDb2RlQXQoMSkgPT09IENIQVJfQ09MT04pIHsKICAgIHJvb3RFbmQgPSBsZW4gPiAyICYmIGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KDIpKSA/IDMgOiAyCiAgICBvZmZzZXQgPSByb290RW5kCiAgfQoKICBsZXQgZW5kID0gLTEKICBsZXQgbWF0Y2hlZFNsYXNoID0gdHJ1ZQogIGZvciAobGV0IGkgPSBsZW4gLSAxOyBpID49IG9mZnNldDsgLS1pKSB7CiAgICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaSkpKSB7CiAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgZW5kID0gaQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIG1hdGNoZWRTbGFzaCA9IGZhbHNlCiAgICB9CiAgfQoKICBpZiAoZW5kID09PSAtMSkgewogICAgaWYgKHJvb3RFbmQgPT09IC0xKSByZXR1cm4gJy4nCgogICAgZW5kID0gcm9vdEVuZAogIH0KICByZXR1cm4gcGF0aC5zdWJzdHJpbmcoMCwgZW5kKQp9CgpleHBvcnRzLmJhc2VuYW1lID0gZnVuY3Rpb24gYmFzZW5hbWUgKHBhdGgsIHN1ZmZpeCkgewogIGxldCBzdGFydCA9IDAKICBsZXQgZW5kID0gLTEKICBsZXQgbWF0Y2hlZFNsYXNoID0gdHJ1ZQoKICBpZiAocGF0aC5sZW5ndGggPj0gMiAmJiBpc1dpbmRvd3NEZXZpY2VSb290KHBhdGguY2hhckNvZGVBdCgwKSkgJiYgcGF0aC5jaGFyQ29kZUF0KDEpID09PSBDSEFSX0NPTE9OKSB7CiAgICBzdGFydCA9IDIKICB9CgogIGlmIChzdWZmaXggIT09IHVuZGVmaW5lZCAmJiBzdWZmaXgubGVuZ3RoID4gMCAmJiBzdWZmaXgubGVuZ3RoIDw9IHBhdGgubGVuZ3RoKSB7CiAgICBpZiAoc3VmZml4ID09PSBwYXRoKSByZXR1cm4gJycKICAgIGxldCBleHRJZHggPSBzdWZmaXgubGVuZ3RoIC0gMQogICAgbGV0IGZpcnN0Tm9uU2xhc2hFbmQgPSAtMQogICAgZm9yIChsZXQgaSA9IHBhdGgubGVuZ3RoIC0gMTsgaSA+PSBzdGFydDsgLS1pKSB7CiAgICAgIGNvbnN0IGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoaSkKICAgICAgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IoY29kZSkpIHsKICAgICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgICAgc3RhcnQgPSBpICsgMQogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGZpcnN0Tm9uU2xhc2hFbmQgPT09IC0xKSB7CiAgICAgICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZQogICAgICAgICAgZmlyc3ROb25TbGFzaEVuZCA9IGkgKyAxCiAgICAgICAgfQogICAgICAgIGlmIChleHRJZHggPj0gMCkgewogICAgICAgICAgaWYgKGNvZGUgPT09IHN1ZmZpeC5jaGFyQ29kZUF0KGV4dElkeCkpIHsKICAgICAgICAgICAgaWYgKC0tZXh0SWR4ID09PSAtMSkgewogICAgICAgICAgICAgIGVuZCA9IGkKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXh0SWR4ID0gLTEKICAgICAgICAgICAgZW5kID0gZmlyc3ROb25TbGFzaEVuZAogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChzdGFydCA9PT0gZW5kKSBlbmQgPSBmaXJzdE5vblNsYXNoRW5kCiAgICBlbHNlIGlmIChlbmQgPT09IC0xKSBlbmQgPSBwYXRoLmxlbmd0aAogICAgcmV0dXJuIHBhdGguc3Vic3RyaW5nKHN0YXJ0LCBlbmQpCiAgfQogIGZvciAobGV0IGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gc3RhcnQ7IC0taSkgewogICAgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGkpKSkgewogICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgIHN0YXJ0ID0gaSArIDEKICAgICAgICBicmVhawogICAgICB9CiAgICB9IGVsc2UgaWYgKGVuZCA9PT0gLTEpIHsKICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2UKICAgICAgZW5kID0gaSArIDEKICAgIH0KICB9CgogIGlmIChlbmQgPT09IC0xKSByZXR1cm4gJycKICByZXR1cm4gcGF0aC5zdWJzdHJpbmcoc3RhcnQsIGVuZCkKfQoKZXhwb3J0cy5leHRuYW1lID0gZnVuY3Rpb24gZXh0bmFtZSAocGF0aCkgewogIGxldCBzdGFydCA9IDAKICBsZXQgc3RhcnREb3QgPSAtMQogIGxldCBzdGFydFBhcnQgPSAwCiAgbGV0IGVuZCA9IC0xCiAgbGV0IG1hdGNoZWRTbGFzaCA9IHRydWUKICBsZXQgcHJlRG90U3RhdGUgPSAwCgogIGlmIChwYXRoLmxlbmd0aCA+PSAyICYmIHBhdGguY2hhckNvZGVBdCgxKSA9PT0gQ0hBUl9DT0xPTiAmJiBpc1dpbmRvd3NEZXZpY2VSb290KHBhdGguY2hhckNvZGVBdCgwKSkpIHsKICAgIHN0YXJ0ID0gc3RhcnRQYXJ0ID0gMgogIH0KCiAgZm9yIChsZXQgaSA9IHBhdGgubGVuZ3RoIC0gMTsgaSA+PSBzdGFydDsgLS1pKSB7CiAgICBjb25zdCBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpCiAgICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihjb2RlKSkgewogICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgIHN0YXJ0UGFydCA9IGkgKyAxCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgICBjb250aW51ZQogICAgfQogICAgaWYgKGVuZCA9PT0gLTEpIHsKICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2UKICAgICAgZW5kID0gaSArIDEKICAgIH0KICAgIGlmIChjb2RlID09PSBDSEFSX0RPVCkgewogICAgICBpZiAoc3RhcnREb3QgPT09IC0xKSBzdGFydERvdCA9IGkKICAgICAgZWxzZSBpZiAocHJlRG90U3RhdGUgIT09IDEpIHByZURvdFN0YXRlID0gMQogICAgfSBlbHNlIGlmIChzdGFydERvdCAhPT0gLTEpIHsKICAgICAgcHJlRG90U3RhdGUgPSAtMQogICAgfQogIH0KCiAgaWYgKHN0YXJ0RG90ID09PSAtMSB8fCBlbmQgPT09IC0xIHx8IHByZURvdFN0YXRlID09PSAwIHx8IChwcmVEb3RTdGF0ZSA9PT0gMSAmJiBzdGFydERvdCA9PT0gZW5kIC0gMSAmJiBzdGFydERvdCA9PT0gc3RhcnRQYXJ0ICsgMSkpIHsKICAgIHJldHVybiAnJwogIH0KICByZXR1cm4gcGF0aC5zdWJzdHJpbmcoc3RhcnREb3QsIGVuZCkKfQp7CiAgIm5hbWUiOiAiYmFyZS1wYXRoIiwKICAidmVyc2lvbiI6ICIzLjAuMCIsCiAgImRlc2NyaXB0aW9uIjogIlBhdGggbWFuaXB1bGF0aW9uIGxpYnJhcnkgZm9yIEphdmFTY3JpcHQiLAogICJleHBvcnRzIjogewogICAgIi4iOiAiLi9pbmRleC5qcyIsCiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuL3Bvc2l4IjogIi4vbGliL3Bvc2l4LmpzIiwKICAgICIuL3dpbjMyIjogIi4vbGliL3dpbjMyLmpzIgogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJsaWIiLAogICAgIk5PVElDRSIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYmFyZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtcGF0aC5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXBhdGgvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXBhdGgjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtb3MiOiAiXjMuMC4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjMuMiIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9Cn0KY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IG0gPSByZXF1aXJlKCcuL2xpYi9tZXNzYWdlcycpCmNvbnN0IHsgdHlwZTogdCwgc3RyZWFtOiBzIH0gPSByZXF1aXJlKCcuL2xpYi9jb25zdGFudHMnKQpjb25zdCBJbmNvbWluZ1JlcXVlc3QgPSByZXF1aXJlKCcuL2xpYi9pbmNvbWluZy1yZXF1ZXN0JykKY29uc3QgSW5jb21pbmdTdHJlYW0gPSByZXF1aXJlKCcuL2xpYi9pbmNvbWluZy1zdHJlYW0nKQpjb25zdCBPdXRnb2luZ1JlcXVlc3QgPSByZXF1aXJlKCcuL2xpYi9vdXRnb2luZy1yZXF1ZXN0JykKY29uc3QgT3V0Z29pbmdTdHJlYW0gPSByZXF1aXJlKCcuL2xpYi9vdXRnb2luZy1zdHJlYW0nKQpjb25zdCBDb21tYW5kUm91dGVyID0gcmVxdWlyZSgnLi9saWIvY29tbWFuZC1yb3V0ZXInKQoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gY2xhc3MgUlBDIHsKICBjb25zdHJ1Y3RvcihzdHJlYW0sIG9ucmVxdWVzdCA9IG5vb3ApIHsKICAgIHRoaXMuX3N0cmVhbSA9IHN0cmVhbQogICAgdGhpcy5faWQgPSAwCgogICAgdGhpcy5fb3V0Z29pbmdSZXF1ZXN0cyA9IG5ldyBNYXAoKQogICAgdGhpcy5fb3V0Z29pbmdSZXNwb25zZXMgPSBuZXcgTWFwKCkKICAgIHRoaXMuX2luY29taW5nUmVxdWVzdHMgPSBuZXcgTWFwKCkKICAgIHRoaXMuX2luY29taW5nUmVzcG9uc2VzID0gbmV3IE1hcCgpCiAgICB0aGlzLl9wZW5kaW5nUmVxdWVzdHMgPSBuZXcgU2V0KCkKICAgIHRoaXMuX3BlbmRpbmdSZXNwb25zZXMgPSBuZXcgU2V0KCkKCiAgICB0aGlzLl9idWZmZXIgPSBbXQogICAgdGhpcy5fYnVmZmVyZWQgPSAwCiAgICB0aGlzLl9mcmFtZSA9IC0xCiAgICB0aGlzLl9kcmFpbmluZyA9IFtdCgogICAgaWYgKHR5cGVvZiBvbnJlcXVlc3QgPT09ICdmdW5jdGlvbicpIHsKICAgICAgb25yZXF1ZXN0ID0gb25yZXF1ZXN0LmJpbmQodGhpcykKICAgIH0gZWxzZSB7CiAgICAgIG9ucmVxdWVzdCA9IG9ucmVxdWVzdC5fb25yZXF1ZXN0LmJpbmQob25yZXF1ZXN0KQogICAgfQoKICAgIHRoaXMuX29ucmVxdWVzdCA9IG9ucmVxdWVzdAogICAgdGhpcy5fb25lcnJvciA9IHRoaXMuX29uZXJyb3IuYmluZCh0aGlzKQogICAgdGhpcy5fb25kYXRhID0gdGhpcy5fb25kYXRhLmJpbmQodGhpcykKICAgIHRoaXMuX29uZHJhaW4gPSB0aGlzLl9vbmRyYWluLmJpbmQodGhpcykKCiAgICB0aGlzLl9zdHJlYW0KICAgICAgLm9uKCdlcnJvcicsIHRoaXMuX29uZXJyb3IpCiAgICAgIC5vbignZGF0YScsIHRoaXMuX29uZGF0YSkKICAgICAgLm9uKCdkcmFpbicsIHRoaXMuX29uZHJhaW4pCiAgfQoKICByZXF1ZXN0KGNvbW1hbmQpIHsKICAgIHJldHVybiBuZXcgT3V0Z29pbmdSZXF1ZXN0KHRoaXMsICsrdGhpcy5faWQsIGNvbW1hbmQpCiAgfQoKICBfc2VuZE1lc3NhZ2UobWVzc2FnZSwgY2IpIHsKICAgIGNvbnN0IGhlYWRlciA9IGMuZW5jb2RlKG0uaGVhZGVyLCBtZXNzYWdlKQoKICAgIGxldCBmbHVzaGVkID0gdGhpcy5fc3RyZWFtLndyaXRlKGhlYWRlcikKCiAgICBpZiAobWVzc2FnZS5kYXRhKSBmbHVzaGVkID0gdGhpcy5fc3RyZWFtLndyaXRlKG1lc3NhZ2UuZGF0YSkKCiAgICBpZiAoY2IpIHsKICAgICAgaWYgKGZsdXNoZWQpIGNiKG51bGwpCiAgICAgIGVsc2UgdGhpcy5fZHJhaW5pbmcucHVzaChjYikKICAgIH0KICB9CgogIF9zZW5kUmVxdWVzdChyZXF1ZXN0LCBkYXRhID0gbnVsbCkgewogICAgdGhpcy5fb3V0Z29pbmdSZXF1ZXN0cy5zZXQocmVxdWVzdC5pZCwgcmVxdWVzdCkKCiAgICB0aGlzLl9zZW5kTWVzc2FnZSh7CiAgICAgIHR5cGU6IHQuUkVRVUVTVCwKICAgICAgaWQ6IHJlcXVlc3QuaWQsCiAgICAgIGNvbW1hbmQ6IHJlcXVlc3QuY29tbWFuZCwKICAgICAgc3RyZWFtOiAwLAogICAgICBkYXRhCiAgICB9KQogIH0KCiAgX2NyZWF0ZVJlcXVlc3RTdHJlYW0ocmVxdWVzdCwgaXNJbml0aWF0b3IsIG9wdHMpIHsKICAgIGlmIChpc0luaXRpYXRvcikgewogICAgICB0aGlzLl9vdXRnb2luZ1JlcXVlc3RzLnNldChyZXF1ZXN0LmlkLCByZXF1ZXN0KQoKICAgICAgcmVxdWVzdC5fcmVxdWVzdFN0cmVhbSA9IG5ldyBPdXRnb2luZ1N0cmVhbSgKICAgICAgICB0aGlzLAogICAgICAgIHJlcXVlc3QsCiAgICAgICAgdC5SRVFVRVNULAogICAgICAgIG9wdHMKICAgICAgKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5faW5jb21pbmdSZXF1ZXN0cy5zZXQocmVxdWVzdC5pZCwgcmVxdWVzdCkKCiAgICAgIHJlcXVlc3QuX3JlcXVlc3RTdHJlYW0gPSBuZXcgSW5jb21pbmdTdHJlYW0oCiAgICAgICAgdGhpcywKICAgICAgICByZXF1ZXN0LAogICAgICAgIHQuUkVRVUVTVCwKICAgICAgICBvcHRzCiAgICAgICkKCiAgICAgIHJlcXVlc3QuX3JlcXVlc3RTdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4KICAgICAgICB0aGlzLl9pbmNvbWluZ1JlcXVlc3RzLmRlbGV0ZShyZXF1ZXN0LmlkKQogICAgICApCiAgICB9CiAgfQoKICBfc2VuZFJlc3BvbnNlKHJlcXVlc3QsIGRhdGEpIHsKICAgIHRoaXMuX3NlbmRNZXNzYWdlKHsKICAgICAgdHlwZTogdC5SRVNQT05TRSwKICAgICAgaWQ6IHJlcXVlc3QuaWQsCiAgICAgIHN0cmVhbTogMCwKICAgICAgZXJyb3I6IG51bGwsCiAgICAgIGRhdGEKICAgIH0pCiAgfQoKICBfY3JlYXRlUmVzcG9uc2VTdHJlYW0ocmVxdWVzdCwgaXNJbml0aWF0b3IsIG9wdHMpIHsKICAgIGlmIChpc0luaXRpYXRvcikgewogICAgICB0aGlzLl9vdXRnb2luZ1Jlc3BvbnNlcy5zZXQocmVxdWVzdC5pZCwgcmVxdWVzdCkKCiAgICAgIHJlcXVlc3QuX3Jlc3BvbnNlU3RyZWFtID0gbmV3IE91dGdvaW5nU3RyZWFtKAogICAgICAgIHRoaXMsCiAgICAgICAgcmVxdWVzdCwKICAgICAgICB0LlJFU1BPTlNFLAogICAgICAgIG9wdHMKICAgICAgKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5faW5jb21pbmdSZXNwb25zZXMuc2V0KHJlcXVlc3QuaWQsIHJlcXVlc3QpCgogICAgICByZXF1ZXN0Ll9yZXNwb25zZVN0cmVhbSA9IG5ldyBJbmNvbWluZ1N0cmVhbSgKICAgICAgICB0aGlzLAogICAgICAgIHJlcXVlc3QsCiAgICAgICAgdC5SRVNQT05TRSwKICAgICAgICBvcHRzCiAgICAgICkKCiAgICAgIHJlcXVlc3QuX3Jlc3BvbnNlU3RyZWFtLm9uKCdjbG9zZScsICgpID0+CiAgICAgICAgdGhpcy5faW5jb21pbmdSZXNwb25zZXMuZGVsZXRlKHJlcXVlc3QuaWQpCiAgICAgICkKICAgIH0KICB9CgogIF9zZW5kRXJyb3IocmVxdWVzdCwgZXJyKSB7CiAgICB0aGlzLl9zZW5kTWVzc2FnZSh7CiAgICAgIHR5cGU6IHQuUkVTUE9OU0UsCiAgICAgIGlkOiByZXF1ZXN0LmlkLAogICAgICBzdHJlYW06IDAsCiAgICAgIGVycm9yOiBlcnIsCiAgICAgIGRhdGE6IG51bGwKICAgIH0pCiAgfQoKICBfb25lcnJvcihlcnIpIHsKICAgIHRoaXMuX29uZHJhaW4oZXJyKQoKICAgIC8vIFRPRE8gRGVzdHJveSBwZW5kaW5nIHJlcXVlc3RzIGFuZCByZXNwb25zZXMKICB9CgogIF9vbmRhdGEoZGF0YSkgewogICAgdGhpcy5fYnVmZmVyLnB1c2goZGF0YSkKICAgIHRoaXMuX2J1ZmZlcmVkICs9IGRhdGEuYnl0ZUxlbmd0aAoKICAgIGlmICh0aGlzLl9mcmFtZSA9PT0gLTEpIHsKICAgICAgdGhpcy5fb25iZWZvcmVmcmFtZSgpCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9vbmFmdGVyZnJhbWUoKQogICAgfQogIH0KCiAgX29uYmVmb3JlZnJhbWUoKSB7CiAgICBpZiAodGhpcy5fYnVmZmVyZWQgPCA0KSByZXR1cm4KCiAgICBjb25zdCBidWZmZXIgPQogICAgICB0aGlzLl9idWZmZXIubGVuZ3RoID09PSAxID8gdGhpcy5fYnVmZmVyWzBdIDogYjRhLmNvbmNhdCh0aGlzLl9idWZmZXIpCgogICAgdGhpcy5fYnVmZmVyID0gW2J1ZmZlcl0KICAgIHRoaXMuX2ZyYW1lID0gNCArIGMudWludDMyLmRlY29kZShjLnN0YXRlKDAsIDQsIGJ1ZmZlcikpCgogICAgdGhpcy5fb25hZnRlcmZyYW1lKCkKICB9CgogIF9vbmFmdGVyZnJhbWUoKSB7CiAgICBpZiAodGhpcy5fYnVmZmVyZWQgPCB0aGlzLl9mcmFtZSkgcmV0dXJuCgogICAgY29uc3QgYnVmZmVyID0KICAgICAgdGhpcy5fYnVmZmVyLmxlbmd0aCA9PT0gMSA/IHRoaXMuX2J1ZmZlclswXSA6IGI0YS5jb25jYXQodGhpcy5fYnVmZmVyKQoKICAgIGNvbnN0IGZyYW1lID0gdGhpcy5fZnJhbWUKCiAgICB0aGlzLl9idWZmZXJlZCAtPSBmcmFtZQogICAgdGhpcy5fYnVmZmVyID0gdGhpcy5fYnVmZmVyZWQgPiAwID8gW2J1ZmZlci5zdWJhcnJheShmcmFtZSldIDogW10KICAgIHRoaXMuX2ZyYW1lID0gLTEKCiAgICB0aGlzLl9vbm1lc3NhZ2UoYnVmZmVyLnN1YmFycmF5KDAsIGZyYW1lKSkKICAgIHRoaXMuX29uYmVmb3JlZnJhbWUoKQogIH0KCiAgYXN5bmMgX29ubWVzc2FnZShidWZmZXIpIHsKICAgIGxldCBtZXNzYWdlCiAgICB0cnkgewogICAgICBtZXNzYWdlID0gbS5tZXNzYWdlLmRlY29kZShjLnN0YXRlKDAsIGJ1ZmZlci5sZW5ndGgsIGJ1ZmZlcikpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgc2FmZXR5Q2F0Y2goZXJyKQoKICAgICAgcmV0dXJuIHRoaXMuX3N0cmVhbS5kZXN0cm95KGVycikKICAgIH0KCiAgICBzd2l0Y2ggKG1lc3NhZ2UudHlwZSkgewogICAgICBjYXNlIHQuUkVRVUVTVDoKICAgICAgICBjb25zdCByZXF1ZXN0ID0gbmV3IEluY29taW5nUmVxdWVzdCgKICAgICAgICAgIHRoaXMsCiAgICAgICAgICBtZXNzYWdlLmlkLAogICAgICAgICAgbWVzc2FnZS5jb21tYW5kLAogICAgICAgICAgbWVzc2FnZS5kYXRhCiAgICAgICAgKQoKICAgICAgICB0cnkgewogICAgICAgICAgYXdhaXQgdGhpcy5fb25yZXF1ZXN0KHJlcXVlc3QpCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBzYWZldHlDYXRjaChlcnIpCgogICAgICAgICAgdGhpcy5fc2VuZEVycm9yKHJlcXVlc3QsIGVycikKICAgICAgICB9CiAgICAgICAgYnJlYWsKICAgICAgY2FzZSB0LlJFU1BPTlNFOgogICAgICAgIHRyeSB7CiAgICAgICAgICB0aGlzLl9vbnJlc3BvbnNlKG1lc3NhZ2UpCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgICAgfQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgdC5TVFJFQU06CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHRoaXMuX29uc3RyZWFtKG1lc3NhZ2UpCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgICAgfQogICAgfQogIH0KCiAgX29ucmVzcG9uc2UobWVzc2FnZSkgewogICAgaWYgKG1lc3NhZ2UuaWQgPT09IDApIHJldHVybgoKICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9vdXRnb2luZ1JlcXVlc3RzLmdldChtZXNzYWdlLmlkKQogICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgaWYgKG1lc3NhZ2UuZXJyb3IpIHsKICAgICAgcmVxdWVzdC5fcmVqZWN0KG1lc3NhZ2UuZXJyb3IpCiAgICB9IGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtID09PSAwKSB7CiAgICAgIHJlcXVlc3QuX3Jlc29sdmUobWVzc2FnZS5kYXRhKQogICAgfQogIH0KCiAgX29uc3RyZWFtKG1lc3NhZ2UpIHsKICAgIGlmIChtZXNzYWdlLmlkID09PSAwKSByZXR1cm4KCiAgICBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLk9QRU4pIHRoaXMuX29uc3RyZWFtb3BlbihtZXNzYWdlKQogICAgZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLkNMT1NFKSB0aGlzLl9vbnN0cmVhbWNsb3NlKG1lc3NhZ2UpCiAgICBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUEFVU0UpIHRoaXMuX29uc3RyZWFtcGF1c2UobWVzc2FnZSkKICAgIGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVNVTUUpIHRoaXMuX29uc3RyZWFtcmVzdW1lKG1lc3NhZ2UpCiAgICBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuREFUQSkgdGhpcy5fb25zdHJlYW1kYXRhKG1lc3NhZ2UpCiAgICBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuRU5EKSB0aGlzLl9vbnN0cmVhbWVuZChtZXNzYWdlKQogICAgZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLkRFU1RST1kpIHRoaXMuX29uc3RyZWFtZGVzdHJveShtZXNzYWdlKQogIH0KCiAgX29uc3RyZWFtb3BlbihtZXNzYWdlKSB7CiAgICBsZXQgc3RyZWFtCgogICAgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVFVRVNUKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9vdXRnb2luZ1JlcXVlc3RzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5fcGVuZGluZ1JlcXVlc3RzLmFkZChtZXNzYWdlLmlkKQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXF1ZXN0U3RyZWFtCgogICAgICBpZiAoc3RyZWFtLl9wZW5kaW5nT3BlbiA9PT0gbnVsbCkgewogICAgICAgIHRoaXMuX3BlbmRpbmdSZXF1ZXN0cy5hZGQobWVzc2FnZS5pZCkKICAgICAgICByZXR1cm4KICAgICAgfQogICAgfSBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVTUE9OU0UpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX291dGdvaW5nUmVzcG9uc2VzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5fcGVuZGluZ1Jlc3BvbnNlcy5hZGQobWVzc2FnZS5pZCkKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVzcG9uc2VTdHJlYW0KCiAgICAgIGlmIChzdHJlYW0uX3BlbmRpbmdPcGVuID09PSBudWxsKSB7CiAgICAgICAgdGhpcy5fcGVuZGluZ1Jlc3BvbnNlcy5hZGQobWVzc2FnZS5pZCkKICAgICAgICByZXR1cm4KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgc3RyZWFtLl9jb250aW51ZU9wZW4oKQogIH0KCiAgX29uc3RyZWFtY2xvc2UobWVzc2FnZSkgewogICAgbGV0IHN0cmVhbQoKICAgIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVRVUVTVCkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5faW5jb21pbmdSZXF1ZXN0cy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXF1ZXN0U3RyZWFtCiAgICB9IGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVNQT05TRSkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5faW5jb21pbmdSZXNwb25zZXMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVzcG9uc2VTdHJlYW0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChtZXNzYWdlLmVycm9yKSBzdHJlYW0uZGVzdHJveShtZXNzYWdlLmVycm9yKQogICAgZWxzZSBzdHJlYW0ucHVzaChudWxsKQogIH0KCiAgX29uc3RyZWFtcGF1c2UobWVzc2FnZSkgewogICAgbGV0IHN0cmVhbQoKICAgIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVRVUVTVCkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fb3V0Z29pbmdSZXF1ZXN0cy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXF1ZXN0U3RyZWFtCiAgICB9IGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVNQT05TRSkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fb3V0Z29pbmdSZXNwb25zZXMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVzcG9uc2VTdHJlYW0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIHN0cmVhbS5jb3JrKCkKICB9CgogIF9vbnN0cmVhbXJlc3VtZShtZXNzYWdlKSB7CiAgICBsZXQgc3RyZWFtCgogICAgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVFVRVNUKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9vdXRnb2luZ1JlcXVlc3RzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3JlcXVlc3RTdHJlYW0KICAgIH0gZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFU1BPTlNFKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9vdXRnb2luZ1Jlc3BvbnNlcy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXNwb25zZVN0cmVhbQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgc3RyZWFtLnVuY29yaygpCiAgfQoKICBfb25zdHJlYW1kYXRhKG1lc3NhZ2UpIHsKICAgIGxldCBzdHJlYW0KCiAgICBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFUVVFU1QpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX2luY29taW5nUmVxdWVzdHMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVxdWVzdFN0cmVhbQogICAgfSBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVTUE9OU0UpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX2luY29taW5nUmVzcG9uc2VzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3Jlc3BvbnNlU3RyZWFtCiAgICB9IGVsc2UgewogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoc3RyZWFtLnB1c2gobWVzc2FnZS5kYXRhKSA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5fc2VuZE1lc3NhZ2UoewogICAgICAgIHR5cGU6IHQuU1RSRUFNLAogICAgICAgIGlkOiBzdHJlYW0uX3JlcXVlc3QuaWQsCiAgICAgICAgc3RyZWFtOiBzdHJlYW0uX21hc2sgfCBzLlBBVVNFLAogICAgICAgIGVycm9yOiBudWxsLAogICAgICAgIGRhdGE6IG51bGwKICAgICAgfSkKICAgIH0KICB9CgogIF9vbnN0cmVhbWVuZChtZXNzYWdlKSB7CiAgICBsZXQgc3RyZWFtCgogICAgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVFVRVNUKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9pbmNvbWluZ1JlcXVlc3RzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3JlcXVlc3RTdHJlYW0KICAgIH0gZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFU1BPTlNFKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9pbmNvbWluZ1Jlc3BvbnNlcy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXNwb25zZVN0cmVhbQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgc3RyZWFtLnB1c2gobnVsbCkKICB9CgogIF9vbnN0cmVhbWRlc3Ryb3kobWVzc2FnZSkgewogICAgbGV0IHN0cmVhbQoKICAgIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVRVUVTVCkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fb3V0Z29pbmdSZXF1ZXN0cy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXF1ZXN0U3RyZWFtCiAgICB9IGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVNQT05TRSkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fb3V0Z29pbmdSZXNwb25zZXMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVzcG9uc2VTdHJlYW0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIHN0cmVhbS5kZXN0cm95KG1lc3NhZ2UuZXJyb3IpCiAgfQoKICBfb25kcmFpbihlcnIgPSBudWxsKSB7CiAgICBjb25zdCBkcmFpbmluZyA9IHRoaXMuX2RyYWluaW5nCgogICAgdGhpcy5fZHJhaW5pbmcgPSBbXQoKICAgIGZvciAoY29uc3QgY2Igb2YgZHJhaW5pbmcpIGNiKGVycikKICB9Cn0KCmV4cG9ydHMuQ29tbWFuZFJvdXRlciA9IENvbW1hbmRSb3V0ZXIKCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJQQ0NvbW1hbmRSb3V0ZXIgewogIGNvbnN0cnVjdG9yKG9wdHMgPSB7fSkgewogICAgY29uc3QgeyB2YWx1ZUVuY29kaW5nID0gYy5yYXcgfSA9IG9wdHMKCiAgICB0aGlzLl9yZXNwb25kZXJzID0gbmV3IE1hcCgpCiAgICB0aGlzLl9kZWZhdWx0VmFsdWVFbmNvZGluZyA9IHZhbHVlRW5jb2RpbmcKICB9CgogIHJlc3BvbmQoY29tbWFuZCwgb3B0cyA9IHt9LCBvbnJlcXVlc3QpIHsKICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBvbnJlcXVlc3QgPSBvcHRzCiAgICAgIG9wdHMgPSB7fQogICAgfQoKICAgIGNvbnN0IHsKICAgICAgdmFsdWVFbmNvZGluZyA9IHRoaXMuX2RlZmF1bHRWYWx1ZUVuY29kaW5nLAogICAgICByZXF1ZXN0RW5jb2RpbmcgPSB2YWx1ZUVuY29kaW5nLAogICAgICByZXNwb25zZUVuY29kaW5nID0gdmFsdWVFbmNvZGluZwogICAgfSA9IG9wdHMKCiAgICB0aGlzLl9yZXNwb25kZXJzLnNldChjb21tYW5kLCB7CiAgICAgIG9ucmVxdWVzdCwKICAgICAgcmVxdWVzdEVuY29kaW5nLAogICAgICByZXNwb25zZUVuY29kaW5nCiAgICB9KQogIH0KCiAgYXN5bmMgX29ucmVxdWVzdChyZXEpIHsKICAgIGNvbnN0IHJlc3BvbmRlciA9IHRoaXMuX3Jlc3BvbmRlcnMuZ2V0KHJlcS5jb21tYW5kKQoKICAgIGlmIChyZXNwb25kZXIgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgY29uc3QgeyBvbnJlcXVlc3QsIHJlcXVlc3RFbmNvZGluZywgcmVzcG9uc2VFbmNvZGluZyB9ID0gcmVzcG9uZGVyCgogICAgbGV0IGRhdGEgPSByZXEuZGF0YQoKICAgIGlmIChyZXF1ZXN0RW5jb2RpbmcpIGRhdGEgPSBjLmRlY29kZShyZXF1ZXN0RW5jb2RpbmcsIGRhdGEpCgogICAgZGF0YSA9IGF3YWl0IG9ucmVxdWVzdChyZXEsIGRhdGEpCgogICAgaWYgKHJlcS5zZW50KSByZXR1cm4KCiAgICBpZiAocmVzcG9uc2VFbmNvZGluZykgZGF0YSA9IGMuZW5jb2RlKHJlc3BvbnNlRW5jb2RpbmcsIGRhdGEpCgogICAgcmVxLnJlcGx5KGRhdGEpCiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gewogIHR5cGU6IHsKICAgIFJFUVVFU1Q6IDEsCiAgICBSRVNQT05TRTogMiwKICAgIFNUUkVBTTogMwogIH0sCiAgc3RyZWFtOiB7CiAgICBPUEVOOiAweDEsCiAgICBDTE9TRTogMHgyLAogICAgUEFVU0U6IDB4NCwKICAgIFJFU1VNRTogMHg4LAogICAgREFUQTogMHgxMCwKICAgIEVORDogMHgyMCwKICAgIERFU1RST1k6IDB4NDAsCiAgICBFUlJPUjogMHg4MCwKICAgIFJFUVVFU1Q6IDB4MTAwLAogICAgUkVTUE9OU0U6IDB4MjAwCiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUlBDRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobXNnLCBjb2RlLCBmbiA9IFJQQ0Vycm9yKSB7CiAgICBzdXBlcihgJHtjb2RlfTogJHttc2d9YCkKICAgIHRoaXMuY29kZSA9IGNvZGUKCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgZm4pCiAgICB9CiAgfQoKICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiAnUlBDRXJyb3InCiAgfQoKICBzdGF0aWMgVU5LTk9XTl9NRVNTQUdFKG1zZykgewogICAgcmV0dXJuIG5ldyBSUENFcnJvcihtc2csICdVTktOT1dOX01FU1NBR0UnLCBSUENFcnJvci5VTktOT1dOX01FU1NBR0UpCiAgfQoKICBzdGF0aWMgQUxSRUFEWV9TRU5UKG1zZykgewogICAgcmV0dXJuIG5ldyBSUENFcnJvcihtc2csICdBTFJFQURZX1NFTlQnLCBSUENFcnJvci5BTFJFQURZX1NFTlQpCiAgfQoKICBzdGF0aWMgQUxSRUFEWV9SRUNFSVZFRChtc2cpIHsKICAgIHJldHVybiBuZXcgUlBDRXJyb3IobXNnLCAnQUxSRUFEWV9SRUNFSVZFRCcsIFJQQ0Vycm9yLkFMUkVBRFlfUkVDRUlWRUQpCiAgfQp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi9lcnJvcnMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSUENJbmNvbWluZ1JlcXVlc3QgewogIGNvbnN0cnVjdG9yKHJwYywgaWQsIGNvbW1hbmQsIGRhdGEpIHsKICAgIHRoaXMucnBjID0gcnBjCiAgICB0aGlzLmlkID0gaWQKICAgIHRoaXMuY29tbWFuZCA9IGNvbW1hbmQKICAgIHRoaXMuZGF0YSA9IGRhdGEKICAgIHRoaXMuc2VudCA9IGZhbHNlCiAgICB0aGlzLnJlY2VpdmVkID0gZmFsc2UKCiAgICB0aGlzLl9yZXF1ZXN0U3RyZWFtID0gbnVsbAogICAgdGhpcy5fcmVzcG9uc2VTdHJlYW0gPSBudWxsCiAgfQoKICByZXBseShkYXRhLCBlbmNvZGluZykgewogICAgaWYgKHRoaXMuc2VudCkgewogICAgICB0aHJvdyBlcnJvcnMuQUxSRUFEWV9TRU5UKCdSZXNwb25zZSBoYXMgYWxyZWFkeSBiZWVuIHNlbnQnKQogICAgfQoKICAgIGVuY29kaW5nID0KICAgICAgZW5jb2RpbmcgJiYgZW5jb2RpbmcgIT09ICdidWZmZXInCiAgICAgICAgPyBjLmZyb20oZW5jb2RpbmcpCiAgICAgICAgOiB0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycKICAgICAgICAgID8gYy5yYXcudXRmOAogICAgICAgICAgOiBudWxsCgogICAgdGhpcy5zZW50ID0gdHJ1ZQoKICAgIHRoaXMucnBjLl9zZW5kUmVzcG9uc2UodGhpcywgZW5jb2RpbmcgPyBjLmVuY29kZShlbmNvZGluZywgZGF0YSkgOiBkYXRhKQogIH0KCiAgY3JlYXRlUmVzcG9uc2VTdHJlYW0ob3B0cyA9IHt9KSB7CiAgICBpZiAodGhpcy5zZW50KSB7CiAgICAgIHRocm93IGVycm9ycy5BTFJFQURZX1NFTlQoJ1Jlc3BvbnNlIGhhcyBhbHJlYWR5IGJlZW4gc2VudCcpCiAgICB9CgogICAgdGhpcy5zZW50ID0gdHJ1ZQoKICAgIHRoaXMucnBjLl9jcmVhdGVSZXNwb25zZVN0cmVhbSh0aGlzLCB0cnVlLCBvcHRzKQoKICAgIHJldHVybiB0aGlzLl9yZXNwb25zZVN0cmVhbQogIH0KCiAgY3JlYXRlUmVxdWVzdFN0cmVhbShvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLnJlY2VpdmVkKSB7CiAgICAgIHRocm93IGVycm9ycy5BTFJFQURZX1JFQ0VJVkVEKCdSZXF1ZXN0IGhhcyBhbHJlYWR5IGJlZW4gcmVjZWl2ZWQnKQogICAgfQoKICAgIHRoaXMucmVjZWl2ZWQgPSB0cnVlCgogICAgdGhpcy5ycGMuX2NyZWF0ZVJlcXVlc3RTdHJlYW0odGhpcywgZmFsc2UsIG9wdHMpCgogICAgcmV0dXJuIHRoaXMuX3JlcXVlc3RTdHJlYW0KICB9Cn0KY29uc3QgeyBSZWFkYWJsZSB9ID0gcmVxdWlyZSgnYmFyZS1zdHJlYW0nKQpjb25zdCB7IHR5cGU6IHQsIHN0cmVhbTogcyB9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSUENJbmNvbWluZ1N0cmVhbSBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3RvcihycGMsIHJlcXVlc3QsIHR5cGUsIG9wdHMpIHsKICAgIHN1cGVyKHsgLi4ub3B0cywgZWFnZXJPcGVuOiB0cnVlIH0pCgogICAgdGhpcy5fcnBjID0gcnBjCiAgICB0aGlzLl9yZXF1ZXN0ID0gcmVxdWVzdAogICAgdGhpcy5fdHlwZSA9IHR5cGUKICAgIHRoaXMuX21hc2sgPSB0eXBlID09PSB0LlJFUVVFU1QgPyBzLlJFUVVFU1QgOiBzLlJFU1BPTlNFCiAgfQoKICBfb3BlbihjYikgewogICAgdGhpcy5fcnBjLl9zZW5kTWVzc2FnZSgKICAgICAgewogICAgICAgIHR5cGU6IHQuU1RSRUFNLAogICAgICAgIGlkOiB0aGlzLl9yZXF1ZXN0LmlkLAogICAgICAgIHN0cmVhbTogdGhpcy5fbWFzayB8IHMuT1BFTiwKICAgICAgICBlcnJvcjogbnVsbCwKICAgICAgICBkYXRhOiBudWxsCiAgICAgIH0sCiAgICAgIGNiCiAgICApCiAgfQoKICBfcmVhZCgpIHsKICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoewogICAgICB0eXBlOiB0LlNUUkVBTSwKICAgICAgaWQ6IHRoaXMuX3JlcXVlc3QuaWQsCiAgICAgIHN0cmVhbTogdGhpcy5fbWFzayB8IHMuUkVTVU1FLAogICAgICBlcnJvcjogbnVsbCwKICAgICAgZGF0YTogbnVsbAogICAgfSkKICB9CgogIF9kZXN0cm95KGVyciwgY2IpIHsKICAgIGlmIChlcnIpIHsKICAgICAgdGhpcy5fcnBjLl9zZW5kTWVzc2FnZSgKICAgICAgICB7CiAgICAgICAgICB0eXBlOiB0LlNUUkVBTSwKICAgICAgICAgIGlkOiB0aGlzLl9yZXF1ZXN0LmlkLAogICAgICAgICAgc3RyZWFtOiB0aGlzLl9tYXNrIHwgcy5ERVNUUk9ZIHwgcy5FUlJPUiwKICAgICAgICAgIGVycm9yOiBlcnIsCiAgICAgICAgICBkYXRhOiBudWxsCiAgICAgICAgfSwKICAgICAgICBjYgogICAgICApCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9ycGMuX3NlbmRNZXNzYWdlKAogICAgICAgIHsKICAgICAgICAgIHR5cGU6IHQuU1RSRUFNLAogICAgICAgICAgaWQ6IHRoaXMuX3JlcXVlc3QuaWQsCiAgICAgICAgICBzdHJlYW06IHRoaXMuX21hc2sgfCBzLkRFU1RST1ksCiAgICAgICAgICBlcnJvcjogbnVsbCwKICAgICAgICAgIGRhdGE6IG51bGwKICAgICAgICB9LAogICAgICAgIGNiCiAgICAgICkKICAgIH0KICB9Cn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCB7IHR5cGU6IHQsIHN0cmVhbTogcyB9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuL2Vycm9ycycpCgpjb25zdCBlcnJvciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudXRmOC5wcmVlbmNvZGUoc3RhdGUsIG0ubWVzc2FnZSkKICAgIGMudXRmOC5wcmVlbmNvZGUoc3RhdGUsIFN0cmluZyhtLmNvZGUpIHx8ICcnKQogICAgYy5pbnQucHJlZW5jb2RlKHN0YXRlLCBOdW1iZXIobS5lcnJubykgfHwgMCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51dGY4LmVuY29kZShzdGF0ZSwgbS5tZXNzYWdlKQogICAgYy51dGY4LmVuY29kZShzdGF0ZSwgU3RyaW5nKG0uY29kZSkgfHwgJycpCiAgICBjLmludC5lbmNvZGUoc3RhdGUsIE51bWJlcihtLmVycm5vKSB8fCAwKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoYCR7Yy51dGY4LmRlY29kZShzdGF0ZSl9YCkKICAgIGVyci5jb2RlID0gYy51dGY4LmRlY29kZShzdGF0ZSkKICAgIGVyci5lcnJubyA9IGMuaW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiBlcnIKICB9Cn0KCmV4cG9ydHMuaGVhZGVyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50MzIucHJlZW5jb2RlKHN0YXRlLCAwKSAvLyBGcmFtZQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS50eXBlKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5pZCkKCiAgICBsZXQgaGFzRGF0YSA9IGZhbHNlCgogICAgc3dpdGNoIChtLnR5cGUpIHsKICAgICAgY2FzZSB0LlJFUVVFU1Q6CiAgICAgICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5jb21tYW5kKQogICAgICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RyZWFtKQogICAgICAgIGlmIChtLnN0cmVhbSA9PT0gMCkgaGFzRGF0YSA9IHRydWUKICAgICAgICBicmVhawoKICAgICAgY2FzZSB0LlJFU1BPTlNFOgogICAgICAgIGMuYm9vbC5wcmVlbmNvZGUoc3RhdGUsICEhbS5lcnJvcikKICAgICAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0cmVhbSkKCiAgICAgICAgaWYgKG0uZXJyb3IpIGVycm9yLnByZWVuY29kZShzdGF0ZSwgbS5lcnJvcikKICAgICAgICBlbHNlIGlmIChtLnN0cmVhbSA9PT0gMCkgaGFzRGF0YSA9IHRydWUKICAgICAgICBicmVhawoKICAgICAgY2FzZSB0LlNUUkVBTToKICAgICAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0cmVhbSkKCiAgICAgICAgaWYgKG0uc3RyZWFtICYgcy5FUlJPUikgZXJyb3IucHJlZW5jb2RlKHN0YXRlLCBtLmVycm9yKQogICAgICAgIGVsc2UgaWYgKG0uc3RyZWFtICYgcy5EQVRBKSBoYXNEYXRhID0gdHJ1ZQogICAgICAgIGJyZWFrCiAgICB9CgogICAgaWYgKGhhc0RhdGEpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZGF0YSA/IG0uZGF0YS5ieXRlTGVuZ3RoIDogMCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZnJhbWUgPSBzdGF0ZS5zdGFydAoKICAgIGMudWludDMyLmVuY29kZShzdGF0ZSwgMCkgLy8gRnJhbWUKCiAgICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS50eXBlKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5pZCkKCiAgICBsZXQgaGFzRGF0YSA9IGZhbHNlCgogICAgc3dpdGNoIChtLnR5cGUpIHsKICAgICAgY2FzZSB0LlJFUVVFU1Q6CiAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5jb21tYW5kKQogICAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RyZWFtKQogICAgICAgIGlmIChtLnN0cmVhbSA9PT0gMCkgaGFzRGF0YSA9IHRydWUKICAgICAgICBicmVhawoKICAgICAgY2FzZSB0LlJFU1BPTlNFOgogICAgICAgIGMuYm9vbC5lbmNvZGUoc3RhdGUsICEhbS5lcnJvcikKICAgICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0cmVhbSkKCiAgICAgICAgaWYgKG0uZXJyb3IpIGVycm9yLmVuY29kZShzdGF0ZSwgbS5lcnJvcikKICAgICAgICBlbHNlIGlmIChtLnN0cmVhbSA9PT0gMCkgaGFzRGF0YSA9IHRydWUKICAgICAgICBicmVhawoKICAgICAgY2FzZSB0LlNUUkVBTToKICAgICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0cmVhbSkKCiAgICAgICAgaWYgKG0uc3RyZWFtICYgcy5FUlJPUikgZXJyb3IuZW5jb2RlKHN0YXRlLCBtLmVycm9yKQogICAgICAgIGVsc2UgaWYgKG0uc3RyZWFtICYgcy5EQVRBKSBoYXNEYXRhID0gdHJ1ZQogICAgICAgIGJyZWFrCiAgICB9CgogICAgaWYgKGhhc0RhdGEpIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZGF0YSA/IG0uZGF0YS5ieXRlTGVuZ3RoIDogMCkKCiAgICBjb25zdCBlbmQgPSBzdGF0ZS5zdGFydAoKICAgIHN0YXRlLnN0YXJ0ID0gZnJhbWUKCiAgICBjLnVpbnQzMi5lbmNvZGUoCiAgICAgIHN0YXRlLAogICAgICBlbmQgLSBzdGFydCArIChoYXNEYXRhICYmIG0uZGF0YSA/IG0uZGF0YS5ieXRlTGVuZ3RoIDogMCkKICAgICkKCiAgICBzdGF0ZS5zdGFydCA9IGVuZAogIH0KfQoKZXhwb3J0cy5tZXNzYWdlID0gewogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZnJhbWUgPSBjLnVpbnQzMi5kZWNvZGUoc3RhdGUpCgogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgZnJhbWUpIHRocm93IG5ldyBSYW5nZUVycm9yKCdPdXQgb2YgYm91bmRzJykKCiAgICBjb25zdCB0eXBlID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGlkID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSB0LlJFUVVFU1Q6IHsKICAgICAgICBjb25zdCBjb21tYW5kID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgICAgICBjb25zdCBzdHJlYW0gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgICAgIGNvbnN0IGRhdGEgPSBzdHJlYW0gPT09IDAgPyBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpIDogbnVsbAoKICAgICAgICByZXR1cm4geyB0eXBlLCBpZCwgY29tbWFuZCwgc3RyZWFtLCBkYXRhIH0KICAgICAgfQoKICAgICAgY2FzZSB0LlJFU1BPTlNFOiB7CiAgICAgICAgY29uc3QgZXJyID0gYy5ib29sLmRlY29kZShzdGF0ZSkKICAgICAgICBjb25zdCBzdHJlYW0gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICByZXR1cm4geyB0eXBlLCBpZCwgc3RyZWFtLCBlcnJvcjogZXJyb3IuZGVjb2RlKHN0YXRlKSwgZGF0YTogbnVsbCB9CiAgICAgICAgfQoKICAgICAgICBpZiAoc3RyZWFtID09PSAwKSB7CiAgICAgICAgICByZXR1cm4geyB0eXBlLCBpZCwgc3RyZWFtLCBlcnJvcjogbnVsbCwgZGF0YTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKSB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4geyB0eXBlLCBpZCwgc3RyZWFtLCBlcnJvcjogbnVsbCwgZGF0YTogbnVsbCB9CiAgICAgIH0KCiAgICAgIGNhc2UgdC5TVFJFQU06CiAgICAgICAgY29uc3Qgc3RyZWFtID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICAgICAgaWYgKHN0cmVhbSAmIHMuRVJST1IpIHsKICAgICAgICAgIHJldHVybiB7IHR5cGUsIGlkLCBzdHJlYW0sIGVycm9yOiBlcnJvci5kZWNvZGUoc3RhdGUpLCBkYXRhOiBudWxsIH0KICAgICAgICB9CgogICAgICAgIGlmIChzdHJlYW0gJiBzLkRBVEEpIHsKICAgICAgICAgIHJldHVybiB7IHR5cGUsIGlkLCBzdHJlYW0sIGVycm9yOiBudWxsLCBkYXRhOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB7IHR5cGUsIGlkLCBzdHJlYW0sIGVycm9yOiBudWxsLCBkYXRhOiBudWxsIH0KCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgZXJyb3JzLlVOS05PV05fTUVTU0FHRShgVW5rbm93biBtZXNzYWdlICcke3R5cGV9J2ApCiAgICB9CiAgfQp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi9lcnJvcnMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSUENPdXRnb2luZ1JlcXVlc3QgewogIGNvbnN0cnVjdG9yKHJwYywgaWQsIGNvbW1hbmQpIHsKICAgIHRoaXMucnBjID0gcnBjCiAgICB0aGlzLmlkID0gaWQKICAgIHRoaXMuY29tbWFuZCA9IGNvbW1hbmQKICAgIHRoaXMuc2VudCA9IGZhbHNlCiAgICB0aGlzLnJlY2VpdmVkID0gZmFsc2UKCiAgICB0aGlzLl9wcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICB0aGlzLl9yZXNvbHZlID0gcmVzb2x2ZQogICAgICB0aGlzLl9yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgdGhpcy5fcmVxdWVzdFN0cmVhbSA9IG51bGwKICAgIHRoaXMuX3Jlc3BvbnNlU3RyZWFtID0gbnVsbAogIH0KCiAgc2VuZChkYXRhLCBlbmNvZGluZykgewogICAgaWYgKHRoaXMuc2VudCkgewogICAgICB0aHJvdyBlcnJvcnMuQUxSRUFEWV9TRU5UKCdSZXF1ZXN0IGhhcyBhbHJlYWR5IGJlZW4gc2VudCcpCiAgICB9CgogICAgZW5jb2RpbmcgPQogICAgICBlbmNvZGluZyAmJiBlbmNvZGluZyAhPT0gJ2J1ZmZlcicKICAgICAgICA/IGMuZnJvbShlbmNvZGluZykKICAgICAgICA6IHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJwogICAgICAgICAgPyBjLnJhdy51dGY4CiAgICAgICAgICA6IG51bGwKCiAgICB0aGlzLnNlbnQgPSB0cnVlCgogICAgdGhpcy5ycGMuX3NlbmRSZXF1ZXN0KHRoaXMsIGVuY29kaW5nID8gYy5lbmNvZGUoZW5jb2RpbmcsIGRhdGEpIDogZGF0YSkKICB9CgogIHJlcGx5KGVuY29kaW5nKSB7CiAgICBpZiAodGhpcy5yZWNlaXZlZCkgewogICAgICB0aHJvdyBlcnJvcnMuQUxSRUFEWV9SRUNFSVZFRCgnUmVzcG9uc2UgaXMgYWxyZWFkeSBiZWluZyByZWNlaXZlZCcpCiAgICB9CgogICAgZW5jb2RpbmcgPSBlbmNvZGluZyAmJiBlbmNvZGluZyAhPT0gJ2J1ZmZlcicgPyBjLmZyb20oZW5jb2RpbmcpIDogbnVsbAoKICAgIHRoaXMucmVjZWl2ZWQgPSB0cnVlCgogICAgcmV0dXJuIGVuY29kaW5nCiAgICAgID8gdGhpcy5fcHJvbWlzZS50aGVuKChkYXRhKSA9PiBjLmRlY29kZShlbmNvZGluZywgZGF0YSkpCiAgICAgIDogdGhpcy5fcHJvbWlzZQogIH0KCiAgY3JlYXRlUmVxdWVzdFN0cmVhbShvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLnNlbnQpIHsKICAgICAgdGhyb3cgZXJyb3JzLkFMUkVBRFlfU0VOVCgnUmVxdWVzdCBoYXMgYWxyZWFkeSBiZWVuIHNlbnQnKQogICAgfQoKICAgIHRoaXMuc2VudCA9IHRydWUKCiAgICB0aGlzLnJwYy5fY3JlYXRlUmVxdWVzdFN0cmVhbSh0aGlzLCB0cnVlLCBvcHRzKQoKICAgIHJldHVybiB0aGlzLl9yZXF1ZXN0U3RyZWFtCiAgfQoKICBjcmVhdGVSZXNwb25zZVN0cmVhbShvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLnJlY2VpdmVkKSB7CiAgICAgIHRocm93IGVycm9ycy5BTFJFQURZX1JFQ0VJVkVEKCdSZXNwb25zZSBoYXMgYWxyZWFkeSBiZWVuIHJlY2VpdmVkJykKICAgIH0KCiAgICB0aGlzLnJlY2VpdmVkID0gdHJ1ZQoKICAgIHRoaXMucnBjLl9jcmVhdGVSZXNwb25zZVN0cmVhbSh0aGlzLCBmYWxzZSwgb3B0cykKCiAgICByZXR1cm4gdGhpcy5fcmVzcG9uc2VTdHJlYW0KICB9Cn0KY29uc3QgeyBXcml0YWJsZSB9ID0gcmVxdWlyZSgnYmFyZS1zdHJlYW0nKQpjb25zdCB7IHR5cGU6IHQsIHN0cmVhbTogcyB9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSUENPdXRnb2luZ1N0cmVhbSBleHRlbmRzIFdyaXRhYmxlIHsKICBjb25zdHJ1Y3RvcihycGMsIHJlcXVlc3QsIHR5cGUsIG9wdHMpIHsKICAgIHN1cGVyKHsgLi4ub3B0cywgZWFnZXJPcGVuOiB0cnVlIH0pCgogICAgdGhpcy5fcnBjID0gcnBjCiAgICB0aGlzLl9yZXF1ZXN0ID0gcmVxdWVzdAogICAgdGhpcy5fdHlwZSA9IHR5cGUKICAgIHRoaXMuX21hc2sgPSB0eXBlID09PSB0LlJFUVVFU1QgPyBzLlJFUVVFU1QgOiBzLlJFU1BPTlNFCgogICAgdGhpcy5fcGVuZGluZ09wZW4gPSBudWxsCiAgfQoKICBfb3BlbihjYikgewogICAgbGV0IHBlbmRpbmcKCiAgICBjb25zdCBvbmZsdXNoZWQgPSAoKSA9PiB7CiAgICAgIGlmIChwZW5kaW5nLmhhcyh0aGlzLl9yZXF1ZXN0LmlkKSkgewogICAgICAgIHBlbmRpbmcuZGVsZXRlKHRoaXMuX3JlcXVlc3QuaWQpCgogICAgICAgIGNiKG51bGwpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fcGVuZGluZ09wZW4gPSBjYgogICAgICB9CiAgICB9CgogICAgc3dpdGNoICh0aGlzLl90eXBlKSB7CiAgICAgIGNhc2UgdC5SRVFVRVNUOgogICAgICAgIHBlbmRpbmcgPSB0aGlzLl9ycGMuX3BlbmRpbmdSZXF1ZXN0cwoKICAgICAgICB0aGlzLl9ycGMuX3NlbmRNZXNzYWdlKAogICAgICAgICAgewogICAgICAgICAgICB0eXBlOiB0LlJFUVVFU1QsCiAgICAgICAgICAgIGlkOiB0aGlzLl9yZXF1ZXN0LmlkLAogICAgICAgICAgICBjb21tYW5kOiB0aGlzLl9yZXF1ZXN0LmNvbW1hbmQsCiAgICAgICAgICAgIHN0cmVhbTogcy5PUEVOLAogICAgICAgICAgICBkYXRhOiBudWxsCiAgICAgICAgICB9LAogICAgICAgICAgb25mbHVzaGVkCiAgICAgICAgKQogICAgICAgIGJyZWFrCgogICAgICBjYXNlIHQuUkVTUE9OU0U6CiAgICAgICAgcGVuZGluZyA9IHRoaXMuX3JwYy5fcGVuZGluZ1Jlc3BvbnNlcwoKICAgICAgICB0aGlzLl9ycGMuX3NlbmRNZXNzYWdlKAogICAgICAgICAgewogICAgICAgICAgICB0eXBlOiB0LlJFU1BPTlNFLAogICAgICAgICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgICAgICAgZXJyb3I6IGZhbHNlLAogICAgICAgICAgICBzdHJlYW06IHMuT1BFTiwKICAgICAgICAgICAgZGF0YTogbnVsbAogICAgICAgICAgfSwKICAgICAgICAgIG9uZmx1c2hlZAogICAgICAgICkKICAgICAgICBicmVhawogICAgfQogIH0KCiAgX2NvbnRpbnVlT3BlbigpIHsKICAgIGlmICh0aGlzLl9wZW5kaW5nT3BlbiA9PT0gbnVsbCkgcmV0dXJuCiAgICBjb25zdCBjYiA9IHRoaXMuX3BlbmRpbmdPcGVuCiAgICB0aGlzLl9wZW5kaW5nT3BlbiA9IG51bGwKICAgIGNiKCkKICB9CgogIF93cml0ZShkYXRhLCBlbmNvZGluZywgY2IpIHsKICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgIHsKICAgICAgICB0eXBlOiB0LlNUUkVBTSwKICAgICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgICBzdHJlYW06IHRoaXMuX21hc2sgfCBzLkRBVEEsCiAgICAgICAgZXJyb3I6IG51bGwsCiAgICAgICAgZGF0YQogICAgICB9LAogICAgICBjYgogICAgKQogIH0KCiAgX2ZpbmFsKGNiKSB7CiAgICB0aGlzLl9ycGMuX3NlbmRNZXNzYWdlKAogICAgICB7CiAgICAgICAgdHlwZTogdC5TVFJFQU0sCiAgICAgICAgaWQ6IHRoaXMuX3JlcXVlc3QuaWQsCiAgICAgICAgc3RyZWFtOiB0aGlzLl9tYXNrIHwgcy5FTkQsCiAgICAgICAgZXJyb3I6IG51bGwsCiAgICAgICAgZGF0YTogbnVsbAogICAgICB9LAogICAgICBjYgogICAgKQogIH0KCiAgX2Rlc3Ryb3koZXJyLCBjYikgewogICAgaWYgKGVycikgewogICAgICB0aGlzLl9ycGMuX3NlbmRNZXNzYWdlKAogICAgICAgIHsKICAgICAgICAgIHR5cGU6IHQuU1RSRUFNLAogICAgICAgICAgaWQ6IHRoaXMuX3JlcXVlc3QuaWQsCiAgICAgICAgICBzdHJlYW06IHRoaXMuX21hc2sgfCBzLkNMT1NFIHwgcy5FUlJPUiwKICAgICAgICAgIGVycm9yOiBlcnIsCiAgICAgICAgICBkYXRhOiBudWxsCiAgICAgICAgfSwKICAgICAgICBjYgogICAgICApCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9ycGMuX3NlbmRNZXNzYWdlKAogICAgICAgIHsKICAgICAgICAgIHR5cGU6IHQuU1RSRUFNLAogICAgICAgICAgaWQ6IHRoaXMuX3JlcXVlc3QuaWQsCiAgICAgICAgICBzdHJlYW06IHRoaXMuX21hc2sgfCBzLkNMT1NFLAogICAgICAgICAgZXJyb3I6IG51bGwsCiAgICAgICAgICBkYXRhOiBudWxsCiAgICAgICAgfSwKICAgICAgICBjYgogICAgICApCiAgICB9CiAgfQp9CnsKICAibmFtZSI6ICJiYXJlLXJwYyIsCiAgInZlcnNpb24iOiAiMC4yLjEzIiwKICAiZGVzY3JpcHRpb24iOiAibGlicnBjIEFCSSBjb21wYXRpYmxlIFJQQyBmb3IgQmFyZSIsCiAgImV4cG9ydHMiOiB7CiAgICAiLiI6IHsKICAgICAgInR5cGVzIjogIi4vaW5kZXguZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vaW5kZXguanMiCiAgICB9LAogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLi9lcnJvcnMiOiB7CiAgICAgICJ0eXBlcyI6ICIuL2xpYi9lcnJvcnMuZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vbGliL2Vycm9ycy5qcyIKICAgIH0KICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiaW5kZXguZC50cyIsCiAgICAibGliIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYmFyZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtcnBjLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtcnBjL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1ycGMjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjYiLAogICAgImJhcmUtc3RyZWFtIjogIl4yLjEuMyIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xNS4wIiwKICAgICJzYWZldHktY2F0Y2giOiAiXjEuMC4yIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWJ1ZmZlciI6ICJeMy4wLjEiLAogICAgImJhcmUtaXBjIjogIl4xLjEuMCIsCiAgICAiYnJpdHRsZSI6ICJeMy4yLjEiLAogICAgInByZXR0aWVyIjogIl4zLjQuMiIsCiAgICAicHJldHRpZXItY29uZmlnLXN0YW5kYXJkIjogIl43LjAuMCIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYnVmZmVyIjogIioiCiAgfSwKICAicGVlckRlcGVuZGVuY2llc01ldGEiOiB7CiAgICAiYmFyZS1idWZmZXIiOiB7CiAgICAgICJvcHRpb25hbCI6IHRydWUKICAgIH0KICB9Cn0KY29uc3Qgc3RyZWFtID0gcmVxdWlyZSgnc3RyZWFteCcpCgpjb25zdCBkZWZhdWx0RW5jb2RpbmcgPSAndXRmOCcKCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IHN0cmVhbS5TdHJlYW0KCmV4cG9ydHMucGlwZWxpbmUgPSBzdHJlYW0ucGlwZWxpbmUKCmV4cG9ydHMuaXNTdHJlYW0gPSBzdHJlYW0uaXNTdHJlYW0KZXhwb3J0cy5pc0VuZGVkID0gc3RyZWFtLmlzRW5kZWQKZXhwb3J0cy5pc0ZpbmlzaGVkID0gc3RyZWFtLmlzRmluaXNoZWQKZXhwb3J0cy5pc0Rpc3R1cmJlZCA9IHN0cmVhbS5pc0Rpc3R1cmJlZAoKZXhwb3J0cy5nZXRTdHJlYW1FcnJvciA9IHN0cmVhbS5nZXRTdHJlYW1FcnJvcgoKZXhwb3J0cy5TdHJlYW0gPSBleHBvcnRzCgpleHBvcnRzLlJlYWRhYmxlID0gY2xhc3MgUmVhZGFibGUgZXh0ZW5kcyBzdHJlYW0uUmVhZGFibGUgewogIGNvbnN0cnVjdG9yKG9wdHMgPSB7fSkgewogICAgc3VwZXIoewogICAgICAuLi5vcHRzLAogICAgICBieXRlTGVuZ3RoOiBudWxsLAogICAgICBieXRlTGVuZ3RoUmVhZGFibGU6IG51bGwsCiAgICAgIG1hcDogbnVsbCwKICAgICAgbWFwUmVhZGFibGU6IG51bGwKICAgIH0pCgogICAgaWYgKHRoaXMuX2NvbnN0cnVjdCkgdGhpcy5fb3BlbiA9IHRoaXMuX2NvbnN0cnVjdAoKICAgIGlmICh0aGlzLl9yZWFkICE9PSBzdHJlYW0uUmVhZGFibGUucHJvdG90eXBlLl9yZWFkKSB7CiAgICAgIHRoaXMuX3JlYWQgPSByZWFkLmJpbmQodGhpcywgdGhpcy5fcmVhZCkKICAgIH0KCiAgICBpZiAodGhpcy5fZGVzdHJveSAhPT0gc3RyZWFtLlN0cmVhbS5wcm90b3R5cGUuX2Rlc3Ryb3kpIHsKICAgICAgdGhpcy5fZGVzdHJveSA9IGRlc3Ryb3kuYmluZCh0aGlzLCB0aGlzLl9kZXN0cm95KQogICAgfQogIH0KCiAgcHVzaChjaHVuaywgZW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZykKICAgIH0KCiAgICByZXR1cm4gc3VwZXIucHVzaChjaHVuaykKICB9CgogIHVuc2hpZnQoY2h1bmssIGVuY29kaW5nKSB7CiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcpCiAgICB9CgogICAgc3VwZXIudW5zaGlmdChjaHVuaykKICB9Cn0KCmV4cG9ydHMuV3JpdGFibGUgPSBjbGFzcyBXcml0YWJsZSBleHRlbmRzIHN0cmVhbS5Xcml0YWJsZSB7CiAgY29uc3RydWN0b3Iob3B0cyA9IHt9KSB7CiAgICBzdXBlcih7CiAgICAgIC4uLm9wdHMsCiAgICAgIGJ5dGVMZW5ndGg6IG51bGwsCiAgICAgIGJ5dGVMZW5ndGhXcml0YWJsZSwKICAgICAgbWFwOiBudWxsLAogICAgICBtYXBXcml0YWJsZTogbnVsbAogICAgfSkKCiAgICBpZiAodGhpcy5fY29uc3RydWN0KSB0aGlzLl9vcGVuID0gdGhpcy5fY29uc3RydWN0CgogICAgaWYgKHRoaXMuX3dyaXRlICE9PSBzdHJlYW0uV3JpdGFibGUucHJvdG90eXBlLl93cml0ZSkgewogICAgICB0aGlzLl93cml0ZSA9IHdyaXRlLmJpbmQodGhpcywgdGhpcy5fd3JpdGUpCiAgICB9CgogICAgaWYgKHRoaXMuX2Rlc3Ryb3kgIT09IHN0cmVhbS5TdHJlYW0ucHJvdG90eXBlLl9kZXN0cm95KSB7CiAgICAgIHRoaXMuX2Rlc3Ryb3kgPSBkZXN0cm95LmJpbmQodGhpcywgdGhpcy5fZGVzdHJveSkKICAgIH0KICB9CgogIHdyaXRlKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSBlbmNvZGluZwogICAgICBlbmNvZGluZyA9IG51bGwKICAgIH0KCiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZwogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZykKICAgIH0gZWxzZSB7CiAgICAgIGVuY29kaW5nID0gJ2J1ZmZlcicKICAgIH0KCiAgICBjb25zdCByZXN1bHQgPSBzdXBlci53cml0ZSh7IGNodW5rLCBlbmNvZGluZyB9KQoKICAgIGlmIChjYikgc3RyZWFtLldyaXRhYmxlLmRyYWluZWQodGhpcykudGhlbigoKSA9PiBjYihudWxsKSwgY2IpCgogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgZW5kKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSBjaHVuawogICAgICBjaHVuayA9IG51bGwKICAgIH0gZWxzZSBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gZW5jb2RpbmcKICAgICAgZW5jb2RpbmcgPSBudWxsCiAgICB9CgogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nKQogICAgfSBlbHNlIHsKICAgICAgZW5jb2RpbmcgPSAnYnVmZmVyJwogICAgfQoKICAgIGNvbnN0IHJlc3VsdCA9CiAgICAgIGNodW5rICE9PSB1bmRlZmluZWQgJiYgY2h1bmsgIT09IG51bGwKICAgICAgICA/IHN1cGVyLmVuZCh7IGNodW5rLCBlbmNvZGluZyB9KQogICAgICAgIDogc3VwZXIuZW5kKCkKCiAgICBpZiAoY2IpIHRoaXMub25jZSgnZmluaXNoJywgKCkgPT4gY2IobnVsbCkpCgogICAgcmV0dXJuIHJlc3VsdAogIH0KfQoKZXhwb3J0cy5EdXBsZXggPSBjbGFzcyBEdXBsZXggZXh0ZW5kcyBzdHJlYW0uRHVwbGV4IHsKICBjb25zdHJ1Y3RvcihvcHRzID0ge30pIHsKICAgIHN1cGVyKHsKICAgICAgLi4ub3B0cywKICAgICAgYnl0ZUxlbmd0aDogbnVsbCwKICAgICAgYnl0ZUxlbmd0aFJlYWRhYmxlOiBudWxsLAogICAgICBieXRlTGVuZ3RoV3JpdGFibGUsCiAgICAgIG1hcDogbnVsbCwKICAgICAgbWFwUmVhZGFibGU6IG51bGwsCiAgICAgIG1hcFdyaXRhYmxlOiBudWxsCiAgICB9KQoKICAgIGlmICh0aGlzLl9jb25zdHJ1Y3QpIHRoaXMuX29wZW4gPSB0aGlzLl9jb25zdHJ1Y3QKCiAgICBpZiAodGhpcy5fcmVhZCAhPT0gc3RyZWFtLlJlYWRhYmxlLnByb3RvdHlwZS5fcmVhZCkgewogICAgICB0aGlzLl9yZWFkID0gcmVhZC5iaW5kKHRoaXMsIHRoaXMuX3JlYWQpCiAgICB9CgogICAgaWYgKHRoaXMuX3dyaXRlICE9PSBzdHJlYW0uRHVwbGV4LnByb3RvdHlwZS5fd3JpdGUpIHsKICAgICAgdGhpcy5fd3JpdGUgPSB3cml0ZS5iaW5kKHRoaXMsIHRoaXMuX3dyaXRlKQogICAgfQoKICAgIGlmICh0aGlzLl9kZXN0cm95ICE9PSBzdHJlYW0uU3RyZWFtLnByb3RvdHlwZS5fZGVzdHJveSkgewogICAgICB0aGlzLl9kZXN0cm95ID0gZGVzdHJveS5iaW5kKHRoaXMsIHRoaXMuX2Rlc3Ryb3kpCiAgICB9CiAgfQoKICBwdXNoKGNodW5rLCBlbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nKQogICAgfQoKICAgIHJldHVybiBzdXBlci5wdXNoKGNodW5rKQogIH0KCiAgdW5zaGlmdChjaHVuaywgZW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZykKICAgIH0KCiAgICBzdXBlci51bnNoaWZ0KGNodW5rKQogIH0KCiAgd3JpdGUoY2h1bmssIGVuY29kaW5nLCBjYikgewogICAgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGVuY29kaW5nCiAgICAgIGVuY29kaW5nID0gbnVsbAogICAgfQoKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nCiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nKQogICAgfSBlbHNlIHsKICAgICAgZW5jb2RpbmcgPSAnYnVmZmVyJwogICAgfQoKICAgIGNvbnN0IHJlc3VsdCA9IHN1cGVyLndyaXRlKHsgY2h1bmssIGVuY29kaW5nIH0pCgogICAgaWYgKGNiKSBzdHJlYW0uV3JpdGFibGUuZHJhaW5lZCh0aGlzKS50aGVuKCgpID0+IGNiKG51bGwpLCBjYikKCiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICBlbmQoY2h1bmssIGVuY29kaW5nLCBjYikgewogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGNodW5rCiAgICAgIGNodW5rID0gbnVsbAogICAgfSBlbHNlIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSBlbmNvZGluZwogICAgICBlbmNvZGluZyA9IG51bGwKICAgIH0KCiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZwogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZykKICAgIH0gZWxzZSB7CiAgICAgIGVuY29kaW5nID0gJ2J1ZmZlcicKICAgIH0KCiAgICBjb25zdCByZXN1bHQgPQogICAgICBjaHVuayAhPT0gdW5kZWZpbmVkICYmIGNodW5rICE9PSBudWxsCiAgICAgICAgPyBzdXBlci5lbmQoeyBjaHVuaywgZW5jb2RpbmcgfSkKICAgICAgICA6IHN1cGVyLmVuZCgpCgogICAgaWYgKGNiKSB0aGlzLm9uY2UoJ2ZpbmlzaCcsICgpID0+IGNiKG51bGwpKQoKICAgIHJldHVybiByZXN1bHQKICB9Cn0KCmV4cG9ydHMuVHJhbnNmb3JtID0gY2xhc3MgVHJhbnNmb3JtIGV4dGVuZHMgc3RyZWFtLlRyYW5zZm9ybSB7CiAgY29uc3RydWN0b3Iob3B0cyA9IHt9KSB7CiAgICBzdXBlcih7CiAgICAgIC4uLm9wdHMsCiAgICAgIGJ5dGVMZW5ndGg6IG51bGwsCiAgICAgIGJ5dGVMZW5ndGhSZWFkYWJsZTogbnVsbCwKICAgICAgYnl0ZUxlbmd0aFdyaXRhYmxlLAogICAgICBtYXA6IG51bGwsCiAgICAgIG1hcFJlYWRhYmxlOiBudWxsLAogICAgICBtYXBXcml0YWJsZTogbnVsbAogICAgfSkKCiAgICBpZiAodGhpcy5fdHJhbnNmb3JtICE9PSBzdHJlYW0uVHJhbnNmb3JtLnByb3RvdHlwZS5fdHJhbnNmb3JtKSB7CiAgICAgIHRoaXMuX3RyYW5zZm9ybSA9IHRyYW5zZm9ybS5iaW5kKHRoaXMsIHRoaXMuX3RyYW5zZm9ybSkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3RyYW5zZm9ybSA9IHBhc3N0aHJvdWdoCiAgICB9CiAgfQoKICBwdXNoKGNodW5rLCBlbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nKQogICAgfQoKICAgIHJldHVybiBzdXBlci5wdXNoKGNodW5rKQogIH0KCiAgdW5zaGlmdChjaHVuaywgZW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZykKICAgIH0KCiAgICBzdXBlci51bnNoaWZ0KGNodW5rKQogIH0KCiAgd3JpdGUoY2h1bmssIGVuY29kaW5nLCBjYikgewogICAgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGVuY29kaW5nCiAgICAgIGVuY29kaW5nID0gbnVsbAogICAgfQoKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nCiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nKQogICAgfSBlbHNlIHsKICAgICAgZW5jb2RpbmcgPSAnYnVmZmVyJwogICAgfQoKICAgIGNvbnN0IHJlc3VsdCA9IHN1cGVyLndyaXRlKHsgY2h1bmssIGVuY29kaW5nIH0pCgogICAgaWYgKGNiKSBzdHJlYW0uV3JpdGFibGUuZHJhaW5lZCh0aGlzKS50aGVuKCgpID0+IGNiKG51bGwpLCBjYikKCiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICBlbmQoY2h1bmssIGVuY29kaW5nLCBjYikgewogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGNodW5rCiAgICAgIGNodW5rID0gbnVsbAogICAgfSBlbHNlIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSBlbmNvZGluZwogICAgICBlbmNvZGluZyA9IG51bGwKICAgIH0KCiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZwogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZykKICAgIH0gZWxzZSB7CiAgICAgIGVuY29kaW5nID0gJ2J1ZmZlcicKICAgIH0KCiAgICBjb25zdCByZXN1bHQgPQogICAgICBjaHVuayAhPT0gdW5kZWZpbmVkICYmIGNodW5rICE9PSBudWxsCiAgICAgICAgPyBzdXBlci5lbmQoeyBjaHVuaywgZW5jb2RpbmcgfSkKICAgICAgICA6IHN1cGVyLmVuZCgpCgogICAgaWYgKGNiKSB0aGlzLm9uY2UoJ2ZpbmlzaCcsICgpID0+IGNiKG51bGwpKQoKICAgIHJldHVybiByZXN1bHQKICB9Cn0KCmV4cG9ydHMuUGFzc1Rocm91Z2ggPSBjbGFzcyBQYXNzVGhyb3VnaCBleHRlbmRzIGV4cG9ydHMuVHJhbnNmb3JtIHt9CgpleHBvcnRzLmZpbmlzaGVkID0gZnVuY3Rpb24gZmluaXNoZWQoc3RyZWFtLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGNvbnN0IHsgY2xlYW51cCA9IGZhbHNlIH0gPSBvcHRzCgogIGNvbnN0IGRvbmUgPSAoKSA9PiB7CiAgICBjYihleHBvcnRzLmdldFN0cmVhbUVycm9yKHN0cmVhbSwgeyBhbGw6IHRydWUgfSkpCgogICAgaWYgKGNsZWFudXApIGRldGFjaCgpCiAgfQoKICBjb25zdCBkZXRhY2ggPSAoKSA9PiB7CiAgICBzdHJlYW0ub2ZmKCdjbG9zZScsIGRvbmUpCiAgICBzdHJlYW0ub2ZmKCdlcnJvcicsIG5vb3ApCiAgfQoKICBpZiAoc3RyZWFtLmRlc3Ryb3llZCkgewogICAgZG9uZSgpCiAgfSBlbHNlIHsKICAgIHN0cmVhbS5vbignY2xvc2UnLCBkb25lKQogICAgc3RyZWFtLm9uKCdlcnJvcicsIG5vb3ApCiAgfQoKICByZXR1cm4gZGV0YWNoCn0KCmZ1bmN0aW9uIHJlYWQocmVhZCwgY2IpIHsKICByZWFkLmNhbGwodGhpcywgNjU1MzYpCgogIGNiKG51bGwpCn0KCmZ1bmN0aW9uIHdyaXRlKHdyaXRlLCBkYXRhLCBjYikgewogIHdyaXRlLmNhbGwodGhpcywgZGF0YS5jaHVuaywgZGF0YS5lbmNvZGluZywgY2IpCn0KCmZ1bmN0aW9uIHRyYW5zZm9ybSh0cmFuc2Zvcm0sIGRhdGEsIGNiKSB7CiAgdHJhbnNmb3JtLmNhbGwodGhpcywgZGF0YS5jaHVuaywgZGF0YS5lbmNvZGluZywgY2IpCn0KCmZ1bmN0aW9uIGRlc3Ryb3koZGVzdHJveSwgY2IpIHsKICBkZXN0cm95LmNhbGwodGhpcywgZXhwb3J0cy5nZXRTdHJlYW1FcnJvcih0aGlzKSwgY2IpCn0KCmZ1bmN0aW9uIHBhc3N0aHJvdWdoKGRhdGEsIGNiKSB7CiAgY2IobnVsbCwgZGF0YS5jaHVuaykKfQoKZnVuY3Rpb24gYnl0ZUxlbmd0aFdyaXRhYmxlKGRhdGEpIHsKICByZXR1cm4gZGF0YS5jaHVuay5ieXRlTGVuZ3RoCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQp7CiAgIm5hbWUiOiAiYmFyZS1zdHJlYW0iLAogICJ2ZXJzaW9uIjogIjIuNy4wIiwKICAiZGVzY3JpcHRpb24iOiAiU3RyZWFtaW5nIGRhdGEgZm9yIEphdmFTY3JpcHQiLAogICJleHBvcnRzIjogewogICAgIi4iOiB7CiAgICAgICJ0eXBlcyI6ICIuL2luZGV4LmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2luZGV4LmpzIgogICAgfSwKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4vcHJvbWlzZXMiOiAiLi9wcm9taXNlcy5qcyIsCiAgICAiLi93ZWIiOiB7CiAgICAgICJ0eXBlcyI6ICIuL3dlYi5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi93ZWIuanMiCiAgICB9LAogICAgIi4vZ2xvYmFsIjogIi4vZ2xvYmFsLmpzIgogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJpbmRleC5kLnRzIiwKICAgICJwcm9taXNlcy5qcyIsCiAgICAid2ViLmpzIiwKICAgICJ3ZWIuZC50cyIsCiAgICAiZ2xvYmFsLmpzIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYmFyZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtc3RyZWFtLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtc3RyZWFtL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1zdHJlYW0jcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgInN0cmVhbXgiOiAiXjIuMjEuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1idWZmZXIiOiAiXjMuMC4wIiwKICAgICJiYXJlLWV2ZW50cyI6ICJeMi41LjQiLAogICAgImJyaXR0bGUiOiAiXjMuNS4yIiwKICAgICJwcmV0dGllciI6ICJeMy4zLjMiLAogICAgInByZXR0aWVyLWNvbmZpZy1zdGFuZGFyZCI6ICJeNy4wLjAiCiAgfSwKICAicGVlckRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWJ1ZmZlciI6ICIqIiwKICAgICJiYXJlLWV2ZW50cyI6ICIqIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXNNZXRhIjogewogICAgImJhcmUtYnVmZmVyIjogewogICAgICAib3B0aW9uYWwiOiB0cnVlCiAgICB9LAogICAgImJhcmUtZXZlbnRzIjogewogICAgICAib3B0aW9uYWwiOiB0cnVlCiAgICB9CiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZS5hZGRvbigpCmNvbnN0IHBhdGggPSByZXF1aXJlKCdiYXJlLXBhdGgnKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi9iaW5kaW5nJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi9saWIvZXJyb3JzJykKY29uc3QgVVJMU2VhcmNoUGFyYW1zID0gcmVxdWlyZSgnLi9saWIvdXJsLXNlYXJjaC1wYXJhbXMnKQoKY29uc3Qga2luZCA9IFN5bWJvbC5mb3IoJ2JhcmUudXJsLmtpbmQnKQoKY29uc3QgaXNXaW5kb3dzID0gQmFyZS5wbGF0Zm9ybSA9PT0gJ3dpbjMyJwoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gY2xhc3MgVVJMIHsKICBzdGF0aWMgZ2V0IFtraW5kXSgpIHsKICAgIHJldHVybiAwIC8vIENvbXBhdGliaWxpdHkgdmVyc2lvbgogIH0KCiAgY29uc3RydWN0b3IoaW5wdXQsIGJhc2UsIG9wdHMgPSB7fSkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHRocm93IGVycm9ycy5JTlZBTElEX1VSTCgpCgogICAgaW5wdXQgPSBTdHJpbmcoaW5wdXQpCgogICAgaWYgKGJhc2UgIT09IHVuZGVmaW5lZCkgYmFzZSA9IFN0cmluZyhiYXNlKQoKICAgIHRoaXMuX2NvbXBvbmVudHMgPSBuZXcgVWludDMyQXJyYXkoOCkKCiAgICB0aGlzLl9wYXJzZShpbnB1dCwgYmFzZSwgb3B0cy50aHJvdyAhPT0gZmFsc2UpCgogICAgaWYgKHRoaXMuX2hyZWYpIHRoaXMuX3BhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXModGhpcy5zZWFyY2gsIHRoaXMpCiAgfQoKICBnZXQgW2tpbmRdKCkgewogICAgcmV0dXJuIFVSTFtraW5kXQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsLWhyZWYKCiAgZ2V0IGhyZWYoKSB7CiAgICByZXR1cm4gdGhpcy5faHJlZgogIH0KCiAgc2V0IGhyZWYodmFsdWUpIHsKICAgIHRoaXMuX3VwZGF0ZSh2YWx1ZSkKCiAgICB0aGlzLl9wYXJhbXMuX3BhcnNlKHRoaXMuc2VhcmNoKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsLXByb3RvY29sCgogIGdldCBwcm90b2NvbCgpIHsKICAgIHJldHVybiB0aGlzLl9zbGljZSgwLCB0aGlzLl9jb21wb25lbnRzWzBdKSArICc6JwogIH0KCiAgc2V0IHByb3RvY29sKHZhbHVlKSB7CiAgICB0aGlzLl91cGRhdGUodGhpcy5fcmVwbGFjZSh2YWx1ZS5yZXBsYWNlKC86KyQvLCAnJyksIDAsIHRoaXMuX2NvbXBvbmVudHNbMF0pKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsLXVzZXJuYW1lCgogIGdldCB1c2VybmFtZSgpIHsKICAgIHJldHVybiB0aGlzLl9zbGljZSh0aGlzLl9jb21wb25lbnRzWzBdICsgMyAvKiA6Ly8gKi8sIHRoaXMuX2NvbXBvbmVudHNbMV0pCiAgfQoKICBzZXQgdXNlcm5hbWUodmFsdWUpIHsKICAgIGlmIChjYW5ub3RIYXZlQ3JlZGVudGlhbHNPclBvcnQodGhpcykpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMudXNlcm5hbWUgPT09ICcnKSB2YWx1ZSArPSAnQCcKCiAgICB0aGlzLl91cGRhdGUodGhpcy5fcmVwbGFjZSh2YWx1ZSwgdGhpcy5fY29tcG9uZW50c1swXSArIDMgLyogOi8vICovLCB0aGlzLl9jb21wb25lbnRzWzFdKSkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1wYXNzd29yZAoKICBnZXQgcGFzc3dvcmQoKSB7CiAgICByZXR1cm4gdGhpcy5faHJlZi5zbGljZSh0aGlzLl9jb21wb25lbnRzWzFdICsgMSAvKiA6ICovLCB0aGlzLl9jb21wb25lbnRzWzJdIC0gMSAvKiBAICovKQogIH0KCiAgc2V0IHBhc3N3b3JkKHZhbHVlKSB7CiAgICBpZiAoY2Fubm90SGF2ZUNyZWRlbnRpYWxzT3JQb3J0KHRoaXMpKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGxldCBzdGFydCA9IHRoaXMuX2NvbXBvbmVudHNbMV0gKyAxIC8qIDogKi8KICAgIGxldCBlbmQgPSB0aGlzLl9jb21wb25lbnRzWzJdIC0gMSAvKiBAICovCgogICAgaWYgKHRoaXMucGFzc3dvcmQgPT09ICcnKSB7CiAgICAgIHZhbHVlID0gJzonICsgdmFsdWUKICAgICAgc3RhcnQtLQogICAgfQoKICAgIGlmICh0aGlzLnVzZXJuYW1lID09PSAnJykgewogICAgICB2YWx1ZSArPSAnQCcKICAgICAgZW5kKysKICAgIH0KCiAgICB0aGlzLl91cGRhdGUodGhpcy5fcmVwbGFjZSh2YWx1ZSwgc3RhcnQsIGVuZCkpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtaG9zdAoKICBnZXQgaG9zdCgpIHsKICAgIHJldHVybiB0aGlzLl9zbGljZSh0aGlzLl9jb21wb25lbnRzWzJdLCB0aGlzLl9jb21wb25lbnRzWzVdKQogIH0KCiAgc2V0IGhvc3QodmFsdWUpIHsKICAgIGlmIChoYXNPcGFxdWVQYXRoKHRoaXMpKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuX3VwZGF0ZSgKICAgICAgdGhpcy5fcmVwbGFjZSh2YWx1ZSwgdGhpcy5fY29tcG9uZW50c1syXSwgdGhpcy5fY29tcG9uZW50c1t2YWx1ZS5pbmNsdWRlcygnOicpID8gNSA6IDNdKQogICAgKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsLWhvc3RuYW1lCgogIGdldCBob3N0bmFtZSgpIHsKICAgIHJldHVybiB0aGlzLl9zbGljZSh0aGlzLl9jb21wb25lbnRzWzJdLCB0aGlzLl9jb21wb25lbnRzWzNdKQogIH0KCiAgc2V0IGhvc3RuYW1lKHZhbHVlKSB7CiAgICBpZiAoaGFzT3BhcXVlUGF0aCh0aGlzKSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLl91cGRhdGUodGhpcy5fcmVwbGFjZSh2YWx1ZSwgdGhpcy5fY29tcG9uZW50c1syXSwgdGhpcy5fY29tcG9uZW50c1szXSkpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtcG9ydAoKICBnZXQgcG9ydCgpIHsKICAgIHJldHVybiB0aGlzLl9zbGljZSh0aGlzLl9jb21wb25lbnRzWzNdICsgMSAvKiA6ICovLCB0aGlzLl9jb21wb25lbnRzWzVdKQogIH0KCiAgc2V0IHBvcnQodmFsdWUpIHsKICAgIGlmIChjYW5ub3RIYXZlQ3JlZGVudGlhbHNPclBvcnQodGhpcykpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgbGV0IHN0YXJ0ID0gdGhpcy5fY29tcG9uZW50c1szXSArIDEgLyogOiAqLwoKICAgIGlmICh0aGlzLnBvcnQgPT09ICcnKSB7CiAgICAgIHZhbHVlID0gJzonICsgdmFsdWUKICAgICAgc3RhcnQtLQogICAgfQoKICAgIHRoaXMuX3VwZGF0ZSh0aGlzLl9yZXBsYWNlKHZhbHVlLCBzdGFydCwgdGhpcy5fY29tcG9uZW50c1s1XSkpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtcGF0aG5hbWUKCiAgZ2V0IHBhdGhuYW1lKCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKHRoaXMuX2NvbXBvbmVudHNbNV0sIHRoaXMuX2NvbXBvbmVudHNbNl0gLSAxIC8qID8gKi8pCiAgfQoKICBzZXQgcGF0aG5hbWUodmFsdWUpIHsKICAgIGlmIChoYXNPcGFxdWVQYXRoKHRoaXMpKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh2YWx1ZVswXSAhPT0gJy8nICYmIHZhbHVlWzBdICE9PSAnXFwnKSB7CiAgICAgIHZhbHVlID0gJy8nICsgdmFsdWUKICAgIH0KCiAgICB0aGlzLl91cGRhdGUodGhpcy5fcmVwbGFjZSh2YWx1ZSwgdGhpcy5fY29tcG9uZW50c1s1XSwgdGhpcy5fY29tcG9uZW50c1s2XSAtIDEgLyogPyAqLykpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtc2VhcmNoCgogIGdldCBzZWFyY2goKSB7CiAgICByZXR1cm4gdGhpcy5fc2xpY2UodGhpcy5fY29tcG9uZW50c1s2XSAtIDEgLyogPyAqLywgdGhpcy5fY29tcG9uZW50c1s3XSAtIDEgLyogIyAqLykKICB9CgogIHNldCBzZWFyY2godmFsdWUpIHsKICAgIGlmICh2YWx1ZSAmJiB2YWx1ZVswXSAhPT0gJz8nKSB2YWx1ZSA9ICc/JyArIHZhbHVlCgogICAgdGhpcy5fdXBkYXRlKAogICAgICB0aGlzLl9yZXBsYWNlKHZhbHVlLCB0aGlzLl9jb21wb25lbnRzWzZdIC0gMSAvKiA/ICovLCB0aGlzLl9jb21wb25lbnRzWzddIC0gMSAvKiAjICovKQogICAgKQoKICAgIHRoaXMuX3BhcmFtcy5fcGFyc2UodGhpcy5zZWFyY2gpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtc2VhcmNocGFyYW1zCgogIGdldCBzZWFyY2hQYXJhbXMoKSB7CiAgICByZXR1cm4gdGhpcy5fcGFyYW1zCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtaGFzaAoKICBnZXQgaGFzaCgpIHsKICAgIHJldHVybiB0aGlzLl9zbGljZSh0aGlzLl9jb21wb25lbnRzWzddIC0gMSAvKiAjICovKQogIH0KCiAgc2V0IGhhc2godmFsdWUpIHsKICAgIGlmICh2YWx1ZSAmJiB2YWx1ZVswXSAhPT0gJyMnKSB2YWx1ZSA9ICcjJyArIHZhbHVlCgogICAgdGhpcy5fdXBkYXRlKHRoaXMuX3JlcGxhY2UodmFsdWUsIHRoaXMuX2NvbXBvbmVudHNbN10gLSAxIC8qICMgKi8pKQogIH0KCiAgdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5faHJlZgogIH0KCiAgdG9KU09OKCkgewogICAgcmV0dXJuIHRoaXMuX2hyZWYKICB9CgogIFtTeW1ib2wuZm9yKCdiYXJlLmluc3BlY3QnKV0oKSB7CiAgICByZXR1cm4gewogICAgICBfX3Byb3RvX186IHsgY29uc3RydWN0b3I6IFVSTCB9LAoKICAgICAgaHJlZjogdGhpcy5ocmVmLAogICAgICBwcm90b2NvbDogdGhpcy5wcm90b2NvbCwKICAgICAgdXNlcm5hbWU6IHRoaXMudXNlcm5hbWUsCiAgICAgIHBhc3N3b3JkOiB0aGlzLnBhc3N3b3JkLAogICAgICBob3N0OiB0aGlzLmhvc3QsCiAgICAgIGhvc3RuYW1lOiB0aGlzLmhvc3RuYW1lLAogICAgICBwb3J0OiB0aGlzLnBvcnQsCiAgICAgIHBhdGhuYW1lOiB0aGlzLnBhdGhuYW1lLAogICAgICBzZWFyY2g6IHRoaXMuc2VhcmNoLAogICAgICBzZWFyY2hQYXJhbXM6IHRoaXMuc2VhcmNoUGFyYW1zLAogICAgICBoYXNoOiB0aGlzLmhhc2gKICAgIH0KICB9CgogIF9zbGljZShzdGFydCwgZW5kID0gdGhpcy5faHJlZi5sZW5ndGgpIHsKICAgIHJldHVybiB0aGlzLl9ocmVmLnNsaWNlKHN0YXJ0LCBlbmQpCiAgfQoKICBfcmVwbGFjZShyZXBsYWNlbWVudCwgc3RhcnQsIGVuZCA9IHRoaXMuX2hyZWYubGVuZ3RoKSB7CiAgICByZXR1cm4gdGhpcy5fc2xpY2UoMCwgc3RhcnQpICsgcmVwbGFjZW1lbnQgKyB0aGlzLl9zbGljZShlbmQpCiAgfQoKICBfcGFyc2UoaW5wdXQsIGJhc2UsIHNob3VsZFRocm93KSB7CiAgICB0cnkgewogICAgICB0aGlzLl9ocmVmID0gYmluZGluZy5wYXJzZSgKICAgICAgICBTdHJpbmcoaW5wdXQpLAogICAgICAgIGJhc2UgPyBTdHJpbmcoYmFzZSkgOiBudWxsLAogICAgICAgIHRoaXMuX2NvbXBvbmVudHMsCiAgICAgICAgc2hvdWxkVGhyb3cKICAgICAgKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBUeXBlRXJyb3IpIHRocm93IGVycgoKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfVVJMKGBJbnZhbGlkIFVSTCAnJHtpbnB1dH0nYCwgaW5wdXQpCiAgICB9CiAgfQoKICBfdXBkYXRlKGlucHV0KSB7CiAgICB0cnkgewogICAgICB0aGlzLl9wYXJzZShpbnB1dCwgbnVsbCwgdHJ1ZSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAoZXJyIGluc3RhbmNlb2YgVHlwZUVycm9yKSB0aHJvdyBlcnIKICAgIH0KICB9Cn0KCi8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jdXJsLW9wYXF1ZS1wYXRoCmZ1bmN0aW9uIGhhc09wYXF1ZVBhdGgodXJsKSB7CiAgcmV0dXJuIHVybC5wYXRobmFtZVswXSAhPT0gJy8nCn0KCi8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jY2Fubm90LWhhdmUtYS11c2VybmFtZS1wYXNzd29yZC1wb3J0CmZ1bmN0aW9uIGNhbm5vdEhhdmVDcmVkZW50aWFsc09yUG9ydCh1cmwpIHsKICByZXR1cm4gdXJsLmhvc3RuYW1lID09PSAnJyB8fCB1cmwucHJvdG9jb2wgPT09ICdmaWxlOicKfQoKY29uc3QgVVJMID0gZXhwb3J0cwoKZXhwb3J0cy5VUkwgPSBVUkwKZXhwb3J0cy5VUkxTZWFyY2hQYXJhbXMgPSBVUkxTZWFyY2hQYXJhbXMKCmV4cG9ydHMuZXJyb3JzID0gZXJyb3JzCgpleHBvcnRzLmlzVVJMID0gZnVuY3Rpb24gaXNVUkwodmFsdWUpIHsKICBpZiAodmFsdWUgaW5zdGFuY2VvZiBVUkwpIHJldHVybiB0cnVlCgogIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIHZhbHVlICE9PSBudWxsICYmIHZhbHVlW2tpbmRdID09PSBVUkxba2luZF0KfQoKLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsLXBhcnNlCmV4cG9ydHMucGFyc2UgPSBmdW5jdGlvbiBwYXJzZShpbnB1dCwgYmFzZSkgewogIGNvbnN0IHVybCA9IG5ldyBVUkwoaW5wdXQsIGJhc2UsIHsgdGhyb3c6IGZhbHNlIH0pCiAgcmV0dXJuIHVybC5faHJlZiA/IHVybCA6IG51bGwKfQoKLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsLWNhbnBhcnNlCmV4cG9ydHMuY2FuUGFyc2UgPSBmdW5jdGlvbiBjYW5QYXJzZShpbnB1dCwgYmFzZSkgewogIHJldHVybiBiaW5kaW5nLmNhblBhcnNlKFN0cmluZyhpbnB1dCksIGJhc2UgPyBTdHJpbmcoYmFzZSkgOiBudWxsKQp9CgpleHBvcnRzLmZpbGVVUkxUb1BhdGggPSBmdW5jdGlvbiBmaWxlVVJMVG9QYXRoKHVybCkgewogIGlmICh0eXBlb2YgdXJsID09PSAnc3RyaW5nJykgewogICAgdXJsID0gbmV3IFVSTCh1cmwpCiAgfQoKICBpZiAodXJsLnByb3RvY29sICE9PSAnZmlsZTonKSB7CiAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9VUkxfU0NIRU1FKCdUaGUgVVJMIG11c3QgdXNlIHRoZSBmaWxlOiBwcm90b2NvbCcpCiAgfQoKICBpZiAoaXNXaW5kb3dzKSB7CiAgICBpZiAoLyUyZnwlNWMvaS50ZXN0KHVybC5wYXRobmFtZSkpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfRklMRV9VUkxfUEFUSCgKICAgICAgICAnVGhlIGZpbGU6IFVSTCBwYXRoIG11c3Qgbm90IGluY2x1ZGUgZW5jb2RlZCBcXCBvciAvIGNoYXJhY3RlcnMnCiAgICAgICkKICAgIH0KICB9IGVsc2UgewogICAgaWYgKHVybC5ob3N0bmFtZSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9GSUxFX1VSTF9IT1NUKCJUaGUgZmlsZTogVVJMIGhvc3QgbXVzdCBiZSAnbG9jYWxob3N0JyBvciBlbXB0eSIpCiAgICB9CgogICAgaWYgKC8lMmYvaS50ZXN0KHVybC5wYXRobmFtZSkpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfRklMRV9VUkxfUEFUSCgnVGhlIGZpbGU6IFVSTCBwYXRoIG11c3Qgbm90IGluY2x1ZGUgZW5jb2RlZCAvIGNoYXJhY3RlcnMnKQogICAgfQogIH0KCiAgY29uc3QgcGF0aG5hbWUgPSBwYXRoLm5vcm1hbGl6ZShkZWNvZGVVUklDb21wb25lbnQodXJsLnBhdGhuYW1lKSkKCiAgaWYgKGlzV2luZG93cykgewogICAgaWYgKHVybC5ob3N0bmFtZSkgcmV0dXJuICdcXFxcJyArIHVybC5ob3N0bmFtZSArIHBhdGhuYW1lCgogICAgY29uc3QgbGV0dGVyID0gcGF0aG5hbWUuY2hhckNvZGVBdCgxKSB8IDB4MjAKCiAgICBpZiAobGV0dGVyIDwgMHg2MSAvKiBhICovIHx8IGxldHRlciA+IDB4N2EgLyogeiAqLyB8fCBwYXRobmFtZS5jaGFyQ29kZUF0KDIpICE9PSAweDNhIC8qIDogKi8pIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfRklMRV9VUkxfUEFUSCgnVGhlIGZpbGU6IFVSTCBwYXRoIG11c3QgYmUgYWJzb2x1dGUnKQogICAgfQoKICAgIHJldHVybiBwYXRobmFtZS5zbGljZSgxKQogIH0KCiAgcmV0dXJuIHBhdGhuYW1lCn0KCmV4cG9ydHMucGF0aFRvRmlsZVVSTCA9IGZ1bmN0aW9uIHBhdGhUb0ZpbGVVUkwocGF0aG5hbWUpIHsKICBsZXQgcmVzb2x2ZWQgPSBwYXRoLnJlc29sdmUocGF0aG5hbWUpCgogIGlmIChwYXRobmFtZVtwYXRobmFtZS5sZW5ndGggLSAxXSA9PT0gJy8nKSB7CiAgICByZXNvbHZlZCArPSAnLycKICB9IGVsc2UgaWYgKGlzV2luZG93cyAmJiBwYXRobmFtZVtwYXRobmFtZS5sZW5ndGggLSAxXSA9PT0gJ1xcJykgewogICAgcmVzb2x2ZWQgKz0gJ1xcJwogIH0KCiAgcmVzb2x2ZWQgPSByZXNvbHZlZAogICAgLnJlcGxhY2VBbGwoJyUnLCAnJTI1JykgLy8gTXVzdCBiZSBmaXJzdAogICAgLnJlcGxhY2VBbGwoJyMnLCAnJTIzJykKICAgIC5yZXBsYWNlQWxsKCc/JywgJyUzZicpCiAgICAucmVwbGFjZUFsbCgnXG4nLCAnJTBhJykKICAgIC5yZXBsYWNlQWxsKCdccicsICclMGQnKQogICAgLnJlcGxhY2VBbGwoJ1x0JywgJyUwOScpCgogIGlmICghaXNXaW5kb3dzKSB7CiAgICByZXNvbHZlZCA9IHJlc29sdmVkLnJlcGxhY2VBbGwoJ1xcJywgJyU1YycpCiAgfQoKICByZXR1cm4gbmV3IFVSTCgnZmlsZTonICsgcmVzb2x2ZWQpCn0KCmV4cG9ydHMuZm9ybWF0ID0gZnVuY3Rpb24gZm9ybWF0KHBhcnRzKSB7CiAgY29uc3QgeyBwcm90b2NvbCwgYXV0aCwgaG9zdCwgaG9zdG5hbWUsIHBvcnQsIHBhdGhuYW1lLCBzZWFyY2gsIHF1ZXJ5LCBoYXNoLCBzbGFzaGVzIH0gPSBwYXJ0cwoKICBsZXQgcmVzdWx0ID0gJycKCiAgaWYgKHR5cGVvZiBwcm90b2NvbCA9PT0gJ3N0cmluZycpIHsKICAgIHJlc3VsdCArPSBwcm90b2NvbAoKICAgIGlmIChwcm90b2NvbFtwcm90b2NvbC5sZW5ndGggLSAxXSAhPT0gJzonKSB7CiAgICAgIHJlc3VsdCArPSAnOicKICAgIH0KCiAgICBpZiAoc2xhc2hlcyA9PT0gdHJ1ZSB8fCAvaHR0cHM/fGZ0cHxnb3BoZXJ8ZmlsZS8udGVzdChwcm90b2NvbCkpIHsKICAgICAgcmVzdWx0ICs9ICcvLycKICAgIH0KICB9CgogIGlmICh0eXBlb2YgYXV0aCA9PT0gJ3N0cmluZycpIHsKICAgIGlmIChob3N0IHx8IGhvc3RuYW1lKSByZXN1bHQgKz0gYXV0aCArICdAJwogIH0KCiAgaWYgKHR5cGVvZiBob3N0ID09PSAnc3RyaW5nJykgcmVzdWx0ICs9IGhvc3QKICBlbHNlIHsKICAgIHJlc3VsdCArPSBob3N0bmFtZQoKICAgIGlmIChwb3J0KSByZXN1bHQgKz0gJzonICsgcG9ydAogIH0KCiAgaWYgKHR5cGVvZiBwYXRobmFtZSA9PT0gJ3N0cmluZycgJiYgcGF0aG5hbWUgIT09ICcnKSB7CiAgICBpZiAocGF0aG5hbWVbMF0gIT09ICcvJykgcmVzdWx0ICs9ICcvJwogICAgcmVzdWx0ICs9IHBhdGhuYW1lCiAgfQoKICBpZiAodHlwZW9mIHNlYXJjaCA9PT0gJ3N0cmluZycpIHsKICAgIGlmIChzZWFyY2hbMF0gIT09ICc/JykgcmVzdWx0ICs9ICc/JwogICAgcmVzdWx0ICs9IHNlYXJjaAogIH0gZWxzZSBpZiAodHlwZW9mIHF1ZXJ5ID09PSAnb2JqZWN0JyAmJiBxdWVyeSAhPT0gbnVsbCkgewogICAgcmVzdWx0ICs9ICc/JyArIG5ldyBVUkxTZWFyY2hQYXJhbXMocXVlcnkpCiAgfQoKICBpZiAodHlwZW9mIGhhc2ggPT09ICdzdHJpbmcnKSB7CiAgICBpZiAoaGFzaFswXSAhPT0gJyMnKSByZXN1bHQgKz0gJyMnCiAgICByZXN1bHQgKz0gaGFzaAogIH0KCiAgcmV0dXJuIHJlc3VsdAp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVVJMRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobXNnLCBmbiA9IFVSTEVycm9yLCBjb2RlID0gZm4ubmFtZSkgewogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWApCgogICAgdGhpcy5jb2RlID0gY29kZQoKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgZm4pCiAgfQoKICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiAnVVJMRXJyb3InCiAgfQoKICBzdGF0aWMgSU5WQUxJRF9VUkwobXNnLCBpbnB1dCkgewogICAgY29uc3QgZXJyID0gbmV3IFVSTEVycm9yKG1zZywgVVJMRXJyb3IuSU5WQUxJRF9VUkwpCgogICAgZXJyLmlucHV0ID0gaW5wdXQKCiAgICByZXR1cm4gZXJyCiAgfQoKICBzdGF0aWMgSU5WQUxJRF9VUkxfU0NIRU1FKG1zZyA9ICdJbnZhbGlkIFVSTCcpIHsKICAgIHJldHVybiBuZXcgVVJMRXJyb3IobXNnLCBVUkxFcnJvci5JTlZBTElEX1VSTF9TQ0hFTUUpCiAgfQoKICBzdGF0aWMgSU5WQUxJRF9GSUxFX1VSTF9IT1NUKG1zZyA9ICdJbnZhbGlkIGZpbGU6IFVSTCBob3N0JykgewogICAgcmV0dXJuIG5ldyBVUkxFcnJvcihtc2csIFVSTEVycm9yLklOVkFMSURfRklMRV9VUkxfSE9TVCkKICB9CgogIHN0YXRpYyBJTlZBTElEX0ZJTEVfVVJMX1BBVEgobXNnID0gJ0ludmFsaWQgZmlsZTogVVJMIHBhdGgnKSB7CiAgICByZXR1cm4gbmV3IFVSTEVycm9yKG1zZywgVVJMRXJyb3IuSU5WQUxJRF9GSUxFX1VSTF9QQVRIKQogIH0KfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFVSTFNlYXJjaFBhcmFtcyB7CiAgc3RhdGljIF91cmxzID0gbmV3IFdlYWtNYXAoKQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmxzZWFyY2hwYXJhbXMtdXJsc2VhcmNocGFyYW1zCiAgY29uc3RydWN0b3IoaW5pdCwgdXJsID0gbnVsbCkgewogICAgdGhpcy5fcGFyYW1zID0gbmV3IE1hcCgpCgogICAgaWYgKHVybCkgVVJMU2VhcmNoUGFyYW1zLl91cmxzLnNldCh0aGlzLCB1cmwpCgogICAgaWYgKHR5cGVvZiBpbml0ID09PSAnc3RyaW5nJykgewogICAgICB0aGlzLl9wYXJzZShpbml0KQogICAgfSBlbHNlIGlmIChpbml0KSB7CiAgICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiB0eXBlb2YgaW5pdFtTeW1ib2wuaXRlcmF0b3JdID09PSAnZnVuY3Rpb24nCiAgICAgICAgPyBpbml0CiAgICAgICAgOiBPYmplY3QuZW50cmllcyhpbml0KSkgewogICAgICAgIHRoaXMuYXBwZW5kKG5hbWUsIHZhbHVlKQogICAgICB9CiAgICB9CiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmxzZWFyY2hwYXJhbXMtc2l6ZQogIGdldCBzaXplKCkgewogICAgcmV0dXJuIHRoaXMuX3BhcmFtcy5sZW5ndGgKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybHNlYXJjaHBhcmFtcy1hcHBlbmQKICBhcHBlbmQobmFtZSwgdmFsdWUgPSBudWxsKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwpIHJldHVybgoKICAgIGxldCBsaXN0ID0gdGhpcy5fcGFyYW1zLmdldChuYW1lKQoKICAgIGlmIChsaXN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgbGlzdCA9IFtdCiAgICAgIHRoaXMuX3BhcmFtcy5zZXQobmFtZSwgbGlzdCkKICAgIH0KCiAgICBsaXN0LnB1c2godmFsdWUpCgogICAgdGhpcy5fdXBkYXRlKCkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybHNlYXJjaHBhcmFtcy1kZWxldGUKICBkZWxldGUobmFtZSwgdmFsdWUgPSBudWxsKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwpIHRoaXMuX3BhcmFtcy5kZWxldGUobmFtZSkKICAgIGVsc2UgewogICAgICBsZXQgbGlzdCA9IHRoaXMuX3BhcmFtcy5nZXQobmFtZSkKCiAgICAgIGlmIChsaXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgbGlzdCA9IGxpc3QuZmlsdGVyKChmb3VuZCkgPT4gZm91bmQgIT09IHZhbHVlKQoKICAgICAgaWYgKGxpc3QubGVuZ3RoID09PSAwKSB0aGlzLl9wYXJhbXMuZGVsZXRlKG5hbWUpCiAgICAgIGVsc2UgdGhpcy5fcGFyYW1zLnNldChuYW1lLCBsaXN0KQogICAgfQoKICAgIHRoaXMuX3VwZGF0ZSgpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmxzZWFyY2hwYXJhbXMtZ2V0CiAgZ2V0KG5hbWUpIHsKICAgIGNvbnN0IGxpc3QgPSB0aGlzLl9wYXJhbXMuZ2V0KG5hbWUpCgogICAgaWYgKGxpc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGwKCiAgICByZXR1cm4gbGlzdFswXQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsc2VhcmNocGFyYW1zLWdldGFsbAogIGdldEFsbChuYW1lKSB7CiAgICBjb25zdCBsaXN0ID0gdGhpcy5fcGFyYW1zLmdldChuYW1lKQoKICAgIGlmIChsaXN0ID09PSB1bmRlZmluZWQpIHJldHVybiBbXQoKICAgIHJldHVybiBBcnJheS5mcm9tKGxpc3QpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmxzZWFyY2hwYXJhbXMtaGFzCiAgaGFzKG5hbWUsIHZhbHVlID0gbnVsbCkgewogICAgY29uc3QgbGlzdCA9IHRoaXMuX3BhcmFtcy5nZXQobmFtZSkKCiAgICBpZiAobGlzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2UKCiAgICBpZiAodmFsdWUgPT09IG51bGwpIHJldHVybiB0cnVlCgogICAgcmV0dXJuIGxpc3QuaW5jbHVkZXModmFsdWUpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmxzZWFyY2hwYXJhbXMtc2V0CiAgc2V0KG5hbWUsIHZhbHVlID0gbnVsbCkgewogICAgaWYgKHZhbHVlID09PSBudWxsKSB0aGlzLl9wYXJhbXMuZGVsZXRlKG5hbWUpCiAgICBlbHNlIHRoaXMuX3BhcmFtcy5zZXQobmFtZSwgW3ZhbHVlXSkKCiAgICB0aGlzLl91cGRhdGUoKQogIH0KCiAgdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5fc2VyaWFsaXplKCkKICB9CgogIHRvSlNPTigpIHsKICAgIHJldHVybiBbLi4udGhpc10KICB9CgogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlc10gb2YgdGhpcy5fcGFyYW1zKSB7CiAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKSB5aWVsZCBbbmFtZSwgdmFsdWVdCiAgICB9CiAgfQoKICBbU3ltYm9sLmZvcignYmFyZS5pbnNwZWN0JyldKCkgewogICAgY29uc3Qgb2JqZWN0ID0gewogICAgICBfX3Byb3RvX186IHsgY29uc3RydWN0b3I6IFVSTFNlYXJjaFBhcmFtcyB9CiAgICB9CgogICAgZm9yIChjb25zdCBbbmFtZSwgdmFsdWVzXSBvZiB0aGlzLl9wYXJhbXMpIHsKICAgICAgaWYgKHZhbHVlcy5sZW5ndGggPT09IDEpIG9iamVjdFtuYW1lXSA9IHZhbHVlc1swXQogICAgICBlbHNlIG9iamVjdFtuYW1lXSA9IHZhbHVlcwogICAgfQoKICAgIHJldHVybiBvYmplY3QKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jY29uY2VwdC11cmxzZWFyY2hwYXJhbXMtdXBkYXRlCiAgX3VwZGF0ZSgpIHsKICAgIGNvbnN0IHVybCA9IFVSTFNlYXJjaFBhcmFtcy5fdXJscy5nZXQodGhpcykKCiAgICBpZiAodXJsID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgIHVybC5zZWFyY2ggPSB0aGlzLl9zZXJpYWxpemUoKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LXVybGVuY29kZWQtcGFyc2VyCiAgX3BhcnNlKGlucHV0KSB7CiAgICBpZiAoaW5wdXRbMF0gPT09ICc/JykgaW5wdXQgPSBpbnB1dC5zdWJzdHJpbmcoMSkKCiAgICB0aGlzLl9wYXJhbXMgPSBuZXcgTWFwKCkKCiAgICBmb3IgKGNvbnN0IHNlcXVlbmNlIG9mIGlucHV0LnNwbGl0KCcmJykpIHsKICAgICAgaWYgKHNlcXVlbmNlLmxlbmd0aCA9PT0gMCkgY29udGludWUKCiAgICAgIGxldCBpID0gc2VxdWVuY2UuaW5kZXhPZignPScpCiAgICAgIGlmIChpID09PSAtMSkgaSA9IHNlcXVlbmNlLmxlbmd0aAoKICAgICAgY29uc3QgbmFtZSA9IGRlY29kZVVSSUNvbXBvbmVudChzZXF1ZW5jZS5zdWJzdHJpbmcoMCwgaSkpCiAgICAgIGNvbnN0IHZhbHVlID0gZGVjb2RlVVJJQ29tcG9uZW50KHNlcXVlbmNlLnN1YnN0cmluZyhpICsgMSwgc2VxdWVuY2UubGVuZ3RoKSkKCiAgICAgIGxldCBsaXN0ID0gdGhpcy5fcGFyYW1zLmdldChuYW1lKQoKICAgICAgaWYgKGxpc3QgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGxpc3QgPSBbXQogICAgICAgIHRoaXMuX3BhcmFtcy5zZXQobmFtZSwgbGlzdCkKICAgICAgfQoKICAgICAgbGlzdC5wdXNoKHZhbHVlKQogICAgfQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LXVybGVuY29kZWQtc2VyaWFsaXplcgogIF9zZXJpYWxpemUoKSB7CiAgICBsZXQgb3V0cHV0ID0gJycKCiAgICBmb3IgKGxldCBbbmFtZSwgdmFsdWVzXSBvZiB0aGlzLl9wYXJhbXMpIHsKICAgICAgbmFtZSA9IGVuY29kZVVSSUNvbXBvbmVudChuYW1lKQoKICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiB2YWx1ZXMpIHsKICAgICAgICBpZiAob3V0cHV0KSBvdXRwdXQgKz0gJyYnCgogICAgICAgIG91dHB1dCArPSBuYW1lICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG91dHB1dAogIH0KfQp7CiAgIm5hbWUiOiAiYmFyZS11cmwiLAogICJ2ZXJzaW9uIjogIjIuMy4yIiwKICAiZGVzY3JpcHRpb24iOiAiV0hBVFdHIFVSTCBpbXBsZW1lbnRhdGlvbiBmb3IgSmF2YVNjcmlwdCIsCiAgImV4cG9ydHMiOiB7CiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuIjogewogICAgICAidHlwZXMiOiAiLi9pbmRleC5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9pbmRleC5qcyIKICAgIH0sCiAgICAiLi9nbG9iYWwiOiB7CiAgICAgICJ0eXBlcyI6ICIuL2dsb2JhbC5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9nbG9iYWwuanMiCiAgICB9CiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImluZGV4LmQudHMiLAogICAgImdsb2JhbC5qcyIsCiAgICAiZ2xvYmFsLmQudHMiLAogICAgImJpbmRpbmcuYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiLAogICAgImxpYiIsCiAgICAicHJlYnVpbGRzIgogIF0sCiAgImFkZG9uIjogdHJ1ZSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBiYXJlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS11cmwuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS11cmwvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXVybCIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLXBhdGgiOiAiXjMuMC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjMuMiIsCiAgICAiY21ha2UtYmFyZSI6ICJeMS4xLjYiLAogICAgImNtYWtlLWZldGNoIjogIl4xLjAuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuMy4zIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIKICB9Cn0KY29uc3QgRkFDVE9SID0gbmV3IFVpbnQxNkFycmF5KDgpCgpmdW5jdGlvbiBmYWN0b3I0MDk2IChpLCBuKSB7CiAgd2hpbGUgKG4gPiAwKSB7CiAgICBjb25zdCBmID0gaSAmIDQwOTUKICAgIEZBQ1RPUlstLW5dID0gZgogICAgaSA9IChpIC0gZikgLyA0MDk2CiAgfQogIHJldHVybiBGQUNUT1IKfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBCaWdTcGFyc2VBcnJheSB7CiAgY29uc3RydWN0b3IgKCkgewogICAgdGhpcy50aW55ID0gbmV3IFRpbnlBcnJheSgpCiAgICB0aGlzLm1heExlbmd0aCA9IDQwOTYKICAgIHRoaXMuZmFjdG9yID0gMQogIH0KCiAgc2V0IChpbmRleCwgdmFsKSB7CiAgICBpZiAodmFsICE9PSB1bmRlZmluZWQpIHsKICAgICAgd2hpbGUgKGluZGV4ID49IHRoaXMubWF4TGVuZ3RoKSB7CiAgICAgICAgdGhpcy5tYXhMZW5ndGggKj0gNDA5NgogICAgICAgIHRoaXMuZmFjdG9yKysKICAgICAgICBpZiAoIXRoaXMudGlueS5pc0VtcHR5aXNoKCkpIHsKICAgICAgICAgIGNvbnN0IHQgPSBuZXcgVGlueUFycmF5KCkKICAgICAgICAgIHQuc2V0KDAsIHRoaXMudGlueSkKICAgICAgICAgIHRoaXMudGlueSA9IHQKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBmID0gZmFjdG9yNDA5NihpbmRleCwgdGhpcy5mYWN0b3IpCiAgICBjb25zdCBsYXN0ID0gdGhpcy5mYWN0b3IgLSAxCgogICAgbGV0IHRpbnkgPSB0aGlzLnRpbnkKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGFzdDsgaSsrKSB7CiAgICAgIGNvbnN0IG5leHQgPSB0aW55LmdldChmW2ldKQogICAgICBpZiAobmV4dCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KICAgICAgICB0aW55ID0gdGlueS5zZXQoZltpXSwgbmV3IFRpbnlBcnJheSgpKQogICAgICB9IGVsc2UgewogICAgICAgIHRpbnkgPSBuZXh0CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGlueS5zZXQoZltsYXN0XSwgdmFsKQogIH0KCiAgZ2V0IChpbmRleCkgewogICAgaWYgKGluZGV4ID49IHRoaXMubWF4TGVuZ3RoKSByZXR1cm4KCiAgICBjb25zdCBmID0gZmFjdG9yNDA5NihpbmRleCwgdGhpcy5mYWN0b3IpCiAgICBjb25zdCBsYXN0ID0gdGhpcy5mYWN0b3IgLSAxCgogICAgbGV0IHRpbnkgPSB0aGlzLnRpbnkKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGFzdDsgaSsrKSB7CiAgICAgIHRpbnkgPSB0aW55LmdldChmW2ldKQogICAgICBpZiAodGlueSA9PT0gdW5kZWZpbmVkKSByZXR1cm4KICAgIH0KCiAgICByZXR1cm4gdGlueS5nZXQoZltsYXN0XSkKICB9Cn0KCmNsYXNzIFRpbnlBcnJheSB7CiAgY29uc3RydWN0b3IgKCkgewogICAgdGhpcy5zID0gMAogICAgdGhpcy5iID0gbmV3IEFycmF5KDEpCiAgICB0aGlzLmYgPSBuZXcgVWludDE2QXJyYXkoMSkKICB9CgogIGlzRW1wdHlpc2ggKCkgewogICAgcmV0dXJuIHRoaXMuYi5sZW5ndGggPT09IDEgJiYgdGhpcy5iWzBdID09PSB1bmRlZmluZWQKICB9CgogIGdldCAoaSkgewogICAgaWYgKHRoaXMucyA9PT0gMTIpIHJldHVybiB0aGlzLmJbaV0KICAgIGNvbnN0IGYgPSBpID4+PiB0aGlzLnMKICAgIGNvbnN0IHIgPSBpICYgKHRoaXMuYi5sZW5ndGggLSAxKQogICAgcmV0dXJuIHRoaXMuZltyXSA9PT0gZiA/IHRoaXMuYltyXSA6IHVuZGVmaW5lZAogIH0KCiAgc2V0IChpLCB2KSB7CiAgICB3aGlsZSAodGhpcy5zICE9PSAxMikgewogICAgICBjb25zdCBmID0gaSA+Pj4gdGhpcy5zCiAgICAgIGNvbnN0IHIgPSBpICYgKHRoaXMuYi5sZW5ndGggLSAxKQogICAgICBjb25zdCBvID0gdGhpcy5iW3JdCgogICAgICBpZiAobyA9PT0gdW5kZWZpbmVkIHx8IGYgPT09IHRoaXMuZltyXSkgewogICAgICAgIHRoaXMuYltyXSA9IHYKICAgICAgICB0aGlzLmZbcl0gPSBmCiAgICAgICAgcmV0dXJuIHYKICAgICAgfQoKICAgICAgdGhpcy5ncm93KCkKICAgIH0KCiAgICB0aGlzLmJbaV0gPSB2CiAgICByZXR1cm4gdgogIH0KCiAgZ3JvdyAoKSB7CiAgICBjb25zdCBvcyA9IHRoaXMucwogICAgY29uc3Qgb2IgPSB0aGlzLmIKICAgIGNvbnN0IG9mID0gdGhpcy5mCgogICAgdGhpcy5zICs9IDQKICAgIHRoaXMuYiA9IG5ldyBBcnJheSh0aGlzLmIubGVuZ3RoIDw8IDQpCiAgICB0aGlzLmYgPSB0aGlzLnMgPT09IDEyID8gbnVsbCA6IG5ldyBVaW50OEFycmF5KHRoaXMuYi5sZW5ndGgpCgogICAgY29uc3QgbSA9IHRoaXMuYi5sZW5ndGggLSAxCgogICAgZm9yIChsZXQgb3IgPSAwOyBvciA8IG9iLmxlbmd0aDsgb3IrKykgewogICAgICBpZiAob2Jbb3JdID09PSB1bmRlZmluZWQpIGNvbnRpbnVlCgogICAgICBjb25zdCBpID0gb2Zbb3JdIDw8IG9zIHwgb3IKICAgICAgY29uc3QgZiA9IGkgPj4+IHRoaXMucwogICAgICBjb25zdCByID0gaSAmIG0KCiAgICAgIHRoaXMuYltyXSA9IG9iW29yXQogICAgICBpZiAodGhpcy5zICE9PSAxMikgdGhpcy5mW3JdID0gZgogICAgfQogIH0KfQp7CiAgIm5hbWUiOiAiYmlnLXNwYXJzZS1hcnJheSIsCiAgInZlcnNpb24iOiAiMS4wLjMiLAogICJkZXNjcmlwdGlvbiI6ICJBIHNwYXJzZSBhcnJheSBvcHRpbWlzZWQgZm9yIGxvdyBtZW1vcnkgd2hpbHN0IHN0aWxsIGJlaW5nIGZhc3QiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjEuMSIsCiAgICAic3RhbmRhcmQiOiAiXjE2LjAuMyIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2JpZy1zcGFyc2UtYXJyYXkuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2JpZy1zcGFyc2UtYXJyYXkvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvYmlnLXNwYXJzZS1hcnJheSIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKZnVuY3Rpb24gYnl0ZUxlbmd0aCAoc2l6ZSkgewogIHJldHVybiBNYXRoLmNlaWwoc2l6ZSAvIDgpCn0KCmZ1bmN0aW9uIGdldCAoYnVmZmVyLCBiaXQpIHsKICBjb25zdCBuID0gYnVmZmVyLkJZVEVTX1BFUl9FTEVNRU5UICogOAoKICBjb25zdCBvZmZzZXQgPSBiaXQgJiAobiAtIDEpCiAgY29uc3QgaSA9IChiaXQgLSBvZmZzZXQpIC8gbgoKICByZXR1cm4gKGJ1ZmZlcltpXSAmICgxIDw8IG9mZnNldCkpICE9PSAwCn0KCmZ1bmN0aW9uIHNldCAoYnVmZmVyLCBiaXQsIHZhbHVlID0gdHJ1ZSkgewogIGNvbnN0IG4gPSBidWZmZXIuQllURVNfUEVSX0VMRU1FTlQgKiA4CgogIGNvbnN0IG9mZnNldCA9IGJpdCAmIChuIC0gMSkKICBjb25zdCBpID0gKGJpdCAtIG9mZnNldCkgLyBuCiAgY29uc3QgbWFzayA9IDEgPDwgb2Zmc2V0CgogIGlmICh2YWx1ZSkgewogICAgaWYgKChidWZmZXJbaV0gJiBtYXNrKSAhPT0gMCkgcmV0dXJuIGZhbHNlCiAgfSBlbHNlIHsKICAgIGlmICgoYnVmZmVyW2ldICYgbWFzaykgPT09IDApIHJldHVybiBmYWxzZQogIH0KCiAgYnVmZmVyW2ldIF49IG1hc2sKICByZXR1cm4gdHJ1ZQp9CgpmdW5jdGlvbiBzZXRSYW5nZSAoYnVmZmVyLCBzdGFydCwgZW5kLCB2YWx1ZSA9IHRydWUpIHsKICBjb25zdCBuID0gYnVmZmVyLkJZVEVTX1BFUl9FTEVNRU5UICogOAoKICBsZXQgcmVtYWluaW5nID0gZW5kIC0gc3RhcnQKICBsZXQgb2Zmc2V0ID0gc3RhcnQgJiAobiAtIDEpCiAgbGV0IGkgPSAoc3RhcnQgLSBvZmZzZXQpIC8gbgoKICBsZXQgY2hhbmdlZCA9IGZhbHNlCgogIHdoaWxlIChyZW1haW5pbmcgPiAwKSB7CiAgICBjb25zdCBtYXNrID0gKDIgKiogTWF0aC5taW4ocmVtYWluaW5nLCBuIC0gb2Zmc2V0KSAtIDEpIDw8IG9mZnNldAoKICAgIGlmICh2YWx1ZSkgewogICAgICBpZiAoKGJ1ZmZlcltpXSAmIG1hc2spICE9PSBtYXNrKSB7CiAgICAgICAgYnVmZmVyW2ldIHw9IG1hc2sKICAgICAgICBjaGFuZ2VkID0gdHJ1ZQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoKGJ1ZmZlcltpXSAmIG1hc2spICE9PSAwKSB7CiAgICAgICAgYnVmZmVyW2ldICY9IH5tYXNrCiAgICAgICAgY2hhbmdlZCA9IHRydWUKICAgICAgfQogICAgfQoKICAgIHJlbWFpbmluZyAtPSBuIC0gb2Zmc2V0CiAgICBvZmZzZXQgPSAwCiAgICBpKysKICB9CgogIHJldHVybiBjaGFuZ2VkCn0KCmZ1bmN0aW9uIGZpbGwgKGJ1ZmZlciwgdmFsdWUsIHN0YXJ0ID0gMCwgZW5kID0gYnVmZmVyLmJ5dGVMZW5ndGggKiA4KSB7CiAgY29uc3QgbiA9IGJ1ZmZlci5CWVRFU19QRVJfRUxFTUVOVCAqIDgKICBsZXQgaSwgagoKICB7CiAgICBjb25zdCBvZmZzZXQgPSBzdGFydCAmIChuIC0gMSkKICAgIGkgPSAoc3RhcnQgLSBvZmZzZXQpIC8gbgoKICAgIGlmIChvZmZzZXQgIT09IDApIHsKICAgICAgY29uc3QgbWFzayA9ICgyICoqIE1hdGgubWluKG4gLSBvZmZzZXQsIGVuZCAtIHN0YXJ0KSAtIDEpIDw8IG9mZnNldAoKICAgICAgaWYgKHZhbHVlKSBidWZmZXJbaV0gfD0gbWFzawogICAgICBlbHNlIGJ1ZmZlcltpXSAmPSB+bWFzawoKICAgICAgaSsrCiAgICB9CiAgfQoKICB7CiAgICBjb25zdCBvZmZzZXQgPSBlbmQgJiAobiAtIDEpCiAgICBqID0gKGVuZCAtIG9mZnNldCkgLyBuCgogICAgaWYgKG9mZnNldCAhPT0gMCAmJiBqID49IGkpIHsKICAgICAgY29uc3QgbWFzayA9ICgyICoqIG9mZnNldCkgLSAxCgogICAgICBpZiAodmFsdWUpIGJ1ZmZlcltqXSB8PSBtYXNrCiAgICAgIGVsc2UgYnVmZmVyW2pdICY9IH5tYXNrCiAgICB9CiAgfQoKICByZXR1cm4gYnVmZmVyLmZpbGwodmFsdWUgPyAoMiAqKiBuKSAtIDEgOiAwLCBpLCBqKQp9CgpmdW5jdGlvbiB0b2dnbGUgKGJ1ZmZlciwgYml0KSB7CiAgY29uc3QgbiA9IGJ1ZmZlci5CWVRFU19QRVJfRUxFTUVOVCAqIDgKCiAgY29uc3Qgb2Zmc2V0ID0gYml0ICYgKG4gLSAxKQogIGNvbnN0IGkgPSAoYml0IC0gb2Zmc2V0KSAvIG4KICBjb25zdCBtYXNrID0gMSA8PCBvZmZzZXQKCiAgYnVmZmVyW2ldIF49IG1hc2sKICByZXR1cm4gKGJ1ZmZlcltpXSAmIG1hc2spICE9PSAwCn0KCmZ1bmN0aW9uIHJlbW92ZSAoYnVmZmVyLCBiaXQpIHsKICByZXR1cm4gc2V0KGJ1ZmZlciwgYml0LCBmYWxzZSkKfQoKZnVuY3Rpb24gcmVtb3ZlUmFuZ2UgKGJ1ZmZlciwgc3RhcnQsIGVuZCkgewogIHJldHVybiBzZXRSYW5nZShidWZmZXIsIHN0YXJ0LCBlbmQsIGZhbHNlKQp9CgpmdW5jdGlvbiBpbmRleE9mIChidWZmZXIsIHZhbHVlLCBwb3NpdGlvbiA9IDApIHsKICBmb3IgKGxldCBpID0gcG9zaXRpb24sIG4gPSBidWZmZXIuYnl0ZUxlbmd0aCAqIDg7IGkgPCBuOyBpKyspIHsKICAgIGlmIChnZXQoYnVmZmVyLCBpKSA9PT0gdmFsdWUpIHJldHVybiBpCiAgfQoKICByZXR1cm4gLTEKfQoKZnVuY3Rpb24gbGFzdEluZGV4T2YgKGJ1ZmZlciwgdmFsdWUsIHBvc2l0aW9uID0gYnVmZmVyLmJ5dGVMZW5ndGggKiA4IC0gMSkgewogIGZvciAobGV0IGkgPSBwb3NpdGlvbjsgaSA+PSAwOyBpLS0pIHsKICAgIGlmIChnZXQoYnVmZmVyLCBpKSA9PT0gdmFsdWUpIHJldHVybiBpCiAgfQoKICByZXR1cm4gLTEKfQoKZnVuY3Rpb24gb2YgKC4uLmJpdHMpIHsKICByZXR1cm4gZnJvbShiaXRzKQp9CgpmdW5jdGlvbiBmcm9tIChiaXRzKSB7CiAgY29uc3QgYnVmZmVyID0gYjRhLmFsbG9jKGJ5dGVMZW5ndGgoYml0cy5sZW5ndGgpKQogIGZvciAobGV0IGkgPSAwOyBpIDwgYml0cy5sZW5ndGg7IGkrKykgc2V0KGJ1ZmZlciwgaSwgYml0c1tpXSkKICByZXR1cm4gYnVmZmVyCn0KCmZ1bmN0aW9uICogaXRlcmF0b3IgKGJ1ZmZlcikgewogIGZvciAobGV0IGkgPSAwLCBuID0gYnVmZmVyLmJ5dGVMZW5ndGggKiA4OyBpIDwgbjsgaSsrKSB5aWVsZCBnZXQoYnVmZmVyLCBpKQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBieXRlTGVuZ3RoLAogIGdldCwKICBzZXQsCiAgc2V0UmFuZ2UsCiAgZmlsbCwKICB0b2dnbGUsCiAgcmVtb3ZlLAogIHJlbW92ZVJhbmdlLAogIGluZGV4T2YsCiAgbGFzdEluZGV4T2YsCiAgb2YsCiAgZnJvbSwKICBpdGVyYXRvcgp9CnsKICAibmFtZSI6ICJiaXRzLXRvLWJ5dGVzIiwKICAidmVyc2lvbiI6ICIxLjMuMCIsCiAgImRlc2NyaXB0aW9uIjogIkZ1bmN0aW9ucyBmb3IgZG9pbmcgYml0IG1hbmlwdWxhdGlvbiBvZiB0eXBlZCBhcnJheXMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5tanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYml0cy10by1ieXRlcy5naXQiCiAgfSwKICAiYXV0aG9yIjogIkthc3BlciBJc2FnZXIgRGFsc2dhcsOwIDxrYXNwZXJAZnVua3Rpb25lbC5jbz4iLAogICJsaWNlbnNlIjogIklTQyIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iaXRzLXRvLWJ5dGVzL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYml0cy10by1ieXRlcyNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjUuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMi4zLjEiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfQp9CmNvbnN0IEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpCmNvbnN0IFByb3RvbXV4ID0gcmVxdWlyZSgncHJvdG9tdXgnKQpjb25zdCB7IFJlYWRhYmxlIH0gPSByZXF1aXJlKCdzdHJlYW14JykKY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYml0ZmllbGQgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkJykKY29uc3QgYml0cyA9IHJlcXVpcmUoJ2JpdHMtdG8tYnl0ZXMnKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuL2xpYi9lcnJvcnMnKQoKZXhwb3J0cy5TZXJ2ZXIgPSBjbGFzcyBCbGluZFJlbGF5U2VydmVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgY29uc3QgewogICAgICBjcmVhdGVTdHJlYW0KICAgIH0gPSBvcHRzCgogICAgdGhpcy5fY3JlYXRlU3RyZWFtID0gY3JlYXRlU3RyZWFtCiAgICB0aGlzLl9wYWlyaW5nID0gbmV3IE1hcCgpCiAgICB0aGlzLl9zZXNzaW9ucyA9IG5ldyBTZXQoKQogIH0KCiAgZ2V0IHNlc3Npb25zICgpIHsKICAgIHJldHVybiB0aGlzLl9zZXNzaW9uc1tTeW1ib2wuaXRlcmF0b3JdKCkKICB9CgogIGFjY2VwdCAoc3RyZWFtLCBvcHRzKSB7CiAgICBjb25zdCBzZXNzaW9uID0gbmV3IEJsaW5kUmVsYXlTZXNzaW9uKHRoaXMsIHN0cmVhbSwgb3B0cykKCiAgICB0aGlzLl9zZXNzaW9ucy5hZGQoc2Vzc2lvbikKCiAgICByZXR1cm4gc2Vzc2lvbgogIH0KCiAgYXN5bmMgY2xvc2UgKCkgewogICAgY29uc3QgZW5kaW5nID0gW10KCiAgICBmb3IgKGNvbnN0IHNlc3Npb24gb2YgdGhpcy5fc2Vzc2lvbnMpIHsKICAgICAgZW5kaW5nLnB1c2goc2Vzc2lvbi5lbmQoKSkKICAgIH0KCiAgICBhd2FpdCBQcm9taXNlLmFsbChlbmRpbmcpCgogICAgdGhpcy5fcGFpcmluZy5jbGVhcigpCiAgfQp9CgpjbGFzcyBCbGluZFJlbGF5U2Vzc2lvbiBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IgKHNlcnZlciwgc3RyZWFtLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICBjb25zdCB7CiAgICAgIGlkLAogICAgICBoYW5kc2hha2UsCiAgICAgIGhhbmRzaGFrZUVuY29kaW5nCiAgICB9ID0gb3B0cwoKICAgIHRoaXMuX3NlcnZlciA9IHNlcnZlcgogICAgdGhpcy5fbXV4ID0gUHJvdG9tdXguZnJvbShzdHJlYW0pCgogICAgdGhpcy5fY2hhbm5lbCA9IHRoaXMuX211eC5jcmVhdGVDaGFubmVsKHsKICAgICAgcHJvdG9jb2w6ICdibGluZC1yZWxheScsCiAgICAgIGlkLAogICAgICBoYW5kc2hha2U6IGhhbmRzaGFrZSA/IGhhbmRzaGFrZUVuY29kaW5nIHx8IGMucmF3IDogbnVsbCwKICAgICAgb25vcGVuOiB0aGlzLl9vbm9wZW4uYmluZCh0aGlzKSwKICAgICAgb25jbG9zZTogdGhpcy5fb25jbG9zZS5iaW5kKHRoaXMpLAogICAgICBvbmRlc3Ryb3k6IHRoaXMuX29uZGVzdHJveS5iaW5kKHRoaXMpCiAgICB9KQoKICAgIHRoaXMuX3BhaXIgPSB0aGlzLl9jaGFubmVsLmFkZE1lc3NhZ2UoewogICAgICBlbmNvZGluZzogbS5wYWlyLAogICAgICBvbm1lc3NhZ2U6IHRoaXMuX29ucGFpci5iaW5kKHRoaXMpCiAgICB9KQoKICAgIHRoaXMuX3VucGFpciA9IHRoaXMuX2NoYW5uZWwuYWRkTWVzc2FnZSh7CiAgICAgIGVuY29kaW5nOiBtLnVucGFpciwKICAgICAgb25tZXNzYWdlOiB0aGlzLl9vbnVucGFpci5iaW5kKHRoaXMpCiAgICB9KQoKICAgIHRoaXMuX2VuZGluZyA9IG51bGwKICAgIHRoaXMuX2Rlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLl9lcnJvciA9IG51bGwKICAgIHRoaXMuX3BhaXJpbmcgPSBuZXcgU2V0KCkKICAgIHRoaXMuX3N0cmVhbXMgPSBuZXcgTWFwKCkKCiAgICB0aGlzLl9vbmVycm9yID0gKGVycikgPT4gdGhpcy5lbWl0KCdlcnJvcicsIGVycikKCiAgICB0aGlzLl9jaGFubmVsLm9wZW4oaGFuZHNoYWtlKQogIH0KCiAgZ2V0IGNsb3NlZCAoKSB7CiAgICByZXR1cm4gdGhpcy5fY2hhbm5lbC5jbG9zZWQKICB9CgogIGdldCBtdXggKCkgewogICAgcmV0dXJuIHRoaXMuX211eAogIH0KCiAgZ2V0IHN0cmVhbSAoKSB7CiAgICByZXR1cm4gdGhpcy5fbXV4LnN0cmVhbQogIH0KCiAgX29ub3BlbiAoKSB7CiAgICB0aGlzLmVtaXQoJ29wZW4nKQogIH0KCiAgX29uY2xvc2UgKCkgewogICAgdGhpcy5fZW5kaW5nID0gUHJvbWlzZS5yZXNvbHZlKCkKCiAgICBjb25zdCBlcnIgPSB0aGlzLl9lcnJvciB8fCBlcnJvcnMuQ0hBTk5FTF9DTE9TRUQoKQoKICAgIGZvciAoY29uc3QgdG9rZW4gb2YgdGhpcy5fcGFpcmluZykgewogICAgICB0aGlzLl9zZXJ2ZXIuX3BhaXJpbmcuZGVsZXRlKHRva2VuLnRvU3RyaW5nKCdoZXgnKSkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHN0cmVhbSBvZiB0aGlzLl9zdHJlYW1zLnZhbHVlcygpKSB7CiAgICAgIHN0cmVhbQogICAgICAgIC5vZmYoJ2Vycm9yJywgdGhpcy5fb25lcnJvcikKICAgICAgICAub24oJ2Vycm9yJywgbm9vcCkKICAgICAgICAuZGVzdHJveShlcnIpCiAgICB9CgogICAgdGhpcy5fcGFpcmluZy5jbGVhcigpCiAgICB0aGlzLl9zdHJlYW1zLmNsZWFyKCkKCiAgICB0aGlzLl9zZXJ2ZXIuX3Nlc3Npb25zLmRlbGV0ZSh0aGlzKQoKICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogIH0KCiAgX29uZGVzdHJveSAoKSB7CiAgICB0aGlzLl9kZXN0cm95ZWQgPSB0cnVlCiAgICB0aGlzLmVtaXQoJ2Rlc3Ryb3knKQogIH0KCiAgX29ucGFpciAoeyBpc0luaXRpYXRvciwgdG9rZW4sIGlkOiByZW1vdGVJZCB9KSB7CiAgICBjb25zdCBrZXlTdHJpbmcgPSB0b2tlbi50b1N0cmluZygnaGV4JykKCiAgICBsZXQgcGFpciA9IHRoaXMuX3NlcnZlci5fcGFpcmluZy5nZXQoa2V5U3RyaW5nKQoKICAgIGlmIChwYWlyID09PSB1bmRlZmluZWQpIHsKICAgICAgcGFpciA9IG5ldyBCbGluZFJlbGF5UGFpcih0b2tlbikKICAgICAgdGhpcy5fc2VydmVyLl9wYWlyaW5nLnNldChrZXlTdHJpbmcsIHBhaXIpCiAgICB9IGVsc2UgaWYgKHBhaXIubGlua3NbK2lzSW5pdGlhdG9yXSkgcmV0dXJuCgogICAgdGhpcy5fcGFpcmluZy5hZGQoa2V5U3RyaW5nKQoKICAgIHBhaXIubGlua3NbK2lzSW5pdGlhdG9yXSA9IG5ldyBCbGluZFJlbGF5TGluayh0aGlzLCBpc0luaXRpYXRvciwgcmVtb3RlSWQpCgogICAgaWYgKCFwYWlyLnBhaXJlZCkgcmV0dXJuCgogICAgdGhpcy5fc2VydmVyLl9wYWlyaW5nLmRlbGV0ZShrZXlTdHJpbmcpCgogICAgLy8gMXN0IHBhc3M6IENyZWF0ZSB0aGUgcmF3IHN0cmVhbXMgbmVlZGVkIGZvciBlYWNoIGVuZCBvZiB0aGUgbGluay4KICAgIGZvciAoY29uc3QgbGluayBvZiBwYWlyLmxpbmtzKSB7CiAgICAgIGxpbmsuY3JlYXRlU3RyZWFtKCkKICAgIH0KCiAgICAvLyAybmQgcGFzczogQ29ubmVjdCB0aGUgcmF3IHN0cmVhbXMgYW5kIHNldCB1cCBoYW5kbGVycy4KICAgIGZvciAoY29uc3QgeyBpc0luaXRpYXRvciwgc2Vzc2lvbiwgc3RyZWFtIH0gb2YgcGFpci5saW5rcykgewogICAgICBjb25zdCByZW1vdGUgPSBwYWlyLnJlbW90ZShpc0luaXRpYXRvcikKCiAgICAgIHN0cmVhbQogICAgICAgIC5vbignZXJyb3InLCBzZXNzaW9uLl9vbmVycm9yKQogICAgICAgIC5vbignY2xvc2UnLCAoKSA9PiBzZXNzaW9uLl9zdHJlYW1zLmRlbGV0ZShrZXlTdHJpbmcpKQogICAgICAgIC5yZWxheVRvKHJlbW90ZS5zdHJlYW0pCgogICAgICBzZXNzaW9uLl9wYWlyaW5nLmRlbGV0ZShrZXlTdHJpbmcpCiAgICAgIHNlc3Npb24uX3N0cmVhbXMuc2V0KGtleVN0cmluZywgc3RyZWFtKQogICAgfQoKICAgIC8vIDNyZCBwYXNzOiBMZXQgZWl0aGVyIGVuZCBvZiB0aGUgbGluayBrbm93IHRoZSBzdHJlYW1zIHdlcmUgc2V0IHVwLgogICAgZm9yIChjb25zdCB7IGlzSW5pdGlhdG9yLCBzZXNzaW9uLCByZW1vdGVJZCwgc3RyZWFtIH0gb2YgcGFpci5saW5rcykgewogICAgICBzZXNzaW9uLl9wYWlyLnNlbmQoewogICAgICAgIGlzSW5pdGlhdG9yLAogICAgICAgIHRva2VuLAogICAgICAgIGlkOiBzdHJlYW0uaWQsCiAgICAgICAgc2VxOiAwCiAgICAgIH0pCgogICAgICBzZXNzaW9uLl9lbmRNYXliZSgpCgogICAgICBzZXNzaW9uLmVtaXQoJ3BhaXInLCBpc0luaXRpYXRvciwgdG9rZW4sIHN0cmVhbSwgcmVtb3RlSWQpCiAgICB9CiAgfQoKICBfb251bnBhaXIgKHsgdG9rZW4gfSkgewogICAgY29uc3Qga2V5U3RyaW5nID0gdG9rZW4udG9TdHJpbmcoJ2hleCcpCgogICAgY29uc3QgcGFpciA9IHRoaXMuX3NlcnZlci5fcGFpcmluZy5nZXQoa2V5U3RyaW5nKQoKICAgIGlmIChwYWlyKSB7CiAgICAgIGZvciAoY29uc3QgbGluayBvZiBwYWlyLmxpbmtzKSB7CiAgICAgICAgaWYgKGxpbmspIGxpbmsuc2Vzc2lvbi5fcGFpcmluZy5kZWxldGUoa2V5U3RyaW5nKQogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fc2VydmVyLl9wYWlyaW5nLmRlbGV0ZShrZXlTdHJpbmcpCiAgICB9CgogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5fc3RyZWFtcy5nZXQoa2V5U3RyaW5nKQoKICAgIGlmIChzdHJlYW0pIHsKICAgICAgc3RyZWFtCiAgICAgICAgLm9mZignZXJyb3InLCB0aGlzLl9vbmVycm9yKQogICAgICAgIC5vbignZXJyb3InLCBub29wKQogICAgICAgIC5kZXN0cm95KGVycm9ycy5QQUlSSU5HX0NBTkNFTExFRCgpKQoKICAgICAgdGhpcy5fc3RyZWFtcy5kZWxldGUoa2V5U3RyaW5nKQogICAgfQogIH0KCiAgY29yayAoKSB7CiAgICB0aGlzLl9jaGFubmVsLmNvcmsoKQogIH0KCiAgdW5jb3JrICgpIHsKICAgIHRoaXMuX2NoYW5uZWwudW5jb3JrKCkKICB9CgogIGFzeW5jIGVuZCAoKSB7CiAgICBpZiAodGhpcy5fZW5kaW5nKSByZXR1cm4gdGhpcy5fZW5kaW5nCgogICAgdGhpcy5fZW5kaW5nID0gRXZlbnRFbWl0dGVyLm9uY2UodGhpcywgJ2Nsb3NlJykKICAgIHRoaXMuX2VuZE1heWJlKCkKCiAgICByZXR1cm4gdGhpcy5fZW5kaW5nCiAgfQoKICBfZW5kTWF5YmUgKCkgewogICAgaWYgKHRoaXMuX2VuZGluZyAmJiB0aGlzLl9wYWlyaW5nLnNpemUgPT09IDApIHsKICAgICAgdGhpcy5fY2hhbm5lbC5jbG9zZSgpCiAgICB9CiAgfQoKICBkZXN0cm95IChlcnIpIHsKICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5fZGVzdHJveWVkID0gdHJ1ZQoKICAgIHRoaXMuX2Vycm9yID0gZXJyIHx8IGVycm9ycy5DSEFOTkVMX0RFU1RST1lFRCgpCiAgICB0aGlzLl9jaGFubmVsLmNsb3NlKCkKICB9Cn0KCmNsYXNzIEJsaW5kUmVsYXlQYWlyIHsKICBjb25zdHJ1Y3RvciAodG9rZW4pIHsKICAgIHRoaXMudG9rZW4gPSB0b2tlbgogICAgdGhpcy5saW5rcyA9IFtudWxsLCBudWxsXQogIH0KCiAgZ2V0IHBhaXJlZCAoKSB7CiAgICByZXR1cm4gdGhpcy5saW5rc1swXSAhPT0gbnVsbCAmJiB0aGlzLmxpbmtzWzFdICE9PSBudWxsCiAgfQoKICByZW1vdGUgKGlzSW5pdGlhdG9yKSB7CiAgICByZXR1cm4gdGhpcy5saW5rc1tpc0luaXRpYXRvciA/IDAgOiAxXQogIH0KfQoKY2xhc3MgQmxpbmRSZWxheUxpbmsgewogIGNvbnN0cnVjdG9yIChzZXNzaW9uLCBpc0luaXRpYXRvciwgcmVtb3RlSWQpIHsKICAgIHRoaXMuc2Vzc2lvbiA9IHNlc3Npb24KICAgIHRoaXMuaXNJbml0aWF0b3IgPSBpc0luaXRpYXRvcgogICAgdGhpcy5yZW1vdGVJZCA9IHJlbW90ZUlkCiAgICB0aGlzLnN0cmVhbSA9IG51bGwKICB9CgogIGNyZWF0ZVN0cmVhbSAoKSB7CiAgICBpZiAodGhpcy5zdHJlYW0pIHJldHVybgoKICAgIHRoaXMuc3RyZWFtID0gdGhpcy5zZXNzaW9uLl9zZXJ2ZXIuX2NyZWF0ZVN0cmVhbSh7CiAgICAgIGZpcmV3YWxsOiB0aGlzLl9vbmZpcmV3YWxsLmJpbmQodGhpcykKICAgIH0pCiAgfQoKICBfb25maXJld2FsbCAoc29ja2V0LCBwb3J0LCBob3N0KSB7CiAgICB0aGlzLnN0cmVhbS5jb25uZWN0KHNvY2tldCwgdGhpcy5yZW1vdGVJZCwgcG9ydCwgaG9zdCkKCiAgICByZXR1cm4gZmFsc2UKICB9Cn0KCmV4cG9ydHMuQ2xpZW50ID0gY2xhc3MgQmxpbmRSZWxheUNsaWVudCBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgc3RhdGljIF9jbGllbnRzID0gbmV3IFdlYWtNYXAoKQoKICBzdGF0aWMgZnJvbSAoc3RyZWFtLCBvcHRzKSB7CiAgICBsZXQgY2xpZW50ID0gdGhpcy5fY2xpZW50cy5nZXQoc3RyZWFtKQogICAgaWYgKGNsaWVudCkgcmV0dXJuIGNsaWVudAogICAgY2xpZW50ID0gbmV3IHRoaXMoc3RyZWFtLCBvcHRzKQogICAgdGhpcy5fY2xpZW50cy5zZXQoc3RyZWFtLCBjbGllbnQpCiAgICByZXR1cm4gY2xpZW50CiAgfQoKICBjb25zdHJ1Y3RvciAoc3RyZWFtLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICBjb25zdCB7CiAgICAgIGlkLAogICAgICBoYW5kc2hha2UsCiAgICAgIGhhbmRzaGFrZUVuY29kaW5nCiAgICB9ID0gb3B0cwoKICAgIHRoaXMuX211eCA9IFByb3RvbXV4LmZyb20oc3RyZWFtKQoKICAgIHRoaXMuX2NoYW5uZWwgPSB0aGlzLl9tdXguY3JlYXRlQ2hhbm5lbCh7CiAgICAgIHByb3RvY29sOiAnYmxpbmQtcmVsYXknLAogICAgICBpZCwKICAgICAgaGFuZHNoYWtlOiBoYW5kc2hha2UgPyBoYW5kc2hha2VFbmNvZGluZyB8fCBjLnJhdyA6IG51bGwsCiAgICAgIG9ub3BlbjogdGhpcy5fb25vcGVuLmJpbmQodGhpcyksCiAgICAgIG9uY2xvc2U6IHRoaXMuX29uY2xvc2UuYmluZCh0aGlzKSwKICAgICAgb25kZXN0cm95OiB0aGlzLl9vbmRlc3Ryb3kuYmluZCh0aGlzKQogICAgfSkKCiAgICB0aGlzLl9wYWlyID0gdGhpcy5fY2hhbm5lbC5hZGRNZXNzYWdlKHsKICAgICAgZW5jb2Rpbmc6IG0ucGFpciwKICAgICAgb25tZXNzYWdlOiB0aGlzLl9vbnBhaXIuYmluZCh0aGlzKQogICAgfSkKCiAgICB0aGlzLl91bnBhaXIgPSB0aGlzLl9jaGFubmVsLmFkZE1lc3NhZ2UoewogICAgICBlbmNvZGluZzogbS51bnBhaXIKICAgIH0pCgogICAgdGhpcy5fZW5kaW5nID0gZmFsc2UKICAgIHRoaXMuX2Rlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLl9lcnJvciA9IG51bGwKICAgIHRoaXMuX3JlcXVlc3RzID0gbmV3IE1hcCgpCgogICAgdGhpcy5fY2hhbm5lbC5vcGVuKGhhbmRzaGFrZSkKICB9CgogIGdldCBjbG9zZWQgKCkgewogICAgcmV0dXJuIHRoaXMuX2NoYW5uZWwuY2xvc2VkCiAgfQoKICBnZXQgbXV4ICgpIHsKICAgIHJldHVybiB0aGlzLl9tdXgKICB9CgogIGdldCBzdHJlYW0gKCkgewogICAgcmV0dXJuIHRoaXMuX211eC5zdHJlYW0KICB9CgogIGdldCByZXF1ZXN0cyAoKSB7CiAgICByZXR1cm4gdGhpcy5fcmVxdWVzdHMudmFsdWVzKCkKICB9CgogIF9vbm9wZW4gKCkgewogICAgdGhpcy5lbWl0KCdvcGVuJykKICB9CgogIF9vbmNsb3NlICgpIHsKICAgIHRoaXMuX2VuZGluZyA9IFByb21pc2UucmVzb2x2ZSgpCgogICAgY29uc3QgZXJyID0gdGhpcy5fZXJyb3IgfHwgZXJyb3JzLkNIQU5ORUxfQ0xPU0VEKCkKCiAgICBmb3IgKGNvbnN0IHJlcXVlc3Qgb2YgdGhpcy5fcmVxdWVzdHMudmFsdWVzKCkpIHsKICAgICAgcmVxdWVzdC5kZXN0cm95KGVycikKICAgIH0KCiAgICB0aGlzLl9yZXF1ZXN0cy5jbGVhcigpCgogICAgdGhpcy5jb25zdHJ1Y3Rvci5fY2xpZW50cy5kZWxldGUodGhpcy5zdHJlYW0pCgogICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgfQoKICBfb25kZXN0cm95ICgpIHsKICAgIHRoaXMuX2Rlc3Ryb3llZCA9IHRydWUKICAgIHRoaXMuZW1pdCgnZGVzdHJveScpCiAgfQoKICBfb25wYWlyICh7IGlzSW5pdGlhdG9yLCB0b2tlbiwgaWQ6IHJlbW90ZUlkIH0pIHsKICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9yZXF1ZXN0cy5nZXQodG9rZW4udG9TdHJpbmcoJ2hleCcpKQoKICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQgfHwgcmVxdWVzdC5pc0luaXRpYXRvciAhPT0gaXNJbml0aWF0b3IpIHJldHVybgoKICAgIHJlcXVlc3QucHVzaChyZW1vdGVJZCkKICAgIHJlcXVlc3QucHVzaChudWxsKQoKICAgIHRoaXMuZW1pdCgncGFpcicsIHJlcXVlc3QuaXNJbml0aWF0b3IsIHJlcXVlc3QudG9rZW4sIHJlcXVlc3Quc3RyZWFtLCByZW1vdGVJZCkKICB9CgogIHBhaXIgKGlzSW5pdGlhdG9yLCB0b2tlbiwgc3RyZWFtKSB7CiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSB0aHJvdyBlcnJvcnMuQ0hBTk5FTF9ERVNUUk9ZRUQoKQoKICAgIGNvbnN0IGtleVN0cmluZyA9IHRva2VuLnRvU3RyaW5nKCdoZXgnKQoKICAgIGlmICh0aGlzLl9yZXF1ZXN0cy5oYXMoa2V5U3RyaW5nKSkgdGhyb3cgZXJyb3JzLkFMUkVBRFlfUEFJUklORygpCgogICAgY29uc3QgcmVxdWVzdCA9IG5ldyBCbGluZFJlbGF5UmVxdWVzdCh0aGlzLCBpc0luaXRpYXRvciwgdG9rZW4sIHN0cmVhbSkKCiAgICB0aGlzLl9yZXF1ZXN0cy5zZXQoa2V5U3RyaW5nLCByZXF1ZXN0KQoKICAgIHJldHVybiByZXF1ZXN0CiAgfQoKICB1bnBhaXIgKHRva2VuKSB7CiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSB0aHJvdyBlcnJvcnMuQ0hBTk5FTF9ERVNUUk9ZRUQoKQoKICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9yZXF1ZXN0cy5nZXQodG9rZW4udG9TdHJpbmcoJ2hleCcpKQoKICAgIGlmIChyZXF1ZXN0KSByZXF1ZXN0LmRlc3Ryb3koZXJyb3JzLlBBSVJJTkdfQ0FOQ0VMTEVEKCkpCgogICAgdGhpcy5fdW5wYWlyLnNlbmQoeyB0b2tlbiB9KQogIH0KCiAgY29yayAoKSB7CiAgICB0aGlzLl9jaGFubmVsLmNvcmsoKQogIH0KCiAgdW5jb3JrICgpIHsKICAgIHRoaXMuX2NoYW5uZWwudW5jb3JrKCkKICB9CgogIGFzeW5jIGVuZCAoKSB7CiAgICBpZiAodGhpcy5fZW5kaW5nKSByZXR1cm4gdGhpcy5fZW5kaW5nCgogICAgdGhpcy5fZW5kaW5nID0gRXZlbnRFbWl0dGVyLm9uY2UodGhpcywgJ2Nsb3NlJykKICAgIHRoaXMuX2VuZE1heWJlKCkKCiAgICByZXR1cm4gdGhpcy5fZW5kaW5nCiAgfQoKICBfZW5kTWF5YmUgKCkgewogICAgaWYgKHRoaXMuX2VuZGluZyAmJiB0aGlzLl9yZXF1ZXN0cy5zaXplID09PSAwKSB7CiAgICAgIHRoaXMuX2NoYW5uZWwuY2xvc2UoKQogICAgfQogIH0KCiAgZGVzdHJveSAoZXJyKSB7CiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuX2Rlc3Ryb3llZCA9IHRydWUKCiAgICB0aGlzLl9lcnJvciA9IGVyciB8fCBlcnJvcnMuQ0hBTk5FTF9ERVNUUk9ZRUQoKQogICAgdGhpcy5fY2hhbm5lbC5jbG9zZSgpCiAgfQp9CgpjbGFzcyBCbGluZFJlbGF5UmVxdWVzdCBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3RvciAoY2xpZW50LCBpc0luaXRpYXRvciwgdG9rZW4sIHN0cmVhbSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuY2xpZW50ID0gY2xpZW50CiAgICB0aGlzLmlzSW5pdGlhdG9yID0gaXNJbml0aWF0b3IKICAgIHRoaXMudG9rZW4gPSB0b2tlbgogICAgdGhpcy5zdHJlYW0gPSBzdHJlYW0KICB9CgogIF9vcGVuIChjYikgewogICAgaWYgKHRoaXMuY2xpZW50Ll9kZXN0cm95ZWQpIHJldHVybiBjYihlcnJvcnMuQ0hBTk5FTF9ERVNUUk9ZRUQoKSkKCiAgICB0aGlzLmNsaWVudC5fcGFpci5zZW5kKHsKICAgICAgaXNJbml0aWF0b3I6IHRoaXMuaXNJbml0aWF0b3IsCiAgICAgIHRva2VuOiB0aGlzLnRva2VuLAogICAgICBpZDogdGhpcy5zdHJlYW0uaWQsCiAgICAgIHNlcTogMAogICAgfSkKCiAgICBjYihudWxsKQogIH0KCiAgX2Rlc3Ryb3kgKGNiKSB7CiAgICB0aGlzLmNsaWVudC5fcmVxdWVzdHMuZGVsZXRlKHRoaXMudG9rZW4udG9TdHJpbmcoJ2hleCcpKQoKICAgIGNiKG51bGwpCgogICAgdGhpcy5jbGllbnQuX2VuZE1heWJlKCkKICB9Cn0KCmV4cG9ydHMudG9rZW4gPSBmdW5jdGlvbiB0b2tlbiAoYnVmID0gYjRhLmFsbG9jVW5zYWZlKDMyKSkgewogIHNvZGl1bS5yYW5kb21ieXRlc19idWYoYnVmKQogIHJldHVybiBidWYKfQoKZnVuY3Rpb24gbm9vcCAoKSB7fQoKY29uc3QgbSA9IGV4cG9ydHMubWVzc2FnZXMgPSB7fQoKY29uc3QgZmxhZ3MgPSBiaXRmaWVsZCg3KQoKbS5wYWlyID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGZsYWdzLnByZWVuY29kZShzdGF0ZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0udG9rZW4pCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zZXEpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBmbGFncy5lbmNvZGUoc3RhdGUsIGJpdHMub2YobS5pc0luaXRpYXRvcikpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnRva2VuKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc2VxKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgW2lzSW5pdGlhdG9yXSA9IGJpdHMuaXRlcmF0b3IoZmxhZ3MuZGVjb2RlKHN0YXRlKSkKCiAgICByZXR1cm4gewogICAgICBpc0luaXRpYXRvciwKICAgICAgdG9rZW46IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBpZDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNlcTogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCm0udW5wYWlyID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGZsYWdzLnByZWVuY29kZShzdGF0ZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0udG9rZW4pCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBmbGFncy5lbmNvZGUoc3RhdGUsIGJpdHMub2YoKSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0udG9rZW4pCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBmbGFncy5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdG9rZW46IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQmxpbmRSZWxheUVycm9yIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yIChtc2csIGNvZGUsIGZuID0gQmxpbmRSZWxheUVycm9yKSB7CiAgICBzdXBlcihgJHtjb2RlfTogJHttc2d9YCkKICAgIHRoaXMuY29kZSA9IGNvZGUKCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgZm4pCiAgICB9CiAgfQoKICBnZXQgbmFtZSAoKSB7CiAgICByZXR1cm4gJ0JsaW5kUmVsYXlFcnJvcicKICB9CgogIHN0YXRpYyBEVVBMSUNBVEVfQ0hBTk5FTCAobXNnID0gJ0R1cGxpY2F0ZSBjaGFubmVsJykgewogICAgcmV0dXJuIG5ldyBCbGluZFJlbGF5RXJyb3IobXNnLCAnRFVQTElDQVRFX0NIQU5ORUwnLCBCbGluZFJlbGF5RXJyb3IuRFVQTElDQVRFX0NIQU5ORUwpCiAgfQoKICBzdGF0aWMgQ0hBTk5FTF9DTE9TRUQgKG1zZyA9ICdDaGFubmVsIGNsb3NlZCcpIHsKICAgIHJldHVybiBuZXcgQmxpbmRSZWxheUVycm9yKG1zZywgJ0NIQU5ORUxfQ0xPU0VEJywgQmxpbmRSZWxheUVycm9yLkNIQU5ORUxfQ0xPU0VEKQogIH0KCiAgc3RhdGljIENIQU5ORUxfREVTVFJPWUVEIChtc2cgPSAnQ2hhbm5lbCBkZXN0cm95ZWQnKSB7CiAgICByZXR1cm4gbmV3IEJsaW5kUmVsYXlFcnJvcihtc2csICdDSEFOTkVMX0RFU1RST1lFRCcsIEJsaW5kUmVsYXlFcnJvci5DSEFOTkVMX0RFU1RST1lFRCkKICB9CgogIHN0YXRpYyBBTFJFQURZX1BBSVJJTkcgKG1zZyA9ICdBbHJlYWR5IHBhaXJpbmcnKSB7CiAgICByZXR1cm4gbmV3IEJsaW5kUmVsYXlFcnJvcihtc2csICdBTFJFQURZX1BBSVJJTkcnLCBCbGluZFJlbGF5RXJyb3IuQUxSRUFEWV9QQUlSSU5HKQogIH0KCiAgc3RhdGljIFBBSVJJTkdfQ0FOQ0VMTEVEIChtc2cgPSAnUGFpcmluZyBjYW5jZWxsZWQnKSB7CiAgICByZXR1cm4gbmV3IEJsaW5kUmVsYXlFcnJvcihtc2csICdQQUlSSU5HX0NBTkNFTExFRCcsIEJsaW5kUmVsYXlFcnJvci5QQUlSSU5HX0NBTkNFTExFRCkKICB9Cn0KewogICJuYW1lIjogImJsaW5kLXJlbGF5IiwKICAidmVyc2lvbiI6ICIxLjQuMCIsCiAgImRlc2NyaXB0aW9uIjogIkJsaW5kIHJlbGF5IGZvciBVRFggb3ZlciBQcm90b211eCBjaGFubmVscyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibGliIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QubWpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JsaW5kLXJlbGF5LmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JsaW5kLXJlbGF5L2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmxpbmQtcmVsYXkjcmVhZG1lIiwKICAiaW1wb3J0cyI6IHsKICAgICJldmVudHMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZXZlbnRzIiwKICAgICAgImRlZmF1bHQiOiAiZXZlbnRzIgogICAgfQogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi40IiwKICAgICJiYXJlLWV2ZW50cyI6ICJeMi4yLjAiLAogICAgImJpdHMtdG8tYnl0ZXMiOiAiXjEuMy4wIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjEyLjAiLAogICAgImNvbXBhY3QtZW5jb2RpbmctYml0ZmllbGQiOiAiXjEuMC4wIiwKICAgICJwcm90b211eCI6ICJeMy41LjEiLAogICAgInNvZGl1bS11bml2ZXJzYWwiOiAiXjUuMC4wIiwKICAgICJzdHJlYW14IjogIl4yLjE1LjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMi4xIiwKICAgICJoeXBlcmRodCI6ICJeNi42LjEiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiLAogICAgInVkeC1uYXRpdmUiOiAiXjEuNi4xIgogIH0KfQovLyBodHRwczovL2lwaW5mby5pby9ib2dvbgoKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBuZXQgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nLW5ldCcpCgptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBmdW5jdGlvbiBpc0JvZ29uIChpcCkgewogIHJldHVybiBpc0JvZ29uSVAoZW5zdXJlQnVmZmVyKGlwKSkKfQoKZXhwb3J0cy5pc0JvZ29uID0gZXhwb3J0cwoKZXhwb3J0cy5pc1ByaXZhdGUgPSBmdW5jdGlvbiBpc1ByaXZhdGUgKGlwKSB7CiAgcmV0dXJuIGlzUHJpdmF0ZUlQKGVuc3VyZUJ1ZmZlcihpcCkpCn0KCmZ1bmN0aW9uIGlzQm9nb25JUCAoaXApIHsKICByZXR1cm4gaXNQcml2YXRlSVAoaXApIHx8IGlzUmVzZXJ2ZWRJUChpcCkKfQoKZnVuY3Rpb24gaXNQcml2YXRlSVAgKGlwKSB7CiAgcmV0dXJuIGlwLmJ5dGVMZW5ndGggPT09IDQgPyBpc1ByaXZhdGVJUHY0KGlwKSA6IGZhbHNlIC8vIElQdjYgaGFzIG5vIHByaXZhdGUgSVBzCn0KCmZ1bmN0aW9uIGlzUHJpdmF0ZUlQdjQgKGlwKSB7CiAgcmV0dXJuICgKICAgIC8vIDEwLjAuMC4wLzggIFByaXZhdGUtdXNlIG5ldHdvcmtzCiAgICAoaXBbMF0gPT09IDEwKSB8fAogICAgLy8gMTAwLjY0LjAuMC8xMCBDYXJyaWVyLWdyYWRlIE5BVAogICAgKGlwWzBdID09PSAxMDAgJiYgaXBbMV0gPj0gNjQgJiYgaXBbMV0gPD0gMTI3KSB8fAogICAgLy8gMTI3LjAuMC4wLzggTG9vcGJhY2sgKyBOYW1lIGNvbGxpc2lvbiBvY2N1cnJlbmNlICgxMjcuMC41My41MykKICAgIChpcFswXSA9PT0gMTI3KSB8fAogICAgLy8gMTY5LjI1NC4wLjAvMTYgIExpbmsgbG9jYWwKICAgIChpcFswXSA9PT0gMTY5ICYmIGlwWzFdID09PSAyNTQpIHx8CiAgICAvLyAxNzIuMTYuMC4wLzEyIFByaXZhdGUtdXNlIG5ldHdvcmtzCiAgICAoaXBbMF0gPT09IDE3MiAmJiBpcFsxXSA+PSAxNiAmJiBpcFsxXSA8PSAzMSkgfHwKICAgIC8vIDE5Mi4xNjguMC4wLzE2ICBQcml2YXRlLXVzZSBuZXR3b3JrcwogICAgKGlwWzBdID09PSAxOTIgJiYgaXBbMV0gPT09IDE2OCkKICApCn0KCmZ1bmN0aW9uIGlzUmVzZXJ2ZWRJUCAoaXApIHsKICByZXR1cm4gaXAuYnl0ZUxlbmd0aCA9PT0gNCA/IGlzUmVzZXJ2ZWRJUHY0KGlwKSA6IGlzUmVzZXJ2ZWRJUHY2KGlwKQp9CgpmdW5jdGlvbiBpc1Jlc2VydmVkSVB2NCAoaXApIHsKICByZXR1cm4gKAogICAgLy8gMC4wLjAuMC84ICJUaGlzIiBuZXR3b3JrCiAgICAoaXBbMF0gPT09IDApIHx8CiAgICAvLyAxOTIuMC4wLjAvMjQgIElFVEYgcHJvdG9jb2wgYXNzaWdubWVudHMKICAgIChpcFswXSA9PT0gMTkyICYmIGlwWzFdID09PSAwICYmIGlwWzJdID09PSAwKSB8fAogICAgLy8gMTkyLjAuMi4wLzI0ICBURVNULU5FVC0xCiAgICAoaXBbMF0gPT09IDE5MiAmJiBpcFsxXSA9PT0gMCAmJiBpcFsyXSA9PT0gMikgfHwKICAgIC8vIDE5OC4xOC4wLjAvMTUgTmV0d29yayBpbnRlcmNvbm5lY3QgZGV2aWNlIGJlbmNobWFyayB0ZXN0aW5nCiAgICAoaXBbMF0gPT09IDE5OCAmJiBpcFsxXSA+PSAxOCAmJiBpcFsxXSA8PSAxOSkgfHwKICAgIC8vIDE5OC41MS4xMDAuMC8yNCBURVNULU5FVC0yCiAgICAoaXBbMF0gPT09IDE5OCAmJiBpcFsxXSA9PT0gNTEgJiYgaXBbMl0gPT09IDEwMCkgfHwKICAgIC8vIDIwMy4wLjExMy4wLzI0ICBURVNULU5FVC0zCiAgICAoaXBbMF0gPT09IDIwMyAmJiBpcFsxXSA9PT0gMCAmJiBpcFsyXSA9PT0gMTEzKSB8fAogICAgLy8gMjI0LjAuMC4wLzQgTXVsdGljYXN0CiAgICAoaXBbMF0gPj0gMjI0ICYmIGlwWzBdIDw9IDIzOSkgfHwKICAgIC8vIDI0MC4wLjAuMC80IFJlc2VydmVkIGZvciBmdXR1cmUgdXNlCiAgICAoaXBbMF0gPj0gMjQwKSB8fAogICAgLy8gMjU1LjI1NS4yNTUuMjU1LzMyCiAgICAoaXBbMF0gPT09IDI1NSAmJiBpcFsxXSA9PT0gMjU1ICYmIGlwWzJdID09PSAyNTUgJiYgaXBbM10gPT09IDI1NSkKICApCn0KCmZ1bmN0aW9uIGlzUmVzZXJ2ZWRJUHY2IChpcCkgewogIHJldHVybiAoCiAgICAvLyA6Oi8xMjggTm9kZS1zY29wZSB1bmljYXN0IHVuc3BlY2lmaWVkIGFkZHJlc3MKICAgIC8vIDo6MS8xMjggTm9kZS1zY29wZSB1bmljYXN0IGxvb3BiYWNrIGFkZHJlc3MKICAgICgKICAgICAgaXBbMF0gPT09IDAgJiYgaXBbMV0gPT09IDAgJiYgaXBbMl0gPT09IDAgJiYgaXBbM10gPT09IDAgJiYgaXBbNF0gPT09IDAgJiYKICAgICAgaXBbNV0gPT09IDAgJiYgaXBbNl0gPT09IDAgJiYgaXBbN10gPT09IDAgJiYgaXBbOF0gPT09IDAgJiYgaXBbOV0gPT09IDAgJiYKICAgICAgaXBbMTBdID09PSAwICYmIGlwWzExXSA9PT0gMCAmJiBpcFsxMl0gPT09IDAgJiYgaXBbMTNdID09PSAwICYmIGlwWzE0XSA9PT0gMCAmJgogICAgICBpcFsxNV0gPD0gMQogICAgKSB8fAogICAgLy8gOjpmZmZmOjA6MC85NiBJUHY0LW1hcHBlZCBhZGRyZXNzZXMKICAgIC8vIDo6Lzk2IElQdjQtY29tcGF0aWJsZSBhZGRyZXNzZXMKICAgICgKICAgICAgaXBbMF0gPT09IDAgJiYgaXBbMV0gPT09IDAgJiYgaXBbMl0gPT09IDAgJiYgaXBbM10gPT09IDAgJiYgaXBbNF0gPT09IDAgJiYKICAgICAgaXBbNV0gPT09IDAgJiYgaXBbNl0gPT09IDAgJiYgaXBbN10gPT09IDAgJiYgaXBbOF0gPT09IDAgJiYgaXBbOV0gPT09IDAgJiYKICAgICAgKGlwWzEwXSA9PT0gMCB8fCBpcFsxMF0gPT09IDB4ZmYpICYmCiAgICAgIChpcFsxMV0gPT09IDAgfHwgaXBbMTFdID09PSAweGZmKQogICAgKSB8fAogICAgLy8gMTAwOjovNjQgUmVtb3RlbHkgdHJpZ2dlcmVkIGJsYWNrIGhvbGUgYWRkcmVzc2VzCiAgICAoaXBbMF0gPT09IDB4MDEgJiYgaXBbMV0gPT09IDAgJiYgaXBbMl0gPT09IDAgJiYgaXBbM10gPT09IDAgJiYgaXBbNF0gPT09IDAgJiYgaXBbNV0gPT09IDAgJiYgaXBbNl0gPT09IDAgJiYgaXBbN10gPT09IDApIHx8CiAgICAvLyAyMDAxOjEwOjovMjggT3ZlcmxheSByb3V0YWJsZSBjcnlwdG9ncmFwaGljIGhhc2ggaWRlbnRpZmllcnMgKE9SQ0hJRCkKICAgIChpcFswXSA9PT0gMHgyMCAmJiBpcFsxXSA9PT0gMHgwMSAmJiBpcFsyXSA9PT0gMCAmJiBpcFszXSA+PSAweDEwICYmIGlwWzNdIDw9IDB4MWYpIHx8CiAgICAvLyAyMDAxOjIwOjovMjggT3ZlcmxheSByb3V0YWJsZSBjcnlwdG9ncmFwaGljIGhhc2ggaWRlbnRpZmllcnMgdmVyc2lvbiAyIChPUkNISUR2MikKICAgIChpcFswXSA9PT0gMHgyMCAmJiBpcFsxXSA9PT0gMHgwMSAmJiBpcFsyXSA9PT0gMCAmJiBpcFszXSA+PSAweDIwICYmIGlwWzNdIDw9IDB4MmYpIHx8CiAgICAvLyAyMDAxOmRiODo6LzMyIERvY3VtZW50YXRpb24gcHJlZml4CiAgICAoaXBbMF0gPT09IDB4MjAgJiYgaXBbMV0gPT09IDB4MDEgJiYgaXBbMl0gPT09IDB4MGQgJiYgaXBbM10gPT09IDB4YjgpIHx8CiAgICAvLyBmYzAwOjovNyBVbmlxdWUgbG9jYWwgYWRkcmVzc2VzIChVTEEpCiAgICAoaXBbMF0gPj0gMHhmYyAmJiBpcFswXSA8PSAweGZkKSB8fAogICAgLy8gZmU4MDo6LzEwIExpbmstbG9jYWwgdW5pY2FzdAogICAgKGlwWzBdID09PSAweGZlICYmIGlwWzFdID49IDB4ODAgJiYgaXBbMV0gPD0gMHhiZikgfHwKICAgIC8vIGZmMDA6Oi84IE11bHRpY2FzdAogICAgKGlwWzBdID09PSAweGZmKQogICkKfQoKY29uc3Qgc3RhdGUgPSBjLnN0YXRlKDAsIDAsIGI0YS5hbGxvY1Vuc2FmZSgxIC8qIGZhbWlseSAqLyArIDE2KSkKCmZ1bmN0aW9uIGVuc3VyZUJ1ZmZlciAoaXApIHsKICBpZiAoYjRhLmlzQnVmZmVyKGlwKSkgcmV0dXJuIGlwCgogIG5ldC5pcC5wcmVlbmNvZGUoc3RhdGUsIGlwKQogIG5ldC5pcC5lbmNvZGUoc3RhdGUsIGlwKQoKICBjb25zdCBidWZmZXIgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoMSAvKiBmYW1pbHkgKi8sIHN0YXRlLmVuZCkKCiAgc3RhdGUuc3RhcnQgPSAwCiAgc3RhdGUuZW5kID0gMAoKICByZXR1cm4gYnVmZmVyCn0KewogICJuYW1lIjogImJvZ29uIiwKICAidmVyc2lvbiI6ICIxLjEuMCIsCiAgImRlc2NyaXB0aW9uIjogIkNoZWNrIGlmIGFuIElQIGlzIGEgYm9nb24iLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5tanMiCiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuMTEuMCIsCiAgICAiY29tcGFjdC1lbmNvZGluZy1uZXQiOiAiXjEuMi4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjAuNCIsCiAgICAibmFub2JlbmNoIjogIl4yLjEuMSIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9ib2dvbi5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvYm9nb24vaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvYm9nb24iCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCm1vZHVsZS5leHBvcnRzID0gY29kZWNzCgpjb2RlY3MuYXNjaWkgPSBjcmVhdGVTdHJpbmcoJ2FzY2lpJykKY29kZWNzLnV0ZjggPSBjcmVhdGVTdHJpbmcoJ3V0Zi04JykKY29kZWNzLmhleCA9IGNyZWF0ZVN0cmluZygnaGV4JykKY29kZWNzLmJhc2U2NCA9IGNyZWF0ZVN0cmluZygnYmFzZTY0JykKY29kZWNzLnVjczIgPSBjcmVhdGVTdHJpbmcoJ3VjczInKQpjb2RlY3MudXRmMTZsZSA9IGNyZWF0ZVN0cmluZygndXRmMTZsZScpCmNvZGVjcy5uZGpzb24gPSBjcmVhdGVKU09OKHRydWUpCmNvZGVjcy5qc29uID0gY3JlYXRlSlNPTihmYWxzZSkKY29kZWNzLmJpbmFyeSA9IHsKICBuYW1lOiAnYmluYXJ5JywKICBlbmNvZGU6IGZ1bmN0aW9uIGVuY29kZUJpbmFyeSAob2JqKSB7CiAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ3N0cmluZycKICAgICAgPyBiNGEuZnJvbShvYmosICd1dGYtOCcpCiAgICAgIDogYjRhLnRvQnVmZmVyKG9iaikKICB9LAogIGRlY29kZTogZnVuY3Rpb24gZGVjb2RlQmluYXJ5IChidWYpIHsKICAgIHJldHVybiBiNGEudG9CdWZmZXIoYnVmKQogIH0KfQoKZnVuY3Rpb24gaXNDb21wYWN0RW5jb2RpbmcgKGMpIHsKICByZXR1cm4gISEoYy5lbmNvZGUgJiYgYy5kZWNvZGUgJiYgYy5wcmVlbmNvZGUpCn0KCmZ1bmN0aW9uIGZyb21Db21wYWN0RW5jb2RpbmcgKGMpIHsKICByZXR1cm4gewogICAgbmFtZTogJ2NvbXBhY3QtZW5jb2RpbmcnLAogICAgZW5jb2RlOiBmdW5jdGlvbiBlbmNvZGVXaXRoQ29tcGFjdCAodmFsdWUpIHsKICAgICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDAsIGJ1ZmZlcjogbnVsbCwgY2FjaGU6IG51bGwgfQogICAgICBjLnByZWVuY29kZShzdGF0ZSwgdmFsdWUpCiAgICAgIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShzdGF0ZS5lbmQpCiAgICAgIGMuZW5jb2RlKHN0YXRlLCB2YWx1ZSkKICAgICAgcmV0dXJuIHN0YXRlLmJ1ZmZlcgogICAgfSwKICAgIGRlY29kZTogZnVuY3Rpb24gZGVjb2RlV2l0aENvbXBhY3QgKGJ1ZmZlcikgewogICAgICByZXR1cm4gYy5kZWNvZGUoeyBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCwgYnVmZmVyLCBjYWNoZTogbnVsbCB9KQogICAgfQogIH0KfQoKZnVuY3Rpb24gY29kZWNzIChmbXQsIGZhbGxiYWNrKSB7CiAgaWYgKHR5cGVvZiBmbXQgPT09ICdvYmplY3QnICYmIGZtdCkgewogICAgcmV0dXJuIGlzQ29tcGFjdEVuY29kaW5nKGZtdCkgPyBmcm9tQ29tcGFjdEVuY29kaW5nKGZtdCkgOiBmbXQKICB9CgogIHN3aXRjaCAoZm10KSB7CiAgICBjYXNlICduZGpzb24nOiByZXR1cm4gY29kZWNzLm5kanNvbgogICAgY2FzZSAnanNvbic6IHJldHVybiBjb2RlY3MuanNvbgogICAgY2FzZSAnYXNjaWknOiByZXR1cm4gY29kZWNzLmFzY2lpCiAgICBjYXNlICd1dGYtOCc6CiAgICBjYXNlICd1dGY4JzogcmV0dXJuIGNvZGVjcy51dGY4CiAgICBjYXNlICdoZXgnOiByZXR1cm4gY29kZWNzLmhleAogICAgY2FzZSAnYmFzZTY0JzogcmV0dXJuIGNvZGVjcy5iYXNlNjQKICAgIGNhc2UgJ3Vjcy0yJzoKICAgIGNhc2UgJ3VjczInOiByZXR1cm4gY29kZWNzLnVjczIKICAgIGNhc2UgJ3V0ZjE2LWxlJzoKICAgIGNhc2UgJ3V0ZjE2bGUnOiByZXR1cm4gY29kZWNzLnV0ZjE2bGUKICB9CgogIHJldHVybiBmYWxsYmFjayAhPT0gdW5kZWZpbmVkID8gZmFsbGJhY2sgOiBjb2RlY3MuYmluYXJ5Cn0KCmZ1bmN0aW9uIGNyZWF0ZUpTT04gKG5ld2xpbmUpIHsKICByZXR1cm4gewogICAgbmFtZTogbmV3bGluZSA/ICduZGpzb24nIDogJ2pzb24nLAogICAgZW5jb2RlOiBuZXdsaW5lID8gZW5jb2RlTkRKU09OIDogZW5jb2RlSlNPTiwKICAgIGRlY29kZTogZnVuY3Rpb24gZGVjb2RlSlNPTiAoYnVmKSB7CiAgICAgIHJldHVybiBKU09OLnBhcnNlKGI0YS50b1N0cmluZyhidWYpKQogICAgfQogIH0KCiAgZnVuY3Rpb24gZW5jb2RlSlNPTiAodmFsKSB7CiAgICByZXR1cm4gYjRhLmZyb20oSlNPTi5zdHJpbmdpZnkodmFsKSkKICB9CgogIGZ1bmN0aW9uIGVuY29kZU5ESlNPTiAodmFsKSB7CiAgICByZXR1cm4gYjRhLmZyb20oSlNPTi5zdHJpbmdpZnkodmFsKSArICdcbicpCiAgfQp9CgpmdW5jdGlvbiBjcmVhdGVTdHJpbmcgKHR5cGUpIHsKICByZXR1cm4gewogICAgbmFtZTogdHlwZSwKICAgIGVuY29kZTogZnVuY3Rpb24gZW5jb2RlU3RyaW5nICh2YWwpIHsKICAgICAgaWYgKHR5cGVvZiB2YWwgIT09ICdzdHJpbmcnKSB2YWwgPSB2YWwudG9TdHJpbmcoKQogICAgICByZXR1cm4gYjRhLmZyb20odmFsLCB0eXBlKQogICAgfSwKICAgIGRlY29kZTogZnVuY3Rpb24gZGVjb2RlU3RyaW5nIChidWYpIHsKICAgICAgcmV0dXJuIGI0YS50b1N0cmluZyhidWYsIHR5cGUpCiAgICB9CiAgfQp9CnsKICAibmFtZSI6ICJjb2RlY3MiLAogICJ2ZXJzaW9uIjogIjMuMS4wIiwKICAiZGVzY3JpcHRpb24iOiAiQ3JlYXRlIGFuIGJpbmFyeSBlbmNvZGVyL2RlY29kZXIgZm9yIGpzb24sIHV0Zi04IG9yIGN1c3RvbSB0eXBlcyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMyIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4yLjEiLAogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuMTEuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2NvZGVjcy5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvY29kZWNzL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2NvZGVjcyIKfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGJpdGZpZWxkIChsZW5ndGgpIHsKICBpZiAobGVuZ3RoID4gNjQpIHRocm93IG5ldyBSYW5nZUVycm9yKCdCaXRmaWVsZCBjYW5ub3QgYmUgbGFyZ2VyIHRoYW4gNjQgYml0cycpCgogIGxldCBieXRlTGVuZ3RoCiAgaWYgKGxlbmd0aCA8IDgpIGJ5dGVMZW5ndGggPSAxCiAgZWxzZSBpZiAobGVuZ3RoIDw9IDE2KSBieXRlTGVuZ3RoID0gMgogIGVsc2UgaWYgKGxlbmd0aCA8PSAzMikgYnl0ZUxlbmd0aCA9IDQKICBlbHNlIGJ5dGVMZW5ndGggPSA4CgogIHJldHVybiB7CiAgICBwcmVlbmNvZGUgKHN0YXRlKSB7CiAgICAgIHN0YXRlLmVuZCsrIC8vIExlbmd0aCBieXRlLCB1c2VkIGZvciBkYXRhIHdoZW4gYnl0ZUxlbmd0aCA9PT0gMQoKICAgICAgaWYgKGJ5dGVMZW5ndGggPT09IDEpIDsKICAgICAgZWxzZSBpZiAoYnl0ZUxlbmd0aCA9PT0gMikgYy51aW50MTYucHJlZW5jb2RlKHN0YXRlKQogICAgICBlbHNlIGlmIChieXRlTGVuZ3RoID09PSA0KSBjLnVpbnQzMi5wcmVlbmNvZGUoc3RhdGUpCiAgICAgIGVsc2UgYy51aW50NjQucHJlZW5jb2RlKHN0YXRlKQogICAgfSwKCiAgICBlbmNvZGUgKHN0YXRlLCBiKSB7CiAgICAgIGlmIChieXRlTGVuZ3RoID09PSAxKSA7CiAgICAgIGVsc2UgaWYgKGJ5dGVMZW5ndGggPT09IDIpIGMudWludDguZW5jb2RlKHN0YXRlLCAweGZkKQogICAgICBlbHNlIGlmIChieXRlTGVuZ3RoID09PSA0KSBjLnVpbnQ4LmVuY29kZShzdGF0ZSwgMHhmZSkKICAgICAgZWxzZSBjLnVpbnQ4LmVuY29kZShzdGF0ZSwgMHhmZikKCiAgICAgIGlmICh0eXBlb2YgYiA9PT0gJ251bWJlcicpIHsKICAgICAgICBpZiAoYnl0ZUxlbmd0aCA9PT0gMSkgYy51aW50OC5lbmNvZGUoc3RhdGUsIGIpCiAgICAgICAgZWxzZSBpZiAoYnl0ZUxlbmd0aCA9PT0gMikgYy51aW50MTYuZW5jb2RlKHN0YXRlLCBiKQogICAgICAgIGVsc2UgaWYgKGJ5dGVMZW5ndGggPT09IDQpIGMudWludDMyLmVuY29kZShzdGF0ZSwgYikKICAgICAgICBlbHNlIGMudWludDY0LmVuY29kZShzdGF0ZSwgYikKICAgICAgfSBlbHNlIHsKICAgICAgICBzdGF0ZS5idWZmZXIuc2V0KGIsIHN0YXRlLnN0YXJ0KQoKICAgICAgICBpZiAoYi5ieXRlTGVuZ3RoIDwgYnl0ZUxlbmd0aCkgewogICAgICAgICAgLy8gWmVyby1maWxsIHRoZSByZXN0IG9mIHRoZSBieXRlIGxlbmd0aC4KICAgICAgICAgIHN0YXRlLmJ1ZmZlci5maWxsKAogICAgICAgICAgICAwLAogICAgICAgICAgICBzdGF0ZS5zdGFydCArIGIuYnl0ZUxlbmd0aCwKICAgICAgICAgICAgc3RhdGUuc3RhcnQgKyBieXRlTGVuZ3RoCiAgICAgICAgICApCiAgICAgICAgfQoKICAgICAgICBzdGF0ZS5zdGFydCArPSBieXRlTGVuZ3RoCiAgICAgIH0KICAgIH0sCgogICAgZGVjb2RlIChzdGF0ZSkgewogICAgICBjb25zdCBieXRlID0gc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0XQoKICAgICAgbGV0IGJ5dGVMZW5ndGgKICAgICAgaWYgKGJ5dGUgPD0gMHhmYykgYnl0ZUxlbmd0aCA9IDEKICAgICAgZWxzZSBpZiAoYnl0ZSA9PT0gMHhmZCkgYnl0ZUxlbmd0aCA9IDIKICAgICAgZWxzZSBpZiAoYnl0ZSA9PT0gMHhmZSkgYnl0ZUxlbmd0aCA9IDQKICAgICAgZWxzZSBieXRlTGVuZ3RoID0gOAoKICAgICAgaWYgKGJ5dGVMZW5ndGggPiAxKSBzdGF0ZS5zdGFydCsrIC8vIFNraXAgdGhlIGxlbmd0aCBieXRlCgogICAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCBieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQoKICAgICAgY29uc3QgYiA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCwgKHN0YXRlLnN0YXJ0ICs9IGJ5dGVMZW5ndGgpKQoKICAgICAgcmV0dXJuIGxlbmd0aCA8PSA4ID8gYi5zdWJhcnJheSgwLCAxKSA6IGIKICAgIH0KICB9Cn0KewogICJuYW1lIjogImNvbXBhY3QtZW5jb2RpbmctYml0ZmllbGQiLAogICJ2ZXJzaW9uIjogIjEuMC4wIiwKICAiZGVzY3JpcHRpb24iOiAiQ29tcGFjdCBjb2RlYyBmb3IgYml0ZmllbGRzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QubWpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2NvbXBhY3QtZW5jb2RpbmcvY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZC5naXQiCiAgfSwKICAiYXV0aG9yIjogIkthc3BlciBJc2FnZXIgRGFsc2dhcsOwIDxrYXNwZXJAZnVua3Rpb25lbC5jbz4iLAogICJsaWNlbnNlIjogIklTQyIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9jb21wYWN0LWVuY29kaW5nL2NvbXBhY3QtZW5jb2RpbmctYml0ZmllbGQvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9jb21wYWN0LWVuY29kaW5nL2NvbXBhY3QtZW5jb2RpbmctYml0ZmllbGQjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuNC4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4xLjMuNSIsCiAgICAic3RhbmRhcmQiOiAiXjE2LjAuMyIKICB9LAogICJzdGFuZGFyZCI6IHsKICAgICJpZ25vcmUiOiBbCiAgICAgICJfX3NuYXBzaG90c19fLyoqIgogICAgXQogIH0KfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCgpjb25zdCBwb3J0ID0gYy51aW50MTYKCmNvbnN0IGFkZHJlc3MgPSAoaG9zdCwgZmFtaWx5KSA9PiB7CiAgcmV0dXJuIHsKICAgIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgICAgaG9zdC5wcmVlbmNvZGUoc3RhdGUsIG0uaG9zdCkKICAgICAgcG9ydC5wcmVlbmNvZGUoc3RhdGUsIG0ucG9ydCkKICAgIH0sCiAgICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICAgIGhvc3QuZW5jb2RlKHN0YXRlLCBtLmhvc3QpCiAgICAgIHBvcnQuZW5jb2RlKHN0YXRlLCBtLnBvcnQpCiAgICB9LAogICAgZGVjb2RlIChzdGF0ZSkgewogICAgICByZXR1cm4gewogICAgICAgIGhvc3Q6IGhvc3QuZGVjb2RlKHN0YXRlKSwKICAgICAgICBmYW1pbHksCiAgICAgICAgcG9ydDogcG9ydC5kZWNvZGUoc3RhdGUpCiAgICAgIH0KICAgIH0KICB9Cn0KCmNvbnN0IGlwdjQgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSkgewogICAgc3RhdGUuZW5kICs9IDQKICB9LAogIGVuY29kZSAoc3RhdGUsIHN0cmluZykgewogICAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogICAgY29uc3QgZW5kID0gc3RhcnQgKyA0CgogICAgbGV0IGkgPSAwCgogICAgd2hpbGUgKGkgPCBzdHJpbmcubGVuZ3RoKSB7CiAgICAgIGxldCBuID0gMAogICAgICBsZXQgYwoKICAgICAgd2hpbGUgKGkgPCBzdHJpbmcubGVuZ3RoICYmIChjID0gc3RyaW5nLmNoYXJDb2RlQXQoaSsrKSkgIT09IC8qIC4gKi8gMHgyZSkgewogICAgICAgIG4gPSBuICogMTAgKyAoYyAtIC8qIDAgKi8gMHgzMCkKICAgICAgfQoKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgogICAgfQoKICAgIHN0YXRlLnN0YXJ0ID0gZW5kCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA0KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuICgKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsgJy4nICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsgJy4nICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsgJy4nICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgICApCiAgfQp9Cgpjb25zdCBpcHY0QWRkcmVzcyA9IGFkZHJlc3MoaXB2NCwgNCkKCmNvbnN0IGlwdjYgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSkgewogICAgc3RhdGUuZW5kICs9IDE2CiAgfSwKICBlbmNvZGUgKHN0YXRlLCBzdHJpbmcpIHsKICAgIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgMTYKCiAgICBsZXQgaSA9IDAKICAgIGxldCBzcGxpdCA9IG51bGwKCiAgICB3aGlsZSAoaSA8IHN0cmluZy5sZW5ndGgpIHsKICAgICAgbGV0IG4gPSAwCiAgICAgIGxldCBjCgogICAgICB3aGlsZSAoaSA8IHN0cmluZy5sZW5ndGggJiYgKGMgPSBzdHJpbmcuY2hhckNvZGVBdChpKyspKSAhPT0gLyogOiAqLyAweDNhKSB7CiAgICAgICAgaWYgKGMgPj0gMHgzMCAmJiBjIDw9IDB4MzkpIG4gPSBuICogMHgxMCArIChjIC0gLyogMCAqLyAweDMwKQogICAgICAgIGVsc2UgaWYgKGMgPj0gMHg0MSAmJiBjIDw9IDB4NDYpIG4gPSBuICogMHgxMCArIChjIC0gLyogQSAqLyAweDQxICsgMTApCiAgICAgICAgZWxzZSBpZiAoYyA+PSAweDYxICYmIGMgPD0gMHg2NikgbiA9IG4gKiAweDEwICsgKGMgLSAvKiBhICovIDB4NjEgKyAxMCkKICAgICAgfQoKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gOAogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuCgogICAgICBpZiAoaSA8IHN0cmluZy5sZW5ndGggJiYgc3RyaW5nLmNoYXJDb2RlQXQoaSkgPT09IC8qIDogKi8gMHgzYSkgewogICAgICAgIGkrKwogICAgICAgIHNwbGl0ID0gc3RhdGUuc3RhcnQKICAgICAgfQogICAgfQoKICAgIGlmIChzcGxpdCAhPT0gbnVsbCkgewogICAgICBjb25zdCBvZmZzZXQgPSBlbmQgLSBzdGF0ZS5zdGFydAogICAgICBzdGF0ZS5idWZmZXIKICAgICAgICAuY29weVdpdGhpbihzcGxpdCArIG9mZnNldCwgc3BsaXQpCiAgICAgICAgLmZpbGwoMCwgc3BsaXQsIHNwbGl0ICsgb2Zmc2V0KQogICAgfQoKICAgIHN0YXRlLnN0YXJ0ID0gZW5kCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCAxNikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiAoCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKyBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10pLnRvU3RyaW5nKDE2KSArICc6JyArCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKyBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10pLnRvU3RyaW5nKDE2KSArICc6JyArCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKyBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10pLnRvU3RyaW5nKDE2KSArICc6JyArCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKyBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10pLnRvU3RyaW5nKDE2KSArICc6JyArCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKyBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10pLnRvU3RyaW5nKDE2KSArICc6JyArCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKyBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10pLnRvU3RyaW5nKDE2KSArICc6JyArCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKyBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10pLnRvU3RyaW5nKDE2KSArICc6JyArCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKyBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10pLnRvU3RyaW5nKDE2KQogICAgKQogIH0KfQoKY29uc3QgaXB2NkFkZHJlc3MgPSBhZGRyZXNzKGlwdjYsIDYpCgpjb25zdCBpcCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBzdHJpbmcpIHsKICAgIGNvbnN0IGZhbWlseSA9IHN0cmluZy5pbmNsdWRlcygnOicpID8gNiA6IDQKICAgIGMudWludDgucHJlZW5jb2RlKHN0YXRlLCBmYW1pbHkpCiAgICBpZiAoZmFtaWx5ID09PSA0KSBpcHY0LnByZWVuY29kZShzdGF0ZSkKICAgIGVsc2UgaXB2Ni5wcmVlbmNvZGUoc3RhdGUpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBzdHJpbmcpIHsKICAgIGNvbnN0IGZhbWlseSA9IHN0cmluZy5pbmNsdWRlcygnOicpID8gNiA6IDQKICAgIGMudWludDguZW5jb2RlKHN0YXRlLCBmYW1pbHkpCiAgICBpZiAoZmFtaWx5ID09PSA0KSBpcHY0LmVuY29kZShzdGF0ZSwgc3RyaW5nKQogICAgZWxzZSBpcHY2LmVuY29kZShzdGF0ZSwgc3RyaW5nKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgZmFtaWx5ID0gYy51aW50OC5kZWNvZGUoc3RhdGUpCiAgICBpZiAoZmFtaWx5ID09PSA0KSByZXR1cm4gaXB2NC5kZWNvZGUoc3RhdGUpCiAgICBlbHNlIHJldHVybiBpcHY2LmRlY29kZShzdGF0ZSkKICB9Cn0KCmNvbnN0IGlwQWRkcmVzcyA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBpcC5wcmVlbmNvZGUoc3RhdGUsIG0uaG9zdCkKICAgIHBvcnQucHJlZW5jb2RlKHN0YXRlLCBtLnBvcnQpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBpcC5lbmNvZGUoc3RhdGUsIG0uaG9zdCkKICAgIHBvcnQuZW5jb2RlKHN0YXRlLCBtLnBvcnQpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmYW1pbHkgPSBjLnVpbnQ4LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIGhvc3Q6IGZhbWlseSA9PT0gNCA/IGlwdjQuZGVjb2RlKHN0YXRlKSA6IGlwdjYuZGVjb2RlKHN0YXRlKSwKICAgICAgZmFtaWx5LAogICAgICBwb3J0OiBwb3J0LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gewogIHBvcnQsCiAgaXB2NCwKICBpcHY0QWRkcmVzcywKICBpcHY2LAogIGlwdjZBZGRyZXNzLAogIGlwLAogIGlwQWRkcmVzcwp9CnsKICAibmFtZSI6ICJjb21wYWN0LWVuY29kaW5nLW5ldCIsCiAgInZlcnNpb24iOiAiMS4yLjAiLAogICJkZXNjcmlwdGlvbiI6ICJDb21wYWN0IGNvZGVjcyBmb3IgbmV0IHR5cGVzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QubWpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2NvbXBhY3QtZW5jb2RpbmcvY29tcGFjdC1lbmNvZGluZy1uZXQuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJLYXNwZXIgSXNhZ2VyIERhbHNnYXLDsCA8a2FzcGVyQGZ1bmt0aW9uZWwuY28+IiwKICAibGljZW5zZSI6ICJJU0MiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vY29tcGFjdC1lbmNvZGluZy9jb21wYWN0LWVuY29kaW5nLW5ldC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2NvbXBhY3QtZW5jb2RpbmcvY29tcGFjdC1lbmNvZGluZy1uZXQjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuNC4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4xLjMuNSIsCiAgICAibmFub2JlbmNoIjogIl4yLjEuMSIsCiAgICAic3RhbmRhcmQiOiAiXjE2LjAuMyIKICB9Cn0KY29uc3QgTEUgPSAoZXhwb3J0cy5MRSA9CiAgbmV3IFVpbnQ4QXJyYXkobmV3IFVpbnQxNkFycmF5KFsweGZmXSkuYnVmZmVyKVswXSA9PT0gMHhmZikKCmV4cG9ydHMuQkUgPSAhTEUKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IHsgQkUgfSA9IHJlcXVpcmUoJy4vZW5kaWFuJykKCmV4cG9ydHMuc3RhdGUgPSBmdW5jdGlvbiAoc3RhcnQgPSAwLCBlbmQgPSAwLCBidWZmZXIgPSBudWxsKSB7CiAgcmV0dXJuIHsgc3RhcnQsIGVuZCwgYnVmZmVyIH0KfQoKY29uc3QgcmF3ID0gKGV4cG9ydHMucmF3ID0gcmVxdWlyZSgnLi9yYXcnKSkKCmNvbnN0IHVpbnQgPSAoZXhwb3J0cy51aW50ID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kICs9IG4gPD0gMHhmYyA/IDEgOiBuIDw9IDB4ZmZmZiA/IDMgOiBuIDw9IDB4ZmZmZmZmZmYgPyA1IDogOQogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBpZiAobiA8PSAweGZjKSB1aW50OC5lbmNvZGUoc3RhdGUsIG4pCiAgICBlbHNlIGlmIChuIDw9IDB4ZmZmZikgewogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweGZkCiAgICAgIHVpbnQxNi5lbmNvZGUoc3RhdGUsIG4pCiAgICB9IGVsc2UgaWYgKG4gPD0gMHhmZmZmZmZmZikgewogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweGZlCiAgICAgIHVpbnQzMi5lbmNvZGUoc3RhdGUsIG4pCiAgICB9IGVsc2UgewogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweGZmCiAgICAgIHVpbnQ2NC5lbmNvZGUoc3RhdGUsIG4pCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGEgPSB1aW50OC5kZWNvZGUoc3RhdGUpCiAgICBpZiAoYSA8PSAweGZjKSByZXR1cm4gYQogICAgaWYgKGEgPT09IDB4ZmQpIHJldHVybiB1aW50MTYuZGVjb2RlKHN0YXRlKQogICAgaWYgKGEgPT09IDB4ZmUpIHJldHVybiB1aW50MzIuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHVpbnQ2NC5kZWNvZGUoc3RhdGUpCiAgfQp9KQoKY29uc3QgdWludDggPSAoZXhwb3J0cy51aW50OCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSAxCiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHZhbGlkYXRlVWludChuKQogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuc3RhcnQgPj0gc3RhdGUuZW5kKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogIH0KfSkKCmNvbnN0IHVpbnQxNiA9IChleHBvcnRzLnVpbnQxNiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSAyCiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHZhbGlkYXRlVWludChuKQogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gOAogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCAyKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwCiAgfQp9KQoKY29uc3QgdWludDI0ID0gKGV4cG9ydHMudWludDI0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kICs9IDMKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgdmFsaWRhdGVVaW50KG4pCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuID4+PiA4CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuID4+PiAxNgogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCAzKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuICgKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMHgxMDAgKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMDAwCiAgICApCiAgfQp9KQoKY29uc3QgdWludDMyID0gKGV4cG9ydHMudWludDMyID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kICs9IDQKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgdmFsaWRhdGVVaW50KG4pCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuID4+PiA4CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuID4+PiAxNgogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gMjQKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgNCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiAoCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMHgxMDAwMCArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwMDAwMAogICAgKQogIH0KfSkKCmNvbnN0IHVpbnQ0MCA9IChleHBvcnRzLnVpbnQ0MCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSA1CiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHZhbGlkYXRlVWludChuKQogICAgY29uc3QgciA9IE1hdGguZmxvb3IobiAvIDB4MTAwKQogICAgdWludDguZW5jb2RlKHN0YXRlLCBuKQogICAgdWludDMyLmVuY29kZShzdGF0ZSwgcikKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgNSkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiB1aW50OC5kZWNvZGUoc3RhdGUpICsgMHgxMDAgKiB1aW50MzIuZGVjb2RlKHN0YXRlKQogIH0KfSkKCmNvbnN0IHVpbnQ0OCA9IChleHBvcnRzLnVpbnQ0OCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSA2CiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHZhbGlkYXRlVWludChuKQogICAgY29uc3QgciA9IE1hdGguZmxvb3IobiAvIDB4MTAwMDApCiAgICB1aW50MTYuZW5jb2RlKHN0YXRlLCBuKQogICAgdWludDMyLmVuY29kZShzdGF0ZSwgcikKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgNikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiB1aW50MTYuZGVjb2RlKHN0YXRlKSArIDB4MTAwMDAgKiB1aW50MzIuZGVjb2RlKHN0YXRlKQogIH0KfSkKCmNvbnN0IHVpbnQ1NiA9IChleHBvcnRzLnVpbnQ1NiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSA3CiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHZhbGlkYXRlVWludChuKQogICAgY29uc3QgciA9IE1hdGguZmxvb3IobiAvIDB4MTAwMDAwMCkKICAgIHVpbnQyNC5lbmNvZGUoc3RhdGUsIG4pCiAgICB1aW50MzIuZW5jb2RlKHN0YXRlLCByKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA3KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuIHVpbnQyNC5kZWNvZGUoc3RhdGUpICsgMHgxMDAwMDAwICogdWludDMyLmRlY29kZShzdGF0ZSkKICB9Cn0pCgpjb25zdCB1aW50NjQgPSAoZXhwb3J0cy51aW50NjQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gOAogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICB2YWxpZGF0ZVVpbnQobikKICAgIGNvbnN0IHIgPSBNYXRoLmZsb29yKG4gLyAweDEwMDAwMDAwMCkKICAgIHVpbnQzMi5lbmNvZGUoc3RhdGUsIG4pCiAgICB1aW50MzIuZW5jb2RlKHN0YXRlLCByKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA4KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuIHVpbnQzMi5kZWNvZGUoc3RhdGUpICsgMHgxMDAwMDAwMDAgKiB1aW50MzIuZGVjb2RlKHN0YXRlKQogIH0KfSkKCmNvbnN0IGludCA9IChleHBvcnRzLmludCA9IHppZ1phZ0ludCh1aW50KSkKZXhwb3J0cy5pbnQ4ID0gemlnWmFnSW50KHVpbnQ4KQpleHBvcnRzLmludDE2ID0gemlnWmFnSW50KHVpbnQxNikKZXhwb3J0cy5pbnQyNCA9IHppZ1phZ0ludCh1aW50MjQpCmV4cG9ydHMuaW50MzIgPSB6aWdaYWdJbnQodWludDMyKQpleHBvcnRzLmludDQwID0gemlnWmFnSW50KHVpbnQ0MCkKZXhwb3J0cy5pbnQ0OCA9IHppZ1phZ0ludCh1aW50NDgpCmV4cG9ydHMuaW50NTYgPSB6aWdaYWdJbnQodWludDU2KQpleHBvcnRzLmludDY0ID0gemlnWmFnSW50KHVpbnQ2NCkKCmNvbnN0IGJpZ3VpbnQ2NCA9IChleHBvcnRzLmJpZ3VpbnQ2NCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSA4CiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoCiAgICAgIHN0YXRlLmJ1ZmZlci5idWZmZXIsCiAgICAgIHN0YXRlLnN0YXJ0ICsgc3RhdGUuYnVmZmVyLmJ5dGVPZmZzZXQsCiAgICAgIDgKICAgICkKICAgIHZpZXcuc2V0QmlnVWludDY0KDAsIG4sIHRydWUpIC8vIGxpdHRsZSBlbmRpYW4KICAgIHN0YXRlLnN0YXJ0ICs9IDgKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgOCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoCiAgICAgIHN0YXRlLmJ1ZmZlci5idWZmZXIsCiAgICAgIHN0YXRlLnN0YXJ0ICsgc3RhdGUuYnVmZmVyLmJ5dGVPZmZzZXQsCiAgICAgIDgKICAgICkKICAgIGNvbnN0IG4gPSB2aWV3LmdldEJpZ1VpbnQ2NCgwLCB0cnVlKSAvLyBsaXR0bGUgZW5kaWFuCiAgICBzdGF0ZS5zdGFydCArPSA4CiAgICByZXR1cm4gbgogIH0KfSkKCmV4cG9ydHMuYmlnaW50NjQgPSB6aWdaYWdCaWdJbnQoYmlndWludDY0KQoKY29uc3QgYmlndWludCA9IChleHBvcnRzLmJpZ3VpbnQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBsZXQgbGVuID0gMAogICAgZm9yIChsZXQgbSA9IG47IG07IG0gPSBtID4+IDY0bikgbGVuKysKICAgIHVpbnQucHJlZW5jb2RlKHN0YXRlLCBsZW4pCiAgICBzdGF0ZS5lbmQgKz0gOCAqIGxlbgogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBsZXQgbGVuID0gMAogICAgZm9yIChsZXQgbSA9IG47IG07IG0gPSBtID4+IDY0bikgbGVuKysKICAgIHVpbnQuZW5jb2RlKHN0YXRlLCBsZW4pCiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KAogICAgICBzdGF0ZS5idWZmZXIuYnVmZmVyLAogICAgICBzdGF0ZS5zdGFydCArIHN0YXRlLmJ1ZmZlci5ieXRlT2Zmc2V0LAogICAgICA4ICogbGVuCiAgICApCiAgICBmb3IgKGxldCBtID0gbiwgaSA9IDA7IG07IG0gPSBtID4+IDY0biwgaSArPSA4KSB7CiAgICAgIHZpZXcuc2V0QmlnVWludDY0KGksIEJpZ0ludC5hc1VpbnROKDY0LCBtKSwgdHJ1ZSkgLy8gbGl0dGxlIGVuZGlhbgogICAgfQogICAgc3RhdGUuc3RhcnQgKz0gOCAqIGxlbgogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBsZW4gPSB1aW50LmRlY29kZShzdGF0ZSkKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDggKiBsZW4pIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KAogICAgICBzdGF0ZS5idWZmZXIuYnVmZmVyLAogICAgICBzdGF0ZS5zdGFydCArIHN0YXRlLmJ1ZmZlci5ieXRlT2Zmc2V0LAogICAgICA4ICogbGVuCiAgICApCiAgICBsZXQgbiA9IDBuCiAgICBmb3IgKGxldCBpID0gbGVuIC0gMTsgaSA+PSAwOyBpLS0pCiAgICAgIG4gPSAobiA8PCA2NG4pICsgdmlldy5nZXRCaWdVaW50NjQoaSAqIDgsIHRydWUpIC8vIGxpdHRsZSBlbmRpYW4KICAgIHN0YXRlLnN0YXJ0ICs9IDggKiBsZW4KICAgIHJldHVybiBuCiAgfQp9KQoKZXhwb3J0cy5iaWdpbnQgPSB6aWdaYWdCaWdJbnQoYmlndWludCkKCmV4cG9ydHMubGV4aW50ID0gcmVxdWlyZSgnLi9sZXhpbnQnKQoKZXhwb3J0cy5mbG9hdDMyID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kICs9IDQKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldygKICAgICAgc3RhdGUuYnVmZmVyLmJ1ZmZlciwKICAgICAgc3RhdGUuc3RhcnQgKyBzdGF0ZS5idWZmZXIuYnl0ZU9mZnNldCwKICAgICAgNAogICAgKQogICAgdmlldy5zZXRGbG9hdDMyKDAsIG4sIHRydWUpIC8vIGxpdHRsZSBlbmRpYW4KICAgIHN0YXRlLnN0YXJ0ICs9IDQKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgNCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoCiAgICAgIHN0YXRlLmJ1ZmZlci5idWZmZXIsCiAgICAgIHN0YXRlLnN0YXJ0ICsgc3RhdGUuYnVmZmVyLmJ5dGVPZmZzZXQsCiAgICAgIDQKICAgICkKICAgIGNvbnN0IGZsb2F0ID0gdmlldy5nZXRGbG9hdDMyKDAsIHRydWUpIC8vIGxpdHRsZSBlbmRpYW4KICAgIHN0YXRlLnN0YXJ0ICs9IDQKICAgIHJldHVybiBmbG9hdAogIH0KfQoKZXhwb3J0cy5mbG9hdDY0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kICs9IDgKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldygKICAgICAgc3RhdGUuYnVmZmVyLmJ1ZmZlciwKICAgICAgc3RhdGUuc3RhcnQgKyBzdGF0ZS5idWZmZXIuYnl0ZU9mZnNldCwKICAgICAgOAogICAgKQogICAgdmlldy5zZXRGbG9hdDY0KDAsIG4sIHRydWUpIC8vIGxpdHRsZSBlbmRpYW4KICAgIHN0YXRlLnN0YXJ0ICs9IDgKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgOCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoCiAgICAgIHN0YXRlLmJ1ZmZlci5idWZmZXIsCiAgICAgIHN0YXRlLnN0YXJ0ICsgc3RhdGUuYnVmZmVyLmJ5dGVPZmZzZXQsCiAgICAgIDgKICAgICkKICAgIGNvbnN0IGZsb2F0ID0gdmlldy5nZXRGbG9hdDY0KDAsIHRydWUpIC8vIGxpdHRsZSBlbmRpYW4KICAgIHN0YXRlLnN0YXJ0ICs9IDgKICAgIHJldHVybiBmbG9hdAogIH0KfQoKY29uc3QgYnVmZmVyID0gKGV4cG9ydHMuYnVmZmVyID0gewogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgaWYgKGIpIHVpbnQ4YXJyYXkucHJlZW5jb2RlKHN0YXRlLCBiKQogICAgZWxzZSBzdGF0ZS5lbmQrKwogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBpZiAoYikgdWludDhhcnJheS5lbmNvZGUoc3RhdGUsIGIpCiAgICBlbHNlIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDAKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgbGVuID0gdWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAobGVuID09PSAwKSByZXR1cm4gbnVsbAogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgbGVuKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCwgKHN0YXRlLnN0YXJ0ICs9IGxlbikpCiAgfQp9KQoKZXhwb3J0cy5iaW5hcnkgPSB7CiAgLi4uYnVmZmVyLAogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgaWYgKHR5cGVvZiBiID09PSAnc3RyaW5nJykgdXRmOC5wcmVlbmNvZGUoc3RhdGUsIGIpCiAgICBlbHNlIGJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIGIpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGlmICh0eXBlb2YgYiA9PT0gJ3N0cmluZycpIHV0ZjguZW5jb2RlKHN0YXRlLCBiKQogICAgZWxzZSBidWZmZXIuZW5jb2RlKHN0YXRlLCBiKQogIH0KfQoKZXhwb3J0cy5hcnJheWJ1ZmZlciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIHVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLmJ5dGVMZW5ndGgpCiAgICBzdGF0ZS5lbmQgKz0gYi5ieXRlTGVuZ3RoCiAgfSwKICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgIHVpbnQuZW5jb2RlKHN0YXRlLCBiLmJ5dGVMZW5ndGgpCgogICAgY29uc3QgdmlldyA9IG5ldyBVaW50OEFycmF5KGIpCgogICAgc3RhdGUuYnVmZmVyLnNldCh2aWV3LCBzdGF0ZS5zdGFydCkKICAgIHN0YXRlLnN0YXJ0ICs9IGIuYnl0ZUxlbmd0aAogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBsZW4gPSB1aW50LmRlY29kZShzdGF0ZSkKCiAgICBjb25zdCBiID0gbmV3IEFycmF5QnVmZmVyKGxlbikKICAgIGNvbnN0IHZpZXcgPSBuZXcgVWludDhBcnJheShiKQoKICAgIHZpZXcuc2V0KHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCwgKHN0YXRlLnN0YXJ0ICs9IGxlbikpKQoKICAgIHJldHVybiBiCiAgfQp9CgpmdW5jdGlvbiB0eXBlZGFycmF5KFR5cGVkQXJyYXksIHN3YXApIHsKICBjb25zdCBuID0gVHlwZWRBcnJheS5CWVRFU19QRVJfRUxFTUVOVAoKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICAgIHVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLmxlbmd0aCkKICAgICAgc3RhdGUuZW5kICs9IGIuYnl0ZUxlbmd0aAogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgYikgewogICAgICB1aW50LmVuY29kZShzdGF0ZSwgYi5sZW5ndGgpCgogICAgICBjb25zdCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYi5idWZmZXIsIGIuYnl0ZU9mZnNldCwgYi5ieXRlTGVuZ3RoKQoKICAgICAgaWYgKEJFICYmIHN3YXApIHN3YXAodmlldykKCiAgICAgIHN0YXRlLmJ1ZmZlci5zZXQodmlldywgc3RhdGUuc3RhcnQpCiAgICAgIHN0YXRlLnN0YXJ0ICs9IGIuYnl0ZUxlbmd0aAogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICBjb25zdCBsZW4gPSB1aW50LmRlY29kZShzdGF0ZSkKCiAgICAgIGxldCBiID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0LCAoc3RhdGUuc3RhcnQgKz0gbGVuICogbikpCiAgICAgIGlmIChiLmJ5dGVMZW5ndGggIT09IGxlbiAqIG4pIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICAgIGlmIChiLmJ5dGVPZmZzZXQgJSBuICE9PSAwKSBiID0gbmV3IFVpbnQ4QXJyYXkoYikKCiAgICAgIGlmIChCRSAmJiBzd2FwKSBzd2FwKGIpCgogICAgICByZXR1cm4gbmV3IFR5cGVkQXJyYXkoYi5idWZmZXIsIGIuYnl0ZU9mZnNldCwgYi5ieXRlTGVuZ3RoIC8gbikKICAgIH0KICB9Cn0KCmNvbnN0IHVpbnQ4YXJyYXkgPSAoZXhwb3J0cy51aW50OGFycmF5ID0gdHlwZWRhcnJheShVaW50OEFycmF5KSkKZXhwb3J0cy51aW50MTZhcnJheSA9IHR5cGVkYXJyYXkoVWludDE2QXJyYXksIGI0YS5zd2FwMTYpCmV4cG9ydHMudWludDMyYXJyYXkgPSB0eXBlZGFycmF5KFVpbnQzMkFycmF5LCBiNGEuc3dhcDMyKQoKZXhwb3J0cy5pbnQ4YXJyYXkgPSB0eXBlZGFycmF5KEludDhBcnJheSkKZXhwb3J0cy5pbnQxNmFycmF5ID0gdHlwZWRhcnJheShJbnQxNkFycmF5LCBiNGEuc3dhcDE2KQpleHBvcnRzLmludDMyYXJyYXkgPSB0eXBlZGFycmF5KEludDMyQXJyYXksIGI0YS5zd2FwMzIpCgpleHBvcnRzLmJpZ3VpbnQ2NGFycmF5ID0gdHlwZWRhcnJheShCaWdVaW50NjRBcnJheSwgYjRhLnN3YXA2NCkKZXhwb3J0cy5iaWdpbnQ2NGFycmF5ID0gdHlwZWRhcnJheShCaWdJbnQ2NEFycmF5LCBiNGEuc3dhcDY0KQoKZXhwb3J0cy5mbG9hdDMyYXJyYXkgPSB0eXBlZGFycmF5KEZsb2F0MzJBcnJheSwgYjRhLnN3YXAzMikKZXhwb3J0cy5mbG9hdDY0YXJyYXkgPSB0eXBlZGFycmF5KEZsb2F0NjRBcnJheSwgYjRhLnN3YXA2NCkKCmZ1bmN0aW9uIHN0cmluZyhlbmNvZGluZykgewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIHMpIHsKICAgICAgY29uc3QgbGVuID0gYjRhLmJ5dGVMZW5ndGgocywgZW5jb2RpbmcpCiAgICAgIHVpbnQucHJlZW5jb2RlKHN0YXRlLCBsZW4pCiAgICAgIHN0YXRlLmVuZCArPSBsZW4KICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIHMpIHsKICAgICAgY29uc3QgbGVuID0gYjRhLmJ5dGVMZW5ndGgocywgZW5jb2RpbmcpCiAgICAgIHVpbnQuZW5jb2RlKHN0YXRlLCBsZW4pCiAgICAgIGI0YS53cml0ZShzdGF0ZS5idWZmZXIsIHMsIHN0YXRlLnN0YXJ0LCBlbmNvZGluZykKICAgICAgc3RhdGUuc3RhcnQgKz0gbGVuCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIGNvbnN0IGxlbiA9IHVpbnQuZGVjb2RlKHN0YXRlKQogICAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCBsZW4pIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICAgIHJldHVybiBiNGEudG9TdHJpbmcoCiAgICAgICAgc3RhdGUuYnVmZmVyLAogICAgICAgIGVuY29kaW5nLAogICAgICAgIHN0YXRlLnN0YXJ0LAogICAgICAgIChzdGF0ZS5zdGFydCArPSBsZW4pCiAgICAgICkKICAgIH0sCiAgICBmaXhlZChuKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcHJlZW5jb2RlKHN0YXRlKSB7CiAgICAgICAgICBzdGF0ZS5lbmQgKz0gbgogICAgICAgIH0sCiAgICAgICAgZW5jb2RlKHN0YXRlLCBzKSB7CiAgICAgICAgICBiNGEud3JpdGUoc3RhdGUuYnVmZmVyLCBzLCBzdGF0ZS5zdGFydCwgbiwgZW5jb2RpbmcpCiAgICAgICAgICBzdGF0ZS5zdGFydCArPSBuCiAgICAgICAgfSwKICAgICAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IG4pIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICAgICAgICByZXR1cm4gYjRhLnRvU3RyaW5nKAogICAgICAgICAgICBzdGF0ZS5idWZmZXIsCiAgICAgICAgICAgIGVuY29kaW5nLAogICAgICAgICAgICBzdGF0ZS5zdGFydCwKICAgICAgICAgICAgKHN0YXRlLnN0YXJ0ICs9IG4pCiAgICAgICAgICApCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQp9Cgpjb25zdCB1dGY4ID0gKGV4cG9ydHMuc3RyaW5nID0gZXhwb3J0cy51dGY4ID0gc3RyaW5nKCd1dGYtOCcpKQpleHBvcnRzLmFzY2lpID0gc3RyaW5nKCdhc2NpaScpCmV4cG9ydHMuaGV4ID0gc3RyaW5nKCdoZXgnKQpleHBvcnRzLmJhc2U2NCA9IHN0cmluZygnYmFzZTY0JykKZXhwb3J0cy51Y3MyID0gZXhwb3J0cy51dGYxNmxlID0gc3RyaW5nKCd1dGYxNmxlJykKCmV4cG9ydHMuYm9vbCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIHN0YXRlLmVuZCsrCiAgfSwKICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IGIgPyAxIDogMAogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuc3RhcnQgPj0gc3RhdGUuZW5kKSB0aHJvdyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID09PSAxCiAgfQp9Cgpjb25zdCBmaXhlZCA9IChleHBvcnRzLmZpeGVkID0gZnVuY3Rpb24gZml4ZWQobikgewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIHMpIHsKICAgICAgaWYgKHMuYnl0ZUxlbmd0aCAhPT0gbikgdGhyb3cgbmV3IEVycm9yKCdJbmNvcnJlY3QgYnVmZmVyIHNpemUnKQogICAgICBzdGF0ZS5lbmQgKz0gbgogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgcykgewogICAgICBzdGF0ZS5idWZmZXIuc2V0KHMsIHN0YXRlLnN0YXJ0KQogICAgICBzdGF0ZS5zdGFydCArPSBuCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IG4pIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICAgIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIChzdGF0ZS5zdGFydCArPSBuKSkKICAgIH0KICB9Cn0pCgpleHBvcnRzLmZpeGVkMzIgPSBmaXhlZCgzMikKZXhwb3J0cy5maXhlZDY0ID0gZml4ZWQoNjQpCgpleHBvcnRzLmFycmF5ID0gZnVuY3Rpb24gYXJyYXkoZW5jKSB7CiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgbGlzdCkgewogICAgICB1aW50LnByZWVuY29kZShzdGF0ZSwgbGlzdC5sZW5ndGgpCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgZW5jLnByZWVuY29kZShzdGF0ZSwgbGlzdFtpXSkKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIGxpc3QpIHsKICAgICAgdWludC5lbmNvZGUoc3RhdGUsIGxpc3QubGVuZ3RoKQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIGVuYy5lbmNvZGUoc3RhdGUsIGxpc3RbaV0pCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIGNvbnN0IGxlbiA9IHVpbnQuZGVjb2RlKHN0YXRlKQogICAgICBpZiAobGVuID4gMHgxMDAwMDApIHRocm93IG5ldyBFcnJvcignQXJyYXkgaXMgdG9vIGJpZycpCiAgICAgIGNvbnN0IGFyciA9IG5ldyBBcnJheShsZW4pCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIGFycltpXSA9IGVuYy5kZWNvZGUoc3RhdGUpCiAgICAgIHJldHVybiBhcnIKICAgIH0KICB9Cn0KCmV4cG9ydHMuZnJhbWUgPSBmdW5jdGlvbiBmcmFtZShlbmMpIHsKICBjb25zdCBkdW1teSA9IGV4cG9ydHMuc3RhdGUoKQoKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIGNvbnN0IGVuZCA9IHN0YXRlLmVuZAogICAgICBlbmMucHJlZW5jb2RlKHN0YXRlLCBtKQogICAgICB1aW50LnByZWVuY29kZShzdGF0ZSwgc3RhdGUuZW5kIC0gZW5kKQogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgbSkgewogICAgICBkdW1teS5lbmQgPSAwCiAgICAgIGVuYy5wcmVlbmNvZGUoZHVtbXksIG0pCiAgICAgIHVpbnQuZW5jb2RlKHN0YXRlLCBkdW1teS5lbmQpCiAgICAgIGVuYy5lbmNvZGUoc3RhdGUsIG0pCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIGNvbnN0IGVuZCA9IHN0YXRlLmVuZAogICAgICBjb25zdCBsZW4gPSB1aW50LmRlY29kZShzdGF0ZSkKICAgICAgc3RhdGUuZW5kID0gc3RhdGUuc3RhcnQgKyBsZW4KICAgICAgY29uc3QgbSA9IGVuYy5kZWNvZGUoc3RhdGUpCiAgICAgIHN0YXRlLnN0YXJ0ID0gc3RhdGUuZW5kCiAgICAgIHN0YXRlLmVuZCA9IGVuZAogICAgICByZXR1cm4gbQogICAgfQogIH0KfQoKZXhwb3J0cy5kYXRlID0gewogIHByZWVuY29kZShzdGF0ZSwgZCkgewogICAgaW50LnByZWVuY29kZShzdGF0ZSwgZC5nZXRUaW1lKCkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGQpIHsKICAgIGludC5lbmNvZGUoc3RhdGUsIGQuZ2V0VGltZSgpKQogIH0sCiAgZGVjb2RlKHN0YXRlLCBkKSB7CiAgICByZXR1cm4gbmV3IERhdGUoaW50LmRlY29kZShzdGF0ZSkpCiAgfQp9CgpleHBvcnRzLmpzb24gPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCB2KSB7CiAgICB1dGY4LnByZWVuY29kZShzdGF0ZSwgSlNPTi5zdHJpbmdpZnkodikpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHYpIHsKICAgIHV0ZjguZW5jb2RlKHN0YXRlLCBKU09OLnN0cmluZ2lmeSh2KSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIEpTT04ucGFyc2UodXRmOC5kZWNvZGUoc3RhdGUpKQogIH0KfQoKZXhwb3J0cy5uZGpzb24gPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCB2KSB7CiAgICB1dGY4LnByZWVuY29kZShzdGF0ZSwgSlNPTi5zdHJpbmdpZnkodikgKyAnXG4nKQogIH0sCiAgZW5jb2RlKHN0YXRlLCB2KSB7CiAgICB1dGY4LmVuY29kZShzdGF0ZSwgSlNPTi5zdHJpbmdpZnkodikgKyAnXG4nKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gSlNPTi5wYXJzZSh1dGY4LmRlY29kZShzdGF0ZSkpCiAgfQp9CgovLyBzaW1wbGUgaGVscGVyIGZvciB3aGVuIHlvdSB3YW50IHRvIGp1c3QgZXhwcmVzcyBub3RoaW5nCmV4cG9ydHMubm9uZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIC8vIGRvIG5vdGhpbmcKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgLy8gZG8gbm90aGluZwogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gbnVsbAogIH0KfQoKLy8gImFueSIgZW5jb2RlcnMgaGVyZSBmb3IgaGVscGluZyBqdXN0IHN0cnVjdHVyZSBhbnkgb2JqZWN0IHdpdGhvdXQgc2NoZW1hdGlzaW5nIGl0Cgpjb25zdCBhbnlBcnJheSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGFycikgewogICAgdWludC5wcmVlbmNvZGUoc3RhdGUsIGFyci5sZW5ndGgpCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgICBhbnkucHJlZW5jb2RlKHN0YXRlLCBhcnJbaV0pCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIGFycikgewogICAgdWludC5lbmNvZGUoc3RhdGUsIGFyci5sZW5ndGgpCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgICBhbnkuZW5jb2RlKHN0YXRlLCBhcnJbaV0pCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGFyciA9IFtdCiAgICBsZXQgbGVuID0gdWludC5kZWNvZGUoc3RhdGUpCiAgICB3aGlsZSAobGVuLS0gPiAwKSB7CiAgICAgIGFyci5wdXNoKGFueS5kZWNvZGUoc3RhdGUpKQogICAgfQogICAgcmV0dXJuIGFycgogIH0KfQoKY29uc3QgYW55T2JqZWN0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbykgewogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKG8pCiAgICB1aW50LnByZWVuY29kZShzdGF0ZSwga2V5cy5sZW5ndGgpCiAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7CiAgICAgIHV0ZjgucHJlZW5jb2RlKHN0YXRlLCBrZXkpCiAgICAgIGFueS5wcmVlbmNvZGUoc3RhdGUsIG9ba2V5XSkKICAgIH0KICB9LAogIGVuY29kZShzdGF0ZSwgbykgewogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKG8pCiAgICB1aW50LmVuY29kZShzdGF0ZSwga2V5cy5sZW5ndGgpCiAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7CiAgICAgIHV0ZjguZW5jb2RlKHN0YXRlLCBrZXkpCiAgICAgIGFueS5lbmNvZGUoc3RhdGUsIG9ba2V5XSkKICAgIH0KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgbGV0IGxlbiA9IHVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgbyA9IHt9CiAgICB3aGlsZSAobGVuLS0gPiAwKSB7CiAgICAgIGNvbnN0IGtleSA9IHV0ZjguZGVjb2RlKHN0YXRlKQogICAgICBvW2tleV0gPSBhbnkuZGVjb2RlKHN0YXRlKQogICAgfQogICAgcmV0dXJuIG8KICB9Cn0KCmNvbnN0IGFueVR5cGVzID0gWwogIGV4cG9ydHMubm9uZSwKICBleHBvcnRzLmJvb2wsCiAgZXhwb3J0cy5zdHJpbmcsCiAgZXhwb3J0cy5idWZmZXIsCiAgZXhwb3J0cy51aW50LAogIGV4cG9ydHMuaW50LAogIGV4cG9ydHMuZmxvYXQ2NCwKICBhbnlBcnJheSwKICBhbnlPYmplY3QsCiAgZXhwb3J0cy5kYXRlCl0KCmNvbnN0IGFueSA9IChleHBvcnRzLmFueSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG8pIHsKICAgIGNvbnN0IHQgPSBnZXRUeXBlKG8pCiAgICB1aW50LnByZWVuY29kZShzdGF0ZSwgdCkKICAgIGFueVR5cGVzW3RdLnByZWVuY29kZShzdGF0ZSwgbykKICB9LAogIGVuY29kZShzdGF0ZSwgbykgewogICAgY29uc3QgdCA9IGdldFR5cGUobykKICAgIHVpbnQuZW5jb2RlKHN0YXRlLCB0KQogICAgYW55VHlwZXNbdF0uZW5jb2RlKHN0YXRlLCBvKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB0ID0gdWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAodCA+PSBhbnlUeXBlcy5sZW5ndGgpIHRocm93IG5ldyBFcnJvcignVW5rbm93biB0eXBlOiAnICsgdCkKICAgIHJldHVybiBhbnlUeXBlc1t0XS5kZWNvZGUoc3RhdGUpCiAgfQp9KQoKY29uc3QgcG9ydCA9IChleHBvcnRzLnBvcnQgPSB1aW50MTYpCgpjb25zdCBhZGRyZXNzID0gKGhvc3QsIGZhbWlseSkgPT4gewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgaG9zdC5wcmVlbmNvZGUoc3RhdGUsIG0uaG9zdCkKICAgICAgcG9ydC5wcmVlbmNvZGUoc3RhdGUsIG0ucG9ydCkKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgaG9zdC5lbmNvZGUoc3RhdGUsIG0uaG9zdCkKICAgICAgcG9ydC5lbmNvZGUoc3RhdGUsIG0ucG9ydCkKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBob3N0OiBob3N0LmRlY29kZShzdGF0ZSksCiAgICAgICAgZmFtaWx5LAogICAgICAgIHBvcnQ6IHBvcnQuZGVjb2RlKHN0YXRlKQogICAgICB9CiAgICB9CiAgfQp9Cgpjb25zdCBpcHY0ID0gKGV4cG9ydHMuaXB2NCA9IHsKICBwcmVlbmNvZGUoc3RhdGUpIHsKICAgIHN0YXRlLmVuZCArPSA0CiAgfSwKICBlbmNvZGUoc3RhdGUsIHN0cmluZykgewogICAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogICAgY29uc3QgZW5kID0gc3RhcnQgKyA0CgogICAgbGV0IGkgPSAwCgogICAgd2hpbGUgKGkgPCBzdHJpbmcubGVuZ3RoKSB7CiAgICAgIGxldCBuID0gMAogICAgICBsZXQgYwoKICAgICAgd2hpbGUgKAogICAgICAgIGkgPCBzdHJpbmcubGVuZ3RoICYmCiAgICAgICAgKGMgPSBzdHJpbmcuY2hhckNvZGVBdChpKyspKSAhPT0gLyogLiAqLyAweDJlCiAgICAgICkgewogICAgICAgIG4gPSBuICogMTAgKyAoYyAtIC8qIDAgKi8gMHgzMCkKICAgICAgfQoKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgogICAgfQoKICAgIHN0YXRlLnN0YXJ0ID0gZW5kCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDQpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gKAogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKwogICAgICAnLicgKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKwogICAgICAnLicgKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKwogICAgICAnLicgKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICkKICB9Cn0pCgpleHBvcnRzLmlwdjRBZGRyZXNzID0gYWRkcmVzcyhpcHY0LCA0KQoKY29uc3QgaXB2NiA9IChleHBvcnRzLmlwdjYgPSB7CiAgcHJlZW5jb2RlKHN0YXRlKSB7CiAgICBzdGF0ZS5lbmQgKz0gMTYKICB9LAogIGVuY29kZShzdGF0ZSwgc3RyaW5nKSB7CiAgICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgICBjb25zdCBlbmQgPSBzdGFydCArIDE2CgogICAgbGV0IGkgPSAwCiAgICBsZXQgc3BsaXQgPSBudWxsCgogICAgd2hpbGUgKGkgPCBzdHJpbmcubGVuZ3RoKSB7CiAgICAgIGxldCBuID0gMAogICAgICBsZXQgYwoKICAgICAgd2hpbGUgKAogICAgICAgIGkgPCBzdHJpbmcubGVuZ3RoICYmCiAgICAgICAgKGMgPSBzdHJpbmcuY2hhckNvZGVBdChpKyspKSAhPT0gLyogOiAqLyAweDNhCiAgICAgICkgewogICAgICAgIGlmIChjID49IDB4MzAgJiYgYyA8PSAweDM5KSBuID0gbiAqIDB4MTAgKyAoYyAtIC8qIDAgKi8gMHgzMCkKICAgICAgICBlbHNlIGlmIChjID49IDB4NDEgJiYgYyA8PSAweDQ2KSBuID0gbiAqIDB4MTAgKyAoYyAtIC8qIEEgKi8gMHg0MSArIDEwKQogICAgICAgIGVsc2UgaWYgKGMgPj0gMHg2MSAmJiBjIDw9IDB4NjYpIG4gPSBuICogMHgxMCArIChjIC0gLyogYSAqLyAweDYxICsgMTApCiAgICAgIH0KCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDgKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgoKICAgICAgaWYgKGkgPCBzdHJpbmcubGVuZ3RoICYmIHN0cmluZy5jaGFyQ29kZUF0KGkpID09PSAvKiA6ICovIDB4M2EpIHsKICAgICAgICBpKysKICAgICAgICBzcGxpdCA9IHN0YXRlLnN0YXJ0CiAgICAgIH0KICAgIH0KCiAgICBpZiAoc3BsaXQgIT09IG51bGwpIHsKICAgICAgY29uc3Qgb2Zmc2V0ID0gZW5kIC0gc3RhdGUuc3RhcnQKICAgICAgc3RhdGUuYnVmZmVyCiAgICAgICAgLmNvcHlXaXRoaW4oc3BsaXQgKyBvZmZzZXQsIHNwbGl0KQogICAgICAgIC5maWxsKDAsIHNwbGl0LCBzcGxpdCArIG9mZnNldCkKICAgIH0KCiAgICBzdGF0ZS5zdGFydCA9IGVuZAogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCAxNikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiAoCiAgICAgICgKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKwogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogICAgICApLnRvU3RyaW5nKDE2KSArCiAgICAgICc6JyArCiAgICAgICgKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKwogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogICAgICApLnRvU3RyaW5nKDE2KSArCiAgICAgICc6JyArCiAgICAgICgKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKwogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogICAgICApLnRvU3RyaW5nKDE2KSArCiAgICAgICc6JyArCiAgICAgICgKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKwogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogICAgICApLnRvU3RyaW5nKDE2KSArCiAgICAgICc6JyArCiAgICAgICgKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKwogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogICAgICApLnRvU3RyaW5nKDE2KSArCiAgICAgICc6JyArCiAgICAgICgKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKwogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogICAgICApLnRvU3RyaW5nKDE2KSArCiAgICAgICc6JyArCiAgICAgICgKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKwogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogICAgICApLnRvU3RyaW5nKDE2KSArCiAgICAgICc6JyArCiAgICAgICgKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAyNTYgKwogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogICAgICApLnRvU3RyaW5nKDE2KQogICAgKQogIH0KfSkKCmV4cG9ydHMuaXB2NkFkZHJlc3MgPSBhZGRyZXNzKGlwdjYsIDYpCgpjb25zdCBpcCA9IChleHBvcnRzLmlwID0gewogIHByZWVuY29kZShzdGF0ZSwgc3RyaW5nKSB7CiAgICBjb25zdCBmYW1pbHkgPSBzdHJpbmcuaW5jbHVkZXMoJzonKSA/IDYgOiA0CiAgICB1aW50OC5wcmVlbmNvZGUoc3RhdGUsIGZhbWlseSkKICAgIGlmIChmYW1pbHkgPT09IDQpIGlwdjQucHJlZW5jb2RlKHN0YXRlKQogICAgZWxzZSBpcHY2LnByZWVuY29kZShzdGF0ZSkKICB9LAogIGVuY29kZShzdGF0ZSwgc3RyaW5nKSB7CiAgICBjb25zdCBmYW1pbHkgPSBzdHJpbmcuaW5jbHVkZXMoJzonKSA/IDYgOiA0CiAgICB1aW50OC5lbmNvZGUoc3RhdGUsIGZhbWlseSkKICAgIGlmIChmYW1pbHkgPT09IDQpIGlwdjQuZW5jb2RlKHN0YXRlLCBzdHJpbmcpCiAgICBlbHNlIGlwdjYuZW5jb2RlKHN0YXRlLCBzdHJpbmcpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZhbWlseSA9IHVpbnQ4LmRlY29kZShzdGF0ZSkKICAgIGlmIChmYW1pbHkgPT09IDQpIHJldHVybiBpcHY0LmRlY29kZShzdGF0ZSkKICAgIGVsc2UgcmV0dXJuIGlwdjYuZGVjb2RlKHN0YXRlKQogIH0KfSkKCmV4cG9ydHMuaXBBZGRyZXNzID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgaXAucHJlZW5jb2RlKHN0YXRlLCBtLmhvc3QpCiAgICBwb3J0LnByZWVuY29kZShzdGF0ZSwgbS5wb3J0KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBpcC5lbmNvZGUoc3RhdGUsIG0uaG9zdCkKICAgIHBvcnQuZW5jb2RlKHN0YXRlLCBtLnBvcnQpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZhbWlseSA9IHVpbnQ4LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIGhvc3Q6IGZhbWlseSA9PT0gNCA/IGlwdjQuZGVjb2RlKHN0YXRlKSA6IGlwdjYuZGVjb2RlKHN0YXRlKSwKICAgICAgZmFtaWx5LAogICAgICBwb3J0OiBwb3J0LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGdldFR5cGUobykgewogIGlmIChvID09PSBudWxsIHx8IG8gPT09IHVuZGVmaW5lZCkgcmV0dXJuIDAKICBpZiAodHlwZW9mIG8gPT09ICdib29sZWFuJykgcmV0dXJuIDEKICBpZiAodHlwZW9mIG8gPT09ICdzdHJpbmcnKSByZXR1cm4gMgogIGlmIChiNGEuaXNCdWZmZXIobykpIHJldHVybiAzCiAgaWYgKHR5cGVvZiBvID09PSAnbnVtYmVyJykgewogICAgaWYgKE51bWJlci5pc0ludGVnZXIobykpIHJldHVybiBvID49IDAgPyA0IDogNQogICAgcmV0dXJuIDYKICB9CiAgaWYgKEFycmF5LmlzQXJyYXkobykpIHJldHVybiA3CiAgaWYgKG8gaW5zdGFuY2VvZiBEYXRlKSByZXR1cm4gOQogIGlmICh0eXBlb2YgbyA9PT0gJ29iamVjdCcpIHJldHVybiA4CgogIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdHlwZSBmb3IgJyArIG8pCn0KCmV4cG9ydHMuZnJvbSA9IGZ1bmN0aW9uIGZyb20oZW5jKSB7CiAgaWYgKHR5cGVvZiBlbmMgPT09ICdzdHJpbmcnKSByZXR1cm4gZnJvbU5hbWVkKGVuYykKICBpZiAoZW5jLnByZWVuY29kZSkgcmV0dXJuIGVuYwogIGlmIChlbmMuZW5jb2RpbmdMZW5ndGgpIHJldHVybiBmcm9tQWJzdHJhY3RFbmNvZGVyKGVuYykKICByZXR1cm4gZnJvbUNvZGVjKGVuYykKfQoKZnVuY3Rpb24gZnJvbU5hbWVkKGVuYykgewogIHN3aXRjaCAoZW5jKSB7CiAgICBjYXNlICdhc2NpaSc6CiAgICAgIHJldHVybiByYXcuYXNjaWkKICAgIGNhc2UgJ3V0Zi04JzoKICAgIGNhc2UgJ3V0ZjgnOgogICAgICByZXR1cm4gcmF3LnV0ZjgKICAgIGNhc2UgJ2hleCc6CiAgICAgIHJldHVybiByYXcuaGV4CiAgICBjYXNlICdiYXNlNjQnOgogICAgICByZXR1cm4gcmF3LmJhc2U2NAogICAgY2FzZSAndXRmMTYtbGUnOgogICAgY2FzZSAndXRmMTZsZSc6CiAgICBjYXNlICd1Y3MtMic6CiAgICBjYXNlICd1Y3MyJzoKICAgICAgcmV0dXJuIHJhdy51Y3MyCiAgICBjYXNlICduZGpzb24nOgogICAgICByZXR1cm4gcmF3Lm5kanNvbgogICAgY2FzZSAnanNvbic6CiAgICAgIHJldHVybiByYXcuanNvbgogICAgY2FzZSAnYmluYXJ5JzoKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiByYXcuYmluYXJ5CiAgfQp9CgpmdW5jdGlvbiBmcm9tQ29kZWMoZW5jKSB7CiAgbGV0IHRtcE0gPSBudWxsCiAgbGV0IHRtcEJ1ZiA9IG51bGwKCiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgICB0bXBNID0gbQogICAgICB0bXBCdWYgPSBlbmMuZW5jb2RlKG0pCiAgICAgIHN0YXRlLmVuZCArPSB0bXBCdWYuYnl0ZUxlbmd0aAogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgbSkgewogICAgICByYXcuZW5jb2RlKHN0YXRlLCBtID09PSB0bXBNID8gdG1wQnVmIDogZW5jLmVuY29kZShtKSkKICAgICAgdG1wTSA9IHRtcEJ1ZiA9IG51bGwKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgcmV0dXJuIGVuYy5kZWNvZGUocmF3LmRlY29kZShzdGF0ZSkpCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBmcm9tQWJzdHJhY3RFbmNvZGVyKGVuYykgewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgc3RhdGUuZW5kICs9IGVuYy5lbmNvZGluZ0xlbmd0aChtKQogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgbSkgewogICAgICBlbmMuZW5jb2RlKG0sIHN0YXRlLmJ1ZmZlciwgc3RhdGUuc3RhcnQpCiAgICAgIHN0YXRlLnN0YXJ0ICs9IGVuYy5lbmNvZGUuYnl0ZXMKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgY29uc3QgbSA9IGVuYy5kZWNvZGUoc3RhdGUuYnVmZmVyLCBzdGF0ZS5zdGFydCwgc3RhdGUuZW5kKQogICAgICBzdGF0ZS5zdGFydCArPSBlbmMuZGVjb2RlLmJ5dGVzCiAgICAgIHJldHVybiBtCiAgICB9CiAgfQp9CgpleHBvcnRzLmVuY29kZSA9IGZ1bmN0aW9uIGVuY29kZShlbmMsIG0pIHsKICBjb25zdCBzdGF0ZSA9IGV4cG9ydHMuc3RhdGUoKQogIGVuYy5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHN0YXRlLmVuZCkKICBlbmMuZW5jb2RlKHN0YXRlLCBtKQogIHJldHVybiBzdGF0ZS5idWZmZXIKfQoKZXhwb3J0cy5kZWNvZGUgPSBmdW5jdGlvbiBkZWNvZGUoZW5jLCBidWZmZXIpIHsKICByZXR1cm4gZW5jLmRlY29kZShleHBvcnRzLnN0YXRlKDAsIGJ1ZmZlci5ieXRlTGVuZ3RoLCBidWZmZXIpKQp9CgpmdW5jdGlvbiB6aWdaYWdJbnQoZW5jKSB7CiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgICBlbmMucHJlZW5jb2RlKHN0YXRlLCB6aWdaYWdFbmNvZGVJbnQobikpCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICAgIGVuYy5lbmNvZGUoc3RhdGUsIHppZ1phZ0VuY29kZUludChuKSkKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgcmV0dXJuIHppZ1phZ0RlY29kZUludChlbmMuZGVjb2RlKHN0YXRlKSkKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHppZ1phZ0RlY29kZUludChuKSB7CiAgcmV0dXJuIG4gPT09IDAgPyBuIDogKG4gJiAxKSA9PT0gMCA/IG4gLyAyIDogLShuICsgMSkgLyAyCn0KCmZ1bmN0aW9uIHppZ1phZ0VuY29kZUludChuKSB7CiAgLy8gMCwgLTEsIDEsIC0yLCAyLCAuLi4KICByZXR1cm4gbiA8IDAgPyAyICogLW4gLSAxIDogbiA9PT0gMCA/IDAgOiAyICogbgp9CgpmdW5jdGlvbiB6aWdaYWdCaWdJbnQoZW5jKSB7CiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgICBlbmMucHJlZW5jb2RlKHN0YXRlLCB6aWdaYWdFbmNvZGVCaWdJbnQobikpCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICAgIGVuYy5lbmNvZGUoc3RhdGUsIHppZ1phZ0VuY29kZUJpZ0ludChuKSkKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgcmV0dXJuIHppZ1phZ0RlY29kZUJpZ0ludChlbmMuZGVjb2RlKHN0YXRlKSkKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHppZ1phZ0RlY29kZUJpZ0ludChuKSB7CiAgcmV0dXJuIG4gPT09IDBuID8gbiA6IChuICYgMW4pID09PSAwbiA/IG4gLyAybiA6IC0obiArIDFuKSAvIDJuCn0KCmZ1bmN0aW9uIHppZ1phZ0VuY29kZUJpZ0ludChuKSB7CiAgLy8gMCwgLTEsIDEsIC0yLCAyLCAuLi4KICByZXR1cm4gbiA8IDBuID8gMm4gKiAtbiAtIDFuIDogbiA9PT0gMG4gPyAwbiA6IDJuICogbgp9CgpmdW5jdGlvbiB2YWxpZGF0ZVVpbnQobikgewogIGlmIChuID49IDAgPT09IGZhbHNlIC8qIEhhbmRsZXMgTmFOIGFzIHdlbGwgKi8pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3VpbnQgbXVzdCBiZSBwb3NpdGl2ZScpCn0KbW9kdWxlLmV4cG9ydHMgPSB7CiAgcHJlZW5jb2RlLAogIGVuY29kZSwKICBkZWNvZGUKfQoKZnVuY3Rpb24gcHJlZW5jb2RlKHN0YXRlLCBudW0pIHsKICBpZiAobnVtIDwgMjUxKSB7CiAgICBzdGF0ZS5lbmQrKwogIH0gZWxzZSBpZiAobnVtIDwgMjU2KSB7CiAgICBzdGF0ZS5lbmQgKz0gMgogIH0gZWxzZSBpZiAobnVtIDwgMHgxMDAwMCkgewogICAgc3RhdGUuZW5kICs9IDMKICB9IGVsc2UgaWYgKG51bSA8IDB4MTAwMDAwMCkgewogICAgc3RhdGUuZW5kICs9IDQKICB9IGVsc2UgaWYgKG51bSA8IDB4MTAwMDAwMDAwKSB7CiAgICBzdGF0ZS5lbmQgKz0gNQogIH0gZWxzZSB7CiAgICBzdGF0ZS5lbmQrKwogICAgY29uc3QgZXhwID0gTWF0aC5mbG9vcihNYXRoLmxvZyhudW0pIC8gTWF0aC5sb2coMikpIC0gMzIKICAgIHByZWVuY29kZShzdGF0ZSwgZXhwKQogICAgc3RhdGUuZW5kICs9IDYKICB9Cn0KCmZ1bmN0aW9uIGVuY29kZShzdGF0ZSwgbnVtKSB7CiAgY29uc3QgbWF4ID0gMjUxCiAgY29uc3QgeCA9IG51bSAtIG1heAoKICBpZiAobnVtIDwgbWF4KSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBudW0KICB9IGVsc2UgaWYgKG51bSA8IDI1NikgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbWF4CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSB4CiAgfSBlbHNlIGlmIChudW0gPCAweDEwMDAwKSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBtYXggKyAxCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAoeCA+PiA4KSAmIDB4ZmYKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IHggJiAweGZmCiAgfSBlbHNlIGlmIChudW0gPCAweDEwMDAwMDApIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG1heCArIDIKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IHggPj4gMTYKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9ICh4ID4+IDgpICYgMHhmZgogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0geCAmIDB4ZmYKICB9IGVsc2UgaWYgKG51bSA8IDB4MTAwMDAwMDAwKSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBtYXggKyAzCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSB4ID4+IDI0CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAoeCA+PiAxNikgJiAweGZmCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAoeCA+PiA4KSAmIDB4ZmYKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IHggJiAweGZmCiAgfSBlbHNlIHsKICAgIC8vIG5lZWQgdG8gdXNlIE1hdGggaGVyZSBhcyBiaXR3aXNlIG9wcyBhcmUgMzIgYml0CiAgICBjb25zdCBleHAgPSBNYXRoLmZsb29yKE1hdGgubG9nKHgpIC8gTWF0aC5sb2coMikpIC0gMzIKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4ZmYKCiAgICBlbmNvZGUoc3RhdGUsIGV4cCkKICAgIGNvbnN0IHJlbSA9IHggLyBNYXRoLnBvdygyLCBleHAgLSAxMSkKCiAgICBmb3IgKGxldCBpID0gNTsgaSA+PSAwOyBpLS0pIHsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gKHJlbSAvIE1hdGgucG93KDIsIDggKiBpKSkgJiAweGZmCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBkZWNvZGUoc3RhdGUpIHsKICBjb25zdCBtYXggPSAyNTEKCiAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgMSkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKCiAgY29uc3QgZmxhZyA9IHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQoKICBpZiAoZmxhZyA8IG1heCkgcmV0dXJuIGZsYWcKCiAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgZmxhZyAtIG1heCArIDEpIHsKICAgIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcy4nKQogIH0KCiAgaWYgKGZsYWcgPCAyNTIpIHsKICAgIHJldHVybiBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKyBtYXgKICB9CgogIGlmIChmbGFnIDwgMjUzKSB7CiAgICByZXR1cm4gKAogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdIDw8IDgpICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsgbWF4CiAgICApCiAgfQoKICBpZiAoZmxhZyA8IDI1NCkgewogICAgcmV0dXJuICgKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA8PCAxNikgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdIDw8IDgpICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsKICAgICAgbWF4CiAgICApCiAgfQoKICAvLyA8PCAyNCByZXN1bHQgbWF5IGJlIGludGVycHJldGVkIGFzIG5lZ2F0aXZlCiAgaWYgKGZsYWcgPCAyNTUpIHsKICAgIHJldHVybiAoCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwMDAwMCArCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPDwgMTYpICsKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA8PCA4KSArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArCiAgICAgIG1heAogICAgKQogIH0KCiAgY29uc3QgZXhwID0gZGVjb2RlKHN0YXRlKQoKICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA2KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQoKICBsZXQgcmVtID0gMAogIGZvciAobGV0IGkgPSA1OyBpID49IDA7IGktLSkgewogICAgcmVtICs9IHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIE1hdGgucG93KDIsIDggKiBpKQogIH0KCiAgcmV0dXJuIHJlbSAqIE1hdGgucG93KDIsIGV4cCAtIDExKSArIG1heAp9CnsKICAibmFtZSI6ICJjb21wYWN0LWVuY29kaW5nIiwKICAidmVyc2lvbiI6ICIyLjE4LjAiLAogICJkZXNjcmlwdGlvbiI6ICJBIHNlcmllcyBvZiBjb21wYWN0IGVuY29kaW5nIHNjaGVtZXMgZm9yIGJ1aWxkaW5nIHNtYWxsIGFuZCBmYXN0IHBhcnNlcnMgYW5kIHNlcmlhbGl6ZXJzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuMy4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjAuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4xLjAuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAuIC0td3JpdGUiLAogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2NvbXBhY3QtZW5jb2RpbmcvY29tcGFjdC1lbmNvZGluZy5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vY29tcGFjdC1lbmNvZGluZy9jb21wYWN0LWVuY29kaW5nL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vY29tcGFjdC1lbmNvZGluZy9jb21wYWN0LWVuY29kaW5nIgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCB7IEJFIH0gPSByZXF1aXJlKCcuL2VuZGlhbicpCgpleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBzdGF0ZS5lbmQgKz0gYi5ieXRlTGVuZ3RoCiAgfSwKICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgIHN0YXRlLmJ1ZmZlci5zZXQoYiwgc3RhdGUuc3RhcnQpCiAgICBzdGF0ZS5zdGFydCArPSBiLmJ5dGVMZW5ndGgKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgYiA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCwgc3RhdGUuZW5kKQogICAgc3RhdGUuc3RhcnQgPSBzdGF0ZS5lbmQKICAgIHJldHVybiBiCiAgfQp9Cgpjb25zdCBidWZmZXIgPSAoZXhwb3J0cy5idWZmZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBpZiAoYikgdWludDhhcnJheS5wcmVlbmNvZGUoc3RhdGUsIGIpCiAgICBlbHNlIHN0YXRlLmVuZCsrCiAgfSwKICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGlmIChiKSB1aW50OGFycmF5LmVuY29kZShzdGF0ZSwgYikKICAgIGVsc2Ugc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMAogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBiID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0KQogICAgaWYgKGIuYnl0ZUxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGwKICAgIHN0YXRlLnN0YXJ0ID0gc3RhdGUuZW5kCiAgICByZXR1cm4gYgogIH0KfSkKCmV4cG9ydHMuYmluYXJ5ID0gewogIC4uLmJ1ZmZlciwKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGlmICh0eXBlb2YgYiA9PT0gJ3N0cmluZycpIHV0ZjgucHJlZW5jb2RlKHN0YXRlLCBiKQogICAgZWxzZSBidWZmZXIucHJlZW5jb2RlKHN0YXRlLCBiKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBpZiAodHlwZW9mIGIgPT09ICdzdHJpbmcnKSB1dGY4LmVuY29kZShzdGF0ZSwgYikKICAgIGVsc2UgYnVmZmVyLmVuY29kZShzdGF0ZSwgYikKICB9Cn0KCmV4cG9ydHMuYXJyYXlidWZmZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBzdGF0ZS5lbmQgKz0gYi5ieXRlTGVuZ3RoCiAgfSwKICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGNvbnN0IHZpZXcgPSBuZXcgVWludDhBcnJheShiKQoKICAgIHN0YXRlLmJ1ZmZlci5zZXQodmlldywgc3RhdGUuc3RhcnQpCiAgICBzdGF0ZS5zdGFydCArPSBiLmJ5dGVMZW5ndGgKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgYiA9IG5ldyBBcnJheUJ1ZmZlcihzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCkKICAgIGNvbnN0IHZpZXcgPSBuZXcgVWludDhBcnJheShiKQoKICAgIHZpZXcuc2V0KHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCkpCgogICAgc3RhdGUuc3RhcnQgPSBzdGF0ZS5lbmQKCiAgICByZXR1cm4gYgogIH0KfQoKZnVuY3Rpb24gdHlwZWRhcnJheShUeXBlZEFycmF5LCBzd2FwKSB7CiAgY29uc3QgbiA9IFR5cGVkQXJyYXkuQllURVNfUEVSX0VMRU1FTlQKCiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgICBzdGF0ZS5lbmQgKz0gYi5ieXRlTGVuZ3RoCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICAgIGNvbnN0IHZpZXcgPSBuZXcgVWludDhBcnJheShiLmJ1ZmZlciwgYi5ieXRlT2Zmc2V0LCBiLmJ5dGVMZW5ndGgpCgogICAgICBpZiAoQkUgJiYgc3dhcCkgc3dhcCh2aWV3KQoKICAgICAgc3RhdGUuYnVmZmVyLnNldCh2aWV3LCBzdGF0ZS5zdGFydCkKICAgICAgc3RhdGUuc3RhcnQgKz0gYi5ieXRlTGVuZ3RoCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIGxldCBiID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0KQogICAgICBpZiAoYi5ieXRlT2Zmc2V0ICUgbiAhPT0gMCkgYiA9IG5ldyBVaW50OEFycmF5KGIpCgogICAgICBpZiAoQkUgJiYgc3dhcCkgc3dhcChiKQoKICAgICAgc3RhdGUuc3RhcnQgPSBzdGF0ZS5lbmQKCiAgICAgIHJldHVybiBuZXcgVHlwZWRBcnJheShiLmJ1ZmZlciwgYi5ieXRlT2Zmc2V0LCBiLmJ5dGVMZW5ndGggLyBuKQogICAgfQogIH0KfQoKY29uc3QgdWludDhhcnJheSA9IChleHBvcnRzLnVpbnQ4YXJyYXkgPSB0eXBlZGFycmF5KFVpbnQ4QXJyYXkpKQpleHBvcnRzLnVpbnQxNmFycmF5ID0gdHlwZWRhcnJheShVaW50MTZBcnJheSwgYjRhLnN3YXAxNikKZXhwb3J0cy51aW50MzJhcnJheSA9IHR5cGVkYXJyYXkoVWludDMyQXJyYXksIGI0YS5zd2FwMzIpCgpleHBvcnRzLmludDhhcnJheSA9IHR5cGVkYXJyYXkoSW50OEFycmF5KQpleHBvcnRzLmludDE2YXJyYXkgPSB0eXBlZGFycmF5KEludDE2QXJyYXksIGI0YS5zd2FwMTYpCmV4cG9ydHMuaW50MzJhcnJheSA9IHR5cGVkYXJyYXkoSW50MzJBcnJheSwgYjRhLnN3YXAzMikKCmV4cG9ydHMuYmlndWludDY0YXJyYXkgPSB0eXBlZGFycmF5KEJpZ1VpbnQ2NEFycmF5LCBiNGEuc3dhcDY0KQpleHBvcnRzLmJpZ2ludDY0YXJyYXkgPSB0eXBlZGFycmF5KEJpZ0ludDY0QXJyYXksIGI0YS5zd2FwNjQpCgpleHBvcnRzLmZsb2F0MzJhcnJheSA9IHR5cGVkYXJyYXkoRmxvYXQzMkFycmF5LCBiNGEuc3dhcDMyKQpleHBvcnRzLmZsb2F0NjRhcnJheSA9IHR5cGVkYXJyYXkoRmxvYXQ2NEFycmF5LCBiNGEuc3dhcDY0KQoKZnVuY3Rpb24gc3RyaW5nKGVuY29kaW5nKSB7CiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgcykgewogICAgICBzdGF0ZS5lbmQgKz0gYjRhLmJ5dGVMZW5ndGgocywgZW5jb2RpbmcpCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBzKSB7CiAgICAgIHN0YXRlLnN0YXJ0ICs9IGI0YS53cml0ZShzdGF0ZS5idWZmZXIsIHMsIHN0YXRlLnN0YXJ0LCBlbmNvZGluZykKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgY29uc3QgcyA9IGI0YS50b1N0cmluZyhzdGF0ZS5idWZmZXIsIGVuY29kaW5nLCBzdGF0ZS5zdGFydCkKICAgICAgc3RhdGUuc3RhcnQgPSBzdGF0ZS5lbmQKICAgICAgcmV0dXJuIHMKICAgIH0KICB9Cn0KCmNvbnN0IHV0ZjggPSAoZXhwb3J0cy5zdHJpbmcgPSBleHBvcnRzLnV0ZjggPSBzdHJpbmcoJ3V0Zi04JykpCmV4cG9ydHMuYXNjaWkgPSBzdHJpbmcoJ2FzY2lpJykKZXhwb3J0cy5oZXggPSBzdHJpbmcoJ2hleCcpCmV4cG9ydHMuYmFzZTY0ID0gc3RyaW5nKCdiYXNlNjQnKQpleHBvcnRzLnVjczIgPSBleHBvcnRzLnV0ZjE2bGUgPSBzdHJpbmcoJ3V0ZjE2bGUnKQoKZXhwb3J0cy5hcnJheSA9IGZ1bmN0aW9uIGFycmF5KGVuYykgewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIGxpc3QpIHsKICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiBsaXN0KSBlbmMucHJlZW5jb2RlKHN0YXRlLCB2YWx1ZSkKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIGxpc3QpIHsKICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiBsaXN0KSBlbmMuZW5jb2RlKHN0YXRlLCB2YWx1ZSkKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgY29uc3QgYXJyID0gW10KICAgICAgd2hpbGUgKHN0YXRlLnN0YXJ0IDwgc3RhdGUuZW5kKSBhcnIucHVzaChlbmMuZGVjb2RlKHN0YXRlKSkKICAgICAgcmV0dXJuIGFycgogICAgfQogIH0KfQoKZXhwb3J0cy5qc29uID0gewogIHByZWVuY29kZShzdGF0ZSwgdikgewogICAgdXRmOC5wcmVlbmNvZGUoc3RhdGUsIEpTT04uc3RyaW5naWZ5KHYpKQogIH0sCiAgZW5jb2RlKHN0YXRlLCB2KSB7CiAgICB1dGY4LmVuY29kZShzdGF0ZSwgSlNPTi5zdHJpbmdpZnkodikpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiBKU09OLnBhcnNlKHV0ZjguZGVjb2RlKHN0YXRlKSkKICB9Cn0KCmV4cG9ydHMubmRqc29uID0gewogIHByZWVuY29kZShzdGF0ZSwgdikgewogICAgdXRmOC5wcmVlbmNvZGUoc3RhdGUsIEpTT04uc3RyaW5naWZ5KHYpICsgJ1xuJykKICB9LAogIGVuY29kZShzdGF0ZSwgdikgewogICAgdXRmOC5lbmNvZGUoc3RhdGUsIEpTT04uc3RyaW5naWZ5KHYpICsgJ1xuJykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIEpTT04ucGFyc2UodXRmOC5kZWNvZGUoc3RhdGUpKQogIH0KfQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENvcmVDb3VwbGVyIHsKICBjb25zdHJ1Y3RvciAodGFyZ2V0LCB3YWtldXApIHsKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0CiAgICB0aGlzLndha2V1cCA9IHdha2V1cAogICAgdGhpcy5jb3VwbGVkID0gbmV3IFNldCgpCgogICAgdGhpcy5fb25wZWVyYWRkQm91bmQgPSB0aGlzLl9vbnBlZXJhZGQuYmluZCh0aGlzKQogICAgdGhpcy50YXJnZXQub24oJ3BlZXItYWRkJywgdGhpcy5fb25wZWVyYWRkQm91bmQpCiAgfQoKICBhZGQgKGNvcmUpIHsKICAgIGNvbnN0IGFkZGVkID0gdGhpcy5jb3VwbGVkLnNpemUKICAgIHRoaXMuY291cGxlZC5hZGQoY29yZSkKICAgIGlmIChhZGRlZCAhPT0gdGhpcy5jb3VwbGVkLnNpemUpIHRoaXMuX2NvdXBsZShjb3JlKQogIH0KCiAgcmVtb3ZlIChjb3JlKSB7CiAgICB0aGlzLmNvdXBsZWQuZGVsZXRlKGNvcmUpCiAgfQoKICBkZXN0cm95ICgpIHsKICAgIHRoaXMudGFyZ2V0Lm9mZigncGVlci1hZGQnLCB0aGlzLl9vbnBlZXJhZGRCb3VuZCkKICB9CgogIGFzeW5jIHVwZGF0ZSAoc3RyZWFtKSB7CiAgICBjb25zdCBtdXhlciA9IHN0cmVhbS51c2VyRGF0YQogICAgaWYgKCFtdXhlcikgcmV0dXJuCgogICAgdHJ5IHsKICAgICAgaWYgKCEoYXdhaXQgdGhpcy5faGFzTXV4ZXIodGhpcy50YXJnZXQsIG11eGVyKSkpIHJldHVybgoKICAgICAgbGV0IHdha2V1cCA9IG51bGwKCiAgICAgIGZvciAoY29uc3QgY29yZSBvZiB0aGlzLmNvdXBsZWQpIHsKICAgICAgICBpZiAoYXdhaXQgdGhpcy5faGFzTXV4ZXIoY29yZSwgbXV4ZXIpKSBjb250aW51ZQogICAgICAgIGlmICh3YWtldXAgPT09IG51bGwpIHdha2V1cCA9IFtdCiAgICAgICAgd2FrZXVwLnB1c2goY29yZSkKICAgICAgfQoKICAgICAgaWYgKHdha2V1cCAhPT0gbnVsbCkgewogICAgICAgIHRoaXMud2FrZXVwKHN0cmVhbSwgd2FrZXVwKQogICAgICB9CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgfQogIH0KCiAgYXN5bmMgX2NvdXBsZSAoY29yZSkgewogICAgdHJ5IHsKICAgICAgbGV0IHdha2V1cCA9IG51bGwKCiAgICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnRhcmdldC5wZWVycykgewogICAgICAgIGlmIChhd2FpdCB0aGlzLl9oYXNQZWVyKGNvcmUsIHBlZXIpKSBjb250aW51ZQogICAgICAgIGlmICh3YWtldXAgPT09IG51bGwpIHdha2V1cCA9IFtdCiAgICAgICAgd2FrZXVwLnB1c2gocGVlcikKICAgICAgfQoKICAgICAgaWYgKHdha2V1cCAhPT0gbnVsbCAmJiB0aGlzLmNvdXBsZWQuaGFzKGNvcmUpKSB7CiAgICAgICAgZm9yIChjb25zdCBwZWVyIG9mIHdha2V1cCkgdGhpcy53YWtldXAocGVlci5zdHJlYW0sIFtjb3JlXSkKICAgICAgfQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgIH0KICB9CgogIGFzeW5jIF9vbnBlZXJhZGQgKHBlZXIpIHsKICAgIHRyeSB7CiAgICAgIGxldCB3YWtldXAgPSBudWxsCgogICAgICBmb3IgKGNvbnN0IGNvcmUgb2YgdGhpcy5jb3VwbGVkKSB7CiAgICAgICAgaWYgKGF3YWl0IHRoaXMuX2hhc1BlZXIoY29yZSwgcGVlcikpIGNvbnRpbnVlCiAgICAgICAgaWYgKHdha2V1cCA9PT0gbnVsbCkgd2FrZXVwID0gW10KICAgICAgICB3YWtldXAucHVzaChjb3JlKQogICAgICB9CgogICAgICBpZiAod2FrZXVwICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy53YWtldXAocGVlci5zdHJlYW0sIHdha2V1cCkKICAgICAgfQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgIH0KICB9CgogIF9oYXNNdXhlciAoY29yZSwgbXV4ZXIpIHsKICAgIGNvbnN0IGNoID0gbXV4ZXIuZ2V0TGFzdENoYW5uZWwoeyBwcm90b2NvbDogJ2h5cGVyY29yZScsIGlkOiBjb3JlLmRpc2NvdmVyeUtleSB9KQogICAgaWYgKGNoKSByZXR1cm4gY2guZnVsbHlPcGVuZWQoKQoKICAgIGNvbnN0IGNoYSA9IG11eGVyLmdldExhc3RDaGFubmVsKHsgcHJvdG9jb2w6ICdoeXBlcmNvcmUvYWxwaGEnLCBpZDogY29yZS5kaXNjb3ZlcnlLZXkgfSkKICAgIGlmIChjaGEpIHJldHVybiBjaGEuZnVsbHlPcGVuZWQoKQoKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpCiAgfQoKICBfaGFzUGVlciAoY29yZSwgcGVlcikgewogICAgcmV0dXJuIHRoaXMuX2hhc011eGVyKGNvcmUsIHBlZXIucHJvdG9tdXgpCiAgfQp9CnsKICAibmFtZSI6ICJjb3JlLWNvdXBsZXIiLAogICJ2ZXJzaW9uIjogIjIuMC4wIiwKICAiZGVzY3JpcHRpb24iOiAiQ291cGxlIHRoZSBwZWVycyBvZiBjb3JlcyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQiCiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgInNhZmV0eS1jYXRjaCI6ICJeMS4wLjIiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImNvcmVzdG9yZSI6ICJeNi4xOC4yIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4wIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vY29yZS1jb3VwbGVyLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYyIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9jb3JlLWNvdXBsZXIvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9jb3JlLWNvdXBsZXIiCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgSHlwZXJjb3JlID0gcmVxdWlyZSgnaHlwZXJjb3JlJykKY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBJRCA9IHJlcXVpcmUoJ2h5cGVyY29yZS1pZC1lbmNvZGluZycpCmNvbnN0IHsgaXNBbmRyb2lkIH0gPSByZXF1aXJlKCd3aGljaC1ydW50aW1lJykKY29uc3QgeyBTVE9SQUdFX0VNUFRZLCBBU1NFUlRJT04gfSA9IHJlcXVpcmUoJ2h5cGVyY29yZS1lcnJvcnMnKQoKY29uc3QgYXVkaXRTdG9yZSA9IHJlcXVpcmUoJy4vbGliL2F1ZGl0LmpzJykKCmNvbnN0IFtOU10gPSBjcnlwdG8ubmFtZXNwYWNlKCdjb3Jlc3RvcmUnLCAxKQpjb25zdCBERUZBVUxUX05BTUVTUEFDRSA9IGI0YS5hbGxvYygzMikgLy8gVGhpcyBpcyBtZWFudCB0byBiZSAzMiAwLWJ5dGVzCgpjbGFzcyBTdHJlYW1UcmFja2VyIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMucmVjb3JkcyA9IFtdCiAgfQoKICBhZGQoc3RyZWFtLCBpc0V4dGVybmFsKSB7CiAgICBjb25zdCByZWNvcmQgPSB7IGluZGV4OiAwLCBzdHJlYW0sIGlzRXh0ZXJuYWwgfQogICAgcmVjb3JkLmluZGV4ID0gdGhpcy5yZWNvcmRzLnB1c2gocmVjb3JkKSAtIDEKICAgIHJldHVybiByZWNvcmQKICB9CgogIHJlbW92ZShyZWNvcmQpIHsKICAgIGNvbnN0IHBvcHBlZCA9IHRoaXMucmVjb3Jkcy5wb3AoKQogICAgaWYgKHBvcHBlZCA9PT0gcmVjb3JkKSByZXR1cm4KICAgIHRoaXMucmVjb3Jkc1socG9wcGVkLmluZGV4ID0gcmVjb3JkLmluZGV4KV0gPSBwb3BwZWQKICB9CgogIGF0dGFjaEFsbChjb3JlKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucmVjb3Jkcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCByZWNvcmQgPSB0aGlzLnJlY29yZHNbaV0KICAgICAgY29uc3QgbXV4ZXIgPSByZWNvcmQuc3RyZWFtLm5vaXNlU3RyZWFtLnVzZXJEYXRhCiAgICAgIGlmICghY29yZS5yZXBsaWNhdG9yLmF0dGFjaGVkKG11eGVyKSkgY29yZS5yZXBsaWNhdG9yLmF0dGFjaFRvKG11eGVyKQogICAgfQogIH0KCiAgZGVzdHJveSgpIHsKICAgIC8vIHJldmVyc2UgaXMgc2FmZXIgY2F1c2Ugd2UgZGVsZXRlIG1iCiAgICBmb3IgKGxldCBpID0gdGhpcy5yZWNvcmRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHJlY29yZCA9IHRoaXMucmVjb3Jkc1tpXQogICAgICBpZiAoIXJlY29yZC5pc0V4dGVybmFsKSByZWNvcmQuc3RyZWFtLmRlc3Ryb3koKQogICAgfQogIH0KfQoKY2xhc3MgU2Vzc2lvblRyYWNrZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5tYXAgPSBuZXcgTWFwKCkKICB9CgogIGdldCBzaXplKCkgewogICAgcmV0dXJuIHRoaXMubWFwLnNpemUKICB9CgogIGdldChpZCkgewogICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLm1hcC5nZXQoaWQpCiAgICBpZiAoZXhpc3RpbmcgIT09IHVuZGVmaW5lZCkgcmV0dXJuIGV4aXN0aW5nCiAgICBjb25zdCBmcmVzaCA9IFtdCiAgICB0aGlzLm1hcC5zZXQoaWQsIGZyZXNoKQogICAgcmV0dXJuIGZyZXNoCiAgfQoKICBnYyhpZCkgewogICAgdGhpcy5tYXAuZGVsZXRlKGlkKQogIH0KCiAgbGlzdChpZCkgewogICAgcmV0dXJuIGlkID8gdGhpcy5tYXAuZ2V0KGlkKSB8fCBbXSA6IFsuLi50aGlzXQogIH0KCiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgZm9yIChjb25zdCBzZXNzaW9ucyBvZiB0aGlzLm1hcC52YWx1ZXMoKSkgewogICAgICB5aWVsZCogc2Vzc2lvbnNbU3ltYm9sLml0ZXJhdG9yXSgpCiAgICB9CiAgfQp9CgpjbGFzcyBDb3JlVHJhY2tlciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLm1hcCA9IG5ldyBNYXAoKQogICAgdGhpcy53YXRjaGluZyA9IFtdCgogICAgdGhpcy5fZ2NpbmcgPSBuZXcgU2V0KCkKICAgIHRoaXMuX2djSW50ZXJ2YWwgPSBudWxsCiAgICB0aGlzLl9nY0N5Y2xlQm91bmQgPSB0aGlzLl9nY0N5Y2xlLmJpbmQodGhpcykKICB9CgogIGdldCBzaXplKCkgewogICAgcmV0dXJuIHRoaXMubWFwLnNpemUKICB9CgogIHdhdGNoKHN0b3JlKSB7CiAgICBpZiAoc3RvcmUud2F0Y2hJbmRleCAhPT0gLTEpIHJldHVybgogICAgc3RvcmUud2F0Y2hJbmRleCA9IHRoaXMud2F0Y2hpbmcucHVzaChzdG9yZSkgLSAxCiAgfQoKICB1bndhdGNoKHN0b3JlKSB7CiAgICBpZiAoc3RvcmUud2F0Y2hJbmRleCA9PT0gLTEpIHJldHVybgogICAgY29uc3QgaGVhZCA9IHRoaXMud2F0Y2hpbmcucG9wKCkKICAgIGlmIChoZWFkICE9PSBzdG9yZSkgdGhpcy53YXRjaGluZ1soaGVhZC53YXRjaEluZGV4ID0gc3RvcmUud2F0Y2hJbmRleCldID0gaGVhZAogICAgc3RvcmUud2F0Y2hJbmRleCA9IC0xCiAgfQoKICByZXN1bWUoaWQpIHsKICAgIGNvbnN0IGNvcmUgPSB0aGlzLm1hcC5nZXQoaWQpCgogICAgaWYgKCFjb3JlKSByZXR1cm4gbnVsbAoKICAgIC8vIHNpZ25hbCBiYWNrIHRoYXQgd2UgaGF2ZSBhIGNsb3Npbmcgb25lIHN0b3JlZAogICAgaWYgKGNvcmUuY2xvc2luZykgcmV0dXJuIGNvcmUKCiAgICBpZiAoY29yZS5nYykgewogICAgICB0aGlzLl9nY2luZy5kZWxldGUoY29yZSkKICAgICAgaWYgKHRoaXMuX2djaW5nLnNpemUgPT09IDApIHRoaXMuX3N0b3BHQygpCiAgICAgIGNvcmUuZ2MgPSAwCiAgICB9CgogICAgcmV0dXJuIGNvcmUKICB9CgogIG9wZW5lZChpZCkgewogICAgY29uc3QgY29yZSA9IHRoaXMubWFwLmdldChpZCkKICAgIHJldHVybiAhIShjb3JlICYmIGNvcmUub3BlbmVkICYmICFjb3JlLmNsb3NpbmcpCiAgfQoKICBnZXQoaWQpIHsKICAgIC8vIHdlIGFsbG93IHlvdSBkbyBjYWxsIHRoaXMgZnJvbSB0aGUgb3V0c2lkZSwgc28gc3VwcG9ydCBub3JtYWwgYnVmZmVycyBhbHNvCiAgICBpZiAoYjRhLmlzQnVmZmVyKGlkKSkgaWQgPSBiNGEudG9TdHJpbmcoaWQsICdoZXgnKQogICAgY29uc3QgY29yZSA9IHRoaXMubWFwLmdldChpZCkKICAgIGlmICghY29yZSB8fCBjb3JlLmNsb3NpbmcpIHJldHVybiBudWxsCiAgICByZXR1cm4gY29yZQogIH0KCiAgc2V0KGlkLCBjb3JlKSB7CiAgICB0aGlzLm1hcC5zZXQoaWQsIGNvcmUpCiAgICBpZiAodGhpcy53YXRjaGluZy5sZW5ndGggPiAwKSB0aGlzLl9lbWl0KGNvcmUpCiAgfQoKICBfZW1pdChjb3JlKSB7CiAgICBmb3IgKGxldCBpID0gdGhpcy53YXRjaGluZy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBzdG9yZSA9IHRoaXMud2F0Y2hpbmdbaV0KICAgICAgZm9yIChjb25zdCBmbiBvZiBzdG9yZS53YXRjaGVycykgZm4oY29yZSkKICAgIH0KICB9CgogIF9nYyhjb3JlKSB7CiAgICBjb25zdCBpZCA9IHRvSGV4KGNvcmUuZGlzY292ZXJ5S2V5KQogICAgaWYgKHRoaXMubWFwLmdldChpZCkgPT09IGNvcmUpIHRoaXMubWFwLmRlbGV0ZShpZCkKICB9CgogIF9nY0N5Y2xlKCkgewogICAgZm9yIChjb25zdCBjb3JlIG9mIHRoaXMuX2djaW5nKSB7CiAgICAgIGlmICgrK2NvcmUuZ2MgPCA0KSBjb250aW51ZQogICAgICBjb25zdCBnYyA9IHRoaXMuX2djLmJpbmQodGhpcywgY29yZSkKICAgICAgY29yZS5jbG9zZSgpLnRoZW4oZ2MsIGdjKQogICAgICB0aGlzLl9nY2luZy5kZWxldGUoY29yZSkKICAgIH0KCiAgICBpZiAodGhpcy5fZ2Npbmcuc2l6ZSA9PT0gMCkgdGhpcy5fc3RvcEdDKCkKICB9CgogIGdjKGNvcmUpIHsKICAgIGNvcmUuZ2MgPSAxIC8vIGZpcnN0IHN0cmlrZQogICAgdGhpcy5fZ2NpbmcuYWRkKGNvcmUpCiAgICBpZiAodGhpcy5fZ2Npbmcuc2l6ZSA9PT0gMSkgdGhpcy5fc3RhcnRHQygpCiAgfQoKICBfc3RvcEdDKCkgewogICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9nY0ludGVydmFsKQogICAgdGhpcy5fZ2NJbnRlcnZhbCA9IG51bGwKICB9CgogIF9zdGFydEdDKCkgewogICAgaWYgKHRoaXMuX2djSW50ZXJ2YWwpIHJldHVybgogICAgdGhpcy5fZ2NJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuX2djQ3ljbGVCb3VuZCwgMjAwMCkKICAgIGlmICh0aGlzLl9nY0ludGVydmFsLnVucmVmKSB0aGlzLl9nY0ludGVydmFsLnVucmVmKCkKICB9CgogIGNsb3NlKCkgewogICAgdGhpcy5fc3RvcEdDKCkKICAgIHRoaXMuX2djaW5nLmNsZWFyKCkKCiAgICBjb25zdCBhbGwgPSBbXQogICAgZm9yIChjb25zdCBjb3JlIG9mIHRoaXMubWFwLnZhbHVlcygpKSB7CiAgICAgIGNvcmUub25pZGxlID0gbm9vcCAvLyBubyByZWVudHJ5CiAgICAgIGFsbC5wdXNoKGNvcmUuY2xvc2UoKSkKICAgIH0KICAgIHRoaXMubWFwLmNsZWFyKCkKCiAgICByZXR1cm4gUHJvbWlzZS5hbGwoYWxsKQogIH0KCiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgZm9yIChjb25zdCBjb3JlIG9mIHRoaXMubWFwLnZhbHVlcygpKSB7CiAgICAgIGlmICghY29yZS5jbG9zaW5nKSB5aWVsZCBjb3JlCiAgICB9CiAgfQp9CgpjbGFzcyBGaW5kaW5nUGVlcnMgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5jb3VudCA9IDAKICAgIHRoaXMucGVuZGluZyA9IFtdCiAgfQoKICBhZGQoY29yZSkgewogICAgaWYgKHRoaXMuY291bnQgPT09IDApIHJldHVybgogICAgdGhpcy5wZW5kaW5nLnB1c2goY29yZS5maW5kaW5nUGVlcnMoKSkKICB9CgogIGluYyhzZXNzaW9ucykgewogICAgaWYgKCsrdGhpcy5jb3VudCAhPT0gMSkgcmV0dXJuCgogICAgZm9yIChjb25zdCBjb3JlIG9mIHNlc3Npb25zKSB7CiAgICAgIHRoaXMucGVuZGluZy5wdXNoKGNvcmUuZmluZGluZ1BlZXJzKCkpCiAgICB9CiAgfQoKICBkZWMoc2Vzc2lvbnMpIHsKICAgIGlmICgtLXRoaXMuY291bnQgIT09IDApIHJldHVybgogICAgd2hpbGUgKHRoaXMucGVuZGluZy5sZW5ndGggPiAwKSB0aGlzLnBlbmRpbmcucG9wKCkoKQogIH0KfQoKY2xhc3MgQ29yZXN0b3JlIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3Ioc3RvcmFnZSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5yb290ID0gb3B0cy5yb290IHx8IG51bGwKICAgIHRoaXMuc3RvcmFnZSA9IHRoaXMucm9vdAogICAgICA/IHRoaXMucm9vdC5zdG9yYWdlCiAgICAgIDogSHlwZXJjb3JlLmRlZmF1bHRTdG9yYWdlKHN0b3JhZ2UsIHsKICAgICAgICAgIGlkOiBvcHRzLmlkLAogICAgICAgICAgYWxsb3dCYWNrdXA6IG9wdHMuYWxsb3dCYWNrdXAsCiAgICAgICAgICByZWFkT25seTogb3B0cy5yZWFkT25seSwKICAgICAgICAgIHdhaXQ6IG9wdHMud2FpdAogICAgICAgIH0pCiAgICB0aGlzLnN0cmVhbVRyYWNrZXIgPSB0aGlzLnJvb3QgPyB0aGlzLnJvb3Quc3RyZWFtVHJhY2tlciA6IG5ldyBTdHJlYW1UcmFja2VyKCkKICAgIHRoaXMuY29yZXMgPSB0aGlzLnJvb3QgPyB0aGlzLnJvb3QuY29yZXMgOiBuZXcgQ29yZVRyYWNrZXIoKQogICAgdGhpcy5zZXNzaW9ucyA9IG5ldyBTZXNzaW9uVHJhY2tlcigpCiAgICB0aGlzLmNvcmVzdG9yZXMgPSB0aGlzLnJvb3QgPyB0aGlzLnJvb3QuY29yZXN0b3JlcyA6IG5ldyBTZXQoKQogICAgdGhpcy5yZWFkT25seSA9IG9wdHMud3JpdGFibGUgPT09IGZhbHNlIHx8ICEhb3B0cy5yZWFkT25seQogICAgdGhpcy5nbG9iYWxDYWNoZSA9IHRoaXMucm9vdCA/IHRoaXMucm9vdC5nbG9iYWxDYWNoZSA6IG9wdHMuZ2xvYmFsQ2FjaGUgfHwgbnVsbAogICAgdGhpcy5wcmltYXJ5S2V5ID0gdGhpcy5yb290ID8gdGhpcy5yb290LnByaW1hcnlLZXkgOiBvcHRzLnByaW1hcnlLZXkgfHwgbnVsbAogICAgdGhpcy5ucyA9IG9wdHMubmFtZXNwYWNlIHx8IERFRkFVTFRfTkFNRVNQQUNFCiAgICB0aGlzLm1hbmlmZXN0VmVyc2lvbiA9IG9wdHMubWFuaWZlc3RWZXJzaW9uIHx8IDEKICAgIHRoaXMuc2hvdWxkU3VzcGVuZCA9IGlzQW5kcm9pZCA/ICEhb3B0cy5zdXNwZW5kIDogb3B0cy5zdXNwZW5kICE9PSBmYWxzZQogICAgdGhpcy5hY3RpdmUgPSBvcHRzLmFjdGl2ZSAhPT0gZmFsc2UKCiAgICB0aGlzLndhdGNoZXJzID0gbnVsbAogICAgdGhpcy53YXRjaEluZGV4ID0gLTEKCiAgICB0aGlzLl9maW5kaW5nUGVlcnMgPSBudWxsIC8vIGhlcmUgZm9yIGxlZ2FjeQogICAgdGhpcy5fb25nY0JvdW5kID0gdGhpcy5fb25nYy5iaW5kKHRoaXMpCgogICAgaWYgKG9wdHMucHJpbWFyeUtleSAmJiAhdGhpcy5yb290ICYmICFvcHRzLnVuc2FmZSkgewogICAgICB0aHJvdyBBU1NFUlRJT04oCiAgICAgICAgJ1Bhc3NpbmcgdGhlIHByaW1hcnkga2V5IGlzIHVuc2FmZSB1bmxlc3MgeW91IGtub3cgd2hhdCB5b3UgYXJlIGRvaW5nLiBTZXQgdW5zYWZlOiB0cnVlIHRvIGFja25vd2xlZGdlIHRoYXQnCiAgICAgICkKICAgIH0KCiAgICBpZiAodGhpcy5yb290KSB0aGlzLmNvcmVzdG9yZXMuYWRkKHRoaXMpCgogICAgdGhpcy5yZWFkeSgpLmNhdGNoKG5vb3ApCiAgfQoKICB3YXRjaChmbikgewogICAgaWYgKHRoaXMud2F0Y2hlcnMgPT09IG51bGwpIHsKICAgICAgdGhpcy53YXRjaGVycyA9IG5ldyBTZXQoKQogICAgICB0aGlzLmNvcmVzLndhdGNoKHRoaXMpCiAgICB9CgogICAgdGhpcy53YXRjaGVycy5hZGQoZm4pCiAgfQoKICB1bndhdGNoKGZuKSB7CiAgICBpZiAodGhpcy53YXRjaGVycyA9PT0gbnVsbCkgcmV0dXJuCgogICAgdGhpcy53YXRjaGVycy5kZWxldGUoZm4pCgogICAgaWYgKHRoaXMud2F0Y2hlcnMuc2l6ZSA9PT0gMCkgewogICAgICB0aGlzLndhdGNoZXJzID0gbnVsbAogICAgICB0aGlzLmNvcmVzLnVud2F0Y2godGhpcykKICAgIH0KICB9CgogIGZpbmRpbmdQZWVycygpIHsKICAgIGlmICh0aGlzLl9maW5kaW5nUGVlcnMgPT09IG51bGwpIHRoaXMuX2ZpbmRpbmdQZWVycyA9IG5ldyBGaW5kaW5nUGVlcnMoKQogICAgdGhpcy5fZmluZGluZ1BlZXJzLmluYyh0aGlzLnNlc3Npb25zKQogICAgbGV0IGRvbmUgPSBmYWxzZQogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKGRvbmUpIHJldHVybgogICAgICBkb25lID0gdHJ1ZQogICAgICB0aGlzLl9maW5kaW5nUGVlcnMuZGVjKHRoaXMuc2Vzc2lvbnMpCiAgICB9CiAgfQoKICBhdWRpdChvcHRzID0ge30pIHsKICAgIHJldHVybiBhdWRpdFN0b3JlKHRoaXMsIG9wdHMpCiAgfQoKICBhc3luYyBzdXNwZW5kKHsgbG9nID0gbm9vcCB9ID0ge30pIHsKICAgIGF3YWl0IGxvZygnRmx1c2hpbmcgZGIuLi4nKQogICAgLy8gSWYgcmVhZE9ubHkgd2UgZG9uJ3QgbmVlZCB0byBmbHVzaAogICAgaWYgKCF0aGlzLnN0b3JhZ2UucmVhZE9ubHkpIGF3YWl0IHRoaXMuc3RvcmFnZS5kYi5mbHVzaCgpCiAgICBpZiAoIXRoaXMuc2hvdWxkU3VzcGVuZCkgcmV0dXJuCiAgICBhd2FpdCBsb2coJ1N1c3BlbmRpbmcgZGIuLi4nKQogICAgYXdhaXQgdGhpcy5zdG9yYWdlLnN1c3BlbmQoKQogIH0KCiAgcmVzdW1lKCkgewogICAgcmV0dXJuIHRoaXMuc3RvcmFnZS5yZXN1bWUoKQogIH0KCiAgc2Vzc2lvbihvcHRzKSB7CiAgICB0aGlzLl9tYXliZUNsb3NlZCgpCiAgICBjb25zdCByb290ID0gdGhpcy5yb290IHx8IHRoaXMKICAgIHJldHVybiBuZXcgQ29yZXN0b3JlKG51bGwsIHsKICAgICAgbWFuaWZlc3RWZXJzaW9uOiB0aGlzLm1hbmlmZXN0VmVyc2lvbiwKICAgICAgLi4ub3B0cywKICAgICAgcm9vdAogICAgfSkKICB9CgogIG5hbWVzcGFjZShuYW1lLCBvcHRzKSB7CiAgICByZXR1cm4gdGhpcy5zZXNzaW9uKHsKICAgICAgLi4ub3B0cywKICAgICAgbmFtZXNwYWNlOiBnZW5lcmF0ZU5hbWVzcGFjZSh0aGlzLm5zLCBuYW1lKQogICAgfSkKICB9CgogIGxpc3QobmFtZXNwYWNlKSB7CiAgICByZXR1cm4gdGhpcy5zdG9yYWdlLmNyZWF0ZURpc2NvdmVyeUtleVN0cmVhbShuYW1lc3BhY2UpCiAgfQoKICBnZXRBdXRoKGRpc2NvdmVyeUtleSkgewogICAgcmV0dXJuIHRoaXMuc3RvcmFnZS5nZXRBdXRoKGRpc2NvdmVyeUtleSkKICB9CgogIF9vbmdjKHNlc3Npb24pIHsKICAgIGlmIChzZXNzaW9uLnNlc3Npb25zLmxlbmd0aCA9PT0gMCkgdGhpcy5zZXNzaW9ucy5nYyhzZXNzaW9uLmlkKQogIH0KCiAgYXN5bmMgX2dldE9yU2V0U2VlZCgpIHsKICAgIGNvbnN0IHNlZWQgPSBhd2FpdCB0aGlzLnN0b3JhZ2UuZ2V0U2VlZCgpCiAgICBpZiAoc2VlZCAhPT0gbnVsbCkgcmV0dXJuIHNlZWQKICAgIHJldHVybiBhd2FpdCB0aGlzLnN0b3JhZ2Uuc2V0U2VlZCh0aGlzLnByaW1hcnlLZXkgfHwgY3J5cHRvLnJhbmRvbUJ5dGVzKDMyKSkKICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgaWYgKHRoaXMucm9vdCAhPT0gbnVsbCkgewogICAgICBpZiAodGhpcy5yb290Lm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucm9vdC5yZWFkeSgpCiAgICAgIHRoaXMucHJpbWFyeUtleSA9IHRoaXMucm9vdC5wcmltYXJ5S2V5CiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IHByaW1hcnlLZXkgPSBhd2FpdCB0aGlzLl9nZXRPclNldFNlZWQoKQoKICAgIGlmICh0aGlzLnByaW1hcnlLZXkgPT09IG51bGwpIHsKICAgICAgdGhpcy5wcmltYXJ5S2V5ID0gcHJpbWFyeUtleQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoIWI0YS5lcXVhbHMocHJpbWFyeUtleSwgdGhpcy5wcmltYXJ5S2V5KSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Fub3RoZXIgY29yZXN0b3JlIGlzIHN0b3JlZCBoZXJlJykKICAgIH0KICB9CgogIGFzeW5jIF9jbG9zZSgpIHsKICAgIGNvbnN0IGNsb3NpbmcgPSBbXQogICAgY29uc3QgaGFuZ2luZyA9IFsuLi50aGlzLnNlc3Npb25zXQogICAgZm9yIChjb25zdCBzZXNzIG9mIGhhbmdpbmcpIGNsb3NpbmcucHVzaChzZXNzLmNsb3NlKCkpCgogICAgaWYgKHRoaXMud2F0Y2hlcnMgIT09IG51bGwpIHRoaXMuY29yZXMudW53YXRjaCh0aGlzKQoKICAgIGlmICh0aGlzLnJvb3QgIT09IG51bGwpIHsKICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoY2xvc2luZykKICAgICAgcmV0dXJuCiAgICB9CgogICAgZm9yIChjb25zdCBzdG9yZSBvZiB0aGlzLmNvcmVzdG9yZXMpIHsKICAgICAgY2xvc2luZy5wdXNoKHN0b3JlLmNsb3NlKCkpCiAgICB9CgogICAgYXdhaXQgUHJvbWlzZS5hbGwoY2xvc2luZykKCiAgICBhd2FpdCB0aGlzLmNvcmVzLmNsb3NlKCkKICAgIGF3YWl0IHRoaXMuc3RvcmFnZS5jbG9zZSgpCiAgfQoKICBhc3luYyBfYXR0YWNoTWF5YmUobXV4ZXIsIGRpc2NvdmVyeUtleSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAoCiAgICAgICF0aGlzLmNvcmVzLm9wZW5lZCh0b0hleChkaXNjb3ZlcnlLZXkpKSAmJgogICAgICAhKGF3YWl0IHRoaXMuc3RvcmFnZS5oYXNDb3JlKGRpc2NvdmVyeUtleSwgeyBpZk1pZ3JhdGVkOiB0cnVlIH0pKQogICAgKQogICAgICByZXR1cm4KICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybgoKICAgIGNvbnN0IGNvcmUgPSB0aGlzLl9vcGVuQ29yZShkaXNjb3ZlcnlLZXksIHsgY3JlYXRlSWZNaXNzaW5nOiBmYWxzZSB9KQoKICAgIGlmICghY29yZSkgcmV0dXJuCiAgICBpZiAoIWNvcmUub3BlbmVkKSBhd2FpdCBjb3JlLnJlYWR5KCkKCiAgICBpZiAoIWNvcmUucmVwbGljYXRvci5hdHRhY2hlZChtdXhlcikpIHsKICAgICAgY29yZS5yZXBsaWNhdG9yLmF0dGFjaFRvKG11eGVyKQogICAgfQoKICAgIGNvcmUuY2hlY2tJZklkbGUoKQogIH0KCiAgX3Nob3VsZFJlcGxpY2F0ZShjb3JlLCBtdXhlcikgewogICAgcmV0dXJuICgKICAgICAgY29yZS5yZXBsaWNhdG9yLmRvd25sb2FkaW5nICYmICFjb3JlLnJlcGxpY2F0b3IuYXR0YWNoZWQobXV4ZXIpICYmIGNvcmUub3BlbmVkICYmIHRoaXMuYWN0aXZlCiAgICApCiAgfQoKICByZXBsaWNhdGUoaXNJbml0aWF0b3IsIG9wdHMpIHsKICAgIHRoaXMuX21heWJlQ2xvc2VkKCkKCiAgICBjb25zdCBpc0V4dGVybmFsID0gaXNTdHJlYW0oaXNJbml0aWF0b3IpCiAgICBjb25zdCBzdHJlYW0gPSBIeXBlcmNvcmUuY3JlYXRlUHJvdG9jb2xTdHJlYW0oaXNJbml0aWF0b3IsIHsKICAgICAgLi4ub3B0cywKICAgICAgb25kaXNjb3ZlcnlrZXk6IChkaXNjb3ZlcnlLZXkpID0+IHsKICAgICAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4KICAgICAgICBjb25zdCBtdXhlciA9IHN0cmVhbS5ub2lzZVN0cmVhbS51c2VyRGF0YQogICAgICAgIHJldHVybiB0aGlzLl9hdHRhY2hNYXliZShtdXhlciwgZGlzY292ZXJ5S2V5KQogICAgICB9CiAgICB9KQoKICAgIGlmICh0aGlzLmNvcmVzLnNpemUgPiAwKSB7CiAgICAgIGNvbnN0IG11eGVyID0gc3RyZWFtLm5vaXNlU3RyZWFtLnVzZXJEYXRhCiAgICAgIGNvbnN0IHVuY29yayA9IG11eGVyLnVuY29yay5iaW5kKG11eGVyKQogICAgICBtdXhlci5jb3JrKCkKCiAgICAgIGZvciAoY29uc3QgY29yZSBvZiB0aGlzLmNvcmVzKSB7CiAgICAgICAgaWYgKCF0aGlzLl9zaG91bGRSZXBsaWNhdGUoY29yZSwgbXV4ZXIpKSB7CiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAgICAgICBjb3JlLnJlcGxpY2F0b3IuYXR0YWNoVG8obXV4ZXIpCiAgICAgIH0KCiAgICAgIHN0cmVhbS5ub2lzZVN0cmVhbS5vcGVuZWQudGhlbih1bmNvcmspCiAgICB9CgogICAgY29uc3QgcmVjb3JkID0gdGhpcy5zdHJlYW1UcmFja2VyLmFkZChzdHJlYW0sIGlzRXh0ZXJuYWwpCiAgICBzdHJlYW0ub25jZSgnY2xvc2UnLCAoKSA9PiB0aGlzLnN0cmVhbVRyYWNrZXIucmVtb3ZlKHJlY29yZCkpCiAgICByZXR1cm4gc3RyZWFtCiAgfQoKICBfbWF5YmVDbG9zZWQoKSB7CiAgICBpZiAodGhpcy5jbG9zaW5nIHx8ICh0aGlzLnJvb3QgIT09IG51bGwgJiYgdGhpcy5yb290LmNsb3NpbmcpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQ29yZXN0b3JlIGlzIGNsb3NlZCcpCiAgICB9CiAgfQoKICBhc3luYyBzdGF0aWNpZnkoY29yZSwgb3B0cykgewogICAgaWYgKCF0aGlzLm9wZW5lZCkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAoIWNvcmUub3BlbmVkKSBhd2FpdCBjb3JlLnJlYWR5KCkKCiAgICBjb25zdCByeCA9IGNvcmUuc3RhdGUuc3RvcmFnZS5yZWFkKCkKCiAgICBjb25zdCBoZWFkUHJvbWlzZSA9IHJ4LmdldEhlYWQoKQogICAgY29uc3QgYXV0aFByb21pc2UgPSByeC5nZXRBdXRoKCkKCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgW2hlYWQsIGF1dGhdID0gYXdhaXQgUHJvbWlzZS5hbGwoW2hlYWRQcm9taXNlLCBhdXRoUHJvbWlzZV0pCiAgICBpZiAoIWhlYWQgfHwgaGVhZC5sZW5ndGggPT09IDApIHRocm93IG5ldyBFcnJvcignQ29yZSBtdXN0IGhhdmUgZGF0YScpCgogICAgY29uc3QgcHJvbG9ndWUgPSB7CiAgICAgIGxlbmd0aDogaGVhZC5sZW5ndGgsCiAgICAgIGhhc2g6IGhlYWQucm9vdEhhc2gKICAgIH0KCiAgICBjb25zdCBtYW5pZmVzdCA9IHsKICAgICAgdmVyc2lvbjogMSwKICAgICAgaGFzaDogYXV0aC5tYW5pZmVzdC5oYXNoLAogICAgICBxdW9ydW06IDAsCiAgICAgIHNpZ25lcnM6IFtdLAogICAgICBwcm9sb2d1ZQogICAgfQoKICAgIGNvbnN0IGMgPSB7CiAgICAgIGtleTogbnVsbCwKICAgICAgZGlzY292ZXJ5S2V5OiBudWxsLAogICAgICBtYW5pZmVzdCwKICAgICAgY29yZTogY29yZS5zdGF0ZS5zdG9yYWdlLmNvcmUKICAgIH0KCiAgICBjLmtleSA9IEh5cGVyY29yZS5rZXkoYy5tYW5pZmVzdCkKICAgIGMuZGlzY292ZXJ5S2V5ID0gSHlwZXJjb3JlLmRpc2NvdmVyeUtleShjLmtleSkKCiAgICBhd2FpdCB0aGlzLnN0b3JhZ2UuY3JlYXRlQ29yZShjKQoKICAgIGNvbnN0IHN0YXRpY0NvcmUgPSB0aGlzLmdldCh7IC4uLm9wdHMsIGtleTogYy5rZXkgfSkKICAgIGF3YWl0IHN0YXRpY0NvcmUucmVhZHkoKQogICAgcmV0dXJuIHN0YXRpY0NvcmUKICB9CgogIGdldChvcHRzKSB7CiAgICB0aGlzLl9tYXliZUNsb3NlZCgpCgogICAgaWYgKGI0YS5pc0J1ZmZlcihvcHRzKSB8fCB0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGtleTogb3B0cyB9CiAgICBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICAgIGNvbnN0IGNvbmYgPSB7CiAgICAgIHByZWxvYWQ6IG51bGwsCiAgICAgIHNlc3Npb25zOiBudWxsLAogICAgICBvbmdjOiBudWxsLAogICAgICBjb3JlOiBudWxsLAogICAgICBhY3RpdmU6IG9wdHMuYWN0aXZlICE9PSBmYWxzZSwKICAgICAgZW5jcnlwdGlvbjogb3B0cy5lbmNyeXB0aW9uIHx8IG51bGwsCiAgICAgIGVuY3J5cHRpb25LZXk6IG9wdHMuZW5jcnlwdGlvbktleSB8fCBudWxsLCAvLyBiYWNrIGNvbXBhdCwgc2hvdWxkIHJlbW92ZQogICAgICBpc0Jsb2NrS2V5OiAhIW9wdHMuaXNCbG9ja0tleSwgLy8gYmFjayBjb21wYXQsIHNob3VsZCByZW1vdmUKICAgICAgdmFsdWVFbmNvZGluZzogb3B0cy52YWx1ZUVuY29kaW5nIHx8IG51bGwsCiAgICAgIGV4Y2x1c2l2ZTogISFvcHRzLmV4Y2x1c2l2ZSwKICAgICAgbWFuaWZlc3Q6IG9wdHMubWFuaWZlc3QgfHwgbnVsbCwKICAgICAga2V5UGFpcjogb3B0cy5rZXlQYWlyIHx8IG51bGwsCiAgICAgIG9ud2FpdDogb3B0cy5vbndhaXQgfHwgbnVsbCwKICAgICAgd2FpdDogb3B0cy53YWl0ICE9PSBmYWxzZSwKICAgICAgdGltZW91dDogb3B0cy50aW1lb3V0IHx8IDAsCiAgICAgIGRyYWZ0OiAhIW9wdHMuZHJhZnQsCiAgICAgIHdyaXRhYmxlOiBvcHRzLndyaXRhYmxlID09PSB1bmRlZmluZWQgJiYgdGhpcy5yZWFkT25seSA/IGZhbHNlIDogb3B0cy53cml0YWJsZQogICAgfQoKICAgIC8vIG5hbWUgcmVxdWlyZXMgdXMgdG8gcnQgdG8gc3RvcmFnZSArIHJlYWR5LCBzbyBuZWVkcyBwcmVsb2FkCiAgICAvLyBzYW1lIGdvZXMgaWYgdXNlciBoYXMgZGVmaW5lZCBhc3luYyBwcmVsb2FkIG9idnMKICAgIGlmIChvcHRzLm5hbWUgfHwgb3B0cy5wcmVsb2FkKSB7CiAgICAgIGNvbmYucHJlbG9hZCA9IHRoaXMuX3ByZWxvYWQob3B0cykKICAgICAgcmV0dXJuIHRoaXMuX21ha2VTZXNzaW9uKGNvbmYpCiAgICB9CgogICAgaWYgKG9wdHMuZGlzY292ZXJ5S2V5ICYmICFvcHRzLmtleSAmJiAhb3B0cy5tYW5pZmVzdCkgewogICAgICBjb25mLnByZWxvYWQgPSB0aGlzLl9wcmVsb2FkQ2hlY2tJZkV4aXN0cyhvcHRzKQogICAgICByZXR1cm4gdGhpcy5fbWFrZVNlc3Npb24oY29uZikKICAgIH0KCiAgICAvLyBpZiBub3Qgbm90IHdlIGNhbiBzeW5jIGNyZWF0ZSBpdCwgd2hpY2gganVzdCBpcyBlYXNpZXIgZm9yIHRoZQogICAgLy8gdXBzdHJlYW0gdXNlciBpbiB0ZXJtcyBvZiBndWFyYW50ZWVzIChrZXkgaXMgdGhlcmUgZXRjIGV0YykKICAgIGNvbnN0IGNvcmUgPSB0aGlzLl9vcGVuQ29yZShudWxsLCBvcHRzKQoKICAgIGNvbmYuY29yZSA9IGNvcmUKICAgIGNvbmYuc2Vzc2lvbnMgPSB0aGlzLnNlc3Npb25zLmdldChjb3JlLmlkKQogICAgY29uZi5vbmdjID0gdGhpcy5fb25nY0JvdW5kCgogICAgcmV0dXJuIHRoaXMuX21ha2VTZXNzaW9uKGNvbmYpCiAgfQoKICBfbWFrZVNlc3Npb24oY29uZikgewogICAgY29uc3Qgc2Vzc2lvbiA9IG5ldyBIeXBlcmNvcmUobnVsbCwgbnVsbCwgY29uZikKICAgIGlmICh0aGlzLl9maW5kaW5nUGVlcnMgIT09IG51bGwpIHRoaXMuX2ZpbmRpbmdQZWVycy5hZGQoc2Vzc2lvbikKICAgIHJldHVybiBzZXNzaW9uCiAgfQoKICBhc3luYyBjcmVhdGVLZXlQYWlyKG5hbWUsIG5zID0gdGhpcy5ucykgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICByZXR1cm4gY3JlYXRlS2V5UGFpcih0aGlzLnByaW1hcnlLZXksIG5zLCBuYW1lKQogIH0KCiAgYXN5bmMgX3ByZWxvYWRDaGVja0lmRXhpc3RzKG9wdHMpIHsKICAgIGNvbnN0IGhhcyA9IGF3YWl0IHRoaXMuc3RvcmFnZS5oYXNDb3JlKG9wdHMuZGlzY292ZXJ5S2V5KQogICAgaWYgKCFoYXMpIHRocm93IFNUT1JBR0VfRU1QVFkoJ05vIEh5cGVyY29yZSBpcyBzdG9yZWQgaGVyZScpCiAgICByZXR1cm4gdGhpcy5fcHJlbG9hZChvcHRzKQogIH0KCiAgYXN5bmMgX3ByZWxvYWQob3B0cykgewogICAgaWYgKG9wdHMucHJlbG9hZCkgb3B0cyA9IHsgLi4ub3B0cywgLi4uKGF3YWl0IG9wdHMucHJlbG9hZCkgfQogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgY29uc3QgZGlzY292ZXJ5S2V5ID0gb3B0cy5uYW1lCiAgICAgID8gYXdhaXQgdGhpcy5zdG9yYWdlLmdldEFsaWFzKHsgbmFtZTogb3B0cy5uYW1lLCBuYW1lc3BhY2U6IHRoaXMubnMgfSkKICAgICAgOiBudWxsCiAgICB0aGlzLl9tYXliZUNsb3NlZCgpCgogICAgY29uc3QgY29yZSA9IHRoaXMuX29wZW5Db3JlKGRpc2NvdmVyeUtleSwgb3B0cykKCiAgICByZXR1cm4gewogICAgICBjb3JlLAogICAgICBzZXNzaW9uczogdGhpcy5zZXNzaW9ucy5nZXQoY29yZS5pZCksCiAgICAgIG9uZ2M6IHRoaXMuX29uZ2NCb3VuZCwKICAgICAgZW5jcnlwdGlvbjogb3B0cy5lbmNyeXB0aW9uIHx8IG51bGwsCiAgICAgIGVuY3J5cHRpb25LZXk6IG9wdHMuZW5jcnlwdGlvbktleSB8fCBudWxsLCAvLyBiYWNrIGNvbXBhdCwgc2hvdWxkIHJlbW92ZQogICAgICBpc0Jsb2NrS2V5OiAhIW9wdHMuaXNCbG9ja0tleSAvLyBiYWNrIGNvbXBhdCwgc2hvdWxkIHJlbW92ZQogICAgfQogIH0KCiAgX2F1dGgoZGlzY292ZXJ5S2V5LCBvcHRzKSB7CiAgICBjb25zdCByZXN1bHQgPSB7CiAgICAgIGtleVBhaXI6IG51bGwsCiAgICAgIGtleTogbnVsbCwKICAgICAgZGlzY292ZXJ5S2V5LAogICAgICBtYW5pZmVzdDogbnVsbAogICAgfQoKICAgIGlmIChvcHRzLm5hbWUpIHsKICAgICAgcmVzdWx0LmtleVBhaXIgPSBjcmVhdGVLZXlQYWlyKHRoaXMucHJpbWFyeUtleSwgdGhpcy5ucywgb3B0cy5uYW1lKQogICAgfSBlbHNlIGlmIChvcHRzLmtleVBhaXIpIHsKICAgICAgcmVzdWx0LmtleVBhaXIgPSBvcHRzLmtleVBhaXIKICAgIH0KCiAgICBpZiAob3B0cy5tYW5pZmVzdCkgewogICAgICByZXN1bHQubWFuaWZlc3QgPSBvcHRzLm1hbmlmZXN0CiAgICB9IGVsc2UgaWYgKHJlc3VsdC5rZXlQYWlyICYmICFyZXN1bHQuZGlzY292ZXJ5S2V5KSB7CiAgICAgIHJlc3VsdC5tYW5pZmVzdCA9IHsKICAgICAgICB2ZXJzaW9uOiB0aGlzLm1hbmlmZXN0VmVyc2lvbiwKICAgICAgICBzaWduZXJzOiBbeyBwdWJsaWNLZXk6IHJlc3VsdC5rZXlQYWlyLnB1YmxpY0tleSB9XQogICAgICB9CiAgICB9CgogICAgaWYgKG9wdHMua2V5KSByZXN1bHQua2V5ID0gSUQuZGVjb2RlKG9wdHMua2V5KQogICAgZWxzZSBpZiAocmVzdWx0Lm1hbmlmZXN0KSByZXN1bHQua2V5ID0gSHlwZXJjb3JlLmtleShyZXN1bHQubWFuaWZlc3QpCgogICAgaWYgKHJlc3VsdC5kaXNjb3ZlcnlLZXkpIHJldHVybiByZXN1bHQKCiAgICBpZiAob3B0cy5kaXNjb3ZlcnlLZXkpIHJlc3VsdC5kaXNjb3ZlcnlLZXkgPSBJRC5kZWNvZGUob3B0cy5kaXNjb3ZlcnlLZXkpCiAgICBlbHNlIGlmIChyZXN1bHQua2V5KSByZXN1bHQuZGlzY292ZXJ5S2V5ID0gY3J5cHRvLmRpc2NvdmVyeUtleShyZXN1bHQua2V5KQogICAgZWxzZSB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBkZXJpdmUgZGlzY292ZXJ5IGZyb20gaW5wdXQnKQoKICAgIHJldHVybiByZXN1bHQKICB9CgogIF9vcGVuQ29yZShkaXNjb3ZlcnlLZXksIG9wdHMpIHsKICAgIGNvbnN0IGF1dGggPSB0aGlzLl9hdXRoKGRpc2NvdmVyeUtleSwgb3B0cykKCiAgICBjb25zdCBpZCA9IHRvSGV4KGF1dGguZGlzY292ZXJ5S2V5KQogICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLmNvcmVzLnJlc3VtZShpZCkKICAgIGlmIChleGlzdGluZyAmJiAhZXhpc3RpbmcuY2xvc2luZykgcmV0dXJuIGV4aXN0aW5nCgogICAgY29uc3QgY29yZSA9IEh5cGVyY29yZS5jcmVhdGVDb3JlKHRoaXMuc3RvcmFnZSwgewogICAgICBwcmVvcGVuOiBleGlzdGluZyAmJiBleGlzdGluZy5vcGVuZWQgPyBleGlzdGluZy5jbG9zaW5nIDogbnVsbCwgLy8gYWx3YXlzIHdhaXQgZm9yIHRoZSBwcmV2IG9uZSB0byBjbG9zZSBmaXJzdCBpbiBhbnkgY2FzZS4uLgogICAgICBlYWdlclVwZ3JhZGU6IHRydWUsCiAgICAgIG5vdERvd25sb2FkaW5nTGluZ2VyOiBvcHRzLm5vdERvd25sb2FkaW5nTGluZ2VyLAogICAgICBhbGxvd0Zvcms6IG9wdHMuYWxsb3dGb3JrICE9PSBmYWxzZSwKICAgICAgaW5mbGlnaHRSYW5nZTogb3B0cy5pbmZsaWdodFJhbmdlLAogICAgICBjb21wYXQ6IGZhbHNlLCAvLyBubyBjb21wYXQgZm9yIG5vdyA6KQogICAgICBmb3JjZTogb3B0cy5mb3JjZSwKICAgICAgY3JlYXRlSWZNaXNzaW5nOiBvcHRzLmNyZWF0ZUlmTWlzc2luZywKICAgICAgZGlzY292ZXJ5S2V5OiBhdXRoLmRpc2NvdmVyeUtleSwKICAgICAgb3ZlcndyaXRlOiBvcHRzLm92ZXJ3cml0ZSwKICAgICAga2V5OiBhdXRoLmtleSwKICAgICAga2V5UGFpcjogYXV0aC5rZXlQYWlyLAogICAgICBsZWdhY3k6IG9wdHMubGVnYWN5LAogICAgICBtYW5pZmVzdDogYXV0aC5tYW5pZmVzdCwKICAgICAgZ2xvYmFsQ2FjaGU6IG9wdHMuZ2xvYmFsQ2FjaGUgfHwgdGhpcy5nbG9iYWxDYWNoZSB8fCBudWxsLAogICAgICBhbGlhczogb3B0cy5uYW1lID8geyBuYW1lOiBvcHRzLm5hbWUsIG5hbWVzcGFjZTogdGhpcy5ucyB9IDogbnVsbAogICAgfSkKCiAgICBjb3JlLm9uaWRsZSA9ICgpID0+IHsKICAgICAgdGhpcy5jb3Jlcy5nYyhjb3JlKQogICAgfQoKICAgIGNvcmUucmVwbGljYXRvci5vbmRvd25sb2FkaW5nID0gKCkgPT4gewogICAgICBpZiAodGhpcy5hY3RpdmUpIHRoaXMuc3RyZWFtVHJhY2tlci5hdHRhY2hBbGwoY29yZSkKICAgIH0KCiAgICB0aGlzLmNvcmVzLnNldChpZCwgY29yZSkKICAgIHJldHVybiBjb3JlCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IENvcmVzdG9yZQoKZnVuY3Rpb24gaXNTdHJlYW0ocykgewogIHJldHVybiB0eXBlb2YgcyA9PT0gJ29iamVjdCcgJiYgcyAmJiB0eXBlb2Ygcy5waXBlID09PSAnZnVuY3Rpb24nCn0KCmZ1bmN0aW9uIGdlbmVyYXRlTmFtZXNwYWNlKG5hbWVzcGFjZSwgbmFtZSkgewogIGlmICghYjRhLmlzQnVmZmVyKG5hbWUpKSBuYW1lID0gYjRhLmZyb20obmFtZSkKICBjb25zdCBvdXQgPSBiNGEuYWxsb2NVbnNhZmVTbG93KDMyKQogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2gob3V0LCBbbmFtZXNwYWNlLCBuYW1lXSkKICByZXR1cm4gb3V0Cn0KCmZ1bmN0aW9uIGRlcml2ZVNlZWQocHJpbWFyeUtleSwgbmFtZXNwYWNlLCBuYW1lKSB7CiAgaWYgKCFiNGEuaXNCdWZmZXIobmFtZSkpIG5hbWUgPSBiNGEuZnJvbShuYW1lKQogIGNvbnN0IG91dCA9IGI0YS5hbGxvYygzMikKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKG91dCwgW05TLCBuYW1lc3BhY2UsIG5hbWVdLCBwcmltYXJ5S2V5KQogIHJldHVybiBvdXQKfQoKZnVuY3Rpb24gY3JlYXRlS2V5UGFpcihwcmltYXJ5S2V5LCBuYW1lc3BhY2UsIG5hbWUpIHsKICBjb25zdCBzZWVkID0gZGVyaXZlU2VlZChwcmltYXJ5S2V5LCBuYW1lc3BhY2UsIG5hbWUpCiAgY29uc3QgYnVmID0gYjRhLmFsbG9jKHNvZGl1bS5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUyArIHNvZGl1bS5jcnlwdG9fc2lnbl9TRUNSRVRLRVlCWVRFUykKICBjb25zdCBrZXlQYWlyID0gewogICAgcHVibGljS2V5OiBidWYuc3ViYXJyYXkoMCwgc29kaXVtLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKSwKICAgIHNlY3JldEtleTogYnVmLnN1YmFycmF5KHNvZGl1bS5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICB9CiAgc29kaXVtLmNyeXB0b19zaWduX3NlZWRfa2V5cGFpcihrZXlQYWlyLnB1YmxpY0tleSwga2V5UGFpci5zZWNyZXRLZXksIHNlZWQpCiAgcmV0dXJuIGtleVBhaXIKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CgpmdW5jdGlvbiB0b0hleChkaXNjb3ZlcnlLZXkpIHsKICByZXR1cm4gYjRhLnRvU3RyaW5nKGRpc2NvdmVyeUtleSwgJ2hleCcpCn0KbW9kdWxlLmV4cG9ydHMgPSBhc3luYyBmdW5jdGlvbiogYXVkaXQoc3RvcmUsIHsgZHJ5UnVuID0gZmFsc2UgfSA9IHt9KSB7CiAgZm9yIGF3YWl0IChjb25zdCB7IGRpc2NvdmVyeUtleSwgY29yZSB9IG9mIHN0b3JlLnN0b3JhZ2UuY3JlYXRlQ29yZVN0cmVhbSgpKSB7CiAgICBpZiAoY29yZS52ZXJzaW9uIDwgMSkgY29udGludWUgLy8gbm90IG1pZ3JhdGVkLCBpZ25vcmUKCiAgICBjb25zdCBjID0gc3RvcmUuZ2V0KHsgZGlzY292ZXJ5S2V5LCBhY3RpdmU6IGZhbHNlIH0pCiAgICBhd2FpdCBjLnJlYWR5KCkKCiAgICB5aWVsZCB7IGRpc2NvdmVyeUtleSwga2V5OiBjLmtleSwgYXVkaXQ6IGF3YWl0IGMuY29yZS5hdWRpdCh7IGRyeVJ1biB9KSB9CgogICAgdHJ5IHsKICAgICAgYXdhaXQgYy5jbG9zZSgpCiAgICB9IGNhdGNoIHsKICAgICAgLy8gaWdub3JlIGlmIGZhaWxlZCwgd2UgYXJlIGF1ZGl0aW5nLi4uCiAgICB9CiAgfQp9CnsKICAibmFtZSI6ICJjb3Jlc3RvcmUiLAogICJ2ZXJzaW9uIjogIjcuNy4wIiwKICAiZGVzY3JpcHRpb24iOiAiQSBIeXBlcmNvcmUgZmFjdG9yeSB0aGF0IHNpbXBsaWZpZXMgbWFuYWdpbmcgY29sbGVjdGlvbnMgb2YgY29yZXMuIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJsaWIvKiIKICBdLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNyIsCiAgICAiaHlwZXJjb3JlIjogIl4xMS4xOS4wIiwKICAgICJoeXBlcmNvcmUtY3J5cHRvIjogIl4zLjQuMiIsCiAgICAiaHlwZXJjb3JlLWVycm9ycyI6ICJeMS40LjAiLAogICAgImh5cGVyY29yZS1pZC1lbmNvZGluZyI6ICJeMS4zLjAiLAogICAgInJlYWR5LXJlc291cmNlIjogIl4xLjEuMSIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjEiLAogICAgIndoaWNoLXJ1bnRpbWUiOiAiXjEuMi4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjcuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIsCiAgICAicmFjaGUiOiAiXjEuMC4wIiwKICAgICJ0ZXN0LXRtcCI6ICJeMS4zLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIiwKICAgICJ0ZXN0IjogInByZXR0aWVyIC0tY2hlY2sgLiAmJiBicml0dGxlIHRlc3QvKi5qcyIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC9iYXNpYy5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2NvcmVzdG9yZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9jb3Jlc3RvcmUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9jb3Jlc3RvcmUiCn0KbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBkZWJvdW5jZSAod29ya2VyLCBjb250ZXh0ID0gbnVsbCkgewogIGRlYm91bmNlZC5ydW5uaW5nID0gbnVsbAogIHJldHVybiBkZWJvdW5jZWQKCiAgYXN5bmMgZnVuY3Rpb24gZGVib3VuY2VkICgpIHsKICAgIGlmIChkZWJvdW5jZWQucnVubmluZyAhPT0gbnVsbCkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IGRlYm91bmNlZC5ydW5uaW5nCiAgICAgIH0gY2F0Y2ggKF8pIHsKICAgICAgICAvLyBpZ25vcmUgLSBkbyBub3QgZmFpbCBvbiBvbGQgZXJyb3JzCiAgICAgIH0KICAgIH0KCiAgICAvLyBhbm90aGVyICJ0aHJlYWQiIGJlYXQgdXMgdG8gaXQsIGp1c3QgcGlnZ3kgcGFjayBvbiB0aGF0IG9uZQogICAgaWYgKGRlYm91bmNlZC5ydW5uaW5nICE9PSBudWxsKSByZXR1cm4gZGVib3VuY2VkLnJ1bm5pbmcKCiAgICBkZWJvdW5jZWQucnVubmluZyA9IHdvcmtlci5jYWxsKGNvbnRleHQpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IGRlYm91bmNlZC5ydW5uaW5nCiAgICB9IGZpbmFsbHkgewogICAgICBkZWJvdW5jZWQucnVubmluZyA9IG51bGwKICAgIH0KICB9Cn0KewogICJuYW1lIjogImRlYm91bmNlaWZ5IiwKICAidmVyc2lvbiI6ICIxLjEuMCIsCiAgImRlc2NyaXB0aW9uIjogIlRpbnkgYXN5bmMgZGVib3VuY2VyIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE2LjAuMyIsCiAgICAidGFwZSI6ICJeNS4xLjEiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvZGVib3VuY2VpZnkuZ2l0IgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiB0YXBlIHRlc3QuanMiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvZGVib3VuY2VpZnkvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvZGVib3VuY2VpZnkiCn0KY29uc3QgZnMgPSByZXF1aXJlKCdmcycpCmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJykKY29uc3QgZnN4ID0gcmVxdWlyZSgnZnMtbmF0aXZlLWV4dGVuc2lvbnMnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBSZWFkeVJlc291cmNlID0gcmVxdWlyZSgncmVhZHktcmVzb3VyY2UnKQpjb25zdCBGRExvY2sgPSByZXF1aXJlKCdmZC1sb2NrJykKCmNvbnN0IFBMQVRGT1JNID0gZ2xvYmFsLkJhcmUgPyBnbG9iYWwuQmFyZS5wbGF0Zm9ybSA6IGdsb2JhbC5wcm9jZXNzLnBsYXRmb3JtCmNvbnN0IElTX1dJTiA9IFBMQVRGT1JNID09PSAnd2luMzInCmNvbnN0IElTX0xJTlVYID0gUExBVEZPUk0gPT09ICdsaW51eCcKY29uc3QgTU9ESUZJRURfU0xBQ0sgPSA1MDAwCmNvbnN0IEVNUFRZID0gYjRhLmFsbG9jKDApCmNvbnN0IEFUVFIgPSBJU19MSU5VWCA/ICd1c2VyLmRldmljZS1maWxlJyA6ICdkZXZpY2UtZmlsZScKCmNvbnN0IG5sID0gSVNfV0lOID8gJ1xyXG4nIDogJ1xuJwoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBEZXZpY2VGaWxlIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IoZmlsZW5hbWUsIHsgY3JlYXRlID0gdHJ1ZSwgd2FpdCA9IGZhbHNlLCBsb2NrID0gd2FpdCwgZGF0YSA9IHt9IH0gPSB7fSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuZmlsZW5hbWUgPSBmaWxlbmFtZQogICAgdGhpcy5kYXRhID0gZGF0YQogICAgdGhpcy5sb2NrID0gbnVsbAoKICAgIHRoaXMuX2NyZWF0ZSA9IGNyZWF0ZQogICAgdGhpcy5fd2FpdCA9IHdhaXQKICAgIHRoaXMuX2xvY2sgPSBsb2NrCiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIGlmIChhd2FpdCB2ZXJpZnlEZXZpY2VGaWxlKHRoaXMpKSByZXR1cm4KICAgIGlmICghdGhpcy5fY3JlYXRlKSB0aHJvdyBuZXcgRXJyb3IoJ05vIGRldmljZSBmaWxlIHByZXNlbnQnKQogICAgYXdhaXQgd3JpdGVEZXZpY2VGaWxlKHRoaXMpCiAgfQoKICB0cmFuc2ZlcigpIHsKICAgIHJldHVybiB0aGlzLmxvY2sgPyB0aGlzLmxvY2sudHJhbnNmZXIoKSA6IC0xCiAgfQoKICBhc3luYyBfY2xvc2UoKSB7CiAgICBpZiAodGhpcy5sb2NrKSBhd2FpdCB0aGlzLmxvY2suY2xvc2UoKQogIH0KCiAgYXN5bmMgc3VzcGVuZCgpIHsKICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKHRoaXMubG9jaykgYXdhaXQgdGhpcy5sb2NrLnN1c3BlbmQoKQogIH0KCiAgYXN5bmMgcmVzdW1lKCkgewogICAgaWYgKCF0aGlzLm9wZW5lZCkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAodGhpcy5sb2NrKSBhd2FpdCB0aGlzLmxvY2sucmVzdW1lKCkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHdyaXRlRGV2aWNlRmlsZShkZXZpY2UpIHsKICBsZXQgcyA9ICcnCgogIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGRldmljZS5kYXRhKSkgewogICAgaWYgKHZhbHVlID09PSBudWxsKSBjb250aW51ZQogICAgcyArPSBrZXkgKyAnPScgKyB2YWx1ZSArIG5sCiAgfQoKICBhd2FpdCBmcy5wcm9taXNlcy5ta2RpcihwYXRoLmRpcm5hbWUoZGV2aWNlLmZpbGVuYW1lKSwgeyByZWN1cnNpdmU6IHRydWUgfSkKCiAgY29uc3QgZmQgPSBhd2FpdCBvcGVuKGRldmljZS5maWxlbmFtZSwgJ3cnKQoKICBkZXZpY2UubG9jayA9IGRldmljZS5fbG9jayA/IG5ldyBGRExvY2soZmQsIHsgd2FpdDogZGV2aWNlLl93YWl0IH0pIDogbnVsbAoKICBpZiAoZGV2aWNlLmxvY2spIHsKICAgIHRyeSB7CiAgICAgIGF3YWl0IGRldmljZS5sb2NrLnJlYWR5KCkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBhd2FpdCBkZXZpY2UubG9jay5jbG9zZSgpCiAgICAgIHRocm93IGVycgogICAgfQogIH0KCiAgY29uc3Qgc3QgPSBhd2FpdCBmc3RhdChmZCkKCiAgY29uc3QgY3JlYXRlZCA9IERhdGUubm93KCkKCiAgcyArPSAnZGV2aWNlL3BsYXRmb3JtPScgKyBQTEFURk9STSArIG5sCiAgcyArPSAnZGV2aWNlL2lub2RlPScgKyBzdC5pbm8gKyBubAogIHMgKz0gJ2RldmljZS9jcmVhdGVkPScgKyBjcmVhdGVkICsgbmwKCiAgaWYgKGF3YWl0IHNldEF0dHIoZmQsIEFUVFIsIGI0YS5mcm9tKCdvcmlnaW5hbCcpKSkgewogICAgcyArPSAnZGV2aWNlL2F0dHJpYnV0ZT1vcmlnaW5hbCcgKyBubAogIH0KCiAgYXdhaXQgd3JpdGUoZmQsIGI0YS5mcm9tKHMpKQoKICBpZiAoIWRldmljZS5sb2NrKSBhd2FpdCBjbG9zZShmZCkKfQoKYXN5bmMgZnVuY3Rpb24gdmVyaWZ5RGV2aWNlRmlsZShkZXZpY2UpIHsKICBsZXQgZmQgPSAwCgogIHRyeSB7CiAgICBmZCA9IGF3YWl0IG9wZW4oZGV2aWNlLmZpbGVuYW1lLCAncisnKQogIH0gY2F0Y2ggKGUpIHsKICAgIGZkID0gMAogIH0KCiAgaWYgKGZkID09PSAwKSByZXR1cm4gZmFsc2UKCiAgZGV2aWNlLmxvY2sgPSBkZXZpY2UuX2xvY2sgPyBuZXcgRkRMb2NrKGZkLCB7IHdhaXQ6IGRldmljZS5fd2FpdCB9KSA6IG51bGwKCiAgaWYgKGRldmljZS5sb2NrKSB7CiAgICB0cnkgewogICAgICBhd2FpdCBkZXZpY2UubG9jay5yZWFkeSgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgYXdhaXQgZGV2aWNlLmxvY2suY2xvc2UoKQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIGNvbnN0IGJ1ZiA9IGF3YWl0IHJlYWQoZmQpCiAgY29uc3QgcmVzdWx0ID0ge30KCiAgY29uc3QgcyA9IGI0YS50b1N0cmluZyhidWYpLnRyaW0oKS5zcGxpdCgnXG4nKQoKICBsZXQgaW5vZGUgPSAwCiAgbGV0IGNyZWF0ZWQgPSAwCiAgbGV0IGF0dHIgPSAnJwogIGxldCBwbGF0Zm9ybSA9ICcnCgogIGZvciAoY29uc3QgbG4gb2YgcykgewogICAgY29uc3QgaSA9IGxuLmluZGV4T2YoJz0nKQogICAgaWYgKGkgPT09IC0xKSBjb250aW51ZQoKICAgIGNvbnN0IGsgPSBsbi5zbGljZSgwLCBpKS50cmltKCkKICAgIGNvbnN0IHYgPSBsbi5zbGljZShpICsgMSkudHJpbSgpCgogICAgc3dpdGNoIChrKSB7CiAgICAgIGNhc2UgJ2RldmljZS9wbGF0Zm9ybSc6CiAgICAgICAgcGxhdGZvcm0gPSB2CiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAnZGV2aWNlL2lub2RlJzoKICAgICAgICBpbm9kZSA9IE51bWJlcih2KQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ2RldmljZS9jcmVhdGVkJzoKICAgICAgICBjcmVhdGVkID0gTnVtYmVyKHYpCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAnZGV2aWNlL2F0dHJpYnV0ZSc6CiAgICAgICAgYXR0ciA9IHYKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHJlc3VsdFtrXSA9IHYKICAgICAgICBicmVhawogICAgfQogIH0KCiAgZm9yIChjb25zdCBbaywgdl0gb2YgT2JqZWN0LmVudHJpZXMoZGV2aWNlLmRhdGEpKSB7CiAgICBpZiAodiA9PT0gbnVsbCkgY29udGludWUKICAgIGlmIChyZXN1bHRba10gPT09IHVuZGVmaW5lZCkgY29udGludWUgLy8gYWxsb3cgdXBzZXJ0cwogICAgaWYgKHJlc3VsdFtrXSAhPT0gJycgKyB2KSB7CiAgICAgIGF3YWl0IHRlYXJkb3duKCkKICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGRldmljZSBmaWxlLCAnICsgayArICcgaGFzIGNoYW5nZWQuIFdhcyAnICsgcmVzdWx0W2tdICsgJywgaXMgJyArIHYpCiAgICB9CiAgfQoKICBjb25zdCBzdCA9IGF3YWl0IGZzdGF0KGZkKQogIGNvbnN0IGF0ID0gYXdhaXQgZ2V0QXR0cihmZCwgQVRUUikKCiAgY29uc3Qgc2FtZUF0dHIgPSBiNGEudG9TdHJpbmcoYXQgfHwgRU1QVFkpID09PSBhdHRyCiAgY29uc3QgbW9kaWZpZWQgPSBNYXRoLm1heChzdC5tdGltZS5nZXRUaW1lKCksIHN0LmJpcnRodGltZS5nZXRUaW1lKCkpCgogIGlmIChwbGF0Zm9ybSAmJiBwbGF0Zm9ybSAhPT0gUExBVEZPUk0pIHsKICAgIGF3YWl0IHRlYXJkb3duKCkKICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBkZXZpY2UgZmlsZSwgd2FzIG1hZGUgb24gZGlmZmVyZW50IHBsYXRmb3JtJykKICB9CgogIGlmICghc2FtZUF0dHIpIHsKICAgIGF3YWl0IHRlYXJkb3duKCkKICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBkZXZpY2UgZmlsZSwgd2FzIG1vdmVkIHVuc2FmZWx5JykKICB9CgogIGlmIChzdC5pbm8gIT09IGlub2RlIHx8IChjcmVhdGVkICYmIE1hdGguYWJzKG1vZGlmaWVkIC0gY3JlYXRlZCkgPj0gTU9ESUZJRURfU0xBQ0spKSB7CiAgICBhd2FpdCB0ZWFyZG93bigpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZGV2aWNlIGZpbGUsIHdhcyBtb2RpZmllZCcpCiAgfQoKICBpZiAoIWRldmljZS5sb2NrKSBhd2FpdCBjbG9zZShmZCkKCiAgZGV2aWNlLmRhdGEgPSByZXN1bHQKICByZXR1cm4gdHJ1ZQoKICBhc3luYyBmdW5jdGlvbiB0ZWFyZG93biAoKSB7CiAgICBpZiAoZGV2aWNlLmxvY2spIGF3YWl0IGRldmljZS5sb2NrLmNsb3NlKCkKICAgIGVsc2UgYXdhaXQgY2xvc2UoZmQpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBnZXRBdHRyKGZkLCBuYW1lKSB7CiAgdHJ5IHsKICAgIHJldHVybiBhd2FpdCBmc3guZ2V0QXR0cihmZCwgbmFtZSkKICB9IGNhdGNoIHsKICAgIHJldHVybiBudWxsCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBzZXRBdHRyKGZkLCBuYW1lLCB2YWx1ZSkgewogIHRyeSB7CiAgICBhd2FpdCBmc3guc2V0QXR0cihmZCwgbmFtZSwgdmFsdWUpCiAgICByZXR1cm4gdHJ1ZQogIH0gY2F0Y2ggewogICAgcmV0dXJuIGZhbHNlCiAgfQp9CgpmdW5jdGlvbiBmc3RhdChmZCkgewogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBmcy5mc3RhdChmZCwgKGVyciwgc3QpID0+IHsKICAgICAgaWYgKGVycikgcmVqZWN0KGVycikKICAgICAgcmVzb2x2ZShzdCkKICAgIH0pCiAgfSkKfQoKZnVuY3Rpb24gY2xvc2UoZmQpIHsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgZnMuY2xvc2UoZmQsIChlcnIsIHN0KSA9PiB7CiAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpCiAgICAgIHJlc29sdmUoc3QpCiAgICB9KQogIH0pCn0KCmZ1bmN0aW9uIHdyaXRlKGZkLCBidWYpIHsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgbGV0IG9mZnNldCA9IDAKCiAgICBvbndyaXRlKG51bGwsIDApCgogICAgZnVuY3Rpb24gb253cml0ZShlcnIsIHdyb3RlKSB7CiAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3QoZXJyKQogICAgICBpZiAob2Zmc2V0ID09PSBidWYuYnl0ZUxlbmd0aCkgcmV0dXJuIHJlc29sdmUoKQogICAgICBvZmZzZXQgKz0gd3JvdGUKICAgICAgZnMud3JpdGUoZmQsIGJ1Ziwgb2Zmc2V0LCBidWYuYnl0ZUxlbmd0aCAtIG9mZnNldCwgb2Zmc2V0LCBvbndyaXRlKQogICAgfQogIH0pCn0KCmZ1bmN0aW9uIHJlYWQoZmQpIHsKICBjb25zdCBidWYgPSBiNGEuYWxsb2NVbnNhZmUoNDA5NikKCiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIGxldCBvZmZzZXQgPSAwCgogICAgZnMucmVhZChmZCwgYnVmLCAwLCBidWYuYnl0ZUxlbmd0aCwgMCwgb25yZWFkKQoKICAgIGZ1bmN0aW9uIG9ucmVhZChlcnIsIHJlYWQpIHsKICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdChlcnIpCiAgICAgIGlmIChyZWFkID09PSAwKSByZXR1cm4gcmVzb2x2ZShidWYuc3ViYXJyYXkoMCwgb2Zmc2V0KSkKICAgICAgb2Zmc2V0ICs9IHJlYWQKICAgICAgZnMucmVhZChmZCwgYnVmLCBvZmZzZXQsIGJ1Zi5ieXRlTGVuZ3RoIC0gb2Zmc2V0LCBvZmZzZXQsIG9ucmVhZCkKICAgIH0KICB9KQp9CgpmdW5jdGlvbiBvcGVuKGZpbGVuYW1lLCBmbGFncykgewogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBmcy5vcGVuKGZpbGVuYW1lLCBmbGFncywgKGVyciwgZmQpID0+IHsKICAgICAgaWYgKGVycikgcmVqZWN0KGVycikKICAgICAgcmVzb2x2ZShmZCkKICAgIH0pCiAgfSkKfQp7CiAgIm5hbWUiOiAiZGV2aWNlLWZpbGUiLAogICJ2ZXJzaW9uIjogIjIuMS4zIiwKICAiZGVzY3JpcHRpb24iOiAiRGV2aWNlIG9ubHkgZmlsZSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNyIsCiAgICAiYmFyZS1mcyI6ICJeNC4wLjEiLAogICAgImJhcmUtcGF0aCI6ICJeMy4wLjAiLAogICAgImZkLWxvY2siOiAiXjIuMS4wIiwKICAgICJmcy1uYXRpdmUtZXh0ZW5zaW9ucyI6ICJeMS40LjAiLAogICAgInJlYWR5LXJlc291cmNlIjogIl4xLjIuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4xMy4xIiwKICAgICJsdW50ZSI6ICJeMS4wLjIiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIiwKICAgICJsaW50IjogInByZXR0aWVyIC0tY2hlY2sgLiAmJiBsdW50ZSIsCiAgICAidGVzdCI6ICJicml0dGxlIHRlc3QuanMiCiAgfSwKICAiaW1wb3J0cyI6IHsKICAgICJmcyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1mcyIsCiAgICAgICJkZWZhdWx0IjogImZzIgogICAgfSwKICAgICJwYXRoIjogewogICAgICAiYmFyZSI6ICJiYXJlLXBhdGgiLAogICAgICAiZGVmYXVsdCI6ICJwYXRoIgogICAgfQogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vZGV2aWNlLWZpbGUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2ggSW5jIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2RldmljZS1maWxlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vZGV2aWNlLWZpbGUiCn0KY29uc3QgeyBFdmVudEVtaXR0ZXIgfSA9IHJlcXVpcmUoJ2V2ZW50cycpCmNvbnN0IFRhYmxlID0gcmVxdWlyZSgna2FkZW1saWEtcm91dGluZy10YWJsZScpCmNvbnN0IFRPUyA9IHJlcXVpcmUoJ3RpbWUtb3JkZXJlZC1zZXQnKQpjb25zdCBVRFggPSByZXF1aXJlKCd1ZHgtbmF0aXZlJykKY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgTmF0U2FtcGxlciA9IHJlcXVpcmUoJ25hdC1zYW1wbGVyJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgSU8gPSByZXF1aXJlKCcuL2xpYi9pbycpCmNvbnN0IFF1ZXJ5ID0gcmVxdWlyZSgnLi9saWIvcXVlcnknKQpjb25zdCBTZXNzaW9uID0gcmVxdWlyZSgnLi9saWIvc2Vzc2lvbicpCmNvbnN0IHBlZXIgPSByZXF1aXJlKCcuL2xpYi9wZWVyJykKY29uc3QgeyBVTktOT1dOX0NPTU1BTkQsIElOVkFMSURfVE9LRU4gfSA9IHJlcXVpcmUoJy4vbGliL2Vycm9ycycpCmNvbnN0IHsgUElORywgUElOR19OQVQsIEZJTkRfTk9ERSwgRE9XTl9ISU5UIH0gPSByZXF1aXJlKCcuL2xpYi9jb21tYW5kcycpCgpjb25zdCBUTVAgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCmNvbnN0IFRJQ0tfSU5URVJWQUwgPSA1MDAwCmNvbnN0IFNMRUVQSU5HX0lOVEVSVkFMID0gMyAqIFRJQ0tfSU5URVJWQUwKY29uc3QgU1RBQkxFX1RJQ0tTID0gMjQwIC8vIGlmIG5vdGhpbmcgbWFqb3IgYmFkIGhhcHBlbnMgaW4gfjIwbWlucyB3ZSBjYW4gY29uc2lkZXIgdGhpcyBub2RlIHN0YWJsZSAoaWYgbmF0IGlzIGZyaWVuZGx5KQpjb25zdCBNT1JFX1NUQUJMRV9USUNLUyA9IDMgKiBTVEFCTEVfVElDS1MKY29uc3QgUkVGUkVTSF9USUNLUyA9IDYwIC8vIHJlZnJlc2ggZXZlcnkgfjVtaW4gd2hlbiBpZGxlCmNvbnN0IFJFQ0VOVF9OT0RFID0gMTIgLy8gd2UndmUgaGVhcmQgZnJvbSBhIG5vZGUgbGVzcyB0aGFuIDFtaW4gYWdvCmNvbnN0IE9MRF9OT0RFID0gMzYwIC8vIGlmIGFuIG5vZGUgaGFzIGJlZW4gYXJvdW5kIG1vcmUgdGhhbiAzMCBtaW4gd2UgY29uc2lkZXIgaXQgb2xkCgpjbGFzcyBESFQgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuYm9vdHN0cmFwTm9kZXMgPSBvcHRzLmJvb3RzdHJhcCA9PT0gZmFsc2UgPyBbXSA6IChvcHRzLmJvb3RzdHJhcCB8fCBbXSkubWFwKHBhcnNlTm9kZSkKICAgIHRoaXMudGFibGUgPSBuZXcgVGFibGUocmFuZG9tQnl0ZXMoMzIpKQogICAgdGhpcy5ub2RlcyA9IG5ldyBUT1MoKQogICAgdGhpcy51ZHggPSBvcHRzLnVkeCB8fCBuZXcgVURYKCkKICAgIHRoaXMuaW8gPSBuZXcgSU8odGhpcy50YWJsZSwgdGhpcy51ZHgsIHsKICAgICAgLi4ub3B0cywKICAgICAgb25yZXF1ZXN0OiB0aGlzLl9vbnJlcXVlc3QuYmluZCh0aGlzKSwKICAgICAgb25yZXNwb25zZTogdGhpcy5fb25yZXNwb25zZS5iaW5kKHRoaXMpLAogICAgICBvbnRpbWVvdXQ6IHRoaXMuX29udGltZW91dC5iaW5kKHRoaXMpCiAgICB9KQoKICAgIHRoaXMuY29uY3VycmVuY3kgPSBvcHRzLmNvbmN1cnJlbmN5IHx8IDEwCiAgICB0aGlzLmJvb3RzdHJhcHBlZCA9IGZhbHNlCiAgICB0aGlzLmVwaGVtZXJhbCA9IHRydWUKICAgIHRoaXMuZmlyZXdhbGxlZCA9IHRoaXMuaW8uZmlyZXdhbGxlZAogICAgdGhpcy5hZGFwdGl2ZSA9IHR5cGVvZiBvcHRzLmVwaGVtZXJhbCAhPT0gJ2Jvb2xlYW4nICYmIG9wdHMuYWRhcHRpdmUgIT09IGZhbHNlCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCiAgICB0aGlzLm9ubGluZSA9IHRydWUKICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgIHF1ZXJpZXM6IHsgYWN0aXZlOiAwLCB0b3RhbDogMCB9LAogICAgICByZXF1ZXN0czogdGhpcy5pby5zdGF0cy5yZXF1ZXN0cywKICAgICAgY29tbWFuZHM6IHsKICAgICAgICBwaW5nOiB0aGlzLmlvLnN0YXRzLmNvbW1hbmRzW1BJTkddLAogICAgICAgIHBpbmdOYXQ6IHRoaXMuaW8uc3RhdHMuY29tbWFuZHNbUElOR19OQVRdLAogICAgICAgIGZpbmROb2RlOiB0aGlzLmlvLnN0YXRzLmNvbW1hbmRzW0ZJTkRfTk9ERV0sCiAgICAgICAgZG93bkhpbnQ6IHRoaXMuaW8uc3RhdHMuY29tbWFuZHNbRE9XTl9ISU5UXQogICAgICB9CiAgICB9CgogICAgdGhpcy5fbmF0ID0gbmV3IE5hdFNhbXBsZXIoKQogICAgdGhpcy5fcXVpY2tGaXJld2FsbCA9IG9wdHMucXVpY2tGaXJld2FsbCAhPT0gZmFsc2UKICAgIHRoaXMuX2ZvcmNlUGVyc2lzdGVudCA9IG9wdHMuZXBoZW1lcmFsID09PSBmYWxzZQogICAgdGhpcy5fcmVwaW5naW5nID0gMAogICAgdGhpcy5fY2hlY2tzID0gMAogICAgdGhpcy5fdGljayA9IHJhbmRvbU9mZnNldCgxMDApIC8vIG1ha2Ugc3VyZSB0byByYW5kb20gb2Zmc2V0IGFsbCB0aGUgbmV0d29yayB0aWNrcwogICAgdGhpcy5fcmVmcmVzaFRpY2tzID0gcmFuZG9tT2Zmc2V0KFJFRlJFU0hfVElDS1MpCiAgICB0aGlzLl9zdGFibGVUaWNrcyA9IHRoaXMuYWRhcHRpdmUgPyBTVEFCTEVfVElDS1MgOiAwCiAgICB0aGlzLl90aWNrSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLl9vbnRpY2suYmluZCh0aGlzKSwgVElDS19JTlRFUlZBTCkKICAgIHRoaXMuX2xhc3RUaWNrID0gRGF0ZS5ub3coKQogICAgdGhpcy5fbGFzdEhvc3QgPSBudWxsCiAgICB0aGlzLl9maWx0ZXJOb2RlID0gb3B0cy5maWx0ZXJOb2RlIHx8IG9wdHMuYWRkTm9kZSB8fCBudWxsIC8vIG9wdHMuYWRkTm9kZSBpcyBkZXByZWNhdGluZywgdXNlIG9wdHMuZmlsdGVyTm9kZSBpbnN0ZWFkCiAgICB0aGlzLl9vbnJvdyA9IChyb3cpID0+IHJvdy5vbignZnVsbCcsIChub2RlKSA9PiB0aGlzLl9vbmZ1bGxyb3cobm9kZSwgcm93KSkKICAgIHRoaXMuX25vbmVQZXJzaXN0ZW50U2FtcGxlcyA9IFtdCiAgICB0aGlzLl9ib290c3RyYXBwaW5nID0gdGhpcy5fYm9vdHN0cmFwKCkKICAgIHRoaXMuX2Jvb3RzdHJhcHBpbmcuY2F0Y2gobm9vcCkKCiAgICB0aGlzLnRhYmxlLm9uKCdyb3cnLCB0aGlzLl9vbnJvdykKCiAgICB0aGlzLmlvLm5ldHdvcmtJbnRlcmZhY2VzLm9uKCdjaGFuZ2UnLCAoaW50ZXJmYWNlcykgPT4gdGhpcy5fb25uZXR3b3JrY2hhbmdlKGludGVyZmFjZXMpKQoKICAgIGlmIChvcHRzLm5vZGVzKSB7CiAgICAgIGZvciAobGV0IGkgPSBvcHRzLm5vZGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgdGhpcy5hZGROb2RlKG9wdHMubm9kZXNbaV0pCiAgICAgIH0KICAgIH0KICB9CgogIHN0YXRpYyBib290c3RyYXBwZXIocG9ydCwgaG9zdCwgb3B0cykgewogICAgaWYgKCFwb3J0KSB0aHJvdyBuZXcgRXJyb3IoJ1BvcnQgaXMgcmVxdWlyZWQnKQogICAgaWYgKCFob3N0KSB0aHJvdyBuZXcgRXJyb3IoJ0hvc3QgaXMgcmVxdWlyZWQnKQogICAgaWYgKGhvc3QgPT09ICcwLjAuMC4wJyB8fCBob3N0ID09PSAnOjonKSB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgaG9zdCcpCiAgICBpZiAoIVVEWC5pc0lQdjQoaG9zdCkpIHRocm93IG5ldyBFcnJvcignSG9zdCBtdXN0IGJlIGEgSVB2NCBhZGRyZXNzJykKCiAgICBjb25zdCBkaHQgPSBuZXcgdGhpcyh7CiAgICAgIHBvcnQsCiAgICAgIGVwaGVtZXJhbDogZmFsc2UsCiAgICAgIGZpcmV3YWxsZWQ6IGZhbHNlLAogICAgICBhbnlQb3J0OiBmYWxzZSwKICAgICAgYm9vdHN0cmFwOiBbXSwKICAgICAgLi4ub3B0cwogICAgfSkKICAgIGRodC5fbmF0LmFkZChob3N0LCBwb3J0KQogICAgcmV0dXJuIGRodAogIH0KCiAgZ2V0IGlkKCkgewogICAgcmV0dXJuIHRoaXMuZXBoZW1lcmFsID8gbnVsbCA6IHRoaXMudGFibGUuaWQKICB9CgogIGdldCBob3N0KCkgewogICAgcmV0dXJuIHRoaXMuX25hdC5ob3N0CiAgfQoKICBnZXQgcG9ydCgpIHsKICAgIHJldHVybiB0aGlzLl9uYXQucG9ydAogIH0KCiAgZ2V0IHJhbmRvbWl6ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5fbmF0Lmhvc3QgIT09IG51bGwgJiYgdGhpcy5fbmF0LnBvcnQgPT09IDAKICB9CgogIGdldCBzb2NrZXQoKSB7CiAgICByZXR1cm4gdGhpcy5maXJld2FsbGVkID8gdGhpcy5pby5jbGllbnRTb2NrZXQgOiB0aGlzLmlvLnNlcnZlclNvY2tldAogIH0KCiAgb25tZXNzYWdlKHNvY2tldCwgYnVmLCByaW5mbykgewogICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoID4gMSkgdGhpcy5pby5vbm1lc3NhZ2Uoc29ja2V0LCBidWYsIHJpbmZvKQogIH0KCiAgYmluZCgpIHsKICAgIHJldHVybiB0aGlzLmlvLmJpbmQoKQogIH0KCiAgYXN5bmMgc3VzcGVuZCh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICBsb2coJ1N1c3BlbmRpbmcgd2FpdGluZyBmb3IgaW8gYmluZC4uLicpCiAgICBhd2FpdCB0aGlzLmlvLmJpbmQoKQogICAgbG9nKCdEb25lLCBjb250aW51aW5nJykKICAgIGlmICh0aGlzLnN1c3BlbmRlZCB8fCB0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLnN1c3BlbmRlZCA9IHRydWUKICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fdGlja0ludGVydmFsKQogICAgbG9nKCdEb25lLCBzdXNwZW5kaW5nIGlvJykKICAgIGF3YWl0IHRoaXMuaW8uc3VzcGVuZCh7IGxvZyB9KQogICAgbG9nKCdEb25lLCBkaHQgc3VzcGVuZGVkJykKICAgIHRoaXMuZW1pdCgnc3VzcGVuZCcpCiAgfQoKICBhc3luYyByZXN1bWUoeyBsb2cgPSBub29wIH0gPSB7fSkgewogICAgaWYgKCF0aGlzLnN1c3BlbmRlZCB8fCB0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCiAgICB0aGlzLl90aWNrSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLl9vbnRpY2suYmluZCh0aGlzKSwgVElDS19JTlRFUlZBTCkKICAgIHRoaXMuX29ud2FrZXVwKCkKICAgIGxvZygnUmVzdW1pbmcgaW8nKQogICAgYXdhaXQgdGhpcy5pby5yZXN1bWUoKQogICAgbG9nKCdEb25lLCBkaHQgcmVzdW1lZCcpCiAgICB0aGlzLmlvLm5ldHdvcmtJbnRlcmZhY2VzLm9uKCdjaGFuZ2UnLCAoaW50ZXJmYWNlcykgPT4gdGhpcy5fb25uZXR3b3JrY2hhbmdlKGludGVyZmFjZXMpKQogICAgdGhpcy5yZWZyZXNoKCkKICAgIHRoaXMuZW1pdCgncmVzdW1lJykKICB9CgogIGFkZHJlc3MoKSB7CiAgICBjb25zdCBzb2NrZXQgPSB0aGlzLnNvY2tldAogICAgcmV0dXJuIHNvY2tldCA/IHNvY2tldC5hZGRyZXNzKCkgOiBudWxsCiAgfQoKICBsb2NhbEFkZHJlc3MoKSB7CiAgICBpZiAoIXRoaXMuaW8uc2VydmVyU29ja2V0KSByZXR1cm4gbnVsbAoKICAgIHJldHVybiB7CiAgICAgIGhvc3Q6IGxvY2FsSVAodGhpcy51ZHgpLAogICAgICBwb3J0OiB0aGlzLmlvLnNlcnZlclNvY2tldC5hZGRyZXNzKCkucG9ydAogICAgfQogIH0KCiAgcmVtb3RlQWRkcmVzcygpIHsKICAgIGlmICghdGhpcy5ob3N0KSByZXR1cm4gbnVsbAogICAgaWYgKCF0aGlzLnBvcnQpIHJldHVybiBudWxsCiAgICBpZiAodGhpcy5maXJld2FsbGVkKSByZXR1cm4gbnVsbAogICAgaWYgKCF0aGlzLmlvLnNlcnZlclNvY2tldCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBwb3J0ID0gdGhpcy5pby5zZXJ2ZXJTb2NrZXQuYWRkcmVzcygpLnBvcnQKICAgIGlmIChwb3J0ICE9PSB0aGlzLnBvcnQpIHJldHVybiBudWxsCgogICAgcmV0dXJuIHsKICAgICAgaG9zdDogdGhpcy5ob3N0LAogICAgICBwb3J0CiAgICB9CiAgfQoKICBhZGROb2RlKHsgaG9zdCwgcG9ydCB9KSB7CiAgICB0aGlzLl9hZGROb2RlKHsKICAgICAgaWQ6IHBlZXIuaWQoaG9zdCwgcG9ydCksCiAgICAgIHBvcnQsCiAgICAgIGhvc3QsCiAgICAgIHRva2VuOiBudWxsLAogICAgICB0bzogbnVsbCwKICAgICAgc2FtcGxlZDogMCwKICAgICAgYWRkZWQ6IHRoaXMuX3RpY2ssCiAgICAgIHBpbmdlZDogMCwKICAgICAgc2VlbjogMCwKICAgICAgZG93bkhpbnRzOiAwLAogICAgICBwcmV2OiBudWxsLAogICAgICBuZXh0OiBudWxsCiAgICB9KQogIH0KCiAgdG9BcnJheShvcHRzKSB7CiAgICBjb25zdCBsaW1pdCA9IG9wdHMgJiYgb3B0cy5saW1pdAogICAgaWYgKGxpbWl0ID09PSAwKSByZXR1cm4gW10KICAgIHJldHVybiB0aGlzLm5vZGVzLnRvQXJyYXkoeyBsaW1pdCwgcmV2ZXJzZTogdHJ1ZSB9KS5tYXAoKHsgaG9zdCwgcG9ydCB9KSA9PiAoeyBob3N0LCBwb3J0IH0pKQogIH0KCiAgYXN5bmMgZnVsbHlCb290c3RyYXBwZWQoKSB7CiAgICByZXR1cm4gdGhpcy5fYm9vdHN0cmFwcGluZwogIH0KCiAgcmVhZHkoKSB7CiAgICAvLyBEZXByZWNhdGluZywgdXNlIGZ1bGx5Qm9vdHN0cmFwcGVkIGluc3RlYWQgKHJlbW92ZWQgb24gbmV4dCBtYWpvcikKICAgIHJldHVybiB0aGlzLmZ1bGx5Qm9vdHN0cmFwcGVkKCkKICB9CgogIGZpbmROb2RlKHRhcmdldCwgb3B0cykgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSB0aHJvdyBuZXcgRXJyb3IoJ05vZGUgZGVzdHJveWVkJykKICAgIHRoaXMuX3JlZnJlc2hUaWNrcyA9IFJFRlJFU0hfVElDS1MKICAgIHJldHVybiBuZXcgUXVlcnkodGhpcywgdGFyZ2V0LCB0cnVlLCBGSU5EX05PREUsIG51bGwsIG9wdHMpCiAgfQoKICBxdWVyeSh7IHRhcmdldCwgY29tbWFuZCwgdmFsdWUgfSwgb3B0cykgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSB0aHJvdyBuZXcgRXJyb3IoJ05vZGUgZGVzdHJveWVkJykKICAgIHRoaXMuX3JlZnJlc2hUaWNrcyA9IFJFRlJFU0hfVElDS1MKICAgIHJldHVybiBuZXcgUXVlcnkodGhpcywgdGFyZ2V0LCBmYWxzZSwgY29tbWFuZCwgdmFsdWUgfHwgbnVsbCwgb3B0cykKICB9CgogIHBpbmcoeyBob3N0LCBwb3J0IH0sIG9wdHMpIHsKICAgIGxldCB2YWx1ZSA9IG51bGwKCiAgICBpZiAob3B0cyAmJiBvcHRzLnNpemUgJiYgb3B0cy5zaXplID4gMCkgdmFsdWUgPSBiNGEuYWxsb2Mob3B0cy5zaXplKQoKICAgIGNvbnN0IHJlcSA9IHRoaXMuaW8uY3JlYXRlUmVxdWVzdCgKICAgICAgeyBpZDogbnVsbCwgaG9zdCwgcG9ydCB9LAogICAgICBudWxsLAogICAgICB0cnVlLAogICAgICBQSU5HLAogICAgICBudWxsLAogICAgICB2YWx1ZSwKICAgICAgKG9wdHMgJiYgb3B0cy5zZXNzaW9uKSB8fCBudWxsLAogICAgICBvcHRzICYmIG9wdHMudHRsCiAgICApCiAgICByZXR1cm4gdGhpcy5fcmVxdWVzdFRvUHJvbWlzZShyZXEsIG9wdHMpCiAgfQoKICByZXF1ZXN0KHsgdG9rZW4gPSBudWxsLCBjb21tYW5kLCB0YXJnZXQgPSBudWxsLCB2YWx1ZSA9IG51bGwgfSwgeyBob3N0LCBwb3J0IH0sIG9wdHMpIHsKICAgIGNvbnN0IHJlcSA9IHRoaXMuaW8uY3JlYXRlUmVxdWVzdCgKICAgICAgeyBpZDogbnVsbCwgaG9zdCwgcG9ydCB9LAogICAgICB0b2tlbiwKICAgICAgZmFsc2UsCiAgICAgIGNvbW1hbmQsCiAgICAgIHRhcmdldCwKICAgICAgdmFsdWUsCiAgICAgIChvcHRzICYmIG9wdHMuc2Vzc2lvbikgfHwgbnVsbCwKICAgICAgb3B0cyAmJiBvcHRzLnR0bAogICAgKQogICAgcmV0dXJuIHRoaXMuX3JlcXVlc3RUb1Byb21pc2UocmVxLCBvcHRzKQogIH0KCiAgc2Vzc2lvbigpIHsKICAgIHJldHVybiBuZXcgU2Vzc2lvbih0aGlzKQogIH0KCiAgX3JlcXVlc3RUb1Byb21pc2UocmVxLCBvcHRzKSB7CiAgICBpZiAocmVxID09PSBudWxsKSByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdOb2RlIGRlc3Ryb3llZCcpKQoKICAgIGlmIChvcHRzICYmIG9wdHMuc29ja2V0KSByZXEuc29ja2V0ID0gb3B0cy5zb2NrZXQKICAgIGlmIChvcHRzICYmIG9wdHMucmV0cnkgPT09IGZhbHNlKSByZXEucmV0cmllcyA9IDAKCiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICByZXEub25yZXNwb25zZSA9IHJlc29sdmUKICAgICAgcmVxLm9uZXJyb3IgPSByZWplY3QKICAgICAgcmVxLnNlbmQoKQogICAgfSkKICB9CgogIGFzeW5jIF9ib290c3RyYXAoKSB7CiAgICBjb25zdCBzZWxmID0gdGhpcwoKICAgIGF3YWl0IFByb21pc2UucmVzb2x2ZSgpIC8vIHdhaXQgYSB0aWNrLCBzbyBhcGlzIGNhbiBiZSB1c2VkIGZyb20gdGhlIG91dHNpZGUKICAgIGF3YWl0IHRoaXMuaW8uYmluZCgpCgogICAgdGhpcy5lbWl0KCdsaXN0ZW5pbmcnKQoKICAgIC8vIFRPRE86IHNvbWUgcGFwZXJzIGRlc2NyaWJlIG1vcmUgYWR2YW5jZWQgd2F5cyBvZiBib290c3RyYXBwaW5nIC0gd2Ugc2hvdWxkIHByb2IgbG9vayBpbnRvIHRoYXQKCiAgICBsZXQgZmlyc3QgPSB0aGlzLmZpcmV3YWxsZWQgJiYgdGhpcy5fcXVpY2tGaXJld2FsbCAmJiAhdGhpcy5fZm9yY2VQZXJzaXN0ZW50CiAgICBsZXQgdGVzdE5hdCA9IGZhbHNlCgogICAgY29uc3Qgb25seUZpcmV3YWxsID0gIXRoaXMuX2ZvcmNlUGVyc2lzdGVudAoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMjsgaSsrKSB7CiAgICAgIGF3YWl0IHRoaXMuX2JhY2tncm91bmRRdWVyeSh0aGlzLnRhYmxlLmlkKS5vbignZGF0YScsIG9uZGF0YSkuZmluaXNoZWQoKQoKICAgICAgaWYgKHRoaXMuYm9vdHN0cmFwcGVkIHx8ICghdGVzdE5hdCAmJiAhdGhpcy5fZm9yY2VQZXJzaXN0ZW50KSkgYnJlYWsKICAgICAgaWYgKCEoYXdhaXQgdGhpcy5fdXBkYXRlTmV0d29ya1N0YXRlKG9ubHlGaXJld2FsbCkpKSBicmVhawogICAgfQoKICAgIGlmICh0aGlzLmJvb3RzdHJhcHBlZCkgcmV0dXJuCiAgICB0aGlzLmJvb3RzdHJhcHBlZCA9IHRydWUKCiAgICB0aGlzLmVtaXQoJ3JlYWR5JykKCiAgICBmdW5jdGlvbiBvbmRhdGEoZGF0YSkgewogICAgICAvLyBTaW1wbGUgUVVJQ0sgbmF0IGhldXJpc3RpYy4KICAgICAgLy8gSWYgd2UgZ2V0IE9ORSBwb3NpdGl2ZSBuYXQgcGluZyBiZWZvcmUgdGhlIGJvb3RzdHJhcCBxdWVyeSBmaW5pc2hlcwogICAgICAvLyB0aGVuIHdlIGFsd2F5cyB0byBhIG5hdCB0ZXN0LCBubyBtYXR0ZXIgaWYgd2UgYXJlIGFkYXB0aXZlLi4uCiAgICAgIC8vIFRoaXMgc2hvdWxkIGJlIGV4cGFuZGVkIGluIHRoZSBmdXR1cmUgdG8gdHJ5IG1vcmUgdGhhbiBvbmUgbm9kZSBldGMsIG5vdCBhbHdheXMgaGl0IHRoZSBmaXJzdCBldGMKICAgICAgLy8gSWYgdGhpcyBmYWlscywgdGhlbiBuYmQsIGFzIHRoZSBvbnN0YWJsZSBob29rIHdpbGwgcGljayBpdCB1cCBsYXRlci4KCiAgICAgIGlmICghZmlyc3QpIHJldHVybgogICAgICBmaXJzdCA9IGZhbHNlCgogICAgICBjb25zdCB2YWx1ZSA9IGI0YS5hbGxvY1Vuc2FmZSgyKQogICAgICBjLnVpbnQxNi5lbmNvZGUoeyBzdGFydDogMCwgZW5kOiAyLCBidWZmZXI6IHZhbHVlIH0sIHNlbGYuaW8uc2VydmVyU29ja2V0LmFkZHJlc3MoKS5wb3J0KQoKICAgICAgc2VsZi5fcmVxdWVzdCgKICAgICAgICBkYXRhLmZyb20sCiAgICAgICAgZmFsc2UsCiAgICAgICAgdHJ1ZSwKICAgICAgICBQSU5HX05BVCwKICAgICAgICBudWxsLAogICAgICAgIHZhbHVlLAogICAgICAgIG51bGwsCiAgICAgICAgKCkgPT4gewogICAgICAgICAgdGVzdE5hdCA9IHRydWUKICAgICAgICB9LAogICAgICAgIG5vb3AKICAgICAgKQogICAgfQogIH0KCiAgcmVmcmVzaCgpIHsKICAgIGNvbnN0IG5vZGUgPSB0aGlzLnRhYmxlLnJhbmRvbSgpCiAgICB0aGlzLl9iYWNrZ3JvdW5kUXVlcnkobm9kZSA/IG5vZGUuaWQgOiB0aGlzLnRhYmxlLmlkKS5vbignZXJyb3InLCBub29wKQogIH0KCiAgYXN5bmMgZGVzdHJveSgpIHsKICAgIGNvbnN0IGVtaXRDbG9zZSA9ICF0aGlzLmRlc3Ryb3llZAogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCiAgICBjbGVhckludGVydmFsKHRoaXMuX3RpY2tJbnRlcnZhbCkKICAgIGF3YWl0IHRoaXMuaW8uZGVzdHJveSgpCiAgICBpZiAoZW1pdENsb3NlKSB0aGlzLmVtaXQoJ2Nsb3NlJykKICB9CgogIF9yZXF1ZXN0KHRvLCBmb3JjZSwgaW50ZXJuYWwsIGNvbW1hbmQsIHRhcmdldCwgdmFsdWUsIHNlc3Npb24sIG9ucmVzcG9uc2UsIG9uZXJyb3IpIHsKICAgIGNvbnN0IHJlcSA9IHRoaXMuaW8uY3JlYXRlUmVxdWVzdCh0bywgbnVsbCwgaW50ZXJuYWwsIGNvbW1hbmQsIHRhcmdldCwgdmFsdWUsIHNlc3Npb24pCiAgICBpZiAocmVxID09PSBudWxsKSByZXR1cm4gbnVsbAoKICAgIHJlcS5vbnJlc3BvbnNlID0gb25yZXNwb25zZQogICAgcmVxLm9uZXJyb3IgPSBvbmVycm9yCiAgICByZXEuc2VuZChmb3JjZSkKCiAgICByZXR1cm4gcmVxCiAgfQoKICBfbmF0QWRkKGhvc3QsIHBvcnQpIHsKICAgIGNvbnN0IHByZXZIb3N0ID0gdGhpcy5fbmF0Lmhvc3QKICAgIGNvbnN0IHByZXZQb3J0ID0gdGhpcy5fbmF0LnBvcnQKCiAgICB0aGlzLl9uYXQuYWRkKGhvc3QsIHBvcnQpCgogICAgaWYgKHByZXZIb3N0ID09PSB0aGlzLl9uYXQuaG9zdCAmJiBwcmV2UG9ydCA9PT0gdGhpcy5fbmF0LnBvcnQpIHJldHVybgoKICAgIHRoaXMuZW1pdCgnbmF0LXVwZGF0ZScsIHRoaXMuX25hdC5ob3N0LCB0aGlzLl9uYXQucG9ydCkKICB9CgogIC8vIHdlIGRvbid0IGNoZWNrIHRoYXQgdGhpcyBpcyBhIGJvb3RzdHJhcCBub2RlIGJ1dCB3ZSBsaW1pdCB0aGUgc2FtcGxlIHNpemUgdG8gdmVyeSBmZXcgbm9kZXMsIHNvIGZpbmUKICBfc2FtcGxlQm9vdHN0cmFwTWF5YmUoZnJvbSwgdG8pIHsKICAgIGlmICh0aGlzLl9ub25lUGVyc2lzdGVudFNhbXBsZXMubGVuZ3RoID49IE1hdGgubWF4KDEsIHRoaXMuYm9vdHN0cmFwTm9kZXMubGVuZ3RoKSkgcmV0dXJuCiAgICBjb25zdCBpZCA9IGZyb20uaG9zdCArICc6JyArIGZyb20ucG9ydAogICAgaWYgKHRoaXMuX25vbmVQZXJzaXN0ZW50U2FtcGxlcy5pbmRleE9mKGlkKSA+IC0xKSByZXR1cm4KICAgIHRoaXMuX25vbmVQZXJzaXN0ZW50U2FtcGxlcy5wdXNoKGlkKQogICAgdGhpcy5fbmF0QWRkKHRvLmhvc3QsIHRvLnBvcnQpCiAgfQoKICBfYWRkTm9kZUZyb21OZXR3b3JrKHNhbXBsZSwgZnJvbSwgdG8pIHsKICAgIGlmICh0aGlzLl9maWx0ZXJOb2RlICE9PSBudWxsICYmICF0aGlzLl9maWx0ZXJOb2RlKGZyb20pKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChmcm9tLmlkID09PSBudWxsKSB7CiAgICAgIHRoaXMuX3NhbXBsZUJvb3RzdHJhcE1heWJlKGZyb20sIHRvKQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBvbGROb2RlID0gdGhpcy50YWJsZS5nZXQoZnJvbS5pZCkKCiAgICAvLyByZWZyZXNoIGl0LCBpZiB3ZSd2ZSBzZWVuIHRoaXMgYmVmb3JlCiAgICBpZiAob2xkTm9kZSkgewogICAgICBpZiAoc2FtcGxlICYmIChvbGROb2RlLnNhbXBsZWQgPT09IDAgfHwgdGhpcy5fdGljayAtIG9sZE5vZGUuc2FtcGxlZCA+PSBPTERfTk9ERSkpIHsKICAgICAgICBvbGROb2RlLnRvID0gdG8KICAgICAgICBvbGROb2RlLnNhbXBsZWQgPSB0aGlzLl90aWNrCiAgICAgICAgdGhpcy5fbmF0QWRkKHRvLmhvc3QsIHRvLnBvcnQpCiAgICAgIH0KCiAgICAgIG9sZE5vZGUucGluZ2VkID0gb2xkTm9kZS5zZWVuID0gdGhpcy5fdGljawogICAgICB0aGlzLm5vZGVzLmFkZChvbGROb2RlKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLl9hZGROb2RlKHsKICAgICAgaWQ6IGZyb20uaWQsCiAgICAgIHBvcnQ6IGZyb20ucG9ydCwKICAgICAgaG9zdDogZnJvbS5ob3N0LAogICAgICB0bywKICAgICAgc2FtcGxlZDogMCwKICAgICAgYWRkZWQ6IHRoaXMuX3RpY2ssCiAgICAgIHBpbmdlZDogdGhpcy5fdGljaywgLy8gbGFzdCB0aW1lIHdlIGludGVyYWN0ZWQgd2l0aCB0aGVtCiAgICAgIHNlZW46IHRoaXMuX3RpY2ssIC8vIGxhc3QgdGltZSB3ZSBoZWFyZCBmcm9tIHRoZW0KICAgICAgZG93bkhpbnRzOiAwLAogICAgICBwcmV2OiBudWxsLAogICAgICBuZXh0OiBudWxsCiAgICB9KQogIH0KCiAgX2FkZE5vZGUobm9kZSkgewogICAgaWYgKHRoaXMubm9kZXMuaGFzKG5vZGUpIHx8IGI0YS5lcXVhbHMobm9kZS5pZCwgdGhpcy50YWJsZS5pZCkpIHJldHVybgoKICAgIG5vZGUuYWRkZWQgPSBub2RlLnBpbmdlZCA9IG5vZGUuc2VlbiA9IHRoaXMuX3RpY2sKCiAgICBpZiAoIXRoaXMudGFibGUuYWRkKG5vZGUpKSByZXR1cm4KICAgIHRoaXMubm9kZXMuYWRkKG5vZGUpCgogICAgaWYgKG5vZGUudG8gJiYgbm9kZS5zYW1wbGVkID09PSAwKSB7CiAgICAgIG5vZGUuc2FtcGxlZCA9IHRoaXMuX3RpY2sKICAgICAgdGhpcy5fbmF0QWRkKG5vZGUudG8uaG9zdCwgbm9kZS50by5wb3J0KQogICAgfQoKICAgIHRoaXMuZW1pdCgnYWRkLW5vZGUnLCBub2RlKQogIH0KCiAgX3JlbW92ZVN0YWxlTm9kZShub2RlLCBsYXN0U2VlbikgewogICAgaWYgKG5vZGUuc2VlbiA8PSBsYXN0U2VlbikgdGhpcy5fcmVtb3ZlTm9kZShub2RlKQogIH0KCiAgX3JlbW92ZU5vZGUobm9kZSkgewogICAgaWYgKCF0aGlzLm5vZGVzLmhhcyhub2RlKSkgcmV0dXJuCgogICAgdGhpcy50YWJsZS5yZW1vdmUobm9kZS5pZCkKICAgIHRoaXMubm9kZXMucmVtb3ZlKG5vZGUpCgogICAgdGhpcy5lbWl0KCdyZW1vdmUtbm9kZScsIG5vZGUpCiAgfQoKICBfb253YWtldXAoKSB7CiAgICB0aGlzLl90aWNrICs9IDIgKiBPTERfTk9ERSAvLyBidW1wIHRoZSB0aWNrIGVub3VnaCB0aGF0IGV2ZXJ5dGhpbmcgYXBwZWFycyBvbGQuCiAgICB0aGlzLl90aWNrICs9IDggLSAodGhpcy5fdGljayAmIDcpIC0gMiAvLyB0cmlnZ2VycyBhIHNlcmllcyBvZiBwaW5ncyBpbiB0d28gdGlja3MKICAgIHRoaXMuX3N0YWJsZVRpY2tzID0gTU9SRV9TVEFCTEVfVElDS1MKICAgIHRoaXMuX3JlZnJlc2hUaWNrcyA9IDEgLy8gdHJpZ2dlcnMgYSByZWZyZXNoIG5leHQgdGljayAoYWxsb3cgbmV0d29yayB0aW1lIHRvIHdha2UgdXAgYWxzbykKICAgIHRoaXMuX2xhc3RIb3N0ID0gbnVsbCAvLyBjbGVhciBuZXR3b3JrIGNhY2hlIGNoZWNrCgogICAgaWYgKHRoaXMuYWRhcHRpdmUpIHsKICAgICAgLy8gVE9ETzogcmUtZW5hYmxlIHRoaXMgYXMgc29vbiBhcyB3ZSBmaW5kIG91dCB3aHkgdGhpcyBpcyBvdmVyIHRyaWdnZXJpbmcgaW4gc29tZSBlZGdlIGNhc2VzCiAgICAgIC8vIHRoaXMuZmlyZXdhbGxlZCA9IHRydWUKICAgICAgLy8gdGhpcy5pby5maXJld2FsbGVkID0gdHJ1ZQoKICAgICAgaWYgKCF0aGlzLmVwaGVtZXJhbCkgewogICAgICAgIHRoaXMuZXBoZW1lcmFsID0gdHJ1ZQogICAgICAgIHRoaXMuaW8uZXBoZW1lcmFsID0gdHJ1ZQogICAgICAgIHRoaXMuZW1pdCgnZXBoZW1lcmFsJykKICAgICAgfQogICAgfQoKICAgIHRoaXMuZW1pdCgnd2FrZXVwJykKICB9CgogIF9vbmZ1bGxyb3cobmV3Tm9kZSwgcm93KSB7CiAgICBpZiAoIXRoaXMuYm9vdHN0cmFwcGVkIHx8IHRoaXMuX3JlcGluZ2luZyA+PSAzKSByZXR1cm4KCiAgICBsZXQgb2xkZXN0ID0gbnVsbAogICAgZm9yIChjb25zdCBub2RlIG9mIHJvdy5ub2RlcykgewogICAgICBpZiAobm9kZS5waW5nZWQgPT09IHRoaXMuX3RpY2spIGNvbnRpbnVlCiAgICAgIGlmICgKICAgICAgICBvbGRlc3QgPT09IG51bGwgfHwKICAgICAgICBvbGRlc3QucGluZ2VkID4gbm9kZS5waW5nZWQgfHwKICAgICAgICAob2xkZXN0LnBpbmdlZCA9PT0gbm9kZS5waW5nZWQgJiYgb2xkZXN0LmFkZGVkID4gbm9kZS5hZGRlZCkKICAgICAgKSB7CiAgICAgICAgb2xkZXN0ID0gbm9kZQogICAgICB9CiAgICB9CgogICAgaWYgKG9sZGVzdCA9PT0gbnVsbCkgcmV0dXJuCiAgICBpZiAodGhpcy5fdGljayAtIG9sZGVzdC5waW5nZWQgPCBSRUNFTlRfTk9ERSAmJiB0aGlzLl90aWNrIC0gb2xkZXN0LmFkZGVkID4gT0xEX05PREUpIHJldHVybgoKICAgIHRoaXMuX3JlcGluZ0FuZFN3YXAobmV3Tm9kZSwgb2xkZXN0KQogIH0KCiAgX29ubmV0d29ya2NoYW5nZShpbnRlcmZhY2VzKSB7CiAgICB0aGlzLmVtaXQoJ25ldHdvcmstY2hhbmdlJywgaW50ZXJmYWNlcykKICAgIHRoaXMuZW1pdCgnbmV0d29yay11cGRhdGUnKQogIH0KCiAgX3JlcGluZ0FuZFN3YXAobmV3Tm9kZSwgb2xkTm9kZSkgewogICAgY29uc3Qgc2VsZiA9IHRoaXMKICAgIGNvbnN0IGxhc3RTZWVuID0gb2xkTm9kZS5zZWVuCgogICAgb2xkTm9kZS5waW5nZWQgPSB0aGlzLl90aWNrCgogICAgdGhpcy5fcmVwaW5naW5nKysKICAgIHRoaXMuX3JlcXVlc3QoCiAgICAgIHsgaWQ6IG51bGwsIGhvc3Q6IG9sZE5vZGUuaG9zdCwgcG9ydDogb2xkTm9kZS5wb3J0IH0sCiAgICAgIGZhbHNlLAogICAgICB0cnVlLAogICAgICBQSU5HLAogICAgICBudWxsLAogICAgICBudWxsLAogICAgICBudWxsLAogICAgICBvbnN1Y2Nlc3MsCiAgICAgIG9uc3dhcAogICAgKQoKICAgIGZ1bmN0aW9uIG9uc3VjY2VzcyhtKSB7CiAgICAgIGlmIChvbGROb2RlLnNlZW4gPD0gbGFzdFNlZW4pIHJldHVybiBvbnN3YXAoKQogICAgICBzZWxmLl9yZXBpbmdpbmctLQogICAgfQoKICAgIGZ1bmN0aW9uIG9uc3dhcChlKSB7CiAgICAgIHNlbGYuX3JlcGluZ2luZy0tCiAgICAgIHNlbGYuX3JlbW92ZU5vZGUob2xkTm9kZSkKICAgICAgc2VsZi5fYWRkTm9kZShuZXdOb2RlKQogICAgfQogIH0KCiAgX29ucmVxdWVzdChyZXEsIGV4dGVybmFsKSB7CiAgICBpZiAocmVxLmZyb20uaWQgIT09IG51bGwpIHsKICAgICAgdGhpcy5fYWRkTm9kZUZyb21OZXR3b3JrKCFleHRlcm5hbCwgcmVxLmZyb20sIHJlcS50bykKICAgIH0KCiAgICBpZiAocmVxLmludGVybmFsKSB7CiAgICAgIHN3aXRjaCAocmVxLmNvbW1hbmQpIHsKICAgICAgICAvLyBzdGFuZGFyZCBrZWVwIGFsaXZlIGNhbGwKICAgICAgICBjYXNlIFBJTkc6IHsKICAgICAgICAgIHJlcS5zZW5kUmVwbHkoMCwgbnVsbCwgZmFsc2UsIGZhbHNlKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIC8vIGNoZWNrIGlmIHRoZSBvdGhlciBzaWRlIGNhbiByZWNlaXZlIGEgbWVzc2FnZSB0byB0aGVpciBvdGhlciBzb2NrZXQKICAgICAgICBjYXNlIFBJTkdfTkFUOiB7CiAgICAgICAgICBpZiAocmVxLnZhbHVlID09PSBudWxsIHx8IHJlcS52YWx1ZS5ieXRlTGVuZ3RoIDwgMikgcmV0dXJuCiAgICAgICAgICBjb25zdCBwb3J0ID0gYy51aW50MTYuZGVjb2RlKHsgc3RhcnQ6IDAsIGVuZDogMiwgYnVmZmVyOiByZXEudmFsdWUgfSkKICAgICAgICAgIGlmIChwb3J0ID09PSAwKSByZXR1cm4KICAgICAgICAgIHJlcS5mcm9tLnBvcnQgPSBwb3J0CiAgICAgICAgICByZXEuc2VuZFJlcGx5KDAsIG51bGwsIGZhbHNlLCBmYWxzZSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICAvLyBlbXB0eSBkaHQgcmVwbHkgYmFjawogICAgICAgIGNhc2UgRklORF9OT0RFOiB7CiAgICAgICAgICBpZiAoIXJlcS50YXJnZXQpIHJldHVybgogICAgICAgICAgcmVxLnNlbmRSZXBseSgwLCBudWxsLCBmYWxzZSwgdHJ1ZSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICAvLyAidGhpcyBpcyBub2RlIHlvdSBzZW50IG1lIGlzIGRvd24iIC0gbGV0J3MgdHJ5IHRvIHBpbmcgaXQKICAgICAgICBjYXNlIERPV05fSElOVDogewogICAgICAgICAgaWYgKHJlcS52YWx1ZSA9PT0gbnVsbCB8fCByZXEudmFsdWUuYnl0ZUxlbmd0aCA8IDYpIHJldHVybgogICAgICAgICAgaWYgKHRoaXMuX2NoZWNrcyA8IDEwKSB7CiAgICAgICAgICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goVE1QLCByZXEudmFsdWUuc3ViYXJyYXkoMCwgNikpCiAgICAgICAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLnRhYmxlLmdldChUTVApCiAgICAgICAgICAgIGlmIChub2RlICYmIChub2RlLnBpbmdlZCA8IHRoaXMuX3RpY2sgfHwgbm9kZS5kb3duSGludHMgPT09IDApKSB7CiAgICAgICAgICAgICAgbm9kZS5kb3duSGludHMrKwogICAgICAgICAgICAgIHRoaXMuX2NoZWNrKG5vZGUpCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlcS5zZW5kUmVwbHkoMCwgbnVsbCwgZmFsc2UsIGZhbHNlKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICB9CgogICAgICByZXEuc2VuZFJlcGx5KFVOS05PV05fQ09NTUFORCwgbnVsbCwgZmFsc2UsIHJlcS50YXJnZXQgIT09IG51bGwpCiAgICAgIHJldHVybgogICAgfQoKICAgIC8vIGFzayB0aGUgdXNlciB0byBoYW5kbGUgaXQgb3IgcmVwbHkgYmFjayB3aXRoIGEgYmFkIGNvbW1hbmQKICAgIGlmICh0aGlzLm9ucmVxdWVzdChyZXEpID09PSBmYWxzZSkgewogICAgICByZXEuc2VuZFJlcGx5KFVOS05PV05fQ09NTUFORCwgbnVsbCwgZmFsc2UsIHJlcS50YXJnZXQgIT09IG51bGwpCiAgICB9CiAgfQoKICBvbnJlcXVlc3QocmVxKSB7CiAgICByZXR1cm4gdGhpcy5lbWl0KCdyZXF1ZXN0JywgcmVxKQogIH0KCiAgX29ucmVzcG9uc2UocmVzLCBleHRlcm5hbCkgewogICAgdGhpcy5fYWRkTm9kZUZyb21OZXR3b3JrKCFleHRlcm5hbCwgcmVzLmZyb20sIHJlcy50bykKICB9CgogIF9vbnRpbWVvdXQocmVxKSB7CiAgICBpZiAoIXJlcS50by5pZCkgcmV0dXJuCiAgICBjb25zdCBub2RlID0gdGhpcy50YWJsZS5nZXQocmVxLnRvLmlkKQogICAgaWYgKG5vZGUpIHRoaXMuX3JlbW92ZU5vZGUobm9kZSkKICB9CgogIF9waW5nU29tZSgpIHsKICAgIGxldCBjbnQgPSB0aGlzLmlvLmluZmxpZ2h0Lmxlbmd0aCA+IDIgPyAzIDogNQogICAgbGV0IG9sZGVzdCA9IHRoaXMubm9kZXMub2xkZXN0CgogICAgLy8gdGlueSBkaHQsIHBpbmdlZCB0aGUgYm9vdHN0cmFwIGFnYWluCiAgICBpZiAoIW9sZGVzdCkgewogICAgICB0aGlzLnJlZnJlc2goKQogICAgICByZXR1cm4KICAgIH0KCiAgICAvLyB3ZSd2ZSByZWNlbnRseSBwaW5nZWQgdGhlIG9sZGVzdCBvbmUsIHNvIG9ubHkgdHJpZ2dlciBhIGNvdXBsZSBvZiByZXBpbmdzCiAgICBpZiAodGhpcy5fdGljayAtIG9sZGVzdC5waW5nZWQgPCBSRUNFTlRfTk9ERSkgewogICAgICBjbnQgPSAyCiAgICB9CgogICAgd2hpbGUgKGNudC0tKSB7CiAgICAgIGlmICghb2xkZXN0IHx8IHRoaXMuX3RpY2sgPT09IG9sZGVzdC5waW5nZWQpIGNvbnRpbnVlCiAgICAgIHRoaXMuX2NoZWNrKG9sZGVzdCkKICAgICAgb2xkZXN0ID0gb2xkZXN0Lm5leHQKICAgIH0KICB9CgogIF9jaGVjayhub2RlKSB7CiAgICBub2RlLnBpbmdlZCA9IHRoaXMuX3RpY2sKCiAgICBjb25zdCBsYXN0U2VlbiA9IG5vZGUuc2VlbgogICAgY29uc3Qgb25yZXNwb25zZSA9ICgpID0+IHsKICAgICAgdGhpcy5fY2hlY2tzLS0KICAgICAgdGhpcy5fcmVtb3ZlU3RhbGVOb2RlKG5vZGUsIGxhc3RTZWVuKQogICAgfQogICAgY29uc3Qgb25lcnJvciA9ICgpID0+IHsKICAgICAgdGhpcy5fY2hlY2tzLS0KICAgICAgdGhpcy5fcmVtb3ZlTm9kZShub2RlKQogICAgfQoKICAgIHRoaXMuX2NoZWNrcysrCiAgICB0aGlzLl9yZXF1ZXN0KAogICAgICB7IGlkOiBudWxsLCBob3N0OiBub2RlLmhvc3QsIHBvcnQ6IG5vZGUucG9ydCB9LAogICAgICBmYWxzZSwKICAgICAgdHJ1ZSwKICAgICAgUElORywKICAgICAgbnVsbCwKICAgICAgbnVsbCwKICAgICAgbnVsbCwKICAgICAgb25yZXNwb25zZSwKICAgICAgb25lcnJvcgogICAgKQogIH0KCiAgX29udGljaygpIHsKICAgIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpCgogICAgaWYgKHRpbWUgLSB0aGlzLl9sYXN0VGljayA+IFNMRUVQSU5HX0lOVEVSVkFMICYmIHRoaXMuc3VzcGVuZGVkID09PSBmYWxzZSkgewogICAgICB0aGlzLl9vbndha2V1cCgpCiAgICB9IGVsc2UgewogICAgICB0aGlzLl90aWNrKysKICAgIH0KCiAgICB0aGlzLl9sYXN0VGljayA9IHRpbWUKCiAgICBpZiAoIXRoaXMuYm9vdHN0cmFwcGVkIHx8IHRoaXMuc3VzcGVuZGVkKSByZXR1cm4KCiAgICBpZiAodGhpcy5hZGFwdGl2ZSAmJiB0aGlzLmVwaGVtZXJhbCAmJiAtLXRoaXMuX3N0YWJsZVRpY2tzIDw9IDApIHsKICAgICAgaWYgKHRoaXMuX2xhc3RIb3N0ID09PSB0aGlzLl9uYXQuaG9zdCkgewogICAgICAgIC8vIGRvIG5vdCByZWNoZWNrIHRoZSBzYW1lIG5ldHdvcmsuLi4KICAgICAgICB0aGlzLl9zdGFibGVUaWNrcyA9IE1PUkVfU1RBQkxFX1RJQ0tTCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fdXBkYXRlTmV0d29ya1N0YXRlKCkgLy8gdGhlIHByb21pc2UgcmV0dXJuZWQgaGVyZSBuZXZlciBmYWlscyBzbyBqdXN0IGlnbm9yZSBpdAogICAgICB9CiAgICB9CgogICAgaWYgKCh0aGlzLl90aWNrICYgNykgPT09IDApIHsKICAgICAgdGhpcy5fcGluZ1NvbWUoKQogICAgfQoKICAgIGlmICgKICAgICAgKCh0aGlzLl90aWNrICYgNjMpID09PSAwICYmIHRoaXMubm9kZXMubGVuZ3RoIDwgdGhpcy50YWJsZS5rKSB8fAogICAgICAtLXRoaXMuX3JlZnJlc2hUaWNrcyA8PSAwCiAgICApIHsKICAgICAgdGhpcy5yZWZyZXNoKCkKICAgIH0KICB9CgogIGFzeW5jIF91cGRhdGVOZXR3b3JrU3RhdGUob25seUZpcmV3YWxsID0gZmFsc2UpIHsKICAgIGlmICghdGhpcy5lcGhlbWVyYWwpIHJldHVybiBmYWxzZQogICAgaWYgKG9ubHlGaXJld2FsbCAmJiAhdGhpcy5maXJld2FsbGVkKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCB7IGhvc3QsIHBvcnQgfSA9IHRoaXMuX25hdAoKICAgIGlmICghb25seUZpcmV3YWxsKSB7CiAgICAgIC8vIHJlbWVtYmVyIHdoYXQgaG9zdCB3ZSBjaGVja2VkIGFuZCByZXNldCB0aGUgY291bnRlcgogICAgICB0aGlzLl9zdGFibGVUaWNrcyA9IE1PUkVfU1RBQkxFX1RJQ0tTCiAgICAgIHRoaXMuX2xhc3RIb3N0ID0gaG9zdAogICAgfQoKICAgIC8vIGNoZWNrIGlmIHdlIGhhdmUgYSBjb25zaXN0ZW50IGhvc3QgYW5kIHBvcnQKICAgIGlmIChob3N0ID09PSBudWxsIHx8IHBvcnQgPT09IDApIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc3QgbmF0U2FtcGxlciA9IHRoaXMuZmlyZXdhbGxlZCA/IG5ldyBOYXRTYW1wbGVyKCkgOiB0aGlzLl9uYXQKCiAgICAvLyBhc2sgcmVtb3RlIG5vZGVzIHRvIHBpbmcgdXMgb24gb3VyIHNlcnZlciBzb2NrZXQgdG8gc2VlIGlmIHdlIGhhdmUgdGhlIHBvcnQgb3BlbgogICAgY29uc3QgZmlyZXdhbGxlZCA9IHRoaXMuZmlyZXdhbGxlZCAmJiAoYXdhaXQgdGhpcy5fY2hlY2tJZkZpcmV3YWxsZWQobmF0U2FtcGxlcikpCiAgICBpZiAoZmlyZXdhbGxlZCkgcmV0dXJuIGZhbHNlCgogICAgdGhpcy5maXJld2FsbGVkID0gdGhpcy5pby5maXJld2FsbGVkID0gZmFsc2UKCiAgICAvLyBpbmNhc2UgaXQncyBjYWxsZWQgaW4gcGFyYWxsZWwgZm9yIHNvbWUgcmVhc29uLCBvciBpZiBvdXIgbmF0IHN0YXR1cyBzb21laG93IGNoYW5nZWQKICAgIGlmICghdGhpcy5lcGhlbWVyYWwgfHwgaG9zdCAhPT0gdGhpcy5fbmF0Lmhvc3QgfHwgcG9ydCAhPT0gdGhpcy5fbmF0LnBvcnQpIHJldHVybiBmYWxzZQogICAgLy8gaWYgdGhlIGZpcmV3YWxsIHByb2JlIHJldHVybmVkIGEgZGlmZmVyZW50IGhvc3QgLyBub24gY29uc2lzdGVudCBwb3J0LCBiYWlsIGFzIHdlbGwKICAgIGlmIChuYXRTYW1wbGVyLmhvc3QgIT09IGhvc3QgfHwgbmF0U2FtcGxlci5wb3J0ID09PSAwKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBpZCA9IHBlZXIuaWQobmF0U2FtcGxlci5ob3N0LCBuYXRTYW1wbGVyLnBvcnQpCgogICAgaWYgKCFvbmx5RmlyZXdhbGwpIHsKICAgICAgdGhpcy5lcGhlbWVyYWwgPSB0aGlzLmlvLmVwaGVtZXJhbCA9IGZhbHNlCiAgICB9CgogICAgaWYgKG5hdFNhbXBsZXIgIT09IHRoaXMuX25hdCkgewogICAgICBjb25zdCBwcmV2SG9zdCA9IHRoaXMuX25hdC5ob3N0CiAgICAgIGNvbnN0IHByZXZQb3J0ID0gdGhpcy5fbmF0LnBvcnQKCiAgICAgIHRoaXMuX25vbmVQZXJzaXN0ZW50U2FtcGxlcyA9IFtdCiAgICAgIHRoaXMuX25hdCA9IG5hdFNhbXBsZXIKCiAgICAgIGlmIChwcmV2SG9zdCAhPT0gdGhpcy5fbmF0Lmhvc3QgfHwgcHJldlBvcnQgIT09IHRoaXMuX25hdC5wb3J0KSB7CiAgICAgICAgdGhpcy5lbWl0KCduYXQtdXBkYXRlJywgdGhpcy5fbmF0Lmhvc3QsIHRoaXMuX25hdC5wb3J0KQogICAgICB9CiAgICB9CgogICAgLy8gVE9ETzogd2Ugc2hvdWxkIG1ha2UgdGhpcyBhIGJpdCBtb3JlIGRlZmVuc2l2ZSBpbiB0ZXJtcyBvZiB1c2luZyBtb3JlCiAgICAvLyByZXNvdXJjZXMgdG8gbWFrZSBzdXJlIHRoYXQgdGhlIG5ldyByb3V0aW5nIHRhYmxlIGNvbnRhaW5zIGFzIG1hbnkgYWxpdmUgbm9kZXMKICAgIC8vIGFzIHBvc3NpYmxlLCB2cyBibGluZGx5IGNvcHlpbmcgdGhlbSBvdmVyLi4uCgogICAgLy8gYWxsIGdvb2QhIGNvcHkgb3ZlciB0aGUgb2xkIHJvdXRpbmcgdGFibGUgdG8gdGhlIG5ldyBvbmUKICAgIGlmICghYjRhLmVxdWFscyh0aGlzLnRhYmxlLmlkLCBpZCkpIHsKICAgICAgY29uc3Qgbm9kZXMgPSB0aGlzLnRhYmxlLnRvQXJyYXkoKQoKICAgICAgdGhpcy50YWJsZSA9IHRoaXMuaW8udGFibGUgPSBuZXcgVGFibGUoaWQpCgogICAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIHsKICAgICAgICBpZiAoYjRhLmVxdWFscyhub2RlLmlkLCBpZCkpIGNvbnRpbnVlCiAgICAgICAgaWYgKCF0aGlzLnRhYmxlLmFkZChub2RlKSkgdGhpcy5ub2Rlcy5yZW1vdmUobm9kZSkKICAgICAgfQoKICAgICAgdGhpcy50YWJsZS5vbigncm93JywgdGhpcy5fb25yb3cpCgogICAgICAvLyB3ZSBuZWVkIHRvIHJlYm9vdHN0cmFwL3JlZnJlc2ggc2luY2Ugd2UgdXBkYXRlZCBvdXIgaWQKICAgICAgaWYgKHRoaXMuYm9vdHN0cmFwcGVkKSB0aGlzLnJlZnJlc2goKQogICAgfQoKICAgIGlmICghdGhpcy5lcGhlbWVyYWwpIHsKICAgICAgdGhpcy5lbWl0KCdwZXJzaXN0ZW50JykKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgKl9yZXNvbHZlQm9vdHN0cmFwTm9kZXMoKSB7CiAgICBmb3IgKGxldCB7IGhvc3QsIHBvcnQgfSBvZiB0aGlzLmJvb3RzdHJhcE5vZGVzKSB7CiAgICAgIGxldCBkb0xvb2t1cCA9IGZhbHNlCgogICAgICBpZiAoaG9zdC5pbmRleE9mKCdAJykgPT09IC0xKSB7CiAgICAgICAgZG9Mb29rdXAgPSB0cnVlCiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgW3N1Z2dlc3RlZElQLCBmYWxsYmFja0hvc3RdID0gaG9zdC5zcGxpdCgnQCcpCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF3YWl0IHRoaXMucGluZyh7IGhvc3Q6IHN1Z2dlc3RlZElQLCBwb3J0IH0pCiAgICAgICAgICBob3N0ID0gc3VnZ2VzdGVkSVAKICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgIGhvc3QgPSBmYWxsYmFja0hvc3QKICAgICAgICAgIGRvTG9va3VwID0gdHJ1ZQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGRvTG9va3VwKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGhvc3QgPSBVRFguaXNJUHY0KGhvc3QpID8gaG9zdCA6IChhd2FpdCB0aGlzLnVkeC5sb29rdXAoaG9zdCwgeyBmYW1pbHk6IDQgfSkpLmhvc3QKICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogICAgICB9CgogICAgICB5aWVsZCB7CiAgICAgICAgaWQ6IHBlZXIuaWQoaG9zdCwgcG9ydCksCiAgICAgICAgaG9zdCwKICAgICAgICBwb3J0CiAgICAgIH0KICAgIH0KICB9CgogIGFzeW5jIF9hZGRCb290c3RyYXBOb2Rlcyhub2RlcykgewogICAgZm9yIGF3YWl0IChjb25zdCBub2RlIG9mIHRoaXMuX3Jlc29sdmVCb290c3RyYXBOb2RlcygpKSB7CiAgICAgIG5vZGVzLnB1c2gobm9kZSkKICAgIH0KICB9CgogIGFzeW5jIF9jaGVja0lmRmlyZXdhbGxlZChuYXRTYW1wbGVyID0gbmV3IE5hdFNhbXBsZXIoKSkgewogICAgY29uc3Qgbm9kZXMgPSBbXQogICAgZm9yIChsZXQgbm9kZSA9IHRoaXMubm9kZXMubGF0ZXN0OyBub2RlICYmIG5vZGVzLmxlbmd0aCA8IDU7IG5vZGUgPSBub2RlLnByZXYpIHsKICAgICAgbm9kZXMucHVzaChub2RlKQogICAgfQoKICAgIGlmIChub2Rlcy5sZW5ndGggPCA1KSBhd2FpdCB0aGlzLl9hZGRCb290c3RyYXBOb2Rlcyhub2RlcykKICAgIC8vIGlmIG5vIG5vZGVzIGFyZSBhdmFpbGFibGUsIGluY2x1ZGluZyBib290c3RyYXBwZXJzIC0gYmFpbAogICAgaWYgKG5vZGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHRydWUKCiAgICBjb25zdCBob3N0cyA9IG5ldyBTZXQoKQogICAgY29uc3QgdmFsdWUgPSBiNGEuYWxsb2NVbnNhZmUoMikKCiAgICBjLnVpbnQxNi5lbmNvZGUoeyBzdGFydDogMCwgZW5kOiAyLCBidWZmZXI6IHZhbHVlIH0sIHRoaXMuaW8uc2VydmVyU29ja2V0LmFkZHJlc3MoKS5wb3J0KQoKICAgIC8vIGRvdWJsZSBjaGVjayB0aGV5IGFjdHVhbGx5IGNhbWUgb24gdGhlIHNlcnZlciBzb2NrZXQuLi4KICAgIHRoaXMuaW8uc2VydmVyU29ja2V0Lm9uKCdtZXNzYWdlJywgb25tZXNzYWdlKQoKICAgIGNvbnN0IHBvbmdzID0gYXdhaXQgcmVxdWVzdEFsbCh0aGlzLCB0cnVlLCBQSU5HX05BVCwgdmFsdWUsIG5vZGVzKQoKICAgIGxldCBjb3VudCA9IDAKICAgIGZvciAoY29uc3QgcmVzIG9mIHBvbmdzKSB7CiAgICAgIGlmIChob3N0cy5oYXMocmVzLmZyb20uaG9zdCkpIHsKICAgICAgICBjb3VudCsrCiAgICAgICAgbmF0U2FtcGxlci5hZGQocmVzLnRvLmhvc3QsIHJlcy50by5wb3J0KQogICAgICB9CiAgICB9CgogICAgdGhpcy5pby5zZXJ2ZXJTb2NrZXQucmVtb3ZlTGlzdGVuZXIoJ21lc3NhZ2UnLCBvbm1lc3NhZ2UpCgogICAgLy8gaWYgd2UgZ290IG5vIG9yIHZlcnkgZmV3IHJlcGxpZXMsIGNvbnNpZGVyIGl0IGEgZmx1a2UKICAgIGlmIChjb3VudCA8IChub2Rlcy5sZW5ndGggPj0gNSA/IDMgOiAxKSkgcmV0dXJuIHRydWUKCiAgICAvLyBjaGVjayB0aGF0IHRoZSBzZXJ2ZXIgc29ja2V0IGhhcyB0aGUgc2FtZSBpcCBhcyB0aGUgY2xpZW50IHNvY2tldAogICAgaWYgKG5hdFNhbXBsZXIuaG9zdCA9PT0gbnVsbCB8fCB0aGlzLl9uYXQuaG9zdCAhPT0gbmF0U2FtcGxlci5ob3N0KSByZXR1cm4gdHJ1ZQoKICAgIC8vIGNoZWNrIHRoYXQgdGhlIGxvY2FsIHBvcnQgb2YgdGhlIHNlcnZlciBzb2NrZXQgaXMgdGhlIHNhbWUgYXMgdGhlIHJlbW90ZSBwb3J0CiAgICAvLyBUT0RPOiB3ZSBtaWdodCB3YW50IGEgZmxhZyB0byBvcHQgb3V0IG9mIHRoaXMgaGV1cmlzdGljIGZvciBzcGVjaWZpYyByZW1hcHBlZCBwb3J0IHNlcnZlcnMKICAgIGlmIChuYXRTYW1wbGVyLnBvcnQgPT09IDAgfHwgbmF0U2FtcGxlci5wb3J0ICE9PSB0aGlzLmlvLnNlcnZlclNvY2tldC5hZGRyZXNzKCkucG9ydCkgewogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQoKICAgIGZ1bmN0aW9uIG9ubWVzc2FnZShfLCB7IGhvc3QgfSkgewogICAgICBob3N0cy5hZGQoaG9zdCkKICAgIH0KICB9CgogIF9iYWNrZ3JvdW5kUXVlcnkodGFyZ2V0KSB7CiAgICB0aGlzLl9yZWZyZXNoVGlja3MgPSBSRUZSRVNIX1RJQ0tTCgogICAgY29uc3QgYmFja2dyb3VuZENvbiA9IE1hdGgubWluKHRoaXMuY29uY3VycmVuY3ksIE1hdGgubWF4KDIsICh0aGlzLmNvbmN1cnJlbmN5IC8gOCkgfCAwKSkKICAgIGNvbnN0IHEgPSBuZXcgUXVlcnkodGhpcywgdGFyZ2V0LCB0cnVlLCBGSU5EX05PREUsIG51bGwsIHsKICAgICAgY29uY3VycmVuY3k6IGJhY2tncm91bmRDb24sCiAgICAgIG1heFNsb3c6IDAKICAgIH0pCgogICAgcS5vbignZGF0YScsICgpID0+IHsKICAgICAgLy8geWllbGQgdG8gb3RoZXIgdHJhZmZpYwogICAgICBxLmNvbmN1cnJlbmN5ID0gdGhpcy5pby5pbmZsaWdodC5sZW5ndGggPCAzID8gdGhpcy5jb25jdXJyZW5jeSA6IGJhY2tncm91bmRDb24KICAgIH0pCgogICAgcmV0dXJuIHEKICB9CgogIC8vIGNhbGxlZCBieSB0aGUgcXVlcnkKICBfb25saW5lKCkgewogICAgaWYgKHRoaXMub25saW5lKSByZXR1cm4KICAgIHRoaXMub25saW5lID0gdHJ1ZQogICAgdGhpcy5lbWl0KCduZXR3b3JrLXVwZGF0ZScpCiAgfQoKICAvLyBjYWxsZWQgYnkgdGhlIHF1ZXJ5CiAgX29mZmxpbmUoKSB7CiAgICBpZiAoIXRoaXMub25saW5lKSByZXR1cm4KICAgIHRoaXMub25saW5lID0gZmFsc2UKICAgIHRoaXMuZW1pdCgnbmV0d29yay11cGRhdGUnKQogIH0KfQoKREhULk9LID0gMApESFQuRVJST1JfVU5LTk9XTl9DT01NQU5EID0gVU5LTk9XTl9DT01NQU5ECkRIVC5FUlJPUl9JTlZBTElEX1RPS0VOID0gSU5WQUxJRF9UT0tFTgoKbW9kdWxlLmV4cG9ydHMgPSBESFQKCmZ1bmN0aW9uIGxvY2FsSVAodWR4LCBmYW1pbHkgPSA0KSB7CiAgbGV0IGhvc3QgPSBudWxsCgogIGZvciAoY29uc3QgbiBvZiB1ZHgubmV0d29ya0ludGVyZmFjZXMoKSkgewogICAgaWYgKG4uZmFtaWx5ICE9PSBmYW1pbHkgfHwgbi5pbnRlcm5hbCkgY29udGludWUKCiAgICAvLyBtYWMgcmVhbGx5IGxpa2VzIGVuMCwgbWIgYSBiZXR0ZXIgd2F5IGJ1dCB0aGlzIHNob3VsZG50IGJlIGJhZCBhbnl3aGVyZSBzbyByZXR1cm4gbm93CiAgICBpZiAobi5uYW1lID09PSAnZW4wJykgcmV0dXJuIG4uaG9zdAoKICAgIC8vIG90aGVyd2lzZSBwaWNrIHRoZSBmaXJzdCBub24gaW50ZXJuYWwgaG9zdCAobGV0IHRoZSBsb29wIGNvbnRpbnVlIGluIGNhc2Ugd2Ugc2VlIGVuMCkKICAgIGlmIChob3N0ID09PSBudWxsKSBob3N0ID0gbi5ob3N0CiAgfQoKICByZXR1cm4gaG9zdCB8fCAoZmFtaWx5ID09PSA0ID8gJzEyNy4wLjAuMScgOiAnOjoxJykKfQoKZnVuY3Rpb24gcGFyc2VOb2RlKHMpIHsKICBpZiAodHlwZW9mIHMgPT09ICdvYmplY3QnKSByZXR1cm4gcwogIGlmICh0eXBlb2YgcyA9PT0gJ251bWJlcicpIHJldHVybiB7IGhvc3Q6ICcxMjcuMC4wLjEnLCBwb3J0OiBzIH0KICBjb25zdCBbaG9zdCwgcG9ydF0gPSBzLnNwbGl0KCc6JykKICBpZiAoIXBvcnQpIHRocm93IG5ldyBFcnJvcignQm9vdHN0cmFwIG5vZGUgZm9ybWF0IGlzIGhvc3Q6cG9ydCcpCgogIHJldHVybiB7CiAgICBob3N0LAogICAgcG9ydDogTnVtYmVyKHBvcnQpCiAgfQp9CgpmdW5jdGlvbiByYW5kb21CeXRlcyhuKSB7CiAgY29uc3QgYiA9IGI0YS5hbGxvYyhuKQogIHNvZGl1bS5yYW5kb21ieXRlc19idWYoYikKICByZXR1cm4gYgp9CgpmdW5jdGlvbiByYW5kb21PZmZzZXQobikgewogIHJldHVybiBuIC0gKChNYXRoLnJhbmRvbSgpICogMC41ICogbikgfCAwKQp9CgpmdW5jdGlvbiByZXF1ZXN0QWxsKGRodCwgaW50ZXJuYWwsIGNvbW1hbmQsIHZhbHVlLCBub2RlcykgewogIGxldCBtaXNzaW5nID0gbm9kZXMubGVuZ3RoCiAgY29uc3QgcmVwbGllcyA9IFtdCgogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSB7CiAgICAgIGNvbnN0IHJlcSA9IGRodC5fcmVxdWVzdCgKICAgICAgICBub2RlLAogICAgICAgIGZhbHNlLAogICAgICAgIGludGVybmFsLAogICAgICAgIGNvbW1hbmQsCiAgICAgICAgbnVsbCwKICAgICAgICB2YWx1ZSwKICAgICAgICBudWxsLAogICAgICAgIG9uc3VjY2VzcywKICAgICAgICBvbmVycm9yCiAgICAgICkKICAgICAgaWYgKCFyZXEpIHJldHVybiByZXNvbHZlKHJlcGxpZXMpCiAgICB9CgogICAgZnVuY3Rpb24gb25zdWNjZXNzKHJlcykgewogICAgICByZXBsaWVzLnB1c2gocmVzKQogICAgICBpZiAoLS1taXNzaW5nID09PSAwKSByZXNvbHZlKHJlcGxpZXMpCiAgICB9CgogICAgZnVuY3Rpb24gb25lcnJvcigpIHsKICAgICAgaWYgKC0tbWlzc2luZyA9PT0gMCkgcmVzb2x2ZShyZXBsaWVzKQogICAgfQogIH0pCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpleHBvcnRzLlBJTkcgPSAwCmV4cG9ydHMuUElOR19OQVQgPSAxCmV4cG9ydHMuRklORF9OT0RFID0gMgpleHBvcnRzLkRPV05fSElOVCA9IDMKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBESFRFcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3Rvcihtc2csIGNvZGUsIGZuID0gREhURXJyb3IpIHsKICAgIHN1cGVyKGAke2NvZGV9OiAke21zZ31gKQogICAgdGhpcy5jb2RlID0gY29kZQoKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBmbikKICAgIH0KICB9CgogIGdldCBuYW1lKCkgewogICAgcmV0dXJuICdESFRFcnJvcicKICB9CgogIHN0YXRpYyBVTktOT1dOX0NPTU1BTkQgPSAxCiAgc3RhdGljIElOVkFMSURfVE9LRU4gPSAyCgogIHN0YXRpYyBSRVFVRVNUX1RJTUVPVVQobXNnID0gJ1JlcXVlc3QgdGltZWQgb3V0JykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdSRVFVRVNUX1RJTUVPVVQnLCBESFRFcnJvci5SRVFVRVNUX1RJTUVPVVQpCiAgfQoKICBzdGF0aWMgUkVRVUVTVF9ERVNUUk9ZRUQobXNnID0gJ1JlcXVlc3QgZGVzdHJveWVkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdSRVFVRVNUX0RFU1RST1lFRCcsIERIVEVycm9yLlJFUVVFU1RfREVTVFJPWUVEKQogIH0KCiAgc3RhdGljIElPX1NVU1BFTkRFRChtc2cgPSAnSS9PIHN1c3BlbmRlZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnSU9fU1VTUEVOREVEJywgREhURXJyb3IuSU9fU1VTUEVOREVEKQogIH0KfQpjb25zdCBGSUZPID0gcmVxdWlyZSgnZmFzdC1maWZvJykKY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgcGVlciA9IHJlcXVpcmUoJy4vcGVlcicpCmNvbnN0IHsgSU5WQUxJRF9UT0tFTiwgUkVRVUVTVF9USU1FT1VULCBSRVFVRVNUX0RFU1RST1lFRCwgSU9fU1VTUEVOREVEIH0gPSByZXF1aXJlKCcuL2Vycm9ycycpCgpjb25zdCBWRVJTSU9OID0gMGIxMQpjb25zdCBSRVNQT05TRV9JRCA9ICgwYjAwMDEgPDwgNCkgfCBWRVJTSU9OCmNvbnN0IFJFUVVFU1RfSUQgPSAoMGIwMDAwIDw8IDQpIHwgVkVSU0lPTgpjb25zdCBFTVBUWV9BUlJBWSA9IFtdCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIElPIHsKICBjb25zdHJ1Y3RvcigKICAgIHRhYmxlLAogICAgdWR4LAogICAgewogICAgICBtYXhXaW5kb3cgPSA4MCwKICAgICAgcG9ydCA9IDAsCiAgICAgIGhvc3QgPSAnMC4wLjAuMCcsCiAgICAgIGFueVBvcnQgPSB0cnVlLAogICAgICBmaXJld2FsbGVkID0gdHJ1ZSwKICAgICAgb25yZXF1ZXN0LAogICAgICBvbnJlc3BvbnNlID0gbm9vcCwKICAgICAgb250aW1lb3V0ID0gbm9vcAogICAgfSA9IHt9CiAgKSB7CiAgICB0aGlzLnRhYmxlID0gdGFibGUKICAgIHRoaXMudWR4ID0gdWR4CiAgICB0aGlzLmluZmxpZ2h0ID0gW10KICAgIHRoaXMuY2xpZW50U29ja2V0ID0gbnVsbAogICAgdGhpcy5zZXJ2ZXJTb2NrZXQgPSBudWxsCiAgICB0aGlzLmZpcmV3YWxsZWQgPSBmaXJld2FsbGVkICE9PSBmYWxzZQogICAgdGhpcy5lcGhlbWVyYWwgPSB0cnVlCiAgICB0aGlzLmNvbmdlc3Rpb24gPSBuZXcgQ29uZ2VzdGlvbldpbmRvdyhtYXhXaW5kb3cpCiAgICB0aGlzLm5ldHdvcmtJbnRlcmZhY2VzID0gdWR4LndhdGNoTmV0d29ya0ludGVyZmFjZXMoKQogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQoKICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgIHJlcXVlc3RzOiB7IGFjdGl2ZTogMCwgdG90YWw6IDAgfSwKICAgICAgY29tbWFuZHM6IFsKICAgICAgICB7IHR4OiAwLCByeDogMCB9LCAvLyB0eCA9IHRyYW5zbWl0dGVkLCByeCA9IHJlY2VpdmVkCiAgICAgICAgeyB0eDogMCwgcng6IDAgfSwKICAgICAgICB7IHR4OiAwLCByeDogMCB9LAogICAgICAgIHsgdHg6IDAsIHJ4OiAwIH0KICAgICAgXQogICAgfQoKICAgIHRoaXMub25yZXF1ZXN0ID0gb25yZXF1ZXN0CiAgICB0aGlzLm9ucmVzcG9uc2UgPSBvbnJlc3BvbnNlCiAgICB0aGlzLm9udGltZW91dCA9IG9udGltZW91dAoKICAgIHRoaXMuX3BlbmRpbmcgPSBuZXcgRklGTygpCiAgICB0aGlzLl9yb3RhdGVTZWNyZXRzID0gMTAKICAgIHRoaXMuX3RpZCA9IChNYXRoLnJhbmRvbSgpICogNjU1MzYpIHwgMAogICAgdGhpcy5fc2VjcmV0cyA9IG51bGwKICAgIHRoaXMuX2RyYWluSW50ZXJ2YWwgPSBudWxsCiAgICB0aGlzLl9kZXN0cm95aW5nID0gbnVsbAogICAgdGhpcy5fYmluZGluZyA9IG51bGwKCiAgICAvLyBwb3J0IGNhbiBiZSBhIG51bWJlciBvciBhIHJhbmdlIFtzdGFydCwgdG9dCiAgICB0aGlzLnBvcnRSYW5nZSA9IHBvcnQubGVuZ3RoID8gcG9ydCA6IHBvcnQgPT09IDAgPyBbMCwgMF0gOiBbcG9ydCwgcG9ydCArIDVdCgogICAgdGhpcy5faG9zdCA9IGhvc3QKICAgIHRoaXMuX2FueVBvcnQgPSBhbnlQb3J0ICE9PSBmYWxzZQogICAgdGhpcy5fYm91bmRTZXJ2ZXJQb3J0ID0gMAogICAgdGhpcy5fYm91bmRDbGllbnRQb3J0ID0gMAogIH0KCiAgb25tZXNzYWdlKHNvY2tldCwgYnVmZmVyLCB7IGhvc3QsIHBvcnQgfSkgewogICAgaWYgKGJ1ZmZlci5ieXRlTGVuZ3RoIDwgMiB8fCAhKHBvcnQgPiAwICYmIHBvcnQgPCA2NTUzNikgfHwgdGhpcy5zdXNwZW5kZWQgPT09IHRydWUpIHJldHVybgoKICAgIGNvbnN0IGZyb20gPSB7IGlkOiBudWxsLCBob3N0LCBwb3J0IH0KICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMSwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCwgYnVmZmVyIH0KICAgIGNvbnN0IGV4cGVjdGVkU29ja2V0ID0gdGhpcy5maXJld2FsbGVkID8gdGhpcy5jbGllbnRTb2NrZXQgOiB0aGlzLnNlcnZlclNvY2tldAogICAgY29uc3QgZXh0ZXJuYWwgPSBzb2NrZXQgIT09IGV4cGVjdGVkU29ja2V0CgogICAgaWYgKGJ1ZmZlclswXSA9PT0gUkVRVUVTVF9JRCkgewogICAgICBjb25zdCByZXEgPSBSZXF1ZXN0LmRlY29kZSh0aGlzLCBzb2NrZXQsIGZyb20sIHN0YXRlKQogICAgICBpZiAocmVxID09PSBudWxsKSByZXR1cm4KICAgICAgaWYgKAogICAgICAgIHJlcS50b2tlbiAhPT0gbnVsbCAmJgogICAgICAgICFiNGEuZXF1YWxzKHJlcS50b2tlbiwgdGhpcy50b2tlbihyZXEuZnJvbSwgMSkpICYmCiAgICAgICAgIWI0YS5lcXVhbHMocmVxLnRva2VuLCB0aGlzLnRva2VuKHJlcS5mcm9tLCAwKSkKICAgICAgKSB7CiAgICAgICAgcmVxLmVycm9yKElOVkFMSURfVE9LRU4sIHsgdG9rZW46IHRydWUgfSkKICAgICAgICByZXR1cm4KICAgICAgfQogICAgICB0aGlzLm9ucmVxdWVzdChyZXEsIGV4dGVybmFsKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoYnVmZmVyWzBdID09PSBSRVNQT05TRV9JRCkgewogICAgICBjb25zdCByZXMgPSBkZWNvZGVSZXBseShmcm9tLCBzdGF0ZSkKICAgICAgaWYgKHJlcyA9PT0gbnVsbCkgcmV0dXJuCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuaW5mbGlnaHQubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCByZXEgPSB0aGlzLmluZmxpZ2h0W2ldCiAgICAgICAgaWYgKHJlcS50aWQgIT09IHJlcy50aWQpIGNvbnRpbnVlCgogICAgICAgIHJlcy5ydHQgPSBEYXRlLm5vdygpIC0gcmVxLl90aW1lc3RhbXAKCiAgICAgICAgaWYgKGkgPT09IHRoaXMuaW5mbGlnaHQubGVuZ3RoIC0gMSkgdGhpcy5pbmZsaWdodC5wb3AoKQogICAgICAgIGVsc2UgdGhpcy5pbmZsaWdodFtpXSA9IHRoaXMuaW5mbGlnaHQucG9wKCkKCiAgICAgICAgaWYgKHJlcS5zZXNzaW9uKSByZXEuc2Vzc2lvbi5fZGV0YWNoKHJlcSkKCiAgICAgICAgLy8gVE9ETzogQXV0byByZXRyeSBoZXJlIGlmIGVycm9ycy5JTlZBTElEX1RPS0VOIGlzIHJldHVybmVkPwoKICAgICAgICBpZiAocmVxLl90aW1lb3V0KSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQocmVxLl90aW1lb3V0KQogICAgICAgICAgcmVxLl90aW1lb3V0ID0gbnVsbAogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb25nZXN0aW9uLnJlY3YoKQoKICAgICAgICBpZiAocmVxLmludGVybmFsICYmIHJlcS5jb21tYW5kIDwgdGhpcy5zdGF0cy5jb21tYW5kcy5sZW5ndGgpIHsKICAgICAgICAgIHRoaXMuc3RhdHMuY29tbWFuZHNbcmVxLmNvbW1hbmRdLnJ4KysKICAgICAgICB9CgogICAgICAgIHRoaXMuc3RhdHMucmVxdWVzdHMuYWN0aXZlLS0KCiAgICAgICAgdGhpcy5vbnJlc3BvbnNlKHJlcywgZXh0ZXJuYWwpCiAgICAgICAgcmVxLm9ucmVzcG9uc2UocmVzLCByZXEpCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQogIH0KCiAgdG9rZW4oYWRkciwgaSkgewogICAgaWYgKHRoaXMuX3NlY3JldHMgPT09IG51bGwpIHsKICAgICAgY29uc3QgYnVmID0gYjRhLmFsbG9jKDY0KQogICAgICB0aGlzLl9zZWNyZXRzID0gW2J1Zi5zdWJhcnJheSgwLCAzMiksIGJ1Zi5zdWJhcnJheSgzMiwgNjQpXQogICAgICBzb2RpdW0ucmFuZG9tYnl0ZXNfYnVmKHRoaXMuX3NlY3JldHNbMF0pCiAgICAgIHNvZGl1bS5yYW5kb21ieXRlc19idWYodGhpcy5fc2VjcmV0c1sxXSkKICAgIH0KCiAgICBjb25zdCB0b2tlbiA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2godG9rZW4sIGI0YS5mcm9tKGFkZHIuaG9zdCksIHRoaXMuX3NlY3JldHNbaV0pCiAgICByZXR1cm4gdG9rZW4KICB9CgogIGFzeW5jIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5fZGVzdHJveWluZykgcmV0dXJuIHRoaXMuX2Rlc3Ryb3lpbmcKICAgIHRoaXMuX2Rlc3Ryb3lpbmcgPSB0aGlzLl9kZXN0cm95KCkKICAgIHJldHVybiB0aGlzLl9kZXN0cm95aW5nCiAgfQoKICBhc3luYyBfZGVzdHJveSgpIHsKICAgIC8vIHNpbXBsaWZpZXMgdGltaW5nIHRvIGF3YWl0IHRoZSBiaW5kIGhlcmUgYWxzbywgYWx0aG91Z2ggaXQgbWlnaHQgYmUgdW5uZWVkZWQKICAgIGF3YWl0IHRoaXMuYmluZCgpCiAgICBhd2FpdCB0aGlzLl9jbGVhcihmYWxzZSkKICB9CgogIGFzeW5jIF9jbGVhcihzdXNwZW5kZWQpIHsKICAgIGlmICh0aGlzLl9kcmFpbkludGVydmFsKSB7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fZHJhaW5JbnRlcnZhbCkKICAgICAgdGhpcy5fZHJhaW5JbnRlcnZhbCA9IG51bGwKICAgIH0KCiAgICB3aGlsZSAodGhpcy5pbmZsaWdodC5sZW5ndGgpIHsKICAgICAgY29uc3QgcmVxID0gdGhpcy5pbmZsaWdodC5wb3AoKQogICAgICBpZiAocmVxLl90aW1lb3V0KSBjbGVhclRpbWVvdXQocmVxLl90aW1lb3V0KQogICAgICByZXEuX3RpbWVvdXQgPSBudWxsCiAgICAgIHJlcS5kZXN0cm95ZWQgPSB0cnVlCgogICAgICBpZiAocmVxLnNlc3Npb24pIHJlcS5zZXNzaW9uLl9kZXRhY2gocmVxKQoKICAgICAgdGhpcy5jb25nZXN0aW9uLnJlY3YoKQogICAgICB0aGlzLnN0YXRzLnJlcXVlc3RzLmFjdGl2ZS0tCgogICAgICByZXEub25lcnJvcihzdXNwZW5kZWQgPyBJT19TVVNQRU5ERUQoKSA6IFJFUVVFU1RfREVTVFJPWUVEKCksIHJlcSkKICAgIH0KCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoW3RoaXMuc2VydmVyU29ja2V0LmNsb3NlKCksIHRoaXMuY2xpZW50U29ja2V0LmNsb3NlKCldKQoKICAgIHRoaXMubmV0d29ya0ludGVyZmFjZXMuZGVzdHJveSgpCiAgfQoKICBhc3luYyBzdXNwZW5kKCkgewogICAgdGhpcy5zdXNwZW5kZWQgPSB0cnVlCiAgICBhd2FpdCB0aGlzLl9jbGVhcih0cnVlKQoKICAgIHRoaXMuY29uZ2VzdGlvbi5jbGVhcigpCgogICAgaWYgKHRoaXMuX2RyYWluSW50ZXJ2YWwpIHsKICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9kcmFpbkludGVydmFsKQogICAgICB0aGlzLl9kcmFpbkludGVydmFsID0gbnVsbAogICAgfQogIH0KCiAgYXN5bmMgX3JlYmluZChiaW5kaW5nKSB7CiAgICBpZiAoYmluZGluZykgYXdhaXQgYmluZGluZwogICAgaWYgKHRoaXMuX2Rlc3Ryb3lpbmcpIHJldHVybiB0aGlzLl9kZXN0cm95aW5nCiAgICBhd2FpdCB0aGlzLl9iaW5kU29ja2V0cygpCiAgICB0aGlzLm5ldHdvcmtJbnRlcmZhY2VzID0gdGhpcy51ZHgud2F0Y2hOZXR3b3JrSW50ZXJmYWNlcygpCiAgfQoKICByZXN1bWUoKSB7CiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCiAgICBjb25zdCBiaW5kaW5nID0gdGhpcy5fYmluZGluZwogICAgdGhpcy5fYmluZGluZyA9IHRoaXMuX3JlYmluZChiaW5kaW5nKQogICAgcmV0dXJuIHRoaXMuX2JpbmRpbmcKICB9CgogIGJpbmQoKSB7CiAgICBpZiAodGhpcy5fYmluZGluZykgcmV0dXJuIHRoaXMuX2JpbmRpbmcKICAgIHRoaXMuX2JpbmRpbmcgPSB0aGlzLl9iaW5kU29ja2V0cygpCiAgICByZXR1cm4gdGhpcy5fYmluZGluZwogIH0KCiAgYXN5bmMgX2JpbmRTb2NrZXRzKCkgewogICAgY29uc3Qgc2VydmVyU29ja2V0ID0gdGhpcy51ZHguY3JlYXRlU29ja2V0KCkKCiAgICBjb25zdCBjYW5kaWRhdGVQb3J0cyA9IFtdCgogICAgLy8gUmV0cnlpbmcgcHJldmlvdXMgcG9ydCBhbHdheXMgaGFzIHByZWNlZGVuY2UKICAgIGlmICh0aGlzLl9ib3VuZFNlcnZlclBvcnQpIGNhbmRpZGF0ZVBvcnRzLnB1c2godGhpcy5fYm91bmRTZXJ2ZXJQb3J0KQoKICAgIGZvciAobGV0IGkgPSB0aGlzLnBvcnRSYW5nZVswXTsgaSA8IHRoaXMucG9ydFJhbmdlWzFdOyBpKyspIGNhbmRpZGF0ZVBvcnRzLnB1c2goaSkKCiAgICBmb3IgKGNvbnN0IHBvcnQgb2YgY2FuZGlkYXRlUG9ydHMpIHsKICAgICAgaWYgKHNlcnZlclNvY2tldC5ib3VuZCkgYnJlYWsKCiAgICAgIHRyeSB7CiAgICAgICAgc2VydmVyU29ja2V0LmJpbmQocG9ydCwgdGhpcy5faG9zdCkKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKCF0aGlzLl9hbnlQb3J0KSB7CiAgICAgICAgICBhd2FpdCBzZXJ2ZXJTb2NrZXQuY2xvc2UoKQogICAgICAgICAgdGhyb3cgZXJyCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKCFzZXJ2ZXJTb2NrZXQuYm91bmQpIHsKICAgICAgdHJ5IHsKICAgICAgICBzZXJ2ZXJTb2NrZXQuYmluZCgwLCB0aGlzLl9ob3N0KQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBhd2FpdCBzZXJ2ZXJTb2NrZXQuY2xvc2UoKQogICAgICAgIHRocm93IGVycgogICAgICB9CiAgICB9CgogICAgY29uc3QgY2xpZW50U29ja2V0ID0gdGhpcy51ZHguY3JlYXRlU29ja2V0KCkKCiAgICB0cnkgewogICAgICBjbGllbnRTb2NrZXQuYmluZCh0aGlzLl9ib3VuZENsaWVudFBvcnQgfHwgMCwgdGhpcy5faG9zdCkKICAgIH0gY2F0Y2ggewogICAgICB0cnkgewogICAgICAgIGNsaWVudFNvY2tldC5iaW5kKDAsIHRoaXMuX2hvc3QpCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGF3YWl0IHNlcnZlclNvY2tldC5jbG9zZSgpCiAgICAgICAgYXdhaXQgY2xpZW50U29ja2V0LmNsb3NlKCkKICAgICAgICB0aHJvdyBlcnIKICAgICAgfQogICAgfQoKICAgIHRoaXMuX2JvdW5kU2VydmVyUG9ydCA9IHNlcnZlclNvY2tldC5hZGRyZXNzKCkucG9ydAogICAgdGhpcy5fYm91bmRDbGllbnRQb3J0ID0gY2xpZW50U29ja2V0LmFkZHJlc3MoKS5wb3J0CgogICAgdGhpcy5jbGllbnRTb2NrZXQgPSBjbGllbnRTb2NrZXQKICAgIHRoaXMuc2VydmVyU29ja2V0ID0gc2VydmVyU29ja2V0CgogICAgdGhpcy5zZXJ2ZXJTb2NrZXQub24oJ21lc3NhZ2UnLCB0aGlzLm9ubWVzc2FnZS5iaW5kKHRoaXMsIHRoaXMuc2VydmVyU29ja2V0KSkKICAgIHRoaXMuY2xpZW50U29ja2V0Lm9uKCdtZXNzYWdlJywgdGhpcy5vbm1lc3NhZ2UuYmluZCh0aGlzLCB0aGlzLmNsaWVudFNvY2tldCkpCgogICAgaWYgKHRoaXMuX2RyYWluSW50ZXJ2YWwgPT09IG51bGwpIHsKICAgICAgdGhpcy5fZHJhaW5JbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuX2RyYWluLmJpbmQodGhpcyksIDc1MCkKICAgICAgaWYgKHRoaXMuX2RyYWluSW50ZXJ2YWwudW5yZWYpIHRoaXMuX2RyYWluSW50ZXJ2YWwudW5yZWYoKQogICAgfQoKICAgIGZvciAoY29uc3QgcmVxIG9mIHRoaXMuaW5mbGlnaHQpIHsKICAgICAgaWYgKCFyZXEuc29ja2V0KSByZXEuc29ja2V0ID0gdGhpcy5maXJld2FsbGVkID8gdGhpcy5jbGllbnRTb2NrZXQgOiB0aGlzLnNlcnZlclNvY2tldAogICAgICByZXEuc2VudCA9IDAKICAgICAgcmVxLnNlbmQoZmFsc2UpCiAgICB9CiAgfQoKICBfZHJhaW4oKSB7CiAgICBpZiAodGhpcy5fc2VjcmV0cyAhPT0gbnVsbCAmJiAtLXRoaXMuX3JvdGF0ZVNlY3JldHMgPT09IDApIHsKICAgICAgdGhpcy5fcm90YXRlU2VjcmV0cyA9IDEwCiAgICAgIGNvbnN0IHRtcCA9IHRoaXMuX3NlY3JldHNbMF0KICAgICAgdGhpcy5fc2VjcmV0c1swXSA9IHRoaXMuX3NlY3JldHNbMV0KICAgICAgdGhpcy5fc2VjcmV0c1sxXSA9IHRtcAogICAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKHRtcCwgdG1wKQogICAgfQoKICAgIHRoaXMuY29uZ2VzdGlvbi5kcmFpbigpCgogICAgd2hpbGUgKCF0aGlzLmNvbmdlc3Rpb24uaXNGdWxsKCkpIHsKICAgICAgY29uc3QgcCA9IHRoaXMuX3BlbmRpbmcuc2hpZnQoKQogICAgICBpZiAocCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KICAgICAgcC5fc2VuZE5vdygpCiAgICB9CiAgfQoKICBjcmVhdGVSZXF1ZXN0KHRvLCB0b2tlbiwgaW50ZXJuYWwsIGNvbW1hbmQsIHRhcmdldCwgdmFsdWUsIHNlc3Npb24sIHR0bCkgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3lpbmcgIT09IG51bGwpIHJldHVybiBudWxsCgogICAgaWYgKHRoaXMuX3RpZCA9PT0gNjU1MzYpIHRoaXMuX3RpZCA9IDAKCiAgICBjb25zdCB0aWQgPSB0aGlzLl90aWQrKwogICAgY29uc3Qgc29ja2V0ID0gdGhpcy5maXJld2FsbGVkID8gdGhpcy5jbGllbnRTb2NrZXQgOiB0aGlzLnNlcnZlclNvY2tldAoKICAgIGNvbnN0IHJlcSA9IG5ldyBSZXF1ZXN0KAogICAgICB0aGlzLAogICAgICBzb2NrZXQsCiAgICAgIHRpZCwKICAgICAgbnVsbCwKICAgICAgdG8sCiAgICAgIHRva2VuLAogICAgICBpbnRlcm5hbCwKICAgICAgY29tbWFuZCwKICAgICAgdGFyZ2V0LAogICAgICB2YWx1ZSwKICAgICAgc2Vzc2lvbiwKICAgICAgdHRsIHx8IDAKICAgICkKICAgIHRoaXMuaW5mbGlnaHQucHVzaChyZXEpCiAgICBpZiAoc2Vzc2lvbikgc2Vzc2lvbi5fYXR0YWNoKHJlcSkKCiAgICBpZiAoaW50ZXJuYWwgJiYgY29tbWFuZCA8IHRoaXMuc3RhdHMuY29tbWFuZHMubGVuZ3RoKSB7CiAgICAgIHRoaXMuc3RhdHMuY29tbWFuZHNbY29tbWFuZF0udHgrKwogICAgfQoKICAgIHRoaXMuc3RhdHMucmVxdWVzdHMuYWN0aXZlKysKICAgIHRoaXMuc3RhdHMucmVxdWVzdHMudG90YWwrKwoKICAgIHJldHVybiByZXEKICB9Cn0KCmNsYXNzIFJlcXVlc3QgewogIGNvbnN0cnVjdG9yKGlvLCBzb2NrZXQsIHRpZCwgZnJvbSwgdG8sIHRva2VuLCBpbnRlcm5hbCwgY29tbWFuZCwgdGFyZ2V0LCB2YWx1ZSwgc2Vzc2lvbiwgdHRsKSB7CiAgICB0aGlzLnNvY2tldCA9IHNvY2tldAogICAgdGhpcy50aWQgPSB0aWQKICAgIHRoaXMuZnJvbSA9IGZyb20KICAgIHRoaXMudG8gPSB0bwogICAgdGhpcy50b2tlbiA9IHRva2VuCiAgICB0aGlzLmNvbW1hbmQgPSBjb21tYW5kCiAgICB0aGlzLnRhcmdldCA9IHRhcmdldAogICAgdGhpcy52YWx1ZSA9IHZhbHVlCiAgICB0aGlzLmludGVybmFsID0gaW50ZXJuYWwKICAgIHRoaXMuc2Vzc2lvbiA9IHNlc3Npb24KICAgIHRoaXMudHRsID0gdHRsCiAgICB0aGlzLmluZGV4ID0gLTEKICAgIHRoaXMuc2VudCA9IDAKICAgIHRoaXMucmV0cmllcyA9IDMKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKCiAgICB0aGlzLm9uY3ljbGUgPSBub29wCiAgICB0aGlzLm9uZXJyb3IgPSBub29wCiAgICB0aGlzLm9ucmVzcG9uc2UgPSBub29wCgogICAgdGhpcy5fYnVmZmVyID0gbnVsbAogICAgdGhpcy5faW8gPSBpbwogICAgdGhpcy5fdGltZW91dCA9IG51bGwKICAgIHRoaXMuX3RpbWVzdGFtcCA9IERhdGUubm93KCkKICB9CgogIHN0YXRpYyBkZWNvZGUoaW8sIHNvY2tldCwgZnJvbSwgc3RhdGUpIHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgICAgY29uc3QgdGlkID0gYy51aW50MTYuZGVjb2RlKHN0YXRlKQogICAgICBjb25zdCB0byA9IHBlZXIuaXB2NC5kZWNvZGUoc3RhdGUpCiAgICAgIGNvbnN0IGlkID0gZmxhZ3MgJiAxID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICAgIGNvbnN0IHRva2VuID0gZmxhZ3MgJiAyID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICAgIGNvbnN0IGludGVybmFsID0gKGZsYWdzICYgNCkgIT09IDAKICAgICAgY29uc3QgY29tbWFuZCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICAgIGNvbnN0IHRhcmdldCA9IGZsYWdzICYgOCA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgICBjb25zdCB2YWx1ZSA9IGZsYWdzICYgMTYgPyBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpIDogbnVsbAoKICAgICAgaWYgKGlkICE9PSBudWxsKSBmcm9tLmlkID0gdmFsaWRhdGVJZChpZCwgZnJvbSkKCiAgICAgIHJldHVybiBuZXcgUmVxdWVzdCgKICAgICAgICBpbywKICAgICAgICBzb2NrZXQsCiAgICAgICAgdGlkLAogICAgICAgIGZyb20sCiAgICAgICAgdG8sCiAgICAgICAgdG9rZW4sCiAgICAgICAgaW50ZXJuYWwsCiAgICAgICAgY29tbWFuZCwKICAgICAgICB0YXJnZXQsCiAgICAgICAgdmFsdWUsCiAgICAgICAgbnVsbCwKICAgICAgICAwCiAgICAgICkKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gbnVsbAogICAgfQogIH0KCiAgcmVwbHkodmFsdWUsIG9wdHMgPSB7fSkgewogICAgY29uc3Qgc29ja2V0ID0gb3B0cy5zb2NrZXQgfHwgdGhpcy5zb2NrZXQKICAgIGNvbnN0IHRvID0gb3B0cy50byB8fCB0aGlzLmZyb20KICAgIHRoaXMuX3NlbmRSZXBseSgwLCB2YWx1ZSB8fCBudWxsLCBvcHRzLnRva2VuICE9PSBmYWxzZSwgb3B0cy5jbG9zZXJOb2RlcyAhPT0gZmFsc2UsIHRvLCBzb2NrZXQpCiAgfQoKICBlcnJvcihjb2RlLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHNvY2tldCA9IG9wdHMuc29ja2V0IHx8IHRoaXMuc29ja2V0CiAgICBjb25zdCB0byA9IG9wdHMudG8gfHwgdGhpcy5mcm9tCiAgICB0aGlzLl9zZW5kUmVwbHkoY29kZSwgbnVsbCwgb3B0cy50b2tlbiA9PT0gdHJ1ZSwgb3B0cy5jbG9zZXJOb2RlcyAhPT0gZmFsc2UsIHRvLCBzb2NrZXQpCiAgfQoKICByZWxheSh2YWx1ZSwgdG8sIG9wdHMpIHsKICAgIGNvbnN0IHNvY2tldCA9IChvcHRzICYmIG9wdHMuc29ja2V0KSB8fCB0aGlzLnNvY2tldAogICAgY29uc3QgYnVmZmVyID0gdGhpcy5fZW5jb2RlUmVxdWVzdChudWxsLCB2YWx1ZSwgdG8sIHNvY2tldCkKICAgIHNvY2tldC50cnlTZW5kKGJ1ZmZlciwgdG8ucG9ydCwgdG8uaG9zdCwgdGhpcy50dGwpCiAgfQoKICBzZW5kKGZvcmNlID0gZmFsc2UpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCgogICAgaWYgKHRoaXMuc29ja2V0ID09PSBudWxsKSByZXR1cm4KICAgIGlmICh0aGlzLl9idWZmZXIgPT09IG51bGwpIHsKICAgICAgdGhpcy5fYnVmZmVyID0gdGhpcy5fZW5jb2RlUmVxdWVzdCh0aGlzLnRva2VuLCB0aGlzLnZhbHVlLCB0aGlzLnRvLCB0aGlzLnNvY2tldCkKICAgIH0KCiAgICBpZiAoIWZvcmNlICYmIHRoaXMuX2lvLmNvbmdlc3Rpb24uaXNGdWxsKCkpIHsKICAgICAgdGhpcy5faW8uX3BlbmRpbmcucHVzaCh0aGlzKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLl9zZW5kTm93KCkKICB9CgogIHNlbmRSZXBseShlcnJvciwgdmFsdWUsIHRva2VuLCBoYXNDbG9zZXJOb2RlcykgewogICAgdGhpcy5fc2VuZFJlcGx5KGVycm9yLCB2YWx1ZSwgdG9rZW4sIGhhc0Nsb3Nlck5vZGVzLCB0aGlzLmZyb20sIHRoaXMuc29ja2V0LCBudWxsKQogIH0KCiAgX3NlbmROb3coKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5zZW50KysKICAgIHRoaXMuX2lvLmNvbmdlc3Rpb24uc2VuZCgpCiAgICB0aGlzLnNvY2tldC50cnlTZW5kKHRoaXMuX2J1ZmZlciwgdGhpcy50by5wb3J0LCB0aGlzLnRvLmhvc3QsIHRoaXMudHRsKQogICAgaWYgKHRoaXMuX3RpbWVvdXQpIGNsZWFyVGltZW91dCh0aGlzLl90aW1lb3V0KQogICAgdGhpcy5fdGltZW91dCA9IHNldFRpbWVvdXQob25jeWNsZSwgMTAwMCwgdGhpcykKICB9CgogIGRlc3Ryb3koZXJyKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCgogICAgaWYgKHRoaXMuX3RpbWVvdXQpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVvdXQpCiAgICAgIHRoaXMuX3RpbWVvdXQgPSBudWxsCiAgICB9CgogICAgY29uc3QgaSA9IHRoaXMuX2lvLmluZmxpZ2h0LmluZGV4T2YodGhpcykKICAgIGlmIChpID09PSAtMSkgcmV0dXJuCgogICAgaWYgKGkgPT09IHRoaXMuX2lvLmluZmxpZ2h0Lmxlbmd0aCAtIDEpIHRoaXMuX2lvLmluZmxpZ2h0LnBvcCgpCiAgICBlbHNlIHRoaXMuX2lvLmluZmxpZ2h0W2ldID0gdGhpcy5faW8uaW5mbGlnaHQucG9wKCkKCiAgICBpZiAodGhpcy5zZXNzaW9uKSB0aGlzLnNlc3Npb24uX2RldGFjaCh0aGlzKQoKICAgIHRoaXMuX2lvLnN0YXRzLnJlcXVlc3RzLmFjdGl2ZS0tCiAgICB0aGlzLl9pby5jb25nZXN0aW9uLnJlY3YoKQoKICAgIHRoaXMub25lcnJvcihlcnIgfHwgUkVRVUVTVF9ERVNUUk9ZRUQoKSwgdGhpcykKICB9CgogIF9zZW5kUmVwbHkoZXJyb3IsIHZhbHVlLCB0b2tlbiwgaGFzQ2xvc2VyTm9kZXMsIGZyb20sIHNvY2tldCkgewogICAgaWYgKHNvY2tldCA9PT0gbnVsbCB8fCB0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCgogICAgY29uc3QgaWQgPSB0aGlzLl9pby5lcGhlbWVyYWwgPT09IGZhbHNlICYmIHNvY2tldCA9PT0gdGhpcy5faW8uc2VydmVyU29ja2V0CiAgICBjb25zdCBjbG9zZXJOb2RlcyA9CiAgICAgIHRoaXMudGFyZ2V0ICE9PSBudWxsICYmIGhhc0Nsb3Nlck5vZGVzID8gdGhpcy5faW8udGFibGUuY2xvc2VzdCh0aGlzLnRhcmdldCkgOiBFTVBUWV9BUlJBWQogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDEgKyAxICsgNiArIDIsIGJ1ZmZlcjogbnVsbCB9IC8vICh0eXBlIHwgdmVyc2lvbikgKyBmbGFncyArIHRvICsgdGlkCgogICAgaWYgKGlkKSBzdGF0ZS5lbmQgKz0gMzIKICAgIGlmICh0b2tlbikgc3RhdGUuZW5kICs9IDMyCiAgICBpZiAoY2xvc2VyTm9kZXMubGVuZ3RoID4gMCkgcGVlci5pcHY0QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBjbG9zZXJOb2RlcykKICAgIGlmIChlcnJvciA+IDApIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGVycm9yKQogICAgaWYgKHZhbHVlKSBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHZhbHVlKQoKICAgIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShzdGF0ZS5lbmQpCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBSRVNQT05TRV9JRAogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0KICAgICAgKGlkID8gMSA6IDApIHwKICAgICAgKHRva2VuID8gMiA6IDApIHwKICAgICAgKGNsb3Nlck5vZGVzLmxlbmd0aCA+IDAgPyA0IDogMCkgfAogICAgICAoZXJyb3IgPiAwID8gOCA6IDApIHwKICAgICAgKHZhbHVlID8gMTYgOiAwKQoKICAgIGMudWludDE2LmVuY29kZShzdGF0ZSwgdGhpcy50aWQpCiAgICBwZWVyLmlwdjQuZW5jb2RlKHN0YXRlLCBmcm9tKQoKICAgIGlmIChpZCkgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgdGhpcy5faW8udGFibGUuaWQpCiAgICBpZiAodG9rZW4pIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIHRoaXMuX2lvLnRva2VuKGZyb20sIDEpKQogICAgaWYgKGNsb3Nlck5vZGVzLmxlbmd0aCA+IDApIHBlZXIuaXB2NEFycmF5LmVuY29kZShzdGF0ZSwgY2xvc2VyTm9kZXMpCiAgICBpZiAoZXJyb3IgPiAwKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBlcnJvcikKICAgIGlmICh2YWx1ZSkgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB2YWx1ZSkKCiAgICBzb2NrZXQudHJ5U2VuZChzdGF0ZS5idWZmZXIsIGZyb20ucG9ydCwgZnJvbS5ob3N0LCB0aGlzLnR0bCkKICB9CgogIF9lbmNvZGVSZXF1ZXN0KHRva2VuLCB2YWx1ZSwgdG8sIHNvY2tldCkgewogICAgY29uc3QgaWQgPSB0aGlzLl9pby5lcGhlbWVyYWwgPT09IGZhbHNlICYmIHNvY2tldCA9PT0gdGhpcy5faW8uc2VydmVyU29ja2V0CiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogMSArIDEgKyA2ICsgMiwgYnVmZmVyOiBudWxsIH0gLy8gKHR5cGUgfCB2ZXJzaW9uKSArIGZsYWdzICsgdG8gKyB0aWQKCiAgICBpZiAoaWQpIHN0YXRlLmVuZCArPSAzMgogICAgaWYgKHRva2VuKSBzdGF0ZS5lbmQgKz0gMzIKCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB0aGlzLmNvbW1hbmQpCgogICAgaWYgKHRoaXMudGFyZ2V0KSBzdGF0ZS5lbmQgKz0gMzIKICAgIGlmICh2YWx1ZSkgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCB2YWx1ZSkKCiAgICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gUkVRVUVTVF9JRAogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0KICAgICAgKGlkID8gMSA6IDApIHwKICAgICAgKHRva2VuID8gMiA6IDApIHwKICAgICAgKHRoaXMuaW50ZXJuYWwgPyA0IDogMCkgfAogICAgICAodGhpcy50YXJnZXQgPyA4IDogMCkgfAogICAgICAodmFsdWUgPyAxNiA6IDApCgogICAgYy51aW50MTYuZW5jb2RlKHN0YXRlLCB0aGlzLnRpZCkKICAgIHBlZXIuaXB2NC5lbmNvZGUoc3RhdGUsIHRvKQoKICAgIGlmIChpZCkgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgdGhpcy5faW8udGFibGUuaWQpCiAgICBpZiAodG9rZW4pIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIHRva2VuKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHRoaXMuY29tbWFuZCkKCiAgICBpZiAodGhpcy50YXJnZXQpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIHRoaXMudGFyZ2V0KQogICAgaWYgKHZhbHVlKSBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHZhbHVlKQoKICAgIHJldHVybiBzdGF0ZS5idWZmZXIKICB9Cn0KCmNsYXNzIENvbmdlc3Rpb25XaW5kb3cgewogIGNvbnN0cnVjdG9yKG1heFdpbmRvdykgewogICAgdGhpcy5faSA9IDAKICAgIHRoaXMuX3RvdGFsID0gMAogICAgdGhpcy5fd2luZG93ID0gWzAsIDAsIDAsIDBdCiAgICB0aGlzLl9tYXhXaW5kb3cgPSBtYXhXaW5kb3cKICB9CgogIGNsZWFyKCkgewogICAgdGhpcy5faSA9IDAKICAgIHRoaXMuX3RvdGFsID0gMAogICAgdGhpcy5fd2luZG93ID0gWzAsIDAsIDAsIDBdCiAgfQoKICBpc0Z1bGwoKSB7CiAgICByZXR1cm4gdGhpcy5fdG90YWwgPj0gMiAqIHRoaXMuX21heFdpbmRvdyB8fCB0aGlzLl93aW5kb3dbdGhpcy5faV0gPj0gdGhpcy5fbWF4V2luZG93CiAgfQoKICByZWN2KCkgewogICAgaWYgKHRoaXMuX3dpbmRvd1t0aGlzLl9pXSA+IDApIHsKICAgICAgdGhpcy5fd2luZG93W3RoaXMuX2ldLS0KICAgICAgdGhpcy5fdG90YWwtLQogICAgfQogIH0KCiAgc2VuZCgpIHsKICAgIHRoaXMuX3RvdGFsKysKICAgIHRoaXMuX3dpbmRvd1t0aGlzLl9pXSsrCiAgfQoKICBkcmFpbigpIHsKICAgIHRoaXMuX2kgPSAodGhpcy5faSArIDEpICYgMwogICAgdGhpcy5fdG90YWwgLT0gdGhpcy5fd2luZG93W3RoaXMuX2ldCiAgICB0aGlzLl93aW5kb3dbdGhpcy5faV0gPSAwIC8vIGNsZWFyIG9sZGVzdAogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CgpmdW5jdGlvbiBvbmN5Y2xlKHJlcSkgewogIHJlcS5fdGltZW91dCA9IG51bGwKICByZXEub25jeWNsZShyZXEpCiAgaWYgKHJlcS5zZW50ID49IHJlcS5yZXRyaWVzKSB7CiAgICByZXEuZGVzdHJveShSRVFVRVNUX1RJTUVPVVQoKSkKICAgIHJlcS5faW8ub250aW1lb3V0KHJlcSkKICB9IGVsc2UgewogICAgcmVxLnNlbmQoKQogIH0KfQoKZnVuY3Rpb24gZGVjb2RlUmVwbHkoZnJvbSwgc3RhdGUpIHsKICB0cnkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgdGlkID0gYy51aW50MTYuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgdG8gPSBwZWVyLmlwdjQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgaWQgPSBmbGFncyAmIDEgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIGNvbnN0IHRva2VuID0gZmxhZ3MgJiAyID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICBjb25zdCBjbG9zZXJOb2RlcyA9IGZsYWdzICYgNCA/IHBlZXIuaXB2NEFycmF5LmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICBjb25zdCBlcnJvciA9IGZsYWdzICYgOCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgY29uc3QgdmFsdWUgPSBmbGFncyAmIDE2ID8gYy5idWZmZXIuZGVjb2RlKHN0YXRlKSA6IG51bGwKCiAgICBpZiAoaWQgIT09IG51bGwpIGZyb20uaWQgPSB2YWxpZGF0ZUlkKGlkLCBmcm9tKQoKICAgIHJldHVybiB7IHRpZCwgcnR0OiAwLCBmcm9tLCB0bywgdG9rZW4sIGNsb3Nlck5vZGVzLCBlcnJvciwgdmFsdWUgfQogIH0gY2F0Y2ggewogICAgcmV0dXJuIG51bGwKICB9Cn0KCmZ1bmN0aW9uIHZhbGlkYXRlSWQoaWQsIGZyb20pIHsKICBjb25zdCBleHBlY3RlZCA9IHBlZXIuaWQoZnJvbS5ob3N0LCBmcm9tLnBvcnQpCiAgcmV0dXJuIGI0YS5lcXVhbHMoZXhwZWN0ZWQsIGlkKSA/IGV4cGVjdGVkIDogbnVsbAp9CmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IG5ldCA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmctbmV0JykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IGlwdjQgPSB7CiAgLi4ubmV0LmlwdjRBZGRyZXNzLAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgaXAgPSBuZXQuaXB2NEFkZHJlc3MuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgaWQ6IG51bGwsIC8vIHBvcHVsYXRlZCBieSB0aGUgY2FsbGVlCiAgICAgIGhvc3Q6IGlwLmhvc3QsCiAgICAgIHBvcnQ6IGlwLnBvcnQKICAgIH0KICB9Cn0KCm1vZHVsZS5leHBvcnRzID0geyBpZCwgaXB2NCwgaXB2NEFycmF5OiBjLmFycmF5KGlwdjQpIH0KCmZ1bmN0aW9uIGlkKGhvc3QsIHBvcnQsIG91dCA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coMzIpKSB7CiAgY29uc3QgYWRkciA9IG91dC5zdWJhcnJheSgwLCA2KQogIGlwdjQuZW5jb2RlKHsgc3RhcnQ6IDAsIGVuZDogNiwgYnVmZmVyOiBhZGRyIH0sIHsgaG9zdCwgcG9ydCB9KQogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2gob3V0LCBhZGRyKQogIHJldHVybiBvdXQKfQpjb25zdCB7IFJlYWRhYmxlLCBnZXRTdHJlYW1FcnJvciB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHBlZXIgPSByZXF1aXJlKCcuL3BlZXInKQpjb25zdCB7IERPV05fSElOVCB9ID0gcmVxdWlyZSgnLi9jb21tYW5kcycpCgpjb25zdCBET05FID0gW10KY29uc3QgRE9XTiA9IFtdCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFF1ZXJ5IGV4dGVuZHMgUmVhZGFibGUgewogIGNvbnN0cnVjdG9yKGRodCwgdGFyZ2V0LCBpbnRlcm5hbCwgY29tbWFuZCwgdmFsdWUsIG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIGRodC5zdGF0cy5xdWVyaWVzLnRvdGFsKysKICAgIGRodC5zdGF0cy5xdWVyaWVzLmFjdGl2ZSsrCgogICAgdGhpcy5mb3JjZSA9ICEhb3B0cy5mb3JjZQogICAgdGhpcy5kaHQgPSBkaHQKICAgIHRoaXMuayA9IHRoaXMuZGh0LnRhYmxlLmsKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0CiAgICB0aGlzLmludGVybmFsID0gaW50ZXJuYWwKICAgIHRoaXMuY29tbWFuZCA9IGNvbW1hbmQKICAgIHRoaXMudmFsdWUgPSB2YWx1ZQogICAgdGhpcy5lcnJvcnMgPSAwCiAgICB0aGlzLnN1Y2Nlc3NlcyA9IDAKICAgIHRoaXMuY29uY3VycmVuY3kgPSBvcHRzLmNvbmN1cnJlbmN5IHx8IHRoaXMuZGh0LmNvbmN1cnJlbmN5CiAgICB0aGlzLmluZmxpZ2h0ID0gMAogICAgdGhpcy5tYXAgPSBvcHRzLm1hcCB8fCBkZWZhdWx0TWFwCiAgICB0aGlzLnJldHJpZXMgPSBvcHRzLnJldHJpZXMgPT09IDAgPyAwIDogb3B0cy5yZXRyaWVzIHx8IDMKICAgIHRoaXMubWF4U2xvdyA9IG9wdHMubWF4U2xvdyA9PT0gMCA/IDAgOiBvcHRzLm1heFNsb3cgfHwgNQogICAgdGhpcy5jbG9zZXN0UmVwbGllcyA9IFtdCgogICAgdGhpcy5fc2xvdyA9IDAKICAgIHRoaXMuX29ubGluZSA9IGZhbHNlCiAgICB0aGlzLl9zbG93ZG93biA9IGZhbHNlCiAgICB0aGlzLl9zZWVuID0gbmV3IE1hcCgpCiAgICB0aGlzLl9wZW5kaW5nID0gW10KICAgIHRoaXMuX2Zyb21UYWJsZSA9IGZhbHNlCiAgICB0aGlzLl9jb21taXQgPSBvcHRzLmNvbW1pdCA9PT0gdHJ1ZSA/IGF1dG9Db21taXQgOiBvcHRzLmNvbW1pdCB8fCBudWxsCiAgICB0aGlzLl9jb21taXRpbmcgPSBmYWxzZQogICAgdGhpcy5fc2Vzc2lvbiA9IG9wdHMuc2Vzc2lvbiB8fCBkaHQuc2Vzc2lvbigpCiAgICB0aGlzLl9hdXRvRGVzdHJveVNlc3Npb24gPSAhb3B0cy5zZXNzaW9uCiAgICB0aGlzLl9vbmx5Q2xvc2VzdE5vZGVzID0gZmFsc2UKCiAgICB0aGlzLl9vbnZpc2l0Ym91bmQgPSB0aGlzLl9vbnZpc2l0LmJpbmQodGhpcykKICAgIHRoaXMuX29uZXJyb3Jib3VuZCA9IHRoaXMuX29uZXJyb3IuYmluZCh0aGlzKQogICAgdGhpcy5fb25jeWNsZWJvdW5kID0gdGhpcy5fb25jeWNsZS5iaW5kKHRoaXMpCgogICAgY29uc3Qgbm9kZXMgPSBvcHRzLm5vZGVzIHx8IG9wdHMuY2xvc2VzdE5vZGVzCiAgICBjb25zdCByZXBsaWVzID0gb3B0cy5yZXBsaWVzIHx8IG9wdHMuY2xvc2VzdFJlcGxpZXMKCiAgICAvLyBhZGQgdGhlbSByZXZlcnNlIGFzIHdlIHBvcCBiZWxvdwogICAgaWYgKG5vZGVzKSB7CiAgICAgIGZvciAobGV0IGkgPSBub2Rlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGNvbnN0IG5vZGUgPSBub2Rlc1tpXQogICAgICAgIHRoaXMuX2FkZFBlbmRpbmcoCiAgICAgICAgICB7CiAgICAgICAgICAgIGlkOiBub2RlLmlkIHx8IHBlZXIuaWQobm9kZS5ob3N0LCBub2RlLnBvcnQpLAogICAgICAgICAgICBob3N0OiBub2RlLmhvc3QsCiAgICAgICAgICAgIHBvcnQ6IG5vZGUucG9ydAogICAgICAgICAgfSwKICAgICAgICAgIG51bGwKICAgICAgICApCiAgICAgIH0KICAgIH0gZWxzZSBpZiAocmVwbGllcykgewogICAgICBmb3IgKGxldCBpID0gcmVwbGllcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIHRoaXMuX2FkZFBlbmRpbmcocmVwbGllc1tpXS5mcm9tLCBudWxsKQogICAgICB9CiAgICB9CgogICAgaWYgKG9wdHMub25seUNsb3Nlc3ROb2RlcykgdGhpcy5fb25seUNsb3Nlc3ROb2RlcyA9IHRydWUKICB9CgogIGdldCBjbG9zZXN0Tm9kZXMoKSB7CiAgICBjb25zdCBub2RlcyA9IG5ldyBBcnJheSh0aGlzLmNsb3Nlc3RSZXBsaWVzLmxlbmd0aCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIG5vZGVzW2ldID0gdGhpcy5jbG9zZXN0UmVwbGllc1tpXS5mcm9tCiAgICB9CgogICAgcmV0dXJuIG5vZGVzCiAgfQoKICBmaW5pc2hlZCgpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgewogICAgICAgIGNvbnN0IGVycm9yID0gZ2V0U3RyZWFtRXJyb3IodGhpcykKICAgICAgICBpZiAoZXJyb3IpIHJlamVjdChlcnJvcikKICAgICAgICBlbHNlIHJlc29sdmUoKQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICBjb25zdCBzZWxmID0gdGhpcwogICAgICBsZXQgZXJyb3IgPSBudWxsCgogICAgICB0aGlzLnJlc3VtZSgpCiAgICAgIHRoaXMub24oJ2Vycm9yJywgb25lcnJvcikKICAgICAgdGhpcy5vbignY2xvc2UnLCBvbmNsb3NlKQoKICAgICAgZnVuY3Rpb24gb25jbG9zZSgpIHsKICAgICAgICBzZWxmLnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIG9uZXJyb3IpCiAgICAgICAgc2VsZi5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBvbmNsb3NlKQogICAgICAgIGlmIChlcnJvcikgcmVqZWN0KGVycm9yKQogICAgICAgIGVsc2UgcmVzb2x2ZSgpCiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIG9uZXJyb3IoZXJyKSB7CiAgICAgICAgZXJyb3IgPSBlcnIKICAgICAgfQogICAgfSkKICB9CgogIF9hZGRGcm9tVGFibGUoKSB7CiAgICBpZiAodGhpcy5fcGVuZGluZy5sZW5ndGggPj0gdGhpcy5rKSByZXR1cm4KICAgIHRoaXMuX2Zyb21UYWJsZSA9IHRydWUKCiAgICBjb25zdCBjbG9zZXN0ID0gdGhpcy5kaHQudGFibGUuY2xvc2VzdCh0aGlzLnRhcmdldCwgdGhpcy5rIC0gdGhpcy5fcGVuZGluZy5sZW5ndGgpCgogICAgZm9yIChjb25zdCBub2RlIG9mIGNsb3Nlc3QpIHsKICAgICAgdGhpcy5fYWRkUGVuZGluZyh7IGlkOiBub2RlLmlkLCBob3N0OiBub2RlLmhvc3QsIHBvcnQ6IG5vZGUucG9ydCB9LCBudWxsKQogICAgfQogIH0KCiAgYXN5bmMgX29wZW4oY2IpIHsKICAgIHRoaXMuX2FkZEZyb21UYWJsZSgpCiAgICBpZiAodGhpcy5fcGVuZGluZy5sZW5ndGggPj0gdGhpcy5rKSByZXR1cm4gY2IobnVsbCkKCiAgICBmb3IgYXdhaXQgKGNvbnN0IG5vZGUgb2YgdGhpcy5kaHQuX3Jlc29sdmVCb290c3RyYXBOb2RlcygpKSB7CiAgICAgIHRoaXMuX2FkZFBlbmRpbmcobm9kZSwgbnVsbCkKICAgIH0KCiAgICBjYihudWxsKQogIH0KCiAgX2lzQ2xvc2VyKGlkKSB7CiAgICByZXR1cm4gKAogICAgICB0aGlzLmNsb3Nlc3RSZXBsaWVzLmxlbmd0aCA8IHRoaXMuayB8fAogICAgICB0aGlzLl9jb21wYXJlKGlkLCB0aGlzLmNsb3Nlc3RSZXBsaWVzW3RoaXMuY2xvc2VzdFJlcGxpZXMubGVuZ3RoIC0gMV0uZnJvbS5pZCkgPCAwCiAgICApCiAgfQoKICBfYWRkUGVuZGluZyhub2RlLCByZWYpIHsKICAgIGlmICh0aGlzLl9vbmx5Q2xvc2VzdE5vZGVzKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBhZGRyID0gbm9kZS5ob3N0ICsgJzonICsgbm9kZS5wb3J0CiAgICBjb25zdCByZWZzID0gdGhpcy5fc2Vlbi5nZXQoYWRkcikKICAgIGNvbnN0IGlzQ2xvc2VyID0gdGhpcy5faXNDbG9zZXIobm9kZS5pZCkKCiAgICBpZiAocmVmcyA9PT0gRE9ORSkgewogICAgICByZXR1cm4gaXNDbG9zZXIKICAgIH0KCiAgICBpZiAocmVmcyA9PT0gRE9XTikgewogICAgICBpZiAocmVmKSB0aGlzLl9kb3duSGludChyZWYsIG5vZGUpCiAgICAgIHJldHVybiBpc0Nsb3NlcgogICAgfQoKICAgIGlmIChyZWZzKSB7CiAgICAgIGlmIChyZWYgIT09IG51bGwpIHJlZnMucHVzaChyZWYpCiAgICAgIHJldHVybiBpc0Nsb3NlcgogICAgfQoKICAgIGlmICghaXNDbG9zZXIpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgdGhpcy5fc2Vlbi5zZXQoYWRkciwgcmVmID09PSBudWxsID8gW10gOiBbcmVmXSkKICAgIHRoaXMuX3BlbmRpbmcucHVzaChub2RlKQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfcmVhZChjYikgewogICAgdGhpcy5fcmVhZE1vcmUoKQogICAgY2IobnVsbCkKICB9CgogIF9yZWFkTW9yZSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3lpbmcgfHwgdGhpcy5fY29tbWl0aW5nKSByZXR1cm4KCiAgICBjb25zdCBjb25jdXJyZW5jeSA9ICh0aGlzLl9zbG93ZG93biA/IDMgOiB0aGlzLmNvbmN1cnJlbmN5KSArIHRoaXMuX3Nsb3cKCiAgICB3aGlsZSAodGhpcy5pbmZsaWdodCA8IGNvbmN1cnJlbmN5ICYmIHRoaXMuX3BlbmRpbmcubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBuZXh0ID0gdGhpcy5fcGVuZGluZy5wb3AoKQogICAgICBpZiAobmV4dCAmJiBuZXh0LmlkICYmICF0aGlzLl9pc0Nsb3NlcihuZXh0LmlkKSkgY29udGludWUKICAgICAgdGhpcy5fdmlzaXQobmV4dCkKICAgIH0KCiAgICAvLyBpZiByZXVzaW5nIGNsb3Nlc3Qgbm9kZXMsIHNsb3cgZG93biBhZnRlciB0aGUgZmlyc3QgcmVhZE1vcmUgdGljayB0byBhbGxvdwogICAgLy8gdGhlIGNsb3Nlc3Qgbm9kZSBhIGNoYW5jZSB0byByZXBseSBiZWZvcmUgZ29pbmcgYnJvYWQgdG8gcXVlc3Rpb24gbW9yZQogICAgaWYgKCF0aGlzLl9mcm9tVGFibGUgJiYgdGhpcy5zdWNjZXNzZXMgPT09IDAgJiYgdGhpcy5lcnJvcnMgPT09IDApIHsKICAgICAgdGhpcy5fc2xvd2Rvd24gPSB0cnVlCiAgICB9CgogICAgaWYgKHRoaXMuX3BlbmRpbmcubGVuZ3RoID4gMCkgcmV0dXJuCgogICAgLy8gaWYgbm8gaW5mbGlnaHQgT1IgYWxsIHRoZSBxdWVyaWVzIHdlIGFyZSB3YWl0aW5nIG9uIGFyZSBtYXJrZWQgYXMgc2xvdyAod2l0aGluIG91ciBsaW1pdHMpIGFuZCB3ZSBoYXZlIGEgZnVsbCByZXN1bHQuCiAgICBpZiAoCiAgICAgIHRoaXMuaW5mbGlnaHQgPT09IDAgfHwKICAgICAgKHRoaXMuX3Nsb3cgPD0gdGhpcy5tYXhTbG93ICYmCiAgICAgICAgdGhpcy5fc2xvdyA9PT0gdGhpcy5pbmZsaWdodCAmJgogICAgICAgIHRoaXMuY2xvc2VzdFJlcGxpZXMubGVuZ3RoID49IHRoaXMuaykKICAgICkgewogICAgICAvLyBpZiBtb3JlIHRoYW4gMy80IGZhaWxlZCBhbmQgd2Ugb25seSB1c2VkIGNhY2hlZCBub2RlcywgdHJ5IGFnYWluIGZyb20gdGhlIHJvdXRpbmcgdGFibGUKICAgICAgaWYgKCF0aGlzLl9mcm9tVGFibGUgJiYgdGhpcy5zdWNjZXNzZXMgPCB0aGlzLmsgLyA0KSB7CiAgICAgICAgdGhpcy5fYWRkRnJvbVRhYmxlKCkKICAgICAgICB0aGlzLl9yZWFkTW9yZSgpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIHRoaXMuX2ZsdXNoKCkKICAgIH0KICB9CgogIF9mbHVzaCgpIHsKICAgIGlmICh0aGlzLl9jb21taXRpbmcpIHJldHVybgogICAgdGhpcy5fY29tbWl0aW5nID0gdHJ1ZQoKICAgIGlmICh0aGlzLl9jb21taXQgPT09IG51bGwpIHsKICAgICAgdGhpcy5wdXNoKG51bGwpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IHAgPSBbXQogICAgZm9yIChjb25zdCBtIG9mIHRoaXMuY2xvc2VzdFJlcGxpZXMpIHAucHVzaCh0aGlzLl9jb21taXQobSwgdGhpcy5kaHQsIHRoaXMpKQogICAgdGhpcy5fZW5kQWZ0ZXJDb21taXQocCkKICB9CgogIF9lbmRBZnRlckNvbW1pdChwcykgewogICAgaWYgKCFwcy5sZW5ndGgpIHsKICAgICAgdGhpcy5kZXN0cm95KG5ldyBFcnJvcignVG9vIGZldyBub2RlcyByZXNwb25kZWQnKSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3Qgc2VsZiA9IHRoaXMKCiAgICBsZXQgcGVuZGluZyA9IHBzLmxlbmd0aAogICAgbGV0IHN1Y2Nlc3MgPSAwCgogICAgZm9yIChjb25zdCBwIG9mIHBzKSBwLnRoZW4ob25kb25lLCBvbmVycm9yKQoKICAgIGZ1bmN0aW9uIG9uZG9uZSgpIHsKICAgICAgc3VjY2VzcysrCiAgICAgIGlmICgtLXBlbmRpbmcgPT09IDApIHNlbGYucHVzaChudWxsKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uZXJyb3IoZXJyKSB7CiAgICAgIGlmICgtLXBlbmRpbmcgPiAwKSByZXR1cm4KICAgICAgaWYgKHN1Y2Nlc3MpIHNlbGYucHVzaChudWxsKQogICAgICBlbHNlIHNlbGYuZGVzdHJveShlcnIpCiAgICB9CiAgfQoKICBfZGVjKHJlcSkgewogICAgaWYgKHJlcS5vbmN5Y2xlID09PSBub29wKSB7CiAgICAgIHRoaXMuX3Nsb3ctLQogICAgfSBlbHNlIHsKICAgICAgcmVxLm9uY3ljbGUgPSBub29wCiAgICB9CiAgICB0aGlzLmluZmxpZ2h0LS0KICB9CgogIF9vbnZpc2l0KG0sIHJlcSkgewogICAgdGhpcy5fZGVjKHJlcSkKCiAgICB0aGlzLl9vbmxpbmUgPSB0cnVlCiAgICBpZiAoIXRoaXMuZGh0Lm9ubGluZSkgdGhpcy5kaHQuX29ubGluZSgpCgogICAgY29uc3QgYWRkciA9IHJlcS50by5ob3N0ICsgJzonICsgcmVxLnRvLnBvcnQKICAgIHRoaXMuX3NlZW4uc2V0KGFkZHIsIERPTkUpCgogICAgaWYgKHRoaXMuX2NvbW1pdGluZykgcmV0dXJuCgogICAgaWYgKG0uZXJyb3IgPT09IDApIHRoaXMuc3VjY2Vzc2VzKysKICAgIGVsc2UgdGhpcy5lcnJvcnMrKwoKICAgIGlmIChtLmVycm9yID09PSAwICYmIG0uZnJvbS5pZCAhPT0gbnVsbCAmJiB0aGlzLl9pc0Nsb3NlcihtLmZyb20uaWQpKSB0aGlzLl9wdXNoQ2xvc2VzdChtKQoKICAgIGlmIChtLmNsb3Nlck5vZGVzICE9PSBudWxsKSB7CiAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiBtLmNsb3Nlck5vZGVzKSB7CiAgICAgICAgbm9kZS5pZCA9IHBlZXIuaWQobm9kZS5ob3N0LCBub2RlLnBvcnQpCiAgICAgICAgaWYgKHRoaXMuZGh0Ll9maWx0ZXJOb2RlICE9PSBudWxsICYmICF0aGlzLmRodC5fZmlsdGVyTm9kZShub2RlKSkgY29udGludWUKICAgICAgICBpZiAoYjRhLmVxdWFscyhub2RlLmlkLCB0aGlzLmRodC50YWJsZS5pZCkpIGNvbnRpbnVlCiAgICAgICAgLy8gVE9ETzogd2UgY291bGQgY29udGludWUgaGVyZSBpbnN0ZWFkIG9mIGJyZWFraW5nIHRvIGVuc3VyZSB0aGF0IG9uZSBvZiB0aGUgbm9kZXMgaW4gdGhlIGNsb3NlciBsaXN0CiAgICAgICAgLy8gaXMgbGF0ZXIgbWFya2VkIGFzIERPV04gdGhhdCB3ZSBnb3NzaXAgdGhhdCBiYWNrCiAgICAgICAgaWYgKCF0aGlzLl9hZGRQZW5kaW5nKG5vZGUsIG0uZnJvbSkpIGJyZWFrCiAgICAgIH0KICAgIH0KCiAgICBpZiAoIXRoaXMuX2Zyb21UYWJsZSAmJiB0aGlzLnN1Y2Nlc3NlcyArIHRoaXMuZXJyb3JzID49IHRoaXMuY29uY3VycmVuY3kpIHsKICAgICAgdGhpcy5fc2xvd2Rvd24gPSBmYWxzZQogICAgfQoKICAgIGlmIChtLmVycm9yICE9PSAwKSB7CiAgICAgIHRoaXMuX3JlYWRNb3JlKCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgZGF0YSA9IHRoaXMubWFwKG0pCiAgICBpZiAoIWRhdGEgfHwgdGhpcy5wdXNoKGRhdGEpICE9PSBmYWxzZSkgewogICAgICB0aGlzLl9yZWFkTW9yZSgpCiAgICB9CiAgfQoKICBfb25lcnJvcihlcnIsIHJlcSkgewogICAgY29uc3QgYWRkciA9IHJlcS50by5ob3N0ICsgJzonICsgcmVxLnRvLnBvcnQKICAgIGNvbnN0IHJlZnMgPSB0aGlzLl9zZWVuLmdldChhZGRyKQoKICAgIGlmIChlcnIuY29kZSA9PT0gJ1JFUVVFU1RfVElNRU9VVCcpIHsKICAgICAgdGhpcy5fc2Vlbi5zZXQoYWRkciwgRE9XTikKICAgICAgZm9yIChjb25zdCBub2RlIG9mIHJlZnMpIHRoaXMuX2Rvd25IaW50KG5vZGUsIHJlcS50bykKICAgIH0KCiAgICB0aGlzLl9kZWMocmVxKQogICAgdGhpcy5lcnJvcnMrKwogICAgdGhpcy5fcmVhZE1vcmUoKQogIH0KCiAgX29uY3ljbGUocmVxKSB7CiAgICByZXEub25jeWNsZSA9IG5vb3AKICAgIHRoaXMuX3Nsb3crKwogICAgdGhpcy5fcmVhZE1vcmUoKQogIH0KCiAgX2Rvd25IaW50KG5vZGUsIGRvd24pIHsKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiA2LCBidWZmZXI6IGI0YS5hbGxvY1Vuc2FmZSg2KSB9CiAgICBwZWVyLmlwdjQuZW5jb2RlKHN0YXRlLCBkb3duKQogICAgdGhpcy5kaHQuX3JlcXVlc3Qobm9kZSwgZmFsc2UsIHRydWUsIERPV05fSElOVCwgbnVsbCwgc3RhdGUuYnVmZmVyLCB0aGlzLl9zZXNzaW9uLCBub29wLCBub29wKQogIH0KCiAgX3B1c2hDbG9zZXN0KG0pIHsKICAgIHRoaXMuY2xvc2VzdFJlcGxpZXMucHVzaChtKQogICAgZm9yIChsZXQgaSA9IHRoaXMuY2xvc2VzdFJlcGxpZXMubGVuZ3RoIC0gMjsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgcHJldiA9IHRoaXMuY2xvc2VzdFJlcGxpZXNbaV0KICAgICAgY29uc3QgY21wID0gdGhpcy5fY29tcGFyZShwcmV2LmZyb20uaWQsIG0uZnJvbS5pZCkKICAgICAgLy8gaWYgc29ydGVkLCBkb25lIQogICAgICBpZiAoY21wIDwgMCkgYnJlYWsKICAgICAgLy8gaWYgZHVwLCBzcGxpY2UgaXQgb3V0IChyYXJlKQogICAgICBpZiAoY21wID09PSAwKSB7CiAgICAgICAgdGhpcy5jbG9zZXN0UmVwbGllcy5zcGxpY2UoaSArIDEsIDEpCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgICAvLyBzd2FwIGFuZCBjb250aW51ZSBkb3duCiAgICAgIHRoaXMuY2xvc2VzdFJlcGxpZXNbaSArIDFdID0gcHJldgogICAgICB0aGlzLmNsb3Nlc3RSZXBsaWVzW2ldID0gbQogICAgfQogICAgaWYgKHRoaXMuY2xvc2VzdFJlcGxpZXMubGVuZ3RoID4gdGhpcy5rKSB0aGlzLmNsb3Nlc3RSZXBsaWVzLnBvcCgpCiAgfQoKICBfY29tcGFyZShhLCBiKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGFbaV0gPT09IGJbaV0pIGNvbnRpbnVlCiAgICAgIGNvbnN0IHQgPSB0aGlzLnRhcmdldFtpXQogICAgICByZXR1cm4gKHQgXiBhW2ldKSAtICh0IF4gYltpXSkKICAgIH0KICAgIHJldHVybiAwCiAgfQoKICBfdmlzaXQodG8pIHsKICAgIHRoaXMuaW5mbGlnaHQrKwoKICAgIGNvbnN0IHJlcSA9IHRoaXMuZGh0Ll9yZXF1ZXN0KAogICAgICB0bywKICAgICAgdGhpcy5mb3JjZSwKICAgICAgdGhpcy5pbnRlcm5hbCwKICAgICAgdGhpcy5jb21tYW5kLAogICAgICB0aGlzLnRhcmdldCwKICAgICAgdGhpcy52YWx1ZSwKICAgICAgdGhpcy5fc2Vzc2lvbiwKICAgICAgdGhpcy5fb252aXNpdGJvdW5kLAogICAgICB0aGlzLl9vbmVycm9yYm91bmQKICAgICkKICAgIGlmIChyZXEgPT09IG51bGwpIHsKICAgICAgdGhpcy5kZXN0cm95KG5ldyBFcnJvcignTm9kZSB3YXMgZGVzdHJveWVkJykpCiAgICAgIHJldHVybgogICAgfQogICAgcmVxLnJldHJpZXMgPSB0aGlzLnJldHJpZXMKICAgIHJlcS5vbmN5Y2xlID0gdGhpcy5fb25jeWNsZWJvdW5kCiAgICBpZiAodGhpcy5mb3JjZSkgcmVxLnJldHJpZXMgPSAwCiAgfQoKICBfZGVzdHJveShjYikgewogICAgdGhpcy5kaHQuc3RhdHMucXVlcmllcy5hY3RpdmUtLQogICAgaWYgKCF0aGlzLl9vbmxpbmUgJiYgdGhpcy5kaHQub25saW5lKSB0aGlzLmRodC5fb2ZmbGluZSgpCiAgICBpZiAodGhpcy5fYXV0b0Rlc3Ryb3lTZXNzaW9uKSB0aGlzLl9zZXNzaW9uLmRlc3Ryb3koKQogICAgY2IobnVsbCkKICB9Cn0KCmZ1bmN0aW9uIGF1dG9Db21taXQocmVwbHksIGRodCwgcXVlcnkpIHsKICBpZiAoIXJlcGx5LnRva2VuKSByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdObyB0b2tlbiByZWNlaXZlZCBmb3IgY2xvc2VzdCBub2RlJykpCiAgcmV0dXJuIGRodC5yZXF1ZXN0KAogICAgewogICAgICB0b2tlbjogcmVwbHkudG9rZW4sCiAgICAgIHRhcmdldDogcXVlcnkudGFyZ2V0LAogICAgICBjb21tYW5kOiBxdWVyeS5jb21tYW5kLAogICAgICB2YWx1ZTogcXVlcnkudmFsdWUKICAgIH0sCiAgICByZXBseS5mcm9tCiAgKQp9CgpmdW5jdGlvbiBkZWZhdWx0TWFwKG0pIHsKICByZXR1cm4gbQp9CgpmdW5jdGlvbiBub29wKCkge30KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBTZXNzaW9uIHsKICBjb25zdHJ1Y3RvcihkaHQpIHsKICAgIHRoaXMuZGh0ID0gZGh0CiAgICB0aGlzLmluZmxpZ2h0ID0gW10KICB9CgogIF9hdHRhY2gocmVxKSB7CiAgICByZXEuaW5kZXggPSB0aGlzLmluZmxpZ2h0LnB1c2gocmVxKSAtIDEKICB9CgogIF9kZXRhY2gocmVxKSB7CiAgICBjb25zdCBpID0gcmVxLmluZGV4CiAgICBpZiAoaSA9PT0gLTEpIHJldHVybgogICAgcmVxLmluZGV4ID0gLTEKCiAgICBpZiAoaSA9PT0gdGhpcy5pbmZsaWdodC5sZW5ndGggLSAxKSB0aGlzLmluZmxpZ2h0LnBvcCgpCiAgICBlbHNlIHsKICAgICAgY29uc3QgcmVxID0gKHRoaXMuaW5mbGlnaHRbaV0gPSB0aGlzLmluZmxpZ2h0LnBvcCgpKQogICAgICByZXEuaW5kZXggPSBpCiAgICB9CiAgfQoKICBxdWVyeSh7IHRhcmdldCwgY29tbWFuZCwgdmFsdWUgfSwgb3B0cyA9IHt9KSB7CiAgICByZXR1cm4gdGhpcy5kaHQucXVlcnkoeyB0YXJnZXQsIGNvbW1hbmQsIHZhbHVlIH0sIHsgLi4ub3B0cywgc2Vzc2lvbjogdGhpcyB9KQogIH0KCiAgcmVxdWVzdCh7IHRva2VuLCBjb21tYW5kLCB0YXJnZXQsIHZhbHVlIH0sIHsgaG9zdCwgcG9ydCB9LCBvcHRzID0ge30pIHsKICAgIHJldHVybiB0aGlzLmRodC5yZXF1ZXN0KAogICAgICB7IHRva2VuLCBjb21tYW5kLCB0YXJnZXQsIHZhbHVlIH0sCiAgICAgIHsgaG9zdCwgcG9ydCB9LAogICAgICB7IC4uLm9wdHMsIHNlc3Npb246IHRoaXMgfQogICAgKQogIH0KCiAgcGluZyh7IGhvc3QsIHBvcnQgfSwgb3B0cyA9IHt9KSB7CiAgICByZXR1cm4gdGhpcy5kaHQucGluZyh7IGhvc3QsIHBvcnQgfSwgeyAuLi5vcHRzLCBzZXNzaW9uOiB0aGlzIH0pCiAgfQoKICBkZXN0cm95KGVycikgewogICAgd2hpbGUgKHRoaXMuaW5mbGlnaHQubGVuZ3RoKSB7CiAgICAgIGNvbnN0IHJlcSA9IHRoaXMuaW5mbGlnaHRbMF0KICAgICAgLy8gcHJldmVudCBkZXN0cm95ZWQgcmVxdWVzdHMgZnJvbSBjb250cmlidXRpbmcgdG8gY29uZ2VzdGlvbiBjb3VudHMKICAgICAgdGhpcy5kaHQuaW8uY29uZ2VzdGlvbi5yZWN2KCkKICAgICAgcmVxLmRlc3Ryb3koZXJyKQogICAgfQogIH0KfQp7CiAgIm5hbWUiOiAiZGh0LXJwYyIsCiAgInZlcnNpb24iOiAiNi4yMC4yIiwKICAiZGVzY3JpcHRpb24iOiAiTWFrZSBSUEMgY2FsbHMgb3ZlciBhIEthZGVtbGlhIGJhc2VkIERIVCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibGliLyouanMiCiAgXSwKICAiaW1wb3J0cyI6IHsKICAgICJldmVudHMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZXZlbnRzIiwKICAgICAgImRlZmF1bHQiOiAiZXZlbnRzIgogICAgfQogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi4xIiwKICAgICJiYXJlLWV2ZW50cyI6ICJeMi4yLjAiLAogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuMTEuMCIsCiAgICAiY29tcGFjdC1lbmNvZGluZy1uZXQiOiAiXjEuMi4wIiwKICAgICJmYXN0LWZpZm8iOiAiXjEuMS4wIiwKICAgICJrYWRlbWxpYS1yb3V0aW5nLXRhYmxlIjogIl4xLjAuMSIsCiAgICAibmF0LXNhbXBsZXIiOiAiXjEuMC4xIiwKICAgICJzb2RpdW0tdW5pdmVyc2FsIjogIl41LjAuMCIsCiAgICAic3RyZWFteCI6ICJeMi4xMy4yIiwKICAgICJ0aW1lLW9yZGVyZWQtc2V0IjogIl4yLjAuMCIsCiAgICAidWR4LW5hdGl2ZSI6ICJeMS41LjMiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMC4wIiwKICAgICJsdW50ZSI6ICJeMS4zLjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiLAogICAgInRlc3Qtc3VzcGVuZCI6ICJeMS4wLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIiwKICAgICJ0ZXN0IjogIm5wbSBydW4gdGVzdDpub2RlICYmIG5wbSBydW4gdGVzdDpiYXJlIiwKICAgICJ0ZXN0OmJhcmUiOiAiYnJpdHRsZS1iYXJlIC0tY292ZXJhZ2UgdGVzdC5qcyIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4gJiYgbHVudGUiLAogICAgInRlc3Q6bm9kZSI6ICJicml0dGxlLW5vZGUgLS1jb3ZlcmFnZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2RodC1ycGMuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2RodC1ycGMvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvZGh0LXJwYyIKfQptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoJ2JhcmUtZXZlbnRzJykKewogICJuYW1lIjogImV2ZW50cy11bml2ZXJzYWwiLAogICJ2ZXJzaW9uIjogIjEuMC4xIiwKICAiZGVzY3JpcHRpb24iOiAiVW5pdmVyc2FsIHdyYXBwZXIgZm9yIHRoZSBOb2RlLmpzIGV2ZW50cyBtb2R1bGUiLAogICJleHBvcnRzIjogewogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLiI6IHsKICAgICAgImJhcmUiOiAiLi9iYXJlLmpzIiwKICAgICAgInJlYWN0LW5hdGl2ZSI6ICIuL3JlYWN0LW5hdGl2ZS5qcyIsCiAgICAgICJkZWZhdWx0IjogIi4vZGVmYXVsdC5qcyIKICAgIH0KICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiZGVmYXVsdC5qcyIsCiAgICAiYmFyZS5qcyIsCiAgICAicmVhY3QtbmF0aXZlLmpzIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJwcmV0dGllciAuIC0tY2hlY2siCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vZXZlbnRzLXVuaXZlcnNhbC5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9ldmVudHMtdW5pdmVyc2FsL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vZXZlbnRzLXVuaXZlcnNhbCNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1ldmVudHMiOiAiXjIuNy4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJwcmV0dGllciI6ICJeMy40LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjEuMC4wIgogIH0KfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEZpeGVkRklGTyB7CiAgY29uc3RydWN0b3IgKGh3bSkgewogICAgaWYgKCEoaHdtID4gMCkgfHwgKChod20gLSAxKSAmIGh3bSkgIT09IDApIHRocm93IG5ldyBFcnJvcignTWF4IHNpemUgZm9yIGEgRml4ZWRGSUZPIHNob3VsZCBiZSBhIHBvd2VyIG9mIHR3bycpCiAgICB0aGlzLmJ1ZmZlciA9IG5ldyBBcnJheShod20pCiAgICB0aGlzLm1hc2sgPSBod20gLSAxCiAgICB0aGlzLnRvcCA9IDAKICAgIHRoaXMuYnRtID0gMAogICAgdGhpcy5uZXh0ID0gbnVsbAogIH0KCiAgY2xlYXIgKCkgewogICAgdGhpcy50b3AgPSB0aGlzLmJ0bSA9IDAKICAgIHRoaXMubmV4dCA9IG51bGwKICAgIHRoaXMuYnVmZmVyLmZpbGwodW5kZWZpbmVkKQogIH0KCiAgcHVzaCAoZGF0YSkgewogICAgaWYgKHRoaXMuYnVmZmVyW3RoaXMudG9wXSAhPT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2UKICAgIHRoaXMuYnVmZmVyW3RoaXMudG9wXSA9IGRhdGEKICAgIHRoaXMudG9wID0gKHRoaXMudG9wICsgMSkgJiB0aGlzLm1hc2sKICAgIHJldHVybiB0cnVlCiAgfQoKICBzaGlmdCAoKSB7CiAgICBjb25zdCBsYXN0ID0gdGhpcy5idWZmZXJbdGhpcy5idG1dCiAgICBpZiAobGFzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdW5kZWZpbmVkCiAgICB0aGlzLmJ1ZmZlclt0aGlzLmJ0bV0gPSB1bmRlZmluZWQKICAgIHRoaXMuYnRtID0gKHRoaXMuYnRtICsgMSkgJiB0aGlzLm1hc2sKICAgIHJldHVybiBsYXN0CiAgfQoKICBwZWVrICgpIHsKICAgIHJldHVybiB0aGlzLmJ1ZmZlclt0aGlzLmJ0bV0KICB9CgogIGlzRW1wdHkgKCkgewogICAgcmV0dXJuIHRoaXMuYnVmZmVyW3RoaXMuYnRtXSA9PT0gdW5kZWZpbmVkCiAgfQp9CmNvbnN0IEZpeGVkRklGTyA9IHJlcXVpcmUoJy4vZml4ZWQtc2l6ZScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEZhc3RGSUZPIHsKICBjb25zdHJ1Y3RvciAoaHdtKSB7CiAgICB0aGlzLmh3bSA9IGh3bSB8fCAxNgogICAgdGhpcy5oZWFkID0gbmV3IEZpeGVkRklGTyh0aGlzLmh3bSkKICAgIHRoaXMudGFpbCA9IHRoaXMuaGVhZAogICAgdGhpcy5sZW5ndGggPSAwCiAgfQoKICBjbGVhciAoKSB7CiAgICB0aGlzLmhlYWQgPSB0aGlzLnRhaWwKICAgIHRoaXMuaGVhZC5jbGVhcigpCiAgICB0aGlzLmxlbmd0aCA9IDAKICB9CgogIHB1c2ggKHZhbCkgewogICAgdGhpcy5sZW5ndGgrKwogICAgaWYgKCF0aGlzLmhlYWQucHVzaCh2YWwpKSB7CiAgICAgIGNvbnN0IHByZXYgPSB0aGlzLmhlYWQKICAgICAgdGhpcy5oZWFkID0gcHJldi5uZXh0ID0gbmV3IEZpeGVkRklGTygyICogdGhpcy5oZWFkLmJ1ZmZlci5sZW5ndGgpCiAgICAgIHRoaXMuaGVhZC5wdXNoKHZhbCkKICAgIH0KICB9CgogIHNoaWZ0ICgpIHsKICAgIGlmICh0aGlzLmxlbmd0aCAhPT0gMCkgdGhpcy5sZW5ndGgtLQogICAgY29uc3QgdmFsID0gdGhpcy50YWlsLnNoaWZ0KCkKICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCAmJiB0aGlzLnRhaWwubmV4dCkgewogICAgICBjb25zdCBuZXh0ID0gdGhpcy50YWlsLm5leHQKICAgICAgdGhpcy50YWlsLm5leHQgPSBudWxsCiAgICAgIHRoaXMudGFpbCA9IG5leHQKICAgICAgcmV0dXJuIHRoaXMudGFpbC5zaGlmdCgpCiAgICB9CgogICAgcmV0dXJuIHZhbAogIH0KCiAgcGVlayAoKSB7CiAgICBjb25zdCB2YWwgPSB0aGlzLnRhaWwucGVlaygpCiAgICBpZiAodmFsID09PSB1bmRlZmluZWQgJiYgdGhpcy50YWlsLm5leHQpIHJldHVybiB0aGlzLnRhaWwubmV4dC5wZWVrKCkKICAgIHJldHVybiB2YWwKICB9CgogIGlzRW1wdHkgKCkgewogICAgcmV0dXJuIHRoaXMubGVuZ3RoID09PSAwCiAgfQp9CnsKICAibmFtZSI6ICJmYXN0LWZpZm8iLAogICJ2ZXJzaW9uIjogIjEuMy4yIiwKICAiZGVzY3JpcHRpb24iOiAiQSBmYXN0IGZpZm8gaW1wbGVtZW50YXRpb24gc2ltaWxhciB0byB0aGUgb25lIHBvd2VyaW5nIG5leHRUaWNrIGluIE5vZGUuanMgY29yZSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICIuL2luZGV4LmpzIiwKICAgICIuL2ZpeGVkLXNpemUuanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4wIiwKICAgICJicml0dGxlIjogIl4zLjMuMiIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2Zhc3QtZmlmby5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvZmFzdC1maWZvL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2Zhc3QtZmlmbyIKfQpjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJykKY29uc3QgZnN4ID0gcmVxdWlyZSgnZnMtbmF0aXZlLWV4dGVuc2lvbnMnKQpjb25zdCBvbmV4aXQgPSByZXF1aXJlKCdyZXNvdXJjZS1vbi1leGl0JykKY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgRkRMb2NrIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IoZmQsIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyB3YWl0ID0gZmFsc2UgfSA9IG9wdHMKCiAgICBzdXBlcigpCgogICAgdGhpcy5fZmQgPSBmZAogICAgdGhpcy5fd2FpdCA9IHdhaXQKICAgIHRoaXMuX2xvY2tlZCA9IGZhbHNlCgogICAgb25leGl0LmFkZCh0aGlzLCBjbG9zZVN5bmMpCiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX3Jlc3VtZSgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgb25leGl0LnJlbW92ZSh0aGlzKQogICAgICBhd2FpdCBjbG9zZSh0aGlzKQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIGFzeW5jIF9jbG9zZSgpIHsKICAgIG9uZXhpdC5yZW1vdmUodGhpcykKICAgIGF3YWl0IGNsb3NlKHRoaXMpCiAgfQoKICB0cmFuc2ZlcigpIHsKICAgIGNvbnN0IGZkID0gdGhpcy5fZmQKICAgIGlmIChmZCA9PT0gLTEpIHRocm93IG5ldyBFcnJvcignTG9jayBoYXMgYWxyZWFkeSBiZWVuIHRyYW5zZmVycmVkJykKICAgIHRoaXMuX2ZkID0gLTEKICAgIG9uZXhpdC5yZW1vdmUodGhpcykKICAgIHJldHVybiBmZAogIH0KCiAgYXN5bmMgc3VzcGVuZCgpIHsKICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgcmV0dXJuIHRoaXMuX3N1c3BlbmQoKQogIH0KCiAgYXN5bmMgX3N1c3BlbmQoKSB7CiAgICBpZiAodGhpcy5fZmQgPT09IC0xIHx8IHRoaXMuX2xvY2tlZCA9PT0gZmFsc2UpIHJldHVybgogICAgZnN4LnVubG9jayh0aGlzLl9mZCkKICAgIHRoaXMuX2xvY2tlZCA9IGZhbHNlCiAgfQoKICBhc3luYyByZXN1bWUoKSB7CiAgICBpZiAoIXRoaXMub3BlbmVkKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIHJldHVybiB0aGlzLl9yZXN1bWUoKQogIH0KCiAgYXN5bmMgX3Jlc3VtZSgpIHsKICAgIGlmICh0aGlzLl9mZCA9PT0gLTEgfHwgdGhpcy5fbG9ja2VkID09PSB0cnVlKSByZXR1cm4KICAgIGlmICh0aGlzLl93YWl0KSBhd2FpdCBmc3gud2FpdEZvckxvY2sodGhpcy5fZmQpCiAgICBlbHNlIGlmICghZnN4LnRyeUxvY2sodGhpcy5fZmQpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignRmlsZSBkZXNjcmlwdG9yIGNvdWxkIG5vdCBiZSBsb2NrZWQnKQogICAgfQogICAgdGhpcy5fbG9ja2VkID0gdHJ1ZQogIH0KfQoKZnVuY3Rpb24gY2xvc2UobG9jaykgewogIGNvbnN0IGZkID0gbG9jay5fZmQKICBpZiAoZmQgPT09IC0xKSByZXR1cm4KICBsb2NrLl9mZCA9IC0xCiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBmcy5jbG9zZShmZCwgKCkgPT4gcmVzb2x2ZSgpKSkKfQoKZnVuY3Rpb24gY2xvc2VTeW5jKGxvY2spIHsKICBjb25zdCBmZCA9IGxvY2suX2ZkCiAgaWYgKGZkID09PSAtMSkgcmV0dXJuCiAgbG9jay5fZmQgPSAtMQogIHRyeSB7CiAgICBmcy5jbG9zZVN5bmMoZmQpCiAgfSBjYXRjaCB7fQp9CnsKICAibmFtZSI6ICJmZC1sb2NrIiwKICAidmVyc2lvbiI6ICIyLjEuMSIsCiAgImRlc2NyaXB0aW9uIjogIlN0YXRlZnVsIGZpbGUgZGVzY3JpcHRvciBsb2NrcyBmb3IgSmF2YVNjcmlwdCIsCiAgImV4cG9ydHMiOiB7CiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuIjogIi4vaW5kZXguanMiCiAgfSwKICAiaW1wb3J0cyI6IHsKICAgICJmcyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1mcyIsCiAgICAgICJkZWZhdWx0IjogImZzIgogICAgfQogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJucG0gcnVuIGxpbnQgJiYgbnBt","IHJ1biB0ZXN0OmJhcmUgJiYgbnBtIHJ1biB0ZXN0Om5vZGUiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QuanMiLAogICAgInRlc3Q6bm9kZSI6ICJub2RlIHRlc3QuanMiLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuIiwKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2ZkLWxvY2suZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vZmQtbG9jay9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2ZkLWxvY2sjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtZnMiOiAiXjQuNS4wIiwKICAgICJmcy1uYXRpdmUtZXh0ZW5zaW9ucyI6ICJeMS40LjQiLAogICAgInJlYWR5LXJlc291cmNlIjogIl4xLjIuMCIsCiAgICAicmVzb3VyY2Utb24tZXhpdCI6ICJeMS4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMy4yIiwKICAgICJwcmV0dGllciI6ICJeMy40LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0KfQpleHBvcnRzLmZ1bGxSb290cyA9IGZ1bmN0aW9uIChpbmRleCwgcmVzdWx0KSB7CiAgaWYgKGluZGV4ICYgMSkgdGhyb3cgbmV3IEVycm9yKCdZb3UgY2FuIG9ubHkgbG9vayB1cCByb290cyBmb3IgZGVwdGgoMCkgYmxvY2tzJykKICBpZiAoIXJlc3VsdCkgcmVzdWx0ID0gW10KCiAgaW5kZXggLz0gMgoKICBsZXQgb2Zmc2V0ID0gMAogIGxldCBmYWN0b3IgPSAxCgogIHdoaWxlICh0cnVlKSB7CiAgICBpZiAoIWluZGV4KSByZXR1cm4gcmVzdWx0CiAgICB3aGlsZSAoZmFjdG9yICogMiA8PSBpbmRleCkgZmFjdG9yICo9IDIKICAgIHJlc3VsdC5wdXNoKG9mZnNldCArIGZhY3RvciAtIDEpCiAgICBvZmZzZXQgPSBvZmZzZXQgKyAyICogZmFjdG9yCiAgICBpbmRleCAtPSBmYWN0b3IKICAgIGZhY3RvciA9IDEKICB9Cn0KCmV4cG9ydHMuZnV0dXJlUm9vdHMgPSBmdW5jdGlvbiAoaW5kZXgsIHJlc3VsdCkgewogIGlmIChpbmRleCAmIDEpIHRocm93IG5ldyBFcnJvcignWW91IGNhbiBvbmx5IGxvb2sgdXAgZnV0dXJlIHJvb3RzIGZvciBkZXB0aCgwKSBibG9ja3MnKQogIGlmICghcmVzdWx0KSByZXN1bHQgPSBbXQoKICBsZXQgZmFjdG9yID0gMQoKICAvLyBtYWtlIGZpcnN0IHJvb3QKICB3aGlsZSAoZmFjdG9yICogMiA8PSBpbmRleCkgZmFjdG9yICo9IDIKCiAgLy8gZnVsbCBmYWN0b3Igb2YgMiAtIGRvbmUKICBpZiAoZmFjdG9yICogMiAtIDIgPT09IGluZGV4KSByZXR1cm4gcmVzdWx0CgogIGxldCBwb3MgPSBmYWN0b3IgLyAyIC0gMQoKICAvLyB3aGlsZSBpdHMgbm90IGEgZnVsbCB0cmVlCiAgd2hpbGUgKChwb3MgKyBmYWN0b3IgLyAyIC0gMSkgIT09IGluZGV4KSB7CiAgICBwb3MgKz0gZmFjdG9yCgogICAgLy8gcmVhZCB0b28gZmFyLCB0byB0byBsZWZ0IGNoaWxkCiAgICB3aGlsZSAoKHBvcyArIGZhY3RvciAvIDIgLSAxKSA+IGluZGV4KSB7CiAgICAgIGZhY3RvciAvPSAyCiAgICAgIHBvcyAtPSBmYWN0b3IgLyAyCiAgICB9CgogICAgLy8gdGhlICJnYXAiIGlzIGEgZnV0dXJlIHJvb3QKICAgIHJlc3VsdC5wdXNoKHBvcyAtIGZhY3RvciAvIDIpCiAgfQoKICByZXR1cm4gcmVzdWx0Cn0KCmV4cG9ydHMucGF0Y2ggPSBmdW5jdGlvbiAoZnJvbSwgdG8pIHsKICBpZiAoZnJvbSA9PT0gMCB8fCBmcm9tID49IHRvKSByZXR1cm4gW10KCiAgY29uc3Qgcm9vdHMgPSBleHBvcnRzLmZ1bGxSb290cyhmcm9tKQogIGNvbnN0IHRhcmdldCA9IGV4cG9ydHMuZnVsbFJvb3RzKHRvKQoKICAvLyBmaXJzdCBmaW5kIHRoZSBmaXJzdCByb290IHRoYXQgaXMgZGlmZmVyZW50CgogIGxldCBpID0gMAogIGZvciAoOyBpIDwgdGFyZ2V0Lmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoaSA+PSByb290cy5sZW5ndGggfHwgcm9vdHNbaV0gIT09IHRhcmdldFtpXSkgYnJlYWsKICB9CgogIGNvbnN0IHBhdGNoID0gW10KCiAgaWYgKGkgPCByb290cy5sZW5ndGgpIHsKICAgIC8vIG5vdyB3ZSBuZWVkIHRvIGdyb3cgdGhlIG5ld2VzdCByb290IHVudGlsIGl0IGhpdHMgdGhlIGRpZmYgb25lCiAgICBsZXQgcHJldiA9IHJvb3RzLmxlbmd0aCAtIDEKCiAgICBjb25zdCBpdGUgPSBleHBvcnRzLml0ZXJhdG9yKHJvb3RzW3ByZXYtLV0pCgogICAgd2hpbGUgKGl0ZS5pbmRleCAhPT0gdGFyZ2V0W2ldKSB7CiAgICAgIGl0ZS5zaWJsaW5nKCkKCiAgICAgIGlmIChwcmV2ID49IDAgJiYgaXRlLmluZGV4ID09PSByb290c1twcmV2XSkgewogICAgICAgIHByZXYtLQogICAgICB9IGVsc2UgewogICAgICAgIHBhdGNoLnB1c2goaXRlLmluZGV4KQogICAgICB9CgogICAgICBwYXRjaC5wdXNoKGl0ZS5wYXJlbnQoKSkKICAgIH0KCiAgICBpKysgLy8gcGF0Y2hlZCB0byBuZXh0IHJvb3QsIHNvIGluYwogIH0KCiAgLy8gaW5jbHVkZSB0aGUgcmVzdAoKICBmb3IgKDsgaSA8IHRhcmdldC5sZW5ndGg7IGkrKykgcGF0Y2gucHVzaCh0YXJnZXRbaV0pCgogIHJldHVybiBwYXRjaAp9CgpleHBvcnRzLmRlcHRoID0gZnVuY3Rpb24gKGluZGV4KSB7CiAgbGV0IGRlcHRoID0gMAoKICBpbmRleCArPSAxCiAgd2hpbGUgKCEoaW5kZXggJiAxKSkgewogICAgZGVwdGgrKwogICAgaW5kZXggPSByaWdodFNoaWZ0KGluZGV4KQogIH0KCiAgcmV0dXJuIGRlcHRoCn0KCmV4cG9ydHMuc2libGluZyA9IGZ1bmN0aW9uIChpbmRleCwgZGVwdGgpIHsKICBpZiAoIWRlcHRoKSBkZXB0aCA9IGV4cG9ydHMuZGVwdGgoaW5kZXgpCiAgY29uc3Qgb2Zmc2V0ID0gZXhwb3J0cy5vZmZzZXQoaW5kZXgsIGRlcHRoKQoKICByZXR1cm4gZXhwb3J0cy5pbmRleChkZXB0aCwgb2Zmc2V0ICYgMSA/IG9mZnNldCAtIDEgOiBvZmZzZXQgKyAxKQp9CgpleHBvcnRzLnBhcmVudCA9IGZ1bmN0aW9uIChpbmRleCwgZGVwdGgpIHsKICBpZiAoIWRlcHRoKSBkZXB0aCA9IGV4cG9ydHMuZGVwdGgoaW5kZXgpCiAgY29uc3Qgb2Zmc2V0ID0gZXhwb3J0cy5vZmZzZXQoaW5kZXgsIGRlcHRoKQoKICByZXR1cm4gZXhwb3J0cy5pbmRleChkZXB0aCArIDEsIHJpZ2h0U2hpZnQob2Zmc2V0KSkKfQoKZXhwb3J0cy5sZWZ0Q2hpbGQgPSBmdW5jdGlvbiAoaW5kZXgsIGRlcHRoKSB7CiAgaWYgKCEoaW5kZXggJiAxKSkgcmV0dXJuIC0xCiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQogIHJldHVybiBleHBvcnRzLmluZGV4KGRlcHRoIC0gMSwgZXhwb3J0cy5vZmZzZXQoaW5kZXgsIGRlcHRoKSAqIDIpCn0KCmV4cG9ydHMucmlnaHRDaGlsZCA9IGZ1bmN0aW9uIChpbmRleCwgZGVwdGgpIHsKICBpZiAoIShpbmRleCAmIDEpKSByZXR1cm4gLTEKICBpZiAoIWRlcHRoKSBkZXB0aCA9IGV4cG9ydHMuZGVwdGgoaW5kZXgpCiAgcmV0dXJuIGV4cG9ydHMuaW5kZXgoZGVwdGggLSAxLCAxICsgKGV4cG9ydHMub2Zmc2V0KGluZGV4LCBkZXB0aCkgKiAyKSkKfQoKZXhwb3J0cy5jaGlsZHJlbiA9IGZ1bmN0aW9uIChpbmRleCwgZGVwdGgpIHsKICBpZiAoIShpbmRleCAmIDEpKSByZXR1cm4gbnVsbAoKICBpZiAoIWRlcHRoKSBkZXB0aCA9IGV4cG9ydHMuZGVwdGgoaW5kZXgpCiAgY29uc3Qgb2Zmc2V0ID0gZXhwb3J0cy5vZmZzZXQoaW5kZXgsIGRlcHRoKSAqIDIKCiAgcmV0dXJuIFsKICAgIGV4cG9ydHMuaW5kZXgoZGVwdGggLSAxLCBvZmZzZXQpLAogICAgZXhwb3J0cy5pbmRleChkZXB0aCAtIDEsIG9mZnNldCArIDEpCiAgXQp9CgpleHBvcnRzLmxlZnRTcGFuID0gZnVuY3Rpb24gKGluZGV4LCBkZXB0aCkgewogIGlmICghKGluZGV4ICYgMSkpIHJldHVybiBpbmRleAogIGlmICghZGVwdGgpIGRlcHRoID0gZXhwb3J0cy5kZXB0aChpbmRleCkKICByZXR1cm4gZXhwb3J0cy5vZmZzZXQoaW5kZXgsIGRlcHRoKSAqIHR3b1BvdyhkZXB0aCArIDEpCn0KCmV4cG9ydHMucmlnaHRTcGFuID0gZnVuY3Rpb24gKGluZGV4LCBkZXB0aCkgewogIGlmICghKGluZGV4ICYgMSkpIHJldHVybiBpbmRleAogIGlmICghZGVwdGgpIGRlcHRoID0gZXhwb3J0cy5kZXB0aChpbmRleCkKICByZXR1cm4gKGV4cG9ydHMub2Zmc2V0KGluZGV4LCBkZXB0aCkgKyAxKSAqIHR3b1BvdyhkZXB0aCArIDEpIC0gMgp9CgpleHBvcnRzLm5leHRMZWFmID0gZnVuY3Rpb24gKGluZGV4KSB7CiAgbGV0IGZhY3RvciA9IDEKICBsZXQgciA9IGluZGV4CgogIHdoaWxlICgociAmIDEpID09PSAxKSB7CiAgICByID0gKHIgLSAxKSAvIDIKICAgIGZhY3RvciAqPSAyCiAgfQoKICByZXR1cm4gaW5kZXggKyBmYWN0b3IgKyAxCn0KCmV4cG9ydHMuY291bnQgPSBmdW5jdGlvbiAoaW5kZXgsIGRlcHRoKSB7CiAgaWYgKCEoaW5kZXggJiAxKSkgcmV0dXJuIDEKICBpZiAoIWRlcHRoKSBkZXB0aCA9IGV4cG9ydHMuZGVwdGgoaW5kZXgpCiAgcmV0dXJuIHR3b1BvdyhkZXB0aCArIDEpIC0gMQp9CgpleHBvcnRzLmNvdW50TGVhdmVzID0gZnVuY3Rpb24gKGluZGV4KSB7CiAgcmV0dXJuIChleHBvcnRzLmNvdW50KGluZGV4KSArIDEpIC8gMgp9CgpleHBvcnRzLnNwYW5zID0gZnVuY3Rpb24gKGluZGV4LCBkZXB0aCkgewogIGlmICghKGluZGV4ICYgMSkpIHJldHVybiBbaW5kZXgsIGluZGV4XQogIGlmICghZGVwdGgpIGRlcHRoID0gZXhwb3J0cy5kZXB0aChpbmRleCkKCiAgY29uc3Qgb2Zmc2V0ID0gZXhwb3J0cy5vZmZzZXQoaW5kZXgsIGRlcHRoKQogIGNvbnN0IHdpZHRoID0gdHdvUG93KGRlcHRoICsgMSkKCiAgcmV0dXJuIFtvZmZzZXQgKiB3aWR0aCwgKG9mZnNldCArIDEpICogd2lkdGggLSAyXQp9CgpleHBvcnRzLmluZGV4ID0gZnVuY3Rpb24gKGRlcHRoLCBvZmZzZXQpIHsKICByZXR1cm4gKDEgKyAyICogb2Zmc2V0KSAqIHR3b1BvdyhkZXB0aCkgLSAxCn0KCmV4cG9ydHMub2Zmc2V0ID0gZnVuY3Rpb24gKGluZGV4LCBkZXB0aCkgewogIGlmICghKGluZGV4ICYgMSkpIHJldHVybiBpbmRleCAvIDIKICBpZiAoIWRlcHRoKSBkZXB0aCA9IGV4cG9ydHMuZGVwdGgoaW5kZXgpCgogIHJldHVybiAoKGluZGV4ICsgMSkgLyB0d29Qb3coZGVwdGgpIC0gMSkgLyAyCn0KCmV4cG9ydHMuaXRlcmF0b3IgPSBmdW5jdGlvbiAoaW5kZXgpIHsKICBjb25zdCBpdGUgPSBuZXcgSXRlcmF0b3IoKQogIGl0ZS5zZWVrKGluZGV4IHx8IDApCiAgcmV0dXJuIGl0ZQp9CgpmdW5jdGlvbiB0d29Qb3cgKG4pIHsKICByZXR1cm4gbiA8IDMxID8gMSA8PCBuIDogKCgxIDw8IDMwKSAqICgxIDw8IChuIC0gMzApKSkKfQoKZnVuY3Rpb24gcmlnaHRTaGlmdCAobikgewogIHJldHVybiAobiAtIChuICYgMSkpIC8gMgp9CgpmdW5jdGlvbiBJdGVyYXRvciAoKSB7CiAgdGhpcy5pbmRleCA9IDAKICB0aGlzLm9mZnNldCA9IDAKICB0aGlzLmZhY3RvciA9IDAKfQoKSXRlcmF0b3IucHJvdG90eXBlLnNlZWsgPSBmdW5jdGlvbiAoaW5kZXgpIHsKICB0aGlzLmluZGV4ID0gaW5kZXgKICBpZiAodGhpcy5pbmRleCAmIDEpIHsKICAgIHRoaXMub2Zmc2V0ID0gZXhwb3J0cy5vZmZzZXQoaW5kZXgpCiAgICB0aGlzLmZhY3RvciA9IHR3b1BvdyhleHBvcnRzLmRlcHRoKGluZGV4KSArIDEpCiAgfSBlbHNlIHsKICAgIHRoaXMub2Zmc2V0ID0gaW5kZXggLyAyCiAgICB0aGlzLmZhY3RvciA9IDIKICB9Cn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5pc0xlZnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuICh0aGlzLm9mZnNldCAmIDEpID09PSAwCn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5pc1JpZ2h0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiAodGhpcy5vZmZzZXQgJiAxKSA9PT0gMQp9CgpJdGVyYXRvci5wcm90b3R5cGUuaXNSb290ID0gZnVuY3Rpb24gKGxlbmd0aCkgewogIGNvbnN0IGN1cnJlbnRMZW5ndGggPSAxICsgKHRoaXMuaW5kZXggKyB0aGlzLmZhY3RvciAvIDIgLSAxKSAvIDIKICBpZiAobGVuZ3RoIDwgY3VycmVudExlbmd0aCkgcmV0dXJuIGZhbHNlCgogIGNvbnN0IGZhY3RvciA9IHRoaXMuZmFjdG9yICogMgogIGNvbnN0IGluZGV4ID0gKHRoaXMub2Zmc2V0ICYgMSkKICAgID8gdGhpcy5pbmRleCAtIHRoaXMuZmFjdG9yIC8gMgogICAgOiB0aGlzLmluZGV4ICsgdGhpcy5mYWN0b3IgLyAyCgogIGNvbnN0IHBhcmVudExlbmd0aCA9IDEgKyAoaW5kZXggKyBmYWN0b3IgLyAyIC0gMSkgLyAyCiAgcmV0dXJuIHBhcmVudExlbmd0aCA+IGxlbmd0aAp9CgpJdGVyYXRvci5wcm90b3R5cGUuY29udGFpbnMgPSBmdW5jdGlvbiAoaW5kZXgpIHsKICByZXR1cm4gaW5kZXggPiB0aGlzLmluZGV4CiAgICA/IGluZGV4IDwgKHRoaXMuaW5kZXggKyB0aGlzLmZhY3RvciAvIDIpCiAgICA6IGluZGV4IDwgdGhpcy5pbmRleAogICAgICA/IGluZGV4ID4gKHRoaXMuaW5kZXggLSB0aGlzLmZhY3RvciAvIDIpCiAgICAgIDogdHJ1ZQp9CgpJdGVyYXRvci5wcm90b3R5cGUucHJldiA9IGZ1bmN0aW9uICgpIHsKICBpZiAoIXRoaXMub2Zmc2V0KSByZXR1cm4gdGhpcy5pbmRleAogIHRoaXMub2Zmc2V0LS0KICB0aGlzLmluZGV4IC09IHRoaXMuZmFjdG9yCiAgcmV0dXJuIHRoaXMuaW5kZXgKfQoKSXRlcmF0b3IucHJvdG90eXBlLm5leHQgPSBmdW5jdGlvbiAoKSB7CiAgdGhpcy5vZmZzZXQrKwogIHRoaXMuaW5kZXggKz0gdGhpcy5mYWN0b3IKICByZXR1cm4gdGhpcy5pbmRleAp9CgpJdGVyYXRvci5wcm90b3R5cGUuY291bnQgPSBmdW5jdGlvbiAoKSB7CiAgaWYgKCEodGhpcy5pbmRleCAmIDEpKSByZXR1cm4gMQogIHJldHVybiB0aGlzLmZhY3RvciAtIDEKfQoKSXRlcmF0b3IucHJvdG90eXBlLmNvdW50TGVhdmVzID0gZnVuY3Rpb24gKCkgewogIHJldHVybiAodGhpcy5jb3VudCgpICsgMSkgLyAyCn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5zaWJsaW5nID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLmlzTGVmdCgpID8gdGhpcy5uZXh0KCkgOiB0aGlzLnByZXYoKQp9CgpJdGVyYXRvci5wcm90b3R5cGUucGFyZW50ID0gZnVuY3Rpb24gKCkgewogIGlmICh0aGlzLm9mZnNldCAmIDEpIHsKICAgIHRoaXMuaW5kZXggLT0gdGhpcy5mYWN0b3IgLyAyCiAgICB0aGlzLm9mZnNldCA9ICh0aGlzLm9mZnNldCAtIDEpIC8gMgogIH0gZWxzZSB7CiAgICB0aGlzLmluZGV4ICs9IHRoaXMuZmFjdG9yIC8gMgogICAgdGhpcy5vZmZzZXQgLz0gMgogIH0KICB0aGlzLmZhY3RvciAqPSAyCiAgcmV0dXJuIHRoaXMuaW5kZXgKfQoKSXRlcmF0b3IucHJvdG90eXBlLmxlZnRTcGFuID0gZnVuY3Rpb24gKCkgewogIHRoaXMuaW5kZXggPSB0aGlzLmluZGV4IC0gdGhpcy5mYWN0b3IgLyAyICsgMQogIHRoaXMub2Zmc2V0ID0gdGhpcy5pbmRleCAvIDIKICB0aGlzLmZhY3RvciA9IDIKICByZXR1cm4gdGhpcy5pbmRleAp9CgpJdGVyYXRvci5wcm90b3R5cGUucGVla0xlZnRTcGFuID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLmluZGV4IC0gdGhpcy5mYWN0b3IgLyAyICsgMQp9CgpJdGVyYXRvci5wcm90b3R5cGUucmlnaHRTcGFuID0gZnVuY3Rpb24gKCkgewogIHRoaXMuaW5kZXggPSB0aGlzLmluZGV4ICsgdGhpcy5mYWN0b3IgLyAyIC0gMQogIHRoaXMub2Zmc2V0ID0gdGhpcy5pbmRleCAvIDIKICB0aGlzLmZhY3RvciA9IDIKICByZXR1cm4gdGhpcy5pbmRleAp9CgpJdGVyYXRvci5wcm90b3R5cGUucGVla1JpZ2h0U3BhbiA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5pbmRleCArIHRoaXMuZmFjdG9yIC8gMiAtIDEKfQoKSXRlcmF0b3IucHJvdG90eXBlLmxlZnRDaGlsZCA9IGZ1bmN0aW9uICgpIHsKICBpZiAodGhpcy5mYWN0b3IgPT09IDIpIHJldHVybiB0aGlzLmluZGV4CiAgdGhpcy5mYWN0b3IgLz0gMgogIHRoaXMuaW5kZXggLT0gdGhpcy5mYWN0b3IgLyAyCiAgdGhpcy5vZmZzZXQgKj0gMgogIHJldHVybiB0aGlzLmluZGV4Cn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5yaWdodENoaWxkID0gZnVuY3Rpb24gKCkgewogIGlmICh0aGlzLmZhY3RvciA9PT0gMikgcmV0dXJuIHRoaXMuaW5kZXgKICB0aGlzLmZhY3RvciAvPSAyCiAgdGhpcy5pbmRleCArPSB0aGlzLmZhY3RvciAvIDIKICB0aGlzLm9mZnNldCA9IDIgKiB0aGlzLm9mZnNldCArIDEKICByZXR1cm4gdGhpcy5pbmRleAp9CgpJdGVyYXRvci5wcm90b3R5cGUubmV4dFRyZWUgPSBmdW5jdGlvbiAoKSB7CiAgdGhpcy5pbmRleCA9IHRoaXMuaW5kZXggKyB0aGlzLmZhY3RvciAvIDIgKyAxCiAgdGhpcy5vZmZzZXQgPSB0aGlzLmluZGV4IC8gMgogIHRoaXMuZmFjdG9yID0gMgogIHJldHVybiB0aGlzLmluZGV4Cn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5wcmV2VHJlZSA9IGZ1bmN0aW9uICgpIHsKICBpZiAoIXRoaXMub2Zmc2V0KSB7CiAgICB0aGlzLmluZGV4ID0gMAogICAgdGhpcy5mYWN0b3IgPSAyCiAgfSBlbHNlIHsKICAgIHRoaXMuaW5kZXggPSB0aGlzLmluZGV4IC0gdGhpcy5mYWN0b3IgLyAyIC0gMQogICAgdGhpcy5vZmZzZXQgPSB0aGlzLmluZGV4IC8gMgogICAgdGhpcy5mYWN0b3IgPSAyCiAgfQogIHJldHVybiB0aGlzLmluZGV4Cn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5mdWxsUm9vdCA9IGZ1bmN0aW9uIChpbmRleCkgewogIGlmIChpbmRleCA8PSB0aGlzLmluZGV4IHx8ICh0aGlzLmluZGV4ICYgMSkgPiAwKSByZXR1cm4gZmFsc2UKICB3aGlsZSAoaW5kZXggPiB0aGlzLmluZGV4ICsgdGhpcy5mYWN0b3IgKyB0aGlzLmZhY3RvciAvIDIpIHsKICAgIHRoaXMuaW5kZXggKz0gdGhpcy5mYWN0b3IgLyAyCiAgICB0aGlzLmZhY3RvciAqPSAyCiAgICB0aGlzLm9mZnNldCAvPSAyCiAgfQogIHJldHVybiB0cnVlCn0KewogICJuYW1lIjogImZsYXQtdHJlZSIsCiAgInZlcnNpb24iOiAiMS4xMy4wIiwKICAiZGVzY3JpcHRpb24iOiAiQSBzZXJpZXMgb2YgZnVuY3Rpb25zIHRvIG1hcCBhIGJpbmFyeSB0cmVlIHRvIGEgbGlzdCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMy4yIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvZmxhdC10cmVlLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9mbGF0LXRyZWUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvZmxhdC10cmVlIgp9CnJlcXVpcmUuYWRkb24gPSByZXF1aXJlKCdyZXF1aXJlLWFkZG9uJykKCm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZS5hZGRvbignLicsIF9fZmlsZW5hbWUpCmNvbnN0IHsgaXNXaW5kb3dzIH0gPSByZXF1aXJlKCd3aGljaC1ydW50aW1lJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4vYmluZGluZycpCgpmdW5jdGlvbiBvbndvcmsoZXJyLCByZXN1bHQpIHsKICBpZiAoZXJyKSB0aGlzLnJlamVjdChlcnIpCiAgZWxzZSB0aGlzLnJlc29sdmUocmVzdWx0KQp9CgpleHBvcnRzLnRyeUxvY2sgPSBmdW5jdGlvbiB0cnlMb2NrKGZkLCBvZmZzZXQgPSAwLCBsZW5ndGggPSAwLCBvcHRzID0ge30pIHsKICBpZiAodHlwZW9mIG9mZnNldCA9PT0gJ29iamVjdCcpIHsKICAgIG9wdHMgPSBvZmZzZXQKICAgIG9mZnNldCA9IDAKICB9CgogIGlmICh0eXBlb2YgbGVuZ3RoID09PSAnb2JqZWN0JykgewogICAgb3B0cyA9IGxlbmd0aAogICAgbGVuZ3RoID0gMAogIH0KCiAgaWYgKHR5cGVvZiBvcHRzICE9PSAnb2JqZWN0JyB8fCBvcHRzID09PSBudWxsKSB7CiAgICBvcHRzID0ge30KICB9CgogIHRyeSB7CiAgICBiaW5kaW5nLnRyeUxvY2soZmQsIG9mZnNldCwgbGVuZ3RoLCBvcHRzLnNoYXJlZCAhPT0gdHJ1ZSkKICB9IGNhdGNoIChlcnIpIHsKICAgIGlmIChlcnIuY29kZSA9PT0gJ0VBR0FJTicpIHJldHVybiBmYWxzZQogICAgdGhyb3cgZXJyCiAgfQoKICByZXR1cm4gdHJ1ZQp9CgpleHBvcnRzLndhaXRGb3JMb2NrID0gZnVuY3Rpb24gd2FpdEZvckxvY2soCiAgZmQsCiAgb2Zmc2V0ID0gMCwKICBsZW5ndGggPSAwLAogIG9wdHMgPSB7fQopIHsKICBpZiAodHlwZW9mIG9mZnNldCA9PT0gJ29iamVjdCcpIHsKICAgIG9wdHMgPSBvZmZzZXQKICAgIG9mZnNldCA9IDAKICB9CgogIGlmICh0eXBlb2YgbGVuZ3RoID09PSAnb2JqZWN0JykgewogICAgb3B0cyA9IGxlbmd0aAogICAgbGVuZ3RoID0gMAogIH0KCiAgaWYgKHR5cGVvZiBvcHRzICE9PSAnb2JqZWN0JyB8fCBvcHRzID09PSBudWxsKSB7CiAgICBvcHRzID0ge30KICB9CgogIGNvbnN0IHJlcSA9IHsKICAgIGhhbmRsZTogbnVsbCwKICAgIHJlc29sdmU6IG51bGwsCiAgICByZWplY3Q6IG51bGwKICB9CgogIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgIHJlcS5yZWplY3QgPSByZWplY3QKICB9KQoKICB0cnkgewogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcud2FpdEZvckxvY2soCiAgICAgIGZkLAogICAgICBvZmZzZXQsCiAgICAgIGxlbmd0aCwKICAgICAgb3B0cy5zaGFyZWQgIT09IHRydWUsCiAgICAgIHJlcSwKICAgICAgb253b3JrCiAgICApCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy50cnlEb3duZ3JhZGVMb2NrID0gZnVuY3Rpb24gdHJ5RG93bmdyYWRlTG9jaygKICBmZCwKICBvZmZzZXQgPSAwLAogIGxlbmd0aCA9IDAKKSB7CiAgdHJ5IHsKICAgIGJpbmRpbmcudHJ5RG93bmdyYWRlTG9jayhmZCwgb2Zmc2V0LCBsZW5ndGgpCiAgfSBjYXRjaCAoZXJyKSB7CiAgICBpZiAoZXJyLmNvZGUgPT09ICdFQUdBSU4nKSByZXR1cm4gZmFsc2UKICAgIHRocm93IGVycgogIH0KCiAgcmV0dXJuIHRydWUKfQoKZXhwb3J0cy53YWl0Rm9yRG93bmdyYWRlTG9jayA9IGZ1bmN0aW9uIGRvd25ncmFkZUxvY2soCiAgZmQsCiAgb2Zmc2V0ID0gMCwKICBsZW5ndGggPSAwCikgewogIGNvbnN0IHJlcSA9IHsKICAgIGhhbmRsZTogbnVsbCwKICAgIHJlc29sdmU6IG51bGwsCiAgICByZWplY3Q6IG51bGwKICB9CgogIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgIHJlcS5yZWplY3QgPSByZWplY3QKICB9KQoKICB0cnkgewogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcud2FpdEZvckRvd25ncmFkZUxvY2soZmQsIG9mZnNldCwgbGVuZ3RoLCByZXEsIG9ud29yaykKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpCiAgfQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLnRyeVVwZ3JhZGVMb2NrID0gZnVuY3Rpb24gdHJ5VXBncmFkZUxvY2soZmQsIG9mZnNldCA9IDAsIGxlbmd0aCA9IDApIHsKICB0cnkgewogICAgYmluZGluZy50cnlVcGdyYWRlTG9jayhmZCwgb2Zmc2V0LCBsZW5ndGgpCiAgfSBjYXRjaCAoZXJyKSB7CiAgICBpZiAoZXJyLmNvZGUgPT09ICdFQUdBSU4nKSByZXR1cm4gZmFsc2UKICAgIHRocm93IGVycgogIH0KCiAgcmV0dXJuIHRydWUKfQoKZXhwb3J0cy53YWl0Rm9yVXBncmFkZUxvY2sgPSBmdW5jdGlvbiB1cGdyYWRlTG9jayhmZCwgb2Zmc2V0ID0gMCwgbGVuZ3RoID0gMCkgewogIGNvbnN0IHJlcSA9IHsKICAgIGhhbmRsZTogbnVsbCwKICAgIHJlc29sdmU6IG51bGwsCiAgICByZWplY3Q6IG51bGwKICB9CgogIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgIHJlcS5yZWplY3QgPSByZWplY3QKICB9KQoKICB0cnkgewogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcud2FpdEZvclVwZ3JhZGVMb2NrKGZkLCBvZmZzZXQsIGxlbmd0aCwgcmVxLCBvbndvcmspCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy51bmxvY2sgPSBmdW5jdGlvbiB1bmxvY2soZmQsIG9mZnNldCA9IDAsIGxlbmd0aCA9IDApIHsKICBiaW5kaW5nLnVubG9jayhmZCwgb2Zmc2V0LCBsZW5ndGgpCn0KCmV4cG9ydHMudHJpbSA9IGZ1bmN0aW9uIHRyaW0oZmQsIG9mZnNldCwgbGVuZ3RoKSB7CiAgY29uc3QgcmVxID0gewogICAgaGFuZGxlOiBudWxsLAogICAgcmVzb2x2ZTogbnVsbCwKICAgIHJlamVjdDogbnVsbAogIH0KCiAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgcmVxLnJlamVjdCA9IHJlamVjdAogIH0pCgogIHRyeSB7CiAgICByZXEuaGFuZGxlID0gYmluZGluZy50cmltKGZkLCBvZmZzZXQsIGxlbmd0aCwgcmVxLCBvbndvcmspCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5zcGFyc2UgPSBmdW5jdGlvbiBzcGFyc2UoZmQpIHsKICAvLyBTaG9ydCBjaXJjdWl0IG9uIGV2ZXJ5dGhpbmcgYnV0IFdpbmRvd3MKICBpZiAoIWlzV2luZG93cykgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCgogIGNvbnN0IHJlcSA9IHsKICAgIGhhbmRsZTogbnVsbCwKICAgIHJlc29sdmU6IG51bGwsCiAgICByZWplY3Q6IG51bGwKICB9CgogIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgIHJlcS5yZWplY3QgPSByZWplY3QKICB9KQoKICB0cnkgewogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcuc3BhcnNlKGZkLCByZXEsIG9ud29yaykKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpCiAgfQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLnN3YXAgPSBmdW5jdGlvbiBzd2FwKGZyb20sIHRvKSB7CiAgY29uc3QgcmVxID0gewogICAgaGFuZGxlOiBudWxsLAogICAgcmVzb2x2ZTogbnVsbCwKICAgIHJlamVjdDogbnVsbAogIH0KCiAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgcmVxLnJlamVjdCA9IHJlamVjdAogIH0pCgogIHRyeSB7CiAgICByZXEuaGFuZGxlID0gYmluZGluZy5zd2FwKGZyb20sIHRvLCByZXEsIG9ud29yaykKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpCiAgfQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLmdldEF0dHIgPSBmdW5jdGlvbiBnZXRBdHRyKGZkLCBuYW1lKSB7CiAgY29uc3QgcmVxID0gewogICAgaGFuZGxlOiBudWxsLAogICAgcmVzb2x2ZTogbnVsbCwKICAgIHJlamVjdDogbnVsbAogIH0KCiAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgcmVxLnJlamVjdCA9IHJlamVjdAogIH0pCgogIHRyeSB7CiAgICByZXEuaGFuZGxlID0gYmluZGluZy5nZXRBdHRyKGZkLCBuYW1lLCByZXEsIG9ud29yaykKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpCiAgfQoKICByZXR1cm4gcHJvbWlzZS50aGVuKChidWZmZXIpID0+CiAgICBidWZmZXIgPT09IG51bGwgPyBudWxsIDogQnVmZmVyLmZyb20oYnVmZmVyKQogICkKfQoKZXhwb3J0cy5zZXRBdHRyID0gZnVuY3Rpb24gc2V0QXR0cihmZCwgbmFtZSwgdmFsdWUsIGVuY29kaW5nKSB7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHZhbHVlID0gQnVmZmVyLmZyb20odmFsdWUsIGVuY29kaW5nKQoKICBjb25zdCByZXEgPSB7CiAgICB2YWx1ZSwKICAgIGhhbmRsZTogbnVsbCwKICAgIHJlc29sdmU6IG51bGwsCiAgICByZWplY3Q6IG51bGwKICB9CgogIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgIHJlcS5yZWplY3QgPSByZWplY3QKICB9KQoKICB0cnkgewogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcuc2V0QXR0cigKICAgICAgZmQsCiAgICAgIG5hbWUsCiAgICAgIHZhbHVlLmJ1ZmZlciwKICAgICAgdmFsdWUuYnl0ZU9mZnNldCwKICAgICAgdmFsdWUuYnl0ZUxlbmd0aCwKICAgICAgcmVxLAogICAgICBvbndvcmsKICAgICkKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpCiAgfQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLnJlbW92ZUF0dHIgPSBmdW5jdGlvbiByZW1vdmVBdHRyKGZkLCBuYW1lKSB7CiAgY29uc3QgcmVxID0gewogICAgaGFuZGxlOiBudWxsLAogICAgcmVzb2x2ZTogbnVsbCwKICAgIHJlamVjdDogbnVsbAogIH0KCiAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgcmVxLnJlamVjdCA9IHJlamVjdAogIH0pCgogIHRyeSB7CiAgICByZXEuaGFuZGxlID0gYmluZGluZy5yZW1vdmVBdHRyKGZkLCBuYW1lLCByZXEsIG9ud29yaykKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpCiAgfQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLmxpc3RBdHRycyA9IGZ1bmN0aW9uIGxpc3RBdHRycyhmZCkgewogIGNvbnN0IHJlcSA9IHsKICAgIGhhbmRsZTogbnVsbCwKICAgIHJlc29sdmU6IG51bGwsCiAgICByZWplY3Q6IG51bGwKICB9CgogIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgIHJlcS5yZWplY3QgPSByZWplY3QKICB9KQoKICB0cnkgewogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcubGlzdEF0dHJzKGZkLCByZXEsIG9ud29yaykKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpCiAgfQoKICByZXR1cm4gcHJvbWlzZQp9CnsKICAibmFtZSI6ICJmcy1uYXRpdmUtZXh0ZW5zaW9ucyIsCiAgInZlcnNpb24iOiAiMS40LjUiLAogICJkZXNjcmlwdGlvbiI6ICJOYXRpdmUgZmlsZSBzeXN0ZW0gZXh0ZW5zaW9ucyBmb3IgYWR2YW5jZWQgZmlsZSBvcGVyYXRpb25zIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJtYWNyb3MuaCIsCiAgICAiYmluZGluZy5jIiwKICAgICJiaW5kaW5nLmpzIiwKICAgICJDTWFrZUxpc3RzLnR4dCIsCiAgICAiaW5jbHVkZSIsCiAgICAic3JjIiwKICAgICJwcmVidWlsZHMiCiAgXSwKICAiaW1wb3J0cyI6IHsKICAgICJjaGlsZF9wcm9jZXNzIjogewogICAgICAiYmFyZSI6ICJiYXJlLXN1YnByb2Nlc3MiLAogICAgICAiZGVmYXVsdCI6ICJjaGlsZF9wcm9jZXNzIgogICAgfSwKICAgICJmcyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1mcyIsCiAgICAgICJkZWZhdWx0IjogImZzIgogICAgfSwKICAgICJmcy8qIjogewogICAgICAiYmFyZSI6ICJiYXJlLWZzLyoiLAogICAgICAiZGVmYXVsdCI6ICJmcy8qIgogICAgfSwKICAgICJwYXRoIjogewogICAgICAiYmFyZSI6ICJiYXJlLXBhdGgiLAogICAgICAiZGVmYXVsdCI6ICJwYXRoIgogICAgfQogIH0sCiAgImFkZG9uIjogdHJ1ZSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogIm5wbSBydW4gbGludCAmJiBucG0gcnVuIHRlc3Q6YmFyZSAmJiBucG0gcnVuIHRlc3Q6bm9kZSIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC5qcyIsCiAgICAidGVzdDpub2RlIjogIm5vZGUgdGVzdC5qcyIsCiAgICAibGludCI6ICJwcmV0dGllciAuIC0tY2hlY2siCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vZnMtbmF0aXZlLWV4dGVuc2lvbnMuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJLYXNwZXIgSXNhZ2VyIERhbHNnYXLDsCA8a2FzcGVyQGZ1bmt0aW9uZWwuY28+IiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2ZzLW5hdGl2ZS1leHRlbnNpb25zL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vZnMtbmF0aXZlLWV4dGVuc2lvbnMjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgInJlcXVpcmUtYWRkb24iOiAiXjEuMS4wIiwKICAgICJ3aGljaC1ydW50aW1lIjogIl4xLjIuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1jb21wYXQtbmFwaSI6ICJeMS4zLjgiLAogICAgImJhcmUtZnMiOiAiXjQuNC40IiwKICAgICJiYXJlLXBhdGgiOiAiXjMuMC4wIiwKICAgICJiYXJlLXN1YnByb2Nlc3MiOiAiXjQuMC41IiwKICAgICJicml0dGxlIjogIl4zLjEuMSIsCiAgICAiY21ha2UtYmFyZSI6ICJeMS4xLjEwIiwKICAgICJjbWFrZS1mZXRjaCI6ICJeMS40LjciLAogICAgImNtYWtlLW5hcGkiOiAiXjEuMC41IiwKICAgICJjbWFrZS1ucG0iOiAiXjEuMS4wIiwKICAgICJtaW5pbWlzdCI6ICJeMS4yLjYiLAogICAgInByZXR0aWVyIjogIl4zLjUuMyIsCiAgICAicHJldHRpZXItY29uZmlnLXN0YW5kYXJkIjogIl43LjAuMCIsCiAgICAidGVzdC10bXAiOiAiXjEuMi4xIgogIH0KfQpjb25zdCBjb2RlY3MgPSByZXF1aXJlKCdjb2RlY3MnKQpjb25zdCB7IFJlYWRhYmxlIH0gPSByZXF1aXJlKCdzdHJlYW14JykKY29uc3QgbXV0ZXhpZnkgPSByZXF1aXJlKCdtdXRleGlmeS9wcm9taXNlJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCBSZWFkeVJlc291cmNlID0gcmVxdWlyZSgncmVhZHktcmVzb3VyY2UnKQpjb25zdCBkZWJvdW5jZSA9IHJlcXVpcmUoJ2RlYm91bmNlaWZ5JykKY29uc3QgUmFjaGUgPSByZXF1aXJlKCdyYWNoZScpCmNvbnN0IHJycCA9IHJlcXVpcmUoJ3Jlc29sdmUtcmVqZWN0LXByb21pc2UnKQoKY29uc3QgeyBhbGw6IHVuc2xhYkFsbCB9ID0gcmVxdWlyZSgndW5zbGFiJykKCmNvbnN0IFJhbmdlSXRlcmF0b3IgPSByZXF1aXJlKCcuL2l0ZXJhdG9ycy9yYW5nZScpCmNvbnN0IEhpc3RvcnlJdGVyYXRvciA9IHJlcXVpcmUoJy4vaXRlcmF0b3JzL2hpc3RvcnknKQpjb25zdCBEaWZmSXRlcmF0b3IgPSByZXF1aXJlKCcuL2l0ZXJhdG9ycy9kaWZmJykKY29uc3QgTG9jYWxCbG9ja0l0ZXJhdG9yID0gcmVxdWlyZSgnLi9pdGVyYXRvcnMvbG9jYWwnKQpjb25zdCBFeHRlbnNpb24gPSByZXF1aXJlKCcuL2xpYi9leHRlbnNpb24nKQpjb25zdCB7IFlvbG9JbmRleCwgTm9kZSwgSGVhZGVyIH0gPSByZXF1aXJlKCcuL2xpYi9tZXNzYWdlcycpCmNvbnN0IHsgQkxPQ0tfTk9UX0FWQUlMQUJMRSwgREVDT0RJTkdfRVJST1IgfSA9IHJlcXVpcmUoJ2h5cGVyY29yZS1lcnJvcnMnKQoKY29uc3QgVCA9IDUKY29uc3QgTUlOX0tFWVMgPSBUIC0gMQpjb25zdCBNQVhfQ0hJTERSRU4gPSBNSU5fS0VZUyAqIDIgKyAxCgpjb25zdCBTRVAgPSBiNGEuYWxsb2MoMSkKY29uc3QgRU1QVFkgPSBiNGEuYWxsb2MoMCkKCmNsYXNzIEtleSB7CiAgY29uc3RydWN0b3IgKHNlcSwgdmFsdWUpIHsKICAgIHRoaXMuc2VxID0gc2VxCiAgICB0aGlzLnZhbHVlID0gdmFsdWUKICB9Cn0KCmNsYXNzIENoaWxkIHsKICBjb25zdHJ1Y3RvciAoc2VxLCBvZmZzZXQsIHZhbHVlKSB7CiAgICB0aGlzLnNlcSA9IHNlcQogICAgdGhpcy5vZmZzZXQgPSBvZmZzZXQKICAgIHRoaXMudmFsdWUgPSB2YWx1ZQogIH0KfQoKY2xhc3MgQ2FjaGUgewogIGNvbnN0cnVjdG9yIChyYWNoZSkgewogICAgdGhpcy5rZXlzID0gcmFjaGUKICAgIHRoaXMubGVuZ3RoID0gMAogIH0KCiAgZ2V0IChzZXEpIHsKICAgIHJldHVybiB0aGlzLmtleXMuZ2V0KHNlcSkgfHwgbnVsbAogIH0KCiAgc2V0IChzZXEsIGtleSkgewogICAgdGhpcy5rZXlzLnNldChzZXEsIGtleSkKICAgIGlmIChzZXEgPj0gdGhpcy5sZW5ndGgpIHRoaXMubGVuZ3RoID0gc2VxICsgMQogIH0KCiAgZ2MgKGxlbmd0aCkgewogICAgLy8gaWYgd2UgbmVlZCB0byAid29yayIgbW9yZSB0aGFuIDEyOCB0aWNrcywganVzdCBidXN0IHRoZSBjYWNoZS4uLgogICAgaWYgKHRoaXMubGVuZ3RoIC0gbGVuZ3RoID4gMTI4KSB7CiAgICAgIHRoaXMua2V5cy5jbGVhcigpCiAgICB9IGVsc2UgewogICAgICBmb3IgKGxldCBpID0gbGVuZ3RoOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMua2V5cy5kZWxldGUoaSkKICAgICAgfQogICAgfQoKICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoCiAgfQoKICBjbGVhciAoKSB7CiAgICB0aGlzLmtleXMuY2xlYXIoKQogIH0KfQoKY2xhc3MgUG9pbnRlcnMgewogIGNvbnN0cnVjdG9yIChkZWNvZGVkKSB7CiAgICB0aGlzLmxldmVscyA9IGRlY29kZWQubGV2ZWxzLm1hcChsID0+IHsKICAgICAgY29uc3QgY2hpbGRyZW4gPSBbXQogICAgICBjb25zdCBrZXlzID0gW10KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbC5rZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAga2V5cy5wdXNoKG5ldyBLZXkobC5rZXlzW2ldLCBudWxsKSkKICAgICAgfQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsLmNoaWxkcmVuLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgY2hpbGRyZW4ucHVzaChuZXcgQ2hpbGQobC5jaGlsZHJlbltpXSwgbC5jaGlsZHJlbltpICsgMV0sIG51bGwpKQogICAgICB9CgogICAgICByZXR1cm4geyBrZXlzLCBjaGlsZHJlbiB9CiAgICB9KQogIH0KCiAgZ2V0IChpKSB7CiAgICByZXR1cm4gdGhpcy5sZXZlbHNbaV0KICB9CgogIGhhc0tleSAoc2VxKSB7CiAgICBmb3IgKGNvbnN0IGx2bCBvZiB0aGlzLmxldmVscykgewogICAgICBmb3IgKGNvbnN0IGtleSBvZiBsdmwua2V5cykgewogICAgICAgIGlmIChrZXkuc2VxID09PSBzZXEpIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZQogIH0KfQoKZnVuY3Rpb24gaW5mbGF0ZSAoZW50cnkpIHsKICBpZiAoZW50cnkuaW5mbGF0ZWQgPT09IG51bGwpIHsKICAgIGVudHJ5LmluZmxhdGVkID0gWW9sb0luZGV4LmRlY29kZShlbnRyeS5pbmRleCkKICAgIGVudHJ5LmluZGV4ID0gbnVsbAogIH0KICByZXR1cm4gbmV3IFBvaW50ZXJzKGVudHJ5LmluZmxhdGVkKQp9CgpmdW5jdGlvbiBkZWZsYXRlIChpbmRleCkgewogIGNvbnN0IGxldmVscyA9IGluZGV4Lm1hcChsID0+IHsKICAgIGNvbnN0IGtleXMgPSBbXQogICAgY29uc3QgY2hpbGRyZW4gPSBbXQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbC52YWx1ZS5rZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGtleXMucHVzaChsLnZhbHVlLmtleXNbaV0uc2VxKQogICAgfQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbC52YWx1ZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBjaGlsZHJlbi5wdXNoKGwudmFsdWUuY2hpbGRyZW5baV0uc2VxLCBsLnZhbHVlLmNoaWxkcmVuW2ldLm9mZnNldCkKICAgIH0KCiAgICByZXR1cm4geyBrZXlzLCBjaGlsZHJlbiB9CiAgfSkKCiAgcmV0dXJuIFlvbG9JbmRleC5lbmNvZGUoeyBsZXZlbHMgfSkKfQoKY2xhc3MgVHJlZU5vZGUgewogIGNvbnN0cnVjdG9yIChibG9jaywga2V5cywgY2hpbGRyZW4sIG9mZnNldCkgewogICAgdGhpcy5ibG9jayA9IGJsb2NrCiAgICB0aGlzLm9mZnNldCA9IG9mZnNldAogICAgdGhpcy5rZXlzID0ga2V5cwogICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuCiAgICB0aGlzLmNoYW5nZWQgPSBmYWxzZQoKICAgIHRoaXMucHJlbG9hZCgpCiAgfQoKICBwcmVsb2FkICgpIHsKICAgIGlmICh0aGlzLmJsb2NrID09PSBudWxsKSByZXR1cm4KCiAgICBjb25zdCBjb3JlID0gZ2V0QmFja2luZ0NvcmUodGhpcy5ibG9jay50cmVlLmNvcmUpCiAgICBpZiAoIWNvcmUpIHJldHVybgoKICAgIGNvbnN0IGJpdGZpZWxkID0gY29yZS5jb3JlLmJpdGZpZWxkCiAgICBjb25zdCBibG9ja3MgPSBbXQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5rZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGsgPSB0aGlzLmtleXNbaV0KICAgICAgaWYgKGsudmFsdWUpIGNvbnRpbnVlCiAgICAgIGlmIChrLnNlcSA+PSBjb3JlLnNpZ25lZExlbmd0aCB8fCAoYml0ZmllbGQgJiYgYml0ZmllbGQuZ2V0KGsuc2VxKSkpIGNvbnRpbnVlCiAgICAgIGJsb2Nrcy5wdXNoKGsuc2VxKQogICAgfQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGMgPSB0aGlzLmNoaWxkcmVuW2ldCiAgICAgIGlmIChjLnZhbHVlKSBjb250aW51ZQogICAgICBpZiAoYy5zZXEgPj0gY29yZS5zaWduZWRMZW5ndGggfHwgKGJpdGZpZWxkICYmIGJpdGZpZWxkLmdldChjLnNlcSkpKSBjb250aW51ZQogICAgICBibG9ja3MucHVzaChjLnNlcSkKICAgIH0KCiAgICBpZiAoYmxvY2tzLmxlbmd0aCkgY29yZS5kb3dubG9hZCh7IGJsb2NrcyB9KQogIH0KCiAgYXN5bmMgaW5zZXJ0S2V5IChrZXksIHZhbHVlLCBjaGlsZCwgbm9kZSwgZW5jb2RpbmcsIGNhcykgewogICAgbGV0IHMgPSAwCiAgICBsZXQgZSA9IHRoaXMua2V5cy5sZW5ndGgKICAgIGxldCBjCgogICAgd2hpbGUgKHMgPCBlKSB7CiAgICAgIGNvbnN0IG1pZCA9IChzICsgZSkgPj4gMQogICAgICBjID0gYjRhLmNvbXBhcmUoa2V5LnZhbHVlLCBhd2FpdCB0aGlzLmdldEtleShtaWQpKQoKICAgICAgaWYgKGMgPT09IDApIHsKICAgICAgICBpZiAoY2FzKSB7CiAgICAgICAgICBjb25zdCBwcmV2ID0gYXdhaXQgdGhpcy5nZXRLZXlOb2RlKG1pZCkKICAgICAgICAgIGlmICghKGF3YWl0IGNhcyhwcmV2LmZpbmFsKGVuY29kaW5nKSwgbm9kZSkpKSByZXR1cm4gdHJ1ZQogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuYmxvY2sudHJlZS50cmVlLmFsd2F5c0R1cGxpY2F0ZSkgewogICAgICAgICAgY29uc3QgcHJldiA9IGF3YWl0IHRoaXMuZ2V0S2V5Tm9kZShtaWQpCiAgICAgICAgICBpZiAoc2FtZVZhbHVlKHByZXYudmFsdWUsIHZhbHVlKSkgcmV0dXJuIHRydWUKICAgICAgICB9CiAgICAgICAgdGhpcy5jaGFuZ2VkID0gdHJ1ZQogICAgICAgIHRoaXMua2V5c1ttaWRdID0ga2V5CiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQoKICAgICAgaWYgKGMgPCAwKSBlID0gbWlkCiAgICAgIGVsc2UgcyA9IG1pZCArIDEKICAgIH0KCiAgICBjb25zdCBpID0gYyA8IDAgPyBlIDogcwogICAgdGhpcy5rZXlzLnNwbGljZShpLCAwLCBrZXkpCiAgICBpZiAoY2hpbGQpIHRoaXMuY2hpbGRyZW4uc3BsaWNlKGkgKyAxLCAwLCBuZXcgQ2hpbGQoMCwgMCwgY2hpbGQpKQogICAgdGhpcy5jaGFuZ2VkID0gdHJ1ZQoKICAgIHJldHVybiB0aGlzLmtleXMubGVuZ3RoIDwgTUFYX0NISUxEUkVOCiAgfQoKICByZW1vdmVLZXkgKGluZGV4KSB7CiAgICB0aGlzLmtleXMuc3BsaWNlKGluZGV4LCAxKQogICAgaWYgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgIHRoaXMuY2hpbGRyZW5baW5kZXggKyAxXS5zZXEgPSAwIC8vIG1hcmsgYXMgZnJlZWQKICAgICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaW5kZXggKyAxLCAxKQogICAgfQogICAgdGhpcy5jaGFuZ2VkID0gdHJ1ZQogIH0KCiAgYXN5bmMgc2libGluZ3MgKHBhcmVudCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJlbnQuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHBhcmVudC5jaGlsZHJlbltpXS52YWx1ZSA9PT0gdGhpcykgewogICAgICAgIGNvbnN0IFtsZWZ0LCByaWdodF0gPSBhd2FpdCBQcm9taXNlLmFsbChbCiAgICAgICAgICBpID8gcGFyZW50LmdldENoaWxkTm9kZShpIC0gMSkgOiBudWxsLAogICAgICAgICAgaSA8IHBhcmVudC5jaGlsZHJlbi5sZW5ndGggLSAxID8gcGFyZW50LmdldENoaWxkTm9kZShpICsgMSkgOiBudWxsCiAgICAgICAgXSkKICAgICAgICByZXR1cm4geyBsZWZ0LCBpbmRleDogaSwgcmlnaHQgfQogICAgICB9CiAgICB9CgogICAgdGhyb3cgbmV3IEVycm9yKCdCYWQgcGFyZW50JykKICB9CgogIG1lcmdlIChub2RlLCBtZWRpYW4pIHsKICAgIHRoaXMuY2hhbmdlZCA9IHRydWUKICAgIHRoaXMua2V5cy5wdXNoKG1lZGlhbikKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5rZXlzLmxlbmd0aDsgaSsrKSB0aGlzLmtleXMucHVzaChub2RlLmtleXNbaV0pCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHRoaXMuY2hpbGRyZW4ucHVzaChub2RlLmNoaWxkcmVuW2ldKQogIH0KCiAgYXN5bmMgc3BsaXQgKCkgewogICAgY29uc3QgbGVuID0gdGhpcy5rZXlzLmxlbmd0aCA+PiAxCiAgICBjb25zdCByaWdodCA9IFRyZWVOb2RlLmNyZWF0ZSh0aGlzLmJsb2NrKQoKICAgIHdoaWxlIChyaWdodC5rZXlzLmxlbmd0aCA8IGxlbikgcmlnaHQua2V5cy5wdXNoKHRoaXMua2V5cy5wb3AoKSkKICAgIHJpZ2h0LmtleXMucmV2ZXJzZSgpCgogICAgYXdhaXQgdGhpcy5nZXRLZXkodGhpcy5rZXlzLmxlbmd0aCAtIDEpIC8vIG1ha2Ugc3VyZSB0aGUgbWVkaWFuIGlzIGxvYWRlZAogICAgY29uc3QgbWVkaWFuID0gdGhpcy5rZXlzLnBvcCgpCgogICAgaWYgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgIHdoaWxlIChyaWdodC5jaGlsZHJlbi5sZW5ndGggPCBsZW4gKyAxKSByaWdodC5jaGlsZHJlbi5wdXNoKHRoaXMuY2hpbGRyZW4ucG9wKCkpCiAgICAgIHJpZ2h0LmNoaWxkcmVuLnJldmVyc2UoKQogICAgfQoKICAgIHRoaXMuY2hhbmdlZCA9IHRydWUKCiAgICByZXR1cm4gewogICAgICBsZWZ0OiB0aGlzLAogICAgICBtZWRpYW4sCiAgICAgIHJpZ2h0CiAgICB9CiAgfQoKICBnZXRLZXlOb2RlIChpbmRleCkgewogICAgcmV0dXJuIHRoaXMuYmxvY2sudHJlZS5nZXRCbG9jayh0aGlzLmtleXNbaW5kZXhdLnNlcSkKICB9CgogIGFzeW5jIGdldENoaWxkTm9kZSAoaW5kZXgpIHsKICAgIGNvbnN0IGNoaWxkID0gdGhpcy5jaGlsZHJlbltpbmRleF0KICAgIGlmIChjaGlsZC52YWx1ZSkgcmV0dXJuIGNoaWxkLnZhbHVlCiAgICBjb25zdCBibG9jayA9IGNoaWxkLnNlcSA9PT0gdGhpcy5ibG9jay5zZXEgPyB0aGlzLmJsb2NrIDogYXdhaXQgdGhpcy5ibG9jay50cmVlLmdldEJsb2NrKGNoaWxkLnNlcSkKICAgIHJldHVybiAoY2hpbGQudmFsdWUgPSBibG9jay5nZXRUcmVlTm9kZShjaGlsZC5vZmZzZXQpKQogIH0KCiAgc2V0S2V5IChpbmRleCwga2V5KSB7CiAgICB0aGlzLmtleXNbaW5kZXhdID0ga2V5CiAgICB0aGlzLmNoYW5nZWQgPSB0cnVlCiAgfQoKICBhc3luYyBnZXRLZXkgKGluZGV4KSB7CiAgICBjb25zdCBrZXkgPSB0aGlzLmtleXNbaW5kZXhdCiAgICBpZiAoa2V5LnZhbHVlKSByZXR1cm4ga2V5LnZhbHVlCiAgICBjb25zdCBrID0ga2V5LnNlcSA9PT0gdGhpcy5ibG9jay5zZXEgPyB0aGlzLmJsb2NrLmtleSA6IGF3YWl0IHRoaXMuYmxvY2sudHJlZS5nZXRLZXkoa2V5LnNlcSkKICAgIHJldHVybiAoa2V5LnZhbHVlID0gaykKICB9CgogIGluZGV4Q2hhbmdlcyAoaW5kZXgsIHNlcSkgewogICAgY29uc3Qgb2Zmc2V0ID0gaW5kZXgucHVzaChudWxsKSAtIDEKICAgIHRoaXMuY2hhbmdlZCA9IGZhbHNlCgogICAgZm9yIChjb25zdCBjaGlsZCBvZiB0aGlzLmNoaWxkcmVuKSB7CiAgICAgIGlmICghY2hpbGQudmFsdWUgfHwgIWNoaWxkLnZhbHVlLmNoYW5nZWQpIGNvbnRpbnVlCiAgICAgIGNoaWxkLnNlcSA9IHNlcQogICAgICBjaGlsZC5vZmZzZXQgPSBjaGlsZC52YWx1ZS5pbmRleENoYW5nZXMoaW5kZXgsIHNlcSkKICAgICAgaW5kZXhbY2hpbGQub2Zmc2V0XSA9IGNoaWxkCiAgICB9CgogICAgcmV0dXJuIG9mZnNldAogIH0KCiAgdXBkYXRlQ2hpbGRyZW4gKHNlcSwgYmxvY2spIHsKICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdGhpcy5jaGlsZHJlbikgewogICAgICBpZiAoIWNoaWxkLnZhbHVlIHx8IGNoaWxkLnNlcSAhPT0gc2VxKSBjb250aW51ZQogICAgICBjaGlsZC52YWx1ZS5ibG9jayA9IGJsb2NrCiAgICAgIGNoaWxkLnZhbHVlLnVwZGF0ZUNoaWxkcmVuKHNlcSwgYmxvY2spCiAgICB9CiAgfQoKICBzdGF0aWMgY3JlYXRlIChibG9jaykgewogICAgY29uc3Qgbm9kZSA9IG5ldyBUcmVlTm9kZShibG9jaywgW10sIFtdLCAwKQogICAgbm9kZS5jaGFuZ2VkID0gdHJ1ZQogICAgcmV0dXJuIG5vZGUKICB9Cn0KCmNsYXNzIEJsb2NrRW50cnkgewogIGNvbnN0cnVjdG9yIChzZXEsIHRyZWUsIGVudHJ5KSB7CiAgICB0aGlzLnNlcSA9IHNlcQogICAgdGhpcy50cmVlID0gdHJlZQogICAgdGhpcy5pbmRleCA9IG51bGwKICAgIHRoaXMuZW50cnkgPSBlbnRyeQogICAgdGhpcy5rZXkgPSBlbnRyeS5rZXkKICAgIHRoaXMudmFsdWUgPSBlbnRyeS52YWx1ZQogIH0KCiAgaXNUYXJnZXQgKGtleSkgewogICAgcmV0dXJuIGI0YS5lcXVhbHModGhpcy5rZXksIGtleSkKICB9CgogIGluZmxhdGUgKCkgewogICAgaWYgKHRoaXMuaW5kZXggPT09IG51bGwpIHsKICAgICAgdGhpcy5pbmRleCA9IGluZmxhdGUodGhpcy5lbnRyeSkKICAgIH0KICB9CgogIGlzRGVsZXRpb24gKCkgewogICAgaWYgKHRoaXMudmFsdWUgIT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIGlmICh0aGlzLmluZGV4ID09PSBudWxsKSB7CiAgICAgIHRoaXMuaW5kZXggPSBpbmZsYXRlKHRoaXMuZW50cnkpCiAgICB9CgogICAgcmV0dXJuICF0aGlzLmluZGV4Lmhhc0tleSh0aGlzLnNlcSkKICB9CgogIGZpbmFsIChlbmNvZGluZykgewogICAgcmV0dXJuIHsKICAgICAgc2VxOiB0aGlzLnNlcSwKICAgICAga2V5OiBlbmNvZGluZy5rZXkgPyBlbmNvZGluZy5rZXkuZGVjb2RlKHRoaXMua2V5KSA6IHRoaXMua2V5LAogICAgICB2YWx1ZTogdGhpcy52YWx1ZSAmJiAoZW5jb2RpbmcudmFsdWUgPyBlbmNvZGluZy52YWx1ZS5kZWNvZGUodGhpcy52YWx1ZSkgOiB0aGlzLnZhbHVlKQogICAgfQogIH0KCiAgZ2V0VHJlZU5vZGUgKG9mZnNldCkgewogICAgaWYgKHRoaXMuaW5kZXggPT09IG51bGwpIHsKICAgICAgdGhpcy5pbmRleCA9IGluZmxhdGUodGhpcy5lbnRyeSkKICAgIH0KICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5pbmRleC5nZXQob2Zmc2V0KQogICAgcmV0dXJuIG5ldyBUcmVlTm9kZSh0aGlzLCBlbnRyeS5rZXlzLCBlbnRyeS5jaGlsZHJlbiwgb2Zmc2V0KQogIH0KfQoKY2xhc3MgQ2FjaGVMb2NrIHsKICBjb25zdHJ1Y3RvciAoKSB7CiAgICB0aGlzLm1hcCA9IG5ldyBNYXAoKQogIH0KCiAgZW50ZXIgKHNlcSkgewogICAgY29uc3QgcGVuZGluZyA9IHRoaXMubWFwLmdldChzZXEpCgogICAgaWYgKCFwZW5kaW5nKSB7CiAgICAgIHRoaXMubWFwLnNldChzZXEsIFtdKQogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKICAgIH0KCiAgICBjb25zdCB7IHJlc29sdmUsIHByb21pc2UgfSA9IHJycCgpCiAgICBwZW5kaW5nLnB1c2gocmVzb2x2ZSkKICAgIHJldHVybiBwcm9taXNlCiAgfQoKICBleGl0IChzZXEpIHsKICAgIGNvbnN0IHBlbmRpbmcgPSB0aGlzLm1hcC5nZXQoc2VxKQogICAgaWYgKCFwZW5kaW5nLmxlbmd0aCkgewogICAgICB0aGlzLm1hcC5kZWxldGUoc2VxKQogICAgICByZXR1cm4KICAgIH0KCiAgICBwZW5kaW5nLnBvcCgpKCkKICB9Cn0KCmNsYXNzIEJhdGNoRW50cnkgZXh0ZW5kcyBCbG9ja0VudHJ5IHsKICBjb25zdHJ1Y3RvciAoc2VxLCB0cmVlLCBrZXksIHZhbHVlLCBpbmRleCkgewogICAgc3VwZXIoc2VxLCB0cmVlLCB7IGtleSwgdmFsdWUsIGluZGV4OiBudWxsLCBpbmZsYXRlZDogbnVsbCB9KQogICAgdGhpcy5wZW5kaW5nSW5kZXggPSBpbmRleAogIH0KCiAgaXNUYXJnZXQgKGtleSkgewogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBnZXRUcmVlTm9kZSAob2Zmc2V0KSB7CiAgICByZXR1cm4gdGhpcy5wZW5kaW5nSW5kZXhbb2Zmc2V0XS52YWx1ZQogIH0KfQoKY2xhc3MgSHlwZXJiZWUgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvciAoY29yZSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCiAgICAvLyB0aGlzLmZlZWQgaXMgbm93IGRlcHJlY2F0ZWQsIGFuZCB3aWxsIGJlIHRoaXMuY29yZSBnb2luZyBmb3J3YXJkCiAgICB0aGlzLmZlZWQgPSBjb3JlCiAgICB0aGlzLmNvcmUgPSBjb3JlCgogICAgdGhpcy5rZXlFbmNvZGluZyA9IG9wdHMua2V5RW5jb2RpbmcgPyBjb2RlY3Mob3B0cy5rZXlFbmNvZGluZykgOiBudWxsCiAgICB0aGlzLnZhbHVlRW5jb2RpbmcgPSBvcHRzLnZhbHVlRW5jb2RpbmcgPyBjb2RlY3Mob3B0cy52YWx1ZUVuY29kaW5nKSA6IG51bGwKICAgIHRoaXMuZXh0ZW5zaW9uID0gb3B0cy5leHRlbnNpb24gIT09IGZhbHNlID8gZ2V0RXh0ZW5zaW9uKHRoaXMsIG9wdHMpIDogbnVsbAogICAgdGhpcy5tZXRhZGF0YSA9IG9wdHMubWV0YWRhdGEgfHwgbnVsbAogICAgdGhpcy5sb2NrID0gb3B0cy5sb2NrIHx8IG11dGV4aWZ5KCkKICAgIHRoaXMuc2VwID0gb3B0cy5zZXAgfHwgU0VQCiAgICB0aGlzLnJlYWRvbmx5ID0gISFvcHRzLnJlYWRvbmx5CiAgICB0aGlzLnByZWZpeCA9IG9wdHMucHJlZml4IHx8IG51bGwKCiAgICAvLyBJbiBhIGZ1dHVyZSB2ZXJzaW9uLCB0aGlzIHNob3VsZCBiZSBmYWxzZSBieSBkZWZhdWx0CiAgICB0aGlzLmFsd2F5c0R1cGxpY2F0ZSA9IG9wdHMuYWx3YXlzRHVwbGljYXRlICE9PSBmYWxzZQoKICAgIHRoaXMuX3VucHJlZml4ZWRLZXlFbmNvZGluZyA9IHRoaXMua2V5RW5jb2RpbmcKICAgIHRoaXMuX3N1YiA9ICEhdGhpcy5wcmVmaXgKICAgIHRoaXMuX2NoZWNrb3V0ID0gb3B0cy5jaGVja291dCB8fCAwCiAgICB0aGlzLl92aWV3ID0gISFvcHRzLl92aWV3CgogICAgdGhpcy5fb25hcHBlbmRCb3VuZCA9IHRoaXMuX3ZpZXcgPyBudWxsIDogdGhpcy5fb25hcHBlbmQuYmluZCh0aGlzKQogICAgdGhpcy5fb250cnVuY2F0ZUJvdW5kID0gdGhpcy5fdmlldyA/IG51bGwgOiB0aGlzLl9vbnRydW5jYXRlLmJpbmQodGhpcykKICAgIHRoaXMuX3dhdGNoZXJzID0gdGhpcy5fb25hcHBlbmRCb3VuZCA/IFtdIDogbnVsbAogICAgdGhpcy5fZW50cnlXYXRjaGVycyA9IHRoaXMuX29uYXBwZW5kQm91bmQgPyBbXSA6IG51bGwKICAgIHRoaXMuX3Nlc3Npb25zID0gb3B0cy5zZXNzaW9ucyAhPT0gZmFsc2UKCiAgICB0aGlzLl9rZXlDYWNoZSA9IG51bGwKICAgIHRoaXMuX25vZGVDYWNoZSA9IG51bGwKICAgIHRoaXMuX2NhY2hlTG9jayA9IG5ldyBDYWNoZUxvY2soKQoKICAgIHRoaXMuX2JhdGNoZXMgPSBbXQoKICAgIGlmICh0aGlzLl93YXRjaGVycykgewogICAgICB0aGlzLmNvcmUub24oJ2FwcGVuZCcsIHRoaXMuX29uYXBwZW5kQm91bmQpCiAgICAgIHRoaXMuY29yZS5vbigndHJ1bmNhdGUnLCB0aGlzLl9vbnRydW5jYXRlQm91bmQpCiAgICB9CgogICAgaWYgKHRoaXMucHJlZml4ICYmIG9wdHMuX3N1YikgewogICAgICB0aGlzLmtleUVuY29kaW5nID0gcHJlZml4RW5jb2RpbmcodGhpcy5wcmVmaXgsIHRoaXMua2V5RW5jb2RpbmcpCiAgICB9CgogICAgdGhpcy5yZWFkeSgpLmNhdGNoKHNhZmV0eUNhdGNoKQogIH0KCiAgYXN5bmMgX29wZW4gKCkgewogICAgaWYgKHRoaXMuY29yZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQoKICAgIC8vIHNuYXBzaG90CiAgICBpZiAodGhpcy5fY2hlY2tvdXQgPT09IC0xKSB0aGlzLl9jaGVja291dCA9IE1hdGgubWF4KDEsIHRoaXMuY29yZS5sZW5ndGgpCgogICAgY29uc3QgYmFzZUNhY2hlID0gUmFjaGUuZnJvbSh0aGlzLmNvcmUuZ2xvYmFsQ2FjaGUpCiAgICB0aGlzLl9rZXlDYWNoZSA9IG5ldyBDYWNoZShiYXNlQ2FjaGUpCiAgICB0aGlzLl9ub2RlQ2FjaGUgPSBuZXcgQ2FjaGUoUmFjaGUuZnJvbShiYXNlQ2FjaGUpKQogIH0KCiAgZ2V0IHZlcnNpb24gKCkgewogICAgcmV0dXJuIE1hdGgubWF4KDEsIHRoaXMuX2NoZWNrb3V0IHx8IHRoaXMuY29yZS5sZW5ndGgpCiAgfQoKICBnZXQgaWQgKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5pZAogIH0KCiAgZ2V0IGtleSAoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLmtleQogIH0KCiAgZ2V0IGRpc2NvdmVyeUtleSAoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLmRpc2NvdmVyeUtleQogIH0KCiAgZ2V0IHdyaXRhYmxlICgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUud3JpdGFibGUKICB9CgogIGdldCByZWFkYWJsZSAoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLnJlYWRhYmxlCiAgfQoKICByZXBsaWNhdGUgKGlzSW5pdGlhdG9yLCBvcHRzKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLnJlcGxpY2F0ZShpc0luaXRpYXRvciwgb3B0cykKICB9CgogIHVwZGF0ZSAob3B0cykgewogICAgcmV0dXJuIHRoaXMuY29yZS51cGRhdGUob3B0cykKICB9CgogIHBlZWsgKHJhbmdlLCBvcHRzKSB7CiAgICByZXR1cm4gaXRlcmF0b3JQZWVrKHRoaXMuY3JlYXRlUmFuZ2VJdGVyYXRvcihyYW5nZSwgeyAuLi5vcHRzLCBsaW1pdDogMSB9KSkKICB9CgogIGNyZWF0ZVJhbmdlSXRlcmF0b3IgKHJhbmdlLCBvcHRzID0ge30pIHsKICAgIC8vIGJhY2t3YXJkcyBjb21wYXQgcmFuZ2UgYXJnCiAgICBvcHRzID0gb3B0cyA/IHsgLi4ub3B0cywgLi4ucmFuZ2UgfSA6IHJhbmdlCgogICAgY29uc3QgZXh0ZW5zaW9uID0gKG9wdHMuZXh0ZW5zaW9uID09PSBmYWxzZSAmJiBvcHRzLmxpbWl0ICE9PSAwKSA/IG51bGwgOiB0aGlzLmV4dGVuc2lvbgogICAgY29uc3Qga2V5RW5jb2RpbmcgPSBvcHRzLmtleUVuY29kaW5nID8gY29kZWNzKG9wdHMua2V5RW5jb2RpbmcpIDogdGhpcy5rZXlFbmNvZGluZwoKICAgIGlmIChleHRlbnNpb24pIHsKICAgICAgY29uc3QgeyBvbnNlcSwgb253YWl0IH0gPSBvcHRzCiAgICAgIGxldCB2ZXJzaW9uID0gMAogICAgICBsZXQgbmV4dCA9IDAKCiAgICAgIG9wdHMgPSBlbmNSYW5nZShrZXlFbmNvZGluZywgewogICAgICAgIC4uLm9wdHMsCiAgICAgICAgc3ViOiB0aGlzLl9zdWIsCiAgICAgICAgb25zZXEgKHNlcSkgewogICAgICAgICAgaWYgKCF2ZXJzaW9uKSB2ZXJzaW9uID0gc2VxICsgMQogICAgICAgICAgaWYgKG5leHQpIG5leHQtLQogICAgICAgICAgaWYgKG9uc2VxKSBvbnNlcShzZXEpCiAgICAgICAgfSwKICAgICAgICBvbndhaXQgKHNlcSkgewogICAgICAgICAgaWYgKCFuZXh0KSB7CiAgICAgICAgICAgIG5leHQgPSBFeHRlbnNpb24uQkFUQ0hfU0laRQogICAgICAgICAgICBleHRlbnNpb24uaXRlcmF0b3IoaXRlLnNuYXBzaG90KHZlcnNpb24pKQogICAgICAgICAgfQogICAgICAgICAgaWYgKG9ud2FpdCkgb253YWl0KHNlcSkKICAgICAgICB9CiAgICAgIH0pCiAgICB9IGVsc2UgewogICAgICBvcHRzID0gZW5jUmFuZ2Uoa2V5RW5jb2RpbmcsIHsgLi4ub3B0cywgc3ViOiB0aGlzLl9zdWIgfSkKICAgIH0KCiAgICBjb25zdCBpdGUgPSBuZXcgUmFuZ2VJdGVyYXRvcihuZXcgQmF0Y2godGhpcywgdGhpcy5fbWFrZVNuYXBzaG90KCksIG51bGwsIGZhbHNlLCBvcHRzKSwgbnVsbCwgb3B0cykKICAgIHJldHVybiBpdGUKICB9CgogIGNyZWF0ZVJlYWRTdHJlYW0gKHJhbmdlLCBvcHRzKSB7CiAgICBjb25zdCBzaWduYWwgPSAob3B0cyAmJiBvcHRzLnNpZ25hbCkgfHwgbnVsbAogICAgcmV0dXJuIGl0ZXJhdG9yVG9TdHJlYW0odGhpcy5jcmVhdGVSYW5nZUl0ZXJhdG9yKHJhbmdlLCBvcHRzKSwgc2lnbmFsKQogIH0KCiAgY3JlYXRlSGlzdG9yeVN0cmVhbSAob3B0cykgewogICAgY29uc3Qgc2Vzc2lvbiA9IChvcHRzICYmIG9wdHMubGl2ZSkgPyB0aGlzLmNvcmUuc2Vzc2lvbigpIDogdGhpcy5fbWFrZVNuYXBzaG90KCkKICAgIGNvbnN0IHNpZ25hbCA9IChvcHRzICYmIG9wdHMuc2lnbmFsKSB8fCBudWxsCiAgICByZXR1cm4gaXRlcmF0b3JUb1N0cmVhbShuZXcgSGlzdG9yeUl0ZXJhdG9yKG5ldyBCYXRjaCh0aGlzLCBzZXNzaW9uLCBudWxsLCBmYWxzZSwgb3B0cyksIG9wdHMpLCBzaWduYWwpCiAgfQoKICBjcmVhdGVEaWZmU3RyZWFtIChyaWdodCwgcmFuZ2UsIG9wdHMpIHsKICAgIGlmICh0eXBlb2YgcmlnaHQgPT09ICdudW1iZXInKSByaWdodCA9IHRoaXMuY2hlY2tvdXQoTWF0aC5tYXgoMSwgcmlnaHQpLCB7IHJldXNlU2Vzc2lvbjogdHJ1ZSB9KQoKICAgIC8vIGJhY2t3YXJkcyBjb21wYXQgcmFuZ2UgYXJnCiAgICBvcHRzID0gb3B0cyA/IHsgLi4ub3B0cywgLi4ucmFuZ2UgfSA6IHJhbmdlCgogICAgY29uc3Qgc2lnbmFsID0gKG9wdHMgJiYgb3B0cy5zaWduYWwpIHx8IG51bGwKCiAgICBjb25zdCBrZXlFbmNvZGluZyA9IG9wdHMgJiYgb3B0cy5rZXlFbmNvZGluZyA/IGNvZGVjcyhvcHRzLmtleUVuY29kaW5nKSA6IHRoaXMua2V5RW5jb2RpbmcKICAgIGlmIChrZXlFbmNvZGluZykgb3B0cyA9IGVuY1JhbmdlKGtleUVuY29kaW5nLCB7IC4uLm9wdHMsIHN1YjogdGhpcy5fc3ViIH0pCgogICAgbGV0IGRvbmUKICAgIGxldCBjbG9zaW5nCiAgICBsZXQgaXRlCgogICAgY29uc3QgbGVmdCA9IHRoaXMKCiAgICBjb25zdCBycyA9IG5ldyBSZWFkYWJsZSh7CiAgICAgIHNpZ25hbCwKICAgICAgZWFnZXJPcGVuOiB0cnVlLAogICAgICBhc3luYyBvcGVuIChjYikgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAocmlnaHQub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgcmlnaHQucmVhZHkoKQogICAgICAgICAgaWYgKGxlZnQub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgbGVmdC5yZWFkeSgpCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBjYihlcnIpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIGlmIChjbG9zaW5nKSB7CiAgICAgICAgICBjYihudWxsKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQoKICAgICAgICBpZiAobGVmdC5jb3JlLmNsb3NpbmcgfHwgcmlnaHQuY29yZS5jbG9zaW5nKSB7CiAgICAgICAgICBjYihuZXcgRXJyb3IoJ0JlZSBjbG9zZWQnKSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgY29uc3Qgc25hcHNob3QgPSByaWdodC52ZXJzaW9uID4gbGVmdC52ZXJzaW9uCiAgICAgICAgICA/IHJpZ2h0Ll9tYWtlU25hcHNob3QoKQogICAgICAgICAgOiBsZWZ0Ll9tYWtlU25hcHNob3QoKQoKICAgICAgICBkb25lID0gY2IKICAgICAgICBpdGUgPSBuZXcgRGlmZkl0ZXJhdG9yKAogICAgICAgICAgbmV3IEJhdGNoKGxlZnQsIHNuYXBzaG90LCBudWxsLCBmYWxzZSwgb3B0cyksCiAgICAgICAgICBuZXcgQmF0Y2gocmlnaHQsIHNuYXBzaG90LCBudWxsLCBmYWxzZSwgb3B0cyksCiAgICAgICAgICBvcHRzCiAgICAgICAgKQogICAgICAgIGl0ZS5vcGVuKCkudGhlbihmaW4sIGZpbikKICAgICAgfSwKICAgICAgcmVhZCAoY2IpIHsKICAgICAgICBkb25lID0gY2IKICAgICAgICBpdGUubmV4dCgpLnRoZW4ocHVzaCwgZmluKQogICAgICB9LAogICAgICBwcmVkZXN0cm95ICgpIHsKICAgICAgICBpZiAoIWl0ZSkgewogICAgICAgICAgY2xvc2luZyA9IFByb21pc2UucmVzb2x2ZSgpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNsb3NpbmcgPSBpdGUuY2xvc2UoKQogICAgICAgICAgY2xvc2luZy5jYXRjaChub29wKQogICAgICAgIH0KICAgICAgfSwKICAgICAgZGVzdHJveSAoY2IpIHsKICAgICAgICBkb25lID0gY2IKICAgICAgICBpZiAoIWNsb3NpbmcpIGNsb3NpbmcgPSBpdGUuY2xvc2UoKQogICAgICAgIGNsb3NpbmcudGhlbihmaW4sIGZpbikKICAgICAgfQogICAgfSkKCiAgICByZXR1cm4gcnMKCiAgICBmdW5jdGlvbiBmaW4gKGVycikgewogICAgICBkb25lKGVycikKICAgIH0KCiAgICBmdW5jdGlvbiBwdXNoICh2YWwpIHsKICAgICAgcnMucHVzaCh2YWwpCiAgICAgIGRvbmUobnVsbCkKICAgIH0KICB9CgogIGdldCAoa2V5LCBvcHRzKSB7CiAgICBjb25zdCBiID0gbmV3IEJhdGNoKHRoaXMsIHRoaXMuX21ha2VTbmFwc2hvdCgpLCBudWxsLCB0cnVlLCBvcHRzKQogICAgcmV0dXJuIGIuZ2V0KGtleSkKICB9CgogIGdldEJ5U2VxIChzZXEsIG9wdHMpIHsKICAgIGNvbnN0IGIgPSBuZXcgQmF0Y2godGhpcywgdGhpcy5fbWFrZVNuYXBzaG90KCksIG51bGwsIHRydWUsIG9wdHMpCiAgICByZXR1cm4gYi5nZXRCeVNlcShzZXEpCiAgfQoKICBwdXQgKGtleSwgdmFsdWUsIG9wdHMpIHsKICAgIGNvbnN0IGIgPSBuZXcgQmF0Y2godGhpcywgdGhpcy5jb3JlLCBudWxsLCB0cnVlLCBvcHRzKQogICAgcmV0dXJuIGIucHV0KGtleSwgdmFsdWUsIG9wdHMpCiAgfQoKICBiYXRjaCAob3B0cykgewogICAgcmV0dXJuIG5ldyBCYXRjaCh0aGlzLCB0aGlzLmNvcmUsIG11dGV4aWZ5KCksIHRydWUsIG9wdHMpCiAgfQoKICBkZWwgKGtleSwgb3B0cykgewogICAgY29uc3QgYiA9IG5ldyBCYXRjaCh0aGlzLCB0aGlzLmNvcmUsIG51bGwsIHRydWUsIG9wdHMpCiAgICByZXR1cm4gYi5kZWwoa2V5LCBvcHRzKQogIH0KCiAgd2F0Y2ggKHJhbmdlLCBvcHRzKSB7CiAgICBpZiAoIXRoaXMuX3dhdGNoZXJzKSB0aHJvdyBuZXcgRXJyb3IoJ0NhbiBvbmx5IHdhdGNoIHRoZSBtYWluIGJlZSBpbnN0YW5jZScpCiAgICByZXR1cm4gbmV3IFdhdGNoZXIodGhpcywgcmFuZ2UsIG9wdHMpCiAgfQoKICBhc3luYyBnZXRBbmRXYXRjaCAoa2V5LCBvcHRzKSB7CiAgICBpZiAoIXRoaXMuX3dhdGNoZXJzKSB0aHJvdyBuZXcgRXJyb3IoJ0NhbiBvbmx5IHdhdGNoIHRoZSBtYWluIGJlZSBpbnN0YW5jZScpCgogICAgY29uc3Qgd2F0Y2hlciA9IG5ldyBFbnRyeVdhdGNoZXIodGhpcywga2V5LCBvcHRzKQogICAgYXdhaXQgd2F0Y2hlci5fZGVib3VuY2VkVXBkYXRlKCkKCiAgICBpZiAodGhpcy5jbG9zaW5nKSB7CiAgICAgIGF3YWl0IHdhdGNoZXIuY2xvc2UoKQogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JlZSBjbG9zZWQnKQogICAgfQoKICAgIHJldHVybiB3YXRjaGVyCiAgfQoKICBfb25hcHBlbmQgKCkgewogICAgZm9yIChjb25zdCB3YXRjaGVyIG9mIHRoaXMuX3dhdGNoZXJzKSB7CiAgICAgIHdhdGNoZXIuX29uYXBwZW5kKCkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHdhdGNoZXIgb2YgdGhpcy5fZW50cnlXYXRjaGVycykgewogICAgICB3YXRjaGVyLl9vbmFwcGVuZCgpCiAgICB9CiAgfQoKICBfb250cnVuY2F0ZSAobGVuZ3RoKSB7CiAgICBmb3IgKGNvbnN0IHdhdGNoZXIgb2YgdGhpcy5fd2F0Y2hlcnMpIHsKICAgICAgd2F0Y2hlci5fb250cnVuY2F0ZSgpCiAgICB9CgogICAgZm9yIChjb25zdCB3YXRjaGVyIG9mIHRoaXMuX2VudHJ5V2F0Y2hlcnMpIHsKICAgICAgd2F0Y2hlci5fb250cnVuY2F0ZSgpCiAgICB9CgogICAgdGhpcy5fbm9kZUNhY2hlLmdjKGxlbmd0aCkKICAgIHRoaXMuX2tleUNhY2hlLmdjKGxlbmd0aCkKICB9CgogIF9tYWtlU25hcHNob3QgKCkgewogICAgaWYgKHRoaXMuX3Nlc3Npb25zID09PSBmYWxzZSkgcmV0dXJuIHRoaXMuY29yZQogICAgLy8gVE9ETzogYmV0dGVyIGlmIHdlIGNvdWxkIGVuY2Fwc3VsYXRlIHRoaXMgaW4gaHlwZXJjb3JlIGluIHRoZSBmdXR1cmUKICAgIHJldHVybiAodGhpcy5fY2hlY2tvdXQgPD0gdGhpcy5jb3JlLmxlbmd0aCB8fCB0aGlzLl9jaGVja291dCA8PSAxKSA/IHRoaXMuY29yZS5zbmFwc2hvdCgpIDogdGhpcy5jb3JlLnNlc3Npb24oeyBzbmFwc2hvdDogZmFsc2UgfSkKICB9CgogIGFzeW5jIGNsZWFyVW5saW5rZWQgKG9wdGlvbnMgPSB7fSkgewogICAgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgY29uc3QgeyBndGUgPSAwLCBsdCA9IHRoaXMudmVyc2lvbiAtIDEsIGJhdGNoU2l6ZSA9IDQwOTYsIHdhaXQgPSB0cnVlIH0gPSBvcHRpb25zCiAgICBjb25zdCBjaGVja291dCA9IHRoaXMudmVyc2lvbgoKICAgIGxldCBwcmV2ID0gdGhpcy5iYXRjaCh7IHdhaXQ6IGZhbHNlLCBjaGVja291dDogZ3RlIH0pCiAgICBsZXQgYiA9IHRoaXMuYmF0Y2goeyB3YWl0LCBjaGVja291dCB9KQoKICAgIGNvbnN0IGl0ZUJhdGNoID0gdGhpcy5iYXRjaCh7IHdhaXQ6IGZhbHNlLCBjaGVja291dCB9KQogICAgY29uc3QgaXRlID0gbmV3IExvY2FsQmxvY2tJdGVyYXRvcihpdGVCYXRjaCwgeyBndGUsIGx0IH0pCiAgICBhd2FpdCBpdGUub3BlbigpCgogICAgbGV0IHRpY2tzID0gMAoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBpdGUubmV4dCgpCiAgICAgIGlmICghZGF0YSkgYnJlYWsKCiAgICAgIGlmICghKGF3YWl0IGlzTGlua2VkKGIsIGRhdGEpKSkgewogICAgICAgIGlmIChiLmNvcmUuY2xvc2luZyB8fCB0aGlzLmNvcmUuY2xvc2luZyB8fCB0aGlzLmNsb3NpbmcpIGJyZWFrCiAgICAgICAgYXdhaXQgdGhpcy5jb3JlLmNsZWFyKGRhdGEuc2VxKQogICAgICB9CgogICAgICBjb25zdCBwcmV2Tm9kZSA9IGF3YWl0IHByZXYuZ2V0KGRhdGEua2V5LCB7IGZpbmFsaXplOiBmYWxzZSB9KS5jYXRjaCh0b051bGwpCgogICAgICBpZiAocHJldk5vZGUgJiYgIShhd2FpdCBpc0xpbmtlZChiLCBwcmV2Tm9kZSkpKSB7CiAgICAgICAgaWYgKGIuY29yZS5jbG9zaW5nIHx8IHRoaXMuY29yZS5jbG9zaW5nIHx8IHRoaXMuY2xvc2luZykgYnJlYWsKICAgICAgICBhd2FpdCB0aGlzLmNvcmUuY2xlYXIocHJldk5vZGUuc2VxKQogICAgICB9CgogICAgICBpZiAodGlja3MrKyA+PSBiYXRjaFNpemUpIHsKICAgICAgICB0aWNrcyA9IDAKICAgICAgICBhd2FpdCBwcmV2LmNsb3NlKCkKICAgICAgICBhd2FpdCBiLmNsb3NlKCkKCiAgICAgICAgcHJldiA9IHRoaXMuYmF0Y2goeyB3YWl0OiBmYWxzZSwgY2hlY2tvdXQ6IGd0ZSB9KQogICAgICAgIGIgPSB0aGlzLmJhdGNoKHsgd2FpdCwgY2hlY2tvdXQgfSkKICAgICAgfQogICAgfQoKICAgIGlmIChiLmNvcmUuY2xvc2luZyB8fCB0aGlzLmNvcmUuY2xvc2luZyB8fCB0aGlzLmNsb3NpbmcpIHRocm93IG5ldyBFcnJvcignQ29yZSBpcyBjbG9zZWQnKQoKICAgIGF3YWl0IGIuY2xvc2UoKQogICAgYXdhaXQgcHJldi5jbG9zZSgpCiAgICBhd2FpdCBpdGUuY2xvc2UoKQogICAgYXdhaXQgaXRlQmF0Y2guY2xvc2UoKQoKICAgIHJldHVybiBsdAogIH0KCiAgY2hlY2tvdXQgKHZlcnNpb24sIG9wdHMgPSB7fSkgewogICAgaWYgKHZlcnNpb24gPT09IDApIHZlcnNpb24gPSAxCgogICAgLy8gc2FtZSBhcyBhYm92ZSwganVzdCBjaGVja291dCBpc24ndCBzZXQgeWV0Li4uCiAgICBjb25zdCBzbmFwID0gKG9wdHMucmV1c2VTZXNzaW9uIHx8IHRoaXMuX3Nlc3Npb25zID09PSBmYWxzZSkKICAgICAgPyB0aGlzLmNvcmUKICAgICAgOiAodmVyc2lvbiA8PSB0aGlzLmNvcmUubGVuZ3RoIHx8IHZlcnNpb24gPD0gMSkgPyB0aGlzLmNvcmUuc25hcHNob3QoKSA6IHRoaXMuY29yZS5zZXNzaW9uKHsgc25hcHNob3Q6IGZhbHNlIH0pCgogICAgcmV0dXJuIG5ldyBIeXBlcmJlZShzbmFwLCB7CiAgICAgIF92aWV3OiB0cnVlLAogICAgICBfc3ViOiBmYWxzZSwKICAgICAgcHJlZml4OiB0aGlzLnByZWZpeCwKICAgICAgc2VwOiB0aGlzLnNlcCwKICAgICAgbG9jazogdGhpcy5sb2NrLAogICAgICBjaGVja291dDogdmVyc2lvbiwKICAgICAga2V5RW5jb2Rpbmc6IG9wdHMua2V5RW5jb2RpbmcgfHwgdGhpcy5rZXlFbmNvZGluZywKICAgICAgdmFsdWVFbmNvZGluZzogb3B0cy52YWx1ZUVuY29kaW5nIHx8IHRoaXMudmFsdWVFbmNvZGluZywKICAgICAgZXh0ZW5zaW9uOiB0aGlzLmV4dGVuc2lvbiAhPT0gbnVsbCA/IHRoaXMuZXh0ZW5zaW9uIDogZmFsc2UKICAgIH0pCiAgfQoKICBzbmFwc2hvdCAob3B0cykgewogICAgcmV0dXJuIHRoaXMuY2hlY2tvdXQoKHRoaXMuY29yZS5vcGVuZWQgPT09IGZhbHNlIHx8IHRoaXMuX2NoZWNrb3V0IDw9IDApID8gLTEgOiBNYXRoLm1heCgxLCB0aGlzLnZlcnNpb24pLCBvcHRzKQogIH0KCiAgc3ViIChwcmVmaXgsIG9wdHMgPSB7fSkgewogICAgbGV0IHNlcCA9IG9wdHMuc2VwIHx8IHRoaXMuc2VwCiAgICBpZiAoIWI0YS5pc0J1ZmZlcihzZXApKSBzZXAgPSBiNGEuZnJvbShzZXApCgogICAgcHJlZml4ID0gYjRhLmNvbmNhdChbdGhpcy5wcmVmaXggfHwgRU1QVFksIGI0YS5mcm9tKHByZWZpeCksIHNlcF0pCgogICAgY29uc3QgdmFsdWVFbmNvZGluZyA9IGNvZGVjcyhvcHRzLnZhbHVlRW5jb2RpbmcgfHwgdGhpcy52YWx1ZUVuY29kaW5nKQogICAgY29uc3Qga2V5RW5jb2RpbmcgPSBjb2RlY3Mob3B0cy5rZXlFbmNvZGluZyB8fCB0aGlzLl91bnByZWZpeGVkS2V5RW5jb2RpbmcpCgogICAgcmV0dXJuIG5ldyBIeXBlcmJlZSh0aGlzLmNvcmUsIHsKICAgICAgX3ZpZXc6IHRydWUsCiAgICAgIF9zdWI6IHRydWUsCiAgICAgIHByZWZpeCwKICAgICAgc2VwOiB0aGlzLnNlcCwKICAgICAgbG9jazogdGhpcy5sb2NrLAogICAgICBjaGVja291dDogdGhpcy5fY2hlY2tvdXQsCiAgICAgIHZhbHVlRW5jb2RpbmcsCiAgICAgIGtleUVuY29kaW5nLAogICAgICBleHRlbnNpb246IHRoaXMuZXh0ZW5zaW9uICE9PSBudWxsID8gdGhpcy5leHRlbnNpb24gOiBmYWxzZSwKICAgICAgbWV0YWRhdGE6IHRoaXMubWV0YWRhdGEKICAgIH0pCiAgfQoKICBhc3luYyBnZXRIZWFkZXIgKG9wdHMpIHsKICAgIGNvbnN0IGJsayA9IGF3YWl0IHRoaXMuY29yZS5nZXQoMCwgb3B0cykKICAgIHRyeSB7CiAgICAgIHJldHVybiBibGsgJiYgSGVhZGVyLmRlY29kZShibGspCiAgICB9IGNhdGNoIHsKICAgICAgdGhyb3cgREVDT0RJTkdfRVJST1IoKQogICAgfQogIH0KCiAgYXN5bmMgX2Nsb3NlICgpIHsKICAgIGlmICghdGhpcy5fdmlldykgewogICAgICBpZiAodGhpcy5fa2V5Q2FjaGUpIHRoaXMuX2tleUNhY2hlLmNsZWFyKCkKICAgICAgaWYgKHRoaXMuX25vZGVDYWNoZSkgdGhpcy5fbm9kZUNhY2hlLmNsZWFyKCkKICAgIH0KCiAgICBpZiAodGhpcy5fd2F0Y2hlcnMpIHsKICAgICAgdGhpcy5jb3JlLm9mZignYXBwZW5kJywgdGhpcy5fb25hcHBlbmRCb3VuZCkKICAgICAgdGhpcy5jb3JlLm9mZigndHJ1bmNhdGUnLCB0aGlzLl9vbnRydW5jYXRlQm91bmQpCgogICAgICB3aGlsZSAodGhpcy5fd2F0Y2hlcnMubGVuZ3RoKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fd2F0Y2hlcnNbdGhpcy5fd2F0Y2hlcnMubGVuZ3RoIC0gMV0uY2xvc2UoKQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMuX2VudHJ5V2F0Y2hlcnMpIHsKICAgICAgd2hpbGUgKHRoaXMuX2VudHJ5V2F0Y2hlcnMubGVuZ3RoKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fZW50cnlXYXRjaGVyc1t0aGlzLl9lbnRyeVdhdGNoZXJzLmxlbmd0aCAtIDFdLmNsb3NlKCkKICAgICAgfQogICAgfQoKICAgIHdoaWxlICh0aGlzLl9iYXRjaGVzLmxlbmd0aCkgewogICAgICBhd2FpdCB0aGlzLl9iYXRjaGVzW3RoaXMuX2JhdGNoZXMubGVuZ3RoIC0gMV0uY2xvc2UoKQogICAgfQoKICAgIHJldHVybiB0aGlzLmNvcmUuY2xvc2UoKQogIH0KCiAgc3RhdGljIGFzeW5jIGlzSHlwZXJiZWUgKGNvcmUsIG9wdHMpIHsKICAgIGF3YWl0IGNvcmUucmVhZHkoKQoKICAgIGNvbnN0IGJsazAgPSBhd2FpdCBjb3JlLmdldCgwLCBvcHRzKQogICAgaWYgKGJsazAgPT09IG51bGwpIHRocm93IEJMT0NLX05PVF9BVkFJTEFCTEUoKQoKICAgIHRyeSB7CiAgICAgIHJldHVybiBIZWFkZXIuZGVjb2RlKGJsazApLnByb3RvY29sID09PSAnaHlwZXJiZWUnCiAgICB9IGNhdGNoIChlcnIpIHsgLy8gdW5kZWNvZGFibGUKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQp9CgpjbGFzcyBCYXRjaCB7CiAgY29uc3RydWN0b3IgKHRyZWUsIGNvcmUsIGJhdGNoTG9jaywgY2FjaGUsIG9wdGlvbnMgPSB7fSkgewogICAgdGhpcy50cmVlID0gdHJlZQogICAgLy8gdGhpcy5mZWVkIGlzIG5vdyBkZXByZWNhdGVkLCBhbmQgd2lsbCBiZSB0aGlzLmNvcmUgZ29pbmcgZm9yd2FyZAogICAgdGhpcy5mZWVkID0gY29yZQogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy5pbmRleCA9IHRyZWUuX2JhdGNoZXMucHVzaCh0aGlzKSAtIDEKICAgIHRoaXMuYmxvY2tzID0gY2FjaGUgPyBuZXcgTWFwKCkgOiBudWxsCiAgICB0aGlzLmF1dG9GbHVzaCA9ICFiYXRjaExvY2sKICAgIHRoaXMubWF4QmxvY2tzQ2FjaGVkID0gb3B0aW9ucy5tYXhCbG9ja3NDYWNoZWQgfHwgMTI4CiAgICB0aGlzLnJvb3RTZXEgPSAwCiAgICB0aGlzLnJvb3QgPSBudWxsCiAgICB0aGlzLmxlbmd0aCA9IDAKICAgIHRoaXMuY2hlY2tvdXQgPSBvcHRpb25zLmNoZWNrb3V0ID09PSB1bmRlZmluZWQgPyAtMSA6IG9wdGlvbnMuY2hlY2tvdXQKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMKICAgIHRoaXMubG9ja2VkID0gbnVsbAogICAgdGhpcy5iYXRjaExvY2sgPSBiYXRjaExvY2sKICAgIHRoaXMub25zZXEgPSB0aGlzLm9wdGlvbnMub25zZXEgfHwgbm9vcAogICAgdGhpcy5hcHBlbmRpbmcgPSBudWxsCiAgICB0aGlzLmlzU25hcHNob3QgPSB0aGlzLmNvcmUgIT09IHRoaXMudHJlZS5jb3JlCiAgICB0aGlzLnNob3VsZFVwZGF0ZSA9IHRoaXMub3B0aW9ucy51cGRhdGUgIT09IGZhbHNlCiAgICB0aGlzLnVwZGF0aW5nID0gbnVsbAogICAgdGhpcy5lbmNvZGluZyA9IHsKICAgICAga2V5OiBvcHRpb25zLmtleUVuY29kaW5nID8gY29kZWNzKG9wdGlvbnMua2V5RW5jb2RpbmcpIDogdHJlZS5rZXlFbmNvZGluZywKICAgICAgdmFsdWU6IG9wdGlvbnMudmFsdWVFbmNvZGluZyA/IGNvZGVjcyhvcHRpb25zLnZhbHVlRW5jb2RpbmcpIDogdHJlZS52YWx1ZUVuY29kaW5nCiAgICB9CiAgfQoKICBhc3luYyByZWFkeSAoKSB7CiAgICBpZiAodGhpcy5jb3JlLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCiAgICBpZiAodGhpcy50cmVlLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMudHJlZS5yZWFkeSgpCiAgfQoKICBhc3luYyBsb2NrICgpIHsKICAgIGlmICh0aGlzLnRyZWUucmVhZG9ubHkpIHRocm93IG5ldyBFcnJvcignSHlwZXJiZWUgaXMgbWFya2VkIGFzIHJlYWQtb25seScpCiAgICBpZiAodGhpcy5sb2NrZWQgPT09IG51bGwpIHRoaXMubG9ja2VkID0gYXdhaXQgdGhpcy50cmVlLmxvY2soKQogIH0KCiAgZ2V0IHZlcnNpb24gKCkgewogICAgaWYgKHRoaXMuY2hlY2tvdXQgIT09IC0xKSByZXR1cm4gTWF0aC5tYXgoMSwgdGhpcy5jaGVja291dCkKICAgIHJldHVybiBNYXRoLm1heCgxLCB0aGlzLnRyZWUuX2NoZWNrb3V0IHx8ICh0aGlzLmNvcmUubGVuZ3RoICsgdGhpcy5sZW5ndGgpKQogIH0KCiAgYXN5bmMgZ2V0Um9vdCAoZW5zdXJlSGVhZGVyKSB7CiAgICBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmIChlbnN1cmVIZWFkZXIpIHsKICAgICAgaWYgKHRoaXMuY29yZS5sZW5ndGggPT09IDAgJiYgdGhpcy5jb3JlLndyaXRhYmxlICYmICF0aGlzLnRyZWUucmVhZG9ubHkpIHsKICAgICAgICBhd2FpdCB0aGlzLmNvcmUuYXBwZW5kKEhlYWRlci5lbmNvZGUoewogICAgICAgICAgcHJvdG9jb2w6ICdoeXBlcmJlZScsCiAgICAgICAgICBtZXRhZGF0YTogdGhpcy50cmVlLm1ldGFkYXRhCiAgICAgICAgfSkpCiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLnRyZWUuX2NoZWNrb3V0ID09PSAwICYmIHRoaXMuY2hlY2tvdXQgPT09IC0xICYmIHRoaXMuc2hvdWxkVXBkYXRlKSB7CiAgICAgIGlmICh0aGlzLnVwZGF0aW5nID09PSBudWxsKSB0aGlzLnVwZGF0aW5nID0gdGhpcy5jb3JlLnVwZGF0ZSgpCiAgICAgIGF3YWl0IHRoaXMudXBkYXRpbmcKICAgIH0KICAgIGlmICh0aGlzLnZlcnNpb24gPCAyKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIChhd2FpdCB0aGlzLmdldEJsb2NrKHRoaXMudmVyc2lvbiAtIDEpKS5nZXRUcmVlTm9kZSgwKQogIH0KCiAgYXN5bmMgZ2V0S2V5IChzZXEpIHsKICAgIGF3YWl0IHRoaXMudHJlZS5fY2FjaGVMb2NrLmVudGVyKHNlcSkKCiAgICB0cnkgewogICAgICBjb25zdCBrID0gdGhpcy5jb3JlLmZvcmsgPT09IHRoaXMudHJlZS5jb3JlLmZvcmsgPyB0aGlzLnRyZWUuX2tleUNhY2hlLmdldChzZXEpIDogbnVsbAogICAgICBpZiAoayAhPT0gbnVsbCkgcmV0dXJuIGsKICAgICAgY29uc3Qga2V5ID0gKGF3YWl0IHRoaXMuX2dldEJsb2NrKHNlcSkpLmtleQogICAgICBpZiAodGhpcy5jb3JlLmZvcmsgPT09IHRoaXMudHJlZS5jb3JlLmZvcmspIHRoaXMudHJlZS5fa2V5Q2FjaGUuc2V0KHNlcSwga2V5KQogICAgICByZXR1cm4ga2V5CiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLnRyZWUuX2NhY2hlTG9jay5leGl0KHNlcSkKICAgIH0KICB9CgogIGFzeW5jIF9nZXROb2RlIChzZXEpIHsKICAgIGNvbnN0IGNhY2hlZCA9ICh0aGlzLnRyZWUuX25vZGVDYWNoZSAhPT0gbnVsbCAmJiB0aGlzLmNvcmUuZm9yayA9PT0gdGhpcy50cmVlLmNvcmUuZm9yaykgPyB0aGlzLnRyZWUuX25vZGVDYWNoZS5nZXQoc2VxKSA6IG51bGwKICAgIGlmIChjYWNoZWQgIT09IG51bGwpIHJldHVybiBjYWNoZWQKICAgIGNvbnN0IGVudHJ5ID0gYXdhaXQgdGhpcy5jb3JlLmdldChzZXEsIHsgLi4udGhpcy5vcHRpb25zLCB2YWx1ZUVuY29kaW5nOiBOb2RlIH0pCiAgICBpZiAoZW50cnkgPT09IG51bGwpIHRocm93IEJMT0NLX05PVF9BVkFJTEFCTEUoKQogICAgY29uc3Qgd3JhcCA9IGNvcHlFbnRyeShlbnRyeSkKICAgIGlmICh0aGlzLmNvcmUuZm9yayA9PT0gdGhpcy50cmVlLmNvcmUuZm9yayAmJiB0aGlzLnRyZWUuX25vZGVDYWNoZSAhPT0gbnVsbCkgdGhpcy50cmVlLl9ub2RlQ2FjaGUuc2V0KHNlcSwgd3JhcCkKICAgIHJldHVybiB3cmFwCiAgfQoKICBhc3luYyBnZXRCbG9jayAoc2VxKSB7CiAgICBpZiAodGhpcy5yb290U2VxID09PSAwKSB0aGlzLnJvb3RTZXEgPSBzZXEKICAgIGF3YWl0IHRoaXMudHJlZS5fY2FjaGVMb2NrLmVudGVyKHNlcSkKCiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0QmxvY2soc2VxKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy50cmVlLl9jYWNoZUxvY2suZXhpdChzZXEpCiAgICB9CiAgfQoKICBhc3luYyBfZ2V0QmxvY2sgKHNlcSkgewogICAgbGV0IGIgPSB0aGlzLmJsb2NrcyAmJiB0aGlzLmJsb2Nrcy5nZXQoc2VxKQogICAgaWYgKGIpIHJldHVybiBiCiAgICB0aGlzLm9uc2VxKHNlcSkKICAgIGNvbnN0IGVudHJ5ID0gYXdhaXQgdGhpcy5fZ2V0Tm9kZShzZXEpCiAgICBiID0gdGhpcy5ibG9ja3MgJiYgdGhpcy5ibG9ja3MuZ2V0KHNlcSkKICAgIGlmIChiKSByZXR1cm4gYgogICAgYiA9IG5ldyBCbG9ja0VudHJ5KHNlcSwgdGhpcywgZW50cnkpCiAgICBpZiAodGhpcy5ibG9ja3MgJiYgKHRoaXMuYmxvY2tzLnNpemUgLSB0aGlzLmxlbmd0aCkgPCB0aGlzLm1heEJsb2Nrc0NhY2hlZCkgdGhpcy5ibG9ja3Muc2V0KHNlcSwgYikKICAgIHJldHVybiBiCiAgfQoKICBfb253YWl0IChrZXkpIHsKICAgIHRoaXMub3B0aW9ucy5vbndhaXQgPSBudWxsCiAgICB0aGlzLnRyZWUuZXh0ZW5zaW9uLmdldCh0aGlzLnJvb3RTZXEgKyAxLCBrZXkpCiAgfQoKICBfZ2V0RW5jb2RpbmcgKG9wdHMpIHsKICAgIGlmICghb3B0cykgcmV0dXJuIHRoaXMuZW5jb2RpbmcKICAgIHJldHVybiB7CiAgICAgIGtleTogb3B0cy5rZXlFbmNvZGluZyA/IGNvZGVjcyhvcHRzLmtleUVuY29kaW5nKSA6IHRoaXMuZW5jb2Rpbmcua2V5LAogICAgICB2YWx1ZTogb3B0cy52YWx1ZUVuY29kaW5nID8gY29kZWNzKG9wdHMudmFsdWVFbmNvZGluZykgOiB0aGlzLmVuY29kaW5nLnZhbHVlCiAgICB9CiAgfQoKICBwZWVrIChyYW5nZSwgb3B0cykgewogICAgcmV0dXJuIGl0ZXJhdG9yUGVlayh0aGlzLmNyZWF0ZVJhbmdlSXRlcmF0b3IocmFuZ2UsIHsgLi4ub3B0cywgbGltaXQ6IDEgfSkpCiAgfQoKICBjcmVhdGVSYW5nZUl0ZXJhdG9yIChyYW5nZSwgb3B0cyA9IHt9KSB7CiAgICAvLyBiYWNrd2FyZHMgY29tcGF0IHJhbmdlIGFyZwogICAgb3B0cyA9IG9wdHMgPyB7IC4uLm9wdHMsIC4uLnJhbmdlIH0gOiByYW5nZQoKICAgIGNvbnN0IGVuY29kaW5nID0gdGhpcy5fZ2V0RW5jb2Rpbmcob3B0cykKICAgIHJldHVybiBuZXcgUmFuZ2VJdGVyYXRvcih0aGlzLCBlbmNvZGluZywgZW5jUmFuZ2UoZW5jb2Rpbmcua2V5LCB7IC4uLm9wdHMsIHN1YjogdGhpcy50cmVlLl9zdWIgfSkpCiAgfQoKICBjcmVhdGVSZWFkU3RyZWFtIChyYW5nZSwgb3B0cykgewogICAgY29uc3Qgc2lnbmFsID0gKG9wdHMgJiYgb3B0cy5zaWduYWwpIHx8IG51bGwKICAgIHJldHVybiBpdGVyYXRvclRvU3RyZWFtKHRoaXMuY3JlYXRlUmFuZ2VJdGVyYXRvcihyYW5nZSwgb3B0cyksIHNpZ25hbCkKICB9CgogIGFzeW5jIGdldEJ5U2VxIChzZXEsIG9wdHMpIHsKICAgIGNvbnN0IGVuY29kaW5nID0gdGhpcy5fZ2V0RW5jb2Rpbmcob3B0cykKCiAgICB0cnkgewogICAgICBjb25zdCBibG9jayA9IChhd2FpdCB0aGlzLmdldEJsb2NrKHNlcSkpLmZpbmFsKGVuY29kaW5nKQogICAgICByZXR1cm4geyBrZXk6IGJsb2NrLmtleSwgdmFsdWU6IGJsb2NrLnZhbHVlIH0KICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IHRoaXMuX2Nsb3NlU25hcHNob3QoKQogICAgfQogIH0KCiAgYXN5bmMgZ2V0IChrZXksIG9wdHMpIHsKICAgIGNvbnN0IGVuY29kaW5nID0gdGhpcy5fZ2V0RW5jb2Rpbmcob3B0cykKICAgIGNvbnN0IGZpbmFsaXplID0gb3B0cyA/IG9wdHMuZmluYWxpemUgIT09IGZhbHNlIDogdHJ1ZQoKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9nZXQoa2V5LCBlbmNvZGluZywgZmluYWxpemUpCiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCB0aGlzLl9jbG9zZVNuYXBzaG90KCkKICAgIH0KICB9CgogIGFzeW5jIF9nZXQgKGtleSwgZW5jb2RpbmcsIGZpbmFsaXplKSB7CiAgICBrZXkgPSBlbmMoZW5jb2Rpbmcua2V5LCBrZXkpCgogICAgaWYgKHRoaXMudHJlZS5leHRlbnNpb24gIT09IG51bGwgJiYgdGhpcy5vcHRpb25zLmV4dGVuc2lvbiAhPT0gZmFsc2UpIHsKICAgICAgdGhpcy5vcHRpb25zLm9ud2FpdCA9IHRoaXMuX29ud2FpdC5iaW5kKHRoaXMsIGtleSkKICAgIH0KCiAgICBsZXQgbm9kZSA9IGF3YWl0IHRoaXMuZ2V0Um9vdChmYWxzZSkKICAgIGlmICghbm9kZSkgcmV0dXJuIG51bGwKCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAobm9kZS5ibG9jay5pc1RhcmdldChrZXkpKSB7CiAgICAgICAgcmV0dXJuIG5vZGUuYmxvY2suaXNEZWxldGlvbigpID8gbnVsbCA6IChmaW5hbGl6ZSA/IG5vZGUuYmxvY2suZmluYWwoZW5jb2RpbmcpIDogbm9kZS5ibG9jaykKICAgICAgfQoKICAgICAgbGV0IHMgPSAwCiAgICAgIGxldCBlID0gbm9kZS5rZXlzLmxlbmd0aAogICAgICBsZXQgYwoKICAgICAgd2hpbGUgKHMgPCBlKSB7CiAgICAgICAgY29uc3QgbWlkID0gKHMgKyBlKSA+PiAxCgogICAgICAgIGMgPSBiNGEuY29tcGFyZShrZXksIGF3YWl0IG5vZGUuZ2V0S2V5KG1pZCkpCgogICAgICAgIGlmIChjID09PSAwKSB7CiAgICAgICAgICBjb25zdCBibG9jayA9IGF3YWl0IHRoaXMuZ2V0QmxvY2sobm9kZS5rZXlzW21pZF0uc2VxKQogICAgICAgICAgcmV0dXJuIGZpbmFsaXplID8gYmxvY2suZmluYWwoZW5jb2RpbmcpIDogYmxvY2sKICAgICAgICB9CgogICAgICAgIGlmIChjIDwgMCkgZSA9IG1pZAogICAgICAgIGVsc2UgcyA9IG1pZCArIDEKICAgICAgfQoKICAgICAgaWYgKCFub2RlLmNoaWxkcmVuLmxlbmd0aCkgcmV0dXJuIG51bGwKCiAgICAgIGNvbnN0IGkgPSBjIDwgMCA/IGUgOiBzCiAgICAgIG5vZGUgPSBhd2FpdCBub2RlLmdldENoaWxkTm9kZShpKQogICAgfQogIH0KCiAgYXN5bmMgbGlua3MgKGtleSwgc2VxKSB7CiAgICBsZXQgbm9kZSA9IGF3YWl0IHRoaXMuZ2V0Um9vdChmYWxzZSkKICAgIGlmICghbm9kZSkgcmV0dXJuIGZhbHNlCgogICAgaWYgKG5vZGUuYmxvY2suc2VxID09PSBzZXEpIHJldHVybiB0cnVlCgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKG5vZGUuYmxvY2suaXNUYXJnZXQoa2V5KSkgcmV0dXJuIGZhbHNlCgogICAgICBsZXQgcyA9IDAKICAgICAgbGV0IGUgPSBub2RlLmtleXMubGVuZ3RoCiAgICAgIGxldCBjCgogICAgICB3aGlsZSAocyA8IGUpIHsKICAgICAgICBjb25zdCBtaWQgPSAocyArIGUpID4+IDEKCiAgICAgICAgaWYgKG5vZGUua2V5c1ttaWRdLnNlcSA9PT0gc2VxKSByZXR1cm4gdHJ1ZQogICAgICAgIGMgPSBiNGEuY29tcGFyZShrZXksIGF3YWl0IG5vZGUuZ2V0S2V5KG1pZCkpCgogICAgICAgIGlmIChjID09PSAwKSByZXR1cm4gZmFsc2UKCiAgICAgICAgaWYgKGMgPCAwKSBlID0gbWlkCiAgICAgICAgZWxzZSBzID0gbWlkICsgMQogICAgICB9CgogICAgICBpZiAoIW5vZGUuY2hpbGRyZW4ubGVuZ3RoKSByZXR1cm4gZmFsc2UKCiAgICAgIGNvbnN0IGkgPSBjIDwgMCA/IGUgOiBzCiAgICAgIG5vZGUgPSBhd2FpdCBub2RlLmdldENoaWxkTm9kZShpKQogICAgICBpZiAobm9kZS5ibG9jay5zZXEgPT09IHNlcSkgcmV0dXJuIHRydWUKICAgIH0KICB9CgogIGFzeW5jIHB1dCAoa2V5LCB2YWx1ZSwgb3B0cykgewogICAgY29uc3QgcmVsZWFzZSA9IHRoaXMuYmF0Y2hMb2NrID8gYXdhaXQgdGhpcy5iYXRjaExvY2soKSA6IG51bGwKCiAgICBjb25zdCBjYXMgPSAob3B0cyAmJiBvcHRzLmNhcykgfHwgbnVsbAogICAgY29uc3QgZW5jb2RpbmcgPSB0aGlzLl9nZXRFbmNvZGluZyhvcHRzKQoKICAgIGlmICghdGhpcy5sb2NrZWQpIGF3YWl0IHRoaXMubG9jaygpCiAgICBpZiAoIXJlbGVhc2UpIHJldHVybiB0aGlzLl9wdXQoa2V5LCB2YWx1ZSwgZW5jb2RpbmcsIGNhcykKCiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fcHV0KGtleSwgdmFsdWUsIGVuY29kaW5nLCBjYXMpCiAgICB9IGZpbmFsbHkgewogICAgICByZWxlYXNlKCkKICAgIH0KICB9CgogIGFzeW5jIF9wdXQgKGtleSwgdmFsdWUsIGVuY29kaW5nLCBjYXMpIHsKICAgIGNvbnN0IG5ld05vZGUgPSB7CiAgICAgIHNlcTogMCwKICAgICAga2V5LAogICAgICB2YWx1ZQogICAgfQogICAga2V5ID0gZW5jKGVuY29kaW5nLmtleSwga2V5KQogICAgdmFsdWUgPSBlbmMoZW5jb2RpbmcudmFsdWUsIHZhbHVlKQoKICAgIGNvbnN0IHN0YWNrID0gW10KCiAgICBsZXQgcm9vdAogICAgbGV0IG5vZGUgPSByb290ID0gYXdhaXQgdGhpcy5nZXRSb290KHRydWUpCiAgICBpZiAoIW5vZGUpIG5vZGUgPSByb290ID0gVHJlZU5vZGUuY3JlYXRlKG51bGwpCgogICAgY29uc3Qgc2VxID0gbmV3Tm9kZS5zZXEgPSB0aGlzLmNvcmUubGVuZ3RoICsgdGhpcy5sZW5ndGgKICAgIGNvbnN0IHRhcmdldCA9IG5ldyBLZXkoc2VxLCBrZXkpCgogICAgd2hpbGUgKG5vZGUuY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgIHN0YWNrLnB1c2gobm9kZSkKICAgICAgbm9kZS5jaGFuZ2VkID0gdHJ1ZSAvLyBjaGFuZ2VkLCBidXQgY29tcHJlc3NpYmxlCgogICAgICBsZXQgcyA9IDAKICAgICAgbGV0IGUgPSBub2RlLmtleXMubGVuZ3RoCiAgICAgIGxldCBjCgogICAgICB3aGlsZSAocyA8IGUpIHsKICAgICAgICBjb25zdCBtaWQgPSAocyArIGUpID4+IDEKICAgICAgICBjID0gYjRhLmNvbXBhcmUodGFyZ2V0LnZhbHVlLCBhd2FpdCBub2RlLmdldEtleShtaWQpKQoKICAgICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgICAgaWYgKGNhcykgewogICAgICAgICAgICBjb25zdCBwcmV2ID0gYXdhaXQgbm9kZS5nZXRLZXlOb2RlKG1pZCkKICAgICAgICAgICAgaWYgKCEoYXdhaXQgY2FzKHByZXYuZmluYWwoZW5jb2RpbmcpLCBuZXdOb2RlKSkpIHJldHVybiB0aGlzLl91bmxvY2tNYXliZSgpCiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXRoaXMudHJlZS5hbHdheXNEdXBsaWNhdGUpIHsKICAgICAgICAgICAgY29uc3QgcHJldiA9IGF3YWl0IG5vZGUuZ2V0S2V5Tm9kZShtaWQpCiAgICAgICAgICAgIGlmIChzYW1lVmFsdWUocHJldi52YWx1ZSwgdmFsdWUpKSByZXR1cm4gdGhpcy5fdW5sb2NrTWF5YmUoKQogICAgICAgICAgfQogICAgICAgICAgbm9kZS5zZXRLZXkobWlkLCB0YXJnZXQpCiAgICAgICAgICByZXR1cm4gdGhpcy5fYXBwZW5kKHJvb3QsIHNlcSwga2V5LCB2YWx1ZSkKICAgICAgICB9CgogICAgICAgIGlmIChjIDwgMCkgZSA9IG1pZAogICAgICAgIGVsc2UgcyA9IG1pZCArIDEKICAgICAgfQoKICAgICAgY29uc3QgaSA9IGMgPCAwID8gZSA6IHMKICAgICAgbm9kZSA9IGF3YWl0IG5vZGUuZ2V0Q2hpbGROb2RlKGkpCiAgICB9CgogICAgbGV0IG5lZWRzU3BsaXQgPSAhKGF3YWl0IG5vZGUuaW5zZXJ0S2V5KHRhcmdldCwgdmFsdWUsIG51bGwsIG5ld05vZGUsIGVuY29kaW5nLCBjYXMpKQogICAgaWYgKCFub2RlLmNoYW5nZWQpIHJldHVybiB0aGlzLl91bmxvY2tNYXliZSgpCgogICAgd2hpbGUgKG5lZWRzU3BsaXQpIHsKICAgICAgY29uc3QgcGFyZW50ID0gc3RhY2sucG9wKCkKICAgICAgY29uc3QgeyBtZWRpYW4sIHJpZ2h0IH0gPSBhd2FpdCBub2RlLnNwbGl0KCkKCiAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICBuZWVkc1NwbGl0ID0gIShhd2FpdCBwYXJlbnQuaW5zZXJ0S2V5KG1lZGlhbiwgdmFsdWUsIHJpZ2h0LCBudWxsLCBlbmNvZGluZywgbnVsbCkpCiAgICAgICAgbm9kZSA9IHBhcmVudAogICAgICB9IGVsc2UgewogICAgICAgIHJvb3QgPSBUcmVlTm9kZS5jcmVhdGUobm9kZS5ibG9jaykKICAgICAgICByb290LmNoYW5nZWQgPSB0cnVlCiAgICAgICAgcm9vdC5rZXlzLnB1c2gobWVkaWFuKQogICAgICAgIHJvb3QuY2hpbGRyZW4ucHVzaChuZXcgQ2hpbGQoMCwgMCwgbm9kZSksIG5ldyBDaGlsZCgwLCAwLCByaWdodCkpCiAgICAgICAgbmVlZHNTcGxpdCA9IGZhbHNlCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGhpcy5fYXBwZW5kKHJvb3QsIHNlcSwga2V5LCB2YWx1ZSkKICB9CgogIGFzeW5jIGRlbCAoa2V5LCBvcHRzKSB7CiAgICBjb25zdCByZWxlYXNlID0gdGhpcy5iYXRjaExvY2sgPyBhd2FpdCB0aGlzLmJhdGNoTG9jaygpIDogbnVsbAogICAgY29uc3QgY2FzID0gKG9wdHMgJiYgb3B0cy5jYXMpIHx8IG51bGwKICAgIGNvbnN0IGVuY29kaW5nID0gdGhpcy5fZ2V0RW5jb2Rpbmcob3B0cykKCiAgICBpZiAoIXRoaXMubG9ja2VkKSBhd2FpdCB0aGlzLmxvY2soKQogICAgaWYgKCFyZWxlYXNlKSByZXR1cm4gdGhpcy5fZGVsKGtleSwgZW5jb2RpbmcsIGNhcykKCiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZGVsKGtleSwgZW5jb2RpbmcsIGNhcykKICAgIH0gZmluYWxseSB7CiAgICAgIHJlbGVhc2UoKQogICAgfQogIH0KCiAgYXN5bmMgX2RlbCAoa2V5LCBlbmNvZGluZywgY2FzKSB7CiAgICBjb25zdCBkZWxOb2RlID0gewogICAgICBzZXE6IDAsCiAgICAgIGtleSwKICAgICAgdmFsdWU6IG51bGwKICAgIH0KCiAgICBrZXkgPSBlbmMoZW5jb2Rpbmcua2V5LCBrZXkpCgogICAgY29uc3Qgc3RhY2sgPSBbXQoKICAgIGxldCBub2RlID0gYXdhaXQgdGhpcy5nZXRSb290KHRydWUpCiAgICBpZiAoIW5vZGUpIHJldHVybiB0aGlzLl91bmxvY2tNYXliZSgpCgogICAgY29uc3Qgc2VxID0gZGVsTm9kZS5zZXEgPSB0aGlzLmNvcmUubGVuZ3RoICsgdGhpcy5sZW5ndGgKCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBzdGFjay5wdXNoKG5vZGUpCgogICAgICBsZXQgcyA9IDAKICAgICAgbGV0IGUgPSBub2RlLmtleXMubGVuZ3RoCiAgICAgIGxldCBjCgogICAgICB3aGlsZSAocyA8IGUpIHsKICAgICAgICBjb25zdCBtaWQgPSAocyArIGUpID4+IDEKICAgICAgICBjID0gYjRhLmNvbXBhcmUoa2V5LCBhd2FpdCBub2RlLmdldEtleShtaWQpKQoKICAgICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgICAgaWYgKGNhcykgewogICAgICAgICAgICBjb25zdCBwcmV2ID0gYXdhaXQgbm9kZS5nZXRLZXlOb2RlKG1pZCkKICAgICAgICAgICAgaWYgKCEoYXdhaXQgY2FzKHByZXYuZmluYWwoZW5jb2RpbmcpLCBkZWxOb2RlKSkpIHJldHVybiB0aGlzLl91bmxvY2tNYXliZSgpCiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS5jaGlsZHJlbi5sZW5ndGgpIGF3YWl0IHNldEtleVRvTmVhcmVzdExlYWYobm9kZSwgbWlkLCBzdGFjaykKICAgICAgICAgIGVsc2Ugbm9kZS5yZW1vdmVLZXkobWlkKQogICAgICAgICAgLy8gd2UgbWFyayB0aGVzZSBhcyBjaGFuZ2VkIGxhdGUsIHNvIHdlIGRvbid0IHJld3JpdGUgdGhlbSBpZiBpdCBpcyBhIDQwNAogICAgICAgICAgZm9yIChjb25zdCBub2RlIG9mIHN0YWNrKSBub2RlLmNoYW5nZWQgPSB0cnVlCiAgICAgICAgICByZXR1cm4gdGhpcy5fYXBwZW5kKGF3YWl0IHJlYmFsYW5jZShzdGFjayksIHNlcSwga2V5LCBudWxsKQogICAgICAgIH0KCiAgICAgICAgaWYgKGMgPCAwKSBlID0gbWlkCiAgICAgICAgZWxzZSBzID0gbWlkICsgMQogICAgICB9CgogICAgICBpZiAoIW5vZGUuY2hpbGRyZW4ubGVuZ3RoKSByZXR1cm4gdGhpcy5fdW5sb2NrTWF5YmUoKQoKICAgICAgY29uc3QgaSA9IGMgPCAwID8gZSA6IHMKICAgICAgbm9kZSA9IGF3YWl0IG5vZGUuZ2V0Q2hpbGROb2RlKGkpCiAgICB9CiAgfQoKICBhc3luYyBfY2xvc2VTbmFwc2hvdCAoKSB7CiAgICBpZiAodGhpcy5pc1NuYXBzaG90KSB7CiAgICAgIGF3YWl0IHRoaXMuY29yZS5jbG9zZSgpCiAgICAgIHRoaXMuX2ZpbmFsaXplKCkKICAgIH0KICB9CgogIGFzeW5jIGNsb3NlICgpIHsKICAgIGlmICh0aGlzLmlzU25hcHNob3QpIHJldHVybiB0aGlzLl9jbG9zZVNuYXBzaG90KCkKCiAgICB0aGlzLnJvb3QgPSBudWxsCiAgICBpZiAodGhpcy5ibG9ja3MpIHRoaXMuYmxvY2tzLmNsZWFyKCkKICAgIHRoaXMubGVuZ3RoID0gMAogICAgdGhpcy5fdW5sb2NrKCkKICB9CgogIGRlc3Ryb3kgKCkgeyAvLyBjb21wYXQsIHJlbW92ZSBsYXRlcgogICAgdGhpcy5jbG9zZSgpLmNhdGNoKG5vb3ApCiAgfQoKICB0b0Jsb2NrcyAoKSB7CiAgICBpZiAodGhpcy5hcHBlbmRpbmcpIHJldHVybiB0aGlzLmFwcGVuZGluZwoKICAgIGNvbnN0IGJhdGNoID0gbmV3IEFycmF5KHRoaXMubGVuZ3RoKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBzZXEgPSB0aGlzLmNvcmUubGVuZ3RoICsgaQogICAgICBjb25zdCB7IHBlbmRpbmdJbmRleCwga2V5LCB2YWx1ZSB9ID0gdGhpcy5ibG9ja3MuZ2V0KHNlcSkKCiAgICAgIGlmIChpIDwgdGhpcy5sZW5ndGggLSAxKSB7CiAgICAgICAgcGVuZGluZ0luZGV4WzBdID0gbnVsbAogICAgICAgIGxldCBqID0gMAoKICAgICAgICB3aGlsZSAoaiA8IHBlbmRpbmdJbmRleC5sZW5ndGgpIHsKICAgICAgICAgIGNvbnN0IGlkeCA9IHBlbmRpbmdJbmRleFtqXQogICAgICAgICAgaWYgKGlkeCAhPT0gbnVsbCAmJiBpZHguc2VxID09PSBzZXEpIHsKICAgICAgICAgICAgaWR4Lm9mZnNldCA9IGorKwogICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgfQogICAgICAgICAgaWYgKGogPT09IHBlbmRpbmdJbmRleC5sZW5ndGggLSAxKSBwZW5kaW5nSW5kZXgucG9wKCkKICAgICAgICAgIGVsc2UgcGVuZGluZ0luZGV4W2pdID0gcGVuZGluZ0luZGV4LnBvcCgpCiAgICAgICAgfQogICAgICB9CgogICAgICBiYXRjaFtpXSA9IE5vZGUuZW5jb2RlKHsKICAgICAgICBrZXksCiAgICAgICAgdmFsdWUsCiAgICAgICAgaW5kZXg6IGRlZmxhdGUocGVuZGluZ0luZGV4KQogICAgICB9KQogICAgfQoKICAgIHRoaXMuYXBwZW5kaW5nID0gYmF0Y2gKICAgIHJldHVybiBiYXRjaAogIH0KCiAgZmx1c2ggKCkgewogICAgaWYgKCF0aGlzLmxlbmd0aCkgcmV0dXJuIHRoaXMuY2xvc2UoKQoKICAgIGNvbnN0IGJhdGNoID0gdGhpcy50b0Jsb2NrcygpCgogICAgdGhpcy5yb290ID0gbnVsbAogICAgdGhpcy5ibG9ja3MuY2xlYXIoKQogICAgdGhpcy5sZW5ndGggPSAwCgogICAgcmV0dXJuIHRoaXMuX2FwcGVuZEJhdGNoKGJhdGNoKQogIH0KCiAgX3VubG9ja01heWJlICgpIHsKICAgIGlmICh0aGlzLmF1dG9GbHVzaCkgdGhpcy5fdW5sb2NrKCkKICB9CgogIF91bmxvY2sgKCkgewogICAgY29uc3QgbG9ja2VkID0gdGhpcy5sb2NrZWQKICAgIHRoaXMubG9ja2VkID0gbnVsbAogICAgaWYgKGxvY2tlZCAhPT0gbnVsbCkgbG9ja2VkKCkKICAgIHRoaXMuX2ZpbmFsaXplKCkKICB9CgogIF9maW5hbGl6ZSAoKSB7CiAgICAvLyB0ZWNobmljYWxseSBmaW5hbGl6ZSBjYW4gYmUgY2FsbGVkIG1vcmUgdGhhbiBvbmNlLCBzbyBoZXJlIHdlIGp1c3QgY2hlY2sgaWYgd2UgYWxyZWFkeSBoYXZlIGJlZW4gcmVtb3ZlZAogICAgaWYgKHRoaXMuaW5kZXggPj0gdGhpcy50cmVlLl9iYXRjaGVzLmxlbmd0aCB8fCB0aGlzLnRyZWUuX2JhdGNoZXNbdGhpcy5pbmRleF0gIT09IHRoaXMpIHJldHVybgogICAgY29uc3QgdG9wID0gdGhpcy50cmVlLl9iYXRjaGVzLnBvcCgpCiAgICBpZiAodG9wID09PSB0aGlzKSByZXR1cm4KICAgIHRvcC5pbmRleCA9IHRoaXMuaW5kZXgKICAgIHRoaXMudHJlZS5fYmF0Y2hlc1t0b3AuaW5kZXhdID0gdG9wCiAgfQoKICBfYXBwZW5kIChyb290LCBzZXEsIGtleSwgdmFsdWUpIHsKICAgIGNvbnN0IGluZGV4ID0gW10KICAgIHJvb3QuaW5kZXhDaGFuZ2VzKGluZGV4LCBzZXEpCiAgICBpbmRleFswXSA9IG5ldyBDaGlsZChzZXEsIDAsIHJvb3QpCgogICAgaWYgKCF0aGlzLmF1dG9GbHVzaCkgewogICAgICBjb25zdCBibG9jayA9IG5ldyBCYXRjaEVudHJ5KHNlcSwgdGhpcywga2V5LCB2YWx1ZSwgaW5kZXgpCiAgICAgIHJvb3QuYmxvY2sgPSBibG9jawogICAgICB0aGlzLnJvb3QgPSByb290CiAgICAgIHRoaXMubGVuZ3RoKysKICAgICAgdGhpcy5ibG9ja3Muc2V0KHNlcSwgYmxvY2spCgogICAgICByb290LnVwZGF0ZUNoaWxkcmVuKHNlcSwgYmxvY2spCiAgICAgIHJldHVybgogICAgfQoKICAgIHJldHVybiB0aGlzLl9hcHBlbmRCYXRjaChOb2RlLmVuY29kZSh7CiAgICAgIGtleSwKICAgICAgdmFsdWUsCiAgICAgIGluZGV4OiBkZWZsYXRlKGluZGV4KQogICAgfSkpCiAgfQoKICBhc3luYyBfYXBwZW5kQmF0Y2ggKHJhdykgewogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5jb3JlLmFwcGVuZChyYXcpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl91bmxvY2soKQogICAgfQogIH0KfQoKY2xhc3MgRW50cnlXYXRjaGVyIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IgKGJlZSwga2V5LCBvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmtleUVuY29kaW5nID0gb3B0cy5rZXlFbmNvZGluZyB8fCBiZWUua2V5RW5jb2RpbmcKICAgIHRoaXMudmFsdWVFbmNvZGluZyA9IG9wdHMudmFsdWVFbmNvZGluZyB8fCBiZWUudmFsdWVFbmNvZGluZwoKICAgIHRoaXMuaW5kZXggPSBiZWUuX2VudHJ5V2F0Y2hlcnMucHVzaCh0aGlzKSAtIDEKICAgIHRoaXMuYmVlID0gYmVlCgogICAgdGhpcy5rZXkgPSBrZXkKICAgIHRoaXMubm9kZSA9IG51bGwKCiAgICB0aGlzLl9mb3JjZVVwZGF0ZSA9IGZhbHNlCiAgICB0aGlzLl9kZWJvdW5jZWRVcGRhdGUgPSBkZWJvdW5jZSh0aGlzLl9wcm9jZXNzVXBkYXRlLmJpbmQodGhpcykpCiAgfQoKICBfY2xvc2UgKCkgewogICAgY29uc3QgdG9wID0gdGhpcy5iZWUuX2VudHJ5V2F0Y2hlcnMucG9wKCkKICAgIGlmICh0b3AgIT09IHRoaXMpIHsKICAgICAgdG9wLmluZGV4ID0gdGhpcy5pbmRleAogICAgICB0aGlzLmJlZS5fZW50cnlXYXRjaGVyc1t0b3AuaW5kZXhdID0gdG9wCiAgICB9CiAgfQoKICBfb25hcHBlbmQgKCkgewogICAgdGhpcy5fZGVib3VuY2VkVXBkYXRlKCkKICB9CgogIF9vbnRydW5jYXRlICgpIHsKICAgIHRoaXMuX2ZvcmNlVXBkYXRlID0gdHJ1ZQogICAgdGhpcy5fZGVib3VuY2VkVXBkYXRlKCkKICB9CgogIGFzeW5jIF9wcm9jZXNzVXBkYXRlICgpIHsKICAgIGNvbnN0IGZvcmNlID0gdGhpcy5fZm9yY2VVcGRhdGUKICAgIHRoaXMuX2ZvcmNlVXBkYXRlID0gZmFsc2UKCiAgICBsZXQgbmV3Tm9kZQogICAgdHJ5IHsKICAgICAgbmV3Tm9kZSA9IGF3YWl0IHRoaXMuYmVlLmdldCh0aGlzLmtleSwgewogICAgICAgIGtleUVuY29kaW5nOiB0aGlzLmtleUVuY29kaW5nLAogICAgICAgIHZhbHVlRW5jb2Rpbmc6IHRoaXMudmFsdWVFbmNvZGluZwogICAgICB9KQogICAgfSBjYXRjaCAoZSkgewogICAgICBpZiAoZS5jb2RlID09PSAnU05BUFNIT1RfTk9UX0FWQUlMQUJMRScpIHsKICAgICAgICAvLyBUaGVyZSB3YXMgYSB0cnVuY2F0ZSBldmVudCBiZWZvcmUgdGhlIGdldCByZXNvbHZlZAogICAgICAgIC8vIFNvIHRoaXMgaGFuZGxlciB3aWxsIHJ1biBhZ2FpbiBhbnl3YXkKICAgICAgICByZXR1cm4KICAgICAgfSBlbHNlIGlmICh0aGlzLmJlZS5jbG9zaW5nKSB7CiAgICAgICAgdGhpcy5jbG9zZSgpLmNhdGNoKHNhZmV0eUNhdGNoKQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoZm9yY2UgfHwgbmV3Tm9kZT8uc2VxICE9PSB0aGlzLm5vZGU/LnNlcSkgewogICAgICB0aGlzLm5vZGUgPSBuZXdOb2RlCiAgICAgIHRoaXMuZW1pdCgndXBkYXRlJykKICAgIH0KICB9Cn0KCmNsYXNzIFdhdGNoZXIgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvciAoYmVlLCByYW5nZSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5rZXlFbmNvZGluZyA9IG9wdHMua2V5RW5jb2RpbmcgfHwgYmVlLmtleUVuY29kaW5nCiAgICB0aGlzLnZhbHVlRW5jb2RpbmcgPSBvcHRzLnZhbHVlRW5jb2RpbmcgfHwgYmVlLnZhbHVlRW5jb2RpbmcKICAgIHRoaXMuaW5kZXggPSBiZWUuX3dhdGNoZXJzLnB1c2godGhpcykgLSAxCiAgICB0aGlzLmJlZSA9IGJlZQogICAgdGhpcy5jb3JlID0gYmVlLmNvcmUKCiAgICB0aGlzLmxhdGVzdERpZmYgPSAwCiAgICB0aGlzLnJhbmdlID0gcmFuZ2UKICAgIHRoaXMubWFwID0gb3B0cy5tYXAgfHwgZGVmYXVsdFdhdGNoTWFwCgogICAgdGhpcy5jdXJyZW50ID0gbnVsbAogICAgdGhpcy5wcmV2aW91cyA9IG51bGwKICAgIHRoaXMuY3VycmVudE1hcHBlZCA9IG51bGwKICAgIHRoaXMucHJldmlvdXNNYXBwZWQgPSBudWxsCiAgICB0aGlzLnN0cmVhbSA9IG51bGwKCiAgICB0aGlzLl9sb2NrID0gbXV0ZXhpZnkoKQogICAgdGhpcy5fZmxvd2luZyA9IGZhbHNlCiAgICB0aGlzLl9yZXNvbHZlT25DaGFuZ2UgPSBudWxsCiAgICB0aGlzLl9kaWZmZXIgPSBvcHRzLmRpZmZlciB8fCBkZWZhdWx0RGlmZmVyCiAgICB0aGlzLl9lYWdlciA9ICEhb3B0cy5lYWdlcgogICAgdGhpcy5fb25jaGFuZ2UgPSBvcHRzLm9uY2hhbmdlIHx8IG51bGwKCiAgICB0aGlzLm9uKCduZXdMaXN0ZW5lcicsIGF1dG9GbG93T25VcGRhdGUpCgogICAgdGhpcy5yZWFkeSgpLmNhdGNoKHNhZmV0eUNhdGNoKQogIH0KCiAgYXN5bmMgX2NvbnN1bWUgKCkgewogICAgaWYgKHRoaXMuX2Zsb3dpbmcpIHJldHVybgogICAgdHJ5IHsKICAgICAgZm9yIGF3YWl0IChjb25zdCBfIG9mIHRoaXMpIHt9IC8vIGVzbGludC1kaXNhYmxlLWxpbmUKICAgIH0gY2F0Y2gge30KICB9CgogIGFzeW5jIF9vcGVuICgpIHsKICAgIGF3YWl0IHRoaXMuYmVlLnJlYWR5KCkKCiAgICBjb25zdCBvcHRzID0gewogICAgICBrZXlFbmNvZGluZzogdGhpcy5rZXlFbmNvZGluZywKICAgICAgdmFsdWVFbmNvZGluZzogdGhpcy52YWx1ZUVuY29kaW5nCiAgICB9CgogICAgLy8gUG9pbnQgZnJvbSB3aGljaCB0byBzdGFydCB3YXRjaGluZwogICAgdGhpcy5jdXJyZW50ID0gdGhpcy5fZWFnZXIgPyB0aGlzLmJlZS5jaGVja291dCgxLCBvcHRzKSA6IHRoaXMuYmVlLnNuYXBzaG90KG9wdHMpCiAgICBhd2FpdCB0aGlzLmN1cnJlbnQucmVhZHkoKQoKICAgIGlmICh0aGlzLl9vbmNoYW5nZSkgewogICAgICBpZiAodGhpcy5fZWFnZXIpIGF3YWl0IHRoaXMuX29uY2hhbmdlKCkKICAgICAgdGhpcy5fY29uc3VtZSgpCiAgICB9CiAgfQoKICBbU3ltYm9sLmFzeW5jSXRlcmF0b3JdICgpIHsKICAgIHRoaXMuX2Zsb3dpbmcgPSB0cnVlCiAgICByZXR1cm4gdGhpcwogIH0KCiAgX29udHJ1bmNhdGUgKCkgewogICAgdGhpcy5fb25hcHBlbmQoKQogIH0KCiAgX29uYXBwZW5kICgpIHsKICAgIGNvbnN0IHJlc29sdmUgPSB0aGlzLl9yZXNvbHZlT25DaGFuZ2UKICAgIHRoaXMuX3Jlc29sdmVPbkNoYW5nZSA9IG51bGwKICAgIGlmIChyZXNvbHZlKSByZXNvbHZlKCkKICB9CgogIGFzeW5jIF93YWl0Rm9yQ2hhbmdlcyAoKSB7CiAgICBpZiAodGhpcy5jdXJyZW50LnZlcnNpb24gPCB0aGlzLmJlZS52ZXJzaW9uIHx8IHRoaXMuY2xvc2luZykgcmV0dXJuCgogICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7CiAgICAgIHRoaXMuX3Jlc29sdmVPbkNoYW5nZSA9IHJlc29sdmUKICAgIH0pCiAgfQoKICBhc3luYyBuZXh0ICgpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9uZXh0KCkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4geyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH0KICAgICAgYXdhaXQgdGhpcy5jbG9zZSgpCiAgICAgIHRocm93IGVycgogICAgfQogIH0KCiAgYXN5bmMgX25leHQgKCkgewogICAgY29uc3QgcmVsZWFzZSA9IGF3YWl0IHRoaXMuX2xvY2soKQoKICAgIHRyeSB7CiAgICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybiB7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfQoKICAgICAgaWYgKCF0aGlzLm9wZW5lZCkgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGF3YWl0IHRoaXMuX3dhaXRGb3JDaGFuZ2VzKCkKCiAgICAgICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuIHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9CgogICAgICAgIGF3YWl0IHRoaXMuX2Nsb3NlUHJldmlvdXMoKQogICAgICAgIHRoaXMucHJldmlvdXMgPSB0aGlzLmN1cnJlbnQuc25hcHNob3QoKQoKICAgICAgICBhd2FpdCB0aGlzLl9jbG9zZUN1cnJlbnQoKQogICAgICAgIHRoaXMuY3VycmVudCA9IHRoaXMuYmVlLnNuYXBzaG90KHsKICAgICAgICAgIGtleUVuY29kaW5nOiB0aGlzLmtleUVuY29kaW5nLAogICAgICAgICAgdmFsdWVFbmNvZGluZzogdGhpcy52YWx1ZUVuY29kaW5nCiAgICAgICAgfSkKCiAgICAgICAgYXdhaXQgdGhpcy5jdXJyZW50LnJlYWR5KCkKICAgICAgICBhd2FpdCB0aGlzLnByZXZpb3VzLnJlYWR5KCkKCiAgICAgICAgaWYgKHRoaXMuY3VycmVudC5jb3JlLmZvcmsgIT09IHRoaXMucHJldmlvdXMuY29yZS5mb3JrKSB7CiAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5feWllbGQoKQogICAgICAgIH0KCiAgICAgICAgdGhpcy5zdHJlYW0gPSB0aGlzLl9kaWZmZXIodGhpcy5jdXJyZW50LCB0aGlzLnByZXZpb3VzLCB0aGlzLnJhbmdlKQoKICAgICAgICB0cnkgewogICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIHRoaXMuc3RyZWFtKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUKICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3lpZWxkKCkKICAgICAgICAgIH0KICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgdGhpcy5zdHJlYW0gPSBudWxsCiAgICAgICAgfQogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICByZWxlYXNlKCkKICAgIH0KICB9CgogIGFzeW5jIF95aWVsZCAoKSB7CiAgICB0aGlzLmN1cnJlbnRNYXBwZWQgPSB0aGlzLm1hcCh0aGlzLmN1cnJlbnQpCiAgICB0aGlzLnByZXZpb3VzTWFwcGVkID0gdGhpcy5tYXAodGhpcy5wcmV2aW91cykKCiAgICBpZiAodGhpcy5fb25jaGFuZ2UpIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLl9vbmNoYW5nZSgpCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgICAgfQogICAgfQoKICAgIHRoaXMuZW1pdCgndXBkYXRlJykKICAgIHJldHVybiB7IGRvbmU6IGZhbHNlLCB2YWx1ZTogW3RoaXMuY3VycmVudE1hcHBlZCwgdGhpcy5wcmV2aW91c01hcHBlZF0gfQogIH0KCiAgYXN5bmMgcmV0dXJuICgpIHsKICAgIGF3YWl0IHRoaXMuY2xvc2UoKQogICAgcmV0dXJuIHsgZG9uZTogdHJ1ZSB9CiAgfQoKICBhc3luYyBfY2xvc2UgKCkgewogICAgY29uc3QgdG9wID0gdGhpcy5iZWUuX3dhdGNoZXJzLnBvcCgpCiAgICBpZiAodG9wICE9PSB0aGlzKSB7CiAgICAgIHRvcC5pbmRleCA9IHRoaXMuaW5kZXgKICAgICAgdGhpcy5iZWUuX3dhdGNoZXJzW3RvcC5pbmRleF0gPSB0b3AKICAgIH0KCiAgICBpZiAodGhpcy5zdHJlYW0gJiYgIXRoaXMuc3RyZWFtLmRlc3Ryb3lpbmcpIHsKICAgICAgdGhpcy5zdHJlYW0uZGVzdHJveSgpCiAgICB9CgogICAgdGhpcy5fb25hcHBlbmQoKSAvLyBDb250aW51ZSBleGVjdXRpb24gYmVpbmcgY2xvc2VkCgogICAgYXdhaXQgdGhpcy5fY2xvc2VDdXJyZW50KCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgICBhd2FpdCB0aGlzLl9jbG9zZVByZXZpb3VzKCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCgogICAgY29uc3QgcmVsZWFzZSA9IGF3YWl0IHRoaXMuX2xvY2soKQogICAgcmVsZWFzZSgpCiAgfQoKICBkZXN0cm95ICgpIHsKICAgIHJldHVybiB0aGlzLmNsb3NlKCkKICB9CgogIGFzeW5jIF9jbG9zZUN1cnJlbnQgKCkgewogICAgaWYgKHRoaXMuY3VycmVudE1hcHBlZCkgYXdhaXQgdGhpcy5jdXJyZW50TWFwcGVkLmNsb3NlKCkKICAgIGlmICh0aGlzLmN1cnJlbnQpIGF3YWl0IHRoaXMuY3VycmVudC5jbG9zZSgpCiAgICB0aGlzLmN1cnJlbnQgPSB0aGlzLmN1cnJlbnRNYXBwZWQgPSBudWxsCiAgfQoKICBhc3luYyBfY2xvc2VQcmV2aW91cyAoKSB7CiAgICBpZiAodGhpcy5wcmV2aW91c01hcHBlZCkgYXdhaXQgdGhpcy5wcmV2aW91c01hcHBlZC5jbG9zZSgpCiAgICBpZiAodGhpcy5wcmV2aW91cykgYXdhaXQgdGhpcy5wcmV2aW91cy5jbG9zZSgpCiAgICB0aGlzLnByZXZpb3VzID0gdGhpcy5wcmV2aW91c01hcHBlZCA9IG51bGwKICB9Cn0KCmZ1bmN0aW9uIGF1dG9GbG93T25VcGRhdGUgKG5hbWUpIHsKICBpZiAobmFtZSA9PT0gJ3VwZGF0ZScpIHRoaXMuX2NvbnN1bWUoKQp9CgpmdW5jdGlvbiBkZWZhdWx0V2F0Y2hNYXAgKHNuYXBzaG90KSB7CiAgcmV0dXJuIHNuYXBzaG90Cn0KCmFzeW5jIGZ1bmN0aW9uIGxlYWZTaXplIChub2RlLCBnb0xlZnQpIHsKICB3aGlsZSAobm9kZS5jaGlsZHJlbi5sZW5ndGgpIG5vZGUgPSBhd2FpdCBub2RlLmdldENoaWxkTm9kZShnb0xlZnQgPyAwIDogbm9kZS5jaGlsZHJlbi5sZW5ndGggLSAxKQogIHJldHVybiBub2RlLmtleXMubGVuZ3RoCn0KCmFzeW5jIGZ1bmN0aW9uIHNldEtleVRvTmVhcmVzdExlYWYgKG5vZGUsIGluZGV4LCBzdGFjaykgewogIGxldCBbbGVmdCwgcmlnaHRdID0gYXdhaXQgUHJvbWlzZS5hbGwoW25vZGUuZ2V0Q2hpbGROb2RlKGluZGV4KSwgbm9kZS5nZXRDaGlsZE5vZGUoaW5kZXggKyAxKV0pCiAgY29uc3QgW2xzLCByc10gPSBhd2FpdCBQcm9taXNlLmFsbChbbGVhZlNpemUobGVmdCwgZmFsc2UpLCBsZWFmU2l6ZShyaWdodCwgdHJ1ZSldKQoKICBpZiAobHMgPCBycykgeyAvLyBpZiBmZXdlciBsZWF2ZXMgb24gdGhlIGxlZnQKICAgIHN0YWNrLnB1c2gocmlnaHQpCiAgICB3aGlsZSAocmlnaHQuY2hpbGRyZW4ubGVuZ3RoKSBzdGFjay5wdXNoKHJpZ2h0ID0gcmlnaHQuY2hpbGRyZW5bMF0udmFsdWUpCiAgICBub2RlLmtleXNbaW5kZXhdID0gcmlnaHQua2V5cy5zaGlmdCgpCiAgfSBlbHNlIHsgLy8gaWYgZmV3ZXIgbGVhdmVzIG9uIHRoZSByaWdodAogICAgc3RhY2sucHVzaChsZWZ0KQogICAgd2hpbGUgKGxlZnQuY2hpbGRyZW4ubGVuZ3RoKSBzdGFjay5wdXNoKGxlZnQgPSBsZWZ0LmNoaWxkcmVuW2xlZnQuY2hpbGRyZW4ubGVuZ3RoIC0gMV0udmFsdWUpCiAgICBub2RlLmtleXNbaW5kZXhdID0gbGVmdC5rZXlzLnBvcCgpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiByZWJhbGFuY2UgKHN0YWNrKSB7CiAgY29uc3Qgcm9vdCA9IHN0YWNrWzBdCgogIHdoaWxlIChzdGFjay5sZW5ndGggPiAxKSB7CiAgICBjb25zdCBub2RlID0gc3RhY2sucG9wKCkKICAgIGNvbnN0IHBhcmVudCA9IHN0YWNrW3N0YWNrLmxlbmd0aCAtIDFdCgogICAgaWYgKG5vZGUua2V5cy5sZW5ndGggPj0gTUlOX0tFWVMpIHJldHVybiByb290CgogICAgbGV0IHsgbGVmdCwgaW5kZXgsIHJpZ2h0IH0gPSBhd2FpdCBub2RlLnNpYmxpbmdzKHBhcmVudCkKCiAgICAvLyBtYXliZSBib3Jyb3cgZnJvbSBsZWZ0IHNpYmxpbmc/CiAgICBpZiAobGVmdCAmJiBsZWZ0LmtleXMubGVuZ3RoID4gTUlOX0tFWVMpIHsKICAgICAgbGVmdC5jaGFuZ2VkID0gdHJ1ZQogICAgICBub2RlLmtleXMudW5zaGlmdChwYXJlbnQua2V5c1tpbmRleCAtIDFdKQogICAgICBpZiAobGVmdC5jaGlsZHJlbi5sZW5ndGgpIG5vZGUuY2hpbGRyZW4udW5zaGlmdChsZWZ0LmNoaWxkcmVuLnBvcCgpKQogICAgICBwYXJlbnQua2V5c1tpbmRleCAtIDFdID0gbGVmdC5rZXlzLnBvcCgpCiAgICAgIHJldHVybiByb290CiAgICB9CgogICAgLy8gbWF5YmUgYm9ycm93IGZyb20gcmlnaHQgc2libGluZz8KICAgIGlmIChyaWdodCAmJiByaWdodC5rZXlzLmxlbmd0aCA+IE1JTl9LRVlTKSB7CiAgICAgIHJpZ2h0LmNoYW5nZWQgPSB0cnVlCiAgICAgIG5vZGUua2V5cy5wdXNoKHBhcmVudC5rZXlzW2luZGV4XSkKICAgICAgaWYgKHJpZ2h0LmNoaWxkcmVuLmxlbmd0aCkgbm9kZS5jaGlsZHJlbi5wdXNoKHJpZ2h0LmNoaWxkcmVuLnNoaWZ0KCkpCiAgICAgIHBhcmVudC5rZXlzW2luZGV4XSA9IHJpZ2h0LmtleXMuc2hpZnQoKQogICAgICByZXR1cm4gcm9vdAogICAgfQoKICAgIC8vIG1lcmdlIG5vZGUgd2l0aCBhbm90aGVyIHNpYmxpbmcKICAgIGlmIChsZWZ0KSB7CiAgICAgIGluZGV4LS0KICAgICAgcmlnaHQgPSBub2RlCiAgICB9IGVsc2UgewogICAgICBsZWZ0ID0gbm9kZQogICAgfQoKICAgIGxlZnQubWVyZ2UocmlnaHQsIHBhcmVudC5rZXlzW2luZGV4XSkKICAgIHBhcmVudC5yZW1vdmVLZXkoaW5kZXgpCiAgfQoKICAvLyBjaGVjayBpZiB0aGUgdHJlZSBzaHJ1bmsKICBpZiAoIXJvb3Qua2V5cy5sZW5ndGggJiYgcm9vdC5jaGlsZHJlbi5sZW5ndGgpIHJldHVybiByb290LmdldENoaWxkTm9kZSgwKQogIHJldHVybiByb290Cn0KCmZ1bmN0aW9uIGl0ZXJhdG9yVG9TdHJlYW0gKGl0ZSwgc2lnbmFsKSB7CiAgbGV0IGRvbmUKICBsZXQgY2xvc2luZwoKICBjb25zdCBycyA9IG5ldyBSZWFkYWJsZSh7CiAgICBzaWduYWwsCiAgICBvcGVuIChjYikgewogICAgICBkb25lID0gY2IKICAgICAgaXRlLm9wZW4oKS50aGVuKGZpbiwgZmluKQogICAgfSwKICAgIHJlYWQgKGNiKSB7CiAgICAgIGRvbmUgPSBjYgogICAgICBpdGUubmV4dCgpLnRoZW4ocHVzaCwgZmluKQogICAgfSwKICAgIHByZWRlc3Ryb3kgKCkgewogICAgICBjbG9zaW5nID0gaXRlLmNsb3NlKCkKICAgICAgY2xvc2luZy5jYXRjaChub29wKQogICAgfSwKICAgIGRlc3Ryb3kgKGNiKSB7CiAgICAgIGRvbmUgPSBjYgogICAgICBpZiAoIWNsb3NpbmcpIGNsb3NpbmcgPSBpdGUuY2xvc2UoKQogICAgICBjbG9zaW5nLnRoZW4oZmluLCBmaW4pCiAgICB9CiAgfSkKCiAgcmV0dXJuIHJzCgogIGZ1bmN0aW9uIGZpbiAoZXJyKSB7CiAgICBkb25lKGVycikKICB9CgogIGZ1bmN0aW9uIHB1c2ggKHZhbCkgewogICAgcnMucHVzaCh2YWwpCiAgICBkb25lKG51bGwpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBpdGVyYXRvclBlZWsgKGl0ZSkgewogIHRyeSB7CiAgICBhd2FpdCBpdGUub3BlbigpCiAgICByZXR1cm4gYXdhaXQgaXRlLm5leHQoKQogIH0gZmluYWxseSB7CiAgICBhd2FpdCBpdGUuY2xvc2UoKQogIH0KfQoKZnVuY3Rpb24gZW5jUmFuZ2UgKGUsIG9wdHMpIHsKICBpZiAoIWUpIHJldHVybiBvcHRzCgogIGlmIChlLmVuY29kZVJhbmdlKSB7CiAgICBjb25zdCByID0gZS5lbmNvZGVSYW5nZSh7IGd0OiBvcHRzLmd0LCBndGU6IG9wdHMuZ3RlLCBsdDogb3B0cy5sdCwgbHRlOiBvcHRzLmx0ZSB9KQogICAgb3B0cy5ndCA9IHIuZ3QKICAgIG9wdHMuZ3RlID0gci5ndGUKICAgIG9wdHMubHQgPSByLmx0CiAgICBvcHRzLmx0ZSA9IHIubHRlCiAgICByZXR1cm4gb3B0cwogIH0KCiAgaWYgKG9wdHMuZ3QgIT09IHVuZGVmaW5lZCkgb3B0cy5ndCA9IGVuYyhlLCBvcHRzLmd0KQogIGlmIChvcHRzLmd0ZSAhPT0gdW5kZWZpbmVkKSBvcHRzLmd0ZSA9IGVuYyhlLCBvcHRzLmd0ZSkKICBpZiAob3B0cy5sdCAhPT0gdW5kZWZpbmVkKSBvcHRzLmx0ID0gZW5jKGUsIG9wdHMubHQpCiAgaWYgKG9wdHMubHRlICE9PSB1bmRlZmluZWQpIG9wdHMubHRlID0gZW5jKGUsIG9wdHMubHRlKQogIGlmIChvcHRzLnN1YiAmJiAhb3B0cy5ndCAmJiAhb3B0cy5ndGUpIG9wdHMuZ3QgPSBlbmMoZSwgU0VQKQogIGlmIChvcHRzLnN1YiAmJiAhb3B0cy5sdCAmJiAhb3B0cy5sdGUpIG9wdHMubHQgPSBidW1wKGVuYyhlLCBFTVBUWSkpCgogIHJldHVybiBvcHRzCn0KCmZ1bmN0aW9uIGJ1bXAgKGtleSkgewogIC8vIGtleSBzaG91bGQgaGF2ZSBiZWVuIGNvcGllZCBieSBlbmMgYWJvdmUgYmVmb3JlIGhpdHRpbmcgdGhpcwogIGtleVtrZXkubGVuZ3RoIC0gMV0rKwogIHJldHVybiBrZXkKfQoKZnVuY3Rpb24gZW5jIChlLCB2KSB7CiAgaWYgKHYgPT09IHVuZGVmaW5lZCB8fCB2ID09PSBudWxsKSByZXR1cm4gbnVsbAogIGlmIChlICE9PSBudWxsKSByZXR1cm4gZS5lbmNvZGUodikKICBpZiAodHlwZW9mIHYgPT09ICdzdHJpbmcnKSByZXR1cm4gYjRhLmZyb20odikKICByZXR1cm4gdgp9CgpmdW5jdGlvbiBwcmVmaXhFbmNvZGluZyAocHJlZml4LCBrZXlFbmNvZGluZykgewogIHJldHVybiB7CiAgICBlbmNvZGUgKGtleSkgewogICAgICByZXR1cm4gYjRhLmNvbmNhdChbcHJlZml4LCBiNGEuaXNCdWZmZXIoa2V5KSA/IGtleSA6IGVuYyhrZXlFbmNvZGluZywga2V5KV0pCiAgICB9LAogICAgZGVjb2RlIChrZXkpIHsKICAgICAgY29uc3Qgc2xpY2VkID0ga2V5LnNsaWNlKHByZWZpeC5sZW5ndGgsIGtleS5sZW5ndGgpCiAgICAgIHJldHVybiBrZXlFbmNvZGluZyA/IGtleUVuY29kaW5nLmRlY29kZShzbGljZWQpIDogc2xpY2VkCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBjb3B5RW50cnkgKGVudHJ5KSB7CiAgbGV0IGtleSA9IGVudHJ5LmtleQogIGxldCB2YWx1ZSA9IGVudHJ5LnZhbHVlCiAgbGV0IGluZGV4ID0gZW50cnkuaW5kZXgKCiAgLy8ga2V5LCB2YWx1ZSBhbmQgaW5kZXggYWxsIHJlZmVyIHRvIHRoZSBzYW1lIGJ1ZmZlciAob25lIGh5cGVyY29yZSBibG9jaykKICAvLyBJZiB0b2dldGhlciB0aGV5IGFyZSBsYXJnZXIgdGhhbiBoYWxmIHRoZSBidWZmZXIncyBieXRlTGVuZ3RoLAogIC8vIHRoaXMgbWVhbnMgdGhhdCB0aGV5IGdvdCB0aGVpciBvd24gcHJpdmF0ZSBzbGFiIChzZWUgQnVmZmVyLmFsbG9jVW5zYWZlIGRvY3MpCiAgLy8gc28gbm8gbmVlZCB0byB1bnNsYWIKICBjb25zdCBzaXplID0ga2V5LmJ5dGVMZW5ndGggKyAodmFsdWUgPT09IG51bGwgPyAwIDogdmFsdWUuYnl0ZUxlbmd0aCkgKyAoaW5kZXggPT09IG51bGwgPyAwIDogaW5kZXguYnl0ZUxlbmd0aCkKICBpZiAoMiAqIHNpemUgPCBrZXkuYnVmZmVyLmJ5dGVMZW5ndGgpIHsKICAgIGNvbnN0IFtuZXdLZXksIG5ld1ZhbHVlLCBuZXdJbmRleF0gPSB1bnNsYWJBbGwoW2VudHJ5LmtleSwgZW50cnkudmFsdWUsIGVudHJ5LmluZGV4XSkKICAgIGtleSA9IG5ld0tleQogICAgdmFsdWUgPSBuZXdWYWx1ZQogICAgaW5kZXggPSBuZXdJbmRleAogIH0KCiAgcmV0dXJuIHsKICAgIGtleSwKICAgIHZhbHVlLAogICAgaW5kZXgsCiAgICBpbmZsYXRlZDogbnVsbAogIH0KfQoKZnVuY3Rpb24gZGVmYXVsdERpZmZlciAoY3VycmVudFNuYXAsIHByZXZpb3VzU25hcCwgb3B0cykgewogIHJldHVybiBjdXJyZW50U25hcC5jcmVhdGVEaWZmU3RyZWFtKHByZXZpb3VzU25hcCwgb3B0cykKfQoKZnVuY3Rpb24gdG9OdWxsICgpIHsKICByZXR1cm4gbnVsbAp9CgpmdW5jdGlvbiBnZXRCYWNraW5nQ29yZSAoY29yZSkgewogIGlmIChjb3JlLmNvcmUpIHJldHVybiBjb3JlCiAgaWYgKGNvcmUuZ2V0QmFja2luZ0NvcmUpIHJldHVybiBjb3JlLmdldEJhY2tpbmdDb3JlKCkuc2Vzc2lvbgogIHJldHVybiBudWxsCn0KCmZ1bmN0aW9uIHNhbWVWYWx1ZSAoYSwgYikgewogIHJldHVybiBhID09PSBiIHx8IChhICE9PSBudWxsICYmIGIgIT09IG51bGwgJiYgYjRhLmVxdWFscyhhLCBiKSkKfQoKZnVuY3Rpb24gbm9vcCAoKSB7fQoKZnVuY3Rpb24gZ2V0RXh0ZW5zaW9uIChkYiwgb3B0cykgewogIGlmIChvcHRzLmV4dGVuc2lvbiA9PT0gZmFsc2UpIHJldHVybiBudWxsCiAgaWYgKG9wdHMuZXh0ZW5zaW9uICYmIG9wdHMuZXh0ZW5zaW9uICE9PSB0cnVlKSByZXR1cm4gb3B0cy5leHRlbnNpb24KICByZXR1cm4gRXh0ZW5zaW9uLnJlZ2lzdGVyKGRiKQp9Cgphc3luYyBmdW5jdGlvbiBpc0xpbmtlZCAoYmF0Y2gsIGJsb2NrKSB7CiAgY29uc3Qgc2VxID0gYmxvY2suc2VxCiAgYmxvY2suaW5mbGF0ZSgpCgogIGNvbnN0IGtleXMgPSBbYmxvY2sua2V5XQogIGNvbnN0IHdhaXQgPSBiYXRjaC5vcHRpb25zLndhaXQKCiAgZm9yIChjb25zdCBsIG9mIGJsb2NrLmluZGV4LmxldmVscykgewogICAgaWYgKCFsLmtleXMubGVuZ3RoKSBjb250aW51ZQogICAgYmF0Y2gub3B0aW9ucy53YWl0ID0gZmFsc2UKICAgIHRyeSB7CiAgICAgIGtleXMucHVzaChhd2FpdCBiYXRjaC5nZXRLZXkobC5rZXlzWzBdLnNlcSkpCiAgICB9IGNhdGNoIHt9CiAgICBiYXRjaC5vcHRpb25zLndhaXQgPSB3YWl0CiAgfQoKICBmb3IgKGNvbnN0IGsgb2Yga2V5cykgewogICAgaWYgKGF3YWl0IGJhdGNoLmxpbmtzKGssIHNlcSkpIHJldHVybiB0cnVlCiAgfQoKICBpZiAoYmF0Y2guY29yZS5jbG9zaW5nKSB0aHJvdyBuZXcgRXJyb3IoJ0NvcmUgaXMgY2xvc2VkJykKCiAgcmV0dXJuIGZhbHNlCn0KCm1vZHVsZS5leHBvcnRzID0gSHlwZXJiZWUKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNsYXNzIFN1YlRyZWUgewogIGNvbnN0cnVjdG9yIChub2RlLCBwYXJlbnQpIHsKICAgIHRoaXMubm9kZSA9IG5vZGUKICAgIHRoaXMucGFyZW50ID0gcGFyZW50CgogICAgdGhpcy5pc0tleSA9IG5vZGUuY2hpbGRyZW4ubGVuZ3RoID09PSAwCiAgICB0aGlzLmkgPSB0aGlzLmlzS2V5ID8gMSA6IDAKICAgIHRoaXMubiA9IDAKCiAgICBjb25zdCBjaGlsZCA9IHRoaXMuaXNLZXkgPyBudWxsIDogdGhpcy5ub2RlLmNoaWxkcmVuWzBdCiAgICB0aGlzLnNlcSA9IGNoaWxkICE9PSBudWxsID8gY2hpbGQuc2VxIDogdGhpcy5ub2RlLmtleXNbMF0uc2VxCiAgICB0aGlzLm9mZnNldCA9IGNoaWxkICE9PSBudWxsID8gY2hpbGQub2Zmc2V0IDogMAogIH0KCiAgbmV4dCAoKSB7CiAgICB0aGlzLmkrKwogICAgdGhpcy5pc0tleSA9ICh0aGlzLmkgJiAxKSA9PT0gMQogICAgaWYgKCF0aGlzLmlzS2V5ICYmICF0aGlzLm5vZGUuY2hpbGRyZW4ubGVuZ3RoKSB0aGlzLmkrKwogICAgcmV0dXJuIHRoaXMudXBkYXRlKCkKICB9CgogIGFzeW5jIGJpc2VjdCAoa2V5LCBpbmNsKSB7CiAgICBsZXQgcyA9IDAKICAgIGxldCBlID0gdGhpcy5ub2RlLmtleXMubGVuZ3RoCiAgICBsZXQgYwoKICAgIHdoaWxlIChzIDwgZSkgewogICAgICBjb25zdCBtaWQgPSAocyArIGUpID4+IDEKICAgICAgYyA9IGNtcChrZXksIGF3YWl0IHRoaXMubm9kZS5nZXRLZXkobWlkKSkKCiAgICAgIGlmIChjID09PSAwKSB7CiAgICAgICAgaWYgKGluY2wpIHRoaXMuaSA9IG1pZCAqIDIgKyAxCiAgICAgICAgZWxzZSB0aGlzLmkgPSBtaWQgKiAyICsgKHRoaXMubm9kZS5jaGlsZHJlbi5sZW5ndGggPyAyIDogMykKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CgogICAgICBpZiAoYyA8IDApIGUgPSBtaWQKICAgICAgZWxzZSBzID0gbWlkICsgMQogICAgfQoKICAgIGNvbnN0IGkgPSBjIDwgMCA/IGUgOiBzCiAgICB0aGlzLmkgPSAyICogaSArICh0aGlzLm5vZGUuY2hpbGRyZW4ubGVuZ3RoID8gMCA6IDEpCiAgICByZXR1cm4gdGhpcy5ub2RlLmNoaWxkcmVuLmxlbmd0aCA9PT0gMAogIH0KCiAgdXBkYXRlICgpIHsKICAgIHRoaXMuaXNLZXkgPSAodGhpcy5pICYgMSkgPT09IDEKICAgIHRoaXMubiA9IHRoaXMuaSA+PiAxCiAgICBpZiAodGhpcy5uID49ICh0aGlzLmlzS2V5ID8gdGhpcy5ub2RlLmtleXMubGVuZ3RoIDogdGhpcy5ub2RlLmNoaWxkcmVuLmxlbmd0aCkpIHJldHVybiBmYWxzZQogICAgY29uc3QgY2hpbGQgPSB0aGlzLmlzS2V5ID8gbnVsbCA6IHRoaXMubm9kZS5jaGlsZHJlblt0aGlzLm5dCiAgICB0aGlzLnNlcSA9IGNoaWxkICE9PSBudWxsID8gY2hpbGQuc2VxIDogdGhpcy5ub2RlLmtleXNbdGhpcy5uXS5zZXEKICAgIHRoaXMub2Zmc2V0ID0gY2hpbGQgIT09IG51bGwgPyBjaGlsZC5vZmZzZXQgOiAwCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMga2V5ICgpIHsKICAgIHJldHVybiB0aGlzLm4gPCB0aGlzLm5vZGUua2V5cy5sZW5ndGggPyB0aGlzLm5vZGUuZ2V0S2V5KHRoaXMubikgOiAodGhpcy5wYXJlbnQgJiYgdGhpcy5wYXJlbnQua2V5KCkpCiAgfQoKICBhc3luYyBjb21wYXJlICh0cmVlKSB7CiAgICBjb25zdCBbYSwgYl0gPSBhd2FpdCBQcm9taXNlLmFsbChbdGhpcy5rZXkoKSwgdHJlZS5rZXkoKV0pCiAgICByZXR1cm4gY21wKGEsIGIpCiAgfQp9CgpjbGFzcyBUcmVlSXRlcmF0b3IgewogIGNvbnN0cnVjdG9yIChiYXRjaCwgb3B0cykgewogICAgdGhpcy5iYXRjaCA9IGJhdGNoCiAgICB0aGlzLnN0YWNrID0gW10KICAgIHRoaXMubHQgPSBvcHRzLmx0IHx8IG9wdHMubHRlIHx8IG51bGwKICAgIHRoaXMubHRlID0gISFvcHRzLmx0ZQogICAgdGhpcy5ndCA9IG9wdHMuZ3QgfHwgb3B0cy5ndGUgfHwgbnVsbAogICAgdGhpcy5ndGUgPSAhIW9wdHMuZ3RlCiAgICB0aGlzLnNlZWtpbmcgPSAhIXRoaXMuZ3QKICAgIHRoaXMuZW5jb2RpbmcgPSBvcHRzLmVuY29kaW5nIHx8IGJhdGNoLmVuY29kaW5nCiAgfQoKICBhc3luYyBvcGVuICgpIHsKICAgIGNvbnN0IG5vZGUgPSBhd2FpdCB0aGlzLmJhdGNoLmdldFJvb3QoZmFsc2UpCiAgICBpZiAoIW5vZGUgfHwgIW5vZGUua2V5cy5sZW5ndGgpIHJldHVybgogICAgY29uc3QgdHJlZSA9IG5ldyBTdWJUcmVlKG5vZGUsIG51bGwpCiAgICBpZiAodGhpcy5zZWVraW5nICYmICEoYXdhaXQgdGhpcy5fc2Vlayh0cmVlKSkpIHJldHVybgogICAgdGhpcy5zdGFjay5wdXNoKHRyZWUpCiAgfQoKICBhc3luYyBfc2VlayAodHJlZSkgewogICAgY29uc3QgZG9uZSA9IGF3YWl0IHRyZWUuYmlzZWN0KHRoaXMuZ3QsIHRoaXMuZ3RlKQogICAgY29uc3Qgb29iID0gIXRyZWUudXBkYXRlKCkKICAgIGlmIChkb25lIHx8IG9vYikgewogICAgICB0aGlzLnNlZWtpbmcgPSBmYWxzZQogICAgICBpZiAob29iKSByZXR1cm4gZmFsc2UKICAgIH0KICAgIHJldHVybiB0cnVlCiAgfQoKICBwZWVrICgpIHsKICAgIGlmICghdGhpcy5zdGFjay5sZW5ndGgpIHJldHVybiBudWxsCiAgICByZXR1cm4gdGhpcy5zdGFja1t0aGlzLnN0YWNrLmxlbmd0aCAtIDFdCiAgfQoKICBza2lwICgpIHsKICAgIGlmICghdGhpcy5zdGFjay5sZW5ndGgpIHJldHVybgogICAgaWYgKCF0aGlzLnN0YWNrW3RoaXMuc3RhY2subGVuZ3RoIC0gMV0ubmV4dCgpKSB0aGlzLnN0YWNrLnBvcCgpCiAgfQoKICBhc3luYyBuZXh0S2V5ICgpIHsKICAgIGxldCBuID0gbnVsbAogICAgd2hpbGUgKHRoaXMuc3RhY2subGVuZ3RoICYmIG4gPT09IG51bGwpIG4gPSBhd2FpdCB0aGlzLm5leHQoKQogICAgaWYgKG4gPT09IG51bGwpIHJldHVybiBudWxsCiAgICBpZiAoIXRoaXMubHQpIHJldHVybiBuLmZpbmFsKHRoaXMuZW5jb2RpbmcpCgogICAgY29uc3QgYyA9IGNtcChuLmtleSwgdGhpcy5sdCkKICAgIGlmICh0aGlzLmx0ZSA/IGMgPD0gMCA6IGMgPCAwKSByZXR1cm4gbi5maW5hbCh0aGlzLmVuY29kaW5nKQogICAgdGhpcy5zdGFjayA9IFtdCiAgICByZXR1cm4gbnVsbAogIH0KCiAgYXN5bmMgbmV4dCAoKSB7CiAgICBpZiAoIXRoaXMuc3RhY2subGVuZ3RoKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHRvcCA9IHRoaXMuc3RhY2tbdGhpcy5zdGFjay5sZW5ndGggLSAxXQogICAgY29uc3QgeyBpc0tleSwgbiwgc2VxIH0gPSB0b3AKCiAgICBpZiAoIXRvcC5uZXh0KCkpIHsKICAgICAgdGhpcy5zdGFjay5wb3AoKQogICAgfQoKICAgIGlmIChpc0tleSkgewogICAgICB0aGlzLnNlZWtpbmcgPSBmYWxzZQogICAgICByZXR1cm4gdGhpcy5iYXRjaC5nZXRCbG9jayhzZXEpCiAgICB9CgogICAgY29uc3QgY2hpbGQgPSBhd2FpdCB0b3Aubm9kZS5nZXRDaGlsZE5vZGUobikKICAgIHRvcC5ub2RlLmNoaWxkcmVuW25dID0gbnVsbCAvLyB1bmxpbmsgdG8gc2F2ZSBtZW1vcnkKICAgIGNvbnN0IHRyZWUgPSBuZXcgU3ViVHJlZShjaGlsZCwgdG9wKQogICAgaWYgKHRoaXMuc2Vla2luZyAmJiAhKGF3YWl0IHRoaXMuX3NlZWsodHJlZSkpKSByZXR1cm4gbnVsbAogICAgdGhpcy5zdGFjay5wdXNoKHRyZWUpCgogICAgcmV0dXJuIG51bGwKICB9CgogIGNsb3NlICgpIHsKICAgIHJldHVybiB0aGlzLmJhdGNoLl9jbG9zZVNuYXBzaG90KCkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgRGlmZkl0ZXJhdG9yIHsKICBjb25zdHJ1Y3RvciAobGVmdCwgcmlnaHQsIG9wdHMgPSB7fSkgewogICAgdGhpcy5sZWZ0ID0gbmV3IFRyZWVJdGVyYXRvcihsZWZ0LCBvcHRzKQogICAgdGhpcy5yaWdodCA9IG5ldyBUcmVlSXRlcmF0b3IocmlnaHQsIG9wdHMpCiAgICB0aGlzLmxpbWl0ID0gdHlwZW9mIG9wdHMubGltaXQgPT09ICdudW1iZXInID8gb3B0cy5saW1pdCA6IC0xCiAgfQoKICBhc3luYyBvcGVuICgpIHsKICAgIGF3YWl0IFByb21pc2UuYWxsKFt0aGlzLmxlZnQub3BlbigpLCB0aGlzLnJpZ2h0Lm9wZW4oKV0pCiAgfQoKICBhc3luYyBuZXh0ICgpIHsKICAgIGlmICh0aGlzLmxpbWl0ID09PSAwKSByZXR1cm4gbnVsbAogICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5fbmV4dCgpCiAgICBpZiAoIXJlcyB8fCAocmVzLmxlZnQgPT09IG51bGwgJiYgcmVzLnJpZ2h0ID09PSBudWxsKSkgcmV0dXJuIG51bGwKICAgIHRoaXMubGltaXQtLQogICAgcmV0dXJuIHJlcwogIH0KCiAgYXN5bmMgX25leHQgKCkgewogICAgY29uc3QgYSA9IHRoaXMubGVmdAogICAgY29uc3QgYiA9IHRoaXMucmlnaHQKCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBjb25zdCBbbCwgcl0gPSBhd2FpdCBQcm9taXNlLmFsbChbYS5wZWVrKCksIGIucGVlaygpXSkKCiAgICAgIGlmICghbCAmJiAhcikgcmV0dXJuIG51bGwKICAgICAgaWYgKCFsKSByZXR1cm4geyBsZWZ0OiBudWxsLCByaWdodDogYXdhaXQgYi5uZXh0S2V5KCkgfQogICAgICBpZiAoIXIpIHJldHVybiB7IGxlZnQ6IGF3YWl0IGEubmV4dEtleSgpLCByaWdodDogbnVsbCB9CgogICAgICBpZiAobC5zZXEgPT09IHIuc2VxICYmIGwuaXNLZXkgPT09IHIuaXNLZXkgJiYgbC5vZmZzZXQgPT09IHIub2Zmc2V0KSB7CiAgICAgICAgYS5za2lwKCkKICAgICAgICBiLnNraXAoKQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGNvbnN0IGMgPSBhd2FpdCBsLmNvbXBhcmUocikKCiAgICAgIGlmIChsLmlzS2V5ICYmICFyLmlzS2V5KSB7CiAgICAgICAgYXdhaXQgYi5uZXh0KCkKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBpZiAoIWwuaXNLZXkgJiYgci5pc0tleSkgewogICAgICAgIGF3YWl0IGEubmV4dCgpCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgaWYgKGwuaXNLZXkgJiYgci5pc0tleSkgewogICAgICAgIGlmIChjID09PSAwKSByZXR1cm4geyBsZWZ0OiBhd2FpdCBhLm5leHRLZXkoKSwgcmlnaHQ6IGF3YWl0IGIubmV4dEtleSgpIH0KICAgICAgICBpZiAoYyA8IDApIHJldHVybiB7IGxlZnQ6IGF3YWl0IGEubmV4dEtleSgpLCByaWdodDogbnVsbCB9CiAgICAgICAgcmV0dXJuIHsgbGVmdDogbnVsbCwgcmlnaHQ6IGF3YWl0IGIubmV4dEtleSgpIH0KICAgICAgfQoKICAgICAgaWYgKGMgPT09IDApIGF3YWl0IFByb21pc2UuYWxsKFthLm5leHQoKSwgYi5uZXh0KCldKQogICAgICBlbHNlIGlmIChjIDwgMCkgYXdhaXQgYi5uZXh0KCkKICAgICAgZWxzZSBhd2FpdCBhLm5leHQoKQogICAgfQogIH0KCiAgYXN5bmMgY2xvc2UgKCkgewogICAgYXdhaXQgUHJvbWlzZS5hbGwoW3RoaXMubGVmdC5jbG9zZSgpLCB0aGlzLnJpZ2h0LmNsb3NlKCldKQogIH0KfQoKZnVuY3Rpb24gY21wIChhLCBiKSB7CiAgaWYgKCFhKSByZXR1cm4gYiA/IDEgOiAwCiAgaWYgKCFiKSByZXR1cm4gYSA/IC0xIDogMAogIHJldHVybiBiNGEuY29tcGFyZShhLCBiKQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgSGlzdG9yeUl0ZXJhdG9yIHsKICBjb25zdHJ1Y3RvciAoYmF0Y2gsIG9wdHMgPSB7fSkgewogICAgdGhpcy5iYXRjaCA9IGJhdGNoCiAgICB0aGlzLm9wdGlvbnMgPSBvcHRzCiAgICB0aGlzLmxpdmUgPSAhIW9wdHMubGl2ZQogICAgdGhpcy5ndGUgPSAwCiAgICB0aGlzLmx0ID0gMAogICAgdGhpcy5yZXZlcnNlID0gISFvcHRzLnJldmVyc2UKICAgIHRoaXMubGltaXQgPSB0eXBlb2Ygb3B0cy5saW1pdCA9PT0gJ251bWJlcicgPyBvcHRzLmxpbWl0IDogLTEKICAgIHRoaXMuZW5jb2RpbmcgPSBvcHRzLmVuY29kaW5nIHx8IGJhdGNoLmVuY29kaW5nCiAgICBpZiAodGhpcy5saXZlICYmIHRoaXMucmV2ZXJzZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBoYXZlIGJvdGggbGl2ZSBhbmQgcmV2ZXJzZSBlbmFibGVkJykKICAgIH0KICB9CgogIGFzeW5jIG9wZW4gKCkgewogICAgYXdhaXQgdGhpcy5iYXRjaC5nZXRSb290KGZhbHNlKSAvLyBkb2VzIHRoZSB1cGRhdGUgZGFuY2UKICAgIHRoaXMuZ3RlID0gZ3RlKHRoaXMub3B0aW9ucywgdGhpcy5iYXRjaC52ZXJzaW9uKQogICAgdGhpcy5sdCA9IHRoaXMubGl2ZSA/IEluZmluaXR5IDogbHQodGhpcy5vcHRpb25zLCB0aGlzLmJhdGNoLnZlcnNpb24pCiAgfQoKICBhc3luYyBuZXh0ICgpIHsKICAgIGlmICh0aGlzLmxpbWl0ID09PSAwKSByZXR1cm4gbnVsbAogICAgaWYgKHRoaXMubGltaXQgPiAwKSB0aGlzLmxpbWl0LS0KCiAgICBpZiAodGhpcy5ndGUgPj0gdGhpcy5sdCkgcmV0dXJuIG51bGwKCiAgICBpZiAodGhpcy5yZXZlcnNlKSB7CiAgICAgIGlmICh0aGlzLmx0IDw9IDEpIHJldHVybiBudWxsCiAgICAgIHJldHVybiBmaW5hbChhd2FpdCB0aGlzLmJhdGNoLmdldEJsb2NrKC0tdGhpcy5sdCksIHRoaXMuZW5jb2RpbmcpCiAgICB9CgogICAgcmV0dXJuIGZpbmFsKGF3YWl0IHRoaXMuYmF0Y2guZ2V0QmxvY2sodGhpcy5ndGUrKyksIHRoaXMuZW5jb2RpbmcpCiAgfQoKICBjbG9zZSAoKSB7CiAgICByZXR1cm4gdGhpcy5iYXRjaC5fY2xvc2VTbmFwc2hvdCgpCiAgfQp9CgpmdW5jdGlvbiBmaW5hbCAobm9kZSwgZW5jb2RpbmcpIHsKICBjb25zdCB0eXBlID0gbm9kZS5pc0RlbGV0aW9uKCkgPyAnZGVsJyA6ICdwdXQnCiAgcmV0dXJuIHsgdHlwZSwgLi4ubm9kZS5maW5hbChlbmNvZGluZykgfQp9CgpmdW5jdGlvbiBndGUgKG9wdHMsIHZlcnNpb24pIHsKICBpZiAob3B0cy5ndCkgcmV0dXJuIChvcHRzLmd0IDwgMCA/IChvcHRzLmd0ICsgdmVyc2lvbikgOiBvcHRzLmd0KSArIDEKICBjb25zdCBndGUgPSBvcHRzLmd0ZSB8fCBvcHRzLnNpbmNlIHx8IDEKICByZXR1cm4gZ3RlIDwgMCA/IGd0ZSArIHZlcnNpb24gOiBndGUKfQoKZnVuY3Rpb24gbHQgKG9wdHMsIHZlcnNpb24pIHsKICBpZiAob3B0cy5sdGUgPT09IDAgfHwgb3B0cy5sdCA9PT0gMCB8fCBvcHRzLmVuZCA9PT0gMCkgcmV0dXJuIDAKICBpZiAob3B0cy5sdGUpIHJldHVybiAob3B0cy5sdGUgPCAwID8gKG9wdHMubHRlICsgdmVyc2lvbikgOiBvcHRzLmx0ZSkgKyAxCiAgY29uc3QgbHQgPSBvcHRzLmx0IHx8IG9wdHMuZW5kIHx8IHZlcnNpb24KICByZXR1cm4gbHQgPCAwID8gbHQgKyB2ZXJzaW9uIDogbHQKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIExvY2FsQmxvY2tzSXRlcmF0b3IgewogIGNvbnN0cnVjdG9yIChiYXRjaCwgb3B0cyA9IHt9KSB7CiAgICB0aGlzLmJhdGNoID0gYmF0Y2gKICAgIHRoaXMub3B0aW9ucyA9IG9wdHMKICAgIHRoaXMuZ3RlID0gMAogICAgdGhpcy5sdCA9IDAKICAgIHRoaXMubGltaXQgPSB0eXBlb2Ygb3B0cy5saW1pdCA9PT0gJ251bWJlcicgPyBvcHRzLmxpbWl0IDogLTEKICB9CgogIGFzeW5jIG9wZW4gKCkgewogICAgYXdhaXQgdGhpcy5iYXRjaC5nZXRSb290KGZhbHNlKSAvLyBkb2VzIHRoZSB1cGRhdGUgZGFuY2UKICAgIHRoaXMuZ3RlID0gZ3RlKHRoaXMub3B0aW9ucywgdGhpcy5iYXRjaC52ZXJzaW9uKQogICAgdGhpcy5sdCA9IGx0KHRoaXMub3B0aW9ucywgdGhpcy5iYXRjaC52ZXJzaW9uKQogIH0KCiAgYXN5bmMgbmV4dCAoKSB7CiAgICBpZiAodGhpcy5saW1pdCA9PT0gMCkgcmV0dXJuIG51bGwKICAgIGlmICh0aGlzLmxpbWl0ID4gMCkgdGhpcy5saW1pdC0tCgogICAgd2hpbGUgKHRoaXMuZ3RlIDwgdGhpcy5sdCkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmJhdGNoLmdldEJsb2NrKHRoaXMuZ3RlKyspCiAgICAgIH0gY2F0Y2ggewogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgY2xvc2UgKCkgewogICAgcmV0dXJuIHRoaXMuYmF0Y2guX2Nsb3NlU25hcHNob3QoKQogIH0KfQoKZnVuY3Rpb24gZ3RlIChvcHRzLCB2ZXJzaW9uKSB7CiAgaWYgKG9wdHMuZ3QpIHJldHVybiAob3B0cy5ndCA8IDAgPyAob3B0cy5ndCArIHZlcnNpb24pIDogb3B0cy5ndCkgKyAxCiAgY29uc3QgZ3RlID0gb3B0cy5ndGUgfHwgb3B0cy5zaW5jZSB8fCAxCiAgcmV0dXJuIGd0ZSA8IDAgPyBndGUgKyB2ZXJzaW9uIDogZ3RlCn0KCmZ1bmN0aW9uIGx0IChvcHRzLCB2ZXJzaW9uKSB7CiAgaWYgKG9wdHMubHRlID09PSAwIHx8IG9wdHMubHQgPT09IDAgfHwgb3B0cy5lbmQgPT09IDApIHJldHVybiAwCiAgaWYgKG9wdHMubHRlKSByZXR1cm4gKG9wdHMubHRlIDwgMCA/IChvcHRzLmx0ZSArIHZlcnNpb24pIDogb3B0cy5sdGUpICsgMQogIGNvbnN0IGx0ID0gb3B0cy5sdCB8fCBvcHRzLmVuZCB8fCB2ZXJzaW9uCiAgcmV0dXJuIGx0IDwgMCA/IGx0ICsgdmVyc2lvbiA6IGx0Cn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUmFuZ2VJdGVyYXRvciB7CiAgY29uc3RydWN0b3IgKGJhdGNoLCBlbmNvZGluZywgb3B0cyA9IHt9KSB7CiAgICB0aGlzLmJhdGNoID0gYmF0Y2gKICAgIHRoaXMuc3RhY2sgPSBbXQogICAgdGhpcy5vcGVuZWQgPSBmYWxzZQogICAgdGhpcy5lbmNvZGluZyA9IGVuY29kaW5nIHx8IGJhdGNoLmVuY29kaW5nCgogICAgdGhpcy5fbGltaXQgPSB0eXBlb2Ygb3B0cy5saW1pdCA9PT0gJ251bWJlcicgPyBvcHRzLmxpbWl0IDogLTEKICAgIHRoaXMuX2dJbmNsID0gIW9wdHMuZ3QKICAgIHRoaXMuX2dLZXkgPSBvcHRzLmd0IHx8IG9wdHMuZ3RlIHx8IG51bGwKICAgIHRoaXMuX2xJbmNsID0gIW9wdHMubHQKICAgIHRoaXMuX2xLZXkgPSBvcHRzLmx0IHx8IG9wdHMubHRlIHx8IG51bGwKICAgIHRoaXMuX3JldmVyc2UgPSAhIW9wdHMucmV2ZXJzZQogICAgdGhpcy5fdmVyc2lvbiA9IDAKICAgIHRoaXMuX2NoZWNrcG9pbnQgPSAob3B0cy5jaGVja3BvaW50ICYmIG9wdHMuY2hlY2twb2ludC5sZW5ndGgpID8gb3B0cy5jaGVja3BvaW50IDogbnVsbAogICAgdGhpcy5fbmV4dGluZyA9IGZhbHNlCiAgfQoKICBzbmFwc2hvdCAodmVyc2lvbiA9IHRoaXMuYmF0Y2gudmVyc2lvbikgewogICAgY29uc3QgY2hlY2twb2ludCA9IFtdCiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5zdGFjaykgewogICAgICBsZXQgeyBub2RlLCBpIH0gPSBzCiAgICAgIGlmICh0aGlzLl9uZXh0aW5nICYmIHMgPT09IHRoaXMuc3RhY2tbdGhpcy5zdGFjay5sZW5ndGggLSAxXSkgaSA9IHRoaXMuX3JldmVyc2UgPyBpICsgMSA6IGkgLSAxCiAgICAgIGlmICghbm9kZS5ibG9jaykgY29udGludWUKICAgICAgaWYgKGkgPCAwKSBjb250aW51ZQogICAgICBjaGVja3BvaW50LnB1c2gobm9kZS5ibG9jay5zZXEsIG5vZGUub2Zmc2V0LCBpKQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb24sCiAgICAgIGd0ZTogdGhpcy5fZ0luY2wgPyB0aGlzLl9nS2V5IDogbnVsbCwKICAgICAgZ3Q6IHRoaXMuX2dJbmNsID8gbnVsbCA6IHRoaXMuX2dLZXksCiAgICAgIGx0ZTogdGhpcy5fbEluY2wgPyB0aGlzLl9sS2V5IDogbnVsbCwKICAgICAgbHQ6IHRoaXMuX2xJbmNsID8gbnVsbCA6IHRoaXMuX2xLZXksCiAgICAgIGxpbWl0OiB0aGlzLl9saW1pdCwKICAgICAgcmV2ZXJzZTogdGhpcy5fcmV2ZXJzZSwKICAgICAgZW5kZWQ6IHRoaXMub3BlbmVkICYmICFjaGVja3BvaW50Lmxlbmd0aCwKICAgICAgY2hlY2twb2ludDogdGhpcy5vcGVuZWQgPyBjaGVja3BvaW50IDogW10KICAgIH0KICB9CgogIGFzeW5jIG9wZW4gKCkgewogICAgYXdhaXQgdGhpcy5fb3BlbigpCiAgICB0aGlzLm9wZW5lZCA9IHRydWUKICB9CgogIGFzeW5jIF9vcGVuICgpIHsKICAgIGlmICh0aGlzLl9jaGVja3BvaW50KSB7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGhpcy5fY2hlY2twb2ludC5sZW5ndGg7IGogKz0gMykgewogICAgICAgIGNvbnN0IHNlcSA9IHRoaXMuX2NoZWNrcG9pbnRbal0KICAgICAgICBjb25zdCBvZmZzZXQgPSB0aGlzLl9jaGVja3BvaW50W2ogKyAxXQogICAgICAgIGNvbnN0IGkgPSB0aGlzLl9jaGVja3BvaW50W2ogKyAyXQogICAgICAgIHRoaXMuc3RhY2sucHVzaCh7CiAgICAgICAgICBub2RlOiAoYXdhaXQgdGhpcy5iYXRjaC5nZXRCbG9jayhzZXEpKS5nZXRUcmVlTm9kZShvZmZzZXQpLAogICAgICAgICAgaQogICAgICAgIH0pCiAgICAgIH0KICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5fbmV4dGluZyA9IHRydWUKCiAgICBsZXQgbm9kZSA9IGF3YWl0IHRoaXMuYmF0Y2guZ2V0Um9vdChmYWxzZSkKICAgIGlmICghbm9kZSkgewogICAgICB0aGlzLl9uZXh0aW5nID0gZmFsc2UKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgaW5jbCA9IHRoaXMuX3JldmVyc2UgPyB0aGlzLl9sSW5jbCA6IHRoaXMuX2dJbmNsCiAgICBjb25zdCBzdGFydCA9IHRoaXMuX3JldmVyc2UgPyB0aGlzLl9sS2V5IDogdGhpcy5fZ0tleQoKICAgIGlmICghc3RhcnQpIHsKICAgICAgdGhpcy5zdGFjay5wdXNoKHsgbm9kZSwgaTogdGhpcy5fcmV2ZXJzZSA/IG5vZGUua2V5cy5sZW5ndGggPDwgMSA6IDAgfSkKICAgICAgdGhpcy5fbmV4dGluZyA9IGZhbHNlCiAgICAgIHJldHVybgogICAgfQoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGNvbnN0IGVudHJ5ID0geyBub2RlLCBpOiB0aGlzLl9yZXZlcnNlID8gbm9kZS5rZXlzLmxlbmd0aCA8PCAxIDogMCB9CgogICAgICBsZXQgcyA9IDAKICAgICAgbGV0IGUgPSBub2RlLmtleXMubGVuZ3RoCiAgICAgIGxldCBjCgogICAgICB3aGlsZSAocyA8IGUpIHsKICAgICAgICBjb25zdCBtaWQgPSAocyArIGUpID4+IDEKICAgICAgICBjID0gYjRhLmNvbXBhcmUoc3RhcnQsIGF3YWl0IG5vZGUuZ2V0S2V5KG1pZCkpCgogICAgICAgIGlmIChjID09PSAwKSB7CiAgICAgICAgICBpZiAoaW5jbCkgZW50cnkuaSA9IG1pZCAqIDIgKyAxCiAgICAgICAgICBlbHNlIGVudHJ5LmkgPSBtaWQgKiAyICsgKHRoaXMuX3JldmVyc2UgPyAwIDogMikKICAgICAgICAgIHRoaXMuc3RhY2sucHVzaChlbnRyeSkKICAgICAgICAgIHRoaXMuX25leHRpbmcgPSBmYWxzZQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQoKICAgICAgICBpZiAoYyA8IDApIGUgPSBtaWQKICAgICAgICBlbHNlIHMgPSBtaWQgKyAxCiAgICAgIH0KCiAgICAgIGNvbnN0IGkgPSBjIDwgMCA/IGUgOiBzCiAgICAgIGVudHJ5LmkgPSAyICogaSArICh0aGlzLl9yZXZlcnNlID8gLTEgOiAxKQoKICAgICAgaWYgKGVudHJ5LmkgPj0gMCAmJiBlbnRyeS5pIDw9IChub2RlLmtleXMubGVuZ3RoIDw8IDEpKSB0aGlzLnN0YWNrLnB1c2goZW50cnkpCiAgICAgIGlmICghbm9kZS5jaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICB0aGlzLl9uZXh0aW5nID0gZmFsc2UKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgbm9kZSA9IGF3YWl0IG5vZGUuZ2V0Q2hpbGROb2RlKGkpCiAgICB9CiAgfQoKICBhc3luYyBuZXh0ICgpIHsKICAgIC8vIFRPRE86IHRoaXMgbmV4dGluZyBmbGFnIGlzIG9ubHkgbmVlZGVkIGlmIHNvbWVvbmUgYXNrcyBmb3IgYSBzbmFwc2hvdCBkdXJpbmcKICAgIC8vIGEgbG9va3VwIChpZSB0aGUgZXh0ZW5zaW9uLCBwcmV0dHkgaW1wb3J0YW50Li4uKS4KICAgIC8vIEEgYmV0dGVyIHNvbHV0aW9uIHdvdWxkIGJlIHRvIHJlZmFjdG9yIHRoaXMgc28gdG9wLmkgaXMgaW5jcmVtZW50ZWQgZWFnZXJseQogICAgLy8gdG8gZ2V0IHRoZSBjdXJyZW50IGJsb2NrIGluc3RlYWQgb2YgdGhlIHdheSBpdCBpcyBkb25lIG5vdyAoKytpIHZzIGkrKykKICAgIHRoaXMuX25leHRpbmcgPSB0cnVlCgogICAgY29uc3QgZW5kID0gdGhpcy5fcmV2ZXJzZSA/IHRoaXMuX2dLZXkgOiB0aGlzLl9sS2V5CiAgICBjb25zdCBpbmNsID0gdGhpcy5fcmV2ZXJzZSA/IHRoaXMuX2dJbmNsIDogdGhpcy5fbEluY2wKCiAgICB3aGlsZSAodGhpcy5zdGFjay5sZW5ndGggJiYgKHRoaXMuX2xpbWl0ID09PSAtMSB8fCB0aGlzLl9saW1pdCA+IDApKSB7CiAgICAgIGNvbnN0IHRvcCA9IHRoaXMuc3RhY2tbdGhpcy5zdGFjay5sZW5ndGggLSAxXQogICAgICBjb25zdCBpc0tleSA9ICh0b3AuaSAmIDEpID09PSAxCiAgICAgIGNvbnN0IG4gPSB0aGlzLl9yZXZlcnNlCiAgICAgICAgPyAodG9wLmkgPCAwID8gdG9wLm5vZGUua2V5cy5sZW5ndGggOiB0b3AuaS0tID4+IDEpCiAgICAgICAgOiB0b3AuaSsrID4+IDEKCiAgICAgIGlmICghaXNLZXkpIHsKICAgICAgICBpZiAoIXRvcC5ub2RlLmNoaWxkcmVuLmxlbmd0aCkgY29udGludWUKICAgICAgICBjb25zdCBub2RlID0gYXdhaXQgdG9wLm5vZGUuZ2V0Q2hpbGROb2RlKG4pCiAgICAgICAgaWYgKHRvcC5ub2RlLmJsb2NrLnNlcSA8IHRoaXMuYmF0Y2guY29yZS5sZW5ndGgpIHsKICAgICAgICAgIHRvcC5ub2RlLmNoaWxkcmVuW25dLnZhbHVlID0gbnVsbCAvLyB1bmxpbmsgaXQgdG8gc2F2ZSBtZW1vcnkKICAgICAgICB9CiAgICAgICAgdGhpcy5zdGFjay5wdXNoKHsgaTogdGhpcy5fcmV2ZXJzZSA/IG5vZGUua2V5cy5sZW5ndGggPDwgMSA6IDAsIG5vZGUgfSkKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBpZiAobiA+PSB0b3Aubm9kZS5rZXlzLmxlbmd0aCkgewogICAgICAgIHRoaXMuc3RhY2sucG9wKCkKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBjb25zdCBrZXkgPSB0b3Aubm9kZS5rZXlzW25dCiAgICAgIGNvbnN0IGJsb2NrID0gYXdhaXQgdGhpcy5iYXRjaC5nZXRCbG9jayhrZXkuc2VxKQogICAgICBpZiAoZW5kKSB7CiAgICAgICAgY29uc3QgYyA9IGI0YS5jb21wYXJlKGJsb2NrLmtleSwgZW5kKQogICAgICAgIGlmIChjID09PSAwID8gIWluY2wgOiAodGhpcy5fcmV2ZXJzZSA/IGMgPCAwIDogYyA+IDApKSB7CiAgICAgICAgICB0aGlzLl9saW1pdCA9IDAKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh0aGlzLl9saW1pdCA+IDApIHRoaXMuX2xpbWl0LS0KICAgICAgdGhpcy5fbmV4dGluZyA9IGZhbHNlCiAgICAgIHJldHVybiBibG9jay5maW5hbCh0aGlzLmVuY29kaW5nKQogICAgfQoKICAgIHRoaXMuX25leHRpbmcgPSBmYWxzZQogICAgcmV0dXJuIG51bGwKICB9CgogIGNsb3NlICgpIHsKICAgIHJldHVybiB0aGlzLmJhdGNoLl9jbG9zZVNuYXBzaG90KCkKICB9Cn0KY29uc3QgeyBFeHRlbnNpb24gfSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMnKQoKLy8gY29uc3QgTUFYX0FDVElWRSA9IDMyCmNvbnN0IEZMVVNIX0JBVENIID0gMTI4CmNvbnN0IE1BWF9QQVNTSVZFX0JBVENIID0gMjA0OApjb25zdCBNQVhfQUNUSVZFX0JBVENIID0gTUFYX1BBU1NJVkVfQkFUQ0ggKyBGTFVTSF9CQVRDSAoKY2xhc3MgQmF0Y2ggewogIGNvbnN0cnVjdG9yIChvdXRnb2luZywgZnJvbSkgewogICAgdGhpcy5ibG9ja3MgPSBbXQogICAgdGhpcy5zdGFydCA9IDAKICAgIHRoaXMuZW5kID0gMAogICAgdGhpcy5vdXRnb2luZyA9IG91dGdvaW5nCiAgICB0aGlzLmZyb20gPSBmcm9tCiAgfQoKICBwdXNoIChzZXEpIHsKICAgIGNvbnN0IGxlbiA9IHRoaXMuYmxvY2tzLnB1c2goc2VxKQogICAgaWYgKGxlbiA9PT0gMSB8fCBzZXEgPCB0aGlzLnN0YXJ0KSB0aGlzLnN0YXJ0ID0gc2VxCiAgICBpZiAobGVuID09PSAxIHx8IHNlcSA+PSB0aGlzLmVuZCkgdGhpcy5lbmQgPSBzZXEgKyAxCiAgICBpZiAobGVuID49IEZMVVNIX0JBVENIKSB7CiAgICAgIHRoaXMuc2VuZCgpCiAgICAgIHRoaXMuY2xlYXIoKQogICAgfQogIH0KCiAgc2VuZCAoKSB7CiAgICBpZiAoIXRoaXMuYmxvY2tzLmxlbmd0aCkgcmV0dXJuCiAgICB0aGlzLm91dGdvaW5nLnNlbmQoRXh0ZW5zaW9uLmVuY29kZSh7IGNhY2hlOiB7IGJsb2NrczogdGhpcy5ibG9ja3MsIHN0YXJ0OiB0aGlzLnN0YXJ0LCBlbmQ6IHRoaXMuZW5kIH0gfSksIHRoaXMuZnJvbSkKICB9CgogIGNsZWFyICgpIHsKICAgIHRoaXMuc3RhcnQgPSB0aGlzLmVuZCA9IDAKICAgIHRoaXMuYmxvY2tzID0gW10KICB9Cn0KCmNsYXNzIEh5cGVyYmVlRXh0ZW5zaW9uIHsKICBjb25zdHJ1Y3RvciAoZGIpIHsKICAgIHRoaXMuZW5jb2RpbmcgPSBudWxsCiAgICB0aGlzLm91dGdvaW5nID0gbnVsbAogICAgdGhpcy5kYiA9IGRiCiAgICB0aGlzLmFjdGl2ZSA9IDAKICB9CgogIGdldCAodmVyc2lvbiwga2V5KSB7CiAgICB0aGlzLm91dGdvaW5nLmJyb2FkY2FzdChFeHRlbnNpb24uZW5jb2RlKHsgZ2V0OiB7IHZlcnNpb24sIGtleSB9IH0pKQogIH0KCiAgaXRlcmF0b3IgKHNuYXBzaG90KSB7CiAgICBpZiAoc25hcHNob3QuZW5kZWQpIHJldHVybgogICAgaWYgKHNuYXBzaG90LmxpbWl0ID09PSAwKSByZXR1cm4KICAgIGlmIChzbmFwc2hvdC5saW1pdCA9PT0gLTEpIHNuYXBzaG90LmxpbWl0ID0gMAogICAgdGhpcy5vdXRnb2luZy5icm9hZGNhc3QoRXh0ZW5zaW9uLmVuY29kZSh7IGl0ZXJhdG9yOiBzbmFwc2hvdCB9KSkKICB9CgogIG9ubWVzc2FnZSAoYnVmLCBmcm9tKSB7CiAgICAvLyBUT0RPOiBoYW5kbGUgbWF4IGFjdGl2ZSBleHRlbnNpb24gbWVzc2FnZXMKICAgIC8vIHRoaXMuYWN0aXZlKysKCiAgICBjb25zdCBtZXNzYWdlID0gZGVjb2RlKGJ1ZikKICAgIGlmICghbWVzc2FnZSkgcmV0dXJuCgogICAgaWYgKG1lc3NhZ2UuY2FjaGUpIHRoaXMub25jYWNoZShtZXNzYWdlLmNhY2hlLCBmcm9tKQogICAgaWYgKG1lc3NhZ2UuZ2V0KSB0aGlzLm9uZ2V0KG1lc3NhZ2UuZ2V0LCBmcm9tKQogICAgaWYgKG1lc3NhZ2UuaXRlcmF0b3IpIHRoaXMub25pdGVyYXRvcihtZXNzYWdlLml0ZXJhdG9yLCBmcm9tKQogIH0KCiAgb25jYWNoZSAobWVzc2FnZSwgZnJvbSkgewogICAgaWYgKCFtZXNzYWdlLmJsb2Nrcy5sZW5ndGgpIHJldHVybgogICAgdGhpcy5kYi5jb3JlLmRvd25sb2FkKG1lc3NhZ2UpCiAgfQoKICBvbmdldCAobWVzc2FnZSwgZnJvbSkgewogICAgaWYgKCFtZXNzYWdlLnZlcnNpb24gfHwgbWVzc2FnZS52ZXJzaW9uID4gdGhpcy5kYi52ZXJzaW9uKSByZXR1cm4KCiAgICBjb25zdCBiID0gbmV3IEJhdGNoKHRoaXMub3V0Z29pbmcsIGZyb20pCiAgICBjb25zdCBkYiA9IHRoaXMuZGIuY2hlY2tvdXQobWVzc2FnZS52ZXJzaW9uKQoKICAgIGRiLmdldChtZXNzYWdlLmtleSwgeyBleHRlbnNpb246IGZhbHNlLCB3YWl0OiBmYWxzZSwgdXBkYXRlOiBmYWxzZSwgb25zZXEgfSkudGhlbihkb25lLCBkb25lKQoKICAgIGZ1bmN0aW9uIGRvbmUgKCkgewogICAgICBkYi5jbG9zZSgpLmNhdGNoKG5vb3ApCiAgICAgIGIuc2VuZCgpCiAgICB9CgogICAgZnVuY3Rpb24gb25zZXEgKHNlcSkgewogICAgICBiLnB1c2goc2VxKQogICAgfQogIH0KCiAgYXN5bmMgb25pdGVyYXRvciAobWVzc2FnZSwgZnJvbSkgewogICAgaWYgKCFtZXNzYWdlLnZlcnNpb24gfHwgbWVzc2FnZS52ZXJzaW9uID4gdGhpcy5kYi52ZXJzaW9uKSByZXR1cm4KCiAgICBjb25zdCBiID0gbmV3IEJhdGNoKHRoaXMub3V0Z29pbmcsIGZyb20pCiAgICBjb25zdCBzZXFzID0gbmV3IFNldCgpCgogICAgbGV0IHNraXAgPSBtZXNzYWdlLmNoZWNrcG9pbnQubGVuZ3RoCiAgICBsZXQgd29yayA9IDAKCiAgICBjb25zdCBkYiA9IHRoaXMuZGIuY2hlY2tvdXQobWVzc2FnZS52ZXJzaW9uKQogICAgY29uc3QgaXRlID0gZGIuY3JlYXRlUmFuZ2VJdGVyYXRvcih7CiAgICAgIC4uLm1lc3NhZ2UsCiAgICAgIHdhaXQ6IGZhbHNlLAogICAgICBleHRlbnNpb246IGZhbHNlLAogICAgICB1cGRhdGU6IGZhbHNlLAogICAgICBsaW1pdDogbWVzc2FnZS5saW1pdCA9PT0gMCA/IC0xIDogbWVzc2FnZS5saW1pdCwKICAgICAgb25zZXEgKHNlcSkgewogICAgICAgIGlmIChza2lwICYmIHNraXAtLSkgcmV0dXJuCiAgICAgICAgaWYgKHNlcXMuaGFzKHNlcSkpIHJldHVybgogICAgICAgIHdvcmsrKwogICAgICAgIHNlcXMuYWRkKHNlcSkKICAgICAgICBiLnB1c2goc2VxKQogICAgICB9CiAgICB9KQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IGl0ZS5vcGVuKCkKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVubW9kaWZpZWQtbG9vcC1jb25kaXRpb24KICAgICAgd2hpbGUgKHdvcmsgPCBNQVhfQUNUSVZFX0JBVENIKSB7CiAgICAgICAgaWYgKCEoYXdhaXQgaXRlLm5leHQoKSkpIGJyZWFrCiAgICAgIH0KICAgIH0gY2F0Y2ggKF8pIHsKICAgICAgLy8gZG8gbm90aGluZwogICAgfSBmaW5hbGx5IHsKICAgICAgaXRlLmNsb3NlKCkuY2F0Y2gobm9vcCkKICAgICAgZGIuY2xvc2UoKS5jYXRjaChub29wKQogICAgICBiLnNlbmQoKQogICAgfQogIH0KCiAgc3RhdGljIHJlZ2lzdGVyIChkYikgewogICAgY29uc3QgZSA9IG5ldyB0aGlzKGRiKQogICAgZS5vdXRnb2luZyA9IGRiLmNvcmUucmVnaXN0ZXJFeHRlbnNpb24oJ2h5cGVyYmVlJywgZSkKICAgIHJldHVybiBlCiAgfQp9CgpIeXBlcmJlZUV4dGVuc2lvbi5CQVRDSF9TSVpFID0gTUFYX1BBU1NJVkVfQkFUQ0gKCm1vZHVsZS5leHBvcnRzID0gSHlwZXJiZWVFeHRlbnNpb24KCmZ1bmN0aW9uIGRlY29kZSAoYnVmKSB7CiAgdHJ5IHsKICAgIHJldHVybiBFeHRlbnNpb24uZGVjb2RlKGJ1ZikKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBudWxsCiAgfQp9CgpmdW5jdGlvbiBub29wICgpIHt9Ci8vIFRoaXMgZmlsZSBpcyBhdXRvIGdlbmVyYXRlZCBieSB0aGUgcHJvdG9jb2wtYnVmZmVycyBjb21waWxlcgoKLyogZXNsaW50LWRpc2FibGUgcXVvdGVzICovCi8qIGVzbGludC1kaXNhYmxlIGluZGVudCAqLwovKiBlc2xpbnQtZGlzYWJsZSBuby1yZWRlY2xhcmUgKi8KLyogZXNsaW50LWRpc2FibGUgY2FtZWxjYXNlICovCi8qIGVzbGludC1kaXNhYmxlIG5vLXZhciAqLwoKLy8gUmVtZW1iZXIgdG8gYG5wbSBpbnN0YWxsIC0tc2F2ZSBwcm90b2NvbC1idWZmZXJzLWVuY29kaW5nc2AKdmFyIGVuY29kaW5ncyA9IHJlcXVpcmUoJ3Byb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzJykKdmFyIGI0YSA9IHJlcXVpcmUoJ2I0YScpCnZhciB2YXJpbnQgPSBlbmNvZGluZ3MudmFyaW50CnZhciBza2lwID0gZW5jb2RpbmdzLnNraXAKCnZhciBZb2xvSW5kZXggPSBleHBvcnRzLllvbG9JbmRleCA9IHsKICBidWZmZXI6IHRydWUsCiAgZW5jb2RpbmdMZW5ndGg6IG51bGwsCiAgZW5jb2RlOiBudWxsLAogIGRlY29kZTogbnVsbAp9Cgp2YXIgSGVhZGVyID0gZXhwb3J0cy5IZWFkZXIgPSB7CiAgYnVmZmVyOiB0cnVlLAogIGVuY29kaW5nTGVuZ3RoOiBudWxsLAogIGVuY29kZTogbnVsbCwKICBkZWNvZGU6IG51bGwKfQoKdmFyIE5vZGUgPSBleHBvcnRzLk5vZGUgPSB7CiAgYnVmZmVyOiB0cnVlLAogIGVuY29kaW5nTGVuZ3RoOiBudWxsLAogIGVuY29kZTogbnVsbCwKICBkZWNvZGU6IG51bGwKfQoKdmFyIEV4dGVuc2lvbiA9IGV4cG9ydHMuRXh0ZW5zaW9uID0gewogIGJ1ZmZlcjogdHJ1ZSwKICBlbmNvZGluZ0xlbmd0aDogbnVsbCwKICBlbmNvZGU6IG51bGwsCiAgZGVjb2RlOiBudWxsCn0KCmRlZmluZVlvbG9JbmRleCgpCmRlZmluZUhlYWRlcigpCmRlZmluZU5vZGUoKQpkZWZpbmVFeHRlbnNpb24oKQoKZnVuY3Rpb24gZGVmaW5lWW9sb0luZGV4ICgpIHsKICB2YXIgTGV2ZWwgPSBZb2xvSW5kZXguTGV2ZWwgPSB7CiAgICBidWZmZXI6IHRydWUsCiAgICBlbmNvZGluZ0xlbmd0aDogbnVsbCwKICAgIGVuY29kZTogbnVsbCwKICAgIGRlY29kZTogbnVsbAogIH0KCiAgZGVmaW5lTGV2ZWwoKQoKICBmdW5jdGlvbiBkZWZpbmVMZXZlbCAoKSB7CiAgICBMZXZlbC5lbmNvZGluZ0xlbmd0aCA9IGVuY29kaW5nTGVuZ3RoCiAgICBMZXZlbC5lbmNvZGUgPSBlbmNvZGUKICAgIExldmVsLmRlY29kZSA9IGRlY29kZQoKICAgIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChvYmopIHsKICAgICAgdmFyIGxlbmd0aCA9IDAKICAgICAgaWYgKGRlZmluZWQob2JqLmtleXMpKSB7CiAgICAgICAgdmFyIHBhY2tlZExlbiA9IDAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5rZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmtleXNbaV0pKSBjb250aW51ZQogICAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLmtleXNbaV0pCiAgICAgICAgICBwYWNrZWRMZW4gKz0gbGVuCiAgICAgICAgfQogICAgICAgIGlmIChwYWNrZWRMZW4pIHsKICAgICAgICAgIGxlbmd0aCArPSAxICsgcGFja2VkTGVuICsgdmFyaW50LmVuY29kaW5nTGVuZ3RoKHBhY2tlZExlbikKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmNoaWxkcmVuKSkgewogICAgICAgIHZhciBwYWNrZWRMZW4gPSAwCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmouY2hpbGRyZW5baV0pKSBjb250aW51ZQogICAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLmNoaWxkcmVuW2ldKQogICAgICAgICAgcGFja2VkTGVuICs9IGxlbgogICAgICAgIH0KICAgICAgICBpZiAocGFja2VkTGVuKSB7CiAgICAgICAgICBsZW5ndGggKz0gMSArIHBhY2tlZExlbiArIHZhcmludC5lbmNvZGluZ0xlbmd0aChwYWNrZWRMZW4pCiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBsZW5ndGgKICAgIH0KCiAgICBmdW5jdGlvbiBlbmNvZGUgKG9iaiwgYnVmLCBvZmZzZXQpIHsKICAgICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgICAgaWYgKCFidWYpIGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShlbmNvZGluZ0xlbmd0aChvYmopKQogICAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICAgIGlmIChkZWZpbmVkKG9iai5rZXlzKSkgewogICAgICAgIHZhciBwYWNrZWRMZW4gPSAwCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmoua2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5rZXlzW2ldKSkgY29udGludWUKICAgICAgICAgIHBhY2tlZExlbiArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5rZXlzW2ldKQogICAgICAgIH0KICAgICAgICBpZiAocGFja2VkTGVuKSB7CiAgICAgICAgICBidWZbb2Zmc2V0KytdID0gMTAKICAgICAgICAgIHZhcmludC5lbmNvZGUocGFja2VkTGVuLCBidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmoua2V5c1tpXSkpIGNvbnRpbnVlCiAgICAgICAgICBlbmNvZGluZ3MudmFyaW50LmVuY29kZShvYmoua2V5c1tpXSwgYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmNoaWxkcmVuKSkgewogICAgICAgIHZhciBwYWNrZWRMZW4gPSAwCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmouY2hpbGRyZW5baV0pKSBjb250aW51ZQogICAgICAgICAgcGFja2VkTGVuICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLmNoaWxkcmVuW2ldKQogICAgICAgIH0KICAgICAgICBpZiAocGFja2VkTGVuKSB7CiAgICAgICAgICBidWZbb2Zmc2V0KytdID0gMTgKICAgICAgICAgIHZhcmludC5lbmNvZGUocGFja2VkTGVuLCBidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmNoaWxkcmVuW2ldKSkgY29udGludWUKICAgICAgICAgIGVuY29kaW5ncy52YXJpbnQuZW5jb2RlKG9iai5jaGlsZHJlbltpXSwgYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgICB9CiAgICAgIH0KICAgICAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgIHJldHVybiBidWYKICAgIH0KCiAgICBmdW5jdGlvbiBkZWNvZGUgKGJ1Ziwgb2Zmc2V0LCBlbmQpIHsKICAgICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgICAgaWYgKCFlbmQpIGVuZCA9IGJ1Zi5sZW5ndGgKICAgICAgaWYgKCEoZW5kIDw9IGJ1Zi5sZW5ndGggJiYgb2Zmc2V0IDw9IGJ1Zi5sZW5ndGgpKSB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgbWVzc2FnZSBpcyBub3QgdmFsaWQiKQogICAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICAgIHZhciBvYmogPSB7CiAgICAgICAga2V5czogW10sCiAgICAgICAgY2hpbGRyZW46IFtdCiAgICAgIH0KICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBpZiAoZW5kIDw9IG9mZnNldCkgewogICAgICAgICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgICAgICByZXR1cm4gb2JqCiAgICAgICAgfQogICAgICAgIHZhciBwcmVmaXggPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgdmFyIHRhZyA9IHByZWZpeCA+PiAzCiAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgIHZhciBwYWNrZWRFbmQgPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIHBhY2tlZEVuZCArPSBvZmZzZXQKICAgICAgICAgIHdoaWxlIChvZmZzZXQgPCBwYWNrZWRFbmQpIHsKICAgICAgICAgICAgb2JqLmtleXMucHVzaChlbmNvZGluZ3MudmFyaW50LmRlY29kZShidWYsIG9mZnNldCkpCiAgICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgfQogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgIHZhciBwYWNrZWRFbmQgPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIHBhY2tlZEVuZCArPSBvZmZzZXQKICAgICAgICAgIHdoaWxlIChvZmZzZXQgPCBwYWNrZWRFbmQpIHsKICAgICAgICAgICAgb2JqLmNoaWxkcmVuLnB1c2goZW5jb2RpbmdzLnZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpKQogICAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgb2Zmc2V0ID0gc2tpcChwcmVmaXggJiA3LCBidWYsIG9mZnNldCkKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIFlvbG9JbmRleC5lbmNvZGluZ0xlbmd0aCA9IGVuY29kaW5nTGVuZ3RoCiAgWW9sb0luZGV4LmVuY29kZSA9IGVuY29kZQogIFlvbG9JbmRleC5kZWNvZGUgPSBkZWNvZGUKCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKG9iaikgewogICAgdmFyIGxlbmd0aCA9IDAKICAgIGlmIChkZWZpbmVkKG9iai5sZXZlbHMpKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmxldmVscy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICghZGVmaW5lZChvYmoubGV2ZWxzW2ldKSkgY29udGludWUKICAgICAgICB2YXIgbGVuID0gTGV2ZWwuZW5jb2RpbmdMZW5ndGgob2JqLmxldmVsc1tpXSkKICAgICAgICBsZW5ndGggKz0gdmFyaW50LmVuY29kaW5nTGVuZ3RoKGxlbikKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICB9CiAgICByZXR1cm4gbGVuZ3RoCiAgfQoKICBmdW5jdGlvbiBlbmNvZGUgKG9iaiwgYnVmLCBvZmZzZXQpIHsKICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICBpZiAoIWJ1ZikgYnVmID0gYjRhLmFsbG9jVW5zYWZlKGVuY29kaW5nTGVuZ3RoKG9iaikpCiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICBpZiAoZGVmaW5lZChvYmoubGV2ZWxzKSkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5sZXZlbHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoIWRlZmluZWQob2JqLmxldmVsc1tpXSkpIGNvbnRpbnVlCiAgICAgICAgYnVmW29mZnNldCsrXSA9IDEwCiAgICAgICAgdmFyaW50LmVuY29kZShMZXZlbC5lbmNvZGluZ0xlbmd0aChvYmoubGV2ZWxzW2ldKSwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgICBMZXZlbC5lbmNvZGUob2JqLmxldmVsc1tpXSwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IExldmVsLmVuY29kZS5ieXRlcwogICAgICB9CiAgICB9CiAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgIHJldHVybiBidWYKICB9CgogIGZ1bmN0aW9uIGRlY29kZSAoYnVmLCBvZmZzZXQsIGVuZCkgewogICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgIGlmICghZW5kKSBlbmQgPSBidWYubGVuZ3RoCiAgICBpZiAoIShlbmQgPD0gYnVmLmxlbmd0aCAmJiBvZmZzZXQgPD0gYnVmLmxlbmd0aCkpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICB2YXIgb2JqID0gewogICAgICBsZXZlbHM6IFtdCiAgICB9CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAoZW5kIDw9IG9mZnNldCkgewogICAgICAgIGRlY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICAgIHJldHVybiBvYmoKICAgICAgfQogICAgICB2YXIgcHJlZml4ID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgdmFyIHRhZyA9IHByZWZpeCA+PiAzCiAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgIHZhciBsZW4gPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgb2JqLmxldmVscy5wdXNoKExldmVsLmRlY29kZShidWYsIG9mZnNldCwgb2Zmc2V0ICsgbGVuKSkKICAgICAgICBvZmZzZXQgKz0gTGV2ZWwuZGVjb2RlLmJ5dGVzCiAgICAgICAgYnJlYWsKICAgICAgICBkZWZhdWx0OgogICAgICAgIG9mZnNldCA9IHNraXAocHJlZml4ICYgNywgYnVmLCBvZmZzZXQpCiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGRlZmluZUhlYWRlciAoKSB7CiAgdmFyIE1ldGFkYXRhID0gSGVhZGVyLk1ldGFkYXRhID0gewogICAgYnVmZmVyOiB0cnVlLAogICAgZW5jb2RpbmdMZW5ndGg6IG51bGwsCiAgICBlbmNvZGU6IG51bGwsCiAgICBkZWNvZGU6IG51bGwKICB9CgogIGRlZmluZU1ldGFkYXRhKCkKCiAgZnVuY3Rpb24gZGVmaW5lTWV0YWRhdGEgKCkgewogICAgTWV0YWRhdGEuZW5jb2RpbmdMZW5ndGggPSBlbmNvZGluZ0xlbmd0aAogICAgTWV0YWRhdGEuZW5jb2RlID0gZW5jb2RlCiAgICBNZXRhZGF0YS5kZWNvZGUgPSBkZWNvZGUKCiAgICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAob2JqKSB7CiAgICAgIHZhciBsZW5ndGggPSAwCiAgICAgIGlmIChkZWZpbmVkKG9iai5jb250ZW50RmVlZCkpIHsKICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kaW5nTGVuZ3RoKG9iai5jb250ZW50RmVlZCkKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai51c2VyRGF0YSkpIHsKICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kaW5nTGVuZ3RoKG9iai51c2VyRGF0YSkKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIHJldHVybiBsZW5ndGgKICAgIH0KCiAgICBmdW5jdGlvbiBlbmNvZGUgKG9iaiwgYnVmLCBvZmZzZXQpIHsKICAgICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgICAgaWYgKCFidWYpIGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShlbmNvZGluZ0xlbmd0aChvYmopKQogICAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICAgIGlmIChkZWZpbmVkKG9iai5jb250ZW50RmVlZCkpIHsKICAgICAgICBidWZbb2Zmc2V0KytdID0gMTAKICAgICAgICBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlKG9iai5jb250ZW50RmVlZCwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoudXNlckRhdGEpKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDE4CiAgICAgICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmoudXNlckRhdGEsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgIHJldHVybiBidWYKICAgIH0KCiAgICBmdW5jdGlvbiBkZWNvZGUgKGJ1Ziwgb2Zmc2V0LCBlbmQpIHsKICAgICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgICAgaWYgKCFlbmQpIGVuZCA9IGJ1Zi5sZW5ndGgKICAgICAgaWYgKCEoZW5kIDw9IGJ1Zi5sZW5ndGggJiYgb2Zmc2V0IDw9IGJ1Zi5sZW5ndGgpKSB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgbWVzc2FnZSBpcyBub3QgdmFsaWQiKQogICAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICAgIHZhciBvYmogPSB7CiAgICAgICAgY29udGVudEZlZWQ6IG51bGwsCiAgICAgICAgdXNlckRhdGE6IG51bGwKICAgICAgfQogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGlmIChlbmQgPD0gb2Zmc2V0KSB7CiAgICAgICAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgICAgIHJldHVybiBvYmoKICAgICAgICB9CiAgICAgICAgdmFyIHByZWZpeCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICB2YXIgdGFnID0gcHJlZml4ID4+IDMKICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgb2JqLmNvbnRlbnRGZWVkID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgb2JqLnVzZXJEYXRhID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBicmVhawogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIG9mZnNldCA9IHNraXAocHJlZml4ICYgNywgYnVmLCBvZmZzZXQpCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBIZWFkZXIuZW5jb2RpbmdMZW5ndGggPSBlbmNvZGluZ0xlbmd0aAogIEhlYWRlci5lbmNvZGUgPSBlbmNvZGUKICBIZWFkZXIuZGVjb2RlID0gZGVjb2RlCgogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChvYmopIHsKICAgIHZhciBsZW5ndGggPSAwCiAgICBpZiAoIWRlZmluZWQob2JqLnByb3RvY29sKSkgdGhyb3cgbmV3IEVycm9yKCJwcm90b2NvbCBpcyByZXF1aXJlZCIpCiAgICB2YXIgbGVuID0gZW5jb2RpbmdzLnN0cmluZy5lbmNvZGluZ0xlbmd0aChvYmoucHJvdG9jb2wpCiAgICBsZW5ndGggKz0gMSArIGxlbgogICAgaWYgKGRlZmluZWQob2JqLm1ldGFkYXRhKSkgewogICAgICB2YXIgbGVuID0gTWV0YWRhdGEuZW5jb2RpbmdMZW5ndGgob2JqLm1ldGFkYXRhKQogICAgICBsZW5ndGggKz0gdmFyaW50LmVuY29kaW5nTGVuZ3RoKGxlbikKICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgIH0KICAgIHJldHVybiBsZW5ndGgKICB9CgogIGZ1bmN0aW9uIGVuY29kZSAob2JqLCBidWYsIG9mZnNldCkgewogICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgIGlmICghYnVmKSBidWYgPSBiNGEuYWxsb2NVbnNhZmUoZW5jb2RpbmdMZW5ndGgob2JqKSkKICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgIGlmICghZGVmaW5lZChvYmoucHJvdG9jb2wpKSB0aHJvdyBuZXcgRXJyb3IoInByb3RvY29sIGlzIHJlcXVpcmVkIikKICAgIGJ1ZltvZmZzZXQrK10gPSAxMAogICAgZW5jb2RpbmdzLnN0cmluZy5lbmNvZGUob2JqLnByb3RvY29sLCBidWYsIG9mZnNldCkKICAgIG9mZnNldCArPSBlbmNvZGluZ3Muc3RyaW5nLmVuY29kZS5ieXRlcwogICAgaWYgKGRlZmluZWQob2JqLm1ldGFkYXRhKSkgewogICAgICBidWZbb2Zmc2V0KytdID0gMTgKICAgICAgdmFyaW50LmVuY29kZShNZXRhZGF0YS5lbmNvZGluZ0xlbmd0aChvYmoubWV0YWRhdGEpLCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgTWV0YWRhdGEuZW5jb2RlKG9iai5tZXRhZGF0YSwgYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSBNZXRhZGF0YS5lbmNvZGUuYnl0ZXMKICAgIH0KICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgcmV0dXJuIGJ1ZgogIH0KCiAgZnVuY3Rpb24gZGVjb2RlIChidWYsIG9mZnNldCwgZW5kKSB7CiAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgaWYgKCFlbmQpIGVuZCA9IGJ1Zi5sZW5ndGgKICAgIGlmICghKGVuZCA8PSBidWYubGVuZ3RoICYmIG9mZnNldCA8PSBidWYubGVuZ3RoKSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgIHZhciBvYmogPSB7CiAgICAgIHByb3RvY29sOiAiIiwKICAgICAgbWV0YWRhdGE6IG51bGwKICAgIH0KICAgIHZhciBmb3VuZDAgPSBmYWxzZQogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKGVuZCA8PSBvZmZzZXQpIHsKICAgICAgICBpZiAoIWZvdW5kMCkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgICAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgICByZXR1cm4gb2JqCiAgICAgIH0KICAgICAgdmFyIHByZWZpeCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgIHZhciB0YWcgPSBwcmVmaXggPj4gMwogICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgIGNhc2UgMToKICAgICAgICBvYmoucHJvdG9jb2wgPSBlbmNvZGluZ3Muc3RyaW5nLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnN0cmluZy5kZWNvZGUuYnl0ZXMKICAgICAgICBmb3VuZDAgPSB0cnVlCiAgICAgICAgYnJlYWsKICAgICAgICBjYXNlIDI6CiAgICAgICAgdmFyIGxlbiA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICBvYmoubWV0YWRhdGEgPSBNZXRhZGF0YS5kZWNvZGUoYnVmLCBvZmZzZXQsIG9mZnNldCArIGxlbikKICAgICAgICBvZmZzZXQgKz0gTWV0YWRhdGEuZGVjb2RlLmJ5dGVzCiAgICAgICAgYnJlYWsKICAgICAgICBkZWZhdWx0OgogICAgICAgIG9mZnNldCA9IHNraXAocHJlZml4ICYgNywgYnVmLCBvZmZzZXQpCiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGRlZmluZU5vZGUgKCkgewogIE5vZGUuZW5jb2RpbmdMZW5ndGggPSBlbmNvZGluZ0xlbmd0aAogIE5vZGUuZW5jb2RlID0gZW5jb2RlCiAgTm9kZS5kZWNvZGUgPSBkZWNvZGUKCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKG9iaikgewogICAgdmFyIGxlbmd0aCA9IDAKICAgIGlmICghZGVmaW5lZChvYmouaW5kZXgpKSB0aHJvdyBuZXcgRXJyb3IoImluZGV4IGlzIHJlcXVpcmVkIikKICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLmluZGV4KQogICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgIGlmICghZGVmaW5lZChvYmoua2V5KSkgdGhyb3cgbmV3IEVycm9yKCJrZXkgaXMgcmVxdWlyZWQiKQogICAgdmFyIGxlbiA9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGluZ0xlbmd0aChvYmoua2V5KQogICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgIGlmIChkZWZpbmVkKG9iai52YWx1ZSkpIHsKICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGluZ0xlbmd0aChvYmoudmFsdWUpCiAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICB9CiAgICByZXR1cm4gbGVuZ3RoCiAgfQoKICBmdW5jdGlvbiBlbmNvZGUgKG9iaiwgYnVmLCBvZmZzZXQpIHsKICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICBpZiAoIWJ1ZikgYnVmID0gYjRhLmFsbG9jVW5zYWZlKGVuY29kaW5nTGVuZ3RoKG9iaikpCiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICBpZiAoIWRlZmluZWQob2JqLmluZGV4KSkgdGhyb3cgbmV3IEVycm9yKCJpbmRleCBpcyByZXF1aXJlZCIpCiAgICBidWZbb2Zmc2V0KytdID0gMTAKICAgIGVuY29kaW5ncy5ieXRlcy5lbmNvZGUob2JqLmluZGV4LCBidWYsIG9mZnNldCkKICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlLmJ5dGVzCiAgICBpZiAoIWRlZmluZWQob2JqLmtleSkpIHRocm93IG5ldyBFcnJvcigia2V5IGlzIHJlcXVpcmVkIikKICAgIGJ1ZltvZmZzZXQrK10gPSAxOAogICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmoua2V5LCBidWYsIG9mZnNldCkKICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlLmJ5dGVzCiAgICBpZiAoZGVmaW5lZChvYmoudmFsdWUpKSB7CiAgICAgIGJ1ZltvZmZzZXQrK10gPSAyNgogICAgICBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlKG9iai52YWx1ZSwgYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlLmJ5dGVzCiAgICB9CiAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgIHJldHVybiBidWYKICB9CgogIGZ1bmN0aW9uIGRlY29kZSAoYnVmLCBvZmZzZXQsIGVuZCkgewogICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgIGlmICghZW5kKSBlbmQgPSBidWYubGVuZ3RoCiAgICBpZiAoIShlbmQgPD0gYnVmLmxlbmd0aCAmJiBvZmZzZXQgPD0gYnVmLmxlbmd0aCkpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICB2YXIgb2JqID0gewogICAgICBpbmRleDogbnVsbCwKICAgICAga2V5OiBudWxsLAogICAgICB2YWx1ZTogbnVsbAogICAgfQogICAgdmFyIGZvdW5kMCA9IGZhbHNlCiAgICB2YXIgZm91bmQxID0gZmFsc2UKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmIChlbmQgPD0gb2Zmc2V0KSB7CiAgICAgICAgaWYgKCFmb3VuZDAgfHwgIWZvdW5kMSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgICAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgICByZXR1cm4gb2JqCiAgICAgIH0KICAgICAgdmFyIHByZWZpeCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgIHZhciB0YWcgPSBwcmVmaXggPj4gMwogICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgIGNhc2UgMToKICAgICAgICBvYmouaW5kZXggPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlLmJ5dGVzCiAgICAgICAgZm91bmQwID0gdHJ1ZQogICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAyOgogICAgICAgIG9iai5rZXkgPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlLmJ5dGVzCiAgICAgICAgZm91bmQxID0gdHJ1ZQogICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAzOgogICAgICAgIG9iai52YWx1ZSA9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUuYnl0ZXMKICAgICAgICBicmVhawogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgb2Zmc2V0ID0gc2tpcChwcmVmaXggJiA3LCBidWYsIG9mZnNldCkKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gZGVmaW5lRXh0ZW5zaW9uICgpIHsKICB2YXIgR2V0ID0gRXh0ZW5zaW9uLkdldCA9IHsKICAgIGJ1ZmZlcjogdHJ1ZSwKICAgIGVuY29kaW5nTGVuZ3RoOiBudWxsLAogICAgZW5jb2RlOiBudWxsLAogICAgZGVjb2RlOiBudWxsCiAgfQoKICB2YXIgSXRlcmF0b3IgPSBFeHRlbnNpb24uSXRlcmF0b3IgPSB7CiAgICBidWZmZXI6IHRydWUsCiAgICBlbmNvZGluZ0xlbmd0aDogbnVsbCwKICAgIGVuY29kZTogbnVsbCwKICAgIGRlY29kZTogbnVsbAogIH0KCiAgdmFyIENhY2hlID0gRXh0ZW5zaW9uLkNhY2hlID0gewogICAgYnVmZmVyOiB0cnVlLAogICAgZW5jb2RpbmdMZW5ndGg6IG51bGwsCiAgICBlbmNvZGU6IG51bGwsCiAgICBkZWNvZGU6IG51bGwKICB9CgogIGRlZmluZUdldCgpCiAgZGVmaW5lSXRlcmF0b3IoKQogIGRlZmluZUNhY2hlKCkKCiAgZnVuY3Rpb24gZGVmaW5lR2V0ICgpIHsKICAgIEdldC5lbmNvZGluZ0xlbmd0aCA9IGVuY29kaW5nTGVuZ3RoCiAgICBHZXQuZW5jb2RlID0gZW5jb2RlCiAgICBHZXQuZGVjb2RlID0gZGVjb2RlCgogICAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKG9iaikgewogICAgICB2YXIgbGVuZ3RoID0gMAogICAgICBpZiAoZGVmaW5lZChvYmoudmVyc2lvbikpIHsKICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGluZ0xlbmd0aChvYmoudmVyc2lvbikKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5rZXkpKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGluZ0xlbmd0aChvYmoua2V5KQogICAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIH0KICAgICAgcmV0dXJuIGxlbmd0aAogICAgfQoKICAgIGZ1bmN0aW9uIGVuY29kZSAob2JqLCBidWYsIG9mZnNldCkgewogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgICBpZiAoIWJ1ZikgYnVmID0gYjRhLmFsbG9jVW5zYWZlKGVuY29kaW5nTGVuZ3RoKG9iaikpCiAgICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgICAgaWYgKGRlZmluZWQob2JqLnZlcnNpb24pKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDgKICAgICAgICBlbmNvZGluZ3MudmFyaW50LmVuY29kZShvYmoudmVyc2lvbiwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmtleSkpIHsKICAgICAgICBidWZbb2Zmc2V0KytdID0gMTgKICAgICAgICBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlKG9iai5rZXksIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgIHJldHVybiBidWYKICAgIH0KCiAgICBmdW5jdGlvbiBkZWNvZGUgKGJ1Ziwgb2Zmc2V0LCBlbmQpIHsKICAgICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgICAgaWYgKCFlbmQpIGVuZCA9IGJ1Zi5sZW5ndGgKICAgICAgaWYgKCEoZW5kIDw9IGJ1Zi5sZW5ndGggJiYgb2Zmc2V0IDw9IGJ1Zi5sZW5ndGgpKSB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgbWVzc2FnZSBpcyBub3QgdmFsaWQiKQogICAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICAgIHZhciBvYmogPSB7CiAgICAgICAgdmVyc2lvbjogMCwKICAgICAgICBrZXk6IG51bGwKICAgICAgfQogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGlmIChlbmQgPD0gb2Zmc2V0KSB7CiAgICAgICAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgICAgIHJldHVybiBvYmoKICAgICAgICB9CiAgICAgICAgdmFyIHByZWZpeCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICB2YXIgdGFnID0gcHJlZml4ID4+IDMKICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgb2JqLnZlcnNpb24gPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgIG9iai5rZXkgPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgb2Zmc2V0ID0gc2tpcChwcmVmaXggJiA3LCBidWYsIG9mZnNldCkKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGRlZmluZUl0ZXJhdG9yICgpIHsKICAgIEl0ZXJhdG9yLmVuY29kaW5nTGVuZ3RoID0gZW5jb2RpbmdMZW5ndGgKICAgIEl0ZXJhdG9yLmVuY29kZSA9IGVuY29kZQogICAgSXRlcmF0b3IuZGVjb2RlID0gZGVjb2RlCgogICAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKG9iaikgewogICAgICB2YXIgbGVuZ3RoID0gMAogICAgICBpZiAoZGVmaW5lZChvYmoudmVyc2lvbikpIHsKICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGluZ0xlbmd0aChvYmoudmVyc2lvbikKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5ndGUpKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGluZ0xlbmd0aChvYmouZ3RlKQogICAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmd0KSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLmd0KQogICAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmx0ZSkpIHsKICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kaW5nTGVuZ3RoKG9iai5sdGUpCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoubHQpKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGluZ0xlbmd0aChvYmoubHQpCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoubGltaXQpKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLmxpbWl0KQogICAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLnJldmVyc2UpKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy5ib29sLmVuY29kaW5nTGVuZ3RoKG9iai5yZXZlcnNlKQogICAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmNoZWNrcG9pbnQpKSB7CiAgICAgICAgdmFyIHBhY2tlZExlbiA9IDAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5jaGVja3BvaW50Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmNoZWNrcG9pbnRbaV0pKSBjb250aW51ZQogICAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLmNoZWNrcG9pbnRbaV0pCiAgICAgICAgICBwYWNrZWRMZW4gKz0gbGVuCiAgICAgICAgfQogICAgICAgIGlmIChwYWNrZWRMZW4pIHsKICAgICAgICAgIGxlbmd0aCArPSAxICsgcGFja2VkTGVuICsgdmFyaW50LmVuY29kaW5nTGVuZ3RoKHBhY2tlZExlbikKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGxlbmd0aAogICAgfQoKICAgIGZ1bmN0aW9uIGVuY29kZSAob2JqLCBidWYsIG9mZnNldCkgewogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgICBpZiAoIWJ1ZikgYnVmID0gYjRhLmFsbG9jVW5zYWZlKGVuY29kaW5nTGVuZ3RoKG9iaikpCiAgICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgICAgaWYgKGRlZmluZWQob2JqLnZlcnNpb24pKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDgKICAgICAgICBlbmNvZGluZ3MudmFyaW50LmVuY29kZShvYmoudmVyc2lvbiwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmd0ZSkpIHsKICAgICAgICBidWZbb2Zmc2V0KytdID0gMTgKICAgICAgICBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlKG9iai5ndGUsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmd0KSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSAyNgogICAgICAgIGVuY29kaW5ncy5ieXRlcy5lbmNvZGUob2JqLmd0LCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5sdGUpKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDM0CiAgICAgICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmoubHRlLCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5sdCkpIHsKICAgICAgICBidWZbb2Zmc2V0KytdID0gNDIKICAgICAgICBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlKG9iai5sdCwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoubGltaXQpKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDQ4CiAgICAgICAgZW5jb2RpbmdzLnZhcmludC5lbmNvZGUob2JqLmxpbWl0LCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoucmV2ZXJzZSkpIHsKICAgICAgICBidWZbb2Zmc2V0KytdID0gNTYKICAgICAgICBlbmNvZGluZ3MuYm9vbC5lbmNvZGUob2JqLnJldmVyc2UsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYm9vbC5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmouY2hlY2twb2ludCkpIHsKICAgICAgICB2YXIgcGFja2VkTGVuID0gMAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmNoZWNrcG9pbnQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmouY2hlY2twb2ludFtpXSkpIGNvbnRpbnVlCiAgICAgICAgICBwYWNrZWRMZW4gKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGluZ0xlbmd0aChvYmouY2hlY2twb2ludFtpXSkKICAgICAgICB9CiAgICAgICAgaWYgKHBhY2tlZExlbikgewogICAgICAgICAgYnVmW29mZnNldCsrXSA9IDY2CiAgICAgICAgICB2YXJpbnQuZW5jb2RlKHBhY2tlZExlbiwgYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5jaGVja3BvaW50Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmNoZWNrcG9pbnRbaV0pKSBjb250aW51ZQogICAgICAgICAgZW5jb2RpbmdzLnZhcmludC5lbmNvZGUob2JqLmNoZWNrcG9pbnRbaV0sIGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgICAgfQogICAgICB9CiAgICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICByZXR1cm4gYnVmCiAgICB9CgogICAgZnVuY3Rpb24gZGVjb2RlIChidWYsIG9mZnNldCwgZW5kKSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghZW5kKSBlbmQgPSBidWYubGVuZ3RoCiAgICAgIGlmICghKGVuZCA8PSBidWYubGVuZ3RoICYmIG9mZnNldCA8PSBidWYubGVuZ3RoKSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICB2YXIgb2JqID0gewogICAgICAgIHZlcnNpb246IDAsCiAgICAgICAgZ3RlOiBudWxsLAogICAgICAgIGd0OiBudWxsLAogICAgICAgIGx0ZTogbnVsbCwKICAgICAgICBsdDogbnVsbCwKICAgICAgICBsaW1pdDogMCwKICAgICAgICByZXZlcnNlOiBmYWxzZSwKICAgICAgICBjaGVja3BvaW50OiBbXQogICAgICB9CiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgaWYgKGVuZCA8PSBvZmZzZXQpIHsKICAgICAgICAgIGRlY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICAgICAgcmV0dXJuIG9iagogICAgICAgIH0KICAgICAgICB2YXIgcHJlZml4ID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIHZhciB0YWcgPSBwcmVmaXggPj4gMwogICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICBvYmoudmVyc2lvbiA9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgb2JqLmd0ZSA9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZS5ieXRlcwogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgIG9iai5ndCA9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZS5ieXRlcwogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgIG9iai5sdGUgPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICBvYmoubHQgPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICBvYmoubGltaXQgPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgIG9iai5yZXZlcnNlID0gZW5jb2RpbmdzLmJvb2wuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ib29sLmRlY29kZS5ieXRlcwogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgODoKICAgICAgICAgIHZhciBwYWNrZWRFbmQgPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIHBhY2tlZEVuZCArPSBvZmZzZXQKICAgICAgICAgIHdoaWxlIChvZmZzZXQgPCBwYWNrZWRFbmQpIHsKICAgICAgICAgICAgb2JqLmNoZWNrcG9pbnQucHVzaChlbmNvZGluZ3MudmFyaW50LmRlY29kZShidWYsIG9mZnNldCkpCiAgICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgfQogICAgICAgICAgYnJlYWsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBvZmZzZXQgPSBza2lwKHByZWZpeCAmIDcsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZGVmaW5lQ2FjaGUgKCkgewogICAgQ2FjaGUuZW5jb2RpbmdMZW5ndGggPSBlbmNvZGluZ0xlbmd0aAogICAgQ2FjaGUuZW5jb2RlID0gZW5jb2RlCiAgICBDYWNoZS5kZWNvZGUgPSBkZWNvZGUKCiAgICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAob2JqKSB7CiAgICAgIHZhciBsZW5ndGggPSAwCiAgICAgIGlmICghZGVmaW5lZChvYmouc3RhcnQpKSB0aHJvdyBuZXcgRXJyb3IoInN0YXJ0IGlzIHJlcXVpcmVkIikKICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLnN0YXJ0KQogICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICBpZiAoIWRlZmluZWQob2JqLmVuZCkpIHRocm93IG5ldyBFcnJvcigiZW5kIGlzIHJlcXVpcmVkIikKICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLmVuZCkKICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgaWYgKGRlZmluZWQob2JqLmJsb2NrcykpIHsKICAgICAgICB2YXIgcGFja2VkTGVuID0gMAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmJsb2Nrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5ibG9ja3NbaV0pKSBjb250aW51ZQogICAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLmJsb2Nrc1tpXSkKICAgICAgICAgIHBhY2tlZExlbiArPSBsZW4KICAgICAgICB9CiAgICAgICAgaWYgKHBhY2tlZExlbikgewogICAgICAgICAgbGVuZ3RoICs9IDEgKyBwYWNrZWRMZW4gKyB2YXJpbnQuZW5jb2RpbmdMZW5ndGgocGFja2VkTGVuKQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbGVuZ3RoCiAgICB9CgogICAgZnVuY3Rpb24gZW5jb2RlIChvYmosIGJ1Ziwgb2Zmc2V0KSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghYnVmKSBidWYgPSBiNGEuYWxsb2NVbnNhZmUoZW5jb2RpbmdMZW5ndGgob2JqKSkKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICBpZiAoIWRlZmluZWQob2JqLnN0YXJ0KSkgdGhyb3cgbmV3IEVycm9yKCJzdGFydCBpcyByZXF1aXJlZCIpCiAgICAgIGJ1ZltvZmZzZXQrK10gPSA4CiAgICAgIGVuY29kaW5ncy52YXJpbnQuZW5jb2RlKG9iai5zdGFydCwgYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kZS5ieXRlcwogICAgICBpZiAoIWRlZmluZWQob2JqLmVuZCkpIHRocm93IG5ldyBFcnJvcigiZW5kIGlzIHJlcXVpcmVkIikKICAgICAgYnVmW29mZnNldCsrXSA9IDE2CiAgICAgIGVuY29kaW5ncy52YXJpbnQuZW5jb2RlKG9iai5lbmQsIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgaWYgKGRlZmluZWQob2JqLmJsb2NrcykpIHsKICAgICAgICB2YXIgcGFja2VkTGVuID0gMAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmJsb2Nrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5ibG9ja3NbaV0pKSBjb250aW51ZQogICAgICAgICAgcGFja2VkTGVuICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLmJsb2Nrc1tpXSkKICAgICAgICB9CiAgICAgICAgaWYgKHBhY2tlZExlbikgewogICAgICAgICAgYnVmW29mZnNldCsrXSA9IDI2CiAgICAgICAgICB2YXJpbnQuZW5jb2RlKHBhY2tlZExlbiwgYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5ibG9ja3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmouYmxvY2tzW2ldKSkgY29udGludWUKICAgICAgICAgIGVuY29kaW5ncy52YXJpbnQuZW5jb2RlKG9iai5ibG9ja3NbaV0sIGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgICAgfQogICAgICB9CiAgICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICByZXR1cm4gYnVmCiAgICB9CgogICAgZnVuY3Rpb24gZGVjb2RlIChidWYsIG9mZnNldCwgZW5kKSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghZW5kKSBlbmQgPSBidWYubGVuZ3RoCiAgICAgIGlmICghKGVuZCA8PSBidWYubGVuZ3RoICYmIG9mZnNldCA8PSBidWYubGVuZ3RoKSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICB2YXIgb2JqID0gewogICAgICAgIHN0YXJ0OiAwLAogICAgICAgIGVuZDogMCwKICAgICAgICBibG9ja3M6IFtdCiAgICAgIH0KICAgICAgdmFyIGZvdW5kMCA9IGZhbHNlCiAgICAgIHZhciBmb3VuZDEgPSBmYWxzZQogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGlmIChlbmQgPD0gb2Zmc2V0KSB7CiAgICAgICAgICBpZiAoIWZvdW5kMCB8fCAhZm91bmQxKSB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgbWVzc2FnZSBpcyBub3QgdmFsaWQiKQogICAgICAgICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgICAgICByZXR1cm4gb2JqCiAgICAgICAgfQogICAgICAgIHZhciBwcmVmaXggPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgdmFyIHRhZyA9IHByZWZpeCA+PiAzCiAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgIG9iai5zdGFydCA9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBmb3VuZDAgPSB0cnVlCiAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgb2JqLmVuZCA9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBmb3VuZDEgPSB0cnVlCiAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgdmFyIHBhY2tlZEVuZCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgcGFja2VkRW5kICs9IG9mZnNldAogICAgICAgICAgd2hpbGUgKG9mZnNldCA8IHBhY2tlZEVuZCkgewogICAgICAgICAgICBvYmouYmxvY2tzLnB1c2goZW5jb2RpbmdzLnZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpKQogICAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgb2Zmc2V0ID0gc2tpcChwcmVmaXggJiA3LCBidWYsIG9mZnNldCkKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIEV4dGVuc2lvbi5lbmNvZGluZ0xlbmd0aCA9IGVuY29kaW5nTGVuZ3RoCiAgRXh0ZW5zaW9uLmVuY29kZSA9IGVuY29kZQogIEV4dGVuc2lvbi5kZWNvZGUgPSBkZWNvZGUKCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKG9iaikgewogICAgdmFyIGxlbmd0aCA9IDAKICAgIGlmIChkZWZpbmVkKG9iai5jYWNoZSkpIHsKICAgICAgdmFyIGxlbiA9IENhY2hlLmVuY29kaW5nTGVuZ3RoKG9iai5jYWNoZSkKICAgICAgbGVuZ3RoICs9IHZhcmludC5lbmNvZGluZ0xlbmd0aChsZW4pCiAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICB9CiAgICBpZiAoZGVmaW5lZChvYmouZ2V0KSkgewogICAgICB2YXIgbGVuID0gR2V0LmVuY29kaW5nTGVuZ3RoKG9iai5nZXQpCiAgICAgIGxlbmd0aCArPSB2YXJpbnQuZW5jb2RpbmdMZW5ndGgobGVuKQogICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgfQogICAgaWYgKGRlZmluZWQob2JqLml0ZXJhdG9yKSkgewogICAgICB2YXIgbGVuID0gSXRlcmF0b3IuZW5jb2RpbmdMZW5ndGgob2JqLml0ZXJhdG9yKQogICAgICBsZW5ndGggKz0gdmFyaW50LmVuY29kaW5nTGVuZ3RoKGxlbikKICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgIH0KICAgIHJldHVybiBsZW5ndGgKICB9CgogIGZ1bmN0aW9uIGVuY29kZSAob2JqLCBidWYsIG9mZnNldCkgewogICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgIGlmICghYnVmKSBidWYgPSBiNGEuYWxsb2NVbnNhZmUoZW5jb2RpbmdMZW5ndGgob2JqKSkKICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgIGlmIChkZWZpbmVkKG9iai5jYWNoZSkpIHsKICAgICAgYnVmW29mZnNldCsrXSA9IDEwCiAgICAgIHZhcmludC5lbmNvZGUoQ2FjaGUuZW5jb2RpbmdMZW5ndGgob2JqLmNhY2hlKSwgYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgIENhY2hlLmVuY29kZShvYmouY2FjaGUsIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gQ2FjaGUuZW5jb2RlLmJ5dGVzCiAgICB9CiAgICBpZiAoZGVmaW5lZChvYmouZ2V0KSkgewogICAgICBidWZbb2Zmc2V0KytdID0gMTgKICAgICAgdmFyaW50LmVuY29kZShHZXQuZW5jb2RpbmdMZW5ndGgob2JqLmdldCksIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgICBHZXQuZW5jb2RlKG9iai5nZXQsIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gR2V0LmVuY29kZS5ieXRlcwogICAgfQogICAgaWYgKGRlZmluZWQob2JqLml0ZXJhdG9yKSkgewogICAgICBidWZbb2Zmc2V0KytdID0gMjYKICAgICAgdmFyaW50LmVuY29kZShJdGVyYXRvci5lbmNvZGluZ0xlbmd0aChvYmouaXRlcmF0b3IpLCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgSXRlcmF0b3IuZW5jb2RlKG9iai5pdGVyYXRvciwgYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSBJdGVyYXRvci5lbmNvZGUuYnl0ZXMKICAgIH0KICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgcmV0dXJuIGJ1ZgogIH0KCiAgZnVuY3Rpb24gZGVjb2RlIChidWYsIG9mZnNldCwgZW5kKSB7CiAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgaWYgKCFlbmQpIGVuZCA9IGJ1Zi5sZW5ndGgKICAgIGlmICghKGVuZCA8PSBidWYubGVuZ3RoICYmIG9mZnNldCA8PSBidWYubGVuZ3RoKSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgIHZhciBvYmogPSB7CiAgICAgIGNhY2hlOiBudWxsLAogICAgICBnZXQ6IG51bGwsCiAgICAgIGl0ZXJhdG9yOiBudWxsCiAgICB9CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAoZW5kIDw9IG9mZnNldCkgewogICAgICAgIGRlY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICAgIHJldHVybiBvYmoKICAgICAgfQogICAgICB2YXIgcHJlZml4ID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgdmFyIHRhZyA9IHByZWZpeCA+PiAzCiAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgIHZhciBsZW4gPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgb2JqLmNhY2hlID0gQ2FjaGUuZGVjb2RlKGJ1Ziwgb2Zmc2V0LCBvZmZzZXQgKyBsZW4pCiAgICAgICAgb2Zmc2V0ICs9IENhY2hlLmRlY29kZS5ieXRlcwogICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAyOgogICAgICAgIHZhciBsZW4gPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgb2JqLmdldCA9IEdldC5kZWNvZGUoYnVmLCBvZmZzZXQsIG9mZnNldCArIGxlbikKICAgICAgICBvZmZzZXQgKz0gR2V0LmRlY29kZS5ieXRlcwogICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAzOgogICAgICAgIHZhciBsZW4gPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgb2JqLml0ZXJhdG9yID0gSXRlcmF0b3IuZGVjb2RlKGJ1Ziwgb2Zmc2V0LCBvZmZzZXQgKyBsZW4pCiAgICAgICAgb2Zmc2V0ICs9IEl0ZXJhdG9yLmRlY29kZS5ieXRlcwogICAgICAgIGJyZWFrCiAgICAgICAgZGVmYXVsdDoKICAgICAgICBvZmZzZXQgPSBza2lwKHByZWZpeCAmIDcsIGJ1Ziwgb2Zmc2V0KQogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBkZWZpbmVkICh2YWwpIHsKICByZXR1cm4gdmFsICE9PSBudWxsICYmIHZhbCAhPT0gdW5kZWZpbmVkICYmICh0eXBlb2YgdmFsICE9PSAnbnVtYmVyJyB8fCAhaXNOYU4odmFsKSkKfQp7CiAgIm5hbWUiOiAiaHlwZXJiZWUiLAogICJ2ZXJzaW9uIjogIjIuMjYuNSIsCiAgImRlc2NyaXB0aW9uIjogIkFuIGFwcGVuZC1vbmx5IEItdHJlZSBydW5uaW5nIG9uIGEgSHlwZXJjb3JlLiIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibGliLyoqLmpzIiwKICAgICJpdGVyYXRvcnMvKiouanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjAiLAogICAgImNvZGVjcyI6ICJeMy4wLjAiLAogICAgImRlYm91bmNlaWZ5IjogIl4xLjAuMCIsCiAgICAiaHlwZXJjb3JlLWVycm9ycyI6ICJeMS4wLjAiLAogICAgIm11dGV4aWZ5IjogIl4xLjQuMCIsCiAgICAicHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MiOiAiXjEuMi4wIiwKICAgICJyYWNoZSI6ICJeMS4wLjAiLAogICAgInJlYWR5LXJlc291cmNlIjogIl4xLjAuMCIsCiAgICAicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6ICJeMS4xLjAiLAogICAgInNhZmV0eS1jYXRjaCI6ICJeMS4wLjIiLAogICAgInN0cmVhbXgiOiAiXjIuMTIuNCIsCiAgICAidW5zbGFiIjogIl4xLjIuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4xLjAiLAogICAgImh5cGVyY29yZSI6ICJeMTEuMC4wIiwKICAgICJwcm90b2NvbC1idWZmZXJzIjogIl40LjIuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIsCiAgICAic3ViLWVuY29kZXIiOiAiXjEuMC42IiwKICAgICJ0cmVlLXRvLXN0cmluZyI6ICJeMS4xLjEiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC8qLmpzIiwKICAgICJwcm90b2J1ZiI6ICJwcm90b2NvbC1idWZmZXJzIHNjaGVtYS5wcm90byAtbyAuL2xpYi9tZXNzYWdlcy5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyYmVlLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyYmVlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJiZWUiCn0KY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCi8vIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL01lcmtsZV90cmVlI1NlY29uZF9wcmVpbWFnZV9hdHRhY2sKY29uc3QgTEVBRl9UWVBFID0gYjRhLmZyb20oWzBdKQpjb25zdCBQQVJFTlRfVFlQRSA9IGI0YS5mcm9tKFsxXSkKY29uc3QgUk9PVF9UWVBFID0gYjRhLmZyb20oWzJdKQoKY29uc3QgSFlQRVJDT1JFID0gYjRhLmZyb20oJ2h5cGVyY29yZScpCgpleHBvcnRzLmtleVBhaXIgPSBmdW5jdGlvbiAoc2VlZCkgewogIC8vIGtleSBwYWlycyBtaWdodCBzdGF5IGFyb3VuZCBmb3IgYSB3aGlsZSwgc28gYmV0dGVyIG5vdCB0byB1c2UgYSBkZWZhdWx0IHNsYWIgdG8gYXZvaWQgcmV0YWluaW5nIGl0IGNvbXBsZXRlbHkKICBjb25zdCBzbGFiID0gYjRhLmFsbG9jVW5zYWZlU2xvdyhzb2RpdW0uY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMgKyBzb2RpdW0uY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMpCiAgY29uc3QgcHVibGljS2V5ID0gc2xhYi5zdWJhcnJheSgwLCBzb2RpdW0uY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgY29uc3Qgc2VjcmV0S2V5ID0gc2xhYi5zdWJhcnJheShzb2RpdW0uY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCgogIGlmIChzZWVkKSBzb2RpdW0uY3J5cHRvX3NpZ25fc2VlZF9rZXlwYWlyKHB1YmxpY0tleSwgc2VjcmV0S2V5LCBzZWVkKQogIGVsc2Ugc29kaXVtLmNyeXB0b19zaWduX2tleXBhaXIocHVibGljS2V5LCBzZWNyZXRLZXkpCgogIHJldHVybiB7CiAgICBwdWJsaWNLZXksCiAgICBzZWNyZXRLZXkKICB9Cn0KCmV4cG9ydHMudmFsaWRhdGVLZXlQYWlyID0gZnVuY3Rpb24gKGtleVBhaXIpIHsKICBjb25zdCBwayA9IGI0YS5hbGxvY1Vuc2FmZShzb2RpdW0uY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgc29kaXVtLmNyeXB0b19zaWduX2VkMjU1MTlfc2tfdG9fcGsocGssIGtleVBhaXIuc2VjcmV0S2V5KQogIHJldHVybiBiNGEuZXF1YWxzKHBrLCBrZXlQYWlyLnB1YmxpY0tleSkKfQoKZXhwb3J0cy5zaWduID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHNlY3JldEtleSkgewogIC8vIERlZGljYXRlZCBzbGFiIGZvciB0aGUgc2lnbmF0dXJlLCB0byBhdm9pZCByZXRhaW5pbmcgdW5uZWVkZWQgbWVtIGFuZCBmb3Igc2VjdXJpdHkKICBjb25zdCBzaWduYXR1cmUgPSBiNGEuYWxsb2NVbnNhZmVTbG93KHNvZGl1bS5jcnlwdG9fc2lnbl9CWVRFUykKICBzb2RpdW0uY3J5cHRvX3NpZ25fZGV0YWNoZWQoc2lnbmF0dXJlLCBtZXNzYWdlLCBzZWNyZXRLZXkpCiAgcmV0dXJuIHNpZ25hdHVyZQp9CgpleHBvcnRzLnZlcmlmeSA9IGZ1bmN0aW9uIChtZXNzYWdlLCBzaWduYXR1cmUsIHB1YmxpY0tleSkgewogIGlmIChzaWduYXR1cmUuYnl0ZUxlbmd0aCAhPT0gc29kaXVtLmNyeXB0b19zaWduX0JZVEVTKSByZXR1cm4gZmFsc2UKICBpZiAocHVibGljS2V5LmJ5dGVMZW5ndGggIT09IHNvZGl1bS5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykgcmV0dXJuIGZhbHNlCiAgcmV0dXJuIHNvZGl1bS5jcnlwdG9fc2lnbl92ZXJpZnlfZGV0YWNoZWQoc2lnbmF0dXJlLCBtZXNzYWdlLCBwdWJsaWNLZXkpCn0KCmV4cG9ydHMuZW5jcnlwdCA9IGZ1bmN0aW9uIChtZXNzYWdlLCBwdWJsaWNLZXkpIHsKICBjb25zdCBjaXBoZXJ0ZXh0ID0gYjRhLmFsbG9jKG1lc3NhZ2UuYnl0ZUxlbmd0aCArIHNvZGl1bS5jcnlwdG9fYm94X1NFQUxCWVRFUykKICBzb2RpdW0uY3J5cHRvX2JveF9zZWFsKGNpcGhlcnRleHQsIG1lc3NhZ2UsIHB1YmxpY0tleSkKICByZXR1cm4gY2lwaGVydGV4dAp9CgpleHBvcnRzLmRlY3J5cHQgPSBmdW5jdGlvbiAoY2lwaGVydGV4dCwga2V5UGFpcikgewogIGlmIChjaXBoZXJ0ZXh0LmJ5dGVMZW5ndGggPCBzb2RpdW0uY3J5cHRvX2JveF9TRUFMQllURVMpIHJldHVybiBudWxsCgogIGNvbnN0IHBsYWludGV4dCA9IGI0YS5hbGxvYyhjaXBoZXJ0ZXh0LmJ5dGVMZW5ndGggLSBzb2RpdW0uY3J5cHRvX2JveF9TRUFMQllURVMpCgogIGlmICghc29kaXVtLmNyeXB0b19ib3hfc2VhbF9vcGVuKHBsYWludGV4dCwgY2lwaGVydGV4dCwga2V5UGFpci5wdWJsaWNLZXksIGtleVBhaXIuc2VjcmV0S2V5KSkgewogICAgcmV0dXJuIG51bGwKICB9CgogIHJldHVybiBwbGFpbnRleHQKfQoKZXhwb3J0cy5lbmNyeXB0aW9uS2V5UGFpciA9IGZ1bmN0aW9uIChzZWVkKSB7CiAgY29uc3QgcHVibGljS2V5ID0gYjRhLmFsbG9jKHNvZGl1bS5jcnlwdG9fYm94X1BVQkxJQ0tFWUJZVEVTKQogIGNvbnN0IHNlY3JldEtleSA9IGI0YS5hbGxvYyhzb2RpdW0uY3J5cHRvX2JveF9TRUNSRVRLRVlCWVRFUykKCiAgaWYgKHNlZWQpIHsKICAgIHNvZGl1bS5jcnlwdG9fYm94X3NlZWRfa2V5cGFpcihwdWJsaWNLZXksIHNlY3JldEtleSwgc2VlZCkKICB9IGVsc2UgewogICAgc29kaXVtLmNyeXB0b19ib3hfa2V5cGFpcihwdWJsaWNLZXksIHNlY3JldEtleSkKICB9CgogIHJldHVybiB7CiAgICBwdWJsaWNLZXksCiAgICBzZWNyZXRLZXkKICB9Cn0KCmV4cG9ydHMuZGF0YSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgY29uc3Qgb3V0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKQoKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKG91dCwgWwogICAgTEVBRl9UWVBFLAogICAgYy5lbmNvZGUoYy51aW50NjQsIGRhdGEuYnl0ZUxlbmd0aCksCiAgICBkYXRhCiAgXSkKCiAgcmV0dXJuIG91dAp9CgpleHBvcnRzLnBhcmVudCA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgaWYgKGEuaW5kZXggPiBiLmluZGV4KSB7CiAgICBjb25zdCB0bXAgPSBhCiAgICBhID0gYgogICAgYiA9IHRtcAogIH0KCiAgY29uc3Qgb3V0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKQoKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKG91dCwgWwogICAgUEFSRU5UX1RZUEUsCiAgICBjLmVuY29kZShjLnVpbnQ2NCwgYS5zaXplICsgYi5zaXplKSwKICAgIGEuaGFzaCwKICAgIGIuaGFzaAogIF0pCgogIHJldHVybiBvdXQKfQoKZXhwb3J0cy50cmVlID0gZnVuY3Rpb24gKHJvb3RzLCBvdXQpIHsKICBjb25zdCBidWZmZXJzID0gbmV3IEFycmF5KDMgKiByb290cy5sZW5ndGggKyAxKQogIGxldCBqID0gMAoKICBidWZmZXJzW2orK10gPSBST09UX1RZUEUKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCByb290cy5sZW5ndGg7IGkrKykgewogICAgY29uc3QgciA9IHJvb3RzW2ldCiAgICBidWZmZXJzW2orK10gPSByLmhhc2gKICAgIGJ1ZmZlcnNbaisrXSA9IGMuZW5jb2RlKGMudWludDY0LCByLmluZGV4KQogICAgYnVmZmVyc1tqKytdID0gYy5lbmNvZGUoYy51aW50NjQsIHIuc2l6ZSkKICB9CgogIGlmICghb3V0KSBvdXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChvdXQsIGJ1ZmZlcnMpCiAgcmV0dXJuIG91dAp9CgpleHBvcnRzLmhhc2ggPSBmdW5jdGlvbiAoZGF0YSwgb3V0KSB7CiAgaWYgKCFvdXQpIG91dCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKICBpZiAoIUFycmF5LmlzQXJyYXkoZGF0YSkpIGRhdGEgPSBbZGF0YV0KCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChvdXQsIGRhdGEpCgogIHJldHVybiBvdXQKfQoKZXhwb3J0cy5yYW5kb21CeXRlcyA9IGZ1bmN0aW9uIChuKSB7CiAgY29uc3QgYnVmID0gYjRhLmFsbG9jVW5zYWZlKG4pCiAgc29kaXVtLnJhbmRvbWJ5dGVzX2J1ZihidWYpCiAgcmV0dXJuIGJ1Zgp9CgpleHBvcnRzLmRpc2NvdmVyeUtleSA9IGZ1bmN0aW9uIChrZXkpIHsKICBpZiAoIWtleSB8fCBrZXkuYnl0ZUxlbmd0aCAhPT0gMzIpIHRocm93IG5ldyBFcnJvcignTXVzdCBwYXNzIGEgMzIgYnl0ZSBidWZmZXInKQogIC8vIERpc2NvdmVyeSBrZXlzIG1pZ2h0IHN0YXkgYXJvdW5kIGZvciBhIHdoaWxlLCBzbyBiZXR0ZXIgbm90IHRvIHVzZSBzbGFiIG1lbW9yeSAoZm9yIGJldHRlciBnYykKICBjb25zdCBkaWdlc3QgPSBiNGEuYWxsb2NVbnNhZmVTbG93KDMyKQogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goZGlnZXN0LCBIWVBFUkNPUkUsIGtleSkKICByZXR1cm4gZGlnZXN0Cn0KCmlmIChzb2RpdW0uc29kaXVtX2ZyZWUpIHsKICBleHBvcnRzLmZyZWUgPSBmdW5jdGlvbiAoc2VjdXJlQnVmKSB7CiAgICBpZiAoc2VjdXJlQnVmLnNlY3VyZSkgc29kaXVtLnNvZGl1bV9mcmVlKHNlY3VyZUJ1ZikKICB9Cn0gZWxzZSB7CiAgZXhwb3J0cy5mcmVlID0gZnVuY3Rpb24gKCkge30KfQoKZXhwb3J0cy5uYW1lc3BhY2UgPSBmdW5jdGlvbiAobmFtZSwgY291bnQpIHsKICBjb25zdCBpZHMgPSB0eXBlb2YgY291bnQgPT09ICdudW1iZXInID8gcmFuZ2UoY291bnQpIDogY291bnQKCiAgLy8gTmFtZXNwYWNlcyBhcmUgbG9uZy1saXZlZCwgc28gYmV0dGVyIHRvIHVzZSBhIGRlZGljYXRlZCBzbGFiCiAgY29uc3QgYnVmID0gYjRhLmFsbG9jVW5zYWZlU2xvdygzMiAqIGlkcy5sZW5ndGgpCgogIGNvbnN0IGxpc3QgPSBuZXcgQXJyYXkoaWRzLmxlbmd0aCkKCiAgLy8gbnMgaXMgZW1oZW1lcmFsLCBzbyBkZWZhdWx0IHNsYWIKICBjb25zdCBucyA9IGI0YS5hbGxvY1Vuc2FmZSgzMykKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKG5zLnN1YmFycmF5KDAsIDMyKSwgdHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnID8gYjRhLmZyb20obmFtZSkgOiBuYW1lKQoKICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgIGxpc3RbaV0gPSBidWYuc3ViYXJyYXkoMzIgKiBpLCAzMiAqIGkgKyAzMikKICAgIG5zWzMyXSA9IGlkc1tpXQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChsaXN0W2ldLCBucykKICB9CgogIHJldHVybiBsaXN0Cn0KCmZ1bmN0aW9uIHJhbmdlIChjb3VudCkgewogIGNvbnN0IGFyciA9IG5ldyBBcnJheShjb3VudCkKICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIGFycltpXSA9IGkKICByZXR1cm4gYXJyCn0KewogICJuYW1lIjogImh5cGVyY29yZS1jcnlwdG8iLAogICJ2ZXJzaW9uIjogIjMuNi4xIiwKICAiZGVzY3JpcHRpb24iOiAiVGhlIGNyeXB0byBwcmltaXRpdmVzIHVzZWQgaW4gaHlwZXJjb3JlLCBleHRyYWN0ZWQgaW50byBhIHNlcGFyYXRlIG1vZHVsZSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNiIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xNS4wIiwKICAgICJzb2RpdW0tdW5pdmVyc2FsIjogIl41LjAuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy41LjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4xLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9oeXBlcmNvcmUtY3J5cHRvLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9oeXBlcmNvcmUtY3J5cHRvL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2h5cGVyY29yZS1jcnlwdG8iCn0KY29uc3QgSWRFbmMgPSByZXF1aXJlKCdoeXBlcmNvcmUtaWQtZW5jb2RpbmcnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBIeXBlcmNvcmVFcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3RvciAobXNnLCBjb2RlLCBmbiA9IEh5cGVyY29yZUVycm9yLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICBpZiAoZGlzY292ZXJ5S2V5KSBtc2cgPSBgJHttc2d9IChkaXNjb3Zlcnkga2V5OiAke0lkRW5jLm5vcm1hbGl6ZShkaXNjb3ZlcnlLZXkpfSlgCiAgICBzdXBlcihgJHtjb2RlfTogJHttc2d9YCkKCiAgICB0aGlzLmNvZGUgPSBjb2RlCiAgICB0aGlzLmRpc2NvdmVyeUtleSA9IGRpc2NvdmVyeUtleQoKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBmbikKICAgIH0KICB9CgogIGdldCBuYW1lICgpIHsKICAgIHJldHVybiAnSHlwZXJjb3JlRXJyb3InCiAgfQoKICBzdGF0aWMgQVNTRVJUSU9OIChtc2csIGRpc2NvdmVyeUtleSA9IG51bGwpIHsgLy8gRVJSX0FTU0VSVElPTiBpcyBwaWNrZWQgdXAgYnkgc2FmZXR5LWNhdGNoIGFsc28KICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnRVJSX0FTU0VSVElPTicsIEh5cGVyY29yZUVycm9yLkFTU0VSVCwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIEJBRF9BUkdVTUVOVCAobXNnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0JBRF9BUkdVTUVOVCcsIEh5cGVyY29yZUVycm9yLkJBRF9BUkdVTUVOVCwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIFNUT1JBR0VfRU1QVFkgKG1zZywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdTVE9SQUdFX0VNUFRZJywgSHlwZXJjb3JlRXJyb3IuU1RPUkFHRV9FTVBUWSwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIFNUT1JBR0VfQ09ORkxJQ1QgKG1zZywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdTVE9SQUdFX0NPTkZMSUNUJywgSHlwZXJjb3JlRXJyb3IuU1RPUkFHRV9DT05GTElDVCwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIElOVkFMSURfU0lHTkFUVVJFIChtc2csIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnSU5WQUxJRF9TSUdOQVRVUkUnLCBIeXBlcmNvcmVFcnJvci5JTlZBTElEX1NJR05BVFVSRSwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIElOVkFMSURfQ0FQQUJJTElUWSAobXNnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0lOVkFMSURfQ0FQQUJJTElUWScsIEh5cGVyY29yZUVycm9yLklOVkFMSURfQ0FQQUJJTElUWSwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIElOVkFMSURfQ0hFQ0tTVU0gKG1zZyA9ICdJbnZhbGlkIGNoZWNrc3VtJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdJTlZBTElEX0NIRUNLU1VNJywgSHlwZXJjb3JlRXJyb3IuSU5WQUxJRF9DSEVDS1NVTSwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIElOVkFMSURfT1BFUkFUSU9OIChtc2csIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnSU5WQUxJRF9PUEVSQVRJT04nLCBIeXBlcmNvcmVFcnJvci5JTlZBTElEX09QRVJBVElPTiwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIElOVkFMSURfUFJPT0YgKG1zZyA9ICdQcm9vZiBub3QgdmVyaWZpYWJsZScsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnSU5WQUxJRF9QUk9PRicsIEh5cGVyY29yZUVycm9yLklOVkFMSURfUFJPT0YsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBCTE9DS19OT1RfQVZBSUxBQkxFIChtc2cgPSAnQmxvY2sgaXMgbm90IGF2YWlsYWJsZScsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnQkxPQ0tfTk9UX0FWQUlMQUJMRScsIEh5cGVyY29yZUVycm9yLkJMT0NLX05PVF9BVkFJTEFCTEUsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBTTkFQU0hPVF9OT1RfQVZBSUxBQkxFIChtc2cgPSAnU25hcHNob3QgaXMgbm90IGF2YWlsYWJsZScsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnU05BUFNIT1RfTk9UX0FWQUlMQUJMRScsIEh5cGVyY29yZUVycm9yLlNOQVBTSE9UX05PVF9BVkFJTEFCTEUsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBSRVFVRVNUX0NBTkNFTExFRCAobXNnID0gJ1JlcXVlc3Qgd2FzIGNhbmNlbGxlZCcsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnUkVRVUVTVF9DQU5DRUxMRUQnLCBIeXBlcmNvcmVFcnJvci5SRVFVRVNUX0NBTkNFTExFRCwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIFJFUVVFU1RfVElNRU9VVCAobXNnID0gJ1JlcXVlc3QgdGltZWQgb3V0JywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdSRVFVRVNUX1RJTUVPVVQnLCBIeXBlcmNvcmVFcnJvci5SRVFVRVNUX1RJTUVPVVQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBTRVNTSU9OX05PVF9XUklUQUJMRSAobXNnID0gJ1Nlc3Npb24gaXMgbm90IHdyaXRhYmxlJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdTRVNTSU9OX05PVF9XUklUQUJMRScsIEh5cGVyY29yZUVycm9yLlNFU1NJT05fTk9UX1dSSVRBQkxFLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgU0VTU0lPTl9DTE9TRUQgKG1zZyA9ICdTZXNzaW9uIGlzIGNsb3NlZCcsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnU0VTU0lPTl9DTE9TRUQnLCBIeXBlcmNvcmVFcnJvci5TRVNTSU9OX0NMT1NFRCwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIEJBVENIX1VORkxVU0hFRCAobXNnID0gJ0JhdGNoIG5vdCB5ZXQgZmx1c2hlZCcsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnQkFUQ0hfVU5GTFVTSEVEJywgSHlwZXJjb3JlRXJyb3IuQkFUQ0hfVU5GTFVTSEVELCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgQkFUQ0hfQUxSRUFEWV9FWElTVFMgKG1zZyA9ICdCYXRjaCBhbHJlYWR5IGV4aXN0cycsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnQkFUQ0hfQUxSRUFEWV9FWElTVFMnLCBIeXBlcmNvcmVFcnJvci5CQVRDSF9BTFJFQURZX0VYSVNUUywgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIEJBVENIX0FMUkVBRFlfRkxVU0hFRCAobXNnID0gJ0JhdGNoIGhhcyBhbHJlYWR5IGJlZW4gZmx1c2hlZCcsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnQkFUQ0hfQUxSRUFEWV9GTFVTSEVEJywgSHlwZXJjb3JlRXJyb3IuQkFUQ0hfQUxSRUFEWV9GTFVTSEVELCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgT1BMT0dfQ09SUlVQVCAobXNnID0gJ09wbG9nIGZpbGUgYXBwZWFycyBjb3JydXB0IG9yIG91dCBvZiBkYXRlJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdPUExPR19DT1JSVVBUJywgSHlwZXJjb3JlRXJyb3IuT1BMT0dfQ09SUlVQVCwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIE9QTE9HX0hFQURFUl9PVkVSRkxPVyAobXNnID0gJ09wbG9nIGhlYWRlciBleGNlZWRzIHBhZ2Ugc2l6ZScsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnT1BMT0dfSEVBREVSX09WRVJGTE9XJywgSHlwZXJjb3JlRXJyb3IuT1BMT0dfSEVBREVSX09WRVJGTE9XLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgSU5WQUxJRF9PUExPR19WRVJTSU9OIChtc2cgPSAnSW52YWxpZCBoZWFkZXIgdmVyc2lvbicsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnSU5WQUxJRF9PUExPR19WRVJTSU9OJywgSHlwZXJjb3JlRXJyb3IuSU5WQUxJRF9PUExPR19WRVJTSU9OLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgV1JJVEVfRkFJTEVEIChtc2cgPSAnV3JpdGUgdG8gc3RvcmFnZSBmYWlsZWQnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ1dSSVRFX0ZBSUxFRCcsIEh5cGVyY29yZUVycm9yLldSSVRFX0ZBSUxFRCwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIERFQ09ESU5HX0VSUk9SIChtc2cgPSAnRGVjb2RpbmcgZXJyb3InLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0RFQ09ESU5HX0VSUk9SJywgSHlwZXJjb3JlRXJyb3IuREVDT0RJTkdfRVJST1IsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBTRVNTSU9OX01PVkVEIChtc2cgPSAnU2Vzc2lvbiBtb3ZlZCcsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnU0VTU0lPTl9NT1ZFRCcsIEh5cGVyY29yZUVycm9yLlNFU1NJT05fTU9WRUQsIGRpc2NvdmVyeUtleSkKICB9Cn0KewogICJuYW1lIjogImh5cGVyY29yZS1lcnJvcnMiLAogICJ2ZXJzaW9uIjogIjEuNS4wIiwKICAiZGVzY3JpcHRpb24iOiAiSHlwZXJjb3JlIGVycm9ycyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJjb3JlLWVycm9ycy5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmNvcmUtZXJyb3JzL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJjb3JlLWVycm9ycyNyZWFkbWUiLAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNyIsCiAgICAiYnJpdHRsZSI6ICJeMy4xLjMiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImh5cGVyY29yZS1pZC1lbmNvZGluZyI6ICJeMS4zLjAiCiAgfQp9CmNvbnN0IHozMiA9IHJlcXVpcmUoJ3ozMicpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgptb2R1bGUuZXhwb3J0cyA9IHsKICBlbmNvZGUsCiAgZGVjb2RlLAogIG5vcm1hbGl6ZSwKICBpc1ZhbGlkCn0KCmZ1bmN0aW9uIGVuY29kZSAoa2V5KSB7CiAgaWYgKCFiNGEuaXNCdWZmZXIoa2V5KSkgdGhyb3cgbmV3IEVycm9yKCdLZXkgbXVzdCBiZSBhIEJ1ZmZlcicpCiAgaWYgKGtleS5ieXRlTGVuZ3RoICE9PSAzMikgdGhyb3cgbmV3IEVycm9yKCdLZXkgbXVzdCBiZSAzMi1ieXRlcyBsb25nJykKICByZXR1cm4gejMyLmVuY29kZShrZXkpCn0KCmZ1bmN0aW9uIGRlY29kZSAoaWQpIHsKICBpZiAoYjRhLmlzQnVmZmVyKGlkKSkgewogICAgaWYgKGlkLmJ5dGVMZW5ndGggIT09IDMyKSB0aHJvdyBuZXcgRXJyb3IoJ0lEIG11c3QgYmUgMzItYnl0ZXMgbG9uZycpCiAgICByZXR1cm4gaWQKICB9CiAgaWYgKHR5cGVvZiBpZCA9PT0gJ3N0cmluZycpIHsKICAgIGlmIChpZC5zdGFydHNXaXRoKCdwZWFyOi8vJykpIGlkID0gaWQuc2xpY2UoNykuc3BsaXQoJy8nKVswXQogICAgaWYgKGlkLmxlbmd0aCA9PT0gNTIpIHJldHVybiB6MzIuZGVjb2RlKGlkKQogICAgaWYgKGlkLmxlbmd0aCA9PT0gNjQpIHsKICAgICAgY29uc3QgYnVmID0gYjRhLmZyb20oaWQsICdoZXgnKQogICAgICBpZiAoYnVmLmJ5dGVMZW5ndGggPT09IDMyKSByZXR1cm4gYnVmCiAgICB9CiAgfQogIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBIeXBlcmNvcmUga2V5JykKfQoKZnVuY3Rpb24gbm9ybWFsaXplIChhbnkpIHsKICByZXR1cm4gZW5jb2RlKGRlY29kZShhbnkpKQp9CgpmdW5jdGlvbiBpc1ZhbGlkIChhbnkpIHsKICB0cnkgewogICAgZGVjb2RlKGFueSkKICAgIHJldHVybiB0cnVlCiAgfSBjYXRjaCB7CiAgICByZXR1cm4gZmFsc2UKICB9Cn0KewogICJuYW1lIjogImh5cGVyY29yZS1pZC1lbmNvZGluZyIsCiAgInZlcnNpb24iOiAiMS4zLjAiLAogICJkZXNjcmlwdGlvbiI6ICJDb252ZXJ0IEh5cGVyY29yZSBrZXlzIHRvL2Zyb20gei1iYXNlMzIgb3IgaGV4IiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS41LjMiLAogICAgInozMiI6ICJeMS4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMS4xIiwKICAgICJoeXBlcmNvcmUiOiAiXjEwLjAuMCIsCiAgICAicmFuZG9tLWFjY2Vzcy1tZW1vcnkiOiAiXjYuMC4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4wIgogIH0sCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyY29yZS1pZC1lbmNvZGluZy5naXQiCiAgfSwKICAia2V5d29yZHMiOiBbXSwKICAiYXV0aG9yIjogIiIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmNvcmUtaWQtZW5jb2RpbmcjcmVhZG1lIgp9CmNvbnN0IFJvY2tzREIgPSByZXF1aXJlKCdyb2Nrc2RiLW5hdGl2ZScpCmNvbnN0IHJycCA9IHJlcXVpcmUoJ3Jlc29sdmUtcmVqZWN0LXByb21pc2UnKQpjb25zdCBTY29wZUxvY2sgPSByZXF1aXJlKCdzY29wZS1sb2NrJykKY29uc3QgRGV2aWNlRmlsZSA9IHJlcXVpcmUoJ2RldmljZS1maWxlJykKY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKQpjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJykKY29uc3QgVmlldyA9IHJlcXVpcmUoJy4vbGliL3ZpZXcuanMnKQoKY29uc3QgVkVSU0lPTiA9IDEKY29uc3QgQ09MVU1OX0ZBTUlMWSA9ICdjb3Jlc3RvcmUnCgpjb25zdCB7IHN0b3JlLCBjb3JlIH0gPSByZXF1aXJlKCcuL2xpYi9rZXlzLmpzJykKCmNvbnN0IHsgQ29yZXN0b3JlUlgsIENvcmVzdG9yZVRYLCBDb3JlVFgsIENvcmVSWCB9ID0gcmVxdWlyZSgnLi9saWIvdHguanMnKQoKY29uc3QgewogIGNyZWF0ZUNvcmVTdHJlYW0sCiAgY3JlYXRlQWxpYXNTdHJlYW0sCiAgY3JlYXRlRGlzY292ZXJ5S2V5U3RyZWFtLAogIGNyZWF0ZUJsb2NrU3RyZWFtLAogIGNyZWF0ZUJpdGZpZWxkU3RyZWFtLAogIGNyZWF0ZVVzZXJEYXRhU3RyZWFtLAogIGNyZWF0ZVRyZWVOb2RlU3RyZWFtLAogIGNyZWF0ZUxvY2FsU3RyZWFtCn0gPSByZXF1aXJlKCcuL2xpYi9zdHJlYW1zLmpzJykKCmNvbnN0IEVNUFRZID0gbmV3IFZpZXcoKQoKY2xhc3MgQXRvbSB7CiAgY29uc3RydWN0b3IoZGIpIHsKICAgIHRoaXMuZGIgPSBkYgogICAgdGhpcy52aWV3ID0gbmV3IFZpZXcoKQogICAgdGhpcy5mbHVzaGVkUHJvbWlzZSA9IG51bGwKICAgIHRoaXMuZmx1c2hpbmcgPSBmYWxzZQogICAgdGhpcy5mbHVzaGVzID0gW10KICB9CgogIG9uZmx1c2goZm4pIHsKICAgIHRoaXMuZmx1c2hlcy5wdXNoKGZuKQogIH0KCiAgZmx1c2hlZCgpIHsKICAgIGlmICghdGhpcy5mbHVzaGluZykgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCiAgICBpZiAodGhpcy5mbHVzaGVkUHJvbWlzZSAhPT0gbnVsbCkgcmV0dXJuIHRoaXMuZmx1c2hlZFByb21pc2UucHJvbWlzZQogICAgdGhpcy5mbHVzaGVkUHJvbWlzZSA9IHJycCgpCiAgICByZXR1cm4gdGhpcy5mbHVzaGVkUHJvbWlzZS5wcm9taXNlCiAgfQoKICBfcmVzb2x2ZSgpIHsKICAgIGNvbnN0IGYgPSB0aGlzLmZsdXNoZWRQcm9taXNlCiAgICB0aGlzLmZsdXNoZWRQcm9taXNlID0gbnVsbAogICAgZi5yZXNvbHZlKCkKICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgaWYgKHRoaXMuZmx1c2hpbmcpIHRocm93IG5ldyBFcnJvcignQXRvbSBhbHJlYWR5IGZsdXNoaW5nJykKICAgIHRoaXMuZmx1c2hpbmcgPSB0cnVlCgogICAgdHJ5IHsKICAgICAgYXdhaXQgVmlldy5mbHVzaCh0aGlzLnZpZXcuY2hhbmdlcywgdGhpcy5kYikKICAgICAgdGhpcy52aWV3LnJlc2V0KCkKCiAgICAgIGNvbnN0IHByb21pc2VzID0gW10KICAgICAgY29uc3QgbGVuID0gdGhpcy5mbHVzaGVzLmxlbmd0aCAvLyBpbiBjYXNlIG9mIHJlZW50cnkKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykgcHJvbWlzZXMucHVzaCh0aGlzLmZsdXNoZXNbaV0oKSkKCiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5mbHVzaGluZyA9IGZhbHNlCiAgICAgIGlmICh0aGlzLmZsdXNoZWRQcm9taXNlICE9PSBudWxsKSB0aGlzLl9yZXNvbHZlKCkKICAgIH0KICB9Cn0KCmNsYXNzIEh5cGVyY29yZVN0b3JhZ2UgewogIGNvbnN0cnVjdG9yKHN0b3JlLCBkYiwgY29yZSwgdmlldywgYXRvbSkgewogICAgdGhpcy5zdG9yZSA9IHN0b3JlCiAgICB0aGlzLmRiID0gZGIKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMudmlldyA9IHZpZXcKICAgIHRoaXMuYXRvbSA9IGF0b20KCiAgICB0aGlzLnZpZXcucmVhZFN0YXJ0KCkKICB9CgogIGdldCByZWFkT25seSgpIHsKICAgIHJldHVybiB0aGlzLnN0b3JlLnJlYWRPbmx5CiAgfQoKICBnZXQgZGVwZW5kZW5jaWVzKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5kZXBlbmRlbmNpZXMKICB9CgogIGdldERlcGVuZGVuY3lMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLmRlcGVuZGVuY2llcy5sZW5ndGgKICAgICAgPyB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzW3RoaXMuY29yZS5kZXBlbmRlbmNpZXMubGVuZ3RoIC0gMV0ubGVuZ3RoCiAgICAgIDogLTEKICB9CgogIGdldERlcGVuZGVuY3kobGVuZ3RoKSB7CiAgICBmb3IgKGxldCBpID0gdGhpcy5jb3JlLmRlcGVuZGVuY2llcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBkZXAgPSB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzW2ldCiAgICAgIGlmIChkZXAubGVuZ3RoIDwgbGVuZ3RoKSByZXR1cm4gZGVwCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIHNldERlcGVuZGVuY3lIZWFkKGRlcCkgewogICAgY29uc3QgZGVwcyA9IHRoaXMuY29yZS5kZXBlbmRlbmNpZXMKCiAgICBmb3IgKGxldCBpID0gZGVwcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBkID0gZGVwc1tpXQoKICAgICAgaWYgKGQuZGF0YVBvaW50ZXIgIT09IGRlcC5kYXRhUG9pbnRlcikgY29udGludWUKCiAgICAgIC8vIGNoZWNrIGlmIG5vdGhpbmcgY2hhbmdlZAogICAgICBpZiAoZC5sZW5ndGggPT09IGRlcC5sZW5ndGggJiYgaSA9PT0gZGVwcy5sZW5ndGggLSAxKSByZXR1cm4KCiAgICAgIHRoaXMuY29yZSA9IHsKICAgICAgICBjb3JlUG9pbnRlcjogdGhpcy5jb3JlLmNvcmVQb2ludGVyLAogICAgICAgIGRhdGFQb2ludGVyOiB0aGlzLmNvcmUuZGF0YVBvaW50ZXIsCiAgICAgICAgZGVwZW5kZW5jaWVzOiBkZXBzLnNsaWNlKDAsIGkgKyAxKQogICAgICB9CgogICAgICB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzW2ldID0gewogICAgICAgIGRhdGFQb2ludGVyOiBkZXAuZGF0YVBvaW50ZXIsCiAgICAgICAgbGVuZ3RoOiBkZXAubGVuZ3RoCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzID0gWwogICAgICB7CiAgICAgICAgZGF0YVBvaW50ZXI6IGRlcC5kYXRhUG9pbnRlciwKICAgICAgICBsZW5ndGg6IGRlcC5sZW5ndGgKICAgICAgfQogICAgXQogIH0KCiAgLy8gVE9ETzogdGhpcyBtaWdodCBoYXZlIHRvIGJlIGFzeW5jIGlmIHRoZSBkZXBlbmRlbnRzIGhhdmUgY2hhbmdlZCwgYnV0IHByb3Agb2sgZm9yIG5vdwogIHVwZGF0ZURlcGVuZGVuY3lMZW5ndGgobGVuZ3RoLCB0cnVuY2F0ZWQpIHsKICAgIGNvbnN0IGRlcHMgPSB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzCgogICAgY29uc3QgaSA9IHRoaXMuZmluZERlcGVuZGVuY3lJbmRleChsZW5ndGgsIHRydW5jYXRlZCkKICAgIGlmIChpID09PSAtMSkgdGhyb3cgbmV3IEVycm9yKCdEZXBlbmRlbmN5IG5vdCBmb3VuZCcpCgogICAgdGhpcy5jb3JlID0gewogICAgICBjb3JlUG9pbnRlcjogdGhpcy5jb3JlLmNvcmVQb2ludGVyLAogICAgICBkYXRhUG9pbnRlcjogdGhpcy5jb3JlLmRhdGFQb2ludGVyLAogICAgICBkZXBlbmRlbmNpZXM6IGRlcHMuc2xpY2UoMCwgaSArIDEpCiAgICB9CgogICAgaWYgKHRoaXMuY29yZS5kZXBlbmRlbmNpZXNbaV0ubGVuZ3RoICE9PSBsZW5ndGgpIHsKICAgICAgdGhpcy5jb3JlLmRlcGVuZGVuY2llc1tpXSA9IHsKICAgICAgICBkYXRhUG9pbnRlcjogZGVwc1tpXS5kYXRhUG9pbnRlciwKICAgICAgICBsZW5ndGgKICAgICAgfQogICAgfQogIH0KCiAgZmluZERlcGVuZGVuY3lJbmRleChsZW5ndGgsIHRydW5jYXRlZCkgewogICAgY29uc3QgZGVwcyA9IHRoaXMuY29yZS5kZXBlbmRlbmNpZXMKCiAgICBpZiAodHJ1bmNhdGVkKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGVwcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChkZXBzW2ldLmxlbmd0aCA+PSBsZW5ndGgpIHJldHVybiBpCiAgICAgIH0KCiAgICAgIHJldHVybiAtMQogICAgfQoKICAgIGZvciAobGV0IGkgPSBkZXBzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGlmIChkZXBzW2ldLmxlbmd0aCA8PSBsZW5ndGgpIHJldHVybiBpCiAgICB9CgogICAgcmV0dXJuIC0xCiAgfQoKICBnZXQgc25hcHNob3R0ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5kYi5fc25hcHNob3QgIT09IG51bGwKICB9CgogIHNuYXBzaG90KCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVTdG9yYWdlKAogICAgICB0aGlzLnN0b3JlLAogICAgICB0aGlzLmRiLnNuYXBzaG90KCksCiAgICAgIHRoaXMuY29yZSwKICAgICAgdGhpcy52aWV3LnNuYXBzaG90KCksCiAgICAgIHRoaXMuYXRvbQogICAgKQogIH0KCiAgY29tcGFjdCgpIHsKICAgIHJldHVybiBQcm9taXNlLmFsbChbCiAgICAgIHRoaXMuZGIuY29tcGFjdFJhbmdlKGNvcmUuY29yZSh0aGlzLmNvcmUuY29yZVBvaW50ZXIpLCBjb3JlLmNvcmUodGhpcy5jb3JlLmNvcmVQb2ludGVyKSksCiAgICAgIHRoaXMuZGIuY29tcGFjdFJhbmdlKGNvcmUuZGF0YSh0aGlzLmNvcmUuZGF0YVBvaW50ZXIpLCBjb3JlLmRhdGEodGhpcy5jb3JlLmRhdGFQb2ludGVyKSkKICAgIF0pCiAgfQoKICBhdG9taXplKGF0b20pIHsKICAgIGlmICh0aGlzLmF0b20gJiYgdGhpcy5hdG9tICE9PSBhdG9tKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGF0b21pemUgYW5kIGF0b21pemVkIHNlc3Npb24gd2l0aCBhIG5ldyBhdG9tJykKICAgIH0KICAgIHJldHVybiBuZXcgSHlwZXJjb3JlU3RvcmFnZSh0aGlzLnN0b3JlLCB0aGlzLmRiLnNlc3Npb24oKSwgdGhpcy5jb3JlLCBhdG9tLnZpZXcsIGF0b20pCiAgfQoKICBjcmVhdGVBdG9tKCkgewogICAgcmV0dXJuIHRoaXMuc3RvcmUuY3JlYXRlQXRvbSgpCiAgfQoKICBjcmVhdGVCbG9ja1N0cmVhbShvcHRzKSB7CiAgICByZXR1cm4gY3JlYXRlQmxvY2tTdHJlYW0odGhpcy5jb3JlLCB0aGlzLmRiLCB0aGlzLnZpZXcsIG9wdHMpCiAgfQoKICBjcmVhdGVUcmVlTm9kZVN0cmVhbShvcHRzKSB7CiAgICByZXR1cm4gY3JlYXRlVHJlZU5vZGVTdHJlYW0odGhpcy5jb3JlLCB0aGlzLmRiLCB0aGlzLnZpZXcsIG9wdHMpCiAgfQoKICBjcmVhdGVCaXRmaWVsZFN0cmVhbShvcHRzKSB7CiAgICByZXR1cm4gY3JlYXRlQml0ZmllbGRTdHJlYW0odGhpcy5jb3JlLCB0aGlzLmRiLCB0aGlzLnZpZXcsIG9wdHMpCiAgfQoKICBjcmVhdGVVc2VyRGF0YVN0cmVhbShvcHRzKSB7CiAgICByZXR1cm4gY3JlYXRlVXNlckRhdGFTdHJlYW0odGhpcy5jb3JlLCB0aGlzLmRiLCB0aGlzLnZpZXcsIG9wdHMpCiAgfQoKICBjcmVhdGVMb2NhbFN0cmVhbShvcHRzKSB7CiAgICByZXR1cm4gY3JlYXRlTG9jYWxTdHJlYW0odGhpcy5jb3JlLCB0aGlzLmRiLCB0aGlzLnZpZXcsIG9wdHMpCiAgfQoKICBhc3luYyByZXN1bWVTZXNzaW9uKG5hbWUpIHsKICAgIGNvbnN0IHJ4ID0gdGhpcy5yZWFkKCkKICAgIGNvbnN0IGV4aXN0aW5nU2Vzc2lvbnNQcm9taXNlID0gcnguZ2V0U2Vzc2lvbnMoKQoKICAgIHJ4LnRyeUZsdXNoKCkKICAgIGNvbnN0IGV4aXN0aW5nU2Vzc2lvbnMgPSBhd2FpdCBleGlzdGluZ1Nlc3Npb25zUHJvbWlzZQoKICAgIGNvbnN0IHNlc3Npb25zID0gZXhpc3RpbmdTZXNzaW9ucyB8fCBbXQogICAgY29uc3Qgc2Vzc2lvbiA9IGdldEJhdGNoKHNlc3Npb25zLCBuYW1lLCBmYWxzZSkKCiAgICBpZiAoc2Vzc2lvbiA9PT0gbnVsbCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBjb3JlID0gewogICAgICBjb3JlUG9pbnRlcjogdGhpcy5jb3JlLmNvcmVQb2ludGVyLAogICAgICBkYXRhUG9pbnRlcjogc2Vzc2lvbi5kYXRhUG9pbnRlciwKICAgICAgZGVwZW5kZW5jaWVzOiBbXQogICAgfQoKICAgIGNvbnN0IGNvcmVSeCA9IG5ldyBDb3JlUlgoY29yZSwgdGhpcy5kYiwgdGhpcy52aWV3KQoKICAgIGNvbnN0IGRlcGVuZGVuY3lQcm9taXNlID0gY29yZVJ4LmdldERlcGVuZGVuY3koKQogICAgY29yZVJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBkZXBlbmRlbmN5ID0gYXdhaXQgZGVwZW5kZW5jeVByb21pc2UKICAgIGlmIChkZXBlbmRlbmN5KSBjb3JlLmRlcGVuZGVuY2llcyA9IHRoaXMuX2FkZERlcGVuZGVuY3koZGVwZW5kZW5jeSkKCiAgICByZXR1cm4gbmV3IEh5cGVyY29yZVN0b3JhZ2UoCiAgICAgIHRoaXMuc3RvcmUsCiAgICAgIHRoaXMuZGIuc2Vzc2lvbigpLAogICAgICBjb3JlLAogICAgICB0aGlzLmF0b20gPyB0aGlzLnZpZXcgOiBuZXcgVmlldygpLAogICAgICB0aGlzLmF0b20KICAgICkKICB9CgogIGFzeW5jIGNyZWF0ZVNlc3Npb24obmFtZSwgaGVhZCkgewogICAgY29uc3QgcnggPSB0aGlzLnJlYWQoKQoKICAgIGNvbnN0IGV4aXN0aW5nU2Vzc2lvbnNQcm9taXNlID0gcnguZ2V0U2Vzc2lvbnMoKQogICAgY29uc3QgZXhpc3RpbmdIZWFkUHJvbWlzZSA9IHJ4LmdldEhlYWQoKQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBbZXhpc3RpbmdTZXNzaW9ucywgZXhpc3RpbmdIZWFkXSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgICAgZXhpc3RpbmdTZXNzaW9uc1Byb21pc2UsCiAgICAgIGV4aXN0aW5nSGVhZFByb21pc2UKICAgIF0pCiAgICBpZiAoaGVhZCA9PT0gbnVsbCkgaGVhZCA9IGV4aXN0aW5nSGVhZAoKICAgIGlmIChleGlzdGluZ0hlYWQgIT09IG51bGwgJiYgaGVhZC5sZW5ndGggPiBleGlzdGluZ0hlYWQubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBoZWFkIHBhc3NlZCwgYWhlYWQgb2YgY29yZScpCiAgICB9CgogICAgY29uc3Qgc2Vzc2lvbnMgPSBleGlzdGluZ1Nlc3Npb25zIHx8IFtdCiAgICBjb25zdCBzZXNzaW9uID0gZ2V0QmF0Y2goc2Vzc2lvbnMsIG5hbWUsIHRydWUpCiAgICBjb25zdCBmcmVzaCA9IHNlc3Npb24uZGF0YVBvaW50ZXIgPT09IC0xCgogICAgaWYgKGZyZXNoKSB7CiAgICAgIHNlc3Npb24uZGF0YVBvaW50ZXIgPSBhd2FpdCB0aGlzLnN0b3JlLl9hbGxvY0RhdGEoKQogICAgfQoKICAgIGNvbnN0IHR4ID0gdGhpcy53cml0ZSgpCgogICAgdHguc2V0U2Vzc2lvbnMoc2Vzc2lvbnMpCgogICAgY29uc3QgbGVuZ3RoID0gaGVhZCA9PT0gbnVsbCA/IDAgOiBoZWFkLmxlbmd0aAogICAgY29uc3QgY29yZSA9IHsKICAgICAgY29yZVBvaW50ZXI6IHRoaXMuY29yZS5jb3JlUG9pbnRlciwKICAgICAgZGF0YVBvaW50ZXI6IHNlc3Npb24uZGF0YVBvaW50ZXIsCiAgICAgIGRlcGVuZGVuY2llczogdGhpcy5fYWRkRGVwZW5kZW5jeSh7CiAgICAgICAgZGF0YVBvaW50ZXI6IHRoaXMuY29yZS5kYXRhUG9pbnRlciwKICAgICAgICBsZW5ndGgKICAgICAgfSkKICAgIH0KCiAgICBjb25zdCBjb3JlVHggPSBuZXcgQ29yZVRYKGNvcmUsIHRoaXMuZGIsIHR4LnZpZXcsIHR4LmNoYW5nZXMpCgogICAgaWYgKGxlbmd0aCA+IDApIGNvcmVUeC5zZXRIZWFkKGhlYWQpCiAgICBjb3JlVHguc2V0RGVwZW5kZW5jeShjb3JlLmRlcGVuZGVuY2llc1tjb3JlLmRlcGVuZGVuY2llcy5sZW5ndGggLSAxXSkKCiAgICBpZiAoIWZyZXNoKSB7CiAgICAgIC8vIG51a2UgYWxsIGV4aXN0aW5nIHN0YXRlLi4uCiAgICAgIGNvcmVUeC5kZWxldGVCbG9ja1JhbmdlKDAsIC0xKQogICAgICBjb3JlVHguZGVsZXRlVHJlZU5vZGVSYW5nZSgwLCAtMSkKICAgICAgY29yZVR4LmRlbGV0ZUJpdGZpZWxkUGFnZVJhbmdlKDAsIC0xKQogICAgfQoKICAgIGF3YWl0IHR4LmZsdXNoKCkKCiAgICByZXR1cm4gbmV3IEh5cGVyY29yZVN0b3JhZ2UoCiAgICAgIHRoaXMuc3RvcmUsCiAgICAgIHRoaXMuZGIuc2Vzc2lvbigpLAogICAgICBjb3JlLAogICAgICB0aGlzLmF0b20gPyB0aGlzLnZpZXcgOiBuZXcgVmlldygpLAogICAgICB0aGlzLmF0b20KICAgICkKICB9CgogIGFzeW5jIGNyZWF0ZUF0b21pY1Nlc3Npb24oYXRvbSwgaGVhZCkgewogICAgY29uc3QgbGVuZ3RoID0gaGVhZCA9PT0gbnVsbCA/IDAgOiBoZWFkLmxlbmd0aAogICAgY29uc3QgY29yZSA9IHsKICAgICAgY29yZVBvaW50ZXI6IHRoaXMuY29yZS5jb3JlUG9pbnRlciwKICAgICAgZGF0YVBvaW50ZXI6IHRoaXMuY29yZS5kYXRhUG9pbnRlciwKICAgICAgZGVwZW5kZW5jaWVzOiB0aGlzLl9hZGREZXBlbmRlbmN5KG51bGwpCiAgICB9CgogICAgY29uc3QgY29yZVR4ID0gbmV3IENvcmVUWChjb3JlLCB0aGlzLmRiLCBhdG9tLnZpZXcsIFtdKQoKICAgIGlmIChsZW5ndGggPiAwKSBjb3JlVHguc2V0SGVhZChoZWFkKQoKICAgIGF3YWl0IGNvcmVUeC5mbHVzaCgpCgogICAgcmV0dXJuIHRoaXMuYXRvbWl6ZShhdG9tKQogIH0KCiAgX2FkZERlcGVuZGVuY3koZGVwKSB7CiAgICBjb25zdCBkZXBzID0gW10KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY29yZS5kZXBlbmRlbmNpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgZCA9IHRoaXMuY29yZS5kZXBlbmRlbmNpZXNbaV0KCiAgICAgIGlmIChkZXAgIT09IG51bGwgJiYgZC5sZW5ndGggPiBkZXAubGVuZ3RoKSB7CiAgICAgICAgaWYgKGQuZGF0YVBvaW50ZXIgIT09IGRlcC5kYXRhUG9pbnRlcikgewogICAgICAgICAgZGVwcy5wdXNoKHsgZGF0YVBvaW50ZXI6IGQuZGF0YVBvaW50ZXIsIGxlbmd0aDogZGVwLmxlbmd0aCB9KQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVwcwogICAgICB9CgogICAgICBkZXBzLnB1c2goZCkKICAgIH0KCiAgICBpZiAoCiAgICAgIGRlcCAhPT0gbnVsbCAmJgogICAgICAoZGVwcy5sZW5ndGggPT09IDAgfHwgZGVwc1tkZXBzLmxlbmd0aCAtIDFdLmRhdGFQb2ludGVyICE9PSBkZXAuZGF0YVBvaW50ZXIpCiAgICApIHsKICAgICAgZGVwcy5wdXNoKGRlcCkKICAgIH0KICAgIHJldHVybiBkZXBzCiAgfQoKICByZWFkKCkgewogICAgcmV0dXJuIG5ldyBDb3JlUlgodGhpcy5jb3JlLCB0aGlzLmRiLCB0aGlzLnZpZXcpCiAgfQoKICB3cml0ZSgpIHsKICAgIHJldHVybiBuZXcgQ29yZVRYKHRoaXMuY29yZSwgdGhpcy5kYiwgdGhpcy5hdG9tID8gdGhpcy52aWV3IDogbnVsbCwgW10pCiAgfQoKICBjbG9zZSgpIHsKICAgIGlmICh0aGlzLnZpZXcgIT09IG51bGwpIHsKICAgICAgdGhpcy52aWV3LnJlYWRTdG9wKCkKICAgICAgdGhpcy52aWV3ID0gbnVsbAogICAgfQoKICAgIHJldHVybiB0aGlzLmRiLmNsb3NlKCkKICB9CgogIHN0YXRpYyBhc3luYyBleHBvcnQocHRyLCBkYiwgeyBiYXRjaGVzID0gZmFsc2UgfSA9IHt9KSB7CiAgICBjb25zdCByeCA9IG5ldyBDb3JlUlgocHRyLCBkYiwgRU1QVFkpCgogICAgY29uc3QgY29yZSA9IHsKICAgICAgaGVhZDogbnVsbCwKICAgICAgYXV0aDogbnVsbCwKICAgICAgc2Vzc2lvbnM6IFtdLAogICAgICBkYXRhOiBudWxsCiAgICB9CgogICAgY29uc3Qgc2Vzc2lvbnNQcm9taXNlID0gcnguZ2V0U2Vzc2lvbnMoKQogICAgY29uc3QgaGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKICAgIGNvbnN0IGF1dGhQcm9taXNlID0gcnguZ2V0QXV0aCgpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IFtzZXNzaW9ucywgaGVhZCwgYXV0aF0gPSBhd2FpdCBQcm9taXNlLmFsbChbc2Vzc2lvbnNQcm9taXNlLCBoZWFkUHJvbWlzZSwgYXV0aFByb21pc2VdKQoKICAgIGNvcmUuaGVhZCA9IGhlYWQKICAgIGNvcmUuYXV0aCA9IHsgLi4uYXV0aCwga2V5UGFpcjogbnVsbCB9CiAgICBpZiAoc2Vzc2lvbnMpIGNvcmUuc2Vzc2lvbnMgPSBzZXNzaW9ucy5tYXAoKHMpID0+IHMubmFtZSkKCiAgICBjb25zdCBkYXRhID0gW10KCiAgICBkYXRhLnB1c2goZXhwb3J0RGF0YShwdHIsIGRiKSkKCiAgICBpZiAoYmF0Y2hlcykgewogICAgICBmb3IgKGNvbnN0IHsgZGF0YVBvaW50ZXIgfSBvZiBzZXNzaW9ucykgewogICAgICAgIGRhdGEucHVzaChleHBvcnREYXRhKHsgZGF0YVBvaW50ZXIsIGRlcGVuZGVuY2llczogW10gfSwgZGIpKQogICAgICB9CiAgICB9CgogICAgY29yZS5kYXRhID0gYXdhaXQgUHJvbWlzZS5hbGwoZGF0YSkKCiAgICByZXR1cm4gY29yZQogIH0KfQoKY2xhc3MgQ29yZXN0b3JlU3RvcmFnZSB7CiAgY29uc3RydWN0b3IoZGIsIG9wdHMgPSB7fSkgewogICAgY29uc3Qgc3RvcmFnZSA9IHR5cGVvZiBkYiA9PT0gJ3N0cmluZycgPyBkYiA6IG51bGwKCiAgICB0aGlzLmJvb3RzdHJhcCA9IHN0b3JhZ2UgIT09IG51bGwKICAgIHRoaXMucGF0aCA9IHN0b3JhZ2UgIT09IG51bGwgPyBzdG9yYWdlIDogcGF0aC5qb2luKGRiLnBhdGgsICcuLicpCiAgICB0aGlzLnJlYWRPbmx5ID0gISFvcHRzLnJlYWRPbmx5CiAgICB0aGlzLmFsbG93QmFja3VwID0gISFvcHRzLmFsbG93QmFja3VwCiAgICB0aGlzLmRldmljZUZpbGUgPSBudWxsCiAgICB0aGlzLndhaXQgPSAhIW9wdHMud2FpdAoKICAgIC8vIHRtcCBzeW5jIGZpeCBmb3Igc2ltcGxpY3R5IHNpbmNlIG5vdCBzdXBlciBkZXBsb3llZCB5ZXQKICAgIGlmICh0aGlzLmJvb3RzdHJhcCAmJiAhdGhpcy5yZWFkT25seSkgdG1wRml4U3RvcmFnZSh0aGlzLnBhdGgpCgogICAgdGhpcy5pZCA9IG9wdHMuaWQgfHwgbnVsbAogICAgdGhpcy52aWV3ID0gbnVsbAogICAgdGhpcy5lbnRlcnMgPSAwCiAgICB0aGlzLmxvY2sgPSBuZXcgU2NvcGVMb2NrKCkKICAgIHRoaXMuZmx1c2hpbmcgPSBudWxsCiAgICB0aGlzLnZlcnNpb24gPSAwCiAgICB0aGlzLm1pZ3JhdGluZyA9IG51bGwKCiAgICBpZiAoKHRoaXMuYm9vdHN0cmFwICYmICF0aGlzLnJlYWRPbmx5ICYmICF0aGlzLmFsbG93QmFja3VwKSB8fCB0aGlzLndhaXQpIHsKICAgICAgY29uc3QgY29yZXN0b3JlRmlsZSA9IHBhdGguam9pbih0aGlzLnBhdGgsICdDT1JFU1RPUkUnKQoKICAgICAgdGhpcy5kZXZpY2VGaWxlID0gbmV3IERldmljZUZpbGUoY29yZXN0b3JlRmlsZSwgewogICAgICAgIGxvY2s6IHRydWUsCiAgICAgICAgd2FpdDogdGhpcy53YWl0LAogICAgICAgIGRhdGE6IHsgaWQ6IHRoaXMuaWQgfQogICAgICB9KQogICAgfQoKICAgIGNvbnN0IGRiUGF0aCA9IHBhdGguam9pbih0aGlzLnBhdGgsICdkYicpCgogICAgdGhpcy5yb2NrcyA9IHN0b3JhZ2UgPT09IG51bGwgPyBkYiA6IG5ldyBSb2Nrc0RCKGRiUGF0aCwgeyAuLi5vcHRzLCBsb2NrOiB0aGlzLmRldmljZUZpbGUgfSkKICAgIHRoaXMuZGIgPSBjcmVhdGVDb2x1bW5GYW1pbHkodGhpcy5yb2Nrcywgb3B0cykKICB9CgogIGdldCBvcGVuZWQoKSB7CiAgICByZXR1cm4gdGhpcy5kYi5vcGVuZWQKICB9CgogIGdldCBjbG9zZWQoKSB7CiAgICByZXR1cm4gdGhpcy5kYi5jbG9zZWQKICB9CgogIGFzeW5jIHJlYWR5KCkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKICAgIHJldHVybiB0aGlzLmRiLnJlYWR5KCkKICB9CgogIGNvbXBhY3QoKSB7CiAgICByZXR1cm4gdGhpcy5kYi5jb21wYWN0UmFuZ2UoKQogIH0KCiAgYXN5bmMgYXVkaXQoKSB7CiAgICBmb3IgYXdhaXQgKGNvbnN0IHsgY29yZSB9IG9mIHRoaXMuY3JlYXRlQ29yZVN0cmVhbSgpKSB7CiAgICAgIGNvbnN0IGNvcmVSeCA9IG5ldyBDb3JlUlgoY29yZSwgdGhpcy5kYiwgRU1QVFkpCiAgICAgIGNvbnN0IGF1dGhQcm9taXNlID0gY29yZVJ4LmdldEF1dGgoKQoKICAgICAgY29yZVJ4LnRyeUZsdXNoKCkKCiAgICAgIGNvbnN0IGF1dGggPSBhd2FpdCBhdXRoUHJvbWlzZQoKICAgICAgaWYgKCFhdXRoLm1hbmlmZXN0IHx8IGF1dGgubWFuaWZlc3QudmVyc2lvbiA+IDApIGNvbnRpbnVlCiAgICAgIGlmIChhdXRoLm1hbmlmZXN0LmxpbmtlZCA9PT0gbnVsbCkgY29udGludWUKCiAgICAgIGF1dGgubWFuaWZlc3QubGlua2VkID0gbnVsbAogICAgICBjb25zdCBjb3JlVHggPSBuZXcgQ29yZVRYKGNvcmUsIHRoaXMuZGIsIG51bGwsIFtdKQogICAgICBjb3JlVHguc2V0QXV0aChhdXRoKQogICAgICBhd2FpdCBjb3JlVHguZmx1c2goKQogICAgfQogIH0KCiAgYXN5bmMgZGVsZXRlQ29yZShwdHIpIHsKICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVSWChwdHIsIHRoaXMuZGIsIEVNUFRZKQoKICAgIGNvbnN0IGF1dGhQcm9taXNlID0gcnguZ2V0QXV0aCgpCiAgICBjb25zdCBzZXNzaW9uc1Byb21pc2UgPSByeC5nZXRTZXNzaW9ucygpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IGF1dGggPSBhd2FpdCBhdXRoUHJvbWlzZQogICAgY29uc3Qgc2Vzc2lvbnMgPSBhd2FpdCBzZXNzaW9uc1Byb21pc2UKCiAgICAvLyBubyBjb3JlIHN0b3JlZCBoZXJlCiAgICBpZiAoIWF1dGgpIHJldHVybgoKICAgIGNvbnN0IHR4ID0gdGhpcy5kYi53cml0ZSh7IGF1dG9EZXN0cm95OiB0cnVlIH0pCgogICAgdHgudHJ5RGVsZXRlKHN0b3JlLmNvcmUoYXV0aC5kaXNjb3ZlcnlLZXkpKQoKICAgIC8vIGNsZWFyIGNvcmUKICAgIGNvbnN0IHN0YXJ0ID0gY29yZS5jb3JlKHB0ci5jb3JlUG9pbnRlcikKICAgIGNvbnN0IGVuZCA9IGNvcmUuY29yZShwdHIuY29yZVBvaW50ZXIgKyAxKQogICAgdHgudHJ5RGVsZXRlUmFuZ2Uoc3RhcnQsIGVuZCkKCiAgICBpZiAoc2Vzc2lvbnMpIHsKICAgICAgZm9yIChjb25zdCB7IGRhdGFQb2ludGVyIH0gb2Ygc2Vzc2lvbnMpIHsKICAgICAgICBjb25zdCBzdGFydCA9IGNvcmUuZGF0YShkYXRhUG9pbnRlcikKICAgICAgICBjb25zdCBlbmQgPSBjb3JlLmRhdGEoZGF0YVBvaW50ZXIgKyAxKQogICAgICAgIHR4LnRyeURlbGV0ZVJhbmdlKHN0YXJ0LCBlbmQpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdHguZmx1c2goKQogIH0KCiAgc3RhdGljIGlzQ29yZVN0b3JhZ2UoZGIpIHsKICAgIHJldHVybiBpc0NvcmVzdG9yZVN0b3JhZ2UoZGIpCiAgfQoKICBzdGF0aWMgZnJvbShkYikgewogICAgaWYgKGlzQ29yZXN0b3JlU3RvcmFnZShkYikpIHJldHVybiBkYgogICAgcmV0dXJuIG5ldyB0aGlzKGRiKQogIH0KCiAgYXN5bmMgX2ZsdXNoKCkgewogICAgd2hpbGUgKHRoaXMuZW50ZXJzID4gMCkgewogICAgICBhd2FpdCB0aGlzLmxvY2subG9jaygpCiAgICAgIGF3YWl0IHRoaXMubG9jay51bmxvY2soKQogICAgfQogIH0KCiAgLy8gcnVucyBwcmUgYW55IG90aGVyIG11dGF0aW9uIGFuZCByZWFkCiAgYXN5bmMgX21pZ3JhdGVTdG9yZSgpIHsKICAgIGNvbnN0IHZpZXcgPSBhd2FpdCB0aGlzLl9lbnRlcigpCgogICAgdHJ5IHsKICAgICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gVkVSU0lPTikgcmV0dXJuCgogICAgICBhd2FpdCB0aGlzLl9wcmVvcGVuCiAgICAgIGF3YWl0IHRoaXMuZGIucmVhZHkoKQoKICAgICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgdmlldykKICAgICAgY29uc3QgaGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKCiAgICAgIHJ4LnRyeUZsdXNoKCkKICAgICAgY29uc3QgaGVhZCA9IGF3YWl0IGhlYWRQcm9taXNlCgogICAgICBjb25zdCB2ZXJzaW9uID0gaGVhZCA9PT0gbnVsbCA/IDAgOiBoZWFkLnZlcnNpb24KICAgICAgaWYgKHZlcnNpb24gPT09IFZFUlNJT04pIHsKICAgICAgICB0aGlzLnZlcnNpb24gPSBWRVJTSU9OCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIGNvbnN0IHRhcmdldCA9IHsgdmVyc2lvbjogVkVSU0lPTiwgZHJ5UnVuOiBmYWxzZSB9CgogICAgICBzd2l0Y2ggKHZlcnNpb24pIHsKICAgICAgICBjYXNlIDA6IHsKICAgICAgICAgIGF3YWl0IHJlcXVpcmUoJy4vbWlncmF0aW9ucy8wJykuc3RvcmUodGhpcywgdGFyZ2V0KQogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAnVW5zdXBwb3J0ZWQgdmVyc2lvbjogJyArIHZlcnNpb24gKyAnIC0geW91IHNob3VsZCBwcm9iYWJseSB1cGdyYWRlIHlvdXIgZGVwZW5kZW5jaWVzJwogICAgICAgICAgKQogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy52ZXJzaW9uID0gVkVSU0lPTgogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgdGhpcy5fZXhpdCgpCiAgICB9CiAgfQoKICAvLyBydW5zIHByZSB0aGUgY29yZSBpcyByZXR1cm5lZCB0byB0aGUgdXNlcgogIGFzeW5jIF9taWdyYXRlQ29yZShjb3JlLCBkaXNjb3ZlcnlLZXksIHZlcnNpb24sIGxvY2tlZCkgewogICAgY29uc3QgdmlldyA9IGxvY2tlZCA/IHRoaXMudmlldyA6IGF3YWl0IHRoaXMuX2VudGVyKCkKICAgIHRyeSB7CiAgICAgIGlmICh2ZXJzaW9uID09PSBWRVJTSU9OKSByZXR1cm4KCiAgICAgIGNvbnN0IHRhcmdldCA9IHsgdmVyc2lvbjogVkVSU0lPTiwgZHJ5UnVuOiBmYWxzZSB9CgogICAgICBzd2l0Y2ggKHZlcnNpb24pIHsKICAgICAgICBjYXNlIDA6IHsKICAgICAgICAgIGF3YWl0IHJlcXVpcmUoJy4vbWlncmF0aW9ucy8wJykuY29yZShjb3JlLCB0YXJnZXQpCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICdVbnN1cHBvcnRlZCB2ZXJzaW9uOiAnICsgdmVyc2lvbiArICcgLSB5b3Ugc2hvdWxkIHByb2JhYmx5IHVwZ3JhZGUgeW91ciBkZXBlbmRlbmNpZXMnCiAgICAgICAgICApCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAobG9ja2VkID09PSBmYWxzZSkgcmV0dXJuCgogICAgICAvLyBpZiBpdHMgbG9ja2VkLCB0aGVuIG1vdmUgdGhlIGNvcmUgc3RhdGUgaW50byB0aGUgbWVtdmlldwogICAgICAvLyBpbiBjYXNlIHRoZSBjb3JlIGlzIHJlb3BlbmVkIGZyb20gdGhlIG1lbXZpZXcsIHByZSBmbHVzaAoKICAgICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgRU1QVFkpCiAgICAgIGNvbnN0IHR4ID0gbmV3IENvcmVzdG9yZVRYKHZpZXcpCgogICAgICBjb25zdCBjb3JlUHJvbWlzZSA9IHJ4LmdldENvcmUoZGlzY292ZXJ5S2V5KQogICAgICByeC50cnlGbHVzaCgpCgogICAgICB0eC5wdXRDb3JlKGRpc2NvdmVyeUtleSwgYXdhaXQgY29yZVByb21pc2UpCiAgICAgIHR4LmFwcGx5KCkKICAgIH0gZmluYWxseSB7CiAgICAgIGlmICghbG9ja2VkKSBhd2FpdCB0aGlzLl9leGl0KCkKICAgIH0KICB9CgogIGFzeW5jIF9lbnRlcigpIHsKICAgIHRoaXMuZW50ZXJzKysKICAgIGF3YWl0IHRoaXMubG9jay5sb2NrKCkKICAgIGlmICh0aGlzLnZpZXcgPT09IG51bGwpIHRoaXMudmlldyA9IG5ldyBWaWV3KCkKICAgIHJldHVybiB0aGlzLnZpZXcKICB9CgogIGFzeW5jIF9leGl0KCkgewogICAgdGhpcy5lbnRlcnMtLQoKICAgIGlmICh0aGlzLmZsdXNoaW5nID09PSBudWxsKSB0aGlzLmZsdXNoaW5nID0gcnJwKCkKICAgIGNvbnN0IGZsdXNoZWQgPSB0aGlzLmZsdXNoaW5nLnByb21pc2UKCiAgICBpZiAodGhpcy5lbnRlcnMgPT09IDAgfHwgdGhpcy52aWV3LnNpemUoKSA+IDEyOCkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IFZpZXcuZmx1c2godGhpcy52aWV3LmNoYW5nZXMsIHRoaXMuZGIpCiAgICAgICAgdGhpcy5mbHVzaGluZy5yZXNvbHZlKCkKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgdGhpcy5mbHVzaGluZy5yZWplY3QoZXJyKQogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRoaXMuZmx1c2hpbmcgPSBudWxsCiAgICAgICAgdGhpcy52aWV3ID0gbnVsbAogICAgICB9CiAgICB9CgogICAgdGhpcy5sb2NrLnVubG9jaygpCiAgICByZXR1cm4gZmx1c2hlZAogIH0KCiAgLy8gd2hlbiB1c2VkIHdpdGggY29yZSBjYXRjaGVzIHRoaXMgaXNudCB0cmFuc2FjdGlvbmFsIGZvciBzaW1wbGljaXR5LCBIT1dFVkVSLCBpdHMganVzdCBhIG51bWJlcgogIC8vIHNvIHdvcnRoIHRoZSB0cmFkZW9mZgogIGFzeW5jIF9hbGxvY0RhdGEoKSB7CiAgICBsZXQgZGF0YVBvaW50ZXIgPSAwCgogICAgY29uc3QgdmlldyA9IGF3YWl0IHRoaXMuX2VudGVyKCkKICAgIGNvbnN0IHR4ID0gbmV3IENvcmVzdG9yZVRYKHZpZXcpCgogICAgdHJ5IHsKICAgICAgY29uc3QgaGVhZCA9IGF3YWl0IHRoaXMuX2dldEhlYWQodmlldykKCiAgICAgIGRhdGFQb2ludGVyID0gaGVhZC5hbGxvY2F0ZWQuZGF0YXMrKwoKICAgICAgdHguc2V0SGVhZChoZWFkKQogICAgICB0eC5hcHBseSgpCiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCB0aGlzLl9leGl0KCkKICAgIH0KCiAgICByZXR1cm4gZGF0YVBvaW50ZXIKICB9CgogIC8vIGV4cG9zZXMgaGVyZSBzbyBtaWdyYXRpb25zIGNhbiBlYXNpbHkgYWNjZXNzIHRoZSBoZWFkIGluIGFuIGluaXQgc3RhdGUKICBhc3luYyBfZ2V0SGVhZCh2aWV3KSB7CiAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCB2aWV3KQogICAgY29uc3QgaGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBoZWFkID0gYXdhaXQgaGVhZFByb21pc2UKICAgIHJldHVybiBoZWFkID09PSBudWxsID8gaW5pdFN0b3JlSGVhZCgpIDogaGVhZAogIH0KCiAgY3JlYXRlQXRvbSgpIHsKICAgIHJldHVybiBuZXcgQXRvbSh0aGlzLmRiKQogIH0KCiAgYXN5bmMgZmx1c2goKSB7CiAgICBhd2FpdCB0aGlzLnJvY2tzLmZsdXNoKCkKICB9CgogIGFzeW5jIGNsb3NlKCkgewogICAgaWYgKHRoaXMuZGIuY2xvc2VkKSByZXR1cm4KICAgIGF3YWl0IHRoaXMuX2ZsdXNoKCkKICAgIGF3YWl0IHRoaXMuZGIuY2xvc2UoKQogICAgYXdhaXQgdGhpcy5yb2Nrcy5jbG9zZSgpCiAgICBpZiAodGhpcy5kZXZpY2VGaWxlKSBhd2FpdCB0aGlzLmRldmljZUZpbGUuY2xvc2UoKQogIH0KCiAgYXN5bmMgY2xlYXIoKSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSBhd2FpdCB0aGlzLl9taWdyYXRlU3RvcmUoKQoKICAgIGNvbnN0IHZpZXcgPSBhd2FpdCB0aGlzLl9lbnRlcigpCiAgICBjb25zdCB0eCA9IG5ldyBDb3Jlc3RvcmVUWCh2aWV3KQoKICAgIHR4LmNsZWFyKCkKICAgIHR4LmFwcGx5KCkKCiAgICBhd2FpdCB0aGlzLl9leGl0KCkKICB9CgogIGNyZWF0ZUNvcmVTdHJlYW0oKSB7CiAgICAvLyBUT0RPOiBiZSBuaWNlIHRvIHJ1biB0aGUgbWdpcmF0aW9uIGhlcmUgYWxzbywgYnV0IHRvbyBtdWNoIHBsdW1iaW5nIGF0bQogICAgcmV0dXJuIGNyZWF0ZUNvcmVTdHJlYW0odGhpcy5kYiwgRU1QVFkpCiAgfQoKICBjcmVhdGVBbGlhc1N0cmVhbShuYW1lc3BhY2UpIHsKICAgIC8vIFRPRE86IGJlIG5pY2UgdG8gcnVuIHRoZSBtZ2lyYXRpb24gaGVyZSBhbHNvLCBidXQgdG9vIG11Y2ggcGx1bWJpbmcgYXRtCiAgICByZXR1cm4gY3JlYXRlQWxpYXNTdHJlYW0odGhpcy5kYiwgRU1QVFksIG5hbWVzcGFjZSkKICB9CgogIGNyZWF0ZURpc2NvdmVyeUtleVN0cmVhbShuYW1lc3BhY2UpIHsKICAgIHJldHVybiBjcmVhdGVEaXNjb3ZlcnlLZXlTdHJlYW0odGhpcy5kYiwgRU1QVFksIG5hbWVzcGFjZSkKICB9CgogIGFzeW5jIGdldEFsaWFzKGFsaWFzKSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSBhd2FpdCB0aGlzLl9taWdyYXRlU3RvcmUoKQoKICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIEVNUFRZKQogICAgY29uc3QgZGlzY292ZXJ5S2V5UHJvbWlzZSA9IHJ4LmdldENvcmVCeUFsaWFzKGFsaWFzKQogICAgcngudHJ5Rmx1c2goKQogICAgcmV0dXJuIGRpc2NvdmVyeUtleVByb21pc2UKICB9CgogIGFzeW5jIGdldFNlZWQoKSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSBhd2FpdCB0aGlzLl9taWdyYXRlU3RvcmUoKQoKICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIEVNUFRZKQogICAgY29uc3QgaGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgaGVhZCA9IGF3YWl0IGhlYWRQcm9taXNlCiAgICByZXR1cm4gaGVhZCA9PT0gbnVsbCA/IG51bGwgOiBoZWFkLnNlZWQKICB9CgogIGFzeW5jIHNldFNlZWQoc2VlZCwgeyBvdmVyd3JpdGUgPSB0cnVlIH0gPSB7fSkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBjb25zdCB2aWV3ID0gYXdhaXQgdGhpcy5fZW50ZXIoKQogICAgY29uc3QgdHggPSBuZXcgQ29yZXN0b3JlVFgodmlldykKCiAgICB0cnkgewogICAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCB2aWV3KQogICAgICBjb25zdCBoZWFkUHJvbWlzZSA9IHJ4LmdldEhlYWQoKQoKICAgICAgcngudHJ5Rmx1c2goKQoKICAgICAgY29uc3QgaGVhZCA9IChhd2FpdCBoZWFkUHJvbWlzZSkgfHwgaW5pdFN0b3JlSGVhZCgpCgogICAgICBpZiAoaGVhZC5zZWVkID09PSBudWxsIHx8IG92ZXJ3cml0ZSkgaGVhZC5zZWVkID0gc2VlZAogICAgICB0eC5zZXRIZWFkKGhlYWQpCiAgICAgIHR4LmFwcGx5KCkKCiAgICAgIHJldHVybiBoZWFkLnNlZWQKICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IHRoaXMuX2V4aXQoKQogICAgfQogIH0KCiAgYXN5bmMgZ2V0RGVmYXVsdERpc2NvdmVyeUtleSgpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgRU1QVFkpCiAgICBjb25zdCBoZWFkUHJvbWlzZSA9IHJ4LmdldEhlYWQoKQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBoZWFkID0gYXdhaXQgaGVhZFByb21pc2UKICAgIHJldHVybiBoZWFkID09PSBudWxsID8gbnVsbCA6IGhlYWQuZGVmYXVsdERpc2NvdmVyeUtleQogIH0KCiAgYXN5bmMgc2V0RGVmYXVsdERpc2NvdmVyeUtleShkaXNjb3ZlcnlLZXksIHsgb3ZlcndyaXRlID0gdHJ1ZSB9ID0ge30pIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgY29uc3QgdmlldyA9IGF3YWl0IHRoaXMuX2VudGVyKCkKICAgIGNvbnN0IHR4ID0gbmV3IENvcmVzdG9yZVRYKHZpZXcpCgogICAgdHJ5IHsKICAgICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgdmlldykKICAgICAgY29uc3QgaGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKCiAgICAgIHJ4LnRyeUZsdXNoKCkKCiAgICAgIGNvbnN0IGhlYWQgPSAoYXdhaXQgaGVhZFByb21pc2UpIHx8IGluaXRTdG9yZUhlYWQoKQoKICAgICAgaWYgKGhlYWQuZGVmYXVsdERpc2NvdmVyeUtleSA9PT0gbnVsbCB8fCBvdmVyd3JpdGUpIGhlYWQuZGVmYXVsdERpc2NvdmVyeUtleSA9IGRpc2NvdmVyeUtleQogICAgICB0eC5zZXRIZWFkKGhlYWQpCiAgICAgIHR4LmFwcGx5KCkKCiAgICAgIHJldHVybiBoZWFkLmRlZmF1bHREaXNjb3ZlcnlLZXkKICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IHRoaXMuX2V4aXQoKQogICAgfQogIH0KCiAgYXN5bmMgaGFzQ29yZShkaXNjb3ZlcnlLZXksIHsgaWZNaWdyYXRlZCA9IGZhbHNlIH0gPSB7fSkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCBFTVBUWSkKICAgIGNvbnN0IHByb21pc2UgPSByeC5nZXRDb3JlKGRpc2NvdmVyeUtleSkKCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgY29yZSA9IGF3YWl0IHByb21pc2UKCiAgICBpZiAoY29yZSA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCiAgICBpZiAoY29yZS52ZXJzaW9uICE9PSBWRVJTSU9OICYmIGlmTWlncmF0ZWQpIHJldHVybiBmYWxzZQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBnZXRBdXRoKGRpc2NvdmVyeUtleSkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCBFTVBUWSkKICAgIGNvbnN0IGNvcmVQcm9taXNlID0gcnguZ2V0Q29yZShkaXNjb3ZlcnlLZXkpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IGNvcmUgPSBhd2FpdCBjb3JlUHJvbWlzZQogICAgaWYgKGNvcmUgPT09IG51bGwpIHJldHVybiBudWxsCgogICAgY29uc3QgcmVhZCA9IHRoaXMuZGIucmVhZCh7IGF1dG9EZXN0cm95OiB0cnVlIH0pCiAgICBjb25zdCBhdXRoUHJvbWlzZSA9IENvcmVSWC5nZXRBdXRoKHJlYWQsIGNvcmUpCgogICAgcmVhZC50cnlGbHVzaCgpCgogICAgcmV0dXJuIGF1dGhQcm9taXNlCiAgfQoKICBhc3luYyBnZXRJbmZvKGRpc2NvdmVyeUtleSwgb3B0cykgewogICAgcmV0dXJuIChhd2FpdCB0aGlzLmdldEluZm9zKFtkaXNjb3ZlcnlLZXldLCBvcHRzKSlbMF0KICB9CgogIGFzeW5jIGdldEluZm9zKGRpc2NvdmVyeUtleXMsIHsgYXV0aCA9IHRydWUsIGhlYWQgPSB0cnVlLCBoaW50cyA9IHRydWUgfSA9IHt9KSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSBhd2FpdCB0aGlzLl9taWdyYXRlU3RvcmUoKQoKICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIEVNUFRZKQogICAgY29uc3QgY29yZVByb21pc2VzID0gbmV3IEFycmF5KGRpc2NvdmVyeUtleXMubGVuZ3RoKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGlzY292ZXJ5S2V5cy5sZW5ndGg7IGkrKykgewogICAgICBjb3JlUHJvbWlzZXNbaV0gPSByeC5nZXRDb3JlKGRpc2NvdmVyeUtleXNbaV0pCiAgICB9CgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IGNvcmVzID0gYXdhaXQgUHJvbWlzZS5hbGwoY29yZVByb21pc2VzKQogICAgY29uc3QgcmVhZCA9IHRoaXMuZGIucmVhZCh7IGF1dG9EZXN0cm95OiB0cnVlIH0pCgogICAgY29uc3QgcmVzdWx0UHJvbWlzZXMgPSBuZXcgQXJyYXkoY29yZXMubGVuZ3RoKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29yZXMubGVuZ3RoOyBpKyspIHsKICAgICAgcmVzdWx0UHJvbWlzZXNbaV0gPSBjb3Jlc1tpXQogICAgICAgID8gZ2V0SW5mb0Zyb21CYXRjaChyZWFkLCBjb3Jlc1tpXSwgZGlzY292ZXJ5S2V5c1tpXSwgYXV0aCwgaGVhZCwgaGludHMpCiAgICAgICAgOiBudWxsCiAgICB9CgogICAgcmVhZC50cnlGbHVzaCgpCgogICAgcmV0dXJuIFByb21pc2UuYWxsKHJlc3VsdFByb21pc2VzKQogIH0KCiAgYXN5bmMgc3VzcGVuZCgpIHsKICAgIGF3YWl0IHRoaXMuZGIuc3VzcGVuZCgpCiAgICBpZiAodGhpcy5kZXZpY2VGaWxlKSBhd2FpdCB0aGlzLmRldmljZUZpbGUuc3VzcGVuZCgpCiAgfQoKICBhc3luYyByZXN1bWUoKSB7CiAgICBpZiAodGhpcy5kZXZpY2VGaWxlKSBhd2FpdCB0aGlzLmRldmljZUZpbGUucmVzdW1lKCkKICAgIGF3YWl0IHRoaXMuZGIucmVzdW1lKCkKICB9CgogIGFzeW5jIHJlc3VtZUNvcmUoZGlzY292ZXJ5S2V5KSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSBhd2FpdCB0aGlzLl9taWdyYXRlU3RvcmUoKQoKICAgIGlmICghZGlzY292ZXJ5S2V5KSB7CiAgICAgIGRpc2NvdmVyeUtleSA9IGF3YWl0IHRoaXMuZ2V0RGVmYXVsdERpc2NvdmVyeUtleSgpCiAgICAgIGlmICghZGlzY292ZXJ5S2V5KSByZXR1cm4gbnVsbAogICAgfQoKICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIEVNUFRZKQogICAgY29uc3QgY29yZVByb21pc2UgPSByeC5nZXRDb3JlKGRpc2NvdmVyeUtleSkKCiAgICByeC50cnlGbHVzaCgpCiAgICBjb25zdCBjb3JlID0gYXdhaXQgY29yZVByb21pc2UKCiAgICBpZiAoY29yZSA9PT0gbnVsbCkgcmV0dXJuIG51bGwKICAgIHJldHVybiB0aGlzLl9yZXN1bWVGcm9tUG9pbnRlcnMoRU1QVFksIGRpc2NvdmVyeUtleSwgZmFsc2UsIGNvcmUpCiAgfQoKICBhc3luYyBleHBvcnQoZGlzY292ZXJ5S2V5LCBvcHRzKSB7CiAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCBFTVBUWSkKICAgIGNvbnN0IGNvcmVQcm9taXNlID0gcnguZ2V0Q29yZShkaXNjb3ZlcnlLZXkpCgogICAgcngudHJ5Rmx1c2goKQogICAgY29uc3QgY29yZSA9IGF3YWl0IGNvcmVQcm9taXNlCiAgICBpZiAoY29yZSA9PT0gbnVsbCkgcmV0dXJuIG51bGwKCiAgICBsZXQgeyBkYXRhUG9pbnRlciwgY29yZVBvaW50ZXIgfSA9IGNvcmUKCiAgICBjb25zdCBwdHIgPSB7IGNvcmVQb2ludGVyLCBkYXRhUG9pbnRlciwgZGVwZW5kZW5jaWVzOiBbXSB9CgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgY29uc3QgcnggPSBuZXcgQ29yZVJYKHsgZGF0YVBvaW50ZXIsIGNvcmVQb2ludGVyOiAwLCBkZXBlbmRlbmNpZXM6IFtdIH0sIHRoaXMuZGIsIEVNUFRZKQogICAgICBjb25zdCBkZXBlbmRlbmN5UHJvbWlzZSA9IHJ4LmdldERlcGVuZGVuY3koKQogICAgICByeC50cnlGbHVzaCgpCiAgICAgIGNvbnN0IGRlcGVuZGVuY3kgPSBhd2FpdCBkZXBlbmRlbmN5UHJvbWlzZQogICAgICBpZiAoIWRlcGVuZGVuY3kpIGJyZWFrCiAgICAgIHB0ci5kZXBlbmRlbmNpZXMucHVzaChkZXBlbmRlbmN5KQogICAgICBkYXRhUG9pbnRlciA9IGRlcGVuZGVuY3kuZGF0YVBvaW50ZXIKICAgIH0KCiAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5kYi5zZXNzaW9uKCkKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCBIeXBlcmNvcmVTdG9yYWdlLmV4cG9ydChwdHIsIHNlc3Npb24sIG9wdHMpCiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCBzZXNzaW9uLmNsb3NlKCkKICAgIH0KICB9CgogIGFzeW5jIF9yZXN1bWVGcm9tUG9pbnRlcnModmlldywgZGlzY292ZXJ5S2V5LCBjcmVhdGUsIHsgdmVyc2lvbiwgY29yZVBvaW50ZXIsIGRhdGFQb2ludGVyIH0pIHsKICAgIGNvbnN0IGNvcmUgPSB7IGNvcmVQb2ludGVyLCBkYXRhUG9pbnRlciwgZGVwZW5kZW5jaWVzOiBbXSB9CgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgY29uc3QgcnggPSBuZXcgQ29yZVJYKHsgZGF0YVBvaW50ZXIsIGNvcmVQb2ludGVyOiAwLCBkZXBlbmRlbmNpZXM6IFtdIH0sIHRoaXMuZGIsIHZpZXcpCiAgICAgIGNvbnN0IGRlcGVuZGVuY3lQcm9taXNlID0gcnguZ2V0RGVwZW5kZW5jeSgpCiAgICAgIHJ4LnRyeUZsdXNoKCkKICAgICAgY29uc3QgZGVwZW5kZW5jeSA9IGF3YWl0IGRlcGVuZGVuY3lQcm9taXNlCiAgICAgIGlmICghZGVwZW5kZW5jeSkgYnJlYWsKICAgICAgY29yZS5kZXBlbmRlbmNpZXMucHVzaChkZXBlbmRlbmN5KQogICAgICBkYXRhUG9pbnRlciA9IGRlcGVuZGVuY3kuZGF0YVBvaW50ZXIKICAgIH0KCiAgICBjb25zdCByZXN1bHQgPSBuZXcgSHlwZXJjb3JlU3RvcmFnZSh0aGlzLCB0aGlzLmRiLnNlc3Npb24oKSwgY29yZSwgRU1QVFksIG51bGwpCgogICAgaWYgKHZlcnNpb24gPCBWRVJTSU9OKSBhd2FpdCB0aGlzLl9taWdyYXRlQ29yZShyZXN1bHQsIGRpc2NvdmVyeUtleSwgdmVyc2lvbiwgY3JlYXRlKQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgLy8gbm90IGFsbG93ZWQgdG8gdGhyb3cgdmFsaWRhdGlvbiBlcnJvcnMgYXMgaXRzIGEgc2hhcmVkIHR4IQogIGFzeW5jIF9jcmVhdGUoCiAgICB2aWV3LAogICAgeyBrZXksIG1hbmlmZXN0LCBrZXlQYWlyLCBlbmNyeXB0aW9uS2V5LCBkaXNjb3ZlcnlLZXksIGFsaWFzLCB1c2VyRGF0YSwgY29yZTogcHRycyB9CiAgKSB7CiAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCB2aWV3KQogICAgY29uc3QgdHggPSBuZXcgQ29yZXN0b3JlVFgodmlldykKCiAgICBjb25zdCBjb3JlUHJvbWlzZSA9IHJ4LmdldENvcmUoZGlzY292ZXJ5S2V5KQogICAgY29uc3QgaGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKCiAgICByeC50cnlGbHVzaCgpCgogICAgbGV0IFtjb3JlLCBoZWFkXSA9IGF3YWl0IFByb21pc2UuYWxsKFtjb3JlUHJvbWlzZSwgaGVhZFByb21pc2VdKQogICAgaWYgKGNvcmUpIHJldHVybiB0aGlzLl9yZXN1bWVGcm9tUG9pbnRlcnModmlldywgZGlzY292ZXJ5S2V5LCB0cnVlLCBjb3JlKQoKICAgIGlmIChoZWFkID09PSBudWxsKSBoZWFkID0gaW5pdFN0b3JlSGVhZCgpCiAgICBpZiAoaGVhZC5kZWZhdWx0RGlzY292ZXJ5S2V5ID09PSBudWxsKSBoZWFkLmRlZmF1bHREaXNjb3ZlcnlLZXkgPSBkaXNjb3ZlcnlLZXkKCiAgICBjb25zdCBjb3JlUG9pbnRlciA9IHB0cnMgPyBwdHJzLmNvcmVQb2ludGVyIDogaGVhZC5hbGxvY2F0ZWQuY29yZXMrKwogICAgY29uc3QgZGF0YVBvaW50ZXIgPSBwdHJzID8gcHRycy5kYXRhUG9pbnRlciA6IGhlYWQuYWxsb2NhdGVkLmRhdGFzKysKCiAgICBjb3JlID0geyB2ZXJzaW9uOiBWRVJTSU9OLCBjb3JlUG9pbnRlciwgZGF0YVBvaW50ZXIsIGFsaWFzIH0KCiAgICB0eC5zZXRIZWFkKGhlYWQpCiAgICB0eC5wdXRDb3JlKGRpc2NvdmVyeUtleSwgY29yZSkKICAgIGlmIChhbGlhcykgdHgucHV0Q29yZUJ5QWxpYXMoYWxpYXMsIGRpc2NvdmVyeUtleSkKCiAgICBjb25zdCBwdHIgPSB7IGNvcmVQb2ludGVyLCBkYXRhUG9pbnRlciwgZGVwZW5kZW5jaWVzOiBbXSB9CiAgICBjb25zdCBjdHggPSBuZXcgQ29yZVRYKHB0ciwgdGhpcy5kYiwgdmlldywgdHguY2hhbmdlcykKCiAgICBjdHguc2V0QXV0aCh7CiAgICAgIGtleSwKICAgICAgZGlzY292ZXJ5S2V5LAogICAgICBtYW5pZmVzdCwKICAgICAga2V5UGFpciwKICAgICAgZW5jcnlwdGlvbktleQogICAgfSkKCiAgICBpZiAodXNlckRhdGEpIHsKICAgICAgZm9yIChjb25zdCB7IGtleSwgdmFsdWUgfSBvZiB1c2VyRGF0YSkgewogICAgICAgIGN0eC5wdXRVc2VyRGF0YShrZXksIHZhbHVlKQogICAgICB9CiAgICB9CgogICAgdHguYXBwbHkoKQoKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlU3RvcmFnZSh0aGlzLCB0aGlzLmRiLnNlc3Npb24oKSwgcHRyLCBFTVBUWSwgbnVsbCkKICB9CgogIGFzeW5jIGNyZWF0ZUNvcmUoZGF0YSkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBjb25zdCB2aWV3ID0gYXdhaXQgdGhpcy5fZW50ZXIoKQoKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9jcmVhdGUodmlldywgZGF0YSkKICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IHRoaXMuX2V4aXQoKQogICAgfQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBDb3Jlc3RvcmVTdG9yYWdlCgpmdW5jdGlvbiBpbml0U3RvcmVIZWFkKCkgewogIHJldHVybiB7CiAgICB2ZXJzaW9uOiAwLCAvLyBjYXVzZSB3ZSB3YW5uYSBydW4gdGhlIG1pZ3JhdGlvbgogICAgYWxsb2NhdGVkOiB7CiAgICAgIGRhdGFzOiAwLAogICAgICBjb3JlczogMAogICAgfSwKICAgIHNlZWQ6IG51bGwsCiAgICBkZWZhdWx0RGlzY292ZXJ5S2V5OiBudWxsCiAgfQp9CgpmdW5jdGlvbiBnZXRCYXRjaChzZXNzaW9ucywgbmFtZSwgYWxsb2MpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IHNlc3Npb25zLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoc2Vzc2lvbnNbaV0ubmFtZSA9PT0gbmFtZSkgcmV0dXJuIHNlc3Npb25zW2ldCiAgfQoKICBpZiAoIWFsbG9jKSByZXR1cm4gbnVsbAoKICBjb25zdCByZXN1bHQgPSB7IG5hbWUsIGRhdGFQb2ludGVyOiAtMSB9CiAgc2Vzc2lvbnMucHVzaChyZXN1bHQpCiAgcmV0dXJuIHJlc3VsdAp9CgpmdW5jdGlvbiBpc0NvcmVzdG9yZVN0b3JhZ2UocykgewogIHJldHVybiB0eXBlb2YgcyA9PT0gJ29iamVjdCcgJiYgISFzICYmIHR5cGVvZiBzLnNldERlZmF1bHREaXNjb3ZlcnlLZXkgPT09ICdmdW5jdGlvbicKfQoKZnVuY3Rpb24gY3JlYXRlQ29sdW1uRmFtaWx5KGRiLCBvcHRzID0ge30pIHsKICBjb25zdCB7CiAgICB0YWJsZUNhY2hlSW5kZXhBbmRGaWx0ZXJCbG9ja3MgPSB0cnVlLAogICAgYmxvY2tDYWNoZSA9IHRydWUsCiAgICBvcHRpbWl6ZUZpbHRlcnNGb3JNZW1vcnkgPSBmYWxzZQogIH0gPSBvcHRzCgogIGNvbnN0IGNvbCA9IG5ldyBSb2Nrc0RCLkNvbHVtbkZhbWlseShDT0xVTU5fRkFNSUxZLCB7CiAgICBlbmFibGVCbG9iRmlsZXM6IHRydWUsCiAgICBtaW5CbG9iU2l6ZTogNDA5NiwKICAgIGJsb2JGaWxlU2l6ZTogMjU2ICogMTAyNCAqIDEwMjQsCiAgICBlbmFibGVCbG9iR2FyYmFnZUNvbGxlY3Rpb246IHRydWUsCiAgICB0YWJsZUJsb2NrU2l6ZTogODE5MiwKICAgIHRhYmxlQ2FjaGVJbmRleEFuZEZpbHRlckJsb2NrcywKICAgIHRhYmxlRm9ybWF0VmVyc2lvbjogNiwKICAgIG9wdGltaXplRmlsdGVyc0Zvck1lbW9yeSwKICAgIGJsb2NrQ2FjaGUKICB9KQoKICByZXR1cm4gZGIuY29sdW1uRmFtaWx5KGNvbCkKfQoKLy8gVE9ETzogcmVtb3ZlIGluIGxpa2UgMy02IG1vCmZ1bmN0aW9uIHRtcEZpeFN0b3JhZ2UocCkgewogIC8vIGlmIENPUkVTVE9SRSBmaWxlIGlzIHdyaXR0ZW4sIG5ldyBmb3JtYXQKICBpZiAoZnMuZXhpc3RzU3luYyhwYXRoLmpvaW4ocCwgJ0NPUkVTVE9SRScpKSkgcmV0dXJuCgogIGxldCBmaWxlcyA9IFtdCgogIHRyeSB7CiAgICBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKHApCiAgfSBjYXRjaCB7fQoKICBjb25zdCBub3RSb2NrcyA9IG5ldyBTZXQoWwogICAgJ0NPUkVTVE9SRScsCiAgICAncHJpbWFyeS1rZXknLAogICAgJ2NvcmVzJywKICAgICdhcHAtcHJlZmVyZW5jZXMnLAogICAgJ2NhY2hlJywKICAgICdwcmVmZXJlbmNlcy5qc29uJywKICAgICdkYicsCiAgICAnY2xvbmUnLAogICAgJ2NvcmUnLAogICAgJ25vdGlmaWNhdGlvbnMnCiAgXSkKCiAgZm9yIChjb25zdCBmIG9mIGZpbGVzKSB7CiAgICBpZiAobm90Um9ja3MuaGFzKGYpKSBjb250aW51ZQoKICAgIHRyeSB7CiAgICAgIGZzLm1rZGlyU3luYyhwYXRoLmpvaW4ocCwgJ2RiJykpCiAgICB9IGNhdGNoIHt9CgogICAgZnMucmVuYW1lU3luYyhwYXRoLmpvaW4ocCwgZiksIHBhdGguam9pbihwLCAnZGInLCBmKSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGV4cG9ydERhdGEocHRyLCBkYiwgb3B0cykgewogIC8vIGp1c3QgbmVlZCBkYXRhUG9pbnRlcgogIGNvbnN0IHJlYWRzID0gWwogICAgdG9BcnJheShjcmVhdGVCbG9ja1N0cmVhbShwdHIsIGRiLCBFTVBUWSwgb3B0cykpLAogICAgdG9BcnJheShjcmVhdGVUcmVlTm9kZVN0cmVhbShwdHIsIGRiLCBFTVBUWSwgb3B0cykpLAogICAgdG9BcnJheShjcmVhdGVCaXRmaWVsZFN0cmVhbShwdHIsIGRiLCBFTVBUWSwgb3B0cykpCiAgXQoKICBjb25zdCBbYmxvY2tzLCB0cmVlLCBiaXRmaWVsZF0gPSBhd2FpdCBQcm9taXNlLmFsbChyZWFkcykKCiAgcmV0dXJuIHsKICAgIGJsb2NrcywKICAgIHRyZWUsCiAgICBiaXRmaWVsZAogIH0KfQoKYXN5bmMgZnVuY3Rpb24gdG9BcnJheShzdHJlYW0pIHsKICBjb25zdCBhbGwgPSBbXQogIGZvciBhd2FpdCAoY29uc3QgZSBvZiBzdHJlYW0pIGFsbC5wdXNoKGUpCiAgcmV0dXJuIGFsbAp9CgpmdW5jdGlvbiBub29wKCkge30KCmFzeW5jIGZ1bmN0aW9uIGdldEluZm9Gcm9tQmF0Y2goZGIsIGMsIGRpc2NvdmVyeUtleSwgZ2V0QXV0aCwgZ2V0SGVhZCwgZ2V0SGludHMpIHsKICBjb25zdCBhdXRoUHJvbWlzZSA9IGdldEF1dGggPyBDb3JlUlguZ2V0QXV0aChkYiwgYykgOiBudWxsCiAgY29uc3QgaGVhZFByb21pc2UgPSBnZXRIZWFkID8gQ29yZVJYLmdldEhlYWQoZGIsIGMpIDogbnVsbAogIGNvbnN0IGhpbnRzUHJvbWlzZSA9IGdldEhpbnRzID8gQ29yZVJYLmdldEhpbnRzKGRiLCBjKSA6IG51bGwKCiAgLy8gZW5zdXJlIG5vIHVuY2F1Z2h0cwogIGlmIChhdXRoUHJvbWlzZSkgYXV0aFByb21pc2UuY2F0Y2gobm9vcCkKICBpZiAoaGVhZFByb21pc2UpIGhlYWRQcm9taXNlLmNhdGNoKG5vb3ApCiAgaWYgKGhpbnRzUHJvbWlzZSkgaGludHNQcm9taXNlLmNhdGNoKG5vb3ApCgogIHJldHVybiB7CiAgICBkaXNjb3ZlcnlLZXksCiAgICBjb3JlOiBjLAogICAgYXV0aDogYXdhaXQgYXV0aFByb21pc2UsCiAgICBoZWFkOiBhd2FpdCBoZWFkUHJvbWlzZSwKICAgIGhpbnRzOiBhd2FpdCBoaW50c1Byb21pc2UKICB9Cn0KY29uc3QgeyBSZWFkYWJsZSwgZ2V0U3RyZWFtRXJyb3IgfSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQpjb25zdCB7IGNvcmUgfSA9IHJlcXVpcmUoJy4va2V5cycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEJsb2NrU3RyZWFtIGV4dGVuZHMgUmVhZGFibGUgewogIGNvbnN0cnVjdG9yKGNvcmUsIGRiLCB1cGRhdGVzLCBzdGFydCwgZW5kLCByZXZlcnNlKSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy5kYiA9IGRiCiAgICB0aGlzLnVwZGF0ZXMgPSB1cGRhdGVzCiAgICB0aGlzLnN0YXJ0ID0gc3RhcnQKICAgIHRoaXMuZW5kID0gZW5kCiAgICB0aGlzLnJldmVyc2UgPSByZXZlcnNlID09PSB0cnVlCgogICAgdGhpcy5fZHJhaW5lZCA9IHRydWUKICAgIHRoaXMuX2NvbnN1bWVkID0gMAogICAgdGhpcy5fc3RyZWFtID0gbnVsbAogICAgdGhpcy5fb25jbG9zZUJvdW5kID0gdGhpcy5fb25jbG9zZS5iaW5kKHRoaXMpCiAgICB0aGlzLl9tYXliZURyYWluQm91bmQgPSB0aGlzLl9tYXliZURyYWluLmJpbmQodGhpcykKCiAgICB0aGlzLl91cGRhdGUoKQogIH0KCiAgX3VwZGF0ZSgpIHsKICAgIGlmICh0aGlzLl9jb25zdW1lZCA+IHRoaXMuY29yZS5kZXBlbmRlbmNpZXMubGVuZ3RoKSByZXR1cm4KCiAgICBjb25zdCBkZXBzID0gdGhpcy5jb3JlLmRlcGVuZGVuY2llcwogICAgY29uc3QgaW5kZXggPSB0aGlzLl9maW5kRGVwZW5kZW5jeUluZGV4KGRlcHMpCgogICAgY29uc3QgY3VyciA9IGluZGV4IDwgZGVwcy5sZW5ndGggPyBkZXBzW2luZGV4XSA6IG51bGwKICAgIGNvbnN0IHByZXYgPSBpbmRleCA+IDAgJiYgaW5kZXggLSAxIDwgZGVwcy5sZW5ndGggPyBkZXBzW2luZGV4IC0gMV0gOiBudWxsCgogICAgY29uc3Qgc3RhcnQgPSBwcmV2ICYmIHByZXYubGVuZ3RoID4gdGhpcy5zdGFydCA/IHByZXYubGVuZ3RoIDogdGhpcy5zdGFydAogICAgY29uc3QgZW5kID0gY3VyciAmJiAodGhpcy5lbmQgPT09IC0xIHx8IGN1cnIubGVuZ3RoIDwgdGhpcy5lbmQpID8gY3Vyci5sZW5ndGggOiB0aGlzLmVuZAoKICAgIGNvbnN0IHB0ciA9IGN1cnIgPyBjdXJyLmRhdGFQb2ludGVyIDogdGhpcy5jb3JlLmRhdGFQb2ludGVyCgogICAgdGhpcy5fbWFrZVN0cmVhbShjb3JlLmJsb2NrKHB0ciwgc3RhcnQpLCBjb3JlLmJsb2NrKHB0ciwgZW5kKSkKICB9CgogIF9maW5kRGVwZW5kZW5jeUluZGV4KGRlcHMpIHsKICAgIGlmICghdGhpcy5yZXZlcnNlKSByZXR1cm4gdGhpcy5fY29uc3VtZWQrKwoKICAgIGxldCBpID0gZGVwcy5sZW5ndGggLSB0aGlzLl9jb25zdW1lZCsrCiAgICB3aGlsZSAoaSA+IDApIHsKICAgICAgaWYgKGRlcHNbaSAtIDFdLmxlbmd0aCA8PSB0aGlzLmVuZCkgcmV0dXJuIGkKICAgICAgaS0tCiAgICAgIHRoaXMuX2NvbnN1bWVkKysKICAgIH0KCiAgICByZXR1cm4gMAogIH0KCiAgX3ByZWRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5fc3RyZWFtICE9PSBudWxsKSB0aGlzLl9zdHJlYW0uZGVzdHJveSgpCiAgfQoKICBfcmVhZChjYikgewogICAgdGhpcy5fZHJhaW5lZCA9IHRoaXMuX29ucmVhZGFibGUoKQogICAgY2IobnVsbCkKICB9CgogIF9tYXliZURyYWluKCkgewogICAgaWYgKHRoaXMuX2RyYWluZWQgPT09IHRydWUpIHJldHVybgogICAgdGhpcy5fZHJhaW5lZCA9IHRoaXMuX29ucmVhZGFibGUoKQogIH0KCiAgX29ucmVhZGFibGUoKSB7CiAgICBpZiAodGhpcy5fc3RyZWFtID09PSBudWxsKSB7CiAgICAgIHRoaXMucHVzaChudWxsKQogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGxldCBkYXRhID0gdGhpcy5fc3RyZWFtLnJlYWQoKQoKICAgIGlmIChkYXRhID09PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgICBkbyB7CiAgICAgIHRoaXMucHVzaChkYXRhKQogICAgICBkYXRhID0gdGhpcy5fc3RyZWFtLnJlYWQoKQogICAgfSB3aGlsZSAoZGF0YSAhPT0gbnVsbCkKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX29uY2xvc2UoKSB7CiAgICBpZiAodGhpcy5kZXN0cm95aW5nKSByZXR1cm4KCiAgICBjb25zdCBlcnIgPSBnZXRTdHJlYW1FcnJvcih0aGlzLl9zdHJlYW0pCgogICAgaWYgKGVyciAhPT0gbnVsbCkgewogICAgICB0aGlzLmRlc3Ryb3koZXJyKQogICAgICByZXR1cm4KICAgIH0KCiAgICAvLyBlbXB0eSB0aGUgY3VycmVudCBzdHJlYW0KICAgIGlmICh0aGlzLl9vbnJlYWRhYmxlKCkgPT09IHRydWUpIHRoaXMuX2RyYWluZWQgPSB0cnVlCgogICAgdGhpcy5fc3RyZWFtID0gbnVsbAoKICAgIHRoaXMuX3VwZGF0ZSgpCiAgICB0aGlzLl9tYXliZURyYWluKCkKICB9CgogIF9tYWtlU3RyZWFtKHN0YXJ0LCBlbmQpIHsKICAgIHRoaXMuX3N0cmVhbSA9IHRoaXMudXBkYXRlcy5pdGVyYXRvcih0aGlzLmRiLCBzdGFydCwgZW5kLCB0aGlzLnJldmVyc2UpCiAgICB0aGlzLl9zdHJlYW0ub24oJ3JlYWRhYmxlJywgdGhpcy5fbWF5YmVEcmFpbkJvdW5kKQogICAgdGhpcy5fc3RyZWFtLm9uKCdlcnJvcicsIG5vb3ApCiAgICB0aGlzLl9zdHJlYW0ub24oJ2Nsb3NlJywgdGhpcy5fb25jbG9zZUJvdW5kKQogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IHsgUmVhZGFibGUgfSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQoKLy8gdXNlZCBmb3IgcmV0dXJuZWQgYSBzdHJlYW0gdGhhdCBqdXN0IGVycm9ycyAoZHVyaW5nIHJlYWQgZHVyaW5nIHRlYXJkb3duKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBDbG9zZUVycm9yU3RyZWFtIGV4dGVuZHMgUmVhZGFibGUgewogIGNvbnN0cnVjdG9yKGVycikgewogICAgc3VwZXIoKQogICAgdGhpcy5lcnJvciA9IGVycgogIH0KCiAgX29wZW4oY2IpIHsKICAgIGNiKHRoaXMuZXJyb3IpCiAgfQp9CmNvbnN0IHsgVUlOVCwgU1RSSU5HIH0gPSByZXF1aXJlKCdpbmRleC1lbmNvZGVyJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgVExfSEVBRCA9IDAKY29uc3QgVExfQ09SRV9CWV9ES0VZID0gMQpjb25zdCBUTF9DT1JFX0JZX0FMSUFTID0gMgpjb25zdCBUTF9DT1JFID0gMwpjb25zdCBUTF9EQVRBID0gNAoKY29uc3QgVExfRU5EID0gVExfREFUQSArIDEKCmNvbnN0IENPUkVfQVVUSCA9IDAKY29uc3QgQ09SRV9TRVNTSU9OUyA9IDEKCmNvbnN0IERBVEFfSEVBRCA9IDAKY29uc3QgREFUQV9ERVBFTkRFTkNZID0gMQpjb25zdCBEQVRBX0hJTlRTID0gMgpjb25zdCBEQVRBX0JMT0NLID0gMwpjb25zdCBEQVRBX1RSRUUgPSA0CmNvbnN0IERBVEFfQklURklFTEQgPSA1CmNvbnN0IERBVEFfVVNFUl9EQVRBID0gNgpjb25zdCBEQVRBX0xPQ0FMID0gNwoKY29uc3Qgc2xhYiA9IHsgYnVmZmVyOiBiNGEuYWxsb2NVbnNhZmUoNjU1MzYpLCBzdGFydDogMCwgZW5kOiAwIH0KCmNvbnN0IHN0b3JlID0ge30KY29uc3QgY29yZSA9IHt9CgpzdG9yZS5jbGVhciA9IGZ1bmN0aW9uICgpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBsZXQgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCAwKQogIGNvbnN0IGEgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQogIHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfRU5EKQogIGNvbnN0IGIgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQogIHJldHVybiBbYSwgYl0KfQoKc3RvcmUuaGVhZCA9IGZ1bmN0aW9uICgpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0hFQUQpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCnN0b3JlLmNvcmUgPSBmdW5jdGlvbiAoZGlzY292ZXJ5S2V5KSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9DT1JFX0JZX0RLRVkpCiAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgZGlzY292ZXJ5S2V5KQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9CgpzdG9yZS5jb3JlU3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9DT1JFX0JZX0RLRVkpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCnN0b3JlLmNvcmVFbmQgPSBmdW5jdGlvbiAoKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9DT1JFX0JZX0RLRVkgKyAxKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9CgpzdG9yZS5jb3JlQnlBbGlhcyA9IGZ1bmN0aW9uICh7IG5hbWVzcGFjZSwgbmFtZSB9KSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9DT1JFX0JZX0FMSUFTKQogIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG5hbWVzcGFjZSkKICBTVFJJTkcuZW5jb2RlKHN0YXRlLCBuYW1lKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9CgpzdG9yZS5jb3JlQnlBbGlhc1N0YXJ0ID0gZnVuY3Rpb24gKG5hbWVzcGFjZSkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRV9CWV9BTElBUykKICBpZiAobmFtZXNwYWNlKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBuYW1lc3BhY2UpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCnN0b3JlLmNvcmVCeUFsaWFzRW5kID0gZnVuY3Rpb24gKG5hbWVzcGFjZSkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKCiAgaWYgKG5hbWVzcGFjZSkgewogICAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0NPUkVfQllfQUxJQVMpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBuYW1lc3BhY2UpCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweGZmCiAgfSBlbHNlIHsKICAgIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9DT1JFX0JZX0FMSUFTICsgMSkKICB9CgogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9CgpzdG9yZS5hbGlhcyA9IGZ1bmN0aW9uIChidWZmZXIpIHsKICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyLCBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCB9CiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIG5zCiAgY29uc3QgbmFtZXNwYWNlID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICBjb25zdCBuYW1lID0gU1RSSU5HLmRlY29kZShzdGF0ZSkKICByZXR1cm4geyBuYW1lc3BhY2UsIG5hbWUgfQp9CgpzdG9yZS5kaXNjb3ZlcnlLZXkgPSBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlciwgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGggfQogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBucwogIHJldHVybiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQp9Cgpjb3JlLmNvcmUgPSBmdW5jdGlvbiAocHRyKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9DT1JFKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUuZGF0YSA9IGZ1bmN0aW9uIChwdHIpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0RBVEEpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS5hdXRoID0gZnVuY3Rpb24gKHB0cikgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBDT1JFX0FVVEgpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUuc2Vzc2lvbnMgPSBmdW5jdGlvbiAocHRyKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9DT1JFKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIENPUkVfU0VTU0lPTlMpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUuaGVhZCA9IGZ1bmN0aW9uIChwdHIpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0RBVEEpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgREFUQV9IRUFEKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLmRlcGVuZGVuY3kgPSBmdW5jdGlvbiAocHRyKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfREVQRU5ERU5DWSkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS5oaW50cyA9IGZ1bmN0aW9uIChwdHIpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0RBVEEpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgREFUQV9ISU5UUykKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS5ibG9jayA9IGZ1bmN0aW9uIChwdHIsIGluZGV4KSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfQkxPQ0spCiAgVUlOVC5lbmNvZGUoc3RhdGUsIGluZGV4KQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLnRyZWUgPSBmdW5jdGlvbiAocHRyLCBpbmRleCkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfREFUQSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBEQVRBX1RSRUUpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIGluZGV4KQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLmJpdGZpZWxkID0gZnVuY3Rpb24gKHB0ciwgaW5kZXgsIHR5cGUpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0RBVEEpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgREFUQV9CSVRGSUVMRCkKICBVSU5ULmVuY29kZShzdGF0ZSwgaW5kZXgpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHR5cGUpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUudXNlckRhdGEgPSBmdW5jdGlvbiAocHRyLCBrZXkpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0RBVEEpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgREFUQV9VU0VSX0RBVEEpCiAgU1RSSU5HLmVuY29kZShzdGF0ZSwga2V5KQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLnVzZXJEYXRhRW5kID0gZnVuY3Rpb24gKHB0cikgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfREFUQSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBEQVRBX1VTRVJfREFUQSArIDEpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUubG9jYWwgPSBmdW5jdGlvbiAocHRyLCBrZXkpIHsKICBpZiAoa2V5LmJ5dGVMZW5ndGggPiAyMDQ4KSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ2xvY2FsIGtleXMgaGFzIGFuIHVwcGVyIGxpbWl0IG9mIDIwNDggYnl0ZXMgYXRtJykKICB9CgogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfREFUQSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBEQVRBX0xPQ0FMKQoKICBzdGF0ZS5idWZmZXIuc2V0KGtleSwgc3RhdGUuc3RhcnQpCiAgc3RhdGUuc3RhcnQgKz0ga2V5LmJ5dGVMZW5ndGgKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS5sb2NhbEVuZCA9IGZ1bmN0aW9uIChwdHIpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0RBVEEpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgREFUQV9MT0NBTCArIDEpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUuYmxvY2tJbmRleCA9IGZ1bmN0aW9uIChidWZmZXIpIHsKICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyLCBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCB9CiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIG5zCiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIHB0cgogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyB0eXBlCiAgcmV0dXJuIFVJTlQuZGVjb2RlKHN0YXRlKQp9Cgpjb3JlLmJpdGZpZWxkSW5kZXhBbmRUeXBlID0gZnVuY3Rpb24gKGJ1ZmZlcikgewogIGNvbnN0IHN0YXRlID0geyBidWZmZXIsIHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoIH0KICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gbnMKICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gcHRyCiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIHR5cGUKICByZXR1cm4gW1VJTlQuZGVjb2RlKHN0YXRlKSwgVUlOVC5kZWNvZGUoc3RhdGUpXQp9Cgpjb3JlLnVzZXJEYXRhS2V5ID0gZnVuY3Rpb24gKGJ1ZmZlcikgewogIGNvbnN0IHN0YXRlID0geyBidWZmZXIsIHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoIH0KICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gbnMKICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gcHRyCiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIHR5cGUKICByZXR1cm4gU1RSSU5HLmRlY29kZShzdGF0ZSkKfQoKY29yZS5sb2NhbEtleSA9IGZ1bmN0aW9uIChidWZmZXIpIHsKICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyLCBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCB9CiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIG5zCiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIHB0cgogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyB0eXBlCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCwgc3RhdGUuZW5kKQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsgc3RvcmUsIGNvcmUgfQoKZnVuY3Rpb24gYWxsb2MoKSB7CiAgaWYgKHNsYWIuYnVmZmVyLmJ5dGVMZW5ndGggLSBzbGFiLnN0YXJ0IDwgNDA5NikgewogICAgc2xhYi5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc2xhYi5idWZmZXIuYnl0ZUxlbmd0aCkKICAgIHNsYWIuc3RhcnQgPSAwCiAgfQogIHJldHVybiBzbGFiCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgQmxvY2tEZXBlbmRlbmN5U3RyZWFtID0gcmVxdWlyZSgnLi9ibG9jay1kZXBlbmRlbmN5LXN0cmVhbS5qcycpCmNvbnN0IHsgY29yZSwgc3RvcmUgfSA9IHJlcXVpcmUoJy4va2V5cy5qcycpCmNvbnN0IHNjaGVtYSA9IHJlcXVpcmUoJy4uL3NwZWMvaHlwZXJzY2hlbWEnKQoKY29uc3QgQ09SRVNUT1JFX0NPUkUgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0Bjb3Jlc3RvcmUvY29yZScpCmNvbnN0IENPUkVfVFJFRV9OT0RFID0gc2NoZW1hLmdldEVuY29kaW5nKCdAY29yZS90cmVlLW5vZGUnKQpjb25zdCBFTVBUWSA9IGI0YS5hbGxvYygwKQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgY3JlYXRlQmxvY2tTdHJlYW0sCiAgY3JlYXRlQml0ZmllbGRTdHJlYW0sCiAgY3JlYXRlVXNlckRhdGFTdHJlYW0sCiAgY3JlYXRlQ29yZVN0cmVhbSwKICBjcmVhdGVBbGlhc1N0cmVhbSwKICBjcmVhdGVEaXNjb3ZlcnlLZXlTdHJlYW0sCiAgY3JlYXRlVHJlZU5vZGVTdHJlYW0sCiAgY3JlYXRlTG9jYWxTdHJlYW0KfQoKZnVuY3Rpb24gY3JlYXRlQ29yZVN0cmVhbShkYiwgdmlldykgewogIGNvbnN0IHN0YXJ0ID0gc3RvcmUuY29yZVN0YXJ0KCkKICBjb25zdCBlbmQgPSBzdG9yZS5jb3JlRW5kKCkKCiAgY29uc3QgaXRlID0gdmlldy5pdGVyYXRvcihkYiwgc3RhcnQsIGVuZCwgZmFsc2UpCgogIGl0ZS5fcmVhZGFibGVTdGF0ZS5tYXAgPSBtYXBDb3JlCiAgcmV0dXJuIGl0ZQp9CgpmdW5jdGlvbiBjcmVhdGVEaXNjb3ZlcnlLZXlTdHJlYW0oZGIsIHZpZXcsIG5hbWVzcGFjZSkgewogIGNvbnN0IHN0YXJ0ID0gbmFtZXNwYWNlID8gc3RvcmUuY29yZUJ5QWxpYXNTdGFydChuYW1lc3BhY2UpIDogc3RvcmUuY29yZVN0YXJ0KCkKICBjb25zdCBlbmQgPSBuYW1lc3BhY2UgPyBzdG9yZS5jb3JlQnlBbGlhc0VuZChuYW1lc3BhY2UpIDogc3RvcmUuY29yZUVuZCgpCgogIGNvbnN0IGl0ZSA9IHZpZXcuaXRlcmF0b3IoZGIsIHN0YXJ0LCBlbmQsIGZhbHNlKQoKICBpdGUuX3JlYWRhYmxlU3RhdGUubWFwID0gbmFtZXNwYWNlID8gbWFwTmFtZXNwYWNlRGlzY292ZXJ5S2V5cyA6IG1hcEFsbERpc2NvdmVyeUtleXMKICByZXR1cm4gaXRlCn0KCmZ1bmN0aW9uIGNyZWF0ZUFsaWFzU3RyZWFtKGRiLCB2aWV3LCBuYW1lc3BhY2UpIHsKICBjb25zdCBzdGFydCA9IHN0b3JlLmNvcmVCeUFsaWFzU3RhcnQobmFtZXNwYWNlKQogIGNvbnN0IGVuZCA9IHN0b3JlLmNvcmVCeUFsaWFzRW5kKG5hbWVzcGFjZSkKCiAgY29uc3QgaXRlID0gdmlldy5pdGVyYXRvcihkYiwgc3RhcnQsIGVuZCwgZmFsc2UpCgogIGl0ZS5fcmVhZGFibGVTdGF0ZS5tYXAgPSBtYXBBbGlhcwogIHJldHVybiBpdGUKfQoKZnVuY3Rpb24gY3JlYXRlQmxvY2tJdGVyYXRvcihwdHIsIGRiLCB2aWV3LCBzdGFydCwgZW5kLCByZXZlcnNlKSB7CiAgaWYgKHB0ci5kZXBlbmRlbmNpZXMubGVuZ3RoID4gMCkgewogICAgcmV0dXJuIG5ldyBCbG9ja0RlcGVuZGVuY3lTdHJlYW0ocHRyLCBkYiwgdmlldywgc3RhcnQsIGVuZCwgcmV2ZXJzZSkKICB9CgogIGNvbnN0IHMgPSBjb3JlLmJsb2NrKHB0ci5kYXRhUG9pbnRlciwgc3RhcnQpCiAgY29uc3QgZSA9IGNvcmUuYmxvY2socHRyLmRhdGFQb2ludGVyLCBlbmQgPT09IC0xID8gSW5maW5pdHkgOiBlbmQpCiAgcmV0dXJuIHZpZXcuaXRlcmF0b3IoZGIsIHMsIGUsIHJldmVyc2UpCn0KCmZ1bmN0aW9uIGNyZWF0ZUJsb2NrU3RyZWFtKAogIHB0ciwKICBkYiwKICB2aWV3LAogIHsgZ3QgPSAtMSwgZ3RlID0gZ3QgKyAxLCBsdGUgPSAtMSwgbHQgPSBsdGUgPT09IC0xID8gLTEgOiBsdGUgKyAxLCByZXZlcnNlID0gZmFsc2UgfSA9IHt9CikgewogIGNvbnN0IGl0ZSA9IGNyZWF0ZUJsb2NrSXRlcmF0b3IocHRyLCBkYiwgdmlldywgZ3RlLCBsdCwgcmV2ZXJzZSkKCiAgaXRlLl9yZWFkYWJsZVN0YXRlLm1hcCA9IG1hcEJsb2NrCiAgcmV0dXJuIGl0ZQp9CgpmdW5jdGlvbiBjcmVhdGVCaXRmaWVsZFN0cmVhbSgKICBwdHIsCiAgZGIsCiAgdmlldywKICB7IGd0ID0gLTEsIGd0ZSA9IGd0ICsgMSwgbHRlID0gLTEsIGx0ID0gbHRlID09PSAtMSA/IC0xIDogbHRlICsgMSwgcmV2ZXJzZSA9IGZhbHNlIH0gPSB7fQopIHsKICBjb25zdCBzID0gY29yZS5iaXRmaWVsZChwdHIuZGF0YVBvaW50ZXIsIGd0ZSwgMCkKICBjb25zdCBlID0gY29yZS5iaXRmaWVsZChwdHIuZGF0YVBvaW50ZXIsIGx0ID09PSAtMSA/IEluZmluaXR5IDogbHQsIDApCiAgY29uc3QgaXRlID0gdmlldy5pdGVyYXRvcihkYiwgcywgZSwgZmFsc2UpCgogIGl0ZS5fcmVhZGFibGVTdGF0ZS5tYXAgPSBtYXBCaXRmaWVsZAogIHJldHVybiBpdGUKfQoKLy8gTk9URTogdGhpcyBkb2VzIG5vdCBkbyBkZXBlbmRlbmN5IGxvb2t1cHMgYXRtCmZ1bmN0aW9uIGNyZWF0ZVRyZWVOb2RlU3RyZWFtKAogIHB0ciwKICBkYiwKICB2aWV3LAogIHsgZ3QgPSAtMSwgZ3RlID0gZ3QgKyAxLCBsdGUgPSAtMSwgbHQgPSBsdGUgPT09IC0xID8gLTEgOiBsdGUgKyAxLCByZXZlcnNlID0gZmFsc2UgfSA9IHt9CikgewogIGNvbnN0IHMgPSBjb3JlLnRyZWUocHRyLmRhdGFQb2ludGVyLCBndGUsIDApCiAgY29uc3QgZSA9IGNvcmUudHJlZShwdHIuZGF0YVBvaW50ZXIsIGx0ID09PSAtMSA/IEluZmluaXR5IDogbHQsIDApCiAgY29uc3QgaXRlID0gdmlldy5pdGVyYXRvcihkYiwgcywgZSwgZmFsc2UpCgogIGl0ZS5fcmVhZGFibGVTdGF0ZS5tYXAgPSBtYXBUcmVlTm9kZQogIHJldHVybiBpdGUKfQoKZnVuY3Rpb24gY3JlYXRlVXNlckRhdGFTdHJlYW0oCiAgcHRyLAogIGRiLAogIHZpZXcsCiAgeyBndCA9IG51bGwsIGd0ZSA9ICcnLCBsdGUgPSBudWxsLCBsdCA9IG51bGwsIHJldmVyc2UgPSBmYWxzZSB9ID0ge30KKSB7CiAgaWYgKGd0ICE9PSBudWxsIHx8IGx0ZSAhPT0gbnVsbCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdndCBhbmQgbHRlIG5vdCB5ZXQgc3VwcG9ydGVkIGZvciB1c2VyIGRhdGEgc3RyZWFtcycpCiAgfQoKICBjb25zdCBzID0gY29yZS51c2VyRGF0YShwdHIuZGF0YVBvaW50ZXIsIGd0ZSkKICBjb25zdCBlID0gbHQgPT09IG51bGwgPyBjb3JlLnVzZXJEYXRhRW5kKHB0ci5kYXRhUG9pbnRlcikgOiBjb3JlLnVzZXJEYXRhKHB0ci5kYXRhUG9pbnRlciwgbHQpCiAgY29uc3QgaXRlID0gdmlldy5pdGVyYXRvcihkYiwgcywgZSwgZmFsc2UpCgogIGl0ZS5fcmVhZGFibGVTdGF0ZS5tYXAgPSBtYXBVc2VyRGF0YQogIHJldHVybiBpdGUKfQoKZnVuY3Rpb24gY3JlYXRlTG9jYWxTdHJlYW0oCiAgcHRyLAogIGRiLAogIHZpZXcsCiAgeyBndCA9IG51bGwsIGd0ZSA9IEVNUFRZLCBsdGUgPSBudWxsLCBsdCA9IG51bGwsIHJldmVyc2UgPSBmYWxzZSB9ID0ge30KKSB7CiAgaWYgKGd0ICE9PSBudWxsIHx8IGx0ZSAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdndCBhbmQgbHRlIG5vdCB5ZXQgc3VwcG9ydGVkIGZvciBsb2NhbCBzdHJlYW1zJykKCiAgY29uc3QgcyA9IGNvcmUubG9jYWwocHRyLmRhdGFQb2ludGVyLCBndGUpCiAgY29uc3QgZSA9IGx0ID09PSBudWxsID8gY29yZS5sb2NhbEVuZChwdHIuZGF0YVBvaW50ZXIpIDogY29yZS5sb2NhbChwdHIuZGF0YVBvaW50ZXIsIGx0KQogIGNvbnN0IGl0ZSA9IHZpZXcuaXRlcmF0b3IoZGIsIHMsIGUsIGZhbHNlKQoKICBpdGUuX3JlYWRhYmxlU3RhdGUubWFwID0gbWFwTG9jYWwKICByZXR1cm4gaXRlCn0KCmZ1bmN0aW9uIG1hcEJpdGZpZWxkKGRhdGEpIHsKICBjb25zdCBbaW5kZXgsIHR5cGVdID0gY29yZS5iaXRmaWVsZEluZGV4QW5kVHlwZShkYXRhLmtleSkKICBpZiAodHlwZSAhPT0gMCkgcmV0dXJuIG51bGwgLy8gaWdub3JlIGZvciBub3cKICByZXR1cm4geyBpbmRleCwgcGFnZTogZGF0YS52YWx1ZSB9Cn0KCmZ1bmN0aW9uIG1hcExvY2FsKGRhdGEpIHsKICBjb25zdCBrZXkgPSBjb3JlLmxvY2FsS2V5KGRhdGEua2V5KQogIHJldHVybiB7IGtleSwgdmFsdWU6IGRhdGEudmFsdWUgfQp9CgpmdW5jdGlvbiBtYXBVc2VyRGF0YShkYXRhKSB7CiAgY29uc3Qga2V5ID0gY29yZS51c2VyRGF0YUtleShkYXRhLmtleSkKICByZXR1cm4geyBrZXksIHZhbHVlOiBkYXRhLnZhbHVlIH0KfQoKZnVuY3Rpb24gbWFwQ29yZShkYXRhKSB7CiAgY29uc3QgZGlzY292ZXJ5S2V5ID0gc3RvcmUuZGlzY292ZXJ5S2V5KGRhdGEua2V5KQogIGNvbnN0IGNvcmUgPSBDT1JFU1RPUkVfQ09SRS5kZWNvZGUoewogICAgc3RhcnQ6IDAsCiAgICBlbmQ6IGRhdGEudmFsdWUuYnl0ZUxlbmd0aCwKICAgIGJ1ZmZlcjogZGF0YS52YWx1ZQogIH0pCiAgcmV0dXJuIHsgZGlzY292ZXJ5S2V5LCBjb3JlIH0KfQoKZnVuY3Rpb24gbWFwQWxsRGlzY292ZXJ5S2V5cyhkYXRhKSB7CiAgcmV0dXJuIHN0b3JlLmRpc2NvdmVyeUtleShkYXRhLmtleSkKfQoKZnVuY3Rpb24gbWFwTmFtZXNwYWNlRGlzY292ZXJ5S2V5cyhkYXRhKSB7CiAgcmV0dXJuIGRhdGEudmFsdWUKfQoKZnVuY3Rpb24gbWFwQWxpYXMoZGF0YSkgewogIGNvbnN0IGFsaWFzID0gc3RvcmUuYWxpYXMoZGF0YS5rZXkpCiAgcmV0dXJuIHsgYWxpYXMsIGRpc2NvdmVyeUtleTogZGF0YS52YWx1ZSB9Cn0KCmZ1bmN0aW9uIG1hcEJsb2NrKGRhdGEpIHsKICByZXR1cm4geyBpbmRleDogY29yZS5ibG9ja0luZGV4KGRhdGEua2V5KSwgdmFsdWU6IGRhdGEudmFsdWUgfQp9CgpmdW5jdGlvbiBtYXBUcmVlTm9kZShkYXRhKSB7CiAgcmV0dXJuIENPUkVfVFJFRV9OT0RFLmRlY29kZSh7CiAgICBzdGFydDogMCwKICAgIGVuZDogZGF0YS52YWx1ZS5ieXRlTGVuZ3RoLAogICAgYnVmZmVyOiBkYXRhLnZhbHVlCiAgfSkKfQpjb25zdCBzY2hlbWEgPSByZXF1aXJlKCcuLi9zcGVjL2h5cGVyc2NoZW1hJykKY29uc3QgeyBzdG9yZSwgY29yZSB9ID0gcmVxdWlyZSgnLi9rZXlzLmpzJykKY29uc3QgVmlldyA9IHJlcXVpcmUoJy4vdmlldy5qcycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGZsYXQgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQoKY29uc3QgQ09SRVNUT1JFX0hFQUQgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0Bjb3Jlc3RvcmUvaGVhZCcpCmNvbnN0IENPUkVTVE9SRV9DT1JFID0gc2NoZW1hLmdldEVuY29kaW5nKCdAY29yZXN0b3JlL2NvcmUnKQoKY29uc3QgQ09SRV9BVVRIID0gc2NoZW1hLmdldEVuY29kaW5nKCdAY29yZS9hdXRoJykKY29uc3QgQ09SRV9TRVNTSU9OUyA9IHNjaGVtYS5nZXRFbmNvZGluZygnQGNvcmUvc2Vzc2lvbnMnKQpjb25zdCBDT1JFX0hFQUQgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0Bjb3JlL2hlYWQnKQpjb25zdCBDT1JFX1RSRUVfTk9ERSA9IHNjaGVtYS5nZXRFbmNvZGluZygnQGNvcmUvdHJlZS1ub2RlJykKY29uc3QgQ09SRV9ERVBFTkRFTkNZID0gc2NoZW1hLmdldEVuY29kaW5nKCdAY29yZS9kZXBlbmRlbmN5JykKY29uc3QgQ09SRV9ISU5UUyA9IHNjaGVtYS5nZXRFbmNvZGluZygnQGNvcmUvaGludHMnKQoKY2xhc3MgQ29yZVRYIHsKICBjb25zdHJ1Y3Rvcihjb3JlLCBkYiwgdmlldywgY2hhbmdlcykgewogICAgaWYgKGRiLnNuYXBzaG90dGVkKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBvcGVuIGNvcmUgdHggb24gc25hcHNob3QnKQogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy5kYiA9IGRiCiAgICB0aGlzLnZpZXcgPSB2aWV3CiAgICB0aGlzLmNoYW5nZXMgPSBjaGFuZ2VzCiAgfQoKICBzZXRBdXRoKGF1dGgpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLmF1dGgodGhpcy5jb3JlLmNvcmVQb2ludGVyKSwgZW5jb2RlKENPUkVfQVVUSCwgYXV0aCksIG51bGxdKQogIH0KCiAgc2V0U2Vzc2lvbnMoc2Vzc2lvbnMpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLnNlc3Npb25zKHRoaXMuY29yZS5jb3JlUG9pbnRlciksIGVuY29kZShDT1JFX1NFU1NJT05TLCBzZXNzaW9ucyksIG51bGxdKQogIH0KCiAgc2V0SGVhZChoZWFkKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5oZWFkKHRoaXMuY29yZS5kYXRhUG9pbnRlciksIGVuY29kZShDT1JFX0hFQUQsIGhlYWQpLCBudWxsXSkKICB9CgogIGRlbGV0ZUhlYWQoKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5oZWFkKHRoaXMuY29yZS5kYXRhUG9pbnRlciksIG51bGwsIG51bGxdKQogIH0KCiAgc2V0RGVwZW5kZW5jeShkZXApIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLmRlcGVuZGVuY3kodGhpcy5jb3JlLmRhdGFQb2ludGVyKSwgZW5jb2RlKENPUkVfREVQRU5ERU5DWSwgZGVwKSwgbnVsbF0pCiAgfQoKICBzZXRIaW50cyhoaW50cykgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUuaGludHModGhpcy5jb3JlLmRhdGFQb2ludGVyKSwgZW5jb2RlKENPUkVfSElOVFMsIGhpbnRzKSwgbnVsbF0pCiAgfQoKICBwdXRCbG9jayhpbmRleCwgZGF0YSkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUuYmxvY2sodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBpbmRleCksIGRhdGEsIG51bGxdKQogIH0KCiAgZGVsZXRlQmxvY2soaW5kZXgpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLmJsb2NrKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgaW5kZXgpLCBudWxsLCBudWxsXSkKICB9CgogIGRlbGV0ZUJsb2NrUmFuZ2Uoc3RhcnQsIGVuZCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goWwogICAgICBjb3JlLmJsb2NrKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgc3RhcnQpLAogICAgICBudWxsLAogICAgICBjb3JlLmJsb2NrKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgZW5kID09PSAtMSA/IEluZmluaXR5IDogZW5kKQogICAgXSkKICB9CgogIHB1dEJpdGZpZWxkUGFnZShpbmRleCwgZGF0YSkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUuYml0ZmllbGQodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBpbmRleCwgMCksIGRhdGEsIG51bGxdKQogIH0KCiAgZGVsZXRlQml0ZmllbGRQYWdlKGluZGV4KSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5iaXRmaWVsZCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGluZGV4LCAwKSwgbnVsbCwgbnVsbF0pCiAgfQoKICBkZWxldGVCaXRmaWVsZFBhZ2VSYW5nZShzdGFydCwgZW5kKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbCiAgICAgIGNvcmUuYml0ZmllbGQodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBzdGFydCwgMCksCiAgICAgIG51bGwsCiAgICAgIGNvcmUuYml0ZmllbGQodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBlbmQgPT09IC0xID8gSW5maW5pdHkgOiBlbmQsIDApCiAgICBdKQogIH0KCiAgcHV0VHJlZU5vZGUobm9kZSkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goWwogICAgICBjb3JlLnRyZWUodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBub2RlLmluZGV4KSwKICAgICAgZW5jb2RlKENPUkVfVFJFRV9OT0RFLCBub2RlKSwKICAgICAgbnVsbAogICAgXSkKICB9CgogIGRlbGV0ZVRyZWVOb2RlKGluZGV4KSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS50cmVlKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgaW5kZXgpLCBudWxsLCBudWxsXSkKICB9CgogIGRlbGV0ZVRyZWVOb2RlUmFuZ2Uoc3RhcnQsIGVuZCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goWwogICAgICBjb3JlLnRyZWUodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBzdGFydCksCiAgICAgIG51bGwsCiAgICAgIGNvcmUudHJlZSh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGVuZCA9PT0gLTEgPyBJbmZpbml0eSA6IGVuZCkKICAgIF0pCiAgfQoKICBwdXRVc2VyRGF0YShrZXksIHZhbHVlKSB7CiAgICBjb25zdCBidWZmZXIgPSB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gYjRhLmZyb20odmFsdWUpIDogdmFsdWUKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLnVzZXJEYXRhKHRoaXMuY29yZS5kYXRhUG9pbnRlciwga2V5KSwgYnVmZmVyLCBudWxsXSkKICB9CgogIGRlbGV0ZVVzZXJEYXRhKGtleSkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUudXNlckRhdGEodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBrZXkpLCBudWxsLCBudWxsXSkKICB9CgogIHB1dExvY2FsKGtleSwgdmFsdWUpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLmxvY2FsKHRoaXMuY29yZS5kYXRhUG9pbnRlciwga2V5KSwgdmFsdWUsIG51bGxdKQogIH0KCiAgZGVsZXRlTG9jYWwoa2V5KSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5sb2NhbCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGtleSksIG51bGwsIG51bGxdKQogIH0KCiAgZGVsZXRlTG9jYWxSYW5nZShzdGFydCwgZW5kKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbCiAgICAgIGNvcmUubG9jYWwodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBzdGFydCksCiAgICAgIG51bGwsCiAgICAgIGVuZCA9PT0gbnVsbCA/IGNvcmUubG9jYWxFbmQodGhpcy5jb3JlLmRhdGFQb2ludGVyKSA6IGNvcmUubG9jYWwodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBlbmQpCiAgICBdKQogIH0KCiAgZmx1c2goKSB7CiAgICBjb25zdCBjaGFuZ2VzID0gdGhpcy5jaGFuZ2VzCiAgICBpZiAoY2hhbmdlcyA9PT0gbnVsbCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSghdGhpcy52aWV3KQoKICAgIHRoaXMuY2hhbmdlcyA9IG51bGwKCiAgICBpZiAodGhpcy52aWV3KSB7CiAgICAgIHRoaXMudmlldy5hcHBseShjaGFuZ2VzKQogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKQogICAgfQoKICAgIHJldHVybiBWaWV3LmZsdXNoKGNoYW5nZXMsIHRoaXMuZGIpCiAgfQp9CgpjbGFzcyBDb3JlUlggewogIGNvbnN0cnVjdG9yKGNvcmUsIGRiLCB2aWV3KSB7CiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICB0aGlzLnJlYWQgPSBkYi5yZWFkKHsgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKICAgIHRoaXMudmlldyA9IHZpZXcKCiAgICB2aWV3LnJlYWRTdGFydCgpCiAgfQoKICBzdGF0aWMgYXN5bmMgZ2V0QXV0aChkYiwgYykgewogICAgcmV0dXJuIGF3YWl0IGRlY29kZShDT1JFX0FVVEgsIGF3YWl0IGRiLmdldChjb3JlLmF1dGgoYy5jb3JlUG9pbnRlcikpKQogIH0KCiAgYXN5bmMgZ2V0QXV0aCgpIHsKICAgIHJldHVybiBhd2FpdCBkZWNvZGUoQ09SRV9BVVRILCBhd2FpdCB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgY29yZS5hdXRoKHRoaXMuY29yZS5jb3JlUG9pbnRlcikpKQogIH0KCiAgYXN5bmMgZ2V0U2Vzc2lvbnMoKSB7CiAgICByZXR1cm4gYXdhaXQgZGVjb2RlKAogICAgICBDT1JFX1NFU1NJT05TLAogICAgICBhd2FpdCB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgY29yZS5zZXNzaW9ucyh0aGlzLmNvcmUuY29yZVBvaW50ZXIpKQogICAgKQogIH0KCiAgc3RhdGljIGFzeW5jIGdldEhlYWQoZGIsIGMpIHsKICAgIHJldHVybiBhd2FpdCBkZWNvZGUoQ09SRV9IRUFELCBhd2FpdCBkYi5nZXQoY29yZS5oZWFkKGMuZGF0YVBvaW50ZXIpKSkKICB9CgogIGFzeW5jIGdldEhlYWQoKSB7CiAgICByZXR1cm4gYXdhaXQgZGVjb2RlKENPUkVfSEVBRCwgYXdhaXQgdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUuaGVhZCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIpKSkKICB9CgogIGFzeW5jIGdldERlcGVuZGVuY3koKSB7CiAgICByZXR1cm4gYXdhaXQgZGVjb2RlKAogICAgICBDT1JFX0RFUEVOREVOQ1ksCiAgICAgIGF3YWl0IHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBjb3JlLmRlcGVuZGVuY3kodGhpcy5jb3JlLmRhdGFQb2ludGVyKSkKICAgICkKICB9CgogIHN0YXRpYyBhc3luYyBnZXRIaW50cyhkYiwgYykgewogICAgcmV0dXJuIGF3YWl0IGRlY29kZShDT1JFX0hJTlRTLCBhd2FpdCBkYi5nZXQoY29yZS5oaW50cyhjLmRhdGFQb2ludGVyKSkpCiAgfQoKICBhc3luYyBnZXRIaW50cygpIHsKICAgIHJldHVybiBhd2FpdCBkZWNvZGUoCiAgICAgIENPUkVfSElOVFMsCiAgICAgIGF3YWl0IHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBjb3JlLmhpbnRzKHRoaXMuY29yZS5kYXRhUG9pbnRlcikpCiAgICApCiAgfQoKICBnZXRCbG9jayhpbmRleCkgewogICAgY29uc3QgZGVwID0gZmluZEJsb2NrRGVwZW5kZW5jeSh0aGlzLmNvcmUuZGVwZW5kZW5jaWVzLCBpbmRleCkKICAgIGNvbnN0IGRhdGEgPSBkZXAgPT09IG51bGwgPyB0aGlzLmNvcmUuZGF0YVBvaW50ZXIgOiBkZXAuZGF0YVBvaW50ZXIKICAgIHJldHVybiB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgY29yZS5ibG9jayhkYXRhLCBpbmRleCkpCiAgfQoKICBnZXRCaXRmaWVsZFBhZ2UoaW5kZXgpIHsKICAgIHJldHVybiB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgY29yZS5iaXRmaWVsZCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGluZGV4LCAwKSkKICB9CgogIGFzeW5jIGdldFRyZWVOb2RlKGluZGV4KSB7CiAgICBjb25zdCBkZXAgPSBmaW5kVHJlZURlcGVuZGVuY3kodGhpcy5jb3JlLmRlcGVuZGVuY2llcywgaW5kZXgpCiAgICBjb25zdCBkYXRhID0gZGVwID09PSBudWxsID8gdGhpcy5jb3JlLmRhdGFQb2ludGVyIDogZGVwLmRhdGFQb2ludGVyCiAgICByZXR1cm4gZGVjb2RlKENPUkVfVFJFRV9OT0RFLCBhd2FpdCB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgY29yZS50cmVlKGRhdGEsIGluZGV4KSkpCiAgfQoKICBhc3luYyBoYXNUcmVlTm9kZShpbmRleCkgewogICAgcmV0dXJuIChhd2FpdCB0aGlzLmdldFRyZWVOb2RlKGluZGV4KSkgIT09IG51bGwKICB9CgogIGdldFVzZXJEYXRhKGtleSkgewogICAgcmV0dXJuIHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBjb3JlLnVzZXJEYXRhKHRoaXMuY29yZS5kYXRhUG9pbnRlciwga2V5KSkKICB9CgogIGdldExvY2FsKGtleSkgewogICAgcmV0dXJuIHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBjb3JlLmxvY2FsKHRoaXMuY29yZS5kYXRhUG9pbnRlciwga2V5KSkKICB9CgogIHRyeUZsdXNoKCkgewogICAgdGhpcy5yZWFkLnRyeUZsdXNoKCkKICAgIHRoaXMuX2ZyZWUoKQogIH0KCiAgZGVzdHJveSgpIHsKICAgIHRoaXMucmVhZC5kZXN0cm95KCkKICAgIHRoaXMuX2ZyZWUoKQogIH0KCiAgX2ZyZWUoKSB7CiAgICBpZiAodGhpcy52aWV3ID09PSBudWxsKSByZXR1cm4KICAgIHRoaXMudmlldy5yZWFkU3RvcCgpCiAgICB0aGlzLnZpZXcgPSBudWxsCiAgfQp9CgpjbGFzcyBDb3Jlc3RvcmVUWCB7CiAgY29uc3RydWN0b3IodmlldykgewogICAgdGhpcy52aWV3ID0gdmlldwogICAgdGhpcy5jaGFuZ2VzID0gW10KICB9CgogIHNldEhlYWQoaGVhZCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW3N0b3JlLmhlYWQoKSwgZW5jb2RlKENPUkVTVE9SRV9IRUFELCBoZWFkKSwgbnVsbF0pCiAgfQoKICBwdXRDb3JlKGRpc2NvdmVyeUtleSwgcHRyKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbc3RvcmUuY29yZShkaXNjb3ZlcnlLZXkpLCBlbmNvZGUoQ09SRVNUT1JFX0NPUkUsIHB0ciksIG51bGxdKQogIH0KCiAgcHV0Q29yZUJ5QWxpYXMoYWxpYXMsIGRpc2NvdmVyeUtleSkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW3N0b3JlLmNvcmVCeUFsaWFzKGFsaWFzKSwgZGlzY292ZXJ5S2V5LCBudWxsXSkKICB9CgogIGNsZWFyKCkgewogICAgY29uc3QgW3N0YXJ0LCBlbmRdID0gc3RvcmUuY2xlYXIoKQogICAgdGhpcy5jaGFuZ2VzLnB1c2goW3N0YXJ0LCBudWxsLCBlbmRdKQogIH0KCiAgYXBwbHkoKSB7CiAgICBpZiAodGhpcy5jaGFuZ2VzID09PSBudWxsKSByZXR1cm4KICAgIHRoaXMudmlldy5hcHBseSh0aGlzLmNoYW5nZXMpCiAgICB0aGlzLmNoYW5nZXMgPSBudWxsCiAgfQp9CgpjbGFzcyBDb3Jlc3RvcmVSWCB7CiAgY29uc3RydWN0b3IoZGIsIHZpZXcpIHsKICAgIHRoaXMucmVhZCA9IGRiLnJlYWQoeyBhdXRvRGVzdHJveTogdHJ1ZSB9KQogICAgdGhpcy52aWV3ID0gdmlldwoKICAgIHZpZXcucmVhZFN0YXJ0KCkKICB9CgogIGFzeW5jIGdldEhlYWQoKSB7CiAgICByZXR1cm4gZGVjb2RlKENPUkVTVE9SRV9IRUFELCBhd2FpdCB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgc3RvcmUuaGVhZCgpKSkKICB9CgogIGFzeW5jIGdldENvcmUoZGlzY292ZXJ5S2V5KSB7CiAgICByZXR1cm4gZGVjb2RlKENPUkVTVE9SRV9DT1JFLCBhd2FpdCB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgc3RvcmUuY29yZShkaXNjb3ZlcnlLZXkpKSkKICB9CgogIGdldENvcmVCeUFsaWFzKGFsaWFzKSB7CiAgICByZXR1cm4gdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIHN0b3JlLmNvcmVCeUFsaWFzKGFsaWFzKSkKICB9CgogIHRyeUZsdXNoKCkgewogICAgdGhpcy5yZWFkLnRyeUZsdXNoKCkKICAgIHRoaXMuX2ZyZWUoKQogIH0KCiAgZGVzdHJveSgpIHsKICAgIHRoaXMucmVhZC5kZXN0cm95KCkKICAgIHRoaXMuX2ZyZWUoKQogIH0KCiAgX2ZyZWUoKSB7CiAgICBpZiAodGhpcy52aWV3ID09PSBudWxsKSByZXR1cm4KICAgIHRoaXMudmlldy5yZWFkU3RvcCgpCiAgICB0aGlzLnZpZXcgPSBudWxsCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsgQ29yZXN0b3JlVFgsIENvcmVzdG9yZVJYLCBDb3JlVFgsIENvcmVSWCB9CgpmdW5jdGlvbiBmaW5kQmxvY2tEZXBlbmRlbmN5KGRlcGVuZGVuY2llcywgaW5kZXgpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IGRlcGVuZGVuY2llcy5sZW5ndGg7IGkrKykgewogICAgY29uc3QgZGVwID0gZGVwZW5kZW5jaWVzW2ldCiAgICBpZiAoaW5kZXggPCBkZXAubGVuZ3RoKSByZXR1cm4gZGVwCiAgfQoKICByZXR1cm4gbnVsbAp9CgpmdW5jdGlvbiBmaW5kVHJlZURlcGVuZGVuY3koZGVwZW5kZW5jaWVzLCBpbmRleCkgewogIGZvciAobGV0IGkgPSAwOyBpIDwgZGVwZW5kZW5jaWVzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBkZXAgPSBkZXBlbmRlbmNpZXNbaV0KICAgIGlmIChmbGF0LnJpZ2h0U3BhbihpbmRleCkgPD0gKGRlcC5sZW5ndGggLSAxKSAqIDIpIHJldHVybiBkZXAKICB9CgogIHJldHVybiBudWxsCn0KCmZ1bmN0aW9uIGRlY29kZShlbmMsIGJ1ZmZlcikgewogIGlmIChidWZmZXIgPT09IG51bGwpIHJldHVybiBudWxsCiAgcmV0dXJuIGVuYy5kZWNvZGUoeyBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCwgYnVmZmVyIH0pCn0KCmZ1bmN0aW9uIGVuY29kZShlbmMsIG0pIHsKICAvLyBUT0RPOiB1c2UgZmFuY3kgc2xhYiBmb3Igc21hbGwgbWVzc2FnZXMKICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogMCwgYnVmZmVyOiBudWxsIH0KICBlbmMucHJlZW5jb2RlKHN0YXRlLCBtKQogIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShzdGF0ZS5lbmQpCiAgZW5jLmVuY29kZShzdGF0ZSwgbSkKICByZXR1cm4gc3RhdGUuYnVmZmVyCn0KY29uc3QgeyBSZWFkYWJsZSwgZ2V0U3RyZWFtRXJyb3IgfSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQpjb25zdCBDbG9zZUVycm9yU3RyZWFtID0gcmVxdWlyZSgnLi9jbG9zZS1lcnJvci1zdHJlYW0uanMnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY2xhc3MgT3ZlcmxheVN0cmVhbSBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3RvcihzdHJlYW0sIHN0YXJ0LCBlbmQsIHJldmVyc2UsIGNoYW5nZXMsIGNsZWFyZWQpIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLnN0YXJ0ID0gc3RhcnQKICAgIHRoaXMuZW5kID0gZW5kCiAgICB0aGlzLnJldmVyc2UgPSByZXZlcnNlCiAgICB0aGlzLmNoYW5nZXMgPSBjaGFuZ2VzCiAgICB0aGlzLmNsZWFyZWQgPSBjbGVhcmVkCiAgICB0aGlzLmNoYW5nZSA9IDAKICAgIHRoaXMucmFuZ2UgPSAwCgogICAgdGhpcy5fc3RyZWFtID0gc3RyZWFtCiAgICB0aGlzLl9kcmFpbmVkID0gZmFsc2UKCiAgICB0aGlzLl9zdHJlYW0ub24oJ3JlYWRhYmxlJywgdGhpcy5fZHJhaW5NYXliZS5iaW5kKHRoaXMpKQogICAgdGhpcy5fc3RyZWFtLm9uKCdlcnJvcicsIG5vb3ApCiAgICB0aGlzLl9zdHJlYW0ub24oJ2Nsb3NlJywgdGhpcy5fb25jbG9zZS5iaW5kKHRoaXMpKQogIH0KCiAgX2RyYWluTWF5YmUoKSB7CiAgICBpZiAodGhpcy5fZHJhaW5lZCA9PT0gdHJ1ZSkgcmV0dXJuCiAgICB0aGlzLl9kcmFpbmVkID0gdGhpcy5fb25yZWFkYWJsZSgpCiAgfQoKICBfb25jbG9zZSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3lpbmcpIHJldHVybgoKICAgIGNvbnN0IGVyciA9IGdldFN0cmVhbUVycm9yKHRoaXMuX3N0cmVhbSkKCiAgICBpZiAoZXJyICE9PSBudWxsKSB7CiAgICAgIHRoaXMuZGVzdHJveShlcnIpCiAgICAgIHJldHVybgogICAgfQoKICAgIHdoaWxlICh0aGlzLmNoYW5nZSA8IHRoaXMuY2hhbmdlcy5sZW5ndGgpIHsKICAgICAgY29uc3QgYyA9IHRoaXMuY2hhbmdlc1t0aGlzLmNoYW5nZSsrXQogICAgICBjb25zdCBrZXkgPSBjWzBdCiAgICAgIGNvbnN0IHZhbHVlID0gY1sxXQoKICAgICAgaWYgKHZhbHVlICE9PSBudWxsICYmIHRoaXMuX2luUmFuZ2Uoa2V5KSkgdGhpcy5wdXNoKHsga2V5LCB2YWx1ZSB9KQogICAgfQoKICAgIHRoaXMucHVzaChudWxsKQogICAgdGhpcy5fc3RyZWFtID0gbnVsbAogIH0KCiAgX29ucmVhZGFibGUoKSB7CiAgICBsZXQgZGF0YSA9IHRoaXMuX3N0cmVhbS5yZWFkKCkKICAgIGlmIChkYXRhID09PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgICBsZXQgZHJhaW5lZCA9IGZhbHNlCgogICAgZG8gewogICAgICBpZiAodGhpcy5fcHVzaChkYXRhKSA9PT0gdHJ1ZSkgZHJhaW5lZCA9IHRydWUKICAgICAgZGF0YSA9IHRoaXMuX3N0cmVhbS5yZWFkKCkKICAgIH0gd2hpbGUgKGRhdGEgIT09IG51bGwpCgogICAgcmV0dXJuIGRyYWluZWQKICB9CgogIF9yZWFkKGNiKSB7CiAgICB0aGlzLl9kcmFpbmVkID0gdGhpcy5fb25yZWFkYWJsZSgpCiAgICBjYihudWxsKQogIH0KCiAgX3ByZWRlc3Ryb3koKSB7CiAgICB0aGlzLnN0cmVhbS5kZXN0cm95KCkKICB9CgogIF9wdXNoKGVudHJ5KSB7CiAgICBjb25zdCBrZXkgPSBlbnRyeS5rZXkKCiAgICB3aGlsZSAodGhpcy5yYW5nZSA8IHRoaXMuY2xlYXJlZC5sZW5ndGgpIHsKICAgICAgY29uc3QgYyA9IHRoaXMuY2xlYXJlZFt0aGlzLnJhbmdlXQoKICAgICAgLy8gd2UgbW92ZWQgcGFzdCB0aGUgcmFuZ2UKICAgICAgaWYgKHRoaXMucmV2ZXJzZSA/IGI0YS5jb21wYXJlKGtleSwgY1swXSkgPCAwIDogYjRhLmNvbXBhcmUoY1syXSwga2V5KSA8PSAwKSB7CiAgICAgICAgdGhpcy5yYW5nZSsrCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgLy8gd2UgZGlkbnQgbW92ZSBwYXN0IGFuZCBhcmUgaW4sIGRyb3AKICAgICAgaWYgKGI0YS5jb21wYXJlKGNbMF0sIGtleSkgPD0gMCAmJiBiNGEuY29tcGFyZShrZXksIGNbMl0pIDwgMCkgewogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9CgogICAgICBicmVhawogICAgfQoKICAgIGxldCB1cGRhdGVkID0gZmFsc2UKCiAgICB3aGlsZSAodGhpcy5jaGFuZ2UgPCB0aGlzLmNoYW5nZXMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IGMgPSB0aGlzLmNoYW5nZXNbdGhpcy5jaGFuZ2VdCiAgICAgIGNvbnN0IGtleSA9IGNbMF0KICAgICAgY29uc3QgdmFsdWUgPSB0eXBlb2YgY1sxXSA9PT0gJ3N0cmluZycgPyBiNGEuZnJvbShjWzFdKSA6IGNbMV0KICAgICAgY29uc3QgY21wID0gYjRhLmNvbXBhcmUoa2V5LCBlbnRyeS5rZXkpCgogICAgICAvLyBzYW1lIHZhbHVlLCBpZiBub3QgZGVsZXRlZCwgcmV0dXJuIG5ldyBvbmUKICAgICAgaWYgKGNtcCA9PT0gMCkgewogICAgICAgIHRoaXMuY2hhbmdlKysKICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdGhpcy5faW5SYW5nZShrZXkpID09PSBmYWxzZSkgcmV0dXJuIHVwZGF0ZWQKICAgICAgICB0aGlzLnB1c2goeyBrZXksIHZhbHVlIH0pCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQoKICAgICAgLy8gd2UgbW92ZWQgcGFzdCB0aGUgY2hhbmdlLCBwdXNoIGl0CiAgICAgIGlmICh0aGlzLnJldmVyc2UgPyBjbXAgPiAwIDogY21wIDwgMCkgewogICAgICAgIHRoaXMuY2hhbmdlKysKICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdGhpcy5faW5SYW5nZShrZXkpID09PSBmYWxzZSkgY29udGludWUKICAgICAgICB0aGlzLnB1c2goeyBrZXksIHZhbHVlIH0pCiAgICAgICAgdXBkYXRlZCA9IHRydWUKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICB0aGlzLnB1c2goZW50cnkpCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgdGhpcy5wdXNoKGVudHJ5KQogICAgcmV0dXJuIHRydWUKICB9CgogIF9pblJhbmdlKGtleSkgewogICAgcmV0dXJuIGI0YS5jb21wYXJlKHRoaXMuc3RhcnQsIGtleSkgPD0gMCAmJiBiNGEuY29tcGFyZShrZXksIHRoaXMuZW5kKSA8IDAKICB9Cn0KCmNsYXNzIE92ZXJsYXkgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5pbmRleGVkID0gMAogICAgdGhpcy5jaGFuZ2VzID0gbnVsbAogICAgdGhpcy5jbGVhcmVkID0gbnVsbAogICAgdGhpcy5yZXZlcnNlID0gZmFsc2UKICB9CgogIHVwZGF0ZSh2aWV3LCByZXZlcnNlKSB7CiAgICBpZiAodmlldy5pbmRleGVkID09PSB0aGlzLmluZGV4ZWQpIHJldHVybgoKICAgIGNvbnN0IGNoYW5nZXMgPSB2aWV3Lm1hcCA9PT0gbnVsbCA/IFtdIDogWy4uLnZpZXcubWFwLnZhbHVlcygpXQogICAgY29uc3QgY2xlYXJlZCA9IHZpZXcuY2xlYXJlZCA9PT0gbnVsbCA/IFtdIDogdmlldy5jbGVhcmVkLnNsaWNlKDApCgogICAgY29uc3QgY21wID0gcmV2ZXJzZSA/IGNtcENoYW5nZVJldmVyc2UgOiBjbXBDaGFuZ2UKCiAgICBjaGFuZ2VzLnNvcnQoY21wKQogICAgY2xlYXJlZC5zb3J0KGNtcCkKCiAgICB0aGlzLmluZGV4ZWQgPSB2aWV3LmluZGV4ZWQKICAgIHRoaXMuY2hhbmdlcyA9IGNoYW5nZXMKICAgIHRoaXMuY2xlYXJlZCA9IGNsZWFyZWQKICAgIHRoaXMucmV2ZXJzZSA9IHJldmVyc2UKICB9CgogIGNyZWF0ZVN0cmVhbShzdHJlYW0sIHN0YXJ0LCBlbmQsIHJldmVyc2UpIHsKICAgIHJldHVybiBuZXcgT3ZlcmxheVN0cmVhbSgKICAgICAgc3RyZWFtLAogICAgICBzdGFydCwKICAgICAgZW5kLAogICAgICByZXZlcnNlLAogICAgICB0aGlzLnJldmVyc2UgPT09IHJldmVyc2UgPyB0aGlzLmNoYW5nZXMgOiByZXZlcnNlQXJyYXkodGhpcy5jaGFuZ2VzKSwKICAgICAgdGhpcy5yZXZlcnNlID09PSByZXZlcnNlID8gdGhpcy5jbGVhcmVkIDogcmV2ZXJzZUFycmF5KHRoaXMuY2xlYXJlZCkKICAgICkKICB9Cn0KCmNsYXNzIFZpZXcgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5tYXAgPSBudWxsCiAgICB0aGlzLmluZGV4ZWQgPSAwCiAgICB0aGlzLmNoYW5nZXMgPSBudWxsCiAgICB0aGlzLmNsZWFyZWQgPSBudWxsCiAgICB0aGlzLm92ZXJsYXkgPSBudWxsCiAgICB0aGlzLnNuYXAgPSBudWxsCiAgICB0aGlzLnJlYWRlcnMgPSAwCiAgfQoKICBzbmFwc2hvdCgpIHsKICAgIGlmICh0aGlzLl9hdHRhY2hlZCgpKSByZXR1cm4gdGhpcy5zbmFwLnNuYXBzaG90KCkKCiAgICBjb25zdCBzbmFwID0gbmV3IFZpZXcoKQoKICAgIHNuYXAubWFwID0gdGhpcy5tYXAKICAgIHNuYXAuaW5kZXhlZCA9IHRoaXMuaW5kZXhlZAogICAgc25hcC5jaGFuZ2VzID0gdGhpcy5jaGFuZ2VzCiAgICBzbmFwLmNsZWFyZWQgPSB0aGlzLmNsZWFyZWQKCiAgICBpZiAodGhpcy5fZnJvemVuKCkpIHJldHVybiBzbmFwCgogICAgdGhpcy5yZWFkZXJzKysKICAgIHNuYXAuc25hcCA9IHRoaXMKCiAgICByZXR1cm4gc25hcAogIH0KCiAgcmVhZFN0YXJ0KCkgewogICAgaWYgKHRoaXMuc25hcCAhPT0gbnVsbCkgdGhpcy5yZWFkZXJzKysKICB9CgogIHJlYWRTdG9wKCkgewogICAgaWYgKHRoaXMuc25hcCAhPT0gbnVsbCAmJiAtLXRoaXMucmVhZGVycyA9PT0gMCkgdGhpcy5zbmFwLnJlYWRlcnMtLQogIH0KCiAgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLmNoYW5nZXMgPT09IG51bGwgPyAwIDogdGhpcy5jaGFuZ2VzLmxlbmd0aAogIH0KCiAgdXBkYXRlZCgpIHsKICAgIHJldHVybiB0aGlzLmNoYW5nZXMgPT09IG51bGwKICB9CgogIGdldChyZWFkLCBrZXkpIHsKICAgIHJldHVybiB0aGlzLmNoYW5nZXMgPT09IG51bGwgPyByZWFkLmdldChrZXkpIDogdGhpcy5faW5kZXhBbmRHZXQocmVhZCwga2V5KQogIH0KCiAgcmVzZXQoKSB7CiAgICB0aGlzLmluZGV4ZWQgPSAwCiAgICB0aGlzLnNuYXAgPSB0aGlzLm1hcCA9IHRoaXMuY2hhbmdlcyA9IHRoaXMuY2xlYXJlZCA9IHRoaXMub3ZlcmxheSA9IG51bGwKICB9CgogIGl0ZXJhdG9yKGRiLCBzdGFydCwgZW5kLCByZXZlcnNlKSB7CiAgICBpZiAoZGJDbG9zaW5nKGRiKSkgcmV0dXJuIG5ldyBDbG9zZUVycm9yU3RyZWFtKG5ldyBFcnJvcignUm9ja3NEQiBzZXNzaW9uIGlzIGNsb3NlZCcpKQoKICAgIGNvbnN0IHN0cmVhbSA9IGRiLml0ZXJhdG9yKHsgZ3RlOiBzdGFydCwgbHQ6IGVuZCwgcmV2ZXJzZSB9KQogICAgaWYgKHRoaXMuY2hhbmdlcyA9PT0gbnVsbCkgcmV0dXJuIHN0cmVhbQoKICAgIHRoaXMuX2luZGV4KCkKCiAgICBpZiAodGhpcy5vdmVybGF5ID09PSBudWxsKSB0aGlzLm92ZXJsYXkgPSBuZXcgT3ZlcmxheSgpCiAgICB0aGlzLm92ZXJsYXkudXBkYXRlKHRoaXMsIHJldmVyc2UpCiAgICByZXR1cm4gdGhpcy5vdmVybGF5LmNyZWF0ZVN0cmVhbShzdHJlYW0sIHN0YXJ0LCBlbmQsIHJldmVyc2UpCiAgfQoKICBfaW5kZXhBbmRHZXQocmVhZCwga2V5KSB7CiAgICB0aGlzLl9pbmRleCgpCiAgICBjb25zdCBjaGFuZ2UgPSB0aGlzLm1hcC5nZXQoYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpKQoKICAgIGlmIChjaGFuZ2UgPT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gdGhpcy5jbGVhcmVkID09PSBudWxsID8gcmVhZC5nZXQoa2V5KSA6IHRoaXMuX3JlYWRBbmRNYXliZURyb3AocmVhZCwga2V5KQogICAgfQoKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY2hhbmdlWzFdKQogIH0KCiAgYXN5bmMgX3JlYWRBbmRNYXliZURyb3AocmVhZCwga2V5KSB7CiAgICBjb25zdCBjbGVhcmVkID0gdGhpcy5jbGVhcmVkIC8vIGluIGNhc2UgaXRzIGNsZWFyZWQKICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgcmVhZC5nZXQoa2V5KQogICAgaWYgKHZhbHVlID09PSBudWxsKSByZXR1cm4gbnVsbAoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2xlYXJlZC5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjID0gY2xlYXJlZFtpXQogICAgICAvLyBjaGVjayBpZiBpbiByYW5nZQogICAgICBpZiAoYjRhLmNvbXBhcmUoY1swXSwga2V5KSA8PSAwICYmIGI0YS5jb21wYXJlKGtleSwgY1syXSkgPCAwKSByZXR1cm4gbnVsbAogICAgfQoKICAgIHJldHVybiB2YWx1ZQogIH0KCiAgX2F0dGFjaGVkKCkgewogICAgcmV0dXJuIHRoaXMuc25hcCAhPT0gbnVsbCAmJiB0aGlzLmNoYW5nZXMgPT09IHRoaXMuc25hcC5jaGFuZ2VzCiAgfQoKICBfZnJvemVuKCkgewogICAgcmV0dXJuIHRoaXMuY2hhbmdlcyA9PT0gbnVsbCB8fCAodGhpcy5zbmFwICE9PSBudWxsICYmIHRoaXMuY2hhbmdlcyAhPT0gdGhpcy5zbmFwLmNoYW5nZXMpCiAgfQoKICBfaW5kZXgoKSB7CiAgICAvLyBpZiB3ZSBhcmUgYSBzbmFwIGFuZCB3ZSBhcmUgc3RpbGwgYXR0YWNoZWQgKGllIG5vIG11dGF0aW9ucyksIHNpbXBseSBjb3B5IHRoZSByZWZzCiAgICBpZiAodGhpcy5fYXR0YWNoZWQoKSkgewogICAgICB0aGlzLnNuYXAuX2luZGV4KCkKICAgICAgdGhpcy5tYXAgPSB0aGlzLnNuYXAubWFwCiAgICAgIHRoaXMuY2xlYXJlZCA9IHRoaXMuc25hcC5jbGVhcmVkCiAgICAgIHRoaXMuaW5kZXhlZCA9IHRoaXMuc25hcC5pbmRleGVkCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLm1hcCA9PT0gbnVsbCkgdGhpcy5tYXAgPSBuZXcgTWFwKCkKICAgIGlmICh0aGlzLmNoYW5nZXMubGVuZ3RoID09PSB0aGlzLmluZGV4ZWQpIHJldHVybgoKICAgIHdoaWxlICh0aGlzLmluZGV4ZWQgPCB0aGlzLmNoYW5nZXMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IGMgPSB0aGlzLmNoYW5nZXNbdGhpcy5pbmRleGVkKytdCgogICAgICBpZiAoY1syXSA9PT0gbnVsbCkgdGhpcy5tYXAuc2V0KGI0YS50b1N0cmluZyhjWzBdLCAnaGV4JyksIGMpCiAgICAgIGVsc2UgdGhpcy5faW5kZXhSYW5nZShjKQogICAgfQogIH0KCiAgX2luZGV4UmFuZ2UocmFuZ2UpIHsKICAgIGNvbnN0IHMgPSBiNGEudG9TdHJpbmcocmFuZ2VbMF0sICdoZXgnKQogICAgY29uc3QgZSA9IGI0YS50b1N0cmluZyhyYW5nZVsyXSwgJ2hleCcpCgogICAgZm9yIChjb25zdCBba2V5LCBjXSBvZiB0aGlzLm1hcCkgewogICAgICBpZiAocyA8PSBrZXkgJiYga2V5IDwgZSkgdGhpcy5tYXAuc2V0KGtleSwgW2NbMF0sIG51bGwsIG51bGxdKQogICAgfQoKICAgIGlmICh0aGlzLmNsZWFyZWQgPT09IG51bGwpIHRoaXMuY2xlYXJlZCA9IFtdCiAgICB0aGlzLmNsZWFyZWQucHVzaChyYW5nZSkKICB9CgogIGFwcGx5KGNoYW5nZXMpIHsKICAgIGlmICh0aGlzLnNuYXAgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignSWxsZWdhbCB0byBwdXNoIGNoYW5nZXMgdG8gYSBzbmFwc2hvdCcpCgogICAgaWYgKHRoaXMucmVhZGVycyAhPT0gMCAmJiB0aGlzLmNoYW5nZXMgIT09IG51bGwpIHsKICAgICAgdGhpcy5jaGFuZ2VzID0gdGhpcy5jaGFuZ2VzLnNsaWNlKDApCiAgICAgIHRoaXMuY2xlYXJlZCA9IHRoaXMuY2xlYXJlZCA9PT0gbnVsbCA/IG51bGwgOiB0aGlzLmNsZWFyZWQuc2xpY2UoMCkKICAgICAgdGhpcy5tYXAgPSB0aGlzLm1hcCA9PT0gbnVsbCA/IG51bGwgOiBuZXcgTWFwKFsuLi50aGlzLm1hcF0pCiAgICB9CgogICAgaWYgKHRoaXMuY2hhbmdlcyA9PT0gbnVsbCkgewogICAgICB0aGlzLmNoYW5nZXMgPSBjaGFuZ2VzCiAgICAgIHJldHVybgogICAgfQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbmdlcy5sZW5ndGg7IGkrKykgewogICAgICB0aGlzLmNoYW5nZXMucHVzaChjaGFuZ2VzW2ldKQogICAgfQogIH0KCiAgc3RhdGljIGFzeW5jIGZsdXNoKGNoYW5nZXMsIGRiKSB7CiAgICBpZiAoY2hhbmdlcyA9PT0gbnVsbCkgcmV0dXJuIHRydWUKCiAgICBjb25zdCB3ID0gZGIud3JpdGUoeyBhdXRvRGVzdHJveTogdHJ1ZSB9KQoKICAgIGZvciAoY29uc3QgW3N0YXJ0LCB2YWx1ZSwgZW5kXSBvZiBjaGFuZ2VzKSB7CiAgICAgIGlmIChlbmQgIT09IG51bGwpIHcudHJ5RGVsZXRlUmFuZ2Uoc3RhcnQsIGVuZCkKICAgICAgZWxzZSBpZiAodmFsdWUgIT09IG51bGwpIHcudHJ5UHV0KHN0YXJ0LCB2YWx1ZSkKICAgICAgZWxzZSB3LnRyeURlbGV0ZShzdGFydCkKICAgIH0KCiAgICBhd2FpdCB3LmZsdXNoKCkKCiAgICByZXR1cm4gdHJ1ZQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBWaWV3CgpmdW5jdGlvbiBjbXBDaGFuZ2UoYSwgYikgewogIGNvbnN0IGMgPSBiNGEuY29tcGFyZShhWzBdLCBiWzBdKQogIHJldHVybiBjID09PSAwID8gYjRhLmNvbXBhcmUoYVsyXSwgYlsyXSkgOiBjCn0KCmZ1bmN0aW9uIGNtcENoYW5nZVJldmVyc2UoYSwgYikgewogIHJldHVybiBjbXBDaGFuZ2UoYiwgYSkKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CgpmdW5jdGlvbiByZXZlcnNlQXJyYXkobGlzdCkgewogIGNvbnN0IHIgPSBuZXcgQXJyYXkobGlzdC5sZW5ndGgpCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSByW3IubGVuZ3RoIC0gMSAtIGldID0gbGlzdFtpXQogIHJldHVybiByCn0KCi8vIFRPRE86IGV4cG9zZSBmcm9tIHJvY2tzIGluc3RlYWQKZnVuY3Rpb24gZGJDbG9zaW5nKGRiKSB7CiAgcmV0dXJuIGRiLl9zdGF0ZS5jbG9zaW5nIHx8IGRiLl9pbmRleCA9PT0gLTEKfQpjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJykKY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKQpjb25zdCB7IFJlYWRhYmxlIH0gPSByZXF1aXJlKCdzdHJlYW14JykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgZmxhdCA9IHJlcXVpcmUoJ2ZsYXQtdHJlZScpCmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IG0gPSByZXF1aXJlKCcuL21lc3NhZ2VzLmpzJykKY29uc3QgVmlldyA9IHJlcXVpcmUoJy4uLy4uL2xpYi92aWV3LmpzJykKY29uc3QgeyBDb3Jlc3RvcmVUWCwgQ29yZVRYLCBDb3Jlc3RvcmVSWCB9ID0gcmVxdWlyZSgnLi4vLi4vbGliL3R4LmpzJykKCmNvbnN0IEVNUFRZX05PREUgPSBiNGEuYWxsb2MoNDApCmNvbnN0IEVNUFRZX1BBR0UgPSBiNGEuYWxsb2MoNDA5NikKCmxldCBUUkVFXzAxX1NLSVAgPSBudWxsCmxldCBUUkVFXzA0X1NLSVAgPSBudWxsCmxldCBUUkVFXzE2X1NLSVAgPSBudWxsCgpjbGFzcyBDb3JlTGlzdFN0cmVhbSBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3RvciAoc3RvcmFnZSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuc3RvcmFnZSA9IHN0b3JhZ2UKICAgIHRoaXMuc3RhY2sgPSBbXQogIH0KCiAgYXN5bmMgX29wZW4gKGNiKSB7CiAgICBmb3IgKGNvbnN0IGEgb2YgYXdhaXQgcmVhZGRpcihwYXRoLmpvaW4odGhpcy5zdG9yYWdlLCAnY29yZXMnKSkpIHsKICAgICAgZm9yIChjb25zdCBiIG9mIGF3YWl0IHJlYWRkaXIocGF0aC5qb2luKHRoaXMuc3RvcmFnZSwgJ2NvcmVzJywgYSkpKSB7CiAgICAgICAgZm9yIChjb25zdCBka2V5IG9mIGF3YWl0IHJlYWRkaXIocGF0aC5qb2luKHRoaXMuc3RvcmFnZSwgJ2NvcmVzJywgYSwgYikpKSB7CiAgICAgICAgICB0aGlzLnN0YWNrLnB1c2gocGF0aC5qb2luKHRoaXMuc3RvcmFnZSwgJ2NvcmVzJywgYSwgYiwgZGtleSkpCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgY2IobnVsbCkKICB9CgogIGFzeW5jIF9yZWFkIChjYikgewogICAgd2hpbGUgKHRydWUpIHsKICAgICAgY29uc3QgbmV4dCA9IHRoaXMuc3RhY2sucG9wKCkKICAgICAgaWYgKCFuZXh0KSB7CiAgICAgICAgdGhpcy5wdXNoKG51bGwpCiAgICAgICAgYnJlYWsKICAgICAgfQoKICAgICAgY29uc3Qgb3Bsb2cgPSBwYXRoLmpvaW4obmV4dCwgJ29wbG9nJykKICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVhZE9wbG9nKG9wbG9nKQogICAgICBpZiAoIXJlc3VsdCkgY29udGludWUKCiAgICAgIHRoaXMucHVzaChyZXN1bHQpCiAgICAgIGJyZWFrCiAgICB9CgogICAgY2IobnVsbCkKICB9Cn0KCmZ1bmN0aW9uIGRlY29kZU9wbG9nSGVhZGVyIChzdGF0ZSkgewogIGMudWludDMyLmRlY29kZShzdGF0ZSkgLy8gY2tzdW0sIGlnbm9yZSBmb3Igbm93CgogIGNvbnN0IGwgPSBjLnVpbnQzMi5kZWNvZGUoc3RhdGUpCiAgY29uc3QgbGVuZ3RoID0gbCA+PiAyCiAgY29uc3QgaGVhZGVyQml0ID0gbCAmIDEKICBjb25zdCBwYXJ0aWFsQml0ID0gbCAmIDIKCiAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgbGVuZ3RoKSByZXR1cm4gbnVsbAoKICBjb25zdCBlbmQgPSBzdGF0ZS5zdGFydCArIGxlbmd0aAogIGNvbnN0IHJlc3VsdCA9IHsgaGVhZGVyOiBoZWFkZXJCaXQsIHBhcnRpYWw6IHBhcnRpYWxCaXQgIT09IDAsIGJ5dGVMZW5ndGg6IGxlbmd0aCArIDgsIG1lc3NhZ2U6IG51bGwgfQoKICB0cnkgewogICAgcmVzdWx0Lm1lc3NhZ2UgPSBtLm9wbG9nLmhlYWRlci5kZWNvZGUoeyBzdGFydDogc3RhdGUuc3RhcnQsIGVuZCwgYnVmZmVyOiBzdGF0ZS5idWZmZXIgfSkKICB9IGNhdGNoIHsKICAgIHJldHVybiBudWxsCiAgfQoKICBzdGF0ZS5zdGFydCA9IGVuZAogIHJldHVybiByZXN1bHQKfQoKZnVuY3Rpb24gZGVjb2RlT3Bsb2dFbnRyeSAoc3RhdGUpIHsKICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA4KSByZXR1cm4gbnVsbAoKICBjLnVpbnQzMi5kZWNvZGUoc3RhdGUpIC8vIGNrc3VtLCBpZ25vcmUgZm9yIG5vdwoKICBjb25zdCBsID0gYy51aW50MzIuZGVjb2RlKHN0YXRlKQogIGNvbnN0IGxlbmd0aCA9IGwgPj4+IDIKICBjb25zdCBoZWFkZXJCaXQgPSBsICYgMQogIGNvbnN0IHBhcnRpYWxCaXQgPSBsICYgMgoKICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCBsZW5ndGgpIHJldHVybiBudWxsCgogIGNvbnN0IGVuZCA9IHN0YXRlLnN0YXJ0ICsgbGVuZ3RoCgogIGNvbnN0IHJlc3VsdCA9IHsgaGVhZGVyOiBoZWFkZXJCaXQsIHBhcnRpYWw6IHBhcnRpYWxCaXQgIT09IDAsIGJ5dGVMZW5ndGg6IGxlbmd0aCArIDgsIG1lc3NhZ2U6IG51bGwgfQoKICB0cnkgewogICAgcmVzdWx0Lm1lc3NhZ2UgPSBtLm9wbG9nLmVudHJ5LmRlY29kZSh7IHN0YXJ0OiBzdGF0ZS5zdGFydCwgZW5kLCBidWZmZXI6IHN0YXRlLmJ1ZmZlciB9KQogIH0gY2F0Y2ggewogICAgcmV0dXJuIG51bGwKICB9CgogIHN0YXRlLnN0YXJ0ID0gZW5kCgogIHJldHVybiByZXN1bHQKfQoKbW9kdWxlLmV4cG9ydHMgPSB7IHN0b3JlLCBjb3JlIH0KCmFzeW5jIGZ1bmN0aW9uIHN0b3JlIChzdG9yYWdlLCB7IHZlcnNpb24sIGRyeVJ1biA9IHRydWUsIGdjID0gdHJ1ZSB9KSB7CiAgY29uc3Qgc3RyZWFtID0gbmV3IENvcmVMaXN0U3RyZWFtKHN0b3JhZ2UucGF0aCkKICBjb25zdCB2aWV3ID0gbmV3IFZpZXcoKQoKICBjb25zdCB0eCA9IG5ldyBDb3Jlc3RvcmVUWCh2aWV3KQogIGNvbnN0IGhlYWQgPSBhd2FpdCBzdG9yYWdlLl9nZXRIZWFkKHZpZXcpCiAgY29uc3QgcHJpbWFyeUtleUZpbGUgPSBwYXRoLmpvaW4oc3RvcmFnZS5wYXRoLCAncHJpbWFyeS1rZXknKQoKICBjb25zdCBwcmltYXJ5S2V5ID0gYXdhaXQgcmVhZEZpbGUocHJpbWFyeUtleUZpbGUpCgogIGlmICghaGVhZC5zZWVkKSBoZWFkLnNlZWQgPSBwcmltYXJ5S2V5CgogIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiBzdHJlYW0pIHsKICAgIGNvbnN0IGtleSA9IGRhdGEuaGVhZGVyLmtleQogICAgY29uc3QgZGlzY292ZXJ5S2V5ID0gY3J5cHRvLmRpc2NvdmVyeUtleShkYXRhLmhlYWRlci5rZXkpCiAgICBjb25zdCBmaWxlcyA9IGdldEZpbGVzKGRhdGEucGF0aCkKCiAgICBpZiAoaGVhZC5kZWZhdWx0RGlzY292ZXJ5S2V5ID09PSBudWxsKSBoZWFkLmRlZmF1bHREaXNjb3ZlcnlLZXkgPSBkaXNjb3ZlcnlLZXkKCiAgICBjb25zdCBjb3JlID0gewogICAgICB2ZXJzaW9uOiAwLCAvLyBuZWVkIGxhdGVyIG1pZ3JhdGlvbgogICAgICBjb3JlUG9pbnRlcjogaGVhZC5hbGxvY2F0ZWQuY29yZXMrKywKICAgICAgZGF0YVBvaW50ZXI6IGhlYWQuYWxsb2NhdGVkLmRhdGFzKyssCiAgICAgIGFsaWFzOiBudWxsCiAgICB9CgogICAgY29uc3QgcHRyID0geyB2ZXJzaW9uOiAwLCBjb3JlUG9pbnRlcjogY29yZS5jb3JlUG9pbnRlciwgZGF0YVBvaW50ZXI6IGNvcmUuZGF0YVBvaW50ZXIsIGRlcGVuZGVuY2llczogW10gfQogICAgY29uc3QgY3R4ID0gbmV3IENvcmVUWChwdHIsIHN0b3JhZ2UuZGIsIHZpZXcsIFtdKQogICAgY29uc3QgdXNlckRhdGEgPSBuZXcgTWFwKCkKICAgIGNvbnN0IHRyZWVOb2RlcyA9IG5ldyBNYXAoKQoKICAgIGNvbnN0IGF1dGggPSB7CiAgICAgIGtleSwKICAgICAgZGlzY292ZXJ5S2V5LAogICAgICBtYW5pZmVzdDogZGF0YS5oZWFkZXIubWFuaWZlc3QsCiAgICAgIGtleVBhaXI6IGRhdGEuaGVhZGVyLmtleVBhaXIsCiAgICAgIGVuY3J5cHRpb25LZXk6IG51bGwKICAgIH0KCiAgICBjb25zdCB0cmVlID0gewogICAgICBsZW5ndGg6IDAsCiAgICAgIGZvcms6IDAsCiAgICAgIHJvb3RIYXNoOiBudWxsLAogICAgICBzaWduYXR1cmU6IG51bGwKICAgIH0KCiAgICBpZiAoZGF0YS5oZWFkZXIudHJlZSAmJiBkYXRhLmhlYWRlci50cmVlLmxlbmd0aCkgewogICAgICB0cmVlLmxlbmd0aCA9IGRhdGEuaGVhZGVyLnRyZWUubGVuZ3RoCiAgICAgIHRyZWUuZm9yayA9IGRhdGEuaGVhZGVyLnRyZWUuZm9yawogICAgICB0cmVlLnJvb3RIYXNoID0gZGF0YS5oZWFkZXIudHJlZS5yb290SGFzaAogICAgICB0cmVlLnNpZ25hdHVyZSA9IGRhdGEuaGVhZGVyLnRyZWUuc2lnbmF0dXJlCiAgICB9CgogICAgZm9yIChjb25zdCB7IGtleSwgdmFsdWUgfSBvZiBkYXRhLmhlYWRlci51c2VyRGF0YSkgewogICAgICB1c2VyRGF0YS5zZXQoa2V5LCB2YWx1ZSkKICAgIH0KCiAgICBmb3IgKGNvbnN0IGUgb2YgZGF0YS5lbnRyaWVzKSB7CiAgICAgIGlmIChlLnVzZXJEYXRhKSB1c2VyRGF0YS5zZXQoZS51c2VyRGF0YS5rZXksIGUudXNlckRhdGEudmFsdWUpCgogICAgICBpZiAoZS50cmVlTm9kZXMpIHsKICAgICAgICBmb3IgKGNvbnN0IG5vZGUgb2YgZS50cmVlTm9kZXMpIHsKICAgICAgICAgIHRyZWVOb2Rlcy5zZXQobm9kZS5pbmRleCwgbm9kZSkKICAgICAgICAgIGN0eC5wdXRUcmVlTm9kZShub2RlKQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGUudHJlZVVwZ3JhZGUpIHsKICAgICAgICBpZiAoZS50cmVlVXBncmFkZS5hbmNlc3RvcnMgIT09IHRyZWUubGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuZmx1c2hlZCB0cnVuY2F0aW9ucyBub3QgbWlncmF0ZS1hYmxlIGF0bScpCiAgICAgICAgfQoKICAgICAgICB0cmVlLmxlbmd0aCA9IGUudHJlZVVwZ3JhZGUubGVuZ3RoCiAgICAgICAgdHJlZS5mb3JrID0gZS50cmVlVXBncmFkZS5mb3JrCiAgICAgICAgdHJlZS5yb290SGFzaCA9IG51bGwKICAgICAgICB0cmVlLnNpZ25hdHVyZSA9IGUudHJlZVVwZ3JhZGUuc2lnbmF0dXJlCiAgICAgIH0KICAgIH0KCiAgICBpZiAodXNlckRhdGEuaGFzKCdjb3Jlc3RvcmUvbmFtZScpICYmIHVzZXJEYXRhLmhhcygnY29yZXN0b3JlL25hbWVzcGFjZScpKSB7CiAgICAgIGNvcmUuYWxpYXMgPSB7CiAgICAgICAgbmFtZTogYjRhLnRvU3RyaW5nKHVzZXJEYXRhLmdldCgnY29yZXN0b3JlL25hbWUnKSksCiAgICAgICAgbmFtZXNwYWNlOiB1c2VyRGF0YS5nZXQoJ2NvcmVzdG9yZS9uYW1lc3BhY2UnKQogICAgICB9CiAgICAgIHVzZXJEYXRhLmRlbGV0ZSgnY29yZXN0b3JlL25hbWUnKQogICAgICB1c2VyRGF0YS5kZWxldGUoJ2NvcmVzdG9yZS9uYW1lc3BhY2UnKQogICAgfQoKICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHVzZXJEYXRhKSB7CiAgICAgIGN0eC5wdXRVc2VyRGF0YShrZXksIHZhbHVlKQogICAgfQoKICAgIGN0eC5zZXRBdXRoKGF1dGgpCgogICAgY29uc3QgZ2V0VHJlZU5vZGUgPSAoaW5kZXgpID0+ICh0cmVlTm9kZXMuZ2V0KGluZGV4KSB8fCBnZXRUcmVlTm9kZUZyb21GaWxlKGZpbGVzLnRyZWUsIGluZGV4KSkKCiAgICBpZiAodHJlZS5sZW5ndGgpIHsKICAgICAgaWYgKHRyZWUucm9vdEhhc2ggPT09IG51bGwpIHRyZWUucm9vdEhhc2ggPSBjcnlwdG8udHJlZShhd2FpdCBnZXRSb290cyh0cmVlLmxlbmd0aCwgZ2V0VHJlZU5vZGUpKQogICAgICBjdHguc2V0SGVhZCh0cmVlKQogICAgfQoKICAgIHR4LnB1dENvcmUoZGlzY292ZXJ5S2V5LCBjb3JlKQogICAgaWYgKGNvcmUuYWxpYXMpIHR4LnB1dENvcmVCeUFsaWFzKGNvcmUuYWxpYXMsIGRpc2NvdmVyeUtleSkKCiAgICBhd2FpdCBjdHguZmx1c2goKQogIH0KCiAgaGVhZC52ZXJzaW9uID0gdmVyc2lvbgogIHR4LnNldEhlYWQoaGVhZCkKICB0eC5hcHBseSgpCgogIGlmIChkcnlSdW4pIHJldHVybgoKICBhd2FpdCBWaWV3LmZsdXNoKHZpZXcuY2hhbmdlcywgc3RvcmFnZS5kYikKCiAgaWYgKGdjKSBhd2FpdCBybShwcmltYXJ5S2V5RmlsZSkKfQoKY2xhc3MgQmxvY2tTbGljZXIgewogIGNvbnN0cnVjdG9yIChmaWxlbmFtZSkgewogICAgdGhpcy5zdHJlYW0gPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGZpbGVuYW1lKQogICAgdGhpcy5jbG9zZWQgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHRoaXMuc3RyZWFtLm9uY2UoJ2Nsb3NlJywgcmVzb2x2ZSkpCiAgICB0aGlzLm9mZnNldCA9IDAKICAgIHRoaXMub3ZlcmZsb3cgPSBudWxsCiAgfQoKICBhc3luYyB0YWtlIChvZmZzZXQsIHNpemUpIHsKICAgIGxldCBidWZmZXIgPSBudWxsCiAgICBpZiAob2Zmc2V0IDwgdGhpcy5vZmZzZXQpIHRocm93IG5ldyBFcnJvcignb3ZlcnJlYWQnKQoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGxldCBkYXRhID0gbnVsbAoKICAgICAgaWYgKHRoaXMub3ZlcmZsb3cpIHsKICAgICAgICBkYXRhID0gdGhpcy5vdmVyZmxvdwogICAgICAgIHRoaXMub3ZlcmZsb3cgPSBudWxsCiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGF0YSA9IHRoaXMuc3RyZWFtLnJlYWQoKQoKICAgICAgICBpZiAoIWRhdGEpIHsKICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gdGhpcy5zdHJlYW0ub25jZSgncmVhZGFibGUnLCByZXNvbHZlKSkKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogICAgICB9CgogICAgICBsZXQgY2h1bmsgPSBudWxsCgogICAgICBpZiAodGhpcy5vZmZzZXQgPT09IG9mZnNldCB8fCBidWZmZXIpIHsKICAgICAgICBjaHVuayA9IGRhdGEKICAgICAgfSBlbHNlIGlmICh0aGlzLm9mZnNldCArIGRhdGEuYnl0ZUxlbmd0aCA+IG9mZnNldCkgewogICAgICAgIGNodW5rID0gZGF0YS5zdWJhcnJheShvZmZzZXQgLSB0aGlzLm9mZnNldCkKICAgICAgfQoKICAgICAgdGhpcy5vZmZzZXQgKz0gZGF0YS5ieXRlTGVuZ3RoCiAgICAgIGlmICghY2h1bmspIGNvbnRpbnVlCgogICAgICBpZiAoYnVmZmVyKSBidWZmZXIgPSBiNGEuY29uY2F0KFtidWZmZXIsIGNodW5rXSkKICAgICAgZWxzZSBidWZmZXIgPSBjaHVuawoKICAgICAgaWYgKGJ1ZmZlci5ieXRlTGVuZ3RoIDwgc2l6ZSkgY29udGludWUKCiAgICAgIGNvbnN0IHJlc3VsdCA9IGJ1ZmZlci5zdWJhcnJheSgwLCBzaXplKQogICAgICB0aGlzLm92ZXJmbG93ID0gc2l6ZSA9PT0gYnVmZmVyLmJ5dGVMZW5ndGggPyBudWxsIDogYnVmZmVyLnN1YmFycmF5KHJlc3VsdC5ieXRlTGVuZ3RoKQogICAgICB0aGlzLm9mZnNldCAtPSAodGhpcy5vdmVyZmxvdyA/IHRoaXMub3ZlcmZsb3cuYnl0ZUxlbmd0aCA6IDApCiAgICAgIHJldHVybiByZXN1bHQKICAgIH0KICB9CgogIGNsb3NlICgpIHsKICAgIHRoaXMuc3RyZWFtLm9uKCdlcnJvcicsIG5vb3ApCiAgICB0aGlzLnN0cmVhbS5kZXN0cm95KCkKICAgIHJldHVybiB0aGlzLmNsb3NlZAogIH0KfQoKY2xhc3MgVHJlZVNsaWNlciB7CiAgY29uc3RydWN0b3IgKCkgewogICAgdGhpcy5idWZmZXIgPSBudWxsCiAgICB0aGlzLm9mZnNldCA9IDAKICB9CgogIGdldCBzaXplICgpIHsKICAgIHJldHVybiB0aGlzLmJ1ZmZlciA9PT0gbnVsbCA/IDAgOiB0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RoCiAgfQoKICBwdXNoIChkYXRhKSB7CiAgICBpZiAodGhpcy5idWZmZXIgPT09IG51bGwpIHRoaXMuYnVmZmVyID0gZGF0YQogICAgZWxzZSB0aGlzLmJ1ZmZlciA9IGI0YS5jb25jYXQoW3RoaXMuYnVmZmVyLCBkYXRhXSkKICAgIHRoaXMub2Zmc2V0ICs9IGRhdGEuYnl0ZUxlbmd0aAogIH0KCiAgc2tpcCAoKSB7CiAgICBsZXQgc2tpcHBlZCA9IDAKCiAgICBpZiAoVFJFRV8wMV9TS0lQID09PSBudWxsKSB7CiAgICAgIFRSRUVfMTZfU0tJUCA9IGI0YS5hbGxvYygxNiAqIDQwICogMTAwKQogICAgICBUUkVFXzA0X1NLSVAgPSBUUkVFXzE2X1NLSVAuc3ViYXJyYXkoMCwgNCAqIDQwICogMTAwKQogICAgICBUUkVFXzAxX1NLSVAgPSBUUkVFXzE2X1NLSVAuc3ViYXJyYXkoMCwgMSAqIDQwICogMTAwKQogICAgfQoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmICh0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RoID49IFRSRUVfMTZfU0tJUC5ieXRlTGVuZ3RoKSB7CiAgICAgICAgaWYgKGI0YS5lcXVhbHModGhpcy5idWZmZXIuc3ViYXJyYXkoMCwgVFJFRV8xNl9TS0lQLmJ5dGVMZW5ndGgpLCBUUkVFXzE2X1NLSVApKSB7CiAgICAgICAgICB0aGlzLmJ1ZmZlciA9IHRoaXMuYnVmZmVyLnN1YmFycmF5KFRSRUVfMTZfU0tJUC5ieXRlTGVuZ3RoKQogICAgICAgICAgc2tpcHBlZCArPSAxNjAwCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMuYnVmZmVyLmJ5dGVMZW5ndGggPj0gVFJFRV8wNF9TS0lQLmJ5dGVMZW5ndGgpIHsKICAgICAgICBpZiAoYjRhLmVxdWFscyh0aGlzLmJ1ZmZlci5zdWJhcnJheSgwLCBUUkVFXzA0X1NLSVAuYnl0ZUxlbmd0aCksIFRSRUVfMDRfU0tJUCkpIHsKICAgICAgICAgIHRoaXMuYnVmZmVyID0gdGhpcy5idWZmZXIuc3ViYXJyYXkoVFJFRV8wNF9TS0lQLmJ5dGVMZW5ndGgpCiAgICAgICAgICBza2lwcGVkICs9IDQwMAogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RoID49IFRSRUVfMDFfU0tJUC5ieXRlTGVuZ3RoKSB7CiAgICAgICAgaWYgKGI0YS5lcXVhbHModGhpcy5idWZmZXIuc3ViYXJyYXkoMCwgVFJFRV8wMV9TS0lQLmJ5dGVMZW5ndGgpLCBUUkVFXzAxX1NLSVApKSB7CiAgICAgICAgICB0aGlzLmJ1ZmZlciA9IHRoaXMuYnVmZmVyLnN1YmFycmF5KFRSRUVfMDFfU0tJUC5ieXRlTGVuZ3RoKQogICAgICAgICAgc2tpcHBlZCArPSAxMDAKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogICAgICB9CiAgICAgIGJyZWFrCiAgICB9CgogICAgcmV0dXJuIHNraXBwZWQKICB9CgogIHRha2UgKCkgewogICAgY29uc3QgbGVuID0gNDAKCiAgICBpZiAobGVuIDw9IHRoaXMuc2l6ZSkgewogICAgICBjb25zdCBjaHVuayA9IHRoaXMuYnVmZmVyLnN1YmFycmF5KDAsIGxlbikKICAgICAgdGhpcy5idWZmZXIgPSB0aGlzLmJ1ZmZlci5zdWJhcnJheShsZW4pCiAgICAgIHJldHVybiBjaHVuawogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBjb3JlIChjb3JlLCB7IHZlcnNpb24sIGRyeVJ1biA9IHRydWUsIGdjID0gdHJ1ZSB9KSB7CiAgaWYgKGRyeVJ1bikgcmV0dXJuIC8vIGRyeVJ1biBtb2RlIG5vdCBzdXBwb3J0ZWQgYXRtCgogIGNvbnN0IHJ4ID0gY29yZS5yZWFkKCkKCiAgY29uc3QgcHJvbWlzZXMgPSBbcnguZ2V0QXV0aCgpLCByeC5nZXRIZWFkKCldCiAgcngudHJ5Rmx1c2goKQoKICBjb25zdCBbYXV0aCwgaGVhZF0gPSBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcykKCiAgaWYgKCFhdXRoKSByZXR1cm4KCiAgY29uc3QgZGsgPSBiNGEudG9TdHJpbmcoYXV0aC5kaXNjb3ZlcnlLZXksICdoZXgnKQogIGNvbnN0IGZpbGVzID0gZ2V0RmlsZXMocGF0aC5qb2luKGNvcmUuc3RvcmUucGF0aCwgJ2NvcmVzJywgZGsuc2xpY2UoMCwgMiksIGRrLnNsaWNlKDIsIDQpLCBkaykpCgogIGlmIChoZWFkID09PSBudWxsIHx8IGhlYWQubGVuZ3RoID09PSAwKSB7CiAgICBhd2FpdCBjb21taXRDb3JlTWlncmF0aW9uKGF1dGgsIGNvcmUsIHZlcnNpb24pCiAgICBpZiAoZ2MpIGF3YWl0IHJ1bkdDKCkKICAgIHJldHVybiAvLyBubyBkYXRhCiAgfQoKICBjb25zdCBvcGxvZyA9IGF3YWl0IHJlYWRPcGxvZyhmaWxlcy5vcGxvZykKICBpZiAoIW9wbG9nKSB7CiAgICBjb25zdCB3cml0YWJsZSA9ICEhYXV0aC5rZXlQYWlyCgogICAgaWYgKHdyaXRhYmxlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gb3Bsb2cgYXZhaWxhYmxlIHdyaXRhYmxlIGNvcmUgZm9yICcgKyBmaWxlcy5vcGxvZyArICcsIGxlbmd0aCA9ICcgKyAoaGVhZCA/IGhlYWQubGVuZ3RoIDogMCkpCiAgICB9CgogICAgLy8gaWYgbm90IHdyaXRhYmxlLCBqdXN0IG51a2UgaXQgdG8gcmVjb3Zlciwgc29tZSBiYWQgc3RhdGUgaGFwcGVuZWQgaGVyZSwgcHJvcCBjb3JydXB0aW9uIGZyb20gZWFybGllciB2ZXJzaW9ucwogICAgY29uc3QgdyA9IGNvcmUud3JpdGUoKQoKICAgIHcuZGVsZXRlQmxvY2tSYW5nZSgwLCAtMSkKICAgIHcuZGVsZXRlVHJlZU5vZGVSYW5nZSgwLCAtMSkKICAgIHcuZGVsZXRlQml0ZmllbGRQYWdlUmFuZ2UoMCwgLTEpCiAgICB3LmRlbGV0ZUhlYWQoKQoKICAgIGF3YWl0IHcuZmx1c2goKQoKICAgIGF3YWl0IGNvbW1pdENvcmVNaWdyYXRpb24oYXV0aCwgY29yZSwgdmVyc2lvbikKICAgIGlmIChnYykgYXdhaXQgcnVuR0MoKQogICAgcmV0dXJuIC8vIG5vIGRhdGEKICB9CgogIGNvbnN0IHRyZWVEYXRhID0gbmV3IFRyZWVTbGljZXIoKQoKICBsZXQgdHJlZUluZGV4ID0gMAoKICBpZiAoYXdhaXQgZXhpc3RzKGZpbGVzLnRyZWUpKSB7CiAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgZnMuY3JlYXRlUmVhZFN0cmVhbShmaWxlcy50cmVlKSkgewogICAgICB0cmVlRGF0YS5wdXNoKGRhdGEpCgogICAgICBsZXQgd3JpdGUgPSBudWxsCgogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGNvbnN0IHNraXAgPSB0cmVlRGF0YS5za2lwKCkKICAgICAgICB0cmVlSW5kZXggKz0gc2tpcAoKICAgICAgICBjb25zdCBidWYgPSB0cmVlRGF0YS50YWtlKCkKICAgICAgICBpZiAoYnVmID09PSBudWxsKSBicmVhawoKICAgICAgICBjb25zdCBpbmRleCA9IHRyZWVJbmRleCsrCiAgICAgICAgaWYgKGI0YS5lcXVhbHMoYnVmLCBFTVBUWV9OT0RFKSkgY29udGludWUKCiAgICAgICAgaWYgKHdyaXRlID09PSBudWxsKSB3cml0ZSA9IGNvcmUud3JpdGUoKQogICAgICAgIHdyaXRlLnB1dFRyZWVOb2RlKGRlY29kZVRyZWVOb2RlKGluZGV4LCBidWYpKQogICAgICB9CgogICAgICBpZiAod3JpdGUgIT09IG51bGwpIGF3YWl0IHdyaXRlLmZsdXNoKCkKICAgIH0KICB9CgogIGNvbnN0IGJ1ZiA9IFtdCiAgaWYgKGF3YWl0IGV4aXN0cyhmaWxlcy5iaXRmaWVsZCkpIHsKICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiBmcy5jcmVhdGVSZWFkU3RyZWFtKGZpbGVzLmJpdGZpZWxkKSkgewogICAgICBidWYucHVzaChkYXRhKQogICAgfQogIH0KCiAgbGV0IGJpdGZpZWxkID0gYjRhLmNvbmNhdChidWYpCiAgaWYgKGJpdGZpZWxkLmJ5dGVMZW5ndGggJiA0MDk1KSBiaXRmaWVsZCA9IGI0YS5jb25jYXQoW2JpdGZpZWxkLCBiNGEuYWxsb2MoNDA5NiAtIChiaXRmaWVsZC5ieXRlTGVuZ3RoICYgNDA5NSkpXSkKCiAgY29uc3QgcGFnZXMgPSBuZXcgTWFwKCkKICBjb25zdCBoZWFkZXJCaXRzID0gbmV3IE1hcCgpCgogIGNvbnN0IHJvb3RzID0gYXdhaXQgZ2V0Um9vdHNGcm9tU3RvcmFnZShjb3JlLCBoZWFkLmxlbmd0aCkKCiAgZm9yIChjb25zdCBlIG9mIG9wbG9nLmVudHJpZXMpIHsKICAgIGlmICghZS5iaXRmaWVsZCkgY29udGludWUKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGUuYml0ZmllbGQubGVuZ3RoOyBpKyspIHsKICAgICAgaGVhZGVyQml0cy5zZXQoaSArIGUuYml0ZmllbGQuc3RhcnQsICFlLmJpdGZpZWxkLmRyb3ApCiAgICB9CiAgfQoKICBsZXQgYmF0Y2ggPSBbXQoKICBjb25zdCBjYWNoZSA9IG5ldyBNYXAoKQogIGNvbnN0IGJsb2NrcyA9IG5ldyBCbG9ja1NsaWNlcihmaWxlcy5kYXRhKQoKICBmb3IgKGNvbnN0IGluZGV4IG9mIGFsbEJpdHMoYml0ZmllbGQpKSB7CiAgICBpZiAoaGVhZGVyQml0cy5nZXQoaW5kZXgpID09PSBmYWxzZSkgY29udGludWUKICAgIGlmIChpbmRleCA+PSBoZWFkLmxlbmd0aCkgY29udGludWUKCiAgICBzZXRCaXRJblBhZ2UoaW5kZXgpCgogICAgYmF0Y2gucHVzaChpbmRleCkKICAgIGlmIChiYXRjaC5sZW5ndGggPCAxMDI0KSBjb250aW51ZQoKICAgIGF3YWl0IHdyaXRlQmxvY2tzQmF0Y2goKQogICAgY29udGludWUKICB9CgogIGlmIChiYXRjaC5sZW5ndGgpIGF3YWl0IHdyaXRlQmxvY2tzQmF0Y2goKQoKICBhd2FpdCBibG9ja3MuY2xvc2UoKQoKICBjb25zdCB3ID0gY29yZS53cml0ZSgpCgogIGZvciAoY29uc3QgW2luZGV4LCBiaXRdIG9mIGhlYWRlckJpdHMpIHsKICAgIGlmICghYml0KSBjb250aW51ZQogICAgaWYgKGluZGV4ID49IGhlYWQubGVuZ3RoKSBjb250aW51ZQoKICAgIHNldEJpdEluUGFnZShpbmRleCkKCiAgICBjb25zdCBibGsgPSBhd2FpdCBnZXRCbG9ja0Zyb21GaWxlKGZpbGVzLmRhdGEsIGNvcmUsIGluZGV4LCByb290cywgY2FjaGUpCiAgICB3LnB1dEJsb2NrKGluZGV4LCBibGspCiAgfQoKICBmb3IgKGNvbnN0IFtpbmRleCwgcGFnZV0gb2YgcGFnZXMpIHsKICAgIHcucHV0Qml0ZmllbGRQYWdlKGluZGV4LCBiNGEuZnJvbShwYWdlLmJ1ZmZlciwgcGFnZS5ieXRlT2Zmc2V0LCBwYWdlLmJ5dGVMZW5ndGgpKQogIH0KCiAgYXdhaXQgdy5mbHVzaCgpCgogIGxldCBjb250aWd1b3VzTGVuZ3RoID0gMAogIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiBjb3JlLmNyZWF0ZUJsb2NrU3RyZWFtKCkpIHsKICAgIGlmIChkYXRhLmluZGV4ID09PSBjb250aWd1b3VzTGVuZ3RoKSBjb250aWd1b3VzTGVuZ3RoKysKICAgIGVsc2UgYnJlYWsKICB9CgogIGlmIChjb250aWd1b3VzTGVuZ3RoKSB7CiAgICBjb25zdCB3ID0gY29yZS53cml0ZSgpCiAgICB3LnNldEhpbnRzKHsgY29udGlndW91c0xlbmd0aCB9KQogICAgYXdhaXQgdy5mbHVzaCgpCiAgfQoKICBhd2FpdCBjb21taXRDb3JlTWlncmF0aW9uKGF1dGgsIGNvcmUsIHZlcnNpb24pCgogIGlmIChnYykgYXdhaXQgcnVuR0MoKQoKICBhc3luYyBmdW5jdGlvbiBydW5HQyAoKSB7CiAgICBhd2FpdCBybShmaWxlcy5wYXRoKQogICAgYXdhaXQgcm1kaXIocGF0aC5qb2luKGZpbGVzLnBhdGgsICcuLicpKQogICAgYXdhaXQgcm1kaXIocGF0aC5qb2luKGZpbGVzLnBhdGgsICcuLi8uLicpKQogICAgYXdhaXQgcm1kaXIocGF0aC5qb2luKGNvcmUuc3RvcmUucGF0aCwgJ2NvcmVzJykpCiAgfQoKICBmdW5jdGlvbiBzZXRCaXRJblBhZ2UgKGluZGV4KSB7CiAgICBjb25zdCBuID0gaW5kZXggJiAzMjc2NwogICAgY29uc3QgcCA9IChpbmRleCAtIG4pIC8gMzI3NjgKCiAgICBsZXQgcGFnZSA9IHBhZ2VzLmdldChwKQoKICAgIGlmICghcGFnZSkgewogICAgICBwYWdlID0gbmV3IFVpbnQzMkFycmF5KDEwMjQpCiAgICAgIHBhZ2VzLnNldChwLCBwYWdlKQogICAgfQoKICAgIGNvbnN0IG8gPSBuICYgMzEKICAgIGNvbnN0IGIgPSAobiAtIG8pIC8gMzIKICAgIGNvbnN0IHYgPSAxIDw8IG8KCiAgICBwYWdlW2JdIHw9IHYKICB9CgogIGFzeW5jIGZ1bmN0aW9uIHdyaXRlQmxvY2tzQmF0Y2ggKCkgewogICAgY29uc3QgcmVhZCA9IGNvcmUucmVhZCgpCiAgICBjb25zdCBwcm9taXNlcyA9IFtdCiAgICBmb3IgKGNvbnN0IGluZGV4IG9mIGJhdGNoKSBwcm9taXNlcy5wdXNoKGdldEJ5dGVSYW5nZUZyb21TdG9yYWdlKHJlYWQsIDIgKiBpbmRleCwgcm9vdHMsIGNhY2hlKSkKICAgIHJlYWQudHJ5Rmx1c2goKQoKICAgIGNvbnN0IHIgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcykKICAgIGNvbnN0IHR4ID0gY29yZS53cml0ZSgpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCByLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGluZGV4ID0gYmF0Y2hbaV0KICAgICAgY29uc3QgW29mZnNldCwgc2l6ZV0gPSByW2ldCgogICAgICBjb25zdCBibGsgPSBhd2FpdCBibG9ja3MudGFrZShvZmZzZXQsIHNpemUpCiAgICAgIHR4LnB1dEJsb2NrKGluZGV4LCBibGspCiAgICB9CgogICAgYmF0Y2ggPSBbXQogICAgaWYgKGNhY2hlLnNpemUgPiAxNjM4NCkgY2FjaGUuY2xlYXIoKQoKICAgIGF3YWl0IHR4LmZsdXNoKCkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGNvbW1pdENvcmVNaWdyYXRpb24gKGF1dGgsIGNvcmUsIHZlcnNpb24pIHsKICBjb25zdCB2aWV3ID0gbmV3IFZpZXcoKQogIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKGNvcmUuZGIsIHZpZXcpCgogIGNvbnN0IHN0b3JlQ29yZVByb21pc2UgPSByeC5nZXRDb3JlKGF1dGguZGlzY292ZXJ5S2V5KQogIHJ4LnRyeUZsdXNoKCkKCiAgY29uc3Qgc3RvcmVDb3JlID0gYXdhaXQgc3RvcmVDb3JlUHJvbWlzZQoKICBzdG9yZUNvcmUudmVyc2lvbiA9IHZlcnNpb24KCiAgY29uc3QgdHggPSBuZXcgQ29yZXN0b3JlVFgodmlldykKCiAgdHgucHV0Q29yZShhdXRoLmRpc2NvdmVyeUtleSwgc3RvcmVDb3JlKQogIHR4LmFwcGx5KCkKCiAgYXdhaXQgVmlldy5mbHVzaCh2aWV3LmNoYW5nZXMsIGNvcmUuZGIpCn0KCmFzeW5jIGZ1bmN0aW9uIGdldEJsb2NrRnJvbUZpbGUgKGZpbGUsIGNvcmUsIGluZGV4LCByb290cywgY2FjaGUpIHsKICBjb25zdCByeCA9IGNvcmUucmVhZCgpCiAgY29uc3QgcHJvbWlzZSA9IGdldEJ5dGVSYW5nZUZyb21TdG9yYWdlKHJ4LCAyICogaW5kZXgsIHJvb3RzLCBjYWNoZSkKICByeC50cnlGbHVzaCgpCiAgY29uc3QgW29mZnNldCwgc2l6ZV0gPSBhd2FpdCBwcm9taXNlCgogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgcmVhZEFsbChmaWxlLCBzaXplLCBvZmZzZXQsIGZ1bmN0aW9uIChlcnIsIGJ1ZikgewogICAgICBpZiAoZXJyKSByZXR1cm4gcmVzb2x2ZShudWxsKQogICAgICByZXNvbHZlKGJ1ZikKICAgIH0pCiAgfSkKfQoKZnVuY3Rpb24gZ2V0RmlsZXMgKGRpcikgewogIHJldHVybiB7CiAgICBwYXRoOiBkaXIsCiAgICBvcGxvZzogcGF0aC5qb2luKGRpciwgJ29wbG9nJyksCiAgICBkYXRhOiBwYXRoLmpvaW4oZGlyLCAnZGF0YScpLAogICAgdHJlZTogcGF0aC5qb2luKGRpciwgJ3RyZWUnKSwKICAgIGJpdGZpZWxkOiBwYXRoLmpvaW4oZGlyLCAnYml0ZmllbGQnKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZ2V0Um9vdHNGcm9tU3RvcmFnZSAoY29yZSwgbGVuZ3RoKSB7CiAgY29uc3QgYWxsID0gW10KICBjb25zdCByeCA9IGNvcmUucmVhZCgpCiAgZm9yIChjb25zdCBpbmRleCBvZiBmbGF0LmZ1bGxSb290cygyICogbGVuZ3RoKSkgewogICAgYWxsLnB1c2gocnguZ2V0VHJlZU5vZGUoaW5kZXgpKQogIH0KICByeC50cnlGbHVzaCgpCiAgcmV0dXJuIFByb21pc2UuYWxsKGFsbCkKfQoKYXN5bmMgZnVuY3Rpb24gZ2V0Um9vdHMgKGxlbmd0aCwgZ2V0VHJlZU5vZGUpIHsKICBjb25zdCBhbGwgPSBbXQogIGZvciAoY29uc3QgaW5kZXggb2YgZmxhdC5mdWxsUm9vdHMoMiAqIGxlbmd0aCkpIHsKICAgIGFsbC5wdXNoKGF3YWl0IGdldFRyZWVOb2RlKGluZGV4KSkKICB9CiAgcmV0dXJuIGFsbAp9CgpmdW5jdGlvbiBnZXRDYWNoZWQgKHJlYWQsIGNhY2hlLCBpbmRleCkgewogIGlmIChjYWNoZS5oYXMoaW5kZXgpKSByZXR1cm4gY2FjaGUuZ2V0KGluZGV4KQogIGNvbnN0IHAgPSByZWFkLmdldFRyZWVOb2RlKGluZGV4KQogIGNhY2hlLnNldChpbmRleCwgcCkKICByZXR1cm4gcAp9Cgphc3luYyBmdW5jdGlvbiBnZXRCeXRlUmFuZ2VGcm9tU3RvcmFnZSAocmVhZCwgaW5kZXgsIHJvb3RzLCBjYWNoZSkgewogIGNvbnN0IHByb21pc2VzID0gW2dldENhY2hlZChyZWFkLCBjYWNoZSwgaW5kZXgpLCBnZXRCeXRlT2Zmc2V0RnJvbVN0b3JhZ2UocmVhZCwgaW5kZXgsIHJvb3RzLCBjYWNoZSldCiAgY29uc3QgW25vZGUsIG9mZnNldF0gPSBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcykKICBpZiAoIW5vZGUpIHRocm93IG5ldyBFcnJvcignTm9kZSBub3QgZm91bmQgZHVyaW5nIG1pZ3JhdGlvbjogJyArIGluZGV4KQogIHJldHVybiBbb2Zmc2V0LCBub2RlLnNpemVdCn0KCmFzeW5jIGZ1bmN0aW9uIGdldEJ5dGVPZmZzZXRGcm9tU3RvcmFnZSAocngsIGluZGV4LCByb290cywgY2FjaGUpIHsKICBpZiAoaW5kZXggPT09IDApIHJldHVybiAwCiAgaWYgKChpbmRleCAmIDEpID09PSAxKSBpbmRleCA9IGZsYXQubGVmdFNwYW4oaW5kZXgpCgogIGxldCBoZWFkID0gMAogIGxldCBvZmZzZXQgPSAwCgogIGZvciAoY29uc3Qgbm9kZSBvZiByb290cykgeyAvLyBhbGwgYXN5bmMgdGlja3MgaGFwcGVuIG9uY2Ugd2UgZmluZCB0aGUgcm9vdCBzbyBzYWZlCiAgICBoZWFkICs9IDIgKiAoKG5vZGUuaW5kZXggLSBoZWFkKSArIDEpCgogICAgaWYgKGluZGV4ID49IGhlYWQpIHsKICAgICAgb2Zmc2V0ICs9IG5vZGUuc2l6ZQogICAgICBjb250aW51ZQogICAgfQoKICAgIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3Iobm9kZS5pbmRleCkKICAgIGNvbnN0IHByb21pc2VzID0gW10KCiAgICB3aGlsZSAoaXRlLmluZGV4ICE9PSBpbmRleCkgewogICAgICBpZiAoaW5kZXggPCBpdGUuaW5kZXgpIHsKICAgICAgICBpdGUubGVmdENoaWxkKCkKICAgICAgfSBlbHNlIHsKICAgICAgICBwcm9taXNlcy5wdXNoKGdldENhY2hlZChyeCwgY2FjaGUsIGl0ZS5sZWZ0Q2hpbGQoKSkpCiAgICAgICAgaXRlLnNpYmxpbmcoKQogICAgICB9CiAgICB9CgogICAgY29uc3Qgbm9kZXMgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcykKICAgIGZvciAoY29uc3Qgbm9kZSBvZiBub2Rlcykgb2Zmc2V0ICs9IG5vZGUuc2l6ZQoKICAgIHJldHVybiBvZmZzZXQKICB9CgogIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGZpbmQgb2Zmc2V0JykKfQoKZnVuY3Rpb24gZGVjb2RlVHJlZU5vZGUgKGluZGV4LCBidWYpIHsKICByZXR1cm4geyBpbmRleCwgc2l6ZTogYy5kZWNvZGUoYy51aW50NjQsIGJ1ZiksIGhhc2g6IGJ1Zi5zdWJhcnJheSg4KSB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGdldFRyZWVOb2RlRnJvbUZpbGUgKGZpbGUsIGluZGV4KSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICByZWFkQWxsKGZpbGUsIDQwLCBpbmRleCAqIDQwLCBmdW5jdGlvbiAoZXJyLCBidWYpIHsKICAgICAgaWYgKGVycikgcmV0dXJuIHJlc29sdmUobnVsbCkKICAgICAgcmVzb2x2ZShkZWNvZGVUcmVlTm9kZShpbmRleCwgYnVmKSkKICAgIH0pCiAgfSkKfQoKZnVuY3Rpb24gcmVhZEFsbCAoZmlsZW5hbWUsIGxlbmd0aCwgcG9zLCBjYikgewogIGNvbnN0IGJ1ZiA9IGI0YS5hbGxvYyhsZW5ndGgpCgogIGZzLm9wZW4oZmlsZW5hbWUsICdyJywgZnVuY3Rpb24gKGVyciwgZmQpIHsKICAgIGlmIChlcnIpIHJldHVybiBjYihlcnIpCgogICAgbGV0IG9mZnNldCA9IDAKCiAgICBmcy5yZWFkKGZkLCBidWYsIG9mZnNldCwgYnVmLmJ5dGVMZW5ndGgsIHBvcywgZnVuY3Rpb24gbG9vcCAoZXJyLCByZWFkKSB7CiAgICAgIGlmIChlcnIpIHJldHVybiBkb25lKGVycikKICAgICAgaWYgKHJlYWQgPT09IDApIHJldHVybiBkb25lKG5ldyBFcnJvcignUGFydGlhbCByZWFkJykpCiAgICAgIG9mZnNldCArPSByZWFkCiAgICAgIGlmIChvZmZzZXQgPT09IGJ1Zi5ieXRlTGVuZ3RoKSByZXR1cm4gZG9uZShudWxsLCBidWYpCiAgICAgIGZzLnJlYWQoZmQsIG9mZnNldCwgYnVmLmJ5dGVMZW5ndGggLSBvZmZzZXQsIGJ1ZiwgcG9zICsgb2Zmc2V0LCBsb29wKQogICAgfSkKCiAgICBmdW5jdGlvbiBkb25lIChlcnIsIHZhbHVlKSB7CiAgICAgIGZzLmNsb3NlKGZkLCAoKSA9PiBjYihlcnIsIHZhbHVlKSkKICAgIH0KICB9KQp9Cgphc3luYyBmdW5jdGlvbiByZWFkZGlyIChkaXIpIHsKICB0cnkgewogICAgcmV0dXJuIGF3YWl0IGZzLnByb21pc2VzLnJlYWRkaXIoZGlyKQogIH0gY2F0Y2ggewogICAgcmV0dXJuIFtdCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBleGlzdHMgKGZpbGUpIHsKICB0cnkgewogICAgYXdhaXQgZnMucHJvbWlzZXMuc3RhdChmaWxlKQogICAgcmV0dXJuIHRydWUKICB9IGNhdGNoIHsKICAgIHJldHVybiBmYWxzZQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcmVhZEZpbGUgKGZpbGUpIHsKICB0cnkgewogICAgcmV0dXJuIGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKGZpbGUpCiAgfSBjYXRjaCB7CiAgICByZXR1cm4gbnVsbAogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcm0gKGRpcikgewogIHRyeSB7CiAgICBhd2FpdCBmcy5wcm9taXNlcy5ybShkaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pCiAgfSBjYXRjaCB7fQp9Cgphc3luYyBmdW5jdGlvbiBybWRpciAoZGlyKSB7CiAgdHJ5IHsKICAgIGF3YWl0IGZzLnByb21pc2VzLnJtZGlyKGRpcikKICB9IGNhdGNoIHt9Cn0KCmZ1bmN0aW9uICogYWxsQml0cyAoYnVmZmVyKSB7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXIuYnl0ZUxlbmd0aDsgaSArPSBFTVBUWV9QQUdFLmJ5dGVMZW5ndGgpIHsKICAgIGNvbnN0IHBhZ2UgPSBidWZmZXIuc3ViYXJyYXkoaSwgaSArIEVNUFRZX05PREUuYnl0ZUxlbmd0aCkKICAgIGlmIChiNGEuZXF1YWxzKHBhZ2UsIEVNUFRZX1BBR0UpKSBjb250aW51ZQoKICAgIGNvbnN0IHZpZXcgPSBuZXcgVWludDMyQXJyYXkocGFnZS5idWZmZXIsIHBhZ2UuYnl0ZU9mZnNldCwgRU1QVFlfUEFHRS5ieXRlTGVuZ3RoIC8gNCkKCiAgICBmb3IgKGxldCBqID0gMDsgaiA8IHZpZXcubGVuZ3RoOyBqKyspIHsKICAgICAgY29uc3QgbiA9IHZpZXdbal0KICAgICAgaWYgKG4gPT09IDApIGNvbnRpbnVlCgogICAgICBmb3IgKGxldCBrID0gMDsgayA8IDMyOyBrKyspIHsKICAgICAgICBjb25zdCBtID0gMSA8PCBrCiAgICAgICAgaWYgKG4gJiBtKSB5aWVsZCBpICogOCArIGogKiAzMiArIGsKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gcmVhZE9wbG9nIChvcGxvZykgewogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgZnMucmVhZEZpbGUob3Bsb2csIGZ1bmN0aW9uIChlcnIsIGJ1ZmZlcikgewogICAgICBpZiAoZXJyKSByZXR1cm4gcmVzb2x2ZShudWxsKQoKICAgICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoLCBidWZmZXIgfQogICAgICBjb25zdCBoZWFkZXJzID0gWzEsIDBdCgogICAgICBjb25zdCBoMSA9IGRlY29kZU9wbG9nSGVhZGVyKHN0YXRlKQogICAgICBzdGF0ZS5zdGFydCA9IDQwOTYKCiAgICAgIGNvbnN0IGgyID0gZGVjb2RlT3Bsb2dIZWFkZXIoc3RhdGUpCiAgICAgIHN0YXRlLnN0YXJ0ID0gNDA5NiAqIDIKCiAgICAgIGlmICghaDEgJiYgIWgyKSByZXR1cm4gcmVzb2x2ZShudWxsKQoKICAgICAgaWYgKGgxICYmICFoMikgewogICAgICAgIGhlYWRlcnNbMF0gPSBoMS5oZWFkZXIKICAgICAgICBoZWFkZXJzWzFdID0gaDEuaGVhZGVyCiAgICAgIH0gZWxzZSBpZiAoIWgxICYmIGgyKSB7CiAgICAgICAgaGVhZGVyc1swXSA9IChoMi5oZWFkZXIgKyAxKSAmIDEKICAgICAgICBoZWFkZXJzWzFdID0gaDIuaGVhZGVyCiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGVhZGVyc1swXSA9IGgxLmhlYWRlcgogICAgICAgIGhlYWRlcnNbMV0gPSBoMi5oZWFkZXIKICAgICAgfQoKICAgICAgY29uc3QgaGVhZGVyID0gKGhlYWRlcnNbMF0gKyBoZWFkZXJzWzFdKSAmIDEKICAgICAgY29uc3QgcmVzdWx0ID0geyBwYXRoOiBwYXRoLmRpcm5hbWUob3Bsb2cpLCBoZWFkZXI6IG51bGwsIGVudHJpZXM6IFtdIH0KICAgICAgY29uc3QgZGVjb2RlZCA9IFtdCgogICAgICByZXN1bHQuaGVhZGVyID0gaGVhZGVyID8gaDIubWVzc2FnZSA6IGgxLm1lc3NhZ2UKCiAgICAgIGlmIChyZXN1bHQuaGVhZGVyLmV4dGVybmFsKSB7CiAgICAgICAgZnMucmVhZEZpbGUocGF0aC5qb2luKG9wbG9nLCAnLi4vaGVhZGVyJyksIGZ1bmN0aW9uIChlcnIsIGJ1ZmZlcikgewogICAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlc29sdmUobnVsbCkKICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gcmVzdWx0LmhlYWRlci5leHRlcm5hbC5zdGFydAogICAgICAgICAgY29uc3QgZW5kID0gc3RhcnQgKyByZXN1bHQuaGVhZGVyLmV4dGVybmFsLmxlbmd0aAogICAgICAgICAgcmVzdWx0LmhlYWRlciA9IG0ub3Bsb2cuaGVhZGVyLmRlY29kZSh7IGJ1ZmZlciwgc3RhcnQsIGVuZCB9KQogICAgICAgICAgZmluaXNoKCkKICAgICAgICB9KQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICBmaW5pc2goKQoKICAgICAgZnVuY3Rpb24gZmluaXNoICgpIHsKICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgY29uc3QgZW50cnkgPSBkZWNvZGVPcGxvZ0VudHJ5KHN0YXRlKQogICAgICAgICAgaWYgKCFlbnRyeSkgYnJlYWsKICAgICAgICAgIGlmIChlbnRyeS5oZWFkZXIgIT09IGhlYWRlcikgYnJlYWsKCiAgICAgICAgICBkZWNvZGVkLnB1c2goZW50cnkpCiAgICAgICAgfQoKICAgICAgICB3aGlsZSAoZGVjb2RlZC5sZW5ndGggPiAwICYmIGRlY29kZWRbZGVjb2RlZC5sZW5ndGggLSAxXS5wYXJ0aWFsKSBkZWNvZGVkLnBvcCgpCgogICAgICAgIGZvciAoY29uc3QgZSBvZiBkZWNvZGVkKSB7CiAgICAgICAgICByZXN1bHQuZW50cmllcy5wdXNoKGUubWVzc2FnZSkKICAgICAgICB9CgogICAgICAgIHJlc29sdmUocmVzdWx0KQogICAgICB9CiAgICB9KQogIH0pCn0KCmZ1bmN0aW9uIG5vb3AgKCkge30KLy8gbmVlZGVkIGhlcmUgZm9yIGNvbXBhdCwgY29waWVkIGZyb20gb2xkIGh5cGVyY29yZSwgZG8gbm90IGNoYW5nZSB0aGlzCgpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBFTVBUWSA9IGI0YS5hbGxvYygwKQpjb25zdCBERUZBVUxUX05BTUVTUEFDRSA9IGI0YS5mcm9tKCc0MTQ0ZWVhNTMxZTQ4M2Q1NGUwYzE0ZjRjYTY4ZTA2NDRmMzU1MzQzZmY2ZmNiMGYwMDUyMDBlMTJjZDc0N2NiJywgJ2hleCcpCgpjb25zdCBoYXNoZXMgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gc21hbGwgdWludAogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgaWYgKG0gPT09ICdibGFrZTJiJykgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAwKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gaGFzaDogJyArIG0pCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBuID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGlmIChuID09PSAwKSByZXR1cm4gJ2JsYWtlMmInCiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gaGFzaCBpZDogJyArIG4pCiAgfQp9Cgpjb25zdCBzaWduYXR1cmVzID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIHNtYWxsIHVpbnQKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGlmIChtID09PSAnZWQyNTUxOScpIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHNpZ25hdHVyZTogJyArIG0pCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBuID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGlmIChuID09PSAwKSByZXR1cm4gJ2VkMjU1MTknCiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gc2lnbmF0dXJlIGlkOiAnICsgbikKICB9Cn0KCmNvbnN0IHNpZ25lciA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzaWduYXR1cmVzLnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc2lnbmF0dXJlcy5lbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHNpZ25hdHVyZTogc2lnbmF0dXJlcy5kZWNvZGUoc3RhdGUpLAogICAgICBuYW1lc3BhY2U6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBwdWJsaWNLZXk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBzaWduZXJBcnJheSA9IGMuYXJyYXkoc2lnbmVyKQoKY29uc3QgcHJvbG9ndWUgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgcCkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgcC5oYXNoKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgcC5sZW5ndGgpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBwKSB7CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBwLmhhc2gpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBwLmxlbmd0aCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGhhc2g6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBtYW5pZmVzdHYwID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGhhc2hlcy5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIHN0YXRlLmVuZCsrIC8vIHR5cGUKCiAgICBpZiAobS5wcm9sb2d1ZSAmJiBtLnNpZ25lcnMubGVuZ3RoID09PSAwKSB7CiAgICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ucHJvbG9ndWUuaGFzaCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKG0ucXVvcnVtID09PSAxICYmIG0uc2lnbmVycy5sZW5ndGggPT09IDEgJiYgIW0uYWxsb3dQYXRjaCkgewogICAgICBzaWduZXIucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnNbMF0pCiAgICB9IGVsc2UgewogICAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnF1b3J1bSkKICAgICAgc2lnbmVyQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCiAgICB9CiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBoYXNoZXMuZW5jb2RlKHN0YXRlLCBtLmhhc2gpCgogICAgaWYgKG0ucHJvbG9ndWUgJiYgbS5zaWduZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAwKQogICAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlLmhhc2gpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChtLnF1b3J1bSA9PT0gMSAmJiBtLnNpZ25lcnMubGVuZ3RoID09PSAxICYmICFtLmFsbG93UGF0Y2gpIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMSkKICAgICAgc2lnbmVyLmVuY29kZShzdGF0ZSwgbS5zaWduZXJzWzBdKQogICAgfSBlbHNlIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMikKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5hbGxvd1BhdGNoID8gMSA6IDApCiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucXVvcnVtKQogICAgICBzaWduZXJBcnJheS5lbmNvZGUoc3RhdGUsIG0uc2lnbmVycykKICAgIH0KICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IGhhc2ggPSBoYXNoZXMuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgdHlwZSA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgaWYgKHR5cGUgPiAyKSB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gdHlwZTogJyArIHR5cGUpCgogICAgaWYgKHR5cGUgPT09IDApIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uOiAwLAogICAgICAgIGhhc2gsCiAgICAgICAgYWxsb3dQYXRjaDogZmFsc2UsCiAgICAgICAgcXVvcnVtOiAwLAogICAgICAgIHNpZ25lcnM6IFtdLAogICAgICAgIHByb2xvZ3VlOiB7CiAgICAgICAgICBoYXNoOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgICAgIGxlbmd0aDogMAogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmICh0eXBlID09PSAxKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmVyc2lvbjogMCwKICAgICAgICBoYXNoLAogICAgICAgIGFsbG93UGF0Y2g6IGZhbHNlLAogICAgICAgIHF1b3J1bTogMSwKICAgICAgICBzaWduZXJzOiBbc2lnbmVyLmRlY29kZShzdGF0ZSldLAogICAgICAgIHByb2xvZ3VlOiBudWxsCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogMCwKICAgICAgaGFzaCwKICAgICAgYWxsb3dQYXRjaDogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIHF1b3J1bTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25lcnM6IHNpZ25lckFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIHByb2xvZ3VlOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBtYW5pZmVzdCA9IGV4cG9ydHMubWFuaWZlc3QgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gdmVyc2lvbgogICAgaWYgKG0udmVyc2lvbiA9PT0gMCkgcmV0dXJuIG1hbmlmZXN0djAucHJlZW5jb2RlKHN0YXRlLCBtKQoKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBoYXNoZXMucHJlZW5jb2RlKHN0YXRlLCBtLmhhc2gpCgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5xdW9ydW0pCiAgICBzaWduZXJBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmVycykKICAgIGlmIChtLnByb2xvZ3VlKSBwcm9sb2d1ZS5wcmVlbmNvZGUoc3RhdGUsIG0ucHJvbG9ndWUpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBpZiAobS52ZXJzaW9uID09PSAwKSByZXR1cm4gbWFuaWZlc3R2MC5lbmNvZGUoc3RhdGUsIG0pCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgKG0uYWxsb3dQYXRjaCA/IDEgOiAwKSB8IChtLnByb2xvZ3VlID8gMiA6IDApIHwgKG0udW5lbmNyeXB0ZWQgPyA0IDogMCkpCiAgICBoYXNoZXMuZW5jb2RlKHN0YXRlLCBtLmhhc2gpCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5xdW9ydW0pCiAgICBzaWduZXJBcnJheS5lbmNvZGUoc3RhdGUsIG0uc2lnbmVycykKICAgIGlmIChtLnByb2xvZ3VlKSBwcm9sb2d1ZS5lbmNvZGUoc3RhdGUsIG0ucHJvbG9ndWUpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCB2ID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGlmICh2ID09PSAwKSByZXR1cm4gbWFuaWZlc3R2MC5kZWNvZGUoc3RhdGUpCiAgICBpZiAodiAhPT0gMSkgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHZlcnNpb246ICcgKyB2KQoKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGhhc2ggPSBoYXNoZXMuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcXVvcnVtID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHNpZ25lcnMgPSBzaWduZXJBcnJheS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCB1bmVuY3J5cHRlZCA9IChmbGFncyAmIDQpICE9PSAwCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogMSwKICAgICAgaGFzaCwKICAgICAgYWxsb3dQYXRjaDogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIHF1b3J1bSwKICAgICAgc2lnbmVycywKICAgICAgcHJvbG9ndWU6IChmbGFncyAmIDIpID09PSAwID8gbnVsbCA6IHByb2xvZ3VlLmRlY29kZShzdGF0ZSksCiAgICAgIHVuZW5jcnlwdGVkCiAgICB9CiAgfQp9Cgpjb25zdCBub2RlID0gewogIHByZWVuY29kZSAoc3RhdGUsIG4pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4uaW5kZXgpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLnNpemUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBuLmhhc2gpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLmluZGV4KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5zaXplKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbi5oYXNoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaXplOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgaGFzaDogYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IG5vZGVBcnJheSA9IGMuYXJyYXkobm9kZSkKCmNvbnN0IHdpcmUgPSBleHBvcnRzLndpcmUgPSB7fQoKd2lyZS5oYW5kc2hha2UgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgMSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0uY2FwYWJpbGl0eSkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc2Vla3MgPyAxIDogMCkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0uY2FwYWJpbGl0eSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIHNlZWtzOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgY2FwYWJpbGl0eTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlcXVlc3RCbG9jayA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGVuY29kZSAoc3RhdGUsIGIpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBub2RlczogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlcXVlc3RTZWVrID0gewogIHByZWVuY29kZSAoc3RhdGUsIHMpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHMuYnl0ZXMpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBzLnBhZGRpbmcpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBzKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBzLmJ5dGVzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgcy5wYWRkaW5nKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgYnl0ZXM6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBwYWRkaW5nOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVxdWVzdFVwZ3JhZGUgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgdSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgdSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLnJlcXVlc3QgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uaWQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmZvcmspCgogICAgaWYgKG0uYmxvY2spIHJlcXVlc3RCbG9jay5wcmVlbmNvZGUoc3RhdGUsIG0uYmxvY2spCiAgICBpZiAobS5oYXNoKSByZXF1ZXN0QmxvY2sucHJlZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBpZiAobS5zZWVrKSByZXF1ZXN0U2Vlay5wcmVlbmNvZGUoc3RhdGUsIG0uc2VlaykKICAgIGlmIChtLnVwZ3JhZGUpIHJlcXVlc3RVcGdyYWRlLnByZWVuY29kZShzdGF0ZSwgbS51cGdyYWRlKQogICAgaWYgKG0ucHJpb3JpdHkpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucHJpb3JpdHkpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLmJsb2NrID8gMSA6IDApIHwgKG0uaGFzaCA/IDIgOiAwKSB8IChtLnNlZWsgPyA0IDogMCkgfCAobS51cGdyYWRlID8gOCA6IDApIHwgKG0ubWFuaWZlc3QgPyAxNiA6IDApIHwgKG0ucHJpb3JpdHkgPyAzMiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5mb3JrKQoKICAgIGlmIChtLmJsb2NrKSByZXF1ZXN0QmxvY2suZW5jb2RlKHN0YXRlLCBtLmJsb2NrKQogICAgaWYgKG0uaGFzaCkgcmVxdWVzdEJsb2NrLmVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgaWYgKG0uc2VlaykgcmVxdWVzdFNlZWsuZW5jb2RlKHN0YXRlLCBtLnNlZWspCiAgICBpZiAobS51cGdyYWRlKSByZXF1ZXN0VXBncmFkZS5lbmNvZGUoc3RhdGUsIG0udXBncmFkZSkKICAgIGlmIChtLnByaW9yaXR5KSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnByaW9yaXR5KQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGlkOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgZm9yazogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGJsb2NrOiBmbGFncyAmIDEgPyByZXF1ZXN0QmxvY2suZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGhhc2g6IGZsYWdzICYgMiA/IHJlcXVlc3RCbG9jay5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgc2VlazogZmxhZ3MgJiA0ID8gcmVxdWVzdFNlZWsuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHVwZ3JhZGU6IGZsYWdzICYgOCA/IHJlcXVlc3RVcGdyYWRlLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBtYW5pZmVzdDogKGZsYWdzICYgMTYpICE9PSAwLAogICAgICBwcmlvcml0eTogZmxhZ3MgJiAzMiA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgfQogIH0KfQoKd2lyZS5jYW5jZWwgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZXF1ZXN0KQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZXF1ZXN0KQogIH0sCiAgZGVjb2RlIChzdGF0ZSwgbSkgewogICAgcmV0dXJuIHsKICAgICAgcmVxdWVzdDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGRhdGFVcGdyYWRlID0gewogIHByZWVuY29kZSAoc3RhdGUsIHUpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUuc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICAgIG5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIHUubm9kZXMpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCB1LmFkZGl0aW9uYWxOb2RlcykKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdS5zaWduYXR1cmUpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1LnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgICBub2RlQXJyYXkuZW5jb2RlKHN0YXRlLCB1Lm5vZGVzKQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgdS5hZGRpdGlvbmFsTm9kZXMpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHUuc2lnbmF0dXJlKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBub2Rlczogbm9kZUFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIGFkZGl0aW9uYWxOb2Rlczogbm9kZUFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25hdHVyZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgZGF0YVNlZWsgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgcykgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgcy5ieXRlcykKICAgIG5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIHMubm9kZXMpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBzKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBzLmJ5dGVzKQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgcy5ub2RlcykKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGJ5dGVzOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbm9kZXM6IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBkYXRhQmxvY2sgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgYikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgYi52YWx1ZSkKICAgIG5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBiLnZhbHVlKQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGluZGV4OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgdmFsdWU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkgfHwgRU1QVFksCiAgICAgIG5vZGVzOiBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgZGF0YUhhc2ggPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgYikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIG5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGluZGV4OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbm9kZXM6IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLmRhdGEgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZm9yaykKCiAgICBpZiAobS5ibG9jaykgZGF0YUJsb2NrLnByZWVuY29kZShzdGF0ZSwgbS5ibG9jaykKICAgIGlmIChtLmhhc2gpIGRhdGFIYXNoLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgaWYgKG0uc2VlaykgZGF0YVNlZWsucHJlZW5jb2RlKHN0YXRlLCBtLnNlZWspCiAgICBpZiAobS51cGdyYWRlKSBkYXRhVXBncmFkZS5wcmVlbmNvZGUoc3RhdGUsIG0udXBncmFkZSkKICAgIGlmIChtLm1hbmlmZXN0KSBtYW5pZmVzdC5wcmVlbmNvZGUoc3RhdGUsIG0ubWFuaWZlc3QpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLmJsb2NrID8gMSA6IDApIHwgKG0uaGFzaCA/IDIgOiAwKSB8IChtLnNlZWsgPyA0IDogMCkgfCAobS51cGdyYWRlID8gOCA6IDApIHwgKG0ubWFuaWZlc3QgPyAxNiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmZvcmspCgogICAgaWYgKG0uYmxvY2spIGRhdGFCbG9jay5lbmNvZGUoc3RhdGUsIG0uYmxvY2spCiAgICBpZiAobS5oYXNoKSBkYXRhSGFzaC5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGlmIChtLnNlZWspIGRhdGFTZWVrLmVuY29kZShzdGF0ZSwgbS5zZWVrKQogICAgaWYgKG0udXBncmFkZSkgZGF0YVVwZ3JhZGUuZW5jb2RlKHN0YXRlLCBtLnVwZ3JhZGUpCiAgICBpZiAobS5tYW5pZmVzdCkgbWFuaWZlc3QuZW5jb2RlKHN0YXRlLCBtLm1hbmlmZXN0KQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHJlcXVlc3Q6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBmb3JrOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYmxvY2s6IGZsYWdzICYgMSA/IGRhdGFCbG9jay5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgaGFzaDogZmxhZ3MgJiAyID8gZGF0YUhhc2guZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHNlZWs6IGZsYWdzICYgNCA/IGRhdGFTZWVrLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB1cGdyYWRlOiBmbGFncyAmIDggPyBkYXRhVXBncmFkZS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgbWFuaWZlc3Q6IGZsYWdzICYgMTYgPyBtYW5pZmVzdC5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKd2lyZS5ub0RhdGEgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZXF1ZXN0KQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZXF1ZXN0KQogIH0sCiAgZGVjb2RlIChzdGF0ZSwgbSkgewogICAgcmV0dXJuIHsKICAgICAgcmVxdWVzdDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUud2FudCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUudW53YW50ID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZSAoc3RhdGUsIG0pIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5yYW5nZSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGlmIChtLmxlbmd0aCAhPT0gMSkgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAobS5kcm9wID8gMSA6IDApIHwgKG0ubGVuZ3RoID09PSAxID8gMiA6IDApKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGlmIChtLmxlbmd0aCAhPT0gMSkgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgZHJvcDogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IDEgOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5iaXRmaWVsZCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50MzJhcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0uYml0ZmllbGQpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50MzJhcnJheS5lbmNvZGUoc3RhdGUsIG0uYml0ZmllbGQpCiAgfSwKICBkZWNvZGUgKHN0YXRlLCBtKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGJpdGZpZWxkOiBjLnVpbnQzMmFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUuc3luYyA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5mb3JrKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnJlbW90ZUxlbmd0aCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIChtLmNhblVwZ3JhZGUgPyAxIDogMCkgfCAobS51cGxvYWRpbmcgPyAyIDogMCkgfCAobS5kb3dubG9hZGluZyA/IDQgOiAwKSB8IChtLmhhc01hbmlmZXN0ID8gOCA6IDApKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5mb3JrKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlbW90ZUxlbmd0aCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBmb3JrOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgcmVtb3RlTGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgY2FuVXBncmFkZTogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIHVwbG9hZGluZzogKGZsYWdzICYgMikgIT09IDAsCiAgICAgIGRvd25sb2FkaW5nOiAoZmxhZ3MgJiA0KSAhPT0gMCwKICAgICAgaGFzTWFuaWZlc3Q6IChmbGFncyAmIDgpICE9PSAwCiAgICB9CiAgfQp9Cgp3aXJlLnJlb3JnSGludCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmZyb20pCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnRvKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5hbmNlc3RvcnMpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmZyb20pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnRvKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5hbmNlc3RvcnMpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBmcm9tOiBjLnVpbnQuZW5jb2RlKHN0YXRlKSwKICAgICAgdG86IGMudWludC5lbmNvZGUoc3RhdGUpLAogICAgICBhbmNlc3RvcnM6IGMudWludC5lbmNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLmV4dGVuc2lvbiA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIG0ubmFtZSkKICAgIGMucmF3LnByZWVuY29kZShzdGF0ZSwgbS5tZXNzYWdlKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCBtLm5hbWUpCiAgICBjLnJhdy5lbmNvZGUoc3RhdGUsIG0ubWVzc2FnZSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSksCiAgICAgIG1lc3NhZ2U6IGMucmF3LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGtleVZhbHVlID0gewogIHByZWVuY29kZSAoc3RhdGUsIHApIHsKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgcC5rZXkpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHAudmFsdWUpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBwKSB7CiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIHAua2V5KQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBwLnZhbHVlKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAga2V5OiBjLnN0cmluZy5kZWNvZGUoc3RhdGUpLAogICAgICB2YWx1ZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgdHJlZVVwZ3JhZGUgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgdSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5mb3JrKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5hbmNlc3RvcnMpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdS5zaWduYXR1cmUpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1LmZvcmspCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1LmFuY2VzdG9ycykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB1LnNpZ25hdHVyZSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGZvcms6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBhbmNlc3RvcnM6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGJpdGZpZWxkVXBkYXRlID0geyAvLyBUT0RPOiBjYW4gbWF5YmUgYmUgZm9sZGVkIGludG8gYSBIQVZFIGxhdGVyIG9uIHdpdGggdGhlIG1vc3QgcmVjZW50IHNwZWMKICBwcmVlbmNvZGUgKHN0YXRlLCBiKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgYi5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIubGVuZ3RoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgYikgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gYi5kcm9wID8gMSA6IDAKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGIuc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLmxlbmd0aCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIGRyb3A6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IG9wbG9nID0gZXhwb3J0cy5vcGxvZyA9IHt9CgpvcGxvZy5lbnRyeSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgaWYgKG0udXNlckRhdGEpIGtleVZhbHVlLnByZWVuY29kZShzdGF0ZSwgbS51c2VyRGF0YSkKICAgIGlmIChtLnRyZWVOb2Rlcykgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgbS50cmVlTm9kZXMpCiAgICBpZiAobS50cmVlVXBncmFkZSkgdHJlZVVwZ3JhZGUucHJlZW5jb2RlKHN0YXRlLCBtLnRyZWVVcGdyYWRlKQogICAgaWYgKG0uYml0ZmllbGQpIGJpdGZpZWxkVXBkYXRlLnByZWVuY29kZShzdGF0ZSwgbS5iaXRmaWVsZCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGNvbnN0IHMgPSBzdGF0ZS5zdGFydCsrCiAgICBsZXQgZmxhZ3MgPSAwCgogICAgaWYgKG0udXNlckRhdGEpIHsKICAgICAgZmxhZ3MgfD0gMQogICAgICBrZXlWYWx1ZS5lbmNvZGUoc3RhdGUsIG0udXNlckRhdGEpCiAgICB9CiAgICBpZiAobS50cmVlTm9kZXMpIHsKICAgICAgZmxhZ3MgfD0gMgogICAgICBub2RlQXJyYXkuZW5jb2RlKHN0YXRlLCBtLnRyZWVOb2RlcykKICAgIH0KICAgIGlmIChtLnRyZWVVcGdyYWRlKSB7CiAgICAgIGZsYWdzIHw9IDQKICAgICAgdHJlZVVwZ3JhZGUuZW5jb2RlKHN0YXRlLCBtLnRyZWVVcGdyYWRlKQogICAgfQogICAgaWYgKG0uYml0ZmllbGQpIHsKICAgICAgZmxhZ3MgfD0gOAogICAgICBiaXRmaWVsZFVwZGF0ZS5lbmNvZGUoc3RhdGUsIG0uYml0ZmllbGQpCiAgICB9CgogICAgc3RhdGUuYnVmZmVyW3NdID0gZmxhZ3MKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIHVzZXJEYXRhOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGtleVZhbHVlLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB0cmVlTm9kZXM6IChmbGFncyAmIDIpICE9PSAwID8gbm9kZUFycmF5LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB0cmVlVXBncmFkZTogKGZsYWdzICYgNCkgIT09IDAgPyB0cmVlVXBncmFkZS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgYml0ZmllbGQ6IChmbGFncyAmIDgpICE9PSAwID8gYml0ZmllbGRVcGRhdGUuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IGtleVBhaXIgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwga3ApIHsKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwga3AucHVibGljS2V5KQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBrcC5zZWNyZXRLZXkpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBrcCkgewogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBrcC5wdWJsaWNLZXkpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIGtwLnNlY3JldEtleSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHB1YmxpY0tleTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgc2VjcmV0S2V5OiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZW9yZ0hpbnQgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgcikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgci5mcm9tKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgci50bykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHIuYW5jZXN0b3JzKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgcikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgci5mcm9tKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgci50bykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHIuYW5jZXN0b3JzKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgZnJvbTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHRvOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYW5jZXN0b3JzOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVvcmdIaW50QXJyYXkgPSBjLmFycmF5KHJlb3JnSGludCkKCmNvbnN0IGhpbnRzID0gewogIHByZWVuY29kZSAoc3RhdGUsIGgpIHsKICAgIHJlb3JnSGludEFycmF5LnByZWVuY29kZShzdGF0ZSwgaC5yZW9yZ3MpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBoLmNvbnRpZ3VvdXNMZW5ndGgpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBoKSB7CiAgICByZW9yZ0hpbnRBcnJheS5lbmNvZGUoc3RhdGUsIGgucmVvcmdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgaC5jb250aWd1b3VzTGVuZ3RoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcmVvcmdzOiByZW9yZ0hpbnRBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICBjb250aWd1b3VzTGVuZ3RoOiBzdGF0ZS5zdGFydCA8IHN0YXRlLmVuZCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgfQogIH0KfQoKY29uc3QgdHJlZUhlYWRlciA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCB0KSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB0LmZvcmspCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB0Lmxlbmd0aCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdC5yb290SGFzaCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdC5zaWduYXR1cmUpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCB0KSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB0LmZvcmspCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB0Lmxlbmd0aCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgdC5yb290SGFzaCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgdC5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBmb3JrOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgcm9vdEhhc2g6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25hdHVyZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgdHlwZXMgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgdCkgewogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCB0LnRyZWUpCiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIHQuYml0ZmllbGQpCiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIHQuc2lnbmVyKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgdCkgewogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCB0LnRyZWUpCiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIHQuYml0ZmllbGQpCiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIHQuc2lnbmVyKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgdHJlZTogYy5zdHJpbmcuZGVjb2RlKHN0YXRlKSwKICAgICAgYml0ZmllbGQ6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25lcjogYy5zdHJpbmcuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgZXh0ZXJuYWxIZWFkZXIgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBrZXlWYWx1ZUFycmF5ID0gYy5hcnJheShrZXlWYWx1ZSkKCm9wbG9nLmhlYWRlciA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBoKSB7CiAgICBzdGF0ZS5lbmQgKz0gMiAvLyB2ZXJzaW9uICsgZmxhZ3MKICAgIGlmIChoLmV4dGVybmFsKSB7CiAgICAgIGV4dGVybmFsSGVhZGVyLnByZWVuY29kZShzdGF0ZSwgaC5leHRlcm5hbCkKICAgICAgcmV0dXJuCiAgICB9CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBoLmtleSkKICAgIGlmIChoLm1hbmlmZXN0KSBtYW5pZmVzdC5wcmVlbmNvZGUoc3RhdGUsIGgubWFuaWZlc3QpCiAgICBpZiAoaC5rZXlQYWlyKSBrZXlQYWlyLnByZWVuY29kZShzdGF0ZSwgaC5rZXlQYWlyKQogICAga2V5VmFsdWVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIGgudXNlckRhdGEpCiAgICB0cmVlSGVhZGVyLnByZWVuY29kZShzdGF0ZSwgaC50cmVlKQogICAgaGludHMucHJlZW5jb2RlKHN0YXRlLCBoLmhpbnRzKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgaCkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgMSkKICAgIGlmIChoLmV4dGVybmFsKSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpIC8vIE9OTFkgc2V0IHRoZSBmaXJzdCBiaWcgZm9yIGNsYXJpdHkKICAgICAgZXh0ZXJuYWxIZWFkZXIuZW5jb2RlKHN0YXRlLCBoLmV4dGVybmFsKQogICAgICByZXR1cm4KICAgIH0KICAgIGMudWludC5lbmNvZGUoc3RhdGUsIChoLm1hbmlmZXN0ID8gMiA6IDApIHwgKGgua2V5UGFpciA/IDQgOiAwKSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIGgua2V5KQogICAgaWYgKGgubWFuaWZlc3QpIG1hbmlmZXN0LmVuY29kZShzdGF0ZSwgaC5tYW5pZmVzdCkKICAgIGlmIChoLmtleVBhaXIpIGtleVBhaXIuZW5jb2RlKHN0YXRlLCBoLmtleVBhaXIpCiAgICBrZXlWYWx1ZUFycmF5LmVuY29kZShzdGF0ZSwgaC51c2VyRGF0YSkKICAgIHRyZWVIZWFkZXIuZW5jb2RlKHN0YXRlLCBoLnRyZWUpCiAgICBoaW50cy5lbmNvZGUoc3RhdGUsIGguaGludHMpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAodmVyc2lvbiA+IDEpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGhlYWRlciB2ZXJzaW9uLiBFeHBlY3RlZCA8PSAxLCBnb3QgJyArIHZlcnNpb24pCiAgICB9CgogICAgaWYgKHZlcnNpb24gPT09IDApIHsKICAgICAgY29uc3Qgb2xkID0gewogICAgICAgIHR5cGVzOiB0eXBlcy5kZWNvZGUoc3RhdGUpLAogICAgICAgIHVzZXJEYXRhOiBrZXlWYWx1ZUFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgICAgdHJlZTogdHJlZUhlYWRlci5kZWNvZGUoc3RhdGUpLAogICAgICAgIHNpZ25lcjoga2V5UGFpci5kZWNvZGUoc3RhdGUpLAogICAgICAgIGhpbnRzOiBoaW50cy5kZWNvZGUoc3RhdGUpCiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgZXh0ZXJuYWw6IG51bGwsCiAgICAgICAga2V5OiBvbGQuc2lnbmVyLnB1YmxpY0tleSwKICAgICAgICBtYW5pZmVzdDogewogICAgICAgICAgdmVyc2lvbjogMCwKICAgICAgICAgIGhhc2g6IG9sZC50eXBlcy50cmVlLAogICAgICAgICAgYWxsb3dQYXRjaDogZmFsc2UsCiAgICAgICAgICBxdW9ydW06IDEsCiAgICAgICAgICBzaWduZXJzOiBbewogICAgICAgICAgICBzaWduYXR1cmU6IG9sZC50eXBlcy5zaWduZXIsCiAgICAgICAgICAgIG5hbWVzcGFjZTogREVGQVVMVF9OQU1FU1BBQ0UsCiAgICAgICAgICAgIHB1YmxpY0tleTogb2xkLnNpZ25lci5wdWJsaWNLZXkKICAgICAgICAgIH1dLAogICAgICAgICAgcHJvbG9ndWU6IG51bGwKICAgICAgICB9LAogICAgICAgIGtleVBhaXI6IG9sZC5zaWduZXIuc2VjcmV0S2V5ID8gb2xkLnNpZ25lciA6IG51bGwsCiAgICAgICAgdXNlckRhdGE6IG9sZC51c2VyRGF0YSwKICAgICAgICB0cmVlOiBvbGQudHJlZSwKICAgICAgICBoaW50czogb2xkLmhpbnRzCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgaWYgKGZsYWdzICYgMSkgewogICAgICByZXR1cm4gewogICAgICAgIGV4dGVybmFsOiBleHRlcm5hbEhlYWRlci5kZWNvZGUoc3RhdGUpLAogICAgICAgIGtleTogbnVsbCwKICAgICAgICBtYW5pZmVzdDogbnVsbCwKICAgICAgICBrZXlQYWlyOiBudWxsLAogICAgICAgIHVzZXJEYXRhOiBudWxsLAogICAgICAgIHRyZWU6IG51bGwsCiAgICAgICAgaGludHM6IG51bGwKICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGV4dGVybmFsOiBudWxsLAogICAgICBrZXk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBtYW5pZmVzdDogKGZsYWdzICYgMikgIT09IDAgPyBtYW5pZmVzdC5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAga2V5UGFpcjogKGZsYWdzICYgNCkgIT09IDAgPyBrZXlQYWlyLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB1c2VyRGF0YToga2V5VmFsdWVBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICB0cmVlOiB0cmVlSGVhZGVyLmRlY29kZShzdGF0ZSksCiAgICAgIGhpbnRzOiBoaW50cy5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCB1aW50QXJyYXkgPSBjLmFycmF5KGMudWludCkKCmNvbnN0IG11bHRpc2lnSW5wdXQgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgaW5wKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBpbnAuc2lnbmVyKQogICAgYy5maXhlZDY0LnByZWVuY29kZShzdGF0ZSwgaW5wLnNpZ25hdHVyZSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGlucC5wYXRjaCkKICB9LAogIGVuY29kZSAoc3RhdGUsIGlucCkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgaW5wLnNpZ25lcikKICAgIGMuZml4ZWQ2NC5lbmNvZGUoc3RhdGUsIGlucC5zaWduYXR1cmUpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBpbnAucGF0Y2gpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzaWduZXI6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuZml4ZWQ2NC5kZWNvZGUoc3RhdGUpLAogICAgICBwYXRjaDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHBhdGNoRW5jb2Rpbmd2MCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5sZW5ndGgpCiAgICB1aW50QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBuLm5vZGVzKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4ubGVuZ3RoKQogICAgdWludEFycmF5LmVuY29kZShzdGF0ZSwgbi5ub2RlcykKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbm9kZXM6IHVpbnRBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBtdWx0aXNpZ0lucHV0djAgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kKysKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4uc2lnbmVyKQogICAgYy5maXhlZDY0LnByZWVuY29kZShzdGF0ZSwgbi5zaWduYXR1cmUpCiAgICBpZiAobi5wYXRjaCkgcGF0Y2hFbmNvZGluZ3YwLnByZWVuY29kZShzdGF0ZSwgbi5wYXRjaCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG4pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4ucGF0Y2ggPyAxIDogMCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uc2lnbmVyKQogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgbi5zaWduYXR1cmUpCiAgICBpZiAobi5wYXRjaCkgcGF0Y2hFbmNvZGluZ3YwLmVuY29kZShzdGF0ZSwgbi5wYXRjaCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIHNpZ25lcjogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25hdHVyZTogYy5maXhlZDY0LmRlY29kZShzdGF0ZSksCiAgICAgIHBhdGNoOiAoZmxhZ3MgJiAxKSA/IHBhdGNoRW5jb2Rpbmd2MC5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKY29uc3QgbXVsdGlzaWdJbnB1dEFycmF5djAgPSBjLmFycmF5KG11bHRpc2lnSW5wdXR2MCkKY29uc3QgbXVsdGlzaWdJbnB1dEFycmF5ID0gYy5hcnJheShtdWx0aXNpZ0lucHV0KQoKY29uc3QgY29tcGFjdE5vZGUgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5pbmRleCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4uc2l6ZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG4uaGFzaCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG4pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uaW5kZXgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLnNpemUpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBuLmhhc2gpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpbmRleDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpemU6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBoYXNoOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgY29tcGFjdE5vZGVBcnJheSA9IGMuYXJyYXkoY29tcGFjdE5vZGUpCgpleHBvcnRzLm11bHRpU2lnbmF0dXJldjAgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgcykgewogICAgbXVsdGlzaWdJbnB1dEFycmF5djAucHJlZW5jb2RlKHN0YXRlLCBzLnByb29mcykKICAgIGNvbXBhY3ROb2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBzLnBhdGNoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgcykgewogICAgbXVsdGlzaWdJbnB1dEFycmF5djAuZW5jb2RlKHN0YXRlLCBzLnByb29mcykKICAgIGNvbXBhY3ROb2RlQXJyYXkuZW5jb2RlKHN0YXRlLCBzLnBhdGNoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcHJvb2ZzOiBtdWx0aXNpZ0lucHV0QXJyYXl2MC5kZWNvZGUoc3RhdGUpLAogICAgICBwYXRjaDogY29tcGFjdE5vZGVBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CgpleHBvcnRzLm11bHRpU2lnbmF0dXJlID0gewogIHByZWVuY29kZSAoc3RhdGUsIHMpIHsKICAgIG11bHRpc2lnSW5wdXRBcnJheS5wcmVlbmNvZGUoc3RhdGUsIHMucHJvb2ZzKQogICAgY29tcGFjdE5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIHMucGF0Y2gpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBzKSB7CiAgICBtdWx0aXNpZ0lucHV0QXJyYXkuZW5jb2RlKHN0YXRlLCBzLnByb29mcykKICAgIGNvbXBhY3ROb2RlQXJyYXkuZW5jb2RlKHN0YXRlLCBzLnBhdGNoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcHJvb2ZzOiBtdWx0aXNpZ0lucHV0QXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgcGF0Y2g6IGNvbXBhY3ROb2RlQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQp7CiAgIm5hbWUiOiAiaHlwZXJjb3JlLXN0b3JhZ2UiLAogICJ2ZXJzaW9uIjogIjIuNC4xIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJsaWIvKi5qcyIsCiAgICAic3BlYy9oeXBlcnNjaGVtYS8qLmpzIiwKICAgICJtaWdyYXRpb25zLzAvKi5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuICYmIGx1bnRlIiwKICAgICJ0ZXN0IjogIm5vZGUgdGVzdC9hbGwuanMiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmdlbmVyYXRlIjogImJyaXR0bGUgLXIgdGVzdC9hbGwuanMgdGVzdC8qLmpzIgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2ggSW5jLiIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImRlc2NyaXB0aW9uIjogIlN0b3JhZ2UgZW5naW5lIGZvciBIeXBlcmNvcmUiLAogICJpbXBvcnRzIjogewogICAgImZzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWZzIiwKICAgICAgImRlZmF1bHQiOiAiZnMiCiAgICB9LAogICAgInBhdGgiOiB7CiAgICAgICJiYXJlIjogImJhcmUtcGF0aCIsCiAgICAgICJkZWZhdWx0IjogInBhdGgiCiAgICB9CiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjciLAogICAgImJhcmUtZnMiOiAiXjQuMC4xIiwKICAgICJiYXJlLXBhdGgiOiAiXjMuMC4wIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjE2LjAiLAogICAgImRldmljZS1maWxlIjogIl4yLjEuMiIsCiAgICAiZmxhdC10cmVlIjogIl4xLjEyLjEiLAogICAgImh5cGVyY29yZS1jcnlwdG8iOiAiXjMuNC4yIiwKICAgICJoeXBlcnNjaGVtYSI6ICJeMS43LjAiLAogICAgImluZGV4LWVuY29kZXIiOiAiXjMuMy4yIiwKICAgICJyZXNvbHZlLXJlamVjdC1wcm9taXNlIjogIl4xLjAuMCIsCiAgICAicm9ja3NkYi1uYXRpdmUiOiAiXjMuMTEuMCIsCiAgICAic2NvcGUtbG9jayI6ICJeMS4yLjQiLAogICAgInN0cmVhbXgiOiAiXjIuMjEuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy43LjAiLAogICAgImx1bnRlIjogIl4xLjIuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIsCiAgICAidGVzdC10bXAiOiAiXjEuMy4xIgogIH0KfQovLyBUaGlzIGZpbGUgaXMgYXV0b2dlbmVyYXRlZCBieSB0aGUgaHlwZXJzY2hlbWEgY29tcGlsZXIKLy8gU2NoZW1hIFZlcnNpb246IDEKLyogZXNsaW50LWRpc2FibGUgY2FtZWxjYXNlICovCi8qIGVzbGludC1kaXNhYmxlIHF1b3RlcyAqLwovKiBlc2xpbnQtZGlzYWJsZSBzcGFjZS1iZWZvcmUtZnVuY3Rpb24tcGFyZW4gKi8KCmNvbnN0IHsgYyB9ID0gcmVxdWlyZSgnaHlwZXJzY2hlbWEvcnVudGltZScpCgpjb25zdCBWRVJTSU9OID0gMQoKLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC12YXJzCmxldCB2ZXJzaW9uID0gVkVSU0lPTgoKLy8gQGNvcmVzdG9yZS9hbGxvY2F0ZWQKY29uc3QgZW5jb2RpbmcwID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5jb3JlcykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZGF0YXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uY29yZXMpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmRhdGFzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgY29yZXM6IHIwLAogICAgICBkYXRhczogcjEKICAgIH0KICB9Cn0KCi8vIEBjb3Jlc3RvcmUvaGVhZApjb25zdCBlbmNvZGluZzEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyA0IHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLmFsbG9jYXRlZCkgZW5jb2RpbmcwLnByZWVuY29kZShzdGF0ZSwgbS5hbGxvY2F0ZWQpCiAgICBpZiAobS5zZWVkKSBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnNlZWQpCiAgICBpZiAobS5kZWZhdWx0RGlzY292ZXJ5S2V5KSBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmRlZmF1bHREaXNjb3ZlcnlLZXkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0KICAgICAgKG0uYWxsb2NhdGVkID8gMSA6IDApIHwKICAgICAgKG0uc2VlZCA/IDIgOiAwKSB8CiAgICAgIChtLmRlZmF1bHREaXNjb3ZlcnlLZXkgPyA0IDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5hbGxvY2F0ZWQpIGVuY29kaW5nMC5lbmNvZGUoc3RhdGUsIG0uYWxsb2NhdGVkKQogICAgaWYgKG0uc2VlZCkgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5zZWVkKQogICAgaWYgKG0uZGVmYXVsdERpc2NvdmVyeUtleSkgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5kZWZhdWx0RGlzY292ZXJ5S2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogcjAsCiAgICAgIGFsbG9jYXRlZDogKGZsYWdzICYgMSkgIT09IDAgPyBlbmNvZGluZzAuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHNlZWQ6IChmbGFncyAmIDIpICE9PSAwID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBkZWZhdWx0RGlzY292ZXJ5S2V5OiAoZmxhZ3MgJiA0KSAhPT0gMCA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKLy8gQGNvcmVzdG9yZS9hbGlhcwpjb25zdCBlbmNvZGluZzIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIG0ubmFtZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ubmFtZXNwYWNlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIG0ubmFtZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ubmFtZXNwYWNlKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMuc3RyaW5nLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBuYW1lOiByMCwKICAgICAgbmFtZXNwYWNlOiByMQogICAgfQogIH0KfQoKLy8gQGNvcmVzdG9yZS9jb3JlCmNvbnN0IGVuY29kaW5nMyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uY29yZVBvaW50ZXIpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmRhdGFQb2ludGVyKQogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMSBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5hbGlhcykgZW5jb2RpbmcyLnByZWVuY29kZShzdGF0ZSwgbS5hbGlhcykKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSBtLmFsaWFzID8gMSA6IDAKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmNvcmVQb2ludGVyKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5kYXRhUG9pbnRlcikKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLmFsaWFzKSBlbmNvZGluZzIuZW5jb2RlKHN0YXRlLCBtLmFsaWFzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogcjAsCiAgICAgIGNvcmVQb2ludGVyOiByMSwKICAgICAgZGF0YVBvaW50ZXI6IHIyLAogICAgICBhbGlhczogKGZsYWdzICYgMSkgIT09IDAgPyBlbmNvZGluZzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IGVuY29kaW5nNF9lbnVtID0gewogIGJsYWtlMmI6ICdibGFrZTJiJwp9CgovLyBAY29yZS9oYXNoZXMgZW51bQpjb25zdCBlbmNvZGluZzQgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gbWF4IGVudW0gaXMgMCBzbyBhbHdheXMgb25lIGJ5dGUKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN3aXRjaCAobSkgewogICAgICBjYXNlICdibGFrZTJiJzoKICAgICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAwKQogICAgICAgIGJyZWFrCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGVudW0nKQogICAgfQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgc3dpdGNoIChjLnVpbnQuZGVjb2RlKHN0YXRlKSkgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuICdibGFrZTJiJwogICAgICBkZWZhdWx0OiByZXR1cm4gbnVsbAogICAgfQogIH0KfQoKY29uc3QgZW5jb2Rpbmc1X2VudW0gPSB7CiAgZWQyNTUxOTogJ2VkMjU1MTknCn0KCi8vIEBjb3JlL3NpZ25hdHVyZXMgZW51bQpjb25zdCBlbmNvZGluZzUgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gbWF4IGVudW0gaXMgMCBzbyBhbHdheXMgb25lIGJ5dGUKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN3aXRjaCAobSkgewogICAgICBjYXNlICdlZDI1NTE5JzoKICAgICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAwKQogICAgICAgIGJyZWFrCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGVudW0nKQogICAgfQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgc3dpdGNoIChjLnVpbnQuZGVjb2RlKHN0YXRlKSkgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuICdlZDI1NTE5JwogICAgICBkZWZhdWx0OiByZXR1cm4gbnVsbAogICAgfQogIH0KfQoKLy8gQGNvcmUvdHJlZS1ub2RlCmNvbnN0IGVuY29kaW5nNiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uaW5kZXgpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnNpemUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uaW5kZXgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnNpemUpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIyID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBpbmRleDogcjAsCiAgICAgIHNpemU6IHIxLAogICAgICBoYXNoOiByMgogICAgfQogIH0KfQoKLy8gQGNvcmUvc2lnbmVyCmNvbnN0IGVuY29kaW5nNyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGVuY29kaW5nNS5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgZW5jb2Rpbmc1LmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGVuY29kaW5nNS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMiA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgc2lnbmF0dXJlOiByMCwKICAgICAgbmFtZXNwYWNlOiByMSwKICAgICAgcHVibGljS2V5OiByMgogICAgfQogIH0KfQoKLy8gQGNvcmUvcHJvbG9ndWUKY29uc3QgZW5jb2Rpbmc4ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgaGFzaDogcjAsCiAgICAgIGxlbmd0aDogcjEKICAgIH0KICB9Cn0KCi8vIEBjb3JlL21hbmlmZXN0LnNpZ25lcnMKY29uc3QgZW5jb2Rpbmc5XzQgPSBjLmFycmF5KGVuY29kaW5nNykKLy8gQGNvcmUvbWFuaWZlc3QubGlua2VkCmNvbnN0IGVuY29kaW5nOV82ID0gYy5hcnJheShjLmZpeGVkMzIpCgovLyBAY29yZS9tYW5pZmVzdApjb25zdCBlbmNvZGluZzkgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyA4IHNvIGFsd2F5cyBvbmUgYnl0ZQogICAgZW5jb2Rpbmc0LnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5xdW9ydW0pCiAgICBlbmNvZGluZzlfNC5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmVycykKCiAgICBpZiAobS5wcm9sb2d1ZSkgZW5jb2Rpbmc4LnByZWVuY29kZShzdGF0ZSwgbS5wcm9sb2d1ZSkKICAgIGlmIChtLmxpbmtlZCkgZW5jb2Rpbmc5XzYucHJlZW5jb2RlKHN0YXRlLCBtLmxpbmtlZCkKICAgIGlmIChtLnVzZXJEYXRhKSBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0udXNlckRhdGEpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0KICAgICAgKG0uYWxsb3dQYXRjaCA/IDEgOiAwKSB8CiAgICAgIChtLnByb2xvZ3VlID8gMiA6IDApIHwKICAgICAgKG0ubGlua2VkID8gNCA6IDApIHwKICAgICAgKG0udXNlckRhdGEgPyA4IDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICAgIGVuY29kaW5nNC5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucXVvcnVtKQogICAgZW5jb2Rpbmc5XzQuZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCgogICAgaWYgKG0ucHJvbG9ndWUpIGVuY29kaW5nOC5lbmNvZGUoc3RhdGUsIG0ucHJvbG9ndWUpCiAgICBpZiAobS5saW5rZWQpIGVuY29kaW5nOV82LmVuY29kZShzdGF0ZSwgbS5saW5rZWQpCiAgICBpZiAobS51c2VyRGF0YSkgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnVzZXJEYXRhKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogcjAsCiAgICAgIGhhc2g6IGVuY29kaW5nNC5kZWNvZGUoc3RhdGUpLAogICAgICBxdW9ydW06IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBhbGxvd1BhdGNoOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgc2lnbmVyczogZW5jb2Rpbmc5XzQuZGVjb2RlKHN0YXRlKSwKICAgICAgcHJvbG9ndWU6IChmbGFncyAmIDIpICE9PSAwID8gZW5jb2Rpbmc4LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBsaW5rZWQ6IChmbGFncyAmIDQpICE9PSAwID8gZW5jb2Rpbmc5XzYuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHVzZXJEYXRhOiAoZmxhZ3MgJiA4KSAhPT0gMCA/IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9CgovLyBAY29yZS9rZXlQYWlyCmNvbnN0IGVuY29kaW5nMTAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnNlY3JldEtleSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS5zZWNyZXRLZXkpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgcHVibGljS2V5OiByMCwKICAgICAgc2VjcmV0S2V5OiByMQogICAgfQogIH0KfQoKLy8gQGNvcmUvYXV0aC5tYW5pZmVzdApjb25zdCBlbmNvZGluZzExXzIgPSBjLmZyYW1lKGVuY29kaW5nOSkKCi8vIEBjb3JlL2F1dGgKY29uc3QgZW5jb2RpbmcxMSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5kaXNjb3ZlcnlLZXkpCiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyA0IHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLm1hbmlmZXN0KSBlbmNvZGluZzExXzIucHJlZW5jb2RlKHN0YXRlLCBtLm1hbmlmZXN0KQogICAgaWYgKG0ua2V5UGFpcikgZW5jb2RpbmcxMC5wcmVlbmNvZGUoc3RhdGUsIG0ua2V5UGFpcikKICAgIGlmIChtLmVuY3J5cHRpb25LZXkpIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS5lbmNyeXB0aW9uS2V5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9CiAgICAgIChtLm1hbmlmZXN0ID8gMSA6IDApIHwKICAgICAgKG0ua2V5UGFpciA/IDIgOiAwKSB8CiAgICAgIChtLmVuY3J5cHRpb25LZXkgPyA0IDogMCkKCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0uZGlzY292ZXJ5S2V5KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0ubWFuaWZlc3QpIGVuY29kaW5nMTFfMi5lbmNvZGUoc3RhdGUsIG0ubWFuaWZlc3QpCiAgICBpZiAobS5rZXlQYWlyKSBlbmNvZGluZzEwLmVuY29kZShzdGF0ZSwgbS5rZXlQYWlyKQogICAgaWYgKG0uZW5jcnlwdGlvbktleSkgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLmVuY3J5cHRpb25LZXkpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBrZXk6IHIwLAogICAgICBkaXNjb3ZlcnlLZXk6IHIxLAogICAgICBtYW5pZmVzdDogKGZsYWdzICYgMSkgIT09IDAgPyBlbmNvZGluZzExXzIuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGtleVBhaXI6IChmbGFncyAmIDIpICE9PSAwID8gZW5jb2RpbmcxMC5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgZW5jcnlwdGlvbktleTogKGZsYWdzICYgNCkgIT09IDAgPyBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKLy8gQGNvcmUvaGVhZApjb25zdCBlbmNvZGluZzEyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5mb3JrKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnJvb3RIYXNoKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5mb3JrKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnJvb3RIYXNoKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjIgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjMgPSBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgZm9yazogcjAsCiAgICAgIGxlbmd0aDogcjEsCiAgICAgIHJvb3RIYXNoOiByMiwKICAgICAgc2lnbmF0dXJlOiByMwogICAgfQogIH0KfQoKLy8gQGNvcmUvaGludHMKY29uc3QgZW5jb2RpbmcxMyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDIgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0uY29udGlndW91c0xlbmd0aCkgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5jb250aWd1b3VzTGVuZ3RoKQogICAgaWYgKG0ucmVtb3RlQ29udGlndW91c0xlbmd0aCkgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZW1vdGVDb250aWd1b3VzTGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9CiAgICAgIChtLmNvbnRpZ3VvdXNMZW5ndGggPyAxIDogMCkgfAogICAgICAobS5yZW1vdGVDb250aWd1b3VzTGVuZ3RoID8gMiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0uY29udGlndW91c0xlbmd0aCkgYy51aW50LmVuY29kZShzdGF0ZSwgbS5jb250aWd1b3VzTGVuZ3RoKQogICAgaWYgKG0ucmVtb3RlQ29udGlndW91c0xlbmd0aCkgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZW1vdGVDb250aWd1b3VzTGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgY29udGlndW91c0xlbmd0aDogKGZsYWdzICYgMSkgIT09IDAgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAsCiAgICAgIHJlbW90ZUNvbnRpZ3VvdXNMZW5ndGg6IChmbGFncyAmIDIpICE9PSAwID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCiAgICB9CiAgfQp9CgovLyBAY29yZS9zZXNzaW9uCmNvbnN0IGVuY29kaW5nMTQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIG0ubmFtZSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZGF0YVBvaW50ZXIpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgbS5uYW1lKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5kYXRhUG9pbnRlcikKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnN0cmluZy5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgbmFtZTogcjAsCiAgICAgIGRhdGFQb2ludGVyOiByMQogICAgfQogIH0KfQoKLy8gQGNvcmUvc2Vzc2lvbnMKY29uc3QgZW5jb2RpbmcxNSA9IGMuYXJyYXkoZW5jb2RpbmcxNCkKCi8vIEBjb3JlL2RlcGVuZGVuY3kKY29uc3QgZW5jb2RpbmcxNiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZGF0YVBvaW50ZXIpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5kYXRhUG9pbnRlcikKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgZGF0YVBvaW50ZXI6IHIwLAogICAgICBsZW5ndGg6IHIxCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBzZXRWZXJzaW9uKHYpIHsKICB2ZXJzaW9uID0gdgp9CgpmdW5jdGlvbiBlbmNvZGUobmFtZSwgdmFsdWUsIHYgPSBWRVJTSU9OKSB7CiAgdmVyc2lvbiA9IHYKICByZXR1cm4gYy5lbmNvZGUoZ2V0RW5jb2RpbmcobmFtZSksIHZhbHVlKQp9CgpmdW5jdGlvbiBkZWNvZGUobmFtZSwgYnVmZmVyLCB2ID0gVkVSU0lPTikgewogIHZlcnNpb24gPSB2CiAgcmV0dXJuIGMuZGVjb2RlKGdldEVuY29kaW5nKG5hbWUpLCBidWZmZXIpCn0KCmZ1bmN0aW9uIGdldEVudW0obmFtZSkgewogIHN3aXRjaCAobmFtZSkgewogICAgY2FzZSAnQGNvcmUvaGFzaGVzJzoKICAgICAgcmV0dXJuIGVuY29kaW5nNF9lbnVtCiAgICBjYXNlICdAY29yZS9zaWduYXR1cmVzJzoKICAgICAgcmV0dXJuIGVuY29kaW5nNV9lbnVtCiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VudW0gbm90IGZvdW5kICcgKyBuYW1lKQogIH0KfQoKZnVuY3Rpb24gZ2V0RW5jb2RpbmcobmFtZSkgewogIHN3aXRjaCAobmFtZSkgewogICAgY2FzZSAnQGNvcmVzdG9yZS9hbGxvY2F0ZWQnOgogICAgICByZXR1cm4gZW5jb2RpbmcwCiAgICBjYXNlICdAY29yZXN0b3JlL2hlYWQnOgogICAgICByZXR1cm4gZW5jb2RpbmcxCiAgICBjYXNlICdAY29yZXN0b3JlL2FsaWFzJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMgogICAgY2FzZSAnQGNvcmVzdG9yZS9jb3JlJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMwogICAgY2FzZSAnQGNvcmUvaGFzaGVzJzoKICAgICAgcmV0dXJuIGVuY29kaW5nNAogICAgY2FzZSAnQGNvcmUvc2lnbmF0dXJlcyc6CiAgICAgIHJldHVybiBlbmNvZGluZzUKICAgIGNhc2UgJ0Bjb3JlL3RyZWUtbm9kZSc6CiAgICAgIHJldHVybiBlbmNvZGluZzYKICAgIGNhc2UgJ0Bjb3JlL3NpZ25lcic6CiAgICAgIHJldHVybiBlbmNvZGluZzcKICAgIGNhc2UgJ0Bjb3JlL3Byb2xvZ3VlJzoKICAgICAgcmV0dXJuIGVuY29kaW5nOAogICAgY2FzZSAnQGNvcmUvbWFuaWZlc3QnOgogICAgICByZXR1cm4gZW5jb2Rpbmc5CiAgICBjYXNlICdAY29yZS9rZXlQYWlyJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTAKICAgIGNhc2UgJ0Bjb3JlL2F1dGgnOgogICAgICByZXR1cm4gZW5jb2RpbmcxMQogICAgY2FzZSAnQGNvcmUvaGVhZCc6CiAgICAgIHJldHVybiBlbmNvZGluZzEyCiAgICBjYXNlICdAY29yZS9oaW50cyc6CiAgICAgIHJldHVybiBlbmNvZGluZzEzCiAgICBjYXNlICdAY29yZS9zZXNzaW9uJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTQKICAgIGNhc2UgJ0Bjb3JlL3Nlc3Npb25zJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTUKICAgIGNhc2UgJ0Bjb3JlL2RlcGVuZGVuY3knOgogICAgICByZXR1cm4gZW5jb2RpbmcxNgogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbmNvZGVyIG5vdCBmb3VuZCAnICsgbmFtZSkKICB9Cn0KCmZ1bmN0aW9uIGdldFN0cnVjdChuYW1lLCB2ID0gVkVSU0lPTikgewogIGNvbnN0IGVuYyA9IGdldEVuY29kaW5nKG5hbWUpCiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgICB2ZXJzaW9uID0gdgogICAgICBlbmMucHJlZW5jb2RlKHN0YXRlLCBtKQogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgbSkgewogICAgICB2ZXJzaW9uID0gdgogICAgICBlbmMuZW5jb2RlKHN0YXRlLCBtKQogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICB2ZXJzaW9uID0gdgogICAgICByZXR1cm4gZW5jLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlc29sdmVTdHJ1Y3QgPSBnZXRTdHJ1Y3QgLy8gY29tcGF0Cgptb2R1bGUuZXhwb3J0cyA9IHsKICByZXNvbHZlU3RydWN0LAogIGdldFN0cnVjdCwKICBnZXRFbnVtLAogIGdldEVuY29kaW5nLAogIGVuY29kZSwKICBkZWNvZGUsCiAgc2V0VmVyc2lvbiwKICB2ZXJzaW9uCn0KY29uc3QgeyBFdmVudEVtaXR0ZXIgfSA9IHJlcXVpcmUoJ2V2ZW50cycpCmNvbnN0IGlzT3B0aW9ucyA9IHJlcXVpcmUoJ2lzLW9wdGlvbnMnKQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgQ29yZVN0b3JhZ2UgPSByZXF1aXJlKCdoeXBlcmNvcmUtc3RvcmFnZScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgTm9pc2VTZWNyZXRTdHJlYW0gPSByZXF1aXJlKCdAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtJykKY29uc3QgUHJvdG9tdXggPSByZXF1aXJlKCdwcm90b211eCcpCmNvbnN0IGlkID0gcmVxdWlyZSgnaHlwZXJjb3JlLWlkLWVuY29kaW5nJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCB1bnNsYWIgPSByZXF1aXJlKCd1bnNsYWInKQoKY29uc3QgaW5zcGVjdCA9IHJlcXVpcmUoJy4vbGliL2luc3BlY3QnKQpjb25zdCBDb3JlID0gcmVxdWlyZSgnLi9saWIvY29yZScpCmNvbnN0IEluZm8gPSByZXF1aXJlKCcuL2xpYi9pbmZvJykKY29uc3QgRG93bmxvYWQgPSByZXF1aXJlKCcuL2xpYi9kb3dubG9hZCcpCmNvbnN0IERlZmF1bHRFbmNyeXB0aW9uID0gcmVxdWlyZSgnLi9saWIvZGVmYXVsdC1lbmNyeXB0aW9uJykKY29uc3QgY2FwcyA9IHJlcXVpcmUoJy4vbGliL2NhcHMnKQpjb25zdCBSZXBsaWNhdG9yID0gcmVxdWlyZSgnLi9saWIvcmVwbGljYXRvcicpCmNvbnN0IHsgbWFuaWZlc3RIYXNoLCBjcmVhdGVNYW5pZmVzdCB9ID0gcmVxdWlyZSgnLi9saWIvdmVyaWZpZXInKQpjb25zdCB7IFJlYWRTdHJlYW0sIFdyaXRlU3RyZWFtLCBCeXRlU3RyZWFtIH0gPSByZXF1aXJlKCcuL2xpYi9zdHJlYW1zJykKY29uc3QgeyBNZXJrbGVUcmVlIH0gPSByZXF1aXJlKCcuL2xpYi9tZXJrbGUtdHJlZScpCmNvbnN0IHsKICBBU1NFUlRJT04sCiAgQkFEX0FSR1VNRU5ULAogIFNFU1NJT05fQ0xPU0VELAogIFNFU1NJT05fTU9WRUQsCiAgU0VTU0lPTl9OT1RfV1JJVEFCTEUsCiAgU05BUFNIT1RfTk9UX0FWQUlMQUJMRSwKICBERUNPRElOR19FUlJPUgp9ID0gcmVxdWlyZSgnaHlwZXJjb3JlLWVycm9ycycpCgovLyBIeXBlcmNvcmUgYWN0dWFsbHkgZG9lcyBub3QgaGF2ZSBhbnkgbm90aW9uIG9mIG1heC9taW4gYmxvY2sgc2l6ZXMKLy8gYnV0IHdlIGVuZm9yY2UgMTVtYiB0byBlbnN1cmUgc21vb3RoIHJlcGxpY2F0aW9uIChlYWNoIGJsb2NrIGlzIHRyYW5zbWl0dGVkIGF0b21pY2FsbHkpCmNvbnN0IE1BWF9TVUdHRVNURURfQkxPQ0tfU0laRSA9IDE1ICogMTAyNCAqIDEwMjQKCmNsYXNzIEh5cGVyY29yZSBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3Ioc3RvcmFnZSwga2V5LCBvcHRzKSB7CiAgICBzdXBlcigpCgogICAgaWYgKGlzT3B0aW9ucyhzdG9yYWdlKSAmJiAhc3RvcmFnZS5kYikgewogICAgICBvcHRzID0gc3RvcmFnZQogICAgICBzdG9yYWdlID0gbnVsbAogICAgICBrZXkgPSBvcHRzLmtleSB8fCBudWxsCiAgICB9IGVsc2UgaWYgKGlzT3B0aW9ucyhrZXkpKSB7CiAgICAgIG9wdHMgPSBrZXkKICAgICAga2V5ID0gb3B0cy5rZXkgfHwgbnVsbAogICAgfQoKICAgIGlmIChrZXkgJiYgdHlwZW9mIGtleSA9PT0gJ3N0cmluZycpIGtleSA9IGlkLmRlY29kZShrZXkpCiAgICBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICAgIGlmICghc3RvcmFnZSkgc3RvcmFnZSA9IG9wdHMuc3RvcmFnZQoKICAgIHRoaXMuY29yZSA9IG51bGwKICAgIHRoaXMuc3RhdGUgPSBudWxsCiAgICB0aGlzLmVuY3J5cHRpb24gPSBudWxsCiAgICB0aGlzLmV4dGVuc2lvbnMgPSBuZXcgTWFwKCkKCiAgICB0aGlzLnZhbHVlRW5jb2RpbmcgPSBudWxsCiAgICB0aGlzLmVuY29kZUJhdGNoID0gbnVsbAogICAgdGhpcy5hY3RpdmVSZXF1ZXN0cyA9IFtdCiAgICB0aGlzLnNlc3Npb25zID0gbnVsbAogICAgdGhpcy5vbmdjID0gbnVsbAoKICAgIHRoaXMua2V5UGFpciA9IG9wdHMua2V5UGFpciB8fCBudWxsCiAgICB0aGlzLnJlYWRhYmxlID0gdHJ1ZQogICAgdGhpcy53cml0YWJsZSA9IGZhbHNlCiAgICB0aGlzLmV4Y2x1c2l2ZSA9IGZhbHNlCiAgICB0aGlzLm9wZW5lZCA9IGZhbHNlCiAgICB0aGlzLmNsb3NlZCA9IGZhbHNlCiAgICB0aGlzLndlYWsgPSAhIW9wdHMud2VhawogICAgdGhpcy5zbmFwc2hvdHRlZCA9ICEhb3B0cy5zbmFwc2hvdAogICAgdGhpcy5vbnNlcSA9IG9wdHMub25zZXEgfHwgbnVsbAogICAgdGhpcy5vbndhaXQgPSBvcHRzLm9ud2FpdCB8fCBudWxsCiAgICB0aGlzLndhaXQgPSBvcHRzLndhaXQgIT09IGZhbHNlCiAgICB0aGlzLnRpbWVvdXQgPSBvcHRzLnRpbWVvdXQgfHwgMAogICAgdGhpcy5wcmVsb2FkID0gbnVsbAogICAgdGhpcy5jbG9zaW5nID0gbnVsbAogICAgdGhpcy5vcGVuaW5nID0gbnVsbAoKICAgIHRoaXMuX3JlYWRvbmx5ID0gb3B0cy53cml0YWJsZSA9PT0gZmFsc2UKICAgIHRoaXMuX3ByZWFwcGVuZCA9IHByZWFwcGVuZC5iaW5kKHRoaXMpCiAgICB0aGlzLl9zbmFwc2hvdCA9IG51bGwKICAgIHRoaXMuX2ZpbmRpbmdQZWVycyA9IDAKICAgIHRoaXMuX2FjdGl2ZSA9IG9wdHMud2VhayA/ICEhb3B0cy5hY3RpdmUgOiBvcHRzLmFjdGl2ZSAhPT0gZmFsc2UKCiAgICB0aGlzLl9zZXNzaW9uSW5kZXggPSAtMQogICAgdGhpcy5fc3RhdGVJbmRleCA9IC0xIC8vIG1haW50YWluZWQgYnkgc2Vzc2lvbiBzdGF0ZQogICAgdGhpcy5fbW9uaXRvckluZGV4ID0gLTEgLy8gbWFpbnRhaW5lZCBieSByZXBsaWNhdGlvbiBzdGF0ZQoKICAgIHRoaXMub3BlbmluZyA9IHRoaXMuX29wZW4oc3RvcmFnZSwga2V5LCBvcHRzKQogICAgdGhpcy5vcGVuaW5nLmNhdGNoKHNhZmV0eUNhdGNoKQoKICAgIHRoaXMub24oJ25ld0xpc3RlbmVyJywgbWF5YmVBZGRNb25pdG9yKQogIH0KCiAgW1N5bWJvbC5mb3IoJ25vZGVqcy51dGlsLmluc3BlY3QuY3VzdG9tJyldKGRlcHRoLCBvcHRzKSB7CiAgICByZXR1cm4gaW5zcGVjdCh0aGlzLCBkZXB0aCwgb3B0cykKICB9CgogIHN0YXRpYyBNQVhfU1VHR0VTVEVEX0JMT0NLX1NJWkUgPSBNQVhfU1VHR0VTVEVEX0JMT0NLX1NJWkUKCiAgc3RhdGljIERlZmF1bHRFbmNyeXB0aW9uID0gRGVmYXVsdEVuY3J5cHRpb24KCiAgc3RhdGljIGtleShtYW5pZmVzdCwgeyBjb21wYXQsIHZlcnNpb24sIG5hbWVzcGFjZSB9ID0ge30pIHsKICAgIGlmIChiNGEuaXNCdWZmZXIobWFuaWZlc3QpKSB7CiAgICAgIG1hbmlmZXN0ID0geyB2ZXJzaW9uLCBzaWduZXJzOiBbeyBwdWJsaWNLZXk6IG1hbmlmZXN0LCBuYW1lc3BhY2UgfV0gfQogICAgfQogICAgcmV0dXJuIGNvbXBhdCA/IG1hbmlmZXN0LnNpZ25lcnNbMF0ucHVibGljS2V5IDogbWFuaWZlc3RIYXNoKGNyZWF0ZU1hbmlmZXN0KG1hbmlmZXN0KSkKICB9CgogIHN0YXRpYyBkaXNjb3ZlcnlLZXkoa2V5KSB7CiAgICByZXR1cm4gY3J5cHRvLmRpc2NvdmVyeUtleShrZXkpCiAgfQoKICBzdGF0aWMgYmxvY2tFbmNyeXB0aW9uS2V5KGtleSwgZW5jcnlwdGlvbktleSkgewogICAgcmV0dXJuIERlZmF1bHRFbmNyeXB0aW9uLmJsb2NrRW5jcnlwdGlvbktleShrZXksIGVuY3J5cHRpb25LZXkpCiAgfQoKICBzdGF0aWMgZ2V0UHJvdG9jb2xNdXhlcihzdHJlYW0pIHsKICAgIHJldHVybiBzdHJlYW0ubm9pc2VTdHJlYW0udXNlckRhdGEKICB9CgogIHN0YXRpYyBjcmVhdGVDb3JlKHN0b3JhZ2UsIG9wdHMpIHsKICAgIHJldHVybiBuZXcgQ29yZShIeXBlcmNvcmUuZGVmYXVsdFN0b3JhZ2Uoc3RvcmFnZSksIHsgYXV0b0Nsb3NlOiBmYWxzZSwgLi4ub3B0cyB9KQogIH0KCiAgc3RhdGljIGNyZWF0ZVByb3RvY29sU3RyZWFtKGlzSW5pdGlhdG9yLCBvcHRzID0ge30pIHsKICAgIGxldCBvdXRlclN0cmVhbSA9IFByb3RvbXV4LmlzUHJvdG9tdXgoaXNJbml0aWF0b3IpCiAgICAgID8gaXNJbml0aWF0b3Iuc3RyZWFtCiAgICAgIDogaXNTdHJlYW0oaXNJbml0aWF0b3IpCiAgICAgICAgPyBpc0luaXRpYXRvcgogICAgICAgIDogb3B0cy5zdHJlYW0KCiAgICBsZXQgbm9pc2VTdHJlYW0gPSBudWxsCgogICAgaWYgKG91dGVyU3RyZWFtKSB7CiAgICAgIG5vaXNlU3RyZWFtID0gb3V0ZXJTdHJlYW0ubm9pc2VTdHJlYW0KICAgIH0gZWxzZSB7CiAgICAgIG5vaXNlU3RyZWFtID0gbmV3IE5vaXNlU2VjcmV0U3RyZWFtKGlzSW5pdGlhdG9yLCBudWxsLCBvcHRzKQogICAgICBvdXRlclN0cmVhbSA9IG5vaXNlU3RyZWFtLnJhd1N0cmVhbQogICAgfQogICAgaWYgKCFub2lzZVN0cmVhbSkgdGhyb3cgQkFEX0FSR1VNRU5UKCdJbnZhbGlkIHN0cmVhbScsIHRoaXMuZGlzY292ZXJ5S2V5KQoKICAgIGlmICghbm9pc2VTdHJlYW0udXNlckRhdGEpIHsKICAgICAgY29uc3QgcHJvdG9jb2wgPSBQcm90b211eC5mcm9tKG5vaXNlU3RyZWFtKQoKICAgICAgaWYgKG9wdHMua2VlcEFsaXZlICE9PSBmYWxzZSAmJiBub2lzZVN0cmVhbS5rZWVwQWxpdmUgPT09IDApIHsKICAgICAgICBub2lzZVN0cmVhbS5zZXRLZWVwQWxpdmUoNTAwMCkKICAgICAgfQogICAgICBub2lzZVN0cmVhbS51c2VyRGF0YSA9IHByb3RvY29sCiAgICB9CgogICAgaWYgKG9wdHMub25kaXNjb3ZlcnlrZXkpIHsKICAgICAgbm9pc2VTdHJlYW0udXNlckRhdGEucGFpcih7IHByb3RvY29sOiAnaHlwZXJjb3JlL2FscGhhJyB9LCBvcHRzLm9uZGlzY292ZXJ5a2V5KQogICAgfQoKICAgIHJldHVybiBvdXRlclN0cmVhbQogIH0KCiAgc3RhdGljIGRlZmF1bHRTdG9yYWdlKHN0b3JhZ2UsIG9wdHMgPSB7fSkgewogICAgaWYgKENvcmVTdG9yYWdlLmlzQ29yZVN0b3JhZ2Uoc3RvcmFnZSkpIHJldHVybiBzdG9yYWdlCgogICAgY29uc3QgZGlyZWN0b3J5ID0gc3RvcmFnZQogICAgcmV0dXJuIG5ldyBDb3JlU3RvcmFnZShkaXJlY3RvcnksIG9wdHMpCiAgfQoKICBzdGF0aWMgY2xlYXJSZXF1ZXN0cyhzZXNzaW9uLCBlcnIpIHsKICAgIHJldHVybiBSZXBsaWNhdG9yLmNsZWFyUmVxdWVzdHMoc2Vzc2lvbiwgZXJyKQogIH0KCiAgc25hcHNob3Qob3B0cykgewogICAgcmV0dXJuIHRoaXMuc2Vzc2lvbih7IC4uLm9wdHMsIHNuYXBzaG90OiB0cnVlIH0pCiAgfQoKICBjb21wYWN0KCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5jb21wYWN0KCkKICB9CgogIHNlc3Npb24ob3B0cyA9IHt9KSB7CiAgICBpZiAodGhpcy5jbG9zaW5nKSB7CiAgICAgIC8vIFRoaXMgbWFrZXMgdGhlIGNsb3NpbmcgbG9naWMgYSBsb3QgZWFzaWVyLiBJZiB0aGlzIHR1cm5zIG91dCB0byBiZSBhIHByb2JsZW0KICAgICAgLy8gaW4gcHJhY3RpY2UsIG9wZW4gYW4gaXNzdWUgYW5kIHdlJ2xsIHRyeSB0byBtYWtlIGEgc29sdXRpb24gZm9yIGl0LgogICAgICB0aHJvdyBTRVNTSU9OX0NMT1NFRCgnQ2Fubm90IG1ha2Ugc2Vzc2lvbnMgb24gYSBjbG9zaW5nIGNvcmUnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KICAgIGlmIChvcHRzLmNoZWNrb3V0ICE9PSB1bmRlZmluZWQgJiYgIW9wdHMubmFtZSAmJiAhb3B0cy5hdG9tKSB7CiAgICAgIHRocm93IEFTU0VSVElPTignQ2hlY2tvdXRzIGFyZSBvbmx5IHN1cHBvcnRlZCBvbiBhdG9tcyBvciBuYW1lZCBzZXNzaW9ucycsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIGNvbnN0IHdhaXQgPSBvcHRzLndhaXQgPT09IGZhbHNlID8gZmFsc2UgOiB0aGlzLndhaXQKICAgIGNvbnN0IHdyaXRhYmxlID0gb3B0cy53cml0YWJsZSA9PT0gdW5kZWZpbmVkID8gIXRoaXMuX3JlYWRvbmx5IDogb3B0cy53cml0YWJsZSA9PT0gdHJ1ZQogICAgY29uc3Qgb253YWl0ID0gb3B0cy5vbndhaXQgPT09IHVuZGVmaW5lZCA/IHRoaXMub253YWl0IDogb3B0cy5vbndhaXQKICAgIGNvbnN0IG9uc2VxID0gb3B0cy5vbnNlcSA9PT0gdW5kZWZpbmVkID8gdGhpcy5vbnNlcSA6IG9wdHMub25zZXEKICAgIGNvbnN0IHRpbWVvdXQgPSBvcHRzLnRpbWVvdXQgPT09IHVuZGVmaW5lZCA/IHRoaXMudGltZW91dCA6IG9wdHMudGltZW91dAogICAgY29uc3Qgd2VhayA9IG9wdHMud2VhayA9PT0gdW5kZWZpbmVkID8gdGhpcy53ZWFrIDogb3B0cy53ZWFrCiAgICBjb25zdCBDbHogPSBvcHRzLmNsYXNzIHx8IEh5cGVyY29yZQogICAgY29uc3QgcyA9IG5ldyBDbHoobnVsbCwgdGhpcy5rZXksIHsKICAgICAgLi4ub3B0cywKICAgICAgd2FpdCwKICAgICAgb253YWl0LAogICAgICBvbnNlcSwKICAgICAgdGltZW91dCwKICAgICAgd3JpdGFibGUsCiAgICAgIHdlYWssCiAgICAgIHBhcmVudDogdGhpcwogICAgfSkKCiAgICByZXR1cm4gcwogIH0KCiAgYXN5bmMgc2V0RW5jcnlwdGlvbktleShrZXksIG9wdHMpIHsKICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMub3BlbmluZwogICAgY29uc3QgZW5jcnlwdGlvbiA9IHRoaXMuX2dldEVuY3J5cHRpb25Qcm92aWRlcih7IGtleSwgYmxvY2s6ICEhKG9wdHMgJiYgb3B0cy5ibG9jaykgfSkKICAgIHJldHVybiB0aGlzLnNldEVuY3J5cHRpb24oZW5jcnlwdGlvbikKICB9CgogIGFzeW5jIHNldEVuY3J5cHRpb24oZW5jcnlwdGlvbikgewogICAgaWYgKCF0aGlzLm9wZW5lZCkgYXdhaXQgdGhpcy5vcGVuaW5nCgogICAgaWYgKGVuY3J5cHRpb24gPT09IG51bGwpIHsKICAgICAgdGhpcy5lbmNyeXB0aW9uID0gZW5jcnlwdGlvbgogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoIWlzRW5jcnlwdGlvblByb3ZpZGVyKGVuY3J5cHRpb24pKSB7CiAgICAgIHRocm93IEFTU0VSVElPTignUHJvdmlkZXIgZG9lcyBub3Qgc2F0aXNmeSBIeXBlcmNvcmVFbmNyeXB0aW9uIGludGVyZmFjZScsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIHRoaXMuZW5jcnlwdGlvbiA9IGVuY3J5cHRpb24KICB9CgogIHNldEtleVBhaXIoa2V5UGFpcikgewogICAgdGhpcy5rZXlQYWlyID0ga2V5UGFpcgogIH0KCiAgc2V0QWN0aXZlKGJvb2wpIHsKICAgIGNvbnN0IGFjdGl2ZSA9ICEhYm9vbAogICAgaWYgKGFjdGl2ZSA9PT0gdGhpcy5fYWN0aXZlIHx8IHRoaXMuY2xvc2luZykgcmV0dXJuCiAgICB0aGlzLl9hY3RpdmUgPSBhY3RpdmUKICAgIGlmICghdGhpcy5vcGVuZWQpIHJldHVybgogICAgdGhpcy5jb3JlLnJlcGxpY2F0b3IudXBkYXRlQWN0aXZpdHkodGhpcy5fYWN0aXZlID8gMSA6IC0xKQogIH0KCiAgYXN5bmMgX29wZW4oc3RvcmFnZSwga2V5LCBvcHRzKSB7CiAgICBjb25zdCBwcmVsb2FkID0gb3B0cy5wcmVsb2FkIHx8IChvcHRzLnBhcmVudCAmJiBvcHRzLnBhcmVudC5wcmVsb2FkKQoKICAgIGlmIChwcmVsb2FkKSB7CiAgICAgIHRoaXMuc2Vzc2lvbnMgPSBbXSAvLyBpbiBjYXNlIHNvbWVvbmUgbG9va3MgYXQgaXQgbGlrZSB3aXRoIHBlZXJzCiAgICAgIHRoaXMucHJlbG9hZCA9IHByZWxvYWQKICAgICAgb3B0cyA9IHsgLi4ub3B0cywgLi4uKGF3YWl0IHRoaXMucHJlbG9hZCkgfQogICAgICB0aGlzLnByZWxvYWQgPSBudWxsCiAgICB9CgogICAgY29uc3QgcGFyZW50ID0gb3B0cy5wYXJlbnQgfHwgbnVsbAogICAgY29uc3QgY29yZSA9IG9wdHMuY29yZSB8fCAocGFyZW50ICYmIHBhcmVudC5jb3JlKQogICAgY29uc3Qgc2Vzc2lvbnMgPSBvcHRzLnNlc3Npb25zIHx8IChwYXJlbnQgJiYgcGFyZW50LnNlc3Npb25zKQogICAgY29uc3Qgb25nYyA9IG9wdHMub25nYyB8fCAocGFyZW50ICYmIHBhcmVudC5vbmdjKQoKICAgIGlmIChjb3JlKSB0aGlzLmNvcmUgPSBjb3JlCiAgICBpZiAob25nYykgdGhpcy5vbmdjID0gb25nYwogICAgaWYgKHNlc3Npb25zKSB0aGlzLnNlc3Npb25zID0gc2Vzc2lvbnMKCiAgICBpZiAodGhpcy5zZXNzaW9ucyA9PT0gbnVsbCkgdGhpcy5zZXNzaW9ucyA9IFtdCiAgICB0aGlzLl9zZXNzaW9uSW5kZXggPSB0aGlzLnNlc3Npb25zLnB1c2godGhpcykgLSAxCgogICAgaWYgKHRoaXMuY29yZSA9PT0gbnVsbCkgaW5pdE9uY2UodGhpcywgc3RvcmFnZSwga2V5LCBvcHRzKQogICAgaWYgKHRoaXMuX21vbml0b3JJbmRleCA9PT0gLTIpIHRoaXMuY29yZS5hZGRNb25pdG9yKHRoaXMpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fb3BlblNlc3Npb24ob3B0cykKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAodGhpcy5jb3JlLmF1dG9DbG9zZSAmJiB0aGlzLmNvcmUuaGFzU2Vzc2lvbigpID09PSBmYWxzZSkgYXdhaXQgdGhpcy5jb3JlLmNsb3NlKCkKCiAgICAgIGlmICh0aGlzLmV4Y2x1c2l2ZSkgdGhpcy5jb3JlLnVubG9ja0V4Y2x1c2l2ZSgpCgogICAgICB0aGlzLmNvcmUucmVtb3ZlTW9uaXRvcih0aGlzKQogICAgICB0aGlzLl9yZW1vdmVTZXNzaW9uKCkKCiAgICAgIGlmICh0aGlzLnN0YXRlICE9PSBudWxsKSB0aGlzLnN0YXRlLnJlbW92ZVNlc3Npb24odGhpcykKCiAgICAgIHRoaXMuY2xvc2VkID0gdHJ1ZQogICAgICB0aGlzLmVtaXQoJ2Nsb3NlJykKICAgICAgdGhyb3cgZXJyCiAgICB9CgogICAgdGhpcy5lbWl0KCdyZWFkeScpCgogICAgLy8gaWYgd2UgYXJlIGEgd2VhayBzZXNzaW9uIHRoZSBjb3JlIG1pZ2h0IGhhdmUgY2xvc2VkLi4uCiAgICBpZiAodGhpcy5jb3JlLmNsb3NpbmcpIHRoaXMuY2xvc2UoKS5jYXRjaChzYWZldHlDYXRjaCkKICB9CgogIF9yZW1vdmVTZXNzaW9uKCkgewogICAgaWYgKHRoaXMuX3Nlc3Npb25JbmRleCA9PT0gLTEpIHJldHVybgogICAgY29uc3QgaGVhZCA9IHRoaXMuc2Vzc2lvbnMucG9wKCkKICAgIGlmIChoZWFkICE9PSB0aGlzKSB0aGlzLnNlc3Npb25zWyhoZWFkLl9zZXNzaW9uSW5kZXggPSB0aGlzLl9zZXNzaW9uSW5kZXgpXSA9IGhlYWQKICAgIHRoaXMuX3Nlc3Npb25JbmRleCA9IC0xCiAgICBpZiAodGhpcy5vbmdjICE9PSBudWxsKSB0aGlzLm9uZ2ModGhpcykKICB9CgogIGFzeW5jIF9vcGVuU2Vzc2lvbihvcHRzKSB7CiAgICBpZiAodGhpcy5jb3JlLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCgogICAgaWYgKHRoaXMua2V5UGFpciA9PT0gbnVsbCkgdGhpcy5rZXlQYWlyID0gb3B0cy5rZXlQYWlyIHx8IHRoaXMuY29yZS5oZWFkZXIua2V5UGFpcgoKICAgIGNvbnN0IHBhcmVudCA9IG9wdHMucGFyZW50IHx8IG51bGwKICAgIGlmIChwYXJlbnQgJiYgcGFyZW50LmVuY3J5cHRpb24pIHRoaXMuZW5jcnlwdGlvbiA9IHBhcmVudC5lbmNyeXB0aW9uCgogICAgY29uc3QgZSA9IGdldEVuY3J5cHRpb25PcHRpb24ob3B0cykKICAgIGlmICghdGhpcy5lbmNyeXB0aW9uKSB0aGlzLmVuY3J5cHRpb24gPSB0aGlzLl9nZXRFbmNyeXB0aW9uUHJvdmlkZXIoZSkKCiAgICB0aGlzLndyaXRhYmxlID0gdGhpcy5faXNXcml0YWJsZSgpCgogICAgaWYgKG9wdHMudmFsdWVFbmNvZGluZykgewogICAgICB0aGlzLnZhbHVlRW5jb2RpbmcgPSBjLmZyb20ob3B0cy52YWx1ZUVuY29kaW5nKQogICAgfQogICAgaWYgKG9wdHMuZW5jb2RlQmF0Y2gpIHsKICAgICAgdGhpcy5lbmNvZGVCYXRjaCA9IG9wdHMuZW5jb2RlQmF0Y2gKICAgIH0KCiAgICBpZiAocGFyZW50KSB7CiAgICAgIGlmIChwYXJlbnQuX3N0YXRlSW5kZXggPT09IC0xKSBhd2FpdCBwYXJlbnQucmVhZHkoKQogICAgICBpZiAoIXRoaXMua2V5UGFpcikgdGhpcy5rZXlQYWlyID0gcGFyZW50LmtleVBhaXIKCiAgICAgIGNvbnN0IHBzID0gcGFyZW50LnN0YXRlCgogICAgICBpZiAocHMpIHsKICAgICAgICBjb25zdCBzaG91bGRTbmFwc2hvdCA9IHRoaXMuc25hcHNob3R0ZWQgJiYgIXBzLmlzU25hcHNob3QoKQogICAgICAgIHRoaXMuc3RhdGUgPSBzaG91bGRTbmFwc2hvdCA/IGF3YWl0IHBzLnNuYXBzaG90KCkgOiBwcy5yZWYoKQogICAgICB9CgogICAgICBpZiAodGhpcy5zbmFwc2hvdHRlZCAmJiB0aGlzLmNvcmUgJiYgIXRoaXMuX3NuYXBzaG90KSB7CiAgICAgICAgdGhpcy5fdXBkYXRlU25hcHNob3QoKQogICAgICB9CiAgICB9CgogICAgaWYgKG9wdHMuZXhjbHVzaXZlICYmIG9wdHMud3JpdGFibGUgIT09IGZhbHNlKSB7CiAgICAgIHRoaXMuZXhjbHVzaXZlID0gdHJ1ZQogICAgICBhd2FpdCB0aGlzLmNvcmUubG9ja0V4Y2x1c2l2ZSgpCiAgICB9CgogICAgY29uc3QgcGFyZW50U3RhdGUgPSBwYXJlbnQgPyBwYXJlbnQuc3RhdGUgOiB0aGlzLmNvcmUuc3RhdGUKICAgIGNvbnN0IGNoZWNrb3V0ID0gb3B0cy5jaGVja291dCA9PT0gdW5kZWZpbmVkID8gLTEgOiBvcHRzLmNoZWNrb3V0CiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuc3RhdGUKCiAgICBpZiAob3B0cy5hdG9tKSB7CiAgICAgIHRoaXMuc3RhdGUgPSBhd2FpdCBwYXJlbnRTdGF0ZS5jcmVhdGVTZXNzaW9uKG51bGwsIGZhbHNlLCBvcHRzLmF0b20pCiAgICAgIGlmIChzdGF0ZSkgc3RhdGUudW5yZWYoKQogICAgfSBlbHNlIGlmIChvcHRzLm5hbWUpIHsKICAgICAgLy8gdG9kbzogbmVlZCB0byBtYWtlIG5hbWVkIHNlc3Npb25zIHNhZmUgYmVmb3JlIHJlYWR5CiAgICAgIC8vIGF0bSB3ZSBhbHdheXMgY29weSB0aGUgc3RhdGUgaW4gcGFzc0NhcGFiaWxpdGllcwogICAgICB0aGlzLnN0YXRlID0gYXdhaXQgcGFyZW50U3RhdGUuY3JlYXRlU2Vzc2lvbihvcHRzLm5hbWUsICEhb3B0cy5vdmVyd3JpdGUsIG51bGwpCiAgICAgIGlmIChzdGF0ZSkgc3RhdGUudW5yZWYoKSAvLyByZWYnZWQgYWJvdmUgaW4gc2V0dXAgc2Vzc2lvbgogICAgfQoKICAgIGlmICh0aGlzLnN0YXRlICYmIGNoZWNrb3V0ICE9PSAtMSkgewogICAgICBpZiAoIW9wdHMubmFtZSAmJiAhb3B0cy5hdG9tKSB7CiAgICAgICAgdGhyb3cgQVNTRVJUSU9OKCdDaGVja291dHMgbXVzdCBiZSBuYW1lZCBvciBhdG9taXplZCcsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgICB9CiAgICAgIGlmIChjaGVja291dCA+IHRoaXMuc3RhdGUubGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgQVNTRVJUSU9OKAogICAgICAgICAgYEludmFsaWQgY2hlY2tvdXQgJHtjaGVja291dH0gZm9yICR7b3B0cy5uYW1lfSwgbGVuZ3RoIGlzICR7dGhpcy5zdGF0ZS5sZW5ndGh9YCwKICAgICAgICAgIHRoaXMuZGlzY292ZXJ5S2V5CiAgICAgICAgKQogICAgICB9CiAgICAgIGlmICh0aGlzLnN0YXRlLnByb2xvZ3VlICYmIGNoZWNrb3V0IDwgdGhpcy5zdGF0ZS5wcm9sb2d1ZS5sZW5ndGgpIHsKICAgICAgICB0aHJvdyBBU1NFUlRJT04oCiAgICAgICAgICBgSW52YWxpZCBjaGVja291dCAke2NoZWNrb3V0fSBmb3IgJHtvcHRzLm5hbWV9LCBwcm9sb2d1ZSBsZW5ndGggaXMgJHt0aGlzLnN0YXRlLnByb2xvZ3VlLmxlbmd0aH1gLAogICAgICAgICAgdGhpcy5kaXNjb3ZlcnlLZXkKICAgICAgICApCiAgICAgIH0KICAgICAgaWYgKGNoZWNrb3V0IDwgdGhpcy5zdGF0ZS5sZW5ndGgpIGF3YWl0IHRoaXMuc3RhdGUudHJ1bmNhdGUoY2hlY2tvdXQsIHRoaXMuZm9yaykKICAgIH0KCiAgICBpZiAodGhpcy5zdGF0ZSA9PT0gbnVsbCkgewogICAgICB0aGlzLnN0YXRlID0gdGhpcy5jb3JlLnN0YXRlLnJlZigpCiAgICB9CgogICAgdGhpcy53cml0YWJsZSA9IHRoaXMuX2lzV3JpdGFibGUoKQoKICAgIGlmICh0aGlzLnNuYXBzaG90dGVkICYmIHRoaXMuY29yZSkgdGhpcy5fdXBkYXRlU25hcHNob3QoKQoKICAgIHRoaXMuc3RhdGUuYWRkU2Vzc2lvbih0aGlzKQogICAgLy8gVE9ETzogd2UgbmVlZCB0byByZXdvcmsgdGhlIGNvcmUgcmVmZXJlbmNlIGZsb3csIGFzIHRoZSBzdGF0ZSBhbmQgc2Vzc2lvbiBkbyBub3QgYWx3YXlzIGFncmVlIG5vdyBkdWUgdG8gbW92ZVRvCiAgICB0aGlzLmNvcmUgPSB0aGlzLnN0YXRlLmNvcmUgLy8gaW4gY2FzZSBpdCB3YXMgd3JvbmcuLi4KCiAgICBpZiAob3B0cy51c2VyRGF0YSkgewogICAgICBjb25zdCB0eCA9IHRoaXMuc3RhdGUuc3RvcmFnZS53cml0ZSgpCiAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG9wdHMudXNlckRhdGEpKSB7CiAgICAgICAgdHgucHV0VXNlckRhdGEoa2V5LCB2YWx1ZSkKICAgICAgfQogICAgICBhd2FpdCB0eC5mbHVzaCgpCiAgICB9CgogICAgaWYgKG9wdHMubWFuaWZlc3QgJiYgIXRoaXMuY29yZS5oZWFkZXIubWFuaWZlc3QpIHsKICAgICAgYXdhaXQgdGhpcy5jb3JlLnNldE1hbmlmZXN0KGNyZWF0ZU1hbmlmZXN0KG9wdHMubWFuaWZlc3QpKQogICAgfQoKICAgIHRoaXMuY29yZS5yZXBsaWNhdG9yLnVwZGF0ZUFjdGl2aXR5KHRoaXMuX2FjdGl2ZSA/IDEgOiAwKQoKICAgIHRoaXMub3BlbmVkID0gdHJ1ZQogIH0KCiAgZ2V0IHJlcGxpY2F0b3IoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlID09PSBudWxsID8gbnVsbCA6IHRoaXMuY29yZS5yZXBsaWNhdG9yCiAgfQoKICBfZ2V0U25hcHNob3QoKSB7CiAgICByZXR1cm4gewogICAgICBsZW5ndGg6IHRoaXMuc3RhdGUubGVuZ3RoLAogICAgICBieXRlTGVuZ3RoOiB0aGlzLnN0YXRlLmJ5dGVMZW5ndGgsCiAgICAgIGZvcms6IHRoaXMuc3RhdGUuZm9yawogICAgfQogIH0KCiAgX3VwZGF0ZVNuYXBzaG90KCkgewogICAgY29uc3QgcHJldiA9IHRoaXMuX3NuYXBzaG90CiAgICBjb25zdCBuZXh0ID0gKHRoaXMuX3NuYXBzaG90ID0gdGhpcy5fZ2V0U25hcHNob3QoKSkKCiAgICBpZiAoIXByZXYpIHJldHVybiB0cnVlCiAgICByZXR1cm4gcHJldi5sZW5ndGggIT09IG5leHQubGVuZ3RoIHx8IHByZXYuZm9yayAhPT0gbmV4dC5mb3JrCiAgfQoKICBfaXNXcml0YWJsZSgpIHsKICAgIGlmICh0aGlzLl9yZWFkb25seSkgcmV0dXJuIGZhbHNlCiAgICBpZiAodGhpcy5zdGF0ZSAmJiAhdGhpcy5zdGF0ZS5pc0RlZmF1bHQoKSkgcmV0dXJuIHRydWUKICAgIHJldHVybiAhISh0aGlzLmtleVBhaXIgJiYgdGhpcy5rZXlQYWlyLnNlY3JldEtleSkKICB9CgogIGNsb3NlKHsgZXJyb3IgfSA9IHt9KSB7CiAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4gdGhpcy5jbG9zaW5nCgogICAgdGhpcy5jbG9zaW5nID0gdGhpcy5fY2xvc2UoZXJyb3IgfHwgbnVsbCkKICAgIHJldHVybiB0aGlzLmNsb3NpbmcKICB9CgogIGNsZWFyUmVxdWVzdHMoYWN0aXZlUmVxdWVzdHMsIGVycm9yKSB7CiAgICBpZiAoIWFjdGl2ZVJlcXVlc3RzLmxlbmd0aCkgcmV0dXJuCiAgICBpZiAodGhpcy5jb3JlKSB0aGlzLmNvcmUucmVwbGljYXRvci5jbGVhclJlcXVlc3RzKGFjdGl2ZVJlcXVlc3RzLCBlcnJvcikKICB9CgogIGFzeW5jIF9jbG9zZShlcnJvcikgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMub3BlbmluZwogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBpZiAoIXRoaXMuY2xvc2VkKSB0aHJvdyBlcnIKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLmNsb3NlZCA9PT0gdHJ1ZSkgcmV0dXJuCgogICAgdGhpcy5jb3JlLnJlbW92ZU1vbml0b3IodGhpcykKICAgIHRoaXMuc3RhdGUucmVtb3ZlU2Vzc2lvbih0aGlzKQogICAgdGhpcy5fcmVtb3ZlU2Vzc2lvbigpCgogICAgdGhpcy5yZWFkYWJsZSA9IGZhbHNlCiAgICB0aGlzLndyaXRhYmxlID0gZmFsc2UKICAgIHRoaXMub3BlbmVkID0gZmFsc2UKCiAgICBjb25zdCBnYyA9IFtdCiAgICBmb3IgKGNvbnN0IGV4dCBvZiB0aGlzLmV4dGVuc2lvbnMudmFsdWVzKCkpIHsKICAgICAgaWYgKGV4dC5zZXNzaW9uID09PSB0aGlzKSBnYy5wdXNoKGV4dCkKICAgIH0KICAgIGZvciAoY29uc3QgZXh0IG9mIGdjKSBleHQuZGVzdHJveSgpCgogICAgdGhpcy5jb3JlLnJlcGxpY2F0b3IuZmluZGluZ1BlZXJzIC09IHRoaXMuX2ZpbmRpbmdQZWVycwogICAgdGhpcy5jb3JlLnJlcGxpY2F0b3IuY2xlYXJSZXF1ZXN0cyh0aGlzLmFjdGl2ZVJlcXVlc3RzLCBlcnJvcikKICAgIHRoaXMuY29yZS5yZXBsaWNhdG9yLnVwZGF0ZUFjdGl2aXR5KHRoaXMuX2FjdGl2ZSA/IC0xIDogMCkKCiAgICB0aGlzLl9maW5kaW5nUGVlcnMgPSAwCgogICAgdGhpcy5zdGF0ZS51bnJlZigpCgogICAgaWYgKHRoaXMuZXhjbHVzaXZlKSB0aGlzLmNvcmUudW5sb2NrRXhjbHVzaXZlKCkKCiAgICBpZiAodGhpcy5jb3JlLmhhc1Nlc3Npb24oKSkgewogICAgICAvLyBlbWl0ICJmYWtlIiBjbG9zZSBhcyB0aGlzIGlzIGEgc2Vzc2lvbgogICAgICB0aGlzLmNsb3NlZCA9IHRydWUKICAgICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLmNvcmUuYXV0b0Nsb3NlKSBhd2FpdCB0aGlzLmNvcmUuY2xvc2UoKQoKICAgIHRoaXMuY2xvc2VkID0gdHJ1ZQogICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgfQoKICBhc3luYyBjb21taXQoc2Vzc2lvbiwgb3B0cykgewogICAgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBhd2FpdCBzZXNzaW9uLnJlYWR5KCkKCiAgICByZXR1cm4gdGhpcy5zdGF0ZS5jb21taXQoc2Vzc2lvbi5zdGF0ZSwgeyBrZXlQYWlyOiB0aGlzLmtleVBhaXIsIC4uLm9wdHMgfSkKICB9CgogIHJlcGxpY2F0ZShpc0luaXRpYXRvciwgb3B0cyA9IHt9KSB7CiAgICAvLyBPbmx5IGxpbWl0YXRpb24gaGVyZSBpcyB0aGF0IG9uZGlzY292ZXJ5a2V5IGRvZXNuJ3Qgd29yayBhdG0gd2hlbiBwYXNzaW5nIGEgbXV4ZXIgZGlyZWN0bHksCiAgICAvLyBiZWNhdXNlIGl0IGRvZXNuJ3QgcmVhbGx5IG1ha2UgYSBsb3Qgb2Ygc2Vuc2UuCiAgICBpZiAoUHJvdG9tdXguaXNQcm90b211eChpc0luaXRpYXRvcikpIHJldHVybiB0aGlzLl9hdHRhY2hUb011eGVyKGlzSW5pdGlhdG9yKQoKICAgIC8vIGlmIHNhbWUgc3RyZWFtIGlzIHBhc3NlZCB0d2ljZSwgaWdub3JlIHRoZSAybmQgb25lIGJlZm9yZSB3ZSBtYWtlIHNlc3Npb25zIGV0YwogICAgaWYgKGlzU3RyZWFtKGlzSW5pdGlhdG9yKSAmJiB0aGlzLl9pc0F0dGFjaGVkKGlzSW5pdGlhdG9yKSkgcmV0dXJuIGlzSW5pdGlhdG9yCgogICAgY29uc3QgcHJvdG9jb2xTdHJlYW0gPSBIeXBlcmNvcmUuY3JlYXRlUHJvdG9jb2xTdHJlYW0oaXNJbml0aWF0b3IsIG9wdHMpCiAgICBjb25zdCBub2lzZVN0cmVhbSA9IHByb3RvY29sU3RyZWFtLm5vaXNlU3RyZWFtCiAgICBjb25zdCBwcm90b2NvbCA9IG5vaXNlU3RyZWFtLnVzZXJEYXRhCgogICAgdGhpcy5fYXR0YWNoVG9NdXhlcihwcm90b2NvbCkKCiAgICByZXR1cm4gcHJvdG9jb2xTdHJlYW0KICB9CgogIF9pc0F0dGFjaGVkKHN0cmVhbSkgewogICAgcmV0dXJuICgKICAgICAgc3RyZWFtLnVzZXJEYXRhICYmCiAgICAgIHRoaXMuY29yZSAmJgogICAgICB0aGlzLmNvcmUucmVwbGljYXRvciAmJgogICAgICB0aGlzLmNvcmUucmVwbGljYXRvci5hdHRhY2hlZChzdHJlYW0udXNlckRhdGEpCiAgICApCiAgfQoKICBfYXR0YWNoVG9NdXhlcihtdXgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCkgewogICAgICB0aGlzLmNvcmUucmVwbGljYXRvci5hdHRhY2hUbyhtdXgpCiAgICB9IGVsc2UgewogICAgICB0aGlzLm9wZW5pbmcudGhlbigoKSA9PiB0aGlzLmNvcmUucmVwbGljYXRvci5hdHRhY2hUbyhtdXgpLCBtdXguZGVzdHJveS5iaW5kKG11eCkpCiAgICB9CgogICAgcmV0dXJuIG11eAogIH0KCiAgZ2V0IGlkKCkgewogICAgcmV0dXJuIHRoaXMuY29yZSA9PT0gbnVsbCA/IG51bGwgOiB0aGlzLmNvcmUuaWQKICB9CgogIGdldCBrZXkoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlID09PSBudWxsID8gbnVsbCA6IHRoaXMuY29yZS5rZXkKICB9CgogIGdldCBkaXNjb3ZlcnlLZXkoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlID09PSBudWxsID8gbnVsbCA6IHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkKICB9CgogIGdldCBtYW5pZmVzdCgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUgPT09IG51bGwgPyBudWxsIDogdGhpcy5jb3JlLm1hbmlmZXN0CiAgfQoKICBnZXQgbGVuZ3RoKCkgewogICAgaWYgKHRoaXMuX3NuYXBzaG90KSByZXR1cm4gdGhpcy5fc25hcHNob3QubGVuZ3RoCiAgICByZXR1cm4gdGhpcy5vcGVuZWQgPT09IGZhbHNlID8gMCA6IHRoaXMuc3RhdGUubGVuZ3RoCiAgfQoKICBnZXQgc2lnbmVkTGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMub3BlbmVkID09PSBmYWxzZSA/IDAgOiB0aGlzLnN0YXRlLnNpZ25lZExlbmd0aCgpCiAgfQoKICAvKioKICAgKiBEZXByZWNhdGVkLiBVc2UgYGNvbnN0IHsgYnl0ZUxlbmd0aCB9ID0gYXdhaXQgY29yZS5pbmZvKClgLgogICAqLwogIGdldCBieXRlTGVuZ3RoKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgcmV0dXJuIDAKICAgIGlmICh0aGlzLl9zbmFwc2hvdCkgcmV0dXJuIHRoaXMuX3NuYXBzaG90LmJ5dGVMZW5ndGgKICAgIHJldHVybiB0aGlzLnN0YXRlLmJ5dGVMZW5ndGggLSB0aGlzLnN0YXRlLmxlbmd0aCAqIHRoaXMucGFkZGluZwogIH0KCiAgZ2V0IHJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSByZXR1cm4gMAogICAgcmV0dXJuIE1hdGgubWluKHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgsIHRoaXMuY29yZS5oZWFkZXIuaGludHMucmVtb3RlQ29udGlndW91c0xlbmd0aCkKICB9CgogIGdldCBjb250aWd1b3VzTGVuZ3RoKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgcmV0dXJuIDAKICAgIHJldHVybiBNYXRoLm1pbih0aGlzLmNvcmUuc3RhdGUubGVuZ3RoLCB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgpCiAgfQoKICBnZXQgY29udGlndW91c0J5dGVMZW5ndGgoKSB7CiAgICByZXR1cm4gMAogIH0KCiAgZ2V0IGZvcmsoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSByZXR1cm4gMAogICAgcmV0dXJuIHRoaXMuc3RhdGUuZm9yawogIH0KCiAgZ2V0IHBhZGRpbmcoKSB7CiAgICBpZiAodGhpcy5lbmNyeXB0aW9uICYmIHRoaXMua2V5ICYmIHRoaXMubWFuaWZlc3QpIHsKICAgICAgcmV0dXJuIHRoaXMuZW5jcnlwdGlvbi5wYWRkaW5nKHRoaXMuY29yZSwgdGhpcy5sZW5ndGgpCiAgICB9CgogICAgcmV0dXJuIDAKICB9CgogIGdldCBwZWVycygpIHsKICAgIHJldHVybiB0aGlzLm9wZW5lZCA9PT0gZmFsc2UgPyBbXSA6IHRoaXMuY29yZS5yZXBsaWNhdG9yLnBlZXJzCiAgfQoKICBnZXQgZ2xvYmFsQ2FjaGUoKSB7CiAgICByZXR1cm4gdGhpcy5vcGVuZWQgPT09IGZhbHNlID8gbnVsbCA6IHRoaXMuY29yZS5nbG9iYWxDYWNoZQogIH0KCiAgcmVhZHkoKSB7CiAgICByZXR1cm4gdGhpcy5vcGVuaW5nCiAgfQoKICBhc3luYyBzZXRVc2VyRGF0YShrZXksIHZhbHVlKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgdGhpcy5nZXRVc2VyRGF0YShrZXkpCiAgICBpZiAoZXhpc3RpbmcgJiYgYjRhLmlzQnVmZmVyKHZhbHVlKSAmJiBiNGEuZXF1YWxzKGV4aXN0aW5nLCB2YWx1ZSkpIHJldHVybgogICAgYXdhaXQgdGhpcy5zdGF0ZS5zZXRVc2VyRGF0YShrZXksIHZhbHVlKQogIH0KCiAgYXN5bmMgZ2V0VXNlckRhdGEoa2V5KSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGNvbnN0IGJhdGNoID0gdGhpcy5zdGF0ZS5zdG9yYWdlLnJlYWQoKQogICAgY29uc3QgcCA9IGJhdGNoLmdldFVzZXJEYXRhKGtleSkKICAgIGJhdGNoLnRyeUZsdXNoKCkKICAgIHJldHVybiBwCiAgfQoKICB0cmFuc2ZlclNlc3Npb24oY29yZSkgewogICAgLy8gdG9kbzogdmFsaWRhdGUgd2UgY2FuIG1vdmUKCiAgICBpZiAodGhpcy53ZWFrID09PSBmYWxzZSkgewogICAgICB0aGlzLmNvcmUuYWN0aXZlU2Vzc2lvbnMtLQogICAgICBjb3JlLmFjdGl2ZVNlc3Npb25zKysKICAgIH0KCiAgICBpZiAodGhpcy5fbW9uaXRvckluZGV4ID49IDApIHsKICAgICAgdGhpcy5jb3JlLnJlbW92ZU1vbml0b3IodGhpcykKICAgICAgY29yZS5hZGRNb25pdG9yKHRoaXMpCiAgICB9CgogICAgY29uc3Qgb2xkID0gdGhpcy5jb3JlCgogICAgdGhpcy5jb3JlID0gY29yZQoKICAgIG9sZC5yZXBsaWNhdG9yLmNsZWFyUmVxdWVzdHModGhpcy5hY3RpdmVSZXF1ZXN0cywgU0VTU0lPTl9NT1ZFRCgpKQoKICAgIHRoaXMuZW1pdCgnbWlncmF0ZScsIHRoaXMua2V5KQogIH0KCiAgZmluZGluZ1BlZXJzKCkgewogICAgdGhpcy5fZmluZGluZ1BlZXJzKysKICAgIGlmICh0aGlzLmNvcmUgIT09IG51bGwgJiYgIXRoaXMuY2xvc2luZykgdGhpcy5jb3JlLnJlcGxpY2F0b3IuZmluZGluZ1BlZXJzKysKCiAgICBsZXQgb25jZSA9IHRydWUKCiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAodGhpcy5jbG9zaW5nIHx8ICFvbmNlKSByZXR1cm4KICAgICAgb25jZSA9IGZhbHNlCiAgICAgIHRoaXMuX2ZpbmRpbmdQZWVycy0tCiAgICAgIGlmICh0aGlzLmNvcmUgIT09IG51bGwgJiYgLS10aGlzLmNvcmUucmVwbGljYXRvci5maW5kaW5nUGVlcnMgPT09IDApIHsKICAgICAgICB0aGlzLmNvcmUucmVwbGljYXRvci51cGRhdGVBbGwoKQogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBpbmZvKG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwoKICAgIHJldHVybiBJbmZvLmZyb20odGhpcywgb3B0cykKICB9CgogIGFzeW5jIHVwZGF0ZShvcHRzKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGlmICh0aGlzLmNsb3NpbmcgIT09IG51bGwpIHJldHVybiBmYWxzZQogICAgaWYgKHRoaXMuc25hcHNob3R0ZWQpIHJldHVybiBmYWxzZQoKICAgIGlmICh0aGlzLndyaXRhYmxlICYmICghb3B0cyB8fCBvcHRzLmZvcmNlICE9PSB0cnVlKSkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgcmVtb3RlV2FpdCA9IHRoaXMuX3Nob3VsZFdhaXQob3B0cywgdGhpcy5jb3JlLnJlcGxpY2F0b3IuZmluZGluZ1BlZXJzID4gMCkKCiAgICBsZXQgdXBncmFkZWQgPSBmYWxzZQoKICAgIGlmIChhd2FpdCB0aGlzLmNvcmUucmVwbGljYXRvci5hcHBseVBlbmRpbmdSZW9yZygpKSB7CiAgICAgIHVwZ3JhZGVkID0gdHJ1ZQogICAgfQoKICAgIGlmICghdXBncmFkZWQgJiYgcmVtb3RlV2FpdCkgewogICAgICBjb25zdCBhY3RpdmVSZXF1ZXN0cyA9IChvcHRzICYmIG9wdHMuYWN0aXZlUmVxdWVzdHMpIHx8IHRoaXMuYWN0aXZlUmVxdWVzdHMKICAgICAgY29uc3QgcmVxID0gdGhpcy5jb3JlLnJlcGxpY2F0b3IuYWRkVXBncmFkZShhY3RpdmVSZXF1ZXN0cykKCiAgICAgIHRyeSB7CiAgICAgICAgdXBncmFkZWQgPSBhd2FpdCByZXEucHJvbWlzZQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBpZiAoaXNTZXNzaW9uTW92ZWQoZXJyKSkgcmV0dXJuIHRoaXMudXBkYXRlKG9wdHMpCiAgICAgICAgdGhyb3cgZXJyCiAgICAgIH0KICAgIH0KCiAgICBpZiAoIXVwZ3JhZGVkKSByZXR1cm4gZmFsc2UKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBzZWVrKGJ5dGVzLCBvcHRzKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGlmICghaXNWYWxpZEluZGV4KGJ5dGVzKSkgdGhyb3cgQVNTRVJUSU9OKCdzZWVrIGlzIGludmFsaWQnLCB0aGlzLmRpc2NvdmVyeUtleSkKCiAgICBjb25zdCBhY3RpdmVSZXF1ZXN0cyA9IChvcHRzICYmIG9wdHMuYWN0aXZlUmVxdWVzdHMpIHx8IHRoaXMuYWN0aXZlUmVxdWVzdHMKCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uICYmICF0aGlzLmNvcmUubWFuaWZlc3QpIHsKICAgICAgY29uc3QgcmVxID0gdGhpcy5yZXBsaWNhdG9yLmFkZFVwZ3JhZGUoYWN0aXZlUmVxdWVzdHMpCiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgcmVxLnByb21pc2UKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKGlzU2Vzc2lvbk1vdmVkKGVycikpIHJldHVybiB0aGlzLnNlZWsoYnl0ZXMsIG9wdHMpCiAgICAgICAgdGhyb3cgZXJyCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBzID0gTWVya2xlVHJlZS5zZWVrKHRoaXMuc3RhdGUsIGJ5dGVzLCB0aGlzLnBhZGRpbmcpCgogICAgY29uc3Qgb2Zmc2V0ID0gYXdhaXQgcy51cGRhdGUoKQogICAgaWYgKG9mZnNldCkgcmV0dXJuIG9mZnNldAoKICAgIGlmICh0aGlzLmNsb3NpbmcgIT09IG51bGwpIHsKICAgICAgdGhyb3cgU0VTU0lPTl9DTE9TRUQoJ2Nhbm5vdCBzZWVrIG9uIGEgY2xvc2VkIHNlc3Npb24nLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICBpZiAoIXRoaXMuX3Nob3VsZFdhaXQob3B0cywgdGhpcy53YWl0KSkgcmV0dXJuIG51bGwKCiAgICBjb25zdCByZXEgPSB0aGlzLmNvcmUucmVwbGljYXRvci5hZGRTZWVrKGFjdGl2ZVJlcXVlc3RzLCBzKQoKICAgIGNvbnN0IHRpbWVvdXQgPSBvcHRzICYmIG9wdHMudGltZW91dCAhPT0gdW5kZWZpbmVkID8gb3B0cy50aW1lb3V0IDogdGhpcy50aW1lb3V0CiAgICBpZiAodGltZW91dCkgcmVxLmNvbnRleHQuc2V0VGltZW91dChyZXEsIHRpbWVvdXQpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHJlcS5wcm9taXNlCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKGlzU2Vzc2lvbk1vdmVkKGVycikpIHJldHVybiB0aGlzLnNlZWsoYnl0ZXMsIG9wdHMpCiAgICAgIHRocm93IGVycgogICAgfQogIH0KCiAgYXN5bmMgaGFzKHN0YXJ0LCBlbmQgPSBzdGFydCArIDEpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgaWYgKCFpc1ZhbGlkSW5kZXgoc3RhcnQpIHx8ICFpc1ZhbGlkSW5kZXgoZW5kKSkgewogICAgICB0aHJvdyBBU1NFUlRJT04oJ2hhcyByYW5nZSBpcyBpbnZhbGlkJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgaWYgKHRoaXMuc3RhdGUuaXNEZWZhdWx0KCkpIHsKICAgICAgaWYgKGVuZCA9PT0gc3RhcnQgKyAxKSByZXR1cm4gdGhpcy5jb3JlLmJpdGZpZWxkLmdldChzdGFydCkKCiAgICAgIGNvbnN0IGkgPSB0aGlzLmNvcmUuYml0ZmllbGQuZmlyc3RVbnNldChzdGFydCkKICAgICAgcmV0dXJuIGkgPT09IC0xIHx8IGkgPj0gZW5kCiAgICB9CgogICAgaWYgKGVuZCA9PT0gc3RhcnQgKyAxKSB7CiAgICAgIGNvbnN0IHJ4ID0gdGhpcy5zdGF0ZS5zdG9yYWdlLnJlYWQoKQogICAgICBjb25zdCBibG9jayA9IHJ4LmdldEJsb2NrKHN0YXJ0KQogICAgICByeC50cnlGbHVzaCgpCgogICAgICByZXR1cm4gKGF3YWl0IGJsb2NrKSAhPT0gbnVsbAogICAgfQoKICAgIGxldCBjb3VudCA9IDAKCiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0YXRlLnN0b3JhZ2UuY3JlYXRlQmxvY2tTdHJlYW0oeyBndGU6IHN0YXJ0LCBsdDogZW5kIH0pCiAgICBmb3IgYXdhaXQgKGNvbnN0IGJsb2NrIG9mIHN0cmVhbSkgewogICAgICBpZiAoYmxvY2sgPT09IG51bGwpIHJldHVybiBmYWxzZQogICAgICBjb3VudCsrCiAgICB9CgogICAgcmV0dXJuIGNvdW50ID09PSBlbmQgLSBzdGFydAogIH0KCiAgYXN5bmMgZ2V0KGluZGV4LCBvcHRzKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGlmICghaXNWYWxpZEluZGV4KGluZGV4KSkgdGhyb3cgQVNTRVJUSU9OKCdibG9jayBpbmRleCBpcyBpbnZhbGlkJywgdGhpcy5kaXNjb3ZlcnlLZXkpCgogICAgaWYgKHRoaXMuY2xvc2luZyAhPT0gbnVsbCkgewogICAgICB0aHJvdyBTRVNTSU9OX0NMT1NFRCgnY2Fubm90IGdldCBvbiBhIGNsb3NlZCBzZXNzaW9uJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgY29uc3QgZW5jb2RpbmcgPQogICAgICAob3B0cyAmJiBvcHRzLnZhbHVlRW5jb2RpbmcgJiYgYy5mcm9tKG9wdHMudmFsdWVFbmNvZGluZykpIHx8IHRoaXMudmFsdWVFbmNvZGluZwoKICAgIGlmICh0aGlzLm9uc2VxICE9PSBudWxsKSB0aGlzLm9uc2VxKGluZGV4LCB0aGlzKQoKICAgIGNvbnN0IHJlcSA9IHRoaXMuX2dldChpbmRleCwgb3B0cykKCiAgICBsZXQgYmxvY2sgPSBhd2FpdCByZXEKICAgIGlmICghYmxvY2spIHJldHVybiBudWxsCgogICAgaWYgKG9wdHMgJiYgb3B0cy5yYXcpIHJldHVybiBibG9jawoKICAgIGlmICh0aGlzLmVuY3J5cHRpb24gJiYgKCFvcHRzIHx8IG9wdHMuZGVjcnlwdCAhPT0gZmFsc2UpKSB7CiAgICAgIC8vIENvcHkgdGhlIGJsb2NrIGFzIGl0IG1pZ2h0IGJlIHNoYXJlZCB3aXRoIG90aGVyIHNlc3Npb25zLgogICAgICBibG9jayA9IGI0YS5mcm9tKGJsb2NrKQoKICAgICAgYXdhaXQgdGhpcy5lbmNyeXB0aW9uLmRlY3J5cHQoaW5kZXgsIGJsb2NrLCB0aGlzLmNvcmUpCiAgICB9CgogICAgcmV0dXJuIHRoaXMuX2RlY29kZShlbmNvZGluZywgYmxvY2ssIGluZGV4KQogIH0KCiAgYXN5bmMgY2xlYXIoc3RhcnQsIGVuZCA9IHN0YXJ0ICsgMSwgb3B0cykgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBpZiAodGhpcy5jbG9zaW5nICE9PSBudWxsKSB7CiAgICAgIHRocm93IFNFU1NJT05fQ0xPU0VEKCdjYW5ub3QgY2xlYXIgb24gYSBjbG9zZWQgc2Vzc2lvbicsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIGlmICh0eXBlb2YgZW5kID09PSAnb2JqZWN0JykgewogICAgICBvcHRzID0gZW5kCiAgICAgIGVuZCA9IHN0YXJ0ICsgMQogICAgfQoKICAgIGlmICghaXNWYWxpZEluZGV4KHN0YXJ0KSB8fCAhaXNWYWxpZEluZGV4KGVuZCkpIHsKICAgICAgdGhyb3cgQVNTRVJUSU9OKCdjbGVhciByYW5nZSBpcyBpbnZhbGlkJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgY29uc3QgY2xlYXJlZCA9IG9wdHMgJiYgb3B0cy5kaWZmID8geyBibG9ja3M6IDAgfSA6IG51bGwKCiAgICBpZiAoc3RhcnQgPj0gZW5kKSByZXR1cm4gY2xlYXJlZAogICAgaWYgKHN0YXJ0ID49IHRoaXMubGVuZ3RoKSByZXR1cm4gY2xlYXJlZAoKICAgIGF3YWl0IHRoaXMuc3RhdGUuY2xlYXIoc3RhcnQsIGVuZCwgY2xlYXJlZCkKCiAgICByZXR1cm4gY2xlYXJlZAogIH0KCiAgYXN5bmMgcHVyZ2UoKSB7CiAgICBhd2FpdCB0aGlzLl9jbG9zZUFsbFNlc3Npb25zKG51bGwpCiAgICBhd2FpdCB0aGlzLmNvcmUucHVyZ2UoKQogIH0KCiAgYXN5bmMgX2dldChpbmRleCwgb3B0cykgewogICAgY29uc3QgYmxvY2sgPSBhd2FpdCByZWFkQmxvY2sodGhpcy5zdGF0ZS5zdG9yYWdlLnJlYWQoKSwgaW5kZXgpCgogICAgaWYgKGJsb2NrICE9PSBudWxsKSByZXR1cm4gYmxvY2sKCiAgICBpZiAodGhpcy5jbG9zaW5nICE9PSBudWxsKSB7CiAgICAgIHRocm93IFNFU1NJT05fQ0xPU0VEKCdjYW5ub3QgZ2V0IG9uIGEgY2xvc2VkIHNlc3Npb24nLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICAvLyBzbmFwc2hvdCBzaG91bGQgY2hlY2sgaWYgY29yZSBoYXMgYmxvY2sKICAgIGlmICh0aGlzLl9zbmFwc2hvdCAhPT0gbnVsbCkgewogICAgICBjaGVja1NuYXBzaG90KHRoaXMsIGluZGV4KQogICAgICBjb25zdCBjb3JlQmxvY2sgPSBhd2FpdCByZWFkQmxvY2sodGhpcy5jb3JlLnN0YXRlLnN0b3JhZ2UucmVhZCgpLCBpbmRleCkKCiAgICAgIGNoZWNrU25hcHNob3QodGhpcywgaW5kZXgpCiAgICAgIGlmIChjb3JlQmxvY2sgIT09IG51bGwpIHJldHVybiBjb3JlQmxvY2sKICAgIH0KCiAgICAvLyBsZXRzIGNoZWNrIHRoZSBiaXRmaWVsZCB0byBzZWUgaWYgd2UgZ290IGl0IGR1cmluZyB0aGUgYWJvdmUgYXN5bmMgY2FsbHMKICAgIC8vIHRoaXMgaXMgdGhlIGxhc3QgcmVzb3J0IGJlZm9yZSByZXBsaWNhdGlvbiwgc28gYWx3YXlzIHNhZmUuCiAgICBpZiAodGhpcy5jb3JlLmJpdGZpZWxkLmdldChpbmRleCkpIHsKICAgICAgY29uc3QgY29yZUJsb2NrID0gYXdhaXQgcmVhZEJsb2NrKHRoaXMuc3RhdGUuc3RvcmFnZS5yZWFkKCksIGluZGV4KQogICAgICAvLyBUT0RPOiB0aGlzIHNob3VsZCBub3QgYmUgbmVlZGVkLCBvbmx5IG5lZWRlZCBhdG0gaW4gY2FzZSB3ZSBhcmUgZG9pbmcgYSBtb3ZlVG8gZHVyaW5nIHRoaXMgKHdlIHNob3VsZCBmaXgpCiAgICAgIGlmIChjb3JlQmxvY2sgIT09IG51bGwpIHJldHVybiBjb3JlQmxvY2sKICAgIH0KCiAgICBpZiAoIXRoaXMuX3Nob3VsZFdhaXQob3B0cywgdGhpcy53YWl0KSkgcmV0dXJuIG51bGwKCiAgICBpZiAob3B0cyAmJiBvcHRzLm9ud2FpdCkgb3B0cy5vbndhaXQoaW5kZXgsIHRoaXMpCiAgICBpZiAodGhpcy5vbndhaXQpIHRoaXMub253YWl0KGluZGV4LCB0aGlzKQoKICAgIGNvbnN0IGFjdGl2ZVJlcXVlc3RzID0gKG9wdHMgJiYgb3B0cy5hY3RpdmVSZXF1ZXN0cykgfHwgdGhpcy5hY3RpdmVSZXF1ZXN0cwoKICAgIGNvbnN0IHJlcSA9IHRoaXMuY29yZS5yZXBsaWNhdG9yLmFkZEJsb2NrKGFjdGl2ZVJlcXVlc3RzLCBpbmRleCkKICAgIHJlcS5zbmFwc2hvdCA9IGluZGV4IDwgdGhpcy5sZW5ndGgKCiAgICBjb25zdCB0aW1lb3V0ID0gb3B0cyAmJiBvcHRzLnRpbWVvdXQgIT09IHVuZGVmaW5lZCA/IG9wdHMudGltZW91dCA6IHRoaXMudGltZW91dAogICAgaWYgKHRpbWVvdXQpIHJlcS5jb250ZXh0LnNldFRpbWVvdXQocmVxLCB0aW1lb3V0KQoKICAgIGxldCByZXBsaWNhdGVkQmxvY2sgPSBudWxsCgogICAgdHJ5IHsKICAgICAgcmVwbGljYXRlZEJsb2NrID0gYXdhaXQgcmVxLnByb21pc2UKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAoaXNTZXNzaW9uTW92ZWQoZXJyKSkgcmV0dXJuIHRoaXMuX2dldChpbmRleCwgb3B0cykKICAgICAgdGhyb3cgZXJyCiAgICB9CgogICAgaWYgKHRoaXMuX3NuYXBzaG90ICE9PSBudWxsKSBjaGVja1NuYXBzaG90KHRoaXMsIGluZGV4KQogICAgcmV0dXJuIG1heWJlVW5zbGFiKHJlcGxpY2F0ZWRCbG9jaykKICB9CgogIF9zaG91bGRXYWl0KG9wdHMsIGRlZmF1bHRWYWx1ZSkgewogICAgaWYgKG9wdHMpIHsKICAgICAgaWYgKG9wdHMud2FpdCA9PT0gZmFsc2UpIHJldHVybiBmYWxzZQogICAgICBpZiAob3B0cy53YWl0ID09PSB0cnVlKSByZXR1cm4gdHJ1ZQogICAgfQogICAgcmV0dXJuIGRlZmF1bHRWYWx1ZQogIH0KCiAgY3JlYXRlUmVhZFN0cmVhbShvcHRzKSB7CiAgICByZXR1cm4gbmV3IFJlYWRTdHJlYW0odGhpcywgb3B0cykKICB9CgogIGNyZWF0ZVdyaXRlU3RyZWFtKCkgewogICAgcmV0dXJuIG5ldyBXcml0ZVN0cmVhbSh0aGlzKQogIH0KCiAgY3JlYXRlQnl0ZVN0cmVhbShvcHRzKSB7CiAgICByZXR1cm4gbmV3IEJ5dGVTdHJlYW0odGhpcywgb3B0cykKICB9CgogIGRvd25sb2FkKHJhbmdlKSB7CiAgICByZXR1cm4gbmV3IERvd25sb2FkKHRoaXMsIHJhbmdlKQogIH0KCiAgLy8gVE9ETzogZ2V0IHJpZCBvZiB0aGlzIC8gZGVwcmVjYXRlIGl0PwogIHVuZG93bmxvYWQocmFuZ2UpIHsKICAgIHJhbmdlLmRlc3Ryb3kobnVsbCkKICB9CgogIC8vIFRPRE86IGdldCByaWQgb2YgdGhpcyAvIGRlcHJlY2F0ZSBpdD8KICBjYW5jZWwocmVxdWVzdCkgewogICAgLy8gRG8gbm90aGluZyBmb3Igbm93CiAgfQoKICBhc3luYyB0cnVuY2F0ZShuZXdMZW5ndGggPSAwLCBvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwoKICAgIGNvbnN0IHsKICAgICAgZm9yayA9IHRoaXMuc3RhdGUuZm9yayArIDEsCiAgICAgIGtleVBhaXIgPSB0aGlzLmtleVBhaXIsCiAgICAgIHNpZ25hdHVyZSA9IG51bGwKICAgIH0gPSB0eXBlb2Ygb3B0cyA9PT0gJ251bWJlcicgPyB7IGZvcms6IG9wdHMgfSA6IG9wdHMKCiAgICBjb25zdCBpc0RlZmF1bHQgPSB0aGlzLnN0YXRlID09PSB0aGlzLmNvcmUuc3RhdGUKICAgIGNvbnN0IHdyaXRhYmxlID0gIXRoaXMuX3JlYWRvbmx5ICYmICEhKHNpZ25hdHVyZSB8fCAoa2V5UGFpciAmJiBrZXlQYWlyLnNlY3JldEtleSkpCiAgICBpZiAoaXNEZWZhdWx0ICYmIHdyaXRhYmxlID09PSBmYWxzZSAmJiAobmV3TGVuZ3RoID4gMCB8fCBmb3JrICE9PSB0aGlzLnN0YXRlLmZvcmspKSB7CiAgICAgIHRocm93IFNFU1NJT05fTk9UX1dSSVRBQkxFKCdjYW5ub3QgYXBwZW5kIHRvIGEgbm9uLXdyaXRhYmxlIGNvcmUnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICBhd2FpdCB0aGlzLnN0YXRlLnRydW5jYXRlKG5ld0xlbmd0aCwgZm9yaywgeyBrZXlQYWlyLCBzaWduYXR1cmUgfSkKCiAgICAvLyBUT0RPOiBTaG91bGQgcHJvcGFnYXRlIGZyb20gYW4gZXZlbnQgdHJpZ2dlcmVkIGJ5IHRoZSBvcGxvZwogICAgaWYgKHRoaXMuc3RhdGUgPT09IHRoaXMuY29yZS5zdGF0ZSkgdGhpcy5jb3JlLnJlcGxpY2F0b3IudXBkYXRlQWxsKCkKICB9CgogIGFzeW5jIGFwcGVuZChibG9ja3MsIG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCgogICAgY29uc3QgaXNEZWZhdWx0ID0gdGhpcy5zdGF0ZSA9PT0gdGhpcy5jb3JlLnN0YXRlCiAgICBjb25zdCBkZWZhdWx0S2V5UGFpciA9IHRoaXMuc3RhdGUubmFtZSA9PT0gbnVsbCA/IHRoaXMua2V5UGFpciA6IG51bGwKCiAgICBjb25zdCB7IGtleVBhaXIgPSBkZWZhdWx0S2V5UGFpciwgc2lnbmF0dXJlID0gbnVsbCwgbWF4TGVuZ3RoLCBwb3N0YXBwZW5kID0gbnVsbCB9ID0gb3B0cwogICAgY29uc3Qgd3JpdGFibGUgPQogICAgICAhaXNEZWZhdWx0IHx8ICEhc2lnbmF0dXJlIHx8ICEhKGtleVBhaXIgJiYga2V5UGFpci5zZWNyZXRLZXkpIHx8IG9wdHMud3JpdGFibGUgPT09IHRydWUKCiAgICBpZiAodGhpcy5fcmVhZG9ubHkgfHwgd3JpdGFibGUgPT09IGZhbHNlKSB7CiAgICAgIHRocm93IFNFU1NJT05fTk9UX1dSSVRBQkxFKCdjYW5ub3QgYXBwZW5kIHRvIGEgcmVhZG9ubHkgY29yZScsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIGJsb2NrcyA9IEFycmF5LmlzQXJyYXkoYmxvY2tzKSA/IGJsb2NrcyA6IFtibG9ja3NdCgogICAgY29uc3QgcHJlYXBwZW5kID0gdGhpcy5lbmNyeXB0aW9uICYmIHRoaXMuX3ByZWFwcGVuZAoKICAgIGNvbnN0IGJ1ZmZlcnMgPSB0aGlzLmVuY29kZUJhdGNoICE9PSBudWxsID8gdGhpcy5lbmNvZGVCYXRjaChibG9ja3MpIDogbmV3IEFycmF5KGJsb2Nrcy5sZW5ndGgpCgogICAgaWYgKHRoaXMuZW5jb2RlQmF0Y2ggPT09IG51bGwpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBibG9ja3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBidWZmZXJzW2ldID0gdGhpcy5fZW5jb2RlKHRoaXMudmFsdWVFbmNvZGluZywgYmxvY2tzW2ldKQogICAgICB9CiAgICB9CiAgICBmb3IgKGNvbnN0IGIgb2YgYnVmZmVycykgewogICAgICBpZiAoYi5ieXRlTGVuZ3RoID4gTUFYX1NVR0dFU1RFRF9CTE9DS19TSVpFKSB7CiAgICAgICAgdGhyb3cgQkFEX0FSR1VNRU5UKAogICAgICAgICAgJ0FwcGVuZGVkIGJsb2NrIGV4Y2VlZHMgdGhlIG1heGltdW0gc3VnZ2VzdGVkIGJsb2NrIHNpemUnLAogICAgICAgICAgdGhpcy5kaXNjb3ZlcnlLZXkKICAgICAgICApCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGhpcy5zdGF0ZS5hcHBlbmQoYnVmZmVycywgeyBrZXlQYWlyLCBzaWduYXR1cmUsIHByZWFwcGVuZCwgcG9zdGFwcGVuZCwgbWF4TGVuZ3RoIH0pCiAgfQoKICBhc3luYyBzaWduYWJsZShsZW5ndGggPSAtMSwgZm9yayA9IC0xKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGlmIChsZW5ndGggPT09IC0xKSBsZW5ndGggPSB0aGlzLmxlbmd0aAogICAgaWYgKGZvcmsgPT09IC0xKSBmb3JrID0gdGhpcy5mb3JrCgogICAgcmV0dXJuIGNhcHMudHJlZVNpZ25hYmxlKHRoaXMua2V5LCBhd2FpdCB0aGlzLnRyZWVIYXNoKGxlbmd0aCksIGxlbmd0aCwgZm9yaykKICB9CgogIGFzeW5jIHRyZWVIYXNoKGxlbmd0aCA9IC0xKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGlmIChsZW5ndGggPT09IC0xKSBsZW5ndGggPSB0aGlzLmxlbmd0aAoKICAgIGNvbnN0IHJvb3RzID0gYXdhaXQgTWVya2xlVHJlZS5nZXRSb290cyh0aGlzLnN0YXRlLCBsZW5ndGgpCiAgICByZXR1cm4gY3J5cHRvLnRyZWUocm9vdHMpCiAgfQoKICBhc3luYyBtaXNzaW5nTm9kZXMoaW5kZXgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgcmV0dXJuIGF3YWl0IE1lcmtsZVRyZWUubWlzc2luZ05vZGVzKHRoaXMuY29yZS5zdGF0ZSwgMiAqIGluZGV4LCB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoKQogIH0KCiAgYXN5bmMgcHJvb2Yob3B0cykgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBjb25zdCByeCA9IHRoaXMuc3RhdGUuc3RvcmFnZS5yZWFkKCkKICAgIGNvbnN0IHByb29mUHJvbWlzZSA9IE1lcmtsZVRyZWUucHJvb2YodGhpcy5zdGF0ZSwgcngsIG9wdHMpCiAgICBjb25zdCBibG9ja1Byb21pc2UgPSBvcHRzICYmIG9wdHMuYmxvY2sgPyByeC5nZXRCbG9jayhvcHRzLmJsb2NrLmluZGV4KSA6IG51bGwKICAgIHJ4LnRyeUZsdXNoKCkKICAgIGNvbnN0IFtwcm9vZiwgYmxvY2tdID0gYXdhaXQgUHJvbWlzZS5hbGwoW3Byb29mUHJvbWlzZSwgYmxvY2tQcm9taXNlXSkKICAgIGNvbnN0IHNldHRsZWQgPSBhd2FpdCBwcm9vZi5zZXR0bGUoKQogICAgaWYgKGJsb2NrKSBzZXR0bGVkLmJsb2NrLnZhbHVlID0gYmxvY2sKICAgIHJldHVybiBzZXR0bGVkCiAgfQoKICBhc3luYyBhcHBseVByb29mKHByb29mLCBmcm9tKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIHJldHVybiB0aGlzLmNvcmUudmVyaWZ5KHByb29mLCBmcm9tKQogIH0KCiAgYXN5bmMgdmVyaWZ5RnVsbHlSZW1vdGUocHJvb2YpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgY29uc3QgYmF0Y2ggPSBhd2FpdCBNZXJrbGVUcmVlLnZlcmlmeUZ1bGx5UmVtb3RlKHRoaXMuc3RhdGUsIHByb29mKQogICAgYXdhaXQgdGhpcy5jb3JlLl92ZXJpZnlCYXRjaFVwZ3JhZGUoYmF0Y2gsIHByb29mLm1hbmlmZXN0KQogICAgcmV0dXJuIGJhdGNoCiAgfQoKICByZWdpc3RlckV4dGVuc2lvbihuYW1lLCBoYW5kbGVycyA9IHt9KSB7CiAgICBpZiAodGhpcy5leHRlbnNpb25zLmhhcyhuYW1lKSkgewogICAgICBjb25zdCBleHQgPSB0aGlzLmV4dGVuc2lvbnMuZ2V0KG5hbWUpCiAgICAgIGV4dC5oYW5kbGVycyA9IGhhbmRsZXJzCiAgICAgIGV4dC5lbmNvZGluZyA9IGMuZnJvbShoYW5kbGVycy5lbmNvZGluZyB8fCBjLmJ1ZmZlcikKICAgICAgZXh0LnNlc3Npb24gPSB0aGlzCiAgICAgIHJldHVybiBleHQKICAgIH0KCiAgICBjb25zdCBleHQgPSB7CiAgICAgIG5hbWUsCiAgICAgIGhhbmRsZXJzLAogICAgICBlbmNvZGluZzogYy5mcm9tKGhhbmRsZXJzLmVuY29kaW5nIHx8IGMuYnVmZmVyKSwKICAgICAgc2Vzc2lvbjogdGhpcywKICAgICAgc2VuZChtZXNzYWdlLCBwZWVyKSB7CiAgICAgICAgY29uc3QgYnVmZmVyID0gYy5lbmNvZGUodGhpcy5lbmNvZGluZywgbWVzc2FnZSkKICAgICAgICBwZWVyLmV4dGVuc2lvbihuYW1lLCBidWZmZXIpCiAgICAgIH0sCiAgICAgIGJyb2FkY2FzdChtZXNzYWdlKSB7CiAgICAgICAgY29uc3QgYnVmZmVyID0gYy5lbmNvZGUodGhpcy5lbmNvZGluZywgbWVzc2FnZSkKICAgICAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5zZXNzaW9uLnBlZXJzKSB7CiAgICAgICAgICBwZWVyLmV4dGVuc2lvbihuYW1lLCBidWZmZXIpCiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95KCkgewogICAgICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnNlc3Npb24ucGVlcnMpIHsKICAgICAgICAgIGlmIChwZWVyLmV4dGVuc2lvbnMuZ2V0KG5hbWUpID09PSBleHQpIHBlZXIuZXh0ZW5zaW9ucy5kZWxldGUobmFtZSkKICAgICAgICB9CiAgICAgICAgdGhpcy5zZXNzaW9uLmV4dGVuc2lvbnMuZGVsZXRlKG5hbWUpCiAgICAgIH0sCiAgICAgIF9vbm1lc3NhZ2Uoc3RhdGUsIHBlZXIpIHsKICAgICAgICBjb25zdCBtID0gdGhpcy5lbmNvZGluZy5kZWNvZGUoc3RhdGUpCiAgICAgICAgaWYgKHRoaXMuaGFuZGxlcnMub25tZXNzYWdlKSB0aGlzLmhhbmRsZXJzLm9ubWVzc2FnZShtLCBwZWVyKQogICAgICB9CiAgICB9CgogICAgdGhpcy5leHRlbnNpb25zLnNldChuYW1lLCBleHQpCgogICAgaWYgKHRoaXMuY29yZSA9PT0gbnVsbCkgdGhpcy5fbW9uaXRvckluZGV4ID0gLTIKICAgIGVsc2UgdGhpcy5jb3JlLmFkZE1vbml0b3IodGhpcykKCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgewogICAgICBwZWVyLmV4dGVuc2lvbnMuc2V0KG5hbWUsIGV4dCkKICAgIH0KCiAgICByZXR1cm4gZXh0CiAgfQoKICBfZW5jb2RlKGVuYywgdmFsKSB7CiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IHRoaXMucGFkZGluZywgZW5kOiB0aGlzLnBhZGRpbmcsIGJ1ZmZlcjogbnVsbCB9CgogICAgaWYgKGI0YS5pc0J1ZmZlcih2YWwpKSB7CiAgICAgIGlmIChzdGF0ZS5zdGFydCA9PT0gMCkgcmV0dXJuIHZhbAogICAgICBzdGF0ZS5lbmQgKz0gdmFsLmJ5dGVMZW5ndGgKICAgIH0gZWxzZSBpZiAoZW5jKSB7CiAgICAgIGVuYy5wcmVlbmNvZGUoc3RhdGUsIHZhbCkKICAgIH0gZWxzZSB7CiAgICAgIHZhbCA9IGI0YS5mcm9tKHZhbCkKICAgICAgaWYgKHN0YXRlLnN0YXJ0ID09PSAwKSByZXR1cm4gdmFsCiAgICAgIHN0YXRlLmVuZCArPSB2YWwuYnl0ZUxlbmd0aAogICAgfQoKICAgIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShzdGF0ZS5lbmQpCgogICAgaWYgKGVuYykgZW5jLmVuY29kZShzdGF0ZSwgdmFsKQogICAgZWxzZSBzdGF0ZS5idWZmZXIuc2V0KHZhbCwgc3RhdGUuc3RhcnQpCgogICAgcmV0dXJuIHN0YXRlLmJ1ZmZlcgogIH0KCiAgX2RlY29kZShlbmMsIGJsb2NrLCBpbmRleCkgewogICAgaWYgKHRoaXMuZW5jcnlwdGlvbikgYmxvY2sgPSBibG9jay5zdWJhcnJheSh0aGlzLmVuY3J5cHRpb24ucGFkZGluZyh0aGlzLmNvcmUsIGluZGV4KSkKICAgIHRyeSB7CiAgICAgIGlmIChlbmMpIHJldHVybiBjLmRlY29kZShlbmMsIGJsb2NrKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRocm93IERFQ09ESU5HX0VSUk9SKGVyci5tZXNzYWdlLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KICAgIHJldHVybiBibG9jawogIH0KCiAgX2dldEVuY3J5cHRpb25Qcm92aWRlcihlKSB7CiAgICBpZiAoaXNFbmNyeXB0aW9uUHJvdmlkZXIoZSkpIHJldHVybiBlCiAgICBpZiAoIWUgfHwgIWUua2V5KSByZXR1cm4gbnVsbAogICAgcmV0dXJuIG5ldyBEZWZhdWx0RW5jcnlwdGlvbihlLmtleSwgdGhpcy5rZXksIHsgYmxvY2s6IGUuYmxvY2ssIGNvbXBhdDogdGhpcy5jb3JlLmNvbXBhdCB9KQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBIeXBlcmNvcmUKCmZ1bmN0aW9uIGlzU3RyZWFtKHMpIHsKICByZXR1cm4gdHlwZW9mIHMgPT09ICdvYmplY3QnICYmIHMgJiYgdHlwZW9mIHMucGlwZSA9PT0gJ2Z1bmN0aW9uJwp9Cgphc3luYyBmdW5jdGlvbiBwcmVhcHBlbmQoYmxvY2tzKSB7CiAgY29uc3Qgb2Zmc2V0ID0gdGhpcy5zdGF0ZS5sZW5ndGgKICBjb25zdCBmb3JrID0gdGhpcy5zdGF0ZS5lbmNyeXB0aW9uRm9yawoKICBmb3IgKGxldCBpID0gMDsgaSA8IGJsb2Nrcy5sZW5ndGg7IGkrKykgewogICAgYXdhaXQgdGhpcy5lbmNyeXB0aW9uLmVuY3J5cHQob2Zmc2V0ICsgaSwgYmxvY2tzW2ldLCBmb3JrLCB0aGlzLmNvcmUpCiAgfQp9CgpmdW5jdGlvbiBpc1ZhbGlkSW5kZXgoaW5kZXgpIHsKICByZXR1cm4gaW5kZXggPT09IDAgfHwgaW5kZXggPiAwCn0KCmZ1bmN0aW9uIG1heWJlVW5zbGFiKGJsb2NrKSB7CiAgLy8gVW5zbGFiIG9ubHkgd2hlbiBpdCB0YWtlcyB1cCBsZXNzIHRoZW4gaGFsZiB0aGUgc2xhYgogIHJldHVybiBibG9jayAhPT0gbnVsbCAmJiAyICogYmxvY2suYnl0ZUxlbmd0aCA8IGJsb2NrLmJ1ZmZlci5ieXRlTGVuZ3RoID8gdW5zbGFiKGJsb2NrKSA6IGJsb2NrCn0KCmZ1bmN0aW9uIGNoZWNrU25hcHNob3Qoc25hcHNob3QsIGluZGV4KSB7CiAgaWYgKGluZGV4ID49IHNuYXBzaG90LnN0YXRlLnNuYXBzaG90Q29tcGF0TGVuZ3RoKSB7CiAgICB0aHJvdyBTTkFQU0hPVF9OT1RfQVZBSUxBQkxFKAogICAgICBgc25hcHNob3QgYXQgaW5kZXggJHtpbmRleH0gbm90IGF2YWlsYWJsZSAobWF4IGNvbXBhdCBsZW5ndGggJHtzbmFwc2hvdC5zdGF0ZS5zbmFwc2hvdENvbXBhdExlbmd0aH0pYCwKICAgICAgc25hcHNob3QuZGlzY292ZXJ5S2V5CiAgICApCiAgfQp9CgpmdW5jdGlvbiByZWFkQmxvY2socngsIGluZGV4KSB7CiAgY29uc3QgcHJvbWlzZSA9IHJ4LmdldEJsb2NrKGluZGV4KQogIHJ4LnRyeUZsdXNoKCkKICByZXR1cm4gcHJvbWlzZQp9CgpmdW5jdGlvbiBpbml0T25jZShzZXNzaW9uLCBzdG9yYWdlLCBrZXksIG9wdHMpIHsKICBpZiAoc3RvcmFnZSA9PT0gbnVsbCkgc3RvcmFnZSA9IG9wdHMuc3RvcmFnZSB8fCBudWxsCiAgaWYgKGtleSA9PT0gbnVsbCkga2V5ID0gb3B0cy5rZXkgfHwgbnVsbAoKICBzZXNzaW9uLmNvcmUgPSBuZXcgQ29yZShIeXBlcmNvcmUuZGVmYXVsdFN0b3JhZ2Uoc3RvcmFnZSksIHsKICAgIHByZW9wZW46IG9wdHMucHJlb3BlbiwKICAgIGVhZ2VyVXBncmFkZTogb3B0cy5lYWdlclVwZ3JhZGUgIT09IGZhbHNlLAogICAgbm90RG93bmxvYWRpbmdMaW5nZXI6IG9wdHMubm90RG93bmxvYWRpbmdMaW5nZXIsCiAgICBhbGxvd0Zvcms6IG9wdHMuYWxsb3dGb3JrICE9PSBmYWxzZSwKICAgIGFsbG93UHVzaDogISFvcHRzLmFsbG93UHVzaCwKICAgIGFsd2F5c0xhdGVzdEJsb2NrOiAhIW9wdHMuYWxsb3dMYXRlc3RCbG9jaywKICAgIGluZmxpZ2h0UmFuZ2U6IG9wdHMuaW5mbGlnaHRSYW5nZSwKICAgIGNvbXBhdDogb3B0cy5jb21wYXQgPT09IHRydWUsCiAgICBmb3JjZTogb3B0cy5mb3JjZSwKICAgIGNyZWF0ZUlmTWlzc2luZzogb3B0cy5jcmVhdGVJZk1pc3NpbmcsCiAgICBkaXNjb3ZlcnlLZXk6IG9wdHMuZGlzY292ZXJ5S2V5LAogICAgb3ZlcndyaXRlOiBvcHRzLm92ZXJ3cml0ZSwKICAgIGtleSwKICAgIGtleVBhaXI6IG9wdHMua2V5UGFpciwKICAgIGxlZ2FjeTogb3B0cy5sZWdhY3ksCiAgICBtYW5pZmVzdDogb3B0cy5tYW5pZmVzdCwKICAgIGdsb2JhbENhY2hlOiBvcHRzLmdsb2JhbENhY2hlIHx8IG51bGwgLy8gc2Vzc2lvbiBpcyBhIHRlbXAgb3B0aW9uLCBub3QgdG8gYmUgcmVsaWVkIG9uIHVubGVzcyB5b3Uga25vdyB3aGF0IHlvdSBhcmUgZG9pbmcgKG5vIHNlbXZlciBndWFyYW50ZWVzKQogIH0pCn0KCmZ1bmN0aW9uIG1heWJlQWRkTW9uaXRvcihuYW1lKSB7CiAgaWYgKG5hbWUgPT09ICdhcHBlbmQnIHx8IG5hbWUgPT09ICd0cnVuY2F0ZScpIHJldHVybgogIGlmICh0aGlzLl9tb25pdG9ySW5kZXggPj0gMCB8fCB0aGlzLmNsb3NpbmcpIHJldHVybgoKICBpZiAodGhpcy5jb3JlID09PSBudWxsKSB7CiAgICB0aGlzLl9tb25pdG9ySW5kZXggPSAtMgogIH0gZWxzZSB7CiAgICB0aGlzLmNvcmUuYWRkTW9uaXRvcih0aGlzKQogIH0KfQoKZnVuY3Rpb24gaXNTZXNzaW9uTW92ZWQoZXJyKSB7CiAgcmV0dXJuIGVyci5jb2RlID09PSAnU0VTU0lPTl9NT1ZFRCcKfQoKZnVuY3Rpb24gZ2V0RW5jcnlwdGlvbk9wdGlvbihvcHRzKSB7CiAgLy8gb2xkIHN0eWxlLCBzdXBwb3J0ZWQgZm9yIG5vdyBidXQgd2lsbCBnbyBhd2F5CiAgaWYgKG9wdHMuZW5jcnlwdGlvbktleSkgcmV0dXJuIHsga2V5OiBvcHRzLmVuY3J5cHRpb25LZXksIGJsb2NrOiAhIW9wdHMuaXNCbG9ja0tleSB9CiAgaWYgKCFvcHRzLmVuY3J5cHRpb24pIHJldHVybiBudWxsCiAgcmV0dXJuIGI0YS5pc0J1ZmZlcihvcHRzLmVuY3J5cHRpb24pID8geyBrZXk6IG9wdHMuZW5jcnlwdGlvbiB9IDogb3B0cy5lbmNyeXB0aW9uCn0KCmZ1bmN0aW9uIGlzRW5jcnlwdGlvblByb3ZpZGVyKGUpIHsKICByZXR1cm4gZSAmJiBpc0Z1bmN0aW9uKGUucGFkZGluZykgJiYgaXNGdW5jdGlvbihlLmVuY3J5cHQpICYmIGlzRnVuY3Rpb24oZS5kZWNyeXB0KQp9CgpmdW5jdGlvbiBpc0Z1bmN0aW9uKGZuKSB7CiAgcmV0dXJuICEhZm4gJiYgdHlwZW9mIGZuID09PSAnZnVuY3Rpb24nCn0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IGZsYXQgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCB7IE1lcmtsZVRyZWUgfSA9IHJlcXVpcmUoJy4vbWVya2xlLXRyZWUnKQoKbW9kdWxlLmV4cG9ydHMgPSBhc3luYyBmdW5jdGlvbiBhdWRpdENvcmUoCiAgY29yZSwKICB7IHRyZWUgPSB0cnVlLCBibG9ja3MgPSB0cnVlLCBiaXRmaWVsZCA9IHRydWUsIGRyeVJ1biA9IGZhbHNlIH0gPSB7fQopIHsKICBjb25zdCBsZW5ndGggPSBjb3JlLnN0YXRlLmxlbmd0aAogIGNvbnN0IHN0YXRzID0gewogICAgdHJlZU5vZGVzOiAwLAogICAgYmxvY2tzOiAwLAogICAgYml0czogMCwKICAgIGRyb3BwZWRUcmVlTm9kZXM6IDAsCiAgICBkcm9wcGVkQmxvY2tzOiAwLAogICAgZHJvcHBlZEJpdHM6IDAsCiAgICBjb3JydXB0OiBmYWxzZQogIH0KCiAgLy8gYXVkaXQgdGhlIHRyZWUKICBpZiAodHJlZSkgewogICAgbGV0IHR4ID0gbnVsbAoKICAgIGNvbnN0IHJvb3RzID0gYXdhaXQgTWVya2xlVHJlZS5nZXRSb290c0Zyb21TdG9yYWdlKGNvcmUuc3RhdGUuc3RvcmFnZSwgbGVuZ3RoKQogICAgY29uc3Qgc3RhY2sgPSBbXQoKICAgIGZvciAoY29uc3QgciBvZiByb290cykgewogICAgICBpZiAociA9PT0gbnVsbCkgewogICAgICAgIGlmICghZHJ5UnVuKSB7CiAgICAgICAgICBjb25zdCBzdG9yYWdlID0gY29yZS5zdGF0ZS5zdG9yYWdlCiAgICAgICAgICBhd2FpdCBzdG9yYWdlLnN0b3JlLmRlbGV0ZUNvcmUoc3RvcmFnZS5jb3JlKQogICAgICAgICAgcmV0dXJuIG51bGwKICAgICAgICB9CgogICAgICAgIHN0YXRzLmNvcnJ1cHQgPSB0cnVlCiAgICAgIH0KCiAgICAgIHN0YWNrLnB1c2gocikKICAgIH0KCiAgICBzdGF0cy50cmVlTm9kZXMgKz0gcm9vdHMubGVuZ3RoCgogICAgd2hpbGUgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3Qgbm9kZSA9IHN0YWNrLnBvcCgpCgogICAgICBpZiAoKG5vZGUuaW5kZXggJiAxKSA9PT0gMCkgY29udGludWUKCiAgICAgIGNvbnN0IFtsZWZ0LCByaWdodF0gPSBmbGF0LmNoaWxkcmVuKG5vZGUuaW5kZXgpCgogICAgICBjb25zdCByeCA9IGNvcmUuc3RhdGUuc3RvcmFnZS5yZWFkKCkKICAgICAgY29uc3QgbGVmdE5vZGVQcm9taXNlID0gcnguZ2V0VHJlZU5vZGUobGVmdCkKICAgICAgY29uc3QgcmlnaHROb2RlUHJvbWlzZSA9IHJ4LmdldFRyZWVOb2RlKHJpZ2h0KQoKICAgICAgcngudHJ5Rmx1c2goKQoKICAgICAgY29uc3QgW2xlZnROb2RlLCByaWdodE5vZGVdID0gYXdhaXQgUHJvbWlzZS5hbGwoW2xlZnROb2RlUHJvbWlzZSwgcmlnaHROb2RlUHJvbWlzZV0pCgogICAgICBpZiAoaXNCYWRUcmVlKG5vZGUsIGxlZnROb2RlLCByaWdodE5vZGUpKSB7CiAgICAgICAgaWYgKCF0eCAmJiAhc3RhdHMuY29ycnVwdCkgdHggPSBjb3JlLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQogICAgICAgIGNvbnN0IFtsLCByXSA9IGZsYXQuc3BhbnMobm9kZS5pbmRleCkKICAgICAgICB0eC5kZWxldGVUcmVlTm9kZVJhbmdlKGwsIHIgKyAxKQogICAgICAgIHN0YXRzLmRyb3BwZWRUcmVlTm9kZXMrKwogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGlmICghbGVmdE5vZGUpIGNvbnRpbnVlCgogICAgICBzdGF0cy50cmVlTm9kZXMgKz0gMgogICAgICBzdGFjay5wdXNoKGxlZnROb2RlLCByaWdodE5vZGUpCiAgICB9CgogICAgaWYgKHR4ICYmICFkcnlSdW4pIGF3YWl0IHR4LmZsdXNoKCkKICB9CgogIC8vIGF1ZGl0IHRoZSBibG9ja3MKICBpZiAoYmxvY2tzKSB7CiAgICBsZXQgdHggPSBudWxsCgogICAgZm9yIGF3YWl0IChjb25zdCBibG9jayBvZiBjb3JlLnN0YXRlLnN0b3JhZ2UuY3JlYXRlQmxvY2tTdHJlYW0oKSkgewogICAgICBpZiAoIWNvcmUuYml0ZmllbGQuZ2V0KGJsb2NrLmluZGV4KSkgewogICAgICAgIGlmICghdHggJiYgIXN0YXRzLmNvcnJ1cHQpIHR4ID0gY29yZS5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKICAgICAgICB0eC5kZWxldGVCbG9jayhibG9jay5pbmRleCkKICAgICAgICBzdGF0cy5kcm9wcGVkQmxvY2tzKysKICAgICAgfQoKICAgICAgY29uc3QgcnggPSBjb3JlLnN0YXRlLnN0b3JhZ2UucmVhZCgpCiAgICAgIGNvbnN0IHRyZWVOb2RlUHJvbWlzZSA9IHJ4LmdldFRyZWVOb2RlKDIgKiBibG9jay5pbmRleCkKCiAgICAgIHJ4LnRyeUZsdXNoKCkKCiAgICAgIGNvbnN0IHRyZWVOb2RlID0gYXdhaXQgdHJlZU5vZGVQcm9taXNlCgogICAgICBpZiAoaXNCYWRCbG9jayh0cmVlTm9kZSwgYmxvY2sudmFsdWUpKSB7CiAgICAgICAgaWYgKCF0eCAmJiAhc3RhdHMuY29ycnVwdCkgdHggPSBjb3JlLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQogICAgICAgIHR4LmRlbGV0ZUJsb2NrKGJsb2NrLmluZGV4KQogICAgICAgIHN0YXRzLmRyb3BwZWRCbG9ja3MrKwogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIHN0YXRzLmJsb2NrcysrCiAgICB9CgogICAgaWYgKHR4ICYmICFkcnlSdW4pIGF3YWl0IHR4LmZsdXNoKCkKICB9CgogIGlmIChiaXRmaWVsZCkgewogICAgbGV0IHR4ID0gbnVsbAoKICAgIGZvciAoY29uc3QgaW5kZXggb2YgYWxsQml0cyhjb3JlLmJpdGZpZWxkKSkgewogICAgICBjb25zdCByeCA9IGNvcmUuc3RhdGUuc3RvcmFnZS5yZWFkKCkKICAgICAgY29uc3QgYmxvY2tQcm9taXNlID0gcnguZ2V0QmxvY2soaW5kZXgpCgogICAgICByeC50cnlGbHVzaCgpCgogICAgICBjb25zdCBibG9jayA9IGF3YWl0IGJsb2NrUHJvbWlzZQogICAgICBpZiAoIWJsb2NrKSB7CiAgICAgICAgc3RhdHMuZHJvcHBlZEJpdHMrKwogICAgICAgIGlmIChkcnlSdW4pIGNvbnRpbnVlCgogICAgICAgIGlmICghdHggJiYgIXN0YXRzLmNvcnJ1cHQpIHR4ID0gY29yZS5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKCiAgICAgICAgY29yZS5iaXRmaWVsZC5zZXQoaW5kZXgsIGZhbHNlKQoKICAgICAgICBjb25zdCBwYWdlID0gY29yZS5iaXRmaWVsZC5nZXRCaXRmaWVsZChpbmRleCkKICAgICAgICBpZiAocGFnZS5iaXRmaWVsZCkgdHgucHV0Qml0ZmllbGRQYWdlKHBhZ2UuaW5kZXgsIHBhZ2UuYml0ZmllbGQpCiAgICAgICAgZWxzZSB0eC5kZWxldGVCaXRmaWVsZFBhZ2UocGFnZS5pbmRleCkKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBzdGF0cy5iaXRzKysKICAgIH0KCiAgICBpZiAodHggJiYgIWRyeVJ1bikgYXdhaXQgdHguZmx1c2goKQogIH0KCiAgcmV0dXJuIHN0YXRzCn0KCmZ1bmN0aW9uIGlzQmFkQmxvY2sobm9kZSwgYmxvY2spIHsKICBpZiAoIW5vZGUpIHJldHVybiB0cnVlCiAgY29uc3QgaGFzaCA9IGNyeXB0by5kYXRhKGJsb2NrKQogIHJldHVybiAhYjRhLmVxdWFscyhoYXNoLCBub2RlLmhhc2gpIHx8IG5vZGUuc2l6ZSAhPT0gYmxvY2suYnl0ZUxlbmd0aAp9CgpmdW5jdGlvbiBpc0JhZFRyZWUocGFyZW50LCBsZWZ0LCByaWdodCkgewogIGlmICghbGVmdCAmJiAhcmlnaHQpIHJldHVybiBmYWxzZQogIGlmICghbGVmdCB8fCAhcmlnaHQpIHJldHVybiB0cnVlCiAgY29uc3QgaGFzaCA9IGNyeXB0by5wYXJlbnQobGVmdCwgcmlnaHQpCiAgcmV0dXJuICFiNGEuZXF1YWxzKGhhc2gsIHBhcmVudC5oYXNoKSB8fCBwYXJlbnQuc2l6ZSAhPT0gbGVmdC5zaXplICsgcmlnaHQuc2l6ZQp9CgpmdW5jdGlvbiogYWxsQml0cyhiaXRmaWVsZCkgewogIGxldCBpID0gMAogIGlmIChiaXRmaWVsZC5nZXQoMCkpIHlpZWxkIDAKICB3aGlsZSAodHJ1ZSkgewogICAgaSA9IGJpdGZpZWxkLmZpbmRGaXJzdCh0cnVlLCBpICsgMSkKICAgIGlmIChpID09PSAtMSkgYnJlYWsKICAgIHlpZWxkIGkKICB9Cn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgcXVpY2tiaXQgPSByZXF1aXJlKCcuL2NvbXBhdCcpLnF1aWNrYml0Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEJpdEludGVybHVkZSB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLnJhbmdlcyA9IFtdCiAgfQoKICBjb250aWd1b3VzTGVuZ3RoKGZyb20pIHsKICAgIGZvciAoY29uc3QgciBvZiB0aGlzLnJhbmdlcykgewogICAgICBpZiAoci5zdGFydCA+IGZyb20pIGJyZWFrCiAgICAgIGlmICghci52YWx1ZSAmJiByLnN0YXJ0IDw9IGZyb20pIHJldHVybiByLnN0YXJ0CiAgICB9CgogICAgLy8gVE9ETzogYmUgc21hcnRlcgogICAgd2hpbGUgKHRoaXMuZ2V0KGZyb20pID09PSB0cnVlKSBmcm9tKysKICAgIHJldHVybiBmcm9tCiAgfQoKICBnZXQoaW5kZXgpIHsKICAgIGxldCBzdGFydCA9IDAKICAgIGxldCBlbmQgPSB0aGlzLnJhbmdlcy5sZW5ndGgKCiAgICB3aGlsZSAoc3RhcnQgPCBlbmQpIHsKICAgICAgY29uc3QgbWlkID0gKHN0YXJ0ICsgZW5kKSA+PiAxCiAgICAgIGNvbnN0IHIgPSB0aGlzLnJhbmdlc1ttaWRdCgogICAgICBpZiAoaW5kZXggPCByLnN0YXJ0KSB7CiAgICAgICAgZW5kID0gbWlkCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgaWYgKGluZGV4ID49IHIuZW5kKSB7CiAgICAgICAgaWYgKG1pZCA9PT0gc3RhcnQpIGJyZWFrCiAgICAgICAgc3RhcnQgPSBtaWQKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICByZXR1cm4gci52YWx1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgc2V0UmFuZ2Uoc3RhcnQsIGVuZCwgdmFsdWUpIHsKICAgIGlmIChzdGFydCA9PT0gZW5kKSByZXR1cm4KCiAgICBsZXQgciA9IG51bGwKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucmFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHIgPSB0aGlzLnJhbmdlc1tpXQoKICAgICAgLy8gaWYgYWxyZWFkeSBpbnNpZGUsIHN0b3AKICAgICAgaWYgKHIuc3RhcnQgPD0gc3RhcnQgJiYgZW5kIDw9IHIuZW5kKSB7CiAgICAgICAgaWYgKHZhbHVlID09PSByLnZhbHVlKSByZXR1cm4KCiAgICAgICAgY29uc3QgcmFuZ2VzID0gbWVyZ2VSYW5nZXMociwgeyBzdGFydCwgZW5kLCB2YWx1ZSB9KQogICAgICAgIHRoaXMucmFuZ2VzLnNwbGljZShpLCAxLCAuLi5yYW5nZXMpCgogICAgICAgIHJldHVybgogICAgICB9CgogICAgICAvLyB3ZSB3YW5uYSBvdmVydW4gdGhlIGludGVydmFsCiAgICAgIGlmIChzdGFydCA+IHIuZW5kKSB7CiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgLy8gd2Ugb3ZlcnJhbiBidXQgdGhpcyBpbnRlcnZhbCBpcyBlbmRpbmcgYWZ0ZXIgdXMsIG1vdmUgaXQgYmFjawogICAgICBpZiAoZW5kID49IHIuc3RhcnQgJiYgZW5kIDw9IHIuZW5kKSB7CiAgICAgICAgci5zdGFydCA9IHIudmFsdWUgPT09IHZhbHVlID8gc3RhcnQgOiBlbmQKICAgICAgICBpZiAoci52YWx1ZSAhPT0gdmFsdWUpIHRoaXMucmFuZ2VzLnNwbGljZShpLCAwLCB7IHN0YXJ0LCBlbmQsIHZhbHVlIH0pCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIC8vIHdlIG92ZXJyYW4gYnV0IG91ciBzdGFydCBpcyBjb250YWluZWQgaW4gdGhpcyBpbnRlcnZhbCwgbW92ZSBzdGFydCBiYWNrCiAgICAgIGlmIChzdGFydCA+PSByLnN0YXJ0ICYmIHN0YXJ0IDw9IHIuZW5kKSB7CiAgICAgICAgaWYgKHIudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICByLmVuZCA9IHN0YXJ0IC8vIENyb3AgY3VycmVudCBjb21wYXJpc29uCgogICAgICAgICAgLy8gSWYgdGhlcmUncyBhIG5leHQgcmFuZ2UKICAgICAgICAgIGlmICh0aGlzLnJhbmdlcy5sZW5ndGggLSAxID4gaSkgewogICAgICAgICAgICBjb25zdCBuZXh0ID0gdGhpcy5yYW5nZXNbaSArIDFdCiAgICAgICAgICAgIC8vIElmIHRoZSBzYW1lLCBnbyBuZXh0CiAgICAgICAgICAgIGlmIChuZXh0LnZhbHVlID09PSB2YWx1ZSkgY29udGludWUKICAgICAgICAgICAgLy8gRWxzZSB3ZSBvdmVybGFwIHNvIHVwZGF0ZSBuZXh0IHJhbmdlCiAgICAgICAgICAgIGlmIChuZXh0LnN0YXJ0IDwgZW5kKSBuZXh0LnN0YXJ0ID0gZW5kCiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5yYW5nZXMuc3BsaWNlKCsraSwgMCwgeyBzdGFydCwgZW5kLCB2YWx1ZSB9KQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQoKICAgICAgICBzdGFydCA9IHIuc3RhcnQKICAgICAgfQoKICAgICAgbGV0IHJlbW92ZSA9IDAKCiAgICAgIGZvciAobGV0IGogPSBpOyBqIDwgdGhpcy5yYW5nZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICBjb25zdCBuID0gdGhpcy5yYW5nZXNbal0KICAgICAgICBpZiAobi5zdGFydCA+IGVuZCB8fCBuLnZhbHVlICE9PSB2YWx1ZSkgYnJlYWsKICAgICAgICBpZiAobi5zdGFydCA8PSBlbmQgJiYgbi5lbmQgPiBlbmQpIGVuZCA9IG4uZW5kCiAgICAgICAgcmVtb3ZlKysKICAgICAgfQoKICAgICAgdGhpcy5yYW5nZXMuc3BsaWNlKGksIHJlbW92ZSwgeyBzdGFydCwgZW5kLCB2YWx1ZSB9KQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAociAhPT0gbnVsbCkgewogICAgICBpZiAoc3RhcnQgPD0gci5lbmQgJiYgZW5kID4gci5lbmQpIHsKICAgICAgICByLmVuZCA9IGVuZAogICAgICAgIHJldHVybgogICAgICB9CgogICAgICAvLyB3ZSBuZXZlcgogICAgICBpZiAoci5lbmQgPiBzdGFydCkgcmV0dXJuCiAgICB9CgogICAgdGhpcy5yYW5nZXMucHVzaCh7IHN0YXJ0LCBlbmQsIHZhbHVlIH0pCiAgfQoKICBmbHVzaCh0eCwgYml0ZmllbGQpIHsKICAgIGlmICghdGhpcy5yYW5nZXMubGVuZ3RoKSByZXR1cm4gW10KCiAgICBsZXQgaW5kZXggPSB0aGlzLnJhbmdlc1swXS5zdGFydAogICAgY29uc3QgZmluYWwgPSB0aGlzLnJhbmdlc1t0aGlzLnJhbmdlcy5sZW5ndGggLSAxXS5lbmQKCiAgICBsZXQgaSA9IDAKCiAgICB3aGlsZSAoaW5kZXggPCBmaW5hbCkgewogICAgICBjb25zdCBwYWdlID0gYml0ZmllbGQuZ2V0Qml0ZmllbGQoaW5kZXgpIC8vIHJlYWQgb25seQogICAgICBjb25zdCBwYWdlSW5kZXggPSBwYWdlID8gcGFnZS5pbmRleCA6IGJpdGZpZWxkLmdldFBhZ2VJbmRleChpbmRleCkKCiAgICAgIGNvbnN0IGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShiaXRmaWVsZC5nZXRQYWdlQnl0ZUxlbmd0aCgpKQoKICAgICAgaWYgKHBhZ2UpIHsKICAgICAgICBjb25zdCBzcmMgPSBwYWdlLmJpdGZpZWxkIC8vIFVpbnQzMkFycmF5CiAgICAgICAgYnVmLnNldChiNGEuZnJvbShzcmMuYnVmZmVyLCBzcmMuYnl0ZU9mZnNldCwgc3JjLmJ5dGVMZW5ndGgpLCAwKQogICAgICB9IGVsc2UgewogICAgICAgIGI0YS5maWxsKGJ1ZiwgMCkKICAgICAgfQoKICAgICAgY29uc3QgbGFzdCA9IChwYWdlSW5kZXggKyAxKSAqIChidWYuYnl0ZUxlbmd0aCA8PCAzKQogICAgICBjb25zdCBvZmZzZXQgPSBwYWdlSW5kZXggKiAoYnVmLmJ5dGVMZW5ndGggPDwgMykKCiAgICAgIGxldCBoYXNWYWx1ZSA9IGZhbHNlCgogICAgICB3aGlsZSAoaSA8IHRoaXMucmFuZ2VzLmxlbmd0aCkgewogICAgICAgIGNvbnN0IHsgc3RhcnQsIGVuZCwgdmFsdWUgfSA9IHRoaXMucmFuZ2VzW2ldCgogICAgICAgIGlmICghaGFzVmFsdWUgJiYgdmFsdWUpIGhhc1ZhbHVlID0gdHJ1ZQoKICAgICAgICBjb25zdCBmcm9tID0gc3RhcnQgPCBpbmRleCA/IGluZGV4IDogc3RhcnQKICAgICAgICBjb25zdCB0byA9IGVuZCA8IGxhc3QgPyBlbmQgOiBsYXN0CgogICAgICAgIHF1aWNrYml0LmZpbGwoYnVmLCB2YWx1ZSwgZnJvbSAtIG9mZnNldCwgdG8gLSBvZmZzZXQpCgogICAgICAgIGluZGV4ID0gdG8KCiAgICAgICAgaWYgKHRvID09PSBsYXN0KSBicmVhawoKICAgICAgICBpKysKICAgICAgfQoKICAgICAgaWYgKHBhZ2UgfHwgaGFzVmFsdWUpIHR4LnB1dEJpdGZpZWxkUGFnZShwYWdlSW5kZXgsIGJ1ZikKICAgIH0KCiAgICByZXR1cm4gdGhpcy5yYW5nZXMKICB9Cn0KCmZ1bmN0aW9uIG1lcmdlUmFuZ2VzKGEsIGIpIHsKICBjb25zdCByYW5nZXMgPSBbXQogIGlmIChhLnN0YXJ0IDwgYi5zdGFydCkgcmFuZ2VzLnB1c2goeyBzdGFydDogYS5zdGFydCwgZW5kOiBiLnN0YXJ0LCB2YWx1ZTogYS52YWx1ZSB9KQogIHJhbmdlcy5wdXNoKHsgc3RhcnQ6IGIuc3RhcnQsIGVuZDogYi5lbmQsIHZhbHVlOiBiLnZhbHVlIH0pCiAgaWYgKGIuZW5kIDwgYS5lbmQpIHJhbmdlcy5wdXNoKHsgc3RhcnQ6IGIuZW5kLCBlbmQ6IGEuZW5kLCB2YWx1ZTogYS52YWx1ZSB9KQoKICByZXR1cm4gcmFuZ2VzCn0KY29uc3QgQmlnU3BhcnNlQXJyYXkgPSByZXF1aXJlKCdiaWctc3BhcnNlLWFycmF5JykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgcXVpY2tiaXQgPSByZXF1aXJlKCcuL2NvbXBhdCcpLnF1aWNrYml0Cgpjb25zdCBCSVRTX1BFUl9QQUdFID0gMzI3NjgKY29uc3QgQllURVNfUEVSX1BBR0UgPSBCSVRTX1BFUl9QQUdFIC8gOApjb25zdCBXT1JEU19QRVJfUEFHRSA9IEJZVEVTX1BFUl9QQUdFIC8gNApjb25zdCBCSVRTX1BFUl9TRUdNRU5UID0gMjA5NzE1Mgpjb25zdCBCWVRFU19QRVJfU0VHTUVOVCA9IEJJVFNfUEVSX1NFR01FTlQgLyA4CmNvbnN0IFdPUkRTX1BFUl9TRUdNRU5UID0gQllURVNfUEVSX1NFR01FTlQgLyA0CmNvbnN0IElOSVRJQUxfV09SRFNfUEVSX1NFR01FTlQgPSAxMDI0CmNvbnN0IFBBR0VTX1BFUl9TRUdNRU5UID0gQklUU19QRVJfU0VHTUVOVCAvIEJJVFNfUEVSX1BBR0UKY29uc3QgU0VHTUVOVF9HUk9XVEhfRkFDVE9SID0gNAoKY2xhc3MgQml0ZmllbGRQYWdlIHsKICBjb25zdHJ1Y3RvcihpbmRleCwgc2VnbWVudCkgewogICAgdGhpcy5pbmRleCA9IGluZGV4CiAgICB0aGlzLm9mZnNldCA9IGluZGV4ICogQllURVNfUEVSX1BBR0UgLSBzZWdtZW50Lm9mZnNldAogICAgdGhpcy5iaXRmaWVsZCA9IG51bGwKICAgIHRoaXMuc2VnbWVudCA9IHNlZ21lbnQKCiAgICBzZWdtZW50LmFkZCh0aGlzKQogIH0KCiAgZ2V0IHRyZWUoKSB7CiAgICByZXR1cm4gdGhpcy5zZWdtZW50LnRyZWUKICB9CgogIGdldChpbmRleCwgZGlydHkpIHsKICAgIHJldHVybiBxdWlja2JpdC5nZXQodGhpcy5iaXRmaWVsZCwgaW5kZXgpCiAgfQoKICBzZXQoaW5kZXgsIHZhbCkgewogICAgaWYgKHF1aWNrYml0LnNldCh0aGlzLmJpdGZpZWxkLCBpbmRleCwgdmFsKSkgewogICAgICB0aGlzLnRyZWUudXBkYXRlKHRoaXMub2Zmc2V0ICogOCArIGluZGV4KQogICAgfQogIH0KCiAgc2V0UmFuZ2Uoc3RhcnQsIGVuZCwgdmFsKSB7CiAgICBxdWlja2JpdC5maWxsKHRoaXMuYml0ZmllbGQsIHZhbCwgc3RhcnQsIGVuZCkKCiAgICBsZXQgaSA9IE1hdGguZmxvb3Ioc3RhcnQgLyAxMjgpCiAgICBjb25zdCBuID0gaSArIE1hdGguY2VpbCgoZW5kIC0gc3RhcnQpIC8gMTI4KQoKICAgIHdoaWxlIChpIDw9IG4pIHRoaXMudHJlZS51cGRhdGUodGhpcy5vZmZzZXQgKiA4ICsgaSsrICogMTI4KQogIH0KCiAgZmluZEZpcnN0KHZhbCwgcG9zaXRpb24pIHsKICAgIHJldHVybiBxdWlja2JpdC5maW5kRmlyc3QodGhpcy5iaXRmaWVsZCwgdmFsLCBwb3NpdGlvbikKICB9CgogIGZpbmRMYXN0KHZhbCwgcG9zaXRpb24pIHsKICAgIHJldHVybiBxdWlja2JpdC5maW5kTGFzdCh0aGlzLmJpdGZpZWxkLCB2YWwsIHBvc2l0aW9uKQogIH0KCiAgY291bnQoc3RhcnQsIGxlbmd0aCwgdmFsKSB7CiAgICBjb25zdCBlbmQgPSBzdGFydCArIGxlbmd0aAoKICAgIGxldCBpID0gc3RhcnQKICAgIGxldCBjID0gMAoKICAgIHdoaWxlIChsZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IGwgPSB0aGlzLmZpbmRGaXJzdCh2YWwsIGkpCiAgICAgIGlmIChsID09PSAtMSB8fCBsID49IGVuZCkgcmV0dXJuIGMKCiAgICAgIGNvbnN0IGggPSB0aGlzLmZpbmRGaXJzdCghdmFsLCBsICsgMSkKICAgICAgaWYgKGggPT09IC0xIHx8IGggPj0gZW5kKSByZXR1cm4gYyArIGVuZCAtIGwKCiAgICAgIGMgKz0gaCAtIGwKICAgICAgbGVuZ3RoIC09IGggLSBpCiAgICAgIGkgPSBoCiAgICB9CgogICAgcmV0dXJuIGMKICB9Cn0KCmNsYXNzIEJpdGZpZWxkU2VnbWVudCB7CiAgY29uc3RydWN0b3IoaW5kZXgsIGJpdGZpZWxkKSB7CiAgICB0aGlzLmluZGV4ID0gaW5kZXgKICAgIHRoaXMub2Zmc2V0ID0gaW5kZXggKiBCWVRFU19QRVJfU0VHTUVOVAogICAgdGhpcy50cmVlID0gcXVpY2tiaXQuSW5kZXguZnJvbShiaXRmaWVsZCwgQllURVNfUEVSX1NFR01FTlQpCiAgICB0aGlzLnBhZ2VzID0gbmV3IEFycmF5KFBBR0VTX1BFUl9TRUdNRU5UKQogIH0KCiAgZ2V0IGJpdGZpZWxkKCkgewogICAgcmV0dXJuIHRoaXMudHJlZS5maWVsZAogIH0KCiAgYWRkKHBhZ2UpIHsKICAgIGNvbnN0IGkgPSBwYWdlLmluZGV4IC0gdGhpcy5pbmRleCAqIFBBR0VTX1BFUl9TRUdNRU5UCiAgICB0aGlzLnBhZ2VzW2ldID0gcGFnZQoKICAgIGNvbnN0IHN0YXJ0ID0gaSAqIFdPUkRTX1BFUl9QQUdFCiAgICBjb25zdCBlbmQgPSBzdGFydCArIFdPUkRTX1BFUl9QQUdFCgogICAgaWYgKGVuZCA+PSB0aGlzLmJpdGZpZWxkLmxlbmd0aCkgdGhpcy5yZWFsbG9jYXRlKGVuZCkKCiAgICBwYWdlLmJpdGZpZWxkID0gdGhpcy5iaXRmaWVsZC5zdWJhcnJheShzdGFydCwgZW5kKQogIH0KCiAgcmVhbGxvY2F0ZShsZW5ndGgpIHsKICAgIGxldCB0YXJnZXQgPSB0aGlzLmJpdGZpZWxkLmxlbmd0aAogICAgd2hpbGUgKHRhcmdldCA8IGxlbmd0aCkgdGFyZ2V0ICo9IFNFR01FTlRfR1JPV1RIX0ZBQ1RPUgoKICAgIGNvbnN0IGJpdGZpZWxkID0gbmV3IFVpbnQzMkFycmF5KHRhcmdldCkKICAgIGJpdGZpZWxkLnNldCh0aGlzLmJpdGZpZWxkKQoKICAgIHRoaXMudHJlZSA9IHF1aWNrYml0LkluZGV4LmZyb20oYml0ZmllbGQsIEJZVEVTX1BFUl9TRUdNRU5UKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5wYWdlcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBwYWdlID0gdGhpcy5wYWdlc1tpXQogICAgICBpZiAoIXBhZ2UpIGNvbnRpbnVlCgogICAgICBjb25zdCBzdGFydCA9IGkgKiBXT1JEU19QRVJfUEFHRQogICAgICBjb25zdCBlbmQgPSBzdGFydCArIFdPUkRTX1BFUl9QQUdFCgogICAgICBwYWdlLmJpdGZpZWxkID0gYml0ZmllbGQuc3ViYXJyYXkoc3RhcnQsIGVuZCkKICAgIH0KICB9CgogIGZpbmRGaXJzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICBwb3NpdGlvbiA9IHRoaXMudHJlZS5za2lwRmlyc3QoIXZhbCwgcG9zaXRpb24pCgogICAgbGV0IGogPSBwb3NpdGlvbiAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGxldCBpID0gKHBvc2l0aW9uIC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgaWYgKGkgPj0gUEFHRVNfUEVSX1NFR01FTlQpIHJldHVybiAtMQoKICAgIHdoaWxlIChpIDwgdGhpcy5wYWdlcy5sZW5ndGgpIHsKICAgICAgY29uc3QgcCA9IHRoaXMucGFnZXNbaV0KCiAgICAgIGxldCBpbmRleCA9IC0xCgogICAgICBpZiAocCkgaW5kZXggPSBwLmZpbmRGaXJzdCh2YWwsIGopCiAgICAgIGVsc2UgaWYgKCF2YWwpIGluZGV4ID0gagoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIGkgKiBCSVRTX1BFUl9QQUdFICsgaW5kZXgKCiAgICAgIGogPSAwCiAgICAgIGkrKwogICAgfQoKICAgIHJldHVybiAtMQogIH0KCiAgZmluZExhc3QodmFsLCBwb3NpdGlvbikgewogICAgcG9zaXRpb24gPSB0aGlzLnRyZWUuc2tpcExhc3QoIXZhbCwgcG9zaXRpb24pCgogICAgbGV0IGogPSBwb3NpdGlvbiAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGxldCBpID0gKHBvc2l0aW9uIC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgaWYgKGkgPj0gUEFHRVNfUEVSX1NFR01FTlQpIHJldHVybiAtMQoKICAgIHdoaWxlIChpID49IDApIHsKICAgICAgY29uc3QgcCA9IHRoaXMucGFnZXNbaV0KCiAgICAgIGxldCBpbmRleCA9IC0xCgogICAgICBpZiAocCkgaW5kZXggPSBwLmZpbmRMYXN0KHZhbCwgaikKICAgICAgZWxzZSBpZiAoIXZhbCkgaW5kZXggPSBqCgogICAgICBpZiAoaW5kZXggIT09IC0xKSByZXR1cm4gaSAqIEJJVFNfUEVSX1BBR0UgKyBpbmRleAoKICAgICAgaiA9IEJJVFNfUEVSX1BBR0UgLSAxCiAgICAgIGktLQogICAgfQoKICAgIHJldHVybiAtMQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBCaXRmaWVsZCB7CiAgc3RhdGljIEJJVFNfUEVSX1BBR0UgPSBCSVRTX1BFUl9QQUdFCiAgc3RhdGljIEJZVEVTX1BFUl9QQUdFID0gQllURVNfUEVSX1BBR0UKCiAgY29uc3RydWN0b3IoYnVmZmVyKSB7CiAgICB0aGlzLnJlc3VtZWQgPSAhIShidWZmZXIgJiYgYnVmZmVyLmJ5dGVMZW5ndGggPj0gMCkKCiAgICB0aGlzLl9wYWdlcyA9IG5ldyBCaWdTcGFyc2VBcnJheSgpCiAgICB0aGlzLl9zZWdtZW50cyA9IG5ldyBCaWdTcGFyc2VBcnJheSgpCgogICAgY29uc3QgdmlldyA9IHRoaXMucmVzdW1lZAogICAgICA/IG5ldyBVaW50MzJBcnJheShidWZmZXIuYnVmZmVyLCBidWZmZXIuYnl0ZU9mZnNldCwgTWF0aC5mbG9vcihidWZmZXIuYnl0ZUxlbmd0aCAvIDQpKQogICAgICA6IG5ldyBVaW50MzJBcnJheShJTklUSUFMX1dPUkRTX1BFUl9TRUdNRU5UKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmlldy5sZW5ndGg7IGkgKz0gV09SRFNfUEVSX1NFR01FTlQpIHsKICAgICAgbGV0IGJpdGZpZWxkID0gdmlldy5zdWJhcnJheShpLCBpICsgV09SRFNfUEVSX1NFR01FTlQpCiAgICAgIGxldCBsZW5ndGggPSBXT1JEU19QRVJfU0VHTUVOVAoKICAgICAgaWYgKGkgPT09IDApIHsKICAgICAgICBsZW5ndGggPSBJTklUSUFMX1dPUkRTX1BFUl9TRUdNRU5UCiAgICAgICAgd2hpbGUgKGxlbmd0aCA8IGJpdGZpZWxkLmxlbmd0aCkgbGVuZ3RoICo9IFNFR01FTlRfR1JPV1RIX0ZBQ1RPUgogICAgICB9CgogICAgICBpZiAoYml0ZmllbGQubGVuZ3RoICE9PSBsZW5ndGgpIHsKICAgICAgICBjb25zdCBjb3B5ID0gbmV3IFVpbnQzMkFycmF5KGxlbmd0aCkKICAgICAgICBjb3B5LnNldChiaXRmaWVsZCwgMCkKICAgICAgICBiaXRmaWVsZCA9IGNvcHkKICAgICAgfQoKICAgICAgY29uc3Qgc2VnbWVudCA9IG5ldyBCaXRmaWVsZFNlZ21lbnQoaSAvIFdPUkRTX1BFUl9TRUdNRU5ULCBiaXRmaWVsZCkKICAgICAgdGhpcy5fc2VnbWVudHMuc2V0KHNlZ21lbnQuaW5kZXgsIHNlZ21lbnQpCgogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGJpdGZpZWxkLmxlbmd0aDsgaiArPSBXT1JEU19QRVJfUEFHRSkgewogICAgICAgIGNvbnN0IHBhZ2UgPSBuZXcgQml0ZmllbGRQYWdlKChpICsgaikgLyBXT1JEU19QRVJfUEFHRSwgc2VnbWVudCkKICAgICAgICB0aGlzLl9wYWdlcy5zZXQocGFnZS5pbmRleCwgcGFnZSkKICAgICAgfQogICAgfQogIH0KCiAgc3RhdGljIGZyb20oYml0ZmllbGQpIHsKICAgIHJldHVybiBuZXcgQml0ZmllbGQoYml0ZmllbGQudG9CdWZmZXIoYml0ZmllbGQuX3BhZ2VzLm1heExlbmd0aCAqIEJJVFNfUEVSX1BBR0UpKQogIH0KCiAgdG9CdWZmZXIobGVuZ3RoKSB7CiAgICBjb25zdCBwYWdlcyA9IE1hdGguY2VpbChsZW5ndGggLyBCSVRTX1BFUl9QQUdFKQogICAgY29uc3QgYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHBhZ2VzICogQllURVNfUEVSX1BBR0UpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYWdlczsgaSsrKSB7CiAgICAgIGNvbnN0IHBhZ2UgPSB0aGlzLl9wYWdlcy5nZXQoaSkKICAgICAgY29uc3Qgb2Zmc2V0ID0gaSAqIEJZVEVTX1BFUl9QQUdFCgogICAgICBpZiAocGFnZSkgewogICAgICAgIGNvbnN0IGJ1ZiA9IGI0YS5mcm9tKAogICAgICAgICAgcGFnZS5iaXRmaWVsZC5idWZmZXIsCiAgICAgICAgICBwYWdlLmJpdGZpZWxkLmJ5dGVPZmZzZXQsCiAgICAgICAgICBwYWdlLmJpdGZpZWxkLmJ5dGVMZW5ndGgKICAgICAgICApCgogICAgICAgIGJ1ZmZlci5zZXQoYnVmLCBvZmZzZXQpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnVmZmVyLmZpbGwoMCwgb2Zmc2V0LCBvZmZzZXQgKyBCWVRFU19QRVJfUEFHRSkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBidWZmZXIKICB9CgogIGdldEJpdGZpZWxkKGluZGV4KSB7CiAgICBjb25zdCBpID0gdGhpcy5nZXRQYWdlSW5kZXgoaW5kZXgpCgogICAgY29uc3QgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQogICAgcmV0dXJuIHAgfHwgbnVsbAogIH0KCiAgbWVyZ2UoYml0ZmllbGQsIGxlbmd0aCkgewogICAgbGV0IGkgPSAwCgogICAgd2hpbGUgKGkgPCBsZW5ndGgpIHsKICAgICAgY29uc3Qgc3RhcnQgPSBiaXRmaWVsZC5maXJzdFNldChpKQogICAgICBpZiAoc3RhcnQgPT09IC0xKSBicmVhawoKICAgICAgaSA9IGJpdGZpZWxkLmZpcnN0VW5zZXQoc3RhcnQpCgogICAgICBpZiAoaSA9PT0gLTEgfHwgaSA+IGxlbmd0aCkgaSA9IGxlbmd0aAoKICAgICAgdGhpcy5zZXRSYW5nZShzdGFydCwgaSwgdHJ1ZSkKCiAgICAgIGlmIChpID49IGxlbmd0aCkgYnJlYWsKICAgIH0KICB9CgogIGdldChpbmRleCkgewogICAgY29uc3QgaiA9IGluZGV4ICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgY29uc3QgaSA9IChpbmRleCAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIGNvbnN0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKCiAgICByZXR1cm4gcCA/IHAuZ2V0KGopIDogZmFsc2UKICB9CgogIGdldFBhZ2VCeXRlTGVuZ3RoKCkgewogICAgcmV0dXJuIEJZVEVTX1BFUl9QQUdFCiAgfQoKICBnZXRQYWdlSW5kZXgoaW5kZXgpIHsKICAgIGNvbnN0IGogPSBpbmRleCAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIHJldHVybiAoaW5kZXggLSBqKSAvIEJJVFNfUEVSX1BBR0UKICB9CgogIGdldFBhZ2UoaW5kZXgsIGNyZWF0ZSkgewogICAgY29uc3QgaSA9IHRoaXMuZ2V0UGFnZUluZGV4KGluZGV4KQoKICAgIGxldCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCgogICAgaWYgKHApIHJldHVybiBwCgogICAgaWYgKCFjcmVhdGUpIHJldHVybiBudWxsCgogICAgY29uc3QgayA9IE1hdGguZmxvb3IoaSAvIFBBR0VTX1BFUl9TRUdNRU5UKQogICAgY29uc3QgcyA9CiAgICAgIHRoaXMuX3NlZ21lbnRzLmdldChrKSB8fAogICAgICB0aGlzLl9zZWdtZW50cy5zZXQoCiAgICAgICAgaywKICAgICAgICBuZXcgQml0ZmllbGRTZWdtZW50KAogICAgICAgICAgaywKICAgICAgICAgIG5ldyBVaW50MzJBcnJheShrID09PSAwID8gSU5JVElBTF9XT1JEU19QRVJfU0VHTUVOVCA6IFdPUkRTX1BFUl9TRUdNRU5UKQogICAgICAgICkKICAgICAgKQoKICAgIHAgPSB0aGlzLl9wYWdlcy5zZXQoaSwgbmV3IEJpdGZpZWxkUGFnZShpLCBzKSkKCiAgICByZXR1cm4gcAogIH0KCiAgc2V0KGluZGV4LCB2YWwpIHsKICAgIGNvbnN0IGogPSBpbmRleCAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGNvbnN0IGkgPSAoaW5kZXggLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICBsZXQgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgIGlmICghcCAmJiB2YWwpIHsKICAgICAgY29uc3QgayA9IE1hdGguZmxvb3IoaSAvIFBBR0VTX1BFUl9TRUdNRU5UKQogICAgICBjb25zdCBzID0KICAgICAgICB0aGlzLl9zZWdtZW50cy5nZXQoaykgfHwKICAgICAgICB0aGlzLl9zZWdtZW50cy5zZXQoCiAgICAgICAgICBrLAogICAgICAgICAgbmV3IEJpdGZpZWxkU2VnbWVudCgKICAgICAgICAgICAgaywKICAgICAgICAgICAgbmV3IFVpbnQzMkFycmF5KGsgPT09IDAgPyBJTklUSUFMX1dPUkRTX1BFUl9TRUdNRU5UIDogV09SRFNfUEVSX1NFR01FTlQpCiAgICAgICAgICApCiAgICAgICAgKQoKICAgICAgcCA9IHRoaXMuX3BhZ2VzLnNldChpLCBuZXcgQml0ZmllbGRQYWdlKGksIHMpKQogICAgfQoKICAgIGlmIChwKSBwLnNldChqLCB2YWwpCiAgfQoKICBzZXRSYW5nZShzdGFydCwgZW5kLCB2YWwpIHsKICAgIGxldCBqID0gc3RhcnQgJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChzdGFydCAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIHdoaWxlIChzdGFydCA8IGVuZCkgewogICAgICBsZXQgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgICAgaWYgKCFwICYmIHZhbCkgewogICAgICAgIGNvbnN0IGsgPSBNYXRoLmZsb29yKGkgLyBQQUdFU19QRVJfU0VHTUVOVCkKICAgICAgICBjb25zdCBzID0KICAgICAgICAgIHRoaXMuX3NlZ21lbnRzLmdldChrKSB8fAogICAgICAgICAgdGhpcy5fc2VnbWVudHMuc2V0KAogICAgICAgICAgICBrLAogICAgICAgICAgICBuZXcgQml0ZmllbGRTZWdtZW50KAogICAgICAgICAgICAgIGssCiAgICAgICAgICAgICAgbmV3IFVpbnQzMkFycmF5KGsgPT09IDAgPyBJTklUSUFMX1dPUkRTX1BFUl9TRUdNRU5UIDogV09SRFNfUEVSX1NFR01FTlQpCiAgICAgICAgICAgICkKICAgICAgICAgICkKCiAgICAgICAgcCA9IHRoaXMuX3BhZ2VzLnNldChpLCBuZXcgQml0ZmllbGRQYWdlKGksIHMpKQogICAgICB9CgogICAgICBjb25zdCBvZmZzZXQgPSBpICogQklUU19QRVJfUEFHRQogICAgICBjb25zdCBsYXN0ID0gTWF0aC5taW4oZW5kIC0gb2Zmc2V0LCBCSVRTX1BFUl9QQUdFKQogICAgICBjb25zdCByYW5nZSA9IGxhc3QgLSBqCgogICAgICBpZiAocCkgcC5zZXRSYW5nZShqLCBsYXN0LCB2YWwpCgogICAgICBqID0gMAogICAgICBpKysKICAgICAgc3RhcnQgKz0gcmFuZ2UKICAgIH0KICB9CgogIGZpbmRGaXJzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICBsZXQgaiA9IHBvc2l0aW9uICYgKEJJVFNfUEVSX1NFR01FTlQgLSAxKQogICAgbGV0IGkgPSAocG9zaXRpb24gLSBqKSAvIEJJVFNfUEVSX1NFR01FTlQKCiAgICB3aGlsZSAoaSA8IHRoaXMuX3NlZ21lbnRzLm1heExlbmd0aCkgewogICAgICBjb25zdCBzID0gdGhpcy5fc2VnbWVudHMuZ2V0KGkpCgogICAgICBsZXQgaW5kZXggPSAtMQoKICAgICAgaWYgKHMpIGluZGV4ID0gcy5maW5kRmlyc3QodmFsLCBqKQogICAgICBlbHNlIGlmICghdmFsKSBpbmRleCA9IGoKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBpICogQklUU19QRVJfU0VHTUVOVCArIGluZGV4CgogICAgICBqID0gMAogICAgICBpKysKICAgIH0KCiAgICByZXR1cm4gdmFsID8gLTEgOiB0aGlzLl9zZWdtZW50cy5tYXhMZW5ndGggKiBCSVRTX1BFUl9TRUdNRU5UCiAgfQoKICBmaXJzdFNldChwb3NpdGlvbikgewogICAgcmV0dXJuIHRoaXMuZmluZEZpcnN0KHRydWUsIHBvc2l0aW9uKQogIH0KCiAgZmlyc3RVbnNldChwb3NpdGlvbikgewogICAgcmV0dXJuIHRoaXMuZmluZEZpcnN0KGZhbHNlLCBwb3NpdGlvbikKICB9CgogIGZpbmRMYXN0KHZhbCwgcG9zaXRpb24pIHsKICAgIGxldCBqID0gcG9zaXRpb24gJiAoQklUU19QRVJfU0VHTUVOVCAtIDEpCiAgICBsZXQgaSA9IChwb3NpdGlvbiAtIGopIC8gQklUU19QRVJfU0VHTUVOVAoKICAgIHdoaWxlIChpID49IDApIHsKICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZ21lbnRzLmdldChpKQoKICAgICAgbGV0IGluZGV4ID0gLTEKCiAgICAgIGlmIChzKSBpbmRleCA9IHMuZmluZExhc3QodmFsLCBqKQogICAgICBlbHNlIGlmICghdmFsKSBpbmRleCA9IGoKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBpICogQklUU19QRVJfU0VHTUVOVCArIGluZGV4CgogICAgICBqID0gQklUU19QRVJfU0VHTUVOVCAtIDEKICAgICAgaS0tCiAgICB9CgogICAgcmV0dXJuIC0xCiAgfQoKICBsYXN0U2V0KHBvc2l0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5maW5kTGFzdCh0cnVlLCBwb3NpdGlvbikKICB9CgogIGxhc3RVbnNldChwb3NpdGlvbikgewogICAgcmV0dXJuIHRoaXMuZmluZExhc3QoZmFsc2UsIHBvc2l0aW9uKQogIH0KCiAgaGFzU2V0KHN0YXJ0LCBsZW5ndGgpIHsKICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgbGVuZ3RoCgogICAgbGV0IGogPSBzdGFydCAmIChCSVRTX1BFUl9TRUdNRU5UIC0gMSkKICAgIGxldCBpID0gKHN0YXJ0IC0gaikgLyBCSVRTX1BFUl9TRUdNRU5UCgogICAgd2hpbGUgKGkgPCB0aGlzLl9zZWdtZW50cy5tYXhMZW5ndGgpIHsKICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZ21lbnRzLmdldChpKQoKICAgICAgbGV0IGluZGV4ID0gLTEKCiAgICAgIGlmIChzKSBpbmRleCA9IHMuZmluZEZpcnN0KHRydWUsIGopCgogICAgICBpZiAoaW5kZXggIT09IC0xKSByZXR1cm4gaSAqIEJJVFNfUEVSX1NFR01FTlQgKyBpbmRleCA8IGVuZAoKICAgICAgaiA9IDAKICAgICAgaSsrCgogICAgICBpZiAoaSAqIEJJVFNfUEVSX1NFR01FTlQgPj0gZW5kKSByZXR1cm4gZmFsc2UKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIGNvdW50KHN0YXJ0LCBsZW5ndGgsIHZhbCkgewogICAgbGV0IGogPSBzdGFydCAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGxldCBpID0gKHN0YXJ0IC0gaikgLyBCSVRTX1BFUl9QQUdFCiAgICBsZXQgYyA9IDAKCiAgICB3aGlsZSAobGVuZ3RoID4gMCkgewogICAgICBjb25zdCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCgogICAgICBjb25zdCBlbmQgPSBNYXRoLm1pbihqICsgbGVuZ3RoLCBCSVRTX1BFUl9QQUdFKQogICAgICBjb25zdCByYW5nZSA9IGVuZCAtIGoKCiAgICAgIGlmIChwKSBjICs9IHAuY291bnQoaiwgcmFuZ2UsIHZhbCkKICAgICAgZWxzZSBpZiAoIXZhbCkgYyArPSByYW5nZQoKICAgICAgaiA9IDAKICAgICAgaSsrCiAgICAgIGxlbmd0aCAtPSByYW5nZQogICAgfQoKICAgIHJldHVybiBjCiAgfQoKICBjb3VudFNldChzdGFydCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gdGhpcy5jb3VudChzdGFydCwgbGVuZ3RoLCB0cnVlKQogIH0KCiAgY291bnRVbnNldChzdGFydCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gdGhpcy5jb3VudChzdGFydCwgbGVuZ3RoLCBmYWxzZSkKICB9CgogICp3YW50KHN0YXJ0LCBsZW5ndGgpIHsKICAgIGNvbnN0IGogPSBzdGFydCAmIChCSVRTX1BFUl9TRUdNRU5UIC0gMSkKICAgIGxldCBpID0gKHN0YXJ0IC0gaikgLyBCSVRTX1BFUl9TRUdNRU5UCgogICAgd2hpbGUgKGxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZ21lbnRzLmdldChpKQoKICAgICAgaWYgKHMpIHsKICAgICAgICAvLyBXZSBhbHdheXMgc2VuZCBhdCBsZWFzdCA0IEtpQiB3b3J0aCBvZiBiaXRmaWVsZCBpbiBhIHdhbnQsIHJvdW5kaW5nCiAgICAgICAgLy8gdG8gdGhlIG5lYXJlc3QgNCBLaUIuCiAgICAgICAgY29uc3QgZW5kID0gY2VpbFRvKGNsYW1wKGxlbmd0aCAvIDgsIDQwOTYsIEJZVEVTX1BFUl9TRUdNRU5UKSwgNDA5NikKCiAgICAgICAgeWllbGQgewogICAgICAgICAgc3RhcnQ6IGkgKiBCSVRTX1BFUl9TRUdNRU5ULAogICAgICAgICAgYml0ZmllbGQ6IHMuYml0ZmllbGQuc3ViYXJyYXkoMCwgZW5kIC8gNCkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGkrKwogICAgICBsZW5ndGggLT0gQklUU19QRVJfU0VHTUVOVAogICAgfQogIH0KCiAgY2xlYXIodHgpIHsKICAgIHJldHVybiB0eC5kZWxldGVCaXRmaWVsZFBhZ2VSYW5nZSgwLCAtMSkKICB9CgogIG9udXBkYXRlKHJhbmdlcykgewogICAgZm9yIChjb25zdCB7IHN0YXJ0LCBlbmQsIHZhbHVlIH0gb2YgcmFuZ2VzKSB7CiAgICAgIHRoaXMuc2V0UmFuZ2Uoc3RhcnQsIGVuZCwgdmFsdWUpCiAgICB9CiAgfQoKICBzdGF0aWMgYXN5bmMgb3BlbihzdG9yYWdlLCBsZW5ndGgpIHsKICAgIGlmIChsZW5ndGggPT09IDApIHJldHVybiBuZXcgQml0ZmllbGQoc3RvcmFnZSwgbnVsbCkKCiAgICBjb25zdCBwYWdlcyA9IE1hdGguY2VpbChsZW5ndGggLyBCSVRTX1BFUl9QQUdFKQogICAgY29uc3QgYnVmZmVyID0gYjRhLmFsbG9jKHBhZ2VzICogQllURVNfUEVSX1BBR0UpCiAgICBjb25zdCBzdHJlYW0gPSBzdG9yYWdlLmNyZWF0ZUJpdGZpZWxkU3RyZWFtKHsgbHQ6IHBhZ2VzIH0pCgogICAgZm9yIGF3YWl0IChjb25zdCB7IGluZGV4LCBwYWdlIH0gb2Ygc3RyZWFtKSB7CiAgICAgIGJ1ZmZlci5zZXQocGFnZSwgaW5kZXggKiBCWVRFU19QRVJfUEFHRSkKICAgIH0KCiAgICByZXR1cm4gbmV3IEJpdGZpZWxkKGJ1ZmZlcikKICB9Cn0KCmZ1bmN0aW9uIGNsYW1wKG4sIG1pbiwgbWF4KSB7CiAgcmV0dXJuIE1hdGgubWluKE1hdGgubWF4KG4sIG1pbiksIG1heCkKfQoKZnVuY3Rpb24gY2VpbFRvKG4sIG11bHRpcGxlID0gMSkgewogIGNvbnN0IHJlbWFpbmRlciA9IG4gJSBtdWx0aXBsZQogIGlmIChyZW1haW5kZXIgPT09IDApIHJldHVybiBuCiAgcmV0dXJuIG4gKyBtdWx0aXBsZSAtIHJlbWFpbmRlcgp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQoKLy8gVE9ETzogcmVuYW1lIHRoaXMgdG8gImNyeXB0byIgYW5kIG1vdmUgZXZlcnl0aGluZyBoYXNoaW5nIHJlbGF0ZWQgZXRjIGluIGhlcmUKLy8gQWxzbyBsZXRzIG1vdmUgdGhlIHRyZWUgc3R1ZmYgZnJvbSBoeXBlcmNvcmUtY3J5cHRvIGhlcmUKCmNvbnN0IFsKICBUUkVFLAogIFJFUExJQ0FURV9JTklUSUFUT1IsCiAgUkVQTElDQVRFX1JFU1BPTkRFUiwKICBNQU5JRkVTVCwKICBERUZBVUxUX05BTUVTUEFDRSwKICBERUZBVUxUX0VOQ1JZUFRJT04KXSA9IGNyeXB0by5uYW1lc3BhY2UoJ2h5cGVyY29yZScsIDYpCgpleHBvcnRzLk1BTklGRVNUID0gTUFOSUZFU1QKZXhwb3J0cy5ERUZBVUxUX05BTUVTUEFDRSA9IERFRkFVTFRfTkFNRVNQQUNFCmV4cG9ydHMuREVGQVVMVF9FTkNSWVBUSU9OID0gREVGQVVMVF9FTkNSWVBUSU9OCgpleHBvcnRzLnJlcGxpY2F0ZSA9IGZ1bmN0aW9uIChpc0luaXRpYXRvciwga2V5LCBoYW5kc2hha2VIYXNoKSB7CiAgY29uc3Qgb3V0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKQogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2goCiAgICBvdXQsCiAgICBbaXNJbml0aWF0b3IgPyBSRVBMSUNBVEVfSU5JVElBVE9SIDogUkVQTElDQVRFX1JFU1BPTkRFUiwga2V5XSwKICAgIGhhbmRzaGFrZUhhc2gKICApCiAgcmV0dXJuIG91dAp9CgpleHBvcnRzLnRyZWVTaWduYWJsZSA9IGZ1bmN0aW9uIChtYW5pZmVzdEhhc2gsIHRyZWVIYXNoLCBsZW5ndGgsIGZvcmspIHsKICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogMTEyLCBidWZmZXI6IGI0YS5hbGxvY1Vuc2FmZSgxMTIpIH0KICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBUUkVFKQogIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG1hbmlmZXN0SGFzaCkKICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCB0cmVlSGFzaCkKICBjLnVpbnQ2NC5lbmNvZGUoc3RhdGUsIGxlbmd0aCkKICBjLnVpbnQ2NC5lbmNvZGUoc3RhdGUsIGZvcmspCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlcgp9CgpleHBvcnRzLnRyZWVTaWduYWJsZUNvbXBhdCA9IGZ1bmN0aW9uIChoYXNoLCBsZW5ndGgsIGZvcmssIG5vSGVhZGVyKSB7CiAgY29uc3QgZW5kID0gbm9IZWFkZXIgPyA0OCA6IDgwCiAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQsIGJ1ZmZlcjogYjRhLmFsbG9jVW5zYWZlKGVuZCkgfQogIGlmICghbm9IZWFkZXIpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIFRSRUUpIC8vIHVsdHJhIGxlZ2FjeSBtb2RlLCBraWxsIGluIGZ1dHVyZSBtYWpvcgogIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIGhhc2gpCiAgYy51aW50NjQuZW5jb2RlKHN0YXRlLCBsZW5ndGgpCiAgYy51aW50NjQuZW5jb2RlKHN0YXRlLCBmb3JrKQogIHJldHVybiBzdGF0ZS5idWZmZXIKfQovLyBFeHBvcnQgdGhlIGFwcHJvcHJpYXRlIHZlcnNpb24gb2YgYHF1aWNrYml0LXVuaXZlcnNhbGAgYXMgdGhlIHBsYWluIGltcG9ydAovLyBtYXkgcmVzb2x2ZSB0byBhbiBvbGRlciB2ZXJzaW9uIGluIHNvbWUgZW52aXJvbm1lbnRzCmxldCBxdWlja2JpdCA9IHJlcXVpcmUoJ3F1aWNrYml0LXVuaXZlcnNhbCcpCmlmICgKICB0eXBlb2YgcXVpY2tiaXQuZmluZEZpcnN0ICE9PSAnZnVuY3Rpb24nIHx8CiAgdHlwZW9mIHF1aWNrYml0LmZpbmRMYXN0ICE9PSAnZnVuY3Rpb24nIHx8CiAgdHlwZW9mIHF1aWNrYml0LmNsZWFyICE9PSAnZnVuY3Rpb24nCikgewogIC8vIFRoaXMgc2hvdWxkIGFsd2F5cyBsb2FkIHRoZSBmYWxsYmFjayBmcm9tIHRoZSBsb2NhbGx5IGluc3RhbGxlZCB2ZXJzaW9uCiAgcXVpY2tiaXQgPSByZXF1aXJlKCdxdWlja2JpdC11bml2ZXJzYWwvZmFsbGJhY2snKQp9CmV4cG9ydHMucXVpY2tiaXQgPSBxdWlja2JpdApjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgZmxhdCA9IHJlcXVpcmUoJ2ZsYXQtdHJlZScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHF1aWNrYml0ID0gcmVxdWlyZSgncXVpY2tiaXQtdW5pdmVyc2FsJykKY29uc3QgQml0ZmllbGQgPSByZXF1aXJlKCcuL2JpdGZpZWxkJykKCmNvbnN0IE1BWF9CQVRDSF9VU0VEID0gNCAqIDEwMjQgKiAxMDI0CmNvbnN0IE1JTl9CQVRDSF9VU0VEID0gNTEyICogMTAyNAoKLy8ganVzdCBpbiBpdHMgb3duIGZpbGUgYXMgaXRzIGEgYml0IGludm9sdmVkCgptb2R1bGUuZXhwb3J0cyA9IGNvcHlQcm9sb2d1ZQoKYXN5bmMgZnVuY3Rpb24gY29weVByb2xvZ3VlKHNyYywgZHN0KSB7CiAgY29uc3QgcHJvbG9ndWUgPSBkc3QuaGVhZGVyLm1hbmlmZXN0LnByb2xvZ3VlCgogIGlmIChzcmMubGVuZ3RoIDwgcHJvbG9ndWUubGVuZ3RoIHx8IHByb2xvZ3VlLmxlbmd0aCA9PT0gMCkgcmV0dXJuCgogIGNvbnN0IHN0YWNrID0gW10KICBjb25zdCByb290cyA9IGZsYXQuZnVsbFJvb3RzKHByb2xvZ3VlLmxlbmd0aCAqIDIpCiAgY29uc3QgYmF0Y2ggPSB7IHJvb3RzLCBmaXJzdDogdHJ1ZSwgbGFzdDogZmFsc2UsIGNvbnRpZzogMCwgdXNlZDogMCwgdHJlZTogW10sIGJsb2NrczogW10gfQoKICBmb3IgKGxldCBpID0gMDsgaSA8IHJvb3RzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBub2RlID0gcm9vdHNbaV0KICAgIGJhdGNoLnRyZWUucHVzaChub2RlKQogICAgc3RhY2sucHVzaChub2RlKQogIH0KCiAgbGV0IGxhc3RQYWdlID0gLTEKICBsZXQgbGFzdEJsb2NrID0gLTEKCiAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIHNyYy5zdG9yYWdlLmNyZWF0ZUJsb2NrU3RyZWFtKHsKICAgIGd0ZTogMCwKICAgIGx0OiBwcm9sb2d1ZS5sZW5ndGgsCiAgICByZXZlcnNlOiB0cnVlCiAgfSkpIHsKICAgIGlmICh3YWxrVHJlZShzdGFjaywgZGF0YS5pbmRleCAqIDIsIGJhdGNoKSA9PT0gZmFsc2UpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIGJsb2NrIG9yIHRyZWUgbm9kZSBmb3IgJyArIGRhdGEuaW5kZXgpCiAgICB9CgogICAgYmF0Y2guY29udGlnID0gZGF0YS5pbmRleCArIDEgPT09IGxhc3RCbG9jayA/IGJhdGNoLmNvbnRpZyArIDEgOiAxCiAgICBsYXN0QmxvY2sgPSBkYXRhLmluZGV4CgogICAgY29uc3QgcGFnZSA9IGdldEJpdGZpZWxkUGFnZShkYXRhLmluZGV4KQogICAgYmF0Y2guYmxvY2tzLnB1c2goZGF0YSkKCiAgICBpZiAobGFzdFBhZ2UgIT09IHBhZ2UpIGJhdGNoLnVzZWQgKz0gNDA5NgogICAgYmF0Y2gudXNlZCArPSBNYXRoLm1heChkYXRhLnZhbHVlLmJ5dGVMZW5ndGgsIDEyOCkgLy8gMTI4IGlzIGp1c3QgYSBzYW5pdHkgbnVtYmVyIHRvIGF2b2lkIG1lZ2EgYmF0Y2hlcwoKICAgIC8vIGFsd2F5cyBzYWZlIHRvIHBhcnRpYWxseSBmbHVzaCBzbyB3ZSBkbyB0aGF0IG9uZGVtYW5kIHRvIHJlZHVjZSBtZW1vcnkgdXNhZ2UuLi4KICAgIGlmICgoYmF0Y2gudXNlZCA+PSBNSU5fQkFUQ0hfVVNFRCAmJiBwYWdlICE9PSBsYXN0UGFnZSkgfHwgYmF0Y2gudXNlZCA+PSBNQVhfQkFUQ0hfVVNFRCkgewogICAgICBhd2FpdCBmbHVzaEJhdGNoKHByb2xvZ3VlLCBzcmMsIGRzdCwgYmF0Y2gpCiAgICB9CgogICAgbGFzdFBhZ2UgPSBwYWdlCiAgfQoKICBpZiAobGFzdEJsb2NrICE9PSAwKSBiYXRjaC5jb250aWcgPSAwCgogIGJhdGNoLmxhc3QgPSB0cnVlCiAgYXdhaXQgZmx1c2hCYXRjaChwcm9sb2d1ZSwgc3JjLCBkc3QsIGJhdGNoKQp9Cgphc3luYyBmdW5jdGlvbiBmbHVzaEJhdGNoKHByb2xvZ3VlLCBzcmMsIGRzdCwgYmF0Y2gpIHsKICBjb25zdCBub2RlUHJvbWlzZXMgPSBbXQoKICBjb25zdCBzcmNSZWFkZXIgPSBzcmMuc3RvcmFnZS5yZWFkKCkKICBmb3IgKGNvbnN0IGluZGV4IG9mIGJhdGNoLnRyZWUpIHsKICAgIG5vZGVQcm9taXNlcy5wdXNoKHNyY1JlYWRlci5nZXRUcmVlTm9kZShpbmRleCkpCiAgfQogIHNyY1JlYWRlci50cnlGbHVzaCgpCgogIGNvbnN0IG5vZGVzID0gYXdhaXQgUHJvbWlzZS5hbGwobm9kZVByb21pc2VzKQoKICBjb25zdCBwYWdlUHJvbWlzZXMgPSBbXQogIGNvbnN0IGRzdFJlYWRlciA9IGRzdC5zdG9yYWdlLnJlYWQoKQoKICBjb25zdCBoZWFkUHJvbWlzZSA9IGJhdGNoLmZpcnN0ID8gZHN0UmVhZGVyLmdldEhlYWQoKSA6IG51bGwKICBpZiAoaGVhZFByb21pc2UpIGhlYWRQcm9taXNlLmNhdGNoKG5vb3ApCgogIGxldCBsYXN0UGFnZSA9IC0xCiAgZm9yIChjb25zdCB7IGluZGV4IH0gb2YgYmF0Y2guYmxvY2tzKSB7CiAgICBjb25zdCBwYWdlID0gZ2V0Qml0ZmllbGRQYWdlKGluZGV4KQogICAgaWYgKHBhZ2UgPT09IGxhc3RQYWdlKSBjb250aW51ZQogICAgbGFzdFBhZ2UgPSBwYWdlCiAgICBwYWdlUHJvbWlzZXMucHVzaChkc3RSZWFkZXIuZ2V0Qml0ZmllbGRQYWdlKHBhZ2UpKQogIH0KCiAgZHN0UmVhZGVyLnRyeUZsdXNoKCkKCiAgY29uc3QgcGFnZXMgPSBhd2FpdCBQcm9taXNlLmFsbChwYWdlUHJvbWlzZXMpCiAgY29uc3QgaGVhZCA9IGhlYWRQcm9taXNlID09PSBudWxsID8gbnVsbCA6IGF3YWl0IGhlYWRQcm9taXNlCiAgY29uc3QgdXNlckRhdGEgPSBbXQoKICAvLyByZWFkcyBkb25lIQoKICBpZiAoYmF0Y2guZmlyc3QpIHsKICAgIGNvbnN0IHJvb3RzID0gbm9kZXMuc2xpY2UoMCwgYmF0Y2gucm9vdHMubGVuZ3RoKQoKICAgIGZvciAoY29uc3Qgbm9kZSBvZiByb290cykgewogICAgICBpZiAoIW5vZGUpIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBub2RlcyBmb3IgcHJvbG9ndWUgaGFzaCcpCiAgICB9CgogICAgY29uc3QgdHJlZUhhc2ggPSBjcnlwdG8udHJlZShyb290cykKICAgIGlmICghYjRhLmVxdWFscyh0cmVlSGFzaCwgcHJvbG9ndWUuaGFzaCkpIHRocm93IG5ldyBFcnJvcignUHJvbG9ndWUgZG9lcyBub3QgbWF0Y2ggc291cmNlJykKICB9CgogIGlmIChiYXRjaC5maXJzdCkgewogICAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIHNyYy5zdG9yYWdlLmNyZWF0ZVVzZXJEYXRhU3RyZWFtKCkpIHVzZXJEYXRhLnB1c2goZGF0YSkKICB9CgogIGZvciAobGV0IGkgPSAwOyBpIDwgcGFnZXMubGVuZ3RoOyBpKyspIHsKICAgIGlmICghcGFnZXNbaV0pIHBhZ2VzW2ldID0gYjRhLmFsbG9jKDQwOTYpCiAgfQoKICBjb25zdCB0eCA9IGRzdC5zdG9yYWdlLndyaXRlKCkKCiAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSB0eC5wdXRUcmVlTm9kZShub2RlKQoKICBsYXN0UGFnZSA9IC0xCiAgbGV0IHBhZ2VJbmRleCA9IC0xCgogIGZvciAoY29uc3QgeyBpbmRleCwgdmFsdWUgfSBvZiBiYXRjaC5ibG9ja3MpIHsKICAgIGNvbnN0IHBhZ2UgPSBnZXRCaXRmaWVsZFBhZ2UoaW5kZXgpCgogICAgaWYgKHBhZ2UgIT09IGxhc3RQYWdlKSB7CiAgICAgIGxhc3RQYWdlID0gcGFnZQogICAgICBwYWdlSW5kZXgrKwogICAgICAvLyBxdWV1ZSB0aGUgcGFnZSBub3csIHdlIG11dGF0ZSBpdCBiZWxvdyBidXQgaXRzIHRoZSBzYW1lIHJlZgogICAgICB0eC5wdXRCaXRmaWVsZFBhZ2UocGFnZUluZGV4LCBwYWdlc1twYWdlSW5kZXhdKQogICAgfQoKICAgIGNvbnN0IHBhZ2VCdWZmZXIgPSBwYWdlc1twYWdlSW5kZXhdCiAgICBxdWlja2JpdC5zZXQocGFnZUJ1ZmZlciwgZ2V0Qml0ZmllbGRPZmZzZXQoaW5kZXgpLCB0cnVlKQogICAgdHgucHV0QmxvY2soaW5kZXgsIHZhbHVlKQogIH0KCiAgZm9yIChjb25zdCB7IGtleSwgdmFsdWUgfSBvZiB1c2VyRGF0YSkgewogICAgdHgucHV0VXNlckRhdGEoa2V5LCB2YWx1ZSkKICB9CgogIGxldCB1cGdyYWRlZCA9IGJhdGNoLmZpcnN0ICYmICFoZWFkCiAgaWYgKHVwZ3JhZGVkKSB7CiAgICB0eC5zZXRIZWFkKHByb2xvZ3VlVG9UcmVlKHByb2xvZ3VlKSkKICB9CgogIGF3YWl0IHR4LmZsdXNoKCkKCiAgaWYgKHVwZ3JhZGVkKSB7CiAgICBjb25zdCByb290cyA9IG5vZGVzLnNsaWNlKDAsIGJhdGNoLnJvb3RzLmxlbmd0aCkKICAgIGRzdC5zdGF0ZS5zZXRSb290cyhyb290cykKICAgIGRzdC5oZWFkZXIudHJlZSA9IHByb2xvZ3VlVG9UcmVlKHByb2xvZ3VlKQogIH0KCiAgaWYgKHVzZXJEYXRhLmxlbmd0aCA+IDApIHsKICAgIGRzdC5oZWFkZXIudXNlckRhdGEgPSB1c2VyRGF0YS5jb25jYXQoZHN0LmhlYWRlci51c2VyRGF0YSkKICB9CgogIGlmIChiYXRjaC5jb250aWcpIHsKICAgIC8vIFRPRE86IHdlIG5lZWQgdG8gcGVyc2lzdCB0aGlzIHNvbWVob3cKICAgIGRzdC5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCA9IGJhdGNoLmNvbnRpZwogIH0KCiAgbGV0IHN0YXJ0ID0gMAogIGxldCBsZW5ndGggPSAwCgogIC8vIHVwZGF0ZSBpbiBtZW1vcnkgYml0ZmllbGQKICBmb3IgKGNvbnN0IHsgaW5kZXggfSBvZiBiYXRjaC5ibG9ja3MpIHsKICAgIGlmIChzdGFydCA9PT0gMCB8fCBzdGFydCAtIDEgPT09IGluZGV4KSB7CiAgICAgIGxlbmd0aCsrCiAgICB9IGVsc2UgewogICAgICBpZiAobGVuZ3RoID4gMCkgc2lnbmFsUmVwbGljYXRvcihkc3QsIHVwZ3JhZGVkLCBzdGFydCwgbGVuZ3RoKQogICAgICB1cGdyYWRlZCA9IGZhbHNlCiAgICAgIGxlbmd0aCA9IDEKICAgIH0KCiAgICBzdGFydCA9IGluZGV4CiAgICBkc3QuYml0ZmllbGQuc2V0KGluZGV4LCB0cnVlKQogIH0KCiAgaWYgKGxlbmd0aCA+IDApIHNpZ25hbFJlcGxpY2F0b3IoZHN0LCB1cGdyYWRlZCwgc3RhcnQsIGxlbmd0aCkKCiAgLy8gdW5saW5rCiAgYmF0Y2gudHJlZSA9IFtdCiAgYmF0Y2guYmxvY2tzID0gW10KICBiYXRjaC5maXJzdCA9IGZhbHNlCiAgYmF0Y2gudXNlZCA9IDAKfQoKZnVuY3Rpb24gc2lnbmFsUmVwbGljYXRvcihjb3JlLCB1cGdyYWRlZCwgc3RhcnQsIGxlbmd0aCkgewogIGlmICh1cGdyYWRlZCkgewogICAgY29yZS5yZXBsaWNhdG9yLmNvcmsoKQogICAgY29yZS5yZXBsaWNhdG9yLm9uaGF2ZShzdGFydCwgbGVuZ3RoLCBmYWxzZSkKICAgIGNvcmUucmVwbGljYXRvci5vbnVwZ3JhZGUoKQogICAgY29yZS5yZXBsaWNhdG9yLnVuY29yaygpCiAgfSBlbHNlIHsKICAgIGNvcmUucmVwbGljYXRvci5vbmhhdmUoc3RhcnQsIGxlbmd0aCwgZmFsc2UpCiAgfQp9CgpmdW5jdGlvbiBwcm9sb2d1ZVRvVHJlZShwcm9sb2d1ZSkgewogIHJldHVybiB7CiAgICBmb3JrOiAwLAogICAgbGVuZ3RoOiBwcm9sb2d1ZS5sZW5ndGgsCiAgICByb290SGFzaDogcHJvbG9ndWUuaGFzaCwKICAgIHNpZ25hdHVyZTogbnVsbAogIH0KfQoKZnVuY3Rpb24gZ2V0Qml0ZmllbGRQYWdlKGluZGV4KSB7CiAgcmV0dXJuIE1hdGguZmxvb3IoaW5kZXggLyBCaXRmaWVsZC5CSVRTX1BFUl9QQUdFKQp9CgpmdW5jdGlvbiBnZXRCaXRmaWVsZE9mZnNldChpbmRleCkgewogIHJldHVybiBpbmRleCAmIChCaXRmaWVsZC5CSVRTX1BFUl9QQUdFIC0gMSkKfQoKZnVuY3Rpb24gd2Fsa1RyZWUoc3RhY2ssIHRhcmdldCwgYmF0Y2gpIHsKICB3aGlsZSAoc3RhY2subGVuZ3RoID4gMCkgewogICAgY29uc3Qgbm9kZSA9IHN0YWNrLnBvcCgpCgogICAgaWYgKChub2RlICYgMSkgPT09IDApIHsKICAgICAgaWYgKG5vZGUgPT09IHRhcmdldCkgcmV0dXJuIHRydWUKICAgICAgY29udGludWUKICAgIH0KCiAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKG5vZGUpCiAgICBpZiAoIWl0ZS5jb250YWlucyh0YXJnZXQpKSBjb250aW51ZQoKICAgIHdoaWxlICgoaXRlLmluZGV4ICYgMSkgIT09IDApIHsKICAgICAgY29uc3QgbGVmdCA9IGl0ZS5sZWZ0Q2hpbGQoKQogICAgICBjb25zdCByaWdodCA9IGl0ZS5zaWJsaW5nKCkgLy8gaXMgcmlnaHQgY2hpbGQKCiAgICAgIGJhdGNoLnRyZWUucHVzaChsZWZ0LCByaWdodCkKCiAgICAgIGlmIChpdGUuY29udGFpbnModGFyZ2V0KSkgc3RhY2sucHVzaChsZWZ0KQogICAgICBlbHNlIGl0ZS5zaWJsaW5nKCkKICAgIH0KCiAgICBpZiAoaXRlLmluZGV4ID09PSB0YXJnZXQpIHJldHVybiB0cnVlCiAgfQoKICByZXR1cm4gZmFsc2UKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCB1bnNsYWIgPSByZXF1aXJlKCd1bnNsYWInKQpjb25zdCB6MzIgPSByZXF1aXJlKCd6MzInKQpjb25zdCBNdXRleCA9IHJlcXVpcmUoJy4vbXV0ZXgnKQpjb25zdCB7IE1lcmtsZVRyZWUsIFJlb3JnQmF0Y2ggfSA9IHJlcXVpcmUoJy4vbWVya2xlLXRyZWUnKQpjb25zdCBCaXRJbnRlcmx1ZGUgPSByZXF1aXJlKCcuL2JpdC1pbnRlcmx1ZGUnKQpjb25zdCBCaXRmaWVsZCA9IHJlcXVpcmUoJy4vYml0ZmllbGQnKQpjb25zdCBSZW1vdGVCaXRmaWVsZCA9IHJlcXVpcmUoJy4vcmVtb3RlLWJpdGZpZWxkJykKY29uc3QgewogIEJBRF9BUkdVTUVOVCwKICBTVE9SQUdFX0VNUFRZLAogIFNUT1JBR0VfQ09ORkxJQ1QsCiAgSU5WQUxJRF9TSUdOQVRVUkUsCiAgSU5WQUxJRF9DSEVDS1NVTQp9ID0gcmVxdWlyZSgnaHlwZXJjb3JlLWVycm9ycycpCmNvbnN0IFZlcmlmaWVyID0gcmVxdWlyZSgnLi92ZXJpZmllcicpCmNvbnN0IGF1ZGl0ID0gcmVxdWlyZSgnLi9hdWRpdCcpCmNvbnN0IGNvcHlQcm9sb2d1ZSA9IHJlcXVpcmUoJy4vY29weS1wcm9sb2d1ZScpCmNvbnN0IFNlc3Npb25TdGF0ZSA9IHJlcXVpcmUoJy4vc2Vzc2lvbi1zdGF0ZScpCmNvbnN0IFJlcGxpY2F0b3IgPSByZXF1aXJlKCcuL3JlcGxpY2F0b3InKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBDb3JlIHsKICBjb25zdHJ1Y3RvcihkYiwgb3B0cyA9IHt9KSB7CiAgICB0aGlzLmRiID0gZGIKICAgIHRoaXMuc3RvcmFnZSA9IG51bGwKICAgIHRoaXMucmVwbGljYXRvciA9IG5ldyBSZXBsaWNhdG9yKHRoaXMsIG9wdHMpCiAgICB0aGlzLnNlc3Npb25TdGF0ZXMgPSBbXQogICAgdGhpcy5tb25pdG9ycyA9IFtdCiAgICB0aGlzLmFjdGl2ZVNlc3Npb25zID0gMAogICAgdGhpcy5nYyA9IDAgLy8gY29yZXN0b3JlIHVzZXMgdGhpcyB0byBtYWluIGEgZ2Mgc3RyaWtlIHBvb2wKCiAgICB0aGlzLmlkID0gb3B0cy5rZXkgPyB6MzIuZW5jb2RlKG9wdHMua2V5KSA6IG51bGwKICAgIHRoaXMua2V5ID0gb3B0cy5rZXkgfHwgbnVsbAogICAgdGhpcy5kaXNjb3ZlcnlLZXkgPSBvcHRzLmRpc2NvdmVyeUtleSB8fCAob3B0cy5rZXkgJiYgY3J5cHRvLmRpc2NvdmVyeUtleShvcHRzLmtleSkpIHx8IG51bGwKICAgIHRoaXMubWFuaWZlc3QgPSBudWxsCiAgICB0aGlzLm9wZW5pbmcgPSBudWxsCiAgICB0aGlzLmNsb3NpbmcgPSBudWxsCiAgICB0aGlzLmV4Y2x1c2l2ZSA9IG51bGwKCiAgICB0aGlzLnByZXVwZGF0ZSA9IG51bGwKICAgIHRoaXMuaGVhZGVyID0gbnVsbAogICAgdGhpcy5jb21wYXQgPSBmYWxzZQogICAgdGhpcy5iaXRmaWVsZCA9IG51bGwKICAgIHRoaXMudmVyaWZpZXIgPSBudWxsCiAgICB0aGlzLnRydW5jYXRpbmcgPSAwCiAgICB0aGlzLnVwZGF0aW5nID0gZmFsc2UKICAgIHRoaXMuc2tpcEJpdGZpZWxkID0gbnVsbAogICAgdGhpcy5nbG9iYWxDYWNoZSA9IG9wdHMuZ2xvYmFsQ2FjaGUgfHwgbnVsbAogICAgdGhpcy5hdXRvQ2xvc2UgPSBvcHRzLmF1dG9DbG9zZSAhPT0gZmFsc2UKICAgIHRoaXMub25pZGxlID0gbm9vcAoKICAgIHRoaXMuc3RhdGUgPSBudWxsCiAgICB0aGlzLm9wZW5lZCA9IGZhbHNlCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLmNsb3NlZCA9IGZhbHNlCgogICAgdGhpcy5oaW50c0NoYW5nZWQgPSBmYWxzZQoKICAgIHRoaXMuX2JpdGZpZWxkID0gbnVsbAogICAgdGhpcy5fdmVyaWZpZXMgPSBudWxsCiAgICB0aGlzLl92ZXJpZmllc0ZsdXNoZWQgPSBudWxsCiAgICB0aGlzLl9sZWdhY3kgPSAhIW9wdHMubGVnYWN5CgogICAgdGhpcy5vcGVuaW5nID0gdGhpcy5fb3BlbihvcHRzKQogICAgdGhpcy5vcGVuaW5nLmNhdGNoKG5vb3ApCiAgfQoKICByZWFkeSgpIHsKICAgIHJldHVybiB0aGlzLm9wZW5pbmcKICB9CgogIGFkZE1vbml0b3IocykgewogICAgaWYgKHMuX21vbml0b3JJbmRleCA+PSAwKSByZXR1cm4KICAgIHMuX21vbml0b3JJbmRleCA9IHRoaXMubW9uaXRvcnMucHVzaChzKSAtIDEKICB9CgogIHJlbW92ZU1vbml0b3IocykgewogICAgaWYgKHMuX21vbml0b3JJbmRleCA8IDApIHJldHVybgogICAgY29uc3QgaGVhZCA9IHRoaXMubW9uaXRvcnMucG9wKCkKICAgIGlmIChoZWFkICE9PSBzKSB0aGlzLm1vbml0b3JzWyhoZWFkLl9tb25pdG9ySW5kZXggPSBzLl9tb25pdG9ySW5kZXgpXSA9IGhlYWQKICAgIHMuX21vbml0b3JJbmRleCA9IC0xCiAgfQoKICBlbWl0TWFuaWZlc3QoKSB7CiAgICBmb3IgKGxldCBpID0gdGhpcy5tb25pdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICB0aGlzLm1vbml0b3JzW2ldLmVtaXQoJ21hbmlmZXN0JykKICAgIH0KICB9CgogIGNyZWF0ZVVzZXJEYXRhU3RyZWFtKG9wdHMsIHNlc3Npb24gPSB0aGlzLnN0YXRlKSB7CiAgICByZXR1cm4gc2Vzc2lvbi5zdG9yYWdlLmNyZWF0ZVVzZXJEYXRhU3RyZWFtKG9wdHMpCiAgfQoKICBhbGxTZXNzaW9ucygpIHsKICAgIGNvbnN0IHNlc3Npb25zID0gW10KICAgIGZvciAoY29uc3Qgc3RhdGUgb2YgdGhpcy5zZXNzaW9uU3RhdGVzKSB7CiAgICAgIGlmIChzdGF0ZS5zZXNzaW9ucy5sZW5ndGgpIHNlc3Npb25zLnB1c2goLi4uc3RhdGUuc2Vzc2lvbnMpCiAgICB9CiAgICByZXR1cm4gc2Vzc2lvbnMKICB9CgogIGhhc1Nlc3Npb24oKSB7CiAgICByZXR1cm4gdGhpcy5hY3RpdmVTZXNzaW9ucyAhPT0gMAogIH0KCiAgY29tcGFjdCgpIHsKICAgIGNvbnN0IGNvbXBhY3RpbmcgPSBbXQogICAgZm9yIChjb25zdCBzIG9mIHRoaXMuc2Vzc2lvblN0YXRlcykgewogICAgICBjb21wYWN0aW5nLnB1c2gocy5zdG9yYWdlLmNvbXBhY3QoKSkKICAgIH0KICAgIHJldHVybiBQcm9taXNlLmFsbChjb21wYWN0aW5nKQogIH0KCiAgY2hlY2tJZklkbGUoKSB7CiAgICBpZiAoIXRoaXMub3BlbmVkIHx8IHRoaXMuZGVzdHJveWVkID09PSB0cnVlIHx8IHRoaXMuaGFzU2Vzc2lvbigpID09PSB0cnVlKSByZXR1cm4KICAgIGlmICh0aGlzLnJlcGxpY2F0b3IuaWRsZSgpID09PSBmYWxzZSkgcmV0dXJuCiAgICBpZiAodGhpcy5zdGF0ZSA9PT0gbnVsbCB8fCB0aGlzLnN0YXRlLm11dGV4LmlkbGUoKSA9PT0gZmFsc2UpIHJldHVybgogICAgdGhpcy5vbmlkbGUoKQogIH0KCiAgYXN5bmMgbG9ja0V4Y2x1c2l2ZSgpIHsKICAgIGlmICh0aGlzLmV4Y2x1c2l2ZSA9PT0gbnVsbCkgdGhpcy5leGNsdXNpdmUgPSBuZXcgTXV0ZXgoKQogICAgYXdhaXQgdGhpcy5leGNsdXNpdmUubG9jaygpCiAgfQoKICB1bmxvY2tFeGNsdXNpdmUoKSB7CiAgICBpZiAodGhpcy5leGNsdXNpdmUgIT09IG51bGwpIHRoaXMuZXhjbHVzaXZlLnVubG9jaygpCiAgfQoKICBhc3luYyBfb3BlbihvcHRzKSB7CiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl90cnlPcGVuKG9wdHMpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5vbmlkbGUoKQogICAgICB0aHJvdyBlcnIKICAgIH0KCiAgICB0aGlzLm9wZW5lZCA9IHRydWUKICB9CgogIGFzeW5jIF90cnlPcGVuKG9wdHMpIHsKICAgIGlmIChvcHRzLnByZW9wZW4pIGF3YWl0IG9wdHMucHJlb3BlbiAvLyBqdXN0IGEgaG9vayB0byBhbGxvdyBleGNsdXNpdmUgYWNjZXNzIGhlcmUuLi4KCiAgICBsZXQgc3RvcmFnZSA9IGF3YWl0IHRoaXMuZGIucmVzdW1lQ29yZSh0aGlzLmRpc2NvdmVyeUtleSkKCiAgICBsZXQgb3ZlcndyaXRlID0gb3B0cy5vdmVyd3JpdGUgPT09IHRydWUKCiAgICBjb25zdCBmb3JjZSA9IG9wdHMuZm9yY2UgPT09IHRydWUKICAgIGNvbnN0IGNyZWF0ZUlmTWlzc2luZyA9IG9wdHMuY3JlYXRlSWZNaXNzaW5nICE9PSBmYWxzZQogICAgLy8ga2lsbCB0aGlzIGZsYWcgc29vbgogICAgY29uc3QgbGVnYWN5ID0gISFvcHRzLmxlZ2FjeQoKICAgIC8vIGRlZmF1bHQgdG8gdHJ1ZSBmb3Igbm93IGlmIG5vIG1hbmlmZXN0IGlzIHByb3ZpZGVkCiAgICBsZXQgY29tcGF0ID0gb3B0cy5jb21wYXQgPT09IHRydWUgfHwgKG9wdHMuY29tcGF0ICE9PSBmYWxzZSAmJiAhb3B0cy5tYW5pZmVzdCkKCiAgICBsZXQgaGVhZGVyID0gc3RvcmFnZSA/IHBhcnNlSGVhZGVyKGF3YWl0IGdldENvcmVJbmZvKHN0b3JhZ2UpKSA6IG51bGwKCiAgICBjb25zdCBoYWRNYW5pZmVzdCA9ICEhaGVhZGVyICYmICEhaGVhZGVyLm1hbmlmZXN0ICYmICEhaGVhZGVyLmtleQogICAgY29uc3QgaGFkS2V5UGFpciA9ICEhaGVhZGVyICYmICEhaGVhZGVyLmtleVBhaXIKCiAgICBpZiAoZm9yY2UgJiYgb3B0cy5rZXkgJiYgaGVhZGVyICYmICFiNGEuZXF1YWxzKGhlYWRlci5rZXksIG9wdHMua2V5KSkgewogICAgICBvdmVyd3JpdGUgPSB0cnVlCiAgICB9CgogICAgaWYgKCFoZWFkZXIgJiYgb3B0cy5kaXNjb3ZlcnlLZXkgJiYgIShvcHRzLmtleSB8fCBvcHRzLm1hbmlmZXN0KSkgewogICAgICB0aHJvdyBTVE9SQUdFX0VNUFRZKCdObyBIeXBlcmNvcmUgaXMgc3RvcmVkIGhlcmUnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICBpZiAoIWhlYWRlciB8fCBvdmVyd3JpdGUpIHsKICAgICAgaWYgKCFjcmVhdGVJZk1pc3NpbmcpIHsKICAgICAgICB0aHJvdyBTVE9SQUdFX0VNUFRZKCdObyBIeXBlcmNvcmUgaXMgc3RvcmVkIGhlcmUnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgICAgfQoKICAgICAgaWYgKGNvbXBhdCkgewogICAgICAgIGlmIChvcHRzLmtleSAmJiBvcHRzLmtleVBhaXIgJiYgIWI0YS5lcXVhbHMob3B0cy5rZXksIG9wdHMua2V5UGFpci5wdWJsaWNLZXkpKSB7CiAgICAgICAgICB0aHJvdyBCQURfQVJHVU1FTlQoJ0tleSBtdXN0IG1hdGNoIHB1YmxpY0tleSB3aGVuIGluIGNvbXBhdCBtb2RlJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCBrZXlQYWlyID0gb3B0cy5rZXlQYWlyIHx8IChvcHRzLmtleSA/IG51bGwgOiBjcnlwdG8ua2V5UGFpcigpKQoKICAgICAgY29uc3QgZGVmYXVsdE1hbmlmZXN0ID0KICAgICAgICAhb3B0cy5tYW5pZmVzdCAmJgogICAgICAgICghIW9wdHMuY29tcGF0IHx8ICFvcHRzLmtleSB8fCAhIShrZXlQYWlyICYmIGI0YS5lcXVhbHMob3B0cy5rZXksIGtleVBhaXIucHVibGljS2V5KSkpCiAgICAgIGNvbnN0IG1hbmlmZXN0ID0gZGVmYXVsdE1hbmlmZXN0CiAgICAgICAgPyBWZXJpZmllci5kZWZhdWx0U2lnbmVyTWFuaWZlc3Qob3B0cy5rZXkgfHwga2V5UGFpci5wdWJsaWNLZXkpCiAgICAgICAgOiBWZXJpZmllci5jcmVhdGVNYW5pZmVzdChvcHRzLm1hbmlmZXN0KQoKICAgICAgaGVhZGVyID0gewogICAgICAgIGtleTogb3B0cy5rZXkgfHwgKGNvbXBhdCA/IG1hbmlmZXN0LnNpZ25lcnNbMF0ucHVibGljS2V5IDogVmVyaWZpZXIubWFuaWZlc3RIYXNoKG1hbmlmZXN0KSksCiAgICAgICAgbWFuaWZlc3QsCiAgICAgICAga2V5UGFpcjoga2V5UGFpcgogICAgICAgICAgPyB7IHB1YmxpY0tleToga2V5UGFpci5wdWJsaWNLZXksIHNlY3JldEtleToga2V5UGFpci5zZWNyZXRLZXkgfHwgbnVsbCB9CiAgICAgICAgICA6IG51bGwsCiAgICAgICAgZnJvemVuOiBmYWxzZSwKICAgICAgICB0cmVlOiB7CiAgICAgICAgICBmb3JrOiAwLAogICAgICAgICAgbGVuZ3RoOiAwLAogICAgICAgICAgcm9vdEhhc2g6IG51bGwsCiAgICAgICAgICBzaWduYXR1cmU6IG51bGwKICAgICAgICB9LAogICAgICAgIGhpbnRzOiB7CiAgICAgICAgICByZW9yZ3M6IFtdLAogICAgICAgICAgY29udGlndW91c0xlbmd0aDogMCwKICAgICAgICAgIHJlbW90ZUNvbnRpZ3VvdXNMZW5ndGg6IDAKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IGRpc2NvdmVyeUtleSA9IG9wdHMuZGlzY292ZXJ5S2V5IHx8IGNyeXB0by5kaXNjb3ZlcnlLZXkoaGVhZGVyLmtleSkKCiAgICAgIHN0b3JhZ2UgPSBhd2FpdCB0aGlzLmRiLmNyZWF0ZUNvcmUoewogICAgICAgIGtleTogaGVhZGVyLmtleSwKICAgICAgICBtYW5pZmVzdCwKICAgICAgICBrZXlQYWlyLAogICAgICAgIGZyb3plbjogZmFsc2UsCiAgICAgICAgZGlzY292ZXJ5S2V5LAogICAgICAgIHVzZXJEYXRhOiBvcHRzLnVzZXJEYXRhIHx8IFtdLAogICAgICAgIGFsaWFzOiBvcHRzLmFsaWFzIHx8IG51bGwKICAgICAgfSkKICAgIH0KCiAgICAvLyB1bnNsYWIgdGhlIGxvbmcgbGl2ZWQgYnVmZmVycyB0byBhdm9pZCBrZWVwaW5nIHRoZSBzbGFiIGFsaXZlCiAgICBoZWFkZXIua2V5ID0gdW5zbGFiKGhlYWRlci5rZXkpCgogICAgaWYgKGhlYWRlci50cmVlKSB7CiAgICAgIGhlYWRlci50cmVlLnJvb3RIYXNoID0gdW5zbGFiKGhlYWRlci50cmVlLnJvb3RIYXNoKQogICAgICBoZWFkZXIudHJlZS5zaWduYXR1cmUgPSB1bnNsYWIoaGVhZGVyLnRyZWUuc2lnbmF0dXJlKQogICAgfQoKICAgIGlmIChoZWFkZXIua2V5UGFpcikgewogICAgICBoZWFkZXIua2V5UGFpci5wdWJsaWNLZXkgPSB1bnNsYWIoaGVhZGVyLmtleVBhaXIucHVibGljS2V5KQogICAgICBoZWFkZXIua2V5UGFpci5zZWNyZXRLZXkgPSB1bnNsYWIoaGVhZGVyLmtleVBhaXIuc2VjcmV0S2V5KQogICAgfQoKICAgIGlmIChoZWFkZXIua2V5UGFpcikgewogICAgICBoZWFkZXIua2V5UGFpci5wdWJsaWNLZXkgPSB1bnNsYWIoaGVhZGVyLmtleVBhaXIucHVibGljS2V5KQogICAgICBoZWFkZXIua2V5UGFpci5zZWNyZXRLZXkgPSB1bnNsYWIoaGVhZGVyLmtleVBhaXIuc2VjcmV0S2V5KQogICAgfQoKICAgIGlmIChvcHRzLm1hbmlmZXN0KSB7CiAgICAgIC8vIGlmIHdlIHByb3ZpZGUgYSBtYW5pZmVzdCBhbmQgbm8ga2V5LCB2ZXJpZnkgdGhhdCB0aGUgc3RvcmVkIGtleSBpcyB0aGUgc2FtZQogICAgICBpZiAoCiAgICAgICAgIW9wdHMua2V5ICYmCiAgICAgICAgIVZlcmlmaWVyLmlzVmFsaWRNYW5pZmVzdChoZWFkZXIua2V5LCBWZXJpZmllci5jcmVhdGVNYW5pZmVzdChvcHRzLm1hbmlmZXN0KSkKICAgICAgKSB7CiAgICAgICAgdGhyb3cgU1RPUkFHRV9DT05GTElDVCgnTWFuaWZlc3QgZG9lcyBub3QgaGFzaCB0byBwcm92aWRlZCBrZXknLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgICAgfQoKICAgICAgaWYgKCFoZWFkZXIubWFuaWZlc3QpIGhlYWRlci5tYW5pZmVzdCA9IG9wdHMubWFuaWZlc3QKICAgIH0KCiAgICBpZiAob3B0cy5rZXkgJiYgIWI0YS5lcXVhbHMoaGVhZGVyLmtleSwgb3B0cy5rZXkpKSB7CiAgICAgIHRocm93IFNUT1JBR0VfQ09ORkxJQ1QoJ0Fub3RoZXIgSHlwZXJjb3JlIGlzIHN0b3JlZCBoZXJlJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgLy8gaWYgd2Ugc2lnbmFsbGVkIGNvbXBhdCwgYnV0IGFscmVhZHkgbm93IHRoaXMgY29yZSBpc24ndCBkaXNhYmxlIGl0CiAgICBpZiAoY29tcGF0ICYmIGhlYWRlci5tYW5pZmVzdCAmJiAhVmVyaWZpZXIuaXNDb21wYXQoaGVhZGVyLmtleSwgaGVhZGVyLm1hbmlmZXN0KSkgewogICAgICBjb21wYXQgPSBmYWxzZQogICAgfSBlbHNlIGlmICghY29tcGF0ICYmIGhlYWRlci5tYW5pZmVzdCAmJiBWZXJpZmllci5pc0NvbXBhdChoZWFkZXIua2V5LCBoZWFkZXIubWFuaWZlc3QpKSB7CiAgICAgIGNvbXBhdCA9IHRydWUKICAgIH0KCiAgICBjb25zdCBwcm9sb2d1ZSA9IGhlYWRlci5tYW5pZmVzdCA/IGhlYWRlci5tYW5pZmVzdC5wcm9sb2d1ZSA6IG51bGwKCiAgICBjb25zdCBiaXRmaWVsZCA9IGF3YWl0IEJpdGZpZWxkLm9wZW4oc3RvcmFnZSwgaGVhZGVyLnRyZWUubGVuZ3RoKQoKICAgIGNvbnN0IHRyZWVJbmZvID0gewogICAgICBmb3JrOiBoZWFkZXIudHJlZS5mb3JrLAogICAgICBsZW5ndGg6IGhlYWRlci50cmVlLmxlbmd0aCwKICAgICAgc2lnbmF0dXJlOiBoZWFkZXIudHJlZS5zaWduYXR1cmUsCiAgICAgIHJvb3RzOiBoZWFkZXIudHJlZS5sZW5ndGgKICAgICAgICA/IGF3YWl0IE1lcmtsZVRyZWUuZ2V0Um9vdHNGcm9tU3RvcmFnZShzdG9yYWdlLCBoZWFkZXIudHJlZS5sZW5ndGgpCiAgICAgICAgOiBbXSwKICAgICAgcHJvbG9ndWUKICAgIH0KCiAgICBpZiAob3ZlcndyaXRlKSB7CiAgICAgIGNvbnN0IHR4ID0gc3RvcmFnZS53cml0ZSgpCiAgICAgIHR4LmRlbGV0ZVRyZWVOb2RlUmFuZ2UoMCwgLTEpCiAgICAgIHR4LmRlbGV0ZUJsb2NrUmFuZ2UoMCwgLTEpCiAgICAgIGJpdGZpZWxkLmNsZWFyKHR4KQogICAgICBhd2FpdCB0eC5mbHVzaCgpCiAgICB9CgogICAgY29uc3QgbGVuID0gYml0ZmllbGQuZmluZEZpcnN0KGZhbHNlLCBoZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCkKICAgIGlmIChoZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCAhPT0gbGVuICYmICFzdG9yYWdlLnJlYWRPbmx5KSB7CiAgICAgIGhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoID0gbGVuCiAgICAgIGNvbnN0IHR4ID0gc3RvcmFnZS53cml0ZSgpCiAgICAgIHR4LnNldEhpbnRzKGhlYWRlci5oaW50cykKICAgICAgYXdhaXQgdHguZmx1c2goKQogICAgfQoKICAgIC8vIHRvIHVuc2xhYgogICAgaWYgKGhlYWRlci5tYW5pZmVzdCkgewogICAgICBoZWFkZXIubWFuaWZlc3QgPSBWZXJpZmllci5jcmVhdGVNYW5pZmVzdChoZWFkZXIubWFuaWZlc3QpCiAgICAgIGlmICghaGFkTWFuaWZlc3QgfHwgKGhlYWRlci5rZXlQYWlyICYmICFoYWRLZXlQYWlyKSkgewogICAgICAgIGNvbnN0IHR4ID0gc3RvcmFnZS53cml0ZSgpCiAgICAgICAgdHguc2V0QXV0aCh7CiAgICAgICAgICBrZXk6IGhlYWRlci5rZXksCiAgICAgICAgICBkaXNjb3ZlcnlLZXk6IGNyeXB0by5kaXNjb3ZlcnlLZXkoaGVhZGVyLmtleSksCiAgICAgICAgICBtYW5pZmVzdDogaGVhZGVyLm1hbmlmZXN0LAogICAgICAgICAga2V5UGFpcjogaGVhZGVyLmtleVBhaXIKICAgICAgICB9KQogICAgICAgIGF3YWl0IHR4LmZsdXNoKCkKICAgICAgfQogICAgfQoKICAgIGNvbnN0IHZlcmlmaWVyID0gaGVhZGVyLm1hbmlmZXN0CiAgICAgID8gbmV3IFZlcmlmaWVyKGhlYWRlci5rZXksIGhlYWRlci5tYW5pZmVzdCwgeyBjcnlwdG8sIGxlZ2FjeSB9KQogICAgICA6IG51bGwKCiAgICB0aGlzLnN0b3JhZ2UgPSBzdG9yYWdlCiAgICB0aGlzLmhlYWRlciA9IGhlYWRlcgogICAgdGhpcy5jb21wYXQgPSBjb21wYXQKICAgIHRoaXMuYml0ZmllbGQgPSBiaXRmaWVsZAogICAgdGhpcy52ZXJpZmllciA9IHZlcmlmaWVyCiAgICB0aGlzLnN0YXRlID0gbmV3IFNlc3Npb25TdGF0ZSh0aGlzLCBudWxsLCBzdG9yYWdlLCB0cmVlSW5mbywgbnVsbCkKCiAgICBpZiAodGhpcy5rZXkgPT09IG51bGwpIHRoaXMua2V5ID0gdGhpcy5oZWFkZXIua2V5CiAgICBpZiAodGhpcy5kaXNjb3ZlcnlLZXkgPT09IG51bGwpIHRoaXMuZGlzY292ZXJ5S2V5ID0gY3J5cHRvLmRpc2NvdmVyeUtleSh0aGlzLmtleSkKICAgIGlmICh0aGlzLmlkID09PSBudWxsKSB0aGlzLmlkID0gejMyLmVuY29kZSh0aGlzLmtleSkKICAgIGlmICh0aGlzLm1hbmlmZXN0ID09PSBudWxsKSB0aGlzLm1hbmlmZXN0ID0gdGhpcy5oZWFkZXIubWFuaWZlc3QKICB9CgogIGFzeW5jIGF1ZGl0KG9wdHMpIHsKICAgIGF3YWl0IHRoaXMuc3RhdGUubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IGF1ZGl0KHRoaXMsIG9wdHMpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLnN0YXRlLl91bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgc2V0TWFuaWZlc3QobWFuaWZlc3QpIHsKICAgIGF3YWl0IHRoaXMuc3RhdGUubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgaWYgKG1hbmlmZXN0ICYmIHRoaXMuaGVhZGVyLm1hbmlmZXN0ID09PSBudWxsKSB7CiAgICAgICAgaWYgKCFWZXJpZmllci5pc1ZhbGlkTWFuaWZlc3QodGhpcy5oZWFkZXIua2V5LCBtYW5pZmVzdCkpIHsKICAgICAgICAgIHRocm93IElOVkFMSURfQ0hFQ0tTVU0oJ01hbmlmZXN0IGhhc2ggZG9lcyBub3QgbWF0Y2gnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgICAgICB9CgogICAgICAgIGNvbnN0IHR4ID0gdGhpcy5zdGF0ZS5jcmVhdGVXcml0ZUJhdGNoKCkKICAgICAgICB0aGlzLl9zZXRNYW5pZmVzdCh0eCwgVmVyaWZpZXIuY3JlYXRlTWFuaWZlc3QobWFuaWZlc3QpLCBudWxsKQogICAgICAgIGF3YWl0IHRoaXMuc3RhdGUuZmx1c2goKQogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLnN0YXRlLl91bmxvY2soKQogICAgfQogIH0KCiAgX3NldE1hbmlmZXN0KHR4LCBtYW5pZmVzdCwga2V5UGFpcikgewogICAgaWYgKCFtYW5pZmVzdCAmJiBiNGEuZXF1YWxzKGtleVBhaXIucHVibGljS2V5LCB0aGlzLmhlYWRlci5rZXkpKSB7CiAgICAgIG1hbmlmZXN0ID0gVmVyaWZpZXIuZGVmYXVsdFNpZ25lck1hbmlmZXN0KHRoaXMuaGVhZGVyLmtleSkKICAgIH0KICAgIGlmICghbWFuaWZlc3QpIHJldHVybgoKICAgIGNvbnN0IHZlcmlmaWVyID0gbmV3IFZlcmlmaWVyKHRoaXMuaGVhZGVyLmtleSwgbWFuaWZlc3QsIHsgbGVnYWN5OiB0aGlzLl9sZWdhY3kgfSkKCiAgICBpZiAodmVyaWZpZXIucHJvbG9ndWUpIHRoaXMuc3RhdGUucHJvbG9ndWUgPSBPYmplY3QuYXNzaWduKHt9LCB2ZXJpZmllci5wcm9sb2d1ZSkKCiAgICB0aGlzLm1hbmlmZXN0ID0gdGhpcy5oZWFkZXIubWFuaWZlc3QgPSBtYW5pZmVzdAoKICAgIHR4LnNldEF1dGgoewogICAgICBrZXk6IHRoaXMuaGVhZGVyLmtleSwKICAgICAgZGlzY292ZXJ5S2V5OiB0aGlzLmRpc2NvdmVyeUtleSwKICAgICAgbWFuaWZlc3QsCiAgICAgIGtleVBhaXI6IHRoaXMuaGVhZGVyLmtleVBhaXIKICAgICAgLy8gVE9ETzogZW5jcnlwdGlvbktleT8KICAgIH0pCgogICAgdGhpcy5jb21wYXQgPSB2ZXJpZmllci5jb21wYXQKICAgIHRoaXMudmVyaWZpZXIgPSB2ZXJpZmllcgoKICAgIHRoaXMucmVwbGljYXRvci5vbnVwZ3JhZGUoKQogICAgdGhpcy5lbWl0TWFuaWZlc3QoKQogIH0KCiAgYXN5bmMgY29weVByb2xvZ3VlKHNyYykgewogICAgYXdhaXQgdGhpcy5zdGF0ZS5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBhd2FpdCBzcmMubXV0ZXgubG9jaygpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5zdGF0ZS5tdXRleC51bmxvY2soKQogICAgICB0aHJvdyBlcnIKICAgIH0KCiAgICB0cnkgewogICAgICBhd2FpdCBjb3B5UHJvbG9ndWUoc3JjLCB0aGlzKQogICAgfSBmaW5hbGx5IHsKICAgICAgc3JjLm11dGV4LnVubG9jaygpCiAgICAgIHRoaXMuc3RhdGUubXV0ZXgudW5sb2NrKCkKICAgICAgdGhpcy5jaGVja0lmSWRsZSgpCiAgICB9CiAgfQoKICBmbHVzaGVkKCkgewogICAgcmV0dXJuIHRoaXMuc3RhdGUuZmx1c2hlZCgpCiAgfQoKICBhc3luYyBfdmFsaWRhdGVDb21taXQoc3RhdGUsIHRyZWVMZW5ndGgpIHsKICAgIGlmICh0aGlzLnN0YXRlLmxlbmd0aCA+IHN0YXRlLmxlbmd0aCkgewogICAgICByZXR1cm4gZmFsc2UgLy8gVE9ETzogcGFydGlhbCBjb21taXQgYW5kIHRydW5jYXRpb24gcG9zc2libGUgaW4gdGhlIGZ1dHVyZQogICAgfQoKICAgIGlmICh0aGlzLnN0YXRlLmxlbmd0aCA+IHRyZWVMZW5ndGgpIHsKICAgICAgZm9yIChjb25zdCByb290IG9mIHRoaXMuc3RhdGUucm9vdHMpIHsKICAgICAgICBjb25zdCBiYXRjaFJvb3QgPSBhd2FpdCBNZXJrbGVUcmVlLmdldChzdGF0ZSwgcm9vdC5pbmRleCkKICAgICAgICBpZiAoYmF0Y2hSb290LnNpemUgIT09IHJvb3Quc2l6ZSB8fCAhYjRhLmVxdWFscyhiYXRjaFJvb3QuaGFzaCwgcm9vdC5oYXNoKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMudmVyaWZpZXIgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIGZhbHNlIC8vIGVhc2llciB0byBhc3NlcnQgdGhhbiB1cHNlcnQKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3ZlcmlmeUJhdGNoVXBncmFkZShiYXRjaCwgbWFuaWZlc3QpIHsKICAgIGlmICghdGhpcy5oZWFkZXIubWFuaWZlc3QpIHsKICAgICAgLy8gY29tcGF0LCBkcm9wIGF0IHNvbWUgcG9pbnQKICAgICAgaWYgKCFtYW5pZmVzdCkgbWFuaWZlc3QgPSBWZXJpZmllci5kZWZhdWx0U2lnbmVyTWFuaWZlc3QodGhpcy5oZWFkZXIua2V5KQoKICAgICAgaWYgKAogICAgICAgICFtYW5pZmVzdCB8fAogICAgICAgICEoCiAgICAgICAgICBWZXJpZmllci5pc1ZhbGlkTWFuaWZlc3QodGhpcy5oZWFkZXIua2V5LCBtYW5pZmVzdCkgfHwKICAgICAgICAgIFZlcmlmaWVyLmlzQ29tcGF0KHRoaXMuaGVhZGVyLmtleSwgbWFuaWZlc3QpCiAgICAgICAgKQogICAgICApIHsKICAgICAgICB0aHJvdyBJTlZBTElEX1NJR05BVFVSRSgnUHJvb2YgY29udGFpbnMgYW4gaW52YWxpZCBtYW5pZmVzdCcsIHRoaXMuZGlzY292ZXJ5S2V5KSAvLyBUT0RPOiBwcm9wZXIgZXJyb3IgdHlwZQogICAgICB9CiAgICB9CgogICAgY29uc3QgdmVyaWZpZXIgPQogICAgICB0aGlzLnZlcmlmaWVyIHx8CiAgICAgIG5ldyBWZXJpZmllcih0aGlzLmhlYWRlci5rZXksIFZlcmlmaWVyLmNyZWF0ZU1hbmlmZXN0KG1hbmlmZXN0KSwgeyBsZWdhY3k6IHRoaXMuX2xlZ2FjeSB9KQoKICAgIGlmICghdmVyaWZpZXIudmVyaWZ5KGJhdGNoLCBiYXRjaC5zaWduYXR1cmUpKSB7CiAgICAgIHRocm93IElOVkFMSURfU0lHTkFUVVJFKCdQcm9vZiBjb250YWlucyBhbiBpbnZhbGlkIHNpZ25hdHVyZScsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIHJldHVybiBtYW5pZmVzdAogIH0KCiAgYXN5bmMgX3ZlcmlmeUV4Y2x1c2l2ZSh7IGJhdGNoLCBiaXRmaWVsZCwgdmFsdWUsIG1hbmlmZXN0IH0pIHsKICAgIG1hbmlmZXN0ID0gdGhpcy5fdmVyaWZ5QmF0Y2hVcGdyYWRlKGJhdGNoLCBtYW5pZmVzdCkKCiAgICBpZiAoCiAgICAgICEoYXdhaXQgdGhpcy5zdGF0ZS5fdmVyaWZ5QmxvY2soCiAgICAgICAgYmF0Y2gsCiAgICAgICAgYml0ZmllbGQsCiAgICAgICAgdmFsdWUsCiAgICAgICAgdGhpcy5oZWFkZXIubWFuaWZlc3QgPyBudWxsIDogbWFuaWZlc3QKICAgICAgKSkKICAgICkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBpZiAoIWJhdGNoLnVwZ3JhZGVkICYmIGJpdGZpZWxkKSB7CiAgICAgIHRoaXMucmVwbGljYXRvci5vbmhhdmUoYml0ZmllbGQuc3RhcnQsIGJpdGZpZWxkLmxlbmd0aCwgYml0ZmllbGQuZHJvcCkKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgX3ZlcmlmeVNoYXJlZCgpIHsKICAgIGlmICghdGhpcy5fdmVyaWZpZXMubGVuZ3RoKSByZXR1cm4gZmFsc2UKCiAgICBhd2FpdCB0aGlzLnN0YXRlLm11dGV4LmxvY2soKQoKICAgIGNvbnN0IHR4ID0gdGhpcy5zdGF0ZS5jcmVhdGVXcml0ZUJhdGNoKCkKCiAgICBjb25zdCB2ZXJpZmllcyA9IHRoaXMuX3ZlcmlmaWVzCiAgICB0aGlzLl92ZXJpZmllcyA9IG51bGwKICAgIHRoaXMuX3ZlcmlmaWVkID0gbnVsbAoKICAgIHRyeSB7CiAgICAgIGZvciAoY29uc3QgeyBiYXRjaCwgYml0ZmllbGQsIHZhbHVlIH0gb2YgdmVyaWZpZXMpIHsKICAgICAgICBpZiAoIWJhdGNoLmNvbW1pdGFibGUoKSkgY29udGludWUKCiAgICAgICAgaWYgKGJpdGZpZWxkKSB7CiAgICAgICAgICB0eC5wdXRCbG9jayhiaXRmaWVsZC5zdGFydCwgdmFsdWUpCiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCBiaXRzID0gbmV3IEJpdEludGVybHVkZSgpCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcmlmaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgeyBiYXRjaCwgYml0ZmllbGQsIG1hbmlmZXN0IH0gPSB2ZXJpZmllc1tpXQoKICAgICAgICBpZiAoIWJhdGNoLmNvbW1pdGFibGUoKSkgewogICAgICAgICAgdmVyaWZpZXNbaV0gPSBudWxsIC8vIHNpZ25hbCB0aGF0IHdlIGNhbm5vdCBjb21taXQgdGhpcyBvbmUKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQoKICAgICAgICBpZiAoYml0ZmllbGQpIHsKICAgICAgICAgIGJpdHMuc2V0UmFuZ2UoYml0ZmllbGQuc3RhcnQsIGJpdGZpZWxkLnN0YXJ0ICsgMSwgdHJ1ZSkKICAgICAgICB9CgogICAgICAgIC8vIGlmIHdlIGdvdCBhIG1hbmlmZXN0IEFORCBpdHMgc3RyaWN0bHkgYSBub24gY29tcGF0IG9uZSwgbGV0cyBzdG9yZSBpdAogICAgICAgIGlmIChtYW5pZmVzdCAmJiB0aGlzLmhlYWRlci5tYW5pZmVzdCA9PT0gbnVsbCkgewogICAgICAgICAgaWYgKCFWZXJpZmllci5pc1ZhbGlkTWFuaWZlc3QodGhpcy5oZWFkZXIua2V5LCBtYW5pZmVzdCkpIHsKICAgICAgICAgICAgdGhyb3cgSU5WQUxJRF9DSEVDS1NVTSgnTWFuaWZlc3QgaGFzaCBkb2VzIG5vdCBtYXRjaCcsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgICAgICAgfQogICAgICAgICAgdGhpcy5fc2V0TWFuaWZlc3QodHgsIG1hbmlmZXN0LCBudWxsKQogICAgICAgIH0KCiAgICAgICAgaWYgKGJhdGNoLmNvbW1pdGFibGUoKSkgYmF0Y2guY29tbWl0KHR4KQogICAgICB9CgogICAgICBjb25zdCByYW5nZXMgPSBiaXRzLmZsdXNoKHR4LCB0aGlzLmJpdGZpZWxkKQoKICAgICAgYXdhaXQgdGhpcy5zdGF0ZS5mbHVzaCgpCgogICAgICBmb3IgKGNvbnN0IHsgc3RhcnQsIGVuZCwgdmFsdWUgfSBvZiByYW5nZXMpIHsKICAgICAgICB0aGlzLl9zZXRCaXRmaWVsZFJhbmdlcyhzdGFydCwgZW5kLCB2YWx1ZSkKICAgICAgfQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2ZXJpZmllcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGJpdGZpZWxkID0gdmVyaWZpZXNbaV0gJiYgdmVyaWZpZXNbaV0uYml0ZmllbGQKICAgICAgICBpZiAoYml0ZmllbGQpIHsKICAgICAgICAgIHRoaXMudXBkYXRlQ29udGlndW91c0xlbmd0aChiaXRmaWVsZCkKICAgICAgICAgIHRoaXMucmVwbGljYXRvci5vbmhhdmUoYml0ZmllbGQuc3RhcnQsIGJpdGZpZWxkLmxlbmd0aCwgYml0ZmllbGQuZHJvcCkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmhpbnRzQ2hhbmdlZCkgYXdhaXQgdGhpcy5mbHVzaEhpbnRzKCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuc3RhdGUuX2NsZWFyQWN0aXZlQmF0Y2goKQogICAgICB0aGlzLnN0YXRlLm11dGV4LnVubG9jaygpCiAgICB9CgogICAgcmV0dXJuIHZlcmlmaWVzWzBdICE9PSBudWxsCiAgfQoKICBhc3luYyBmbHVzaEhpbnRzKCkgewogICAgaWYgKCF0aGlzLmhpbnRzQ2hhbmdlZCkgcmV0dXJuCiAgICB0aGlzLmhpbnRzQ2hhbmdlZCA9IGZhbHNlIC8vIHdlIHVuc2V0IHRoaXMgaW1tZWRpYXRlbHkgYXMgYSAiZGVib3VuY2UiCgogICAgY29uc3QgdHggPSB0aGlzLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQoKICAgIHR4LnNldEhpbnRzKHsKICAgICAgY29udGlndW91c0xlbmd0aDogdGhpcy5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCwKICAgICAgcmVtb3RlQ29udGlndW91c0xlbmd0aDogdGhpcy5oZWFkZXIuaGludHMucmVtb3RlQ29udGlndW91c0xlbmd0aAogICAgfSkKCiAgICBhd2FpdCB0eC5mbHVzaCgpCiAgfQoKICBhc3luYyBjaGVja0NvbmZsaWN0KHByb29mLCBmcm9tKSB7CiAgICBpZiAodGhpcy5zdGF0ZS5sZW5ndGggPCBwcm9vZi51cGdyYWRlLmxlbmd0aCB8fCBwcm9vZi5mb3JrICE9PSB0aGlzLnN0YXRlLmZvcmspIHsKICAgICAgLy8gb3V0IG9mIGRhdGUgdGhpcyBwcm9vZiAtIGlnbm9yZSBmb3Igbm93CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIC8vIHNhbml0eSBjaGVjayAtPiBubyBtYW5pZmVzdCwgbm8gd2F5IHRvIHZlcmlmeQogICAgaWYgKCF0aGlzLmhlYWRlci5tYW5pZmVzdCkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBjb25zdCBiYXRjaCA9IE1lcmtsZVRyZWUudmVyaWZ5RnVsbHlSZW1vdGUodGhpcy5zdGF0ZSwgcHJvb2YpCgogICAgdHJ5IHsKICAgICAgdGhpcy5fdmVyaWZ5QmF0Y2hVcGdyYWRlKGJhdGNoLCBwcm9vZi5tYW5pZmVzdCkKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGNvbnN0IHJvb3RzID0gYXdhaXQgTWVya2xlVHJlZS5nZXRSb290c0Zyb21TdG9yYWdlKHRoaXMuc3RvcmFnZSwgcHJvb2YudXBncmFkZS5sZW5ndGgpCiAgICBjb25zdCByZW1vdGVUcmVlSGFzaCA9IGNyeXB0by50cmVlKHByb29mLnVwZ3JhZGUubm9kZXMpCiAgICBjb25zdCBsb2NhbFRyZWVIYXNoID0gY3J5cHRvLnRyZWUocm9vdHMpCgogICAgdHJ5IHsKICAgICAgY29uc3QgcnggPSB0aGlzLnN0YXRlLnN0b3JhZ2UucmVhZCgpCiAgICAgIGNvbnN0IHRyZWVQcm9vZlByb21pc2UgPSBNZXJrbGVUcmVlLnByb29mKHRoaXMuc3RhdGUsIHJ4LCB7CiAgICAgICAgYmxvY2s6IG51bGwsCiAgICAgICAgaGFzaDogbnVsbCwKICAgICAgICBzZWVrOiBudWxsLAogICAgICAgIHVwZ3JhZGU6IHsKICAgICAgICAgIHN0YXJ0OiAwLAogICAgICAgICAgbGVuZ3RoOiBwcm9vZi51cGdyYWRlLmxlbmd0aAogICAgICAgIH0KICAgICAgfSkKCiAgICAgIHJ4LnRyeUZsdXNoKCkKCiAgICAgIGNvbnN0IHRyZWVQcm9vZiA9IGF3YWl0IHRyZWVQcm9vZlByb21pc2UKCiAgICAgIGNvbnN0IHZlcmlmeUJhdGNoID0gTWVya2xlVHJlZS52ZXJpZnlGdWxseVJlbW90ZSh0aGlzLnN0YXRlLCBhd2FpdCB0cmVlUHJvb2Yuc2V0dGxlKCkpCiAgICAgIHRoaXMuX3ZlcmlmeUJhdGNoVXBncmFkZSh2ZXJpZnlCYXRjaCwgdGhpcy5oZWFkZXIubWFuaWZlc3QpCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICAvLyBib3RoIHByb29mcyBhcmUgdmFsaWQsIG5vdyBjaGVjayBpZiB0aGV5IGZvcmtlZAogICAgaWYgKGI0YS5lcXVhbHMobG9jYWxUcmVlSGFzaCwgcmVtb3RlVHJlZUhhc2gpKSByZXR1cm4gZmFsc2UKCiAgICBhd2FpdCB0aGlzLnN0YXRlLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHR4ID0gdGhpcy5zdGF0ZS5jcmVhdGVXcml0ZUJhdGNoKCkKCiAgICAgIHRoaXMuaGVhZGVyLmZyb3plbiA9IHRydWUKCiAgICAgIHR4LnNldEF1dGgoewogICAgICAgIGtleTogdGhpcy5oZWFkZXIua2V5LAogICAgICAgIGRpc2NvdmVyeUtleTogdGhpcy5kaXNjb3ZlcnlLZXksCiAgICAgICAgbWFuaWZlc3Q6IHRoaXMuaGVhZGVyLm1hbmlmZXN0LAogICAgICAgIGtleVBhaXI6IHRoaXMuaGVhZGVyLmtleVBhaXIsCiAgICAgICAgZnJvemVuOiB0cnVlCiAgICAgIH0pCgogICAgICBhd2FpdCB0aGlzLnN0YXRlLmZsdXNoKCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuc3RhdGUubXV0ZXgudW5sb2NrKCkKICAgIH0KCiAgICAvLyB0bXAgbG9nIHNvIHdlIGNhbiBzZWUgdGhlc2UKICAgIGNvbnN0IGlkID0gYjRhLnRvU3RyaW5nKHRoaXMuZGlzY292ZXJ5S2V5LCAnaGV4JykKICAgIGNvbnNvbGUubG9nKAogICAgICAnW2h5cGVyY29yZV0gY29uZmxpY3QgZGV0ZWN0ZWQgaW4gJyArCiAgICAgICAgaWQgKwogICAgICAgICcgKHdyaXRhYmxlPScgKwogICAgICAgICEhdGhpcy5oZWFkZXIua2V5UGFpciArCiAgICAgICAgJyxxdW9ydW09JyArCiAgICAgICAgdGhpcy5oZWFkZXIubWFuaWZlc3QucXVvcnVtICsKICAgICAgICAnKScKICAgICkKICAgIGF3YWl0IHRoaXMuX29uY29uZmxpY3QocHJvb2YpCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgdmVyaWZ5UmVvcmcocHJvb2YpIHsKICAgIGNvbnN0IGJhdGNoID0gbmV3IFJlb3JnQmF0Y2godGhpcy5zdGF0ZSkKICAgIGF3YWl0IE1lcmtsZVRyZWUucmVvcmcodGhpcy5zdGF0ZSwgcHJvb2YsIGJhdGNoKQogICAgY29uc3QgbWFuaWZlc3QgPSB0aGlzLl92ZXJpZnlCYXRjaFVwZ3JhZGUoYmF0Y2gsIHByb29mLm1hbmlmZXN0KQoKICAgIGlmIChtYW5pZmVzdCAmJiAhdGhpcy5oZWFkZXIubWFuaWZlc3QpIHsKICAgICAgYXdhaXQgdGhpcy5zdGF0ZS5tdXRleC5sb2NrKCkKICAgICAgdHJ5IHsKICAgICAgICBpZiAobWFuaWZlc3QgJiYgdGhpcy5oZWFkZXIubWFuaWZlc3QgPT09IG51bGwpIHsKICAgICAgICAgIGNvbnN0IHR4ID0gdGhpcy5zdGF0ZS5jcmVhdGVXcml0ZUJhdGNoKCkKICAgICAgICAgIHRoaXMuX3NldE1hbmlmZXN0KHR4LCBWZXJpZmllci5jcmVhdGVNYW5pZmVzdChtYW5pZmVzdCksIG51bGwpCiAgICAgICAgICBhd2FpdCB0aGlzLnN0YXRlLmZsdXNoKCkKICAgICAgICB9CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgdGhpcy5zdGF0ZS5fdW5sb2NrKCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBiYXRjaAogIH0KCiAgYXN5bmMgdmVyaWZ5KHByb29mLCBmcm9tKSB7CiAgICAvLyBXZSBjYW5ub3QgYXBwbHkgIm90aGVyIGZvcmtzIiBhdG0uCiAgICAvLyBXZSBzaG91bGQgcHJvYmFibHkgc3RpbGwgdHJ5IGFuZCB0aGV5IGFyZSBsaWtlbHkgc3VwZXIgc2ltaWxhciBmb3Igbm9uIHVwZ3JhZGVzCiAgICAvLyBidXQgdGhpcyBpcyBlYXN5IGF0bSAoYW5kIHRoZSBhYm92ZSBsYXllciB3aWxsIGp1c3QgcmV0cnkpCiAgICBpZiAocHJvb2YuZm9yayAhPT0gdGhpcy5zdGF0ZS5mb3JrKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBiYXRjaCA9IGF3YWl0IE1lcmtsZVRyZWUudmVyaWZ5KHRoaXMuc3RhdGUsIHByb29mKQoKICAgIGlmIChiYXRjaC51cGdyYWRlZCAmJiBiYXRjaC5sZW5ndGggPD0gdGhpcy5zdGF0ZS5sZW5ndGgpIHsKICAgICAgYXdhaXQgYmF0Y2guZG93bmdyYWRlKCkKICAgIH0KCiAgICBpZiAoIWJhdGNoLmNvbW1pdGFibGUoKSkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBjb25zdCB2YWx1ZSA9IChwcm9vZi5ibG9jayAmJiBwcm9vZi5ibG9jay52YWx1ZSkgfHwgbnVsbAogICAgY29uc3Qgb3AgPSB7CiAgICAgIGJhdGNoLAogICAgICBiaXRmaWVsZDogdmFsdWUgJiYgeyBkcm9wOiBmYWxzZSwgc3RhcnQ6IHByb29mLmJsb2NrLmluZGV4LCBsZW5ndGg6IDEgfSwKICAgICAgdmFsdWUsCiAgICAgIG1hbmlmZXN0OiBwcm9vZi5tYW5pZmVzdCwKICAgICAgZnJvbQogICAgfQoKICAgIGlmIChiYXRjaC51cGdyYWRlZCkgewogICAgICByZXR1cm4gdGhpcy5fdmVyaWZ5RXhjbHVzaXZlKG9wKQogICAgfQoKICAgIGlmICh0aGlzLl92ZXJpZmllcyAhPT0gbnVsbCkgewogICAgICBjb25zdCB2ZXJpZmllcyA9IHRoaXMuX3ZlcmlmaWVzCiAgICAgIGNvbnN0IGkgPSB2ZXJpZmllcy5wdXNoKG9wKQogICAgICBhd2FpdCB0aGlzLl92ZXJpZmllZAogICAgICByZXR1cm4gdmVyaWZpZXNbaV0gIT09IG51bGwKICAgIH0KCiAgICB0aGlzLl92ZXJpZmllcyA9IFtvcF0KICAgIHRoaXMuX3ZlcmlmaWVkID0gdGhpcy5fdmVyaWZ5U2hhcmVkKCkKCiAgICByZXR1cm4gdGhpcy5fdmVyaWZpZWQKICB9CgogIGFzeW5jIHJlb3JnKGJhdGNoKSB7CiAgICBpZiAoIWJhdGNoLmNvbW1pdGFibGUoKSkgcmV0dXJuIGZhbHNlCgogICAgdGhpcy50cnVuY2F0aW5nKysKCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLnN0YXRlLnJlb3JnKGJhdGNoKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy50cnVuY2F0aW5nLS0KICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgb3BlblNraXBCaXRmaWVsZCgpIHsKICAgIGlmICh0aGlzLnNraXBCaXRmaWVsZCAhPT0gbnVsbCkgcmV0dXJuIHRoaXMuc2tpcEJpdGZpZWxkCiAgICB0aGlzLnNraXBCaXRmaWVsZCA9IG5ldyBSZW1vdGVCaXRmaWVsZCgpCiAgICBjb25zdCBidWYgPSB0aGlzLmJpdGZpZWxkLnRvQnVmZmVyKHRoaXMuc3RhdGUubGVuZ3RoKQogICAgY29uc3QgYml0ZmllbGQgPSBuZXcgVWludDMyQXJyYXkoYnVmLmJ1ZmZlciwgYnVmLmJ5dGVPZmZzZXQsIGJ1Zi5ieXRlTGVuZ3RoIC8gNCkKICAgIHRoaXMuc2tpcEJpdGZpZWxkLmluc2VydCgwLCBiaXRmaWVsZCkKICAgIHJldHVybiB0aGlzLnNraXBCaXRmaWVsZAogIH0KCiAgX3NldEJpdGZpZWxkUmFuZ2VzKHN0YXJ0LCBlbmQsIHZhbHVlKSB7CiAgICB0aGlzLmJpdGZpZWxkLnNldFJhbmdlKHN0YXJ0LCBlbmQsIHZhbHVlKQogICAgaWYgKHRoaXMuc2tpcEJpdGZpZWxkICE9PSBudWxsKSB0aGlzLnNraXBCaXRmaWVsZC5zZXRSYW5nZShzdGFydCwgZW5kLCB2YWx1ZSkKICB9CgogIGNsb3NlKCkgewogICAgaWYgKCF0aGlzLmNsb3NpbmcpIHRoaXMuY2xvc2luZyA9IHRoaXMuX2Nsb3NlKCkKICAgIHJldHVybiB0aGlzLmNsb3NpbmcKICB9CgogIHVwZGF0ZUNvbnRpZ3VvdXNMZW5ndGgoYml0ZmllbGQpIHsKICAgIGNvbnN0IGNvbnRpZyA9IHVwZGF0ZUNvbnRpZ0JhdGNoKHRoaXMuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgsIGJpdGZpZWxkLCB0aGlzLmJpdGZpZWxkKQoKICAgIGlmIChjb250aWcubGVuZ3RoICE9PSAtMSAmJiBjb250aWcubGVuZ3RoICE9PSB0aGlzLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoKSB7CiAgICAgIHRoaXMuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGggPSBjb250aWcubGVuZ3RoCiAgICAgIHRoaXMuaGludHNDaGFuZ2VkID0gdHJ1ZQogICAgfQogIH0KCiAgdXBkYXRlUmVtb3RlQ29udGlndW91c0xlbmd0aChsZW5ndGgpIHsKICAgIHRoaXMuaGVhZGVyLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGggPSBsZW5ndGgKICAgIHRoaXMuaGludHNDaGFuZ2VkID0gdHJ1ZQoKICAgIGZvciAobGV0IGkgPSB0aGlzLm1vbml0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIHRoaXMubW9uaXRvcnNbaV0uZW1pdCgncmVtb3RlLWNvbnRpZ3VvdXMtbGVuZ3RoJywgbGVuZ3RoKQogICAgfQogIH0KCiAgb25hcHBlbmQodHJlZSwgYml0ZmllbGQpIHsKICAgIHRoaXMuaGVhZGVyLnRyZWUgPSB0cmVlCgogICAgaWYgKCFiaXRmaWVsZCkgewogICAgICB0aGlzLnJlcGxpY2F0b3Iub251cGdyYWRlKCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5yZXBsaWNhdG9yLmNvcmsoKQoKICAgIGNvbnN0IHsgc3RhcnQsIGxlbmd0aCwgZHJvcCB9ID0gYml0ZmllbGQKCiAgICB0aGlzLl9zZXRCaXRmaWVsZFJhbmdlcyhzdGFydCwgc3RhcnQgKyBsZW5ndGgsIHRydWUpCiAgICB0aGlzLnVwZGF0ZUNvbnRpZ3VvdXNMZW5ndGgoeyBzdGFydCwgbGVuZ3RoLCBkcm9wOiBmYWxzZSB9KQoKICAgIHRoaXMucmVwbGljYXRvci5vbnVwZ3JhZGUoKQogICAgdGhpcy5yZXBsaWNhdG9yLm9uaGF2ZShzdGFydCwgbGVuZ3RoLCBkcm9wKQogICAgdGhpcy5yZXBsaWNhdG9yLnVuY29yaygpCiAgfQoKICBvbnRydW5jYXRlKHRyZWUsIHsgc3RhcnQsIGxlbmd0aCB9KSB7CiAgICBpZiAodHJlZSkgdGhpcy5oZWFkZXIudHJlZSA9IHRyZWUKCiAgICB0aGlzLnJlcGxpY2F0b3IuY29yaygpCgogICAgdGhpcy5yZXBsaWNhdG9yLm9udHJ1bmNhdGUoc3RhcnQsIGxlbmd0aCkKICAgIHRoaXMucmVwbGljYXRvci5vbmhhdmUoc3RhcnQsIGxlbmd0aCwgdHJ1ZSkKICAgIHRoaXMucmVwbGljYXRvci5vbnVwZ3JhZGUoKQogICAgdGhpcy5yZXBsaWNhdG9yLnVuY29yaygpCgogICAgZm9yIChjb25zdCBzZXNzaW9uU3RhdGUgb2YgdGhpcy5zZXNzaW9uU3RhdGVzKSB7CiAgICAgIGlmIChzdGFydCA8IHNlc3Npb25TdGF0ZS5zbmFwc2hvdENvbXBhdExlbmd0aCkgc2Vzc2lvblN0YXRlLnNuYXBzaG90Q29tcGF0TGVuZ3RoID0gc3RhcnQKICAgIH0KCiAgICB0aGlzLl9zZXRCaXRmaWVsZFJhbmdlcyhzdGFydCwgc3RhcnQgKyBsZW5ndGgsIGZhbHNlKQogICAgdGhpcy51cGRhdGVDb250aWd1b3VzTGVuZ3RoKHsgc3RhcnQsIGxlbmd0aCwgZHJvcDogdHJ1ZSB9KQogIH0KCiAgYXN5bmMgX29uY29uZmxpY3QocHJvb2YpIHsKICAgIGF3YWl0IHRoaXMucmVwbGljYXRvci5vbmNvbmZsaWN0KCkKCiAgICBmb3IgKGxldCBpID0gdGhpcy5tb25pdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBzID0gdGhpcy5tb25pdG9yc1tpXQogICAgICBzLmVtaXQoJ2NvbmZsaWN0JywgcHJvb2YudXBncmFkZS5sZW5ndGgsIHByb29mLmZvcmssIHByb29mKQogICAgfQoKICAgIGNvbnN0IGVyciA9IG5ldyBFcnJvcignVHdvIGNvbmZsaWN0aW5nIHNpZ25hdHVyZXMgZXhpc3QgZm9yIGxlbmd0aCAnICsgcHJvb2YudXBncmFkZS5sZW5ndGgpCiAgICBhd2FpdCB0aGlzLmNsb3NlQWxsU2Vzc2lvbnMoZXJyKQogIH0KCiAgYXN5bmMgY2xvc2VBbGxTZXNzaW9ucyhlcnIpIHsKICAgIC8vIHRoaXMuc2Vzc2lvbnMgbW9kaWZpZXMgaXRzZWxmIHdoZW4gYSBzZXNzaW9uIGNsb3NlcwogICAgLy8gVGhpcyB3YXkgd2UgZW5zdXJlIHdlIGluZGVlZCBpdGVyYXRlIG92ZXIgYWxsIHNlc3Npb25zCiAgICBjb25zdCBzZXNzaW9ucyA9IHRoaXMuYWxsU2Vzc2lvbnMoKQoKICAgIGNvbnN0IGFsbCA9IFtdCiAgICBmb3IgKGNvbnN0IHMgb2Ygc2Vzc2lvbnMpIGFsbC5wdXNoKHMuY2xvc2UoeyBlcnJvcjogZXJyLCBmb3JjZTogZmFsc2UgfSkpIC8vIGZvcmNlIGZhbHNlIG9yIGVsc2UgaW5maW5pdGUgcmVjdXJzaW9uCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoYWxsKQogIH0KCiAgYXN5bmMgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCA9PT0gdHJ1ZSkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKCiAgICBpZiAodGhpcy5oYXNTZXNzaW9uKCkgPT09IHRydWUpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGRlc3Ryb3kgd2hpbGUgc2Vzc2lvbnMgYXJlIG9wZW4nKQoKICAgIGNvbnN0IHdlYWtTZXNzaW9ucyA9IHRoaXMuYWxsU2Vzc2lvbnMoKQoKICAgIGlmICh0aGlzLnJlcGxpY2F0b3IpIHRoaXMucmVwbGljYXRvci5kZXN0cm95KCkKICAgIGlmICh0aGlzLnN0YXRlKSBhd2FpdCB0aGlzLnN0YXRlLmNsb3NlKCkKCiAgICAvLyBjbG9zZSBhbGwgcGVuZGluZyB3ZWFrIHNlc3Npb25zLi4uCiAgICBmb3IgKGNvbnN0IHMgb2Ygd2Vha1Nlc3Npb25zKSBzLmNsb3NlKCkuY2F0Y2gobm9vcCkKICB9CgogIGFzeW5jIF9jbG9zZSgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgaWYgKHRoaXMuaGFzU2Vzc2lvbigpID09PSB0cnVlKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBjbG9zZSB3aGlsZSBzZXNzaW9ucyBhcmUgb3BlbicpCgogICAgaWYgKHRoaXMucmVwbGljYXRvcikgYXdhaXQgdGhpcy5yZXBsaWNhdG9yLmNsb3NlKCkKCiAgICBhd2FpdCB0aGlzLmRlc3Ryb3koKQogICAgaWYgKHRoaXMuYXV0b0Nsb3NlKSBhd2FpdCB0aGlzLnN0b3JhZ2Uuc3RvcmUuY2xvc2UoKQoKICAgIHRoaXMuY2xvc2VkID0gdHJ1ZQogIH0KfQoKZnVuY3Rpb24gdXBkYXRlQ29udGlnQmF0Y2goc3RhcnQsIHVwZCwgYml0ZmllbGQpIHsKICBjb25zdCBlbmQgPSB1cGQuc3RhcnQgKyB1cGQubGVuZ3RoCgogIGxldCBjID0gc3RhcnQKCiAgaWYgKHVwZC5kcm9wKSB7CiAgICAvLyBJZiB3ZSBkcm9wcGVkIGEgYmxvY2sgaW4gdGhlIGN1cnJlbnQgY29udGlnIHJhbmdlLCAiZG93bmdyYWRlIiBpdAogICAgaWYgKGMgPiB1cGQuc3RhcnQpIHsKICAgICAgYyA9IHVwZC5zdGFydAogICAgfQogIH0gZWxzZSB7CiAgICBpZiAoYyA8PSBlbmQgJiYgYyA+PSB1cGQuc3RhcnQpIHsKICAgICAgYyA9IGVuZAogICAgICB3aGlsZSAoYml0ZmllbGQuZ2V0KGMpKSBjKysKICAgIH0KICB9CgogIGlmIChjID09PSBzdGFydCkgewogICAgcmV0dXJuIHsKICAgICAgbGVuZ3RoOiAtMQogICAgfQogIH0KCiAgaWYgKGMgPiBzdGFydCkgewogICAgcmV0dXJuIHsKICAgICAgbGVuZ3RoOiBjCiAgICB9CiAgfQoKICByZXR1cm4gewogICAgbGVuZ3RoOiBjCiAgfQp9CgpmdW5jdGlvbiBnZXREZWZhdWx0VHJlZSgpIHsKICByZXR1cm4gewogICAgZm9yazogMCwKICAgIGxlbmd0aDogMCwKICAgIHJvb3RIYXNoOiBudWxsLAogICAgc2lnbmF0dXJlOiBudWxsCiAgfQp9CgpmdW5jdGlvbiBwYXJzZUhlYWRlcihpbmZvKSB7CiAgaWYgKCFpbmZvKSByZXR1cm4gbnVsbAoKICByZXR1cm4gewogICAga2V5OiBpbmZvLmtleSwKICAgIG1hbmlmZXN0OiBpbmZvLm1hbmlmZXN0LAogICAgZXh0ZXJuYWw6IG51bGwsCiAgICBrZXlQYWlyOiBpbmZvLmtleVBhaXIsCiAgICB0cmVlOiBpbmZvLmhlYWQgfHwgZ2V0RGVmYXVsdFRyZWUoKSwKICAgIGhpbnRzOiB7CiAgICAgIHJlb3JnczogW10sCiAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IGluZm8uaGludHMgPyBpbmZvLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGggOiAwLAogICAgICByZW1vdGVDb250aWd1b3VzTGVuZ3RoOiBpbmZvLmhpbnRzID8gaW5mby5oaW50cy5yZW1vdGVDb250aWd1b3VzTGVuZ3RoIDogMAogICAgfQogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9Cgphc3luYyBmdW5jdGlvbiBnZXRDb3JlSW5mbyhzdG9yYWdlKSB7CiAgY29uc3QgciA9IHN0b3JhZ2UucmVhZCgpCgogIGNvbnN0IGF1dGggPSByLmdldEF1dGgoKQogIGNvbnN0IGhlYWQgPSByLmdldEhlYWQoKQogIGNvbnN0IGhpbnRzID0gci5nZXRIaW50cygpCgogIHIudHJ5Rmx1c2goKQoKICBjb25zdCBbYXV0aEluZm8sIGhlYWRJbmZvLCBoaW50c0luZm9dID0gYXdhaXQgUHJvbWlzZS5hbGwoW2F1dGgsIGhlYWQsIGhpbnRzXSkKICByZXR1cm4gewogICAgLi4uYXV0aEluZm8sCiAgICBoZWFkOiBoZWFkSW5mbywKICAgIGhpbnRzOiBoaW50c0luZm8KICB9Cn0KY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgeyBERUZBVUxUX0VOQ1JZUFRJT04gfSA9IHJlcXVpcmUoJy4vY2FwcycpCgpjb25zdCBub25jZSA9IGI0YS5hbGxvYyhzb2RpdW0uY3J5cHRvX3N0cmVhbV9OT05DRUJZVEVTKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBEZWZhdWx0RW5jcnlwdGlvbiB7CiAgc3RhdGljIFBBRERJTkcgPSA4CgogIGNvbnN0cnVjdG9yKGVuY3J5cHRpb25LZXksIGh5cGVyY29yZUtleSwgb3B0cyA9IHt9KSB7CiAgICB0aGlzLmtleSA9IGVuY3J5cHRpb25LZXkKICAgIHRoaXMuY29tcGF0ID0gb3B0cy5jb21wYXQgPT09IHRydWUKCiAgICBjb25zdCBrZXlzID0gRGVmYXVsdEVuY3J5cHRpb24uZGVyaXZlS2V5cyhlbmNyeXB0aW9uS2V5LCBoeXBlcmNvcmVLZXksIG9wdHMpCgogICAgdGhpcy5ibG9ja0tleSA9IGtleXMuYmxvY2sKICAgIHRoaXMuYmxpbmRpbmdLZXkgPSBrZXlzLmJsaW5kaW5nCiAgfQoKICBzdGF0aWMgZGVyaXZlS2V5cyhlbmNyeXB0aW9uS2V5LCBoeXBlcmNvcmVLZXksIHsgYmxvY2sgPSBmYWxzZSwgY29tcGF0ID0gZmFsc2UgfSA9IHt9KSB7CiAgICBjb25zdCBzdWJLZXlzID0gYjRhLmFsbG9jKDIgKiBzb2RpdW0uY3J5cHRvX3N0cmVhbV9LRVlCWVRFUykKCiAgICBjb25zdCBibG9ja0tleSA9IGJsb2NrID8gZW5jcnlwdGlvbktleSA6IHN1YktleXMuc3ViYXJyYXkoMCwgc29kaXVtLmNyeXB0b19zdHJlYW1fS0VZQllURVMpCiAgICBjb25zdCBibGluZGluZ0tleSA9IHN1YktleXMuc3ViYXJyYXkoc29kaXVtLmNyeXB0b19zdHJlYW1fS0VZQllURVMpCgogICAgaWYgKCFibG9jaykgewogICAgICBpZiAoY29tcGF0KSB7CiAgICAgICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChibG9ja0tleSwgW2VuY3J5cHRpb25LZXldLCBoeXBlcmNvcmVLZXkpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChibG9ja0tleSwgW0RFRkFVTFRfRU5DUllQVElPTiwgaHlwZXJjb3JlS2V5LCBlbmNyeXB0aW9uS2V5XSkKICAgICAgfQogICAgfQoKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goYmxpbmRpbmdLZXksIGJsb2NrS2V5KQoKICAgIHJldHVybiB7CiAgICAgIGJsaW5kaW5nOiBibGluZGluZ0tleSwKICAgICAgYmxvY2s6IGJsb2NrS2V5CiAgICB9CiAgfQoKICBzdGF0aWMgYmxvY2tFbmNyeXB0aW9uS2V5KGh5cGVyY29yZUtleSwgZW5jcnlwdGlvbktleSkgewogICAgY29uc3QgYmxvY2tLZXkgPSBiNGEuYWxsb2Moc29kaXVtLmNyeXB0b19zdHJlYW1fS0VZQllURVMpCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKGJsb2NrS2V5LCBbREVGQVVMVF9FTkNSWVBUSU9OLCBoeXBlcmNvcmVLZXksIGVuY3J5cHRpb25LZXldKQogICAgcmV0dXJuIGJsb2NrS2V5CiAgfQoKICBzdGF0aWMgZW5jcnlwdChpbmRleCwgYmxvY2ssIGZvcmssIGJsb2NrS2V5LCBibGluZGluZ0tleSkgewogICAgY29uc3QgcGFkZGluZyA9IGJsb2NrLnN1YmFycmF5KDAsIERlZmF1bHRFbmNyeXB0aW9uLlBBRERJTkcpCiAgICBibG9jayA9IGJsb2NrLnN1YmFycmF5KERlZmF1bHRFbmNyeXB0aW9uLlBBRERJTkcpCgogICAgYy51aW50NjQuZW5jb2RlKHsgc3RhcnQ6IDAsIGVuZDogOCwgYnVmZmVyOiBwYWRkaW5nIH0sIGZvcmspCiAgICBjLnVpbnQ2NC5lbmNvZGUoeyBzdGFydDogMCwgZW5kOiA4LCBidWZmZXI6IG5vbmNlIH0sIGluZGV4KQoKICAgIC8vIFplcm8gb3V0IGFueSBwcmV2aW91cyBwYWRkaW5nLgogICAgbm9uY2UuZmlsbCgwLCA4LCA4ICsgcGFkZGluZy5ieXRlTGVuZ3RoKQoKICAgIC8vIEJsaW5kIHRoZSBmb3JrIElELCBwb3NzaWJseSByaXNraW5nIHJldXNpbmcgdGhlIG5vbmNlIG9uIGEgcmVvcmcgb2YgdGhlCiAgICAvLyBIeXBlcmNvcmUuIFRoaXMgaXMgZmluZSBhcyB0aGUgYmxpbmRpbmcgaXMgYmVzdC1lZmZvcnQgYW5kIHRoZSBsYXRlc3QKICAgIC8vIGZvcmsgSUQgc2hhcmVkIG9uIHJlcGxpY2F0aW9uIGFueXdheS4KICAgIHNvZGl1bS5jcnlwdG9fc3RyZWFtX3hvcihwYWRkaW5nLCBwYWRkaW5nLCBub25jZSwgYmxpbmRpbmdLZXkpCgogICAgbm9uY2Uuc2V0KHBhZGRpbmcsIDgpCgogICAgLy8gVGhlIGNvbWJpbmF0aW9uIG9mIGEgKGJsaW5kZWQpIGZvcmsgSUQgYW5kIGEgYmxvY2sgaW5kZXggaXMgdW5pcXVlIGZvciBhCiAgICAvLyBnaXZlbiBIeXBlcmNvcmUgYW5kIGlzIHRoZXJlZm9yZSBhIHZhbGlkIG5vbmNlIGZvciBlbmNyeXB0aW5nIHRoZSBibG9jay4KICAgIHNvZGl1bS5jcnlwdG9fc3RyZWFtX3hvcihibG9jaywgYmxvY2ssIG5vbmNlLCBibG9ja0tleSkKICB9CgogIHN0YXRpYyBkZWNyeXB0KGluZGV4LCBibG9jaywgYmxvY2tLZXkpIHsKICAgIGNvbnN0IHBhZGRpbmcgPSBibG9jay5zdWJhcnJheSgwLCBEZWZhdWx0RW5jcnlwdGlvbi5QQURESU5HKQogICAgYmxvY2sgPSBibG9jay5zdWJhcnJheShEZWZhdWx0RW5jcnlwdGlvbi5QQURESU5HKQoKICAgIGMudWludDY0LmVuY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IDgsIGJ1ZmZlcjogbm9uY2UgfSwgaW5kZXgpCgogICAgbm9uY2Uuc2V0KHBhZGRpbmcsIDgpCgogICAgLy8gRGVjcnlwdCB0aGUgYmxvY2sgdXNpbmcgdGhlIGJsaW5kZWQgZm9yayBJRC4KICAgIHNvZGl1bS5jcnlwdG9fc3RyZWFtX3hvcihibG9jaywgYmxvY2ssIG5vbmNlLCBibG9ja0tleSkKICB9CgogIGVuY3J5cHQoaW5kZXgsIGJsb2NrLCBmb3JrLCBjb3JlKSB7CiAgICBpZiAoY29yZS5jb21wYXQgIT09IHRoaXMuY29tcGF0KSB0aGlzLl9yZWxvYWQoY29yZSkKICAgIHJldHVybiBEZWZhdWx0RW5jcnlwdGlvbi5lbmNyeXB0KGluZGV4LCBibG9jaywgZm9yaywgdGhpcy5ibG9ja0tleSwgdGhpcy5ibGluZGluZ0tleSkKICB9CgogIGRlY3J5cHQoaW5kZXgsIGJsb2NrLCBjb3JlKSB7CiAgICBpZiAoY29yZS5jb21wYXQgIT09IHRoaXMuY29tcGF0KSB0aGlzLl9yZWxvYWQoY29yZSkKICAgIHJldHVybiBEZWZhdWx0RW5jcnlwdGlvbi5kZWNyeXB0KGluZGV4LCBibG9jaywgdGhpcy5ibG9ja0tleSkKICB9CgogIHBhZGRpbmcoKSB7CiAgICByZXR1cm4gRGVmYXVsdEVuY3J5cHRpb24uUEFERElORwogIH0KCiAgX3JlbG9hZChjb3JlKSB7CiAgICBjb25zdCBibG9jayA9IGI0YS5lcXVhbHModGhpcy5rZXksIHRoaXMuYmxvY2tLZXkpCiAgICBjb25zdCBrZXlzID0gRGVmYXVsdEVuY3J5cHRpb24uZGVyaXZlS2V5cyh0aGlzLmtleSwgY29yZS5rZXksIHsgYmxvY2ssIGNvbXBhdDogY29yZS5jb21wYXQgfSkKCiAgICB0aGlzLmJsb2NrS2V5ID0ga2V5cy5ibG9ja0tleQogICAgdGhpcy5ibGluZGluZ0tleSA9IGtleXMuYmxpbmRpbmdLZXkKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBEb3dubG9hZCB7CiAgY29uc3RydWN0b3Ioc2Vzc2lvbiwgcmFuZ2UpIHsKICAgIHRoaXMuc2Vzc2lvbiA9IHNlc3Npb24KICAgIHRoaXMucmFuZ2UgPSByYW5nZQogICAgdGhpcy5yZXF1ZXN0ID0gbnVsbAogICAgdGhpcy5vcGVuZWQgPSBmYWxzZQogICAgdGhpcy5vcGVuaW5nID0gdGhpcy5fb3BlbigpCiAgICB0aGlzLm9wZW5pbmcuY2F0Y2gobm9vcCkKICB9CgogIHJlYWR5KCkgewogICAgcmV0dXJuIHRoaXMub3BlbmluZwogIH0KCiAgYXN5bmMgX29wZW4oKSB7CiAgICBpZiAodGhpcy5zZXNzaW9uLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMuc2Vzc2lvbi5vcGVuaW5nCiAgICB0aGlzLl9kb3dubG9hZCgpCiAgICB0aGlzLm9wZW5lZCA9IHRydWUKICB9CgogIGFzeW5jIGRvbmUoKSB7CiAgICBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5yZXF1ZXN0LnByb21pc2UKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAoaXNTZXNzaW9uTW92ZWQoZXJyKSkgcmV0dXJuIHRoaXMuX2Rvd25sb2FkKCkKICAgICAgdGhyb3cgZXJyCiAgICB9CiAgfQoKICBfZG93bmxvYWQoKSB7CiAgICBjb25zdCBhY3RpdmVSZXF1ZXN0cyA9ICh0aGlzLnJhbmdlICYmIHRoaXMucmFuZ2UuYWN0aXZlUmVxdWVzdHMpIHx8IHRoaXMuc2Vzc2lvbi5hY3RpdmVSZXF1ZXN0cwogICAgdGhpcy5yZXF1ZXN0ID0gdGhpcy5zZXNzaW9uLmNvcmUucmVwbGljYXRvci5hZGRSYW5nZShhY3RpdmVSZXF1ZXN0cywgdGhpcy5yYW5nZSkKICAgIHRoaXMucmVxdWVzdC5wcm9taXNlLmNhdGNoKG5vb3ApCiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0LnByb21pc2UKICB9CgogIC8qKgogICAqIERlcHJlY2F0ZWQuIFVzZSBgcmFuZ2UuZG9uZSgpYC4KICAgKi8KICBkb3dubG9hZGVkKCkgewogICAgcmV0dXJuIHRoaXMuZG9uZSgpCiAgfQoKICBkZXN0cm95KCkgewogICAgdGhpcy5fZGVzdHJveUJhY2tncm91bmQoKS5jYXRjaChub29wKQogIH0KCiAgYXN5bmMgX2Rlc3Ryb3lCYWNrZ3JvdW5kKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAodGhpcy5yZXF1ZXN0LmNvbnRleHQpIHRoaXMucmVxdWVzdC5jb250ZXh0LmRldGFjaCh0aGlzLnJlcXVlc3QpCiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIGlzU2Vzc2lvbk1vdmVkKGVycikgewogIHJldHVybiBlcnIuY29kZSA9PT0gJ1NFU1NJT05fTU9WRUQnCn0KY29uc3QgVElDS1MgPSAxNgoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBIb3Rzd2FwUXVldWUgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5wcmlvcml0aWVzID0gW1tdLCBbXSwgW11dCiAgfQoKICAqcGljayhwZWVyKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucHJpb3JpdGllcy5sZW5ndGg7IGkrKykgewogICAgICAvLyB0cnkgZmlyc3Qgb25lIG1vcmUgdGhhbiBzZWNvbmQgb25lIGV0YyBldGMKICAgICAgbGV0IHRpY2tzID0gKHRoaXMucHJpb3JpdGllcy5sZW5ndGggLSBpKSAqIFRJQ0tTCiAgICAgIGNvbnN0IHF1ZXVlID0gdGhpcy5wcmlvcml0aWVzW2ldCgogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHF1ZXVlLmxlbmd0aDsgaisrKSB7CiAgICAgICAgY29uc3QgciA9IGogKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBxdWV1ZS5sZW5ndGggLSBqKQogICAgICAgIGNvbnN0IGEgPSBxdWV1ZVtqXQogICAgICAgIGNvbnN0IGIgPSBxdWV1ZVtyXQoKICAgICAgICBpZiAociAhPT0gaikgewogICAgICAgICAgcXVldWVbKGIuaG90c3dhcC5pbmRleCA9IGopXSA9IGIKICAgICAgICAgIHF1ZXVlWyhhLmhvdHN3YXAuaW5kZXggPSByKV0gPSBhCiAgICAgICAgfQoKICAgICAgICBpZiAoaGFzSW5mbGlnaHQoYiwgcGVlcikpIGNvbnRpbnVlCgogICAgICAgIHlpZWxkIGIKCiAgICAgICAgaWYgKC0tdGlja3MgPD0gMCkgYnJlYWsKICAgICAgfQogICAgfQogIH0KCiAgYWRkKGJsb2NrKSB7CiAgICBpZiAoYmxvY2suaG90c3dhcCAhPT0gbnVsbCkgdGhpcy5yZW1vdmUoYmxvY2spCiAgICBpZiAoYmxvY2suaW5mbGlnaHQubGVuZ3RoID09PSAwIHx8IGJsb2NrLmluZmxpZ2h0Lmxlbmd0aCA+PSAzKSByZXR1cm4KCiAgICAvLyBUT0RPOiBhbHNvIHVzZSBvdGhlciBzdHVmZiB0byBkZXRlcm1pbmUgcXVldWUgcHJpbwogICAgY29uc3QgcXVldWUgPSB0aGlzLnByaW9yaXRpZXNbYmxvY2suaW5mbGlnaHQubGVuZ3RoIC0gMV0KCiAgICBjb25zdCBpbmRleCA9IHF1ZXVlLnB1c2goYmxvY2spIC0gMQogICAgYmxvY2suaG90c3dhcCA9IHsgcmVmOiB0aGlzLCBxdWV1ZSwgaW5kZXggfQogIH0KCiAgcmVtb3ZlKGJsb2NrKSB7CiAgICBjb25zdCBob3Rzd2FwID0gYmxvY2suaG90c3dhcAogICAgaWYgKGhvdHN3YXAgPT09IG51bGwpIHJldHVybgoKICAgIGJsb2NrLmhvdHN3YXAgPSBudWxsCiAgICBjb25zdCBoZWFkID0gaG90c3dhcC5xdWV1ZS5wb3AoKQogICAgaWYgKGhlYWQgPT09IGJsb2NrKSByZXR1cm4KICAgIGhvdHN3YXAucXVldWVbKGhlYWQuaG90c3dhcC5pbmRleCA9IGhvdHN3YXAuaW5kZXgpXSA9IGhlYWQKICB9Cn0KCmZ1bmN0aW9uIGhhc0luZmxpZ2h0KGJsb2NrLCBwZWVyKSB7CiAgZm9yIChsZXQgaiA9IDA7IGogPCBibG9jay5pbmZsaWdodC5sZW5ndGg7IGorKykgewogICAgaWYgKGJsb2NrLmluZmxpZ2h0W2pdLnBlZXIgPT09IHBlZXIpIHJldHVybiB0cnVlCiAgfQogIHJldHVybiBmYWxzZQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgSW5mbyB7CiAgY29uc3RydWN0b3Iob3B0cyA9IHt9KSB7CiAgICB0aGlzLmtleSA9IG9wdHMua2V5CiAgICB0aGlzLmRpc2NvdmVyeUtleSA9IG9wdHMuZGlzY292ZXJ5S2V5CiAgICB0aGlzLmxlbmd0aCA9IG9wdHMubGVuZ3RoIHx8IDAKICAgIHRoaXMuY29udGlndW91c0xlbmd0aCA9IG9wdHMuY29udGlndW91c0xlbmd0aCB8fCAwCiAgICB0aGlzLmJ5dGVMZW5ndGggPSBvcHRzLmJ5dGVMZW5ndGggfHwgMAogICAgdGhpcy5mb3JrID0gb3B0cy5mb3JrIHx8IDAKICAgIHRoaXMucGFkZGluZyA9IG9wdHMucGFkZGluZyB8fCAwCiAgICB0aGlzLnN0b3JhZ2UgPSBvcHRzLnN0b3JhZ2UgfHwgbnVsbAogIH0KCiAgc3RhdGljIGFzeW5jIGZyb20oc2Vzc2lvbiwgb3B0cyA9IHt9KSB7CiAgICByZXR1cm4gbmV3IEluZm8oewogICAgICBrZXk6IHNlc3Npb24ua2V5LAogICAgICBkaXNjb3ZlcnlLZXk6IHNlc3Npb24uZGlzY292ZXJ5S2V5LAogICAgICBsZW5ndGg6IHNlc3Npb24ubGVuZ3RoLAogICAgICBjb250aWd1b3VzTGVuZ3RoOiBzZXNzaW9uLmNvbnRpZ3VvdXNMZW5ndGgsCiAgICAgIGJ5dGVMZW5ndGg6IHNlc3Npb24uYnl0ZUxlbmd0aCwKICAgICAgZm9yazogc2Vzc2lvbi5mb3JrLAogICAgICBwYWRkaW5nOiBzZXNzaW9uLnBhZGRpbmcsCiAgICAgIHN0b3JhZ2U6IG9wdHMuc3RvcmFnZSA/IGF3YWl0IHRoaXMuc3RvcmFnZShzZXNzaW9uKSA6IG51bGwKICAgIH0pCiAgfQoKICBzdGF0aWMgYXN5bmMgc3RvcmFnZShzZXNzaW9uKSB7CiAgICBjb25zdCB7IG9wbG9nLCB0cmVlLCBibG9ja3MsIGJpdGZpZWxkIH0gPSBzZXNzaW9uLmNvcmUKICAgIHRyeSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgb3Bsb2c6IGF3YWl0IEluZm8uYnl0ZXNVc2VkKG9wbG9nLnN0b3JhZ2UpLAogICAgICAgIHRyZWU6IGF3YWl0IEluZm8uYnl0ZXNVc2VkKHRyZWUuc3RvcmFnZSksCiAgICAgICAgYmxvY2tzOiBhd2FpdCBJbmZvLmJ5dGVzVXNlZChibG9ja3Muc3RvcmFnZSksCiAgICAgICAgYml0ZmllbGQ6IGF3YWl0IEluZm8uYnl0ZXNVc2VkKGJpdGZpZWxkLnN0b3JhZ2UpCiAgICAgIH0KICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gbnVsbAogICAgfQogIH0KCiAgc3RhdGljIGJ5dGVzVXNlZChmaWxlKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICBmaWxlLnN0YXQoKGVyciwgc3QpID0+IHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICByZXNvbHZlKDApIC8vIHByb2IganVzdCBmaWxlIG5vdCBmb3VuZCAoVE9ETywgaW1wcm92ZSkKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdC5ibG9ja3MgIT09ICdudW1iZXInKSB7CiAgICAgICAgICByZWplY3QobmV3IEVycm9yKCdjYW5ub3QgZGV0ZXJtaW5lIGJ5dGVzIHVzZWQnKSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzb2x2ZShzdC5ibG9ja3MgKiA1MTIpCiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9Cn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKGNvcmUsIGRlcHRoLCBvcHRzKSB7CiAgbGV0IGluZGVudCA9ICcnCiAgaWYgKHR5cGVvZiBvcHRzLmluZGVudGF0aW9uTHZsID09PSAnbnVtYmVyJykgewogICAgd2hpbGUgKGluZGVudC5sZW5ndGggPCBvcHRzLmluZGVudGF0aW9uTHZsKSBpbmRlbnQgKz0gJyAnCiAgfQoKICBsZXQgcGVlcnMgPSAnJwogIGNvbnN0IG1pbiA9IE1hdGgubWluKGNvcmUucGVlcnMubGVuZ3RoLCA1KQoKICBmb3IgKGxldCBpID0gMDsgaSA8IG1pbjsgaSsrKSB7CiAgICBjb25zdCBwZWVyID0gY29yZS5wZWVyc1tpXQoKICAgIHBlZXJzICs9IGAke2luZGVudH0gICAgUGVlcihcbmAKICAgIHBlZXJzICs9IGAke2luZGVudH0gICAgICByZW1vdGVQdWJsaWNLZXk6ICR7b3B0cy5zdHlsaXplKHRvSGV4KHBlZXIucmVtb3RlUHVibGljS2V5KSwgJ3N0cmluZycpfVxuYAogICAgcGVlcnMgKz0gYCR7aW5kZW50fSAgICAgIHJlbW90ZUxlbmd0aDogJHtvcHRzLnN0eWxpemUocGVlci5yZW1vdGVMZW5ndGgsICdudW1iZXInKX1cbmAKICAgIHBlZXJzICs9IGAke2luZGVudH0gICAgICByZW1vdGVGb3JrOiAke29wdHMuc3R5bGl6ZShwZWVyLnJlbW90ZUZvcmssICdudW1iZXInKX1cbmAKICAgIHBlZXJzICs9IGAke2luZGVudH0gICAgICByZW1vdGVDYW5VcGdyYWRlOiAke29wdHMuc3R5bGl6ZShwZWVyLnJlbW90ZUNhblVwZ3JhZGUsICdib29sZWFuJyl9XG5gCiAgICBwZWVycyArPSBgJHtpbmRlbnR9ICAgIClcbmAKICB9CgogIGlmIChjb3JlLnBlZXJzLmxlbmd0aCA+IDUpIHsKICAgIHBlZXJzICs9IGAke2luZGVudH0gIC4uLiBhbmQgJHtjb3JlLnBlZXJzLmxlbmd0aCAtIDV9IG1vcmVcbmAKICB9CgogIGlmIChwZWVycykgcGVlcnMgPSBgW1xuJHtwZWVyc30ke2luZGVudH0gIF1gCiAgZWxzZSBwZWVycyA9IGBbICR7b3B0cy5zdHlsaXplKDAsICdudW1iZXInKX0gXWAKCiAgcmV0dXJuICgKICAgIGAke2NvcmUuY29uc3RydWN0b3IubmFtZX0oXG5gICsKICAgIGAke2luZGVudH0gIGlkOiAke29wdHMuc3R5bGl6ZShjb3JlLmlkLCAnc3RyaW5nJyl9XG5gICsKICAgIGAke2luZGVudH0gIGtleTogJHtvcHRzLnN0eWxpemUodG9IZXgoY29yZS5rZXkpLCAnc3RyaW5nJyl9XG5gICsKICAgIGAke2luZGVudH0gIGRpc2NvdmVyeUtleTogJHtvcHRzLnN0eWxpemUodG9IZXgoY29yZS5kaXNjb3ZlcnlLZXkpLCAnc3RyaW5nJyl9XG5gICsKICAgIGAke2luZGVudH0gIG9wZW5lZDogJHtvcHRzLnN0eWxpemUoY29yZS5vcGVuZWQsICdib29sZWFuJyl9XG5gICsKICAgIGAke2luZGVudH0gIGNsb3NlZDogJHtvcHRzLnN0eWxpemUoY29yZS5jbG9zZWQsICdib29sZWFuJyl9XG5gICsKICAgIGAke2luZGVudH0gIHNuYXBzaG90dGVkOiAke29wdHMuc3R5bGl6ZShjb3JlLnNuYXBzaG90dGVkLCAnYm9vbGVhbicpfVxuYCArCiAgICBgJHtpbmRlbnR9ICB3cml0YWJsZTogJHtvcHRzLnN0eWxpemUoY29yZS53cml0YWJsZSwgJ2Jvb2xlYW4nKX1cbmAgKwogICAgYCR7aW5kZW50fSAgbGVuZ3RoOiAke29wdHMuc3R5bGl6ZShjb3JlLmxlbmd0aCwgJ251bWJlcicpfVxuYCArCiAgICBgJHtpbmRlbnR9ICBmb3JrOiAke29wdHMuc3R5bGl6ZShjb3JlLmZvcmssICdudW1iZXInKX1cbmAgKwogICAgYCR7aW5kZW50fSAgc2Vzc2lvbnM6IFsgJHtvcHRzLnN0eWxpemUoY29yZS5zZXNzaW9ucy5sZW5ndGgsICdudW1iZXInKX0gXVxuYCArCiAgICBgJHtpbmRlbnR9ICBhY3RpdmVSZXF1ZXN0czogWyAke29wdHMuc3R5bGl6ZShjb3JlLmFjdGl2ZVJlcXVlc3RzLmxlbmd0aCwgJ251bWJlcicpfSBdXG5gICsKICAgIGAke2luZGVudH0gIHBlZXJzOiAke3BlZXJzfVxuYCArCiAgICBgJHtpbmRlbnR9KWAKICApCn0KCmZ1bmN0aW9uIHRvSGV4KGJ1ZikgewogIHJldHVybiBidWYgJiYgYjRhLnRvU3RyaW5nKGJ1ZiwgJ2hleCcpCn0KY29uc3QgZmxhdCA9IHJlcXVpcmUoJ2ZsYXQtdHJlZScpCmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCB1bnNsYWIgPSByZXF1aXJlKCd1bnNsYWInKQpjb25zdCBjYXBzID0gcmVxdWlyZSgnLi9jYXBzJykKY29uc3QgewogIElOVkFMSURfUFJPT0YsCiAgSU5WQUxJRF9DSEVDS1NVTSwKICBJTlZBTElEX09QRVJBVElPTiwKICBCQURfQVJHVU1FTlQsCiAgQVNTRVJUSU9OCn0gPSByZXF1aXJlKCdoeXBlcmNvcmUtZXJyb3JzJykKCmNsYXNzIE5vZGVRdWV1ZSB7CiAgY29uc3RydWN0b3Iobm9kZXMsIGV4dHJhID0gbnVsbCkgewogICAgdGhpcy5pID0gMAogICAgdGhpcy5ub2RlcyA9IG5vZGVzCiAgICB0aGlzLmV4dHJhID0gZXh0cmEKICAgIHRoaXMubGVuZ3RoID0gbm9kZXMubGVuZ3RoICsgKHRoaXMuZXh0cmEgPT09IG51bGwgPyAwIDogMSkKICB9CgogIHNoaWZ0KGluZGV4KSB7CiAgICBpZiAodGhpcy5leHRyYSAhPT0gbnVsbCAmJiB0aGlzLmV4dHJhLmluZGV4ID09PSBpbmRleCkgewogICAgICBjb25zdCBub2RlID0gdGhpcy5leHRyYQogICAgICB0aGlzLmV4dHJhID0gbnVsbAogICAgICB0aGlzLmxlbmd0aC0tCiAgICAgIHJldHVybiBub2RlCiAgICB9CgogICAgaWYgKHRoaXMuaSA+PSB0aGlzLm5vZGVzLmxlbmd0aCkgewogICAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTignRXhwZWN0ZWQgbm9kZSAnICsgaW5kZXggKyAnLCBnb3QgKG5pbCknKQogICAgfQoKICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGVzW3RoaXMuaSsrXQogICAgaWYgKG5vZGUuaW5kZXggIT09IGluZGV4KSB7CiAgICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdFeHBlY3RlZCBub2RlICcgKyBpbmRleCArICcsIGdvdCBub2RlICcgKyBub2RlLmluZGV4KQogICAgfQoKICAgIHRoaXMubGVuZ3RoLS0KICAgIHJldHVybiBub2RlCiAgfQp9CgpjbGFzcyBNZXJrbGVUcmVlQmF0Y2ggewogIGNvbnN0cnVjdG9yKHNlc3Npb24pIHsKICAgIHRoaXMuZm9yayA9IHNlc3Npb24uZm9yawogICAgdGhpcy5yb290cyA9IFsuLi5zZXNzaW9uLnJvb3RzXQogICAgdGhpcy5sZW5ndGggPSBzZXNzaW9uLmxlbmd0aAogICAgdGhpcy5zaWduYXR1cmUgPSBzZXNzaW9uLnNpZ25hdHVyZQogICAgdGhpcy5hbmNlc3RvcnMgPSBzZXNzaW9uLmxlbmd0aAogICAgdGhpcy5ieXRlTGVuZ3RoID0gc2Vzc2lvbi5ieXRlTGVuZ3RoCiAgICB0aGlzLnByb2xvZ3VlID0gc2Vzc2lvbi5wcm9sb2d1ZQogICAgdGhpcy5oYXNoQ2FjaGVkID0gbnVsbAoKICAgIHRoaXMuY29tbWl0dGVkID0gZmFsc2UKICAgIHRoaXMudHJ1bmNhdGVkID0gZmFsc2UKICAgIHRoaXMudHJlZUxlbmd0aCA9IHNlc3Npb24ubGVuZ3RoCiAgICB0aGlzLnRyZWVGb3JrID0gc2Vzc2lvbi5mb3JrCiAgICB0aGlzLnN0b3JhZ2UgPSBzZXNzaW9uLnN0b3JhZ2UKICAgIHRoaXMuc2Vzc2lvbiA9IHNlc3Npb24KICAgIHRoaXMubm9kZXMgPSBbXQogICAgdGhpcy51cGdyYWRlZCA9IGZhbHNlCiAgfQoKICBjaGVja291dChsZW5ndGgsIGFkZGl0aW9uYWxSb290cykgewogICAgY29uc3Qgcm9vdHMgPSBbXQogICAgbGV0IHIgPSAwCgogICAgY29uc3QgaGVhZCA9IDIgKiBsZW5ndGggLSAyCiAgICBjb25zdCBnYXBzID0gbmV3IFNldCgpCiAgICBjb25zdCBhbGwgPSBuZXcgTWFwKCkKCiAgICAvLyBhZGRpdGlvbmFsIHJvb3RzIGlzIHNvIHRoZSBvcmlnaW5hbCByb290cyBjYW4gYmUgcGFzc2VkICh3ZSBtdXRhdGUgdGhlIGFycmF5IGluIGFwcGVuZFJvb3QpCiAgICBpZiAoYWRkaXRpb25hbFJvb3RzKSB7CiAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiBhZGRpdGlvbmFsUm9vdHMpIGFsbC5zZXQobm9kZS5pbmRleCwgbm9kZSkKICAgIH0KCiAgICBmb3IgKGNvbnN0IG5vZGUgb2YgdGhpcy5ub2RlcykgYWxsLnNldChub2RlLmluZGV4LCBub2RlKQoKICAgIGZvciAoY29uc3QgaW5kZXggb2YgZmxhdC5mdWxsUm9vdHMoaGVhZCArIDIpKSB7CiAgICAgIGNvbnN0IGxlZnQgPSBmbGF0LmxlZnRTcGFuKGluZGV4KQogICAgICBpZiAobGVmdCAhPT0gMCkgZ2Fwcy5hZGQobGVmdCAtIDEpCgogICAgICBpZiAociA8IHRoaXMucm9vdHMubGVuZ3RoICYmIHRoaXMucm9vdHNbcl0uaW5kZXggPT09IGluZGV4KSB7CiAgICAgICAgcm9vdHMucHVzaCh0aGlzLnJvb3RzW3IrK10pCiAgICAgICAgY29udGludWUKICAgICAgfQogICAgICBjb25zdCBub2RlID0gYWxsLmdldChpbmRleCkKICAgICAgaWYgKCFub2RlKSB0aHJvdyBuZXcgQkFEX0FSR1VNRU5UKCdyb290IG1pc3NpbmcgZm9yIGdpdmVuIGxlbmd0aCcpCiAgICAgIHJvb3RzLnB1c2gobm9kZSkKICAgIH0KCiAgICB0aGlzLnJvb3RzID0gcm9vdHMKICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLmJ5dGVMZW5ndGggPSB0b3RhbFNpemUocm9vdHMpCiAgICB0aGlzLmhhc2hDYWNoZWQgPSBudWxsCiAgICB0aGlzLnNpZ25hdHVyZSA9IG51bGwKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgaW5kZXggPSB0aGlzLm5vZGVzW2ldLmluZGV4CiAgICAgIGlmIChpbmRleCA8PSBoZWFkICYmICFnYXBzLmhhcyhpbmRleCkpIGNvbnRpbnVlCiAgICAgIGNvbnN0IGxhc3QgPSB0aGlzLm5vZGVzLnBvcCgpCiAgICAgIGlmIChpIDwgdGhpcy5ub2Rlcy5sZW5ndGgpIHRoaXMubm9kZXNbaS0tXSA9IGxhc3QKICAgIH0KICB9CgogIHBydW5lKGxlbmd0aCkgewogICAgaWYgKGxlbmd0aCA9PT0gMCkgcmV0dXJuCgogICAgY29uc3QgaGVhZCA9IDIgKiBsZW5ndGggLSAyCiAgICBjb25zdCBnYXBzID0gbmV3IFNldCgpCgogICAgLy8gVE9ETzogbWFrZSBhIGZ1bmN0aW9uIGZvciB0aGlzIGluIGZsYXQtdHJlZQogICAgZm9yIChjb25zdCBpbmRleCBvZiBmbGF0LmZ1bGxSb290cyhoZWFkICsgMikpIHsKICAgICAgY29uc3QgbGVmdCA9IGZsYXQubGVmdFNwYW4oaW5kZXgpCiAgICAgIGlmIChsZWZ0ICE9PSAwKSBnYXBzLmFkZChsZWZ0IC0gMSkKICAgIH0KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgaW5kZXggPSB0aGlzLm5vZGVzW2ldLmluZGV4CiAgICAgIGlmIChpbmRleCA+IGhlYWQgfHwgZ2Fwcy5oYXMoaW5kZXgpKSBjb250aW51ZQogICAgICBjb25zdCBsYXN0ID0gdGhpcy5ub2Rlcy5wb3AoKQogICAgICBpZiAoaSA8IHRoaXMubm9kZXMubGVuZ3RoKSB0aGlzLm5vZGVzW2ktLV0gPSBsYXN0CiAgICB9CiAgfQoKICBjbG9uZSgpIHsKICAgIGNvbnN0IGIgPSBuZXcgTWVya2xlVHJlZUJhdGNoKHRoaXMuc2Vzc2lvbikKCiAgICBiLmZvcmsgPSB0aGlzLmZvcmsKICAgIGIucm9vdHMgPSBbLi4udGhpcy5yb290c10KICAgIGIubGVuZ3RoID0gdGhpcy5sZW5ndGgKICAgIGIuYnl0ZUxlbmd0aCA9IHRoaXMuYnl0ZUxlbmd0aAogICAgYi5zaWduYXR1cmUgPSB0aGlzLnNpZ25hdHVyZQogICAgYi50cmVlTGVuZ3RoID0gdGhpcy50cmVlTGVuZ3RoCiAgICBiLnRyZWVGb3JrID0gdGhpcy50cmVlRm9yawogICAgYi50cmVlID0gdGhpcy50cmVlCiAgICBiLm5vZGVzID0gWy4uLnRoaXMubm9kZXNdCiAgICBiLnVwZ3JhZGVkID0gdGhpcy51cGdyYWRlZAoKICAgIHJldHVybiBiCiAgfQoKICBoYXNoKCkgewogICAgaWYgKHRoaXMuaGFzaENhY2hlZCA9PT0gbnVsbCkgdGhpcy5oYXNoQ2FjaGVkID0gdW5zbGFiKGNyeXB0by50cmVlKHRoaXMucm9vdHMpKQogICAgcmV0dXJuIHRoaXMuaGFzaENhY2hlZAogIH0KCiAgc2lnbmFibGUobWFuaWZlc3RIYXNoKSB7CiAgICByZXR1cm4gY2Fwcy50cmVlU2lnbmFibGUobWFuaWZlc3RIYXNoLCB0aGlzLmhhc2goKSwgdGhpcy5sZW5ndGgsIHRoaXMuZm9yaykKICB9CgogIHNpZ25hYmxlQ29tcGF0KG5vSGVhZGVyKSB7CiAgICByZXR1cm4gY2Fwcy50cmVlU2lnbmFibGVDb21wYXQodGhpcy5oYXNoKCksIHRoaXMubGVuZ3RoLCB0aGlzLmZvcmssIG5vSGVhZGVyKQogIH0KCiAgZ2V0KGluZGV4KSB7CiAgICBpZiAoaW5kZXggPj0gdGhpcy5sZW5ndGggKiAyKSB7CiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgZm9yIChjb25zdCBuIG9mIHRoaXMubm9kZXMpIHsKICAgICAgaWYgKG4uaW5kZXggPT09IGluZGV4KSByZXR1cm4gbgogICAgfQoKICAgIHJldHVybiBnZXRUcmVlTm9kZUZyb21TdG9yYWdlKHRoaXMuc2Vzc2lvbi5zdG9yYWdlLCBpbmRleCkKICB9CgogIC8vIGRlcHJlY2F0ZWQsIHVzZSBzc3Npb24gcHJvb2YgaW5zdGVhZAogIHByb29mKGJhdGNoLCB7IGJsb2NrLCBoYXNoLCBzZWVrLCB1cGdyYWRlIH0pIHsKICAgIHJldHVybiBnZW5lcmF0ZVByb29mKHRoaXMuc2Vzc2lvbiwgYmF0Y2gsIGJsb2NrLCBoYXNoLCBzZWVrLCB1cGdyYWRlKQogIH0KCiAgdmVyaWZ5VXBncmFkZShwcm9vZikgewogICAgY29uc3QgdW52ZXJpZmllZCA9IHZlcmlmeVRyZWUocHJvb2YsIHRoaXMubm9kZXMpCgogICAgaWYgKCFwcm9vZi51cGdyYWRlKSB0aHJvdyBJTlZBTElEX09QRVJBVElPTignRXhwZWN0ZWQgdXBncmFkZSBwcm9vZicpCgogICAgcmV0dXJuIHZlcmlmeVVwZ3JhZGUocHJvb2YsIHVudmVyaWZpZWQsIHRoaXMpCiAgfQoKICBhZGROb2Rlc1Vuc2FmZShub2RlcykgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICB0aGlzLm5vZGVzLnB1c2gobm9kZXNbaV0pCiAgICB9CiAgfQoKICBhcHBlbmQoYnVmKSB7CiAgICBjb25zdCBoZWFkID0gdGhpcy5sZW5ndGggKiAyCiAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKGhlYWQpCiAgICBjb25zdCBub2RlID0gYmxvY2tOb2RlKGhlYWQsIGJ1ZikKCiAgICB0aGlzLmFwcGVuZFJvb3Qobm9kZSwgaXRlKQogIH0KCiAgYXBwZW5kUm9vdChub2RlLCBpdGUpIHsKICAgIG5vZGUgPSB1bnNsYWJOb2RlKG5vZGUpCiAgICB0aGlzLmhhc2hDYWNoZWQgPSBudWxsCiAgICB0aGlzLnVwZ3JhZGVkID0gdHJ1ZQogICAgdGhpcy5sZW5ndGggKz0gaXRlLmZhY3RvciAvIDIKICAgIHRoaXMuYnl0ZUxlbmd0aCArPSBub2RlLnNpemUKICAgIHRoaXMucm9vdHMucHVzaChub2RlKQogICAgdGhpcy5ub2Rlcy5wdXNoKG5vZGUpCgogICAgd2hpbGUgKHRoaXMucm9vdHMubGVuZ3RoID4gMSkgewogICAgICBjb25zdCBhID0gdGhpcy5yb290c1t0aGlzLnJvb3RzLmxlbmd0aCAtIDFdCiAgICAgIGNvbnN0IGIgPSB0aGlzLnJvb3RzW3RoaXMucm9vdHMubGVuZ3RoIC0gMl0KCiAgICAgIC8vIFRPRE86IGp1c3QgaGF2ZSBhIHBlZWsgc2libGluZyBpbnN0ZWFkPyAocHJldHR5IHN1cmUgaXQncyBhbHdheXMgdGhlIGxlZnQgc2liIGFzIHdlbGwpCiAgICAgIGlmIChpdGUuc2libGluZygpICE9PSBiLmluZGV4KSB7CiAgICAgICAgaXRlLnNpYmxpbmcoKSAvLyB1bnNldCBzbyBpdCBhbHdheXMgcG9pbnRzIHRvIGxhc3Qgcm9vdAogICAgICAgIGJyZWFrCiAgICAgIH0KCiAgICAgIGNvbnN0IG5vZGUgPSB1bnNsYWJOb2RlKHBhcmVudE5vZGUoaXRlLnBhcmVudCgpLCBhLCBiKSkKICAgICAgdGhpcy5ub2Rlcy5wdXNoKG5vZGUpCiAgICAgIHRoaXMucm9vdHMucG9wKCkKICAgICAgdGhpcy5yb290cy5wb3AoKQogICAgICB0aGlzLnJvb3RzLnB1c2gobm9kZSkKICAgIH0KICB9CgogIGNvbW1pdGFibGUoKSB7CiAgICByZXR1cm4gKAogICAgICB0aGlzLnRyZWVGb3JrID09PSB0aGlzLnNlc3Npb24uZm9yayAmJgogICAgICAodGhpcy51cGdyYWRlZAogICAgICAgID8gdGhpcy50cmVlTGVuZ3RoID09PSB0aGlzLnNlc3Npb24ubGVuZ3RoCiAgICAgICAgOiB0aGlzLnRyZWVMZW5ndGggPD0gdGhpcy5zZXNzaW9uLmxlbmd0aCkKICAgICkKICB9CgogIGNvbW1pdCh0eCkgewogICAgaWYgKHR4ID09PSB1bmRlZmluZWQpIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdObyBkYXRhYmFzZSBiYXRjaCB3YXMgcGFzc2VkJykKICAgIGlmICghdGhpcy5jb21taXRhYmxlKCkpIHsKICAgICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ1RyZWUgd2FzIG1vZGlmaWVkIGR1cmluZyBiYXRjaCwgcmVmdXNpbmcgdG8gY29tbWl0JykKICAgIH0KCiAgICBpZiAodGhpcy51cGdyYWRlZCkgdGhpcy5fY29tbWl0VXBncmFkZSh0eCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qgbm9kZSA9IHRoaXMubm9kZXNbaV0KICAgICAgdHgucHV0VHJlZU5vZGUobm9kZSkKICAgIH0KCiAgICB0aGlzLmNvbW1pdHRlZCA9IHRydWUKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgX2NvbW1pdFVwZ3JhZGUodHgpIHsKICAgIC8vIFRPRE86IElmIGVhc3kgdG8gZGV0ZWN0LCB3ZSBzaG91bGQgcmVmdXNlIGFuIHRydW5jK2FwcGVuZCBoZXJlIHdpdGhvdXQgYSBmb3JrIGlkCiAgICAvLyBjaGFuZ2UuIFdpbGwgb25seSBoYXBwZW4gb24gdXNlciBlcnJvciBzbyBtb3N0bHkgdG8gcHJldmVudCB0aGF0LgoKICAgIGlmICh0aGlzLmFuY2VzdG9ycyA8IHRoaXMudHJlZUxlbmd0aCkgewogICAgICB0eC5kZWxldGVUcmVlTm9kZVJhbmdlKHRoaXMuYW5jZXN0b3JzICogMiwgdGhpcy50cmVlTGVuZ3RoICogMikKCiAgICAgIGlmICh0aGlzLmFuY2VzdG9ycyA+IDApIHsKICAgICAgICBjb25zdCBoZWFkID0gdGhpcy5hbmNlc3RvcnMgKiAyCiAgICAgICAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihoZWFkIC0gMikKCiAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgIGlmIChpdGUuY29udGFpbnMoaGVhZCkgJiYgaXRlLmluZGV4IDwgaGVhZCkgewogICAgICAgICAgICB0eC5kZWxldGVUcmVlTm9kZShpdGUuaW5kZXgpCiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXRlLm9mZnNldCA9PT0gMCkgYnJlYWsKICAgICAgICAgIGl0ZS5wYXJlbnQoKQogICAgICAgIH0KCiAgICAgICAgdGhpcy50cnVuY2F0ZWQgPSB0cnVlCiAgICAgIH0KICAgIH0KICB9CgogIHNlZWsoYnl0ZXMsIHBhZGRpbmcpIHsKICAgIHJldHVybiBuZXcgQnl0ZVNlZWtlcih0aGlzLCB0aGlzLCBieXRlcywgcGFkZGluZykKICB9CgogIGJ5dGVSYW5nZShpbmRleCkgewogICAgY29uc3QgcnggPSB0aGlzLnN0b3JhZ2UucmVhZCgpCiAgICBjb25zdCByYW5nZSA9IGdldEJ5dGVSYW5nZSh0aGlzLCBpbmRleCwgcngpCiAgICByeC50cnlGbHVzaCgpCgogICAgcmV0dXJuIHJhbmdlCiAgfQoKICBieXRlT2Zmc2V0KGluZGV4KSB7CiAgICBpZiAoaW5kZXggPT09IDIgKiB0aGlzLmxlbmd0aCkgcmV0dXJuIHRoaXMuYnl0ZUxlbmd0aAoKICAgIGNvbnN0IHJ4ID0gdGhpcy5zdG9yYWdlLnJlYWQoKQogICAgY29uc3Qgb2Zmc2V0ID0gZ2V0Qnl0ZU9mZnNldCh0aGlzLCBpbmRleCwgcngpCiAgICByeC50cnlGbHVzaCgpCgogICAgcmV0dXJuIG9mZnNldAogIH0KCiAgYXN5bmMgZG93bmdyYWRlKCkgewogICAgaWYgKCF0aGlzLnVwZ3JhZGVkKSByZXR1cm4gdHJ1ZQoKICAgIGNvbnN0IHJ4ID0gdGhpcy5zdG9yYWdlLnJlYWQoKQogICAgY29uc3Qgbm9kZVByb21pc2VzID0gW10KCiAgICBmb3IgKGNvbnN0IHIgb2YgdGhpcy5yb290cykgewogICAgICBub2RlUHJvbWlzZXMucHVzaChyeC5nZXRUcmVlTm9kZShyLmluZGV4KSkKICAgIH0KCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3Qgbm9kZXMgPSBhd2FpdCBQcm9taXNlLmFsbChub2RlUHJvbWlzZXMpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnJvb3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHJvb3QgPSB0aGlzLnJvb3RzW2ldCiAgICAgIGNvbnN0IG5vZGUgPSBub2Rlc1tpXQoKICAgICAgaWYgKCFub2RlKSByZXR1cm4gZmFsc2UKICAgICAgaWYgKCFiNGEuZXF1YWxzKG5vZGUuaGFzaCwgcm9vdC5oYXNoKSkgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgdGhpcy51cGdyYWRlZCA9IGZhbHNlCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgcmVzdG9yZShsZW5ndGgpIHsKICAgIGlmIChsZW5ndGggPT09IHRoaXMubGVuZ3RoKSByZXR1cm4gdGhpcwoKICAgIGNvbnN0IHJvb3RzID0gdW5zbGFiTm9kZXMoYXdhaXQgTWVya2xlVHJlZS5nZXRSb290c0Zyb21TdG9yYWdlKHRoaXMuc3RvcmFnZSwgbGVuZ3RoKSkKCiAgICB0aGlzLnJvb3RzID0gcm9vdHMKICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLmJ5dGVMZW5ndGggPSB0b3RhbFNpemUocm9vdHMpCiAgICB0aGlzLmFuY2VzdG9ycyA9IGxlbmd0aAoKICAgIGZvciAoY29uc3Qgbm9kZSBvZiByb290cykgdGhpcy5ieXRlTGVuZ3RoICs9IG5vZGUuc2l6ZQoKICAgIHJldHVybiB0aGlzCiAgfQp9CgpjbGFzcyBSZW9yZ0JhdGNoIGV4dGVuZHMgTWVya2xlVHJlZUJhdGNoIHsKICBjb25zdHJ1Y3RvcihzZXNzaW9uKSB7CiAgICBzdXBlcihzZXNzaW9uKQoKICAgIHRoaXMucm9vdHMgPSBbXQogICAgdGhpcy5sZW5ndGggPSAwCiAgICB0aGlzLmJ5dGVMZW5ndGggPSAwCiAgICB0aGlzLmRpZmYgPSBudWxsCiAgICB0aGlzLmFuY2VzdG9ycyA9IDAKICAgIC8vIFdlIHNldCB1cGdyYWRlZCBiZWNhdXNlIHJlb3JncyBhcmUgc2lnbmVkIHNvIGhpdCB3aWxsCiAgICAvLyBoaXQgdGhlIHNhbWUgY29kZSBwYXRocyAobGlrZSB0aGUgdHJlZUxlbmd0aCBjaGVjayBpbiBjb21taXQpCiAgICB0aGlzLnVwZ3JhZGVkID0gdHJ1ZQogICAgdGhpcy53YW50ID0gewogICAgICBub2RlczogMCwKICAgICAgc3RhcnQ6IDAsCiAgICAgIGVuZDogMAogICAgfQogIH0KCiAgZ2V0IGZpbmlzaGVkKCkgewogICAgcmV0dXJuIHRoaXMud2FudCA9PT0gbnVsbAogIH0KCiAgdXBkYXRlKHByb29mKSB7CiAgICBpZiAodGhpcy53YW50ID09PSBudWxsKSByZXR1cm4gdHJ1ZQoKICAgIGNvbnN0IG5vZGVzID0gW10KICAgIGNvbnN0IHJvb3QgPSB2ZXJpZnlUcmVlKHByb29mLCBub2RlcykKCiAgICBpZiAocm9vdCA9PT0gbnVsbCB8fCAhYjRhLmVxdWFscyhyb290Lmhhc2gsIHRoaXMuZGlmZi5oYXNoKSkgcmV0dXJuIGZhbHNlCgogICAgdGhpcy5ub2Rlcy5wdXNoKC4uLm5vZGVzKQogICAgcmV0dXJuIHRoaXMuX3VwZGF0ZShub2RlcykKICB9CgogIGFzeW5jIF91cGRhdGUobm9kZXMpIHsKICAgIGNvbnN0IG4gPSBuZXcgTWFwKCkKICAgIGZvciAoY29uc3Qgbm9kZSBvZiBub2Rlcykgbi5zZXQobm9kZS5pbmRleCwgbm9kZSkKCiAgICBsZXQgZGlmZiA9IG51bGwKICAgIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IodGhpcy5kaWZmLmluZGV4KQogICAgY29uc3Qgc3RhcnRpbmdEaWZmID0gdGhpcy5kaWZmCgogICAgd2hpbGUgKChpdGUuaW5kZXggJiAxKSAhPT0gMCkgewogICAgICBjb25zdCBsZWZ0ID0gbi5nZXQoaXRlLmxlZnRDaGlsZCgpKQogICAgICBpZiAoIWxlZnQpIGJyZWFrCgogICAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IGdldFRyZWVOb2RlRnJvbVN0b3JhZ2UodGhpcy5zZXNzaW9uLnN0b3JhZ2UsIGxlZnQuaW5kZXgpCiAgICAgIGlmICghZXhpc3RpbmcgfHwgIWI0YS5lcXVhbHMoZXhpc3RpbmcuaGFzaCwgbGVmdC5oYXNoKSkgewogICAgICAgIGRpZmYgPSBsZWZ0CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGlmZiA9IG4uZ2V0KGl0ZS5zaWJsaW5nKCkpCiAgICAgIH0KICAgIH0KCiAgICBpZiAoKHRoaXMuZGlmZi5pbmRleCAmIDEpID09PSAwKSByZXR1cm4gdHJ1ZQogICAgaWYgKGRpZmYgPT09IG51bGwpIHJldHVybiBmYWxzZQogICAgaWYgKHN0YXJ0aW5nRGlmZiAhPT0gdGhpcy5kaWZmKSByZXR1cm4gZmFsc2UKCiAgICByZXR1cm4gdGhpcy5fdXBkYXRlRGlmZlJvb3QoZGlmZikKICB9CgogIF91cGRhdGVEaWZmUm9vdChkaWZmKSB7CiAgICBpZiAodGhpcy53YW50ID09PSBudWxsKSByZXR1cm4gdHJ1ZQoKICAgIGNvbnN0IHNwYW5zID0gZmxhdC5zcGFucyhkaWZmLmluZGV4KQogICAgY29uc3Qgc3RhcnQgPSBzcGFuc1swXSAvIDIKICAgIGNvbnN0IGVuZCA9IE1hdGgubWluKHRoaXMudHJlZUxlbmd0aCwgc3BhbnNbMV0gLyAyICsgMSkKICAgIGNvbnN0IGxlbiA9IGVuZCAtIHN0YXJ0CgogICAgdGhpcy5hbmNlc3RvcnMgPSBzdGFydAogICAgdGhpcy5kaWZmID0gZGlmZgoKICAgIGlmICgoZGlmZi5pbmRleCAmIDEpID09PSAwIHx8IHRoaXMud2FudC5zdGFydCA+PSB0aGlzLnRyZWVMZW5ndGggfHwgbGVuIDw9IDApIHsKICAgICAgdGhpcy53YW50ID0gbnVsbAogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHRoaXMud2FudC5zdGFydCA9IHN0YXJ0CiAgICB0aGlzLndhbnQuZW5kID0gZW5kCiAgICB0aGlzLndhbnQubm9kZXMgPSBsb2cyKHNwYW5zWzFdIC0gc3BhbnNbMF0gKyAyKSAtIDEKCiAgICByZXR1cm4gZmFsc2UKICB9Cn0KCmNsYXNzIEJ5dGVTZWVrZXIgewogIGNvbnN0cnVjdG9yKHNlc3Npb24sIGJ5dGVzLCBwYWRkaW5nID0gMCkgewogICAgdGhpcy5zZXNzaW9uID0gc2Vzc2lvbgogICAgdGhpcy5ieXRlcyA9IGJ5dGVzCiAgICB0aGlzLnBhZGRpbmcgPSBwYWRkaW5nCgogICAgY29uc3Qgc2l6ZSA9IHNlc3Npb24uYnl0ZUxlbmd0aCAtIHNlc3Npb24ubGVuZ3RoICogcGFkZGluZwoKICAgIHRoaXMuc3RhcnQgPSBieXRlcyA+PSBzaXplID8gc2Vzc2lvbi5sZW5ndGggOiAwCiAgICB0aGlzLmVuZCA9IGJ5dGVzIDwgc2l6ZSA/IHNlc3Npb24ubGVuZ3RoIDogMAogIH0KCiAgYXN5bmMgX3NlZWsoYnl0ZXMpIHsKICAgIGlmICghYnl0ZXMpIHJldHVybiBbMCwgMF0KCiAgICBmb3IgKGNvbnN0IG5vZGUgb2YgdGhpcy5zZXNzaW9uLnJvb3RzKSB7CiAgICAgIC8vIGFsbCBhc3luYyB0aWNrcyBoYXBwZW4gb25jZSB3ZSBmaW5kIHRoZSByb290IHNvIHNhZmUKICAgICAgY29uc3Qgc2l6ZSA9IGdldFVucGFkZGVkU2l6ZShub2RlLCB0aGlzLnBhZGRpbmcsIG51bGwpCgogICAgICBpZiAoYnl0ZXMgPT09IHNpemUpIHJldHVybiBbZmxhdC5yaWdodFNwYW4obm9kZS5pbmRleCkgKyAyLCAwXQogICAgICBpZiAoYnl0ZXMgPiBzaXplKSB7CiAgICAgICAgYnl0ZXMgLT0gc2l6ZQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3Iobm9kZS5pbmRleCkKCiAgICAgIHdoaWxlICgoaXRlLmluZGV4ICYgMSkgIT09IDApIHsKICAgICAgICBjb25zdCBsID0gYXdhaXQgZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZSh0aGlzLnNlc3Npb24uc3RvcmFnZSwgaXRlLmxlZnRDaGlsZCgpKQoKICAgICAgICBpZiAobCkgewogICAgICAgICAgY29uc3Qgc2l6ZSA9IGdldFVucGFkZGVkU2l6ZShsLCB0aGlzLnBhZGRpbmcsIGl0ZSkKCiAgICAgICAgICBpZiAoc2l6ZSA9PT0gYnl0ZXMpIHJldHVybiBbaXRlLnJpZ2h0U3BhbigpICsgMiwgMF0KICAgICAgICAgIGlmIChzaXplID4gYnl0ZXMpIGNvbnRpbnVlCiAgICAgICAgICBieXRlcyAtPSBzaXplCiAgICAgICAgICBpdGUuc2libGluZygpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGl0ZS5wYXJlbnQoKQogICAgICAgICAgcmV0dXJuIFtpdGUuaW5kZXgsIGJ5dGVzXQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIFtpdGUuaW5kZXgsIGJ5dGVzXQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBhc3luYyB1cGRhdGUoKSB7CiAgICAvLyBUT0RPOiBjb21iaW5lIF9zZWVrIGFuZCB0aGlzLCBtdWNoIHNpbXBsZXIKICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuX3NlZWsodGhpcy5ieXRlcykKICAgIGlmICghcmVzKSByZXR1cm4gbnVsbAogICAgaWYgKChyZXNbMF0gJiAxKSA9PT0gMCkgcmV0dXJuIFtyZXNbMF0gLyAyLCByZXNbMV1dCgogICAgY29uc3Qgc3BhbiA9IGZsYXQuc3BhbnMocmVzWzBdKQogICAgdGhpcy5zdGFydCA9IHNwYW5bMF0gLyAyCiAgICB0aGlzLmVuZCA9IHNwYW5bMV0gLyAyICsgMQoKICAgIHJldHVybiBudWxsCiAgfQp9CgpjbGFzcyBUcmVlUHJvb2YgewogIGNvbnN0cnVjdG9yKHNlc3Npb24sIGJsb2NrLCBoYXNoLCBzZWVrLCB1cGdyYWRlKSB7CiAgICB0aGlzLmZvcmsgPSBzZXNzaW9uLmZvcmsKICAgIHRoaXMuc2lnbmF0dXJlID0gc2Vzc2lvbi5zaWduYXR1cmUKCiAgICB0aGlzLmJsb2NrID0gYmxvY2sKICAgIHRoaXMuaGFzaCA9IGhhc2gKICAgIHRoaXMuc2VlayA9IHNlZWsKICAgIHRoaXMudXBncmFkZSA9IHVwZ3JhZGUKCiAgICB0aGlzLnBlbmRpbmcgPSB7CiAgICAgIG5vZGU6IG51bGwsCiAgICAgIHNlZWs6IG51bGwsCiAgICAgIHVwZ3JhZGU6IG51bGwsCiAgICAgIGFkZGl0aW9uYWxVcGdyYWRlOiBudWxsCiAgICB9CiAgfQoKICBhc3luYyBzZXR0bGUoKSB7CiAgICBjb25zdCByZXN1bHQgPSB7CiAgICAgIGZvcms6IHRoaXMuZm9yaywKICAgICAgYmxvY2s6IG51bGwsCiAgICAgIGhhc2g6IG51bGwsCiAgICAgIHNlZWs6IG51bGwsCiAgICAgIHVwZ3JhZGU6IG51bGwsCiAgICAgIG1hbmlmZXN0OiBudWxsCiAgICB9CgogICAgY29uc3QgW3BOb2RlLCBwU2VlaywgcFVwZ3JhZGUsIHBBZGRpdGlvbmFsXSA9IGF3YWl0IHNldHRsZVByb29mKHRoaXMucGVuZGluZykKCiAgICBpZiAodGhpcy5ibG9jaykgewogICAgICBpZiAocE5vZGUgPT09IG51bGwpIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdJbnZhbGlkIGJsb2NrIHJlcXVlc3QnKQogICAgICByZXN1bHQuYmxvY2sgPSB7CiAgICAgICAgaW5kZXg6IHRoaXMuYmxvY2suaW5kZXgsCiAgICAgICAgdmFsdWU6IG51bGwsIC8vIHBvcHVsYXRlZCB1cHN0cmVhbSwgYWxsb2MgaXQgaGVyZSBmb3Igc2ltcGxpY2l0eQogICAgICAgIG5vZGVzOiBwTm9kZQogICAgICB9CiAgICB9IGVsc2UgaWYgKHRoaXMuaGFzaCkgewogICAgICBpZiAocE5vZGUgPT09IG51bGwpIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdJbnZhbGlkIGJsb2NrIHJlcXVlc3QnKQogICAgICByZXN1bHQuaGFzaCA9IHsKICAgICAgICBpbmRleDogdGhpcy5oYXNoLmluZGV4LAogICAgICAgIG5vZGVzOiBwTm9kZQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMuc2VlayAmJiBwU2VlayAhPT0gbnVsbCkgewogICAgICByZXN1bHQuc2VlayA9IHsKICAgICAgICBieXRlczogdGhpcy5zZWVrLmJ5dGVzLAogICAgICAgIG5vZGVzOiBwU2VlawogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMudXBncmFkZSkgewogICAgICByZXN1bHQudXBncmFkZSA9IHsKICAgICAgICBzdGFydDogdGhpcy51cGdyYWRlLnN0YXJ0LAogICAgICAgIGxlbmd0aDogdGhpcy51cGdyYWRlLmxlbmd0aCwKICAgICAgICBub2RlczogcFVwZ3JhZGUsCiAgICAgICAgYWRkaXRpb25hbE5vZGVzOiBwQWRkaXRpb25hbCB8fCBbXSwKICAgICAgICBzaWduYXR1cmU6IHRoaXMuc2lnbmF0dXJlCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmVzdWx0CiAgfQp9CgpjbGFzcyBNZXJrbGVUcmVlIHsKICBzdGF0aWMgaGFzaChzKSB7CiAgICByZXR1cm4gdW5zbGFiKGNyeXB0by50cmVlKHMucm9vdHMpKQogIH0KCiAgc3RhdGljIHNpZ25hYmxlKHMsIG5hbWVzcGFjZSkgewogICAgcmV0dXJuIGNhcHMudHJlZVNpZ25hYmxlKG5hbWVzcGFjZSwgTWVya2xlVHJlZS5oYXNoKHMpLCBzLmxlbmd0aCwgcy5mb3JrKQogIH0KCiAgc3RhdGljIHNpemUocm9vdHMpIHsKICAgIHJldHVybiB0b3RhbFNpemUocm9vdHMpCiAgfQoKICBzdGF0aWMgc3Bhbihyb290cykgewogICAgcmV0dXJuIHRvdGFsU3Bhbihyb290cykKICB9CgogIHN0YXRpYyBnZXRSb290cyhzZXNzaW9uLCBsZW5ndGgpIHsKICAgIHJldHVybiBNZXJrbGVUcmVlLmdldFJvb3RzRnJvbVN0b3JhZ2Uoc2Vzc2lvbi5zdG9yYWdlLCBsZW5ndGgpCiAgfQoKICBzdGF0aWMgZ2V0Um9vdHNGcm9tU3RvcmFnZShzdG9yYWdlLCBsZW5ndGgpIHsKICAgIGNvbnN0IGluZGV4ZXMgPSBmbGF0LmZ1bGxSb290cygyICogbGVuZ3RoKQogICAgY29uc3Qgcm9vdHMgPSBuZXcgQXJyYXkoaW5kZXhlcy5sZW5ndGgpCiAgICBjb25zdCByeCA9IHN0b3JhZ2UucmVhZCgpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRleGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJvb3RzW2ldID0gZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpbmRleGVzW2ldKQogICAgfQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICByZXR1cm4gUHJvbWlzZS5hbGwocm9vdHMpCiAgfQoKICBzdGF0aWMgYXN5bmMgdXBncmFkZWFibGUoc2Vzc2lvbiwgbGVuZ3RoKSB7CiAgICBjb25zdCBpbmRleGVzID0gZmxhdC5mdWxsUm9vdHMoMiAqIGxlbmd0aCkKICAgIGNvbnN0IHJvb3RzID0gbmV3IEFycmF5KGluZGV4ZXMubGVuZ3RoKQogICAgY29uc3QgcnggPSBzZXNzaW9uLnN0b3JhZ2UucmVhZCgpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRleGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJvb3RzW2ldID0gcnguZ2V0VHJlZU5vZGUoaW5kZXhlc1tpXSkKICAgIH0KCiAgICByeC50cnlGbHVzaCgpCgogICAgZm9yIChjb25zdCBub2RlIG9mIGF3YWl0IFByb21pc2UuYWxsKHJvb3RzKSkgewogICAgICBpZiAobm9kZSA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIHN0YXRpYyBzZWVrKHNlc3Npb24sIGJ5dGVzLCBwYWRkaW5nKSB7CiAgICByZXR1cm4gbmV3IEJ5dGVTZWVrZXIoc2Vzc2lvbiwgYnl0ZXMsIHBhZGRpbmcpCiAgfQoKICBzdGF0aWMgZ2V0KHNlc3Npb24sIGluZGV4KSB7CiAgICByZXR1cm4gZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZShzZXNzaW9uLnN0b3JhZ2UsIGluZGV4KQogIH0KCiAgc3RhdGljIGFzeW5jIHRydW5jYXRlKHNlc3Npb24sIGxlbmd0aCwgYmF0Y2gsIGZvcmsgPSBiYXRjaC5mb3JrKSB7CiAgICBjb25zdCBoZWFkID0gbGVuZ3RoICogMgogICAgY29uc3QgZnVsbFJvb3RzID0gZmxhdC5mdWxsUm9vdHMoaGVhZCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZ1bGxSb290cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCByb290ID0gZnVsbFJvb3RzW2ldCiAgICAgIGlmIChpIDwgYmF0Y2gucm9vdHMubGVuZ3RoICYmIGJhdGNoLnJvb3RzW2ldLmluZGV4ID09PSByb290KSBjb250aW51ZQoKICAgICAgd2hpbGUgKGJhdGNoLnJvb3RzLmxlbmd0aCA+IGkpIGJhdGNoLnJvb3RzLnBvcCgpCiAgICAgIGJhdGNoLnJvb3RzLnB1c2godW5zbGFiTm9kZShhd2FpdCBnZXRUcmVlTm9kZUZyb21TdG9yYWdlT3JFcnJvcihzZXNzaW9uLnN0b3JhZ2UsIHJvb3QpKSkKICAgIH0KCiAgICB3aGlsZSAoYmF0Y2gucm9vdHMubGVuZ3RoID4gZnVsbFJvb3RzLmxlbmd0aCkgewogICAgICBiYXRjaC5yb290cy5wb3AoKQogICAgfQoKICAgIGJhdGNoLmZvcmsgPSBmb3JrCiAgICBiYXRjaC5sZW5ndGggPSBsZW5ndGgKICAgIGJhdGNoLmFuY2VzdG9ycyA9IGxlbmd0aAogICAgYmF0Y2guYnl0ZUxlbmd0aCA9IHRvdGFsU2l6ZShiYXRjaC5yb290cykKICAgIGJhdGNoLnVwZ3JhZGVkID0gdHJ1ZQoKICAgIHJldHVybiBiYXRjaAogIH0KCiAgc3RhdGljIGFzeW5jIHJlb3JnKHNlc3Npb24sIHByb29mLCBiYXRjaCkgewogICAgbGV0IHVudmVyaWZpZWQgPSBudWxsCgogICAgaWYgKHByb29mLmJsb2NrIHx8IHByb29mLmhhc2ggfHwgcHJvb2Yuc2VlaykgewogICAgICB1bnZlcmlmaWVkID0gdmVyaWZ5VHJlZShwcm9vZiwgYmF0Y2gubm9kZXMpCiAgICB9CgogICAgaWYgKCF2ZXJpZnlVcGdyYWRlKHByb29mLCB1bnZlcmlmaWVkLCBiYXRjaCkpIHsKICAgICAgdGhyb3cgSU5WQUxJRF9QUk9PRignRm9yayBwcm9vZiBub3QgdmVyaWZpYWJsZScpCiAgICB9CgogICAgZm9yIChjb25zdCByb290IG9mIGJhdGNoLnJvb3RzKSB7CiAgICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZShzZXNzaW9uLnN0b3JhZ2UsIHJvb3QuaW5kZXgpCiAgICAgIGlmIChleGlzdGluZyAmJiBiNGEuZXF1YWxzKGV4aXN0aW5nLmhhc2gsIHJvb3QuaGFzaCkpIGNvbnRpbnVlCiAgICAgIGJhdGNoLl91cGRhdGVEaWZmUm9vdChyb290KQogICAgICBicmVhawogICAgfQoKICAgIGlmIChiYXRjaC5kaWZmICE9PSBudWxsKSB7CiAgICAgIGF3YWl0IGJhdGNoLl91cGRhdGUoYmF0Y2gubm9kZXMpCiAgICB9IGVsc2UgewogICAgICBiYXRjaC53YW50ID0gbnVsbAogICAgICBiYXRjaC5hbmNlc3RvcnMgPSBiYXRjaC5sZW5ndGgKICAgIH0KCiAgICByZXR1cm4gYmF0Y2gKICB9CgogIHN0YXRpYyB2ZXJpZnlGdWxseVJlbW90ZShzZXNzaW9uLCBwcm9vZikgewogICAgLy8gVE9ETzogaW1wbCB0aGlzIGxlc3MgaGFja2lzaGx5CiAgICBjb25zdCBiYXRjaCA9IG5ldyBNZXJrbGVUcmVlQmF0Y2goc2Vzc2lvbikKCiAgICBiYXRjaC5mb3JrID0gcHJvb2YuZm9yawogICAgYmF0Y2gucm9vdHMgPSBbXQogICAgYmF0Y2gubGVuZ3RoID0gMAogICAgYmF0Y2guYW5jZXN0b3JzID0gMAogICAgYmF0Y2guYnl0ZUxlbmd0aCA9IDAKCiAgICBsZXQgdW52ZXJpZmllZCA9IHZlcmlmeVRyZWUocHJvb2YsIGJhdGNoLm5vZGVzKQoKICAgIGlmIChwcm9vZi51cGdyYWRlKSB7CiAgICAgIGlmICh2ZXJpZnlVcGdyYWRlKHByb29mLCB1bnZlcmlmaWVkLCBiYXRjaCkpIHsKICAgICAgICB1bnZlcmlmaWVkID0gbnVsbAogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGJhdGNoCiAgfQoKICBzdGF0aWMgYXN5bmMgdmVyaWZ5KHNlc3Npb24sIHByb29mKSB7CiAgICBjb25zdCBiYXRjaCA9IG5ldyBNZXJrbGVUcmVlQmF0Y2goc2Vzc2lvbikKCiAgICBsZXQgdW52ZXJpZmllZCA9IHZlcmlmeVRyZWUocHJvb2YsIGJhdGNoLm5vZGVzKQoKICAgIGlmIChwcm9vZi51cGdyYWRlKSB7CiAgICAgIGlmICh2ZXJpZnlVcGdyYWRlKHByb29mLCB1bnZlcmlmaWVkLCBiYXRjaCkpIHsKICAgICAgICB1bnZlcmlmaWVkID0gbnVsbAogICAgICB9CiAgICB9CgogICAgaWYgKHVudmVyaWZpZWQpIHsKICAgICAgY29uc3QgdmVyaWZpZWQgPSBhd2FpdCBnZXRUcmVlTm9kZUZyb21TdG9yYWdlT3JFcnJvcihzZXNzaW9uLnN0b3JhZ2UsIHVudmVyaWZpZWQuaW5kZXgpCiAgICAgIGlmICghYjRhLmVxdWFscyh2ZXJpZmllZC5oYXNoLCB1bnZlcmlmaWVkLmhhc2gpKSB7CiAgICAgICAgdGhyb3cgSU5WQUxJRF9DSEVDS1NVTSgnSW52YWxpZCBjaGVja3N1bSBhdCBub2RlICcgKyB1bnZlcmlmaWVkLmluZGV4KQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGJhdGNoCiAgfQoKICBzdGF0aWMgcHJvb2Yoc2Vzc2lvbiwgcngsIHsgYmxvY2ssIGhhc2gsIHNlZWssIHVwZ3JhZGUgfSkgewogICAgcmV0dXJuIGdlbmVyYXRlUHJvb2Yoc2Vzc2lvbiwgcngsIGJsb2NrLCBoYXNoLCBzZWVrLCB1cGdyYWRlKQogIH0KCiAgc3RhdGljIG1heE1pc3NpbmdOb2RlcyhpbmRleCwgbGVuZ3RoKSB7CiAgICBjb25zdCBoZWFkID0gMiAqIGxlbmd0aAogICAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihpbmRleCkKCiAgICAvLyBTZWUgaXRlcmF0b3IucmlnaHRTcGFuKCkKICAgIGNvbnN0IGl0ZVJpZ2h0U3BhbiA9IGl0ZS5pbmRleCArIGl0ZS5mYWN0b3IgLyAyIC0gMQogICAgLy8gSWYgdGhlIGluZGV4IGlzIG5vdCBpbiB0aGUgY3VycmVudCB0cmVlLCB3ZSBkbyBub3Qga25vdyBob3cgbWFueSBtaXNzaW5nIG5vZGVzIHRoZXJlIGFyZS4uLgogICAgaWYgKGl0ZVJpZ2h0U3BhbiA+PSBoZWFkKSByZXR1cm4gMAoKICAgIGZvciAoY29uc3QgciBvZiBmbGF0LmZ1bGxSb290cyhoZWFkKSkgewogICAgICBpZiAociA9PT0gaW5kZXgpIHJldHVybiAwCiAgICB9CgogICAgbGV0IGNudCA9IDAKICAgIHdoaWxlICghaXRlLmNvbnRhaW5zKGhlYWQpKSB7CiAgICAgIGNudCsrCiAgICAgIGl0ZS5wYXJlbnQoKQogICAgfQoKICAgIHJldHVybiBjbnQKICB9CgogIHN0YXRpYyBhc3luYyBtaXNzaW5nTm9kZXMoc2Vzc2lvbiwgaW5kZXgsIGxlbmd0aCkgewogICAgY29uc3QgaGVhZCA9IDIgKiBsZW5ndGgKICAgIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IoaW5kZXgpCgogICAgLy8gU2VlIGl0ZXJhdG9yLnJpZ2h0U3BhbigpCiAgICBjb25zdCBpdGVSaWdodFNwYW4gPSBpdGUuaW5kZXggKyBpdGUuZmFjdG9yIC8gMiAtIDEKICAgIC8vIElmIHRoZSBpbmRleCBpcyBub3QgaW4gdGhlIGN1cnJlbnQgdHJlZSwgd2UgZG8gbm90IGtub3cgaG93IG1hbnkgbWlzc2luZyBub2RlcyB0aGVyZSBhcmUuLi4KICAgIGlmIChpdGVSaWdodFNwYW4gPj0gaGVhZCkgcmV0dXJuIDAKCiAgICBsZXQgY250ID0gMAogICAgLy8gVE9ETzogd2UgY291bGQgcHJvcCB1c2UgYSByZWFkIGJhdGNoIGhlcmUgYW5kIGRvIHRoaXMgaW4gYmxvY2tzIG9mIFggZm9yIHBlcmYKICAgIHdoaWxlICghaXRlLmNvbnRhaW5zKGhlYWQpICYmICEoYXdhaXQgaGFzVHJlZU5vZGUoc2Vzc2lvbi5zdG9yYWdlLCBpdGUuaW5kZXgpKSkgewogICAgICBjbnQrKwogICAgICBpZiAoY250ID49IDEwMjQpIHsKICAgICAgICB0aHJvdyBBU1NFUlRJT04oJ0JhZCBhcmd1bWVudHMgdG8gbWlzc2luZ05vZGVzIGluZGV4PScgKyBpbmRleCArICcgYXQgbGVuZ3RoPScgKyBsZW5ndGgpCiAgICAgIH0KICAgICAgaXRlLnBhcmVudCgpCiAgICB9CgogICAgcmV0dXJuIGNudAogIH0KCiAgc3RhdGljIGJ5dGVPZmZzZXQoc2Vzc2lvbiwgaW5kZXgpIHsKICAgIHJldHVybiBnZXRCeXRlT2Zmc2V0U2Vzc2lvbihzZXNzaW9uLCBpbmRleCwgbnVsbCkKICB9CgogIHN0YXRpYyBieXRlUmFuZ2Uoc2Vzc2lvbiwgaW5kZXgpIHsKICAgIGNvbnN0IHJ4ID0gc2Vzc2lvbi5zdG9yYWdlLnJlYWQoKQogICAgY29uc3Qgb2Zmc2V0ID0gZ2V0Qnl0ZU9mZnNldFNlc3Npb24oc2Vzc2lvbiwgaW5kZXgsIHJ4KQogICAgY29uc3Qgc2l6ZSA9IGdldE5vZGVTaXplKGluZGV4LCByeCkKICAgIHJ4LnRyeUZsdXNoKCkKICAgIHJldHVybiBQcm9taXNlLmFsbChbb2Zmc2V0LCBzaXplXSkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gewogIE1lcmtsZVRyZWVCYXRjaCwKICBSZW9yZ0JhdGNoLAogIE1lcmtsZVRyZWUKfQoKYXN5bmMgZnVuY3Rpb24gZ2V0Tm9kZVNpemUoaW5kZXgsIHJ4KSB7CiAgcmV0dXJuIChhd2FpdCBnZXRUcmVlTm9kZU9yRXJyb3IocngsIGluZGV4KSkuc2l6ZQp9Cgphc3luYyBmdW5jdGlvbiBnZXRCeXRlT2Zmc2V0U2Vzc2lvbihzZXNzaW9uLCBpbmRleCwgcngpIHsKICBpZiAoaW5kZXggPT09IDIgKiBzZXNzaW9uLmxlbmd0aCkgcmV0dXJuIHNlc3Npb24uYnl0ZUxlbmd0aAoKICBjb25zdCB0cmVlTm9kZXMgPQogICAgcnggPT09IG51bGwKICAgICAgPyBhd2FpdCBnZXRCeXRlT2Zmc2V0QmF0Y2hGbHVzaChzZXNzaW9uLnJvb3RzLCBpbmRleCwgc2Vzc2lvbi5zdG9yYWdlLnJlYWQoKSkKICAgICAgOiBhd2FpdCBnZXRCeXRlT2Zmc2V0QmF0Y2goc2Vzc2lvbi5yb290cywgaW5kZXgsIHJ4KQoKICBsZXQgb2Zmc2V0ID0gMAogIGZvciAoY29uc3Qgbm9kZSBvZiB0cmVlTm9kZXMpIG9mZnNldCArPSBub2RlLnNpemUKCiAgcmV0dXJuIG9mZnNldAp9Cgphc3luYyBmdW5jdGlvbiBnZXRCeXRlT2Zmc2V0KHRyZWUsIGluZGV4LCByeCkgewogIGlmIChpbmRleCA9PT0gMiAqIHRyZWUubGVuZ3RoKSByZXR1cm4gdHJlZS5ieXRlTGVuZ3RoCgogIGNvbnN0IHRyZWVOb2RlcyA9IGF3YWl0IGdldEJ5dGVPZmZzZXRCYXRjaCh0cmVlLnJvb3RzLCBpbmRleCwgcngpCgogIGxldCBvZmZzZXQgPSAwCiAgZm9yIChjb25zdCBub2RlIG9mIHRyZWVOb2Rlcykgb2Zmc2V0ICs9IG5vZGUuc2l6ZQoKICByZXR1cm4gb2Zmc2V0Cn0KCmZ1bmN0aW9uIGdldEJ5dGVPZmZzZXRCYXRjaEZsdXNoKHJvb3RzLCBpbmRleCwgcngpIHsKICBjb25zdCB0cmVlTm9kZXMgPSBnZXRCeXRlT2Zmc2V0QmF0Y2gocm9vdHMsIGluZGV4LCByeCkKICByeC50cnlGbHVzaCgpCiAgcmV0dXJuIHRyZWVOb2Rlcwp9CgpmdW5jdGlvbiBnZXRCeXRlT2Zmc2V0QmF0Y2gocm9vdHMsIGluZGV4LCByeCkgewogIGlmICgoaW5kZXggJiAxKSA9PT0gMSkgaW5kZXggPSBmbGF0LmxlZnRTcGFuKGluZGV4KQoKICBsZXQgaGVhZCA9IDAKICBsZXQgY250ID0gMAoKICBjb25zdCBwcm9taXNlcyA9IFtdCgogIGZvciAoY29uc3Qgbm9kZSBvZiByb290cykgewogICAgLy8gYWxsIGFzeW5jIHRpY2tzIGhhcHBlbiBvbmNlIHdlIGZpbmQgdGhlIHJvb3Qgc28gc2FmZQogICAgaGVhZCArPSAyICogKG5vZGUuaW5kZXggLSBoZWFkICsgMSkKCiAgICBpZiAoaW5kZXggPj0gaGVhZCkgewogICAgICBwcm9taXNlcy5wdXNoKG5vZGUuc2l6ZSkKICAgICAgY29udGludWUKICAgIH0KCiAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKG5vZGUuaW5kZXgpCgogICAgd2hpbGUgKGl0ZS5pbmRleCAhPT0gaW5kZXgpIHsKICAgICAgaWYgKCsrY250ID49IDEwMjQpIHRocm93IEFTU0VSVElPTignQmFkIGdldEJ5dGVPZmZzZXRTZXNzaW9uIGluZGV4PScgKyBpbmRleCkKCiAgICAgIGlmIChpbmRleCA8IGl0ZS5pbmRleCkgewogICAgICAgIGl0ZS5sZWZ0Q2hpbGQoKQogICAgICB9IGVsc2UgewogICAgICAgIHByb21pc2VzLnB1c2goZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpdGUubGVmdENoaWxkKCkpKQogICAgICAgIGl0ZS5zaWJsaW5nKCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcykKICB9CgogIHRocm93IEFTU0VSVElPTignRmFpbGVkIHRvIGZpbmQgb2Zmc2V0JykKfQoKZnVuY3Rpb24gZ2V0Qnl0ZVJhbmdlKHRyZWUsIGluZGV4LCByeCkgewogIGNvbnN0IGhlYWQgPSAyICogdHJlZS5sZW5ndGgKICBpZiAoKChpbmRleCAmIDEpID09PSAwID8gaW5kZXggOiBmbGF0LnJpZ2h0U3BhbihpbmRleCkpID49IGhlYWQpIHsKICAgIHRocm93IEJBRF9BUkdVTUVOVCgnSW5kZXggaXMgb3V0IG9mIGJvdW5kcycpCiAgfQoKICBjb25zdCBvZmZzZXQgPSBnZXRCeXRlT2Zmc2V0KHRyZWUsIGluZGV4LCByeCkKICBjb25zdCBzaXplID0gZ2V0Tm9kZVNpemUoaW5kZXgsIHJ4KQoKICByZXR1cm4gUHJvbWlzZS5hbGwoW29mZnNldCwgc2l6ZV0pCn0KCi8vIEFsbCB0aGUgbWV0aG9kcyBuZWVkZWQgZm9yIHByb29mIHZlcmlmaWNhdGlvbgoKZnVuY3Rpb24gdmVyaWZ5VHJlZSh7IGJsb2NrLCBoYXNoLCBzZWVrIH0sIG5vZGVzKSB7CiAgY29uc3QgdW50cnVzdGVkTm9kZSA9IGJsb2NrCiAgICA/IHsgaW5kZXg6IDIgKiBibG9jay5pbmRleCwgdmFsdWU6IGJsb2NrLnZhbHVlLCBub2RlczogYmxvY2subm9kZXMgfQogICAgOiBoYXNoCiAgICAgID8geyBpbmRleDogaGFzaC5pbmRleCwgdmFsdWU6IG51bGwsIG5vZGVzOiBoYXNoLm5vZGVzIH0KICAgICAgOiBudWxsCgogIGlmICh1bnRydXN0ZWROb2RlID09PSBudWxsICYmICghc2VlayB8fCAhc2Vlay5ub2Rlcy5sZW5ndGgpKSByZXR1cm4gbnVsbAoKICBsZXQgcm9vdCA9IG51bGwKCiAgaWYgKHNlZWsgJiYgc2Vlay5ub2Rlcy5sZW5ndGgpIHsKICAgIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3Ioc2Vlay5ub2Rlc1swXS5pbmRleCkKICAgIGNvbnN0IHEgPSBuZXcgTm9kZVF1ZXVlKHNlZWsubm9kZXMpCgogICAgcm9vdCA9IHEuc2hpZnQoaXRlLmluZGV4KQogICAgbm9kZXMucHVzaChyb290KQoKICAgIHdoaWxlIChxLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3Qgbm9kZSA9IHEuc2hpZnQoaXRlLnNpYmxpbmcoKSkKCiAgICAgIHJvb3QgPSBwYXJlbnROb2RlKGl0ZS5wYXJlbnQoKSwgcm9vdCwgbm9kZSkKICAgICAgbm9kZXMucHVzaChub2RlKQogICAgICBub2Rlcy5wdXNoKHJvb3QpCiAgICB9CiAgfQoKICBpZiAodW50cnVzdGVkTm9kZSA9PT0gbnVsbCkgcmV0dXJuIHJvb3QKCiAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcih1bnRydXN0ZWROb2RlLmluZGV4KQogIGNvbnN0IGJsb2NrSGFzaCA9IHVudHJ1c3RlZE5vZGUudmFsdWUgJiYgYmxvY2tOb2RlKGl0ZS5pbmRleCwgdW50cnVzdGVkTm9kZS52YWx1ZSkKCiAgY29uc3QgcSA9IG5ldyBOb2RlUXVldWUodW50cnVzdGVkTm9kZS5ub2Rlcywgcm9vdCkKCiAgcm9vdCA9IGJsb2NrSGFzaCB8fCBxLnNoaWZ0KGl0ZS5pbmRleCkKICBub2Rlcy5wdXNoKHJvb3QpCgogIHdoaWxlIChxLmxlbmd0aCA+IDApIHsKICAgIGNvbnN0IG5vZGUgPSBxLnNoaWZ0KGl0ZS5zaWJsaW5nKCkpCgogICAgcm9vdCA9IHBhcmVudE5vZGUoaXRlLnBhcmVudCgpLCByb290LCBub2RlKQogICAgbm9kZXMucHVzaChub2RlKQogICAgbm9kZXMucHVzaChyb290KQogIH0KCiAgcmV0dXJuIHJvb3QKfQoKZnVuY3Rpb24gdmVyaWZ5VXBncmFkZSh7IGZvcmssIHVwZ3JhZGUgfSwgYmxvY2tSb290LCBiYXRjaCkgewogIGNvbnN0IHByb2xvZ3VlID0gYmF0Y2gucHJvbG9ndWUKCiAgaWYgKHByb2xvZ3VlKSB7CiAgICBjb25zdCB7IHN0YXJ0LCBsZW5ndGggfSA9IHVwZ3JhZGUKICAgIGlmIChzdGFydCA8IHByb2xvZ3VlLmxlbmd0aCAmJiAoc3RhcnQgIT09IDAgfHwgbGVuZ3RoIDwgcHJvbG9ndWUubGVuZ3RoKSkgewogICAgICB0aHJvdyBJTlZBTElEX1BST09GKCdVcGdyYWRlIGRvZXMgbm90IHNhdGlzZnkgcHJvbG9ndWUnKQogICAgfQogIH0KCiAgY29uc3QgcSA9IG5ldyBOb2RlUXVldWUodXBncmFkZS5ub2RlcywgYmxvY2tSb290KQoKICBsZXQgZ3JvdyA9IGJhdGNoLnJvb3RzLmxlbmd0aCA+IDAKICBsZXQgaSA9IDAKCiAgY29uc3QgdG8gPSAyICogKHVwZ3JhZGUuc3RhcnQgKyB1cGdyYWRlLmxlbmd0aCkKICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKDApCgogIGZvciAoOyBpdGUuZnVsbFJvb3QodG8pOyBpdGUubmV4dFRyZWUoKSkgewogICAgaWYgKGkgPCBiYXRjaC5yb290cy5sZW5ndGggJiYgYmF0Y2gucm9vdHNbaV0uaW5kZXggPT09IGl0ZS5pbmRleCkgewogICAgICBpKysKICAgICAgY29udGludWUKICAgIH0KCiAgICBpZiAoZ3JvdykgewogICAgICBncm93ID0gZmFsc2UKICAgICAgY29uc3Qgcm9vdCA9IGl0ZS5pbmRleAogICAgICBpZiAoaSA8IGJhdGNoLnJvb3RzLmxlbmd0aCkgewogICAgICAgIGl0ZS5zZWVrKGJhdGNoLnJvb3RzW2JhdGNoLnJvb3RzLmxlbmd0aCAtIDFdLmluZGV4KQogICAgICAgIHdoaWxlIChpdGUuaW5kZXggIT09IHJvb3QpIHsKICAgICAgICAgIGJhdGNoLmFwcGVuZFJvb3QocS5zaGlmdChpdGUuc2libGluZygpKSwgaXRlKQogICAgICAgIH0KICAgICAgICBjb250aW51ZQogICAgICB9CiAgICB9CgogICAgYmF0Y2guYXBwZW5kUm9vdChxLnNoaWZ0KGl0ZS5pbmRleCksIGl0ZSkKICB9CgogIGlmIChwcm9sb2d1ZSAmJiBiYXRjaC5sZW5ndGggPT09IHByb2xvZ3VlLmxlbmd0aCkgewogICAgaWYgKCFiNGEuZXF1YWxzKHByb2xvZ3VlLmhhc2gsIGJhdGNoLmhhc2goKSkpIHsKICAgICAgdGhyb3cgSU5WQUxJRF9QUk9PRignSW52YWxpZCBoYXNoJykKICAgIH0KICB9CgogIGNvbnN0IGV4dHJhID0gdXBncmFkZS5hZGRpdGlvbmFsTm9kZXMKCiAgaXRlLnNlZWsoYmF0Y2gucm9vdHNbYmF0Y2gucm9vdHMubGVuZ3RoIC0gMV0uaW5kZXgpCiAgaSA9IDAKCiAgd2hpbGUgKGkgPCBleHRyYS5sZW5ndGggJiYgZXh0cmFbaV0uaW5kZXggPT09IGl0ZS5zaWJsaW5nKCkpIHsKICAgIGJhdGNoLmFwcGVuZFJvb3QoZXh0cmFbaSsrXSwgaXRlKQogIH0KCiAgd2hpbGUgKGkgPCBleHRyYS5sZW5ndGgpIHsKICAgIGNvbnN0IG5vZGUgPSBleHRyYVtpKytdCgogICAgd2hpbGUgKG5vZGUuaW5kZXggIT09IGl0ZS5pbmRleCkgewogICAgICBpZiAoaXRlLmZhY3RvciA9PT0gMikgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ1VuZXhwZWN0ZWQgbm9kZTogJyArIG5vZGUuaW5kZXgpCiAgICAgIGl0ZS5sZWZ0Q2hpbGQoKQogICAgfQoKICAgIGJhdGNoLmFwcGVuZFJvb3Qobm9kZSwgaXRlKQogICAgaXRlLnNpYmxpbmcoKQogIH0KCiAgYmF0Y2guc2lnbmF0dXJlID0gdW5zbGFiKHVwZ3JhZGUuc2lnbmF0dXJlKQogIGJhdGNoLmZvcmsgPSBmb3JrCgogIHJldHVybiBxLmV4dHJhID09PSBudWxsCn0KCmFzeW5jIGZ1bmN0aW9uIHNlZWtGcm9tSGVhZChzZXNzaW9uLCBoZWFkLCBieXRlcywgcGFkZGluZykgewogIGNvbnN0IHJvb3RzID0gZmxhdC5mdWxsUm9vdHMoaGVhZCkKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCByb290cy5sZW5ndGg7IGkrKykgewogICAgY29uc3Qgcm9vdCA9IHJvb3RzW2ldCiAgICBjb25zdCBub2RlID0gYXdhaXQgZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZShzZXNzaW9uLnN0b3JhZ2UsIHJvb3QpCiAgICBjb25zdCBzaXplID0gZ2V0VW5wYWRkZWRTaXplKG5vZGUsIHBhZGRpbmcsIG51bGwpCgogICAgaWYgKGJ5dGVzID09PSBzaXplKSByZXR1cm4gcm9vdAogICAgaWYgKGJ5dGVzID4gc2l6ZSkgewogICAgICBieXRlcyAtPSBzaXplCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgcmV0dXJuIHNlZWtUcnVzdGVkVHJlZShzZXNzaW9uLCByb290LCBieXRlcywgcGFkZGluZykKICB9CgogIHJldHVybiBoZWFkCn0KCi8vIHRydXN0IHRoYXQgYnl0ZXMgYXJlIHdpdGhpbiB0aGUgcm9vdCB0cmVlIGFuZCBmaW5kIHRoZSBibG9jayBhdCBieXRlcwoKYXN5bmMgZnVuY3Rpb24gc2Vla1RydXN0ZWRUcmVlKHNlc3Npb24sIHJvb3QsIGJ5dGVzLCBwYWRkaW5nKSB7CiAgaWYgKCFieXRlcykgcmV0dXJuIHJvb3QKCiAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihyb290KQogIGxldCBjbnQgPSAwCgogIHdoaWxlICgoaXRlLmluZGV4ICYgMSkgIT09IDApIHsKICAgIGlmICgrK2NudCA+PSAxMDI0KSB0aHJvdyBBU1NFUlRJT04oJ0JhZCBzZWVrVHJ1c3RlZCBieXRlcz0nICsgYnl0ZXMgKyAnLCBwYWRkZGluZz0nICsgcGFkZGluZykKICAgIGNvbnN0IGwgPSBhd2FpdCBnZXRUcmVlTm9kZUZyb21TdG9yYWdlKHNlc3Npb24uc3RvcmFnZSwgaXRlLmxlZnRDaGlsZCgpKQoKICAgIGlmIChsKSB7CiAgICAgIGNvbnN0IHNpemUgPSBnZXRVbnBhZGRlZFNpemUobCwgcGFkZGluZywgaXRlKQogICAgICBpZiAoc2l6ZSA9PT0gYnl0ZXMpIHJldHVybiBpdGUuaW5kZXgKICAgICAgaWYgKHNpemUgPiBieXRlcykgY29udGludWUKICAgICAgYnl0ZXMgLT0gc2l6ZQogICAgICBpdGUuc2libGluZygpCiAgICB9IGVsc2UgewogICAgICBpdGUucGFyZW50KCkKICAgICAgcmV0dXJuIGl0ZS5pbmRleAogICAgfQogIH0KCiAgcmV0dXJuIGl0ZS5pbmRleAp9CgovLyB0cnkgdG8gZmluZCB0aGUgYmxvY2sgYXQgYnl0ZXMgd2l0aG91dCB0cnVzdGluZyB0aGF0IGlzICppcyogd2l0aGluIHRoZSByb290IHBhc3NlZAoKYXN5bmMgZnVuY3Rpb24gc2Vla1VudHJ1c3RlZFRyZWUoc2Vzc2lvbiwgcm9vdCwgYnl0ZXMsIHBhZGRpbmcpIHsKICBjb25zdCBvZmZzZXQgPQogICAgKGF3YWl0IGdldEJ5dGVPZmZzZXRTZXNzaW9uKHNlc3Npb24sIHJvb3QsIG51bGwpKSAtCiAgICAocGFkZGluZyA/IChwYWRkaW5nICogZmxhdC5sZWZ0U3Bhbihyb290KSkgLyAyIDogMCkKCiAgaWYgKG9mZnNldCA+IGJ5dGVzKSB0aHJvdyBJTlZBTElEX09QRVJBVElPTignSW52YWxpZCBzZWVrJykKICBpZiAob2Zmc2V0ID09PSBieXRlcykgcmV0dXJuIHJvb3QKCiAgYnl0ZXMgLT0gb2Zmc2V0CgogIGNvbnN0IG5vZGUgPSBhd2FpdCBnZXRUcmVlTm9kZUZyb21TdG9yYWdlT3JFcnJvcihzZXNzaW9uLnN0b3JhZ2UsIHJvb3QpCgogIGlmIChnZXRVbnBhZGRlZFNpemUobm9kZSwgcGFkZGluZywgbnVsbCkgPD0gYnl0ZXMpIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdJbnZhbGlkIHNlZWsnKQoKICByZXR1cm4gc2Vla1RydXN0ZWRUcmVlKHNlc3Npb24sIHJvb3QsIGJ5dGVzLCBwYWRkaW5nKQp9CgovLyBCZWxvdyBpcyBwcm9vZiBwcm9kdWN0aW9uLCBpZSwgY29uc3RydWN0IHByb29mcyB0byB2ZXJpZnkgYSByZXF1ZXN0Ci8vIE5vdGUsIHRoYXQgYWxsIHRoZXNlIG1ldGhvZHMgYXJlIHN5bmMgYXMgd2UgY2FuIHN0YXRpY2FsbHkgaW5mZXIgd2hpY2ggbm9kZXMKLy8gYXJlIG5lZWRlZCBmb3IgdGhlIHJlbW90ZSB0byB2ZXJpZnkgZ2l2ZW4gdGhleSBhcmd1bWVudHMgdGhleSBwYXNzZWQgdXMKCmZ1bmN0aW9uIHNlZWtQcm9vZihzZXNzaW9uLCByeCwgc2Vla1Jvb3QsIHJvb3QsIHApIHsKICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKHNlZWtSb290KQogIGxldCBjbnQgPSAwCgogIHAuc2VlayA9IFtdCiAgcC5zZWVrLnB1c2goZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpdGUuaW5kZXgpKQoKICB3aGlsZSAoaXRlLmluZGV4ICE9PSByb290KSB7CiAgICBpZiAoKytjbnQgPj0gMTAyNCkgdGhyb3cgQVNTRVJUSU9OKCdCYWQgc2Vla1Byb29mIHNlZWtSb290PScgKyBzZWVrUm9vdCArICcsIHJvb3Q9JyArIHJvb3QpCiAgICBpdGUuc2libGluZygpCiAgICBwLnNlZWsucHVzaChnZXRUcmVlTm9kZU9yRXJyb3IocngsIGl0ZS5pbmRleCkpCiAgICBpdGUucGFyZW50KCkKICB9Cn0KCmZ1bmN0aW9uIGJsb2NrQW5kU2Vla1Byb29mKHNlc3Npb24sIHJ4LCBub2RlLCBzZWVrLCBzZWVrUm9vdCwgcm9vdCwgcCkgewogIGlmICghbm9kZSkgcmV0dXJuIHNlZWtQcm9vZihzZXNzaW9uLCByeCwgc2Vla1Jvb3QsIHJvb3QsIHApCgogIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3Iobm9kZS5pbmRleCkKICBsZXQgY250ID0gMAoKICBwLm5vZGUgPSBbXQogIGlmICghbm9kZS52YWx1ZSkgcC5ub2RlLnB1c2goZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpdGUuaW5kZXgpKQoKICB3aGlsZSAoaXRlLmluZGV4ICE9PSByb290KSB7CiAgICBpZiAoKytjbnQgPj0gMTAyNCkgewogICAgICB0aHJvdyBBU1NFUlRJT04oJ0JhZCBibG9ja0FuZFNlZWtQcm9vZiBzZWVrUm9vdD0nICsgc2Vla1Jvb3QgKyAnLCByb290PScgKyByb290KQogICAgfQogICAgaXRlLnNpYmxpbmcoKQoKICAgIGlmIChzZWVrICYmIGl0ZS5jb250YWlucyhzZWVrUm9vdCkgJiYgaXRlLmluZGV4ICE9PSBzZWVrUm9vdCkgewogICAgICBzZWVrUHJvb2Yoc2Vzc2lvbiwgcngsIHNlZWtSb290LCBpdGUuaW5kZXgsIHApCiAgICB9IGVsc2UgewogICAgICBwLm5vZGUucHVzaChnZXRUcmVlTm9kZU9yRXJyb3IocngsIGl0ZS5pbmRleCkpCiAgICB9CgogICAgaXRlLnBhcmVudCgpCiAgfQp9CgpmdW5jdGlvbiB1cGdyYWRlUHJvb2Yoc2Vzc2lvbiwgcngsIG5vZGUsIHNlZWssIGZyb20sIHRvLCBzdWJUcmVlLCBwKSB7CiAgaWYgKGZyb20gPT09IDApIHAudXBncmFkZSA9IFtdCgogIGZvciAoY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcigwKTsgaXRlLmZ1bGxSb290KHRvKTsgaXRlLm5leHRUcmVlKCkpIHsKICAgIC8vIGNoZWNrIGlmIHRoZXkgYWxyZWFkeSBoYXZlIHRoZSBub2RlCiAgICBpZiAoaXRlLmluZGV4ICsgaXRlLmZhY3RvciAvIDIgPCBmcm9tKSBjb250aW51ZQoKICAgIC8vIGNvbm5lY3QgZXhpc3RpbmcgdHJlZQogICAgaWYgKHAudXBncmFkZSA9PT0gbnVsbCAmJiBpdGUuY29udGFpbnMoZnJvbSAtIDIpKSB7CiAgICAgIHAudXBncmFkZSA9IFtdCgogICAgICBjb25zdCByb290ID0gaXRlLmluZGV4CiAgICAgIGNvbnN0IHRhcmdldCA9IGZyb20gLSAyCiAgICAgIGxldCBjbnQgPSAwCgogICAgICBpdGUuc2Vlayh0YXJnZXQpCgogICAgICB3aGlsZSAoaXRlLmluZGV4ICE9PSByb290KSB7CiAgICAgICAgaWYgKCsrY250ID49IDEwMjQpIHRocm93IEFTU0VSVElPTignQmFkIHVwZ3JhZGVQcm9vZiB0YXJnZXQ9JyArIHRhcmdldCArICcsIHJvb3Q9JyArIHJvb3QpCgogICAgICAgIGl0ZS5zaWJsaW5nKCkKICAgICAgICBpZiAoaXRlLmluZGV4ID4gdGFyZ2V0KSB7CiAgICAgICAgICBpZiAocC5ub2RlID09PSBudWxsICYmIHAuc2VlayA9PT0gbnVsbCAmJiBpdGUuY29udGFpbnMoc3ViVHJlZSkpIHsKICAgICAgICAgICAgYmxvY2tBbmRTZWVrUHJvb2Yoc2Vzc2lvbiwgcngsIG5vZGUsIHNlZWssIHN1YlRyZWUsIGl0ZS5pbmRleCwgcCkKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHAudXBncmFkZS5wdXNoKGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaXRlLmluZGV4KSkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaXRlLnBhcmVudCgpCiAgICAgIH0KCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgaWYgKHAudXBncmFkZSA9PT0gbnVsbCkgewogICAgICBwLnVwZ3JhZGUgPSBbXQogICAgfQoKICAgIC8vIGlmIHRoZSBzdWJ0cmVlIGluY2x1ZGVkIGlzIGEgY2hpbGQgb2YgdGhpcyB0cmVlLCBpbmNsdWRlIHRoYXQgb25lCiAgICAvLyBpbnN0ZWFkIG9mIGEgZHVwIG5vZGUKICAgIGlmIChwLm5vZGUgPT09IG51bGwgJiYgcC5zZWVrID09PSBudWxsICYmIGl0ZS5jb250YWlucyhzdWJUcmVlKSkgewogICAgICBibG9ja0FuZFNlZWtQcm9vZihzZXNzaW9uLCByeCwgbm9kZSwgc2Vlaywgc3ViVHJlZSwgaXRlLmluZGV4LCBwKQogICAgICBjb250aW51ZQogICAgfQoKICAgIC8vIGFkZCByb290IChjYW4gYmUgb3B0aW1pc2VkIHNpbmNlIHRoZSByb290IG1pZ2h0IGJlIGluIHRyZWUucm9vdHMpCiAgICBwLnVwZ3JhZGUucHVzaChnZXRUcmVlTm9kZU9yRXJyb3IocngsIGl0ZS5pbmRleCkpCiAgfQp9CgpmdW5jdGlvbiBhZGRpdGlvbmFsVXBncmFkZVByb29mKHNlc3Npb24sIHJ4LCBmcm9tLCB0bywgcCkgewogIGlmIChmcm9tID09PSAwKSBwLmFkZGl0aW9uYWxVcGdyYWRlID0gW10KCiAgZm9yIChjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKDApOyBpdGUuZnVsbFJvb3QodG8pOyBpdGUubmV4dFRyZWUoKSkgewogICAgLy8gY2hlY2sgaWYgdGhleSBhbHJlYWR5IGhhdmUgdGhlIG5vZGUKICAgIGlmIChpdGUuaW5kZXggKyBpdGUuZmFjdG9yIC8gMiA8IGZyb20pIGNvbnRpbnVlCgogICAgLy8gY29ubmVjdCBleGlzdGluZyB0cmVlCiAgICBpZiAocC5hZGRpdGlvbmFsVXBncmFkZSA9PT0gbnVsbCAmJiBpdGUuY29udGFpbnMoZnJvbSAtIDIpKSB7CiAgICAgIHAuYWRkaXRpb25hbFVwZ3JhZGUgPSBbXQoKICAgICAgY29uc3Qgcm9vdCA9IGl0ZS5pbmRleAogICAgICBjb25zdCB0YXJnZXQgPSBmcm9tIC0gMgogICAgICBsZXQgY250ID0gMAoKICAgICAgaXRlLnNlZWsodGFyZ2V0KQoKICAgICAgd2hpbGUgKGl0ZS5pbmRleCAhPT0gcm9vdCkgewogICAgICAgIGlmICgrK2NudCA+PSAxMDI0KSB7CiAgICAgICAgICB0aHJvdyBBU1NFUlRJT04oCiAgICAgICAgICAgICdCYWQgYXJndW1lbnRzIHRvIGFkZGl0aW9uYWxVcGdyYWRlUHJvb2Ygcm9vdD0nICsgcm9vdCArICcgdGFyZ2V0PScgKyB0YXJnZXQKICAgICAgICAgICkKICAgICAgICB9CiAgICAgICAgaXRlLnNpYmxpbmcoKQogICAgICAgIGlmIChpdGUuaW5kZXggPiB0YXJnZXQpIHsKICAgICAgICAgIHAuYWRkaXRpb25hbFVwZ3JhZGUucHVzaChnZXRUcmVlTm9kZU9yRXJyb3IocngsIGl0ZS5pbmRleCkpCiAgICAgICAgfQogICAgICAgIGl0ZS5wYXJlbnQoKQogICAgICB9CgogICAgICBjb250aW51ZQogICAgfQoKICAgIGlmIChwLmFkZGl0aW9uYWxVcGdyYWRlID09PSBudWxsKSB7CiAgICAgIHAuYWRkaXRpb25hbFVwZ3JhZGUgPSBbXQogICAgfQoKICAgIC8vIGFkZCByb290IChjYW4gYmUgb3B0aW1pc2VkIHNpbmNlIHRoZSByb290IGlzIGluIHRyZWUucm9vdHMpCiAgICBwLmFkZGl0aW9uYWxVcGdyYWRlLnB1c2goZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpdGUuaW5kZXgpKQogIH0KfQoKZnVuY3Rpb24gbm9kZXNUb1Jvb3QoaW5kZXgsIG5vZGVzLCBoZWFkKSB7CiAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihpbmRleCkKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlczsgaSsrKSB7CiAgICBpdGUucGFyZW50KCkKICAgIGlmIChpdGUuY29udGFpbnMoaGVhZCkpIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdOb2RlcyBpcyBvdXQgb2YgYm91bmRzJykKICB9CgogIHJldHVybiBpdGUuaW5kZXgKfQoKZnVuY3Rpb24gdG90YWxTaXplKG5vZGVzKSB7CiAgbGV0IHMgPSAwCiAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSBzICs9IG5vZGUuc2l6ZQogIHJldHVybiBzCn0KCmZ1bmN0aW9uIHRvdGFsU3Bhbihub2RlcykgewogIGxldCBzID0gMAogIGZvciAoY29uc3Qgbm9kZSBvZiBub2RlcykgcyArPSAyICogKG5vZGUuaW5kZXggLSBzICsgMSkKICByZXR1cm4gcwp9CgpmdW5jdGlvbiBibG9ja05vZGUoaW5kZXgsIHZhbHVlKSB7CiAgcmV0dXJuIHsgaW5kZXgsIHNpemU6IHZhbHVlLmJ5dGVMZW5ndGgsIGhhc2g6IGNyeXB0by5kYXRhKHZhbHVlKSB9Cn0KCmZ1bmN0aW9uIHBhcmVudE5vZGUoaW5kZXgsIGEsIGIpIHsKICByZXR1cm4geyBpbmRleCwgc2l6ZTogYS5zaXplICsgYi5zaXplLCBoYXNoOiBjcnlwdG8ucGFyZW50KGEsIGIpIH0KfQoKZnVuY3Rpb24gbG9nMihuKSB7CiAgbGV0IHJlcyA9IDEKCiAgd2hpbGUgKG4gPiAyKSB7CiAgICBuIC89IDIKICAgIHJlcysrCiAgfQoKICByZXR1cm4gcmVzCn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZUluZGV4ZWQoYmxvY2ssIGhhc2gpIHsKICBpZiAoYmxvY2spIHsKICAgIHJldHVybiB7CiAgICAgIHZhbHVlOiB0cnVlLAogICAgICBpbmRleDogYmxvY2suaW5kZXggKiAyLAogICAgICBub2RlczogYmxvY2subm9kZXMsCiAgICAgIGxhc3RJbmRleDogYmxvY2suaW5kZXgKICAgIH0KICB9CiAgaWYgKGhhc2gpIHsKICAgIHJldHVybiB7CiAgICAgIHZhbHVlOiBmYWxzZSwKICAgICAgaW5kZXg6IGhhc2guaW5kZXgsCiAgICAgIG5vZGVzOiBoYXNoLm5vZGVzLAogICAgICBsYXN0SW5kZXg6IGZsYXQucmlnaHRTcGFuKGhhc2guaW5kZXgpIC8gMgogICAgfQogIH0KICByZXR1cm4gbnVsbAp9Cgphc3luYyBmdW5jdGlvbiBnZXRUcmVlTm9kZU9yRXJyb3IocngsIGluZGV4KSB7CiAgY29uc3Qgbm9kZSA9IGF3YWl0IHJ4LmdldFRyZWVOb2RlKGluZGV4KQogIGlmIChub2RlID09PSBudWxsKSB7CiAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTignRXhwZWN0ZWQgdHJlZSBub2RlICcgKyBpbmRleCArICcgZnJvbSBzdG9yYWdlLCBnb3QgKG5pbCknKQogIH0KICByZXR1cm4gbm9kZQp9CgpmdW5jdGlvbiBnZXRUcmVlTm9kZUZyb21TdG9yYWdlT3JFcnJvcihzdG9yYWdlLCBpbmRleCkgewogIGNvbnN0IHJ4ID0gc3RvcmFnZS5yZWFkKCkKICBjb25zdCBwID0gZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpbmRleCkKICByeC50cnlGbHVzaCgpCiAgcmV0dXJuIHAKfQoKZnVuY3Rpb24gZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZShzdG9yYWdlLCBpbmRleCkgewogIGNvbnN0IHJ4ID0gc3RvcmFnZS5yZWFkKCkKICBjb25zdCBub2RlID0gcnguZ2V0VHJlZU5vZGUoaW5kZXgpCiAgcngudHJ5Rmx1c2goKQogIHJldHVybiBub2RlCn0KCmZ1bmN0aW9uIGhhc1RyZWVOb2RlKHN0b3JhZ2UsIGluZGV4KSB7CiAgY29uc3QgcnggPSBzdG9yYWdlLnJlYWQoKQogIGNvbnN0IGhhcyA9IHJ4Lmhhc1RyZWVOb2RlKGluZGV4KQogIHJ4LnRyeUZsdXNoKCkKICByZXR1cm4gaGFzCn0KCmFzeW5jIGZ1bmN0aW9uIHNldHRsZVByb29mKHApIHsKICBjb25zdCByZXN1bHQgPSBbCiAgICBwLm5vZGUgJiYgUHJvbWlzZS5hbGwocC5ub2RlKSwKICAgIHAuc2VlayAmJiBQcm9taXNlLmFsbChwLnNlZWspLAogICAgcC51cGdyYWRlICYmIFByb21pc2UuYWxsKHAudXBncmFkZSksCiAgICBwLmFkZGl0aW9uYWxVcGdyYWRlICYmIFByb21pc2UuYWxsKHAuYWRkaXRpb25hbFVwZ3JhZGUpCiAgXQoKICB0cnkgewogICAgcmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKHJlc3VsdCkKICB9IGNhdGNoIChlcnIpIHsKICAgIGlmIChwLm5vZGUpIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChwLm5vZGUpCiAgICBpZiAocC5zZWVrKSBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQocC5zZWVrKQogICAgaWYgKHAudXBncmFkZSkgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHAudXBncmFkZSkKICAgIGlmIChwLmFkZGl0aW9uYWxVcGdyYWRlKSBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQocC5hZGRpdGlvbmFsVXBncmFkZSkKICAgIHRocm93IGVycgogIH0KfQoKLy8gdHJlZSBjYW4gYmUgZWl0aGVyIHRoZSBtZXJrbGUgdHJlZSBvciBhIG1lcmtsZSB0cmVlIGJhdGNoCmFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlUHJvb2Yoc2Vzc2lvbiwgcngsIGJsb2NrLCBoYXNoLCBzZWVrLCB1cGdyYWRlKSB7CiAgLy8gSW1wb3J0YW50IHRoYXQgdGhpcyBkb2VzIG5vdCB0aHJvdyBpbmJldHdlZW4gbWFraW5nIHRoZSBwcm9taXNlIGFycmF5cwogIC8vIGFuZCBmaW5hbGlzZSBiZWluZyBjYWxsZWQsIG90aGVyd2lzZSB0aGVyZSB3aWxsIGJlIGxpbmdlcmluZyBwcm9taXNlcyBpbiB0aGUgYmFja2dyb3VuZAoKICBpZiAoc2Vzc2lvbi5wcm9sb2d1ZSAmJiB1cGdyYWRlKSB7CiAgICB1cGdyYWRlLnN0YXJ0ID0gdXBncmFkZS5zdGFydCA8IHNlc3Npb24ucHJvbG9ndWUubGVuZ3RoID8gMCA6IHVwZ3JhZGUuc3RhcnQKICAgIHVwZ3JhZGUubGVuZ3RoID0KICAgICAgdXBncmFkZS5zdGFydCA8IHNlc3Npb24ucHJvbG9ndWUubGVuZ3RoID8gc2Vzc2lvbi5wcm9sb2d1ZS5sZW5ndGggOiB1cGdyYWRlLmxlbmd0aAogIH0KCiAgY29uc3QgaGVhZCA9IDIgKiBzZXNzaW9uLmxlbmd0aAogIGNvbnN0IGZyb20gPSB1cGdyYWRlID8gdXBncmFkZS5zdGFydCAqIDIgOiAwCiAgY29uc3QgdG8gPSB1cGdyYWRlID8gZnJvbSArIHVwZ3JhZGUubGVuZ3RoICogMiA6IGhlYWQKICBjb25zdCBub2RlID0gbm9ybWFsaXplSW5kZXhlZChibG9jaywgaGFzaCkKCiAgLy8gY2FuJ3QgZG8gYW55dGhpbmcgYXMgd2UgaGF2ZSBubyBkYXRhLi4uCiAgaWYgKGhlYWQgPT09IDApIHJldHVybiBuZXcgVHJlZVByb29mKHNlc3Npb24sIG51bGwsIG51bGwsIG51bGwsIG51bGwpCgogIGlmIChmcm9tID49IHRvIHx8IHRvID4gaGVhZCkgewogICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0ludmFsaWQgdXBncmFkZScpCiAgfQogIGlmIChzZWVrICYmIHVwZ3JhZGUgJiYgbm9kZSAhPT0gbnVsbCAmJiBub2RlLmluZGV4ID49IGZyb20pIHsKICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdDYW5ub3QgYm90aCBkbyBhIHNlZWsgYW5kIGJsb2NrL2hhc2ggcmVxdWVzdCB3aGVuIHVwZ3JhZGluZycpCiAgfQoKICBsZXQgc3ViVHJlZSA9IGhlYWQKCiAgY29uc3QgcCA9IG5ldyBUcmVlUHJvb2Yoc2Vzc2lvbiwgYmxvY2ssIGhhc2gsIHNlZWssIHVwZ3JhZGUpCgogIGlmIChub2RlICE9PSBudWxsICYmICghdXBncmFkZSB8fCBub2RlLmxhc3RJbmRleCA8IHVwZ3JhZGUuc3RhcnQpKSB7CiAgICBzdWJUcmVlID0gbm9kZXNUb1Jvb3Qobm9kZS5pbmRleCwgbm9kZS5ub2RlcywgdG8pCiAgICBjb25zdCBzZWVrUm9vdCA9IHNlZWsKICAgICAgPyBhd2FpdCBzZWVrVW50cnVzdGVkVHJlZShzZXNzaW9uLCBzdWJUcmVlLCBzZWVrLmJ5dGVzLCBzZWVrLnBhZGRpbmcpCiAgICAgIDogaGVhZAogICAgYmxvY2tBbmRTZWVrUHJvb2Yoc2Vzc2lvbiwgcngsIG5vZGUsIHNlZWssIHNlZWtSb290LCBzdWJUcmVlLCBwLnBlbmRpbmcpCiAgfSBlbHNlIGlmICgobm9kZSB8fCBzZWVrKSAmJiB1cGdyYWRlKSB7CiAgICBzdWJUcmVlID0gc2VlayA/IGF3YWl0IHNlZWtGcm9tSGVhZChzZXNzaW9uLCB0bywgc2Vlay5ieXRlcywgc2Vlay5wYWRkaW5nKSA6IG5vZGUuaW5kZXgKICB9CgogIGlmICh1cGdyYWRlKSB7CiAgICB1cGdyYWRlUHJvb2Yoc2Vzc2lvbiwgcngsIG5vZGUsIHNlZWssIGZyb20sIHRvLCBzdWJUcmVlLCBwLnBlbmRpbmcpCiAgICBpZiAoaGVhZCA+IHRvKSBhZGRpdGlvbmFsVXBncmFkZVByb29mKHNlc3Npb24sIHJ4LCB0bywgaGVhZCwgcC5wZW5kaW5nKQogIH0KCiAgcmV0dXJuIHAKfQoKZnVuY3Rpb24gZ2V0VW5wYWRkZWRTaXplKG5vZGUsIHBhZGRpbmcsIGl0ZSkgewogIHJldHVybiBwYWRkaW5nID09PSAwCiAgICA/IG5vZGUuc2l6ZQogICAgOiBub2RlLnNpemUgLSBwYWRkaW5nICogKGl0ZSA/IGl0ZS5jb3VudExlYXZlcygpIDogZmxhdC5jb3VudExlYXZlcyhub2RlLmluZGV4KSkKfQoKZnVuY3Rpb24gdW5zbGFiTm9kZXMobm9kZXMpIHsKICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIHVuc2xhYk5vZGUobm9kZSkKICByZXR1cm4gbm9kZXMKfQoKZnVuY3Rpb24gdW5zbGFiTm9kZShub2RlKSB7CiAgaWYgKG5vZGUgPT09IG51bGwpIHJldHVybiBub2RlCiAgbm9kZS5oYXNoID0gdW5zbGFiKG5vZGUuaGFzaCkKICByZXR1cm4gbm9kZQp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgeyBERUZBVUxUX05BTUVTUEFDRSB9ID0gcmVxdWlyZSgnLi9jYXBzJykKY29uc3QgeyBJTlZBTElEX09QTE9HX1ZFUlNJT04gfSA9IHJlcXVpcmUoJ2h5cGVyY29yZS1lcnJvcnMnKQpjb25zdCB1bnNsYWIgPSByZXF1aXJlKCd1bnNsYWInKQoKY29uc3QgRU1QVFkgPSBiNGEuYWxsb2MoMCkKCmNvbnN0IE1BTklGRVNUX1BBVENIID0gMGIwMDAwMDAwMQpjb25zdCBNQU5JRkVTVF9QUk9MT0dVRSA9IDBiMDAwMDAwMTAKY29uc3QgTUFOSUZFU1RfTElOS0VEID0gMGIwMDAwMDEwMApjb25zdCBNQU5JRkVTVF9VU0VSX0RBVEEgPSAwYjAwMDAxMDAwCgpjb25zdCBoYXNoZXMgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBzbWFsbCB1aW50CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGlmIChtID09PSAnYmxha2UyYicpIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGhhc2g6ICcgKyBtKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBuID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGlmIChuID09PSAwKSByZXR1cm4gJ2JsYWtlMmInCiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gaGFzaCBpZDogJyArIG4pCiAgfQp9Cgpjb25zdCBzaWduYXR1cmVzID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gc21hbGwgdWludAogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBpZiAobSA9PT0gJ2VkMjU1MTknKSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApCiAgICAgIHJldHVybgogICAgfQoKICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBzaWduYXR1cmU6ICcgKyBtKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBuID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGlmIChuID09PSAwKSByZXR1cm4gJ2VkMjU1MTknCiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gc2lnbmF0dXJlIGlkOiAnICsgbikKICB9Cn0KCmNvbnN0IHNpZ25lciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHNpZ25hdHVyZXMucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ubmFtZXNwYWNlKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHNpZ25hdHVyZXMuZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ubmFtZXNwYWNlKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHNpZ25hdHVyZTogc2lnbmF0dXJlcy5kZWNvZGUoc3RhdGUpLAogICAgICBuYW1lc3BhY2U6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBwdWJsaWNLZXk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBzaWduZXJBcnJheSA9IGMuYXJyYXkoc2lnbmVyKQoKY29uc3QgcHJvbG9ndWUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBwKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBwLmhhc2gpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBwLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgcCkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgcC5oYXNoKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgcC5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGhhc2g6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBtYW5pZmVzdHYwID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgaGFzaGVzLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgc3RhdGUuZW5kKysgLy8gdHlwZQoKICAgIGlmIChtLnByb2xvZ3VlICYmIG0uc2lnbmVycy5sZW5ndGggPT09IDApIHsKICAgICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5wcm9sb2d1ZS5oYXNoKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAobS5xdW9ydW0gPT09IDEgJiYgbS5zaWduZXJzLmxlbmd0aCA9PT0gMSAmJiAhbS5hbGxvd1BhdGNoKSB7CiAgICAgIHNpZ25lci5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmVyc1swXSkKICAgIH0gZWxzZSB7CiAgICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucXVvcnVtKQogICAgICBzaWduZXJBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmVycykKICAgIH0KICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgaGFzaGVzLmVuY29kZShzdGF0ZSwgbS5oYXNoKQoKICAgIGlmIChtLnByb2xvZ3VlICYmIG0uc2lnbmVycy5sZW5ndGggPT09IDApIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkKICAgICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5wcm9sb2d1ZS5oYXNoKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAobS5xdW9ydW0gPT09IDEgJiYgbS5zaWduZXJzLmxlbmd0aCA9PT0gMSAmJiAhbS5hbGxvd1BhdGNoKSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpCiAgICAgIHNpZ25lci5lbmNvZGUoc3RhdGUsIG0uc2lnbmVyc1swXSkKICAgIH0gZWxzZSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDIpCiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uYWxsb3dQYXRjaCA/IDEgOiAwKQogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnF1b3J1bSkKICAgICAgc2lnbmVyQXJyYXkuZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGhhc2ggPSBoYXNoZXMuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgdHlwZSA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgaWYgKHR5cGUgPiAyKSB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gdHlwZTogJyArIHR5cGUpCgogICAgaWYgKHR5cGUgPT09IDApIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uOiAwLAogICAgICAgIGhhc2gsCiAgICAgICAgYWxsb3dQYXRjaDogZmFsc2UsCiAgICAgICAgcXVvcnVtOiAwLAogICAgICAgIHNpZ25lcnM6IFtdLAogICAgICAgIHByb2xvZ3VlOiB7CiAgICAgICAgICBoYXNoOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgICAgIGxlbmd0aDogMAogICAgICAgIH0sCiAgICAgICAgbGlua2VkOiBudWxsLAogICAgICAgIHVzZXJEYXRhOiBudWxsCiAgICAgIH0KICAgIH0KCiAgICBpZiAodHlwZSA9PT0gMSkgewogICAgICByZXR1cm4gewogICAgICAgIHZlcnNpb246IDAsCiAgICAgICAgaGFzaCwKICAgICAgICBhbGxvd1BhdGNoOiBmYWxzZSwKICAgICAgICBxdW9ydW06IDEsCiAgICAgICAgc2lnbmVyczogW3NpZ25lci5kZWNvZGUoc3RhdGUpXSwKICAgICAgICBwcm9sb2d1ZTogbnVsbCwKICAgICAgICBsaW5rZWQ6IG51bGwsCiAgICAgICAgdXNlckRhdGE6IG51bGwKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiAwLAogICAgICBoYXNoLAogICAgICBhbGxvd1BhdGNoOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgcXVvcnVtOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmVyczogc2lnbmVyQXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgcHJvbG9ndWU6IG51bGwsCiAgICAgIGxpbmtlZDogbnVsbCwKICAgICAgdXNlckRhdGE6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IGZpeGVkMzJBcnJheSA9IGMuYXJyYXkoYy5maXhlZDMyKQoKY29uc3QgbWFuaWZlc3QgPSAoZXhwb3J0cy5tYW5pZmVzdCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIHZlcnNpb24KCiAgICBpZiAobS52ZXJzaW9uID09PSAwKSByZXR1cm4gbWFuaWZlc3R2MC5wcmVlbmNvZGUoc3RhdGUsIG0pCgogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGhhc2hlcy5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnF1b3J1bSkKICAgIHNpZ25lckFycmF5LnByZWVuY29kZShzdGF0ZSwgbS5zaWduZXJzKQoKICAgIGlmIChtLnByb2xvZ3VlKSBwcm9sb2d1ZS5wcmVlbmNvZGUoc3RhdGUsIG0ucHJvbG9ndWUpCiAgICBpZiAobS5saW5rZWQpIGZpeGVkMzJBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0ubGlua2VkKQogICAgaWYgKG0udXNlckRhdGEpIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS51c2VyRGF0YSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQoKICAgIGlmIChtLnZlcnNpb24gPT09IDApIHJldHVybiBtYW5pZmVzdHYwLmVuY29kZShzdGF0ZSwgbSkKCiAgICBsZXQgZmxhZ3MgPSAwCiAgICBpZiAobS5hbGxvd1BhdGNoKSBmbGFncyB8PSBNQU5JRkVTVF9QQVRDSAogICAgaWYgKG0ucHJvbG9ndWUpIGZsYWdzIHw9IE1BTklGRVNUX1BST0xPR1VFCiAgICBpZiAobS5saW5rZWQpIGZsYWdzIHw9IE1BTklGRVNUX0xJTktFRAogICAgaWYgKG0udXNlckRhdGEpIGZsYWdzIHw9IE1BTklGRVNUX1VTRVJfREFUQQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgaGFzaGVzLmVuY29kZShzdGF0ZSwgbS5oYXNoKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucXVvcnVtKQogICAgc2lnbmVyQXJyYXkuZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCgogICAgaWYgKG0ucHJvbG9ndWUpIHByb2xvZ3VlLmVuY29kZShzdGF0ZSwgbS5wcm9sb2d1ZSkKICAgIGlmIChtLmxpbmtlZCkgZml4ZWQzMkFycmF5LmVuY29kZShzdGF0ZSwgbS5saW5rZWQpCiAgICBpZiAobS51c2VyRGF0YSkgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnVzZXJEYXRhKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAodmVyc2lvbiA9PT0gMCkgcmV0dXJuIG1hbmlmZXN0djAuZGVjb2RlKHN0YXRlKQogICAgaWYgKHZlcnNpb24gPiAyKSB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gdmVyc2lvbjogJyArIHZlcnNpb24pCgogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgaGFzaCA9IGhhc2hlcy5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBxdW9ydW0gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3Qgc2lnbmVycyA9IHNpZ25lckFycmF5LmRlY29kZShzdGF0ZSkKCiAgICBjb25zdCBoYXNQYXRjaCA9IChmbGFncyAmIE1BTklGRVNUX1BBVENIKSAhPT0gMAogICAgY29uc3QgaGFzUHJvbG9ndWUgPSAoZmxhZ3MgJiBNQU5JRkVTVF9QUk9MT0dVRSkgIT09IDAKICAgIGNvbnN0IGhhc0xpbmtlZCA9IChmbGFncyAmIE1BTklGRVNUX0xJTktFRCkgIT09IDAKICAgIGNvbnN0IGhhc1VzZXJEYXRhID0gKGZsYWdzICYgTUFOSUZFU1RfVVNFUl9EQVRBKSAhPT0gMAoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb24sCiAgICAgIGhhc2gsCiAgICAgIGFsbG93UGF0Y2g6IGhhc1BhdGNoLAogICAgICBxdW9ydW0sCiAgICAgIHNpZ25lcnMsCiAgICAgIHByb2xvZ3VlOiBoYXNQcm9sb2d1ZSA/IHByb2xvZ3VlLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBsaW5rZWQ6IGhhc0xpbmtlZCA/IGZpeGVkMzJBcnJheS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdXNlckRhdGE6IGhhc1VzZXJEYXRhID8gYy5idWZmZXIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0pCgpjb25zdCBub2RlID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5pbmRleCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4uc2l6ZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG4uaGFzaCkKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5pbmRleCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uc2l6ZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG4uaGFzaCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaXplOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgaGFzaDogYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IG5vZGVBcnJheSA9IGMuYXJyYXkobm9kZSkKCmNvbnN0IHdpcmUgPSAoZXhwb3J0cy53aXJlID0ge30pCgp3aXJlLmhhbmRzaGFrZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIDEpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmNhcGFiaWxpdHkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc2Vla3MgPyAxIDogMCkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0uY2FwYWJpbGl0eSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgc2Vla3M6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBjYXBhYmlsaXR5OiB1bnNsYWIoYy5maXhlZDMyLmRlY29kZShzdGF0ZSkpCiAgICB9CiAgfQp9Cgpjb25zdCByZXF1ZXN0QmxvY2sgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGluZGV4OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbm9kZXM6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZXF1ZXN0U2VlayA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHMpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHMuYnl0ZXMpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBzLnBhZGRpbmcpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHMpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHMuYnl0ZXMpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBzLnBhZGRpbmcpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGJ5dGVzOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgcGFkZGluZzogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlcXVlc3RVcGdyYWRlID0gewogIHByZWVuY29kZShzdGF0ZSwgdSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1LnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5yZXF1ZXN0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uaWQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmZvcmspCgogICAgaWYgKG0uYmxvY2spIHJlcXVlc3RCbG9jay5wcmVlbmNvZGUoc3RhdGUsIG0uYmxvY2spCiAgICBpZiAobS5oYXNoKSByZXF1ZXN0QmxvY2sucHJlZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBpZiAobS5zZWVrKSByZXF1ZXN0U2Vlay5wcmVlbmNvZGUoc3RhdGUsIG0uc2VlaykKICAgIGlmIChtLnVwZ3JhZGUpIHJlcXVlc3RVcGdyYWRlLnByZWVuY29kZShzdGF0ZSwgbS51cGdyYWRlKQogICAgaWYgKG0ucHJpb3JpdHkpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucHJpb3JpdHkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0KICAgICAgKG0uYmxvY2sgPyAxIDogMCkgfAogICAgICAobS5oYXNoID8gMiA6IDApIHwKICAgICAgKG0uc2VlayA/IDQgOiAwKSB8CiAgICAgIChtLnVwZ3JhZGUgPyA4IDogMCkgfAogICAgICAobS5tYW5pZmVzdCA/IDE2IDogMCkgfAogICAgICAobS5wcmlvcml0eSA/IDMyIDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uaWQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmZvcmspCgogICAgaWYgKG0uYmxvY2spIHJlcXVlc3RCbG9jay5lbmNvZGUoc3RhdGUsIG0uYmxvY2spCiAgICBpZiAobS5oYXNoKSByZXF1ZXN0QmxvY2suZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBpZiAobS5zZWVrKSByZXF1ZXN0U2Vlay5lbmNvZGUoc3RhdGUsIG0uc2VlaykKICAgIGlmIChtLnVwZ3JhZGUpIHJlcXVlc3RVcGdyYWRlLmVuY29kZShzdGF0ZSwgbS51cGdyYWRlKQogICAgaWYgKG0ucHJpb3JpdHkpIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucHJpb3JpdHkpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBpZDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGZvcms6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBibG9jazogZmxhZ3MgJiAxID8gcmVxdWVzdEJsb2NrLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBoYXNoOiBmbGFncyAmIDIgPyByZXF1ZXN0QmxvY2suZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHNlZWs6IGZsYWdzICYgNCA/IHJlcXVlc3RTZWVrLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB1cGdyYWRlOiBmbGFncyAmIDggPyByZXF1ZXN0VXBncmFkZS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgbWFuaWZlc3Q6IChmbGFncyAmIDE2KSAhPT0gMCwKICAgICAgcHJpb3JpdHk6IGZsYWdzICYgMzIgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCndpcmUuY2FuY2VsID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZXF1ZXN0KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgfSwKICBkZWNvZGUoc3RhdGUsIG0pIHsKICAgIHJldHVybiB7CiAgICAgIHJlcXVlc3Q6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBkYXRhVXBncmFkZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHUpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUuc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICAgIG5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIHUubm9kZXMpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCB1LmFkZGl0aW9uYWxOb2RlcykKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdS5zaWduYXR1cmUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHUpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUuc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIHUubm9kZXMpCiAgICBub2RlQXJyYXkuZW5jb2RlKHN0YXRlLCB1LmFkZGl0aW9uYWxOb2RlcykKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgdS5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbm9kZXM6IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICBhZGRpdGlvbmFsTm9kZXM6IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGRhdGFTZWVrID0gewogIHByZWVuY29kZShzdGF0ZSwgcykgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgcy5ieXRlcykKICAgIG5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIHMubm9kZXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHMpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHMuYnl0ZXMpCiAgICBub2RlQXJyYXkuZW5jb2RlKHN0YXRlLCBzLm5vZGVzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBieXRlczogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgZGF0YUJsb2NrID0gewogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgYi52YWx1ZSkKICAgIG5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIGIudmFsdWUpCiAgICBub2RlQXJyYXkuZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpbmRleDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHZhbHVlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpIHx8IEVNUFRZLAogICAgICBub2Rlczogbm9kZUFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGRhdGFIYXNoID0gewogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIG5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBub2RlQXJyYXkuZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpbmRleDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5kYXRhID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZm9yaykKCiAgICBpZiAobS5ibG9jaykgZGF0YUJsb2NrLnByZWVuY29kZShzdGF0ZSwgbS5ibG9jaykKICAgIGlmIChtLmhhc2gpIGRhdGFIYXNoLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgaWYgKG0uc2VlaykgZGF0YVNlZWsucHJlZW5jb2RlKHN0YXRlLCBtLnNlZWspCiAgICBpZiAobS51cGdyYWRlKSBkYXRhVXBncmFkZS5wcmVlbmNvZGUoc3RhdGUsIG0udXBncmFkZSkKICAgIGlmIChtLm1hbmlmZXN0KSBtYW5pZmVzdC5wcmVlbmNvZGUoc3RhdGUsIG0ubWFuaWZlc3QpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0KICAgICAgKG0uYmxvY2sgPyAxIDogMCkgfAogICAgICAobS5oYXNoID8gMiA6IDApIHwKICAgICAgKG0uc2VlayA/IDQgOiAwKSB8CiAgICAgIChtLnVwZ3JhZGUgPyA4IDogMCkgfAogICAgICAobS5tYW5pZmVzdCA/IDE2IDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZm9yaykKCiAgICBpZiAobS5ibG9jaykgZGF0YUJsb2NrLmVuY29kZShzdGF0ZSwgbS5ibG9jaykKICAgIGlmIChtLmhhc2gpIGRhdGFIYXNoLmVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgaWYgKG0uc2VlaykgZGF0YVNlZWsuZW5jb2RlKHN0YXRlLCBtLnNlZWspCiAgICBpZiAobS51cGdyYWRlKSBkYXRhVXBncmFkZS5lbmNvZGUoc3RhdGUsIG0udXBncmFkZSkKICAgIGlmIChtLm1hbmlmZXN0KSBtYW5pZmVzdC5lbmNvZGUoc3RhdGUsIG0ubWFuaWZlc3QpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICByZXF1ZXN0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgZm9yazogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGJsb2NrOiBmbGFncyAmIDEgPyBkYXRhQmxvY2suZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGhhc2g6IGZsYWdzICYgMiA/IGRhdGFIYXNoLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBzZWVrOiBmbGFncyAmIDQgPyBkYXRhU2Vlay5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdXBncmFkZTogZmxhZ3MgJiA4ID8gZGF0YVVwZ3JhZGUuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIG1hbmlmZXN0OiBmbGFncyAmIDE2ID8gbWFuaWZlc3QuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCndpcmUubm9EYXRhID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZXF1ZXN0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZWFzb24gPyAxIDogMCkKICAgIGlmIChtLnJlYXNvbikgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZWFzb24pCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVhc29uID8gMSA6IDApCiAgICBpZiAobS5yZWFzb24pIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVhc29uKQogIH0sCiAgZGVjb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCByZXF1ZXN0ID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGZsYWdzID0gc3RhdGUuc3RhcnQgPCBzdGF0ZS5lbmQgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIHJldHVybiB7CiAgICAgIHJlcXVlc3QsCiAgICAgIHJlYXNvbjogZmxhZ3MgJiAxID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCiAgICB9CiAgfQp9Cgp3aXJlLndhbnQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLnVud2FudCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlLCBtKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUucmFuZ2UgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGlmIChtLmxlbmd0aCAhPT0gMSkgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIChtLmRyb3AgPyAxIDogMCkgfCAobS5sZW5ndGggPT09IDEgPyAyIDogMCkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgaWYgKG0ubGVuZ3RoICE9PSAxKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGRyb3A6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogKGZsYWdzICYgMikgIT09IDAgPyAxIDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUuYml0ZmllbGQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50MzJhcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0uYml0ZmllbGQpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQzMmFycmF5LmVuY29kZShzdGF0ZSwgbS5iaXRmaWVsZCkKICB9LAogIGRlY29kZShzdGF0ZSwgbSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBiaXRmaWVsZDogYy51aW50MzJhcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLnN5bmMgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5mb3JrKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnJlbW90ZUxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZSgKICAgICAgc3RhdGUsCiAgICAgIChtLmNhblVwZ3JhZGUgPyAxIDogMCkgfAogICAgICAgIChtLnVwbG9hZGluZyA/IDIgOiAwKSB8CiAgICAgICAgKG0uZG93bmxvYWRpbmcgPyA0IDogMCkgfAogICAgICAgIChtLmhhc01hbmlmZXN0ID8gOCA6IDApIHwKICAgICAgICAobS5hbGxvd1B1c2ggPyAxNiA6IDApCiAgICApCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmZvcmspCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVtb3RlTGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgZm9yazogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHJlbW90ZUxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGNhblVwZ3JhZGU6IChmbGFncyAmIDEpICE9PSAwLAogICAgICB1cGxvYWRpbmc6IChmbGFncyAmIDIpICE9PSAwLAogICAgICBkb3dubG9hZGluZzogKGZsYWdzICYgNCkgIT09IDAsCiAgICAgIGhhc01hbmlmZXN0OiAoZmxhZ3MgJiA4KSAhPT0gMCwKICAgICAgYWxsb3dQdXNoOiAoZmxhZ3MgJiAxNikgIT09IDAKICAgIH0KICB9Cn0KCndpcmUucmVvcmdIaW50ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5mcm9tKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS50bykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uYW5jZXN0b3JzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmZyb20pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnRvKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5hbmNlc3RvcnMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGZyb206IGMudWludC5lbmNvZGUoc3RhdGUpLAogICAgICB0bzogYy51aW50LmVuY29kZShzdGF0ZSksCiAgICAgIGFuY2VzdG9yczogYy51aW50LmVuY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUuZXh0ZW5zaW9uID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWUpCiAgICBjLnJhdy5wcmVlbmNvZGUoc3RhdGUsIG0ubWVzc2FnZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCBtLm5hbWUpCiAgICBjLnJhdy5lbmNvZGUoc3RhdGUsIG0ubWVzc2FnZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgbmFtZTogYy5zdHJpbmcuZGVjb2RlKHN0YXRlKSwKICAgICAgbWVzc2FnZTogYy5yYXcuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qga2V5VmFsdWUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBwKSB7CiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIHAua2V5KQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBwLnZhbHVlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBwKSB7CiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIHAua2V5KQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBwLnZhbHVlKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBrZXk6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSksCiAgICAgIHZhbHVlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCB0cmVlVXBncmFkZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHUpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUuZm9yaykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUuYW5jZXN0b3JzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHUuc2lnbmF0dXJlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1LmZvcmspCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1LmFuY2VzdG9ycykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB1LnNpZ25hdHVyZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgZm9yazogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGFuY2VzdG9yczogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25hdHVyZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgYml0ZmllbGRVcGRhdGUgPSB7CiAgLy8gVE9ETzogY2FuIG1heWJlIGJlIGZvbGRlZCBpbnRvIGEgSEFWRSBsYXRlciBvbiB3aXRoIHRoZSBtb3N0IHJlY2VudCBzcGVjCiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgYi5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBiLmRyb3AgPyAxIDogMAogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGIubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBkcm9wOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBvcGxvZyA9IChleHBvcnRzLm9wbG9nID0ge30pCgpvcGxvZy5lbnRyeSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBpZiAobS51c2VyRGF0YSkga2V5VmFsdWUucHJlZW5jb2RlKHN0YXRlLCBtLnVzZXJEYXRhKQogICAgaWYgKG0udHJlZU5vZGVzKSBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLnRyZWVOb2RlcykKICAgIGlmIChtLnRyZWVVcGdyYWRlKSB0cmVlVXBncmFkZS5wcmVlbmNvZGUoc3RhdGUsIG0udHJlZVVwZ3JhZGUpCiAgICBpZiAobS5iaXRmaWVsZCkgYml0ZmllbGRVcGRhdGUucHJlZW5jb2RlKHN0YXRlLCBtLmJpdGZpZWxkKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBzID0gc3RhdGUuc3RhcnQrKwogICAgbGV0IGZsYWdzID0gMAoKICAgIGlmIChtLnVzZXJEYXRhKSB7CiAgICAgIGZsYWdzIHw9IDEKICAgICAga2V5VmFsdWUuZW5jb2RlKHN0YXRlLCBtLnVzZXJEYXRhKQogICAgfQogICAgaWYgKG0udHJlZU5vZGVzKSB7CiAgICAgIGZsYWdzIHw9IDIKICAgICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgbS50cmVlTm9kZXMpCiAgICB9CiAgICBpZiAobS50cmVlVXBncmFkZSkgewogICAgICBmbGFncyB8PSA0CiAgICAgIHRyZWVVcGdyYWRlLmVuY29kZShzdGF0ZSwgbS50cmVlVXBncmFkZSkKICAgIH0KICAgIGlmIChtLmJpdGZpZWxkKSB7CiAgICAgIGZsYWdzIHw9IDgKICAgICAgYml0ZmllbGRVcGRhdGUuZW5jb2RlKHN0YXRlLCBtLmJpdGZpZWxkKQogICAgfQoKICAgIHN0YXRlLmJ1ZmZlcltzXSA9IGZsYWdzCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIHVzZXJEYXRhOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGtleVZhbHVlLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB0cmVlTm9kZXM6IChmbGFncyAmIDIpICE9PSAwID8gbm9kZUFycmF5LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB0cmVlVXBncmFkZTogKGZsYWdzICYgNCkgIT09IDAgPyB0cmVlVXBncmFkZS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgYml0ZmllbGQ6IChmbGFncyAmIDgpICE9PSAwID8gYml0ZmllbGRVcGRhdGUuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IGtleVBhaXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBrcCkgewogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBrcC5wdWJsaWNLZXkpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIGtwLnNlY3JldEtleSkKICB9LAogIGVuY29kZShzdGF0ZSwga3ApIHsKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwga3AucHVibGljS2V5KQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBrcC5zZWNyZXRLZXkpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHB1YmxpY0tleTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgc2VjcmV0S2V5OiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZW9yZ0hpbnQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCByKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCByLmZyb20pCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCByLnRvKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgci5hbmNlc3RvcnMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHIpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHIuZnJvbSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHIudG8pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCByLmFuY2VzdG9ycykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgZnJvbTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHRvOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYW5jZXN0b3JzOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVvcmdIaW50QXJyYXkgPSBjLmFycmF5KHJlb3JnSGludCkKCmNvbnN0IGhpbnRzID0gewogIHByZWVuY29kZShzdGF0ZSwgaCkgewogICAgcmVvcmdIaW50QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBoLnJlb3JncykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGguY29udGlndW91c0xlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgaCkgewogICAgcmVvcmdIaW50QXJyYXkuZW5jb2RlKHN0YXRlLCBoLnJlb3JncykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGguY29udGlndW91c0xlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcmVvcmdzOiByZW9yZ0hpbnRBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICBjb250aWd1b3VzTGVuZ3RoOiBzdGF0ZS5zdGFydCA8IHN0YXRlLmVuZCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgfQogIH0KfQoKY29uc3QgdHJlZUhlYWRlciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHQpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHQuZm9yaykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHQubGVuZ3RoKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCB0LnJvb3RIYXNoKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCB0LnNpZ25hdHVyZSkKICB9LAogIGVuY29kZShzdGF0ZSwgdCkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdC5mb3JrKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdC5sZW5ndGgpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHQucm9vdEhhc2gpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHQuc2lnbmF0dXJlKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBmb3JrOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgcm9vdEhhc2g6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25hdHVyZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgdHlwZXMgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCB0KSB7CiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIHQudHJlZSkKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgdC5iaXRmaWVsZCkKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgdC5zaWduZXIpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHQpIHsKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgdC50cmVlKQogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCB0LmJpdGZpZWxkKQogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCB0LnNpZ25lcikKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgdHJlZTogYy5zdHJpbmcuZGVjb2RlKHN0YXRlKSwKICAgICAgYml0ZmllbGQ6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25lcjogYy5zdHJpbmcuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgZXh0ZXJuYWxIZWFkZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBrZXlWYWx1ZUFycmF5ID0gYy5hcnJheShrZXlWYWx1ZSkKCm9wbG9nLmhlYWRlciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGgpIHsKICAgIHN0YXRlLmVuZCArPSAyIC8vIHZlcnNpb24gKyBmbGFncwogICAgaWYgKGguZXh0ZXJuYWwpIHsKICAgICAgZXh0ZXJuYWxIZWFkZXIucHJlZW5jb2RlKHN0YXRlLCBoLmV4dGVybmFsKQogICAgICByZXR1cm4KICAgIH0KICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIGgua2V5KQogICAgaWYgKGgubWFuaWZlc3QpIG1hbmlmZXN0LnByZWVuY29kZShzdGF0ZSwgaC5tYW5pZmVzdCkKICAgIGlmIChoLmtleVBhaXIpIGtleVBhaXIucHJlZW5jb2RlKHN0YXRlLCBoLmtleVBhaXIpCiAgICBrZXlWYWx1ZUFycmF5LnByZWVuY29kZShzdGF0ZSwgaC51c2VyRGF0YSkKICAgIHRyZWVIZWFkZXIucHJlZW5jb2RlKHN0YXRlLCBoLnRyZWUpCiAgICBoaW50cy5wcmVlbmNvZGUoc3RhdGUsIGguaGludHMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGgpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpCiAgICBpZiAoaC5leHRlcm5hbCkgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKSAvLyBPTkxZIHNldCB0aGUgZmlyc3QgYmlnIGZvciBjbGFyaXR5CiAgICAgIGV4dGVybmFsSGVhZGVyLmVuY29kZShzdGF0ZSwgaC5leHRlcm5hbCkKICAgICAgcmV0dXJuCiAgICB9CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAoaC5tYW5pZmVzdCA/IDIgOiAwKSB8IChoLmtleVBhaXIgPyA0IDogMCkpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBoLmtleSkKICAgIGlmIChoLm1hbmlmZXN0KSBtYW5pZmVzdC5lbmNvZGUoc3RhdGUsIGgubWFuaWZlc3QpCiAgICBpZiAoaC5rZXlQYWlyKSBrZXlQYWlyLmVuY29kZShzdGF0ZSwgaC5rZXlQYWlyKQogICAga2V5VmFsdWVBcnJheS5lbmNvZGUoc3RhdGUsIGgudXNlckRhdGEpCiAgICB0cmVlSGVhZGVyLmVuY29kZShzdGF0ZSwgaC50cmVlKQogICAgaGludHMuZW5jb2RlKHN0YXRlLCBoLmhpbnRzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAodmVyc2lvbiA+IDEpIHsKICAgICAgdGhyb3cgSU5WQUxJRF9PUExPR19WRVJTSU9OKCdJbnZhbGlkIGhlYWRlciB2ZXJzaW9uLiBFeHBlY3RlZCA8PSAxLCBnb3QgJyArIHZlcnNpb24pCiAgICB9CgogICAgaWYgKHZlcnNpb24gPT09IDApIHsKICAgICAgY29uc3Qgb2xkID0gewogICAgICAgIHR5cGVzOiB0eXBlcy5kZWNvZGUoc3RhdGUpLAogICAgICAgIHVzZXJEYXRhOiBrZXlWYWx1ZUFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgICAgdHJlZTogdHJlZUhlYWRlci5kZWNvZGUoc3RhdGUpLAogICAgICAgIHNpZ25lcjoga2V5UGFpci5kZWNvZGUoc3RhdGUpLAogICAgICAgIGhpbnRzOiBoaW50cy5kZWNvZGUoc3RhdGUpCiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgZXh0ZXJuYWw6IG51bGwsCiAgICAgICAga2V5OiBvbGQuc2lnbmVyLnB1YmxpY0tleSwKICAgICAgICBtYW5pZmVzdDogewogICAgICAgICAgdmVyc2lvbjogMCwKICAgICAgICAgIGhhc2g6IG9sZC50eXBlcy50cmVlLAogICAgICAgICAgYWxsb3dQYXRjaDogZmFsc2UsCiAgICAgICAgICBxdW9ydW06IDEsCiAgICAgICAgICBzaWduZXJzOiBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzaWduYXR1cmU6IG9sZC50eXBlcy5zaWduZXIsCiAgICAgICAgICAgICAgbmFtZXNwYWNlOiBERUZBVUxUX05BTUVTUEFDRSwKICAgICAgICAgICAgICBwdWJsaWNLZXk6IG9sZC5zaWduZXIucHVibGljS2V5CiAgICAgICAgICAgIH0KICAgICAgICAgIF0sCiAgICAgICAgICBwcm9sb2d1ZTogbnVsbCwKICAgICAgICAgIGxpbmtlZDogbnVsbCwKICAgICAgICAgIHVzZXJEYXRhOiBudWxsCiAgICAgICAgfSwKICAgICAgICBrZXlQYWlyOiBvbGQuc2lnbmVyLnNlY3JldEtleSA/IG9sZC5zaWduZXIgOiBudWxsLAogICAgICAgIHVzZXJEYXRhOiBvbGQudXNlckRhdGEsCiAgICAgICAgdHJlZTogb2xkLnRyZWUsCiAgICAgICAgaGludHM6IG9sZC5oaW50cwogICAgICB9CiAgICB9CgogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmIChmbGFncyAmIDEpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBleHRlcm5hbDogZXh0ZXJuYWxIZWFkZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgICBrZXk6IG51bGwsCiAgICAgICAgbWFuaWZlc3Q6IG51bGwsCiAgICAgICAga2V5UGFpcjogbnVsbCwKICAgICAgICB1c2VyRGF0YTogbnVsbCwKICAgICAgICB0cmVlOiBudWxsLAogICAgICAgIGhpbnRzOiBudWxsCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gewogICAgICBleHRlcm5hbDogbnVsbCwKICAgICAga2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgbWFuaWZlc3Q6IChmbGFncyAmIDIpICE9PSAwID8gbWFuaWZlc3QuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGtleVBhaXI6IChmbGFncyAmIDQpICE9PSAwID8ga2V5UGFpci5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdXNlckRhdGE6IGtleVZhbHVlQXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgdHJlZTogdHJlZUhlYWRlci5kZWNvZGUoc3RhdGUpLAogICAgICBoaW50czogaGludHMuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgdWludEFycmF5ID0gYy5hcnJheShjLnVpbnQpCgpjb25zdCBtdWx0aXNpZ0lucHV0ID0gewogIHByZWVuY29kZShzdGF0ZSwgaW5wKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBpbnAuc2lnbmVyKQogICAgYy5maXhlZDY0LnByZWVuY29kZShzdGF0ZSwgaW5wLnNpZ25hdHVyZSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGlucC5wYXRjaCkKICB9LAogIGVuY29kZShzdGF0ZSwgaW5wKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBpbnAuc2lnbmVyKQogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgaW5wLnNpZ25hdHVyZSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGlucC5wYXRjaCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc2lnbmVyOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmZpeGVkNjQuZGVjb2RlKHN0YXRlKSwKICAgICAgcGF0Y2g6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBwYXRjaEVuY29kaW5ndjAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5sZW5ndGgpCiAgICB1aW50QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBuLm5vZGVzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5sZW5ndGgpCiAgICB1aW50QXJyYXkuZW5jb2RlKHN0YXRlLCBuLm5vZGVzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiB1aW50QXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgbXVsdGlzaWdJbnB1dHYwID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kKysKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4uc2lnbmVyKQogICAgYy5maXhlZDY0LnByZWVuY29kZShzdGF0ZSwgbi5zaWduYXR1cmUpCiAgICBpZiAobi5wYXRjaCkgcGF0Y2hFbmNvZGluZ3YwLnByZWVuY29kZShzdGF0ZSwgbi5wYXRjaCkKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5wYXRjaCA/IDEgOiAwKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5zaWduZXIpCiAgICBjLmZpeGVkNjQuZW5jb2RlKHN0YXRlLCBuLnNpZ25hdHVyZSkKICAgIGlmIChuLnBhdGNoKSBwYXRjaEVuY29kaW5ndjAuZW5jb2RlKHN0YXRlLCBuLnBhdGNoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBzaWduZXI6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuZml4ZWQ2NC5kZWNvZGUoc3RhdGUpLAogICAgICBwYXRjaDogZmxhZ3MgJiAxID8gcGF0Y2hFbmNvZGluZ3YwLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBtdWx0aXNpZ0lucHV0QXJyYXl2MCA9IGMuYXJyYXkobXVsdGlzaWdJbnB1dHYwKQpjb25zdCBtdWx0aXNpZ0lucHV0QXJyYXkgPSBjLmFycmF5KG11bHRpc2lnSW5wdXQpCgpjb25zdCBjb21wYWN0Tm9kZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4uaW5kZXgpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLnNpemUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBuLmhhc2gpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uaW5kZXgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLnNpemUpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBuLmhhc2gpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGluZGV4OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2l6ZTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGhhc2g6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBjb21wYWN0Tm9kZUFycmF5ID0gYy5hcnJheShjb21wYWN0Tm9kZSkKCmV4cG9ydHMubXVsdGlTaWduYXR1cmV2MCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHMpIHsKICAgIG11bHRpc2lnSW5wdXRBcnJheXYwLnByZWVuY29kZShzdGF0ZSwgcy5wcm9vZnMpCiAgICBjb21wYWN0Tm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgcy5wYXRjaCkKICB9LAogIGVuY29kZShzdGF0ZSwgcykgewogICAgbXVsdGlzaWdJbnB1dEFycmF5djAuZW5jb2RlKHN0YXRlLCBzLnByb29mcykKICAgIGNvbXBhY3ROb2RlQXJyYXkuZW5jb2RlKHN0YXRlLCBzLnBhdGNoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBwcm9vZnM6IG11bHRpc2lnSW5wdXRBcnJheXYwLmRlY29kZShzdGF0ZSksCiAgICAgIHBhdGNoOiBjb21wYWN0Tm9kZUFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmV4cG9ydHMubXVsdGlTaWduYXR1cmUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBzKSB7CiAgICBtdWx0aXNpZ0lucHV0QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBzLnByb29mcykKICAgIGNvbXBhY3ROb2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBzLnBhdGNoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBzKSB7CiAgICBtdWx0aXNpZ0lucHV0QXJyYXkuZW5jb2RlKHN0YXRlLCBzLnByb29mcykKICAgIGNvbXBhY3ROb2RlQXJyYXkuZW5jb2RlKHN0YXRlLCBzLnBhdGNoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBwcm9vZnM6IG11bHRpc2lnSW5wdXRBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICBwYXRjaDogY29tcGFjdE5vZGVBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgZmxhdCA9IHJlcXVpcmUoJ2ZsYXQtdHJlZScpCmNvbnN0IHsgTWVya2xlVHJlZSB9ID0gcmVxdWlyZSgnLi9tZXJrbGUtdHJlZScpCmNvbnN0IHsgbXVsdGlTaWduYXR1cmUsIG11bHRpU2lnbmF0dXJldjAgfSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMnKQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgYXNzZW1ibGV2MCwKICBhc3NlbWJsZSwKICBpbmZsYXRldjAsCiAgaW5mbGF0ZSwKICBwYXJ0aWFsU2lnbmF0dXJlLAogIHNpZ25hYmxlTGVuZ3RoCn0KCmZ1bmN0aW9uIGluZmxhdGV2MChkYXRhKSB7CiAgcmV0dXJuIGMuZGVjb2RlKG11bHRpU2lnbmF0dXJldjAsIGRhdGEpCn0KCmZ1bmN0aW9uIGluZmxhdGUoZGF0YSkgewogIHJldHVybiBjLmRlY29kZShtdWx0aVNpZ25hdHVyZSwgZGF0YSkKfQoKYXN5bmMgZnVuY3Rpb24gcGFydGlhbFNpZ25hdHVyZSgKICBjb3JlLAogIHNpZ25lciwKICBmcm9tLAogIHRvID0gY29yZS5zdGF0ZS5sZW5ndGgsCiAgc2lnbmF0dXJlID0gY29yZS5zdGF0ZS5zaWduYXR1cmUKKSB7CiAgaWYgKGZyb20gPiBjb3JlLnN0YXRlLmxlbmd0aCkgcmV0dXJuIG51bGwKICBjb25zdCBub2RlcyA9IHRvIDw9IGZyb20gPyBudWxsIDogYXdhaXQgdXBncmFkZU5vZGVzKGNvcmUsIGZyb20sIHRvKQoKICBpZiAoc2lnbmF0dXJlLmJ5dGVMZW5ndGggIT09IDY0KSB7CiAgICBzaWduYXR1cmUgPSBjLmRlY29kZShtdWx0aVNpZ25hdHVyZSwgc2lnbmF0dXJlKS5wcm9vZnNbMF0uc2lnbmF0dXJlCiAgfQoKICByZXR1cm4gewogICAgc2lnbmVyLAogICAgc2lnbmF0dXJlLAogICAgcGF0Y2g6IG5vZGVzID8gdG8gLSBmcm9tIDogMCwKICAgIG5vZGVzCiAgfQp9Cgphc3luYyBmdW5jdGlvbiB1cGdyYWRlTm9kZXMoY29yZSwgZnJvbSwgdG8pIHsKICBjb25zdCByeCA9IGNvcmUuc3RhdGUuc3RvcmFnZS5yZWFkKCkKICBsZXQgcCA9IG51bGwKICB0cnkgewogICAgcCA9IGF3YWl0IE1lcmtsZVRyZWUucHJvb2YoY29yZS5zdGF0ZSwgcngsIHsgdXBncmFkZTogeyBzdGFydDogZnJvbSwgbGVuZ3RoOiB0byAtIGZyb20gfSB9KQogIH0gY2F0Y2ggKGVycikgewogICAgcnguZGVzdHJveSgpCiAgICB0aHJvdyBlcnIKICB9CiAgcngudHJ5Rmx1c2goKQogIHJldHVybiAoYXdhaXQgcC5zZXR0bGUoKSkudXBncmFkZS5ub2Rlcwp9CgpmdW5jdGlvbiBzaWduYWJsZUxlbmd0aChsZW5ndGhzLCBxdW9ydW0pIHsKICBpZiAocXVvcnVtIDw9IDApIHF1b3J1bSA9IDEKICBpZiAocXVvcnVtID4gbGVuZ3Rocy5sZW5ndGgpIHJldHVybiAwCgogIHJldHVybiBsZW5ndGhzLnNvcnQoY21wKVtxdW9ydW0gLSAxXQp9CgpmdW5jdGlvbiBjbXAoYSwgYikgewogIHJldHVybiBiIC0gYQp9CgpmdW5jdGlvbiBhc3NlbWJsZXYwKGlucHV0cykgewogIGNvbnN0IHByb29mcyA9IFtdCiAgY29uc3QgcGF0Y2ggPSBbXQoKICBmb3IgKGNvbnN0IHUgb2YgaW5wdXRzKSB7CiAgICBwcm9vZnMucHVzaChjb21wcmVzc1Byb29mKHUsIHBhdGNoKSkKICB9CgogIHJldHVybiBjLmVuY29kZShtdWx0aVNpZ25hdHVyZXYwLCB7IHByb29mcywgcGF0Y2ggfSkKfQoKZnVuY3Rpb24gYXNzZW1ibGUoaW5wdXRzKSB7CiAgY29uc3QgcHJvb2ZzID0gW10KICBjb25zdCBwYXRjaCA9IFtdCiAgY29uc3Qgc2VlbiA9IG5ldyBTZXQoKQoKICBmb3IgKGNvbnN0IHUgb2YgaW5wdXRzKSB7CiAgICBpZiAodS5ub2RlcykgewogICAgICBmb3IgKGNvbnN0IG5vZGUgb2YgdS5ub2RlcykgewogICAgICAgIGlmIChzZWVuLmhhcyhub2RlLmluZGV4KSkgY29udGludWUKICAgICAgICBzZWVuLmFkZChub2RlLmluZGV4KQogICAgICAgIHBhdGNoLnB1c2gobm9kZSkKICAgICAgfQogICAgfQoKICAgIHByb29mcy5wdXNoKHsKICAgICAgc2lnbmVyOiB1LnNpZ25lciwKICAgICAgc2lnbmF0dXJlOiB1LnNpZ25hdHVyZSwKICAgICAgcGF0Y2g6IHUucGF0Y2gKICAgIH0pCiAgfQoKICByZXR1cm4gYy5lbmNvZGUobXVsdGlTaWduYXR1cmUsIHsgcHJvb2ZzLCBwYXRjaCB9KQp9CgpmdW5jdGlvbiBjb21wYXJlTm9kZShhLCBiKSB7CiAgaWYgKGEuaW5kZXggIT09IGIuaW5kZXgpIHJldHVybiBmYWxzZQogIGlmIChhLnNpemUgIT09IGIuc2l6ZSkgcmV0dXJuIGZhbHNlCiAgcmV0dXJuIGI0YS5lcXVhbHMoYS5oYXNoLCBiLmhhc2gpCn0KCmZ1bmN0aW9uIGNvbXByZXNzUHJvb2YocHJvb2YsIG5vZGVzKSB7CiAgcmV0dXJuIHsKICAgIHNpZ25lcjogcHJvb2Yuc2lnbmVyLAogICAgc2lnbmF0dXJlOiBwcm9vZi5zaWduYXR1cmUsCiAgICBwYXRjaDogcHJvb2YucGF0Y2ggPyBjb21wcmVzc1VwZ3JhZGUocHJvb2YsIG5vZGVzKSA6IG51bGwKICB9Cn0KCmZ1bmN0aW9uIGNvbXByZXNzVXBncmFkZShwLCBub2RlcykgewogIGNvbnN0IHUgPSB7CiAgICBzdGFydDogZmxhdC5yaWdodFNwYW4ocC5ub2Rlc1twLm5vZGVzLmxlbmd0aCAtIDFdLmluZGV4KSAvIDIgKyAxLAogICAgbGVuZ3RoOiBwLnBhdGNoLAogICAgbm9kZXM6IFtdCiAgfQoKICBmb3IgKGNvbnN0IG5vZGUgb2YgcC5ub2RlcykgewogICAgbGV0IHByZXNlbnQgPSBmYWxzZQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoIWNvbXBhcmVOb2RlKG5vZGVzW2ldLCBub2RlKSkgY29udGludWUKCiAgICAgIHUubm9kZXMucHVzaChpKQogICAgICBwcmVzZW50ID0gdHJ1ZQogICAgICBicmVhawogICAgfQoKICAgIGlmIChwcmVzZW50KSBjb250aW51ZQogICAgdS5ub2Rlcy5wdXNoKG5vZGVzLnB1c2gobm9kZSkgLSAxKQogIH0KCiAgcmV0dXJuIHUKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIE11dGV4IHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMubG9ja2VkID0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKCiAgICB0aGlzLl9kZXN0cm95aW5nID0gbnVsbAogICAgdGhpcy5fZGVzdHJveUVycm9yID0gbnVsbAogICAgdGhpcy5fcXVldWUgPSBbXQogICAgdGhpcy5fZW5xdWV1ZSA9IChyZXNvbHZlLCByZWplY3QpID0+IHRoaXMuX3F1ZXVlLnB1c2goW3Jlc29sdmUsIHJlamVjdF0pCiAgfQoKICBpZGxlKCkgewogICAgcmV0dXJuIHRoaXMuX3F1ZXVlLmxlbmd0aCA9PT0gMCAmJiB0aGlzLmxvY2tlZCA9PT0gZmFsc2UKICB9CgogIGxvY2soKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KHRoaXMuX2Rlc3Ryb3lFcnJvciB8fCBuZXcgRXJyb3IoJ011dGV4IGhhcyBiZWVuIGRlc3Ryb3llZCcpKQogICAgfQogICAgaWYgKHRoaXMubG9ja2VkKSByZXR1cm4gbmV3IFByb21pc2UodGhpcy5fZW5xdWV1ZSkKICAgIHRoaXMubG9ja2VkID0gdHJ1ZQogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCiAgfQoKICB1bmxvY2soKSB7CiAgICBpZiAoIXRoaXMuX3F1ZXVlLmxlbmd0aCkgewogICAgICB0aGlzLmxvY2tlZCA9IGZhbHNlCiAgICAgIHJldHVybgogICAgfQogICAgdGhpcy5fcXVldWUuc2hpZnQoKVswXSgpCiAgfQoKICBkZXN0cm95KGVycikgewogICAgaWYgKCF0aGlzLl9kZXN0cm95aW5nKSB7CiAgICAgIHRoaXMuX2Rlc3Ryb3lpbmcgPSB0aGlzLmxvY2tlZCA/IHRoaXMubG9jaygpLmNhdGNoKCgpID0+IHt9KSA6IFByb21pc2UucmVzb2x2ZSgpCiAgICB9CgogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCiAgICBpZiAoZXJyKSB0aGlzLl9kZXN0cm95RXJyb3IgPSBlcnIKCiAgICBpZiAoZXJyKSB7CiAgICAgIHdoaWxlICh0aGlzLl9xdWV1ZS5sZW5ndGgpIHRoaXMuX3F1ZXVlLnNoaWZ0KClbMV0oZXJyKQogICAgfQoKICAgIHJldHVybiB0aGlzLl9kZXN0cm95aW5nCiAgfQp9CmNvbnN0IEZJRk8gPSByZXF1aXJlKCdmYXN0LWZpZm8nKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSZWNlaXZlclF1ZXVlIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMucXVldWUgPSBuZXcgRklGTygpCiAgICB0aGlzLnByaW9yaXR5ID0gW10KICAgIHRoaXMucmVxdWVzdHMgPSBuZXcgTWFwKCkKICAgIHRoaXMubGVuZ3RoID0gMAogIH0KCiAgcHVzaChyZXEpIHsKICAgIC8vIFRPRE86IHVzZSBhIGhlYXAgYXQgc29tZSBwb2ludCBpZiB3ZSB3YW5uYSBzdXBwb3J0IG11bHRpcGxlIHByaW9zCiAgICBpZiAocmVxLnByaW9yaXR5ID4gMCkgdGhpcy5wcmlvcml0eS5wdXNoKHJlcSkKICAgIGVsc2UgdGhpcy5xdWV1ZS5wdXNoKHJlcSkKCiAgICB0aGlzLnJlcXVlc3RzLnNldChyZXEuaWQsIHJlcSkKICAgIHRoaXMubGVuZ3RoKysKICB9CgogIHNoaWZ0KCkgewogICAgd2hpbGUgKHRoaXMucHJpb3JpdHkubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBtc2cgPSB0aGlzLnByaW9yaXR5LnBvcCgpCiAgICAgIGNvbnN0IHJlcSA9IHRoaXMuX3Byb2Nlc3NSZXF1ZXN0KG1zZykKICAgICAgaWYgKHJlcSAhPT0gbnVsbCkgcmV0dXJuIHJlcQogICAgfQoKICAgIHdoaWxlICh0aGlzLnF1ZXVlLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgbXNnID0gdGhpcy5xdWV1ZS5zaGlmdCgpCiAgICAgIGNvbnN0IHJlcSA9IHRoaXMuX3Byb2Nlc3NSZXF1ZXN0KG1zZykKICAgICAgaWYgKHJlcSAhPT0gbnVsbCkgcmV0dXJuIHJlcQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBfcHJvY2Vzc1JlcXVlc3QocmVxKSB7CiAgICBpZiAocmVxLmJsb2NrIHx8IHJlcS5oYXNoIHx8IHJlcS5zZWVrIHx8IHJlcS51cGdyYWRlIHx8IHJlcS5tYW5pZmVzdCkgewogICAgICB0aGlzLnJlcXVlc3RzLmRlbGV0ZShyZXEuaWQpCiAgICAgIHRoaXMubGVuZ3RoLS0KICAgICAgcmV0dXJuIHJlcQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBjbGVhcigpIHsKICAgIHRoaXMucXVldWUuY2xlYXIoKQogICAgdGhpcy5wcmlvcml0eSA9IFtdCiAgICB0aGlzLmxlbmd0aCA9IDAKICAgIHRoaXMucmVxdWVzdHMuY2xlYXIoKQogIH0KCiAgZGVsZXRlKGlkKSB7CiAgICBjb25zdCByZXEgPSB0aGlzLnJlcXVlc3RzLmdldChpZCkKICAgIGlmICghcmVxKSByZXR1cm4KCiAgICByZXEuYmxvY2sgPSBudWxsCiAgICByZXEuaGFzaCA9IG51bGwKICAgIHJlcS5zZWVrID0gbnVsbAogICAgcmVxLnVwZ3JhZGUgPSBudWxsCiAgICByZXEubWFuaWZlc3QgPSBmYWxzZQoKICAgIHRoaXMucmVxdWVzdHMuZGVsZXRlKGlkKQogICAgdGhpcy5sZW5ndGgtLQoKICAgIGlmICh0aGlzLmxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLnF1ZXVlLmNsZWFyKCkKICAgICAgdGhpcy5wcmlvcml0eSA9IFtdCiAgICB9CiAgfQp9CmNvbnN0IEJpZ1NwYXJzZUFycmF5ID0gcmVxdWlyZSgnYmlnLXNwYXJzZS1hcnJheScpCmNvbnN0IHF1aWNrYml0ID0gcmVxdWlyZSgnLi9jb21wYXQnKS5xdWlja2JpdAoKY29uc3QgQklUU19QRVJfUEFHRSA9IDMyNzY4CmNvbnN0IEJZVEVTX1BFUl9QQUdFID0gQklUU19QRVJfUEFHRSAvIDgKY29uc3QgV09SRFNfUEVSX1BBR0UgPSBCWVRFU19QRVJfUEFHRSAvIDQKY29uc3QgQklUU19QRVJfU0VHTUVOVCA9IDIwOTcxNTIKY29uc3QgQllURVNfUEVSX1NFR01FTlQgPSBCSVRTX1BFUl9TRUdNRU5UIC8gOApjb25zdCBQQUdFU19QRVJfU0VHTUVOVCA9IEJJVFNfUEVSX1NFR01FTlQgLyBCSVRTX1BFUl9QQUdFCgpjbGFzcyBSZW1vdGVCaXRmaWVsZFBhZ2UgewogIGNvbnN0cnVjdG9yKGluZGV4LCBiaXRmaWVsZCwgc2VnbWVudCkgewogICAgdGhpcy5pbmRleCA9IGluZGV4CiAgICB0aGlzLm9mZnNldCA9IGluZGV4ICogQllURVNfUEVSX1BBR0UgLSBzZWdtZW50Lm9mZnNldAogICAgdGhpcy5iaXRmaWVsZCA9IGJpdGZpZWxkCiAgICB0aGlzLnNlZ21lbnQgPSBzZWdtZW50CgogICAgc2VnbWVudC5hZGQodGhpcykKICB9CgogIGdldCB0cmVlKCkgewogICAgcmV0dXJuIHRoaXMuc2VnbWVudC50cmVlCiAgfQoKICBnZXQoaW5kZXgpIHsKICAgIHJldHVybiBxdWlja2JpdC5nZXQodGhpcy5iaXRmaWVsZCwgaW5kZXgpCiAgfQoKICBzZXQoaW5kZXgsIHZhbCkgewogICAgaWYgKHF1aWNrYml0LnNldCh0aGlzLmJpdGZpZWxkLCBpbmRleCwgdmFsKSkgewogICAgICB0aGlzLnRyZWUudXBkYXRlKHRoaXMub2Zmc2V0ICogOCArIGluZGV4KQogICAgfQogIH0KCiAgc2V0UmFuZ2Uoc3RhcnQsIGVuZCwgdmFsKSB7CiAgICBxdWlja2JpdC5maWxsKHRoaXMuYml0ZmllbGQsIHZhbCwgc3RhcnQsIGVuZCkKCiAgICBsZXQgaSA9IE1hdGguZmxvb3Ioc3RhcnQgLyAxMjgpCiAgICBjb25zdCBuID0gaSArIE1hdGguY2VpbCgoZW5kIC0gc3RhcnQpIC8gMTI4KQoKICAgIHdoaWxlIChpIDw9IG4pIHRoaXMudHJlZS51cGRhdGUodGhpcy5vZmZzZXQgKiA4ICsgaSsrICogMTI4KQogIH0KCiAgZmluZEZpcnN0KHZhbCwgcG9zaXRpb24pIHsKICAgIHJldHVybiBxdWlja2JpdC5maW5kRmlyc3QodGhpcy5iaXRmaWVsZCwgdmFsLCBwb3NpdGlvbikKICB9CgogIGZpbmRMYXN0KHZhbCwgcG9zaXRpb24pIHsKICAgIHJldHVybiBxdWlja2JpdC5maW5kTGFzdCh0aGlzLmJpdGZpZWxkLCB2YWwsIHBvc2l0aW9uKQogIH0KCiAgaW5zZXJ0KHN0YXJ0LCBiaXRmaWVsZCkgewogICAgdGhpcy5iaXRmaWVsZC5zZXQoYml0ZmllbGQsIHN0YXJ0IC8gMzIpCiAgICB0aGlzLnNlZ21lbnQucmVmcmVzaCgpCiAgfQoKICBjbGVhcihzdGFydCwgYml0ZmllbGQpIHsKICAgIHF1aWNrYml0LmNsZWFyKHRoaXMuYml0ZmllbGQsIHsgZmllbGQ6IGJpdGZpZWxkLCBvZmZzZXQ6IHN0YXJ0IH0pCiAgfQp9CgpjbGFzcyBSZW1vdGVCaXRmaWVsZFNlZ21lbnQgewogIGNvbnN0cnVjdG9yKGluZGV4KSB7CiAgICB0aGlzLmluZGV4ID0gaW5kZXgKICAgIHRoaXMub2Zmc2V0ID0gaW5kZXggKiBCWVRFU19QRVJfU0VHTUVOVAogICAgdGhpcy50cmVlID0gcXVpY2tiaXQuSW5kZXguZnJvbShbXSwgQllURVNfUEVSX1NFR01FTlQpCiAgICB0aGlzLnBhZ2VzID0gbmV3IEFycmF5KFBBR0VTX1BFUl9TRUdNRU5UKQogICAgdGhpcy5wYWdlc0xlbmd0aCA9IDAKICB9CgogIGdldCBjaHVua3MoKSB7CiAgICByZXR1cm4gdGhpcy50cmVlLmNodW5rcwogIH0KCiAgcmVmcmVzaCgpIHsKICAgIHRoaXMudHJlZSA9IHF1aWNrYml0LkluZGV4LmZyb20odGhpcy50cmVlLmNodW5rcywgQllURVNfUEVSX1NFR01FTlQpCiAgfQoKICBhZGQocGFnZSkgewogICAgY29uc3QgcGFnZUluZGV4ID0gcGFnZS5pbmRleCAtIHRoaXMuaW5kZXggKiBQQUdFU19QRVJfU0VHTUVOVAogICAgaWYgKHBhZ2VJbmRleCA+PSB0aGlzLnBhZ2VzTGVuZ3RoKSB0aGlzLnBhZ2VzTGVuZ3RoID0gcGFnZUluZGV4ICsgMQoKICAgIHRoaXMucGFnZXNbcGFnZUluZGV4XSA9IHBhZ2UKCiAgICBjb25zdCBjaHVuayA9IHsgZmllbGQ6IHBhZ2UuYml0ZmllbGQsIG9mZnNldDogcGFnZS5vZmZzZXQgfQoKICAgIHRoaXMuY2h1bmtzLnB1c2goY2h1bmspCgogICAgZm9yIChsZXQgaSA9IHRoaXMuY2h1bmtzLmxlbmd0aCAtIDI7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHByZXYgPSB0aGlzLmNodW5rc1tpXQogICAgICBpZiAocHJldi5vZmZzZXQgPD0gY2h1bmsub2Zmc2V0KSBicmVhawogICAgICB0aGlzLmNodW5rc1tpXSA9IGNodW5rCiAgICAgIHRoaXMuY2h1bmtzW2kgKyAxXSA9IHByZXYKICAgIH0KICB9CgogIGZpbmRGaXJzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICBwb3NpdGlvbiA9IHRoaXMudHJlZS5za2lwRmlyc3QoIXZhbCwgcG9zaXRpb24pCgogICAgbGV0IGogPSBwb3NpdGlvbiAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGxldCBpID0gKHBvc2l0aW9uIC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgaWYgKGkgPj0gUEFHRVNfUEVSX1NFR01FTlQpIHJldHVybiAtMQoKICAgIHdoaWxlIChpIDwgdGhpcy5wYWdlc0xlbmd0aCkgewogICAgICBjb25zdCBwID0gdGhpcy5wYWdlc1tpXQoKICAgICAgbGV0IGluZGV4ID0gLTEKCiAgICAgIGlmIChwKSBpbmRleCA9IHAuZmluZEZpcnN0KHZhbCwgaikKICAgICAgZWxzZSBpZiAoIXZhbCkgaW5kZXggPSBqCgogICAgICBpZiAoaW5kZXggIT09IC0xKSByZXR1cm4gaSAqIEJJVFNfUEVSX1BBR0UgKyBpbmRleAoKICAgICAgaiA9IDAKICAgICAgaSsrCiAgICB9CgogICAgcmV0dXJuIHZhbCB8fCB0aGlzLnBhZ2VzTGVuZ3RoID09PSBQQUdFU19QRVJfU0VHTUVOVCA/IC0xIDogdGhpcy5wYWdlc0xlbmd0aCAqIEJJVFNfUEVSX1BBR0UKICB9CgogIGZpbmRMYXN0KHZhbCwgcG9zaXRpb24pIHsKICAgIHBvc2l0aW9uID0gdGhpcy50cmVlLnNraXBMYXN0KCF2YWwsIHBvc2l0aW9uKQoKICAgIGxldCBqID0gcG9zaXRpb24gJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChwb3NpdGlvbiAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIGlmIChpID49IFBBR0VTX1BFUl9TRUdNRU5UKSByZXR1cm4gLTEKCiAgICB3aGlsZSAoaSA+PSAwKSB7CiAgICAgIGNvbnN0IHAgPSB0aGlzLnBhZ2VzW2ldCgogICAgICBsZXQgaW5kZXggPSAtMQoKICAgICAgaWYgKHApIGluZGV4ID0gcC5maW5kTGFzdCh2YWwsIGopCiAgICAgIGVsc2UgaWYgKCF2YWwpIGluZGV4ID0gagoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIGkgKiBCSVRTX1BFUl9QQUdFICsgaW5kZXgKCiAgICAgIGogPSBCSVRTX1BFUl9QQUdFIC0gMQogICAgICBpLS0KICAgIH0KCiAgICByZXR1cm4gLTEKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUmVtb3RlQml0ZmllbGQgewogIHN0YXRpYyBCSVRTX1BFUl9QQUdFID0gQklUU19QRVJfUEFHRQoKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuX3BhZ2VzID0gbmV3IEJpZ1NwYXJzZUFycmF5KCkKICAgIHRoaXMuX3NlZ21lbnRzID0gbmV3IEJpZ1NwYXJzZUFycmF5KCkKICAgIHRoaXMuX21heFNlZ21lbnRzID0gMAogIH0KCiAgZ2V0Qml0ZmllbGQoaW5kZXgpIHsKICAgIGNvbnN0IGogPSBpbmRleCAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGNvbnN0IGkgPSAoaW5kZXggLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICBjb25zdCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCiAgICByZXR1cm4gcCB8fCBudWxsCiAgfQoKICBnZXQoaW5kZXgpIHsKICAgIGNvbnN0IGogPSBpbmRleCAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGNvbnN0IGkgPSAoaW5kZXggLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICBjb25zdCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCgogICAgcmV0dXJuIHAgPyBwLmdldChqKSA6IGZhbHNlCiAgfQoKICBzZXQoaW5kZXgsIHZhbCkgewogICAgY29uc3QgaiA9IGluZGV4ICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgY29uc3QgaSA9IChpbmRleCAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIGxldCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCgogICAgaWYgKCFwICYmIHZhbCkgewogICAgICBjb25zdCBrID0gTWF0aC5mbG9vcihpIC8gUEFHRVNfUEVSX1NFR01FTlQpCiAgICAgIGNvbnN0IHMgPSB0aGlzLl9zZWdtZW50cy5nZXQoaykgfHwgdGhpcy5fc2VnbWVudHMuc2V0KGssIG5ldyBSZW1vdGVCaXRmaWVsZFNlZ21lbnQoaykpCiAgICAgIGlmICh0aGlzLl9tYXhTZWdtZW50cyA8PSBrKSB0aGlzLl9tYXhTZWdtZW50cyA9IGsgKyAxCgogICAgICBwID0gdGhpcy5fcGFnZXMuc2V0KGksIG5ldyBSZW1vdGVCaXRmaWVsZFBhZ2UoaSwgbmV3IFVpbnQzMkFycmF5KFdPUkRTX1BFUl9QQUdFKSwgcykpCiAgICB9CgogICAgaWYgKHApIHAuc2V0KGosIHZhbCkKICB9CgogIHNldFJhbmdlKHN0YXJ0LCBlbmQsIHZhbCkgewogICAgbGV0IGogPSBzdGFydCAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGxldCBpID0gKHN0YXJ0IC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgd2hpbGUgKHN0YXJ0IDwgZW5kKSB7CiAgICAgIGxldCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCgogICAgICBpZiAoIXAgJiYgdmFsKSB7CiAgICAgICAgY29uc3QgayA9IE1hdGguZmxvb3IoaSAvIFBBR0VTX1BFUl9TRUdNRU5UKQogICAgICAgIGNvbnN0IHMgPSB0aGlzLl9zZWdtZW50cy5nZXQoaykgfHwgdGhpcy5fc2VnbWVudHMuc2V0KGssIG5ldyBSZW1vdGVCaXRmaWVsZFNlZ21lbnQoaykpCiAgICAgICAgaWYgKHRoaXMuX21heFNlZ21lbnRzIDw9IGspIHRoaXMuX21heFNlZ21lbnRzID0gayArIDEKCiAgICAgICAgcCA9IHRoaXMuX3BhZ2VzLnNldChpLCBuZXcgUmVtb3RlQml0ZmllbGRQYWdlKGksIG5ldyBVaW50MzJBcnJheShXT1JEU19QRVJfUEFHRSksIHMpKQogICAgICB9CgogICAgICBjb25zdCBvZmZzZXQgPSBpICogQklUU19QRVJfUEFHRQogICAgICBjb25zdCBsYXN0ID0gTWF0aC5taW4oZW5kIC0gb2Zmc2V0LCBCSVRTX1BFUl9QQUdFKQogICAgICBjb25zdCByYW5nZSA9IGxhc3QgLSBqCgogICAgICBpZiAocCkgcC5zZXRSYW5nZShqLCBsYXN0LCB2YWwpCgogICAgICBqID0gMAogICAgICBpKysKICAgICAgc3RhcnQgKz0gcmFuZ2UKICAgIH0KICB9CgogIGZpbmRGaXJzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICBsZXQgaiA9IHBvc2l0aW9uICYgKEJJVFNfUEVSX1NFR01FTlQgLSAxKQogICAgbGV0IGkgPSAocG9zaXRpb24gLSBqKSAvIEJJVFNfUEVSX1NFR01FTlQKCiAgICB3aGlsZSAoaSA8IHRoaXMuX21heFNlZ21lbnRzKSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLl9zZWdtZW50cy5nZXQoaSkKCiAgICAgIGxldCBpbmRleCA9IC0xCgogICAgICBpZiAocykgaW5kZXggPSBzLmZpbmRGaXJzdCh2YWwsIGopCiAgICAgIGVsc2UgaWYgKCF2YWwpIGluZGV4ID0gagoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIGkgKiBCSVRTX1BFUl9TRUdNRU5UICsgaW5kZXgKCiAgICAgIGogPSAwCiAgICAgIGkrKwogICAgfQoKICAgIC8vIEZvciB0aGUgdmFsID09PSBmYWxzZSBjYXNlLCB3ZSBhbHdheXMgcmV0dXJuIGF0IGxlYXN0CiAgICAvLyB0aGUgJ3Bvc2l0aW9uJywgYWxzbyBpZiBub3RoaW5nIHdhcyBmb3VuZAogICAgcmV0dXJuIHZhbCA/IC0xIDogTWF0aC5tYXgocG9zaXRpb24sIHRoaXMuX21heFNlZ21lbnRzICogQklUU19QRVJfU0VHTUVOVCkKICB9CgogIGZpcnN0U2V0KHBvc2l0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5maW5kRmlyc3QodHJ1ZSwgcG9zaXRpb24pCiAgfQoKICBmaXJzdFVuc2V0KHBvc2l0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5maW5kRmlyc3QoZmFsc2UsIHBvc2l0aW9uKQogIH0KCiAgZmluZExhc3QodmFsLCBwb3NpdGlvbikgewogICAgbGV0IGogPSBwb3NpdGlvbiAmIChCSVRTX1BFUl9TRUdNRU5UIC0gMSkKICAgIGxldCBpID0gKHBvc2l0aW9uIC0gaikgLyBCSVRTX1BFUl9TRUdNRU5UCgogICAgd2hpbGUgKGkgPj0gMCkgewogICAgICBjb25zdCBzID0gdGhpcy5fc2VnbWVudHMuZ2V0KGkpCgogICAgICBsZXQgaW5kZXggPSAtMQoKICAgICAgaWYgKHMpIGluZGV4ID0gcy5maW5kTGFzdCh2YWwsIGopCiAgICAgIGVsc2UgaWYgKCF2YWwpIGluZGV4ID0gagoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIGkgKiBCSVRTX1BFUl9TRUdNRU5UICsgaW5kZXgKCiAgICAgIGogPSBCSVRTX1BFUl9TRUdNRU5UIC0gMQogICAgICBpLS0KICAgIH0KCiAgICByZXR1cm4gLTEKICB9CgogIGxhc3RTZXQocG9zaXRpb24pIHsKICAgIHJldHVybiB0aGlzLmZpbmRMYXN0KHRydWUsIHBvc2l0aW9uKQogIH0KCiAgbGFzdFVuc2V0KHBvc2l0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5maW5kTGFzdChmYWxzZSwgcG9zaXRpb24pCiAgfQoKICBpbnNlcnQoc3RhcnQsIGJpdGZpZWxkKSB7CiAgICBpZiAoc3RhcnQgJSAzMiAhPT0gMCkgcmV0dXJuIGZhbHNlCgogICAgbGV0IGxlbmd0aCA9IGJpdGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogICAgbGV0IGogPSBzdGFydCAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGxldCBpID0gKHN0YXJ0IC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgd2hpbGUgKGxlbmd0aCA+IDApIHsKICAgICAgbGV0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKCiAgICAgIGlmICghcCkgewogICAgICAgIGNvbnN0IGsgPSBNYXRoLmZsb29yKGkgLyBQQUdFU19QRVJfU0VHTUVOVCkKICAgICAgICBjb25zdCBzID0gdGhpcy5fc2VnbWVudHMuZ2V0KGspIHx8IHRoaXMuX3NlZ21lbnRzLnNldChrLCBuZXcgUmVtb3RlQml0ZmllbGRTZWdtZW50KGspKQogICAgICAgIGlmICh0aGlzLl9tYXhTZWdtZW50cyA8PSBrKSB0aGlzLl9tYXhTZWdtZW50cyA9IGsgKyAxCgogICAgICAgIHAgPSB0aGlzLl9wYWdlcy5zZXQoaSwgbmV3IFJlbW90ZUJpdGZpZWxkUGFnZShpLCBuZXcgVWludDMyQXJyYXkoV09SRFNfUEVSX1BBR0UpLCBzKSkKICAgICAgfQoKICAgICAgY29uc3QgZW5kID0gTWF0aC5taW4oaiArIGxlbmd0aCwgQklUU19QRVJfUEFHRSkKICAgICAgY29uc3QgcmFuZ2UgPSBlbmQgLSBqCgogICAgICBwLmluc2VydChqLCBiaXRmaWVsZC5zdWJhcnJheSgwLCByYW5nZSAvIDMyKSkKCiAgICAgIGJpdGZpZWxkID0gYml0ZmllbGQuc3ViYXJyYXkocmFuZ2UgLyAzMikKCiAgICAgIGogPSAwCiAgICAgIGkrKwogICAgICBsZW5ndGggLT0gcmFuZ2UKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgY2xlYXIoc3RhcnQsIGJpdGZpZWxkKSB7CiAgICBpZiAoc3RhcnQgJSAzMiAhPT0gMCkgcmV0dXJuIGZhbHNlCgogICAgbGV0IGxlbmd0aCA9IGJpdGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogICAgbGV0IGogPSBzdGFydCAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGxldCBpID0gKHN0YXJ0IC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgd2hpbGUgKGxlbmd0aCA+IDApIHsKICAgICAgbGV0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKCiAgICAgIGlmICghcCkgewogICAgICAgIGNvbnN0IGsgPSBNYXRoLmZsb29yKGkgLyBQQUdFU19QRVJfU0VHTUVOVCkKICAgICAgICBjb25zdCBzID0gdGhpcy5fc2VnbWVudHMuZ2V0KGspIHx8IHRoaXMuX3NlZ21lbnRzLnNldChrLCBuZXcgUmVtb3RlQml0ZmllbGRTZWdtZW50KGspKQogICAgICAgIGlmICh0aGlzLl9tYXhTZWdtZW50cyA8PSBrKSB0aGlzLl9tYXhTZWdtZW50cyA9IGsgKyAxCgogICAgICAgIHAgPSB0aGlzLl9wYWdlcy5zZXQoaSwgbmV3IFJlbW90ZUJpdGZpZWxkUGFnZShpLCBuZXcgVWludDMyQXJyYXkoV09SRFNfUEVSX1BBR0UpLCBzKSkKICAgICAgfQoKICAgICAgY29uc3QgZW5kID0gTWF0aC5taW4oaiArIGxlbmd0aCwgQklUU19QRVJfUEFHRSkKICAgICAgY29uc3QgcmFuZ2UgPSBlbmQgLSBqCgogICAgICBwLmNsZWFyKGosIGJpdGZpZWxkLnN1YmFycmF5KDAsIHJhbmdlIC8gMzIpKQoKICAgICAgYml0ZmllbGQgPSBiaXRmaWVsZC5zdWJhcnJheShyYW5nZSAvIDMyKQoKICAgICAgaiA9IDAKICAgICAgaSsrCiAgICAgIGxlbmd0aCAtPSByYW5nZQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQp9Ci8qIERFViBET0NTCiAgRXZlcnkgaHlwZXJjb3JlIGhhcyBvbmUgUmVwbGljYXRvciBvYmplY3QgbWFuYWdpbmcgaXRzIGNvbm5lY3Rpb25zIHRvIG90aGVyIHBlZXJzLgogIFRoZXJlIGlzIG9uZSBQZWVyIG9iamVjdCBwZXIgcGVlciBjb25uZWN0ZWQgdG8gdGhlIEh5cGVyY29yZS4KICBIeXBlcmNvcmVzIGRvIG5vdCBrbm93IGFib3V0IG90aGVyIGh5cGVyY29yZXMsIHNvIHdoZW4gYSBwZWVyIGlzIGNvbm5lY3RlZCB0byBtdWx0aXBsZSBjb3JlcywgdGhlcmUgZXhpc3RzIG9uZSBQZWVyIG9iamVjdCBwZXIgY29yZS4KCiAgSHlwZXJjb3JlIGluZGljYXRlcyBibG9jayBzaG91bGQgYmUgZG93bmxvYWRlZCB0aHJvdWdoIG1ldGhvZHMgbGlrZSBSZXBsaWNhdG9yLmFkZFJhbmdlIG9yIFJlcGxpY2F0b3IuYWRkQmxvY2sKICBIeXBlcmNvcmUgY2FsbHMgUmVwbGljYXRvci51cGRhdGVBY3Rpdml0eSBldmVyeSB0aW1lIGEgaHlwZXJjb3JlIHNlc3Npb24gb3BlbnMvY2xvc2VzCiAgUmVwbGljYXRvci51cGRhdGVBY3Rpdml0eSBlbnN1cmVzIHRoZSBIeXBlcmNvcmUgaXMgZG93bmxvYWRpbmcgYmxvY2tzIGFzIGV4cGVjdGVkCiAgUmVwbGljYXRvciBrZWVwcyB0cmFjayBvZjoKICAgIC0gV2hpY2ggYmxvY2tzIG5lZWQgdG8gYmUgZG93bmxvYWRlZCAoUmVwbGljYXRvci5fYmxvY2tzKQogICAgLSBXaGljaCBibG9ja3MgY3VycmVudGx5IGhhdmUgaW5mbGlnaHQgcmVxdWVzdHMgKFJlcGxpY2F0b3IuX2luZmxpZ2h0KQoKICBCbG9ja3MgYXJlIHJlcXVlc3RlZCBmcm9tIHJlbW90ZSBwZWVycyBieSBQZWVyIG9iamVjdHMuIFRoZSBmbG93IGlzOgogICAgLSBUaGUgcmVwbGljYXRvcidzIHVwZGF0ZVBlZXIgbWV0aG9kIGdldHMgY2FsbGVkCiAgICAtIFRoZSByZXBsaWNhdG9yIGRldGVjdHMgd2hldGhlciB0aGUgUGVlciBjYW4gYWNjZXB0IG1vcmUgcmVxdWVzdHMgKGZvciBleGFtcGxlIGJ5IGNoZWNraW5nIGlmIGl0J3MgbWF4ZWQgb3V0IG9uIGluZmxpZ2h0IGJsb2NrcykKICAgIC0gVGhlIHJlcGxpY2F0b3IgdGhlbiB0ZWxscyB0aGUgUGVlciB3aGF0IHRvIHJlcXVlc3QgKGUuZy4gUGVlcl9yZXF1ZXN0UmFuZ2Ugb3IgUGVlci5fcmVxdWVzdEJsb2NrIG1ldGhvZHMpCgogIFRoZSBQZWVyIG9iamVjdCBpcyByZXNwb25zaWJsZSBmb3IgdHJhY2tpbmcKICAgIC0gV2hpY2ggYmxvY2tzIGRvZXMgdGhlIFBlZXIgaGF2ZSBhdmFpbGFibGUgKHRyYWNrZWQgaW4gcmVtb3RlQml0ZmllbGQpCiAgICAtIFdoaWNoIGJsb2NrcyBhcmUgeW91IGFjdGl2ZWx5IGxvb2tpbmcgZm9yIGZyb20gdGhpcyBwZWVyICh0cmFja2VkIGluIG1pc3NpbmdCbG9ja3MpCiAgICAtIEhvdyBtYW55IGJsb2NrcyBhcmUgY3VycmVudGx5IGluZmxpZ2h0ICh0cmFja2VkIGluIGluZmxpZ2h0KQogIFRoZSBQZWVyIHVzZXMgdGhpcyBpbmZvcm1hdGlvbiB0byBkZWNpZGUgd2hpY2ggYmxvY2tzIHRvIHJlcXVlc3QgZnJvbSB0aGUgcGVlciBpbiByZXNwb25zZSB0byBfcmVxdWVzdFJhbmdlIHJlcXVlc3RzIGFuZCB0aGUgbGlrZS4KKi8KCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgUmFuZG9tSXRlcmF0b3IgPSByZXF1aXJlKCdyYW5kb20tYXJyYXktaXRlcmF0b3InKQpjb25zdCBmbGF0VHJlZSA9IHJlcXVpcmUoJ2ZsYXQtdHJlZScpCmNvbnN0IE11dGV4ID0gcmVxdWlyZSgnLi9tdXRleCcpCmNvbnN0IFJlY2VpdmVyUXVldWUgPSByZXF1aXJlKCcuL3JlY2VpdmVyLXF1ZXVlJykKY29uc3QgSG90c3dhcFF1ZXVlID0gcmVxdWlyZSgnLi9ob3Rzd2FwLXF1ZXVlJykKY29uc3QgUmVtb3RlQml0ZmllbGQgPSByZXF1aXJlKCcuL3JlbW90ZS1iaXRmaWVsZCcpCmNvbnN0IHsgTWVya2xlVHJlZSB9ID0gcmVxdWlyZSgnLi9tZXJrbGUtdHJlZScpCmNvbnN0IHsKICBSRVFVRVNUX0NBTkNFTExFRCwKICBSRVFVRVNUX1RJTUVPVVQsCiAgSU5WQUxJRF9DQVBBQklMSVRZLAogIFNOQVBTSE9UX05PVF9BVkFJTEFCTEUsCiAgQVNTRVJUSU9OCn0gPSByZXF1aXJlKCdoeXBlcmNvcmUtZXJyb3JzJykKY29uc3QgbSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMnKQpjb25zdCBjYXBzID0gcmVxdWlyZSgnLi9jYXBzJykKCmNvbnN0IERFRkFVTFRfTUFYX0lORkxJR0hUID0gWzE2LCA1MTJdCmNvbnN0IFNDQUxFX0xBVEVOQ1kgPSA1MApjb25zdCBERUZBVUxUX1NFR01FTlRfU0laRSA9IDI1NiAqIDEwMjQgKiA4IC8vIDI1NiBLaUIgaW4gYml0cwpjb25zdCBOT1RfRE9XTkxPQURJTkdfU0xBQ0sgPSAoMjAwMDAgKyBNYXRoLnJhbmRvbSgpICogMjAwMDApIHwgMApjb25zdCBNQVhfUEVFUlNfVVBHUkFERSA9IDMKY29uc3QgTEFTVF9CTE9DS1MgPSAyNTYKY29uc3QgTUFYX1JFTU9URV9TRUdNRU5UUyA9IDIwNDgKCmNvbnN0IE1BWF9SQU5HRVMgPSA2NAoKY29uc3QgTk9UX0FWQUlMQUJMRSA9IDEKY29uc3QgSU5WQUxJRF9SRVFVRVNUID0gMgpjb25zdCBNQVhfSU5WQUxJRF9SRVFVRVNUUyA9IDY0CmNvbnN0IE1BWF9CQUNLT0ZGUyA9IE1BWF9JTlZBTElEX1JFUVVFU1RTIC8gMgoKY29uc3QgUFJJT1JJVFkgPSB7CiAgTk9STUFMOiAwLAogIEhJR0g6IDEsCiAgVkVSWV9ISUdIOiAyLAogIENBTkNFTExFRDogMjU1IC8vIHJlc2VydmVkIHRvIG1hcmsgY2FuY2VsbGF0aW9uCn0KCmNsYXNzIEF0dGFjaGFibGUgewogIGNvbnN0cnVjdG9yKHJlcGxpY2F0b3IpIHsKICAgIHRoaXMucmVwbGljYXRvciA9IHJlcGxpY2F0b3IKICAgIHRoaXMucmVzb2x2ZWQgPSBmYWxzZQogICAgdGhpcy5wcm9jZXNzaW5nID0gZmFsc2UKICAgIHRoaXMucmVmcyA9IFtdCiAgfQoKICBhdHRhY2goc2Vzc2lvbikgewogICAgY29uc3QgciA9IHsKICAgICAgY29udGV4dDogdGhpcywKICAgICAgc2Vzc2lvbiwKICAgICAgc2luZGV4OiAwLAogICAgICByaW5kZXg6IDAsCiAgICAgIHNuYXBzaG90OiB0cnVlLAogICAgICByZXNvbHZlOiBudWxsLAogICAgICByZWplY3Q6IG51bGwsCiAgICAgIHByb21pc2U6IG51bGwsCiAgICAgIHRpbWVvdXQ6IG51bGwKICAgIH0KCiAgICByLnNpbmRleCA9IHNlc3Npb24ucHVzaChyKSAtIDEKICAgIHIucmluZGV4ID0gdGhpcy5yZWZzLnB1c2gocikgLSAxCiAgICByLnByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIHIucmVzb2x2ZSA9IHJlc29sdmUKICAgICAgci5yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgcmV0dXJuIHIKICB9CgogIGRldGFjaChyLCBlcnIgPSBudWxsKSB7CiAgICBpZiAoci5jb250ZXh0ICE9PSB0aGlzKSByZXR1cm4gZmFsc2UKCiAgICB0aGlzLl9kZXRhY2gocikKICAgIHRoaXMuX2NhbmNlbChyLCBlcnIpCiAgICB0aGlzLmdjKCkKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX2RldGFjaChyKSB7CiAgICBjb25zdCByaCA9IHRoaXMucmVmcy5wb3AoKQogICAgY29uc3Qgc2ggPSByLnNlc3Npb24ucG9wKCkKCiAgICBpZiAoci5yaW5kZXggPCB0aGlzLnJlZnMubGVuZ3RoKSB0aGlzLnJlZnNbKHJoLnJpbmRleCA9IHIucmluZGV4KV0gPSByaAogICAgaWYgKHIuc2luZGV4IDwgci5zZXNzaW9uLmxlbmd0aCkgci5zZXNzaW9uWyhzaC5zaW5kZXggPSByLnNpbmRleCldID0gc2gKCiAgICBkZXN0cm95UmVxdWVzdFRpbWVvdXQocikKICAgIHIuY29udGV4dCA9IG51bGwKCiAgICByZXR1cm4gcgogIH0KCiAgZ2MoKSB7CiAgICBpZiAodGhpcy5yZWZzLmxlbmd0aCA9PT0gMCAmJiAhdGhpcy5wcm9jZXNzaW5nKSB0aGlzLl91bnJlZigpCiAgfQoKICBwcm9jZXNzZWQoKSB7CiAgICB0aGlzLnByb2Nlc3NpbmcgPSBmYWxzZQogICAgdGhpcy5nYygpCiAgfQoKICBfY2FuY2VsKHIsIGVycikgewogICAgci5yZWplY3QoZXJyIHx8IFJFUVVFU1RfQ0FOQ0VMTEVEKCkpCiAgfQoKICBfdW5yZWYoKSB7CiAgICAvLyBvdmVyd3JpdGUgbWUKICB9CgogIHJlc29sdmUodmFsKSB7CiAgICB0aGlzLnJlc29sdmVkID0gdHJ1ZQogICAgd2hpbGUgKHRoaXMucmVmcy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuX2RldGFjaCh0aGlzLnJlZnNbdGhpcy5yZWZzLmxlbmd0aCAtIDFdKS5yZXNvbHZlKHZhbCkKICAgIH0KICB9CgogIHJlamVjdChlcnIpIHsKICAgIHRoaXMucmVzb2x2ZWQgPSB0cnVlCiAgICB3aGlsZSAodGhpcy5yZWZzLmxlbmd0aCA+IDApIHsKICAgICAgdGhpcy5fZGV0YWNoKHRoaXMucmVmc1t0aGlzLnJlZnMubGVuZ3RoIC0gMV0pLnJlamVjdChlcnIpCiAgICB9CiAgfQoKICBzZXRUaW1lb3V0KHIsIG1zKSB7CiAgICBkZXN0cm95UmVxdWVzdFRpbWVvdXQocikKICAgIHIudGltZW91dCA9IHNldFRpbWVvdXQob25yZXF1ZXN0dGltZW91dCwgbXMsIHIpCiAgfQp9CgpjbGFzcyBCbG9ja1JlcXVlc3QgZXh0ZW5kcyBBdHRhY2hhYmxlIHsKICBjb25zdHJ1Y3RvcihyZXBsaWNhdG9yLCB0cmFja2VyLCBpbmRleCwgcHJpb3JpdHkpIHsKICAgIHN1cGVyKHJlcGxpY2F0b3IpCgogICAgdGhpcy5pbmRleCA9IGluZGV4CiAgICB0aGlzLnByaW9yaXR5ID0gcHJpb3JpdHkKICAgIHRoaXMuaW5mbGlnaHQgPSBbXQogICAgdGhpcy5xdWV1ZWQgPSBmYWxzZQogICAgdGhpcy5ob3Rzd2FwID0gbnVsbAogICAgdGhpcy50cmFja2VyID0gdHJhY2tlcgogIH0KCiAgX3VucmVmKCkgewogICAgdGhpcy5xdWV1ZWQgPSBmYWxzZQoKICAgIGZvciAoY29uc3QgcmVxIG9mIHRoaXMuaW5mbGlnaHQpIHsKICAgICAgcmVxLnBlZXIuX2NhbmNlbFJlcXVlc3QocmVxKQogICAgfQoKICAgIHRoaXMudHJhY2tlci5yZW1vdmUodGhpcy5pbmRleCkKICAgIHJlbW92ZUhvdHN3YXAodGhpcykKICB9Cn0KCmNsYXNzIFJhbmdlUmVxdWVzdCBleHRlbmRzIEF0dGFjaGFibGUgewogIGNvbnN0cnVjdG9yKHJlcGxpY2F0b3IsIHJhbmdlcywgc3RhcnQsIGVuZCwgbGluZWFyLCBpZkF2YWlsYWJsZSwgYmxvY2tzKSB7CiAgICBzdXBlcihyZXBsaWNhdG9yKQoKICAgIHRoaXMuc3RhcnQgPSBzdGFydAogICAgdGhpcy5lbmQgPSBlbmQKICAgIHRoaXMubGluZWFyID0gbGluZWFyCiAgICB0aGlzLmlmQXZhaWxhYmxlID0gaWZBdmFpbGFibGUKICAgIHRoaXMuYmxvY2tzID0gYmxvY2tzCiAgICB0aGlzLnJhbmdlcyA9IHJhbmdlcwogICAgcmFuZ2VzLnB1c2godGhpcykKCiAgICBpZiAodGhpcy5lbmQgPT09IC0xKSB7CiAgICAgIHRoaXMucmVwbGljYXRvci5fYWx3YXlzTGF0ZXN0QmxvY2srKwogICAgfQoKICAgIC8vIEFzIHBhc3NlZCBieSB0aGUgdXNlciwgaW1tdXQKICAgIHRoaXMudXNlclN0YXJ0ID0gc3RhcnQKICAgIHRoaXMudXNlckVuZCA9IGVuZAogIH0KCiAgX3VucmVmKCkgewogICAgY29uc3QgcmFuZ2VJbmRleCA9IHRoaXMucmFuZ2VzLmluZGV4T2YodGhpcykKICAgIGlmIChyYW5nZUluZGV4ID09PSAtMSkgcmV0dXJuCgogICAgY29uc3QgaCA9IHRoaXMucmFuZ2VzLnBvcCgpCiAgICBpZiAoaCAhPT0gdGhpcykgewogICAgICB0aGlzLnJhbmdlc1tyYW5nZUluZGV4XSA9IGgKICAgIH0KCiAgICBpZiAodGhpcy5lbmQgPT09IC0xKSB7CiAgICAgIHRoaXMucmVwbGljYXRvci5fYWx3YXlzTGF0ZXN0QmxvY2stLQogICAgfQogIH0KCiAgX2NhbmNlbChyKSB7CiAgICByLnJlc29sdmUoZmFsc2UpCiAgfQp9CgpjbGFzcyBVcGdyYWRlUmVxdWVzdCBleHRlbmRzIEF0dGFjaGFibGUgewogIGNvbnN0cnVjdG9yKHJlcGxpY2F0b3IsIGZvcmssIGxlbmd0aCkgewogICAgc3VwZXIocmVwbGljYXRvcikKCiAgICB0aGlzLmZvcmsgPSBmb3JrCiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aAogICAgdGhpcy5pbmZsaWdodCA9IFtdCiAgfQoKICBfdW5yZWYoKSB7CiAgICBpZiAodGhpcy5yZXBsaWNhdG9yLmVhZ2VyVXBncmFkZSA9PT0gdHJ1ZSB8fCB0aGlzLmluZmxpZ2h0Lmxlbmd0aCA+IDApIHJldHVybgogICAgdGhpcy5yZXBsaWNhdG9yLl91cGdyYWRlID0gbnVsbAogIH0KCiAgX2NhbmNlbChyKSB7CiAgICByLnJlc29sdmUoZmFsc2UpCiAgfQp9CgpjbGFzcyBTZWVrUmVxdWVzdCBleHRlbmRzIEF0dGFjaGFibGUgewogIGNvbnN0cnVjdG9yKHJlcGxpY2F0b3IsIHNlZWtzLCBzZWVrZXIpIHsKICAgIHN1cGVyKHJlcGxpY2F0b3IpCgogICAgdGhpcy5zZWVrZXIgPSBzZWVrZXIKICAgIHRoaXMuaW5mbGlnaHQgPSBbXQogICAgdGhpcy5zZWVrcyA9IHNlZWtzCiAgfQoKICBfdW5yZWYoKSB7CiAgICBpZiAodGhpcy5pbmZsaWdodC5sZW5ndGggPiAwKSByZXR1cm4KICAgIGNvbnN0IGkgPSB0aGlzLnNlZWtzLmluZGV4T2YodGhpcykKICAgIGlmIChpID09PSAtMSkgcmV0dXJuCiAgICBjb25zdCBoID0gdGhpcy5zZWVrcy5wb3AoKQogICAgaWYgKGkgPCB0aGlzLnNlZWtzLmxlbmd0aCkgdGhpcy5zZWVrc1tpXSA9IGgKICB9Cn0KCmNsYXNzIEluZmxpZ2h0VHJhY2tlciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLl9yZXF1ZXN0cyA9IFtdCiAgICB0aGlzLl9mcmVlID0gW10KICAgIHRoaXMuX2FjdGl2ZSA9IDAKICB9CgogIGdldCBpZGxlKCkgewogICAgcmV0dXJuIHRoaXMuX2FjdGl2ZSA9PT0gMAogIH0KCiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgZm9yIChjb25zdCByZXEgb2YgdGhpcy5fcmVxdWVzdHMpIHsKICAgICAgaWYgKHJlcSAhPT0gbnVsbCkgeWllbGQgcmVxCiAgICB9CiAgfQoKICBhZGQocmVxKSB7CiAgICBjb25zdCBpZCA9IHRoaXMuX2ZyZWUubGVuZ3RoID8gdGhpcy5fZnJlZS5wb3AoKSA6IHRoaXMuX3JlcXVlc3RzLnB1c2gobnVsbCkKICAgIHJlcS5pZCA9IGlkCiAgICB0aGlzLl9yZXF1ZXN0c1tpZCAtIDFdID0gcmVxCiAgICB0aGlzLl9hY3RpdmUrKwogICAgcmV0dXJuIHJlcQogIH0KCiAgZ2V0KGlkKSB7CiAgICByZXR1cm4gaWQgPD0gdGhpcy5fcmVxdWVzdHMubGVuZ3RoID8gdGhpcy5fcmVxdWVzdHNbaWQgLSAxXSA6IG51bGwKICB9CgogIHJlbW92ZShpZCwgcm91bmR0cmlwKSB7CiAgICBpZiAoaWQgPiB0aGlzLl9yZXF1ZXN0cy5sZW5ndGgpIHJldHVybgogICAgaWYgKHRoaXMuX3JlcXVlc3RzW2lkIC0gMV0pIHRoaXMuX2FjdGl2ZS0tCiAgICB0aGlzLl9yZXF1ZXN0c1tpZCAtIDFdID0gbnVsbAogICAgaWYgKHJvdW5kdHJpcCA9PT0gdHJ1ZSkgdGhpcy5fZnJlZS5wdXNoKGlkKQogIH0KCiAgcmV1c2FibGUoaWQpIHsKICAgIHRoaXMuX2ZyZWUucHVzaChpZCkKICB9Cn0KCmNsYXNzIEJsb2NrVHJhY2tlciB7CiAgY29uc3RydWN0b3IocmVwbGljYXRvcikgewogICAgdGhpcy5fcmVwbGljYXRvciA9IHJlcGxpY2F0b3IKICAgIHRoaXMuX21hcCA9IG5ldyBNYXAoKQogIH0KCiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy5fbWFwLnZhbHVlcygpCiAgfQoKICBpc0VtcHR5KCkgewogICAgcmV0dXJuIHRoaXMuX21hcC5zaXplID09PSAwCiAgfQoKICBoYXMoaW5kZXgpIHsKICAgIHJldHVybiB0aGlzLl9tYXAuaGFzKGluZGV4KQogIH0KCiAgZ2V0KGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5fbWFwLmdldChpbmRleCkgfHwgbnVsbAogIH0KCiAgYWRkKGluZGV4LCBwcmlvcml0eSkgewogICAgbGV0IGIgPSB0aGlzLl9tYXAuZ2V0KGluZGV4KQogICAgaWYgKGIpIHJldHVybiBiCgogICAgYiA9IG5ldyBCbG9ja1JlcXVlc3QodGhpcy5fcmVwbGljYXRvciwgdGhpcywgaW5kZXgsIHByaW9yaXR5KQogICAgdGhpcy5fbWFwLnNldChpbmRleCwgYikKCiAgICByZXR1cm4gYgogIH0KCiAgcmVtb3ZlKGluZGV4KSB7CiAgICBjb25zdCBiID0gdGhpcy5nZXQoaW5kZXgpCiAgICB0aGlzLl9tYXAuZGVsZXRlKGluZGV4KQogICAgcmV0dXJuIGIKICB9Cn0KCmNsYXNzIFJvdW5kdHJpcFF1ZXVlIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMucXVldWUgPSBbXQogICAgdGhpcy50aWNrID0gMAogIH0KCiAgY2xlYXIoKSB7CiAgICBjb25zdCBpZHMgPSBuZXcgQXJyYXkodGhpcy5xdWV1ZS5sZW5ndGgpCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGlkcy5sZW5ndGg7IGkrKykgewogICAgICBpZHNbaV0gPSB0aGlzLnF1ZXVlW2ldWzFdCiAgICB9CgogICAgdGhpcy5xdWV1ZSA9IFtdCgogICAgcmV0dXJuIGlkcwogIH0KCiAgYWRkKGlkKSB7CiAgICB0aGlzLnF1ZXVlLnB1c2goWysrdGhpcy50aWNrLCBpZF0pCiAgfQoKICBmbHVzaCh0aWNrKSB7CiAgICBsZXQgZmx1c2hlZCA9IG51bGwKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHRoaXMucXVldWVbaV1bMF0gPiB0aWNrKSBicmVhawogICAgICBpZiAoZmx1c2hlZCA9PT0gbnVsbCkgZmx1c2hlZCA9IFtdCiAgICAgIGZsdXNoZWQucHVzaCh0aGlzLnF1ZXVlW2ldWzFdKQogICAgfQoKICAgIGlmIChmbHVzaGVkICE9PSBudWxsKSB0aGlzLnF1ZXVlLnNwbGljZSgwLCBmbHVzaGVkLmxlbmd0aCkKICAgIHJldHVybiBmbHVzaGVkCiAgfQp9CgpjbGFzcyBQcm9vZlJlcXVlc3QgewogIGNvbnN0cnVjdG9yKG1zZywgcHJvb2YsIGJsb2NrLCBtYW5pZmVzdCkgewogICAgdGhpcy5tc2cgPSBtc2cKICAgIHRoaXMucHJvb2YgPSBwcm9vZgogICAgdGhpcy5ibG9jayA9IGJsb2NrCiAgICB0aGlzLm1hbmlmZXN0ID0gbWFuaWZlc3QKICB9CgogIGFzeW5jIGZ1bGZpbGwoKSB7CiAgICBpZiAodGhpcy5wcm9vZiA9PT0gbnVsbCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBbcHJvb2YsIGJsb2NrXSA9IGF3YWl0IFByb21pc2UuYWxsKFt0aGlzLnByb29mLnNldHRsZSgpLCB0aGlzLmJsb2NrXSkKCiAgICBpZiAodGhpcy5tYW5pZmVzdCkgcHJvb2YubWFuaWZlc3QgPSB0aGlzLm1hbmlmZXN0CiAgICBpZiAoIWJsb2NrICYmIHByb29mLmJsb2NrKSByZXR1cm4gbnVsbAoKICAgIGlmIChibG9jaykgcHJvb2YuYmxvY2sudmFsdWUgPSBibG9jawogICAgcmV0dXJuIHByb29mCiAgfQp9CgpjbGFzcyBQZWVyIHsKICBjb25zdHJ1Y3RvcihyZXBsaWNhdG9yLCBwcm90b211eCwgY2hhbm5lbCwgaW5mbGlnaHRSYW5nZSkgewogICAgdGhpcy5jb3JlID0gcmVwbGljYXRvci5jb3JlCiAgICB0aGlzLnJlcGxpY2F0b3IgPSByZXBsaWNhdG9yCiAgICB0aGlzLnN0cmVhbSA9IHByb3RvbXV4LnN0cmVhbQogICAgdGhpcy5wcm90b211eCA9IHByb3RvbXV4CiAgICB0aGlzLnJlbW90ZVB1YmxpY0tleSA9IHRoaXMuc3RyZWFtLnJlbW90ZVB1YmxpY0tleQogICAgdGhpcy5yZW1vdGVTdXBwb3J0c1NlZWtzID0gZmFsc2UKICAgIHRoaXMuaW5mbGlnaHRSYW5nZSA9IGluZmxpZ2h0UmFuZ2UKICAgIHRoaXMucmVtb3RlU2VnbWVudHNXYW50ZWQgPSBuZXcgU2V0KCkKICAgIHRoaXMuZnVsbHlEb3dubG9hZGVkU2lnbmFsZWQgPSBmYWxzZQoKICAgIHRoaXMucGF1c2VkID0gZmFsc2UKICAgIHRoaXMucmVtb3ZlZCA9IGZhbHNlCgogICAgdGhpcy5jaGFubmVsID0gY2hhbm5lbAogICAgdGhpcy5jaGFubmVsLnVzZXJEYXRhID0gdGhpcwoKICAgIHRoaXMud2lyZVN5bmMgPSB0aGlzLmNoYW5uZWwubWVzc2FnZXNbMF0KICAgIHRoaXMud2lyZVJlcXVlc3QgPSB0aGlzLmNoYW5uZWwubWVzc2FnZXNbMV0KICAgIHRoaXMud2lyZUNhbmNlbCA9IHRoaXMuY2hhbm5lbC5tZXNzYWdlc1syXQogICAgdGhpcy53aXJlRGF0YSA9IHRoaXMuY2hhbm5lbC5tZXNzYWdlc1szXQogICAgdGhpcy53aXJlTm9EYXRhID0gdGhpcy5jaGFubmVsLm1lc3NhZ2VzWzRdCiAgICB0aGlzLndpcmVXYW50ID0gdGhpcy5jaGFubmVsLm1lc3NhZ2VzWzVdCiAgICB0aGlzLndpcmVVbndhbnQgPSB0aGlzLmNoYW5uZWwubWVzc2FnZXNbNl0KICAgIHRoaXMud2lyZUJpdGZpZWxkID0gdGhpcy5jaGFubmVsLm1lc3NhZ2VzWzddCiAgICB0aGlzLndpcmVSYW5nZSA9IHRoaXMuY2hhbm5lbC5tZXNzYWdlc1s4XQogICAgdGhpcy53aXJlRXh0ZW5zaW9uID0gdGhpcy5jaGFubmVsLm1lc3NhZ2VzWzldCgogICAgLy8gU2FtZSBzdGF0cyBhcyByZXBsaWNhdG9yLCBidXQgZm9yIHRoaXMgc3BlY2lmaWMgcGVlcgogICAgdGhpcy5zdGF0cyA9IHsKICAgICAgd2lyZVN5bmM6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVSZXF1ZXN0OiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlQ2FuY2VsOiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlRGF0YTogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZVdhbnQ6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVCaXRmaWVsZDogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZVJhbmdlOiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlRXh0ZW5zaW9uOiB7IHR4OiAwLCByeDogMCB9LAogICAgICBob3Rzd2FwczogMCwKICAgICAgaW52YWxpZERhdGE6IDAsCiAgICAgIGludmFsaWRSZXF1ZXN0czogMCwKICAgICAgYmFja29mZnM6IDAKICAgIH0KCiAgICB0aGlzLnJlY2VpdmVyUXVldWUgPSBuZXcgUmVjZWl2ZXJRdWV1ZSgpCiAgICB0aGlzLnJlY2VpdmVyQnVzeSA9IGZhbHNlCgogICAgLy8gbW9zdCBvZnRlbiBub3QgdXNlZCwgc28gbWFkZSBvbiBkZW1hbmQKICAgIHRoaXMucm91bmR0cmlwUXVldWUgPSBudWxsCgogICAgdGhpcy5pbmZsaWdodCA9IDAKICAgIHRoaXMuZGF0YVByb2Nlc3NpbmcgPSAwCgogICAgdGhpcy5jYW5VcGdyYWRlID0gdHJ1ZQoKICAgIHRoaXMubmVlZHNTeW5jID0gZmFsc2UKICAgIHRoaXMuc3luY3NQcm9jZXNzaW5nID0gMAogICAgdGhpcy5sYXN0VXBncmFkYWJsZUxlbmd0aCA9IDAKICAgIHRoaXMubGFzdFVwZ3JhZGFibGVGb3JrID0gMAoKICAgIHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGggPSAwCgogICAgLy8gVE9ETzogdHdlYWsgcGlwZWxpbmluZyBzbyB0aGF0IGRhdGEgc2VudCBCRUZPUkUgcmVtb3RlT3BlbmVkIGlzIG5vdCBjYXAgdmVyaWZpZWQhCiAgICAvLyB3ZSBtaWdodCB3YW5uYSB0d2VhayB0aGF0IHdpdGggc29tZSBjcnlwdG8sIGllIHVzZSB0aGUgY2FwIHRvIGVuY3J5cHQgaXQuLi4KICAgIC8vIG9yIGp1c3QgYmUgYXdhcmUgb2YgdGhhdCwgdG8gb25seSBwdXNoIG5vbiBsZWFreSBkYXRhCgogICAgdGhpcy5yZW1vdGVPcGVuZWQgPSBmYWxzZQogICAgdGhpcy5yZW1vdGVCaXRmaWVsZCA9IG5ldyBSZW1vdGVCaXRmaWVsZCgpCiAgICB0aGlzLm1pc3NpbmdCbG9ja3MgPSBuZXcgUmVtb3RlQml0ZmllbGQoKQoKICAgIHRoaXMucHVzaGVkTGVuZ3RoID0gMAoKICAgIHRoaXMucmVtb3RlRm9yayA9IDAKICAgIHRoaXMucmVtb3RlTGVuZ3RoID0gMAogICAgdGhpcy5yZW1vdGVDYW5VcGdyYWRlID0gZmFsc2UKICAgIHRoaXMucmVtb3RlVXBsb2FkaW5nID0gdHJ1ZQogICAgdGhpcy5yZW1vdGVEb3dubG9hZGluZyA9IHRydWUKICAgIHRoaXMucmVtb3RlU3luY2VkID0gZmFsc2UKICAgIHRoaXMucmVtb3RlSGFzTWFuaWZlc3QgPSBmYWxzZQogICAgdGhpcy5yZW1vdGVBbGxvd1B1c2ggPSBmYWxzZQogICAgdGhpcy5yZW1vdGVSZXF1ZXN0cyA9IG5ldyBNYXAoKQoKICAgIHRoaXMuc2VnbWVudHNXYW50ZWQgPSBuZXcgU2V0KCkKICAgIHRoaXMuYnJvYWRjYXN0ZWROb25TcGFyc2UgPSBmYWxzZQoKICAgIHRoaXMubGVuZ3RoQWNrZWQgPSAwCgogICAgdGhpcy5leHRlbnNpb25zID0gbmV3IE1hcCgpCiAgICB0aGlzLmxhc3RFeHRlbnNpb25TZW50ID0gJycKICAgIHRoaXMubGFzdEV4dGVuc2lvblJlY3YgPSAnJwoKICAgIHJlcGxpY2F0b3IuX2lmQXZhaWxhYmxlKysKICAgIHJlcGxpY2F0b3IuX2FjdGl2ZSsrCiAgfQoKICBnZXQgcmVtb3RlQ29udGlndW91c0xlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLnJlbW90ZUJpdGZpZWxkLmZpbmRGaXJzdChmYWxzZSwgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCkKICB9CgogIGdldE1heEluZmxpZ2h0KCkgewogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0ucmF3U3RyZWFtCiAgICBpZiAoIXN0cmVhbS51ZHgpIHJldHVybiBNYXRoLm1pbih0aGlzLmluZmxpZ2h0UmFuZ2VbMV0sIHRoaXMuaW5mbGlnaHRSYW5nZVswXSAqIDMpCgogICAgY29uc3Qgc2NhbGUgPQogICAgICBzdHJlYW0ucnR0IDw9IFNDQUxFX0xBVEVOQ1kKICAgICAgICA/IDEKICAgICAgICA6IChzdHJlYW0ucnR0IC8gU0NBTEVfTEFURU5DWSkgKiBNYXRoLm1pbigxLCAyIC8gdGhpcy5yZXBsaWNhdG9yLnBlZXJzLmxlbmd0aCkKICAgIHJldHVybiBNYXRoLm1heCgKICAgICAgdGhpcy5pbmZsaWdodFJhbmdlWzBdLAogICAgICBNYXRoLnJvdW5kKE1hdGgubWluKHRoaXMuaW5mbGlnaHRSYW5nZVsxXSwgdGhpcy5pbmZsaWdodFJhbmdlWzBdICogc2NhbGUpKQogICAgKQogIH0KCiAgZ2V0TWF4SG90c3dhcEluZmxpZ2h0KCkgewogICAgY29uc3QgaW5mID0gdGhpcy5nZXRNYXhJbmZsaWdodCgpCiAgICByZXR1cm4gTWF0aC5tYXgoMTYsIGluZiAvIDIpCiAgfQoKICBzaWduYWxVcGdyYWRlKCkgewogICAgaWYgKHRoaXMuZnVsbHlEb3dubG9hZGVkU2lnbmFsZWQgJiYgIXRoaXMucmVwbGljYXRvci5mdWxseURvd25sb2FkZWQoKSkgewogICAgICB0aGlzLmZ1bGx5RG93bmxvYWRlZFNpZ25hbGVkID0gZmFsc2UKICAgIH0KICAgIGlmICh0aGlzLl9zaG91bGRVcGRhdGVDYW5VcGdyYWRlKCkgPT09IHRydWUpIHRoaXMuX3VwZGF0ZUNhblVwZ3JhZGVBbmRTeW5jKCkKICAgIGVsc2UgdGhpcy5zZW5kU3luYygpCiAgfQoKICBfbWFya0luZmxpZ2h0KGluZGV4KSB7CiAgICB0aGlzLm1pc3NpbmdCbG9ja3Muc2V0KGluZGV4LCBmYWxzZSkKICB9CgogIGJyb2FkY2FzdFJhbmdlKHN0YXJ0LCBsZW5ndGgsIGRyb3ApIHsKICAgIGlmICghdGhpcy5pc0FjdGl2ZSgpKSByZXR1cm4KCiAgICBpZiAoZHJvcCkgdGhpcy5fdW5jbGVhckxvY2FsUmFuZ2Uoc3RhcnQsIGxlbmd0aCkKICAgIGVsc2UgdGhpcy5fY2xlYXJMb2NhbFJhbmdlKHN0YXJ0LCBsZW5ndGgpCgogICAgY29uc3QgaSA9IE1hdGguZmxvb3Ioc3RhcnQgLyBERUZBVUxUX1NFR01FTlRfU0laRSkKICAgIGNvbnN0IGZ1bGx5Q29udGlnID0gdGhpcy5jb3JlLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoID09PSB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoCgogICAgaWYgKAogICAgICBzdGFydCArIExBU1RfQkxPQ0tTIDwgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCAmJgogICAgICAhdGhpcy5yZW1vdGVTZWdtZW50c1dhbnRlZC5oYXMoaSkgJiYKICAgICAgIWRyb3AgJiYKICAgICAgIWZ1bGx5Q29udGlnCiAgICApIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgbGV0IGZvcmNlID0gZmFsc2UKICAgIGlmIChmdWxseUNvbnRpZyAmJiAhZHJvcCkgewogICAgICBzdGFydCA9IDAKICAgICAgbGVuZ3RoID0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aAoKICAgICAgLy8gQWx3YXlzIHNlbmQgdGhlIGJyb2FkY2FzdCB3aGVuIHdlIHN3aXRjaCBmcm9tIHNwYXJzZSB0byBmdWxseSBjb250aWd1b3VzLCBzbyByZW1vdGUga25vd3MgdG9vCiAgICAgIGlmICghdGhpcy5mdWxseURvd25sb2FkZWRTaWduYWxlZCkgewogICAgICAgIHRoaXMuZnVsbHlEb3dubG9hZGVkU2lnbmFsZWQgPSB0cnVlCiAgICAgICAgZm9yY2UgPSB0cnVlCiAgICAgIH0KICAgIH0KCiAgICAvLyBUT0RPOiBjb25zaWRlciBhbHNvIGFkZGluZyBlYXJseS1yZXR1cm5zIG9uIHRoZSBkcm9wPT09dHJ1ZSBjYXNlCiAgICBpZiAoIWZvcmNlICYmICFkcm9wKSB7CiAgICAgIC8vIE5vIG5lZWQgdG8gYnJvYWRjYXN0IGlmIHRoZSByZW1vdGUgYWxyZWFkeSBoYXMgdGhpcyByYW5nZQoKICAgICAgaWYgKHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGggPj0gc3RhcnQgKyBsZW5ndGgpIHJldHVybgoKICAgICAgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICAgIGlmICh0aGlzLnJlbW90ZUJpdGZpZWxkLmdldChzdGFydCkpIHJldHVybgogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0aGlzLnJlbW90ZUJpdGZpZWxkLmZpcnN0VW5zZXQoc3RhcnQpID49IHN0YXJ0ICsgbGVuZ3RoKSByZXR1cm4KICAgICAgfQogICAgfQoKICAgIHRoaXMud2lyZVJhbmdlLnNlbmQoewogICAgICBkcm9wLAogICAgICBzdGFydCwKICAgICAgbGVuZ3RoCiAgICB9KQogICAgaW5jcmVtZW50VHgodGhpcy5zdGF0cy53aXJlUmFuZ2UsIHRoaXMucmVwbGljYXRvci5zdGF0cy53aXJlUmFuZ2UpCiAgfQoKICBleHRlbnNpb24obmFtZSwgbWVzc2FnZSkgewogICAgdGhpcy53aXJlRXh0ZW5zaW9uLnNlbmQoeyBuYW1lOiBuYW1lID09PSB0aGlzLmxhc3RFeHRlbnNpb25TZW50ID8gJycgOiBuYW1lLCBtZXNzYWdlIH0pCiAgICBpbmNyZW1lbnRUeCh0aGlzLnN0YXRzLndpcmVFeHRlbnNpb24sIHRoaXMucmVwbGljYXRvci5zdGF0cy53aXJlRXh0ZW5zaW9uKQogICAgdGhpcy5sYXN0RXh0ZW5zaW9uU2VudCA9IG5hbWUKICB9CgogIG9uZXh0ZW5zaW9uKG1lc3NhZ2UpIHsKICAgIGNvbnN0IG5hbWUgPSBtZXNzYWdlLm5hbWUgfHwgdGhpcy5sYXN0RXh0ZW5zaW9uUmVjdgogICAgdGhpcy5sYXN0RXh0ZW5zaW9uUmVjdiA9IG5hbWUKICAgIGNvbnN0IGV4dCA9IHRoaXMuZXh0ZW5zaW9ucy5nZXQobmFtZSkKICAgIGlmIChleHQpIHsKICAgICAgZXh0Ll9vbm1lc3NhZ2UoeyBzdGFydDogMCwgZW5kOiBtZXNzYWdlLm1lc3NhZ2UuYnl0ZUxlbmd0aCwgYnVmZmVyOiBtZXNzYWdlLm1lc3NhZ2UgfSwgdGhpcykKICAgIH0KICB9CgogIHNlbmRTeW5jKCkgewogICAgaWYgKHRoaXMuc3luY3NQcm9jZXNzaW5nICE9PSAwKSB7CiAgICAgIHRoaXMubmVlZHNTeW5jID0gdHJ1ZQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5jb3JlLnN0YXRlLmZvcmsgIT09IHRoaXMucmVtb3RlRm9yaykgewogICAgICB0aGlzLmNhblVwZ3JhZGUgPSBmYWxzZQogICAgfQoKICAgIHRoaXMubmVlZHNTeW5jID0gZmFsc2UKCiAgICB0aGlzLndpcmVTeW5jLnNlbmQoewogICAgICBmb3JrOiB0aGlzLmNvcmUuc3RhdGUuZm9yaywKICAgICAgbGVuZ3RoOiB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoLAogICAgICByZW1vdGVMZW5ndGg6IHRoaXMuY29yZS5zdGF0ZS5mb3JrID09PSB0aGlzLnJlbW90ZUZvcmsgPyB0aGlzLnJlbW90ZUxlbmd0aCA6IDAsCiAgICAgIGNhblVwZ3JhZGU6IHRoaXMuY2FuVXBncmFkZSwKICAgICAgdXBsb2FkaW5nOiB0cnVlLAogICAgICBkb3dubG9hZGluZzogdGhpcy5yZXBsaWNhdG9yLmlzRG93bmxvYWRpbmcoKSwKICAgICAgaGFzTWFuaWZlc3Q6ICEhdGhpcy5jb3JlLmhlYWRlci5tYW5pZmVzdCAmJiB0aGlzLmNvcmUuY29tcGF0ID09PSBmYWxzZSwKICAgICAgYWxsb3dQdXNoOiB0aGlzLnJlcGxpY2F0b3IuYWxsb3dQdXNoCiAgICB9KQogICAgaW5jcmVtZW50VHgodGhpcy5zdGF0cy53aXJlU3luYywgdGhpcy5yZXBsaWNhdG9yLnN0YXRzLndpcmVTeW5jKQogIH0KCiAgb25vcGVuKHsgc2Vla3MsIGNhcGFiaWxpdHkgfSkgewogICAgY29uc3QgZXhwZWN0ZWQgPSBjYXBzLnJlcGxpY2F0ZSgKICAgICAgdGhpcy5zdHJlYW0uaXNJbml0aWF0b3IgPT09IGZhbHNlLAogICAgICB0aGlzLmNvcmUua2V5LAogICAgICB0aGlzLnN0cmVhbS5oYW5kc2hha2VIYXNoCiAgICApCgogICAgaWYgKGI0YS5lcXVhbHMoY2FwYWJpbGl0eSwgZXhwZWN0ZWQpICE9PSB0cnVlKSB7CiAgICAgIC8vIFRPRE86IGNoYW5nZSB0aGlzIHRvIGEgcmVqZWN0aW9uIGluc3RlYWQsIGxlc3MgbGVha2FnZQogICAgICB0aHJvdyBJTlZBTElEX0NBUEFCSUxJVFkoJ1JlbW90ZSBzZW50IGFuIGludmFsaWQgcmVwbGljYXRpb24gY2FwYWJpbGl0eScpCiAgICB9CgogICAgaWYgKHRoaXMucmVtb3RlT3BlbmVkID09PSB0cnVlKSByZXR1cm4KICAgIHRoaXMucmVtb3RlT3BlbmVkID0gdHJ1ZQogICAgdGhpcy5yZW1vdGVTdXBwb3J0c1NlZWtzID0gc2Vla3MKCiAgICB0aGlzLnByb3RvbXV4LmNvcmsoKQoKICAgIHRoaXMuc2VuZFN5bmMoKQoKICAgIGNvbnN0IGNvbnRpZyA9IE1hdGgubWluKHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgsIHRoaXMuY29yZS5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCkKICAgIGlmIChjb250aWcgPiAwKSB7CiAgICAgIHRoaXMuYnJvYWRjYXN0UmFuZ2UoMCwgY29udGlnLCBmYWxzZSkKCiAgICAgIGlmIChjb250aWcgPT09IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpIHsKICAgICAgICB0aGlzLmJyb2FkY2FzdGVkTm9uU3BhcnNlID0gdHJ1ZQogICAgICB9CiAgICB9CgogICAgdGhpcy5yZXBsaWNhdG9yLl9pZkF2YWlsYWJsZS0tCiAgICB0aGlzLnJlcGxpY2F0b3IuX2FkZFBlZXIodGhpcykKCiAgICB0aGlzLnByb3RvbXV4LnVuY29yaygpCgogICAgdGhpcy5jb3JlLmNoZWNrSWZJZGxlKCkKICB9CgogIG9uY2xvc2UoaXNSZW1vdGUpIHsKICAgIC8vIHdlIG1pZ2h0IGhhdmUgc2lnbmFsbGVkIHRvIHRoZSByZW1vdGUgdGhhdCB3ZSBhcmUgZG9uZSAoaWUgbm90IGRvd25sb2FkaW5nKSBhbmQgdGhlIHJlbW90ZSBtaWdodCBhZ3JlZSBvbiB0aGF0CiAgICAvLyBpZiB0aGF0IGhhcHBlbnMsIHRoZSBjaGFubmVsIG1pZ2h0IGJlIGNsb3NlZCBieSB0aGUgcmVtb3RlLiBpZiBzbyBqdXN0IHJlbmVnb3RpYXRlIGl0LgogICAgLy8gVE9ETzogYWRkIGEgQ0xPU0VfUkVBU09OIHRvIG11eCB0byB3ZSBjYW4gbWFrZSB0aGlzIGNsZWFuZXIuLi4KICAgIGNvbnN0IHJlb3BlbiA9CiAgICAgIGlzUmVtb3RlID09PSB0cnVlICYmCiAgICAgIHRoaXMucmVtb3RlT3BlbmVkID09PSB0cnVlICYmCiAgICAgIHRoaXMucmVtb3RlRG93bmxvYWRpbmcgPT09IGZhbHNlICYmCiAgICAgIHRoaXMucmVtb3RlVXBsb2FkaW5nID09PSB0cnVlICYmCiAgICAgIHRoaXMucmVwbGljYXRvci5kb3dubG9hZGluZyA9PT0gdHJ1ZQoKICAgIGlmICh0aGlzLnJlbW90ZU9wZW5lZCA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5yZXBsaWNhdG9yLl9pZkF2YWlsYWJsZS0tCiAgICAgIHRoaXMucmVwbGljYXRvci51cGRhdGVBbGwoKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLnJlbW90ZU9wZW5lZCA9IGZhbHNlCiAgICB0aGlzLnJlbW92ZWQgPSB0cnVlCiAgICB0aGlzLnJlbW90ZVJlcXVlc3RzLmNsZWFyKCkgLy8gY2FuY2VsIGFsbAogICAgdGhpcy5yZWNlaXZlclF1ZXVlLmNsZWFyKCkKCiAgICBpZiAodGhpcy5yb3VuZHRyaXBRdWV1ZSAhPT0gbnVsbCkgewogICAgICBmb3IgKGNvbnN0IGlkIG9mIHRoaXMucm91bmR0cmlwUXVldWUuY2xlYXIoKSkgdGhpcy5yZXBsaWNhdG9yLl9pbmZsaWdodC5yZXVzYWJsZShpZCkKICAgIH0KCiAgICB0aGlzLnJlcGxpY2F0b3IuX3JlbW92ZVBlZXIodGhpcykKCiAgICBpZiAocmVvcGVuKSB7CiAgICAgIHRoaXMucmVwbGljYXRvci5fbWFrZVBlZXIodGhpcy5wcm90b211eCkKICAgIH0KICB9CgogIGNsb3NlSWZJZGxlKCkgewogICAgaWYgKHRoaXMucmVtb3RlRG93bmxvYWRpbmcgPT09IGZhbHNlICYmIHRoaXMucmVwbGljYXRvci5pc0Rvd25sb2FkaW5nKCkgPT09IGZhbHNlKSB7CiAgICAgIC8vIGlkbGluZywgc2h1dCBpdCBkb3duLi4uCiAgICAgIHRoaXMuY2hhbm5lbC5jbG9zZSgpCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBhc3luYyBvbnN5bmMobXNnKSB7CiAgICBjb25zdCB7CiAgICAgIGZvcmssCiAgICAgIGxlbmd0aCwKICAgICAgcmVtb3RlTGVuZ3RoLAogICAgICBjYW5VcGdyYWRlLAogICAgICB1cGxvYWRpbmcsCiAgICAgIGRvd25sb2FkaW5nLAogICAgICBoYXNNYW5pZmVzdCwKICAgICAgYWxsb3dQdXNoCiAgICB9ID0gbXNnCgogICAgY29uc3QgbGVuZ3RoQ2hhbmdlZCA9IGxlbmd0aCAhPT0gdGhpcy5yZW1vdGVMZW5ndGgKICAgIGNvbnN0IHNhbWVGb3JrID0gZm9yayA9PT0gdGhpcy5jb3JlLnN0YXRlLmZvcmsKCiAgICB0aGlzLnJlbW90ZVN5bmNlZCA9IHRydWUKICAgIHRoaXMucmVtb3RlRm9yayA9IGZvcmsKICAgIHRoaXMucmVtb3RlTGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLnJlbW90ZUNhblVwZ3JhZGUgPSBjYW5VcGdyYWRlCiAgICB0aGlzLnJlbW90ZVVwbG9hZGluZyA9IHVwbG9hZGluZwogICAgdGhpcy5yZW1vdGVEb3dubG9hZGluZyA9IGRvd25sb2FkaW5nCiAgICB0aGlzLnJlbW90ZUhhc01hbmlmZXN0ID0gaGFzTWFuaWZlc3QKICAgIHRoaXMucmVtb3RlQWxsb3dQdXNoID0gYWxsb3dQdXNoCgogICAgaWYgKHRoaXMuY2xvc2VJZklkbGUoKSkgcmV0dXJuCgogICAgdGhpcy5sZW5ndGhBY2tlZCA9IHNhbWVGb3JrID8gcmVtb3RlTGVuZ3RoIDogMAogICAgdGhpcy5zeW5jc1Byb2Nlc3NpbmcrKwoKICAgIHRoaXMucmVwbGljYXRvci5fdXBkYXRlRm9yayh0aGlzKQoKICAgIGlmICh0aGlzLnJlbW90ZUxlbmd0aCA+IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggJiYgdGhpcy5sZW5ndGhBY2tlZCA9PT0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkgewogICAgICBpZiAodGhpcy5yZXBsaWNhdG9yLl9hZGRVcGdyYWRlTWF5YmUoKSAhPT0gbnVsbCkgdGhpcy5fdXBkYXRlKCkKICAgIH0KCiAgICBjb25zdCB1cGdyYWRlID0KICAgICAgbGVuZ3RoQ2hhbmdlZCA9PT0gZmFsc2UgfHwgc2FtZUZvcmsgPT09IGZhbHNlCiAgICAgICAgPyB0aGlzLmNhblVwZ3JhZGUgJiYgc2FtZUZvcmsKICAgICAgICA6IGF3YWl0IHRoaXMuX2NhblVwZ3JhZGUobGVuZ3RoLCBmb3JrKQoKICAgIGlmIChsZW5ndGggPT09IHRoaXMucmVtb3RlTGVuZ3RoICYmIGZvcmsgPT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrKSB7CiAgICAgIHRoaXMuY2FuVXBncmFkZSA9IHVwZ3JhZGUKICAgICAgaWYgKHVwZ3JhZGUpIHsKICAgICAgICB0aGlzLmxhc3RVcGdyYWRhYmxlRm9yayA9IGZvcmsKICAgICAgICB0aGlzLmxhc3RVcGdyYWRhYmxlTGVuZ3RoID0gbGVuZ3RoCiAgICAgIH0KICAgIH0KCiAgICBpZiAoLS10aGlzLnN5bmNzUHJvY2Vzc2luZyAhPT0gMCkgcmV0dXJuIC8vIGllIG5vdCBsYXRlc3QKCiAgICBpZiAoCiAgICAgIHRoaXMubmVlZHNTeW5jID09PSB0cnVlIHx8CiAgICAgICh0aGlzLmNvcmUuc3RhdGUuZm9yayA9PT0gdGhpcy5yZW1vdGVGb3JrICYmIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggPiB0aGlzLnJlbW90ZUxlbmd0aCkKICAgICkgewogICAgICB0aGlzLnNpZ25hbFVwZ3JhZGUoKQogICAgfQoKICAgIHRoaXMuX3VwZGF0ZSgpCiAgfQoKICBfc2hvdWxkVXBkYXRlQ2FuVXBncmFkZSgpIHsKICAgIHJldHVybiAoCiAgICAgIHRoaXMuY29yZS5zdGF0ZS5mb3JrID09PSB0aGlzLnJlbW90ZUZvcmsgJiYKICAgICAgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCA+IHRoaXMucmVtb3RlTGVuZ3RoICYmCiAgICAgIHRoaXMuY2FuVXBncmFkZSA9PT0gZmFsc2UgJiYKICAgICAgdGhpcy5zeW5jc1Byb2Nlc3NpbmcgPT09IDAKICAgICkKICB9CgogIGFzeW5jIF91cGRhdGVDYW5VcGdyYWRlQW5kU3luYygpIHsKICAgIGNvbnN0IHsgbGVuZ3RoLCBmb3JrIH0gPSB0aGlzLmNvcmUuc3RhdGUKCiAgICBjb25zdCByZW1vdGVMZW5ndGggPSB0aGlzLnJlbW90ZUxlbmd0aAogICAgY29uc3QgcmVtb3RlRm9yayA9IHRoaXMucmVtb3RlRm9yawogICAgY29uc3QgY2FuVXBncmFkZSA9IGF3YWl0IHRoaXMuX2NhblVwZ3JhZGUodGhpcy5yZW1vdGVMZW5ndGgsIHRoaXMucmVtb3RlRm9yaykKCiAgICBpZiAoCiAgICAgIHRoaXMuc3luY3NQcm9jZXNzaW5nID4gMCB8fAogICAgICBsZW5ndGggIT09IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggfHwKICAgICAgZm9yayAhPT0gdGhpcy5jb3JlLnN0YXRlLmZvcmsKICAgICkgewogICAgICByZXR1cm4KICAgIH0KICAgIGlmIChyZW1vdGVMZW5ndGggIT09IHRoaXMucmVtb3RlTGVuZ3RoIHx8IHJlbW90ZUZvcmsgIT09IHRoaXMucmVtb3RlRm9yaykgewogICAgICByZXR1cm4KICAgIH0KICAgIGlmIChjYW5VcGdyYWRlID09PSB0aGlzLmNhblVwZ3JhZGUpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5jYW5VcGdyYWRlID0gY2FuVXBncmFkZQogICAgaWYgKGNhblVwZ3JhZGUpIHsKICAgICAgdGhpcy5sYXN0VXBncmFkYWJsZUxlbmd0aCA9IHRoaXMucmVtb3RlTGVuZ3RoCiAgICAgIHRoaXMubGFzdFVwZ3JhZGFibGVGb3JrID0gdGhpcy5yZW1vdGVGb3JrCiAgICB9CgogICAgdGhpcy5zZW5kU3luYygpCiAgfQoKICAvLyBTYWZlIHRvIGNhbGwgaW4gdGhlIGJhY2tncm91bmQgLSBuZXZlciBmYWlscwogIGFzeW5jIF9jYW5VcGdyYWRlKHJlbW90ZUxlbmd0aCwgcmVtb3RlRm9yaykgewogICAgaWYgKHJlbW90ZUZvcmsgIT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrKSByZXR1cm4gZmFsc2UKCiAgICBpZiAocmVtb3RlTGVuZ3RoID09PSAwKSByZXR1cm4gdHJ1ZQogICAgaWYgKHJlbW90ZUxlbmd0aCA+PSB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoKSByZXR1cm4gZmFsc2UKCiAgICB0cnkgewogICAgICAvLyBSZWx5IG9uIGNhY2hpbmcgdG8gbWFrZSBzdXJlIHRoaXMgaXMgY2hlYXAuLi4KICAgICAgY29uc3QgY2FuVXBncmFkZSA9IGF3YWl0IE1lcmtsZVRyZWUudXBncmFkZWFibGUodGhpcy5jb3JlLnN0YXRlLCByZW1vdGVMZW5ndGgpCgogICAgICBpZiAocmVtb3RlRm9yayAhPT0gdGhpcy5jb3JlLnN0YXRlLmZvcmspIHJldHVybiBmYWxzZQoKICAgICAgcmV0dXJuIGNhblVwZ3JhZGUKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICB9CgogIGFzeW5jIF9nZXRQcm9vZihiYXRjaCwgbXNnLCBwdXNoaW5nKSB7CiAgICBsZXQgYmxvY2sgPSBudWxsCgogICAgaWYgKG1zZy5ibG9jaykgewogICAgICBjb25zdCBpbmRleCA9IG1zZy5ibG9jay5pbmRleAoKICAgICAgaWYgKCFwdXNoaW5nICYmIChtc2cuZm9yayAhPT0gdGhpcy5jb3JlLnN0YXRlLmZvcmsgfHwgIXRoaXMuY29yZS5iaXRmaWVsZC5nZXQoaW5kZXgpKSkgewogICAgICAgIHJldHVybiBuZXcgUHJvb2ZSZXF1ZXN0KG1zZywgbnVsbCwgbnVsbCwgbnVsbCkKICAgICAgfQoKICAgICAgYmxvY2sgPSBiYXRjaC5nZXRCbG9jayhpbmRleCkKICAgICAgYmxvY2suY2F0Y2gobm9vcCkKICAgIH0KCiAgICBjb25zdCBtYW5pZmVzdCA9IG1zZy5tYW5pZmVzdCAmJiAhdGhpcy5jb3JlLmNvbXBhdCA/IHRoaXMuY29yZS5oZWFkZXIubWFuaWZlc3QgOiBudWxsCgogICAgdHJ5IHsKICAgICAgY29uc3QgcHJvb2YgPSBhd2FpdCBNZXJrbGVUcmVlLnByb29mKHRoaXMuY29yZS5zdGF0ZSwgYmF0Y2gsIG1zZykKICAgICAgcmV0dXJuIG5ldyBQcm9vZlJlcXVlc3QobXNnLCBwcm9vZiwgYmxvY2ssIG1hbmlmZXN0KQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGJhdGNoLmRlc3Ryb3koKQoKICAgICAgdGhpcy5yZXBsaWNhdG9yLl9vbmludmFsaWRyZXF1ZXN0KGVyciwgbXNnLCB0aGlzKQoKICAgICAgaWYgKHRoaXMuc3RhdHMuaW52YWxpZFJlcXVlc3RzID49IE1BWF9JTlZBTElEX1JFUVVFU1RTKSB0aHJvdyBlcnIKCiAgICAgIGF3YWl0IGJhY2tvZmYodGhpcy5zdGF0cy5pbnZhbGlkUmVxdWVzdHMpCiAgICAgIHJldHVybiBudWxsCiAgICB9CiAgfQoKICBhc3luYyBvbnJlcXVlc3QobXNnKSB7CiAgICBjb25zdCBzaXplID0gdGhpcy5yZW1vdGVSZXF1ZXN0cy5zaXplCiAgICB0aGlzLnJlbW90ZVJlcXVlc3RzLnNldChtc2cuaWQsIG1zZykKCiAgICAvLyBpZiBzaXplIGRpZG50IGNoYW5nZSAtPiBpZCBvdmVyd3JpdGUgLT4gb2xkIG9uZSBpcyBkZWxldGVkLCBjYW5jZWwgY3VycmVudCBhbmQgcmUtYWRkCiAgICBpZiAoc2l6ZSA9PT0gdGhpcy5yZW1vdGVSZXF1ZXN0cy5zaXplKSB7CiAgICAgIHRoaXMuX2NhbmNlbChtc2cuaWQpCiAgICAgIHRoaXMucmVtb3RlUmVxdWVzdHMuc2V0KG1zZy5pZCwgbXNnKQogICAgfQoKICAgIGlmICghdGhpcy5wcm90b211eC5kcmFpbmVkIHx8IHRoaXMucmVjZWl2ZXJRdWV1ZS5sZW5ndGgpIHsKICAgICAgdGhpcy5yZWNlaXZlclF1ZXVlLnB1c2gobXNnKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5yZXBsaWNhdG9yLmRlc3Ryb3llZCkgcmV0dXJuCgogICAgYXdhaXQgdGhpcy5faGFuZGxlUmVxdWVzdChtc2cpCiAgfQoKICBvbmNhbmNlbChtc2cpIHsKICAgIHRoaXMuX2NhbmNlbChtc2cucmVxdWVzdCkKICB9CgogIF9jYW5jZWwoaWQpIHsKICAgIHRoaXMucmVtb3RlUmVxdWVzdHMuZGVsZXRlKGlkKQogICAgdGhpcy5yZWNlaXZlclF1ZXVlLmRlbGV0ZShpZCkKICB9CgogIG9uZHJhaW4oKSB7CiAgICByZXR1cm4gdGhpcy5faGFuZGxlUmVxdWVzdHMoKQogIH0KCiAgYXN5bmMgX2hhbmRsZVJlcXVlc3RzKCkgewogICAgaWYgKHRoaXMucmVjZWl2ZXJCdXN5IHx8IHRoaXMucmVwbGljYXRvci5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5yZWNlaXZlckJ1c3kgPSB0cnVlCiAgICB0aGlzLnByb3RvbXV4LmNvcmsoKQoKICAgIHdoaWxlICgKICAgICAgdGhpcy5yZW1vdGVPcGVuZWQgJiYKICAgICAgdGhpcy5wcm90b211eC5kcmFpbmVkICYmCiAgICAgIHRoaXMucmVjZWl2ZXJRdWV1ZS5sZW5ndGggPiAwICYmCiAgICAgICF0aGlzLnJlbW92ZWQKICAgICkgewogICAgICBjb25zdCBtc2cgPSB0aGlzLnJlY2VpdmVyUXVldWUuc2hpZnQoKQogICAgICBhd2FpdCB0aGlzLl9oYW5kbGVSZXF1ZXN0KG1zZykKICAgIH0KCiAgICB0aGlzLnByb3RvbXV4LnVuY29yaygpCiAgICB0aGlzLnJlY2VpdmVyQnVzeSA9IGZhbHNlCiAgfQoKICBhc3luYyBwdXNoKGluZGV4KSB7CiAgICBpZiAoIXRoaXMucmVtb3RlQWxsb3dQdXNoKSByZXR1cm4KICAgIGlmICh0aGlzLmNvcmUuc3RhdGUuZm9yayAhPT0gdGhpcy5yZW1vdGVGb3JrKSByZXR1cm4KICAgIGlmICh0aGlzLnJlbW90ZUJpdGZpZWxkLmdldChpbmRleCkpIHJldHVybgoKICAgIGNvbnN0IG1zZyA9IHsKICAgICAgaWQ6IDAsCiAgICAgIGZvcms6IHRoaXMuY29yZS5zdGF0ZS5mb3JrLAogICAgICBibG9jazogbnVsbCwKICAgICAgaGFzaDogbnVsbCwKICAgICAgc2VlazogbnVsbCwKICAgICAgdXBncmFkZTogbnVsbCwKICAgICAgbWFuaWZlc3Q6IHRoaXMucmVtb3RlTGVuZ3RoID09PSAwLAogICAgICBwcmlvcml0eTogMAogICAgfQoKICAgIGNvbnN0IHJlbW90ZUxlbmd0aCA9IE1hdGgubWF4KHRoaXMucmVtb3RlTGVuZ3RoLCB0aGlzLnB1c2hlZExlbmd0aCkKCiAgICBtc2cuYmxvY2sgPSB7CiAgICAgIGluZGV4LAogICAgICBub2RlczogTWVya2xlVHJlZS5tYXhNaXNzaW5nTm9kZXMoMiAqIGluZGV4LCByZW1vdGVMZW5ndGgpCiAgICB9CgogICAgaWYgKGluZGV4ID49IHRoaXMucmVtb3RlTGVuZ3RoKSB7CiAgICAgIG1zZy51cGdyYWRlID0gewogICAgICAgIHN0YXJ0OiByZW1vdGVMZW5ndGgsCiAgICAgICAgbGVuZ3RoOiB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoIC0gcmVtb3RlTGVuZ3RoCiAgICAgIH0KICAgIH0KCiAgICBsZXQgcmVxID0gbnVsbAogICAgY29uc3QgYmF0Y2ggPSB0aGlzLmNvcmUuc3RvcmFnZS5yZWFkKCkKICAgIHRyeSB7CiAgICAgIHJlcSA9IGF3YWl0IHRoaXMuX2dldFByb29mKGJhdGNoLCBtc2csIHRydWUpCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHJlcSA9PT0gbnVsbCkgcmV0dXJuCiAgICBiYXRjaC50cnlGbHVzaCgpCgogICAgYXdhaXQgdGhpcy5fZnVsZmlsbFJlcXVlc3QocmVxLCB0cnVlKQogIH0KCiAgYXN5bmMgX2hhbmRsZVJlcXVlc3QobXNnKSB7CiAgICBjb25zdCBiYXRjaCA9IHRoaXMuY29yZS5zdG9yYWdlLnJlYWQoKQoKICAgIC8vIFRPRE86IGNvdWxkIHN0aWxsIGJlIGFuc3dlcmFibGUgaWYgKGluZGV4LCBmb3JrKSBpcyBhbiBhbmNlc3RvciBvZiB0aGUgY3VycmVudCBmb3JrCiAgICBjb25zdCByZXEgPQogICAgICBtc2cuZm9yayA9PT0gdGhpcy5jb3JlLnN0YXRlLmZvcmsKICAgICAgICA/IGF3YWl0IHRoaXMuX2dldFByb29mKGJhdGNoLCBtc2csIGZhbHNlKQogICAgICAgIDogbmV3IFByb29mUmVxdWVzdChtc2csIG51bGwsIG51bGwsIG51bGwpCgogICAgaWYgKHJlcSA9PT0gbnVsbCkgewogICAgICB0aGlzLndpcmVOb0RhdGEuc2VuZCh7IHJlcXVlc3Q6IG1zZy5pZCwgcmVhc29uOiBJTlZBTElEX1JFUVVFU1QgfSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgYmF0Y2gudHJ5Rmx1c2goKQoKICAgIGF3YWl0IHRoaXMuX2Z1bGZpbGxSZXF1ZXN0KHJlcSwgZmFsc2UpCiAgfQoKICBhc3luYyBfZnVsZmlsbFJlcXVlc3QocmVxLCBwdXNoaW5nKSB7CiAgICBjb25zdCBwcm9vZiA9IGF3YWl0IHJlcS5mdWxmaWxsKCkKCiAgICBpZiAoIXB1c2hpbmcpIHsKICAgICAgLy8gaWYgY2FuY2VsbGVkIGRvIG5vdCByZXBseQogICAgICBpZiAodGhpcy5yZW1vdGVSZXF1ZXN0cy5nZXQocmVxLm1zZy5pZCkgIT09IHJlcS5tc2cpIHsKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgLy8gc3luYyBmcm9tIG5vdyBvbiwgc28gc2FmZSB0byBkZWxldGUgZnJvbSB0aGUgbWFwCiAgICAgIHRoaXMucmVtb3RlUmVxdWVzdHMuZGVsZXRlKHJlcS5tc2cuaWQpCiAgICB9IGVsc2UgaWYgKCF0aGlzLnJlbW90ZUFsbG93UHVzaCkgewogICAgICAvLyBpZiBwdXNoaW5nIGJ1dCByZW1vdGUgZGlzYWJsZWQgaXQsIGp1c3QgZHJvcCBpdAogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoIXRoaXMuaXNBY3RpdmUoKSAmJiBwcm9vZi5ibG9jayAhPT0gbnVsbCkgewogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAocHJvb2YgPT09IG51bGwpIHsKICAgICAgaWYgKHJlcS5tc2cubWFuaWZlc3QgJiYgdGhpcy5jb3JlLmhlYWRlci5tYW5pZmVzdCkgewogICAgICAgIGNvbnN0IG1hbmlmZXN0ID0gdGhpcy5jb3JlLmhlYWRlci5tYW5pZmVzdAogICAgICAgIHRoaXMud2lyZURhdGEuc2VuZCh7CiAgICAgICAgICByZXF1ZXN0OiByZXEubXNnLmlkLAogICAgICAgICAgZm9yazogdGhpcy5jb3JlLnN0YXRlLmZvcmssCiAgICAgICAgICBibG9jazogbnVsbCwKICAgICAgICAgIGhhc2g6IG51bGwsCiAgICAgICAgICBzZWVrOiBudWxsLAogICAgICAgICAgdXBncmFkZTogbnVsbCwKICAgICAgICAgIG1hbmlmZXN0CiAgICAgICAgfSkKICAgICAgICBpbmNyZW1lbnRUeCh0aGlzLnN0YXRzLndpcmVEYXRhLCB0aGlzLnJlcGxpY2F0b3Iuc3RhdHMud2lyZURhdGEpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIHRoaXMud2lyZU5vRGF0YS5zZW5kKHsgcmVxdWVzdDogcmVxLm1zZy5pZCwgcmVhc29uOiBOT1RfQVZBSUxBQkxFIH0pCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChwcm9vZi5ibG9jayAhPT0gbnVsbCkgewogICAgICB0aGlzLnJlcGxpY2F0b3IuX29udXBsb2FkKHByb29mLmJsb2NrLmluZGV4LCBwcm9vZi5ibG9jay52YWx1ZS5ieXRlTGVuZ3RoLCB0aGlzKQogICAgfQoKICAgIGlmIChwcm9vZi51cGdyYWRlKSB7CiAgICAgIGNvbnN0IHJlbW90ZUxlbmd0aCA9IHByb29mLnVwZ3JhZGUuc3RhcnQgKyBwcm9vZi51cGdyYWRlLmxlbmd0aAogICAgICBpZiAocmVtb3RlTGVuZ3RoID4gdGhpcy5wdXNoZWRMZW5ndGgpIHRoaXMucHVzaGVkTGVuZ3RoID0gcmVtb3RlTGVuZ3RoCiAgICB9CgogICAgdGhpcy53aXJlRGF0YS5zZW5kKHsKICAgICAgcmVxdWVzdDogcmVxLm1zZy5pZCwKICAgICAgZm9yazogcmVxLm1zZy5mb3JrLAogICAgICBibG9jazogcHJvb2YuYmxvY2ssCiAgICAgIGhhc2g6IHByb29mLmhhc2gsCiAgICAgIHNlZWs6IHByb29mLnNlZWssCiAgICAgIHVwZ3JhZGU6IHByb29mLnVwZ3JhZGUsCiAgICAgIG1hbmlmZXN0OiBwcm9vZi5tYW5pZmVzdAogICAgfSkKICAgIGluY3JlbWVudFR4KHRoaXMuc3RhdHMud2lyZURhdGEsIHRoaXMucmVwbGljYXRvci5zdGF0cy53aXJlRGF0YSkKICB9CgogIF9jYW5jZWxSZXF1ZXN0KHJlcSkgewogICAgaWYgKHJlcS5wcmlvcml0eSA9PT0gUFJJT1JJVFkuQ0FOQ0VMTEVEKSByZXR1cm4KICAgIC8vIG1hcmsgYXMgY2FuY2VsbGVkIGFsc28gYW5kIGF2b2lkIHJlLWVudHJ5CiAgICByZXEucHJpb3JpdHkgPSBQUklPUklUWS5DQU5DRUxMRUQKCiAgICB0aGlzLmluZmxpZ2h0LS0KICAgIHRoaXMucmVwbGljYXRvci5fcmVxdWVzdERvbmUocmVxLmlkLCBmYWxzZSkKCiAgICAvLyBjbGVhciBpbmZsaWdodCBzdGF0ZQogICAgaWYgKGlzQmxvY2tSZXF1ZXN0KHJlcSkpIHRoaXMucmVwbGljYXRvci5fdW5tYXJrSW5mbGlnaHQocmVxLmJsb2NrLmluZGV4KQogICAgaWYgKGlzVXBncmFkZVJlcXVlc3QocmVxKSkgdGhpcy5yZXBsaWNhdG9yLl9jbGVhckluZmxpZ2h0VXBncmFkZShyZXEpCgogICAgaWYgKHRoaXMucm91bmR0cmlwUXVldWUgPT09IG51bGwpIHRoaXMucm91bmR0cmlwUXVldWUgPSBuZXcgUm91bmR0cmlwUXVldWUoKQogICAgdGhpcy5yb3VuZHRyaXBRdWV1ZS5hZGQocmVxLmlkKQogICAgdGhpcy53aXJlQ2FuY2VsLnNlbmQoeyByZXF1ZXN0OiByZXEuaWQgfSkKICAgIGluY3JlbWVudFR4KHRoaXMuc3RhdHMud2lyZUNhbmNlbCwgdGhpcy5yZXBsaWNhdG9yLnN0YXRzLndpcmVDYW5jZWwpCiAgfQoKICBfY2hlY2tJZkNvbmZsaWN0KCkgewogICAgdGhpcy5wYXVzZWQgPSB0cnVlCgogICAgY29uc3QgbGVuZ3RoID0gTWF0aC5taW4odGhpcy5jb3JlLnN0YXRlLmxlbmd0aCwgdGhpcy5yZW1vdGVMZW5ndGgpCiAgICBpZiAobGVuZ3RoID09PSAwKSByZXR1cm4gLy8gcGF1c2UgYW5kIGlnbm9yZQoKICAgIHRoaXMud2lyZVJlcXVlc3Quc2VuZCh7CiAgICAgIGlkOiAwLCAvLyBUT0RPOiB1c2UgYW4gbW9yZSBleHBsaWNpdCBpZCBmb3IgdGhpcyBldmVudHVhbGx5Li4uCiAgICAgIGZvcms6IHRoaXMucmVtb3RlRm9yaywKICAgICAgYmxvY2s6IG51bGwsCiAgICAgIGhhc2g6IG51bGwsCiAgICAgIHNlZWs6IG51bGwsCiAgICAgIHVwZ3JhZGU6IHsKICAgICAgICBzdGFydDogMCwKICAgICAgICBsZW5ndGgKICAgICAgfQogICAgfSkKCiAgICBpbmNyZW1lbnRUeCh0aGlzLnN0YXRzLndpcmVSZXF1ZXN0LCB0aGlzLnJlcGxpY2F0b3Iuc3RhdHMud2lyZVJlcXVlc3QpCiAgfQoKICBfdW5tYXJrSW5mbGlnaHRCbG9ja1JlcXVlc3QocmVxLCBkYXRhKSB7CiAgICBpZiAoaXNCbG9ja1JlcXVlc3QocmVxKSkgdGhpcy5yZXBsaWNhdG9yLl91bm1hcmtJbmZsaWdodChyZXEuYmxvY2suaW5kZXgpCiAgICBlbHNlIGlmIChkYXRhLmJsb2NrICYmICFyZXEpIHRoaXMucmVwbGljYXRvci5fdW5tYXJrSW5mbGlnaHQoZGF0YS5ibG9jay5pbmRleCkKICB9CgogIGFzeW5jIG9uZGF0YShkYXRhKSB7CiAgICBpZiAoZGF0YS5yZXF1ZXN0ICE9PSAwKSByZXR1cm4gdGhpcy5faGFuZGxlRGF0YShkYXRhKQoKICAgIGF3YWl0IHRoaXMucmVwbGljYXRvci5fcHVzaExvY2subG9jaygpCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9oYW5kbGVEYXRhKGRhdGEpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLnJlcGxpY2F0b3IuX3B1c2hMb2NrLnVubG9jaygpCiAgICB9CiAgfQoKICBhc3luYyBfaGFuZGxlRGF0YShkYXRhKSB7CiAgICAvLyBhbHdheXMgYWxsb3cgYSBmb3JrIGNvbmZsaWN0IHByb29mIHRvIGJlIHNlbnQKICAgIGlmIChkYXRhLnJlcXVlc3QgPT09IDAgJiYgZGF0YS51cGdyYWRlICYmIGRhdGEudXBncmFkZS5zdGFydCA9PT0gMCkgewogICAgICBpZiAoYXdhaXQgdGhpcy5jb3JlLmNoZWNrQ29uZmxpY3QoZGF0YSwgdGhpcykpIHJldHVybgogICAgICB0aGlzLnBhdXNlZCA9IGZhbHNlCiAgICB9CgogICAgY29uc3QgcmVxID0gZGF0YS5yZXF1ZXN0ID4gMCA/IHRoaXMucmVwbGljYXRvci5faW5mbGlnaHQuZ2V0KGRhdGEucmVxdWVzdCkgOiBudWxsCiAgICBjb25zdCByZW9yZyA9IGRhdGEuZm9yayA+IHRoaXMuY29yZS5zdGF0ZS5mb3JrCgogICAgLy8gbm8gcHVzaCBhdG0sIFRPRE86IGNoZWNrIGlmIHRoaXMgc2F0aXNmaWVzIGFub3RoZXIgcGVuZGluZyByZXF1ZXN0CiAgICAvLyBhbGxvdyByZW9yZyBwdXNoZXMgdGhvIGFzIHRob3NlIGFyZSBub3Qgd3JpdHRlbiB0byBzdG9yYWdlIHNvIHdlJ2xsIHRha2UgYWxsIHRoZSBoZWxwIHdlIGNhbiBnZXQKICAgIGlmIChyZXEgPT09IG51bGwgJiYgcmVvcmcgPT09IGZhbHNlICYmICF0aGlzLnJlcGxpY2F0b3IuYWxsb3dQdXNoKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChyZXEgPT09IG51bGwgJiYgcmVvcmcgPT09IGZhbHNlICYmIGRhdGEuYmxvY2spIHsKICAgICAgLy8gbWFyayB0aGlzIGFzIGluZmxpZ2h0IHRvIGF2b2lkIHBhcmFsbGVsIHJlcXVlc3RzCiAgICAgIHRoaXMucmVwbGljYXRvci5fbWFya0luZmxpZ2h0KGRhdGEuYmxvY2suaW5kZXgpCiAgICB9CgogICAgaWYgKHJlcSAhPT0gbnVsbCkgewogICAgICBpZiAocmVxLnBlZXIgIT09IHRoaXMpIHJldHVybgogICAgICB0aGlzLl9vbnJlcXVlc3Ryb3VuZHRyaXAocmVxKQogICAgfQoKICAgIHRyeSB7CiAgICAgIGlmIChyZW9yZyA9PT0gdHJ1ZSkgcmV0dXJuIGF3YWl0IHRoaXMucmVwbGljYXRvci5fb25yZW9yZ2RhdGEodGhpcywgcmVxLCBkYXRhKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgICAgdGhpcy5fdW5tYXJrSW5mbGlnaHRCbG9ja1JlcXVlc3QocmVxLCBkYXRhKQoKICAgICAgdGhpcy5wYXVzZWQgPSB0cnVlCiAgICAgIHRoaXMucmVwbGljYXRvci5fb25pbnZhbGlkZGF0YShlcnIsIHJlcSwgZGF0YSwgdGhpcykKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5kYXRhUHJvY2Vzc2luZysrCiAgICBpZiAoaXNCbG9ja1JlcXVlc3QocmVxKSkgdGhpcy5yZXBsaWNhdG9yLl9tYXJrUHJvY2Vzc2luZyhyZXEuYmxvY2suaW5kZXgpCgogICAgdHJ5IHsKICAgICAgaWYgKCF0aGlzLnJlcGxpY2F0b3IuX21hdGNoaW5nUmVxdWVzdChyZXEsIGRhdGEpIHx8ICEoYXdhaXQgdGhpcy5jb3JlLnZlcmlmeShkYXRhLCB0aGlzKSkpIHsKICAgICAgICB0aGlzLnJlcGxpY2F0b3IuX29ubm9kYXRhKHRoaXMsIHJlcSwgMCkKICAgICAgICByZXR1cm4KICAgICAgfQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgICAgdGhpcy5fdW5tYXJrSW5mbGlnaHRCbG9ja1JlcXVlc3QocmVxLCBkYXRhKQoKICAgICAgaWYgKGVyci5jb2RlID09PSAnV1JJVEVfRkFJTEVEJykgewogICAgICAgIC8vIEZvciBleGFtcGxlLCB3ZSBkb24ndCB3YW50IHRvIGtlZXAgcHVsbGluZyBkYXRhIHdoZW4gc3RvcmFnZSBpcyBmdWxsCiAgICAgICAgLy8gVE9ETzogbm90aWZ5IHRoZSB1c2VyIHNvbWVob3cKICAgICAgICB0aGlzLnBhdXNlZCA9IHRydWUKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgaWYgKHRoaXMuY29yZS5jbG9zZWQgJiYgIWlzQ3JpdGljYWxFcnJvcihlcnIpKSByZXR1cm4KCiAgICAgIGlmIChlcnIuY29kZSAhPT0gJ0lOVkFMSURfT1BFUkFUSU9OJykgewogICAgICAgIC8vIG1pZ2h0IGJlIGEgZm9yaywgdmVyaWZ5CiAgICAgICAgdGhpcy5fY2hlY2tJZkNvbmZsaWN0KCkKICAgICAgfQoKICAgICAgLy8gaWYgcHVzaCBtb2RlLCB3ZSBNSUdIVCBnZXQgYW4gb2NjYXNpb25hbCBiYWQgbWVzc2FnZQogICAgICAvLyBubyBuZWVkIHRvIG1lZ2EgYmFpbCBmb3IgdGhhdC4gVE9ETzogcmF0ZSBsaW1pdCBpbnN0ZWFkIGFzIGEgZ2VuZXJhbCB0aGluZwogICAgICBpZiAoIXRoaXMucmVwbGljYXRvci5hbGxvd1B1c2gpIHsKICAgICAgICB0aGlzLnBhdXNlZCA9IHRydWUKICAgICAgfQoKICAgICAgdGhpcy5yZXBsaWNhdG9yLl9vbm5vZGF0YSh0aGlzLCByZXEsIDApCiAgICAgIHRoaXMucmVwbGljYXRvci5fb25pbnZhbGlkZGF0YShlcnIsIHJlcSwgZGF0YSwgdGhpcykKICAgICAgcmV0dXJuCiAgICB9IGZpbmFsbHkgewogICAgICBpZiAoaXNCbG9ja1JlcXVlc3QocmVxKSkgdGhpcy5yZXBsaWNhdG9yLl9tYXJrUHJvY2Vzc2VkKHJlcS5ibG9jay5pbmRleCkKICAgICAgdGhpcy5kYXRhUHJvY2Vzc2luZy0tCiAgICB9CgogICAgdGhpcy5yZXBsaWNhdG9yLl9vbmRhdGEodGhpcywgcmVxLCBkYXRhKQoKICAgIGlmICh0aGlzLl9zaG91bGRVcGRhdGVDYW5VcGdyYWRlKCkgPT09IHRydWUpIHsKICAgICAgdGhpcy5fdXBkYXRlQ2FuVXBncmFkZUFuZFN5bmMoKQogICAgfQogIH0KCiAgb25ub2RhdGEoeyByZXF1ZXN0LCByZWFzb24gfSkgewogICAgY29uc3QgcmVxID0gcmVxdWVzdCA+IDAgPyB0aGlzLnJlcGxpY2F0b3IuX2luZmxpZ2h0LmdldChyZXF1ZXN0KSA6IG51bGwKCiAgICBpZiAocmVxID09PSBudWxsIHx8IHJlcS5wZWVyICE9PSB0aGlzKSB7CiAgICAgIHRoaXMucmVwbGljYXRvci51cGRhdGVBbGwoKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLl9vbnJlcXVlc3Ryb3VuZHRyaXAocmVxKQogICAgdGhpcy5yZXBsaWNhdG9yLl9vbm5vZGF0YSh0aGlzLCByZXEsIHJlYXNvbikKICB9CgogIF9vbnJlcXVlc3Ryb3VuZHRyaXAocmVxKSB7CiAgICBpZiAocmVxLnByaW9yaXR5ID09PSBQUklPUklUWS5DQU5DRUxMRUQpIHJldHVybgogICAgLy8gdG8gYXZvaWQgcmUtZW50cnkgd2UgYWxzbyBqdXN0IG1hcmsgaXQgYXMgY2FuY2VsbGVkCiAgICByZXEucHJpb3JpdHkgPSBQUklPUklUWS5DQU5DRUxMRUQKCiAgICB0aGlzLmluZmxpZ2h0LS0KICAgIHRoaXMucmVwbGljYXRvci5fcmVxdWVzdERvbmUocmVxLmlkLCB0cnVlKQogICAgaWYgKHRoaXMucm91bmR0cmlwUXVldWUgPT09IG51bGwpIHJldHVybgogICAgY29uc3QgZmx1c2hlZCA9IHRoaXMucm91bmR0cmlwUXVldWUuZmx1c2gocmVxLnJ0KQogICAgaWYgKGZsdXNoZWQgPT09IG51bGwpIHJldHVybgogICAgZm9yIChjb25zdCBpZCBvZiBmbHVzaGVkKSB0aGlzLnJlcGxpY2F0b3IuX2luZmxpZ2h0LnJldXNhYmxlKGlkKQogIH0KCiAgb253YW50KHsgc3RhcnQsIGxlbmd0aCB9KSB7CiAgICBjb25zdCBpID0gTWF0aC5mbG9vcihzdGFydCAvIERFRkFVTFRfU0VHTUVOVF9TSVpFKQogICAgaWYgKHRoaXMucmVtb3RlU2VnbWVudHNXYW50ZWQuc2l6ZSA+PSBNQVhfUkVNT1RFX1NFR01FTlRTKSB0aGlzLnJlbW90ZVNlZ21lbnRzV2FudGVkLmNsZWFyKCkgLy8ganVzdCBpbiBjYXNlIG9mIGFidXNlCiAgICB0aGlzLnJlbW90ZVNlZ21lbnRzV2FudGVkLmFkZChpKQogICAgdGhpcy5yZXBsaWNhdG9yLl9vbndhbnQodGhpcywgc3RhcnQsIGxlbmd0aCkKICB9CgogIG9udW53YW50KCkgewogICAgLy8gVE9ETwogIH0KCiAgb25iaXRmaWVsZCh7IHN0YXJ0LCBiaXRmaWVsZCB9KSB7CiAgICBpZiAoc3RhcnQgPCB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoKSB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoID0gc3RhcnQgLy8gYml0ZmllbGQgaXMgYWx3YXlzIHRoZSB0cnV0aAogICAgdGhpcy5yZW1vdGVCaXRmaWVsZC5pbnNlcnQoc3RhcnQsIGJpdGZpZWxkKQogICAgdGhpcy5taXNzaW5nQmxvY2tzLmluc2VydChzdGFydCwgYml0ZmllbGQpCiAgICB0aGlzLl9jbGVhckxvY2FsUmFuZ2Uoc3RhcnQsIGJpdGZpZWxkLmJ5dGVMZW5ndGggKiA4KQogICAgdGhpcy5fdXBkYXRlKCkKICB9CgogIF9jbGVhckxvY2FsUmFuZ2Uoc3RhcnQsIGxlbmd0aCkgewogICAgY29uc3QgYml0ZmllbGQgPSB0aGlzLmNvcmUuc2tpcEJpdGZpZWxkID09PSBudWxsID8gdGhpcy5jb3JlLmJpdGZpZWxkIDogdGhpcy5jb3JlLnNraXBCaXRmaWVsZAoKICAgIGlmIChsZW5ndGggPT09IDEpIHsKICAgICAgdGhpcy5taXNzaW5nQmxvY2tzLnNldChzdGFydCwgdGhpcy5fcmVtb3RlSGFzQmxvY2soc3RhcnQpICYmICFiaXRmaWVsZC5nZXQoc3RhcnQpKQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBjb250aWcgPSBNYXRoLm1pbih0aGlzLmNvcmUuc3RhdGUubGVuZ3RoLCB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgpCgogICAgaWYgKHN0YXJ0ICsgbGVuZ3RoIDwgY29udGlnKSB7CiAgICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5zZXRSYW5nZShzdGFydCwgY29udGlnLCBmYWxzZSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgcmVtID0gc3RhcnQgJiAzMjc2NwogICAgaWYgKHJlbSA+IDApIHsKICAgICAgc3RhcnQgLT0gcmVtCiAgICAgIGxlbmd0aCArPSByZW0KICAgIH0KCiAgICBjb25zdCBlbmQgPSBzdGFydCArIE1hdGgubWluKGxlbmd0aCwgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkKICAgIHdoaWxlIChzdGFydCA8IGVuZCkgewogICAgICBjb25zdCBsb2NhbCA9IGJpdGZpZWxkLmdldEJpdGZpZWxkKHN0YXJ0KQoKICAgICAgaWYgKGxvY2FsICYmIGxvY2FsLmJpdGZpZWxkKSB7CiAgICAgICAgdGhpcy5taXNzaW5nQmxvY2tzLmNsZWFyKHN0YXJ0LCBsb2NhbC5iaXRmaWVsZCkKICAgICAgfQoKICAgICAgc3RhcnQgKz0gMzI3NjgKICAgIH0KICB9CgogIF9yZXNldE1pc3NpbmdCbG9jayhpbmRleCkgewogICAgY29uc3QgYml0ZmllbGQgPSB0aGlzLmNvcmUuc2tpcEJpdGZpZWxkID09PSBudWxsID8gdGhpcy5jb3JlLmJpdGZpZWxkIDogdGhpcy5jb3JlLnNraXBCaXRmaWVsZAogICAgdGhpcy5taXNzaW5nQmxvY2tzLnNldChpbmRleCwgdGhpcy5fcmVtb3RlSGFzQmxvY2soaW5kZXgpICYmICFiaXRmaWVsZC5nZXQoaW5kZXgpKQogIH0KCiAgX3VuY2xlYXJMb2NhbFJhbmdlKHN0YXJ0LCBsZW5ndGgpIHsKICAgIGlmIChsZW5ndGggPT09IDEpIHsKICAgICAgdGhpcy5fcmVzZXRNaXNzaW5nQmxvY2soc3RhcnQpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IHJlbSA9IHN0YXJ0ICYgMjA5NzE1MQogICAgaWYgKHJlbSA+IDApIHsKICAgICAgc3RhcnQgLT0gcmVtCiAgICAgIGxlbmd0aCArPSByZW0KICAgIH0KCiAgICBjb25zdCBmaXhlZFN0YXJ0ID0gc3RhcnQKCiAgICBjb25zdCBlbmQgPSBzdGFydCArIE1hdGgubWluKGxlbmd0aCwgdGhpcy5yZW1vdGVMZW5ndGgpCiAgICB3aGlsZSAoc3RhcnQgPCBlbmQpIHsKICAgICAgY29uc3QgcmVtb3RlID0gdGhpcy5yZW1vdGVCaXRmaWVsZC5nZXRCaXRmaWVsZChzdGFydCkKICAgICAgaWYgKHJlbW90ZSAmJiByZW1vdGUuYml0ZmllbGQpIHsKICAgICAgICB0aGlzLm1pc3NpbmdCbG9ja3MuaW5zZXJ0KHN0YXJ0LCByZW1vdGUuYml0ZmllbGQpCiAgICAgIH0KCiAgICAgIHN0YXJ0ICs9IDIwOTcxNTIKICAgIH0KCiAgICB0aGlzLl9jbGVhckxvY2FsUmFuZ2UoZml4ZWRTdGFydCwgbGVuZ3RoKQogIH0KCiAgYXN5bmMgb25yYW5nZSh7IGRyb3AsIHN0YXJ0LCBsZW5ndGggfSkgewogICAgY29uc3QgaGFzID0gZHJvcCA9PT0gZmFsc2UKCiAgICBpZiAoZHJvcCA9PT0gdHJ1ZSAmJiBzdGFydCA8IHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpIHsKICAgICAgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCA9IHN0YXJ0CiAgICB9CgogICAgaWYgKHN0YXJ0ID09PSAwICYmIGRyb3AgPT09IGZhbHNlKSB7CiAgICAgIGlmIChsZW5ndGggPiB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoKSB7CiAgICAgICAgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCA9IGxlbmd0aAogICAgICAgIGlmICgKICAgICAgICAgIHRoaXMucmVtb3RlRm9yayA9PT0gdGhpcy5jb3JlLnN0YXRlLmZvcmsgJiYKICAgICAgICAgIGxlbmd0aCA+IHRoaXMuY29yZS5oZWFkZXIuaGludHMucmVtb3RlQ29udGlndW91c0xlbmd0aAogICAgICAgICkgewogICAgICAgICAgdGhpcy5jb3JlLnVwZGF0ZVJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgobGVuZ3RoKQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChsZW5ndGggPT09IDEpIHsKICAgICAgY29uc3QgYml0ZmllbGQgPSB0aGlzLmNvcmUuc2tpcEJpdGZpZWxkID09PSBudWxsID8gdGhpcy5jb3JlLmJpdGZpZWxkIDogdGhpcy5jb3JlLnNraXBCaXRmaWVsZAogICAgICB0aGlzLnJlbW90ZUJpdGZpZWxkLnNldChzdGFydCwgaGFzKQogICAgICB0aGlzLm1pc3NpbmdCbG9ja3Muc2V0KHN0YXJ0LCBoYXMgJiYgIWJpdGZpZWxkLmdldChzdGFydCkpCiAgICB9IGVsc2UgewogICAgICBjb25zdCByYW5nZVN0YXJ0ID0gdGhpcy5yZW1vdGVCaXRmaWVsZC5maW5kRmlyc3QoIWhhcywgc3RhcnQpCiAgICAgIGNvbnN0IHJhbmdlRW5kID0gbGVuZ3RoICsgc3RhcnQKCiAgICAgIGlmIChyYW5nZVN0YXJ0ICE9PSAtMSAmJiByYW5nZVN0YXJ0IDwgcmFuZ2VFbmQpIHsKICAgICAgICB0aGlzLnJlbW90ZUJpdGZpZWxkLnNldFJhbmdlKHJhbmdlU3RhcnQsIHJhbmdlRW5kLCBoYXMpCiAgICAgICAgdGhpcy5taXNzaW5nQmxvY2tzLnNldFJhbmdlKHJhbmdlU3RhcnQsIHJhbmdlRW5kLCBoYXMpCiAgICAgICAgaWYgKGhhcykgdGhpcy5fY2xlYXJMb2NhbFJhbmdlKHJhbmdlU3RhcnQsIHJhbmdlRW5kIC0gcmFuZ2VTdGFydCkKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLmNvcmUuaGludHNDaGFuZ2VkKSBhd2FpdCB0aGlzLmNvcmUuZmx1c2hIaW50cygpCiAgICBpZiAoZHJvcCA9PT0gZmFsc2UpIHRoaXMuX3VwZGF0ZSgpCiAgfQoKICBvbnJlb3JnaGludCgpIHsKICAgIC8vIFRPRE8KICB9CgogIF91cGRhdGUoKSB7CiAgICAvLyBUT0RPOiBpZiB0aGlzIGlzIGluIGEgYmF0Y2ggb3Igc2ltaWxhciBpdCB3b3VsZCBiZSBiZXR0ZXIgdG8gZGVmZXIgaXQKICAgIC8vIHdlIGNvdWxkIGRvIHRoYXQgd2l0aCBuZXh0VGljay9taWNyb3RpY2sgbWI/IChjb21iaW5lZCB3aXRoIGEgcHJvcGVydHkgb24gdGhlIHNlc3Npb24gdG8gc2lnbmFsIHJlYWQgYnVmZmVyIG1iKQogICAgdGhpcy5yZXBsaWNhdG9yLnVwZGF0ZVBlZXIodGhpcykKICB9CgogIGFzeW5jIF9vbmNvbmZsaWN0KCkgewogICAgdGhpcy5wcm90b211eC5jb3JrKCkKICAgIGlmICh0aGlzLnJlbW90ZUxlbmd0aCA+IDAgJiYgdGhpcy5jb3JlLnN0YXRlLmZvcmsgPT09IHRoaXMucmVtb3RlRm9yaykgewogICAgICBhd2FpdCB0aGlzLm9ucmVxdWVzdCh7CiAgICAgICAgaWQ6IDAsCiAgICAgICAgZm9yazogdGhpcy5jb3JlLnN0YXRlLmZvcmssCiAgICAgICAgYmxvY2s6IG51bGwsCiAgICAgICAgaGFzaDogbnVsbCwKICAgICAgICBzZWVrOiBudWxsLAogICAgICAgIHVwZ3JhZGU6IHsKICAgICAgICAgIHN0YXJ0OiAwLAogICAgICAgICAgbGVuZ3RoOiBNYXRoLm1pbih0aGlzLmNvcmUuc3RhdGUubGVuZ3RoLCB0aGlzLnJlbW90ZUxlbmd0aCkKICAgICAgICB9CiAgICAgIH0pCiAgICB9CiAgICB0aGlzLmNoYW5uZWwuY2xvc2UoKQogICAgdGhpcy5wcm90b211eC51bmNvcmsoKQogIH0KCiAgX21ha2VSZXF1ZXN0KG5lZWRzVXBncmFkZSwgcHJpb3JpdHksIG1pbkxlbmd0aCkgewogICAgaWYgKG5lZWRzVXBncmFkZSA9PT0gdHJ1ZSAmJiB0aGlzLnJlcGxpY2F0b3IuX3Nob3VsZFVwZ3JhZGUodGhpcykgPT09IGZhbHNlKSB7CiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgLy8gZW5zdXJlIHRoYXQgdGhlIHJlbW90ZSBoYXMgc2lnbmFsbGVkIHRoZXkgaGF2ZSB0aGUgbGVuZ3RoIHdlIHJlcXVlc3QKICAgIGlmICh0aGlzLnJlbW90ZUxlbmd0aCA8IG1pbkxlbmd0aCkgewogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGlmIChuZWVkc1VwZ3JhZGUgPT09IGZhbHNlICYmIHRoaXMucmVwbGljYXRvci5fYXV0b1VwZ3JhZGUodGhpcykgPT09IHRydWUpIHsKICAgICAgbmVlZHNVcGdyYWRlID0gdHJ1ZQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIHBlZXI6IHRoaXMsCiAgICAgIHJ0OiB0aGlzLnJvdW5kdHJpcFF1ZXVlID09PSBudWxsID8gMCA6IHRoaXMucm91bmR0cmlwUXVldWUudGljaywKICAgICAgaWQ6IDAsCiAgICAgIGZvcms6IHRoaXMucmVtb3RlRm9yaywKICAgICAgYmxvY2s6IG51bGwsCiAgICAgIGhhc2g6IG51bGwsCiAgICAgIHNlZWs6IG51bGwsCiAgICAgIHVwZ3JhZGU6CiAgICAgICAgbmVlZHNVcGdyYWRlID09PSBmYWxzZQogICAgICAgICAgPyBudWxsCiAgICAgICAgICA6IHsgc3RhcnQ6IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgsIGxlbmd0aDogdGhpcy5yZW1vdGVMZW5ndGggLSB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoIH0sCiAgICAgIC8vIHJlbW90ZSBtYW5pZmVzdCBjaGVjayBjYW4gYmUgcmVtb3ZlZCBldmVudHVhbGx5Li4uCiAgICAgIG1hbmlmZXN0OiB0aGlzLmNvcmUuaGVhZGVyLm1hbmlmZXN0ID09PSBudWxsICYmIHRoaXMucmVtb3RlSGFzTWFuaWZlc3QgPT09IHRydWUsCiAgICAgIHByaW9yaXR5LAogICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgIGVsYXBzZWQ6IDAKICAgIH0KICB9CgogIF9yZXF1ZXN0TWFuaWZlc3QoKSB7CiAgICBjb25zdCByZXEgPSB0aGlzLl9tYWtlUmVxdWVzdChmYWxzZSwgMCwgMCkKICAgIHRoaXMuX3NlbmQocmVxKQogIH0KCiAgX2luY2x1ZGVMYXN0QmxvY2soKSB7CiAgICBpZiAodGhpcy5yZXBsaWNhdG9yLl9hbHdheXNMYXRlc3RCbG9jayA9PT0gMCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBpbmRleCA9IHRoaXMucmVtb3RlTGVuZ3RoIC0gMQoKICAgIC8vIG9ubHkgdmFsaWQgaWYgaXRzIGFuIE9PQiBnZXQKICAgIGlmIChpbmRleCA8IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpIHJldHVybiBudWxsCgogICAgLy8gZG8gdGhlIG5vcm1hbCBjaGVja3MKICAgIGlmICghdGhpcy5fcmVtb3RlSGFzQmxvY2soaW5kZXgpKSByZXR1cm4gbnVsbAogICAgaWYgKCF0aGlzLl9jYW5SZXF1ZXN0KGluZGV4KSkgcmV0dXJuIG51bGwKCiAgICAvLyBhdG0gd2Ugb25seSBldmVyIGRvIG9uZSB1cGdyYWRlIHJlcXVlc3QgaW4gcGFyYWxsZWwsIGlmIHRoYXQgY2hhbmdlcwogICAgLy8gdGhlbiB3ZSBzaG91bGQgYWRkIHNvbWUgY2hlY2sgaGVyZSBmb3IgaW5mbGlnaHRzIHRvIGF2b2lkIG92ZXIgcmVxdWVzdGluZwogICAgY29uc3QgYiA9IHRoaXMucmVwbGljYXRvci5fYmxvY2tzLmFkZChpbmRleCwgUFJJT1JJVFkuTk9STUFMKQogICAgcmV0dXJuIGIKICB9CgogIF9yZXF1ZXN0VXBncmFkZSh1KSB7CiAgICBjb25zdCByZXEgPSB0aGlzLl9tYWtlUmVxdWVzdCh0cnVlLCAwLCAwKQogICAgaWYgKHJlcSA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgYiA9IHRoaXMuX2luY2x1ZGVMYXN0QmxvY2soKQoKICAgIGlmIChiKSB0aGlzLl9zZW5kQmxvY2tSZXF1ZXN0KHJlcSwgYikKICAgIGVsc2UgdGhpcy5fc2VuZChyZXEpCgogICAgcmV0dXJuIHRydWUKICB9CgogIF9yZXF1ZXN0U2VlayhzKSB7CiAgICAvLyBpZiByZXBsaWNhdG9yIGlzIHVwZGF0aW5nIHRoZSBzZWVrcyBldGMsIGJhaWwgYW5kIHdhaXQgZm9yIGl0IHRvIGRyYWluCiAgICBpZiAodGhpcy5yZXBsaWNhdG9yLl91cGRhdGVzUGVuZGluZyA+IDApIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IHsgbGVuZ3RoLCBmb3JrIH0gPSB0aGlzLmNvcmUuc3RhdGUKCiAgICBpZiAoZm9yayAhPT0gdGhpcy5yZW1vdGVGb3JrKSByZXR1cm4gZmFsc2UKCiAgICBpZiAocy5zZWVrZXIuc3RhcnQgPj0gbGVuZ3RoKSB7CiAgICAgIGNvbnN0IHJlcSA9IHRoaXMuX21ha2VSZXF1ZXN0KHRydWUsIDAsIDApCgogICAgICAvLyBXZSBuZWVkIGFuIHVwZ3JhZGUgZm9yIHRoZSBzZWVrLCBpZiBub24gY2FuIGJlIHByb3ZpZGVkLCBza2lwCiAgICAgIGlmIChyZXEgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgICAgcmVxLnNlZWsgPSB0aGlzLnJlbW90ZVN1cHBvcnRzU2Vla3MKICAgICAgICA/IHsgYnl0ZXM6IHMuc2Vla2VyLmJ5dGVzLCBwYWRkaW5nOiBzLnNlZWtlci5wYWRkaW5nIH0KICAgICAgICA6IG51bGwKCiAgICAgIHMuaW5mbGlnaHQucHVzaChyZXEpCiAgICAgIHRoaXMuX3NlbmQocmVxKQoKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBjb25zdCBsZW4gPSBzLnNlZWtlci5lbmQgLSBzLnNlZWtlci5zdGFydAogICAgY29uc3Qgb2ZmID0gcy5zZWVrZXIuc3RhcnQgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBsZW4pCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICBsZXQgaW5kZXggPSBvZmYgKyBpCiAgICAgIGlmIChpbmRleCA+IHMuc2Vla2VyLmVuZCkgaW5kZXggLT0gbGVuCgogICAgICBpZiAodGhpcy5fcmVtb3RlSGFzQmxvY2soaW5kZXgpID09PSBmYWxzZSkgY29udGludWUKICAgICAgaWYgKHRoaXMuY29yZS5iaXRmaWVsZC5nZXQoaW5kZXgpID09PSB0cnVlKSBjb250aW51ZQogICAgICBpZiAoIXRoaXMuX2NhblJlcXVlc3QoaW5kZXgpKSBjb250aW51ZQoKICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBibG9jayBpcyBjdXJyZW50bHkgaW5mbGlnaHQgLSBpZiBzbyBwaWNrIGFub3RoZXIKICAgICAgY29uc3QgYiA9IHRoaXMucmVwbGljYXRvci5fYmxvY2tzLmdldChpbmRleCkKICAgICAgaWYgKGIgIT09IG51bGwgJiYgYi5pbmZsaWdodC5sZW5ndGggPiAwKSBjb250aW51ZQoKICAgICAgLy8gQmxvY2sgaXMgbm90IGluZmxpZ2h0LCBidXQgd2Ugb25seSB3YW50IHRoZSBoYXNoLCBjaGVjayBpZiB0aGF0IGlzIGluZmxpZ2h0CiAgICAgIGNvbnN0IGggPSB0aGlzLnJlcGxpY2F0b3IuX2hhc2hlcy5hZGQoaW5kZXgsIFBSSU9SSVRZLk5PUk1BTCkKICAgICAgaWYgKGguaW5mbGlnaHQubGVuZ3RoID4gMCkgY29udGludWUKCiAgICAgIGNvbnN0IHJlcSA9IHRoaXMuX21ha2VSZXF1ZXN0KGZhbHNlLCBoLnByaW9yaXR5LCBpbmRleCArIDEpCiAgICAgIGlmIChyZXEgPT09IG51bGwpIGNvbnRpbnVlCgogICAgICBjb25zdCBub2RlcyA9IGZsYXRUcmVlLmRlcHRoKHMuc2Vla2VyLnN0YXJ0ICsgcy5zZWVrZXIuZW5kIC0gMSkKCiAgICAgIHJlcS5oYXNoID0geyBpbmRleDogMiAqIGluZGV4LCBub2RlcyB9CiAgICAgIHJlcS5zZWVrID0gdGhpcy5yZW1vdGVTdXBwb3J0c1NlZWtzCiAgICAgICAgPyB7IGJ5dGVzOiBzLnNlZWtlci5ieXRlcywgcGFkZGluZzogcy5zZWVrZXIucGFkZGluZyB9CiAgICAgICAgOiBudWxsCgogICAgICBzLmluZmxpZ2h0LnB1c2gocmVxKQogICAgICBoLmluZmxpZ2h0LnB1c2gocmVxKQogICAgICB0aGlzLl9zZW5kKHJlcSkKCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgdGhpcy5fbWF5YmVXYW50KHMuc2Vla2VyLnN0YXJ0LCBsZW4pCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF9jYW5SZXF1ZXN0KGluZGV4KSB7CiAgICBpZiAoIShpbmRleCA+PSAwKSkgdGhyb3cgQVNTRVJUSU9OKCdiYWQgaW5kZXggdG8gX2NhblJlcXVlc3Q6ICcgKyBpbmRleCkKCiAgICBpZiAodGhpcy5yZW1vdGVMZW5ndGggPj0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkgewogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGlmIChpbmRleCA8IHRoaXMubGFzdFVwZ3JhZGFibGVMZW5ndGggJiYgdGhpcy5sYXN0VXBncmFkYWJsZUZvcmsgPT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrKSB7CiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgaWYgKHRoaXMuY2FuVXBncmFkZSAmJiB0aGlzLnN5bmNzUHJvY2Vzc2luZyA9PT0gMCkgewogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX3JlbW90ZUhhc0Jsb2NrKGluZGV4KSB7CiAgICByZXR1cm4gaW5kZXggPCB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoIHx8IHRoaXMucmVtb3RlQml0ZmllbGQuZ2V0KGluZGV4KSA9PT0gdHJ1ZQogIH0KCiAgX3NlbmRCbG9ja1JlcXVlc3QocmVxLCBiKSB7CiAgICByZXEuYmxvY2sgPSB7IGluZGV4OiBiLmluZGV4LCBub2RlczogMCB9CiAgICB0aGlzLnJlcGxpY2F0b3IuX21hcmtJbmZsaWdodChiLmluZGV4KQoKICAgIGIuaW5mbGlnaHQucHVzaChyZXEpCiAgICB0aGlzLnJlcGxpY2F0b3IuaG90c3dhcHMuYWRkKGIpCiAgICB0aGlzLl9zZW5kKHJlcSkKICB9CgogIF9yZXF1ZXN0QmxvY2soYikgewogICAgY29uc3QgeyBsZW5ndGgsIGZvcmsgfSA9IHRoaXMuY29yZS5zdGF0ZQoKICAgIGlmICh0aGlzLl9yZW1vdGVIYXNCbG9jayhiLmluZGV4KSA9PT0gZmFsc2UgfHwgZm9yayAhPT0gdGhpcy5yZW1vdGVGb3JrKSB7CiAgICAgIHRoaXMuX21heWJlV2FudChiLmluZGV4KQogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBpZiAoIXRoaXMuX2NhblJlcXVlc3QoYi5pbmRleCkpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IHJlcSA9IHRoaXMuX21ha2VSZXF1ZXN0KGIuaW5kZXggPj0gbGVuZ3RoLCBiLnByaW9yaXR5LCBiLmluZGV4ICsgMSkKICAgIGlmIChyZXEgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIHRoaXMuX3NlbmRCbG9ja1JlcXVlc3QocmVxLCBiKQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfcmVxdWVzdFJhbmdlQmxvY2soaW5kZXgsIGxlbmd0aCkgewogICAgaWYgKHRoaXMuY29yZS5iaXRmaWVsZC5nZXQoaW5kZXgpID09PSB0cnVlIHx8ICF0aGlzLl9jYW5SZXF1ZXN0KGluZGV4KSkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgYiA9IHRoaXMucmVwbGljYXRvci5fYmxvY2tzLmFkZChpbmRleCwgUFJJT1JJVFkuTk9STUFMKQogICAgaWYgKGIuaW5mbGlnaHQubGVuZ3RoID4gMCkgewogICAgICB0aGlzLm1pc3NpbmdCbG9ja3Muc2V0KGluZGV4LCBmYWxzZSkgLy8gaW4gY2FzZSB3ZSBtaXNzZWQgc29tZSBzdGF0ZXMganVzdCBzZXQgdGhlbSBvbmRlbWFuZCwgbmJkCiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnN0IHJlcSA9IHRoaXMuX21ha2VSZXF1ZXN0KGluZGV4ID49IGxlbmd0aCwgYi5wcmlvcml0eSwgaW5kZXggKyAxKQoKICAgIC8vIElmIHRoZSByZXF1ZXN0IGNhbm5vdCBiZSBzYXRpc2ZpZWQsIGRlYWxsb2MgdGhlIGJsb2NrIHJlcXVlc3QgaWYgbm8gb25lIGlzIHN1YnNjcmliZWQgdG8gaXQKICAgIGlmIChyZXEgPT09IG51bGwpIHsKICAgICAgYi5nYygpCiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIHRoaXMuX3NlbmRCbG9ja1JlcXVlc3QocmVxLCBiKQoKICAgIC8vIERvbid0IHRoaW5rIHRoaXMgd2lsbCBldmVyIGhhcHBlbiwgYXMgdGhlIHBlbmRpbmcgcXVldWUgaXMgZHJhaW5lZCBiZWZvcmUgdGhlIHJhbmdlIHF1ZXVlCiAgICAvLyBidXQgZG9lc24ndCBodXJ0IHRvIGNoZWNrIHRoaXMgZXhwbGljaXRseSBoZXJlIGFsc28uCiAgICBpZiAoYi5xdWV1ZWQpIGIucXVldWVkID0gZmFsc2UKICAgIHJldHVybiB0cnVlCiAgfQoKICBfZmluZE5leHQoaSkgewogICAgaWYgKGkgPCB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoKSB7CiAgICAgIGlmICh0aGlzLmNvcmUuc2tpcEJpdGZpZWxkID09PSBudWxsKSB0aGlzLnJlcGxpY2F0b3IuX29wZW5Ta2lwQml0ZmllbGQoKQogICAgICBpID0gdGhpcy5jb3JlLnNraXBCaXRmaWVsZC5maW5kRmlyc3QoZmFsc2UsIGkpCiAgICAgIGlmIChpIDwgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCAmJiBpID4gLTEpIHJldHVybiBpCiAgICAgIGkgPSB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoCiAgICB9CgogICAgcmV0dXJuIHRoaXMubWlzc2luZ0Jsb2Nrcy5maW5kRmlyc3QodHJ1ZSwgaSkKICB9CgogIF9yZXF1ZXN0UmFuZ2UocikgewogICAgaWYgKHRoaXMuc3luY3NQcm9jZXNzaW5nID4gMCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgeyBsZW5ndGgsIGZvcmsgfSA9IHRoaXMuY29yZS5zdGF0ZQoKICAgIGlmIChyLmJsb2NrcykgewogICAgICBsZXQgbWluID0gLTEKICAgICAgbGV0IG1heCA9IC0xCgogICAgICBmb3IgKGxldCBpID0gci5zdGFydDsgaSA8IHIuZW5kOyBpKyspIHsKICAgICAgICBjb25zdCBpbmRleCA9IHIuYmxvY2tzW2ldCiAgICAgICAgaWYgKG1pbiA9PT0gLTEgfHwgaW5kZXggPCBtaW4pIG1pbiA9IGluZGV4CiAgICAgICAgaWYgKG1heCA9PT0gLTEgfHwgaW5kZXggPiBtYXgpIG1heCA9IGluZGV4CiAgICAgICAgY29uc3QgaGFzID0gaW5kZXggPCB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoIHx8IHRoaXMubWlzc2luZ0Jsb2Nrcy5nZXQoaW5kZXgpID09PSB0cnVlCiAgICAgICAgaWYgKGhhcyA9PT0gdHJ1ZSAmJiB0aGlzLl9yZXF1ZXN0UmFuZ2VCbG9jayhpbmRleCwgbGVuZ3RoKSkgcmV0dXJuIHRydWUKICAgICAgfQoKICAgICAgaWYgKG1pbiA+IC0xKSB0aGlzLl9tYXliZVdhbnQobWluLCBtYXggLSBtaW4pCiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIC8vIGlmIHdlIGNhbiB1cGdyYWRlIHRoZSByZW1vdGUsIG9yIHRoZSByZW1vdGUgaXMgYWhlYWQsIHRoZW4gYWxsIHRoZSByZW1vdGVzIGJsb2NrcyBhcmUgdmFsaWQKICAgIC8vIG90aGVyd2lzZSB0cnVuY2F0ZSB0byB0aGUgbGFzdCBsZW5ndGggdGhlIHJlbW90ZSBoYXMgYWNrZWQgZm9yIHVzCiAgICBjb25zdCBtYXhMb2NhbExlbmd0aCA9CiAgICAgIHRoaXMuY2FuVXBncmFkZSB8fCB0aGlzLnJlbW90ZUxlbmd0aCA+PSB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoCiAgICAgICAgPyB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoCiAgICAgICAgOiBmb3JrID09PSB0aGlzLmxhc3RVcGdyYWRhYmxlRm9yawogICAgICAgICAgPyBNYXRoLm1pbih0aGlzLmxhc3RVcGdyYWRhYmxlTGVuZ3RoLCB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoKQogICAgICAgICAgOiAwCgogICAgY29uc3QgZW5kID0gTWF0aC5taW4oCiAgICAgIG1heExvY2FsTGVuZ3RoLAogICAgICBNYXRoLm1pbihyLmVuZCA9PT0gLTEgPyB0aGlzLnJlbW90ZUxlbmd0aCA6IHIuZW5kLCB0aGlzLnJlbW90ZUxlbmd0aCkKICAgICkKICAgIGlmIChlbmQgPD0gci5zdGFydCB8fCBmb3JrICE9PSB0aGlzLnJlbW90ZUZvcmspIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGxlbiA9IGVuZCAtIHIuc3RhcnQKICAgIGNvbnN0IG9mZiA9IHIuc3RhcnQgKyAoci5saW5lYXIgPyAwIDogTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbGVuKSkKCiAgICBsZXQgaSA9IG9mZgogICAgLy8gc2hvdWxkIGJlIHdheSBsZXNzIHRoYW4gdGhpcywgYnV0IHRoaXMgaXMgd29yc3QgY2FzZSB1cHBlciBib3VuZCBmb3IgdGhlIHNraXBsaXN0CiAgICBsZXQgdHJpZXMgPSB0aGlzLmluZmxpZ2h0CgogICAgZG8gewogICAgICBpID0gdGhpcy5fZmluZE5leHQoaSkKICAgICAgaWYgKGkgPT09IC0xIHx8IGkgPj0gZW5kKSBicmVhawoKICAgICAgaWYgKHRoaXMuX3JlcXVlc3RSYW5nZUJsb2NrKGksIGxlbmd0aCkpIHJldHVybiB0cnVlCiAgICAgIGkrKwogICAgfSB3aGlsZSAodHJpZXMtLSA+IDApCgogICAgaSA9IHIuc3RhcnQKCiAgICBkbyB7CiAgICAgIGkgPSB0aGlzLl9maW5kTmV4dChpKQogICAgICBpZiAoaSA9PT0gLTEgfHwgaSA+PSBvZmYpIGJyZWFrCgogICAgICBpZiAodGhpcy5fcmVxdWVzdFJhbmdlQmxvY2soaSwgbGVuZ3RoKSkgcmV0dXJuIHRydWUKICAgICAgaSsrCiAgICB9IHdoaWxlICh0cmllcy0tID4gMCkKCiAgICB0aGlzLl9tYXliZVdhbnQoci5zdGFydCwgbGVuKQogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBfcmVxdWVzdEZvcmtQcm9vZihmKSB7CiAgICBpZiAoIXRoaXMucmVtb3RlTGVuZ3RoKSByZXR1cm4KCiAgICBjb25zdCByZXEgPSB0aGlzLl9tYWtlUmVxdWVzdChmYWxzZSwgMCwgMCkKCiAgICByZXEudXBncmFkZSA9IHsgc3RhcnQ6IDAsIGxlbmd0aDogdGhpcy5yZW1vdGVMZW5ndGggfQogICAgcmVxLm1hbmlmZXN0ID0gIXRoaXMuY29yZS5oZWFkZXIubWFuaWZlc3QKCiAgICBmLmluZmxpZ2h0LnB1c2gocmVxKQogICAgdGhpcy5fc2VuZChyZXEpCiAgfQoKICBfcmVxdWVzdEZvcmtSYW5nZShmKSB7CiAgICBpZiAoZi5mb3JrICE9PSB0aGlzLnJlbW90ZUZvcmsgfHwgZi5iYXRjaC53YW50ID09PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBlbmQgPSBNYXRoLm1pbihmLmJhdGNoLndhbnQuZW5kLCB0aGlzLnJlbW90ZUxlbmd0aCkKICAgIGlmIChlbmQgPCBmLmJhdGNoLndhbnQuc3RhcnQpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGxlbiA9IGVuZCAtIGYuYmF0Y2gud2FudC5zdGFydAogICAgY29uc3Qgb2ZmID0gZi5iYXRjaC53YW50LnN0YXJ0ICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbGVuKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgbGV0IGluZGV4ID0gb2ZmICsgaQogICAgICBpZiAoaW5kZXggPj0gZW5kKSBpbmRleCAtPSBsZW4KCiAgICAgIGlmICh0aGlzLl9yZW1vdGVIYXNCbG9jayhpbmRleCkgPT09IGZhbHNlKSBjb250aW51ZQoKICAgICAgY29uc3QgcmVxID0gdGhpcy5fbWFrZVJlcXVlc3QoZmFsc2UsIDAsIDApCgogICAgICByZXEuaGFzaCA9IHsgaW5kZXg6IDIgKiBpbmRleCwgbm9kZXM6IGYuYmF0Y2gud2FudC5ub2RlcyB9CgogICAgICBmLmluZmxpZ2h0LnB1c2gocmVxKQogICAgICB0aGlzLl9zZW5kKHJlcSkKCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgdGhpcy5fbWF5YmVXYW50KGYuYmF0Y2gud2FudC5zdGFydCwgbGVuKQogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBfbWF5YmVXYW50KHN0YXJ0LCBsZW5ndGggPSAxKSB7CiAgICBpZiAoc3RhcnQgKyBsZW5ndGggPD0gdGhpcy5yZW1vdGVDb250aWd1b3VzTGVuZ3RoKSByZXR1cm4KCiAgICBsZXQgaSA9IE1hdGguZmxvb3Ioc3RhcnQgLyBERUZBVUxUX1NFR01FTlRfU0laRSkKICAgIGNvbnN0IG4gPSBNYXRoLmNlaWwoKHN0YXJ0ICsgbGVuZ3RoKSAvIERFRkFVTFRfU0VHTUVOVF9TSVpFKQoKICAgIGZvciAoOyBpIDwgbjsgaSsrKSB7CiAgICAgIGlmICh0aGlzLnNlZ21lbnRzV2FudGVkLmhhcyhpKSkgY29udGludWUKICAgICAgdGhpcy5zZWdtZW50c1dhbnRlZC5hZGQoaSkKCiAgICAgIHRoaXMud2lyZVdhbnQuc2VuZCh7CiAgICAgICAgc3RhcnQ6IGkgKiBERUZBVUxUX1NFR01FTlRfU0laRSwKICAgICAgICBsZW5ndGg6IERFRkFVTFRfU0VHTUVOVF9TSVpFCiAgICAgIH0pCiAgICAgIGluY3JlbWVudFR4KHRoaXMuc3RhdHMud2lyZVdhbnQsIHRoaXMucmVwbGljYXRvci5zdGF0cy53aXJlV2FudCkKICAgIH0KICB9CgogIGlzQWN0aXZlKCkgewogICAgaWYgKHRoaXMucGF1c2VkIHx8IHRoaXMucmVtb3ZlZCB8fCB0aGlzLmNvcmUuaGVhZGVyLmZyb3plbikgcmV0dXJuIGZhbHNlCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgX3NlbmQocmVxKSB7CiAgICBjb25zdCBmb3JrID0gdGhpcy5jb3JlLnN0YXRlLmZvcmsKCiAgICB0aGlzLmluZmxpZ2h0KysKICAgIHRoaXMucmVwbGljYXRvci5faW5mbGlnaHQuYWRkKHJlcSkKCiAgICBpZiAocmVxLnVwZ3JhZGUgIT09IG51bGwgJiYgcmVxLmZvcmsgPT09IGZvcmspIHsKICAgICAgY29uc3QgdSA9IHRoaXMucmVwbGljYXRvci5fYWRkVXBncmFkZSgpCiAgICAgIHUuaW5mbGlnaHQucHVzaChyZXEpCiAgICB9CgogICAgdHJ5IHsKICAgICAgaWYgKHJlcS5ibG9jayAhPT0gbnVsbCAmJiByZXEuZm9yayA9PT0gZm9yaykgewogICAgICAgIHJlcS5ibG9jay5ub2RlcyA9IGF3YWl0IE1lcmtsZVRyZWUubWlzc2luZ05vZGVzKAogICAgICAgICAgdGhpcy5jb3JlLnN0YXRlLAogICAgICAgICAgMiAqIHJlcS5ibG9jay5pbmRleCwKICAgICAgICAgIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgKICAgICAgICApCiAgICAgICAgaWYgKHJlcS5wcmlvcml0eSA9PT0gUFJJT1JJVFkuQ0FOQ0VMTEVEKSByZXR1cm4KICAgICAgfQogICAgICBpZiAocmVxLmhhc2ggIT09IG51bGwgJiYgcmVxLmZvcmsgPT09IGZvcmsgJiYgcmVxLmhhc2gubm9kZXMgPT09IDApIHsKICAgICAgICByZXEuaGFzaC5ub2RlcyA9IGF3YWl0IE1lcmtsZVRyZWUubWlzc2luZ05vZGVzKAogICAgICAgICAgdGhpcy5jb3JlLnN0YXRlLAogICAgICAgICAgcmVxLmhhc2guaW5kZXgsCiAgICAgICAgICB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoCiAgICAgICAgKQogICAgICAgIGlmIChyZXEucHJpb3JpdHkgPT09IFBSSU9SSVRZLkNBTkNFTExFRCkgcmV0dXJuCgogICAgICAgIC8vIG5vZGVzID09PSAwLCB3ZSBhbHJlYWR5IGhhdmUgaXQsIGJhaWwKICAgICAgICBpZiAocmVxLmhhc2gubm9kZXMgPT09IDAgJiYgKHJlcS5oYXNoLmluZGV4ICYgMSkgPT09IDApIHsKICAgICAgICAgIHRoaXMuaW5mbGlnaHQtLQogICAgICAgICAgdGhpcy5yZXBsaWNhdG9yLl9yZXNvbHZlSGFzaExvY2FsbHkodGhpcywgcmVxKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICB9CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5zdHJlYW0uZGVzdHJveShlcnIpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMud2lyZVJlcXVlc3Quc2VuZChyZXEpCiAgICBpbmNyZW1lbnRUeCh0aGlzLnN0YXRzLndpcmVSZXF1ZXN0LCB0aGlzLnJlcGxpY2F0b3Iuc3RhdHMud2lyZVJlcXVlc3QpCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJlcGxpY2F0b3IgewogIHN0YXRpYyBQZWVyID0gUGVlciAvLyBoYWNrIHRvIGJlIGFibGUgdG8gYWNjZXNzIFBlZXIgZnJvbSBvdXRzaWRlIHRoaXMgbW9kdWxlCgogIGNvbnN0cnVjdG9yKAogICAgY29yZSwKICAgIHsKICAgICAgbm90RG93bmxvYWRpbmdMaW5nZXIgPSBOT1RfRE9XTkxPQURJTkdfU0xBQ0ssCiAgICAgIGVhZ2VyVXBncmFkZSA9IHRydWUsCiAgICAgIGFsbG93Rm9yayA9IHRydWUsCiAgICAgIGFsbG93UHVzaCA9IGZhbHNlLAogICAgICBhbHdheXNMYXRlc3RCbG9jayA9IGZhbHNlLAogICAgICBpbmZsaWdodFJhbmdlID0gbnVsbAogICAgfSA9IHt9CiAgKSB7CiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICB0aGlzLmVhZ2VyVXBncmFkZSA9IGVhZ2VyVXBncmFkZQogICAgdGhpcy5hbGxvd0ZvcmsgPSBhbGxvd0ZvcmsKICAgIHRoaXMuYWxsb3dQdXNoID0gYWxsb3dQdXNoCiAgICB0aGlzLm9uZG93bmxvYWRpbmcgPSBudWxsIC8vIG9wdGlvbmFsIGV4dGVybmFsIGhvb2sgZm9yIG1vbml0b3JpbmcgZG93bmxvYWRpbmcgc3RhdHVzCiAgICB0aGlzLnBlZXJzID0gW10KICAgIHRoaXMuZmluZGluZ1BlZXJzID0gMCAvLyB1cGRhdGFibGUgZnJvbSB0aGUgb3V0c2lkZQogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5kb3dubG9hZGluZyA9IGZhbHNlCiAgICB0aGlzLmFjdGl2ZVNlc3Npb25zID0gMAoKICAgIHRoaXMuaG90c3dhcHMgPSBuZXcgSG90c3dhcFF1ZXVlKCkKICAgIHRoaXMuaW5mbGlnaHRSYW5nZSA9IGluZmxpZ2h0UmFuZ2UgfHwgREVGQVVMVF9NQVhfSU5GTElHSFQKCiAgICAvLyBOb3RlOiBub2RhdGEgYW5kIHVud2FudCBub3QgY3VycmVudGx5IHRyYWNrZWQKICAgIC8vIHR4ID0gdHJhbnNtaXR0ZWQsIHJ4ID0gcmVjZWl2ZWQKICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgIHdpcmVTeW5jOiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlUmVxdWVzdDogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZUNhbmNlbDogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZURhdGE6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVXYW50OiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlQml0ZmllbGQ6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVSYW5nZTogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZUV4dGVuc2lvbjogeyB0eDogMCwgcng6IDAgfSwKICAgICAgaG90c3dhcHM6IDAsCiAgICAgIGludmFsaWREYXRhOiAwLAogICAgICBpbnZhbGlkUmVxdWVzdHM6IDAsCiAgICAgIGJhY2tvZmZzOiAwCiAgICB9CgogICAgdGhpcy5fYXR0YWNoZWQgPSBuZXcgU2V0KCkKICAgIHRoaXMuX2luZmxpZ2h0ID0gbmV3IEluZmxpZ2h0VHJhY2tlcigpCiAgICB0aGlzLl9ibG9ja3MgPSBuZXcgQmxvY2tUcmFja2VyKHRoaXMpCiAgICB0aGlzLl9oYXNoZXMgPSBuZXcgQmxvY2tUcmFja2VyKHRoaXMpCgogICAgdGhpcy5fYWx3YXlzTGF0ZXN0QmxvY2sgPSBhbHdheXNMYXRlc3RCbG9jayA/IDEgOiAwCiAgICB0aGlzLl9xdWV1ZWQgPSBbXQoKICAgIHRoaXMuX3NlZWtzID0gW10KICAgIHRoaXMuX3VwZ3JhZGUgPSBudWxsCiAgICB0aGlzLl9yZW9yZ3MgPSBbXQogICAgdGhpcy5fcmFuZ2VzID0gW10KCiAgICB0aGlzLl9wdXNoTG9jayA9IG5ldyBNdXRleCgpCiAgICB0aGlzLl9oYWRQZWVycyA9IGZhbHNlCiAgICB0aGlzLl9hY3RpdmUgPSAwCiAgICB0aGlzLl9pZkF2YWlsYWJsZSA9IDAKICAgIHRoaXMuX3VwZGF0ZXNQZW5kaW5nID0gMAogICAgdGhpcy5fYXBwbHlpbmdSZW9yZyA9IG51bGwKICAgIHRoaXMuX21hbmlmZXN0UGVlciA9IG51bGwKICAgIHRoaXMuX25vdERvd25sb2FkaW5nTGluZ2VyID0gbm90RG93bmxvYWRpbmdMaW5nZXIKICAgIHRoaXMuX2Rvd25sb2FkaW5nVGltZXIgPSBudWxsCgogICAgY29uc3Qgc2VsZiA9IHRoaXMKICAgIHRoaXMuX29uc3RyZWFtY2xvc2UgPSBvbnN0cmVhbWNsb3NlCgogICAgZnVuY3Rpb24gb25zdHJlYW1jbG9zZSgpIHsKICAgICAgc2VsZi5kZXRhY2hGcm9tKHRoaXMudXNlckRhdGEpCiAgICB9CiAgfQoKICB1cGRhdGVBY3Rpdml0eShpbmMsIHNlc3Npb24pIHsKICAgIHRoaXMuYWN0aXZlU2Vzc2lvbnMgKz0gaW5jCiAgICB0aGlzLnNldERvd25sb2FkaW5nKHRoaXMuYWN0aXZlU2Vzc2lvbnMgIT09IDAsIHNlc3Npb24pCiAgfQoKICBpc0Rvd25sb2FkaW5nKCkgewogICAgcmV0dXJuIHRoaXMuZG93bmxvYWRpbmcgfHwgIXRoaXMuX2luZmxpZ2h0LmlkbGUKICB9CgogIGFzeW5jIHB1c2goaW5kZXgpIHsKICAgIGNvbnN0IGFsbCA9IFtdCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgewogICAgICBhbGwucHVzaChwZWVyLnB1c2goaW5kZXgpKQogICAgfQogICAgYXdhaXQgUHJvbWlzZS5hbGwoYWxsKQogIH0KCiAgc2V0QWxsb3dQdXNoKGFsbG93UHVzaCkgewogICAgaWYgKGFsbG93UHVzaCA9PT0gdGhpcy5hbGxvd1B1c2gpIHJldHVybgogICAgdGhpcy5hbGxvd1B1c2ggPSBhbGxvd1B1c2gKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSBwZWVyLnNlbmRTeW5jKCkKICB9CgogIHNldERvd25sb2FkaW5nKGRvd25sb2FkaW5nKSB7CiAgICBjbGVhclRpbWVvdXQodGhpcy5fZG93bmxvYWRpbmdUaW1lcikKCiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgaWYgKGRvd25sb2FkaW5nIHx8IHRoaXMuX25vdERvd25sb2FkaW5nTGluZ2VyID09PSAwKSB7CiAgICAgIHRoaXMuc2V0RG93bmxvYWRpbmdOb3coZG93bmxvYWRpbmcpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuX2Rvd25sb2FkaW5nVGltZXIgPSBzZXRUaW1lb3V0KAogICAgICBzZXREb3dubG9hZGluZ0xhdGVyLAogICAgICB0aGlzLl9ub3REb3dubG9hZGluZ0xpbmdlciwKICAgICAgdGhpcywKICAgICAgZG93bmxvYWRpbmcKICAgICkKICAgIGlmICh0aGlzLl9kb3dubG9hZGluZ1RpbWVyLnVucmVmKSB0aGlzLl9kb3dubG9hZGluZ1RpbWVyLnVucmVmKCkKICB9CgogIHNldERvd25sb2FkaW5nTm93KGRvd25sb2FkaW5nKSB7CiAgICB0aGlzLl9kb3dubG9hZGluZ1RpbWVyID0gbnVsbAogICAgaWYgKHRoaXMuZG93bmxvYWRpbmcgPT09IGRvd25sb2FkaW5nKSByZXR1cm4KICAgIHRoaXMuZG93bmxvYWRpbmcgPSBkb3dubG9hZGluZwogICAgaWYgKCFkb3dubG9hZGluZyAmJiB0aGlzLmlzRG93bmxvYWRpbmcoKSkgcmV0dXJuCgogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHBlZXIuc2lnbmFsVXBncmFkZSgpCgogICAgaWYgKGRvd25sb2FkaW5nKSB7CiAgICAgIC8vIHJlc3RhcnQgY2hhbm5lbCBpZiBuZWVkZWQuLi4KICAgICAgZm9yIChjb25zdCBwcm90b211eCBvZiB0aGlzLl9hdHRhY2hlZCkgewogICAgICAgIGlmICghcHJvdG9tdXguc3RyZWFtLmhhbmRzaGFrZUhhc2gpIGNvbnRpbnVlCiAgICAgICAgaWYgKHByb3RvbXV4Lm9wZW5lZCh7IHByb3RvY29sOiAnaHlwZXJjb3JlL2FscGhhJywgaWQ6IHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkgfSkpIGNvbnRpbnVlCiAgICAgICAgdGhpcy5fbWFrZVBlZXIocHJvdG9tdXgsIHRydWUpCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSBwZWVyLmNsb3NlSWZJZGxlKCkKICAgIH0KCiAgICBpZiAodGhpcy5vbmRvd25sb2FkaW5nICE9PSBudWxsICYmIGRvd25sb2FkaW5nKSB0aGlzLm9uZG93bmxvYWRpbmcoKQogIH0KCiAgY29yaygpIHsKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSBwZWVyLnByb3RvbXV4LmNvcmsoKQogIH0KCiAgdW5jb3JrKCkgewogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHBlZXIucHJvdG9tdXgudW5jb3JrKCkKICB9CgogIC8vIENhbGxlZCBleHRlcm5hbGx5IHdoZW4gYSByYW5nZSBvZiBuZXcgYmxvY2tzIGhhcyBiZWVuIHByb2Nlc3NlZC9yZW1vdmVkCiAgb25oYXZlKHN0YXJ0LCBsZW5ndGgsIGRyb3AgPSBmYWxzZSkgewogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHBlZXIuYnJvYWRjYXN0UmFuZ2Uoc3RhcnQsIGxlbmd0aCwgZHJvcCkKICB9CgogIC8vIENhbGxlZCBleHRlcm5hbGx5IHdoZW4gYSB0cnVuY2F0aW9uIHVwZ3JhZGUgaGFzIGJlZW4gcHJvY2Vzc2VkCiAgb250cnVuY2F0ZShuZXdMZW5ndGgsIHRydW5jYXRlZCkgewogICAgY29uc3Qgbm90aWZ5ID0gW10KCiAgICBmb3IgKGNvbnN0IGJsayBvZiB0aGlzLl9ibG9ja3MpIHsKICAgICAgaWYgKGJsay5pbmRleCA8IG5ld0xlbmd0aCkgY29udGludWUKICAgICAgbm90aWZ5LnB1c2goYmxrKQogICAgfQoKICAgIGZvciAoY29uc3QgYmxrIG9mIG5vdGlmeSkgewogICAgICBmb3IgKGNvbnN0IHIgb2YgYmxrLnJlZnMpIHsKICAgICAgICBpZiAoci5zbmFwc2hvdCA9PT0gZmFsc2UpIGNvbnRpbnVlCiAgICAgICAgYmxrLmRldGFjaChyLCBTTkFQU0hPVF9OT1RfQVZBSUxBQkxFKCkpCiAgICAgIH0KICAgIH0KCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5fdW5jbGVhckxvY2FsUmFuZ2UobmV3TGVuZ3RoLCB0cnVuY2F0ZWQpCiAgfQoKICAvLyBDYWxsZWQgZXh0ZXJuYWxseSB3aGVuIGEgdXBncmFkZSBoYXMgYmVlbiBwcm9jZXNzZWQKICBvbnVwZ3JhZGUoKSB7CiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5zaWduYWxVcGdyYWRlKCkKICAgIGlmICh0aGlzLl9ibG9ja3MuaXNFbXB0eSgpID09PSBmYWxzZSkgdGhpcy5fcmVzb2x2ZUJsb2Nrc0xvY2FsbHkoKQogICAgaWYgKHRoaXMuX3VwZ3JhZGUgIT09IG51bGwpIHRoaXMuX3Jlc29sdmVVcGdyYWRlUmVxdWVzdChudWxsKQogICAgaWYgKCF0aGlzLl9ibG9ja3MuaXNFbXB0eSgpIHx8IHRoaXMuX3Jhbmdlcy5sZW5ndGggIT09IDAgfHwgdGhpcy5fc2Vla3MubGVuZ3RoICE9PSAwKSB7CiAgICAgIHRoaXMuX3VwZGF0ZU5vblByaW1hcnkodHJ1ZSkKICAgIH0KICB9CgogIC8vIENhbGxlZCBleHRlcm5hbGx5IHdoZW4gYSBjb25mbGljdCBoYXMgYmVlbiBkZXRlY3RlZCBhbmQgdmVyaWZpZWQKICBhc3luYyBvbmNvbmZsaWN0KCkgewogICAgY29uc3QgYWxsID0gW10KICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSB7CiAgICAgIGFsbC5wdXNoKHBlZXIuX29uY29uZmxpY3QoKSkKICAgIH0KICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChhbGwpCiAgfQoKICBhc3luYyBhcHBseVBlbmRpbmdSZW9yZygpIHsKICAgIGlmICh0aGlzLl9hcHBseWluZ1Jlb3JnICE9PSBudWxsKSB7CiAgICAgIGF3YWl0IHRoaXMuX2FwcGx5aW5nUmVvcmcKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBmb3IgKGxldCBpID0gdGhpcy5fcmVvcmdzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IGYgPSB0aGlzLl9yZW9yZ3NbaV0KICAgICAgaWYgKGYuYmF0Y2ggIT09IG51bGwgJiYgZi5iYXRjaC5maW5pc2hlZCkgewogICAgICAgIGF3YWl0IHRoaXMuX2FwcGx5UmVvcmcoZikKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBhZGRVcGdyYWRlKHNlc3Npb24pIHsKICAgIGlmICh0aGlzLl91cGdyYWRlICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IHJlZiA9IHRoaXMuX3VwZ3JhZGUuYXR0YWNoKHNlc3Npb24pCiAgICAgIHRoaXMuX2NoZWNrVXBncmFkZUlmQXZhaWxhYmxlKCkKICAgICAgcmV0dXJuIHJlZgogICAgfQoKICAgIGNvbnN0IHJlZiA9IHRoaXMuX2FkZFVwZ3JhZGUoKS5hdHRhY2goc2Vzc2lvbikKCiAgICB0aGlzLnVwZGF0ZUFsbCgpCgogICAgcmV0dXJuIHJlZgogIH0KCiAgYWRkQmxvY2soc2Vzc2lvbiwgaW5kZXgpIHsKICAgIGNvbnN0IGIgPSB0aGlzLl9ibG9ja3MuYWRkKGluZGV4LCBQUklPUklUWS5ISUdIKQogICAgY29uc3QgcmVmID0gYi5hdHRhY2goc2Vzc2lvbikKCiAgICB0aGlzLl9xdWV1ZUJsb2NrKGIpCiAgICB0aGlzLnVwZGF0ZUFsbCgpCgogICAgcmV0dXJuIHJlZgogIH0KCiAgYWRkU2VlayhzZXNzaW9uLCBzZWVrZXIpIHsKICAgIGNvbnN0IHMgPSBuZXcgU2Vla1JlcXVlc3QodGhpcywgdGhpcy5fc2Vla3MsIHNlZWtlcikKICAgIGNvbnN0IHJlZiA9IHMuYXR0YWNoKHNlc3Npb24pCgogICAgdGhpcy5fc2Vla3MucHVzaChzKQogICAgdGhpcy51cGRhdGVBbGwoKQoKICAgIHJldHVybiByZWYKICB9CgogIGFkZFJhbmdlKAogICAgc2Vzc2lvbiwKICAgIHsKICAgICAgc3RhcnQgPSAwLAogICAgICBlbmQgPSAtMSwKICAgICAgbGVuZ3RoID0gdG9MZW5ndGgoc3RhcnQsIGVuZCksCiAgICAgIGJsb2NrcyA9IG51bGwsCiAgICAgIGxpbmVhciA9IGZhbHNlLAogICAgICBpZkF2YWlsYWJsZSA9IGZhbHNlCiAgICB9ID0ge30KICApIHsKICAgIGlmIChibG9ja3MgIT09IG51bGwpIHsKICAgICAgLy8gaWYgdXNpbmcgYmxvY2tzLCBzdGFydCwgZW5kIGp1c3QgYWN0cyBhcyBmcmFtZXMgYXJvdW5kIHRoZSBibG9ja3MgYXJyYXkKICAgICAgc3RhcnQgPSAwCiAgICAgIGVuZCA9IGxlbmd0aCA9IGJsb2Nrcy5sZW5ndGgKICAgIH0KCiAgICBjb25zdCByID0gbmV3IFJhbmdlUmVxdWVzdCgKICAgICAgdGhpcywKICAgICAgdGhpcy5fcmFuZ2VzLAogICAgICBzdGFydCwKICAgICAgbGVuZ3RoID09PSAtMSA/IC0xIDogc3RhcnQgKyBsZW5ndGgsCiAgICAgIGxpbmVhciwKICAgICAgaWZBdmFpbGFibGUsCiAgICAgIGJsb2NrcwogICAgKQoKICAgIGNvbnN0IHJlZiA9IHIuYXR0YWNoKHNlc3Npb24pCgogICAgLy8gVHJpZ2dlciB0aGlzIHRvIHNlZSBpZiB0aGlzIGlzIGFscmVhZHkgcmVzb2x2ZWQuLi4KICAgIC8vIEFsc28gYXV0byBjb21wcmVzc2VzIHRoZSByYW5nZSBiYXNlZCBvbiBsb2NhbCBiaXRmaWVsZAogICAgY2xhbXBSYW5nZSh0aGlzLmNvcmUsIHIpCgogICAgaWYgKHIuZW5kICE9PSAtMSAmJiByLnN0YXJ0ID49IHIuZW5kKSB7CiAgICAgIHRoaXMuX3Jlc29sdmVSYW5nZVJlcXVlc3QocikKICAgICAgcmV0dXJuIHJlZgogICAgfQoKICAgIHRoaXMudXBkYXRlQWxsKCkKCiAgICByZXR1cm4gcmVmCiAgfQoKICBjYW5jZWwocmVmKSB7CiAgICByZWYuY29udGV4dC5kZXRhY2gocmVmLCBudWxsKQogIH0KCiAgc3RhdGljIGNsZWFyUmVxdWVzdHMoc2Vzc2lvbiwgZXJyKSB7CiAgICBpZiAoc2Vzc2lvbi5sZW5ndGggPT09IDApIHJldHVybgoKICAgIGNvbnN0IHVwZGF0ZWQgPSBuZXcgU2V0KCkKCiAgICB3aGlsZSAoc2Vzc2lvbi5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHJlZiA9IHNlc3Npb25bc2Vzc2lvbi5sZW5ndGggLSAxXQogICAgICB1cGRhdGVkLmFkZChyZWYuY29udGV4dC5yZXBsaWNhdG9yKQogICAgICByZWYuY29udGV4dC5kZXRhY2gocmVmLCBlcnIpCiAgICB9CgogICAgZm9yIChjb25zdCByZXBsaWNhdG9yIG9mIHVwZGF0ZWQpIHsKICAgICAgcmVwbGljYXRvci51cGRhdGVBbGwoKQogICAgfQogIH0KCiAgY2xlYXJSZXF1ZXN0cyhzZXNzaW9uLCBlcnIgPSBudWxsKSB7CiAgICBsZXQgY2xlYXJlZCA9IGZhbHNlCiAgICB3aGlsZSAoc2Vzc2lvbi5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHJlZiA9IHNlc3Npb25bc2Vzc2lvbi5sZW5ndGggLSAxXQogICAgICByZWYuY29udGV4dC5kZXRhY2gocmVmLCBlcnIpCiAgICAgIGNsZWFyZWQgPSB0cnVlCiAgICB9CgogICAgaWYgKGNsZWFyZWQpIHRoaXMudXBkYXRlQWxsKCkKICB9CgogIF9tYXRjaGluZ1JlcXVlc3QocmVxLCBkYXRhKSB7CiAgICBpZiAodGhpcy5hbGxvd1B1c2gpIHsKICAgICAgcmV0dXJuIHRydWUKICAgIH0KICAgIGlmIChkYXRhLmJsb2NrICE9PSBudWxsICYmIChyZXEuYmxvY2sgPT09IG51bGwgfHwgcmVxLmJsb2NrLmluZGV4ICE9PSBkYXRhLmJsb2NrLmluZGV4KSkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICAgIGlmIChkYXRhLmhhc2ggIT09IG51bGwgJiYgKHJlcS5oYXNoID09PSBudWxsIHx8IHJlcS5oYXNoLmluZGV4ICE9PSBkYXRhLmhhc2guaW5kZXgpKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogICAgaWYgKGRhdGEuc2VlayAhPT0gbnVsbCAmJiAocmVxLnNlZWsgPT09IG51bGwgfHwgcmVxLnNlZWsuYnl0ZXMgIT09IGRhdGEuc2Vlay5ieXRlcykpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgICBpZiAoZGF0YS51cGdyYWRlICE9PSBudWxsICYmIHJlcS51cGdyYWRlID09PSBudWxsKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogICAgcmV0dXJuIHJlcS5mb3JrID09PSBkYXRhLmZvcmsKICB9CgogIF9hZGRVcGdyYWRlTWF5YmUoKSB7CiAgICByZXR1cm4gdGhpcy5lYWdlclVwZ3JhZGUgPT09IHRydWUgPyB0aGlzLl9hZGRVcGdyYWRlKCkgOiB0aGlzLl91cGdyYWRlCiAgfQoKICAvLyBUT0RPOiB0aGlzIGZ1bmN0aW9uIGlzIE9WRVIgY2FsbGVkIGF0bSwgYXQgZWFjaCB1cGRhdGVQZWVyL3VwZGF0ZUFsbAogIC8vIGluc3RlYWQgaXRzIG1vcmUgZWZmaWNpZW50IHRvIG9ubHkgY2FsbCBpdCB3aGVuIHRoZSBjb25kaXRpb25zIGluIGhlcmUgY2hhbmdlIC0gaWUgb24gc3luYy9hZGQvcmVtb3ZlIHBlZXIKICAvLyBEbyB0aGlzIHdoZW4gd2UgaGF2ZSBtb3JlIHRlc3RzLgogIF9jaGVja1VwZ3JhZGVJZkF2YWlsYWJsZSgpIHsKICAgIGlmICh0aGlzLl9pZkF2YWlsYWJsZSA+IDAgJiYgdGhpcy5wZWVycy5sZW5ndGggPCBNQVhfUEVFUlNfVVBHUkFERSkgcmV0dXJuCiAgICBpZiAodGhpcy5fdXBncmFkZSA9PT0gbnVsbCB8fCB0aGlzLl91cGdyYWRlLnJlZnMubGVuZ3RoID09PSAwKSByZXR1cm4KICAgIGlmICh0aGlzLl9oYWRQZWVycyA9PT0gZmFsc2UgJiYgdGhpcy5maW5kaW5nUGVlcnMgPiAwKSByZXR1cm4KCiAgICBjb25zdCBtYXhQZWVycyA9IE1hdGgubWluKHRoaXMucGVlcnMubGVuZ3RoLCBNQVhfUEVFUlNfVVBHUkFERSkKCiAgICAvLyBjaGVjayBpZiBhIHBlZXIgY2FuIHVwZ3JhZGUgdXMKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1heFBlZXJzOyBpKyspIHsKICAgICAgY29uc3QgcGVlciA9IHRoaXMucGVlcnNbaV0KCiAgICAgIGlmIChwZWVyLnJlbW90ZVN5bmNlZCA9PT0gZmFsc2UpIHJldHVybgoKICAgICAgaWYgKHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggPT09IDAgJiYgcGVlci5yZW1vdGVMZW5ndGggPiAwKSByZXR1cm4KCiAgICAgIGlmIChwZWVyLnJlbW90ZUxlbmd0aCA8PSB0aGlzLl91cGdyYWRlLmxlbmd0aCB8fCBwZWVyLnJlbW90ZUZvcmsgIT09IHRoaXMuX3VwZ3JhZGUuZm9yaykgewogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGlmIChwZWVyLnN5bmNzUHJvY2Vzc2luZyA+IDApIHJldHVybgoKICAgICAgaWYgKHBlZXIubGVuZ3RoQWNrZWQgIT09IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggJiYgcGVlci5yZW1vdGVGb3JrID09PSB0aGlzLmNvcmUuc3RhdGUuZm9yaykgewogICAgICAgIHJldHVybgogICAgICB9CgogICAgICBpZiAocGVlci5yZW1vdGVDYW5VcGdyYWRlID09PSB0cnVlKSByZXR1cm4KICAgIH0KCiAgICAvLyBjaGVjayBpZiByZW9yZ3MgaW4gcHJvZ3Jlc3MuLi4KCiAgICBpZiAodGhpcy5fYXBwbHlpbmdSZW9yZyAhPT0gbnVsbCkgcmV0dXJuCgogICAgLy8gVE9ETzogd2UgcHJvYiBzaG91bGQgTk9UIHdhaXQgZm9yIGluZmxpZ2h0IHJlb3JncyBoZXJlLCBzZWVtcyBiZXR0ZXIgdG8ganVzdCByZXNvbHZlIHRoZSB1cGdyYWRlCiAgICAvLyBhbmQgdGhlbiBhcHBseSB0aGUgcmVvcmcgb24gdGhlIG5leHQgY2FsbCBpbiBjYXNlIGl0J3Mgc2xvdyAtIG5lZWRzIHNvbWUgdGVzdGluZyBpbiBwcmFjdGljZQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fcmVvcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHIgPSB0aGlzLl9yZW9yZ3NbaV0KICAgICAgaWYgKHIuaW5mbGlnaHQubGVuZ3RoID4gMCkgcmV0dXJuCiAgICB9CgogICAgLy8gaWYgc29tZXRoaW5nIGlzIGluZmxpZ2h0LCB3YWl0IGZvciB0aGF0IGZpcnN0CiAgICBpZiAodGhpcy5fdXBncmFkZS5pbmZsaWdodC5sZW5ndGggPiAwKSByZXR1cm4KCiAgICAvLyBub3RoaW5nIHRvIGRvLCBpbmRpY2F0ZSBubyB1cGRhdGUgYXZhaWwKCiAgICBjb25zdCB1ID0gdGhpcy5fdXBncmFkZQogICAgdGhpcy5fdXBncmFkZSA9IG51bGwKICAgIHUucmVzb2x2ZShmYWxzZSkKICB9CgogIF9hZGRVcGdyYWRlKCkgewogICAgaWYgKHRoaXMuX3VwZ3JhZGUgIT09IG51bGwpIHJldHVybiB0aGlzLl91cGdyYWRlCgogICAgLy8gVE9ETzogbmVlZHMgYSByZW9yZzogdHJ1ZS9mYWxzZSBmbGFnIHRvIGluZGljYXRlIGlmIHRoZSB1c2VyIHJlcXVlc3RlZCBhIHJlb3JnCiAgICB0aGlzLl91cGdyYWRlID0gbmV3IFVwZ3JhZGVSZXF1ZXN0KHRoaXMsIHRoaXMuY29yZS5zdGF0ZS5mb3JrLCB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoKQoKICAgIHJldHVybiB0aGlzLl91cGdyYWRlCiAgfQoKICBfYWRkUmVvcmcoZm9yaywgcGVlcikgewogICAgaWYgKHRoaXMuYWxsb3dGb3JrID09PSBmYWxzZSkgcmV0dXJuIG51bGwKCiAgICAvLyBUT0RPOiBlYWdlciBnYyBvbGQgcmVvcmdzIGZyb20gdGhlIHNhbWUgcGVlcgogICAgLy8gbm90IHN1cGVyIGltcG9ydGFudCBiZWNhdXNlIHRoZXknbGwgZ2V0IGdjJ2VkIHdoZW4gdGhlIHJlcXVlc3QgZmluaXNoZXMKICAgIC8vIGJ1dCBqdXN0IHNwYW0gdGhlIHJlbW90ZSBjYW4gZG8gLi4uCgogICAgZm9yIChjb25zdCBmIG9mIHRoaXMuX3Jlb3JncykgewogICAgICBpZiAoZi5mb3JrID4gZm9yayAmJiBmLmJhdGNoICE9PSBudWxsKSByZXR1cm4gbnVsbAogICAgICBpZiAoZi5mb3JrID09PSBmb3JrKSByZXR1cm4gZgogICAgfQoKICAgIGNvbnN0IGYgPSB7CiAgICAgIGZvcmssCiAgICAgIGluZmxpZ2h0OiBbXSwKICAgICAgYmF0Y2g6IG51bGwKICAgIH0KCiAgICB0aGlzLl9yZW9yZ3MucHVzaChmKQoKICAgIC8vIG1haW50YWluIHNvcnRlZCBieSBmb3JrCiAgICBsZXQgaSA9IHRoaXMuX3Jlb3Jncy5sZW5ndGggLSAxCiAgICB3aGlsZSAoaSA+IDAgJiYgdGhpcy5fcmVvcmdzW2kgLSAxXS5mb3JrID4gZm9yaykgewogICAgICB0aGlzLl9yZW9yZ3NbaV0gPSB0aGlzLl9yZW9yZ3NbaSAtIDFdCiAgICAgIHRoaXMuX3Jlb3Jnc1stLWldID0gZgogICAgfQoKICAgIHJldHVybiBmCiAgfQoKICBfc2hvdWxkVXBncmFkZShwZWVyKSB7CiAgICBpZiAodGhpcy5fdXBncmFkZSAhPT0gbnVsbCAmJiB0aGlzLl91cGdyYWRlLmluZmxpZ2h0Lmxlbmd0aCA+IDApIHJldHVybiBmYWxzZQogICAgcmV0dXJuICgKICAgICAgcGVlci5yZW1vdGVDYW5VcGdyYWRlID09PSB0cnVlICYmCiAgICAgIHBlZXIucmVtb3RlTGVuZ3RoID4gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCAmJgogICAgICBwZWVyLmxlbmd0aEFja2VkID09PSB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoCiAgICApCiAgfQoKICBfYXV0b1VwZ3JhZGUocGVlcikgewogICAgcmV0dXJuICgKICAgICAgdGhpcy5fdXBncmFkZSAhPT0gbnVsbCAmJgogICAgICBwZWVyLnJlbW90ZUZvcmsgPT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrICYmCiAgICAgIHRoaXMuX3Nob3VsZFVwZ3JhZGUocGVlcikKICAgICkKICB9CgogIF9hZGRQZWVyKHBlZXIpIHsKICAgIHRoaXMuX2hhZFBlZXJzID0gdHJ1ZQogICAgdGhpcy5wZWVycy5wdXNoKHBlZXIpCiAgICB0aGlzLnVwZGF0ZVBlZXIocGVlcikKICAgIHRoaXMuX29ucGVlcnVwZGF0ZSh0cnVlLCBwZWVyKQogIH0KCiAgX3JlcXVlc3REb25lKGlkLCByb3VuZHRyaXApIHsKICAgIHRoaXMuX2luZmxpZ2h0LnJlbW92ZShpZCwgcm91bmR0cmlwKQogICAgaWYgKHRoaXMuaXNEb3dubG9hZGluZygpID09PSB0cnVlKSByZXR1cm4KICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSBwZWVyLnNpZ25hbFVwZ3JhZGUoKQogIH0KCiAgX3JlbW92ZVBlZXIocGVlcikgewogICAgdGhpcy5wZWVycy5zcGxpY2UodGhpcy5wZWVycy5pbmRleE9mKHBlZXIpLCAxKQoKICAgIGlmICh0aGlzLl9tYW5pZmVzdFBlZXIgPT09IHBlZXIpIHRoaXMuX21hbmlmZXN0UGVlciA9IG51bGwKCiAgICBmb3IgKGNvbnN0IHJlcSBvZiB0aGlzLl9pbmZsaWdodCkgewogICAgICBpZiAocmVxLnBlZXIgIT09IHBlZXIpIGNvbnRpbnVlCiAgICAgIHRoaXMuX2luZmxpZ2h0LnJlbW92ZShyZXEuaWQsIHRydWUpCiAgICAgIHRoaXMuX2NsZWFyUmVxdWVzdChwZWVyLCByZXEpCiAgICB9CgogICAgdGhpcy5fb25wZWVydXBkYXRlKGZhbHNlLCBwZWVyKQogICAgdGhpcy51cGRhdGVBbGwoKQogIH0KCiAgX3F1ZXVlQmxvY2soYikgewogICAgaWYgKGIuaW5mbGlnaHQubGVuZ3RoID4gMCB8fCBiLnF1ZXVlZCA9PT0gdHJ1ZSkgcmV0dXJuCiAgICBiLnF1ZXVlZCA9IHRydWUKICAgIHRoaXMuX3F1ZXVlZC5wdXNoKGIpCiAgfQoKICBfcmVzb2x2ZUhhc2hMb2NhbGx5KHBlZXIsIHJlcSkgewogICAgdGhpcy5fcmVxdWVzdERvbmUocmVxLmlkLCBmYWxzZSkKICAgIHRoaXMuX3Jlc29sdmVCbG9ja1JlcXVlc3QodGhpcy5faGFzaGVzLCByZXEuaGFzaC5pbmRleCAvIDIsIG51bGwsIHJlcSkKICAgIHRoaXMudXBkYXRlUGVlcihwZWVyKQogIH0KCiAgLy8gUnVucyBpbiB0aGUgYmFja2dyb3VuZCAtIG5vdCBhbGxvd2VkIHRvIHRocm93CiAgYXN5bmMgX3Jlc29sdmVCbG9ja3NMb2NhbGx5KCkgewogICAgLy8gVE9ETzogY2hlY2sgaWYgZm9yayBjb21wYXQgZXRjLiBSZXF1aXJlcyB0aGF0IHdlIHBhc3MgZG93biB0cnVuY2F0aW9uIGluZm8KCiAgICBjb25zdCBjbGVhciA9IFtdCiAgICBjb25zdCBibG9ja3MgPSBbXQoKICAgIGNvbnN0IHJlYWRlciA9IHRoaXMuY29yZS5zdG9yYWdlLnJlYWQoKQogICAgZm9yIChjb25zdCBiIG9mIHRoaXMuX2Jsb2NrcykgewogICAgICBpZiAodGhpcy5jb3JlLmJpdGZpZWxkLmdldChiLmluZGV4KSA9PT0gZmFsc2UpIGNvbnRpbnVlCiAgICAgIGJsb2Nrcy5wdXNoKHRoaXMuX3Jlc29sdmVMb2NhbEJsb2NrKGIsIHJlYWRlciwgY2xlYXIpKQogICAgfQogICAgcmVhZGVyLnRyeUZsdXNoKCkKCiAgICBhd2FpdCBQcm9taXNlLmFsbChibG9ja3MpCgogICAgaWYgKCFjbGVhci5sZW5ndGgpIHJldHVybgoKICAgIC8vIEN1cnJlbnRseSB0aGUgYmxvY2sgdHJhY2tlciBkb2VzIG5vdCBzdXBwb3J0IGRlbGV0ZXMgZHVyaW5nIGl0ZXJhdGlvbiwgc28gd2UgbWFrZQogICAgLy8gc3VyZSB0byBjbGVhciB0aGVtIGFmdGVyd2FyZHMuCiAgICBmb3IgKGNvbnN0IGIgb2YgY2xlYXIpIHsKICAgICAgdGhpcy5fYmxvY2tzLnJlbW92ZShiLmluZGV4KQogICAgICByZW1vdmVIb3Rzd2FwKGIpCiAgICB9CiAgfQoKICBhc3luYyBfcmVzb2x2ZUxvY2FsQmxvY2soYiwgcmVhZGVyLCByZXNvbHZlZCkgewogICAgdHJ5IHsKICAgICAgYi5yZXNvbHZlKGF3YWl0IHJlYWRlci5nZXRCbG9jayhiLmluZGV4KSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBiLnJlamVjdChlcnIpCiAgICAgIHJldHVybgogICAgfQoKICAgIHJlc29sdmVkLnB1c2goYikKICB9CgogIF9yZXNvbHZlQmxvY2tSZXF1ZXN0KHRyYWNrZXIsIGluZGV4LCB2YWx1ZSwgcmVxKSB7CiAgICBjb25zdCBiID0gdHJhY2tlci5yZW1vdmUoaW5kZXgpCiAgICBpZiAoYiA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogICAgcmVtb3ZlSW5mbGlnaHQoYi5pbmZsaWdodCwgcmVxKQogICAgcmVtb3ZlSG90c3dhcChiKQogICAgYi5xdWV1ZWQgPSBmYWxzZQoKICAgIGIucmVzb2x2ZSh2YWx1ZSkKCiAgICBpZiAoYi5pbmZsaWdodC5sZW5ndGggPiAwKSB7CiAgICAgIC8vIGlmIGFueXRoaW5nIGlzIHN0aWxsIGluZmxpZ2h0LCBjYW5jZWwgaXQKICAgICAgZm9yIChsZXQgaSA9IGIuaW5mbGlnaHQubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBjb25zdCByZXEgPSBiLmluZmxpZ2h0W2ldCiAgICAgICAgcmVxLnBlZXIuX2NhbmNlbFJlcXVlc3QocmVxKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIF9yZXNvbHZlVXBncmFkZVJlcXVlc3QocmVxKSB7CiAgICBpZiAocmVxICE9PSBudWxsKSByZW1vdmVJbmZsaWdodCh0aGlzLl91cGdyYWRlLmluZmxpZ2h0LCByZXEpCgogICAgaWYgKAogICAgICB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoID09PSB0aGlzLl91cGdyYWRlLmxlbmd0aCAmJgogICAgICB0aGlzLmNvcmUuc3RhdGUuZm9yayA9PT0gdGhpcy5fdXBncmFkZS5mb3JrCiAgICApIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc3QgdSA9IHRoaXMuX3VwZ3JhZGUKICAgIHRoaXMuX3VwZ3JhZGUgPSBudWxsCiAgICB1LnJlc29sdmUodHJ1ZSkKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3Jlc29sdmVSYW5nZVJlcXVlc3QocmVxKSB7CiAgICByZXEucmVzb2x2ZSh0cnVlKQogICAgcmVxLmdjKCkKICB9CgogIF9jbGVhckluZmxpZ2h0QmxvY2sodHJhY2tlciwgcmVxKSB7CiAgICBjb25zdCBpc0Jsb2NrID0gdHJhY2tlciA9PT0gdGhpcy5fYmxvY2tzCiAgICBjb25zdCBpbmRleCA9IGlzQmxvY2sgPT09IHRydWUgPyByZXEuYmxvY2suaW5kZXggOiByZXEuaGFzaC5pbmRleCAvIDIKICAgIGNvbnN0IGIgPSB0cmFja2VyLmdldChpbmRleCkKCiAgICBpZiAoYiA9PT0gbnVsbCB8fCByZW1vdmVJbmZsaWdodChiLmluZmxpZ2h0LCByZXEpID09PSBmYWxzZSkgcmV0dXJuCgogICAgaWYgKHJlbW92ZUhvdHN3YXAoYikgPT09IHRydWUgJiYgYi5pbmZsaWdodC5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuaG90c3dhcHMuYWRkKGIpCiAgICB9CgogICAgaWYgKGIucmVmcy5sZW5ndGggPiAwICYmIGlzQmxvY2sgPT09IHRydWUpIHsKICAgICAgdGhpcy5fcXVldWVCbG9jayhiKQogICAgICByZXR1cm4KICAgIH0KCiAgICBiLmdjKCkKICB9CgogIF9jbGVhckluZmxpZ2h0VXBncmFkZShyZXEpIHsKICAgIGlmICh0aGlzLl91cGdyYWRlID09PSBudWxsIHx8IHJlbW92ZUluZmxpZ2h0KHRoaXMuX3VwZ3JhZGUuaW5mbGlnaHQsIHJlcSkgPT09IGZhbHNlKSByZXR1cm4KICAgIHRoaXMuX3VwZ3JhZGUuZ2MoKQogIH0KCiAgX2NsZWFySW5mbGlnaHRTZWVrcyhyZXEpIHsKICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLl9zZWVrcykgewogICAgICBpZiAocmVtb3ZlSW5mbGlnaHQocy5pbmZsaWdodCwgcmVxKSA9PT0gZmFsc2UpIGNvbnRpbnVlCiAgICAgIHMuZ2MoKQogICAgfQogIH0KCiAgX2NsZWFySW5mbGlnaHRSZW9yZ3MocmVxKSB7CiAgICBmb3IgKGNvbnN0IHIgb2YgdGhpcy5fcmVvcmdzKSB7CiAgICAgIHJlbW92ZUluZmxpZ2h0KHIuaW5mbGlnaHQsIHJlcSkKICAgIH0KICB9CgogIF9jbGVhck9sZFJlb3Jncyhmb3JrKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3Jlb3Jncy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBmID0gdGhpcy5fcmVvcmdzW2ldCiAgICAgIGlmIChmLmZvcmsgPj0gZm9yaykgY29udGludWUKICAgICAgaWYgKGkgPT09IHRoaXMuX3Jlb3Jncy5sZW5ndGggLSAxKSB0aGlzLl9yZW9yZ3MucG9wKCkKICAgICAgZWxzZSB0aGlzLl9yZW9yZ3NbaV0gPSB0aGlzLl9yZW9yZ3MucG9wKCkKICAgICAgaS0tCiAgICB9CiAgfQoKICAvLyAic2xvdyIgdXBkYXRlcyBoZXJlIC0gYXN5bmMgYnV0IG5vdCBhbGxvd2VkIHRvIGV2ZXIgdGhyb3cKICBhc3luYyBfdXBkYXRlTm9uUHJpbWFyeSh1cGRhdGVBbGwpIHsKICAgIC8vIENoZWNrIGlmIHJ1bm5pbmcsIGlmIHNvIHNraXAgaXQgYW5kIHRoZSBydW5uaW5nIG9uZSB3aWxsIGlzc3VlIGFub3RoZXIgdXBkYXRlIGZvciB1cyAoZGVib3VuY2UpCiAgICB3aGlsZSAoKyt0aGlzLl91cGRhdGVzUGVuZGluZyA9PT0gMSkgewogICAgICBsZXQgbGVuID0gTWF0aC5taW4oTUFYX1JBTkdFUywgdGhpcy5fcmFuZ2VzLmxlbmd0aCkKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBjb25zdCByID0gdGhpcy5fcmFuZ2VzW2ldCgogICAgICAgIGNsYW1wUmFuZ2UodGhpcy5jb3JlLCByKQoKICAgICAgICBpZiAoci5lbmQgIT09IC0xICYmIHIuc3RhcnQgPj0gci5lbmQpIHsKICAgICAgICAgIHRoaXMuX3Jlc29sdmVSYW5nZVJlcXVlc3QocikKICAgICAgICAgIGktLQogICAgICAgICAgaWYgKGxlbiA+IHRoaXMuX3Jhbmdlcy5sZW5ndGgpIGxlbi0tCiAgICAgICAgICBpZiAodGhpcy5fcmFuZ2VzLmxlbmd0aCA9PT0gTUFYX1JBTkdFUykgdXBkYXRlQWxsID0gdHJ1ZQogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9zZWVrcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHMgPSB0aGlzLl9zZWVrc1tpXQoKICAgICAgICBsZXQgZXJyID0gbnVsbAogICAgICAgIGxldCByZXMgPSBudWxsCgogICAgICAgIHRyeSB7CiAgICAgICAgICByZXMgPSBhd2FpdCBzLnNlZWtlci51cGRhdGUoKQogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICBlcnIgPSBlcnJvcgogICAgICAgIH0KCiAgICAgICAgaWYgKCFyZXMgJiYgIWVycikgY29udGludWUKCiAgICAgICAgaWYgKGkgPCB0aGlzLl9zZWVrcy5sZW5ndGggLSAxKSB0aGlzLl9zZWVrc1tpXSA9IHRoaXMuX3NlZWtzLnBvcCgpCiAgICAgICAgZWxzZSB0aGlzLl9zZWVrcy5wb3AoKQoKICAgICAgICBpLS0KCiAgICAgICAgaWYgKGVycikgcy5yZWplY3QoZXJyKQogICAgICAgIGVsc2Ugcy5yZXNvbHZlKHJlcykKICAgICAgfQoKICAgICAgLy8gTm8gYWRkaXRpb25hbCB1cGRhdGVzIHNjaGVkdWxlZCAtIGJyZWFrCiAgICAgIGlmICgtLXRoaXMuX3VwZGF0ZXNQZW5kaW5nID09PSAwKSBicmVhawogICAgICAvLyBEZWJvdW5jZSB0aGUgYWRkaXRpb25hbCB1cGRhdGVzIC0gY29udGludWUKICAgICAgdGhpcy5fdXBkYXRlc1BlbmRpbmcgPSAwCiAgICB9CgogICAgaWYgKHRoaXMuX2luZmxpZ2h0LmlkbGUgfHwgdXBkYXRlQWxsKSB0aGlzLnVwZGF0ZUFsbCgpCiAgfQoKICBfbWF5YmVSZXNvbHZlSWZBdmFpbGFibGVSYW5nZXMoKSB7CiAgICBpZiAodGhpcy5faWZBdmFpbGFibGUgPiAwIHx8ICF0aGlzLl9pbmZsaWdodC5pZGxlIHx8ICF0aGlzLl9yYW5nZXMubGVuZ3RoKSByZXR1cm4KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGVlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHRoaXMucGVlcnNbaV0uZGF0YVByb2Nlc3NpbmcgPiAwKSByZXR1cm4KICAgIH0KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3Jhbmdlcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCByID0gdGhpcy5fcmFuZ2VzW2ldCgogICAgICBpZiAoci5pZkF2YWlsYWJsZSkgewogICAgICAgIHRoaXMuX3Jlc29sdmVSYW5nZVJlcXVlc3QocikKICAgICAgICBpLS0KICAgICAgfQogICAgfQogIH0KCiAgX2NsZWFyUmVxdWVzdChwZWVyLCByZXEpIHsKICAgIGlmIChyZXEuYmxvY2sgIT09IG51bGwpIHsKICAgICAgdGhpcy5fY2xlYXJJbmZsaWdodEJsb2NrKHRoaXMuX2Jsb2NrcywgcmVxKQogICAgICB0aGlzLl91bm1hcmtJbmZsaWdodChyZXEuYmxvY2suaW5kZXgpCiAgICB9CgogICAgaWYgKHJlcS5oYXNoICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX2NsZWFySW5mbGlnaHRCbG9jayh0aGlzLl9oYXNoZXMsIHJlcSkKICAgIH0KCiAgICBpZiAocmVxLnVwZ3JhZGUgIT09IG51bGwgJiYgdGhpcy5fdXBncmFkZSAhPT0gbnVsbCkgewogICAgICB0aGlzLl9jbGVhckluZmxpZ2h0VXBncmFkZShyZXEpCiAgICB9CgogICAgaWYgKHRoaXMuX3NlZWtzLmxlbmd0aCA+IDApIHsKICAgICAgdGhpcy5fY2xlYXJJbmZsaWdodFNlZWtzKHJlcSkKICAgIH0KCiAgICBpZiAodGhpcy5fcmVvcmdzLmxlbmd0aCA+IDApIHsKICAgICAgdGhpcy5fY2xlYXJJbmZsaWdodFJlb3JncyhyZXEpCiAgICB9CiAgfQoKICBfb25ub2RhdGEocGVlciwgcmVxLCByZWFzb24pIHsKICAgIGlmIChyZWFzb24gPT09IElOVkFMSURfUkVRVUVTVCkgewogICAgICBwZWVyLnN0YXRzLmJhY2tvZmZzKysKICAgICAgdGhpcy5zdGF0cy5iYWNrb2ZmcysrCgogICAgICBpZiAocGVlci5zdGF0cy5iYWNrb2ZmcyA+PSBNQVhfQkFDS09GRlMpIHsKICAgICAgICBwZWVyLnBhdXNlZCA9IHRydWUKICAgICAgfQogICAgfQoKICAgIGlmIChyZXEpIHsKICAgICAgdGhpcy5fY2xlYXJSZXF1ZXN0KHBlZXIsIHJlcSkKICAgIH0KCiAgICB0aGlzLnVwZGF0ZUFsbCgpCiAgfQoKICBfb3BlblNraXBCaXRmaWVsZCgpIHsKICAgIC8vIHRlY2huaWNhbGx5IHRoZSBza2lwIGJpdGZpZWxkIGdldHMgYml0cyBjbGVhcmVkIGlmIC5jbGVhcigpIGlzIGNhbGxlZAogICAgLy8gYWxzbyB3aGljaCBtaWdodCBiZSBpbiBpbmZsaWdodCBhbHNvLCBidXQgdGhhdCBqdXN0IHJlc3VsdHMgaW4gdGhhdCBzZWN0aW9uIGJlaW5nIG92ZXJjYWxsZWQgc2hvcnRseQogICAgLy8gd29yc3QgY2FzZSwgc28gb2sgZm9yIG5vdwoKICAgIGNvbnN0IGJpdGZpZWxkID0gdGhpcy5jb3JlLm9wZW5Ta2lwQml0ZmllbGQoKQoKICAgIGZvciAoY29uc3QgcmVxIG9mIHRoaXMuX2luZmxpZ2h0KSB7CiAgICAgIGlmIChyZXEuYmxvY2spIGJpdGZpZWxkLnNldChyZXEuYmxvY2suaW5kZXgsIHRydWUpIC8vIHNraXAKICAgIH0KICB9CgogIF9tYXJrUHJvY2Vzc2luZyhpbmRleCkgewogICAgY29uc3QgYiA9IHRoaXMuX2Jsb2Nrcy5nZXQoaW5kZXgpCiAgICBpZiAoYikgewogICAgICBiLnByb2Nlc3NpbmcgPSB0cnVlCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IGggPSB0aGlzLl9oYXNoZXMuZ2V0KGluZGV4KQogICAgaWYgKGgpIGgucHJvY2Vzc2luZyA9IHRydWUKICB9CgogIF9tYXJrUHJvY2Vzc2VkKGluZGV4KSB7CiAgICBjb25zdCBiID0gdGhpcy5fYmxvY2tzLmdldChpbmRleCkKICAgIGlmIChiKSByZXR1cm4gYi5wcm9jZXNzZWQoKQoKICAgIGNvbnN0IGggPSB0aGlzLl9oYXNoZXMuZ2V0KGluZGV4KQogICAgaWYgKGgpIGgucHJvY2Vzc2VkKCkKICB9CgogIF9tYXJrSW5mbGlnaHQoaW5kZXgpIHsKICAgIGlmICh0aGlzLmNvcmUuc2tpcEJpdGZpZWxkICE9PSBudWxsKSB0aGlzLmNvcmUuc2tpcEJpdGZpZWxkLnNldChpbmRleCwgdHJ1ZSkKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSBwZWVyLl9tYXJrSW5mbGlnaHQoaW5kZXgpCiAgfQoKICBfdW5tYXJrSW5mbGlnaHQoaW5kZXgpIHsKICAgIGlmICh0aGlzLmNvcmUuc2tpcEJpdGZpZWxkICE9PSBudWxsKSB7CiAgICAgIHRoaXMuY29yZS5za2lwQml0ZmllbGQuc2V0KGluZGV4LCB0aGlzLmNvcmUuYml0ZmllbGQuZ2V0KGluZGV4KSkKICAgIH0KICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSBwZWVyLl9yZXNldE1pc3NpbmdCbG9jayhpbmRleCkKICB9CgogIGZ1bGx5RG93bmxvYWRlZCgpIHsKICAgIGlmICghdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkgcmV0dXJuIGZhbHNlCiAgICByZXR1cm4gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCA9PT0gdGhpcy5jb3JlLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoCiAgfQoKICBfb25kYXRhKHBlZXIsIHJlcSwgZGF0YSkgewogICAgaWYgKHJlcSkgewogICAgICByZXEuZWxhcHNlZCA9IERhdGUubm93KCkgLSByZXEudGltZXN0YW1wCiAgICB9CgogICAgaWYgKGRhdGEuYmxvY2sgIT09IG51bGwpIHsKICAgICAgdGhpcy5fcmVzb2x2ZUJsb2NrUmVxdWVzdCh0aGlzLl9ibG9ja3MsIGRhdGEuYmxvY2suaW5kZXgsIGRhdGEuYmxvY2sudmFsdWUsIHJlcSkKICAgICAgdGhpcy5fb25kb3dubG9hZChkYXRhLmJsb2NrLmluZGV4LCBkYXRhLmJsb2NrLnZhbHVlLmJ5dGVMZW5ndGgsIHBlZXIsIHJlcSkKICAgIH0KCiAgICBpZiAoZGF0YS5oYXNoICE9PSBudWxsICYmIChkYXRhLmhhc2guaW5kZXggJiAxKSA9PT0gMCkgewogICAgICB0aGlzLl9yZXNvbHZlQmxvY2tSZXF1ZXN0KHRoaXMuX2hhc2hlcywgZGF0YS5oYXNoLmluZGV4IC8gMiwgbnVsbCwgcmVxKQogICAgfQoKICAgIGlmICh0aGlzLl91cGdyYWRlICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX3Jlc29sdmVVcGdyYWRlUmVxdWVzdChyZXEpCiAgICB9CgogICAgaWYgKHRoaXMuX3NlZWtzLmxlbmd0aCA+IDApIHsKICAgICAgdGhpcy5fY2xlYXJJbmZsaWdodFNlZWtzKHJlcSkKICAgIH0KCiAgICBpZiAodGhpcy5fcmVvcmdzLmxlbmd0aCA+IDApIHsKICAgICAgdGhpcy5fY2xlYXJJbmZsaWdodFJlb3JncyhyZXEpCiAgICB9CgogICAgaWYgKHRoaXMuX21hbmlmZXN0UGVlciA9PT0gcGVlciAmJiB0aGlzLmNvcmUuaGVhZGVyLm1hbmlmZXN0ICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX21hbmlmZXN0UGVlciA9IG51bGwKICAgIH0KCiAgICBpZiAodGhpcy5fc2Vla3MubGVuZ3RoID4gMCB8fCB0aGlzLl9yYW5nZXMubGVuZ3RoID4gMCkgewogICAgICB0aGlzLl91cGRhdGVOb25QcmltYXJ5KHRoaXMuX3NlZWtzLmxlbmd0aCA+IDApCiAgICB9CgogICAgdGhpcy51cGRhdGVQZWVyKHBlZXIpCiAgfQoKICBfb253YW50KHBlZXIsIHN0YXJ0LCBsZW5ndGgpIHsKICAgIGlmICghcGVlci5pc0FjdGl2ZSgpKSByZXR1cm4KCiAgICBjb25zdCBjb250aWcgPSBNYXRoLm1pbih0aGlzLmNvcmUuc3RhdGUubGVuZ3RoLCB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgpCgogICAgaWYgKHN0YXJ0ICsgbGVuZ3RoIDwgY29udGlnIHx8IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggPT09IGNvbnRpZykgewogICAgICBwZWVyLndpcmVSYW5nZS5zZW5kKHsKICAgICAgICBkcm9wOiBmYWxzZSwKICAgICAgICBzdGFydDogMCwKICAgICAgICBsZW5ndGg6IGNvbnRpZwogICAgICB9KQogICAgICBpbmNyZW1lbnRUeChwZWVyLnN0YXRzLndpcmVSYW5nZSwgdGhpcy5zdGF0cy53aXJlUmFuZ2UpCiAgICAgIHJldHVybgogICAgfQoKICAgIGxlbmd0aCA9IE1hdGgubWluKGxlbmd0aCwgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCAtIHN0YXJ0KQoKICAgIHBlZXIucHJvdG9tdXguY29yaygpCgogICAgZm9yIChjb25zdCBtc2cgb2YgdGhpcy5jb3JlLmJpdGZpZWxkLndhbnQoc3RhcnQsIGxlbmd0aCkpIHsKICAgICAgcGVlci53aXJlQml0ZmllbGQuc2VuZChtc2cpCiAgICAgIGluY3JlbWVudFR4KHBlZXIuc3RhdHMud2lyZUJpdGZpZWxkLCB0aGlzLnN0YXRzLndpcmVCaXRmaWVsZCkKICAgIH0KCiAgICBwZWVyLnByb3RvbXV4LnVuY29yaygpCiAgfQoKICBhc3luYyBfb25yZW9yZ2RhdGEocGVlciwgcmVxLCBkYXRhKSB7CiAgICBjb25zdCBuZXdCYXRjaCA9IGRhdGEudXBncmFkZSAmJiAoYXdhaXQgdGhpcy5jb3JlLnZlcmlmeVJlb3JnKGRhdGEpKQogICAgY29uc3QgZiA9IHRoaXMuX2FkZFJlb3JnKGRhdGEuZm9yaywgcGVlcikKCiAgICBpZiAoZiA9PT0gbnVsbCkgewogICAgICB0aGlzLnVwZGF0ZUFsbCgpCiAgICAgIHJldHVybgogICAgfQoKICAgIHJlbW92ZUluZmxpZ2h0KGYuaW5mbGlnaHQsIHJlcSkKCiAgICBpZiAoZi5iYXRjaCkgewogICAgICBhd2FpdCBmLmJhdGNoLnVwZGF0ZShkYXRhKQogICAgfSBlbHNlIGlmIChkYXRhLnVwZ3JhZGUpIHsKICAgICAgZi5iYXRjaCA9IG5ld0JhdGNoCgogICAgICAvLyBSZW1vdmUgIm9sZGVyIiByZW9yZ3MgaW4gcHJvZ3Jlc3MgYXMgd2UganVzdCB2ZXJpZmllZCB0aGlzIG9uZS4KICAgICAgdGhpcy5fY2xlYXJPbGRSZW9yZ3MoZi5mb3JrKQogICAgfQoKICAgIGlmIChmLmJhdGNoICYmIGYuYmF0Y2guZmluaXNoZWQpIHsKICAgICAgaWYgKHRoaXMuX2FkZFVwZ3JhZGVNYXliZSgpICE9PSBudWxsKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fYXBwbHlSZW9yZyhmKQogICAgICB9CiAgICB9CgogICAgdGhpcy51cGRhdGVBbGwoKQogIH0KCiAgLy8gTmV2ZXIgdGhyb3dzLCBhbGxvd2VkIHRvIHJ1biBpbiB0aGUgYmFja2dyb3VuZAogIGFzeW5jIF9hcHBseVJlb3JnKGYpIHsKICAgIC8vIFRPRE86IG1vcmUgb3B0aW1hbCBoZXJlIHRvIGNoZWNrIGlmIHBvdGVudGlhbGx5IGEgYmV0dGVyIHJlb3JnCiAgICAvLyBpcyBhdmFpbGFibGUsIGllIGhpZ2hlciBmb3JrLCBhbmQgcmVxdWVzdCB0aGF0IG9uZSBmaXJzdC4KICAgIC8vIFRoaXMgd2lsbCByZXF1ZXN0IHRoYXQgb25lIGFmdGVyIHRoaXMgZmluaXNoZXMsIHdoaWNoIGlzIGZpbmUsIGJ1dCB3ZQogICAgLy8gc2hvdWxkIGludmVzdGlnYXRlIHRoZSBjb21wbGV4aXR5IGluIGdvaW5nIHRoZSBvdGhlciB3YXkKCiAgICBjb25zdCB1ID0gdGhpcy5fdXBncmFkZQoKICAgIHRoaXMuX3Jlb3JncyA9IFtdIC8vIGNsZWFyIGFsbCBhcyB0aGUgbm9kZXMgYXJlIGFnYWluc3QgdGhlIG9sZCB0cmVlIC0gZWFzaWVyCiAgICB0aGlzLl9hcHBseWluZ1Jlb3JnID0gdGhpcy5jb3JlLnJlb3JnKGYuYmF0Y2gsIG51bGwpIC8vIFRPRE86IG51bGwgc2hvdWxkIGJlIHRoZSBmaXJzdC9sYXN0IHBlZXI/CgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fYXBwbHlpbmdSZW9yZwogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuX3VwZ3JhZGUgPSBudWxsCiAgICAgIHUucmVqZWN0KGVycikKICAgIH0KCiAgICB0aGlzLl9hcHBseWluZ1Jlb3JnID0gbnVsbAoKICAgIGlmICh0aGlzLl91cGdyYWRlICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX3Jlc29sdmVVcGdyYWRlUmVxdWVzdChudWxsKQogICAgfQoKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSB0aGlzLl91cGRhdGVGb3JrKHBlZXIpCgogICAgLy8gVE9ETzogYWxsIHRoZSByZW1haW5pbmcgaXMgYSB0bXAgd29ya2Fyb3VuZCB1bnRpbCB3ZSBoYXZlIGEgZmxhZy93YXkgZm9yIEFOWV9GT1JLCiAgICBmb3IgKGNvbnN0IHIgb2YgdGhpcy5fcmFuZ2VzKSB7CiAgICAgIHIuc3RhcnQgPSByLnVzZXJTdGFydAogICAgICByLmVuZCA9IHIudXNlckVuZAogICAgfQoKICAgIHRoaXMudXBkYXRlQWxsKCkKICB9CgogIF9tYXliZVVwZGF0ZSgpIHsKICAgIHJldHVybiB0aGlzLl91cGdyYWRlICE9PSBudWxsICYmIHRoaXMuX3VwZ3JhZGUuaW5mbGlnaHQubGVuZ3RoID09PSAwCiAgfQoKICBfbWF5YmVSZXF1ZXN0TWFuaWZlc3QoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLmhlYWRlci5tYW5pZmVzdCA9PT0gbnVsbCAmJiB0aGlzLl9tYW5pZmVzdFBlZXIgPT09IG51bGwKICB9CgogIF91cGRhdGVGb3JrKHBlZXIpIHsKICAgIGlmICgKICAgICAgdGhpcy5fYXBwbHlpbmdSZW9yZyAhPT0gbnVsbCB8fAogICAgICB0aGlzLmFsbG93Rm9yayA9PT0gZmFsc2UgfHwKICAgICAgcGVlci5yZW1vdGVGb3JrIDw9IHRoaXMuY29yZS5zdGF0ZS5mb3JrCiAgICApIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc3QgZiA9IHRoaXMuX2FkZFJlb3JnKHBlZXIucmVtb3RlRm9yaywgcGVlcikKCiAgICAvLyBUT0RPOiBvbmUgcGVyIHBlZXIgaXMgYmV0dGVyCiAgICBpZiAoZiAhPT0gbnVsbCAmJiBmLmJhdGNoID09PSBudWxsICYmIGYuaW5mbGlnaHQubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBwZWVyLl9yZXF1ZXN0Rm9ya1Byb29mKGYpCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBfdXBkYXRlSG90c3dhcChwZWVyKSB7CiAgICBjb25zdCBtYXhIb3Rzd2FwcyA9IHBlZXIuZ2V0TWF4SG90c3dhcEluZmxpZ2h0KCkKICAgIGlmICghcGVlci5pc0FjdGl2ZSgpIHx8IHBlZXIuaW5mbGlnaHQgPj0gbWF4SG90c3dhcHMpIHJldHVybgoKICAgIGZvciAoY29uc3QgYiBvZiB0aGlzLmhvdHN3YXBzLnBpY2socGVlcikpIHsKICAgICAgaWYgKHBlZXIuX3JlcXVlc3RCbG9jayhiKSA9PT0gZmFsc2UpIGNvbnRpbnVlCiAgICAgIHBlZXIuc3RhdHMuaG90c3dhcHMrKwogICAgICBwZWVyLnJlcGxpY2F0b3Iuc3RhdHMuaG90c3dhcHMrKwogICAgICBpZiAocGVlci5pbmZsaWdodCA+PSBtYXhIb3Rzd2FwcykgYnJlYWsKICAgIH0KICB9CgogIF91cGRhdGVQZWVyKHBlZXIpIHsKICAgIGlmICghcGVlci5pc0FjdGl2ZSgpIHx8IHBlZXIuaW5mbGlnaHQgPj0gcGVlci5nZXRNYXhJbmZsaWdodCgpIHx8ICFwZWVyLnJlbW90ZVVwbG9hZGluZykgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICAvLyBFYWdlcmx5IHJlcXVlc3QgdGhlIG1hbmlmZXN0IGV2ZW4gaWYgdGhlIHJlbW90ZSBsZW5ndGggaXMgMC4gSWYgbm90IDAgd2UnbGwgZ2V0IGFzIHBhcnQgb2YgdGhlIHVwZ3JhZGUgcmVxdWVzdC4uLgogICAgaWYgKAogICAgICB0aGlzLl9tYXliZVJlcXVlc3RNYW5pZmVzdCgpID09PSB0cnVlICYmCiAgICAgIHBlZXIucmVtb3RlTGVuZ3RoID09PSAwICYmCiAgICAgIHBlZXIucmVtb3RlSGFzTWFuaWZlc3QgPT09IHRydWUKICAgICkgewogICAgICB0aGlzLl9tYW5pZmVzdFBlZXIgPSBwZWVyCiAgICAgIHBlZXIuX3JlcXVlc3RNYW5pZmVzdCgpCiAgICB9CgogICAgZm9yIChjb25zdCBzIG9mIHRoaXMuX3NlZWtzKSB7CiAgICAgIGlmIChzLmluZmxpZ2h0Lmxlbmd0aCA+IDApIGNvbnRpbnVlIC8vIFRPRE86IG9uZSBwZXIgcGVlciBpcyBiZXR0ZXIKICAgICAgaWYgKHBlZXIuX3JlcXVlc3RTZWVrKHMpID09PSB0cnVlKSB7CiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgfQoKICAgIC8vIEltcGxpZWQgdGhhdCBhbnkgYmxvY2sgaW4gdGhlIHF1ZXVlIHNob3VsZCBiZSByZXF1ZXN0ZWQsIG5vIG1hdHRlciBob3cgbWFueSBpbmZsaWdodHMKICAgIGNvbnN0IGJsa3MgPSBuZXcgUmFuZG9tSXRlcmF0b3IodGhpcy5fcXVldWVkKQoKICAgIGZvciAoY29uc3QgYiBvZiBibGtzKSB7CiAgICAgIGlmIChiLnF1ZXVlZCA9PT0gZmFsc2UgfHwgcGVlci5fcmVxdWVzdEJsb2NrKGIpID09PSB0cnVlKSB7CiAgICAgICAgYi5xdWV1ZWQgPSBmYWxzZQogICAgICAgIGJsa3MuZGVxdWV1ZSgpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX3VwZGF0ZVBlZXJOb25QcmltYXJ5KHBlZXIpIHsKICAgIGlmICghcGVlci5pc0FjdGl2ZSgpIHx8IHBlZXIuaW5mbGlnaHQgPj0gcGVlci5nZXRNYXhJbmZsaWdodCgpIHx8ICFwZWVyLnJlbW90ZVVwbG9hZGluZykgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBjb25zdCByYW5nZXMgPSBuZXcgUmFuZG9tSXRlcmF0b3IodGhpcy5fcmFuZ2VzKQogICAgbGV0IHRyaWVkID0gMAoKICAgIGZvciAoY29uc3QgciBvZiByYW5nZXMpIHsKICAgICAgaWYgKHBlZXIuX3JlcXVlc3RSYW5nZShyKSA9PT0gdHJ1ZSkgewogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgICAgaWYgKCsrdHJpZWQgPj0gTUFYX1JBTkdFUykgYnJlYWsKICAgIH0KCiAgICAvLyBJdGVyYXRlIGZyb20gbmV3ZXN0IGZvcmsgdG8gb2xkZXN0IGZvcmsuLi4KICAgIGZvciAobGV0IGkgPSB0aGlzLl9yZW9yZ3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgZiA9IHRoaXMuX3Jlb3Jnc1tpXQogICAgICBpZiAoZi5iYXRjaCAhPT0gbnVsbCAmJiBmLmluZmxpZ2h0Lmxlbmd0aCA9PT0gMCAmJiBwZWVyLl9yZXF1ZXN0Rm9ya1JhbmdlKGYpID09PSB0cnVlKSB7CiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLl9tYXliZVVwZGF0ZSgpID09PSB0cnVlICYmIHBlZXIuX3JlcXVlc3RVcGdyYWRlKHRoaXMuX3VwZ3JhZGUpID09PSB0cnVlKSB7CiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICB1cGRhdGVQZWVyKHBlZXIpIHsKICAgIC8vIFF1aWNrIHNob3J0Y3V0IHRvIHdhaXQgZm9yIGZsdXNoaW5nIHJlb3JncyAtIG5vdCBuZWVkZWQgYnV0IGxlc3Mgd2Fpc3RlZCByZXF1ZXN0cwogICAgaWYgKHRoaXMuX2FwcGx5aW5nUmVvcmcgIT09IG51bGwpIHJldHVybgoKICAgIHdoaWxlICh0aGlzLl91cGRhdGVQZWVyKHBlZXIpID09PSB0cnVlKTsKICAgIHdoaWxlICh0aGlzLl91cGRhdGVQZWVyTm9uUHJpbWFyeShwZWVyKSA9PT0gdHJ1ZSk7CgogICAgaWYgKHRoaXMucGVlcnMubGVuZ3RoID4gMSAmJiB0aGlzLl9ibG9ja3MuaXNFbXB0eSgpID09PSBmYWxzZSkgewogICAgICB0aGlzLl91cGRhdGVIb3Rzd2FwKHBlZXIpCiAgICB9CgogICAgdGhpcy5fY2hlY2tVcGdyYWRlSWZBdmFpbGFibGUoKQogICAgdGhpcy5fbWF5YmVSZXNvbHZlSWZBdmFpbGFibGVSYW5nZXMoKQogIH0KCiAgdXBkYXRlQWxsKCkgewogICAgLy8gUXVpY2sgc2hvcnRjdXQgdG8gd2FpdCBmb3IgZmx1c2hpbmcgcmVvcmdzIC0gbm90IG5lZWRlZCBidXQgbGVzcyB3YWlzdGVkIHJlcXVlc3RzCiAgICBpZiAodGhpcy5fYXBwbHlpbmdSZW9yZyAhPT0gbnVsbCkgcmV0dXJuCgogICAgY29uc3QgcGVlcnMgPSBuZXcgUmFuZG9tSXRlcmF0b3IodGhpcy5wZWVycykKCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgcGVlcnMpIHsKICAgICAgaWYgKHRoaXMuX3VwZGF0ZVBlZXIocGVlcikgPT09IHRydWUpIHsKICAgICAgICBwZWVycy5yZXF1ZXVlKCkKICAgICAgfQogICAgfQoKICAgIC8vIENoZWNrIGlmIHdlIGNhbiBza2lwIHRoZSBub24gcHJpbWFyeSBjaGVjayBmdWxseQogICAgaWYgKHRoaXMuX21heWJlVXBkYXRlKCkgPT09IGZhbHNlICYmIHRoaXMuX3Jhbmdlcy5sZW5ndGggPT09IDAgJiYgdGhpcy5fcmVvcmdzLmxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLl9jaGVja1VwZ3JhZGVJZkF2YWlsYWJsZSgpCiAgICAgIHJldHVybgogICAgfQoKICAgIGZvciAoY29uc3QgcGVlciBvZiBwZWVycy5yZXN0YXJ0KCkpIHsKICAgICAgaWYgKHRoaXMuX3VwZGF0ZVBlZXJOb25QcmltYXJ5KHBlZXIpID09PSB0cnVlKSB7CiAgICAgICAgcGVlcnMucmVxdWV1ZSgpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9jaGVja1VwZ3JhZGVJZkF2YWlsYWJsZSgpCiAgICB0aGlzLl9tYXliZVJlc29sdmVJZkF2YWlsYWJsZVJhbmdlcygpCiAgfQoKICBvbnBlZXJkZXN0cm95KCkgewogICAgaWYgKC0tdGhpcy5fYWN0aXZlID09PSAwKSB0aGlzLmNvcmUuY2hlY2tJZklkbGUoKQogIH0KCiAgYXR0YWNoZWQocHJvdG9tdXgpIHsKICAgIHJldHVybiB0aGlzLl9hdHRhY2hlZC5oYXMocHJvdG9tdXgpCiAgfQoKICBhdHRhY2hUbyhwcm90b211eCkgewogICAgaWYgKHRoaXMuY29yZS5jbG9zZWQpIHJldHVybgoKICAgIGNvbnN0IG1ha2VQZWVyID0gdGhpcy5fbWFrZVBlZXIuYmluZCh0aGlzLCBwcm90b211eCkKCiAgICB0aGlzLl9hdHRhY2hlZC5hZGQocHJvdG9tdXgpCiAgICBwcm90b211eC5wYWlyKHsgcHJvdG9jb2w6ICdoeXBlcmNvcmUvYWxwaGEnLCBpZDogdGhpcy5jb3JlLmRpc2NvdmVyeUtleSB9LCBtYWtlUGVlcikKICAgIHByb3RvbXV4LnN0cmVhbS5zZXRNYXhMaXN0ZW5lcnMoMCkKICAgIHByb3RvbXV4LnN0cmVhbS5vbignY2xvc2UnLCB0aGlzLl9vbnN0cmVhbWNsb3NlKQoKICAgIHRoaXMuX2lmQXZhaWxhYmxlKysKICAgIHRoaXMuX2FjdGl2ZSsrCgogICAgcHJvdG9tdXguc3RyZWFtLm9wZW5lZC50aGVuKChvcGVuZWQpID0+IHsKICAgICAgdGhpcy5faWZBdmFpbGFibGUtLQogICAgICB0aGlzLl9hY3RpdmUtLQoKICAgICAgaWYgKG9wZW5lZCAmJiAhdGhpcy5kZXN0cm95ZWQpIG1ha2VQZWVyKCkKICAgICAgdGhpcy5fY2hlY2tVcGdyYWRlSWZBdmFpbGFibGUoKQoKICAgICAgdGhpcy5jb3JlLmNoZWNrSWZJZGxlKCkKICAgIH0pCiAgfQoKICBkZXRhY2hGcm9tKHByb3RvbXV4KSB7CiAgICBpZiAodGhpcy5fYXR0YWNoZWQuZGVsZXRlKHByb3RvbXV4KSkgewogICAgICBwcm90b211eC5zdHJlYW0ucmVtb3ZlTGlzdGVuZXIoJ2Nsb3NlJywgdGhpcy5fb25zdHJlYW1jbG9zZSkKICAgICAgcHJvdG9tdXgudW5wYWlyKHsgcHJvdG9jb2w6ICdoeXBlcmNvcmUvYWxwaGEnLCBpZDogdGhpcy5jb3JlLmRpc2NvdmVyeUtleSB9KQogICAgfQogIH0KCiAgaWRsZSgpIHsKICAgIHJldHVybiB0aGlzLnBlZXJzLmxlbmd0aCA9PT0gMCAmJiB0aGlzLl9hY3RpdmUgPT09IDAKICB9CgogIGNsb3NlKCkgewogICAgY29uc3Qgd2FpdGluZyA9IFtdCgogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHsKICAgICAgd2FpdGluZy5wdXNoKHBlZXIuY2hhbm5lbC5mdWxseUNsb3NlZCgpKQogICAgfQoKICAgIHRoaXMuZGVzdHJveSgpCiAgICByZXR1cm4gUHJvbWlzZS5hbGwod2FpdGluZykKICB9CgogIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCgogICAgaWYgKHRoaXMuX2Rvd25sb2FkaW5nVGltZXIpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2Rvd25sb2FkaW5nVGltZXIpCiAgICAgIHRoaXMuX2Rvd25sb2FkaW5nVGltZXIgPSBudWxsCiAgICB9CgogICAgd2hpbGUgKHRoaXMucGVlcnMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IHBlZXIgPSB0aGlzLnBlZXJzW3RoaXMucGVlcnMubGVuZ3RoIC0gMV0KICAgICAgdGhpcy5kZXRhY2hGcm9tKHBlZXIucHJvdG9tdXgpCiAgICAgIHBlZXIuY2hhbm5lbC5jbG9zZSgpIC8vIHBlZXIgaXMgcmVtb3ZlZCBmcm9tIGFycmF5IGluIG9uY2xvc2UKICAgIH0KCiAgICBmb3IgKGNvbnN0IHByb3RvbXV4IG9mIHRoaXMuX2F0dGFjaGVkKSB7CiAgICAgIHRoaXMuZGV0YWNoRnJvbShwcm90b211eCkKICAgIH0KICB9CgogIF9tYWtlUGVlcihwcm90b211eCkgewogICAgY29uc3QgcmVwbGljYXRvciA9IHRoaXMKICAgIGlmIChwcm90b211eC5vcGVuZWQoeyBwcm90b2NvbDogJ2h5cGVyY29yZS9hbHBoYScsIGlkOiB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5IH0pKSB7CiAgICAgIHJldHVybiBvbm5vY2hhbm5lbCgpCiAgICB9CgogICAgY29uc3QgY2hhbm5lbCA9IHByb3RvbXV4LmNyZWF0ZUNoYW5uZWwoewogICAgICB1c2VyRGF0YTogbnVsbCwKICAgICAgcHJvdG9jb2w6ICdoeXBlcmNvcmUvYWxwaGEnLAogICAgICBhbGlhc2VzOiBbJ2h5cGVyY29yZSddLAogICAgICBpZDogdGhpcy5jb3JlLmRpc2NvdmVyeUtleSwKICAgICAgaGFuZHNoYWtlOiBtLndpcmUuaGFuZHNoYWtlLAogICAgICBtZXNzYWdlczogWwogICAgICAgIHsgZW5jb2Rpbmc6IG0ud2lyZS5zeW5jLCBvbm1lc3NhZ2U6IG9ud2lyZXN5bmMgfSwKICAgICAgICB7IGVuY29kaW5nOiBtLndpcmUucmVxdWVzdCwgb25tZXNzYWdlOiBvbndpcmVyZXF1ZXN0IH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLmNhbmNlbCwgb25tZXNzYWdlOiBvbndpcmVjYW5jZWwgfSwKICAgICAgICB7IGVuY29kaW5nOiBtLndpcmUuZGF0YSwgb25tZXNzYWdlOiBvbndpcmVkYXRhIH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLm5vRGF0YSwgb25tZXNzYWdlOiBvbndpcmVub2RhdGEgfSwKICAgICAgICB7IGVuY29kaW5nOiBtLndpcmUud2FudCwgb25tZXNzYWdlOiBvbndpcmV3YW50IH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLnVud2FudCwgb25tZXNzYWdlOiBvbndpcmV1bndhbnQgfSwKICAgICAgICB7IGVuY29kaW5nOiBtLndpcmUuYml0ZmllbGQsIG9ubWVzc2FnZTogb253aXJlYml0ZmllbGQgfSwKICAgICAgICB7IGVuY29kaW5nOiBtLndpcmUucmFuZ2UsIG9ubWVzc2FnZTogb253aXJlcmFuZ2UgfSwKICAgICAgICB7IGVuY29kaW5nOiBtLndpcmUuZXh0ZW5zaW9uLCBvbm1lc3NhZ2U6IG9ud2lyZWV4dGVuc2lvbiB9CiAgICAgIF0sCiAgICAgIG9ub3Blbjogb253aXJlb3BlbiwKICAgICAgb25jbG9zZTogb253aXJlY2xvc2UsCiAgICAgIG9uZHJhaW46IG9ud2lyZWRyYWluLAogICAgICBvbmRlc3Ryb3k6IG9ud2lyZWRlc3Ryb3kKICAgIH0pCgogICAgaWYgKGNoYW5uZWwgPT09IG51bGwpIHJldHVybiBvbm5vY2hhbm5lbCgpCgogICAgY29uc3QgcGVlciA9IG5ldyBQZWVyKHJlcGxpY2F0b3IsIHByb3RvbXV4LCBjaGFubmVsLCB0aGlzLmluZmxpZ2h0UmFuZ2UpCiAgICBjb25zdCBzdHJlYW0gPSBwcm90b211eC5zdHJlYW0KCiAgICBwZWVyLmNoYW5uZWwub3Blbih7CiAgICAgIHNlZWtzOiB0cnVlLAogICAgICBjYXBhYmlsaXR5OiBjYXBzLnJlcGxpY2F0ZShzdHJlYW0uaXNJbml0aWF0b3IsIHRoaXMuY29yZS5rZXksIHN0cmVhbS5oYW5kc2hha2VIYXNoKQogICAgfSkKCiAgICByZXR1cm4gdHJ1ZQoKICAgIGZ1bmN0aW9uIG9ubm9jaGFubmVsKCkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICB9CgogIF9vbnBlZXJ1cGRhdGUoYWRkZWQsIHBlZXIpIHsKICAgIGNvbnN0IG5hbWUgPSBhZGRlZCA/ICdwZWVyLWFkZCcgOiAncGVlci1yZW1vdmUnCiAgICBjb25zdCBzZXNzaW9ucyA9IHRoaXMuY29yZS5tb25pdG9ycwoKICAgIGZvciAobGV0IGkgPSBzZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBzZXNzaW9uc1tpXS5lbWl0KG5hbWUsIHBlZXIpCgogICAgICBpZiAoYWRkZWQpIHsKICAgICAgICBmb3IgKGNvbnN0IGV4dCBvZiBzZXNzaW9uc1tpXS5leHRlbnNpb25zLnZhbHVlcygpKSB7CiAgICAgICAgICBwZWVyLmV4dGVuc2lvbnMuc2V0KGV4dC5uYW1lLCBleHQpCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBfb25kb3dubG9hZChpbmRleCwgYnl0ZUxlbmd0aCwgZnJvbSwgcmVxKSB7CiAgICBjb25zdCBzZXNzaW9ucyA9IHRoaXMuY29yZS5tb25pdG9ycwoKICAgIGZvciAobGV0IGkgPSBzZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBzID0gc2Vzc2lvbnNbaV0KICAgICAgcy5lbWl0KCdkb3dubG9hZCcsIGluZGV4LCBieXRlTGVuZ3RoIC0gcy5wYWRkaW5nLCBmcm9tLCByZXEpCiAgICB9CiAgfQoKICBfb251cGxvYWQoaW5kZXgsIGJ5dGVMZW5ndGgsIGZyb20pIHsKICAgIGNvbnN0IHNlc3Npb25zID0gdGhpcy5jb3JlLm1vbml0b3JzCgogICAgZm9yIChsZXQgaSA9IHNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHMgPSBzZXNzaW9uc1tpXQogICAgICBzLmVtaXQoJ3VwbG9hZCcsIGluZGV4LCBieXRlTGVuZ3RoIC0gcy5wYWRkaW5nLCBmcm9tKQogICAgfQogIH0KCiAgX29uaW52YWxpZGRhdGEoZXJyLCByZXEsIHJlcywgZnJvbSkgewogICAgY29uc3Qgc2Vzc2lvbnMgPSB0aGlzLmNvcmUubW9uaXRvcnMKCiAgICB0aGlzLnN0YXRzLmludmFsaWREYXRhKysKICAgIGZyb20uc3RhdHMuaW52YWxpZERhdGErKwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZXNzaW9ucy5sZW5ndGg7IGkrKykgewogICAgICBzZXNzaW9uc1tpXS5lbWl0KCd2ZXJpZmljYXRpb24tZXJyb3InLCBlcnIsIHJlcSwgcmVzLCBmcm9tKQogICAgfQogIH0KCiAgX29uaW52YWxpZHJlcXVlc3QoZXJyLCByZXEsIGZyb20pIHsKICAgIGNvbnN0IHNlc3Npb25zID0gdGhpcy5jb3JlLm1vbml0b3JzCgogICAgZnJvbS5zdGF0cy5pbnZhbGlkUmVxdWVzdHMrKwogICAgdGhpcy5zdGF0cy5pbnZhbGlkUmVxdWVzdHMrKwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZXNzaW9ucy5sZW5ndGg7IGkrKykgewogICAgICBzZXNzaW9uc1tpXS5lbWl0KCdpbnZhbGlkLXJlcXVlc3QnLCBlcnIsIHJlcSwgZnJvbSkKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHJlbW92ZUhvdHN3YXAoYmxvY2spIHsKICBpZiAoYmxvY2suaG90c3dhcCA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCiAgYmxvY2suaG90c3dhcC5yZWYucmVtb3ZlKGJsb2NrKQogIHJldHVybiB0cnVlCn0KCmZ1bmN0aW9uIHJlbW92ZUluZmxpZ2h0KGluZiwgcmVxKSB7CiAgY29uc3QgaSA9IGluZi5pbmRleE9mKHJlcSkKICBpZiAoaSA9PT0gLTEpIHJldHVybiBmYWxzZQogIGlmIChpIDwgaW5mLmxlbmd0aCAtIDEpIGluZltpXSA9IGluZi5wb3AoKQogIGVsc2UgaW5mLnBvcCgpCiAgcmV0dXJuIHRydWUKfQoKZnVuY3Rpb24gdG9MZW5ndGgoc3RhcnQsIGVuZCkgewogIHJldHVybiBlbmQgPT09IC0xID8gLTEgOiBlbmQgPCBzdGFydCA/IDAgOiBlbmQgLSBzdGFydAp9CgpmdW5jdGlvbiBjbGFtcFJhbmdlKGNvcmUsIHIpIHsKICBpZiAoci5ibG9ja3MgPT09IG51bGwpIHsKICAgIGNvbnN0IHN0YXJ0ID0gY29yZS5iaXRmaWVsZC5maXJzdFVuc2V0KHIuc3RhcnQpCgogICAgaWYgKHIuZW5kID09PSAtMSkgci5zdGFydCA9IHN0YXJ0ID09PSAtMSA/IGNvcmUuc3RhdGUubGVuZ3RoIDogc3RhcnQKICAgIGVsc2UgaWYgKHN0YXJ0ID09PSAtMSB8fCBzdGFydCA+PSByLmVuZCkgci5zdGFydCA9IHIuZW5kCiAgICBlbHNlIHsKICAgICAgci5zdGFydCA9IHN0YXJ0CgogICAgICBjb25zdCBlbmQgPSBjb3JlLmJpdGZpZWxkLmxhc3RVbnNldChyLmVuZCAtIDEpCgogICAgICBpZiAoZW5kID09PSAtMSB8fCBzdGFydCA+PSBlbmQgKyAxKSByLmVuZCA9IHIuc3RhcnQKICAgICAgZWxzZSByLmVuZCA9IGVuZCArIDEKICAgIH0KICB9IGVsc2UgewogICAgd2hpbGUgKHIuc3RhcnQgPCByLmVuZCAmJiBjb3JlLmJpdGZpZWxkLmdldChyLmJsb2Nrc1tyLnN0YXJ0XSkpIHIuc3RhcnQrKwogICAgd2hpbGUgKHIuc3RhcnQgPCByLmVuZCAmJiBjb3JlLmJpdGZpZWxkLmdldChyLmJsb2Nrc1tyLmVuZCAtIDFdKSkgci5lbmQtLQogIH0KfQoKZnVuY3Rpb24gb25yZXF1ZXN0dGltZW91dChyZXEpIHsKICBpZiAocmVxLmNvbnRleHQpIHJlcS5jb250ZXh0LmRldGFjaChyZXEsIFJFUVVFU1RfVElNRU9VVCgpKQp9CgpmdW5jdGlvbiBkZXN0cm95UmVxdWVzdFRpbWVvdXQocmVxKSB7CiAgaWYgKHJlcS50aW1lb3V0ICE9PSBudWxsKSB7CiAgICBjbGVhclRpbWVvdXQocmVxLnRpbWVvdXQpCiAgICByZXEudGltZW91dCA9IG51bGwKICB9Cn0KCmZ1bmN0aW9uIGlzQ3JpdGljYWxFcnJvcihlcnIpIHsKICAvLyBUT0RPOiBleHBvc2UgLmNyaXRpY2FsIG9yIHNpbWlsYXIgb24gdGhlIGh5cGVyY29yZSBlcnJvcnMgdGhhdCBhcmUgY3JpdGljYWwgKGlmIGFsbCBub3QgYXJlKQogIHJldHVybiBlcnIubmFtZSA9PT0gJ0h5cGVyY29yZUVycm9yJwp9CgpmdW5jdGlvbiBvbndpcmVvcGVuKG0sIGMpIHsKICByZXR1cm4gYy51c2VyRGF0YS5vbm9wZW4obSkKfQoKZnVuY3Rpb24gb253aXJlY2xvc2UoaXNSZW1vdGUsIGMpIHsKICByZXR1cm4gYy51c2VyRGF0YS5vbmNsb3NlKGlzUmVtb3RlKQp9CgpmdW5jdGlvbiBvbndpcmVkZXN0cm95KGMpIHsKICBjLnVzZXJEYXRhLnJlcGxpY2F0b3Iub25wZWVyZGVzdHJveSgpCn0KCmZ1bmN0aW9uIG9ud2lyZWRyYWluKGMpIHsKICByZXR1cm4gYy51c2VyRGF0YS5vbmRyYWluKCkKfQoKZnVuY3Rpb24gb253aXJlc3luYyhtLCBjKSB7CiAgaW5jcmVtZW50UngoYy51c2VyRGF0YS5zdGF0cy53aXJlU3luYywgYy51c2VyRGF0YS5yZXBsaWNhdG9yLnN0YXRzLndpcmVTeW5jKQogIHJldHVybiBjLnVzZXJEYXRhLm9uc3luYyhtKQp9CgpmdW5jdGlvbiBvbndpcmVyZXF1ZXN0KG0sIGMpIHsKICBpbmNyZW1lbnRSeChjLnVzZXJEYXRhLnN0YXRzLndpcmVSZXF1ZXN0LCBjLnVzZXJEYXRhLnJlcGxpY2F0b3Iuc3RhdHMud2lyZVJlcXVlc3QpCiAgcmV0dXJuIGMudXNlckRhdGEub25yZXF1ZXN0KG0pCn0KCmZ1bmN0aW9uIG9ud2lyZWNhbmNlbChtLCBjKSB7CiAgaW5jcmVtZW50UngoYy51c2VyRGF0YS5zdGF0cy53aXJlQ2FuY2VsLCBjLnVzZXJEYXRhLnJlcGxpY2F0b3Iuc3RhdHMud2lyZUNhbmNlbCkKICByZXR1cm4gYy51c2VyRGF0YS5vbmNhbmNlbChtKQp9CgpmdW5jdGlvbiBvbndpcmVkYXRhKG0sIGMpIHsKICBpbmNyZW1lbnRSeChjLnVzZXJEYXRhLnN0YXRzLndpcmVEYXRhLCBjLnVzZXJEYXRhLnJlcGxpY2F0b3Iuc3RhdHMud2lyZURhdGEpCiAgcmV0dXJuIGMudXNlckRhdGEub25kYXRhKG0pCn0KCmZ1bmN0aW9uIG9ud2lyZW5vZGF0YShtLCBjKSB7CiAgcmV0dXJuIGMudXNlckRhdGEub25ub2RhdGEobSkKfQoKZnVuY3Rpb24gb253aXJld2FudChtLCBjKSB7CiAgaW5jcmVtZW50UngoYy51c2VyRGF0YS5zdGF0cy53aXJlV2FudCwgYy51c2VyRGF0YS5yZXBsaWNhdG9yLnN0YXRzLndpcmVXYW50KQogIHJldHVybiBjLnVzZXJEYXRhLm9ud2FudChtKQp9CgpmdW5jdGlvbiBvbndpcmV1bndhbnQobSwgYykgewogIHJldHVybiBjLnVzZXJEYXRhLm9udW53YW50KG0pCn0KCmZ1bmN0aW9uIG9ud2lyZWJpdGZpZWxkKG0sIGMpIHsKICBpbmNyZW1lbnRSeChjLnVzZXJEYXRhLnN0YXRzLndpcmVCaXRmaWVsZCwgYy51c2VyRGF0YS5yZXBsaWNhdG9yLnN0YXRzLndpcmVCaXRmaWVsZCkKICByZXR1cm4gYy51c2VyRGF0YS5vbmJpdGZpZWxkKG0pCn0KCmZ1bmN0aW9uIG9ud2lyZXJhbmdlKG0sIGMpIHsKICBpbmNyZW1lbnRSeChjLnVzZXJEYXRhLnN0YXRzLndpcmVSYW5nZSwgYy51c2VyRGF0YS5yZXBsaWNhdG9yLnN0YXRzLndpcmVSYW5nZSkKICByZXR1cm4gYy51c2VyRGF0YS5vbnJhbmdlKG0pCn0KCmZ1bmN0aW9uIG9ud2lyZWV4dGVuc2lvbihtLCBjKSB7CiAgaW5jcmVtZW50UngoYy51c2VyRGF0YS5zdGF0cy53aXJlRXh0ZW5zaW9uLCBjLnVzZXJEYXRhLnJlcGxpY2F0b3Iuc3RhdHMud2lyZUV4dGVuc2lvbikKICByZXR1cm4gYy51c2VyRGF0YS5vbmV4dGVuc2lvbihtKQp9CgpmdW5jdGlvbiBzZXREb3dubG9hZGluZ0xhdGVyKHJlcGwsIGRvd25sb2FkaW5nLCBzZXNzaW9uKSB7CiAgcmVwbC5zZXREb3dubG9hZGluZ05vdyhkb3dubG9hZGluZywgc2Vzc2lvbikKfQoKZnVuY3Rpb24gaXNCbG9ja1JlcXVlc3QocmVxKSB7CiAgcmV0dXJuIHJlcSAhPT0gbnVsbCAmJiByZXEuYmxvY2sgIT09IG51bGwKfQoKZnVuY3Rpb24gaXNVcGdyYWRlUmVxdWVzdChyZXEpIHsKICByZXR1cm4gcmVxICE9PSBudWxsICYmIHJlcS51cGdyYWRlICE9PSBudWxsCn0KCmZ1bmN0aW9uIGluY3JlbWVudFR4KHN0YXRzMSwgc3RhdHMyKSB7CiAgc3RhdHMxLnR4KysKICBzdGF0czIudHgrKwp9CgpmdW5jdGlvbiBpbmNyZW1lbnRSeChzdGF0czEsIHN0YXRzMikgewogIHN0YXRzMS5yeCsrCiAgc3RhdHMyLnJ4KysKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CgpmdW5jdGlvbiBiYWNrb2ZmKHRpbWVzKSB7CiAgY29uc3Qgc2xlZXAgPSB0aW1lcyA8IDIgPyAyMDAgOiB0aW1lcyA8IDUgPyA1MDAgOiB0aW1lcyA8IDQwID8gMTAwMCA6IDUwMDAKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgc2xlZXApKQp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBhc3NlcnQgPSByZXF1aXJlKCduYW5vYXNzZXJ0JykKY29uc3QgZmxhdCA9IHJlcXVpcmUoJ2ZsYXQtdHJlZScpCmNvbnN0IHF1aWNrYml0ID0gcmVxdWlyZSgncXVpY2tiaXQtdW5pdmVyc2FsJykKCmNvbnN0IHsgSU5WQUxJRF9PUEVSQVRJT04sIElOVkFMSURfU0lHTkFUVVJFIH0gPSByZXF1aXJlKCdoeXBlcmNvcmUtZXJyb3JzJykKCmNvbnN0IE11dGV4ID0gcmVxdWlyZSgnLi9tdXRleCcpCmNvbnN0IEJpdGZpZWxkID0gcmVxdWlyZSgnLi9iaXRmaWVsZCcpCmNvbnN0IHsgTWVya2xlVHJlZSwgTWVya2xlVHJlZUJhdGNoIH0gPSByZXF1aXJlKCcuL21lcmtsZS10cmVlJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU2Vzc2lvblN0YXRlIHsKICBjb25zdHJ1Y3Rvcihjb3JlLCBwYXJlbnQsIHN0b3JhZ2UsIHRyZWVJbmZvLCBuYW1lKSB7CiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICB0aGlzLmluZGV4ID0gdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXMucHVzaCh0aGlzKSAtIDEKCiAgICB0aGlzLnN0b3JhZ2UgPSBzdG9yYWdlCiAgICB0aGlzLm5hbWUgPSBuYW1lCiAgICB0aGlzLnNlc3Npb25zID0gW10KCiAgICAvLyBzbWFsbCBoYWNrIHRvIGNsb3NlIG9sZCBzdG9yYWdlcyBhcyBsYXRlIGFzIHBvc3NpYmxlLgogICAgLy8gVE9ETzogYWRkIGEgcmVhZCBsb2NrIHNvIHdlIGNhbiBhdm9pZCB0aGF0CiAgICB0aGlzLmxpbmdlcnMgPSBudWxsCgogICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQKICAgIHRoaXMuYXRvbWl6ZWQgPSBudWxsCiAgICB0aGlzLm11dGV4ID0gbmV3IE11dGV4KCkKCiAgICAvLyBtZXJrbGUgc3RhdGUKICAgIHRoaXMucm9vdHMgPSB0cmVlSW5mby5yb290cy5sZW5ndGggPyB0cmVlSW5mby5yb290cyA6IFtdCiAgICB0aGlzLmZvcmsgPSB0cmVlSW5mby5mb3JrIHx8IDAKICAgIHRoaXMubGVuZ3RoID0gTWVya2xlVHJlZS5zcGFuKHRoaXMucm9vdHMpIC8gMgogICAgdGhpcy5ieXRlTGVuZ3RoID0gTWVya2xlVHJlZS5zaXplKHRoaXMucm9vdHMpCiAgICB0aGlzLnByb2xvZ3VlID0gdHJlZUluZm8ucHJvbG9ndWUgfHwgbnVsbAogICAgdGhpcy5zaWduYXR1cmUgPSB0cmVlSW5mby5zaWduYXR1cmUgfHwgbnVsbAoKICAgIHRoaXMuc25hcHNob3RDb21wYXRMZW5ndGggPSB0aGlzLmlzU25hcHNob3QoKQogICAgICA/IE1hdGgubWluKHRoaXMubGVuZ3RoLCB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoKQogICAgICA6IC0xCiAgICB0aGlzLmxhc3RUcnVuY2F0aW9uID0gbnVsbAoKICAgIHRoaXMuYWN0aXZlID0gMAoKICAgIHRoaXMuX2FjdGl2ZVR4ID0gbnVsbAogICAgdGhpcy5fcGVuZGluZ0JpdGZpZWxkID0gbnVsbAoKICAgIHRoaXMucmVmKCkKICB9CgogIGlzU25hcHNob3QoKSB7CiAgICByZXR1cm4gdGhpcy5zdG9yYWdlLnNuYXBzaG90dGVkCiAgfQoKICBpc0RlZmF1bHQoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLnN0YXRlID09PSB0aGlzIHx8IHRoaXMuaXNBdG9taWNEZWZhdWx0KCkKICB9CgogIGlzQXRvbWljRGVmYXVsdCgpIHsKICAgIHJldHVybiAhIXRoaXMuc3RvcmFnZS5hdG9tICYmICEhdGhpcy5wYXJlbnQgJiYgdGhpcy5wYXJlbnQuaXNEZWZhdWx0KCkKICB9CgogIGNyZWF0ZVRyZWVCYXRjaCgpIHsKICAgIHJldHVybiBuZXcgTWVya2xlVHJlZUJhdGNoKHRoaXMpCiAgfQoKICBhZGRTZXNzaW9uKHMpIHsKICAgIGlmIChzLl9zdGF0ZUluZGV4ICE9PSAtMSkgcmV0dXJuCiAgICBzLl9zdGF0ZUluZGV4ID0gdGhpcy5zZXNzaW9ucy5wdXNoKHMpIC0gMQogICAgaWYgKHMud2VhayA9PT0gZmFsc2UpIHRoaXMuY29yZS5hY3RpdmVTZXNzaW9ucysrCiAgfQoKICByZW1vdmVTZXNzaW9uKHMpIHsKICAgIGlmIChzLl9zdGF0ZUluZGV4ID09PSAtMSkgcmV0dXJuCiAgICBjb25zdCBoZWFkID0gdGhpcy5zZXNzaW9ucy5wb3AoKQogICAgaWYgKGhlYWQgIT09IHMpIHRoaXMuc2Vzc2lvbnNbKGhlYWQuX3N0YXRlSW5kZXggPSBzLl9zdGF0ZUluZGV4KV0gPSBoZWFkCiAgICBzLl9zdGF0ZUluZGV4ID0gLTEKICAgIGlmIChzLndlYWsgPT09IGZhbHNlKSB0aGlzLmNvcmUuYWN0aXZlU2Vzc2lvbnMtLQogICAgdGhpcy5jb3JlLmNoZWNrSWZJZGxlKCkKICB9CgogIGZsdXNoZWRMZW5ndGgoKSB7CiAgICBpZiAodGhpcy5pc0RlZmF1bHQoKSB8fCB0aGlzLmlzU25hcHNob3QoKSkgcmV0dXJuIHRoaXMubGVuZ3RoCiAgICBjb25zdCBkZXBzID0gdGhpcy5zdG9yYWdlLmRlcGVuZGVuY2llcwogICAgaWYgKGRlcHMubGVuZ3RoKSByZXR1cm4gZGVwc1tkZXBzLmxlbmd0aCAtIDFdLmxlbmd0aAogICAgcmV0dXJuIDAKICB9CgogIHNpZ25lZExlbmd0aCgpIHsKICAgIGNvbnN0IGwgPSBNYXRoLm1pbih0aGlzLmZsdXNoZWRMZW5ndGgoKSwgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkKICAgIHJldHVybiB0aGlzLmlzU25hcHNob3QoKSAmJiBsID4gdGhpcy5zbmFwc2hvdENvbXBhdExlbmd0aCA/IHRoaXMuc25hcHNob3RDb21wYXRMZW5ndGggOiBsCiAgfQoKICB1bnJlZigpIHsKICAgIGlmICgtLXRoaXMuYWN0aXZlID4gMCkgcmV0dXJuCiAgICB0aGlzLmNsb3NlKCkuY2F0Y2gobm9vcCkgLy8gdGVjaG5pY2FsbHkgYXN5bmMsIGJ1dCBvbmx5IGZvciB0aGUgbGFzdCBkYiBzZXNzaW9uCiAgfQoKICByZWYoKSB7CiAgICB0aGlzLmFjdGl2ZSsrCiAgICByZXR1cm4gdGhpcwogIH0KCiAgaGFzaCgpIHsKICAgIHJldHVybiBNZXJrbGVUcmVlLmhhc2godGhpcykKICB9CgogIHNldFJvb3RzKHJvb3RzKSB7CiAgICB0aGlzLnJvb3RzID0gcm9vdHMKICAgIHRoaXMubGVuZ3RoID0gTWVya2xlVHJlZS5zcGFuKHJvb3RzKSAvIDIKICAgIHRoaXMuYnl0ZUxlbmd0aCA9IE1lcmtsZVRyZWUuc2l6ZShyb290cykKICB9CgogIGdldCBlbmNyeXB0aW9uRm9yaygpIHsKICAgIHJldHVybiB0aGlzLmNvcmUuaGVhZGVyLnRyZWUuZm9yawogIH0KCiAgYXN5bmMgdXBkYXRlU25hcHNob3RTdG9yYWdlKHN0b3JhZ2UpIHsKICAgIGlmICghdGhpcy5hdG9taXplZCB8fCAhdGhpcy5hdG9taXplZC5mbHVzaGluZykgcmV0dXJuIHRoaXMudHJlZUluZm8oKQogICAgYXdhaXQgdGhpcy5hdG9taXplZC5mbHVzaGVkKCkKCiAgICBsZXQgcnggPSBzdG9yYWdlLnJlYWQoKQogICAgY29uc3QgaGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKICAgIGNvbnN0IGF1dGhQcm9taXNlID0gcnguZ2V0QXV0aCgpCiAgICBjb25zdCBkZXBQcm9taXNlID0gcnguZ2V0RGVwZW5kZW5jeSgpCgogICAgcngudHJ5Rmx1c2goKQogICAgY29uc3QgW2hlYWQsIGF1dGgsIGRlcF0gPSBhd2FpdCBQcm9taXNlLmFsbChbaGVhZFByb21pc2UsIGF1dGhQcm9taXNlLCBkZXBQcm9taXNlXSkKCiAgICBzdG9yYWdlLnNldERlcGVuZGVuY3lIZWFkKGRlcCkKCiAgICBjb25zdCBmb3JrID0gaGVhZCA/IGhlYWQuZm9yayA6IDAKICAgIGNvbnN0IGxlbmd0aCA9IGhlYWQgPyBoZWFkLmxlbmd0aCA6IDAKCiAgICByeCA9IHN0b3JhZ2UucmVhZCgpCiAgICBjb25zdCByb290UHJvbWlzZXMgPSBbXQogICAgZm9yIChjb25zdCByIG9mIGZsYXQuZnVsbFJvb3RzKGxlbmd0aCAqIDIpKSB7CiAgICAgIHJvb3RQcm9taXNlcy5wdXNoKHJ4LmdldFRyZWVOb2RlKHIpKQogICAgfQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCByb290cyA9IGF3YWl0IFByb21pc2UuYWxsKHJvb3RQcm9taXNlcykKCiAgICAvLyBkYmwgY2hlY2sgaWYgd2UgYXJlIGhpdHRpbmcgYW4gcmVncmVzc2lvbiBmcm9tIGVhcmxlcgogICAgZm9yIChjb25zdCByb290IG9mIHJvb3RzKSB7CiAgICAgIGlmIChyb290ID09PSBudWxsKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgJ0JhZCBzbmFwc2hvdCBmcm9tIGF0b21pemVkIHNlc3Npb24sIGlkID0gJyArCiAgICAgICAgICAgIHRoaXMuY29yZS5pZCArCiAgICAgICAgICAgICcgbGVuZ3RoID0gJyArCiAgICAgICAgICAgIGxlbmd0aCArCiAgICAgICAgICAgICcgZm9yayA9ICcgKwogICAgICAgICAgICBmb3JrCiAgICAgICAgKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZm9yaywKICAgICAgcm9vdHMsCiAgICAgIGxlbmd0aCwKICAgICAgcHJvbG9ndWU6IGF1dGgubWFuaWZlc3QgJiYgYXV0aC5tYW5pZmVzdC5wcm9sb2d1ZSwKICAgICAgc2lnbmF0dXJlOiBoZWFkICYmIGhlYWQuc2lnbmF0dXJlCiAgICB9CiAgfQoKICB0cmVlSW5mbygpIHsKICAgIHJldHVybiB7CiAgICAgIGZvcms6IHRoaXMuZm9yaywKICAgICAgcm9vdHM6IHRoaXMucm9vdHMuc2xpY2UoKSwKICAgICAgbGVuZ3RoOiB0aGlzLmxlbmd0aCwKICAgICAgcHJvbG9ndWU6IHRoaXMucHJvbG9ndWUsCiAgICAgIHNpZ25hdHVyZTogdGhpcy5zaWduYXR1cmUKICAgIH0KICB9CgogIGFzeW5jIGNsb3NlKCkgewogICAgaWYgKHRoaXMuaW5kZXggPT09IC0xKSByZXR1cm4KCiAgICB0aGlzLmFjdGl2ZSA9IDAKICAgIHRoaXMubXV0ZXguZGVzdHJveShuZXcgRXJyb3IoJ0Nsb3NlZCcpKS5jYXRjaChub29wKQogICAgaWYgKHRoaXMucGFyZW50ICYmIHRoaXMucGFyZW50LmF0b21pemVkKSB0aGlzLnBhcmVudC5hdG9taXplZCA9IG51bGwKCiAgICBjb25zdCBjbG9zaW5nID0gdGhpcy5zdG9yYWdlLmNsb3NlKCkKCiAgICBjb25zdCBoZWFkID0gdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXMucG9wKCkKICAgIGlmIChoZWFkICE9PSB0aGlzKSB0aGlzLmNvcmUuc2Vzc2lvblN0YXRlc1soaGVhZC5pbmRleCA9IHRoaXMuaW5kZXgpXSA9IGhlYWQKCiAgICB0aGlzLmluZGV4ID0gLTEKICAgIHRoaXMuY29yZS5jaGVja0lmSWRsZSgpCgogICAgaWYgKHRoaXMubGluZ2VycyAhPT0gbnVsbCkgewogICAgICBmb3IgKGNvbnN0IHN0b3JhZ2Ugb2YgdGhpcy5saW5nZXJzKSBhd2FpdCBzdG9yYWdlLmNsb3NlKCkKICAgIH0KCiAgICByZXR1cm4gY2xvc2luZwogIH0KCiAgYXN5bmMgc25hcHNob3QoKSB7CiAgICBjb25zdCBzdG9yYWdlID0gdGhpcy5zdG9yYWdlLnNuYXBzaG90KCkKICAgIGNvbnN0IHRyZWVJbmZvID0gYXdhaXQgdGhpcy51cGRhdGVTbmFwc2hvdFN0b3JhZ2Uoc3RvcmFnZSkKCiAgICBjb25zdCBzID0gbmV3IFNlc3Npb25TdGF0ZSh0aGlzLmNvcmUsIG51bGwsIHN0b3JhZ2UsIHRyZWVJbmZvLCB0aGlzLm5hbWUpCgogICAgcmV0dXJuIHMKICB9CgogIHVwZGF0ZURlcGVuZGVuY3kodHgsIGxlbmd0aCkgewogICAgY29uc3QgZGVwZW5kZW5jeSA9IHVwZGF0ZURlcGVuZGVuY3kodGhpcywgbGVuZ3RoLCBmYWxzZSkKICAgIGlmIChkZXBlbmRlbmN5KSB0eC5zZXREZXBlbmRlbmN5KGRlcGVuZGVuY3kpCiAgICByZXR1cm4gZGVwZW5kZW5jeQogIH0KCiAgX2NsZWFyQWN0aXZlQmF0Y2goKSB7CiAgICB0aGlzLl9hY3RpdmVUeCA9IG51bGwKICB9CgogIGNyZWF0ZVdyaXRlQmF0Y2goKSB7CiAgICBhc3NlcnQoIXRoaXMuX2FjdGl2ZVR4ICYmICF0aGlzLnN0b3JhZ2Uuc25hcHNob3R0ZWQpCgogICAgdGhpcy5fYWN0aXZlVHggPSB0aGlzLnN0b3JhZ2Uud3JpdGUoKQogICAgcmV0dXJuIHRoaXMuX2FjdGl2ZVR4CiAgfQoKICBfdW5sb2NrKCkgewogICAgdGhpcy5fY2xlYXJBY3RpdmVCYXRjaCgpCiAgICB0aGlzLm11dGV4LnVubG9jaygpCiAgICB0aGlzLmNvcmUuY2hlY2tJZklkbGUoKQogIH0KCiAgYXN5bmMgZmx1c2goKSB7CiAgICBjb25zdCB0eCA9IHRoaXMuX2FjdGl2ZVR4CiAgICB0aGlzLl9hY3RpdmVUeCA9IG51bGwKCiAgICB0cnkgewogICAgICBpZiAoIShhd2FpdCB0eC5mbHVzaCgpKSkgcmV0dXJuIGZhbHNlCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl9jbGVhckFjdGl2ZUJhdGNoKCkKICAgIH0KCiAgICB0aGlzLmxhc3RUcnVuY2F0aW9uID0gbnVsbAogICAgcmV0dXJuIHRydWUKICB9CgogIF9wcmVjb21taXQoKSB7CiAgICB0aGlzLmNvbW1pdGluZyA9IHRydWUKICB9CgogIGFzeW5jIF9jb21taXQoKSB7CiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IGJpdGZpZWxkID0gdGhpcy5fcGVuZGluZ0JpdGZpZWxkCiAgICAgIHRoaXMuX3BlbmRpbmdCaXRmaWVsZCA9IG51bGwKICAgICAgdGhpcy5sYXN0VHJ1bmNhdGlvbiA9IG51bGwKICAgICAgYXdhaXQgdGhpcy5wYXJlbnQuX29uY29tbWl0KHRoaXMsIGJpdGZpZWxkKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5jb21taXRpbmcgPSBmYWxzZQogICAgICB0aGlzLm11dGV4LnVubG9jaygpCiAgICB9CiAgfQoKICBhc3luYyBfb25jb21taXQoc3JjLCBiaXRmaWVsZCkgewogICAgYXdhaXQgdGhpcy5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBjb25zdCBjdXJyTGVuZ3RoID0gdGhpcy5sZW5ndGgKCiAgICAgIC8vIGxvYWQgZGVwZW5kZW5jeSBpbnRvIG1lbW9yeQogICAgICBjb25zdCByeCA9IHRoaXMuc3RvcmFnZS5yZWFkKCkKICAgICAgY29uc3QgZGVwZW5kZW5jeVByb21pc2UgPSByeC5nZXREZXBlbmRlbmN5KCkKCiAgICAgIHJ4LnRyeUZsdXNoKCkKCiAgICAgIGNvbnN0IGRlcGVuZGVuY3kgPSBhd2FpdCBkZXBlbmRlbmN5UHJvbWlzZQoKICAgICAgdGhpcy5mb3JrID0gc3JjLmZvcmsKICAgICAgdGhpcy5sZW5ndGggPSBzcmMubGVuZ3RoCiAgICAgIHRoaXMuYnl0ZUxlbmd0aCA9IHNyYy5ieXRlTGVuZ3RoCiAgICAgIHRoaXMucm9vdHMgPSBzcmMucm9vdHMuc2xpY2UoKQogICAgICB0aGlzLnNpZ25hdHVyZSA9IHNyYy5zaWduYXR1cmUKCiAgICAgIGNvbnN0IHRyZWUgPSB7CiAgICAgICAgZm9yazogdGhpcy5mb3JrLAogICAgICAgIGxlbmd0aDogdGhpcy5sZW5ndGgsCiAgICAgICAgcm9vdEhhc2g6IHRoaXMuaGFzaCgpLAogICAgICAgIHNpZ25hdHVyZTogdGhpcy5zaWduYXR1cmUKICAgICAgfQoKICAgICAgaWYgKGRlcGVuZGVuY3kpIHRoaXMuc3RvcmFnZS5zZXREZXBlbmRlbmN5SGVhZChkZXBlbmRlbmN5KQoKICAgICAgY29uc3QgYiA9IGJpdGZpZWxkCgogICAgICBpZiAoYiAmJiBiLnRydW5jYXRlZCAmJiBiLnN0YXJ0IDwgY3Vyckxlbmd0aCkgewogICAgICAgIHRoaXMub250cnVuY2F0ZSh0cmVlLCBiLnN0YXJ0LCBjdXJyTGVuZ3RoLCB0cnVlKQogICAgICAgIGlmICghYiB8fCBiLmFwcGVuZHMgPT09IDApIHJldHVybgogICAgICB9CgogICAgICBjb25zdCBhcHBlbmQgPSBiID8geyBzdGFydDogYi5zdGFydCwgbGVuZ3RoOiBiLmFwcGVuZHMsIGRyb3A6IGZhbHNlIH0gOiBudWxsCgogICAgICB0aGlzLm9uYXBwZW5kKHRyZWUsIGFwcGVuZCwgdHJ1ZSkKCiAgICAgIGlmICh0aGlzLmNvcmUuaGludHNDaGFuZ2VkICYmIHRoaXMuaXNEZWZhdWx0KCkpIGF3YWl0IHRoaXMuY29yZS5mbHVzaEhpbnRzKCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMubXV0ZXgudW5sb2NrKCkKICAgICAgdGhpcy5jb3JlLmNoZWNrSWZJZGxlKCkKICAgIH0KICB9CgogIGFzeW5jIHNldFVzZXJEYXRhKGtleSwgdmFsdWUpIHsKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgY29uc3QgdHggPSB0aGlzLmNyZWF0ZVdyaXRlQmF0Y2goKQogICAgICB0eC5wdXRVc2VyRGF0YShrZXksIHZhbHVlKQoKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZmx1c2goKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fdW5sb2NrKCkKICAgIH0KICB9CgogIGFzeW5jIF92ZXJpZnlCbG9jayhiYXRjaCwgYml0ZmllbGQsIHZhbHVlLCBtYW5pZmVzdCwgZnJvbSkgewogICAgYXdhaXQgdGhpcy5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBpZiAoYmF0Y2gudXBncmFkZWQgJiYgYmF0Y2gubGVuZ3RoIDw9IHRoaXMubGVuZ3RoKSB7CiAgICAgICAgYXdhaXQgYmF0Y2guZG93bmdyYWRlKCkKICAgICAgfQoKICAgICAgaWYgKCFiYXRjaC5jb21taXRhYmxlKCkpIHsKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQoKICAgICAgaWYgKHRoaXMuY29yZS5wcmV1cGRhdGUgIT09IG51bGwpIHsKICAgICAgICBhd2FpdCB0aGlzLmNvcmUucHJldXBkYXRlKGJhdGNoLCB0aGlzLmNvcmUuaGVhZGVyLmtleSkKICAgICAgfQoKICAgICAgY29uc3QgdHggPSB0aGlzLmNyZWF0ZVdyaXRlQmF0Y2goKQogICAgICB0aGlzLnVwZGF0aW5nID0gdHJ1ZQoKICAgICAgaWYgKGJpdGZpZWxkKSB7CiAgICAgICAgdHgucHV0QmxvY2soYml0ZmllbGQuc3RhcnQsIHZhbHVlKQogICAgICB9CgogICAgICBpZiAoYml0ZmllbGQgJiYgdGhpcy5pc0RlZmF1bHQoKSkgewogICAgICAgIGF3YWl0IHN0b3JlQml0ZmllbGRSYW5nZSh0aGlzLnN0b3JhZ2UsIHR4LCBiaXRmaWVsZC5zdGFydCwgYml0ZmllbGQuc3RhcnQgKyAxLCB0cnVlKQogICAgICB9CgogICAgICBpZiAobWFuaWZlc3QpIHRoaXMuY29yZS5fc2V0TWFuaWZlc3QodHgsIG1hbmlmZXN0LCBudWxsKQoKICAgICAgYXNzZXJ0KGJhdGNoLmNvbW1pdGFibGUoKSwgJ1Nob3VsZCBzdGlsbCBiZSBjb21taXRhYmxlJykKICAgICAgYmF0Y2guY29tbWl0KHR4KQoKICAgICAgY29uc3QgaGVhZCA9IHsKICAgICAgICBmb3JrOiBiYXRjaC5mb3JrLAogICAgICAgIGxlbmd0aDogYmF0Y2gubGVuZ3RoLAogICAgICAgIHJvb3RIYXNoOiBiYXRjaC5oYXNoKCksCiAgICAgICAgc2lnbmF0dXJlOiBiYXRjaC5zaWduYXR1cmUKICAgICAgfQoKICAgICAgaWYgKGJhdGNoLnVwZ3JhZGVkKSB0eC5zZXRIZWFkKGhlYWQpCgogICAgICBjb25zdCBmbHVzaGVkID0gYXdhaXQgdGhpcy5mbHVzaCgpCgogICAgICBpZiAoYmF0Y2gudXBncmFkZWQpIHsKICAgICAgICB0aGlzLnJvb3RzID0gYmF0Y2gucm9vdHMKICAgICAgICB0aGlzLmxlbmd0aCA9IGJhdGNoLmxlbmd0aAogICAgICAgIHRoaXMuYnl0ZUxlbmd0aCA9IGJhdGNoLmJ5dGVMZW5ndGgKICAgICAgICB0aGlzLmZvcmsgPSBiYXRjaC5mb3JrCiAgICAgICAgdGhpcy5zaWduYXR1cmUgPSBiYXRjaC5zaWduYXR1cmUKCiAgICAgICAgdGhpcy5vbmFwcGVuZChoZWFkLCBiaXRmaWVsZCwgZmx1c2hlZCkKICAgICAgfQoKICAgICAgaWYgKHRoaXMuY29yZS5oaW50c0NoYW5nZWQgJiYgdGhpcy5pc0RlZmF1bHQoKSkgYXdhaXQgdGhpcy5jb3JlLmZsdXNoSGludHMoKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fY2xlYXJBY3RpdmVCYXRjaCgpCiAgICAgIHRoaXMudXBkYXRpbmcgPSBmYWxzZQogICAgICB0aGlzLm11dGV4LnVubG9jaygpCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIHRydW5jYXRlKGxlbmd0aCwgZm9yaywgeyBzaWduYXR1cmUsIGtleVBhaXIgfSA9IHt9KSB7CiAgICBpZiAoIWtleVBhaXIgJiYgdGhpcy5pc0RlZmF1bHQoKSkga2V5UGFpciA9IHRoaXMuY29yZS5oZWFkZXIua2V5UGFpcgoKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgaWYgKHRoaXMucHJvbG9ndWUgJiYgbGVuZ3RoIDwgdGhpcy5wcm9sb2d1ZS5sZW5ndGgpIHsKICAgICAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTignVHJ1bmNhdGlvbiBicmVha3MgcHJvbG9ndWUnLCB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5KQogICAgICB9CiAgICAgIGlmIChsZW5ndGggPiB0aGlzLmxlbmd0aCkgewogICAgICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKAogICAgICAgICAgJ05vdCBhIHRydW5jYXRpb24sICcgKyBsZW5ndGggKyAnIG11c3QgYmUgbGVzcyBvciBlcXVhbCB0byAnICsgdGhpcy5sZW5ndGgsCiAgICAgICAgICB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5CiAgICAgICAgKQogICAgICB9CgogICAgICBjb25zdCBiYXRjaCA9IHRoaXMuY3JlYXRlVHJlZUJhdGNoKCkKICAgICAgYXdhaXQgTWVya2xlVHJlZS50cnVuY2F0ZSh0aGlzLCBsZW5ndGgsIGJhdGNoLCBmb3JrKQoKICAgICAgaWYgKCFzaWduYXR1cmUgJiYga2V5UGFpciAmJiBsZW5ndGggPiAwKSBzaWduYXR1cmUgPSB0aGlzLmNvcmUudmVyaWZpZXIuc2lnbihiYXRjaCwga2V5UGFpcikKICAgICAgaWYgKHNpZ25hdHVyZSkgYmF0Y2guc2lnbmF0dXJlID0gc2lnbmF0dXJlCgogICAgICBjb25zdCB0eCA9IHRoaXMuY3JlYXRlV3JpdGVCYXRjaCgpCgogICAgICAvLyB1cHNlcnQgY29tcGF0IG1hbmlmZXN0CiAgICAgIGlmICh0aGlzLmNvcmUudmVyaWZpZXIgPT09IG51bGwgJiYga2V5UGFpcikgdGhpcy5jb3JlLl9zZXRNYW5pZmVzdCh0eCwgbnVsbCwga2V5UGFpcikKCiAgICAgIGNvbnN0IHsgZGVwZW5kZW5jeSwgdHJlZSwgcm9vdHMgfSA9IGF3YWl0IHRoaXMuX3RydW5jYXRlKHR4LCBiYXRjaCkKCiAgICAgIGZvciAoY29uc3Qgc2Vzc2lvblN0YXRlIG9mIHRoaXMuY29yZS5zZXNzaW9uU3RhdGVzKSB7CiAgICAgICAgaWYgKAogICAgICAgICAgc2Vzc2lvblN0YXRlLmlzU25hcHNob3QoKSAmJgogICAgICAgICAgc2Vzc2lvblN0YXRlLm5hbWUgPT09IHRoaXMubmFtZSAmJgogICAgICAgICAgbGVuZ3RoIDwgc2Vzc2lvblN0YXRlLnNuYXBzaG90Q29tcGF0TGVuZ3RoCiAgICAgICAgKSB7CiAgICAgICAgICBzZXNzaW9uU3RhdGUuc25hcHNob3RDb21wYXRMZW5ndGggPSBsZW5ndGgKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IGZsdXNoZWQgPSBhd2FpdCB0aGlzLmZsdXNoKCkKCiAgICAgIHRoaXMuZm9yayA9IHRyZWUuZm9yawogICAgICB0aGlzLmxlbmd0aCA9IHRyZWUubGVuZ3RoCiAgICAgIHRoaXMuYnl0ZUxlbmd0aCA9IE1lcmtsZVRyZWUuc2l6ZShyb290cykKICAgICAgdGhpcy5yb290cyA9IHJvb3RzCiAgICAgIHRoaXMuc2lnbmF0dXJlID0gdHJlZS5zaWduYXR1cmUKCiAgICAgIGlmIChkZXBlbmRlbmN5KSB0aGlzLnN0b3JhZ2Uuc2V0RGVwZW5kZW5jeUhlYWQoZGVwZW5kZW5jeSkKCiAgICAgIHRoaXMub250cnVuY2F0ZSh0cmVlLCB0cmVlLmxlbmd0aCwgYmF0Y2gudHJlZUxlbmd0aCwgZmx1c2hlZCkKCiAgICAgIGlmICh0aGlzLmNvcmUuaGludHNDaGFuZ2VkICYmIHRoaXMuaXNEZWZhdWx0KCkpIGF3YWl0IHRoaXMuY29yZS5mbHVzaEhpbnRzKCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX3VubG9jaygpCiAgICB9CiAgfQoKICBhc3luYyByZW9yZyhiYXRjaCkgewogICAgYXdhaXQgdGhpcy5tdXRleC5sb2NrKCkKCiAgICBjb25zdCBzdG9yYWdlID0gdGhpcy5jcmVhdGVXcml0ZUJhdGNoKCkKCiAgICB0cnkgewogICAgICBpZiAoIWJhdGNoLmNvbW1pdGFibGUoKSkgcmV0dXJuIGZhbHNlCgogICAgICBjb25zdCB7IGRlcGVuZGVuY3ksIHRyZWUgfSA9IGF3YWl0IHRoaXMuX3RydW5jYXRlKHN0b3JhZ2UsIGJhdGNoKQoKICAgICAgY29uc3QgZmx1c2hlZCA9IGF3YWl0IHRoaXMuZmx1c2goKQoKICAgICAgdGhpcy5mb3JrID0gYmF0Y2guZm9yawogICAgICB0aGlzLmxlbmd0aCA9IGJhdGNoLmxlbmd0aAogICAgICB0aGlzLmJ5dGVMZW5ndGggPSBiYXRjaC5ieXRlTGVuZ3RoCiAgICAgIHRoaXMucm9vdHMgPSBiYXRjaC5yb290cwogICAgICB0aGlzLnNpZ25hdHVyZSA9IGJhdGNoLnNpZ25hdHVyZQoKICAgICAgaWYgKGRlcGVuZGVuY3kpIHRoaXMuc3RvcmFnZS5zZXREZXBlbmRlbmN5SGVhZChkZXBlbmRlbmN5KQoKICAgICAgdGhpcy5vbnRydW5jYXRlKHRyZWUsIGJhdGNoLmFuY2VzdG9ycywgYmF0Y2gudHJlZUxlbmd0aCwgZmx1c2hlZCkKCiAgICAgIGlmICh0aGlzLmNvcmUuaGludHNDaGFuZ2VkICYmIHRoaXMuaXNEZWZhdWx0KCkpIGF3YWl0IHRoaXMuY29yZS5mbHVzaEhpbnRzKCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX3VubG9jaygpCiAgICB9CiAgfQoKICBhc3luYyBfdHJ1bmNhdGUoc3RvcmFnZSwgYmF0Y2gpIHsKICAgIHN0b3JhZ2UuZGVsZXRlQmxvY2tSYW5nZShiYXRjaC5hbmNlc3RvcnMsIGJhdGNoLnRyZWVMZW5ndGgpCgogICAgYXNzZXJ0KGJhdGNoLmNvbW1pdGFibGUoKSwgJ0JhdGNoIG11c3QgYmUgY29tbWl0YWJsZScpCgogICAgY29uc3QgdHJlZSA9IHsKICAgICAgZm9yazogYmF0Y2guZm9yaywKICAgICAgbGVuZ3RoOiBiYXRjaC5sZW5ndGgsCiAgICAgIHJvb3RIYXNoOiBiYXRjaC5oYXNoKCksCiAgICAgIHNpZ25hdHVyZTogYmF0Y2guc2lnbmF0dXJlCiAgICB9CgogICAgc3RvcmFnZS5zZXRIZWFkKHRyZWUpCiAgICBiYXRjaC5jb21taXQoc3RvcmFnZSkKCiAgICBjb25zdCB0cnVuY2F0ZWQgPSBiYXRjaC5sZW5ndGggPCB0aGlzLmZsdXNoZWRMZW5ndGgoKQogICAgY29uc3QgZGVwZW5kZW5jeSA9IHRydW5jYXRlZCA/IHVwZGF0ZURlcGVuZGVuY3kodGhpcywgYmF0Y2gubGVuZ3RoLCB0cnVlKSA6IG51bGwKCiAgICBpZiAoZGVwZW5kZW5jeSkgc3RvcmFnZS5zZXREZXBlbmRlbmN5KGRlcGVuZGVuY3kpCgogICAgaWYgKHRoaXMuaXNEZWZhdWx0KCkpIHsKICAgICAgYXdhaXQgc3RvcmVCaXRmaWVsZFJhbmdlKHRoaXMuc3RvcmFnZSwgc3RvcmFnZSwgYmF0Y2guYW5jZXN0b3JzLCBiYXRjaC50cmVlTGVuZ3RoLCBmYWxzZSkKICAgICAgaWYgKGJhdGNoLmFuY2VzdG9ycyA8IHRoaXMuY29yZS5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCkgewogICAgICAgIHRoaXMuY29yZS5oZWFkZXIuaGludHMucmVtb3RlQ29udGlndW91c0xlbmd0aCA9IE1hdGgubWluKAogICAgICAgICAgYmF0Y2gubGVuZ3RoLAogICAgICAgICAgdGhpcy5jb3JlLmhlYWRlci5oaW50cy5yZW1vdGVDb250aWd1b3VzTGVuZ3RoCiAgICAgICAgKQogICAgICAgIHN0b3JhZ2Uuc2V0SGludHMoewogICAgICAgICAgY29udGlndW91c0xlbmd0aDogYmF0Y2guYW5jZXN0b3JzLAogICAgICAgICAgcmVtb3RlQ29udGlndW91c0xlbmd0aDogdGhpcy5jb3JlLmhlYWRlci5oaW50cy5yZW1vdGVDb250aWd1b3VzTGVuZ3RoCiAgICAgICAgfSkKICAgICAgfQogICAgfQoKICAgIHJldHVybiB7IGRlcGVuZGVuY3ksIHRyZWUsIHJvb3RzOiBiYXRjaC5yb290cyB9CiAgfQoKICBhc3luYyBjbGVhcihzdGFydCwgZW5kLCBjbGVhcmVkKSB7CiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHR4ID0gdGhpcy5jcmVhdGVXcml0ZUJhdGNoKCkKCiAgICAgIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3Ioc3RhcnQgKiAyKQogICAgICB3aGlsZSAoIWlzUm9vdEluZGV4KGl0ZS5pbmRleCwgdGhpcy5yb290cykpIHsKICAgICAgICBjb25zdCBhID0gaXRlLmluZGV4CiAgICAgICAgY29uc3QgYiA9IGl0ZS5zaWJsaW5nKCkKICAgICAgICBpdGUucGFyZW50KCkKCiAgICAgICAgY29uc3QgW2xlZnQsIHJpZ2h0XSA9IGZsYXQuc3BhbnMoYikKICAgICAgICBjb25zdCBzID0gbGVmdCAvIDIKICAgICAgICBjb25zdCBlID0gcmlnaHQgLyAyICsgMQogICAgICAgIGNvbnN0IGhhcyA9IHMgPD0gc3RhcnQgJiYgZSA8PSBlbmQgPyBmYWxzZSA6IHRoaXMuY29yZS5iaXRmaWVsZC5oYXNTZXQocywgZSAtIHMpCiAgICAgICAgaWYgKGhhcykgYnJlYWsKCiAgICAgICAgdHguZGVsZXRlVHJlZU5vZGUoYSkKICAgICAgICB0eC5kZWxldGVUcmVlTm9kZShiKQogICAgICB9CgogICAgICBpZiAodGhpcy5pc0RlZmF1bHQoKSkgewogICAgICAgIGF3YWl0IHN0b3JlQml0ZmllbGRSYW5nZSh0aGlzLnN0b3JhZ2UsIHR4LCBzdGFydCwgZW5kLCBmYWxzZSkKICAgICAgICBpZiAoc3RhcnQgPCB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgpIHsKICAgICAgICAgIHR4LnNldEhpbnRzKHsKICAgICAgICAgICAgY29udGlndW91c0xlbmd0aDogc3RhcnQsCiAgICAgICAgICAgIHJlbW90ZUNvbnRpZ3VvdXNMZW5ndGg6IHRoaXMuY29yZS5oZWFkZXIuaGludHMucmVtb3RlQ29udGlndW91c0xlbmd0aAogICAgICAgICAgfSkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChlbmQgLSBzdGFydCA9PT0gMSkgdHguZGVsZXRlQmxvY2soc3RhcnQpCiAgICAgIGVsc2UgdHguZGVsZXRlQmxvY2tSYW5nZShzdGFydCwgZW5kKQoKICAgICAgY29uc3QgZGVwZW5kZW5jeSA9IHN0YXJ0IDwgdGhpcy5mbHVzaGVkTGVuZ3RoKCkgPyB1cGRhdGVEZXBlbmRlbmN5KHRoaXMsIHN0YXJ0LCB0cnVlKSA6IG51bGwKCiAgICAgIGNvbnN0IGZsdXNoZWQgPSBhd2FpdCB0aGlzLmZsdXNoKCkKCiAgICAgIGlmIChkZXBlbmRlbmN5KSB0aGlzLnN0b3JhZ2Uuc2V0RGVwZW5kZW5jeUhlYWQoZGVwZW5kZW5jeSkKCiAgICAgIC8vIHRvZG86IGF0b21pYyBldmVudCBoYW5kbGUKICAgICAgaWYgKHRoaXMuaXNEZWZhdWx0KCkgJiYgZmx1c2hlZCkgewogICAgICAgIGNvbnN0IGxlbmd0aCA9IGVuZCAtIHN0YXJ0CgogICAgICAgIHRoaXMuY29yZS51cGRhdGVDb250aWd1b3VzTGVuZ3RoKHsgc3RhcnQsIGxlbmd0aCwgZHJvcDogdHJ1ZSB9KQogICAgICAgIHRoaXMuY29yZS5fc2V0Qml0ZmllbGRSYW5nZXMoc3RhcnQsIGVuZCwgZmFsc2UpCiAgICAgICAgdGhpcy5jb3JlLnJlcGxpY2F0b3Iub25oYXZlKHN0YXJ0LCBsZW5ndGgsIHRydWUpCgogICAgICAgIGlmICh0aGlzLmNvcmUuaGludHNDaGFuZ2VkKSBhd2FpdCB0aGlzLmNvcmUuZmx1c2hIaW50cygpCiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX3VubG9jaygpCiAgICB9CiAgfQoKICBhc3luYyBhcHBlbmQodmFsdWVzLCB7IHNpZ25hdHVyZSwga2V5UGFpciwgcHJlYXBwZW5kLCBwb3N0YXBwZW5kLCBtYXhMZW5ndGggPSAtMSB9ID0ge30pIHsKICAgIGlmICgha2V5UGFpciAmJiB0aGlzLmlzRGVmYXVsdCgpKSBrZXlQYWlyID0gdGhpcy5jb3JlLmhlYWRlci5rZXlQYWlyCgogICAgYXdhaXQgdGhpcy5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBpZiAobWF4TGVuZ3RoID49IDAgJiYgdGhpcy5sZW5ndGggKyB2YWx1ZXMubGVuZ3RoID4gbWF4TGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIHsgbGVuZ3RoOiB0aGlzLmxlbmd0aCwgYnl0ZUxlbmd0aDogdGhpcy5ieXRlTGVuZ3RoIH0KICAgICAgfQoKICAgICAgY29uc3QgdHggPSB0aGlzLmNyZWF0ZVdyaXRlQmF0Y2goKQoKICAgICAgLy8gdXBzZXJ0IGNvbXBhdCBtYW5pZmVzdAogICAgICBpZiAodGhpcy5jb3JlLnZlcmlmaWVyID09PSBudWxsICYmIGtleVBhaXIpIHRoaXMuY29yZS5fc2V0TWFuaWZlc3QodHgsIG51bGwsIGtleVBhaXIpCgogICAgICBpZiAocHJlYXBwZW5kKSBhd2FpdCBwcmVhcHBlbmQodmFsdWVzKQoKICAgICAgaWYgKCF2YWx1ZXMubGVuZ3RoKSB7CiAgICAgICAgYXdhaXQgdGhpcy5mbHVzaCgpCiAgICAgICAgcmV0dXJuIHsgbGVuZ3RoOiB0aGlzLmxlbmd0aCwgYnl0ZUxlbmd0aDogdGhpcy5ieXRlTGVuZ3RoIH0KICAgICAgfQoKICAgICAgY29uc3QgYmF0Y2ggPSB0aGlzLmNyZWF0ZVRyZWVCYXRjaCgpCiAgICAgIGZvciAoY29uc3QgdmFsIG9mIHZhbHVlcykgYmF0Y2guYXBwZW5kKHZhbCkKCiAgICAgIC8vIG9ubHkgbXVsdGlzaWcgY2FuIGhhdmUgcHJvbG9ndWUgc28gc2lnbmF0dXJlIGlzIGFsd2F5cyBwcmVzZW50CiAgICAgIGlmICh0aGlzLnByb2xvZ3VlICYmIGJhdGNoLmxlbmd0aCA8IHRoaXMucHJvbG9ndWUubGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0FwcGVuZCBpcyBub3QgY29uc2lzdGVudCB3aXRoIHByb2xvZ3VlJywgdGhpcy5jb3JlLmRpc2NvdmVyeUtleSkKICAgICAgfQoKICAgICAgaWYgKCFzaWduYXR1cmUgJiYga2V5UGFpcikgc2lnbmF0dXJlID0gdGhpcy5jb3JlLnZlcmlmaWVyLnNpZ24oYmF0Y2gsIGtleVBhaXIpCiAgICAgIGlmIChzaWduYXR1cmUpIGJhdGNoLnNpZ25hdHVyZSA9IHNpZ25hdHVyZQoKICAgICAgYmF0Y2guY29tbWl0KHR4KQoKICAgICAgY29uc3QgdHJlZSA9IHsKICAgICAgICBmb3JrOiBiYXRjaC5mb3JrLAogICAgICAgIGxlbmd0aDogYmF0Y2gubGVuZ3RoLAogICAgICAgIHJvb3RIYXNoOiBiYXRjaC5oYXNoKCksCiAgICAgICAgc2lnbmF0dXJlOiBiYXRjaC5zaWduYXR1cmUKICAgICAgfQoKICAgICAgdHguc2V0SGVhZCh0cmVlKQoKICAgICAgaWYgKHRoaXMuaXNEZWZhdWx0KCkpIHsKICAgICAgICBhd2FpdCBzdG9yZUJpdGZpZWxkUmFuZ2UodGhpcy5zdG9yYWdlLCB0eCwgYmF0Y2guYW5jZXN0b3JzLCBiYXRjaC5sZW5ndGgsIHRydWUpCiAgICAgICAgaWYgKHRoaXMubGVuZ3RoID09PSB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgpIHsKICAgICAgICAgIHR4LnNldEhpbnRzKHsKICAgICAgICAgICAgY29udGlndW91c0xlbmd0aDogdGhpcy5sZW5ndGggKyB2YWx1ZXMubGVuZ3RoLAogICAgICAgICAgICByZW1vdGVDb250aWd1b3VzTGVuZ3RoOiB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgKICAgICAgICAgIH0pCiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHR4LnB1dEJsb2NrKHRoaXMubGVuZ3RoICsgaSwgdmFsdWVzW2ldKQogICAgICB9CgogICAgICBjb25zdCBiaXRmaWVsZCA9IHsKICAgICAgICBkcm9wOiBmYWxzZSwKICAgICAgICBzdGFydDogYmF0Y2guYW5jZXN0b3JzLAogICAgICAgIGxlbmd0aDogdmFsdWVzLmxlbmd0aAogICAgICB9CgogICAgICBjb25zdCBmbHVzaGVkID0gYXdhaXQgdGhpcy5mbHVzaCgpCgogICAgICB0aGlzLmZvcmsgPSBiYXRjaC5mb3JrCiAgICAgIHRoaXMucm9vdHMgPSBiYXRjaC5yb290cwogICAgICB0aGlzLmxlbmd0aCA9IGJhdGNoLmxlbmd0aAogICAgICB0aGlzLmJ5dGVMZW5ndGggPSBiYXRjaC5ieXRlTGVuZ3RoCiAgICAgIHRoaXMuc2lnbmF0dXJlID0gYmF0Y2guc2lnbmF0dXJlCgogICAgICBpZiAocG9zdGFwcGVuZCkgYXdhaXQgcG9zdGFwcGVuZCh2YWx1ZXMpCgogICAgICB0aGlzLm9uYXBwZW5kKHRyZWUsIGJpdGZpZWxkLCBmbHVzaGVkKQoKICAgICAgaWYgKHRoaXMuY29yZS5oaW50c0NoYW5nZWQgJiYgdGhpcy5pc0RlZmF1bHQoKSkgYXdhaXQgdGhpcy5jb3JlLmZsdXNoSGludHMoKQoKICAgICAgcmV0dXJuIHsgbGVuZ3RoOiB0aGlzLmxlbmd0aCwgYnl0ZUxlbmd0aDogdGhpcy5ieXRlTGVuZ3RoIH0KICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX3VubG9jaygpCiAgICB9CiAgfQoKICBvbmFwcGVuZCh0cmVlLCBiaXRmaWVsZCwgZmx1c2hlZCkgewogICAgaWYgKCFmbHVzaGVkKSB0aGlzLl91cGRhdGVCaXRmaWVsZChiaXRmaWVsZCkKICAgIGVsc2UgaWYgKHRoaXMuaXNEZWZhdWx0KCkpIHRoaXMuY29yZS5vbmFwcGVuZCh0cmVlLCBiaXRmaWVsZCkKCiAgICBmb3IgKGxldCBpID0gdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICB0aGlzLnNlc3Npb25zW2ldLmVtaXQoJ2FwcGVuZCcpCiAgICB9CiAgfQoKICBvbnRydW5jYXRlKHRyZWUsIHRvLCBmcm9tLCBmbHVzaGVkKSB7CiAgICBjb25zdCBiaXRmaWVsZCA9IHsgc3RhcnQ6IHRvLCBsZW5ndGg6IGZyb20gLSB0bywgZHJvcDogdHJ1ZSB9CgogICAgdGhpcy5sYXN0VHJ1bmNhdGlvbiA9IHsgZnJvbSwgdG8gfQoKICAgIGlmICghZmx1c2hlZCkgdGhpcy5fdXBkYXRlQml0ZmllbGQoYml0ZmllbGQpCiAgICBlbHNlIGlmICh0aGlzLmlzRGVmYXVsdCgpKSB0aGlzLmNvcmUub250cnVuY2F0ZSh0cmVlLCBiaXRmaWVsZCkKCiAgICBmb3IgKGNvbnN0IHNlc3Npb25TdGF0ZSBvZiB0aGlzLmNvcmUuc2Vzc2lvblN0YXRlcykgewogICAgICBpZiAoCiAgICAgICAgc2Vzc2lvblN0YXRlLmlzU25hcHNob3QoKSAmJgogICAgICAgIHNlc3Npb25TdGF0ZS5uYW1lID09PSB0aGlzLm5hbWUgJiYKICAgICAgICB0byA8IHNlc3Npb25TdGF0ZS5zbmFwc2hvdENvbXBhdExlbmd0aAogICAgICApIHsKICAgICAgICBzZXNzaW9uU3RhdGUuc25hcHNob3RDb21wYXRMZW5ndGggPSB0bwogICAgICB9CiAgICB9CgogICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgdGhpcy5zZXNzaW9uc1tpXS5lbWl0KCd0cnVuY2F0ZScsIHRvLCB0cmVlLmZvcmspCiAgICB9CiAgfQoKICBfdXBkYXRlQml0ZmllbGQoYml0ZmllbGQsIGZsdXNoZWQpIHsKICAgIGlmICghYml0ZmllbGQpIHJldHVybgoKICAgIGNvbnN0IHAgPSB0aGlzLl9wZW5kaW5nQml0ZmllbGQKICAgIGNvbnN0IGIgPSBiaXRmaWVsZAoKICAgIGlmIChiLmRyb3ApIHsKICAgICAgLy8gdHJ1bmNhdGlvbiBtdXN0IGJlIGZyb20gZW5kCiAgICAgIGlmIChwICYmIGIuc3RhcnQgKyBiLmxlbmd0aCAhPT0gcC5zdGFydCArIHAuYXBwZW5kcykgewogICAgICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdBdG9taWMgdHJ1bmNhdGlvbnMgbXVzdCBiZSBjb250aWd1b3VzJywgdGhpcy5jb3JlLmRpc2NvdmVyeUtleSkKICAgICAgfQoKICAgICAgLy8gYWN0dWFsIHRydW5jYXRpb24KICAgICAgaWYgKHAgPT09IG51bGwgfHwgYi5zdGFydCA8IHAuc3RhcnQpIHsKICAgICAgICB0aGlzLl9wZW5kaW5nQml0ZmllbGQgPSB7IHRydW5jYXRlZDogdHJ1ZSwgc3RhcnQ6IGIuc3RhcnQsIGFwcGVuZHM6IDAgfQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICAvLyBqdXN0IGNsZWFyaW5nIGJhdGNoIGRhdGEKICAgICAgcC5hcHBlbmRzID0gYi5zdGFydCAtIHAuc3RhcnQKCiAgICAgIC8vIHdlIGNsZWFyZWQgdGhlIGN1cnJlbnQgYmF0Y2gKICAgICAgaWYgKHAuYXBwZW5kcyA9PT0gMCkgdGhpcy5fcGVuZGluZ0JpdGZpZWxkID0gbnVsbAoKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHAgPT09IG51bGwpIHsKICAgICAgdGhpcy5fcGVuZGluZ0JpdGZpZWxkID0geyB0cnVuY2F0ZWQ6IGZhbHNlLCBzdGFydDogYi5zdGFydCwgYXBwZW5kczogYi5sZW5ndGggfQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoYi5zdGFydCAhPT0gcC5zdGFydCArIHAuYXBwZW5kcykgewogICAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTignQXRvbWljIG9wZXJhdGlvbnMgbXVzdCBiZSBjb250aWd1b3VzJywgdGhpcy5jb3JlLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICBwLmFwcGVuZHMgKz0gYi5sZW5ndGgKICB9CgogIGFzeW5jIGNhdGNodXAobGVuZ3RoKSB7CiAgICBhc3NlcnQoIXRoaXMuaXNEZWZhdWx0KCksICdDYW5ub3QgY2F0Y2h1cCBzaWduZWQgc3RhdGUnKSAvLyBUT0RPOiBtYWtlIHRoaXMgY2hlY2sgYmV0dGVyCgogICAgYXdhaXQgdGhpcy5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBjb25zdCBvcmlnTGVuZ3RoID0gdGhpcy5sZW5ndGgKCiAgICAgIGxldCBzaGFyZWRMZW5ndGggPSAwCiAgICAgIGZvciAobGV0IGkgPSB0aGlzLnN0b3JhZ2UuZGVwZW5kZW5jaWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgY29uc3QgZGVwID0gdGhpcy5zdG9yYWdlLmRlcGVuZGVuY2llc1tpXQogICAgICAgIGlmIChkZXAuZGF0YVBvaW50ZXIgPT09IHRoaXMuY29yZS5zdGF0ZS5zdG9yYWdlLmNvcmUuZGF0YVBvaW50ZXIpIHsKICAgICAgICAgIHNoYXJlZExlbmd0aCA9IGRlcC5sZW5ndGgKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCB0eCA9IHRoaXMuY3JlYXRlV3JpdGVCYXRjaCgpCiAgICAgIGNvbnN0IHJ4ID0gdGhpcy5jb3JlLnN0YXRlLnN0b3JhZ2UucmVhZCgpCiAgICAgIGNvbnN0IHJvb3RQcm9taXNlcyA9IFtdCgogICAgICBmb3IgKGNvbnN0IHJvb3Qgb2YgZmxhdC5mdWxsUm9vdHMobGVuZ3RoICogMikpIHsKICAgICAgICByb290UHJvbWlzZXMucHVzaChyeC5nZXRUcmVlTm9kZShyb290KSkKICAgICAgfQoKICAgICAgcngudHJ5Rmx1c2goKQoKICAgICAgY29uc3Qgcm9vdHMgPSBhd2FpdCBQcm9taXNlLmFsbChyb290UHJvbWlzZXMpCiAgICAgIGNvbnN0IHRydW5jYXRpbmcgPSBzaGFyZWRMZW5ndGggPCBvcmlnTGVuZ3RoCgogICAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygcm9vdHMpIHsKICAgICAgICBpZiAobm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oCiAgICAgICAgICAgICdJbnZhbGlkIGNhdGNodXAgbGVuZ3RoLCB0cmVlIG5vZGVzIG5vdCBhdmFpbGFibGUnLAogICAgICAgICAgICB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5CiAgICAgICAgICApCiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCBmb3JrID0gdHJ1bmNhdGluZyA/IHRoaXMuZm9yayArIDEgOiB0aGlzLmZvcmsKCiAgICAgIC8vIG92ZXJ3cml0ZSBpdCBhdG0sIFRPRE86IGtlZXAgd2hhdCB3ZSBjYW4gY29ubmVjdCB0byB0aGUgdHJlZQogICAgICB0eC5kZWxldGVCbG9ja1JhbmdlKDAsIC0xKQogICAgICB0eC5kZWxldGVUcmVlTm9kZVJhbmdlKDAsIC0xKQogICAgICB0eC5kZWxldGVCaXRmaWVsZFBhZ2VSYW5nZSgwLCAtMSkKCiAgICAgIGNvbnN0IHRyZWUgPSB7CiAgICAgICAgZm9yaywKICAgICAgICBsZW5ndGgsCiAgICAgICAgcm9vdEhhc2g6IGNyeXB0by50cmVlKHJvb3RzKSwKICAgICAgICBzaWduYXR1cmU6IG51bGwKICAgICAgfQoKICAgICAgdHguc2V0SGVhZCh0cmVlKQoKICAgICAgLy8gcHJvcCBhIGJldHRlciB3YXkgdG8gZG8gdGhpcwogICAgICBjb25zdCBkZXAgPSB1cGRhdGVEZXBlbmRlbmN5KHRoaXMsIHNoYXJlZExlbmd0aCwgdHJ1ZSkKICAgICAgZGVwLmxlbmd0aCA9IGxlbmd0aAoKICAgICAgdHguc2V0RGVwZW5kZW5jeShkZXApCgogICAgICBjb25zdCBmbHVzaGVkID0gYXdhaXQgdGhpcy5mbHVzaCgpCgogICAgICB0aGlzLnN0b3JhZ2Uuc2V0RGVwZW5kZW5jeUhlYWQoZGVwKQoKICAgICAgdGhpcy5mb3JrID0gdHJlZS5mb3JrCiAgICAgIHRoaXMucm9vdHMgPSByb290cwogICAgICB0aGlzLmxlbmd0aCA9IHRyZWUubGVuZ3RoCiAgICAgIHRoaXMuYnl0ZUxlbmd0aCA9IE1lcmtsZVRyZWUuc2l6ZShyb290cykKCiAgICAgIGlmICh0cnVuY2F0aW5nKSB0aGlzLm9udHJ1bmNhdGUodHJlZSwgc2hhcmVkTGVuZ3RoLCBvcmlnTGVuZ3RoLCBmbHVzaGVkKQogICAgICBpZiAoc2hhcmVkTGVuZ3RoIDwgbGVuZ3RoKSB0aGlzLm9uYXBwZW5kKHRyZWUsIG51bGwsIGZsdXNoZWQpCgogICAgICBpZiAodGhpcy5jb3JlLmhpbnRzQ2hhbmdlZCAmJiB0aGlzLmlzRGVmYXVsdCgpKSBhd2FpdCB0aGlzLmNvcmUuZmx1c2hIaW50cygpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLm11dGV4LnVubG9jaygpCiAgICB9CiAgfQoKICBhc3luYyBfb3ZlcndyaXRlKHNvdXJjZSwgZm9yaywgbGVuZ3RoLCB0cmVlTGVuZ3RoLCBzaWduYXR1cmUpIHsKICAgIGNvbnN0IGJsb2NrUHJvbWlzZXMgPSBbXQogICAgY29uc3QgdHJlZVByb21pc2VzID0gW10KICAgIGNvbnN0IHJvb3RQcm9taXNlcyA9IFtdCgogICAgY29uc3QgcnggPSBzb3VyY2Uuc3RvcmFnZS5yZWFkKCkKCiAgICBmb3IgKGNvbnN0IHJvb3Qgb2YgZmxhdC5mdWxsUm9vdHMobGVuZ3RoICogMikpIHsKICAgICAgcm9vdFByb21pc2VzLnB1c2gocnguZ2V0VHJlZU5vZGUocm9vdCkpCiAgICB9CgogICAgZm9yIChjb25zdCBpbmRleCBvZiBmbGF0LnBhdGNoKHRyZWVMZW5ndGggKiAyLCBsZW5ndGggKiAyKSkgewogICAgICB0cmVlUHJvbWlzZXMucHVzaChyeC5nZXRUcmVlTm9kZShpbmRleCkpCiAgICB9CgogICAgZm9yIChsZXQgaSA9IHRyZWVMZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB0cmVlUHJvbWlzZXMucHVzaChyeC5nZXRUcmVlTm9kZShpICogMikpCiAgICAgIHRyZWVQcm9taXNlcy5wdXNoKHJ4LmdldFRyZWVOb2RlKGkgKiAyICsgMSkpCiAgICAgIGJsb2NrUHJvbWlzZXMucHVzaChyeC5nZXRCbG9jayhpKSkKICAgIH0KCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgYmxvY2tzID0gYXdhaXQgUHJvbWlzZS5hbGwoYmxvY2tQcm9taXNlcykKICAgIGNvbnN0IG5vZGVzID0gYXdhaXQgUHJvbWlzZS5hbGwodHJlZVByb21pc2VzKQogICAgY29uc3Qgcm9vdHMgPSBhd2FpdCBQcm9taXNlLmFsbChyb290UHJvbWlzZXMpCgogICAgaWYgKHRoaXMuY29yZS5kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcignQ29yZSBkZXN0cm95ZWQnKQoKICAgIGlmIChzaWduYXR1cmUpIHsKICAgICAgY29uc3QgYmF0Y2ggPSB0aGlzLmNyZWF0ZVRyZWVCYXRjaCgpCiAgICAgIGJhdGNoLnJvb3RzID0gcm9vdHMKICAgICAgYmF0Y2gubGVuZ3RoID0gbGVuZ3RoCgogICAgICBpZiAoIXRoaXMuY29yZS52ZXJpZmllci52ZXJpZnkoYmF0Y2gsIHNpZ25hdHVyZSkpIHsKICAgICAgICB0aHJvdyBJTlZBTElEX1NJR05BVFVSRSgKICAgICAgICAgICdTaWduYXR1cmUgaXMgbm90IHZhbGlkIG92ZXIgY29tbWl0dGVkIHRyZWUnLAogICAgICAgICAgdGhpcy5jb3JlLmRpc2NvdmVyeUtleQogICAgICAgICkKICAgICAgfQogICAgfQoKICAgIGNvbnN0IHR4ID0gdGhpcy5jcmVhdGVXcml0ZUJhdGNoKCkKCiAgICAvLyB0cnVuY2F0ZSBleGlzdGluZyB0cmVlCiAgICBpZiAodHJlZUxlbmd0aCA8IHRoaXMubGVuZ3RoKSB7CiAgICAgIHR4LmRlbGV0ZUJsb2NrUmFuZ2UodHJlZUxlbmd0aCwgdGhpcy5sZW5ndGgpCiAgICB9CgogICAgZm9yIChjb25zdCByb290IG9mIHJvb3RzKSB0eC5wdXRUcmVlTm9kZShyb290KQoKICAgIC8vIG5vIG5vZGVzIHdpbGwgYmUgY29waWVkIGluIHNoYWxsb3cgbW9kZQogICAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSB7CiAgICAgIGlmIChub2RlICE9PSBudWxsKSB0eC5wdXRUcmVlTm9kZShub2RlKQogICAgfQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGFzc2VydChibG9ja3NbaV0gIT09IG51bGwsICdoYXMgYmxvY2snKQogICAgICB0eC5wdXRCbG9jayhpICsgdHJlZUxlbmd0aCwgYmxvY2tzW2ldKQogICAgfQoKICAgIGNvbnN0IHRvdGFsTGVuZ3RoID0gTWF0aC5tYXgobGVuZ3RoLCB0aGlzLmxlbmd0aCkKCiAgICBpZiAodG90YWxMZW5ndGggPiB0cmVlTGVuZ3RoKSB7CiAgICAgIGNvbnN0IGZpcnN0UGFnZSA9IGdldEJpdGZpZWxkUGFnZSh0cmVlTGVuZ3RoKQogICAgICBjb25zdCBsYXN0UGFnZSA9IGdldEJpdGZpZWxkUGFnZSh0b3RhbExlbmd0aCAtIDEpCgogICAgICBjb25zdCBzcnggPSB0aGlzLnN0b3JhZ2UucmVhZCgpCiAgICAgIGNvbnN0IGJpdGZpZWxkUGFnZVByb21pc2UgPSBzcnguZ2V0Qml0ZmllbGRQYWdlKGZpcnN0UGFnZSkKICAgICAgc3J4LnRyeUZsdXNoKCkKCiAgICAgIGNvbnN0IGJpdGZpZWxkUGFnZSA9IGF3YWl0IGJpdGZpZWxkUGFnZVByb21pc2UKCiAgICAgIGxldCBpbmRleCA9IHRyZWVMZW5ndGgKCiAgICAgIGZvciAobGV0IGkgPSBmaXJzdFBhZ2U7IGkgPD0gbGFzdFBhZ2U7IGkrKykgewogICAgICAgIGNvbnN0IHBhZ2UgPSBiNGEuYWxsb2MoQml0ZmllbGQuQllURVNfUEVSX1BBR0UpCiAgICAgICAgdHgucHV0Qml0ZmllbGRQYWdlKGksIHBhZ2UpCgogICAgICAgIC8vIGNvcHkgZXhpc3RpbmcgYml0cyBpbgogICAgICAgIGlmIChpID09PSBmaXJzdFBhZ2UgJiYgYml0ZmllbGRQYWdlKSBwYWdlLnNldChiaXRmaWVsZFBhZ2UpCgogICAgICAgIGlmIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgaW5kZXggPSBmaWxsQml0ZmllbGRQYWdlKHBhZ2UsIGluZGV4LCBsZW5ndGgsIGksIHRydWUpCiAgICAgICAgICBpZiAoaW5kZXggPCBsZW5ndGgpIGNvbnRpbnVlCiAgICAgICAgfQoKICAgICAgICBpZiAoaW5kZXggPCB0aGlzLmxlbmd0aCkgewogICAgICAgICAgaW5kZXggPSBmaWxsQml0ZmllbGRQYWdlKHBhZ2UsIGluZGV4LCB0aGlzLmxlbmd0aCwgaSwgZmFsc2UpCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgY29uc3QgdHJlZSA9IHsKICAgICAgZm9yaywKICAgICAgbGVuZ3RoLAogICAgICByb290SGFzaDogY3J5cHRvLnRyZWUocm9vdHMpLAogICAgICBzaWduYXR1cmUKICAgIH0KCiAgICBjb25zdCB1cGdyYWRlZCA9IHRyZWVMZW5ndGggPCB0aGlzLmxlbmd0aCB8fCB0aGlzLmxlbmd0aCA8IGxlbmd0aCB8fCB0cmVlLmZvcmsgIT09IHRoaXMuZm9yawoKICAgIGlmICh1cGdyYWRlZCkgdHguc2V0SGVhZCh0cmVlKQoKICAgIGNvbnN0IGZsdXNoZWQgPSBhd2FpdCB0aGlzLmZsdXNoKCkKCiAgICB0aGlzLmZvcmsgPSB0cmVlLmZvcmsKICAgIHRoaXMucm9vdHMgPSByb290cwogICAgdGhpcy5sZW5ndGggPSBsZW5ndGgKICAgIHRoaXMuYnl0ZUxlbmd0aCA9IE1lcmtsZVRyZWUuc2l6ZShyb290cykKICAgIHRoaXMuc2lnbmF0dXJlID0gc2lnbmF0dXJlCgogICAgcmV0dXJuIHsgdHJlZSwgZmx1c2hlZCB9CiAgfQoKICBhc3luYyBjb21taXQoc3RhdGUsIHsgc2lnbmF0dXJlLCBrZXlQYWlyLCBsZW5ndGggPSBzdGF0ZS5sZW5ndGgsIHRyZWVMZW5ndGggPSAtMSB9ID0ge30pIHsKICAgIGFzc2VydCgKICAgICAgdGhpcy5pc0RlZmF1bHQoKSB8fCAodGhpcy5wYXJlbnQgJiYgdGhpcy5wYXJlbnQuaXNEZWZhdWx0KCkpLAogICAgICAnQ2FuIG9ubHkgY29tbWl0IGludG8gZGVmYXVsdCBzdGF0ZScKICAgICkKCiAgICBsZXQgc3JjTG9ja2VkID0gZmFsc2UKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgc3RhdGUubXV0ZXgubG9jaygpCiAgICAgIHNyY0xvY2tlZCA9IHRydWUKCiAgICAgIGlmICh0cmVlTGVuZ3RoID09PSAtMSkgdHJlZUxlbmd0aCA9IHN0YXRlLmZsdXNoZWRMZW5ndGgoKQoKICAgICAgaWYgKCEoYXdhaXQgdGhpcy5jb3JlLl92YWxpZGF0ZUNvbW1pdChzdGF0ZSwgdHJlZUxlbmd0aCkpKSByZXR1cm4gbnVsbAogICAgICBpZiAodGhpcy5sZW5ndGggPiBsZW5ndGgpIHJldHVybiBudWxsCgogICAgICBpZiAodGhpcy5sZW5ndGggPCBsZW5ndGggJiYgIXNpZ25hdHVyZSkgewogICAgICAgIGlmICgha2V5UGFpcikga2V5UGFpciA9IHRoaXMuY29yZS5oZWFkZXIua2V5UGFpcgogICAgICAgIGNvbnN0IGJhdGNoID0gc3RhdGUuY3JlYXRlVHJlZUJhdGNoKCkKICAgICAgICBpZiAobGVuZ3RoICE9PSBiYXRjaC5sZW5ndGgpIGF3YWl0IGJhdGNoLnJlc3RvcmUobGVuZ3RoKQogICAgICAgIHNpZ25hdHVyZSA9IHRoaXMuY29yZS52ZXJpZmllci5zaWduKGJhdGNoLCBrZXlQYWlyKQogICAgICB9CgogICAgICBjb25zdCB7IHRyZWUsIGZsdXNoZWQgfSA9IGF3YWl0IHRoaXMuX292ZXJ3cml0ZSgKICAgICAgICBzdGF0ZSwKICAgICAgICB0aGlzLmZvcmssCiAgICAgICAgbGVuZ3RoLAogICAgICAgIHRyZWVMZW5ndGgsCiAgICAgICAgc2lnbmF0dXJlCiAgICAgICkKCiAgICAgIC8vIGdjIGJsb2NrcyBmcm9tIHNvdXJjZQogICAgICBpZiAodHJlZUxlbmd0aCA8IGxlbmd0aCkgewogICAgICAgIGNvbnN0IHR4ID0gc3RhdGUuY3JlYXRlV3JpdGVCYXRjaCgpCgogICAgICAgIHR4LmRlbGV0ZUJsb2NrUmFuZ2UodHJlZUxlbmd0aCwgbGVuZ3RoKQogICAgICAgIGNvbnN0IGRlcGVuZGVuY3kgPSBzdGF0ZS51cGRhdGVEZXBlbmRlbmN5KHR4LCBsZW5ndGgpCgogICAgICAgIGF3YWl0IHN0YXRlLmZsdXNoKHR4KQoKICAgICAgICBpZiAoZGVwZW5kZW5jeSkgc3RhdGUuc3RvcmFnZS5zZXREZXBlbmRlbmN5SGVhZChkZXBlbmRlbmN5KQogICAgICB9CgogICAgICBjb25zdCBiaXRmaWVsZCA9IHsgc3RhcnQ6IHRyZWVMZW5ndGgsIGxlbmd0aDogbGVuZ3RoIC0gdHJlZUxlbmd0aCwgZHJvcDogZmFsc2UgfQogICAgICB0aGlzLm9uYXBwZW5kKHRyZWUsIGJpdGZpZWxkLCBmbHVzaGVkKQoKICAgICAgcmV0dXJuIHsKICAgICAgICBsZW5ndGg6IHRoaXMubGVuZ3RoLAogICAgICAgIGJ5dGVMZW5ndGg6IHRoaXMuYnl0ZUxlbmd0aAogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLnVwZGF0aW5nID0gZmFsc2UKICAgICAgdGhpcy5tdXRleC51bmxvY2soKQoKICAgICAgaWYgKHNyY0xvY2tlZCkgewogICAgICAgIHN0YXRlLm11dGV4LnVubG9jaygpCiAgICAgICAgc3RhdGUuX2NsZWFyQWN0aXZlQmF0Y2goKQogICAgICB9CgogICAgICB0aGlzLmNvcmUuY2hlY2tJZklkbGUoKQogICAgfQogIH0KCiAgYXN5bmMgX2dldFRyZWVIZWFkQXQobGVuZ3RoKSB7CiAgICBpZiAobGVuZ3RoID09PSBudWxsKSByZXR1cm4gdGhpcy50cmVlSW5mbygpCgogICAgY29uc3QgaGVhZCA9IGdldERlZmF1bHRUcmVlKCkKCiAgICBoZWFkLmxlbmd0aCA9IGxlbmd0aAoKICAgIGNvbnN0IHJvb3RzID0gYXdhaXQgTWVya2xlVHJlZS5nZXRSb290c0Zyb21TdG9yYWdlKHRoaXMuc3RvcmFnZSwgbGVuZ3RoKQogICAgY29uc3Qgcm9vdEhhc2ggPSBjcnlwdG8udHJlZShyb290cykKCiAgICBoZWFkLmZvcmsgPSB0aGlzLmZvcmsKICAgIGhlYWQucm9vdEhhc2ggPSByb290SGFzaAoKICAgIGlmIChsZW5ndGggPT09IHRoaXMubGVuZ3RoKSBoZWFkLnNpZ25hdHVyZSA9IHRoaXMuc2lnbmF0dXJlCgogICAgcmV0dXJuIGhlYWQKICB9CgogIF9tb3ZlVG9Db3JlKGNvcmUsIHRydW5jYXRlZCwgYXBwZW5kZWQpIHsKICAgIGNvbnN0IGhlYWQgPSB0aGlzLmNvcmUuc2Vzc2lvblN0YXRlcy5wb3AoKQogICAgaWYgKGhlYWQgIT09IHRoaXMpIHRoaXMuY29yZS5zZXNzaW9uU3RhdGVzWyhoZWFkLmluZGV4ID0gdGhpcy5pbmRleCldID0gaGVhZAoKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMuaW5kZXggPSB0aGlzLmNvcmUuc2Vzc2lvblN0YXRlcy5wdXNoKHRoaXMpIC0gMQoKICAgIGZvciAobGV0IGkgPSB0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLnNlc3Npb25zW2ldCiAgICAgIGNvbnN0IG1hbmlmZXN0ID0gcy5tYW5pZmVzdAogICAgICBzLnRyYW5zZmVyU2Vzc2lvbih0aGlzLmNvcmUpCiAgICAgIGlmICghbWFuaWZlc3QgJiYgcy5tYW5pZmVzdCkgcy5lbWl0KCdtYW5pZmVzdCcpCiAgICAgIGlmICh0cnVuY2F0ZWQpIHMuZW1pdCgndHJ1bmNhdGUnLCB0cnVuY2F0ZWQudG8sIHRydW5jYXRlZC5mb3JrKQogICAgICBpZiAoYXBwZW5kZWQpIHMuZW1pdCgnYXBwZW5kJykKICAgIH0KICB9CgogIGFzeW5jIG1vdmVUbyhjb3JlLCBsZW5ndGgpIHsKICAgIGNvbnN0IHN0YXRlID0gY29yZS5zdGF0ZQoKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgLy8gaWYgKHN0YXRlLnN0b3JhZ2UgJiYgKGF3YWl0IHN0YXRlLnN0b3JhZ2UucmVzdW1lU2Vzc2lvbih0aGlzLm5hbWUpKSAhPT0gbnVsbCkgewogICAgICAvLyAgIHRocm93IFNUT1JBR0VfQ09ORkxJQ1QoJ0JhdGNoIGhhcyBhbHJlYWR5IGJlZW4gY3JlYXRlZCcpCiAgICAgIC8vIH0KCiAgICAgIGNvbnN0IHRyZWVMZW5ndGggPSB0aGlzLmxlbmd0aAoKICAgICAgbGV0IHRydW5jYXRlZCA9IG51bGwKICAgICAgbGV0IGFwcGVuZGVkID0gZmFsc2UKCiAgICAgIGlmICghdGhpcy5pc1NuYXBzaG90KCkpIHsKICAgICAgICBpZiAodGhpcy5saW5nZXJzID09PSBudWxsKSB0aGlzLmxpbmdlcnMgPSBbXQogICAgICAgIHRoaXMubGluZ2Vycy5wdXNoKHRoaXMuc3RvcmFnZSkKCiAgICAgICAgY29uc3QgcmVzdW1lZCA9IGF3YWl0IHN0YXRlLnN0b3JhZ2UucmVzdW1lU2Vzc2lvbih0aGlzLm5hbWUpCgogICAgICAgIGNvbnN0IHRydW5jYXRpb24gPSBsZW5ndGggPCB0aGlzLmxlbmd0aCA/IGF3YWl0IHRydW5jYXRlQW5kRmx1c2godGhpcywgbGVuZ3RoKSA6IG51bGwKICAgICAgICBjb25zdCB0cmVlSW5mbyA9IHRydW5jYXRpb24KICAgICAgICAgID8gdHJ1bmNhdGlvbi50cmVlCiAgICAgICAgICA6IHJlc3VtZWQKICAgICAgICAgICAgPyBudWxsCiAgICAgICAgICAgIDogYXdhaXQgc3RhdGUuX2dldFRyZWVIZWFkQXQodGhpcy5sZW5ndGgpCgogICAgICAgIGNvbnN0IGZvcmsgPSB0cnVuY2F0aW9uID8gdGhpcy5mb3JrICsgMSA6IHRoaXMuZm9yawoKICAgICAgICAvLyB0b2RvOiB2YWxpZGF0ZSB0cmVlSW5mbwoKICAgICAgICBsZXQgc3RvcmFnZSA9IG51bGwKCiAgICAgICAgaWYgKHJlc3VtZWQpIHsKICAgICAgICAgIHN0b3JhZ2UgPSByZXN1bWVkCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRyZWVJbmZvLmZvcmsgPSBmb3JrCiAgICAgICAgICBzdG9yYWdlID0gYXdhaXQgc3RhdGUuc3RvcmFnZS5jcmVhdGVTZXNzaW9uKHRoaXMubmFtZSwgdHJlZUluZm8pCiAgICAgICAgfQoKICAgICAgICBjb25zdCByb290cyA9IGF3YWl0IE1lcmtsZVRyZWUuZ2V0Um9vdHNGcm9tU3RvcmFnZShzdG9yYWdlLCBsZW5ndGgpCgogICAgICAgIHRoaXMuc3RvcmFnZSA9IHN0b3JhZ2UKICAgICAgICB0aGlzLnByb2xvZ3VlID0gc3RhdGUucHJvbG9ndWUKICAgICAgICB0aGlzLmZvcmsgPSBmb3JrCiAgICAgICAgdGhpcy5sZW5ndGggPSBsZW5ndGgKICAgICAgICB0aGlzLmJ5dGVMZW5ndGggPSBNZXJrbGVUcmVlLnNpemUocm9vdHMpCiAgICAgICAgdGhpcy5yb290cyA9IHJvb3RzCgogICAgICAgIGlmICh0cnVuY2F0aW9uKSB7CiAgICAgICAgICBjb25zdCB7IGRlcGVuZGVuY3kgfSA9IHRydW5jYXRpb24KCiAgICAgICAgICBpZiAoZGVwZW5kZW5jeSkgdGhpcy5zdG9yYWdlLnNldERlcGVuZGVuY3lIZWFkKGRlcGVuZGVuY3kpCiAgICAgICAgICB0cnVuY2F0ZWQgPSB7IHRvOiB0cmVlTGVuZ3RoLCBmb3JrIH0KICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmxlbmd0aCA+IHRyZWVMZW5ndGgpIHsKICAgICAgICAgIGFwcGVuZGVkID0gdHJ1ZQogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yIChsZXQgaSA9IHRoaXMuY29yZS5zZXNzaW9uU3RhdGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgY29uc3Qgc3RhdGUgPSB0aGlzLmNvcmUuc2Vzc2lvblN0YXRlc1tpXQogICAgICAgIGlmIChzdGF0ZSA9PT0gdGhpcykgY29udGludWUKICAgICAgICBpZiAoc3RhdGUubmFtZSA9PT0gdGhpcy5uYW1lKSBzdGF0ZS5fbW92ZVRvQ29yZShjb3JlLmNvcmUpCiAgICAgIH0KCiAgICAgIHRoaXMuX21vdmVUb0NvcmUoY29yZS5jb3JlLCB0cnVuY2F0ZWQsIGFwcGVuZGVkKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5tdXRleC51bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgY3JlYXRlU2Vzc2lvbihuYW1lLCBvdmVyd3JpdGUsIGF0b20pIHsKICAgIGxldCBzdG9yYWdlID0gbnVsbAogICAgbGV0IHRyZWVJbmZvID0gbnVsbAoKICAgIGlmICghYXRvbSAmJiAhb3ZlcndyaXRlICYmIHRoaXMuc3RvcmFnZSkgewogICAgICBzdG9yYWdlID0gYXdhaXQgdGhpcy5zdG9yYWdlLnJlc3VtZVNlc3Npb24obmFtZSkKCiAgICAgIGlmIChzdG9yYWdlICE9PSBudWxsKSB0cmVlSW5mbyA9IChhd2FpdCBnZXRDb3JlSGVhZChzdG9yYWdlKSkgfHwgZ2V0RGVmYXVsdFRyZWUoKQogICAgfQoKICAgIGNvbnN0IGxlbmd0aCA9IHRyZWVJbmZvID8gdHJlZUluZm8ubGVuZ3RoIDogdGhpcy5sZW5ndGgKCiAgICBpZiAoc3RvcmFnZSA9PT0gbnVsbCkgewogICAgICB0cmVlSW5mbyA9IGF3YWl0IHRoaXMuX2dldFRyZWVIZWFkQXQobGVuZ3RoKQoKICAgICAgaWYgKGF0b20pIHsKICAgICAgICBzdG9yYWdlID0gYXdhaXQgdGhpcy5zdG9yYWdlLmNyZWF0ZUF0b21pY1Nlc3Npb24oYXRvbSwgdHJlZUluZm8pCiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RvcmFnZSA9IGF3YWl0IHRoaXMuc3RvcmFnZS5jcmVhdGVTZXNzaW9uKG5hbWUsIHRyZWVJbmZvKQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMuYXRvbWl6ZWQgJiYgYXRvbSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Nlc3Npb24gYWxyZWFkeSBhdG9taXplZCcpCiAgICB9CgogICAgY29uc3QgaGVhZCA9IHsKICAgICAgZm9yazogdGhpcy5mb3JrLAogICAgICByb290czoKICAgICAgICBsZW5ndGggPT09IHRoaXMubGVuZ3RoCiAgICAgICAgICA/IHRoaXMucm9vdHMuc2xpY2UoKQogICAgICAgICAgOiBhd2FpdCBNZXJrbGVUcmVlLmdldFJvb3RzRnJvbVN0b3JhZ2Uoc3RvcmFnZSwgbGVuZ3RoKSwKICAgICAgbGVuZ3RoLAogICAgICBwcm9sb2d1ZTogdGhpcy5wcm9sb2d1ZSwKICAgICAgc2lnbmF0dXJlOiBsZW5ndGggPT09IHRoaXMubGVuZ3RoID8gdGhpcy5zaWduYXR1cmUgOiBudWxsCiAgICB9CgogICAgY29uc3Qgc3RhdGUgPSBuZXcgU2Vzc2lvblN0YXRlKAogICAgICB0aGlzLmNvcmUsCiAgICAgIGF0b20gPyB0aGlzIDogbnVsbCwKICAgICAgc3RvcmFnZSwKICAgICAgaGVhZCwKICAgICAgYXRvbSA/IHRoaXMubmFtZSA6IG5hbWUKICAgICkKCiAgICBpZiAoYXRvbSkgewogICAgICB0aGlzLmF0b21pemVkID0gYXRvbQogICAgICBhdG9tLm9uZmx1c2goc3RhdGUuX2NvbW1pdC5iaW5kKHN0YXRlKSkKICAgIH0KCiAgICByZXR1cm4gc3RhdGUKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gZ2V0Qml0ZmllbGRQYWdlKGluZGV4KSB7CiAgcmV0dXJuIE1hdGguZmxvb3IoaW5kZXggLyBCaXRmaWVsZC5CSVRTX1BFUl9QQUdFKQp9CgpmdW5jdGlvbiBmaWxsQml0ZmllbGRQYWdlKHBhZ2UsIHN0YXJ0LCBlbmQsIHBhZ2VJbmRleCwgdmFsdWUpIHsKICBjb25zdCBvZmZzZXQgPSBwYWdlSW5kZXggKiBCaXRmaWVsZC5CSVRTX1BFUl9QQUdFCiAgY29uc3QgbWF4ID0gb2Zmc2V0ICsgQml0ZmllbGQuQklUU19QRVJfUEFHRQoKICBjb25zdCBpbmRleCA9IG1heCA8IGVuZCA/IG1heCA6IGVuZAoKICBjb25zdCBmcm9tID0gc3RhcnQgLSBvZmZzZXQKICBjb25zdCB0byA9IGluZGV4IC0gb2Zmc2V0CgogIHF1aWNrYml0LmZpbGwocGFnZSwgdmFsdWUsIGZyb20sIHRvKQoKICByZXR1cm4gaW5kZXgKfQoKYXN5bmMgZnVuY3Rpb24gc3RvcmVCaXRmaWVsZFJhbmdlKHN0b3JhZ2UsIHR4LCBmcm9tLCB0bywgdmFsdWUpIHsKICBpZiAoZnJvbSA+PSB0bykgcmV0dXJuCgogIGNvbnN0IGZpcnN0UGFnZSA9IGdldEJpdGZpZWxkUGFnZShmcm9tKQogIGNvbnN0IGxhc3RQYWdlID0gZ2V0Qml0ZmllbGRQYWdlKHRvIC0gMSkKCiAgbGV0IGluZGV4ID0gZnJvbQoKICBjb25zdCByeCA9IHN0b3JhZ2UucmVhZCgpCgogIGNvbnN0IHByb21pc2VzID0gW10KICBmb3IgKGxldCBpID0gZmlyc3RQYWdlOyBpIDw9IGxhc3RQYWdlOyBpKyspIHsKICAgIHByb21pc2VzLnB1c2gocnguZ2V0Qml0ZmllbGRQYWdlKGkpKQogIH0KCiAgcngudHJ5Rmx1c2goKQoKICBjb25zdCBwYWdlcyA9IGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKQogIGNvbnN0IGNudCA9IGxhc3RQYWdlIC0gZmlyc3RQYWdlICsgMQoKICBmb3IgKGxldCBpID0gMDsgaSA8IGNudDsgaSsrKSB7CiAgICBjb25zdCBwYWdlSW5kZXggPSBpICsgZmlyc3RQYWdlCiAgICBpZiAoIXBhZ2VzW2ldKSBwYWdlc1tpXSA9IGI0YS5hbGxvYyhCaXRmaWVsZC5CWVRFU19QRVJfUEFHRSkKCiAgICBpbmRleCA9IGZpbGxCaXRmaWVsZFBhZ2UocGFnZXNbaV0sIGluZGV4LCB0bywgcGFnZUluZGV4LCB2YWx1ZSkKICAgIHR4LnB1dEJpdGZpZWxkUGFnZShwYWdlSW5kZXgsIHBhZ2VzW2ldKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gdHJ1bmNhdGVBbmRGbHVzaChzLCBsZW5ndGgpIHsKICBjb25zdCBiYXRjaCA9IHMuY3JlYXRlVHJlZUJhdGNoKCkKICBhd2FpdCBNZXJrbGVUcmVlLnRydW5jYXRlKHMsIGxlbmd0aCwgYmF0Y2gsIHMuZm9yaykKICBjb25zdCB0eCA9IHMuY3JlYXRlV3JpdGVCYXRjaCgpCgogIGNvbnN0IGluZm8gPSBhd2FpdCBzLl90cnVuY2F0ZSh0eCwgYmF0Y2gpCiAgY29uc3QgZmx1c2hlZCA9IGF3YWl0IHMuZmx1c2goKQoKICByZXR1cm4gewogICAgdHJlZTogaW5mby50cmVlLAogICAgcm9vdHM6IGluZm8ucm9vdHMsCiAgICBkZXBlbmRlbmN5OiBpbmZvLmRlcGVuZGVuY3ksCiAgICBmbHVzaGVkCiAgfQp9CgpmdW5jdGlvbiB1cGRhdGVEZXBlbmRlbmN5KHN0YXRlLCBsZW5ndGgsIHRydW5jYXRlZCkgewogIGNvbnN0IGkgPSBzdGF0ZS5zdG9yYWdlLmZpbmREZXBlbmRlbmN5SW5kZXgobGVuZ3RoLCB0cnVuY2F0ZWQpCiAgaWYgKGkgPT09IC0xKSByZXR1cm4gbnVsbCAvLyBza2lwIGRlZmF1bHQgc3RhdGUgYW5kIG92ZXJsYXlzIG9mIGRlZmF1bHQKCiAgcmV0dXJuIHsKICAgIGRhdGFQb2ludGVyOiBzdGF0ZS5zdG9yYWdlLmRlcGVuZGVuY2llc1tpXS5kYXRhUG9pbnRlciwKICAgIGxlbmd0aAogIH0KfQoKZnVuY3Rpb24gZ2V0RGVmYXVsdFRyZWUoKSB7CiAgcmV0dXJuIHsKICAgIGZvcms6IDAsCiAgICBsZW5ndGg6IDAsCiAgICByb290SGFzaDogbnVsbCwKICAgIHNpZ25hdHVyZTogbnVsbAogIH0KfQoKZnVuY3Rpb24gZ2V0Q29yZUhlYWQoc3RvcmFnZSkgewogIGNvbnN0IGIgPSBzdG9yYWdlLnJlYWQoKQogIGNvbnN0IHAgPSBiLmdldEhlYWQoKQogIGIudHJ5Rmx1c2goKQogIHJldHVybiBwCn0KCmZ1bmN0aW9uIGlzUm9vdEluZGV4KGluZGV4LCByb290cykgewogIGZvciAoY29uc3Qgbm9kZSBvZiByb290cykgewogICAgaWYgKG5vZGUuaW5kZXggPT09IGluZGV4KSByZXR1cm4gdHJ1ZQogIH0KCiAgcmV0dXJuIGZhbHNlCn0KY29uc3QgeyBXcml0YWJsZSwgUmVhZGFibGUgfSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQoKY2xhc3MgUmVhZFN0cmVhbSBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3Rvcihjb3JlLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICB0aGlzLnN0YXJ0ID0gb3B0cy5zdGFydCB8fCAwCiAgICB0aGlzLmVuZCA9IHR5cGVvZiBvcHRzLmVuZCA9PT0gJ251bWJlcicgPyBvcHRzLmVuZCA6IC0xCiAgICB0aGlzLnNuYXBzaG90ID0gIW9wdHMubGl2ZSAmJiBvcHRzLnNuYXBzaG90ICE9PSBmYWxzZQogICAgdGhpcy5saXZlID0gdGhpcy5lbmQgPT09IC0xID8gISFvcHRzLmxpdmUgOiBmYWxzZQogICAgdGhpcy53YWl0ID0gdHlwZW9mIG9wdHMud2FpdCA9PT0gJ2Jvb2xlYW4nID8gb3B0cy53YWl0IDogdGhpcy5jb3JlLndhaXQKICAgIHRoaXMudGltZW91dCA9IG9wdHMudGltZW91dCB8fCBjb3JlLnRpbWVvdXQKICB9CgogIF9vcGVuKGNiKSB7CiAgICB0aGlzLl9vcGVuUCgpLnRoZW4oY2IsIGNiKQogIH0KCiAgX3JlYWQoY2IpIHsKICAgIHRoaXMuX3JlYWRQKCkudGhlbihjYiwgY2IpCiAgfQoKICBhc3luYyBfb3BlblAoKSB7CiAgICBpZiAodGhpcy5lbmQgPT09IC0xKSBhd2FpdCB0aGlzLmNvcmUudXBkYXRlKCkKICAgIGVsc2UgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKICAgIGlmICh0aGlzLnNuYXBzaG90ICYmIHRoaXMuZW5kID09PSAtMSkgdGhpcy5lbmQgPSB0aGlzLmNvcmUubGVuZ3RoCiAgfQoKICBhc3luYyBfcmVhZFAoKSB7CiAgICBjb25zdCBlbmQgPSB0aGlzLmxpdmUgPyAtMSA6IHRoaXMuZW5kID09PSAtMSA/IHRoaXMuY29yZS5sZW5ndGggOiB0aGlzLmVuZAogICAgaWYgKGVuZCA+PSAwICYmIHRoaXMuc3RhcnQgPj0gZW5kKSB7CiAgICAgIHRoaXMucHVzaChudWxsKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLnB1c2goYXdhaXQgdGhpcy5jb3JlLmdldCh0aGlzLnN0YXJ0KyssIHsgd2FpdDogdGhpcy53YWl0LCB0aW1lb3V0OiB0aGlzLnRpbWVvdXQgfSkpCiAgfQp9CgpleHBvcnRzLlJlYWRTdHJlYW0gPSBSZWFkU3RyZWFtCgpjbGFzcyBXcml0ZVN0cmVhbSBleHRlbmRzIFdyaXRhYmxlIHsKICBjb25zdHJ1Y3Rvcihjb3JlKSB7CiAgICBzdXBlcigpCiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgfQoKICBfd3JpdGV2KGJhdGNoLCBjYikgewogICAgdGhpcy5fd3JpdGV2UChiYXRjaCkudGhlbihjYiwgY2IpCiAgfQoKICBhc3luYyBfd3JpdGV2UChiYXRjaCkgewogICAgYXdhaXQgdGhpcy5jb3JlLmFwcGVuZChiYXRjaCkKICB9Cn0KCmV4cG9ydHMuV3JpdGVTdHJlYW0gPSBXcml0ZVN0cmVhbQoKY2xhc3MgQnl0ZVN0cmVhbSBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3Rvcihjb3JlLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLl9jb3JlID0gY29yZQogICAgdGhpcy5faW5kZXggPSAwCiAgICB0aGlzLl9yYW5nZSA9IG51bGwKCiAgICB0aGlzLl9ieXRlT2Zmc2V0ID0gb3B0cy5ieXRlT2Zmc2V0IHx8IDAKICAgIHRoaXMuX2J5dGVMZW5ndGggPSB0eXBlb2Ygb3B0cy5ieXRlTGVuZ3RoID09PSAnbnVtYmVyJyA/IG9wdHMuYnl0ZUxlbmd0aCA6IC0xCiAgICB0aGlzLl9wcmVmZXRjaCA9IHR5cGVvZiBvcHRzLnByZWZldGNoID09PSAnbnVtYmVyJyA/IG9wdHMucHJlZmV0Y2ggOiAzMgoKICAgIHRoaXMuX2FwcGx5T2Zmc2V0ID0gdGhpcy5fYnl0ZU9mZnNldCA+IDAKICB9CgogIF9vcGVuKGNiKSB7CiAgICB0aGlzLl9vcGVucCgpLnRoZW4oY2IsIGNiKQogIH0KCiAgX3JlYWQoY2IpIHsKICAgIHRoaXMuX3JlYWRwKCkudGhlbihjYiwgY2IpCiAgfQoKICBhc3luYyBfb3BlbnAoKSB7CiAgICBpZiAodGhpcy5fYnl0ZUxlbmd0aCA9PT0gLTEpIHsKICAgICAgYXdhaXQgdGhpcy5fY29yZS51cGRhdGUoKQogICAgICB0aGlzLl9ieXRlTGVuZ3RoID0gTWF0aC5tYXgodGhpcy5fY29yZS5ieXRlTGVuZ3RoIC0gdGhpcy5fYnl0ZU9mZnNldCwgMCkKICAgIH0KICB9CgogIGFzeW5jIF9yZWFkcCgpIHsKICAgIGxldCBkYXRhID0gbnVsbAoKICAgIGlmICh0aGlzLl9ieXRlTGVuZ3RoID09PSAwKSB7CiAgICAgIHRoaXMucHVzaChudWxsKQogICAgICByZXR1cm4KICAgIH0KCiAgICBsZXQgcmVsYXRpdmVPZmZzZXQgPSAwCgogICAgaWYgKHRoaXMuX2FwcGx5T2Zmc2V0KSB7CiAgICAgIHRoaXMuX2FwcGx5T2Zmc2V0ID0gZmFsc2UKCiAgICAgIGNvbnN0IFtibG9jaywgYnl0ZU9mZnNldF0gPSBhd2FpdCB0aGlzLl9jb3JlLnNlZWsodGhpcy5fYnl0ZU9mZnNldCkKCiAgICAgIHRoaXMuX2luZGV4ID0gYmxvY2sKICAgICAgcmVsYXRpdmVPZmZzZXQgPSBieXRlT2Zmc2V0CiAgICB9CgogICAgdGhpcy5fcHJlZG93bmxvYWQodGhpcy5faW5kZXggKyAxKQogICAgZGF0YSA9IGF3YWl0IHRoaXMuX2NvcmUuZ2V0KHRoaXMuX2luZGV4KyssIHsgdmFsdWVFbmNvZGluZzogJ2JpbmFyeScgfSkKCiAgICBpZiAocmVsYXRpdmVPZmZzZXQgPiAwKSBkYXRhID0gZGF0YS5zdWJhcnJheShyZWxhdGl2ZU9mZnNldCkKCiAgICBpZiAoZGF0YS5ieXRlTGVuZ3RoID4gdGhpcy5fYnl0ZUxlbmd0aCkgZGF0YSA9IGRhdGEuc3ViYXJyYXkoMCwgdGhpcy5fYnl0ZUxlbmd0aCkKICAgIHRoaXMuX2J5dGVMZW5ndGggLT0gZGF0YS5ieXRlTGVuZ3RoCgogICAgdGhpcy5wdXNoKGRhdGEpCiAgICBpZiAodGhpcy5fYnl0ZUxlbmd0aCA9PT0gMCkgdGhpcy5wdXNoKG51bGwpCiAgfQoKICBfcHJlZG93bmxvYWQoaW5kZXgpIHsKICAgIGlmICh0aGlzLl9yYW5nZSkgdGhpcy5fcmFuZ2UuZGVzdHJveSgpCiAgICB0aGlzLl9yYW5nZSA9IHRoaXMuX2NvcmUuZG93bmxvYWQoeyBzdGFydDogaW5kZXgsIGVuZDogaW5kZXggKyB0aGlzLl9wcmVmZXRjaCwgbGluZWFyOiB0cnVlIH0pCiAgfQoKICBfZGVzdHJveShjYikgewogICAgaWYgKHRoaXMuX3JhbmdlKSB0aGlzLl9yYW5nZS5kZXN0cm95KCkKICAgIGNiKG51bGwpCiAgfQp9CgpleHBvcnRzLkJ5dGVTdHJlYW0gPSBCeXRlU3RyZWFtCmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGZsYXQgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQpjb25zdCB7IEJBRF9BUkdVTUVOVCB9ID0gcmVxdWlyZSgnaHlwZXJjb3JlLWVycm9ycycpCmNvbnN0IHVuc2xhYiA9IHJlcXVpcmUoJ3Vuc2xhYicpCgpjb25zdCBtID0gcmVxdWlyZSgnLi9tZXNzYWdlcycpCmNvbnN0IG11bHRpc2lnID0gcmVxdWlyZSgnLi9tdWx0aXNpZycpCmNvbnN0IGNhcHMgPSByZXF1aXJlKCcuL2NhcHMnKQoKY2xhc3MgU2lnbmVyIHsKICBjb25zdHJ1Y3RvcigKICAgIG1hbmlmZXN0SGFzaCwKICAgIHZlcnNpb24sCiAgICBpbmRleCwKICAgIHsgc2lnbmF0dXJlID0gJ2VkMjU1MTknLCBwdWJsaWNLZXksIG5hbWVzcGFjZSA9IGNhcHMuREVGQVVMVF9OQU1FU1BBQ0UgfSA9IHt9CiAgKSB7CiAgICBpZiAoIXB1YmxpY0tleSkgdGhyb3cgQkFEX0FSR1VNRU5UKCdwdWJsaWMga2V5IGlzIHJlcXVpcmVkIGZvciBhIHNpZ25lcicpCiAgICBpZiAoc2lnbmF0dXJlICE9PSAnZWQyNTUxOScpIHRocm93IEJBRF9BUkdVTUVOVCgnT25seSBFZDI1NTE5IHNpZ25hdHVyZXMgYXJlIHN1cHBvcnRlZCcpCgogICAgdGhpcy5tYW5pZmVzdEhhc2ggPSBtYW5pZmVzdEhhc2gKICAgIHRoaXMudmVyc2lvbiA9IHZlcnNpb24KICAgIHRoaXMuc2lnbmVyID0gaW5kZXgKICAgIHRoaXMuc2lnbmF0dXJlID0gc2lnbmF0dXJlCiAgICB0aGlzLnB1YmxpY0tleSA9IHB1YmxpY0tleQogICAgdGhpcy5uYW1lc3BhY2UgPSBuYW1lc3BhY2UKICB9CgogIF9jdHgoKSB7CiAgICByZXR1cm4gdGhpcy52ZXJzaW9uID09PSAwID8gdGhpcy5uYW1lc3BhY2UgOiB0aGlzLm1hbmlmZXN0SGFzaAogIH0KCiAgdmVyaWZ5KGJhdGNoLCBzaWduYXR1cmUpIHsKICAgIHJldHVybiBjcnlwdG8udmVyaWZ5KGJhdGNoLnNpZ25hYmxlKHRoaXMuX2N0eCgpKSwgc2lnbmF0dXJlLCB0aGlzLnB1YmxpY0tleSkKICB9CgogIHNpZ24oYmF0Y2gsIGtleVBhaXIpIHsKICAgIHJldHVybiBjcnlwdG8uc2lnbihiYXRjaC5zaWduYWJsZSh0aGlzLl9jdHgoKSksIGtleVBhaXIuc2VjcmV0S2V5KQogIH0KfQoKY2xhc3MgQ29tcGF0U2lnbmVyIGV4dGVuZHMgU2lnbmVyIHsKICBjb25zdHJ1Y3RvcihpbmRleCwgc2lnbmVyLCBsZWdhY3kpIHsKICAgIHN1cGVyKG51bGwsIDAsIGluZGV4LCBzaWduZXIpCiAgICB0aGlzLmxlZ2FjeSA9IGxlZ2FjeQogIH0KCiAgdmVyaWZ5KGJhdGNoLCBzaWduYXR1cmUpIHsKICAgIHJldHVybiBjcnlwdG8udmVyaWZ5KGJhdGNoLnNpZ25hYmxlQ29tcGF0KHRoaXMubGVnYWN5KSwgc2lnbmF0dXJlLCB0aGlzLnB1YmxpY0tleSkKICB9CgogIHNpZ24oYmF0Y2gsIGtleVBhaXIpIHsKICAgIHJldHVybiBjcnlwdG8uc2lnbihiYXRjaC5zaWduYWJsZUNvbXBhdCh0aGlzLmxlZ2FjeSksIGtleVBhaXIuc2VjcmV0S2V5KQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBWZXJpZmllciB7CiAgY29uc3RydWN0b3IoCiAgICBtYW5pZmVzdEhhc2gsCiAgICBtYW5pZmVzdCwKICAgIHsgY29tcGF0ID0gaXNDb21wYXQobWFuaWZlc3RIYXNoLCBtYW5pZmVzdCksIGxlZ2FjeSA9IGZhbHNlIH0gPSB7fQogICkgewogICAgY29uc3Qgc2VsZiA9IHRoaXMKCiAgICB0aGlzLm1hbmlmZXN0SGFzaCA9IG1hbmlmZXN0SGFzaAogICAgdGhpcy5jb21wYXQgPSBjb21wYXQgfHwgbWFuaWZlc3QgPT09IG51bGwKICAgIHRoaXMudmVyc2lvbiA9IHRoaXMuY29tcGF0ID8gMCA6IHR5cGVvZiBtYW5pZmVzdC52ZXJzaW9uID09PSAnbnVtYmVyJyA/IG1hbmlmZXN0LnZlcnNpb24gOiAxCiAgICB0aGlzLmhhc2ggPSBtYW5pZmVzdC5oYXNoIHx8ICdibGFrZTJiJwogICAgdGhpcy5hbGxvd1BhdGNoID0gIXRoaXMuY29tcGF0ICYmICEhbWFuaWZlc3QuYWxsb3dQYXRjaAogICAgdGhpcy5xdW9ydW0gPSB0aGlzLmNvbXBhdCA/IDEgOiBkZWZhdWx0UXVvcnVtKG1hbmlmZXN0KQoKICAgIHRoaXMuc2lnbmVycyA9IG1hbmlmZXN0LnNpZ25lcnMgPyBtYW5pZmVzdC5zaWduZXJzLm1hcChjcmVhdGVTaWduZXIpIDogW10KICAgIHRoaXMucHJvbG9ndWUgPSB0aGlzLmNvbXBhdCA/IG51bGwgOiBtYW5pZmVzdC5wcm9sb2d1ZSB8fCBudWxsCgogICAgZnVuY3Rpb24gY3JlYXRlU2lnbmVyKHNpZ25lciwgaW5kZXgpIHsKICAgICAgcmV0dXJuIHNlbGYuY29tcGF0CiAgICAgICAgPyBuZXcgQ29tcGF0U2lnbmVyKGluZGV4LCBzaWduZXIsIGxlZ2FjeSkKICAgICAgICA6IG5ldyBTaWduZXIobWFuaWZlc3RIYXNoLCBzZWxmLnZlcnNpb24sIGluZGV4LCBzaWduZXIpCiAgICB9CiAgfQoKICBfdmVyaWZ5Q29tcGF0KGJhdGNoLCBzaWduYXR1cmUpIHsKICAgIGlmICghc2lnbmF0dXJlKSByZXR1cm4gZmFsc2UKCiAgICBpZiAodGhpcy5jb21wYXQgfHwgKCF0aGlzLmFsbG93UGF0Y2ggJiYgdGhpcy5zaWduZXJzLmxlbmd0aCA9PT0gMSkpIHsKICAgICAgcmV0dXJuICEhc2lnbmF0dXJlICYmIHRoaXMuc2lnbmVyc1swXS52ZXJpZnkoYmF0Y2gsIHNpZ25hdHVyZSkKICAgIH0KCiAgICByZXR1cm4gdGhpcy5fdmVyaWZ5TXVsdGkoYmF0Y2gsIHNpZ25hdHVyZSkKICB9CgogIF9pbmZsYXRlKHNpZ25hdHVyZSkgewogICAgaWYgKHRoaXMudmVyc2lvbiA+PSAxKSByZXR1cm4gbXVsdGlzaWcuaW5mbGF0ZShzaWduYXR1cmUpCiAgICBjb25zdCB7IHByb29mcywgcGF0Y2ggfSA9IG11bHRpc2lnLmluZmxhdGV2MChzaWduYXR1cmUpCgogICAgcmV0dXJuIHsKICAgICAgcHJvb2ZzOiBwcm9vZnMubWFwKHByb29mVG9WZXJzaW9uMSksCiAgICAgIHBhdGNoCiAgICB9CiAgfQoKICBfdmVyaWZ5TXVsdGkoYmF0Y2gsIHNpZ25hdHVyZSkgewogICAgaWYgKCFzaWduYXR1cmUgfHwgdGhpcy5xdW9ydW0gPT09IDApIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IHsgcHJvb2ZzLCBwYXRjaCB9ID0gdGhpcy5faW5mbGF0ZShzaWduYXR1cmUpCiAgICBpZiAocHJvb2ZzLmxlbmd0aCA8IHRoaXMucXVvcnVtKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCB0cmllZCA9IG5ldyBVaW50OEFycmF5KHRoaXMuc2lnbmVycy5sZW5ndGgpCiAgICBjb25zdCBub2RlcyA9IHRoaXMuYWxsb3dQYXRjaCAmJiBwYXRjaC5sZW5ndGggPyB0b01hcChwYXRjaCkgOiBudWxsCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnF1b3J1bTsgaSsrKSB7CiAgICAgIGNvbnN0IGlucCA9IHByb29mc1tpXQoKICAgICAgbGV0IHRyZWUgPSBiYXRjaAoKICAgICAgaWYgKGlucC5wYXRjaCAmJiB0aGlzLmFsbG93UGF0Y2gpIHsKICAgICAgICB0cmVlID0gYmF0Y2guY2xvbmUoKQoKICAgICAgICBjb25zdCB1cGdyYWRlID0gZ2VuZXJhdGVVcGdyYWRlKG5vZGVzLCBiYXRjaC5sZW5ndGgsIGlucC5wYXRjaCkKICAgICAgICBjb25zdCBwcm9vZiA9IHsKICAgICAgICAgIGZvcms6IHRyZWUuZm9yaywKICAgICAgICAgIGJsb2NrOiBudWxsLAogICAgICAgICAgaGFzaDogbnVsbCwKICAgICAgICAgIHNlZWs6IG51bGwsCiAgICAgICAgICB1cGdyYWRlLAogICAgICAgICAgbWFuaWZlc3Q6IG51bGwKICAgICAgICB9CgogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoIXRyZWUudmVyaWZ5VXBncmFkZShwcm9vZikpIHJldHVybiBmYWxzZQogICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaW5wLnNpZ25lciA+PSB0aGlzLnNpZ25lcnMubGVuZ3RoIHx8IHRyaWVkW2lucC5zaWduZXJdKSByZXR1cm4gZmFsc2UKICAgICAgdHJpZWRbaW5wLnNpZ25lcl0gPSAxCgogICAgICBjb25zdCBzID0gdGhpcy5zaWduZXJzW2lucC5zaWduZXJdCiAgICAgIGlmICghcy52ZXJpZnkodHJlZSwgaW5wLnNpZ25hdHVyZSkpIHJldHVybiBmYWxzZQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICB2ZXJpZnkoYmF0Y2gsIHNpZ25hdHVyZSkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgewogICAgICByZXR1cm4gdGhpcy5fdmVyaWZ5Q29tcGF0KGJhdGNoLCBzaWduYXR1cmUpCiAgICB9CgogICAgaWYgKHRoaXMucHJvbG9ndWUgIT09IG51bGwgJiYgYmF0Y2gubGVuZ3RoIDw9IHRoaXMucHJvbG9ndWUubGVuZ3RoKSB7CiAgICAgIHJldHVybiBiYXRjaC5sZW5ndGggPT09IHRoaXMucHJvbG9ndWUubGVuZ3RoICYmIGI0YS5lcXVhbHMoYmF0Y2guaGFzaCgpLCB0aGlzLnByb2xvZ3VlLmhhc2gpCiAgICB9CgogICAgcmV0dXJuIHRoaXMuX3ZlcmlmeU11bHRpKGJhdGNoLCBzaWduYXR1cmUpCiAgfQoKICAvLyBUT0RPOiBiZXR0ZXIgYXBpIGZvciB0aGlzIHRoYXQgaXMgbW9yZSAuLi4gbXVsdGlzaWctZXkKICBzaWduKGJhdGNoLCBrZXlQYWlyKSB7CiAgICBpZiAoIWtleVBhaXIgfHwgIWtleVBhaXIuc2VjcmV0S2V5KSB0aHJvdyBCQURfQVJHVU1FTlQoJ05vIGtleSBwYWlyIHdhcyBwYXNzZWQnKQoKICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLnNpZ25lcnMpIHsKICAgICAgaWYgKGI0YS5lcXVhbHMocy5wdWJsaWNLZXksIGtleVBhaXIucHVibGljS2V5KSkgewogICAgICAgIGNvbnN0IHNpZ25hdHVyZSA9IHMuc2lnbihiYXRjaCwga2V5UGFpcikKICAgICAgICBpZiAodGhpcy5zaWduZXJzLmxlbmd0aCAhPT0gMSB8fCB0aGlzLnZlcnNpb24gPT09IDApIHJldHVybiBzaWduYXR1cmUKICAgICAgICByZXR1cm4gdGhpcy5hc3NlbWJsZShbeyBzaWduZXI6IDAsIHNpZ25hdHVyZSwgcGF0Y2g6IDAsIG5vZGVzOiBudWxsIH1dKQogICAgICB9CiAgICB9CgogICAgdGhyb3cgQkFEX0FSR1VNRU5UKCdQdWJsaWMga2V5IGlzIG5vdCBhIGRlY2xhcmVkIHNpZ25lcicpCiAgfQoKICBhc3NlbWJsZShpbnB1dHMpIHsKICAgIHJldHVybiB0aGlzLnZlcnNpb24gPT09IDAgPyBtdWx0aXNpZy5hc3NlbWJsZXYwKGlucHV0cykgOiBtdWx0aXNpZy5hc3NlbWJsZShpbnB1dHMpCiAgfQoKICBzdGF0aWMgbWFuaWZlc3RIYXNoKG1hbmlmZXN0KSB7CiAgICByZXR1cm4gbWFuaWZlc3RIYXNoKG1hbmlmZXN0KQogIH0KCiAgc3RhdGljIGVuY29kZU1hbmlmZXN0KG1hbmlmZXN0KSB7CiAgICByZXR1cm4gYy5lbmNvZGUobS5tYW5pZmVzdCwgbWFuaWZlc3QpCiAgfQoKICBzdGF0aWMgZGVjb2RlTWFuaWZlc3QobWFuaWZlc3QpIHsKICAgIHJldHVybiBjLmRlY29kZShtLm1hbmlmZXN0LCBtYW5pZmVzdCkKICB9CgogIHN0YXRpYyBkZWZhdWx0U2lnbmVyTWFuaWZlc3QocHVibGljS2V5KSB7CiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiAxLAogICAgICBoYXNoOiAnYmxha2UyYicsCiAgICAgIGFsbG93UGF0Y2g6IGZhbHNlLAogICAgICBxdW9ydW06IDEsCiAgICAgIHNpZ25lcnM6IFsKICAgICAgICB7CiAgICAgICAgICBzaWduYXR1cmU6ICdlZDI1NTE5JywKICAgICAgICAgIG5hbWVzcGFjZTogY2Fwcy5ERUZBVUxUX05BTUVTUEFDRSwKICAgICAgICAgIHB1YmxpY0tleQogICAgICAgIH0KICAgICAgXSwKICAgICAgcHJvbG9ndWU6IG51bGwsCiAgICAgIGxpbmtlZDogbnVsbCwKICAgICAgdXNlckRhdGE6IG51bGwKICAgIH0KICB9CgogIHN0YXRpYyBmcm9tTWFuaWZlc3QobWFuaWZlc3QsIG9wdHMpIHsKICAgIGNvbnN0IG0gPSB0aGlzLmNyZWF0ZU1hbmlmZXN0KG1hbmlmZXN0KQogICAgcmV0dXJuIG5ldyB0aGlzKG1hbmlmZXN0SGFzaChtKSwgbSwgb3B0cykKICB9CgogIHN0YXRpYyBjcmVhdGVNYW5pZmVzdChpbnApIHsKICAgIGlmICghaW5wKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IG1hbmlmZXN0ID0gewogICAgICB2ZXJzaW9uOiBnZXRNYW5pZmVzdFZlcnNpb24oaW5wKSwgLy8gZGVmYXVsdHMgdG8gdjEKICAgICAgaGFzaDogJ2JsYWtlMmInLAogICAgICBhbGxvd1BhdGNoOiAhIWlucC5hbGxvd1BhdGNoLAogICAgICBxdW9ydW06IGRlZmF1bHRRdW9ydW0oaW5wKSwKICAgICAgc2lnbmVyczogaW5wLnNpZ25lcnMgPyBpbnAuc2lnbmVycy5tYXAocGFyc2VTaWduZXIpIDogW10sCiAgICAgIHByb2xvZ3VlOiBudWxsLAogICAgICBsaW5rZWQ6IG51bGwsCiAgICAgIHVzZXJEYXRhOiBpbnAudXNlckRhdGEgfHwgbnVsbAogICAgfQoKICAgIGlmIChpbnAuaGFzaCAmJiBpbnAuaGFzaCAhPT0gJ2JsYWtlMmInKSB0aHJvdyBCQURfQVJHVU1FTlQoJ09ubHkgQmxha2UyYiBoYXNoZXMgYXJlIHN1cHBvcnRlZCcpCgogICAgaWYgKGlucC5wcm9sb2d1ZSkgewogICAgICBpZiAoCiAgICAgICAgIShiNGEuaXNCdWZmZXIoaW5wLnByb2xvZ3VlLmhhc2gpICYmIGlucC5wcm9sb2d1ZS5oYXNoLmJ5dGVMZW5ndGggPT09IDMyKSB8fAogICAgICAgICEoaW5wLnByb2xvZ3VlLmxlbmd0aCA+PSAwKQogICAgICApIHsKICAgICAgICB0aHJvdyBCQURfQVJHVU1FTlQoJ0ludmFsaWQgcHJvbG9ndWUnKQogICAgICB9CgogICAgICBtYW5pZmVzdC5wcm9sb2d1ZSA9IGlucC5wcm9sb2d1ZQogICAgICBtYW5pZmVzdC5wcm9sb2d1ZS5oYXNoID0gdW5zbGFiKG1hbmlmZXN0LnByb2xvZ3VlLmhhc2gpCiAgICB9CgogICAgaWYgKG1hbmlmZXN0LnVzZXJEYXRhICE9PSBudWxsICYmIG1hbmlmZXN0LnZlcnNpb24gPCAyKSB7CiAgICAgIHRocm93IEJBRF9BUkdVTUVOVCgnSW52YWxpZCBmaWVsZDogdXNlckRhdGEnKQogICAgfQoKICAgIGlmIChpbnAubGlua2VkICYmIGlucC5saW5rZWQubGVuZ3RoKSB7CiAgICAgIGlmIChtYW5pZmVzdC52ZXJzaW9uIDwgMikgdGhyb3cgQkFEX0FSR1VNRU5UKCdJbnZhbGlkIGZpZWxkOiBsaW5rZWQnKQoKICAgICAgZm9yIChjb25zdCBrZXkgb2YgaW5wLmxpbmtlZCkgewogICAgICAgIGlmICghKGI0YS5pc0J1ZmZlcihrZXkpICYmIGtleS5ieXRlTGVuZ3RoID09PSAzMikpIHsKICAgICAgICAgIHRocm93IEJBRF9BUkdVTUVOVCgnSW52YWxpZCBrZXknKQogICAgICAgIH0KICAgICAgfQoKICAgICAgbWFuaWZlc3QubGlua2VkID0gaW5wLmxpbmtlZAogICAgfQoKICAgIHJldHVybiBtYW5pZmVzdAogIH0KCiAgc3RhdGljIGlzVmFsaWRNYW5pZmVzdChrZXksIG1hbmlmZXN0KSB7CiAgICByZXR1cm4gYjRhLmVxdWFscyhrZXksIG1hbmlmZXN0SGFzaChtYW5pZmVzdCkpCiAgfQoKICBzdGF0aWMgaXNDb21wYXQoa2V5LCBtYW5pZmVzdCkgewogICAgcmV0dXJuIGlzQ29tcGF0KGtleSwgbWFuaWZlc3QpCiAgfQoKICBzdGF0aWMgc2lnbihtYW5pZmVzdCwgYmF0Y2gsIGtleVBhaXIsIG9wdHMpIHsKICAgIHJldHVybiBWZXJpZmllci5mcm9tTWFuaWZlc3QobWFuaWZlc3QsIG9wdHMpLnNpZ24oYmF0Y2gsIGtleVBhaXIpCiAgfQp9CgpmdW5jdGlvbiB0b01hcChub2RlcykgewogIGNvbnN0IG0gPSBuZXcgTWFwKCkKICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIG0uc2V0KG5vZGUuaW5kZXgsIG5vZGUpCiAgcmV0dXJuIG0KfQoKZnVuY3Rpb24gaXNDb21wYXQoa2V5LCBtYW5pZmVzdCkgewogIHJldHVybiAhISgKICAgIG1hbmlmZXN0ICYmCiAgICBtYW5pZmVzdC5zaWduZXJzLmxlbmd0aCA9PT0gMSAmJgogICAgYjRhLmVxdWFscyhrZXksIG1hbmlmZXN0LnNpZ25lcnNbMF0ucHVibGljS2V5KQogICkKfQoKZnVuY3Rpb24gZGVmYXVsdFF1b3J1bShtYW4pIHsKICBpZiAodHlwZW9mIG1hbi5xdW9ydW0gPT09ICdudW1iZXInKSByZXR1cm4gbWFuLnF1b3J1bQogIGlmICghbWFuLnNpZ25lcnMgfHwgIW1hbi5zaWduZXJzLmxlbmd0aCkgcmV0dXJuIDAKICByZXR1cm4gKG1hbi5zaWduZXJzLmxlbmd0aCA+PiAxKSArIDEKfQoKZnVuY3Rpb24gZ2VuZXJhdGVVcGdyYWRlKHBhdGNoLCBzdGFydCwgbGVuZ3RoKSB7CiAgY29uc3QgdXBncmFkZSA9IHsgc3RhcnQsIGxlbmd0aCwgbm9kZXM6IG51bGwsIGFkZGl0aW9uYWxOb2RlczogW10sIHNpZ25hdHVyZTogbnVsbCB9CgogIGNvbnN0IGZyb20gPSBzdGFydCAqIDIKICBjb25zdCB0byA9IGZyb20gKyBsZW5ndGggKiAyCgogIGZvciAoY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcigwKTsgaXRlLmZ1bGxSb290KHRvKTsgaXRlLm5leHRUcmVlKCkpIHsKICAgIGlmIChpdGUuaW5kZXggKyBpdGUuZmFjdG9yIC8gMiA8IGZyb20pIGNvbnRpbnVlCgogICAgaWYgKHVwZ3JhZGUubm9kZXMgPT09IG51bGwgJiYgaXRlLmNvbnRhaW5zKGZyb20gLSAyKSkgewogICAgICB1cGdyYWRlLm5vZGVzID0gW10KCiAgICAgIGNvbnN0IHJvb3QgPSBpdGUuaW5kZXgKICAgICAgY29uc3QgdGFyZ2V0ID0gZnJvbSAtIDIKCiAgICAgIGl0ZS5zZWVrKHRhcmdldCkKCiAgICAgIHdoaWxlIChpdGUuaW5kZXggIT09IHJvb3QpIHsKICAgICAgICBpdGUuc2libGluZygpCiAgICAgICAgaWYgKGl0ZS5pbmRleCA+IHRhcmdldCkgdXBncmFkZS5ub2Rlcy5wdXNoKHBhdGNoLmdldChpdGUuaW5kZXgpKQogICAgICAgIGl0ZS5wYXJlbnQoKQogICAgICB9CgogICAgICBjb250aW51ZQogICAgfQoKICAgIGlmICh1cGdyYWRlLm5vZGVzID09PSBudWxsKSB1cGdyYWRlLm5vZGVzID0gW10KICAgIHVwZ3JhZGUubm9kZXMucHVzaChwYXRjaC5nZXQoaXRlLmluZGV4KSkKICB9CgogIGlmICh1cGdyYWRlLm5vZGVzID09PSBudWxsKSB1cGdyYWRlLm5vZGVzID0gW10KICByZXR1cm4gdXBncmFkZQp9CgpmdW5jdGlvbiBwYXJzZVNpZ25lcihzaWduZXIpIHsKICB2YWxpZGF0ZVNpZ25lcihzaWduZXIpCiAgcmV0dXJuIHsKICAgIHNpZ25hdHVyZTogJ2VkMjU1MTknLAogICAgbmFtZXNwYWNlOiB1bnNsYWIoc2lnbmVyLm5hbWVzcGFjZSB8fCBjYXBzLkRFRkFVTFRfTkFNRVNQQUNFKSwKICAgIHB1YmxpY0tleTogdW5zbGFiKHNpZ25lci5wdWJsaWNLZXkpCiAgfQp9CgpmdW5jdGlvbiB2YWxpZGF0ZVNpZ25lcihzaWduZXIpIHsKICBpZiAoIXNpZ25lciB8fCAhc2lnbmVyLnB1YmxpY0tleSkgdGhyb3cgQkFEX0FSR1VNRU5UKCdTaWduZXIgbWlzc2luZyBwdWJsaWMga2V5JykKICBpZiAoc2lnbmVyLnNpZ25hdHVyZSAmJiBzaWduZXIuc2lnbmF0dXJlICE9PSAnZWQyNTUxOScpIHsKICAgIHRocm93IEJBRF9BUkdVTUVOVCgnT25seSBFZDI1NTE5IHNpZ25hdHVyZXMgYXJlIHN1cHBvcnRlZCcpCiAgfQp9CgpmdW5jdGlvbiBtYW5pZmVzdEhhc2gobWFuaWZlc3QpIHsKICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogMzIsIGJ1ZmZlcjogbnVsbCB9CiAgbS5tYW5pZmVzdC5wcmVlbmNvZGUoc3RhdGUsIG1hbmlmZXN0KQogIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShzdGF0ZS5lbmQpCiAgYy5yYXcuZW5jb2RlKHN0YXRlLCBjYXBzLk1BTklGRVNUKQogIG0ubWFuaWZlc3QuZW5jb2RlKHN0YXRlLCBtYW5pZmVzdCkKICByZXR1cm4gY3J5cHRvLmhhc2goc3RhdGUuYnVmZmVyKQp9CgpmdW5jdGlvbiBwcm9vZlRvVmVyc2lvbjEocHJvb2YpIHsKICByZXR1cm4gewogICAgc2lnbmVyOiBwcm9vZi5zaWduZXIsCiAgICBzaWduYXR1cmU6IHByb29mLnNpZ25hdHVyZSwKICAgIHBhdGNoOiBwcm9vZi5wYXRjaCA/IHByb29mLnBhdGNoLmxlbmd0aCA6IDAKICB9Cn0KCmZ1bmN0aW9uIGdldE1hbmlmZXN0VmVyc2lvbihpbnApIHsKICBpZiAodHlwZW9mIGlucC52ZXJzaW9uID09PSAnbnVtYmVyJykgcmV0dXJuIGlucC52ZXJzaW9uCiAgaWYgKGlucC5saW5rZWQgJiYgaW5wLmxpbmtlZC5sZW5ndGgpIHJldHVybiAyCiAgaWYgKGlucC51c2VyRGF0YSkgcmV0dXJuIDIKICByZXR1cm4gMQp9CnsKICAibmFtZSI6ICJoeXBlcmNvcmUiLAogICJ2ZXJzaW9uIjogIjExLjIxLjUiLAogICJkZXNjcmlwdGlvbiI6ICJIeXBlcmNvcmUgaXMgYSBzZWN1cmUsIGRpc3RyaWJ1dGVkIGFwcGVuZC1vbmx5IGxvZyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuICYmIGx1bnRlIiwKICAgICJ0ZXN0IjogImJyaXR0bGUgdGVzdC9hbGwuanMiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmdlbmVyYXRlIjogImJyaXR0bGUgLXIgdGVzdC9hbGwuanMgdGVzdC8qLmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyY29yZS5naXQiCiAgfSwKICAiY29udHJpYnV0b3JzIjogWwogICAgewogICAgICAibmFtZSI6ICJNYXRoaWFzIEJ1dXMiLAogICAgICAiZW1haWwiOiAibWF0aGlhc2J1dXNAZ21haWwuY29tIiwKICAgICAgInVybCI6ICJodHRwczovL21hZmludG8uc2giCiAgICB9LAogICAgewogICAgICAibmFtZSI6ICJBbmRyZXcgT3NoZXJvZmYiLAogICAgICAiZW1haWwiOiAiYW5kcmV3b3NoQGdtYWlsLmNvbSIsCiAgICAgICJ1cmwiOiAiaHR0cHM6Ly9hbmRyZXdvc2guY29tIgogICAgfQogIF0sCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyY29yZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyY29yZSNyZWFkbWUiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiZXJyb3JzLmpzIiwKICAgICJtZXNzYWdlcy5qcyIsCiAgICAibGliLyoqLmpzIgogIF0sCiAgImltcG9ydHMiOiB7CiAgICAiZXZlbnRzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWV2ZW50cyIsCiAgICAgICJkZWZhdWx0IjogImV2ZW50cyIKICAgIH0KICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbSI6ICJeNi4wLjAiLAogICAgImI0YSI6ICJeMS4xLjAiLAogICAgImJhcmUtZXZlbnRzIjogIl4yLjIuMCIsCiAgICAiYmlnLXNwYXJzZS1hcnJheSI6ICJeMS4wLjMiLAogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuMTEuMCIsCiAgICAiZmFzdC1maWZvIjogIl4xLjMuMCIsCiAgICAiZmxhdC10cmVlIjogIl4xLjkuMCIsCiAgICAiaHlwZXJjb3JlLWNyeXB0byI6ICJeMy4yLjEiLAogICAgImh5cGVyY29yZS1lcnJvcnMiOiAiXjEuNS4wIiwKICAgICJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiAiXjEuMi4wIiwKICAgICJoeXBlcmNvcmUtc3RvcmFnZSI6ICJeMi4wLjAiLAogICAgImlzLW9wdGlvbnMiOiAiXjEuMC4xIiwKICAgICJuYW5vYXNzZXJ0IjogIl4yLjAuMCIsCiAgICAicHJvdG9tdXgiOiAiXjMuNS4wIiwKICAgICJxdWlja2JpdC11bml2ZXJzYWwiOiAiXjIuMi4wIiwKICAgICJyYW5kb20tYXJyYXktaXRlcmF0b3IiOiAiXjEuMC4wIiwKICAgICJzYWZldHktY2F0Y2giOiAiXjEuMC4xIiwKICAgICJzb2RpdW0tdW5pdmVyc2FsIjogIl41LjAuMSIsCiAgICAic3RyZWFteCI6ICJeMi4xMi40IiwKICAgICJ1bnNsYWIiOiAiXjEuMy4wIiwKICAgICJ6MzIiOiAiXjEuMC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjAuMCIsCiAgICAiZGVidWdnaW5nLXN0cmVhbSI6ICJeMy4xLjAiLAogICAgImh5cGVyc3dhcm0iOiAiXjQuMy42IiwKICAgICJsdW50ZSI6ICJeMS4zLjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiLAogICAgInJhY2hlIjogIl4xLjAuMCIsCiAgICAicmFuZ2UtcGFyc2VyIjogIl4xLjIuMSIsCiAgICAicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6ICJeMS4xLjAiLAogICAgInNwZWVkb21ldGVyIjogIl4xLjEuMCIsCiAgICAidGVzdC10bXAiOiAiXjEuMC4yIiwKICAgICJ0aW55LWJ5dGUtc2l6ZSI6ICJeMS4xLjAiLAogICAgInVkeC1uYXRpdmUiOiAiXjEuNi4xIiwKICAgICJ1bmNhdWdodHMiOiAiXjEuMS4wIgogIH0KfQpjb25zdCBESFQgPSByZXF1aXJlKCdkaHQtcnBjJykKY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCBtID0gcmVxdWlyZSgnLi9saWIvbWVzc2FnZXMnKQpjb25zdCBTb2NrZXRQb29sID0gcmVxdWlyZSgnLi9saWIvc29ja2V0LXBvb2wnKQpjb25zdCBQZXJzaXN0ZW50ID0gcmVxdWlyZSgnLi9saWIvcGVyc2lzdGVudCcpCmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJy4vbGliL3JvdXRlcicpCmNvbnN0IENhY2hlID0gcmVxdWlyZSgneGFjaGUnKQpjb25zdCBTZXJ2ZXIgPSByZXF1aXJlKCcuL2xpYi9zZXJ2ZXInKQpjb25zdCBjb25uZWN0ID0gcmVxdWlyZSgnLi9saWIvY29ubmVjdCcpCmNvbnN0IHsgRklSRVdBTEwsIEJPT1RTVFJBUF9OT0RFUywgS05PV05fTk9ERVMsIENPTU1BTkRTIH0gPSByZXF1aXJlKCcuL2xpYi9jb25zdGFudHMnKQpjb25zdCB7IGhhc2gsIGNyZWF0ZUtleVBhaXIgfSA9IHJlcXVpcmUoJy4vbGliL2NyeXB0bycpCmNvbnN0IHsgZGVjb2RlIH0gPSByZXF1aXJlKCdoeXBlcmNvcmUtaWQtZW5jb2RpbmcnKQpjb25zdCBSYXdTdHJlYW1TZXQgPSByZXF1aXJlKCcuL2xpYi9yYXctc3RyZWFtLXNldCcpCmNvbnN0IENvbm5lY3Rpb25Qb29sID0gcmVxdWlyZSgnLi9saWIvY29ubmVjdGlvbi1wb29sJykKY29uc3QgeyBTVFJFQU1fTk9UX0NPTk5FQ1RFRCB9ID0gcmVxdWlyZSgnLi9saWIvZXJyb3JzJykKCmNsYXNzIEh5cGVyREhUIGV4dGVuZHMgREhUIHsKICBjb25zdHJ1Y3RvcihvcHRzID0ge30pIHsKICAgIGNvbnN0IHBvcnQgPSBvcHRzLnBvcnQgfHwgNDk3MzcKICAgIGNvbnN0IGJvb3RzdHJhcCA9IG9wdHMuYm9vdHN0cmFwIHx8IEJPT1RTVFJBUF9OT0RFUwogICAgY29uc3Qgbm9kZXMgPSBvcHRzLm5vZGVzIHx8IEtOT1dOX05PREVTCgogICAgc3VwZXIoeyAuLi5vcHRzLCBwb3J0LCBib290c3RyYXAsIG5vZGVzLCBmaWx0ZXJOb2RlIH0pCgogICAgY29uc3QgeyByb3V0ZXIsIHJlbGF5QWRkcmVzc2VzLCBwZXJzaXN0ZW50IH0gPSBkZWZhdWx0Q2FjaGVPcHRzKG9wdHMpCgogICAgdGhpcy5kZWZhdWx0S2V5UGFpciA9IG9wdHMua2V5UGFpciB8fCBjcmVhdGVLZXlQYWlyKG9wdHMuc2VlZCkKICAgIHRoaXMubGlzdGVuaW5nID0gbmV3IFNldCgpCiAgICB0aGlzLmNvbm5lY3Rpb25LZWVwQWxpdmUgPQogICAgICBvcHRzLmNvbm5lY3Rpb25LZWVwQWxpdmUgPT09IGZhbHNlID8gMCA6IG9wdHMuY29ubmVjdGlvbktlZXBBbGl2ZSB8fCA1MDAwCgogICAgLy8gc3RhdHMgaXMgaW5oZXJpdGVkIGZyb20gZGh0LXJwYyBzbyBmd2QgdGhlIG9uZXMgZnJvbSB0aGVyZQogICAgdGhpcy5zdGF0cyA9IHsKICAgICAgcHVuY2hlczogeyBjb25zaXN0ZW50OiAwLCByYW5kb206IDAsIG9wZW46IDAgfSwKICAgICAgcmVsYXlpbmc6IHsgYXR0ZW1wdHM6IDAsIHN1Y2Nlc3NlczogMCwgYWJvcnRzOiAwIH0sCiAgICAgIC4uLnRoaXMuc3RhdHMKICAgIH0KICAgIHRoaXMucmF3U3RyZWFtcyA9IG5ldyBSYXdTdHJlYW1TZXQodGhpcykKCiAgICB0aGlzLl9yb3V0ZXIgPSBuZXcgUm91dGVyKHRoaXMsIHJvdXRlcikKICAgIHRoaXMuX3NvY2tldFBvb2wgPSBuZXcgU29ja2V0UG9vbCh0aGlzLCBvcHRzLmhvc3QgfHwgJzAuMC4wLjAnKQogICAgdGhpcy5fcGVyc2lzdGVudCA9IG51bGwKICAgIHRoaXMuX3ZhbGlkYXRlZExvY2FsQWRkcmVzc2VzID0gbmV3IE1hcCgpCiAgICB0aGlzLl9yZWxheUFkZHJlc3Nlc0NhY2hlID0gbmV3IENhY2hlKHJlbGF5QWRkcmVzc2VzKQoKICAgIHRoaXMuX2RlZmVyUmFuZG9tUHVuY2ggPSAhIW9wdHMuZGVmZXJSYW5kb21QdW5jaAogICAgdGhpcy5fbGFzdFJhbmRvbVB1bmNoID0gdGhpcy5fZGVmZXJSYW5kb21QdW5jaCA/IERhdGUubm93KCkgOiAwCiAgICB0aGlzLl9jb25uZWN0YWJsZSA9IHRydWUKICAgIHRoaXMuX3JhbmRvbVB1bmNoSW50ZXJ2YWwgPSBvcHRzLnJhbmRvbVB1bmNoSW50ZXJ2YWwgfHwgMjAwMDAgLy8gbWluIDIwcyBiZXR3ZWVuIHJhbmRvbSBwdW5jaGVzLi4uCiAgICB0aGlzLl9yYW5kb21QdW5jaGVzID0gMAogICAgdGhpcy5fcmFuZG9tUHVuY2hMaW1pdCA9IDEgLy8gc2V0IHRvIG9uZSBmb3IgZXh0cmEgc2FmZXR5IGZvciBub3cKCiAgICB0aGlzLm9uY2UoJ3BlcnNpc3RlbnQnLCAoKSA9PiB7CiAgICAgIHRoaXMuX3BlcnNpc3RlbnQgPSBuZXcgUGVyc2lzdGVudCh0aGlzLCBwZXJzaXN0ZW50KQogICAgfSkKCiAgICB0aGlzLm9uKCduZXR3b3JrLWNoYW5nZScsICgpID0+IHsKICAgICAgZm9yIChjb25zdCBzZXJ2ZXIgb2YgdGhpcy5saXN0ZW5pbmcpIHNlcnZlci5yZWZyZXNoKCkKICAgIH0pCgogICAgdGhpcy5vbignbmV0d29yay11cGRhdGUnLCAoKSA9PiB7CiAgICAgIGlmICghdGhpcy5vbmxpbmUpIHJldHVybgogICAgICBmb3IgKGNvbnN0IHNlcnZlciBvZiB0aGlzLmxpc3RlbmluZykgc2VydmVyLm5vdGlmeU9ubGluZSgpCiAgICB9KQogIH0KCiAgY29ubmVjdChyZW1vdGVQdWJsaWNLZXksIG9wdHMpIHsKICAgIHJldHVybiBjb25uZWN0KHRoaXMsIGRlY29kZShyZW1vdGVQdWJsaWNLZXkpLCBvcHRzKQogIH0KCiAgY3JlYXRlU2VydmVyKG9wdHMsIG9uY29ubmVjdGlvbikgewogICAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSByZXR1cm4gdGhpcy5jcmVhdGVTZXJ2ZXIoe30sIG9wdHMpCiAgICBpZiAob3B0cyAmJiBvcHRzLm9uY29ubmVjdGlvbikgb25jb25uZWN0aW9uID0gb3B0cy5vbmNvbm5lY3Rpb24KICAgIGNvbnN0IHMgPSBuZXcgU2VydmVyKHRoaXMsIG9wdHMpCiAgICBpZiAob25jb25uZWN0aW9uKSBzLm9uKCdjb25uZWN0aW9uJywgb25jb25uZWN0aW9uKQogICAgcmV0dXJuIHMKICB9CgogIHBvb2woKSB7CiAgICByZXR1cm4gbmV3IENvbm5lY3Rpb25Qb29sKHRoaXMpCiAgfQoKICBhc3luYyByZXN1bWUoeyBsb2cgPSBub29wIH0gPSB7fSkgewogICAgaWYgKHRoaXMuX2RlZmVyUmFuZG9tUHVuY2gpIHRoaXMuX2xhc3RSYW5kb21QdW5jaCA9IERhdGUubm93KCkKICAgIGF3YWl0IHN1cGVyLnJlc3VtZSh7IGxvZyB9KQogICAgY29uc3QgcmVzdW1pbmcgPSBbXQogICAgZm9yIChjb25zdCBzZXJ2ZXIgb2YgdGhpcy5saXN0ZW5pbmcpIHJlc3VtaW5nLnB1c2goc2VydmVyLnJlc3VtZSgpKQogICAgbG9nKCdSZXN1bWluZyBoeXBlcmRodCBzZXJ2ZXJzJykKICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChyZXN1bWluZykKICAgIGxvZygnRG9uZSwgaHlwZXJkaHQgZnVsbHkgcmVzdW1lZCcpCiAgfQoKICBhc3luYyBzdXNwZW5kKHsgbG9nID0gbm9vcCB9ID0ge30pIHsKICAgIHRoaXMuX2Nvbm5lY3RhYmxlID0gZmFsc2UgLy8ganVzdCBzbyBub3RoaW5nIGdldHMgY29ubmVjdGVkIGR1cmluZyBzdXNwZW5zaW9uCiAgICBjb25zdCBzdXNwZW5kaW5nID0gW10KICAgIGZvciAoY29uc3Qgc2VydmVyIG9mIHRoaXMubGlzdGVuaW5nKSBzdXNwZW5kaW5nLnB1c2goc2VydmVyLnN1c3BlbmQoKSkKICAgIGxvZygnU3VzcGVuZGluZyBhbGwgaHlwZXJkaHQgc2VydmVycycpCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc3VzcGVuZGluZykKICAgIGxvZygnRG9uZSwgY2xlYXJpbmcgYWxsIHJhdyBzdHJlYW1zJykKICAgIGF3YWl0IHRoaXMucmF3U3RyZWFtcy5jbGVhcigpCiAgICBsb2coJ0RvbmUsIHN1c3BlbmRpbmcgZGh0LXJwYycpCiAgICBhd2FpdCBzdXBlci5zdXNwZW5kKHsgbG9nIH0pCiAgICBsb2coJ0RvbmUsIGNsZWFyaW5nIHJhdyBzdHJlYW1zIGFnYWluJykKICAgIGF3YWl0IHRoaXMucmF3U3RyZWFtcy5jbGVhcigpCiAgICBsb2coJ0RvbmUsIGh5cGVyZGh0IGZ1bGx5IHN1c3BlbmRlZCcpCiAgICB0aGlzLl9jb25uZWN0YWJsZSA9IHRydWUKICB9CgogIGFzeW5jIGRlc3Ryb3koeyBmb3JjZSA9IGZhbHNlIH0gPSB7fSkgewogICAgaWYgKCFmb3JjZSkgewogICAgICBjb25zdCBjbG9zaW5nID0gW10KICAgICAgZm9yIChjb25zdCBzZXJ2ZXIgb2YgdGhpcy5saXN0ZW5pbmcpIGNsb3NpbmcucHVzaChzZXJ2ZXIuY2xvc2UoKSkKICAgICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKGNsb3NpbmcpCiAgICB9CiAgICB0aGlzLl9yb3V0ZXIuZGVzdHJveSgpCiAgICBpZiAodGhpcy5fcGVyc2lzdGVudCkgdGhpcy5fcGVyc2lzdGVudC5kZXN0cm95KCkKICAgIGF3YWl0IHRoaXMucmF3U3RyZWFtcy5jbGVhcigpCiAgICBhd2FpdCB0aGlzLl9zb2NrZXRQb29sLmRlc3Ryb3koKQogICAgYXdhaXQgc3VwZXIuZGVzdHJveSgpCiAgfQoKICBhc3luYyB2YWxpZGF0ZUxvY2FsQWRkcmVzc2VzKGFkZHJlc3NlcykgewogICAgY29uc3QgbGlzdCA9IFtdCiAgICBjb25zdCBzb2NrcyA9IFtdCiAgICBjb25zdCB3YWl0aW5nID0gW10KCiAgICBmb3IgKGNvbnN0IGFkZHIgb2YgYWRkcmVzc2VzKSB7CiAgICAgIGNvbnN0IHsgaG9zdCB9ID0gYWRkcgoKICAgICAgaWYgKHRoaXMuX3ZhbGlkYXRlZExvY2FsQWRkcmVzc2VzLmhhcyhob3N0KSkgewogICAgICAgIGlmIChhd2FpdCB0aGlzLl92YWxpZGF0ZWRMb2NhbEFkZHJlc3Nlcy5nZXQoaG9zdCkpIHsKICAgICAgICAgIGxpc3QucHVzaChhZGRyKQogICAgICAgIH0KICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBjb25zdCBzb2NrID0gdGhpcy51ZHguY3JlYXRlU29ja2V0KCkKICAgICAgdHJ5IHsKICAgICAgICBzb2NrLmJpbmQoMCwgaG9zdCkKICAgICAgfSBjYXRjaCB7CiAgICAgICAgdGhpcy5fdmFsaWRhdGVkTG9jYWxBZGRyZXNzZXMuc2V0KGhvc3QsIFByb21pc2UucmVzb2x2ZShmYWxzZSkpCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgc29ja3MucHVzaChzb2NrKQoKICAgICAgLy8gc2VtaSB0ZXJyaWJsZSBoZXVyaXN0aWMgdW50aWwgd2UgcHJvcGVyIGZpeCBsb2NhbCBjb25uZWN0aW9ucyBieSByYWNpbmcgdGhlbSB0byB0aGUgcmVtb3RlLi4uCiAgICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgIHNvY2sub24oJ21lc3NhZ2UnLCAoKSA9PiByZXNvbHZlKHRydWUpKQogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gcmVzb2x2ZShmYWxzZSksIDUwMCkKICAgICAgICBzb2NrLnRyeVNlbmQoYjRhLmFsbG9jKDEpLCBzb2NrLmFkZHJlc3MoKS5wb3J0LCBhZGRyLmhvc3QpCiAgICAgIH0pCgogICAgICB0aGlzLl92YWxpZGF0ZWRMb2NhbEFkZHJlc3Nlcy5zZXQoaG9zdCwgcHJvbWlzZSkKICAgICAgd2FpdGluZy5wdXNoKGFkZHIpCiAgICB9CgogICAgZm9yIChjb25zdCBhZGRyIG9mIHdhaXRpbmcpIHsKICAgICAgY29uc3QgeyBob3N0IH0gPSBhZGRyCiAgICAgIGlmICh0aGlzLl92YWxpZGF0ZWRMb2NhbEFkZHJlc3Nlcy5oYXMoaG9zdCkpIHsKICAgICAgICBpZiAoYXdhaXQgdGhpcy5fdmFsaWRhdGVkTG9jYWxBZGRyZXNzZXMuZ2V0KGhvc3QpKSB7CiAgICAgICAgICBsaXN0LnB1c2goYWRkcikKICAgICAgICB9CiAgICAgICAgY29udGludWUKICAgICAgfQogICAgfQoKICAgIGZvciAoY29uc3Qgc29jayBvZiBzb2NrcykgYXdhaXQgc29jay5jbG9zZSgpCgogICAgcmV0dXJuIGxpc3QKICB9CgogIGZpbmRQZWVyKHB1YmxpY0tleSwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB0YXJnZXQgPSBvcHRzLmhhc2ggPT09IGZhbHNlID8gcHVibGljS2V5IDogaGFzaChwdWJsaWNLZXkpCiAgICBvcHRzID0geyAuLi5vcHRzLCBtYXA6IG1hcEZpbmRQZWVyIH0KICAgIHJldHVybiB0aGlzLnF1ZXJ5KHsgdGFyZ2V0LCBjb21tYW5kOiBDT01NQU5EUy5GSU5EX1BFRVIsIHZhbHVlOiBudWxsIH0sIG9wdHMpCiAgfQoKICBsb29rdXAodGFyZ2V0LCBvcHRzID0ge30pIHsKICAgIG9wdHMgPSB7IC4uLm9wdHMsIG1hcDogbWFwTG9va3VwIH0KICAgIHJldHVybiB0aGlzLnF1ZXJ5KHsgdGFyZ2V0LCBjb21tYW5kOiBDT01NQU5EUy5MT09LVVAsIHZhbHVlOiBudWxsIH0sIG9wdHMpCiAgfQoKICBsb29rdXBBbmRVbmFubm91bmNlKHRhcmdldCwga2V5UGFpciwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB1bmFubm91bmNlcyA9IFtdCiAgICBjb25zdCBkaHQgPSB0aGlzCiAgICBjb25zdCB1c2VyQ29tbWl0ID0gb3B0cy5jb21taXQgfHwgbm9vcAogICAgY29uc3Qgc2lnblVuYW5ub3VuY2UgPSBvcHRzLnNpZ25VbmFubm91bmNlIHx8IFBlcnNpc3RlbnQuc2lnblVuYW5ub3VuY2UKCiAgICBpZiAodGhpcy5fcGVyc2lzdGVudCAhPT0gbnVsbCkgewogICAgICAvLyB1bmxpbmsgc2VsZgogICAgICB0aGlzLl9wZXJzaXN0ZW50LnVuYW5ub3VuY2UodGFyZ2V0LCBrZXlQYWlyLnB1YmxpY0tleSkKICAgIH0KCiAgICBvcHRzID0geyAuLi5vcHRzLCBtYXAsIGNvbW1pdCB9CiAgICByZXR1cm4gdGhpcy5xdWVyeSh7IHRhcmdldCwgY29tbWFuZDogQ09NTUFORFMuTE9PS1VQLCB2YWx1ZTogbnVsbCB9LCBvcHRzKQoKICAgIGFzeW5jIGZ1bmN0aW9uIGNvbW1pdChyZXBseSwgZGh0LCBxdWVyeSkgewogICAgICBhd2FpdCBQcm9taXNlLmFsbCh1bmFubm91bmNlcykgLy8gY2FuIG5ldmVyIGZhaWwsIGNhdWdodCBiZWxvdwogICAgICByZXR1cm4gdXNlckNvbW1pdChyZXBseSwgZGh0LCBxdWVyeSkKICAgIH0KCiAgICBmdW5jdGlvbiBtYXAocmVwbHkpIHsKICAgICAgY29uc3QgZGF0YSA9IG1hcExvb2t1cChyZXBseSkKCiAgICAgIGlmICghZGF0YSB8fCAhZGF0YS50b2tlbikgcmV0dXJuIGRhdGEKCiAgICAgIGxldCBmb3VuZCA9IGRhdGEucGVlcnMubGVuZ3RoID49IDIwCiAgICAgIGZvciAobGV0IGkgPSAwOyAhZm91bmQgJiYgaSA8IGRhdGEucGVlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBmb3VuZCA9IGI0YS5lcXVhbHMoZGF0YS5wZWVyc1tpXS5wdWJsaWNLZXksIGtleVBhaXIucHVibGljS2V5KQogICAgICB9CgogICAgICBpZiAoIWZvdW5kKSByZXR1cm4gZGF0YQoKICAgICAgaWYgKCFkYXRhLmZyb20uaWQpIHJldHVybiBkYXRhCgogICAgICB1bmFubm91bmNlcy5wdXNoKAogICAgICAgIGRodAogICAgICAgICAgLl9yZXF1ZXN0VW5hbm5vdW5jZShrZXlQYWlyLCBkaHQsIHRhcmdldCwgZGF0YS50b2tlbiwgZGF0YS5mcm9tLCBzaWduVW5hbm5vdW5jZSkKICAgICAgICAgIC5jYXRjaChzYWZldHlDYXRjaCkKICAgICAgKQoKICAgICAgcmV0dXJuIGRhdGEKICAgIH0KICB9CgogIHVuYW5ub3VuY2UodGFyZ2V0LCBrZXlQYWlyLCBvcHRzID0ge30pIHsKICAgIHJldHVybiB0aGlzLmxvb2t1cEFuZFVuYW5ub3VuY2UodGFyZ2V0LCBrZXlQYWlyLCBvcHRzKS5maW5pc2hlZCgpCiAgfQoKICBhbm5vdW5jZSh0YXJnZXQsIGtleVBhaXIsIHJlbGF5QWRkcmVzc2VzLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHNpZ25Bbm5vdW5jZSA9IG9wdHMuc2lnbkFubm91bmNlIHx8IFBlcnNpc3RlbnQuc2lnbkFubm91bmNlCiAgICBjb25zdCBidW1wID0gb3B0cy5idW1wIHx8IDAKCiAgICBvcHRzID0geyAuLi5vcHRzLCBjb21taXQgfQoKICAgIHJldHVybiBvcHRzLmNsZWFyID8gdGhpcy5sb29rdXBBbmRVbmFubm91bmNlKHRhcmdldCwga2V5UGFpciwgb3B0cykgOiB0aGlzLmxvb2t1cCh0YXJnZXQsIG9wdHMpCgogICAgZnVuY3Rpb24gY29tbWl0KHJlcGx5LCBkaHQpIHsKICAgICAgcmV0dXJuIGRodC5fcmVxdWVzdEFubm91bmNlKAogICAgICAgIGtleVBhaXIsCiAgICAgICAgZGh0LAogICAgICAgIHRhcmdldCwKICAgICAgICByZXBseS50b2tlbiwKICAgICAgICByZXBseS5mcm9tLAogICAgICAgIHJlbGF5QWRkcmVzc2VzLAogICAgICAgIHNpZ25Bbm5vdW5jZSwKICAgICAgICBidW1wCiAgICAgICkKICAgIH0KICB9CgogIGFzeW5jIGltbXV0YWJsZUdldCh0YXJnZXQsIG9wdHMgPSB7fSkgewogICAgb3B0cyA9IHsgLi4ub3B0cywgbWFwOiBtYXBJbW11dGFibGUgfQoKICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5xdWVyeSh7IHRhcmdldCwgY29tbWFuZDogQ09NTUFORFMuSU1NVVRBQkxFX0dFVCwgdmFsdWU6IG51bGwgfSwgb3B0cykKICAgIGNvbnN0IGNoZWNrID0gYjRhLmFsbG9jVW5zYWZlKDMyKQoKICAgIGZvciBhd2FpdCAoY29uc3Qgbm9kZSBvZiBxdWVyeSkgewogICAgICBjb25zdCB7IHZhbHVlIH0gPSBub2RlCiAgICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goY2hlY2ssIHZhbHVlKQogICAgICBpZiAoYjRhLmVxdWFscyhjaGVjaywgdGFyZ2V0KSkgcmV0dXJuIG5vZGUKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgYXN5bmMgaW1tdXRhYmxlUHV0KHZhbHVlLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHRhcmdldCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2godGFyZ2V0LCB2YWx1ZSkKCiAgICBvcHRzID0gewogICAgICAuLi5vcHRzLAogICAgICBtYXA6IG1hcEltbXV0YWJsZSwKICAgICAgY29tbWl0KHJlcGx5LCBkaHQpIHsKICAgICAgICByZXR1cm4gZGh0LnJlcXVlc3QoCiAgICAgICAgICB7IHRva2VuOiByZXBseS50b2tlbiwgdGFyZ2V0LCBjb21tYW5kOiBDT01NQU5EUy5JTU1VVEFCTEVfUFVULCB2YWx1ZSB9LAogICAgICAgICAgcmVwbHkuZnJvbQogICAgICAgICkKICAgICAgfQogICAgfQoKICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5xdWVyeSh7IHRhcmdldCwgY29tbWFuZDogQ09NTUFORFMuSU1NVVRBQkxFX0dFVCwgdmFsdWU6IG51bGwgfSwgb3B0cykKICAgIGF3YWl0IHF1ZXJ5LmZpbmlzaGVkKCkKCiAgICByZXR1cm4geyBoYXNoOiB0YXJnZXQsIGNsb3Nlc3ROb2RlczogcXVlcnkuY2xvc2VzdE5vZGVzIH0KICB9CgogIGFzeW5jIG11dGFibGVHZXQocHVibGljS2V5LCBvcHRzID0ge30pIHsKICAgIGxldCByZWZyZXNoID0gb3B0cy5yZWZyZXNoIHx8IG51bGwKICAgIGxldCBzaWduZWQgPSBudWxsCiAgICBsZXQgcmVzdWx0ID0gbnVsbAoKICAgIG9wdHMgPSB7IC4uLm9wdHMsIG1hcDogbWFwTXV0YWJsZSwgY29tbWl0OiByZWZyZXNoID8gY29tbWl0IDogbnVsbCB9CgogICAgY29uc3QgdGFyZ2V0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaCh0YXJnZXQsIHB1YmxpY0tleSkKCiAgICBjb25zdCB1c2VyU2VxID0gb3B0cy5zZXEgfHwgMAogICAgY29uc3QgcXVlcnkgPSB0aGlzLnF1ZXJ5KAogICAgICB7IHRhcmdldCwgY29tbWFuZDogQ09NTUFORFMuTVVUQUJMRV9HRVQsIHZhbHVlOiBjLmVuY29kZShjLnVpbnQsIHVzZXJTZXEpIH0sCiAgICAgIG9wdHMKICAgICkKICAgIGNvbnN0IGxhdGVzdCA9IG9wdHMubGF0ZXN0ICE9PSBmYWxzZQoKICAgIGZvciBhd2FpdCAoY29uc3Qgbm9kZSBvZiBxdWVyeSkgewogICAgICBpZiAocmVzdWx0ICYmIG5vZGUuc2VxIDw9IHJlc3VsdC5zZXEpIGNvbnRpbnVlCiAgICAgIGlmICgKICAgICAgICBub2RlLnNlcSA8IHVzZXJTZXEgfHwKICAgICAgICAhUGVyc2lzdGVudC52ZXJpZnlNdXRhYmxlKG5vZGUuc2lnbmF0dXJlLCBub2RlLnNlcSwgbm9kZS52YWx1ZSwgcHVibGljS2V5KQogICAgICApCiAgICAgICAgY29udGludWUKICAgICAgaWYgKCFsYXRlc3QpIHJldHVybiBub2RlCiAgICAgIGlmICghcmVzdWx0IHx8IG5vZGUuc2VxID4gcmVzdWx0LnNlcSkgcmVzdWx0ID0gbm9kZQogICAgfQoKICAgIHJldHVybiByZXN1bHQKCiAgICBmdW5jdGlvbiBjb21taXQocmVwbHksIGRodCkgewogICAgICBpZiAoIXNpZ25lZCAmJiByZXN1bHQgJiYgcmVmcmVzaCkgewogICAgICAgIGlmIChyZWZyZXNoKHJlc3VsdCkpIHsKICAgICAgICAgIHNpZ25lZCA9IGMuZW5jb2RlKG0ubXV0YWJsZVB1dFJlcXVlc3QsIHsKICAgICAgICAgICAgcHVibGljS2V5LAogICAgICAgICAgICBzZXE6IHJlc3VsdC5zZXEsCiAgICAgICAgICAgIHZhbHVlOiByZXN1bHQudmFsdWUsCiAgICAgICAgICAgIHNpZ25hdHVyZTogcmVzdWx0LnNpZ25hdHVyZQogICAgICAgICAgfSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVmcmVzaCA9IG51bGwKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBzaWduZWQKICAgICAgICA/IGRodC5yZXF1ZXN0KAogICAgICAgICAgICB7IHRva2VuOiByZXBseS50b2tlbiwgdGFyZ2V0LCBjb21tYW5kOiBDT01NQU5EUy5NVVRBQkxFX1BVVCwgdmFsdWU6IHNpZ25lZCB9LAogICAgICAgICAgICByZXBseS5mcm9tCiAgICAgICAgICApCiAgICAgICAgOiBQcm9taXNlLnJlc29sdmUobnVsbCkKICAgIH0KICB9CgogIGFzeW5jIG11dGFibGVQdXQoa2V5UGFpciwgdmFsdWUsIG9wdHMgPSB7fSkgewogICAgY29uc3Qgc2lnbk11dGFibGUgPSBvcHRzLnNpZ25NdXRhYmxlIHx8IFBlcnNpc3RlbnQuc2lnbk11dGFibGUKCiAgICBjb25zdCB0YXJnZXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKHRhcmdldCwga2V5UGFpci5wdWJsaWNLZXkpCgogICAgY29uc3Qgc2VxID0gb3B0cy5zZXEgfHwgMAogICAgY29uc3Qgc2lnbmF0dXJlID0gYXdhaXQgc2lnbk11dGFibGUoc2VxLCB2YWx1ZSwga2V5UGFpcikKCiAgICBjb25zdCBzaWduZWQgPSBjLmVuY29kZShtLm11dGFibGVQdXRSZXF1ZXN0LCB7CiAgICAgIHB1YmxpY0tleToga2V5UGFpci5wdWJsaWNLZXksCiAgICAgIHNlcSwKICAgICAgdmFsdWUsCiAgICAgIHNpZ25hdHVyZQogICAgfSkKCiAgICBvcHRzID0gewogICAgICAuLi5vcHRzLAogICAgICBtYXA6IG1hcE11dGFibGUsCiAgICAgIGNvbW1pdChyZXBseSwgZGh0KSB7CiAgICAgICAgcmV0dXJuIGRodC5yZXF1ZXN0KAogICAgICAgICAgeyB0b2tlbjogcmVwbHkudG9rZW4sIHRhcmdldCwgY29tbWFuZDogQ09NTUFORFMuTVVUQUJMRV9QVVQsIHZhbHVlOiBzaWduZWQgfSwKICAgICAgICAgIHJlcGx5LmZyb20KICAgICAgICApCiAgICAgIH0KICAgIH0KCiAgICAvLyB1c2Ugc2VxID0gMCwgZm9yIHRoZSBxdWVyeSBwYXJ0IGhlcmUsIGFzIHdlIGRvbid0IGNhcmUgYWJvdXQgdGhlIGFjdHVhbCB2YWx1ZXMKICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5xdWVyeSgKICAgICAgeyB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLk1VVEFCTEVfR0VULCB2YWx1ZTogYy5lbmNvZGUoYy51aW50LCAwKSB9LAogICAgICBvcHRzCiAgICApCiAgICBhd2FpdCBxdWVyeS5maW5pc2hlZCgpCgogICAgcmV0dXJuIHsgcHVibGljS2V5OiBrZXlQYWlyLnB1YmxpY0tleSwgY2xvc2VzdE5vZGVzOiBxdWVyeS5jbG9zZXN0Tm9kZXMsIHNlcSwgc2lnbmF0dXJlIH0KICB9CgogIG9ucmVxdWVzdChyZXEpIHsKICAgIHN3aXRjaCAocmVxLmNvbW1hbmQpIHsKICAgICAgY2FzZSBDT01NQU5EUy5QRUVSX0hBTkRTSEFLRTogewogICAgICAgIHRoaXMuX3JvdXRlci5vbnBlZXJoYW5kc2hha2UocmVxKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgICAgY2FzZSBDT01NQU5EUy5QRUVSX0hPTEVQVU5DSDogewogICAgICAgIHRoaXMuX3JvdXRlci5vbnBlZXJob2xlcHVuY2gocmVxKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5fcGVyc2lzdGVudCA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogICAgc3dpdGNoIChyZXEuY29tbWFuZCkgewogICAgICBjYXNlIENPTU1BTkRTLkZJTkRfUEVFUjogewogICAgICAgIHRoaXMuX3BlcnNpc3RlbnQub25maW5kcGVlcihyZXEpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgICBjYXNlIENPTU1BTkRTLkxPT0tVUDogewogICAgICAgIHRoaXMuX3BlcnNpc3RlbnQub25sb29rdXAocmVxKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgICAgY2FzZSBDT01NQU5EUy5BTk5PVU5DRTogewogICAgICAgIHRoaXMuX3BlcnNpc3RlbnQub25hbm5vdW5jZShyZXEpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgICBjYXNlIENPTU1BTkRTLlVOQU5OT1VOQ0U6IHsKICAgICAgICB0aGlzLl9wZXJzaXN0ZW50Lm9udW5hbm5vdW5jZShyZXEpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgICBjYXNlIENPTU1BTkRTLk1VVEFCTEVfUFVUOiB7CiAgICAgICAgdGhpcy5fcGVyc2lzdGVudC5vbm11dGFibGVwdXQocmVxKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgICAgY2FzZSBDT01NQU5EUy5NVVRBQkxFX0dFVDogewogICAgICAgIHRoaXMuX3BlcnNpc3RlbnQub25tdXRhYmxlZ2V0KHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIGNhc2UgQ09NTUFORFMuSU1NVVRBQkxFX1BVVDogewogICAgICAgIHRoaXMuX3BlcnNpc3RlbnQub25pbW11dGFibGVwdXQocmVxKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgICAgY2FzZSBDT01NQU5EUy5JTU1VVEFCTEVfR0VUOiB7CiAgICAgICAgdGhpcy5fcGVyc2lzdGVudC5vbmltbXV0YWJsZWdldChyZXEpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgc3RhdGljIGtleVBhaXIoc2VlZCkgewogICAgcmV0dXJuIGNyZWF0ZUtleVBhaXIoc2VlZCkKICB9CgogIHN0YXRpYyBoYXNoKGRhdGEpIHsKICAgIHJldHVybiBoYXNoKGRhdGEpCiAgfQoKICBzdGF0aWMgY29ubmVjdFJhd1N0cmVhbShlbmNyeXB0ZWRTdHJlYW0sIHJhd1N0cmVhbSwgcmVtb3RlSWQpIHsKICAgIGNvbnN0IHN0cmVhbSA9IGVuY3J5cHRlZFN0cmVhbS5yYXdTdHJlYW0KCiAgICBpZiAoIXN0cmVhbS5jb25uZWN0ZWQpIHRocm93IFNUUkVBTV9OT1RfQ09OTkVDVEVEKCkKCiAgICByYXdTdHJlYW0uY29ubmVjdChzdHJlYW0uc29ja2V0LCByZW1vdGVJZCwgc3RyZWFtLnJlbW90ZVBvcnQsIHN0cmVhbS5yZW1vdGVIb3N0KQogIH0KCiAgY3JlYXRlUmF3U3RyZWFtKG9wdHMpIHsKICAgIHJldHVybiB0aGlzLnJhd1N0cmVhbXMuYWRkKG9wdHMpCiAgfQoKICBhc3luYyBfcmVxdWVzdEFubm91bmNlKGtleVBhaXIsIGRodCwgdGFyZ2V0LCB0b2tlbiwgZnJvbSwgcmVsYXlBZGRyZXNzZXMsIHNpZ24sIGJ1bXApIHsKICAgIGNvbnN0IGFubiA9IHsKICAgICAgcGVlcjogewogICAgICAgIHB1YmxpY0tleToga2V5UGFpci5wdWJsaWNLZXksCiAgICAgICAgcmVsYXlBZGRyZXNzZXM6IHJlbGF5QWRkcmVzc2VzIHx8IFtdCiAgICAgIH0sCiAgICAgIHJlZnJlc2g6IG51bGwsCiAgICAgIHNpZ25hdHVyZTogbnVsbCwKICAgICAgYnVtcAogICAgfQoKICAgIGFubi5zaWduYXR1cmUgPSBhd2FpdCBzaWduKHRhcmdldCwgdG9rZW4sIGZyb20uaWQsIGFubiwga2V5UGFpcikKCiAgICBjb25zdCB2YWx1ZSA9IGMuZW5jb2RlKG0uYW5ub3VuY2UsIGFubikKCiAgICByZXR1cm4gZGh0LnJlcXVlc3QoCiAgICAgIHsKICAgICAgICB0b2tlbiwKICAgICAgICB0YXJnZXQsCiAgICAgICAgY29tbWFuZDogQ09NTUFORFMuQU5OT1VOQ0UsCiAgICAgICAgdmFsdWUKICAgICAgfSwKICAgICAgZnJvbQogICAgKQogIH0KCiAgYXN5bmMgX3JlcXVlc3RVbmFubm91bmNlKGtleVBhaXIsIGRodCwgdGFyZ2V0LCB0b2tlbiwgZnJvbSwgc2lnbikgewogICAgY29uc3QgdW5hbm4gPSB7CiAgICAgIHBlZXI6IHsKICAgICAgICBwdWJsaWNLZXk6IGtleVBhaXIucHVibGljS2V5LAogICAgICAgIHJlbGF5QWRkcmVzc2VzOiBbXQogICAgICB9LAogICAgICBzaWduYXR1cmU6IG51bGwKICAgIH0KCiAgICB1bmFubi5zaWduYXR1cmUgPSBhd2FpdCBzaWduKHRhcmdldCwgdG9rZW4sIGZyb20uaWQsIHVuYW5uLCBrZXlQYWlyKQoKICAgIGNvbnN0IHZhbHVlID0gYy5lbmNvZGUobS5hbm5vdW5jZSwgdW5hbm4pCgogICAgcmV0dXJuIGRodC5yZXF1ZXN0KAogICAgICB7CiAgICAgICAgdG9rZW4sCiAgICAgICAgdGFyZ2V0LAogICAgICAgIGNvbW1hbmQ6IENPTU1BTkRTLlVOQU5OT1VOQ0UsCiAgICAgICAgdmFsdWUKICAgICAgfSwKICAgICAgZnJvbQogICAgKQogIH0KfQoKSHlwZXJESFQuQk9PVFNUUkFQID0gQk9PVFNUUkFQX05PREVTCkh5cGVyREhULkZJUkVXQUxMID0gRklSRVdBTEwKCm1vZHVsZS5leHBvcnRzID0gSHlwZXJESFQKCmZ1bmN0aW9uIG1hcExvb2t1cChub2RlKSB7CiAgaWYgKCFub2RlLnZhbHVlKSByZXR1cm4gbnVsbAoKICBjb25zdCBsID0gYy5kZWNvZGUobS5sb29rdXBSYXdSZXBseSwgbm9kZS52YWx1ZSkKCiAgdHJ5IHsKICAgIHJldHVybiB7CiAgICAgIHRva2VuOiBub2RlLnRva2VuLAogICAgICBmcm9tOiBub2RlLmZyb20sCiAgICAgIHRvOiBub2RlLnRvLAogICAgICBwZWVyczogbC5wZWVycywKICAgICAgYnVtcDogbC5idW1wCiAgICB9CiAgfSBjYXRjaCB7CiAgICByZXR1cm4gbnVsbAogIH0KfQoKZnVuY3Rpb24gbWFwRmluZFBlZXIobm9kZSkgewogIGlmICghbm9kZS52YWx1ZSkgcmV0dXJuIG51bGwKCiAgdHJ5IHsKICAgIHJldHVybiB7CiAgICAgIHRva2VuOiBub2RlLnRva2VuLAogICAgICBmcm9tOiBub2RlLmZyb20sCiAgICAgIHRvOiBub2RlLnRvLAogICAgICBwZWVyOiBjLmRlY29kZShtLnBlZXIsIG5vZGUudmFsdWUpCiAgICB9CiAgfSBjYXRjaCB7CiAgICByZXR1cm4gbnVsbAogIH0KfQoKZnVuY3Rpb24gbWFwSW1tdXRhYmxlKG5vZGUpIHsKICBpZiAoIW5vZGUudmFsdWUpIHJldHVybiBudWxsCgogIHJldHVybiB7CiAgICB0b2tlbjogbm9kZS50b2tlbiwKICAgIGZyb206IG5vZGUuZnJvbSwKICAgIHRvOiBub2RlLnRvLAogICAgdmFsdWU6IG5vZGUudmFsdWUKICB9Cn0KCmZ1bmN0aW9uIG1hcE11dGFibGUobm9kZSkgewogIGlmICghbm9kZS52YWx1ZSkgcmV0dXJuIG51bGwKCiAgdHJ5IHsKICAgIGNvbnN0IHsgc2VxLCB2YWx1ZSwgc2lnbmF0dXJlIH0gPSBjLmRlY29kZShtLm11dGFibGVHZXRSZXNwb25zZSwgbm9kZS52YWx1ZSkKCiAgICByZXR1cm4gewogICAgICB0b2tlbjogbm9kZS50b2tlbiwKICAgICAgZnJvbTogbm9kZS5mcm9tLAogICAgICB0bzogbm9kZS50bywKICAgICAgc2VxLAogICAgICB2YWx1ZSwKICAgICAgc2lnbmF0dXJlCiAgICB9CiAgfSBjYXRjaCB7CiAgICByZXR1cm4gbnVsbAogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CgpmdW5jdGlvbiBmaWx0ZXJOb2RlKG5vZGUpIHsKICAvLyBhbHdheXMgc2tpcCB0aGVzZSB0ZXN0bmV0IG5vZGVzIHRoYXQgZ290IG1peGVkIGluIGJ5IGFjY2lkZW50LCB1bnRpbCB0aGV5IGdldCB1cGRhdGVkCiAgcmV0dXJuICgKICAgICEobm9kZS5wb3J0ID09PSA0OTczOCAmJiAobm9kZS5ob3N0ID09PSAnMTM0LjIwOS4yOC45OCcgfHwgbm9kZS5ob3N0ID09PSAnMTY3Ljk5LjE0Mi4xODUnKSkgJiYKICAgICEobm9kZS5wb3J0ID09PSA5NDAwICYmIG5vZGUuaG9zdCA9PT0gJzM1LjIzMy40Ny4yNTInKSAmJgogICAgIShub2RlLmhvc3QgPT09ICcxNTAuMTM2LjE0Mi4xMTYnKQogICkKfQoKY29uc3QgZGVmYXVsdE1heFNpemUgPSA2NTUzNgpjb25zdCBkZWZhdWx0TWF4QWdlID0gMjAgKiA2MCAqIDEwMDAgLy8gMjAgbWludXRlcwoKZnVuY3Rpb24gZGVmYXVsdENhY2hlT3B0cyhvcHRzKSB7CiAgY29uc3QgbWF4U2l6ZSA9IG9wdHMubWF4U2l6ZSB8fCBkZWZhdWx0TWF4U2l6ZQogIGNvbnN0IG1heEFnZSA9IG9wdHMubWF4QWdlIHx8IGRlZmF1bHRNYXhBZ2UKCiAgcmV0dXJuIHsKICAgIHJvdXRlcjogewogICAgICBmb3J3YXJkczogeyBtYXhTaXplLCBtYXhBZ2UgfQogICAgfSwKICAgIHJlbGF5QWRkcmVzc2VzOiB7IG1heFNpemU6IE1hdGgubWluKG1heFNpemUsIDUxMiksIG1heEFnZTogMCB9LAogICAgcGVyc2lzdGVudDogewogICAgICByZWNvcmRzOiB7IG1heFNpemUsIG1heEFnZSB9LAogICAgICByZWZyZXNoZXM6IHsgbWF4U2l6ZSwgbWF4QWdlIH0sCiAgICAgIG11dGFibGVzOiB7CiAgICAgICAgbWF4U2l6ZTogKG1heFNpemUgLyAyKSB8IDAsCiAgICAgICAgbWF4QWdlOiBvcHRzLm1heEFnZSB8fCA0OCAqIDYwICogNjAgKiAxMDAwIC8vIDQ4IGhvdXJzCiAgICAgIH0sCiAgICAgIGltbXV0YWJsZXM6IHsKICAgICAgICBtYXhTaXplOiAobWF4U2l6ZSAvIDIpIHwgMCwKICAgICAgICBtYXhBZ2U6IG9wdHMubWF4QWdlIHx8IDQ4ICogNjAgKiA2MCAqIDEwMDAgLy8gNDggaG91cnMKICAgICAgfSwKICAgICAgYnVtcHM6IHsgbWF4U2l6ZSwgbWF4QWdlIH0KICAgIH0KICB9Cn0KY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IFNpZ25hbCA9IHJlcXVpcmUoJ3NpZ25hbC1wcm9taXNlJykKY29uc3QgeyBlbmNvZGVVbnNsYWIgfSA9IHJlcXVpcmUoJy4vZW5jb2RlJykKY29uc3QgU2xlZXBlciA9IHJlcXVpcmUoJy4vc2xlZXBlcicpCmNvbnN0IG0gPSByZXF1aXJlKCcuL21lc3NhZ2VzJykKY29uc3QgUGVyc2lzdGVudCA9IHJlcXVpcmUoJy4vcGVyc2lzdGVudCcpCmNvbnN0IHsgQ09NTUFORFMgfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCmNvbnN0IE1JTl9BQ1RJVkUgPSAzCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEFubm91bmNlciB7CiAgY29uc3RydWN0b3IoZGh0LCBrZXlQYWlyLCB0YXJnZXQsIG9wdHMgPSB7fSkgewogICAgdGhpcy5kaHQgPSBkaHQKICAgIHRoaXMua2V5UGFpciA9IGtleVBhaXIKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0CiAgICB0aGlzLnJlbGF5cyA9IFtdCiAgICB0aGlzLnJlbGF5QWRkcmVzc2VzID0gW10KICAgIHRoaXMuc3RvcHBlZCA9IGZhbHNlCiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCiAgICB0aGlzLnJlY29yZCA9IGVuY29kZVVuc2xhYihtLnBlZXIsIHsgcHVibGljS2V5OiBrZXlQYWlyLnB1YmxpY0tleSwgcmVsYXlBZGRyZXNzZXM6IFtdIH0pCiAgICB0aGlzLm9ubGluZSA9IG5ldyBTaWduYWwoKQoKICAgIHRoaXMuX3JlZnJlc2hpbmcgPSBmYWxzZQogICAgdGhpcy5fY2xvc2VzdE5vZGVzID0gbnVsbAogICAgdGhpcy5fYWN0aXZlID0gbnVsbAogICAgdGhpcy5fc2xlZXBlciA9IG5ldyBTbGVlcGVyKCkKICAgIHRoaXMuX3Jlc3VtZWQgPSBuZXcgU2lnbmFsKCkKICAgIHRoaXMuX3NpZ25Bbm5vdW5jZSA9IG9wdHMuc2lnbkFubm91bmNlIHx8IFBlcnNpc3RlbnQuc2lnbkFubm91bmNlCiAgICB0aGlzLl9zaWduVW5hbm5vdW5jZSA9IG9wdHMuc2lnblVuYW5ub3VuY2UgfHwgUGVyc2lzdGVudC5zaWduVW5hbm5vdW5jZQogICAgdGhpcy5fdXBkYXRpbmcgPSBudWxsCiAgICB0aGlzLl9hY3RpdmVRdWVyeSA9IG51bGwKICAgIHRoaXMuX3VuYW5ub3VuY2luZyA9IG51bGwKCiAgICB0aGlzLl9zZXJ2ZXJSZWxheXMgPSBbbmV3IE1hcCgpLCBuZXcgTWFwKCksIG5ldyBNYXAoKV0KICB9CgogIGlzUmVsYXkoYWRkcikgewogICAgY29uc3QgaWQgPSBhZGRyLmhvc3QgKyAnOicgKyBhZGRyLnBvcnQKICAgIGNvbnN0IFthLCBiLCBjXSA9IHRoaXMuX3NlcnZlclJlbGF5cwogICAgcmV0dXJuIGEuaGFzKGlkKSB8fCBiLmhhcyhpZCkgfHwgYy5oYXMoaWQpCiAgfQoKICBhc3luYyBzdXNwZW5kKHsgbG9nID0gbm9vcCB9ID0ge30pIHsKICAgIGlmICh0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCiAgICB0aGlzLnN1c3BlbmRlZCA9IHRydWUKCiAgICBsb2coJ1N1c3BlbmRpbmcgYW5ub3VuY2VyJykKCiAgICAvLyBTdXNwZW5kIGhhcyBpdHMgb3duIHNsZWVwIGxvZ2ljCiAgICAvLyBzbyB3ZSBkb24ndCB3YW50IHRvIGhhbmcgb24gdGhpcyBvbmUKICAgIHRoaXMub25saW5lLm5vdGlmeSgpCgogICAgaWYgKHRoaXMuX2FjdGl2ZVF1ZXJ5KSB0aGlzLl9hY3RpdmVRdWVyeS5kZXN0cm95KCkKCiAgICB0aGlzLl9zbGVlcGVyLnJlc3VtZSgpCiAgICBpZiAodGhpcy5fdXBkYXRpbmcpIGF3YWl0IHRoaXMuX3VwZGF0aW5nCiAgICBsb2coJ1N1c3BlbmRpbmcgYW5ub3VuY2VyIChwb3N0IHVwZGF0ZSknKQoKICAgIGlmICh0aGlzLnN1c3BlbmRlZCA9PT0gZmFsc2UgfHwgdGhpcy5zdG9wcGVkKSByZXR1cm4KCiAgICBsb2coJ1N1c3BlbmRpbmcgYW5ub3VuY2VyIChwcmUgdW5hbm5vdW5jZSknKQogICAgYXdhaXQgdGhpcy5fdW5hbm5vdW5jZUN1cnJlbnQoKQogICAgbG9nKCdTdXNwZW5kaW5nIGFubm91bmNlciAocG9zdCB1bmFubm91bmNlKScpCiAgfQoKICByZXN1bWUoKSB7CiAgICBpZiAoIXRoaXMuc3VzcGVuZGVkKSByZXR1cm4KICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKCiAgICB0aGlzLnJlZnJlc2goKQogICAgdGhpcy5fc2xlZXBlci5yZXN1bWUoKQogICAgdGhpcy5fcmVzdW1lZC5ub3RpZnkoKQogIH0KCiAgcmVmcmVzaCgpIHsKICAgIGlmICh0aGlzLnN0b3BwZWQpIHJldHVybgogICAgdGhpcy5fcmVmcmVzaGluZyA9IHRydWUKICB9CgogIGFzeW5jIHN0YXJ0KCkgewogICAgaWYgKHRoaXMuc3RvcHBlZCkgcmV0dXJuCiAgICB0aGlzLl9hY3RpdmUgPSB0aGlzLl9ydW5VcGRhdGUoKQogICAgYXdhaXQgdGhpcy5fYWN0aXZlCiAgICBpZiAodGhpcy5zdG9wcGVkKSByZXR1cm4KICAgIHRoaXMuX2FjdGl2ZSA9IHRoaXMuX2JhY2tncm91bmQoKQogIH0KCiAgYXN5bmMgc3RvcCgpIHsKICAgIHRoaXMuc3RvcHBlZCA9IHRydWUKICAgIHRoaXMub25saW5lLm5vdGlmeSgpIC8vIEJyZWFrIG91dCBvZiB0aGUgX2JhY2tncm91bmQgbG9vcCBpZiB3ZSdyZSBvZmZsaW5lCiAgICB0aGlzLl9zbGVlcGVyLnJlc3VtZSgpCiAgICB0aGlzLl9yZXN1bWVkLm5vdGlmeSgpCiAgICBhd2FpdCB0aGlzLl9hY3RpdmUKICAgIGF3YWl0IHRoaXMuX3VuYW5ub3VuY2VDdXJyZW50KCkKICB9CgogIGFzeW5jIF91bmFubm91bmNlQ3VycmVudCgpIHsKICAgIHdoaWxlICh0aGlzLl91bmFubm91bmNpbmcgIT09IG51bGwpIGF3YWl0IHRoaXMuX3VuYW5ub3VuY2luZwogICAgY29uc3QgdW4gPSAodGhpcy5fdW5hbm5vdW5jaW5nID0gdGhpcy5fdW5hbm5vdW5jZUFsbCh0aGlzLl9zZXJ2ZXJSZWxheXNbMl0udmFsdWVzKCkpKQogICAgYXdhaXQgdGhpcy5fdW5hbm5vdW5jaW5nCiAgICBpZiAodW4gPT09IHRoaXMuX3VuYW5ub3VuY2luZykgdGhpcy5fdW5hbm5vdW5jaW5nID0gbnVsbAogIH0KCiAgYXN5bmMgX2JhY2tncm91bmQoKSB7CiAgICB3aGlsZSAoIXRoaXMuZGh0LmRlc3Ryb3llZCAmJiAhdGhpcy5zdG9wcGVkKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdGhpcy5fcmVmcmVzaGluZyA9IGZhbHNlCgogICAgICAgIC8vIH41bWluICstCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDAgJiYgIXRoaXMuc3RvcHBlZCAmJiAhdGhpcy5fcmVmcmVzaGluZyAmJiAhdGhpcy5zdXNwZW5kZWQ7IGkrKykgewogICAgICAgICAgY29uc3QgcGluZ3MgPSBbXQoKICAgICAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiB0aGlzLl9zZXJ2ZXJSZWxheXNbMl0udmFsdWVzKCkpIHsKICAgICAgICAgICAgcGluZ3MucHVzaCh0aGlzLmRodC5waW5nKG5vZGUpKQogICAgICAgICAgfQoKICAgICAgICAgIGNvbnN0IGFjdGl2ZSA9IGF3YWl0IHJlc29sdmVkKHBpbmdzKQogICAgICAgICAgaWYgKGFjdGl2ZSA8IE1hdGgubWluKHBpbmdzLmxlbmd0aCwgTUlOX0FDVElWRSkpIHsKICAgICAgICAgICAgdGhpcy5yZWZyZXNoKCkgLy8gd2UgbG9zdCB0b28gbWFueSByZWxheSBub2RlcywgcmV0cnkgYWxsCiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHRoaXMuc3RvcHBlZCkgcmV0dXJuCgogICAgICAgICAgaWYgKCF0aGlzLnN1c3BlbmRlZCAmJiAhdGhpcy5fcmVmcmVzaGluZykgYXdhaXQgdGhpcy5fc2xlZXBlci5wYXVzZSgzMDAwKQogICAgICAgIH0KCiAgICAgICAgd2hpbGUgKCF0aGlzLnN0b3BwZWQgJiYgdGhpcy5zdXNwZW5kZWQpIGF3YWl0IHRoaXMuX3Jlc3VtZWQud2FpdCgpCgogICAgICAgIGlmICghdGhpcy5zdG9wcGVkKSBhd2FpdCB0aGlzLl9ydW5VcGRhdGUoKQoKICAgICAgICB3aGlsZSAoIXRoaXMuZGh0Lm9ubGluZSAmJiAhdGhpcy5zdG9wcGVkICYmICF0aGlzLnN1c3BlbmRlZCkgewogICAgICAgICAgLy8gQmVpbmcgb2ZmbGluZSBjYW4gbWFrZSBfYmFja2dyb3VuZCByZXBlYXQgdmVyeSBxdWlja2x5CiAgICAgICAgICAvLyBTbyB3YWl0IHVudGlsIHdlJ3JlIGJhY2sgb25saW5lCiAgICAgICAgICBhd2FpdCB0aGlzLm9ubGluZS53YWl0KCkKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgX3J1blVwZGF0ZSgpIHsKICAgIHRoaXMuX3VwZGF0aW5nID0gdGhpcy5fdXBkYXRlKCkKICAgIGF3YWl0IHRoaXMuX3VwZGF0aW5nCiAgICB0aGlzLl91cGRhdGluZyA9IG51bGwKICB9CgogIGFzeW5jIF91cGRhdGUoKSB7CiAgICB3aGlsZSAodGhpcy5fdW5hbm5vdW5jaW5nKSBhd2FpdCB0aGlzLl91bmFubm91bmNpbmcKCiAgICB0aGlzLl9jeWNsZSgpCgogICAgY29uc3QgcSA9ICh0aGlzLl9hY3RpdmVRdWVyeSA9IHRoaXMuZGh0LmZpbmRQZWVyKHRoaXMudGFyZ2V0LCB7CiAgICAgIGhhc2g6IGZhbHNlLAogICAgICBub2RlczogdGhpcy5fY2xvc2VzdE5vZGVzCiAgICB9KSkKCiAgICB0cnkgewogICAgICBhd2FpdCBxLmZpbmlzaGVkKCkKICAgIH0gY2F0Y2ggewogICAgICAvLyBpZ25vcmUgZmFpbHVyZXMuLi4KICAgIH0KCiAgICB0aGlzLl9hY3RpdmVRdWVyeSA9IG51bGwKCiAgICBpZiAodGhpcy5zdG9wcGVkIHx8IHRoaXMuc3VzcGVuZGVkKSByZXR1cm4KCiAgICBjb25zdCBhbm4gPSBbXQogICAgY29uc3QgcmVwbGllcyA9IHBpY2tCZXN0KHEuY2xvc2VzdFJlcGxpZXMpCgogICAgY29uc3QgcmVsYXlzID0gW10KICAgIGNvbnN0IHJlbGF5QWRkcmVzc2VzID0gW10KCiAgICBpZiAoIXRoaXMuZGh0LmZpcmV3YWxsZWQpIHsKICAgICAgY29uc3QgYWRkciA9IHRoaXMuZGh0LnJlbW90ZUFkZHJlc3MoKQogICAgICBpZiAoYWRkcikgcmVsYXlBZGRyZXNzZXMucHVzaChhZGRyKQogICAgfQoKICAgIGZvciAoY29uc3QgbXNnIG9mIHJlcGxpZXMpIHsKICAgICAgYW5uLnB1c2godGhpcy5fY29tbWl0KG1zZywgcmVsYXlzLCByZWxheUFkZHJlc3NlcykpCiAgICB9CgogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKGFubikKICAgIGlmICh0aGlzLnN0b3BwZWQgfHwgdGhpcy5zdXNwZW5kZWQpIHJldHVybgoKICAgIHRoaXMuX2Nsb3Nlc3ROb2RlcyA9IHEuY2xvc2VzdE5vZGVzCiAgICB0aGlzLnJlbGF5cyA9IHJlbGF5cwogICAgdGhpcy5yZWxheUFkZHJlc3NlcyA9IHJlbGF5QWRkcmVzc2VzCgogICAgY29uc3QgcmVtb3ZlZCA9IFtdCiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiB0aGlzLl9zZXJ2ZXJSZWxheXNbMV0pIHsKICAgICAgaWYgKCF0aGlzLl9zZXJ2ZXJSZWxheXNbMl0uaGFzKGtleSkpIHJlbW92ZWQucHVzaCh2YWx1ZSkKICAgIH0KCiAgICBhd2FpdCB0aGlzLl91bmFubm91bmNlQWxsKHJlbW92ZWQpCiAgfQoKICBfdW5hbm5vdW5jZUFsbChyZWxheXMpIHsKICAgIGNvbnN0IHVuYW5uID0gW10KICAgIGZvciAoY29uc3QgciBvZiByZWxheXMpIHVuYW5uLnB1c2godGhpcy5fdW5hbm5vdW5jZShyKSkKICAgIHJldHVybiBQcm9taXNlLmFsbFNldHRsZWQodW5hbm4pCiAgfQoKICBhc3luYyBfdW5hbm5vdW5jZSh0bykgewogICAgY29uc3QgdW5hbm4gPSB7CiAgICAgIHBlZXI6IHsKICAgICAgICBwdWJsaWNLZXk6IHRoaXMua2V5UGFpci5wdWJsaWNLZXksCiAgICAgICAgcmVsYXlBZGRyZXNzZXM6IFtdCiAgICAgIH0sCiAgICAgIHJlZnJlc2g6IG51bGwsCiAgICAgIHNpZ25hdHVyZTogbnVsbAogICAgfQoKICAgIGNvbnN0IHsgZnJvbSwgdG9rZW4sIHZhbHVlIH0gPSBhd2FpdCB0aGlzLmRodC5yZXF1ZXN0KAogICAgICB7CiAgICAgICAgdG9rZW46IG51bGwsCiAgICAgICAgY29tbWFuZDogQ09NTUFORFMuRklORF9QRUVSLAogICAgICAgIHRhcmdldDogdGhpcy50YXJnZXQsCiAgICAgICAgdmFsdWU6IG51bGwKICAgICAgfSwKICAgICAgdG8KICAgICkKCiAgICBpZiAoIXRva2VuIHx8ICFmcm9tLmlkIHx8ICF2YWx1ZSkgcmV0dXJuCgogICAgdW5hbm4uc2lnbmF0dXJlID0gYXdhaXQgdGhpcy5fc2lnblVuYW5ub3VuY2UodGhpcy50YXJnZXQsIHRva2VuLCBmcm9tLmlkLCB1bmFubiwgdGhpcy5rZXlQYWlyKQoKICAgIGF3YWl0IHRoaXMuZGh0LnJlcXVlc3QoCiAgICAgIHsKICAgICAgICB0b2tlbiwKICAgICAgICBjb21tYW5kOiBDT01NQU5EUy5VTkFOTk9VTkNFLAogICAgICAgIHRhcmdldDogdGhpcy50YXJnZXQsCiAgICAgICAgdmFsdWU6IGMuZW5jb2RlKG0uYW5ub3VuY2UsIHVuYW5uKQogICAgICB9LAogICAgICB0bwogICAgKQogIH0KCiAgYXN5bmMgX2NvbW1pdChtc2csIHJlbGF5cywgcmVsYXlBZGRyZXNzZXMpIHsKICAgIGNvbnN0IGFubiA9IHsKICAgICAgcGVlcjogewogICAgICAgIHB1YmxpY0tleTogdGhpcy5rZXlQYWlyLnB1YmxpY0tleSwKICAgICAgICByZWxheUFkZHJlc3NlczogW10KICAgICAgfSwKICAgICAgcmVmcmVzaDogbnVsbCwKICAgICAgc2lnbmF0dXJlOiBudWxsCiAgICB9CgogICAgYW5uLnNpZ25hdHVyZSA9IGF3YWl0IHRoaXMuX3NpZ25Bbm5vdW5jZSh0aGlzLnRhcmdldCwgbXNnLnRva2VuLCBtc2cuZnJvbS5pZCwgYW5uLCB0aGlzLmtleVBhaXIpCgogICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5kaHQucmVxdWVzdCgKICAgICAgewogICAgICAgIHRva2VuOiBtc2cudG9rZW4sCiAgICAgICAgY29tbWFuZDogQ09NTUFORFMuQU5OT1VOQ0UsCiAgICAgICAgdGFyZ2V0OiB0aGlzLnRhcmdldCwKICAgICAgICB2YWx1ZTogYy5lbmNvZGUobS5hbm5vdW5jZSwgYW5uKQogICAgICB9LAogICAgICBtc2cuZnJvbQogICAgKQoKICAgIGlmIChyZXMuZXJyb3IgIT09IDApIHJldHVybgoKICAgIGlmIChyZWxheUFkZHJlc3Nlcy5sZW5ndGggPCAzKSByZWxheUFkZHJlc3Nlcy5wdXNoKHsgaG9zdDogbXNnLmZyb20uaG9zdCwgcG9ydDogbXNnLmZyb20ucG9ydCB9KQogICAgcmVsYXlzLnB1c2goeyByZWxheUFkZHJlc3M6IG1zZy5mcm9tLCBwZWVyQWRkcmVzczogbXNnLnRvIH0pCgogICAgdGhpcy5fc2VydmVyUmVsYXlzWzJdLnNldChtc2cuZnJvbS5ob3N0ICsgJzonICsgbXNnLmZyb20ucG9ydCwgbXNnLmZyb20pCiAgfQoKICBfY3ljbGUoKSB7CiAgICBjb25zdCB0bXAgPSB0aGlzLl9zZXJ2ZXJSZWxheXNbMF0KICAgIHRoaXMuX3NlcnZlclJlbGF5c1swXSA9IHRoaXMuX3NlcnZlclJlbGF5c1sxXQogICAgdGhpcy5fc2VydmVyUmVsYXlzWzFdID0gdGhpcy5fc2VydmVyUmVsYXlzWzJdCiAgICB0aGlzLl9zZXJ2ZXJSZWxheXNbMl0gPSB0bXAKICAgIHRtcC5jbGVhcigpCiAgfQp9CgpmdW5jdGlvbiByZXNvbHZlZChwcykgewogIGxldCByZXBsaWVkID0gMAogIGxldCB0aWNrcyA9IHBzLmxlbmd0aCArIDEKCiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICBmb3IgKGNvbnN0IHAgb2YgcHMpIHAudGhlbihwdXNoLCB0aWNrKQogICAgdGljaygpCgogICAgZnVuY3Rpb24gcHVzaCh2KSB7CiAgICAgIHJlcGxpZWQrKwogICAgICB0aWNrKCkKICAgIH0KCiAgICBmdW5jdGlvbiB0aWNrKCkgewogICAgICBpZiAoLS10aWNrcyA9PT0gMCkgcmVzb2x2ZShyZXBsaWVkKQogICAgfQogIH0pCn0KCmZ1bmN0aW9uIHBpY2tCZXN0KHJlcGxpZXMpIHsKICAvLyBUT0RPOiBwaWNrIHRoZSBvbmVzIGNsb3Nlc3QgdG8gdXMgUlRUIHdpc2UKICByZXR1cm4gcmVwbGllcy5zbGljZSgwLCAzKQp9CgpmdW5jdGlvbiBub29wKCkge30KY29uc3QgTm9pc2VTZWNyZXRTdHJlYW0gPSByZXF1aXJlKCdAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgcmVsYXkgPSByZXF1aXJlKCdibGluZC1yZWxheScpCmNvbnN0IHsgaXNQcml2YXRlLCBpc0JvZ29uIH0gPSByZXF1aXJlKCdib2dvbicpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKY29uc3QgU2VtYXBob3JlID0gcmVxdWlyZSgnLi9zZW1hcGhvcmUnKQpjb25zdCBOb2lzZVdyYXAgPSByZXF1aXJlKCcuL25vaXNlLXdyYXAnKQpjb25zdCBTZWN1cmVQYXlsb2FkID0gcmVxdWlyZSgnLi9zZWN1cmUtcGF5bG9hZCcpCmNvbnN0IEhvbGVwdW5jaGVyID0gcmVxdWlyZSgnLi9ob2xlcHVuY2hlcicpCmNvbnN0IFNsZWVwZXIgPSByZXF1aXJlKCcuL3NsZWVwZXInKQpjb25zdCB7IEZJUkVXQUxMLCBFUlJPUiB9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQpjb25zdCB7IHVuc2xhYmJlZEhhc2ggfSA9IHJlcXVpcmUoJy4vY3J5cHRvJykKY29uc3QgewogIENBTk5PVF9IT0xFUFVOQ0gsCiAgSEFORFNIQUtFX0lOVkFMSUQsCiAgSE9MRVBVTkNIX0FCT1JURUQsCiAgSE9MRVBVTkNIX0lOVkFMSUQsCiAgSE9MRVBVTkNIX1BST0JFX1RJTUVPVVQsCiAgSE9MRVBVTkNIX0RPVUJMRV9SQU5ET01JWkVEX05BVFMsCiAgUEVFUl9DT05ORUNUSU9OX0ZBSUxFRCwKICBQRUVSX05PVF9GT1VORCwKICBSRU1PVEVfQUJPUlRFRCwKICBSRU1PVEVfTk9UX0hPTEVQVU5DSEFCTEUsCiAgUkVNT1RFX05PVF9IT0xFUFVOQ0hJTkcsCiAgU0VSVkVSX0VSUk9SLAogIFNFUlZFUl9JTkNPTVBBVElCTEUsCiAgUkVMQVlfQUJPUlRFRCwKICBTVVNQRU5ERUQKfSA9IHJlcXVpcmUoJy4vZXJyb3JzJykKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gY29ubmVjdChkaHQsIHB1YmxpY0tleSwgb3B0cyA9IHt9KSB7CiAgY29uc3QgcG9vbCA9IG9wdHMucG9vbCB8fCBudWxsCgogIGlmIChwb29sICYmIHBvb2wuaGFzKHB1YmxpY0tleSkpIHJldHVybiBwb29sLmdldChwdWJsaWNLZXkpCgogIHB1YmxpY0tleSA9IHVuc2xhYihwdWJsaWNLZXkpCgogIGNvbnN0IGtleVBhaXIgPSBvcHRzLmtleVBhaXIgfHwgZGh0LmRlZmF1bHRLZXlQYWlyCiAgY29uc3QgcmVsYXlUaHJvdWdoID0gc2VsZWN0UmVsYXkob3B0cy5yZWxheVRocm91Z2ggfHwgbnVsbCkKICBjb25zdCBlbmNyeXB0ZWRTb2NrZXQgPSAob3B0cy5jcmVhdGVTZWNyZXRTdHJlYW0gfHwgZGVmYXVsdENyZWF0ZVNlY3JldFN0cmVhbSkodHJ1ZSwgbnVsbCwgewogICAgcHVibGljS2V5OiBrZXlQYWlyLnB1YmxpY0tleSwKICAgIHJlbW90ZVB1YmxpY0tleTogcHVibGljS2V5LAogICAgYXV0b1N0YXJ0OiBmYWxzZSwKICAgIGtlZXBBbGl2ZTogZGh0LmNvbm5lY3Rpb25LZWVwQWxpdmUKICB9KQoKICAvLyBpbiBjYXNlIGEgc29ja2V0IGlzIG1hZGUgZHVyaW5nIHN1c3BlbmRlZCBzdGF0ZSwgZGVzdHJveSBpdCBpbW1lZGlhdGVseQogIGlmIChkaHQuc3VzcGVuZGVkIHx8ICFkaHQuX2Nvbm5lY3RhYmxlKSB7CiAgICBlbmNyeXB0ZWRTb2NrZXQuZGVzdHJveShTVVNQRU5ERUQoKSkKICAgIHJldHVybiBlbmNyeXB0ZWRTb2NrZXQKICB9CgogIGlmIChwb29sKSBwb29sLl9hdHRhY2hTdHJlYW0oZW5jcnlwdGVkU29ja2V0LCBmYWxzZSkKCiAgY29uc3QgaWQgPSBiNGEudG9TdHJpbmcocHVibGljS2V5LCAnaGV4JykKICBjb25zdCBjID0gewogICAgaWQsCiAgICBkaHQsCiAgICBzZXNzaW9uOiBkaHQuc2Vzc2lvbigpLAogICAgcmVsYXlBZGRyZXNzZXM6IG9wdHMucmVsYXlBZGRyZXNzZXMgfHwgW10sCiAgICByZW1vdGVSZWxheUFkZHJlc3NlczogW10sCiAgICBwb29sLAogICAgcm91bmQ6IDAsCiAgICB0YXJnZXQ6IHVuc2xhYmJlZEhhc2gocHVibGljS2V5KSwKICAgIHJlbW90ZVB1YmxpY0tleTogcHVibGljS2V5LAogICAgcmV1c2FibGVTb2NrZXQ6ICEhb3B0cy5yZXVzYWJsZVNvY2tldCwKICAgIGhhbmRzaGFrZTogKG9wdHMuY3JlYXRlSGFuZHNoYWtlIHx8IGRlZmF1bHRDcmVhdGVIYW5kc2hha2UpKGtleVBhaXIsIHB1YmxpY0tleSksCiAgICByZXF1ZXN0OiBudWxsLAogICAgcmVxdWVzdGluZzogZmFsc2UsCiAgICBsYW46IG9wdHMubG9jYWxDb25uZWN0aW9uICE9PSBmYWxzZSwKICAgIGZpcmV3YWxsOiBGSVJFV0FMTC5VTktOT1dOLAogICAgcmF3U3RyZWFtOiBkaHQuY3JlYXRlUmF3U3RyZWFtKHsgZnJhbWVkOiB0cnVlLCBmaXJld2FsbCB9KSwKICAgIGNvbm5lY3Q6IG51bGwsCiAgICBxdWVyeTogbnVsbCwKICAgIHB1bmNoZXI6IG51bGwsCiAgICBwYXlsb2FkOiBudWxsLAogICAgcGFzc2l2ZUNvbm5lY3RUaW1lb3V0OiBudWxsLAogICAgc2VydmVyU29ja2V0OiBudWxsLAogICAgc2VydmVyQWRkcmVzczogbnVsbCwKICAgIG9uc29ja2V0OiBudWxsLAogICAgc2xlZXBlcjogbmV3IFNsZWVwZXIoKSwKICAgIGVuY3J5cHRlZFNvY2tldCwKCiAgICAvLyBSZWxheSBzdGF0ZQogICAgcmVsYXlUaW1lb3V0OiBudWxsLAogICAgcmVsYXlUaHJvdWdoLAogICAgcmVsYXlUb2tlbjogcmVsYXlUaHJvdWdoID8gcmVsYXkudG9rZW4oKSA6IG51bGwsCiAgICByZWxheVNvY2tldDogbnVsbCwKICAgIHJlbGF5Q2xpZW50OiBudWxsLAogICAgcmVsYXlQYWlyZWQ6IGZhbHNlLAogICAgcmVsYXlLZWVwQWxpdmU6IG9wdHMucmVsYXlLZWVwQWxpdmUgfHwgNTAwMAogIH0KCiAgLy8gSWYgdGhlIHJhdyBzdHJlYW0gcmVjZWl2ZXMgYW4gZXJyb3Igc2lnbmFsIHByZSBjb25uZWN0IChpZSBmcm9tIHRoZSBmaXJld2FsbCBob29rKSwgbWFrZSBzdXJlCiAgLy8gdG8gZm9yd2FyZCB0aGF0IHRvIHRoZSBlbmNyeXB0ZWQgc29ja2V0IGZvciBwcm9wZXIgdGVhcmRvd24KICBjLnJhd1N0cmVhbS5vbignZXJyb3InLCBhdXRvRGVzdHJveSkKICBjLnJhd1N0cmVhbS5vbmNlKCdjb25uZWN0JywgKCkgPT4gewogICAgYy5yYXdTdHJlYW0ucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgYXV0b0Rlc3Ryb3kpCiAgfSkKCiAgZW5jcnlwdGVkU29ja2V0Lm9uKCdjbG9zZScsIGZ1bmN0aW9uICgpIHsKICAgIGlmIChjLnBhc3NpdmVDb25uZWN0VGltZW91dCkgY2xlYXJQYXNzaXZlQ29ubmVjdFRpbWVvdXQoYykKICAgIGlmIChjLnF1ZXJ5KSBjLnF1ZXJ5LmRlc3Ryb3koKQogICAgaWYgKGMucHVuY2hlcikgYy5wdW5jaGVyLmRlc3Ryb3koKQogICAgaWYgKGMucmF3U3RyZWFtKSBjLnJhd1N0cmVhbS5kZXN0cm95KCkKICAgIGMuc2Vzc2lvbi5kZXN0cm95KCkKICAgIGMuc2xlZXBlci5yZXN1bWUoKQogIH0pCgogIC8vIFNhZmUgdG8gcnVuIGluIHRoZSBiYWNrZ3JvdW5kIC0gbmV2ZXIgdGhyb3dzCiAgaWYgKGRodC5zdXNwZW5kZWQpIGVuY3J5cHRlZFNvY2tldC5kZXN0cm95KFNVU1BFTkRFRCgpKQogIGVsc2UgY29ubmVjdEFuZEhvbGVwdW5jaChjLCBvcHRzKQoKICByZXR1cm4gZW5jcnlwdGVkU29ja2V0CgogIGZ1bmN0aW9uIGF1dG9EZXN0cm95KGVycikgewogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIGVycikKICB9CgogIGZ1bmN0aW9uIGZpcmV3YWxsKHNvY2tldCwgcG9ydCwgaG9zdCkgewogICAgLy8gQ2hlY2sgaWYgdGhlIHRyYWZmaWMgb3JpZ2luYXRlZCBmcm9tIHRoZSBzb2NrZXQgb24gd2hpY2ggd2UncmUgZXhwZWN0aW5nIHJlbGF5IHRyYWZmaWMuIElmIHNvLAogICAgLy8gd2UgaGF2ZW4ndCBob2xlIHB1bmNoZWQgeWV0IGFuZCB0aGUgb3RoZXIgc2lkZSBpcyBqdXN0IHNlbmRpbmcgdXMgdHJhZmZpYyB0aHJvdWdoIHRoZSByZWxheS4KICAgIGlmIChjLnJlbGF5U29ja2V0ICYmIGlzUmVsYXkoYy5yZWxheVNvY2tldCwgc29ja2V0LCBwb3J0LCBob3N0KSkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBpZiAoYy5vbnNvY2tldCkgewogICAgICBjLm9uc29ja2V0KHNvY2tldCwgcG9ydCwgaG9zdCkKICAgIH0gZWxzZSB7CiAgICAgIGMuc2VydmVyU29ja2V0ID0gc29ja2V0CiAgICAgIGMuc2VydmVyQWRkcmVzcyA9IHsgcG9ydCwgaG9zdCB9CiAgICB9CiAgICByZXR1cm4gZmFsc2UKICB9Cn0KCmZ1bmN0aW9uIGlzRG9uZShjKSB7CiAgLy8gd2UgYXJlIGRlc3Ryb3lpbmcgb3IgdGhlIHB1bmNoZXIgaXMgY29ubmVjdGVkIC0gZG9uZQogIGlmIChjLmVuY3J5cHRlZFNvY2tldC5kZXN0cm95aW5nIHx8ICEhKGMucHVuY2hlciAmJiBjLnB1bmNoZXIuY29ubmVjdGVkKSkgewogICAgcmV0dXJuIHRydWUKICB9CiAgLy8gbm90IGRlc3Ryb3lpbmcsIGJ1dCBubyByYXcgc3RyZWFtIC0gZGVmIG5vdCBkb25lCiAgaWYgKGMuZW5jcnlwdGVkU29ja2V0LnJhd1N0cmVhbSA9PT0gbnVsbCkgewogICAgcmV0dXJuIGZhbHNlCiAgfQogIC8vIHdlIGFyZSByZWxheWVkLCBidXQgdGhlIHB1bmNoZXIgaXMgbm90IGRvbmUgeWV0CiAgaWYgKGMucmVsYXlTb2NrZXQgJiYgISEoYy5wdW5jaGVyICYmICFjLnB1bmNoZXIuY29ubmVjdGVkICYmICFjLnB1bmNoZXIuZGVzdHJveWVkKSkgewogICAgcmV0dXJuIGZhbHNlCiAgfQogIC8vIHdlIGFyZSBkb25lCiAgcmV0dXJuIHRydWUKfQoKYXN5bmMgZnVuY3Rpb24gcmV0cnlSb3V0ZShjLCByb3V0ZSkgewogIGNvbnN0IHJlZiA9IGMuZGh0Ll9zb2NrZXRQb29sLmxvb2t1cChyb3V0ZS5zb2NrZXQpCgogIGlmICghcmVmKSB7CiAgICBpZiAocm91dGUuc29ja2V0ID09PSBjLmRodC5zb2NrZXQpIHsKICAgICAgYXdhaXQgY29ubmVjdFRocm91Z2hOb2RlKGMsIHJvdXRlLmFkZHJlc3MsIGMuZGh0LnNvY2tldCkKICAgIH0KICAgIHJldHVybgogIH0KCiAgcmVmLmFjdGl2ZSgpCgogIHRyeSB7CiAgICBhd2FpdCBjb25uZWN0VGhyb3VnaE5vZGUoYywgcm91dGUuYWRkcmVzcywgcm91dGUuc29ja2V0KQogIH0gY2F0Y2ggewogICAgLy8gaWYgZXJyb3IsIGp1c3QgaWdub3JlLCBhbmQgY29udGludWUgdGhyb3VnaCB0aGUgZXhpc3Rpbmcgc3RyYXQKICB9CgogIHJlZi5pbmFjdGl2ZSgpCn0KCmFzeW5jIGZ1bmN0aW9uIGNvbm5lY3RBbmRIb2xlcHVuY2goYywgb3B0cykgewogIGNvbnN0IHJvdXRlID0gYy5yZXVzYWJsZVNvY2tldCA/IGMuZGh0Ll9zb2NrZXRQb29sLnJvdXRlcy5nZXQoYy5yZW1vdGVQdWJsaWNLZXkpIDogbnVsbAoKICBpZiAocm91dGUpIHsKICAgIGF3YWl0IHJldHJ5Um91dGUoYywgcm91dGUpCiAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4KICB9CgogIGF3YWl0IGZpbmRBbmRDb25uZWN0KGMsIG9wdHMpCiAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCgogIGlmICghYy5jb25uZWN0KSB7CiAgICAvLyBUT0RPOiBqdXN0IGEgcXVpY2sgZml4IGZvciBub3csIHNob3VsZCByZXRyeSBwcm9iCiAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgSEFORFNIQUtFX0lOVkFMSUQoKSkKICAgIHJldHVybgogIH0KCiAgYXdhaXQgaG9sZXB1bmNoKGMsIG9wdHMpCn0KCmZ1bmN0aW9uIGdldEZpcnN0UmVtb3RlQWRkcmVzcyhhZGRycywgc2VydmVyQWRkcmVzcykgewogIGZvciAoY29uc3QgYWRkciBvZiBhZGRycykgewogICAgaWYgKGlzQm9nb24oYWRkci5ob3N0KSkgY29udGludWUKICAgIHJldHVybiBhZGRyCiAgfQoKICByZXR1cm4gc2VydmVyQWRkcmVzcwp9Cgphc3luYyBmdW5jdGlvbiBob2xlcHVuY2goYywgb3B0cykgewogIGxldCB7IHJlbGF5QWRkcmVzcywgc2VydmVyQWRkcmVzcywgY2xpZW50QWRkcmVzcywgcGF5bG9hZCB9ID0gYy5jb25uZWN0CgogIGNvbnN0IHJlbW90ZUhvbGVwdW5jaGFibGUgPSAhIShwYXlsb2FkLmhvbGVwdW5jaCAmJiBwYXlsb2FkLmhvbGVwdW5jaC5yZWxheXMubGVuZ3RoKQoKICBjb25zdCByZWxheWVkID0gZGlmZkFkZHJlc3Moc2VydmVyQWRkcmVzcywgcmVsYXlBZGRyZXNzKQoKICBpZiAocGF5bG9hZC5maXJld2FsbCA9PT0gRklSRVdBTEwuT1BFTiB8fCAocmVsYXllZCAmJiAhcmVtb3RlSG9sZXB1bmNoYWJsZSkpIHsKICAgIGNvbnN0IGFkZHIgPSBnZXRGaXJzdFJlbW90ZUFkZHJlc3MocGF5bG9hZC5hZGRyZXNzZXM0LCBzZXJ2ZXJBZGRyZXNzKQogICAgaWYgKGFkZHIpIHsKICAgICAgY29uc3Qgc29ja2V0ID0gYy5kaHQuc29ja2V0CiAgICAgIGMuZGh0LnN0YXRzLnB1bmNoZXMub3BlbisrCiAgICAgIGMub25zb2NrZXQoc29ja2V0LCBhZGRyLnBvcnQsIGFkZHIuaG9zdCkKICAgICAgcmV0dXJuCiAgICB9CiAgICAvLyBUT0RPOiBjaGVjayBhbGwgYWRkcmVzc2VzIGFsc28gb2J2cwogIH0KCiAgY29uc3Qgb25hYm9ydCA9ICgpID0+IHsKICAgIGMuc2Vzc2lvbi5kZXN0cm95KCkKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBIT0xFUFVOQ0hfQUJPUlRFRCgpKQogIH0KCiAgaWYgKGMuZmlyZXdhbGwgPT09IEZJUkVXQUxMLk9QRU4pIHsKICAgIGMucGFzc2l2ZUNvbm5lY3RUaW1lb3V0ID0gc2V0VGltZW91dChvbmFib3J0LCAxMDAwMCkKICAgIHJldHVybgogIH0KCiAgLy8gVE9ETzogd291bGQgYmUgYmV0dGVyIHRvIGp1c3QgdHJ5IGxvY2FsIGFkZHJzIGluIHRoZSBiYWNrZ3JvdW5kIHdoaWxzdCBjb250aW51aW5nIHdpdGggb3RoZXIgc3RyYXRlZ2llcy4uLgogIGlmIChjLmxhbiAmJiByZWxheWVkICYmIGNsaWVudEFkZHJlc3MuaG9zdCA9PT0gc2VydmVyQWRkcmVzcy5ob3N0KSB7CiAgICBjb25zdCBzZXJ2ZXJBZGRyZXNzZXMgPSBwYXlsb2FkLmFkZHJlc3NlczQuZmlsdGVyKG9ubHlQcml2YXRlSG9zdHMpCgogICAgaWYgKHNlcnZlckFkZHJlc3Nlcy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG15QWRkcmVzc2VzID0gSG9sZXB1bmNoZXIubG9jYWxBZGRyZXNzZXMoYy5kaHQuaW8uc2VydmVyU29ja2V0KQogICAgICBjb25zdCBhZGRyID0gSG9sZXB1bmNoZXIubWF0Y2hBZGRyZXNzKG15QWRkcmVzc2VzLCBzZXJ2ZXJBZGRyZXNzZXMpIHx8IHNlcnZlckFkZHJlc3Nlc1swXQoKICAgICAgY29uc3Qgc29ja2V0ID0gYy5kaHQuaW8uc2VydmVyU29ja2V0CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgYy5kaHQucGluZyhhZGRyKQogICAgICB9IGNhdGNoIHsKICAgICAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgSE9MRVBVTkNIX0FCT1JURUQoKSkKICAgICAgICByZXR1cm4KICAgICAgfQogICAgICBjLm9uc29ja2V0KHNvY2tldCwgYWRkci5wb3J0LCBhZGRyLmhvc3QpCiAgICAgIHJldHVybgogICAgfQogIH0KCiAgaWYgKCFyZW1vdGVIb2xlcHVuY2hhYmxlKSB7CiAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgQ0FOTk9UX0hPTEVQVU5DSCgpKQogICAgcmV0dXJuCiAgfQoKICBjLnB1bmNoZXIgPSBuZXcgSG9sZXB1bmNoZXIoYy5kaHQsIGMuc2Vzc2lvbiwgdHJ1ZSwgcGF5bG9hZC5maXJld2FsbCkKCiAgYy5wdW5jaGVyLm9uY29ubmVjdCA9IGMub25zb2NrZXQKICBjLnB1bmNoZXIub25hYm9ydCA9IG9uYWJvcnQKCiAgY29uc3Qgc2VydmVyUmVsYXkgPSBwaWNrU2VydmVyUmVsYXkocGF5bG9hZC5ob2xlcHVuY2gucmVsYXlzLCByZWxheUFkZHJlc3MpCgogIC8vIEJlZ2luIGhvbGVwdW5jaGluZyEKCiAgbGV0IHByb2JlCiAgdHJ5IHsKICAgIHByb2JlID0gYXdhaXQgcHJvYmVSb3VuZChjLCBvcHRzLmZhc3RPcGVuID09PSBmYWxzZSA/IG51bGwgOiBzZXJ2ZXJBZGRyZXNzLCBzZXJ2ZXJSZWxheSwgdHJ1ZSkKICB9IGNhdGNoIChlcnIpIHsKICAgIGRlc3Ryb3lQdW5jaGVyKGMpCiAgICAvLyBUT0RPOiB3ZSBzaG91bGQgcmV0cnkgaGVyZSB3aXRoIHNvbWUgb2YgdGhlIG90aGVyIHJlbGF5cywgYmFpbCBmb3Igbm93CiAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgZXJyKQogICAgcmV0dXJuCiAgfQoKICBpZiAoaXNEb25lKGMpIHx8ICFwcm9iZSkgcmV0dXJuCiAgY29uc3QgeyB0b2tlbiwgcGVlckFkZHJlc3MgfSA9IHByb2JlCgogIC8vIElmIHRoZSByZWxheSB0aGUgc2VydmVyIHBpY2tlZCBpcyB0aGUgc2FtZSBhcyB0aGUgcmVsYXkgdGhlIGNsaWVudCBwaWNrZWQsCiAgLy8gdGhlbiB3ZSBjYW4gdXNlIHRoZSBwZWVyQWRkcmVzcyB0aGF0IHJvdW5kIG9uZSBpbmRpY2F0ZXMgdGhlIHNlcnZlciB3YW50cyB0byB1c2UuCiAgLy8gVGhpcyBzaGF2ZXMgb2ZmIGEgcm91bmR0cmlwIGlmIHRoZSBzZXJ2ZXIgY2hvc2UgdG8gcmVyb2xsIGl0cyBzb2NrZXQgZHVlIHRvIHNvbWUgTkFUCiAgLy8gaXNzdWUgd2l0aCB0aGUgZmlyc3Qgb25lIGl0IHBpY2tlZCAoaWUgbW9iaWxlIG5hdCBpbmNvbnNpc3RlbmNpZXMuLi4pLgogIC8vIElmIHRoZSByZWxheXMgd2VyZSBkaWZmZXJlbnQsIHRoZW4gdGhlIHNlcnZlciB3b3VsZCBub3QgaGF2ZSBhIFVEUCBzZXNzaW9uIG9wZW4gb24gdGhpcyBhZGRyZXNzCiAgLy8gdG8gdGhlIGNsaWVudCByZWxheSwgd2hpY2ggcm91bmQyIHVzZXMuCiAgaWYgKAogICAgIWRpZmZBZGRyZXNzKHNlcnZlclJlbGF5LnJlbGF5QWRkcmVzcywgcmVsYXlBZGRyZXNzKSAmJgogICAgZGlmZkFkZHJlc3Moc2VydmVyQWRkcmVzcywgcGVlckFkZHJlc3MpCiAgKSB7CiAgICBzZXJ2ZXJBZGRyZXNzID0gcGVlckFkZHJlc3MKICAgIGF3YWl0IGMucHVuY2hlci5vcGVuU2Vzc2lvbihzZXJ2ZXJBZGRyZXNzKQogICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCiAgfQoKICAvLyBUT0RPOiBzdGlsbCBjb250aW51ZSBoZXJlIGlmIGEgbG9jYWwgY29ubmVjdGlvbiBtaWdodCB3b3JrLCBidXQgdGhlbiBkbyBub3QgaG9sZXB1bmNoLi4uCiAgaWYgKAogICAgb3B0cy5ob2xlcHVuY2ggJiYKICAgICFvcHRzLmhvbGVwdW5jaCgKICAgICAgYy5wdW5jaGVyLnJlbW90ZUZpcmV3YWxsLAogICAgICBjLnB1bmNoZXIubmF0LmZpcmV3YWxsLAogICAgICBjLnB1bmNoZXIucmVtb3RlQWRkcmVzc2VzLAogICAgICBjLnB1bmNoZXIubmF0LmFkZHJlc3NlcwogICAgKQogICkgewogICAgYXdhaXQgYWJvcnQoYywgc2VydmVyUmVsYXksIEhPTEVQVU5DSF9BQk9SVEVEKCdDbGllbnQgYWJvcnRlZCBob2xlcHVuY2gnKSkKICAgIHJldHVybgogIH0KCiAgdHJ5IHsKICAgIGF3YWl0IHJvdW5kUHVuY2goYywgc2VydmVyQWRkcmVzcywgdG9rZW4sIHJlbGF5QWRkcmVzcywgc2VydmVyUmVsYXksIGZhbHNlKQogIH0gY2F0Y2ggKGVycikgewogICAgZGVzdHJveVB1bmNoZXIoYykKICAgIC8vIFRPRE86IHJldHJ5IHdpdGggYW5vdGhlciByZWxheT8KICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBlcnIpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBmaW5kQW5kQ29ubmVjdChjLCBvcHRzKSB7CiAgbGV0IGF0dGVtcHRzID0gMAogIGxldCBjbG9zZXN0Tm9kZXMgPSBvcHRzLnJlbGF5QWRkcmVzc2VzICYmIG9wdHMucmVsYXlBZGRyZXNzZXMubGVuZ3RoID8gb3B0cy5yZWxheUFkZHJlc3NlcyA6IG51bGwKCiAgaWYgKCFjbG9zZXN0Tm9kZXMpIHsKICAgIGNvbnN0IGNhY2hlZFJlbGF5QWRkcmVzc2VzID0gYy5kaHQuX3JlbGF5QWRkcmVzc2VzQ2FjaGUuZ2V0KGMuaWQpCiAgICBpZiAoY2FjaGVkUmVsYXlBZGRyZXNzZXMpIGNsb3Nlc3ROb2RlcyA9IGNhY2hlZFJlbGF5QWRkcmVzc2VzCiAgfQoKICBpZiAoYy5kaHQuX3BlcnNpc3RlbnQpIHsKICAgIC8vIGNoZWNrIGlmIHdlIGtub3cgdGhlIHJvdXRlIG91cnNlbGYuLi4KICAgIGNvbnN0IHJvdXRlID0gYy5kaHQuX3JvdXRlci5nZXQoYy50YXJnZXQpCiAgICBpZiAocm91dGUgJiYgcm91dGUucmVsYXkgIT09IG51bGwpIHsKICAgICAgY2xvc2VzdE5vZGVzID0gW3sgaG9zdDogcm91dGUucmVsYXkuaG9zdCwgcG9ydDogcm91dGUucmVsYXkucG9ydCB9XQogICAgfQogIH0KCiAgLy8gMiBpcyBob3cgbWFueSBwYXJhbGxlbCBjb25uZWN0IGF0dGVtcHRzIHdlIHdhbnQgdG8gZG8sIHdlIGNhbiBtYWtlIHRoaXMgY29uZmlndXJhYmxlCiAgY29uc3Qgc2VtID0gbmV3IFNlbWFwaG9yZSgyKQogIGNvbnN0IHNpZ25hbCA9IHNlbS5zaWduYWwuYmluZChzZW0pCiAgY29uc3QgdHJpZXMgPSBjbG9zZXN0Tm9kZXMgIT09IG51bGwgPyAyIDogMQoKICB0cnkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0cmllcyAmJiAhaXNEb25lKGMpICYmICFjLmNvbm5lY3Q7IGkrKykgewogICAgICBjLnF1ZXJ5ID0gYy5kaHQuZmluZFBlZXIoYy50YXJnZXQsIHsKICAgICAgICBoYXNoOiBmYWxzZSwKICAgICAgICBzZXNzaW9uOiBjLnNlc3Npb24sCiAgICAgICAgY2xvc2VzdE5vZGVzLAogICAgICAgIG9ubHlDbG9zZXN0Tm9kZXM6IGNsb3Nlc3ROb2RlcyAhPT0gbnVsbCwKICAgICAgICByZXRyaWVzOiBjbG9zZXN0Tm9kZXMgPyAxIDogMwogICAgICB9KQoKICAgICAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIGMucXVlcnkpIHsKICAgICAgICBhd2FpdCBzZW0ud2FpdCgpCiAgICAgICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCgogICAgICAgIGlmIChjLmNvbm5lY3QpIHsKICAgICAgICAgIHNlbS5zaWduYWwoKQogICAgICAgICAgYnJlYWsKICAgICAgICB9CgogICAgICAgIGMucmVtb3RlUmVsYXlBZGRyZXNzZXMucHVzaChkYXRhLmZyb20pCiAgICAgICAgYXR0ZW1wdHMrKwogICAgICAgIGNvbm5lY3RUaHJvdWdoTm9kZShjLCBkYXRhLmZyb20sIG51bGwpLnRoZW4oc2lnbmFsLCBzaWduYWwpCiAgICAgIH0KCiAgICAgIGNsb3Nlc3ROb2RlcyA9IG51bGwKCiAgICAgIGlmIChhdHRlbXB0cyA+IDApIGF3YWl0IHNlbS5mbHVzaCgpCiAgICB9CgogICAgYy5xdWVyeSA9IG51bGwKICAgIGlmIChpc0RvbmUoYykpIHJldHVybgoKICAgIC8vIGZsdXNoIHRoZSBzZW1hcGhvcmUKICAgIGF3YWl0IHNlbS5mbHVzaCgpCiAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4KICB9IGNhdGNoIChlcnIpIHsKICAgIGMucXVlcnkgPSBudWxsCiAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgZXJyKQogICAgcmV0dXJuCiAgfQoKICBpZiAoIWMuY29ubmVjdCkgewogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIGF0dGVtcHRzID8gUEVFUl9DT05ORUNUSU9OX0ZBSUxFRCgpIDogUEVFUl9OT1RfRk9VTkQoKSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGNvbm5lY3RUaHJvdWdoTm9kZShjLCBhZGRyZXNzLCBzb2NrZXQpIHsKICBpZiAoIWMucmVxdWVzdGluZykgewogICAgLy8gSWYgd2UgaGF2ZSBhIHN0YWJsZSBzZXJ2ZXIgYWRkcmVzcywgc2VuZCBpdCBvdmVyIG5vdwogICAgY29uc3QgYWRkciA9IGMuZGh0LnJlbW90ZUFkZHJlc3MoKQogICAgY29uc3QgbG9jYWxBZGRycyA9IGMubGFuID8gSG9sZXB1bmNoZXIubG9jYWxBZGRyZXNzZXMoYy5kaHQuaW8uc2VydmVyU29ja2V0KSA6IG51bGwKICAgIGNvbnN0IGFkZHJlc3NlczQgPSBbXQoKICAgIGlmIChhZGRyKSBhZGRyZXNzZXM0LnB1c2goYWRkcikKICAgIGlmIChsb2NhbEFkZHJzKSBhZGRyZXNzZXM0LnB1c2goLi4ubG9jYWxBZGRycykKCiAgICBjLmZpcmV3YWxsID0gYWRkciA/IEZJUkVXQUxMLk9QRU4gOiBGSVJFV0FMTC5VTktOT1dOCiAgICBjLnJlcXVlc3RpbmcgPSB0cnVlCiAgICBjLnJlcXVlc3QgPSBhd2FpdCBjLmhhbmRzaGFrZS5zZW5kKHsKICAgICAgZXJyb3I6IEVSUk9SLk5PTkUsCiAgICAgIGZpcmV3YWxsOiBjLmZpcmV3YWxsLAogICAgICBob2xlcHVuY2g6IG51bGwsCiAgICAgIGFkZHJlc3NlczQsCiAgICAgIGFkZHJlc3NlczY6IFtdLAogICAgICB1ZHg6IHsKICAgICAgICByZXVzYWJsZVNvY2tldDogYy5yZXVzYWJsZVNvY2tldCwKICAgICAgICBpZDogYy5yYXdTdHJlYW0uaWQsCiAgICAgICAgc2VxOiAwCiAgICAgIH0sCiAgICAgIHNlY3JldFN0cmVhbToge30sCiAgICAgIHJlbGF5VGhyb3VnaDogYy5yZWxheVRocm91Z2ggPyB7IHB1YmxpY0tleTogYy5yZWxheVRocm91Z2gsIHRva2VuOiBjLnJlbGF5VG9rZW4gfSA6IG51bGwKICAgIH0pCiAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4KICB9CgogIGNvbnN0IHsgc2VydmVyQWRkcmVzcywgY2xpZW50QWRkcmVzcywgcmVsYXllZCwgbm9pc2UgfSA9IGF3YWl0IGMuZGh0Ll9yb3V0ZXIucGVlckhhbmRzaGFrZSgKICAgIGMudGFyZ2V0LAogICAgeyBub2lzZTogYy5yZXF1ZXN0LCBzb2NrZXQsIHNlc3Npb246IGMuc2Vzc2lvbiB9LAogICAgYWRkcmVzcwogICkKICBpZiAoaXNEb25lKGMpIHx8IGMuY29ubmVjdCkgcmV0dXJuCgogIGNvbnN0IHBheWxvYWQgPSBhd2FpdCBjLmhhbmRzaGFrZS5yZWN2KG5vaXNlKQogIGlmIChpc0RvbmUoYykgfHwgIXBheWxvYWQpIHJldHVybgoKICBpZiAocGF5bG9hZC52ZXJzaW9uICE9PSAxKSB7CiAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgU0VSVkVSX0lOQ09NUEFUSUJMRSgpKQogICAgcmV0dXJuCiAgfQogIGlmIChwYXlsb2FkLmVycm9yICE9PSBFUlJPUi5OT05FKSB7CiAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgU0VSVkVSX0VSUk9SKCkpCiAgICByZXR1cm4KICB9CiAgaWYgKCFwYXlsb2FkLnVkeCkgewogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIFNFUlZFUl9FUlJPUignU2VydmVyIGRpZCBub3Qgc2VuZCBVRFggZGF0YScpKQogICAgcmV0dXJuCiAgfQoKICBjb25zdCBocyA9IGMuaGFuZHNoYWtlLmZpbmFsKCkKCiAgYy5oYW5kc2hha2UgPSBudWxsCiAgYy5yZXF1ZXN0ID0gbnVsbAogIGMucmVxdWVzdGluZyA9IGZhbHNlCiAgYy5jb25uZWN0ID0gewogICAgcmVsYXllZCwKICAgIHJlbGF5QWRkcmVzczogYWRkcmVzcywKICAgIGNsaWVudEFkZHJlc3MsCiAgICBzZXJ2ZXJBZGRyZXNzLAogICAgcGF5bG9hZAogIH0KCiAgYy5wYXlsb2FkID0gbmV3IFNlY3VyZVBheWxvYWQoaHMuaG9sZXB1bmNoU2VjcmV0KQoKICBjLm9uc29ja2V0ID0gZnVuY3Rpb24gKHNvY2tldCwgcG9ydCwgaG9zdCkgewogICAgaWYgKGMucmF3U3RyZWFtID09PSBudWxsKSByZXR1cm4gLy8gQWxyZWFkeSBob2xlIHB1bmNoZWQKCiAgICBpZiAoYy5yYXdTdHJlYW0uY29ubmVjdGVkKSB7CiAgICAgIGNvbnN0IHJlbW90ZUNoYW5naW5nID0gYy5yYXdTdHJlYW0uY2hhbmdlUmVtb3RlKHNvY2tldCwgYy5jb25uZWN0LnBheWxvYWQudWR4LmlkLCBwb3J0LCBob3N0KQoKICAgICAgaWYgKHJlbW90ZUNoYW5naW5nKSByZW1vdGVDaGFuZ2luZy5jYXRjaChzYWZldHlDYXRjaCkKICAgIH0gZWxzZSB7CiAgICAgIC8vIGNhY2hlIHRoZSByZWxheSBhZGRycyBmb3IgYSBmdXR1cmUgcmVjb25uZWN0LCB3ZSBwcmVmZXIgdGhlIHJlbW90ZSBvbmUgc28gdGhleQogICAgICAvLyBjYW4gZ2l2ZSB1cyB0aGUgY29ycmVjdCBvbmVzIGZyb20gdGhlaXIgcG92CiAgICAgIGlmIChwYXlsb2FkLnJlbGF5QWRkcmVzc2VzICYmIHBheWxvYWQucmVsYXlBZGRyZXNzZXMubGVuZ3RoKSB7CiAgICAgICAgYy5kaHQuX3JlbGF5QWRkcmVzc2VzQ2FjaGUuc2V0KGMuaWQsIHBheWxvYWQucmVsYXlBZGRyZXNzZXMpCiAgICAgIH0gZWxzZSBpZiAoYy5yZW1vdGVSZWxheUFkZHJlc3Nlcy5sZW5ndGgpIHsKICAgICAgICBjLmRodC5fcmVsYXlBZGRyZXNzZXNDYWNoZS5zZXQoYy5pZCwgYy5yZW1vdGVSZWxheUFkZHJlc3NlcykKICAgICAgfQoKICAgICAgYy5yYXdTdHJlYW0uY29ubmVjdChzb2NrZXQsIGMuY29ubmVjdC5wYXlsb2FkLnVkeC5pZCwgcG9ydCwgaG9zdCkKICAgICAgYy5lbmNyeXB0ZWRTb2NrZXQuc3RhcnQoYy5yYXdTdHJlYW0sIHsgaGFuZHNoYWtlOiBocyB9KQogICAgfQoKICAgIGlmIChjLnJldXNhYmxlU29ja2V0ICYmIHBheWxvYWQudWR4LnJldXNhYmxlU29ja2V0KSB7CiAgICAgIGMuZGh0Ll9zb2NrZXRQb29sLnJvdXRlcy5hZGQoYy5yZW1vdGVQdWJsaWNLZXksIGMucmF3U3RyZWFtKQogICAgfQoKICAgIGlmIChjLnB1bmNoZXIpIHsKICAgICAgYy5wdW5jaGVyLm9uYWJvcnQgPSBub29wCiAgICAgIGMucHVuY2hlci5kZXN0cm95KCkKICAgIH0KCiAgICBpZiAoYy5wYXNzaXZlQ29ubmVjdFRpbWVvdXQpIHsKICAgICAgY2xlYXJQYXNzaXZlQ29ubmVjdFRpbWVvdXQoYykKICAgIH0KCiAgICBjLnJhd1N0cmVhbSA9IG51bGwKICB9CgogIGlmIChwYXlsb2FkLnJlbGF5VGhyb3VnaCB8fCBjLnJlbGF5VGhyb3VnaCkgewogICAgcmVsYXlDb25uZWN0aW9uKGMsIGMucmVsYXlUaHJvdWdoLCBwYXlsb2FkLCBocykKICB9CgogIGlmIChjLnNlcnZlclNvY2tldCkgewogICAgYy5vbnNvY2tldChjLnNlcnZlclNvY2tldCwgYy5zZXJ2ZXJBZGRyZXNzLnBvcnQsIGMuc2VydmVyQWRkcmVzcy5ob3N0KQogICAgcmV0dXJuCiAgfQoKICBpZiAoIXJlbGF5ZWQpIHsKICAgIGMub25zb2NrZXQoc29ja2V0IHx8IGMuZGh0LnNvY2tldCwgYWRkcmVzcy5wb3J0LCBhZGRyZXNzLmhvc3QpCiAgfQoKICBjLnNlc3Npb24uZGVzdHJveSgpCn0KCmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUhvbGVwdW5jaChjLCBwZWVyQWRkcmVzcywgcmVsYXlBZGRyLCBwYXlsb2FkKSB7CiAgY29uc3QgaG9sZXB1bmNoID0gYXdhaXQgYy5kaHQuX3JvdXRlci5wZWVySG9sZXB1bmNoKAogICAgYy50YXJnZXQsCiAgICB7CiAgICAgIGlkOiBjLmNvbm5lY3QucGF5bG9hZC5ob2xlcHVuY2guaWQsCiAgICAgIHBheWxvYWQ6IGMucGF5bG9hZC5lbmNyeXB0KHBheWxvYWQpLAogICAgICBwZWVyQWRkcmVzcywKICAgICAgc29ja2V0OiBjLnB1bmNoZXIuc29ja2V0LAogICAgICBzZXNzaW9uOiBjLnNlc3Npb24KICAgIH0sCiAgICByZWxheUFkZHIKICApCgogIGlmIChpc0RvbmUoYykpIHJldHVybiBudWxsCgogIGNvbnN0IHJlbW90ZVBheWxvYWQgPSBjLnBheWxvYWQuZGVjcnlwdChob2xlcHVuY2gucGF5bG9hZCkKICBpZiAoIXJlbW90ZVBheWxvYWQpIHsKICAgIHRocm93IEhPTEVQVU5DSF9JTlZBTElEKCkKICB9CgogIGNvbnN0IHsgZXJyb3IsIGZpcmV3YWxsLCBwdW5jaGluZywgYWRkcmVzc2VzLCByZW1vdGVUb2tlbiB9ID0gcmVtb3RlUGF5bG9hZAoKICBpZiAoZXJyb3IgPT09IEVSUk9SLlRSWV9MQVRFUiAmJiBjLnJlbGF5VG9rZW4gJiYgcGF5bG9hZC5wdW5jaGluZykgewogICAgcmV0dXJuIHsKICAgICAgdHJ5TGF0ZXI6IHRydWUsCiAgICAgIC4uLmhvbGVwdW5jaCwKICAgICAgcGF5bG9hZDogcmVtb3RlUGF5bG9hZAogICAgfQogIH0KCiAgaWYgKGVycm9yICE9PSBFUlJPUi5OT05FKSB7CiAgICB0aHJvdyBSRU1PVEVfQUJPUlRFRCgnUmVtb3RlIGFib3J0ZWQgd2l0aCBlcnJvciBjb2RlICcgKyBlcnJvcikKICB9CgogIGNvbnN0IGVjaG9lZCA9ICEhKHJlbW90ZVRva2VuICYmIHBheWxvYWQudG9rZW4gJiYgYjRhLmVxdWFscyhyZW1vdGVUb2tlbiwgcGF5bG9hZC50b2tlbikpCgogIGMucHVuY2hlci51cGRhdGVSZW1vdGUoewogICAgcHVuY2hpbmcsCiAgICBmaXJld2FsbCwKICAgIGFkZHJlc3NlcywKICAgIHZlcmlmaWVkOiBlY2hvZWQgPyBwZWVyQWRkcmVzcy5ob3N0IDogbnVsbAogIH0pCgogIHJldHVybiB7CiAgICB0cnlMYXRlcjogZmFsc2UsCiAgICAuLi5ob2xlcHVuY2gsCiAgICBwYXlsb2FkOiByZW1vdGVQYXlsb2FkCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBwcm9iZVJvdW5kKGMsIHNlcnZlckFkZHJlc3MsIHNlcnZlclJlbGF5LCByZXRyeSkgewogIC8vIE9wZW4gYSBxdWljayBsb3cgdHRsIHNlc3Npb24gYWdhaW5zdCB3aGF0IHdlIHRoaW5rIGlzIHRoZSBzZXJ2ZXIKICBpZiAoc2VydmVyQWRkcmVzcykgYXdhaXQgYy5wdW5jaGVyLm9wZW5TZXNzaW9uKHNlcnZlckFkZHJlc3MpCgogIGlmIChpc0RvbmUoYykpIHJldHVybiBudWxsCgogIGNvbnN0IHJlcGx5ID0gYXdhaXQgdXBkYXRlSG9sZXB1bmNoKGMsIHNlcnZlclJlbGF5LnBlZXJBZGRyZXNzLCBzZXJ2ZXJSZWxheS5yZWxheUFkZHJlc3MsIHsKICAgIGVycm9yOiBFUlJPUi5OT05FLAogICAgZmlyZXdhbGw6IGMucHVuY2hlci5uYXQuZmlyZXdhbGwsCiAgICByb3VuZDogYy5yb3VuZCsrLAogICAgY29ubmVjdGVkOiBmYWxzZSwKICAgIHB1bmNoaW5nOiBmYWxzZSwKICAgIGFkZHJlc3NlczogYy5wdW5jaGVyLm5hdC5hZGRyZXNzZXMsCiAgICByZW1vdGVBZGRyZXNzOiBzZXJ2ZXJBZGRyZXNzLAogICAgdG9rZW46IG51bGwsCiAgICByZW1vdGVUb2tlbjogbnVsbAogIH0pCgogIGlmIChpc0RvbmUoYykgfHwgIXJlcGx5KSByZXR1cm4gbnVsbAoKICBjb25zdCB7IHBlZXJBZGRyZXNzIH0gPSByZXBseQogIGNvbnN0IHsgYWRkcmVzcywgdG9rZW4gfSA9IHJlcGx5LnBheWxvYWQKCiAgYy5wdW5jaGVyLm5hdC5hZGQocmVwbHkudG8sIHJlcGx5LmZyb20pCgogIC8vIE9wZW4gYW5vdGhlciBxdWljayBsb3cgdHRsIHNlc3Npb24gYWdhaW5zdCB3aGF0IHRoZSBzZXJ2ZXIgc2F5cyB0aGVpciBhZGRyZXNzIGlzLAogIC8vIGlmIHRoZXkgaGF2ZW4ndCBzYWlkIHRoZXkgYXJlIHJhbmRvbSB5ZXQKICBpZiAoCiAgICBjLnB1bmNoZXIucmVtb3RlRmlyZXdhbGwgPCBGSVJFV0FMTC5SQU5ET00gJiYKICAgIGFkZHJlc3MgJiYKICAgIGFkZHJlc3MuaG9zdCAmJgogICAgYWRkcmVzcy5wb3J0ICYmCiAgICBkaWZmQWRkcmVzcyhhZGRyZXNzLCBzZXJ2ZXJBZGRyZXNzKQogICkgewogICAgYXdhaXQgYy5wdW5jaGVyLm9wZW5TZXNzaW9uKGFkZHJlc3MpCiAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4gbnVsbAogIH0KCiAgLy8gSWYgdGhlIHJlbW90ZSB0b2xkIHVzIHRoZXkgZGlkbid0IGtub3cgdGhlaXIgbmF0IGZpcmV3YWxsIHlldCwgZ2l2ZSB0aGVtIGEgY2hhbmNlIHRvIGZpZ3VyZSBpdCBvdXQKICAvLyBUaGV5IG1pZ2h0IHNheSB0aGlzIHRvIHNlZSBpZiB0aGUgImZhc3QgbW9kZSIgcHVuY2ggY29tZXMgdGhyb3VnaCBmaXJzdC4KICBpZiAoYy5wdW5jaGVyLnJlbW90ZUZpcmV3YWxsID09PSBGSVJFV0FMTC5VTktOT1dOKSB7CiAgICBhd2FpdCBjLnNsZWVwZXIucGF1c2UoMTAwMCkKICAgIGlmIChpc0RvbmUoYykpIHJldHVybiBudWxsCiAgfQoKICBsZXQgc3RhYmxlID0gYXdhaXQgYy5wdW5jaGVyLmFuYWx5emUoZmFsc2UpCiAgaWYgKGlzRG9uZShjKSkgcmV0dXJuIG51bGwKCiAgLy8gSWYgdGhlIHNvY2tldCBzZWVtcyB1bnN0YWJsZSwgdHJ5IHRvIG1ha2UgaXQgc3RhYmxlIGJ5IHNldHRpbmcgdGhlICJhbGxvd1Jlb3BlbiIgZmxhZwogIC8vIE1vc3RseSByZWxldmFudCBmb3IgbW9iaWxlIG5ldHdvcmtzCiAgaWYgKCFzdGFibGUpIHsKICAgIHN0YWJsZSA9IGF3YWl0IGMucHVuY2hlci5hbmFseXplKHRydWUpCiAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4gbnVsbAogICAgaWYgKHN0YWJsZSkgcmV0dXJuIHByb2JlUm91bmQoYywgc2VydmVyQWRkcmVzcywgc2VydmVyUmVsYXksIGZhbHNlKQogIH0KCiAgaWYgKChjLnB1bmNoZXIucmVtb3RlRmlyZXdhbGwgPT09IEZJUkVXQUxMLlVOS05PV04gfHwgIXRva2VuKSAmJiByZXRyeSkgewogICAgcmV0dXJuIHByb2JlUm91bmQoYywgc2VydmVyQWRkcmVzcywgc2VydmVyUmVsYXksIGZhbHNlKQogIH0KCiAgaWYgKAogICAgYy5wdW5jaGVyLnJlbW90ZUZpcmV3YWxsID09PSBGSVJFV0FMTC5VTktOT1dOIHx8CiAgICBjLnB1bmNoZXIubmF0LmZpcmV3YWxsID09PSBGSVJFV0FMTC5VTktOT1dOCiAgKSB7CiAgICBhd2FpdCBhYm9ydChjLCBzZXJ2ZXJSZWxheSwgSE9MRVBVTkNIX1BST0JFX1RJTUVPVVQoKSkKICAgIHJldHVybiBudWxsCiAgfQoKICBpZiAoYy5wdW5jaGVyLnJlbW90ZUZpcmV3YWxsID49IEZJUkVXQUxMLlJBTkRPTSAmJiBjLnB1bmNoZXIubmF0LmZpcmV3YWxsID49IEZJUkVXQUxMLlJBTkRPTSkgewogICAgYXdhaXQgYWJvcnQoYywgc2VydmVyUmVsYXksIEhPTEVQVU5DSF9ET1VCTEVfUkFORE9NSVpFRF9OQVRTKCkpCiAgICByZXR1cm4gbnVsbAogIH0KCiAgcmV0dXJuIHsgdG9rZW4sIHBlZXJBZGRyZXNzIH0KfQoKYXN5bmMgZnVuY3Rpb24gcm91bmRQdW5jaChjLCBzZXJ2ZXJBZGRyZXNzLCByZW1vdGVUb2tlbiwgY2xpZW50UmVsYXksIHNlcnZlclJlbGF5LCBkZWxheWVkKSB7CiAgLy8gV2UgYXJlIGdvc3NpcGluZyBvdXIgZmluYWwgTkFUIHN0YXR1cyB0byB0aGUgb3RoZXIgcGVlciBub3cKICAvLyBzbyBtYWtlIHN1cmUgd2UgZG9uJ3QgdXBkYXRlIG91ciBsb2NhbCB2aWV3IGZvciBub3cgYXMgdGhhdCBjYW4gbWFrZSB0aGluZ3Mgd2VpcmQKICBjLnB1bmNoZXIubmF0LmZyZWV6ZSgpCgogIGNvbnN0IGlzUmFuZG9tID0KICAgIGMucHVuY2hlci5yZW1vdGVGaXJld2FsbCA+PSBGSVJFV0FMTC5SQU5ET00gfHwgYy5wdW5jaGVyLm5hdC5maXJld2FsbCA+PSBGSVJFV0FMTC5SQU5ET00KICBpZiAoaXNSYW5kb20pIHsKICAgIHdoaWxlICgKICAgICAgYy5kaHQuX3JhbmRvbVB1bmNoZXMgPj0gYy5kaHQuX3JhbmRvbVB1bmNoTGltaXQgfHwKICAgICAgRGF0ZS5ub3coKSAtIGMuZGh0Ll9sYXN0UmFuZG9tUHVuY2ggPCBjLmRodC5fcmFuZG9tUHVuY2hJbnRlcnZhbAogICAgKSB7CiAgICAgIC8vIGlmIG5vIHJlbGF5IGNhbiBoZWxwLCBiYWlsCiAgICAgIGlmICghYy5yZWxheVRva2VuKSB0aHJvdyBIT0xFUFVOQ0hfQUJPUlRFRCgpCgogICAgICBpZiAoIWRlbGF5ZWQpIHsKICAgICAgICBkZWxheWVkID0gdHJ1ZQogICAgICAgIGF3YWl0IHVwZGF0ZUhvbGVwdW5jaChjLCBzZXJ2ZXJBZGRyZXNzLCBjbGllbnRSZWxheSwgewogICAgICAgICAgZXJyb3I6IEVSUk9SLk5PTkUsCiAgICAgICAgICBmaXJld2FsbDogYy5wdW5jaGVyLm5hdC5maXJld2FsbCwKICAgICAgICAgIHJvdW5kOiBjLnJvdW5kKyssCiAgICAgICAgICBjb25uZWN0ZWQ6IGZhbHNlLAogICAgICAgICAgcHVuY2hpbmc6IGZhbHNlLAogICAgICAgICAgYWRkcmVzc2VzOiBjLnB1bmNoZXIubmF0LmFkZHJlc3NlcywKICAgICAgICAgIHJlbW90ZUFkZHJlc3M6IG51bGwsCiAgICAgICAgICB0b2tlbjogYy5wYXlsb2FkLnRva2VuKHNlcnZlckFkZHJlc3MpLAogICAgICAgICAgcmVtb3RlVG9rZW4KICAgICAgICB9KQogICAgICAgIGlmIChpc0RvbmUoYykpIHJldHVybgogICAgICB9CgogICAgICBhd2FpdCB0cnlMYXRlcihjKQogICAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4KICAgIH0KICB9CgogIC8vIGluY3JlbWVudCBub3csIHNvIHdlIGNhbiBjb21taXQgdG8gcHVuY2hpbmcKICBpZiAoaXNSYW5kb20pIGMuZGh0Ll9yYW5kb21QdW5jaGVzKysKCiAgbGV0IHJlcGx5CgogIHRyeSB7CiAgICAvLyBpZiBkZWxheWVkIHN3aXRjaCB0byB0aGUgc2VydmVycyBjaG9zZW4gcmVsYXkgLSB3ZSB2YWxpZGF0ZWQgYW55d2F5CiAgICByZXBseSA9IGF3YWl0IHVwZGF0ZUhvbGVwdW5jaCgKICAgICAgYywKICAgICAgZGVsYXllZCA/IHNlcnZlclJlbGF5LnBlZXJBZGRyZXNzIDogc2VydmVyQWRkcmVzcywKICAgICAgZGVsYXllZCA/IHNlcnZlclJlbGF5LnJlbGF5QWRkcmVzcyA6IGNsaWVudFJlbGF5LAogICAgICB7CiAgICAgICAgZXJyb3I6IEVSUk9SLk5PTkUsCiAgICAgICAgZmlyZXdhbGw6IGMucHVuY2hlci5uYXQuZmlyZXdhbGwsCiAgICAgICAgcm91bmQ6IGMucm91bmQrKywKICAgICAgICBjb25uZWN0ZWQ6IGZhbHNlLAogICAgICAgIHB1bmNoaW5nOiB0cnVlLAogICAgICAgIGFkZHJlc3NlczogYy5wdW5jaGVyLm5hdC5hZGRyZXNzZXMsCiAgICAgICAgcmVtb3RlQWRkcmVzczogbnVsbCwKICAgICAgICB0b2tlbjogZGVsYXllZCA/IG51bGwgOiBjLnBheWxvYWQudG9rZW4oc2VydmVyQWRkcmVzcyksCiAgICAgICAgcmVtb3RlVG9rZW4KICAgICAgfQogICAgKQogIH0gZmluYWxseSB7CiAgICAvLyBkZWNyZW1lbnQgYXMgcHVuY2ggaW5jcmVtZW50cyBmb3IgdXMKICAgIGlmIChpc1JhbmRvbSkgYy5kaHQuX3JhbmRvbVB1bmNoZXMtLQogIH0KCiAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCiAgaWYgKCFyZXBseSkgcmV0dXJuCgogIGlmIChyZXBseS50cnlMYXRlcikgewogICAgYXdhaXQgdHJ5TGF0ZXIoYykKICAgIGlmIChpc0RvbmUoYykpIHJldHVybgogICAgcmV0dXJuIHJvdW5kUHVuY2goYywgc2VydmVyQWRkcmVzcywgcmVtb3RlVG9rZW4sIGNsaWVudFJlbGF5LCBzZXJ2ZXJSZWxheSwgdHJ1ZSkKICB9CgogIGlmICghYy5wdW5jaGVyLnJlbW90ZUhvbGVwdW5jaGluZykgewogICAgdGhyb3cgUkVNT1RFX05PVF9IT0xFUFVOQ0hJTkcoKQogIH0KCiAgaWYgKCEoYXdhaXQgYy5wdW5jaGVyLnB1bmNoKCkpKSB7CiAgICB0aHJvdyBSRU1PVEVfTk9UX0hPTEVQVU5DSEFCTEUoKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gdHJ5TGF0ZXIoYykgewogIGlmICghYy5yZWxheVRva2VuKSB0aHJvdyBIT0xFUFVOQ0hfQUJPUlRFRCgpCiAgYXdhaXQgYy5zbGVlcGVyLnBhdXNlKDEwMDAwICsgTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogMTAwMDApKQp9CgpmdW5jdGlvbiBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgZXJyKSB7CiAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCiAgaWYgKGMuZW5jcnlwdGVkU29ja2V0LnJhd1N0cmVhbSkgcmV0dXJuCiAgaWYgKGMucmVsYXlTb2NrZXQpIHJldHVybiAvLyB3YWl0aW5nIGZvciB0aGUgcmVsYXkKICBpZiAoYy5wdW5jaGVyICYmICFjLnB1bmNoZXIuZGVzdHJveWVkKSByZXR1cm4gLy8gd2FpdGluZyBmb3IgdGhlIHB1bmNoZXIKICBjLnNlc3Npb24uZGVzdHJveSgpCiAgYy5lbmNyeXB0ZWRTb2NrZXQuZGVzdHJveShlcnIpCn0KCmFzeW5jIGZ1bmN0aW9uIGFib3J0KGMsIHsgcGVlckFkZHJlc3MsIHJlbGF5QWRkcmVzcyB9LCBlcnIpIHsKICB0cnkgewogICAgYXdhaXQgdXBkYXRlSG9sZXB1bmNoKHBlZXJBZGRyZXNzLCByZWxheUFkZHJlc3MsIHsKICAgICAgZXJyb3I6IEVSUk9SLkFCT1JURUQsCiAgICAgIGZpcmV3YWxsOiBGSVJFV0FMTC5VTktOT1dOLAogICAgICByb3VuZDogYy5yb3VuZCsrLAogICAgICBjb25uZWN0ZWQ6IGZhbHNlLAogICAgICBwdW5jaGluZzogZmFsc2UsCiAgICAgIGFkZHJlc3NlczogbnVsbCwKICAgICAgcmVtb3RlQWRkcmVzczogbnVsbCwKICAgICAgdG9rZW46IG51bGwsCiAgICAgIHJlbW90ZVRva2VuOiBudWxsCiAgICB9KQogIH0gY2F0Y2gge30KCiAgZGVzdHJveVB1bmNoZXIoYykKICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgZXJyKQp9CgpmdW5jdGlvbiByZWxheUNvbm5lY3Rpb24oYywgcmVsYXlUaHJvdWdoLCBwYXlsb2FkLCBocykgewogIGxldCBpc0luaXRpYXRvcgogIGxldCBwdWJsaWNLZXkKICBsZXQgdG9rZW4KCiAgaWYgKHBheWxvYWQucmVsYXlUaHJvdWdoKSB7CiAgICBpc0luaXRpYXRvciA9IGZhbHNlCiAgICBwdWJsaWNLZXkgPSBwYXlsb2FkLnJlbGF5VGhyb3VnaC5wdWJsaWNLZXkKICAgIHRva2VuID0gcGF5bG9hZC5yZWxheVRocm91Z2gudG9rZW4KICB9IGVsc2UgewogICAgaXNJbml0aWF0b3IgPSB0cnVlCiAgICBwdWJsaWNLZXkgPSByZWxheVRocm91Z2gKICAgIHRva2VuID0gYy5yZWxheVRva2VuCiAgfQoKICBjLnJlbGF5VG9rZW4gPSB0b2tlbgogIGMucmVsYXlTb2NrZXQgPSBjLmRodC5jb25uZWN0KHB1YmxpY0tleSkKICBjLnJlbGF5U29ja2V0LnNldEtlZXBBbGl2ZShjLnJlbGF5S2VlcEFsaXZlKQogIGMucmVsYXlDbGllbnQgPSByZWxheS5DbGllbnQuZnJvbShjLnJlbGF5U29ja2V0LCB7IGlkOiBjLnJlbGF5U29ja2V0LnB1YmxpY0tleSB9KQogIGMucmVsYXlUaW1lb3V0ID0gc2V0VGltZW91dChvbmFib3J0LCAxNTAwMCwgbnVsbCkKCiAgYy5yZWxheUNsaWVudC5wYWlyKGlzSW5pdGlhdG9yLCB0b2tlbiwgYy5yYXdTdHJlYW0pLm9uKCdlcnJvcicsIG9uYWJvcnQpLm9uKCdkYXRhJywgb25kYXRhKQoKICBmdW5jdGlvbiBvbmRhdGEocmVtb3RlSWQpIHsKICAgIGlmIChjLnJlbGF5VGltZW91dCkgY2xlYXJSZWxheVRpbWVvdXQoYykKICAgIGlmIChjLnJhd1N0cmVhbSA9PT0gbnVsbCkgewogICAgICBvbmFib3J0KG51bGwpCiAgICAgIHJldHVybgogICAgfQoKICAgIGMucmVsYXlQYWlyZWQgPSB0cnVlCgogICAgY29uc3QgeyByZW1vdGVQb3J0LCByZW1vdGVIb3N0LCBzb2NrZXQgfSA9IGMucmVsYXlTb2NrZXQucmF3U3RyZWFtCgogICAgYy5yYXdTdHJlYW0KICAgICAgLm9uKCdjbG9zZScsICgpID0+IGMucmVsYXlTb2NrZXQuZGVzdHJveSgpKQogICAgICAuY29ubmVjdChzb2NrZXQsIHJlbW90ZUlkLCByZW1vdGVQb3J0LCByZW1vdGVIb3N0KQoKICAgIGMuZW5jcnlwdGVkU29ja2V0LnN0YXJ0KGMucmF3U3RyZWFtLCB7IGhhbmRzaGFrZTogaHMgfSkKICB9CgogIGZ1bmN0aW9uIG9uYWJvcnQoZXJyKSB7CiAgICBpZiAoYy5yZWxheVRpbWVvdXQpIGNsZWFyUmVsYXlUaW1lb3V0KGMpCiAgICBjb25zdCBzb2NrZXQgPSBjLnJlbGF5U29ja2V0CiAgICBjLnJlbGF5VG9rZW4gPSBudWxsCiAgICBjLnJlbGF5U29ja2V0ID0gbnVsbAogICAgaWYgKHNvY2tldCkgc29ja2V0LmRlc3Ryb3koKQogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIGVyciB8fCBSRUxBWV9BQk9SVEVEKCkpCiAgfQp9CgpmdW5jdGlvbiBjbGVhclBhc3NpdmVDb25uZWN0VGltZW91dChjKSB7CiAgY2xlYXJUaW1lb3V0KGMucGFzc2l2ZUNvbm5lY3RUaW1lb3V0KQogIGMucGFzc2l2ZUNvbm5lY3RUaW1lb3V0ID0gbnVsbAp9CgpmdW5jdGlvbiBjbGVhclJlbGF5VGltZW91dChjKSB7CiAgY2xlYXJUaW1lb3V0KGMucmVsYXlUaW1lb3V0KQogIGMucmVsYXlUaW1lb3V0ID0gbnVsbAp9CgpmdW5jdGlvbiBkZXN0cm95UHVuY2hlcihjKSB7CiAgaWYgKGMucHVuY2hlcikgYy5wdW5jaGVyLmRlc3Ryb3koKQogIGMuc2Vzc2lvbi5kZXN0cm95KCkKfQoKZnVuY3Rpb24gcGlja1NlcnZlclJlbGF5KHJlbGF5cywgY2xpZW50UmVsYXkpIHsKICBmb3IgKGNvbnN0IHIgb2YgcmVsYXlzKSB7CiAgICBpZiAoIWRpZmZBZGRyZXNzKHIucmVsYXlBZGRyZXNzLCBjbGllbnRSZWxheSkpIHJldHVybiByCiAgfQogIHJldHVybiByZWxheXNbMF0KfQoKZnVuY3Rpb24gZGlmZkFkZHJlc3MoYSwgYikgewogIHJldHVybiBhLmhvc3QgIT09IGIuaG9zdCB8fCBhLnBvcnQgIT09IGIucG9ydAp9CgpmdW5jdGlvbiBkZWZhdWx0Q3JlYXRlSGFuZHNoYWtlKGtleVBhaXIsIHJlbW90ZVB1YmxpY0tleSkgewogIHJldHVybiBuZXcgTm9pc2VXcmFwKGtleVBhaXIsIHJlbW90ZVB1YmxpY0tleSkKfQoKZnVuY3Rpb24gZGVmYXVsdENyZWF0ZVNlY3JldFN0cmVhbShpc0luaXRpYXRvciwgcmF3U3RyZWFtLCBvcHRzKSB7CiAgcmV0dXJuIG5ldyBOb2lzZVNlY3JldFN0cmVhbShpc0luaXRpYXRvciwgcmF3U3RyZWFtLCBvcHRzKQp9CgpmdW5jdGlvbiBvbmx5UHJpdmF0ZUhvc3RzKGFkZHIpIHsKICByZXR1cm4gaXNQcml2YXRlKGFkZHIuaG9zdCkKfQoKZnVuY3Rpb24gaXNSZWxheShyZWxheVNvY2tldCwgc29ja2V0LCBwb3J0LCBob3N0KSB7CiAgY29uc3Qgc3RyZWFtID0gcmVsYXlTb2NrZXQucmF3U3RyZWFtCiAgaWYgKCFzdHJlYW0pIHJldHVybiBmYWxzZQogIGlmIChzdHJlYW0uc29ja2V0ICE9PSBzb2NrZXQpIHJldHVybiBmYWxzZQogIHJldHVybiBwb3J0ID09PSBzdHJlYW0ucmVtb3RlUG9ydCAmJiBob3N0ID09PSBzdHJlYW0ucmVtb3RlSG9zdAp9CgpmdW5jdGlvbiBzZWxlY3RSZWxheShyZWxheVRocm91Z2gpIHsKICBpZiAodHlwZW9mIHJlbGF5VGhyb3VnaCA9PT0gJ2Z1bmN0aW9uJykgcmVsYXlUaHJvdWdoID0gcmVsYXlUaHJvdWdoKCkKICBpZiAocmVsYXlUaHJvdWdoID09PSBudWxsKSByZXR1cm4gbnVsbAogIGlmIChBcnJheS5pc0FycmF5KHJlbGF5VGhyb3VnaCkpCiAgICByZXR1cm4gcmVsYXlUaHJvdWdoW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHJlbGF5VGhyb3VnaC5sZW5ndGgpXQogIHJldHVybiByZWxheVRocm91Z2gKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4vZXJyb3JzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ29ubmVjdGlvblBvb2wgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKGRodCkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuX2RodCA9IGRodAogICAgdGhpcy5fc2VydmVycyA9IG5ldyBNYXAoKQogICAgdGhpcy5fY29ubmVjdGluZyA9IG5ldyBNYXAoKQogICAgdGhpcy5fY29ubmVjdGlvbnMgPSBuZXcgTWFwKCkKICB9CgogIF9hdHRhY2hTZXJ2ZXIoc2VydmVyKSB7CiAgICBjb25zdCBrZXlTdHJpbmcgPSBiNGEudG9TdHJpbmcoc2VydmVyLnB1YmxpY0tleSwgJ2hleCcpCgogICAgdGhpcy5fc2VydmVycy5zZXQoa2V5U3RyaW5nLCBzZXJ2ZXIpCgogICAgc2VydmVyCiAgICAgIC5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgICAgdGhpcy5fc2VydmVycy5kZWxldGUoa2V5U3RyaW5nKQogICAgICB9KQogICAgICAub24oJ2Nvbm5lY3Rpb24nLCAoc29ja2V0KSA9PiB7CiAgICAgICAgdGhpcy5fYXR0YWNoU3RyZWFtKHNvY2tldCwgdHJ1ZSkKICAgICAgfSkKICB9CgogIF9hdHRhY2hTdHJlYW0oc3RyZWFtLCBvcGVuZWQpIHsKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5nZXQoc3RyZWFtLnJlbW90ZVB1YmxpY0tleSkKCiAgICBpZiAoZXhpc3RpbmcpIHsKICAgICAgY29uc3Qga2VlcE5ldyA9CiAgICAgICAgc3RyZWFtLmlzSW5pdGlhdG9yID09PSBleGlzdGluZy5pc0luaXRpYXRvciB8fAogICAgICAgIGI0YS5jb21wYXJlKHN0cmVhbS5wdWJsaWNLZXksIHN0cmVhbS5yZW1vdGVQdWJsaWNLZXkpID4gMAoKICAgICAgaWYgKGtlZXBOZXcpIHsKICAgICAgICBsZXQgY2xvc2VkID0gZmFsc2UKCiAgICAgICAgY29uc3Qgb25jbG9zZSA9ICgpID0+IHsKICAgICAgICAgIGNsb3NlZCA9IHRydWUKICAgICAgICB9CgogICAgICAgIGV4aXN0aW5nCiAgICAgICAgICAub24oJ2Vycm9yJywgbm9vcCkKICAgICAgICAgIC5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgICAgICAgIGlmIChjbG9zZWQpIHJldHVybgoKICAgICAgICAgICAgc3RyZWFtLm9mZignZXJyb3InLCBub29wKS5vZmYoJ2Nsb3NlJywgb25jbG9zZSkKCiAgICAgICAgICAgIHRoaXMuX2F0dGFjaFN0cmVhbShzdHJlYW0sIG9wZW5lZCkKICAgICAgICAgIH0pCiAgICAgICAgICAuZGVzdHJveShlcnJvcnMuRFVQTElDQVRFX0NPTk5FQ1RJT04oKSkKCiAgICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIG5vb3ApLm9uKCdjbG9zZScsIG9uY2xvc2UpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIG5vb3ApLmRlc3Ryb3koZXJyb3JzLkRVUExJQ0FURV9DT05ORUNUSU9OKCkpCiAgICAgIH0KCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IHNlc3Npb24gPSBuZXcgQ29ubmVjdGlvblJlZih0aGlzLCBzdHJlYW0pCgogICAgY29uc3Qga2V5U3RyaW5nID0gYjRhLnRvU3RyaW5nKHN0cmVhbS5yZW1vdGVQdWJsaWNLZXksICdoZXgnKQoKICAgIGlmIChvcGVuZWQpIHsKICAgICAgdGhpcy5fY29ubmVjdGlvbnMuc2V0KGtleVN0cmluZywgc2Vzc2lvbikKCiAgICAgIHN0cmVhbS5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgICAgdGhpcy5fY29ubmVjdGlvbnMuZGVsZXRlKGtleVN0cmluZykKICAgICAgfSkKCiAgICAgIHRoaXMuZW1pdCgnY29ubmVjdGlvbicsIHN0cmVhbSwgc2Vzc2lvbikKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2Nvbm5lY3Rpbmcuc2V0KGtleVN0cmluZywgc2Vzc2lvbikKCiAgICAgIHN0cmVhbQogICAgICAgIC5vbignZXJyb3InLCBub29wKQogICAgICAgIC5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgICAgICBpZiAob3BlbmVkKSB0aGlzLl9jb25uZWN0aW9ucy5kZWxldGUoa2V5U3RyaW5nKQogICAgICAgICAgZWxzZSB0aGlzLl9jb25uZWN0aW5nLmRlbGV0ZShrZXlTdHJpbmcpCiAgICAgICAgfSkKICAgICAgICAub24oJ29wZW4nLCAoKSA9PiB7CiAgICAgICAgICBvcGVuZWQgPSB0cnVlCgogICAgICAgICAgdGhpcy5fY29ubmVjdGluZy5kZWxldGUoa2V5U3RyaW5nKQogICAgICAgICAgdGhpcy5fY29ubmVjdGlvbnMuc2V0KGtleVN0cmluZywgc2Vzc2lvbikKCiAgICAgICAgICBzdHJlYW0ub2ZmKCdlcnJvcicsIG5vb3ApCgogICAgICAgICAgdGhpcy5lbWl0KCdjb25uZWN0aW9uJywgc3RyZWFtLCBzZXNzaW9uKQogICAgICAgIH0pCiAgICB9CgogICAgcmV0dXJuIHNlc3Npb24KICB9CgogIGdldCBjb25uZWN0aW5nKCkgewogICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpbmcuc2l6ZQogIH0KCiAgZ2V0IGNvbm5lY3Rpb25zKCkgewogICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb25zLnZhbHVlcygpCiAgfQoKICBoYXMocHVibGljS2V5KSB7CiAgICBjb25zdCBrZXlTdHJpbmcgPSBiNGEudG9TdHJpbmcocHVibGljS2V5LCAnaGV4JykKCiAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbnMuaGFzKGtleVN0cmluZykgfHwgdGhpcy5fY29ubmVjdGluZy5oYXMoa2V5U3RyaW5nKQogIH0KCiAgZ2V0KHB1YmxpY0tleSkgewogICAgY29uc3Qga2V5U3RyaW5nID0gYjRhLnRvU3RyaW5nKHB1YmxpY0tleSwgJ2hleCcpCgogICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLl9jb25uZWN0aW9ucy5nZXQoa2V5U3RyaW5nKSB8fCB0aGlzLl9jb25uZWN0aW5nLmdldChrZXlTdHJpbmcpCgogICAgcmV0dXJuIGV4aXN0aW5nPy5fc3RyZWFtIHx8IG51bGwKICB9Cn0KCmNsYXNzIENvbm5lY3Rpb25SZWYgewogIGNvbnN0cnVjdG9yKHBvb2wsIHN0cmVhbSkgewogICAgdGhpcy5fcG9vbCA9IHBvb2wKICAgIHRoaXMuX3N0cmVhbSA9IHN0cmVhbQogICAgdGhpcy5fcmVmcyA9IDAKICB9CgogIGFjdGl2ZSgpIHsKICAgIHRoaXMuX3JlZnMrKwogIH0KCiAgaW5hY3RpdmUoKSB7CiAgICB0aGlzLl9yZWZzLS0KICB9CgogIHJlbGVhc2UoKSB7CiAgICB0aGlzLl9zdHJlYW0uZGVzdHJveSgpCiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCgpjb25zdCBDT01NQU5EUyA9IChleHBvcnRzLkNPTU1BTkRTID0gewogIFBFRVJfSEFORFNIQUtFOiAwLAogIFBFRVJfSE9MRVBVTkNIOiAxLAogIEZJTkRfUEVFUjogMiwKICBMT09LVVA6IDMsCiAgQU5OT1VOQ0U6IDQsCiAgVU5BTk5PVU5DRTogNSwKICBNVVRBQkxFX1BVVDogNiwKICBNVVRBQkxFX0dFVDogNywKICBJTU1VVEFCTEVfUFVUOiA4LAogIElNTVVUQUJMRV9HRVQ6IDkKfSkKCmV4cG9ydHMuQk9PVFNUUkFQX05PREVTID0gZ2xvYmFsLlBlYXI/LmNvbmZpZy5kaHQ/LmJvb3RzdHJhcCB8fCBbCiAgJzg4Ljk5LjMuODZAbm9kZTEuaHlwZXJkaHQub3JnOjQ5NzM3JywKICAnMTQyLjkzLjkwLjExM0Bub2RlMi5oeXBlcmRodC5vcmc6NDk3MzcnLAogICcxMzguNjguMTQ3LjhAbm9kZTMuaHlwZXJkaHQub3JnOjQ5NzM3JwpdCgpleHBvcnRzLktOT1dOX05PREVTID0gZ2xvYmFsLlBlYXI/LmNvbmZpZy5kaHQ/Lm5vZGVzIHx8IFtdCgpleHBvcnRzLkZJUkVXQUxMID0gewogIFVOS05PV046IDAsCiAgT1BFTjogMSwKICBDT05TSVNURU5UOiAyLAogIFJBTkRPTTogMwp9CgpleHBvcnRzLkVSUk9SID0gewogIC8vIG5vaXNlIC8gY29ubmVjdGlvbiByZWxhdGVkCiAgTk9ORTogMCwKICBBQk9SVEVEOiAxLAogIFZFUlNJT05fTUlTTUFUQ0g6IDIsCiAgVFJZX0xBVEVSOiAzLAogIC8vIGRodCByZWxhdGVkCiAgU0VRX1JFVVNFRDogMTYsCiAgU0VRX1RPT19MT1c6IDE3Cn0KCmNvbnN0IFtOU19BTk5PVU5DRSwgTlNfVU5BTk5PVU5DRSwgTlNfTVVUQUJMRV9QVVQsIE5TX1BFRVJfSEFORFNIQUtFLCBOU19QRUVSX0hPTEVQVU5DSF0gPQogIGNyeXB0by5uYW1lc3BhY2UoJ2h5cGVyc3dhcm0vZGh0JywgWwogICAgQ09NTUFORFMuQU5OT1VOQ0UsCiAgICBDT01NQU5EUy5VTkFOTk9VTkNFLAogICAgQ09NTUFORFMuTVVUQUJMRV9QVVQsCiAgICBDT01NQU5EUy5QRUVSX0hBTkRTSEFLRSwKICAgIENPTU1BTkRTLlBFRVJfSE9MRVBVTkNICiAgXSkKCmV4cG9ydHMuTlMgPSB7CiAgQU5OT1VOQ0U6IE5TX0FOTk9VTkNFLAogIFVOQU5OT1VOQ0U6IE5TX1VOQU5OT1VOQ0UsCiAgTVVUQUJMRV9QVVQ6IE5TX01VVEFCTEVfUFVULAogIFBFRVJfSEFORFNIQUtFOiBOU19QRUVSX0hBTkRTSEFLRSwKICBQRUVSX0hPTEVQVU5DSDogTlNfUEVFUl9IT0xFUFVOQ0gKfQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmZ1bmN0aW9uIGhhc2goZGF0YSkgewogIGNvbnN0IG91dCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKG91dCwgZGF0YSkKICByZXR1cm4gb3V0Cn0KCmZ1bmN0aW9uIHVuc2xhYmJlZEhhc2goZGF0YSkgewogIGNvbnN0IG91dCA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coMzIpCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChvdXQsIGRhdGEpCiAgcmV0dXJuIG91dAp9CgpmdW5jdGlvbiBjcmVhdGVLZXlQYWlyKHNlZWQpIHsKICBjb25zdCBwdWJsaWNLZXkgPSBiNGEuYWxsb2MoMzIpCiAgY29uc3Qgc2VjcmV0S2V5ID0gYjRhLmFsbG9jKDY0KQogIGlmIChzZWVkKSBzb2RpdW0uY3J5cHRvX3NpZ25fc2VlZF9rZXlwYWlyKHB1YmxpY0tleSwgc2VjcmV0S2V5LCBzZWVkKQogIGVsc2Ugc29kaXVtLmNyeXB0b19zaWduX2tleXBhaXIocHVibGljS2V5LCBzZWNyZXRLZXkpCiAgcmV0dXJuIHsgcHVibGljS2V5LCBzZWNyZXRLZXkgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBoYXNoLAogIHVuc2xhYmJlZEhhc2gsCiAgY3JlYXRlS2V5UGFpcgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGNlbmMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKCmZ1bmN0aW9uIGVuY29kZVVuc2xhYihlbmMsIG0pIHsKICAvLyBGYXN0ZXIgdGhhbiB1bnNsYWIoYy5lbmNvZGUoZW5jLCBkYXRhKSkgYmVjYXVzZSBpdCBhdm9pZHMgdGhlIG1lbSBjb3B5LgogIC8vIE1ha2VzIHNlbnNlIHRvIHB1dCBpbiBjb21wYWN0LWVuY29kaW5nIHdoZW4gd2UgbmVlZCBpdCBpbiBvdGhlciBtb2R1bGVzIHRvbwogIGNvbnN0IHN0YXRlID0gY2VuYy5zdGF0ZSgpCiAgZW5jLnByZWVuY29kZShzdGF0ZSwgbSkKICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmVTbG93KHN0YXRlLmVuZCkKICBlbmMuZW5jb2RlKHN0YXRlLCBtKQogIHJldHVybiBzdGF0ZS5idWZmZXIKfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgZW5jb2RlVW5zbGFiCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBESFRFcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3Rvcihtc2csIGNvZGUsIGZuID0gREhURXJyb3IpIHsKICAgIHN1cGVyKGAke2NvZGV9OiAke21zZ31gKQogICAgdGhpcy5jb2RlID0gY29kZQoKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBmbikKICAgIH0KICB9CgogIGdldCBuYW1lKCkgewogICAgcmV0dXJuICdESFRFcnJvcicKICB9CgogIHN0YXRpYyBCQURfSEFORFNIQUtFX1JFUExZKG1zZyA9ICdCYWQgaGFuZHNoYWtlIHJlcGx5JykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdCQURfSEFORFNIQUtFX1JFUExZJywgREhURXJyb3IuQkFEX0hBTkRTSEFLRV9SRVBMWSkKICB9CgogIHN0YXRpYyBCQURfSE9MRVBVTkNIX1JFUExZKG1zZyA9ICdCYWQgaG9sZXB1bmNoIHJlcGx5JykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdCQURfSE9MRVBVTkNIX1JFUExZJywgREhURXJyb3IuQkFEX0hPTEVQVU5DSF9SRVBMWSkKICB9CgogIHN0YXRpYyBIT0xFUFVOQ0hfQUJPUlRFRChtc2cgPSAnSG9sZXB1bmNoIGFib3J0ZWQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0hPTEVQVU5DSF9BQk9SVEVEJywgREhURXJyb3IuSE9MRVBVTkNIX0FCT1JURUQpCiAgfQoKICBzdGF0aWMgSE9MRVBVTkNIX0lOVkFMSUQobXNnID0gJ0ludmFsaWQgaG9sZXB1bmNoIHBheWxvYWQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0hPTEVQVU5DSF9JTlZBTElEJywgREhURXJyb3IuSE9MRVBVTkNIX0lOVkFMSUQpCiAgfQoKICBzdGF0aWMgSE9MRVBVTkNIX1BST0JFX1RJTUVPVVQobXNnID0gJ0hvbGVwdW5jaGluZyBwcm9iZSBkaWQgbm90IGZpbmlzaCBpbiB0aW1lJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdIT0xFUFVOQ0hfUFJPQkVfVElNRU9VVCcsIERIVEVycm9yLkhPTEVQVU5DSF9QUk9CRV9USU1FT1VUKQogIH0KCiAgc3RhdGljIEhPTEVQVU5DSF9ET1VCTEVfUkFORE9NSVpFRF9OQVRTKG1zZyA9ICdCb3RoIHJlbW90ZSBhbmQgbG9jYWwgTkFUcyBhcmUgcmFuZG9taXplZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IoCiAgICAgIG1zZywKICAgICAgJ0hPTEVQVU5DSF9ET1VCTEVfUkFORE9NSVpFRF9OQVRTJywKICAgICAgREhURXJyb3IuSE9MRVBVTkNIX0RPVUJMRV9SQU5ET01JWkVEX05BVFMKICAgICkKICB9CgogIHN0YXRpYyBDQU5OT1RfSE9MRVBVTkNIKG1zZyA9ICdDYW5ub3QgaG9sZXB1bmNoIHRvIHJlbW90ZScpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnQ0FOTk9UX0hPTEVQVU5DSCcsIERIVEVycm9yLkNBTk5PVF9IT0xFUFVOQ0gpCiAgfQoKICBzdGF0aWMgUkVNT1RFX05PVF9IT0xFUFVOQ0hJTkcobXNnID0gJ1JlbW90ZSBpcyBub3QgaG9sZXB1bmNoaW5nJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdSRU1PVEVfTk9UX0hPTEVQVU5DSElORycsIERIVEVycm9yLlJFTU9URV9OT1RfSE9MRVBVTkNISU5HKQogIH0KCiAgc3RhdGljIFJFTU9URV9OT1RfSE9MRVBVTkNIQUJMRShtc2cgPSAnUmVtb3RlIGlzIG5vdCBob2xlcHVuY2hhYmxlJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdSRU1PVEVfTk9UX0hPTEVQVU5DSEFCTEUnLCBESFRFcnJvci5SRU1PVEVfTk9UX0hPTEVQVU5DSEFCTEUpCiAgfQoKICBzdGF0aWMgUkVNT1RFX0FCT1JURUQobXNnID0gJ1JlbW90ZSBhYm9ydGVkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdSRU1PVEVfQUJPUlRFRCcsIERIVEVycm9yLlJFTU9URV9BQk9SVEVEKQogIH0KCiAgc3RhdGljIEhBTkRTSEFLRV9VTkZJTklTSEVEKG1zZyA9ICdIYW5kc2hha2UgZGlkIG5vdCBmaW5pc2gnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0hBTkRTSEFLRV9VTkZJTklTSEVEJywgREhURXJyb3IuSEFORFNIQUtFX1VORklOSVNIRUQpCiAgfQoKICBzdGF0aWMgSEFORFNIQUtFX0lOVkFMSUQobXNnID0gJ1JlY2VpdmVkIGludmFsaWQgaGFuZHNoYWtlJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdIQU5EU0hBS0VfSU5WQUxJRCcsIERIVEVycm9yLkhBTkRTSEFLRV9JTlZBTElEKQogIH0KCiAgc3RhdGljIEFMUkVBRFlfTElTVEVOSU5HKG1zZyA9ICdBbHJlYWR5IGxpc3RlbmluZycpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnQUxSRUFEWV9MSVNURU5JTkcnLCBESFRFcnJvci5BTFJFQURZX0xJU1RFTklORykKICB9CgogIHN0YXRpYyBLRVlQQUlSX0FMUkVBRFlfVVNFRChtc2cgPSAnS2V5cGFpciBhbHJlYWR5IHVzZWQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0tFWVBBSVJfQUxSRUFEWV9VU0VEJywgREhURXJyb3IuS0VZUEFJUl9BTFJFQURZX1VTRUQpCiAgfQoKICBzdGF0aWMgTk9ERV9ERVNUUk9ZRUQobXNnID0gJ05vZGUgZGVzdHJveWVkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdOT0RFX0RFU1RST1lFRCcsIERIVEVycm9yLk5PREVfREVTVFJPWUVEKQogIH0KCiAgc3RhdGljIFBFRVJfQ09OTkVDVElPTl9GQUlMRUQobXNnID0gJ0NvdWxkIG5vdCBjb25uZWN0IHRvIHBlZXInKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ1BFRVJfQ09OTkVDVElPTl9GQUlMRUQnLCBESFRFcnJvci5QRUVSX0NPTk5FQ1RJT05fRkFJTEVEKQogIH0KCiAgc3RhdGljIFBFRVJfTk9UX0ZPVU5EKG1zZyA9ICdQZWVyIG5vdCBmb3VuZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnUEVFUl9OT1RfRk9VTkQnLCBESFRFcnJvci5QRUVSX05PVF9GT1VORCkKICB9CgogIHN0YXRpYyBTVFJFQU1fTk9UX0NPTk5FQ1RFRChtc2cgPSAnU3RyZWFtIGlzIG5vdCBjb25uZWN0ZWQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ1NUUkVBTV9OT1RfQ09OTkVDVEVEJywgREhURXJyb3IuU1RSRUFNX0RJU0NPTk5FQ1RFRCkKICB9CgogIHN0YXRpYyBTRVJWRVJfSU5DT01QQVRJQkxFKG1zZyA9ICdTZXJ2ZXIgaXMgdXNpbmcgYW4gaW5jb21wYXRpYmxlIHZlcnNpb24nKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ1NFUlZFUl9JTkNPTVBBVElCTEUnLCBESFRFcnJvci5TRVJWRVJfSU5DT01QQVRJQkxFKQogIH0KCiAgc3RhdGljIFNFUlZFUl9FUlJPUihtc2cgPSAnU2VydmVyIHJldHVybmVkIGFuIGVycm9yJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdTRVJWRVJfRVJST1InLCBESFRFcnJvci5TRVJWRVJfRVJST1IpCiAgfQoKICBzdGF0aWMgRFVQTElDQVRFX0NPTk5FQ1RJT04obXNnID0gJ0R1cGxpY2F0ZSBjb25uZWN0aW9uJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdEVVBMSUNBVEVfQ09OTkVDVElPTicsIERIVEVycm9yLkRVUExJQ0FURV9DT05ORUNUSU9OKQogIH0KCiAgc3RhdGljIFJFTEFZX0FCT1JURUQobXNnID0gJ1JlbGF5IGFib3J0ZWQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ1JFTEFZX0FCT1JURUQnLCBESFRFcnJvci5SRUxBWV9BQk9SVEVEKQogIH0KCiAgc3RhdGljIFNVU1BFTkRFRChtc2cgPSAnU3VzcGVuZGVkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdTVVNQRU5ERUQnLCBESFRFcnJvci5TVVNQRU5ERUQpCiAgfQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IE5hdCA9IHJlcXVpcmUoJy4vbmF0JykKY29uc3QgU2xlZXBlciA9IHJlcXVpcmUoJy4vc2xlZXBlcicpCmNvbnN0IHsgRklSRVdBTEwgfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCmNvbnN0IEJJUlRIREFZX1NPQ0tFVFMgPSAyNTYKY29uc3QgSE9MRVBVTkNIID0gYjRhLmZyb20oWzBdKQpjb25zdCBIT0xFUFVOQ0hfVFRMID0gNQpjb25zdCBERUZBVUxUX1RUTCA9IDY0CmNvbnN0IE1BWF9SRU9QRU5TID0gMwoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBIb2xlcHVuY2hlciB7CiAgY29uc3RydWN0b3IoZGh0LCBzZXNzaW9uLCBpc0luaXRpYXRvciwgcmVtb3RlRmlyZXdhbGwgPSBGSVJFV0FMTC5VTktOT1dOKSB7CiAgICBjb25zdCBob2xkZXIgPSBkaHQuX3NvY2tldFBvb2wuYWNxdWlyZSgpCgogICAgdGhpcy5kaHQgPSBkaHQKICAgIHRoaXMuc2Vzc2lvbiA9IHNlc3Npb24KCiAgICB0aGlzLm5hdCA9IG5ldyBOYXQoZGh0LCBzZXNzaW9uLCBob2xkZXIuc29ja2V0KQogICAgdGhpcy5uYXQuYXV0b1NhbXBsZSgpCgogICAgdGhpcy5pc0luaXRpYXRvciA9IGlzSW5pdGlhdG9yCgogICAgLy8gZXZlbnRzCiAgICB0aGlzLm9uY29ubmVjdCA9IG5vb3AKICAgIHRoaXMub25hYm9ydCA9IG5vb3AKCiAgICB0aGlzLnB1bmNoaW5nID0gZmFsc2UKICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICAgIHRoaXMucmFuZG9taXplZCA9IGZhbHNlCgogICAgLy8gdHJhY2sgcmVtb3RlIHN0YXRlCiAgICB0aGlzLnJlbW90ZUZpcmV3YWxsID0gcmVtb3RlRmlyZXdhbGwKICAgIHRoaXMucmVtb3RlQWRkcmVzc2VzID0gW10KICAgIHRoaXMucmVtb3RlSG9sZXB1bmNoaW5nID0gZmFsc2UKCiAgICB0aGlzLl9zbGVlcGVyID0gbmV3IFNsZWVwZXIoKQogICAgdGhpcy5fcmVvcGVuaW5nID0gbnVsbAogICAgdGhpcy5fdGltZW91dCA9IG51bGwKICAgIHRoaXMuX3B1bmNoaW5nID0gbnVsbAogICAgdGhpcy5fYWxsSG9sZGVycyA9IFtdCiAgICB0aGlzLl9ob2xkZXIgPSB0aGlzLl9hZGRSZWYoaG9sZGVyKQogIH0KCiAgZ2V0IHNvY2tldCgpIHsKICAgIHJldHVybiB0aGlzLl9ob2xkZXIuc29ja2V0CiAgfQoKICB1cGRhdGVSZW1vdGUoeyBwdW5jaGluZywgZmlyZXdhbGwsIGFkZHJlc3NlcywgdmVyaWZpZWQgfSkgewogICAgY29uc3QgcmVtb3RlQWRkcmVzc2VzID0gW10KCiAgICBpZiAoYWRkcmVzc2VzKSB7CiAgICAgIGZvciAoY29uc3QgYWRkciBvZiBhZGRyZXNzZXMpIHsKICAgICAgICByZW1vdGVBZGRyZXNzZXMucHVzaCh7CiAgICAgICAgICBob3N0OiBhZGRyLmhvc3QsCiAgICAgICAgICBwb3J0OiBhZGRyLnBvcnQsCiAgICAgICAgICB2ZXJpZmllZDogdmVyaWZpZWQgPT09IGFkZHIuaG9zdCB8fCB0aGlzLl9pc1ZlcmlmaWVkKGFkZHIuaG9zdCkKICAgICAgICB9KQogICAgICB9CiAgICB9CgogICAgdGhpcy5yZW1vdGVGaXJld2FsbCA9IGZpcmV3YWxsCiAgICB0aGlzLnJlbW90ZUFkZHJlc3NlcyA9IHJlbW90ZUFkZHJlc3NlcwogICAgdGhpcy5yZW1vdGVIb2xlcHVuY2hpbmcgPSBwdW5jaGluZwogIH0KCiAgX2lzVmVyaWZpZWQoaG9zdCkgewogICAgZm9yIChjb25zdCBhZGRyIG9mIHRoaXMucmVtb3RlQWRkcmVzc2VzKSB7CiAgICAgIGlmIChhZGRyLnZlcmlmaWVkICYmIGFkZHIuaG9zdCA9PT0gaG9zdCkgewogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZQogIH0KCiAgcGluZyhhZGRyLCBzb2NrZXQgPSB0aGlzLl9ob2xkZXIuc29ja2V0KSB7CiAgICByZXR1cm4gaG9sZXB1bmNoKHNvY2tldCwgYWRkciwgZmFsc2UpCiAgfQoKICBvcGVuU2Vzc2lvbihhZGRyLCBzb2NrZXQgPSB0aGlzLl9ob2xkZXIuc29ja2V0KSB7CiAgICByZXR1cm4gaG9sZXB1bmNoKHNvY2tldCwgYWRkciwgdHJ1ZSkKICB9CgogIGFzeW5jIGFuYWx5emUoYWxsb3dSZW9wZW4pIHsKICAgIGF3YWl0IHRoaXMubmF0LmFuYWx5emluZwogICAgaWYgKHRoaXMuX3Vuc3RhYmxlKCkpIHsKICAgICAgaWYgKCFhbGxvd1Jlb3BlbikgcmV0dXJuIGZhbHNlCiAgICAgIGlmICghdGhpcy5fcmVvcGVuaW5nKSB0aGlzLl9yZW9wZW5pbmcgPSB0aGlzLl9yZW9wZW4oKQogICAgICByZXR1cm4gdGhpcy5fcmVvcGVuaW5nCiAgICB9CiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3Vuc3RhYmxlKCkgewogICAgLy8gVE9ETyEhOiBXZSBuZWVkIGFuIGFkZGl0aW9uYWwgaGV1cmlzdGljIGhlcmUuLi4gSWYgd2Ugd2VyZSBOT1QgcmFuZG9tIGluIHRoZSBwYXN0IHdlIHNob3VsZCBhbHNvIGRvIHRoaXMuCiAgICBjb25zdCBmaXJld2FsbCA9IHRoaXMubmF0LmZpcmV3YWxsCiAgICByZXR1cm4gKAogICAgICAodGhpcy5yZW1vdGVGaXJld2FsbCA+PSBGSVJFV0FMTC5SQU5ET00gJiYgZmlyZXdhbGwgPj0gRklSRVdBTEwuUkFORE9NKSB8fAogICAgICBmaXJld2FsbCA9PT0gRklSRVdBTEwuVU5LTk9XTgogICAgKQogIH0KCiAgX3Jlc2V0KCkgewogICAgY29uc3QgcHJldiA9IHRoaXMuX2hvbGRlcgoKICAgIHRoaXMuX2FsbEhvbGRlcnMucG9wKCkKICAgIHRoaXMuX2hvbGRlciA9IHRoaXMuX2FkZFJlZih0aGlzLmRodC5fc29ja2V0UG9vbC5hY3F1aXJlKCkpCgogICAgcHJldi5yZWxlYXNlKCkKICAgIHRoaXMubmF0LmRlc3Ryb3koKQoKICAgIHRoaXMubmF0ID0gbmV3IE5hdCh0aGlzLmRodCwgdGhpcy5zZXNzaW9uLCB0aGlzLl9ob2xkZXIuc29ja2V0KQogICAgLy8gVE9ETzogbWF5YmUgbWFrZSBhdXRvIHNhbXBsaW5nIGNvbmZpZ3VyYWJsZSBzb21laG93PwogICAgdGhpcy5uYXQuYXV0b1NhbXBsZSgpCiAgfQoKICBfYWRkUmVmKHJlZikgewogICAgdGhpcy5fYWxsSG9sZGVycy5wdXNoKHJlZikKICAgIHJlZi5vbmhvbGVwdW5jaG1lc3NhZ2UgPSAobXNnLCByaW5mbykgPT4gdGhpcy5fb25ob2xlcHVuY2htZXNzYWdlKG1zZywgcmluZm8sIHJlZikKICAgIHJldHVybiByZWYKICB9CgogIF9vbmhvbGVwdW5jaG1lc3NhZ2UoXywgYWRkciwgcmVmKSB7CiAgICBpZiAoIXRoaXMuaXNJbml0aWF0b3IpIHsKICAgICAgLy8gVE9ETzogd2UgZG9uJ3QgbmVlZCB0aGlzIGlmIHdlIGhhZCBhIHdheSB0byBjb25uZWN0IGEgc29ja2V0IHRvIG1hbnkgaG9zdHMKICAgICAgaG9sZXB1bmNoKHJlZi5zb2NrZXQsIGFkZHIsIGZhbHNlKSAvLyBuZXZlciBmYWlscwogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5jb25uZWN0ZWQpIHJldHVybgoKICAgIHRoaXMuY29ubmVjdGVkID0gdHJ1ZQogICAgdGhpcy5wdW5jaGluZyA9IGZhbHNlCgogICAgZm9yIChjb25zdCByIG9mIHRoaXMuX2FsbEhvbGRlcnMpIHsKICAgICAgaWYgKHIgPT09IHJlZikgY29udGludWUKICAgICAgci5yZWxlYXNlKCkKICAgIH0KCiAgICB0aGlzLl9hbGxIb2xkZXJzWzBdID0gcmVmCiAgICB3aGlsZSAodGhpcy5fYWxsSG9sZGVycy5sZW5ndGggPiAxKSB0aGlzLl9hbGxIb2xkZXJzLnBvcCgpCgogICAgdGhpcy5fZGVjcmVtZW50UmFuZG9taXplZCgpCiAgICB0aGlzLm9uY29ubmVjdChyZWYuc29ja2V0LCBhZGRyLnBvcnQsIGFkZHIuaG9zdCkKICB9CgogIF9kb25lKCkgewogICAgcmV0dXJuIHRoaXMuZGVzdHJveWVkIHx8IHRoaXMuY29ubmVjdGVkCiAgfQoKICBhc3luYyBfcmVvcGVuKCkgewogICAgZm9yIChsZXQgaSA9IDA7IHRoaXMuX3Vuc3RhYmxlKCkgJiYgaSA8IE1BWF9SRU9QRU5TICYmICF0aGlzLl9kb25lKCkgJiYgIXRoaXMucHVuY2hpbmc7IGkrKykgewogICAgICB0aGlzLl9yZXNldCgpCiAgICAgIGF3YWl0IHRoaXMubmF0LmFuYWx5emluZwogICAgfQoKICAgIHJldHVybiBjb2VyY2VGaXJld2FsbCh0aGlzLm5hdC5maXJld2FsbCkgPT09IEZJUkVXQUxMLkNPTlNJU1RFTlQKICB9CgogIHB1bmNoKCkgewogICAgaWYgKCF0aGlzLl9wdW5jaGluZykgdGhpcy5fcHVuY2hpbmcgPSB0aGlzLl9wdW5jaCgpCiAgICByZXR1cm4gdGhpcy5fcHVuY2hpbmcKICB9CgogIGFzeW5jIF9wdW5jaCgpIHsKICAgIGlmICh0aGlzLl9kb25lKCkgfHwgIXRoaXMucmVtb3RlQWRkcmVzc2VzLmxlbmd0aCkgcmV0dXJuIGZhbHNlCgogICAgdGhpcy5wdW5jaGluZyA9IHRydWUKCiAgICAvLyBDb2VyY2UgaW50byBjb25zaXN0ZW5jeSBmb3Igbm93LiBPYnZzIHdlIGNvdWxkIG1ha2UgdGhpcyB0aGlzIG1vcmUgZWZmaWNpZW50IGlmIHdlIHVzZSB0aGF0IGluZm8KICAgIC8vIGJ1dCB0aGF0J3Mgc2VsZG9tbHkgdXNlZCBzaW5jZSB0aG9zZSB3aWxsIGp1c3QgdXNlIHRjcCBtb3N0IG9mIHRoZSB0aW1lLgoKICAgIGNvbnN0IGxvY2FsID0gY29lcmNlRmlyZXdhbGwodGhpcy5uYXQuZmlyZXdhbGwpCiAgICBjb25zdCByZW1vdGUgPSBjb2VyY2VGaXJld2FsbCh0aGlzLnJlbW90ZUZpcmV3YWxsKQoKICAgIC8vIE5vdGUgdGhhdCBtb3N0IG9mIHRoZXNlIGFzeW5jIGZ1bmN0aW9ucyBhcmUgbWVhbnQgdG8gcnVuIGluIHRoZSBiYWNrZ3JvdW5kCiAgICAvLyB3aGljaCBpcyB3aHkgd2UgZG9uJ3QgYXdhaXQgdGhlbSBoZXJlIGFuZCB3aHkgdGhleSBhcmUgbm90IGFsbG93ZWQgdG8gdGhyb3cKCiAgICBsZXQgcmVtb3RlVmVyaWZpZWRBZGRyZXNzID0gbnVsbAogICAgZm9yIChjb25zdCBhZGRyIG9mIHRoaXMucmVtb3RlQWRkcmVzc2VzKSB7CiAgICAgIGlmIChhZGRyLnZlcmlmaWVkKSB7CiAgICAgICAgcmVtb3RlVmVyaWZpZWRBZGRyZXNzID0gYWRkcgogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KCiAgICBpZiAobG9jYWwgPT09IEZJUkVXQUxMLkNPTlNJU1RFTlQgJiYgcmVtb3RlID09PSBGSVJFV0FMTC5DT05TSVNURU5UKSB7CiAgICAgIHRoaXMuZGh0LnN0YXRzLnB1bmNoZXMuY29uc2lzdGVudCsrCiAgICAgIHRoaXMuX2NvbnNpc3RlbnRQcm9iZSgpCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgaWYgKCFyZW1vdGVWZXJpZmllZEFkZHJlc3MpIHJldHVybiBmYWxzZQoKICAgIGlmIChsb2NhbCA9PT0gRklSRVdBTEwuQ09OU0lTVEVOVCAmJiByZW1vdGUgPj0gRklSRVdBTEwuUkFORE9NKSB7CiAgICAgIHRoaXMuZGh0LnN0YXRzLnB1bmNoZXMucmFuZG9tKysKICAgICAgdGhpcy5faW5jcmVtZW50UmFuZG9taXplZCgpCiAgICAgIHRoaXMuX3JhbmRvbVByb2JlcyhyZW1vdGVWZXJpZmllZEFkZHJlc3MpCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgaWYgKGxvY2FsID49IEZJUkVXQUxMLlJBTkRPTSAmJiByZW1vdGUgPT09IEZJUkVXQUxMLkNPTlNJU1RFTlQpIHsKICAgICAgdGhpcy5kaHQuc3RhdHMucHVuY2hlcy5yYW5kb20rKwogICAgICB0aGlzLl9pbmNyZW1lbnRSYW5kb21pemVkKCkKICAgICAgYXdhaXQgdGhpcy5fb3BlbkJpcnRoZGF5U29ja2V0cyhyZW1vdGVWZXJpZmllZEFkZHJlc3MpCiAgICAgIGlmICh0aGlzLnB1bmNoaW5nKSB0aGlzLl9rZWVwQWxpdmVSYW5kb21OYXQocmVtb3RlVmVyaWZpZWRBZGRyZXNzKQogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgLy8gTm90ZSB0aGF0IHRoaXMgbmV2ZXIgdGhyb3dzIHNvIGl0IGlzIHNhZmUgdG8gcnVuIGluIHRoZSBiYWNrZ3JvdW5kCiAgYXN5bmMgX2NvbnNpc3RlbnRQcm9iZSgpIHsKICAgIC8vIEhlcmUgd2UgZG8gdGhlIHNsZWVwIGZpcnN0IGJlY2F1c2UgdGhlICJmYXN0IG9wZW4iIG1vZGUgaW4gdGhlIHNlcnZlciBqdXN0IGZpcmVkIGEgcGluZwogICAgaWYgKCF0aGlzLmlzSW5pdGlhdG9yKSBhd2FpdCB0aGlzLl9zbGVlcGVyLnBhdXNlKDEwMDApCgogICAgbGV0IHRyaWVzID0gMAoKICAgIHdoaWxlICh0aGlzLnB1bmNoaW5nICYmIHRyaWVzKysgPCAxMCkgewogICAgICBmb3IgKGNvbnN0IGFkZHIgb2YgdGhpcy5yZW1vdGVBZGRyZXNzZXMpIHsKICAgICAgICAvLyBvbmx5IHRyeSB1bnZlcmlmaWVkIGFkZHJlc3NlcyBldmVyeSA0IHRpY2tzCiAgICAgICAgaWYgKCFhZGRyLnZlcmlmaWVkICYmICh0cmllcyAmIDMpICE9PSAwKSBjb250aW51ZQogICAgICAgIGF3YWl0IGhvbGVwdW5jaCh0aGlzLl9ob2xkZXIuc29ja2V0LCBhZGRyLCBmYWxzZSkKICAgICAgfQogICAgICBpZiAodGhpcy5wdW5jaGluZykgYXdhaXQgdGhpcy5fc2xlZXBlci5wYXVzZSgxMDAwKQogICAgfQoKICAgIHRoaXMuX2F1dG9EZXN0cm95KCkKICB9CgogIC8vIE5vdGUgdGhhdCB0aGlzIG5ldmVyIHRocm93cyBzbyBpdCBpcyBzYWZlIHRvIHJ1biBpbiB0aGUgYmFja2dyb3VuZAogIGFzeW5jIF9yYW5kb21Qcm9iZXMocmVtb3RlQWRkcikgewogICAgbGV0IHRyaWVzID0gMTc1MCAvLyB+MzVzCgogICAgd2hpbGUgKHRoaXMucHVuY2hpbmcgJiYgdHJpZXMtLSA+IDApIHsKICAgICAgY29uc3QgYWRkciA9IHsgaG9zdDogcmVtb3RlQWRkci5ob3N0LCBwb3J0OiByYW5kb21Qb3J0KCkgfQogICAgICBhd2FpdCBob2xlcHVuY2godGhpcy5faG9sZGVyLnNvY2tldCwgYWRkciwgZmFsc2UpCiAgICAgIGlmICh0aGlzLnB1bmNoaW5nKSBhd2FpdCB0aGlzLl9zbGVlcGVyLnBhdXNlKDIwKQogICAgfQoKICAgIHRoaXMuX2F1dG9EZXN0cm95KCkKICB9CgogIC8vIE5vdGUgdGhhdCB0aGlzIG5ldmVyIHRocm93cyBzbyBpdCBpcyBzYWZlIHRvIHJ1biBpbiB0aGUgYmFja2dyb3VuZAogIGFzeW5jIF9rZWVwQWxpdmVSYW5kb21OYXQocmVtb3RlQWRkcikgewogICAgbGV0IGkgPSAwCiAgICBsZXQgbG93VFRMUm91bmRzID0gMQoKICAgIC8vIFRPRE86IGV4cGVyaW1lbnQgd2l0aCB0aGlzIGhlcmUuIFdlIGp1c3QgYnVyc3RlZCBhbGwgdGhlIG1lc3NhZ2VzIGluCiAgICAvLyBvcGVuT3RoZXJTb2NrZXRzIHRvIGVuc3VyZSB0aGUgc29ja2V0cyBhcmUgb3Blbiwgc28gaXQncyBwb3RlbnRpYWxseQogICAgLy8gYSBnb29kIGlkZWEgdG8gc2xvdyBkb3duIGZvciBhIGJpdC4KICAgIGF3YWl0IHRoaXMuX3NsZWVwZXIucGF1c2UoMTAwKQoKICAgIGxldCB0cmllcyA9IDE3NTAgLy8gfjM1cwoKICAgIHdoaWxlICh0aGlzLnB1bmNoaW5nICYmIHRyaWVzLS0gPiAwKSB7CiAgICAgIGlmIChpID09PSB0aGlzLl9hbGxIb2xkZXJzLmxlbmd0aCkgewogICAgICAgIGkgPSAwCiAgICAgICAgaWYgKGxvd1RUTFJvdW5kcyA+IDApIGxvd1RUTFJvdW5kcy0tCiAgICAgIH0KCiAgICAgIGF3YWl0IGhvbGVwdW5jaCh0aGlzLl9hbGxIb2xkZXJzW2krK10uc29ja2V0LCByZW1vdGVBZGRyLCBsb3dUVExSb3VuZHMgPiAwKQogICAgICBpZiAodGhpcy5wdW5jaGluZykgYXdhaXQgdGhpcy5fc2xlZXBlci5wYXVzZSgyMCkKICAgIH0KCiAgICB0aGlzLl9hdXRvRGVzdHJveSgpCiAgfQoKICBhc3luYyBfb3BlbkJpcnRoZGF5U29ja2V0cyhyZW1vdGVBZGRyKSB7CiAgICB3aGlsZSAodGhpcy5wdW5jaGluZyAmJiB0aGlzLl9hbGxIb2xkZXJzLmxlbmd0aCA8IEJJUlRIREFZX1NPQ0tFVFMpIHsKICAgICAgY29uc3QgcmVmID0gdGhpcy5fYWRkUmVmKHRoaXMuZGh0Ll9zb2NrZXRQb29sLmFjcXVpcmUoKSkKICAgICAgYXdhaXQgaG9sZXB1bmNoKHJlZi5zb2NrZXQsIHJlbW90ZUFkZHIsIEhPTEVQVU5DSF9UVEwpCiAgICB9CiAgfQoKICBfYXV0b0Rlc3Ryb3koKSB7CiAgICBpZiAoIXRoaXMuY29ubmVjdGVkKSB0aGlzLmRlc3Ryb3koKQogIH0KCiAgX2luY3JlbWVudFJhbmRvbWl6ZWQoKSB7CiAgICBpZiAoIXRoaXMucmFuZG9taXplZCkgewogICAgICB0aGlzLnJhbmRvbWl6ZWQgPSB0cnVlCiAgICAgIHRoaXMuZGh0Ll9yYW5kb21QdW5jaGVzKysKICAgIH0KICB9CgogIF9kZWNyZW1lbnRSYW5kb21pemVkKCkgewogICAgaWYgKHRoaXMucmFuZG9taXplZCkgewogICAgICB0aGlzLmRodC5fbGFzdFJhbmRvbVB1bmNoID0gRGF0ZS5ub3coKQogICAgICB0aGlzLnJhbmRvbWl6ZWQgPSBmYWxzZQogICAgICB0aGlzLmRodC5fcmFuZG9tUHVuY2hlcy0tCiAgICB9CiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQogICAgdGhpcy5wdW5jaGluZyA9IGZhbHNlCgogICAgZm9yIChjb25zdCByZWYgb2YgdGhpcy5fYWxsSG9sZGVycykgcmVmLnJlbGVhc2UoKQogICAgdGhpcy5fYWxsSG9sZGVycyA9IFtdCiAgICB0aGlzLm5hdC5kZXN0cm95KCkKCiAgICBpZiAoIXRoaXMuY29ubmVjdGVkKSB7CiAgICAgIHRoaXMuX2RlY3JlbWVudFJhbmRvbWl6ZWQoKQogICAgICB0aGlzLm9uYWJvcnQoKQogICAgfQogIH0KCiAgc3RhdGljIHBpbmcoc29ja2V0LCBhZGRyKSB7CiAgICByZXR1cm4gaG9sZXB1bmNoKHNvY2tldCwgYWRkciwgZmFsc2UpCiAgfQoKICBzdGF0aWMgbG9jYWxBZGRyZXNzZXMoc29ja2V0KSB7CiAgICByZXR1cm4gbG9jYWxBZGRyZXNzZXMoc29ja2V0KQogIH0KCiAgc3RhdGljIG1hdGNoQWRkcmVzcyhteUFkZHJlc3NlcywgZXh0ZXJuYWxBZGRyZXNzZXMpIHsKICAgIHJldHVybiBtYXRjaEFkZHJlc3MobXlBZGRyZXNzZXMsIGV4dGVybmFsQWRkcmVzc2VzKQogIH0KfQoKZnVuY3Rpb24gaG9sZXB1bmNoKHNvY2tldCwgYWRkciwgbG93VFRMKSB7CiAgcmV0dXJuIHNvY2tldC5zZW5kKEhPTEVQVU5DSCwgYWRkci5wb3J0LCBhZGRyLmhvc3QsIGxvd1RUTCA/IEhPTEVQVU5DSF9UVEwgOiBERUZBVUxUX1RUTCkKfQoKZnVuY3Rpb24gcmFuZG9tUG9ydCgpIHsKICByZXR1cm4gKDEwMDAgKyBNYXRoLnJhbmRvbSgpICogNjQ1MzYpIHwgMAp9CgpmdW5jdGlvbiBjb2VyY2VGaXJld2FsbChmdykgewogIHJldHVybiBmdyA9PT0gRklSRVdBTEwuT1BFTiA/IEZJUkVXQUxMLkNPTlNJU1RFTlQgOiBmdwp9CgpmdW5jdGlvbiBsb2NhbEFkZHJlc3Nlcyhzb2NrZXQpIHsKICBjb25zdCBhZGRycyA9IFtdCiAgY29uc3QgeyBob3N0LCBwb3J0IH0gPSBzb2NrZXQuYWRkcmVzcygpCgogIGlmIChob3N0ID09PSAnMTI3LjAuMC4xJykgcmV0dXJuIFt7IGhvc3QsIHBvcnQgfV0KCiAgZm9yIChjb25zdCBuIG9mIHNvY2tldC51ZHgubmV0d29ya0ludGVyZmFjZXMoKSkgewogICAgaWYgKG4uZmFtaWx5ICE9PSA0IHx8IG4uaW50ZXJuYWwpIGNvbnRpbnVlCgogICAgYWRkcnMucHVzaCh7IGhvc3Q6IG4uaG9zdCwgcG9ydCB9KQogIH0KCiAgaWYgKGFkZHJzLmxlbmd0aCA9PT0gMCkgewogICAgYWRkcnMucHVzaCh7IGhvc3Q6ICcxMjcuMC4wLjEnLCBwb3J0IH0pCiAgfQoKICByZXR1cm4gYWRkcnMKfQoKZnVuY3Rpb24gbWF0Y2hBZGRyZXNzKGxvY2FsQWRkcmVzc2VzLCByZW1vdGVMb2NhbEFkZHJlc3NlcykgewogIGlmIChyZW1vdGVMb2NhbEFkZHJlc3Nlcy5sZW5ndGggPT09IDApIHJldHVybiBudWxsCgogIGxldCBiZXN0ID0geyBzZWdtZW50OiAxLCBhZGRyOiBudWxsIH0KCiAgZm9yIChjb25zdCBsb2NhbEFkZHJlc3Mgb2YgbG9jYWxBZGRyZXNzZXMpIHsKICAgIC8vID0+IDE5Mi4xNjguMTIyLjIzOAogICAgY29uc3QgYSA9IGxvY2FsQWRkcmVzcy5ob3N0LnNwbGl0KCcuJykKCiAgICBmb3IgKGNvbnN0IHJlbW90ZUFkZHJlc3Mgb2YgcmVtb3RlTG9jYWxBZGRyZXNzZXMpIHsKICAgICAgLy8gPT4gMTkyLjE2OC4wLjIzCiAgICAgIC8vID0+IDE5Mi4xNjguMTIyLjEKICAgICAgY29uc3QgYiA9IHJlbW90ZUFkZHJlc3MuaG9zdC5zcGxpdCgnLicpCgogICAgICAvLyBNYXRjaGVzIDE5Mi4qLiouKgogICAgICBpZiAoYVswXSA9PT0gYlswXSkgewogICAgICAgIGlmIChiZXN0LnNlZ21lbnQgPT09IDEpIGJlc3QgPSB7IHNlZ21lbnQ6IDIsIGFkZHI6IHJlbW90ZUFkZHJlc3MgfQoKICAgICAgICAvLyBNYXRjaGVzIDE5Mi4xNjguKi4qCiAgICAgICAgaWYgKGFbMV0gPT09IGJbMV0pIHsKICAgICAgICAgIGlmIChiZXN0LnNlZ21lbnQgPT09IDIpIGJlc3QgPSB7IHNlZ21lbnQ6IDMsIGFkZHI6IHJlbW90ZUFkZHJlc3MgfQoKICAgICAgICAgIC8vIE1hdGNoZXMgMTkyLjE2OC4xMjIuKgogICAgICAgICAgaWYgKGFbMl0gPT09IGJbMl0pIHJldHVybiByZW1vdGVBZGRyZXNzCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gYmVzdC5hZGRyCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IG5ldCA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmctbmV0JykKCmNvbnN0IGlwdjQgPSB7CiAgLi4ubmV0LmlwdjRBZGRyZXNzLAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgaXAgPSBuZXQuaXB2NEFkZHJlc3MuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgaG9zdDogaXAuaG9zdCwKICAgICAgcG9ydDogaXAucG9ydAogICAgfQogIH0KfQoKY29uc3QgaXB2NEFycmF5ID0gYy5hcnJheShpcHY0KQoKY29uc3QgaXB2NiA9IHsKICAuLi5uZXQuaXB2NkFkZHJlc3MsCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBpcCA9IG5ldC5pcHY2QWRkcmVzcy5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBob3N0OiBpcC5ob3N0LAogICAgICBwb3J0OiBpcC5wb3J0CiAgICB9CiAgfQp9Cgpjb25zdCBpcHY2QXJyYXkgPSBjLmFycmF5KGlwdjYpCgpleHBvcnRzLmhhbmRzaGFrZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCArPSAxICsgMSArIChtLnBlZXJBZGRyZXNzID8gNiA6IDApICsgKG0ucmVsYXlBZGRyZXNzID8gNiA6IDApCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0ubm9pc2UpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gKG0ucGVlckFkZHJlc3MgPyAxIDogMCkgfCAobS5yZWxheUFkZHJlc3MgPyAyIDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubW9kZSkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS5ub2lzZSkKCiAgICBpZiAobS5wZWVyQWRkcmVzcykgaXB2NC5lbmNvZGUoc3RhdGUsIG0ucGVlckFkZHJlc3MpCiAgICBpZiAobS5yZWxheUFkZHJlc3MpIGlwdjQuZW5jb2RlKHN0YXRlLCBtLnJlbGF5QWRkcmVzcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIG1vZGU6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBub2lzZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgcGVlckFkZHJlc3M6IGZsYWdzICYgMSA/IGlwdjQuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHJlbGF5QWRkcmVzczogZmxhZ3MgJiAyID8gaXB2NC5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKY29uc3QgcmVsYXlJbmZvID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kICs9IDEyCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGlwdjQuZW5jb2RlKHN0YXRlLCBtLnJlbGF5QWRkcmVzcykKICAgIGlwdjQuZW5jb2RlKHN0YXRlLCBtLnBlZXJBZGRyZXNzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICByZWxheUFkZHJlc3M6IGlwdjQuZGVjb2RlKHN0YXRlKSwKICAgICAgcGVlckFkZHJlc3M6IGlwdjQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVsYXlJbmZvQXJyYXkgPSBjLmFycmF5KHJlbGF5SW5mbykKCmNvbnN0IGhvbGVwdW5jaEluZm8gPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgcmVsYXlJbmZvQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLnJlbGF5cykKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5pZCkKICAgIHJlbGF5SW5mb0FycmF5LmVuY29kZShzdGF0ZSwgbS5yZWxheXMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGlkOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgcmVsYXlzOiByZWxheUluZm9BcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCB1ZHhJbmZvID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kICs9IDIgLy8gdmVyc2lvbiArIGZlYXR1cmVzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zZXEpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJldXNhYmxlU29ja2V0ID8gMSA6IDApCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zZXEpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmVhdHVyZXMgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb24sCiAgICAgIHJldXNhYmxlU29ja2V0OiAoZmVhdHVyZXMgJiAxKSAhPT0gMCwKICAgICAgaWQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzZXE6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBzZWNyZXRTdHJlYW1JbmZvID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgMSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgMSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlbGF5VGhyb3VnaEluZm8gPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCAxKSAvLyB2ZXJzaW9uCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCAwKSAvLyBmbGFncwogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnRva2VuKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS50b2tlbikKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb24sCiAgICAgIHB1YmxpY0tleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIHRva2VuOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKZXhwb3J0cy5ub2lzZVBheWxvYWQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQgKz0gNCAvLyB2ZXJzaW9uICsgZmxhZ3MgKyBlcnJvciArIGZpcmV3YWxsCiAgICBpZiAobS5ob2xlcHVuY2gpIGhvbGVwdW5jaEluZm8ucHJlZW5jb2RlKHN0YXRlLCBtLmhvbGVwdW5jaCkKICAgIGlmIChtLmFkZHJlc3NlczQgJiYgbS5hZGRyZXNzZXM0Lmxlbmd0aCkgaXB2NEFycmF5LnByZWVuY29kZShzdGF0ZSwgbS5hZGRyZXNzZXM0KQogICAgaWYgKG0uYWRkcmVzc2VzNiAmJiBtLmFkZHJlc3NlczYubGVuZ3RoKSBpcHY2QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLmFkZHJlc3NlczYpCiAgICBpZiAobS51ZHgpIHVkeEluZm8ucHJlZW5jb2RlKHN0YXRlLCBtLnVkeCkKICAgIGlmIChtLnNlY3JldFN0cmVhbSkgc2VjcmV0U3RyZWFtSW5mby5wcmVlbmNvZGUoc3RhdGUsIG0uc2VjcmV0U3RyZWFtKQogICAgaWYgKG0ucmVsYXlUaHJvdWdoKSByZWxheVRocm91Z2hJbmZvLnByZWVuY29kZShzdGF0ZSwgbS5yZWxheVRocm91Z2gpCiAgICBpZiAobS5yZWxheUFkZHJlc3NlcykgaXB2NEFycmF5LnByZWVuY29kZShzdGF0ZSwgbS5yZWxheUFkZHJlc3NlcykKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgbGV0IGZsYWdzID0gMAoKICAgIGlmIChtLmhvbGVwdW5jaCkgZmxhZ3MgfD0gMQogICAgaWYgKG0uYWRkcmVzc2VzNCAmJiBtLmFkZHJlc3NlczQubGVuZ3RoKSBmbGFncyB8PSAyCiAgICBpZiAobS5hZGRyZXNzZXM2ICYmIG0uYWRkcmVzc2VzNi5sZW5ndGgpIGZsYWdzIHw9IDQKICAgIGlmIChtLnVkeCkgZmxhZ3MgfD0gOAogICAgaWYgKG0uc2VjcmV0U3RyZWFtKSBmbGFncyB8PSAxNgogICAgaWYgKG0ucmVsYXlUaHJvdWdoKSBmbGFncyB8PSAzMgogICAgaWYgKG0ucmVsYXlBZGRyZXNzZXMpIGZsYWdzIHw9IDY0CgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgMSkgLy8gdmVyc2lvbgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmVycm9yKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5maXJld2FsbCkKCiAgICBpZiAobS5ob2xlcHVuY2gpIGhvbGVwdW5jaEluZm8uZW5jb2RlKHN0YXRlLCBtLmhvbGVwdW5jaCkKICAgIGlmIChtLmFkZHJlc3NlczQgJiYgbS5hZGRyZXNzZXM0Lmxlbmd0aCkgaXB2NEFycmF5LmVuY29kZShzdGF0ZSwgbS5hZGRyZXNzZXM0KQogICAgaWYgKG0uYWRkcmVzc2VzNiAmJiBtLmFkZHJlc3NlczYubGVuZ3RoKSBpcHY2QXJyYXkuZW5jb2RlKHN0YXRlLCBtLmFkZHJlc3NlczYpCiAgICBpZiAobS51ZHgpIHVkeEluZm8uZW5jb2RlKHN0YXRlLCBtLnVkeCkKICAgIGlmIChtLnNlY3JldFN0cmVhbSkgc2VjcmV0U3RyZWFtSW5mby5lbmNvZGUoc3RhdGUsIG0uc2VjcmV0U3RyZWFtKQogICAgaWYgKG0ucmVsYXlUaHJvdWdoKSByZWxheVRocm91Z2hJbmZvLmVuY29kZShzdGF0ZSwgbS5yZWxheVRocm91Z2gpCiAgICBpZiAobS5yZWxheUFkZHJlc3NlcykgaXB2NEFycmF5LmVuY29kZShzdGF0ZSwgbS5yZWxheUFkZHJlc3NlcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgaWYgKHZlcnNpb24gIT09IDEpIHsKICAgICAgLy8gRG8gbm90IGF0dGVtcHQgdG8gZGVjb2RlIGJ1dCByZXR1cm4gdGhpcyBiYWNrIHRvIHRoZSB1c2VyIHNvIHRoZXkgY2FuCiAgICAgIC8vIGFjdHVhbGx5IGhhbmRsZSBpdAogICAgICByZXR1cm4gewogICAgICAgIHZlcnNpb24sCiAgICAgICAgZXJyb3I6IDAsCiAgICAgICAgZmlyZXdhbGw6IDAsCiAgICAgICAgaG9sZXB1bmNoOiBudWxsLAogICAgICAgIGFkZHJlc3NlczQ6IFtdLAogICAgICAgIGFkZHJlc3NlczY6IFtdLAogICAgICAgIHVkeDogbnVsbCwKICAgICAgICBzZWNyZXRTdHJlYW06IG51bGwsCiAgICAgICAgcmVsYXlUaHJvdWdoOiBudWxsLAogICAgICAgIHJlbGF5QWRkcmVzc2VzOiBudWxsCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbiwKICAgICAgZXJyb3I6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBmaXJld2FsbDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGhvbGVwdW5jaDogKGZsYWdzICYgMSkgIT09IDAgPyBob2xlcHVuY2hJbmZvLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBhZGRyZXNzZXM0OiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGlwdjRBcnJheS5kZWNvZGUoc3RhdGUpIDogW10sCiAgICAgIGFkZHJlc3NlczY6IChmbGFncyAmIDQpICE9PSAwID8gaXB2NkFycmF5LmRlY29kZShzdGF0ZSkgOiBbXSwKICAgICAgdWR4OiAoZmxhZ3MgJiA4KSAhPT0gMCA/IHVkeEluZm8uZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHNlY3JldFN0cmVhbTogKGZsYWdzICYgMTYpICE9PSAwID8gc2VjcmV0U3RyZWFtSW5mby5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgcmVsYXlUaHJvdWdoOiAoZmxhZ3MgJiAzMikgIT09IDAgPyByZWxheVRocm91Z2hJbmZvLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICByZWxheUFkZHJlc3NlczogKGZsYWdzICYgNjQpICE9PSAwID8gaXB2NEFycmF5LmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9CgpleHBvcnRzLmhvbGVwdW5jaCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCArPSAyCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnBheWxvYWQpCiAgICBpZiAobS5wZWVyQWRkcmVzcykgaXB2NC5wcmVlbmNvZGUoc3RhdGUsIG0ucGVlckFkZHJlc3MpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gbS5wZWVyQWRkcmVzcyA/IDEgOiAwCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubW9kZSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uaWQpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0ucGF5bG9hZCkKICAgIGlmIChtLnBlZXJBZGRyZXNzKSBpcHY0LmVuY29kZShzdGF0ZSwgbS5wZWVyQWRkcmVzcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgbW9kZTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGlkOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgcGF5bG9hZDogYy5idWZmZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgcGVlckFkZHJlc3M6IGZsYWdzICYgMSA/IGlwdjQuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmV4cG9ydHMuaG9sZXB1bmNoUGF5bG9hZCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCArPSA0IC8vIGZsYWdzICsgZXJyb3IgKyBmaXJld2FsbCArIHJvdW5kCiAgICBpZiAobS5hZGRyZXNzZXMpIGlwdjRBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0uYWRkcmVzc2VzKQogICAgaWYgKG0ucmVtb3RlQWRkcmVzcykgc3RhdGUuZW5kICs9IDYKICAgIGlmIChtLnRva2VuKSBzdGF0ZS5lbmQgKz0gMzIKICAgIGlmIChtLnJlbW90ZVRva2VuKSBzdGF0ZS5lbmQgKz0gMzIKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPQogICAgICAobS5jb25uZWN0ZWQgPyAxIDogMCkgfAogICAgICAobS5wdW5jaGluZyA/IDIgOiAwKSB8CiAgICAgIChtLmFkZHJlc3NlcyA/IDQgOiAwKSB8CiAgICAgIChtLnJlbW90ZUFkZHJlc3MgPyA4IDogMCkgfAogICAgICAobS50b2tlbiA/IDE2IDogMCkgfAogICAgICAobS5yZW1vdGVUb2tlbiA/IDMyIDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZXJyb3IpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmZpcmV3YWxsKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yb3VuZCkKCiAgICBpZiAobS5hZGRyZXNzZXMpIGlwdjRBcnJheS5lbmNvZGUoc3RhdGUsIG0uYWRkcmVzc2VzKQogICAgaWYgKG0ucmVtb3RlQWRkcmVzcykgaXB2NC5lbmNvZGUoc3RhdGUsIG0ucmVtb3RlQWRkcmVzcykKICAgIGlmIChtLnRva2VuKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnRva2VuKQogICAgaWYgKG0ucmVtb3RlVG9rZW4pIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucmVtb3RlVG9rZW4pCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBlcnJvcjogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGZpcmV3YWxsOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgcm91bmQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBjb25uZWN0ZWQ6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBwdW5jaGluZzogKGZsYWdzICYgMikgIT09IDAsCiAgICAgIGFkZHJlc3NlczogKGZsYWdzICYgNCkgIT09IDAgPyBpcHY0QXJyYXkuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHJlbW90ZUFkZHJlc3M6IChmbGFncyAmIDgpICE9PSAwID8gaXB2NC5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdG9rZW46IChmbGFncyAmIDE2KSAhPT0gMCA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgcmVtb3RlVG9rZW46IChmbGFncyAmIDMyKSAhPT0gMCA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKY29uc3QgcGVlciA9IChleHBvcnRzLnBlZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQgKz0gMzIKICAgIGlwdjRBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0ucmVsYXlBZGRyZXNzZXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogICAgaXB2NEFycmF5LmVuY29kZShzdGF0ZSwgbS5yZWxheUFkZHJlc3NlcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcHVibGljS2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgcmVsYXlBZGRyZXNzZXM6IGlwdjRBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9KQoKY29uc3QgcGVlcnMgPSAoZXhwb3J0cy5wZWVycyA9IGMuYXJyYXkocGVlcikpCgpjb25zdCByYXdQZWVycyA9IGMuYXJyYXkoYy5yYXcpCgpleHBvcnRzLmxvb2t1cFJhd1JlcGx5ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgcmF3UGVlcnMucHJlZW5jb2RlKHN0YXRlLCBtLnBlZXJzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5idW1wKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICByYXdQZWVycy5lbmNvZGUoc3RhdGUsIG0ucGVlcnMpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmJ1bXApCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHBlZXJzOiBwZWVycy5kZWNvZGUoc3RhdGUpLAogICAgICBidW1wOiBzdGF0ZS5zdGFydCA8IHN0YXRlLmVuZCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgfQogIH0KfQoKZXhwb3J0cy5hbm5vdW5jZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBpZiAobS5wZWVyKSBwZWVyLnByZWVuY29kZShzdGF0ZSwgbS5wZWVyKQogICAgaWYgKG0ucmVmcmVzaCkgc3RhdGUuZW5kICs9IDMyCiAgICBpZiAobS5zaWduYXR1cmUpIHN0YXRlLmVuZCArPSA2NAogICAgaWYgKG0uYnVtcCkgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5idW1wKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLnBlZXIgPyAxIDogMCkgfCAobS5yZWZyZXNoID8gMiA6IDApIHwgKG0uc2lnbmF0dXJlID8gNCA6IDApIHwgKG0uYnVtcCA/IDggOiAwKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBpZiAobS5wZWVyKSBwZWVyLmVuY29kZShzdGF0ZSwgbS5wZWVyKQogICAgaWYgKG0ucmVmcmVzaCkgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5yZWZyZXNoKQogICAgaWYgKG0uc2lnbmF0dXJlKSBjLmZpeGVkNjQuZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGlmIChtLmJ1bXApIGMudWludC5lbmNvZGUoc3RhdGUsIG0uYnVtcCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHBlZXI6IChmbGFncyAmIDEpICE9PSAwID8gcGVlci5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgcmVmcmVzaDogKGZsYWdzICYgMikgIT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHNpZ25hdHVyZTogKGZsYWdzICYgNCkgIT09IDAgPyBjLmZpeGVkNjQuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGJ1bXA6IChmbGFncyAmIDgpICE9PSAwID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCiAgICB9CiAgfQp9CgpleHBvcnRzLm11dGFibGVTaWduYWJsZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc2VxKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnZhbHVlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnNlcSkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc2VxOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgdmFsdWU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmV4cG9ydHMubXV0YWJsZVB1dFJlcXVlc3QgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc2VxKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnZhbHVlKQogICAgYy5maXhlZDY0LnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zZXEpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0udmFsdWUpCiAgICBjLmZpeGVkNjQuZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcHVibGljS2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgc2VxOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgdmFsdWU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25hdHVyZTogYy5maXhlZDY0LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmV4cG9ydHMubXV0YWJsZUdldFJlc3BvbnNlID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zZXEpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0udmFsdWUpCiAgICBjLmZpeGVkNjQucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zZXEpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0udmFsdWUpCiAgICBjLmZpeGVkNjQuZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc2VxOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgdmFsdWU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25hdHVyZTogYy5maXhlZDY0LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KY29uc3QgeyBGSVJFV0FMTCB9ID0gcmVxdWlyZSgnLi4vbGliL2NvbnN0YW50cycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIE5hdCB7CiAgY29uc3RydWN0b3IoZGh0LCBzZXNzaW9uLCBzb2NrZXQpIHsKICAgIHRoaXMuX3NhbXBsZXNIb3N0ID0gW10KICAgIHRoaXMuX3NhbXBsZXNGdWxsID0gW10KICAgIHRoaXMuX3Zpc2l0ZWQgPSBuZXcgTWFwKCkKICAgIHRoaXMuX3Jlc29sdmUgPSBudWxsCiAgICB0aGlzLl9taW5TYW1wbGVzID0gNAogICAgdGhpcy5fYXV0b1NhbXBsaW5nID0gZmFsc2UKCiAgICB0aGlzLmRodCA9IGRodAogICAgdGhpcy5zZXNzaW9uID0gc2Vzc2lvbgogICAgdGhpcy5zb2NrZXQgPSBzb2NrZXQKCiAgICB0aGlzLnNhbXBsZWQgPSAwCiAgICB0aGlzLmZpcmV3YWxsID0gZGh0LmZpcmV3YWxsZWQgPyBGSVJFV0FMTC5VTktOT1dOIDogRklSRVdBTEwuT1BFTgogICAgdGhpcy5hZGRyZXNzZXMgPSBudWxsCgogICAgdGhpcy5hbmFseXppbmcgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICB0aGlzLl9yZXNvbHZlID0gcmVzb2x2ZQogICAgfSkKICB9CgogIGF1dG9TYW1wbGUocmV0cnkgPSB0cnVlKSB7CiAgICBpZiAodGhpcy5fYXV0b1NhbXBsaW5nKSByZXR1cm4KICAgIHRoaXMuX2F1dG9TYW1wbGluZyA9IHRydWUKCiAgICBjb25zdCBzZWxmID0gdGhpcwogICAgY29uc3Qgc29ja2V0ID0gdGhpcy5zb2NrZXQKICAgIGNvbnN0IG1heFBpbmdzID0gdGhpcy5fbWluU2FtcGxlcwoKICAgIGxldCBza2lwID0gdGhpcy5kaHQubm9kZXMubGVuZ3RoID49IDggPyA1IDogMAogICAgbGV0IHBlbmRpbmcgPSAwCgogICAgLy8gVE9ETzogaXQgd291bGQgYmUgYmVzdCB0byBwaWNrIHRoZSBub2RlcyB0byBoZWxwIHVzIGJhc2VkIG9uIGxhdGVuY3kgdG8gdXMKICAgIC8vIFRoYXQgc2hvdWxkIHJlZHVjZSBjb25uZWN0IGxhdGVuY3kgaW4gZ2VuZXJhbC4gV2Ugc2hvdWxkIGludmVzdGlnYXRlIHRyYWNraW5nIHRoYXQgbGF0ZXIgb24uCgogICAgLy8gVE9ETyAyOiB0cnkgdG8gcGljayBub2RlcyB3aXRoIGRpZmZlcmVudCBJUHMgYXMgd2VsbCwgYXMgdGhhdCdsbCBoZWxwIG11bHRpIElQIGNlbGwgY29ubmVjdGlvbnMuLi4KICAgIC8vIElmIHdlIGV4cG9zZSB0aGlzIGZyb20gdGhlIG5hdCBzYW1wbGVyIHRoZW4gdGhlIERIVCBzaG91bGQgYmUgYWJsZSB0byBoZWxwIHVzIGZpbHRlciBvdXQgc2NhbXMgYXMgd2VsbC4uLgoKICAgIGZvciAoCiAgICAgIGxldCBub2RlID0gdGhpcy5kaHQubm9kZXMubGF0ZXN0OwogICAgICBub2RlICYmIHRoaXMuc2FtcGxlZCArIHBlbmRpbmcgPCBtYXhQaW5nczsKICAgICAgbm9kZSA9IG5vZGUucHJldgogICAgKSB7CiAgICAgIGlmIChza2lwID4gMCkgewogICAgICAgIHNraXAtLQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGNvbnN0IHJlZiA9IG5vZGUuaG9zdCArICc6JyArIG5vZGUucG9ydAoKICAgICAgaWYgKHRoaXMuX3Zpc2l0ZWQuaGFzKHJlZikpIGNvbnRpbnVlCiAgICAgIHRoaXMuX3Zpc2l0ZWQuc2V0KHJlZiwgMSkKCiAgICAgIHBlbmRpbmcrKwogICAgICB0aGlzLnNlc3Npb24ucGluZyhub2RlLCB7IHNvY2tldCwgcmV0cnk6IGZhbHNlIH0pLnRoZW4ob25wb25nLCBvbnNraXApCiAgICB9CgogICAgcGVuZGluZysrCiAgICBvbnNraXAoKQoKICAgIGZ1bmN0aW9uIG9ucG9uZyhyZXMpIHsKICAgICAgc2VsZi5hZGQocmVzLnRvLCByZXMuZnJvbSkKICAgICAgb25za2lwKCkKICAgIH0KCiAgICBmdW5jdGlvbiBvbnNraXAoKSB7CiAgICAgIGlmICgtLXBlbmRpbmcgPT09IDAgJiYgc2VsZi5zYW1wbGVkIDwgc2VsZi5fbWluU2FtcGxlcykgewogICAgICAgIGlmIChyZXRyeSkgewogICAgICAgICAgc2VsZi5fYXV0b1NhbXBsaW5nID0gZmFsc2UKICAgICAgICAgIHNlbGYuYXV0b1NhbXBsZShmYWxzZSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICBzZWxmLl9yZXNvbHZlKCkKICAgICAgfQogICAgfQogIH0KCiAgZGVzdHJveSgpIHsKICAgIHRoaXMuX2F1dG9TYW1wbGluZyA9IHRydWUKICAgIHRoaXMuX21pblNhbXBsZXMgPSAwCiAgICB0aGlzLl9yZXNvbHZlKCkKICB9CgogIHVuZnJlZXplKCkgewogICAgdGhpcy5mcm96ZW4gPSBmYWxzZQogICAgdGhpcy5fdXBkYXRlRmlyZXdhbGwoKQogICAgdGhpcy5fdXBkYXRlQWRkcmVzc2VzKCkKICB9CgogIGZyZWV6ZSgpIHsKICAgIHRoaXMuZnJvemVuID0gdHJ1ZQogIH0KCiAgX3VwZGF0ZUZpcmV3YWxsKCkgewogICAgaWYgKCF0aGlzLmRodC5maXJld2FsbGVkKSB7CiAgICAgIHRoaXMuZmlyZXdhbGwgPSBGSVJFV0FMTC5PUEVOCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLnNhbXBsZWQgPCAzKSByZXR1cm4KCiAgICBjb25zdCBtYXggPSB0aGlzLl9zYW1wbGVzRnVsbFswXS5oaXRzCgogICAgaWYgKG1heCA+PSAzKSB7CiAgICAgIHRoaXMuZmlyZXdhbGwgPSBGSVJFV0FMTC5DT05TSVNURU5UCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChtYXggPT09IDEpIHsKICAgICAgdGhpcy5maXJld2FsbCA9IEZJUkVXQUxMLlJBTkRPTQogICAgICByZXR1cm4KICAgIH0KCiAgICAvLyBlbHNlIG1heCA9PT0gMgoKICAgIC8vIDEgaG9zdCwgPj0gNCB0b3RhbCBzYW1wbGVzIGllLCAyIGJhZCBvbmVzIC0+IHJhbmRvbQogICAgaWYgKHRoaXMuX3NhbXBsZXNIb3N0Lmxlbmd0aCA9PT0gMSAmJiB0aGlzLnNhbXBsZWQgPiAzKSB7CiAgICAgIHRoaXMuZmlyZXdhbGwgPSBGSVJFV0FMTC5SQU5ET00KICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gZG91YmxlIGhpdCBvbiB0d28gZGlmZmVyZW50IGlwcyAtPiBhc3N1bWUgY29uc2lzdGVudAogICAgaWYgKHRoaXMuX3NhbXBsZXNIb3N0Lmxlbmd0aCA+IDEgJiYgdGhpcy5fc2FtcGxlc0Z1bGxbMV0uaGl0cyA+IDEpIHsKICAgICAgdGhpcy5maXJld2FsbCA9IEZJUkVXQUxMLkNPTlNJU1RFTlQKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gKDQgaXMganVzdCBtZWFucyAtIGFsbCB0aGUgc2FtcGxlcyB3ZSBleHBlY3QpIC0gbm8gZGVjaXNpb24gLSBhc3N1bWUgcmFuZG9tCiAgICBpZiAodGhpcy5zYW1wbGVkID4gNCkgewogICAgICB0aGlzLmZpcmV3YWxsID0gRklSRVdBTEwuUkFORE9NCiAgICB9CiAgfQoKICBfdXBkYXRlQWRkcmVzc2VzKCkgewogICAgaWYgKHRoaXMuZmlyZXdhbGwgPT09IEZJUkVXQUxMLlVOS05PV04pIHsKICAgICAgdGhpcy5hZGRyZXNzZXMgPSBudWxsCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLmZpcmV3YWxsID09PSBGSVJFV0FMTC5SQU5ET00pIHsKICAgICAgdGhpcy5hZGRyZXNzZXMgPSBbdGhpcy5fc2FtcGxlc0hvc3RbMF1dCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLmZpcmV3YWxsID09PSBGSVJFV0FMTC5DT05TSVNURU5UKSB7CiAgICAgIHRoaXMuYWRkcmVzc2VzID0gW10KICAgICAgZm9yIChjb25zdCBhZGRyIG9mIHRoaXMuX3NhbXBsZXNGdWxsKSB7CiAgICAgICAgaWYgKGFkZHIuaGl0cyA+PSAyIHx8IHRoaXMuYWRkcmVzc2VzLmxlbmd0aCA8IDIpIHRoaXMuYWRkcmVzc2VzLnB1c2goYWRkcikKICAgICAgfQogICAgfQogIH0KCiAgdXBkYXRlKCkgewogICAgaWYgKHRoaXMuZGh0LmZpcmV3YWxsZWQgJiYgdGhpcy5maXJld2FsbCA9PT0gRklSRVdBTEwuT1BFTikgewogICAgICB0aGlzLmZpcmV3YWxsID0gRklSRVdBTEwuVU5LTk9XTgogICAgfQogICAgdGhpcy5fdXBkYXRlRmlyZXdhbGwoKQogICAgdGhpcy5fdXBkYXRlQWRkcmVzc2VzKCkKICB9CgogIGFkZChhZGRyLCBmcm9tKSB7CiAgICBjb25zdCByZWYgPSBmcm9tLmhvc3QgKyAnOicgKyBmcm9tLnBvcnQKCiAgICBpZiAodGhpcy5fdmlzaXRlZC5nZXQocmVmKSA9PT0gMikgcmV0dXJuCiAgICB0aGlzLl92aXNpdGVkLnNldChyZWYsIDIpCgogICAgYWRkU2FtcGxlKHRoaXMuX3NhbXBsZXNIb3N0LCBhZGRyLmhvc3QsIDApCiAgICBhZGRTYW1wbGUodGhpcy5fc2FtcGxlc0Z1bGwsIGFkZHIuaG9zdCwgYWRkci5wb3J0KQoKICAgIGlmICgoKyt0aGlzLnNhbXBsZWQgPj0gMyB8fCAhdGhpcy5kaHQuZmlyZXdhbGxlZCkgJiYgIXRoaXMuZnJvemVuKSB7CiAgICAgIHRoaXMudXBkYXRlKCkKICAgIH0KCiAgICBpZiAodGhpcy5maXJld2FsbCA9PT0gRklSRVdBTEwuQ09OU0lTVEVOVCB8fCB0aGlzLmZpcmV3YWxsID09PSBGSVJFV0FMTC5PUEVOKSB7CiAgICAgIHRoaXMuX3Jlc29sdmUoKQogICAgfSBlbHNlIGlmICh0aGlzLnNhbXBsZWQgPj0gdGhpcy5fbWluU2FtcGxlcykgewogICAgICB0aGlzLl9yZXNvbHZlKCkKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGFkZFNhbXBsZShzYW1wbGVzLCBob3N0LCBwb3J0KSB7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzYW1wbGVzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBzID0gc2FtcGxlc1tpXQoKICAgIGlmIChzLnBvcnQgIT09IHBvcnQgfHwgcy5ob3N0ICE9PSBob3N0KSBjb250aW51ZQogICAgcy5oaXRzKysKCiAgICBmb3IgKDsgaSA+IDA7IGktLSkgewogICAgICBjb25zdCBwcmV2ID0gc2FtcGxlc1tpIC0gMV0KICAgICAgaWYgKHByZXYuaGl0cyA+PSBzLmhpdHMpIHJldHVybgogICAgICBzYW1wbGVzW2kgLSAxXSA9IHMKICAgICAgc2FtcGxlc1tpXSA9IHByZXYKICAgIH0KCiAgICByZXR1cm4KICB9CgogIHNhbXBsZXMucHVzaCh7CiAgICBob3N0LAogICAgcG9ydCwKICAgIGhpdHM6IDEKICB9KQp9CmNvbnN0IE5vaXNlU2VjcmV0U3RyZWFtID0gcmVxdWlyZSgnQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbScpCmNvbnN0IE5vaXNlSGFuZHNoYWtlID0gcmVxdWlyZSgnbm9pc2UtaGFuZHNoYWtlJykKY29uc3QgY3VydmUgPSByZXF1aXJlKCdub2lzZS1jdXJ2ZS1lZCcpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IG0gPSByZXF1aXJlKCcuL21lc3NhZ2VzJykKY29uc3QgeyBOUyB9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQpjb25zdCB7IEhBTkRTSEFLRV9VTkZJTklTSEVEIH0gPSByZXF1aXJlKCcuL2Vycm9ycycpCgpjb25zdCBOT0lTRV9QUk9MT1VHRSA9IE5TLlBFRVJfSEFORFNIQUtFCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIE5vaXNlV3JhcCB7CiAgY29uc3RydWN0b3Ioa2V5UGFpciwgcmVtb3RlUHVibGljS2V5KSB7CiAgICB0aGlzLmlzSW5pdGlhdG9yID0gISFyZW1vdGVQdWJsaWNLZXkKICAgIHRoaXMucmVtb3RlUHVibGljS2V5ID0gcmVtb3RlUHVibGljS2V5CiAgICB0aGlzLmtleVBhaXIgPSBrZXlQYWlyCiAgICB0aGlzLmhhbmRzaGFrZSA9IG5ldyBOb2lzZUhhbmRzaGFrZSgnSUsnLCB0aGlzLmlzSW5pdGlhdG9yLCBrZXlQYWlyLCB7IGN1cnZlIH0pCiAgICB0aGlzLmhhbmRzaGFrZS5pbml0aWFsaXNlKE5PSVNFX1BST0xPVUdFLCByZW1vdGVQdWJsaWNLZXkpCiAgfQoKICBzZW5kKHBheWxvYWQpIHsKICAgIGNvbnN0IGJ1ZiA9IGMuZW5jb2RlKG0ubm9pc2VQYXlsb2FkLCBwYXlsb2FkKQogICAgcmV0dXJuIHRoaXMuaGFuZHNoYWtlLnNlbmQoYnVmKQogIH0KCiAgcmVjdihidWYpIHsKICAgIGNvbnN0IHBheWxvYWQgPSBjLmRlY29kZShtLm5vaXNlUGF5bG9hZCwgdGhpcy5oYW5kc2hha2UucmVjdihidWYpKQogICAgdGhpcy5yZW1vdGVQdWJsaWNLZXkgPSBiNGEudG9CdWZmZXIodGhpcy5oYW5kc2hha2UucnMpCiAgICByZXR1cm4gcGF5bG9hZAogIH0KCiAgZmluYWwoKSB7CiAgICBpZiAoIXRoaXMuaGFuZHNoYWtlLmNvbXBsZXRlKSB0aHJvdyBIQU5EU0hBS0VfVU5GSU5JU0hFRCgpCgogICAgY29uc3QgaG9sZXB1bmNoU2VjcmV0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKQoKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goaG9sZXB1bmNoU2VjcmV0LCBOUy5QRUVSX0hPTEVQVU5DSCwgdGhpcy5oYW5kc2hha2UuaGFzaCkKCiAgICByZXR1cm4gewogICAgICBpc0luaXRpYXRvcjogdGhpcy5pc0luaXRpYXRvciwKICAgICAgcHVibGljS2V5OiB0aGlzLmtleVBhaXIucHVibGljS2V5LAogICAgICBzdHJlYW1JZDogdGhpcy5zdHJlYW1JZCwKICAgICAgcmVtb3RlUHVibGljS2V5OiB0aGlzLnJlbW90ZVB1YmxpY0tleSwKICAgICAgcmVtb3RlSWQ6IE5vaXNlU2VjcmV0U3RyZWFtLmlkKHRoaXMuaGFuZHNoYWtlLmhhc2gsICF0aGlzLmlzSW5pdGlhdG9yKSwKICAgICAgaG9sZXB1bmNoU2VjcmV0LAogICAgICBoYXNoOiBiNGEudG9CdWZmZXIodGhpcy5oYW5kc2hha2UuaGFzaCksCiAgICAgIHJ4OiBiNGEudG9CdWZmZXIodGhpcy5oYW5kc2hha2UucngpLAogICAgICB0eDogYjRhLnRvQnVmZmVyKHRoaXMuaGFuZHNoYWtlLnR4KQogICAgfQogIH0KfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBSZWNvcmRDYWNoZSA9IHJlcXVpcmUoJ3JlY29yZC1jYWNoZScpCmNvbnN0IENhY2hlID0gcmVxdWlyZSgneGFjaGUnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCB1bnNsYWIgPSByZXF1aXJlKCd1bnNsYWInKQoKY29uc3QgeyBlbmNvZGVVbnNsYWIgfSA9IHJlcXVpcmUoJy4vZW5jb2RlJykKY29uc3QgbSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMnKQpjb25zdCB7IE5TLCBFUlJPUiB9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKY29uc3QgRU1QVFkgPSBiNGEuYWxsb2MoMCkKY29uc3QgVE1QID0gYjRhLmFsbG9jVW5zYWZlKDMyKQpjb25zdCBNQVhfQlVNUF9EUklGVCA9IDYwXzAwMAoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBQZXJzaXN0ZW50IHsKICBjb25zdHJ1Y3RvcihkaHQsIG9wdHMpIHsKICAgIHRoaXMuZGh0ID0gZGh0CiAgICB0aGlzLnJlY29yZHMgPSBuZXcgUmVjb3JkQ2FjaGUob3B0cy5yZWNvcmRzKQogICAgdGhpcy5idW1wcyA9IG5ldyBDYWNoZShvcHRzLmJ1bXBzKQogICAgdGhpcy5yZWZyZXNoZXMgPSBuZXcgQ2FjaGUob3B0cy5yZWZyZXNoZXMpCiAgICB0aGlzLm11dGFibGVzID0gbmV3IENhY2hlKG9wdHMubXV0YWJsZXMpCiAgICB0aGlzLmltbXV0YWJsZXMgPSBuZXcgQ2FjaGUob3B0cy5pbW11dGFibGVzKQogIH0KCiAgb25sb29rdXAocmVxKSB7CiAgICBpZiAoIXJlcS50YXJnZXQpIHJldHVybgoKICAgIGNvbnN0IGsgPSBiNGEudG9TdHJpbmcocmVxLnRhcmdldCwgJ2hleCcpCiAgICBjb25zdCByZWNvcmRzID0gdGhpcy5yZWNvcmRzLmdldChrLCAyMCkKICAgIGNvbnN0IGJ1bXAgPSB0aGlzLmJ1bXBzLmdldChrKSB8fCAwCiAgICBjb25zdCBmd2QgPSB0aGlzLmRodC5fcm91dGVyLmdldChrKQoKICAgIGlmIChmd2QgJiYgcmVjb3Jkcy5sZW5ndGggPCAyMCkgcmVjb3Jkcy5wdXNoKGZ3ZC5yZWNvcmQpCgogICAgcmVxLnJlcGx5KHJlY29yZHMubGVuZ3RoID8gYy5lbmNvZGUobS5sb29rdXBSYXdSZXBseSwgeyBwZWVyczogcmVjb3JkcywgYnVtcCB9KSA6IG51bGwpCiAgfQoKICBvbmZpbmRwZWVyKHJlcSkgewogICAgaWYgKCFyZXEudGFyZ2V0KSByZXR1cm4KICAgIGNvbnN0IGZ3ZCA9IHRoaXMuZGh0Ll9yb3V0ZXIuZ2V0KHJlcS50YXJnZXQpCiAgICByZXEucmVwbHkoZndkID8gZndkLnJlY29yZCA6IG51bGwpCiAgfQoKICB1bmFubm91bmNlKHRhcmdldCwgcHVibGljS2V5KSB7CiAgICBjb25zdCBrID0gYjRhLnRvU3RyaW5nKHRhcmdldCwgJ2hleCcpCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKFRNUCwgcHVibGljS2V5KQoKICAgIGlmIChiNGEuZXF1YWxzKFRNUCwgdGFyZ2V0KSkgdGhpcy5kaHQuX3JvdXRlci5kZWxldGUoaykKICAgIHRoaXMucmVjb3Jkcy5yZW1vdmUoaywgcHVibGljS2V5KQogIH0KCiAgb251bmFubm91bmNlKHJlcSkgewogICAgaWYgKCFyZXEudGFyZ2V0IHx8ICFyZXEudG9rZW4pIHJldHVybgoKICAgIGNvbnN0IHVuYW5uID0gZGVjb2RlKG0uYW5ub3VuY2UsIHJlcS52YWx1ZSkKICAgIGlmICh1bmFubiA9PT0gbnVsbCkgcmV0dXJuCgogICAgY29uc3QgeyBwZWVyLCBzaWduYXR1cmUgfSA9IHVuYW5uCiAgICBpZiAoIXBlZXIgfHwgIXNpZ25hdHVyZSkgcmV0dXJuCgogICAgY29uc3Qgc2lnbmFibGUgPSBhbm5TaWduYWJsZShyZXEudGFyZ2V0LCByZXEudG9rZW4sIHRoaXMuZGh0LmlkLCB1bmFubiwgTlMuVU5BTk5PVU5DRSkKCiAgICBpZiAoIXNvZGl1bS5jcnlwdG9fc2lnbl92ZXJpZnlfZGV0YWNoZWQoc2lnbmF0dXJlLCBzaWduYWJsZSwgcGVlci5wdWJsaWNLZXkpKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMudW5hbm5vdW5jZShyZXEudGFyZ2V0LCBwZWVyLnB1YmxpY0tleSkKICAgIHJlcS5yZXBseShudWxsLCB7IHRva2VuOiBmYWxzZSwgY2xvc2VyTm9kZXM6IGZhbHNlIH0pCiAgfQoKICBfb25yZWZyZXNoKHRva2VuLCByZXEpIHsKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goVE1QLCB0b2tlbikKICAgIGNvbnN0IGFjdGl2ZVJlZnJlc2ggPSBiNGEudG9TdHJpbmcoVE1QLCAnaGV4JykKCiAgICBjb25zdCByID0gdGhpcy5yZWZyZXNoZXMuZ2V0KGFjdGl2ZVJlZnJlc2gpCiAgICBpZiAoIXIpIHJldHVybgoKICAgIGNvbnN0IHsgYW5ub3VuY2VTZWxmLCBrLCByZWNvcmQgfSA9IHIKICAgIGNvbnN0IHB1YmxpY0tleSA9IHJlY29yZC5zdWJhcnJheSgwLCAzMikKCiAgICBpZiAoYW5ub3VuY2VTZWxmKSB7CiAgICAgIHRoaXMuZGh0Ll9yb3V0ZXIuc2V0KGssIHsKICAgICAgICByZWxheTogcmVxLmZyb20sCiAgICAgICAgcmVjb3JkLAogICAgICAgIG9uY29ubmVjdDogbnVsbCwKICAgICAgICBvbmhvbGVwdW5jaDogbnVsbAogICAgICB9KQogICAgICB0aGlzLnJlY29yZHMucmVtb3ZlKGssIHB1YmxpY0tleSkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucmVjb3Jkcy5hZGQoaywgcHVibGljS2V5LCByZWNvcmQpCiAgICB9CgogICAgdGhpcy5yZWZyZXNoZXMuZGVsZXRlKGFjdGl2ZVJlZnJlc2gpCiAgICB0aGlzLnJlZnJlc2hlcy5zZXQoYjRhLnRvU3RyaW5nKHRva2VuLCAnaGV4JyksIHIpCgogICAgcmVxLnJlcGx5KG51bGwsIHsgdG9rZW46IGZhbHNlLCBjbG9zZXJOb2RlczogZmFsc2UgfSkKICB9CgogIG9uYW5ub3VuY2UocmVxKSB7CiAgICBpZiAoIXJlcS50YXJnZXQgfHwgIXJlcS50b2tlbiB8fCAhdGhpcy5kaHQuaWQpIHJldHVybgoKICAgIGNvbnN0IGFubiA9IGRlY29kZShtLmFubm91bmNlLCByZXEudmFsdWUpCiAgICBpZiAoYW5uID09PSBudWxsKSByZXR1cm4KCiAgICBjb25zdCBzaWduYWJsZSA9IGFublNpZ25hYmxlKHJlcS50YXJnZXQsIHJlcS50b2tlbiwgdGhpcy5kaHQuaWQsIGFubiwgTlMuQU5OT1VOQ0UpCiAgICBjb25zdCB7IHBlZXIsIHJlZnJlc2gsIHNpZ25hdHVyZSwgYnVtcCB9ID0gYW5uCgogICAgaWYgKCFwZWVyKSB7CiAgICAgIGlmICghcmVmcmVzaCkgcmV0dXJuCiAgICAgIHRoaXMuX29ucmVmcmVzaChyZWZyZXNoLCByZXEpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICghc2lnbmF0dXJlIHx8ICFzb2RpdW0uY3J5cHRvX3NpZ25fdmVyaWZ5X2RldGFjaGVkKHNpZ25hdHVyZSwgc2lnbmFibGUsIHBlZXIucHVibGljS2V5KSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICAvLyBUT0RPOiBpdCB3b3VsZCBiZSBwb3RlbnRpYWxseSBiZSBtb3JlIG9wdGltYWwgdG8gYWxsb3cgbW9yZSB0aGFuIDMgYWRkcmVzc2VzIGhlcmUgZm9yIGEgZmluZFBlZXIgcmVzcG9uc2UKICAgIC8vIGFuZCBvbmx5IHVzZSBtYXggMyBmb3IgYSBsb29rdXAgcmVwbHkKICAgIGlmIChwZWVyLnJlbGF5QWRkcmVzc2VzLmxlbmd0aCA+IDMpIHsKICAgICAgcGVlci5yZWxheUFkZHJlc3NlcyA9IHBlZXIucmVsYXlBZGRyZXNzZXMuc2xpY2UoMCwgMykKICAgIH0KCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKFRNUCwgcGVlci5wdWJsaWNLZXkpCgogICAgY29uc3QgayA9IGI0YS50b1N0cmluZyhyZXEudGFyZ2V0LCAnaGV4JykKICAgIGNvbnN0IGFubm91bmNlU2VsZiA9IGI0YS5lcXVhbHMoVE1QLCByZXEudGFyZ2V0KQogICAgY29uc3QgcmVjb3JkID0gZW5jb2RlVW5zbGFiKG0ucGVlciwgcGVlcikKCiAgICBpZiAoYW5ub3VuY2VTZWxmKSB7CiAgICAgIHRoaXMuZGh0Ll9yb3V0ZXIuc2V0KGssIHsKICAgICAgICByZWxheTogcmVxLmZyb20sCiAgICAgICAgcmVjb3JkLAogICAgICAgIG9uY29ubmVjdDogbnVsbCwKICAgICAgICBvbmhvbGVwdW5jaDogbnVsbAogICAgICB9KQogICAgICB0aGlzLnJlY29yZHMucmVtb3ZlKGssIHBlZXIucHVibGljS2V5KQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgY3VycmVudEJ1bXAgPSB0aGlzLmJ1bXBzLmdldChrKSB8fCAwCiAgICAgIGlmIChidW1wID4gY3VycmVudEJ1bXAgJiYgYnVtcCA8PSBEYXRlLm5vdygpICsgTUFYX0JVTVBfRFJJRlQpIHRoaXMuYnVtcHMuc2V0KGssIGJ1bXApCiAgICAgIHRoaXMucmVjb3Jkcy5hZGQoaywgcGVlci5wdWJsaWNLZXksIHJlY29yZCkKICAgIH0KCiAgICBpZiAocmVmcmVzaCkgewogICAgICB0aGlzLnJlZnJlc2hlcy5zZXQoYjRhLnRvU3RyaW5nKHJlZnJlc2gsICdoZXgnKSwgeyBrLCByZWNvcmQsIGFubm91bmNlU2VsZiB9KQogICAgfQoKICAgIHJlcS5yZXBseShudWxsLCB7IHRva2VuOiBmYWxzZSwgY2xvc2VyTm9kZXM6IGZhbHNlIH0pCiAgfQoKICBvbm11dGFibGVnZXQocmVxKSB7CiAgICBpZiAoIXJlcS50YXJnZXQgfHwgIXJlcS52YWx1ZSkgcmV0dXJuCgogICAgbGV0IHNlcSA9IDAKICAgIHRyeSB7CiAgICAgIHNlcSA9IGMuZGVjb2RlKGMudWludCwgcmVxLnZhbHVlKQogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IGsgPSBiNGEudG9TdHJpbmcocmVxLnRhcmdldCwgJ2hleCcpCiAgICBjb25zdCB2YWx1ZSA9IHRoaXMubXV0YWJsZXMuZ2V0KGspCgogICAgaWYgKCF2YWx1ZSkgewogICAgICByZXEucmVwbHkobnVsbCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgbG9jYWxTZXEgPSBjLmRlY29kZShjLnVpbnQsIHZhbHVlKQogICAgcmVxLnJlcGx5KGxvY2FsU2VxIDwgc2VxID8gbnVsbCA6IHZhbHVlKQogIH0KCiAgb25tdXRhYmxlcHV0KHJlcSkgewogICAgaWYgKCFyZXEudGFyZ2V0IHx8ICFyZXEudG9rZW4gfHwgIXJlcS52YWx1ZSkgcmV0dXJuCgogICAgY29uc3QgcCA9IGRlY29kZShtLm11dGFibGVQdXRSZXF1ZXN0LCByZXEudmFsdWUpCiAgICBpZiAoIXApIHJldHVybgoKICAgIGNvbnN0IHsgcHVibGljS2V5LCBzZXEsIHZhbHVlLCBzaWduYXR1cmUgfSA9IHAKCiAgICBjb25zdCBoYXNoID0gYjRhLmFsbG9jVW5zYWZlKDMyKQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChoYXNoLCBwdWJsaWNLZXkpCiAgICBpZiAoIWI0YS5lcXVhbHMoaGFzaCwgcmVxLnRhcmdldCkpIHJldHVybgoKICAgIGlmICghdmFsdWUgfHwgIXZlcmlmeU11dGFibGUoc2lnbmF0dXJlLCBzZXEsIHZhbHVlLCBwdWJsaWNLZXkpKSByZXR1cm4KCiAgICBjb25zdCBrID0gYjRhLnRvU3RyaW5nKGhhc2gsICdoZXgnKQogICAgY29uc3QgbG9jYWwgPSB0aGlzLm11dGFibGVzLmdldChrKQoKICAgIGlmIChsb2NhbCkgewogICAgICBjb25zdCBleGlzdGluZyA9IGMuZGVjb2RlKG0ubXV0YWJsZUdldFJlc3BvbnNlLCBsb2NhbCkKICAgICAgaWYgKGV4aXN0aW5nLnZhbHVlICYmIGV4aXN0aW5nLnNlcSA9PT0gc2VxICYmIGI0YS5jb21wYXJlKHZhbHVlLCBleGlzdGluZy52YWx1ZSkgIT09IDApIHsKICAgICAgICByZXEuZXJyb3IoRVJST1IuU0VRX1JFVVNFRCkKICAgICAgICByZXR1cm4KICAgICAgfQogICAgICBpZiAoc2VxIDwgZXhpc3Rpbmcuc2VxKSB7CiAgICAgICAgcmVxLmVycm9yKEVSUk9SLlNFUV9UT09fTE9XKQogICAgICAgIHJldHVybgogICAgICB9CiAgICB9CgogICAgdGhpcy5tdXRhYmxlcy5zZXQoaywgZW5jb2RlVW5zbGFiKG0ubXV0YWJsZUdldFJlc3BvbnNlLCB7IHNlcSwgdmFsdWUsIHNpZ25hdHVyZSB9KSkKICAgIHJlcS5yZXBseShudWxsKQogIH0KCiAgb25pbW11dGFibGVnZXQocmVxKSB7CiAgICBpZiAoIXJlcS50YXJnZXQpIHJldHVybgoKICAgIGNvbnN0IGsgPSBiNGEudG9TdHJpbmcocmVxLnRhcmdldCwgJ2hleCcpCiAgICBjb25zdCB2YWx1ZSA9IHRoaXMuaW1tdXRhYmxlcy5nZXQoaykKCiAgICByZXEucmVwbHkodmFsdWUgfHwgbnVsbCkKICB9CgogIG9uaW1tdXRhYmxlcHV0KHJlcSkgewogICAgaWYgKCFyZXEudGFyZ2V0IHx8ICFyZXEudG9rZW4gfHwgIXJlcS52YWx1ZSkgcmV0dXJuCgogICAgY29uc3QgaGFzaCA9IGI0YS5hbGxvYygzMikKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goaGFzaCwgcmVxLnZhbHVlKQogICAgaWYgKCFiNGEuZXF1YWxzKGhhc2gsIHJlcS50YXJnZXQpKSByZXR1cm4KCiAgICBjb25zdCBrID0gYjRhLnRvU3RyaW5nKGhhc2gsICdoZXgnKQogICAgdGhpcy5pbW11dGFibGVzLnNldChrLCB1bnNsYWIocmVxLnZhbHVlKSkKCiAgICByZXEucmVwbHkobnVsbCkKICB9CgogIGRlc3Ryb3koKSB7CiAgICB0aGlzLnJlY29yZHMuZGVzdHJveSgpCiAgICB0aGlzLnJlZnJlc2hlcy5kZXN0cm95KCkKICAgIHRoaXMubXV0YWJsZXMuZGVzdHJveSgpCiAgICB0aGlzLmltbXV0YWJsZXMuZGVzdHJveSgpCiAgfQoKICBzdGF0aWMgc2lnbk11dGFibGUoc2VxLCB2YWx1ZSwga2V5UGFpcikgewogICAgY29uc3Qgc2lnbmFibGUgPSBiNGEuYWxsb2NVbnNhZmUoMzIgKyAzMikKICAgIGNvbnN0IGhhc2ggPSBzaWduYWJsZS5zdWJhcnJheSgzMikKCiAgICBzaWduYWJsZS5zZXQoTlMuTVVUQUJMRV9QVVQsIDApCgogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChoYXNoLCBjLmVuY29kZShtLm11dGFibGVTaWduYWJsZSwgeyBzZXEsIHZhbHVlIH0pKQogICAgcmV0dXJuIHNpZ24oc2lnbmFibGUsIGtleVBhaXIpCiAgfQoKICBzdGF0aWMgdmVyaWZ5TXV0YWJsZShzaWduYXR1cmUsIHNlcSwgdmFsdWUsIHB1YmxpY0tleSkgewogICAgcmV0dXJuIHZlcmlmeU11dGFibGUoc2lnbmF0dXJlLCBzZXEsIHZhbHVlLCBwdWJsaWNLZXkpCiAgfQoKICBzdGF0aWMgc2lnbkFubm91bmNlKHRhcmdldCwgdG9rZW4sIGlkLCBhbm4sIGtleVBhaXIpIHsKICAgIHJldHVybiBzaWduKGFublNpZ25hYmxlKHRhcmdldCwgdG9rZW4sIGlkLCBhbm4sIE5TLkFOTk9VTkNFKSwga2V5UGFpcikKICB9CgogIHN0YXRpYyBzaWduVW5hbm5vdW5jZSh0YXJnZXQsIHRva2VuLCBpZCwgYW5uLCBrZXlQYWlyKSB7CiAgICByZXR1cm4gc2lnbihhbm5TaWduYWJsZSh0YXJnZXQsIHRva2VuLCBpZCwgYW5uLCBOUy5VTkFOTk9VTkNFKSwga2V5UGFpcikKICB9Cn0KCmZ1bmN0aW9uIHZlcmlmeU11dGFibGUoc2lnbmF0dXJlLCBzZXEsIHZhbHVlLCBwdWJsaWNLZXkpIHsKICBjb25zdCBzaWduYWJsZSA9IGI0YS5hbGxvY1Vuc2FmZSgzMiArIDMyKQogIGNvbnN0IGhhc2ggPSBzaWduYWJsZS5zdWJhcnJheSgzMikKCiAgc2lnbmFibGUuc2V0KE5TLk1VVEFCTEVfUFVULCAwKQoKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGhhc2gsIGMuZW5jb2RlKG0ubXV0YWJsZVNpZ25hYmxlLCB7IHNlcSwgdmFsdWUgfSkpCiAgcmV0dXJuIHNvZGl1bS5jcnlwdG9fc2lnbl92ZXJpZnlfZGV0YWNoZWQoc2lnbmF0dXJlLCBzaWduYWJsZSwgcHVibGljS2V5KQp9CgpmdW5jdGlvbiBhbm5TaWduYWJsZSh0YXJnZXQsIHRva2VuLCBpZCwgYW5uLCBucykgewogIGNvbnN0IHNpZ25hYmxlID0gYjRhLmFsbG9jVW5zYWZlKDMyICsgMzIpCiAgY29uc3QgaGFzaCA9IHNpZ25hYmxlLnN1YmFycmF5KDMyKQoKICBzaWduYWJsZS5zZXQobnMsIDApCgogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2goaGFzaCwgWwogICAgdGFyZ2V0LAogICAgaWQsCiAgICB0b2tlbiwKICAgIGMuZW5jb2RlKG0ucGVlciwgYW5uLnBlZXIpLCAvLyBub3RlIHRoYXQgdGhpcyBpcyB0aGUgcGFydGlhbCBlbmNvZGluZyBvZiB0aGUgYW5ub3VuY2UgbWVzc2FnZSBzbyB3ZSBjb3VsZCBqdXN0IHVzZSB0aGF0IGZvciBwZXJmCiAgICBhbm4ucmVmcmVzaCB8fCBFTVBUWQogIF0pCgogIHJldHVybiBzaWduYWJsZQp9CgpmdW5jdGlvbiBzaWduKHNpZ25hYmxlLCBrZXlQYWlyKSB7CiAgaWYgKGtleVBhaXIuc2lnbikgewogICAgcmV0dXJuIGtleVBhaXIuc2lnbihzaWduYWJsZSkKICB9CiAgY29uc3Qgc2VjcmV0S2V5ID0ga2V5UGFpci5zZWNyZXRLZXkgPyBrZXlQYWlyLnNlY3JldEtleSA6IGtleVBhaXIKICBjb25zdCBzaWduYXR1cmUgPSBiNGEuYWxsb2NVbnNhZmUoNjQpCiAgc29kaXVtLmNyeXB0b19zaWduX2RldGFjaGVkKHNpZ25hdHVyZSwgc2lnbmFibGUsIHNlY3JldEtleSkKICByZXR1cm4gc2lnbmF0dXJlCn0KCmZ1bmN0aW9uIGRlY29kZShlbmMsIHZhbCkgewogIHRyeSB7CiAgICByZXR1cm4gdmFsICYmIGMuZGVjb2RlKGVuYywgdmFsKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIG51bGwKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSYXdTdHJlYW1TZXQgewogIGNvbnN0cnVjdG9yKGRodCkgewogICAgdGhpcy5fZGh0ID0gZGh0CgogICAgdGhpcy5fcHJlZml4ID0gMTYgLSAxIC8vIDE2IGlzIHRoZSBkZWZhdWx0IHN0cmVhbS1zZXQgc2lkZSBpbiB1ZHgKICAgIHRoaXMuX3N0cmVhbXMgPSBuZXcgTWFwKCkKICB9CgogIGdldCBzaXplKCkgewogICAgcmV0dXJuIHRoaXMuX3N0cmVhbXMuc2l6ZQogIH0KCiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy5fc3RyZWFtcy52YWx1ZXMoKQogIH0KCiAgYWRkKG9wdHMpIHsKICAgIGNvbnN0IHNlbGYgPSB0aGlzCgogICAgLy8gVE9ETzogd2Ugc2hvdWxkIHByb2IgaGF2ZSBhIHVkeCBoZWxwZXIgZm9yIGlkIGdlbmVyYXRpb24sIGdpdmVuIHRoZSBzbGlnaHQgY29tcGxleGl0eQogICAgLy8gb2YgdGhlIGJlbG93LiByZXF1aXJlcyBhIFBSTkcgaW4gdWR4IHRoby4KCiAgICBsZXQgaWQgPSAwCgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWQgPSAoTWF0aC5yYW5kb20oKSAqIDB4MTAwMDAwMDAwKSA+Pj4gMAoKICAgICAgaWYgKHRoaXMuX3N0cmVhbXMuaGFzKGlkICYgdGhpcy5fcHJlZml4KSkgY29udGludWUKICAgICAgYnJlYWsKICAgIH0KCiAgICAvLyBhbHdheXMgaGF2ZSB+NTAlIGNoYW5nZSBvZiByb2xsaW5nIGEgZnJlZSBvbmUKICAgIGlmICgyICogdGhpcy5fc3RyZWFtcy5zaXplID49IHRoaXMuX3ByZWZpeCkgewogICAgICAvLyBpZSAwYjExMTExID0gMGIxMTExICsgMSArIDBiMTExMQogICAgICB0aGlzLl9wcmVmaXggPSAyICogdGhpcy5fcHJlZml4ICsgMQoKICAgICAgLy8gbW92ZSB0aGUgcHJlZml4ZXMgb3ZlcgogICAgICBjb25zdCBuZXh0ID0gbmV3IE1hcCgpCiAgICAgIGZvciAoY29uc3Qgc3RyZWFtIG9mIHRoaXMuX3N0cmVhbXMudmFsdWVzKCkpIHsKICAgICAgICBuZXh0LnNldChzdHJlYW0uaWQgJiB0aGlzLl9wcmVmaXgsIHN0cmVhbSkKICAgICAgfQogICAgICB0aGlzLl9zdHJlYW1zID0gbmV4dAogICAgfQoKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuX2RodC51ZHguY3JlYXRlU3RyZWFtKGlkLCBvcHRzKQogICAgdGhpcy5fc3RyZWFtcy5zZXQoaWQgJiB0aGlzLl9wcmVmaXgsIHN0cmVhbSkKCiAgICBzdHJlYW0ub24oJ2Nsb3NlJywgb25jbG9zZSkKCiAgICByZXR1cm4gc3RyZWFtCgogICAgZnVuY3Rpb24gb25jbG9zZSgpIHsKICAgICAgc2VsZi5fc3RyZWFtcy5kZWxldGUoaWQgJiBzZWxmLl9wcmVmaXgpCiAgICB9CiAgfQoKICBhc3luYyBjbGVhcigpIHsKICAgIGNvbnN0IGRlc3Ryb3lpbmcgPSBbXQoKICAgIGZvciAoY29uc3Qgc3RyZWFtIG9mIHRoaXMuX3N0cmVhbXMudmFsdWVzKCkpIHsKICAgICAgZGVzdHJveWluZy5wdXNoKG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzdHJlYW0ub25jZSgnY2xvc2UnLCByZXNvbHZlKS5kZXN0cm95KCkpKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChkZXN0cm95aW5nKQogIH0KfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IENhY2hlID0gcmVxdWlyZSgneGFjaGUnKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHsgaGFuZHNoYWtlLCBob2xlcHVuY2ggfSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMnKQpjb25zdCB7IENPTU1BTkRTIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCmNvbnN0IHsgQkFEX0hBTkRTSEFLRV9SRVBMWSwgQkFEX0hPTEVQVU5DSF9SRVBMWSB9ID0gcmVxdWlyZSgnLi9lcnJvcnMnKQoKY29uc3QgRlJPTV9DTElFTlQgPSAwCmNvbnN0IEZST01fU0VSVkVSID0gMQpjb25zdCBGUk9NX1JFTEFZID0gMgpjb25zdCBGUk9NX1NFQ09ORF9SRUxBWSA9IDMKY29uc3QgUkVQTFkgPSA0CgovLyBUT0RPOiBXaGlsZSB0aGUgY3VycmVudCBkZXNpZ24gaXMgdmVyeSB0cnVzdGxlc3MgaW4gcmVnYXJkcyB0byBjbGllbnRzL3NlcnZlcnMgdHJ1c3RpbmcgdGhlIERIVCwKLy8gd2Ugc2hvdWxkIGFkZCBhIGJ1bmNoIG9mIHJhdGUgbGltaXRzIGV2ZXJ5d2hlcmUsIGVzcGVjaWFsbHkgaW5jbHVkaW5nIGhlcmUgdG8gYXZvaWQgYmFkIHVzZXJzCi8vIHVzaW5nIGEgREhUIG5vZGUgdG8gcmVsYXkgdHJhZmZpYyBpbmRpc2NyaW1pbmF0ZWx5IHVzaW5nIHRoZSBjb25uZWN0L2hvbGVwdW5jaCBtZXNzYWdlcy4KLy8gVGhhdCdzIG1vc3RseSBmcm9tIGFuIGFidXNlIFBPViBhcyBub25lIG9mIHRoZSBtZXNzc2FnZXMgZG8gYW1wbGljYXRpb24uCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJvdXRlciB7CiAgY29uc3RydWN0b3IoZGh0LCBvcHRzKSB7CiAgICB0aGlzLmRodCA9IGRodAogICAgdGhpcy5mb3J3YXJkcyA9IG5ldyBDYWNoZShvcHRzLmZvcndhcmRzKQogIH0KCiAgc2V0KHRhcmdldCwgc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5vbnBlZXJoYW5kc2hha2UpIHsKICAgICAgdGhpcy5mb3J3YXJkcy5yZXRhaW4odG9TdHJpbmcodGFyZ2V0KSwgc3RhdGUpCiAgICB9IGVsc2UgewogICAgICB0aGlzLmZvcndhcmRzLnNldCh0b1N0cmluZyh0YXJnZXQpLCBzdGF0ZSkKICAgIH0KICB9CgogIGdldCh0YXJnZXQpIHsKICAgIHJldHVybiB0aGlzLmZvcndhcmRzLmdldCh0b1N0cmluZyh0YXJnZXQpKQogIH0KCiAgZGVsZXRlKHRhcmdldCkgewogICAgdGhpcy5mb3J3YXJkcy5kZWxldGUodG9TdHJpbmcodGFyZ2V0KSkKICB9CgogIGRlc3Ryb3koKSB7CiAgICB0aGlzLmZvcndhcmRzLmRlc3Ryb3koKQogIH0KCiAgYXN5bmMgcGVlckhhbmRzaGFrZSh0YXJnZXQsIHsgbm9pc2UsIHBlZXJBZGRyZXNzLCByZWxheUFkZHJlc3MsIHNvY2tldCwgc2Vzc2lvbiB9LCB0bykgewogICAgY29uc3QgZGh0ID0gdGhpcy5kaHQKCiAgICBjb25zdCByZXF1ZXN0VmFsdWUgPSBjLmVuY29kZShoYW5kc2hha2UsIHsKICAgICAgbW9kZTogRlJPTV9DTElFTlQsCiAgICAgIG5vaXNlLAogICAgICBwZWVyQWRkcmVzcywKICAgICAgcmVsYXlBZGRyZXNzCiAgICB9KQoKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGRodC5yZXF1ZXN0KAogICAgICB7IGNvbW1hbmQ6IENPTU1BTkRTLlBFRVJfSEFORFNIQUtFLCB0YXJnZXQsIHZhbHVlOiByZXF1ZXN0VmFsdWUgfSwKICAgICAgdG8sCiAgICAgIHsgc29ja2V0LCBzZXNzaW9uIH0KICAgICkKCiAgICBjb25zdCBocyA9IGRlY29kZShoYW5kc2hha2UsIHJlcy52YWx1ZSkKICAgIGlmICgKICAgICAgIWhzIHx8CiAgICAgIGhzLm1vZGUgIT09IFJFUExZIHx8CiAgICAgIHRvLmhvc3QgIT09IHJlcy5mcm9tLmhvc3QgfHwKICAgICAgdG8ucG9ydCAhPT0gcmVzLmZyb20ucG9ydCB8fAogICAgICAhaHMubm9pc2UKICAgICkgewogICAgICB0aHJvdyBCQURfSEFORFNIQUtFX1JFUExZKCkKICAgIH0KCiAgICByZXR1cm4gewogICAgICBub2lzZTogaHMubm9pc2UsCiAgICAgIHJlbGF5ZWQ6ICEhaHMucGVlckFkZHJlc3MsCiAgICAgIHNlcnZlckFkZHJlc3M6IGhzLnBlZXJBZGRyZXNzIHx8IHRvLAogICAgICBjbGllbnRBZGRyZXNzOiByZXMudG8KICAgIH0KICB9CgogIGFzeW5jIG9ucGVlcmhhbmRzaGFrZShyZXEpIHsKICAgIGNvbnN0IGhzID0gcmVxLnZhbHVlICYmIGRlY29kZShoYW5kc2hha2UsIHJlcS52YWx1ZSkKICAgIGlmICghaHMpIHJldHVybgoKICAgIGNvbnN0IHsgbW9kZSwgbm9pc2UsIHBlZXJBZGRyZXNzLCByZWxheUFkZHJlc3MgfSA9IGhzCgogICAgY29uc3Qgc3RhdGUgPSByZXEudGFyZ2V0ICYmIHRoaXMuZ2V0KHJlcS50YXJnZXQpCiAgICBjb25zdCBpc1NlcnZlciA9ICEhKHN0YXRlICYmIHN0YXRlLm9ucGVlcmhhbmRzaGFrZSkKICAgIGNvbnN0IHJlbGF5ID0gc3RhdGUgJiYgc3RhdGUucmVsYXkKCiAgICBpZiAoaXNTZXJ2ZXIpIHsKICAgICAgbGV0IHJlcGx5ID0gbnVsbAogICAgICB0cnkgewogICAgICAgIHJlcGx5ID0gbm9pc2UgJiYgKGF3YWl0IHN0YXRlLm9ucGVlcmhhbmRzaGFrZSh7IG5vaXNlLCBwZWVyQWRkcmVzcyB9LCByZXEpKQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgc2FmZXR5Q2F0Y2goZSkKICAgICAgICByZXR1cm4KICAgICAgfQogICAgICBpZiAoIXJlcGx5IHx8ICFyZXBseS5ub2lzZSkgcmV0dXJuCiAgICAgIGNvbnN0IG9wdHMgPSB7IHNvY2tldDogcmVwbHkuc29ja2V0LCBjbG9zZXJOb2RlczogZmFsc2UsIHRva2VuOiBmYWxzZSB9CgogICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICBjYXNlIEZST01fQ0xJRU5UOiB7CiAgICAgICAgICByZXEucmVwbHkoCiAgICAgICAgICAgIGMuZW5jb2RlKGhhbmRzaGFrZSwgeyBtb2RlOiBSRVBMWSwgbm9pc2U6IHJlcGx5Lm5vaXNlLCBwZWVyQWRkcmVzczogbnVsbCB9KSwKICAgICAgICAgICAgb3B0cwogICAgICAgICAgKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIGNhc2UgRlJPTV9SRUxBWTogewogICAgICAgICAgcmVxLnJlbGF5KAogICAgICAgICAgICBjLmVuY29kZShoYW5kc2hha2UsIHsgbW9kZTogRlJPTV9TRVJWRVIsIG5vaXNlOiByZXBseS5ub2lzZSwgcGVlckFkZHJlc3MgfSksCiAgICAgICAgICAgIHJlcS5mcm9tLAogICAgICAgICAgICBvcHRzCiAgICAgICAgICApCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgY2FzZSBGUk9NX1NFQ09ORF9SRUxBWTogewogICAgICAgICAgaWYgKCFyZWxheUFkZHJlc3MpIHJldHVybgogICAgICAgICAgcmVxLnJlbGF5KAogICAgICAgICAgICBjLmVuY29kZShoYW5kc2hha2UsIHsgbW9kZTogRlJPTV9TRVJWRVIsIG5vaXNlOiByZXBseS5ub2lzZSwgcGVlckFkZHJlc3MgfSksCiAgICAgICAgICAgIHJlbGF5QWRkcmVzcywKICAgICAgICAgICAgb3B0cwogICAgICAgICAgKQogICAgICAgICAgcmV0dXJuIC8vIGVzbGludC1kaXNhYmxlLWxpbmUKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHN3aXRjaCAobW9kZSkgewogICAgICAgIGNhc2UgRlJPTV9DTElFTlQ6IHsKICAgICAgICAgIC8vIFRPRE86IGlmIG5vIHJlbGF5IGlzIGtub3duIHJvdXRlIGNsb3NlciB0byB0aGUgdGFyZ2V0IGluc3RlYWQgb2YgdGltaW5nIG91dAogICAgICAgICAgaWYgKCFub2lzZSkgcmV0dXJuCiAgICAgICAgICBpZiAoIXJlbGF5ICYmICFyZWxheUFkZHJlc3MpIHsKICAgICAgICAgICAgLy8gaGVscCB0aGUgdXNlciByb3V0ZQogICAgICAgICAgICByZXEucmVwbHkobnVsbCwgeyB0b2tlbjogZmFsc2UsIGNsb3Nlck5vZGVzOiB0cnVlIH0pCiAgICAgICAgICAgIHJldHVybgogICAgICAgICAgfQogICAgICAgICAgcmVxLnJlbGF5KAogICAgICAgICAgICBjLmVuY29kZShoYW5kc2hha2UsIHsKICAgICAgICAgICAgICBtb2RlOiBGUk9NX1JFTEFZLAogICAgICAgICAgICAgIG5vaXNlLAogICAgICAgICAgICAgIHBlZXJBZGRyZXNzOiByZXEuZnJvbSwKICAgICAgICAgICAgICByZWxheUFkZHJlc3M6IG51bGwKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIHJlbGF5QWRkcmVzcyB8fCByZWxheQogICAgICAgICAgKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIGNhc2UgRlJPTV9SRUxBWTogewogICAgICAgICAgaWYgKCFyZWxheSB8fCAhbm9pc2UpIHJldHVybgogICAgICAgICAgcmVxLnJlbGF5KAogICAgICAgICAgICBjLmVuY29kZShoYW5kc2hha2UsIHsKICAgICAgICAgICAgICBtb2RlOiBGUk9NX1NFQ09ORF9SRUxBWSwKICAgICAgICAgICAgICBub2lzZSwKICAgICAgICAgICAgICBwZWVyQWRkcmVzcywKICAgICAgICAgICAgICByZWxheUFkZHJlc3M6IHJlcS5mcm9tCiAgICAgICAgICAgIH0pLAogICAgICAgICAgICByZWxheQogICAgICAgICAgKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIGNhc2UgRlJPTV9TRVJWRVI6IHsKICAgICAgICAgIGlmICghcGVlckFkZHJlc3MgfHwgIW5vaXNlKSByZXR1cm4KICAgICAgICAgIHJlcS5yZXBseSgKICAgICAgICAgICAgYy5lbmNvZGUoaGFuZHNoYWtlLCB7IG1vZGU6IFJFUExZLCBub2lzZSwgcGVlckFkZHJlc3M6IHJlcS5mcm9tLCByZWxheUFkZHJlc3M6IG51bGwgfSksCiAgICAgICAgICAgIHsgdG86IHBlZXJBZGRyZXNzLCBjbG9zZXJOb2RlczogZmFsc2UsIHRva2VuOiBmYWxzZSB9CiAgICAgICAgICApCiAgICAgICAgICByZXR1cm4gLy8gZXNsaW50LWRpc2FibGUtbGluZQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgcGVlckhvbGVwdW5jaCh0YXJnZXQsIHsgaWQsIHBheWxvYWQsIHBlZXJBZGRyZXNzLCBzb2NrZXQsIHNlc3Npb24gfSwgdG8pIHsKICAgIGNvbnN0IGRodCA9IHRoaXMuZGh0CiAgICBjb25zdCByZXF1ZXN0VmFsdWUgPSBjLmVuY29kZShob2xlcHVuY2gsIHsKICAgICAgbW9kZTogRlJPTV9DTElFTlQsCiAgICAgIGlkLAogICAgICBwYXlsb2FkLAogICAgICBwZWVyQWRkcmVzcwogICAgfSkKCiAgICBjb25zdCByZXMgPSBhd2FpdCBkaHQucmVxdWVzdCgKICAgICAgeyBjb21tYW5kOiBDT01NQU5EUy5QRUVSX0hPTEVQVU5DSCwgdGFyZ2V0LCB2YWx1ZTogcmVxdWVzdFZhbHVlIH0sCiAgICAgIHRvLAogICAgICB7IHNvY2tldCwgc2Vzc2lvbiB9CiAgICApCgogICAgY29uc3QgaHAgPSBkZWNvZGUoaG9sZXB1bmNoLCByZXMudmFsdWUpCiAgICBpZiAoIWhwIHx8IGhwLm1vZGUgIT09IFJFUExZIHx8IHRvLmhvc3QgIT09IHJlcy5mcm9tLmhvc3QgfHwgdG8ucG9ydCAhPT0gcmVzLmZyb20ucG9ydCkgewogICAgICB0aHJvdyBCQURfSE9MRVBVTkNIX1JFUExZKCkKICAgIH0KCiAgICByZXR1cm4gewogICAgICBmcm9tOiByZXMuZnJvbSwKICAgICAgdG86IHJlcy50bywKICAgICAgcGF5bG9hZDogaHAucGF5bG9hZCwKICAgICAgcGVlckFkZHJlc3M6IGhwLnBlZXJBZGRyZXNzIHx8IHRvCiAgICB9CiAgfQoKICBhc3luYyBvbnBlZXJob2xlcHVuY2gocmVxKSB7CiAgICBjb25zdCBocCA9IHJlcS52YWx1ZSAmJiBkZWNvZGUoaG9sZXB1bmNoLCByZXEudmFsdWUpCiAgICBpZiAoIWhwKSByZXR1cm4KCiAgICBjb25zdCB7IG1vZGUsIGlkLCBwYXlsb2FkLCBwZWVyQWRkcmVzcyB9ID0gaHAKCiAgICBjb25zdCBzdGF0ZSA9IHJlcS50YXJnZXQgJiYgdGhpcy5nZXQocmVxLnRhcmdldCkKICAgIGNvbnN0IGlzU2VydmVyID0gISEoc3RhdGUgJiYgc3RhdGUub25wZWVyaG9sZXB1bmNoKQogICAgY29uc3QgcmVsYXkgPSBzdGF0ZSAmJiBzdGF0ZS5yZWxheQoKICAgIHN3aXRjaCAobW9kZSkgewogICAgICBjYXNlIEZST01fQ0xJRU5UOiB7CiAgICAgICAgaWYgKCFwZWVyQWRkcmVzcyAmJiAhcmVsYXkpIHJldHVybgogICAgICAgIHJlcS5yZWxheSgKICAgICAgICAgIGMuZW5jb2RlKGhvbGVwdW5jaCwgeyBtb2RlOiBGUk9NX1JFTEFZLCBpZCwgcGF5bG9hZCwgcGVlckFkZHJlc3M6IHJlcS5mcm9tIH0pLAogICAgICAgICAgcGVlckFkZHJlc3MgfHwgcmVsYXkKICAgICAgICApCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgY2FzZSBGUk9NX1JFTEFZOiB7CiAgICAgICAgaWYgKCFpc1NlcnZlciB8fCAhcGVlckFkZHJlc3MpIHJldHVybgogICAgICAgIGxldCByZXBseSA9IG51bGwKICAgICAgICB0cnkgewogICAgICAgICAgcmVwbHkgPSBhd2FpdCBzdGF0ZS5vbnBlZXJob2xlcHVuY2goeyBpZCwgcGF5bG9hZCwgcGVlckFkZHJlc3MgfSwgcmVxKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHNhZmV0eUNhdGNoKGUpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgaWYgKCFyZXBseSkgcmV0dXJuCiAgICAgICAgY29uc3Qgb3B0cyA9IHsgc29ja2V0OiByZXBseS5zb2NrZXQsIGNsb3Nlck5vZGVzOiBmYWxzZSwgdG9rZW46IGZhbHNlIH0KICAgICAgICByZXEucmVsYXkoCiAgICAgICAgICBjLmVuY29kZShob2xlcHVuY2gsIHsgbW9kZTogRlJPTV9TRVJWRVIsIGlkOiAwLCBwYXlsb2FkOiByZXBseS5wYXlsb2FkLCBwZWVyQWRkcmVzcyB9KSwKICAgICAgICAgIHJlcS5mcm9tLAogICAgICAgICAgb3B0cwogICAgICAgICkKICAgICAgICByZXR1cm4KICAgICAgfQogICAgICBjYXNlIEZST01fU0VSVkVSOiB7CiAgICAgICAgcmVxLnJlcGx5KGMuZW5jb2RlKGhvbGVwdW5jaCwgeyBtb2RlOiBSRVBMWSwgaWQsIHBheWxvYWQsIHBlZXJBZGRyZXNzOiByZXEuZnJvbSB9KSwgewogICAgICAgICAgdG86IHBlZXJBZGRyZXNzLAogICAgICAgICAgY2xvc2VyTm9kZXM6IGZhbHNlLAogICAgICAgICAgdG9rZW46IGZhbHNlCiAgICAgICAgfSkKICAgICAgICByZXR1cm4gLy8gZXNsaW50LWRpc2FibGUtbGluZQogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBkZWNvZGUoZW5jLCB2YWwpIHsKICB0cnkgewogICAgcmV0dXJuIGMuZGVjb2RlKGVuYywgdmFsKQogIH0gY2F0Y2ggewogICAgcmV0dXJuIG51bGwKICB9Cn0KCmZ1bmN0aW9uIHRvU3RyaW5nKHQpIHsKICByZXR1cm4gdHlwZW9mIHQgPT09ICdzdHJpbmcnID8gdCA6IGI0YS50b1N0cmluZyh0LCAnaGV4JykKfQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgeyBob2xlcHVuY2hQYXlsb2FkIH0gPSByZXF1aXJlKCcuL21lc3NhZ2VzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgSG9sZXB1bmNoUGF5bG9hZCB7CiAgY29uc3RydWN0b3IoaG9sZXB1bmNoU2VjcmV0KSB7CiAgICB0aGlzLl9zaGFyZWRTZWNyZXQgPSBob2xlcHVuY2hTZWNyZXQKICAgIHRoaXMuX2xvY2FsU2VjcmV0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKQoKICAgIHNvZGl1bS5yYW5kb21ieXRlc19idWYodGhpcy5fbG9jYWxTZWNyZXQpCiAgfQoKICBkZWNyeXB0KGJ1ZmZlcikgewogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAyNCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCAtIDE2LCBidWZmZXIgfQoKICAgIGlmIChzdGF0ZS5lbmQgPD0gc3RhdGUuc3RhcnQpIHJldHVybiBudWxsCgogICAgY29uc3Qgbm9uY2UgPSBidWZmZXIuc3ViYXJyYXkoMCwgMjQpCiAgICBjb25zdCBtc2cgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIHN0YXRlLmVuZCkKICAgIGNvbnN0IGNpcGhlciA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCkKCiAgICBpZiAoIXNvZGl1bS5jcnlwdG9fc2VjcmV0Ym94X29wZW5fZWFzeShtc2csIGNpcGhlciwgbm9uY2UsIHRoaXMuX3NoYXJlZFNlY3JldCkpIHJldHVybiBudWxsCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGhvbGVwdW5jaFBheWxvYWQuZGVjb2RlKHN0YXRlKQogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiBudWxsCiAgICB9CiAgfQoKICBlbmNyeXB0KHBheWxvYWQpIHsKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMjQsIGVuZDogMjQsIGJ1ZmZlcjogbnVsbCB9CiAgICBob2xlcHVuY2hQYXlsb2FkLnByZWVuY29kZShzdGF0ZSwgcGF5bG9hZCkKICAgIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShzdGF0ZS5lbmQgKyAxNikKCiAgICBjb25zdCBub25jZSA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheSgwLCAyNCkKICAgIGNvbnN0IG1zZyA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCwgc3RhdGUuZW5kKQogICAgY29uc3QgY2lwaGVyID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0KQoKICAgIGhvbGVwdW5jaFBheWxvYWQuZW5jb2RlKHN0YXRlLCBwYXlsb2FkKQogICAgc29kaXVtLnJhbmRvbWJ5dGVzX2J1Zihub25jZSkKICAgIHNvZGl1bS5jcnlwdG9fc2VjcmV0Ym94X2Vhc3koY2lwaGVyLCBtc2csIG5vbmNlLCB0aGlzLl9zaGFyZWRTZWNyZXQpCgogICAgcmV0dXJuIHN0YXRlLmJ1ZmZlcgogIH0KCiAgdG9rZW4oYWRkcikgewogICAgY29uc3Qgb3V0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChvdXQsIGI0YS5mcm9tKGFkZHIuaG9zdCksIHRoaXMuX2xvY2FsU2VjcmV0KQogICAgcmV0dXJuIG91dAogIH0KfQpjb25zdCBET05FID0gUHJvbWlzZS5yZXNvbHZlKHRydWUpCmNvbnN0IERFU1RST1lFRCA9IFByb21pc2UucmVzb2x2ZShmYWxzZSkKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU2VtYXBob3JlIHsKICBjb25zdHJ1Y3RvcihsaW1pdCA9IDEpIHsKICAgIHRoaXMubGltaXQgPSBsaW1pdAogICAgdGhpcy5hY3RpdmUgPSAwCiAgICB0aGlzLndhaXRpbmcgPSBbXQoKICAgIHRoaXMuZmx1c2hlZFByb21pc2UgPSBudWxsCiAgICB0aGlzLmZsdXNoZWRSZXNvbHZlID0gbnVsbAoKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKCiAgICB0aGlzLl9vbndhaXQgPSB0aGlzLl9xdWV1ZVdhaXRpbmcuYmluZCh0aGlzKQogICAgdGhpcy5fb25mbHVzaCA9IHRoaXMuX3F1ZXVlRmx1c2hlZC5iaW5kKHRoaXMpCiAgfQoKICBfcXVldWVXYWl0aW5nKHJlc29sdmUpIHsKICAgIHRoaXMud2FpdGluZy5wdXNoKHJlc29sdmUpCiAgfQoKICBfcXVldWVGbHVzaGVkKHJlc29sdmUpIHsKICAgIHRoaXMuZmx1c2hlZFJlc29sdmUgPSByZXNvbHZlCiAgfQoKICB3YWl0KCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkID09PSB0cnVlKSByZXR1cm4gREVTVFJPWUVECgogICAgaWYgKHRoaXMuYWN0aXZlIDwgdGhpcy5saW1pdCAmJiB0aGlzLndhaXRpbmcubGVuZ3RoID09PSAwKSB7CiAgICAgIHRoaXMuYWN0aXZlKysKICAgICAgcmV0dXJuIERPTkUKICAgIH0KCiAgICByZXR1cm4gbmV3IFByb21pc2UodGhpcy5fb253YWl0KQogIH0KCiAgc2lnbmFsKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkID09PSB0cnVlKSByZXR1cm4KCiAgICB0aGlzLmFjdGl2ZS0tCiAgICB3aGlsZSAodGhpcy5hY3RpdmUgPCB0aGlzLmxpbWl0ICYmIHRoaXMud2FpdGluZy5sZW5ndGggPiAwICYmIHRoaXMuZGVzdHJveWVkID09PSBmYWxzZSkgewogICAgICB0aGlzLmFjdGl2ZSsrCiAgICAgIHRoaXMud2FpdGluZy5zaGlmdCgpKHRydWUpCiAgICB9CgogICAgaWYgKHRoaXMuYWN0aXZlID09PSAwICYmIHRoaXMuZmx1c2hlZFJlc29sdmUpIHsKICAgICAgY29uc3QgcmVzb2x2ZSA9IHRoaXMuZmx1c2hlZFJlc29sdmUKICAgICAgdGhpcy5mbHVzaGVkUmVzb2x2ZSA9IG51bGwKICAgICAgdGhpcy5mbHVzaGVkUHJvbWlzZSA9IG51bGwKICAgICAgcmVzb2x2ZSh0cnVlKQogICAgfQogIH0KCiAgYXN5bmMgZmx1c2goKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQgPT09IHRydWUpIHJldHVybgogICAgaWYgKHRoaXMuYWN0aXZlID09PSAwKSByZXR1cm4KICAgIGlmICh0aGlzLmZsdXNoZWRQcm9taXNlKSByZXR1cm4gdGhpcy5mbHVzaGVkUHJvbWlzZQogICAgdGhpcy5mbHVzaGVkUHJvbWlzZSA9IG5ldyBQcm9taXNlKHRoaXMuX29uZmx1c2gpCiAgICByZXR1cm4gdGhpcy5mbHVzaGVkUHJvbWlzZQogIH0KCiAgZGVzdHJveSgpIHsKICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQogICAgdGhpcy5hY3RpdmUgPSAwCiAgICB3aGlsZSAodGhpcy53YWl0aW5nLmxlbmd0aCkgdGhpcy53YWl0aW5nLnBvcCgpKGZhbHNlKQogICAgaWYgKHRoaXMuZmx1c2hlZFJlc29sdmUpIHRoaXMuZmx1c2hlZFJlc29sdmUoZmFsc2UpCiAgfQp9CmNvbnN0IHsgRXZlbnRFbWl0dGVyIH0gPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IE5vaXNlU2VjcmV0U3RyZWFtID0gcmVxdWlyZSgnQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHJlbGF5ID0gcmVxdWlyZSgnYmxpbmQtcmVsYXknKQpjb25zdCBOb2lzZVdyYXAgPSByZXF1aXJlKCcuL25vaXNlLXdyYXAnKQpjb25zdCBBbm5vdW5jZXIgPSByZXF1aXJlKCcuL2Fubm91bmNlcicpCmNvbnN0IHsgRklSRVdBTEwsIEVSUk9SIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCmNvbnN0IHsgdW5zbGFiYmVkSGFzaCB9ID0gcmVxdWlyZSgnLi9jcnlwdG8nKQpjb25zdCBTZWN1cmVQYXlsb2FkID0gcmVxdWlyZSgnLi9zZWN1cmUtcGF5bG9hZCcpCmNvbnN0IEhvbGVwdW5jaGVyID0gcmVxdWlyZSgnLi9ob2xlcHVuY2hlcicpCmNvbnN0IHsgaXNQcml2YXRlIH0gPSByZXF1aXJlKCdib2dvbicpCmNvbnN0IHsgQUxSRUFEWV9MSVNURU5JTkcsIE5PREVfREVTVFJPWUVELCBLRVlQQUlSX0FMUkVBRFlfVVNFRCB9ID0gcmVxdWlyZSgnLi9lcnJvcnMnKQoKY29uc3QgSEFORFNIQUtFX0NMRUFSX1dBSVQgPSAxMDAwMApjb25zdCBIQU5EU0hBS0VfSU5JVElBTF9USU1FT1VUID0gMTAwMDAKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU2VydmVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvcihkaHQsIG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuZGh0ID0gZGh0CiAgICB0aGlzLnRhcmdldCA9IG51bGwKCiAgICB0aGlzLmNsb3NlZCA9IGZhbHNlCiAgICB0aGlzLmZpcmV3YWxsID0gb3B0cy5maXJld2FsbCB8fCAoKCkgPT4gZmFsc2UpCiAgICB0aGlzLmhvbGVwdW5jaCA9IG9wdHMuaG9sZXB1bmNoIHx8ICgoKSA9PiB0cnVlKQogICAgdGhpcy5yZWxheVRocm91Z2ggPSBvcHRzLnJlbGF5VGhyb3VnaCB8fCBudWxsCiAgICB0aGlzLnJlbGF5S2VlcEFsaXZlID0gb3B0cy5yZWxheUtlZXBBbGl2ZSB8fCA1MDAwCiAgICB0aGlzLnBvb2wgPSBvcHRzLnBvb2wgfHwgbnVsbAogICAgdGhpcy5jcmVhdGVIYW5kc2hha2UgPSBvcHRzLmNyZWF0ZUhhbmRzaGFrZSB8fCBkZWZhdWx0Q3JlYXRlSGFuZHNoYWtlCiAgICB0aGlzLmNyZWF0ZVNlY3JldFN0cmVhbSA9IG9wdHMuY3JlYXRlU2VjcmV0U3RyZWFtIHx8IGRlZmF1bHRDcmVhdGVTZWNyZXRTdHJlYW0KICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKICAgIHRoaXMuaGFuZHNoYWtlQ2xlYXJXYWl0ID0gb3B0cy5oYW5kc2hha2VDbGVhcldhaXQgfHwgSEFORFNIQUtFX0NMRUFSX1dBSVQKCiAgICB0aGlzLl9zaGFyZUxvY2FsQWRkcmVzcyA9IG9wdHMuc2hhcmVMb2NhbEFkZHJlc3MgIT09IGZhbHNlCiAgICB0aGlzLl9yZXVzYWJsZVNvY2tldCA9ICEhb3B0cy5yZXVzYWJsZVNvY2tldAogICAgdGhpcy5fbmV2ZXJQdW5jaCA9IG9wdHMuaG9sZXB1bmNoID09PSBmYWxzZSAvLyB1c2VmdWwgZm9yIGZ1bGx5IGRpc2FibGluZyBwdW5jaGluZwogICAgdGhpcy5fa2V5UGFpciA9IG51bGwKICAgIHRoaXMuX2Fubm91bmNlciA9IG51bGwKICAgIHRoaXMuX2Nvbm5lY3RzID0gbmV3IE1hcCgpCiAgICB0aGlzLl9ob2xlcHVuY2hlcyA9IFtdCiAgICB0aGlzLl9saXN0ZW5pbmcgPSBudWxsCiAgICB0aGlzLl9jbG9zaW5nID0gbnVsbAogIH0KCiAgZ2V0IGxpc3RlbmluZygpIHsKICAgIHJldHVybiB0aGlzLl9saXN0ZW5pbmcgIT09IG51bGwKICB9CgogIGdldCBwdWJsaWNLZXkoKSB7CiAgICByZXR1cm4gdGhpcy5fa2V5UGFpciAmJiB0aGlzLl9rZXlQYWlyLnB1YmxpY0tleQogIH0KCiAgZ2V0IHJlbGF5QWRkcmVzc2VzKCkgewogICAgcmV0dXJuIHRoaXMuX2Fubm91bmNlciA/IHRoaXMuX2Fubm91bmNlci5yZWxheUFkZHJlc3NlcyA6IFtdCiAgfQoKICBvbmNvbm5lY3Rpb24oZW5jcnlwdGVkU29ja2V0KSB7CiAgICB0aGlzLmVtaXQoJ2Nvbm5lY3Rpb24nLCBlbmNyeXB0ZWRTb2NrZXQpCiAgfQoKICBhc3luYyBzdXNwZW5kKHsgbG9nID0gbm9vcCB9ID0ge30pIHsKICAgIGxvZygnU3VzcGVuZGluZyBoeXBlcmRodCBzZXJ2ZXInKQogICAgaWYgKHRoaXMuX2xpc3RlbmluZyAhPT0gbnVsbCkgYXdhaXQgdGhpcy5fbGlzdGVuaW5nCiAgICBsb2coJ1N1c3BlbmRpbmcgaHlwZXJkaHQgc2VydmVyIChwb3N0IGxpc3RlbmluZyknKQogICAgdGhpcy5zdXNwZW5kZWQgPSB0cnVlCiAgICB0aGlzLl9jbGVhckFsbCgpCiAgICByZXR1cm4gdGhpcy5fYW5ub3VuY2VyID8gdGhpcy5fYW5ub3VuY2VyLnN1c3BlbmQoeyBsb2cgfSkgOiBQcm9taXNlLnJlc29sdmUoKQogIH0KCiAgYXN5bmMgcmVzdW1lKCkgewogICAgaWYgKHRoaXMuX2xpc3RlbmluZyAhPT0gbnVsbCkgYXdhaXQgdGhpcy5fbGlzdGVuaW5nCiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCiAgICByZXR1cm4gdGhpcy5fYW5ub3VuY2VyID8gdGhpcy5fYW5ub3VuY2VyLnJlc3VtZSgpIDogUHJvbWlzZS5yZXNvbHZlKCkKICB9CgogIGFkZHJlc3MoKSB7CiAgICBpZiAoIXRoaXMuX2tleVBhaXIpIHJldHVybiBudWxsCgogICAgcmV0dXJuIHsKICAgICAgcHVibGljS2V5OiB0aGlzLl9rZXlQYWlyLnB1YmxpY0tleSwKICAgICAgaG9zdDogdGhpcy5kaHQuaG9zdCwKICAgICAgcG9ydDogdGhpcy5kaHQucG9ydAogICAgfQogIH0KCiAgY2xvc2UoKSB7CiAgICBpZiAodGhpcy5fY2xvc2luZykgcmV0dXJuIHRoaXMuX2Nsb3NpbmcKICAgIHRoaXMuX2Nsb3NpbmcgPSB0aGlzLl9jbG9zZSgpCiAgICByZXR1cm4gdGhpcy5fY2xvc2luZwogIH0KCiAgX2djKCkgewogICAgdGhpcy5kaHQubGlzdGVuaW5nLmRlbGV0ZSh0aGlzKQogICAgaWYgKHRoaXMudGFyZ2V0KSB0aGlzLmRodC5fcm91dGVyLmRlbGV0ZSh0aGlzLnRhcmdldCkKICB9CgogIGFzeW5jIF9zdG9wTGlzdGVuaW5nKCkgewogICAgdHJ5IHsKICAgICAgaWYgKHRoaXMuX2Fubm91bmNlcikgYXdhaXQgdGhpcy5fYW5ub3VuY2VyLnN0b3AoKQogICAgfSBjYXRjaCB7CiAgICAgIC8vIGlnbm9yZQogICAgfQoKICAgIHRoaXMuX2Fubm91bmNlciA9IG51bGwKICAgIHRoaXMuX2xpc3RlbmluZyA9IG51bGwKICAgIHRoaXMuX2tleVBhaXIgPSBudWxsCiAgfQoKICBhc3luYyBfY2xvc2UoKSB7CiAgICBpZiAodGhpcy5fbGlzdGVuaW5nID09PSBudWxsKSB7CiAgICAgIHRoaXMuY2xvc2VkID0gdHJ1ZQogICAgICB0aGlzLmVtaXQoJ2Nsb3NlJykKICAgICAgcmV0dXJuCiAgICB9CgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fbGlzdGVuaW5nCiAgICB9IGNhdGNoIHt9CgogICAgdGhpcy5fZ2MoKQogICAgdGhpcy5fY2xlYXJBbGwoKQoKICAgIGF3YWl0IHRoaXMuX3N0b3BMaXN0ZW5pbmcoKQoKICAgIHRoaXMuY2xvc2VkID0gdHJ1ZQogICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgfQoKICBfY2xlYXJBbGwoKSB7CiAgICB3aGlsZSAodGhpcy5faG9sZXB1bmNoZXMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBoID0gdGhpcy5faG9sZXB1bmNoZXMucG9wKCkKICAgICAgaWYgKGggJiYgaC5wdW5jaGVyKSBoLnB1bmNoZXIuZGVzdHJveSgpCiAgICAgIGlmIChoICYmIGguY2xlYXJpbmcpIGNsZWFyVGltZW91dChoLmNsZWFyaW5nKQogICAgICBpZiAoaCAmJiBoLnByZXB1bmNoaW5nKSBjbGVhclRpbWVvdXQoaC5wcmVwdW5jaGluZykKICAgICAgaWYgKGggJiYgaC5yYXdTdHJlYW0pIGgucmF3U3RyZWFtLmRlc3Ryb3koKQogICAgfQoKICAgIHRoaXMuX2Nvbm5lY3RzLmNsZWFyKCkKICB9CgogIGFzeW5jIGxpc3RlbihrZXlQYWlyID0gdGhpcy5kaHQuZGVmYXVsdEtleVBhaXIsIG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMuX2xpc3RlbmluZyAhPT0gbnVsbCkgdGhyb3cgQUxSRUFEWV9MSVNURU5JTkcoKQogICAgaWYgKHRoaXMuZGh0LmRlc3Ryb3llZCkgdGhyb3cgTk9ERV9ERVNUUk9ZRUQoKQoKICAgIHRoaXMuX2xpc3RlbmluZyA9IHRoaXMuX2xpc3RlbihrZXlQYWlyLCBvcHRzKQogICAgYXdhaXQgdGhpcy5fbGlzdGVuaW5nCiAgICByZXR1cm4gdGhpcwogIH0KCiAgYXN5bmMgX2xpc3RlbihrZXlQYWlyLCBvcHRzKSB7CiAgICAvLyBGcm9tIG5vdyBvbiwgdGhlIERIVCBvYmplY3Qgd2hpY2ggY3JlYXRlZCBtZSBpcyByZXNwb25zaWJsZSBmb3IgY2xvc2luZyBtZQogICAgdGhpcy5kaHQubGlzdGVuaW5nLmFkZCh0aGlzKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuZGh0LmJpbmQoKQogICAgICBpZiAodGhpcy5fY2xvc2luZykgcmV0dXJuCgogICAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5kaHQubGlzdGVuaW5nKSB7CiAgICAgICAgaWYgKHMuX2tleVBhaXIgJiYgYjRhLmVxdWFscyhzLl9rZXlQYWlyLnB1YmxpY0tleSwga2V5UGFpci5wdWJsaWNLZXkpKSB7CiAgICAgICAgICB0aHJvdyBLRVlQQUlSX0FMUkVBRFlfVVNFRCgpCiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLnRhcmdldCA9IHVuc2xhYmJlZEhhc2goa2V5UGFpci5wdWJsaWNLZXkpCiAgICAgIHRoaXMuX2tleVBhaXIgPSBrZXlQYWlyCiAgICAgIHRoaXMuX2Fubm91bmNlciA9IG5ldyBBbm5vdW5jZXIodGhpcy5kaHQsIGtleVBhaXIsIHRoaXMudGFyZ2V0LCBvcHRzKQoKICAgICAgdGhpcy5kaHQuX3JvdXRlci5zZXQodGhpcy50YXJnZXQsIHsKICAgICAgICByZWxheTogbnVsbCwKICAgICAgICByZWNvcmQ6IHRoaXMuX2Fubm91bmNlci5yZWNvcmQsCiAgICAgICAgb25wZWVyaGFuZHNoYWtlOiB0aGlzLl9vbnBlZXJoYW5kc2hha2UuYmluZCh0aGlzKSwKICAgICAgICBvbnBlZXJob2xlcHVuY2g6IHRoaXMuX29ucGVlcmhvbGVwdW5jaC5iaW5kKHRoaXMpCiAgICAgIH0pCgogICAgICAvLyB3YXJtIGl0IHVwIGZvciBub3cKICAgICAgdGhpcy5fbG9jYWxBZGRyZXNzZXMoKS5jYXRjaChzYWZldHlDYXRjaCkKCiAgICAgIGF3YWl0IHRoaXMuX2Fubm91bmNlci5zdGFydCgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgYXdhaXQgdGhpcy5fc3RvcExpc3RlbmluZygpCiAgICAgIHRoaXMuX2djKCkKICAgICAgdGhyb3cgZXJyCiAgICB9CgogICAgaWYgKHRoaXMuX2Nsb3NpbmcpIHJldHVybgogICAgaWYgKHRoaXMuc3VzcGVuZGVkKSBhd2FpdCB0aGlzLl9hbm5vdW5jZXIuc3VzcGVuZCgpCgogICAgaWYgKHRoaXMuX2Nsb3NpbmcpIHJldHVybgogICAgaWYgKHRoaXMuZGh0LmRlc3Ryb3llZCkgdGhyb3cgTk9ERV9ERVNUUk9ZRUQoKQoKICAgIGlmICh0aGlzLnBvb2wpIHRoaXMucG9vbC5fYXR0YWNoU2VydmVyKHRoaXMpCgogICAgdGhpcy5lbWl0KCdsaXN0ZW5pbmcnKQogIH0KCiAgcmVmcmVzaCgpIHsKICAgIGlmICh0aGlzLl9hbm5vdW5jZXIgJiYgIXRoaXMuc3VzcGVuZGVkKSB0aGlzLl9hbm5vdW5jZXIucmVmcmVzaCgpCiAgfQoKICBub3RpZnlPbmxpbmUoKSB7CiAgICBpZiAodGhpcy5fYW5ub3VuY2VyKSB0aGlzLl9hbm5vdW5jZXIub25saW5lLm5vdGlmeSgpCiAgfQoKICBfbG9jYWxBZGRyZXNzZXMoKSB7CiAgICByZXR1cm4gdGhpcy5kaHQudmFsaWRhdGVMb2NhbEFkZHJlc3NlcyhIb2xlcHVuY2hlci5sb2NhbEFkZHJlc3Nlcyh0aGlzLmRodC5pby5zZXJ2ZXJTb2NrZXQpKQogIH0KCiAgYXN5bmMgX2FkZEhhbmRzaGFrZShrLCBub2lzZSwgY2xpZW50QWRkcmVzcywgeyBmcm9tLCB0bzogc2VydmVyQWRkcmVzcywgc29ja2V0IH0sIGRpcmVjdCkgewogICAgbGV0IGlkID0gdGhpcy5faG9sZXB1bmNoZXMuaW5kZXhPZihudWxsKQogICAgaWYgKGlkID09PSAtMSkgaWQgPSB0aGlzLl9ob2xlcHVuY2hlcy5wdXNoKG51bGwpIC0gMQoKICAgIGNvbnN0IGhzID0gewogICAgICByb3VuZDogMCwKICAgICAgcmVwbHk6IG51bGwsCiAgICAgIHB1bmNoZXI6IG51bGwsCiAgICAgIHBheWxvYWQ6IG51bGwsCiAgICAgIHJhd1N0cmVhbTogbnVsbCwKICAgICAgZW5jcnlwdGVkU29ja2V0OiBudWxsLAogICAgICBwcmVwdW5jaGluZzogbnVsbCwKICAgICAgZmlyZXdhbGxlZDogdHJ1ZSwKICAgICAgY2xlYXJpbmc6IG51bGwsCiAgICAgIG9uc29ja2V0OiBudWxsLAogICAgICBhYm9ydGVkOiBmYWxzZSwKCiAgICAgIC8vIFJlbGF5IHN0YXRlCiAgICAgIHJlbGF5VGltZW91dDogbnVsbCwKICAgICAgcmVsYXlUb2tlbjogbnVsbCwKICAgICAgcmVsYXlTb2NrZXQ6IG51bGwsCiAgICAgIHJlbGF5Q2xpZW50OiBudWxsLAogICAgICByZWxheVBhaXJlZDogZmFsc2UKICAgIH0KCiAgICB0aGlzLl9ob2xlcHVuY2hlc1tpZF0gPSBocwoKICAgIGNvbnN0IGhhbmRzaGFrZSA9IHRoaXMuY3JlYXRlSGFuZHNoYWtlKHRoaXMuX2tleVBhaXIsIG51bGwpCgogICAgbGV0IHJlbW90ZVBheWxvYWQKICAgIHRyeSB7CiAgICAgIHJlbW90ZVBheWxvYWQgPSBhd2FpdCBoYW5kc2hha2UucmVjdihub2lzZSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgIHRoaXMuX2NsZWFyTGF0ZXIoaHMsIGlkLCBrKQogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGlmICh0aGlzLl9jbG9zaW5nIHx8IHRoaXMuc3VzcGVuZGVkKSByZXR1cm4gbnVsbAoKICAgIHRyeSB7CiAgICAgIGhzLmZpcmV3YWxsZWQgPSBhd2FpdCB0aGlzLmZpcmV3YWxsKGhhbmRzaGFrZS5yZW1vdGVQdWJsaWNLZXksIHJlbW90ZVBheWxvYWQsIGNsaWVudEFkZHJlc3MpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgfQoKICAgIGlmICh0aGlzLl9jbG9zaW5nIHx8IHRoaXMuc3VzcGVuZGVkKSByZXR1cm4gbnVsbAoKICAgIGlmIChocy5maXJld2FsbGVkKSB7CiAgICAgIHRoaXMuX2NsZWFyTGF0ZXIoaHMsIGlkLCBrKQogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGNvbnN0IGVycm9yID0KICAgICAgcmVtb3RlUGF5bG9hZC52ZXJzaW9uID09PSAxCiAgICAgICAgPyByZW1vdGVQYXlsb2FkLnVkeAogICAgICAgICAgPyBFUlJPUi5OT05FCiAgICAgICAgICA6IEVSUk9SLkFCT1JURUQKICAgICAgICA6IEVSUk9SLlZFUlNJT05fTUlTTUFUQ0gKCiAgICBjb25zdCBhZGRyZXNzZXMgPSBbXQogICAgY29uc3Qgb3VyUmVtb3RlQWRkciA9IHRoaXMuZGh0LnJlbW90ZUFkZHJlc3MoKQogICAgY29uc3Qgb3VyTG9jYWxBZGRycyA9IHRoaXMuX3NoYXJlTG9jYWxBZGRyZXNzID8gYXdhaXQgdGhpcy5fbG9jYWxBZGRyZXNzZXMoKSA6IG51bGwKCiAgICBpZiAodGhpcy5fY2xvc2luZyB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuIG51bGwKCiAgICBpZiAob3VyUmVtb3RlQWRkcikgYWRkcmVzc2VzLnB1c2gob3VyUmVtb3RlQWRkcikKICAgIGlmIChvdXJMb2NhbEFkZHJzKSBhZGRyZXNzZXMucHVzaCguLi5vdXJMb2NhbEFkZHJzKQoKICAgIGlmIChlcnJvciA9PT0gRVJST1IuTk9ORSkgewogICAgICBocy5yYXdTdHJlYW0gPSB0aGlzLmRodC5jcmVhdGVSYXdTdHJlYW0oewogICAgICAgIGZyYW1lZDogdHJ1ZSwKICAgICAgICBmaXJld2FsbChzb2NrZXQsIHBvcnQsIGhvc3QpIHsKICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSB0cmFmZmljIG9yaWdpbmF0ZWQgZnJvbSB0aGUgc29ja2V0IG9uIHdoaWNoIHdlJ3JlIGV4cGVjdGluZyByZWxheSB0cmFmZmljLiBJZiBzbywKICAgICAgICAgIC8vIHdlIGhhdmVuJ3QgaG9sZSBwdW5jaGVkIHlldCBhbmQgdGhlIG90aGVyIHNpZGUgaXMganVzdCBzZW5kaW5nIHVzIHRyYWZmaWMgdGhyb3VnaCB0aGUgcmVsYXkuCiAgICAgICAgICBpZiAoaHMucmVsYXlTb2NrZXQgJiYgaXNSZWxheShocy5yZWxheVNvY2tldCwgc29ja2V0LCBwb3J0LCBob3N0KSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICAgIH0KCiAgICAgICAgICBocy5vbnNvY2tldChzb2NrZXQsIHBvcnQsIGhvc3QpCiAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CiAgICAgIH0pCgogICAgICBocy5yYXdTdHJlYW0ub24oJ2Vycm9yJywgYXV0b0Rlc3Ryb3kpCgogICAgICAvLyBIYW5kbGVzIHRoZSBjYXNlIHdoZXJlIG9uc29ja2V0IGlzIG5ldmVyIGNhbGxlZCwgYnV0IHRoZSBzdHJlYW0gZ290IHNldHVwCiAgICAgIC8vIFRoaXMgY2FuIGhhcHBlbiBvbiBhIHJlbGF5ZWQgY29ubmVjdGlvbiB3aGljaCBuZXZlciBjb25uZWN0cyBkaXJlY3RseQogICAgICAvLyAob25zb2NrZXQgaXMgY2FsbGVkIHRoZXJlIG9ubHkgd2hlbiB0aGUgZGlyZWN0IGNvbm5lY3Rpb24gaXMgZXN0YWJsaXNoZWQpCiAgICAgIGNvbnN0IG9ucmF3c3RyZWFtY2xvc2UgPSAoKSA9PiB7CiAgICAgICAgaWYgKHRoaXMuX2Nsb3NpbmcpIHJldHVybgogICAgICAgIHRoaXMuX2NsZWFyTGF0ZXIoaHMsIGlkLCBrKQogICAgICB9CiAgICAgIGhzLnJhd1N0cmVhbS5vbignY2xvc2UnLCBvbnJhd3N0cmVhbWNsb3NlKQoKICAgICAgaHMub25zb2NrZXQgPSAoc29ja2V0LCBwb3J0LCBob3N0KSA9PiB7CiAgICAgICAgaWYgKGhzLnJhd1N0cmVhbSA9PT0gbnVsbCkgcmV0dXJuIC8vIEFscmVhZHkgaG9sZSBwdW5jaGVkCgogICAgICAgIHRoaXMuX2NsZWFyTGF0ZXIoaHMsIGlkLCBrKQoKICAgICAgICBpZiAoaHMucHJlcHVuY2hpbmcpIHsKICAgICAgICAgIGNsZWFyVGltZW91dChocy5wcmVwdW5jaGluZykKICAgICAgICAgIGhzLnByZXB1bmNoaW5nID0gbnVsbAogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX3JldXNhYmxlU29ja2V0ICYmIHJlbW90ZVBheWxvYWQudWR4LnJldXNhYmxlU29ja2V0KSB7CiAgICAgICAgICB0aGlzLmRodC5fc29ja2V0UG9vbC5yb3V0ZXMuYWRkKGhhbmRzaGFrZS5yZW1vdGVQdWJsaWNLZXksIGhzLnJhd1N0cmVhbSkKICAgICAgICB9CgogICAgICAgIGhzLnJhd1N0cmVhbS5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBhdXRvRGVzdHJveSkKICAgICAgICBocy5yYXdTdHJlYW0ucmVtb3ZlTGlzdGVuZXIoJ2Nsb3NlJywgb25yYXdzdHJlYW1jbG9zZSkKCiAgICAgICAgaWYgKGhzLnJhd1N0cmVhbS5jb25uZWN0ZWQpIHsKICAgICAgICAgIGNvbnN0IHJlbW90ZUNoYW5naW5nID0gaHMucmF3U3RyZWFtLmNoYW5nZVJlbW90ZShzb2NrZXQsIHJlbW90ZVBheWxvYWQudWR4LmlkLCBwb3J0LCBob3N0KQoKICAgICAgICAgIGlmIChyZW1vdGVDaGFuZ2luZykgcmVtb3RlQ2hhbmdpbmcuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGhzLnJhd1N0cmVhbS5jb25uZWN0KHNvY2tldCwgcmVtb3RlUGF5bG9hZC51ZHguaWQsIHBvcnQsIGhvc3QpCiAgICAgICAgICBocy5lbmNyeXB0ZWRTb2NrZXQgPSB0aGlzLmNyZWF0ZVNlY3JldFN0cmVhbShmYWxzZSwgaHMucmF3U3RyZWFtLCB7CiAgICAgICAgICAgIGhhbmRzaGFrZTogaCwKICAgICAgICAgICAga2VlcEFsaXZlOiB0aGlzLmRodC5jb25uZWN0aW9uS2VlcEFsaXZlCiAgICAgICAgICB9KQoKICAgICAgICAgIHRoaXMub25jb25uZWN0aW9uKGhzLmVuY3J5cHRlZFNvY2tldCkKICAgICAgICB9CgogICAgICAgIGlmIChocy5wdW5jaGVyKSB7CiAgICAgICAgICBocy5wdW5jaGVyLm9uYWJvcnQgPSBub29wCiAgICAgICAgICBocy5wdW5jaGVyLmRlc3Ryb3koKQogICAgICAgIH0KCiAgICAgICAgaHMucmF3U3RyZWFtID0gbnVsbAogICAgICB9CgogICAgICBmdW5jdGlvbiBhdXRvRGVzdHJveSgpIHsKICAgICAgICBpZiAoaHMucHVuY2hlcikgaHMucHVuY2hlci5kZXN0cm95KCkKICAgICAgfQogICAgfQoKICAgIGNvbnN0IHJlbGF5QWRkcmVzc2VzID0gdGhpcy5yZWxheUFkZHJlc3NlcwogICAgY29uc3QgcmVsYXlUaHJvdWdoID0gc2VsZWN0UmVsYXkodGhpcy5yZWxheVRocm91Z2gpCgogICAgaWYgKHJlbGF5VGhyb3VnaCkgaHMucmVsYXlUb2tlbiA9IHJlbGF5LnRva2VuKCkKCiAgICB0cnkgewogICAgICBocy5yZXBseSA9IGF3YWl0IGhhbmRzaGFrZS5zZW5kKHsKICAgICAgICBlcnJvciwKICAgICAgICBmaXJld2FsbDogb3VyUmVtb3RlQWRkciA/IEZJUkVXQUxMLk9QRU4gOiBGSVJFV0FMTC5VTktOT1dOLAogICAgICAgIGhvbGVwdW5jaDogb3VyUmVtb3RlQWRkciA/IG51bGwgOiB7IGlkLCByZWxheXM6IHRoaXMuX2Fubm91bmNlci5yZWxheXMgfSwKICAgICAgICBhZGRyZXNzZXM0OiBhZGRyZXNzZXMsCiAgICAgICAgYWRkcmVzc2VzNjogbnVsbCwKICAgICAgICB1ZHg6IHsKICAgICAgICAgIHJldXNhYmxlU29ja2V0OiB0aGlzLl9yZXVzYWJsZVNvY2tldCwKICAgICAgICAgIGlkOiBocy5yYXdTdHJlYW0gPyBocy5yYXdTdHJlYW0uaWQgOiAwLAogICAgICAgICAgc2VxOiAwCiAgICAgICAgfSwKICAgICAgICBzZWNyZXRTdHJlYW06IHt9LAogICAgICAgIHJlbGF5VGhyb3VnaDogcmVsYXlUaHJvdWdoID8geyBwdWJsaWNLZXk6IHJlbGF5VGhyb3VnaCwgdG9rZW46IGhzLnJlbGF5VG9rZW4gfSA6IG51bGwsCiAgICAgICAgcmVsYXlBZGRyZXNzZXM6IHJlbGF5QWRkcmVzc2VzLmxlbmd0aCA/IHJlbGF5QWRkcmVzc2VzIDogbnVsbAogICAgICB9KQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgICAgaHMucmF3U3RyZWFtLmRlc3Ryb3koKQogICAgICB0aGlzLl9jbGVhckxhdGVyKGhzLCBpZCwgaykKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBpZiAodGhpcy5fY2xvc2luZyB8fCB0aGlzLnN1c3BlbmRlZCkgewogICAgICBocy5yYXdTdHJlYW0uZGVzdHJveSgpCiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgY29uc3QgaCA9IGhhbmRzaGFrZS5maW5hbCgpCgogICAgaWYgKGVycm9yICE9PSBFUlJPUi5OT05FKSB7CiAgICAgIGhzLnJhd1N0cmVhbS5kZXN0cm95KCkKICAgICAgdGhpcy5fY2xlYXJMYXRlcihocywgaWQsIGspCiAgICAgIHJldHVybiBocwogICAgfQoKICAgIGlmIChyZW1vdGVQYXlsb2FkLmZpcmV3YWxsID09PSBGSVJFV0FMTC5PUEVOIHx8IGRpcmVjdCkgewogICAgICBjb25zdCBzb2NrID0gZGlyZWN0ID8gc29ja2V0IDogdGhpcy5kaHQuc29ja2V0CiAgICAgIHRoaXMuZGh0LnN0YXRzLnB1bmNoZXMub3BlbisrCiAgICAgIGhzLm9uc29ja2V0KHNvY2ssIGNsaWVudEFkZHJlc3MucG9ydCwgY2xpZW50QWRkcmVzcy5ob3N0KQogICAgICByZXR1cm4gaHMKICAgIH0KCiAgICBpZiAocmVsYXlUaHJvdWdoIHx8IHJlbW90ZVBheWxvYWQucmVsYXlUaHJvdWdoKSB7CiAgICAgIHRoaXMuX3JlbGF5Q29ubmVjdGlvbihocywgcmVsYXlUaHJvdWdoLCByZW1vdGVQYXlsb2FkLCBoKQogICAgfQoKICAgIGNvbnN0IG9uYWJvcnQgPSAoKSA9PiB7CiAgICAgIGhzLmFib3J0ZWQgPSB0cnVlCiAgICAgIGlmIChocy5wcmVwdW5jaGluZykgY2xlYXJUaW1lb3V0KGhzLnByZXB1bmNoaW5nKQogICAgICBocy5wcmVwdW5jaGluZyA9IG51bGwKICAgICAgaWYgKGhzLnJhd1N0cmVhbS5kZXN0cm95ZWQpIHsKICAgICAgICB0aGlzLl9jbGVhckxhdGVyKGhzLCBpZCwgaykKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgaHMucmF3U3RyZWFtLm9uKCdjbG9zZScsICgpID0+IHRoaXMuX2NsZWFyTGF0ZXIoaHMsIGlkLCBrKSkKICAgICAgaWYgKGhzLnJlbGF5VG9rZW4gPT09IG51bGwpIGhzLnJhd1N0cmVhbS5kZXN0cm95KCkKICAgIH0KCiAgICBpZiAoIWRpcmVjdCAmJiBjbGllbnRBZGRyZXNzLmhvc3QgPT09IHNlcnZlckFkZHJlc3MuaG9zdCkgewogICAgICBjb25zdCBjbGllbnRBZGRyZXNzZXMgPSByZW1vdGVQYXlsb2FkLmFkZHJlc3NlczQuZmlsdGVyKG9ubHlQcml2YXRlSG9zdHMpCgogICAgICBpZiAoY2xpZW50QWRkcmVzc2VzLmxlbmd0aCA+IDAgJiYgdGhpcy5fc2hhcmVMb2NhbEFkZHJlc3MpIHsKICAgICAgICBjb25zdCBteUFkZHJlc3NlcyA9IGF3YWl0IHRoaXMuX2xvY2FsQWRkcmVzc2VzKCkKICAgICAgICBjb25zdCBhZGRyID0gSG9sZXB1bmNoZXIubWF0Y2hBZGRyZXNzKG15QWRkcmVzc2VzLCBjbGllbnRBZGRyZXNzZXMpCgogICAgICAgIGlmIChhZGRyKSB7CiAgICAgICAgICBocy5wcmVwdW5jaGluZyA9IHNldFRpbWVvdXQob25hYm9ydCwgSEFORFNIQUtFX0lOSVRJQUxfVElNRU9VVCkKICAgICAgICAgIHJldHVybiBocwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLl9jbG9zaW5nIHx8IHRoaXMuc3VzcGVuZGVkKSByZXR1cm4gbnVsbAoKICAgIGlmIChvdXJSZW1vdGVBZGRyIHx8IHRoaXMuX25ldmVyUHVuY2gpIHsKICAgICAgaHMucHJlcHVuY2hpbmcgPSBzZXRUaW1lb3V0KG9uYWJvcnQsIEhBTkRTSEFLRV9JTklUSUFMX1RJTUVPVVQpCiAgICAgIHJldHVybiBocwogICAgfQoKICAgIGhzLnBheWxvYWQgPSBuZXcgU2VjdXJlUGF5bG9hZChoLmhvbGVwdW5jaFNlY3JldCkKICAgIGhzLnB1bmNoZXIgPSBuZXcgSG9sZXB1bmNoZXIodGhpcy5kaHQsIHRoaXMuZGh0LnNlc3Npb24oKSwgZmFsc2UsIHJlbW90ZVBheWxvYWQuZmlyZXdhbGwpCgogICAgaHMucHVuY2hlci5vbmNvbm5lY3QgPSBocy5vbnNvY2tldAogICAgaHMucHVuY2hlci5vbmFib3J0ID0gb25hYm9ydAogICAgaHMucHJlcHVuY2hpbmcgPSBzZXRUaW1lb3V0KGhzLnB1bmNoZXIuZGVzdHJveS5iaW5kKGhzLnB1bmNoZXIpLCBIQU5EU0hBS0VfSU5JVElBTF9USU1FT1VUKQoKICAgIHJldHVybiBocwogIH0KCiAgX2NsZWFyTGF0ZXIoaHMsIGlkLCBrKSB7CiAgICBpZiAoaHMuY2xlYXJpbmcpIHJldHVybgogICAgaHMuY2xlYXJpbmcgPSBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX2NsZWFyKGhzLCBpZCwgayksIHRoaXMuaGFuZHNoYWtlQ2xlYXJXYWl0KQogIH0KCiAgX2NsZWFyKGhzLCBpZCwgaykgewogICAgaWYgKGlkID49IHRoaXMuX2hvbGVwdW5jaGVzLmxlbmd0aCB8fCB0aGlzLl9ob2xlcHVuY2hlc1tpZF0gIT09IGhzKSByZXR1cm4KICAgIGlmIChocy5jbGVhcmluZykgY2xlYXJUaW1lb3V0KGhzLmNsZWFyaW5nKQoKICAgIHRoaXMuX2hvbGVwdW5jaGVzW2lkXSA9IG51bGwKICAgIHdoaWxlICgKICAgICAgdGhpcy5faG9sZXB1bmNoZXMubGVuZ3RoID4gMCAmJgogICAgICB0aGlzLl9ob2xlcHVuY2hlc1t0aGlzLl9ob2xlcHVuY2hlcy5sZW5ndGggLSAxXSA9PT0gbnVsbAogICAgKSB7CiAgICAgIHRoaXMuX2hvbGVwdW5jaGVzLnBvcCgpCiAgICB9CiAgICB0aGlzLl9jb25uZWN0cy5kZWxldGUoaykKICB9CgogIGFzeW5jIF9vbnBlZXJoYW5kc2hha2UoeyBub2lzZSwgcGVlckFkZHJlc3MgfSwgcmVxKSB7CiAgICBjb25zdCBrID0gYjRhLnRvU3RyaW5nKG5vaXNlLCAnaGV4JykKCiAgICAvLyBUaGUgbmV4dCBjb3VwbGUgb2Ygc3RhdGVtZW50cyBNVVNUIHJ1biB3aXRoaW4gdGhlIHNhbWUgdGljayB0byBwcmV2ZW50CiAgICAvLyBhIG1hbGljaW91cyBwZWVyIGZyb20gZmxvb2RpbmcgdXMgd2l0aCBoYW5kc2hha2VzLgogICAgbGV0IHAgPSB0aGlzLl9jb25uZWN0cy5nZXQoaykKICAgIGlmICghcCkgewogICAgICBwID0gdGhpcy5fYWRkSGFuZHNoYWtlKGssIG5vaXNlLCBwZWVyQWRkcmVzcyB8fCByZXEuZnJvbSwgcmVxLCAhcGVlckFkZHJlc3MpCiAgICAgIHRoaXMuX2Nvbm5lY3RzLnNldChrLCBwKQogICAgfQoKICAgIGNvbnN0IGggPSBhd2FpdCBwCiAgICBpZiAoIWgpIHJldHVybiBudWxsCgogICAgaWYgKHRoaXMuX2Nsb3NpbmcgIT09IG51bGwgfHwgdGhpcy5zdXNwZW5kZWQpIHJldHVybiBudWxsCgogICAgcmV0dXJuIHsgc29ja2V0OiBoLnB1bmNoZXIgJiYgaC5wdW5jaGVyLnNvY2tldCwgbm9pc2U6IGgucmVwbHkgfQogIH0KCiAgYXN5bmMgX29ucGVlcmhvbGVwdW5jaCh7IGlkLCBwZWVyQWRkcmVzcywgcGF5bG9hZCB9LCByZXEpIHsKICAgIGNvbnN0IGggPSBpZCA8IHRoaXMuX2hvbGVwdW5jaGVzLmxlbmd0aCA/IHRoaXMuX2hvbGVwdW5jaGVzW2lkXSA6IG51bGwKICAgIGlmICghaCkgcmV0dXJuIG51bGwKCiAgICBpZiAoIXBlZXJBZGRyZXNzIHx8IHRoaXMuX2Nsb3NpbmcgIT09IG51bGwgfHwgdGhpcy5zdXNwZW5kZWQpIHJldHVybiBudWxsCgogICAgY29uc3QgcCA9IGgucHVuY2hlcgogICAgaWYgKCFwIHx8ICFwLnNvY2tldCkgcmV0dXJuIHRoaXMuX2Fib3J0KGgpIC8vIG5vdCBvcGVuZWQKCiAgICBjb25zdCByZW1vdGVQYXlsb2FkID0gaC5wYXlsb2FkLmRlY3J5cHQocGF5bG9hZCkKICAgIGlmICghcmVtb3RlUGF5bG9hZCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBpc1NlcnZlclJlbGF5ID0gdGhpcy5fYW5ub3VuY2VyLmlzUmVsYXkocmVxLmZyb20pCiAgICBjb25zdCB7IGVycm9yLCBmaXJld2FsbCwgcm91bmQsIHB1bmNoaW5nLCBhZGRyZXNzZXMsIHJlbW90ZUFkZHJlc3MsIHJlbW90ZVRva2VuIH0gPQogICAgICByZW1vdGVQYXlsb2FkCgogICAgaWYgKGVycm9yICE9PSBFUlJPUi5OT05FKSB7CiAgICAgIC8vIFdlIGFjdHVhbGx5IGRvIG5vdCBuZWVkIHRvIHNldCB0aGUgcm91bmQgaGVyZSwgYnV0IGp1c3QgZG8gaXQgZm9yIGNvbnNpc3RlbmN5LgogICAgICBpZiAocm91bmQgPj0gaC5yb3VuZCkgaC5yb3VuZCA9IHJvdW5kCiAgICAgIHJldHVybiB0aGlzLl9hYm9ydChoKQogICAgfQoKICAgIGNvbnN0IHRva2VuID0gaC5wYXlsb2FkLnRva2VuKHBlZXJBZGRyZXNzKQogICAgY29uc3QgZWNob2VkID0gaXNTZXJ2ZXJSZWxheSAmJiAhIXJlbW90ZVRva2VuICYmIGI0YS5lcXVhbHModG9rZW4sIHJlbW90ZVRva2VuKQoKICAgIC8vIFVwZGF0ZSBvdXIgaGV1cmlzdGljcyBoZXJlCiAgICBpZiAocmVxLnNvY2tldCA9PT0gcC5zb2NrZXQpIHsKICAgICAgcC5uYXQuYWRkKHJlcS50bywgcmVxLmZyb20pCiAgICB9CgogICAgaWYgKHJvdW5kID49IGgucm91bmQpIHsKICAgICAgaC5yb3VuZCA9IHJvdW5kCiAgICAgIHAudXBkYXRlUmVtb3RlKHsgcHVuY2hpbmcsIGZpcmV3YWxsLCBhZGRyZXNzZXMsIHZlcmlmaWVkOiBlY2hvZWQgPyBwZWVyQWRkcmVzcy5ob3N0IDogbnVsbCB9KQogICAgfQoKICAgIC8vIFdhaXQgZm9yIHRoZSBhbmFseXplciB0byByZWFjaCBhIGNvbmNsdXNpb24uLi4KICAgIGxldCBzdGFibGUgPSBhd2FpdCBwLmFuYWx5emUoZmFsc2UpCiAgICBpZiAocC5kZXN0cm95ZWQpIHJldHVybiBudWxsCgogICAgaWYgKCFwLnJlbW90ZUhvbGVwdW5jaGluZyAmJiAhc3RhYmxlKSB7CiAgICAgIHN0YWJsZSA9IGF3YWl0IHAuYW5hbHl6ZSh0cnVlKQogICAgICBpZiAocC5kZXN0cm95ZWQpIHJldHVybiBudWxsCiAgICAgIGlmICghc3RhYmxlKSByZXR1cm4gdGhpcy5fYWJvcnQoaCkKICAgIH0KCiAgICAvLyBGYXN0IG1vZGUhIElmIHdlIGFyZSBjb25zaXN0ZW50IGFuZCB0aGUgcmVtb3RlIGhhcyBvcGVuZWQgYSBzZXNzaW9uIHRvIHVzIChyZW1vdGVBZGRyZXNzKQogICAgLy8gdGhlbiBmaXJlIGEgcXVpY2sgcHVuY2ggYmFjay4gTm90ZSB0aGUgYXdhaXQgaGVyZSBqdXN0IHdhaXRzIGZvciB0aGUgdWRwIHNvY2tldCB0byBmbHVzaC4KICAgIGlmICgKICAgICAgaXNDb25zaXN0ZW50KHAubmF0LmZpcmV3YWxsKSAmJgogICAgICByZW1vdGVBZGRyZXNzICYmCiAgICAgIGhhc1NhbWVBZGRyKHAubmF0LmFkZHJlc3NlcywgcmVtb3RlQWRkcmVzcykKICAgICkgewogICAgICBhd2FpdCBwLnBpbmcocGVlckFkZHJlc3MpCiAgICAgIGlmIChwLmRlc3Ryb3llZCkgcmV0dXJuIG51bGwKICAgIH0KCiAgICAvLyBSZW1vdGUgc2FpZCB0aGV5IGFyZSBwdW5jaGluZyAob3Igd2lsbGluZyB0byksIHNvIHdlIHdpbGwgcHVuY2ggYXMgd2VsbC4KICAgIC8vIE5vdGUgdGhhdCB0aGlzIHJldHVybnMgd2hlbiB0aGUgcHVuY2hpbmcgaGFzIFNUQVJURUQsIHNvIG5vIGd1YXJhbnRlZQogICAgLy8gd2Ugd2lsbCBoYXZlIGEgY29ubmVjdGlvbiBhZnRlciB0aGlzIHByb21pc2UgZXRjLgogICAgaWYgKHAucmVtb3RlSG9sZXB1bmNoaW5nKSB7CiAgICAgIC8vIFRPRE86IHN0aWxsIGNvbnRpbnVlIGhlcmUgaWYgYSBsb2NhbCBjb25uZWN0aW9uIG1pZ2h0IHdvcmssIGJ1dCB0aGVuIGRvIG5vdCBob2xlcHVuY2guLi4KICAgICAgaWYgKCF0aGlzLmhvbGVwdW5jaChwLnJlbW90ZUZpcmV3YWxsLCBwLm5hdC5maXJld2FsbCwgcC5yZW1vdGVBZGRyZXNzZXMsIHAubmF0LmFkZHJlc3NlcykpIHsKICAgICAgICByZXR1cm4gcC5kZXN0cm95ZWQgPyBudWxsIDogdGhpcy5fYWJvcnQoaCkKICAgICAgfQoKICAgICAgaWYgKGgucHJlcHVuY2hpbmcpIHsKICAgICAgICBjbGVhclRpbWVvdXQoaC5wcmVwdW5jaGluZykKICAgICAgICBoLnByZXB1bmNoaW5nID0gbnVsbAogICAgICB9CgogICAgICBpZiAocC5yZW1vdGVGaXJld2FsbCA+PSBGSVJFV0FMTC5SQU5ET00gfHwgcC5uYXQuZmlyZXdhbGwgPj0gRklSRVdBTEwuUkFORE9NKSB7CiAgICAgICAgaWYgKAogICAgICAgICAgdGhpcy5kaHQuX3JhbmRvbVB1bmNoZXMgPj0gdGhpcy5kaHQuX3JhbmRvbVB1bmNoTGltaXQgfHwKICAgICAgICAgIERhdGUubm93KCkgLSB0aGlzLmRodC5fbGFzdFJhbmRvbVB1bmNoIDwgdGhpcy5kaHQuX3JhbmRvbVB1bmNoSW50ZXJ2YWwKICAgICAgICApIHsKICAgICAgICAgIGlmICghaC5yZWxheVRva2VuKSByZXR1cm4gdGhpcy5fYWJvcnQoaCwgRVJST1IuVFJZX0xBVEVSKQogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgc29ja2V0OiBwLnNvY2tldCwKICAgICAgICAgICAgcGF5bG9hZDogaC5wYXlsb2FkLmVuY3J5cHQoewogICAgICAgICAgICAgIGVycm9yOiBFUlJPUi5UUllfTEFURVIsCiAgICAgICAgICAgICAgZmlyZXdhbGw6IHAubmF0LmZpcmV3YWxsLAogICAgICAgICAgICAgIHJvdW5kOiBoLnJvdW5kLAogICAgICAgICAgICAgIGNvbm5lY3RlZDogcC5jb25uZWN0ZWQsCiAgICAgICAgICAgICAgcHVuY2hpbmc6IHAucHVuY2hpbmcsCiAgICAgICAgICAgICAgYWRkcmVzc2VzOiBwLm5hdC5hZGRyZXNzZXMsCiAgICAgICAgICAgICAgcmVtb3RlQWRkcmVzczogbnVsbCwKICAgICAgICAgICAgICB0b2tlbjogaXNTZXJ2ZXJSZWxheSA/IHRva2VuIDogbnVsbCwKICAgICAgICAgICAgICByZW1vdGVUb2tlbjogcmVtb3RlUGF5bG9hZC50b2tlbgogICAgICAgICAgICB9KQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgcHVuY2hpbmcgPSBhd2FpdCBwLnB1bmNoKCkKICAgICAgaWYgKHAuZGVzdHJveWVkKSByZXR1cm4gbnVsbAogICAgICBpZiAoIXB1bmNoaW5nKSByZXR1cm4gdGhpcy5fYWJvcnQoaCkKICAgIH0KCiAgICAvLyBGcmVlemUgdGhhdCBhbmFseXNpcyBhcyBzb29uIGFzIHdlIGhhdmUgYSByZXN1bHQgd2UgYXJlIGdpdmluZyB0byB0aGUgb3RoZXIgcGVlcgogICAgaWYgKHAubmF0LmZpcmV3YWxsICE9PSBGSVJFV0FMTC5VTktOT1dOKSB7CiAgICAgIHAubmF0LmZyZWV6ZSgpCiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgc29ja2V0OiBwLnNvY2tldCwKICAgICAgcGF5bG9hZDogaC5wYXlsb2FkLmVuY3J5cHQoewogICAgICAgIGVycm9yOiBFUlJPUi5OT05FLAogICAgICAgIGZpcmV3YWxsOiBwLm5hdC5maXJld2FsbCwKICAgICAgICByb3VuZDogaC5yb3VuZCwKICAgICAgICBjb25uZWN0ZWQ6IHAuY29ubmVjdGVkLAogICAgICAgIHB1bmNoaW5nOiBwLnB1bmNoaW5nLAogICAgICAgIGFkZHJlc3NlczogcC5uYXQuYWRkcmVzc2VzLAogICAgICAgIHJlbW90ZUFkZHJlc3M6IG51bGwsCiAgICAgICAgdG9rZW46IGlzU2VydmVyUmVsYXkgPyB0b2tlbiA6IG51bGwsCiAgICAgICAgcmVtb3RlVG9rZW46IHJlbW90ZVBheWxvYWQudG9rZW4KICAgICAgfSkKICAgIH0KICB9CgogIF9hYm9ydChoLCBlcnJvciA9IEVSUk9SLkFCT1JURUQpIHsKICAgIGlmICghaC5wYXlsb2FkKSB7CiAgICAgIGlmIChoLnB1bmNoZXIpIGgucHVuY2hlci5kZXN0cm95KCkKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBjb25zdCBwYXlsb2FkID0gaC5wYXlsb2FkLmVuY3J5cHQoewogICAgICBlcnJvciwKICAgICAgZmlyZXdhbGw6IEZJUkVXQUxMLlVOS05PV04sCiAgICAgIHJvdW5kOiBoLnJvdW5kLAogICAgICBjb25uZWN0ZWQ6IGZhbHNlLAogICAgICBwdW5jaGluZzogZmFsc2UsCiAgICAgIGFkZHJlc3NlczogbnVsbCwKICAgICAgcmVtb3RlQWRkcmVzczogbnVsbCwKICAgICAgdG9rZW46IG51bGwsCiAgICAgIHJlbW90ZVRva2VuOiBudWxsCiAgICB9KQoKICAgIGgucHVuY2hlci5kZXN0cm95KCkKCiAgICByZXR1cm4geyBzb2NrZXQ6IHRoaXMuZGh0LnNvY2tldCwgcGF5bG9hZCB9CiAgfQoKICBfcmVsYXlDb25uZWN0aW9uKGhzLCByZWxheVRocm91Z2gsIHJlbW90ZVBheWxvYWQsIGgpIHsKICAgIHRoaXMuZGh0LnN0YXRzLnJlbGF5aW5nLmF0dGVtcHRzKysKCiAgICBsZXQgaXNJbml0aWF0b3IKICAgIGxldCBwdWJsaWNLZXkKICAgIGxldCB0b2tlbgoKICAgIGlmIChyZWxheVRocm91Z2gpIHsKICAgICAgaXNJbml0aWF0b3IgPSB0cnVlCiAgICAgIHB1YmxpY0tleSA9IHJlbGF5VGhyb3VnaAogICAgICB0b2tlbiA9IGhzLnJlbGF5VG9rZW4KICAgIH0gZWxzZSB7CiAgICAgIGlzSW5pdGlhdG9yID0gZmFsc2UKICAgICAgcHVibGljS2V5ID0gcmVtb3RlUGF5bG9hZC5yZWxheVRocm91Z2gucHVibGljS2V5CiAgICAgIHRva2VuID0gcmVtb3RlUGF5bG9hZC5yZWxheVRocm91Z2gudG9rZW4KICAgIH0KCiAgICBocy5yZWxheVRva2VuID0gdG9rZW4KICAgIGhzLnJlbGF5U29ja2V0ID0gdGhpcy5kaHQuY29ubmVjdChwdWJsaWNLZXkpCiAgICBocy5yZWxheVNvY2tldC5zZXRLZWVwQWxpdmUodGhpcy5yZWxheUtlZXBBbGl2ZSkKICAgIGhzLnJlbGF5Q2xpZW50ID0gcmVsYXkuQ2xpZW50LmZyb20oaHMucmVsYXlTb2NrZXQsIHsgaWQ6IGhzLnJlbGF5U29ja2V0LnB1YmxpY0tleSB9KQogICAgaHMucmVsYXlUaW1lb3V0ID0gc2V0VGltZW91dChvbmFib3J0LCAxNTAwMCkKCiAgICBocy5yZWxheUNsaWVudAogICAgICAucGFpcihpc0luaXRpYXRvciwgdG9rZW4sIGhzLnJhd1N0cmVhbSkKICAgICAgLm9uKCdlcnJvcicsIG9uYWJvcnQpCiAgICAgIC5vbignZGF0YScsIChyZW1vdGVJZCkgPT4gewogICAgICAgIGlmIChocy5yZWxheVRpbWVvdXQpIGNsZWFyUmVsYXlUaW1lb3V0KGhzKQogICAgICAgIGlmIChocy5yYXdTdHJlYW0gPT09IG51bGwpIHsKICAgICAgICAgIG9uYWJvcnQobnVsbCkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgaHMucmVsYXlQYWlyZWQgPSB0cnVlCiAgICAgICAgdGhpcy5kaHQuc3RhdHMucmVsYXlpbmcuc3VjY2Vzc2VzKysKCiAgICAgICAgaWYgKGhzLnByZXB1bmNoaW5nKSBjbGVhclRpbWVvdXQoaHMucHJlcHVuY2hpbmcpCiAgICAgICAgaHMucHJlcHVuY2hpbmcgPSBudWxsCgogICAgICAgIGNvbnN0IHsgcmVtb3RlUG9ydCwgcmVtb3RlSG9zdCwgc29ja2V0IH0gPSBocy5yZWxheVNvY2tldC5yYXdTdHJlYW0KCiAgICAgICAgaHMucmF3U3RyZWFtCiAgICAgICAgICAub24oJ2Nsb3NlJywgKCkgPT4gaHMucmVsYXlTb2NrZXQuZGVzdHJveSgpKQogICAgICAgICAgLmNvbm5lY3Qoc29ja2V0LCByZW1vdGVJZCwgcmVtb3RlUG9ydCwgcmVtb3RlSG9zdCkKCiAgICAgICAgaHMuZW5jcnlwdGVkU29ja2V0ID0gdGhpcy5jcmVhdGVTZWNyZXRTdHJlYW0oZmFsc2UsIGhzLnJhd1N0cmVhbSwgeyBoYW5kc2hha2U6IGggfSkKCiAgICAgICAgdGhpcy5vbmNvbm5lY3Rpb24oaHMuZW5jcnlwdGVkU29ja2V0KQogICAgICB9KQoKICAgIGNvbnN0IGRodCA9IHRoaXMuZGh0CiAgICBmdW5jdGlvbiBvbmFib3J0KCkgewogICAgICBpZiAoIWhzLnJlbGF5UGFpcmVkKSBkaHQuc3RhdHMucmVsYXlpbmcuYWJvcnRzKysKICAgICAgaWYgKGhzLnJlbGF5VGltZW91dCkgY2xlYXJSZWxheVRpbWVvdXQoaHMpCiAgICAgIGNvbnN0IHNvY2tldCA9IGhzLnJlbGF5U29ja2V0CiAgICAgIGhzLnJlbGF5VG9rZW4gPSBudWxsCiAgICAgIGhzLnJlbGF5U29ja2V0ID0gbnVsbAogICAgICBpZiAoc29ja2V0KSBzb2NrZXQuZGVzdHJveSgpCiAgICAgIGlmIChocy5hYm9ydGVkICYmIGhzLnJhd1N0cmVhbSkgaHMucmF3U3RyZWFtLmRlc3Ryb3koKQogICAgfQogIH0KfQoKZnVuY3Rpb24gY2xlYXJSZWxheVRpbWVvdXQoaHMpIHsKICBjbGVhclRpbWVvdXQoaHMucmVsYXlUaW1lb3V0KQogIGhzLnJlbGF5VGltZW91dCA9IG51bGwKfQoKZnVuY3Rpb24gaXNDb25zaXN0ZW50KGZ3KSB7CiAgcmV0dXJuIGZ3ID09PSBGSVJFV0FMTC5PUEVOIHx8IGZ3ID09PSBGSVJFV0FMTC5DT05TSVNURU5UCn0KCmZ1bmN0aW9uIGhhc1NhbWVBZGRyKGFkZHJzLCBvdGhlcikgewogIGlmIChhZGRycyA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogIGZvciAoY29uc3QgYWRkciBvZiBhZGRycykgewogICAgaWYgKGFkZHIucG9ydCA9PT0gb3RoZXIucG9ydCAmJiBhZGRyLmhvc3QgPT09IG90aGVyLmhvc3QpIHJldHVybiB0cnVlCiAgfQogIHJldHVybiBmYWxzZQp9CgpmdW5jdGlvbiBkZWZhdWx0Q3JlYXRlSGFuZHNoYWtlKGtleVBhaXIsIHJlbW90ZVB1YmxpY0tleSkgewogIHJldHVybiBuZXcgTm9pc2VXcmFwKGtleVBhaXIsIHJlbW90ZVB1YmxpY0tleSkKfQoKZnVuY3Rpb24gZGVmYXVsdENyZWF0ZVNlY3JldFN0cmVhbShpc0luaXRpYXRvciwgcmF3U3RyZWFtLCBvcHRzKSB7CiAgcmV0dXJuIG5ldyBOb2lzZVNlY3JldFN0cmVhbShpc0luaXRpYXRvciwgcmF3U3RyZWFtLCBvcHRzKQp9CgpmdW5jdGlvbiBvbmx5UHJpdmF0ZUhvc3RzKGFkZHIpIHsKICByZXR1cm4gaXNQcml2YXRlKGFkZHIuaG9zdCkKfQoKZnVuY3Rpb24gaXNSZWxheShyZWxheVNvY2tldCwgc29ja2V0LCBwb3J0LCBob3N0KSB7CiAgY29uc3Qgc3RyZWFtID0gcmVsYXlTb2NrZXQucmF3U3RyZWFtCiAgaWYgKCFzdHJlYW0pIHJldHVybiBmYWxzZQogIGlmIChzdHJlYW0uc29ja2V0ICE9PSBzb2NrZXQpIHJldHVybiBmYWxzZQogIHJldHVybiBwb3J0ID09PSBzdHJlYW0ucmVtb3RlUG9ydCAmJiBob3N0ID09PSBzdHJlYW0ucmVtb3RlSG9zdAp9CgpmdW5jdGlvbiBzZWxlY3RSZWxheShyZWxheVRocm91Z2gpIHsKICBpZiAodHlwZW9mIHJlbGF5VGhyb3VnaCA9PT0gJ2Z1bmN0aW9uJykgcmVsYXlUaHJvdWdoID0gcmVsYXlUaHJvdWdoKCkKICBpZiAocmVsYXlUaHJvdWdoID09PSBudWxsKSByZXR1cm4gbnVsbAogIGlmIChBcnJheS5pc0FycmF5KHJlbGF5VGhyb3VnaCkpIHsKICAgIHJldHVybiByZWxheVRocm91Z2hbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogcmVsYXlUaHJvdWdoLmxlbmd0aCldCiAgfQogIHJldHVybiByZWxheVRocm91Z2gKfQoKZnVuY3Rpb24gbm9vcCgpIHt9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU2xlZXBlciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLl90aW1lb3V0ID0gbnVsbAogICAgdGhpcy5fcmVzb2x2ZSA9IG51bGwKCiAgICB0aGlzLl9zdGFydCA9IChyZXNvbHZlKSA9PiB7CiAgICAgIHRoaXMuX3Jlc29sdmUgPSByZXNvbHZlCiAgICB9CgogICAgdGhpcy5fdHJpZ2dlciA9ICgpID0+IHsKICAgICAgaWYgKHRoaXMuX3Jlc29sdmUgPT09IG51bGwpIHJldHVybgogICAgICBjb25zdCByZXNvbHZlID0gdGhpcy5fcmVzb2x2ZQogICAgICB0aGlzLl90aW1lb3V0ID0gbnVsbAogICAgICB0aGlzLl9yZXNvbHZlID0gbnVsbAogICAgICByZXNvbHZlKCkKICAgIH0KICB9CgogIHBhdXNlKG1zKSB7CiAgICBjb25zdCBwID0gbmV3IFByb21pc2UodGhpcy5fc3RhcnQpCiAgICBpZiAodGhpcy5fdGltZW91dCAhPT0gbnVsbCkgewogICAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZW91dCkKICAgICAgdGhpcy5fdHJpZ2dlcigpCiAgICB9CiAgICB0aGlzLl90aW1lb3V0ID0gc2V0VGltZW91dCh0aGlzLl90cmlnZ2VyLCBtcykKICAgIHJldHVybiBwCiAgfQoKICByZXN1bWUoKSB7CiAgICBpZiAodGhpcy5fdGltZW91dCAhPT0gbnVsbCkgewogICAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZW91dCkKICAgICAgdGhpcy5fdHJpZ2dlcigpCiAgICB9CiAgfQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBMSU5HRVJfVElNRSA9IDMwMDAKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU29ja2V0UG9vbCB7CiAgY29uc3RydWN0b3IoZGh0LCBob3N0KSB7CiAgICB0aGlzLl9kaHQgPSBkaHQKICAgIHRoaXMuX3NvY2tldHMgPSBuZXcgTWFwKCkKICAgIHRoaXMuX2xpbmdlcmluZyA9IG5ldyBTZXQoKSAvLyB1cGRhdGVkIGJ5IHRoZSByZWYKICAgIHRoaXMuX2hvc3QgPSBob3N0CgogICAgdGhpcy5yb3V0ZXMgPSBuZXcgU29ja2V0Um91dGVzKHRoaXMpCiAgfQoKICBfb25tZXNzYWdlKHJlZiwgZGF0YSwgYWRkcmVzcykgewogICAgdGhpcy5fZGh0Lm9ubWVzc2FnZShyZWYuc29ja2V0LCBkYXRhLCBhZGRyZXNzKQogIH0KCiAgX2FkZChyZWYpIHsKICAgIHRoaXMuX3NvY2tldHMuc2V0KHJlZi5zb2NrZXQsIHJlZikKICB9CgogIF9yZW1vdmUocmVmKSB7CiAgICB0aGlzLl9zb2NrZXRzLmRlbGV0ZShyZWYuc29ja2V0KQogICAgdGhpcy5fbGluZ2VyaW5nLmRlbGV0ZShyZWYpCiAgfQoKICBsb29rdXAoc29ja2V0KSB7CiAgICByZXR1cm4gdGhpcy5fc29ja2V0cy5nZXQoc29ja2V0KSB8fCBudWxsCiAgfQoKICBzZXRSZXVzYWJsZShzb2NrZXQsIGJvb2wpIHsKICAgIGNvbnN0IHJlZiA9IHRoaXMubG9va3VwKHNvY2tldCkKICAgIGlmIChyZWYpIHJlZi5yZXVzYWJsZSA9IGJvb2wKICB9CgogIGFjcXVpcmUoKSB7CiAgICAvLyBUT0RPOiBFbmFibGUgc29ja2V0IHJldXNlCiAgICByZXR1cm4gbmV3IFNvY2tldFJlZih0aGlzKQogIH0KCiAgYXN5bmMgZGVzdHJveSgpIHsKICAgIGNvbnN0IGNsb3NpbmcgPSBbXQoKICAgIGZvciAoY29uc3QgcmVmIG9mIHRoaXMuX3NvY2tldHMudmFsdWVzKCkpIHsKICAgICAgcmVmLl91bmxpbmdlcigpCiAgICAgIGNsb3NpbmcucHVzaChyZWYuc29ja2V0LmNsb3NlKCkpCiAgICB9CgogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKGNsb3NpbmcpCiAgfQp9CgpjbGFzcyBTb2NrZXRSb3V0ZXMgewogIGNvbnN0cnVjdG9yKHBvb2wpIHsKICAgIHRoaXMuX3Bvb2wgPSBwb29sCiAgICB0aGlzLl9yb3V0ZXMgPSBuZXcgTWFwKCkKICB9CgogIGFkZChwdWJsaWNLZXksIHJhd1N0cmVhbSkgewogICAgaWYgKHJhd1N0cmVhbS5zb2NrZXQpIHRoaXMuX29uY29ubmVjdChwdWJsaWNLZXksIHJhd1N0cmVhbSkKICAgIGVsc2UgcmF3U3RyZWFtLm9uKCdjb25uZWN0JywgdGhpcy5fb25jb25uZWN0LmJpbmQodGhpcywgcHVibGljS2V5LCByYXdTdHJlYW0pKQogIH0KCiAgZ2V0KHB1YmxpY0tleSkgewogICAgY29uc3QgaWQgPSBiNGEudG9TdHJpbmcocHVibGljS2V5LCAnaGV4JykKICAgIGNvbnN0IHJvdXRlID0gdGhpcy5fcm91dGVzLmdldChpZCkKICAgIGlmICghcm91dGUpIHJldHVybiBudWxsCiAgICByZXR1cm4gcm91dGUKICB9CgogIF9vbmNvbm5lY3QocHVibGljS2V5LCByYXdTdHJlYW0pIHsKICAgIGNvbnN0IGlkID0gYjRhLnRvU3RyaW5nKHB1YmxpY0tleSwgJ2hleCcpCiAgICBjb25zdCBzb2NrZXQgPSByYXdTdHJlYW0uc29ja2V0CgogICAgbGV0IHJvdXRlID0gdGhpcy5fcm91dGVzLmdldChpZCkKCiAgICBpZiAoIXJvdXRlKSB7CiAgICAgIGNvbnN0IGdjID0gKCkgPT4gewogICAgICAgIGlmICh0aGlzLl9yb3V0ZXMuZ2V0KGlkKSA9PT0gcm91dGUpIHRoaXMuX3JvdXRlcy5kZWxldGUoaWQpCiAgICAgICAgc29ja2V0LnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIGdjKQogICAgICB9CgogICAgICByb3V0ZSA9IHsKICAgICAgICBzb2NrZXQsCiAgICAgICAgYWRkcmVzczogeyBob3N0OiByYXdTdHJlYW0ucmVtb3RlSG9zdCwgcG9ydDogcmF3U3RyZWFtLnJlbW90ZVBvcnQgfSwKICAgICAgICBnYwogICAgICB9CgogICAgICB0aGlzLl9yb3V0ZXMuc2V0KGlkLCByb3V0ZSkKICAgICAgc29ja2V0Lm9uKCdjbG9zZScsIGdjKQogICAgfQoKICAgIHRoaXMuX3Bvb2wuc2V0UmV1c2FibGUoc29ja2V0LCB0cnVlKQoKICAgIHJhd1N0cmVhbS5vbignZXJyb3InLCAoKSA9PiB7CiAgICAgIHRoaXMuX3Bvb2wuc2V0UmV1c2FibGUoc29ja2V0LCBmYWxzZSkKICAgICAgaWYgKCFyb3V0ZSkgcm91dGUgPSB0aGlzLl9yb3V0ZXMuZ2V0KGlkKQogICAgICBpZiAocm91dGUgJiYgcm91dGUuc29ja2V0ID09PSBzb2NrZXQpIHJvdXRlLmdjKCkKICAgIH0pCiAgfQp9CgovLyBUT0RPOiB3ZSBzaG91bGQganVzdCBtYWtlIHNvbWUgInVzZXIgZGF0YSIgb2JqZWN0IG9uIHVkeCB0byBhbGxvdyB0byBhdHRhY2ggdGhpcyBpbmZvCmNsYXNzIFNvY2tldFJlZiB7CiAgY29uc3RydWN0b3IocG9vbCkgewogICAgdGhpcy5fcG9vbCA9IHBvb2wKCiAgICAvLyBFdmVudHMKICAgIHRoaXMub25ob2xlcHVuY2htZXNzYWdlID0gbm9vcAoKICAgIC8vIFdoZXRoZXIgaXQgc2hvdWxkIHRlYXJkb3duIGltbWVkaWF0ZWx5IG9yIHdhaXQgYSBiaXQKICAgIHRoaXMucmV1c2FibGUgPSBmYWxzZQoKICAgIHRoaXMuc29ja2V0ID0gcG9vbC5fZGh0LnVkeC5jcmVhdGVTb2NrZXQoKQogICAgdGhpcy5zb2NrZXQKICAgICAgLm9uKCdjbG9zZScsIHRoaXMuX29uY2xvc2UuYmluZCh0aGlzKSkKICAgICAgLm9uKCdtZXNzYWdlJywgdGhpcy5fb25tZXNzYWdlLmJpbmQodGhpcykpCiAgICAgIC5vbignaWRsZScsIHRoaXMuX29uaWRsZS5iaW5kKHRoaXMpKQogICAgICAub24oJ2J1c3knLCB0aGlzLl9vbmJ1c3kuYmluZCh0aGlzKSkKICAgICAgLmJpbmQoMCwgdGhpcy5fcG9vbC5faG9zdCkKCiAgICB0aGlzLl9yZWZzID0gMQogICAgdGhpcy5fcmVsZWFzZWQgPSBmYWxzZQogICAgdGhpcy5fY2xvc2VkID0gZmFsc2UKCiAgICB0aGlzLl90aW1lb3V0ID0gbnVsbAogICAgdGhpcy5fd2FzQnVzeSA9IGZhbHNlCgogICAgdGhpcy5fcG9vbC5fYWRkKHRoaXMpCiAgfQoKICBfb25jbG9zZSgpIHsKICAgIHRoaXMuX3Bvb2wuX3JlbW92ZSh0aGlzKQogIH0KCiAgX29ubWVzc2FnZShkYXRhLCBhZGRyZXNzKSB7CiAgICBpZiAoZGF0YS5ieXRlTGVuZ3RoID4gMSkgewogICAgICB0aGlzLl9wb29sLl9vbm1lc3NhZ2UodGhpcywgZGF0YSwgYWRkcmVzcykKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMub25ob2xlcHVuY2htZXNzYWdlKGRhdGEsIGFkZHJlc3MsIHRoaXMpCiAgICB9CiAgfQoKICBfb25pZGxlKCkgewogICAgdGhpcy5fY2xvc2VNYXliZSgpCiAgfQoKICBfb25idXN5KCkgewogICAgdGhpcy5fd2FzQnVzeSA9IHRydWUKICAgIHRoaXMuX3VubGluZ2VyKCkKICB9CgogIF9yZXNldCgpIHsKICAgIHRoaXMub25ob2xlcHVuY2htZXNzYWdlID0gbm9vcAogIH0KCiAgX2Nsb3NlTWF5YmUoKSB7CiAgICBpZiAodGhpcy5fcmVmcyA9PT0gMCAmJiB0aGlzLnNvY2tldC5pZGxlICYmICF0aGlzLl90aW1lb3V0KSB0aGlzLl9jbG9zZSgpCiAgfQoKICBfbGluZ2VyaW5nQ2xvc2UoKSB7CiAgICB0aGlzLl9wb29sLl9saW5nZXJpbmcuZGVsZXRlKHRoaXMpCiAgICB0aGlzLl90aW1lb3V0ID0gbnVsbAogICAgdGhpcy5fY2xvc2VNYXliZSgpCiAgfQoKICBfY2xvc2UoKSB7CiAgICB0aGlzLl91bmxpbmdlcigpCgogICAgaWYgKHRoaXMucmV1c2FibGUgJiYgdGhpcy5fd2FzQnVzeSkgewogICAgICB0aGlzLl93YXNCdXN5ID0gZmFsc2UKICAgICAgdGhpcy5fcG9vbC5fbGluZ2VyaW5nLmFkZCh0aGlzKQogICAgICB0aGlzLl90aW1lb3V0ID0gc2V0VGltZW91dCh0aGlzLl9saW5nZXJpbmdDbG9zZS5iaW5kKHRoaXMpLCBMSU5HRVJfVElNRSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5fY2xvc2VkID0gdHJ1ZQogICAgdGhpcy5zb2NrZXQuY2xvc2UoKQogIH0KCiAgX3VubGluZ2VyKCkgewogICAgaWYgKHRoaXMuX3RpbWVvdXQgIT09IG51bGwpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVvdXQpCiAgICAgIHRoaXMuX3Bvb2wuX2xpbmdlcmluZy5kZWxldGUodGhpcykKICAgICAgdGhpcy5fdGltZW91dCA9IG51bGwKICAgIH0KICB9CgogIGdldCBmcmVlKCkgewogICAgcmV0dXJuIHRoaXMuX3JlZnMgPT09IDAKICB9CgogIGFjdGl2ZSgpIHsKICAgIHRoaXMuX3JlZnMrKwogICAgdGhpcy5fdW5saW5nZXIoKQogIH0KCiAgaW5hY3RpdmUoKSB7CiAgICB0aGlzLl9yZWZzLS0KICAgIHRoaXMuX2Nsb3NlTWF5YmUoKQogIH0KCiAgYWRkcmVzcygpIHsKICAgIHJldHVybiB0aGlzLnNvY2tldC5hZGRyZXNzKCkKICB9CgogIHJlbGVhc2UoKSB7CiAgICBpZiAodGhpcy5fcmVsZWFzZWQpIHJldHVybgoKICAgIHRoaXMuX3JlbGVhc2VkID0gdHJ1ZQogICAgdGhpcy5fcmVzZXQoKQoKICAgIHRoaXMuX3JlZnMtLQogICAgdGhpcy5fY2xvc2VNYXliZSgpCiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KewogICJuYW1lIjogImh5cGVyZGh0IiwKICAidmVyc2lvbiI6ICI2LjI3LjEiLAogICJkZXNjcmlwdGlvbiI6ICJUaGUgREhUIHBvd2VyaW5nIEh5cGVyc3dhcm0iLAogICJtYWluIjogImluZGV4LmpzIiwKICAiYnJvd3NlciI6ICJicm93c2VyLmpzIiwKICAiYmluIjogewogICAgImh5cGVyZGh0IjogIi4vYmluLmpzIgogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJicm93c2VyLmpzIiwKICAgICJ0ZXN0bmV0LmpzIiwKICAgICJiaW4uanMiLAogICAgImxpYi8qKi5qcyIKICBdLAogICJpbXBvcnRzIjogewogICAgImV2ZW50cyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1ldmVudHMiLAogICAgICAiZGVmYXVsdCI6ICJldmVudHMiCiAgICB9LAogICAgImNoaWxkX3Byb2Nlc3MiOiB7CiAgICAgICJiYXJlIjogImJhcmUtbm9kZS1jaGlsZC1wcm9jZXNzIiwKICAgICAgImRlZmF1bHQiOiAiY2hpbGRfcHJvY2VzcyIKICAgIH0KICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbSI6ICJeNi42LjIiLAogICAgImI0YSI6ICJeMS4zLjEiLAogICAgImJhcmUtZXZlbnRzIjogIl4yLjIuMCIsCiAgICAiYmxpbmQtcmVsYXkiOiAiXjEuMy4wIiwKICAgICJib2dvbiI6ICJeMS4wLjAiLAogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuNC4xIiwKICAgICJjb21wYWN0LWVuY29kaW5nLW5ldCI6ICJeMS4wLjEiLAogICAgImRodC1ycGMiOiAiXjYuMTUuMSIsCiAgICAiaHlwZXJjb3JlLWNyeXB0byI6ICJeMy4zLjAiLAogICAgImh5cGVyY29yZS1pZC1lbmNvZGluZyI6ICJeMS4yLjAiLAogICAgIm5vaXNlLWN1cnZlLWVkIjogIl4yLjAuMCIsCiAgICAibm9pc2UtaGFuZHNoYWtlIjogIl40LjAuMCIsCiAgICAicmVjb3JkLWNhY2hlIjogIl4xLjEuMSIsCiAgICAic2FmZXR5LWNhdGNoIjogIl4xLjAuMSIsCiAgICAic2lnbmFsLXByb21pc2UiOiAiXjEuMC4zIiwKICAgICJzb2RpdW0tdW5pdmVyc2FsIjogIl41LjAuMSIsCiAgICAic3RyZWFteCI6ICJeMi4xNi4xIiwKICAgICJ1bnNsYWIiOiAiXjEuMy4wIiwKICAgICJ4YWNoZSI6ICJeMS4xLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtbm9kZS1jaGlsZC1wcm9jZXNzIjogIl4xLjAuMSIsCiAgICAiYnJpdHRsZSI6ICJeMy4wLjAiLAogICAgImdyYWNlZnVsLWdvb2RieWUiOiAiXjEuMy4wIiwKICAgICJuZXdsaW5lLWRlY29kZXIiOiAiXjEuMC4yIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAidGVzdCI6ICJwcmV0dGllciAtLWNoZWNrIC4gJiYgbm9kZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC9hbGwuanMiLAogICAgInRlc3Q6Z2VuZXJhdGUiOiAiYnJpdHRsZSAtciB0ZXN0L2FsbC5qcyB0ZXN0LyouanMiLAogICAgImludGVncmF0aW9uIjogImJyaXR0bGUgdGVzdC9pbnRlZ3JhdGlvbi8qLmpzIiwKICAgICJlbmQtdG8tZW5kIjogImJyaXR0bGUgdGVzdC9lbmQtdG8tZW5kLyouanMiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImRpcmVjdG9yaWVzIjogewogICAgImxpYiI6ICJsaWIiLAogICAgInRlc3QiOiAidGVzdCIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmRodC5naXQiCiAgfSwKICAia2V5d29yZHMiOiBbXSwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyZGh0L2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJkaHQjcmVhZG1lIgp9CnsKICAibmFtZSI6ICJoeXBlcnNjaGVtYSIsCiAgInZlcnNpb24iOiAiMS4xOC4wIiwKICAiZGVzY3JpcHRpb24iOiAiQ3JlYXRlIHJlZ2lzdHJpZXMgb2YgZGVjbGFyYXRpdmUgY29tcGFjdC1lbmNvZGluZyBzY2hlbWFzIiwKICAiZmlsZXMiOiBbCiAgICAibGliLyouanMiLAogICAgImJ1aWxkZXIubWpzIiwKICAgICJidWlsZGVyLmNqcyIsCiAgICAicnVudGltZS5tanMiLAogICAgInJ1bnRpbWUuY2pzIiwKICAgICJwcmltaXRpdmVzLm1qcyIsCiAgICAicHJpbWl0aXZlcy5janMiCiAgXSwKICAiZXhwb3J0cyI6IHsKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4iOiB7CiAgICAgICJpbXBvcnQiOiAiLi9idWlsZGVyLm1qcyIsCiAgICAgICJkZWZhdWx0IjogIi4vYnVpbGRlci5janMiCiAgICB9LAogICAgIi4vcnVudGltZSI6IHsKICAgICAgImltcG9ydCI6ICIuL3J1bnRpbWUubWpzIiwKICAgICAgImRlZmF1bHQiOiAiLi9ydW50aW1lLmNqcyIKICAgIH0sCiAgICAiLi9wcmltaXRpdmVzIjogewogICAgICAiaW1wb3J0IjogIi4vcHJpbWl0aXZlcy5tanMiLAogICAgICAiZGVmYXVsdCI6ICIuL3ByaW1pdGl2ZXMuY2pzIgogICAgfQogIH0sCiAgImltcG9ydHMiOiB7CiAgICAiZnMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZnMiLAogICAgICAiZGVmYXVsdCI6ICJmcyIKICAgIH0sCiAgICAicGF0aCI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1wYXRoIiwKICAgICAgImRlZmF1bHQiOiAicGF0aCIKICAgIH0KICB9LAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAuIC0td3JpdGUiLAogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJyaXR0bGUgdGVzdC9pbmRleC5qcyIsCiAgICAidGVzdDpiYXJlIjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBiYXJlIHRlc3QvaW5kZXguanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJzY2hlbWEuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJzY2hlbWEvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcnNjaGVtYSNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1mcyI6ICJeNC4wLjEiLAogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuMTUuMCIsCiAgICAiZ2VuZXJhdGUtb2JqZWN0LXByb3BlcnR5IjogIl4yLjAuMCIsCiAgICAiZ2VuZXJhdGUtc3RyaW5nIjogIl4xLjAuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy43LjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMS4wLjAiLAogICAgInRlc3QtdG1wIjogIl4xLjMuMCIKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSB7CiAgYzogcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCn0KY29uc3QgeyBFdmVudEVtaXR0ZXIgfSA9IHJlcXVpcmUoJ2V2ZW50cycpCmNvbnN0IHsgZ2V0U3RyZWFtRXJyb3IgfSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQpjb25zdCBESFQgPSByZXF1aXJlKCdoeXBlcmRodCcpCmNvbnN0IHNwcSA9IHJlcXVpcmUoJ3NodWZmbGVkLXByaW9yaXR5LXF1ZXVlJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKCmNvbnN0IFBlZXJJbmZvID0gcmVxdWlyZSgnLi9saWIvcGVlci1pbmZvJykKY29uc3QgUmV0cnlUaW1lciA9IHJlcXVpcmUoJy4vbGliL3JldHJ5LXRpbWVyJykKY29uc3QgQ29ubmVjdGlvblNldCA9IHJlcXVpcmUoJy4vbGliL2Nvbm5lY3Rpb24tc2V0JykKY29uc3QgUGVlckRpc2NvdmVyeSA9IHJlcXVpcmUoJy4vbGliL3BlZXItZGlzY292ZXJ5JykKCmNvbnN0IE1BWF9QRUVSUyA9IDY0CmNvbnN0IE1BWF9QQVJBTExFTCA9IDMKY29uc3QgTUFYX0NMSUVOVF9DT05ORUNUSU9OUyA9IEluZmluaXR5IC8vIFRPRE86IENoYW5nZQpjb25zdCBNQVhfU0VSVkVSX0NPTk5FQ1RJT05TID0gSW5maW5pdHkKCmNvbnN0IEVSUl9NSVNTSU5HX1RPUElDID0gJ1RvcGljIGlzIHJlcXVpcmVkIGFuZCBtdXN0IGJlIGEgMzItYnl0ZSBidWZmZXInCmNvbnN0IEVSUl9ERVNUUk9ZRUQgPSAnU3dhcm0gaGFzIGJlZW4gZGVzdHJveWVkJwpjb25zdCBFUlJfRFVQTElDQVRFID0gJ0R1cGxpY2F0ZSBjb25uZWN0aW9uJwpjb25zdCBFUlJfRklSRVdBTEwgPSAnUGVlciBpcyBmaXJld2FsbGVkJwoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBIeXBlcnN3YXJtIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvcihvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKICAgIGNvbnN0IHsKICAgICAgc2VlZCwKICAgICAgcmVsYXlUaHJvdWdoLAogICAgICBrZXlQYWlyID0gREhULmtleVBhaXIoc2VlZCksCiAgICAgIG1heFBlZXJzID0gTUFYX1BFRVJTLAogICAgICBtYXhDbGllbnRDb25uZWN0aW9ucyA9IE1BWF9DTElFTlRfQ09OTkVDVElPTlMsCiAgICAgIG1heFNlcnZlckNvbm5lY3Rpb25zID0gTUFYX1NFUlZFUl9DT05ORUNUSU9OUywKICAgICAgbWF4UGFyYWxsZWwgPSBNQVhfUEFSQUxMRUwsCiAgICAgIGZpcmV3YWxsID0gYWxsb3dBbGwKICAgIH0gPSBvcHRzCiAgICB0aGlzLmtleVBhaXIgPSBrZXlQYWlyCgogICAgdGhpcy5kaHQgPQogICAgICBvcHRzLmRodCB8fAogICAgICBuZXcgREhUKHsKICAgICAgICBib290c3RyYXA6IG9wdHMuYm9vdHN0cmFwLAogICAgICAgIG5vZGVzOiBvcHRzLm5vZGVzLAogICAgICAgIHBvcnQ6IG9wdHMucG9ydCwKICAgICAgICBkZWZlclJhbmRvbVB1bmNoOiBvcHRzLmRlZmVyUmFuZG9tUHVuY2gsCiAgICAgICAgcmFuZG9tUHVuY2hJbnRlcnZhbDogb3B0cy5yYW5kb21QdW5jaEludGVydmFsCiAgICAgIH0pCiAgICB0aGlzLnNlcnZlciA9IHRoaXMuZGh0LmNyZWF0ZVNlcnZlcigKICAgICAgewogICAgICAgIGZpcmV3YWxsOiB0aGlzLl9oYW5kbGVGaXJld2FsbC5iaW5kKHRoaXMpLAogICAgICAgIHJlbGF5VGhyb3VnaDogdGhpcy5fbWF5YmVSZWxheUNvbm5lY3Rpb24uYmluZCh0aGlzKSwKICAgICAgICBoYW5kc2hha2VDbGVhcldhaXQ6IG9wdHMuaGFuZHNoYWtlQ2xlYXJXYWl0CiAgICAgIH0sCiAgICAgIHRoaXMuX2hhbmRsZVNlcnZlckNvbm5lY3Rpb24uYmluZCh0aGlzKQogICAgKQoKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKICAgIHRoaXMubWF4UGVlcnMgPSBtYXhQZWVycwogICAgdGhpcy5tYXhDbGllbnRDb25uZWN0aW9ucyA9IG1heENsaWVudENvbm5lY3Rpb25zCiAgICB0aGlzLm1heFNlcnZlckNvbm5lY3Rpb25zID0gbWF4U2VydmVyQ29ubmVjdGlvbnMKICAgIHRoaXMubWF4UGFyYWxsZWwgPSBtYXhQYXJhbGxlbAogICAgdGhpcy5yZWxheVRocm91Z2ggPSByZWxheVRocm91Z2ggPyB0b1JlbGF5RnVuY3Rpb24ocmVsYXlUaHJvdWdoKSA6IG51bGwKCiAgICB0aGlzLmNvbm5lY3RpbmcgPSAwCiAgICB0aGlzLmNvbm5lY3Rpb25zID0gbmV3IFNldCgpCiAgICB0aGlzLnBlZXJzID0gbmV3IE1hcCgpCiAgICB0aGlzLmV4cGxpY2l0UGVlcnMgPSBuZXcgU2V0KCkKICAgIHRoaXMubGlzdGVuaW5nID0gbnVsbAogICAgdGhpcy5zdGF0cyA9IHsKICAgICAgdXBkYXRlczogMCwKICAgICAgY29ubmVjdHM6IHsKICAgICAgICBjbGllbnQ6IHsKICAgICAgICAgIG9wZW5lZDogMCwKICAgICAgICAgIGNsb3NlZDogMCwKICAgICAgICAgIGF0dGVtcHRlZDogMAogICAgICAgIH0sCiAgICAgICAgc2VydmVyOiB7CiAgICAgICAgICAvLyBOb3RlOiB0aGVyZSBpcyBubyBub3Rpb24gb2YgJ2F0dGVtcHRzJyBmb3Igc2VydmVyIGNvbm5lY3Rpb25zCiAgICAgICAgICBvcGVuZWQ6IDAsCiAgICAgICAgICBjbG9zZWQ6IDAKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGJhbm5lZFBlZXJzOiAwCiAgICB9CgogICAgdGhpcy5fZGlzY292ZXJ5ID0gbmV3IE1hcCgpCiAgICB0aGlzLl90aW1lciA9IG5ldyBSZXRyeVRpbWVyKHRoaXMuX3JlcXVldWUuYmluZCh0aGlzKSwgewogICAgICBiYWNrb2Zmczogb3B0cy5iYWNrb2ZmcywKICAgICAgaml0dGVyOiBvcHRzLmppdHRlcgogICAgfSkKICAgIHRoaXMuX3F1ZXVlID0gc3BxKCkKCiAgICB0aGlzLl9hbGxDb25uZWN0aW9ucyA9IG5ldyBDb25uZWN0aW9uU2V0KCkKICAgIHRoaXMuX3BlbmRpbmdGbHVzaGVzID0gW10KICAgIHRoaXMuX2ZsdXNoVGljayA9IDAKCiAgICB0aGlzLl9kcmFpbmluZ1F1ZXVlID0gZmFsc2UKICAgIHRoaXMuX2NsaWVudENvbm5lY3Rpb25zID0gMAogICAgdGhpcy5fc2VydmVyQ29ubmVjdGlvbnMgPSAwCiAgICB0aGlzLl9maXJld2FsbCA9IGZpcmV3YWxsCgogICAgdGhpcy5kaHQub24oJ25ldHdvcmstY2hhbmdlJywgdGhpcy5faGFuZGxlTmV0d29ya0NoYW5nZS5iaW5kKHRoaXMpKQogICAgdGhpcy5kaHQub24oJ25ldHdvcmstdXBkYXRlJywgdGhpcy5faGFuZGxlTmV0d29ya1VwZGF0ZS5iaW5kKHRoaXMpKQogICAgdGhpcy5vbigndXBkYXRlJywgdGhpcy5faGFuZGxlVXBkYXRlKQogIH0KCiAgX21heWJlUmVsYXlDb25uZWN0aW9uKGZvcmNlKSB7CiAgICBpZiAoIXRoaXMucmVsYXlUaHJvdWdoKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHRoaXMucmVsYXlUaHJvdWdoKGZvcmNlLCB0aGlzKQogIH0KCiAgX2VucXVldWUocGVlckluZm8pIHsKICAgIGlmIChwZWVySW5mby5xdWV1ZWQpIHJldHVybgogICAgcGVlckluZm8ucXVldWVkID0gdHJ1ZQogICAgcGVlckluZm8uX2ZsdXNoVGljayA9IHRoaXMuX2ZsdXNoVGljawogICAgdGhpcy5fcXVldWUuYWRkKHBlZXJJbmZvKQoKICAgIHRoaXMuX2F0dGVtcHRDbGllbnRDb25uZWN0aW9ucygpCiAgfQoKICBfcmVxdWV1ZShiYXRjaCkgewogICAgaWYgKHRoaXMuc3VzcGVuZGVkKSByZXR1cm4KICAgIGZvciAoY29uc3QgcGVlckluZm8gb2YgYmF0Y2gpIHsKICAgICAgcGVlckluZm8ud2FpdGluZyA9IGZhbHNlCgogICAgICBpZiAoCiAgICAgICAgcGVlckluZm8uX3VwZGF0ZVByaW9yaXR5KCkgPT09IGZhbHNlIHx8CiAgICAgICAgdGhpcy5fYWxsQ29ubmVjdGlvbnMuaGFzKHBlZXJJbmZvLnB1YmxpY0tleSkgfHwKICAgICAgICBwZWVySW5mby5xdWV1ZWQKICAgICAgKQogICAgICAgIGNvbnRpbnVlCiAgICAgIHBlZXJJbmZvLnF1ZXVlZCA9IHRydWUKICAgICAgcGVlckluZm8uX2ZsdXNoVGljayA9IHRoaXMuX2ZsdXNoVGljawogICAgICB0aGlzLl9xdWV1ZS5hZGQocGVlckluZm8pCiAgICB9CgogICAgdGhpcy5fYXR0ZW1wdENsaWVudENvbm5lY3Rpb25zKCkKICB9CgogIF9mbHVzaE1heWJlKHBlZXJJbmZvKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3BlbmRpbmdGbHVzaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGZsdXNoID0gdGhpcy5fcGVuZGluZ0ZsdXNoZXNbaV0KICAgICAgaWYgKHBlZXJJbmZvLl9mbHVzaFRpY2sgPiBmbHVzaC50aWNrKSBjb250aW51ZQogICAgICBpZiAoLS1mbHVzaC5taXNzaW5nID4gMCkgY29udGludWUKICAgICAgZmx1c2gub25mbHVzaCh0cnVlKQogICAgICB0aGlzLl9wZW5kaW5nRmx1c2hlcy5zcGxpY2UoaS0tLCAxKQogICAgfQogIH0KCiAgX2ZsdXNoQWxsTWF5YmUoKSB7CiAgICBpZiAoCiAgICAgIHRoaXMuY29ubmVjdGluZyA+IDAgfHwKICAgICAgKHRoaXMuX2FsbENvbm5lY3Rpb25zLnNpemUgPCB0aGlzLm1heFBlZXJzICYmCiAgICAgICAgdGhpcy5fY2xpZW50Q29ubmVjdGlvbnMgPCB0aGlzLm1heENsaWVudENvbm5lY3Rpb25zKQogICAgKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nRmx1c2hlcy5sZW5ndGgpIHsKICAgICAgY29uc3QgZmx1c2ggPSB0aGlzLl9wZW5kaW5nRmx1c2hlcy5wb3AoKQogICAgICBmbHVzaC5vbmZsdXNoKHRydWUpCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIF9zaG91bGRDb25uZWN0RXhwbGljaXQoKSB7CiAgICByZXR1cm4gIXRoaXMuZGVzdHJveWVkICYmICF0aGlzLnN1c3BlbmRlZCAmJiB0aGlzLmNvbm5lY3RpbmcgPCB0aGlzLm1heFBhcmFsbGVsCiAgfQoKICBfc2hvdWxkQ29ubmVjdCgpIHsKICAgIHJldHVybiAoCiAgICAgICF0aGlzLmRlc3Ryb3llZCAmJgogICAgICAhdGhpcy5zdXNwZW5kZWQgJiYKICAgICAgdGhpcy5jb25uZWN0aW5nIDwgdGhpcy5tYXhQYXJhbGxlbCAmJgogICAgICB0aGlzLl9hbGxDb25uZWN0aW9ucy5zaXplIDwgdGhpcy5tYXhQZWVycyAmJgogICAgICB0aGlzLl9jbGllbnRDb25uZWN0aW9ucyA8IHRoaXMubWF4Q2xpZW50Q29ubmVjdGlvbnMKICAgICkKICB9CgogIF9zaG91bGRSZXF1ZXVlKHBlZXJJbmZvKSB7CiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIHJldHVybiBmYWxzZQogICAgaWYgKHBlZXJJbmZvLmV4cGxpY2l0KSByZXR1cm4gdHJ1ZQogICAgZm9yIChjb25zdCB0b3BpYyBvZiBwZWVySW5mby50b3BpY3MpIHsKICAgICAgaWYgKHRoaXMuX2Rpc2NvdmVyeS5oYXMoYjRhLnRvU3RyaW5nKHRvcGljLCAnaGV4JykpICYmICF0aGlzLmRlc3Ryb3llZCkgewogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZQogIH0KCiAgX2Nvbm5lY3QocGVlckluZm8sIHF1ZXVlZCkgewogICAgaWYgKHBlZXJJbmZvLmJhbm5lZCB8fCB0aGlzLl9hbGxDb25uZWN0aW9ucy5oYXMocGVlckluZm8ucHVibGljS2V5KSkgewogICAgICBpZiAocXVldWVkKSB0aGlzLl9mbHVzaE1heWJlKHBlZXJJbmZvKQogICAgICByZXR1cm4KICAgIH0KCiAgICAvLyBUT0RPOiBTdXBwb3J0IGFzeW5jIGZpcmV3YWxsaW5nIGF0IHNvbWUgcG9pbnQuCiAgICBpZiAodGhpcy5faGFuZGxlRmlyZXdhbGwocGVlckluZm8ucHVibGljS2V5LCBudWxsKSkgewogICAgICBpZiAocXVldWVkKSB0aGlzLl9mbHVzaE1heWJlKHBlZXJJbmZvKQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCByZWxheVRocm91Z2ggPSB0aGlzLl9tYXliZVJlbGF5Q29ubmVjdGlvbihwZWVySW5mby5mb3JjZVJlbGF5aW5nKQogICAgY29uc3QgY29ubiA9IHRoaXMuZGh0LmNvbm5lY3QocGVlckluZm8ucHVibGljS2V5LCB7CiAgICAgIHJlbGF5QWRkcmVzc2VzOiBwZWVySW5mby5yZWxheUFkZHJlc3NlcywKICAgICAga2V5UGFpcjogdGhpcy5rZXlQYWlyLAogICAgICByZWxheVRocm91Z2gKICAgIH0pCiAgICB0aGlzLl9hbGxDb25uZWN0aW9ucy5hZGQoY29ubikKCiAgICB0aGlzLnN0YXRzLmNvbm5lY3RzLmNsaWVudC5hdHRlbXB0ZWQrKwoKICAgIHRoaXMuY29ubmVjdGluZysrCiAgICB0aGlzLl9jbGllbnRDb25uZWN0aW9ucysrCiAgICBsZXQgb3BlbmVkID0gZmFsc2UKCiAgICBjb25zdCBvbmVycm9yID0gKGVycikgPT4gewogICAgICBpZiAodGhpcy5yZWxheVRocm91Z2ggJiYgc2hvdWxkRm9yY2VSZWxheWluZyhlcnIuY29kZSkpIHsKICAgICAgICBwZWVySW5mby5mb3JjZVJlbGF5aW5nID0gdHJ1ZQogICAgICAgIC8vIFJlc2V0IHRoZSBhdHRlbXB0cyBpbiBvcmRlciB0byBmYXN0IGNvbm5lY3QgdG8gcmVsYXkKICAgICAgICBwZWVySW5mby5hdHRlbXB0cyA9IDAKICAgICAgfQogICAgfQoKICAgIC8vIFJlbW92ZWQgb25jZSBhIGNvbm5lY3Rpb24gaXMgb3BlbmVkCiAgICBjb25uLm9uKCdlcnJvcicsIG9uZXJyb3IpCgogICAgY29ubi5vbignb3BlbicsICgpID0+IHsKICAgICAgb3BlbmVkID0gdHJ1ZQogICAgICB0aGlzLnN0YXRzLmNvbm5lY3RzLmNsaWVudC5vcGVuZWQrKwoKICAgICAgdGhpcy5fY29ubmVjdERvbmUoKQogICAgICB0aGlzLmNvbm5lY3Rpb25zLmFkZChjb25uKQogICAgICBjb25uLnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIG9uZXJyb3IpCiAgICAgIHBlZXJJbmZvLl9jb25uZWN0ZWQoKQogICAgICBwZWVySW5mby5jbGllbnQgPSB0cnVlCiAgICAgIHRoaXMuZW1pdCgnY29ubmVjdGlvbicsIGNvbm4sIHBlZXJJbmZvKQogICAgICBpZiAocXVldWVkKSB0aGlzLl9mbHVzaE1heWJlKHBlZXJJbmZvKQoKICAgICAgdGhpcy5lbWl0KCd1cGRhdGUnKQogICAgfSkKICAgIGNvbm4ub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICBpZiAoIW9wZW5lZCkgdGhpcy5fY29ubmVjdERvbmUoKQogICAgICB0aGlzLnN0YXRzLmNvbm5lY3RzLmNsaWVudC5jbG9zZWQrKwoKICAgICAgY29uc3QgZXJyID0gZ2V0U3RyZWFtRXJyb3IoY29ubikKICAgICAgaWYgKHNob3VsZEJhbihlcnIpKSB7CiAgICAgICAgdGhpcy5fYmFuUGVlcihwZWVySW5mbywgdHJ1ZSwgZXJyKQogICAgICB9CgogICAgICB0aGlzLmNvbm5lY3Rpb25zLmRlbGV0ZShjb25uKQogICAgICB0aGlzLl9hbGxDb25uZWN0aW9ucy5kZWxldGUoY29ubikKICAgICAgdGhpcy5fY2xpZW50Q29ubmVjdGlvbnMtLQogICAgICBwZWVySW5mby5fZGlzY29ubmVjdGVkKCkKCiAgICAgIHBlZXJJbmZvLndhaXRpbmcgPSB0aGlzLl9zaG91bGRSZXF1ZXVlKHBlZXJJbmZvKSAmJiB0aGlzLl90aW1lci5hZGQocGVlckluZm8pCiAgICAgIHRoaXMuX21heWJlRGVsZXRlUGVlcihwZWVySW5mbykKCiAgICAgIGlmICghb3BlbmVkICYmIHF1ZXVlZCkgdGhpcy5fZmx1c2hNYXliZShwZWVySW5mbykKCiAgICAgIHRoaXMuX2F0dGVtcHRDbGllbnRDb25uZWN0aW9ucygpCgogICAgICB0aGlzLmVtaXQoJ3VwZGF0ZScpCiAgICB9KQoKICAgIHRoaXMuZW1pdCgndXBkYXRlJykKICB9CgogIF9jb25uZWN0RG9uZSgpIHsKICAgIHRoaXMuY29ubmVjdGluZy0tCgogICAgaWYgKHRoaXMuY29ubmVjdGluZyA8IHRoaXMubWF4UGFyYWxsZWwpIHRoaXMuX2F0dGVtcHRDbGllbnRDb25uZWN0aW9ucygpCiAgICBpZiAodGhpcy5jb25uZWN0aW5nID09PSAwKSB0aGlzLl9mbHVzaEFsbE1heWJlKCkKICB9CgogIC8vIENhbGxlZCB3aGVuIHRoZSBQZWVyUXVldWUgaW5kaWNhdGVzIGEgY29ubmVjdGlvbiBzaG91bGQgYmUgYXR0ZW1wdGVkLgogIF9hdHRlbXB0Q2xpZW50Q29ubmVjdGlvbnMoKSB7CiAgICAvLyBHdWFyZCBhZ2FpbnN0IHJlLWVudHJpZXMgLSB1bnN1cmUgaWYgaXQgc3RpbGwgbmVlZGVkIGJ1dCBkb2Vzbid0IGh1cnQKICAgIGlmICh0aGlzLl9kcmFpbmluZ1F1ZXVlIHx8IHRoaXMuc3VzcGVuZGVkKSByZXR1cm4KICAgIHRoaXMuX2RyYWluaW5nUXVldWUgPSB0cnVlCgogICAgZm9yIChjb25zdCBwZWVySW5mbyBvZiB0aGlzLmV4cGxpY2l0UGVlcnMpIHsKICAgICAgaWYgKCF0aGlzLl9zaG91bGRDb25uZWN0RXhwbGljaXQoKSkgYnJlYWsKICAgICAgaWYgKAogICAgICAgIHBlZXJJbmZvLmF0dGVtcHRzID49IDUgfHwKICAgICAgICBEYXRlLm5vdygpIC0gcGVlckluZm8uZGlzY29ubmVjdGVkVGltZSA8IHBlZXJJbmZvLmF0dGVtcHRzICogMTAwMAogICAgICApCiAgICAgICAgY29udGludWUKICAgICAgdGhpcy5fY29ubmVjdChwZWVySW5mbywgZmFsc2UpCiAgICB9CgogICAgd2hpbGUgKHRoaXMuX3F1ZXVlLmxlbmd0aCAmJiB0aGlzLl9zaG91bGRDb25uZWN0KCkpIHsKICAgICAgY29uc3QgcGVlckluZm8gPSB0aGlzLl9xdWV1ZS5zaGlmdCgpCiAgICAgIHBlZXJJbmZvLnF1ZXVlZCA9IGZhbHNlCiAgICAgIHRoaXMuX2Nvbm5lY3QocGVlckluZm8sIHRydWUpCiAgICB9CiAgICB0aGlzLl9kcmFpbmluZ1F1ZXVlID0gZmFsc2UKICAgIGlmICh0aGlzLmNvbm5lY3RpbmcgPT09IDApIHRoaXMuX2ZsdXNoQWxsTWF5YmUoKQogIH0KCiAgX2hhbmRsZUZpcmV3YWxsKHJlbW90ZVB1YmxpY0tleSwgcGF5bG9hZCkgewogICAgaWYgKGI0YS5lcXVhbHMocmVtb3RlUHVibGljS2V5LCB0aGlzLmtleVBhaXIucHVibGljS2V5KSkgcmV0dXJuIHRydWUKCiAgICBsZXQgcGVlckluZm8gPSB0aGlzLnBlZXJzLmdldChiNGEudG9TdHJpbmcocmVtb3RlUHVibGljS2V5LCAnaGV4JykpCiAgICBpZiAocGVlckluZm8gJiYgcGVlckluZm8uYmFubmVkKSByZXR1cm4gdHJ1ZQoKICAgIGNvbnN0IGZpcmV3YWxsZWQgPSB0aGlzLl9maXJld2FsbChyZW1vdGVQdWJsaWNLZXksIHBheWxvYWQpCiAgICBpZiAoZmlyZXdhbGxlZCkgewogICAgICBpZiAoIXBlZXJJbmZvKSBwZWVySW5mbyA9IHRoaXMuX3Vwc2VydFBlZXIocmVtb3RlUHVibGljS2V5KQogICAgICB0aGlzLl9iYW5QZWVyKHBlZXJJbmZvLCB0cnVlLCBuZXcgRXJyb3IoRVJSX0ZJUkVXQUxMKSkKICAgIH0KCiAgICByZXR1cm4gZmlyZXdhbGxlZAogIH0KCiAgX2hhbmRsZVNlcnZlckNvbm5lY3Rpb25Td2FwKGV4aXN0aW5nLCBjb25uKSB7CiAgICBsZXQgY2xvc2VkID0gZmFsc2UKCiAgICBleGlzdGluZy5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgIGlmIChjbG9zZWQpIHJldHVybgoKICAgICAgY29ubi5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBub29wKQogICAgICBjb25uLnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIG9uY2xvc2UpCgogICAgICB0aGlzLl9oYW5kbGVTZXJ2ZXJDb25uZWN0aW9uKGNvbm4pCiAgICB9KQoKICAgIGNvbm4ub24oJ2Vycm9yJywgbm9vcCkKICAgIGNvbm4ub24oJ2Nsb3NlJywgb25jbG9zZSkKCiAgICBmdW5jdGlvbiBvbmNsb3NlKCkgewogICAgICBjbG9zZWQgPSB0cnVlCiAgICB9CiAgfQoKICAvLyBDYWxsZWQgd2hlbiB0aGUgREhUIHJlY2VpdmVzIGEgbmV3IHNlcnZlciBjb25uZWN0aW9uLgogIF9oYW5kbGVTZXJ2ZXJDb25uZWN0aW9uKGNvbm4pIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCB8fCB0aGlzLnN1c3BlbmRlZCkgewogICAgICAvLyBUT0RPOiBJbnZlc3RpZ2F0ZSB3aHkgYSBmaW5hbCBzZXJ2ZXIgY29ubmVjdGlvbiBjYW4gYmUgcmVjZWl2ZWQgYWZ0ZXIgY2xvc2UKICAgICAgY29ubi5vbignZXJyb3InLCBub29wKQogICAgICByZXR1cm4gY29ubi5kZXN0cm95KEVSUl9ERVNUUk9ZRUQpCiAgICB9CgogICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLl9hbGxDb25uZWN0aW9ucy5nZXQoY29ubi5yZW1vdGVQdWJsaWNLZXkpCgogICAgaWYgKGV4aXN0aW5nKSB7CiAgICAgIC8vIElmIGJvdGggY29ubmVjdGlvbnMgYXJlIGZyb20gdGhlIHNhbWUgcGVlciwKICAgICAgLy8gLSBwaWNrIHRoZSBuZXcgb25lIGlmIHRoZSBleGlzdGluZyBzdHJlYW0gaXMgYWxyZWFkeSBlc3RhYmxpc2hlZCAoaGFzIHNlbnQgYW5kIHJlY2VpdmVkIGJ5dGVzKSwKICAgICAgLy8gICBiZWNhdXNlIHRoZSBvdGhlciBjbGllbnQgbXVzdCBoYXZlIGxvc3QgdGhhdCBjb25uZWN0aW9uIGFuZCBiZSByZWNvbm5lY3RpbmcKICAgICAgLy8gLSBvdGhlcndpc2UsIHBpY2sgdGhlIG9uZSB0aGF0cyBleHBlY3RlZCB0byBpbml0aWF0ZSBpbiBhIHRpZSBicmVhawogICAgICBjb25zdCBleGlzdGluZ0lzT3V0ZGF0ZWQgPSBleGlzdGluZy5yYXdCeXRlc1JlYWQgPiAwICYmIGV4aXN0aW5nLnJhd0J5dGVzV3JpdHRlbiA+IDAKICAgICAgY29uc3QgZXhwZWN0ZWRJbml0aWF0b3IgPSBiNGEuY29tcGFyZShjb25uLnB1YmxpY0tleSwgY29ubi5yZW1vdGVQdWJsaWNLZXkpID4gMAogICAgICBjb25zdCBrZWVwTmV3ID0gZXhpc3RpbmdJc091dGRhdGVkIHx8IGV4cGVjdGVkSW5pdGlhdG9yID09PSBjb25uLmlzSW5pdGlhdG9yCgogICAgICBpZiAoa2VlcE5ldyA9PT0gZmFsc2UpIHsKICAgICAgICBleGlzdGluZy5zZW5kS2VlcEFsaXZlKCkKICAgICAgICBjb25uLm9uKCdlcnJvcicsIG5vb3ApCiAgICAgICAgY29ubi5kZXN0cm95KG5ldyBFcnJvcihFUlJfRFVQTElDQVRFKSkKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgZXhpc3Rpbmcub24oJ2Vycm9yJywgbm9vcCkKICAgICAgZXhpc3RpbmcuZGVzdHJveShuZXcgRXJyb3IoRVJSX0RVUExJQ0FURSkpCiAgICAgIHRoaXMuX2hhbmRsZVNlcnZlckNvbm5lY3Rpb25Td2FwKGV4aXN0aW5nLCBjb25uKQogICAgICByZXR1cm4KICAgIH0KCiAgICAvLyBXaGVuIHJlYWNoaW5nIGhlcmUsIHRoZSBjb25uZWN0aW9uIHdpbGwgYWx3YXlzIGJlICdvcGVuZWQnIG5leHQgdGljawogICAgdGhpcy5zdGF0cy5jb25uZWN0cy5zZXJ2ZXIub3BlbmVkKysKCiAgICBjb25zdCBwZWVySW5mbyA9IHRoaXMuX3Vwc2VydFBlZXIoY29ubi5yZW1vdGVQdWJsaWNLZXksIG51bGwpCgogICAgdGhpcy5jb25uZWN0aW9ucy5hZGQoY29ubikKICAgIHRoaXMuX2FsbENvbm5lY3Rpb25zLmFkZChjb25uKQogICAgdGhpcy5fc2VydmVyQ29ubmVjdGlvbnMrKwoKICAgIGNvbm4ub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICBjb25zdCBlcnIgPSBnZXRTdHJlYW1FcnJvcihjb25uKQogICAgICBpZiAoc2hvdWxkQmFuKGVycikpIHsKICAgICAgICB0aGlzLl9iYW5QZWVyKHBlZXJJbmZvLCB0cnVlLCBlcnIpCiAgICAgIH0KCiAgICAgIHRoaXMuY29ubmVjdGlvbnMuZGVsZXRlKGNvbm4pCiAgICAgIHRoaXMuX2FsbENvbm5lY3Rpb25zLmRlbGV0ZShjb25uKQogICAgICB0aGlzLl9zZXJ2ZXJDb25uZWN0aW9ucy0tCiAgICAgIHRoaXMuc3RhdHMuY29ubmVjdHMuc2VydmVyLmNsb3NlZCsrCgogICAgICB0aGlzLl9tYXliZURlbGV0ZVBlZXIocGVlckluZm8pCgogICAgICB0aGlzLl9hdHRlbXB0Q2xpZW50Q29ubmVjdGlvbnMoKQoKICAgICAgdGhpcy5lbWl0KCd1cGRhdGUnKQogICAgfSkKICAgIHBlZXJJbmZvLmNsaWVudCA9IGZhbHNlCiAgICB0aGlzLmVtaXQoJ2Nvbm5lY3Rpb24nLCBjb25uLCBwZWVySW5mbykKCiAgICB0aGlzLmVtaXQoJ3VwZGF0ZScpCiAgfQoKICBfdXBzZXJ0UGVlcihwdWJsaWNLZXksIHJlbGF5QWRkcmVzc2VzKSB7CiAgICBpZiAoYjRhLmVxdWFscyhwdWJsaWNLZXksIHRoaXMua2V5UGFpci5wdWJsaWNLZXkpKSByZXR1cm4gbnVsbAogICAgY29uc3Qga2V5U3RyaW5nID0gYjRhLnRvU3RyaW5nKHB1YmxpY0tleSwgJ2hleCcpCiAgICBsZXQgcGVlckluZm8gPSB0aGlzLnBlZXJzLmdldChrZXlTdHJpbmcpCgogICAgaWYgKHBlZXJJbmZvKSB7CiAgICAgIHBlZXJJbmZvLnJlbGF5QWRkcmVzc2VzID0gcmVsYXlBZGRyZXNzZXMgLy8gbmV3IGlzIGFsd2F5cyBiZXR0ZXIKICAgICAgcmV0dXJuIHBlZXJJbmZvCiAgICB9CgogICAgcGVlckluZm8gPSBuZXcgUGVlckluZm8oewogICAgICBwdWJsaWNLZXksCiAgICAgIHJlbGF5QWRkcmVzc2VzCiAgICB9KQoKICAgIHRoaXMucGVlcnMuc2V0KGtleVN0cmluZywgcGVlckluZm8pCiAgICByZXR1cm4gcGVlckluZm8KICB9CgogIF9oYW5kbGVVcGRhdGUoKSB7CiAgICB0aGlzLnN0YXRzLnVwZGF0ZXMrKwogIH0KCiAgX21heWJlRGVsZXRlUGVlcihwZWVySW5mbykgewogICAgaWYgKCFwZWVySW5mby5zaG91bGRHQygpKSByZXR1cm4KCiAgICBjb25zdCBoYXNBY3RpdmVDb25uID0gdGhpcy5fYWxsQ29ubmVjdGlvbnMuaGFzKHBlZXJJbmZvLnB1YmxpY0tleSkKICAgIGlmIChoYXNBY3RpdmVDb25uKSByZXR1cm4KCiAgICBjb25zdCBrZXlTdHJpbmcgPSBiNGEudG9TdHJpbmcocGVlckluZm8ucHVibGljS2V5LCAnaGV4JykKICAgIHRoaXMucGVlcnMuZGVsZXRlKGtleVN0cmluZykKICB9CgogIC8qCiAgICogQ2FsbGVkIHdoZW4gYSBwZWVyIGlzIGFjdGl2ZWx5IGRpc2NvdmVyZWQgZHVyaW5nIGEgbG9va3VwLgogICAqCiAgICogVGhyZWUgY29uZGl0aW9uczoKICAgKiAgMS4gTm90IGEga25vd24gcGVlciAtLSBpbnNlcnQgaW50byBxdWV1ZQogICAqICAyLiBBIGtub3duIHBlZXIgd2l0aCBub3JtYWwgcHJpb3JpdHkgLS0gZG8gbm90aGluZwogICAqICAzLiBBIGtub3duIHBlZXIgd2l0aCBsb3cgcHJpb3JpdHkgLS0gYnVtcCBwcmlvcml0eSwgYmVjYXVzZSBpdCdzIGJlZW4gcmVkaXNjb3ZlcmVkCiAgICovCiAgX2hhbmRsZVBlZXIocGVlciwgdG9waWMpIHsKICAgIGNvbnN0IHBlZXJJbmZvID0gdGhpcy5fdXBzZXJ0UGVlcihwZWVyLnB1YmxpY0tleSwgcGVlci5yZWxheUFkZHJlc3NlcykKICAgIGlmIChwZWVySW5mbykgcGVlckluZm8uX3RvcGljKHRvcGljKQogICAgaWYgKCFwZWVySW5mbyB8fCB0aGlzLl9hbGxDb25uZWN0aW9ucy5oYXMocGVlci5wdWJsaWNLZXkpKSByZXR1cm4KICAgIGlmICghcGVlckluZm8ucHJpb3JpdGl6ZWQgfHwgcGVlckluZm8uc2VydmVyKSBwZWVySW5mby5fcmVzZXQoKQogICAgaWYgKHBlZXJJbmZvLl91cGRhdGVQcmlvcml0eSgpKSB7CiAgICAgIHRoaXMuX2VucXVldWUocGVlckluZm8pCiAgICB9CiAgfQoKICBhc3luYyBfaGFuZGxlTmV0d29ya1VwZGF0ZSgpIHsKICAgIGlmICghdGhpcy5vbmxpbmUpIHJldHVybgogICAgdGhpcy5faGFuZGxlTmV0d29ya0NoYW5nZSgpCiAgfQoKICBhc3luYyBfaGFuZGxlTmV0d29ya0NoYW5nZSgpIHsKICAgIGlmICh0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCgogICAgLy8gcHJpb3JpdGl6ZSBmaWd1cmluZyBvdXQgaWYgZXhpc3RpbmcgY29ubmVjdGlvbnMgYXJlIGRlYWQKICAgIGZvciAoY29uc3QgY29ubiBvZiB0aGlzLl9hbGxDb25uZWN0aW9ucykgewogICAgICBjb25uLnNlbmRLZWVwQWxpdmUoKQogICAgfQoKICAgIGNvbnN0IHJlZnJlc2hlcyA9IFtdCgogICAgZm9yIChjb25zdCBkaXNjb3Zlcnkgb2YgdGhpcy5fZGlzY292ZXJ5LnZhbHVlcygpKSB7CiAgICAgIHJlZnJlc2hlcy5wdXNoKGRpc2NvdmVyeS5yZWZyZXNoKCkpCiAgICB9CgogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHJlZnJlc2hlcykKICB9CgogIF9iYW5QZWVyKHBlZXJJbmZvLCBiYW5uZWQsIGVycikgewogICAgcGVlckluZm8uYmFuKGJhbm5lZCkKICAgIHRoaXMuc3RhdHMuYmFubmVkUGVlcnMrKwogICAgdGhpcy5lbWl0KCdiYW4nLCBwZWVySW5mbywgZXJyKQogIH0KCiAgc3RhdHVzKGtleSkgewogICAgcmV0dXJuIHRoaXMuX2Rpc2NvdmVyeS5nZXQoYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpKSB8fCBudWxsCiAgfQoKICBsaXN0ZW4oKSB7CiAgICBpZiAoIXRoaXMubGlzdGVuaW5nKSB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdTd2FybSBkZXN0cm95ZWQnKQogICAgICB0aGlzLmxpc3RlbmluZyA9IHRoaXMuc2VydmVyLmxpc3Rlbih0aGlzLmtleVBhaXIpCiAgICB9CiAgICByZXR1cm4gdGhpcy5saXN0ZW5pbmcKICB9CgogIC8vIE9iamVjdCB0aGF0IGV4cG9zZXMgYSBjYW5jZWxsYXRpb24gbWV0aG9kIChkZXN0cm95KQogIC8vIFRPRE86IFdoZW4geW91IHJlam9pbiwgaXQgc2hvdWxkIHJlYW5ub3VuY2UgKyBidW1wIGxvb2t1cCBwcmlvcml0eQogIGpvaW4odG9waWMsIG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSB0aHJvdyBuZXcgRXJyb3IoJ1N3YXJtIGRlc3Ryb3llZCcpCiAgICBpZiAoIXRvcGljKSB0aHJvdyBuZXcgRXJyb3IoRVJSX01JU1NJTkdfVE9QSUMpCiAgICB0b3BpYyA9IHVuc2xhYih0b3BpYykKCiAgICBjb25zdCB0b3BpY1N0cmluZyA9IGI0YS50b1N0cmluZyh0b3BpYywgJ2hleCcpCgogICAgbGV0IGRpc2NvdmVyeSA9IHRoaXMuX2Rpc2NvdmVyeS5nZXQodG9waWNTdHJpbmcpCgogICAgaWYgKGRpc2NvdmVyeSAmJiAhZGlzY292ZXJ5LmRlc3Ryb3llZCkgewogICAgICByZXR1cm4gZGlzY292ZXJ5LnNlc3Npb24ob3B0cykKICAgIH0KCiAgICBkaXNjb3ZlcnkgPSBuZXcgUGVlckRpc2NvdmVyeSh0aGlzLCB0b3BpYywgewogICAgICBsaW1pdDogb3B0cy5saW1pdCwKICAgICAgd2FpdDogZGlzY292ZXJ5ID8gZGlzY292ZXJ5LmRlc3Ryb3koKSA6IG51bGwsCiAgICAgIHN1c3BlbmRlZDogdGhpcy5zdXNwZW5kZWQsCiAgICAgIG9ucGVlcjogKHBlZXIpID0+IHRoaXMuX2hhbmRsZVBlZXIocGVlciwgdG9waWMpCiAgICB9KQogICAgdGhpcy5fZGlzY292ZXJ5LnNldCh0b3BpY1N0cmluZywgZGlzY292ZXJ5KQogICAgcmV0dXJuIGRpc2NvdmVyeS5zZXNzaW9uKG9wdHMpCiAgfQoKICAvLyBSZXR1cm5zIGEgcHJvbWlzZQogIGFzeW5jIGxlYXZlKHRvcGljKSB7CiAgICBpZiAoIXRvcGljKSB0aHJvdyBuZXcgRXJyb3IoRVJSX01JU1NJTkdfVE9QSUMpCiAgICBjb25zdCB0b3BpY1N0cmluZyA9IGI0YS50b1N0cmluZyh0b3BpYywgJ2hleCcpCiAgICBpZiAoIXRoaXMuX2Rpc2NvdmVyeS5oYXModG9waWNTdHJpbmcpKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKCiAgICBjb25zdCBkaXNjb3ZlcnkgPSB0aGlzLl9kaXNjb3ZlcnkuZ2V0KHRvcGljU3RyaW5nKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IGRpc2NvdmVyeS5kZXN0cm95KCkKICAgIH0gY2F0Y2ggewogICAgICAvLyBpZ25vcmUsIHByb3AgbmV0d29yawogICAgfQoKICAgIGlmICh0aGlzLl9kaXNjb3ZlcnkuZ2V0KHRvcGljU3RyaW5nKSA9PT0gZGlzY292ZXJ5KSB7CiAgICAgIHRoaXMuX2Rpc2NvdmVyeS5kZWxldGUodG9waWNTdHJpbmcpCiAgICB9CiAgfQoKICBqb2luUGVlcihwdWJsaWNLZXkpIHsKICAgIGNvbnN0IHBlZXJJbmZvID0gdGhpcy5fdXBzZXJ0UGVlcihwdWJsaWNLZXksIG51bGwpCiAgICBpZiAoIXBlZXJJbmZvKSByZXR1cm4KICAgIGlmICghdGhpcy5leHBsaWNpdFBlZXJzLmhhcyhwZWVySW5mbykpIHsKICAgICAgcGVlckluZm8uZXhwbGljaXQgPSB0cnVlCiAgICAgIHRoaXMuZXhwbGljaXRQZWVycy5hZGQocGVlckluZm8pCiAgICB9CiAgICBpZiAodGhpcy5fYWxsQ29ubmVjdGlvbnMuaGFzKHB1YmxpY0tleSkpIHJldHVybgogICAgaWYgKHBlZXJJbmZvLl91cGRhdGVQcmlvcml0eSgpKSB7CiAgICAgIHRoaXMuX2VucXVldWUocGVlckluZm8pCiAgICB9CiAgfQoKICBsZWF2ZVBlZXIocHVibGljS2V5KSB7CiAgICBjb25zdCBrZXlTdHJpbmcgPSBiNGEudG9TdHJpbmcocHVibGljS2V5LCAnaGV4JykKICAgIGlmICghdGhpcy5wZWVycy5oYXMoa2V5U3RyaW5nKSkgcmV0dXJuCgogICAgY29uc3QgcGVlckluZm8gPSB0aGlzLnBlZXJzLmdldChrZXlTdHJpbmcpCiAgICBwZWVySW5mby5leHBsaWNpdCA9IGZhbHNlCiAgICB0aGlzLmV4cGxpY2l0UGVlcnMuZGVsZXRlKHBlZXJJbmZvKQogICAgdGhpcy5fbWF5YmVEZWxldGVQZWVyKHBlZXJJbmZvKQogIH0KCiAgLy8gUmV0dXJucyBhIHByb21pc2UKICBhc3luYyBmbHVzaCgpIHsKICAgIGNvbnN0IGFsbEZsdXNoZWQgPSBbLi4udGhpcy5fZGlzY292ZXJ5LnZhbHVlcygpXS5tYXAoKHYpID0+IHYuZmx1c2hlZCgpKQogICAgYXdhaXQgUHJvbWlzZS5hbGwoYWxsRmx1c2hlZCkKICAgIGlmICh0aGlzLl9mbHVzaEFsbE1heWJlKCkpIHJldHVybiB0cnVlCiAgICBjb25zdCBwZW5kaW5nU2l6ZSA9IHRoaXMuX2FsbENvbm5lY3Rpb25zLnNpemUgLSB0aGlzLmNvbm5lY3Rpb25zLnNpemUKICAgIGlmICghdGhpcy5fcXVldWUubGVuZ3RoICYmICFwZW5kaW5nU2l6ZSkgcmV0dXJuIHRydWUKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICB0aGlzLl9wZW5kaW5nRmx1c2hlcy5wdXNoKHsKICAgICAgICBvbmZsdXNoOiByZXNvbHZlLAogICAgICAgIG1pc3Npbmc6IHRoaXMuX3F1ZXVlLmxlbmd0aCArIHBlbmRpbmdTaXplLAogICAgICAgIHRpY2s6IHRoaXMuX2ZsdXNoVGljaysrCiAgICAgIH0pCiAgICB9KQogIH0KCiAgYXN5bmMgY2xlYXIoKSB7CiAgICBjb25zdCBjbGVhcmVkID0gUHJvbWlzZS5hbGxTZXR0bGVkKFsuLi50aGlzLl9kaXNjb3ZlcnkudmFsdWVzKCldLm1hcCgoZCkgPT4gZC5kZXN0cm95KCkpKQogICAgdGhpcy5fZGlzY292ZXJ5LmNsZWFyKCkKICAgIHJldHVybiBjbGVhcmVkCiAgfQoKICBhc3luYyBkZXN0cm95KHsgZm9yY2UgfSA9IHt9KSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQgJiYgIWZvcmNlKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQoKICAgIHRoaXMuX3RpbWVyLmRlc3Ryb3koKQoKICAgIGlmICghZm9yY2UpIGF3YWl0IHRoaXMuY2xlYXIoKQoKICAgIGF3YWl0IHRoaXMuc2VydmVyLmNsb3NlKCkKCiAgICB3aGlsZSAodGhpcy5fcGVuZGluZ0ZsdXNoZXMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IGZsdXNoID0gdGhpcy5fcGVuZGluZ0ZsdXNoZXMucG9wKCkKICAgICAgZmx1c2gub25mbHVzaChmYWxzZSkKICAgIH0KCiAgICBhd2FpdCB0aGlzLmRodC5kZXN0cm95KHsgZm9yY2UgfSkKICB9CgogIGFzeW5jIHN1c3BlbmQoeyBsb2cgPSBub29wIH0gPSB7fSkgewogICAgaWYgKHRoaXMuc3VzcGVuZGVkKSByZXR1cm4KCiAgICBjb25zdCBwcm9taXNlcyA9IFtdCgogICAgcHJvbWlzZXMucHVzaCh0aGlzLnNlcnZlci5zdXNwZW5kKHsgbG9nIH0pKQoKICAgIGZvciAoY29uc3QgZGlzY292ZXJ5IG9mIHRoaXMuX2Rpc2NvdmVyeS52YWx1ZXMoKSkgewogICAgICBwcm9taXNlcy5wdXNoKGRpc2NvdmVyeS5zdXNwZW5kKHsgbG9nIH0pKQogICAgfQoKICAgIGNvbnN0IHBlbmRpbmcgPSBbXQogICAgZm9yIChjb25zdCBjb25uZWN0aW9uIG9mIHRoaXMuX2FsbENvbm5lY3Rpb25zKSB7CiAgICAgIGNvbm5lY3Rpb24uZGVzdHJveSgpCiAgICAgIHBlbmRpbmcucHVzaChuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gY29ubmVjdGlvbi5vbignY2xvc2UnLCByZXNvbHZlKSkpCiAgICB9CgogICAgdGhpcy5zdXNwZW5kZWQgPSB0cnVlCgogICAgbG9nKCdTdXNwZW5kaW5nIHNlcnZlciBhbmQgZGlzY292ZXJ5Li4uICgnICsgcHJvbWlzZXMubGVuZ3RoICsgJyknKQogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHByb21pc2VzKQogICAgbG9nKCdEb25lLCBzdXNwZW5kaW5nIHRoZSBkaHQuLi4nKQogICAgYXdhaXQgdGhpcy5kaHQuc3VzcGVuZCh7IGxvZyB9KQogICAgbG9nKCdEb25lLCBzd2FybSBmdWxseSBzdXNwZW5kZWQnKQoKICAgIGF3YWl0IFByb21pc2UuYWxsKHBlbmRpbmcpCgogICAgLy8gcmVzZXQgcXVldWUKICAgIHRoaXMuX3RpbWVyLmRlc3Ryb3koKQogICAgdGhpcy5fdGltZXIgPSBuZXcgUmV0cnlUaW1lcih0aGlzLl9yZXF1ZXVlLmJpbmQodGhpcyksIHsKICAgICAgYmFja29mZnM6IHRoaXMuX3RpbWVyLmJhY2tvZmZzLAogICAgICBqaXR0ZXI6IHRoaXMuX3RpbWVyLmppdHRlcgogICAgfSkKICAgIHRoaXMuX3F1ZXVlID0gc3BxKCkKICB9CgogIGFzeW5jIHJlc3VtZSh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICBpZiAoIXRoaXMuc3VzcGVuZGVkKSByZXR1cm4KCiAgICBsb2coJ1Jlc3VtaW5nIHRoZSBkaHQnKQogICAgYXdhaXQgdGhpcy5kaHQucmVzdW1lKCkKICAgIGxvZygnRG9uZSwgcmVzdW1pbmcgdGhlIHNlcnZlcicpCiAgICBhd2FpdCB0aGlzLnNlcnZlci5yZXN1bWUoKQogICAgbG9nKCdEb25lLCBhbGwgZGlzY292ZXJ5JykKCiAgICBmb3IgKGNvbnN0IGRpc2NvdmVyeSBvZiB0aGlzLl9kaXNjb3ZlcnkudmFsdWVzKCkpIHsKICAgICAgZGlzY292ZXJ5LnJlc3VtZSgpCiAgICB9CgogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgdGhpcy5fYXR0ZW1wdENsaWVudENvbm5lY3Rpb25zKCkKICB9CgogIHRvcGljcygpIHsKICAgIHJldHVybiB0aGlzLl9kaXNjb3ZlcnkudmFsdWVzKCkKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gYWxsb3dBbGwoKSB7CiAgcmV0dXJuIGZhbHNlCn0KCmZ1bmN0aW9uIHNob3VsZEZvcmNlUmVsYXlpbmcoY29kZSkgewogIHJldHVybiAoCiAgICBjb2RlID09PSAnSE9MRVBVTkNIX0FCT1JURUQnIHx8CiAgICBjb2RlID09PSAnSE9MRVBVTkNIX0RPVUJMRV9SQU5ET01JWkVEX05BVFMnIHx8CiAgICBjb2RlID09PSAnUkVNT1RFX05PVF9IT0xFUFVOQ0hBQkxFJwogICkKfQoKZnVuY3Rpb24gc2hvdWxkQmFuKCkgewogIC8vIHJldHVybiAhIWVyciAmJiBlcnIubmFtZSA9PT0gJ0h5cGVyY29yZUVycm9yJyAmJiBlcnIuY29kZSA9PT0gJ0lOVkFMSURfT1BFUkFUSU9OJwogIHJldHVybiBmYWxzZQp9CgpmdW5jdGlvbiB0b1JlbGF5RnVuY3Rpb24ocmVsYXlUaHJvdWdoKSB7CiAgcmV0dXJuIHR5cGVvZiByZWxheVRocm91Z2ggPT09ICdmdW5jdGlvbicKICAgID8gcmVsYXlUaHJvdWdoCiAgICA6IChmb3JjZSwgc3dhcm0pID0+IChmb3JjZSB8fCBzd2FybS5kaHQucmFuZG9taXplZCA/IHJlbGF5VGhyb3VnaCA6IG51bGwpCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBCdWxrVGltZXIgewogIGNvbnN0cnVjdG9yKHRpbWUsIGZuKSB7CiAgICB0aGlzLl90aW1lID0gdGltZQogICAgdGhpcy5fZm4gPSBmbgogICAgdGhpcy5faW50ZXJ2YWwgPSBudWxsCiAgICB0aGlzLl9uZXh0ID0gW10KICAgIHRoaXMuX3BlbmRpbmcgPSBbXQogICAgdGhpcy5fZGVzdHJveWVkID0gZmFsc2UKICB9CgogIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuX2Rlc3Ryb3llZCA9IHRydWUKICAgIGNsZWFySW50ZXJ2YWwodGhpcy5faW50ZXJ2YWwpCiAgICB0aGlzLl9pbnRlcnZhbCA9IG51bGwKICB9CgogIF9vbnRpY2soKSB7CiAgICBpZiAoIXRoaXMuX25leHQubGVuZ3RoICYmICF0aGlzLl9wZW5kaW5nLmxlbmd0aCkgcmV0dXJuCiAgICBpZiAodGhpcy5fbmV4dC5sZW5ndGgpIHRoaXMuX2ZuKHRoaXMuX25leHQpCiAgICB0aGlzLl9uZXh0ID0gdGhpcy5fcGVuZGluZwogICAgdGhpcy5fcGVuZGluZyA9IFtdCiAgfQoKICBhZGQoaW5mbykgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgcmV0dXJuCiAgICBpZiAoIXRoaXMuX2ludGVydmFsKSB7CiAgICAgIHRoaXMuX2ludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5fb250aWNrLmJpbmQodGhpcyksIE1hdGguZmxvb3IodGhpcy5fdGltZSAqIDAuNjYpKQogICAgfQoKICAgIHRoaXMuX3BlbmRpbmcucHVzaChpbmZvKQogIH0KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBDb25uZWN0aW9uU2V0IHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuX2J5UHVibGljS2V5ID0gbmV3IE1hcCgpCiAgfQoKICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLl9ieVB1YmxpY0tleS52YWx1ZXMoKQogIH0KCiAgZ2V0IHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5fYnlQdWJsaWNLZXkuc2l6ZQogIH0KCiAgaGFzKHB1YmxpY0tleSkgewogICAgcmV0dXJuIHRoaXMuX2J5UHVibGljS2V5Lmhhcyh0b0hleChwdWJsaWNLZXkpKQogIH0KCiAgZ2V0KHB1YmxpY0tleSkgewogICAgcmV0dXJuIHRoaXMuX2J5UHVibGljS2V5LmdldCh0b0hleChwdWJsaWNLZXkpKQogIH0KCiAgYWRkKGNvbm5lY3Rpb24pIHsKICAgIHRoaXMuX2J5UHVibGljS2V5LnNldChiNGEudG9TdHJpbmcoY29ubmVjdGlvbi5yZW1vdGVQdWJsaWNLZXksICdoZXgnKSwgY29ubmVjdGlvbikKICB9CgogIGRlbGV0ZShjb25uZWN0aW9uKSB7CiAgICBjb25zdCBrZXlTdHJpbmcgPSBiNGEudG9TdHJpbmcoY29ubmVjdGlvbi5yZW1vdGVQdWJsaWNLZXksICdoZXgnKQogICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLl9ieVB1YmxpY0tleS5nZXQoa2V5U3RyaW5nKQogICAgaWYgKGV4aXN0aW5nICE9PSBjb25uZWN0aW9uKSByZXR1cm4KICAgIHRoaXMuX2J5UHVibGljS2V5LmRlbGV0ZShrZXlTdHJpbmcpCiAgfQp9CgpmdW5jdGlvbiB0b0hleChiKSB7CiAgcmV0dXJuIHR5cGVvZiBiID09PSAnc3RyaW5nJyA/IGIgOiBiNGEudG9TdHJpbmcoYiwgJ2hleCcpCn0KY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgUkVGUkVTSF9JTlRFUlZBTCA9IDEwMDAgKiA2MCAqIDEwIC8vIDEwIG1pbgpjb25zdCBSQU5ET01fSklUVEVSID0gMTAwMCAqIDYwICogMiAvLyAyIG1pbgpjb25zdCBERUxBWV9HUkFDRV9QRVJJT0QgPSAxMDAwICogMzAgLy8gMzBzCgpjb25zdCBNQVhfRElTQ09WRVJZX0NBQ0hFID0gNjQKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUGVlckRpc2NvdmVyeSB7CiAgY29uc3RydWN0b3IoCiAgICBzd2FybSwKICAgIHRvcGljLAogICAgeyBsaW1pdCA9IEluZmluaXR5LCB3YWl0ID0gbnVsbCwgc3VzcGVuZGVkID0gZmFsc2UsIG9ucGVlciA9IG5vb3AsIG9uZXJyb3IgPSBzYWZldHlDYXRjaCB9CiAgKSB7CiAgICB0aGlzLmxpbWl0ID0gbGltaXQKICAgIHRoaXMuc3dhcm0gPSBzd2FybQogICAgdGhpcy50b3BpYyA9IHRvcGljCiAgICB0aGlzLmlzQ2xpZW50ID0gZmFsc2UKICAgIHRoaXMuaXNTZXJ2ZXIgPSBmYWxzZQogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5kZXN0cm95aW5nID0gbnVsbAogICAgdGhpcy5zdXNwZW5kZWQgPSBzdXNwZW5kZWQKCiAgICB0aGlzLl9zZXNzaW9ucyA9IFtdCiAgICB0aGlzLl9jbGllbnRTZXNzaW9ucyA9IDAKICAgIHRoaXMuX3NlcnZlclNlc3Npb25zID0gMAoKICAgIHRoaXMuX29ucGVlciA9IG9ucGVlcgogICAgdGhpcy5fb25lcnJvciA9IG9uZXJyb3IKCiAgICB0aGlzLl9kaXNjb3ZlcmVkID0gbmV3IFNldCgpCiAgICB0aGlzLl9hY3RpdmVRdWVyeSA9IG51bGwKICAgIHRoaXMuX3RpbWVyID0gbnVsbAogICAgdGhpcy5fY3VycmVudFJlZnJlc2ggPSBudWxsCiAgICB0aGlzLl9jbG9zZXN0Tm9kZXMgPSBudWxsCiAgICB0aGlzLl9maXJzdEFubm91bmNlID0gdHJ1ZQogICAgdGhpcy5fbmVlZHNVbmFubm91bmNlID0gZmFsc2UKICAgIHRoaXMuX3JlZnJlc2hlcyA9IDAKICAgIHRoaXMuX3dhaXQgPSB3YWl0CiAgfQoKICBzZXNzaW9uKHsgc2VydmVyID0gdHJ1ZSwgY2xpZW50ID0gdHJ1ZSwgbGltaXQgPSBJbmZpbml0eSwgb25lcnJvciA9IHNhZmV0eUNhdGNoIH0pIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdQZWVyRGlzY292ZXJ5IGlzIGRlc3Ryb3llZCcpCiAgICBjb25zdCBzZXNzaW9uID0gbmV3IFBlZXJEaXNjb3ZlcnlTZXNzaW9uKHRoaXMpCiAgICBzZXNzaW9uLnJlZnJlc2goeyBzZXJ2ZXIsIGNsaWVudCwgbGltaXQgfSkuY2F0Y2gob25lcnJvcikKICAgIHRoaXMuX3Nlc3Npb25zLnB1c2goc2Vzc2lvbikKICAgIHJldHVybiBzZXNzaW9uCiAgfQoKICBfcmVmcmVzaExhdGVyKGVhZ2VyKSB7CiAgICBjb25zdCBqaXR0ZXIgPSBNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkgKiBSQU5ET01fSklUVEVSKQogICAgY29uc3QgZGVsYXkgPSAhZWFnZXIgPyBSRUZSRVNIX0lOVEVSVkFMICsgaml0dGVyIDogaml0dGVyCgogICAgaWYgKHRoaXMuX3RpbWVyKSBjbGVhclRpbWVvdXQodGhpcy5fdGltZXIpCgogICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKQogICAgdGhpcy5fdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgLy8gSWYgeW91ciBsYXB0b3Agd2VudCB0byBzbGVlcCwgYW5kIGlzIGNvbWluZyBiYWNrIG9ubGluZS4uLgogICAgICBjb25zdCBvdmVyZHVlID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSA+IGRlbGF5ICsgREVMQVlfR1JBQ0VfUEVSSU9ECiAgICAgIGlmIChvdmVyZHVlKSB0aGlzLl9yZWZyZXNoTGF0ZXIodHJ1ZSkKICAgICAgZWxzZSB0aGlzLnJlZnJlc2goKS5jYXRjaCh0aGlzLl9vbmVycm9yKQogICAgfSwgZGVsYXkpCiAgfQoKICBfaXNBY3RpdmUoKSB7CiAgICByZXR1cm4gIXRoaXMuZGVzdHJveWVkICYmICF0aGlzLnN1c3BlbmRlZAogIH0KCiAgLy8gVE9ETzogQWxsb3cgYW5ub3VuY2UgdG8gYmUgYW4gYXJndW1lbnQgdG8gdGhpcwogIC8vIFRPRE86IE1heWJlIGFubm91bmNlIHNob3VsZCBiZSBhIHNldHRlcj8KICBhc3luYyBfcmVmcmVzaCgpIHsKICAgIGlmICh0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCiAgICBjb25zdCBjbG9jayA9ICsrdGhpcy5fcmVmcmVzaGVzCgogICAgaWYgKHRoaXMuX3dhaXQpIHsKICAgICAgYXdhaXQgdGhpcy5fd2FpdAogICAgICB0aGlzLl93YWl0ID0gbnVsbAogICAgICBpZiAoY2xvY2sgIT09IHRoaXMuX3JlZnJlc2hlcyB8fCAhdGhpcy5faXNBY3RpdmUoKSkgcmV0dXJuCiAgICB9CgogICAgY29uc3QgY2xlYXIgPSB0aGlzLmlzU2VydmVyICYmIHRoaXMuX2ZpcnN0QW5ub3VuY2UKICAgIGlmIChjbGVhcikgdGhpcy5fZmlyc3RBbm5vdW5jZSA9IGZhbHNlCgogICAgY29uc3Qgb3B0cyA9IHsKICAgICAgY2xlYXIsCiAgICAgIGNsb3Nlc3ROb2RlczogdGhpcy5fY2xvc2VzdE5vZGVzCiAgICB9CgogICAgaWYgKHRoaXMuaXNTZXJ2ZXIpIHsKICAgICAgYXdhaXQgdGhpcy5zd2FybS5saXN0ZW4oKQogICAgICAvLyBpZiBhIHBhcmFsbGVsIHJlZnJlc2ggaXMgaGFwcGVuaW5nLCB5aWVsZCB0byB0aGUgbmV3IG9uZQogICAgICBpZiAoY2xvY2sgIT09IHRoaXMuX3JlZnJlc2hlcyB8fCAhdGhpcy5faXNBY3RpdmUoKSkgcmV0dXJuCiAgICAgIHRoaXMuX25lZWRzVW5hbm5vdW5jZSA9IHRydWUKICAgIH0KCiAgICBsZXQgbGltaXQgPSB0aGlzLmxpbWl0CgogICAgaWYgKGxpbWl0IDwgSW5maW5pdHkgJiYgbGltaXQgPiAwKSB7CiAgICAgIGZvciAoY29uc3QgaWQgb2YgdGhpcy5fZGlzY292ZXJlZCkgewogICAgICAgIGlmICghdGhpcy5zd2FybS5jb25uZWN0aW9ucy5oYXMoaWQpKSBjb250aW51ZQogICAgICAgIGlmICgtLWxpbWl0ID09PSAwKSBicmVhawogICAgICB9CiAgICB9CgogICAgdGhpcy5fZGlzY292ZXJlZC5jbGVhcigpCgogICAgY29uc3QgYW5ub3VuY2luZyA9IHRoaXMuaXNTZXJ2ZXIKICAgIGNvbnN0IHF1ZXJ5ID0gKHRoaXMuX2FjdGl2ZVF1ZXJ5ID0gYW5ub3VuY2luZwogICAgICA/IHRoaXMuc3dhcm0uZGh0LmFubm91bmNlKAogICAgICAgICAgdGhpcy50b3BpYywKICAgICAgICAgIHRoaXMuc3dhcm0ua2V5UGFpciwKICAgICAgICAgIHRoaXMuc3dhcm0uc2VydmVyLnJlbGF5QWRkcmVzc2VzLAogICAgICAgICAgb3B0cwogICAgICAgICkKICAgICAgOiB0aGlzLl9uZWVkc1VuYW5ub3VuY2UKICAgICAgICA/IHRoaXMuc3dhcm0uZGh0Lmxvb2t1cEFuZFVuYW5ub3VuY2UodGhpcy50b3BpYywgdGhpcy5zd2FybS5rZXlQYWlyLCBvcHRzKQogICAgICAgIDogdGhpcy5zd2FybS5kaHQubG9va3VwKHRoaXMudG9waWMsIG9wdHMpKQoKICAgIHRyeSB7CiAgICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiB0aGlzLl9hY3RpdmVRdWVyeSkgewogICAgICAgIGlmICghdGhpcy5pc0NsaWVudCB8fCAhdGhpcy5faXNBY3RpdmUoKSkgY29udGludWUKICAgICAgICBmb3IgKGNvbnN0IHBlZXIgb2YgZGF0YS5wZWVycykgewogICAgICAgICAgaWYgKGxpbWl0IDwgSW5maW5pdHkpIHsKICAgICAgICAgICAgY29uc3QgaWQgPSBiNGEudG9TdHJpbmcocGVlci5wdWJsaWNLZXksICdoZXgnKQoKICAgICAgICAgICAgaWYgKHRoaXMuX2Rpc2NvdmVyZWQuc2l6ZSA8IE1BWF9ESVNDT1ZFUllfQ0FDSEUpIHsKICAgICAgICAgICAgICB0aGlzLl9kaXNjb3ZlcmVkLmFkZChpZCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGxpbWl0ID09PSAwKSBjb250aW51ZQoKICAgICAgICAgICAgLy8gdGhlcmUgaXMgYSBjaGFuY2UgaXQgaGFzIHVwZGF0ZWQgYSBjb25uZWN0aW9uIGR1cmluZyBkaXNjb3ZlcnkgYW5kIHdlIGdvIG92ZXIKICAgICAgICAgICAgLy8gdGhlIGxpbWl0IC0gdGhhdHMgYWNjZXB0YWJsZSB0byBhdm9pZCBhIGNvbXBsZXhpdHkgc3BpcmFsIGhlcmUuCiAgICAgICAgICAgIGlmICghdGhpcy5zd2FybS5jb25uZWN0aW9ucy5oYXMoaWQpKSBsaW1pdC0tCiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5fb25wZWVyKHBlZXIsIGRhdGEpCiAgICAgICAgfQogICAgICB9CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKHRoaXMuX2lzQWN0aXZlKCkpIHRocm93IGVycgogICAgfSBmaW5hbGx5IHsKICAgICAgaWYgKHRoaXMuX2FjdGl2ZVF1ZXJ5ID09PSBxdWVyeSkgewogICAgICAgIHRoaXMuX2FjdGl2ZVF1ZXJ5ID0gbnVsbAogICAgICAgIGlmICghdGhpcy5kZXN0cm95ZWQgJiYgIXRoaXMuc3VzcGVuZGVkKSB0aGlzLl9yZWZyZXNoTGF0ZXIoZmFsc2UpCiAgICAgIH0KICAgIH0KCiAgICAvLyBUaGlzIGlzIHNldCBhdCB0aGUgdmVyeSBlbmQsIHdoZW4gdGhlIHF1ZXJ5IGNvbXBsZXRlcyBzdWNjZXNzZnVsbHkuCiAgICB0aGlzLl9jbG9zZXN0Tm9kZXMgPSBxdWVyeS5jbG9zZXN0Tm9kZXMKCiAgICBpZiAoY2xvY2sgIT09IHRoaXMuX3JlZnJlc2hlcykgcmV0dXJuCgogICAgLy8gSW4gdGhpcyBpcyB0aGUgbGF0ZXN0IHF1ZXJ5LCB1bmFubm91bmNlIGhhcyBiZWVuIGZ1bGZpbGxlZCBhcyB3ZWxsCiAgICBpZiAoIWFubm91bmNpbmcpIHRoaXMuX25lZWRzVW5hbm5vdW5jZSA9IGZhbHNlCiAgfQoKICBhc3luYyByZWZyZXNoKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSB0aHJvdyBuZXcgRXJyb3IoJ1BlZXJEaXNjb3ZlcnkgaXMgZGVzdHJveWVkJykKCiAgICBjb25zdCBzZXJ2ZXIgPSB0aGlzLl9zZXJ2ZXJTZXNzaW9ucyA+IDAKICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuX2NsaWVudFNlc3Npb25zID4gMAoKICAgIGlmICh0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCgogICAgaWYgKHNlcnZlciA9PT0gdGhpcy5pc1NlcnZlciAmJiBjbGllbnQgPT09IHRoaXMuaXNDbGllbnQpIHsKICAgICAgaWYgKHRoaXMuX2N1cnJlbnRSZWZyZXNoKSByZXR1cm4gdGhpcy5fY3VycmVudFJlZnJlc2gKICAgICAgdGhpcy5fY3VycmVudFJlZnJlc2ggPSB0aGlzLl9yZWZyZXNoKCkKICAgIH0gZWxzZSB7CiAgICAgIGlmICh0aGlzLl9hY3RpdmVRdWVyeSkgdGhpcy5fYWN0aXZlUXVlcnkuZGVzdHJveSgpCiAgICAgIHRoaXMuaXNTZXJ2ZXIgPSBzZXJ2ZXIKICAgICAgdGhpcy5pc0NsaWVudCA9IGNsaWVudAogICAgICB0aGlzLl9jdXJyZW50UmVmcmVzaCA9IHRoaXMuX3JlZnJlc2goKQogICAgfQoKICAgIGNvbnN0IHJlZnJlc2ggPSB0aGlzLl9jdXJyZW50UmVmcmVzaAogICAgdHJ5IHsKICAgICAgYXdhaXQgcmVmcmVzaAogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfSBmaW5hbGx5IHsKICAgICAgaWYgKHJlZnJlc2ggPT09IHRoaXMuX2N1cnJlbnRSZWZyZXNoKSB7CiAgICAgICAgdGhpcy5fY3VycmVudFJlZnJlc2ggPSBudWxsCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgZmx1c2hlZCgpIHsKICAgIGlmICh0aGlzLnN3YXJtLmxpc3RlbmluZykgYXdhaXQgdGhpcy5zd2FybS5saXN0ZW5pbmcKCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9jdXJyZW50UmVmcmVzaAogICAgICByZXR1cm4gdHJ1ZQogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0KCiAgYXN5bmMgX2Rlc3Ryb3lNYXliZSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCgogICAgdHJ5IHsKICAgICAgaWYgKHRoaXMuX3Nlc3Npb25zLmxlbmd0aCA9PT0gMCkgYXdhaXQgdGhpcy5zd2FybS5sZWF2ZSh0aGlzLnRvcGljKQogICAgICBlbHNlIGlmICh0aGlzLl9zZXJ2ZXJTZXNzaW9ucyA9PT0gMCAmJiB0aGlzLl9uZWVkc1VuYW5ub3VuY2UpIGF3YWl0IHRoaXMucmVmcmVzaCgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgLy8gaWdub3JlIG5ldHdvcmsgZmFpbHVyZXMgaGVyZSwgYXMgd2UgYXJlIHRlYXJpbmcgZG93bgogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICB9CiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuZGVzdHJveWluZykgcmV0dXJuIHRoaXMuZGVzdHJveWluZwogICAgdGhpcy5kZXN0cm95aW5nID0gdGhpcy5fZGVzdHJveSgpCiAgICByZXR1cm4gdGhpcy5kZXN0cm95aW5nCiAgfQoKICBhc3luYyBfYWJvcnQobG9nKSB7CiAgICBjb25zdCBpZCA9IGxvZyA9PT0gbm9vcCA/ICcnIDogYjRhLnRvU3RyaW5nKHRoaXMudG9waWMsICdoZXgnKQoKICAgIGxvZygnQWJvcnRpbmcgZGlzY292ZXJ5JywgaWQpCiAgICBpZiAodGhpcy5fd2FpdCkgYXdhaXQgdGhpcy5fd2FpdAogICAgbG9nKCdBYm9ydGluZyBkaXNjb3ZlcnkgKHBvc3Qgd2FpdCknLCBpZCkKCiAgICBpZiAodGhpcy5fYWN0aXZlUXVlcnkpIHsKICAgICAgdGhpcy5fYWN0aXZlUXVlcnkuZGVzdHJveSgpCiAgICAgIHRoaXMuX2FjdGl2ZVF1ZXJ5ID0gbnVsbAogICAgfQogICAgaWYgKHRoaXMuX3RpbWVyKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lcikKICAgICAgdGhpcy5fdGltZXIgPSBudWxsCiAgICB9CgogICAgbGV0IG5vZGVzID0gdGhpcy5fY2xvc2VzdE5vZGVzCgogICAgaWYgKHRoaXMuX2N1cnJlbnRSZWZyZXNoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgdGhpcy5fY3VycmVudFJlZnJlc2gKICAgICAgfSBjYXRjaCB7CiAgICAgICAgLy8gSWYgdGhlIGRlc3Ryb3kgY2F1c2VzIHRoZSByZWZyZXNoIHRvIGZhaWwsIHN1cHByZXNzIGl0LgogICAgICB9CiAgICB9CgogICAgbG9nKCdBYm9ydGluZyBkaXNjb3ZlcnkgKHBvc3QgcmVmcmVzaCknLCBpZCkKICAgIGlmICh0aGlzLl9pc0FjdGl2ZSgpKSByZXR1cm4KCiAgICBpZiAoIW5vZGVzKSBub2RlcyA9IHRoaXMuX2Nsb3Nlc3ROb2RlcwogICAgZWxzZSBpZiAodGhpcy5fY2xvc2VzdE5vZGVzICE9PSBub2RlcykgewogICAgICBjb25zdCBsZW4gPSBub2Rlcy5sZW5ndGgKICAgICAgZm9yIChjb25zdCBuZXdlciBvZiB0aGlzLl9jbG9zZXN0Tm9kZXMpIHsKICAgICAgICBpZiAobmV3ZXIuaWQgJiYgIWhhc05vZGUobm9kZXMsIGxlbiwgbmV3ZXIpKSBub2Rlcy5wdXNoKG5ld2VyKQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMuX25lZWRzVW5hbm5vdW5jZSkgewogICAgICBsb2coJ1VuYW5ub3VuY2luZyBkaXNjb3ZlcnknLCBpZCkKICAgICAgaWYgKG5vZGVzICYmIG5vZGVzLmxlbmd0aCkKICAgICAgICBhd2FpdCB0aGlzLnN3YXJtLmRodC51bmFubm91bmNlKHRoaXMudG9waWMsIHRoaXMuc3dhcm0ua2V5UGFpciwgewogICAgICAgICAgY2xvc2VzdE5vZGVzOiBub2RlcywKICAgICAgICAgIG9ubHlDbG9zZXN0Tm9kZXM6IHRydWUsCiAgICAgICAgICBmb3JjZTogdHJ1ZQogICAgICAgIH0pCiAgICAgIHRoaXMuX25lZWRzVW5hbm5vdW5jZSA9IGZhbHNlCiAgICAgIGxvZygnVW5hbm5vdW5jaW5nIGRpc2NvdmVyeSAoZG9uZSknLCBpZCkKICAgIH0KICB9CgogIF9kZXN0cm95KCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQogICAgcmV0dXJuIHRoaXMuX2Fib3J0KG5vb3ApCiAgfQoKICBhc3luYyBzdXNwZW5kKHsgbG9nID0gbm9vcCB9ID0ge30pIHsKICAgIGlmICh0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCiAgICB0aGlzLnN1c3BlbmRlZCA9IHRydWUKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2Fib3J0KGxvZykKICAgIH0gY2F0Y2ggewogICAgICAvLyBpZ25vcmUKICAgIH0KICB9CgogIHJlc3VtZSgpIHsKICAgIGlmICghdGhpcy5zdXNwZW5kZWQpIHJldHVybgogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgdGhpcy5yZWZyZXNoKCkuY2F0Y2gobm9vcCkKICB9Cn0KCmNsYXNzIFBlZXJEaXNjb3ZlcnlTZXNzaW9uIHsKICBjb25zdHJ1Y3RvcihkaXNjb3ZlcnkpIHsKICAgIHRoaXMuZGlzY292ZXJ5ID0gZGlzY292ZXJ5CiAgICB0aGlzLmlzQ2xpZW50ID0gZmFsc2UKICAgIHRoaXMuaXNTZXJ2ZXIgPSBmYWxzZQogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogIH0KCiAgZ2V0IHN3YXJtKCkgewogICAgcmV0dXJuIHRoaXMuZGlzY292ZXJ5LnN3YXJtCiAgfQoKICBnZXQgdG9waWMoKSB7CiAgICByZXR1cm4gdGhpcy5kaXNjb3ZlcnkudG9waWMKICB9CgogIGFzeW5jIHJlZnJlc2goeyBjbGllbnQgPSB0aGlzLmlzQ2xpZW50LCBzZXJ2ZXIgPSB0aGlzLmlzU2VydmVyLCBsaW1pdCA9IEluZmluaXR5IH0gPSB7fSkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSB0aHJvdyBuZXcgRXJyb3IoJ1BlZXJEaXNjb3ZlcnkgaXMgZGVzdHJveWVkJykKICAgIGlmICghY2xpZW50ICYmICFzZXJ2ZXIpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHJlZnJlc2ggd2l0aCBuZWl0aGVyIGNsaWVudCBub3Igc2VydmVyIG9wdGlvbicpCgogICAgaWYgKGNsaWVudCAhPT0gdGhpcy5pc0NsaWVudCkgewogICAgICB0aGlzLmlzQ2xpZW50ID0gY2xpZW50CiAgICAgIHRoaXMuZGlzY292ZXJ5Ll9jbGllbnRTZXNzaW9ucyArPSBjbGllbnQgPyAxIDogLTEKICAgIH0KCiAgICBpZiAoc2VydmVyICE9PSB0aGlzLmlzU2VydmVyKSB7CiAgICAgIHRoaXMuaXNTZXJ2ZXIgPSBzZXJ2ZXIKICAgICAgdGhpcy5kaXNjb3ZlcnkuX3NlcnZlclNlc3Npb25zICs9IHNlcnZlciA/IDEgOiAtMQogICAgfQoKICAgIHRoaXMuZGlzY292ZXJ5LmxpbWl0ID0gbGltaXQKCiAgICByZXR1cm4gdGhpcy5kaXNjb3ZlcnkucmVmcmVzaCgpCiAgfQoKICBhc3luYyBmbHVzaGVkKCkgewogICAgcmV0dXJuIHRoaXMuZGlzY292ZXJ5LmZsdXNoZWQoKQogIH0KCiAgYXN5bmMgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKCiAgICBpZiAodGhpcy5pc0NsaWVudCkgdGhpcy5kaXNjb3ZlcnkuX2NsaWVudFNlc3Npb25zLS0KICAgIGlmICh0aGlzLmlzU2VydmVyKSB0aGlzLmRpc2NvdmVyeS5fc2VydmVyU2Vzc2lvbnMtLQoKICAgIGNvbnN0IGluZGV4ID0gdGhpcy5kaXNjb3ZlcnkuX3Nlc3Npb25zLmluZGV4T2YodGhpcykKICAgIGNvbnN0IGhlYWQgPSB0aGlzLmRpc2NvdmVyeS5fc2Vzc2lvbnMucG9wKCkKCiAgICBpZiAoaGVhZCAhPT0gdGhpcykgdGhpcy5kaXNjb3ZlcnkuX3Nlc3Npb25zW2luZGV4XSA9IGhlYWQKCiAgICByZXR1cm4gdGhpcy5kaXNjb3ZlcnkuX2Rlc3Ryb3lNYXliZSgpCiAgfQp9CgpmdW5jdGlvbiBoYXNOb2RlKG5vZGVzLCBsZW4sIG5vZGUpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICBjb25zdCBleGlzdGluZyA9IG5vZGVzW2ldCiAgICBpZiAoZXhpc3RpbmcuaWQgJiYgYjRhLmVxdWFscyhleGlzdGluZy5pZCwgbm9kZS5pZCkpIHJldHVybiB0cnVlCiAgfQoKICByZXR1cm4gZmFsc2UKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IHsgRXZlbnRFbWl0dGVyIH0gPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCB1bnNsYWIgPSByZXF1aXJlKCd1bnNsYWInKQoKY29uc3QgTUlOX0NPTk5FQ1RJT05fVElNRSA9IDE1MDAwCgpjb25zdCBWRVJZX0xPV19QUklPUklUWSA9IDAKY29uc3QgTE9XX1BSSU9SSVRZID0gMQpjb25zdCBOT1JNQUxfUFJJT1JJVFkgPSAyCmNvbnN0IEhJR0hfUFJJT1JJVFkgPSAzCmNvbnN0IFZFUllfSElHSF9QUklPUklUWSA9IDQKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUGVlckluZm8gZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKHsgcHVibGljS2V5LCByZWxheUFkZHJlc3NlcyB9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5wdWJsaWNLZXkgPSB1bnNsYWIocHVibGljS2V5KQogICAgdGhpcy5yZWxheUFkZHJlc3NlcyA9IHJlbGF5QWRkcmVzc2VzCgogICAgdGhpcy5yZWNvbm5lY3RpbmcgPSB0cnVlCiAgICB0aGlzLnByb3ZlbiA9IGZhbHNlCiAgICB0aGlzLmNvbm5lY3RlZFRpbWUgPSAtMQogICAgdGhpcy5kaXNjb25uZWN0ZWRUaW1lID0gMAogICAgdGhpcy5iYW5uZWQgPSBmYWxzZQogICAgdGhpcy50cmllZCA9IGZhbHNlCiAgICB0aGlzLmV4cGxpY2l0ID0gZmFsc2UKICAgIHRoaXMud2FpdGluZyA9IGZhbHNlCiAgICB0aGlzLmZvcmNlUmVsYXlpbmcgPSBmYWxzZQoKICAgIC8vIFNldCBieSB0aGUgU3dhcm0KICAgIHRoaXMucXVldWVkID0gZmFsc2UKICAgIHRoaXMuY2xpZW50ID0gZmFsc2UKICAgIHRoaXMudG9waWNzID0gW10gLy8gVE9ETzogcmVtb3ZlIG9uIG5leHQgbWFqb3IgKGNoZWNrIHdpdGggbWFmaW50b3NoIGZvciBjb250ZXh0KQoKICAgIHRoaXMuYXR0ZW1wdHMgPSAwCiAgICB0aGlzLnByaW9yaXR5ID0gTk9STUFMX1BSSU9SSVRZCgogICAgLy8gVXNlZCBieSBzaHVmZmxlZC1wcmlvcml0eS1xdWV1ZQogICAgdGhpcy5faW5kZXggPSAwCgogICAgLy8gVXNlZCBmb3IgZmx1c2ggbWFuYWdlbWVudAogICAgdGhpcy5fZmx1c2hUaWNrID0gMAoKICAgIC8vIFVzZWQgZm9yIHRvcGljIG11bHRpcGxleGluZwogICAgdGhpcy5fc2VlblRvcGljcyA9IG5ldyBTZXQoKQogIH0KCiAgZ2V0IHNlcnZlcigpIHsKICAgIHJldHVybiAhdGhpcy5jbGllbnQKICB9CgogIGdldCBwcmlvcml0aXplZCgpIHsKICAgIHJldHVybiB0aGlzLnByaW9yaXR5ID49IE5PUk1BTF9QUklPUklUWQogIH0KCiAgX2dldFByaW9yaXR5KCkgewogICAgY29uc3QgcGVlcklzU3RhbGUgPSB0aGlzLnRyaWVkICYmICF0aGlzLnByb3ZlbgogICAgaWYgKHBlZXJJc1N0YWxlIHx8IHRoaXMuYXR0ZW1wdHMgPiAzKSByZXR1cm4gVkVSWV9MT1dfUFJJT1JJVFkKICAgIGlmICh0aGlzLmF0dGVtcHRzID09PSAzKSByZXR1cm4gTE9XX1BSSU9SSVRZCiAgICBpZiAodGhpcy5hdHRlbXB0cyA9PT0gMikgcmV0dXJuIEhJR0hfUFJJT1JJVFkKICAgIGlmICh0aGlzLmF0dGVtcHRzID09PSAxKSByZXR1cm4gVkVSWV9ISUdIX1BSSU9SSVRZCiAgICByZXR1cm4gTk9STUFMX1BSSU9SSVRZCiAgfQoKICBfY29ubmVjdGVkKCkgewogICAgdGhpcy5wcm92ZW4gPSB0cnVlCiAgICB0aGlzLmNvbm5lY3RlZFRpbWUgPSBEYXRlLm5vdygpCiAgfQoKICBfZGlzY29ubmVjdGVkKCkgewogICAgdGhpcy5kaXNjb25uZWN0ZWRUaW1lID0gRGF0ZS5ub3coKQogICAgaWYgKHRoaXMuY29ubmVjdGVkVGltZSA+IC0xKSB7CiAgICAgIGlmICh0aGlzLmRpc2Nvbm5lY3RlZFRpbWUgLSB0aGlzLmNvbm5lY3RlZFRpbWUgPj0gTUlOX0NPTk5FQ1RJT05fVElNRSkgdGhpcy5hdHRlbXB0cyA9IDAgLy8gZmFzdCByZXRyeQogICAgICB0aGlzLmNvbm5lY3RlZFRpbWUgPSAtMQogICAgfQogICAgdGhpcy5hdHRlbXB0cysrCiAgfQoKICBfZGVwcmlvcml0aXplKCkgewogICAgdGhpcy5hdHRlbXB0cyA9IDMKICB9CgogIF9yZXNldCgpIHsKICAgIHRoaXMuY2xpZW50ID0gZmFsc2UKICAgIHRoaXMucHJvdmVuID0gZmFsc2UKICAgIHRoaXMudHJpZWQgPSBmYWxzZQogICAgdGhpcy5hdHRlbXB0cyA9IDAKICB9CgogIF91cGRhdGVQcmlvcml0eSgpIHsKICAgIGlmICh0aGlzLmV4cGxpY2l0ICYmIHRoaXMuYXR0ZW1wdHMgPiAzKSB0aGlzLl9kZXByaW9yaXRpemUoKQogICAgaWYgKHRoaXMuYmFubmVkIHx8IHRoaXMucXVldWVkIHx8IHRoaXMuYXR0ZW1wdHMgPiAzKSByZXR1cm4gZmFsc2UKICAgIHRoaXMucHJpb3JpdHkgPSB0aGlzLl9nZXRQcmlvcml0eSgpCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3RvcGljKHRvcGljKSB7CiAgICBjb25zdCB0b3BpY1N0cmluZyA9IGI0YS50b1N0cmluZyh0b3BpYywgJ2hleCcpCiAgICBpZiAodGhpcy5fc2VlblRvcGljcy5oYXModG9waWNTdHJpbmcpKSByZXR1cm4KICAgIHRoaXMuX3NlZW5Ub3BpY3MuYWRkKHRvcGljU3RyaW5nKQogICAgdGhpcy50b3BpY3MucHVzaCh0b3BpYykKICAgIHRoaXMuZW1pdCgndG9waWMnLCB0b3BpYykKICB9CgogIHJlY29ubmVjdCh2YWwpIHsKICAgIHRoaXMucmVjb25uZWN0aW5nID0gISF2YWwKICB9CgogIGJhbih2YWwpIHsKICAgIHRoaXMuYmFubmVkID0gISF2YWwKICB9CgogIHNob3VsZEdDKCkgewogICAgcmV0dXJuICEodGhpcy5iYW5uZWQgfHwgdGhpcy5xdWV1ZWQgfHwgdGhpcy5leHBsaWNpdCB8fCB0aGlzLndhaXRpbmcpCiAgfQp9CmNvbnN0IEJ1bGtUaW1lciA9IHJlcXVpcmUoJy4vYnVsay10aW1lcicpCgpjb25zdCBCQUNLT0ZGX0pJVFRFUiA9IDUwMApjb25zdCBCQUNLT0ZGX1MgPSAxMDAwICsgTWF0aC5yb3VuZChCQUNLT0ZGX0pJVFRFUiAqIE1hdGgucmFuZG9tKCkpCmNvbnN0IEJBQ0tPRkZfTSA9IDUwMDAgKyBNYXRoLnJvdW5kKDIgKiBCQUNLT0ZGX0pJVFRFUiAqIE1hdGgucmFuZG9tKCkpCmNvbnN0IEJBQ0tPRkZfTCA9IDE1MDAwICsgTWF0aC5yb3VuZCg0ICogQkFDS09GRl9KSVRURVIgKiBNYXRoLnJhbmRvbSgpKQpjb25zdCBCQUNLT0ZGX1ggPSAxMDAwICogNjAgKiAxMCArIE1hdGgucm91bmQoMjQwICogQkFDS09GRl9KSVRURVIgKiBNYXRoLnJhbmRvbSgpKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSZXRyeVRpbWVyIHsKICBjb25zdHJ1Y3RvcigKICAgIHB1c2gsCiAgICB7IGJhY2tvZmZzID0gW0JBQ0tPRkZfUywgQkFDS09GRl9NLCBCQUNLT0ZGX0wsIEJBQ0tPRkZfWF0sIGppdHRlciA9IEJBQ0tPRkZfSklUVEVSIH0gPSB7fQogICkgewogICAgdGhpcy5qaXR0ZXIgPSBqaXR0ZXIKICAgIHRoaXMuYmFja29mZnMgPSBiYWNrb2ZmcwoKICAgIHRoaXMuX3NUaW1lciA9IG5ldyBCdWxrVGltZXIoYmFja29mZnNbMF0gKyBNYXRoLnJvdW5kKGppdHRlciAqIE1hdGgucmFuZG9tKCkpLCBwdXNoKQogICAgdGhpcy5fbVRpbWVyID0gbmV3IEJ1bGtUaW1lcihiYWNrb2Zmc1sxXSArIE1hdGgucm91bmQoaml0dGVyICogTWF0aC5yYW5kb20oKSksIHB1c2gpCiAgICB0aGlzLl9sVGltZXIgPSBuZXcgQnVsa1RpbWVyKGJhY2tvZmZzWzJdICsgTWF0aC5yb3VuZChqaXR0ZXIgKiBNYXRoLnJhbmRvbSgpKSwgcHVzaCkKICAgIHRoaXMuX3hUaW1lciA9IG5ldyBCdWxrVGltZXIoYmFja29mZnNbM10gKyBNYXRoLnJvdW5kKGppdHRlciAqIE1hdGgucmFuZG9tKCkpLCBwdXNoKQogIH0KCiAgX3NlbGVjdFJldHJ5VGltZXIocGVlckluZm8pIHsKICAgIGlmIChwZWVySW5mby5iYW5uZWQgfHwgIXBlZXJJbmZvLnJlY29ubmVjdGluZykgcmV0dXJuIG51bGwKCiAgICBpZiAocGVlckluZm8uYXR0ZW1wdHMgPiAzKSB7CiAgICAgIHJldHVybiBwZWVySW5mby5leHBsaWNpdCA/IHRoaXMuX3hUaW1lciA6IG51bGwKICAgIH0KCiAgICBpZiAocGVlckluZm8uYXR0ZW1wdHMgPT09IDApIHJldHVybiB0aGlzLl9zVGltZXIKICAgIGlmIChwZWVySW5mby5wcm92ZW4pIHsKICAgICAgc3dpdGNoIChwZWVySW5mby5hdHRlbXB0cykgewogICAgICAgIGNhc2UgMToKICAgICAgICAgIHJldHVybiB0aGlzLl9zVGltZXIKICAgICAgICBjYXNlIDI6CiAgICAgICAgICByZXR1cm4gdGhpcy5fbVRpbWVyCiAgICAgICAgY2FzZSAzOgogICAgICAgICAgcmV0dXJuIHRoaXMuX2xUaW1lcgogICAgICB9CiAgICB9IGVsc2UgewogICAgICBzd2l0Y2ggKHBlZXJJbmZvLmF0dGVtcHRzKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgICAgcmV0dXJuIHRoaXMuX21UaW1lcgogICAgICAgIGNhc2UgMjoKICAgICAgICAgIHJldHVybiB0aGlzLl9sVGltZXIKICAgICAgICBjYXNlIDM6CiAgICAgICAgICByZXR1cm4gdGhpcy5fbFRpbWVyCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgYWRkKHBlZXJJbmZvKSB7CiAgICBjb25zdCB0aW1lciA9IHRoaXMuX3NlbGVjdFJldHJ5VGltZXIocGVlckluZm8pCiAgICBpZiAoIXRpbWVyKSByZXR1cm4gZmFsc2UKCiAgICB0aW1lci5hZGQocGVlckluZm8pCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgZGVzdHJveSgpIHsKICAgIHRoaXMuX3NUaW1lci5kZXN0cm95KCkKICAgIHRoaXMuX21UaW1lci5kZXN0cm95KCkKICAgIHRoaXMuX2xUaW1lci5kZXN0cm95KCkKICAgIHRoaXMuX3hUaW1lci5kZXN0cm95KCkKICB9Cn0KewogICJuYW1lIjogImh5cGVyc3dhcm0iLAogICJ2ZXJzaW9uIjogIjQuMTYuMCIsCiAgImRlc2NyaXB0aW9uIjogIkEgZGlzdHJpYnV0ZWQgbmV0d29ya2luZyBzdGFjayBmb3IgY29ubmVjdGluZyBwZWVycyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJsaWIvKiouanMiCiAgXSwKICAiaW1wb3J0cyI6IHsKICAgICJldmVudHMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZXZlbnRzIiwKICAgICAgImRlZmF1bHQiOiAiZXZlbnRzIgogICAgfQogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuMy4xIiwKICAgICJiYXJlLWV2ZW50cyI6ICJeMi4yLjAiLAogICAgImh5cGVyZGh0IjogIl42LjIxLjAiLAogICAgInNhZmV0eS1jYXRjaCI6ICJeMS4wLjIiLAogICAgInNodWZmbGVkLXByaW9yaXR5LXF1ZXVlIjogIl4yLjEuMCIsCiAgICAic3RyZWFteCI6ICJeMi4yMi4xIiwKICAgICJ1bnNsYWIiOiAiXjEuMy4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjAuMiIsCiAgICAiaHlwZXJjb3JlLWNyeXB0byI6ICJeMy40LjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIiwKICAgICJsaW50IjogInByZXR0aWVyIC0tY2hlY2sgLiIsCiAgICAidGVzdCI6ICJub2RlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmdlbmVyYXRlIjogImJyaXR0bGUgLXIgdGVzdC9hbGwuanMgdGVzdC8qLmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJzd2FybS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJjb250cmlidXRvcnMiOiBbCiAgICAiRGF2aWQgTWFyayBDbGVtZW50cyAoQGRhdmlkbWFya2NsZW0pIiwKICAgICJBbmRyZXcgT3NoZXJvZmYgKEBhbmRyZXdvc2gpIgogIF0sCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyc3dhcm0vaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcnN3YXJtIgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBFTVBUWSA9IGI0YS5hbGxvYygwKQpjb25zdCBNQVggPSBiNGEuZnJvbShbMHhmZl0pCmNvbnN0IEJVRkZFUiA9IHt9CgpCVUZGRVIucHJlZW5jb2RlID0gZnVuY3Rpb24gKHN0YXRlLCBidWYpIHsKICBpZiAoYnVmID09PSBudWxsKSBidWYgPSBFTVBUWQoKICBsZXQgaSA9IDAKICBsZXQgZXh0cmEgPSAzCgogIHdoaWxlICgoaSA9IGI0YS5pbmRleE9mKGJ1ZiwgMHgwMCwgaSkpID4gLTEpIHsKICAgIGkrKwogICAgZXh0cmErKwogIH0KCiAgc3RhdGUuZW5kICs9IGJ1Zi5ieXRlTGVuZ3RoICsgZXh0cmEKfQoKQlVGRkVSLmVuY29kZSA9IGZ1bmN0aW9uIChzdGF0ZSwgYnVmKSB7CiAgaWYgKGJ1ZiA9PT0gbnVsbCkgYnVmID0gRU1QVFkKCiAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHgwMAoKICBsZXQgcHJldiA9IDAKICBsZXQgaSA9IDAKCiAgd2hpbGUgKChpID0gYjRhLmluZGV4T2YoYnVmLCAweDAwLCBpKSkgPiAtMSkgewogICAgY29uc3Qgc2xpY2UgPSBidWYuc3ViYXJyYXkocHJldiwgKytpKQoKICAgIHN0YXRlLmJ1ZmZlci5zZXQoc2xpY2UsIHN0YXRlLnN0YXJ0KQogICAgc3RhdGUuc3RhcnQgKz0gc2xpY2UuYnl0ZUxlbmd0aAogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHgwMgogICAgcHJldiA9IGkKICB9CgogIGNvbnN0IHNsaWNlID0gYnVmLnN1YmFycmF5KHByZXYpCgogIHN0YXRlLmJ1ZmZlci5zZXQoc2xpY2UsIHN0YXRlLnN0YXJ0KQogIHN0YXRlLnN0YXJ0ICs9IHNsaWNlLmJ5dGVMZW5ndGgKCiAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHgwMAogIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4MDEKfQoKQlVGRkVSLmRlY29kZSA9IGZ1bmN0aW9uIChzdGF0ZSkgewogIGlmIChzdGF0ZS5zdGFydCA+PSBzdGF0ZS5lbmQpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgaWYgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAhPT0gMHgwMCkgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHN0YXJ0IG9mIHN0cmluZycpCgogIGxldCBlc2NhcGVkID0gbnVsbAoKICBsZXQgcHJldiA9IHN0YXRlLnN0YXJ0CiAgbGV0IGkgPSBzdGF0ZS5zdGFydAoKICB3aGlsZSAoKGkgPSBiNGEuaW5kZXhPZihzdGF0ZS5idWZmZXIsIDB4MDAsIGkpKSA+IC0xKSB7CiAgICBjb25zdCBuZXh0ID0gKytpIDwgc3RhdGUuZW5kID8gc3RhdGUuYnVmZmVyW2ldIDogMHgwMAoKICAgIGkrKwoKICAgIGlmIChuZXh0ID09PSAweDAxKSB7CiAgICAgIGJyZWFrCiAgICB9CgogICAgaWYgKG5leHQgPT09IDB4MDIpIHsKICAgICAgaWYgKGVzY2FwZWQgPT09IG51bGwpIGVzY2FwZWQgPSBbXQogICAgICBlc2NhcGVkLnB1c2goc3RhdGUuYnVmZmVyLnN1YmFycmF5KHByZXYsIGkgLSAxKSkKICAgICAgcHJldiA9IGkKICAgICAgY29udGludWUKICAgIH0KCiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gdmFsdWUgaW4gdGVybWluYXRvcicpCiAgfQoKICBpZiAoaSA9PT0gLTEpIHsKICAgIHRocm93IG5ldyBFcnJvcignTm8gdGVybWluYXRvciBmb3VuZCcpCiAgfQoKICBzdGF0ZS5zdGFydCA9IGkKICBjb25zdCBsYXN0ID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHByZXYsIGkgLSAyKQogIGlmIChlc2NhcGVkID09PSBudWxsKSByZXR1cm4gbGFzdAoKICBlc2NhcGVkLnB1c2gobGFzdCkKICByZXR1cm4gYjRhLmNvbmNhdChlc2NhcGVkKQp9CgovLyBUT0RPOiBjYW4gYmUgb3B0aW1pc2VkIGEgbG90Cgpjb25zdCBTVFJJTkcgPSB7fQoKU1RSSU5HLnByZWVuY29kZSA9IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7CiAgQlVGRkVSLnByZWVuY29kZShzdGF0ZSwgYjRhLmZyb20oc3RyIHx8ICcnKSkKfQoKU1RSSU5HLmVuY29kZSA9IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7CiAgQlVGRkVSLmVuY29kZShzdGF0ZSwgYjRhLmZyb20oc3RyIHx8ICcnKSkKfQoKU1RSSU5HLmRlY29kZSA9IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7CiAgcmV0dXJuIGI0YS50b1N0cmluZyhCVUZGRVIuZGVjb2RlKHN0YXRlKSkKfQoKY29uc3QgVUlOVCA9IHt9CgpVSU5ULnByZWVuY29kZSA9IGZ1bmN0aW9uIChzdGF0ZSwgbikgewogIHN0YXRlLmVuZCArPSBuIDw9IDB4ZmIgPyAxIDogbiA8PSAweGZmZmYgPyAzIDogbiA8PSAweGZmZmZmZmZmID8gNSA6IChuID09PSBJbmZpbml0eSA/IDEgOiA5KQp9CgpVSU5ULmVuY29kZSA9IGZ1bmN0aW9uIChzdGF0ZSwgbikgewogIGlmIChuID09PSBJbmZpbml0eSkgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHhmZgogICAgcmV0dXJuCiAgfQoKICBpZiAobiA8PSAweGZiKSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuCiAgICByZXR1cm4KICB9CgogIGlmIChuIDw9IDB4ZmZmZikgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHhmYwogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gOAogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgogICAgcmV0dXJuCiAgfQoKICBpZiAobiA8PSAweGZmZmZmZmZmKSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweGZkCiAgICBlbmNvZGVVaW50MzIoc3RhdGUsIG4pCiAgICByZXR1cm4KICB9CgogIGlmIChOdW1iZXIuaXNTYWZlSW50ZWdlcihuKSkgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHhmZQoKICAgIGNvbnN0IHIgPSBNYXRoLmZsb29yKG4gLyAweDEwMDAwMDAwMCkKICAgIGVuY29kZVVpbnQzMihzdGF0ZSwgcikKICAgIGVuY29kZVVpbnQzMihzdGF0ZSwgbikKICAgIHJldHVybgogIH0KCiAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIG51bWJlciAnICsgbikKfQoKVUlOVC5kZWNvZGUgPSBmdW5jdGlvbiAoc3RhdGUpIHsKICBpZiAoc3RhdGUuc3RhcnQgPj0gc3RhdGUuZW5kKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQoKICBjb25zdCBhID0gc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCgogIGlmIChhIDw9IDB4ZmIpIHJldHVybiBhCgogIGlmIChhID09PSAweGZjKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCAyKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuICgKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMHgxMDAgKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICkKICB9CgogIGlmIChhID09PSAweGZkKSB7CiAgICByZXR1cm4gZGVjb2RlVWludDMyKHN0YXRlKQogIH0KCiAgaWYgKGEgPT09IDB4ZmUpIHsKICAgIHJldHVybiAoCiAgICAgIGRlY29kZVVpbnQzMihzdGF0ZSkgKiAweDEwMDAwMDAwMCArCiAgICAgIGRlY29kZVVpbnQzMihzdGF0ZSkKICAgICkKICB9CgogIHJldHVybiBJbmZpbml0eQp9Cgpjb25zdCBCT09MID0ge30KCkJPT0wucHJlZW5jb2RlID0gKHN0YXRlLCBiKSA9PiBVSU5ULnByZWVuY29kZShzdGF0ZSwgYiA/IDEgOiAwKQpCT09MLmVuY29kZSA9IChzdGF0ZSwgYikgPT4gVUlOVC5lbmNvZGUoc3RhdGUsIGIgPyAxIDogMCkKQk9PTC5kZWNvZGUgPSAoc3RhdGUsIGIpID0+ICEhVUlOVC5kZWNvZGUoc3RhdGUpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEluZGV4RW5jb2RlciB7CiAgY29uc3RydWN0b3IgKGVuY29kaW5ncywgeyBwcmVmaXggPSAtMSB9ID0ge30pIHsKICAgIHRoaXMuZW5jb2RpbmdzID0gZW5jb2RpbmdzCiAgICB0aGlzLnByZWZpeCA9IHByZWZpeAogIH0KCiAgc3RhdGljIEJVRkZFUiA9IEJVRkZFUgogIHN0YXRpYyBTVFJJTkcgPSBTVFJJTkcKICBzdGF0aWMgVUlOVCA9IFVJTlQKICBzdGF0aWMgQk9PTCA9IEJPT0wKCiAgc3RhdGljIGxvb2t1cCAoYykgewogICAgc3dpdGNoIChjKSB7CiAgICAgIGNhc2UgJ3VpbnQnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50OCc6IHJldHVybiBVSU5UCiAgICAgIGNhc2UgJ3VpbnQxNic6IHJldHVybiBVSU5UCiAgICAgIGNhc2UgJ3VpbnQyNCc6IHJldHVybiBVSU5UCiAgICAgIGNhc2UgJ3VpbnQzMic6IHJldHVybiBVSU5UCiAgICAgIGNhc2UgJ3VpbnQ0MCc6IHJldHVybiBVSU5UCiAgICAgIGNhc2UgJ3VpbnQ0OCc6IHJldHVybiBVSU5UCiAgICAgIGNhc2UgJ3VpbnQ1Nic6IHJldHVybiBVSU5UCiAgICAgIGNhc2UgJ3VpbnQ2NCc6IHJldHVybiBVSU5UCiAgICAgIGNhc2UgJ3N0cmluZyc6IHJldHVybiBTVFJJTkcKICAgICAgY2FzZSAndXRmOCc6IHJldHVybiBTVFJJTkcKICAgICAgY2FzZSAnYXNjaWknOiByZXR1cm4gU1RSSU5HCiAgICAgIGNhc2UgJ2hleCc6IHJldHVybiBTVFJJTkcKICAgICAgY2FzZSAnYmFzZTY0JzogcmV0dXJuIFNUUklORwogICAgICBjYXNlICdmaXhlZDMyJzogcmV0dXJuIEJVRkZFUgogICAgICBjYXNlICdmaXhlZDY0JzogcmV0dXJuIEJVRkZFUgogICAgICBjYXNlICdidWZmZXInOiByZXR1cm4gQlVGRkVSCiAgICAgIGNhc2UgJ2Jvb2wnOiByZXR1cm4gQk9PTAogICAgfQoKICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biB0eXBlJykKICB9CgogIGVuY29kZSAoa2V5cykgewogICAgcmV0dXJuIHRoaXMuX2VuY29kZShrZXlzLCBmYWxzZSkKICB9CgogIF9lbmNvZGUgKGtleXMsIHRlcm1pbmF0ZSkgewogICAgaWYgKGI0YS5pc0J1ZmZlcihrZXlzKSkgcmV0dXJuIGtleXMKCiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogMCwgYnVmZmVyOiBudWxsIH0KCiAgICBpZiAodGhpcy5wcmVmaXggIT09IC0xKSBVSU5ULnByZWVuY29kZShzdGF0ZSwgdGhpcy5wcmVmaXgpCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgdGhpcy5lbmNvZGluZ3NbaV0ucHJlZW5jb2RlKHN0YXRlLCBrZXlzW2ldKQogICAgfQoKICAgIGlmICh0ZXJtaW5hdGUgJiYga2V5cy5sZW5ndGggPCB0aGlzLmVuY29kaW5ncy5sZW5ndGgpIHsKICAgICAgc3RhdGUuZW5kKysKICAgIH0KCiAgICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQoKICAgIGlmICh0aGlzLnByZWZpeCAhPT0gLTEpIFVJTlQuZW5jb2RlKHN0YXRlLCB0aGlzLnByZWZpeCkKICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICB0aGlzLmVuY29kaW5nc1tpXS5lbmNvZGUoc3RhdGUsIGtleXNbaV0pCiAgICB9CgogICAgaWYgKHRlcm1pbmF0ZSAmJiBrZXlzLmxlbmd0aCA8IHRoaXMuZW5jb2RpbmdzLmxlbmd0aCkgewogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBNQVhbMF0KICAgIH0KCiAgICByZXR1cm4gc3RhdGUuYnVmZmVyCiAgfQoKICBkZWNvZGUgKGJ1ZmZlcikgewogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoLCBidWZmZXIgfQogICAgY29uc3QgcmVzdWx0ID0gW10KCiAgICBpZiAodGhpcy5wcmVmaXggIT09IC0xKSBVSU5ULmRlY29kZShzdGF0ZSkKICAgIGZvciAoY29uc3QgZW5jIG9mIHRoaXMuZW5jb2RpbmdzKSB7CiAgICAgIGNvbnN0IGtleSA9IHN0YXRlLnN0YXJ0IDwgc3RhdGUuZW5kID8gZW5jLmRlY29kZShzdGF0ZSkgOiAoZW5jID09PSBVSU5UID8gMCA6IG51bGwpCiAgICAgIHJlc3VsdC5wdXNoKGtleSkKICAgIH0KCiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICBlbmNvZGVSYW5nZSAoeyBndCwgZ3RlLCBsdCwgbHRlIH0pIHsKICAgIGNvbnN0IHJhbmdlID0gewogICAgICBndDogZ3QgJiYgdGhpcy5fZW5jb2RlKGd0LCB0cnVlKSwKICAgICAgZ3RlOiBndGUgJiYgdGhpcy5fZW5jb2RlKGd0ZSwgZmFsc2UpLAogICAgICBsdDogbHQgJiYgdGhpcy5fZW5jb2RlKGx0LCBmYWxzZSksCiAgICAgIGx0ZTogbHRlICYmIHRoaXMuX2VuY29kZShsdGUsIHRydWUpCiAgICB9CgogICAgaWYgKHRoaXMucHJlZml4ICE9PSAtMSkgewogICAgICBpZiAoIWd0ICYmICFndGUpIHJhbmdlLmd0ZSA9IGVuY29kZVVpbnQodGhpcy5wcmVmaXgpCiAgICAgIGlmICghbHQgJiYgIWx0ZSkgcmFuZ2UubHQgPSBlbmNvZGVVaW50KHRoaXMucHJlZml4ICsgMSkKICAgIH0KCiAgICByZXR1cm4gcmFuZ2UKICB9Cn0KCmZ1bmN0aW9uIGVuY29kZVVpbnQgKG4pIHsKICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogMCwgYnVmZmVyOiBudWxsIH0KICBVSU5ULnByZWVuY29kZShzdGF0ZSwgbikKICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBuKQogIHJldHVybiBzdGF0ZS5idWZmZXIKfQoKZnVuY3Rpb24gZW5jb2RlVWludDMyIChzdGF0ZSwgbikgewogIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDI0CiAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gMTYKICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuID4+PiA4CiAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgp9CgpmdW5jdGlvbiBkZWNvZGVVaW50MzIgKHN0YXRlLCBuKSB7CiAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgNCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICByZXR1cm4gKAogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMHgxMDAwMDAwICsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwMDAgKwogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMHgxMDAgKwogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgKQp9CnsKICAibmFtZSI6ICJpbmRleC1lbmNvZGVyIiwKICAidmVyc2lvbiI6ICIzLjQuMCIsCiAgImRlc2NyaXB0aW9uIjogIkVuY29kZSBtdWx0aXBsZSB2YWx1ZXMgaW50byBzb3J0ZWQga2V5cyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4yLjEiLAogICAgImh5cGVyYmVlIjogIl4yLjEwLjUiLAogICAgImh5cGVyY29yZSI6ICJeMTAuOS4yIiwKICAgICJyYW5kb20tYWNjZXNzLW1lbW9yeSI6ICJeNi4yLjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2luZGV4LWVuY29kZXIuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2luZGV4LWVuY29kZXIvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9pbmRleC1lbmNvZGVyIgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGlzT3B0aW9ucyAob3B0cykgewogIHJldHVybiB0eXBlb2Ygb3B0cyA9PT0gJ29iamVjdCcgJiYgb3B0cyAmJiAhYjRhLmlzQnVmZmVyKG9wdHMpCn0KewogICJuYW1lIjogImlzLW9wdGlvbnMiLAogICJ2ZXJzaW9uIjogIjEuMC4yIiwKICAiZGVzY3JpcHRpb24iOiAiRWFzaWx5IGNoZWNrIGlmIGlucHV0IGlzIGFuIG9wdGlvbnMgbWFwIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuMS4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTEuMC4xIiwKICAgICJ0YXBlIjogIl40LjkuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgdGFwZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2lzLW9wdGlvbnMuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2lzLW9wdGlvbnMvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvaXMtb3B0aW9ucyIKfQpjb25zdCB7IEV2ZW50RW1pdHRlciB9ID0gcmVxdWlyZSgnZXZlbnRzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUm91dGluZ1RhYmxlIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvciAoaWQsIG9wdHMpIHsKICAgIGlmICghb3B0cykgb3B0cyA9IHt9CgogICAgc3VwZXIoKQoKICAgIHRoaXMuaWQgPSBpZAogICAgdGhpcy5rID0gb3B0cy5rIHx8IDIwCiAgICB0aGlzLnNpemUgPSAwCiAgICB0aGlzLnJvd3MgPSBuZXcgQXJyYXkoaWQubGVuZ3RoICogOCkKICB9CgogIGFkZCAobm9kZSkgewogICAgY29uc3QgaSA9IHRoaXMuX2RpZmYobm9kZS5pZCkKCiAgICBsZXQgcm93ID0gdGhpcy5yb3dzW2ldCgogICAgaWYgKCFyb3cpIHsKICAgICAgcm93ID0gdGhpcy5yb3dzW2ldID0gbmV3IFJvdyh0aGlzLCBpKQogICAgICB0aGlzLmVtaXQoJ3JvdycsIHJvdykKICAgIH0KCiAgICBjb25zdCBsZW4gPSByb3cubm9kZXMubGVuZ3RoCiAgICBpZiAoIXJvdy5hZGQobm9kZSwgdGhpcy5rKSkgcmV0dXJuIGZhbHNlCgogICAgdGhpcy5zaXplICs9IHJvdy5ub2Rlcy5sZW5ndGggLSBsZW4KICAgIHJldHVybiB0cnVlCiAgfQoKICByZW1vdmUgKGlkKSB7CiAgICBjb25zdCBpID0gdGhpcy5fZGlmZihpZCkKICAgIGNvbnN0IHJvdyA9IHRoaXMucm93c1tpXQogICAgaWYgKCFyb3cpIHJldHVybiBmYWxzZQogICAgaWYgKCFyb3cucmVtb3ZlKGlkKSkgcmV0dXJuIGZhbHNlCiAgICB0aGlzLnNpemUtLQogICAgcmV0dXJuIHRydWUKICB9CgogIGdldCAoaWQpIHsKICAgIGNvbnN0IGkgPSB0aGlzLl9kaWZmKGlkKQogICAgY29uc3Qgcm93ID0gdGhpcy5yb3dzW2ldCiAgICBpZiAoIXJvdykgcmV0dXJuIG51bGwKICAgIHJldHVybiByb3cuZ2V0KGlkKQogIH0KCiAgaGFzIChpZCkgewogICAgcmV0dXJuIHRoaXMuZ2V0KGlkKSAhPT0gbnVsbAogIH0KCiAgcmFuZG9tICgpIHsKICAgIGxldCBuID0gKE1hdGgucmFuZG9tKCkgKiB0aGlzLnNpemUpIHwgMAoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5yb3dzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHIgPSB0aGlzLnJvd3NbaV0KICAgICAgaWYgKCFyKSBjb250aW51ZQogICAgICBpZiAobiA8IHIubm9kZXMubGVuZ3RoKSByZXR1cm4gci5ub2Rlc1tuXQogICAgICBuIC09IHIubm9kZXMubGVuZ3RoCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIGNsb3Nlc3QgKGlkLCBrKSB7CiAgICBpZiAoIWspIGsgPSB0aGlzLmsKCiAgICBjb25zdCByZXN1bHQgPSBbXQogICAgY29uc3QgZCA9IHRoaXMuX2RpZmYoaWQpCgogICAgLy8gcHVzaCBjbG9zZSBub2RlcwogICAgZm9yIChsZXQgaSA9IGQ7IGkgPj0gMCAmJiByZXN1bHQubGVuZ3RoIDwgazsgaS0tKSB0aGlzLl9wdXNoTm9kZXMoaSwgaywgcmVzdWx0KQoKICAgIC8vIGlmIHdlIGRvbid0IGhhdmUgZW5vdWdoIGNsb3NlIG5vZGVzLCBwb3B1bGF0ZSBmcm9tIG90aGVyIHJvd3MsIHJlIHRoZSBwYXBlcgogICAgZm9yIChsZXQgaSA9IGQgKyAxOyBpIDwgdGhpcy5yb3dzLmxlbmd0aCAmJiByZXN1bHQubGVuZ3RoIDwgazsgaSsrKSB0aGlzLl9wdXNoTm9kZXMoaSwgaywgcmVzdWx0KQoKICAgIHJldHVybiByZXN1bHQKICB9CgogIF9wdXNoTm9kZXMgKGksIGssIHJlc3VsdCkgewogICAgY29uc3Qgcm93ID0gdGhpcy5yb3dzW2ldCiAgICBpZiAoIXJvdykgcmV0dXJuCgogICAgY29uc3QgbWlzc2luZyA9IE1hdGgubWluKGsgLSByZXN1bHQubGVuZ3RoLCByb3cubm9kZXMubGVuZ3RoKQogICAgZm9yIChsZXQgaiA9IDA7IGogPCBtaXNzaW5nOyBqKyspIHJlc3VsdC5wdXNoKHJvdy5ub2Rlc1tqXSkKICB9CgogIHRvQXJyYXkgKCkgewogICAgcmV0dXJuIHRoaXMuY2xvc2VzdCh0aGlzLmlkLCBJbmZpbml0eSkKICB9CgogIF9kaWZmIChpZCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpZC5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBhID0gaWRbaV0KICAgICAgY29uc3QgYiA9IHRoaXMuaWRbaV0KCiAgICAgIGlmIChhICE9PSBiKSByZXR1cm4gaSAqIDggKyBNYXRoLmNsejMyKGEgXiBiKSAtIDI0CiAgICB9CgogICAgcmV0dXJuIHRoaXMucm93cy5sZW5ndGggLSAxCiAgfQp9CgpjbGFzcyBSb3cgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yICh0YWJsZSwgaW5kZXgpIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmRhdGEgPSBudWxsIC8vIGNhbiBiZSB1c2VkIGJlIHVwc3RyZWFtIGZvciB3aGF0ZXZzCiAgICB0aGlzLmJ5dGVPZmZzZXQgPSBpbmRleCA+PiAzCiAgICB0aGlzLmluZGV4ID0gaW5kZXgKICAgIHRoaXMudGFibGUgPSB0YWJsZQogICAgdGhpcy5ub2RlcyA9IFtdCiAgfQoKICBhZGQgKG5vZGUpIHsKICAgIGNvbnN0IGlkID0gbm9kZS5pZAoKICAgIGxldCBsID0gMAogICAgbGV0IHIgPSB0aGlzLm5vZGVzLmxlbmd0aCAtIDEKCiAgICB3aGlsZSAobCA8PSByKSB7CiAgICAgIGNvbnN0IG0gPSAobCArIHIpID4+IDEKICAgICAgY29uc3QgYyA9IHRoaXMuY29tcGFyZShpZCwgdGhpcy5ub2Rlc1ttXS5pZCkKCiAgICAgIGlmIChjID09PSAwKSB7CiAgICAgICAgdGhpcy5ub2Rlc1ttXSA9IG5vZGUKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CgogICAgICBpZiAoYyA8IDApIHIgPSBtIC0gMQogICAgICBlbHNlIGwgPSBtICsgMQogICAgfQoKICAgIGlmICh0aGlzLm5vZGVzLmxlbmd0aCA+PSB0aGlzLnRhYmxlLmspIHsKICAgICAgdGhpcy5lbWl0KCdmdWxsJywgbm9kZSkKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgdGhpcy5pbnNlcnQobCwgbm9kZSkKICAgIHJldHVybiB0cnVlCiAgfQoKICByZW1vdmUgKGlkKSB7CiAgICBsZXQgbCA9IDAKICAgIGxldCByID0gdGhpcy5ub2Rlcy5sZW5ndGggLSAxCgogICAgd2hpbGUgKGwgPD0gcikgewogICAgICBjb25zdCBtID0gKGwgKyByKSA+PiAxCiAgICAgIGNvbnN0IGMgPSB0aGlzLmNvbXBhcmUoaWQsIHRoaXMubm9kZXNbbV0uaWQpCgogICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgIHRoaXMuc3BsaWNlKG0pCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQoKICAgICAgaWYgKGMgPCAwKSByID0gbSAtIDEKICAgICAgZWxzZSBsID0gbSArIDEKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIGdldCAoaWQpIHsKICAgIGxldCBsID0gMAogICAgbGV0IHIgPSB0aGlzLm5vZGVzLmxlbmd0aCAtIDEKCiAgICB3aGlsZSAobCA8PSByKSB7CiAgICAgIGNvbnN0IG0gPSAobCArIHIpID4+IDEKICAgICAgY29uc3Qgbm9kZSA9IHRoaXMubm9kZXNbbV0KICAgICAgY29uc3QgYyA9IHRoaXMuY29tcGFyZShpZCwgbm9kZS5pZCkKCiAgICAgIGlmIChjID09PSAwKSByZXR1cm4gbm9kZQogICAgICBpZiAoYyA8IDApIHIgPSBtIC0gMQogICAgICBlbHNlIGwgPSBtICsgMQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBpbnNlcnQgKGksIG5vZGUpIHsKICAgIHRoaXMubm9kZXMucHVzaChub2RlKSAvLyBwdXNoIG5vZGUgb3IgbnVsbCBvciB3aGF0ZXZzLCBqdXN0IHRyeWluZyB0byBub3QgYmUgcG9seW1vcnBoaWMKICAgIGZvciAobGV0IGogPSB0aGlzLm5vZGVzLmxlbmd0aCAtIDE7IGogPiBpOyBqLS0pIHRoaXMubm9kZXNbal0gPSB0aGlzLm5vZGVzW2ogLSAxXQogICAgdGhpcy5ub2Rlc1tpXSA9IG5vZGUKICAgIHRoaXMuZW1pdCgnYWRkJywgbm9kZSkKICB9CgogIHNwbGljZSAoaSkgewogICAgZm9yICg7IGkgPCB0aGlzLm5vZGVzLmxlbmd0aCAtIDE7IGkrKykgdGhpcy5ub2Rlc1tpXSA9IHRoaXMubm9kZXNbaSArIDFdCiAgICB0aGlzLmVtaXQoJ3JlbW92ZScsIHRoaXMubm9kZXMucG9wKCkpCiAgfQoKICAvLyB2ZXJ5IGxpa2VseSB0aGV5IGRpdmVyZ2UgYWZ0ZXIgYSBjb3VwbGUgb2YgYnl0ZXMgc28gYSBzaW1wbGUgaW1wbCwgbGlrZSB0aGlzIGlzIHByb3AgZmFzdGVzdCB2cyBCdWZmZXIuY29tcGFyZQogIGNvbXBhcmUgKGEsIGIpIHsKICAgIGZvciAobGV0IGkgPSB0aGlzLmJ5dGVPZmZzZXQ7IGkgPCBhLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGFpID0gYVtpXQogICAgICBjb25zdCBiaSA9IGJbaV0KICAgICAgaWYgKGFpID09PSBiaSkgY29udGludWUKICAgICAgcmV0dXJuIGFpIDwgYmkgPyAtMSA6IDEKICAgIH0KICAgIHJldHVybiAwCiAgfQp9CnsKICAibmFtZSI6ICJrYWRlbWxpYS1yb3V0aW5nLXRhYmxlIiwKICAidmVyc2lvbiI6ICIxLjAuNiIsCiAgImRlc2NyaXB0aW9uIjogIlhPUiBiYXNlZCByb3V0aW5nIHRhYmxlIHVzZWQgZm9yIFAyUCBuZXR3b3JrcyBzdWNoIGFzIGEgS2FkZW1saWEgREhULiIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJpbXBvcnRzIjogewogICAgImV2ZW50cyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1ldmVudHMiLAogICAgICAiZGVmYXVsdCI6ICJldmVudHMiCiAgICB9CiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtZXZlbnRzIjogIl4yLjIuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4zLjIiLAogICAgInN0YW5kYXJkIjogIl4xNy4xLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJrZXl3b3JkcyI6IFsKICAgICJrYWRlbWxpYSIsCiAgICAicDJwIiwKICAgICJrLWJ1Y2tldCIsCiAgICAiay1idWNrZXRzIiwKICAgICJ4b3IiLAogICAgInJvdXRpbmciLAogICAgImRpc3RyaWJ1dGVkIiwKICAgICJzeXN0ZW1zIgogIF0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2thZGVtbGlhLXJvdXRpbmctdGFibGUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2thZGVtbGlhLXJvdXRpbmctdGFibGUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gva2FkZW1saWEtcm91dGluZy10YWJsZSIKfQp2YXIgcXVldWVUaWNrID0gcmVxdWlyZSgncXVldWUtdGljaycpCgp2YXIgbXV0ZXhpZnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHF1ZXVlID0gW10KICB2YXIgdXNlZCA9IG51bGwKCiAgdmFyIGNhbGwgPSBmdW5jdGlvbiAoKSB7CiAgICB1c2VkKHJlbGVhc2UpCiAgfQoKICB2YXIgYWNxdWlyZSA9IGZ1bmN0aW9uIChmbikgewogICAgaWYgKHVzZWQpIHJldHVybiBxdWV1ZS5wdXNoKGZuKQogICAgdXNlZCA9IGZuCiAgICBhY3F1aXJlLmxvY2tlZCA9IHRydWUKICAgIHF1ZXVlVGljayhjYWxsKQogICAgcmV0dXJuIDAKICB9CgogIGFjcXVpcmUubG9ja2VkID0gZmFsc2UKCiAgdmFyIHJlbGVhc2UgPSBmdW5jdGlvbiAoZm4sIGVyciwgdmFsdWUpIHsKICAgIHVzZWQgPSBudWxsCiAgICBhY3F1aXJlLmxvY2tlZCA9IGZhbHNlCiAgICBpZiAocXVldWUubGVuZ3RoKSBhY3F1aXJlKHF1ZXVlLnNoaWZ0KCkpCiAgICBpZiAoZm4pIGZuKGVyciwgdmFsdWUpCiAgfQoKICByZXR1cm4gYWNxdWlyZQp9Cgptb2R1bGUuZXhwb3J0cyA9IG11dGV4aWZ5CnsKICAibmFtZSI6ICJtdXRleGlmeSIsCiAgInZlcnNpb24iOiAiMS40LjAiLAogICJkZXNjcmlwdGlvbiI6ICJtdXRleCBsb2NrIGZvciBqYXZhc2NyaXB0IiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJxdWV1ZS10aWNrIjogIl4xLjAuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE0LjMuMyIsCiAgICAidGFwZSI6ICJeMy4wLjIiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInRhcGUgdGVzdC5qcyIsCiAgICAicG9zdHRlc3QiOiAibnBtIHJ1biBsaW50IiwKICAgICJsaW50IjogInN0YW5kYXJkIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL211dGV4aWZ5LmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9tdXRleGlmeS9pc3N1ZXMiCiAgfSwKICAia2V5d29yZHMiOiBbCiAgICAibXV0ZXgiLAogICAgImxvY2siCiAgXSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9tdXRleGlmeSIKfQp2YXIgbXV0ZXhpZnkgPSByZXF1aXJlKCcuJykKCnZhciBtdXRleGlmeVByb21pc2UgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIGxvY2sgPSBtdXRleGlmeSgpCgogIHZhciBhY3F1aXJlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGxvY2spCiAgfQoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYWNxdWlyZSwgJ2xvY2tlZCcsIHsKICAgIGdldDogZnVuY3Rpb24gKCkgeyByZXR1cm4gbG9jay5sb2NrZWQgfSwKICAgIGVudW1lcmFibGU6IHRydWUKICB9KQoKICByZXR1cm4gYWNxdWlyZQp9Cgptb2R1bGUuZXhwb3J0cyA9IG11dGV4aWZ5UHJvbWlzZQptb2R1bGUuZXhwb3J0cyA9IGFzc2VydAoKY2xhc3MgQXNzZXJ0aW9uRXJyb3IgZXh0ZW5kcyBFcnJvciB7fQpBc3NlcnRpb25FcnJvci5wcm90b3R5cGUubmFtZSA9ICdBc3NlcnRpb25FcnJvcicKCi8qKgogKiBNaW5pbWFsIGFzc2VydCBmdW5jdGlvbgogKiBAcGFyYW0gIHthbnl9IHQgVmFsdWUgdG8gY2hlY2sgaWYgZmFsc3kKICogQHBhcmFtICB7c3RyaW5nPX0gbSBPcHRpb25hbCBhc3NlcnRpb24gZXJyb3IgbWVzc2FnZQogKiBAdGhyb3dzIHtBc3NlcnRpb25FcnJvcn0KICovCmZ1bmN0aW9uIGFzc2VydCAodCwgbSkgewogIGlmICghdCkgewogICAgdmFyIGVyciA9IG5ldyBBc3NlcnRpb25FcnJvcihtKQogICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZShlcnIsIGFzc2VydCkKICAgIHRocm93IGVycgogIH0KfQp7CiAgIm5hbWUiOiAibmFub2Fzc2VydCIsCiAgInZlcnNpb24iOiAiMi4wLjAiLAogICJkZXNjcmlwdGlvbiI6ICJOYW5vc2NhbGUgYXNzZXJ0aW9uIG1vZHVsZSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInRhcGUiOiAiXjQuOS4xIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJ0YXBlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vZW1pbGJheWVzL25hbm9hc3NlcnQuZ2l0IgogIH0sCiAgImtleXdvcmRzIjogWwogICAgImFzc2VydCIsCiAgICAidW5hc3NlcnQiLAogICAgInBvd2VyLWFzc2VydCIsCiAgICAidGlueSIsCiAgICAibmFubyIsCiAgICAicGljbyIKICBdLAogICJhdXRob3IiOiAiRW1pbCBCYXkgPGdpdGh1YkB0aXh6LmRrPiIsCiAgImxpY2Vuc2UiOiAiSVNDIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2VtaWxiYXllcy9uYW5vYXNzZXJ0L2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vZW1pbGJheWVzL25hbm9hc3NlcnQjcmVhZG1lIgp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgTmF0U2FtcGxlciB7CiAgY29uc3RydWN0b3IgKCkgewogICAgdGhpcy5ob3N0ID0gbnVsbAogICAgdGhpcy5wb3J0ID0gMAogICAgdGhpcy5zaXplID0gMAoKICAgIHRoaXMuX2EgPSBudWxsCiAgICB0aGlzLl9iID0gbnVsbAogICAgdGhpcy5fdGhyZXNob2xkID0gMAogICAgdGhpcy5fdG9wID0gMAogICAgdGhpcy5fc2FtcGxlcyA9IFtdCiAgfQoKICBhZGQgKGhvc3QsIHBvcnQpIHsKICAgIGNvbnN0IGEgPSB0aGlzLl9idW1wKGhvc3QsIHBvcnQsIDIpCiAgICBjb25zdCBiID0gdGhpcy5fYnVtcChob3N0LCAwLCAxKQoKICAgIGlmICh0aGlzLl9zYW1wbGVzLmxlbmd0aCA8IDMyKSB7CiAgICAgIHRoaXMuc2l6ZSsrCiAgICAgIHRoaXMuX3RocmVzaG9sZCA9IHRoaXMuc2l6ZSAtICh0aGlzLnNpemUgPCA0ID8gMCA6IHRoaXMuc2l6ZSA8IDggPyAxIDogdGhpcy5zaXplIDwgMTIgPyAyIDogMykKICAgICAgdGhpcy5fc2FtcGxlcy5wdXNoKGEsIGIpCiAgICAgIHRoaXMuX3RvcCArPSAyCiAgICB9IGVsc2UgewogICAgICBpZiAodGhpcy5fdG9wID09PSAzMikgdGhpcy5fdG9wID0gMAoKICAgICAgY29uc3Qgb2EgPSB0aGlzLl9zYW1wbGVzW3RoaXMuX3RvcF0KICAgICAgdGhpcy5fc2FtcGxlc1t0aGlzLl90b3ArK10gPSBhCiAgICAgIG9hLmhpdHMtLQoKICAgICAgY29uc3Qgb2IgPSB0aGlzLl9zYW1wbGVzW3RoaXMuX3RvcF0KICAgICAgdGhpcy5fc2FtcGxlc1t0aGlzLl90b3ArK10gPSBiCiAgICAgIG9iLmhpdHMtLQogICAgfQoKICAgIGlmICh0aGlzLl9hID09PSBudWxsIHx8IHRoaXMuX2EuaGl0cyA8IGEuaGl0cykgdGhpcy5fYSA9IGEKICAgIGlmICh0aGlzLl9iID09PSBudWxsIHx8IHRoaXMuX2IuaGl0cyA8IGIuaGl0cykgdGhpcy5fYiA9IGIKCiAgICBpZiAodGhpcy5fYS5oaXRzID49IHRoaXMuX3RocmVzaG9sZCkgewogICAgICB0aGlzLmhvc3QgPSB0aGlzLl9hLmhvc3QKICAgICAgdGhpcy5wb3J0ID0gdGhpcy5fYS5wb3J0CiAgICB9IGVsc2UgaWYgKHRoaXMuX2IuaGl0cyA+PSB0aGlzLl90aHJlc2hvbGQpIHsKICAgICAgdGhpcy5ob3N0ID0gdGhpcy5fYi5ob3N0CiAgICAgIHRoaXMucG9ydCA9IDAKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuaG9zdCA9IG51bGwKICAgICAgdGhpcy5wb3J0ID0gMAogICAgfQoKICAgIHJldHVybiBhLmhpdHMKICB9CgogIF9idW1wIChob3N0LCBwb3J0LCBpbmMpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7CiAgICAgIGNvbnN0IGogPSAodGhpcy5fdG9wIC0gaW5jIC0gKDIgKiBpKSkgJiAzMQogICAgICBpZiAoaiA+PSB0aGlzLl9zYW1wbGVzLmxlbmd0aCkgcmV0dXJuIHsgaG9zdCwgcG9ydCwgaGl0czogMSB9CiAgICAgIGNvbnN0IHMgPSB0aGlzLl9zYW1wbGVzW2pdCiAgICAgIGlmIChzLnBvcnQgPT09IHBvcnQgJiYgcy5ob3N0ID09PSBob3N0KSB7CiAgICAgICAgcy5oaXRzKysKICAgICAgICByZXR1cm4gcwogICAgICB9CiAgICB9CiAgICByZXR1cm4geyBob3N0LCBwb3J0LCBoaXRzOiAxIH0KICB9Cn0KewogICJuYW1lIjogIm5hdC1zYW1wbGVyIiwKICAidmVyc2lvbiI6ICIxLjAuMSIsCiAgImRlc2NyaXB0aW9uIjogIlNhbXBsZSBhZGRyZXNzZXMgdG8gZmlndXJlIG91dCBpZiBhIGhvc3QgKyBwb3J0IGlzIGNvbnNpc3RlbnQiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTYuMC4zIiwKICAgICJ0YXBlIjogIl41LjIuMiIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9uYXQtc2FtcGxlci5naXQiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9uYXQtc2FtcGxlci9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9uYXQtc2FtcGxlciIKfQovKiBlc2xpbnQtZGlzYWJsZSBjYW1lbGNhc2UgKi8KY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ25hbm9hc3NlcnQnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgREhMRU4gPSBzb2RpdW0uY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9CWVRFUwpjb25zdCBQS0xFTiA9IHNvZGl1bS5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X0JZVEVTCmNvbnN0IFNDQUxBUkxFTiA9IHNvZGl1bS5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X0JZVEVTCmNvbnN0IFNLTEVOID0gc29kaXVtLmNyeXB0b19zaWduX1NFQ1JFVEtFWUJZVEVTCmNvbnN0IEFMRyA9ICdFZDI1NTE5JwoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgREhMRU4sCiAgUEtMRU4sCiAgU0NBTEFSTEVOLAogIFNLTEVOLAogIEFMRywKICBuYW1lOiBBTEcsCiAgZ2VuZXJhdGVLZXlQYWlyLAogIGRoCn0KCmZ1bmN0aW9uIGdlbmVyYXRlS2V5UGFpciAocHJpdktleSkgewogIGlmIChwcml2S2V5KSByZXR1cm4gZ2VuZXJhdGVTZWVkS2V5UGFpcihwcml2S2V5LnN1YmFycmF5KDAsIDMyKSkKCiAgY29uc3Qga2V5UGFpciA9IHt9CiAga2V5UGFpci5zZWNyZXRLZXkgPSBiNGEuYWxsb2MoU0tMRU4pCiAga2V5UGFpci5wdWJsaWNLZXkgPSBiNGEuYWxsb2MoUEtMRU4pCgogIHNvZGl1bS5jcnlwdG9fc2lnbl9rZXlwYWlyKGtleVBhaXIucHVibGljS2V5LCBrZXlQYWlyLnNlY3JldEtleSkKICByZXR1cm4ga2V5UGFpcgp9CgpmdW5jdGlvbiBnZW5lcmF0ZVNlZWRLZXlQYWlyIChzZWVkKSB7CiAgY29uc3Qga2V5UGFpciA9IHt9CiAga2V5UGFpci5zZWNyZXRLZXkgPSBiNGEuYWxsb2MoU0tMRU4pCiAga2V5UGFpci5wdWJsaWNLZXkgPSBiNGEuYWxsb2MoUEtMRU4pCgogIHNvZGl1bS5jcnlwdG9fc2lnbl9zZWVkX2tleXBhaXIoa2V5UGFpci5wdWJsaWNLZXksIGtleVBhaXIuc2VjcmV0S2V5LCBzZWVkKQogIHJldHVybiBrZXlQYWlyCn0KCmZ1bmN0aW9uIGRoIChwdWJsaWNLZXksIHsgc2NhbGFyLCBzZWNyZXRLZXkgfSkgewogIC8vIHR3ZWFrZWQga2V5cyBleHBvc2Ugc2NhbGFyIGRpcmVjdGx5CiAgaWYgKCFzY2FsYXIpIHsKICAgIGFzc2VydChzZWNyZXRLZXkuYnl0ZUxlbmd0aCA9PT0gU0tMRU4pCgogICAgLy8gbGlic29kaXVtIHN0b3JlcyBzZWVkIG5vdCBhY3R1YWwgc2NhbGFyCiAgICBjb25zdCBzayA9IGI0YS5hbGxvYyg2NCkKICAgIHNvZGl1bS5jcnlwdG9faGFzaF9zaGE1MTIoc2ssIHNlY3JldEtleS5zdWJhcnJheSgwLCAzMikpCiAgICBza1swXSAmPSAyNDgKICAgIHNrWzMxXSAmPSAxMjcKICAgIHNrWzMxXSB8PSA2NAoKICAgIHNjYWxhciA9IHNrLnN1YmFycmF5KDAsIDMyKQogIH0KCiAgYXNzZXJ0KHNjYWxhci5ieXRlTGVuZ3RoID09PSBTQ0FMQVJMRU4pCiAgYXNzZXJ0KHB1YmxpY0tleS5ieXRlTGVuZ3RoID09PSBQS0xFTikKCiAgY29uc3Qgb3V0cHV0ID0gYjRhLmFsbG9jKERITEVOKQoKICAvLyB3ZSBjbGFtcCBpZiBuZWNlc3NhcnkgYWJvdmUKICBzb2RpdW0uY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9ub2NsYW1wKAogICAgb3V0cHV0LAogICAgc2NhbGFyLAogICAgcHVibGljS2V5CiAgKQoKICByZXR1cm4gb3V0cHV0Cn0KewogICJuYW1lIjogIm5vaXNlLWN1cnZlLWVkIiwKICAidmVyc2lvbiI6ICIyLjEuMCIsCiAgImRlc2NyaXB0aW9uIjogIkVkMjU1MTkgZWxsaXB0aWMgY3VydmUgb3BlcmF0aW9ucyBmb3IgW2Bub2lzZS1oYW5kc2hha2VgXShodHRwczovL2dpdGh1Yi5jb20vY2htLWRpZWRlcmljaHMvbm9pc2UtaGFuZHNoYWtlKSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAibnB4IHN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9jaG0tZGllZGVyaWNocy9ub2lzZS1jdXJ2ZS1lZC5naXQiCiAgfSwKICAia2V5d29yZHMiOiBbXSwKICAiYXV0aG9yIjogIiIsCiAgImxpY2Vuc2UiOiAiSVNDIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2NobS1kaWVkZXJpY2hzL25vaXNlLWN1cnZlLWVkL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vY2htLWRpZWRlcmljaHMvbm9pc2UtY3VydmUtZWQjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS4xLjAiLAogICAgIm5hbm9hc3NlcnQiOiAiXjIuMC4wIiwKICAgICJzb2RpdW0tdW5pdmVyc2FsIjogIl41LjAuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAibm9pc2UtaGFuZHNoYWtlIjogIl4zLjAuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE2LjAuMyIsCiAgICAidGFwZSI6ICJeNS4yLjIiCiAgfQp9CmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBDaXBoZXJTdGF0ZSB7CiAgY29uc3RydWN0b3IgKGtleSkgewogICAgdGhpcy5rZXkgPSBrZXkgfHwgbnVsbAogICAgdGhpcy5ub25jZSA9IDAKICAgIHRoaXMuQ0lQSEVSX0FMRyA9ICdDaGFDaGFQb2x5JwogIH0KCiAgaW5pdGlhbGlzZUtleSAoa2V5KSB7CiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy5ub25jZSA9IDAKICB9CgogIHNldE5vbmNlIChub25jZSkgewogICAgdGhpcy5ub25jZSA9IG5vbmNlCiAgfQoKICBlbmNyeXB0IChwbGFpbnRleHQsIGFkKSB7CiAgICBpZiAoIXRoaXMuaGFzS2V5KSByZXR1cm4gcGxhaW50ZXh0CiAgICBpZiAoIWFkKSBhZCA9IGI0YS5hbGxvYygwKQoKICAgIGNvbnN0IGNpcGhlcnRleHQgPSBlbmNyeXB0V2l0aEFEKHRoaXMua2V5LCB0aGlzLm5vbmNlLCBhZCwgcGxhaW50ZXh0KQogICAgaWYgKGNpcGhlcnRleHQubGVuZ3RoID4gNjU1MzUpIHRocm93IG5ldyBFcnJvcihgY2lwaGVydGV4dCBsZW5ndGggb2YgJHtjaXBoZXJ0ZXh0Lmxlbmd0aH0gZXhjZWVkcyBtYXhpbXVtIE5vaXNlIG1lc3NhZ2UgbGVuZ3RoIG9mIDY1NTM1YCkKICAgIHRoaXMubm9uY2UrKwoKICAgIHJldHVybiBjaXBoZXJ0ZXh0CiAgfQoKICBkZWNyeXB0IChjaXBoZXJ0ZXh0LCBhZCkgewogICAgaWYgKCF0aGlzLmhhc0tleSkgcmV0dXJuIGNpcGhlcnRleHQKICAgIGlmICghYWQpIGFkID0gYjRhLmFsbG9jKDApCiAgICBpZiAoY2lwaGVydGV4dC5sZW5ndGggPiA2NTUzNSkgdGhyb3cgbmV3IEVycm9yKGBjaXBoZXJ0ZXh0IGxlbmd0aCBvZiAke2NpcGhlcnRleHQubGVuZ3RofSBleGNlZWRzIG1heGltdW0gTm9pc2UgbWVzc2FnZSBsZW5ndGggb2YgNjU1MzVgKQoKICAgIGNvbnN0IHBsYWludGV4dCA9IGRlY3J5cHRXaXRoQUQodGhpcy5rZXksIHRoaXMubm9uY2UsIGFkLCBjaXBoZXJ0ZXh0KQogICAgdGhpcy5ub25jZSsrCgogICAgcmV0dXJuIHBsYWludGV4dAogIH0KCiAgZ2V0IGhhc0tleSAoKSB7CiAgICByZXR1cm4gdGhpcy5rZXkgIT09IG51bGwKICB9CgogIF9jbGVhciAoKSB7CiAgICBzb2RpdW0uc29kaXVtX21lbXplcm8odGhpcy5rZXkpCiAgICB0aGlzLmtleSA9IG51bGwKICAgIHRoaXMubm9uY2UgPSBudWxsCiAgfQoKICBzdGF0aWMgZ2V0IE1BQ0JZVEVTICgpIHsKICAgIHJldHVybiAxNgogIH0KCiAgc3RhdGljIGdldCBOT05DRUJZVEVTICgpIHsKICAgIHJldHVybiA4CiAgfQoKICBzdGF0aWMgZ2V0IEtFWUJZVEVTICgpIHsKICAgIHJldHVybiAzMgogIH0KfQoKZnVuY3Rpb24gZW5jcnlwdFdpdGhBRCAoa2V5LCBjb3VudGVyLCBhZGRpdGlvbmFsRGF0YSwgcGxhaW50ZXh0KSB7CiAgLy8gZm9yIG91ciBwdXJwb3NlcywgYWRkaXRpb25hbERhdGEgd2lsbCBhbHdheXMgYmUgYSBwdWJrZXkgc28gd2UgZW5jb2RlIGZyb20gaGV4CiAgaWYgKCFiNGEuaXNCdWZmZXIoYWRkaXRpb25hbERhdGEpKSBhZGRpdGlvbmFsRGF0YSA9IGI0YS5mcm9tKGFkZGl0aW9uYWxEYXRhLCAnaGV4JykKICBpZiAoIWI0YS5pc0J1ZmZlcihwbGFpbnRleHQpKSBwbGFpbnRleHQgPSBiNGEuZnJvbShwbGFpbnRleHQsICdoZXgnKQoKICBjb25zdCBub25jZSA9IGI0YS5hbGxvYyhzb2RpdW0uY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX05QVUJCWVRFUykKICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KG5vbmNlLmJ1ZmZlciwgbm9uY2UuYnl0ZU9mZnNldCwgbm9uY2UuYnl0ZUxlbmd0aCkKICB2aWV3LnNldFVpbnQzMig0LCBjb3VudGVyLCB0cnVlKQoKICBjb25zdCBjaXBoZXJ0ZXh0ID0gYjRhLmFsbG9jKHBsYWludGV4dC5ieXRlTGVuZ3RoICsgc29kaXVtLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMpCgogIHNvZGl1bS5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfZW5jcnlwdChjaXBoZXJ0ZXh0LCBwbGFpbnRleHQsIGFkZGl0aW9uYWxEYXRhLCBudWxsLCBub25jZSwga2V5KQogIHJldHVybiBjaXBoZXJ0ZXh0Cn0KCmZ1bmN0aW9uIGRlY3J5cHRXaXRoQUQgKGtleSwgY291bnRlciwgYWRkaXRpb25hbERhdGEsIGNpcGhlcnRleHQpIHsKICAvLyBmb3Igb3VyIHB1cnBvc2VzLCBhZGRpdGlvbmFsRGF0YSB3aWxsIGFsd2F5cyBiZSBhIHB1YmtleSBzbyB3ZSBlbmNvZGUgZnJvbSBoZXgKICBpZiAoIWI0YS5pc0J1ZmZlcihhZGRpdGlvbmFsRGF0YSkpIGFkZGl0aW9uYWxEYXRhID0gYjRhLmZyb20oYWRkaXRpb25hbERhdGEsICdoZXgnKQogIGlmICghYjRhLmlzQnVmZmVyKGNpcGhlcnRleHQpKSBjaXBoZXJ0ZXh0ID0gYjRhLmZyb20oY2lwaGVydGV4dCwgJ2hleCcpCgogIGNvbnN0IG5vbmNlID0gYjRhLmFsbG9jKHNvZGl1bS5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfTlBVQkJZVEVTKQogIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcobm9uY2UuYnVmZmVyLCBub25jZS5ieXRlT2Zmc2V0LCBub25jZS5ieXRlTGVuZ3RoKQogIHZpZXcuc2V0VWludDMyKDQsIGNvdW50ZXIsIHRydWUpCgogIGNvbnN0IHBsYWludGV4dCA9IGI0YS5hbGxvYyhjaXBoZXJ0ZXh0LmJ5dGVMZW5ndGggLSBzb2RpdW0uY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUykKCiAgc29kaXVtLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9kZWNyeXB0KHBsYWludGV4dCwgbnVsbCwgY2lwaGVydGV4dCwgYWRkaXRpb25hbERhdGEsIG5vbmNlLCBrZXkpCiAgcmV0dXJuIHBsYWludGV4dAp9Ci8qIGVzbGludC1kaXNhYmxlIGNhbWVsY2FzZSAqLwpjb25zdCB7CiAgY3J5cHRvX2t4X1NFRURCWVRFUywKICBjcnlwdG9fa3hfa2V5cGFpciwKICBjcnlwdG9fa3hfc2VlZF9rZXlwYWlyLAogIGNyeXB0b19zY2FsYXJtdWx0X0JZVEVTLAogIGNyeXB0b19zY2FsYXJtdWx0X1NDQUxBUkJZVEVTLAogIGNyeXB0b19zY2FsYXJtdWx0LAogIGNyeXB0b19zY2FsYXJtdWx0X2Jhc2UKfSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQoKY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnbmFub2Fzc2VydCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBESExFTiA9IGNyeXB0b19zY2FsYXJtdWx0X0JZVEVTCmNvbnN0IFBLTEVOID0gY3J5cHRvX3NjYWxhcm11bHRfQllURVMKY29uc3QgU0tMRU4gPSBjcnlwdG9fc2NhbGFybXVsdF9TQ0FMQVJCWVRFUwpjb25zdCBTRUVETEVOID0gY3J5cHRvX2t4X1NFRURCWVRFUwpjb25zdCBBTEcgPSAnMjU1MTknCgptb2R1bGUuZXhwb3J0cyA9IHsKICBESExFTiwKICBQS0xFTiwKICBTS0xFTiwKICBTRUVETEVOLAogIEFMRywKICBnZW5lcmF0ZUtleVBhaXIsCiAgZ2VuZXJhdGVTZWVkS2V5UGFpciwKICBkaAp9CgpmdW5jdGlvbiBnZW5lcmF0ZUtleVBhaXIgKHByaXZLZXkpIHsKICBjb25zdCBrZXlQYWlyID0ge30KCiAga2V5UGFpci5zZWNyZXRLZXkgPSBwcml2S2V5IHx8IGI0YS5hbGxvYyhTS0xFTikKICBrZXlQYWlyLnB1YmxpY0tleSA9IGI0YS5hbGxvYyhQS0xFTikKCiAgaWYgKHByaXZLZXkpIHsKICAgIGNyeXB0b19zY2FsYXJtdWx0X2Jhc2Uoa2V5UGFpci5wdWJsaWNLZXksIGtleVBhaXIuc2VjcmV0S2V5KQogIH0gZWxzZSB7CiAgICBjcnlwdG9fa3hfa2V5cGFpcihrZXlQYWlyLnB1YmxpY0tleSwga2V5UGFpci5zZWNyZXRLZXkpCiAgfQoKICByZXR1cm4ga2V5UGFpcgp9CgpmdW5jdGlvbiBnZW5lcmF0ZVNlZWRLZXlQYWlyIChzZWVkKSB7CiAgYXNzZXJ0KHNlZWQuYnl0ZUxlbmd0aCA9PT0gU0tMRU4pCgogIGNvbnN0IGtleVBhaXIgPSB7fQogIGtleVBhaXIuc2VjcmV0S2V5ID0gYjRhLmFsbG9jKFNLTEVOKQogIGtleVBhaXIucHVibGljS2V5ID0gYjRhLmFsbG9jKFBLTEVOKQoKICBjcnlwdG9fa3hfc2VlZF9rZXlwYWlyKGtleVBhaXIucHVibGljS2V5LCBrZXlQYWlyLnNlY3JldEtleSwgc2VlZCkKICByZXR1cm4ga2V5UGFpcgp9CgpmdW5jdGlvbiBkaCAocHVibGljS2V5LCB7IHNlY3JldEtleSB9KSB7CiAgYXNzZXJ0KHNlY3JldEtleS5ieXRlTGVuZ3RoID09PSBTS0xFTikKICBhc3NlcnQocHVibGljS2V5LmJ5dGVMZW5ndGggPT09IFBLTEVOKQoKICBjb25zdCBvdXRwdXQgPSBiNGEuYWxsb2MoREhMRU4pCgogIGNyeXB0b19zY2FsYXJtdWx0KAogICAgb3V0cHV0LAogICAgc2VjcmV0S2V5LAogICAgcHVibGljS2V5CiAgKQoKICByZXR1cm4gb3V0cHV0Cn0KY29uc3QgaG1hY0JsYWtlMmIgPSByZXF1aXJlKCcuL2htYWMnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgSEFTSExFTiA9IDY0Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBoa2RmLAogIEhBU0hMRU4KfQoKLy8gSE1BQy1iYXNlZCBFeHRyYWN0LWFuZC1FeHBhbmQgS0RGCi8vIGh0dHBzOi8vd3d3LmlldGYub3JnL3JmYy9yZmM1ODY5LnR4dAoKZnVuY3Rpb24gaGtkZiAoc2FsdCwgaW5wdXRLZXlNYXRlcmlhbCwgaW5mbyA9ICcnLCBsZW5ndGggPSAyICogSEFTSExFTikgewogIGNvbnN0IHBzZXVkb1JhbmRvbUtleSA9IGhrZGZFeHRyYWN0KHNhbHQsIGlucHV0S2V5TWF0ZXJpYWwpCiAgcmV0dXJuIGhrZGZFeHBhbmQocHNldWRvUmFuZG9tS2V5LCBpbmZvLCBsZW5ndGgpCn0KCmZ1bmN0aW9uIGhrZGZFeHRyYWN0IChzYWx0LCBpbnB1dEtleU1hdGVyaWFsKSB7CiAgY29uc3QgaG1hYyA9IGI0YS5hbGxvYyhIQVNITEVOKQogIHJldHVybiBobWFjRGlnZXN0KGhtYWMsIHNhbHQsIGlucHV0S2V5TWF0ZXJpYWwpCn0KCmZ1bmN0aW9uIGhrZGZFeHBhbmQgKGtleSwgaW5mbywgbGVuZ3RoKSB7CiAgLy8gUHV0IGluIGRlZGljYXRlZCBzbGFiIHRvIGF2b2lkIGtlZXBpbmcgc2hhcmVkIHNsYWIgZnJvbSBiZWluZyBnYydlZAogIGNvbnN0IGJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZVNsb3cobGVuZ3RoKQoKICBjb25zdCBpbmZvQnVmID0gYjRhLmZyb20oaW5mbykKICBsZXQgcHJldiA9IGluZm9CdWYKCiAgY29uc3QgcmVzdWx0ID0gW10KICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSBIQVNITEVOKSB7CiAgICBjb25zdCBwb3MgPSBiNGEuZnJvbShbKGkgLyBIQVNITEVOKSArIDFdKQoKICAgIGNvbnN0IG91dCA9IGJ1ZmZlci5zdWJhcnJheShpLCBpICsgSEFTSExFTikKICAgIHJlc3VsdC5wdXNoKG91dCkKCiAgICBwcmV2ID0gaG1hY0RpZ2VzdChvdXQsIGtleSwgW3ByZXYsIGluZm9CdWYsIHBvc10pCiAgfQoKICByZXR1cm4gcmVzdWx0Cn0KCmZ1bmN0aW9uIGhtYWNEaWdlc3QgKG91dCwga2V5LCBpbnB1dCkgewogIGhtYWNCbGFrZTJiKG91dCwgaW5wdXQsIGtleSkKICByZXR1cm4gb3V0Cn0KLyogZXNsaW50LWRpc2FibGUgY2FtZWxjYXNlICovCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHsgc29kaXVtX21lbXplcm8sIGNyeXB0b19nZW5lcmljaGFzaCwgY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoIH0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKCmNvbnN0IEhBU0hMRU4gPSA2NApjb25zdCBCTE9DS0xFTiA9IDEyOApjb25zdCBzY3JhdGNoID0gYjRhLmFsbG9jKEJMT0NLTEVOICogMykKY29uc3QgSE1BQ0tleSA9IHNjcmF0Y2guc3ViYXJyYXkoQkxPQ0tMRU4gKiAwLCBCTE9DS0xFTiAqIDEpCmNvbnN0IE91dGVyS2V5UGFkID0gc2NyYXRjaC5zdWJhcnJheShCTE9DS0xFTiAqIDEsIEJMT0NLTEVOICogMikKY29uc3QgSW5uZXJLZXlQYWQgPSBzY3JhdGNoLnN1YmFycmF5KEJMT0NLTEVOICogMiwgQkxPQ0tMRU4gKiAzKQoKLy8gUG9zdC1maWxsIGlzIGRvbmUgaW4gdGhlIGNhc2VzIHdoZXJlIHNvbWVvbmUgY2F1Z2h0IGFuIGV4Y2VwdGlvbiB0aGF0Ci8vIGhhcHBlbmVkIGJlZm9yZSB3ZSB3ZXJlIGFibGUgdG8gY2xlYXIgZGF0YSBhdCB0aGUgZW5kCgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGhtYWMgKG91dCwgYmF0Y2gsIGtleSkgewogIGlmIChrZXkuYnl0ZUxlbmd0aCA+IEJMT0NLTEVOKSB7CiAgICBjcnlwdG9fZ2VuZXJpY2hhc2goSE1BQ0tleS5zdWJhcnJheSgwLCBIQVNITEVOKSwga2V5KQogICAgc29kaXVtX21lbXplcm8oSE1BQ0tleS5zdWJhcnJheShIQVNITEVOKSkKICB9IGVsc2UgewogICAgLy8gQ292ZXJzIGtleSA8PSBCTE9DS0xFTgogICAgSE1BQ0tleS5zZXQoa2V5KQogICAgc29kaXVtX21lbXplcm8oSE1BQ0tleS5zdWJhcnJheShrZXkuYnl0ZUxlbmd0aCkpCiAgfQoKICBmb3IgKGxldCBpID0gMDsgaSA8IEhNQUNLZXkuYnl0ZUxlbmd0aDsgaSsrKSB7CiAgICBPdXRlcktleVBhZFtpXSA9IDB4NWMgXiBITUFDS2V5W2ldCiAgICBJbm5lcktleVBhZFtpXSA9IDB4MzYgXiBITUFDS2V5W2ldCiAgfQogIHNvZGl1bV9tZW16ZXJvKEhNQUNLZXkpCgogIGNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChvdXQsIFtJbm5lcktleVBhZF0uY29uY2F0KGJhdGNoKSkKICBzb2RpdW1fbWVtemVybyhJbm5lcktleVBhZCkKICBjcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2gob3V0LCBbT3V0ZXJLZXlQYWQsIG91dF0pCiAgc29kaXVtX21lbXplcm8oT3V0ZXJLZXlQYWQpCn0KCm1vZHVsZS5leHBvcnRzLkJZVEVTID0gSEFTSExFTgptb2R1bGUuZXhwb3J0cy5LRVlCWVRFUyA9IEJMT0NLTEVOCmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ25hbm9hc3NlcnQnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgU3ltbWV0cmljU3RhdGUgPSByZXF1aXJlKCcuL3N5bW1ldHJpYy1zdGF0ZScpCmNvbnN0IHsgSEFTSExFTiB9ID0gcmVxdWlyZSgnLi9oa2RmJykKCmNvbnN0IFBSRVNIQVJFX0lTID0gU3ltYm9sKCdpbml0aWF0b3Igc3RhdGljIGtleSBwcmVzaGFyZWQnKQpjb25zdCBQUkVTSEFSRV9SUyA9IFN5bWJvbCgncmVzcG9uZGVyIHN0YXRpYyBrZXkgcHJlc2hhcmVkJykKCmNvbnN0IFRPS19QU0sgPSBTeW1ib2woJ3BzaycpCgpjb25zdCBUT0tfUyA9IFN5bWJvbCgncycpCmNvbnN0IFRPS19FID0gU3ltYm9sKCdlJykKCmNvbnN0IFRPS19FUyA9IFN5bWJvbCgnZXMnKQpjb25zdCBUT0tfU0UgPSBTeW1ib2woJ3NlJykKY29uc3QgVE9LX0VFID0gU3ltYm9sKCdlZScpCmNvbnN0IFRPS19TUyA9IFN5bWJvbCgnc3MnKQoKY29uc3QgSEFORFNIQUtFUyA9IE9iamVjdC5mcmVlemUoewogIE5OOiBbCiAgICBbVE9LX0VdLAogICAgW1RPS19FLCBUT0tfRUVdCiAgXSwKICBOTnBzazA6IFsKICAgIFtUT0tfUFNLLCBUT0tfRV0sCiAgICBbVE9LX0UsIFRPS19FRV0KICBdLAogIFhYOiBbCiAgICBbVE9LX0VdLAogICAgW1RPS19FLCBUT0tfRUUsIFRPS19TLCBUT0tfRVNdLAogICAgW1RPS19TLCBUT0tfU0VdCiAgXSwKICBYWHBzazA6IFsKICAgIFtUT0tfUFNLLCBUT0tfRV0sCiAgICBbVE9LX0UsIFRPS19FRSwgVE9LX1MsIFRPS19FU10sCiAgICBbVE9LX1MsIFRPS19TRV0KICBdLAogIElLOiBbCiAgICBQUkVTSEFSRV9SUywKICAgIFtUT0tfRSwgVE9LX0VTLCBUT0tfUywgVE9LX1NTXSwKICAgIFtUT0tfRSwgVE9LX0VFLCBUT0tfU0VdCiAgXSwKICBYSzogWwogICAgUFJFU0hBUkVfUlMsCiAgICBbVE9LX0UsIFRPS19FU10sCiAgICBbVE9LX0UsIFRPS19FRV0sCiAgICBbVE9LX1MsIFRPS19TRV0KICBdCn0pCgpjbGFzcyBXcml0ZXIgewogIGNvbnN0cnVjdG9yICgpIHsKICAgIHRoaXMuc2l6ZSA9IDAKICAgIHRoaXMuYnVmZmVycyA9IFtdCiAgfQoKICBwdXNoIChiKSB7CiAgICB0aGlzLnNpemUgKz0gYi5ieXRlTGVuZ3RoCiAgICB0aGlzLmJ1ZmZlcnMucHVzaChiKQogIH0KCiAgZW5kICgpIHsKICAgIGNvbnN0IGFsbCA9IGI0YS5hbGxvYyh0aGlzLnNpemUpCiAgICBsZXQgb2Zmc2V0ID0gMAogICAgZm9yIChjb25zdCBiIG9mIHRoaXMuYnVmZmVycykgewogICAgICBhbGwuc2V0KGIsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IGIuYnl0ZUxlbmd0aAogICAgfQogICAgcmV0dXJuIGFsbAogIH0KfQoKY2xhc3MgUmVhZGVyIHsKICBjb25zdHJ1Y3RvciAoYnVmKSB7CiAgICB0aGlzLm9mZnNldCA9IDAKICAgIHRoaXMuYnVmZmVyID0gYnVmCiAgfQoKICBzaGlmdCAobikgewogICAgY29uc3Qgc3RhcnQgPSB0aGlzLm9mZnNldAogICAgY29uc3QgZW5kID0gdGhpcy5vZmZzZXQgKz0gbgogICAgaWYgKGVuZCA+IHRoaXMuYnVmZmVyLmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcignSW5zdWZmaWNpZW50IGJ5dGVzJykKICAgIHJldHVybiB0aGlzLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgZW5kKQogIH0KCiAgZW5kICgpIHsKICAgIHJldHVybiB0aGlzLnNoaWZ0KHRoaXMuYnVmZmVyLmJ5dGVMZW5ndGggLSB0aGlzLm9mZnNldCkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgTm9pc2VTdGF0ZSBleHRlbmRzIFN5bW1ldHJpY1N0YXRlIHsKICBjb25zdHJ1Y3RvciAocGF0dGVybiwgaW5pdGlhdG9yLCBzdGF0aWNLZXlwYWlyLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKG9wdHMpCgogICAgdGhpcy5zID0gc3RhdGljS2V5cGFpciB8fCB0aGlzLmN1cnZlLmdlbmVyYXRlS2V5UGFpcigpCiAgICB0aGlzLmUgPSBudWxsCgogICAgdGhpcy5wc2sgPSBudWxsCiAgICBpZiAob3B0cyAmJiBvcHRzLnBzaykgdGhpcy5wc2sgPSBvcHRzLnBzawoKICAgIHRoaXMucmUgPSBudWxsCiAgICB0aGlzLnJzID0gbnVsbAoKICAgIHRoaXMucGF0dGVybiA9IHBhdHRlcm4KICAgIHRoaXMuaGFuZHNoYWtlID0gSEFORFNIQUtFU1t0aGlzLnBhdHRlcm5dLnNsaWNlKCkKCiAgICB0aGlzLmlzUHNrSGFuZHNoYWtlID0gISF0aGlzLnBzayAmJiBoYXNQc2tUb2tlbih0aGlzLmhhbmRzaGFrZSkKCiAgICB0aGlzLnByb3RvY29sID0gYjRhLmZyb20oWwogICAgICAnTm9pc2UnLAogICAgICB0aGlzLnBhdHRlcm4sCiAgICAgIHRoaXMuREhfQUxHLAogICAgICB0aGlzLkNJUEhFUl9BTEcsCiAgICAgICdCTEFLRTJiJwogICAgXS5qb2luKCdfJykpCgogICAgdGhpcy5pbml0aWF0b3IgPSBpbml0aWF0b3IKICAgIHRoaXMuY29tcGxldGUgPSBmYWxzZQoKICAgIHRoaXMucnggPSBudWxsCiAgICB0aGlzLnR4ID0gbnVsbAogICAgdGhpcy5oYXNoID0gbnVsbAogIH0KCiAgaW5pdGlhbGlzZSAocHJvbG9ndWUsIHJlbW90ZVN0YXRpYykgewogICAgaWYgKHRoaXMucHJvdG9jb2wuYnl0ZUxlbmd0aCA8PSBIQVNITEVOKSB0aGlzLmRpZ2VzdC5zZXQodGhpcy5wcm90b2NvbCkKICAgIGVsc2UgdGhpcy5taXhIYXNoKHRoaXMucHJvdG9jb2wpCgogICAgdGhpcy5jaGFpbmluZ0tleSA9IGI0YS5mcm9tKHRoaXMuZGlnZXN0KQoKICAgIHRoaXMubWl4SGFzaChwcm9sb2d1ZSkKCiAgICB3aGlsZSAoIUFycmF5LmlzQXJyYXkodGhpcy5oYW5kc2hha2VbMF0pKSB7CiAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLmhhbmRzaGFrZS5zaGlmdCgpCgogICAgICAvLyBoYW5kc2hha2Ugc3RlcHMgc2hvdWxkIGJlIGFzIGFycmF5cywgb25seQogICAgICAvLyBwcmVzaGFyZSB0b2tlbnMgYXJlIHByb3ZpZGVkIG90aGVyd2lzZQogICAgICBhc3NlcnQobWVzc2FnZSA9PT0gUFJFU0hBUkVfUlMgfHwgbWVzc2FnZSA9PT0gUFJFU0hBUkVfSVMsCiAgICAgICAgJ1VuZXhwZWN0ZWQgcGF0dGVybicpCgogICAgICBjb25zdCB0YWtlUmVtb3RlS2V5ID0gdGhpcy5pbml0aWF0b3IKICAgICAgICA/IG1lc3NhZ2UgPT09IFBSRVNIQVJFX1JTCiAgICAgICAgOiBtZXNzYWdlID09PSBQUkVTSEFSRV9JUwoKICAgICAgaWYgKHRha2VSZW1vdGVLZXkpIHRoaXMucnMgPSByZW1vdGVTdGF0aWMKCiAgICAgIGNvbnN0IGtleSA9IHRha2VSZW1vdGVLZXkgPyB0aGlzLnJzIDogdGhpcy5zLnB1YmxpY0tleQogICAgICBhc3NlcnQoa2V5ICE9IG51bGwsICdSZW1vdGUgcHVia2V5IHJlcXVpcmVkJykKCiAgICAgIHRoaXMubWl4SGFzaChrZXkpCiAgICB9CiAgfQoKICBmaW5hbCAoKSB7CiAgICBjb25zdCBbazEsIGsyXSA9IHRoaXMuc3BsaXQoKQoKICAgIHRoaXMudHggPSB0aGlzLmluaXRpYXRvciA/IGsxIDogazIKICAgIHRoaXMucnggPSB0aGlzLmluaXRpYXRvciA/IGsyIDogazEKCiAgICB0aGlzLmNvbXBsZXRlID0gdHJ1ZQogICAgdGhpcy5oYXNoID0gdGhpcy5nZXRIYW5kc2hha2VIYXNoKCkKCiAgICB0aGlzLl9jbGVhcigpCiAgfQoKICByZWN2IChidWYpIHsKICAgIGNvbnN0IHIgPSBuZXcgUmVhZGVyKGJ1ZikKCiAgICBmb3IgKGNvbnN0IHBhdHRlcm4gb2YgdGhpcy5oYW5kc2hha2Uuc2hpZnQoKSkgewogICAgICBzd2l0Y2ggKHBhdHRlcm4pIHsKICAgICAgICBjYXNlIFRPS19QU0sgOgogICAgICAgICAgdGhpcy5taXhLZXlBbmRIYXNoKHRoaXMucHNrKQogICAgICAgICAgYnJlYWsKCiAgICAgICAgY2FzZSBUT0tfRSA6CiAgICAgICAgICB0aGlzLnJlID0gci5zaGlmdCh0aGlzLmN1cnZlLlBLTEVOKQogICAgICAgICAgdGhpcy5taXhIYXNoKHRoaXMucmUpCiAgICAgICAgICBpZiAodGhpcy5pc1Bza0hhbmRzaGFrZSkgdGhpcy5taXhLZXlOb3JtYWwodGhpcy5yZSkKICAgICAgICAgIGJyZWFrCgogICAgICAgIGNhc2UgVE9LX1MgOiB7CiAgICAgICAgICBjb25zdCBrbGVuID0gdGhpcy5oYXNLZXkgPyB0aGlzLmN1cnZlLlBLTEVOICsgMTYgOiB0aGlzLmN1cnZlLlBLTEVOCiAgICAgICAgICB0aGlzLnJzID0gdGhpcy5kZWNyeXB0QW5kSGFzaChyLnNoaWZ0KGtsZW4pKQogICAgICAgICAgYnJlYWsKICAgICAgICB9CgogICAgICAgIGNhc2UgVE9LX0VFIDoKICAgICAgICBjYXNlIFRPS19FUyA6CiAgICAgICAgY2FzZSBUT0tfU0UgOgogICAgICAgIGNhc2UgVE9LX1NTIDogewogICAgICAgICAgY29uc3QgdXNlU3RhdGljID0ga2V5UGF0dGVybihwYXR0ZXJuLCB0aGlzLmluaXRpYXRvcikKCiAgICAgICAgICBjb25zdCBsb2NhbEtleSA9IHVzZVN0YXRpYy5sb2NhbCA/IHRoaXMucyA6IHRoaXMuZQogICAgICAgICAgY29uc3QgcmVtb3RlS2V5ID0gdXNlU3RhdGljLnJlbW90ZSA/IHRoaXMucnMgOiB0aGlzLnJlCgogICAgICAgICAgdGhpcy5taXhLZXkocmVtb3RlS2V5LCBsb2NhbEtleSkKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQoKICAgICAgICBkZWZhdWx0IDoKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3RlZCBtZXNzYWdlJykKICAgICAgfQogICAgfQoKICAgIGNvbnN0IHBheWxvYWQgPSB0aGlzLmRlY3J5cHRBbmRIYXNoKHIuZW5kKCkpCgogICAgaWYgKCF0aGlzLmhhbmRzaGFrZS5sZW5ndGgpIHRoaXMuZmluYWwoKQogICAgcmV0dXJuIHBheWxvYWQKICB9CgogIHNlbmQgKHBheWxvYWQgPSBiNGEuYWxsb2MoMCkpIHsKICAgIGNvbnN0IHcgPSBuZXcgV3JpdGVyKCkKCiAgICBmb3IgKGNvbnN0IHBhdHRlcm4gb2YgdGhpcy5oYW5kc2hha2Uuc2hpZnQoKSkgewogICAgICBzd2l0Y2ggKHBhdHRlcm4pIHsKICAgICAgICBjYXNlIFRPS19QU0sgOgogICAgICAgICAgdGhpcy5taXhLZXlBbmRIYXNoKHRoaXMucHNrKQogICAgICAgICAgYnJlYWsKCiAgICAgICAgY2FzZSBUT0tfRSA6CiAgICAgICAgICBpZiAodGhpcy5lID09PSBudWxsKSB0aGlzLmUgPSB0aGlzLmN1cnZlLmdlbmVyYXRlS2V5UGFpcigpCiAgICAgICAgICB0aGlzLm1peEhhc2godGhpcy5lLnB1YmxpY0tleSkKICAgICAgICAgIGlmICh0aGlzLmlzUHNrSGFuZHNoYWtlKSB0aGlzLm1peEtleU5vcm1hbCh0aGlzLmUucHVibGljS2V5KQogICAgICAgICAgdy5wdXNoKHRoaXMuZS5wdWJsaWNLZXkpCiAgICAgICAgICBicmVhawoKICAgICAgICBjYXNlIFRPS19TIDoKICAgICAgICAgIHcucHVzaCh0aGlzLmVuY3J5cHRBbmRIYXNoKHRoaXMucy5wdWJsaWNLZXkpKQogICAgICAgICAgYnJlYWsKCiAgICAgICAgY2FzZSBUT0tfRVMgOgogICAgICAgIGNhc2UgVE9LX1NFIDoKICAgICAgICBjYXNlIFRPS19FRSA6CiAgICAgICAgY2FzZSBUT0tfU1MgOiB7CiAgICAgICAgICBjb25zdCB1c2VTdGF0aWMgPSBrZXlQYXR0ZXJuKHBhdHRlcm4sIHRoaXMuaW5pdGlhdG9yKQoKICAgICAgICAgIGNvbnN0IGxvY2FsS2V5ID0gdXNlU3RhdGljLmxvY2FsID8gdGhpcy5zIDogdGhpcy5lCiAgICAgICAgICBjb25zdCByZW1vdGVLZXkgPSB1c2VTdGF0aWMucmVtb3RlID8gdGhpcy5ycyA6IHRoaXMucmUKCiAgICAgICAgICB0aGlzLm1peEtleShyZW1vdGVLZXksIGxvY2FsS2V5KQogICAgICAgICAgYnJlYWsKICAgICAgICB9CgogICAgICAgIGRlZmF1bHQgOgogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmV4cGVjdGVkIG1lc3NhZ2UnKQogICAgICB9CiAgICB9CgogICAgdy5wdXNoKHRoaXMuZW5jcnlwdEFuZEhhc2gocGF5bG9hZCkpCiAgICBjb25zdCByZXNwb25zZSA9IHcuZW5kKCkKCiAgICBpZiAoIXRoaXMuaGFuZHNoYWtlLmxlbmd0aCkgdGhpcy5maW5hbCgpCiAgICByZXR1cm4gcmVzcG9uc2UKICB9CgogIF9jbGVhciAoKSB7CiAgICBzdXBlci5fY2xlYXIoKQoKICAgIHRoaXMuZS5zZWNyZXRLZXkuZmlsbCgwKQogICAgdGhpcy5lLnB1YmxpY0tleS5maWxsKDApCgogICAgdGhpcy5yZS5maWxsKDApCgogICAgdGhpcy5lID0gbnVsbAogICAgdGhpcy5yZSA9IG51bGwKICB9Cn0KCmZ1bmN0aW9uIGtleVBhdHRlcm4gKHBhdHRlcm4sIGluaXRpYXRvcikgewogIGNvbnN0IHJldCA9IHsKICAgIGxvY2FsOiBmYWxzZSwKICAgIHJlbW90ZTogZmFsc2UKICB9CgogIHN3aXRjaCAocGF0dGVybikgewogICAgY2FzZSBUT0tfRUU6CiAgICAgIHJldHVybiByZXQKCiAgICBjYXNlIFRPS19FUzoKICAgICAgcmV0LmxvY2FsIF49ICFpbml0aWF0b3IKICAgICAgcmV0LnJlbW90ZSBePSBpbml0aWF0b3IKICAgICAgcmV0dXJuIHJldAoKICAgIGNhc2UgVE9LX1NFOgogICAgICByZXQubG9jYWwgXj0gaW5pdGlhdG9yCiAgICAgIHJldC5yZW1vdGUgXj0gIWluaXRpYXRvcgogICAgICByZXR1cm4gcmV0CgogICAgY2FzZSBUT0tfU1M6CiAgICAgIHJldC5sb2NhbCBePSAxCiAgICAgIHJldC5yZW1vdGUgXj0gMQogICAgICByZXR1cm4gcmV0CiAgfQp9CgpmdW5jdGlvbiBoYXNQc2tUb2tlbiAoaGFuZHNoYWtlKSB7CiAgcmV0dXJuIGhhbmRzaGFrZS5zb21lKHggPT4gewogICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoeCkgJiYgeC5pbmRleE9mKFRPS19QU0spICE9PSAtMQogIH0pCn0KewogICJuYW1lIjogIm5vaXNlLWhhbmRzaGFrZSIsCiAgInZlcnNpb24iOiAiNC4yLjAiLAogICJkZXNjcmlwdGlvbiI6ICJOb2lzZSBwcm90b2NvbCBoYW5kc2hha2UiLAogICJtYWluIjogIm5vaXNlLmpzIiwKICAiZmlsZXMiOiBbCiAgICAiKi5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LyouanMiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL25vaXNlLWhhbmRzaGFrZS5naXQiCiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS4xLjAiLAogICAgIm5hbm9hc3NlcnQiOiAiXjIuMC4wIiwKICAgICJzb2RpdW0tdW5pdmVyc2FsIjogIl41LjAuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4zLjIiLAogICAgIm5vaXNlLXByb3RvY29sIjogImNobS1kaWVkZXJpY2hzL25vaXNlLXByb3RvY29sLmdpdCN4eC1lcGhlbWVyYWwta2V5IiwKICAgICJzdGFuZGFyZCI6ICJeMTYuMC4zIgogIH0KfQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnbmFub2Fzc2VydCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IENpcGhlclN0YXRlID0gcmVxdWlyZSgnLi9jaXBoZXInKQpjb25zdCBjdXJ2ZSA9IHJlcXVpcmUoJy4vZGgnKQpjb25zdCB7IEhBU0hMRU4sIGhrZGYgfSA9IHJlcXVpcmUoJy4vaGtkZicpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFN5bW1ldHJpY1N0YXRlIGV4dGVuZHMgQ2lwaGVyU3RhdGUgewogIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmN1cnZlID0gb3B0cy5jdXJ2ZSB8fCBjdXJ2ZQogICAgdGhpcy5kaWdlc3QgPSBiNGEuYWxsb2MoSEFTSExFTikKICAgIHRoaXMuY2hhaW5pbmdLZXkgPSBudWxsCiAgICB0aGlzLm9mZnNldCA9IDAKCiAgICB0aGlzLkRIX0FMRyA9IHRoaXMuY3VydmUuQUxHCiAgfQoKICBtaXhIYXNoIChkYXRhKSB7CiAgICBhY2N1bXVsYXRlRGlnZXN0KHRoaXMuZGlnZXN0LCBkYXRhKQogIH0KCiAgbWl4S2V5QW5kSGFzaCAoa2V5KSB7CiAgICBjb25zdCBbY2ssIHRlbXBILCB0ZW1wS10gPSBoa2RmKHRoaXMuY2hhaW5pbmdLZXksIGtleSwgJycsIDMgKiBIQVNITEVOKQogICAgdGhpcy5jaGFpbmluZ0tleSA9IGNrCiAgICB0aGlzLm1peEhhc2godGVtcEgpCiAgICB0aGlzLmluaXRpYWxpc2VLZXkodGVtcEsuc3ViYXJyYXkoMCwgMzIpKQogIH0KCiAgbWl4S2V5Tm9ybWFsIChrZXkpIHsKICAgIGNvbnN0IFtjaywgdGVtcEtdID0gaGtkZih0aGlzLmNoYWluaW5nS2V5LCBrZXkpCiAgICB0aGlzLmNoYWluaW5nS2V5ID0gY2sKICAgIHRoaXMuaW5pdGlhbGlzZUtleSh0ZW1wSy5zdWJhcnJheSgwLCAzMikpCiAgfQoKICBtaXhLZXkgKHJlbW90ZUtleSwgbG9jYWxLZXkpIHsKICAgIGNvbnN0IGRoID0gdGhpcy5jdXJ2ZS5kaChyZW1vdGVLZXksIGxvY2FsS2V5KQogICAgY29uc3QgaGtkZlJlc3VsdCA9IGhrZGYodGhpcy5jaGFpbmluZ0tleSwgZGgpCiAgICB0aGlzLmNoYWluaW5nS2V5ID0gaGtkZlJlc3VsdFswXQogICAgdGhpcy5pbml0aWFsaXNlS2V5KGhrZGZSZXN1bHRbMV0uc3ViYXJyYXkoMCwgMzIpKQogIH0KCiAgZW5jcnlwdEFuZEhhc2ggKHBsYWludGV4dCkgewogICAgY29uc3QgY2lwaGVydGV4dCA9IHRoaXMuZW5jcnlwdChwbGFpbnRleHQsIHRoaXMuZGlnZXN0KQogICAgYWNjdW11bGF0ZURpZ2VzdCh0aGlzLmRpZ2VzdCwgY2lwaGVydGV4dCkKICAgIHJldHVybiBjaXBoZXJ0ZXh0CiAgfQoKICBkZWNyeXB0QW5kSGFzaCAoY2lwaGVydGV4dCkgewogICAgY29uc3QgcGxhaW50ZXh0ID0gdGhpcy5kZWNyeXB0KGNpcGhlcnRleHQsIHRoaXMuZGlnZXN0KQogICAgYWNjdW11bGF0ZURpZ2VzdCh0aGlzLmRpZ2VzdCwgY2lwaGVydGV4dCkKICAgIHJldHVybiBwbGFpbnRleHQKICB9CgogIGdldEhhbmRzaGFrZUhhc2ggKG91dCkgewogICAgaWYgKCFvdXQpIHJldHVybiB0aGlzLmdldEhhbmRzaGFrZUhhc2goYjRhLmFsbG9jKEhBU0hMRU4pKQogICAgYXNzZXJ0KG91dC5ieXRlTGVuZ3RoID09PSBIQVNITEVOLCBgb3V0cHV0IG11c3QgYmUgJHtIQVNITEVOfSBieXRlc2ApCgogICAgb3V0LnNldCh0aGlzLmRpZ2VzdCkKICAgIHJldHVybiBvdXQKICB9CgogIHNwbGl0ICgpIHsKICAgIGNvbnN0IHJlcyA9IGhrZGYodGhpcy5jaGFpbmluZ0tleSwgYjRhLmFsbG9jKDApKQogICAgcmV0dXJuIHJlcy5tYXAoayA9PiBrLnN1YmFycmF5KDAsIDMyKSkKICB9CgogIF9jbGVhciAoKSB7CiAgICBzdXBlci5fY2xlYXIoKQoKICAgIHNvZGl1bS5zb2RpdW1fbWVtemVybyh0aGlzLmRpZ2VzdCkKICAgIHNvZGl1bS5zb2RpdW1fbWVtemVybyh0aGlzLmNoYWluaW5nS2V5KQoKICAgIHRoaXMuZGlnZXN0ID0gbnVsbAogICAgdGhpcy5jaGFpbmluZ0tleSA9IG51bGwKICAgIHRoaXMub2Zmc2V0ID0gbnVsbAoKICAgIHRoaXMuY3VydmUgPSBudWxsCiAgfQoKICBzdGF0aWMgZ2V0IGFsZyAoKSB7CiAgICByZXR1cm4gQ2lwaGVyU3RhdGUuYWxnICsgJ19CTEFLRTJiJwogIH0KfQoKZnVuY3Rpb24gYWNjdW11bGF0ZURpZ2VzdCAoZGlnZXN0LCBpbnB1dCkgewogIGNvbnN0IHRvSGFzaCA9IGI0YS5jb25jYXQoW2RpZ2VzdCwgaW5wdXRdKQogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goZGlnZXN0LCB0b0hhc2gpCn0KdmFyIHZhcmludCA9IHJlcXVpcmUoJ3ZhcmludCcpCnZhciBzdmFyaW50ID0gcmVxdWlyZSgnc2lnbmVkLXZhcmludCcpCnZhciBiNGEgPSByZXF1aXJlKCdiNGEnKQoKZXhwb3J0cy5tYWtlID0gZW5jb2RlcgoKZXhwb3J0cy5uYW1lID0gZnVuY3Rpb24gKGVuYykgewogIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZXhwb3J0cykKICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgIGlmIChleHBvcnRzW2tleXNbaV1dID09PSBlbmMpIHJldHVybiBrZXlzW2ldCiAgfQogIHJldHVybiBudWxsCn0KCmV4cG9ydHMuc2tpcCA9IGZ1bmN0aW9uICh0eXBlLCBidWZmZXIsIG9mZnNldCkgewogIHN3aXRjaCAodHlwZSkgewogICAgY2FzZSAwOgogICAgICB2YXJpbnQuZGVjb2RlKGJ1ZmZlciwgb2Zmc2V0KQogICAgICByZXR1cm4gb2Zmc2V0ICsgdmFyaW50LmRlY29kZS5ieXRlcwoKICAgIGNhc2UgMToKICAgICAgcmV0dXJuIG9mZnNldCArIDgKCiAgICBjYXNlIDI6CiAgICAgIHZhciBsZW4gPSB2YXJpbnQuZGVjb2RlKGJ1ZmZlciwgb2Zmc2V0KQogICAgICByZXR1cm4gb2Zmc2V0ICsgdmFyaW50LmRlY29kZS5ieXRlcyArIGxlbgoKICAgIGNhc2UgMzoKICAgIGNhc2UgNDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCdHcm91cHMgYXJlIG5vdCBzdXBwb3J0ZWQnKQoKICAgIGNhc2UgNToKICAgICAgcmV0dXJuIG9mZnNldCArIDQKICB9CgogIHRocm93IG5ldyBFcnJvcignVW5rbm93biB3aXJlIHR5cGU6ICcgKyB0eXBlKQp9CgpleHBvcnRzLmJ5dGVzID0gZW5jb2RlcigyLAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgdmFyIGxlbiA9IGJ1ZmZlckxlbmd0aCh2YWwpCgogICAgdmFyaW50LmVuY29kZShsZW4sIGJ1ZmZlciwgb2Zmc2V0KQogICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKCiAgICBpZiAoYjRhLmlzQnVmZmVyKHZhbCkpIGI0YS5jb3B5KHZhbCwgYnVmZmVyLCBvZmZzZXQpCiAgICBlbHNlIGI0YS53cml0ZShidWZmZXIsIHZhbCwgb2Zmc2V0LCBsZW4pCiAgICBvZmZzZXQgKz0gbGVuCgogICAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICByZXR1cm4gYnVmZmVyCiAgfSwKICBmdW5jdGlvbiBkZWNvZGUgKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CgogICAgdmFyIGxlbiA9IHZhcmludC5kZWNvZGUoYnVmZmVyLCBvZmZzZXQpCiAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwoKICAgIHZhciB2YWwgPSBidWZmZXIuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyBsZW4pCiAgICBvZmZzZXQgKz0gdmFsLmxlbmd0aAoKICAgIGRlY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgcmV0dXJuIHZhbAogIH0sCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKHZhbCkgewogICAgdmFyIGxlbiA9IGJ1ZmZlckxlbmd0aCh2YWwpCiAgICByZXR1cm4gdmFyaW50LmVuY29kaW5nTGVuZ3RoKGxlbikgKyBsZW4KICB9CikKCmV4cG9ydHMuc3RyaW5nID0gZW5jb2RlcigyLAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgdmFyIGxlbiA9IGI0YS5ieXRlTGVuZ3RoKHZhbCkKCiAgICB2YXJpbnQuZW5jb2RlKGxlbiwgYnVmZmVyLCBvZmZzZXQsICd1dGYtOCcpCiAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcwoKICAgIGI0YS53cml0ZShidWZmZXIsIHZhbCwgb2Zmc2V0LCBsZW4pCiAgICBvZmZzZXQgKz0gbGVuCgogICAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICByZXR1cm4gYnVmZmVyCiAgfSwKICBmdW5jdGlvbiBkZWNvZGUgKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CgogICAgdmFyIGxlbiA9IHZhcmludC5kZWNvZGUoYnVmZmVyLCBvZmZzZXQpCiAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwoKICAgIHZhciB2YWwgPSBiNGEudG9TdHJpbmcoYnVmZmVyLCAndXRmLTgnLCBvZmZzZXQsIG9mZnNldCArIGxlbikKICAgIG9mZnNldCArPSBsZW4KCiAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgIHJldHVybiB2YWwKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICh2YWwpIHsKICAgIHZhciBsZW4gPSBiNGEuYnl0ZUxlbmd0aCh2YWwpCiAgICByZXR1cm4gdmFyaW50LmVuY29kaW5nTGVuZ3RoKGxlbikgKyBsZW4KICB9CikKCmV4cG9ydHMuYm9vbCA9IGVuY29kZXIoMCwKICBmdW5jdGlvbiBlbmNvZGUgKHZhbCwgYnVmZmVyLCBvZmZzZXQpIHsKICAgIGJ1ZmZlcltvZmZzZXRdID0gdmFsID8gMSA6IDAKICAgIGVuY29kZS5ieXRlcyA9IDEKICAgIHJldHVybiBidWZmZXIKICB9LAogIGZ1bmN0aW9uIGRlY29kZSAoYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciBib29sID0gYnVmZmVyW29mZnNldF0gPiAwCiAgICBkZWNvZGUuYnl0ZXMgPSAxCiAgICByZXR1cm4gYm9vbAogIH0sCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKCkgewogICAgcmV0dXJuIDEKICB9CikKCmV4cG9ydHMuaW50MzIgPSBlbmNvZGVyKDAsCiAgZnVuY3Rpb24gZW5jb2RlICh2YWwsIGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXJpbnQuZW5jb2RlKHZhbCA8IDAgPyB2YWwgKyA0Mjk0OTY3Mjk2IDogdmFsLCBidWZmZXIsIG9mZnNldCkKICAgIGVuY29kZS5ieXRlcyA9IHZhcmludC5lbmNvZGUuYnl0ZXMKICAgIHJldHVybiBidWZmZXIKICB9LAogIGZ1bmN0aW9uIGRlY29kZSAoYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciB2YWwgPSB2YXJpbnQuZGVjb2RlKGJ1ZmZlciwgb2Zmc2V0KQogICAgZGVjb2RlLmJ5dGVzID0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgcmV0dXJuIHZhbCA+IDIxNDc0ODM2NDcgPyB2YWwgLSA0Mjk0OTY3Mjk2IDogdmFsCiAgfSwKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAodmFsKSB7CiAgICByZXR1cm4gdmFyaW50LmVuY29kaW5nTGVuZ3RoKHZhbCA8IDAgPyB2YWwgKyA0Mjk0OTY3Mjk2IDogdmFsKQogIH0KKQoKZXhwb3J0cy5pbnQ2NCA9IGVuY29kZXIoMCwKICBmdW5jdGlvbiBlbmNvZGUgKHZhbCwgYnVmZmVyLCBvZmZzZXQpIHsKICAgIGlmICh2YWwgPCAwKSB7CiAgICAgIHZhciBsYXN0ID0gb2Zmc2V0ICsgOQogICAgICB2YXJpbnQuZW5jb2RlKHZhbCAqIC0xLCBidWZmZXIsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMgLSAxCiAgICAgIGJ1ZmZlcltvZmZzZXRdID0gYnVmZmVyW29mZnNldF0gfCAweDgwCiAgICAgIHdoaWxlIChvZmZzZXQgPCBsYXN0IC0gMSkgewogICAgICAgIG9mZnNldCsrCiAgICAgICAgYnVmZmVyW29mZnNldF0gPSAweGZmCiAgICAgIH0KICAgICAgYnVmZmVyW2xhc3RdID0gMHgwMQogICAgICBlbmNvZGUuYnl0ZXMgPSAxMAogICAgfSBlbHNlIHsKICAgICAgdmFyaW50LmVuY29kZSh2YWwsIGJ1ZmZlciwgb2Zmc2V0KQogICAgICBlbmNvZGUuYnl0ZXMgPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICB9CiAgICByZXR1cm4gYnVmZmVyCiAgfSwKICBmdW5jdGlvbiBkZWNvZGUgKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgdmFsID0gdmFyaW50LmRlY29kZShidWZmZXIsIG9mZnNldCkKICAgIGlmICh2YWwgPj0gTWF0aC5wb3coMiwgNjMpKSB7CiAgICAgIHZhciBsaW1pdCA9IDkKICAgICAgd2hpbGUgKGJ1ZmZlcltvZmZzZXQgKyBsaW1pdCAtIDFdID09PSAweGZmKSBsaW1pdC0tCiAgICAgIGxpbWl0ID0gbGltaXQgfHwgOQogICAgICB2YXIgc3Vic2V0ID0gYjRhLmFsbG9jVW5zYWZlKGxpbWl0KQogICAgICBiNGEuY29weShidWZmZXIsIHN1YnNldCwgMCwgb2Zmc2V0LCBvZmZzZXQgKyBsaW1pdCkKICAgICAgc3Vic2V0W2xpbWl0IC0gMV0gPSBzdWJzZXRbbGltaXQgLSAxXSAmIDB4N2YKICAgICAgdmFsID0gLTEgKiB2YXJpbnQuZGVjb2RlKHN1YnNldCwgMCkKICAgICAgZGVjb2RlLmJ5dGVzID0gMTAKICAgIH0gZWxzZSB7CiAgICAgIGRlY29kZS5ieXRlcyA9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgIH0KICAgIHJldHVybiB2YWwKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICh2YWwpIHsKICAgIHJldHVybiB2YWwgPCAwID8gMTAgOiB2YXJpbnQuZW5jb2RpbmdMZW5ndGgodmFsKQogIH0KKQoKZXhwb3J0cy5zaW50MzIgPQpleHBvcnRzLnNpbnQ2NCA9IGVuY29kZXIoMCwKICBzdmFyaW50LmVuY29kZSwKICBzdmFyaW50LmRlY29kZSwKICBzdmFyaW50LmVuY29kaW5nTGVuZ3RoCikKCmV4cG9ydHMudWludDMyID0KZXhwb3J0cy51aW50NjQgPQpleHBvcnRzLmVudW0gPQpleHBvcnRzLnZhcmludCA9IGVuY29kZXIoMCwKICB2YXJpbnQuZW5jb2RlLAogIHZhcmludC5kZWNvZGUsCiAgdmFyaW50LmVuY29kaW5nTGVuZ3RoCikKCi8vIHdlIGNhbm5vdCByZXByZXNlbnQgdGhlc2UgaW4gamF2YXNjcmlwdCBzbyB3ZSBqdXN0IHVzZSBidWZmZXJzCmV4cG9ydHMuZml4ZWQ2NCA9CmV4cG9ydHMuc2ZpeGVkNjQgPSBlbmNvZGVyKDEsCiAgZnVuY3Rpb24gZW5jb2RlICh2YWwsIGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICBiNGEuY29weSh2YWwsIGJ1ZmZlciwgb2Zmc2V0KQogICAgZW5jb2RlLmJ5dGVzID0gOAogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIHZhbCA9IGJ1ZmZlci5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIDgpCiAgICBkZWNvZGUuYnl0ZXMgPSA4CiAgICByZXR1cm4gdmFsCiAgfSwKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAoKSB7CiAgICByZXR1cm4gOAogIH0KKQoKZXhwb3J0cy5kb3VibGUgPSBlbmNvZGVyKDEsCiAgZnVuY3Rpb24gZW5jb2RlICh2YWwsIGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICBiNGEud3JpdGVEb3VibGVMRShidWZmZXIsIHZhbCwgb2Zmc2V0KQogICAgZW5jb2RlLmJ5dGVzID0gOAogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIHZhbCA9IGI0YS5yZWFkRG91YmxlTEUoYnVmZmVyLCBvZmZzZXQpCiAgICBkZWNvZGUuYnl0ZXMgPSA4CiAgICByZXR1cm4gdmFsCiAgfSwKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAoKSB7CiAgICByZXR1cm4gOAogIH0KKQoKZXhwb3J0cy5maXhlZDMyID0gZW5jb2Rlcig1LAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgYjRhLndyaXRlVUludDMyTEUoYnVmZmVyLCB2YWwsIG9mZnNldCkKICAgIGVuY29kZS5ieXRlcyA9IDQKICAgIHJldHVybiBidWZmZXIKICB9LAogIGZ1bmN0aW9uIGRlY29kZSAoYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciB2YWwgPSBiNGEucmVhZFVJbnQzMkxFKGJ1ZmZlciwgb2Zmc2V0KQogICAgZGVjb2RlLmJ5dGVzID0gNAogICAgcmV0dXJuIHZhbAogIH0sCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKCkgewogICAgcmV0dXJuIDQKICB9CikKCmV4cG9ydHMuc2ZpeGVkMzIgPSBlbmNvZGVyKDUsCiAgZnVuY3Rpb24gZW5jb2RlICh2YWwsIGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICBiNGEud3JpdGVJbnQzMkxFKGJ1ZmZlciwgdmFsLCBvZmZzZXQpCiAgICBlbmNvZGUuYnl0ZXMgPSA0CiAgICByZXR1cm4gYnVmZmVyCiAgfSwKICBmdW5jdGlvbiBkZWNvZGUgKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgdmFsID0gYjRhLnJlYWRJbnQzMkxFKGJ1ZmZlciwgb2Zmc2V0KQogICAgZGVjb2RlLmJ5dGVzID0gNAogICAgcmV0dXJuIHZhbAogIH0sCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKCkgewogICAgcmV0dXJuIDQKICB9CikKCmV4cG9ydHMuZmxvYXQgPSBlbmNvZGVyKDUsCiAgZnVuY3Rpb24gZW5jb2RlICh2YWwsIGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICBiNGEud3JpdGVGbG9hdExFKGJ1ZmZlciwgdmFsLCBvZmZzZXQpCiAgICBlbmNvZGUuYnl0ZXMgPSA0CiAgICByZXR1cm4gYnVmZmVyCiAgfSwKICBmdW5jdGlvbiBkZWNvZGUgKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgdmFsID0gYjRhLnJlYWRGbG9hdExFKGJ1ZmZlciwgb2Zmc2V0KQogICAgZGVjb2RlLmJ5dGVzID0gNAogICAgcmV0dXJuIHZhbAogIH0sCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKCkgewogICAgcmV0dXJuIDQKICB9CikKCmZ1bmN0aW9uIGVuY29kZXIgKHR5cGUsIGVuY29kZSwgZGVjb2RlLCBlbmNvZGluZ0xlbmd0aCkgewogIGVuY29kZS5ieXRlcyA9IGRlY29kZS5ieXRlcyA9IDAKCiAgcmV0dXJuIHsKICAgIHR5cGU6IHR5cGUsCiAgICBlbmNvZGU6IGVuY29kZSwKICAgIGRlY29kZTogZGVjb2RlLAogICAgZW5jb2RpbmdMZW5ndGg6IGVuY29kaW5nTGVuZ3RoCiAgfQp9CgpmdW5jdGlvbiBidWZmZXJMZW5ndGggKHZhbCkgewogIHJldHVybiBiNGEuaXNCdWZmZXIodmFsKSA/IHZhbC5sZW5ndGggOiBiNGEuYnl0ZUxlbmd0aCh2YWwpCn0KewogICJuYW1lIjogInByb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzIiwKICAidmVyc2lvbiI6ICIxLjIuMCIsCiAgImRlc2NyaXB0aW9uIjogIkJhc2UgZW5jb2RpbmdzIGZvciBwcm90b2NvbC1idWZmZXJzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi4wIiwKICAgICJzaWduZWQtdmFyaW50IjogIl4yLjAuMSIsCiAgICAidmFyaW50IjogIjUuMC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTQuMy40IiwKICAgICJ0YXBlIjogIl41LjAuMSIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgdGFwZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3Byb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9wcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9wcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncyIKfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgUHJvdG9tdXggPSByZXF1aXJlKCdwcm90b211eCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHNjaGVtYSA9IHJlcXVpcmUoJy4vc3BlYy9oeXBlcnNjaGVtYScpCgpjb25zdCBbTlNfSU5JVEFUT1IsIE5TX1JFU1BPTkRFUl0gPSBjcnlwdG8ubmFtZXNwYWNlKCd3YWtldXAnLCAyKQoKY29uc3QgSGFuZHNoYWtlID0gc2NoZW1hLmdldEVuY29kaW5nKCdAd2FrZXVwL2hhbmRzaGFrZScpCmNvbnN0IEFubm91bmNlID0gc2NoZW1hLmdldEVuY29kaW5nKCdAd2FrZXVwL2Fubm91bmNlJykKY29uc3QgTG9va3VwID0gc2NoZW1hLmdldEVuY29kaW5nKCdAd2FrZXVwL2xvb2t1cCcpCmNvbnN0IEluZm8gPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0B3YWtldXAvaW5mbycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFdha2V1cFN3YXJtIHsKICBjb25zdHJ1Y3Rvcihvbndha2V1cCA9IG5vb3AsIHsgZ2NUaWNrVGltZSA9IDIwMDAgfSA9IHt9KSB7CiAgICB0aGlzLmdjVGlja1RpbWUgPSBnY1RpY2tUaW1lCgogICAgdGhpcy50b3BpY3MgPSBuZXcgTWFwKCkKICAgIHRoaXMudG9waWNzR0MgPSBuZXcgU2V0KCkKICAgIHRoaXMubXV4ZXJzID0gbmV3IFNldCgpCiAgICB0aGlzLnN0YXRzID0gewogICAgICBzZXNzaW9uc09wZW5lZDogMCwKICAgICAgc2Vzc2lvbnNDbG9zZWQ6IDAsCiAgICAgIHRvcGljc0FkZGVkOiAwLAogICAgICB0b3BpY3NHY2Q6IDAsCiAgICAgIHBlZXJzQWRkZWQ6IDAsCiAgICAgIHBlZXJzUmVtb3ZlZDogMCwKICAgICAgd2lyZUFubm91bmNlOiB7IHJ4OiAwLCB0eDogMCB9LAogICAgICB3aXJlTG9va3VwOiB7IHJ4OiAwLCB0eDogMCB9LAogICAgICB3aXJlSW5mbzogeyByeDogMCwgdHg6IDAgfQogICAgfQoKICAgIHRoaXMub253YWtldXAgPSBvbndha2V1cAoKICAgIHRoaXMuX2djSW50ZXJ2YWwgPSBudWxsCiAgICB0aGlzLl9nY0JvdW5kID0gdGhpcy5fZ2MuYmluZCh0aGlzKQogIH0KCiAgc2Vzc2lvbihjYXBhYmlsaXR5LCBoYW5kbGVycyA9IHt9KSB7CiAgICBjb25zdCBpZCA9IGhhbmRsZXJzLmRpc2NvdmVyeUtleSB8fCBjcnlwdG8uZGlzY292ZXJ5S2V5KGNhcGFiaWxpdHkpCiAgICBjb25zdCBhY3RpdmUgPSBoYW5kbGVycy5hY3RpdmUgIT09IGZhbHNlCiAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcoaWQsICdoZXgnKQoKICAgIGxldCB3ID0gdGhpcy50b3BpY3MuZ2V0KGhleCkKCiAgICBpZiAodykgcmV0dXJuIHcuYWRkU2Vzc2lvbihoYW5kbGVycykKCiAgICB3ID0gbmV3IFdha2V1cFRvcGljKHRoaXMsIGlkLCBjYXBhYmlsaXR5LCBhY3RpdmUpCgogICAgdGhpcy50b3BpY3Muc2V0KGhleCwgdykKCiAgICBmb3IgKGNvbnN0IG11eGVyIG9mIHRoaXMubXV4ZXJzKSB7CiAgICAgIHcuX29ub3BlbihtdXhlciwgdHJ1ZSkKICAgIH0KCiAgICByZXR1cm4gdy5hZGRTZXNzaW9uKGhhbmRsZXJzKQogIH0KCiAgZ2V0U2Vzc2lvbnMoY2FwYWJpbGl0eSwgaGFuZGxlcnMgPSB7fSkgewogICAgY29uc3QgaWQgPSBoYW5kbGVycy5kaXNjb3ZlcnlLZXkgfHwgY3J5cHRvLmRpc2NvdmVyeUtleShjYXBhYmlsaXR5KQogICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGlkLCAnaGV4JykKICAgIGNvbnN0IHcgPSB0aGlzLnRvcGljcy5nZXQoaGV4KQogICAgcmV0dXJuIHcgPyB3LnNlc3Npb25zIDogW10KICB9CgogIGhhc1N0cmVhbShzdHJlYW0sIGNhcGFiaWxpdHksIGhhbmRsZXJzID0ge30pIHsKICAgIGlmICghY2FwYWJpbGl0eSkgewogICAgICBjb25zdCBub2lzZVN0cmVhbSA9IHN0cmVhbS5ub2lzZVN0cmVhbSB8fCBzdHJlYW0KICAgICAgcmV0dXJuIHRoaXMubXV4ZXJzLmhhcyhnZXRNdXhlcihub2lzZVN0cmVhbSkpCiAgICB9CgogICAgY29uc3QgaWQgPSBoYW5kbGVycy5kaXNjb3ZlcnlLZXkgfHwgY3J5cHRvLmRpc2NvdmVyeUtleShjYXBhYmlsaXR5KQogICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGlkLCAnaGV4JykKICAgIGNvbnN0IHQgPSB0aGlzLnRvcGljcy5nZXQoaGV4KQoKICAgIHJldHVybiB0ID8gdC5wZWVyc0J5U3RyZWFtLmhhcyhzdHJlYW0pIDogZmFsc2UKICB9CgogIGFkZFN0cmVhbShzdHJlYW0pIHsKICAgIGNvbnN0IG5vaXNlU3RyZWFtID0gc3RyZWFtLm5vaXNlU3RyZWFtIHx8IHN0cmVhbQoKICAgIGlmICghbm9pc2VTdHJlYW0uY29ubmVjdGVkKSB7CiAgICAgIG5vaXNlU3RyZWFtLm9uY2UoJ29wZW4nLCB0aGlzLmFkZFN0cmVhbS5iaW5kKHRoaXMsIG5vaXNlU3RyZWFtKSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgbXV4ZXIgPSBnZXRNdXhlcihub2lzZVN0cmVhbSkKICAgIG11eGVyLnBhaXIoeyBwcm90b2NvbDogJ3dha2V1cCcgfSwgKGlkKSA9PiB0aGlzLl9vbnBhaXIoaWQsIG11eGVyKSkKCiAgICB0aGlzLm11eGVycy5hZGQobXV4ZXIpCiAgICBub2lzZVN0cmVhbS5vbignY2xvc2UnLCAoKSA9PiB0aGlzLm11eGVycy5kZWxldGUobXV4ZXIpKQoKICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLnRvcGljcy52YWx1ZXMoKSkgewogICAgICBpZiAoIXcuaXNBY3RpdmUpIGNvbnRpbnVlCiAgICAgIHcuX29ub3BlbihtdXhlciwgdHJ1ZSkKICAgIH0KICB9CgogIF9vbkFjdGl2ZSh3KSB7CiAgICBmb3IgKGNvbnN0IG0gb2YgdGhpcy5tdXhlcnMpIHsKICAgICAgdy5fb25vcGVuKG0sIGZhbHNlKQogICAgfQogIH0KCiAgX2FkZEdDKHRvcGljKSB7CiAgICBpZiAodG9waWMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMudG9waWNzR0MuYWRkKHRvcGljKQogICAgaWYgKHRoaXMuX2djSW50ZXJ2YWwgPT09IG51bGwpIHsKICAgICAgdGhpcy5fZ2NJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuX2djQm91bmQsIHRoaXMuZ2NUaWNrVGltZSkKICAgIH0KICB9CgogIF9yZW1vdmVHQyh0b3BpYykgewogICAgdGhpcy50b3BpY3NHQy5kZWxldGUodG9waWMpCiAgICBpZiAodGhpcy50b3BpY3NHQy5zaXplID09PSAwICYmIHRoaXMuX2djSW50ZXJ2YWwpIHsKICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9nY0ludGVydmFsKQogICAgICB0aGlzLl9nY0ludGVydmFsID0gbnVsbAogICAgfQogIH0KCiAgX2djKCkgewogICAgY29uc3QgZGVzdHJveSA9IFtdCiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy50b3BpY3NHQykgewogICAgICB3LmlkbGVUaWNrcysrCiAgICAgIGlmICh3LmlkbGVUaWNrcyA+PSA1KSBkZXN0cm95LnB1c2godykKICAgIH0KICAgIGZvciAoY29uc3QgdyBvZiBkZXN0cm95KSB3LnRlYXJkb3duKCkKICB9CgogIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5fZ2NJbnRlcnZhbCkgY2xlYXJJbnRlcnZhbCh0aGlzLl9nY0ludGVydmFsKQogICAgdGhpcy5fZ2NJbnRlcnZhbCA9IG51bGwKCiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy50b3BpY3MudmFsdWVzKCkpIHcudGVhcmRvd24oKQogIH0KCiAgYXN5bmMgX29ucGFpcihpZCwgc3RyZWFtKSB7CiAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcoaWQsICdoZXgnKQogICAgY29uc3QgdyA9IHRoaXMudG9waWNzLmdldChoZXgpCiAgICBpZiAoIXcgfHwgIXcuc2Vzc2lvbnMubGVuZ3RoKSByZXR1cm4gdGhpcy5vbndha2V1cChpZCwgc3RyZWFtKQogICAgdy5fb25vcGVuKGdldE11eGVyKHN0cmVhbSksIGZhbHNlKQogIH0KCiAgcmVnaXN0ZXJNZXRyaWNzKHByb21DbGllbnQpIHsKICAgIGNvbnN0IHNlbGYgPSB0aGlzCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfc2Vzc2lvbnNfb3BlbmVkJywKICAgICAgaGVscDogJ1RoZSBhbW91bnQgb2Ygc2Vzc2lvbnMgb3BlbmVkIGJ5IHByb3RvbXV4IHdha2V1cCcsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy5zZXNzaW9uc09wZW5lZCkKICAgICAgfQogICAgfSkKCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfc2Vzc2lvbnNfY2xvc2VkJywKICAgICAgaGVscDogJ1RoZSBhbW91bnQgb2Ygc2Vzc2lvbnMgY2xvc2VkIGJ5IHByb3RvbXV4IHdha2V1cCcsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy5zZXNzaW9uc0Nsb3NlZCkKICAgICAgfQogICAgfSkKCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfdG9waWNzX2FkZGVkJywKICAgICAgaGVscDogJ1RoZSBhbW91bnQgb2YgdG9waWNzIGFkZGVkIHRvIHByb3RvbXV4IHdha2V1cCcsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy50b3BpY3NBZGRlZCkKICAgICAgfQogICAgfSkKCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfdG9waWNzX2djZCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHRvcGljcyB0aGF0IGdvdCBnYXJiYWdlIGNvbGxlY3RlZCBieSBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMudG9waWNzR2NkKQogICAgICB9CiAgICB9KQoKICAgIG5ldyBwcm9tQ2xpZW50LkdhdWdlKHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1uZXcKICAgICAgbmFtZTogJ3Byb3RvbXV4X3dha2V1cF9wZWVyc19hZGRlZCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHBlZXJzIGFkZGVkIGJ5IHByb3RvbXV4IHdha2V1cCwgYWNyb3NzIGFsbCB0b3BpY3MnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMucGVlcnNBZGRlZCkKICAgICAgfQogICAgfSkKCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfcGVlcnNfcmVtb3ZlZCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHBlZXJzIHJlbW92ZWQgYnkgcHJvdG9tdXggd2FrZXVwLCBhY3Jvc3MgYWxsIHRvcGljcycsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy5wZWVyc1JlbW92ZWQpCiAgICAgIH0KICAgIH0pCgogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3dpcmVfYW5ub3VuY2VfcngnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiB3aXJlIGFubm91bmNlIG1lc3NhZ2VzIHJlY2VpdmVkIGJ5IHByb3RvbXV4IHdha2V1cCcsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy53aXJlQW5ub3VuY2UucngpCiAgICAgIH0KICAgIH0pCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfd2lyZV9hbm5vdW5jZV90eCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHdpcmUgYW5ub3VuY2UgbWVzc2FnZXMgdHJhbnNtaXR0ZWQgYnkgcHJvdG9tdXggd2FrZXVwJywKICAgICAgY29sbGVjdCgpIHsKICAgICAgICB0aGlzLnNldChzZWxmLnN0YXRzLndpcmVBbm5vdW5jZS50eCkKICAgICAgfQogICAgfSkKICAgIG5ldyBwcm9tQ2xpZW50LkdhdWdlKHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1uZXcKICAgICAgbmFtZTogJ3Byb3RvbXV4X3dha2V1cF93aXJlX2xvb2t1cF9yeCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHdpcmUgbG9va3VwIG1lc3NhZ2VzIHJlY2VpdmVkIGJ5IHByb3RvbXV4IHdha2V1cCcsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy53aXJlTG9va3VwLnJ4KQogICAgICB9CiAgICB9KQogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3dpcmVfbG9va3VwX3R4JywKICAgICAgaGVscDogJ1RoZSBhbW91bnQgb2Ygd2lyZSBsb29rdXAgbWVzc2FnZXMgdHJhbnNtaXR0ZWQgYnkgcHJvdG9tdXggd2FrZXVwJywKICAgICAgY29sbGVjdCgpIHsKICAgICAgICB0aGlzLnNldChzZWxmLnN0YXRzLndpcmVMb29rdXAudHgpCiAgICAgIH0KICAgIH0pCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfd2lyZV9pbmZvX3J4JywKICAgICAgaGVscDogJ1RoZSBhbW91bnQgb2Ygd2lyZSBpbmZvIG1lc3NhZ2VzIHJlY2VpdmVkIGJ5IHByb3RvbXV4IHdha2V1cCcsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy53aXJlSW5mby5yeCkKICAgICAgfQogICAgfSkKICAgIG5ldyBwcm9tQ2xpZW50LkdhdWdlKHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1uZXcKICAgICAgbmFtZTogJ3Byb3RvbXV4X3dha2V1cF93aXJlX2luZm9fdHgnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiB3aXJlIGluZm8gbWVzc2FnZXMgdHJhbnNtaXR0ZWQgYnkgcHJvdG9tdXggd2FrZXVwJywKICAgICAgY29sbGVjdCgpIHsKICAgICAgICB0aGlzLnNldChzZWxmLnN0YXRzLndpcmVJbmZvLnJ4KQogICAgICB9CiAgICB9KQogIH0KfQoKY2xhc3MgV2FrZXVwUGVlciB7CiAgY29uc3RydWN0b3IodG9waWMpIHsKICAgIHRoaXMuaW5kZXggPSAwCiAgICB0aGlzLnVzZXJEYXRhID0gbnVsbCAvLyBmb3IgdGhlIHVzZXIKICAgIHRoaXMuY2xvY2sgPSAwIC8vIGZvciB0aGUgdXNlciwgdiB1c2VmdWwgdG8gcmVkdWNlIHRyYWZmaWMKICAgIHRoaXMucGVuZGluZyA9IHRydWUKICAgIHRoaXMucmVtb3ZlZCA9IGZhbHNlCiAgICB0aGlzLnRvcGljID0gdG9waWMKICAgIHRoaXMuY2hhbm5lbCA9IG51bGwKICAgIHRoaXMuc3RyZWFtID0gbnVsbAogICAgdGhpcy53aXJlTG9va3VwID0gbnVsbAogICAgdGhpcy53aXJlQW5ub3VuY2UgPSBudWxsCiAgICB0aGlzLndpcmVJbmZvID0gbnVsbAogICAgdGhpcy5hY3RpdmUgPSBmYWxzZQogIH0KCiAgdW5saW5rKGxpc3QpIHsKICAgIC8vIG5vdGUgdGhhdCBzaW5jZSB3ZSBwb3AgaGVyZSB3ZSBjYW4gaXRlcmF0ZSBpbiByZXZlcnNlIHNhZmVseSBpbiBjYXNlIGEgcGVlciBpcyByZW1vdmVkIGluIHRoZSBzYW1lIHRpY2sKICAgIGNvbnN0IGhlYWQgPSBsaXN0LnBvcCgpCiAgICBpZiAoaGVhZCA9PT0gdGhpcykgcmV0dXJuCiAgICBoZWFkLmluZGV4ID0gdGhpcy5pbmRleAogICAgbGlzdFtoZWFkLmluZGV4XSA9IGhlYWQKICB9Cn0KCmNsYXNzIFdha2V1cFNlc3Npb24gewogIGNvbnN0cnVjdG9yKHRvcGljLCBoYW5kbGVycykgewogICAgdGhpcy5pbmRleCA9IDAKICAgIHRoaXMudG9waWMgPSB0b3BpYwogICAgdGhpcy5oYW5kbGVycyA9IGhhbmRsZXJzCiAgICB0aGlzLmlzQWN0aXZlID0gaGFuZGxlcnMuYWN0aXZlICE9PSBmYWxzZQogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogIH0KCiAgZ2V0IHBlZXJzKCkgewogICAgcmV0dXJuIHRoaXMudG9waWMucGVlcnMKICB9CgogIGhhc1N0cmVhbShzdHJlYW0pIHsKICAgIHJldHVybiAhIXRoaXMuZ2V0UGVlcihzdHJlYW0pCiAgfQoKICBhZGRTdHJlYW0oc3RyZWFtKSB7CiAgICB0aGlzLnRvcGljLmFkZFN0cmVhbShzdHJlYW0pCiAgfQoKICBnZXRQZWVyKHN0cmVhbSkgewogICAgcmV0dXJuIHRoaXMudG9waWMucGVlcnNCeVN0cmVhbS5nZXQoc3RyZWFtKSB8fCBudWxsCiAgfQoKICBicm9hZGNhc3RMb29rdXAocmVxKSB7CiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy50b3BpYy5wZW5kaW5nUGVlcnMpIHsKICAgICAgdGhpcy5sb29rdXAocGVlciwgcmVxKQogICAgfQogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMudG9waWMucGVlcnMpIHsKICAgICAgdGhpcy5sb29rdXAocGVlciwgcmVxKQogICAgfQogIH0KCiAgbG9va3VwQnlTdHJlYW0oc3RyZWFtLCByZXEpIHsKICAgIGNvbnN0IHBlZXIgPSB0aGlzLnRvcGljLnBlZXJzQnlTdHJlYW0uZ2V0KHN0cmVhbSkKICAgIGlmIChwZWVyKSB0aGlzLmxvb2t1cChwZWVyLCByZXEpCiAgfQoKICBsb29rdXAocGVlciwgcmVxKSB7CiAgICBwZWVyLnRvcGljLnN0YXRlLnN0YXRzLndpcmVMb29rdXAudHgrKwogICAgcGVlci53aXJlTG9va3VwLnNlbmQocmVxIHx8IHsgaGFzaDogbnVsbCB9KQogIH0KCiAgYW5ub3VuY2VCeVN0cmVhbShzdHJlYW0sIHdha2V1cCkgewogICAgY29uc3QgcGVlciA9IHRoaXMudG9waWMucGVlcnNCeVN0cmVhbS5nZXQoc3RyZWFtKQogICAgaWYgKHBlZXIgJiYgIXBlZXIucGVuZGluZykgdGhpcy5hbm5vdW5jZShwZWVyLCB3YWtldXApCiAgfQoKICBhbm5vdW5jZShwZWVyLCB3YWtldXApIHsKICAgIHBlZXIudG9waWMuc3RhdGUuc3RhdHMud2lyZUFubm91bmNlLnR4KysKICAgIHBlZXIud2lyZUFubm91bmNlLnNlbmQod2FrZXVwKQogIH0KCiAgYWN0aXZlKCkgewogICAgdGhpcy5pc0FjdGl2ZSA9IHRydWUKICAgIHRoaXMudG9waWMuX2J1bXBBY3Rpdml0eSgpCiAgfQoKICBpbmFjdGl2ZSgpIHsKICAgIHRoaXMuaXNBY3RpdmUgPSBmYWxzZQogICAgdGhpcy50b3BpYy5fYnVtcEFjdGl2aXR5KCkKICB9CgogIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCiAgICB0aGlzLnRvcGljLnJlbW92ZVNlc3Npb24odGhpcykKICB9Cn0KCmNsYXNzIFdha2V1cFRvcGljIHsKICBjb25zdHJ1Y3RvcihzdGF0ZSwgaWQsIGNhcGFiaWxpdHksIGFjdGl2ZSkgewogICAgdGhpcy5zdGF0ZSA9IHN0YXRlCiAgICB0aGlzLnNlc3Npb25zID0gW10KICAgIHRoaXMuaWQgPSBpZAogICAgdGhpcy5jYXBhYmlsaXR5ID0gY2FwYWJpbGl0eQogICAgdGhpcy5wZWVycyA9IFtdCiAgICB0aGlzLnBlbmRpbmdQZWVycyA9IFtdCiAgICB0aGlzLnBlZXJzQnlTdHJlYW0gPSBuZXcgTWFwKCkKICAgIHRoaXMuYWN0aXZlUGVlcnMgPSAwCiAgICB0aGlzLmlzQWN0aXZlID0gYWN0aXZlCiAgICB0aGlzLmlkbGVUaWNrcyA9IDAKICAgIHRoaXMuZ2NpbmcgPSBmYWxzZQogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQoKICAgIHRoaXMuc3RhdGUuc3RhdHMudG9waWNzQWRkZWQrKwogIH0KCiAgYWRkU2Vzc2lvbihoYW5kbGVycykgewogICAgdGhpcy5zdGF0ZS5zdGF0cy5zZXNzaW9uc09wZW5lZCsrCiAgICBjb25zdCBzZXNzaW9uID0gbmV3IFdha2V1cFNlc3Npb24odGhpcywgaGFuZGxlcnMpCiAgICBzZXNzaW9uLmluZGV4ID0gdGhpcy5zZXNzaW9ucy5sZW5ndGgKICAgIHRoaXMuc2Vzc2lvbnMucHVzaChzZXNzaW9uKQogICAgdGhpcy5fYnVtcEFjdGl2aXR5KCkKICAgIHRoaXMuX2NoZWNrR0MoKQogICAgcmV0dXJuIHNlc3Npb24KICB9CgogIHJlbW92ZVNlc3Npb24oc2Vzc2lvbikgewogICAgaWYgKHRoaXMuc2Vzc2lvbnMubGVuZ3RoIDw9IHNlc3Npb24uaW5kZXgpIHJldHVybgogICAgaWYgKHRoaXMuc2Vzc2lvbnNbc2Vzc2lvbi5pbmRleF0gIT09IHNlc3Npb24pIHJldHVybgoKICAgIHRoaXMuc3RhdGUuc3RhdHMuc2Vzc2lvbnNDbG9zZWQrKwoKICAgIC8vIHNhbWUgYXMgd2l0aCB0aGUgcGVlciwgdGhpcyBhbGxvd3MgdXMgdG8gaXRlcmF0ZSB3aGlsZSByZW1vdmluZyBpZiBpdGVyYXRpbmcgYmFja3dhcmRzCiAgICBjb25zdCBoZWFkID0gdGhpcy5zZXNzaW9ucy5wb3AoKQogICAgaWYgKGhlYWQgIT09IHNlc3Npb24pIHsKICAgICAgaGVhZC5pbmRleCA9IHNlc3Npb24uaW5kZXgKICAgICAgdGhpcy5zZXNzaW9uc1toZWFkLmluZGV4XSA9IGhlYWQKICAgIH0KCiAgICB0aGlzLl9idW1wQWN0aXZpdHkoKQogICAgdGhpcy5fY2hlY2tHQygpCiAgfQoKICBfYnVtcEFjdGl2aXR5KCkgewogICAgbGV0IGlzQWN0aXZlID0gZmFsc2UKCiAgICBmb3IgKGxldCBpID0gdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBpZiAodGhpcy5zZXNzaW9uc1tpXS5pc0FjdGl2ZSkgewogICAgICAgIGlzQWN0aXZlID0gdHJ1ZQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KCiAgICBpZiAoaXNBY3RpdmUpIHRoaXMuYWN0aXZlKCkKICAgIGVsc2UgdGhpcy5pbmFjdGl2ZSgpCiAgfQoKICBhY3RpdmUoKSB7CiAgICBpZiAodGhpcy5pc0FjdGl2ZSkgcmV0dXJuCiAgICB0aGlzLmlkbGVUaWNrcyA9IDAKICAgIHRoaXMuaXNBY3RpdmUgPSB0cnVlCiAgICB0aGlzLl91cGRhdGVBY3RpdmUodHJ1ZSkKICB9CgogIGluYWN0aXZlKCkgewogICAgaWYgKCF0aGlzLmlzQWN0aXZlKSByZXR1cm4KICAgIHRoaXMuaXNBY3RpdmUgPSBmYWxzZQogICAgdGhpcy5fdXBkYXRlQWN0aXZlKGZhbHNlKQogIH0KCiAgX3VwZGF0ZUFjdGl2ZShhY3RpdmUpIHsKICAgIGNvbnN0IGluZm8gPSB7IGFjdGl2ZSB9CgogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVuZGluZ1BlZXJzKSB7CiAgICAgIHBlZXIudG9waWMuc3RhdGUuc3RhdHMud2lyZUluZm8udHgrKwogICAgICBwZWVyLndpcmVJbmZvLnNlbmQoaW5mbykKICAgIH0KICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSB7CiAgICAgIHBlZXIudG9waWMuc3RhdGUuc3RhdHMud2lyZUluZm8udHgrKwogICAgICBwZWVyLndpcmVJbmZvLnNlbmQoaW5mbykKICAgIH0KCiAgICB0aGlzLl9jaGVja0dDKCkKCiAgICBpZiAoYWN0aXZlKSB0aGlzLnN0YXRlLl9vbkFjdGl2ZSh0aGlzKQogIH0KCiAgdGVhcmRvd24oKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCgogICAgdGhpcy5zdGF0ZS5zdGF0cy50b3BpY3NHY2QrKwoKICAgIGZvciAobGV0IGkgPSB0aGlzLnBlZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIHRoaXMucGVlcnNbaV0uY2hhbm5lbC5jbG9zZSgpCiAgICB9CgogICAgZm9yIChsZXQgaSA9IHRoaXMucGVuZGluZ1BlZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIHRoaXMucGVuZGluZ1BlZXJzW2ldLmNoYW5uZWwuY2xvc2UoKQogICAgfQoKICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyh0aGlzLmlkLCAnaGV4JykKCiAgICB0aGlzLmdjaW5nID0gZmFsc2UKICAgIHRoaXMuc3RhdGUudG9waWNzLmRlbGV0ZShoZXgpCiAgICB0aGlzLnN0YXRlLl9yZW1vdmVHQyh0aGlzKQoKICAgIGZvciAobGV0IGkgPSB0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIHRoaXMuc3RhdGUuc3RhdHMuc2Vzc2lvbnNDbG9zZWQrKwogICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5zZXNzaW9uc1tpXQogICAgICBpZiAoc2Vzc2lvbi5oYW5kbGVycy5vbmRlc3Ryb3kpIHNlc3Npb24uaGFuZGxlcnMub25kZXN0cm95KHNlc3Npb24pCiAgICB9CiAgfQoKICBhZGRTdHJlYW0oc3RyZWFtKSB7CiAgICB0aGlzLl9vbm9wZW4oZ2V0TXV4ZXIoc3RyZWFtKSwgZmFsc2UpCiAgfQoKICBfcHJvdmVDYXBhYmlsaXR5VG8oc3RyZWFtKSB7CiAgICByZXR1cm4gdGhpcy5fbWFrZUNhcGFiaWxpdHkoc3RyZWFtLmlzSW5pdGlhdG9yLCBzdHJlYW0uaGFuZHNoYWtlSGFzaCkKICB9CgogIF9tYWtlQ2FwYWJpbGl0eShpc0luaXRpYXRvciwgaGFuZHNoYWtlSGFzaCkgewogICAgcmV0dXJuIGNyeXB0by5oYXNoKFtpc0luaXRpYXRvciA/IE5TX0lOSVRBVE9SIDogTlNfUkVTUE9OREVSLCB0aGlzLmNhcGFiaWxpdHksIGhhbmRzaGFrZUhhc2hdKQogIH0KCiAgX2FkZFBlZXIocGVlciwgb3BlbikgewogICAgaWYgKAogICAgICAhYjRhLmVxdWFscygKICAgICAgICBvcGVuLmNhcGFiaWxpdHksCiAgICAgICAgdGhpcy5fbWFrZUNhcGFiaWxpdHkoIXBlZXIuc3RyZWFtLmlzSW5pdGlhdG9yLCBwZWVyLnN0cmVhbS5oYW5kc2hha2VIYXNoKQogICAgICApCiAgICApIHsKICAgICAgcGVlci5jaGFubmVsLmNsb3NlKCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHBlZXIucGVuZGluZykgewogICAgICBwZWVyLnVubGluayh0aGlzLnBlbmRpbmdQZWVycykKICAgIH0KCiAgICBwZWVyLmFjdGl2ZSA9IG9wZW4uYWN0aXZlCiAgICBwZWVyLnBlbmRpbmcgPSBmYWxzZQogICAgcGVlci5pbmRleCA9IHRoaXMucGVlcnMucHVzaChwZWVyKSAtIDEKCiAgICBpZiAocGVlci5hY3RpdmUpIHsKICAgICAgdGhpcy5hY3RpdmVQZWVycysrCiAgICAgIHRoaXMuX2NoZWNrR0MoKQogICAgfQoKICAgIGZvciAobGV0IGkgPSB0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zW2ldCiAgICAgIGNvbnN0IGhhbmRsZXJzID0gc2Vzc2lvbi5oYW5kbGVycwoKICAgICAgaWYgKGhhbmRsZXJzLm9ucGVlcmFkZCkgaGFuZGxlcnMub25wZWVyYWRkKHBlZXIsIHNlc3Npb24pCiAgICAgIGlmIChwZWVyLmFjdGl2ZSAmJiBoYW5kbGVycy5vbnBlZXJhY3RpdmUpIGhhbmRsZXJzLm9ucGVlcmFjdGl2ZShwZWVyLCBzZXNzaW9uKQogICAgfQogIH0KCiAgX2NoZWNrR0MoKSB7CiAgICBjb25zdCBzaG91bGRHQyA9IHRoaXMuYWN0aXZlUGVlcnMgPT09IDAgJiYgdGhpcy5zZXNzaW9ucy5sZW5ndGggPT09IDAKCiAgICBpZiAoc2hvdWxkR0MpIHsKICAgICAgaWYgKCF0aGlzLmdjaW5nKSB7CiAgICAgICAgdGhpcy5nY2luZyA9IHRydWUKICAgICAgICB0aGlzLnN0YXRlLl9hZGRHQyh0aGlzKQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAodGhpcy5nY2luZykgewogICAgICAgIHRoaXMuZ2NpbmcgPSBmYWxzZQogICAgICAgIHRoaXMuc3RhdGUuX3JlbW92ZUdDKHRoaXMpCiAgICAgIH0KICAgIH0KICB9CgogIF9yZW1vdmVQZWVyKHBlZXIpIHsKICAgIHRoaXMuc3RhdGUuc3RhdHMucGVlcnNSZW1vdmVkKysKICAgIHBlZXIucmVtb3ZlZCA9IHRydWUKICAgIHRoaXMucGVlcnNCeVN0cmVhbS5kZWxldGUocGVlci5zdHJlYW0pCgogICAgaWYgKHBlZXIucGVuZGluZykgewogICAgICBwZWVyLnVubGluayh0aGlzLnBlbmRpbmdQZWVycykKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgYWN0aXZlID0gcGVlci5hY3RpdmUKCiAgICBpZiAoYWN0aXZlKSB7CiAgICAgIHBlZXIuYWN0aXZlID0gZmFsc2UKICAgICAgdGhpcy5hY3RpdmVQZWVycy0tCiAgICAgIHRoaXMuX2NoZWNrR0MoKQogICAgfQoKICAgIHBlZXIudW5saW5rKHRoaXMucGVlcnMpCgogICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbaV0KICAgICAgY29uc3QgaGFuZGxlcnMgPSBzZXNzaW9uLmhhbmRsZXJzCgogICAgICBpZiAoYWN0aXZlICYmIGhhbmRsZXJzLm9ucGVlcmluYWN0aXZlKSBoYW5kbGVycy5vbnBlZXJpbmFjdGl2ZShwZWVyLCBzZXNzaW9uKQogICAgICBpZiAoaGFuZGxlcnMub25wZWVycmVtb3ZlKSBoYW5kbGVycy5vbnBlZXJyZW1vdmUocGVlciwgc2Vzc2lvbikKICAgIH0KICB9CgogIF9vbmFubm91bmNlKHdha2V1cCwgcGVlcikgewogICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbaV0KICAgICAgY29uc3QgaGFuZGxlcnMgPSBzZXNzaW9uLmhhbmRsZXJzCgogICAgICBpZiAoaGFuZGxlcnMub25hbm5vdW5jZSkgaGFuZGxlcnMub25hbm5vdW5jZSh3YWtldXAsIHBlZXIsIHNlc3Npb24pCiAgICB9CiAgfQoKICBfb25sb29rdXAocmVxLCBwZWVyKSB7CiAgICBmb3IgKGxldCBpID0gdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5zZXNzaW9uc1tpXQogICAgICBjb25zdCBoYW5kbGVycyA9IHNlc3Npb24uaGFuZGxlcnMKCiAgICAgIGlmIChoYW5kbGVycy5vbmxvb2t1cCkgaGFuZGxlcnMub25sb29rdXAocmVxLCBwZWVyLCBzZXNzaW9uKQogICAgfQogIH0KCiAgX29uaW5mbyhpbmZvLCBwZWVyKSB7CiAgICBpZiAoaW5mby5hY3RpdmUpIHsKICAgICAgaWYgKCFwZWVyLmFjdGl2ZSkgewogICAgICAgIHBlZXIuYWN0aXZlID0gdHJ1ZQogICAgICAgIHRoaXMuYWN0aXZlUGVlcnMrKwogICAgICAgIHRoaXMuX2NoZWNrR0MoKQoKICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbaV0KICAgICAgICAgIGNvbnN0IGhhbmRsZXJzID0gc2Vzc2lvbi5oYW5kbGVycwoKICAgICAgICAgIGlmIChoYW5kbGVycy5vbnBlZXJhY3RpdmUpIGhhbmRsZXJzLm9ucGVlcmFjdGl2ZShwZWVyLCBzZXNzaW9uKQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKHBlZXIuYWN0aXZlKSB7CiAgICAgICAgcGVlci5hY3RpdmUgPSBmYWxzZQogICAgICAgIHRoaXMuYWN0aXZlUGVlcnMtLQogICAgICAgIHRoaXMuX2NoZWNrR0MoKQoKICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbaV0KICAgICAgICAgIGNvbnN0IGhhbmRsZXJzID0gc2Vzc2lvbi5oYW5kbGVycwoKICAgICAgICAgIGlmIChoYW5kbGVycy5vbnBlZXJpbmFjdGl2ZSkgaGFuZGxlcnMub25wZWVyaW5hY3RpdmUocGVlciwgc2Vzc2lvbikKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIF9vbm9wZW4obXV4ZXIsIHVuaXF1ZSkgewogICAgaWYgKCF1bmlxdWUgJiYgdGhpcy5wZWVyc0J5U3RyZWFtLmhhcyhtdXhlci5zdHJlYW0pKSByZXR1cm4KCiAgICBjb25zdCBwZWVyID0gbmV3IFdha2V1cFBlZXIodGhpcykKICAgIGNvbnN0IGNoID0gbXV4ZXIuY3JlYXRlQ2hhbm5lbCh7CiAgICAgIHVzZXJEYXRhOiBwZWVyLAogICAgICBwcm90b2NvbDogJ3dha2V1cCcsCiAgICAgIGlkOiB0aGlzLmlkLAogICAgICBoYW5kc2hha2U6IEhhbmRzaGFrZSwKICAgICAgbWVzc2FnZXM6IFsKICAgICAgICB7IGVuY29kaW5nOiBMb29rdXAsIG9ubWVzc2FnZTogb25sb29rdXAgfSwKICAgICAgICB7IGVuY29kaW5nOiBBbm5vdW5jZSwgb25tZXNzYWdlOiBvbmFubm91bmNlIH0sCiAgICAgICAgeyBlbmNvZGluZzogSW5mbywgb25tZXNzYWdlOiBvbmNoYW5uZWxpbmZvIH0KICAgICAgXSwKICAgICAgb25vcGVuOiBvbmNoYW5uZWxvcGVuLAogICAgICBvbmNsb3NlOiBvbmNoYW5uZWxjbG9zZQogICAgfSkKCiAgICBpZiAoIWNoKSByZXR1cm4KCiAgICB0aGlzLnN0YXRlLnN0YXRzLnBlZXJzQWRkZWQrKwoKICAgIHBlZXIuY2hhbm5lbCA9IGNoCiAgICBwZWVyLnN0cmVhbSA9IG11eGVyLnN0cmVhbQoKICAgIHBlZXIud2lyZUxvb2t1cCA9IGNoLm1lc3NhZ2VzWzBdCiAgICBwZWVyLndpcmVBbm5vdW5jZSA9IGNoLm1lc3NhZ2VzWzFdCiAgICBwZWVyLndpcmVJbmZvID0gY2gubWVzc2FnZXNbMl0KCiAgICBwZWVyLmluZGV4ID0gdGhpcy5wZW5kaW5nUGVlcnMucHVzaChwZWVyKSAtIDEKICAgIHRoaXMucGVlcnNCeVN0cmVhbS5zZXQobXV4ZXIuc3RyZWFtLCBwZWVyKQoKICAgIGNoLm9wZW4oewogICAgICB2ZXJzaW9uOiAwLAogICAgICBjYXBhYmlsaXR5OiB0aGlzLl9wcm92ZUNhcGFiaWxpdHlUbyhtdXhlci5zdHJlYW0pLAogICAgICBhY3RpdmU6IHRoaXMuaXNBY3RpdmUKICAgIH0pCiAgfQp9CgpmdW5jdGlvbiBvbmNoYW5uZWxvcGVuKG9wZW4sIGNoYW5uZWwpIHsKICBjb25zdCBwZWVyID0gY2hhbm5lbC51c2VyRGF0YQogIHBlZXIudG9waWMuX2FkZFBlZXIocGVlciwgb3BlbikKfQoKZnVuY3Rpb24gb25jaGFubmVsY2xvc2UoY2xvc2UsIGNoYW5uZWwpIHsKICBjb25zdCBwZWVyID0gY2hhbm5lbC51c2VyRGF0YQogIHBlZXIudG9waWMuX3JlbW92ZVBlZXIocGVlcikKfQoKZnVuY3Rpb24gb25sb29rdXAocmVxLCBjaGFubmVsKSB7CiAgY29uc3QgcGVlciA9IGNoYW5uZWwudXNlckRhdGEKICBwZWVyLnRvcGljLnN0YXRlLnN0YXRzLndpcmVMb29rdXAucngrKwogIHBlZXIudG9waWMuX29ubG9va3VwKHJlcSwgcGVlcikKfQoKZnVuY3Rpb24gb25hbm5vdW5jZSh3YWtldXAsIGNoYW5uZWwpIHsKICBjb25zdCBwZWVyID0gY2hhbm5lbC51c2VyRGF0YQogIHBlZXIudG9waWMuc3RhdGUuc3RhdHMud2lyZUFubm91bmNlLnJ4KysKICBwZWVyLnRvcGljLl9vbmFubm91bmNlKHdha2V1cCwgcGVlcikKfQoKZnVuY3Rpb24gb25jaGFubmVsaW5mbyhpbmZvLCBjaGFubmVsKSB7CiAgY29uc3QgcGVlciA9IGNoYW5uZWwudXNlckRhdGEKICBwZWVyLnRvcGljLnN0YXRlLnN0YXRzLndpcmVJbmZvLnJ4KysKICBwZWVyLnRvcGljLl9vbmluZm8oaW5mbywgcGVlcikKfQoKZnVuY3Rpb24gZ2V0TXV4ZXIoc3RyZWFtKSB7CiAgaWYgKFByb3RvbXV4LmlzUHJvdG9tdXgoc3RyZWFtKSkgcmV0dXJuIHN0cmVhbQogIGlmIChzdHJlYW0ubm9pc2VTdHJlYW0udXNlckRhdGEpIHJldHVybiBzdHJlYW0ubm9pc2VTdHJlYW0udXNlckRhdGEKICBjb25zdCBtdXggPSBQcm90b211eC5mcm9tKHN0cmVhbS5ub2lzZVN0cmVhbSkKICBzdHJlYW0ubm9pc2VTdHJlYW0udXNlckRhdGEgPSBtdXgKICByZXR1cm4gbXV4Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQp7CiAgIm5hbWUiOiAicHJvdG9tdXgtd2FrZXVwIiwKICAidmVyc2lvbiI6ICIyLjkuMCIsCiAgImRlc2NyaXB0aW9uIjogIldha2V1cCBwcm90b2NvbCBvdmVyIHByb3RvbXV4IiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi43IiwKICAgICJoeXBlcmNvcmUtY3J5cHRvIjogIl4zLjUuMCIsCiAgICAiaHlwZXJzY2hlbWEiOiAiXjEuMTAuNCIsCiAgICAicHJvdG9tdXgiOiAiXjMuMTAuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbSI6ICJeNi44LjEiLAogICAgImJyaXR0bGUiOiAiXjMuMTcuMSIsCiAgICAibHVudGUiOiAiXjEuMC4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIiwKICAgICJwcm9tLWNsaWVudCI6ICJeMTUuMS4zIgogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJzcGVjL2h5cGVyc2NoZW1hLyouanMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIiwKICAgICJ0ZXN0IjogInByZXR0aWVyIC0tY2hlY2sgLiAmJiBsdW50ZSAmJiBicml0dGxlIHRlc3QvKi5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3Byb3RvbXV4LXdha2V1cC5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMuIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3Byb3RvbXV4LXdha2V1cC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3Byb3RvbXV4LXdha2V1cCIKfQovLyBUaGlzIGZpbGUgaXMgYXV0b2dlbmVyYXRlZCBieSB0aGUgaHlwZXJzY2hlbWEgY29tcGlsZXIKLy8gU2NoZW1hIFZlcnNpb246IDEKLyogZXNsaW50LWRpc2FibGUgY2FtZWxjYXNlICovCi8qIGVzbGludC1kaXNhYmxlIHF1b3RlcyAqLwoKY29uc3QgVkVSU0lPTiA9IDEKY29uc3QgeyBjIH0gPSByZXF1aXJlKCdoeXBlcnNjaGVtYS9ydW50aW1lJykKCi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtdmFycwpsZXQgdmVyc2lvbiA9IFZFUlNJT04KCi8vIEB3YWtldXAvaW5mbwpjb25zdCBlbmNvZGluZzAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAxIHNvIGFsd2F5cyBvbmUgYnl0ZQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IG0uYWN0aXZlID8gMSA6IDAKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGFjdGl2ZTogKGZsYWdzICYgMSkgIT09IDAKICAgIH0KICB9Cn0KCi8vIEB3YWtldXAvaGFuZHNoYWtlCmNvbnN0IGVuY29kaW5nMSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0uY2FwYWJpbGl0eSkKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDEgc28gYWx3YXlzIG9uZSBieXRlCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gbS5hY3RpdmUgPyAxIDogMAoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0uY2FwYWJpbGl0eSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogcjAsCiAgICAgIGNhcGFiaWxpdHk6IHIxLAogICAgICBhY3RpdmU6IChmbGFncyAmIDEpICE9PSAwCiAgICB9CiAgfQp9CgovLyBAd2FrZXVwL3dyaXRlcgpjb25zdCBlbmNvZGluZzIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAga2V5OiByMCwKICAgICAgbGVuZ3RoOiByMQogICAgfQogIH0KfQoKLy8gQHdha2V1cC9hbm5vdW5jZQpjb25zdCBlbmNvZGluZzMgPSBjLmFycmF5KGVuY29kaW5nMikKCi8vIEB3YWtldXAvbG9va3VwCmNvbnN0IGVuY29kaW5nNCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDEgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0uaGFzaCkgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IG0uaGFzaCA/IDEgOiAwCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0uaGFzaCkgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5oYXNoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgaGFzaDogKGZsYWdzICYgMSkgIT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHNldFZlcnNpb24odikgewogIHZlcnNpb24gPSB2Cn0KCmZ1bmN0aW9uIGVuY29kZShuYW1lLCB2YWx1ZSwgdiA9IFZFUlNJT04pIHsKICB2ZXJzaW9uID0gdgogIHJldHVybiBjLmVuY29kZShnZXRFbmNvZGluZyhuYW1lKSwgdmFsdWUpCn0KCmZ1bmN0aW9uIGRlY29kZShuYW1lLCBidWZmZXIsIHYgPSBWRVJTSU9OKSB7CiAgdmVyc2lvbiA9IHYKICByZXR1cm4gYy5kZWNvZGUoZ2V0RW5jb2RpbmcobmFtZSksIGJ1ZmZlcikKfQoKZnVuY3Rpb24gZ2V0RW51bShuYW1lKSB7CiAgc3dpdGNoIChuYW1lKSB7CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VudW0gbm90IGZvdW5kICcgKyBuYW1lKQogIH0KfQoKZnVuY3Rpb24gZ2V0RW5jb2RpbmcobmFtZSkgewogIHN3aXRjaCAobmFtZSkgewogICAgY2FzZSAnQHdha2V1cC9pbmZvJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMAogICAgY2FzZSAnQHdha2V1cC9oYW5kc2hha2UnOgogICAgICByZXR1cm4gZW5jb2RpbmcxCiAgICBjYXNlICdAd2FrZXVwL3dyaXRlcic6CiAgICAgIHJldHVybiBlbmNvZGluZzIKICAgIGNhc2UgJ0B3YWtldXAvYW5ub3VuY2UnOgogICAgICByZXR1cm4gZW5jb2RpbmczCiAgICBjYXNlICdAd2FrZXVwL2xvb2t1cCc6CiAgICAgIHJldHVybiBlbmNvZGluZzQKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcignRW5jb2RlciBub3QgZm91bmQgJyArIG5hbWUpCiAgfQp9CgpmdW5jdGlvbiBnZXRTdHJ1Y3QobmFtZSwgdiA9IFZFUlNJT04pIHsKICBjb25zdCBlbmMgPSBnZXRFbmNvZGluZyhuYW1lKQogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgZW5jLnByZWVuY29kZShzdGF0ZSwgbSkKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgZW5jLmVuY29kZShzdGF0ZSwgbSkKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgcmV0dXJuIGVuYy5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZXNvbHZlU3RydWN0ID0gZ2V0U3RydWN0IC8vIGNvbXBhdAoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgcmVzb2x2ZVN0cnVjdCwKICBnZXRTdHJ1Y3QsCiAgZ2V0RW51bSwKICBnZXRFbmNvZGluZywKICBlbmNvZGUsCiAgZGVjb2RlLAogIHNldFZlcnNpb24sCiAgdmVyc2lvbgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgcXVldWVUaWNrID0gcmVxdWlyZSgncXVldWUtdGljaycpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKCmNvbnN0IE1BWF9CVUZGRVJFRCA9IDMyNzY4CmNvbnN0IE1BWF9CQUNLTE9HID0gSW5maW5pdHkgLy8gVE9ETzogaW1wbCAib3BlbiIgYmFja3ByZXNzdXJlCmNvbnN0IE1BWF9CQVRDSCA9IDggKiAxMDI0ICogMTAyNAoKY2xhc3MgQ2hhbm5lbCB7CiAgY29uc3RydWN0b3IgKG11eCwgaW5mbywgdXNlckRhdGEsIHByb3RvY29sLCBhbGlhc2VzLCBpZCwgaGFuZHNoYWtlLCBtZXNzYWdlcywgb25vcGVuLCBvbmNsb3NlLCBvbmRlc3Ryb3ksIG9uZHJhaW4pIHsKICAgIHRoaXMudXNlckRhdGEgPSB1c2VyRGF0YQogICAgdGhpcy5wcm90b2NvbCA9IHByb3RvY29sCiAgICB0aGlzLmFsaWFzZXMgPSBhbGlhc2VzCiAgICB0aGlzLmlkID0gaWQKICAgIHRoaXMuaGFuZHNoYWtlID0gbnVsbAogICAgdGhpcy5tZXNzYWdlcyA9IFtdCgogICAgdGhpcy5vcGVuZWQgPSBmYWxzZQogICAgdGhpcy5jbG9zZWQgPSBmYWxzZQogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQoKICAgIHRoaXMub25vcGVuID0gb25vcGVuCiAgICB0aGlzLm9uY2xvc2UgPSBvbmNsb3NlCiAgICB0aGlzLm9uZGVzdHJveSA9IG9uZGVzdHJveQogICAgdGhpcy5vbmRyYWluID0gb25kcmFpbgoKICAgIHRoaXMuX2hhbmRzaGFrZSA9IGhhbmRzaGFrZQogICAgdGhpcy5fbXV4ID0gbXV4CiAgICB0aGlzLl9pbmZvID0gaW5mbwogICAgdGhpcy5fbG9jYWxJZCA9IDAKICAgIHRoaXMuX3JlbW90ZUlkID0gMAogICAgdGhpcy5fYWN0aXZlID0gMAogICAgdGhpcy5fZXh0ZW5zaW9ucyA9IG51bGwKCiAgICB0aGlzLl9kZWNCb3VuZCA9IHRoaXMuX2RlYy5iaW5kKHRoaXMpCiAgICB0aGlzLl9kZWNBbmREZXN0cm95Qm91bmQgPSB0aGlzLl9kZWNBbmREZXN0cm95LmJpbmQodGhpcykKCiAgICB0aGlzLl9vcGVuZWRQcm9taXNlID0gbnVsbAogICAgdGhpcy5fb3BlbmVkUmVzb2x2ZSA9IG51bGwKCiAgICB0aGlzLl9kZXN0cm95ZWRQcm9taXNlID0gbnVsbAogICAgdGhpcy5fZGVzdHJveWVkUmVzb2x2ZSA9IG51bGwKCiAgICBmb3IgKGNvbnN0IG0gb2YgbWVzc2FnZXMpIHRoaXMuYWRkTWVzc2FnZShtKQogIH0KCiAgZ2V0IGRyYWluZWQgKCkgewogICAgcmV0dXJuIHRoaXMuX211eC5kcmFpbmVkCiAgfQoKICBmdWxseU9wZW5lZCAoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQpIHJldHVybiBQcm9taXNlLnJlc29sdmUodHJ1ZSkKICAgIGlmICh0aGlzLmNsb3NlZCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxzZSkKICAgIGlmICh0aGlzLl9vcGVuZWRQcm9taXNlKSByZXR1cm4gdGhpcy5fb3BlbmVkUHJvbWlzZQoKICAgIHRoaXMuX29wZW5lZFByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4geyB0aGlzLl9vcGVuZWRSZXNvbHZlID0gcmVzb2x2ZSB9KQogICAgcmV0dXJuIHRoaXMuX29wZW5lZFByb21pc2UKICB9CgogIGZ1bGx5Q2xvc2VkICgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCiAgICBpZiAodGhpcy5fZGVzdHJveWVkUHJvbWlzZSkgcmV0dXJuIHRoaXMuX2Rlc3Ryb3llZFByb21pc2UKCiAgICB0aGlzLl9kZXN0cm95ZWRQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsgdGhpcy5fZGVzdHJveWVkUmVzb2x2ZSA9IHJlc29sdmUgfSkKICAgIHJldHVybiB0aGlzLl9kZXN0cm95ZWRQcm9taXNlCiAgfQoKICBvcGVuIChoYW5kc2hha2UpIHsKICAgIGNvbnN0IGlkID0gdGhpcy5fbXV4Ll9mcmVlLmxlbmd0aCA+IDAKICAgICAgPyB0aGlzLl9tdXguX2ZyZWUucG9wKCkKICAgICAgOiB0aGlzLl9tdXguX2xvY2FsLnB1c2gobnVsbCkgLSAxCgogICAgdGhpcy5faW5mby5vcGVuZWQrKwogICAgdGhpcy5faW5mby5sYXN0Q2hhbm5lbCA9IHRoaXMKICAgIHRoaXMuX2xvY2FsSWQgPSBpZCArIDEKICAgIHRoaXMuX211eC5fbG9jYWxbaWRdID0gdGhpcwoKICAgIGlmICh0aGlzLl9yZW1vdGVJZCA9PT0gMCkgewogICAgICB0aGlzLl9pbmZvLm91dGdvaW5nLnB1c2godGhpcy5fbG9jYWxJZCkKICAgIH0KCiAgICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyOiBudWxsLCBzdGFydDogMiwgZW5kOiAyIH0KCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB0aGlzLl9sb2NhbElkKQogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCB0aGlzLnByb3RvY29sKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCB0aGlzLmlkKQogICAgaWYgKHRoaXMuX2hhbmRzaGFrZSkgdGhpcy5faGFuZHNoYWtlLnByZWVuY29kZShzdGF0ZSwgaGFuZHNoYWtlKQoKICAgIHN0YXRlLmJ1ZmZlciA9IHRoaXMuX211eC5fYWxsb2Moc3RhdGUuZW5kKQoKICAgIHN0YXRlLmJ1ZmZlclswXSA9IDAKICAgIHN0YXRlLmJ1ZmZlclsxXSA9IDEKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHRoaXMuX2xvY2FsSWQpCiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIHRoaXMucHJvdG9jb2wpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHRoaXMuaWQpCiAgICBpZiAodGhpcy5faGFuZHNoYWtlKSB0aGlzLl9oYW5kc2hha2UuZW5jb2RlKHN0YXRlLCBoYW5kc2hha2UpCgogICAgdGhpcy5fbXV4Ll93cml0ZTAoc3RhdGUuYnVmZmVyKQogIH0KCiAgX2RlYyAoKSB7CiAgICBpZiAoLS10aGlzLl9hY3RpdmUgPT09IDAgJiYgdGhpcy5jbG9zZWQgPT09IHRydWUpIHRoaXMuX2Rlc3Ryb3koKQogIH0KCiAgX2RlY0FuZERlc3Ryb3kgKGVycikgewogICAgdGhpcy5fZGVjKCkKICAgIHRoaXMuX211eC5fc2FmZURlc3Ryb3koZXJyKQogIH0KCiAgX2Z1bGx5T3BlblNvb24gKCkgewogICAgdGhpcy5fbXV4Ll9yZW1vdGVbdGhpcy5fcmVtb3RlSWQgLSAxXS5zZXNzaW9uID0gdGhpcwogICAgcXVldWVUaWNrKHRoaXMuX2Z1bGx5T3Blbi5iaW5kKHRoaXMpKQogIH0KCiAgX2Z1bGx5T3BlbiAoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IHRydWUgfHwgdGhpcy5jbG9zZWQgPT09IHRydWUpIHJldHVybgoKICAgIGNvbnN0IHJlbW90ZSA9IHRoaXMuX211eC5fcmVtb3RlW3RoaXMuX3JlbW90ZUlkIC0gMV0KCiAgICB0aGlzLm9wZW5lZCA9IHRydWUKICAgIHRoaXMuaGFuZHNoYWtlID0gdGhpcy5faGFuZHNoYWtlID8gdGhpcy5faGFuZHNoYWtlLmRlY29kZShyZW1vdGUuc3RhdGUpIDogbnVsbAogICAgdGhpcy5fdHJhY2sodGhpcy5vbm9wZW4odGhpcy5oYW5kc2hha2UsIHRoaXMpKQoKICAgIHJlbW90ZS5zZXNzaW9uID0gdGhpcwogICAgcmVtb3RlLnN0YXRlID0gbnVsbAogICAgaWYgKHJlbW90ZS5wZW5kaW5nICE9PSBudWxsKSB0aGlzLl9kcmFpbihyZW1vdGUpCgogICAgdGhpcy5fcmVzb2x2ZU9wZW4odHJ1ZSkKICB9CgogIF9yZXNvbHZlT3BlbiAob3BlbmVkKSB7CiAgICBpZiAodGhpcy5fb3BlbmVkUmVzb2x2ZSAhPT0gbnVsbCkgewogICAgICB0aGlzLl9vcGVuZWRSZXNvbHZlKG9wZW5lZCkKICAgICAgdGhpcy5fb3BlbmVkUmVzb2x2ZSA9IHRoaXMuX29wZW5lZFByb21pc2UgPSBudWxsCiAgICB9CiAgfQoKICBfcmVzb2x2ZURlc3Ryb3llZCAoKSB7CiAgICBpZiAodGhpcy5fZGVzdHJveWVkUmVzb2x2ZSAhPT0gbnVsbCkgewogICAgICB0aGlzLl9kZXN0cm95ZWRSZXNvbHZlKCkKICAgICAgdGhpcy5fZGVzdHJveWVkUmVzb2x2ZSA9IHRoaXMuX2Rlc3Ryb3llZFByb21pc2UgPSBudWxsCiAgICB9CiAgfQoKICBfZHJhaW4gKHJlbW90ZSkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZW1vdGUucGVuZGluZy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBwID0gcmVtb3RlLnBlbmRpbmdbaV0KICAgICAgdGhpcy5fbXV4Ll9idWZmZXJlZCAtPSBieXRlU2l6ZShwLnN0YXRlKQogICAgICB0aGlzLl9yZWN2KHAudHlwZSwgcC5zdGF0ZSkKICAgIH0KCiAgICByZW1vdGUucGVuZGluZyA9IG51bGwKICAgIHRoaXMuX211eC5fcmVzdW1lTWF5YmUoKQogIH0KCiAgX3RyYWNrIChwKSB7CiAgICBpZiAoaXNQcm9taXNlKHApID09PSB0cnVlKSB7CiAgICAgIHRoaXMuX2FjdGl2ZSsrCiAgICAgIHJldHVybiBwLnRoZW4odGhpcy5fZGVjQm91bmQsIHRoaXMuX2RlY0FuZERlc3Ryb3lCb3VuZCkKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgX2Nsb3NlIChpc1JlbW90ZSkgewogICAgaWYgKHRoaXMuY2xvc2VkID09PSB0cnVlKSByZXR1cm4KICAgIHRoaXMuY2xvc2VkID0gdHJ1ZQoKICAgIHRoaXMuX2luZm8ub3BlbmVkLS0KICAgIGlmICh0aGlzLl9pbmZvLmxhc3RDaGFubmVsID09PSB0aGlzKSB0aGlzLl9pbmZvLmxhc3RDaGFubmVsID0gbnVsbAoKICAgIGlmICh0aGlzLl9yZW1vdGVJZCA+IDApIHsKICAgICAgdGhpcy5fbXV4Ll9yZW1vdGVbdGhpcy5fcmVtb3RlSWQgLSAxXSA9IG51bGwKICAgICAgdGhpcy5fcmVtb3RlSWQgPSAwCiAgICAgIC8vIElmIHJlbW90ZSBoYXMgYWNrZWQsIHdlIGNhbiByZXVzZSB0aGUgbG9jYWwgaWQgbm93CiAgICAgIC8vIG90aGVyd2lzZSwgd2UgbmVlZCB0byB3YWl0IGZvciB0aGUgImFjayIgdG8gYXJyaXZlCiAgICAgIHRoaXMuX211eC5fZnJlZS5wdXNoKHRoaXMuX2xvY2FsSWQgLSAxKQogICAgfQoKICAgIHRoaXMuX211eC5fbG9jYWxbdGhpcy5fbG9jYWxJZCAtIDFdID0gbnVsbAogICAgdGhpcy5fbG9jYWxJZCA9IDAKCiAgICB0aGlzLl9tdXguX2djKHRoaXMuX2luZm8pCiAgICB0aGlzLl90cmFjayh0aGlzLm9uY2xvc2UoaXNSZW1vdGUsIHRoaXMpKQoKICAgIGlmICh0aGlzLl9hY3RpdmUgPT09IDApIHRoaXMuX2Rlc3Ryb3koKQoKICAgIHRoaXMuX3Jlc29sdmVPcGVuKGZhbHNlKQogIH0KCiAgX2Rlc3Ryb3kgKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkID09PSB0cnVlKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQogICAgdGhpcy5fdHJhY2sodGhpcy5vbmRlc3Ryb3kodGhpcykpCiAgICB0aGlzLl9yZXNvbHZlRGVzdHJveWVkKCkKICB9CgogIF9yZWN2ICh0eXBlLCBzdGF0ZSkgewogICAgaWYgKHR5cGUgPCB0aGlzLm1lc3NhZ2VzLmxlbmd0aCkgewogICAgICBjb25zdCBtID0gdGhpcy5tZXNzYWdlc1t0eXBlXQogICAgICBjb25zdCBwID0gbS5yZWN2KHN0YXRlLCB0aGlzKQogICAgICBpZiAobS5hdXRvQmF0Y2ggPT09IHRydWUpIHJldHVybiBwCiAgICB9CiAgICByZXR1cm4gbnVsbAogIH0KCiAgY29yayAoKSB7CiAgICB0aGlzLl9tdXguY29yaygpCiAgfQoKICB1bmNvcmsgKCkgewogICAgdGhpcy5fbXV4LnVuY29yaygpCiAgfQoKICBjbG9zZSAoKSB7CiAgICBpZiAodGhpcy5jbG9zZWQgPT09IHRydWUpIHJldHVybgoKICAgIGNvbnN0IHN0YXRlID0geyBidWZmZXI6IG51bGwsIHN0YXJ0OiAyLCBlbmQ6IDIgfQoKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHRoaXMuX2xvY2FsSWQpCgogICAgc3RhdGUuYnVmZmVyID0gdGhpcy5fbXV4Ll9hbGxvYyhzdGF0ZS5lbmQpCgogICAgc3RhdGUuYnVmZmVyWzBdID0gMAogICAgc3RhdGUuYnVmZmVyWzFdID0gMwogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdGhpcy5fbG9jYWxJZCkKCiAgICB0aGlzLl9jbG9zZShmYWxzZSkKICAgIHRoaXMuX211eC5fd3JpdGUwKHN0YXRlLmJ1ZmZlcikKICB9CgogIGFkZE1lc3NhZ2UgKG9wdHMpIHsKICAgIGlmICghb3B0cykgcmV0dXJuIHRoaXMuX3NraXBNZXNzYWdlKCkKCiAgICBjb25zdCB0eXBlID0gdGhpcy5tZXNzYWdlcy5sZW5ndGgKICAgIGNvbnN0IGF1dG9CYXRjaCA9IG9wdHMuYXV0b0JhdGNoICE9PSBmYWxzZQogICAgY29uc3QgZW5jb2RpbmcgPSBvcHRzLmVuY29kaW5nIHx8IGMucmF3CiAgICBjb25zdCBvbm1lc3NhZ2UgPSBvcHRzLm9ubWVzc2FnZSB8fCBub29wCgogICAgY29uc3QgcyA9IHRoaXMKICAgIGNvbnN0IHR5cGVMZW4gPSBlbmNvZGluZ0xlbmd0aChjLnVpbnQsIHR5cGUpCgogICAgY29uc3QgbSA9IHsKICAgICAgdHlwZSwKICAgICAgYXV0b0JhdGNoLAogICAgICBlbmNvZGluZywKICAgICAgb25tZXNzYWdlLAogICAgICByZWN2IChzdGF0ZSwgc2Vzc2lvbikgewogICAgICAgIHJldHVybiBzZXNzaW9uLl90cmFjayhtLm9ubWVzc2FnZShlbmNvZGluZy5kZWNvZGUoc3RhdGUpLCBzZXNzaW9uKSkKICAgICAgfSwKICAgICAgc2VuZCAobSwgc2Vzc2lvbiA9IHMpIHsKICAgICAgICBpZiAoc2Vzc2lvbi5jbG9zZWQgPT09IHRydWUpIHJldHVybiBmYWxzZQoKICAgICAgICBjb25zdCBtdXggPSBzZXNzaW9uLl9tdXgKICAgICAgICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyOiBudWxsLCBzdGFydDogMCwgZW5kOiB0eXBlTGVuIH0KCiAgICAgICAgaWYgKG11eC5fYmF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgIGVuY29kaW5nLnByZWVuY29kZShzdGF0ZSwgbSkKICAgICAgICAgIHN0YXRlLmJ1ZmZlciA9IG11eC5fYWxsb2Moc3RhdGUuZW5kKQoKICAgICAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHR5cGUpCiAgICAgICAgICBlbmNvZGluZy5lbmNvZGUoc3RhdGUsIG0pCgogICAgICAgICAgbXV4Ll9wdXNoQmF0Y2goc2Vzc2lvbi5fbG9jYWxJZCwgc3RhdGUuYnVmZmVyKQogICAgICAgICAgcmV0dXJuIHRydWUKICAgICAgICB9CgogICAgICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHNlc3Npb24uX2xvY2FsSWQpCiAgICAgICAgZW5jb2RpbmcucHJlZW5jb2RlKHN0YXRlLCBtKQoKICAgICAgICBzdGF0ZS5idWZmZXIgPSBtdXguX2FsbG9jKHN0YXRlLmVuZCkKCiAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgc2Vzc2lvbi5fbG9jYWxJZCkKICAgICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB0eXBlKQogICAgICAgIGVuY29kaW5nLmVuY29kZShzdGF0ZSwgbSkKCiAgICAgICAgbXV4LmRyYWluZWQgPSBtdXguc3RyZWFtLndyaXRlKHN0YXRlLmJ1ZmZlcikKCiAgICAgICAgcmV0dXJuIG11eC5kcmFpbmVkCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLm1lc3NhZ2VzLnB1c2gobSkKCiAgICByZXR1cm4gbQogIH0KCiAgX3NraXBNZXNzYWdlICgpIHsKICAgIGNvbnN0IHR5cGUgPSB0aGlzLm1lc3NhZ2VzLmxlbmd0aAogICAgY29uc3QgbSA9IHsKICAgICAgdHlwZSwKICAgICAgZW5jb2Rpbmc6IGMucmF3LAogICAgICBvbm1lc3NhZ2U6IG5vb3AsCiAgICAgIHJlY3YgKHN0YXRlLCBzZXNzaW9uKSB7fSwKICAgICAgc2VuZCAobSwgc2Vzc2lvbikge30KICAgIH0KCiAgICB0aGlzLm1lc3NhZ2VzLnB1c2gobSkKICAgIHJldHVybiBtCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFByb3RvbXV4IHsKICBjb25zdHJ1Y3RvciAoc3RyZWFtLCB7IGFsbG9jIH0gPSB7fSkgewogICAgaWYgKHN0cmVhbS51c2VyRGF0YSA9PT0gbnVsbCkgc3RyZWFtLnVzZXJEYXRhID0gdGhpcwoKICAgIHRoaXMuaXNQcm90b211eCA9IHRydWUKICAgIHRoaXMuc3RyZWFtID0gc3RyZWFtCiAgICB0aGlzLmNvcmtlZCA9IDAKICAgIHRoaXMuZHJhaW5lZCA9IHRydWUKCiAgICB0aGlzLl9hbGxvYyA9IGFsbG9jIHx8ICh0eXBlb2Ygc3RyZWFtLmFsbG9jID09PSAnZnVuY3Rpb24nID8gc3RyZWFtLmFsbG9jLmJpbmQoc3RyZWFtKSA6IGI0YS5hbGxvY1Vuc2FmZSkKICAgIHRoaXMuX3NhZmVEZXN0cm95Qm91bmQgPSB0aGlzLl9zYWZlRGVzdHJveS5iaW5kKHRoaXMpCiAgICB0aGlzLl91bmNvcmtCb3VuZCA9IHRoaXMudW5jb3JrLmJpbmQodGhpcykKCiAgICB0aGlzLl9yZW1vdGVCYWNrbG9nID0gMAogICAgdGhpcy5fYnVmZmVyZWQgPSAwCiAgICB0aGlzLl9wYXVzZWQgPSBmYWxzZQogICAgdGhpcy5fcmVtb3RlID0gW10KICAgIHRoaXMuX2xvY2FsID0gW10KICAgIHRoaXMuX2ZyZWUgPSBbXQogICAgdGhpcy5fYmF0Y2ggPSBudWxsCiAgICB0aGlzLl9iYXRjaFN0YXRlID0gbnVsbAoKICAgIHRoaXMuX2luZm9zID0gbmV3IE1hcCgpCiAgICB0aGlzLl9ub3RpZnkgPSBuZXcgTWFwKCkKCiAgICB0aGlzLnN0cmVhbS5vbignZGF0YScsIHRoaXMuX29uZGF0YS5iaW5kKHRoaXMpKQogICAgdGhpcy5zdHJlYW0ub24oJ2RyYWluJywgdGhpcy5fb25kcmFpbi5iaW5kKHRoaXMpKQogICAgdGhpcy5zdHJlYW0ub24oJ2VuZCcsIHRoaXMuX29uZW5kLmJpbmQodGhpcykpCiAgICB0aGlzLnN0cmVhbS5vbignZXJyb3InLCBub29wKSAvLyB3ZSBoYW5kbGUgdGhpcyBpbiAiY2xvc2UiCiAgICB0aGlzLnN0cmVhbS5vbignY2xvc2UnLCB0aGlzLl9zaHV0ZG93bi5iaW5kKHRoaXMpKQogIH0KCiAgc3RhdGljIGZyb20gKHN0cmVhbSwgb3B0cykgewogICAgaWYgKHN0cmVhbS51c2VyRGF0YSAmJiBzdHJlYW0udXNlckRhdGEuaXNQcm90b211eCkgcmV0dXJuIHN0cmVhbS51c2VyRGF0YQogICAgaWYgKHN0cmVhbS5pc1Byb3RvbXV4KSByZXR1cm4gc3RyZWFtCiAgICByZXR1cm4gbmV3IHRoaXMoc3RyZWFtLCBvcHRzKQogIH0KCiAgc3RhdGljIGlzUHJvdG9tdXggKG11eCkgewogICAgcmV0dXJuIHR5cGVvZiBtdXggPT09ICdvYmplY3QnICYmIG11eC5pc1Byb3RvbXV4ID09PSB0cnVlCiAgfQoKICAqIFtTeW1ib2wuaXRlcmF0b3JdICgpIHsKICAgIGZvciAoY29uc3Qgc2Vzc2lvbiBvZiB0aGlzLl9sb2NhbCkgewogICAgICBpZiAoc2Vzc2lvbiAhPT0gbnVsbCkgeWllbGQgc2Vzc2lvbgogICAgfQogIH0KCiAgaXNJZGxlICgpIHsKICAgIHJldHVybiB0aGlzLl9sb2NhbC5sZW5ndGggPT09IHRoaXMuX2ZyZWUubGVuZ3RoCiAgfQoKICBjb3JrICgpIHsKICAgIGlmICgrK3RoaXMuY29ya2VkID09PSAxKSB7CiAgICAgIHRoaXMuX2JhdGNoID0gW10KICAgICAgdGhpcy5fYmF0Y2hTdGF0ZSA9IHsgYnVmZmVyOiBudWxsLCBzdGFydDogMCwgZW5kOiAxIH0KICAgIH0KICB9CgogIHVuY29yayAoKSB7CiAgICBpZiAoLS10aGlzLmNvcmtlZCA9PT0gMCkgewogICAgICB0aGlzLl9zZW5kQmF0Y2godGhpcy5fYmF0Y2gsIHRoaXMuX2JhdGNoU3RhdGUpCiAgICAgIHRoaXMuX2JhdGNoID0gbnVsbAogICAgICB0aGlzLl9iYXRjaFN0YXRlID0gbnVsbAogICAgfQogIH0KCiAgZ2V0TGFzdENoYW5uZWwgKHsgcHJvdG9jb2wsIGlkID0gbnVsbCB9KSB7CiAgICBjb25zdCBrZXkgPSB0b0tleShwcm90b2NvbCwgaWQpCiAgICBjb25zdCBpbmZvID0gdGhpcy5faW5mb3MuZ2V0KGtleSkKICAgIGlmIChpbmZvKSByZXR1cm4gaW5mby5sYXN0Q2hhbm5lbAogICAgcmV0dXJuIG51bGwKICB9CgogIHBhaXIgKHsgcHJvdG9jb2wsIGlkID0gbnVsbCB9LCBub3RpZnkpIHsKICAgIHRoaXMuX25vdGlmeS5zZXQodG9LZXkocHJvdG9jb2wsIGlkKSwgbm90aWZ5KQogIH0KCiAgdW5wYWlyICh7IHByb3RvY29sLCBpZCA9IG51bGwgfSkgewogICAgdGhpcy5fbm90aWZ5LmRlbGV0ZSh0b0tleShwcm90b2NvbCwgaWQpKQogIH0KCiAgb3BlbmVkICh7IHByb3RvY29sLCBpZCA9IG51bGwgfSkgewogICAgY29uc3Qga2V5ID0gdG9LZXkocHJvdG9jb2wsIGlkKQogICAgY29uc3QgaW5mbyA9IHRoaXMuX2luZm9zLmdldChrZXkpCiAgICByZXR1cm4gaW5mbyA/IGluZm8ub3BlbmVkID4gMCA6IGZhbHNlCiAgfQoKICBjcmVhdGVDaGFubmVsICh7IHVzZXJEYXRhID0gbnVsbCwgcHJvdG9jb2wsIGFsaWFzZXMgPSBbXSwgaWQgPSBudWxsLCB1bmlxdWUgPSB0cnVlLCBoYW5kc2hha2UgPSBudWxsLCBtZXNzYWdlcyA9IFtdLCBvbm9wZW4gPSBub29wLCBvbmNsb3NlID0gbm9vcCwgb25kZXN0cm95ID0gbm9vcCwgb25kcmFpbiA9IG5vb3AgfSkgewogICAgaWYgKHRoaXMuc3RyZWFtLmRlc3Ryb3llZCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBpbmZvID0gdGhpcy5fZ2V0KHByb3RvY29sLCBpZCwgYWxpYXNlcykKICAgIGlmICh1bmlxdWUgJiYgaW5mby5vcGVuZWQgPiAwKSByZXR1cm4gbnVsbAoKICAgIGlmIChpbmZvLmluY29taW5nLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gbmV3IENoYW5uZWwodGhpcywgaW5mbywgdXNlckRhdGEsIHByb3RvY29sLCBhbGlhc2VzLCBpZCwgaGFuZHNoYWtlLCBtZXNzYWdlcywgb25vcGVuLCBvbmNsb3NlLCBvbmRlc3Ryb3ksIG9uZHJhaW4pCiAgICB9CgogICAgdGhpcy5fcmVtb3RlQmFja2xvZy0tCgogICAgY29uc3QgcmVtb3RlSWQgPSBpbmZvLmluY29taW5nLnNoaWZ0KCkKICAgIGNvbnN0IHIgPSB0aGlzLl9yZW1vdGVbcmVtb3RlSWQgLSAxXQogICAgaWYgKHIgPT09IG51bGwpIHJldHVybiBudWxsCgogICAgY29uc3Qgc2Vzc2lvbiA9IG5ldyBDaGFubmVsKHRoaXMsIGluZm8sIHVzZXJEYXRhLCBwcm90b2NvbCwgYWxpYXNlcywgaWQsIGhhbmRzaGFrZSwgbWVzc2FnZXMsIG9ub3Blbiwgb25jbG9zZSwgb25kZXN0cm95LCBvbmRyYWluKQoKICAgIHNlc3Npb24uX3JlbW90ZUlkID0gcmVtb3RlSWQKICAgIHNlc3Npb24uX2Z1bGx5T3BlblNvb24oKQoKICAgIHJldHVybiBzZXNzaW9uCiAgfQoKICBfcHVzaEJhdGNoIChsb2NhbElkLCBidWZmZXIpIHsKICAgIGlmICh0aGlzLl9iYXRjaFN0YXRlLmVuZCA+PSBNQVhfQkFUQ0gpIHsKICAgICAgdGhpcy5fc2VuZEJhdGNoKHRoaXMuX2JhdGNoLCB0aGlzLl9iYXRjaFN0YXRlKQogICAgICB0aGlzLl9iYXRjaCA9IFtdCiAgICAgIHRoaXMuX2JhdGNoU3RhdGUgPSB7IGJ1ZmZlcjogbnVsbCwgc3RhcnQ6IDAsIGVuZDogMSB9CiAgICB9CgogICAgaWYgKHRoaXMuX2JhdGNoLmxlbmd0aCA9PT0gMCB8fCB0aGlzLl9iYXRjaFt0aGlzLl9iYXRjaC5sZW5ndGggLSAxXS5sb2NhbElkICE9PSBsb2NhbElkKSB7CiAgICAgIHRoaXMuX2JhdGNoU3RhdGUuZW5kKysKICAgICAgYy51aW50LnByZWVuY29kZSh0aGlzLl9iYXRjaFN0YXRlLCBsb2NhbElkKQogICAgfQogICAgYy5idWZmZXIucHJlZW5jb2RlKHRoaXMuX2JhdGNoU3RhdGUsIGJ1ZmZlcikKICAgIHRoaXMuX2JhdGNoLnB1c2goeyBsb2NhbElkLCBidWZmZXIgfSkKICB9CgogIF9zZW5kQmF0Y2ggKGJhdGNoLCBzdGF0ZSkgewogICAgaWYgKGJhdGNoLmxlbmd0aCA9PT0gMCkgcmV0dXJuCgogICAgbGV0IHByZXYgPSBiYXRjaFswXS5sb2NhbElkCgogICAgc3RhdGUuYnVmZmVyID0gdGhpcy5fYWxsb2Moc3RhdGUuZW5kKQogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMAogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMAoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHByZXYpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBiYXRjaC5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBiID0gYmF0Y2hbaV0KICAgICAgaWYgKHByZXYgIT09IGIubG9jYWxJZCkgewogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDAKICAgICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAocHJldiA9IGIubG9jYWxJZCkpCiAgICAgIH0KICAgICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBiLmJ1ZmZlcikKICAgIH0KCiAgICB0aGlzLmRyYWluZWQgPSB0aGlzLnN0cmVhbS53cml0ZShzdGF0ZS5idWZmZXIpCiAgfQoKICBfZ2V0IChwcm90b2NvbCwgaWQsIGFsaWFzZXMgPSBbXSkgewogICAgY29uc3Qga2V5ID0gdG9LZXkocHJvdG9jb2wsIGlkKQoKICAgIGxldCBpbmZvID0gdGhpcy5faW5mb3MuZ2V0KGtleSkKICAgIGlmIChpbmZvKSByZXR1cm4gaW5mbwoKICAgIGluZm8gPSB7IGtleSwgcHJvdG9jb2wsIGFsaWFzZXM6IFtdLCBpZCwgcGFpcmluZzogMCwgb3BlbmVkOiAwLCBpbmNvbWluZzogW10sIG91dGdvaW5nOiBbXSwgbGFzdENoYW5uZWw6IG51bGwgfQogICAgdGhpcy5faW5mb3Muc2V0KGtleSwgaW5mbykKCiAgICBmb3IgKGNvbnN0IGFsaWFzIG9mIGFsaWFzZXMpIHsKICAgICAgY29uc3Qga2V5ID0gdG9LZXkoYWxpYXMsIGlkKQogICAgICBpbmZvLmFsaWFzZXMucHVzaChrZXkpCgogICAgICB0aGlzLl9pbmZvcy5zZXQoa2V5LCBpbmZvKQogICAgfQoKICAgIHJldHVybiBpbmZvCiAgfQoKICBfZ2MgKGluZm8pIHsKICAgIGlmIChpbmZvLm9wZW5lZCA9PT0gMCAmJiBpbmZvLm91dGdvaW5nLmxlbmd0aCA9PT0gMCAmJiBpbmZvLmluY29taW5nLmxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLl9pbmZvcy5kZWxldGUoaW5mby5rZXkpCgogICAgICBmb3IgKGNvbnN0IGFsaWFzIG9mIGluZm8u","YWxpYXNlcykgdGhpcy5faW5mb3MuZGVsZXRlKGFsaWFzKQogICAgfQogIH0KCiAgX29uZGF0YSAoYnVmZmVyKSB7CiAgICBpZiAoYnVmZmVyLmJ5dGVMZW5ndGggPT09IDApIHJldHVybiAvLyBpZ25vcmUgZW1wdHkgZnJhbWVzLi4uCiAgICB0cnkgewogICAgICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyLCBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCB9CiAgICAgIHRoaXMuX2RlY29kZShjLnVpbnQuZGVjb2RlKHN0YXRlKSwgc3RhdGUpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5fc2FmZURlc3Ryb3koZXJyKQogICAgfQogIH0KCiAgX29uZHJhaW4gKCkgewogICAgdGhpcy5kcmFpbmVkID0gdHJ1ZQoKICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLl9sb2NhbCkgewogICAgICBpZiAocyAhPT0gbnVsbCkgcy5fdHJhY2socy5vbmRyYWluKHMpKQogICAgfQogIH0KCiAgX29uZW5kICgpIHsgLy8gVE9ETzogc3VwcG9ydCBoYWxmIG9wZW4gbW9kZSBmb3IgdGhlIHVzZXJzIHdobyB3YW50cyB0aGF0IGhlcmUKICAgIHRoaXMuc3RyZWFtLmVuZCgpCiAgfQoKICBfZGVjb2RlIChyZW1vdGVJZCwgc3RhdGUpIHsKICAgIGNvbnN0IHR5cGUgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmIChyZW1vdGVJZCA9PT0gMCkgewogICAgICByZXR1cm4gdGhpcy5fb25jb250cm9sc2Vzc2lvbih0eXBlLCBzdGF0ZSkKICAgIH0KCiAgICBjb25zdCByID0gcmVtb3RlSWQgPD0gdGhpcy5fcmVtb3RlLmxlbmd0aCA/IHRoaXMuX3JlbW90ZVtyZW1vdGVJZCAtIDFdIDogbnVsbAoKICAgIC8vIGlmIHRoZSBjaGFubmVsIGlzIGNsb3NlZCBpZ25vcmUgLSBjb3VsZCBqdXN0IGJlIGEgcGlwZWxpbmUgbWVzc2FnZS4uLgogICAgaWYgKHIgPT09IG51bGwpIHJldHVybiBudWxsCgogICAgaWYgKHIucGVuZGluZyAhPT0gbnVsbCkgewogICAgICB0aGlzLl9idWZmZXJNZXNzYWdlKHIsIHR5cGUsIHN0YXRlKQogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIHJldHVybiByLnNlc3Npb24uX3JlY3YodHlwZSwgc3RhdGUpCiAgfQoKICBfb25jb250cm9sc2Vzc2lvbiAodHlwZSwgc3RhdGUpIHsKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fb25iYXRjaChzdGF0ZSkKICAgICAgICBicmVhawoKICAgICAgY2FzZSAxOgogICAgICAgIC8vIHJldHVybiB0aGUgcHJvbWlzZSBiYWNrIHVwIGFzIHRoaXMgaGFzIHNpZGVlZmZlY3RzIHNvIHdlIGNhbiBiYXRjaCByZXBseQogICAgICAgIHJldHVybiB0aGlzLl9vbm9wZW5zZXNzaW9uKHN0YXRlKQoKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX29ucmVqZWN0c2Vzc2lvbihzdGF0ZSkKICAgICAgICBicmVhawoKICAgICAgY2FzZSAzOgogICAgICAgIHRoaXMuX29uY2xvc2VzZXNzaW9uKHN0YXRlKQogICAgICAgIGJyZWFrCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIF9idWZmZXJNZXNzYWdlIChyLCB0eXBlLCB7IGJ1ZmZlciwgc3RhcnQsIGVuZCB9KSB7CiAgICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyLCBzdGFydCwgZW5kIH0gLy8gY29weQogICAgci5wZW5kaW5nLnB1c2goeyB0eXBlLCBzdGF0ZSB9KQogICAgdGhpcy5fYnVmZmVyZWQgKz0gYnl0ZVNpemUoc3RhdGUpCiAgICB0aGlzLl9wYXVzZU1heWJlKCkKICB9CgogIF9wYXVzZU1heWJlICgpIHsKICAgIGlmICh0aGlzLl9wYXVzZWQgPT09IHRydWUgfHwgdGhpcy5fYnVmZmVyZWQgPD0gTUFYX0JVRkZFUkVEKSByZXR1cm4KICAgIHRoaXMuX3BhdXNlZCA9IHRydWUKICAgIHRoaXMuc3RyZWFtLnBhdXNlKCkKICB9CgogIF9yZXN1bWVNYXliZSAoKSB7CiAgICBpZiAodGhpcy5fcGF1c2VkID09PSBmYWxzZSB8fCB0aGlzLl9idWZmZXJlZCA+IE1BWF9CVUZGRVJFRCkgcmV0dXJuCiAgICB0aGlzLl9wYXVzZWQgPSBmYWxzZQogICAgdGhpcy5zdHJlYW0ucmVzdW1lKCkKICB9CgogIF9vbmJhdGNoIChzdGF0ZSkgewogICAgY29uc3QgZW5kID0gc3RhdGUuZW5kCiAgICBsZXQgcmVtb3RlSWQgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGxldCB3YWl0aW5nID0gbnVsbAoKICAgIHdoaWxlIChzdGF0ZS5lbmQgPiBzdGF0ZS5zdGFydCkgewogICAgICBjb25zdCBsZW4gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgICBpZiAobGVuID09PSAwKSB7CiAgICAgICAgcmVtb3RlSWQgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KICAgICAgc3RhdGUuZW5kID0gc3RhdGUuc3RhcnQgKyBsZW4KICAgICAgLy8gaWYgYmF0Y2ggY29udGFpbnMgbW9yZSB0aGFuIG9uZSBtZXNzYWdlLCBjb3JrIGl0IHNvIHdlIHJlcGx5IGJhY2sgd2l0aCBhIGJhdGNoCiAgICAgIGlmIChlbmQgIT09IHN0YXRlLmVuZCAmJiB3YWl0aW5nID09PSBudWxsKSB7CiAgICAgICAgd2FpdGluZyA9IFtdCiAgICAgICAgdGhpcy5jb3JrKCkKICAgICAgfQogICAgICBjb25zdCBwID0gdGhpcy5fZGVjb2RlKHJlbW90ZUlkLCBzdGF0ZSkKICAgICAgaWYgKHdhaXRpbmcgIT09IG51bGwgJiYgcCAhPT0gbnVsbCkgd2FpdGluZy5wdXNoKHApCiAgICAgIHN0YXRlLnN0YXJ0ID0gc3RhdGUuZW5kCiAgICAgIHN0YXRlLmVuZCA9IGVuZAogICAgfQoKICAgIGlmICh3YWl0aW5nICE9PSBudWxsKSB7CiAgICAgIC8vIHRoZSB3YWl0aW5nIHByb21pc2VzIGFyZSBub3QgYWxsb3dlZCB0byB0aHJvdyBidXQgd2UgZGVzdHJveSB0aGUgc3RyZWFtIGluIGNhc2Ugd2UgYXJlIHdyb25nCiAgICAgIFByb21pc2UuYWxsKHdhaXRpbmcpLnRoZW4odGhpcy5fdW5jb3JrQm91bmQsIHRoaXMuX3NhZmVEZXN0cm95Qm91bmQpCiAgICB9CiAgfQoKICBfb25vcGVuc2Vzc2lvbiAoc3RhdGUpIHsKICAgIGNvbnN0IHJlbW90ZUlkID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHByb3RvY29sID0gYy5zdHJpbmcuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgaWQgPSB1bnNsYWIoYy5idWZmZXIuZGVjb2RlKHN0YXRlKSkKCiAgICAvLyByZW1vdGUgdHJpZWQgdG8gb3BlbiB0aGUgY29udHJvbCBzZXNzaW9uIC0gYXV0byByZWplY3QgZm9yIG5vdwogICAgLy8gYXMgd2UgY2FuIHVzZSBhcyBhbiBleHBsaWNpdCBjb250cm9sIHByb3RvY29sIGRlY2xhcmF0aW9uIGlmIHdlIG5lZWQgdG8KICAgIGlmIChyZW1vdGVJZCA9PT0gMCkgewogICAgICB0aGlzLl9yZWplY3RTZXNzaW9uKDApCiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgY29uc3QgcmlkID0gcmVtb3RlSWQgLSAxCiAgICBjb25zdCBpbmZvID0gdGhpcy5fZ2V0KHByb3RvY29sLCBpZCkKCiAgICAvLyBhbGxvdyB0aGUgcmVtb3RlIHRvIGdyb3cgdGhlIGlkcyBieSBvbmUKICAgIGlmICh0aGlzLl9yZW1vdGUubGVuZ3RoID09PSByaWQpIHsKICAgICAgdGhpcy5fcmVtb3RlLnB1c2gobnVsbCkKICAgIH0KCiAgICBpZiAocmlkID49IHRoaXMuX3JlbW90ZS5sZW5ndGggfHwgdGhpcy5fcmVtb3RlW3JpZF0gIT09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIG9wZW4gbWVzc2FnZScpCiAgICB9CgogICAgaWYgKGluZm8ub3V0Z29pbmcubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBsb2NhbElkID0gaW5mby5vdXRnb2luZy5zaGlmdCgpCiAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLl9sb2NhbFtsb2NhbElkIC0gMV0KCiAgICAgIGlmIChzZXNzaW9uID09PSBudWxsKSB7IC8vIHdlIGFscmVhZHkgY2xvc2VkIHRoZSBjaGFubmVsIC0gaWdub3JlCiAgICAgICAgdGhpcy5fZnJlZS5wdXNoKGxvY2FsSWQgLSAxKQogICAgICAgIHJldHVybiBudWxsCiAgICAgIH0KCiAgICAgIHRoaXMuX3JlbW90ZVtyaWRdID0geyBzdGF0ZSwgcGVuZGluZzogbnVsbCwgc2Vzc2lvbjogbnVsbCB9CgogICAgICBzZXNzaW9uLl9yZW1vdGVJZCA9IHJlbW90ZUlkCiAgICAgIHNlc3Npb24uX2Z1bGx5T3BlbigpCiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgY29uc3QgY29weVN0YXRlID0geyBidWZmZXI6IHN0YXRlLmJ1ZmZlciwgc3RhcnQ6IHN0YXRlLnN0YXJ0LCBlbmQ6IHN0YXRlLmVuZCB9CiAgICB0aGlzLl9yZW1vdGVbcmlkXSA9IHsgc3RhdGU6IGNvcHlTdGF0ZSwgcGVuZGluZzogW10sIHNlc3Npb246IG51bGwgfQoKICAgIGlmICgrK3RoaXMuX3JlbW90ZUJhY2tsb2cgPiBNQVhfQkFDS0xPRykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlbW90ZSBleGNlZWRlZCBiYWNrbG9nJykKICAgIH0KCiAgICBpbmZvLnBhaXJpbmcrKwogICAgaW5mby5pbmNvbWluZy5wdXNoKHJlbW90ZUlkKQoKICAgIHJldHVybiB0aGlzLl9yZXF1ZXN0U2Vzc2lvbihwcm90b2NvbCwgaWQsIGluZm8pLmNhdGNoKHRoaXMuX3NhZmVEZXN0cm95Qm91bmQpCiAgfQoKICBfb25yZWplY3RzZXNzaW9uIChzdGF0ZSkgewogICAgY29uc3QgbG9jYWxJZCA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgLy8gVE9ETzogY2FuIGJlIGRvbmUgc21hcnRlci4uLgogICAgZm9yIChjb25zdCBpbmZvIG9mIHRoaXMuX2luZm9zLnZhbHVlcygpKSB7CiAgICAgIGNvbnN0IGkgPSBpbmZvLm91dGdvaW5nLmluZGV4T2YobG9jYWxJZCkKICAgICAgaWYgKGkgPT09IC0xKSBjb250aW51ZQoKICAgICAgaW5mby5vdXRnb2luZy5zcGxpY2UoaSwgMSkKCiAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLl9sb2NhbFtsb2NhbElkIC0gMV0KCiAgICAgIHRoaXMuX2ZyZWUucHVzaChsb2NhbElkIC0gMSkKICAgICAgaWYgKHNlc3Npb24gIT09IG51bGwpIHNlc3Npb24uX2Nsb3NlKHRydWUpCgogICAgICB0aGlzLl9nYyhpbmZvKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgcmVqZWN0IG1lc3NhZ2UnKQogIH0KCiAgX29uY2xvc2VzZXNzaW9uIChzdGF0ZSkgewogICAgY29uc3QgcmVtb3RlSWQgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmIChyZW1vdGVJZCA9PT0gMCkgcmV0dXJuIC8vIGlnbm9yZQoKICAgIGNvbnN0IHJpZCA9IHJlbW90ZUlkIC0gMQogICAgY29uc3QgciA9IHJpZCA8IHRoaXMuX3JlbW90ZS5sZW5ndGggPyB0aGlzLl9yZW1vdGVbcmlkXSA6IG51bGwKCiAgICBpZiAociA9PT0gbnVsbCkgcmV0dXJuCgogICAgaWYgKHIuc2Vzc2lvbiAhPT0gbnVsbCkgci5zZXNzaW9uLl9jbG9zZSh0cnVlKQogIH0KCiAgYXN5bmMgX3JlcXVlc3RTZXNzaW9uIChwcm90b2NvbCwgaWQsIGluZm8pIHsKICAgIGNvbnN0IG5vdGlmeSA9IHRoaXMuX25vdGlmeS5nZXQodG9LZXkocHJvdG9jb2wsIGlkKSkgfHwgdGhpcy5fbm90aWZ5LmdldCh0b0tleShwcm90b2NvbCwgbnVsbCkpCgogICAgaWYgKG5vdGlmeSkgYXdhaXQgbm90aWZ5KGlkKQoKICAgIGlmICgtLWluZm8ucGFpcmluZyA+IDApIHJldHVybgoKICAgIHdoaWxlIChpbmZvLmluY29taW5nLmxlbmd0aCA+IDApIHsKICAgICAgdGhpcy5fcmVqZWN0U2Vzc2lvbihpbmZvLCBpbmZvLmluY29taW5nLnNoaWZ0KCkpCiAgICB9CgogICAgdGhpcy5fZ2MoaW5mbykKICB9CgogIF9yZWplY3RTZXNzaW9uIChpbmZvLCByZW1vdGVJZCkgewogICAgaWYgKHJlbW90ZUlkID4gMCkgewogICAgICBjb25zdCByID0gdGhpcy5fcmVtb3RlW3JlbW90ZUlkIC0gMV0KCiAgICAgIGlmIChyLnBlbmRpbmcgIT09IG51bGwpIHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHIucGVuZGluZy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdGhpcy5fYnVmZmVyZWQgLT0gYnl0ZVNpemUoci5wZW5kaW5nW2ldLnN0YXRlKQogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5fcmVtb3RlW3JlbW90ZUlkIC0gMV0gPSBudWxsCiAgICAgIHRoaXMuX3Jlc3VtZU1heWJlKCkKICAgIH0KCiAgICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyOiBudWxsLCBzdGFydDogMiwgZW5kOiAyIH0KCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCByZW1vdGVJZCkKCiAgICBzdGF0ZS5idWZmZXIgPSB0aGlzLl9hbGxvYyhzdGF0ZS5lbmQpCgogICAgc3RhdGUuYnVmZmVyWzBdID0gMAogICAgc3RhdGUuYnVmZmVyWzFdID0gMgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgcmVtb3RlSWQpCgogICAgdGhpcy5fd3JpdGUwKHN0YXRlLmJ1ZmZlcikKICB9CgogIF93cml0ZTAgKGJ1ZmZlcikgewogICAgaWYgKHRoaXMuX2JhdGNoICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX3B1c2hCYXRjaCgwLCBidWZmZXIuc3ViYXJyYXkoMSkpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuZHJhaW5lZCA9IHRoaXMuc3RyZWFtLndyaXRlKGJ1ZmZlcikKICB9CgogIGRlc3Ryb3kgKGVycikgewogICAgdGhpcy5zdHJlYW0uZGVzdHJveShlcnIpCiAgfQoKICBfc2FmZURlc3Ryb3kgKGVycikgewogICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgdGhpcy5zdHJlYW0uZGVzdHJveShlcnIpCiAgfQoKICBfc2h1dGRvd24gKCkgewogICAgZm9yIChjb25zdCBzIG9mIHRoaXMuX2xvY2FsKSB7CiAgICAgIGlmIChzICE9PSBudWxsKSBzLl9jbG9zZSh0cnVlKQogICAgfQogIH0KfQoKZnVuY3Rpb24gbm9vcCAoKSB7fQoKZnVuY3Rpb24gdG9LZXkgKHByb3RvY29sLCBpZCkgewogIHJldHVybiBwcm90b2NvbCArICcjIycgKyAoaWQgPyBiNGEudG9TdHJpbmcoaWQsICdoZXgnKSA6ICcnKQp9CgpmdW5jdGlvbiBieXRlU2l6ZSAoc3RhdGUpIHsKICByZXR1cm4gNTEyICsgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0KQp9CgpmdW5jdGlvbiBpc1Byb21pc2UgKHApIHsKICByZXR1cm4gISEocCAmJiB0eXBlb2YgcC50aGVuID09PSAnZnVuY3Rpb24nKQp9CgpmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAoZW5jLCB2YWwpIHsKICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyOiBudWxsLCBzdGFydDogMCwgZW5kOiAwIH0KICBlbmMucHJlZW5jb2RlKHN0YXRlLCB2YWwpCiAgcmV0dXJuIHN0YXRlLmVuZAp9CnsKICAibmFtZSI6ICJwcm90b211eCIsCiAgInZlcnNpb24iOiAiMy4xMC4xIiwKICAiZGVzY3JpcHRpb24iOiAiTXVsdGlwbGV4IG11bHRpcGxlIG1lc3NhZ2Ugb3JpZW50ZWQgcHJvdG9jb2xzIG92ZXIgYSBzdHJlYW0iLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS4zLjEiLAogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuNS4xIiwKICAgICJxdWV1ZS10aWNrIjogIl4xLjAuMCIsCiAgICAic2FmZXR5LWNhdGNoIjogIl4xLjAuMSIsCiAgICAidW5zbGFiIjogIl4xLjMuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbSI6ICJeNi4wLjAiLAogICAgImJyaXR0bGUiOiAiXjMuMC4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTYuMC40IgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcHJvdG9tdXguZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3Byb3RvbXV4L2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3Byb3RvbXV4Igp9CnsKICAibmFtZSI6ICJxdWV1ZS10aWNrIiwKICAidmVyc2lvbiI6ICIxLjAuMSIsCiAgImRlc2NyaXB0aW9uIjogIk5leHQgdGljayBzaGltIHRoYXQgcHJlZmVycyBwcm9jZXNzLm5leHRUaWNrIG92ZXIgcXVldWVNaWNyb3Rhc2sgZm9yIGNvbXBhdCIsCiAgIm1haW4iOiAiLi9wcm9jZXNzLW5leHQtdGljay5qcyIsCiAgImJyb3dzZXIiOiAiLi9xdWV1ZS1taWNyb3Rhc2suanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xNi4wLjMiLAogICAgInRhcGUiOiAiXjUuMy4xIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiB0YXBlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcXVldWUtdGljay5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcXVldWUtdGljay9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9xdWV1ZS10aWNrIgp9Cm1vZHVsZS5leHBvcnRzID0gKHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgcHJvY2Vzcy5uZXh0VGljayA9PT0gJ2Z1bmN0aW9uJykKICA/IHByb2Nlc3MubmV4dFRpY2suYmluZChwcm9jZXNzKQogIDogcmVxdWlyZSgnLi9xdWV1ZS1taWNyb3Rhc2snKQptb2R1bGUuZXhwb3J0cyA9IHR5cGVvZiBxdWV1ZU1pY3JvdGFzayA9PT0gJ2Z1bmN0aW9uJyA/IHF1ZXVlTWljcm90YXNrIDogKGZuKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZuKQpyZXF1aXJlLmFkZG9uID0gcmVxdWlyZSgncmVxdWlyZS1hZGRvbicpCgptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUuYWRkb24oJy4nLCBfX2ZpbGVuYW1lKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi9iaW5kaW5nJykKCmV4cG9ydHMuZ2V0ID0gZnVuY3Rpb24gZ2V0KGZpZWxkLCBiaXQpIHsKICBjb25zdCBuID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgaWYgKGJpdCA8IDApIGJpdCArPSBuCiAgaWYgKGJpdCA8IDAgfHwgYml0ID49IG4pIHJldHVybiBmYWxzZQoKICByZXR1cm4gYmluZGluZy5xdWlja2JpdF9uYXBpX2dldCh0b0J1ZmZlcihmaWVsZCksIGJpdCkgIT09IDAKfQoKZXhwb3J0cy5zZXQgPSBmdW5jdGlvbiBzZXQoZmllbGQsIGJpdCwgdmFsdWUgPSB0cnVlKSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogIGlmIChiaXQgPCAwKSBiaXQgKz0gbgogIGlmIChiaXQgPCAwIHx8IGJpdCA+PSBuKSByZXR1cm4gZmFsc2UKCiAgcmV0dXJuIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9zZXQodG9CdWZmZXIoZmllbGQpLCBiaXQsIHZhbHVlID8gMSA6IDApICE9PSAwCn0KCmV4cG9ydHMuZmlsbCA9IGZ1bmN0aW9uIGZpbGwoCiAgZmllbGQsCiAgdmFsdWUsCiAgc3RhcnQgPSAwLAogIGVuZCA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CikgewogIGNvbnN0IG4gPSBmaWVsZC5ieXRlTGVuZ3RoICogOAoKICBpZiAoc3RhcnQgPCAwKSBzdGFydCArPSBuCiAgaWYgKGVuZCA8IDApIGVuZCArPSBuCiAgaWYgKHN0YXJ0IDwgMCB8fCBzdGFydCA+PSBmaWVsZC5ieXRlTGVuZ3RoICogOCB8fCBzdGFydCA+PSBlbmQpIHJldHVybiBmaWVsZAoKICBiaW5kaW5nLnF1aWNrYml0X25hcGlfZmlsbCh0b0J1ZmZlcihmaWVsZCksIHZhbHVlID8gMSA6IDAsIHN0YXJ0LCBlbmQpCiAgcmV0dXJuIGZpZWxkCn0KCmV4cG9ydHMuY2xlYXIgPSBmdW5jdGlvbiBjbGVhcihmaWVsZCwgLi4uY2h1bmtzKSB7CiAgYmluZGluZy5xdWlja2JpdF9uYXBpX2NsZWFyKHRvQnVmZmVyKGZpZWxkKSwgY2h1bmtzLm1hcCh0b0J1ZmZlckNodW5rKSkKfQoKZXhwb3J0cy5maW5kRmlyc3QgPSBmdW5jdGlvbiBmaW5kRmlyc3QoZmllbGQsIHZhbHVlLCBwb3NpdGlvbiA9IDApIHsKICBjb25zdCBuID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gKz0gbgogIGlmIChwb3NpdGlvbiA8IDApIHBvc2l0aW9uID0gMAogIGlmIChwb3NpdGlvbiA+PSBuKSByZXR1cm4gLTEKCiAgcmV0dXJuIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9maW5kX2ZpcnN0KAogICAgdG9CdWZmZXIoZmllbGQpLAogICAgdmFsdWUgPyAxIDogMCwKICAgIHBvc2l0aW9uCiAgKQp9CgpleHBvcnRzLmZpbmRMYXN0ID0gZnVuY3Rpb24gZmluZExhc3QoCiAgZmllbGQsCiAgdmFsdWUsCiAgcG9zaXRpb24gPSBmaWVsZC5ieXRlTGVuZ3RoICogOCAtIDEKKSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogIGlmIChwb3NpdGlvbiA8IDApIHBvc2l0aW9uICs9IG4KICBpZiAocG9zaXRpb24gPCAwKSByZXR1cm4gLTEKICBpZiAocG9zaXRpb24gPj0gbikgcG9zaXRpb24gPSBuIC0gMQoKICByZXR1cm4gYmluZGluZy5xdWlja2JpdF9uYXBpX2ZpbmRfbGFzdCgKICAgIHRvQnVmZmVyKGZpZWxkKSwKICAgIHZhbHVlID8gMSA6IDAsCiAgICBwb3NpdGlvbgogICkKfQoKZnVuY3Rpb24gdG9CdWZmZXIoZmllbGQpIHsKICBpZiAoZmllbGQuQllURVNfUEVSX0VMRU1FTlQgPT09IDEpIHJldHVybiBmaWVsZAogIHJldHVybiBuZXcgVWludDhBcnJheShmaWVsZC5idWZmZXIsIGZpZWxkLmJ5dGVPZmZzZXQsIGZpZWxkLmJ5dGVMZW5ndGgpCn0KCmZ1bmN0aW9uIHRvQnVmZmVyQ2h1bmsoY2h1bmspIHsKICByZXR1cm4geyBmaWVsZDogdG9CdWZmZXIoY2h1bmsuZmllbGQpLCBvZmZzZXQ6IGNodW5rLm9mZnNldCB9Cn0KCmNsYXNzIEluZGV4IHsKICBzdGF0aWMgZnJvbShmaWVsZE9yQ2h1bmtzLCBieXRlTGVuZ3RoID0gLTEpIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGZpZWxkT3JDaHVua3MpKSB7CiAgICAgIHJldHVybiBuZXcgU3BhcnNlSW5kZXgoZmllbGRPckNodW5rcywgYnl0ZUxlbmd0aCkKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgRGVuc2VJbmRleChmaWVsZE9yQ2h1bmtzLCBieXRlTGVuZ3RoKQogICAgfQogIH0KCiAgY29uc3RydWN0b3IoYnl0ZUxlbmd0aCkgewogICAgdGhpcy5fYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGgKICAgIHRoaXMuaGFuZGxlID0gQnVmZmVyLmFsbG9jVW5zYWZlKGJpbmRpbmcuc2l6ZW9mX3F1aWNrYml0X2luZGV4X3QpCiAgfQoKICBnZXQgYnl0ZUxlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLl9ieXRlTGVuZ3RoCiAgfQoKICBza2lwRmlyc3QodmFsdWUsIHBvc2l0aW9uID0gMCkgewogICAgY29uc3QgbiA9IHRoaXMuYnl0ZUxlbmd0aCAqIDgKCiAgICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiArPSBuCiAgICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiA9IDAKICAgIGlmIChwb3NpdGlvbiA+PSBuKSByZXR1cm4gbiAtIDEKCiAgICByZXR1cm4gYmluZGluZy5xdWlja2JpdF9uYXBpX3NraXBfZmlyc3QoCiAgICAgIHRoaXMuaGFuZGxlLAogICAgICB0aGlzLmJ5dGVMZW5ndGgsCiAgICAgIHZhbHVlID8gMSA6IDAsCiAgICAgIHBvc2l0aW9uCiAgICApCiAgfQoKICBza2lwTGFzdCh2YWx1ZSwgcG9zaXRpb24gPSB0aGlzLmJ5dGVMZW5ndGggKiA4IC0gMSkgewogICAgY29uc3QgbiA9IHRoaXMuYnl0ZUxlbmd0aCAqIDgKCiAgICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiArPSBuCiAgICBpZiAocG9zaXRpb24gPCAwKSByZXR1cm4gMAogICAgaWYgKHBvc2l0aW9uID49IG4pIHBvc2l0aW9uID0gbiAtIDEKCiAgICByZXR1cm4gYmluZGluZy5xdWlja2JpdF9uYXBpX3NraXBfbGFzdCgKICAgICAgdGhpcy5oYW5kbGUsCiAgICAgIHRoaXMuYnl0ZUxlbmd0aCwKICAgICAgdmFsdWUgPyAxIDogMCwKICAgICAgcG9zaXRpb24KICAgICkKICB9Cn0KCmV4cG9ydHMuSW5kZXggPSBJbmRleAoKY2xhc3MgRGVuc2VJbmRleCBleHRlbmRzIEluZGV4IHsKICBjb25zdHJ1Y3RvcihmaWVsZCwgYnl0ZUxlbmd0aCkgewogICAgc3VwZXIoYnl0ZUxlbmd0aCkKICAgIHRoaXMuZmllbGQgPSBmaWVsZAoKICAgIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9pbmRleF9pbml0KHRoaXMuaGFuZGxlLCB0b0J1ZmZlcih0aGlzLmZpZWxkKSkKICB9CgogIGdldCBieXRlTGVuZ3RoKCkgewogICAgaWYgKHRoaXMuX2J5dGVMZW5ndGggIT09IC0xKSByZXR1cm4gdGhpcy5fYnl0ZUxlbmd0aAogICAgcmV0dXJuIHRoaXMuZmllbGQuYnl0ZUxlbmd0aAogIH0KCiAgdXBkYXRlKGJpdCkgewogICAgY29uc3QgbiA9IHRoaXMuYnl0ZUxlbmd0aCAqIDgKCiAgICBpZiAoYml0IDwgMCkgYml0ICs9IG4KICAgIGlmIChiaXQgPCAwIHx8IGJpdCA+PSBuKSByZXR1cm4gZmFsc2UKCiAgICByZXR1cm4gKAogICAgICBiaW5kaW5nLnF1aWNrYml0X25hcGlfaW5kZXhfdXBkYXRlKAogICAgICAgIHRoaXMuaGFuZGxlLAogICAgICAgIHRvQnVmZmVyKHRoaXMuZmllbGQpLAogICAgICAgIGJpdAogICAgICApICE9PSAwCiAgICApCiAgfQp9CgpmdW5jdGlvbiBzZWxlY3RDaHVuayhjaHVua3MsIG9mZnNldCkgewogIGZvciAobGV0IGkgPSAwOyBpIDwgY2h1bmtzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBuZXh0ID0gY2h1bmtzW2ldCgogICAgY29uc3Qgc3RhcnQgPSBuZXh0Lm9mZnNldAogICAgY29uc3QgZW5kID0gbmV4dC5vZmZzZXQgKyBuZXh0LmZpZWxkLmJ5dGVMZW5ndGgKCiAgICBpZiAob2Zmc2V0ID49IHN0YXJ0ICYmIG9mZnNldCArIDE2IDw9IGVuZCkgewogICAgICByZXR1cm4gbmV4dAogICAgfQogIH0KCiAgcmV0dXJuIG51bGwKfQoKY2xhc3MgU3BhcnNlSW5kZXggZXh0ZW5kcyBJbmRleCB7CiAgY29uc3RydWN0b3IoY2h1bmtzLCBieXRlTGVuZ3RoKSB7CiAgICBzdXBlcihieXRlTGVuZ3RoKQogICAgdGhpcy5jaHVua3MgPSBjaHVua3MKCiAgICBiaW5kaW5nLnF1aWNrYml0X25hcGlfaW5kZXhfaW5pdF9zcGFyc2UoCiAgICAgIHRoaXMuaGFuZGxlLAogICAgICB0aGlzLmNodW5rcy5tYXAodG9CdWZmZXJDaHVuaykKICAgICkKICB9CgogIGdldCBieXRlTGVuZ3RoKCkgewogICAgaWYgKHRoaXMuX2J5dGVMZW5ndGggIT09IC0xKSByZXR1cm4gdGhpcy5fYnl0ZUxlbmd0aAogICAgY29uc3QgbGFzdCA9IHRoaXMuY2h1bmtzW3RoaXMuY2h1bmtzLmxlbmd0aCAtIDFdCiAgICByZXR1cm4gbGFzdCA/IGxhc3Qub2Zmc2V0ICsgbGFzdC5maWVsZC5ieXRlTGVuZ3RoIDogMAogIH0KCiAgdXBkYXRlKGJpdCkgewogICAgY29uc3QgbiA9IHRoaXMuYnl0ZUxlbmd0aCAqIDgKCiAgICBpZiAoYml0IDwgMCkgYml0ICs9IG4KICAgIGlmIChiaXQgPCAwIHx8IGJpdCA+PSBuKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBqID0gTWF0aC5mbG9vcihiaXQgLyAxMjgpCgogICAgY29uc3Qgb2Zmc2V0ID0gaiAqIDE2CgogICAgY29uc3QgY2h1bmsgPSBzZWxlY3RDaHVuayh0aGlzLmNodW5rcywgb2Zmc2V0KQoKICAgIGlmIChjaHVuayA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogICAgcmV0dXJuICgKICAgICAgYmluZGluZy5xdWlja2JpdF9uYXBpX2luZGV4X3VwZGF0ZV9zcGFyc2UoCiAgICAgICAgdGhpcy5oYW5kbGUsCiAgICAgICAgdG9CdWZmZXIoY2h1bmsuZmllbGQpLAogICAgICAgIGNodW5rLm9mZnNldCwKICAgICAgICBiaXQKICAgICAgKSAhPT0gMAogICAgKQogIH0KfQp7CiAgIm5hbWUiOiAicXVpY2tiaXQtbmF0aXZlIiwKICAidmVyc2lvbiI6ICIyLjQuOCIsCiAgImRlc2NyaXB0aW9uIjogImxpYnF1aWNrYml0IEphdmFTY3JpcHQgYmluZGluZ3MgZm9yIE5vZGUuanMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgIm1hY3Jvcy5oIiwKICAgICJiaW5kaW5nLmNjIiwKICAgICJiaW5kaW5nLmpzIiwKICAgICJDTWFrZUxpc3RzLnR4dCIsCiAgICAicHJlYnVpbGRzIgogIF0sCiAgImFkZG9uIjogdHJ1ZSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogIm5wbSBydW4gbGludCAmJiBucG0gcnVuIHRlc3Q6YmFyZSAmJiBucG0gcnVuIHRlc3Q6bm9kZSIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC5tanMiLAogICAgInRlc3Q6bm9kZSI6ICJub2RlIHRlc3QubWpzIiwKICAgICJsaW50IjogInByZXR0aWVyIC4gLS1jaGVjayIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9xdWlja2JpdC1uYXRpdmUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcXVpY2tiaXQtbmF0aXZlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcXVpY2tiaXQtbmF0aXZlI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJyZXF1aXJlLWFkZG9uIjogIl4xLjEuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNyIsCiAgICAiYmFyZS1jb21wYXQtbmFwaSI6ICJeMS4zLjIiLAogICAgImJyaXR0bGUiOiAiXjMuMS4wIiwKICAgICJjbWFrZS1iYXJlIjogIl4xLjEuNyIsCiAgICAiY21ha2UtZmV0Y2giOiAiXjEuMS4wIiwKICAgICJjbWFrZS1uYXBpIjogIl4xLjAuMiIsCiAgICAicHJldHRpZXIiOiAiXjMuNS4zIiwKICAgICJwcmV0dGllci1jb25maWctc3RhbmRhcmQiOiAiXjcuMC4wIgogIH0KfQpjb25zdCBzaW1kbGUgPSByZXF1aXJlKCdzaW1kbGUtdW5pdmVyc2FsJykKCmNvbnN0IElOREVYX0xFTiA9ICgxNiAvKiByb290ICovICsgMTI4ICogMTYgLyogY2hpbGRyZW4gKi8pICogMgoKY29uc3QgZ2V0ID0gZXhwb3J0cy5nZXQgPSBmdW5jdGlvbiBnZXQgKGZpZWxkLCBiaXQpIHsKICBjb25zdCBuID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgaWYgKGJpdCA8IDApIGJpdCArPSBuCiAgaWYgKGJpdCA8IDAgfHwgYml0ID49IG4pIHJldHVybiBmYWxzZQoKICBjb25zdCBtID0gZmllbGQuQllURVNfUEVSX0VMRU1FTlQgKiA4CgogIGNvbnN0IG9mZnNldCA9IGJpdCAmIChtIC0gMSkKICBjb25zdCBpID0gKGJpdCAtIG9mZnNldCkgLyBtCgogIHJldHVybiAoZmllbGRbaV0gJiAoMSA8PCBvZmZzZXQpKSAhPT0gMAp9Cgpjb25zdCBzZXQgPSBleHBvcnRzLnNldCA9IGZ1bmN0aW9uIHNldCAoZmllbGQsIGJpdCwgdmFsdWUgPSB0cnVlKSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogIGlmIChiaXQgPCAwKSBiaXQgKz0gbgogIGlmIChiaXQgPCAwIHx8IGJpdCA+PSBuKSByZXR1cm4gZmFsc2UKCiAgY29uc3QgbSA9IGZpZWxkLkJZVEVTX1BFUl9FTEVNRU5UICogOAoKICBjb25zdCBvZmZzZXQgPSBiaXQgJiAobSAtIDEpCiAgY29uc3QgaSA9IChiaXQgLSBvZmZzZXQpIC8gbQogIGNvbnN0IG1hc2sgPSAxIDw8IG9mZnNldAoKICBpZiAodmFsdWUpIHsKICAgIGlmICgoZmllbGRbaV0gJiBtYXNrKSAhPT0gMCkgcmV0dXJuIGZhbHNlCiAgfSBlbHNlIHsKICAgIGlmICgoZmllbGRbaV0gJiBtYXNrKSA9PT0gMCkgcmV0dXJuIGZhbHNlCiAgfQoKICBmaWVsZFtpXSBePSBtYXNrCgogIHJldHVybiB0cnVlCn0KCmV4cG9ydHMuZmlsbCA9IGZ1bmN0aW9uIGZpbGwgKGZpZWxkLCB2YWx1ZSwgc3RhcnQgPSAwLCBlbmQgPSBmaWVsZC5ieXRlTGVuZ3RoICogOCkgewogIGNvbnN0IG4gPSBmaWVsZC5ieXRlTGVuZ3RoICogOAoKICBpZiAoc3RhcnQgPCAwKSBzdGFydCArPSBuCiAgaWYgKGVuZCA8IDApIGVuZCArPSBuCiAgaWYgKHN0YXJ0IDwgMCB8fCBzdGFydCA+PSBmaWVsZC5ieXRlTGVuZ3RoICogOCB8fCBzdGFydCA+PSBlbmQpIHJldHVybiBmaWVsZAoKICBjb25zdCBtID0gZmllbGQuQllURVNfUEVSX0VMRU1FTlQgKiA4CgogIGxldCBpLCBqCgogIHsKICAgIGNvbnN0IG9mZnNldCA9IHN0YXJ0ICYgKG0gLSAxKQogICAgaSA9IChzdGFydCAtIG9mZnNldCkgLyBtCgogICAgaWYgKG9mZnNldCAhPT0gMCkgewogICAgICBsZXQgc2hpZnQgPSBtIC0gb2Zmc2V0CiAgICAgIGlmIChlbmQgLSBzdGFydCA8IHNoaWZ0KSBzaGlmdCA9IGVuZCAtIHN0YXJ0CgogICAgICBjb25zdCBtYXNrID0gKCgxIDw8IHNoaWZ0KSAtIDEpIDw8IG9mZnNldAoKICAgICAgaWYgKHZhbHVlKSBmaWVsZFtpXSB8PSBtYXNrCiAgICAgIGVsc2UgZmllbGRbaV0gJj0gfm1hc2sKCiAgICAgIGkrKwogICAgfQogIH0KCiAgewogICAgY29uc3Qgb2Zmc2V0ID0gZW5kICYgKG0gLSAxKQogICAgaiA9IChlbmQgLSBvZmZzZXQpIC8gbQoKICAgIGlmIChvZmZzZXQgIT09IDAgJiYgaiA+PSBpKSB7CiAgICAgIGNvbnN0IG1hc2sgPSAoMSA8PCBvZmZzZXQpIC0gMQoKICAgICAgaWYgKHZhbHVlKSBmaWVsZFtqXSB8PSBtYXNrCiAgICAgIGVsc2UgZmllbGRbal0gJj0gfm1hc2sKICAgIH0KICB9CgogIGlmIChpIDwgaikgZmllbGQuZmlsbCh2YWx1ZSA/ICgyICoqIG0pIC0gMSA6IDAsIGksIGopCgogIHJldHVybiBmaWVsZAp9CgpleHBvcnRzLmNsZWFyID0gZnVuY3Rpb24gY2xlYXIgKGZpZWxkLCAuLi5jaHVua3MpIHsKICBjb25zdCBuID0gZmllbGQuYnl0ZUxlbmd0aAoKICBmb3IgKGNvbnN0IGNodW5rIG9mIGNodW5rcykgewogICAgaWYgKGNodW5rLm9mZnNldCA+PSBuKSBjb250aW51ZQoKICAgIGNvbnN0IG0gPSBjaHVuay5maWVsZC5ieXRlTGVuZ3RoCgogICAgbGV0IGkgPSBjaHVuay5vZmZzZXQKICAgIGxldCBqID0gMAoKICAgIHdoaWxlICgoKGkgJiAxNSkgIT09IDAgfHwgKGogJiAxNSkgIT09IDApICYmIGkgPCBuICYmIGogPCBtKSB7CiAgICAgIGZpZWxkW2ldID0gZmllbGRbaV0gJiB+Y2h1bmsuZmllbGRbal0KICAgICAgaSsrCiAgICAgIGorKwogICAgfQoKICAgIGlmIChpICsgMTUgPCBuICYmIGogKyAxNSA8IG0pIHsKICAgICAgY29uc3QgbGVuID0gTWF0aC5taW4obiAtIChuICYgMTUpIC0gaSwgbSAtIChtICYgMTUpIC0gaikKCiAgICAgIHNpbWRsZS5jbGVhcihmaWVsZC5zdWJhcnJheShpLCBpICsgbGVuKSwgY2h1bmsuZmllbGQuc3ViYXJyYXkoaiwgaiArIGxlbiksIGZpZWxkLnN1YmFycmF5KGksIGkgKyBsZW4pKQogICAgfQoKICAgIHdoaWxlIChpIDwgbiAmJiBqIDwgbSkgewogICAgICBmaWVsZFtpXSA9IGZpZWxkW2ldICYgfmNodW5rLmZpZWxkW2pdCiAgICAgIGkrKwogICAgICBqKysKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGJpdE9mZnNldCAoYml0LCBvZmZzZXQpIHsKICByZXR1cm4gIWJpdCA/IG9mZnNldCA6IChJTkRFWF9MRU4gKiA4IC8gMikgKyBvZmZzZXQKfQoKZnVuY3Rpb24gYnl0ZU9mZnNldCAoYml0LCBvZmZzZXQpIHsKICByZXR1cm4gIWJpdCA/IG9mZnNldCA6IChJTkRFWF9MRU4gLyAyKSArIG9mZnNldAp9CgpleHBvcnRzLmZpbmRGaXJzdCA9IGZ1bmN0aW9uIGZpbmRGaXJzdCAoZmllbGQsIHZhbHVlLCBwb3NpdGlvbiA9IDApIHsKICBjb25zdCBuID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gKz0gbgogIGlmIChwb3NpdGlvbiA8IDApIHBvc2l0aW9uID0gMAogIGlmIChwb3NpdGlvbiA+PSBuKSByZXR1cm4gLTEKCiAgdmFsdWUgPSAhIXZhbHVlCgogIGZvciAobGV0IGkgPSBwb3NpdGlvbjsgaSA8IG47IGkrKykgewogICAgaWYgKGdldChmaWVsZCwgaSkgPT09IHZhbHVlKSByZXR1cm4gaQogIH0KCiAgcmV0dXJuIC0xCn0KCmV4cG9ydHMuZmluZExhc3QgPSBmdW5jdGlvbiBmaW5kTGFzdCAoZmllbGQsIHZhbHVlLCBwb3NpdGlvbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4IC0gMSkgewogIGNvbnN0IG4gPSBmaWVsZC5ieXRlTGVuZ3RoICogOAoKICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiArPSBuCiAgaWYgKHBvc2l0aW9uIDwgMCkgcmV0dXJuIC0xCiAgaWYgKHBvc2l0aW9uID49IG4pIHBvc2l0aW9uID0gbiAtIDEKCiAgdmFsdWUgPSAhIXZhbHVlCgogIGZvciAobGV0IGkgPSBwb3NpdGlvbjsgaSA+PSAwOyBpLS0pIHsKICAgIGlmIChnZXQoZmllbGQsIGkpID09PSB2YWx1ZSkgcmV0dXJuIGkKICB9CgogIHJldHVybiAtMQp9Cgpjb25zdCBJbmRleCA9IGV4cG9ydHMuSW5kZXggPSBjbGFzcyBJbmRleCB7CiAgc3RhdGljIGZyb20gKGZpZWxkT3JDaHVua3MsIGJ5dGVMZW5ndGggPSAtMSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkoZmllbGRPckNodW5rcykpIHsKICAgICAgcmV0dXJuIG5ldyBTcGFyc2VJbmRleChmaWVsZE9yQ2h1bmtzLCBieXRlTGVuZ3RoKQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5ldyBEZW5zZUluZGV4KGZpZWxkT3JDaHVua3MsIGJ5dGVMZW5ndGgpCiAgICB9CiAgfQoKICBjb25zdHJ1Y3RvciAoYnl0ZUxlbmd0aCkgewogICAgdGhpcy5fYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGgKICAgIHRoaXMuaGFuZGxlID0gbmV3IFVpbnQzMkFycmF5KElOREVYX0xFTiAvIDQpCiAgfQoKICBnZXQgYnl0ZUxlbmd0aCAoKSB7CiAgICByZXR1cm4gdGhpcy5fYnl0ZUxlbmd0aAogIH0KCiAgc2tpcEZpcnN0ICh2YWx1ZSwgcG9zaXRpb24gPSAwKSB7CiAgICBjb25zdCBuID0gdGhpcy5ieXRlTGVuZ3RoICogOAoKICAgIGlmIChwb3NpdGlvbiA8IDApIHBvc2l0aW9uICs9IG4KICAgIGlmIChwb3NpdGlvbiA8IDApIHBvc2l0aW9uID0gMAogICAgaWYgKHBvc2l0aW9uID49IG4pIHJldHVybiBuIC0gMQoKICAgIGxldCBpID0gTWF0aC5mbG9vcihwb3NpdGlvbiAvIDE2Mzg0KQoKICAgIGlmIChpID4gMTI3KSByZXR1cm4gcG9zaXRpb24KCiAgICB3aGlsZSAoaSA8PSAxMjcgJiYgZ2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodmFsdWUsIGkpKSkgewogICAgICBpKysKICAgIH0KCiAgICBpZiAoaSA9PT0gMTI4KSByZXR1cm4gbiAtIDEKCiAgICBsZXQgayA9IGkgKiAxNjM4NAogICAgbGV0IGogPSAwCgogICAgaWYgKHBvc2l0aW9uID4gaykgaiA9IE1hdGguZmxvb3IoKHBvc2l0aW9uIC0gaykgLyAxMjgpCgogICAgd2hpbGUgKGogPD0gMTI3ICYmIGdldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHZhbHVlLCBpICogMTI4ICsgaiArIDEyOCkpKSB7CiAgICAgIGorKwogICAgICBrICs9IDEyOAogICAgfQoKICAgIGlmIChqID09PSAxMjggJiYgaSAhPT0gMTI3KSByZXR1cm4gdGhpcy5za2lwRmlyc3QodmFsdWUsIChpICsgMSkgKiAxNjM4NCkKCiAgICBpZiAoayA+IHBvc2l0aW9uKSBwb3NpdGlvbiA9IGsKCiAgICByZXR1cm4gcG9zaXRpb24gPCBuID8gcG9zaXRpb24gOiBuIC0gMQogIH0KCiAgc2tpcExhc3QgKHZhbHVlLCBwb3NpdGlvbiA9IHRoaXMuYnl0ZUxlbmd0aCAqIDggLSAxKSB7CiAgICBjb25zdCBuID0gdGhpcy5ieXRlTGVuZ3RoICogOAoKICAgIGlmIChwb3NpdGlvbiA8IDApIHBvc2l0aW9uICs9IG4KICAgIGlmIChwb3NpdGlvbiA8IDApIHJldHVybiAwCiAgICBpZiAocG9zaXRpb24gPj0gbikgcG9zaXRpb24gPSBuIC0gMQoKICAgIGxldCBpID0gTWF0aC5mbG9vcihwb3NpdGlvbiAvIDE2Mzg0KQoKICAgIGlmIChpID4gMTI3KSByZXR1cm4gcG9zaXRpb24KCiAgICB3aGlsZSAoaSA+PSAwICYmIGdldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHZhbHVlLCBpKSkpIHsKICAgICAgaS0tCiAgICB9CgogICAgaWYgKGkgPT09IC0xKSByZXR1cm4gMAoKICAgIGxldCBrID0gKChpICsgMSkgKiAxNjM4NCkgLSAxCiAgICBsZXQgaiA9IDEyNwoKICAgIGlmIChwb3NpdGlvbiA8IGspIGogPSAxMjggLSBNYXRoLmNlaWwoKGsgLSBwb3NpdGlvbikgLyAxMjgpCgogICAgd2hpbGUgKGogPj0gMCAmJiBnZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh2YWx1ZSwgaSAqIDEyOCArIGogKyAxMjgpKSkgewogICAgICBqLS0KICAgICAgayAtPSAxMjgKICAgIH0KCiAgICBpZiAoaiA9PT0gLTEgJiYgaSAhPT0gMCkgcmV0dXJuIHRoaXMuc2tpcExhc3QodmFsdWUsIGkgKiAxNjM4NCAtIDEpCgogICAgaWYgKGsgPCBwb3NpdGlvbikgcG9zaXRpb24gPSBrCgogICAgcmV0dXJuIHBvc2l0aW9uCiAgfQp9CgpjbGFzcyBEZW5zZUluZGV4IGV4dGVuZHMgSW5kZXggewogIGNvbnN0cnVjdG9yIChmaWVsZCwgYnl0ZUxlbmd0aCkgewogICAgc3VwZXIoYnl0ZUxlbmd0aCkKICAgIHRoaXMuZmllbGQgPSBmaWVsZAoKICAgIGNvbnN0IG0gPSBmaWVsZC5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTI4OyBpKyspIHsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCAxMjg7IGorKykgewogICAgICAgIGNvbnN0IG9mZnNldCA9IChpICogMTI4ICsgaikgKiAxNgogICAgICAgIGxldCBhbGx6ID0gdHJ1ZQogICAgICAgIGxldCBhbGxvID0gZmFsc2UKCiAgICAgICAgaWYgKG9mZnNldCArIDE2IDw9IHRoaXMuZmllbGQuYnl0ZUxlbmd0aCkgewogICAgICAgICAgY29uc3QgdmVjID0gdGhpcy5maWVsZC5zdWJhcnJheShvZmZzZXQgLyBtLCAob2Zmc2V0ICsgMTYpIC8gbSkKCiAgICAgICAgICBhbGx6ID0gc2ltZGxlLmFsbHoodmVjKQogICAgICAgICAgYWxsbyA9IHNpbWRsZS5hbGxvKHZlYykKICAgICAgICB9CgogICAgICAgIGNvbnN0IGsgPSBpICogMTI4ICsgMTI4ICsgagoKICAgICAgICBzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldChmYWxzZSwgayksIGFsbHopCiAgICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodHJ1ZSwgayksIGFsbG8pCiAgICAgIH0KCiAgICAgIHsKICAgICAgICBjb25zdCBvZmZzZXQgPSBieXRlT2Zmc2V0KGZhbHNlLCBpICogMTYgKyAxNikgLyA0CiAgICAgICAgY29uc3QgYWxsbyA9IHNpbWRsZS5hbGxvKHRoaXMuaGFuZGxlLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgNCkpCgogICAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KGZhbHNlLCBpKSwgYWxsbykKICAgICAgfQoKICAgICAgewogICAgICAgIGNvbnN0IG9mZnNldCA9IGJ5dGVPZmZzZXQodHJ1ZSwgaSAqIDE2ICsgMTYpIC8gNAogICAgICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh0aGlzLmhhbmRsZS5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIDQpKQoKICAgICAgICBzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh0cnVlLCBpKSwgYWxsbykKICAgICAgfQogICAgfQogIH0KCiAgZ2V0IGJ5dGVMZW5ndGggKCkgewogICAgaWYgKHRoaXMuX2J5dGVMZW5ndGggIT09IC0xKSByZXR1cm4gdGhpcy5fYnl0ZUxlbmd0aAogICAgcmV0dXJuIHRoaXMuZmllbGQuYnl0ZUxlbmd0aAogIH0KCiAgdXBkYXRlIChiaXQpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmJ5dGVMZW5ndGggKiA4CgogICAgaWYgKGJpdCA8IDApIGJpdCArPSBuCiAgICBpZiAoYml0IDwgMCB8fCBiaXQgPj0gbikgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgbSA9IHRoaXMuZmllbGQuQllURVNfUEVSX0VMRU1FTlQKCiAgICBjb25zdCBpID0gTWF0aC5mbG9vcihiaXQgLyAxNjM4NCkKICAgIGNvbnN0IGogPSBNYXRoLmZsb29yKGJpdCAvIDEyOCkKCiAgICBjb25zdCBvZmZzZXQgPSAoaiAqIDE2KSAvIG0KICAgIGNvbnN0IHZlYyA9IHRoaXMuZmllbGQuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyAoMTYgLyBtKSkKCiAgICBjb25zdCBhbGx6ID0gc2ltZGxlLmFsbHoodmVjKQogICAgY29uc3QgYWxsbyA9IHNpbWRsZS5hbGxvKHZlYykKCiAgICBsZXQgY2hhbmdlZCA9IGZhbHNlCgogICAgaWYgKHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KGZhbHNlLCAxMjggKyBqKSwgYWxseikpIHsKICAgICAgY2hhbmdlZCA9IHRydWUKCiAgICAgIGNvbnN0IG9mZnNldCA9IGJ5dGVPZmZzZXQoZmFsc2UsIGkgKiAxNiArIDE2KSAvIDQKICAgICAgY29uc3QgYWxsbyA9IHNpbWRsZS5hbGxvKHRoaXMuaGFuZGxlLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgNCkpCgogICAgICBzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldChmYWxzZSwgaSksIGFsbG8pCiAgICB9CgogICAgaWYgKHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHRydWUsIDEyOCArIGopLCBhbGxvKSkgewogICAgICBjaGFuZ2VkID0gdHJ1ZQoKICAgICAgY29uc3Qgb2Zmc2V0ID0gYnl0ZU9mZnNldCh0cnVlLCBpICogMTYgKyAxNikgLyA0CiAgICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh0aGlzLmhhbmRsZS5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIDQpKQoKICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodHJ1ZSwgaSksIGFsbG8pCiAgICB9CgogICAgcmV0dXJuIGNoYW5nZWQKICB9Cn0KCmZ1bmN0aW9uIHNlbGVjdENodW5rIChjaHVua3MsIG9mZnNldCkgewogIGZvciAobGV0IGkgPSAwOyBpIDwgY2h1bmtzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBuZXh0ID0gY2h1bmtzW2ldCgogICAgY29uc3Qgc3RhcnQgPSBuZXh0Lm9mZnNldAogICAgY29uc3QgZW5kID0gbmV4dC5vZmZzZXQgKyBuZXh0LmZpZWxkLmJ5dGVMZW5ndGgKCiAgICBpZiAob2Zmc2V0ID49IHN0YXJ0ICYmIG9mZnNldCArIDE2IDw9IGVuZCkgewogICAgICByZXR1cm4gbmV4dAogICAgfQogIH0KCiAgcmV0dXJuIG51bGwKfQoKY2xhc3MgU3BhcnNlSW5kZXggZXh0ZW5kcyBJbmRleCB7CiAgY29uc3RydWN0b3IgKGNodW5rcywgYnl0ZUxlbmd0aCkgewogICAgc3VwZXIoYnl0ZUxlbmd0aCkKICAgIHRoaXMuY2h1bmtzID0gY2h1bmtzCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMjg7IGkrKykgewogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDEyODsgaisrKSB7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gKGkgKiAxMjggKyBqKSAqIDE2CiAgICAgICAgbGV0IGFsbHogPSB0cnVlCiAgICAgICAgbGV0IGFsbG8gPSBmYWxzZQoKICAgICAgICBjb25zdCBjaHVuayA9IHNlbGVjdENodW5rKHRoaXMuY2h1bmtzLCBvZmZzZXQpCgogICAgICAgIGlmIChjaHVuayAhPT0gbnVsbCkgewogICAgICAgICAgY29uc3QgbSA9IGNodW5rLmZpZWxkLkJZVEVTX1BFUl9FTEVNRU5UCgogICAgICAgICAgY29uc3QgdmVjID0gY2h1bmsuZmllbGQuc3ViYXJyYXkoKG9mZnNldCAtIGNodW5rLm9mZnNldCkgLyBtLCAob2Zmc2V0IC0gY2h1bmsub2Zmc2V0ICsgMTYpIC8gbSkKCiAgICAgICAgICBhbGx6ID0gc2ltZGxlLmFsbHoodmVjKQogICAgICAgICAgYWxsbyA9IHNpbWRsZS5hbGxvKHZlYykKICAgICAgICB9CgogICAgICAgIGNvbnN0IGsgPSBpICogMTI4ICsgMTI4ICsgagoKICAgICAgICBzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldChmYWxzZSwgayksIGFsbHopCiAgICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodHJ1ZSwgayksIGFsbG8pCiAgICAgIH0KCiAgICAgIHsKICAgICAgICBjb25zdCBvZmZzZXQgPSBieXRlT2Zmc2V0KGZhbHNlLCBpICogMTYgKyAxNikgLyA0CiAgICAgICAgY29uc3QgYWxsbyA9IHNpbWRsZS5hbGxvKHRoaXMuaGFuZGxlLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgNCkpCgogICAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KGZhbHNlLCBpKSwgYWxsbykKICAgICAgfQoKICAgICAgewogICAgICAgIGNvbnN0IG9mZnNldCA9IGJ5dGVPZmZzZXQodHJ1ZSwgaSAqIDE2ICsgMTYpIC8gNAogICAgICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh0aGlzLmhhbmRsZS5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIDQpKQoKICAgICAgICBzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh0cnVlLCBpKSwgYWxsbykKICAgICAgfQogICAgfQogIH0KCiAgZ2V0IGJ5dGVMZW5ndGggKCkgewogICAgaWYgKHRoaXMuX2J5dGVMZW5ndGggIT09IC0xKSByZXR1cm4gdGhpcy5fYnl0ZUxlbmd0aAogICAgY29uc3QgbGFzdCA9IHRoaXMuY2h1bmtzW3RoaXMuY2h1bmtzLmxlbmd0aCAtIDFdCiAgICByZXR1cm4gbGFzdCA/IGxhc3Qub2Zmc2V0ICsgbGFzdC5maWVsZC5ieXRlTGVuZ3RoIDogMAogIH0KCiAgdXBkYXRlIChiaXQpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmJ5dGVMZW5ndGggKiA4CgogICAgaWYgKGJpdCA8IDApIGJpdCArPSBuCiAgICBpZiAoYml0IDwgMCB8fCBiaXQgPj0gbikgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgaSA9IE1hdGguZmxvb3IoYml0IC8gMTYzODQpCiAgICBjb25zdCBqID0gTWF0aC5mbG9vcihiaXQgLyAxMjgpCgogICAgY29uc3Qgb2Zmc2V0ID0gaiAqIDE2CgogICAgY29uc3QgY2h1bmsgPSBzZWxlY3RDaHVuayh0aGlzLmNodW5rcywgb2Zmc2V0KQoKICAgIGlmIChjaHVuayA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgbSA9IGNodW5rLmZpZWxkLkJZVEVTX1BFUl9FTEVNRU5UCgogICAgY29uc3QgdmVjID0gY2h1bmsuZmllbGQuc3ViYXJyYXkoKG9mZnNldCAtIGNodW5rLm9mZnNldCkgLyBtLCAob2Zmc2V0IC0gY2h1bmsub2Zmc2V0ICsgMTYpIC8gbSkKCiAgICBjb25zdCBhbGx6ID0gc2ltZGxlLmFsbHoodmVjKQogICAgY29uc3QgYWxsbyA9IHNpbWRsZS5hbGxvKHZlYykKCiAgICBsZXQgY2hhbmdlZCA9IGZhbHNlCgogICAgaWYgKHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KGZhbHNlLCAxMjggKyBqKSwgYWxseikpIHsKICAgICAgY2hhbmdlZCA9IHRydWUKCiAgICAgIGNvbnN0IG9mZnNldCA9IGJ5dGVPZmZzZXQoZmFsc2UsIGkgKiAxNiArIDE2KSAvIDQKICAgICAgY29uc3QgYWxsbyA9IHNpbWRsZS5hbGxvKHRoaXMuaGFuZGxlLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgNCkpCgogICAgICBzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldChmYWxzZSwgaSksIGFsbG8pCiAgICB9CgogICAgaWYgKHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHRydWUsIDEyOCArIGopLCBhbGxvKSkgewogICAgICBjaGFuZ2VkID0gdHJ1ZQoKICAgICAgY29uc3Qgb2Zmc2V0ID0gYnl0ZU9mZnNldCh0cnVlLCBpICogMTYgKyAxNikgLyA0CiAgICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh0aGlzLmhhbmRsZS5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIDQpKQoKICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodHJ1ZSwgaSksIGFsbG8pCiAgICB9CgogICAgcmV0dXJuIGNoYW5nZWQKICB9Cn0KY29uc3QgZmFsbGJhY2sgPSByZXF1aXJlKCcuL2ZhbGxiYWNrJykKCnRyeSB7CiAgY29uc3QgbmF0aXZlID0gcmVxdWlyZSgncXVpY2tiaXQtbmF0aXZlJykKCiAgLy8gVGhlc2UgZnVuY3Rpb25zIGFyZSBmYXN0ZXIgaW4gSmF2YVNjcmlwdAogIGV4cG9ydHMuZ2V0ID0gZmFsbGJhY2suZ2V0CiAgZXhwb3J0cy5zZXQgPSBmYWxsYmFjay5zZXQKICBleHBvcnRzLmZpbGwgPSBmYWxsYmFjay5maWxsCgogIC8vIFRoZXNlIGZ1bmN0aW9ucyBhcmUgZmFzdGVyIGluIEMKICBleHBvcnRzLmNsZWFyID0gbmF0aXZlLmNsZWFyCiAgZXhwb3J0cy5maW5kRmlyc3QgPSBuYXRpdmUuZmluZEZpcnN0CiAgZXhwb3J0cy5maW5kTGFzdCA9IG5hdGl2ZS5maW5kTGFzdAogIGV4cG9ydHMuSW5kZXggPSBuYXRpdmUuSW5kZXgKfSBjYXRjaCB7CiAgbW9kdWxlLmV4cG9ydHMgPSBmYWxsYmFjawp9CnsKICAibmFtZSI6ICJxdWlja2JpdC11bml2ZXJzYWwiLAogICJ2ZXJzaW9uIjogIjIuMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiVW5pdmVyc2FsIHdyYXBwZXIgZm9yIGxpYnF1aWNrYml0IHdpdGggYSBKYXZhU2NyaXB0IGZhbGxiYWNrIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImZhbGxiYWNrLmpzIiwKICAgICJpbmRleC5qcyIKICBdLAogICJicm93c2VyIjogewogICAgIi4vaW5kZXguanMiOiAiLi9mYWxsYmFjay5qcyIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0Lm1qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9xdWlja2JpdC11bml2ZXJzYWwuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJLYXNwZXIgSXNhZ2VyIERhbHNnYXLDsCA8a2FzcGVyQGZ1bmt0aW9uZWwuY28+IiwKICAibGljZW5zZSI6ICJJU0MiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcXVpY2tiaXQtdW5pdmVyc2FsL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcXVpY2tiaXQtdW5pdmVyc2FsI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi4wIiwKICAgICJzaW1kbGUtdW5pdmVyc2FsIjogIl4xLjEuMCIKICB9LAogICJvcHRpb25hbERlcGVuZGVuY2llcyI6IHsKICAgICJxdWlja2JpdC1uYXRpdmUiOiAiXjIuMi4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjEuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9Cn0KY2xhc3MgQ2FjaGVFbnRyeSB7CiAgY29uc3RydWN0b3IgKGtleSwgaW5kZXgsIG1hcCkgewogICAgdGhpcy5rZXkgPSBrZXkKICAgIHRoaXMuaW5kZXggPSBpbmRleAogICAgdGhpcy5tYXAgPSBtYXAKICB9Cn0KCmNsYXNzIENhY2hlVmFsdWUgewogIGNvbnN0cnVjdG9yIChlbnRyeSwgdmFsdWUpIHsKICAgIHRoaXMuZW50cnkgPSBlbnRyeQogICAgdGhpcy52YWx1ZSA9IHZhbHVlCiAgfQp9CgpjbGFzcyBSYWNoZSB7CiAgY29uc3RydWN0b3IgKHsgbWF4U2l6ZSA9IDY1NTM2LCBwYXJlbnQgPSBudWxsIH0gPSB7fSkgewogICAgdGhpcy5tYXhTaXplID0gcGFyZW50Py5tYXhTaXplIHx8IG1heFNpemUKCiAgICB0aGlzLl9hcnJheSA9IHBhcmVudD8uX2FycmF5IHx8IFtdCiAgICB0aGlzLl9tYXAgPSBuZXcgTWFwKCkKICB9CgogIHN0YXRpYyBmcm9tIChjYWNoZSkgewogICAgcmV0dXJuIGNhY2hlID8gbmV3IHRoaXMoeyBwYXJlbnQ6IGNhY2hlIH0pIDogbmV3IHRoaXMoKQogIH0KCiAgZ2V0IGdsb2JhbFNpemUgKCkgewogICAgcmV0dXJuIHRoaXMuX2FycmF5Lmxlbmd0aAogIH0KCiAgZ2V0IHNpemUgKCkgewogICAgcmV0dXJuIHRoaXMuX21hcC5zaXplCiAgfQoKICBzdWIgKCkgewogICAgcmV0dXJuIG5ldyBSYWNoZSh7IHBhcmVudDogdGhpcyB9KQogIH0KCiAgc2V0IChrZXksIHZhbHVlKSB7IC8vIH5jb25zdGFudCB0aW1lCiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuX21hcC5nZXQoa2V5KQogICAgaWYgKGV4aXN0aW5nICE9PSB1bmRlZmluZWQpIHsKICAgICAgZXhpc3RpbmcudmFsdWUgPSB2YWx1ZQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5fYXJyYXkubGVuZ3RoID49IHRoaXMubWF4U2l6ZSkgdGhpcy5fZ2MoKQoKICAgIGNvbnN0IGVudHJ5ID0gbmV3IENhY2hlRW50cnkoa2V5LCB0aGlzLl9hcnJheS5sZW5ndGgsIHRoaXMuX21hcCkKICAgIHRoaXMuX2FycmF5LnB1c2goZW50cnkpCiAgICBjb25zdCBjYWNoZVZhbHVlID0gbmV3IENhY2hlVmFsdWUoZW50cnksIHZhbHVlKQogICAgdGhpcy5fbWFwLnNldChrZXksIGNhY2hlVmFsdWUpCiAgfQoKICBkZWxldGUgKGtleSkgewogICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLl9tYXAuZ2V0KGtleSkKICAgIGlmIChleGlzdGluZyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2UKCiAgICB0aGlzLl9kZWxldGUoZXhpc3RpbmcuZW50cnkuaW5kZXgpCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgZ2V0IChrZXkpIHsKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5fbWFwLmdldChrZXkpCiAgICByZXR1cm4gZXhpc3RpbmcgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IGV4aXN0aW5nLnZhbHVlCiAgfQoKICAqIFtTeW1ib2wuaXRlcmF0b3JdICgpIHsKICAgIGZvciAoY29uc3QgW2tleSwgeyB2YWx1ZSB9XSBvZiB0aGlzLl9tYXApIHsKICAgICAgeWllbGQgW2tleSwgdmFsdWVdCiAgICB9CiAgfQoKICBrZXlzICgpIHsKICAgIHJldHVybiB0aGlzLl9tYXAua2V5cygpCiAgfQoKICAqIHZhbHVlcyAoKSB7CiAgICBmb3IgKGNvbnN0IHsgdmFsdWUgfSBvZiB0aGlzLl9tYXAudmFsdWVzKCkpIHsKICAgICAgeWllbGQgdmFsdWUKICAgIH0KICB9CgogIGNsZWFyICgpIHsKICAgIC8vIFRoZSBlbnRyaWVzIGluIG1hcCBsaW5nZXIgb24gaW4gX2FycmF5LAogICAgLy8gc28gb24gdG9wIG9mIGNsZWFyaW5nIHRoZSBtYXAsIHdlIGFsc28ga2lsbCB0aGUgcmVmLAogICAgLy8gc28gdGhhdCBhbnkgZ2MgcnVubmluZyBsYXRlciBvbiB0aGUgb2xkIG1hcCB3b24ndCBpbnRlcmZlcmUKICAgIC8vIChpbiBjYXNlIGEgbmV3IGVudHJ5IHdhcyBhZGRlZCB3aXRoIHRoZSBzYW1lIGtleSBhcyBhIGNsZWFyZWQgZW50cnkpCgogICAgdGhpcy5fbWFwLmNsZWFyKCkKICAgIHRoaXMuX21hcCA9IG5ldyBNYXAoKQogIH0KCiAgZGVzdHJveSAoKSB7CiAgICB0aGlzLl9tYXAgPSBudWxsCiAgICB0aGlzLl9hcnJheSA9IG51bGwKICB9CgogIF9nYyAoKSB7CiAgICB0aGlzLl9kZWxldGUoTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdGhpcy5fYXJyYXkubGVuZ3RoKSkKICB9CgogIF9kZWxldGUgKGluZGV4KSB7IC8vIH5jb25zdGFudCB0aW1lCiAgICBpZiAoaW5kZXggPj0gdGhpcy5fYXJyYXkubGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBkZWxldGUgdW51c2VkIGluZGV4IChsb2dpYyBidWc/KScpCgogICAgY29uc3QgaGVhZCA9IHRoaXMuX2FycmF5LnBvcCgpCiAgICBsZXQgcmVtb3ZlZCA9IGhlYWQKCiAgICBpZiAoaW5kZXggPCB0aGlzLl9hcnJheS5sZW5ndGgpIHsKICAgICAgcmVtb3ZlZCA9IHRoaXMuX2FycmF5W2luZGV4XQogICAgICBoZWFkLmluZGV4ID0gaW5kZXgKICAgICAgdGhpcy5fYXJyYXlbaW5kZXhdID0gaGVhZAogICAgfQoKICAgIHJlbW92ZWQubWFwLmRlbGV0ZShyZW1vdmVkLmtleSkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gUmFjaGUKewogICJuYW1lIjogInJhY2hlIiwKICAidmVyc2lvbiI6ICIxLjAuMCIsCiAgImRlc2NyaXB0aW9uIjogIlJhbmRvbS1ldmljdGlvbiBjYWNoZSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIC0tY292ZXJhZ2UiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmFjaGUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmFjaGUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yYWNoZSNyZWFkbWUiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuNS4yIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4wIgogIH0KfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJhbmRvbUFycmF5SXRlcmF0b3IgewogIGNvbnN0cnVjdG9yICh2YWx1ZXMpIHsKICAgIHRoaXMudmFsdWVzID0gdmFsdWVzCiAgICB0aGlzLnN0YXJ0ID0gMAogICAgdGhpcy5sZW5ndGggPSB0aGlzLnZhbHVlcy5sZW5ndGgKICB9CgogIG5leHQgKCkgewogICAgaWYgKHRoaXMubGVuZ3RoID09PSAwKSB7CiAgICAgIGlmICh0aGlzLnN0YXJ0ID09PSAwKSByZXR1cm4geyBkb25lOiB0cnVlLCB2YWx1ZTogdW5kZWZpbmVkIH0KICAgICAgdGhpcy5sZW5ndGggPSB0aGlzLnN0YXJ0CiAgICAgIHRoaXMuc3RhcnQgPSAwCiAgICB9CgogICAgY29uc3QgaSA9IHRoaXMuc3RhcnQgKyAoKE1hdGgucmFuZG9tKCkgKiB0aGlzLmxlbmd0aCkgfCAwKQogICAgY29uc3QgaiA9IHRoaXMuc3RhcnQgKyAtLXRoaXMubGVuZ3RoCiAgICBjb25zdCB2YWx1ZSA9IHRoaXMudmFsdWVzW2ldCgogICAgdGhpcy52YWx1ZXNbaV0gPSB0aGlzLnZhbHVlc1tqXQogICAgdGhpcy52YWx1ZXNbal0gPSB2YWx1ZQoKICAgIHJldHVybiB7IGRvbmU6IGZhbHNlLCB2YWx1ZSB9CiAgfQoKICBkZXF1ZXVlICgpIHsKICAgIHRoaXMudmFsdWVzW3RoaXMuc3RhcnQgKyB0aGlzLmxlbmd0aF0gPSB0aGlzLnZhbHVlc1t0aGlzLnZhbHVlcy5sZW5ndGggLSAxXQogICAgdGhpcy52YWx1ZXMucG9wKCkKICB9CgogIHJlcXVldWUgKCkgewogICAgY29uc3QgaSA9IHRoaXMuc3RhcnQgKyB0aGlzLmxlbmd0aAogICAgY29uc3QgdmFsdWUgPSB0aGlzLnZhbHVlc1tpXQogICAgdGhpcy52YWx1ZXNbaV0gPSB0aGlzLnZhbHVlc1t0aGlzLnN0YXJ0XQogICAgdGhpcy52YWx1ZXNbdGhpcy5zdGFydCsrXSA9IHZhbHVlCiAgfQoKICByZXN0YXJ0ICgpIHsKICAgIHRoaXMuc3RhcnQgPSAwCiAgICB0aGlzLmxlbmd0aCA9IHRoaXMudmFsdWVzLmxlbmd0aAogICAgcmV0dXJuIHRoaXMKICB9CgogIFtTeW1ib2wuaXRlcmF0b3JdICgpIHsKICAgIHJldHVybiB0aGlzCiAgfQp9CnsKICAibmFtZSI6ICJyYW5kb20tYXJyYXktaXRlcmF0b3IiLAogICJ2ZXJzaW9uIjogIjEuMC4wIiwKICAiZGVzY3JpcHRpb24iOiAiQW4gaXRlcmF0b3IgdG8gaXRlcmF0ZSBhbiBhcnJheSBpbiByYW5kb20gb3JkZXIgd2l0aCBjb250cm9scyB0byByZXF1ZXVlIG9yIGRlcXVldWUgZWxlbWVudHMgZHVyaW5nIHRoZSBpdGVyYXRpb24iLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTYuMC4zIiwKICAgICJ0YXBlIjogIl41LjAuMSIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgdGFwZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3JhbmRvbS1hcnJheS1pdGVyYXRvci5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcmFuZG9tLWFycmF5LWl0ZXJhdG9yL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3JhbmRvbS1hcnJheS1pdGVyYXRvciIKfQpjb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSZWFkeVJlc291cmNlIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvciAoKSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5vcGVuaW5nID0gbnVsbAogICAgdGhpcy5jbG9zaW5nID0gbnVsbAoKICAgIHRoaXMub3BlbmVkID0gZmFsc2UKICAgIHRoaXMuY2xvc2VkID0gZmFsc2UKICB9CgogIHJlYWR5ICgpIHsKICAgIGlmICh0aGlzLm9wZW5pbmcgIT09IG51bGwpIHJldHVybiB0aGlzLm9wZW5pbmcKICAgIHRoaXMub3BlbmluZyA9IG9wZW4odGhpcykKICAgIHJldHVybiB0aGlzLm9wZW5pbmcKICB9CgogIGNsb3NlICgpIHsKICAgIGlmICh0aGlzLmNsb3NpbmcgIT09IG51bGwpIHJldHVybiB0aGlzLmNsb3NpbmcKICAgIHRoaXMuY2xvc2luZyA9IGNsb3NlKHRoaXMpCiAgICByZXR1cm4gdGhpcy5jbG9zaW5nCiAgfQoKICBhc3luYyBfb3BlbiAoKSB7CiAgICAvLyBhZGQgaW1wbCBoZXJlCiAgfQoKICBhc3luYyBfY2xvc2UgKCkgewogICAgLy8gYWRkIGltcGwgaGVyZQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gb3BlbiAoc2VsZikgewogIC8vIG9wZW4gYWZ0ZXIgY2xvc2UKICBpZiAoc2VsZi5jbG9zaW5nICE9PSBudWxsKSByZXR1cm4KCiAgdHJ5IHsKICAgIGF3YWl0IHNlbGYuX29wZW4oKQogIH0gY2F0Y2ggKGVycikgewogICAgc2VsZi5jbG9zZSgpIC8vIHNhZmUgdG8gcnVuIGluIGJnCiAgICB0aHJvdyBlcnIKICB9CgogIHNlbGYub3BlbmVkID0gdHJ1ZQogIHNlbGYuZW1pdCgncmVhZHknKQp9Cgphc3luYyBmdW5jdGlvbiBjbG9zZSAoc2VsZikgewogIHRyeSB7CiAgICBpZiAoc2VsZi5vcGVuZWQgPT09IGZhbHNlICYmIHNlbGYub3BlbmluZyAhPT0gbnVsbCkgYXdhaXQgc2VsZi5vcGVuaW5nCiAgfSBjYXRjaCB7CiAgICAvLyBpZ25vcmUgZXJyb3JzIG9uIGNsb3NpbmcKICB9CiAgaWYgKHNlbGYub3BlbmVkID09PSB0cnVlIHx8IHNlbGYub3BlbmluZyA9PT0gbnVsbCkgYXdhaXQgc2VsZi5fY2xvc2UoKQogIHNlbGYuY2xvc2VkID0gdHJ1ZQogIHNlbGYuZW1pdCgnY2xvc2UnKQp9CnsKICAibmFtZSI6ICJyZWFkeS1yZXNvdXJjZSIsCiAgInZlcnNpb24iOiAiMS4yLjAiLAogICJkZXNjcmlwdGlvbiI6ICJNb2Rlcm4gc2luZ2xlIHJlc291cmNlIG1hbmFnZW1lbnQiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiaW1wb3J0cyI6IHsKICAgICJldmVudHMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZXZlbnRzIiwKICAgICAgImRlZmF1bHQiOiAiZXZlbnRzIgogICAgfQogIH0sCiAgInR5cGVzIjogImluZGV4LmQudHMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiaW5kZXguZC50cyIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjEuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yZWFkeS1yZXNvdXJjZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yZWFkeS1yZXNvdXJjZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JlYWR5LXJlc291cmNlIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtZXZlbnRzIjogIl4yLjIuMCIKICB9Cn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCnZhciBFTVBUWSA9IFtdCgptb2R1bGUuZXhwb3J0cyA9IFJlY29yZENhY2hlCgpmdW5jdGlvbiBSZWNvcmRTZXQgKCkgewogIHRoaXMubGlzdCA9IFtdCiAgdGhpcy5tYXAgPSBuZXcgTWFwKCkKfQoKUmVjb3JkU2V0LnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiAocmVjb3JkLCB2YWx1ZSkgewogIHZhciBrID0gdG9TdHJpbmcocmVjb3JkKQogIHZhciByID0gdGhpcy5tYXAuZ2V0KGspCiAgaWYgKHIpIHJldHVybiBmYWxzZQoKICByID0ge2luZGV4OiB0aGlzLmxpc3QubGVuZ3RoLCByZWNvcmQ6IHZhbHVlIHx8IHJlY29yZH0KICB0aGlzLmxpc3QucHVzaChyKQogIHRoaXMubWFwLnNldChrLCByKQogIHJldHVybiB0cnVlCn0KClJlY29yZFNldC5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24gKHJlY29yZCkgewogIHZhciBrID0gdG9TdHJpbmcocmVjb3JkKQogIHZhciByID0gdGhpcy5tYXAuZ2V0KGspCiAgaWYgKCFyKSByZXR1cm4gZmFsc2UKCiAgc3dhcCh0aGlzLmxpc3QsIHIuaW5kZXgsIHRoaXMubGlzdC5sZW5ndGggLSAxKQogIHRoaXMubGlzdC5wb3AoKQogIHRoaXMubWFwLmRlbGV0ZShrKQogIHJldHVybiB0cnVlCn0KCmZ1bmN0aW9uIFJlY29yZFN0b3JlICgpIHsKICB0aGlzLnJlY29yZHMgPSBuZXcgTWFwKCkKICB0aGlzLnNpemUgPSAwCn0KClJlY29yZFN0b3JlLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiAobmFtZSwgcmVjb3JkLCB2YWx1ZSkgewogIHZhciByID0gdGhpcy5yZWNvcmRzLmdldChuYW1lKQoKICBpZiAoIXIpIHsKICAgIHIgPSBuZXcgUmVjb3JkU2V0KCkKICAgIHRoaXMucmVjb3Jkcy5zZXQobmFtZSwgcikKICB9CgogIGlmIChyLmFkZChyZWNvcmQsIHZhbHVlKSkgewogICAgdGhpcy5zaXplKysKICAgIHJldHVybiB0cnVlCiAgfQoKICByZXR1cm4gZmFsc2UKfQoKUmVjb3JkU3RvcmUucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIChuYW1lLCByZWNvcmQsIHZhbHVlKSB7CiAgdmFyIHIgPSB0aGlzLnJlY29yZHMuZ2V0KG5hbWUpCiAgaWYgKCFyKSByZXR1cm4gZmFsc2UKCiAgaWYgKHIucmVtb3ZlKHJlY29yZCwgdmFsdWUpKSB7CiAgICB0aGlzLnNpemUtLQogICAgaWYgKCFyLm1hcC5zaXplKSB0aGlzLnJlY29yZHMuZGVsZXRlKG5hbWUpCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgcmV0dXJuIGZhbHNlCn0KClJlY29yZFN0b3JlLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAobmFtZSkgewogIHZhciByID0gdGhpcy5yZWNvcmRzLmdldChuYW1lKQogIHJldHVybiByID8gci5saXN0IDogRU1QVFkKfQoKZnVuY3Rpb24gUmVjb3JkQ2FjaGUgKG9wdHMpIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUmVjb3JkQ2FjaGUpKSByZXR1cm4gbmV3IFJlY29yZENhY2hlKG9wdHMpCiAgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgdGhpcy5tYXhTaXplID0gb3B0cy5tYXhTaXplIHx8IEluZmluaXR5CiAgdGhpcy5tYXhBZ2UgPSBvcHRzLm1heEFnZSB8fCAwCgogIHRoaXMuX29uc3RhbGUgPSBvcHRzLm9uU3RhbGUgfHwgb3B0cy5vbnN0YWxlIHx8IG51bGwKICB0aGlzLl9mcmVzaCA9IG5ldyBSZWNvcmRTdG9yZSgpCiAgdGhpcy5fc3RhbGUgPSBuZXcgUmVjb3JkU3RvcmUoKQogIHRoaXMuX2ludGVydmFsID0gbnVsbAogIHRoaXMuX2djZWQgPSBmYWxzZQoKICBpZiAodGhpcy5tYXhBZ2UgJiYgdGhpcy5tYXhBZ2UgPCBJbmZpbml0eSkgewogICAgLy8gMi8zIGdpdmVzIHVzIGEgc3BhbiBvZiAwLjY2LTEuMzMgbWF4QWdlIG9yIGF2ZyBtYXhBZ2UKICAgIHZhciB0aWNrID0gTWF0aC5jZWlsKDIgLyAzICogdGhpcy5tYXhBZ2UpCiAgICB0aGlzLl9pbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuX2djQXV0by5iaW5kKHRoaXMpLCB0aWNrKQogICAgaWYgKHRoaXMuX2ludGVydmFsLnVucmVmKSB0aGlzLl9pbnRlcnZhbC51bnJlZigpCiAgfQp9CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUmVjb3JkQ2FjaGUucHJvdG90eXBlLCAnc2l6ZScsIHsKICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9mcmVzaC5zaXplICsgdGhpcy5fc3RhbGUuc2l6ZQogIH0KfSkKClJlY29yZENhY2hlLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiAobmFtZSwgcmVjb3JkLCB2YWx1ZSkgewogIHRoaXMuX3N0YWxlLnJlbW92ZShuYW1lLCByZWNvcmQsIHZhbHVlKQogIGlmICh0aGlzLl9mcmVzaC5hZGQobmFtZSwgcmVjb3JkLCB2YWx1ZSkgJiYgdGhpcy5fZnJlc2guc2l6ZSA+IHRoaXMubWF4U2l6ZSkgewogICAgdGhpcy5fZ2MoKQogIH0KfQoKUmVjb3JkQ2FjaGUucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIChuYW1lLCByZWNvcmQsIHZhbHVlKSB7CiAgdGhpcy5fZnJlc2gucmVtb3ZlKG5hbWUsIHJlY29yZCwgdmFsdWUpCiAgdGhpcy5fc3RhbGUucmVtb3ZlKG5hbWUsIHJlY29yZCwgdmFsdWUpCn0KClJlY29yZENhY2hlLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAobmFtZSwgbikgewogIHZhciBhID0gdGhpcy5fZnJlc2guZ2V0KG5hbWUpCiAgdmFyIGIgPSB0aGlzLl9zdGFsZS5nZXQobmFtZSkKICB2YXIgYUxlbiA9IGEubGVuZ3RoCiAgdmFyIGJMZW4gPSBiLmxlbmd0aAogIHZhciBsZW4gPSBhTGVuICsgYkxlbgoKICBpZiAobiA+IGxlbiB8fCAhbikgbiA9IGxlbgogIHZhciByZXN1bHQgPSBuZXcgQXJyYXkobikKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyBpKyspIHsKICAgIHZhciBqID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKGFMZW4gKyBiTGVuKSkKICAgIGlmIChqIDwgYUxlbikgewogICAgICByZXN1bHRbaV0gPSBhW2pdLnJlY29yZAogICAgICBzd2FwKGEsIGosIC0tYUxlbikKICAgIH0gZWxzZSB7CiAgICAgIGogLT0gYUxlbgogICAgICByZXN1bHRbaV0gPSBiW2pdLnJlY29yZAogICAgICBzd2FwKGIsIGosIC0tYkxlbikKICAgIH0KICB9CgogIHJldHVybiByZXN1bHQKfQoKUmVjb3JkQ2FjaGUucHJvdG90eXBlLl9nY0F1dG8gPSBmdW5jdGlvbiAoKSB7CiAgaWYgKCF0aGlzLl9nY2VkKSB0aGlzLl9nYygpCiAgdGhpcy5fZ2NlZCA9IGZhbHNlCn0KClJlY29yZENhY2hlLnByb3RvdHlwZS5fZ2MgPSBmdW5jdGlvbiAoKSB7CiAgaWYgKHRoaXMuX29uc3RhbGUgJiYgdGhpcy5fc3RhbGUuc2l6ZSA+IDApIHRoaXMuX29uc3RhbGUodGhpcy5fc3RhbGUpCiAgdGhpcy5fc3RhbGUgPSB0aGlzLl9mcmVzaAogIHRoaXMuX2ZyZXNoID0gbmV3IFJlY29yZFN0b3JlKCkKICB0aGlzLl9nY2VkID0gdHJ1ZQp9CgpSZWNvcmRDYWNoZS5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoKSB7CiAgdGhpcy5fZ2MoKQogIHRoaXMuX2djKCkKfQoKUmVjb3JkQ2FjaGUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CiAgdGhpcy5jbGVhcigpCiAgY2xlYXJJbnRlcnZhbCh0aGlzLl9pbnRlcnZhbCkKICB0aGlzLl9pbnRlcnZhbCA9IG51bGwKfQoKZnVuY3Rpb24gdG9TdHJpbmcgKHJlY29yZCkgewogIHJldHVybiBiNGEuaXNCdWZmZXIocmVjb3JkKSA/IGI0YS50b1N0cmluZyhyZWNvcmQsICdoZXgnKSA6IHJlY29yZAp9CgpmdW5jdGlvbiBzd2FwIChsaXN0LCBhLCBiKSB7CiAgdmFyIHRtcCA9IGxpc3RbYV0KICB0bXAuaW5kZXggPSBiCiAgbGlzdFtiXS5pbmRleCA9IGEKICBsaXN0W2FdID0gbGlzdFtiXQogIGxpc3RbYl0gPSB0bXAKfQp7CiAgIm5hbWUiOiAicmVjb3JkLWNhY2hlIiwKICAidmVyc2lvbiI6ICIxLjIuMCIsCiAgImRlc2NyaXB0aW9uIjogIkNhY2hlIG9wdGltaXNlZCBmb3IgcmVjb3JkIGxpa2UgdGhpbmdzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuMy4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTAuMC4zIiwKICAgICJ0YXBlIjogIl40LjguMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgdGFwZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3JlY29yZC1jYWNoZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcmVjb3JkLWNhY2hlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3JlY29yZC1jYWNoZSIKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJlZkNvdW50ZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5jb3VudCA9IDAKCiAgICB0aGlzLl9vbmlkbGUgPSBudWxsCiAgICB0aGlzLl9pZGxlID0gbnVsbAogIH0KCiAgaXNJZGxlKCkgewogICAgcmV0dXJuIHRoaXMuY291bnQgPT09IDAKICB9CgogIGlkbGUoKSB7CiAgICBpZiAodGhpcy5jb3VudCA9PT0gMCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCiAgICBpZiAodGhpcy5faWRsZSAhPT0gbnVsbCkgcmV0dXJuIHRoaXMuX2lkbGUKCiAgICB0aGlzLl9pZGxlID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgdGhpcy5fb25pZGxlID0gcmVzb2x2ZQogICAgfSkKCiAgICByZXR1cm4gdGhpcy5faWRsZQogIH0KCiAgaW5jKCkgewogICAgdGhpcy5jb3VudCsrCiAgfQoKICBkZWMoKSB7CiAgICBpZiAoLS10aGlzLmNvdW50ID4gMCkgcmV0dXJuCgogICAgaWYgKHRoaXMuX29uaWRsZSAhPT0gbnVsbCkgewogICAgICBjb25zdCByZXNvbHZlID0gdGhpcy5fb25pZGxlCiAgICAgIHRoaXMuX2lkbGUgPSBudWxsCiAgICAgIHRoaXMuX29uaWRsZSA9IG51bGwKICAgICAgcmVzb2x2ZSgpCiAgICB9CiAgfQp9CnsKICAibmFtZSI6ICJyZWZjb3VudGVyIiwKICAidmVyc2lvbiI6ICIxLjAuMCIsCiAgImRlc2NyaXB0aW9uIjogIlNpbXBsZSByZWZjb3VudGVyIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7fSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yZWZjb3VudGVyLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYyIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yZWZjb3VudGVyL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVmY291bnRlciIKfQptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUuYWRkb24uYmluZChyZXF1aXJlKQp7CiAgIm5hbWUiOiAicmVxdWlyZS1hZGRvbiIsCiAgInZlcnNpb24iOiAiMS4yLjAiLAogICJkZXNjcmlwdGlvbiI6ICJJbXBvcnQgbmF0aXZlIGFkZG9ucyBhY3Jvc3MgSmF2YVNjcmlwdCBydW50aW1lcyIsCiAgImV4cG9ydHMiOiB7CiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuIjogewogICAgICAiYmFyZSI6ICIuL2xpYi9iYXJlLmpzIiwKICAgICAgIm5vZGUiOiAiLi9saWIvbm9kZS5qcyIsCiAgICAgICJkZWZhdWx0IjogIi4vbGliL2RlZmF1bHQuanMiCiAgICB9CiAgfSwKICAiaW1wb3J0cyI6IHsKICAgICJmcyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1mcyIsCiAgICAgICJkZWZhdWx0IjogImZzIgogICAgfSwKICAgICJwYXRoIjogewogICAgICAiYmFyZSI6ICJiYXJlLXBhdGgiLAogICAgICAiZGVmYXVsdCI6ICJwYXRoIgogICAgfSwKICAgICJ1cmwiOiB7CiAgICAgICJiYXJlIjogImJhcmUtdXJsIiwKICAgICAgImRlZmF1bHQiOiAidXJsIgogICAgfQogIH0sCiAgImZpbGVzIjogWwogICAgImxpYiIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAibnBtIHJ1biBsaW50ICYmIG5wbSBydW4gdGVzdDpiYXJlICYmIG5wbSBydW4gdGVzdDpub2RlIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0LmpzIiwKICAgICJ0ZXN0Om5vZGUiOiAibm9kZSB0ZXN0LmpzIiwKICAgICJsaW50IjogInByZXR0aWVyIC0tY2hlY2sgLiIsCiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yZXF1aXJlLWFkZG9uLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JlcXVpcmUtYWRkb24vaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yZXF1aXJlLWFkZG9uI3JlYWRtZSIsCiAgImVuZ2luZXMiOiB7CiAgICAiYmFyZSI6ICI+PTEuMTAuMCIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1hZGRvbi1yZXNvbHZlIjogIl4xLjMuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1idW5kbGUiOiAiXjEuOC4xIiwKICAgICJiYXJlLWJ1bmRsZS1ldmFsdWF0ZSI6ICJeMS4xLjAiLAogICAgImJhcmUtZnMiOiAiXjQuMC4wIiwKICAgICJiYXJlLXBhdGgiOiAiXjMuMC4wIiwKICAgICJiYXJlLXVybCI6ICJeMi4xLjAiLAogICAgImJyaXR0bGUiOiAiXjMuNy4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0KfQpsZXQgdG1wUmVzb2x2ZSA9IG51bGwKbGV0IHRtcFJlamVjdCA9IG51bGwKCmlmIChQcm9taXNlLndpdGhSZXNvbHZlcnMpIHsKICBtb2R1bGUuZXhwb3J0cyA9IFByb21pc2Uud2l0aFJlc29sdmVycy5iaW5kKFByb21pc2UpCn0gZWxzZSB7CiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiByZXNvbHZlUmVqZWN0UHJvbWlzZSAoKSB7CiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2Uoc2V0VG1wKQogICAgY29uc3QgcmVzdWx0ID0geyBwcm9taXNlLCByZXNvbHZlOiB0bXBSZXNvbHZlLCByZWplY3Q6IHRtcFJlamVjdCB9CiAgICB0bXBSZXNvbHZlID0gdG1wUmVqZWN0ID0gbnVsbAogICAgcmV0dXJuIHJlc3VsdAogIH0KfQoKZnVuY3Rpb24gc2V0VG1wIChyZXNvbHZlLCByZWplY3QpIHsKICB0bXBSZXNvbHZlID0gcmVzb2x2ZQogIHRtcFJlamVjdCA9IHJlamVjdAp9CnsKICAibmFtZSI6ICJyZXNvbHZlLXJlamVjdC1wcm9taXNlIiwKICAidmVyc2lvbiI6ICIxLjEuMCIsCiAgImRlc2NyaXB0aW9uIjogIkNyZWF0ZSBhbiBpbnZlcnRlZCBwcm9taXNlIHdpdGggbm8gZnVuY3Rpb24gYWxsb2NzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMiIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9yZXNvbHZlLXJlamVjdC1wcm9taXNlLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9yZXNvbHZlLXJlamVjdC1wcm9taXNlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3Jlc29sdmUtcmVqZWN0LXByb21pc2UiCn0KY29uc3QgcmVzb3VyY2VzID0gbmV3IE1hcCgpCgpleHBvcnRzLmFkZCA9IGZ1bmN0aW9uKHJlc291cmNlLCB0ZWFyZG93bikgewogIHJlc291cmNlcy5zZXQocmVzb3VyY2UsIHRlYXJkb3duKQp9CgpleHBvcnRzLnJlbW92ZSA9IGZ1bmN0aW9uKHJlc291cmNlKSB7CiAgcmVzb3VyY2VzLmRlbGV0ZShyZXNvdXJjZSkKfQoKaWYgKGdsb2JhbC5CYXJlKSBnbG9iYWwuQmFyZS5vbignZXhpdCcsIHJ1bikKZWxzZSBnbG9iYWwucHJvY2Vzcy5vbignZXhpdCcsIHJ1bikKCmZ1bmN0aW9uIHJ1bigpIHsKICBmb3IgKGNvbnN0IFtyZXNvdXJjZSwgdGVhcmRvd25dIG9mIHJlc291cmNlcykgewogICAgdGVhcmRvd24ocmVzb3VyY2UpCiAgfQp9CnsKICAibmFtZSI6ICJyZXNvdXJjZS1vbi1leGl0IiwKICAidmVyc2lvbiI6ICIxLjAuMCIsCiAgImRlc2NyaXB0aW9uIjogIlJlZ2lzdGVyIHN5bmMgdGVhcmRvd24gaGFuZGxlcnMgZm9yIGEgcmVzb3VyY2UiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHt9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtdGVhcmRvd24uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2ggSW5jLiIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXRlYXJkb3duL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS10ZWFyZG93biIKfQpyZXF1aXJlLmFkZG9uID0gcmVxdWlyZSgncmVxdWlyZS1hZGRvbicpCgptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUuYWRkb24oJy4nLCBfX2ZpbGVuYW1lKQpjb25zdCBDb2x1bW5GYW1pbHkgPSByZXF1aXJlKCcuL2xpYi9jb2x1bW4tZmFtaWx5JykKY29uc3QgSXRlcmF0b3IgPSByZXF1aXJlKCcuL2xpYi9pdGVyYXRvcicpCmNvbnN0IFNuYXBzaG90ID0gcmVxdWlyZSgnLi9saWIvc25hcHNob3QnKQpjb25zdCBTdGF0ZSA9IHJlcXVpcmUoJy4vbGliL3N0YXRlJykKY29uc3QgeyBCbG9vbUZpbHRlclBvbGljeSwgUmliYm9uRmlsdGVyUG9saWN5IH0gPSByZXF1aXJlKCcuL2xpYi9maWx0ZXItcG9saWN5JykKY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9saWIvY29uc3RhbnRzJykKCmNsYXNzIFJvY2tzREIgewogIGNvbnN0cnVjdG9yKHBhdGgsIG9wdHMgPSB7fSkgewogICAgY29uc3QgewogICAgICBjb2x1bW5GYW1pbHksCiAgICAgIHN0YXRlID0gbmV3IFN0YXRlKHRoaXMsIHBhdGgsIG9wdHMpLAogICAgICBzbmFwc2hvdCA9IG51bGwsCiAgICAgIGtleUVuY29kaW5nID0gbnVsbCwKICAgICAgdmFsdWVFbmNvZGluZyA9IG51bGwKICAgIH0gPSBvcHRzCgogICAgdGhpcy5fc3RhdGUgPSBzdGF0ZQogICAgdGhpcy5fc25hcHNob3QgPSBzbmFwc2hvdAogICAgdGhpcy5fY29sdW1uRmFtaWx5ID0gc3RhdGUuZ2V0Q29sdW1uRmFtaWx5KGNvbHVtbkZhbWlseSkKICAgIHRoaXMuX2tleUVuY29kaW5nID0ga2V5RW5jb2RpbmcKICAgIHRoaXMuX3ZhbHVlRW5jb2RpbmcgPSB2YWx1ZUVuY29kaW5nCiAgICB0aGlzLl9pbmRleCA9IC0xCgogICAgdGhpcy5fc3RhdGUuYWRkU2Vzc2lvbih0aGlzKQogIH0KCiAgZ2V0IG9wZW5lZCgpIHsKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5vcGVuZWQKICB9CgogIGdldCBjbG9zZWQoKSB7CiAgICByZXR1cm4gdGhpcy5pc1Jvb3QoKSA/IHRoaXMuX3N0YXRlLmNsb3NlZCA6IHRoaXMuX2luZGV4ID09PSAtMQogIH0KCiAgZ2V0IHBhdGgoKSB7CiAgICByZXR1cm4gdGhpcy5fc3RhdGUucGF0aAogIH0KCiAgZ2V0IHNuYXBzaG90dGVkKCkgewogICAgcmV0dXJuIHRoaXMuX3NuYXBzaG90ICE9PSBudWxsCiAgfQoKICBnZXQgZGVmYXVsdENvbHVtbkZhbWlseSgpIHsKICAgIHJldHVybiB0aGlzLl9jb2x1bW5GYW1pbHkKICB9CgogIHNlc3Npb24oewogICAgY29sdW1uRmFtaWx5ID0gdGhpcy5fY29sdW1uRmFtaWx5LAogICAgc25hcHNob3QgPSB0aGlzLl9zbmFwc2hvdCAhPT0gbnVsbCwKICAgIGtleUVuY29kaW5nID0gdGhpcy5fa2V5RW5jb2RpbmcsCiAgICB2YWx1ZUVuY29kaW5nID0gdGhpcy5fdmFsdWVFbmNvZGluZwogIH0gPSB7fSkgewogICAgbWF5YmVDbG9zZWQodGhpcykKCiAgICByZXR1cm4gbmV3IFJvY2tzREIobnVsbCwgewogICAgICBzdGF0ZTogdGhpcy5fc3RhdGUsCiAgICAgIGNvbHVtbkZhbWlseSwKICAgICAgc25hcHNob3Q6IHNuYXBzaG90ID8gdGhpcy5fc25hcHNob3QgfHwgbmV3IFNuYXBzaG90KHRoaXMuX3N0YXRlKSA6IG51bGwsCiAgICAgIGtleUVuY29kaW5nLAogICAgICB2YWx1ZUVuY29kaW5nCiAgICB9KQogIH0KCiAgY29sdW1uRmFtaWx5KG5hbWUsIG9wdHMpIHsKICAgIHJldHVybiB0aGlzLnNlc3Npb24oeyAuLi5vcHRzLCBjb2x1bW5GYW1pbHk6IG5hbWUgfSkKICB9CgogIHNuYXBzaG90KCkgewogICAgcmV0dXJuIHRoaXMuc2Vzc2lvbih7IHNuYXBzaG90OiB0cnVlIH0pCiAgfQoKICBpc1Jvb3QoKSB7CiAgICByZXR1cm4gdGhpcyA9PT0gdGhpcy5fc3RhdGUuZGIKICB9CgogIHJlYWR5KCkgewogICAgcmV0dXJuIHRoaXMuX3N0YXRlLnJlYWR5KCkKICB9CgogIGFzeW5jIGNsb3NlKHsgZm9yY2UgfSA9IHt9KSB7CiAgICBpZiAoIXRoaXMuX3N0YXRlLm9wZW5lZCkgYXdhaXQgdGhpcy5fc3RhdGUucmVhZHkoKQoKICAgIGlmICh0aGlzLl9pbmRleCAhPT0gLTEpIHRoaXMuX3N0YXRlLnJlbW92ZVNlc3Npb24odGhpcykKCiAgICBpZiAoZm9yY2UpIHsKICAgICAgd2hpbGUgKHRoaXMuX3N0YXRlLnNlc3Npb25zLmxlbmd0aCA+IDApIHsKICAgICAgICBhd2FpdCB0aGlzLl9zdGF0ZS5zZXNzaW9uc1t0aGlzLl9zdGF0ZS5zZXNzaW9ucy5sZW5ndGggLSAxXS5jbG9zZSgpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGhpcy5pc1Jvb3QoKSA/IHRoaXMuX3N0YXRlLmNsb3NlKCkgOiBQcm9taXNlLnJlc29sdmUoKQogIH0KCiAgc3VzcGVuZCgpIHsKICAgIG1heWJlQ2xvc2VkKHRoaXMpCgogICAgcmV0dXJuIHRoaXMuX3N0YXRlLnN1c3BlbmQoKQogIH0KCiAgcmVzdW1lKCkgewogICAgbWF5YmVDbG9zZWQodGhpcykKCiAgICByZXR1cm4gdGhpcy5fc3RhdGUucmVzdW1lKCkKICB9CgogIGlzSWRsZSgpIHsKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5oYW5kbGVzLmlzSWRsZSgpCiAgfQoKICBpZGxlKCkgewogICAgcmV0dXJuIHRoaXMuX3N0YXRlLmhhbmRsZXMuaWRsZSgpCiAgfQoKICBpdGVyYXRvcihyYW5nZSwgb3B0cykgewogICAgbWF5YmVDbG9zZWQodGhpcykKCiAgICByZXR1cm4gbmV3IEl0ZXJhdG9yKHRoaXMsIHsgLi4ucmFuZ2UsIC4uLm9wdHMgfSkKICB9CgogIGFzeW5jICprZXlzKHJhbmdlLCBvcHRzKSB7CiAgICBmb3IgYXdhaXQgKGNvbnN0IHsga2V5IH0gb2YgdGhpcy5pdGVyYXRvcihyYW5nZSwgewogICAgICAuLi5vcHRzLAogICAgICB2YWx1ZXM6IGZhbHNlCiAgICB9KSkgewogICAgICB5aWVsZCBrZXkKICAgIH0KICB9CgogIGFzeW5jIHBlZWsocmFuZ2UsIG9wdHMpIHsKICAgIGZvciBhd2FpdCAoY29uc3QgdmFsdWUgb2YgdGhpcy5pdGVyYXRvcih7IC4uLnJhbmdlLCAuLi5vcHRzLCBsaW1pdDogMSB9KSkgewogICAgICByZXR1cm4gdmFsdWUKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgcmVhZChvcHRzKSB7CiAgICBtYXliZUNsb3NlZCh0aGlzKQoKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5jcmVhdGVSZWFkQmF0Y2godGhpcywgb3B0cykKICB9CgogIHdyaXRlKG9wdHMpIHsKICAgIG1heWJlQ2xvc2VkKHRoaXMpCgogICAgcmV0dXJuIHRoaXMuX3N0YXRlLmNyZWF0ZVdyaXRlQmF0Y2godGhpcywgb3B0cykKICB9CgogIGZsdXNoKG9wdHMpIHsKICAgIG1heWJlQ2xvc2VkKHRoaXMpCgogICAgcmV0dXJuIHRoaXMuX3N0YXRlLmZsdXNoKHRoaXMsIG9wdHMpCiAgfQoKICBhc3luYyBnZXQoa2V5LCBvcHRzKSB7CiAgICBjb25zdCBiYXRjaCA9IHRoaXMucmVhZCh7IC4uLm9wdHMsIGNhcGFjaXR5OiAxLCBhdXRvRGVzdHJveTogdHJ1ZSB9KQogICAgY29uc3QgdmFsdWUgPSBiYXRjaC5nZXQoa2V5KQogICAgYmF0Y2gudHJ5Rmx1c2goKQogICAgcmV0dXJuIHZhbHVlCiAgfQoKICBhc3luYyBwdXQoa2V5LCB2YWx1ZSwgb3B0cykgewogICAgY29uc3QgYmF0Y2ggPSB0aGlzLndyaXRlKHsgLi4ub3B0cywgY2FwYWNpdHk6IDEsIGF1dG9EZXN0cm95OiB0cnVlIH0pCiAgICBiYXRjaC50cnlQdXQoa2V5LCB2YWx1ZSkKICAgIGF3YWl0IGJhdGNoLmZsdXNoKCkKICB9CgogIGFzeW5jIGRlbGV0ZShrZXksIG9wdHMpIHsKICAgIGNvbnN0IGJhdGNoID0gdGhpcy53cml0ZSh7IC4uLm9wdHMsIGNhcGFjaXR5OiAxLCBhdXRvRGVzdHJveTogdHJ1ZSB9KQogICAgYmF0Y2gudHJ5RGVsZXRlKGtleSkKICAgIGF3YWl0IGJhdGNoLmZsdXNoKCkKICB9CgogIGFzeW5jIGRlbGV0ZVJhbmdlKHN0YXJ0LCBlbmQsIG9wdHMpIHsKICAgIGNvbnN0IGJhdGNoID0gdGhpcy53cml0ZSh7IC4uLm9wdHMsIGNhcGFjaXR5OiAxLCBhdXRvRGVzdHJveTogdHJ1ZSB9KQogICAgYmF0Y2gudHJ5RGVsZXRlUmFuZ2Uoc3RhcnQsIGVuZCkKICAgIGF3YWl0IGJhdGNoLmZsdXNoKCkKICB9CgogIGFzeW5jIGNvbXBhY3RSYW5nZShzdGFydCA9IG51bGwsIGVuZCA9IG51bGwsIG9wdHMgPSB7fSkgewogICAgaWYgKHR5cGVvZiBlbmQgPT09ICdvYmplY3QnICYmIGVuZCAhPT0gbnVsbCkgewogICAgICBvcHRzID0gZW5kCiAgICAgIGVuZCA9IG51bGwKICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0YXJ0ID09PSAnb2JqZWN0JyAmJiBzdGFydCAhPT0gbnVsbCkgewogICAgICBvcHRzID0gc3RhcnQKICAgICAgc3RhcnQgPSBudWxsCiAgICAgIGVuZCA9IG51bGwKICAgIH0KCiAgICBhd2FpdCB0aGlzLl9zdGF0ZS5jb21wYWN0UmFuZ2UodGhpcywgc3RhcnQsIGVuZCwgb3B0cykKICB9CgogIGFzeW5jIGFwcHJveGltYXRlU2l6ZShzdGFydCwgZW5kLCBvcHRzID0ge30pIHsKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5hcHByb3hpbWF0ZVNpemUodGhpcywgc3RhcnQsIGVuZCwgb3B0cykKICB9CgogIF9yZWYoKSB7CiAgICBpZiAodGhpcy5fc25hcHNob3QpIHRoaXMuX3NuYXBzaG90LnJlZigpCiAgICB0aGlzLl9zdGF0ZS5oYW5kbGVzLmluYygpCiAgfQoKICBfdW5yZWYoKSB7CiAgICBpZiAodGhpcy5fc25hcHNob3QpIHRoaXMuX3NuYXBzaG90LnVucmVmKCkKICAgIHRoaXMuX3N0YXRlLmhhbmRsZXMuZGVjKCkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IFJvY2tzREIKCmV4cG9ydHMuY29uc3RhbnRzID0gY29uc3RhbnRzCgpleHBvcnRzLkNvbHVtbkZhbWlseSA9IENvbHVtbkZhbWlseQpleHBvcnRzLkJsb29tRmlsdGVyUG9saWN5ID0gQmxvb21GaWx0ZXJQb2xpY3kKZXhwb3J0cy5SaWJib25GaWx0ZXJQb2xpY3kgPSBSaWJib25GaWx0ZXJQb2xpY3kKCmZ1bmN0aW9uIG1heWJlQ2xvc2VkKGRiKSB7CiAgaWYgKGRiLl9zdGF0ZS5jbG9zaW5nIHx8IGRiLl9pbmRleCA9PT0gLTEpIHRocm93IG5ldyBFcnJvcignUm9ja3NEQiBzZXNzaW9uIGlzIGNsb3NlZCcpCn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCgpjb25zdCBlbXB0eSA9IEJ1ZmZlci5hbGxvYygwKQpjb25zdCByZXNvbHZlZCA9IFByb21pc2UucmVzb2x2ZSgpCgpjbGFzcyBSb2Nrc0RCQmF0Y2ggewogIGNvbnN0cnVjdG9yKGRiLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgY2FwYWNpdHkgPSA4LCBhdXRvRGVzdHJveSA9IGZhbHNlIH0gPSBvcHRzCgogICAgZGIuX3JlZigpCgogICAgdGhpcy5fZGIgPSBkYgogICAgdGhpcy5fZGVzdHJveWVkID0gZmFsc2UKICAgIHRoaXMuX2NhcGFjaXR5ID0gY2FwYWNpdHkKICAgIHRoaXMuX29wZXJhdGlvbnMgPSBbXQogICAgdGhpcy5fcHJvbWlzZXMgPSBbXQoKICAgIHRoaXMuX2VucXVldWVQcm9taXNlID0gdGhpcy5fZW5xdWV1ZVByb21pc2UuYmluZCh0aGlzKQoKICAgIHRoaXMuX3JlcXVlc3QgPSBudWxsCiAgICB0aGlzLl9yZXNvbHZlID0gbnVsbAogICAgdGhpcy5fcmVqZWN0ID0gbnVsbAoKICAgIHRoaXMuX2hhbmRsZSA9IG51bGwKICAgIHRoaXMuX2J1ZmZlciA9IG51bGwKICAgIHRoaXMuX2F1dG9EZXN0cm95ID0gYXV0b0Rlc3Ryb3kKCiAgICBpZiAoZGIuX3N0YXRlLm9wZW5lZCA9PT0gdHJ1ZSkgdGhpcy5yZWFkeSgpCiAgfQoKICBfcmV1c2UoZGIsIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyBhdXRvRGVzdHJveSA9IGZhbHNlIH0gPSBvcHRzCgogICAgZGIuX3JlZigpCgogICAgdGhpcy5fZGIgPSBkYgogICAgdGhpcy5fZGVzdHJveWVkID0gZmFsc2UKICAgIHRoaXMuX2F1dG9EZXN0cm95ID0gYXV0b0Rlc3Ryb3kKICB9CgogIF9vbmZpbmlzaGVkKGVycikgewogICAgY29uc3QgcmVzb2x2ZSA9IHRoaXMuX3Jlc29sdmUKICAgIGNvbnN0IHJlamVjdCA9IHRoaXMuX3JlamVjdAoKICAgIGlmICh0aGlzLl9yZXF1ZXN0KSB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKCiAgICB0aGlzLl9vcGVyYXRpb25zID0gW10KICAgIHRoaXMuX3Byb21pc2VzID0gW10KICAgIHRoaXMuX3JlcXVlc3QgPSBudWxsCiAgICB0aGlzLl9yZXNvbHZlID0gbnVsbAogICAgdGhpcy5fcmVqZWN0ID0gbnVsbAoKICAgIGlmICh0aGlzLl9hdXRvRGVzdHJveSA9PT0gdHJ1ZSkgdGhpcy5kZXN0cm95KCkKCiAgICBpZiAocmVqZWN0ICE9PSBudWxsICYmIGVycikgcmVqZWN0KGVycikKICAgIGVsc2UgaWYgKHJlc29sdmUgIT09IG51bGwpIHJlc29sdmUoKQogIH0KCiAgX3Jlc2l6ZSgpIHsKICAgIGlmICh0aGlzLl9vcGVyYXRpb25zLmxlbmd0aCA8PSB0aGlzLl9jYXBhY2l0eSkgcmV0dXJuIGZhbHNlCgogICAgd2hpbGUgKHRoaXMuX29wZXJhdGlvbnMubGVuZ3RoID4gdGhpcy5fY2FwYWNpdHkpIHsKICAgICAgdGhpcy5fY2FwYWNpdHkgKj0gMgogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyByZWFkeSgpIHsKICAgIGlmICh0aGlzLl9oYW5kbGUgIT09IG51bGwpIHJldHVybgoKICAgIGlmICh0aGlzLl9kYi5fc3RhdGUub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5fZGIuX3N0YXRlLnJlYWR5KCkKCiAgICB0aGlzLl9pbml0KCkKICB9CgogIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGluIHByb2dyZXNzJykKICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHJldHVybgoKICAgIHRoaXMuX2Rlc3Ryb3llZCA9IHRydWUKCiAgICBpZiAodGhpcy5fcHJvbWlzZXMubGVuZ3RoKSB0aGlzLl9hYm9ydCgpCgogICAgdGhpcy5fZGIuX3VucmVmKCkKICAgIHRoaXMuX29uZnJlZSgpCiAgfQoKICBfb25mcmVlKCkgewogICAgdGhpcy5fZGIuX3N0YXRlLmZyZWVCYXRjaCh0aGlzLCBmYWxzZSkKICAgIHRoaXMuX2RiID0gbnVsbAogIH0KCiAgX2Fib3J0KCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9wcm9taXNlcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBwcm9taXNlID0gdGhpcy5fcHJvbWlzZXNbaV0KICAgICAgaWYgKHByb21pc2UgIT09IG51bGwpIHByb21pc2UucmVqZWN0KG5ldyBFcnJvcignQmF0Y2ggaXMgZGVzdHJveWVkJykpCiAgICB9CgogICAgdGhpcy5fb25maW5pc2hlZChuZXcgRXJyb3IoJ0JhdGNoIGlzIGRlc3Ryb3llZCcpKQogIH0KCiAgYXN5bmMgZmx1c2goKSB7CiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGluIHByb2dyZXNzJykKICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcignQmF0Y2ggaXMgZGVzdHJveWVkJykKCiAgICB0aGlzLl9yZXF1ZXN0ID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICB0aGlzLl9yZXNvbHZlID0gcmVzb2x2ZQogICAgICB0aGlzLl9yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgdGhpcy5fZmx1c2goKQoKICAgIHJldHVybiB0aGlzLl9yZXF1ZXN0CiAgfQoKICB0cnlGbHVzaCgpIHsKICAgIGlmICh0aGlzLl9yZXF1ZXN0KSB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgaW4gcHJvZ3Jlc3MnKQogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdCYXRjaCBpcyBkZXN0cm95ZWQnKQoKICAgIHRoaXMuX3JlcXVlc3QgPSByZXNvbHZlZAoKICAgIHRoaXMuX2ZsdXNoKCkKICB9CgogIGFzeW5jIF9mbHVzaCgpIHsKICAgIGlmICh0aGlzLl9oYW5kbGUgPT09IG51bGwpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5pbmMoKQoKICAgIGlmICh0aGlzLl9kYi5fc3RhdGUucmVzdW1lZCAhPT0gbnVsbCkgewogICAgICBjb25zdCByZXN1bWVkID0gYXdhaXQgdGhpcy5fZGIuX3N0YXRlLnJlc3VtZWQucHJvbWlzZQoKICAgICAgaWYgKCFyZXN1bWVkKSB7CiAgICAgICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgewogICAgICAgICAgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX2Rlc3Ryb3llZCA9IHRydWUKICAgICAgICAgIHRoaXMuX2Fib3J0KCkKICAgICAgICAgIHRoaXMuX2RiLl91bnJlZigpCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBfZW5xdWV1ZVByb21pc2UocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICB0aGlzLl9wcm9taXNlcy5wdXNoKHsgcmVzb2x2ZSwgcmVqZWN0IH0pCiAgfQoKICBfZW5jb2RlS2V5KGspIHsKICAgIGlmICh0aGlzLl9kYi5fa2V5RW5jb2RpbmcpIHJldHVybiBjLmVuY29kZSh0aGlzLl9kYi5fa2V5RW5jb2RpbmcsIGspCiAgICBpZiAodHlwZW9mIGsgPT09ICdzdHJpbmcnKSByZXR1cm4gQnVmZmVyLmZyb20oaykKICAgIHJldHVybiBrCiAgfQoKICBfZW5jb2RlVmFsdWUodikgewogICAgaWYgKHRoaXMuX2RiLl92YWx1ZUVuY29kaW5nKSByZXR1cm4gYy5lbmNvZGUodGhpcy5fZGIuX3ZhbHVlRW5jb2RpbmcsIHYpCiAgICBpZiAodiA9PT0gbnVsbCkgcmV0dXJuIGVtcHR5CiAgICBpZiAodHlwZW9mIHYgPT09ICdzdHJpbmcnKSByZXR1cm4gQnVmZmVyLmZyb20odikKICAgIHJldHVybiB2CiAgfQoKICBfZGVjb2RlVmFsdWUoYikgewogICAgaWYgKHRoaXMuX2RiLl92YWx1ZUVuY29kaW5nKSByZXR1cm4gYy5kZWNvZGUodGhpcy5fZGIuX3ZhbHVlRW5jb2RpbmcsIGIpCiAgICByZXR1cm4gYgogIH0KfQoKZXhwb3J0cy5SZWFkQmF0Y2ggPSBjbGFzcyBSb2Nrc0RCUmVhZEJhdGNoIGV4dGVuZHMgUm9ja3NEQkJhdGNoIHsKICBjb25zdHJ1Y3RvcihkYiwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcihkYiwgb3B0cykKCiAgICBjb25zdCB7IGFzeW5jSU8gPSBmYWxzZSwgZmlsbENhY2hlID0gdHJ1ZSB9ID0gb3B0cwoKICAgIHRoaXMuX2FzeW5jSU8gPSBhc3luY0lPCiAgICB0aGlzLl9maWxsQ2FjaGUgPSBmaWxsQ2FjaGUKICB9CgogIF9pbml0KCkgewogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5yZWFkSW5pdCgpCiAgICB0aGlzLl9idWZmZXIgPSBiaW5kaW5nLnJlYWRCdWZmZXIodGhpcy5faGFuZGxlLCB0aGlzLl9jYXBhY2l0eSkKICB9CgogIF9yZXNpemUoKSB7CiAgICBpZiAoc3VwZXIuX3Jlc2l6ZSgpICYmIHRoaXMuX2hhbmRsZSAhPT0gbnVsbCkgewogICAgICB0aGlzLl9idWZmZXIgPSBiaW5kaW5nLnJlYWRCdWZmZXIodGhpcy5faGFuZGxlLCB0aGlzLl9jYXBhY2l0eSkKICAgIH0KICB9CgogIGFzeW5jIF9mbHVzaCgpIHsKICAgIGF3YWl0IHN1cGVyLl9mbHVzaCgpCgogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgcmV0dXJuCgogICAgdHJ5IHsKICAgICAgYmluZGluZy5yZWFkKAogICAgICAgIHRoaXMuX2RiLl9zdGF0ZS5faGFuZGxlLAogICAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgICB0aGlzLl9vcGVyYXRpb25zLAogICAgICAgIHRoaXMuX2RiLl9zbmFwc2hvdCA/IHRoaXMuX2RiLl9zbmFwc2hvdC5faGFuZGxlIDogdW5kZWZpbmVkLAogICAgICAgIHRoaXMuX2FzeW5jSU8sCiAgICAgICAgdGhpcy5fZmlsbENhY2hlLAogICAgICAgIHRoaXMsCiAgICAgICAgdGhpcy5fb25yZWFkCiAgICAgICkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKICAgICAgdGhyb3cgZXJyCiAgICB9CiAgfQoKICBfb25yZWFkKGVycnMsIHZhbHVlcykgewogICAgbGV0IGFwcGxpZWQgPSB0cnVlCgogICAgZm9yIChsZXQgaSA9IDAsIG4gPSB0aGlzLl9wcm9taXNlcy5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgY29uc3QgZXJyID0gZXJyc1tpXQogICAgICBpZiAoZXJyKSBhcHBsaWVkID0gZmFsc2UKCiAgICAgIGNvbnN0IHByb21pc2UgPSB0aGlzLl9wcm9taXNlc1tpXQogICAgICBpZiAocHJvbWlzZSA9PT0gbnVsbCkgY29udGludWUKCiAgICAgIGlmIChlcnIpIHByb21pc2UucmVqZWN0KG5ldyBFcnJvcihlcnIpKQogICAgICBlbHNlIHByb21pc2UucmVzb2x2ZSh2YWx1ZXNbaV0gPyB0aGlzLl9kZWNvZGVWYWx1ZShCdWZmZXIuZnJvbSh2YWx1ZXNbaV0pKSA6IG51bGwpCiAgICB9CgogICAgdGhpcy5fb25maW5pc2hlZChhcHBsaWVkID8gbnVsbCA6IG5ldyBFcnJvcignQmF0Y2ggd2FzIG5vdCBhcHBsaWVkJykpCiAgfQoKICBnZXQoa2V5KSB7CiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGFscmVhZHkgaW4gcHJvZ3Jlc3MnKQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSh0aGlzLl9lbnF1ZXVlUHJvbWlzZSkKCiAgICB0aGlzLl9vcGVyYXRpb25zLnB1c2gobmV3IFJvY2tzREJHZXQodGhpcy5fZW5jb2RlS2V5KGtleSksIHRoaXMuX2RiLl9jb2x1bW5GYW1pbHkpKQoKICAgIHRoaXMuX3Jlc2l6ZSgpCgogICAgcmV0dXJuIHByb21pc2UKICB9Cn0KCmV4cG9ydHMuV3JpdGVCYXRjaCA9IGNsYXNzIFJvY2tzREJXcml0ZUJhdGNoIGV4dGVuZHMgUm9ja3NEQkJhdGNoIHsKICBfaW5pdCgpIHsKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcud3JpdGVJbml0KCkKICAgIHRoaXMuX2J1ZmZlciA9IGJpbmRpbmcud3JpdGVCdWZmZXIodGhpcy5faGFuZGxlLCB0aGlzLl9jYXBhY2l0eSkKICB9CgogIF9yZXNpemUoKSB7CiAgICBpZiAoc3VwZXIuX3Jlc2l6ZSgpICYmIHRoaXMuX2hhbmRsZSAhPT0gbnVsbCkgewogICAgICB0aGlzLl9idWZmZXIgPSBiaW5kaW5nLndyaXRlQnVmZmVyKHRoaXMuX2hhbmRsZSwgdGhpcy5fY2FwYWNpdHkpCiAgICB9CiAgfQoKICBfb25mcmVlKCkgewogICAgdGhpcy5fZGIuX3N0YXRlLmZyZWVCYXRjaCh0aGlzLCB0cnVlKQogIH0KCiAgYXN5bmMgX2ZsdXNoKCkgewogICAgYXdhaXQgc3VwZXIuX2ZsdXNoKCkKCiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSByZXR1cm4KCiAgICB0cnkgewogICAgICBiaW5kaW5nLndyaXRlKHRoaXMuX2RiLl9zdGF0ZS5faGFuZGxlLCB0aGlzLl9oYW5kbGUsIHRoaXMuX29wZXJhdGlvbnMsIHRoaXMsIHRoaXMuX29ud3JpdGUpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCiAgICAgIHRocm93IGVycgogICAgfQogIH0KCiAgX29ud3JpdGUoZXJyKSB7CiAgICBjb25zdCBhcHBsaWVkID0gIWVycgoKICAgIGZvciAobGV0IGkgPSAwLCBuID0gdGhpcy5fcHJvbWlzZXMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIGNvbnN0IHByb21pc2UgPSB0aGlzLl9wcm9taXNlc1tpXQogICAgICBpZiAocHJvbWlzZSA9PT0gbnVsbCkgY29udGludWUKCiAgICAgIGlmIChlcnIpIHByb21pc2UucmVqZWN0KG5ldyBFcnJvcihlcnIpKQogICAgICBlbHNlIHByb21pc2UucmVzb2x2ZSgpCiAgICB9CgogICAgdGhpcy5fb25maW5pc2hlZChhcHBsaWVkID8gbnVsbCA6IG5ldyBFcnJvcignQmF0Y2ggd2FzIG5vdCBhcHBsaWVkJykpCiAgfQoKICBwdXQoa2V5LCB2YWx1ZSkgewogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBhbHJlYWR5IGluIHByb2dyZXNzJykKCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UodGhpcy5fZW5xdWV1ZVByb21pc2UpCgogICAgdGhpcy5fb3BlcmF0aW9ucy5wdXNoKAogICAgICBuZXcgUm9ja3NEQlB1dCh0aGlzLl9lbmNvZGVLZXkoa2V5KSwgdGhpcy5fZW5jb2RlVmFsdWUodmFsdWUpLCB0aGlzLl9kYi5fY29sdW1uRmFtaWx5KQogICAgKQoKICAgIHRoaXMuX3Jlc2l6ZSgpCgogICAgcmV0dXJuIHByb21pc2UKICB9CgogIHRyeVB1dChrZXksIHZhbHVlKSB7CiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGFscmVhZHkgaW4gcHJvZ3Jlc3MnKQoKICAgIHRoaXMuX29wZXJhdGlvbnMucHVzaCgKICAgICAgbmV3IFJvY2tzREJQdXQodGhpcy5fZW5jb2RlS2V5KGtleSksIHRoaXMuX2VuY29kZVZhbHVlKHZhbHVlKSwgdGhpcy5fZGIuX2NvbHVtbkZhbWlseSkKICAgICkKCiAgICB0aGlzLl9wcm9taXNlcy5wdXNoKG51bGwpCgogICAgdGhpcy5fcmVzaXplKCkKICB9CgogIGRlbGV0ZShrZXkpIHsKICAgIGlmICh0aGlzLl9yZXF1ZXN0KSB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWxyZWFkeSBpbiBwcm9ncmVzcycpCgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHRoaXMuX2VucXVldWVQcm9taXNlKQoKICAgIHRoaXMuX29wZXJhdGlvbnMucHVzaChuZXcgUm9ja3NEQkRlbGV0ZSh0aGlzLl9lbmNvZGVLZXkoa2V5KSwgdGhpcy5fZGIuX2NvbHVtbkZhbWlseSkpCgogICAgdGhpcy5fcmVzaXplKCkKCiAgICByZXR1cm4gcHJvbWlzZQogIH0KCiAgdHJ5RGVsZXRlKGtleSkgewogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBhbHJlYWR5IGluIHByb2dyZXNzJykKCiAgICB0aGlzLl9vcGVyYXRpb25zLnB1c2gobmV3IFJvY2tzREJEZWxldGUodGhpcy5fZW5jb2RlS2V5KGtleSksIHRoaXMuX2RiLl9jb2x1bW5GYW1pbHkpKQoKICAgIHRoaXMuX3Byb21pc2VzLnB1c2gobnVsbCkKCiAgICB0aGlzLl9yZXNpemUoKQogIH0KCiAgZGVsZXRlUmFuZ2Uoc3RhcnQsIGVuZCkgewogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBhbHJlYWR5IGluIHByb2dyZXNzJykKCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UodGhpcy5fZW5xdWV1ZVByb21pc2UpCgogICAgdGhpcy5fb3BlcmF0aW9ucy5wdXNoKAogICAgICBuZXcgUm9ja3NEQkRlbGV0ZVJhbmdlKHRoaXMuX2VuY29kZUtleShzdGFydCksIHRoaXMuX2VuY29kZUtleShlbmQpLCB0aGlzLl9kYi5fY29sdW1uRmFtaWx5KQogICAgKQoKICAgIHRoaXMuX3Jlc2l6ZSgpCgogICAgcmV0dXJuIHByb21pc2UKICB9CgogIHRyeURlbGV0ZVJhbmdlKHN0YXJ0LCBlbmQpIHsKICAgIGlmICh0aGlzLl9yZXF1ZXN0KSB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWxyZWFkeSBpbiBwcm9ncmVzcycpCgogICAgdGhpcy5fb3BlcmF0aW9ucy5wdXNoKAogICAgICBuZXcgUm9ja3NEQkRlbGV0ZVJhbmdlKHRoaXMuX2VuY29kZUtleShzdGFydCksIHRoaXMuX2VuY29kZUtleShlbmQpLCB0aGlzLl9kYi5fY29sdW1uRmFtaWx5KQogICAgKQoKICAgIHRoaXMuX3Byb21pc2VzLnB1c2gobnVsbCkKCiAgICB0aGlzLl9yZXNpemUoKQogIH0KfQoKY2xhc3MgUm9ja3NEQkdldCB7CiAgY29uc3RydWN0b3Ioa2V5LCBjb2x1bW5GYW1pbHkpIHsKICAgIHRoaXMua2V5ID0ga2V5CiAgICB0aGlzLmNvbHVtbkZhbWlseSA9IGNvbHVtbkZhbWlseS5faGFuZGxlCiAgfQoKICBnZXQgdHlwZSgpIHsKICAgIHJldHVybiBiaW5kaW5nLkdFVAogIH0KfQoKY2xhc3MgUm9ja3NEQlB1dCB7CiAgY29uc3RydWN0b3Ioa2V5LCB2YWx1ZSwgY29sdW1uRmFtaWx5KSB7CiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy52YWx1ZSA9IHZhbHVlCiAgICB0aGlzLmNvbHVtbkZhbWlseSA9IGNvbHVtbkZhbWlseS5faGFuZGxlCiAgfQoKICBnZXQgdHlwZSgpIHsKICAgIHJldHVybiBiaW5kaW5nLlBVVAogIH0KfQoKY2xhc3MgUm9ja3NEQkRlbGV0ZSB7CiAgY29uc3RydWN0b3Ioa2V5LCBjb2x1bW5GYW1pbHkpIHsKICAgIHRoaXMua2V5ID0ga2V5CiAgICB0aGlzLmNvbHVtbkZhbWlseSA9IGNvbHVtbkZhbWlseS5faGFuZGxlCiAgfQoKICBnZXQgdHlwZSgpIHsKICAgIHJldHVybiBiaW5kaW5nLkRFTEVURQogIH0KfQoKY2xhc3MgUm9ja3NEQkRlbGV0ZVJhbmdlIHsKICBjb25zdHJ1Y3RvcihzdGFydCwgZW5kLCBjb2x1bW5GYW1pbHkpIHsKICAgIHRoaXMuc3RhcnQgPSBzdGFydAogICAgdGhpcy5lbmQgPSBlbmQKICAgIHRoaXMuY29sdW1uRmFtaWx5ID0gY29sdW1uRmFtaWx5Ll9oYW5kbGUKICB9CgogIGdldCB0eXBlKCkgewogICAgcmV0dXJuIGJpbmRpbmcuREVMRVRFX1JBTkdFCiAgfQp9CmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQpjb25zdCB7IEJsb29tRmlsdGVyUG9saWN5IH0gPSByZXF1aXJlKCcuL2ZpbHRlci1wb2xpY3knKQoKY2xhc3MgUm9ja3NEQkNvbHVtbkZhbWlseSB7CiAgY29uc3RydWN0b3IobmFtZSwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7CiAgICAgIC8vIEJsb2Igb3B0aW9ucwogICAgICBlbmFibGVCbG9iRmlsZXMgPSBmYWxzZSwKICAgICAgbWluQmxvYlNpemUgPSAwLAogICAgICBibG9iRmlsZVNpemUgPSAwLAogICAgICBlbmFibGVCbG9iR2FyYmFnZUNvbGxlY3Rpb24gPSB0cnVlLAogICAgICAvLyBCbG9jayB0YWJsZSBvcHRpb25zCiAgICAgIHRhYmxlQmxvY2tTaXplID0gODE5MiwKICAgICAgdGFibGVDYWNoZUluZGV4QW5kRmlsdGVyQmxvY2tzID0gdHJ1ZSwKICAgICAgdGFibGVGb3JtYXRWZXJzaW9uID0gNiwKICAgICAgb3B0aW1pemVGaWx0ZXJzRm9yTWVtb3J5ID0gZmFsc2UsCiAgICAgIGJsb2NrQ2FjaGUgPSB0cnVlLAogICAgICBmaWx0ZXJQb2xpY3kgPSBuZXcgQmxvb21GaWx0ZXJQb2xpY3koMTApLAogICAgICB0b3BMZXZlbEluZGV4UGlubmluZ1RpZXIgPSBjb25zdGFudHMucGlubmluZ1RpZXIuQUxMLAogICAgICBwYXJ0aXRpb25QaW5uaW5nVGllciA9IGNvbnN0YW50cy5waW5uaW5nVGllci5BTEwsCiAgICAgIHVucGFydGl0aW9uZWRQaW5uaW5nVGllciA9IGNvbnN0YW50cy5waW5uaW5nVGllci5BTEwsCiAgICAgIG9wdGltaXplRmlsdGVyc0ZvckhpdHMgPSBmYWxzZSwKICAgICAgbnVtTGV2ZWxzID0gNywKICAgICAgbWF4V3JpdGVCdWZmZXJOdW1iZXIgPSAyCiAgICB9ID0gb3B0cwoKICAgIHRoaXMuX25hbWUgPSBuYW1lCiAgICB0aGlzLl9mbHVzaGluZyA9IG51bGwKICAgIHRoaXMuX29wdGlvbnMgPSB7CiAgICAgIGVuYWJsZUJsb2JGaWxlcywKICAgICAgbWluQmxvYlNpemUsCiAgICAgIGJsb2JGaWxlU2l6ZSwKICAgICAgZW5hYmxlQmxvYkdhcmJhZ2VDb2xsZWN0aW9uLAogICAgICB0YWJsZUJsb2NrU2l6ZSwKICAgICAgdGFibGVDYWNoZUluZGV4QW5kRmlsdGVyQmxvY2tzLAogICAgICB0YWJsZUZvcm1hdFZlcnNpb24sCiAgICAgIG9wdGltaXplRmlsdGVyc0Zvck1lbW9yeSwKICAgICAgYmxvY2tDYWNoZSwKICAgICAgZmlsdGVyUG9saWN5LAogICAgICB0b3BMZXZlbEluZGV4UGlubmluZ1RpZXIsCiAgICAgIHBhcnRpdGlvblBpbm5pbmdUaWVyLAogICAgICB1bnBhcnRpdGlvbmVkUGlubmluZ1RpZXIsCiAgICAgIG9wdGltaXplRmlsdGVyc0ZvckhpdHMsCiAgICAgIG51bUxldmVscywKICAgICAgbWF4V3JpdGVCdWZmZXJOdW1iZXIKICAgIH0KCiAgICBjb25zdCBmaWx0ZXJQb2xpY3lBcmd1bWVudHMgPSBbMCwgMCwgMF0KCiAgICBpZiAoZmlsdGVyUG9saWN5ICE9PSBudWxsKSB7CiAgICAgIGZpbHRlclBvbGljeUFyZ3VtZW50c1swXSA9IGZpbHRlclBvbGljeS50eXBlCgogICAgICBzd2l0Y2ggKGZpbHRlclBvbGljeS50eXBlKSB7CiAgICAgICAgY2FzZSAxOiAvLyBCbG9vbSBmaWx0ZXIgcG9saWN5CiAgICAgICAgICBmaWx0ZXJQb2xpY3lBcmd1bWVudHNbMV0gPSBmaWx0ZXJQb2xpY3kuYml0c1BlcktleQogICAgICAgICAgYnJlYWsKICAgICAgICBjYXNlIDI6IC8vIFJpYmJvbiBmaWx0ZXIgcG9saWN5CiAgICAgICAgICBmaWx0ZXJQb2xpY3lBcmd1bWVudHNbMV0gPSBmaWx0ZXJQb2xpY3kuYmxvb21FcXVpdmFsZW50Qml0c1BlcktleQogICAgICAgICAgZmlsdGVyUG9saWN5QXJndW1lbnRzWzJdID0gZmlsdGVyUG9saWN5LmJsb29tQmVmb3JlTGV2ZWwKCiAgICAgICAgICBicmVhawogICAgICB9CiAgICB9CgogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5jb2x1bW5GYW1pbHlJbml0KAogICAgICBuYW1lLAogICAgICBlbmFibGVCbG9iRmlsZXMsCiAgICAgIG1pbkJsb2JTaXplLAogICAgICBibG9iRmlsZVNpemUsCiAgICAgIGVuYWJsZUJsb2JHYXJiYWdlQ29sbGVjdGlvbiwKICAgICAgdGFibGVCbG9ja1NpemUsCiAgICAgIHRhYmxlQ2FjaGVJbmRleEFuZEZpbHRlckJsb2NrcywKICAgICAgdGFibGVGb3JtYXRWZXJzaW9uLAogICAgICBvcHRpbWl6ZUZpbHRlcnNGb3JNZW1vcnksCiAgICAgIGJsb2NrQ2FjaGUgPT09IGZhbHNlLAogICAgICAuLi5maWx0ZXJQb2xpY3lBcmd1bWVudHMsCiAgICAgIHRvcExldmVsSW5kZXhQaW5uaW5nVGllciwKICAgICAgcGFydGl0aW9uUGlubmluZ1RpZXIsCiAgICAgIHVucGFydGl0aW9uZWRQaW5uaW5nVGllciwKICAgICAgb3B0aW1pemVGaWx0ZXJzRm9ySGl0cywKICAgICAgbnVtTGV2ZWxzLAogICAgICBtYXhXcml0ZUJ1ZmZlck51bWJlcgogICAgKQogIH0KCiAgY2xvbmVTZXR0aW5ncyhuYW1lKSB7CiAgICByZXR1cm4gbmV3IFJvY2tzREJDb2x1bW5GYW1pbHkobmFtZSwgdGhpcy5fb3B0aW9ucykKICB9CgogIGdldCBuYW1lKCkgewogICAgcmV0dXJuIHRoaXMuX25hbWUKICB9CgogIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5faGFuZGxlID09PSBudWxsKSByZXR1cm4KCiAgICBiaW5kaW5nLmNvbHVtbkZhbWlseURlc3Ryb3kodGhpcy5faGFuZGxlKQoKICAgIHRoaXMuX2hhbmRsZSA9IG51bGwKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gUm9ja3NEQkNvbHVtbkZhbWlseQptb2R1bGUuZXhwb3J0cyA9IHsKICBwaW5uaW5nVGllcjogewogICAgTk9ORTogMCwKICAgIEZMVVNIRURfQU5EX1NJTUlMQVI6IDEsCiAgICBBTEw6IDIKICB9Cn0KZXhwb3J0cy5CbG9vbUZpbHRlclBvbGljeSA9IGNsYXNzIFJvY2tzREJCbG9vbUZpbHRlclBvbGljeSB7CiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gMQogIH0KCiAgY29uc3RydWN0b3IoYml0c1BlcktleSkgewogICAgdGhpcy5iaXRzUGVyS2V5ID0gYml0c1BlcktleQogIH0KfQoKZXhwb3J0cy5SaWJib25GaWx0ZXJQb2xpY3kgPSBjbGFzcyBSb2Nrc0RCUmliYm9uRmlsdGVyUG9saWN5IHsKICBnZXQgdHlwZSgpIHsKICAgIHJldHVybiAyCiAgfQoKICBjb25zdHJ1Y3RvcihibG9vbUVxdWl2YWxlbnRCaXRzUGVyS2V5LCBibG9vbUJlZm9yZUxldmVsID0gMCkgewogICAgdGhpcy5ibG9vbUVxdWl2YWxlbnRCaXRzUGVyS2V5ID0gYmxvb21FcXVpdmFsZW50Qml0c1BlcktleQogICAgdGhpcy5ibG9vbUJlZm9yZUxldmVsID0gYmxvb21CZWZvcmVMZXZlbAogIH0KfQpjb25zdCB7IFJlYWRhYmxlIH0gPSByZXF1aXJlKCdzdHJlYW14JykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCgpjb25zdCBlbXB0eSA9IEJ1ZmZlci5hbGxvYygwKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSb2Nrc0RCSXRlcmF0b3IgZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3IoZGIsIG9wdHMgPSB7fSkgewogICAgY29uc3QgewogICAgICBndCA9IG51bGwsCiAgICAgIGd0ZSA9IG51bGwsCiAgICAgIGx0ID0gbnVsbCwKICAgICAgbHRlID0gbnVsbCwKICAgICAgcmV2ZXJzZSA9IGZhbHNlLAogICAgICB2YWx1ZXMgPSB0cnVlLAogICAgICBsaW1pdCA9IEluZmluaXR5LAogICAgICBjYXBhY2l0eSA9IDgKICAgIH0gPSBvcHRzCgogICAgc3VwZXIoKQoKICAgIGRiLl9yZWYoKQoKICAgIHRoaXMuX2RiID0gZGIKCiAgICB0aGlzLl9ndCA9IGd0ID8gdGhpcy5fZW5jb2RlS2V5KGd0KSA6IGVtcHR5CiAgICB0aGlzLl9ndGUgPSBndGUgPyB0aGlzLl9lbmNvZGVLZXkoZ3RlKSA6IGVtcHR5CiAgICB0aGlzLl9sdCA9IGx0ID8gdGhpcy5fZW5jb2RlS2V5KGx0KSA6IGVtcHR5CiAgICB0aGlzLl9sdGUgPSBsdGUgPyB0aGlzLl9lbmNvZGVLZXkobHRlKSA6IGVtcHR5CgogICAgdGhpcy5fcmV2ZXJzZSA9IHJldmVyc2UKICAgIHRoaXMuX3ZhbHVlcyA9IHZhbHVlcwogICAgdGhpcy5fbGltaXQgPSBsaW1pdCA8IDAgPyBJbmZpbml0eSA6IGxpbWl0CiAgICB0aGlzLl9jYXBhY2l0eSA9IGNhcGFjaXR5CiAgICB0aGlzLl9vcGVuZWQgPSBmYWxzZQoKICAgIHRoaXMuX3BlbmRpbmdPcGVuID0gbnVsbAogICAgdGhpcy5fcGVuZGluZ1JlYWQgPSBudWxsCiAgICB0aGlzLl9wZW5kaW5nRGVzdHJveSA9IG51bGwKCiAgICB0aGlzLl9idWZmZXIgPSBudWxsCiAgICB0aGlzLl9oYW5kbGUgPSBudWxsCgogICAgaWYgKHRoaXMuX2RiLl9zdGF0ZS5vcGVuZWQgPT09IHRydWUpIHRoaXMucmVhZHkoKQogIH0KCiAgX29ub3BlbihlcnIpIHsKICAgIGNvbnN0IGNiID0gdGhpcy5fcGVuZGluZ09wZW4KICAgIHRoaXMuX3BlbmRpbmdPcGVuID0gbnVsbAogICAgdGhpcy5fb3BlbmVkID0gdHJ1ZQogICAgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCiAgICBjYihlcnIpCiAgfQoKICBfb25yZWFkKGVyciwga2V5cywgdmFsdWVzKSB7CiAgICBjb25zdCBjYiA9IHRoaXMuX3BlbmRpbmdSZWFkCiAgICB0aGlzLl9wZW5kaW5nUmVhZCA9IG51bGwKICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQogICAgaWYgKGVycikgcmV0dXJuIGNiKGVycikKCiAgICBjb25zdCBuID0ga2V5cy5sZW5ndGgKCiAgICB0aGlzLl9saW1pdCAtPSBuCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuOyBpKyspIHsKICAgICAgdGhpcy5wdXNoKHsKICAgICAgICBrZXk6IHRoaXMuX2RlY29kZUtleShCdWZmZXIuZnJvbShrZXlzW2ldKSksCiAgICAgICAgdmFsdWU6IHRoaXMuX3ZhbHVlcyA/IHRoaXMuX2RlY29kZVZhbHVlKEJ1ZmZlci5mcm9tKHZhbHVlc1tpXSkpIDogbnVsbAogICAgICB9KQogICAgfQoKICAgIGlmIChuIDwgdGhpcy5fY2FwYWNpdHkpIHRoaXMucHVzaChudWxsKQoKICAgIGNiKG51bGwpCiAgfQoKICBfb25jbG9zZShlcnIpIHsKICAgIGNvbnN0IGNiID0gdGhpcy5fcGVuZGluZ0Rlc3Ryb3kKICAgIHRoaXMuX3BlbmRpbmdEZXN0cm95ID0gbnVsbAogICAgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCiAgICB0aGlzLl9kYi5fdW5yZWYoKQogICAgY2IoZXJyKQogIH0KCiAgX3Jlc2l6ZSgpIHsKICAgIGlmICh0aGlzLl9oYW5kbGUgIT09IG51bGwpIHsKICAgICAgdGhpcy5fYnVmZmVyID0gYmluZGluZy5pdGVyYXRvckJ1ZmZlcih0aGlzLl9oYW5kbGUsIHRoaXMuX2NhcGFjaXR5KQogICAgfQogIH0KCiAgYXN5bmMgcmVhZHkoKSB7CiAgICBpZiAodGhpcy5faGFuZGxlICE9PSBudWxsKSByZXR1cm4KCiAgICBpZiAodGhpcy5fZGIuX3N0YXRlLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMuX2RiLl9zdGF0ZS5yZWFkeSgpCgogICAgdGhpcy5faW5pdCgpCiAgfQoKICBfaW5pdCgpIHsKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcuaXRlcmF0b3JJbml0KCkKICAgIHRoaXMuX2J1ZmZlciA9IGJpbmRpbmcuaXRlcmF0b3JCdWZmZXIodGhpcy5faGFuZGxlLCB0aGlzLl9jYXBhY2l0eSkKICB9CgogIGFzeW5jIF9vcGVuKGNiKSB7CiAgICBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICB0aGlzLl9kYi5fc3RhdGUuaW8uaW5jKCkKCiAgICBpZiAodGhpcy5fZGIuX3N0YXRlLnJlc3VtZWQgIT09IG51bGwpIHsKICAgICAgY29uc3QgcmVzdW1lZCA9IGF3YWl0IHRoaXMuX2RiLl9zdGF0ZS5yZXN1bWVkLnByb21pc2UKCiAgICAgIGlmICghcmVzdW1lZCkgewogICAgICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQoKICAgICAgICByZXR1cm4gY2IobmV3IEVycm9yKCdSb2Nrc0RCIHNlc3Npb24gaXMgY2xvc2VkJykpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9wZW5kaW5nT3BlbiA9IGNiCgogICAgdHJ5IHsKICAgICAgYmluZGluZy5pdGVyYXRvck9wZW4oCiAgICAgICAgdGhpcy5fZGIuX3N0YXRlLl9oYW5kbGUsCiAgICAgICAgdGhpcy5faGFuZGxlLAogICAgICAgIHRoaXMuX2RiLl9jb2x1bW5GYW1pbHkuX2hhbmRsZSwKICAgICAgICB0aGlzLl9ndCwKICAgICAgICB0aGlzLl9ndGUsCiAgICAgICAgdGhpcy5fbHQsCiAgICAgICAgdGhpcy5fbHRlLAogICAgICAgIHRoaXMuX3JldmVyc2UsCiAgICAgICAgIXRoaXMuX3ZhbHVlcywgLy8gS2V5cyBvbmx5CiAgICAgICAgdGhpcy5fZGIuX3NuYXBzaG90ID8gdGhpcy5fZGIuX3NuYXBzaG90Ll9oYW5kbGUgOiB1bmRlZmluZWQsCiAgICAgICAgdGhpcywKICAgICAgICB0aGlzLl9vbm9wZW4sCiAgICAgICAgdGhpcy5fb25jbG9zZSwKICAgICAgICB0aGlzLl9vbnJlYWQKICAgICAgKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQoKICAgICAgY2IoZXJyKQogICAgfQogIH0KCiAgYXN5bmMgX3JlYWQoY2IpIHsKICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5pbmMoKQoKICAgIGlmICh0aGlzLl9kYi5fc3RhdGUucmVzdW1lZCAhPT0gbnVsbCkgewogICAgICBjb25zdCByZXN1bWVkID0gYXdhaXQgdGhpcy5fZGIuX3N0YXRlLnJlc3VtZWQucHJvbWlzZQoKICAgICAgaWYgKCFyZXN1bWVkKSB7CiAgICAgICAgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCgogICAgICAgIHJldHVybiBjYihuZXcgRXJyb3IoJ1JvY2tzREIgc2Vzc2lvbiBpcyBjbG9zZWQnKSkKICAgICAgfQogICAgfQoKICAgIHRoaXMuX3BlbmRpbmdSZWFkID0gY2IKCiAgICB0cnkgewogICAgICBiaW5kaW5nLml0ZXJhdG9yUmVhZCh0aGlzLl9oYW5kbGUsIE1hdGgubWluKHRoaXMuX2NhcGFjaXR5LCB0aGlzLl9saW1pdCkpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCgogICAgICBjYihlcnIpCiAgICB9CiAgfQoKICBhc3luYyBfZGVzdHJveShjYikgewogICAgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgdGhpcy5fZGIuX3N0YXRlLmlvLmluYygpCgogICAgaWYgKHRoaXMuX29wZW5lZCA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCiAgICAgIHRoaXMuX2RiLl91bnJlZigpCgogICAgICByZXR1cm4gY2IobnVsbCkKICAgIH0KCiAgICB0aGlzLl9wZW5kaW5nRGVzdHJveSA9IGNiCgogICAgdHJ5IHsKICAgICAgYmluZGluZy5pdGVyYXRvckNsb3NlKHRoaXMuX2hhbmRsZSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKICAgICAgdGhpcy5fZGIuX3VucmVmKCkKCiAgICAgIGNiKGVycikKICAgIH0KICB9CgogIF9lbmNvZGVLZXkoaykgewogICAgaWYgKHRoaXMuX2RiLl9rZXlFbmNvZGluZyAhPT0gbnVsbCkgcmV0dXJuIGMuZW5jb2RlKHRoaXMuX2RiLl9rZXlFbmNvZGluZywgaykKICAgIGlmICh0eXBlb2YgayA9PT0gJ3N0cmluZycpIHJldHVybiBCdWZmZXIuZnJvbShrKQogICAgcmV0dXJuIGsKICB9CgogIF9kZWNvZGVLZXkoYikgewogICAgaWYgKHRoaXMuX2RiLl9rZXlFbmNvZGluZyAhPT0gbnVsbCkgcmV0dXJuIGMuZGVjb2RlKHRoaXMuX2RiLl9rZXlFbmNvZGluZywgYikKICAgIHJldHVybiBiCiAgfQoKICBfZGVjb2RlVmFsdWUoYikgewogICAgaWYgKHRoaXMuX2RiLl92YWx1ZUVuY29kaW5nICE9PSBudWxsKSByZXR1cm4gYy5kZWNvZGUodGhpcy5fZGIuX3ZhbHVlRW5jb2RpbmcsIGIpCiAgICByZXR1cm4gYgogIH0KfQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJvY2tzREJTbmFwc2hvdCB7CiAgY29uc3RydWN0b3Ioc3RhdGUpIHsKICAgIHRoaXMuX3N0YXRlID0gc3RhdGUKCiAgICB0aGlzLl9oYW5kbGUgPSBudWxsCiAgICB0aGlzLl9yZWZzID0gMAoKICAgIGlmIChzdGF0ZS5kZWZlclNuYXBzaG90SW5pdCA9PT0gZmFsc2UpIHRoaXMuX2luaXQoKQogIH0KCiAgX2luaXQoKSB7CiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLnNuYXBzaG90Q3JlYXRlKHRoaXMuX3N0YXRlLl9oYW5kbGUpCiAgfQoKICByZWYoKSB7CiAgICB0aGlzLl9yZWZzKysKICB9CgogIHVucmVmKCkgewogICAgaWYgKC0tdGhpcy5fcmVmcyA+IDApIHJldHVybgoKICAgIGlmICh0aGlzLl9oYW5kbGUgPT09IG51bGwpIHJldHVybgoKICAgIGJpbmRpbmcuc25hcHNob3REZXN0cm95KHRoaXMuX2hhbmRsZSkKCiAgICB0aGlzLl9oYW5kbGUgPSBudWxsCiAgfQp9CmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCmNvbnN0IFJlZkNvdW50ZXIgPSByZXF1aXJlKCdyZWZjb3VudGVyJykKY29uc3QgcnJwID0gcmVxdWlyZSgncmVzb2x2ZS1yZWplY3QtcHJvbWlzZScpCmNvbnN0IFNpZ25hbFByb21pc2UgPSByZXF1aXJlKCdzaWduYWwtcHJvbWlzZScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgeyBSZWFkQmF0Y2gsIFdyaXRlQmF0Y2ggfSA9IHJlcXVpcmUoJy4vYmF0Y2gnKQpjb25zdCBDb2x1bW5GYW1pbHkgPSByZXF1aXJlKCcuL2NvbHVtbi1mYW1pbHknKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCgpjb25zdCBNQVhfQkFUQ0hfUkVVU0UgPSA2NApjb25zdCBlbXB0eSA9IEJ1ZmZlci5hbGxvYygwKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSb2Nrc0RCU3RhdGUgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvcihkYiwgcGF0aCwgb3B0cykgewogICAgc3VwZXIoKQoKICAgIGNvbnN0IHsKICAgICAgY29sdW1uRmFtaWx5ID0gbmV3IENvbHVtbkZhbWlseSgnZGVmYXVsdCcsIG9wdHMpLAogICAgICBjb2x1bW5GYW1pbGllcyA9IFtdLAogICAgICByZWFkT25seSA9IGZhbHNlLAogICAgICBjcmVhdGVJZk1pc3NpbmcgPSB0cnVlLAogICAgICBjcmVhdGVNaXNzaW5nQ29sdW1uRmFtaWxpZXMgPSB0cnVlLAogICAgICBtYXhCYWNrZ3JvdW5kSm9icyA9IDYsCiAgICAgIGJ5dGVzUGVyU3luYyA9IDEwNDg1NzYsCiAgICAgIG1heE9wZW5GaWxlcyA9IC0xLAogICAgICB1c2VEaXJlY3RSZWFkcyA9IGZhbHNlLAogICAgICBhdm9pZFVubmVjZXNzYXJ5QmxvY2tpbmdJTyA9IGZhbHNlLAogICAgICBza2lwU3RhdHNVcGRhdGVPbk9wZW4gPSBmYWxzZSwKICAgICAgdXNlRGlyZWN0SU9Gb3JGbHVzaEFuZENvbXBhY3Rpb24gPSBmYWxzZSwKICAgICAgbWF4RmlsZU9wZW5pbmdUaHJlYWRzID0gMTYsCiAgICAgIGxvY2sgPSBudWxsCiAgICB9ID0gb3B0cwoKICAgIHRoaXMucGF0aCA9IHBhdGgKICAgIHRoaXMuZGIgPSBkYgogICAgdGhpcy5oYW5kbGVzID0gbmV3IFJlZkNvdW50ZXIoKQogICAgdGhpcy5pbyA9IG5ldyBSZWZDb3VudGVyKCkKICAgIHRoaXMuc2Vzc2lvbnMgPSBbXQogICAgdGhpcy5jb2x1bW5GYW1pbGllcyA9IFtjb2x1bW5GYW1pbHldCiAgICB0aGlzLmRlZmVyU25hcHNob3RJbml0ID0gdHJ1ZQogICAgdGhpcy5yZXN1bWVkID0gbnVsbAoKICAgIHRoaXMuX3N1c3BlbmRlZCA9IGZhbHNlCiAgICB0aGlzLl9zdXNwZW5kaW5nID0gZmFsc2UKICAgIHRoaXMuX3VwZGF0aW5nID0gZmFsc2UKICAgIHRoaXMuX3VwZGF0aW5nU2lnbmFsID0gbmV3IFNpZ25hbFByb21pc2UoKQogICAgdGhpcy5fY29sdW1uc0ZsdXNoZWQgPSBmYWxzZQogICAgdGhpcy5fbG9jayA9IGxvY2sKICAgIHRoaXMuX3JlYWRCYXRjaGVzID0gW10KICAgIHRoaXMuX3dyaXRlQmF0Y2hlcyA9IFtdCgogICAgZm9yIChjb25zdCBjb2x1bW5GYW1pbHkgb2YgY29sdW1uRmFtaWxpZXMpIHsKICAgICAgdGhpcy5jb2x1bW5GYW1pbGllcy5wdXNoKAogICAgICAgIHR5cGVvZiBjb2x1bW5GYW1pbHkgPT09ICdzdHJpbmcnID8gbmV3IENvbHVtbkZhbWlseShjb2x1bW5GYW1pbHksIG9wdHMpIDogY29sdW1uRmFtaWx5CiAgICAgICkKICAgIH0KCiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLmluaXQoCiAgICAgIHJlYWRPbmx5LAogICAgICBjcmVhdGVJZk1pc3NpbmcsCiAgICAgIGNyZWF0ZU1pc3NpbmdDb2x1bW5GYW1pbGllcywKICAgICAgbWF4QmFja2dyb3VuZEpvYnMsCiAgICAgIGJ5dGVzUGVyU3luYywKICAgICAgbWF4T3BlbkZpbGVzLAogICAgICB1c2VEaXJlY3RSZWFkcywKICAgICAgYXZvaWRVbm5lY2Vzc2FyeUJsb2NraW5nSU8sCiAgICAgIHNraXBTdGF0c1VwZGF0ZU9uT3BlbiwKICAgICAgdXNlRGlyZWN0SU9Gb3JGbHVzaEFuZENvbXBhY3Rpb24sCiAgICAgIG1heEZpbGVPcGVuaW5nVGhyZWFkcwogICAgKQogIH0KCiAgY3JlYXRlUmVhZEJhdGNoKGRiLCBvcHRzKSB7CiAgICBpZiAodGhpcy5fcmVhZEJhdGNoZXMubGVuZ3RoID09PSAwKSByZXR1cm4gbmV3IFJlYWRCYXRjaChkYiwgb3B0cykKICAgIGNvbnN0IGJhdGNoID0gdGhpcy5fcmVhZEJhdGNoZXMucG9wKCkKICAgIGJhdGNoLl9yZXVzZShkYiwgb3B0cykKICAgIHJldHVybiBiYXRjaAogIH0KCiAgY3JlYXRlV3JpdGVCYXRjaChkYiwgb3B0cykgewogICAgaWYgKHRoaXMuX3dyaXRlQmF0Y2hlcy5sZW5ndGggPT09IDApIHJldHVybiBuZXcgV3JpdGVCYXRjaChkYiwgb3B0cykKICAgIGNvbnN0IGJhdGNoID0gdGhpcy5fd3JpdGVCYXRjaGVzLnBvcCgpCiAgICBiYXRjaC5fcmV1c2UoZGIsIG9wdHMpCiAgICByZXR1cm4gYmF0Y2gKICB9CgogIGZyZWVCYXRjaChiYXRjaCwgd3JpdGFibGUpIHsKICAgIGlmIChiYXRjaC5fY2FwYWNpdHkgPiAxNikgcmV0dXJuCiAgICBjb25zdCBxdWV1ZSA9IHdyaXRhYmxlID8gdGhpcy5fd3JpdGVCYXRjaGVzIDogdGhpcy5fcmVhZEJhdGNoZXMKICAgIGlmIChxdWV1ZS5sZW5ndGggPj0gTUFYX0JBVENIX1JFVVNFKSByZXR1cm4KICAgIHF1ZXVlLnB1c2goYmF0Y2gpCiAgfQoKICBhZGRTZXNzaW9uKGRiKSB7CiAgICBkYi5faW5kZXggPSB0aGlzLnNlc3Npb25zLnB1c2goZGIpIC0gMQogICAgaWYgKGRiLl9zbmFwc2hvdCkgZGIuX3NuYXBzaG90LnJlZigpCiAgfQoKICByZW1vdmVTZXNzaW9uKGRiKSB7CiAgICBjb25zdCBoZWFkID0gdGhpcy5zZXNzaW9ucy5wb3AoKQogICAgaWYgKGhlYWQgIT09IGRiKSB0aGlzLnNlc3Npb25zWyhoZWFkLl9pbmRleCA9IGRiLl9pbmRleCldID0gaGVhZAogICAgZGIuX2luZGV4ID0gLTEKICAgIGlmIChkYi5fc25hcHNob3QpIGRiLl9zbmFwc2hvdC51bnJlZigpCiAgfQoKICB1cHNlcnRDb2x1bW5GYW1pbHkoYykgewogICAgaWYgKHR5cGVvZiBjID09PSAnc3RyaW5nJykgewogICAgICBsZXQgY29sID0gdGhpcy5nZXRDb2x1bW5GYW1pbHlCeU5hbWUoYykKICAgICAgaWYgKGNvbCkgcmV0dXJuIGNvbAogICAgICBjb2wgPSB0aGlzLmNvbHVtbkZhbWlsaWVzWzBdLmNsb25lU2V0dGluZ3MoYykKICAgICAgdGhpcy5jb2x1bW5GYW1pbGllcy5wdXNoKGNvbCkKICAgICAgcmV0dXJuIGNvbAogICAgfQoKICAgIGlmICh0aGlzLmNvbHVtbkZhbWlsaWVzLmluY2x1ZGVzKGMpKSByZXR1cm4gYwogICAgdGhpcy5jb2x1bW5GYW1pbGllcy5wdXNoKGMpCiAgICByZXR1cm4gYwogIH0KCiAgZ2V0Q29sdW1uRmFtaWx5KGMpIHsKICAgIGlmICghYykgcmV0dXJuIHRoaXMuY29sdW1uRmFtaWxpZXNbMF0KICAgIGlmICghdGhpcy5fY29sdW1uc0ZsdXNoZWQpIHJldHVybiB0aGlzLnVwc2VydENvbHVtbkZhbWlseShjKQoKICAgIGlmICh0eXBlb2YgYyAhPT0gJ3N0cmluZycpIHJldHVybiBjCgogICAgY29uc3QgY29sID0gdGhpcy5nZXRDb2x1bW5GYW1pbHlCeU5hbWUoYykKICAgIGlmIChjb2wgPT09IG51bGwpIHRocm93IG5ldyBFcnJvcignVW5rbm93biBjb2x1bW4gZmFtaWx5JykKICAgIHJldHVybiBjb2wKICB9CgogIGdldENvbHVtbkZhbWlseUJ5TmFtZShuYW1lKSB7CiAgICBmb3IgKGNvbnN0IGNvbCBvZiB0aGlzLmNvbHVtbkZhbWlsaWVzKSB7CiAgICAgIGlmIChjb2wubmFtZSA9PT0gbmFtZSkgcmV0dXJuIGNvbAogICAgfQogICAgcmV0dXJuIG51bGwKICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgYXdhaXQgUHJvbWlzZS5yZXNvbHZlKCkgLy8gQWxsb3cgY29sdW1uIGZhbWlsaWVzIHRvIHBvcHVsYXRlIGlmIG9uLWRlbWFuZAoKICAgIGlmICh0aGlzLl9sb2NrKSBhd2FpdCB0aGlzLl9sb2NrLnJlYWR5KCkKCiAgICBjb25zdCByZXEgPSB7IHJlc29sdmU6IG51bGwsIHJlamVjdDogbnVsbCwgaGFuZGxlOiBudWxsIH0KCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgICAgcmVxLnJlamVjdCA9IHJlamVjdAogICAgfSkKCiAgICB0aGlzLl9jb2x1bW5zRmx1c2hlZCA9IHRydWUKCiAgICBjb25zdCBsb2NrID0gdGhpcy5fbG9jayA9PT0gbnVsbCA/IC0xIDogdGhpcy5fbG9jay50cmFuc2ZlcigpCgogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcub3BlbigKICAgICAgdGhpcy5faGFuZGxlLAogICAgICB0aGlzLAogICAgICB0aGlzLnBhdGgsCiAgICAgIHRoaXMuY29sdW1uRmFtaWxpZXMubWFwKChjKSA9PiBjLl9oYW5kbGUpLAogICAgICBsb2NrLAogICAgICByZXEsCiAgICAgIG9ub3BlbgogICAgKQoKICAgIGF3YWl0IHByb21pc2UKCiAgICB0aGlzLmRlZmVyU25hcHNob3RJbml0ID0gZmFsc2UKCiAgICBmb3IgKGNvbnN0IHNlc3Npb24gb2YgdGhpcy5zZXNzaW9ucykgewogICAgICBpZiAoc2Vzc2lvbi5fc25hcHNob3QpIHNlc3Npb24uX3NuYXBzaG90Ll9pbml0KCkKICAgIH0KCiAgICBmdW5jdGlvbiBvbm9wZW4oZXJyKSB7CiAgICAgIGlmIChlcnIpIHJlcS5yZWplY3QobmV3IEVycm9yKGVycikpCiAgICAgIGVsc2UgcmVxLnJlc29sdmUoKQogICAgfQogIH0KCiAgYXN5bmMgX2Nsb3NlKCkgewogICAgd2hpbGUgKHRoaXMuX3VwZGF0aW5nKSBhd2FpdCB0aGlzLl91cGRhdGluZ1NpZ25hbC53YWl0KCkKICAgIGlmICh0aGlzLnJlc3VtZWQpIHRoaXMucmVzdW1lZC5yZXNvbHZlKGZhbHNlKQoKICAgIHdoaWxlICghdGhpcy5pby5pc0lkbGUoKSkgYXdhaXQgdGhpcy5pby5pZGxlKCkKICAgIHdoaWxlICghdGhpcy5oYW5kbGVzLmlzSWRsZSgpKSBhd2FpdCB0aGlzLmhhbmRsZXMuaWRsZSgpCgogICAgd2hpbGUgKHRoaXMuc2Vzc2lvbnMubGVuZ3RoID4gMCkgewogICAgICBhd2FpdCB0aGlzLnNlc3Npb25zW3RoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMV0uY2xvc2UoKQogICAgfQoKICAgIGZvciAoY29uc3QgY29sdW1uRmFtaWx5IG9mIHRoaXMuY29sdW1uRmFtaWxpZXMpIGNvbHVtbkZhbWlseS5kZXN0cm95KCkKCiAgICBjb25zdCByZXEgPSB7IHJlc29sdmU6IG51bGwsIHJlamVjdDogbnVsbCwgaGFuZGxlOiBudWxsIH0KCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgICAgcmVxLnJlamVjdCA9IHJlamVjdAogICAgfSkKCiAgICByZXEuaGFuZGxlID0gYmluZGluZy5jbG9zZSh0aGlzLl9oYW5kbGUsIHJlcSwgb25jbG9zZSkKCiAgICB0cnkgewogICAgICBhd2FpdCBwcm9taXNlCiAgICB9IGZpbmFsbHkgewogICAgICBpZiAodGhpcy5fbG9jaykgYXdhaXQgdGhpcy5fbG9jay5jbG9zZSgpCiAgICB9CgogICAgZnVuY3Rpb24gb25jbG9zZShlcnIpIHsKICAgICAgaWYgKGVycikgcmVxLnJlamVjdChuZXcgRXJyb3IoZXJyKSkKICAgICAgZWxzZSByZXEucmVzb2x2ZSgpCiAgICB9CiAgfQoKICBhc3luYyBmbHVzaChkYiwgb3B0cykgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgdGhpcy5pby5pbmMoKQoKICAgIGlmICh0aGlzLnJlc3VtZWQgIT09IG51bGwpIHsKICAgICAgY29uc3QgcmVzdW1lZCA9IGF3YWl0IHRoaXMucmVzdW1lZC5wcm9taXNlCgogICAgICBpZiAoIXJlc3VtZWQpIHsKICAgICAgICB0aGlzLmlvLmRlYygpCgogICAgICAgIHRocm93IG5ldyBFcnJvcignUm9ja3NEQiBzZXNzaW9uIGlzIGNsb3NlZCcpCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCByZXEgPSB7IHJlc29sdmU6IG51bGwsIHJlamVjdDogbnVsbCwgaGFuZGxlOiBudWxsIH0KCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgICAgcmVxLnJlamVjdCA9IHJlamVjdAogICAgfSkKCiAgICB0cnkgewogICAgICByZXEuaGFuZGxlID0gYmluZGluZy5mbHVzaCh0aGlzLl9oYW5kbGUsIGRiLl9jb2x1bW5GYW1pbHkuX2hhbmRsZSwgcmVxLCBvbmZsdXNoKQoKICAgICAgYXdhaXQgcHJvbWlzZQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5pby5kZWMoKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uZmx1c2goZXJyKSB7CiAgICAgIGlmIChlcnIpIHJlcS5yZWplY3QobmV3IEVycm9yKGVycikpCiAgICAgIGVsc2UgcmVxLnJlc29sdmUoKQogICAgfQogIH0KCiAgc3VzcGVuZCgpIHsKICAgIHRoaXMuX3N1c3BlbmRpbmcgPSB0cnVlCiAgICByZXR1cm4gdGhpcy51cGRhdGUoKQogIH0KCiAgcmVzdW1lKCkgewogICAgdGhpcy5fc3VzcGVuZGluZyA9IGZhbHNlCiAgICByZXR1cm4gdGhpcy51cGRhdGUoKQogIH0KCiAgYXN5bmMgdXBkYXRlKCkgewogICAgd2hpbGUgKHRoaXMuX3VwZGF0aW5nKSBhd2FpdCB0aGlzLl91cGRhdGluZ1NpZ25hbC53YWl0KCkKICAgIGlmICh0aGlzLl9zdXNwZW5kaW5nID09PSB0aGlzLl9zdXNwZW5kZWQgfHwgdGhpcy5jbG9zaW5nKSByZXR1cm4KICAgIHRoaXMuX3VwZGF0aW5nID0gdHJ1ZQogICAgdHJ5IHsKICAgICAgaWYgKHRoaXMuX3N1c3BlbmRpbmcpIGF3YWl0IHRoaXMuX3N1c3BlbmQoKQogICAgICBlbHNlIGF3YWl0IHRoaXMuX3Jlc3VtZSgpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl91cGRhdGluZyA9IGZhbHNlCiAgICAgIHRoaXMuX3VwZGF0aW5nU2lnbmFsLm5vdGlmeSgpCiAgICB9CiAgfQoKICBhc3luYyBfc3VzcGVuZCgpIHsKICAgIGlmICh0aGlzLl9zdXNwZW5kZWQgPT09IHRydWUpIHJldHVybgoKICAgIHdoaWxlICghdGhpcy5pby5pc0lkbGUoKSkgYXdhaXQgdGhpcy5pby5pZGxlKCkKCiAgICB0aGlzLmlvLmluYygpCiAgICB0aGlzLnJlc3VtZWQgPSBycnAoKQoKICAgIGNvbnN0IHJlcSA9IHsgcmVzb2x2ZTogbnVsbCwgcmVqZWN0OiBudWxsLCBoYW5kbGU6IG51bGwgfQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIHRyeSB7CiAgICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLnN1c3BlbmQodGhpcy5faGFuZGxlLCByZXEsIG9uc3VzcGVuZCkKCiAgICAgIGF3YWl0IHByb21pc2UKCiAgICAgIHRoaXMuX3N1c3BlbmRlZCA9IHRydWUKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuaW8uZGVjKCkKICAgIH0KCiAgICBmdW5jdGlvbiBvbnN1c3BlbmQoZXJyKSB7CiAgICAgIGlmIChlcnIpIHJlcS5yZWplY3QobmV3IEVycm9yKGVycikpCiAgICAgIGVsc2UgcmVxLnJlc29sdmUoKQogICAgfQogIH0KCiAgYXN5bmMgX3Jlc3VtZSgpIHsKICAgIGlmICh0aGlzLl9zdXNwZW5kZWQgPT09IGZhbHNlKSByZXR1cm4KCiAgICBjb25zdCByZXEgPSB7IHJlc29sdmU6IG51bGwsIHJlamVjdDogbnVsbCwgaGFuZGxlOiBudWxsIH0KCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgICAgcmVxLnJlamVjdCA9IHJlamVjdAogICAgfSkKCiAgICByZXEuaGFuZGxlID0gYmluZGluZy5yZXN1bWUodGhpcy5faGFuZGxlLCByZXEsIG9ucmVzdW1lKQoKICAgIGF3YWl0IHByb21pc2UKCiAgICB0aGlzLl9zdXNwZW5kZWQgPSBmYWxzZQoKICAgIGNvbnN0IHJlc3VtZWQgPSB0aGlzLnJlc3VtZWQKICAgIHRoaXMucmVzdW1lZCA9IG51bGwKICAgIHJlc3VtZWQucmVzb2x2ZSh0cnVlKQoKICAgIGZ1bmN0aW9uIG9ucmVzdW1lKGVycikgewogICAgICBpZiAoZXJyKSByZXEucmVqZWN0KG5ldyBFcnJvcihlcnIpKQogICAgICBlbHNlIHJlcS5yZXNvbHZlKCkKICAgIH0KICB9CgogIGFzeW5jIGNvbXBhY3RSYW5nZShkYiwgc3RhcnQsIGVuZCwgb3B0cykgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgdGhpcy5pby5pbmMoKQoKICAgIGNvbnN0IHsgZXhjbHVzaXZlID0gZmFsc2UgfSA9IG9wdHMKCiAgICBzdGFydCA9IHRoaXMuX2VuY29kZUtleShzdGFydCkKICAgIGVuZCA9IHRoaXMuX2VuY29kZUtleShlbmQpCgogICAgY29uc3QgcmVxID0geyByZXNvbHZlOiBudWxsLCByZWplY3Q6IG51bGwsIGhhbmRsZTogbnVsbCwgc3RhcnQsIGVuZCB9CgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICAgIHJlcS5yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgdHJ5IHsKICAgICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcuY29tcGFjdFJhbmdlKAogICAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgICBkYi5fY29sdW1uRmFtaWx5Ll9oYW5kbGUsCiAgICAgICAgc3RhcnQsCiAgICAgICAgZW5kLAogICAgICAgIGV4Y2x1c2l2ZSwKICAgICAgICByZXEsCiAgICAgICAgb25jb21wYWN0cmFuZ2UKICAgICAgKQoKICAgICAgYXdhaXQgcHJvbWlzZQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5pby5kZWMoKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uY29tcGFjdHJhbmdlKGVycikgewogICAgICBpZiAoZXJyKSByZXEucmVqZWN0KG5ldyBFcnJvcihlcnIpKQogICAgICBlbHNlIHJlcS5yZXNvbHZlKCkKICAgIH0KICB9CgogIGFzeW5jIGFwcHJveGltYXRlU2l6ZShkYiwgc3RhcnQsIGVuZCwgb3B0cykgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgdGhpcy5pby5pbmMoKQoKICAgIGNvbnN0IHsgaW5jbHVkZU1lbXRhYmxlcyA9IGZhbHNlLCBpbmNsdWRlRmlsZXMgPSB0cnVlLCBmaWxlc1NpemVFcnJvck1hcmdpbiA9IC0xIH0gPSBvcHRzCgogICAgc3RhcnQgPSB0aGlzLl9lbmNvZGVLZXkoc3RhcnQpCiAgICBlbmQgPSB0aGlzLl9lbmNvZGVLZXkoZW5kKQoKICAgIGNvbnN0IHJlcSA9IHsgcmVzb2x2ZTogbnVsbCwgcmVqZWN0OiBudWxsLCBoYW5kbGU6IG51bGwsIHN0YXJ0LCBlbmQgfQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIHRyeSB7CiAgICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLmFwcHJveGltYXRlU2l6ZSgKICAgICAgICB0aGlzLl9oYW5kbGUsCiAgICAgICAgZGIuX2NvbHVtbkZhbWlseS5faGFuZGxlLAogICAgICAgIHN0YXJ0LAogICAgICAgIGVuZCwKICAgICAgICBpbmNsdWRlTWVtdGFibGVzLAogICAgICAgIGluY2x1ZGVGaWxlcywKICAgICAgICBmaWxlc1NpemVFcnJvck1hcmdpbiwKICAgICAgICByZXEsCiAgICAgICAgb25hcHByb3hpbWF0ZXNpemUKICAgICAgKQoKICAgICAgcmV0dXJuIGF3YWl0IHByb21pc2UKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuaW8uZGVjKCkKICAgIH0KCiAgICBmdW5jdGlvbiBvbmFwcHJveGltYXRlc2l6ZShlcnIsIHJlc3VsdCkgewogICAgICBpZiAoZXJyKSByZXEucmVqZWN0KG5ldyBFcnJvcihlcnIpKQogICAgICBlbHNlIHJlcS5yZXNvbHZlKHJlc3VsdCkKICAgIH0KICB9CgogIF9lbmNvZGVLZXkoaykgewogICAgaWYgKHRoaXMuZGIuX2tleUVuY29kaW5nKSByZXR1cm4gYy5lbmNvZGUodGhpcy5kYi5fa2V5RW5jb2RpbmcsIGspCiAgICBpZiAodHlwZW9mIGsgPT09ICdzdHJpbmcnKSByZXR1cm4gQnVmZmVyLmZyb20oaykKICAgIGlmIChrID09PSBudWxsKSByZXR1cm4gZW1wdHkKICAgIHJldHVybiBrCiAgfQp9CnsKICAibmFtZSI6ICJyb2Nrc2RiLW5hdGl2ZSIsCiAgInZlcnNpb24iOiAiMy4xMS40IiwKICAiZGVzY3JpcHRpb24iOiAibGlicm9ja3NkYiBiaW5kaW5ncyBmb3IgSmF2YVNjcmlwdCIsCiAgImV4cG9ydHMiOiB7CiAgICAiLiI6ICIuL2luZGV4LmpzIiwKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iCiAgfSwKICAiaW1wb3J0cyI6IHsKICAgICJmcyI6ICJiYXJlLWZzIiwKICAgICJkZWZhdWx0IjogImZzIgogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJiaW5kaW5nLmNjIiwKICAgICJiaW5kaW5nLmpzIiwKICAgICJDTWFrZUxpc3RzLnR4dCIsCiAgICAibGliIiwKICAgICJwcmVidWlsZHMiLAogICAgIiFwcmVidWlsZHMvYW5kcm9pZC0qLyoqLyoubm9kZSIKICBdLAogICJhZGRvbiI6IHRydWUsCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4iLAogICAgInRlc3QiOiAibnBtIHJ1biBsaW50ICYmIG5wbSBydW4gdGVzdDpiYXJlICYmIG5wbSBydW4gdGVzdDpub2RlIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0LmpzIiwKICAgICJ0ZXN0Om5vZGUiOiAibm9kZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JvY2tzZGItbmF0aXZlLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYyIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yb2Nrc2RiLW5hdGl2ZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JvY2tzZGItbmF0aXZlIiwKICAiZW5naW5lcyI6IHsKICAgICJiYXJlIjogIj49MS4xNi4wIgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjE1LjAiLAogICAgInJlYWR5LXJlc291cmNlIjogIl4xLjAuMCIsCiAgICAicmVmY291bnRlciI6ICJeMS4wLjAiLAogICAgInJlcXVpcmUtYWRkb24iOiAiXjEuMC4yIiwKICAgICJyZXNvbHZlLXJlamVjdC1wcm9taXNlIjogIl4xLjEuMCIsCiAgICAic2lnbmFsLXByb21pc2UiOiAiXjEuMC4zIiwKICAgICJzdHJlYW14IjogIl4yLjE2LjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtY29tcGF0LW5hcGkiOiAiXjEuMy4wIiwKICAgICJiYXJlLWZzIjogIl40LjUuMCIsCiAgICAiYnJpdHRsZSI6ICJeMy41LjAiLAogICAgImNtYWtlLWJhcmUiOiAiXjEuMS4xNCIsCiAgICAiY21ha2UtZmV0Y2giOiAiXjEuMC4xIiwKICAgICJjbWFrZS1uYXBpIjogIl4xLjAuNiIsCiAgICAiZmQtbG9jayI6ICJeMi4wLjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiCiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gc2FmZXR5Q2F0Y2gKCmZ1bmN0aW9uIGlzQWN0dWFsbHlVbmNhdWdodCAoZXJyKSB7CiAgaWYgKCFlcnIpIHJldHVybiBmYWxzZQogIHJldHVybiBlcnIgaW5zdGFuY2VvZiBUeXBlRXJyb3IgfHwKICAgIGVyciBpbnN0YW5jZW9mIFN5bnRheEVycm9yIHx8CiAgICBlcnIgaW5zdGFuY2VvZiBSZWZlcmVuY2VFcnJvciB8fAogICAgZXJyIGluc3RhbmNlb2YgRXZhbEVycm9yIHx8CiAgICBlcnIgaW5zdGFuY2VvZiBSYW5nZUVycm9yIHx8CiAgICBlcnIgaW5zdGFuY2VvZiBVUklFcnJvciB8fAogICAgZXJyLmNvZGUgPT09ICdFUlJfQVNTRVJUSU9OJwp9CgpmdW5jdGlvbiB0aHJvd0Vycm9yTlQgKGVycikgewogIHF1ZXVlTWljcm90YXNrKCgpID0+IHsgdGhyb3cgZXJyIH0pCn0KCmZ1bmN0aW9uIHNhZmV0eUNhdGNoIChlcnIpIHsKICBpZiAoaXNBY3R1YWxseVVuY2F1Z2h0KGVycikpIHsKICAgIHRocm93RXJyb3JOVChlcnIpCiAgICB0aHJvdyBlcnIKICB9Cn0KewogICJuYW1lIjogInNhZmV0eS1jYXRjaCIsCiAgInZlcnNpb24iOiAiMS4wLjIiLAogICJkZXNjcmlwdGlvbiI6ICJTbWFsbCBtb2R1bGUgdGhhdCBtYWtlcyBzdXJlIHlvdXIgY2F0Y2gsIGNhdWdodCBhbiBhY3R1YWwgZXJyb3IgYW5kIG5vdCBhIHByb2dyYW1taW5nIG1pc3Rha2Ugb3IgYXNzZXJ0aW9uIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7fSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc2FmZXR5LWNhdGNoLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zYWZldHktY2F0Y2gvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc2FmZXR5LWNhdGNoIgp9CmxldCB0bXBSZXNvbHZlID0gbnVsbAoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBTY29wZUxvY2sgewogIGNvbnN0cnVjdG9yICh7IGRlYm91bmNlID0gZmFsc2UgfSA9IHt9KSB7CiAgICB0aGlzLmRlYm91bmNlID0gZGVib3VuY2UKICAgIHRoaXMud2FpdGluZyA9IFtdCiAgICB0aGlzLmxvY2tlZCA9IGZhbHNlCiAgICB0aGlzLnNraXAgPSAwCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCiAgfQoKICBmbHVzaCAoKSB7CiAgICBpZiAodGhpcy5sb2NrZWQgPT09IGZhbHNlICYmIHRoaXMud2FpdGluZy5sZW5ndGggPT09IDApIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5kZXN0cm95ZWQgPT09IGZhbHNlKQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZShzZXRUbXBSZXNvbHZlKQogICAgY29uc3QgcmVzb2x2ZSA9IHRtcFJlc29sdmUKCiAgICB0bXBSZXNvbHZlID0gbnVsbAogICAgdGhpcy53YWl0aW5nLnB1c2goeyBsb2NrOiBmYWxzZSwgcmVzb2x2ZSB9KQoKICAgIHJldHVybiBwcm9taXNlCiAgfQoKICBkZXN0cm95ICgpIHsKICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQogIH0KCiAgbG9jayAoKSB7CiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2Uoc2V0VG1wUmVzb2x2ZSkKICAgIGNvbnN0IHJlc29sdmUgPSB0bXBSZXNvbHZlCgogICAgdG1wUmVzb2x2ZSA9IG51bGwKCiAgICBpZiAodGhpcy5sb2NrZWQgPT09IHRydWUpIHsKICAgICAgdGhpcy53YWl0aW5nLnB1c2goeyBsb2NrOiB0cnVlLCByZXNvbHZlIH0pCiAgICAgIHJldHVybiBwcm9taXNlCiAgICB9CgogICAgaWYgKHRoaXMuZGVzdHJveWVkID09PSB0cnVlKSB7CiAgICAgIHJlc29sdmUoZmFsc2UpCiAgICAgIHJldHVybiBwcm9taXNlCiAgICB9CgogICAgdGhpcy5sb2NrZWQgPSB0cnVlCiAgICByZXNvbHZlKHRydWUpCgogICAgcmV0dXJuIHByb21pc2UKICB9CgogIHVubG9jayAoKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQgPT09IHRydWUpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLndhaXRpbmcubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLndhaXRpbmdbaV0ucmVzb2x2ZShmYWxzZSkKICAgICAgfQogICAgICB0aGlzLndhaXRpbmcgPSBbXQogICAgICB0aGlzLnNraXAgPSAwCiAgICAgIHRoaXMubG9ja2VkID0gZmFsc2UKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMuc2tpcCAhPT0gMCkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc2tpcDsgaSsrKSB7CiAgICAgICAgY29uc3QgeyBsb2NrLCByZXNvbHZlIH0gPSB0aGlzLndhaXRpbmdbaV0KICAgICAgICByZXNvbHZlKGxvY2sgPT09IGZhbHNlKQogICAgICB9CgogICAgICB0aGlzLndhaXRpbmcgPSB0aGlzLndhaXRpbmcuc2xpY2UodGhpcy5za2lwKQogICAgICB0aGlzLnNraXAgPSAwCiAgICB9CgogICAgd2hpbGUgKHRoaXMud2FpdGluZy5sZW5ndGggPiAwICYmIHRoaXMud2FpdGluZ1swXS5sb2NrID09PSBmYWxzZSkgewogICAgICB0aGlzLndhaXRpbmcuc2hpZnQoKS5yZXNvbHZlKHRydWUpCiAgICB9CgogICAgaWYgKHRoaXMud2FpdGluZy5sZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5sb2NrZWQgPSBmYWxzZQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCB7IHJlc29sdmUgfSA9IHRoaXMud2FpdGluZy5zaGlmdCgpCiAgICBpZiAodGhpcy5kZWJvdW5jZSA9PT0gdHJ1ZSkgdGhpcy5za2lwID0gdGhpcy53YWl0aW5nLmxlbmd0aAoKICAgIHJlc29sdmUodHJ1ZSkKICB9Cn0KCmZ1bmN0aW9uIHNldFRtcFJlc29sdmUgKHJlc29sdmUpIHsKICB0bXBSZXNvbHZlID0gcmVzb2x2ZQp9CnsKICAibmFtZSI6ICJzY29wZS1sb2NrIiwKICAidmVyc2lvbiI6ICIxLjIuNCIsCiAgImRlc2NyaXB0aW9uIjogIlNvbWUgY29uY3VycmVuY3kgc2VtYW50aWNzIGFyb3VuZCBlbnRlcmluZyBzY29wZXMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuNy4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4yIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zY29wZS1sb2NrLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYy4iLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc2NvcGUtbG9jay9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3Njb3BlLWxvY2siCn0KY29uc3Qgc2V0ID0gcmVxdWlyZSgndW5vcmRlcmVkLXNldCcpCgptb2R1bGUuZXhwb3J0cyA9IG9wdHMgPT4gbmV3IFNodWZmbGVkUHJpb3JpdHlRdWV1ZShvcHRzKQoKY2xhc3MgU2h1ZmZsZWRQcmlvcml0eVF1ZXVlIHsKICBjb25zdHJ1Y3RvciAob3B0cykgewogICAgdGhpcy5wcmlvcml0aWVzID0gW10KICAgIHRoaXMuZXF1YWxzID0gKG9wdHMgJiYgb3B0cy5lcXVhbHMpIHx8IG51bGwKICB9CgogIGdldCBsZW5ndGggKCkgewogICAgcmV0dXJuIHRoaXMucHJpb3JpdGllcy5yZWR1Y2UoYWRkLCAwKQogIH0KCiAgW1N5bWJvbC5pdGVyYXRvcl0gKCkgewogICAgcmV0dXJuIG5ldyBJdGVyYXRvcih0aGlzKQogIH0KCiAgaGVhZCAoKSB7CiAgICBmb3IgKGxldCBpID0gdGhpcy5wcmlvcml0aWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHEgPSB0aGlzLnByaW9yaXRpZXNbaV0KICAgICAgaWYgKHEubGVuZ3RoKSByZXR1cm4gc2h1ZmZsZShxLCAwKQogICAgfQogICAgcmV0dXJuIG51bGwKICB9CgogIHRhaWwgKCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnByaW9yaXRpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcSA9IHRoaXMucHJpb3JpdGllc1tpXQogICAgICBpZiAocS5sZW5ndGgpIHJldHVybiBzaHVmZmxlKHEsIDApCiAgICB9CiAgICByZXR1cm4gbnVsbAogIH0KCiAgcHJldiAocHJldikgewogICAgaWYgKCFwcmV2KSByZXR1cm4gdGhpcy50YWlsKCkKICAgIHJldHVybiBuZXh0KHRoaXMucHJpb3JpdGllcywgcHJldiwgMSkKICB9CgogIG5leHQgKHByZXYpIHsKICAgIGlmICghcHJldikgcmV0dXJuIHRoaXMuaGVhZCgpCiAgICByZXR1cm4gbmV4dCh0aGlzLnByaW9yaXRpZXMsIHByZXYsIC0xKQogIH0KCiAgc2hpZnQgKCkgewogICAgcmV0dXJuIHRoaXMucmVtb3ZlKHRoaXMuaGVhZCgpKQogIH0KCiAgcG9wICgpIHsKICAgIHJldHVybiB0aGlzLnJlbW92ZSh0aGlzLnRhaWwoKSkKICB9CgogIGFkZCAodmFsKSB7CiAgICBjb25zdCBwcmlvID0gdmFsLnByaW9yaXR5IHx8IDAKICAgIHdoaWxlIChwcmlvID49IHRoaXMucHJpb3JpdGllcy5sZW5ndGgpIHRoaXMucHJpb3JpdGllcy5wdXNoKFtdKQogICAgc2V0LmFkZCh0aGlzLnByaW9yaXRpZXNbcHJpb10sIHZhbCkKICAgIHJldHVybiB2YWwKICB9CgogIHJlbW92ZSAodmFsKSB7CiAgICBpZiAoIXZhbCkgcmV0dXJuIG51bGwKCiAgICBpZiAodmFsLl9pbmRleCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHZhbCA9IHRoaXMuZmluZCh2YWwpCiAgICAgIGlmICghdmFsKSByZXR1cm4gbnVsbAogICAgfQoKICAgIHJldHVybiBzZXQucmVtb3ZlKHRoaXMucHJpb3JpdGllc1t2YWwucHJpb3JpdHkgfHwgMF0sIHZhbCkKICB9CgogIGhhcyAodmFsKSB7CiAgICBpZiAodmFsLl9pbmRleCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdGhpcy5maW5kKHZhbCkKICAgIGNvbnN0IHByaW9yaXR5ID0gdmFsLnByaW9yaXR5IHx8IDAKICAgIGlmIChwcmlvcml0eSA+PSB0aGlzLnByaW9yaXRpZXMubGVuZ3RoKSByZXR1cm4gZmFsc2UKICAgIHJldHVybiBzZXQuaGFzKHRoaXMucHJpb3JpdGllc1twcmlvcml0eV0sIHZhbCkKICB9CgogIGZpbmQgKHZhbCkgewogICAgaWYgKHZhbC5faW5kZXggIT09IHVuZGVmaW5lZCkgcmV0dXJuIHZhbAoKICAgIGNvbnN0IHByaW8gPSB2YWwucHJpb3JpdHkgfHwgMAogICAgY29uc3QgcXMgPSB0aGlzLnByaW9yaXRpZXMKICAgIGlmIChwcmlvID49IHFzLmxlbmd0aCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBxID0gcXNbcHJpb10KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHEubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHRoaXMuZXF1YWxzKHFbaV0sIHZhbCkpIHJldHVybiBxW2ldCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9Cn0KCmNsYXNzIEl0ZXJhdG9yIHsKICBjb25zdHJ1Y3RvciAocXVldWUpIHsKICAgIHRoaXMucHJldiA9IG51bGwKICAgIHRoaXMucXVldWUgPSBxdWV1ZQogIH0KCiAgbmV4dCAoKSB7CiAgICBjb25zdCBuZXh0ID0gdGhpcy5xdWV1ZS5uZXh0KHRoaXMucHJldikKICAgIHRoaXMucHJldiA9IG5leHQKICAgIHJldHVybiB7IGRvbmU6ICFuZXh0LCB2YWx1ZTogbmV4dCB9CiAgfQp9CgpmdW5jdGlvbiBzaHVmZmxlIChxLCBpKSB7CiAgY29uc3QgcmFuID0gaSArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChxLmxlbmd0aCAtIGkpKQogIHNldC5zd2FwKHEsIHFbcmFuXSwgcVtpXSkKICByZXR1cm4gcVtpXQp9CgpmdW5jdGlvbiBuZXh0IChxdWV1ZXMsIHByZXYsIGluYykgewogIGxldCBpID0gcHJldi5wcmlvcml0eSB8fCAwCiAgbGV0IGogPSAocHJldi5faW5kZXggfHwgMCkgKyAxCgogIHdoaWxlICh0cnVlKSB7CiAgICBpZiAoaSA8IDAgfHwgaSA+PSBxdWV1ZXMubGVuZ3RoKSByZXR1cm4gbnVsbAogICAgY29uc3QgcSA9IHF1ZXVlc1tpXQoKICAgIGlmIChqID49IHEubGVuZ3RoKSB7CiAgICAgIGkgKz0gaW5jCiAgICAgIGogPSAwCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgcmV0dXJuIHNodWZmbGUocSwgaikKICB9Cn0KCmZ1bmN0aW9uIGFkZCAobGVuLCBiKSB7CiAgcmV0dXJuIGxlbiArIGIubGVuZ3RoCn0KewogICJuYW1lIjogInNodWZmbGVkLXByaW9yaXR5LXF1ZXVlIiwKICAidmVyc2lvbiI6ICIyLjEuMCIsCiAgImRlc2NyaXB0aW9uIjogIkEgcHJpb3JpdHkgcXVldWUgdGhhdCBzaHVmZmxlcyBlbGVtZW50cyB3aXRoIHRoZSBzYW1lIHByaW9yaXR5LiIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgdGFwZSB0ZXN0LmpzIgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJ1bm9yZGVyZWQtc2V0IjogIl4yLjAuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjEyLjAuMSIsCiAgICAidGFwZSI6ICJeNC45LjEiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc2h1ZmZsZWQtcHJpb3JpdHktcXVldWUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NodWZmbGVkLXByaW9yaXR5LXF1ZXVlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NodWZmbGVkLXByaW9yaXR5LXF1ZXVlIgp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU2lnbmFsIHsKICBjb25zdHJ1Y3RvciAoKSB7CiAgICB0aGlzLl9yZXNvbHZlID0gbnVsbAogICAgdGhpcy5fcmVqZWN0ID0gbnVsbAogICAgdGhpcy5fcHJvbWlzZSA9IG51bGwKICAgIHRoaXMuX2JpbmQgPSBiaW5kLmJpbmQodGhpcykKICAgIHRoaXMuX29uZXJyb3IgPSBjbGVhci5iaW5kKHRoaXMpCiAgICB0aGlzLl9vbnN1Y2Nlc3MgPSBjbGVhci5iaW5kKHRoaXMsIG51bGwpCiAgICB0aGlzLl90aW1lcnMgPSBuZXcgU2V0KCkKICB9CgogIHdhaXQgKG1heCkgewogICAgaWYgKCF0aGlzLl9wcm9taXNlKSB7CiAgICAgIHRoaXMuX3Byb21pc2UgPSBuZXcgUHJvbWlzZSh0aGlzLl9iaW5kKQogICAgICB0aGlzLl9wcm9taXNlLnRoZW4odGhpcy5fb25zdWNjZXNzKS5jYXRjaCh0aGlzLl9vbmVycm9yKQogICAgfQogICAgaWYgKG1heCkgcmV0dXJuIHRoaXMuX3NsZWVwKG1heCkKICAgIHJldHVybiB0aGlzLl9wcm9taXNlCiAgfQoKICBfc2xlZXAgKG1heCkgewogICAgY29uc3QgcyA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgY29uc3QgZG9uZSA9ICgpID0+IHsKICAgICAgICB0aGlzLl90aW1lcnMuZGVsZXRlKHN0YXRlKQogICAgICAgIHJlc29sdmUodHJ1ZSkKICAgICAgfQogICAgICBjb25zdCBpZCA9IHNldFRpbWVvdXQoZG9uZSwgbWF4KQogICAgICBjb25zdCBzdGF0ZSA9IHsgaWQsIHJlc29sdmUsIHJlamVjdCB9CiAgICAgIHRoaXMuX3RpbWVycy5hZGQoc3RhdGUpCiAgICB9KQoKICAgIHJldHVybiBzCiAgfQoKICBub3RpZnkgKGVycikgewogICAgaWYgKCF0aGlzLl9wcm9taXNlKSByZXR1cm4KICAgIGNvbnN0IHJlc29sdmUgPSB0aGlzLl9yZXNvbHZlCiAgICBjb25zdCByZWplY3QgPSB0aGlzLl9yZWplY3QKICAgIHRoaXMuX3Byb21pc2UgPSBudWxsCiAgICBpZiAoZXJyKSByZWplY3QoZXJyKQogICAgZWxzZSByZXNvbHZlKHRydWUpCiAgfQp9CgpmdW5jdGlvbiBjbGVhciAoZXJyKSB7CiAgZm9yIChjb25zdCB7IGlkLCByZXNvbHZlLCByZWplY3QgfSBvZiB0aGlzLl90aW1lcnMpIHsKICAgIGNsZWFyVGltZW91dChpZCkKICAgIGlmIChlcnIpIHJlamVjdChlcnIpCiAgICBlbHNlIHJlc29sdmUodHJ1ZSkKICB9CiAgdGhpcy5fdGltZXJzLmNsZWFyKCkKfQoKZnVuY3Rpb24gYmluZCAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgdGhpcy5fcmVzb2x2ZSA9IHJlc29sdmUKICB0aGlzLl9yZWplY3QgPSByZWplY3QKfQp7CiAgIm5hbWUiOiAic2lnbmFsLXByb21pc2UiLAogICJ2ZXJzaW9uIjogIjEuMC4zIiwKICAiZGVzY3JpcHRpb24iOiAiU2ltcGxlIHdhaXQvbm90aWZ5IHByb21pc2Ugd2l0aCBvcHRpb25hbCBtYXggd2FpdCB0aW1lIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7fSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc2lnbmFsLXByb21pc2UuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NpZ25hbC1wcm9taXNlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NpZ25hbC1wcm9taXNlIgp9CnZhciB2YXJpbnQgPSByZXF1aXJlKCd2YXJpbnQnKQpleHBvcnRzLmVuY29kZSA9IGZ1bmN0aW9uIGVuY29kZSAodiwgYiwgbykgewogIHYgPSB2ID49IDAgPyB2KjIgOiB2Ki0yIC0gMQogIHZhciByID0gdmFyaW50LmVuY29kZSh2LCBiLCBvKQogIGVuY29kZS5ieXRlcyA9IHZhcmludC5lbmNvZGUuYnl0ZXMKICByZXR1cm4gcgp9CmV4cG9ydHMuZGVjb2RlID0gZnVuY3Rpb24gZGVjb2RlIChiLCBvKSB7CiAgdmFyIHYgPSB2YXJpbnQuZGVjb2RlKGIsIG8pCiAgZGVjb2RlLmJ5dGVzID0gdmFyaW50LmRlY29kZS5ieXRlcwogIHJldHVybiB2ICYgMSA/ICh2KzEpIC8gLTIgOiB2IC8gMgp9CgpleHBvcnRzLmVuY29kaW5nTGVuZ3RoID0gZnVuY3Rpb24gKHYpIHsKICByZXR1cm4gdmFyaW50LmVuY29kaW5nTGVuZ3RoKHYgPj0gMCA/IHYqMiA6IHYqLTIgLSAxKQp9CnsKICAibmFtZSI6ICJzaWduZWQtdmFyaW50IiwKICAiZGVzY3JpcHRpb24iOiAiZWZmaWNpZW50bHkgc3RvcmUgc2lnbmVkIGludGVnZXJzIGluIHZhcmludCIsCiAgInZlcnNpb24iOiAiMi4wLjEiLAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vZG9taW5pY3RhcnIvc2lnbmVkLXZhcmludCIsCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQ6Ly9naXRodWIuY29tL2RvbWluaWN0YXJyL3NpZ25lZC12YXJpbnQuZ2l0IgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJ2YXJpbnQiOiAifjUuMC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJ0YXBlIjogIn4yLjEyLjMiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogIm5vZGUgdGVzdC5qcyIKICB9LAogICJhdXRob3IiOiAiRG9taW5pYyBUYXJyIDxkb21pbmljLnRhcnJAZ21haWwuY29tPiAoaHR0cDovL2RvbWluaWN0YXJyLmNvbSkiLAogICJsaWNlbnNlIjogIk1JVCIKfQpyZXF1aXJlLmFkZG9uID0gcmVxdWlyZSgncmVxdWlyZS1hZGRvbicpCgptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUuYWRkb24oJy4nLCBfX2ZpbGVuYW1lKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi9iaW5kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmZ1bmN0aW9uIHByZWRpY2F0ZSh1OCwgdTE2LCB1MzIpIHsKICByZXR1cm4gZnVuY3Rpb24gcHJlZGljYXRlKGJ1ZikgewogICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoICUgMTYgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXIgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNicpCiAgICB9CgogICAgY29uc3QgbiA9IGJ1Zi5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGlmIChuID09PSAxKSByZXR1cm4gdTgoYnVmKQogICAgaWYgKG4gPT09IDIpIHJldHVybiB1MTYoYnVmKQogICAgcmV0dXJuIHUzMihidWYpCiAgfQp9CgpmdW5jdGlvbiB1bmFyeSh1OCwgdTE2LCB1MzIpIHsKICByZXR1cm4gZnVuY3Rpb24gdW5hcnkoYnVmLCByZXN1bHQgPSBiNGEuYWxsb2NVbnNhZmUoYnVmLmJ5dGVMZW5ndGgpKSB7CiAgICBpZiAoYnVmLmJ5dGVMZW5ndGggJSAxNiAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0J1ZmZlciBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2JykKICAgIH0KCiAgICBpZiAoYnVmLmJ5dGVMZW5ndGggIT09IHJlc3VsdC5ieXRlTGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignTGVuZ3RoIG9mIHJlc3VsdCBidWZmZXIgaXMgaW5zdWZmaWNpZW50JykKICAgIH0KCiAgICBjb25zdCBuID0gYnVmLkJZVEVTX1BFUl9FTEVNRU5UCgogICAgaWYgKG4gPT09IDEpIHU4KGJ1ZiwgcmVzdWx0KQogICAgZWxzZSBpZiAobiA9PT0gMikgdTE2KGJ1ZiwgcmVzdWx0KQogICAgZWxzZSB1MzIoYnVmLCByZXN1bHQpCgogICAgcmV0dXJuIHJlc3VsdAogIH0KfQoKZnVuY3Rpb24gYmluYXJ5KHU4LCB1MTYsIHUzMikgewogIHJldHVybiBmdW5jdGlvbiBiaW5hcnkoYSwgYiwgcmVzdWx0ID0gYjRhLmFsbG9jVW5zYWZlKGEuYnl0ZUxlbmd0aCkpIHsKICAgIGlmIChhLmJ5dGVMZW5ndGggJSAxNiAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0J1ZmZlciBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2JykKICAgIH0KCiAgICBpZiAoYS5ieXRlTGVuZ3RoICE9PSBiLmJ5dGVMZW5ndGggfHwgYS5ieXRlTGVuZ3RoICE9PSByZXN1bHQuYnl0ZUxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0J1ZmZlcnMgbXVzdCBiZSB0aGUgc2FtZSBsZW5ndGgnKQogICAgfQoKICAgIGNvbnN0IG4gPSBhLkJZVEVTX1BFUl9FTEVNRU5UCgogICAgaWYgKG4gPT09IDEpIHU4KGEsIGIsIHJlc3VsdCkKICAgIGVsc2UgaWYgKG4gPT09IDIpIHUxNihhLCBiLCByZXN1bHQpCiAgICBlbHNlIHUzMihhLCBiLCByZXN1bHQpCgogICAgcmV0dXJuIHJlc3VsdAogIH0KfQoKZnVuY3Rpb24gcmVkdWNlKHU4LCB1MTYsIHUzMikgewogIHJldHVybiBmdW5jdGlvbiByZWR1Y2UoYnVmKSB7CiAgICBpZiAoYnVmLmJ5dGVMZW5ndGggJSAxNiAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0J1ZmZlciBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2JykKICAgIH0KCiAgICBjb25zdCBuID0gYnVmLkJZVEVTX1BFUl9FTEVNRU5UCgogICAgaWYgKG4gPT09IDEpIHJldHVybiB1OChidWYpCiAgICBpZiAobiA9PT0gMikgcmV0dXJuIHUxNihidWYpCiAgICByZXR1cm4gdTMyKGJ1ZikKICB9Cn0KCmV4cG9ydHMuYWxsbyA9IHByZWRpY2F0ZSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYWxsb192MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9hbGxvX3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9hbGxvX3YxMjhfdTMyCikKCmV4cG9ydHMuYWxseiA9IHByZWRpY2F0ZSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYWxsel92MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9hbGx6X3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9hbGx6X3YxMjhfdTMyCikKCmV4cG9ydHMuYW5kID0gYmluYXJ5KAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9hbmRfdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYW5kX3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9hbmRfdjEyOF91MzIKKQoKZXhwb3J0cy5jbGVhciA9IGJpbmFyeSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY2xlYXJfdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY2xlYXJfdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2NsZWFyX3YxMjhfdTMyCikKCmV4cG9ydHMuY2xvID0gdW5hcnkoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2Nsb192MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbG9fdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2Nsb192MTI4X3UzMgopCgpleHBvcnRzLmNseiA9IHVuYXJ5KAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbHpfdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY2x6X3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbHpfdjEyOF91MzIKKQoKZXhwb3J0cy5jbnQgPSB1bmFyeSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY250X3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2NudF92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY250X3YxMjhfdTMyCikKCmV4cG9ydHMuY3RvID0gdW5hcnkoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2N0b192MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jdG9fdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2N0b192MTI4X3UzMgopCgpleHBvcnRzLmN0eiA9IHVuYXJ5KAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jdHpfdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY3R6X3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jdHpfdjEyOF91MzIKKQoKZXhwb3J0cy5ub3QgPSB1bmFyeSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfbm90X3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX25vdF92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfbm90X3YxMjhfdTMyCikKCmV4cG9ydHMub3IgPSBiaW5hcnkoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX29yX3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX29yX3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9vcl92MTI4X3UzMgopCgpleHBvcnRzLnN1bSA9IHJlZHVjZSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfc3VtX3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX3N1bV92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfc3VtX3YxMjhfdTMyCikKCmV4cG9ydHMueG9yID0gYmluYXJ5KAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV94b3JfdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfeG9yX3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV94b3JfdjEyOF91MzIKKQp7CiAgIm5hbWUiOiAic2ltZGxlLW5hdGl2ZSIsCiAgInZlcnNpb24iOiAiMS4zLjkiLAogICJkZXNjcmlwdGlvbiI6ICJsaWJzaW1kbGUgSmF2YVNjcmlwdCBiaW5kaW5ncyBmb3IgTm9kZS5qcyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiYmluZGluZy5jYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiLAogICAgInByZWJ1aWxkcyIKICBdLAogICJhZGRvbiI6IHRydWUsCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4iLAogICAgInRlc3QiOiAibnBtIHJ1biBsaW50ICYmIG5wbSBydW4gdGVzdDpiYXJlICYmIG5wbSBydW4gdGVzdDpub2RlIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0Lm1qcyIsCiAgICAidGVzdDpub2RlIjogIm5vZGUgdGVzdC5tanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc2ltZGxlLW5hdGl2ZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zaW1kbGUtbmF0aXZlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc2ltZGxlLW5hdGl2ZSNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMCIsCiAgICAicmVxdWlyZS1hZGRvbiI6ICJeMS4xLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtY29tcGF0LW5hcGkiOiAiXjEuMy4yIiwKICAgICJicml0dGxlIjogIl4zLjEuMCIsCiAgICAiY21ha2UtYmFyZSI6ICJeMS4xLjciLAogICAgImNtYWtlLWZldGNoIjogIl4xLjEuMCIsCiAgICAiY21ha2UtbmFwaSI6ICJeMS4wLjIiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMS4wLjAiCiAgfQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHNjYWxhciA9IHJlcXVpcmUoJy4vc2NhbGFyJykKCmZ1bmN0aW9uIHZpZXcgKGJ1ZiwgbikgewogIGlmIChuID09PSBidWYuQllURVNfUEVSX0VMRU1FTlQpIHJldHVybiBidWYKCiAgbGV0IFR5cGVkQXJyYXkKCiAgaWYgKG4gPT09IDEpIFR5cGVkQXJyYXkgPSBVaW50OEFycmF5CiAgZWxzZSBpZiAobiA9PT0gMikgVHlwZWRBcnJheSA9IFVpbnQxNkFycmF5CiAgZWxzZSBUeXBlZEFycmF5ID0gVWludDMyQXJyYXkKCiAgcmV0dXJuIG5ldyBUeXBlZEFycmF5KGJ1Zi5idWZmZXIsIGJ1Zi5ieXRlT2Zmc2V0LCBidWYuYnl0ZUxlbmd0aCAvIG4pCn0KCmZ1bmN0aW9uIHVuYXJ5ICh1OCwgdTE2ID0gdTgsIHUzMiA9IHUxNikgewogIHJldHVybiBmdW5jdGlvbiB1bmFyeSAoYnVmLCByZXN1bHQgPSBiNGEuYWxsb2NVbnNhZmUoYnVmLmJ5dGVMZW5ndGgpKSB7CiAgICBpZiAoYnVmLmJ5dGVMZW5ndGggJSAxNiAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0J1ZmZlciBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2JykKICAgIH0KCiAgICBpZiAoYnVmLmJ5dGVMZW5ndGggIT09IHJlc3VsdC5ieXRlTGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignTGVuZ3RoIG9mIHJlc3VsdCBidWZmZXIgaXMgaW5zdWZmaWNpZW50JykKICAgIH0KCiAgICBjb25zdCBuID0gYnVmLkJZVEVTX1BFUl9FTEVNRU5UCgogICAgaWYgKG4gPT09IDEpIHU4KGJ1ZiwgdmlldyhyZXN1bHQsIG4pKQogICAgZWxzZSBpZiAobiA9PT0gMikgdTE2KGJ1ZiwgdmlldyhyZXN1bHQsIG4pKQogICAgZWxzZSB1MzIoYnVmLCB2aWV3KHJlc3VsdCwgbikpCgogICAgcmV0dXJuIHJlc3VsdAogIH0KfQoKZnVuY3Rpb24gYmluYXJ5ICh1OCwgdTE2ID0gdTgsIHUzMiA9IHUxNikgewogIHJldHVybiBmdW5jdGlvbiBiaW5hcnkgKGEsIGIsIHJlc3VsdCA9IGI0YS5hbGxvY1Vuc2FmZShhLmJ5dGVMZW5ndGgpKSB7CiAgICBpZiAoYS5ieXRlTGVuZ3RoICUgMTYgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXIgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNicpCiAgICB9CgogICAgaWYgKGEuYnl0ZUxlbmd0aCAhPT0gYi5ieXRlTGVuZ3RoIHx8IGEuYnl0ZUxlbmd0aCAhPT0gcmVzdWx0LmJ5dGVMZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXJzIG11c3QgYmUgdGhlIHNhbWUgbGVuZ3RoJykKICAgIH0KCiAgICBjb25zdCBuID0gYS5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGlmIChuID09PSAxKSB1OChhLCBiLCB2aWV3KHJlc3VsdCwgbikpCiAgICBlbHNlIGlmIChuID09PSAyKSB1MTYoYSwgYiwgdmlldyhyZXN1bHQsIG4pKQogICAgZWxzZSB1MzIoYSwgYiwgdmlldyhyZXN1bHQsIG4pKQoKICAgIHJldHVybiByZXN1bHQKICB9Cn0KCmZ1bmN0aW9uIHJlZHVjZSAodTgsIHUxNiA9IHU4LCB1MzIgPSB1MTYpIHsKICByZXR1cm4gZnVuY3Rpb24gcmVkdWNlIChidWYpIHsKICAgIGlmIChidWYuYnl0ZUxlbmd0aCAlIDE2ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQnVmZmVyIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYnKQogICAgfQoKICAgIGNvbnN0IG4gPSBidWYuQllURVNfUEVSX0VMRU1FTlQKCiAgICBpZiAobiA9PT0gMSkgcmV0dXJuIHU4KGJ1ZikKICAgIGlmIChuID09PSAyKSByZXR1cm4gdTE2KGJ1ZikKICAgIHJldHVybiB1MzIoYnVmKQogIH0KfQoKZXhwb3J0cy5hbGxvID0gZnVuY3Rpb24gYWxsbyAoYnVmKSB7CiAgaWYgKGJ1Zi5ieXRlTGVuZ3RoICUgMTYgIT09IDApIHsKICAgIHRocm93IG5ldyBFcnJvcignQnVmZmVyIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYnKQogIH0KCiAgY29uc3QgbSA9IDIgKiogKGJ1Zi5CWVRFU19QRVJfRUxFTUVOVCAqIDgpIC0gMQoKICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgIGlmIChidWZbaV0gIT09IG0pIHJldHVybiBmYWxzZQogIH0KCiAgcmV0dXJuIHRydWUKfQoKZXhwb3J0cy5hbGx6ID0gZnVuY3Rpb24gYWxseiAoYnVmKSB7CiAgaWYgKGJ1Zi5ieXRlTGVuZ3RoICUgMTYgIT09IDApIHsKICAgIHRocm93IG5ldyBFcnJvcignQnVmZmVyIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYnKQogIH0KCiAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICBpZiAoYnVmW2ldICE9PSAwKSByZXR1cm4gZmFsc2UKICB9CgogIHJldHVybiB0cnVlCn0KCmV4cG9ydHMuYW5kID0gYmluYXJ5KAogIChhLCBiLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gcmVzdWx0Lmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBhW2ldICYgYltpXQogICAgfQogIH0KKQoKZXhwb3J0cy5jbGVhciA9IGJpbmFyeSgKICAoYSwgYiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IHJlc3VsdC5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gYVtpXSAmIH5iW2ldCiAgICB9CiAgfQopCgpleHBvcnRzLmNsbyA9IHVuYXJ5KAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IDI0IC0gc2NhbGFyLmNsbyhidWZbaV0pCiAgICB9CiAgfSwKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSAxNiAtIHNjYWxhci5jbG8oYnVmW2ldKQogICAgfQogIH0sCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gc2NhbGFyLmNsbyhidWZbaV0pCiAgICB9CiAgfQopCgpleHBvcnRzLmNseiA9IHVuYXJ5KAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IDI0IC0gc2NhbGFyLmNseihidWZbaV0pCiAgICB9CiAgfSwKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSAxNiAtIHNjYWxhci5jbHooYnVmW2ldKQogICAgfQogIH0sCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gc2NhbGFyLmNseihidWZbaV0pCiAgICB9CiAgfQopCgpleHBvcnRzLmNudCA9IHVuYXJ5KAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IHNjYWxhci5jbnQoYnVmW2ldKSAmIDB4ZmYKICAgIH0KICB9LAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IHNjYWxhci5jbnQoYnVmW2ldKSAmIDB4ZmZmZgogICAgfQogIH0sCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gc2NhbGFyLmNudChidWZbaV0pCiAgICB9CiAgfQopCgpleHBvcnRzLmN0byA9IHVuYXJ5KAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IE1hdGgubWluKHNjYWxhci5jdG8oYnVmW2ldKSwgOCkKICAgIH0KICB9LAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IE1hdGgubWluKHNjYWxhci5jdG8oYnVmW2ldKSwgMTYpCiAgICB9CiAgfSwKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBzY2FsYXIuY3RvKGJ1ZltpXSkKICAgIH0KICB9CikKCmV4cG9ydHMuY3R6ID0gdW5hcnkoCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gTWF0aC5taW4oc2NhbGFyLmN0eihidWZbaV0pLCA4KQogICAgfQogIH0sCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gTWF0aC5taW4oc2NhbGFyLmN0eihidWZbaV0pLCAxNikKICAgIH0KICB9LAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IHNjYWxhci5jdHooYnVmW2ldKQogICAgfQogIH0KKQoKZXhwb3J0cy5ub3QgPSB1bmFyeSgKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSB+YnVmW2ldCiAgICB9CiAgfQopCgpleHBvcnRzLm9yID0gYmluYXJ5KAogIChhLCBiLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gcmVzdWx0Lmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBhW2ldIHwgYltpXQogICAgfQogIH0KKQoKZXhwb3J0cy5zdW0gPSByZWR1Y2UoCiAgKGJ1ZikgPT4gewogICAgbGV0IHJlc3VsdCA9IDBuCgogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdCArPSBCaWdJbnQoYnVmW2ldKQogICAgfQoKICAgIHJldHVybiByZXN1bHQKICB9CikKCmV4cG9ydHMueG9yID0gYmluYXJ5KAogIChhLCBiLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gcmVzdWx0Lmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBhW2ldIF4gYltpXQogICAgfQogIH0KKQp0cnkgewogIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnc2ltZGxlLW5hdGl2ZScpCn0gY2F0Y2ggewogIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi9mYWxsYmFjaycpCn0KewogICJuYW1lIjogInNpbWRsZS11bml2ZXJzYWwiLAogICJ2ZXJzaW9uIjogIjEuMS4yIiwKICAiZGVzY3JpcHRpb24iOiAiVW5pdmVyc2FsIHdyYXBwZXIgZm9yIGxpYnNpbWRsZSB3aXRoIGEgSmF2YVNjcmlwdCBmYWxsYmFjayIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJmYWxsYmFjay5qcyIsCiAgICAiaW5kZXguanMiLAogICAgInNjYWxhci5qcyIKICBdLAogICJicm93c2VyIjogewogICAgIi4vaW5kZXguanMiOiAiLi9mYWxsYmFjay5qcyIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0Lm1qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zaW1kbGUtdW5pdmVyc2FsLmdpdCIKICB9LAogICJhdXRob3IiOiAiS2FzcGVyIElzYWdlciBEYWxzZ2Fyw7AgPGthc3BlckBmdW5rdGlvbmVsLmNvPiIsCiAgImxpY2Vuc2UiOiAiSVNDIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NpbWRsZS11bml2ZXJzYWwvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zaW1kbGUtdW5pdmVyc2FsI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi4wIgogIH0sCiAgIm9wdGlvbmFsRGVwZW5kZW5jaWVzIjogewogICAgInNpbWRsZS1uYXRpdmUiOiAiXjEuMS4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjEuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9Cn0KY29uc3QgY2x6ID0gZXhwb3J0cy5jbHogPSBmdW5jdGlvbiBjbHogKG4pIHsKICByZXR1cm4gTWF0aC5jbHozMihuKQp9CgpleHBvcnRzLmNsbyA9IGZ1bmN0aW9uIGNsbyAobikgewogIHJldHVybiBjbHoofm4pCn0KCmNvbnN0IGN0eiA9IGV4cG9ydHMuY3R6ID0gZnVuY3Rpb24gY3R6IChuKSB7CiAgcmV0dXJuIDMyIC0gKG4gPT09IDAgPyAwIDogKGNseihuICYgLW4pICsgMSkpCn0KCmV4cG9ydHMuY3RvID0gZnVuY3Rpb24gY3RvIChuKSB7CiAgcmV0dXJuIGN0eih+bikKfQoKZXhwb3J0cy5jbnQgPSBmdW5jdGlvbiBjbnQgKG4pIHsKICBuID0gbiAtICgobiA+Pj4gMSkgJiAweDU1NTU1NTU1KQogIG4gPSAobiAmIDB4MzMzMzMzMzMpICsgKChuID4+PiAyKSAmIDB4MzMzMzMzMzMpCiAgbiA9IChuICsgKG4gPj4+IDQpKSAmIDB4MGYwZjBmMGYKICBuID0gKG4gKiAweDAxMDEwMTAxKSA+Pj4gMjQKICByZXR1cm4gbgp9CnJlcXVpcmUuYWRkb24gPSByZXF1aXJlKCdyZXF1aXJlLWFkZG9uJykKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCcuJywgX19maWxlbmFtZSkKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4vYmluZGluZycpCmNvbnN0IHsgaXNOb2RlIH0gPSByZXF1aXJlKCd3aGljaC1ydW50aW1lJykKCmNvbnN0IE9QVElPTkFMID0gQnVmZmVyLmZyb20obmV3IEFycmF5QnVmZmVyKDApKQoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0geyAuLi5iaW5kaW5nIH0KCi8vIG1lbW9yeQoKZXhwb3J0cy5zb2RpdW1fbWVtemVybyA9IGZ1bmN0aW9uIChidWYpIHsKICBiaW5kaW5nLnNvZGl1bV9tZW16ZXJvKGJ1ZikKfQoKZXhwb3J0cy5zb2RpdW1fbWxvY2sgPSBmdW5jdGlvbiAoYnVmKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5zb2RpdW1fbWxvY2soYnVmKQogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignbWVtb3J5IGxvY2sgZmFpbGVkJykKfQoKZXhwb3J0cy5zb2RpdW1fbXVubG9jayA9IGZ1bmN0aW9uIChidWYpIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLnNvZGl1bV9tdW5sb2NrKGJ1ZikKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ21lbW9yeSB1bmxvY2sgZmFpbGVkJykKfQoKZXhwb3J0cy5zb2RpdW1fbWFsbG9jID0gZnVuY3Rpb24gKHNpemUpIHsKICBpZiAoc2l6ZSA8IDApIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBzaXplJykKICBjb25zdCBidWYgPSBCdWZmZXIuZnJvbShiaW5kaW5nLnNvZGl1bV9tYWxsb2Moc2l6ZSkpCiAgYnVmLnNlY3VyZSA9IHRydWUKCiAgcmV0dXJuIGJ1Zgp9CgpleHBvcnRzLnNvZGl1bV9mcmVlID0gZnVuY3Rpb24gKGJ1ZikgewogIGlmICghYnVmPy5zZWN1cmUpIHJldHVybgoKICBiaW5kaW5nLnNvZGl1bV9mcmVlKGJ1Zi5idWZmZXIpCn0KCmV4cG9ydHMuc29kaXVtX21wcm90ZWN0X25vYWNjZXNzID0gZnVuY3Rpb24gKGJ1ZikgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuc29kaXVtX21wcm90ZWN0X25vYWNjZXNzKGJ1Zi5idWZmZXIpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIGxvY2sgYnVmZmVyJykKfQoKZXhwb3J0cy5zb2RpdW1fbXByb3RlY3RfcmVhZG9ubHkgPSBmdW5jdGlvbiAoYnVmKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5zb2RpdW1fbXByb3RlY3RfcmVhZG9ubHkoYnVmLmJ1ZmZlcikKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdmYWlsZWQgdG8gdW5sb2NrIGJ1ZmZlcicpCn0KCmV4cG9ydHMuc29kaXVtX21wcm90ZWN0X3JlYWR3cml0ZSA9IGZ1bmN0aW9uIChidWYpIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLnNvZGl1bV9tcHJvdGVjdF9yZWFkd3JpdGUoYnVmLmJ1ZmZlcikKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdmYWlsZWQgdG8gdW5sb2NrIGJ1ZmZlcicpCn0KCi8vIGNyeXB0b19yYW5kb21ieXRlcwoKZXhwb3J0cy5yYW5kb21ieXRlc19idWYgPSBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgYmluZGluZy5yYW5kb21ieXRlc19idWYoYnVmZmVyLmJ1ZmZlciwgYnVmZmVyLmJ5dGVPZmZzZXQsIGJ1ZmZlci5ieXRlTGVuZ3RoKQp9CgpleHBvcnRzLnJhbmRvbWJ5dGVzX2J1Zl9kZXRlcm1pbmlzdGljID0gZnVuY3Rpb24gKGJ1ZmZlciwgc2VlZCkgewogIGJpbmRpbmcucmFuZG9tYnl0ZXNfYnVmX2RldGVybWluaXN0aWMoCiAgICBidWZmZXIuYnVmZmVyLAogICAgYnVmZmVyLmJ5dGVPZmZzZXQsCiAgICBidWZmZXIuYnl0ZUxlbmd0aCwKCiAgICBzZWVkLmJ1ZmZlciwKICAgIHNlZWQuYnl0ZU9mZnNldCwKICAgIHNlZWQuYnl0ZUxlbmd0aAogICkKfQoKLy8gc29kaXVtX2hlbHBlcnMKCmV4cG9ydHMuc29kaXVtX21lbWNtcCA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgaWYgKGE/LmJ5dGVMZW5ndGggIT09IGI/LmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2J1ZmZlcnMgbXVzdCBiZSBvZiBzYW1lIGxlbmd0aCInKQogIHJldHVybiBiaW5kaW5nLnNvZGl1bV9tZW1jbXAoYSwgYikKfQoKZXhwb3J0cy5zb2RpdW1fYWRkID0gZnVuY3Rpb24gKGEsIGIpIHsKICBpZiAoYT8uYnl0ZUxlbmd0aCAhPT0gYj8uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYnVmZmVycyBtdXN0IGJlIG9mIHNhbWUgbGVuZ3RoIicpCiAgYmluZGluZy5zb2RpdW1fYWRkKGEsIGIpCn0KCmV4cG9ydHMuc29kaXVtX3N1YiA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgaWYgKGE/LmJ5dGVMZW5ndGggIT09IGI/LmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2J1ZmZlcnMgbXVzdCBiZSBvZiBzYW1lIGxlbmd0aCInKQogIGJpbmRpbmcuc29kaXVtX3N1YihhLCBiKQp9CgpleHBvcnRzLnNvZGl1bV9jb21wYXJlID0gZnVuY3Rpb24gKGEsIGIpIHsKICBpZiAoYT8uYnl0ZUxlbmd0aCAhPT0gYj8uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYnVmZmVycyBtdXN0IGJlIG9mIHNhbWUgbGVuZ3RoIicpCiAgcmV0dXJuIGJpbmRpbmcuc29kaXVtX2NvbXBhcmUoYSwgYikKfQoKZXhwb3J0cy5zb2RpdW1faXNfemVybyA9IGZ1bmN0aW9uIChidWZmZXIsIGxlbmd0aCkgewogIGlmICghYnVmZmVyKSB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgYnVmZmVyJykKICBsZW5ndGggPz89IGJ1ZmZlci5ieXRlTGVuZ3RoCiAgaWYgKGxlbmd0aCA+IGJ1ZmZlci5ieXRlTGVuZ3RoIHx8IGxlbmd0aCA8IDApCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgbGVuZ3RoJykKCiAgcmV0dXJuIGJpbmRpbmcuc29kaXVtX2lzX3plcm8oYnVmZmVyLCBsZW5ndGgpCn0KCmV4cG9ydHMuc29kaXVtX3BhZCA9IGZ1bmN0aW9uIChidWZmZXIsIHVucGFkZGVkQnVmbGVuLCBibG9ja1NpemUpIHsKICBpZiAodW5wYWRkZWRCdWZsZW4gPiBidWZmZXIuYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcigndW5wYWRkZWQgbGVuZ3RoIGNhbm5vdCBleGNlZWQgYnVmZmVyIGxlbmd0aCcpCiAgaWYgKGJsb2NrU2l6ZSA+IGJ1ZmZlci5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdibG9jayBzaXplIGNhbm5vdCBleGNlZWQgYnVmZmVyIGxlbmd0aCcpCiAgaWYgKGJsb2NrU2l6ZSA8IDEpIHRocm93IG5ldyBFcnJvcignYmxvY2sgc2l6ZW11c3QgYmUgYXQgbGVhc3QgMSBieXRlJykKICBpZiAoCiAgICBidWZmZXI/LmJ5dGVMZW5ndGggPAogICAgdW5wYWRkZWRCdWZsZW4gKyAoYmxvY2tTaXplIC0gKHVucGFkZGVkQnVmbGVuICUgYmxvY2tTaXplKSkKICApCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2J1ZiBub3QgbG9uZyBlbm91Z2gnKQoKICByZXR1cm4gYmluZGluZy5zb2RpdW1fcGFkKGJ1ZmZlciwgdW5wYWRkZWRCdWZsZW4sIGJsb2NrU2l6ZSkKfQoKZXhwb3J0cy5zb2RpdW1fdW5wYWQgPSBmdW5jdGlvbiAoYnVmZmVyLCBwYWRkZWRCdWZsZW4sIGJsb2NrU2l6ZSkgewogIGlmIChwYWRkZWRCdWZsZW4gPiBidWZmZXIuYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcigndW5wYWRkZWQgbGVuZ3RoIGNhbm5vdCBleGNlZWQgYnVmZmVyIGxlbmd0aCcpCiAgaWYgKGJsb2NrU2l6ZSA+IGJ1ZmZlci5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdibG9jayBzaXplIGNhbm5vdCBleGNlZWQgYnVmZmVyIGxlbmd0aCcpCiAgaWYgKGJsb2NrU2l6ZSA8IDEpIHRocm93IG5ldyBFcnJvcignYmxvY2sgc2l6ZSBtdXN0IGJlIGF0IGxlYXN0IDEgYnl0ZScpCgogIHJldHVybiBiaW5kaW5nLnNvZGl1bV91bnBhZChidWZmZXIsIHBhZGRlZEJ1ZmxlbiwgYmxvY2tTaXplKQp9CgovLyBjcnlwdG9fc2lnbgoKZXhwb3J0cy5jcnlwdG9fc2lnbl9rZXlwYWlyID0gZnVuY3Rpb24gKHBrLCBzaykgewogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zaWduX2tleXBhaXIocGssIHNrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2lnbl9zZWVkX2tleXBhaXIgPSBmdW5jdGlvbiAocGssIHNrLCBzZWVkKSB7CiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NpZ25fc2VlZF9rZXlwYWlyKHBrLCBzaywgc2VlZCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NpZ24gPSBmdW5jdGlvbiAoc20sIG0sIHNrKSB7CiAgaWYgKHNtPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX0JZVEVTICsgbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdzbSBtdXN0IGJlICJtLmJ5dGVMZW5ndGggKyBjcnlwdG9fc2lnbl9CWVRFUyIgYnl0ZXMnKQogIGlmIChzaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9TRUNSRVRLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zaWduKHNtLCBtLCBzaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NpZ25fb3BlbiA9IGZ1bmN0aW9uIChtLCBzbSwgcGspIHsKICBpZiAoc20/LmJ5dGVMZW5ndGggPCBiaW5kaW5nLmNyeXB0b19zaWduX0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3NtJykKICBpZiAobT8uYnl0ZUxlbmd0aCAhPT0gc20uYnl0ZUxlbmd0aCAtIGJpbmRpbmcuY3J5cHRvX3NpZ25fQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAic20uYnl0ZUxlbmd0aCAtIGNyeXB0b19zaWduX0JZVEVTIiBieXRlcycpCiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NpZ25fb3BlbihtLCBzbSwgcGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zaWduX29wZW4gPSBmdW5jdGlvbiAobSwgc20sIHBrKSB7CiAgaWYgKHNtPy5ieXRlTGVuZ3RoIDwgYmluZGluZy5jcnlwdG9fc2lnbl9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdzbScpCiAgaWYgKG0/LmJ5dGVMZW5ndGggIT09IHNtLmJ5dGVMZW5ndGggLSBiaW5kaW5nLmNyeXB0b19zaWduX0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgInNtLmJ5dGVMZW5ndGggLSBjcnlwdG9fc2lnbl9CWVRFUyIgYnl0ZXMnKQogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQoKICByZXR1cm4gYmluZGluZy5jcnlwdG9fc2lnbl9vcGVuKG0sIHNtLCBwaykKfQoKZXhwb3J0cy5jcnlwdG9fc2lnbl9kZXRhY2hlZCA9IGZ1bmN0aW9uIChzaWcsIG0sIHNrKSB7CiAgaWYgKHNpZz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdzaWcnKQogIGlmIChzaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9TRUNSRVRLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zaWduX2RldGFjaGVkKHNpZywgbSwgc2spCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zaWduX3ZlcmlmeV9kZXRhY2hlZCA9IGZ1bmN0aW9uIChzaWcsIG0sIHBrKSB7CiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX3NpZ25fdmVyaWZ5X2RldGFjaGVkKAogICAgc2lnLmJ1ZmZlciwKICAgIHNpZy5ieXRlT2Zmc2V0LAogICAgc2lnLmJ5dGVMZW5ndGgsCgogICAgbS5idWZmZXIsCiAgICBtLmJ5dGVPZmZzZXQsCiAgICBtLmJ5dGVMZW5ndGgsCgogICAgcGsuYnVmZmVyLAogICAgcGsuYnl0ZU9mZnNldCwKICAgIHBrLmJ5dGVMZW5ndGgKICApCn0KCmV4cG9ydHMuY3J5cHRvX3NpZ25fZWQyNTUxOV9za190b19wayA9IGZ1bmN0aW9uIChwaywgc2spIHsKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKICBpZiAoc2s/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2lnbl9lZDI1NTE5X3NrX3RvX3BrKHBrLCBzaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NpZ25fZWQyNTUxOV9wa190b19jdXJ2ZTI1NTE5ID0gZnVuY3Rpb24gKHgyNTUxOXBrLCBlZDI1NTE5cGspIHsKICBpZiAoeDI1NTE5cGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2JveF9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigneDI1NTE5X3BrJykKICBpZiAoZWQyNTUxOXBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdlZDI1NTE5X3BrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2lnbl9lZDI1NTE5X3BrX3RvX2N1cnZlMjU1MTkoeDI1NTE5cGssIGVkMjU1MTlwaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NpZ25fZWQyNTUxOV9za190b19jdXJ2ZTI1NTE5ID0gZnVuY3Rpb24gKHgyNTUxOXNrLCBlZDI1NTE5c2spIHsKICBpZiAoeDI1NTE5c2s/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2JveF9TRUNSRVRLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigneDI1NTE5X3NrJykKCiAgY29uc3QgZWRMZW4gPSBlZDI1NTE5c2suYnl0ZUxlbmd0aAoKICBpZiAoCiAgICBlZExlbiAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9TRUNSRVRLRVlCWVRFUyAmJgogICAgZWRMZW4gIT09IGJpbmRpbmcuY3J5cHRvX2JveF9TRUNSRVRLRVlCWVRFUwogICkgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAiZWQyNTUxOV9zayBzaG91bGQgZWl0aGVyIGJlICdjcnlwdG9fc2lnbl9TRUNSRVRLRVlCWVRFUycgYnl0ZXMgb3IgJ2NyeXB0b19zaWduX1NFQ1JFVEtFWUJZVEVTIC0gY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMnIGJ5dGVzIgogICAgKQogIH0KCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2lnbl9lZDI1NTE5X3NrX3RvX2N1cnZlMjU1MTkoeDI1NTE5c2ssIGVkMjU1MTlzaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCi8vIGNyeXB0b19ib3gKCmV4cG9ydHMuY3J5cHRvX2JveF9rZXlwYWlyID0gZnVuY3Rpb24gKHBrLCBzaykgewogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYm94X1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwaycpCiAgaWYgKHNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19ib3hfU0VDUkVUS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYm94X2tleXBhaXIocGssIHNrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fYm94X3NlZWRfa2V5cGFpciA9IGZ1bmN0aW9uIChwaywgc2ssIHNlZWQpIHsKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2JveF9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQogIGlmIChzaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYm94X1NFQ1JFVEtFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2JveF9zZWVkX2tleXBhaXIocGssIHNrLCBzZWVkKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fYm94X2Vhc3kgPSBmdW5jdGlvbiAoYywgbSwgbiwgcGssIHNrKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYm94X2Vhc3koYywgbSwgbiwgcGssIHNrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fYm94X2RldGFjaGVkID0gZnVuY3Rpb24gKGMsIG1hYywgbSwgbiwgcGssIHNrKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYm94X2RldGFjaGVkKGMsIG1hYywgbSwgbiwgcGssIHNrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fYm94X3NlYWwgPSBmdW5jdGlvbiAoYywgbSwgcGspIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19ib3hfc2VhbChjLCBtLCBwaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2JveF9zZWFsX29wZW4gPSBmdW5jdGlvbiAobSwgYywgcGssIHNrKSB7CiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX2JveF9zZWFsX29wZW4oCiAgICBtLmJ1ZmZlciwKICAgIG0uYnl0ZU9mZnNldCwKICAgIG0uYnl0ZUxlbmd0aCwKCiAgICBjLmJ1ZmZlciwKICAgIGMuYnl0ZU9mZnNldCwKICAgIGMuYnl0ZUxlbmd0aCwKCiAgICBway5idWZmZXIsCiAgICBway5ieXRlT2Zmc2V0LAogICAgcGsuYnl0ZUxlbmd0aCwKCiAgICBzay5idWZmZXIsCiAgICBzay5ieXRlT2Zmc2V0LAogICAgc2suYnl0ZUxlbmd0aAogICkKfQoKLy8gY3J5cHRvX3NlY3JldGJveAoKZXhwb3J0cy5jcnlwdG9fc2VjcmV0Ym94X2Vhc3kgPSBmdW5jdGlvbiAoYywgbSwgbiwgaykgewogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGggKyBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfTUFDQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICdjIG11c3QgYmUgIm0uYnl0ZUxlbmd0aCArIGNyeXB0b19zZWNyZXRib3hfTUFDQllURVMiIGJ5dGVzJwogICAgKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9LRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X2Vhc3koYywgbSwgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NlY3JldGJveF9vcGVuX2Vhc3kgPSBmdW5jdGlvbiAobSwgYywgbiwgaykgewogIGlmIChtPy5ieXRlTGVuZ3RoICE9PSBjLmJ5dGVMZW5ndGggLSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfTUFDQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYyAtIGNyeXB0b19zZWNyZXRib3hfTUFDQllURVMiIGJ5dGVzJykKICBpZiAoYz8uYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9NQUNCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdjJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignaycpCgogIHJldHVybiBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfb3Blbl9lYXN5KG0sIGMsIG4sIGspCn0KCmV4cG9ydHMuY3J5cHRvX3NlY3JldGJveF9kZXRhY2hlZCA9IGZ1bmN0aW9uIChjLCBtYWMsIG0sIG4sIGspIHsKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdjIG11c3QgIm0uYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChtYWM/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9NQUNCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbWFjJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9kZXRhY2hlZChjLCBtYWMsIG0sIG4sIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zZWNyZXRib3hfb3Blbl9kZXRhY2hlZCA9IGZ1bmN0aW9uIChtLCBjLCBtYWMsIG4sIGspIHsKICBpZiAobT8uYnl0ZUxlbmd0aCAhPT0gYy5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMuYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChtYWM/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9NQUNCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbWFjJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignaycpCgogIHJldHVybiBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfb3Blbl9kZXRhY2hlZChtLCBjLCBtYWMsIG4sIGspCn0KCi8vIGNyeXB0b19nZW5lcmljaGFzaAoKZXhwb3J0cy5jcnlwdG9fZ2VuZXJpY2hhc2ggPSBmdW5jdGlvbiAob3V0cHV0LCBpbnB1dCwga2V5ID0gT1BUSU9OQUwpIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19nZW5lcmljaGFzaCgKICAgIG91dHB1dC5idWZmZXIsCiAgICBvdXRwdXQuYnl0ZU9mZnNldCwKICAgIG91dHB1dC5ieXRlTGVuZ3RoLAoKICAgIGlucHV0LmJ1ZmZlciwKICAgIGlucHV0LmJ5dGVPZmZzZXQsCiAgICBpbnB1dC5ieXRlTGVuZ3RoLAoKICAgIGtleS5idWZmZXIsCiAgICBrZXkuYnl0ZU9mZnNldCwKICAgIGtleS5ieXRlTGVuZ3RoCiAgKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2ggPSBmdW5jdGlvbiAob3V0cHV0LCBiYXRjaCwga2V5KSB7CiAgaWYgKGlzTm9kZSB8fCBiYXRjaC5sZW5ndGggPCA0KSB7CiAgICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaCgKICAgICAgb3V0cHV0LAogICAgICBiYXRjaCwKICAgICAgISFrZXksCiAgICAgIGtleSB8fCBPUFRJT05BTAogICAgKQogICAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCiAgfSBlbHNlIHsKICAgIGNvbnN0IHN0YXRlID0gQnVmZmVyLmFsbG9jKGJpbmRpbmcuY3J5cHRvX2dlbmVyaWNoYXNoX1NUQVRFQllURVMpCgogICAgZXhwb3J0cy5jcnlwdG9fZ2VuZXJpY2hhc2hfaW5pdChzdGF0ZSwga2V5LCBvdXRwdXQuYnl0ZUxlbmd0aCkKCiAgICBmb3IgKGNvbnN0IGJ1ZiBvZiBiYXRjaCkgewogICAgICBleHBvcnRzLmNyeXB0b19nZW5lcmljaGFzaF91cGRhdGUoc3RhdGUsIGJ1ZikKICAgIH0KCiAgICBleHBvcnRzLmNyeXB0b19nZW5lcmljaGFzaF9maW5hbChzdGF0ZSwgb3V0cHV0KQogIH0KfQoKZXhwb3J0cy5jcnlwdG9fZ2VuZXJpY2hhc2hfa2V5Z2VuID0gZnVuY3Rpb24gKGtleSkgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2dlbmVyaWNoYXNoX2tleWdlbigKICAgIGtleS5idWZmZXIsCiAgICBrZXkuYnl0ZU9mZnNldCwKICAgIGtleS5ieXRlTGVuZ3RoCiAgKQogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19nZW5lcmljaGFzaF9pbml0ID0gZnVuY3Rpb24gKHN0YXRlLCBrZXksIG91dHB1dExlbmd0aCkgewogIGtleSB8fD0gT1BUSU9OQUwKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fZ2VuZXJpY2hhc2hfaW5pdCgKICAgIHN0YXRlLmJ1ZmZlciwKICAgIHN0YXRlLmJ5dGVPZmZzZXQsCiAgICBzdGF0ZS5ieXRlTGVuZ3RoLAoKICAgIGtleS5idWZmZXIsCiAgICBrZXkuYnl0ZU9mZnNldCwKICAgIGtleS5ieXRlTGVuZ3RoLAoKICAgIG91dHB1dExlbmd0aAogICkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2dlbmVyaWNoYXNoX3VwZGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgaW5wdXQpIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19nZW5lcmljaGFzaF91cGRhdGUoCiAgICBzdGF0ZS5idWZmZXIsCiAgICBzdGF0ZS5ieXRlT2Zmc2V0LAogICAgc3RhdGUuYnl0ZUxlbmd0aCwKCiAgICBpbnB1dC5idWZmZXIsCiAgICBpbnB1dC5ieXRlT2Zmc2V0LAogICAgaW5wdXQuYnl0ZUxlbmd0aAogICkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2dlbmVyaWNoYXNoX2ZpbmFsID0gZnVuY3Rpb24gKHN0YXRlLCBvdXRwdXQpIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19nZW5lcmljaGFzaF9maW5hbCgKICAgIHN0YXRlLmJ1ZmZlciwKICAgIHN0YXRlLmJ5dGVPZmZzZXQsCiAgICBzdGF0ZS5ieXRlTGVuZ3RoLAoKICAgIG91dHB1dC5idWZmZXIsCiAgICBvdXRwdXQuYnl0ZU9mZnNldCwKICAgIG91dHB1dC5ieXRlTGVuZ3RoCiAgKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKLy8gc2VjcmV0c3RyZWFtCgpleHBvcnRzLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfa2V5Z2VuID0gZnVuY3Rpb24gKGspIHsKICBiaW5kaW5nLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfa2V5Z2VuKAogICAgay5idWZmZXIsCiAgICBrLmJ5dGVPZmZzZXQsCiAgICBrLmJ5dGVMZW5ndGgKICApCn0KCmV4cG9ydHMuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9pbml0X3B1c2ggPSBmdW5jdGlvbiAoCiAgc3RhdGUsCiAgaGVhZGVyLAogIGsKKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X2luaXRfcHVzaCgKICAgIHN0YXRlLmJ1ZmZlciwKICAgIHN0YXRlLmJ5dGVPZmZzZXQsCiAgICBzdGF0ZS5ieXRlTGVuZ3RoLAoKICAgIGhlYWRlci5idWZmZXIsCiAgICBoZWFkZXIuYnl0ZU9mZnNldCwKICAgIGhlYWRlci5ieXRlTGVuZ3RoLAoKICAgIGsuYnVmZmVyLAogICAgay5ieXRlT2Zmc2V0LAogICAgay5ieXRlTGVuZ3RoCiAgKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X2luaXRfcHVsbCA9IGZ1bmN0aW9uICgKICBzdGF0ZSwKICBoZWFkZXIsCiAgawopIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfaW5pdF9wdWxsKAogICAgc3RhdGUuYnVmZmVyLAogICAgc3RhdGUuYnl0ZU9mZnNldCwKICAgIHN0YXRlLmJ5dGVMZW5ndGgsCgogICAgaGVhZGVyLmJ1ZmZlciwKICAgIGhlYWRlci5ieXRlT2Zmc2V0LAogICAgaGVhZGVyLmJ5dGVMZW5ndGgsCgogICAgay5idWZmZXIsCiAgICBrLmJ5dGVPZmZzZXQsCiAgICBrLmJ5dGVMZW5ndGgKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfcHVzaCA9IGZ1bmN0aW9uICgKICBzdGF0ZSwKICBjLAogIG0sCiAgYWQsCiAgdGFnCikgewogIGFkIHx8PSBPUFRJT05BTAoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfcHVzaCgKICAgIHN0YXRlLmJ1ZmZlciwKICAgIHN0YXRlLmJ5dGVPZmZzZXQsCiAgICBzdGF0ZS5ieXRlTGVuZ3RoLAoKICAgIGMuYnVmZmVyLAogICAgYy5ieXRlT2Zmc2V0LAogICAgYy5ieXRlTGVuZ3RoLAoKICAgIG0uYnVmZmVyLAogICAgbS5ieXRlT2Zmc2V0LAogICAgbS5ieXRlTGVuZ3RoLAoKICAgIGFkLmJ1ZmZlciwKICAgIGFkLmJ5dGVPZmZzZXQsCiAgICBhZC5ieXRlTGVuZ3RoLAoKICAgIHRhZwogICkKCiAgaWYgKHJlcyA8IDApIHRocm93IG5ldyBFcnJvcigncHVzaCBmYWlsZWQnKQoKICByZXR1cm4gcmVzCn0KCmV4cG9ydHMuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9wdWxsID0gZnVuY3Rpb24gKAogIHN0YXRlLAogIG0sCiAgdGFnLAogIGMsCiAgYWQKKSB7CiAgYWQgfHw9IE9QVElPTkFMCgogIGlmIChjPy5ieXRlTGVuZ3RoIDwgYmluZGluZy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X0FCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBjaXBoZXIgbGVuZ3RoJykKICBpZiAoCiAgICBtPy5ieXRlTGVuZ3RoICE9PQogICAgYy5ieXRlTGVuZ3RoIC0gYmluZGluZy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X0FCWVRFUwogICkKICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBtZXNzYWdlIGxlbmd0aCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9wdWxsKAogICAgc3RhdGUuYnVmZmVyLAogICAgc3RhdGUuYnl0ZU9mZnNldCwKICAgIHN0YXRlLmJ5dGVMZW5ndGgsCgogICAgbS5idWZmZXIsCiAgICBtLmJ5dGVPZmZzZXQsCiAgICBtLmJ5dGVMZW5ndGgsCgogICAgdGFnLmJ1ZmZlciwKICAgIHRhZy5ieXRlT2Zmc2V0LAogICAgdGFnLmJ5dGVMZW5ndGgsCgogICAgYy5idWZmZXIsCiAgICBjLmJ5dGVPZmZzZXQsCiAgICBjLmJ5dGVMZW5ndGgsCgogICAgYWQuYnVmZmVyLAogICAgYWQuYnl0ZU9mZnNldCwKICAgIGFkLmJ5dGVMZW5ndGgKICApCgogIGlmIChyZXMgPCAwKSB0aHJvdyBuZXcgRXJyb3IoJ3B1bGwgZmFpbGVkJykKCiAgcmV0dXJuIHJlcwp9CgpleHBvcnRzLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfcmVrZXkgPSBmdW5jdGlvbiAoc3RhdGUpIHsKICBiaW5kaW5nLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfcmVrZXkoCiAgICBzdGF0ZS5idWZmZXIsCiAgICBzdGF0ZS5ieXRlT2Zmc2V0LAogICAgc3RhdGUuYnl0ZUxlbmd0aAogICkKfQoKLy8gY3J5cHRvX3N0cmVhbQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtID0gZnVuY3Rpb24gKGMsIG4sIGspIHsKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX05PTkNFQllURVMpIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9LRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtKGMsIG4sIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1feG9yID0gZnVuY3Rpb24gKGMsIG0sIG4sIGspIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feG9yKAogICAgYy5idWZmZXIsCiAgICBjLmJ5dGVPZmZzZXQsCiAgICBjLmJ5dGVMZW5ndGgsCgogICAgbS5idWZmZXIsCiAgICBtLmJ5dGVPZmZzZXQsCiAgICBtLmJ5dGVMZW5ndGgsCgogICAgbi5idWZmZXIsCiAgICBuLmJ5dGVPZmZzZXQsCiAgICBuLmJ5dGVMZW5ndGgsCgogICAgay5idWZmZXIsCiAgICBrLmJ5dGVPZmZzZXQsCiAgICBrLmJ5dGVMZW5ndGgKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fY2hhY2hhMjAgPSBmdW5jdGlvbiAoYywgbiwgaykgewogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMChjLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvciA9IGZ1bmN0aW9uIChjLCBtLCBuLCBrKSB7CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yKGMsIG0sIG4sIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX2ljID0gZnVuY3Rpb24gKGMsIG0sIG4sIGljLCBrKSB7CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX2ljKGMsIG0sIG4sIGljLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGYgPSBmdW5jdGlvbiAoYywgbiwgaykgewogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0ZihjLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yID0gZnVuY3Rpb24gKGMsIG0sIG4sIGspIHsKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMuYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3IoYywgbSwgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl9pYyA9IGZ1bmN0aW9uIChjLCBtLCBuLCBpYywgaykgewogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl9pYyhjLCBtLCBuLCBpYywgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjAgPSBmdW5jdGlvbiAoYywgbiwgaykgewogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMChjLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3IgPSBmdW5jdGlvbiAoYywgbSwgbiwgaykgewogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcihjLCBtLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3JfaWMgPSBmdW5jdGlvbiAoYywgbSwgbiwgaWMsIGspIHsKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMuYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3JfaWMoYywgbSwgbiwgaWMsIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fc2Fsc2EyMCA9IGZ1bmN0aW9uIChjLCBuLCBrKSB7CiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwKGMsIG4sIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3IgPSBmdW5jdGlvbiAoYywgbSwgbiwgaykgewogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcihjLCBtLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX2ljID0gZnVuY3Rpb24gKGMsIG0sIG4sIGljLCBrKSB7CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX2ljKGMsIG0sIG4sIGljLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKLy8gY3J5cHRvX2F1dGgKCmV4cG9ydHMuY3J5cHRvX2F1dGggPSBmdW5jdGlvbiAob3V0LCBpbnB1dCwgaykgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2F1dGhfQllURVMpIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYXV0aF9LRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYXV0aChvdXQsIGlucHV0LCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fYXV0aF92ZXJpZnkgPSBmdW5jdGlvbiAoaCwgaW5wdXQsIGspIHsKICBpZiAoaD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYXV0aF9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdoJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYXV0aF9LRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX2F1dGhfdmVyaWZ5KGgsIGlucHV0LCBrKQp9CgovLyBjcnlwdG9fb25ldGltZWF1dGgKCmV4cG9ydHMuY3J5cHRvX29uZXRpbWVhdXRoID0gZnVuY3Rpb24gKG91dCwgaW5wdXQsIGspIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aChvdXQsIGlucHV0LCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fb25ldGltZWF1dGhfaW5pdCA9IGZ1bmN0aW9uIChzdGF0ZSwgaykgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfU1RBVEVCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnY3J5cHRvX29uZXRpbWVhdXRoX1NUQVRFQllURVMnIGJ5dGVzIikKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF9pbml0KHN0YXRlLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fb25ldGltZWF1dGhfdXBkYXRlID0gZnVuY3Rpb24gKHN0YXRlLCBpbnB1dCkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfU1RBVEVCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnY3J5cHRvX29uZXRpbWVhdXRoX1NUQVRFQllURVMnIGJ5dGVzIikKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfdXBkYXRlKHN0YXRlLCBpbnB1dCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX29uZXRpbWVhdXRoX2ZpbmFsID0gZnVuY3Rpb24gKHN0YXRlLCBvdXQpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX1NUQVRFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ2NyeXB0b19vbmV0aW1lYXV0aF9TVEFURUJZVEVTJyBieXRlcyIpCiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX2ZpbmFsKHN0YXRlLCBvdXQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19vbmV0aW1lYXV0aF92ZXJpZnkgPSBmdW5jdGlvbiAoaCwgaW5wdXQsIGspIHsKICBpZiAoaD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfQllURVMpIHRocm93IG5ldyBFcnJvcignaCcpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX3ZlcmlmeShoLCBpbnB1dCwgaykKfQoKLy8gY3J5cHRvX3B3aGFzaAoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoID0gZnVuY3Rpb24gKG91dCwgcGFzc3dkLCBzYWx0LCBvcHNsaW1pdCwgbWVtbGltaXQsIGFsZykgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfQllURVNfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKG91dD8uYnl0ZUxlbmd0aCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9CWVRFU19NQVgpIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoc2FsdD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX1NBTFRCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2FsdCcpCiAgaWYgKG9wc2xpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX09QU0xJTUlUX01JTikgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG9wc2xpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX09QU0xJTUlUX01BWCkgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG1lbWxpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX01FTUxJTUlUX01JTikgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCiAgaWYgKG1lbWxpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX01FTUxJTUlUX01BWCkgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCiAgaWYgKGFsZyA8IDEgfHwgYWxnID4gMikKICAgIHRocm93IG5ldyBFcnJvcignYWxnIG11c3QgYmUgZWl0aGVyIEFyZ29uMmkgMS4zIG9yIEFyZ29uMmlkIDEuMycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3B3aGFzaChvdXQsIHBhc3N3ZCwgc2FsdCwgb3BzbGltaXQsIG1lbWxpbWl0LCBhbGcpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfYXN5bmMgPSBmdW5jdGlvbiAoCiAgb3V0LAogIHBhc3N3ZCwKICBzYWx0LAogIG9wc2xpbWl0LAogIG1lbWxpbWl0LAogIGFsZywKICBjYWxsYmFjayA9IHVuZGVmaW5lZAopIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoIDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX0JZVEVTX01JTikgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmIChvdXQ/LmJ5dGVMZW5ndGggPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfQllURVNfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKHNhbHQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9TQUxUQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NhbHQnKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChtZW1saW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChhbGcgPCAxIHx8IGFsZyA+IDIpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2FsZyBtdXN0IGJlIGVpdGhlciBBcmdvbjJpIDEuMyBvciBBcmdvbjJpZCAxLjMnKQoKICBjb25zdCBbZG9uZSwgcHJvbWlzZV0gPSBjaGVja1N0YXR1cyhjYWxsYmFjaykKCiAgYmluZGluZy5jcnlwdG9fcHdoYXNoX2FzeW5jKAogICAgb3V0LmJ1ZmZlciwKICAgIG91dC5ieXRlT2Zmc2V0LAogICAgb3V0LmJ5dGVMZW5ndGgsCgogICAgcGFzc3dkLmJ1ZmZlciwKICAgIHBhc3N3ZC5ieXRlT2Zmc2V0LAogICAgcGFzc3dkLmJ5dGVMZW5ndGgsCgogICAgc2FsdC5idWZmZXIsCiAgICBzYWx0LmJ5dGVPZmZzZXQsCiAgICBzYWx0LmJ5dGVMZW5ndGgsCgogICAgb3BzbGltaXQsCiAgICBtZW1saW1pdCwKICAgIGFsZywKCiAgICBkb25lCiAgKQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc3RyID0gZnVuY3Rpb24gKG91dCwgcGFzc3dkLCBvcHNsaW1pdCwgbWVtbGltaXQpIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfU1RSQllURVMpIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAodHlwZW9mIG9wc2xpbWl0ICE9PSAnbnVtYmVyJykgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG9wc2xpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX09QU0xJTUlUX01JTikgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG9wc2xpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX09QU0xJTUlUX01BWCkgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKHR5cGVvZiBtZW1saW1pdCAhPT0gJ251bWJlcicpIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc3RyKG91dCwgcGFzc3dkLCBvcHNsaW1pdCwgbWVtbGltaXQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc3RyX2FzeW5jID0gZnVuY3Rpb24gKAogIG91dCwKICBwYXNzd2QsCiAgb3BzbGltaXQsCiAgbWVtbGltaXQsCiAgY2FsbGJhY2sgPSB1bmRlZmluZWQKKSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX1NUUkJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKCFwYXNzd2Q/LmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcigncGFzc3dkJykKICBpZiAodHlwZW9mIG9wc2xpbWl0ICE9PSAnbnVtYmVyJykgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG9wc2xpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX09QU0xJTUlUX01JTikgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG9wc2xpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX09QU0xJTUlUX01BWCkgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKHR5cGVvZiBtZW1saW1pdCAhPT0gJ251bWJlcicpIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQoKICBjb25zdCBbZG9uZSwgcHJvbWlzZV0gPSBjaGVja1N0YXR1cyhjYWxsYmFjaykKCiAgYmluZGluZy5jcnlwdG9fcHdoYXNoX3N0cl9hc3luYygKICAgIG91dC5idWZmZXIsCiAgICBvdXQuYnl0ZU9mZnNldCwKICAgIG91dC5ieXRlTGVuZ3RoLAoKICAgIHBhc3N3ZC5idWZmZXIsCiAgICBwYXNzd2QuYnl0ZU9mZnNldCwKICAgIHBhc3N3ZC5ieXRlTGVuZ3RoLAoKICAgIG9wc2xpbWl0LAogICAgbWVtbGltaXQsCgogICAgZG9uZQogICkKCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3N0cl92ZXJpZnkgPSBmdW5jdGlvbiAoc3RyLCBwYXNzd2QpIHsKICBpZiAoc3RyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfU1RSQllURVMpIHRocm93IG5ldyBFcnJvcignc3RyJykKCiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zdHJfdmVyaWZ5KHN0ciwgcGFzc3dkKQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc3RyX3ZlcmlmeV9hc3luYyA9IGZ1bmN0aW9uICgKICBzdHIsCiAgcGFzc3dkLAogIGNhbGxiYWNrID0gdW5kZWZpbmVkCikgewogIGlmIChzdHI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9TVFJCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdzdHInKQogIGlmICghcGFzc3dkPy5ieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ3Bhc3N3ZCcpCgogIGNvbnN0IFtkb25lLCBwcm9taXNlXSA9IGNoZWNrU3RhdHVzKGNhbGxiYWNrLCB0cnVlKQoKICBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc3RyX3ZlcmlmeV9hc3luYygKICAgIHN0ci5idWZmZXIsCiAgICBzdHIuYnl0ZU9mZnNldCwKICAgIHN0ci5ieXRlTGVuZ3RoLAoKICAgIHBhc3N3ZC5idWZmZXIsCiAgICBwYXNzd2QuYnl0ZU9mZnNldCwKICAgIHBhc3N3ZC5ieXRlTGVuZ3RoLAoKICAgIGRvbmUKICApCgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zdHJfbmVlZHNfcmVoYXNoID0gZnVuY3Rpb24gKHN0ciwgb3BzbGltaXQsIG1lbWxpbWl0KSB7CiAgaWYgKHN0cj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX1NUUkJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3N0cicpCiAgaWYgKG9wc2xpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX09QU0xJTUlUX01JTikgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG9wc2xpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX09QU0xJTUlUX01BWCkgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG1lbWxpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX01FTUxJTUlUX01JTikgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCiAgaWYgKG1lbWxpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX01FTUxJTUlUX01BWCkgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCgogIHJldHVybiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc3RyX25lZWRzX3JlaGFzaChzdHIsIG9wc2xpbWl0LCBtZW1saW1pdCkKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2ID0gZnVuY3Rpb24gKAogIG91dCwKICBwYXNzd2QsCiAgc2FsdCwKICBvcHNsaW1pdCwKICBtZW1saW1pdAopIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoIDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X0JZVEVTX01JTikKICAgIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAob3V0Py5ieXRlTGVuZ3RoID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X0JZVEVTX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoc2FsdD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X1NBTFRCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2FsdCcpCiAgaWYgKG9wc2xpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X09QU0xJTUlUX01JTikKICAgIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9PUFNMSU1JVF9NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAobWVtbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfTUVNTElNSVRfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCiAgaWYgKG1lbWxpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X01FTUxJTUlUX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTYoCiAgICBvdXQsCiAgICBwYXNzd2QsCiAgICBzYWx0LAogICAgb3BzbGltaXQsCiAgICBtZW1saW1pdAogICkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9hc3luYyA9IGZ1bmN0aW9uICgKICBvdXQsCiAgcGFzc3dkLAogIHNhbHQsCiAgb3BzbGltaXQsCiAgbWVtbGltaXQsCiAgY2FsbGJhY2sgPSB1bmRlZmluZWQKKSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9CWVRFU19NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKG91dD8uYnl0ZUxlbmd0aCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9CWVRFU19NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKCFwYXNzd2Q/LmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcigncGFzc3dkJykKICBpZiAoc2FsdD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X1NBTFRCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2FsdCcpCiAgaWYgKG9wc2xpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X09QU0xJTUlUX01JTikKICAgIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9PUFNMSU1JVF9NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAobWVtbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfTUVNTElNSVRfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCiAgaWYgKG1lbWxpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X01FTUxJTUlUX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQoKICBjb25zdCBbZG9uZSwgcHJvbWlzZV0gPSBjaGVja1N0YXR1cyhjYWxsYmFjaykKCiAgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X2FzeW5jKAogICAgb3V0LmJ1ZmZlciwKICAgIG91dC5ieXRlT2Zmc2V0LAogICAgb3V0LmJ5dGVMZW5ndGgsCgogICAgcGFzc3dkLmJ1ZmZlciwKICAgIHBhc3N3ZC5ieXRlT2Zmc2V0LAogICAgcGFzc3dkLmJ5dGVMZW5ndGgsCgogICAgc2FsdC5idWZmZXIsCiAgICBzYWx0LmJ5dGVPZmZzZXQsCiAgICBzYWx0LmJ5dGVMZW5ndGgsCgogICAgb3BzbGltaXQsCiAgICBtZW1saW1pdCwKCiAgICBkb25lCiAgKQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfc3RyX2FzeW5jID0gZnVuY3Rpb24gKAogIG91dCwKICBwYXNzd2QsCiAgb3BzbGltaXQsCiAgbWVtbGltaXQsCiAgY2FsbGJhY2sgPSB1bmRlZmluZWQKKSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X1NUUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmICghcGFzc3dkPy5ieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ3Bhc3N3ZCcpCiAgaWYgKG9wc2xpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X09QU0xJTUlUX01JTikKICAgIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9PUFNMSU1JVF9NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAobWVtbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfTUVNTElNSVRfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCiAgaWYgKG1lbWxpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X01FTUxJTUlUX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQoKICBjb25zdCBbZG9uZSwgcHJvbWlzZV0gPSBjaGVja1N0YXR1cyhjYWxsYmFjaykKCiAgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X3N0cl9hc3luYygKICAgIG91dC5idWZmZXIsCiAgICBvdXQuYnl0ZU9mZnNldCwKICAgIG91dC5ieXRlTGVuZ3RoLAoKICAgIHBhc3N3ZC5idWZmZXIsCiAgICBwYXNzd2QuYnl0ZU9mZnNldCwKICAgIHBhc3N3ZC5ieXRlTGVuZ3RoLAoKICAgIG9wc2xpbWl0LAogICAgbWVtbGltaXQsCgogICAgZG9uZQogICkKCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X3N0ciA9IGZ1bmN0aW9uICgKICBvdXQsCiAgcGFzc3dkLAogIG9wc2xpbWl0LAogIG1lbWxpbWl0CikgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9TVFJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoIXBhc3N3ZD8uYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdwYXNzd2QnKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9PUFNMSU1JVF9NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfT1BTTElNSVRfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG1lbWxpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X01FTUxJTUlUX01JTikKICAgIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9NRU1MSU1JVF9NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X3N0cigKICAgIG91dCwKICAgIHBhc3N3ZCwKICAgIG9wc2xpbWl0LAogICAgbWVtbGltaXQKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfc3RyX3ZlcmlmeV9hc3luYyA9IGZ1bmN0aW9uICgKICBzdHIsCiAgcGFzc3dkLAogIGNhbGxiYWNrID0gdW5kZWZpbmVkCikgewogIGlmIChzdHI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9TVFJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc3RyJykKICBpZiAoIXBhc3N3ZD8uYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdwYXNzd2QnKQoKICBjb25zdCBbZG9uZSwgcHJvbWlzZV0gPSBjaGVja1N0YXR1cyhjYWxsYmFjaywgdHJ1ZSkKCiAgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X3N0cl92ZXJpZnlfYXN5bmMoCiAgICBzdHIuYnVmZmVyLAogICAgc3RyLmJ5dGVPZmZzZXQsCiAgICBzdHIuYnl0ZUxlbmd0aCwKCiAgICBwYXNzd2QuYnVmZmVyLAogICAgcGFzc3dkLmJ5dGVPZmZzZXQsCiAgICBwYXNzd2QuYnl0ZUxlbmd0aCwKCiAgICBkb25lCiAgKQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfc3RyX3ZlcmlmeSA9IGZ1bmN0aW9uIChzdHIsIHBhc3N3ZCkgewogIGlmIChzdHI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9TVFJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc3RyJykKICBpZiAoIXBhc3N3ZD8uYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdwYXNzd2QnKQoKICByZXR1cm4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X3N0cl92ZXJpZnkoc3RyLCBwYXNzd2QpCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHJfbmVlZHNfcmVoYXNoID0gZnVuY3Rpb24gKAogIHN0ciwKICBvcHNsaW1pdCwKICBtZW1saW1pdAopIHsKICBpZiAoc3RyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfU1RSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3N0cicpCiAgaWYgKG9wc2xpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX09QU0xJTUlUX01JTikgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG9wc2xpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX09QU0xJTUlUX01BWCkgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG1lbWxpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX01FTUxJTUlUX01JTikgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCiAgaWYgKG1lbWxpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX01FTUxJTUlUX01BWCkgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCgogIHJldHVybiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfc3RyX25lZWRzX3JlaGFzaCgKICAgIHN0ciwKICAgIG9wc2xpbWl0LAogICAgbWVtbGltaXQKICApCn0KCi8vIGNyeXB0b19reAoKZXhwb3J0cy5jcnlwdG9fa3hfa2V5cGFpciA9IGZ1bmN0aW9uIChwaywgc2spIHsKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1BVQkxJQ0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKICBpZiAoc2s/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1NFQ1JFVEtFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3NrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fa3hfa2V5cGFpcihwaywgc2spCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19reF9zZWVkX2tleXBhaXIgPSBmdW5jdGlvbiAocGssIHNrLCBzZWVkKSB7CiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9QVUJMSUNLRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdwaycpCiAgaWYgKHNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9TRUNSRVRLRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdzaycpCiAgaWYgKHNlZWQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1NFRURCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdzZWVkJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fa3hfc2VlZF9rZXlwYWlyKHBrLCBzaywgc2VlZCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2t4X2NsaWVudF9zZXNzaW9uX2tleXMgPSBmdW5jdGlvbiAoCiAgcngsCiAgdHgsCiAgY2xpZW50UGssCiAgY2xpZW50U2ssCiAgc2VydmVyUGsKKSB7CiAgLy8gbWF0Y2ggYHN0ZDo6b3B0aW9uYWxgIGJ5IGNvZXJjaW5nIG51bGwgdG8gdW5kZWZpbmVkCiAgcnggPz89IHVuZGVmaW5lZAogIHR4ID8/PSB1bmRlZmluZWQKCiAgaWYgKCFyeCAmJiAhdHgpIHRocm93IG5ldyBFcnJvcignYXQgbGVhc3Qgb25lIHNlc3Npb24ga2V5IG11c3QgYmUgc3BlY2lmaWVkJykKCiAgaWYgKHJ4KSB7CiAgICBpZiAocng/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1NFU1NJT05LRVlCWVRFUykKICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICdyZWNlaXZpbmcga2V5IGJ1ZmZlciBtdXN0IGJlICJjcnlwdG9fa3hfU0VTU0lPTktFWUJZVEVTIiBieXRlcyBvciBudWxsJwogICAgICApCiAgfSBlbHNlIHsKICAgIGlmICh0eD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfU0VTU0lPTktFWUJZVEVTKQogICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgJ3RyYW5zbWl0dGluZyBrZXkgYnVmZmVyIG11c3QgYmUgImNyeXB0b19reF9TRVNTSU9OS0VZQllURVMiIGJ5dGVzIG9yIG51bGwnCiAgICAgICkKICB9CgogIGlmIChjbGllbnRQaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NsaWVudF9waycpCiAgaWYgKGNsaWVudFNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9TRUNSRVRLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignY2xpZW50X3NrJykKICBpZiAoc2VydmVyUGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzZXJ2ZXJfcGsnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19reF9jbGllbnRfc2Vzc2lvbl9rZXlzKAogICAgcngsCiAgICB0eCwKICAgIGNsaWVudFBrLAogICAgY2xpZW50U2ssCiAgICBzZXJ2ZXJQawogICkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2t4X3NlcnZlcl9zZXNzaW9uX2tleXMgPSBmdW5jdGlvbiAoCiAgcngsCiAgdHgsCiAgc2VydmVyUGssCiAgc2VydmVyU2ssCiAgY2xpZW50UGsKKSB7CiAgcnggPz89IHVuZGVmaW5lZAogIHR4ID8/PSB1bmRlZmluZWQKCiAgaWYgKCFyeCAmJiAhdHgpIHRocm93IG5ldyBFcnJvcignYXQgbGVhc3Qgb25lIHNlc3Npb24ga2V5IG11c3QgYmUgc3BlY2lmaWVkJykKCiAgaWYgKHJ4KSB7CiAgICBpZiAocng/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1NFU1NJT05LRVlCWVRFUykKICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICdyZWNlaXZpbmcga2V5IGJ1ZmZlciBtdXN0IGJlICJjcnlwdG9fa3hfU0VTU0lPTktFWUJZVEVTIiBieXRlcyBvciBudWxsJwogICAgICApCiAgfSBlbHNlIHsKICAgIGlmICh0eD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfU0VTU0lPTktFWUJZVEVTKQogICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgJ3RyYW5zbWl0dGluZyBrZXkgYnVmZmVyIG11c3QgYmUgImNyeXB0b19reF9TRVNTSU9OS0VZQllURVMiIGJ5dGVzIG9yIG51bGwnCiAgICAgICkKICB9CgogIGlmIChzZXJ2ZXJQaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NlcnZlcl9waycpCiAgaWYgKHNlcnZlclNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9TRUNSRVRLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2VydmVyX3NrJykKICBpZiAoY2xpZW50UGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdjbGllbnRfcGsnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19reF9zZXJ2ZXJfc2Vzc2lvbl9rZXlzKAogICAgcngsCiAgICB0eCwKICAgIHNlcnZlclBrLAogICAgc2VydmVyU2ssCiAgICBjbGllbnRQawogICkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCi8vIGNyeXB0b19zY2FsYXJtdWx0CgpleHBvcnRzLmNyeXB0b19zY2FsYXJtdWx0X2Jhc2UgPSBmdW5jdGlvbiAocSwgbikgewogIGlmIChxPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3EnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9iYXNlKHEsIG4pCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zY2FsYXJtdWx0ID0gZnVuY3Rpb24gKHEsIG4sIHApIHsKICBpZiAocT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdxJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKHA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfQllURVMpIHRocm93IG5ldyBFcnJvcigncCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHQocSwgbiwgcCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9iYXNlID0gZnVuY3Rpb24gKHEsIG4pIHsKICBpZiAocT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdxJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X2Jhc2UocSwgbikKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOSA9IGZ1bmN0aW9uIChxLCBuLCBwKSB7CiAgaWYgKHE/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncScpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKHA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOShxLCBuLCBwKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X2lzX3ZhbGlkX3BvaW50ID0gZnVuY3Rpb24gKHApIHsKICBpZiAocD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3AnKQoKICByZXR1cm4gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X2lzX3ZhbGlkX3BvaW50KHApCn0KCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9mcm9tX3VuaWZvcm0gPSBmdW5jdGlvbiAocCwgcikgewogIGlmIChwPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfQllURVMpIHRocm93IG5ldyBFcnJvcigncCcpCiAgaWYgKHI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9VTklGT1JNQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3InKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfZnJvbV91bmlmb3JtKHAsIHIpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfYmFzZV9ub2NsYW1wID0gZnVuY3Rpb24gKHEsIG4pIHsKICBpZiAocT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdxJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X2Jhc2Vfbm9jbGFtcChxLCBuKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X25vY2xhbXAgPSBmdW5jdGlvbiAocSwgbiwgcCkgewogIGlmIChxPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3EnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChwPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3AnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfbm9jbGFtcChxLCBuLCBwKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKLy8gY3J5cHRvX2NvcmUKCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9hZGQgPSBmdW5jdGlvbiAociwgcCwgcSkgewogIGlmIChyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfQllURVMpIHRocm93IG5ldyBFcnJvcigncicpCiAgaWYgKHA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdwJykKICBpZiAocT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3EnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfYWRkKHIsIHAsIHEpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19jb3JlX2VkMjU1MTlfc3ViID0gZnVuY3Rpb24gKHIsIHAsIHEpIHsKICBpZiAocj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3InKQogIGlmIChwPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfQllURVMpIHRocm93IG5ldyBFcnJvcigncCcpCiAgaWYgKHE/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdxJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X3N1YihyLCBwLCBxKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9yYW5kb20gPSBmdW5jdGlvbiAocikgewogIGlmIChyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3InKQoKICBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX3JhbmRvbShyKQp9CgpleHBvcnRzLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX3JlZHVjZSA9IGZ1bmN0aW9uIChyLCBzKSB7CiAgaWYgKHI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncicpCiAgaWYgKHM/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9OT05SRURVQ0VEU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3MnKQoKICBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX3JlZHVjZShyLCBzKQp9CgpleHBvcnRzLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX2ludmVydCA9IGZ1bmN0aW9uIChyZWNpcCwgcykgewogIGlmIChyZWNpcD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdyZWNpcCcpCiAgaWYgKHM/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncycpCgogIGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfaW52ZXJ0KHJlY2lwLCBzKQp9CgpleHBvcnRzLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX25lZ2F0ZSA9IGZ1bmN0aW9uIChuZWcsIHMpIHsKICBpZiAobmVnPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ25lZycpCiAgaWYgKHM/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncycpCgogIGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfbmVnYXRlKG5lZywgcykKfQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9jb21wbGVtZW50ID0gZnVuY3Rpb24gKGNvbXAsIHMpIHsKICBpZiAoY29tcD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdjb21wJykKICBpZiAocz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzJykKCiAgYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9jb21wbGVtZW50KGNvbXAsIHMpCn0KCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfYWRkID0gZnVuY3Rpb24gKHosIHgsIHkpIHsKICBpZiAoej8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd6JykKICBpZiAoeD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd4JykKICBpZiAoeT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd5JykKCiAgYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9hZGQoeiwgeCwgeSkKfQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9zdWIgPSBmdW5jdGlvbiAoeiwgeCwgeSkgewogIGlmICh6Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3onKQogIGlmICh4Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3gnKQogIGlmICh5Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3knKQoKICBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX3N1Yih6LCB4LCB5KQp9CgovLyBjcnlwdG9fc2hvcnRoYXNoCgpleHBvcnRzLmNyeXB0b19zaG9ydGhhc2ggPSBmdW5jdGlvbiAob3V0LCBpbnB1dCwgaykgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3Nob3J0aGFzaF9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaG9ydGhhc2hfS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3Nob3J0aGFzaChvdXQsIGlucHV0LCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKLy8gY3J5cHRvX2tkZgoKZXhwb3J0cy5jcnlwdG9fa2RmX2tleWdlbiA9IGZ1bmN0aW9uIChrZXkpIHsKICBpZiAoa2V5Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19rZGZfS0VZQllURVMpIHRocm93IG5ldyBFcnJvcigna2V5JykKCiAgYmluZGluZy5jcnlwdG9fa2RmX2tleWdlbihrZXkpCn0KCmV4cG9ydHMuY3J5cHRvX2tkZl9kZXJpdmVfZnJvbV9rZXkgPSBmdW5jdGlvbiAoc3Via2V5LCBzdWJrZXlJZCwgY3R4LCBrZXkpIHsKICBpZiAoc3Via2V5Py5ieXRlTGVuZ3RoIDwgYmluZGluZy5jcnlwdG9fa2RmX0JZVEVTX01JTikKICAgIHRocm93IG5ldyBFcnJvcignc3Via2V5JykKICBpZiAoc3Via2V5Py5ieXRlTGVuZ3RoID4gYmluZGluZy5jcnlwdG9fa2RmX0JZVEVTX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignc3Via2V5JykKICBpZiAoY3R4Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19rZGZfQ09OVEVYVEJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdjdHgnKQogIGlmIChrZXk/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2tkZl9LRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdrZXknKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19rZGZfZGVyaXZlX2Zyb21fa2V5KHN1YmtleSwgc3Via2V5SWQsIGN0eCwga2V5KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKLy8gY3J5cHRvX2hhc2gKCmV4cG9ydHMuY3J5cHRvX2hhc2ggPSBmdW5jdGlvbiAob3V0LCBpbnB1dCkgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfQllURVMpIHRocm93IG5ldyBFcnJvcignb3V0JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9faGFzaChvdXQsIGlucHV0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9faGFzaF9zaGEyNTYgPSBmdW5jdGlvbiAob3V0LCBpbnB1dCkgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhMjU2X0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTI1NihvdXQsIGlucHV0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9faGFzaF9zaGEyNTZfaW5pdCA9IGZ1bmN0aW9uIChzdGF0ZSkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9faGFzaF9zaGEyNTZfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdjcnlwdG9faGFzaF9zaGEyNTZfU1RBVEVCWVRFUycgYnl0ZXMiKQogIH0KCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9faGFzaF9zaGEyNTZfaW5pdChzdGF0ZSkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2hhc2hfc2hhMjU2X3VwZGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgaW5wdXQpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhMjU2X1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnY3J5cHRvX2hhc2hfc2hhMjU2X1NUQVRFQllURVMnIGJ5dGVzIikKICB9CgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhMjU2X3VwZGF0ZShzdGF0ZSwgaW5wdXQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19oYXNoX3NoYTI1Nl9maW5hbCA9IGZ1bmN0aW9uIChzdGF0ZSwgb3V0KSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTI1Nl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ2NyeXB0b19oYXNoX3NoYTI1Nl9TVEFURUJZVEVTJyBieXRlcyIpCiAgfQogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhMjU2X0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzdGF0ZScpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhMjU2X2ZpbmFsKHN0YXRlLCBvdXQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19oYXNoX3NoYTUxMiA9IGZ1bmN0aW9uIChvdXQsIGlucHV0KSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9faGFzaF9zaGE1MTJfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhNTEyKG91dCwgaW5wdXQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19oYXNoX3NoYTUxMl9pbml0ID0gZnVuY3Rpb24gKHN0YXRlKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTUxMl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ2NyeXB0b19oYXNoX3NoYTUxMl9TVEFURUJZVEVTJyBieXRlcyIpCiAgfQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTUxMl9pbml0KHN0YXRlKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9faGFzaF9zaGE1MTJfdXBkYXRlID0gZnVuY3Rpb24gKHN0YXRlLCBpbnB1dCkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9faGFzaF9zaGE1MTJfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdjcnlwdG9faGFzaF9zaGE1MTJfU1RBVEVCWVRFUycgYnl0ZXMiKQogIH0KCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9faGFzaF9zaGE1MTJfdXBkYXRlKHN0YXRlLCBpbnB1dCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2hhc2hfc2hhNTEyX2ZpbmFsID0gZnVuY3Rpb24gKHN0YXRlLCBvdXQpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhNTEyX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnY3J5cHRvX2hhc2hfc2hhNTEyX1NUQVRFQllURVMnIGJ5dGVzIikKICB9CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9faGFzaF9zaGE1MTJfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhNTEyX2ZpbmFsKHN0YXRlLCBvdXQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgovLyBjcnlwdG9fYWVhZAoKZXhwb3J0cy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX2tleWdlbiA9IGZ1bmN0aW9uIChrKSB7CiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9rZXlnZW4oaykKfQoKZXhwb3J0cy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX2VuY3J5cHQgPSBmdW5jdGlvbiAoCiAgYywKICBtLAogIGFkLAogIG5zZWMgPSBudWxsLAogIG5wdWIsCiAgawopIHsKICBhZCA/Pz0gdW5kZWZpbmVkCiAgaWYgKG5zZWMgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignbnNlYyBtdXN0IGFsd2F5cyBiZSBzZXQgdG8gbnVsbCcpCiAgaWYgKAogICAgYz8uYnl0ZUxlbmd0aCAhPT0KICAgIG0uYnl0ZUxlbmd0aCArIGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMKICApCiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICdjIG11c3QgIm0uYnl0ZUxlbmd0aCArIGNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTIiBieXRlcycKICAgICkKICBpZiAoYz8uYnl0ZUxlbmd0aCA+IDB4ZmZmZmZmZmYpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2MuYnl0ZUxlbmd0aCBtdXN0IGJlIGEgMzJiaXQgaW50ZWdlcicpCiAgaWYgKG5wdWI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ25wdWInKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfZW5jcnlwdCgKICAgIGMsCiAgICBtLAogICAgYWQsCiAgICBucHViLAogICAgawogICkKICBpZiAocmVzIDwgMCkgdGhyb3cgbmV3IEVycm9yKCdjb3VsZCBub3QgZW5jcnlwdCBkYXRhJykKCiAgcmV0dXJuIHJlcwp9CgpleHBvcnRzLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfZGVjcnlwdCA9IGZ1bmN0aW9uICgKICBtLAogIG5zZWMgPSBudWxsLAogIGMsCiAgYWQsCiAgbnB1YiwKICBrCikgewogIGFkID8/PSB1bmRlZmluZWQKICBpZiAobnNlYyAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCduc2VjIG11c3QgYWx3YXlzIGJlIHNldCB0byBudWxsJykKICBpZiAoCiAgICBtPy5ieXRlTGVuZ3RoICE9PQogICAgYy5ieXRlTGVuZ3RoIC0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUwogICkKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgJ20gbXVzdCAiYy5ieXRlTGVuZ3RoIC0gY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMiIGJ5dGVzJwogICAgKQogIGlmIChtPy5ieXRlTGVuZ3RoID4gMHhmZmZmZmZmZikKICAgIHRocm93IG5ldyBFcnJvcignbS5ieXRlTGVuZ3RoIG11c3QgYmUgYSAzMmJpdCBpbnRlZ2VyJykKICBpZiAobnB1Yj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX05QVUJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbnB1YicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9kZWNyeXB0KAogICAgbSwKICAgIGMsCiAgICBhZCwKICAgIG5wdWIsCiAgICBrCiAgKQogIGlmIChyZXMgPCAwKSB0aHJvdyBuZXcgRXJyb3IoJ2NvdWxkIG5vdCB2ZXJpZnkgZGF0YScpCgogIHJldHVybiByZXMKfQoKZXhwb3J0cy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX2VuY3J5cHRfZGV0YWNoZWQgPSBmdW5jdGlvbiAoCiAgYywKICBtYWMsCiAgbSwKICBhZCwKICBuc2VjID0gbnVsbCwKICBucHViLAogIGsKKSB7CiAgYWQgPz89IHVuZGVmaW5lZAogIGlmIChuc2VjICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ25zZWMgbXVzdCBhbHdheXMgYmUgc2V0IHRvIG51bGwnKQogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2MgbXVzdCBiZSAibS5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG1hYz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbWFjJykKICBpZiAobnB1Yj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX05QVUJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbnB1YicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0X2RldGFjaGVkKAogICAgYywKICAgIG1hYywKICAgIG0sCiAgICBhZCwKICAgIG5wdWIsCiAgICBrCiAgKQogIGlmIChyZXMgPCAwKSB0aHJvdyBuZXcgRXJyb3IoJ2NvdWxkIG5vdCBlbmNyeXB0IGRhdGEnKQoKICByZXR1cm4gcmVzCn0KCmV4cG9ydHMuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9kZWNyeXB0X2RldGFjaGVkID0gZnVuY3Rpb24gKAogIG0sCiAgbnNlYyA9IG51bGwsCiAgYywKICBtYWMsCiAgYWQsCiAgbnB1YiwKICBrCikgewogIGFkID8/PSB1bmRlZmluZWQKICBpZiAobnNlYyAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCduc2VjIG11c3QgYWx3YXlzIGJlIHNldCB0byBudWxsJykKICBpZiAobT8uYnl0ZUxlbmd0aCAhPT0gYy5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMuYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChtYWM/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21hYycpCiAgaWYgKG5wdWI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ25wdWInKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfZGVjcnlwdF9kZXRhY2hlZCgKICAgIG0sCiAgICBjLAogICAgbWFjLAogICAgYWQsCiAgICBucHViLAogICAgawogICkKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ2NvdWxkIG5vdCB2ZXJpZnkgZGF0YScpCn0KCmV4cG9ydHMuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2tleWdlbiA9IGZ1bmN0aW9uIChrKSB7CiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfa2V5Z2VuKGspCn0KCmV4cG9ydHMuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2VuY3J5cHQgPSBmdW5jdGlvbiAoCiAgYywKICBtLAogIGFkLAogIG5zZWMgPSBudWxsLAogIG5wdWIsCiAgawopIHsKICBhZCA/Pz0gdW5kZWZpbmVkCiAgaWYgKG5zZWMgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignbnNlYyBtdXN0IGFsd2F5cyBiZSBzZXQgdG8gbnVsbCcpCiAgaWYgKAogICAgYz8uYnl0ZUxlbmd0aCAhPT0KICAgIG0uYnl0ZUxlbmd0aCArIGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUwogICkKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgJ2MgbXVzdCAibS5ieXRlTGVuZ3RoICsgY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUyIgYnl0ZXMnCiAgICApCiAgaWYgKGM/LmJ5dGVMZW5ndGggPiAweGZmZmZmZmZmKQogICAgdGhyb3cgbmV3IEVycm9yKCdjLmJ5dGVMZW5ndGggbXVzdCBiZSBhIDMyYml0IGludGVnZXInKQogIGlmIChucHViPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ25wdWInKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2VuY3J5cHQoCiAgICBjLAogICAgbSwKICAgIGFkLAogICAgbnB1YiwKICAgIGsKICApCiAgaWYgKHJlcyA8IDApIHRocm93IG5ldyBFcnJvcignY291bGQgbm90IGVuY3J5cHQgZGF0YScpCgogIHJldHVybiByZXMKfQoKZXhwb3J0cy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfZGVjcnlwdCA9IGZ1bmN0aW9uICgKICBtLAogIG5zZWMgPSBudWxsLAogIGMsCiAgYWQsCiAgbnB1YiwKICBrCikgewogIGFkID8/PSB1bmRlZmluZWQKICBpZiAobnNlYyAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCduc2VjIG11c3QgYWx3YXlzIGJlIHNldCB0byBudWxsJykKICBpZiAoCiAgICBtPy5ieXRlTGVuZ3RoICE9PQogICAgYy5ieXRlTGVuZ3RoIC0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTCiAgKQogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAnbSBtdXN0ICJjLmJ5dGVMZW5ndGggLSBjcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTIiBieXRlcycKICAgICkKICBpZiAobT8uYnl0ZUxlbmd0aCA+IDB4ZmZmZmZmZmYpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20uYnl0ZUxlbmd0aCBtdXN0IGJlIGEgMzJiaXQgaW50ZWdlcicpCiAgaWYgKG5wdWI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX05QVUJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbnB1YicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfZGVjcnlwdCgKICAgIG0sCiAgICBjLAogICAgYWQsCiAgICBucHViLAogICAgawogICkKICBpZiAocmVzIDwgMCkgdGhyb3cgbmV3IEVycm9yKCdjb3VsZCBub3QgdmVyaWZ5IGRhdGEnKQoKICByZXR1cm4gcmVzCn0KCmV4cG9ydHMuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2VuY3J5cHRfZGV0YWNoZWQgPSBmdW5jdGlvbiAoCiAgYywKICBtYWMsCiAgbSwKICBhZCwKICBuc2VjID0gbnVsbCwKICBucHViLAogIGsKKSB7CiAgYWQgPz89IHVuZGVmaW5lZAogIGlmIChuc2VjICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ25zZWMgbXVzdCBhbHdheXMgYmUgc2V0IHRvIG51bGwnKQogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2MgbXVzdCBiZSAibS5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG1hYz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdtYWMnKQogIGlmIChucHViPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ25wdWInKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2VuY3J5cHRfZGV0YWNoZWQoCiAgICBjLAogICAgbWFjLAogICAgbSwKICAgIGFkLAogICAgbnB1YiwKICAgIGsKICApCiAgaWYgKHJlcyA8IDApIHRocm93IG5ldyBFcnJvcignY291bGQgbm90IGVuY3J5cHQgZGF0YScpCgogIHJldHVybiByZXMKfQoKZXhwb3J0cy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfZGVjcnlwdF9kZXRhY2hlZCA9IGZ1bmN0aW9uICgKICBtLAogIG5zZWMgPSBudWxsLAogIGMsCiAgbWFjLAogIGFkLAogIG5wdWIsCiAgawopIHsKICBhZCA/Pz0gdW5kZWZpbmVkCiAgaWYgKG5zZWMgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignbnNlYyBtdXN0IGFsd2F5cyBiZSBzZXQgdG8gbnVsbCcpCiAgaWYgKG0/LmJ5dGVMZW5ndGggIT09IGMuYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobWFjPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21hYycpCiAgaWYgKG5wdWI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX05QVUJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbnB1YicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfZGVjcnlwdF9kZXRhY2hlZCgKICAgIG0sCiAgICBjLAogICAgbWFjLAogICAgYWQsCiAgICBucHViLAogICAgawogICkKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ2NvdWxkIG5vdCB2ZXJpZnkgZGF0YScpCn0KCi8vIGNyeXB0b19zdHJlYW0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV94b3Jfd3JhcF9pbml0ID0gZnVuY3Rpb24gKHN0YXRlLCBuLCBrKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLnNuX2NyeXB0b19zdHJlYW1feG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnc25fY3J5cHRvX3N0cmVhbV94b3JfU1RBVEVCWVRFUycgYnl0ZXMiKQogIH0KICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX05PTkNFQllURVMpIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9LRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX3hvcl93cmFwX2luaXQoc3RhdGUsIG4sIGspCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV94b3Jfd3JhcF91cGRhdGUgPSBmdW5jdGlvbiAoc3RhdGUsIGMsIG0pIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuc25fY3J5cHRvX3N0cmVhbV94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdzbl9jcnlwdG9fc3RyZWFtX3hvcl9TVEFURUJZVEVTJyBieXRlcyIpCiAgfQogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2MgbXVzdCBiZSAibS5ieXRlTGVuZ3RoIiBieXRlcycpCgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94b3Jfd3JhcF91cGRhdGUoc3RhdGUsIGMsIG0pCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV94b3Jfd3JhcF9maW5hbCA9IGZ1bmN0aW9uIChzdGF0ZSkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5zbl9jcnlwdG9fc3RyZWFtX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ3NuX2NyeXB0b19zdHJlYW1feG9yX1NUQVRFQllURVMnIGJ5dGVzIikKICB9CgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94b3Jfd3JhcF9maW5hbChzdGF0ZSkKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl93cmFwX2luaXQgPSBmdW5jdGlvbiAoc3RhdGUsIG4sIGspIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAic3RhdGUgbXVzdCBiZSAnY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3JfU1RBVEVCWVRFUycgYnl0ZXMiCiAgICApCiAgfQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3Jfd3JhcF9pbml0KHN0YXRlLCBuLCBrKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX3dyYXBfdXBkYXRlID0gZnVuY3Rpb24gKHN0YXRlLCBjLCBtKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdjIG11c3QgYmUgIm0uYnl0ZUxlbmd0aCIgYnl0ZXMnKQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX3dyYXBfdXBkYXRlKHN0YXRlLCBjLCBtKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX3dyYXBfZmluYWwgPSBmdW5jdGlvbiAoc3RhdGUpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAic3RhdGUgbXVzdCBiZSAnY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3JfU1RBVEVCWVRFUycgYnl0ZXMiCiAgICApCiAgfQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX3dyYXBfZmluYWwoc3RhdGUpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl93cmFwX2luaXQgPSBmdW5jdGlvbiAoc3RhdGUsIG4sIGspIHsKICBpZiAoCiAgICBzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX1NUQVRFQllURVMKICApIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3JfU1RBVEVCWVRFUycgYnl0ZXMiCiAgICApCiAgfQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3Jfd3JhcF9pbml0KHN0YXRlLCBuLCBrKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3Jfd3JhcF91cGRhdGUgPSBmdW5jdGlvbiAoc3RhdGUsIGMsIG0pIHsKICBpZiAoCiAgICBzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX1NUQVRFQllURVMKICApIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3JfU1RBVEVCWVRFUycgYnl0ZXMiCiAgICApCiAgfQogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2MgbXVzdCBiZSAibS5ieXRlTGVuZ3RoIiBieXRlcycpCgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl93cmFwX3VwZGF0ZShzdGF0ZSwgYywgbSkKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX3dyYXBfZmluYWwgPSBmdW5jdGlvbiAoc3RhdGUpIHsKICBpZiAoCiAgICBzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX1NUQVRFQllURVMKICApIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3JfU1RBVEVCWVRFUycgYnl0ZXMiCiAgICApCiAgfQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3Jfd3JhcF9maW5hbChzdGF0ZSkKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3Jfd3JhcF9pbml0ID0gZnVuY3Rpb24gKHN0YXRlLCBuLCBrKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3JfU1RBVEVCWVRFUycgYnl0ZXMiCiAgICApCiAgfQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3Jfd3JhcF9pbml0KHN0YXRlLCBuLCBrKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl93cmFwX3VwZGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgYywgbSkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAic3RhdGUgbXVzdCBiZSAnY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdjIG11c3QgYmUgIm0uYnl0ZUxlbmd0aCIgYnl0ZXMnKQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl93cmFwX3VwZGF0ZShzdGF0ZSwgYywgbSkKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3Jfd3JhcF9maW5hbCA9IGZ1bmN0aW9uIChzdGF0ZSkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAic3RhdGUgbXVzdCBiZSAnY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3Jfd3JhcF9maW5hbChzdGF0ZSkKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX3dyYXBfaW5pdCA9IGZ1bmN0aW9uIChzdGF0ZSwgbiwgaykgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3JfU1RBVEVCWVRFUycgYnl0ZXMiCiAgICApCiAgfQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3Jfd3JhcF9pbml0KHN0YXRlLCBuLCBrKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3Jfd3JhcF91cGRhdGUgPSBmdW5jdGlvbiAoc3RhdGUsIGMsIG0pIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdjIG11c3QgYmUgIm0uYnl0ZUxlbmd0aCIgYnl0ZXMnKQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3Jfd3JhcF91cGRhdGUoc3RhdGUsIGMsIG0pCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl93cmFwX2ZpbmFsID0gZnVuY3Rpb24gKHN0YXRlKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAic3RhdGUgbXVzdCBiZSAnY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl93cmFwX2ZpbmFsKHN0YXRlKQp9CgovLyBleHBlcmltZW50YWwKCmV4cG9ydHMuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfYmFzZSA9IGZ1bmN0aW9uIChuLCBwLCBucykgewogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAocD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncCcpCgogIGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfYmFzZShuLCBwLCBucykKfQoKZXhwb3J0cy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9zaWduX2RldGFjaGVkID0gZnVuY3Rpb24gKHNpZywgbSwgc2NhbGFyLCBwaykgewogIGlmIChzaWc/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fQllURVMpIHRocm93IG5ldyBFcnJvcignc2lnJykKICBpZiAoc2NhbGFyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzY2FsYXInKQogIGlmIChwayAmJiBway5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfc2lnbl9kZXRhY2hlZChzaWcsIG0sIHNjYWxhciwgcGspCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdmYWlsZWQgdG8gY29tcHV0ZSBzaWduYXR1cmUnKQp9CgpleHBvcnRzLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3NrX3RvX3NjYWxhciA9IGZ1bmN0aW9uIChuLCBzaykgewogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoc2s/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NrJykKCiAgYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9za190b19zY2FsYXIobiwgc2spCn0KCmV4cG9ydHMuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfc2NhbGFyID0gZnVuY3Rpb24gKHNjYWxhck91dCwgc2NhbGFyLCBucykgewogIGlmIChzY2FsYXJPdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NjYWxhcl9vdXQnKQogIGlmIChzY2FsYXI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NjYWxhcicpCgogIGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfc2NhbGFyKHNjYWxhck91dCwgc2NhbGFyLCBucykKfQoKZXhwb3J0cy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9wayA9IGZ1bmN0aW9uICh0cGssIHBrLCBucykgewogIGlmICh0cGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3RwaycpCiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfcGsodHBrLCBwaywgbnMpCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdmYWlsZWQgdG8gdHdlYWsgcHVibGljIGtleScpCn0KCmV4cG9ydHMuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfa2V5cGFpciA9IGZ1bmN0aW9uICgKICBwaywKICBzY2FsYXJPdXQsCiAgc2NhbGFySW4sCiAgbnMKKSB7CiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwaycpCiAgaWYgKHNjYWxhck91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2NhbGFyX291dCcpCiAgaWYgKHNjYWxhckluPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzY2FsYXJfaW4nKQoKICBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X2tleXBhaXIocGssIHNjYWxhck91dCwgc2NhbGFySW4sIG5zKQp9CgpleHBvcnRzLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3NjYWxhcl9hZGQgPSBmdW5jdGlvbiAoc2NhbGFyT3V0LCBzY2FsYXIsIG4pIHsKICBpZiAoc2NhbGFyT3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzY2FsYXJfb3V0JykKICBpZiAoc2NhbGFyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzY2FsYXInKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKCiAgYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9zY2FsYXJfYWRkKHNjYWxhck91dCwgc2NhbGFyLCBuKQp9CgpleHBvcnRzLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3BrX2FkZCA9IGZ1bmN0aW9uICh0cGssIHBrLCBwKSB7CiAgaWYgKHRwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigndHBrJykKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKICBpZiAocD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdwJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9wa19hZGQodHBrLCBwaywgcCkKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ2ZhaWxlZCB0byBhZGQgdHdlYWsgdG8gcHVibGljIGtleScpCn0KCmV4cG9ydHMuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfa2V5cGFpcl9hZGQgPSBmdW5jdGlvbiAoCiAgcGssCiAgc2NhbGFyT3V0LAogIHNjYWxhckluLAogIHR3ZWFrCikgewogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQogIGlmIChzY2FsYXJPdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NjYWxhcl9vdXQnKQogIGlmIChzY2FsYXJJbj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2NhbGFyX2luJykKICBpZiAodHdlYWs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3R3ZWFrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9rZXlwYWlyX2FkZCgKICAgIHBrLAogICAgc2NhbGFyT3V0LAogICAgc2NhbGFySW4sCiAgICB0d2VhawogICkKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ2ZhaWxlZCB0byBhZGQgdHdlYWsgdG8ga2V5cGFpcicpCn0KCmV4cG9ydHMuZXh0ZW5zaW9uX3Bia2RmMl9zaGE1MTJfYXN5bmMgPSBmdW5jdGlvbiAoCiAgb3V0LAogIHBhc3N3ZCwKICBzYWx0LAogIGl0ZXIsCiAgb3V0bGVuLAogIGNhbGxiYWNrID0gdW5kZWZpbmVkCikgewogIGlmIChpdGVyIDwgYmluZGluZy5leHRlbnNpb25fcGJrZGYyX3NoYTUxMl9JVEVSQVRJT05TX01JTikKICAgIHRocm93IG5ldyBFcnJvcignaXRlcmF0aW9ucycpCiAgaWYgKG91dGxlbiA+IGJpbmRpbmcuZXh0ZW5zaW9uX3Bia2RmMl9zaGE1MTJfQllURVNfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXRsZW4nKQogIGlmIChvdXQ/LmJ5dGVMZW5ndGggPCBvdXRsZW4pIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoIW91dD8uYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmICghcGFzc3dkPy5ieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ3Bhc3N3ZCcpCiAgaWYgKCFzYWx0Py5ieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ3NhbHQnKQoKICBjb25zdCBbZG9uZSwgcHJvbWlzZV0gPSBjaGVja1N0YXR1cyhjYWxsYmFjaykKCiAgYmluZGluZy5leHRlbnNpb25fcGJrZGYyX3NoYTUxMl9hc3luYygKICAgIG91dC5idWZmZXIsCiAgICBvdXQuYnl0ZU9mZnNldCwKICAgIG91dC5ieXRlTGVuZ3RoLAoKICAgIHBhc3N3ZC5idWZmZXIsCiAgICBwYXNzd2QuYnl0ZU9mZnNldCwKICAgIHBhc3N3ZC5ieXRlTGVuZ3RoLAoKICAgIHNhbHQuYnVmZmVyLAogICAgc2FsdC5ieXRlT2Zmc2V0LAogICAgc2FsdC5ieXRlTGVuZ3RoLAoKICAgIGl0ZXIsCiAgICBvdXRsZW4sCgogICAgZG9uZQogICkKCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5leHRlbnNpb25fcGJrZGYyX3NoYTUxMiA9IGZ1bmN0aW9uIChvdXQsIHBhc3N3ZCwgc2FsdCwgaXRlciwgb3V0bGVuKSB7CiAgaWYgKGl0ZXIgPCBiaW5kaW5nLmV4dGVuc2lvbl9wYmtkZjJfc2hhNTEyX0lURVJBVElPTlNfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdpdGVyYXRpb25zJykKICBpZiAob3V0bGVuID4gYmluZGluZy5leHRlbnNpb25fcGJrZGYyX3NoYTUxMl9CWVRFU19NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dGxlbicpCiAgaWYgKG91dD8uYnl0ZUxlbmd0aCA8IG91dGxlbikgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmV4dGVuc2lvbl9wYmtkZjJfc2hhNTEyKG91dCwgcGFzc3dkLCBzYWx0LCBpdGVyLCBvdXRsZW4pCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIGFkZCB0d2VhayB0byBwdWJsaWMga2V5JykKfQoKZnVuY3Rpb24gY2hlY2tTdGF0dXMoY2FsbGJhY2ssIGJvb2xlYW5SZXN1bHQgPSBmYWxzZSkgewogIGxldCBkb25lLCBwcm9taXNlCgogIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgIGRvbmUgPSBmdW5jdGlvbiAoc3RhdHVzKSB7CiAgICAgIGlmIChib29sZWFuUmVzdWx0KSBjYWxsYmFjayhudWxsLCBzdGF0dXMgPT09IDApCiAgICAgIGVsc2UgaWYgKHN0YXR1cyA9PT0gMCkgY2FsbGJhY2sobnVsbCkKICAgICAgZWxzZSBjYWxsYmFjayhuZXcgRXJyb3IoJ3N0YXR1czogJyArIHN0YXR1cykpCiAgICB9CiAgfSBlbHNlIHsKICAgIHByb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGRvbmUgPSBmdW5jdGlvbiAoc3RhdHVzKSB7CiAgICAgICAgaWYgKGJvb2xlYW5SZXN1bHQpIHJlc29sdmUoc3RhdHVzID09PSAwKQogICAgICAgIGVsc2UgaWYgKHN0YXR1cyA9PT0gMCkgcmVzb2x2ZSgpCiAgICAgICAgZWxzZSByZWplY3QobmV3IEVycm9yKCdzdGF0dXM6ICcgKyBzdGF0dXMpKQogICAgICB9CiAgICB9KQogIH0KCiAgcmV0dXJuIFtkb25lLCBwcm9taXNlXQp9CnsKICAibmFtZSI6ICJzb2RpdW0tbmF0aXZlIiwKICAidmVyc2lvbiI6ICI1LjAuMTAiLAogICJkZXNjcmlwdGlvbiI6ICJMb3cgbGV2ZWwgYmluZGluZ3MgZm9yIGxpYnNvZGl1bSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiYmluZGluZy5jYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiZXh0ZW5zaW9ucyIsCiAgICAicHJlYnVpbGRzIiwKICAgICJDTWFrZUxpc3RzLnR4dCIKICBdLAogICJhZGRvbiI6IHRydWUsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJyZXF1aXJlLWFkZG9uIjogIl4xLjEuMCIsCiAgICAid2hpY2gtcnVudGltZSI6ICJeMS4yLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtY29tcGF0LW5hcGkiOiAiXjEuMy41IiwKICAgICJicml0dGxlIjogIl4zLjE2LjIiLAogICAgImNtYWtlLWJhcmUiOiAiXjEuNi4xIiwKICAgICJjbWFrZS1mZXRjaCI6ICJeMS40LjMiLAogICAgImNtYWtlLW5hcGkiOiAiXjEuMi4xIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjEuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgbnBtIHJ1biB0ZXN0Om5vZGUgJiYgbnBtIHJ1biB0ZXN0OmJhcmUiLAogICAgInRlc3Q6bm9kZSI6ICJub2RlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0L2FsbC5qcyIKICB9LAogICJzdGFuZGFyZCI6IHsKICAgICJpZ25vcmUiOiBbCiAgICAgICIvdGVzdC9maXh0dXJlcy8qLmpzIgogICAgXQogIH0sCiAgImVuZ2luZXMiOiB7CiAgICAiYmFyZSI6ICI+PTEuMTYuMCIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zb2RpdW0tbmF0aXZlLmdpdCIKICB9LAogICJjb250cmlidXRvcnMiOiBbCiAgICAiRW1pbCBCYXkgPGdpdGh1YkB0aXh6LmRrPiAoaHR0cDovL2JheWVzLmRrKSIsCiAgICAiTWF0aGlhcyBCdXVzIDxtYXRoaWFzYnV1c0BnbWFpbC5jb20+IChodHRwczovL21hZmludG8uc2gpIiwKICAgICJDaHJpc3RvcGhlIERpZWRlcmljaHMgPGNobS1kaWVkZXJpY2hzQGh5cGVyZGl2aXNpb24uZGs+IgogIF0sCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NvZGl1bS1uYXRpdmUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zb2RpdW0tbmF0aXZlIgp9CmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgQUJZVEVTID0gc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfQUJZVEVTCmNvbnN0IFRBR19NRVNTQUdFID0gc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfVEFHX01FU1NBR0UKY29uc3QgVEFHX0ZJTkFMID0gc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfVEFHX0ZJTkFMCmNvbnN0IFNUQVRFQllURVMgPSBzb2RpdW0uY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9TVEFURUJZVEVTCmNvbnN0IEhFQURFUkJZVEVTID0gc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfSEVBREVSQllURVMKY29uc3QgS0VZQllURVMgPSBzb2RpdW0uY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9LRVlCWVRFUwpjb25zdCBUQUdfRklOQUxfQllURSA9IGI0YS5pc0J1ZmZlcihUQUdfRklOQUwpID8gVEFHX0ZJTkFMWzBdIDogVEFHX0ZJTkFMCgpjb25zdCBFTVBUWSA9IGI0YS5hbGxvYygwKQpjb25zdCBUQUcgPSBiNGEuYWxsb2MoMSkKCmNsYXNzIFB1c2ggewogIGNvbnN0cnVjdG9yIChrZXksIHN0YXRlID0gYjRhLmFsbG9jVW5zYWZlU2xvdyhTVEFURUJZVEVTKSwgaGVhZGVyID0gYjRhLmFsbG9jVW5zYWZlU2xvdyhIRUFERVJCWVRFUykpIHsKICAgIGlmICghVEFHX0ZJTkFMKSB0aHJvdyBuZXcgRXJyb3IoJ0phdmFTY3JpcHQgc29kaXVtIHZlcnNpb24gbmVlZHMgdG8gc3VwcG9ydCBjcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHknKQoKICAgIHRoaXMua2V5ID0ga2V5CiAgICB0aGlzLnN0YXRlID0gc3RhdGUKICAgIHRoaXMuaGVhZGVyID0gaGVhZGVyCgogICAgc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfaW5pdF9wdXNoKHRoaXMuc3RhdGUsIHRoaXMuaGVhZGVyLCB0aGlzLmtleSkKICB9CgogIG5leHQgKG1lc3NhZ2UsIGNpcGhlciA9IGI0YS5hbGxvY1Vuc2FmZShtZXNzYWdlLmJ5dGVMZW5ndGggKyBBQllURVMpKSB7CiAgICBzb2RpdW0uY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9wdXNoKHRoaXMuc3RhdGUsIGNpcGhlciwgbWVzc2FnZSwgbnVsbCwgVEFHX01FU1NBR0UpCiAgICByZXR1cm4gY2lwaGVyCiAgfQoKICBmaW5hbCAobWVzc2FnZSA9IEVNUFRZLCBjaXBoZXIgPSBiNGEuYWxsb2NVbnNhZmUoQUJZVEVTKSkgewogICAgc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfcHVzaCh0aGlzLnN0YXRlLCBjaXBoZXIsIG1lc3NhZ2UsIG51bGwsIFRBR19GSU5BTCkKICAgIHJldHVybiBjaXBoZXIKICB9Cn0KCmNsYXNzIFB1bGwgewogIGNvbnN0cnVjdG9yIChrZXksIHN0YXRlID0gYjRhLmFsbG9jVW5zYWZlU2xvdyhTVEFURUJZVEVTKSkgewogICAgaWYgKCFUQUdfRklOQUwpIHRocm93IG5ldyBFcnJvcignSmF2YVNjcmlwdCBzb2RpdW0gdmVyc2lvbiBuZWVkcyB0byBzdXBwb3J0IGNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seScpCgogICAgdGhpcy5rZXkgPSBrZXkKICAgIHRoaXMuc3RhdGUgPSBzdGF0ZQogICAgdGhpcy5maW5hbCA9IGZhbHNlCiAgfQoKICBpbml0IChoZWFkZXIpIHsKICAgIHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X2luaXRfcHVsbCh0aGlzLnN0YXRlLCBoZWFkZXIsIHRoaXMua2V5KQogIH0KCiAgbmV4dCAoY2lwaGVyLCBtZXNzYWdlID0gYjRhLmFsbG9jVW5zYWZlKGNpcGhlci5ieXRlTGVuZ3RoIC0gQUJZVEVTKSkgewogICAgc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfcHVsbCh0aGlzLnN0YXRlLCBtZXNzYWdlLCBUQUcsIGNpcGhlciwgbnVsbCkKICAgIHRoaXMuZmluYWwgPSBUQUdbMF0gPT09IFRBR19GSU5BTF9CWVRFCiAgICByZXR1cm4gbWVzc2FnZQogIH0KfQoKZnVuY3Rpb24ga2V5Z2VuIChidWYgPSBiNGEuYWxsb2MoS0VZQllURVMpKSB7CiAgc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfa2V5Z2VuKGJ1ZikKICByZXR1cm4gYnVmCn0KCm1vZHVsZS5leHBvcnRzID0gewogIGtleWdlbiwKICBLRVlCWVRFUywKICBBQllURVMsCiAgU1RBVEVCWVRFUywKICBIRUFERVJCWVRFUywKICBQdXNoLAogIFB1bGwKfQp7CiAgIm5hbWUiOiAic29kaXVtLXNlY3JldHN0cmVhbSIsCiAgInZlcnNpb24iOiAiMS4yLjAiLAogICJkZXNjcmlwdGlvbiI6ICJXcmFwcyBsaWJzb2RpdW1zIHNlY3JldHN0cmVhbSBpbiBhIGhpZ2hlciBsZXZlbCBhYnN0cmFjdGlvbiIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjEuMSIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NvZGl1bS1zZWNyZXRzdHJlYW0uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NvZGl1bS1zZWNyZXRzdHJlYW0vaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc29kaXVtLXNlY3JldHN0cmVhbSIKfQptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoJ3NvZGl1bS1uYXRpdmUnKQp7CiAgIm5hbWUiOiAic29kaXVtLXVuaXZlcnNhbCIsCiAgInZlcnNpb24iOiAiNS4wLjEiLAogICJkZXNjcmlwdGlvbiI6ICJVbml2ZXJzYWwgd3JhcHBlciBmb3Igc29kaXVtLWphdmFzY3JpcHQgYW5kIHNvZGl1bS1uYXRpdmUgd29ya2luZyBpbiBOb2RlLmpzIGFuZCB0aGUgQnJvd3NlciIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAic29kaXVtLW5hdGl2ZSI6ICJeNS4wLjEiCiAgfSwKICAicGVlckRlcGVuZGVuY2llcyI6IHsKICAgICJzb2RpdW0tamF2YXNjcmlwdCI6ICJ+MC44LjAiCiAgfSwKICAicGVlckRlcGVuZGVuY2llc01ldGEiOiB7CiAgICAic29kaXVtLWphdmFzY3JpcHQiOiB7CiAgICAgICJvcHRpb25hbCI6IHRydWUKICAgIH0KICB9LAogICJzY3JpcHRzIjogewogICAgInByZXB1Ymxpc2giOiAiLi9idWlsZC1zY3JpcHRzL2dlbmVyYXRlLmpzIgogIH0sCiAgImJyb3dzZXIiOiB7CiAgICAic29kaXVtLW5hdGl2ZSI6ICJzb2RpdW0tamF2YXNjcmlwdCIKICB9LAogICJicm93c2VyaWZ5IjogewogICAgInRyYW5zZm9ybSI6IFsKICAgICAgIi4vYnVpbGQtc2NyaXB0cy90cmFuc2Zvcm0uanMiCiAgICBdCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc29kaXVtLXVuaXZlcnNhbC5naXQiCiAgfSwKICAia2V5d29yZHMiOiBbCiAgICAibGlic29kaXVtIiwKICAgICJzb2RpdW0iLAogICAgInNvZGl1bS1uYXRpdmUiLAogICAgInNvZGl1bS1qYXZhc2NyaXB0IiwKICAgICJicm93c2VyaWZ5IgogIF0sCiAgImNvbnRyaWJ1dG9ycyI6IFsKICAgICJFbWlsIEJheSA8Z2l0aHViQHRpeHouZGs+IChodHRwOi8vYmF5ZXMuZGspIiwKICAgICJNYXRoaWFzIEJ1dXMgPG1hdGhpYXNidXVzQGdtYWlsLmNvbT4gKGh0dHBzOi8vbWFmaW50by5zaCkiLAogICAgIkNocmlzdG9waGUgRGllZGVyaWNocyA8Y2htLWRpZWRlcmljaHNAaHlwZXJkaXZpc2lvbi5kaz4iCiAgXSwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc29kaXVtLXVuaXZlcnNhbC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NvZGl1bS11bml2ZXJzYWwjcmVhZG1lIgp9CmNvbnN0IHsgRXZlbnRFbWl0dGVyIH0gPSByZXF1aXJlKCdldmVudHMtdW5pdmVyc2FsJykKY29uc3QgU1RSRUFNX0RFU1RST1lFRCA9IG5ldyBFcnJvcignU3RyZWFtIHdhcyBkZXN0cm95ZWQnKQpjb25zdCBQUkVNQVRVUkVfQ0xPU0UgPSBuZXcgRXJyb3IoJ1ByZW1hdHVyZSBjbG9zZScpCgpjb25zdCBGSUZPID0gcmVxdWlyZSgnZmFzdC1maWZvJykKY29uc3QgVGV4dERlY29kZXIgPSByZXF1aXJlKCd0ZXh0LWRlY29kZXInKQoKLy8gaWYgd2UgZG8gYSBmdXR1cmUgbWFqb3IsIGV4cGVjdCBxdWV1ZSBtaWNyb3Rhc2sgdG8gYmUgdGhlcmUgYWx3YXlzLCBmb3Igbm93IGEgYml0IGRlZmVuc2l2ZQpjb25zdCBxbXQgPSB0eXBlb2YgcXVldWVNaWNyb3Rhc2sgPT09ICd1bmRlZmluZWQnID8gZm4gPT4gZ2xvYmFsLnByb2Nlc3MubmV4dFRpY2soZm4pIDogcXVldWVNaWNyb3Rhc2sKCi8qIGVzbGludC1kaXNhYmxlIG5vLW11bHRpLXNwYWNlcyAqLwoKLy8gMjkgYml0cyB1c2VkIHRvdGFsICg0IGZyb20gc2hhcmVkLCAxNCBmcm9tIHJlYWQsIGFuZCAxMSBmcm9tIHdyaXRlKQpjb25zdCBNQVggPSAoKDEgPDwgMjkpIC0gMSkKCi8vIFNoYXJlZCBzdGF0ZQpjb25zdCBPUEVOSU5HICAgICAgID0gMGIwMDAxCmNvbnN0IFBSRURFU1RST1lJTkcgPSAwYjAwMTAKY29uc3QgREVTVFJPWUlORyAgICA9IDBiMDEwMApjb25zdCBERVNUUk9ZRUQgICAgID0gMGIxMDAwCgpjb25zdCBOT1RfT1BFTklORyA9IE1BWCBeIE9QRU5JTkcKY29uc3QgTk9UX1BSRURFU1RST1lJTkcgPSBNQVggXiBQUkVERVNUUk9ZSU5HCgovLyBSZWFkIHN0YXRlICg0IGJpdCBvZmZzZXQgZnJvbSBzaGFyZWQgc3RhdGUpCmNvbnN0IFJFQURfQUNUSVZFICAgICAgICAgICA9IDBiMDAwMDAwMDAwMDAwMDEgPDwgNApjb25zdCBSRUFEX1VQREFUSU5HICAgICAgICAgPSAwYjAwMDAwMDAwMDAwMDEwIDw8IDQKY29uc3QgUkVBRF9QUklNQVJZICAgICAgICAgID0gMGIwMDAwMDAwMDAwMDEwMCA8PCA0CmNvbnN0IFJFQURfUVVFVUVEICAgICAgICAgICA9IDBiMDAwMDAwMDAwMDEwMDAgPDwgNApjb25zdCBSRUFEX1JFU1VNRUQgICAgICAgICAgPSAwYjAwMDAwMDAwMDEwMDAwIDw8IDQKY29uc3QgUkVBRF9QSVBFX0RSQUlORUQgICAgID0gMGIwMDAwMDAwMDEwMDAwMCA8PCA0CmNvbnN0IFJFQURfRU5ESU5HICAgICAgICAgICA9IDBiMDAwMDAwMDEwMDAwMDAgPDwgNApjb25zdCBSRUFEX0VNSVRfREFUQSAgICAgICAgPSAwYjAwMDAwMDEwMDAwMDAwIDw8IDQKY29uc3QgUkVBRF9FTUlUX1JFQURBQkxFICAgID0gMGIwMDAwMDEwMDAwMDAwMCA8PCA0CmNvbnN0IFJFQURfRU1JVFRFRF9SRUFEQUJMRSA9IDBiMDAwMDEwMDAwMDAwMDAgPDwgNApjb25zdCBSRUFEX0RPTkUgICAgICAgICAgICAgPSAwYjAwMDEwMDAwMDAwMDAwIDw8IDQKY29uc3QgUkVBRF9ORVhUX1RJQ0sgICAgICAgID0gMGIwMDEwMDAwMDAwMDAwMCA8PCA0CmNvbnN0IFJFQURfTkVFRFNfUFVTSCAgICAgICA9IDBiMDEwMDAwMDAwMDAwMDAgPDwgNApjb25zdCBSRUFEX1JFQURfQUhFQUQgICAgICAgPSAwYjEwMDAwMDAwMDAwMDAwIDw8IDQKCi8vIENvbWJpbmVkIHJlYWQgc3RhdGUKY29uc3QgUkVBRF9GTE9XSU5HID0gUkVBRF9SRVNVTUVEIHwgUkVBRF9QSVBFX0RSQUlORUQKY29uc3QgUkVBRF9BQ1RJVkVfQU5EX05FRURTX1BVU0ggPSBSRUFEX0FDVElWRSB8IFJFQURfTkVFRFNfUFVTSApjb25zdCBSRUFEX1BSSU1BUllfQU5EX0FDVElWRSA9IFJFQURfUFJJTUFSWSB8IFJFQURfQUNUSVZFCmNvbnN0IFJFQURfRU1JVF9SRUFEQUJMRV9BTkRfUVVFVUVEID0gUkVBRF9FTUlUX1JFQURBQkxFIHwgUkVBRF9RVUVVRUQKY29uc3QgUkVBRF9SRVNVTUVEX1JFQURfQUhFQUQgPSBSRUFEX1JFU1VNRUQgfCBSRUFEX1JFQURfQUhFQUQKCmNvbnN0IFJFQURfTk9UX0FDVElWRSAgICAgICAgICAgICA9IE1BWCBeIFJFQURfQUNUSVZFCmNvbnN0IFJFQURfTk9OX1BSSU1BUlkgICAgICAgICAgICA9IE1BWCBeIFJFQURfUFJJTUFSWQpjb25zdCBSRUFEX05PTl9QUklNQVJZX0FORF9QVVNIRUQgPSBNQVggXiAoUkVBRF9QUklNQVJZIHwgUkVBRF9ORUVEU19QVVNIKQpjb25zdCBSRUFEX1BVU0hFRCAgICAgICAgICAgICAgICAgPSBNQVggXiBSRUFEX05FRURTX1BVU0gKY29uc3QgUkVBRF9QQVVTRUQgICAgICAgICAgICAgICAgID0gTUFYIF4gUkVBRF9SRVNVTUVECmNvbnN0IFJFQURfTk9UX1FVRVVFRCAgICAgICAgICAgICA9IE1BWCBeIChSRUFEX1FVRVVFRCB8IFJFQURfRU1JVFRFRF9SRUFEQUJMRSkKY29uc3QgUkVBRF9OT1RfRU5ESU5HICAgICAgICAgICAgID0gTUFYIF4gUkVBRF9FTkRJTkcKY29uc3QgUkVBRF9QSVBFX05PVF9EUkFJTkVEICAgICAgID0gTUFYIF4gUkVBRF9GTE9XSU5HCmNvbnN0IFJFQURfTk9UX05FWFRfVElDSyAgICAgICAgICA9IE1BWCBeIFJFQURfTkVYVF9USUNLCmNvbnN0IFJFQURfTk9UX1VQREFUSU5HICAgICAgICAgICA9IE1BWCBeIFJFQURfVVBEQVRJTkcKY29uc3QgUkVBRF9OT19SRUFEX0FIRUFEICAgICAgICAgID0gTUFYIF4gUkVBRF9SRUFEX0FIRUFECmNvbnN0IFJFQURfUEFVU0VEX05PX1JFQURfQUhFQUQgICA9IE1BWCBeIFJFQURfUkVTVU1FRF9SRUFEX0FIRUFECgovLyBXcml0ZSBzdGF0ZSAoMTggYml0IG9mZnNldCwgNCBiaXQgb2Zmc2V0IGZyb20gc2hhcmVkIHN0YXRlIGFuZCAxNCBmcm9tIHJlYWQgc3RhdGUpCmNvbnN0IFdSSVRFX0FDVElWRSAgICAgPSAwYjAwMDAwMDAwMDAxIDw8IDE4CmNvbnN0IFdSSVRFX1VQREFUSU5HICAgPSAwYjAwMDAwMDAwMDEwIDw8IDE4CmNvbnN0IFdSSVRFX1BSSU1BUlkgICAgPSAwYjAwMDAwMDAwMTAwIDw8IDE4CmNvbnN0IFdSSVRFX1FVRVVFRCAgICAgPSAwYjAwMDAwMDAxMDAwIDw8IDE4CmNvbnN0IFdSSVRFX1VORFJBSU5FRCAgPSAwYjAwMDAwMDEwMDAwIDw8IDE4CmNvbnN0IFdSSVRFX0RPTkUgICAgICAgPSAwYjAwMDAwMTAwMDAwIDw8IDE4CmNvbnN0IFdSSVRFX0VNSVRfRFJBSU4gPSAwYjAwMDAxMDAwMDAwIDw8IDE4CmNvbnN0IFdSSVRFX05FWFRfVElDSyAgPSAwYjAwMDEwMDAwMDAwIDw8IDE4CmNvbnN0IFdSSVRFX1dSSVRJTkcgICAgPSAwYjAwMTAwMDAwMDAwIDw8IDE4CmNvbnN0IFdSSVRFX0ZJTklTSElORyAgPSAwYjAxMDAwMDAwMDAwIDw8IDE4CmNvbnN0IFdSSVRFX0NPUktFRCAgICAgPSAwYjEwMDAwMDAwMDAwIDw8IDE4Cgpjb25zdCBXUklURV9OT1RfQUNUSVZFICAgID0gTUFYIF4gKFdSSVRFX0FDVElWRSB8IFdSSVRFX1dSSVRJTkcpCmNvbnN0IFdSSVRFX05PTl9QUklNQVJZICAgPSBNQVggXiBXUklURV9QUklNQVJZCmNvbnN0IFdSSVRFX05PVF9GSU5JU0hJTkcgPSBNQVggXiAoV1JJVEVfQUNUSVZFIHwgV1JJVEVfRklOSVNISU5HKQpjb25zdCBXUklURV9EUkFJTkVEICAgICAgID0gTUFYIF4gV1JJVEVfVU5EUkFJTkVECmNvbnN0IFdSSVRFX05PVF9RVUVVRUQgICAgPSBNQVggXiBXUklURV9RVUVVRUQKY29uc3QgV1JJVEVfTk9UX05FWFRfVElDSyA9IE1BWCBeIFdSSVRFX05FWFRfVElDSwpjb25zdCBXUklURV9OT1RfVVBEQVRJTkcgID0gTUFYIF4gV1JJVEVfVVBEQVRJTkcKY29uc3QgV1JJVEVfTk9UX0NPUktFRCAgICA9IE1BWCBeIFdSSVRFX0NPUktFRAoKLy8gQ29tYmluZWQgc2hhcmVkIHN0YXRlCmNvbnN0IEFDVElWRSA9IFJFQURfQUNUSVZFIHwgV1JJVEVfQUNUSVZFCmNvbnN0IE5PVF9BQ1RJVkUgPSBNQVggXiBBQ1RJVkUKY29uc3QgRE9ORSA9IFJFQURfRE9ORSB8IFdSSVRFX0RPTkUKY29uc3QgREVTVFJPWV9TVEFUVVMgPSBERVNUUk9ZSU5HIHwgREVTVFJPWUVEIHwgUFJFREVTVFJPWUlORwpjb25zdCBPUEVOX1NUQVRVUyA9IERFU1RST1lfU1RBVFVTIHwgT1BFTklORwpjb25zdCBBVVRPX0RFU1RST1kgPSBERVNUUk9ZX1NUQVRVUyB8IERPTkUKY29uc3QgTk9OX1BSSU1BUlkgPSBXUklURV9OT05fUFJJTUFSWSAmIFJFQURfTk9OX1BSSU1BUlkKY29uc3QgQUNUSVZFX09SX1RJQ0tJTkcgPSBXUklURV9ORVhUX1RJQ0sgfCBSRUFEX05FWFRfVElDSwpjb25zdCBUSUNLSU5HID0gQUNUSVZFX09SX1RJQ0tJTkcgJiBOT1RfQUNUSVZFCmNvbnN0IElTX09QRU5JTkcgPSBPUEVOX1NUQVRVUyB8IFRJQ0tJTkcKCi8vIENvbWJpbmVkIHNoYXJlZCBzdGF0ZSBhbmQgcmVhZCBzdGF0ZQpjb25zdCBSRUFEX1BSSU1BUllfU1RBVFVTID0gT1BFTl9TVEFUVVMgfCBSRUFEX0VORElORyB8IFJFQURfRE9ORQpjb25zdCBSRUFEX1NUQVRVUyA9IE9QRU5fU1RBVFVTIHwgUkVBRF9ET05FIHwgUkVBRF9RVUVVRUQKY29uc3QgUkVBRF9FTkRJTkdfU1RBVFVTID0gT1BFTl9TVEFUVVMgfCBSRUFEX0VORElORyB8IFJFQURfUVVFVUVECmNvbnN0IFJFQURfUkVBREFCTEVfU1RBVFVTID0gT1BFTl9TVEFUVVMgfCBSRUFEX0VNSVRfUkVBREFCTEUgfCBSRUFEX1FVRVVFRCB8IFJFQURfRU1JVFRFRF9SRUFEQUJMRQpjb25zdCBTSE9VTERfTk9UX1JFQUQgPSBPUEVOX1NUQVRVUyB8IFJFQURfQUNUSVZFIHwgUkVBRF9FTkRJTkcgfCBSRUFEX0RPTkUgfCBSRUFEX05FRURTX1BVU0ggfCBSRUFEX1JFQURfQUhFQUQKY29uc3QgUkVBRF9CQUNLUFJFU1NVUkVfU1RBVFVTID0gREVTVFJPWV9TVEFUVVMgfCBSRUFEX0VORElORyB8IFJFQURfRE9ORQpjb25zdCBSRUFEX1VQREFURV9TWU5DX1NUQVRVUyA9IFJFQURfVVBEQVRJTkcgfCBPUEVOX1NUQVRVUyB8IFJFQURfTkVYVF9USUNLIHwgUkVBRF9QUklNQVJZCmNvbnN0IFJFQURfTkVYVF9USUNLX09SX09QRU5JTkcgPSBSRUFEX05FWFRfVElDSyB8IE9QRU5JTkcKCi8vIENvbWJpbmVkIHdyaXRlIHN0YXRlCmNvbnN0IFdSSVRFX1BSSU1BUllfU1RBVFVTID0gT1BFTl9TVEFUVVMgfCBXUklURV9GSU5JU0hJTkcgfCBXUklURV9ET05FCmNvbnN0IFdSSVRFX1FVRVVFRF9BTkRfVU5EUkFJTkVEID0gV1JJVEVfUVVFVUVEIHwgV1JJVEVfVU5EUkFJTkVECmNvbnN0IFdSSVRFX1FVRVVFRF9BTkRfQUNUSVZFID0gV1JJVEVfUVVFVUVEIHwgV1JJVEVfQUNUSVZFCmNvbnN0IFdSSVRFX0RSQUlOX1NUQVRVUyA9IFdSSVRFX1FVRVVFRCB8IFdSSVRFX1VORFJBSU5FRCB8IE9QRU5fU1RBVFVTIHwgV1JJVEVfQUNUSVZFCmNvbnN0IFdSSVRFX1NUQVRVUyA9IE9QRU5fU1RBVFVTIHwgV1JJVEVfQUNUSVZFIHwgV1JJVEVfUVVFVUVEIHwgV1JJVEVfQ09SS0VECmNvbnN0IFdSSVRFX1BSSU1BUllfQU5EX0FDVElWRSA9IFdSSVRFX1BSSU1BUlkgfCBXUklURV9BQ1RJVkUKY29uc3QgV1JJVEVfQUNUSVZFX0FORF9XUklUSU5HID0gV1JJVEVfQUNUSVZFIHwgV1JJVEVfV1JJVElORwpjb25zdCBXUklURV9GSU5JU0hJTkdfU1RBVFVTID0gT1BFTl9TVEFUVVMgfCBXUklURV9GSU5JU0hJTkcgfCBXUklURV9RVUVVRURfQU5EX0FDVElWRSB8IFdSSVRFX0RPTkUKY29uc3QgV1JJVEVfQkFDS1BSRVNTVVJFX1NUQVRVUyA9IFdSSVRFX1VORFJBSU5FRCB8IERFU1RST1lfU1RBVFVTIHwgV1JJVEVfRklOSVNISU5HIHwgV1JJVEVfRE9ORQpjb25zdCBXUklURV9VUERBVEVfU1lOQ19TVEFUVVMgPSBXUklURV9VUERBVElORyB8IE9QRU5fU1RBVFVTIHwgV1JJVEVfTkVYVF9USUNLIHwgV1JJVEVfUFJJTUFSWQpjb25zdCBXUklURV9EUk9QX0RBVEEgPSBXUklURV9GSU5JU0hJTkcgfCBXUklURV9ET05FIHwgREVTVFJPWV9TVEFUVVMKCmNvbnN0IGFzeW5jSXRlcmF0b3IgPSBTeW1ib2wuYXN5bmNJdGVyYXRvciB8fCBTeW1ib2woJ2FzeW5jSXRlcmF0b3InKQoKY2xhc3MgV3JpdGFibGVTdGF0ZSB7CiAgY29uc3RydWN0b3IgKHN0cmVhbSwgeyBoaWdoV2F0ZXJNYXJrID0gMTYzODQsIG1hcCA9IG51bGwsIG1hcFdyaXRhYmxlLCBieXRlTGVuZ3RoLCBieXRlTGVuZ3RoV3JpdGFibGUgfSA9IHt9KSB7CiAgICB0aGlzLnN0cmVhbSA9IHN0cmVhbQogICAgdGhpcy5xdWV1ZSA9IG5ldyBGSUZPKCkKICAgIHRoaXMuaGlnaFdhdGVyTWFyayA9IGhpZ2hXYXRlck1hcmsKICAgIHRoaXMuYnVmZmVyZWQgPSAwCiAgICB0aGlzLmVycm9yID0gbnVsbAogICAgdGhpcy5waXBlbGluZSA9IG51bGwKICAgIHRoaXMuZHJhaW5zID0gbnVsbCAvLyBpZiB3ZSBhZGQgbW9yZSBzZWxkb21seSB1c2VkIGhlbHBlcnMgd2UgbWlnaHQgdGhlbSBpbnRvIGEgc3Vib2JqZWN0IHNvIGl0cyBhIHNpbmdsZSBwdHIKICAgIHRoaXMuYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGhXcml0YWJsZSB8fCBieXRlTGVuZ3RoIHx8IGRlZmF1bHRCeXRlTGVuZ3RoCiAgICB0aGlzLm1hcCA9IG1hcFdyaXRhYmxlIHx8IG1hcAogICAgdGhpcy5hZnRlcldyaXRlID0gYWZ0ZXJXcml0ZS5iaW5kKHRoaXMpCiAgICB0aGlzLmFmdGVyVXBkYXRlTmV4dFRpY2sgPSB1cGRhdGVXcml0ZU5ULmJpbmQodGhpcykKICB9CgogIGdldCBlbmRlZCAoKSB7CiAgICByZXR1cm4gKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX0RPTkUpICE9PSAwCiAgfQoKICBwdXNoIChkYXRhKSB7CiAgICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX0RST1BfREFUQSkgIT09IDApIHJldHVybiBmYWxzZQogICAgaWYgKHRoaXMubWFwICE9PSBudWxsKSBkYXRhID0gdGhpcy5tYXAoZGF0YSkKCiAgICB0aGlzLmJ1ZmZlcmVkICs9IHRoaXMuYnl0ZUxlbmd0aChkYXRhKQogICAgdGhpcy5xdWV1ZS5wdXNoKGRhdGEpCgogICAgaWYgKHRoaXMuYnVmZmVyZWQgPCB0aGlzLmhpZ2hXYXRlck1hcmspIHsKICAgICAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlIHw9IFdSSVRFX1FVRVVFRAogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9RVUVVRURfQU5EX1VORFJBSU5FRAogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBzaGlmdCAoKSB7CiAgICBjb25zdCBkYXRhID0gdGhpcy5xdWV1ZS5zaGlmdCgpCgogICAgdGhpcy5idWZmZXJlZCAtPSB0aGlzLmJ5dGVMZW5ndGgoZGF0YSkKICAgIGlmICh0aGlzLmJ1ZmZlcmVkID09PSAwKSB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gV1JJVEVfTk9UX1FVRVVFRAoKICAgIHJldHVybiBkYXRhCiAgfQoKICBlbmQgKGRhdGEpIHsKICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ2Z1bmN0aW9uJykgdGhpcy5zdHJlYW0ub25jZSgnZmluaXNoJywgZGF0YSkKICAgIGVsc2UgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCAmJiBkYXRhICE9PSBudWxsKSB0aGlzLnB1c2goZGF0YSkKICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSA9ICh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgfCBXUklURV9GSU5JU0hJTkcpICYgV1JJVEVfTk9OX1BSSU1BUlkKICB9CgogIGF1dG9CYXRjaCAoZGF0YSwgY2IpIHsKICAgIGNvbnN0IGJ1ZmZlciA9IFtdCiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQoKICAgIGJ1ZmZlci5wdXNoKGRhdGEpCiAgICB3aGlsZSAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9TVEFUVVMpID09PSBXUklURV9RVUVVRURfQU5EX0FDVElWRSkgewogICAgICBidWZmZXIucHVzaChzdHJlYW0uX3dyaXRhYmxlU3RhdGUuc2hpZnQoKSkKICAgIH0KCiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBPUEVOX1NUQVRVUykgIT09IDApIHJldHVybiBjYihudWxsKQogICAgc3RyZWFtLl93cml0ZXYoYnVmZmVyLCBjYikKICB9CgogIHVwZGF0ZSAoKSB7CiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQoKICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gV1JJVEVfVVBEQVRJTkcKCiAgICBkbyB7CiAgICAgIHdoaWxlICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX1NUQVRVUykgPT09IFdSSVRFX1FVRVVFRCkgewogICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLnNoaWZ0KCkKICAgICAgICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IFdSSVRFX0FDVElWRV9BTkRfV1JJVElORwogICAgICAgIHN0cmVhbS5fd3JpdGUoZGF0YSwgdGhpcy5hZnRlcldyaXRlKQogICAgICB9CgogICAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9QUklNQVJZX0FORF9BQ1RJVkUpID09PSAwKSB0aGlzLnVwZGF0ZU5vblByaW1hcnkoKQogICAgfSB3aGlsZSAodGhpcy5jb250aW51ZVVwZGF0ZSgpID09PSB0cnVlKQoKICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gV1JJVEVfTk9UX1VQREFUSU5HCiAgfQoKICB1cGRhdGVOb25QcmltYXJ5ICgpIHsKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCgogICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfRklOSVNISU5HX1NUQVRVUykgPT09IFdSSVRFX0ZJTklTSElORykgewogICAgICBzdHJlYW0uX2R1cGxleFN0YXRlID0gc3RyZWFtLl9kdXBsZXhTdGF0ZSB8IFdSSVRFX0FDVElWRQogICAgICBzdHJlYW0uX2ZpbmFsKGFmdGVyRmluYWwuYmluZCh0aGlzKSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgREVTVFJPWV9TVEFUVVMpID09PSBERVNUUk9ZSU5HKSB7CiAgICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIEFDVElWRV9PUl9USUNLSU5HKSA9PT0gMCkgewogICAgICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gQUNUSVZFCiAgICAgICAgc3RyZWFtLl9kZXN0cm95KGFmdGVyRGVzdHJveS5iaW5kKHRoaXMpKQogICAgICB9CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIElTX09QRU5JTkcpID09PSBPUEVOSU5HKSB7CiAgICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgPSAoc3RyZWFtLl9kdXBsZXhTdGF0ZSB8IEFDVElWRSkgJiBOT1RfT1BFTklORwogICAgICBzdHJlYW0uX29wZW4oYWZ0ZXJPcGVuLmJpbmQodGhpcykpCiAgICB9CiAgfQoKICBjb250aW51ZVVwZGF0ZSAoKSB7CiAgICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX05FWFRfVElDSykgPT09IDApIHJldHVybiBmYWxzZQogICAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICY9IFdSSVRFX05PVF9ORVhUX1RJQ0sKICAgIHJldHVybiB0cnVlCiAgfQoKICB1cGRhdGVDYWxsYmFjayAoKSB7CiAgICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX1VQREFURV9TWU5DX1NUQVRVUykgPT09IFdSSVRFX1BSSU1BUlkpIHRoaXMudXBkYXRlKCkKICAgIGVsc2UgdGhpcy51cGRhdGVOZXh0VGljaygpCiAgfQoKICB1cGRhdGVOZXh0VGljayAoKSB7CiAgICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX05FWFRfVElDSykgIT09IDApIHJldHVybgogICAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlIHw9IFdSSVRFX05FWFRfVElDSwogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9VUERBVElORykgPT09IDApIHFtdCh0aGlzLmFmdGVyVXBkYXRlTmV4dFRpY2spCiAgfQp9CgpjbGFzcyBSZWFkYWJsZVN0YXRlIHsKICBjb25zdHJ1Y3RvciAoc3RyZWFtLCB7IGhpZ2hXYXRlck1hcmsgPSAxNjM4NCwgbWFwID0gbnVsbCwgbWFwUmVhZGFibGUsIGJ5dGVMZW5ndGgsIGJ5dGVMZW5ndGhSZWFkYWJsZSB9ID0ge30pIHsKICAgIHRoaXMuc3RyZWFtID0gc3RyZWFtCiAgICB0aGlzLnF1ZXVlID0gbmV3IEZJRk8oKQogICAgdGhpcy5oaWdoV2F0ZXJNYXJrID0gaGlnaFdhdGVyTWFyayA9PT0gMCA/IDEgOiBoaWdoV2F0ZXJNYXJrCiAgICB0aGlzLmJ1ZmZlcmVkID0gMAogICAgdGhpcy5yZWFkQWhlYWQgPSBoaWdoV2F0ZXJNYXJrID4gMAogICAgdGhpcy5lcnJvciA9IG51bGwKICAgIHRoaXMucGlwZWxpbmUgPSBudWxsCiAgICB0aGlzLmJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoUmVhZGFibGUgfHwgYnl0ZUxlbmd0aCB8fCBkZWZhdWx0Qnl0ZUxlbmd0aAogICAgdGhpcy5tYXAgPSBtYXBSZWFkYWJsZSB8fCBtYXAKICAgIHRoaXMucGlwZVRvID0gbnVsbAogICAgdGhpcy5hZnRlclJlYWQgPSBhZnRlclJlYWQuYmluZCh0aGlzKQogICAgdGhpcy5hZnRlclVwZGF0ZU5leHRUaWNrID0gdXBkYXRlUmVhZE5ULmJpbmQodGhpcykKICB9CgogIGdldCBlbmRlZCAoKSB7CiAgICByZXR1cm4gKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfRE9ORSkgIT09IDAKICB9CgogIHBpcGUgKHBpcGVUbywgY2IpIHsKICAgIGlmICh0aGlzLnBpcGVUbyAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdDYW4gb25seSBwaXBlIHRvIG9uZSBkZXN0aW5hdGlvbicpCiAgICBpZiAodHlwZW9mIGNiICE9PSAnZnVuY3Rpb24nKSBjYiA9IG51bGwKCiAgICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gUkVBRF9QSVBFX0RSQUlORUQKICAgIHRoaXMucGlwZVRvID0gcGlwZVRvCiAgICB0aGlzLnBpcGVsaW5lID0gbmV3IFBpcGVsaW5lKHRoaXMuc3RyZWFtLCBwaXBlVG8sIGNiKQoKICAgIGlmIChjYikgdGhpcy5zdHJlYW0ub24oJ2Vycm9yJywgbm9vcCkgLy8gV2UgYWxyZWFkeSBlcnJvciBoYW5kbGUgdGhpcyBzbyBzdXByZXNzIGNyYXNoZXMKCiAgICBpZiAoaXNTdHJlYW14KHBpcGVUbykpIHsKICAgICAgcGlwZVRvLl93cml0YWJsZVN0YXRlLnBpcGVsaW5lID0gdGhpcy5waXBlbGluZQogICAgICBpZiAoY2IpIHBpcGVUby5vbignZXJyb3InLCBub29wKSAvLyBXZSBhbHJlYWR5IGVycm9yIGhhbmRsZSB0aGlzIHNvIHN1cHJlc3MgY3Jhc2hlcwogICAgICBwaXBlVG8ub24oJ2ZpbmlzaCcsIHRoaXMucGlwZWxpbmUuZmluaXNoZWQuYmluZCh0aGlzLnBpcGVsaW5lKSkgLy8gVE9ETzoganVzdCBjYWxsIGZpbmlzaGVkIGZyb20gcGlwZVRvIGl0c2VsZgogICAgfSBlbHNlIHsKICAgICAgY29uc3Qgb25lcnJvciA9IHRoaXMucGlwZWxpbmUuZG9uZS5iaW5kKHRoaXMucGlwZWxpbmUsIHBpcGVUbykKICAgICAgY29uc3Qgb25jbG9zZSA9IHRoaXMucGlwZWxpbmUuZG9uZS5iaW5kKHRoaXMucGlwZWxpbmUsIHBpcGVUbywgbnVsbCkgLy8gb25jbG9zZSBoYXMgYSB3ZWlyZCBib29sIGFyZwogICAgICBwaXBlVG8ub24oJ2Vycm9yJywgb25lcnJvcikKICAgICAgcGlwZVRvLm9uKCdjbG9zZScsIG9uY2xvc2UpCiAgICAgIHBpcGVUby5vbignZmluaXNoJywgdGhpcy5waXBlbGluZS5maW5pc2hlZC5iaW5kKHRoaXMucGlwZWxpbmUpKQogICAgfQoKICAgIHBpcGVUby5vbignZHJhaW4nLCBhZnRlckRyYWluLmJpbmQodGhpcykpCiAgICB0aGlzLnN0cmVhbS5lbWl0KCdwaXBpbmcnLCBwaXBlVG8pCiAgICBwaXBlVG8uZW1pdCgncGlwZScsIHRoaXMuc3RyZWFtKQogIH0KCiAgcHVzaCAoZGF0YSkgewogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgICBpZiAoZGF0YSA9PT0gbnVsbCkgewogICAgICB0aGlzLmhpZ2hXYXRlck1hcmsgPSAwCiAgICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgPSAoc3RyZWFtLl9kdXBsZXhTdGF0ZSB8IFJFQURfRU5ESU5HKSAmIFJFQURfTk9OX1BSSU1BUllfQU5EX1BVU0hFRAogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBpZiAodGhpcy5tYXAgIT09IG51bGwpIHsKICAgICAgZGF0YSA9IHRoaXMubWFwKGRhdGEpCiAgICAgIGlmIChkYXRhID09PSBudWxsKSB7CiAgICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBSRUFEX1BVU0hFRAogICAgICAgIHJldHVybiB0aGlzLmJ1ZmZlcmVkIDwgdGhpcy5oaWdoV2F0ZXJNYXJrCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmJ1ZmZlcmVkICs9IHRoaXMuYnl0ZUxlbmd0aChkYXRhKQogICAgdGhpcy5xdWV1ZS5wdXNoKGRhdGEpCgogICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSA9IChzdHJlYW0uX2R1cGxleFN0YXRlIHwgUkVBRF9RVUVVRUQpICYgUkVBRF9QVVNIRUQKCiAgICByZXR1cm4gdGhpcy5idWZmZXJlZCA8IHRoaXMuaGlnaFdhdGVyTWFyawogIH0KCiAgc2hpZnQgKCkgewogICAgY29uc3QgZGF0YSA9IHRoaXMucXVldWUuc2hpZnQoKQoKICAgIHRoaXMuYnVmZmVyZWQgLT0gdGhpcy5ieXRlTGVuZ3RoKGRhdGEpCiAgICBpZiAodGhpcy5idWZmZXJlZCA9PT0gMCkgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICY9IFJFQURfTk9UX1FVRVVFRAogICAgcmV0dXJuIGRhdGEKICB9CgogIHVuc2hpZnQgKGRhdGEpIHsKICAgIGNvbnN0IHBlbmRpbmcgPSBbdGhpcy5tYXAgIT09IG51bGwgPyB0aGlzLm1hcChkYXRhKSA6IGRhdGFdCiAgICB3aGlsZSAodGhpcy5idWZmZXJlZCA+IDApIHBlbmRpbmcucHVzaCh0aGlzLnNoaWZ0KCkpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwZW5kaW5nLmxlbmd0aCAtIDE7IGkrKykgewogICAgICBjb25zdCBkYXRhID0gcGVuZGluZ1tpXQogICAgICB0aGlzLmJ1ZmZlcmVkICs9IHRoaXMuYnl0ZUxlbmd0aChkYXRhKQogICAgICB0aGlzLnF1ZXVlLnB1c2goZGF0YSkKICAgIH0KCiAgICB0aGlzLnB1c2gocGVuZGluZ1twZW5kaW5nLmxlbmd0aCAtIDFdKQogIH0KCiAgcmVhZCAoKSB7CiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQoKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfU1RBVFVTKSA9PT0gUkVBRF9RVUVVRUQpIHsKICAgICAgY29uc3QgZGF0YSA9IHRoaXMuc2hpZnQoKQogICAgICBpZiAodGhpcy5waXBlVG8gIT09IG51bGwgJiYgdGhpcy5waXBlVG8ud3JpdGUoZGF0YSkgPT09IGZhbHNlKSBzdHJlYW0uX2R1cGxleFN0YXRlICY9IFJFQURfUElQRV9OT1RfRFJBSU5FRAogICAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX0VNSVRfREFUQSkgIT09IDApIHN0cmVhbS5lbWl0KCdkYXRhJywgZGF0YSkKICAgICAgcmV0dXJuIGRhdGEKICAgIH0KCiAgICBpZiAodGhpcy5yZWFkQWhlYWQgPT09IGZhbHNlKSB7CiAgICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gUkVBRF9SRUFEX0FIRUFECiAgICAgIHRoaXMudXBkYXRlTmV4dFRpY2soKQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBkcmFpbiAoKSB7CiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQoKICAgIHdoaWxlICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfU1RBVFVTKSA9PT0gUkVBRF9RVUVVRUQgJiYgKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX0ZMT1dJTkcpICE9PSAwKSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLnNoaWZ0KCkKICAgICAgaWYgKHRoaXMucGlwZVRvICE9PSBudWxsICYmIHRoaXMucGlwZVRvLndyaXRlKGRhdGEpID09PSBmYWxzZSkgc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBSRUFEX1BJUEVfTk9UX0RSQUlORUQKICAgICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9FTUlUX0RBVEEpICE9PSAwKSBzdHJlYW0uZW1pdCgnZGF0YScsIGRhdGEpCiAgICB9CiAgfQoKICB1cGRhdGUgKCkgewogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IFJFQURfVVBEQVRJTkcKCiAgICBkbyB7CiAgICAgIHRoaXMuZHJhaW4oKQoKICAgICAgd2hpbGUgKHRoaXMuYnVmZmVyZWQgPCB0aGlzLmhpZ2hXYXRlck1hcmsgJiYgKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBTSE9VTERfTk9UX1JFQUQpID09PSBSRUFEX1JFQURfQUhFQUQpIHsKICAgICAgICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IFJFQURfQUNUSVZFX0FORF9ORUVEU19QVVNICiAgICAgICAgc3RyZWFtLl9yZWFkKHRoaXMuYWZ0ZXJSZWFkKQogICAgICAgIHRoaXMuZHJhaW4oKQogICAgICB9CgogICAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1JFQURBQkxFX1NUQVRVUykgPT09IFJFQURfRU1JVF9SRUFEQUJMRV9BTkRfUVVFVUVEKSB7CiAgICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX0VNSVRURURfUkVBREFCTEUKICAgICAgICBzdHJlYW0uZW1pdCgncmVhZGFibGUnKQogICAgICB9CgogICAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1BSSU1BUllfQU5EX0FDVElWRSkgPT09IDApIHRoaXMudXBkYXRlTm9uUHJpbWFyeSgpCiAgICB9IHdoaWxlICh0aGlzLmNvbnRpbnVlVXBkYXRlKCkgPT09IHRydWUpCgogICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBSRUFEX05PVF9VUERBVElORwogIH0KCiAgdXBkYXRlTm9uUHJpbWFyeSAoKSB7CiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQoKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfRU5ESU5HX1NUQVRVUykgPT09IFJFQURfRU5ESU5HKSB7CiAgICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgPSAoc3RyZWFtLl9kdXBsZXhTdGF0ZSB8IFJFQURfRE9ORSkgJiBSRUFEX05PVF9FTkRJTkcKICAgICAgc3RyZWFtLmVtaXQoJ2VuZCcpCiAgICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIEFVVE9fREVTVFJPWSkgPT09IERPTkUpIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gREVTVFJPWUlORwogICAgICBpZiAodGhpcy5waXBlVG8gIT09IG51bGwpIHRoaXMucGlwZVRvLmVuZCgpCiAgICB9CgogICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgREVTVFJPWV9TVEFUVVMpID09PSBERVNUUk9ZSU5HKSB7CiAgICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIEFDVElWRV9PUl9USUNLSU5HKSA9PT0gMCkgewogICAgICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gQUNUSVZFCiAgICAgICAgc3RyZWFtLl9kZXN0cm95KGFmdGVyRGVzdHJveS5iaW5kKHRoaXMpKQogICAgICB9CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIElTX09QRU5JTkcpID09PSBPUEVOSU5HKSB7CiAgICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgPSAoc3RyZWFtLl9kdXBsZXhTdGF0ZSB8IEFDVElWRSkgJiBOT1RfT1BFTklORwogICAgICBzdHJlYW0uX29wZW4oYWZ0ZXJPcGVuLmJpbmQodGhpcykpCiAgICB9CiAgfQoKICBjb250aW51ZVVwZGF0ZSAoKSB7CiAgICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfTkVYVF9USUNLKSA9PT0gMCkgcmV0dXJuIGZhbHNlCiAgICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gUkVBRF9OT1RfTkVYVF9USUNLCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgdXBkYXRlQ2FsbGJhY2sgKCkgewogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1VQREFURV9TWU5DX1NUQVRVUykgPT09IFJFQURfUFJJTUFSWSkgdGhpcy51cGRhdGUoKQogICAgZWxzZSB0aGlzLnVwZGF0ZU5leHRUaWNrKCkKICB9CgogIHVwZGF0ZU5leHRUaWNrSWZPcGVuICgpIHsKICAgIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9ORVhUX1RJQ0tfT1JfT1BFTklORykgIT09IDApIHJldHVybgogICAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlIHw9IFJFQURfTkVYVF9USUNLCiAgICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfVVBEQVRJTkcpID09PSAwKSBxbXQodGhpcy5hZnRlclVwZGF0ZU5leHRUaWNrKQogIH0KCiAgdXBkYXRlTmV4dFRpY2sgKCkgewogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX05FWFRfVElDSykgIT09IDApIHJldHVybgogICAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlIHw9IFJFQURfTkVYVF9USUNLCiAgICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfVVBEQVRJTkcpID09PSAwKSBxbXQodGhpcy5hZnRlclVwZGF0ZU5leHRUaWNrKQogIH0KfQoKY2xhc3MgVHJhbnNmb3JtU3RhdGUgewogIGNvbnN0cnVjdG9yIChzdHJlYW0pIHsKICAgIHRoaXMuZGF0YSA9IG51bGwKICAgIHRoaXMuYWZ0ZXJUcmFuc2Zvcm0gPSBhZnRlclRyYW5zZm9ybS5iaW5kKHN0cmVhbSkKICAgIHRoaXMuYWZ0ZXJGaW5hbCA9IG51bGwKICB9Cn0KCmNsYXNzIFBpcGVsaW5lIHsKICBjb25zdHJ1Y3RvciAoc3JjLCBkc3QsIGNiKSB7CiAgICB0aGlzLmZyb20gPSBzcmMKICAgIHRoaXMudG8gPSBkc3QKICAgIHRoaXMuYWZ0ZXJQaXBlID0gY2IKICAgIHRoaXMuZXJyb3IgPSBudWxsCiAgICB0aGlzLnBpcGVUb0ZpbmlzaGVkID0gZmFsc2UKICB9CgogIGZpbmlzaGVkICgpIHsKICAgIHRoaXMucGlwZVRvRmluaXNoZWQgPSB0cnVlCiAgfQoKICBkb25lIChzdHJlYW0sIGVycikgewogICAgaWYgKGVycikgdGhpcy5lcnJvciA9IGVycgoKICAgIGlmIChzdHJlYW0gPT09IHRoaXMudG8pIHsKICAgICAgdGhpcy50byA9IG51bGwKCiAgICAgIGlmICh0aGlzLmZyb20gIT09IG51bGwpIHsKICAgICAgICBpZiAoKHRoaXMuZnJvbS5fZHVwbGV4U3RhdGUgJiBSRUFEX0RPTkUpID09PSAwIHx8ICF0aGlzLnBpcGVUb0ZpbmlzaGVkKSB7CiAgICAgICAgICB0aGlzLmZyb20uZGVzdHJveSh0aGlzLmVycm9yIHx8IG5ldyBFcnJvcignV3JpdGFibGUgc3RyZWFtIGNsb3NlZCBwcmVtYXR1cmVseScpKQogICAgICAgIH0KICAgICAgICByZXR1cm4KICAgICAgfQogICAgfQoKICAgIGlmIChzdHJlYW0gPT09IHRoaXMuZnJvbSkgewogICAgICB0aGlzLmZyb20gPSBudWxsCgogICAgICBpZiAodGhpcy50byAhPT0gbnVsbCkgewogICAgICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfRE9ORSkgPT09IDApIHsKICAgICAgICAgIHRoaXMudG8uZGVzdHJveSh0aGlzLmVycm9yIHx8IG5ldyBFcnJvcignUmVhZGFibGUgc3RyZWFtIGNsb3NlZCBiZWZvcmUgZW5kaW5nJykpCiAgICAgICAgfQogICAgICAgIHJldHVybgogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMuYWZ0ZXJQaXBlICE9PSBudWxsKSB0aGlzLmFmdGVyUGlwZSh0aGlzLmVycm9yKQogICAgdGhpcy50byA9IHRoaXMuZnJvbSA9IHRoaXMuYWZ0ZXJQaXBlID0gbnVsbAogIH0KfQoKZnVuY3Rpb24gYWZ0ZXJEcmFpbiAoKSB7CiAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlIHw9IFJFQURfUElQRV9EUkFJTkVECiAgdGhpcy51cGRhdGVDYWxsYmFjaygpCn0KCmZ1bmN0aW9uIGFmdGVyRmluYWwgKGVycikgewogIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCiAgaWYgKGVycikgc3RyZWFtLmRlc3Ryb3koZXJyKQogIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIERFU1RST1lfU1RBVFVTKSA9PT0gMCkgewogICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9ET05FCiAgICBzdHJlYW0uZW1pdCgnZmluaXNoJykKICB9CiAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgQVVUT19ERVNUUk9ZKSA9PT0gRE9ORSkgewogICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBERVNUUk9ZSU5HCiAgfQoKICBzdHJlYW0uX2R1cGxleFN0YXRlICY9IFdSSVRFX05PVF9GSU5JU0hJTkcKCiAgLy8gbm8gbmVlZCB0byB3YWl0IHRoZSBleHRyYSB0aWNrIGhlcmUsIHNvIHdlIHNob3J0IGNpcmN1aXQgdGhhdAogIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX1VQREFUSU5HKSA9PT0gMCkgdGhpcy51cGRhdGUoKQogIGVsc2UgdGhpcy51cGRhdGVOZXh0VGljaygpCn0KCmZ1bmN0aW9uIGFmdGVyRGVzdHJveSAoZXJyKSB7CiAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgaWYgKCFlcnIgJiYgdGhpcy5lcnJvciAhPT0gU1RSRUFNX0RFU1RST1lFRCkgZXJyID0gdGhpcy5lcnJvcgogIGlmIChlcnIpIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycikKICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IERFU1RST1lFRAogIHN0cmVhbS5lbWl0KCdjbG9zZScpCgogIGNvbnN0IHJzID0gc3RyZWFtLl9yZWFkYWJsZVN0YXRlCiAgY29uc3Qgd3MgPSBzdHJlYW0uX3dyaXRhYmxlU3RhdGUKCiAgaWYgKHJzICE9PSBudWxsICYmIHJzLnBpcGVsaW5lICE9PSBudWxsKSBycy5waXBlbGluZS5kb25lKHN0cmVhbSwgZXJyKQoKICBpZiAod3MgIT09IG51bGwpIHsKICAgIHdoaWxlICh3cy5kcmFpbnMgIT09IG51bGwgJiYgd3MuZHJhaW5zLmxlbmd0aCA+IDApIHdzLmRyYWlucy5zaGlmdCgpLnJlc29sdmUoZmFsc2UpCiAgICBpZiAod3MucGlwZWxpbmUgIT09IG51bGwpIHdzLnBpcGVsaW5lLmRvbmUoc3RyZWFtLCBlcnIpCiAgfQp9CgpmdW5jdGlvbiBhZnRlcldyaXRlIChlcnIpIHsKICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQoKICBpZiAoZXJyKSBzdHJlYW0uZGVzdHJveShlcnIpCiAgc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBXUklURV9OT1RfQUNUSVZFCgogIGlmICh0aGlzLmRyYWlucyAhPT0gbnVsbCkgdGlja0RyYWlucyh0aGlzLmRyYWlucykKCiAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfRFJBSU5fU1RBVFVTKSA9PT0gV1JJVEVfVU5EUkFJTkVEKSB7CiAgICBzdHJlYW0uX2R1cGxleFN0YXRlICY9IFdSSVRFX0RSQUlORUQKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX0VNSVRfRFJBSU4pID09PSBXUklURV9FTUlUX0RSQUlOKSB7CiAgICAgIHN0cmVhbS5lbWl0KCdkcmFpbicpCiAgICB9CiAgfQoKICB0aGlzLnVwZGF0ZUNhbGxiYWNrKCkKfQoKZnVuY3Rpb24gYWZ0ZXJSZWFkIChlcnIpIHsKICBpZiAoZXJyKSB0aGlzLnN0cmVhbS5kZXN0cm95KGVycikKICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gUkVBRF9OT1RfQUNUSVZFCiAgaWYgKHRoaXMucmVhZEFoZWFkID09PSBmYWxzZSAmJiAodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9SRVNVTUVEKSA9PT0gMCkgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICY9IFJFQURfTk9fUkVBRF9BSEVBRAogIHRoaXMudXBkYXRlQ2FsbGJhY2soKQp9CgpmdW5jdGlvbiB1cGRhdGVSZWFkTlQgKCkgewogIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9VUERBVElORykgPT09IDApIHsKICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBSRUFEX05PVF9ORVhUX1RJQ0sKICAgIHRoaXMudXBkYXRlKCkKICB9Cn0KCmZ1bmN0aW9uIHVwZGF0ZVdyaXRlTlQgKCkgewogIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfVVBEQVRJTkcpID09PSAwKSB7CiAgICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gV1JJVEVfTk9UX05FWFRfVElDSwogICAgdGhpcy51cGRhdGUoKQogIH0KfQoKZnVuY3Rpb24gdGlja0RyYWlucyAoZHJhaW5zKSB7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBkcmFpbnMubGVuZ3RoOyBpKyspIHsKICAgIC8vIGRyYWlucy53cml0ZXMgYXJlIG1vbm90b25pYywgc28gaWYgb25lIGlzIDAgaXRzIGFsd2F5cyB0aGUgZmlyc3Qgb25lCiAgICBpZiAoLS1kcmFpbnNbaV0ud3JpdGVzID09PSAwKSB7CiAgICAgIGRyYWlucy5zaGlmdCgpLnJlc29sdmUodHJ1ZSkKICAgICAgaS0tCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBhZnRlck9wZW4gKGVycikgewogIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCgogIGlmIChlcnIpIHN0cmVhbS5kZXN0cm95KGVycikKCiAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgREVTVFJPWUlORykgPT09IDApIHsKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfUFJJTUFSWV9TVEFUVVMpID09PSAwKSBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IFJFQURfUFJJTUFSWQogICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfUFJJTUFSWV9TVEFUVVMpID09PSAwKSBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IFdSSVRFX1BSSU1BUlkKICAgIHN0cmVhbS5lbWl0KCdvcGVuJykKICB9CgogIHN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gTk9UX0FDVElWRQoKICBpZiAoc3RyZWFtLl93cml0YWJsZVN0YXRlICE9PSBudWxsKSB7CiAgICBzdHJlYW0uX3dyaXRhYmxlU3RhdGUudXBkYXRlQ2FsbGJhY2soKQogIH0KCiAgaWYgKHN0cmVhbS5fcmVhZGFibGVTdGF0ZSAhPT0gbnVsbCkgewogICAgc3RyZWFtLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZUNhbGxiYWNrKCkKICB9Cn0KCmZ1bmN0aW9uIGFmdGVyVHJhbnNmb3JtIChlcnIsIGRhdGEpIHsKICBpZiAoZGF0YSAhPT0gdW5kZWZpbmVkICYmIGRhdGEgIT09IG51bGwpIHRoaXMucHVzaChkYXRhKQogIHRoaXMuX3dyaXRhYmxlU3RhdGUuYWZ0ZXJXcml0ZShlcnIpCn0KCmZ1bmN0aW9uIG5ld0xpc3RlbmVyIChuYW1lKSB7CiAgaWYgKHRoaXMuX3JlYWRhYmxlU3RhdGUgIT09IG51bGwpIHsKICAgIGlmIChuYW1lID09PSAnZGF0YScpIHsKICAgICAgdGhpcy5fZHVwbGV4U3RhdGUgfD0gKFJFQURfRU1JVF9EQVRBIHwgUkVBRF9SRVNVTUVEX1JFQURfQUhFQUQpCiAgICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgfQogICAgaWYgKG5hbWUgPT09ICdyZWFkYWJsZScpIHsKICAgICAgdGhpcy5fZHVwbGV4U3RhdGUgfD0gUkVBRF9FTUlUX1JFQURBQkxFCiAgICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgfQogIH0KCiAgaWYgKHRoaXMuX3dyaXRhYmxlU3RhdGUgIT09IG51bGwpIHsKICAgIGlmIChuYW1lID09PSAnZHJhaW4nKSB7CiAgICAgIHRoaXMuX2R1cGxleFN0YXRlIHw9IFdSSVRFX0VNSVRfRFJBSU4KICAgICAgdGhpcy5fd3JpdGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICB9CiAgfQp9CgpjbGFzcyBTdHJlYW0gZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yIChvcHRzKSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5fZHVwbGV4U3RhdGUgPSAwCiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlID0gbnVsbAogICAgdGhpcy5fd3JpdGFibGVTdGF0ZSA9IG51bGwKCiAgICBpZiAob3B0cykgewogICAgICBpZiAob3B0cy5vcGVuKSB0aGlzLl9vcGVuID0gb3B0cy5vcGVuCiAgICAgIGlmIChvcHRzLmRlc3Ryb3kpIHRoaXMuX2Rlc3Ryb3kgPSBvcHRzLmRlc3Ryb3kKICAgICAgaWYgKG9wdHMucHJlZGVzdHJveSkgdGhpcy5fcHJlZGVzdHJveSA9IG9wdHMucHJlZGVzdHJveQogICAgICBpZiAob3B0cy5zaWduYWwpIHsKICAgICAgICBvcHRzLnNpZ25hbC5hZGRFdmVudExpc3RlbmVyKCdhYm9ydCcsIGFib3J0LmJpbmQodGhpcykpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLm9uKCduZXdMaXN0ZW5lcicsIG5ld0xpc3RlbmVyKQogIH0KCiAgX29wZW4gKGNiKSB7CiAgICBjYihudWxsKQogIH0KCiAgX2Rlc3Ryb3kgKGNiKSB7CiAgICBjYihudWxsKQogIH0KCiAgX3ByZWRlc3Ryb3kgKCkgewogICAgLy8gZG9lcyBub3RoaW5nCiAgfQoKICBnZXQgcmVhZGFibGUgKCkgewogICAgcmV0dXJuIHRoaXMuX3JlYWRhYmxlU3RhdGUgIT09IG51bGwgPyB0cnVlIDogdW5kZWZpbmVkCiAgfQoKICBnZXQgd3JpdGFibGUgKCkgewogICAgcmV0dXJuIHRoaXMuX3dyaXRhYmxlU3RhdGUgIT09IG51bGwgPyB0cnVlIDogdW5kZWZpbmVkCiAgfQoKICBnZXQgZGVzdHJveWVkICgpIHsKICAgIHJldHVybiAodGhpcy5fZHVwbGV4U3RhdGUgJiBERVNUUk9ZRUQpICE9PSAwCiAgfQoKICBnZXQgZGVzdHJveWluZyAoKSB7CiAgICByZXR1cm4gKHRoaXMuX2R1cGxleFN0YXRlICYgREVTVFJPWV9TVEFUVVMpICE9PSAwCiAgfQoKICBkZXN0cm95IChlcnIpIHsKICAgIGlmICgodGhpcy5fZHVwbGV4U3RhdGUgJiBERVNUUk9ZX1NUQVRVUykgPT09IDApIHsKICAgICAgaWYgKCFlcnIpIGVyciA9IFNUUkVBTV9ERVNUUk9ZRUQKICAgICAgdGhpcy5fZHVwbGV4U3RhdGUgPSAodGhpcy5fZHVwbGV4U3RhdGUgfCBERVNUUk9ZSU5HKSAmIE5PTl9QUklNQVJZCgogICAgICBpZiAodGhpcy5fcmVhZGFibGVTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUuaGlnaFdhdGVyTWFyayA9IDAKICAgICAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLmVycm9yID0gZXJyCiAgICAgIH0KICAgICAgaWYgKHRoaXMuX3dyaXRhYmxlU3RhdGUgIT09IG51bGwpIHsKICAgICAgICB0aGlzLl93cml0YWJsZVN0YXRlLmhpZ2hXYXRlck1hcmsgPSAwCiAgICAgICAgdGhpcy5fd3JpdGFibGVTdGF0ZS5lcnJvciA9IGVycgogICAgICB9CgogICAgICB0aGlzLl9kdXBsZXhTdGF0ZSB8PSBQUkVERVNUUk9ZSU5HCiAgICAgIHRoaXMuX3ByZWRlc3Ryb3koKQogICAgICB0aGlzLl9kdXBsZXhTdGF0ZSAmPSBOT1RfUFJFREVTVFJPWUlORwoKICAgICAgaWYgKHRoaXMuX3JlYWRhYmxlU3RhdGUgIT09IG51bGwpIHRoaXMuX3JlYWRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgICBpZiAodGhpcy5fd3JpdGFibGVTdGF0ZSAhPT0gbnVsbCkgdGhpcy5fd3JpdGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICB9CiAgfQp9CgpjbGFzcyBSZWFkYWJsZSBleHRlbmRzIFN0cmVhbSB7CiAgY29uc3RydWN0b3IgKG9wdHMpIHsKICAgIHN1cGVyKG9wdHMpCgogICAgdGhpcy5fZHVwbGV4U3RhdGUgfD0gT1BFTklORyB8IFdSSVRFX0RPTkUgfCBSRUFEX1JFQURfQUhFQUQKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUgPSBuZXcgUmVhZGFibGVTdGF0ZSh0aGlzLCBvcHRzKQoKICAgIGlmIChvcHRzKSB7CiAgICAgIGlmICh0aGlzLl9yZWFkYWJsZVN0YXRlLnJlYWRBaGVhZCA9PT0gZmFsc2UpIHRoaXMuX2R1cGxleFN0YXRlICY9IFJFQURfTk9fUkVBRF9BSEVBRAogICAgICBpZiAob3B0cy5yZWFkKSB0aGlzLl9yZWFkID0gb3B0cy5yZWFkCiAgICAgIGlmIChvcHRzLmVhZ2VyT3BlbikgdGhpcy5fcmVhZGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICAgIGlmIChvcHRzLmVuY29kaW5nKSB0aGlzLnNldEVuY29kaW5nKG9wdHMuZW5jb2RpbmcpCiAgICB9CiAgfQoKICBzZXRFbmNvZGluZyAoZW5jb2RpbmcpIHsKICAgIGNvbnN0IGRlYyA9IG5ldyBUZXh0RGVjb2RlcihlbmNvZGluZykKICAgIGNvbnN0IG1hcCA9IHRoaXMuX3JlYWRhYmxlU3RhdGUubWFwIHx8IGVjaG8KICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUubWFwID0gbWFwT3JTa2lwCiAgICByZXR1cm4gdGhpcwoKICAgIGZ1bmN0aW9uIG1hcE9yU2tpcCAoZGF0YSkgewogICAgICBjb25zdCBuZXh0ID0gZGVjLnB1c2goZGF0YSkKICAgICAgcmV0dXJuIG5leHQgPT09ICcnICYmIChkYXRhLmJ5dGVMZW5ndGggIT09IDAgfHwgZGVjLnJlbWFpbmluZyA+IDApID8gbnVsbCA6IG1hcChuZXh0KQogICAgfQogIH0KCiAgX3JlYWQgKGNiKSB7CiAgICBjYihudWxsKQogIH0KCiAgcGlwZSAoZGVzdCwgY2IpIHsKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgdGhpcy5fcmVhZGFibGVTdGF0ZS5waXBlKGRlc3QsIGNiKQogICAgcmV0dXJuIGRlc3QKICB9CgogIHJlYWQgKCkgewogICAgdGhpcy5fcmVhZGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICByZXR1cm4gdGhpcy5fcmVhZGFibGVTdGF0ZS5yZWFkKCkKICB9CgogIHB1c2ggKGRhdGEpIHsKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2tJZk9wZW4oKQogICAgcmV0dXJuIHRoaXMuX3JlYWRhYmxlU3RhdGUucHVzaChkYXRhKQogIH0KCiAgdW5zaGlmdCAoZGF0YSkgewogICAgdGhpcy5fcmVhZGFibGVTdGF0ZS51cGRhdGVOZXh0VGlja0lmT3BlbigpCiAgICByZXR1cm4gdGhpcy5fcmVhZGFibGVTdGF0ZS51bnNoaWZ0KGRhdGEpCiAgfQoKICByZXN1bWUgKCkgewogICAgdGhpcy5fZHVwbGV4U3RhdGUgfD0gUkVBRF9SRVNVTUVEX1JFQURfQUhFQUQKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgcmV0dXJuIHRoaXMKICB9CgogIHBhdXNlICgpIHsKICAgIHRoaXMuX2R1cGxleFN0YXRlICY9ICh0aGlzLl9yZWFkYWJsZVN0YXRlLnJlYWRBaGVhZCA9PT0gZmFsc2UgPyBSRUFEX1BBVVNFRF9OT19SRUFEX0FIRUFEIDogUkVBRF9QQVVTRUQpCiAgICByZXR1cm4gdGhpcwogIH0KCiAgc3RhdGljIF9mcm9tQXN5bmNJdGVyYXRvciAoaXRlLCBvcHRzKSB7CiAgICBsZXQgZGVzdHJveQoKICAgIGNvbnN0IHJzID0gbmV3IFJlYWRhYmxlKHsKICAgICAgLi4ub3B0cywKICAgICAgcmVhZCAoY2IpIHsKICAgICAgICBpdGUubmV4dCgpLnRoZW4ocHVzaCkudGhlbihjYi5iaW5kKG51bGwsIG51bGwpKS5jYXRjaChjYikKICAgICAgfSwKICAgICAgcHJlZGVzdHJveSAoKSB7CiAgICAgICAgZGVzdHJveSA9IGl0ZS5yZXR1cm4oKQogICAgICB9LAogICAgICBkZXN0cm95IChjYikgewogICAgICAgIGlmICghZGVzdHJveSkgcmV0dXJuIGNiKG51bGwpCiAgICAgICAgZGVzdHJveS50aGVuKGNiLmJpbmQobnVsbCwgbnVsbCkpLmNhdGNoKGNiKQogICAgICB9CiAgICB9KQoKICAgIHJldHVybiBycwoKICAgIGZ1bmN0aW9uIHB1c2ggKGRhdGEpIHsKICAgICAgaWYgKGRhdGEuZG9uZSkgcnMucHVzaChudWxsKQogICAgICBlbHNlIHJzLnB1c2goZGF0YS52YWx1ZSkKICAgIH0KICB9CgogIHN0YXRpYyBmcm9tIChkYXRhLCBvcHRzKSB7CiAgICBpZiAoaXNSZWFkU3RyZWFteChkYXRhKSkgcmV0dXJuIGRhdGEKICAgIGlmIChkYXRhW2FzeW5jSXRlcmF0b3JdKSByZXR1cm4gdGhpcy5fZnJvbUFzeW5jSXRlcmF0b3IoZGF0YVthc3luY0l0ZXJhdG9yXSgpLCBvcHRzKQogICAgaWYgKCFBcnJheS5pc0FycmF5KGRhdGEpKSBkYXRhID0gZGF0YSA9PT0gdW5kZWZpbmVkID8gW10gOiBbZGF0YV0KCiAgICBsZXQgaSA9IDAKICAgIHJldHVybiBuZXcgUmVhZGFibGUoewogICAgICAuLi5vcHRzLAogICAgICByZWFkIChjYikgewogICAgICAgIHRoaXMucHVzaChpID09PSBkYXRhLmxlbmd0aCA/IG51bGwgOiBkYXRhW2krK10pCiAgICAgICAgY2IobnVsbCkKICAgICAgfQogICAgfSkKICB9CgogIHN0YXRpYyBpc0JhY2twcmVzc3VyZWQgKHJzKSB7CiAgICByZXR1cm4gKHJzLl9kdXBsZXhTdGF0ZSAmIFJFQURfQkFDS1BSRVNTVVJFX1NUQVRVUykgIT09IDAgfHwgcnMuX3JlYWRhYmxlU3RhdGUuYnVmZmVyZWQgPj0gcnMuX3JlYWRhYmxlU3RhdGUuaGlnaFdhdGVyTWFyawogIH0KCiAgc3RhdGljIGlzUGF1c2VkIChycykgewogICAgcmV0dXJuIChycy5fZHVwbGV4U3RhdGUgJiBSRUFEX1JFU1VNRUQpID09PSAwCiAgfQoKICBbYXN5bmNJdGVyYXRvcl0gKCkgewogICAgY29uc3Qgc3RyZWFtID0gdGhpcwoKICAgIGxldCBlcnJvciA9IG51bGwKICAgIGxldCBwcm9taXNlUmVzb2x2ZSA9IG51bGwKICAgIGxldCBwcm9taXNlUmVqZWN0ID0gbnVsbAoKICAgIHRoaXMub24oJ2Vycm9yJywgKGVycikgPT4geyBlcnJvciA9IGVyciB9KQogICAgdGhpcy5vbigncmVhZGFibGUnLCBvbnJlYWRhYmxlKQogICAgdGhpcy5vbignY2xvc2UnLCBvbmNsb3NlKQoKICAgIHJldHVybiB7CiAgICAgIFthc3luY0l0ZXJhdG9yXSAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMKICAgICAgfSwKICAgICAgbmV4dCAoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIHByb21pc2VSZXNvbHZlID0gcmVzb2x2ZQogICAgICAgICAgcHJvbWlzZVJlamVjdCA9IHJlamVjdAogICAgICAgICAgY29uc3QgZGF0YSA9IHN0cmVhbS5yZWFkKCkKICAgICAgICAgIGlmIChkYXRhICE9PSBudWxsKSBvbmRhdGEoZGF0YSkKICAgICAgICAgIGVsc2UgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgREVTVFJPWUVEKSAhPT0gMCkgb25kYXRhKG51bGwpCiAgICAgICAgfSkKICAgICAgfSwKICAgICAgcmV0dXJuICgpIHsKICAgICAgICByZXR1cm4gZGVzdHJveShudWxsKQogICAgICB9LAogICAgICB0aHJvdyAoZXJyKSB7CiAgICAgICAgcmV0dXJuIGRlc3Ryb3koZXJyKQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gb25yZWFkYWJsZSAoKSB7CiAgICAgIGlmIChwcm9taXNlUmVzb2x2ZSAhPT0gbnVsbCkgb25kYXRhKHN0cmVhbS5yZWFkKCkpCiAgICB9CgogICAgZnVuY3Rpb24gb25jbG9zZSAoKSB7CiAgICAgIGlmIChwcm9taXNlUmVzb2x2ZSAhPT0gbnVsbCkgb25kYXRhKG51bGwpCiAgICB9CgogICAgZnVuY3Rpb24gb25kYXRhIChkYXRhKSB7CiAgICAgIGlmIChwcm9taXNlUmVqZWN0ID09PSBudWxsKSByZXR1cm4KICAgICAgaWYgKGVycm9yKSBwcm9taXNlUmVqZWN0KGVycm9yKQogICAgICBlbHNlIGlmIChkYXRhID09PSBudWxsICYmIChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9ET05FKSA9PT0gMCkgcHJvbWlzZVJlamVjdChTVFJFQU1fREVTVFJPWUVEKQogICAgICBlbHNlIHByb21pc2VSZXNvbHZlKHsgdmFsdWU6IGRhdGEsIGRvbmU6IGRhdGEgPT09IG51bGwgfSkKICAgICAgcHJvbWlzZVJlamVjdCA9IHByb21pc2VSZXNvbHZlID0gbnVsbAogICAgfQoKICAgIGZ1bmN0aW9uIGRlc3Ryb3kgKGVycikgewogICAgICBzdHJlYW0uZGVzdHJveShlcnIpCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgaWYgKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBERVNUUk9ZRUQpIHJldHVybiByZXNvbHZlKHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9KQogICAgICAgIHN0cmVhbS5vbmNlKCdjbG9zZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpCiAgICAgICAgICBlbHNlIHJlc29sdmUoeyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH0pCiAgICAgICAgfSkKICAgICAgfSkKICAgIH0KICB9Cn0KCmNsYXNzIFdyaXRhYmxlIGV4dGVuZHMgU3RyZWFtIHsKICBjb25zdHJ1Y3RvciAob3B0cykgewogICAgc3VwZXIob3B0cykKCiAgICB0aGlzLl9kdXBsZXhTdGF0ZSB8PSBPUEVOSU5HIHwgUkVBRF9ET05FCiAgICB0aGlzLl93cml0YWJsZVN0YXRlID0gbmV3IFdyaXRhYmxlU3RhdGUodGhpcywgb3B0cykKCiAgICBpZiAob3B0cykgewogICAgICBpZiAob3B0cy53cml0ZXYpIHRoaXMuX3dyaXRldiA9IG9wdHMud3JpdGV2CiAgICAgIGlmIChvcHRzLndyaXRlKSB0aGlzLl93cml0ZSA9IG9wdHMud3JpdGUKICAgICAgaWYgKG9wdHMuZmluYWwpIHRoaXMuX2ZpbmFsID0gb3B0cy5maW5hbAogICAgICBpZiAob3B0cy5lYWdlck9wZW4pIHRoaXMuX3dyaXRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgfQogIH0KCiAgY29yayAoKSB7CiAgICB0aGlzLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9DT1JLRUQKICB9CgogIHVuY29yayAoKSB7CiAgICB0aGlzLl9kdXBsZXhTdGF0ZSAmPSBXUklURV9OT1RfQ09SS0VECiAgICB0aGlzLl93cml0YWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICB9CgogIF93cml0ZXYgKGJhdGNoLCBjYikgewogICAgY2IobnVsbCkKICB9CgogIF93cml0ZSAoZGF0YSwgY2IpIHsKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUuYXV0b0JhdGNoKGRhdGEsIGNiKQogIH0KCiAgX2ZpbmFsIChjYikgewogICAgY2IobnVsbCkKICB9CgogIHN0YXRpYyBpc0JhY2twcmVzc3VyZWQgKHdzKSB7CiAgICByZXR1cm4gKHdzLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX0JBQ0tQUkVTU1VSRV9TVEFUVVMpICE9PSAwCiAgfQoKICBzdGF0aWMgZHJhaW5lZCAod3MpIHsKICAgIGlmICh3cy5kZXN0cm95ZWQpIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpCiAgICBjb25zdCBzdGF0ZSA9IHdzLl93cml0YWJsZVN0YXRlCiAgICBjb25zdCBwZW5kaW5nID0gKGlzV3JpdGV2KHdzKSA/IE1hdGgubWluKDEsIHN0YXRlLnF1ZXVlLmxlbmd0aCkgOiBzdGF0ZS5xdWV1ZS5sZW5ndGgpCiAgICBjb25zdCB3cml0ZXMgPSBwZW5kaW5nICsgKCh3cy5fZHVwbGV4U3RhdGUgJiBXUklURV9XUklUSU5HKSA/IDEgOiAwKQogICAgaWYgKHdyaXRlcyA9PT0gMCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKQogICAgaWYgKHN0YXRlLmRyYWlucyA9PT0gbnVsbCkgc3RhdGUuZHJhaW5zID0gW10KICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICBzdGF0ZS5kcmFpbnMucHVzaCh7IHdyaXRlcywgcmVzb2x2ZSB9KQogICAgfSkKICB9CgogIHdyaXRlIChkYXRhKSB7CiAgICB0aGlzLl93cml0YWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIHJldHVybiB0aGlzLl93cml0YWJsZVN0YXRlLnB1c2goZGF0YSkKICB9CgogIGVuZCAoZGF0YSkgewogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICB0aGlzLl93cml0YWJsZVN0YXRlLmVuZChkYXRhKQogICAgcmV0dXJuIHRoaXMKICB9Cn0KCmNsYXNzIER1cGxleCBleHRlbmRzIFJlYWRhYmxlIHsgLy8gYW5kIFdyaXRhYmxlCiAgY29uc3RydWN0b3IgKG9wdHMpIHsKICAgIHN1cGVyKG9wdHMpCgogICAgdGhpcy5fZHVwbGV4U3RhdGUgPSBPUEVOSU5HIHwgKHRoaXMuX2R1cGxleFN0YXRlICYgUkVBRF9SRUFEX0FIRUFEKQogICAgdGhpcy5fd3JpdGFibGVTdGF0ZSA9IG5ldyBXcml0YWJsZVN0YXRlKHRoaXMsIG9wdHMpCgogICAgaWYgKG9wdHMpIHsKICAgICAgaWYgKG9wdHMud3JpdGV2KSB0aGlzLl93cml0ZXYgPSBvcHRzLndyaXRldgogICAgICBpZiAob3B0cy53cml0ZSkgdGhpcy5fd3JpdGUgPSBvcHRzLndyaXRlCiAgICAgIGlmIChvcHRzLmZpbmFsKSB0aGlzLl9maW5hbCA9IG9wdHMuZmluYWwKICAgIH0KICB9CgogIGNvcmsgKCkgewogICAgdGhpcy5fZHVwbGV4U3RhdGUgfD0gV1JJVEVfQ09SS0VECiAgfQoKICB1bmNvcmsgKCkgewogICAgdGhpcy5fZHVwbGV4U3RhdGUgJj0gV1JJVEVfTk9UX0NPUktFRAogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgfQoKICBfd3JpdGV2IChiYXRjaCwgY2IpIHsKICAgIGNiKG51bGwpCiAgfQoKICBfd3JpdGUgKGRhdGEsIGNiKSB7CiAgICB0aGlzLl93cml0YWJsZVN0YXRlLmF1dG9CYXRjaChkYXRhLCBjYikKICB9CgogIF9maW5hbCAoY2IpIHsKICAgIGNiKG51bGwpCiAgfQoKICB3cml0ZSAoZGF0YSkgewogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICByZXR1cm4gdGhpcy5fd3JpdGFibGVTdGF0ZS5wdXNoKGRhdGEpCiAgfQoKICBlbmQgKGRhdGEpIHsKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS5lbmQoZGF0YSkKICAgIHJldHVybiB0aGlzCiAgfQp9CgpjbGFzcyBUcmFuc2Zvcm0gZXh0ZW5kcyBEdXBsZXggewogIGNvbnN0cnVjdG9yIChvcHRzKSB7CiAgICBzdXBlcihvcHRzKQogICAgdGhpcy5fdHJhbnNmb3JtU3RhdGUgPSBuZXcgVHJhbnNmb3JtU3RhdGUodGhpcykKCiAgICBpZiAob3B0cykgewogICAgICBpZiAob3B0cy50cmFuc2Zvcm0pIHRoaXMuX3RyYW5zZm9ybSA9IG9wdHMudHJhbnNmb3JtCiAgICAgIGlmIChvcHRzLmZsdXNoKSB0aGlzLl9mbHVzaCA9IG9wdHMuZmx1c2gKICAgIH0KICB9CgogIF93cml0ZSAoZGF0YSwgY2IpIHsKICAgIGlmICh0aGlzLl9yZWFkYWJsZVN0YXRlLmJ1ZmZlcmVkID49IHRoaXMuX3JlYWRhYmxlU3RhdGUuaGlnaFdhdGVyTWFyaykgewogICAgICB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5kYXRhID0gZGF0YQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fdHJhbnNmb3JtKGRhdGEsIHRoaXMuX3RyYW5zZm9ybVN0YXRlLmFmdGVyVHJhbnNmb3JtKQogICAgfQogIH0KCiAgX3JlYWQgKGNiKSB7CiAgICBpZiAodGhpcy5fdHJhbnNmb3JtU3RhdGUuZGF0YSAhPT0gbnVsbCkgewogICAgICBjb25zdCBkYXRhID0gdGhpcy5fdHJhbnNmb3JtU3RhdGUuZGF0YQogICAgICB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5kYXRhID0gbnVsbAogICAgICBjYihudWxsKQogICAgICB0aGlzLl90cmFuc2Zvcm0oZGF0YSwgdGhpcy5fdHJhbnNmb3JtU3RhdGUuYWZ0ZXJUcmFuc2Zvcm0pCiAgICB9IGVsc2UgewogICAgICBjYihudWxsKQogICAgfQogIH0KCiAgZGVzdHJveSAoZXJyKSB7CiAgICBzdXBlci5kZXN0cm95KGVycikKICAgIGlmICh0aGlzLl90cmFuc2Zvcm1TdGF0ZS5kYXRhICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX3RyYW5zZm9ybVN0YXRlLmRhdGEgPSBudWxsCiAgICAgIHRoaXMuX3RyYW5zZm9ybVN0YXRlLmFmdGVyVHJhbnNmb3JtKCkKICAgIH0KICB9CgogIF90cmFuc2Zvcm0gKGRhdGEsIGNiKSB7CiAgICBjYihudWxsLCBkYXRhKQogIH0KCiAgX2ZsdXNoIChjYikgewogICAgY2IobnVsbCkKICB9CgogIF9maW5hbCAoY2IpIHsKICAgIHRoaXMuX3RyYW5zZm9ybVN0YXRlLmFmdGVyRmluYWwgPSBjYgogICAgdGhpcy5fZmx1c2godHJhbnNmb3JtQWZ0ZXJGbHVzaC5iaW5kKHRoaXMpKQogIH0KfQoKY2xhc3MgUGFzc1Rocm91Z2ggZXh0ZW5kcyBUcmFuc2Zvcm0ge30KCmZ1bmN0aW9uIHRyYW5zZm9ybUFmdGVyRmx1c2ggKGVyciwgZGF0YSkgewogIGNvbnN0IGNiID0gdGhpcy5fdHJhbnNmb3JtU3RhdGUuYWZ0ZXJGaW5hbAogIGlmIChlcnIpIHJldHVybiBjYihlcnIpCiAgaWYgKGRhdGEgIT09IG51bGwgJiYgZGF0YSAhPT0gdW5kZWZpbmVkKSB0aGlzLnB1c2goZGF0YSkKICB0aGlzLnB1c2gobnVsbCkKICBjYihudWxsKQp9CgpmdW5jdGlvbiBwaXBlbGluZVByb21pc2UgKC4uLnN0cmVhbXMpIHsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmV0dXJuIHBpcGVsaW5lKC4uLnN0cmVhbXMsIChlcnIpID0+IHsKICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdChlcnIpCiAgICAgIHJlc29sdmUoKQogICAgfSkKICB9KQp9CgpmdW5jdGlvbiBwaXBlbGluZSAoc3RyZWFtLCAuLi5zdHJlYW1zKSB7CiAgY29uc3QgYWxsID0gQXJyYXkuaXNBcnJheShzdHJlYW0pID8gWy4uLnN0cmVhbSwgLi4uc3RyZWFtc10gOiBbc3RyZWFtLCAuLi5zdHJlYW1zXQogIGNvbnN0IGRvbmUgPSAoYWxsLmxlbmd0aCAmJiB0eXBlb2YgYWxsW2FsbC5sZW5ndGggLSAxXSA9PT0gJ2Z1bmN0aW9uJykgPyBhbGwucG9wKCkgOiBudWxsCgogIGlmIChhbGwubGVuZ3RoIDwgMikgdGhyb3cgbmV3IEVycm9yKCdQaXBlbGluZSByZXF1aXJlcyBhdCBsZWFzdCAyIHN0cmVhbXMnKQoKICBsZXQgc3JjID0gYWxsWzBdCiAgbGV0IGRlc3QgPSBudWxsCiAgbGV0IGVycm9yID0gbnVsbAoKICBmb3IgKGxldCBpID0gMTsgaSA8IGFsbC5sZW5ndGg7IGkrKykgewogICAgZGVzdCA9IGFsbFtpXQoKICAgIGlmIChpc1N0cmVhbXgoc3JjKSkgewogICAgICBzcmMucGlwZShkZXN0LCBvbmVycm9yKQogICAgfSBlbHNlIHsKICAgICAgZXJyb3JIYW5kbGUoc3JjLCB0cnVlLCBpID4gMSwgb25lcnJvcikKICAgICAgc3JjLnBpcGUoZGVzdCkKICAgIH0KCiAgICBzcmMgPSBkZXN0CiAgfQoKICBpZiAoZG9uZSkgewogICAgbGV0IGZpbiA9IGZhbHNlCgogICAgY29uc3QgYXV0b0Rlc3Ryb3kgPSBpc1N0cmVhbXgoZGVzdCkgfHwgISEoZGVzdC5fd3JpdGFibGVTdGF0ZSAmJiBkZXN0Ll93cml0YWJsZVN0YXRlLmF1dG9EZXN0cm95KQoKICAgIGRlc3Qub24oJ2Vycm9yJywgKGVycikgPT4gewogICAgICBpZiAoZXJyb3IgPT09IG51bGwpIGVycm9yID0gZXJyCiAgICB9KQoKICAgIGRlc3Qub24oJ2ZpbmlzaCcsICgpID0+IHsKICAgICAgZmluID0gdHJ1ZQogICAgICBpZiAoIWF1dG9EZXN0cm95KSBkb25lKGVycm9yKQogICAgfSkKCiAgICBpZiAoYXV0b0Rlc3Ryb3kpIHsKICAgICAgZGVzdC5vbignY2xvc2UnLCAoKSA9PiBkb25lKGVycm9yIHx8IChmaW4gPyBudWxsIDogUFJFTUFUVVJFX0NMT1NFKSkpCiAgICB9CiAgfQoKICByZXR1cm4gZGVzdAoKICBmdW5jdGlvbiBlcnJvckhhbmRsZSAocywgcmQsIHdyLCBvbmVycm9yKSB7CiAgICBzLm9uKCdlcnJvcicsIG9uZXJyb3IpCiAgICBzLm9uKCdjbG9zZScsIG9uY2xvc2UpCgogICAgZnVuY3Rpb24gb25jbG9zZSAoKSB7CiAgICAgIGlmIChyZCAmJiBzLl9yZWFkYWJsZVN0YXRlICYmICFzLl9yZWFkYWJsZVN0YXRlLmVuZGVkKSByZXR1cm4gb25lcnJvcihQUkVNQVRVUkVfQ0xPU0UpCiAgICAgIGlmICh3ciAmJiBzLl93cml0YWJsZVN0YXRlICYmICFzLl93cml0YWJsZVN0YXRlLmVuZGVkKSByZXR1cm4gb25lcnJvcihQUkVNQVRVUkVfQ0xPU0UpCiAgICB9CiAgfQoKICBmdW5jdGlvbiBvbmVycm9yIChlcnIpIHsKICAgIGlmICghZXJyIHx8IGVycm9yKSByZXR1cm4KICAgIGVycm9yID0gZXJyCgogICAgZm9yIChjb25zdCBzIG9mIGFsbCkgewogICAgICBzLmRlc3Ryb3koZXJyKQogICAgfQogIH0KfQoKZnVuY3Rpb24gZWNobyAocykgewogIHJldHVybiBzCn0KCmZ1bmN0aW9uIGlzU3RyZWFtIChzdHJlYW0pIHsKICByZXR1cm4gISFzdHJlYW0uX3JlYWRhYmxlU3RhdGUgfHwgISFzdHJlYW0uX3dyaXRhYmxlU3RhdGUKfQoKZnVuY3Rpb24gaXNTdHJlYW14IChzdHJlYW0pIHsKICByZXR1cm4gdHlwZW9mIHN0cmVhbS5fZHVwbGV4U3RhdGUgPT09ICdudW1iZXInICYmIGlzU3RyZWFtKHN0cmVhbSkKfQoKZnVuY3Rpb24gaXNFbmRlZCAoc3RyZWFtKSB7CiAgcmV0dXJuICEhc3RyZWFtLl9yZWFkYWJsZVN0YXRlICYmIHN0cmVhbS5fcmVhZGFibGVTdGF0ZS5lbmRlZAp9CgpmdW5jdGlvbiBpc0ZpbmlzaGVkIChzdHJlYW0pIHsKICByZXR1cm4gISFzdHJlYW0uX3dyaXRhYmxlU3RhdGUgJiYgc3RyZWFtLl93cml0YWJsZVN0YXRlLmVuZGVkCn0KCmZ1bmN0aW9uIGdldFN0cmVhbUVycm9yIChzdHJlYW0sIG9wdHMgPSB7fSkgewogIGNvbnN0IGVyciA9IChzdHJlYW0uX3JlYWRhYmxlU3RhdGUgJiYgc3RyZWFtLl9yZWFkYWJsZVN0YXRlLmVycm9yKSB8fCAoc3RyZWFtLl93cml0YWJsZVN0YXRlICYmIHN0cmVhbS5fd3JpdGFibGVTdGF0ZS5lcnJvcikKCiAgLy8gYXZvaWQgaW1wbGljaXQgZXJyb3JzIGJ5IGRlZmF1bHQKICByZXR1cm4gKCFvcHRzLmFsbCAmJiBlcnIgPT09IFNUUkVBTV9ERVNUUk9ZRUQpID8gbnVsbCA6IGVycgp9CgpmdW5jdGlvbiBpc1JlYWRTdHJlYW14IChzdHJlYW0pIHsKICByZXR1cm4gaXNTdHJlYW14KHN0cmVhbSkgJiYgc3RyZWFtLnJlYWRhYmxlCn0KCmZ1bmN0aW9uIGlzRGlzdHVyYmVkIChzdHJlYW0pIHsKICByZXR1cm4gKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBPUEVOSU5HKSAhPT0gT1BFTklORyB8fCAoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIEFDVElWRV9PUl9USUNLSU5HKSAhPT0gMAp9CgpmdW5jdGlvbiBpc1R5cGVkQXJyYXkgKGRhdGEpIHsKICByZXR1cm4gdHlwZW9mIGRhdGEgPT09ICdvYmplY3QnICYmIGRhdGEgIT09IG51bGwgJiYgdHlwZW9mIGRhdGEuYnl0ZUxlbmd0aCA9PT0gJ251bWJlcicKfQoKZnVuY3Rpb24gZGVmYXVsdEJ5dGVMZW5ndGggKGRhdGEpIHsKICByZXR1cm4gaXNUeXBlZEFycmF5KGRhdGEpID8gZGF0YS5ieXRlTGVuZ3RoIDogMTAyNAp9CgpmdW5jdGlvbiBub29wICgpIHt9CgpmdW5jdGlvbiBhYm9ydCAoKSB7CiAgdGhpcy5kZXN0cm95KG5ldyBFcnJvcignU3RyZWFtIGFib3J0ZWQuJykpCn0KCmZ1bmN0aW9uIGlzV3JpdGV2IChzKSB7CiAgcmV0dXJuIHMuX3dyaXRldiAhPT0gV3JpdGFibGUucHJvdG90eXBlLl93cml0ZXYgJiYgcy5fd3JpdGV2ICE9PSBEdXBsZXgucHJvdG90eXBlLl93cml0ZXYKfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgcGlwZWxpbmUsCiAgcGlwZWxpbmVQcm9taXNlLAogIGlzU3RyZWFtLAogIGlzU3RyZWFteCwKICBpc0VuZGVkLAogIGlzRmluaXNoZWQsCiAgaXNEaXN0dXJiZWQsCiAgZ2V0U3RyZWFtRXJyb3IsCiAgU3RyZWFtLAogIFdyaXRhYmxlLAogIFJlYWRhYmxlLAogIER1cGxleCwKICBUcmFuc2Zvcm0sCiAgLy8gRXhwb3J0IFBhc3NUaHJvdWdoIGZvciBjb21wYXRpYmlsaXR5IHdpdGggTm9kZS5qcyBjb3JlJ3Mgc3RyZWFtIG1vZHVsZQogIFBhc3NUaHJvdWdoCn0KewogICJuYW1lIjogInN0cmVhbXgiLAogICJ2ZXJzaW9uIjogIjIuMjMuMCIsCiAgImRlc2NyaXB0aW9uIjogIkFuIGl0ZXJhdGlvbiBvZiB0aGUgTm9kZS5qcyBjb3JlIHN0cmVhbXMgd2l0aCBhIHNlcmllcyBvZiBpbXByb3ZlbWVudHMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImV2ZW50cy11bml2ZXJzYWwiOiAiXjEuMC4wIiwKICAgICJmYXN0LWZpZm8iOiAiXjEuMy4yIiwKICAgICJ0ZXh0LWRlY29kZXIiOiAiXjEuMS4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi42IiwKICAgICJicml0dGxlIjogIl4zLjEuMSIsCiAgICAiZW5kLW9mLXN0cmVhbSI6ICJeMS40LjQiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIG5vZGUgdGVzdC9hbGwuanMiLAogICAgInRlc3Q6YmFyZSI6ICJzdGFuZGFyZCAmJiBiYXJlIHRlc3QvYWxsLmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3N0cmVhbXguZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3N0cmVhbXgvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc3RyZWFteCIKfQpjb25zdCBjb2RlY3MgPSByZXF1aXJlKCdjb2RlY3MnKQpjb25zdCBiID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IFNFUCA9IGIuYWxsb2MoMSkKY29uc3QgU0VQX0JVTVBFRCA9IGIuZnJvbShbMHgxXSkKY29uc3QgRU1QVFkgPSBiLmFsbG9jKDApCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFN1YkVuY29kZXIgewogIGNvbnN0cnVjdG9yIChwcmVmaXgsIGVuY29kaW5nLCBwYXJlbnQgPSBudWxsKSB7CiAgICB0aGlzLnVzZXJFbmNvZGluZyA9IGNvZGVjcyhlbmNvZGluZykKICAgIHRoaXMucHJlZml4ID0gcHJlZml4ICE9IG51bGwgPyBjcmVhdGVQcmVmaXgocHJlZml4LCBwYXJlbnQpIDogbnVsbAogICAgdGhpcy5sdCA9IHRoaXMucHJlZml4ICYmIGIuY29uY2F0KFt0aGlzLnByZWZpeC5zdWJhcnJheSgwLCB0aGlzLnByZWZpeC5ieXRlTGVuZ3RoIC0gMSksIFNFUF9CVU1QRURdKQogIH0KCiAgX2VuY29kZVJhbmdlVXNlciAocikgewogICAgaWYgKHRoaXMudXNlckVuY29kaW5nLmVuY29kZVJhbmdlKSByZXR1cm4gdGhpcy51c2VyRW5jb2RpbmcuZW5jb2RlUmFuZ2UocikKCiAgICBjb25zdCByZXMgPSB7fQogICAgaWYgKHIuZ3QgIT0gbnVsbCkgcmVzLmd0ID0gdGhpcy51c2VyRW5jb2RpbmcuZW5jb2RlKHIuZ3QpCiAgICBpZiAoci5ndGUgIT0gbnVsbCkgcmVzLmd0ZSA9IHRoaXMudXNlckVuY29kaW5nLmVuY29kZShyLmd0ZSkKICAgIGlmIChyLmx0ZSAhPSBudWxsKSByZXMubHRlID0gdGhpcy51c2VyRW5jb2RpbmcuZW5jb2RlKHIubHRlKQogICAgaWYgKHIubHQgIT0gbnVsbCkgcmVzLmx0ID0gdGhpcy51c2VyRW5jb2RpbmcuZW5jb2RlKHIubHQpCgogICAgcmV0dXJuIHJlcwogIH0KCiAgX2FkZFByZWZpeCAoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5wcmVmaXggPyBiLmNvbmNhdChbdGhpcy5wcmVmaXgsIGtleV0pIDoga2V5CiAgfQoKICBlbmNvZGUgKGtleSkgewogICAgcmV0dXJuIHRoaXMuX2FkZFByZWZpeCh0aGlzLnVzZXJFbmNvZGluZy5lbmNvZGUoa2V5KSkKICB9CgogIGVuY29kZVJhbmdlIChyYW5nZSkgewogICAgY29uc3QgciA9IHRoaXMuX2VuY29kZVJhbmdlVXNlcihyYW5nZSkKCiAgICBpZiAoci5ndCkgci5ndCA9IHRoaXMuX2FkZFByZWZpeChyLmd0KQogICAgZWxzZSBpZiAoci5ndGUpIHIuZ3RlID0gdGhpcy5fYWRkUHJlZml4KHIuZ3RlKQogICAgZWxzZSBpZiAodGhpcy5wcmVmaXgpIHIuZ3RlID0gdGhpcy5wcmVmaXgKCiAgICBpZiAoci5sdCkgci5sdCA9IHRoaXMuX2FkZFByZWZpeChyLmx0KQogICAgZWxzZSBpZiAoci5sdGUpIHIubHRlID0gdGhpcy5fYWRkUHJlZml4KHIubHRlKQogICAgZWxzZSBpZiAodGhpcy5wcmVmaXgpIHIubHQgPSB0aGlzLmx0CgogICAgcmV0dXJuIHIKICB9CgogIGRlY29kZSAoa2V5KSB7CiAgICByZXR1cm4gdGhpcy51c2VyRW5jb2RpbmcuZGVjb2RlKHRoaXMucHJlZml4ID8ga2V5LnN1YmFycmF5KHRoaXMucHJlZml4LmJ5dGVMZW5ndGgpIDoga2V5KQogIH0KCiAgc3ViIChwcmVmaXgsIGVuY29kaW5nKSB7CiAgICByZXR1cm4gbmV3IFN1YkVuY29kZXIocHJlZml4IHx8IEVNUFRZLCBjb21wYXQoZW5jb2RpbmcpLCB0aGlzLnByZWZpeCkKICB9Cn0KCmZ1bmN0aW9uIGNyZWF0ZVByZWZpeCAocHJlZml4LCBwYXJlbnQpIHsKICBwcmVmaXggPSB0eXBlb2YgcHJlZml4ID09PSAnc3RyaW5nJyA/IGIuZnJvbShwcmVmaXgpIDogcHJlZml4CgogIGlmIChwcmVmaXggJiYgcGFyZW50KSByZXR1cm4gYi5jb25jYXQoW3BhcmVudCwgcHJlZml4LCBTRVBdKQogIGlmIChwcmVmaXgpIHJldHVybiBiLmNvbmNhdChbcHJlZml4LCBTRVBdKQogIGlmIChwYXJlbnQpIHJldHVybiBiLmNvbmNhdChbcGFyZW50LCBTRVBdKQogIHJldHVybiBTRVAKfQoKZnVuY3Rpb24gY29tcGF0IChlbmMpIHsKICBpZiAoZW5jICYmIGVuYy5rZXlFbmNvZGluZykgcmV0dXJuIGVuYy5rZXlFbmNvZGluZwogIHJldHVybiBlbmMKfQp7CiAgIm5hbWUiOiAic3ViLWVuY29kZXIiLAogICJ2ZXJzaW9uIjogIjIuMS4zIiwKICAiZGVzY3JpcHRpb24iOiAiR2VuZXJhdGUgc3ViIGVuY29kaW5ncyBmb3Iga2V5L3ZhbHVlIHN0b3JlcyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LyouanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc3ViLWVuY29kZXIuZ2l0IgogIH0sCiAgImtleXdvcmRzIjogWwogICAgImt2LXN0b3JlIiwKICAgICJlbmNvZGluZyIsCiAgICAiaHlwZXJiZWUiCiAgXSwKICAiYXV0aG9yIjogIkFuZHJldyBPc2hlcm9mZiA8YW5kcmV3b3NoQGdtYWlsLmNvbT4iLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc3ViLWVuY29kZXIvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zdWItZW5jb2RlciNyZWFkbWUiLAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4xLjEiLAogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuMTIuMCIsCiAgICAiaHlwZXJiZWUiOiAiXjIuMTEuMCIsCiAgICAiaHlwZXJjb3JlIjogIl4xMC4zLjIiLAogICAgImluZGV4LWVuY29kZXIiOiAiXjMuMC4wIiwKICAgICJyYW5kb20tYWNjZXNzLW1lbW9yeSI6ICJeNi4wLjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjAiLAogICAgImNvZGVjcyI6ICJeMy4xLjAiCiAgfQp9CmNvbnN0IFBhc3NUaHJvdWdoRGVjb2RlciA9IHJlcXVpcmUoJy4vbGliL3Bhc3MtdGhyb3VnaC1kZWNvZGVyJykKY29uc3QgVVRGOERlY29kZXIgPSByZXF1aXJlKCcuL2xpYi91dGY4LWRlY29kZXInKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBUZXh0RGVjb2RlciB7CiAgY29uc3RydWN0b3IgKGVuY29kaW5nID0gJ3V0ZjgnKSB7CiAgICB0aGlzLmVuY29kaW5nID0gbm9ybWFsaXplRW5jb2RpbmcoZW5jb2RpbmcpCgogICAgc3dpdGNoICh0aGlzLmVuY29kaW5nKSB7CiAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICAgIHRoaXMuZGVjb2RlciA9IG5ldyBVVEY4RGVjb2RlcigpCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCBlbmNvZGluZzogJyArIHRoaXMuZW5jb2RpbmcpCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhpcy5kZWNvZGVyID0gbmV3IFBhc3NUaHJvdWdoRGVjb2Rlcih0aGlzLmVuY29kaW5nKQogICAgfQogIH0KCiAgZ2V0IHJlbWFpbmluZyAoKSB7CiAgICByZXR1cm4gdGhpcy5kZWNvZGVyLnJlbWFpbmluZwogIH0KCiAgcHVzaCAoZGF0YSkgewogICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgcmV0dXJuIGRhdGEKICAgIHJldHVybiB0aGlzLmRlY29kZXIuZGVjb2RlKGRhdGEpCiAgfQoKICAvLyBGb3IgTm9kZS5qcyBjb21wYXRpYmlsaXR5CiAgd3JpdGUgKGRhdGEpIHsKICAgIHJldHVybiB0aGlzLnB1c2goZGF0YSkKICB9CgogIGVuZCAoZGF0YSkgewogICAgbGV0IHJlc3VsdCA9ICcnCiAgICBpZiAoZGF0YSkgcmVzdWx0ID0gdGhpcy5wdXNoKGRhdGEpCiAgICByZXN1bHQgKz0gdGhpcy5kZWNvZGVyLmZsdXNoKCkKICAgIHJldHVybiByZXN1bHQKICB9Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZUVuY29kaW5nIChlbmNvZGluZykgewogIGVuY29kaW5nID0gZW5jb2RpbmcudG9Mb3dlckNhc2UoKQoKICBzd2l0Y2ggKGVuY29kaW5nKSB7CiAgICBjYXNlICd1dGY4JzoKICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgcmV0dXJuICd1dGY4JwogICAgY2FzZSAndWNzMic6CiAgICBjYXNlICd1Y3MtMic6CiAgICBjYXNlICd1dGYxNmxlJzoKICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgcmV0dXJuICd1dGYxNmxlJwogICAgY2FzZSAnbGF0aW4xJzoKICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgIHJldHVybiAnbGF0aW4xJwogICAgY2FzZSAnYmFzZTY0JzoKICAgIGNhc2UgJ2FzY2lpJzoKICAgIGNhc2UgJ2hleCc6CiAgICAgIHJldHVybiBlbmNvZGluZwogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgfQp9Owpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBQYXNzVGhyb3VnaERlY29kZXIgewogIGNvbnN0cnVjdG9yIChlbmNvZGluZykgewogICAgdGhpcy5lbmNvZGluZyA9IGVuY29kaW5nCiAgfQoKICBnZXQgcmVtYWluaW5nICgpIHsKICAgIHJldHVybiAwCiAgfQoKICBkZWNvZGUgKHRhaWwpIHsKICAgIHJldHVybiBiNGEudG9TdHJpbmcodGFpbCwgdGhpcy5lbmNvZGluZykKICB9CgogIGZsdXNoICgpIHsKICAgIHJldHVybiAnJwogIH0KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKLyoqCiAqIGh0dHBzOi8vZW5jb2Rpbmcuc3BlYy53aGF0d2cub3JnLyN1dGYtOC1kZWNvZGVyCiAqLwptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFVURjhEZWNvZGVyIHsKICBjb25zdHJ1Y3RvciAoKSB7CiAgICB0aGlzLmNvZGVQb2ludCA9IDAKICAgIHRoaXMuYnl0ZXNTZWVuID0gMAogICAgdGhpcy5ieXRlc05lZWRlZCA9IDAKICAgIHRoaXMubG93ZXJCb3VuZGFyeSA9IDB4ODAKICAgIHRoaXMudXBwZXJCb3VuZGFyeSA9IDB4YmYKICB9CgogIGdldCByZW1haW5pbmcgKCkgewogICAgcmV0dXJuIHRoaXMuYnl0ZXNTZWVuCiAgfQoKICBkZWNvZGUgKGRhdGEpIHsKICAgIC8vIElmIHdlIGhhdmUgYSBmYXN0IHBhdGgsIGp1c3Qgc25pZmYgaWYgdGhlIGxhc3QgcGFydCBpcyBhIGJvdW5kYXJ5CiAgICBpZiAodGhpcy5ieXRlc05lZWRlZCA9PT0gMCkgewogICAgICBsZXQgaXNCb3VuZGFyeSA9IHRydWUKCiAgICAgIGZvciAobGV0IGkgPSBNYXRoLm1heCgwLCBkYXRhLmJ5dGVMZW5ndGggLSA0KSwgbiA9IGRhdGEuYnl0ZUxlbmd0aDsgaSA8IG4gJiYgaXNCb3VuZGFyeTsgaSsrKSB7CiAgICAgICAgaXNCb3VuZGFyeSA9IGRhdGFbaV0gPD0gMHg3ZgogICAgICB9CgogICAgICBpZiAoaXNCb3VuZGFyeSkgcmV0dXJuIGI0YS50b1N0cmluZyhkYXRhLCAndXRmOCcpCiAgICB9CgogICAgbGV0IHJlc3VsdCA9ICcnCgogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBkYXRhLmJ5dGVMZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgY29uc3QgYnl0ZSA9IGRhdGFbaV0KCiAgICAgIGlmICh0aGlzLmJ5dGVzTmVlZGVkID09PSAwKSB7CiAgICAgICAgaWYgKGJ5dGUgPD0gMHg3ZikgewogICAgICAgICAgcmVzdWx0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnl0ZSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5ieXRlc1NlZW4gPSAxCgogICAgICAgICAgaWYgKGJ5dGUgPj0gMHhjMiAmJiBieXRlIDw9IDB4ZGYpIHsKICAgICAgICAgICAgdGhpcy5ieXRlc05lZWRlZCA9IDIKICAgICAgICAgICAgdGhpcy5jb2RlUG9pbnQgPSBieXRlICYgMHgxZgogICAgICAgICAgfSBlbHNlIGlmIChieXRlID49IDB4ZTAgJiYgYnl0ZSA8PSAweGVmKSB7CiAgICAgICAgICAgIGlmIChieXRlID09PSAweGUwKSB0aGlzLmxvd2VyQm91bmRhcnkgPSAweGEwCiAgICAgICAgICAgIGVsc2UgaWYgKGJ5dGUgPT09IDB4ZWQpIHRoaXMudXBwZXJCb3VuZGFyeSA9IDB4OWYKICAgICAgICAgICAgdGhpcy5ieXRlc05lZWRlZCA9IDMKICAgICAgICAgICAgdGhpcy5jb2RlUG9pbnQgPSBieXRlICYgMHhmCiAgICAgICAgICB9IGVsc2UgaWYgKGJ5dGUgPj0gMHhmMCAmJiBieXRlIDw9IDB4ZjQpIHsKICAgICAgICAgICAgaWYgKGJ5dGUgPT09IDB4ZjApIHRoaXMubG93ZXJCb3VuZGFyeSA9IDB4OTAKICAgICAgICAgICAgaWYgKGJ5dGUgPT09IDB4ZjQpIHRoaXMudXBwZXJCb3VuZGFyeSA9IDB4OGYKICAgICAgICAgICAgdGhpcy5ieXRlc05lZWRlZCA9IDQKICAgICAgICAgICAgdGhpcy5jb2RlUG9pbnQgPSBieXRlICYgMHg3CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHQgKz0gJ1x1ZmZmZCcKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGlmIChieXRlIDwgdGhpcy5sb3dlckJvdW5kYXJ5IHx8IGJ5dGUgPiB0aGlzLnVwcGVyQm91bmRhcnkpIHsKICAgICAgICB0aGlzLmNvZGVQb2ludCA9IDAKICAgICAgICB0aGlzLmJ5dGVzTmVlZGVkID0gMAogICAgICAgIHRoaXMuYnl0ZXNTZWVuID0gMAogICAgICAgIHRoaXMubG93ZXJCb3VuZGFyeSA9IDB4ODAKICAgICAgICB0aGlzLnVwcGVyQm91bmRhcnkgPSAweGJmCgogICAgICAgIHJlc3VsdCArPSAnXHVmZmZkJwoKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICB0aGlzLmxvd2VyQm91bmRhcnkgPSAweDgwCiAgICAgIHRoaXMudXBwZXJCb3VuZGFyeSA9IDB4YmYKCiAgICAgIHRoaXMuY29kZVBvaW50ID0gKHRoaXMuY29kZVBvaW50IDw8IDYpIHwgKGJ5dGUgJiAweDNmKQogICAgICB0aGlzLmJ5dGVzU2VlbisrCgogICAgICBpZiAodGhpcy5ieXRlc1NlZW4gIT09IHRoaXMuYnl0ZXNOZWVkZWQpIGNvbnRpbnVlCgogICAgICByZXN1bHQgKz0gU3RyaW5nLmZyb21Db2RlUG9pbnQodGhpcy5jb2RlUG9pbnQpCgogICAgICB0aGlzLmNvZGVQb2ludCA9IDAKICAgICAgdGhpcy5ieXRlc05lZWRlZCA9IDAKICAgICAgdGhpcy5ieXRlc1NlZW4gPSAwCiAgICB9CgogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgZmx1c2ggKCkgewogICAgY29uc3QgcmVzdWx0ID0gdGhpcy5ieXRlc05lZWRlZCA+IDAgPyAnXHVmZmZkJyA6ICcnCgogICAgdGhpcy5jb2RlUG9pbnQgPSAwCiAgICB0aGlzLmJ5dGVzTmVlZGVkID0gMAogICAgdGhpcy5ieXRlc1NlZW4gPSAwCiAgICB0aGlzLmxvd2VyQm91bmRhcnkgPSAweDgwCiAgICB0aGlzLnVwcGVyQm91bmRhcnkgPSAweGJmCgogICAgcmV0dXJuIHJlc3VsdAogIH0KfQp7CiAgIm5hbWUiOiAidGV4dC1kZWNvZGVyIiwKICAidmVyc2lvbiI6ICIxLjIuMyIsCiAgImRlc2NyaXB0aW9uIjogIlN0cmVhbWluZyB0ZXh0IGRlY29kZXIgdGhhdCBwcmVzZXJ2ZXMgbXVsdGlieXRlIFVuaWNvZGUgY2hhcmFjdGVycyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibGliIgogIF0sCiAgImJyb3dzZXIiOiB7CiAgICAiLi9saWIvcGFzcy10aHJvdWdoLWRlY29kZXIuanMiOiAiLi9saWIvYnJvd3Nlci1kZWNvZGVyLmpzIiwKICAgICIuL2xpYi91dGY4LWRlY29kZXIuanMiOiAiLi9saWIvYnJvd3Nlci1kZWNvZGVyLmpzIgogIH0sCiAgInJlYWN0LW5hdGl2ZSI6IHsKICAgICIuL2xpYi9wYXNzLXRocm91Z2gtZGVjb2Rlci5qcyI6ICIuL2xpYi9wYXNzLXRocm91Z2gtZGVjb2Rlci5qcyIsCiAgICAiLi9saWIvdXRmOC1kZWNvZGVyLmpzIjogIi4vbGliL3V0ZjgtZGVjb2Rlci5qcyIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3RleHQtZGVjb2Rlci5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by90ZXh0LWRlY29kZXIvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by90ZXh0LWRlY29kZXIjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjQiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMy4yIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0KfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFRpbWVPcmRlcmVkU2V0IHsKICBjb25zdHJ1Y3RvciAoKSB7CiAgICB0aGlzLm9sZGVzdCA9IG51bGwKICAgIHRoaXMubGF0ZXN0ID0gbnVsbAogICAgdGhpcy5sZW5ndGggPSAwCiAgfQoKICBoYXMgKG5vZGUpIHsKICAgIHJldHVybiAhIShub2RlLm5leHQgfHwgbm9kZS5wcmV2KSB8fCBub2RlID09PSB0aGlzLm9sZGVzdAogIH0KCiAgYWRkIChub2RlKSB7CiAgICBpZiAodGhpcy5oYXMobm9kZSkpIHRoaXMucmVtb3ZlKG5vZGUpCgogICAgaWYgKCF0aGlzLmxhdGVzdCAmJiAhdGhpcy5vbGRlc3QpIHsKICAgICAgdGhpcy5sYXRlc3QgPSB0aGlzLm9sZGVzdCA9IG5vZGUKICAgICAgbm9kZS5wcmV2ID0gbm9kZS5uZXh0ID0gbnVsbAogICAgfSBlbHNlIHsKICAgICAgdGhpcy5sYXRlc3QubmV4dCA9IG5vZGUKICAgICAgbm9kZS5wcmV2ID0gdGhpcy5sYXRlc3QKICAgICAgbm9kZS5uZXh0ID0gbnVsbAogICAgICB0aGlzLmxhdGVzdCA9IG5vZGUKICAgIH0KCiAgICB0aGlzLmxlbmd0aCsrCgogICAgcmV0dXJuIG5vZGUKICB9CgogIHJlbW92ZSAobm9kZSkgewogICAgaWYgKCF0aGlzLmhhcyhub2RlKSkgcmV0dXJuIG5vZGUKCiAgICBpZiAodGhpcy5vbGRlc3QgIT09IG5vZGUgJiYgdGhpcy5sYXRlc3QgIT09IG5vZGUpIHsKICAgICAgbm9kZS5wcmV2Lm5leHQgPSBub2RlLm5leHQKICAgICAgbm9kZS5uZXh0LnByZXYgPSBub2RlLnByZXYKICAgIH0gZWxzZSB7CiAgICAgIGlmICh0aGlzLm9sZGVzdCA9PT0gbm9kZSkgewogICAgICAgIHRoaXMub2xkZXN0ID0gbm9kZS5uZXh0CiAgICAgICAgaWYgKHRoaXMub2xkZXN0KSB0aGlzLm9sZGVzdC5wcmV2ID0gbnVsbAogICAgICB9CiAgICAgIGlmICh0aGlzLmxhdGVzdCA9PT0gbm9kZSkgewogICAgICAgIHRoaXMubGF0ZXN0ID0gbm9kZS5wcmV2CiAgICAgICAgaWYgKHRoaXMubGF0ZXN0KSB0aGlzLmxhdGVzdC5uZXh0ID0gbnVsbAogICAgICB9CiAgICB9CgogICAgbm9kZS5uZXh0ID0gbm9kZS5wcmV2ID0gbnVsbAogICAgdGhpcy5sZW5ndGgtLQoKICAgIHJldHVybiBub2RlCiAgfQoKICB0b0FycmF5ICh7IGxpbWl0ID0gSW5maW5pdHksIHJldmVyc2UgPSBmYWxzZSB9ID0ge30pIHsKICAgIGNvbnN0IGxpc3QgPSBbXQoKICAgIGlmIChyZXZlcnNlKSB7CiAgICAgIGxldCBub2RlID0gdGhpcy5sYXRlc3QKICAgICAgd2hpbGUgKG5vZGUgJiYgbGltaXQtLSkgewogICAgICAgIGxpc3QucHVzaChub2RlKQogICAgICAgIG5vZGUgPSBub2RlLnByZXYKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgbGV0IG5vZGUgPSB0aGlzLm9sZGVzdAogICAgICB3aGlsZSAobm9kZSAmJiBsaW1pdC0tKSB7CiAgICAgICAgbGlzdC5wdXNoKG5vZGUpCiAgICAgICAgbm9kZSA9IG5vZGUubmV4dAogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGxpc3QKICB9Cn0KewogICJuYW1lIjogInRpbWUtb3JkZXJlZC1zZXQiLAogICJ2ZXJzaW9uIjogIjIuMC4xIiwKICAiZGVzY3JpcHRpb24iOiAiRWZmaWNpZW50bHkgbWFpbnRhaW4gYSBzZXQgb2Ygbm9kZXMgb3JkZXJlZCBieSB0aGUgdGltZSB0aGV5IHdlcmUgYWRkZWQgdG8gdGhlIHNldCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4wLjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4xLjIiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC90aW1lLW9yZGVyZWQtc2V0LmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC90aW1lLW9yZGVyZWQtc2V0L2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3RpbWUtb3JkZXJlZC1zZXQiCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBUaW1lckJyb3dzZXIgewogIGNvbnN0cnVjdG9yIChtcywgZm4sIGN0eCA9IG51bGwsIGludGVydmFsID0gZmFsc2UpIHsKICAgIHRoaXMubXMgPSBtcwogICAgdGhpcy5vbnRpbWVvdXQgPSBmbgogICAgdGhpcy5jb250ZXh0ID0gY3R4IHx8IG51bGwKICAgIHRoaXMuaW50ZXJ2YWwgPSBpbnRlcnZhbAogICAgdGhpcy5kb25lID0gZmFsc2UKCiAgICB0aGlzLl90aW1lciA9IGludGVydmFsCiAgICAgID8gc2V0SW50ZXJ2YWwoY2FsbEludGVydmFsLCBtcywgdGhpcykKICAgICAgOiBzZXRUaW1lb3V0KGNhbGxUaW1lb3V0LCBtcywgdGhpcykKICB9CgogIHVucmVmICgpIHt9CgogIHJlZiAoKSB7fQoKICByZWZyZXNoICgpIHsKICAgIGlmICh0aGlzLmRvbmUpIHJldHVybgoKICAgIGlmICh0aGlzLmludGVydmFsKSB7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fdGltZXIpCiAgICAgIHRoaXMuX3RpbWVyID0gc2V0SW50ZXJ2YWwoY2FsbEludGVydmFsLCB0aGlzLm1zLCB0aGlzKQogICAgfSBlbHNlIHsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVyKQogICAgICB0aGlzLl90aW1lciA9IHNldFRpbWVvdXQoY2FsbFRpbWVvdXQsIHRoaXMubXMsIHRoaXMpCiAgICB9CiAgfQoKICBkZXN0cm95ICgpIHsKICAgIHRoaXMuZG9uZSA9IHRydWUKICAgIHRoaXMub250aW1lb3V0ID0gbnVsbAoKICAgIGlmICh0aGlzLmludGVydmFsKSBjbGVhckludGVydmFsKHRoaXMuX3RpbWVyKQogICAgZWxzZSBjbGVhclRpbWVvdXQodGhpcy5fdGltZXIpCiAgfQoKICBzdGF0aWMgb25jZSAobXMsIGZuLCBjdHgpIHsKICAgIHJldHVybiBuZXcgdGhpcyhtcywgZm4sIGN0eCwgZmFsc2UpCiAgfQoKICBzdGF0aWMgb24gKG1zLCBmbiwgY3R4KSB7CiAgICByZXR1cm4gbmV3IHRoaXMobXMsIGZuLCBjdHgsIHRydWUpCiAgfQp9CgpmdW5jdGlvbiBjYWxsVGltZW91dCAoc2VsZikgewogIHNlbGYuZG9uZSA9IHRydWUKICBzZWxmLm9udGltZW91dC5jYWxsKHNlbGYuY29udGV4dCkKfQoKZnVuY3Rpb24gY2FsbEludGVydmFsIChzZWxmKSB7CiAgc2VsZi5vbnRpbWVvdXQuY2FsbChzZWxmLmNvbnRleHQpCn0KbW9kdWxlLmV4cG9ydHMgPSBpc05vZGUoKQogID8gcmVxdWlyZSgnLi9ub2RlJykKICA6IHJlcXVpcmUoJy4vYnJvd3NlcicpCgpmdW5jdGlvbiBpc05vZGUgKCkgewogIGNvbnN0IHRvID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7fSwgMTAwMCkKICBjbGVhclRpbWVvdXQodG8pCiAgcmV0dXJuICEhdG8ucmVmcmVzaAp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVGltZXIgewogIGNvbnN0cnVjdG9yIChtcywgZm4sIGN0eCA9IG51bGwsIGludGVydmFsID0gZmFsc2UpIHsKICAgIHRoaXMubXMgPSBtcwogICAgdGhpcy5vbnRpbWVvdXQgPSBmbgogICAgdGhpcy5jb250ZXh0ID0gY3R4CiAgICB0aGlzLmludGVydmFsID0gaW50ZXJ2YWwKICAgIHRoaXMuZG9uZSA9IGZhbHNlCgogICAgdGhpcy5fdGltZXIgPSBpbnRlcnZhbAogICAgICA/IHNldEludGVydmFsKGNhbGxJbnRlcnZhbCwgbXMsIHRoaXMpCiAgICAgIDogc2V0VGltZW91dChjYWxsVGltZW91dCwgbXMsIHRoaXMpCiAgfQoKICB1bnJlZiAoKSB7CiAgICB0aGlzLl90aW1lci51bnJlZigpCiAgfQoKICByZWYgKCkgewogICAgdGhpcy5fdGltZXIucmVmKCkKICB9CgogIHJlZnJlc2ggKCkgewogICAgaWYgKHRoaXMuZG9uZSAhPT0gdHJ1ZSkgdGhpcy5fdGltZXIucmVmcmVzaCgpCiAgfQoKICBkZXN0cm95ICgpIHsKICAgIHRoaXMuZG9uZSA9IHRydWUKICAgIHRoaXMub250aW1lb3V0ID0gbnVsbAogICAgaWYgKHRoaXMuaW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwodGhpcy5fdGltZXIpCiAgICBlbHNlIGNsZWFyVGltZW91dCh0aGlzLl90aW1lcikKICB9CgogIHN0YXRpYyBvbmNlIChtcywgZm4sIGN0eCkgewogICAgcmV0dXJuIG5ldyB0aGlzKG1zLCBmbiwgY3R4LCBmYWxzZSkKICB9CgogIHN0YXRpYyBvbiAobXMsIGZuLCBjdHgpIHsKICAgIHJldHVybiBuZXcgdGhpcyhtcywgZm4sIGN0eCwgdHJ1ZSkKICB9Cn0KCmZ1bmN0aW9uIGNhbGxUaW1lb3V0IChzZWxmKSB7CiAgc2VsZi5kb25lID0gdHJ1ZQogIHNlbGYub250aW1lb3V0LmNhbGwoc2VsZi5jb250ZXh0KQp9CgpmdW5jdGlvbiBjYWxsSW50ZXJ2YWwgKHNlbGYpIHsKICBzZWxmLm9udGltZW91dC5jYWxsKHNlbGYuY29udGV4dCkKfQp7CiAgIm5hbWUiOiAidGltZW91dC1yZWZyZXNoIiwKICAidmVyc2lvbiI6ICIyLjAuMSIsCiAgImRlc2NyaXB0aW9uIjogIkVmZmljaWVudGx5IHJlZnJlc2ggYSB0aW1lciIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xNi4wLjQiLAogICAgInRhcGUiOiAiXjUuNS4yIgogIH0sCiAgImJyb3dzZXIiOiAiLi9icm93c2VyLmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC90aW1lb3V0LXJlZnJlc2guZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3RpbWVvdXQtcmVmcmVzaC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC90aW1lb3V0LXJlZnJlc2giCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQnVmZmVyTWFwIHsKICBjb25zdHJ1Y3RvciAob3RoZXIpIHsKICAgIHRoaXMubSA9IG90aGVyID8gbmV3IE1hcChbLi4ub3RoZXIubV0pIDogbmV3IE1hcCgpCiAgfQoKICBnZXQgc2l6ZSAoKSB7CiAgICByZXR1cm4gdGhpcy5tLnNpemUKICB9CgogIGdldCAoa2V5KSB7CiAgICBpZiAoYjRhLmlzQnVmZmVyKGtleSkpIGtleSA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQogICAgcmV0dXJuIHRoaXMubS5nZXQoa2V5KQogIH0KCiAgc2V0IChrZXksIHZhbHVlKSB7CiAgICBpZiAoYjRhLmlzQnVmZmVyKGtleSkpIGtleSA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQogICAgcmV0dXJuIHRoaXMubS5zZXQoa2V5LCB2YWx1ZSkKICB9CgogIGRlbGV0ZSAoa2V5KSB7CiAgICBpZiAoYjRhLmlzQnVmZmVyKGtleSkpIGtleSA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQogICAgcmV0dXJuIHRoaXMubS5kZWxldGUoa2V5KQogIH0KCiAgaGFzIChrZXkpIHsKICAgIGlmIChiNGEuaXNCdWZmZXIoa2V5KSkga2V5ID0gYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpCiAgICByZXR1cm4gdGhpcy5tLmhhcyhrZXkpCiAgfQoKICAqIFtTeW1ib2wuaXRlcmF0b3JdICgpIHsKICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHRoaXMubSkgewogICAgICB5aWVsZCBbYjRhLmZyb20oa2V5LCAnaGV4JyksIHZhbHVlXQogICAgfQogIH0KCiAgKiBrZXlzICgpIHsKICAgIGZvciAoY29uc3Qga2V5IG9mIHRoaXMubS5rZXlzKCkpIHsKICAgICAgeWllbGQgYjRhLmZyb20oa2V5LCAnaGV4JykKICAgIH0KICB9CgogIHZhbHVlcyAoKSB7CiAgICByZXR1cm4gdGhpcy5tLnZhbHVlcygpCiAgfQoKICBjbGVhciAoKSB7CiAgICByZXR1cm4gdGhpcy5tLmNsZWFyKCkKICB9Cn0KewogICJuYW1lIjogInRpbnktYnVmZmVyLW1hcCIsCiAgInZlcnNpb24iOiAiMS4xLjEiLAogICJkZXNjcmlwdGlvbiI6ICJBIHZlcnkgc2ltcGxlIG1hcCBmb3IgQnVmZmVycyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAiYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2FuZHJld29zaC90aW55LWJ1ZmZlci1tYXAuZ2l0IgogIH0sCiAgImtleXdvcmRzIjogWwogICAgImJ1ZmZlciIsCiAgICAibWFwIgogIF0sCiAgImF1dGhvciI6ICJBbmRyZXcgT3NoZXJvZmYgPGFuZHJld29zaEBnbWFpbC5jb20+IiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vYW5kcmV3b3NoL3RpbnktYnVmZmVyLW1hcC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2FuZHJld29zaC90aW55LWJ1ZmZlci1tYXAjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMC40IgogIH0KfQpyZXF1aXJlLmFkZG9uID0gcmVxdWlyZSgncmVxdWlyZS1hZGRvbicpCgptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUuYWRkb24oJy4nLCBfX2ZpbGVuYW1lKQovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgpjb25zdCB2NFNlZyA9ICcoPzpbMC05XXxbMS05XVswLTldfDFbMC05XVswLTldfDJbMC00XVswLTldfDI1WzAtNV0pJwpjb25zdCB2NFN0ciA9IGAoJHt2NFNlZ31bLl0pezN9JHt2NFNlZ31gCmNvbnN0IElQdjRQYXR0ZXJuID0gbmV3IFJlZ0V4cChgXiR7djRTdHJ9JGApCgpjb25zdCB2NlNlZyA9ICcoPzpbMC05YS1mQS1GXXsxLDR9KScKY29uc3QgSVB2NlBhdHRlcm4gPSBuZXcgUmVnRXhwKAogICdeKCcgKwogICAgYCg/OiR7djZTZWd9Oil7N30oPzoke3Y2U2VnfXw6KXxgICsKICAgIGAoPzoke3Y2U2VnfTopezZ9KD86JHt2NFN0cn18OiR7djZTZWd9fDopfGAgKwogICAgYCg/OiR7djZTZWd9Oil7NX0oPzo6JHt2NFN0cn18KDoke3Y2U2VnfSl7MSwyfXw6KXxgICsKICAgIGAoPzoke3Y2U2VnfTopezR9KD86KDoke3Y2U2VnfSl7MCwxfToke3Y0U3RyfXwoOiR7djZTZWd9KXsxLDN9fDopfGAgKwogICAgYCg/OiR7djZTZWd9Oil7M30oPzooOiR7djZTZWd9KXswLDJ9OiR7djRTdHJ9fCg6JHt2NlNlZ30pezEsNH18Oil8YCArCiAgICBgKD86JHt2NlNlZ306KXsyfSg/Oig6JHt2NlNlZ30pezAsM306JHt2NFN0cn18KDoke3Y2U2VnfSl7MSw1fXw6KXxgICsKICAgIGAoPzoke3Y2U2VnfTopezF9KD86KDoke3Y2U2VnfSl7MCw0fToke3Y0U3RyfXwoOiR7djZTZWd9KXsxLDZ9fDopfGAgKwogICAgYCg/OjooKD86OiR7djZTZWd9KXswLDV9OiR7djRTdHJ9fCg/Ojoke3Y2U2VnfSl7MSw3fXw6KSlgICsKICAgICcpKCVbMC05YS16QS1aLS46XXsxLH0pPyQnCikKCmNvbnN0IGlzSVB2NCA9IChleHBvcnRzLmlzSVB2NCA9IGZ1bmN0aW9uIGlzSVB2NChob3N0KSB7CiAgcmV0dXJuIElQdjRQYXR0ZXJuLnRlc3QoaG9zdCkKfSkKCmNvbnN0IGlzSVB2NiA9IChleHBvcnRzLmlzSVB2NiA9IGZ1bmN0aW9uIGlzSVB2Nihob3N0KSB7CiAgcmV0dXJuIElQdjZQYXR0ZXJuLnRlc3QoaG9zdCkKfSkKCmV4cG9ydHMuaXNJUCA9IGZ1bmN0aW9uIGlzSVAoaG9zdCkgewogIGlmIChpc0lQdjQoaG9zdCkpIHJldHVybiA0CiAgaWYgKGlzSVB2Nihob3N0KSkgcmV0dXJuIDYKICByZXR1cm4gMAp9CmNvbnN0IGV2ZW50cyA9IHJlcXVpcmUoJ2V2ZW50cycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgTmV0d29ya0ludGVyZmFjZXMgZXh0ZW5kcyBldmVudHMuRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3Rvcih1ZHgpIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLl9oYW5kbGUgPSBiNGEuYWxsb2MoYmluZGluZy5zaXplb2ZfdWR4X25hcGlfaW50ZXJmYWNlX2V2ZW50X3QpCiAgICB0aGlzLl93YXRjaGluZyA9IGZhbHNlCiAgICB0aGlzLl9kZXN0cm95aW5nID0gbnVsbAoKICAgIGJpbmRpbmcudWR4X25hcGlfaW50ZXJmYWNlX2V2ZW50X2luaXQoCiAgICAgIHVkeC5faGFuZGxlLAogICAgICB0aGlzLl9oYW5kbGUsCiAgICAgIHRoaXMsCiAgICAgIHRoaXMuX29uZXZlbnQsCiAgICAgIHRoaXMuX29uY2xvc2UKICAgICkKCiAgICB0aGlzLmludGVyZmFjZXMgPSBiaW5kaW5nLnVkeF9uYXBpX2ludGVyZmFjZV9ldmVudF9nZXRfYWRkcnModGhpcy5faGFuZGxlKQogIH0KCiAgX29uY2xvc2UoKSB7CiAgICB0aGlzLmVtaXQoJ2Nsb3NlJykKICB9CgogIF9vbmV2ZW50KCkgewogICAgdGhpcy5pbnRlcmZhY2VzID0gYmluZGluZy51ZHhfbmFwaV9pbnRlcmZhY2VfZXZlbnRfZ2V0X2FkZHJzKHRoaXMuX2hhbmRsZSkKCiAgICB0aGlzLmVtaXQoJ2NoYW5nZScsIHRoaXMuaW50ZXJmYWNlcykKICB9CgogIHdhdGNoKCkgewogICAgaWYgKHRoaXMuX3dhdGNoaW5nKSByZXR1cm4gdGhpcwogICAgdGhpcy5fd2F0Y2hpbmcgPSB0cnVlCgogICAgYmluZGluZy51ZHhfbmFwaV9pbnRlcmZhY2VfZXZlbnRfc3RhcnQodGhpcy5faGFuZGxlKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICB1bndhdGNoKCkgewogICAgaWYgKCF0aGlzLl93YXRjaGluZykgcmV0dXJuIHRoaXMKICAgIHRoaXMuX3dhdGNoaW5nID0gZmFsc2UKCiAgICBiaW5kaW5nLnVkeF9uYXBpX2ludGVyZmFjZV9ldmVudF9zdG9wKHRoaXMuX2hhbmRsZSkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgYXN5bmMgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLl9kZXN0cm95aW5nKSByZXR1cm4gdGhpcy5fZGVzdHJveWluZwogICAgdGhpcy5fZGVzdHJveWluZyA9IGV2ZW50cy5vbmNlKHRoaXMsICdjbG9zZScpCgogICAgYmluZGluZy51ZHhfbmFwaV9pbnRlcmZhY2VfZXZlbnRfY2xvc2UodGhpcy5faGFuZGxlKQoKICAgIHJldHVybiB0aGlzLl9kZXN0cm95aW5nCiAgfQoKICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLmludGVyZmFjZXNbU3ltYm9sLml0ZXJhdG9yXSgpCiAgfQp9CmNvbnN0IGV2ZW50cyA9IHJlcXVpcmUoJ2V2ZW50cycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKY29uc3QgaXAgPSByZXF1aXJlKCcuL2lwJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVURYU29ja2V0IGV4dGVuZHMgZXZlbnRzLkV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IodWR4LCBvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLnVkeCA9IHVkeAoKICAgIHRoaXMuX2hhbmRsZSA9IGI0YS5hbGxvYyhiaW5kaW5nLnNpemVvZl91ZHhfbmFwaV9zb2NrZXRfdCkKICAgIHRoaXMuX2luaXRlZCA9IGZhbHNlCiAgICB0aGlzLl9ob3N0ID0gbnVsbAogICAgdGhpcy5fZmFtaWx5ID0gMAogICAgdGhpcy5faXB2Nk9ubHkgPSBvcHRzLmlwdjZPbmx5ID09PSB0cnVlCiAgICB0aGlzLl9yZXVzZUFkZHJlc3MgPSBvcHRzLnJldXNlQWRkcmVzcyA9PT0gdHJ1ZQogICAgdGhpcy5fcG9ydCA9IDAKICAgIHRoaXMuX3JlcXMgPSBbXQogICAgdGhpcy5fZnJlZSA9IFtdCiAgICB0aGlzLl9jbG9zaW5nID0gbnVsbAogICAgdGhpcy5fY2xvc2VkID0gZmFsc2UKCiAgICB0aGlzLl92aWV3NjQgPSBuZXcgQmlnVWludDY0QXJyYXkoCiAgICAgIHRoaXMuX2hhbmRsZS5idWZmZXIsCiAgICAgIHRoaXMuX2hhbmRsZS5ieXRlT2Zmc2V0LAogICAgICB0aGlzLl9oYW5kbGUuYnl0ZUxlbmd0aCA+PiAzCiAgICApCgogICAgdGhpcy5zdHJlYW1zID0gbmV3IFNldCgpCgogICAgdGhpcy51c2VyRGF0YSA9IG51bGwKICB9CgogIGdldCBib3VuZCgpIHsKICAgIHJldHVybiB0aGlzLl9wb3J0ICE9PSAwCiAgfQoKICBnZXQgY2xvc2luZygpIHsKICAgIHJldHVybiB0aGlzLl9jbG9zaW5nICE9PSBudWxsCiAgfQoKICBnZXQgaWRsZSgpIHsKICAgIHJldHVybiB0aGlzLnN0cmVhbXMuc2l6ZSA9PT0gMAogIH0KCiAgZ2V0IGJ1c3koKSB7CiAgICByZXR1cm4gdGhpcy5zdHJlYW1zLnNpemUgPiAwCiAgfQoKICBnZXQgYnl0ZXNUcmFuc21pdHRlZCgpIHsKICAgIGlmICh0aGlzLl9pbml0ZWQgIT09IHRydWUpIHJldHVybiAwCiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF9zb2NrZXRfdF9ieXRlc190eCA+PiAzXSkKICB9CgogIGdldCBwYWNrZXRzVHJhbnNtaXR0ZWQoKSB7CiAgICBpZiAodGhpcy5faW5pdGVkICE9PSB0cnVlKSByZXR1cm4gMAogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfc29ja2V0X3RfcGFja2V0c190eCA+PiAzXSkKICB9CgogIGdldCBieXRlc1JlY2VpdmVkKCkgewogICAgaWYgKHRoaXMuX2luaXRlZCAhPT0gdHJ1ZSkgcmV0dXJuIDAKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3NvY2tldF90X2J5dGVzX3J4ID4+IDNdKQogIH0KCiAgZ2V0IHBhY2tldHNSZWNlaXZlZCgpIHsKICAgIGlmICh0aGlzLl9pbml0ZWQgIT09IHRydWUpIHJldHVybiAwCiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF9zb2NrZXRfdF9wYWNrZXRzX3J4ID4+IDNdKQogIH0KCiAgZ2V0IHBhY2tldHNEcm9wcGVkQnlLZXJuZWwoKSB7CiAgICBpZiAodGhpcy5faW5pdGVkICE9PSB0cnVlKSByZXR1cm4gMAogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfc29ja2V0X3RfcGFja2V0c19kcm9wcGVkX2J5X2tlcm5lbCA+PiAzXSkKICB9CgogIHRvSlNPTigpIHsKICAgIHJldHVybiB7CiAgICAgIGJvdW5kOiB0aGlzLmJvdW5kLAogICAgICBjbG9zaW5nOiB0aGlzLmNsb3NpbmcsCiAgICAgIHN0cmVhbXM6IHRoaXMuc3RyZWFtcy5zaXplLAogICAgICBhZGRyZXNzOiB0aGlzLmFkZHJlc3MoKSwKICAgICAgaXB2Nk9ubHk6IHRoaXMuX2lwdjZPbmx5LAogICAgICByZXVzZUFkZHJlc3M6IHRoaXMuX3JldXNlQWRkcmVzcywKICAgICAgaWRsZTogdGhpcy5pZGxlLAogICAgICBidXN5OiB0aGlzLmJ1c3kKICAgIH0KICB9CgogIF9pbml0KCkgewogICAgaWYgKHRoaXMuX2luaXRlZCkgcmV0dXJuCgogICAgYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfaW5pdCgKICAgICAgdGhpcy51ZHguX2hhbmRsZSwKICAgICAgdGhpcy5faGFuZGxlLAogICAgICB0aGlzLAogICAgICB0aGlzLl9vbnNlbmQsCiAgICAgIHRoaXMuX29ubWVzc2FnZSwKICAgICAgdGhpcy5fb25jbG9zZSwKICAgICAgdGhpcy5fcmVhbGxvY01lc3NhZ2UKICAgICkKCiAgICB0aGlzLl9pbml0ZWQgPSB0cnVlCiAgfQoKICBfb25zZW5kKGlkLCBlcnIpIHsKICAgIGNvbnN0IHJlcSA9IHRoaXMuX3JlcXNbaWRdCgogICAgY29uc3Qgb25mbHVzaCA9IHJlcS5vbmZsdXNoCgogICAgcmVxLmJ1ZmZlciA9IG51bGwKICAgIHJlcS5vbmZsdXNoID0gbnVsbAoKICAgIHRoaXMuX2ZyZWUucHVzaChpZCkKCiAgICBvbmZsdXNoKGVyciA+PSAwKQoKICAgIC8vIGdjIHRoZSBmcmVlIGxpc3QKICAgIGlmICh0aGlzLl9mcmVlLmxlbmd0aCA+PSAxNiAmJiB0aGlzLl9mcmVlLmxlbmd0aCA9PT0gdGhpcy5fcmVxcy5sZW5ndGgpIHsKICAgICAgdGhpcy5fZnJlZSA9IFtdCiAgICAgIHRoaXMuX3JlcXMgPSBbXQogICAgfQogIH0KCiAgX29ubWVzc2FnZShsZW4sIHBvcnQsIGhvc3QsIGZhbWlseSkgewogICAgdGhpcy5lbWl0KCdtZXNzYWdlJywgdGhpcy51ZHguX2NvbnN1bWVNZXNzYWdlKGxlbiksIHsgaG9zdCwgZmFtaWx5LCBwb3J0IH0pCiAgICByZXR1cm4gdGhpcy51ZHguX2J1ZmZlcgogIH0KCiAgX29uY2xvc2UoKSB7CiAgICB0aGlzLmVtaXQoJ2Nsb3NlJykKICB9CgogIF9yZWFsbG9jTWVzc2FnZSgpIHsKICAgIHJldHVybiB0aGlzLnVkeC5fcmVhbGxvY01lc3NhZ2UoKQogIH0KCiAgX29uaWRsZSgpIHsKICAgIHRoaXMuZW1pdCgnaWRsZScpCiAgfQoKICBfb25idXN5KCkgewogICAgdGhpcy5lbWl0KCdidXN5JykKICB9CgogIF9hZGRTdHJlYW0oc3RyZWFtKSB7CiAgICBpZiAodGhpcy5zdHJlYW1zLmhhcyhzdHJlYW0pKSByZXR1cm4gZmFsc2UKICAgIHRoaXMuc3RyZWFtcy5hZGQoc3RyZWFtKQogICAgaWYgKHRoaXMuc3RyZWFtcy5zaXplID09PSAxKSB0aGlzLl9vbmJ1c3koKQogICAgcmV0dXJuIHRydWUKICB9CgogIF9yZW1vdmVTdHJlYW0oc3RyZWFtKSB7CiAgICBpZiAoIXRoaXMuc3RyZWFtcy5oYXMoc3RyZWFtKSkgcmV0dXJuIGZhbHNlCiAgICB0aGlzLnN0cmVhbXMuZGVsZXRlKHN0cmVhbSkKICAgIGNvbnN0IGNsb3NlZCA9IHRoaXMuX2Nsb3NlTWF5YmUoKQogICAgaWYgKHRoaXMuaWRsZSAmJiAhY2xvc2VkKSB0aGlzLl9vbmlkbGUoKQogICAgcmV0dXJuIHRydWUKICB9CgogIGFkZHJlc3MoKSB7CiAgICBpZiAoIXRoaXMuYm91bmQpIHJldHVybiBudWxsCiAgICByZXR1cm4geyBob3N0OiB0aGlzLl9ob3N0LCBmYW1pbHk6IHRoaXMuX2ZhbWlseSwgcG9ydDogdGhpcy5fcG9ydCB9CiAgfQoKICBiaW5kKHBvcnQsIGhvc3QpIHsKICAgIGlmICh0aGlzLmJvdW5kKSB0aHJvdyBuZXcgRXJyb3IoJ0FscmVhZHkgYm91bmQnKQogICAgaWYgKHRoaXMuY2xvc2luZykgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgaXMgY2xvc2VkJykKCiAgICBpZiAoIXBvcnQpIHBvcnQgPSAwCgogICAgbGV0IGZsYWdzID0gMAogICAgaWYgKHRoaXMuX2lwdjZPbmx5KSBmbGFncyB8PSBiaW5kaW5nLlVWX1VEUF9JUFY2T05MWQogICAgaWYgKHRoaXMuX3JldXNlQWRkcmVzcykgZmxhZ3MgfD0gYmluZGluZy5VVl9VRFBfUkVVU0VBRERSCgogICAgbGV0IGZhbWlseQoKICAgIGlmIChob3N0KSB7CiAgICAgIGZhbWlseSA9IGlwLmlzSVAoaG9zdCkKICAgICAgaWYgKCFmYW1pbHkpIHRocm93IG5ldyBFcnJvcihgJHtob3N0fSBpcyBub3QgYSB2YWxpZCBJUCBhZGRyZXNzYCkKCiAgICAgIGlmICghdGhpcy5faW5pdGVkKSB0aGlzLl9pbml0KCkKCiAgICAgIHRoaXMuX3BvcnQgPSBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9iaW5kKHRoaXMuX2hhbmRsZSwgcG9ydCwgaG9zdCwgZmFtaWx5LCBmbGFncykKICAgIH0gZWxzZSB7CiAgICAgIGlmICghdGhpcy5faW5pdGVkKSB0aGlzLl9pbml0KCkKCiAgICAgIHRyeSB7CiAgICAgICAgaG9zdCA9ICc6OicKICAgICAgICBmYW1pbHkgPSA2CiAgICAgICAgdGhpcy5fcG9ydCA9IGJpbmRpbmcudWR4X25hcGlfc29ja2V0X2JpbmQodGhpcy5faGFuZGxlLCBwb3J0LCBob3N0LCBmYW1pbHksIGZsYWdzKQogICAgICB9IGNhdGNoIHsKICAgICAgICBob3N0ID0gJzAuMC4wLjAnCiAgICAgICAgZmFtaWx5ID0gNAogICAgICAgIHRoaXMuX3BvcnQgPSBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9iaW5kKHRoaXMuX2hhbmRsZSwgcG9ydCwgaG9zdCwgZmFtaWx5LCBmbGFncykKICAgICAgfQogICAgfQoKICAgIHRoaXMuX2hvc3QgPSBob3N0CiAgICB0aGlzLl9mYW1pbHkgPSBmYW1pbHkKCiAgICB0aGlzLmVtaXQoJ2xpc3RlbmluZycpCiAgfQoKICBhc3luYyBjbG9zZSgpIHsKICAgIGlmICh0aGlzLl9jbG9zaW5nKSByZXR1cm4gdGhpcy5fY2xvc2luZwogICAgdGhpcy5fY2xvc2luZyA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB0aGlzLm9uY2UoJ2Nsb3NlJywgcmVzb2x2ZSkpCiAgICB0aGlzLl9jbG9zZU1heWJlKCkKICAgIHJldHVybiB0aGlzLl9jbG9zaW5nCiAgfQoKICBfY2xvc2VNYXliZSgpIHsKICAgIGlmICh0aGlzLl9jbG9zZWQgfHwgdGhpcy5fY2xvc2luZyA9PT0gbnVsbCkgcmV0dXJuIHRoaXMuX2Nsb3NlZAoKICAgIGlmICghdGhpcy5faW5pdGVkKSB7CiAgICAgIHRoaXMuX2Nsb3NlZCA9IHRydWUKICAgICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgaWYgKHRoaXMuaWRsZSkgewogICAgICBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9jbG9zZSh0aGlzLl9oYW5kbGUpCiAgICAgIHRoaXMuX2Nsb3NlZCA9IHRydWUKICAgIH0KCiAgICByZXR1cm4gdGhpcy5fY2xvc2VkCiAgfQoKICBzZXRUVEwodHRsKSB7CiAgICBpZiAoIXRoaXMuX2luaXRlZCkgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgbm90IGFjdGl2ZScpCiAgICBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9zZXRfdHRsKHRoaXMuX2hhbmRsZSwgdHRsKQogIH0KCiAgZ2V0UmVjdkJ1ZmZlclNpemUoKSB7CiAgICBpZiAoIXRoaXMuX2luaXRlZCkgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgbm90IGFjdGl2ZScpCiAgICByZXR1cm4gYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfZ2V0X3JlY3ZfYnVmZmVyX3NpemUodGhpcy5faGFuZGxlKQogIH0KCiAgc2V0UmVjdkJ1ZmZlclNpemUoc2l6ZSkgewogICAgaWYgKCF0aGlzLl9pbml0ZWQpIHRocm93IG5ldyBFcnJvcignU29ja2V0IG5vdCBhY3RpdmUnKQogICAgcmV0dXJuIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X3NldF9yZWN2X2J1ZmZlcl9zaXplKHRoaXMuX2hhbmRsZSwgc2l6ZSkKICB9CgogIGdldFNlbmRCdWZmZXJTaXplKCkgewogICAgaWYgKCF0aGlzLl9pbml0ZWQpIHRocm93IG5ldyBFcnJvcignU29ja2V0IG5vdCBhY3RpdmUnKQogICAgcmV0dXJuIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X2dldF9zZW5kX2J1ZmZlcl9zaXplKHRoaXMuX2hhbmRsZSkKICB9CgogIHNldFNlbmRCdWZmZXJTaXplKHNpemUpIHsKICAgIGlmICghdGhpcy5faW5pdGVkKSB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCBub3QgYWN0aXZlJykKICAgIHJldHVybiBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9zZXRfc2VuZF9idWZmZXJfc2l6ZSh0aGlzLl9oYW5kbGUsIHNpemUpCiAgfQoKICBhZGRNZW1iZXJzaGlwKGdyb3VwLCBpZmFjZUFkZHJlc3MpIHsKICAgIGlmICghdGhpcy5faW5pdGVkKSB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCBub3QgYWN0aXZlJykKICAgIHJldHVybiBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9zZXRfbWVtYmVyc2hpcCh0aGlzLl9oYW5kbGUsIGdyb3VwLCBpZmFjZUFkZHJlc3MgfHwgJycsIHRydWUpCiAgfQoKICBkcm9wTWVtYmVyc2hpcChncm91cCwgaWZhY2VBZGRyZXNzKSB7CiAgICBpZiAoIXRoaXMuX2luaXRlZCkgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgbm90IGFjdGl2ZScpCiAgICByZXR1cm4gYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfc2V0X21lbWJlcnNoaXAodGhpcy5faGFuZGxlLCBncm91cCwgaWZhY2VBZGRyZXNzIHx8ICcnLCBmYWxzZSkKICB9CgogIGFzeW5jIHNlbmQoYnVmZmVyLCBwb3J0LCBob3N0LCB0dGwpIHsKICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybiBmYWxzZQoKICAgIGlmICghaG9zdCkgaG9zdCA9ICcxMjcuMC4wLjEnCgogICAgY29uc3QgZmFtaWx5ID0gaXAuaXNJUChob3N0KQogICAgaWYgKCFmYW1pbHkpIHRocm93IG5ldyBFcnJvcihgJHtob3N0fSBpcyBub3QgYSB2YWxpZCBJUCBhZGRyZXNzYCkKCiAgICBpZiAoIXRoaXMuYm91bmQpIHRoaXMuYmluZCgwKQoKICAgIGNvbnN0IGlkID0gdGhpcy5fYWxsb2NTZW5kKCkKICAgIGNvbnN0IHJlcSA9IHRoaXMuX3JlcXNbaWRdCgogICAgcmVxLmJ1ZmZlciA9IGJ1ZmZlcgoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICByZXEub25mbHVzaCA9IHJlc29sdmUKICAgIH0pCgogICAgYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfc2VuZF90dGwoCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgcmVxLmhhbmRsZSwKICAgICAgaWQsCiAgICAgIGJ1ZmZlciwKICAgICAgcG9ydCwKICAgICAgaG9zdCwKICAgICAgZmFtaWx5LAogICAgICB0dGwgfHwgMAogICAgKQoKICAgIHJldHVybiBwcm9taXNlCiAgfQoKICB0cnlTZW5kKGJ1ZmZlciwgcG9ydCwgaG9zdCwgdHRsKSB7CiAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4KCiAgICBpZiAoIWhvc3QpIGhvc3QgPSAnMTI3LjAuMC4xJwoKICAgIGNvbnN0IGZhbWlseSA9IGlwLmlzSVAoaG9zdCkKICAgIGlmICghZmFtaWx5KSB0aHJvdyBuZXcgRXJyb3IoYCR7aG9zdH0gaXMgbm90IGEgdmFsaWQgSVAgYWRkcmVzc2ApCgogICAgaWYgKCF0aGlzLmJvdW5kKSB0aGlzLmJpbmQoMCkKCiAgICBjb25zdCBpZCA9IHRoaXMuX2FsbG9jU2VuZCgpCiAgICBjb25zdCByZXEgPSB0aGlzLl9yZXFzW2lkXQoKICAgIHJlcS5idWZmZXIgPSBidWZmZXIKICAgIHJlcS5vbmZsdXNoID0gbm9vcAoKICAgIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X3NlbmRfdHRsKAogICAgICB0aGlzLl9oYW5kbGUsCiAgICAgIHJlcS5oYW5kbGUsCiAgICAgIGlkLAogICAgICBidWZmZXIsCiAgICAgIHBvcnQsCiAgICAgIGhvc3QsCiAgICAgIGZhbWlseSwKICAgICAgdHRsIHx8IDAKICAgICkKICB9CgogIF9hbGxvY1NlbmQoKSB7CiAgICBpZiAodGhpcy5fZnJlZS5sZW5ndGggPiAwKSByZXR1cm4gdGhpcy5fZnJlZS5wb3AoKQogICAgY29uc3QgaGFuZGxlID0gYjRhLmFsbG9jVW5zYWZlKGJpbmRpbmcuc2l6ZW9mX3VkeF9zb2NrZXRfc2VuZF90KQogICAgcmV0dXJuIHRoaXMuX3JlcXMucHVzaCh7IGhhbmRsZSwgYnVmZmVyOiBudWxsLCBvbmZsdXNoOiBudWxsIH0pIC0gMQogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IHN0cmVhbXggPSByZXF1aXJlKCdzdHJlYW14JykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQpjb25zdCBpcCA9IHJlcXVpcmUoJy4vaXAnKQoKY29uc3QgTUFYX1BBQ0tFVCA9IDIwNDgKY29uc3QgQlVGRkVSX1NJWkUgPSA2NTUzNiArIE1BWF9QQUNLRVQKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVURYU3RyZWFtIGV4dGVuZHMgc3RyZWFteC5EdXBsZXggewogIGNvbnN0cnVjdG9yKHVkeCwgaWQsIG9wdHMgPSB7fSkgewogICAgc3VwZXIoeyBtYXBXcml0YWJsZTogdG9CdWZmZXIsIGVhZ2VyT3BlbjogdHJ1ZSB9KQoKICAgIHRoaXMudWR4ID0gdWR4CiAgICB0aGlzLnNvY2tldCA9IG51bGwKCiAgICB0aGlzLl9oYW5kbGUgPSBiNGEuYWxsb2MoYmluZGluZy5zaXplb2ZfdWR4X25hcGlfc3RyZWFtX3QpCiAgICB0aGlzLl92aWV3ID0gbmV3IFVpbnQzMkFycmF5KAogICAgICB0aGlzLl9oYW5kbGUuYnVmZmVyLAogICAgICB0aGlzLl9oYW5kbGUuYnl0ZU9mZnNldCwKICAgICAgdGhpcy5faGFuZGxlLmJ5dGVMZW5ndGggPj4gMgogICAgKQogICAgdGhpcy5fdmlldzE2ID0gbmV3IFVpbnQxNkFycmF5KAogICAgICB0aGlzLl9oYW5kbGUuYnVmZmVyLAogICAgICB0aGlzLl9oYW5kbGUuYnl0ZU9mZnNldCwKICAgICAgdGhpcy5faGFuZGxlLmJ5dGVMZW5ndGggPj4gMQogICAgKQogICAgdGhpcy5fdmlldzY0ID0gbmV3IEJpZ1VpbnQ2NEFycmF5KAogICAgICB0aGlzLl9oYW5kbGUuYnVmZmVyLAogICAgICB0aGlzLl9oYW5kbGUuYnl0ZU9mZnNldCwKICAgICAgdGhpcy5faGFuZGxlLmJ5dGVMZW5ndGggPj4gMwogICAgKQoKICAgIHRoaXMuX3dyZXFzID0gW10KICAgIHRoaXMuX3dmcmVlID0gW10KCiAgICB0aGlzLl9zcmVxcyA9IFtdCiAgICB0aGlzLl9zZnJlZSA9IFtdCiAgICB0aGlzLl9jbG9zZWQgPSBmYWxzZQoKICAgIHRoaXMuX2ZsdXNoaW5nID0gMAogICAgdGhpcy5fZmx1c2hlcyA9IFtdCgogICAgdGhpcy5fYnVmZmVyID0gbnVsbAogICAgdGhpcy5fcmVhbGxvY0RhdGEoKQoKICAgIHRoaXMuX29ud3JpdGUgPSBudWxsCiAgICB0aGlzLl9vbmRlc3Ryb3kgPSBudWxsCiAgICB0aGlzLl9maXJld2FsbCA9IG9wdHMuZmlyZXdhbGwgfHwgZmlyZXdhbGxBbGwKCiAgICB0aGlzLl9yZW1vdGVDaGFuZ2luZyA9IG51bGwKICAgIHRoaXMuX3ByZXZpb3VzU29ja2V0ID0gbnVsbAoKICAgIHRoaXMuaWQgPSBpZAogICAgdGhpcy5yZW1vdGVJZCA9IDAKICAgIHRoaXMucmVtb3RlSG9zdCA9IG51bGwKICAgIHRoaXMucmVtb3RlRmFtaWx5ID0gMAogICAgdGhpcy5yZW1vdGVQb3J0ID0gMAoKICAgIHRoaXMudXNlckRhdGEgPSBudWxsCgogICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1faW5pdCgKICAgICAgdGhpcy51ZHguX2hhbmRsZSwKICAgICAgdGhpcy5faGFuZGxlLAogICAgICBpZCwKICAgICAgb3B0cy5mcmFtZWQgPyAxIDogMCwKICAgICAgdGhpcywKICAgICAgdGhpcy5fb25kYXRhLAogICAgICB0aGlzLl9vbmVuZCwKICAgICAgdGhpcy5fb25kcmFpbiwKICAgICAgdGhpcy5fb25hY2ssCiAgICAgIHRoaXMuX29uc2VuZCwKICAgICAgdGhpcy5fb25tZXNzYWdlLAogICAgICB0aGlzLl9vbmNsb3NlLAogICAgICB0aGlzLl9vbmZpcmV3YWxsLAogICAgICB0aGlzLl9vbnJlbW90ZWNoYW5nZWQsCiAgICAgIHRoaXMuX3JlYWxsb2NEYXRhLAogICAgICB0aGlzLl9yZWFsbG9jTWVzc2FnZQogICAgKQoKICAgIGlmIChvcHRzLnNlcSkgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fc2V0X3NlcSh0aGlzLl9oYW5kbGUsIG9wdHMuc2VxKQoKICAgIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX3JlY3Zfc3RhcnQodGhpcy5faGFuZGxlLCB0aGlzLl9idWZmZXIpCiAgfQoKICBnZXQgY29ubmVjdGVkKCkgewogICAgcmV0dXJuIHRoaXMuc29ja2V0ICE9PSBudWxsCiAgfQoKICBnZXQgbXR1KCkgewogICAgcmV0dXJuIHRoaXMuX3ZpZXcxNltiaW5kaW5nLm9mZnNldG9mX3VkeF9zdHJlYW1fdF9tdHUgPj4gMV0KICB9CgogIGdldCBydHQoKSB7CiAgICByZXR1cm4gdGhpcy5fdmlld1tiaW5kaW5nLm9mZnNldG9mX3VkeF9zdHJlYW1fdF9zcnR0ID4+IDJdCiAgfQoKICBnZXQgY3duZCgpIHsKICAgIHJldHVybiB0aGlzLl92aWV3W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X2N3bmQgPj4gMl0KICB9CgogIGdldCBydG9Db3VudCgpIHsKICAgIHJldHVybiB0aGlzLl92aWV3MTZbYmluZGluZy5vZmZzZXRvZl91ZHhfc3RyZWFtX3RfcnRvX2NvdW50ID4+IDFdCiAgfQoKICBnZXQgcmV0cmFuc21pdHMoKSB7CiAgICByZXR1cm4gdGhpcy5fdmlldzE2W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X3JldHJhbnNtaXRfY291bnQgPj4gMV0KICB9CgogIGdldCBmYXN0UmVjb3ZlcmllcygpIHsKICAgIHJldHVybiB0aGlzLl92aWV3MTZbYmluZGluZy5vZmZzZXRvZl91ZHhfc3RyZWFtX3RfZmFzdF9yZWNvdmVyeV9jb3VudCA+PiAxXQogIH0KCiAgZ2V0IGluZmxpZ2h0KCkgewogICAgcmV0dXJuIHRoaXMuX3ZpZXdbYmluZGluZy5vZmZzZXRvZl91ZHhfc3RyZWFtX3RfaW5mbGlnaHQgPj4gMl0KICB9CgogIGdldCBieXRlc1RyYW5zbWl0dGVkKCkgewogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfc3RyZWFtX3RfYnl0ZXNfdHggPj4gM10pCiAgfQoKICBnZXQgcGFja2V0c1RyYW5zbWl0dGVkKCkgewogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfc3RyZWFtX3RfcGFja2V0c190eCA+PiAzXSkKICB9CgogIGdldCBieXRlc1JlY2VpdmVkKCkgewogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfc3RyZWFtX3RfYnl0ZXNfcnggPj4gM10pCiAgfQoKICBnZXQgcGFja2V0c1JlY2VpdmVkKCkgewogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfc3RyZWFtX3RfcGFja2V0c19yeCA+PiAzXSkKICB9CgogIGdldCBsb2NhbEhvc3QoKSB7CiAgICByZXR1cm4gdGhpcy5zb2NrZXQgPyB0aGlzLnNvY2tldC5hZGRyZXNzKCkuaG9zdCA6IG51bGwKICB9CgogIGdldCBsb2NhbEZhbWlseSgpIHsKICAgIHJldHVybiB0aGlzLnNvY2tldCA/IHRoaXMuc29ja2V0LmFkZHJlc3MoKS5mYW1pbHkgOiAwCiAgfQoKICBnZXQgbG9jYWxQb3J0KCkgewogICAgcmV0dXJuIHRoaXMuc29ja2V0ID8gdGhpcy5zb2NrZXQuYWRkcmVzcygpLnBvcnQgOiAwCiAgfQoKICBzZXRJbnRlcmFjdGl2ZShib29sKSB7CiAgICBpZiAoIXRoaXMuX2Nsb3NlZCkgcmV0dXJuCiAgICBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV9zZXRfbW9kZSh0aGlzLl9oYW5kbGUsIGJvb2wgPyAwIDogMSkKICB9CgogIGNvbm5lY3Qoc29ja2V0LCByZW1vdGVJZCwgcG9ydCwgaG9zdCwgb3B0cyA9IHt9KSB7CiAgICBpZiAodGhpcy5fY2xvc2VkKSByZXR1cm4KCiAgICBpZiAodGhpcy5jb25uZWN0ZWQpIHRocm93IG5ldyBFcnJvcignQWxyZWFkeSBjb25uZWN0ZWQnKQogICAgaWYgKHNvY2tldC5jbG9zaW5nKSB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCBpcyBjbG9zZWQnKQoKICAgIGlmICh0eXBlb2YgaG9zdCA9PT0gJ29iamVjdCcpIHsKICAgICAgb3B0cyA9IGhvc3QKICAgICAgaG9zdCA9IG51bGwKICAgIH0KCiAgICBpZiAoIWhvc3QpIGhvc3QgPSAnMTI3LjAuMC4xJwoKICAgIGNvbnN0IGZhbWlseSA9IGlwLmlzSVAoaG9zdCkKICAgIGlmICghZmFtaWx5KSB0aHJvdyBuZXcgRXJyb3IoYCR7aG9zdH0gaXMgbm90IGEgdmFsaWQgSVAgYWRkcmVzc2ApCiAgICBpZiAoIShwb3J0ID4gMCAmJiBwb3J0IDwgNjU1MzYpKSB0aHJvdyBuZXcgRXJyb3IoYCR7cG9ydH0gaXMgbm90IGEgdmFsaWQgcG9ydGApCgogICAgaWYgKCFzb2NrZXQuYm91bmQpIHNvY2tldC5iaW5kKDApCgogICAgdGhpcy5yZW1vdGVJZCA9IHJlbW90ZUlkCiAgICB0aGlzLnJlbW90ZVBvcnQgPSBwb3J0CiAgICB0aGlzLnJlbW90ZUhvc3QgPSBob3N0CiAgICB0aGlzLnJlbW90ZUZhbWlseSA9IGZhbWlseQogICAgdGhpcy5zb2NrZXQgPSBzb2NrZXQKCiAgICBpZiAob3B0cy5hY2spIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX3NldF9hY2sodGhpcy5faGFuZGxlLCBvcHRzLmFjaykKCiAgICBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV9jb25uZWN0KHRoaXMuX2hhbmRsZSwgc29ja2V0Ll9oYW5kbGUsIHJlbW90ZUlkLCBwb3J0LCBob3N0LCBmYW1pbHkpCgogICAgdGhpcy5zb2NrZXQuX2FkZFN0cmVhbSh0aGlzKQoKICAgIHRoaXMuZW1pdCgnY29ubmVjdCcpCiAgfQoKICBjaGFuZ2VSZW1vdGUoc29ja2V0LCByZW1vdGVJZCwgcG9ydCwgaG9zdCkgewogICAgaWYgKHRoaXMuX3JlbW90ZUNoYW5naW5nKSB0aHJvdyBuZXcgRXJyb3IoJ1JlbW90ZSBhbHJlYWR5IGNoYW5naW5nJykKCiAgICBpZiAoIXRoaXMuY29ubmVjdGVkKSB0aHJvdyBuZXcgRXJyb3IoJ05vdCB5ZXQgY29ubmVjdGVkJykKICAgIGlmIChzb2NrZXQuY2xvc2luZykgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgaXMgY2xvc2VkJykKCiAgICBpZiAodGhpcy5zb2NrZXQudWR4ICE9PSBzb2NrZXQudWR4KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGNoYW5nZSB0byBhIHNvY2tldCBvbiBhbm90aGVyIFVEWCBpbnN0YW5jZScpCiAgICB9CgogICAgaWYgKCFob3N0KSBob3N0ID0gJzEyNy4wLjAuMScKCiAgICBjb25zdCBmYW1pbHkgPSBpcC5pc0lQKGhvc3QpCiAgICBpZiAoIWZhbWlseSkgdGhyb3cgbmV3IEVycm9yKGAke2hvc3R9IGlzIG5vdCBhIHZhbGlkIElQIGFkZHJlc3NgKQogICAgaWYgKCEocG9ydCA+IDAgJiYgcG9ydCA8IDY1NTM2KSkgdGhyb3cgbmV3IEVycm9yKGAke3BvcnR9IGlzIG5vdCBhIHZhbGlkIHBvcnRgKQoKICAgIGlmICh0aGlzLnNvY2tldCAhPT0gc29ja2V0KSB0aGlzLl9wcmV2aW91c1NvY2tldCA9IHRoaXMuc29ja2V0CgogICAgdGhpcy5yZW1vdGVJZCA9IHJlbW90ZUlkCiAgICB0aGlzLnJlbW90ZVBvcnQgPSBwb3J0CiAgICB0aGlzLnJlbW90ZUhvc3QgPSBob3N0CiAgICB0aGlzLnJlbW90ZUZhbWlseSA9IGZhbWlseQogICAgdGhpcy5zb2NrZXQgPSBzb2NrZXQKCiAgICB0aGlzLl9yZW1vdGVDaGFuZ2luZyA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgY29uc3Qgb25jaGFuZ2VkID0gKCkgPT4gewogICAgICAgIHRoaXMub2ZmKCdjbG9zZScsIG9uY2xvc2UpCiAgICAgICAgcmVzb2x2ZSgpCiAgICAgIH0KCiAgICAgIGNvbnN0IG9uY2xvc2UgPSAoKSA9PiB7CiAgICAgICAgdGhpcy5vZmYoJ3JlbW90ZS1jaGFuZ2VkJywgb25jaGFuZ2VkKQogICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ1N0cmVhbSBpcyBjbG9zZWQnKSkKICAgICAgfQoKICAgICAgdGhpcy5vbmNlKCdyZW1vdGUtY2hhbmdlZCcsIG9uY2hhbmdlZCkub25jZSgnY2xvc2UnLCBvbmNsb3NlKQogICAgfSkKCiAgICBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV9jaGFuZ2VfcmVtb3RlKAogICAgICB0aGlzLl9oYW5kbGUsCiAgICAgIHNvY2tldC5faGFuZGxlLAogICAgICByZW1vdGVJZCwKICAgICAgcG9ydCwKICAgICAgaG9zdCwKICAgICAgZmFtaWx5CiAgICApCgogICAgdGhpcy5zb2NrZXQuX2FkZFN0cmVhbSh0aGlzKQoKICAgIHJldHVybiB0aGlzLl9yZW1vdGVDaGFuZ2luZwogIH0KCiAgcmVsYXlUbyhkZXN0aW5hdGlvbikgewogICAgaWYgKHRoaXMuX2Nsb3NlZCkgcmV0dXJuCgogICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fcmVsYXlfdG8odGhpcy5faGFuZGxlLCBkZXN0aW5hdGlvbi5faGFuZGxlKQogIH0KCiAgYXN5bmMgc2VuZChidWZmZXIpIHsKICAgIGlmICghdGhpcy5jb25uZWN0ZWQgfHwgdGhpcy5fY2xvc2VkKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBpZCA9IHRoaXMuX2FsbG9jU2VuZCgpCiAgICBjb25zdCByZXEgPSB0aGlzLl9zcmVxc1tpZF0KCiAgICByZXEuYnVmZmVyID0gYnVmZmVyCgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgIHJlcS5vbmZsdXNoID0gcmVzb2x2ZQogICAgfSkKCiAgICBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV9zZW5kKHRoaXMuX2hhbmRsZSwgcmVxLmhhbmRsZSwgaWQsIGJ1ZmZlcikKCiAgICByZXR1cm4gcHJvbWlzZQogIH0KCiAgdHJ5U2VuZChidWZmZXIpIHsKICAgIGlmICghdGhpcy5jb25uZWN0ZWQgfHwgdGhpcy5fY2xvc2VkKSByZXR1cm4KCiAgICBjb25zdCBpZCA9IHRoaXMuX2FsbG9jU2VuZCgpCiAgICBjb25zdCByZXEgPSB0aGlzLl9zcmVxc1tpZF0KCiAgICByZXEuYnVmZmVyID0gYnVmZmVyCiAgICByZXEub25mbHVzaCA9IG5vb3AKCiAgICBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV9zZW5kKHRoaXMuX2hhbmRsZSwgcmVxLmhhbmRsZSwgaWQsIGJ1ZmZlcikKICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgaWYgKChhd2FpdCBzdHJlYW14LldyaXRhYmxlLmRyYWluZWQodGhpcykpID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlCiAgICBpZiAodGhpcy5kZXN0cm95aW5nKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBtaXNzaW5nID0gdGhpcy5fd3JlcXMubGVuZ3RoIC0gdGhpcy5fd2ZyZWUubGVuZ3RoCiAgICBpZiAobWlzc2luZyA9PT0gMCkgcmV0dXJuIHRydWUKCiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgdGhpcy5fZmx1c2hlcy5wdXNoKHsgZmx1c2g6IHRoaXMuX2ZsdXNoaW5nKyssIG1pc3NpbmcsIHJlc29sdmUgfSkKICAgIH0pCiAgfQoKICB0b0pTT04oKSB7CiAgICByZXR1cm4gewogICAgICBpZDogdGhpcy5pZCwKICAgICAgY29ubmVjdGVkOiB0aGlzLmNvbm5lY3RlZCwKICAgICAgZGVzdHJveWluZzogdGhpcy5kZXN0cm95aW5nLAogICAgICBkZXN0cm95ZWQ6IHRoaXMuZGVzdHJveWVkLAogICAgICByZW1vdGVJZDogdGhpcy5yZW1vdGVJZCwKICAgICAgcmVtb3RlSG9zdDogdGhpcy5yZW1vdGVIb3N0LAogICAgICByZW1vdGVGYW1pbHk6IHRoaXMucmVtb3RlRmFtaWx5LAogICAgICByZW1vdGVQb3J0OiB0aGlzLnJlbW90ZVBvcnQsCiAgICAgIG10dTogdGhpcy5tdHUsCiAgICAgIHJ0dDogdGhpcy5ydHQsCiAgICAgIGN3bmQ6IHRoaXMuY3duZCwKICAgICAgaW5mbGlnaHQ6IHRoaXMuaW5mbGlnaHQsCiAgICAgIHNvY2tldDogdGhpcy5zb2NrZXQgPyB0aGlzLnNvY2tldC50b0pTT04oKSA6IG51bGwKICAgIH0KICB9CgogIF9yZWFkKGNiKSB7CiAgICBjYihudWxsKQogIH0KCiAgX3dyaXRlQ29udGludWUoZXJyKSB7CiAgICBpZiAodGhpcy5fb253cml0ZSA9PT0gbnVsbCkgcmV0dXJuCiAgICBjb25zdCBjYiA9IHRoaXMuX29ud3JpdGUKICAgIHRoaXMuX29ud3JpdGUgPSBudWxsCiAgICBjYihlcnIpCiAgfQoKICBfZGVzdHJveUNvbnRpbnVlKGVycikgewogICAgaWYgKHRoaXMuX29uZGVzdHJveSA9PT0gbnVsbCkgcmV0dXJuCiAgICBjb25zdCBjYiA9IHRoaXMuX29uZGVzdHJveQogICAgdGhpcy5fb25kZXN0cm95ID0gbnVsbAogICAgY2IoZXJyKQogIH0KCiAgX3dyaXRldihidWZmZXJzLCBjYikgewogICAgaWYgKCF0aGlzLmNvbm5lY3RlZCkKICAgICAgdGhyb3cgY3VzdG9tRXJyb3IoJ1dyaXRpbmcgd2hpbGUgbm90IGNvbm5lY3RlZCBub3QgY3VycmVudGx5IHN1cHBvcnRlZCcsICdFUlJfQVNTRVJUSU9OJykKCiAgICBsZXQgZHJhaW5lZCA9IHRydWUKCiAgICBpZiAoYnVmZmVycy5sZW5ndGggPT09IDEpIHsKICAgICAgY29uc3QgaWQgPSB0aGlzLl9hbGxvY1dyaXRlKDEpCiAgICAgIGNvbnN0IHJlcSA9IHRoaXMuX3dyZXFzW2lkXQoKICAgICAgcmVxLmZsdXNoID0gdGhpcy5fZmx1c2hpbmcKICAgICAgcmVxLmJ1ZmZlciA9IGJ1ZmZlcnNbMF0KCiAgICAgIGRyYWluZWQgPSBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV93cml0ZSh0aGlzLl9oYW5kbGUsIHJlcS5oYW5kbGUsIGlkLCByZXEuYnVmZmVyKSAhPT0gMAogICAgfSBlbHNlIHsKICAgICAgY29uc3QgaWQgPSB0aGlzLl9hbGxvY1dyaXRlKG5leHRCYXRjaFNpemUoYnVmZmVycy5sZW5ndGgpKQogICAgICBjb25zdCByZXEgPSB0aGlzLl93cmVxc1tpZF0KCiAgICAgIHJlcS5mbHVzaCA9IHRoaXMuX2ZsdXNoaW5nCiAgICAgIHJlcS5idWZmZXJzID0gYnVmZmVycwoKICAgICAgZHJhaW5lZCA9IGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX3dyaXRldih0aGlzLl9oYW5kbGUsIHJlcS5oYW5kbGUsIGlkLCByZXEuYnVmZmVycykgIT09IDAKICAgIH0KCiAgICBpZiAoZHJhaW5lZCkgY2IobnVsbCkKICAgIGVsc2UgdGhpcy5fb253cml0ZSA9IGNiCiAgfQoKICBfZmluYWwoY2IpIHsKICAgIGNvbnN0IGlkID0gdGhpcy5fYWxsb2NXcml0ZSgxKQogICAgY29uc3QgcmVxID0gdGhpcy5fd3JlcXNbaWRdCgogICAgcmVxLmZsdXNoID0gdGhpcy5fZmx1c2hlcwogICAgcmVxLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZSgwKQoKICAgIGNvbnN0IGRyYWluZWQgPQogICAgICBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV93cml0ZV9lbmQodGhpcy5faGFuZGxlLCByZXEuaGFuZGxlLCBpZCwgcmVxLmJ1ZmZlcikgIT09IDAKCiAgICBpZiAoZHJhaW5lZCkgY2IobnVsbCkKICAgIGVsc2UgdGhpcy5fb253cml0ZSA9IGNiCiAgfQoKICBfcHJlZGVzdHJveSgpIHsKICAgIGlmICghdGhpcy5fY2xvc2VkKSBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV9kZXN0cm95KHRoaXMuX2hhbmRsZSkKICAgIHRoaXMuX2Nsb3NlZCA9IHRydWUKICAgIHRoaXMuX3dyaXRlQ29udGludWUobnVsbCkKICB9CgogIF9kZXN0cm95KGNiKSB7CiAgICBpZiAodGhpcy5jb25uZWN0ZWQpIHRoaXMuX29uZGVzdHJveSA9IGNiCiAgICBlbHNlIGNiKG51bGwpCiAgfQoKICBfb25kYXRhKHJlYWQpIHsKICAgIHRoaXMucHVzaCh0aGlzLl9jb25zdW1lRGF0YShyZWFkKSkKICAgIHJldHVybiB0aGlzLl9idWZmZXIKICB9CgogIF9vbmVuZChyZWFkKSB7CiAgICBpZiAocmVhZCA+IDApIHRoaXMucHVzaCh0aGlzLl9jb25zdW1lRGF0YShyZWFkKSkKICAgIHRoaXMucHVzaChudWxsKQogIH0KCiAgX29uZHJhaW4oKSB7CiAgICB0aGlzLl93cml0ZUNvbnRpbnVlKG51bGwpCiAgfQoKICBfZmx1c2hBY2soZmx1c2gpIHsKICAgIGZvciAobGV0IGkgPSB0aGlzLl9mbHVzaGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IGYgPSB0aGlzLl9mbHVzaGVzW2ldCiAgICAgIGlmIChmLmZsdXNoIDwgZmx1c2gpIGJyZWFrCiAgICAgIGYubWlzc2luZy0tCiAgICB9CgogICAgd2hpbGUgKHRoaXMuX2ZsdXNoZXMubGVuZ3RoID4gMCAmJiB0aGlzLl9mbHVzaGVzWzBdLm1pc3NpbmcgPT09IDApIHsKICAgICAgdGhpcy5fZmx1c2hlcy5zaGlmdCgpLnJlc29sdmUodHJ1ZSkKICAgIH0KICB9CgogIF9vbmFjayhpZCkgewogICAgY29uc3QgcmVxID0gdGhpcy5fd3JlcXNbaWRdCgogICAgcmVxLmJ1ZmZlcnMgPSByZXEuYnVmZmVyID0gbnVsbAogICAgdGhpcy5fd2ZyZWUucHVzaChpZCkKCiAgICBpZiAodGhpcy5fZmx1c2hlcy5sZW5ndGggPiAwKSB0aGlzLl9mbHVzaEFjayhyZXEuZmx1c2gpCgogICAgLy8gZ2MgdGhlIGZyZWUgbGlzdAogICAgaWYgKHRoaXMuX3dmcmVlLmxlbmd0aCA+PSA2NCAmJiB0aGlzLl93ZnJlZS5sZW5ndGggPT09IHRoaXMuX3dyZXFzLmxlbmd0aCkgewogICAgICB0aGlzLl93ZnJlZSA9IFtdCiAgICAgIHRoaXMuX3dyZXFzID0gW10KICAgIH0KICB9CgogIF9vbnNlbmQoaWQsIGVycikgewogICAgY29uc3QgcmVxID0gdGhpcy5fc3JlcXNbaWRdCgogICAgY29uc3Qgb25mbHVzaCA9IHJlcS5vbmZsdXNoCgogICAgcmVxLmJ1ZmZlciA9IG51bGwKICAgIHJlcS5vbmZsdXNoID0gbnVsbAoKICAgIHRoaXMuX3NmcmVlLnB1c2goaWQpCgogICAgb25mbHVzaChlcnIgPj0gMCkKCiAgICAvLyBnYyB0aGUgZnJlZSBsaXN0CiAgICBpZiAodGhpcy5fc2ZyZWUubGVuZ3RoID49IDE2ICYmIHRoaXMuX3NmcmVlLmxlbmd0aCA9PT0gdGhpcy5fc3JlcXMubGVuZ3RoKSB7CiAgICAgIHRoaXMuX3NmcmVlID0gW10KICAgICAgdGhpcy5fc3JlcXMgPSBbXQogICAgfQogIH0KCiAgX29ubWVzc2FnZShsZW4pIHsKICAgIHRoaXMuZW1pdCgnbWVzc2FnZScsIHRoaXMudWR4Ll9jb25zdW1lTWVzc2FnZShsZW4pKQogICAgcmV0dXJuIHRoaXMudWR4Ll9idWZmZXIKICB9CgogIF9vbmNsb3NlKGVycikgewogICAgdGhpcy5fY2xvc2VkID0gdHJ1ZQoKICAgIGlmICh0aGlzLnNvY2tldCkgewogICAgICB0aGlzLnNvY2tldC5fcmVtb3ZlU3RyZWFtKHRoaXMpCiAgICAgIHRoaXMuc29ja2V0ID0gbnVsbAogICAgfQoKICAgIGlmICh0aGlzLl9wcmV2aW91c1NvY2tldCkgewogICAgICB0aGlzLl9wcmV2aW91c1NvY2tldC5fcmVtb3ZlU3RyZWFtKHRoaXMpCiAgICAgIHRoaXMuX3ByZXZpb3VzU29ja2V0ID0gbnVsbAogICAgfQoKICAgIC8vIG5vIGVycm9yLCB3ZSBkb24ndCBuZWVkIHRvIGRvIGFueXRoaW5nCiAgICBpZiAoIWVycikgcmV0dXJuIHRoaXMuX2Rlc3Ryb3lDb250aW51ZShudWxsKQoKICAgIGlmICh0aGlzLl9vbmRlc3Ryb3kgPT09IG51bGwpIHRoaXMuZGVzdHJveShlcnIpCiAgICBlbHNlIHRoaXMuX2Rlc3Ryb3lDb250aW51ZShlcnIpCiAgfQoKICBfb25maXJld2FsbChzb2NrZXQsIHBvcnQsIGhvc3QsIGZhbWlseSkgewogICAgcmV0dXJuIHRoaXMuX2ZpcmV3YWxsKHNvY2tldCwgcG9ydCwgaG9zdCwgZmFtaWx5KSA/IDEgOiAwCiAgfQoKICBfb25yZW1vdGVjaGFuZ2VkKCkgewogICAgaWYgKHRoaXMuX3ByZXZpb3VzU29ja2V0KSB7CiAgICAgIHRoaXMuX3ByZXZpb3VzU29ja2V0Ll9yZW1vdmVTdHJlYW0odGhpcykKICAgICAgdGhpcy5fcHJldmlvdXNTb2NrZXQgPSBudWxsCiAgICB9CgogICAgdGhpcy5fcmVtb3RlQ2hhbmdpbmcgPSBudWxsCiAgICB0aGlzLmVtaXQoJ3JlbW90ZS1jaGFuZ2VkJykKICB9CgogIF9jb25zdW1lRGF0YShsZW4pIHsKICAgIGNvbnN0IG5leHQgPSB0aGlzLl9idWZmZXIuc3ViYXJyYXkoMCwgbGVuKQogICAgdGhpcy5fYnVmZmVyID0gdGhpcy5fYnVmZmVyLnN1YmFycmF5KGxlbikKICAgIGlmICh0aGlzLl9idWZmZXIuYnl0ZUxlbmd0aCA8IE1BWF9QQUNLRVQpIHRoaXMuX3JlYWxsb2NEYXRhKCkKICAgIHJldHVybiBuZXh0CiAgfQoKICBfcmVhbGxvY0RhdGEoKSB7CiAgICB0aGlzLl9idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoQlVGRkVSX1NJWkUpCiAgICByZXR1cm4gdGhpcy5fYnVmZmVyCiAgfQoKICBfcmVhbGxvY01lc3NhZ2UoKSB7CiAgICByZXR1cm4gdGhpcy51ZHguX3JlYWxsb2NNZXNzYWdlKCkKICB9CgogIF9hbGxvY1dyaXRlKHNpemUpIHsKICAgIGlmICh0aGlzLl93ZnJlZS5sZW5ndGggPT09IDApIHsKICAgICAgY29uc3QgaGFuZGxlID0gYjRhLmFsbG9jVW5zYWZlKGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX3dyaXRlX3NpemVvZihzaXplKSkKICAgICAgcmV0dXJuICgKICAgICAgICB0aGlzLl93cmVxcy5wdXNoKHsKICAgICAgICAgIGhhbmRsZSwKICAgICAgICAgIHNpemUsCiAgICAgICAgICBidWZmZXJzOiBudWxsLAogICAgICAgICAgYnVmZmVyOiBudWxsLAogICAgICAgICAgZmx1c2g6IDAKICAgICAgICB9KSAtIDEKICAgICAgKQogICAgfQoKICAgIGNvbnN0IGZyZWUgPSB0aGlzLl93ZnJlZS5wb3AoKQogICAgaWYgKHNpemUgPT09IDEpIHJldHVybiBmcmVlCgogICAgY29uc3QgbmV4dCA9IHRoaXMuX3dyZXFzW2ZyZWVdCiAgICBpZiAobmV4dC5zaXplIDwgc2l6ZSkgewogICAgICBuZXh0LmhhbmRsZSA9IGI0YS5hbGxvY1Vuc2FmZShiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV93cml0ZV9zaXplb2Yoc2l6ZSkpCiAgICAgIG5leHQuc2l6ZSA9IHNpemUKICAgIH0KCiAgICByZXR1cm4gZnJlZQogIH0KCiAgX2FsbG9jU2VuZCgpIHsKICAgIGlmICh0aGlzLl9zZnJlZS5sZW5ndGggPiAwKSByZXR1cm4gdGhpcy5fc2ZyZWUucG9wKCkKICAgIGNvbnN0IGhhbmRsZSA9IGI0YS5hbGxvY1Vuc2FmZShiaW5kaW5nLnNpemVvZl91ZHhfc3RyZWFtX3NlbmRfdCkKICAgIHJldHVybiB0aGlzLl9zcmVxcy5wdXNoKHsgaGFuZGxlLCBidWZmZXI6IG51bGwsIHJlc29sdmU6IG51bGwsIHJlamVjdDogbnVsbCB9KSAtIDEKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gdG9CdWZmZXIoZGF0YSkgewogIHJldHVybiB0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycgPyBiNGEuZnJvbShkYXRhKSA6IGRhdGEKfQoKZnVuY3Rpb24gZmlyZXdhbGxBbGwoc29ja2V0LCBwb3J0LCBob3N0KSB7CiAgcmV0dXJuIHRydWUKfQoKZnVuY3Rpb24gY3VzdG9tRXJyb3IobWVzc2FnZSwgY29kZSkgewogIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKG1lc3NhZ2UpCiAgZXJyb3IuY29kZSA9IGNvZGUKICByZXR1cm4gZXJyb3IKfQoKZnVuY3Rpb24gbmV4dEJhdGNoU2l6ZShuKSB7CiAgLy8gdHJ5IHRvIGNvZXJjZSB0aGUgdGhlIHdyaXRldnMgaW50byBzYW1laXNoIHNpemUKICBpZiAobiA9PT0gMSkgcmV0dXJuIDEKICAvLyBncm91cCBhbGwgPCA4IHRvIHRoZSBzYW1lIHNpemUsIGxvdyBtZW0gb3ZlcmhlYWQgYnV0IHNhdmUgc29tZSBzbWFsbCBhbGxvY3MKICBpZiAobiA8IDgpIHJldHVybiA4CiAgaWYgKG4gPCAxNikgcmV0dXJuIDE2CiAgaWYgKG4gPCAzMikgcmV0dXJuIDMyCiAgaWYgKG4gPCA2NCkgcmV0dXJuIDY0CiAgcmV0dXJuIG4KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGlwID0gcmVxdWlyZSgnLi9pcCcpCmNvbnN0IFNvY2tldCA9IHJlcXVpcmUoJy4vc29ja2V0JykKY29uc3QgU3RyZWFtID0gcmVxdWlyZSgnLi9zdHJlYW0nKQpjb25zdCBOZXR3b3JrSW50ZXJmYWNlcyA9IHJlcXVpcmUoJy4vbmV0d29yay1pbnRlcmZhY2VzJykKCmNvbnN0IE1BWF9NRVNTQUdFID0gNDA5Ngpjb25zdCBCVUZGRVJfU0laRSA9IDY1NTM2ICsgTUFYX01FU1NBR0UKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVURYIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuX2hhbmRsZSA9IGI0YS5hbGxvYyhiaW5kaW5nLnNpemVvZl91ZHhfbmFwaV90KQogICAgdGhpcy5fd2F0Y2hlcnMgPSBuZXcgU2V0KCkKICAgIHRoaXMuX3ZpZXc2NCA9IG5ldyBCaWdVaW50NjRBcnJheSgKICAgICAgdGhpcy5faGFuZGxlLmJ1ZmZlciwKICAgICAgdGhpcy5faGFuZGxlLmJ5dGVPZmZzZXQsCiAgICAgIHRoaXMuX2hhbmRsZS5ieXRlTGVuZ3RoID4+IDMKICAgICkKCiAgICB0aGlzLl9idWZmZXIgPSBudWxsCiAgICB0aGlzLl9yZWFsbG9jTWVzc2FnZSgpCgogICAgYmluZGluZy51ZHhfbmFwaV9pbml0KHRoaXMuX2hhbmRsZSwgdGhpcy5fYnVmZmVyKQogIH0KCiAgc3RhdGljIGlzSVB2NChob3N0KSB7CiAgICByZXR1cm4gaXAuaXNJUHY0KGhvc3QpCiAgfQoKICBzdGF0aWMgaXNJUHY2KGhvc3QpIHsKICAgIHJldHVybiBpcC5pc0lQdjYoaG9zdCkKICB9CgogIHN0YXRpYyBpc0lQKGhvc3QpIHsKICAgIHJldHVybiBpcC5pc0lQKGhvc3QpCiAgfQoKICBnZXQgYnl0ZXNUcmFuc21pdHRlZCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3RfYnl0ZXNfdHggPj4gM10pCiAgfQoKICBnZXQgcGFja2V0c1RyYW5zbWl0dGVkKCkgewogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfdF9wYWNrZXRzX3R4ID4+IDNdKQogIH0KCiAgZ2V0IGJ5dGVzUmVjZWl2ZWQoKSB7CiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF90X2J5dGVzX3J4ID4+IDNdKQogIH0KCiAgZ2V0IHBhY2tldHNSZWNlaXZlZCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3RfcGFja2V0c19yeCA+PiAzXSkKICB9CgogIGdldCBwYWNrZXRzRHJvcHBlZEJ5S2VybmVsKCkgewogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfdF9wYWNrZXRzX2Ryb3BwZWRfYnlfa2VybmVsID4+IDNdKQogIH0KCiAgX2NvbnN1bWVNZXNzYWdlKGxlbikgewogICAgY29uc3QgbmV4dCA9IHRoaXMuX2J1ZmZlci5zdWJhcnJheSgwLCBsZW4pCiAgICB0aGlzLl9idWZmZXIgPSB0aGlzLl9idWZmZXIuc3ViYXJyYXkobGVuKQogICAgaWYgKHRoaXMuX2J1ZmZlci5ieXRlTGVuZ3RoIDwgTUFYX01FU1NBR0UpIHRoaXMuX3JlYWxsb2NNZXNzYWdlKCkKICAgIHJldHVybiBuZXh0CiAgfQoKICBfcmVhbGxvY01lc3NhZ2UoKSB7CiAgICAvLyBUT0RPOiBtb3ZlIHJlYWxsb2NhdGlvbiB0byBuYXRpdmUKICAgIHRoaXMuX2J1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShCVUZGRVJfU0laRSkKICAgIHJldHVybiB0aGlzLl9idWZmZXIKICB9CgogIGNyZWF0ZVNvY2tldChvcHRzKSB7CiAgICByZXR1cm4gbmV3IFNvY2tldCh0aGlzLCBvcHRzKQogIH0KCiAgY3JlYXRlU3RyZWFtKGlkLCBvcHRzKSB7CiAgICByZXR1cm4gbmV3IFN0cmVhbSh0aGlzLCBpZCwgb3B0cykKICB9CgogIG5ldHdvcmtJbnRlcmZhY2VzKCkgewogICAgbGV0IFt3YXRjaGVyID0gbnVsbF0gPSB0aGlzLl93YXRjaGVycwogICAgaWYgKHdhdGNoZXIpIHJldHVybiB3YXRjaGVyLmludGVyZmFjZXMKCiAgICB3YXRjaGVyID0gbmV3IE5ldHdvcmtJbnRlcmZhY2VzKHRoaXMpCiAgICB3YXRjaGVyLmRlc3Ryb3koKQoKICAgIHJldHVybiB3YXRjaGVyLmludGVyZmFjZXMKICB9CgogIHdhdGNoTmV0d29ya0ludGVyZmFjZXMob25jaGFuZ2UpIHsKICAgIGNvbnN0IHdhdGNoZXIgPSBuZXcgTmV0d29ya0ludGVyZmFjZXModGhpcykKCiAgICB0aGlzLl93YXRjaGVycy5hZGQod2F0Y2hlcikKICAgIHdhdGNoZXIub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICB0aGlzLl93YXRjaGVycy5kZWxldGUod2F0Y2hlcikKICAgIH0pCgogICAgaWYgKG9uY2hhbmdlKSB3YXRjaGVyLm9uKCdjaGFuZ2UnLCBvbmNoYW5nZSkKCiAgICByZXR1cm4gd2F0Y2hlci53YXRjaCgpCiAgfQoKICBhc3luYyBsb29rdXAoaG9zdCwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IGZhbWlseSA9IDAgfSA9IG9wdHMKCiAgICBjb25zdCByZXEgPSBiNGEuYWxsb2MoYmluZGluZy5zaXplb2ZfdWR4X25hcGlfbG9va3VwX3QpCiAgICBjb25zdCBjdHggPSB7CiAgICAgIHJlcSwKICAgICAgcmVzb2x2ZTogbnVsbCwKICAgICAgcmVqZWN0OiBudWxsCiAgICB9CgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgY3R4LnJlc29sdmUgPSByZXNvbHZlCiAgICAgIGN0eC5yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgYmluZGluZy51ZHhfbmFwaV9sb29rdXAodGhpcy5faGFuZGxlLCByZXEsIGhvc3QsIGZhbWlseSwgY3R4LCBvbmxvb2t1cCkKCiAgICByZXR1cm4gcHJvbWlzZQogIH0KfQoKZnVuY3Rpb24gb25sb29rdXAoZXJyLCBob3N0LCBmYW1pbHkpIHsKICBpZiAoZXJyKSB0aGlzLnJlamVjdChlcnIpCiAgZWxzZSB0aGlzLnJlc29sdmUoeyBob3N0LCBmYW1pbHkgfSkKfQp7CiAgIm5hbWUiOiAidWR4LW5hdGl2ZSIsCiAgInZlcnNpb24iOiAiMS4xOS4yIiwKICAiZGVzY3JpcHRpb24iOiAidWR4IGlzIHJlbGlhYmxlLCBtdWx0aXBsZXhlZCwgYW5kIGNvbmdlc3Rpb24tY29udHJvbGxlZCBzdHJlYW1zIG92ZXIgdWRwIiwKICAibWFpbiI6ICJsaWIvdWR4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAibGliIiwKICAgICJwcmVidWlsZHMiLAogICAgImJpbmRpbmcuY2MiLAogICAgImJpbmRpbmcuanMiLAogICAgIkNNYWtlTGlzdHMudHh0IgogIF0sCiAgImltcG9ydHMiOiB7CiAgICAiZXZlbnRzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWV2ZW50cyIsCiAgICAgICJkZWZhdWx0IjogImV2ZW50cyIKICAgIH0KICB9LAogICJhZGRvbiI6IHRydWUsCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4iLAogICAgInRlc3QiOiAibnBtIHJ1biBsaW50ICYmIG5wbSBydW4gdGVzdDpiYXJlICYmIG5wbSBydW4gdGVzdDpub2RlIiwKICAgICJ0ZXN0Om5vZGUiOiAibm9kZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC9hbGwuanMiLAogICAgInRlc3Q6YWxsIjogImJyaXR0bGUgdGVzdC8qLmpzIHRlc3Qvc2xvdy8qLmpzIiwKICAgICJ0ZXN0OmdlbmVyYXRlIjogImJyaXR0bGUgLXIgdGVzdC9hbGwuanMgdGVzdC8qLmpzIiwKICAgICJiZW5jaCI6ICJicml0dGxlIHRlc3QvYmVuY2gvKi5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by91ZHgtbmF0aXZlLmdpdCIKICB9LAogICJrZXl3b3JkcyI6IFsKICAgICJ0Y3AiLAogICAgInVkcCIsCiAgICAic3RyZWFtIiwKICAgICJyZWxpYWJsZSIKICBdLAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYy4iLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vdWR4LW5hdGl2ZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3VkeC1uYXRpdmUjcmVhZG1lIiwKICAiZW5naW5lcyI6IHsKICAgICJiYXJlIjogIj49MS4xNy40IgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNS4wIiwKICAgICJiYXJlLWV2ZW50cyI6ICJeMi4yLjAiLAogICAgInJlcXVpcmUtYWRkb24iOiAiXjEuMS4wIiwKICAgICJzdHJlYW14IjogIl4yLjIyLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtY29tcGF0LW5hcGkiOiAiXjEuMy4wIiwKICAgICJicml0dGxlIjogIl4zLjEuMCIsCiAgICAiY21ha2UtYmFyZSI6ICJeMS4xLjEwIiwKICAgICJjbWFrZS1mZXRjaCI6ICJeMS4wLjEiLAogICAgImNtYWtlLW5hcGkiOiAiXjEuMC41IiwKICAgICJpcy1jaSI6ICJeMy4wLjEiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiLAogICAgInRpbnktYnl0ZS1zaXplIjogIl4xLjEuMCIKICB9Cn0KZXhwb3J0cy5hZGQgPSBhZGQKZXhwb3J0cy5oYXMgPSBoYXMKZXhwb3J0cy5yZW1vdmUgPSByZW1vdmUKZXhwb3J0cy5zd2FwID0gc3dhcAoKZnVuY3Rpb24gYWRkIChsaXN0LCBpdGVtKSB7CiAgaWYgKGhhcyhsaXN0LCBpdGVtKSkgcmV0dXJuIGl0ZW0KICBpdGVtLl9pbmRleCA9IGxpc3QubGVuZ3RoCiAgbGlzdC5wdXNoKGl0ZW0pCiAgcmV0dXJuIGl0ZW0KfQoKZnVuY3Rpb24gaGFzIChsaXN0LCBpdGVtKSB7CiAgcmV0dXJuIGl0ZW0uX2luZGV4IDwgbGlzdC5sZW5ndGggJiYgbGlzdFtpdGVtLl9pbmRleF0gPT09IGl0ZW0KfQoKZnVuY3Rpb24gcmVtb3ZlIChsaXN0LCBpdGVtKSB7CiAgaWYgKCFoYXMobGlzdCwgaXRlbSkpIHJldHVybiBudWxsCgogIHZhciBsYXN0ID0gbGlzdC5wb3AoKQogIGlmIChsYXN0ICE9PSBpdGVtKSB7CiAgICBsaXN0W2l0ZW0uX2luZGV4XSA9IGxhc3QKICAgIGxhc3QuX2luZGV4ID0gaXRlbS5faW5kZXgKICB9CgogIHJldHVybiBpdGVtCn0KCmZ1bmN0aW9uIHN3YXAgKGxpc3QsIGEsIGIpIHsKICBpZiAoIWhhcyhsaXN0LCBhKSB8fCAhaGFzKGxpc3QsIGIpKSByZXR1cm4KICB2YXIgdG1wID0gYS5faW5kZXgKICBhLl9pbmRleCA9IGIuX2luZGV4CiAgbGlzdFthLl9pbmRleF0gPSBhCiAgYi5faW5kZXggPSB0bXAKICBsaXN0W2IuX2luZGV4XSA9IGIKfQp7CiAgIm5hbWUiOiAidW5vcmRlcmVkLXNldCIsCiAgInZlcnNpb24iOiAiMi4wLjEiLAogICJkZXNjcmlwdGlvbiI6ICJBIGNvdXBsZSBvZiBmdW5jdGlvbnMgdGhhdCBtYWtlIGl0IGVhc3kgdG8gbWFpbnRhaW4gYW4gdW5vcmRlcmVkIHNldCBhcyBhbiBhcnJheSBpbiBhbiBlZmZpY2llbnQgd2F5IiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjYuMC40IiwKICAgICJ0YXBlIjogIl40LjQuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgdGFwZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3Vub3JkZXJlZC1zZXQuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3Vub3JkZXJlZC1zZXQvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvdW5vcmRlcmVkLXNldCIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKdW5zbGFiLmFsbCA9IGFsbAp1bnNsYWIuaXMgPSBpcwoKbW9kdWxlLmV4cG9ydHMgPSB1bnNsYWIKCmZ1bmN0aW9uIHVuc2xhYiAoYnVmKSB7CiAgaWYgKGJ1ZiA9PT0gbnVsbCB8fCBidWYuYnVmZmVyLmJ5dGVMZW5ndGggPT09IGJ1Zi5ieXRlTGVuZ3RoKSByZXR1cm4gYnVmCiAgY29uc3QgY29weSA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coYnVmLmJ5dGVMZW5ndGgpCiAgY29weS5zZXQoYnVmLCAwKQogIHJldHVybiBjb3B5Cn0KCmZ1bmN0aW9uIGlzIChidWYpIHsKICByZXR1cm4gYnVmLmJ1ZmZlci5ieXRlTGVuZ3RoICE9PSBidWYuYnl0ZUxlbmd0aAp9CgpmdW5jdGlvbiBhbGwgKGxpc3QpIHsKICBsZXQgc2l6ZSA9IDAKICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IGJ1ZiA9IGxpc3RbaV0KICAgIHNpemUgKz0gYnVmID09PSBudWxsIHx8IGJ1Zi5idWZmZXIuYnl0ZUxlbmd0aCA9PT0gYnVmLmJ5dGVMZW5ndGggPyAwIDogYnVmLmJ5dGVMZW5ndGgKICB9CgogIGNvbnN0IGNvcHkgPSBiNGEuYWxsb2NVbnNhZmVTbG93KHNpemUpCiAgY29uc3QgcmVzdWx0ID0gbmV3IEFycmF5KGxpc3QubGVuZ3RoKQoKICBsZXQgb2Zmc2V0ID0gMAogIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgbGV0IGJ1ZiA9IGxpc3RbaV0KCiAgICBpZiAoYnVmICE9PSBudWxsICYmIGJ1Zi5idWZmZXIuYnl0ZUxlbmd0aCAhPT0gYnVmLmJ5dGVMZW5ndGgpIHsKICAgICAgY29weS5zZXQoYnVmLCBvZmZzZXQpCiAgICAgIGJ1ZiA9IGNvcHkuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKz0gYnVmLmJ5dGVMZW5ndGgpCiAgICB9CgogICAgcmVzdWx0W2ldID0gYnVmCiAgfQoKICByZXR1cm4gcmVzdWx0Cn0KewogICJuYW1lIjogInVuc2xhYiIsCiAgInZlcnNpb24iOiAiMS4zLjAiLAogICJkZXNjcmlwdGlvbiI6ICJVbnNsYWIgc29tZSBzbGFiJ2VkIGJ1ZmZlcnMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjYiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuNS4yIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by91bnNsYWIuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vdW5zbGFiL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vdW5zbGFiIgp9Cm1vZHVsZS5leHBvcnRzID0gcmVhZAoKdmFyIE1TQiA9IDB4ODAKICAsIFJFU1QgPSAweDdGCgpmdW5jdGlvbiByZWFkKGJ1Ziwgb2Zmc2V0KSB7CiAgdmFyIHJlcyAgICA9IDAKICAgICwgb2Zmc2V0ID0gb2Zmc2V0IHx8IDAKICAgICwgc2hpZnQgID0gMAogICAgLCBjb3VudGVyID0gb2Zmc2V0CiAgICAsIGIKICAgICwgbCA9IGJ1Zi5sZW5ndGgKCiAgZG8gewogICAgaWYgKGNvdW50ZXIgPj0gbCkgewogICAgICByZWFkLmJ5dGVzID0gMAogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQ291bGQgbm90IGRlY29kZSB2YXJpbnQnKQogICAgfQogICAgYiA9IGJ1Zltjb3VudGVyKytdCiAgICByZXMgKz0gc2hpZnQgPCAyOAogICAgICA/IChiICYgUkVTVCkgPDwgc2hpZnQKICAgICAgOiAoYiAmIFJFU1QpICogTWF0aC5wb3coMiwgc2hpZnQpCiAgICBzaGlmdCArPSA3CiAgfSB3aGlsZSAoYiA+PSBNU0IpCgogIHJlYWQuYnl0ZXMgPSBjb3VudGVyIC0gb2Zmc2V0CgogIHJldHVybiByZXMKfQptb2R1bGUuZXhwb3J0cyA9IGVuY29kZQoKdmFyIE1TQiA9IDB4ODAKICAsIFJFU1QgPSAweDdGCiAgLCBNU0JBTEwgPSB+UkVTVAogICwgSU5UID0gTWF0aC5wb3coMiwgMzEpCgpmdW5jdGlvbiBlbmNvZGUobnVtLCBvdXQsIG9mZnNldCkgewogIG91dCA9IG91dCB8fCBbXQogIG9mZnNldCA9IG9mZnNldCB8fCAwCiAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAoKICB3aGlsZShudW0gPj0gSU5UKSB7CiAgICBvdXRbb2Zmc2V0KytdID0gKG51bSAmIDB4RkYpIHwgTVNCCiAgICBudW0gLz0gMTI4CiAgfQogIHdoaWxlKG51bSAmIE1TQkFMTCkgewogICAgb3V0W29mZnNldCsrXSA9IChudW0gJiAweEZGKSB8IE1TQgogICAgbnVtID4+Pj0gNwogIH0KICBvdXRbb2Zmc2V0XSA9IG51bSB8IDAKICAKICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQgKyAxCiAgCiAgcmV0dXJuIG91dAp9Cm1vZHVsZS5leHBvcnRzID0gewogICAgZW5jb2RlOiByZXF1aXJlKCcuL2VuY29kZS5qcycpCiAgLCBkZWNvZGU6IHJlcXVpcmUoJy4vZGVjb2RlLmpzJykKICAsIGVuY29kaW5nTGVuZ3RoOiByZXF1aXJlKCcuL2xlbmd0aC5qcycpCn0KCnZhciBOMSA9IE1hdGgucG93KDIsICA3KQp2YXIgTjIgPSBNYXRoLnBvdygyLCAxNCkKdmFyIE4zID0gTWF0aC5wb3coMiwgMjEpCnZhciBONCA9IE1hdGgucG93KDIsIDI4KQp2YXIgTjUgPSBNYXRoLnBvdygyLCAzNSkKdmFyIE42ID0gTWF0aC5wb3coMiwgNDIpCnZhciBONyA9IE1hdGgucG93KDIsIDQ5KQp2YXIgTjggPSBNYXRoLnBvdygyLCA1NikKdmFyIE45ID0gTWF0aC5wb3coMiwgNjMpCgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiAoCiAgICB2YWx1ZSA8IE4xID8gMQogIDogdmFsdWUgPCBOMiA/IDIKICA6IHZhbHVlIDwgTjMgPyAzCiAgOiB2YWx1ZSA8IE40ID8gNAogIDogdmFsdWUgPCBONSA/IDUKICA6IHZhbHVlIDwgTjYgPyA2CiAgOiB2YWx1ZSA8IE43ID8gNwogIDogdmFsdWUgPCBOOCA/IDgKICA6IHZhbHVlIDwgTjkgPyA5CiAgOiAgICAgICAgICAgICAgMTAKICApCn0KewogICJuYW1lIjogInZhcmludCIsCiAgInZlcnNpb24iOiAiNS4wLjAiLAogICJkZXNjcmlwdGlvbiI6ICJwcm90b2J1Zi1zdHlsZSB2YXJpbnQgYnl0ZXMgLSB1c2UgbXNiIHRvIGNyZWF0ZSBpbnRlZ2VyIHZhbHVlcyBvZiB2YXJ5aW5nIHNpemVzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJub2RlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdDovL2dpdGh1Yi5jb20vY2hyaXNkaWNraW5zb24vdmFyaW50LmdpdCIKICB9LAogICJrZXl3b3JkcyI6IFsKICAgICJ2YXJpbnQiLAogICAgInByb3RvYnVmIiwKICAgICJlbmNvZGUiLAogICAgImRlY29kZSIKICBdLAogICJhdXRob3IiOiAiQ2hyaXMgRGlja2luc29uIDxjaHJpc0BuZXZlcnNhdy51cz4iLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJ0YXBlIjogIn4yLjEyLjMiCiAgfQp9CmNvbnN0IHsgcnVudGltZSwgcGxhdGZvcm0sIGFyY2ggfSA9IHR5cGVvZiBCYXJlICE9PSAndW5kZWZpbmVkJwogID8geyBydW50aW1lOiAnYmFyZScsIHBsYXRmb3JtOiBnbG9iYWwuQmFyZS5wbGF0Zm9ybSwgYXJjaDogZ2xvYmFsLkJhcmUuYXJjaCB9CiAgOiB0eXBlb2YgcHJvY2VzcyAhPT0gJ3VuZGVmaW5lZCcKICAgID8geyBydW50aW1lOiAnbm9kZScsIHBsYXRmb3JtOiBnbG9iYWwucHJvY2Vzcy5wbGF0Zm9ybSwgYXJjaDogZ2xvYmFsLnByb2Nlc3MuYXJjaCB9CiAgICA6IHR5cGVvZiBXaW5kb3cgIT09ICd1bmRlZmluZWQnCiAgICAgID8geyBydW50aW1lOiAnYnJvd3NlcicsIHBsYXRmb3JtOiAndW5rbm93bicsIGFyY2g6ICd1bmtub3duJyB9CiAgICAgIDogeyBydW50aW1lOiAndW5rbm93bicsIHBsYXRmb3JtOiAndW5rbm93bicsIGFyY2g6ICd1bmtub3duJyB9CgpleHBvcnRzLnJ1bnRpbWUgPSBydW50aW1lCmV4cG9ydHMucGxhdGZvcm0gPSBwbGF0Zm9ybQpleHBvcnRzLmFyY2ggPSBhcmNoCmV4cG9ydHMuaXNCYXJlID0gcnVudGltZSA9PT0gJ2JhcmUnCmV4cG9ydHMuaXNCYXJlS2l0ID0gZXhwb3J0cy5pc0JhcmUgJiYgdHlwZW9mIEJhcmVLaXQgIT09ICd1bmRlZmluZWQnCmV4cG9ydHMuaXNQZWFyID0gdHlwZW9mIFBlYXIgIT09ICd1bmRlZmluZWQnCmV4cG9ydHMuaXNOb2RlID0gcnVudGltZSA9PT0gJ25vZGUnCmV4cG9ydHMuaXNCcm93c2VyID0gcnVudGltZSA9PT0gJ2Jyb3dzZXInCmV4cG9ydHMuaXNXaW5kb3dzID0gcGxhdGZvcm0gPT09ICd3aW4zMicKZXhwb3J0cy5pc0xpbnV4ID0gcGxhdGZvcm0gPT09ICdsaW51eCcKZXhwb3J0cy5pc01hYyA9IHBsYXRmb3JtID09PSAnZGFyd2luJwpleHBvcnRzLmlzSU9TID0gcGxhdGZvcm0gPT09ICdpb3MnIHx8IHBsYXRmb3JtID09PSAnaW9zLXNpbXVsYXRvcicKZXhwb3J0cy5pc0FuZHJvaWQgPSBwbGF0Zm9ybSA9PT0gJ2FuZHJvaWQnCmV4cG9ydHMuaXNFbGVjdHJvbiA9IHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJyAmJiAhIWdsb2JhbC5wcm9jZXNzLnZlcnNpb25zPy5lbGVjdHJvbgpleHBvcnRzLmlzRWxlY3Ryb25SZW5kZXJlciA9IGV4cG9ydHMuaXNFbGVjdHJvbiAmJiBnbG9iYWwucHJvY2Vzcy50eXBlID09PSAncmVuZGVyZXInCmV4cG9ydHMuaXNFbGVjdHJvbldvcmtlciA9IGV4cG9ydHMuaXNFbGVjdHJvbiAmJiBnbG9iYWwucHJvY2Vzcy50eXBlID09PSAnd29ya2VyJwp7CiAgIm5hbWUiOiAid2hpY2gtcnVudGltZSIsCiAgInZlcnNpb24iOiAiMS4zLjIiLAogICJkZXNjcmlwdGlvbiI6ICJEZXRlY3QgaWYgeW91IGFyZSBpbiBCYXJlIG9yIE5vZGUgYW5kIHdoaWNoIG9zIGV0YyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vd2hpY2gtcnVudGltZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMuIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3doaWNoLXJ1bnRpbWUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by93aGljaC1ydW50aW1lIgp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgTWF4Q2FjaGUgewogIGNvbnN0cnVjdG9yICh7IG1heFNpemUsIG1heEFnZSwgY3JlYXRlTWFwLCBvbmdjIH0pIHsKICAgIHRoaXMubWF4U2l6ZSA9IG1heFNpemUKICAgIHRoaXMubWF4QWdlID0gbWF4QWdlCiAgICB0aGlzLm9uZ2MgPSBvbmdjIHx8IG51bGwKCiAgICB0aGlzLl9jcmVhdGVNYXAgPSBjcmVhdGVNYXAgfHwgZGVmYXVsdENyZWF0ZU1hcAogICAgdGhpcy5fbGF0ZXN0ID0gdGhpcy5fY3JlYXRlTWFwKCkKICAgIHRoaXMuX29sZGVzdCA9IHRoaXMuX2NyZWF0ZU1hcCgpCiAgICB0aGlzLl9yZXRhaW5lZCA9IHRoaXMuX2NyZWF0ZU1hcCgpCiAgICB0aGlzLl9nY2VkID0gZmFsc2UKICAgIHRoaXMuX2ludGVydmFsID0gbnVsbAoKICAgIGlmICh0aGlzLm1heEFnZSA+IDAgJiYgdGhpcy5tYXhBZ2UgPCBJbmZpbml0eSkgewogICAgICBjb25zdCB0aWNrID0gTWF0aC5jZWlsKDIgLyAzICogdGhpcy5tYXhBZ2UpCiAgICAgIHRoaXMuX2ludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5fZ2NBdXRvLmJpbmQodGhpcyksIHRpY2spCiAgICAgIGlmICh0aGlzLl9pbnRlcnZhbC51bnJlZikgdGhpcy5faW50ZXJ2YWwudW5yZWYoKQogICAgfQogIH0KCiAgKiBbU3ltYm9sLml0ZXJhdG9yXSAoKSB7CiAgICBmb3IgKGNvbnN0IGl0IG9mIFt0aGlzLl9sYXRlc3QsIHRoaXMuX29sZGVzdCwgdGhpcy5fcmV0YWluZWRdKSB7CiAgICAgIHlpZWxkICogaXQKICAgIH0KICB9CgogICoga2V5cyAoKSB7CiAgICBmb3IgKGNvbnN0IGl0IG9mIFt0aGlzLl9sYXRlc3QsIHRoaXMuX29sZGVzdCwgdGhpcy5fcmV0YWluZWRdKSB7CiAgICAgIHlpZWxkICogaXQua2V5cygpCiAgICB9CiAgfQoKICAqIHZhbHVlcyAoKSB7CiAgICBmb3IgKGNvbnN0IGl0IG9mIFt0aGlzLl9sYXRlc3QsIHRoaXMuX29sZGVzdCwgdGhpcy5fcmV0YWluZWRdKSB7CiAgICAgIHlpZWxkICogaXQudmFsdWVzKCkKICAgIH0KICB9CgogIGRlc3Ryb3kgKCkgewogICAgdGhpcy5jbGVhcigpCiAgICBjbGVhckludGVydmFsKHRoaXMuX2ludGVydmFsKQogICAgdGhpcy5faW50ZXJ2YWwgPSBudWxsCiAgfQoKICBjbGVhciAoKSB7CiAgICB0aGlzLl9nY2VkID0gdHJ1ZQogICAgdGhpcy5fbGF0ZXN0LmNsZWFyKCkKICAgIHRoaXMuX29sZGVzdC5jbGVhcigpCiAgICB0aGlzLl9yZXRhaW5lZC5jbGVhcigpCiAgfQoKICBzZXQgKGssIHYpIHsKICAgIGlmICh0aGlzLl9yZXRhaW5lZC5oYXMoaykpIHJldHVybiB0aGlzCiAgICB0aGlzLl9sYXRlc3Quc2V0KGssIHYpCiAgICB0aGlzLl9vbGRlc3QuZGVsZXRlKGspIHx8IHRoaXMuX3JldGFpbmVkLmRlbGV0ZShrKQogICAgaWYgKHRoaXMuX2xhdGVzdC5zaXplID49IHRoaXMubWF4U2l6ZSkgdGhpcy5fZ2MoKQogICAgcmV0dXJuIHRoaXMKICB9CgogIHJldGFpbiAoaywgdikgewogICAgdGhpcy5fcmV0YWluZWQuc2V0KGssIHYpCiAgICB0aGlzLl9sYXRlc3QuZGVsZXRlKGspIHx8IHRoaXMuX29sZGVzdC5kZWxldGUoaykKICAgIHJldHVybiB0aGlzCiAgfQoKICBkZWxldGUgKGspIHsKICAgIHJldHVybiB0aGlzLl9sYXRlc3QuZGVsZXRlKGspIHx8IHRoaXMuX29sZGVzdC5kZWxldGUoaykgfHwgdGhpcy5fcmV0YWluZWQuZGVsZXRlKGspCiAgfQoKICBoYXMgKGspIHsKICAgIHJldHVybiB0aGlzLl9sYXRlc3QuaGFzKGspIHx8IHRoaXMuX29sZGVzdC5oYXMoaykgfHwgdGhpcy5fcmV0YWluZWQuaGFzKGspCiAgfQoKICBnZXQgKGspIHsKICAgIGlmICh0aGlzLl9sYXRlc3QuaGFzKGspKSB7CiAgICAgIHJldHVybiB0aGlzLl9sYXRlc3QuZ2V0KGspCiAgICB9CgogICAgaWYgKHRoaXMuX29sZGVzdC5oYXMoaykpIHsKICAgICAgY29uc3QgdiA9IHRoaXMuX29sZGVzdC5nZXQoaykKICAgICAgdGhpcy5fbGF0ZXN0LnNldChrLCB2KQogICAgICB0aGlzLl9vbGRlc3QuZGVsZXRlKGspCiAgICAgIHJldHVybiB2CiAgICB9CgogICAgaWYgKHRoaXMuX3JldGFpbmVkLmhhcyhrKSkgewogICAgICByZXR1cm4gdGhpcy5fcmV0YWluZWQuZ2V0KGspCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIF9nY0F1dG8gKCkgewogICAgaWYgKCF0aGlzLl9nY2VkKSB0aGlzLl9nYygpCiAgICB0aGlzLl9nY2VkID0gZmFsc2UKICB9CgogIF9nYyAoKSB7CiAgICB0aGlzLl9nY2VkID0gdHJ1ZQogICAgaWYgKHRoaXMub25nYyAhPT0gbnVsbCAmJiB0aGlzLl9vbGRlc3Quc2l6ZSA+IDApIHRoaXMub25nYyh0aGlzLl9vbGRlc3QpCiAgICB0aGlzLl9vbGRlc3QgPSB0aGlzLl9sYXRlc3QKICAgIHRoaXMuX2xhdGVzdCA9IHRoaXMuX2NyZWF0ZU1hcCgpCiAgfQp9CgpmdW5jdGlvbiBkZWZhdWx0Q3JlYXRlTWFwICgpIHsKICByZXR1cm4gbmV3IE1hcCgpCn0KewogICJuYW1lIjogInhhY2hlIiwKICAidmVyc2lvbiI6ICIxLjIuMSIsCiAgImRlc2NyaXB0aW9uIjogIllldCBhbm90aGVyIGF1dG8gZXhwaXJpbmcsIG1heCBzaXphYmxlIGNhY2hlIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjMuMiIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3hhY2hlLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC94YWNoZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC94YWNoZSIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgQUxQSEFCRVQgPSAneWJuZHJmZzhlamttY3BxeG90MXV3aXN6YTM0NWg3NjknCmNvbnN0IE1JTiA9IDB4MzEgLy8gMQpjb25zdCBNQVggPSAweDdhIC8vIHoKY29uc3QgUkVWRVJTRSA9IG5ldyBJbnQ4QXJyYXkoMSArIE1BWCAtIE1JTikKClJFVkVSU0UuZmlsbCgtMSkKCmZvciAobGV0IGkgPSAwOyBpIDwgQUxQSEFCRVQubGVuZ3RoOyBpKyspIHsKICBjb25zdCB2ID0gQUxQSEFCRVQuY2hhckNvZGVBdChpKSAtIE1JTgogIFJFVkVSU0Vbdl0gPSBpCn0KCmV4cG9ydHMuZW5jb2RlID0gZW5jb2RlCmV4cG9ydHMuZGVjb2RlID0gZGVjb2RlCmV4cG9ydHMuQUxQSEFCRVQgPSBBTFBIQUJFVAoKZnVuY3Rpb24gZGVjb2RlIChzLCBvdXQpIHsKICBsZXQgcGIgPSAwCiAgbGV0IHBzID0gMAoKICBjb25zdCByID0gcy5sZW5ndGggJiA3CiAgY29uc3QgcSA9IChzLmxlbmd0aCAtIHIpIC8gOAoKICBpZiAoIW91dCkgb3V0ID0gYjRhLmFsbG9jVW5zYWZlKE1hdGguY2VpbChzLmxlbmd0aCAqIDUgLyA4KSkKCiAgLy8gMCA1IDIgNyA0IDEgNiAzICgrNSBtb2QgOCkKICBmb3IgKGxldCBpID0gMDsgaSA8IHE7IGkrKykgewogICAgY29uc3QgYSA9IHF1aW50ZXQocywgcHMrKykKICAgIGNvbnN0IGIgPSBxdWludGV0KHMsIHBzKyspCiAgICBjb25zdCBjID0gcXVpbnRldChzLCBwcysrKQogICAgY29uc3QgZCA9IHF1aW50ZXQocywgcHMrKykKICAgIGNvbnN0IGUgPSBxdWludGV0KHMsIHBzKyspCiAgICBjb25zdCBmID0gcXVpbnRldChzLCBwcysrKQogICAgY29uc3QgZyA9IHF1aW50ZXQocywgcHMrKykKICAgIGNvbnN0IGggPSBxdWludGV0KHMsIHBzKyspCgogICAgb3V0W3BiKytdID0gKGEgPDwgMykgfCAoYiA+Pj4gMikKICAgIG91dFtwYisrXSA9ICgoYiAmIDBiMTEpIDw8IDYpIHwgKGMgPDwgMSkgfCAoZCA+Pj4gNCkKICAgIG91dFtwYisrXSA9ICgoZCAmIDBiMTExMSkgPDwgNCkgfCAoZSA+Pj4gMSkKICAgIG91dFtwYisrXSA9ICgoZSAmIDBiMSkgPDwgNykgfCAoZiA8PCAyKSB8IChnID4+PiAzKQogICAgb3V0W3BiKytdID0gKChnICYgMGIxMTEpIDw8IDUpIHwgaAogIH0KCiAgaWYgKHIgPT09IDApIHJldHVybiBvdXQuc3ViYXJyYXkoMCwgcGIpCgogIGNvbnN0IGEgPSBxdWludGV0KHMsIHBzKyspCiAgY29uc3QgYiA9IHF1aW50ZXQocywgcHMrKykKCiAgb3V0W3BiKytdID0gKGEgPDwgMykgfCAoYiA+Pj4gMikKCiAgaWYgKHIgPD0gMikgcmV0dXJuIG91dC5zdWJhcnJheSgwLCBwYikKCiAgY29uc3QgYyA9IHF1aW50ZXQocywgcHMrKykKICBjb25zdCBkID0gcXVpbnRldChzLCBwcysrKQoKICBvdXRbcGIrK10gPSAoKGIgJiAwYjExKSA8PCA2KSB8IChjIDw8IDEpIHwgKGQgPj4+IDQpCgogIGlmIChyIDw9IDQpIHJldHVybiBvdXQuc3ViYXJyYXkoMCwgcGIpCgogIGNvbnN0IGUgPSBxdWludGV0KHMsIHBzKyspCgogIG91dFtwYisrXSA9ICgoZCAmIDBiMTExMSkgPDwgNCkgfCAoZSA+Pj4gMSkKCiAgaWYgKHIgPD0gNSkgcmV0dXJuIG91dC5zdWJhcnJheSgwLCBwYikKCiAgY29uc3QgZiA9IHF1aW50ZXQocywgcHMrKykKICBjb25zdCBnID0gcXVpbnRldChzLCBwcysrKQoKICBvdXRbcGIrK10gPSAoKGUgJiAwYjEpIDw8IDcpIHwgKGYgPDwgMikgfCAoZyA+Pj4gMykKCiAgaWYgKHIgPD0gNykgcmV0dXJuIG91dC5zdWJhcnJheSgwLCBwYikKCiAgY29uc3QgaCA9IHF1aW50ZXQocywgcHMrKykKCiAgb3V0W3BiKytdID0gKChnICYgMGIxMTEpIDw8IDUpIHwgaAoKICByZXR1cm4gb3V0LnN1YmFycmF5KDAsIHBiKQp9CgpmdW5jdGlvbiBlbmNvZGUgKGJ1ZikgewogIGlmICh0eXBlb2YgYnVmID09PSAnc3RyaW5nJykgYnVmID0gYjRhLmZyb20oYnVmKQoKICBjb25zdCBtYXggPSBidWYuYnl0ZUxlbmd0aCAqIDgKCiAgbGV0IHMgPSAnJwoKICBmb3IgKGxldCBwID0gMDsgcCA8IG1heDsgcCArPSA1KSB7CiAgICBjb25zdCBpID0gcCA+Pj4gMwogICAgY29uc3QgaiA9IHAgJiA3CgogICAgaWYgKGogPD0gMykgewogICAgICBzICs9IEFMUEhBQkVUWyhidWZbaV0gPj4+ICgzIC0gaikpICYgMGIxMTExMV0KICAgICAgY29udGludWUKICAgIH0KCiAgICBjb25zdCBvZiA9IGogLSAzCiAgICBjb25zdCBoID0gKGJ1ZltpXSA8PCBvZikgJiAwYjExMTExCiAgICBjb25zdCBsID0gKGkgPj0gYnVmLmJ5dGVMZW5ndGggPyAwIDogYnVmW2kgKyAxXSkgPj4+ICg4IC0gb2YpCgogICAgcyArPSBBTFBIQUJFVFtoIHwgbF0KICB9CgogIHJldHVybiBzCn0KCmZ1bmN0aW9uIHF1aW50ZXQgKHMsIGkpIHsKICBpZiAoaSA+IHMubGVuZ3RoKSB7CiAgICByZXR1cm4gMAogIH0KCiAgY29uc3QgdiA9IHMuY2hhckNvZGVBdChpKQoKICBpZiAodiA8IE1JTiB8fCB2ID4gTUFYKSB7CiAgICB0aHJvdyBFcnJvcignSW52YWxpZCBjaGFyYWN0ZXIgaW4gYmFzZTMyIGlucHV0OiAiJyArIHNbaV0gKyAnIiBhdCBwb3NpdGlvbiAnICsgaSkKICB9CgogIGNvbnN0IGJpdHMgPSBSRVZFUlNFW3YgLSBNSU5dCgogIGlmIChiaXRzID09PSAtMSkgewogICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgY2hhcmFjdGVyIGluIGJhc2UzMiBpbnB1dDogIicgKyBzW2ldICsgJyIgYXQgcG9zaXRpb24gJyArIGkpCiAgfQoKICByZXR1cm4gYml0cwp9CnsKICAibmFtZSI6ICJ6MzIiLAogICJ2ZXJzaW9uIjogIjEuMS4wIiwKICAiZGVzY3JpcHRpb24iOiAiRW5jb2RlICYgZGVjb2RlIHotYmFzZTMyIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNS4zIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXNlLXgiOiAiXjQuMC4wIiwKICAgICJiYXNlMzIiOiAiMC4wLjciLAogICAgImJyaXR0bGUiOiAiXjMuMS4zIiwKICAgICJuYW5vYmVuY2giOiAiXjMuMC4wIiwKICAgICJyZmM0NjQ4IjogIl4xLjUuMiIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC96MzIuZ2l0IgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiLAogICAgImJlbmNoIjogIm5vZGUgYmVuY2htYXJrLmpzIgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3ozMi9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC96MzIiCn0KewogICJwcml2YXRlIjogdHJ1ZSwKICAibmFtZSI6ICJsaXN0YW0iLAogICJkZXNjcmlwdGlvbiI6ICJBIG1pbmltYWxpc3RpYyBwMnAgbGlzdCBhcHAiLAogICJtYWluIjogImV4cG8tcm91dGVyL2VudHJ5IiwKICAic2NyaXB0cyI6IHsKICAgICJzdGFydCI6ICJleHBvIHN0YXJ0IiwKICAgICJhbmRyb2lkIjogIm5wbSBydW4gYnVuZGxlOmJhY2tlbmQ6YW5kcm9pZCAmJiBleHBvIHJ1bjphbmRyb2lkIiwKICAgICJhbmRyb2lkOnJlbGVhc2UiOiAiY2QgYW5kcm9pZCAmJiAuL2dyYWRsZXcgYnVuZGxlUmVsZWFzZSIsCiAgICAiaW9zIjogIm5wbSBydW4gYnVuZGxlOmJhY2tlbmQ6aW9zICYmIGV4cG8gcnVuOmlvcyAtLWRldmljZSIsCiAgICAiYnVuZGxlOmJhY2tlbmQ6aW9zIjogIm5weCBiYXJlLXBhY2sgLS10YXJnZXQgaW9zIC0tbGlua2VkIGJhY2tlbmQvYmFja2VuZC5tanMgLS1lbmNvZGluZyBiYXNlNjQgLS1vdXQgYXBwL2FwcC5pb3MuYnVuZGxlICYmIG5vZGUgc2NyaXB0cy93cmFwLWJhcmUtYnVuZGxlLm1qcyBhcHAvYXBwLmlvcy5idW5kbGUgYXBwL2FwcC5pb3MuYnVuZGxlLm1qcyIsCiAgICAiYnVuZGxlOmJhY2tlbmQ6YW5kcm9pZCI6ICJucHggYmFyZS1wYWNrIC0tdGFyZ2V0IGFuZHJvaWQgLS1saW5rZWQgYmFja2VuZC9iYWNrZW5kLm1qcyAtLWVuY29kaW5nIGJhc2U2NCAtLW91dCBhcHAvYXNzZXRzL2JhY2tlbmQuYW5kcm9pZC5idW5kbGUgJiYgbm9kZSBzY3JpcHRzL3dyYXAtYmFyZS1idW5kbGUubWpzIGFwcC9hc3NldHMvYmFja2VuZC5hbmRyb2lkLmJ1bmRsZSBhcHAvYXNzZXRzL2JhY2tlbmQuYW5kcm9pZC5idW5kbGUubWpzIgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJAaW5xdWlyZXIvcHJvbXB0cyI6ICJeNy44LjEiLAogICAgIkByZWFjdC1uYXRpdmUtY2xpcGJvYXJkL2NsaXBib2FyZCI6ICIxLjE2LjMiLAogICAgImF1dG9iYXNlIjogIl43LjIwLjAiLAogICAgImF1dG9wYXNzIjogIl4yLjIuMSIsCiAgICAiYjRhIjogIl4xLjcuMSIsCiAgICAiYmFyZS1jcnlwdG8iOiAiXjEuMTIuMCIsCiAgICAiYmFyZS1mcyI6ICJeNC40LjQiLAogICAgImJhcmUtcnBjIjogIl4wLjIuMTIiLAogICAgImJhc2U2NC1qcyI6ICJeMS41LjEiLAogICAgImJsaW5kLXBlZXJpbmciOiAiXjEuMTMuMCIsCiAgICAiY29yZXN0b3JlIjogIl43LjUuMCIsCiAgICAiZXhwbyI6ICJ+NTQuMC4zMSIsCiAgICAiZXhwby1idWlsZC1wcm9wZXJ0aWVzIjogIjEuMC4xMCIsCiAgICAiZXhwby1jb25zdGFudHMiOiAifjE4LjAuMTMiLAogICAgImV4cG8tZmlsZS1zeXN0ZW0iOiAifjE5LjAuMjEiLAogICAgImV4cG8tbGlua2luZyI6ICI4LjAuMTEiLAogICAgImV4cG8tcm91dGVyIjogIjYuMC4yMSIsCiAgICAiZXhwby1zeXN0ZW0tdWkiOiAiNi4wLjkiLAogICAgImh5cGVyY29yZS1jcnlwdG8iOiAiXjMuNi4xIiwKICAgICJoeXBlcmRiIjogIl40LjE5LjAiLAogICAgImh5cGVyZGlzcGF0Y2giOiAiXjEuNC40IiwKICAgICJoeXBlcnNjaGVtYSI6ICJeMS4xNy4wIiwKICAgICJoeXBlcnN3YXJtIjogIl40LjEyLjEiLAogICAgImx1Y2lkZS1yZWFjdC1uYXRpdmUiOiAiXjAuNTUzLjAiLAogICAgIm1ha2UtZGlyIjogIl41LjEuMCIsCiAgICAicHJvdG9tdXgtd2FrZXVwIjogIl4yLjYuMSIsCiAgICAicmVhY3QiOiAiMTkuMS4wIiwKICAgICJyZWFjdC1kb20iOiAiMTkuMS4wIiwKICAgICJyZWFjdC1uYXRpdmUiOiAiMC44MS41IiwKICAgICJyZWFjdC1uYXRpdmUtYjRhIjogIjAuMC40IiwKICAgICJyZWFjdC1uYXRpdmUtYmFyZS1raXQiOiAiMC4xMS41IiwKICAgICJyZWFjdC1uYXRpdmUtcmVhbmltYXRlZCI6ICJ+NC4xLjEiLAogICAgInJlYWN0LW5hdGl2ZS1zYWZlLWFyZWEtY29udGV4dCI6ICI1LjYuMiIsCiAgICAicmVhY3QtbmF0aXZlLXdvcmtsZXRzIjogIjAuNS4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJAcmVhY3QtbmF0aXZlLWNvbW11bml0eS9jbGkiOiAibGF0ZXN0IiwKICAgICJAdHlwZXMvYjRhIjogIjEuNi41IiwKICAgICJAdHlwZXMvcmVhY3QiOiAiMTkuMi43IiwKICAgICJiYWJlbC1wbHVnaW4tbW9kdWxlLXJlc29sdmVyIjogIl41LjAuMiIsCiAgICAiYmFyZS1wYWNrIjogIjEuNS4xIiwKICAgICJwcmV0dGllciI6ICIzLjcuNCIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICIyLjAuMCIsCiAgICAidHlwZXNjcmlwdCI6ICI1LjkuMyIKICB9Cn0KZXhwb3J0IGNvbnN0IFJQQ19SRVNFVCA9IDAKZXhwb3J0IGNvbnN0IFJQQ19NRVNTQUdFID0gMQpleHBvcnQgY29uc3QgUlBDX0FERCA9IDIKZXhwb3J0IGNvbnN0IFJQQ19VUERBVEUgPSAzCmV4cG9ydCBjb25zdCBSUENfREVMRVRFID0gNApleHBvcnQgY29uc3QgUlBDX0dFVF9LRVkgPSA1CmV4cG9ydCBjb25zdCBTWU5DX0xJU1QgPSA2CmV4cG9ydCBjb25zdCBSUENfSk9JTl9LRVkgPSA3CmV4cG9ydCBjb25zdCBSUENfQUREX0ZST01fQkFDS0VORCA9IDgKZXhwb3J0IGNvbnN0IFJQQ19VUERBVEVfRlJPTV9CQUNLRU5EID0gOQpleHBvcnQgY29uc3QgUlBDX0RFTEVURV9GUk9NX0JBQ0tFTkQgPSAxMApleHBvcnQgY29uc3QgUlBDX1JFUVVFU1RfU1lOQyA9IDExCg=="];
export default chunks.join('');
