// Auto-generated. Do not edit.
const chunks = ["MTAwMTM0CnsidmVyc2lvbiI6MCwiaWQiOiJmNjc1M2U0MDViYTc1ZjIxYWIzMjM5Yjc1ZDQwN2JiODBjOWU5NDkwN2I5MjI1YmUxMDk4MjA3MDYxNzliMTA1IiwibWFpbiI6Ii9iYWNrZW5kL2JhY2tlbmQubWpzIiwiaW1wb3J0cyI6e30sInJlc29sdXRpb25zIjp7Ii9iYWNrZW5kL2JhY2tlbmQubWpzIjp7IiNwYWNrYWdlIjoiL3BhY2thZ2UuanNvbiIsIi4uL3JwYy1jb21tYW5kcy5tanMiOiIvcnBjLWNvbW1hbmRzLm1qcyIsIi4vbGliL2l0ZW0ubWpzIjoiL2JhY2tlbmQvbGliL2l0ZW0ubWpzIiwiLi9saWIva2V5Lm1qcyI6Ii9iYWNrZW5kL2xpYi9rZXkubWpzIiwiLi9saWIvbmV0d29yay5tanMiOiIvYmFja2VuZC9saWIvbmV0d29yay5tanMiLCIuL2xpYi9zdGF0ZS5tanMiOiIvYmFja2VuZC9saWIvc3RhdGUubWpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJiYXJlLXBhdGgiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9pbmRleC5qcyIsImJhcmUtcnBjIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9pbmRleC5qcyIsImJhcmUtdXJsIjoiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9pbmRleC5qcyJ9LCIvYmFja2VuZC9saWIvaXRlbS5tanMiOnsiI3BhY2thZ2UiOiIvcGFja2FnZS5qc29uIiwiLi4vLi4vcnBjLWNvbW1hbmRzLm1qcyI6Ii9ycGMtY29tbWFuZHMubWpzIiwiLi9zdGF0ZS5tanMiOiIvYmFja2VuZC9saWIvc3RhdGUubWpzIiwiLi91dGlsLm1qcyI6Ii9iYWNrZW5kL2xpYi91dGlsLm1qcyJ9LCIvYmFja2VuZC9saWIva2V5Lm1qcyI6eyIjcGFja2FnZSI6Ii9wYWNrYWdlLmpzb24iLCJiYXJlLWZzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2luZGV4LmpzIn0sIi9iYWNrZW5kL2xpYi9uZXR3b3JrLm1qcyI6eyIjcGFja2FnZSI6Ii9wYWNrYWdlLmpzb24iLCIuLi8uLi9ycGMtY29tbWFuZHMubWpzIjoiL3JwYy1jb21tYW5kcy5tanMiLCIuLi9iYWNrZW5kLm1qcyI6Ii9iYWNrZW5kL2JhY2tlbmQubWpzIiwiLi9pdGVtLm1qcyI6Ii9iYWNrZW5kL2xpYi9pdGVtLm1qcyIsIi4vc3RhdGUubWpzIjoiL2JhY2tlbmQvbGliL3N0YXRlLm1qcyIsImF1dG9iYXNlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9pbmRleC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29yZXN0b3JlIjoiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwiaHlwZXJzd2FybSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9pbmRleC5qcyJ9LCIvYmFja2VuZC9saWIvc3RhdGUubWpzIjp7IiNwYWNrYWdlIjoiL3BhY2thZ2UuanNvbiJ9LCIvYmFja2VuZC9saWIvdXRpbC5tanMiOnsiI3BhY2thZ2UiOiIvcGFja2FnZS5qc29uIiwiYmFyZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9wYWNrYWdlLmpzb24iLCIuL2xpYi9icmlkZ2UiOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vbGliL2JyaWRnZS5qcyIsIi4vbGliL2hhbmRzaGFrZSI6Ii9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9saWIvaGFuZHNoYWtlLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwic29kaXVtLXNlY3JldHN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXNlY3JldHN0cmVhbS9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIiwidGltZW91dC1yZWZyZXNoIjoiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vbGliL2JyaWRnZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9wYWNrYWdlLmpzb24iLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9saWIvaGFuZHNoYWtlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwibm9pc2UtY3VydmUtZWQiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWN1cnZlLWVkL2luZGV4LmpzIiwibm9pc2UtaGFuZHNoYWtlIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2Uvbm9pc2UuanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2VuY29kaW5nL2xlZ2FjeS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImluZGV4LWVuY29kZXIiOiIvbm9kZV9tb2R1bGVzL2luZGV4LWVuY29kZXIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9lbmNvZGluZy9zcGVjL2F1dG9iYXNlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuLi8uLi9sZWdhY3kuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2VuY29kaW5nL2xlZ2FjeS5qcyIsImh5cGVyc2NoZW1hL3J1bnRpbWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc2NoZW1hL3J1bnRpbWUuY2pzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vbGliL2FjdGl2ZS13cml0ZXJzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYWN0aXZlLXdyaXRlcnMuanMiLCIuL2xpYi9hcHBlbmQtYmF0Y2guanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9hcHBlbmQtYmF0Y2guanMiLCIuL2xpYi9hcHBseS1jYWxscy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FwcGx5LWNhbGxzLmpzIiwiLi9saWIvYXBwbHktc3RhdGUuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9hcHBseS1zdGF0ZS5qcyIsIi4vbGliL2Jvb3QuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9ib290LmpzIiwiLi9saWIvY2Fwcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2NhcHMuanMiLCIuL2xpYi9lbmNyeXB0aW9uLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvZW5jcnlwdGlvbi5qcyIsIi4vbGliL2Zhc3QtZm9yd2FyZC5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Zhc3QtZm9yd2FyZC5qcyIsIi4vbGliL2xpbmVhcml6ZXIuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9saW5lYXJpemVyLmpzIiwiLi9saWIvbG9jYWwtc3RhdGUuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9sb2NhbC1zdGF0ZS5qcyIsIi4vbGliL21lc3NhZ2VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiLCIuL2xpYi9zdG9yZS5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N0b3JlLmpzIiwiLi9saWIvc3lzdGVtLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvc3lzdGVtLmpzIiwiLi9saWIvdGltZXIuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi90aW1lci5qcyIsIi4vbGliL3VwZGF0ZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi91cGRhdGVzLmpzIiwiLi9saWIvdmFsdWVzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdmFsdWVzLmpzIiwiLi9saWIvd2FrZXVwLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvd2FrZXVwLmpzIiwiLi9saWIvd3JpdGVyLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvd3JpdGVyLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiY29yZS1jb3VwbGVyIjoiL25vZGVfbW9kdWxlcy9jb3JlLWNvdXBsZXIvaW5kZXguanMiLCJkZWJvdW5jZWlmeSI6Ii9ub2RlX21vZHVsZXMvZGVib3VuY2VpZnkvaW5kZXguanMiLCJoeXBlcmNvcmUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9pbmRleC5qcyIsImh5cGVyY29yZS1pZC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWlkLWVuY29kaW5nL2luZGV4LmpzIiwibmFub2Fzc2VydCI6Ii9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyIsInByb3RvbXV4LXdha2V1cCI6Ii9ub2RlX21vZHVsZXMvcHJvdG9tdXgtd2FrZXVwL2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIiwic2NvcGUtbG9jayI6Ii9ub2RlX21vZHVsZXMvc2NvcGUtbG9jay9pbmRleC5qcyIsInNpZ25hbC1wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9hY3RpdmUtd3JpdGVycy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwZW5kLWJhdGNoLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCJzaWduYWwtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvc2lnbmFsLXByb21pc2UvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwbHktY2FsbHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9hcHBseS1zdGF0ZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9hcHBseS1jYWxscy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FwcGx5LWNhbGxzLmpzIiwiLi9jYXBzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY2Fwcy5qcyIsIi4vZW5jcnlwdGlvbi5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2VuY3J5cHRpb24uanMiLCIuL2ZvcmsuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9mb3JrLmpzIiwiLi9sb2NhbC1zdGF0ZS5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2xvY2FsLXN0YXRlLmpzIiwiLi9tZXNzYWdlcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL21lc3NhZ2VzLmpzIiwiLi9zeXN0ZW0uanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9zeXN0ZW0uanMiLCIuL3VwZGF0ZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi91cGRhdGVzLmpzIiwiLi92YWx1ZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi92YWx1ZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwiaHlwZXJjb3JlL2xpYi9tdWx0aXNpZy5qcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tdWx0aXNpZy5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9ib290LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL21lc3NhZ2VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2NhcHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY2xvY2suanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsInRpbnktYnVmZmVyLW1hcCI6Ii9ub2RlX21vZHVsZXMvdGlueS1idWZmZXItbWFwL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2NvbnNlbnN1cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9jbG9jay5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Nsb2NrLmpzIiwidGlueS1idWZmZXItbWFwIjoiL25vZGVfbW9kdWxlcy90aW55LWJ1ZmZlci1tYXAvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvZW5jcnlwdGlvbi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9jYXBzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY2Fwcy5qcyIsIi4vbWVzc2FnZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9tZXNzYWdlcy5qcyIsIi4vc3lzdGVtLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvc3lzdGVtLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsImh5cGVyY29yZS9saWIvZGVmYXVsdC1lbmNyeXB0aW9uLmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2RlZmF1bHQtZW5jcnlwdGlvbi5qcyIsInJlYWR5LXJlc291cmNlIjoiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9pbmRleC5qcyIsInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Zhc3QtZm9yd2FyZC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9lbmNyeXB0aW9uLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvZW5jcnlwdGlvbi5qcyIsIi4vc3lzdGVtLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvc3lzdGVtLmpzIiwicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2ZvcmsuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vZW5jcnlwdGlvbi5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2VuY3J5cHRpb24uanMiLCIuL21lc3NhZ2VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiLCIuL3N5c3RlbS5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N5c3RlbS5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbGluZWFyaXplci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9jbG9jay5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Nsb2NrLmpzIiwiLi9jb25zZW5zdXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jb25zZW5zdXMuanMiLCIuL3RvcG9saXN0LmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdG9wb2xpc3QuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbG9jYWwtc3RhdGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vbWVzc2FnZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9tZXNzYWdlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi4vZW5jb2Rpbmcvc3BlYy9hdXRvYmFzZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvZW5jb2Rpbmcvc3BlYy9hdXRvYmFzZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9ub2RlLWJ1ZmZlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N0b3JlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL21lc3NhZ2VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJoeXBlcmNvcmUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvc3lzdGVtLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL2NhcHMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jYXBzLmpzIiwiLi9tZXNzYWdlcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL21lc3NhZ2VzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiaHlwZXJiZWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsInJlYWR5LXJlc291cmNlIjoiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9pbmRleC5qcyIsInN1Yi1lbmNvZGVyIjoiL25vZGVfbW9kdWxlcy9zdWItZW5jb2Rlci9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi90aW1lci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdG9wb2xpc3QuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwibmFub2Fzc2VydCI6Ii9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi91cGRhdGVzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdmFsdWVzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL2NhcHMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jYXBzLmpzIiwiLi9lbmNyeXB0aW9uLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvZW5jcnlwdGlvbi5qcyIsIi4vbWVzc2FnZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvd2FrZXVwLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi93cml0ZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vbGluZWFyaXplci5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2xpbmVhcml6ZXIuanMiLCIuL25vZGUtYnVmZmVyLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbm9kZS1idWZmZXIuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJuYW5vYXNzZXJ0IjoiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwic2lnbmFsLXByb21pc2UiOiIvbm9kZV9tb2R1bGVzL3NpZ25hbC1wcm9taXNlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2I0YS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9iNGEvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOmJhcmUtY3J5cHRvLjEuMTIuMC5mcmFtZXdvcmsvYmFyZS1jcnlwdG8uMS4xMi4wIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4vbGliL2NpcGhlciI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NpcGhlci5qcyIsIi4vbGliL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NvbnN0YW50cy5qcyIsIi4vbGliL2hhc2giOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9oYXNoLmpzIiwiLi9saWIvaG1hYyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2htYWMuanMiLCIuL2xpYi9rZXkiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9rZXkuanMiLCIuL2xpYi9wYmtkZjIiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9wYmtkZjIuanMiLCIuL2xpYi9yYW5kb20iOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9yYW5kb20uanMiLCIuL2xpYi9zaWduYXR1cmUiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9zaWduYXR1cmUuanMiLCIuL3dlYiI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vd2ViLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NpcGhlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvY29uc3RhbnRzLmpzIiwiYmFyZS1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NvbnN0YW50cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvZXJyb3JzLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2Vycm9ycy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2hhc2guanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2JpbmRpbmcuanMiLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NvbnN0YW50cy5qcyIsImJhcmUtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9obWFjLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jb25zdGFudHMuanMiLCJiYXJlLXN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1zdHJlYW0vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIva2V5LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jb25zdGFudHMuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvcGJrZGYyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jb25zdGFudHMuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvcmFuZG9tLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3NpZ25hdHVyZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvY29uc3RhbnRzLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vZWQyNTUxOS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vLi4vLi4iOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2luZGV4LmpzIiwiLi4vLi4vLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyIsIi4uLy4uL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2Vycm9ycy5qcyIsIi4uLy4uL2tleSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2tleS5qcyIsIi4uL2NyeXB0by1rZXkiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvY3J5cHRvLWtleS5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL2htYWMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4uLy4uLy4uIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9pbmRleC5qcyIsIi4uLy4uL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2Vycm9ycy5qcyIsIi4uL2NyeXB0by1rZXkiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvY3J5cHRvLWtleS5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL3Bia2RmMi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vLi4vLi4iOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2luZGV4LmpzIiwiLi4vLi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvZXJyb3JzLmpzIiwiLi4vY3J5cHRvLWtleSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9jcnlwdG8ta2V5LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vc2hhLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi8uLi8uLiI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2NyeXB0by1rZXkuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vd2ViLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9pbmRleC5qcyIsIi4vbGliL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2Vycm9ycy5qcyIsIi4vbGliL3dlYi9hbGdvcml0aG0vZWQyNTUxOSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vZWQyNTUxOS5qcyIsIi4vbGliL3dlYi9hbGdvcml0aG0vaG1hYyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vaG1hYy5qcyIsIi4vbGliL3dlYi9hbGdvcml0aG0vcGJrZGYyIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2FsZ29yaXRobS9wYmtkZjIuanMiLCIuL2xpYi93ZWIvYWxnb3JpdGhtL3NoYSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vc2hhLmpzIiwiLi9saWIvd2ViL2NyeXB0by1rZXkiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvY3J5cHRvLWtleS5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9wYWNrYWdlLmpzb24iLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2xpYi9lcnJvcnMuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9saWIvZXJyb3JzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvYmluZGluZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOmJhcmUtZnMuNC41LjIuZnJhbWV3b3JrL2JhcmUtZnMuNC41LjIifSwiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL3BhY2thZ2UuanNvbiIsIi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9iaW5kaW5nLmpzIiwiLi9saWIvY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2xpYi9jb25zdGFudHMuanMiLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvbGliL2Vycm9ycy5qcyIsIi4vcHJvbWlzZXMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvcHJvbWlzZXMuanMiLCJiYXJlLWV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMiLCJiYXJlLXBhdGgiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9pbmRleC5qcyIsImJhcmUtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9pbmRleC5qcyIsImJhcmUtdXJsIjoiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9pbmRleC5qcyIsImZhc3QtZmlmbyI6Ii9ub2RlX21vZHVsZXMvZmFzdC1maWZvL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9saWIvY29uc3RhbnRzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvYmluZGluZy5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvbGliL2Vycm9ycy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9wYWNrYWdlLmpzb24iLCJiYXJlLW9zIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvcHJvbWlzZXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvcGFja2FnZS5qc29uIiwiLiI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9pbmRleC5qcyIsImJhcmUtZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvYmluZGluZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOmJhcmUtb3MuMy42LjIuZnJhbWV3b3JrL2JhcmUtb3MuMy42LjIifSwiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL3BhY2thZ2UuanNvbiIsIi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9iaW5kaW5nLmpzIiwiLi9saWIvY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2xpYi9jb25zdGFudHMuanMiLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvbGliL2Vycm9ycy5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvbGliL2NvbnN0YW50cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2JpbmRpbmcuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2xpYi9lcnJvcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1vcy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL3BhY2thZ2UuanNvbiIsIi4vbGliL3Bvc2l4IjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3Bvc2l4LmpzIiwiLi9saWIvd2luMzIiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvd2luMzIuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL2NvbnN0YW50cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvcG9zaXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9jb25zdGFudHMuanMiLCIuL3NoYXJlZCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9zaGFyZWQuanMiLCIuL3dpbjMyIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3dpbjMyLmpzIiwiYmFyZS1vcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvc2hhcmVkLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvY29uc3RhbnRzLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi93aW4zMi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL2NvbnN0YW50cy5qcyIsIi4vcG9zaXgiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvcG9zaXguanMiLCIuL3NoYXJlZCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9zaGFyZWQuanMiLCJiYXJlLW9zIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiIsIi4vbGliL2NvbW1hbmQtcm91dGVyIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvY29tbWFuZC1yb3V0ZXIuanMiLCIuL2xpYi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9jb25zdGFudHMuanMiLCIuL2xpYi9pbmNvbWluZy1yZXF1ZXN0IjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvaW5jb21pbmctcmVxdWVzdC5qcyIsIi4vbGliL2luY29taW5nLXN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2luY29taW5nLXN0cmVhbS5qcyIsIi4vbGliL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvbWVzc2FnZXMuanMiLCIuL2xpYi9vdXRnb2luZy1yZXF1ZXN0IjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvb3V0Z29pbmctcmVxdWVzdC5qcyIsIi4vbGliL291dGdvaW5nLXN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL291dGdvaW5nLXN0cmVhbS5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2NvbW1hbmQtcm91dGVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24iLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2NvbnN0YW50cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2Vycm9ycy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2luY29taW5nLXJlcXVlc3QuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvZXJyb3JzLmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9pbmNvbWluZy1zdHJlYW0uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvY29uc3RhbnRzLmpzIiwiYmFyZS1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL21lc3NhZ2VzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2NvbnN0YW50cy5qcyIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvZXJyb3JzLmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9vdXRnb2luZy1yZXF1ZXN0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24iLCIuL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2Vycm9ycy5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvb3V0Z29pbmctc3RyZWFtLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2NvbnN0YW50cy5qcyIsImJhcmUtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmFyZS1zdHJlYW0vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL3BhY2thZ2UuanNvbiIsInN0cmVhbXgiOiIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2JpbmRpbmcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL3BhY2thZ2UuanNvbiIsIi4iOiJsaW5rZWQ6YmFyZS11cmwuMi4zLjIuZnJhbWV3b3JrL2JhcmUtdXJsLjIuMy4yIn0sIi9ub2RlX21vZHVsZXMvYmFyZS11cmwvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL3BhY2thZ2UuanNvbiIsIi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS11cmwvYmluZGluZy5qcyIsIi4vbGliL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS11cmwvbGliL2Vycm9ycy5qcyIsIi4vbGliL3VybC1zZWFyY2gtcGFyYW1zIjoiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9saWIvdXJsLXNlYXJjaC1wYXJhbXMuanMiLCJiYXJlLXBhdGgiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2xpYi9lcnJvcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2xpYi91cmwtc2VhcmNoLXBhcmFtcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS11cmwvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYmFyZS11cmwvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iaWctc3BhcnNlLWFycmF5L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iaWctc3BhcnNlLWFycmF5L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JpZy1zcGFyc2UtYXJyYXkvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iaXRzLXRvLWJ5dGVzL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iaXRzLXRvLWJ5dGVzL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYml0cy10by1ieXRlcy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ibGluZC1yZWxheS9wYWNrYWdlLmpzb24iLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L2xpYi9lcnJvcnMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImJpdHMtdG8tYnl0ZXMiOiIvbm9kZV9tb2R1bGVzL2JpdHMtdG8tYnl0ZXMvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZCI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZC9pbmRleC5qcyIsImV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMiLCJwcm90b211eCI6Ii9ub2RlX21vZHVsZXMvcHJvdG9tdXgvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L2xpYi9lcnJvcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYm9nb24vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JvZ29uL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmctbmV0IjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLW5ldC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JvZ29uL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvY29kZWNzL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9jb2RlY3MvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9jb2RlY3MvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkL3BhY2thZ2UuanNvbiIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1uZXQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctbmV0L3BhY2thZ2UuanNvbiIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLW5ldC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvZW5kaWFuLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvcGFja2FnZS5qc29uIiwiLi9lbmRpYW4iOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvZW5kaWFuLmpzIiwiLi9sZXhpbnQiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvbGV4aW50LmpzIiwiLi9yYXciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvcmF3LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2xleGludC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9yYXcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvcGFja2FnZS5qc29uIiwiLi9lbmRpYW4iOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvZW5kaWFuLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9jb3JlLWNvdXBsZXIvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvcmUtY291cGxlci9wYWNrYWdlLmpzb24iLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2NvcmUtY291cGxlci9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvY29yZXN0b3JlL3BhY2thZ2UuanNvbiIsIi4vbGliL2F1ZGl0LmpzIjoiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvbGliL2F1ZGl0LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJoeXBlcmNvcmUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJoeXBlcmNvcmUtZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL2luZGV4LmpzIiwiaHlwZXJjb3JlLWlkLWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIiwid2hpY2gtcnVudGltZSI6Ii9ub2RlX21vZHVsZXMvd2hpY2gtcnVudGltZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9saWIvYXVkaXQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9kZWJvdW5jZWlmeS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZGVib3VuY2VpZnkvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvZGVib3VuY2VpZnkvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9kZXZpY2UtZmlsZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZGV2aWNlLWZpbGUvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJmZC1sb2NrIjoiL25vZGVfbW9kdWxlcy9mZC1sb2NrL2luZGV4LmpzIiwiZnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvaW5kZXguanMiLCJmcy1uYXRpdmUtZXh0ZW5zaW9ucyI6Ii9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvaW5kZXguanMiLCJwYXRoIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9kZXZpY2UtZmlsZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvcGFja2FnZS5qc29uIiwiLi9saWIvY29tbWFuZHMiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2NvbW1hbmRzLmpzIiwiLi9saWIvZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9lcnJvcnMuanMiLCIuL2xpYi9pbyI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvaW8uanMiLCIuL2xpYi9wZWVyIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9wZWVyLmpzIiwiLi9saWIvcXVlcnkiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL3F1ZXJ5LmpzIiwiLi9saWIvc2Vzc2lvbiI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvc2Vzc2lvbi5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMiLCJrYWRlbWxpYS1yb3V0aW5nLXRhYmxlIjoiL25vZGVfbW9kdWxlcy9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlL2luZGV4LmpzIiwibmF0LXNhbXBsZXIiOiIvbm9kZV9tb2R1bGVzL25hdC1zYW1wbGVyL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyIsInRpbWUtb3JkZXJlZC1zZXQiOiIvbm9kZV9tb2R1bGVzL3RpbWUtb3JkZXJlZC1zZXQvaW5kZXguanMiLCJ1ZHgtbmF0aXZlIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi91ZHguanMifSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9jb21tYW5kcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9lcnJvcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvaW8uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvcGFja2FnZS5qc29uIiwiLi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2Vycm9ycy5qcyIsIi4vcGVlciI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvcGVlci5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImZhc3QtZmlmbyI6Ii9ub2RlX21vZHVsZXMvZmFzdC1maWZvL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL3BlZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZy1uZXQiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctbmV0L2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL3F1ZXJ5LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL3BhY2thZ2UuanNvbiIsIi4vY29tbWFuZHMiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2NvbW1hbmRzLmpzIiwiLi9wZWVyIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9wZWVyLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvc2Vzc2lvbi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvZXZlbnRzLXVuaXZlcnNhbC9iYXJlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ldmVudHMtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiIsImJhcmUtZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2V2ZW50cy11bml2ZXJzYWwvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vZml4ZWQtc2l6ZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZmFzdC1maWZvL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZmFzdC1maWZvL3BhY2thZ2UuanNvbiIsIi4vZml4ZWQtc2l6ZSI6Ii9ub2RlX21vZHVsZXMvZmFzdC1maWZvL2ZpeGVkLXNpemUuanMifSwiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9mZC1sb2NrL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9mZC1sb2NrL3BhY2thZ2UuanNvbiIsImZzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2luZGV4LmpzIiwiZnMtbmF0aXZlLWV4dGVuc2lvbnMiOiIvbm9kZV9tb2R1bGVzL2ZzLW5hdGl2ZS1leHRlbnNpb25zL2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwicmVzb3VyY2Utb24tZXhpdCI6Ii9ub2RlX21vZHVsZXMvcmVzb3VyY2Utb24tZXhpdC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2ZkLWxvY2svcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOmZzLW5hdGl2ZS1leHRlbnNpb25zLjEuNC41LmZyYW1ld29yay9mcy1uYXRpdmUtZXh0ZW5zaW9ucy4xLjQuNSIsInJlcXVpcmUtYWRkb24iOiIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vbGliL2JhcmUuanMifSwiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvcGFja2FnZS5qc29uIiwiLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9iaW5kaW5nLmpzIiwid2hpY2gtcnVudGltZSI6Ii9ub2RlX21vZHVsZXMvd2hpY2gtcnVudGltZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2ZzLW5hdGl2ZS1leHRlbnNpb25zL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL3BhY2thZ2UuanNvbiIsIi4vaXRlcmF0b3JzL2RpZmYiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9kaWZmLmpzIiwiLi9pdGVyYXRvcnMvaGlzdG9yeSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL2hpc3RvcnkuanMiLCIuL2l0ZXJhdG9ycy9sb2NhbCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL2xvY2FsLmpzIiwiLi9pdGVyYXRvcnMvcmFuZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9yYW5nZS5qcyIsIi4vbGliL2V4dGVuc2lvbiI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvbGliL2V4dGVuc2lvbi5qcyIsIi4vbGliL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9saWIvbWVzc2FnZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvZGVjcyI6Ii9ub2RlX21vZHVsZXMvY29kZWNzL2luZGV4LmpzIiwiZGVib3VuY2VpZnkiOiIvbm9kZV9tb2R1bGVzL2RlYm91bmNlaWZ5L2luZGV4LmpzIiwiaHlwZXJjb3JlLWVycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9pbmRleC5qcyIsIm11dGV4aWZ5L3Byb21pc2UiOiIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L3Byb21pc2UuanMiLCJyYWNoZSI6Ii9ub2RlX21vZHVsZXMvcmFjaGUvaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJyZXNvbHZlLXJlamVjdC1wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9yZXNvbHZlLXJlamVjdC1wcm9taXNlL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIiwidW5zbGFiIjoiL25vZGVfbW9kdWxlcy91bnNsYWIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvZGlmZi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvaGlzdG9yeS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL2xvY2FsLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvcmFuZ2UuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvbGliL2V4dGVuc2lvbi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvcGFja2FnZS5qc29uIiwiLi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvbGliL21lc3NhZ2VzLmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvbGliL21lc3NhZ2VzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInByb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzIjoiL25vZGVfbW9kdWxlcy9wcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvcGFja2FnZS5qc29uIiwiaHlwZXJjb3JlLWlkLWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWlkLWVuY29kaW5nL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJ6MzIiOiIvbm9kZV9tb2R1bGVzL3ozMi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1pZC1lbmNvZGluZy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCIuL2xpYi9rZXlzLmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIva2V5cy5qcyIsIi4vbGliL3N0cmVhbXMuanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9zdHJlYW1zLmpzIiwiLi9saWIvdHguanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi90eC5qcyIsIi4vbGliL3ZpZXcuanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi92aWV3LmpzIiwiLi9taWdyYXRpb25zLzAiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL21pZ3JhdGlvbnMvMC9pbmRleC5qcyIsImRldmljZS1maWxlIjoiL25vZGVfbW9kdWxlcy9kZXZpY2UtZmlsZS9pbmRleC5qcyIsImZzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2luZGV4LmpzIiwicGF0aCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2luZGV4LmpzIiwicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pbmRleC5qcyIsInJvY2tzZGItbmF0aXZlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9pbmRleC5qcyIsInNjb3BlLWxvY2siOiIvbm9kZV9tb2R1bGVzL3Njb3BlLWxvY2svaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvYmxvY2stZGVwZW5kZW5jeS1zdHJlYW0uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiIsIi4va2V5cyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL2tleXMuanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL2Nsb3NlLWVycm9yLXN0cmVhbS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvcGFja2FnZS5qc29uIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9rZXlzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJpbmRleC1lbmNvZGVyIjoiL25vZGVfbW9kdWxlcy9pbmRleC1lbmNvZGVyL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3N0cmVhbXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiIsIi4uL3NwZWMvaHlwZXJzY2hlbWEiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3NwZWMvaHlwZXJzY2hlbWEvaW5kZXguanMiLCIuL2Jsb2NrLWRlcGVuZGVuY3ktc3RyZWFtLmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvYmxvY2stZGVwZW5kZW5jeS1zdHJlYW0uanMiLCIuL2tleXMuanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9rZXlzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvdHguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiIsIi4uL3NwZWMvaHlwZXJzY2hlbWEiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3NwZWMvaHlwZXJzY2hlbWEvaW5kZXguanMiLCIuL2tleXMuanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9rZXlzLmpzIiwiLi92aWV3LmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvdmlldy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZmxhdC10cmVlIjoiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvdmlldy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvcGFja2FnZS5qc29uIiwiLi9jbG9zZS1lcnJvci1zdHJlYW0uanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9jbG9zZS1lcnJvci1zdHJlYW0uanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInN0cmVhbXgiOiIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9taWdyYXRpb25zLzAvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiIsIi4uLy4uL2xpYi90eC5qcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3R4LmpzIiwiLi4vLi4vbGliL3ZpZXcuanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi92aWV3LmpzIiwiLi9tZXNzYWdlcy5qcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbWlncmF0aW9ucy8wL21lc3NhZ2VzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiZmxhdC10cmVlIjoiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMiLCJmcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJwYXRoIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbWlncmF0aW9ucy8wL21lc3NhZ2VzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3NwZWMvaHlwZXJzY2hlbWEvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiIsImh5cGVyc2NoZW1hL3J1bnRpbWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc2NoZW1hL3J1bnRpbWUuY2pzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiLi9saWIvY2FwcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jYXBzLmpzIiwiLi9saWIvY29yZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb3JlLmpzIiwiLi9saWIvZGVmYXVsdC1lbmNyeXB0aW9uIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2RlZmF1bHQtZW5jcnlwdGlvbi5qcyIsIi4vbGliL2Rvd25sb2FkIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2Rvd25sb2FkLmpzIiwiLi9saWIvaW5mbyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9pbmZvLmpzIiwiLi9saWIvaW5zcGVjdCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9pbnNwZWN0LmpzIiwiLi9saWIvbWVya2xlLXRyZWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVya2xlLXRyZWUuanMiLCIuL2xpYi9yZXBsaWNhdG9yIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3JlcGxpY2F0b3IuanMiLCIuL2xpYi9zdHJlYW1zIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3N0cmVhbXMuanMiLCIuL2xpYi92ZXJpZmllciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi92ZXJpZmllci5qcyIsIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vaW5kZXguanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1pZC1lbmNvZGluZy9pbmRleC5qcyIsImh5cGVyY29yZS1zdG9yYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9pbmRleC5qcyIsImlzLW9wdGlvbnMiOiIvbm9kZV9tb2R1bGVzL2lzLW9wdGlvbnMvaW5kZXguanMiLCJwcm90b211eCI6Ii9ub2RlX21vZHVsZXMvcHJvdG9tdXgvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9hdWRpdC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vbWVya2xlLXRyZWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVya2xlLXRyZWUuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvYml0LWludGVybHVkZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vY29tcGF0IjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NvbXBhdC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9iaXRmaWVsZC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vY29tcGF0IjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NvbXBhdC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiYmlnLXNwYXJzZS1hcnJheSI6Ii9ub2RlX21vZHVsZXMvYmlnLXNwYXJzZS1hcnJheS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY2Fwcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb21wYXQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCJxdWlja2JpdC11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9pbmRleC5qcyIsInF1aWNrYml0LXVuaXZlcnNhbC9mYWxsYmFjayI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL2ZhbGxiYWNrLmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb3B5LXByb2xvZ3VlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiLi9iaXRmaWVsZCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9iaXRmaWVsZC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZmxhdC10cmVlIjoiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwicXVpY2tiaXQtdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NvcmUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2F1ZGl0IjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2F1ZGl0LmpzIiwiLi9iaXQtaW50ZXJsdWRlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2JpdC1pbnRlcmx1ZGUuanMiLCIuL2JpdGZpZWxkIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2JpdGZpZWxkLmpzIiwiLi9jb3B5LXByb2xvZ3VlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NvcHktcHJvbG9ndWUuanMiLCIuL21lcmtsZS10cmVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lcmtsZS10cmVlLmpzIiwiLi9tdXRleCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tdXRleC5qcyIsIi4vcmVtb3RlLWJpdGZpZWxkIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3JlbW90ZS1iaXRmaWVsZC5qcyIsIi4vcmVwbGljYXRvciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZXBsaWNhdG9yLmpzIiwiLi9zZXNzaW9uLXN0YXRlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3Nlc3Npb24tc3RhdGUuanMiLCIuL3ZlcmlmaWVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3ZlcmlmaWVyLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwiaHlwZXJjb3JlLWVycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIiwiejMyIjoiL25vZGVfbW9kdWxlcy96MzIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2RlZmF1bHQtZW5jcnlwdGlvbi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vY2FwcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jYXBzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvZG93bmxvYWQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2hvdHN3YXAtcXVldWUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2luZm8uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2luc3BlY3QuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVya2xlLXRyZWUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2NhcHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY2Fwcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZmxhdC10cmVlIjoiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwiaHlwZXJjb3JlLWVycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXNzYWdlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vY2FwcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jYXBzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiaHlwZXJjb3JlLWVycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tdWx0aXNpZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vbWVya2xlLXRyZWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVya2xlLXRyZWUuanMiLCIuL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lc3NhZ2VzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiZmxhdC10cmVlIjoiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL211dGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZWNlaXZlci1xdWV1ZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsImZhc3QtZmlmbyI6Ii9ub2RlX21vZHVsZXMvZmFzdC1maWZvL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZW1vdGUtYml0ZmllbGQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2NvbXBhdCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb21wYXQuanMiLCJiaWctc3BhcnNlLWFycmF5IjoiL25vZGVfbW9kdWxlcy9iaWctc3BhcnNlLWFycmF5L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZXBsaWNhdG9yLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiLi9jYXBzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NhcHMuanMiLCIuL2hvdHN3YXAtcXVldWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvaG90c3dhcC1xdWV1ZS5qcyIsIi4vbWVya2xlLXRyZWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVya2xlLXRyZWUuanMiLCIuL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lc3NhZ2VzLmpzIiwiLi9tdXRleCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tdXRleC5qcyIsIi4vcmVjZWl2ZXItcXVldWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVjZWl2ZXItcXVldWUuanMiLCIuL3JlbW90ZS1iaXRmaWVsZCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZW1vdGUtYml0ZmllbGQuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIiwiaHlwZXJjb3JlLWVycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9pbmRleC5qcyIsInJhbmRvbS1hcnJheS1pdGVyYXRvciI6Ii9ub2RlX21vZHVsZXMvcmFuZG9tLWFycmF5LWl0ZXJhdG9yL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3Nlc3Npb24tc3RhdGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2JpdGZpZWxkIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2JpdGZpZWxkLmpzIiwiLi9tZXJrbGUtdHJlZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXJrbGUtdHJlZS5qcyIsIi4vbXV0ZXgiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXV0ZXguanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJuYW5vYXNzZXJ0IjoiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L2luZGV4LmpzIiwicXVpY2tiaXQtdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3N0cmVhbXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi92ZXJpZmllci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vY2FwcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jYXBzLmpzIiwiLi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXNzYWdlcy5qcyIsIi4vbXVsdGlzaWciOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXVsdGlzaWcuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJmbGF0LXRyZWUiOiIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJoeXBlcmNvcmUtZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL2luZGV4LmpzIiwidW5zbGFiIjoiL25vZGVfbW9kdWxlcy91bnNsYWIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiLi9saWIvY29ubmVjdCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Nvbm5lY3QuanMiLCIuL2xpYi9jb25uZWN0aW9uLXBvb2wiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25uZWN0aW9uLXBvb2wuanMiLCIuL2xpYi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiLCIuL2xpYi9jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jcnlwdG8uanMiLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lcnJvcnMuanMiLCIuL2xpYi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL21lc3NhZ2VzLmpzIiwiLi9saWIvcGVyc2lzdGVudCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3BlcnNpc3RlbnQuanMiLCIuL2xpYi9yYXctc3RyZWFtLXNldCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3Jhdy1zdHJlYW0tc2V0LmpzIiwiLi9saWIvcm91dGVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvcm91dGVyLmpzIiwiLi9saWIvc2VydmVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VydmVyLmpzIiwiLi9saWIvc29ja2V0LXBvb2wiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zb2NrZXQtcG9vbC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImRodC1ycGMiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvaW5kZXguanMiLCJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1pZC1lbmNvZGluZy9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyIsInhhY2hlIjoiL25vZGVfbW9kdWxlcy94YWNoZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9hbm5vdW5jZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIiwiLi9lbmNvZGUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lbmNvZGUuanMiLCIuL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbWVzc2FnZXMuanMiLCIuL3BlcnNpc3RlbnQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9wZXJzaXN0ZW50LmpzIiwiLi9zbGVlcGVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2xlZXBlci5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyIsInNpZ25hbC1wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25uZWN0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2NvbnN0YW50cy5qcyIsIi4vY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY3J5cHRvLmpzIiwiLi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lcnJvcnMuanMiLCIuL2hvbGVwdW5jaGVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvaG9sZXB1bmNoZXIuanMiLCIuL25vaXNlLXdyYXAiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9ub2lzZS13cmFwLmpzIiwiLi9zZWN1cmUtcGF5bG9hZCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NlY3VyZS1wYXlsb2FkLmpzIiwiLi9zZW1hcGhvcmUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zZW1hcGhvcmUuanMiLCIuL3NsZWVwZXIiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zbGVlcGVyLmpzIiwiQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9pbmRleC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiYmxpbmQtcmVsYXkiOiIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L2luZGV4LmpzIiwiYm9nb24iOiIvbm9kZV9tb2R1bGVzL2JvZ29uL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25uZWN0aW9uLXBvb2wuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZXJyb3JzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2NvbnN0YW50cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jcnlwdG8uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lbmNvZGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lcnJvcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9ob2xlcHVuY2hlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiLCIuL25hdCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL25hdC5qcyIsIi4vc2xlZXBlciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NsZWVwZXIuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9tZXNzYWdlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmctbmV0IjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLW5ldC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9uYXQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4uL2xpYi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbm9pc2Utd3JhcC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiLCIuL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Vycm9ycy5qcyIsIi4vbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9tZXNzYWdlcy5qcyIsIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vaW5kZXguanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJub2lzZS1jdXJ2ZS1lZCI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtY3VydmUtZWQvaW5kZXguanMiLCJub2lzZS1oYW5kc2hha2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9ub2lzZS5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvcGVyc2lzdGVudC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiLCIuL2VuY29kZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2VuY29kZS5qcyIsIi4vbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsInJlY29yZC1jYWNoZSI6Ii9ub2RlX21vZHVsZXMvcmVjb3JkLWNhY2hlL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIiwieGFjaGUiOiIvbm9kZV9tb2R1bGVzL3hhY2hlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3Jhdy1zdHJlYW0tc2V0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvcm91dGVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2NvbnN0YW50cy5qcyIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZXJyb3JzLmpzIiwiLi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL21lc3NhZ2VzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiLCJ4YWNoZSI6Ii9ub2RlX21vZHVsZXMveGFjaGUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VjdXJlLXBheWxvYWQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zZW1hcGhvcmUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zZXJ2ZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vYW5ub3VuY2VyIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvYW5ub3VuY2VyLmpzIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiLCIuL2NyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2NyeXB0by5qcyIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZXJyb3JzLmpzIiwiLi9ob2xlcHVuY2hlciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2hvbGVwdW5jaGVyLmpzIiwiLi9ub2lzZS13cmFwIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbm9pc2Utd3JhcC5qcyIsIi4vc2VjdXJlLXBheWxvYWQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zZWN1cmUtcGF5bG9hZC5qcyIsIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vaW5kZXguanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImJsaW5kLXJlbGF5IjoiL25vZGVfbW9kdWxlcy9ibGluZC1yZWxheS9pbmRleC5qcyIsImJvZ29uIjoiL25vZGVfbW9kdWxlcy9ib2dvbi9pbmRleC5qcyIsImV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zbGVlcGVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc29ja2V0LXBvb2wuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9oeXBlcnNjaGVtYS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc2NoZW1hL3J1bnRpbWUuY2pzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcnNjaGVtYS9wYWNrYWdlLmpzb24iLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9wYWNrYWdlLmpzb24iLCIuL2xpYi9jb25uZWN0aW9uLXNldCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvY29ubmVjdGlvbi1zZXQuanMiLCIuL2xpYi9wZWVyLWRpc2NvdmVyeSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvcGVlci1kaXNjb3ZlcnkuanMiLCIuL2xpYi9wZWVyLWluZm8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL3BlZXItaW5mby5qcyIsIi4vbGliL3JldHJ5LXRpbWVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9yZXRyeS10aW1lci5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyIsImh5cGVyZGh0IjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9pbmRleC5qcyIsInNodWZmbGVkLXByaW9yaXR5LXF1ZXVlIjoiL25vZGVfbW9kdWxlcy9zaHVmZmxlZC1wcmlvcml0eS1xdWV1ZS9pbmRleC5qcyIsInN0cmVhbXgiOiIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL2J1bGstdGltZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvY29ubmVjdGlvbi1zZXQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9wZWVyLWRpc2NvdmVyeS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvcGVlci1pbmZvLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvcmV0cnktdGltZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vcGFja2FnZS5qc29uIiwiLi9idWxrLXRpbWVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9idWxrLXRpbWVyLmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2luZGV4LWVuY29kZXIvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2luZGV4LWVuY29kZXIvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9pbmRleC1lbmNvZGVyL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvaXMtb3B0aW9ucy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaXMtb3B0aW9ucy9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2lzLW9wdGlvbnMvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlL3BhY2thZ2UuanNvbiIsImV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvbXV0ZXhpZnkvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L3BhY2thZ2UuanNvbiIsInF1ZXVlLXRpY2siOiIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcHJvY2Vzcy1uZXh0LXRpY2suanMifSwiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L3Byb21pc2UuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L3BhY2thZ2UuanNvbiIsIi4iOiIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvbmF0LXNhbXBsZXIvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25hdC1zYW1wbGVyL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL25hdC1zYW1wbGVyL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvbm9pc2UtY3VydmUtZWQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWN1cnZlLWVkL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwibmFub2Fzc2VydCI6Ii9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ub2lzZS1jdXJ2ZS1lZC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9jaXBoZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvZGguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2hrZGYuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iLCIuL2htYWMiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9obWFjLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvaG1hYy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9ub2lzZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL3BhY2thZ2UuanNvbiIsIi4vaGtkZiI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2hrZGYuanMiLCIuL3N5bW1ldHJpYy1zdGF0ZSI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL3N5bW1ldHJpYy1zdGF0ZS5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwibmFub2Fzc2VydCI6Ii9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9zeW1tZXRyaWMtc3RhdGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iLCIuL2NpcGhlciI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2NpcGhlci5qcyIsIi4vZGgiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9kaC5qcyIsIi4vaGtkZiI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2hrZGYuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3Byb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwic2lnbmVkLXZhcmludCI6Ii9ub2RlX21vZHVsZXMvc2lnbmVkLXZhcmludC9pbmRleC5qcyIsInZhcmludCI6Ii9ub2RlX21vZHVsZXMvdmFyaW50L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9wcm90b211eC13YWtldXAvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9wYWNrYWdlLmpzb24iLCIuL3NwZWMvaHlwZXJzY2hlbWEiOiIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9zcGVjL2h5cGVyc2NoZW1hL2luZGV4LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwicHJvdG9tdXgiOiIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvcHJvdG9tdXgtd2FrZXVwL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcHJvdG9tdXgtd2FrZXVwL3NwZWMvaHlwZXJzY2hlbWEvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9wYWNrYWdlLmpzb24iLCJoeXBlcnNjaGVtYS9ydW50aW1lIjoiL25vZGVfbW9kdWxlcy9oeXBlcnNjaGVtYS9ydW50aW1lLmNqcyJ9LCIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9wcm90b211eC9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJxdWV1ZS10aWNrIjoiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3Byb2Nlc3MtbmV4dC10aWNrLmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcXVldWUtdGljay9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcHJvY2Vzcy1uZXh0LXRpY2suanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcGFja2FnZS5qc29uIiwiLi9xdWV1ZS1taWNyb3Rhc2siOiIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcXVldWUtbWljcm90YXNrLmpzIn0sIi9ub2RlX21vZHVsZXMvcXVldWUtdGljay9xdWV1ZS1taWNyb3Rhc2suanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtbmF0aXZlL2JpbmRpbmcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOnF1aWNrYml0LW5hdGl2ZS4yLjQuOC5mcmFtZXdvcmsvcXVpY2tiaXQtbmF0aXZlLjIuNC44IiwicmVxdWlyZS1hZGRvbiI6Ii9ub2RlX21vZHVsZXMvcmVxdWlyZS1hZGRvbi9saWIvYmFyZS5qcyJ9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LW5hdGl2ZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtbmF0aXZlL2JpbmRpbmcuanMifSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC1uYXRpdmUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvZmFsbGJhY2suanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iLCJzaW1kbGUtdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zaW1kbGUtdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvcGFja2FnZS5qc29uIiwiLi9mYWxsYmFjayI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL2ZhbGxiYWNrLmpzIiwicXVpY2tiaXQtbmF0aXZlIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC1uYXRpdmUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yYWNoZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcmFjaGUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvcmFjaGUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yYW5kb20tYXJyYXktaXRlcmF0b3IvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3JhbmRvbS1hcnJheS1pdGVyYXRvci9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9yYW5kb20tYXJyYXktaXRlcmF0b3IvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvcGFja2FnZS5qc29uIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcmVjb3JkLWNhY2hlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yZWNvcmQtY2FjaGUvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9yZWNvcmQtY2FjaGUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yZWZjb3VudGVyL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yZWZjb3VudGVyL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3JlZmNvdW50ZXIvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL2xpYi9iYXJlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yZXNvbHZlLXJlamVjdC1wcm9taXNlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yZXNvbHZlLXJlamVjdC1wcm9taXNlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yZXNvdXJjZS1vbi1leGl0L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yZXNvdXJjZS1vbi1leGl0L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3Jlc291cmNlLW9uLWV4aXQvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOnJvY2tzZGItbmF0aXZlLjMuMTEuNC5mcmFtZXdvcmsvcm9ja3NkYi1uYXRpdmUuMy4xMS40IiwicmVxdWlyZS1hZGRvbiI6Ii9ub2RlX21vZHVsZXMvcmVxdWlyZS1hZGRvbi9saWIvYmFyZS5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuL2xpYi9jb2x1bW4tZmFtaWx5IjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvY29sdW1uLWZhbWlseS5qcyIsIi4vbGliL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2NvbnN0YW50cy5qcyIsIi4vbGliL2ZpbHRlci1wb2xpY3kiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9maWx0ZXItcG9saWN5LmpzIiwiLi9saWIvaXRlcmF0b3IiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9pdGVyYXRvci5qcyIsIi4vbGliL3NuYXBzaG90IjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvc25hcHNob3QuanMiLCIuL2xpYi9zdGF0ZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL3N0YXRlLmpzIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2JhdGNoLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9jb2x1bW4tZmFtaWx5LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9jb25zdGFudHMuanMiLCIuL2ZpbHRlci1wb2xpY3kiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9maWx0ZXItcG9saWN5LmpzIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2NvbnN0YW50cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2ZpbHRlci1wb2xpY3kuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9pdGVyYXRvci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvYmluZGluZy5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL3NuYXBzaG90LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL3N0YXRlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIiwiLi9iYXRjaCI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2JhdGNoLmpzIiwiLi9jb2x1bW4tZmFtaWx5IjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvY29sdW1uLWZhbWlseS5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJyZWZjb3VudGVyIjoiL25vZGVfbW9kdWxlcy9yZWZjb3VudGVyL2luZGV4LmpzIiwicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pbmRleC5qcyIsInNpZ25hbC1wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2NvcGUtbG9jay9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc2NvcGUtbG9jay9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9zY29wZS1sb2NrL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2h1ZmZsZWQtcHJpb3JpdHktcXVldWUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NodWZmbGVkLXByaW9yaXR5LXF1ZXVlL3BhY2thZ2UuanNvbiIsInVub3JkZXJlZC1zZXQiOiIvbm9kZV9tb2R1bGVzL3Vub3JkZXJlZC1zZXQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zaHVmZmxlZC1wcmlvcml0eS1xdWV1ZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NpZ25hbC1wcm9taXNlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NpZ25lZC12YXJpbnQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NpZ25lZC12YXJpbnQvcGFja2FnZS5qc29uIiwidmFyaW50IjoiL25vZGVfbW9kdWxlcy92YXJpbnQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zaWduZWQtdmFyaW50L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2ltZGxlLW5hdGl2ZS9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4iOiJsaW5rZWQ6c2ltZGxlLW5hdGl2ZS4xLjMuOS5mcmFtZXdvcmsvc2ltZGxlLW5hdGl2ZS4xLjMuOSIsInJlcXVpcmUtYWRkb24iOiIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vbGliL2JhcmUuanMifSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLW5hdGl2ZS9iaW5kaW5nLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9mYWxsYmFjay5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iLCIuL3NjYWxhciI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9zY2FsYXIuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvcGFja2FnZS5qc29uIiwiLi9mYWxsYmFjayI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9mYWxsYmFjay5qcyIsInNpbWRsZS1uYXRpdmUiOiIvbm9kZV9tb2R1bGVzL3NpbWRsZS1uYXRpdmUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9zY2FsYXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4iOiJsaW5rZWQ6c29kaXVtLW5hdGl2ZS41LjAuMTAuZnJhbWV3b3JrL3NvZGl1bS1uYXRpdmUuNS4wLjEwIiwicmVxdWlyZS1hZGRvbiI6Ii9ub2RlX21vZHVsZXMvcmVxdWlyZS1hZGRvbi9saWIvYmFyZS5qcyJ9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS1uYXRpdmUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS1uYXRpdmUvcGFja2FnZS5qc29uIiwiLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tbmF0aXZlL2JpbmRpbmcuanMiLCJ3aGljaC1ydW50aW1lIjoiL25vZGVfbW9kdWxlcy93aGljaC1ydW50aW1lL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS1zZWNyZXRzdHJlYW0vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS1zZWNyZXRzdHJlYW0vcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvc29kaXVtLXNlY3JldHN0cmVhbS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvcGFja2FnZS5qc29uIiwic29kaXVtLW5hdGl2ZSI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L3BhY2thZ2UuanNvbiIsImV2ZW50cy11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL2V2ZW50cy11bml2ZXJzYWwvYmFyZS5qcyIsImZhc3QtZmlmbyI6Ii9ub2RlX21vZHVsZXMvZmFzdC1maWZvL2luZGV4LmpzIiwidGV4dC1kZWNvZGVyIjoiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zdHJlYW14L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc3ViLWVuY29kZXIvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3N1Yi1lbmNvZGVyL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29kZWNzIjoiL25vZGVfbW9kdWxlcy9jb2RlY3MvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zdWItZW5jb2Rlci9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL3BhY2thZ2UuanNvbiIsIi4vbGliL3Bhc3MtdGhyb3VnaC1kZWNvZGVyIjoiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvbGliL3Bhc3MtdGhyb3VnaC1kZWNvZGVyLmpzIiwiLi9saWIvdXRmOC1kZWNvZGVyIjoiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvbGliL3V0ZjgtZGVjb2Rlci5qcyJ9LCIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9saWIvcGFzcy10aHJvdWdoLWRlY29kZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9saWIvdXRmOC1kZWNvZGVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy90aW1lLW9yZGVyZWQtc2V0L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy90aW1lLW9yZGVyZWQtc2V0L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3RpbWUtb3JkZXJlZC1zZXQvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvYnJvd3Nlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL3BhY2thZ2UuanNvbiIsIi4vYnJvd3NlciI6Ii9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL2Jyb3dzZXIuanMiLCIuL25vZGUiOiIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9ub2RlLmpzIn0sIi9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL25vZGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy90aW55LWJ1ZmZlci1tYXAvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3RpbnktYnVmZmVyLW1hcC9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3RpbnktYnVmZmVyLW1hcC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvYmluZGluZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOnVkeC1uYXRpdmUuMS4xOS4yLmZyYW1ld29yay91ZHgtbmF0aXZlLjEuMTkuMiIsInJlcXVpcmUtYWRkb24iOiIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vbGliL2JhcmUuanMifSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9pcC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9uZXR3b3JrLWludGVyZmFjZXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9iaW5kaW5nLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvc29ja2V0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvYmluZGluZy5qcyIsIi4vaXAiOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL2lwLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvc3RyZWFtLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvYmluZGluZy5qcyIsIi4vaXAiOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL2lwLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvdWR4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvYmluZGluZy5qcyIsIi4vaXAiOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL2lwLmpzIiwiLi9uZXR3b3JrLWludGVyZmFjZXMiOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL25ldHdvcmstaW50ZXJmYWNlcy5qcyIsIi4vc29ja2V0IjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9zb2NrZXQuanMiLCIuL3N0cmVhbSI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvc3RyZWFtLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvdW5vcmRlcmVkLXNldC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdW5vcmRlcmVkLXNldC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy91bm9yZGVyZWQtc2V0L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy91bnNsYWIvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy91bnNsYWIvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy92YXJpbnQvZGVjb2RlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy92YXJpbnQvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvdmFyaW50L2VuY29kZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdmFyaW50L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3ZhcmludC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdmFyaW50L3BhY2thZ2UuanNvbiIsIi4vZGVjb2RlLmpzIjoiL25vZGVfbW9kdWxlcy92YXJpbnQvZGVjb2RlLmpzIiwiLi9lbmNvZGUuanMiOiIvbm9kZV9tb2R1bGVzL3ZhcmludC9lbmNvZGUuanMiLCIuL2xlbmd0aC5qcyI6Ii9ub2RlX21vZHVsZXMvdmFyaW50L2xlbmd0aC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3ZhcmludC9sZW5ndGguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3ZhcmludC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy92YXJpbnQvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy93aGljaC1ydW50aW1lL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy93aGljaC1ydW50aW1lL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3doaWNoLXJ1bnRpbWUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy94YWNoZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMveGFjaGUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMveGFjaGUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy96MzIvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3ozMi9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3ozMi9wYWNrYWdlLmpzb24iOnt9LCIvcGFja2FnZS5qc29uIjp7fSwiL3JwYy1jb21tYW5kcy5tanMiOnsiI3BhY2thZ2UiOiIvcGFja2FnZS5qc29uIn19LCJhZGRvbnMiOlsibGlua2VkOmJhcmUtY3J5cHRvLjEuMTIuMC5mcmFtZXdvcmsvYmFyZS1jcnlwdG8uMS4xMi4wIiwibGlua2VkOmJhcmUtZnMuNC41LjIuZnJhbWV3b3JrL2JhcmUtZnMuNC41LjIiLCJsaW5rZWQ6YmFyZS1vcy4zLjYuMi5mcmFtZXdvcmsvYmFyZS1vcy4zLjYuMiIsImxpbmtlZDpiYXJlLXVybC4yLjMuMi5mcmFtZXdvcmsvYmFyZS11cmwuMi4zLjIiLCJsaW5rZWQ6ZnMtbmF0aXZlLWV4dGVuc2lvbnMuMS40LjUuZnJhbWV3b3JrL2ZzLW5hdGl2ZS1leHRlbnNpb25zLjEuNC41IiwibGlua2VkOnF1aWNrYml0LW5hdGl2ZS4yLjQuOC5mcmFtZXdvcmsvcXVpY2tiaXQtbmF0aXZlLjIuNC44IiwibGlua2VkOnJvY2tzZGItbmF0aXZlLjMuMTEuNC5mcmFtZXdvcmsvcm9ja3NkYi1uYXRpdmUuMy4xMS40IiwibGlua2VkOnNpbWRsZS1uYXRpdmUuMS4zLjkuZnJhbWV3b3JrL3NpbWRsZS1uYXRpdmUuMS4zLjkiLCJsaW5rZWQ6c29kaXVtLW5hdGl2ZS41LjAuMTAuZnJhbWV3b3JrL3NvZGl1bS1uYXRpdmUuNS4wLjEwIiwibGlua2VkOnVkeC1uYXRpdmUuMS4xOS4yLmZyYW1ld29yay91ZHgtbmF0aXZlLjEuMTkuMiJdLCJhc3NldHMiOltdLCJmaWxlcyI6eyIvYmFja2VuZC9iYWNrZW5kLm1qcyI6eyJvZmZzZXQiOjAsImxlbmd0aCI6ODAzNSwibW9kZSI6NDIwfSwiL2JhY2tlbmQvbGliL2l0ZW0ubWpzIjp7Im9mZnNldCI6ODAzNSwibGVuZ3RoIjo4MzA4LCJtb2RlIjo0MjB9LCIvYmFja2VuZC9saWIva2V5Lm1qcyI6eyJvZmZzZXQiOjE2MzQzLCJsZW5ndGgiOjE3NjcsIm1vZGUiOjQyMH0sIi9iYWNrZW5kL2xpYi9uZXR3b3JrLm1qcyI6eyJvZmZzZXQiOjE4MTEwLCJsZW5ndGgiOjExMDU0LCJtb2RlIjo0MjB9LCIvYmFja2VuZC9saWIvc3RhdGUubWpzIjp7Im9mZnNldCI6MjkxNjQsImxlbmd0aCI6MjAwMSwibW9kZSI6NDIwfSwiL2JhY2tlbmQvbGliL3V0aWwubWpzIjp7Im9mZnNldCI6MzExNjUsImxlbmd0aCI6MTY0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vaW5kZXguanMiOnsib2Zmc2V0IjozMTMyOSwibGVuZ3RoIjoxNjcyMiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL2xpYi9icmlkZ2UuanMiOnsib2Zmc2V0Ijo0ODA1MSwibGVuZ3RoIjoxMjczLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vbGliL2hhbmRzaGFrZS5qcyI6eyJvZmZzZXQiOjQ5MzI0LCJsZW5ndGgiOjE5NTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo1MTI3NCwibGVuZ3RoIjoxMTMyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2VuY29kaW5nL2xlZ2FjeS5qcyI6eyJvZmZzZXQiOjUyNDA2LCJsZW5ndGgiOjg4NDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvZW5jb2Rpbmcvc3BlYy9hdXRvYmFzZS9pbmRleC5qcyI6eyJvZmZzZXQiOjYxMjU0LCJsZW5ndGgiOjE4OTE4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2luZGV4LmpzIjp7Im9mZnNldCI6ODAxNzIsImxlbmd0aCI6NTgxNDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FjdGl2ZS13cml0ZXJzLmpzIjp7Im9mZnNldCI6MTM4MzIwLCJsZW5ndGgiOjczNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwZW5kLWJhdGNoLmpzIjp7Im9mZnNldCI6MTM5MDU2LCJsZW5ndGgiOjE0MjYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FwcGx5LWNhbGxzLmpzIjp7Im9mZnNldCI6MTQwNDgyLCJsZW5ndGgiOjIyNzUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FwcGx5LXN0YXRlLmpzIjp7Im9mZnNldCI6MTQyNzU3LCJsZW5ndGgiOjQ1MjM2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9ib290LmpzIjp7Im9mZnNldCI6MTg3OTkzLCJsZW5ndGgiOjM0NjEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2NhcHMuanMiOnsib2Zmc2V0IjoxOTE0NTQsImxlbmd0aCI6NTA1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jbG9jay5qcyI6eyJvZmZzZXQiOjE5MTk1OSwibGVuZ3RoIjo3NDksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2NvbnNlbnN1cy5qcyI6eyJvZmZzZXQiOjE5MjcwOCwibGVuZ3RoIjoxMTc1NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvZW5jcnlwdGlvbi5qcyI6eyJvZmZzZXQiOjIwNDQ2MiwibGVuZ3RoIjo5NDQ0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9mYXN0LWZvcndhcmQuanMiOnsib2Zmc2V0IjoyMTM5MDYsImxlbmd0aCI6NTcxNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvZm9yay5qcyI6eyJvZmZzZXQiOjIxOTYyMCwibGVuZ3RoIjo0MjMwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9saW5lYXJpemVyLmpzIjp7Im9mZnNldCI6MjIzODUwLCJsZW5ndGgiOjk2OTYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2xvY2FsLXN0YXRlLmpzIjp7Im9mZnNldCI6MjMzNTQ2LCJsZW5ndGgiOjIwMTMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL21lc3NhZ2VzLmpzIjp7Im9mZnNldCI6MjM1NTU5LCJsZW5ndGgiOjgyNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbm9kZS1idWZmZXIuanMiOnsib2Zmc2V0IjoyMzYzODYsImxlbmd0aCI6MTU2MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvc3RvcmUuanMiOnsib2Zmc2V0IjoyMzc5NDksImxlbmd0aCI6MTQxMDcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N5c3RlbS5qcyI6eyJvZmZzZXQiOjI1MjA1NiwibGVuZ3RoIjoyMDE3NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdGltZXIuanMiOnsib2Zmc2V0IjoyNzIyMzIsImxlbmd0aCI6MjkzNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdG9wb2xpc3QuanMiOnsib2Zmc2V0IjoyNzUxNjksImxlbmd0aCI6NTEwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdXBkYXRlcy5qcyI6eyJvZmZzZXQiOjI4MDI3NywibGVuZ3RoIjoxMTQ4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi92YWx1ZXMuanMiOnsib2Zmc2V0IjoyODE0MjUsImxlbmd0aCI6MTUzOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvd2FrZXVwLmpzIjp7Im9mZnNldCI6MjgyOTY0LCJsZW5ndGgiOjQwMzQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3dyaXRlci5qcyI6eyJvZmZzZXQiOjI4Njk5OCwibGVuZ3RoIjo4OTAxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjI5NTg5OSwibGVuZ3RoIjoyMjQ5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyI6eyJvZmZzZXQiOjI5ODE0OCwibGVuZ3RoIjo0MDU0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2I0YS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjozMDIyMDIsImxlbmd0aCI6MTE0MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIjp7Im9mZnNldCI6MzAzMzQyLCJsZW5ndGgiOjMzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2luZGV4LmpzIjp7Im9mZnNldCI6MzAzMzc1LCJsZW5ndGgiOjE2MTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NpcGhlci5qcyI6eyJvZmZzZXQiOjMwNDk4NiwibGVuZ3RoIjo3MzY2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jb25zdGFudHMuanMiOnsib2Zmc2V0IjozMTIzNTIsImxlbmd0aCI6MjMxMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvZXJyb3JzLmpzIjp7Im9mZnNldCI6MzE0NjY1LCJsZW5ndGgiOjk1NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvaGFzaC5qcyI6eyJvZmZzZXQiOjMxNTYyMiwibGVuZ3RoIjo4MjksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2htYWMuanMiOnsib2Zmc2V0IjozMTY0NTEsImxlbmd0aCI6MTAxNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIva2V5LmpzIjp7Im9mZnNldCI6MzE3NDY2LCJsZW5ndGgiOjEwNjcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3Bia2RmMi5qcyI6eyJvZmZzZXQiOjMxODUzMywibGVuZ3RoIjo3MTMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3JhbmRvbS5qcyI6eyJvZmZzZXQiOjMxOTI0NiwibGVuZ3RoIjoxNzA3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9zaWduYXR1cmUuanMiOnsib2Zmc2V0IjozMjA5NTMsImxlbmd0aCI6MTAxMCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2FsZ29yaXRobS9lZDI1NTE5LmpzIjp7Im9mZnNldCI6MzIxOTYzLCJsZW5ndGgiOjY5MTgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vaG1hYy5qcyI6eyJvZmZzZXQiOjMyODg4MSwibGVuZ3RoIjo0OTI1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL3Bia2RmMi5qcyI6eyJvZmZzZXQiOjMzMzgwNiwibGVuZ3RoIjoxNDY3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL3NoYS5qcyI6eyJvZmZzZXQiOjMzNTI3MywibGVuZ3RoIjoyOTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9jcnlwdG8ta2V5LmpzIjp7Im9mZnNldCI6MzM1NTcyLCJsZW5ndGgiOjk3MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjozMzY1NDIsImxlbmd0aCI6MTQ3NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by93ZWIuanMiOnsib2Zmc2V0IjozMzgwMTcsImxlbmd0aCI6NzM5MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyI6eyJvZmZzZXQiOjM0NTQxMCwibGVuZ3RoIjo4MDMzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2xpYi9lcnJvcnMuanMiOnsib2Zmc2V0IjozNTM0NDMsImxlbmd0aCI6NjcxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjM1NDExNCwibGVuZ3RoIjoxMzk5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvYmluZGluZy5qcyI6eyJvZmZzZXQiOjM1NTUxMywibGVuZ3RoIjozMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2luZGV4LmpzIjp7Im9mZnNldCI6MzU1NTQ2LCJsZW5ndGgiOjQ4MjY3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvbGliL2NvbnN0YW50cy5qcyI6eyJvZmZzZXQiOjQwMzgxMywibGVuZ3RoIjoxNDk0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvbGliL2Vycm9ycy5qcyI6eyJvZmZzZXQiOjQwNTMwNywibGVuZ3RoIjoxMTYzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NDA2NDcwLCJsZW5ndGgiOjE1NDYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9wcm9taXNlcy5qcyI6eyJvZmZzZXQiOjQwODAxNiwibGVuZ3RoIjoxODY2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvYmluZGluZy5qcyI6eyJvZmZzZXQiOjQwOTg4MiwibGVuZ3RoIjozMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2luZGV4LmpzIjp7Im9mZnNldCI6NDA5OTE1LCJsZW5ndGgiOjI0MzMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1vcy9saWIvY29uc3RhbnRzLmpzIjp7Im9mZnNldCI6NDEyMzQ4LCJsZW5ndGgiOjExMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2xpYi9lcnJvcnMuanMiOnsib2Zmc2V0Ijo0MTI0NjEsImxlbmd0aCI6NDc5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NDEyOTQwLCJsZW5ndGgiOjEwMjMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2luZGV4LmpzIjp7Im9mZnNldCI6NDEzOTYzLCJsZW5ndGgiOjMwNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL2NvbnN0YW50cy5qcyI6eyJvZmZzZXQiOjQxNDI2OSwibGVuZ3RoIjoyNDcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9wb3NpeC5qcyI6eyJvZmZzZXQiOjQxNDUxNiwibGVuZ3RoIjo1OTkxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvc2hhcmVkLmpzIjp7Im9mZnNldCI6NDIwNTA3LCJsZW5ndGgiOjE4ODgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi93aW4zMi5qcyI6eyJvZmZzZXQiOjQyMjM5NSwibGVuZ3RoIjoxMzQyNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NDM1ODIyLCJsZW5ndGgiOjc5NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9pbmRleC5qcyI6eyJvZmZzZXQiOjQzNjYxOCwibGVuZ3RoIjoxMDE5OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvY29tbWFuZC1yb3V0ZXIuanMiOnsib2Zmc2V0Ijo0NDY4MTcsImxlbmd0aCI6MTA3MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvY29uc3RhbnRzLmpzIjp7Im9mZnNldCI6NDQ3ODkwLCJsZW5ndGgiOjI3MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvZXJyb3JzLmpzIjp7Im9mZnNldCI6NDQ4MTYwLCJsZW5ndGgiOjU5NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvaW5jb21pbmctcmVxdWVzdC5qcyI6eyJvZmZzZXQiOjQ0ODc1NywibGVuZ3RoIjoxMjQxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9pbmNvbWluZy1zdHJlYW0uanMiOnsib2Zmc2V0Ijo0NDk5OTgsImxlbmd0aCI6MTI2MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvbWVzc2FnZXMuanMiOnsib2Zmc2V0Ijo0NTEyNjEsImxlbmd0aCI6MzkzNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvb3V0Z29pbmctcmVxdWVzdC5qcyI6eyJvZmZzZXQiOjQ1NTE5NSwibGVuZ3RoIjoxNjcwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9vdXRnb2luZy1zdHJlYW0uanMiOnsib2Zmc2V0Ijo0NTY4NjUsImxlbmd0aCI6MjM3NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo0NTkyMzksImxlbmd0aCI6MTIwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9pbmRleC5qcyI6eyJvZmZzZXQiOjQ2MDQ0NywibGVuZ3RoIjo3NjU4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjQ2ODEwNSwibGVuZ3RoIjoxMzA3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2JpbmRpbmcuanMiOnsib2Zmc2V0Ijo0Njk0MTIsImxlbmd0aCI6MzMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS11cmwvaW5kZXguanMiOnsib2Zmc2V0Ijo0Njk0NDUsImxlbmd0aCI6OTI2MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9saWIvZXJyb3JzLmpzIjp7Im9mZnNldCI6NDc4NzA2LCJsZW5ndGgiOjc3OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9saWIvdXJsLXNlYXJjaC1wYXJhbXMuanMiOnsib2Zmc2V0Ijo0Nzk0ODQsImxlbmd0aCI6Mzg2NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo0ODMzNTEsImxlbmd0aCI6MTEwNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iaWctc3BhcnNlLWFycmF5L2luZGV4LmpzIjp7Im9mZnNldCI6NDg0NDU2LCJsZW5ndGgiOjI0NzEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmlnLXNwYXJzZS1hcnJheS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo0ODY5MjcsImxlbmd0aCI6NjM2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JpdHMtdG8tYnl0ZXMvaW5kZXguanMiOnsib2Zmc2V0Ijo0ODc1NjMsImxlbmd0aCI6MzA4MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iaXRzLXRvLWJ5dGVzL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjQ5MDY0NiwibGVuZ3RoIjo3MDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmxpbmQtcmVsYXkvaW5kZXguanMiOnsib2Zmc2V0Ijo0OTEzNTQsImxlbmd0aCI6MTA4NTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmxpbmQtcmVsYXkvbGliL2Vycm9ycy5qcyI6eyJvZmZzZXQiOjUwMjIwNSwibGVuZ3RoIjoxMDQzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjUwMzI0OCwibGVuZ3RoIjoxMDQ2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JvZ29uL2luZGV4LmpzIjp7Im9mZnNldCI6NTA0Mjk0LCJsZW5ndGgiOjM5NjEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYm9nb24vcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTA4MjU1LCJsZW5ndGgiOjY1NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb2RlY3MvaW5kZXguanMiOnsib2Zmc2V0Ijo1MDg5MTIsImxlbmd0aCI6MjQxNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb2RlY3MvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTExMzI4LCJsZW5ndGgiOjY1NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkL2luZGV4LmpzIjp7Im9mZnNldCI6NTExOTgzLCJsZW5ndGgiOjE5NjMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo1MTM5NDYsImxlbmd0aCI6ODI3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctbmV0L2luZGV4LmpzIjp7Im9mZnNldCI6NTE0NzczLCJsZW5ndGgiOjQxMDksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1uZXQvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTE4ODgyLCJsZW5ndGgiOjczNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2VuZGlhbi5qcyI6eyJvZmZzZXQiOjUxOTYxNiwibGVuZ3RoIjoxMDUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyI6eyJvZmZzZXQiOjUxOTcyMSwibGVuZ3RoIjoyMzYzNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2xleGludC5qcyI6eyJvZmZzZXQiOjU0MzM1NSwibGVuZ3RoIjoyODUxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTQ2MjA2LCJsZW5ndGgiOjgwMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL3Jhdy5qcyI6eyJvZmZzZXQiOjU0NzAwNywibGVuZ3RoIjo0MDkzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvcmUtY291cGxlci9pbmRleC5qcyI6eyJvZmZzZXQiOjU1MTEwMCwibGVuZ3RoIjoyMjQzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvcmUtY291cGxlci9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo1NTMzNDMsImxlbmd0aCI6NTk5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9pbmRleC5qcyI6eyJvZmZzZXQiOjU1Mzk0MiwibGVuZ3RoIjoxNzg2MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvbGliL2F1ZGl0LmpzIjp7Im9mZnNldCI6NTcxODA0LCJsZW5ndGgiOjQ3NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTcyMjc5LCJsZW5ndGgiOjEwODUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGVib3VuY2VpZnkvaW5kZXguanMiOnsib2Zmc2V0Ijo1NzMzNjQsImxlbmd0aCI6NTg1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RlYm91bmNlaWZ5L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjU3Mzk0OSwibGVuZ3RoIjo1NjcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGV2aWNlLWZpbGUvaW5kZXguanMiOnsib2Zmc2V0Ijo1NzQ1MTYsImxlbmd0aCI6NTkwMCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kZXZpY2UtZmlsZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo1ODA0MTYsImxlbmd0aCI6MTA2MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2luZGV4LmpzIjp7Im9mZnNldCI6NTgxNDc5LCJsZW5ndGgiOjI1NDAzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2NvbW1hbmRzLmpzIjp7Im9mZnNldCI6NjA2ODgyLCJsZW5ndGgiOjgyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2Vycm9ycy5qcyI6eyJvZmZzZXQiOjYwNjk2NCwibGVuZ3RoIjo3MTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvaW8uanMiOnsib2Zmc2V0Ijo2MDc2ODMsImxlbmd0aCI6MTU5MjYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvcGVlci5qcyI6eyJvZmZzZXQiOjYyMzYwOSwibGVuZ3RoIjo2MzEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvcXVlcnkuanMiOnsib2Zmc2V0Ijo2MjQyNDAsImxlbmd0aCI6OTkxMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9zZXNzaW9uLmpzIjp7Im9mZnNldCI6NjM0MTUzLCJsZW5ndGgiOjExMDMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo2MzUyNTYsImxlbmd0aCI6MTM1NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ldmVudHMtdW5pdmVyc2FsL2JhcmUuanMiOnsib2Zmc2V0Ijo2MzY2MTIsImxlbmd0aCI6NDAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZXZlbnRzLXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo2MzY2NTIsImxlbmd0aCI6OTA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9maXhlZC1zaXplLmpzIjp7Im9mZnNldCI6NjM3NTYwLCJsZW5ndGgiOjg3NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vaW5kZXguanMiOnsib2Zmc2V0Ijo2Mzg0MzUsImxlbmd0aCI6OTcyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo2Mzk0MDcsImxlbmd0aCI6NjgyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2ZkLWxvY2svaW5kZXguanMiOnsib2Zmc2V0Ijo2NDAwODksImxlbmd0aCI6MTY2MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9mZC1sb2NrL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjY0MTc1MCwibGVuZ3RoIjoxMDk5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9pbmRleC5qcyI6eyJvZmZzZXQiOjY0Mjg0OSwibGVuZ3RoIjo4MTY0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo2NTEwMTMsImxlbmd0aCI6NjMxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2ZzLW5hdGl2ZS1leHRlbnNpb25zL2JpbmRpbmcuanMiOnsib2Zmc2V0Ijo2NTE2NDQsImxlbmd0aCI6OTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvaW5kZXguanMiOnsib2Zmc2V0Ijo2NTE3MzQsImxlbmd0aCI6NTcxOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo2NTc0NTIsImxlbmd0aCI6MTY5OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pbmRleC5qcyI6eyJvZmZzZXQiOjY1OTE1MSwibGVuZ3RoIjo0NjEyMCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvZGlmZi5qcyI6eyJvZmZzZXQiOjcwNTI3MSwibGVuZ3RoIjo1MzY4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9oaXN0b3J5LmpzIjp7Im9mZnNldCI6NzEwNjM5LCJsZW5ndGgiOjE2NDIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL2xvY2FsLmpzIjp7Im9mZnNldCI6NzEyMjgxLCJsZW5ndGgiOjExODAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL3JhbmdlLmpzIjp7Im9mZnNldCI6NzEzNDYxLCJsZW5ndGgiOjQ3MzQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvbGliL2V4dGVuc2lvbi5qcyI6eyJvZmZzZXQiOjcxODE5NSwibGVuZ3RoIjozNDQ1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2xpYi9tZXNzYWdlcy5qcyI6eyJvZmZzZXQiOjcyMTY0MCwibGVuZ3RoIjoyODE2MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo3NDk4MDIsImxlbmd0aCI6MTIxNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIjp7Im9mZnNldCI6NzUxMDE4LCJsZW5ndGgiOjUwNDAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo3NTYwNTgsImxlbmd0aCI6NzcxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiOnsib2Zmc2V0Ijo3NTY4MjksImxlbmd0aCI6NDg5NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjc2MTcyNSwibGVuZ3RoIjo2ODgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWlkLWVuY29kaW5nL2luZGV4LmpzIjp7Im9mZnNldCI6NzYyNDEzLCJsZW5ndGgiOjkyMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NzYzMzM2LCJsZW5ndGgiOjc5OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9pbmRleC5qcyI6eyJvZmZzZXQiOjc2NDEzNSwibGVuZ3RoIjoyNzU1MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvYmxvY2stZGVwZW5kZW5jeS1zdHJlYW0uanMiOnsib2Zmc2V0Ijo3OTE2ODYsImxlbmd0aCI6MjU1NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvY2xvc2UtZXJyb3Itc3RyZWFtLmpzIjp7Im9mZnNldCI6Nzk0MjQzLCJsZW5ndGgiOjI3NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIva2V5cy5qcyI6eyJvZmZzZXQiOjc5NDUxOSwibGVuZ3RoIjo3NDU0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9zdHJlYW1zLmpzIjp7Im9mZnNldCI6ODAxOTczLCJsZW5ndGgiOjQ4MjAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3R4LmpzIjp7Im9mZnNldCI6ODA2NzkzLCJsZW5ndGgiOjg0MTYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3ZpZXcuanMiOnsib2Zmc2V0Ijo4MTUyMDksImxlbmd0aCI6ODM3OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9taWdyYXRpb25zLzAvaW5kZXguanMiOnsib2Zmc2V0Ijo4MjM1ODcsImxlbmd0aCI6MjAxMjUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbWlncmF0aW9ucy8wL21lc3NhZ2VzLmpzIjp7Im9mZnNldCI6ODQzNzEyLCJsZW5ndGgiOjI2MjEwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjg2OTkyMiwibGVuZ3RoIjoxMjQ4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3NwZWMvaHlwZXJzY2hlbWEvaW5kZXguanMiOnsib2Zmc2V0Ijo4NzExNzAsImxlbmd0aCI6MTMxMDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2luZGV4LmpzIjp7Im9mZnNldCI6ODg0Mjc4LCJsZW5ndGgiOjMzODU1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvYXVkaXQuanMiOnsib2Zmc2V0Ijo5MTgxMzMsImxlbmd0aCI6MzgzNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2JpdC1pbnRlcmx1ZGUuanMiOnsib2Zmc2V0Ijo5MjE5NjcsImxlbmd0aCI6NDI1NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2JpdGZpZWxkLmpzIjp7Im9mZnNldCI6OTI2MjI0LCJsZW5ndGgiOjExODU0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY2Fwcy5qcyI6eyJvZmZzZXQiOjkzODA3OCwibGVuZ3RoIjoxNTM3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY29tcGF0LmpzIjp7Im9mZnNldCI6OTM5NjE1LCJsZW5ndGgiOjQ3NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NvcHktcHJvbG9ndWUuanMiOnsib2Zmc2V0Ijo5NDAwOTIsImxlbmd0aCI6NTk5OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NvcmUuanMiOnsib2Zmc2V0Ijo5NDYwOTEsImxlbmd0aCI6MjQ0MTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9kZWZhdWx0LWVuY3J5cHRpb24uanMiOnsib2Zmc2V0Ijo5NzA1MTAsImxlbmd0aCI6MzQ1MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2Rvd25sb2FkLmpzIjp7Im9mZnNldCI6OTczOTYzLCJsZW5ndGgiOjEyNzgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9ob3Rzd2FwLXF1ZXVlLmpzIjp7Im9mZnNldCI6OTc1MjQxLCJsZW5ndGgiOjE0OTgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9pbmZvLmpzIjp7Im9mZnNldCI6OTc2NzM5LCJsZW5ndGgiOjE1MTcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9pbnNwZWN0LmpzIjp7Im9mZnNldCI6OTc4MjU2LCJsZW5ndGgiOjE5ODMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXJrbGUtdHJlZS5qcyI6eyJvZmZzZXQiOjk4MDIzOSwibGVuZ3RoIjozMzkxMCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lc3NhZ2VzLmpzIjp7Im9mZnNldCI6MTAxNDE0OSwibGVuZ3RoIjoyNzYzMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL211bHRpc2lnLmpzIjp7Im9mZnNldCI6MTA0MTc4MiwibGVuZ3RoIjoyODUxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXV0ZXguanMiOnsib2Zmc2V0IjoxMDQ0NjMzLCJsZW5ndGgiOjEwMjgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZWNlaXZlci1xdWV1ZS5qcyI6eyJvZmZzZXQiOjEwNDU2NjEsImxlbmd0aCI6MTQxMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3JlbW90ZS1iaXRmaWVsZC5qcyI6eyJvZmZzZXQiOjEwNDcwNzQsImxlbmd0aCI6ODA3OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3JlcGxpY2F0b3IuanMiOnsib2Zmc2V0IjoxMDU1MTUzLCJsZW5ndGgiOjgwNzgxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvc2Vzc2lvbi1zdGF0ZS5qcyI6eyJvZmZzZXQiOjExMzU5MzQsImxlbmd0aCI6MzIyMjUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9zdHJlYW1zLmpzIjp7Im9mZnNldCI6MTE2ODE1OSwibGVuZ3RoIjozMDM0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvdmVyaWZpZXIuanMiOnsib2Zmc2V0IjoxMTcxMTkzLCJsZW5ndGgiOjk2NzgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjExODA4NzEsImxlbmd0aCI6MjE5NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9pbmRleC5qcyI6eyJvZmZzZXQiOjExODMwNjgsImxlbmd0aCI6MTYwOTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Fubm91bmNlci5qcyI6eyJvZmZzZXQiOjExOTkxNjcsImxlbmd0aCI6NzUzMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29ubmVjdC5qcyI6eyJvZmZzZXQiOjEyMDY3MDAsImxlbmd0aCI6MjM2NjgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Nvbm5lY3Rpb24tcG9vbC5qcyI6eyJvZmZzZXQiOjEyMzAzNjgsImxlbmd0aCI6MzA1MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIjp7Im9mZnNldCI6MTIzMzQxOCwibGVuZ3RoIjoxMjExLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jcnlwdG8uanMiOnsib2Zmc2V0IjoxMjM0NjI5LCJsZW5ndGgiOjYzMiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZW5jb2RlLmpzIjp7Im9mZnNldCI6MTIzNTI2MSwibGVuZ3RoIjo0NDYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Vycm9ycy5qcyI6eyJvZmZzZXQiOjEyMzU3MDcsImxlbmd0aCI6MzcxMiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvaG9sZXB1bmNoZXIuanMiOnsib2Zmc2V0IjoxMjM5NDE5LCJsZW5ndGgiOjEwMDAzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9tZXNzYWdlcy5qcyI6eyJvZmZzZXQiOjEyNDk0MjIsImxlbmd0aCI6MTEyNjYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL25hdC5qcyI6eyJvZmZzZXQiOjEyNjA2ODgsImxlbmd0aCI6NDcxNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbm9pc2Utd3JhcC5qcyI6eyJvZmZzZXQiOjEyNjU0MDIsImxlbmd0aCI6MTY2OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvcGVyc2lzdGVudC5qcyI6eyJvZmZzZXQiOjEyNjcwNzEsImxlbmd0aCI6ODA4NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvcmF3LXN0cmVhbS1zZXQuanMiOnsib2Zmc2V0IjoxMjc1MTU3LCJsZW5ndGgiOjE1MTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3JvdXRlci5qcyI6eyJvZmZzZXQiOjEyNzY2NjgsImxlbmd0aCI6Njk3OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VjdXJlLXBheWxvYWQuanMiOnsib2Zmc2V0IjoxMjgzNjQ2LCJsZW5ndGgiOjE0OTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NlbWFwaG9yZS5qcyI6eyJvZmZzZXQiOjEyODUxMzcsImxlbmd0aCI6MTU3NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VydmVyLmpzIjp7Im9mZnNldCI6MTI4NjcxNCwibGVuZ3RoIjoyMTE1NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2xlZXBlci5qcyI6eyJvZmZzZXQiOjEzMDc4NzAsImxlbmd0aCI6NjkwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zb2NrZXQtcG9vbC5qcyI6eyJvZmZzZXQiOjEzMDg1NjAsImxlbmd0aCI6NDM0MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxMzEyOTAzLCJsZW5ndGgiOjIwMTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJzY2hlbWEvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTMxNDkxNCwibGVuZ3RoIjoxNTU2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc2NoZW1hL3J1bnRpbWUuY2pzIjp7Im9mZnNldCI6MTMxNjQ3MCwibGVuZ3RoIjo1NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2luZGV4LmpzIjp7Im9mZnNldCI6MTMxNjUyNCwibGVuZ3RoIjoxODQyOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9idWxrLXRpbWVyLmpzIjp7Im9mZnNldCI6MTMzNDk1MywibGVuZ3RoIjo3MjgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvY29ubmVjdGlvbi1zZXQuanMiOnsib2Zmc2V0IjoxMzM1NjgxLCJsZW5ndGgiOjgyMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9wZWVyLWRpc2NvdmVyeS5qcyI6eyJvZmZzZXQiOjEzMzY1MDQsImxlbmd0aCI6OTI4NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9wZWVyLWluZm8uanMiOnsib2Zmc2V0IjoxMzQ1NzkwLCJsZW5ndGgiOjI2ODgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvcmV0cnktdGltZXIuanMiOnsib2Zmc2V0IjoxMzQ4NDc4LCJsZW5ndGgiOjE4ODksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxMzUwMzY3LCJsZW5ndGgiOjEyMjgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaW5kZXgtZW5jb2Rlci9pbmRleC5qcyI6eyJvZmZzZXQiOjEzNTE1OTUsImxlbmd0aCI6Njc2MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9pbmRleC1lbmNvZGVyL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjEzNTgzNTcsImxlbmd0aCI6NzI5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2lzLW9wdGlvbnMvaW5kZXguanMiOnsib2Zmc2V0IjoxMzU5MDg2LCJsZW5ndGgiOjE0MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9pcy1vcHRpb25zL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjEzNTkyMjYsImxlbmd0aCI6NjA1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2thZGVtbGlhLXJvdXRpbmctdGFibGUvaW5kZXguanMiOnsib2Zmc2V0IjoxMzU5ODMxLCJsZW5ndGgiOjQxNDUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMva2FkZW1saWEtcm91dGluZy10YWJsZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxMzYzOTc2LCJsZW5ndGgiOjk2NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9pbmRleC5qcyI6eyJvZmZzZXQiOjEzNjQ5NDMsImxlbmd0aCI6NTM2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjEzNjU0NzksImxlbmd0aCI6Njc5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L3Byb21pc2UuanMiOnsib2Zmc2V0IjoxMzY2MTU4LCJsZW5ndGgiOjMyNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L2luZGV4LmpzIjp7Im9mZnNldCI6MTM2NjQ4MiwibGVuZ3RoIjo0MzgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxMzY2OTIwLCJsZW5ndGgiOjY0NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9uYXQtc2FtcGxlci9pbmRleC5qcyI6eyJvZmZzZXQiOjEzNjc1NjcsImxlbmd0aCI6MTU1MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9uYXQtc2FtcGxlci9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxMzY5MTE3LCJsZW5ndGgiOjYwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1jdXJ2ZS1lZC9pbmRleC5qcyI6eyJvZmZzZXQiOjEzNjk3MjUsImxlbmd0aCI6MTY0MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1jdXJ2ZS1lZC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxMzcxMzY3LCJsZW5ndGgiOjgwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvY2lwaGVyLmpzIjp7Im9mZnNldCI6MTM3MjE3NSwibGVuZ3RoIjoyODE3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9kaC5qcyI6eyJvZmZzZXQiOjEzNzQ5OTIsImxlbmd0aCI6MTQzOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvaGtkZi5qcyI6eyJvZmZzZXQiOjEzNzY0MzEsImxlbmd0aCI6MTA5MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvaG1hYy5qcyI6eyJvZmZzZXQiOjEzNzc1MjMsImxlbmd0aCI6MTI3MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2Uvbm9pc2UuanMiOnsib2Zmc2V0IjoxMzc4Nzk2LCJsZW5ndGgiOjY0MzcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjEzODUyMzMsImxlbmd0aCI6NjM4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9zeW1tZXRyaWMtc3RhdGUuanMiOnsib2Zmc2V0IjoxMzg1ODcxLCJsZW5ndGgiOjIyMDYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MvaW5kZXguanMiOnsib2Zmc2V0IjoxMzg4MDc3LCJsZW5ndGgiOjY0ODksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTM5NDU2NiwibGVuZ3RoIjo3MTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcHJvdG9tdXgtd2FrZXVwL2luZGV4LmpzIjp7Im9mZnNldCI6MTM5NTI4NSwibGVuZ3RoIjoxNjgyNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9wcm90b211eC13YWtldXAvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQxMjEwOSwibGVuZ3RoIjo5NzIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcHJvdG9tdXgtd2FrZXVwL3NwZWMvaHlwZXJzY2hlbWEvaW5kZXguanMiOnsib2Zmc2V0IjoxNDEzMDgxLCJsZW5ndGgiOjMzMzUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcHJvdG9tdXgvaW5kZXguanMiOnsib2Zmc2V0IjoxNDE2NDE2LCJsZW5ndGgiOjE4OTk2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0MzU0MTIsImxlbmd0aCI6ODE2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQzNjIyOCwibGVuZ3RoIjo2NjksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcXVldWUtdGljay9wcm9jZXNzLW5leHQtdGljay5qcyI6eyJvZmZzZXQiOjE0MzY4OTcsImxlbmd0aCI6MTYwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcXVldWUtbWljcm90YXNrLmpzIjp7Im9mZnNldCI6MTQzNzA1NywibGVuZ3RoIjoxMDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtbmF0aXZlL2JpbmRpbmcuanMiOnsib2Zmc2V0IjoxNDM3MTY1LCJsZW5ndGgiOjkwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LW5hdGl2ZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE0MzcyNTUsImxlbmd0aCI6NDY4MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC1uYXRpdmUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQ0MTkzOCwibGVuZ3RoIjoxMTA0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9mYWxsYmFjay5qcyI6eyJvZmZzZXQiOjE0NDMwNDIsImxlbmd0aCI6MTAyMDQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL2luZGV4LmpzIjp7Im9mZnNldCI6MTQ1MzI0NiwibGVuZ3RoIjo0NDIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0NTM2ODgsImxlbmd0aCI6OTA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JhY2hlL2luZGV4LmpzIjp7Im9mZnNldCI6MTQ1NDU5NiwibGVuZ3RoIjoyNDYzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JhY2hlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0NTcwNTksImxlbmd0aCI6NjAyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JhbmRvbS1hcnJheS1pdGVyYXRvci9pbmRleC5qcyI6eyJvZmZzZXQiOjE0NTc2NjEsImxlbmd0aCI6MTAwMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yYW5kb20tYXJyYXktaXRlcmF0b3IvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQ1ODY2MiwibGVuZ3RoIjo3MDAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiOnsib2Zmc2V0IjoxNDU5MzYyLCJsZW5ndGgiOjEwOTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQ2MDQ1MywibGVuZ3RoIjo4MTIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVjb3JkLWNhY2hlL2luZGV4LmpzIjp7Im9mZnNldCI6MTQ2MTI2NSwibGVuZ3RoIjozNjY4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JlY29yZC1jYWNoZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDY0OTMzLCJsZW5ndGgiOjYxMiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZWZjb3VudGVyL2luZGV4LmpzIjp7Im9mZnNldCI6MTQ2NTU0NSwibGVuZ3RoIjo2MTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVmY291bnRlci9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDY2MTU2LCJsZW5ndGgiOjQ1MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL2xpYi9iYXJlLmpzIjp7Im9mZnNldCI6MTQ2NjYwNywibGVuZ3RoIjo0NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0NjY2NTIsImxlbmd0aCI6MTQ0OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZXNvbHZlLXJlamVjdC1wcm9taXNlL2luZGV4LmpzIjp7Im9mZnNldCI6MTQ2ODEwMSwibGVuZ3RoIjo0NDMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDY4NTQ0LCJsZW5ndGgiOjU4MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZXNvdXJjZS1vbi1leGl0L2luZGV4LmpzIjp7Im9mZnNldCI6MTQ2OTEyNSwibGVuZ3RoIjozNjEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVzb3VyY2Utb24tZXhpdC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDY5NDg2LCJsZW5ndGgiOjQ5NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIjp7Im9mZnNldCI6MTQ2OTk4MiwibGVuZ3RoIjo5MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE0NzAwNzIsImxlbmd0aCI6NDcwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvYmF0Y2guanMiOnsib2Zmc2V0IjoxNDc0NzgwLCJsZW5ndGgiOjg4MTIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2NvbHVtbi1mYW1pbHkuanMiOnsib2Zmc2V0IjoxNDgzNTkyLCJsZW5ndGgiOjI2NzQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2NvbnN0YW50cy5qcyI6eyJvZmZzZXQiOjE0ODYyNjYsImxlbmd0aCI6OTQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2ZpbHRlci1wb2xpY3kuanMiOnsib2Zmc2V0IjoxNDg2MzYwLCJsZW5ndGgiOjQzNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvaXRlcmF0b3IuanMiOnsib2Zmc2V0IjoxNDg2Nzk3LCJsZW5ndGgiOjQzMTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL3NuYXBzaG90LmpzIjp7Im9mZnNldCI6MTQ5MTEwOCwibGVuZ3RoIjo1MDMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL3N0YXRlLmpzIjp7Im9mZnNldCI6MTQ5MTYxMSwibGVuZ3RoIjo5NzYyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MDEzNzMsImxlbmd0aCI6MTUzOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiOnsib2Zmc2V0IjoxNTAyOTEyLCJsZW5ndGgiOjUwNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTUwMzQxOCwibGVuZ3RoIjo1NDcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2NvcGUtbG9jay9pbmRleC5qcyI6eyJvZmZzZXQiOjE1MDM5NjUsImxlbmd0aCI6MTgyMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zY29wZS1sb2NrL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MDU3ODYsImxlbmd0aCI6NjExLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NodWZmbGVkLXByaW9yaXR5LXF1ZXVlL2luZGV4LmpzIjp7Im9mZnNldCI6MTUwNjM5NywibGVuZ3RoIjoyNjA3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NodWZmbGVkLXByaW9yaXR5LXF1ZXVlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MDkwMDQsImxlbmd0aCI6NjkxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpZ25hbC1wcm9taXNlL2luZGV4LmpzIjp7Im9mZnNldCI6MTUwOTY5NSwibGVuZ3RoIjoxMjUyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpZ25hbC1wcm9taXNlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MTA5NDcsImxlbmd0aCI6NTAzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpZ25lZC12YXJpbnQvaW5kZXguanMiOnsib2Zmc2V0IjoxNTExNDUwLCJsZW5ndGgiOjQzNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaWduZWQtdmFyaW50L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MTE4ODUsImxlbmd0aCI6NTIzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS1uYXRpdmUvYmluZGluZy5qcyI6eyJvZmZzZXQiOjE1MTI0MDgsImxlbmd0aCI6OTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2ltZGxlLW5hdGl2ZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE1MTI0OTgsImxlbmd0aCI6MzQ3NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MTU5NzIsImxlbmd0aCI6MTExNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtdW5pdmVyc2FsL2ZhbGxiYWNrLmpzIjp7Im9mZnNldCI6MTUxNzA4NywibGVuZ3RoIjo1MTM3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvaW5kZXguanMiOnsib2Zmc2V0IjoxNTIyMjI0LCJsZW5ndGgiOjEwMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MjIzMjcsImxlbmd0aCI6ODc5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvc2NhbGFyLmpzIjp7Im9mZnNldCI6MTUyMzIwNiwibGVuZ3RoIjo0NjksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9iaW5kaW5nLmpzIjp7Im9mZnNldCI6MTUyMzY3NSwibGVuZ3RoIjo4OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tbmF0aXZlL2luZGV4LmpzIjp7Im9mZnNldCI6MTUyMzc2NCwibGVuZ3RoIjo2NjMyOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tbmF0aXZlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1OTAwOTIsImxlbmd0aCI6MTM1NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tc2VjcmV0c3RyZWFtL2luZGV4LmpzIjp7Im9mZnNldCI6MTU5MTQ0OCwibGVuZ3RoIjoyMjU3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS1zZWNyZXRzdHJlYW0vcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTU5MzcwNSwibGVuZ3RoIjo2NTcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyI6eyJvZmZzZXQiOjE1OTQzNjIsImxlbmd0aCI6NDIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTk0NDA0LCJsZW5ndGgiOjEyMTcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyI6eyJvZmZzZXQiOjE1OTU2MjEsImxlbmd0aCI6MzMzNTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc3RyZWFteC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjI4OTcxLCJsZW5ndGgiOjgzNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zdWItZW5jb2Rlci9pbmRleC5qcyI6eyJvZmZzZXQiOjE2Mjk4MDcsImxlbmd0aCI6MTk2OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zdWItZW5jb2Rlci9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjMxNzc1LCJsZW5ndGgiOjkwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvaW5kZXguanMiOnsib2Zmc2V0IjoxNjMyNjgzLCJsZW5ndGgiOjEzNzgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL2xpYi9wYXNzLXRocm91Z2gtZGVjb2Rlci5qcyI6eyJvZmZzZXQiOjE2MzQwNjEsImxlbmd0aCI6MjczLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9saWIvdXRmOC1kZWNvZGVyLmpzIjp7Im9mZnNldCI6MTYzNDMzNCwibGVuZ3RoIjoyNTI5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjM2ODYzLCJsZW5ndGgiOjk4NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90aW1lLW9yZGVyZWQtc2V0L2luZGV4LmpzIjp7Im9mZnNldCI6MTYzNzg1MCwibGVuZ3RoIjoxNDQ0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RpbWUtb3JkZXJlZC1zZXQvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTYzOTI5NCwibGVuZ3RoIjo2NjYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL2Jyb3dzZXIuanMiOnsib2Zmc2V0IjoxNjM5OTYwLCJsZW5ndGgiOjEwOTgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL2luZGV4LmpzIjp7Im9mZnNldCI6MTY0MTA1OCwibGVuZ3RoIjoxODQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL25vZGUuanMiOnsib2Zmc2V0IjoxNjQxMjQyLCJsZW5ndGgiOjkyOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTY0MjE3MCwibGVuZ3RoIjo2MTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGlueS1idWZmZXItbWFwL2luZGV4LmpzIjp7Im9mZnNldCI6MTY0Mjc4OSwibGVuZ3RoIjo5MzYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGlueS1idWZmZXItbWFwL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2NDM3MjUsImxlbmd0aCI6NjUwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvYmluZGluZy5qcyI6eyJvZmZzZXQiOjE2NDQzNzUsImxlbmd0aCI6OTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvaXAuanMiOnsib2Zmc2V0IjoxNjQ0NDY1LCJsZW5ndGgiOjIyMDQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvbmV0d29yay1pbnRlcmZhY2VzLmpzIjp7Im9mZnNldCI6MTY0NjY2OSwibGVuZ3RoIjoxMzQxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL3NvY2tldC5qcyI6eyJvZmZzZXQiOjE2NDgwMTAsImxlbmd0aCI6NzU1NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9zdHJlYW0uanMiOnsib2Zmc2V0IjoxNjU1NTY3LCJsZW5ndGgiOjEyNzA2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL3VkeC5qcyI6eyJvZmZzZXQiOjE2NjgyNzMsImxlbmd0aCI6Mjg2OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2NzExNDEsImxlbmd0aCI6MTYxNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91bm9yZGVyZWQtc2V0L2luZGV4LmpzIjp7Im9mZnNldCI6MTY3Mjc1NiwibGVuZ3RoIjo2NzcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdW5vcmRlcmVkLXNldC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjczNDMzLCJsZW5ndGgiOjY1NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91bnNsYWIvaW5kZXguanMiOnsib2Zmc2V0IjoxNjc0MDg3LCJsZW5ndGgiOjkxMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91bnNsYWIvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTY3NTAwMCwibGVuZ3RoIjo2MTMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdmFyaW50L2RlY29kZS5qcyI6eyJvZmZzZXQiOjE2NzU2MTMsImxlbmd0aCI6NTA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3ZhcmludC9lbmNvZGUuanMiOnsib2Zmc2V0IjoxNjc2MTIxLCJsZW5ndGgiOjQ1MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy92YXJpbnQvaW5kZXguanMiOnsib2Zmc2V0IjoxNjc2NTczLCJsZW5ndGgiOjEzNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy92YXJpbnQvbGVuZ3RoLmpzIjp7Im9mZnNldCI6MTY3NjcwNywibGVuZ3RoIjo0NzEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdmFyaW50L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2NzcxNzgsImxlbmd0aCI6NTExLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3doaWNoLXJ1bnRpbWUvaW5kZXguanMiOnsib2Zmc2V0IjoxNjc3Njg5LCJsZW5ndGgiOjEyMzEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvd2hpY2gtcnVudGltZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjc4OTIwLCJsZW5ndGgiOjYwMiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy94YWNoZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE2Nzk1MjIsImxlbmd0aCI6MjM3OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy94YWNoZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjgxOTAwLCJsZW5ndGgiOjU4NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy96MzIvaW5kZXguanMiOnsib2Zmc2V0IjoxNjgyNDg0LCJsZW5ndGgiOjI2NTQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvejMyL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2ODUxMzgsImxlbmd0aCI6NzAxLCJtb2RlIjo0MjB9LCIvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTY4NTgzOSwibGVuZ3RoIjoyMjI5LCJtb2RlIjo0MjB9LCIvcnBjLWNvbW1hbmRzLm1qcyI6eyJvZmZzZXQiOjE2ODgwNjgsImxlbmd0aCI6Mzc5LCJtb2RlIjo0MjB9fX0KaW1wb3J0IFJQQyBmcm9tICdiYXJlLXJwYycKaW1wb3J0IFVSTCBmcm9tICdiYXJlLXVybCcKaW1wb3J0IHsgam9pbiB9IGZyb20gJ2JhcmUtcGF0aCcKaW1wb3J0IHsKICAgIFJQQ19VUERBVEUsCiAgICBSUENfQURELAogICAgUlBDX0RFTEVURSwKICAgIFJQQ19HRVRfS0VZLAogICAgUlBDX0pPSU5fS0VZLAogICAgUlBDX0FERF9GUk9NX0JBQ0tFTkQsCiAgICBSUENfVVBEQVRFX0ZST01fQkFDS0VORCwKICAgIFJQQ19ERUxFVEVfRlJPTV9CQUNLRU5ELAogICAgU1lOQ19MSVNULAogICAgUlBDX1JFUVVFU1RfU1lOQwp9IGZyb20gJy4uL3JwYy1jb21tYW5kcy5tanMnCmltcG9ydCBiNGEgZnJvbSAnYjRhJwppbXBvcnQge3N5bmNMaXN0VG9Gcm9udGVuZCwgdmFsaWRhdGVJdGVtLCBhZGRJdGVtLCB1cGRhdGVJdGVtLCBkZWxldGVJdGVtfSBmcm9tICcuL2xpYi9pdGVtLm1qcycKY29uc3QgeyBJUEMgfSA9IEJhcmVLaXQKaW1wb3J0IHtsb2FkQXV0b2Jhc2VLZXl9IGZyb20gIi4vbGliL2tleS5tanMiOwppbXBvcnQge2luaXRBdXRvYmFzZSwgam9pbk5ld0Jhc2V9IGZyb20gIi4vbGliL25ldHdvcmsubWpzIjsKaW1wb3J0IHsKICAgIGF1dG9iYXNlLAogICAgc3RvcmUsCiAgICBzd2FybSwKICAgIGNoYXRTd2FybSwKICAgIGRpc2NvdmVyeSwKICAgIHJwYywKICAgIGN1cnJlbnRMaXN0LAogICAgYmFzZUtleSwKICAgIHNldFJwYywKICAgIHNldEN1cnJlbnRMaXN0LCBzZXRCYXNlS2V5Cn0gZnJvbSAiLi9saWIvc3RhdGUubWpzIjsKCgoKCmNvbnN0IGFyZ3YwID0gdHlwZW9mIEJhcmU/LmFyZ3Y/LlswXSA9PT0gJ3N0cmluZycgPyBCYXJlLmFyZ3ZbMF0gOiAnJzsKbGV0IGJhc2VEaXIgPSAnJzsKaWYgKGFyZ3YwKSB7CiAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBiYXNlRGlyID0gYXJndjAuc3RhcnRzV2l0aCgnZmlsZTovLycpID8gVVJMLmZpbGVVUkxUb1BhdGgoYXJndjApIDogYXJndjA7CiAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgYmFzZURpciA9ICcnOwogICAgICAgICAgfQogICAgfQpleHBvcnQgY29uc3Qgc3RvcmFnZVBhdGggPSBiYXNlRGlyID8gam9pbihiYXNlRGlyLCAnbGlzdGEnKSA6ICcuL2RhdGEnOwpleHBvcnQgY29uc3QgcGVlcktleXNTdHJpbmcgPSBCYXJlLmFyZ3ZbMV0gfHwgJycgLy8gQ29tbWEtc2VwYXJhdGVkIHBlZXIga2V5cwpjb25zdCBiYXNlS2V5SGV4ID0gQmFyZS5hcmd2WzJdIHx8ICcnIC8vIE9wdGlvbmFsIEF1dG9iYXNlIGtleSAodG8gam9pbiBhbiBleGlzdGluZyBiYXNlKQpjb25zdCBrZXlGaWxlUGF0aCA9IGJhc2VEaXIgPyBqb2luKGJhc2VEaXIsICdsaXN0YS1hdXRvYmFzZS1rZXkudHh0JykgOiAnLi9hdXRvYmFzZS1rZXkudHh0JzsKY29uc3QgbG9jYWxXcml0ZXJLZXlGaWxlUGF0aCA9IGJhc2VEaXIgPyBqb2luKGJhc2VEaXIsICdsaXN0YS1sb2NhbC13cml0ZXIta2V5LnR4dCcpIDogJy4vbG9jYWwtd3JpdGVyLWtleS50eHQnOwoKCi8vIE9wdGlvbmFsIEF1dG9iYXNlIGtleSBmcm9tIGFyZ3YgKGluaXRpYWwgYmFzZSkgb3IgbG9hZGVkIGZyb20gZmlsZQppZiAoYmFzZUtleUhleCkgewogICAgdHJ5IHsKICAgICAgICBzZXRCYXNlS2V5KEJ1ZmZlci5mcm9tKGJhc2VLZXlIZXgudHJpbSgpLCAnaGV4JykpCiAgICAgICAgY29uc29sZS5lcnJvcignVXNpbmcgZXhpc3RpbmcgQXV0b2Jhc2Uga2V5IGZyb20gYXJndlsyXTonLCBiYXNlS2V5SGV4LnRyaW0oKSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ludmFsaWQgYmFzZSBrZXkgaGV4LCBjcmVhdGluZyBuZXcgYmFzZSBpbnN0ZWFkOicsIGVyci5tZXNzYWdlKQogICAgICAgIHNldEJhc2VLZXkobnVsbCkKICAgIH0KfQoKLy8gSWYgbm8ga2V5IGZyb20gYXJndiwgdHJ5IGxvYWRpbmcgZnJvbSBmaWxlIChmb3IgcmVzdGFydCBwZXJzaXN0ZW5jZSkKaWYgKCFiYXNlS2V5KSB7CiAgICBzZXRCYXNlS2V5KGxvYWRBdXRvYmFzZUtleShrZXlGaWxlUGF0aCkpCn0KCi8vIENyZWF0ZSBSUEMgc2VydmVyCmxldCBycGNHZW5lcmF0ZWQgPSBuZXcgUlBDKElQQywgYXN5bmMgKHJlcSwgZXJyb3IpID0+IHsKICAgIGNvbnNvbGUuZXJyb3IoJ2dvdCBhIHJlcXVlc3QgZnJvbSByZWFjdCcsIHJlcSkKICAgIGlmIChlcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ2dvdCBhbiBlcnJvciBmcm9tIHJlYWN0JywgZXJyb3IpCiAgICB9CiAgICB0cnkgewogICAgICAgIHN3aXRjaCAocmVxLmNvbW1hbmQpIHsKICAgICAgICAgICAgY2FzZSBSUENfQUREOiB7CiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0ID0gSlNPTi5wYXJzZShiNGEudG9TdHJpbmcocmVxLmRhdGEpKQogICAgICAgICAgICAgICAgYXdhaXQgYWRkSXRlbSh0ZXh0KQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJQQ19VUERBVEU6IHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKHJlcS5kYXRhLnRvU3RyaW5nKCkpCiAgICAgICAgICAgICAgICBhd2FpdCB1cGRhdGVJdGVtKGRhdGEuaXRlbSkKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSUENfREVMRVRFOiB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShyZXEuZGF0YS50b1N0cmluZygpKQogICAgICAgICAgICAgICAgYXdhaXQgZGVsZXRlSXRlbShkYXRhLml0ZW0pCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUlBDX0dFVF9LRVk6IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ2NvbW1hbmQgUlBDX0dFVF9LRVknKQogICAgICAgICAgICAgICAgaWYgKCFhdXRvYmFzZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1JQQ19HRVRfS0VZIHJlcXVlc3RlZCBiZWZvcmUgQXV0b2Jhc2UgaXMgcmVhZHknKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCBrZXlSZXEgPSBycGMucmVxdWVzdChSUENfR0VUX0tFWSkKICAgICAgICAgICAgICAgIGtleVJlcS5zZW5kKGF1dG9iYXNlLmxvY2FsLmtleS50b1N0cmluZygnaGV4JykpCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUlBDX0pPSU5fS0VZOiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdjb21tYW5kIFJQQ19KT0lOX0tFWScpCiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShyZXEuZGF0YS50b1N0cmluZygpKQogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignSm9pbmluZyBuZXcgYmFzZSBrZXkgZnJvbSBSUEM6JywgZGF0YS5rZXkpCiAgICAgICAgICAgICAgICBhd2FpdCBqb2luTmV3QmFzZShkYXRhLmtleSkKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSUENfUkVRVUVTVF9TWU5DOiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdjb21tYW5kIFJQQ19SRVFVRVNUX1NZTkMgLSBmcm9udGVuZCByZXF1ZXN0aW5nIGN1cnJlbnQgbGlzdCcpCiAgICAgICAgICAgICAgICBzeW5jTGlzdFRvRnJvbnRlbmQoKQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGhhbmRsaW5nIFJQQyByZXF1ZXN0OicsIGVycikKICAgIH0KfSkKc2V0UnBjKHJwY0dlbmVyYXRlZCkKCi8vIEluaXRpYWxpemUgQXV0b2Jhc2UgZm9yIHRoZSBpbml0aWFsIGJhc2VLZXkgKGZyb20gYXJndiBvciBuZXcpCmF3YWl0IGluaXRBdXRvYmFzZShiYXNlS2V5KS50aGVuKCgpID0+IHsKICAgIGNvbnNvbGUuZXJyb3IoJ0F1dG9iYXNlIHJlYWR5IDEyMycpCn0pLmNhdGNoKChlcnIpID0+IHsKICAgIGNvbnNvbGUuZXJyb3IoJ2luaXRBdXRvYmFzZSBmYWlsZWQgYXQgc3RhcnR1cDonLCBlcnIpCn0pCgovLyBCYWNrZW5kIHJlYWR5CmNvbnNvbGUuZXJyb3IoJ0JhY2tlbmQgcmVhZHknKQoKLy8gQ2xlYW51cCBvbiB0ZWFyZG93bgpCYXJlLm9uKCd0ZWFyZG93bicsIGFzeW5jICgpID0+IHsKICAgIGNvbnNvbGUuZXJyb3IoJ0JhY2tlbmQgc2h1dHRpbmcgZG93bi4uLicpCiAgICB0cnkgewogICAgICAgIGF3YWl0IHN3YXJtLmRlc3Ryb3koKQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGRlc3Ryb3lpbmcgcmVwbGljYXRpb24gc3dhcm06JywgZSkKICAgIH0KICAgIGlmIChjaGF0U3dhcm0pIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCBjaGF0U3dhcm0uZGVzdHJveSgpCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBkZXN0cm95aW5nIGNoYXQgc3dhcm06JywgZSkKICAgICAgICB9CiAgICB9CiAgICBpZiAoZGlzY292ZXJ5KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgZGlzY292ZXJ5LmRlc3Ryb3koKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZGVzdHJveWluZyBkaXNjb3Zlcnk6JywgZSkKICAgICAgICB9CiAgICB9CiAgICB0cnkgewogICAgICAgIGF3YWl0IHN0b3JlLmZsdXNoKCkKICAgICAgICBhd2FpdCBzdG9yZS5jbG9zZSgpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgY2xvc2luZyBzdG9yZTonLCBlKQogICAgfQogICAgY29uc29sZS5lcnJvcignQmFja2VuZCBzaHV0ZG93biBjb21wbGV0ZScpCn0pCgpleHBvcnQgZnVuY3Rpb24gb3BlbiAoc3RvcmUpIHsKICAgIGNvbnN0IHZpZXcgPSBzdG9yZS5nZXQoewogICAgICAgIG5hbWU6ICd0ZXN0JywKICAgICAgICB2YWx1ZUVuY29kaW5nOiAnanNvbicKICAgIH0pCiAgICBjb25zb2xlLmVycm9yKCdvcGVuaW5nIHN0b3JlLi4uJywgdmlldykKICAgIHJldHVybiB2aWV3Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhcHBseSAobm9kZXMsIHZpZXcsIGhvc3QpIHsKICAgIGNvbnNvbGUuZXJyb3IoJ2FwcGx5IHN0YXJ0ZWQnKQogICAgZm9yIChjb25zdCB7IHZhbHVlIH0gb2Ygbm9kZXMpIHsKICAgICAgICBpZiAoIXZhbHVlKSBjb250aW51ZQoKICAgICAgICAvLyBIYW5kbGUgd3JpdGVyIG1lbWJlcnNoaXAgdXBkYXRlcyBjb21pbmcgZnJvbSBoYW5kc2hha2UKICAgICAgICBpZiAodmFsdWUudHlwZSA9PT0gJ2FkZC13cml0ZXInICYmIHR5cGVvZiB2YWx1ZS5rZXkgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb25zdCB3cml0ZXJLZXkgPSBCdWZmZXIuZnJvbSh2YWx1ZS5rZXksICdoZXgnKQogICAgICAgICAgICAgICAgYXdhaXQgaG9zdC5hZGRXcml0ZXIod3JpdGVyS2V5LCB7IGluZGV4ZXI6IGZhbHNlIH0pCiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdBZGRlZCB3cml0ZXIgZnJvbSBhZGQtd3JpdGVyIG9wOicsIHZhbHVlLmtleSkKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gYWRkIHdyaXRlciBmcm9tIGFkZC13cml0ZXIgb3A6JywgZXJyKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQoKICAgICAgICBpZiAodmFsdWUudHlwZSA9PT0gJ2FkZCcpIHsKICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZUl0ZW0odmFsdWUudmFsdWUpKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdJbnZhbGlkIGl0ZW0gc2NoZW1hIGluIGFkZCBvcGVyYXRpb246JywgdmFsdWUudmFsdWUpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0FwcGx5aW5nIGFkZCBvcGVyYXRpb24gZm9yIGl0ZW06JywgdmFsdWUudmFsdWUpCiAgICAgICAgICAgIC8vIFBlcnNpc3QgaXRlbSB0byB2aWV3CiAgICAgICAgICAgIGF3YWl0IHZpZXcuYXBwZW5kKHZhbHVlLnZhbHVlKQogICAgICAgICAgICAvLyBVcGRhdGUgaW4tbWVtb3J5IGxpc3QKICAgICAgICAgICAgc2V0Q3VycmVudExpc3QoW3ZhbHVlLnZhbHVlLCAuLi5jdXJyZW50TGlzdC5maWx0ZXIoaSA9PiBpLnRleHQgIT09IHZhbHVlLnZhbHVlLnRleHQpXSkKICAgICAgICAgICAgY29uc3QgYWRkUmVxID0gcnBjLnJlcXVlc3QoUlBDX0FERF9GUk9NX0JBQ0tFTkQpCiAgICAgICAgICAgIGFkZFJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHZhbHVlLnZhbHVlKSkKICAgICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIGlmICh2YWx1ZS50eXBlID09PSAnZGVsZXRlJykgewogICAgICAgICAgICBpZiAoIXZhbGlkYXRlSXRlbSh2YWx1ZS52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ludmFsaWQgaXRlbSBzY2hlbWEgaW4gZGVsZXRlIG9wZXJhdGlvbjonLCB2YWx1ZS52YWx1ZSkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc29sZS5lcnJvcignQXBwbHlpbmcgZGVsZXRlIG9wZXJhdGlvbiBmb3IgaXRlbTonLCB2YWx1ZS52YWx1ZSkKICAgICAgICAgICAgLy8gVXBkYXRlIGluLW1lbW9yeSBsaXN0CiAgICAgICAgICAgIHNldEN1cnJlbnRMaXN0KGN1cnJlbnRMaXN0LmZpbHRlcihpID0+IGkudGV4dCAhPT0gdmFsdWUudmFsdWUudGV4dCkpCiAgICAgICAgICAgIGNvbnN0IGRlbGV0ZVJlcSA9IHJwYy5yZXF1ZXN0KFJQQ19ERUxFVEVfRlJPTV9CQUNLRU5EKQogICAgICAgICAgICBkZWxldGVSZXEuc2VuZChKU09OLnN0cmluZ2lmeSh2YWx1ZS52YWx1ZSkpCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQoKICAgICAgICBpZiAodmFsdWUudHlwZSA9PT0gJ3VwZGF0ZScpIHsKICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZUl0ZW0odmFsdWUudmFsdWUpKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdJbnZhbGlkIGl0ZW0gc2NoZW1hIGluIHVwZGF0ZSBvcGVyYXRpb246JywgdmFsdWUudmFsdWUpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0FwcGx5aW5nIHVwZGF0ZSBvcGVyYXRpb24gZm9yIGl0ZW06JywgdmFsdWUudmFsdWUpCiAgICAgICAgICAgIC8vIFVwZGF0ZSBpbi1tZW1vcnkgbGlzdAogICAgICAgICAgICBzZXRDdXJyZW50TGlzdChjdXJyZW50TGlzdC5tYXAoaSA9PgogICAgICAgICAgICAgICAgaS50ZXh0ID09PSB2YWx1ZS52YWx1ZS50ZXh0ID8gdmFsdWUudmFsdWUgOiBpCiAgICAgICAgICAgICkpCiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZVJlcSA9IHJwYy5yZXF1ZXN0KFJQQ19VUERBVEVfRlJPTV9CQUNLRU5EKQogICAgICAgICAgICB1cGRhdGVSZXEuc2VuZChKU09OLnN0cmluZ2lmeSh2YWx1ZS52YWx1ZSkpCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQoKICAgICAgICBpZiAodmFsdWUudHlwZSA9PT0gJ2xpc3QnKSB7CiAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZS52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ludmFsaWQgbGlzdCBvcGVyYXRpb24gcGF5bG9hZCwgZXhwZWN0ZWQgYXJyYXk6JywgdmFsdWUudmFsdWUpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0FwcGx5aW5nIGxpc3Qgb3BlcmF0aW9uIGZvciBpdGVtczonLCB2YWx1ZS52YWx1ZSkKICAgICAgICAgICAgY29uc3QgdXBkYXRlUmVxID0gcnBjLnJlcXVlc3QoU1lOQ19MSVNUKQogICAgICAgICAgICB1cGRhdGVSZXEuc2VuZChKU09OLnN0cmluZ2lmeSh2YWx1ZS52YWx1ZSkpCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQoKICAgICAgICAvLyBBbGwgb3RoZXIgdmFsdWVzIGFyZSBhcHBlbmRlZCB0byB0aGUgdmlldyAoZm9yIGZ1dHVyZSB1c2UpCiAgICAgICAgYXdhaXQgdmlldy5hcHBlbmQodmFsdWUpCiAgICB9Cn0KCgovLyBBZGQgaXRlbSBvcGVyYXRpb24gKGJhY2tlbmQgY3JlYXRlcyB0aGUgY2Fub25pY2FsIGl0ZW0pCmltcG9ydCB7UlBDX01FU1NBR0V9IGZyb20gIi4uLy4uL3JwYy1jb21tYW5kcy5tanMiOwppbXBvcnQge2dlbmVyYXRlSWR9IGZyb20gIi4vdXRpbC5tanMiOwppbXBvcnQge2F1dG9iYXNlLCBzdG9yZSwgcnBjLCBjdXJyZW50TGlzdH0gZnJvbSAnLi9zdGF0ZS5tanMnCmltcG9ydCB7U1lOQ19MSVNUfSBmcm9tICIuLi8uLi9ycGMtY29tbWFuZHMubWpzIjsKCi8vIC0tLSBXUklURSBTRVJJQUxJWkFUSU9OIChwcmV2ZW50cyBjb25jdXJyZW50IGF1dG9iYXNlLmFwcGVuZCAvIGZsdXNoIHJhY2VzKSAtLS0KbGV0IF93cml0ZUNoYWluID0gUHJvbWlzZS5yZXNvbHZlKCkKCmZ1bmN0aW9uIGVucXVldWVXcml0ZSAoZm4pIHsKICAgIC8vIGVuc3VyZXMgd3JpdGVzIHJ1biBvbmUtYXQtYS10aW1lIGV2ZW4gaWYgUlBDIGNhbGxzIGFycml2ZSBjb25jdXJyZW50bHkKICAgIF93cml0ZUNoYWluID0gX3dyaXRlQ2hhaW4udGhlbihmbiwgZm4pCiAgICByZXR1cm4gX3dyaXRlQ2hhaW4KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGFkZEl0ZW0gKHRleHQsIGxpc3RJZCkgewogICAgaWYgKCFhdXRvYmFzZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ2FkZEl0ZW0gY2FsbGVkIGJlZm9yZSBBdXRvYmFzZSBpcyBpbml0aWFsaXplZCcpCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgaWYgKCFhdXRvYmFzZS53cml0YWJsZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ2FkZEl0ZW0gY2FsbGVkIGJ1dCBhdXRvYmFzZSBpcyBub3Qgd3JpdGFibGUgeWV0IC0gd2FpdGluZyB0byBiZSBhZGRlZCBhcyB3cml0ZXInKQogICAgICAgIC8vIE5vdGlmeSBmcm9udGVuZCBhYm91dCBub3QgYmVpbmcgd3JpdGFibGUKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCByZXEgPSBycGMucmVxdWVzdChSUENfTUVTU0FHRSkKICAgICAgICAgICAgcmVxLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyB0eXBlOiAnbm90LXdyaXRhYmxlJywgbWVzc2FnZTogJ1dhaXRpbmcgdG8gYmUgYWRkZWQgYXMgYSB3cml0ZXIgYnkgdGhlIGhvc3QuLi4nIH0pKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHNlbmQgbm90LXdyaXRhYmxlIG1lc3NhZ2U6JywgZSkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc29sZS5lcnJvcignY29tbWFuZCBSUENfQUREIGFkZEl0ZW0gdGV4dCcsIHRleHQpCgogICAgY29uc3QgaXRlbSA9IHsKICAgICAgICBpZDogZ2VuZXJhdGVJZCgpLCAgICAgICAgICAgICAgICAgICAgLy8gZXh0cmEgbWV0YWRhdGEsIGZyb250ZW5kIGNhbiBpZ25vcmUKICAgICAgICB0ZXh0LAogICAgICAgIGlzRG9uZTogZmFsc2UsCiAgICAgICAgbGlzdElkOiBsaXN0SWQgfHwgbnVsbCwKICAgICAgICB0aW1lT2ZDb21wbGV0aW9uOiAwLAogICAgICAgIHVwZGF0ZWRBdDogRGF0ZS5ub3coKSwKICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICB9CgogICAgY29uc3Qgb3AgPSB7CiAgICAgICAgdHlwZTogJ2FkZCcsCiAgICAgICAgdmFsdWU6IGl0ZW0KICAgIH0KCiAgICByZXR1cm4gZW5xdWV1ZVdyaXRlKGFzeW5jICgpID0+IHsKICAgICAgICBpZiAoIWF1dG9iYXNlKSByZXR1cm4gZmFsc2UKICAgICAgICBpZiAoYXV0b2Jhc2UuY2xvc2luZykgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdNdXRhdGlvbiByZXF1ZXN0ZWQgd2hpbGUgQXV0b2Jhc2UgaXMgY2xvc2luZzsgaWdub3JpbmcuJykKICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQogICAgICAgIC8vIEdldCBsZW5ndGggYmVmb3JlIGFwcGVuZCB0byB2ZXJpZnkgaXQgaW5jcmVhc2VzCiAgICAgICAgLy8gY29uc3QgbGVuZ3RoQmVmb3JlID0gYXV0b2Jhc2UubG9jYWwubGVuZ3RoCgogICAgICAgIGF3YWl0IGF1dG9iYXNlLmFwcGVuZChvcCkKCiAgICAgICAgLy8gRmx1c2ggdG8gZGlzayBhbmQgdmVyaWZ5IHBlcnNpc3RlbmNlCiAgICAgICAgLy8gY29uc3QgcGVyc2lzdGVkID0gYXdhaXQgcGVyc2lzdEFuZFZlcmlmeShsZW5ndGhCZWZvcmUgKyAxLCAnQUREJykKICAgICAgICAvLyBpZiAoIXBlcnNpc3RlZCkgewogICAgICAgIC8vICAgICBjb25zb2xlLmVycm9yKCdXQVJOSU5HOiBBZGQgb3BlcmF0aW9uIG1heSBub3QgaGF2ZSBiZWVuIHBlcnNpc3RlZCB0byBkaXNrIScpCiAgICAgICAgLy8gfQoKICAgICAgICBjb25zb2xlLmVycm9yKCdBZGRlZCBpdGVtOicsIHRleHQpCiAgICAgICAgcmV0dXJuIHRydWUKICAgIH0pCn0KCi8vIFVwZGF0ZSBpdGVtIG9wZXJhdGlvbjogQVVUT05PTU9VUywgTk8gQkFDS0VORCBNRU1PUlkKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUl0ZW0gKGl0ZW0pIHsKICAgIGlmICghYXV0b2Jhc2UpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCd1cGRhdGVJdGVtIGNhbGxlZCBiZWZvcmUgQXV0b2Jhc2UgaXMgaW5pdGlhbGl6ZWQnKQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmICghYXV0b2Jhc2Uud3JpdGFibGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCd1cGRhdGVJdGVtIGNhbGxlZCBidXQgYXV0b2Jhc2UgaXMgbm90IHdyaXRhYmxlIHlldCcpCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgcmVxID0gcnBjLnJlcXVlc3QoUlBDX01FU1NBR0UpCiAgICAgICAgICAgIHJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHsgdHlwZTogJ25vdC13cml0YWJsZScsIG1lc3NhZ2U6ICdXYWl0aW5nIHRvIGJlIGFkZGVkIGFzIGEgd3JpdGVyIGJ5IHRoZSBob3N0Li4uJyB9KSkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBzZW5kIG5vdC13cml0YWJsZSBtZXNzYWdlOicsIGUpCiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnNvbGUuZXJyb3IoJ2NvbW1hbmQgUlBDX1VQREFURSB1cGRhdGVJdGVtIGl0ZW0nLCBpdGVtKQoKICAgIGNvbnN0IG9wID0gewogICAgICAgIHR5cGU6ICd1cGRhdGUnLAogICAgICAgIHZhbHVlOiBpdGVtCiAgICB9CgogICAgcmV0dXJuIGVucXVldWVXcml0ZShhc3luYyAoKSA9PiB7CiAgICAgICAgaWYgKCFhdXRvYmFzZSkgcmV0dXJuIGZhbHNlCiAgICAgICAgaWYgKGF1dG9iYXNlLmNsb3NpbmcpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignTXV0YXRpb24gcmVxdWVzdGVkIHdoaWxlIEF1dG9iYXNlIGlzIGNsb3Npbmc7IGlnbm9yaW5nLicpCiAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGhCZWZvcmUgPSBhdXRvYmFzZS5sb2NhbC5sZW5ndGgKCiAgICAgICAgYXdhaXQgYXV0b2Jhc2UuYXBwZW5kKG9wKQoKICAgICAgICAvLyBjb25zdCBwZXJzaXN0ZWQgPSBhd2FpdCBwZXJzaXN0QW5kVmVyaWZ5KGxlbmd0aEJlZm9yZSArIDEsICdVUERBVEUnKQogICAgICAgIC8vIGlmICghcGVyc2lzdGVkKSB7CiAgICAgICAgLy8gICAgIGNvbnNvbGUuZXJyb3IoJ1dBUk5JTkc6IFVwZGF0ZSBvcGVyYXRpb24gbWF5IG5vdCBoYXZlIGJlZW4gcGVyc2lzdGVkIHRvIGRpc2shJykKICAgICAgICAvLyB9CgogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1VwZGF0ZWQgaXRlbTonLCBpdGVtLnRleHQpCiAgICAgICAgcmV0dXJuIHRydWUKICAgIH0pCn0KCi8vIERlbGV0ZSBpdGVtIG9wZXJhdGlvbjogQVVUT05PTU9VUywgTk8gQkFDS0VORCBNRU1PUlkKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUl0ZW0gKGl0ZW0pIHsKICAgIGlmICghYXV0b2Jhc2UpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdkZWxldGVJdGVtIGNhbGxlZCBiZWZvcmUgQXV0b2Jhc2UgaXMgaW5pdGlhbGl6ZWQnKQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmICghYXV0b2Jhc2Uud3JpdGFibGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdkZWxldGVJdGVtIGNhbGxlZCBidXQgYXV0b2Jhc2UgaXMgbm90IHdyaXRhYmxlIHlldCcpCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgcmVxID0gcnBjLnJlcXVlc3QoUlBDX01FU1NBR0UpCiAgICAgICAgICAgIHJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHsgdHlwZTogJ25vdC13cml0YWJsZScsIG1lc3NhZ2U6ICdXYWl0aW5nIHRvIGJlIGFkZGVkIGFzIGEgd3JpdGVyIGJ5IHRoZSBob3N0Li4uJyB9KSkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBzZW5kIG5vdC13cml0YWJsZSBtZXNzYWdlOicsIGUpCiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnNvbGUuZXJyb3IoJ2NvbW1hbmQgUlBDX0RFTEVURSBkZWxldGVJdGVtIGl0ZW0nLCBpdGVtKQoKICAgIGNvbnN0IG9wID0gewogICAgICAgIHR5cGU6ICdkZWxldGUnLAogICAgICAgIHZhbHVlOiBpdGVtCiAgICB9CgogICAgcmV0dXJuIGVucXVldWVXcml0ZShhc3luYyAoKSA9PiB7CiAgICAgICAgaWYgKCFhdXRvYmFzZSkgcmV0dXJuIGZhbHNlCiAgICAgICAgaWYgKGF1dG9iYXNlLmNsb3NpbmcpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignTXV0YXRpb24gcmVxdWVzdGVkIHdoaWxlIEF1dG9iYXNlIGlzIGNsb3Npbmc7IGlnbm9yaW5nLicpCiAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGhCZWZvcmUgPSBhdXRvYmFzZS5sb2NhbC5sZW5ndGgKCiAgICAgICAgYXdhaXQgYXV0b2Jhc2UuYXBwZW5kKG9wKQoKICAgICAgICAvLyBjb25zdCBwZXJzaXN0ZWQgPSBhd2FpdCBwZXJzaXN0QW5kVmVyaWZ5KGxlbmd0aEJlZm9yZSArIDEsICdERUxFVEUnKQogICAgICAgIC8vIGlmICghcGVyc2lzdGVkKSB7CiAgICAgICAgLy8gICAgIGNvbnNvbGUuZXJyb3IoJ1dBUk5JTkc6IERlbGV0ZSBvcGVyYXRpb24gbWF5IG5vdCBoYXZlIGJlZW4gcGVyc2lzdGVkIHRvIGRpc2shJykKICAgICAgICAvLyB9CgogICAgICAgIGNvbnNvbGUuZXJyb3IoJ0RlbGV0ZWQgaXRlbTonLCBpdGVtLnRleHQpCiAgICAgICAgcmV0dXJuIHRydWUKICAgIH0pCn0KCi8vIFNpbXBsZSBpbmxpbmUgc2NoZW1hIHZhbGlkYXRpb24gbWF0Y2hpbmcgdGhlIG1vYmlsZSBMaXN0RW50cnkKZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlSXRlbSAoaXRlbSkgewogICAgaWYgKHR5cGVvZiBpdGVtICE9PSAnb2JqZWN0JyB8fCBpdGVtID09PSBudWxsKSByZXR1cm4gZmFsc2UKICAgIGlmICh0eXBlb2YgaXRlbS50ZXh0ICE9PSAnc3RyaW5nJykgcmV0dXJuIGZhbHNlCiAgICBpZiAodHlwZW9mIGl0ZW0uaXNEb25lICE9PSAnYm9vbGVhbicpIHJldHVybiBmYWxzZQogICAgaWYgKHR5cGVvZiBpdGVtLnRpbWVPZkNvbXBsZXRpb24gIT09ICdudW1iZXInKSByZXR1cm4gZmFsc2UKICAgIHJldHVybiB0cnVlCn0KCi8vIFNlbmQgY3VycmVudCBsaXN0IHRvIGZyb250ZW5kCmV4cG9ydCBmdW5jdGlvbiBzeW5jTGlzdFRvRnJvbnRlbmQgKGN1cnJlbnRMaXN0KSB7CiAgICBpZiAoIXJwYyB8fCAhY3VycmVudExpc3QpIHJldHVybgogICAgdHJ5IHsKICAgICAgICBjb25zdCByZXEgPSBycGMucmVxdWVzdChTWU5DX0xJU1QpCiAgICAgICAgcmVxLnNlbmQoSlNPTi5zdHJpbmdpZnkoY3VycmVudExpc3QpKQogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1N5bmNlZCBsaXN0IHRvIGZyb250ZW5kOicsIGN1cnJlbnRMaXN0Lmxlbmd0aCwgJ2l0ZW1zJykKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gc3luYyBsaXN0IHRvIGZyb250ZW5kOicsIGUpCiAgICB9Cn0KCi8vIFBlcnNpc3QgYW5kIHZlcmlmeSB0aGF0IGFuIG9wZXJhdGlvbiB3YXMgd3JpdHRlbiB0byBkaXNrCi8vIFJldHVybnMgdHJ1ZSBpZiBmbHVzaCBzdWNjZWVkZWQgYW5kIGxlbmd0aCBpcyBjb3JyZWN0LCBmYWxzZSBvdGhlcndpc2UKYXN5bmMgZnVuY3Rpb24gcGVyc2lzdEFuZFZlcmlmeSAoZXhwZWN0ZWRMZW5ndGgsIG9wZXJhdGlvblR5cGUpIHsKICAgIGlmICghYXV0b2Jhc2UgfHwgIWF1dG9iYXNlLmxvY2FsIHx8ICFzdG9yZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYHBlcnNpc3RBbmRWZXJpZnkgKCR7b3BlcmF0aW9uVHlwZX0pOiBhdXRvYmFzZSwgbG9jYWwgY29yZSwgb3Igc3RvcmUgbm90IGF2YWlsYWJsZWApCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgdHJ5IHsKICAgICAgICAvLyBGb3JjZSB3cml0ZSB0byBkaXNrIHZpYSBDb3Jlc3RvcmUgLSB0aGlzIGZsdXNoZXMgYWxsIGNvcmVzIHRvIHN0b3JhZ2UKICAgICAgICAvLyBDb3Jlc3RvcmUuZmx1c2goKSBlbnN1cmVzIGFsbCBwZW5kaW5nIHdyaXRlcyBhcmUgcGVyc2lzdGVkCiAgICAgICAgaWYgKHR5cGVvZiBzdG9yZS5mbHVzaCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBhd2FpdCBzdG9yZS5mbHVzaCgpCiAgICAgICAgfQoKICAgICAgICBjb25zdCBhY3R1YWxMZW5ndGggPSBhdXRvYmFzZS5sb2NhbC5sZW5ndGgKICAgICAgICBjb25zdCBrZXlIZXggPSBhdXRvYmFzZS5sb2NhbC5rZXkudG9TdHJpbmcoJ2hleCcpLnNsaWNlKDAsIDE2KQoKICAgICAgICBpZiAoYWN0dWFsTGVuZ3RoID49IGV4cGVjdGVkTGVuZ3RoKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYHBlcnNpc3RBbmRWZXJpZnkgKCR7b3BlcmF0aW9uVHlwZX0pOiBTVUNDRVNTIC0gZmx1c2hlZCB0byBkaXNrLCBjb3JlICR7a2V5SGV4fS4uLiBsZW5ndGg9JHthY3R1YWxMZW5ndGh9YCkKICAgICAgICAgICAgcmV0dXJuIHRydWUKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBwZXJzaXN0QW5kVmVyaWZ5ICgke29wZXJhdGlvblR5cGV9KTogTEVOR1RIIE1JU01BVENIIC0gY29yZSAke2tleUhleH0uLi4gbGVuZ3RoPSR7YWN0dWFsTGVuZ3RofSwgZXhwZWN0ZWQgPj0gJHtleHBlY3RlZExlbmd0aH1gKQogICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgcGVyc2lzdEFuZFZlcmlmeSAoJHtvcGVyYXRpb25UeXBlfSk6IEZMVVNIIEZBSUxFRCAtYCwgZS5tZXNzYWdlKQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVidWlsZExpc3RGcm9tUGVyc2lzdGVkT3BzKCkgewogICAgYXdhaXQgYXV0b2Jhc2UudXBkYXRlKCkKICAgIGlmICghYXV0b2Jhc2UgfHwgIWF1dG9iYXNlLnZpZXcpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdyZWJ1aWxkTGlzdEZyb21QZXJzaXN0ZWRPcHM6IGF1dG9iYXNlIG9yIHZpZXcgbm90IGF2YWlsYWJsZScpCiAgICAgICAgcmV0dXJuIFtdCiAgICB9CgogICAgY29uc3QgcmVidWlsdExpc3QgPSBbXQogICAgY29uc3QgdmlldyA9IGF1dG9iYXNlLnZpZXcKICAgIGNvbnN0IGxlbmd0aCA9IHZpZXcubGVuZ3RoCgogICAgY29uc29sZS5lcnJvcihgcmVidWlsZExpc3RGcm9tUGVyc2lzdGVkT3BzOiByZWFkaW5nICR7bGVuZ3RofSBlbnRyaWVzIGZyb20gbWVyZ2VkIHZpZXcuLi5gKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBpdGVtID0gYXdhaXQgdmlldy5nZXQoaSkKICAgICAgICAgICAgaWYgKCFpdGVtKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGAgIGVudHJ5ICR7aX06IG51bGwvdW5kZWZpbmVkYCkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpdGVtLnRleHQgIT09IHVuZGVmaW5lZCAmJiB2YWxpZGF0ZUl0ZW0oaXRlbSkpIHsKICAgICAgICAgICAgICAgIHJlYnVpbHRMaXN0LnB1c2goaXRlbSkKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYCAgZW50cnkgJHtpfTogIiR7aXRlbS50ZXh0fSJgKQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgICBlbnRyeSAke2l9OiB1bmtub3duIGZvcm1hdGApCiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYHJlYnVpbGRMaXN0RnJvbVBlcnNpc3RlZE9wczogZXJyb3IgcmVhZGluZyBlbnRyeSAke2l9OmAsIGUubWVzc2FnZSkKICAgICAgICB9CiAgICB9CgogICAgY29uc29sZS5lcnJvcihgcmVidWlsZExpc3RGcm9tUGVyc2lzdGVkT3BzOiByZWJ1aWx0IGxpc3Qgd2l0aCAke3JlYnVpbHRMaXN0Lmxlbmd0aH0gaXRlbXNgKQogICAgcmV0dXJuIHJlYnVpbHRMaXN0Cn0KCgppbXBvcnQgZnMgZnJvbSAnYmFyZS1mcycKCgpleHBvcnQgZnVuY3Rpb24gc2F2ZUF1dG9iYXNlS2V5KGtleSwga2V5RmlsZVBhdGgpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3Qga2V5SGV4ID0ga2V5LnRvU3RyaW5nKCdoZXgnKQogICAgICAgIGZzLndyaXRlRmlsZVN5bmMoa2V5RmlsZVBhdGgsIGtleUhleCkKICAgICAgICBjb25zb2xlLmVycm9yKCdTYXZlZCBhdXRvYmFzZSBrZXkgdG8gZmlsZTonLCBrZXlIZXgpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHNhdmUgYXV0b2Jhc2Uga2V5OicsIGUpCiAgICB9Cn0KCi8vIExvYWQgYXV0b2Jhc2Uga2V5IGZyb20gZmlsZSBpZiBpdCBleGlzdHMKZXhwb3J0IGZ1bmN0aW9uIGxvYWRBdXRvYmFzZUtleShrZXlGaWxlUGF0aCkgewogICAgdHJ5IHsKICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhrZXlGaWxlUGF0aCkpIHsKICAgICAgICAgICAgY29uc3Qga2V5SGV4ID0gZnMucmVhZEZpbGVTeW5jKGtleUZpbGVQYXRoLCAndXRmOCcpLnRyaW0oKQogICAgICAgICAgICBpZiAoa2V5SGV4ICYmIGtleUhleC5sZW5ndGggPT09IDY0KSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdMb2FkZWQgYXV0b2Jhc2Uga2V5IGZyb20gZmlsZTonLCBrZXlIZXgpCiAgICAgICAgICAgICAgICByZXR1cm4gQnVmZmVyLmZyb20oa2V5SGV4LCAnaGV4JykKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9hZCBhdXRvYmFzZSBrZXk6JywgZSkKICAgIH0KICAgIHJldHVybiBudWxsCn0KCi8vIFNhdmUgbG9jYWwgd3JpdGVyIGtleSB0byBmaWxlIGZvciBwZXJzaXN0ZW5jZQpleHBvcnQgZnVuY3Rpb24gc2F2ZUxvY2FsV3JpdGVyS2V5KGtleSwgbG9jYWxXcml0ZXJLZXlGaWxlUGF0aCkgewogICAgdHJ5IHsKICAgICAgICBjb25zdCBrZXlIZXggPSBrZXkudG9TdHJpbmcoJ2hleCcpCiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhsb2NhbFdyaXRlcktleUZpbGVQYXRoLCBrZXlIZXgpCiAgICAgICAgY29uc29sZS5lcnJvcignU2F2ZWQgbG9jYWwgd3JpdGVyIGtleSB0byBmaWxlOicsIGtleUhleCkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gc2F2ZSBsb2NhbCB3cml0ZXIga2V5OicsIGUpCiAgICB9Cn0KCi8vIExvYWQgbG9jYWwgd3JpdGVyIGtleSBmcm9tIGZpbGUgaWYgaXQgZXhpc3RzCmV4cG9ydCBmdW5jdGlvbiBsb2FkTG9jYWxXcml0ZXJLZXkobG9jYWxXcml0ZXJLZXlGaWxlUGF0aCkgewogICAgdHJ5IHsKICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhsb2NhbFdyaXRlcktleUZpbGVQYXRoKSkgewogICAgICAgICAgICBjb25zdCBrZXlIZXggPSBmcy5yZWFkRmlsZVN5bmMobG9jYWxXcml0ZXJLZXlGaWxlUGF0aCwgJ3V0ZjgnKS50cmltKCkKICAgICAgICAgICAgaWYgKGtleUhleCAmJiBrZXlIZXgubGVuZ3RoID09PSA2NCkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignTG9hZGVkIGxvY2FsIHdyaXRlciBrZXkgZnJvbSBmaWxlOicsIGtleUhleCkKICAgICAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShrZXlIZXgsICdoZXgnKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIGxvY2FsIHdyaXRlciBrZXk6JywgZSkKICAgIH0KICAgIHJldHVybiBudWxsCn1pbXBvcnQgSHlwZXJzd2FybSBmcm9tICJoeXBlcnN3YXJtIjsKaW1wb3J0IHthcHBseSwgb3Blbiwgc3RvcmFnZVBhdGgsIHBlZXJLZXlzU3RyaW5nfSBmcm9tICIuLi9iYWNrZW5kLm1qcyI7CmltcG9ydCB7UlBDX01FU1NBR0UsIFJQQ19HRVRfS0VZLCBSUENfUkVTRVQsIFNZTkNfTElTVH0gZnJvbSAiLi4vLi4vcnBjLWNvbW1hbmRzLm1qcyI7CmltcG9ydCBDb3Jlc3RvcmUgZnJvbSAiY29yZXN0b3JlIjsKaW1wb3J0IEF1dG9iYXNlIGZyb20gImF1dG9iYXNlIjsKaW1wb3J0IGI0YSBmcm9tICJiNGEiOwppbXBvcnQgeyByYW5kb21CeXRlcyB9IGZyb20gImh5cGVyY29yZS1jcnlwdG8iOwppbXBvcnQgewogICAgYXV0b2Jhc2UsCiAgICBycGMsCiAgICBhZGRlZFN0YXRpY1BlZXJzLAogICAgY2hhdFN3YXJtLAogICAgc3dhcm0sCiAgICBiYXNlS2V5LAogICAgc3RvcmUsCiAgICBkaXNjb3ZlcnksCiAgICBrbm93bldyaXRlcnMsCiAgICBwZWVyQ291bnQsCiAgICBjdXJyZW50TGlzdCwKICAgIHNldEF1dG9iYXNlLAogICAgc2V0QWRkZWRTdGF0aWNQZWVycywKICAgIHNldENoYXRTd2FybSwKICAgIHNldFN3YXJtLAogICAgc2V0RGlzY292ZXJ5LAogICAgc2V0UGVlckNvdW50LAogICAgc2V0U3RvcmUsCiAgICBzZXRCYXNlS2V5Cn0gZnJvbSAiLi9zdGF0ZS5tanMiCmltcG9ydCB7cmVidWlsZExpc3RGcm9tUGVyc2lzdGVkT3BzLCBzeW5jTGlzdFRvRnJvbnRlbmR9IGZyb20gIi4vaXRlbS5tanMiCgpsZXQgX2luaXRQcm9taXNlID0gbnVsbAoKZXhwb3J0IGZ1bmN0aW9uIHNlbmRIYW5kc2hha2VNZXNzYWdlIChjb25uLCBtc2cpIHsKICAgIGNvbnN0IGxpbmUgPSBKU09OLnN0cmluZ2lmeShtc2cpICsgJ1xuJwogICAgY29ubi53cml0ZShsaW5lKQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlSGFuZHNoYWtlTWVzc2FnZSAobXNnKSB7CiAgICBpZiAoIWF1dG9iYXNlKSByZXR1cm4KICAgIGlmICghbXNnIHx8IG1zZy50eXBlICE9PSAnd3JpdGVyLWtleScpIHJldHVybgoKICAgIGNvbnN0IHJlbW90ZUtleUhleCA9IG1zZy5rZXkKICAgIGlmICghcmVtb3RlS2V5SGV4IHx8IHR5cGVvZiByZW1vdGVLZXlIZXggIT09ICdzdHJpbmcnKSByZXR1cm4KCiAgICBpZiAoa25vd25Xcml0ZXJzLmhhcyhyZW1vdGVLZXlIZXgpKSByZXR1cm4KICAgIGtub3duV3JpdGVycy5hZGQocmVtb3RlS2V5SGV4KQoKICAgIC8vIE9ubHkgYSB3cml0ZXIgY2FuIGFkZCBvdGhlciB3cml0ZXJzLgogICAgaWYgKCFhdXRvYmFzZS53cml0YWJsZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ05vdCB3cml0YWJsZSBoZXJlLCBjYW5ub3QgYWRkIHJlbW90ZSB3cml0ZXIgeWV0JykKICAgICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zb2xlLmVycm9yKCdBZGRpbmcgcmVtb3RlIHdyaXRlciB2aWEgYXV0b2Jhc2U6JywgcmVtb3RlS2V5SGV4KQoKICAgIGF3YWl0IGF1dG9iYXNlLmFwcGVuZCh7CiAgICAgICAgdHlwZTogJ2FkZC13cml0ZXInLAogICAgICAgIGtleTogcmVtb3RlS2V5SGV4CiAgICB9KQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gc2V0dXBIYW5kc2hha2VDaGFubmVsIChjb25uKSB7CiAgICBpZiAoIWF1dG9iYXNlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignc2V0dXBIYW5kc2hha2VDaGFubmVsIGNhbGxlZCBiZWZvcmUgQXV0b2Jhc2UgaXMgaW5pdGlhbGl6ZWQnKQogICAgICAgIHJldHVybgogICAgfQoKICAgIC8vIFNlbmQgb3VyIHdyaXRlciBrZXkgaW1tZWRpYXRlbHkKICAgIGF3YWl0IGF1dG9iYXNlLnJlYWR5KCkKICAgIGNvbnN0IG15V3JpdGVyS2V5SGV4ID0gYXV0b2Jhc2UubG9jYWwua2V5LnRvU3RyaW5nKCdoZXgnKQogICAgc2VuZEhhbmRzaGFrZU1lc3NhZ2UoY29ubiwgewogICAgICAgIHR5cGU6ICd3cml0ZXIta2V5JywKICAgICAgICBrZXk6IG15V3JpdGVyS2V5SGV4CiAgICB9KQoKICAgIGxldCBidWZmZXIgPSAnJwogICAgY29ubi5vbignZGF0YScsIChjaHVuaykgPT4gewogICAgICAgIGJ1ZmZlciArPSBjaHVuay50b1N0cmluZygpCiAgICAgICAgbGV0IGlkeAogICAgICAgIHdoaWxlICgoaWR4ID0gYnVmZmVyLmluZGV4T2YoJ1xuJykpICE9PSAtMSkgewogICAgICAgICAgICBjb25zdCBsaW5lID0gYnVmZmVyLnNsaWNlKDAsIGlkeCkKICAgICAgICAgICAgYnVmZmVyID0gYnVmZmVyLnNsaWNlKGlkeCArIDEpCiAgICAgICAgICAgIGlmICghbGluZS50cmltKCkpIGNvbnRpbnVlCgogICAgICAgICAgICAvLyBGYXN0LXBhdGg6IGh5cGVyY29yZSBwcm90b2NvbCBmcmFtZXMgYW5kIG90aGVyIGJpbmFyeSBnYXJiYWdlCiAgICAgICAgICAgIC8vIGFyZSBub3QgZ29pbmcgdG8gc3RhcnQgd2l0aCAneycsIHNvIGp1c3QgaWdub3JlIHRoZW0uCiAgICAgICAgICAgIGlmIChsaW5lWzBdICE9PSAneycpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBtc2cKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG1zZyA9IEpTT04ucGFyc2UobGluZSkKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdpbnZhbGlkIEpTT04gZnJvbSBwZWVyIChoYW5kc2hha2UsIGlnbm9yZWQpOicsIGxpbmUpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB9CgogICAgICAgICAgICBoYW5kbGVIYW5kc2hha2VNZXNzYWdlKG1zZykKICAgICAgICB9CiAgICB9KQp9CgpleHBvcnQgZnVuY3Rpb24gc2V0dXBDaGF0U3dhcm0gKGNoYXRUb3BpYykgewogICAgaWYgKCFhdXRvYmFzZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ3NldHVwQ2hhdFN3YXJtIGNhbGxlZCBiZWZvcmUgQXV0b2Jhc2UgaXMgaW5pdGlhbGl6ZWQnKQogICAgICAgIHJldHVybgogICAgfQogICAgc2V0Q2hhdFN3YXJtKG5ldyBIeXBlcnN3YXJtKCkpCiAgICBjb25zb2xlLmVycm9yKCdzZXR0aW5nIHVwIGNoYXQgc3dhcm0gd2l0aCB0b3BpYzonLCBjaGF0VG9waWMudG9TdHJpbmcoJ2hleCcpKQogICAgY2hhdFN3YXJtLm9uKCdjb25uZWN0aW9uJywgKGNvbm4sIGluZm8pID0+IHsKICAgICAgICBjb25zb2xlLmVycm9yKCdIYW5kc2hha2UgY29ubmVjdGlvbiAoY2hhdCBzd2FybSkgd2l0aCBwZWVyJywgaW5mbz8ucHVibGljS2V5Py50b1N0cmluZygnaGV4JyksJ3ByaW9yaXRpemVkJywgaW5mbz8ucHJpb3JpdGl6ZWQpCiAgICAgICAgY29ubi5vbignZXJyb3InLCAoZXJyKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0NoYXQgc3dhcm0gY29ubmVjdGlvbiBlcnJvcjonLCBlcnIpCiAgICAgICAgfSkKICAgICAgICBzZXR1cEhhbmRzaGFrZUNoYW5uZWwoY29ubikKICAgIH0pCgogICAgY2hhdFN3YXJtLm9uKCdlcnJvcicsIChlcnIpID0+IHsKICAgICAgICBjb25zb2xlLmVycm9yKCdDaGF0IHN3YXJtIGVycm9yOicsIGVycikKICAgIH0pCgogICAgY2hhdFN3YXJtLmpvaW4oY2hhdFRvcGljLCB7IHNlcnZlcjogdHJ1ZSwgY2xpZW50OiB0cnVlIH0pCiAgICBjb25zb2xlLmVycm9yKCdIYW5kc2hha2UgY2hhdCBzd2FybSBqb2luZWQgb24gdG9waWM6JywgY2hhdFRvcGljLnRvU3RyaW5nKCdoZXgnKSkKfQoKCmFzeW5jIGZ1bmN0aW9uIHRlYXJEb3duQXV0b2Jhc2VTd2FybVN0b3JlKCkgewogICAgLy8gMS4gQ2xlYW4gdXAgcHJldmlvdXMgQXV0b2Jhc2UgaW5zdGFuY2UgKGlmIGFueSkKICAgIGlmIChhdXRvYmFzZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF1dG9iYXNlLnJlbW92ZUFsbExpc3RlbmVycygnYXBwZW5kJykKICAgICAgICAgICAgaWYgKHR5cGVvZiBhdXRvYmFzZS5jbG9zZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignQ2xvc2luZyBwcmV2aW91cyBBdXRvYmFzZSBpbnN0YW5jZS4uLicpCiAgICAgICAgICAgICAgICBhd2FpdCBhdXRvYmFzZS5jbG9zZSgpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdQcmV2aW91cyBBdXRvYmFzZSBoYXMgbm8gY2xvc2UoKSBtZXRob2QsIHNraXBwaW5nIGNsb3NlJykKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3Igd2hpbGUgY2xvc2luZyBwcmV2aW91cyBBdXRvYmFzZTonLCBlKQogICAgICAgIH0KICAgICAgICBzZXRBdXRvYmFzZShudWxsKQogICAgfQoKICAgIC8vIDIuIFRlYXIgZG93biBuZXR3b3JraW5nIGJvdW5kIHRvIG9sZCBzdG9yZQogICAgaWYgKGRpc2NvdmVyeSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IGRpc2NvdmVyeS5kZXN0cm95KCkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSkKICAgICAgICB9CiAgICAgICAgc2V0RGlzY292ZXJ5KG51bGwpCiAgICB9CiAgICBpZiAoY2hhdFN3YXJtKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgY2hhdFN3YXJtLmRlc3Ryb3koKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKQogICAgICAgIH0KICAgICAgICBzZXRDaGF0U3dhcm0obnVsbCkKICAgIH0KCiAgICAvLyAzLiBDbG9zZSBvbGQgc3RvcmUKICAgIGlmIChzdG9yZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IHN0b3JlLmNsb3NlKCkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGNsb3NpbmcgQ29yZXN0b3JlOicsIGUpCiAgICAgICAgfQogICAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gaW5pdEF1dG9iYXNlIChuZXdCYXNlS2V5KSB7CiAgICBpZiAoX2luaXRQcm9taXNlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignaW5pdEF1dG9iYXNlIGFscmVhZHkgcnVubmluZyDigJQgcmV0dXJuaW5nIGV4aXN0aW5nIGluaXQgcHJvbWlzZScpCiAgICAgICAgcmV0dXJuIF9pbml0UHJvbWlzZQogICAgfQoKICAgIF9pbml0UHJvbWlzZSA9IChhc3luYyAoKSA9PiB7CgoKICAgICAgICBhd2FpdCB0ZWFyRG93bkF1dG9iYXNlU3dhcm1TdG9yZSgpOwoKICAgICAgICAvLyBVc2UgcGVyLWJhc2Ugc3RvcmFnZSBwYXRoIHRvIGF2b2lkIGNvbmZsaWN0cyB3aGVuIGpvaW5pbmcgZGlmZmVyZW50IGJhc2VzCiAgICAgICAgY29uc3Qga2V5UHJlZml4ID0gbmV3QmFzZUtleSA/IG5ld0Jhc2VLZXkudG9TdHJpbmcoJ2hleCcpLnNsaWNlKDAsIDgpIDogJ2xvY2FsJwogICAgICAgIGNvbnN0IGJhc2VTdG9yYWdlUGF0aCA9IGAke3N0b3JhZ2VQYXRofS0ke2tleVByZWZpeH1gCgogICAgICAgIHNldFN0b3JlKG5ldyBDb3Jlc3RvcmUoYmFzZVN0b3JhZ2VQYXRoKSkKICAgICAgICBhd2FpdCBzdG9yZS5yZWFkeSgpCiAgICAgICAgc2V0QmFzZUtleShuZXdCYXNlS2V5IHx8IG51bGwpCiAgICAgICAgY29uc29sZS5lcnJvcigKICAgICAgICAgICAgJ2luaXRpYWxpemluZyBhIG5ldyBhdXRvYmFzZSB3aXRoIGtleTonLAogICAgICAgICAgICBiYXNlS2V5ID8gYmFzZUtleS50b1N0cmluZygnaGV4JykgOiAnKG5ldyBiYXNlKScKICAgICAgICApCiAgICAgICAgY29uc3QgYXV0b2Jhc2VPcHRzID0geyBhcHBseSwgb3BlbiwgdmFsdWVFbmNvZGluZzogJ2pzb24nIH0KICAgICAgICBzZXRBdXRvYmFzZShuZXcgQXV0b2Jhc2Uoc3RvcmUsIGJhc2VLZXksIGF1dG9iYXNlT3B0cykpCiAgICAgICAgY29uc29sZS5lcnJvcignQ2FsbGluZyBhdXRvYmFzZS5yZWFkeSgpLi4uJykKICAgICAgICBhd2FpdCBhdXRvYmFzZS5yZWFkeSgpCiAgICAgICAgY29uc29sZS5lcnJvcigKICAgICAgICAgICAgJ2F1dG9iYXNlLnJlYWR5KCkgcmVzb2x2ZWQuIEF1dG9iYXNlIHJlYWR5LCB3cml0YWJsZT8nLAogICAgICAgICAgICBhdXRvYmFzZS53cml0YWJsZSwKICAgICAgICAgICAgJyBrZXk6JywKICAgICAgICAgICAgYXV0b2Jhc2Uua2V5Py50b1N0cmluZygnaGV4JyksCiAgICAgICAgKQogICAgICAgIGlmIChhdXRvYmFzZSkgewogICAgICAgICAgICBjb25zdCByZXEgPSBycGMucmVxdWVzdChSUENfR0VUX0tFWSkKICAgICAgICAgICAgcmVxLnNlbmQoYXV0b2Jhc2Uua2V5Py50b1N0cmluZygnaGV4JykpCiAgICAgICAgfQogICAgICAgIGF1dG9iYXNlLm9uKCdhcHBlbmQnLCBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ05ldyBkYXRhIGFwcGVuZGVkLCB1cGRhdGluZyB2aWV3Li4uJykKICAgICAgICB9KQogICAgICAgIC8vIExvYWQgZXhpc3RpbmcgaXRlbXMgZnJvbSB2aWV3IGFuZCBzeW5jIHRvIGZyb250ZW5kCiAgICAgICAgYXdhaXQgYXV0b2Jhc2UudXBkYXRlKCkKICAgICAgICBjb25zdCByZWJ1aWx0TGlzdCA9IGF3YWl0IHJlYnVpbGRMaXN0RnJvbVBlcnNpc3RlZE9wcygpCiAgICAgICAgc3luY0xpc3RUb0Zyb250ZW5kKHJlYnVpbHRMaXN0KQogICAgICAgIC8vIEFkZCBzdGF0aWMgcGVlcnMgb25seSBvbmNlCiAgICAgICAgaWYgKCFhZGRlZFN0YXRpY1BlZXJzICYmIHBlZXJLZXlzU3RyaW5nKSB7CiAgICAgICAgICAgIGNvbnN0IHBlZXJLZXlzID0gcGVlcktleXNTdHJpbmcuc3BsaXQoJywnKS5maWx0ZXIoayA9PiBrLnRyaW0oKSkKICAgICAgICAgICAgZm9yIChjb25zdCBrZXlIZXggb2YgcGVlcktleXMpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVlcktleSA9IEJ1ZmZlci5mcm9tKGtleUhleC50cmltKCksICdoZXgnKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBlZXJDb3JlID0gc3RvcmUuZ2V0KHsga2V5OiBwZWVyS2V5IH0pCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgcGVlckNvcmUucmVhZHkoKQogICAgICAgICAgICAgICAgICAgIGF3YWl0IGF1dG9iYXNlLmFkZElucHV0KHBlZXJDb3JlKQogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0FkZGVkIHBlZXIgd3JpdGVyIGZyb20gYXJndlsxXTonLCBrZXlIZXgudHJpbSgpKQogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGFkZCBwZWVyIGZyb20gYXJndlsxXTonLCBrZXlIZXgsIGVyci5tZXNzYWdlKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldEFkZGVkU3RhdGljUGVlcnModHJ1ZSkKICAgICAgICB9CiAgICAgICAgLy8gUmVzZXQgcGVlciBjb3VudCBvbiBuZXcgYmFzZQogICAgICAgIHNldFBlZXJDb3VudCgwKQogICAgICAgIGJyb2FkY2FzdFBlZXJDb3VudCgpCiAgICAgICAgLy8gLS0tIFVwZGF0ZSByZXBsaWNhdGlvbiBzd2FybSB0b3BpYyBmb3IgdGhpcyBiYXNlIC0tLQogICAgICAgIGNvbnN0IGZpcnN0TG9jYWxBdXRvYmFzZUtleSA9IHJhbmRvbUJ5dGVzKDMyKQogICAgICAgIGNvbnN0IHRvcGljID0gYXV0b2Jhc2Uua2V5IHx8IGZpcnN0TG9jYWxBdXRvYmFzZUtleQogICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Rpc2NvdmVyeSB0b3BpYyAocmVwbGljYXRpb24gc3dhcm0pOicsIHRvcGljLnRvU3RyaW5nKCdoZXgnKSkKICAgICAgICAvLyBTd2l0Y2ggZGlzY292ZXJ5IHRvIG5ldyB0b3BpYwogICAgICAgIGlmIChkaXNjb3ZlcnkpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGF3YWl0IGRpc2NvdmVyeS5kZXN0cm95KCkKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZGVzdHJveWluZyBwcmV2aW91cyBkaXNjb3Zlcnk6JywgZSkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRTd2FybShuZXcgSHlwZXJzd2FybSgpKQogICAgICAgIHN3YXJtLm9uKCdlcnJvcicsIChlcnIpID0+IHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignUmVwbGljYXRpb24gc3dhcm0gZXJyb3I6JywgZXJyKQogICAgICAgIH0pCiAgICAgICAgc3dhcm0ub24oJ2Nvbm5lY3Rpb24nLCAoY29ubikgPT4gewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdOZXcgcGVlciBjb25uZWN0ZWQgKHJlcGxpY2F0aW9uIHN3YXJtKScsIGI0YS5mcm9tKGNvbm4ucHVibGljS2V5KS50b1N0cmluZygnaGV4JykpCiAgICAgICAgICAgIGNvbm4ub24oJ2Vycm9yJywgKGVycikgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignUmVwbGljYXRpb24gY29ubmVjdGlvbiBlcnJvcjonLCBlcnIpCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIHNldFBlZXJDb3VudChwZWVyQ291bnQrMSkKICAgICAgICAgICAgYnJvYWRjYXN0UGVlckNvdW50KCkKICAgICAgICAgICAgY29ubi5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRQZWVyQ291bnQoTWF0aC5tYXgoMCwgcGVlckNvdW50IC0gMSkpCiAgICAgICAgICAgICAgICBicm9hZGNhc3RQZWVyQ291bnQoKQogICAgICAgICAgICB9KQogICAgICAgICAgICBpZiAoYXV0b2Jhc2UpIHsKICAgICAgICAgICAgICAgIGF1dG9iYXNlLnJlcGxpY2F0ZShjb25uKQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignTm8gQXV0b2Jhc2UgeWV0IHRvIHJlcGxpY2F0ZSB3aXRoJykKICAgICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgc2V0RGlzY292ZXJ5KHN3YXJtLmpvaW4odG9waWMsIHsgc2VydmVyOiB0cnVlLCBjbGllbnQ6IHRydWUgfSkpCiAgICAgICAgYXdhaXQgZGlzY292ZXJ5LmZsdXNoZWQoKQogICAgICAgIGNvbnNvbGUuZXJyb3IoJ0pvaW5lZCByZXBsaWNhdGlvbiBzd2FybSBmb3IgY3VycmVudCBiYXNlJykKICAgICAgICAvLyBSZXN0YXJ0IGNoYXQgc3dhcm0gd2l0aCBuZXcgdG9waWMKICAgICAgICBpZiAoY2hhdFN3YXJtKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBhd2FpdCBjaGF0U3dhcm0uZGVzdHJveSgpCiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGRlc3Ryb3lpbmcgcHJldmlvdXMgY2hhdCBzd2FybTonLCBlKQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldENoYXRTd2FybShudWxsKQogICAgICAgIH0KICAgICAgICBzZXR1cENoYXRTd2FybShiYXNlS2V5ICE9IG51bGwgPyBiYXNlS2V5IDogYXV0b2Jhc2Uua2V5KQogICAgfSkoKQoKICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IF9pbml0UHJvbWlzZQogICAgfSBmaW5hbGx5IHsKICAgICAgICBfaW5pdFByb21pc2UgPSBudWxsCiAgICB9Cn0KCmxldCBfam9pblByb21pc2UgPSBudWxsCgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gam9pbk5ld0Jhc2UgKGJhc2VLZXlIZXhTdHIpIHsKCiAgICBpZiAoX2pvaW5Qcm9taXNlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignaW5pdEF1dG9iYXNlIGFscmVhZHkgcnVubmluZyDigJQgcmV0dXJuaW5nIGV4aXN0aW5nIGluaXQgcHJvbWlzZScpCiAgICAgICAgcmV0dXJuIF9qb2luUHJvbWlzZQogICAgfQoKICAgIF9qb2luUHJvbWlzZSA9IChhc3luYyAoKSA9PiB7CgogICAgICAgIGlmICghYmFzZUtleUhleFN0ciB8fCB0eXBlb2YgYmFzZUtleUhleFN0ciAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignam9pbk5ld0Jhc2U6IGludmFsaWQgYmFzZUtleScsIGJhc2VLZXlIZXhTdHIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgLy8gU2F2ZSBjdXJyZW50IGxpc3QgdG8gcmVzdG9yZSBvbiBmYWlsdXJlCiAgICAgICAgY29uc3QgcHJldmlvdXNMaXN0ID0gWy4uLmN1cnJlbnRMaXN0XQoKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBuZXdLZXkgPSBCdWZmZXIuZnJvbShiYXNlS2V5SGV4U3RyLnRyaW0oKSwgJ2hleCcpCiAgICAgICAgICAgIGlmIChuZXdLZXkubGVuZ3RoICE9PSAzMikgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignam9pbk5ld0Jhc2U6IGJhc2VLZXkgbXVzdCBiZSAzMiBieXRlcywgZ290JywgbmV3S2V5Lmxlbmd0aCkKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0pvaW5pbmcgbmV3IEF1dG9iYXNlIGtleSBhdCBydW50aW1lOicsIGJhc2VLZXlIZXhTdHIudHJpbSgpKQogICAgICAgICAgICAvLyBDbGVhciBmcm9udGVuZCBsaXN0IGJlZm9yZSBqb2luaW5nIG5ldyBiYXNlCiAgICAgICAgICAgIGlmIChycGMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlc2V0UmVxID0gcnBjLnJlcXVlc3QoUlBDX1JFU0VUKQogICAgICAgICAgICAgICAgcmVzZXRSZXEuc2VuZCgnJykKICAgICAgICAgICAgfQogICAgICAgICAgICBhd2FpdCBpbml0QXV0b2Jhc2UobmV3S2V5KQogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdBdXRvYmFzZSByZWFkeSAzMjAnKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignam9pbk5ld0Jhc2UgZmFpbGVkOicsIGUpCiAgICAgICAgICAgIC8vIFJlc3RvcmUgcHJldmlvdXMgbGlzdCBvbiBmYWlsdXJlCiAgICAgICAgICAgIGlmIChycGMgJiYgcHJldmlvdXNMaXN0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHN5bmNSZXEgPSBycGMucmVxdWVzdChTWU5DX0xJU1QpCiAgICAgICAgICAgICAgICBzeW5jUmVxLnNlbmQoSlNPTi5zdHJpbmdpZnkocHJldmlvdXNMaXN0KSkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pKCkKCiAgICB0cnkgewogICAgICAgIHJldHVybiBhd2FpdCBfam9pblByb21pc2UKICAgIH0gZmluYWxseSB7CiAgICAgICAgX2pvaW5Qcm9taXNlID0gbnVsbAogICAgfQoKfQoKZnVuY3Rpb24gYnJvYWRjYXN0UGVlckNvdW50ICgpIHsKICAgIGlmICghcnBjKSByZXR1cm4KICAgIHRyeSB7CiAgICAgICAgY29uc3QgcmVxID0gcnBjLnJlcXVlc3QoUlBDX01FU1NBR0UpCiAgICAgICAgcmVxLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyB0eXBlOiAncGVlci1jb3VudCcsIGNvdW50OiBwZWVyQ291bnQgfSkpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGJyb2FkY2FzdCBwZWVyIGNvdW50JywgZSkKICAgIH0KfS8vIFNoYXJlZCBtdXRhYmxlIHN0YXRlIGV4cG9ydHMKLy8gQWxsIG1vZHVsZXMgaW1wb3J0IGZyb20gaGVyZSBhbmQgdXNlIHNldHRlcnMgdG8gbW9kaWZ5IHN0YXRlCgovLyBDb3JlIFAyUCBpbnN0YW5jZXMKZXhwb3J0IGxldCBhdXRvYmFzZSA9IG51bGwKZXhwb3J0IGxldCBzdG9yZSA9IG51bGwKZXhwb3J0IGxldCBzd2FybSA9IG51bGwKZXhwb3J0IGxldCBjaGF0U3dhcm0gPSBudWxsCmV4cG9ydCBsZXQgZGlzY292ZXJ5ID0gbnVsbAoKLy8gUlBDIGluc3RhbmNlCmV4cG9ydCBsZXQgcnBjID0gbnVsbAoKLy8gS2V5cyBhbmQgdG9waWNzCmV4cG9ydCBsZXQgYmFzZUtleSA9IG51bGwKZXhwb3J0IGxldCBjdXJyZW50VG9waWMgPSBudWxsCmV4cG9ydCBsZXQgY2hhdFRvcGljID0gbnVsbAoKLy8gSW4tbWVtb3J5IGRhdGEKZXhwb3J0IGxldCBjdXJyZW50TGlzdCA9IFtdCmV4cG9ydCBsZXQgcGVlckNvdW50ID0gMAoKLy8gV3JpdGVyIHRyYWNraW5nCmV4cG9ydCBjb25zdCBrbm93bldyaXRlcnMgPSBuZXcgU2V0KCkKZXhwb3J0IGxldCBhZGRlZFN0YXRpY1BlZXJzID0gZmFsc2UKCi8vIFN0YXRlIGZsYWdzCmV4cG9ydCBsZXQgaXNSZXNldHRpbmdTdGF0ZSA9IGZhbHNlCgovLyBUcmFuc2llbnQgZXJyb3IgdHJhY2tpbmcKZXhwb3J0IGxldCB0cmFuc2llbnRFcnJvckNvdW50ID0gMApleHBvcnQgbGV0IGxhc3RUcmFuc2llbnRFcnJvclRpbWUgPSAwCmV4cG9ydCBjb25zdCBNQVhfVFJBTlNJRU5UX0VSUk9SUyA9IDEwCmV4cG9ydCBjb25zdCBERUZBVUxUX0xJU1QgPSBbCiAgICB7IHRleHQ6ICdUYXAgdG8gbWFyayBhcyBkb25lJywgaXNEb25lOiBmYWxzZSwgdGltZU9mQ29tcGxldGlvbjogMCB9LAogICAgeyB0ZXh0OiAnRG91YmxlIHRhcCB0byBhZGQgbmV3JywgaXNEb25lOiBmYWxzZSwgdGltZU9mQ29tcGxldGlvbjogMCB9LAogICAgeyB0ZXh0OiAnU2xpZGUgcmlnaHQgc2xvd2x5IHRvIGRlbGV0ZScsIGlzRG9uZTogZmFsc2UsIHRpbWVPZkNvbXBsZXRpb246IDAgfSwKXQoKCi8vIFNldHRlcnMgZm9yIG11dGFibGUgc3RhdGUKZXhwb3J0IGZ1bmN0aW9uIHNldEF1dG9iYXNlKHZhbCkgeyBhdXRvYmFzZSA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRTdG9yZSh2YWwpIHsgc3RvcmUgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0U3dhcm0odmFsKSB7IHN3YXJtID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldENoYXRTd2FybSh2YWwpIHsgY2hhdFN3YXJtID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldERpc2NvdmVyeSh2YWwpIHsgZGlzY292ZXJ5ID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldFJwYyh2YWwpIHsgcnBjID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldEJhc2VLZXkodmFsKSB7IGJhc2VLZXkgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0Q3VycmVudFRvcGljKHZhbCkgeyBjdXJyZW50VG9waWMgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0Q2hhdFRvcGljKHZhbCkgeyBjaGF0VG9waWMgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0Q3VycmVudExpc3QodmFsKSB7IGN1cnJlbnRMaXN0ID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldFBlZXJDb3VudCh2YWwpIHsgcGVlckNvdW50ID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldEFkZGVkU3RhdGljUGVlcnModmFsKSB7IGFkZGVkU3RhdGljUGVlcnMgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0SXNSZXNldHRpbmdTdGF0ZSh2YWwpIHsgaXNSZXNldHRpbmdTdGF0ZSA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRUcmFuc2llbnRFcnJvckNvdW50KHZhbCkgeyB0cmFuc2llbnRFcnJvckNvdW50ID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldExhc3RUcmFuc2llbnRFcnJvclRpbWUodmFsKSB7IGxhc3RUcmFuc2llbnRFcnJvclRpbWUgPSB2YWwgfQoKLy8gSGVscGVyIHRvIGNsZWFyIGtub3duIHdyaXRlcnMKZXhwb3J0IGZ1bmN0aW9uIGNsZWFyS25vd25Xcml0ZXJzKCkgeyBrbm93bldyaXRlcnMuY2xlYXIoKSB9Ci8vIEdlbmVyYXRlIHVuaXF1ZSBJRCAodXNlZCBvbmx5IGZvciBhZGRJdGVtKQppbXBvcnQge3JhbmRvbUJ5dGVzfSBmcm9tICJiYXJlLWNyeXB0byI7CgpleHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVJZCAoKSB7CiAgICByZXR1cm4gcmFuZG9tQnl0ZXMoMTYpLnRvU3RyaW5nKCdoZXgnKQp9Y29uc3QgeyBQdWxsLCBQdXNoLCBIRUFERVJCWVRFUywgS0VZQllURVMsIEFCWVRFUyB9ID0gcmVxdWlyZSgnc29kaXVtLXNlY3JldHN0cmVhbScpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgeyBEdXBsZXgsIFdyaXRhYmxlLCBnZXRTdHJlYW1FcnJvciB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IFRpbWVvdXQgPSByZXF1aXJlKCd0aW1lb3V0LXJlZnJlc2gnKQpjb25zdCB1bnNsYWIgPSByZXF1aXJlKCd1bnNsYWInKQpjb25zdCBCcmlkZ2UgPSByZXF1aXJlKCcuL2xpYi9icmlkZ2UnKQpjb25zdCBIYW5kc2hha2UgPSByZXF1aXJlKCcuL2xpYi9oYW5kc2hha2UnKQoKY29uc3QgSURIRUFERVJCWVRFUyA9IEhFQURFUkJZVEVTICsgMzIKY29uc3QgW05TX0lOSVRJQVRPUiwgTlNfUkVTUE9OREVSLCBOU19TRU5EXSA9IGNyeXB0by5uYW1lc3BhY2UoJ2h5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbScsIDMpCmNvbnN0IE1BWF9BVE9NSUNfV1JJVEUgPSAyNTYgKiAyNTYgKiAyNTYgLSAxCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIE5vaXNlU2VjcmV0U3RyZWFtIGV4dGVuZHMgRHVwbGV4IHsKICBjb25zdHJ1Y3Rvcihpc0luaXRpYXRvciwgcmF3U3RyZWFtLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKHsgbWFwV3JpdGFibGU6IHRvQnVmZmVyIH0pCgogICAgaWYgKHR5cGVvZiBpc0luaXRpYXRvciAhPT0gJ2Jvb2xlYW4nKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignaXNJbml0aWF0b3Igc2hvdWxkIGJlIGEgYm9vbGVhbicpCiAgICB9CgogICAgdGhpcy5ub2lzZVN0cmVhbSA9IHRoaXMKICAgIHRoaXMuaXNJbml0aWF0b3IgPSBpc0luaXRpYXRvcgogICAgdGhpcy5yYXdTdHJlYW0gPSBudWxsCgogICAgdGhpcy5wdWJsaWNLZXkgPSBvcHRzLnB1YmxpY0tleSB8fCBudWxsCiAgICB0aGlzLnJlbW90ZVB1YmxpY0tleSA9IG9wdHMucmVtb3RlUHVibGljS2V5IHx8IG51bGwKICAgIHRoaXMuaGFuZHNoYWtlSGFzaCA9IG51bGwKICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2UKICAgIHRoaXMua2VlcEFsaXZlID0gb3B0cy5rZWVwQWxpdmUgfHwgMAogICAgdGhpcy50aW1lb3V0ID0gMAogICAgdGhpcy5lbmFibGVTZW5kID0gb3B0cy5lbmFibGVTZW5kICE9PSBmYWxzZQoKICAgIC8vIHBvaW50ZXIgZm9yIHVwc3RyZWFtIHRvIHNldCBkYXRhIGhlcmUgaWYgdGhleSB3YW50CiAgICB0aGlzLnVzZXJEYXRhID0gbnVsbAoKICAgIGxldCBvcGVuZWREb25lID0gbnVsbAogICAgdGhpcy5vcGVuZWQgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICBvcGVuZWREb25lID0gcmVzb2x2ZQogICAgfSkKCiAgICB0aGlzLnJhd0J5dGVzV3JpdHRlbiA9IDAKICAgIHRoaXMucmF3Qnl0ZXNSZWFkID0gMAoKICAgIC8vIG1ldGFkYXRhIHVzZWQgYnkgJ2h5cGVyZGh0JwogICAgdGhpcy5yZWxheSA9IG51bGwKICAgIHRoaXMucHVuY2hlciA9IG51bGwKCiAgICAvLyB1bndyYXBwZWQgcmF3IHN0cmVhbQogICAgdGhpcy5fcmF3U3RyZWFtID0gbnVsbAoKICAgIC8vIGhhbmRzaGFrZSBzdGF0ZQogICAgdGhpcy5faGFuZHNoYWtlID0gbnVsbAogICAgdGhpcy5faGFuZHNoYWtlUGF0dGVybiA9IG9wdHMucGF0dGVybiB8fCBudWxsCiAgICB0aGlzLl9oYW5kc2hha2VEb25lID0gbnVsbAoKICAgIC8vIG1lc3NhZ2UgcGFyc2luZyBzdGF0ZQogICAgdGhpcy5fc3RhdGUgPSAwCiAgICB0aGlzLl9sZW4gPSAwCiAgICB0aGlzLl90bXAgPSAxCiAgICB0aGlzLl9tZXNzYWdlID0gbnVsbAoKICAgIHRoaXMuX29wZW5lZERvbmUgPSBvcGVuZWREb25lCiAgICB0aGlzLl9zdGFydERvbmUgPSBudWxsCiAgICB0aGlzLl9kcmFpbkRvbmUgPSBudWxsCiAgICB0aGlzLl9vdXRnb2luZ1BsYWluID0gbnVsbAogICAgdGhpcy5fb3V0Z29pbmdXcmFwcGVkID0gbnVsbAogICAgdGhpcy5fdXRwID0gbnVsbAogICAgdGhpcy5fc2V0dXAgPSB0cnVlCiAgICB0aGlzLl9lbmRlZCA9IDIKICAgIHRoaXMuX2VuY3J5cHQgPSBudWxsCiAgICB0aGlzLl9kZWNyeXB0ID0gbnVsbAogICAgdGhpcy5fdGltZW91dFRpbWVyID0gbnVsbAogICAgdGhpcy5fa2VlcEFsaXZlVGltZXIgPSBudWxsCiAgICB0aGlzLl9zZW5kU3RhdGUgPSBudWxsCgogICAgaWYgKG9wdHMuYXV0b1N0YXJ0ICE9PSBmYWxzZSkgdGhpcy5zdGFydChyYXdTdHJlYW0sIG9wdHMpCgogICAgLy8gd2lnZ2xlIGl0IHRvIHRyaWdnZXIgb3BlbiBpbW1lZGlhdGVseSAoVE9ETyBhZGQgc3RyZWFteCBvcHRpb24gZm9yIHRoaXMpCiAgICB0aGlzLnJlc3VtZSgpCiAgICB0aGlzLnBhdXNlKCkKICB9CgogIHN0YXRpYyBrZXlQYWlyKHNlZWQpIHsKICAgIHJldHVybiBIYW5kc2hha2Uua2V5UGFpcihzZWVkKQogIH0KCiAgc3RhdGljIGlkKGhhbmRzaGFrZUhhc2gsIGlzSW5pdGlhdG9yLCBpZCkgewogICAgcmV0dXJuIHN0cmVhbUlkKGhhbmRzaGFrZUhhc2gsIGlzSW5pdGlhdG9yLCBpZCkKICB9CgogIHNldFRpbWVvdXQobXMpIHsKICAgIGlmICghbXMpIG1zID0gMAoKICAgIHRoaXMuX2NsZWFyVGltZW91dCgpCiAgICB0aGlzLnRpbWVvdXQgPSBtcwoKICAgIGlmICghbXMgfHwgdGhpcy5yYXdTdHJlYW0gPT09IG51bGwpIHJldHVybgoKICAgIHRoaXMuX3RpbWVvdXRUaW1lciA9IFRpbWVvdXQub25jZShtcywgZGVzdHJveVRpbWVvdXQsIHRoaXMpCiAgICB0aGlzLl90aW1lb3V0VGltZXIudW5yZWYoKQogIH0KCiAgc2V0S2VlcEFsaXZlKG1zKSB7CiAgICBpZiAoIW1zKSBtcyA9IDAKCiAgICB0aGlzLl9jbGVhcktlZXBBbGl2ZSgpCgogICAgdGhpcy5rZWVwQWxpdmUgPSBtcwoKICAgIGlmICghbXMgfHwgdGhpcy5yYXdTdHJlYW0gPT09IG51bGwpIHJldHVybgoKICAgIHRoaXMuX2tlZXBBbGl2ZVRpbWVyID0gVGltZW91dC5vbihtcywgc2VuZEtlZXBBbGl2ZSwgdGhpcykKICAgIHRoaXMuX2tlZXBBbGl2ZVRpbWVyLnVucmVmKCkKICB9CgogIHNlbmRLZWVwQWxpdmUoKSB7CiAgICBjb25zdCBlbXB0eSA9IHRoaXMuYWxsb2MoMCkKICAgIHRoaXMud3JpdGUoZW1wdHkpCiAgfQoKICBzdGFydChyYXdTdHJlYW0sIG9wdHMgPSB7fSkgewogICAgaWYgKHJhd1N0cmVhbSkgewogICAgICB0aGlzLnJhd1N0cmVhbSA9IHJhd1N0cmVhbQogICAgICB0aGlzLl9yYXdTdHJlYW0gPSByYXdTdHJlYW0KICAgICAgaWYgKHR5cGVvZiB0aGlzLnJhd1N0cmVhbS5zZXRDb250ZW50U2l6ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRoaXMuX3V0cCA9IHJhd1N0cmVhbQogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aGlzLnJhd1N0cmVhbSA9IG5ldyBCcmlkZ2UodGhpcykKICAgICAgdGhpcy5fcmF3U3RyZWFtID0gdGhpcy5yYXdTdHJlYW0ucmV2ZXJzZQogICAgfQoKICAgIHRoaXMucmF3U3RyZWFtLm9uKCdlcnJvcicsIHRoaXMuX29ucmF3ZXJyb3IuYmluZCh0aGlzKSkKICAgIHRoaXMucmF3U3RyZWFtLm9uKCdjbG9zZScsIHRoaXMuX29ucmF3Y2xvc2UuYmluZCh0aGlzKSkKCiAgICB0aGlzLl9zdGFydEhhbmRzaGFrZShvcHRzLmhhbmRzaGFrZSwgb3B0cy5rZXlQYWlyIHx8IG51bGwpCiAgICB0aGlzLl9jb250aW51ZU9wZW4obnVsbCkKCiAgICBpZiAodGhpcy5kZXN0cm95aW5nKSByZXR1cm4KCiAgICBpZiAob3B0cy5kYXRhKSB0aGlzLl9vbnJhd2RhdGEob3B0cy5kYXRhKQogICAgaWYgKG9wdHMuZW5kZWQpIHRoaXMuX29ucmF3ZW5kKCkKCiAgICBpZiAodGhpcy5rZWVwQWxpdmUgPiAwICYmIHRoaXMuX2tlZXBBbGl2ZVRpbWVyID09PSBudWxsKSB7CiAgICAgIHRoaXMuc2V0S2VlcEFsaXZlKHRoaXMua2VlcEFsaXZlKQogICAgfQoKICAgIGlmICh0aGlzLnRpbWVvdXQgPiAwICYmIHRoaXMuX3RpbWVvdXRUaW1lciA9PT0gbnVsbCkgewogICAgICB0aGlzLnNldFRpbWVvdXQodGhpcy50aW1lb3V0KQogICAgfQogIH0KCiAgYXN5bmMgZmx1c2goKSB7CiAgICBpZiAoKGF3YWl0IHRoaXMub3BlbmVkKSA9PT0gZmFsc2UpIHJldHVybiBmYWxzZQogICAgaWYgKChhd2FpdCBXcml0YWJsZS5kcmFpbmVkKHRoaXMpKSA9PT0gZmFsc2UpIHJldHVybiBmYWxzZQogICAgaWYgKHRoaXMuZGVzdHJveWluZykgcmV0dXJuIGZhbHNlCgogICAgaWYgKHRoaXMucmF3U3RyZWFtICE9PSBudWxsICYmIHRoaXMucmF3U3RyZWFtLmZsdXNoKSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnJhd1N0cmVhbS5mbHVzaCgpCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIF9jb250aW51ZU9wZW4oZXJyKSB7CiAgICBpZiAoZXJyKSB0aGlzLmRlc3Ryb3koZXJyKQogICAgaWYgKHRoaXMuX3N0YXJ0RG9uZSA9PT0gbnVsbCkgcmV0dXJuCiAgICBjb25zdCBkb25lID0gdGhpcy5fc3RhcnREb25lCiAgICB0aGlzLl9zdGFydERvbmUgPSBudWxsCiAgICB0aGlzLl9vcGVuKGRvbmUpCiAgfQoKICBfb25rZXlwYWlycHJvbWlzZShwKSB7CiAgICBjb25zdCBzZWxmID0gdGhpcwogICAgY29uc3QgY29udCA9IHRoaXMuX2NvbnRpbnVlT3Blbi5iaW5kKHRoaXMpCgogICAgcC50aGVuKG9ua2V5cGFpciwgY29udCkKCiAgICBmdW5jdGlvbiBvbmtleXBhaXIoa3ApIHsKICAgICAgc2VsZi5fb25rZXlwYWlyKGtwKQogICAgICBjb250KG51bGwpCiAgICB9CiAgfQoKICBfb25rZXlwYWlyKGtleVBhaXIpIHsKICAgIGNvbnN0IHBhdHRlcm4gPSB0aGlzLl9oYW5kc2hha2VQYXR0ZXJuIHx8ICdYWCcKICAgIGNvbnN0IHJlbW90ZVB1YmxpY0tleSA9IHRoaXMucmVtb3RlUHVibGljS2V5CgogICAgdGhpcy5faGFuZHNoYWtlID0gbmV3IEhhbmRzaGFrZSh0aGlzLmlzSW5pdGlhdG9yLCBrZXlQYWlyLCByZW1vdGVQdWJsaWNLZXksIHBhdHRlcm4pCiAgICB0aGlzLnB1YmxpY0tleSA9IHRoaXMuX2hhbmRzaGFrZS5rZXlQYWlyLnB1YmxpY0tleQogIH0KCiAgX3N0YXJ0SGFuZHNoYWtlKGhhbmRzaGFrZSwga2V5UGFpcikgewogICAgaWYgKGhhbmRzaGFrZSkgewogICAgICBjb25zdCB7IHR4LCByeCwgaGFzaCwgcHVibGljS2V5LCByZW1vdGVQdWJsaWNLZXkgfSA9IGhhbmRzaGFrZQogICAgICB0aGlzLl9zZXR1cFNlY3JldFN0cmVhbSh0eCwgcngsIGhhc2gsIHB1YmxpY0tleSwgcmVtb3RlUHVibGljS2V5KQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoIWtleVBhaXIpIGtleVBhaXIgPSBIYW5kc2hha2Uua2V5UGFpcigpCgogICAgaWYgKHR5cGVvZiBrZXlQYWlyLnRoZW4gPT09ICdmdW5jdGlvbicpIHsKICAgICAgdGhpcy5fb25rZXlwYWlycHJvbWlzZShrZXlQYWlyKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fb25rZXlwYWlyKGtleVBhaXIpCiAgICB9CiAgfQoKICBfb25yYXdlcnJvcihlcnIpIHsKICAgIHRoaXMuZGVzdHJveShlcnIpCiAgfQoKICBfb25yYXdjbG9zZSgpIHsKICAgIGlmICh0aGlzLl9lbmRlZCAhPT0gMCkgdGhpcy5kZXN0cm95KCkKICB9CgogIF9vbnJhd2RhdGEoZGF0YSkgewogICAgbGV0IG9mZnNldCA9IDAKCiAgICBpZiAodGhpcy5fdGltZW91dFRpbWVyICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX3RpbWVvdXRUaW1lci5yZWZyZXNoKCkKICAgIH0KCiAgICBkbyB7CiAgICAgIHN3aXRjaCAodGhpcy5fc3RhdGUpIHsKICAgICAgICBjYXNlIDA6IHsKICAgICAgICAgIHdoaWxlICh0aGlzLl90bXAgIT09IDB4MTAwMDAwMCAmJiBvZmZzZXQgPCBkYXRhLmJ5dGVMZW5ndGgpIHsKICAgICAgICAgICAgY29uc3QgdiA9IGRhdGFbb2Zmc2V0KytdCiAgICAgICAgICAgIHRoaXMuX2xlbiArPSB0aGlzLl90bXAgKiB2CiAgICAgICAgICAgIHRoaXMuX3RtcCAqPSAyNTYKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodGhpcy5fdG1wID09PSAweDEwMDAwMDApIHsKICAgICAgICAgICAgdGhpcy5fdG1wID0gMAogICAgICAgICAgICB0aGlzLl9zdGF0ZSA9IDEKICAgICAgICAgICAgY29uc3QgdW5wcm9jZXNzZWQgPSBkYXRhLmJ5dGVMZW5ndGggLSBvZmZzZXQKICAgICAgICAgICAgaWYgKHVucHJvY2Vzc2VkIDwgdGhpcy5fbGVuICYmIHRoaXMuX3V0cCAhPT0gbnVsbCkKICAgICAgICAgICAgICB0aGlzLl91dHAuc2V0Q29udGVudFNpemUodGhpcy5fbGVuIC0gdW5wcm9jZXNzZWQpCiAgICAgICAgICB9CgogICAgICAgICAgYnJlYWsKICAgICAgICB9CgogICAgICAgIGNhc2UgMTogewogICAgICAgICAgY29uc3QgbWlzc2luZyA9IHRoaXMuX2xlbiAtIHRoaXMuX3RtcAogICAgICAgICAgY29uc3QgZW5kID0gbWlzc2luZyArIG9mZnNldAoKICAgICAgICAgIGlmICh0aGlzLl9tZXNzYWdlID09PSBudWxsICYmIGVuZCA8PSBkYXRhLmJ5dGVMZW5ndGgpIHsKICAgICAgICAgICAgdGhpcy5fbWVzc2FnZSA9IGRhdGEuc3ViYXJyYXkob2Zmc2V0LCBlbmQpCiAgICAgICAgICAgIG9mZnNldCArPSBtaXNzaW5nCiAgICAgICAgICAgIHRoaXMuX2luY29taW5nKCkKICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIH0KCiAgICAgICAgICBjb25zdCB1bnByb2Nlc3NlZCA9IGRhdGEuYnl0ZUxlbmd0aCAtIG9mZnNldAoKICAgICAgICAgIGlmICh0aGlzLl9tZXNzYWdlID09PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuX21lc3NhZ2UgPSBiNGEuYWxsb2NVbnNhZmUodGhpcy5fbGVuKQogICAgICAgICAgfQoKICAgICAgICAgIGI0YS5jb3B5KGRhdGEsIHRoaXMuX21lc3NhZ2UsIHRoaXMuX3RtcCwgb2Zmc2V0KQogICAgICAgICAgdGhpcy5fdG1wICs9IHVucHJvY2Vzc2VkCgogICAgICAgICAgaWYgKGVuZCA8PSBkYXRhLmJ5dGVMZW5ndGgpIHsKICAgICAgICAgICAgb2Zmc2V0ICs9IG1pc3NpbmcKICAgICAgICAgICAgdGhpcy5faW5jb21pbmcoKQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb2Zmc2V0ICs9IHVucHJvY2Vzc2VkCiAgICAgICAgICB9CgogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0KICAgIH0gd2hpbGUgKG9mZnNldCA8IGRhdGEuYnl0ZUxlbmd0aCAmJiAhdGhpcy5kZXN0cm95aW5nKQogIH0KCiAgX29ucmF3ZW5kKCkgewogICAgdGhpcy5fZW5kZWQtLQogICAgdGhpcy5wdXNoKG51bGwpCiAgfQoKICBfb25yYXdkcmFpbigpIHsKICAgIGNvbnN0IGRyYWluID0gdGhpcy5fZHJhaW5Eb25lCiAgICBpZiAoZHJhaW4gPT09IG51bGwpIHJldHVybgogICAgdGhpcy5fZHJhaW5Eb25lID0gbnVsbAogICAgZHJhaW4oKQogIH0KCiAgX3JlYWQoY2IpIHsKICAgIHRoaXMucmF3U3RyZWFtLnJlc3VtZSgpCiAgICBjYihudWxsKQogIH0KCiAgX2luY29taW5nKCkgewogICAgY29uc3QgbWVzc2FnZSA9IHRoaXMuX21lc3NhZ2UKCiAgICB0aGlzLl9zdGF0ZSA9IDAKICAgIHRoaXMuX2xlbiA9IDAKICAgIHRoaXMuX3RtcCA9IDEKICAgIHRoaXMuX21lc3NhZ2UgPSBudWxsCgogICAgaWYgKHRoaXMuX3NldHVwID09PSB0cnVlKSB7CiAgICAgIGlmICh0aGlzLl9oYW5kc2hha2UpIHsKICAgICAgICB0aGlzLl9vbmhhbmRzaGFrZXJ0KHRoaXMuX2hhbmRzaGFrZS5yZWN2KG1lc3NhZ2UpKQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChtZXNzYWdlLmJ5dGVMZW5ndGggIT09IElESEVBREVSQllURVMpIHsKICAgICAgICAgIHRoaXMuZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgaGVhZGVyIG1lc3NhZ2UgcmVjZWl2ZWQnKSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgY29uc3QgcmVtb3RlSWQgPSBtZXNzYWdlLnN1YmFycmF5KDAsIDMyKQogICAgICAgIGNvbnN0IGV4cGVjdGVkSWQgPSBzdHJlYW1JZCh0aGlzLmhhbmRzaGFrZUhhc2gsICF0aGlzLmlzSW5pdGlhdG9yKQogICAgICAgIGNvbnN0IGhlYWRlciA9IG1lc3NhZ2Uuc3ViYXJyYXkoMzIpCgogICAgICAgIGlmICghYjRhLmVxdWFscyhleHBlY3RlZElkLCByZW1vdGVJZCkpIHsKICAgICAgICAgIHRoaXMuZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgaGVhZGVyIHJlY2VpdmVkJykpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIHRoaXMuX2RlY3J5cHQuaW5pdChoZWFkZXIpCiAgICAgICAgdGhpcy5fc2V0dXAgPSBmYWxzZSAvLyBzZXR1cCBpcyBub3cgZG9uZQogICAgICB9CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChtZXNzYWdlLmJ5dGVMZW5ndGggPCBBQllURVMpIHsKICAgICAgdGhpcy5kZXN0cm95KG5ldyBFcnJvcignSW52YWxpZCBtZXNzYWdlIHJlY2VpdmVkJykpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMucmF3Qnl0ZXNSZWFkICs9IG1lc3NhZ2UuYnl0ZUxlbmd0aAoKICAgIGNvbnN0IHBsYWluID0gbWVzc2FnZS5zdWJhcnJheSgxLCBtZXNzYWdlLmJ5dGVMZW5ndGggLSBBQllURVMgKyAxKQoKICAgIHRyeSB7CiAgICAgIHRoaXMuX2RlY3J5cHQubmV4dChtZXNzYWdlLCBwbGFpbikKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLmRlc3Ryb3koZXJyKQogICAgICByZXR1cm4KICAgIH0KCiAgICAvLyBJZiBrZWVwIGFsaXZlIGlzIHNlbGVjdGl2ZSwgZWF0IHRoZSBlbXB0eSBidWZmZXJzIChpZSBhc3N1bWUgdGhlIG90aGVyIHNpZGUgaGFzIGl0IGVuYWJsZWQgYWxzbykKICAgIGlmIChwbGFpbi5ieXRlTGVuZ3RoID09PSAwICYmIHRoaXMua2VlcEFsaXZlICE9PSAwKSByZXR1cm4KCiAgICBpZiAodGhpcy5wdXNoKHBsYWluKSA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5yYXdTdHJlYW0ucGF1c2UoKQogICAgfQogIH0KCiAgX29uaGFuZHNoYWtlcnQoaCkgewogICAgaWYgKHRoaXMuX2hhbmRzaGFrZURvbmUgPT09IG51bGwpIHJldHVybgoKICAgIGlmIChoICE9PSBudWxsKSB7CiAgICAgIGlmIChoLmRhdGEpIHRoaXMuX3Jhd1N0cmVhbS53cml0ZShoLmRhdGEpCiAgICAgIGlmICghaC50eCkgcmV0dXJuCiAgICB9CgogICAgY29uc3QgZG9uZSA9IHRoaXMuX2hhbmRzaGFrZURvbmUKICAgIGNvbnN0IHB1YmxpY0tleSA9IHRoaXMuX2hhbmRzaGFrZS5rZXlQYWlyLnB1YmxpY0tleQoKICAgIHRoaXMuX2hhbmRzaGFrZURvbmUgPSBudWxsCiAgICB0aGlzLl9oYW5kc2hha2UgPSBudWxsCgogICAgaWYgKGggPT09IG51bGwpIHJldHVybiBkb25lKG5ldyBFcnJvcignTm9pc2UgaGFuZHNoYWtlIGZhaWxlZCcpKQoKICAgIHRoaXMuX3NldHVwU2VjcmV0U3RyZWFtKGgudHgsIGgucngsIGguaGFzaCwgcHVibGljS2V5LCBoLnJlbW90ZVB1YmxpY0tleSkKICAgIHRoaXMuX3Jlc29sdmVPcGVuZWQodHJ1ZSkKICAgIGRvbmUobnVsbCkKICB9CgogIF9zZXR1cFNlY3JldFN0cmVhbSh0eCwgcngsIGhhbmRzaGFrZUhhc2gsIHB1YmxpY0tleSwgcmVtb3RlUHVibGljS2V5KSB7CiAgICBjb25zdCBidWYgPSBiNGEuYWxsb2NVbnNhZmVTbG93KDMgKyBJREhFQURFUkJZVEVTKQogICAgd3JpdGVVaW50MjRsZShJREhFQURFUkJZVEVTLCBidWYpCgogICAgdGhpcy5fZW5jcnlwdCA9IG5ldyBQdXNoKHVuc2xhYih0eC5zdWJhcnJheSgwLCBLRVlCWVRFUykpLCB1bmRlZmluZWQsIGJ1Zi5zdWJhcnJheSgzICsgMzIpKQogICAgdGhpcy5fZGVjcnlwdCA9IG5ldyBQdWxsKHVuc2xhYihyeC5zdWJhcnJheSgwLCBLRVlCWVRFUykpKQoKICAgIHRoaXMucHVibGljS2V5ID0gcHVibGljS2V5CiAgICB0aGlzLnJlbW90ZVB1YmxpY0tleSA9IHJlbW90ZVB1YmxpY0tleQogICAgdGhpcy5oYW5kc2hha2VIYXNoID0gaGFuZHNoYWtlSGFzaAoKICAgIGNvbnN0IGlkID0gYnVmLnN1YmFycmF5KDMsIDMgKyAzMikKICAgIHN0cmVhbUlkKGhhbmRzaGFrZUhhc2gsIHRoaXMuaXNJbml0aWF0b3IsIGlkKQoKICAgIC8vIGluaXRpYWxpemUgc2VjcmV0Ym94IHN0YXRlIGZvciB1bm9yZGVyZWQgbWVzc2FnZXMKICAgIHRoaXMuX3NldHVwU2VjcmV0U2VuZChoYW5kc2hha2VIYXNoKQoKICAgIHRoaXMuZW1pdCgnaGFuZHNoYWtlJykKICAgIC8vIGlmIHJhd1N0cmVhbSBpcyBhIGJyaWRnZSwgYWxzbyBlbWl0IGl0IHRoZXJlCiAgICBpZiAodGhpcy5yYXdTdHJlYW0gIT09IHRoaXMuX3Jhd1N0cmVhbSkgdGhpcy5yYXdTdHJlYW0uZW1pdCgnaGFuZHNoYWtlJykKCiAgICBpZiAodGhpcy5kZXN0cm95aW5nKSByZXR1cm4KCiAgICB0aGlzLl9yYXdTdHJlYW0ud3JpdGUoYnVmKQogIH0KCiAgX3NldHVwU2VjcmV0U2VuZChoYW5kc2hha2VIYXNoKSB7CiAgICB0aGlzLl9zZW5kU3RhdGUgPSBiNGEuYWxsb2NVbnNhZmVTbG93KDMyICsgMzIgKyA4ICsgOCkKICAgIGNvbnN0IGVuY3J5cHQgPSB0aGlzLl9zZW5kU3RhdGUuc3ViYXJyYXkoMCwgMzIpIC8vIHNlY3JldHMKICAgIGNvbnN0IGRlY3J5cHQgPSB0aGlzLl9zZW5kU3RhdGUuc3ViYXJyYXkoMzIsIDY0KQogICAgY29uc3QgY291bnRlciA9IHRoaXMuX3NlbmRTdGF0ZS5zdWJhcnJheSg2NCwgNzIpIC8vIG5vbmNlCiAgICBjb25zdCBpbml0aWFsID0gdGhpcy5fc2VuZFN0YXRlLnN1YmFycmF5KDcyKQoKICAgIGNvbnN0IGlucHV0cyA9IHRoaXMuaXNJbml0aWF0b3IKICAgICAgPyBbCiAgICAgICAgICBbTlNfSU5JVElBVE9SLCBOU19TRU5EXSwKICAgICAgICAgIFtOU19SRVNQT05ERVIsIE5TX1NFTkRdCiAgICAgICAgXQogICAgICA6IFsKICAgICAgICAgIFtOU19SRVNQT05ERVIsIE5TX1NFTkRdLAogICAgICAgICAgW05TX0lOSVRJQVRPUiwgTlNfU0VORF0KICAgICAgICBdCgogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChlbmNyeXB0LCBpbnB1dHNbMF0sIGhhbmRzaGFrZUhhc2gpCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKGRlY3J5cHQsIGlucHV0c1sxXSwgaGFuZHNoYWtlSGFzaCkKCiAgICBzb2RpdW0ucmFuZG9tYnl0ZXNfYnVmKGluaXRpYWwpCiAgICBjb3VudGVyLnNldChpbml0aWFsKQogIH0KCiAgX29wZW4oY2IpIHsKICAgIC8vIG5vIGF1dG9zdGFydCBvciBubyBoYW5kc2hha2UgeWV0CiAgICBpZiAodGhpcy5fcmF3U3RyZWFtID09PSBudWxsIHx8ICh0aGlzLl9oYW5kc2hha2UgPT09IG51bGwgJiYgdGhpcy5fZW5jcnlwdCA9PT0gbnVsbCkpIHsKICAgICAgdGhpcy5fc3RhcnREb25lID0gY2IKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5fcmF3U3RyZWFtLm9uKCdkYXRhJywgdGhpcy5fb25yYXdkYXRhLmJpbmQodGhpcykpCiAgICB0aGlzLl9yYXdTdHJlYW0ub24oJ2VuZCcsIHRoaXMuX29ucmF3ZW5kLmJpbmQodGhpcykpCiAgICB0aGlzLl9yYXdTdHJlYW0ub24oJ2RyYWluJywgdGhpcy5fb25yYXdkcmFpbi5iaW5kKHRoaXMpKQoKICAgIGlmICh0aGlzLmVuYWJsZVNlbmQpIHRoaXMuX3Jhd1N0cmVhbS5vbignbWVzc2FnZScsIHRoaXMuX29ubWVzc2FnZS5iaW5kKHRoaXMpKQoKICAgIGlmICh0aGlzLl9lbmNyeXB0ICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX3Jlc29sdmVPcGVuZWQodHJ1ZSkKICAgICAgcmV0dXJuIGNiKG51bGwpCiAgICB9CgogICAgdGhpcy5faGFuZHNoYWtlRG9uZSA9IGNiCgogICAgaWYgKHRoaXMuaXNJbml0aWF0b3IpIHRoaXMuX29uaGFuZHNoYWtlcnQodGhpcy5faGFuZHNoYWtlLnNlbmQoKSkKICB9CgogIF9wcmVkZXN0cm95KCkgewogICAgaWYgKHRoaXMucmF3U3RyZWFtKSB7CiAgICAgIGNvbnN0IGVycm9yID0gZ2V0U3RyZWFtRXJyb3IodGhpcykKICAgICAgdGhpcy5yYXdTdHJlYW0uZGVzdHJveShlcnJvcikKICAgIH0KCiAgICBpZiAodGhpcy5fc3RhcnREb25lICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IGRvbmUgPSB0aGlzLl9zdGFydERvbmUKICAgICAgdGhpcy5fc3RhcnREb25lID0gbnVsbAogICAgICBkb25lKG5ldyBFcnJvcignU3RyZWFtIGRlc3Ryb3llZCcpKQogICAgfQoKICAgIGlmICh0aGlzLl9oYW5kc2hha2VEb25lICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IGRvbmUgPSB0aGlzLl9oYW5kc2hha2VEb25lCiAgICAgIHRoaXMuX2hhbmRzaGFrZURvbmUgPSBudWxsCiAgICAgIGRvbmUobmV3IEVycm9yKCdTdHJlYW0gZGVzdHJveWVkJykpCiAgICB9CgogICAgaWYgKHRoaXMuX2RyYWluRG9uZSAhPT0gbnVsbCkgewogICAgICBjb25zdCBkb25lID0gdGhpcy5fZHJhaW5Eb25lCiAgICAgIHRoaXMuX2RyYWluRG9uZSA9IG51bGwKICAgICAgZG9uZShuZXcgRXJyb3IoJ1N0cmVhbSBkZXN0cm95ZWQnKSkKICAgIH0KICB9CgogIF93cml0ZShkYXRhLCBjYikgewogICAgbGV0IHdyYXBwZWQgPSB0aGlzLl9vdXRnb2luZ1dyYXBwZWQKCiAgICBpZiAoZGF0YSAhPT0gdGhpcy5fb3V0Z29pbmdQbGFpbikgewogICAgICB3cmFwcGVkID0gYjRhLmFsbG9jVW5zYWZlKGRhdGEuYnl0ZUxlbmd0aCArIDMgKyBBQllURVMpCiAgICAgIHdyYXBwZWQuc2V0KGRhdGEsIDQpCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9vdXRnb2luZ1dyYXBwZWQgPSB0aGlzLl9vdXRnb2luZ1BsYWluID0gbnVsbAogICAgfQoKICAgIGlmICh3cmFwcGVkLmJ5dGVMZW5ndGggLSAzID4gTUFYX0FUT01JQ19XUklURSkgewogICAgICByZXR1cm4gY2IoCiAgICAgICAgbmV3IEVycm9yKAogICAgICAgICAgJ01lc3NhZ2UgaXMgdG9vIGxhcmdlIGZvciBhbiBhdG9taWMgd3JpdGUuIE1heCBzaXplIGlzICcgKyBNQVhfQVRPTUlDX1dSSVRFICsgJyBieXRlcy4nCiAgICAgICAgKQogICAgICApCiAgICB9CiAgICB0aGlzLnJhd0J5dGVzV3JpdHRlbiArPSB3cmFwcGVkLmJ5dGVMZW5ndGgKCiAgICB3cml0ZVVpbnQyNGxlKHdyYXBwZWQuYnl0ZUxlbmd0aCAtIDMsIHdyYXBwZWQpCiAgICAvLyBvZmZzZXQgNCBzbyB3ZSBjYW4gZG8gaXQgaW4tcGxhY2UKICAgIHRoaXMuX2VuY3J5cHQubmV4dCh3cmFwcGVkLnN1YmFycmF5KDQsIDQgKyBkYXRhLmJ5dGVMZW5ndGgpLCB3cmFwcGVkLnN1YmFycmF5KDMpKQoKICAgIGlmICh0aGlzLl9rZWVwQWxpdmVUaW1lciAhPT0gbnVsbCkgdGhpcy5fa2VlcEFsaXZlVGltZXIucmVmcmVzaCgpCgogICAgaWYgKHRoaXMuX3Jhd1N0cmVhbS53cml0ZSh3cmFwcGVkKSA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5fZHJhaW5Eb25lID0gY2IKICAgIH0gZWxzZSB7CiAgICAgIGNiKG51bGwpCiAgICB9CiAgfQoKICBfZmluYWwoY2IpIHsKICAgIHRoaXMuX2NsZWFyS2VlcEFsaXZlKCkKICAgIHRoaXMuX2VuZGVkLS0KICAgIHRoaXMuX3Jhd1N0cmVhbS5lbmQoKQogICAgY2IobnVsbCkKICB9CgogIF9yZXNvbHZlT3BlbmVkKHZhbCkgewogICAgaWYgKHRoaXMuX29wZW5lZERvbmUgPT09IG51bGwpIHJldHVybgogICAgY29uc3Qgb3BlbmVkID0gdGhpcy5fb3BlbmVkRG9uZQogICAgdGhpcy5fb3BlbmVkRG9uZSA9IG51bGwKICAgIG9wZW5lZCh2YWwpCiAgICBpZiAoIXZhbCkgcmV0dXJuCiAgICB0aGlzLmNvbm5lY3RlZCA9IHRydWUKICAgIHRoaXMuZW1pdCgnY29ubmVjdCcpCiAgfQoKICBfY2xlYXJUaW1lb3V0KCkgewogICAgaWYgKHRoaXMuX3RpbWVvdXRUaW1lciA9PT0gbnVsbCkgcmV0dXJuCiAgICB0aGlzLl90aW1lb3V0VGltZXIuZGVzdHJveSgpCiAgICB0aGlzLl90aW1lb3V0VGltZXIgPSBudWxsCiAgICB0aGlzLnRpbWVvdXQgPSAwCiAgfQoKICBfY2xlYXJLZWVwQWxpdmUoKSB7CiAgICBpZiAodGhpcy5fa2VlcEFsaXZlVGltZXIgPT09IG51bGwpIHJldHVybgogICAgdGhpcy5fa2VlcEFsaXZlVGltZXIuZGVzdHJveSgpCiAgICB0aGlzLl9rZWVwQWxpdmVUaW1lciA9IG51bGwKICAgIHRoaXMua2VlcEFsaXZlID0gMAogIH0KCiAgX2Rlc3Ryb3koY2IpIHsKICAgIHRoaXMuX2NsZWFyS2VlcEFsaXZlKCkKICAgIHRoaXMuX2NsZWFyVGltZW91dCgpCiAgICB0aGlzLl9yZXNvbHZlT3BlbmVkKGZhbHNlKQogICAgY2IobnVsbCkKICB9CgogIF9ib3hNZXNzYWdlKGJ1ZmZlcikgewogICAgY29uc3QgTUIgPSBzb2RpdW0uY3J5cHRvX3NlY3JldGJveF9NQUNCWVRFUyAvLyAxNgogICAgY29uc3QgTkIgPSBzb2RpdW0uY3J5cHRvX3NlY3JldGJveF9OT05DRUJZVEVTIC8vIDI0CgogICAgY29uc3QgY291bnRlciA9IHRoaXMuX3NlbmRTdGF0ZS5zdWJhcnJheSg2NCwgNzIpCiAgICBzb2RpdW0uc29kaXVtX2luY3JlbWVudChjb3VudGVyKQogICAgaWYgKGI0YS5lcXVhbHMoY291bnRlciwgdGhpcy5fc2VuZFN0YXRlLnN1YmFycmF5KDcyKSkpIHsKICAgICAgdGhpcy5kZXN0cm95KG5ldyBFcnJvcigndWRwIHNlbmQgbm9uY2UgZXhjaGF1c3RlZCcpKQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBzZWNyZXQgPSB0aGlzLl9zZW5kU3RhdGUuc3ViYXJyYXkoMCwgMzIpCiAgICBjb25zdCBlbnZlbG9wZSA9IGI0YS5hbGxvY1Vuc2FmZSg4ICsgTUIgKyBidWZmZXIuYnl0ZUxlbmd0aCkKICAgIGNvbnN0IG5vbmNlID0gZW52ZWxvcGUuc3ViYXJyYXkoMCwgTkIpCiAgICBjb25zdCBjaXBoZXJ0ZXh0ID0gZW52ZWxvcGUuc3ViYXJyYXkoOCkKCiAgICBiNGEuZmlsbChub25jZSwgMCkgLy8gcGFkIHN1ZmZpeAogICAgbm9uY2Uuc2V0KGNvdW50ZXIpCgogICAgc29kaXVtLmNyeXB0b19zZWNyZXRib3hfZWFzeShjaXBoZXJ0ZXh0LCBidWZmZXIsIG5vbmNlLCBzZWNyZXQpCiAgICByZXR1cm4gZW52ZWxvcGUKICB9CgogIHNlbmQoYnVmZmVyKSB7CiAgICBpZiAoIXRoaXMuX3NlbmRTdGF0ZSkgcmV0dXJuCiAgICBpZiAoIXRoaXMucmF3U3RyZWFtPy5zZW5kKSByZXR1cm4gLy8gdWR4LXN0cmVhbSBleHBlY3RlZAoKICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLl9ib3hNZXNzYWdlKGJ1ZmZlcikKICAgIHJldHVybiB0aGlzLnJhd1N0cmVhbS5zZW5kKG1lc3NhZ2UpCiAgfQoKICB0cnlTZW5kKGJ1ZmZlcikgewogICAgaWYgKCF0aGlzLl9zZW5kU3RhdGUpIHJldHVybgogICAgaWYgKCF0aGlzLnJhd1N0cmVhbT8udHJ5U2VuZCkgcmV0dXJuIC8vIHVkeC1zdHJlYW0gZXhwZWN0ZWQKCiAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5fYm94TWVzc2FnZShidWZmZXIpCiAgICB0aGlzLnJhd1N0cmVhbS50cnlTZW5kKG1lc3NhZ2UpCiAgfQoKICBfb25tZXNzYWdlKGJ1ZmZlcikgewogICAgaWYgKCF0aGlzLl9zZW5kU3RhdGUpIHJldHVybiAvLyBtZXNzYWdlcyBiZWZvcmUgaGFuZHNoYWtlIGFyZSBkcm9wcGVkCgogICAgY29uc3QgTUIgPSBzb2RpdW0uY3J5cHRvX3NlY3JldGJveF9NQUNCWVRFUyAvLyAxNgogICAgY29uc3QgTkIgPSBzb2RpdW0uY3J5cHRvX3NlY3JldGJveF9OT05DRUJZVEVTIC8vIDI0CgogICAgaWYgKGJ1ZmZlci5ieXRlTGVuZ3RoIDwgTkIpIHJldHVybiAvLyBJbnZhbGlkIG1lc3NhZ2UKCiAgICBjb25zdCBub25jZSA9IGI0YS5hbGxvY1Vuc2FmZShOQikKICAgIGI0YS5maWxsKG5vbmNlLCAwKQogICAgbm9uY2Uuc2V0KGJ1ZmZlci5zdWJhcnJheSgwLCA4KSkKCiAgICBjb25zdCBzZWNyZXQgPSB0aGlzLl9zZW5kU3RhdGUuc3ViYXJyYXkoMzIsIDY0KQogICAgY29uc3QgY2lwaGVydGV4dCA9IGJ1ZmZlci5zdWJhcnJheSg4KQogICAgY29uc3QgcGxhaW4gPSBidWZmZXIuc3ViYXJyYXkoOCwgYnVmZmVyLmJ5dGVMZW5ndGggLSBNQikKCiAgICBpZiAoY2lwaGVydGV4dC5ieXRlTGVuZ3RoIDwgTUIpIHJldHVybiAvLyBpbnZhbGlkIG1lc3NhZ2UKCiAgICBjb25zdCBzdWNjZXNzID0gc29kaXVtLmNyeXB0b19zZWNyZXRib3hfb3Blbl9lYXN5KHBsYWluLCBjaXBoZXJ0ZXh0LCBub25jZSwgc2VjcmV0KQoKICAgIGlmIChzdWNjZXNzKSB0aGlzLmVtaXQoJ21lc3NhZ2UnLCBwbGFpbikKICB9CgogIGFsbG9jKGxlbikgewogICAgY29uc3QgYnVmID0gYjRhLmFsbG9jVW5zYWZlKGxlbiArIDMgKyBBQllURVMpCiAgICB0aGlzLl9vdXRnb2luZ1dyYXBwZWQgPSBidWYKICAgIHRoaXMuX291dGdvaW5nUGxhaW4gPSBidWYuc3ViYXJyYXkoNCwgYnVmLmJ5dGVMZW5ndGggLSBBQllURVMgKyAxKQogICAgcmV0dXJuIHRoaXMuX291dGdvaW5nUGxhaW4KICB9CgogIHRvSlNPTigpIHsKICAgIHJldHVybiB7CiAgICAgIGlzSW5pdGlhdG9yOiB0aGlzLmlzSW5pdGlhdG9yLAogICAgICBwdWJsaWNLZXk6IHRoaXMucHVibGljS2V5ICYmIGI0YS50b1N0cmluZyh0aGlzLnB1YmxpY0tleSwgJ2hleCcpLAogICAgICByZW1vdGVQdWJsaWNLZXk6IHRoaXMucmVtb3RlUHVibGljS2V5ICYmIGI0YS50b1N0cmluZyh0aGlzLnJlbW90ZVB1YmxpY0tleSwgJ2hleCcpLAogICAgICBjb25uZWN0ZWQ6IHRoaXMuY29ubmVjdGVkLAogICAgICBkZXN0cm95aW5nOiB0aGlzLmRlc3Ryb3lpbmcsCiAgICAgIGRlc3Ryb3llZDogdGhpcy5kZXN0cm95ZWQsCiAgICAgIHJhd1N0cmVhbTogdGhpcy5yYXdTdHJlYW0gJiYgdGhpcy5yYXdTdHJlYW0udG9KU09OID8gdGhpcy5yYXdTdHJlYW0udG9KU09OKCkgOiBudWxsCiAgICB9CiAgfQp9CgpmdW5jdGlvbiB3cml0ZVVpbnQyNGxlKG4sIGJ1ZikgewogIGJ1ZlswXSA9IG4gJiAyNTUKICBidWZbMV0gPSAobiA+Pj4gOCkgJiAyNTUKICBidWZbMl0gPSAobiA+Pj4gMTYpICYgMjU1Cn0KCmZ1bmN0aW9uIHN0cmVhbUlkKGhhbmRzaGFrZUhhc2gsIGlzSW5pdGlhdG9yLCBvdXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpKSB7CiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChvdXQsIGlzSW5pdGlhdG9yID8gTlNfSU5JVElBVE9SIDogTlNfUkVTUE9OREVSLCBoYW5kc2hha2VIYXNoKQogIHJldHVybiBvdXQKfQoKZnVuY3Rpb24gdG9CdWZmZXIoZGF0YSkgewogIHJldHVybiB0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycgPyBiNGEuZnJvbShkYXRhKSA6IGRhdGEKfQoKZnVuY3Rpb24gZGVzdHJveVRpbWVvdXQoKSB7CiAgdGhpcy5kZXN0cm95KG5ldyBFcnJvcignU3RyZWFtIHRpbWVkIG91dCcpKQp9CgpmdW5jdGlvbiBzZW5kS2VlcEFsaXZlKCkgewogIGNvbnN0IGVtcHR5ID0gdGhpcy5hbGxvYygwKQogIHRoaXMud3JpdGUoZW1wdHkpCn0KY29uc3QgeyBEdXBsZXgsIFdyaXRhYmxlIH0gPSByZXF1aXJlKCdzdHJlYW14JykKCmNsYXNzIFJldmVyc2VQYXNzVGhyb3VnaCBleHRlbmRzIER1cGxleCB7CiAgY29uc3RydWN0b3IocykgewogICAgc3VwZXIoKQogICAgdGhpcy5fc3RyZWFtID0gcwogICAgdGhpcy5fb25kcmFpbiA9IG51bGwKICB9CgogIF93cml0ZShkYXRhLCBjYikgewogICAgaWYgKHRoaXMuX3N0cmVhbS5wdXNoKGRhdGEpID09PSBmYWxzZSkgewogICAgICB0aGlzLl9zdHJlYW0uX29uZHJhaW4gPSBjYgogICAgfSBlbHNlIHsKICAgICAgY2IobnVsbCkKICAgIH0KICB9CgogIF9maW5hbChjYikgewogICAgdGhpcy5fc3RyZWFtLnB1c2gobnVsbCkKICAgIGNiKG51bGwpCiAgfQoKICBfcmVhZChjYikgewogICAgY29uc3Qgb25kcmFpbiA9IHRoaXMuX29uZHJhaW4KICAgIHRoaXMuX29uZHJhaW4gPSBudWxsCiAgICBpZiAob25kcmFpbikgb25kcmFpbigpCiAgICBjYihudWxsKQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBCcmlkZ2UgZXh0ZW5kcyBEdXBsZXggewogIGNvbnN0cnVjdG9yKG5vaXNlU3RyZWFtKSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5ub2lzZVN0cmVhbSA9IG5vaXNlU3RyZWFtCgogICAgdGhpcy5fb25kcmFpbiA9IG51bGwKICAgIHRoaXMucmV2ZXJzZSA9IG5ldyBSZXZlcnNlUGFzc1Rocm91Z2godGhpcykKICB9CgogIGdldCBwdWJsaWNLZXkoKSB7CiAgICByZXR1cm4gdGhpcy5ub2lzZVN0cmVhbS5wdWJsaWNLZXkKICB9CgogIGdldCByZW1vdGVQdWJsaWNLZXkoKSB7CiAgICByZXR1cm4gdGhpcy5ub2lzZVN0cmVhbS5yZW1vdGVQdWJsaWNLZXkKICB9CgogIGdldCBoYW5kc2hha2VIYXNoKCkgewogICAgcmV0dXJuIHRoaXMubm9pc2VTdHJlYW0uaGFuZHNoYWtlSGFzaAogIH0KCiAgZmx1c2goKSB7CiAgICByZXR1cm4gV3JpdGFibGUuZHJhaW5lZCh0aGlzKQogIH0KCiAgX3JlYWQoY2IpIHsKICAgIGNvbnN0IG9uZHJhaW4gPSB0aGlzLl9vbmRyYWluCiAgICB0aGlzLl9vbmRyYWluID0gbnVsbAogICAgaWYgKG9uZHJhaW4pIG9uZHJhaW4oKQogICAgY2IobnVsbCkKICB9CgogIF93cml0ZShkYXRhLCBjYikgewogICAgaWYgKHRoaXMucmV2ZXJzZS5wdXNoKGRhdGEpID09PSBmYWxzZSkgewogICAgICB0aGlzLnJldmVyc2UuX29uZHJhaW4gPSBjYgogICAgfSBlbHNlIHsKICAgICAgY2IobnVsbCkKICAgIH0KICB9CgogIF9maW5hbChjYikgewogICAgdGhpcy5yZXZlcnNlLnB1c2gobnVsbCkKICAgIGNiKG51bGwpCiAgfQp9CmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjdXJ2ZSA9IHJlcXVpcmUoJ25vaXNlLWN1cnZlLWVkJykKY29uc3QgTm9pc2UgPSByZXF1aXJlKCdub2lzZS1oYW5kc2hha2UnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgRU1QVFkgPSBiNGEuYWxsb2MoMCkKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgSGFuZHNoYWtlIHsKICBjb25zdHJ1Y3Rvcihpc0luaXRpYXRvciwga2V5UGFpciwgcmVtb3RlUHVibGljS2V5LCBwYXR0ZXJuKSB7CiAgICB0aGlzLmlzSW5pdGlhdG9yID0gaXNJbml0aWF0b3IKICAgIHRoaXMua2V5UGFpciA9IGtleVBhaXIKICAgIHRoaXMubm9pc2UgPSBuZXcgTm9pc2UocGF0dGVybiwgaXNJbml0aWF0b3IsIGtleVBhaXIsIHsgY3VydmUgfSkKICAgIHRoaXMubm9pc2UuaW5pdGlhbGlzZShFTVBUWSwgcmVtb3RlUHVibGljS2V5KQogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogIH0KCiAgc3RhdGljIGtleVBhaXIoc2VlZCkgewogICAgY29uc3QgcHVibGljS2V5ID0gYjRhLmFsbG9jKDMyKQogICAgY29uc3Qgc2VjcmV0S2V5ID0gYjRhLmFsbG9jKDY0KQogICAgaWYgKHNlZWQpIHNvZGl1bS5jcnlwdG9fc2lnbl9zZWVkX2tleXBhaXIocHVibGljS2V5LCBzZWNyZXRLZXksIHNlZWQpCiAgICBlbHNlIHNvZGl1bS5jcnlwdG9fc2lnbl9rZXlwYWlyKHB1YmxpY0tleSwgc2VjcmV0S2V5KQogICAgcmV0dXJuIHsgcHVibGljS2V5LCBzZWNyZXRLZXkgfQogIH0KCiAgcmVjdihkYXRhKSB7CiAgICB0cnkgewogICAgICB0aGlzLm5vaXNlLnJlY3YoZGF0YSkKICAgICAgaWYgKHRoaXMubm9pc2UuY29tcGxldGUpIHJldHVybiB0aGlzLl9yZXR1cm4obnVsbCkKICAgICAgcmV0dXJuIHRoaXMuc2VuZCgpCiAgICB9IGNhdGNoIHsKICAgICAgdGhpcy5kZXN0cm95KCkKICAgICAgcmV0dXJuIG51bGwKICAgIH0KICB9CgogIC8vIG5vdGUgdGhhdCB0aGUgZGF0YSByZXR1cm5lZCBoZXJlIGlzIGZyYW1lZCBzbyB3ZSBkb24ndCBoYXZlIHRvIGRvIGFuIGV4dHJhIGNvcHkKICAvLyB3aGVuIHNlbmRpbmcgaXQuLi4KICBzZW5kKCkgewogICAgdHJ5IHsKICAgICAgY29uc3QgZGF0YSA9IHRoaXMubm9pc2Uuc2VuZCgpCiAgICAgIGNvbnN0IHdyYXAgPSBiNGEuYWxsb2NVbnNhZmUoZGF0YS5ieXRlTGVuZ3RoICsgMykKCiAgICAgIHdyaXRlVWludDI0bGUoZGF0YS5ieXRlTGVuZ3RoLCB3cmFwKQogICAgICB3cmFwLnNldChkYXRhLCAzKQoKICAgICAgcmV0dXJuIHRoaXMuX3JldHVybih3cmFwKQogICAgfSBjYXRjaCB7CiAgICAgIHRoaXMuZGVzdHJveSgpCiAgICAgIHJldHVybiBudWxsCiAgICB9CiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQogIH0KCiAgX3JldHVybihkYXRhKSB7CiAgICBjb25zdCB0eCA9IHRoaXMubm9pc2UuY29tcGxldGUgPyBiNGEudG9CdWZmZXIodGhpcy5ub2lzZS50eCkgOiBudWxsCiAgICBjb25zdCByeCA9IHRoaXMubm9pc2UuY29tcGxldGUgPyBiNGEudG9CdWZmZXIodGhpcy5ub2lzZS5yeCkgOiBudWxsCiAgICBjb25zdCBoYXNoID0gdGhpcy5ub2lzZS5jb21wbGV0ZSA/IGI0YS50b0J1ZmZlcih0aGlzLm5vaXNlLmhhc2gpIDogbnVsbAogICAgY29uc3QgcmVtb3RlUHVibGljS2V5ID0gdGhpcy5ub2lzZS5jb21wbGV0ZSA/IGI0YS50b0J1ZmZlcih0aGlzLm5vaXNlLnJzKSA6IG51bGwKCiAgICByZXR1cm4gewogICAgICBkYXRhLAogICAgICByZW1vdGVQdWJsaWNLZXksCiAgICAgIGhhc2gsCiAgICAgIHR4LAogICAgICByeAogICAgfQogIH0KfQoKZnVuY3Rpb24gd3JpdGVVaW50MjRsZShuLCBidWYpIHsKICBidWZbMF0gPSBuICYgMjU1CiAgYnVmWzFdID0gKG4gPj4+IDgpICYgMjU1CiAgYnVmWzJdID0gKG4gPj4+IDE2KSAmIDI1NQp9CnsKICAibmFtZSI6ICJAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtIiwKICAidmVyc2lvbiI6ICI2LjkuMSIsCiAgImRlc2NyaXB0aW9uIjogIlNlY3JldCBzdHJlYW0gYmFja2VkIGJ5IE5vaXNlIGFuZCBsaWJzb2RpdW0ncyBzZWNyZXRzdHJlYW0iLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYi8qKi5qcyIKICBdLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjEuMCIsCiAgICAiaHlwZXJjb3JlLWNyeXB0byI6ICJeMy4zLjEiLAogICAgIm5vaXNlLWN1cnZlLWVkIjogIl4yLjAuMSIsCiAgICAibm9pc2UtaGFuZHNoYWtlIjogIl40LjAuMCIsCiAgICAic29kaXVtLXNlY3JldHN0cmVhbSI6ICJeMS4xLjAiLAogICAgInNvZGl1bS11bml2ZXJzYWwiOiAiXjUuMC4wIiwKICAgICJzdHJlYW14IjogIl4yLjE0LjAiLAogICAgInRpbWVvdXQtcmVmcmVzaCI6ICJeMi4wLjAiLAogICAgInVuc2xhYiI6ICJeMS4zLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMy4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIiwKICAgICJ1ZHgtbmF0aXZlIjogIl4xLjEzLjIiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIiwKICAgICJsaW50IjogInByZXR0aWVyIC0tY2hlY2sgLiIsCiAgICAidGVzdCI6ICJicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcnN3YXJtLXNlY3JldC1zdHJlYW0uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyc3dhcm0tc2VjcmV0LXN0cmVhbS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyc3dhcm0tc2VjcmV0LXN0cmVhbSIKfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IEluZGV4RW5jb2RlciA9IHJlcXVpcmUoJ2luZGV4LWVuY29kZXInKQoKY29uc3QgQ2hlY2tvdXQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBrZXk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBDbG9jayA9IGMuYXJyYXkoQ2hlY2tvdXQpCgpjb25zdCBJbmRleENoZWNrcG9pbnQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkNjQucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkNjQuZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzaWduYXR1cmU6IGMuZml4ZWQ2NC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBLZXlWMCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ua2V5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmtleSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAga2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiAtMQogICAgfQogIH0KfQoKY29uc3QgS2V5c1YwID0gYy5hcnJheShLZXlWMCkKCmNvbnN0IFdha2V1cFYwID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgMCkgLy8gdmVyc2lvbgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS50eXBlKQoKICAgIGlmIChtLnR5cGUgPT09IDEpIHsKICAgICAgS2V5c1YwLnByZWVuY29kZShzdGF0ZSwgbS53cml0ZXJzKQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAwKSAvLyB2ZXJzaW9uCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnR5cGUpCgogICAgaWYgKG0udHlwZSA9PT0gMSkgewogICAgICBLZXlzVjAuZW5jb2RlKHN0YXRlLCBtLndyaXRlcnMpCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHYgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgaWYgKHYgIT09IDApIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbjogJyArIHYpCgogICAgY29uc3QgdHlwZSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBtID0geyB2ZXJzaW9uOiAwLCB0eXBlLCB3cml0ZXJzOiBudWxsIH0KCiAgICBpZiAobS50eXBlID09PSAxKSB7CiAgICAgIG0ud3JpdGVycyA9IEtleXNWMC5kZWNvZGUoc3RhdGUpCiAgICB9CgogICAgcmV0dXJuIG0KICB9Cn0KCmNvbnN0IFdha2V1cCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGlmIChtLnZlcnNpb24gPT09IDApIHJldHVybiBXYWtldXBWMC5wcmVlbmNvZGUoc3RhdGUsIG0pCgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgMSkgLy8gdmVyc2lvbgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS50eXBlKQoKICAgIGlmIChtLnR5cGUgPT09IDEpIHsKICAgICAgQ2xvY2sucHJlZW5jb2RlKHN0YXRlLCBtLndyaXRlcnMpCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGlmIChtLnZlcnNpb24gPT09IDApIHJldHVybiBXYWtldXBWMC5lbmNvZGUoc3RhdGUsIG0pCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgMSkgLy8gdmVyc2lvbgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS50eXBlKQoKICAgIGlmIChtLnR5cGUgPT09IDEpIHsKICAgICAgQ2xvY2suZW5jb2RlKHN0YXRlLCBtLndyaXRlcnMpCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICAgIGNvbnN0IHYgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmICh2ID4gMSkgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uOiAnICsgdikKCiAgICBpZiAodiA9PT0gMCkgewogICAgICBzdGF0ZS5zdGFydCA9IHN0YXJ0CiAgICAgIHJldHVybiBXYWtldXBWMC5kZWNvZGUoc3RhdGUpCiAgICB9CgogICAgY29uc3QgdHlwZSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBtID0geyB2ZXJzaW9uOiAxLCB0eXBlLCB3cml0ZXJzOiBudWxsIH0KCiAgICBpZiAobS50eXBlID09PSAxKSB7CiAgICAgIG0ud3JpdGVycyA9IENsb2NrLmRlY29kZShzdGF0ZSkKICAgIH0KCiAgICByZXR1cm4gbQogIH0KfQoKY29uc3QgQm9vdFJlY29yZFYwID0gewogIHByZWVuY29kZSgpIHsKICAgIHRocm93IG5ldyBFcnJvcigndmVyc2lvbiAwIHJlY29yZHMgY2Fubm90IGJlIGVuY29kZWQnKQogIH0sCiAgZW5jb2RlKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCd2ZXJzaW9uIDAgcmVjb3JkcyBjYW5ub3QgYmUgZW5jb2RlZCcpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGluZGV4ZWQgPSBDaGVja291dC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBoZWFkcyA9IENsb2NrLmRlY29kZShzdGF0ZSkKCiAgICAvLyBvbmUgY2F1c2UgaW5pdGlhbCByZWNvdmVyIGlzIG5vdCBmZiByZWNvdmVyeQogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogMCwKICAgICAga2V5OiBpbmRleGVkLmtleSwKICAgICAgc3lzdGVtTGVuZ3RoOiBpbmRleGVkLmxlbmd0aCwKICAgICAgaW5kZXhlcnNVcGRhdGVkOiBmYWxzZSwKICAgICAgZmFzdEZvcndhcmRpbmc6IGZhbHNlLAogICAgICByZWNvdmVyaWVzOiAxLAogICAgICBtaWdyYXRpbmc6IGZhbHNlLAogICAgICBoZWFkcwogICAgfQogIH0KfQoKY29uc3QgQ2hlY2twb2ludGVyID0gewogIHByZWVuY29kZShzdGF0ZSwgaWR4KSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBpZHguY2hlY2twb2ludGVyKQogICAgaWYgKGlkeC5jaGVja3BvaW50ICE9PSBudWxsKSBJbmRleENoZWNrcG9pbnQucHJlZW5jb2RlKHN0YXRlLCBpZHguY2hlY2twb2ludCkKICB9LAogIGVuY29kZShzdGF0ZSwgaWR4KSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBpZHguY2hlY2twb2ludGVyKQogICAgaWYgKGlkeC5jaGVja3BvaW50ICE9PSBudWxsKSBJbmRleENoZWNrcG9pbnQuZW5jb2RlKHN0YXRlLCBpZHguY2hlY2twb2ludCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgY2hlY2twb2ludGVyID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGNoZWNrcG9pbnQgPSBjaGVja3BvaW50ZXIgPyBudWxsIDogSW5kZXhDaGVja3BvaW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBjaGVja3BvaW50ZXIsCiAgICAgIGNoZWNrcG9pbnQKICAgIH0KICB9Cn0KCmNvbnN0IENoZWNrcG9pbnRlckFycmF5ID0gYy5hcnJheShDaGVja3BvaW50ZXIpCgpjb25zdCBJbmRleGVyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ubmFtZXNwYWNlKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHNpZ25hdHVyZTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5hbWVzcGFjZTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIHB1YmxpY0tleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IEluZGV4ZXJzID0gYy5hcnJheShJbmRleGVyKQoKY29uc3QgRGlnZXN0VjAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnBvaW50ZXIpCiAgICBpZiAobS5wb2ludGVyID09PSAwKSB7CiAgICAgIEluZGV4ZXJzLnByZWVuY29kZShzdGF0ZSwgbS5pbmRleGVycykKICAgIH0KICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5wb2ludGVyKQogICAgaWYgKG0ucG9pbnRlciA9PT0gMCkgewogICAgICBJbmRleGVycy5lbmNvZGUoc3RhdGUsIG0uaW5kZXhlcnMpCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHBvaW50ZXIgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgcG9pbnRlciwKICAgICAgaW5kZXhlcnM6IHBvaW50ZXIgPT09IDAgPyBJbmRleGVycy5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKY29uc3QgRGlnZXN0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5wb2ludGVyKQogICAgaWYgKG0ucG9pbnRlciA9PT0gMCkgewogICAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIH0KICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5wb2ludGVyKQogICAgaWYgKG0ucG9pbnRlciA9PT0gMCkgewogICAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIH0KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcG9pbnRlciA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBwb2ludGVyLAogICAgICBrZXk6IHBvaW50ZXIgPT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IE5vZGUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBDbG9jay5wcmVlbmNvZGUoc3RhdGUsIG0uaGVhZHMpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmJhdGNoKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnZhbHVlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBDbG9jay5lbmNvZGUoc3RhdGUsIG0uaGVhZHMpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmJhdGNoKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnZhbHVlKQogIH0sCiAgZGVjb2RlKHN0YXRlLCBtKSB7CiAgICByZXR1cm4gewogICAgICBoZWFkczogQ2xvY2suZGVjb2RlKHN0YXRlKSwKICAgICAgYmF0Y2g6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICB2YWx1ZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgQWRkaXRpb25hbCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucG9pbnRlcikKICAgIGlmIChtLnBvaW50ZXIgPT09IDApIHsKICAgICAgQWRkaXRpb25hbERhdGEucHJlZW5jb2RlKHN0YXRlLCBtLmRhdGEpCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucG9pbnRlcikKICAgIGlmIChtLnBvaW50ZXIgPT09IDApIHsKICAgICAgQWRkaXRpb25hbERhdGEuZW5jb2RlKHN0YXRlLCBtLmRhdGEpCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHBvaW50ZXIgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgcG9pbnRlciwKICAgICAgZGF0YTogcG9pbnRlciA9PT0gMCA/IEFkZGl0aW9uYWxEYXRhLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBBZGRpdGlvbmFsRGF0YSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIDApCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApIC8vIGVtcHR5IGZvciBub3csIGZvciB0aGUgZnV0dXJlCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIGVuY3J5cHRpb25JZDogZmxhZ3MgJiAxID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsLCAvLyB0byBoZWxwIHZhbGlkYXRlIHRoZSBlbmNyeXB0aW9uIGtleSB1c2VkCiAgICAgIGFiaTogZmxhZ3MgJiAyID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCiAgICB9CiAgfQp9Cgpjb25zdCBPcGxvZ01lc3NhZ2VWMSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHRocm93IG5ldyBFcnJvcignRW5jb2Rpbmcgbm90IHN1cHBvcnRlZCcpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHRocm93IG5ldyBFcnJvcignRW5jb2Rpbmcgbm90IHN1cHBvcnRlZCcpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IG1heFN1cHBvcnRlZFZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBjb25zdCBpc0NoZWNrcG9pbnRlciA9IChmbGFncyAmIDEpICE9PSAwCgogICAgY29uc3QgY2hrID0gaXNDaGVja3BvaW50ZXIgPyBDaGVja3BvaW50ZXJBcnJheS5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgY29uc3QgZGlnZXN0ID0gaXNDaGVja3BvaW50ZXIgPyBEaWdlc3QuZGVjb2RlKHN0YXRlKSA6IG51bGwKCiAgICBjb25zdCBub2RlID0gTm9kZS5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogMSwKICAgICAgbWF4U3VwcG9ydGVkVmVyc2lvbiwKICAgICAgZGlnZXN0LAogICAgICBjaGVja3BvaW50OiBjaGsgPyB7IHN5c3RlbTogY2hrWzBdLCBlbmNyeXB0aW9uOiBudWxsLCB1c2VyOiBjaGsuc2xpY2UoMSkgfSA6IG51bGwsCiAgICAgIG9wdGltaXN0aWM6IChmbGFncyAmIDIpICE9PSAwLAogICAgICBub2RlCiAgICB9CiAgfQp9Cgpjb25zdCBPcGxvZ01lc3NhZ2VWMCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHRocm93IG5ldyBFcnJvcignRW5jb2Rpbmcgbm90IHN1cHBvcnRlZCcpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHRocm93IG5ldyBFcnJvcignRW5jb2Rpbmcgbm90IHN1cHBvcnRlZCcpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBjb25zdCBpc0NoZWNrcG9pbnRlciA9IChmbGFncyAmIDEpICE9PSAwCgogICAgaWYgKGlzQ2hlY2twb2ludGVyKSBEaWdlc3RWMC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBjaGsgPSBpc0NoZWNrcG9pbnRlciA/IENoZWNrcG9pbnRlckFycmF5LmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICBjb25zdCBub2RlID0gTm9kZS5kZWNvZGUoc3RhdGUpCiAgICBBZGRpdGlvbmFsLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IG1heFN1cHBvcnRlZFZlcnNpb24gPSBzdGF0ZS5zdGFydCA8IHN0YXRlLmVuZCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IDAsCiAgICAgIG1heFN1cHBvcnRlZFZlcnNpb24sCiAgICAgIGRpZ2VzdDogbnVsbCwKICAgICAgY2hlY2twb2ludDogY2hrID8geyBzeXN0ZW06IGNoa1swXSwgZW5jcnlwdGlvbjogbnVsbCwgdXNlcjogY2hrLnNsaWNlKDEpIH0gOiBudWxsLAogICAgICBvcHRpbWlzdGljOiBudWxsLAogICAgICBub2RlCiAgICB9CiAgfQp9CgovLyBwcmVmaXggMCBpcyByZXNlcnZlZCBmb3IgZnV0dXJlIG1hbmlmZXN0CmNvbnN0IExJTkVBUklaRVJfUFJFRklYID0gMQoKY29uc3QgTGluZWFyaXplcktleSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHNlcSkgewogICAgSW5kZXhFbmNvZGVyLlVJTlQucHJlZW5jb2RlKHN0YXRlLCBMSU5FQVJJWkVSX1BSRUZJWCkKICAgIEluZGV4RW5jb2Rlci5VSU5ULnByZWVuY29kZShzdGF0ZSwgc2VxKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBzZXEpIHsKICAgIEluZGV4RW5jb2Rlci5VSU5ULmVuY29kZShzdGF0ZSwgTElORUFSSVpFUl9QUkVGSVgpCiAgICBJbmRleEVuY29kZXIuVUlOVC5lbmNvZGUoc3RhdGUsIHNlcSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgSW5kZXhFbmNvZGVyLlVJTlQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIEluZGV4RW5jb2Rlci5VSU5ULmRlY29kZShzdGF0ZSkKICB9Cn0KCmZ1bmN0aW9uIGluZm9MZWdhY3lNYXAoaW5mbykgewogIHJldHVybiB7CiAgICB2ZXJzaW9uOiBpbmZvLnZlcnNpb24sCiAgICBtZW1iZXJzOiBpbmZvLm1lbWJlcnMsCiAgICBwZW5kaW5nSW5kZXhlcnM6IGluZm8ucGVuZGluZ0luZGV4ZXJzLAogICAgaW5kZXhlcnM6IGluZm8uaW5kZXhlcnMsCiAgICBoZWFkczogaW5mby5oZWFkcywKICAgIHZpZXdzOiBpbmZvLnZpZXdzLAogICAgZW5jcnlwdGlvbkxlbmd0aDogMCwKICAgIGVudHJvcHk6IG51bGwKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gewogIFdha2V1cCwKICBCb290UmVjb3JkVjAsCiAgT3Bsb2dNZXNzYWdlVjAsCiAgT3Bsb2dNZXNzYWdlVjEsCiAgTGluZWFyaXplcktleSwKICBpbmZvTGVnYWN5TWFwCn0KLy8gVGhpcyBmaWxlIGlzIGF1dG9nZW5lcmF0ZWQgYnkgdGhlIGh5cGVyc2NoZW1hIGNvbXBpbGVyCi8vIFNjaGVtYSBWZXJzaW9uOiAxCi8qIGVzbGludC1kaXNhYmxlIGNhbWVsY2FzZSAqLwovKiBlc2xpbnQtZGlzYWJsZSBxdW90ZXMgKi8KCmNvbnN0IHsgYyB9ID0gcmVxdWlyZSgnaHlwZXJzY2hlbWEvcnVudGltZScpCmNvbnN0IGV4dGVybmFsMCA9IHJlcXVpcmUoJy4uLy4uL2xlZ2FjeS5qcycpCgpjb25zdCBWRVJTSU9OID0gMQoKLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC12YXJzCmxldCB2ZXJzaW9uID0gVkVSU0lPTgoKLy8gQGF1dG9iYXNlL2NoZWNrb3V0CmNvbnN0IGVuY29kaW5nMCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBrZXk6IHIwLAogICAgICBsZW5ndGg6IHIxCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvY2xvY2sKY29uc3QgZW5jb2RpbmcxID0gYy5hcnJheShlbmNvZGluZzApCgovLyBAYXV0b2Jhc2UvaW5kZXgtY2hlY2twb2ludApjb25zdCBlbmNvZGluZzIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkNjQucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkNjQuZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMuZml4ZWQ2NC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgc2lnbmF0dXJlOiByMCwKICAgICAgbGVuZ3RoOiByMQogICAgfQogIH0KfQoKY29uc3QgZW5jb2RpbmczID0gZXh0ZXJuYWwwLldha2V1cAoKY29uc3QgZW5jb2Rpbmc0ID0gZXh0ZXJuYWwwLkJvb3RSZWNvcmRWMAoKLy8gQGF1dG9iYXNlL2Jvb3QtcmVjb3JkLXJhdwpjb25zdCBlbmNvZGluZzUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3lzdGVtTGVuZ3RoKQogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgNCBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5yZWNvdmVyaWVzKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnJlY292ZXJpZXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gKG0uaW5kZXhlcnNVcGRhdGVkID8gMSA6IDApIHwgKG0uZmFzdEZvcndhcmRpbmcgPyAyIDogMCkgfCAobS5yZWNvdmVyaWVzID8gNCA6IDApCgogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN5c3RlbUxlbmd0aCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLnJlY292ZXJpZXMpIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVjb3ZlcmllcykKICB9LAogIGRlY29kZShzdGF0ZSwgdmVyc2lvbikgewogICAgaWYgKHZlcnNpb24gPT09IHVuZGVmaW5lZCkgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMCA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbiwKICAgICAga2V5OiByMCwKICAgICAgc3lzdGVtTGVuZ3RoOiByMSwKICAgICAgaW5kZXhlcnNVcGRhdGVkOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgZmFzdEZvcndhcmRpbmc6IChmbGFncyAmIDIpICE9PSAwLAogICAgICByZWNvdmVyaWVzOiAoZmxhZ3MgJiA0KSAhPT0gMCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL2Jvb3QtcmVjb3JkCmNvbnN0IGVuY29kaW5nNiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIHN3aXRjaCAobS52ZXJzaW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICBlbmNvZGluZzQucHJlZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgMToKICAgICAgY2FzZSAyOgogICAgICBjYXNlIDM6CiAgICAgICAgZW5jb2Rpbmc1LnByZWVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbicpCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIHN3aXRjaCAobS52ZXJzaW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICBlbmNvZGluZzQuZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgMToKICAgICAgY2FzZSAyOgogICAgICBjYXNlIDM6CiAgICAgICAgZW5jb2Rpbmc1LmVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbicpCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgc3dpdGNoICh2ZXJzaW9uKSB7CiAgICAgIGNhc2UgMDogewogICAgICAgIGNvbnN0IGRlY29kZWQgPSBlbmNvZGluZzQuZGVjb2RlKHN0YXRlLCB2ZXJzaW9uKQogICAgICAgIHJldHVybiBkZWNvZGVkCiAgICAgIH0KICAgICAgY2FzZSAxOgogICAgICBjYXNlIDI6CiAgICAgIGNhc2UgMzogewogICAgICAgIGNvbnN0IGRlY29kZWQgPSBlbmNvZGluZzUuZGVjb2RlKHN0YXRlLCB2ZXJzaW9uKQogICAgICAgIHJldHVybiBkZWNvZGVkCiAgICAgIH0KICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb24nKQogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL2NoZWNrcG9pbnRlcgpjb25zdCBlbmNvZGluZzcgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAyIHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLmNoZWNrcG9pbnRlcikgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5jaGVja3BvaW50ZXIpCiAgICBpZiAobS5jaGVja3BvaW50KSBlbmNvZGluZzIucHJlZW5jb2RlKHN0YXRlLCBtLmNoZWNrcG9pbnQpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gKG0uY2hlY2twb2ludGVyID8gMSA6IDApIHwgKG0uY2hlY2twb2ludCA/IDIgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLmNoZWNrcG9pbnRlcikgYy51aW50LmVuY29kZShzdGF0ZSwgbS5jaGVja3BvaW50ZXIpCiAgICBpZiAobS5jaGVja3BvaW50KSBlbmNvZGluZzIuZW5jb2RlKHN0YXRlLCBtLmNoZWNrcG9pbnQpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBjaGVja3BvaW50ZXI6IChmbGFncyAmIDEpICE9PSAwID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwLAogICAgICBjaGVja3BvaW50OiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGVuY29kaW5nMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL2NoZWNrcG9pbnQudXNlcgpjb25zdCBlbmNvZGluZzhfMiA9IGMuYXJyYXkoZW5jb2Rpbmc3KQoKLy8gQGF1dG9iYXNlL2NoZWNrcG9pbnQKY29uc3QgZW5jb2Rpbmc4ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgNCBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5zeXN0ZW0pIGVuY29kaW5nNy5wcmVlbmNvZGUoc3RhdGUsIG0uc3lzdGVtKQogICAgaWYgKG0uZW5jcnlwdGlvbikgZW5jb2Rpbmc3LnByZWVuY29kZShzdGF0ZSwgbS5lbmNyeXB0aW9uKQogICAgaWYgKG0udXNlcikgZW5jb2Rpbmc4XzIucHJlZW5jb2RlKHN0YXRlLCBtLnVzZXIpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gKG0uc3lzdGVtID8gMSA6IDApIHwgKG0uZW5jcnlwdGlvbiA/IDIgOiAwKSB8IChtLnVzZXIgPyA0IDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5zeXN0ZW0pIGVuY29kaW5nNy5lbmNvZGUoc3RhdGUsIG0uc3lzdGVtKQogICAgaWYgKG0uZW5jcnlwdGlvbikgZW5jb2Rpbmc3LmVuY29kZShzdGF0ZSwgbS5lbmNyeXB0aW9uKQogICAgaWYgKG0udXNlcikgZW5jb2Rpbmc4XzIuZW5jb2RlKHN0YXRlLCBtLnVzZXIpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBzeXN0ZW06IChmbGFncyAmIDEpICE9PSAwID8gZW5jb2Rpbmc3LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBlbmNyeXB0aW9uOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGVuY29kaW5nNy5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdXNlcjogKGZsYWdzICYgNCkgIT09IDAgPyBlbmNvZGluZzhfMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL2RpZ2VzdApjb25zdCBlbmNvZGluZzkgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAyIHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLnBvaW50ZXIpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucG9pbnRlcikKICAgIGlmIChtLmtleSkgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gKG0ucG9pbnRlciA/IDEgOiAwKSB8IChtLmtleSA/IDIgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLnBvaW50ZXIpIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucG9pbnRlcikKICAgIGlmIChtLmtleSkgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBwb2ludGVyOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMCwKICAgICAga2V5OiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL25vZGUKY29uc3QgZW5jb2RpbmcxMCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGVuY29kaW5nMS5wcmVlbmNvZGUoc3RhdGUsIG0uaGVhZHMpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmJhdGNoKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnZhbHVlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBlbmNvZGluZzEuZW5jb2RlKHN0YXRlLCBtLmhlYWRzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5iYXRjaCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBlbmNvZGluZzEuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjIgPSBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgaGVhZHM6IHIwLAogICAgICBiYXRjaDogcjEsCiAgICAgIHZhbHVlOiByMgogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL3RyYWNlLnN5c3RlbQpjb25zdCBlbmNvZGluZzExXzAgPSBjLmFycmF5KGMudWludCkKLy8gQGF1dG9iYXNlL3RyYWNlLmVuY3J5cHRpb24KY29uc3QgZW5jb2RpbmcxMV8xID0gZW5jb2RpbmcxMV8wCgovLyBAYXV0b2Jhc2UvdHJhY2UKY29uc3QgZW5jb2RpbmcxMSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGVuY29kaW5nMTFfMC5wcmVlbmNvZGUoc3RhdGUsIG0uc3lzdGVtKQogICAgZW5jb2RpbmcxMV8xLnByZWVuY29kZShzdGF0ZSwgbS5lbmNyeXB0aW9uKQogICAgZW5jb2RpbmcxMV8yLnByZWVuY29kZShzdGF0ZSwgbS51c2VyKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBlbmNvZGluZzExXzAuZW5jb2RlKHN0YXRlLCBtLnN5c3RlbSkKICAgIGVuY29kaW5nMTFfMS5lbmNvZGUoc3RhdGUsIG0uZW5jcnlwdGlvbikKICAgIGVuY29kaW5nMTFfMi5lbmNvZGUoc3RhdGUsIG0udXNlcikKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBlbmNvZGluZzExXzAuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBlbmNvZGluZzExXzEuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjIgPSBlbmNvZGluZzExXzIuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHN5c3RlbTogcjAsCiAgICAgIGVuY3J5cHRpb246IHIxLAogICAgICB1c2VyOiByMgogICAgfQogIH0KfQoKY29uc3QgZW5jb2RpbmcxMiA9IGV4dGVybmFsMC5PcGxvZ01lc3NhZ2VWMAoKY29uc3QgZW5jb2RpbmcxMyA9IGV4dGVybmFsMC5PcGxvZ01lc3NhZ2VWMQoKLy8gQGF1dG9iYXNlL29wbG9nLW1lc3NhZ2UtdjIuY2hlY2twb2ludApjb25zdCBlbmNvZGluZzE0XzEgPSBjLmZyYW1lKGVuY29kaW5nOCkKLy8gQGF1dG9iYXNlL29wbG9nLW1lc3NhZ2UtdjIuZGlnZXN0CmNvbnN0IGVuY29kaW5nMTRfMiA9IGMuZnJhbWUoZW5jb2Rpbmc5KQovLyBAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZS12Mi50cmFjZQpjb25zdCBlbmNvZGluZzE0XzQgPSBjLmZyYW1lKGVuY29kaW5nMTEpCgovLyBAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZS12Mgpjb25zdCBlbmNvZGluZzE0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgZW5jb2RpbmcxMC5wcmVlbmNvZGUoc3RhdGUsIG0ubm9kZSkKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDggc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0uY2hlY2twb2ludCkgZW5jb2RpbmcxNF8xLnByZWVuY29kZShzdGF0ZSwgbS5jaGVja3BvaW50KQogICAgaWYgKG0uZGlnZXN0KSBlbmNvZGluZzE0XzIucHJlZW5jb2RlKHN0YXRlLCBtLmRpZ2VzdCkKICAgIGlmIChtLnRyYWNlKSBlbmNvZGluZzE0XzQucHJlZW5jb2RlKHN0YXRlLCBtLnRyYWNlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9CiAgICAgIChtLmNoZWNrcG9pbnQgPyAxIDogMCkgfCAobS5kaWdlc3QgPyAyIDogMCkgfCAobS5vcHRpbWlzdGljID8gNCA6IDApIHwgKG0udHJhY2UgPyA4IDogMCkKCiAgICBlbmNvZGluZzEwLmVuY29kZShzdGF0ZSwgbS5ub2RlKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0uY2hlY2twb2ludCkgZW5jb2RpbmcxNF8xLmVuY29kZShzdGF0ZSwgbS5jaGVja3BvaW50KQogICAgaWYgKG0uZGlnZXN0KSBlbmNvZGluZzE0XzIuZW5jb2RlKHN0YXRlLCBtLmRpZ2VzdCkKICAgIGlmIChtLnRyYWNlKSBlbmNvZGluZzE0XzQuZW5jb2RlKHN0YXRlLCBtLnRyYWNlKQogIH0sCiAgZGVjb2RlKHN0YXRlLCB2ZXJzaW9uKSB7CiAgICBpZiAodmVyc2lvbiA9PT0gdW5kZWZpbmVkKSB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIwID0gZW5jb2RpbmcxMC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbiwKICAgICAgbm9kZTogcjAsCiAgICAgIGNoZWNrcG9pbnQ6IChmbGFncyAmIDEpICE9PSAwID8gZW5jb2RpbmcxNF8xLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBkaWdlc3Q6IChmbGFncyAmIDIpICE9PSAwID8gZW5jb2RpbmcxNF8yLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBvcHRpbWlzdGljOiAoZmxhZ3MgJiA0KSAhPT0gMCwKICAgICAgdHJhY2U6IChmbGFncyAmIDgpICE9PSAwID8gZW5jb2RpbmcxNF80LmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZQpjb25zdCBlbmNvZGluZzE1ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgc3dpdGNoIChtLnZlcnNpb24pIHsKICAgICAgY2FzZSAwOgogICAgICAgIGVuY29kaW5nMTIucHJlZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgMToKICAgICAgICBlbmNvZGluZzEzLnByZWVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBjYXNlIDI6CiAgICAgICAgZW5jb2RpbmcxNC5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb24nKQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBzd2l0Y2ggKG0udmVyc2lvbikgewogICAgICBjYXNlIDA6CiAgICAgICAgZW5jb2RpbmcxMi5lbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAxOgogICAgICAgIGVuY29kaW5nMTMuZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgMjoKICAgICAgICBlbmNvZGluZzE0LmVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbicpCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgc3dpdGNoICh2ZXJzaW9uKSB7CiAgICAgIGNhc2UgMDogewogICAgICAgIGNvbnN0IGRlY29kZWQgPSBlbmNvZGluZzEyLmRlY29kZShzdGF0ZSwgdmVyc2lvbikKICAgICAgICByZXR1cm4gZGVjb2RlZAogICAgICB9CiAgICAgIGNhc2UgMTogewogICAgICAgIGNvbnN0IGRlY29kZWQgPSBlbmNvZGluZzEzLmRlY29kZShzdGF0ZSwgdmVyc2lvbikKICAgICAgICByZXR1cm4gZGVjb2RlZAogICAgICB9CiAgICAgIGNhc2UgMjogewogICAgICAgIGNvbnN0IGRlY29kZWQgPSBlbmNvZGluZzE0LmRlY29kZShzdGF0ZSwgdmVyc2lvbikKICAgICAgICByZXR1cm4gZGVjb2RlZAogICAgICB9CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uJykKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9pbmZvLXYxLnBlbmRpbmdJbmRleGVycwpjb25zdCBlbmNvZGluZzE2XzEgPSBjLmFycmF5KGMuZml4ZWQzMikKCi8vIEBhdXRvYmFzZS9pbmZvLXYxCmNvbnN0IGVuY29kaW5nMTYgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLm1lbWJlcnMpCiAgICBlbmNvZGluZzE2XzEucHJlZW5jb2RlKHN0YXRlLCBtLnBlbmRpbmdJbmRleGVycykKICAgIGVuY29kaW5nMS5wcmVlbmNvZGUoc3RhdGUsIG0uaW5kZXhlcnMpCiAgICBlbmNvZGluZzEucHJlZW5jb2RlKHN0YXRlLCBtLmhlYWRzKQogICAgZW5jb2RpbmcxLnByZWVuY29kZShzdGF0ZSwgbS52aWV3cykKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5tZW1iZXJzKQogICAgZW5jb2RpbmcxNl8xLmVuY29kZShzdGF0ZSwgbS5wZW5kaW5nSW5kZXhlcnMpCiAgICBlbmNvZGluZzEuZW5jb2RlKHN0YXRlLCBtLmluZGV4ZXJzKQogICAgZW5jb2RpbmcxLmVuY29kZShzdGF0ZSwgbS5oZWFkcykKICAgIGVuY29kaW5nMS5lbmNvZGUoc3RhdGUsIG0udmlld3MpCiAgfSwKICBkZWNvZGUoc3RhdGUsIHZlcnNpb24pIHsKICAgIGlmICh2ZXJzaW9uID09PSB1bmRlZmluZWQpIHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBlbmNvZGluZzE2XzEuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjIgPSBlbmNvZGluZzEuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjMgPSBlbmNvZGluZzEuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjQgPSBlbmNvZGluZzEuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb24sCiAgICAgIG1lbWJlcnM6IHIwLAogICAgICBwZW5kaW5nSW5kZXhlcnM6IHIxLAogICAgICBpbmRleGVyczogcjIsCiAgICAgIGhlYWRzOiByMywKICAgICAgdmlld3M6IHI0CiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvaW5mby12Mi5wZW5kaW5nSW5kZXhlcnMKY29uc3QgZW5jb2RpbmcxN18xID0gZW5jb2RpbmcxNl8xCgovLyBAYXV0b2Jhc2UvaW5mby12Mgpjb25zdCBlbmNvZGluZzE3ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5tZW1iZXJzKQogICAgZW5jb2RpbmcxN18xLnByZWVuY29kZShzdGF0ZSwgbS5wZW5kaW5nSW5kZXhlcnMpCiAgICBlbmNvZGluZzEucHJlZW5jb2RlKHN0YXRlLCBtLmluZGV4ZXJzKQogICAgZW5jb2RpbmcxLnByZWVuY29kZShzdGF0ZSwgbS5oZWFkcykKICAgIGVuY29kaW5nMS5wcmVlbmNvZGUoc3RhdGUsIG0udmlld3MpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmVuY3J5cHRpb25MZW5ndGgpCiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAxIHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLmVudHJvcHkpIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0uZW50cm9weSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSBtLmVudHJvcHkgPyAxIDogMAoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubWVtYmVycykKICAgIGVuY29kaW5nMTdfMS5lbmNvZGUoc3RhdGUsIG0ucGVuZGluZ0luZGV4ZXJzKQogICAgZW5jb2RpbmcxLmVuY29kZShzdGF0ZSwgbS5pbmRleGVycykKICAgIGVuY29kaW5nMS5lbmNvZGUoc3RhdGUsIG0uaGVhZHMpCiAgICBlbmNvZGluZzEuZW5jb2RlKHN0YXRlLCBtLnZpZXdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5lbmNyeXB0aW9uTGVuZ3RoKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0uZW50cm9weSkgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5lbnRyb3B5KQogIH0sCiAgZGVjb2RlKHN0YXRlLCB2ZXJzaW9uKSB7CiAgICBpZiAodmVyc2lvbiA9PT0gdW5kZWZpbmVkKSB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gZW5jb2RpbmcxN18xLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIyID0gZW5jb2RpbmcxLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIzID0gZW5jb2RpbmcxLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHI0ID0gZW5jb2RpbmcxLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHI1ID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICBtZW1iZXJzOiByMCwKICAgICAgcGVuZGluZ0luZGV4ZXJzOiByMSwKICAgICAgaW5kZXhlcnM6IHIyLAogICAgICBoZWFkczogcjMsCiAgICAgIHZpZXdzOiByNCwKICAgICAgZW5jcnlwdGlvbkxlbmd0aDogcjUsCiAgICAgIGVudHJvcHk6IChmbGFncyAmIDEpICE9PSAwID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvaW5mbwpjb25zdCBlbmNvZGluZzE4ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgc3dpdGNoIChtLnZlcnNpb24pIHsKICAgICAgY2FzZSAwOgogICAgICBjYXNlIDE6CiAgICAgICAgZW5jb2RpbmcxNi5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAyOgogICAgICAgIGVuY29kaW5nMTcucHJlZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uJykKICAgIH0KICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgc3dpdGNoIChtLnZlcnNpb24pIHsKICAgICAgY2FzZSAwOgogICAgICBjYXNlIDE6CiAgICAgICAgZW5jb2RpbmcxNi5lbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAyOgogICAgICAgIGVuY29kaW5nMTcuZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uJykKICAgIH0KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBzd2l0Y2ggKHZlcnNpb24pIHsKICAgICAgY2FzZSAwOgogICAgICBjYXNlIDE6IHsKICAgICAgICBjb25zdCBkZWNvZGVkID0gZW5jb2RpbmcxNi5kZWNvZGUoc3RhdGUsIHZlcnNpb24pCiAgICAgICAgY29uc3QgbWFwID0gZXh0ZXJuYWwwLmluZm9MZWdhY3lNYXAKICAgICAgICByZXR1cm4gbWFwKGRlY29kZWQpCiAgICAgIH0KICAgICAgY2FzZSAyOiB7CiAgICAgICAgY29uc3QgZGVjb2RlZCA9IGVuY29kaW5nMTcuZGVjb2RlKHN0YXRlLCB2ZXJzaW9uKQogICAgICAgIHJldHVybiBkZWNvZGVkCiAgICAgIH0KICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb24nKQogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL21lbWJlcgpjb25zdCBlbmNvZGluZzE5ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMiBzbyBhbHdheXMgb25lIGJ5dGUKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLmlzSW5kZXhlciA/IDEgOiAwKSB8IChtLmlzUmVtb3ZlZCA/IDIgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBpc0luZGV4ZXI6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBpc1JlbW92ZWQ6IChmbGFncyAmIDIpICE9PSAwLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBlbmNvZGluZzIwID0gZXh0ZXJuYWwwLkxpbmVhcml6ZXJLZXkKCi8vIEBhdXRvYmFzZS9saW5lYXJpemVyLXVwZGF0ZQpjb25zdCBlbmNvZGluZzIxID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uYmF0Y2gpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN5c3RlbUxlbmd0aCkKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDEgc28gYWx3YXlzIG9uZSBieXRlCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gbS5pbmRleGVycyA/IDEgOiAwCgogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uYmF0Y2gpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN5c3RlbUxlbmd0aCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAga2V5OiByMCwKICAgICAgbGVuZ3RoOiByMSwKICAgICAgYmF0Y2g6IHIyLAogICAgICBzeXN0ZW1MZW5ndGg6IHIzLAogICAgICBpbmRleGVyczogKGZsYWdzICYgMSkgIT09IDAKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9lbmNyeXB0aW9uLWRlc2NyaXB0b3IKY29uc3QgZW5jb2RpbmcyMiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udHlwZSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS5wYXlsb2FkKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnR5cGUpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0ucGF5bG9hZCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdHlwZTogcjAsCiAgICAgIHBheWxvYWQ6IHIxCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvbWFuaWZlc3QtZGF0YQpjb25zdCBlbmNvZGluZzIzID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMiBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5sZWdhY3lCbG9ja3MpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVnYWN5QmxvY2tzKQogICAgaWYgKG0ubmFtZXNwYWNlKSBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSAobS5sZWdhY3lCbG9ja3MgPyAxIDogMCkgfCAobS5uYW1lc3BhY2UgPyAyIDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5sZWdhY3lCbG9ja3MpIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVnYWN5QmxvY2tzKQogICAgaWYgKG0ubmFtZXNwYWNlKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IHIwLAogICAgICBsZWdhY3lCbG9ja3M6IChmbGFncyAmIDEpICE9PSAwID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwLAogICAgICBuYW1lc3BhY2U6IChmbGFncyAmIDIpICE9PSAwID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvdXNlci12aWV3LXRyYWNlLmJsb2Nrcwpjb25zdCBlbmNvZGluZzI0XzEgPSBlbmNvZGluZzExXzAKCi8vIEBhdXRvYmFzZS91c2VyLXZpZXctdHJhY2UKY29uc3QgZW5jb2RpbmcyNCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udmlldykKICAgIGVuY29kaW5nMjRfMS5wcmVlbmNvZGUoc3RhdGUsIG0uYmxvY2tzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnZpZXcpCiAgICBlbmNvZGluZzI0XzEuZW5jb2RlKHN0YXRlLCBtLmJsb2NrcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBlbmNvZGluZzI0XzEuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZpZXc6IHIwLAogICAgICBibG9ja3M6IHIxCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvdHJhY2UudXNlciwgZGVmZXJyZWQgZHVlIHRvIHJlY3VzaXZlIHVzZQpjb25zdCBlbmNvZGluZzExXzIgPSBjLmFycmF5KGVuY29kaW5nMjQpCgpmdW5jdGlvbiBzZXRWZXJzaW9uKHYpIHsKICB2ZXJzaW9uID0gdgp9CgpmdW5jdGlvbiBlbmNvZGUobmFtZSwgdmFsdWUsIHYgPSBWRVJTSU9OKSB7CiAgdmVyc2lvbiA9IHYKICByZXR1cm4gYy5lbmNvZGUoZ2V0RW5jb2RpbmcobmFtZSksIHZhbHVlKQp9CgpmdW5jdGlvbiBkZWNvZGUobmFtZSwgYnVmZmVyLCB2ID0gVkVSU0lPTikgewogIHZlcnNpb24gPSB2CiAgcmV0dXJuIGMuZGVjb2RlKGdldEVuY29kaW5nKG5hbWUpLCBidWZmZXIpCn0KCmZ1bmN0aW9uIGdldEVudW0obmFtZSkgewogIHN3aXRjaCAobmFtZSkgewogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbnVtIG5vdCBmb3VuZCAnICsgbmFtZSkKICB9Cn0KCmZ1bmN0aW9uIGdldEVuY29kaW5nKG5hbWUpIHsKICBzd2l0Y2ggKG5hbWUpIHsKICAgIGNhc2UgJ0BhdXRvYmFzZS9jaGVja291dCc6CiAgICAgIHJldHVybiBlbmNvZGluZzAKICAgIGNhc2UgJ0BhdXRvYmFzZS9jbG9jayc6CiAgICAgIHJldHVybiBlbmNvZGluZzEKICAgIGNhc2UgJ0BhdXRvYmFzZS9pbmRleC1jaGVja3BvaW50JzoKICAgICAgcmV0dXJuIGVuY29kaW5nMgogICAgY2FzZSAnQGF1dG9iYXNlL3dha2V1cCc6CiAgICAgIHJldHVybiBlbmNvZGluZzMKICAgIGNhc2UgJ0BhdXRvYmFzZS9ib290LXJlY29yZC12MCc6CiAgICAgIHJldHVybiBlbmNvZGluZzQKICAgIGNhc2UgJ0BhdXRvYmFzZS9ib290LXJlY29yZC1yYXcnOgogICAgICByZXR1cm4gZW5jb2Rpbmc1CiAgICBjYXNlICdAYXV0b2Jhc2UvYm9vdC1yZWNvcmQnOgogICAgICByZXR1cm4gZW5jb2Rpbmc2CiAgICBjYXNlICdAYXV0b2Jhc2UvY2hlY2twb2ludGVyJzoKICAgICAgcmV0dXJuIGVuY29kaW5nNwogICAgY2FzZSAnQGF1dG9iYXNlL2NoZWNrcG9pbnQnOgogICAgICByZXR1cm4gZW5jb2Rpbmc4CiAgICBjYXNlICdAYXV0b2Jhc2UvZGlnZXN0JzoKICAgICAgcmV0dXJuIGVuY29kaW5nOQogICAgY2FzZSAnQGF1dG9iYXNlL25vZGUnOgogICAgICByZXR1cm4gZW5jb2RpbmcxMAogICAgY2FzZSAnQGF1dG9iYXNlL3RyYWNlJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTEKICAgIGNhc2UgJ0BhdXRvYmFzZS9vcGxvZy1tZXNzYWdlLXYwJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTIKICAgIGNhc2UgJ0BhdXRvYmFzZS9vcGxvZy1tZXNzYWdlLXYxJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTMKICAgIGNhc2UgJ0BhdXRvYmFzZS9vcGxvZy1tZXNzYWdlLXYyJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTQKICAgIGNhc2UgJ0BhdXRvYmFzZS9vcGxvZy1tZXNzYWdlJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTUKICAgIGNhc2UgJ0BhdXRvYmFzZS9pbmZvLXYxJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTYKICAgIGNhc2UgJ0BhdXRvYmFzZS9pbmZvLXYyJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTcKICAgIGNhc2UgJ0BhdXRvYmFzZS9pbmZvJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTgKICAgIGNhc2UgJ0BhdXRvYmFzZS9tZW1iZXInOgogICAgICByZXR1cm4gZW5jb2RpbmcxOQogICAgY2FzZSAnQGF1dG9iYXNlL2xpbmVhcml6ZXIta2V5JzoKICAgICAgcmV0dXJuIGVuY29kaW5nMjAKICAgIGNhc2UgJ0BhdXRvYmFzZS9saW5lYXJpemVyLXVwZGF0ZSc6CiAgICAgIHJldHVybiBlbmNvZGluZzIxCiAgICBjYXNlICdAYXV0b2Jhc2UvZW5jcnlwdGlvbi1kZXNjcmlwdG9yJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMjIKICAgIGNhc2UgJ0BhdXRvYmFzZS9tYW5pZmVzdC1kYXRhJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMjMKICAgIGNhc2UgJ0BhdXRvYmFzZS91c2VyLXZpZXctdHJhY2UnOgogICAgICByZXR1cm4gZW5jb2RpbmcyNAogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbmNvZGVyIG5vdCBmb3VuZCAnICsgbmFtZSkKICB9Cn0KCmZ1bmN0aW9uIGdldFN0cnVjdChuYW1lLCB2ID0gVkVSU0lPTikgewogIGNvbnN0IGVuYyA9IGdldEVuY29kaW5nKG5hbWUpCiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgICB2ZXJzaW9uID0gdgogICAgICBlbmMucHJlZW5jb2RlKHN0YXRlLCBtKQogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgbSkgewogICAgICB2ZXJzaW9uID0gdgogICAgICBlbmMuZW5jb2RlKHN0YXRlLCBtKQogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICB2ZXJzaW9uID0gdgogICAgICByZXR1cm4gZW5jLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlc29sdmVTdHJ1Y3QgPSBnZXRTdHJ1Y3QgLy8gY29tcGF0Cgptb2R1bGUuZXhwb3J0cyA9IHsKICByZXNvbHZlU3RydWN0LAogIGdldFN0cnVjdCwKICBnZXRFbnVtLAogIGdldEVuY29kaW5nLAogIGVuY29kZSwKICBkZWNvZGUsCiAgc2V0VmVyc2lvbiwKICB2ZXJzaW9uCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKY29uc3QgZGVib3VuY2VpZnkgPSByZXF1aXJlKCdkZWJvdW5jZWlmeScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCBoeXBlcmNvcmVJZCA9IHJlcXVpcmUoJ2h5cGVyY29yZS1pZC1lbmNvZGluZycpCmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ25hbm9hc3NlcnQnKQpjb25zdCBTaWduYWxQcm9taXNlID0gcmVxdWlyZSgnc2lnbmFsLXByb21pc2UnKQpjb25zdCBDb3JlQ291cGxlciA9IHJlcXVpcmUoJ2NvcmUtY291cGxlcicpCmNvbnN0IFByb3RvbXV4V2FrZXVwID0gcmVxdWlyZSgncHJvdG9tdXgtd2FrZXVwJykKY29uc3QgcnJwID0gcmVxdWlyZSgncmVzb2x2ZS1yZWplY3QtcHJvbWlzZScpCmNvbnN0IEh5cGVyY29yZSA9IHJlcXVpcmUoJ2h5cGVyY29yZScpCmNvbnN0IFNjb3BlTG9jayA9IHJlcXVpcmUoJ3Njb3BlLWxvY2snKQoKY29uc3QgTG9jYWxTdGF0ZSA9IHJlcXVpcmUoJy4vbGliL2xvY2FsLXN0YXRlLmpzJykKY29uc3QgTGluZWFyaXplciA9IHJlcXVpcmUoJy4vbGliL2xpbmVhcml6ZXIuanMnKQpjb25zdCBTeXN0ZW1WaWV3ID0gcmVxdWlyZSgnLi9saWIvc3lzdGVtLmpzJykKY29uc3QgeyBFbmNyeXB0aW9uVmlldyB9ID0gcmVxdWlyZSgnLi9saWIvZW5jcnlwdGlvbi5qcycpCmNvbnN0IFVwZGF0ZUNoYW5nZXMgPSByZXF1aXJlKCcuL2xpYi91cGRhdGVzLmpzJykKY29uc3QgbWVzc2FnZXMgPSByZXF1aXJlKCcuL2xpYi9tZXNzYWdlcy5qcycpCmNvbnN0IFRpbWVyID0gcmVxdWlyZSgnLi9saWIvdGltZXIuanMnKQpjb25zdCBXcml0ZXIgPSByZXF1aXJlKCcuL2xpYi93cml0ZXIuanMnKQpjb25zdCB7IGVuY29kZVZhbHVlLCBkZWNvZGVWYWx1ZSB9ID0gcmVxdWlyZSgnLi9saWIvdmFsdWVzLmpzJykKY29uc3QgQWN0aXZlV3JpdGVycyA9IHJlcXVpcmUoJy4vbGliL2FjdGl2ZS13cml0ZXJzLmpzJykKY29uc3QgQXV0b1dha2V1cCA9IHJlcXVpcmUoJy4vbGliL3dha2V1cC5qcycpCgpjb25zdCBGYXN0Rm9yd2FyZCA9IHJlcXVpcmUoJy4vbGliL2Zhc3QtZm9yd2FyZC5qcycpCmNvbnN0IEF1dG9TdG9yZSA9IHJlcXVpcmUoJy4vbGliL3N0b3JlLmpzJykKY29uc3QgQXBwbHlTdGF0ZSA9IHJlcXVpcmUoJy4vbGliL2FwcGx5LXN0YXRlLmpzJykKY29uc3QgQXBwZW5kQmF0Y2ggPSByZXF1aXJlKCcuL2xpYi9hcHBlbmQtYmF0Y2guanMnKQpjb25zdCB7IFB1YmxpY0FwcGx5Q2FsbHMgfSA9IHJlcXVpcmUoJy4vbGliL2FwcGx5LWNhbGxzLmpzJykKY29uc3QgYm9vdCA9IHJlcXVpcmUoJy4vbGliL2Jvb3QuanMnKQpjb25zdCB7IE1BWF9BVVRPQkFTRV9WRVJTSU9OLCBCT09UX1JFQ09SRF9WRVJTSU9OIH0gPSByZXF1aXJlKCcuL2xpYi9jYXBzLmpzJykKCmNvbnN0IGluc3BlY3QgPSBTeW1ib2wuZm9yKCdub2RlanMudXRpbC5pbnNwZWN0LmN1c3RvbScpCmNvbnN0IElOVEVSUlVQVCA9IG5ldyBFcnJvcignQXBwbHkgaW50ZXJydXB0ZWQnKQpjb25zdCBCSU5BUllfRU5DT0RJTkcgPSBjLmZyb20oJ2JpbmFyeScpCgpjb25zdCBSRUNPVkVSSUVTID0gMwoKLy8gZGVmYXVsdCBpcyB0byBhdXRvbWF0aWNhbGx5IGFjawpjb25zdCBERUZBVUxUX0FDS19JTlRFUlZBTCA9IDEwXzAwMApjb25zdCBERUZBVUxUX0FDS19USFJFU0hPTEQgPSA0Cgpjb25zdCBSRU1PVEVfQUREX0JBVENIID0gNjQKY29uc3QgUkVNT1RFX0FERF9CQVRDSF9TQU5JVFkgPSA0MDk2CmNvbnN0IE1JTl9GRl9XQUlUID0gMzAwXzAwMCAvLyB3YWl0IGF0IGxlYXN0IDVtaW4gYmVmb3JlIGF0dGVtcHRpbmcgdG8gZmYgYWdhaW4gYWZ0ZXIgZmFpbHVyZQoKY2xhc3MgV2FrZXVwSGFuZGxlciB7CiAgY29uc3RydWN0b3IoYmFzZSwgZGlzY292ZXJ5S2V5KSB7CiAgICB0aGlzLmFjdGl2ZSA9IHRydWUKICAgIHRoaXMuZGlzY292ZXJ5S2V5ID0gZGlzY292ZXJ5S2V5CiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgfQoKICBvbnBlZXJhY3RpdmUocGVlciwgc2Vzc2lvbikgewogICAgdGhpcy5iYXNlLl9idW1wV2FrZXVwUGVlcihwZWVyKQogIH0KCiAgb25sb29rdXAocmVxLCBwZWVyLCBzZXNzaW9uKSB7CiAgICBjb25zdCB3YWtldXAgPSB0aGlzLmJhc2UuX2dldFdha2V1cCgpCiAgICBpZiAod2FrZXVwLmxlbmd0aCA9PT0gMCkgcmV0dXJuCiAgICBzZXNzaW9uLmFubm91bmNlKHBlZXIsIHdha2V1cCkKICB9CgogIG9uYW5ub3VuY2Uod2FrZXVwLCBwZWVyLCBzZXNzaW9uKSB7CiAgICBpZiAodGhpcy5iYXNlLmlzRmFzdEZvcndhcmRpbmcoKSkgewogICAgICB0aGlzLmJhc2UuX25lZWRzV2FrZXVwUmVxdWVzdCA9IHRydWUKICAgICAgcmV0dXJuCiAgICB9CiAgICB0aGlzLmJhc2UuaGludFdha2V1cCh3YWtldXApCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEF1dG9iYXNlIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3Ioc3RvcmUsIGJvb3RzdHJhcCwgaGFuZGxlcnMgPSB7fSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkoYm9vdHN0cmFwKSkgYm9vdHN0cmFwID0gYm9vdHN0cmFwWzBdIC8vIFRPRE86IGp1c3QgYSBxdWljayBjb21wYXQsIGxldHMgcmVtb3ZlIHNvb24KCiAgICBpZiAoYm9vdHN0cmFwICYmIHR5cGVvZiBib290c3RyYXAgIT09ICdzdHJpbmcnICYmICFiNGEuaXNCdWZmZXIoYm9vdHN0cmFwKSkgewogICAgICBoYW5kbGVycyA9IGJvb3RzdHJhcAogICAgICBib290c3RyYXAgPSBudWxsCiAgICB9CgogICAgc3VwZXIoKQoKICAgIGNvbnN0IGtleSA9IGJvb3RzdHJhcCA/IHRvS2V5KGJvb3RzdHJhcCkgOiBudWxsCgogICAgdGhpcy5pZCA9IG51bGwKICAgIHRoaXMua2V5ID0ga2V5CiAgICB0aGlzLmRpc2NvdmVyeUtleSA9IG51bGwKICAgIHRoaXMuYmFja29mZiA9IGhhbmRsZXJzLmJhY2tvZmYgfHwgbnVsbAoKICAgIHRoaXMua2V5UGFpciA9IG51bGwKICAgIHRoaXMudmFsdWVFbmNvZGluZyA9IGMuZnJvbShoYW5kbGVycy52YWx1ZUVuY29kaW5nIHx8ICdiaW5hcnknKQogICAgdGhpcy5zdG9yZSA9IHN0b3JlCiAgICB0aGlzLmdsb2JhbENhY2hlID0gc3RvcmUuZ2xvYmFsQ2FjaGUgfHwgbnVsbAogICAgdGhpcy5taWdyYXRlZCA9IGZhbHNlCgogICAgdGhpcy5lbmNyeXB0ZWQgPSBoYW5kbGVycy5lbmNyeXB0ZWQgfHwgISFoYW5kbGVycy5lbmNyeXB0aW9uS2V5CiAgICB0aGlzLmVuY3J5cHQgPSAhIWhhbmRsZXJzLmVuY3J5cHQKICAgIHRoaXMuZW5jcnlwdGlvbktleSA9IG51bGwKICAgIHRoaXMuZW5jcnlwdGlvbiA9IG51bGwKCiAgICB0aGlzLmFjdGl2ZUJhdGNoID0gbnVsbCAvLyBtYWludGFpbmVkIGJ5IHRoZSBhcHBlbmQtYmF0Y2gKCiAgICB0aGlzLmxvY2FsID0gbnVsbAogICAgdGhpcy5sb2NhbFdyaXRlciA9IG51bGwKICAgIHRoaXMuaXNJbmRleGVyID0gZmFsc2UKCiAgICB0aGlzLmFjdGl2ZVdyaXRlcnMgPSBuZXcgQWN0aXZlV3JpdGVycygpCiAgICB0aGlzLmxpbmVhcml6ZXIgPSBudWxsCiAgICB0aGlzLnVwZGF0aW5nID0gZmFsc2UKCiAgICB0aGlzLm51a2VUaXAgPSAhIWhhbmRsZXJzLm51a2VUaXAKCiAgICB0aGlzLndha2V1cE93bmVyID0gIWhhbmRsZXJzLndha2V1cAogICAgdGhpcy53YWtldXBDYXBhYmlsaXR5ID0gbnVsbAogICAgdGhpcy53YWtldXBQcm90b2NvbCA9IGhhbmRsZXJzLndha2V1cCB8fCBuZXcgUHJvdG9tdXhXYWtldXAoKQogICAgdGhpcy53YWtldXBTZXNzaW9uID0gbnVsbAoKICAgIHRoaXMuX3ByaW1hcnlCb290c3RyYXAgPSBudWxsCgogICAgdGhpcy5mYXN0Rm9yd2FyZEVuYWJsZWQgPSBoYW5kbGVycy5mYXN0Rm9yd2FyZCAhPT0gZmFsc2UKICAgIHRoaXMuZmFzdEZvcndhcmRpbmcgPSBudWxsCiAgICB0aGlzLmZhc3RGb3J3YXJkVG8gPSBudWxsCiAgICB0aGlzLmZhc3RGb3J3YXJkRmFpbGVkQXQgPSAwCiAgICB0aGlzLmZhc3RGb3J3YXJkTWluaW11bSA9IEZhc3RGb3J3YXJkLk1JTklNVU0KCiAgICB0aGlzLmJpZ0JhdGNoZXMgPSAhIWhhbmRsZXJzLmJpZ0JhdGNoZXMKCiAgICB0aGlzLl9ib290c3RyYXBXcml0ZXJzID0gW10gLy8gbWlnaHQgY29udGFpbiBkdXBzLCBidXQgdGhhdHMgb2sKICAgIHRoaXMuX2Jvb3RzdHJhcFdyaXRlcnNDaGFuZ2VkID0gZmFsc2UKCiAgICB0aGlzLl9mbHVzaFNpZ25hbCA9IG5ldyBTaWduYWxQcm9taXNlKCkKICAgIHRoaXMuX2ZsdXNoaW5nID0gMAoKICAgIHRoaXMuX2NoZWNrV3JpdGVycyA9IFtdCiAgICB0aGlzLl9vcHRpbWlzdGljID0gLTEKICAgIHRoaXMuX2FwcGVuZGVkID0gMAogICAgdGhpcy5fYXBwZW5kaW5nID0gbnVsbAogICAgdGhpcy5fd2FrZXVwID0gbmV3IEF1dG9XYWtldXAodGhpcykKICAgIHRoaXMuX3dha2V1cEhpbnRzID0gbmV3IE1hcCgpCiAgICB0aGlzLl93YWtldXBQZWVyQm91bmQgPSB0aGlzLl93YWtldXBQZWVyLmJpbmQodGhpcykKICAgIHRoaXMuX2NvdXBsZXIgPSBudWxsCgogICAgdGhpcy5fdXBkYXRlTG9jYWxDb3JlID0gbnVsbAogICAgdGhpcy5fbG9jayA9IG5ldyBTY29wZUxvY2soKQoKICAgIHRoaXMuX25lZWRzV2FrZXVwUmVxdWVzdCA9IGZhbHNlCiAgICB0aGlzLl9uZWVkc1dha2V1cCA9IHRydWUKICAgIHRoaXMuX25lZWRzV2FrZXVwSGVhZHMgPSB0cnVlCgogICAgdGhpcy5fdXBkYXRlcyA9IFtdCiAgICB0aGlzLl9oYW5kbGVycyA9IGhhbmRsZXJzIHx8IHt9CiAgICB0aGlzLl93YXJuID0gZW1pdFdhcm5pbmcuYmluZCh0aGlzKQogICAgdGhpcy5fbGFzdEVycm9yID0gbnVsbAoKICAgIHRoaXMuX2RyYWluaW5nID0gZmFsc2UKICAgIHRoaXMuX3dyaXRhYmxlID0gbnVsbAogICAgdGhpcy5fYWR2YW5jaW5nID0gbnVsbAogICAgdGhpcy5faW50ZXJydXB0aW5nID0gZmFsc2UKICAgIHRoaXMuX2NhdWdodHVwID0gZmFsc2UKCiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlCgogICAgdGhpcy5fYnVtcCA9IGRlYm91bmNlaWZ5KCgpID0+IHsKICAgICAgdGhpcy5fYWR2YW5jaW5nID0gdGhpcy5fYWR2YW5jZSgpCiAgICAgIHJldHVybiB0aGlzLl9hZHZhbmNpbmcKICAgIH0pCgogICAgdGhpcy5fb25yZW1vdGV3cml0ZXJjaGFuZ2VCb3VuZCA9IHRoaXMuX29ucmVtb3Rld3JpdGVyY2hhbmdlLmJpbmQodGhpcykKICAgIHRoaXMuX29ubG9jYWx3cml0ZXJjaGFuZ2VCb3VuZCA9IHRoaXMuX29ubG9jYWx3cml0ZXJjaGFuZ2UuYmluZCh0aGlzKQoKICAgIHRoaXMuX3ByZW9wZW4gPSBudWxsCgogICAgdGhpcy5faGFzT3BlbiA9ICEhdGhpcy5faGFuZGxlcnMub3BlbgogICAgdGhpcy5faGFzQXBwbHkgPSAhIXRoaXMuX2hhbmRsZXJzLmFwcGx5CiAgICB0aGlzLl9oYXNPcHRpbWlzdGljQXBwbHkgPSAhIXRoaXMuX2hhbmRsZXJzLm9wdGltaXN0aWMKICAgIHRoaXMuX2hhc1VwZGF0ZSA9ICEhdGhpcy5faGFuZGxlcnMudXBkYXRlCiAgICB0aGlzLl9oYXNDbG9zZSA9ICEhdGhpcy5faGFuZGxlcnMuY2xvc2UKCiAgICB0aGlzLl92aWV3U3RvcmUgPSBuZXcgQXV0b1N0b3JlKHRoaXMpCiAgICB0aGlzLl9hcHBseVN0YXRlID0gbnVsbAoKICAgIHRoaXMudmlldyA9IG51bGwKICAgIHRoaXMuY29yZSA9IG51bGwKICAgIHRoaXMudmVyc2lvbiA9IC0xCiAgICB0aGlzLmludGVycnVwdGVkID0gbnVsbAogICAgdGhpcy5yZWNvdmVyaWVzID0gUkVDT1ZFUklFUwoKICAgIGNvbnN0IHsgYWNrSW50ZXJ2YWwgPSBERUZBVUxUX0FDS19JTlRFUlZBTCwgYWNrVGhyZXNob2xkID0gREVGQVVMVF9BQ0tfVEhSRVNIT0xEIH0gPSBoYW5kbGVycwoKICAgIHRoaXMuX2Fja0ludGVydmFsID0gYWNrSW50ZXJ2YWwKICAgIHRoaXMuX2Fja1RocmVzaG9sZCA9IGFja1RocmVzaG9sZAogICAgdGhpcy5fYWNrVGlja1RocmVzaG9sZCA9IGFja1RocmVzaG9sZAogICAgdGhpcy5fYWNrVGljayA9IDAKCiAgICB0aGlzLl9hY2tUaW1lciA9IG51bGwKICAgIHRoaXMuX2Fja2luZyA9IGZhbHNlCgogICAgdGhpcy5fd2FpdGluZyA9IG5ldyBTaWduYWxQcm9taXNlKCkKCiAgICB0aGlzLnZpZXcgPSB0aGlzLl9oYXNPcGVuCiAgICAgID8gdGhpcy5faGFuZGxlcnMub3Blbih0aGlzLl92aWV3U3RvcmUsIG5ldyBQdWJsaWNBcHBseUNhbGxzKHRoaXMpKQogICAgICA6IG51bGwKICAgIHRoaXMuY29yZSA9IHRoaXMuX3ZpZXdTdG9yZS5nZXQoeyBuYW1lOiAnX3N5c3RlbScgfSkKCiAgICBpZiAodGhpcy5mYXN0Rm9yd2FyZEVuYWJsZWQgJiYgaXNPYmplY3QoaGFuZGxlcnMuZmFzdEZvcndhcmQpKSB7CiAgICAgIHRoaXMuX3J1bkZhc3RGb3J3YXJkKAogICAgICAgIG5ldyBGYXN0Rm9yd2FyZCh0aGlzLCBoYW5kbGVycy5mYXN0Rm9yd2FyZC5rZXksIHsgdmVyaWZpZWQ6IGZhbHNlIH0pCiAgICAgICkuY2F0Y2gobm9vcCkKICAgIH0KCiAgICB0aGlzLnJlYWR5KCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgfQoKICBbaW5zcGVjdF0oZGVwdGgsIG9wdHMpIHsKICAgIGxldCBpbmRlbnQgPSAnJwogICAgaWYgKHR5cGVvZiBvcHRzLmluZGVudGF0aW9uTHZsID09PSAnbnVtYmVyJykgewogICAgICB3aGlsZSAoaW5kZW50Lmxlbmd0aCA8IG9wdHMuaW5kZW50YXRpb25MdmwpIGluZGVudCArPSAnICcKICAgIH0KCiAgICByZXR1cm4gaW5kZW50ICsgJ0F1dG9iYXNlIHsgLi4uIH0nCiAgfQoKICAvLyBqdXN0IGNvbXBhdCwgdXNlIC5rZXkKICBnZXQgYm9vdHN0cmFwKCkgewogICAgcmV0dXJuIHRoaXMua2V5CiAgfQoKICAvLyBUT0RPOiBjb21wYXQsIHdpbGwgYmUgcmVtb3ZlZAogIGdldCBib290c3RyYXBzKCkgewogICAgcmV0dXJuIFt0aGlzLmJvb3RzdHJhcF0KICB9CgogIGdldCBhcHBlbmRpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5fYXBwZW5kaW5nICE9PSBudWxsICYmIHRoaXMuX2FwcGVuZGluZy5sZW5ndGggPiAwCiAgfQoKICBnZXQgd3JpdGFibGUoKSB7CiAgICByZXR1cm4gdGhpcy5sb2NhbFdyaXRlciAhPT0gbnVsbCAmJiAhdGhpcy5sb2NhbFdyaXRlci5pc1JlbW92ZWQKICB9CgogIGdldCBhY2thYmxlKCkgewogICAgcmV0dXJuIHRoaXMubG9jYWxXcml0ZXIgIT09IG51bGwgJiYgdGhpcy5sb2NhbFdyaXRlci5pc0FjdGl2ZUluZGV4ZXIKICB9CgogIGdldCBzaWduZWRMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLnNpZ25lZExlbmd0aAogIH0KCiAgZ2V0IGluZGV4ZWRMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5fYXBwbHlTdGF0ZSA/IHRoaXMuX2FwcGx5U3RhdGUuaW5kZXhlZExlbmd0aCA6IDAKICB9CgogIGdldCBsZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLmxlbmd0aAogIH0KCiAgZ2V0IGZsdXNoaW5nKCkgewogICAgcmV0dXJuIHRoaXMuX2ZsdXNoaW5nID4gMAogIH0KCiAgaGFzaCgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUudHJlZUhhc2goKQogIH0KCiAgLy8gZGVwcmVjYXRlZCwgdXNlIC5jb3JlLmtleQogIGdldFN5c3RlbUtleSgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUua2V5CiAgfQoKICBnZXQgc3lzdGVtKCkgewogICAgcmV0dXJuIHRoaXMuX2FwcGx5U3RhdGUgJiYgdGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0KICB9CgogIC8vIGRlcHJlY2F0ZWQKICBhc3luYyBnZXRJbmRleGVkSW5mbygpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgcmV0dXJuICgKICAgICAgdGhpcy5fYXBwbHlTdGF0ZSAmJiB0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5nZXRJbmRleGVkSW5mbyh0aGlzLl9hcHBseVN0YXRlLmluZGV4ZWRMZW5ndGgpCiAgICApCiAgfQoKICBfaXNBY3RpdmVJbmRleGVyKCkgewogICAgcmV0dXJuIHRoaXMubG9jYWxXcml0ZXIgPyB0aGlzLmxvY2FsV3JpdGVyLmlzQWN0aXZlSW5kZXhlciA6IGZhbHNlCiAgfQoKICByZXBsaWNhdGUoaXNJbml0aWF0b3IsIG9wdHMpIHsKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RvcmUucmVwbGljYXRlKGlzSW5pdGlhdG9yLCBvcHRzKQogICAgdGhpcy53YWtldXBQcm90b2NvbC5hZGRTdHJlYW0oc3RyZWFtKQogICAgcmV0dXJuIHN0cmVhbQogIH0KCiAgaGVhZHMoKSB7CiAgICBpZiAoIXRoaXMuX2FwcGx5U3RhdGUgfHwgIXRoaXMuX2FwcGx5U3RhdGUub3BlbmVkKSByZXR1cm4gW10KICAgIGNvbnN0IG5vZGVzID0gbmV3IEFycmF5KHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmhlYWRzLmxlbmd0aCkKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uaGVhZHMubGVuZ3RoOyBpKyspCiAgICAgIG5vZGVzW2ldID0gdGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uaGVhZHNbaV0KICAgIHJldHVybiBub2Rlcy5zb3J0KGNvbXBhcmVOb2RlcykKICB9CgogIGFzeW5jIGV4cG9ydCgpIHsKICAgIGNvbnN0IGV4cG9ydGluZyA9IFt0aGlzLnN0b3JlLnN0b3JhZ2UuZXhwb3J0KHRoaXMubG9jYWwuZGlzY292ZXJ5S2V5KSwgdGhpcy5fdmlld1N0b3JlLmV4cG9ydCgpXQoKICAgIGNvbnN0IFtsb2NhbCwgdmlld3NdID0gYXdhaXQgUHJvbWlzZS5hbGwoZXhwb3J0aW5nKQoKICAgIHJldHVybiB7CiAgICAgIGxvY2FsLAogICAgICB2aWV3cwogICAgfQogIH0KCiAgaGludFdha2V1cChoaW50cykgewogICAgaWYgKCFBcnJheS5pc0FycmF5KGhpbnRzKSkgaGludHMgPSBbaGludHNdCiAgICBmb3IgKGNvbnN0IHsga2V5LCBsZW5ndGggfSBvZiBoaW50cykgewogICAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykKICAgICAgY29uc3QgcHJldiA9IHRoaXMuX3dha2V1cEhpbnRzLmdldChoZXgpCiAgICAgIGlmICghcHJldiB8fCBsZW5ndGggPT09IC0xIHx8IHByZXYgPCBsZW5ndGgpIHRoaXMuX3dha2V1cEhpbnRzLnNldChoZXgsIGxlbmd0aCkKICAgIH0KICAgIHRoaXMuX3F1ZXVlQnVtcCgpCiAgfQoKICBzZXRCaWdCYXRjaGVzKGJvb2wgPSB0cnVlKSB7CiAgICB0aGlzLmJpZ0JhdGNoZXMgPSBib29sCiAgfQoKICBfcXVldWVCdW1wKCkgewogICAgdGhpcy5fYnVtcCgpLmNhdGNoKHNhZmV0eUNhdGNoKQogIH0KCiAgYXN5bmMgX3J1blByZU9wZW4oKSB7CiAgICBpZiAodGhpcy5faGFuZGxlcnMud2FpdCkgYXdhaXQgdGhpcy5faGFuZGxlcnMud2FpdCgpCgogICAgYXdhaXQgdGhpcy5zdG9yZS5yZWFkeSgpCgogICAgdGhpcy5rZXlQYWlyID0gKGF3YWl0IHRoaXMuX2hhbmRsZXJzLmtleVBhaXIpIHx8IG51bGwKCiAgICBpZiAodGhpcy5faGFuZGxlcnMuZW5jcnlwdGlvbktleSAhPT0gbnVsbCkgewogICAgICB0aGlzLmVuY3J5cHRpb25LZXkgPSBhd2FpdCB0aGlzLl9oYW5kbGVycy5lbmNyeXB0aW9uS2V5CiAgICB9CgogICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYm9vdCh0aGlzLnN0b3JlLCB0aGlzLmtleSwgewogICAgICBlbmNyeXB0aW9uS2V5OiB0aGlzLmVuY3J5cHRpb25LZXksCiAgICAgIGVuY3J5cHQ6IHRoaXMuZW5jcnlwdCwKICAgICAga2V5UGFpcjogdGhpcy5rZXlQYWlyCiAgICB9KQoKICAgIHRoaXMuX3ByaW1hcnlCb290c3RyYXAgPSByZXN1bHQuYm9vdHN0cmFwCiAgICB0aGlzLmxvY2FsID0gcmVzdWx0LmxvY2FsCgogICAgdGhpcy5rZXkgPSByZXN1bHQuYm9vdHN0cmFwLmtleQogICAgdGhpcy5kaXNjb3ZlcnlLZXkgPSByZXN1bHQuYm9vdHN0cmFwLmRpc2NvdmVyeUtleQogICAgdGhpcy5pZCA9IHJlc3VsdC5ib290c3RyYXAuaWQKCiAgICB0aGlzLmVuY3J5cHRpb25LZXkgPSByZXN1bHQuZW5jcnlwdGlvbktleQoKICAgIGlmICh0aGlzLmVuY3J5cHRlZCkgewogICAgICBhc3NlcnQodGhpcy5lbmNyeXB0aW9uS2V5ICE9PSBudWxsLCAnRW5jcnlwdGlvbiBrZXkgaXMgZXhwZWN0ZWQnKQogICAgfQoKICAgIGlmICh0aGlzLmVuY3J5cHRpb25LZXkpIHsKICAgICAgdGhpcy5lbmNyeXB0aW9uID0gbmV3IEVuY3J5cHRpb25WaWV3KHRoaXMsIG51bGwpCgogICAgICB0aGlzLmxvY2FsLnNldEVuY3J5cHRpb24odGhpcy5nZXRXcml0ZXJFbmNyeXB0aW9uKCkpCiAgICAgIHRoaXMuX3ByaW1hcnlCb290c3RyYXAuc2V0RW5jcnlwdGlvbih0aGlzLmdldFdyaXRlckVuY3J5cHRpb24oKSkKICAgIH0KCiAgICBpZiAodGhpcy5udWtlVGlwKSBhd2FpdCB0aGlzLl9udWtlVGlwKCkKCiAgICB0aGlzLmxvY2FsLm9uKCdhcHBlbmQnLCB0aGlzLl9vbmxvY2Fsd3JpdGVyY2hhbmdlQm91bmQpCgogICAgdGhpcy53YWtldXBDYXBhYmlsaXR5ID0gKGF3YWl0IHRoaXMuX2hhbmRsZXJzLndha2V1cENhcGFiaWxpdHkpIHx8IHsKICAgICAga2V5OiB0aGlzLmtleSwKICAgICAgZGlzY292ZXJ5S2V5OiB0aGlzLmRpc2NvdmVyeUtleQogICAgfQogICAgdGhpcy5zZXRXYWtldXAodGhpcy53YWtldXBDYXBhYmlsaXR5LmtleSwgdGhpcy53YWtldXBDYXBhYmlsaXR5LmRpc2NvdmVyeUtleSkKICB9CgogIGFzeW5jIF9udWtlVGlwQmF0Y2goa2V5LCBsZW5ndGgpIHsKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7IGtleSwgYWN0aXZlOiBmYWxzZSB9KQogICAgYXdhaXQgY29yZS5yZWFkeSgpCgogICAgY29uc3QgYmF0Y2ggPSBjb3JlLnNlc3Npb24oeyBuYW1lOiAnYmF0Y2gnIH0pCiAgICBhd2FpdCBiYXRjaC5yZWFkeSgpCiAgICBpZiAoYmF0Y2gubGVuZ3RoID4gbGVuZ3RoKSBhd2FpdCBiYXRjaC50cnVuY2F0ZShsZW5ndGgpCiAgICBhd2FpdCBiYXRjaC5jbG9zZSgpCgogICAgYXdhaXQgY29yZS5jbG9zZSgpCiAgfQoKICAvLyBUT0RPOiBub3QgYXRvbWljIGF0bSwgc28gbW9yZSBvZiBhICh2ZXJ5IHVzZWZ1bCkgZGVidWcgaGVscGVyCiAgYXN5bmMgX251a2VUaXAoKSB7CiAgICBjb25zdCBwb2ludGVyID0gYXdhaXQgdGhpcy5sb2NhbC5nZXRVc2VyRGF0YSgnYXV0b2Jhc2UvYm9vdCcpCiAgICBpZiAoIXBvaW50ZXIpIHJldHVybgoKICAgIGNvbnN0IGJvb3QgPSBjLmRlY29kZShtZXNzYWdlcy5Cb290UmVjb3JkLCBwb2ludGVyKQoKICAgIGF3YWl0IExvY2FsU3RhdGUuY2xlYXIodGhpcy5sb2NhbCkKCiAgICBhd2FpdCB0aGlzLl9udWtlVGlwQmF0Y2goYm9vdC5rZXksIGJvb3Quc3lzdGVtTGVuZ3RoKQoKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7IGtleTogYm9vdC5rZXksIGFjdGl2ZTogZmFsc2UsIGVuY3J5cHRpb246IG51bGwgfSkKICAgIGNvbnN0IGVuY0NvcmUgPSBhd2FpdCBFbmNyeXB0aW9uVmlldy5zZXRTeXN0ZW1FbmNyeXB0aW9uKHRoaXMsIGNvcmUpCgogICAgY29uc3QgYmF0Y2ggPSBjb3JlLnNlc3Npb24oeyBuYW1lOiAnYmF0Y2gnIH0pCiAgICBhd2FpdCBiYXRjaC5yZWFkeSgpCgogICAgY29uc3QgaW5mbyA9IGF3YWl0IFN5c3RlbVZpZXcuZ2V0SW5kZXhlZEluZm8oYmF0Y2gsIGJvb3Quc3lzdGVtTGVuZ3RoKQogICAgYXdhaXQgYmF0Y2guY2xvc2UoKQoKICAgIGZvciAoY29uc3QgdmlldyBvZiBpbmZvLnZpZXdzKSB7CiAgICAgIC8vIGVuc3VyZSBhbnkgdmlld3MgcmVmJ2VkIGJ5IHN5c3RlbSBhcmUgY29uc2lzdGVudCBhcyB3ZWxsCiAgICAgIGF3YWl0IHRoaXMuX251a2VUaXBCYXRjaCh2aWV3LmtleSwgdmlldy5sZW5ndGgpCiAgICB9CgogICAgaWYgKGJvb3QuaGVhZHMpIHRoaXMuaGludFdha2V1cChib290LmhlYWRzKQogICAgaWYgKHRoaXMubG9jYWwubGVuZ3RoKSB0aGlzLmhpbnRXYWtldXAoW3sga2V5OiB0aGlzLmxvY2FsLmtleSwgbGVuZ3RoOiB0aGlzLmxvY2FsLmxlbmd0aCB9XSkKCiAgICBhd2FpdCBjb3JlLmNsb3NlKCkKICAgIGlmIChlbmNDb3JlKSBhd2FpdCBlbmNDb3JlLmNsb3NlKCkKICB9CgogIF9idW1wV2FrZXVwUGVlcihwZWVyKSB7CiAgICBpZiAodGhpcy5fY291cGxlcikgdGhpcy5fY291cGxlci51cGRhdGUocGVlci5zdHJlYW0pCiAgfQoKICBhc3luYyBfcm90YXRlTG9jYWxXcml0ZXIobmV3TG9jYWwpIHsKICAgIGFzc2VydCghdGhpcy5hcHBlbmRpbmcsICdDYW5ub3Qgcm90YXRlIGEgbmV3TG9jYWwgd3JpdGVyIGlmIGFuIGFwcGVuZCBpcyBpbiBwcm9ncmVzcycpCgogICAgY29uc3Qgb2xkTG9jYWwgPSB0aGlzLmxvY2FsCgogICAgaWYgKHRoaXMuX2FwcGx5U3RhdGUpIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuY2xvc2UoKQoKICAgIHRoaXMubG9jYWwgPSBuZXdMb2NhbAogICAgdGhpcy5sb2NhbC5vbignYXBwZW5kJywgdGhpcy5fb25sb2NhbHdyaXRlcmNoYW5nZUJvdW5kKQoKICAgIHRoaXMubG9jYWxXcml0ZXIgPSBudWxsCiAgICB0aGlzLl91cGRhdGVMb2NhbENvcmUgPSBudWxsCgogICAgY29uc3Qgc3RvcmUgPSB0aGlzLl92aWV3U3RvcmUuYXRvbWl6ZSgpCgogICAgY29uc3QgbG9jYWwgPSBzdG9yZS5nZXRMb2NhbCgpCiAgICBhd2FpdCBsb2NhbC5yZWFkeSgpCgogICAgYXdhaXQgTG9jYWxTdGF0ZS5tb3ZlVG8ob2xkTG9jYWwsIGxvY2FsKQoKICAgIGF3YWl0IGxvY2FsLnNldFVzZXJEYXRhKCdyZWZlcnJlcicsIHRoaXMua2V5KQogICAgaWYgKHRoaXMuZW5jcnlwdGlvbktleSkgYXdhaXQgbG9jYWwuc2V0VXNlckRhdGEoJ2F1dG9iYXNlL2VuY3J5cHRpb24nLCB0aGlzLmVuY3J5cHRpb25LZXkpCgogICAgYXdhaXQgc3RvcmUuZmx1c2goKQogICAgYXdhaXQgc3RvcmUuY2xvc2UoKQoKICAgIGF3YWl0IHRoaXMuX3ByaW1hcnlCb290c3RyYXAuc2V0VXNlckRhdGEoJ2F1dG9iYXNlL2xvY2FsJywgbG9jYWwua2V5KQoKICAgIGF3YWl0IHRoaXMuX2NsZWFyV3JpdGVycygpCiAgICBhd2FpdCBvbGRMb2NhbC5jbG9zZSgpCgogICAgLy8gZG9uZSwgc29mdCByZWJvb3QKCiAgICBhd2FpdCB0aGlzLl92aWV3U3RvcmUudXBkYXRlTG9jYWwoKQoKICAgIGF3YWl0IHRoaXMuX2NsZWFyV3JpdGVycygpCgogICAgdGhpcy5fYXBwbHlTdGF0ZSA9IG5ldyBBcHBseVN0YXRlKHRoaXMpCiAgICBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnJlYWR5KCkKICAgIGF3YWl0IHRoaXMuX21ha2VMaW5lYXJpemVyRnJvbVZpZXdTdGF0ZSgpCgogICAgdGhpcy5fY2F1Z2h0dXAgPSBmYWxzZQoKICAgIHRoaXMuX3JlYm9vdGVkKCkKCiAgICB0aGlzLmVtaXQoJ3JvdGF0ZS1sb2NhbC13cml0ZXInKQogIH0KCiAgYXN5bmMgc2V0TG9jYWwoa2V5LCB7IGtleVBhaXIgfSA9IHt9KSB7CiAgICBpZiAoIXRoaXMub3BlbmVkKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICBjb25zdCBtYW5pZmVzdCA9IGtleVBhaXIKICAgICAgPyB7IHZlcnNpb246IHRoaXMuc3RvcmUubWFuaWZlc3RWZXJzaW9uLCBzaWduZXJzOiBbeyBwdWJsaWNLZXk6IGtleVBhaXIucHVibGljS2V5IH1dIH0KICAgICAgOiBudWxsCiAgICBpZiAoIWtleSkga2V5ID0gSHlwZXJjb3JlLmtleShtYW5pZmVzdCkKICAgIC8vIElmIHRoZSBrZXlzIGFyZSB0aGUgc2FtZSwgbm8gbmVlZCB0byByb3RhdGUKICAgIGlmIChiNGEuZXF1YWxzKGtleSwgdGhpcy5sb2NhbC5rZXkpKSByZXR1cm4KCiAgICBjb25zdCBlbmNyeXB0aW9uID0gdGhpcy5lbmNyeXB0aW9uS2V5ID8gdGhpcy5nZXRXcml0ZXJFbmNyeXB0aW9uKCkgOiBudWxsCgogICAgY29uc3QgbG9jYWwgPSB0aGlzLnN0b3JlLmdldCh7CiAgICAgIGtleSwKICAgICAgbWFuaWZlc3QsCiAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgIGV4Y2x1c2l2ZTogdHJ1ZSwKICAgICAgZW5jcnlwdGlvbiwKICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlCiAgICB9KQogICAgYXdhaXQgbG9jYWwucmVhZHkoKQoKICAgIHRoaXMuX3VwZGF0ZUxvY2FsQ29yZSA9IGxvY2FsCgogICAgbGV0IHJ1bnMgPSAwCiAgICB3aGlsZSAoIXRoaXMuX2ludGVycnVwdGluZyAmJiB0aGlzLmFwcGVuZGluZyAmJiBydW5zKysgPCAxNikgYXdhaXQgdGhpcy51cGRhdGUoKQogICAgYXdhaXQgdGhpcy5fYnVtcCgpCiAgfQoKICBzZXRXYWtldXAoY2FwLCBkaXNjb3ZlcnlLZXkpIHsKICAgIGlmICh0aGlzLndha2V1cFNlc3Npb24pIHRoaXMud2FrZXVwU2Vzc2lvbi5kZXN0cm95KCkKICAgIGlmICghZGlzY292ZXJ5S2V5ICYmIGI0YS5lcXVhbHMoY2FwLCB0aGlzLmtleSkpIGRpc2NvdmVyeUtleSA9IHRoaXMuZGlzY292ZXJ5S2V5CiAgICB0aGlzLndha2V1cFNlc3Npb24gPSB0aGlzLndha2V1cFByb3RvY29sLnNlc3Npb24oCiAgICAgIGNhcCwKICAgICAgbmV3IFdha2V1cEhhbmRsZXIodGhpcywgZGlzY292ZXJ5S2V5IHx8IG51bGwpCiAgICApCgogICAgLy8gaW5jYXNlIHRoaXMgc2Vzc2lvbiBoYXMgYWN0aXZlIHBlZXJzIGFscmVhZHksIGJ1bXAgdGhlIGNvdXBsZXIKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLndha2V1cFNlc3Npb24ucGVlcnMpIHsKICAgICAgaWYgKHBlZXIuYWN0aXZlKSB0aGlzLl9idW1wV2FrZXVwUGVlcihwZWVyKQogICAgfQogIH0KCiAgYXN5bmMgX2dldE1pZ3JhdGlvblBvaW50ZXIoa2V5LCBsZW5ndGgpIHsKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7IGtleSwgYWN0aXZlOiBmYWxzZSwgZW5jcnlwdGlvbjogbnVsbCB9KQogICAgY29uc3QgZW5jQ29yZSA9IGF3YWl0IEVuY3J5cHRpb25WaWV3LnNldFN5c3RlbUVuY3J5cHRpb24odGhpcywgY29yZSkKCiAgICBjb25zdCBtaW4gPSBjb3JlLm1hbmlmZXN0ICYmIGNvcmUubWFuaWZlc3QucHJvbG9ndWUgPyBjb3JlLm1hbmlmZXN0LnByb2xvZ3VlLmxlbmd0aCA6IDAKCiAgICBmb3IgKGxldCBpID0gbGVuZ3RoIC0gMTsgaSA+PSBtaW47IGktLSkgewogICAgICBpZiAoIShhd2FpdCBjb3JlLmhhcyhpKSkpIGNvbnRpbnVlCgogICAgICBjb25zdCBzeXMgPSBuZXcgU3lzdGVtVmlldyhjb3JlLCB7IGNoZWNrb3V0OiBpICsgMSB9KQogICAgICBhd2FpdCBzeXMucmVhZHkoKQoKICAgICAgbGV0IGdvb2QgPSB0cnVlCgogICAgICBmb3IgKGNvbnN0IHYgb2Ygc3lzLnZpZXdzKSB7CiAgICAgICAgY29uc3QgdmMgPSB0aGlzLnN0b3JlLmdldCh7IGtleTogdi5rZXksIGFjdGl2ZTogZmFsc2UgfSkKICAgICAgICBhd2FpdCB2Yy5yZWFkeSgpCiAgICAgICAgaWYgKHZjLmxlbmd0aCA8IHYubGVuZ3RoKSBnb29kID0gZmFsc2UKICAgICAgICBhd2FpdCB2Yy5jbG9zZSgpCiAgICAgIH0KCiAgICAgIGF3YWl0IHN5cy5jbG9zZSgpCiAgICAgIGlmICghZ29vZCkgY29udGludWUKCiAgICAgIHJldHVybiBpICsgMQogICAgfQoKICAgIGF3YWl0IGNvcmUuY2xvc2UoKQogICAgaWYgKGVuY0NvcmUpIGF3YWl0IGVuY0NvcmUuY2xvc2UoKQoKICAgIHJldHVybiBtaW4KICB9CgogIC8vIG1pZ3JhdGluZyBmcm9tIDYgLT4gbGF0ZXN0CiAgYXN5bmMgX21pZ3JhdGU2KGtleSwgbGVuZ3RoKSB7CiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoeyBrZXksIGFjdGl2ZTogZmFsc2UgfSkKICAgIGF3YWl0IGNvcmUucmVhZHkoKQogICAgY29uc3QgYmF0Y2ggPSBjb3JlLnNlc3Npb24oeyBuYW1lOiAnYmF0Y2gnLCBvdmVyd3JpdGU6IHRydWUsIGNoZWNrb3V0OiBsZW5ndGggfSkKICAgIGF3YWl0IGJhdGNoLnJlYWR5KCkKICAgIGF3YWl0IGJhdGNoLmNsb3NlKCkKICAgIGF3YWl0IGNvcmUuY2xvc2UoKQogIH0KCiAgLy8gY2FsbGVkIGJ5IHZpZXctc3RvcmUgZm9yIGJvb3RzdHJhcHBpbmcKICBhc3luYyBfZ2V0U3lzdGVtSW5mbygpIHsKICAgIGNvbnN0IGJvb3QgPSBhd2FpdCB0aGlzLl9nZXRCb290UmVjb3JkKCkKICAgIGlmICghYm9vdC5rZXkpIHJldHVybiBudWxsCgogICAgY29uc3QgbWlncmF0ZWQgPSAhIWJvb3QuaGVhZHMKICAgIGNvbnN0IGluZGV4ZWRMZW5ndGggPSBib290LnN5c3RlbUxlbmd0aAoKICAgIGlmIChtaWdyYXRlZCkgewogICAgICAvLyBlbnN1cmUgc3lzdGVtIGJhdGNoIGlzIGNvbnNpc3RlbnQgb24gaW5pdGlhbCBtaWdyYXRpb24KICAgICAgYXdhaXQgdGhpcy5fbWlncmF0ZTYoYm9vdC5rZXksIGluZGV4ZWRMZW5ndGgpCiAgICB9CgogICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsga2V5OiBib290LmtleSwgZW5jcnlwdGlvbjogbnVsbCwgYWN0aXZlOiBmYWxzZSB9KQogICAgYXdhaXQgY29yZS5yZWFkeSgpCgogICAgY29uc3QgYmF0Y2ggPSBjb3JlLnNlc3Npb24oeyBuYW1lOiAnYmF0Y2gnIH0pCiAgICBjb25zdCBlbmNDb3JlID0gYXdhaXQgRW5jcnlwdGlvblZpZXcuc2V0U3lzdGVtRW5jcnlwdGlvbih0aGlzLCBiYXRjaCkKCiAgICBjb25zdCBpbmZvID0gYXdhaXQgU3lzdGVtVmlldy5nZXRJbmRleGVkSW5mbyhiYXRjaCwgaW5kZXhlZExlbmd0aCkKCiAgICBpZiAoZW5jQ29yZSkgYXdhaXQgZW5jQ29yZS5jbG9zZSgpCiAgICBhd2FpdCBiYXRjaC5jbG9zZSgpCiAgICBhd2FpdCBjb3JlLmNsb3NlKCkKCiAgICBpZiAoaW5mby52ZXJzaW9uID4gTUFYX0FVVE9CQVNFX1ZFUlNJT04pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdXRvYmFzZSB1cGdyYWRlIHJlcXVpcmVkLicpCiAgICB9CgogICAgLy8ganVzdCBjb21wYXQKICAgIGlmIChtaWdyYXRlZCkgewogICAgICB0aGlzLm1pZ3JhdGVkID0gdHJ1ZQoKICAgICAgZm9yIChjb25zdCB2aWV3IG9mIGluZm8udmlld3MpIHsKICAgICAgICAvLyBlbnN1cmUgYW55IHZpZXdzIHJlZidlZCBieSBzeXN0ZW0gYXJlIGNvbnNpc3RlbnQgYXMgd2VsbAogICAgICAgIGF3YWl0IHRoaXMuX21pZ3JhdGU2KHZpZXcua2V5LCB2aWV3Lmxlbmd0aCkKICAgICAgfQoKICAgICAgaWYgKGJvb3QuaGVhZHMpIHRoaXMuaGludFdha2V1cChib290LmhlYWRzKQogICAgICBpZiAodGhpcy5sb2NhbC5sZW5ndGgpIHRoaXMuaGludFdha2V1cChbeyBrZXk6IHRoaXMubG9jYWwua2V5LCBsZW5ndGg6IHRoaXMubG9jYWwubGVuZ3RoIH1dKQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGtleTogYm9vdC5rZXksCiAgICAgIGluZGV4ZXJzOiBpbmZvLmluZGV4ZXJzLAogICAgICB2aWV3czogaW5mby52aWV3cywKICAgICAgZW50cm9weTogaW5mby5lbnRyb3B5CiAgICB9CiAgfQoKICAvLyBjYWxsZWQgYnkgdGhlIGFwcGx5IHN0YXRlIGZvciBib290c3RyYXBwaW5nCiAgYXN5bmMgX2dldEJvb3RSZWNvcmQoKSB7CiAgICBhd2FpdCB0aGlzLl9wcmVvcGVuCgogICAgY29uc3QgcG9pbnRlciA9IGF3YWl0IHRoaXMubG9jYWwuZ2V0VXNlckRhdGEoJ2F1dG9iYXNlL2Jvb3QnKQoKICAgIGNvbnN0IGJvb3QgPSBwb2ludGVyCiAgICAgID8gYy5kZWNvZGUobWVzc2FnZXMuQm9vdFJlY29yZCwgcG9pbnRlcikKICAgICAgOiB7CiAgICAgICAgICB2ZXJzaW9uOiBCT09UX1JFQ09SRF9WRVJTSU9OLAogICAgICAgICAga2V5OiBudWxsLAogICAgICAgICAgc3lzdGVtTGVuZ3RoOiAwLAogICAgICAgICAgaW5kZXhlcnNVcGRhdGVkOiBmYWxzZSwKICAgICAgICAgIGZhc3RGb3J3YXJkaW5nOiBmYWxzZSwKICAgICAgICAgIHJlY292ZXJpZXM6IFJFQ09WRVJJRVMsCiAgICAgICAgICBoZWFkczogbnVsbAogICAgICAgIH0KCiAgICBpZiAoYm9vdC5oZWFkcykgewogICAgICBjb25zdCBsZW4gPSBhd2FpdCB0aGlzLl9nZXRNaWdyYXRpb25Qb2ludGVyKGJvb3Qua2V5LCBib290LnN5c3RlbUxlbmd0aCkKICAgICAgaWYgKGxlbiAhPT0gYm9vdC5zeXN0ZW1MZW5ndGgpCiAgICAgICAgdGhpcy5fd2FybigKICAgICAgICAgIG5ldyBFcnJvcigKICAgICAgICAgICAgJ0ludmFsaWQgcG9pbnRlciBpbiBtaWdyYXRpb24sIGNvcnJlY3RpbmcgKCcgKyBsZW4gKyAnIHZzICcgKyBib290LnN5c3RlbUxlbmd0aCArICcpJwogICAgICAgICAgKQogICAgICAgICkKICAgICAgYm9vdC5zeXN0ZW1MZW5ndGggPSBsZW4KICAgIH0KCiAgICByZXR1cm4gYm9vdAogIH0KCiAgc3RhdGljIGFzeW5jIGdldEJvb3RSZWNvcmQoc3RvcmUsIGtleSkgewogICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYm9vdChzdG9yZSwga2V5LCB7IGV4Y2x1c2l2ZTogZmFsc2UgfSkKICAgIGF3YWl0IHJlc3VsdC5ib290c3RyYXAuY2xvc2UoKQogICAgYXdhaXQgcmVzdWx0LmxvY2FsLmNsb3NlKCkKICAgIHJldHVybiByZXN1bHQuYm9vdAogIH0KCiAgX2ludGVycnVwdChyZWFzb24pIHsKICAgIGFzc2VydCghIXRoaXMuX2FwcGx5U3RhdGUuYXBwbHlpbmcsICdJbnRlcnJ1cHQgaXMgb25seSBhbGxvd2VkIGluIGFwcGx5JykKICAgIHRoaXMuX2ludGVycnVwdGluZyA9IHRydWUKICAgIGlmIChyZWFzb24pIHRoaXMuaW50ZXJydXB0ZWQgPSByZWFzb24KICAgIHRocm93IElOVEVSUlVQVAogIH0KCiAgYXN5bmMgZmx1c2goKSB7CiAgICBpZiAodGhpcy5fZmx1c2hpbmcgPT09IDApIHJldHVybgogICAgcmV0dXJuIHRoaXMuX2ZsdXNoU2lnbmFsLndhaXQoKQogIH0KCiAgYXN5bmMgYWR2YW5jZSgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgYXdhaXQgdGhpcy5fYWR2YW5jaW5nCiAgfQoKICByZWNvdXBsZSgpIHsKICAgIGlmICh0aGlzLl9jb3VwbGVyKSB0aGlzLl9jb3VwbGVyLmRlc3Ryb3koKQogICAgY29uc3QgY29yZSA9IHRoaXMuX3ZpZXdTdG9yZS5nZXRTeXN0ZW1Db3JlKCkKICAgIHRoaXMuX2NvdXBsZXIgPSBuZXcgQ29yZUNvdXBsZXIoY29yZSwgdGhpcy5fd2FrZXVwUGVlckJvdW5kKQogIH0KCiAgX3VwZGF0ZUJvb3RzdHJhcFdyaXRlcnMoKSB7CiAgICBjb25zdCB3cml0ZXJzID0gdGhpcy5saW5lYXJpemVyLmdldEJvb3RzdHJhcFdyaXRlcnMoKQoKICAgIC8vIGZpcnN0IGNsZWFyIGFsbCwgYnV0IHdpdGhvdXQgYXBwbHlpbmcgaXQgZm9yIGNodXJuIHJlYXNvbnMKICAgIGZvciAoY29uc3Qgd3JpdGVyIG9mIHRoaXMuX2Jvb3RzdHJhcFdyaXRlcnMpIHsKICAgICAgd3JpdGVyLmlzQm9vdHN0cmFwID0gZmFsc2UKICAgICAgd3JpdGVyLmlzQ291cGxlZCA9IGZhbHNlCiAgICB9CgogICAgLy8gYWxsIHBhc3NlZCBhcmUgYm9vdHN0cmFwcwogICAgZm9yIChjb25zdCB3cml0ZXIgb2Ygd3JpdGVycykgewogICAgICB3cml0ZXIuaXNDb3VwbGVkID0gdHJ1ZQogICAgICB3cml0ZXIuc2V0Qm9vdHN0cmFwKHRydWUpCiAgICB9CgogICAgLy8gcmVzZXQgYWN0aXZpdHkgb24gb2xkIG9uZXMsIGFsbCBzaG91bGQgYmUgaW4gc3luYyBub3cKICAgIGZvciAoY29uc3Qgd3JpdGVyIG9mIHRoaXMuX2Jvb3RzdHJhcFdyaXRlcnMpIHsKICAgICAgaWYgKHdyaXRlci5pc0Jvb3RzdHJhcCA9PT0gZmFsc2UpIHdyaXRlci5zZXRCb290c3RyYXAoZmFsc2UpCiAgICB9CgogICAgdGhpcy5fYm9vdHN0cmFwV3JpdGVycyA9IHdyaXRlcnMKICAgIHRoaXMuX2Jvb3RzdHJhcFdyaXRlcnNDaGFuZ2VkID0gZmFsc2UKICB9CgogIGFzeW5jIF9vcGVuTGluZWFyaXplcigpIHsKICAgIGlmICh0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5ib290c3RyYXBwaW5nKSB7CiAgICAgIGF3YWl0IHRoaXMuX21ha2VMaW5lYXJpemVyKG51bGwpCiAgICAgIHRoaXMuX2Jvb3RzdHJhcExpbmVhcml6ZXIoKQogICAgICByZXR1cm4KICAgIH0KCiAgICBhd2FpdCB0aGlzLl9tYWtlTGluZWFyaXplckZyb21WaWV3U3RhdGUoKQogIH0KCiAgYXN5bmMgX2NhdGNodXBBcHBseVN0YXRlKCkgewogICAgaWYgKGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuc2hvdWxkTWlncmF0ZSgpKSB7CiAgICAgIGF3YWl0IHRoaXMuX21pZ3JhdGUoKQogICAgfSBlbHNlIGlmICghKGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuY2F0Y2h1cCh0aGlzLmxpbmVhcml6ZXIpKSkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICB0aGlzLl9jYXVnaHR1cCA9IHRydWUKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIHRoaXMuX3ByZW9wZW4gPSB0aGlzLl9ydW5QcmVPcGVuKCkKICAgIGF3YWl0IHRoaXMuX3ByZW9wZW4KCiAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4KCiAgICB0aGlzLl9hcHBseVN0YXRlID0gbmV3IEFwcGx5U3RhdGUodGhpcykKCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnJlYWR5KCkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4KCiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5jbG9zZSgpCiAgICAgIH0gY2F0Y2gge30KCiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKICAgICAgfSBjYXRjaCB7fQoKICAgICAgdGhpcy5fYXBwbHlTdGF0ZSA9IG51bGwKICAgICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuCgogICAgICB0aHJvdyBlcnIKICAgIH0KCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9vcGVuTGluZWFyaXplcigpCiAgICAgIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCiAgICAgIGF3YWl0IHRoaXMuX3dha2V1cC5yZWFkeSgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuCiAgICAgIHRocm93IGVycgogICAgfQoKICAgIGlmICh0aGlzLmNvcmUubGVuZ3RoIC0gdGhpcy5fYXBwbHlTdGF0ZS5pbmRleGVkTGVuZ3RoID4gdGhpcy5fYWNrVGlja1RocmVzaG9sZCkgewogICAgICB0aGlzLl9hY2tUaWNrID0gdGhpcy5fYWNrVGlja1RocmVzaG9sZAogICAgfQogICAgaWYgKHRoaXMubG9jYWxXcml0ZXIgJiYgdGhpcy5fYWNrSW50ZXJ2YWwpIHsKICAgICAgdGhpcy5fc3RhcnRBY2tUaW1lcigpCiAgICB9CgogICAgdGhpcy5fdXBkYXRlQm9vdHN0cmFwV3JpdGVycygpCgogICAgdGhpcy5yZWNvdXBsZSgpCiAgICB0aGlzLl9xdWV1ZUZhc3RGb3J3YXJkKCkKCiAgICAvLyBxdWV1ZSBhIGZ1bGwgYnVtcCB0aGF0IGhhbmRsZXMgd2FrZXVwIGV0YyAobm90IGxlZ2FsIHRvIHdhaXQgZm9yIHRoYXQgaGVyZSkKICAgIHRoaXMuX3F1ZXVlQnVtcCgpCiAgfQoKICBhc3luYyBfY2xvc2UoKSB7CiAgICBhd2FpdCB0aGlzLmZsdXNoKCkgLy8gZmx1c2ggYWxsIHBlbmRpbmcgbm9uIG5ldHdvcmsgaW8KICAgIHRoaXMuX2ludGVycnVwdGluZyA9IHRydWUKICAgIGF3YWl0IFByb21pc2UucmVzb2x2ZSgpIC8vIGRlZmVyIG9uZSB0aWNrCgogICAgaWYgKHRoaXMud2FrZXVwU2Vzc2lvbikgdGhpcy53YWtldXBTZXNzaW9uLmRlc3Ryb3koKQogICAgaWYgKHRoaXMud2FrZXVwT3duZXIpIHRoaXMud2FrZXVwUHJvdG9jb2wuZGVzdHJveSgpCgogICAgaWYgKHRoaXMuZmFzdEZvcndhcmRpbmcpIGF3YWl0IHRoaXMuZmFzdEZvcndhcmRpbmcuY2xvc2UoKQoKICAgIGlmICh0aGlzLl9jb3VwbGVyKSB0aGlzLl9jb3VwbGVyLmRlc3Ryb3koKQogICAgdGhpcy5fY291cGxlciA9IG51bGwKICAgIHRoaXMuX3dhaXRpbmcubm90aWZ5KG51bGwpCgogICAgYXdhaXQgdGhpcy5hY3RpdmVXcml0ZXJzLmNsZWFyKCkKCiAgICBjb25zdCBjbG9zaW5nID0gdGhpcy5fYWR2YW5jaW5nID8gdGhpcy5fYWR2YW5jaW5nLmNhdGNoKHNhZmV0eUNhdGNoKSA6IG51bGwKCiAgICBhd2FpdCB0aGlzLl9jbGVhcldyaXRlcnMoKQogICAgaWYgKHRoaXMuX3ByaW1hcnlCb290c3RyYXApIGF3YWl0IHRoaXMuX3ByaW1hcnlCb290c3RyYXAuY2xvc2UoKQogICAgYXdhaXQgdGhpcy5sb2NhbC5jbG9zZSgpCgogICAgaWYgKHRoaXMuX2Fja1RpbWVyKSB7CiAgICAgIHRoaXMuX2Fja1RpbWVyLnN0b3AoKQogICAgICBhd2FpdCB0aGlzLl9hY2tUaW1lci5mbHVzaCgpCiAgICB9CgogICAgYXdhaXQgdGhpcy5fd2FrZXVwLmNsb3NlKCkKCiAgICBpZiAodGhpcy5faGFzQ2xvc2UpIGF3YWl0IHRoaXMuX2hhbmRsZXJzLmNsb3NlKHRoaXMudmlldykKICAgIGlmICh0aGlzLl9hcHBseVN0YXRlKSBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmNsb3NlKCkKCiAgICBhd2FpdCB0aGlzLl92aWV3U3RvcmUuY2xvc2UoKQogICAgYXdhaXQgdGhpcy5jb3JlLmNsb3NlKCkKICAgIGF3YWl0IHRoaXMuc3RvcmUuY2xvc2UoKQoKICAgIGlmICh0aGlzLl93cml0YWJsZSkgdGhpcy5fd3JpdGFibGUucmVzb2x2ZShmYWxzZSkKCiAgICBhd2FpdCBjbG9zaW5nCiAgfQoKICBnZXRMYXN0RXJyb3IoKSB7CiAgICByZXR1cm4gdGhpcy5fbGFzdEVycm9yCiAgfQoKICBfb25FcnJvcihlcnIpIHsKICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybgoKICAgIHRoaXMuX2xhc3RFcnJvciA9IGVycgoKICAgIGlmIChlcnIgPT09IElOVEVSUlVQVCkgewogICAgICB0aGlzLmVtaXQoJ2ludGVycnVwdCcsIHRoaXMuaW50ZXJydXB0ZWQpCiAgICAgIHRoaXMuZW1pdCgndXBkYXRlJykKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5jbG9zZSgpLmNhdGNoKHNhZmV0eUNhdGNoKQoKICAgIC8vIGlmIG5vIG9uZSBpcyBsaXN0ZW5pbmcgd2Ugc2hvdWxkIGNyYXNoISB3ZSBjYW5ub3QgcmVseSBvbiB0aGUgRUUgaGVyZQogICAgLy8gYXMgdGhpcyBpcyB3cmFwcGVkIGluIGEgcHJvbWlzZSBzbyBpbnN0ZWFkIG9mIG5leHRUaWNrIHRocm93IGl0CiAgICBpZiAoUmVhZHlSZXNvdXJjZS5saXN0ZW5lckNvdW50KHRoaXMsICdlcnJvcicpID09PSAwKSB7CiAgICAgIGNyYXNoU29vbihlcnIpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlcnIpCiAgfQoKICBhc3luYyBfY2xvc2VXcml0ZXIodykgewogICAgdGhpcy5hY3RpdmVXcml0ZXJzLmRlbGV0ZSh3KQogICAgYXdhaXQgdy5jbG9zZSgpCiAgfQoKICBhc3luYyBfZ2NXcml0ZXJzKCkgewogICAgLy8ganVzdCByZXR1cm4gZWFybHksIHdoeSBub3QKICAgIGlmICh0aGlzLl9jaGVja1dyaXRlcnMubGVuZ3RoID09PSAwKSByZXR1cm4KCiAgICB3aGlsZSAodGhpcy5fY2hlY2tXcml0ZXJzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgdyA9IHRoaXMuX2NoZWNrV3JpdGVycy5wb3AoKQoKICAgICAgLy8gZG9lc250IGh1cnQKICAgICAgdy51cGRhdGVBY3Rpdml0eSgpCgogICAgICBpZiAoIXcuZmx1c2hlZCgpKSBjb250aW51ZQoKICAgICAgY29uc3QgdW5xdWV1ZWQgPSB0aGlzLl93YWtldXAudW5xdWV1ZSh3LmNvcmUua2V5LCB3LmNvcmUubGVuZ3RoKQoKICAgICAgaWYgKCF1bnF1ZXVlZCB8fCB3LmlzQWN0aXZlSW5kZXhlcikgY29udGludWUKICAgICAgaWYgKHRoaXMubG9jYWxXcml0ZXIgPT09IHcpIGNvbnRpbnVlCgogICAgICBhd2FpdCB0aGlzLl9jbG9zZVdyaXRlcih3KQogICAgfQoKICAgIGF3YWl0IHRoaXMuX3dha2V1cC5mbHVzaCgpCiAgfQoKICBfc3RhcnRBY2tUaW1lcigpIHsKICAgIGlmICh0aGlzLl9hY2tUaW1lcikgcmV0dXJuCiAgICB0aGlzLl9hY2tUaW1lciA9IG5ldyBUaW1lcih0aGlzLl9iYWNrZ3JvdW5kQWNrLmJpbmQodGhpcyksIHRoaXMuX2Fja0ludGVydmFsKQogICAgdGhpcy5fYnVtcEFja1RpbWVyKCkKICB9CgogIF9idW1wQWNrVGltZXIoKSB7CiAgICBpZiAoIXRoaXMuX2Fja1RpbWVyKSByZXR1cm4KICAgIHRoaXMuX2Fja1RpbWVyLmJ1bXAoKQogIH0KCiAgYXN5bmMgdXBkYXRlKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fYnVtcCgpCiAgICAgIGlmICh0aGlzLl9hY2tpbmcpIGF3YWl0IHRoaXMuX2J1bXAoKSAvLyBpZiBhY2tpbmcganVzdCByZWJ1bXAgaW5jYXNlIGl0IHdhcyB0cmlnZ2VyZWQgZnJvbSBhYm92ZS4uLgogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmICh0aGlzLl9pbnRlcnJ1cHRpbmcpIHJldHVybgogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIC8vIHJ1bnMgaW4gYmcsIG5vdCBhbGxvd2VkIHRvIHRocm93CiAgLy8gVE9ETzogcmVmYWN0b3Igc28gdGhpcyBvbmx5IG1vdmVzIHRoZSB3cml0ZXIgYWZmZWN0ZWQgdG8gYSB1cGRhdGVkIHNldAogIGFzeW5jIF9vbnJlbW90ZXdyaXRlcmNoYW5nZSgpIHsKICAgIHRoaXMuX2J1bXBBY2tUaW1lcigpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fYnVtcCgpCiAgICB9IGNhdGNoIHt9CiAgfQoKICBfb25sb2NhbHdyaXRlcmNoYW5nZSgpIHsKICAgIGlmICghdGhpcy5sb2NhbFdyaXRlciB8fCB0aGlzLmxvY2FsV3JpdGVyLmlzUmVtb3ZlZCkgdGhpcy5fcXVldWVCdW1wKCkKICB9CgogIF9vbndha2V1cCgpIHsKICAgIHRoaXMuX25lZWRzV2FrZXVwID0gdHJ1ZQogICAgdGhpcy5fcXVldWVCdW1wKCkKICB9CgogIGlzRmFzdEZvcndhcmRpbmcoKSB7CiAgICBpZiAodGhpcy5mYXN0Rm9yd2FyZFRvICE9PSBudWxsKSByZXR1cm4gdHJ1ZQogICAgcmV0dXJuIHRoaXMuZmFzdEZvcndhcmRFbmFibGVkICYmIHRoaXMuZmFzdEZvcndhcmRpbmcgIT09IG51bGwKICB9CgogIF9iYWNrZ3JvdW5kQWNrKCkgewogICAgcmV0dXJuIHRoaXMuYWNrKHRydWUpCiAgfQoKICBhc3luYyBhY2soYmcgPSBmYWxzZSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAodGhpcy5sb2NhbFdyaXRlciA9PT0gbnVsbCB8fCB0aGlzLl9hY2tpbmcgfHwgdGhpcy5faW50ZXJydXB0aW5nIHx8IHRoaXMuX2FwcGVuZGluZyAhPT0gbnVsbCkKICAgICAgcmV0dXJuCgogICAgaWYgKHRoaXMuX2FwcGx5U3RhdGUgPT09IG51bGwpIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLl9idW1wKCkKICAgICAgfSBjYXRjaCB7fQogICAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZSA9PT0gbnVsbCB8fCB0aGlzLl9pbnRlcnJ1cHRpbmcpIHJldHVybgogICAgfQoKICAgIGNvbnN0IGFwcGx5U3RhdGUgPSB0aGlzLl9hcHBseVN0YXRlCiAgICBpZiAoYXBwbHlTdGF0ZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCBhcHBseVN0YXRlLnJlYWR5KCkKCiAgICBjb25zdCBpc1BlbmRpbmdJbmRleGVyID0gYXBwbHlTdGF0ZS5pc0xvY2FsUGVuZGluZ0luZGV4ZXIoKQoKICAgIC8vIGlmIG5vIG9uZSBpcyB3YWl0aW5nIGZvciBvdXIgaW5kZXggbWFuaWZlc3QsIHdhaXQgZm9yIEZGIGJlZm9yZSBwdXNoaW5nIGFuIGFjawogICAgaWYgKCghaXNQZW5kaW5nSW5kZXhlciAmJiB0aGlzLmlzRmFzdEZvcndhcmRpbmcoKSkgfHwgdGhpcy5faW50ZXJydXB0aW5nKSByZXR1cm4KCiAgICBjb25zdCBpc0luZGV4ZXIgPSBhcHBseVN0YXRlLmlzTG9jYWxJbmRleGVyKCkgfHwgaXNQZW5kaW5nSW5kZXhlcgogICAgaWYgKCFpc0luZGV4ZXIpIHJldHVybgoKICAgIHRoaXMuX2Fja2luZyA9IHRydWUKCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9idW1wKCkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAoIXRoaXMuX2ludGVycnVwdGluZykgdGhyb3cgZXJyCiAgICB9CgogICAgaWYgKHRoaXMuX2ludGVycnVwdGluZyB8fCAhdGhpcy5sb2NhbFdyaXRlciB8fCB0aGlzLmxvY2FsV3JpdGVyLmNsb3NlZCkgewogICAgICB0aGlzLl9hY2tpbmcgPSBmYWxzZQogICAgICByZXR1cm4KICAgIH0KCiAgICAvLyBhdm9pZCBsdW1waW5nIGFja3MgdG9nZXRoZXIgZHVlIHRvIHRoZSBidW1wIHdhaXQgaGVyZQogICAgaWYgKHRoaXMuX2Fja1RpbWVyICYmIGJnKSBhd2FpdCB0aGlzLl9hY2tUaW1lci5hc2FwU3RhbmRhbG9uZSgpCiAgICBpZiAodGhpcy5faW50ZXJydXB0aW5nIHx8IGFwcGx5U3RhdGUuY2xvc2luZykgewogICAgICB0aGlzLl9hY2tpbmcgPSBmYWxzZQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBhbHdheXNXcml0ZSA9IGlzUGVuZGluZ0luZGV4ZXIgfHwgKGF3YWl0IGFwcGx5U3RhdGUuc2hvdWxkV3JpdGUoKSkKICAgIGlmICh0aGlzLl9pbnRlcnJ1cHRpbmcgfHwgYXBwbHlTdGF0ZS5jbG9zaW5nKSB7CiAgICAgIHRoaXMuX2Fja2luZyA9IGZhbHNlCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IGhhc1BlbmRpbmdJbmRleGVycyA9IGFwcGx5U3RhdGUuc3lzdGVtLmluZGV4ZXJzLmxlbmd0aCA+IHRoaXMubGluZWFyaXplci5pbmRleGVycy5sZW5ndGgKCiAgICBpZiAoYWx3YXlzV3JpdGUgfHwgdGhpcy5saW5lYXJpemVyLnNob3VsZEFjayh0aGlzLmxvY2FsV3JpdGVyLCBoYXNQZW5kaW5nSW5kZXhlcnMpKSB7CiAgICAgIHRyeSB7CiAgICAgICAgaWYgKHRoaXMubG9jYWxXcml0ZXIgJiYgIXRoaXMubG9jYWxXcml0ZXIuY2xvc2VkKSBhd2FpdCB0aGlzLmFwcGVuZChudWxsKQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBpZiAoIXRoaXMuX2ludGVycnVwdGluZykgdGhyb3cgZXJyCiAgICAgIH0KICAgIH0KCiAgICBpZiAoIXRoaXMuX2ludGVycnVwdGluZykgewogICAgICB0aGlzLl91cGRhdGVBY2tUaHJlc2hvbGQoKQogICAgICB0aGlzLl9idW1wQWNrVGltZXIoKQogICAgfQoKICAgIHRoaXMuX2Fja2luZyA9IGZhbHNlCiAgfQoKICB2aWV3cygpIHsKICAgIGlmICh0aGlzLl9hcHBseVN0YXRlKSByZXR1cm4gdGhpcy5fYXBwbHlTdGF0ZS5zdG9yZS5saXN0Vmlld3MoKQogICAgcmV0dXJuIHRoaXMuX3ZpZXdTdG9yZS5saXN0Vmlld3MoKQogIH0KCiAgYmF0Y2goKSB7CiAgICByZXR1cm4gbmV3IEFwcGVuZEJhdGNoKHRoaXMpCiAgfQoKICBhc3luYyBhcHBlbmQodmFsdWUsIG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKHRoaXMuX2FkdmFuY2luZyAhPT0gbnVsbCkgYXdhaXQgdGhpcy5fYWR2YW5jaW5nCiAgICB3aGlsZSAodGhpcy5hY3RpdmVCYXRjaCkgYXdhaXQgdGhpcy5hY3RpdmVCYXRjaC5mbHVzaGVkKCkKICAgIHJldHVybiB0aGlzLl9hcHBlbmRCYXRjaCh2YWx1ZSwgb3B0cykKICB9CgogIGFzeW5jIF9hcHBlbmRCYXRjaCh2YWx1ZSwgb3B0cykgewogICAgaWYgKHRoaXMuX2ludGVycnVwdGluZykgdGhyb3cgbmV3IEVycm9yKCdBdXRvYmFzZSBpcyBjbG9zaW5nJykKICAgIGlmICh2YWx1ZSAmJiB0aGlzLnZhbHVlRW5jb2RpbmcgIT09IEJJTkFSWV9FTkNPRElORykKICAgICAgdmFsdWUgPSBub3JtYWxpemUodGhpcy52YWx1ZUVuY29kaW5nLCB2YWx1ZSkKCiAgICBjb25zdCBvcHRpbWlzdGljID0gISFvcHRzICYmICEhb3B0cy5vcHRpbWlzdGljICYmICEhdmFsdWUKCiAgICAvLyB3ZSB3YW5uYSBhbGxvdyBhY2tzIHNvIGludGVyZGV4ZXJzIGNhbiBmbHVzaAogICAgaWYgKAogICAgICAhb3B0aW1pc3RpYyAmJgogICAgICAodGhpcy5sb2NhbFdyaXRlciA9PT0gbnVsbCB8fCAodGhpcy5sb2NhbFdyaXRlci5pc1JlbW92ZWQgJiYgdmFsdWUgIT09IG51bGwpKQogICAgKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignTm90IHdyaXRhYmxlJykKICAgIH0KCiAgICBpZiAodGhpcy5fYXBwZW5kaW5nID09PSBudWxsKSB0aGlzLl9hcHBlbmRpbmcgPSBbXQoKICAgIGxldCBsZW4gPSAwCiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgZm9yIChjb25zdCB2IG9mIHZhbHVlKSBsZW4gPSB0aGlzLl9hcHBlbmQodikKICAgIH0gZWxzZSB7CiAgICAgIGxlbiA9IHRoaXMuX2FwcGVuZCh2YWx1ZSkKICAgIH0KCiAgICBjb25zdCBsb2NhbExlbmd0aCA9IHRoaXMubG9jYWwubGVuZ3RoCgogICAgaWYgKG9wdGltaXN0aWMpIHRoaXMuX29wdGltaXN0aWMgPSB0aGlzLl9hcHBlbmRpbmcubGVuZ3RoIC0gMQogICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5fYXBwZW5kZWQgKyB0aGlzLl9hcHBlbmRpbmcubGVuZ3RoCgogICAgLy8gYXdhaXQgaW4gY2FzZSBhcHBlbmQgaXMgaW4gY3VycmVudCB0aWNrCiAgICBpZiAodGhpcy5fYWR2YW5jaW5nKSBhd2FpdCB0aGlzLl9hZHZhbmNpbmcKCiAgICBsZXQgcnVucyA9IDAKCiAgICAvLyBidW1wIHVudGlsIHdlJ3ZlIGZsdXNoZWQgdGhlIG5vZGVzCiAgICB3aGlsZSAodGhpcy5fYXBwZW5kZWQgPCB0YXJnZXQgJiYgIXRoaXMuX2ludGVycnVwdGluZykgewogICAgICBhd2FpdCB0aGlzLl9idW1wKCkKICAgICAgLy8gc2FmZXR5CiAgICAgIGlmIChydW5zKysgPj0gMTYgJiYgdGhpcy5sb2NhbFdyaXRlciAmJiB0aGlzLmxvY2FsV3JpdGVyLmlkbGUoKSkgYnJlYWsKICAgIH0KCiAgICBpZiAodGhpcy5fYWR2YW5jaW5nKSBhd2FpdCB0aGlzLl9hZHZhbmNpbmcKICAgIGlmICh0aGlzLl9pbnRlcnJ1cHRpbmcpIHRocm93IG5ldyBFcnJvcignQXV0b2Jhc2UgaXMgY2xvc2luZycpCgogICAgcmV0dXJuIGxvY2FsTGVuZ3RoICsgbGVuCiAgfQoKICBfYXBwZW5kKHZhbHVlKSB7CiAgICAvLyBpZiBwcmV2IHZhbHVlIGlzIGFuIGFjayB0aGF0IGhhc250IGJlZW4gZmx1c2hlZCwgc2tpcCBpdAogICAgaWYgKHRoaXMuX2FwcGVuZGluZy5sZW5ndGggPiAwKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIHRoaXMuX2FwcGVuZGluZy5sZW5ndGgKICAgICAgaWYgKHRoaXMuX2FwcGVuZGluZ1t0aGlzLl9hcHBlbmRpbmcubGVuZ3RoIC0gMV0gPT09IG51bGwpIHsKICAgICAgICB0aGlzLl9hcHBlbmRpbmcucG9wKCkKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXMuX2FwcGVuZGluZy5wdXNoKHZhbHVlKQogIH0KCiAgc3RhdGljIGRlY29kZVZhbHVlKHZhbHVlLCBvcHRzKSB7CiAgICByZXR1cm4gZGVjb2RlVmFsdWUodmFsdWUsIG9wdHMpCiAgfQoKICBzdGF0aWMgZW5jb2RlVmFsdWUodmFsdWUsIG9wdHMpIHsKICAgIHJldHVybiBlbmNvZGVWYWx1ZSh2YWx1ZSwgb3B0cykKICB9CgogIHN0YXRpYyBhc3luYyBnZXRMb2NhbEtleShzdG9yZSwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCBjb3JlID0gb3B0cy5rZXlQYWlyCiAgICAgID8gc3RvcmUuZ2V0KHsgLi4ub3B0cywgYWN0aXZlOiBmYWxzZSB9KQogICAgICA6IHN0b3JlLmdldCh7IC4uLm9wdHMsIG5hbWU6ICdsb2NhbCcsIGFjdGl2ZTogZmFsc2UgfSkKICAgIGF3YWl0IGNvcmUucmVhZHkoKQogICAgY29uc3Qga2V5ID0gY29yZS5rZXkKICAgIGF3YWl0IGNvcmUuY2xvc2UoKQogICAgcmV0dXJuIGtleQogIH0KCiAgc3RhdGljIGdldExvY2FsQ29yZShzdG9yZSwgaGFuZGxlcnMsIGVuY3J5cHRpb25LZXkpIHsKICAgIGNvbnN0IGVuY3J5cHRpb24gPSAhZW5jcnlwdGlvbktleSA/IG51bGwgOiB7IGtleTogZW5jcnlwdGlvbktleSB9CiAgICBjb25zdCBvcHRzID0gewogICAgICAuLi5oYW5kbGVycywKICAgICAgY29tcGF0OiBmYWxzZSwKICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgZXhjbHVzaXZlOiB0cnVlLAogICAgICB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UsCiAgICAgIGVuY3J5cHRpb24KICAgIH0KICAgIHJldHVybiBvcHRzLmtleVBhaXIgPyBzdG9yZS5nZXQob3B0cykgOiBzdG9yZS5nZXQoeyAuLi5vcHRzLCBuYW1lOiAnbG9jYWwnIH0pCiAgfQoKICBzdGF0aWMgYXN5bmMgZ2V0VXNlckRhdGEoY29yZSkgewogICAgY29uc3QgdmlldyA9IGF3YWl0IGNvcmUuZ2V0VXNlckRhdGEoJ2F1dG9iYXNlL3ZpZXcnKQoKICAgIHJldHVybiB7CiAgICAgIHJlZmVycmVyOiBhd2FpdCBjb3JlLmdldFVzZXJEYXRhKCdyZWZlcnJlcicpLAogICAgICB2aWV3OiB2aWV3ID8gYjRhLnRvU3RyaW5nKHZpZXcpIDogbnVsbAogICAgfQogIH0KCiAgc3RhdGljIGFzeW5jIGlzQXV0b2Jhc2UoY29yZSwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCBibG9jayA9IGF3YWl0IGNvcmUuZ2V0KDAsIG9wdHMpCiAgICBpZiAoIWJsb2NrKSB0aHJvdyBuZXcgRXJyb3IoJ0NvcmUgaXMgZW1wdHkuJykKICAgIGlmICghYjRhLmlzQnVmZmVyKGJsb2NrKSkgcmV0dXJuIGlzQXV0b2Jhc2VNZXNzYWdlKGJsb2NrKQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IG0gPSBjLmRlY29kZShtZXNzYWdlcy5PcGxvZ01lc3NhZ2UsIGJsb2NrKQogICAgICByZXR1cm4gaXNBdXRvYmFzZU1lc3NhZ2UobSkKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICB9CgogIC8vIG5vIGd1YXJhbnRlZXMgd2hlcmUgdGhlIHVzZXIgZGF0YSBpcyBzdG9yZWQsIGp1c3QgdGhhdCBpdHMgYXNzb2NpYXRlZCB3aXRoIHRoZSBiYXNlCiAgYXN5bmMgc2V0VXNlckRhdGEoa2V5LCB2YWwpIHsKICAgIGF3YWl0IHRoaXMuX3ByZW9wZW4KICAgIGNvbnN0IGNvcmUgPSB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwID09PSBudWxsID8gdGhpcy5sb2NhbCA6IHRoaXMuX3ByaW1hcnlCb290c3RyYXAKCiAgICBhd2FpdCBjb3JlLnNldFVzZXJEYXRhKGtleSwgdmFsKQogIH0KCiAgYXN5bmMgZ2V0VXNlckRhdGEoa2V5KSB7CiAgICBhd2FpdCB0aGlzLl9wcmVvcGVuCiAgICBjb25zdCBjb3JlID0gdGhpcy5fcHJpbWFyeUJvb3RzdHJhcCA9PT0gbnVsbCA/IHRoaXMubG9jYWwgOiB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwCgogICAgcmV0dXJuIGF3YWl0IGNvcmUuZ2V0VXNlckRhdGEoa2V5KQogIH0KCiAgX25lZWRzTG9jYWxXcml0ZXIoKSB7CiAgICByZXR1cm4gdGhpcy5sb2NhbFdyaXRlciA9PT0gbnVsbCB8fCB0aGlzLmxvY2FsV3JpdGVyLmNsb3NlZAogIH0KCiAgLy8gbm8gZ3VhcmFudGVlcyBhYm91dCB3cml0ZXIuaXNBY3RpdmVJbmRleGVyIHByb3BlcnR5IGhlcmUKICBhc3luYyBfZ2V0V3JpdGVyQnlLZXkoa2V5LCBsZW4sIHNlZW4sIGFsbG93R0MsIGlzQWRkZWQsIHN5c3RlbSkgewogICAgYXNzZXJ0KHRoaXMuX2RyYWluaW5nID09PSB0cnVlIHx8ICh0aGlzLm9wZW5pbmcgJiYgIXRoaXMub3BlbmVkKSB8fCB0aGlzLl9vcHRpbWlzdGljID4gLTEpCgogICAgYXdhaXQgdGhpcy5fbG9jay5sb2NrKCkKCiAgICBpZiAodGhpcy5faW50ZXJydXB0aW5nKSB7CiAgICAgIHRoaXMuX2xvY2sudW5sb2NrKCkKICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdXRvYmFzZSBpcyBjbG9zaW5nJykKICAgIH0KCiAgICB0cnkgewogICAgICBsZXQgdyA9IHRoaXMuYWN0aXZlV3JpdGVycy5nZXQoa2V5KQoKICAgICAgY29uc3QgYWxyZWFkeUFjdGl2ZSA9ICEhdwogICAgICBjb25zdCBzeXMgPSBzeXN0ZW0gfHwgdGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0KICAgICAgY29uc3Qgd3JpdGVySW5mbyA9IGF3YWl0IHN5cy5nZXQoa2V5KQoKICAgICAgaWYgKGxlbiA9PT0gLTEpIHsKICAgICAgICBpZiAoIWFsbG93R0MgJiYgd3JpdGVySW5mbyA9PT0gbnVsbCkgewogICAgICAgICAgaWYgKHcpIHcuaXNSZW1vdmVkID0gIWlzQWRkZWQKICAgICAgICAgIHJldHVybiBudWxsCiAgICAgICAgfQoKICAgICAgICBsZW4gPSB3cml0ZXJJbmZvID09PSBudWxsID8gMCA6IHdyaXRlckluZm8ubGVuZ3RoCiAgICAgIH0KCiAgICAgIGNvbnN0IGlzQWN0aXZlID0gd3JpdGVySW5mbyAhPT0gbnVsbCAmJiAoaXNBZGRlZCB8fCAhd3JpdGVySW5mby5pc1JlbW92ZWQpCiAgICAgIGNvbnN0IGlzUmVtb3ZlZCA9ICFpc0FjdGl2ZQoKICAgICAgaWYgKHcpIHsKICAgICAgICB3LmlzUmVtb3ZlZCA9IGlzUmVtb3ZlZAogICAgICB9IGVsc2UgewogICAgICAgIHcgPSB0aGlzLl9tYWtlV3JpdGVyKGtleSwgbGVuLCBpc0FjdGl2ZSwgaXNSZW1vdmVkKQogICAgICAgIGlmICghdykgcmV0dXJuIG51bGwKICAgICAgfQoKICAgICAgaWYgKGlzUmVtb3ZlZCAmJiBzeXMuYm9vdHN0cmFwcGluZyAmJiBiNGEuZXF1YWxzKHcuY29yZS5rZXksIHRoaXMua2V5KSkgewogICAgICAgIHcuaXNSZW1vdmVkID0gZmFsc2UKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX2lzTG9jYWxDb3JlKHcuY29yZSkgJiYgdGhpcy5fbmVlZHNMb2NhbFdyaXRlcigpKSB7CiAgICAgICAgdGhpcy5fc2V0TG9jYWxXcml0ZXIodykKICAgICAgfQoKICAgICAgdy5zZWVuKHNlZW4pCgogICAgICBpZiAoYWxyZWFkeUFjdGl2ZSkgcmV0dXJuIHcKCiAgICAgIGF3YWl0IHcucmVhZHkoKQoKICAgICAgaWYgKHRoaXMuX2lzTG9jYWxDb3JlKHcuY29yZSkgJiYgdGhpcy5fbmVlZHNMb2NhbFdyaXRlcigpKSB7CiAgICAgICAgdGhpcy5fc2V0TG9jYWxXcml0ZXIodykKICAgICAgfQoKICAgICAgaWYgKGFsbG93R0MgJiYgdy5mbHVzaGVkKCkpIHsKICAgICAgICB0aGlzLl93YWtldXAudW5xdWV1ZShrZXksIGxlbikKICAgICAgICBpZiAodyAhPT0gdGhpcy5sb2NhbFdyaXRlcikgewogICAgICAgICAgYXdhaXQgdy5jbG9zZSgpCiAgICAgICAgICByZXR1cm4gdwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5hY3RpdmVXcml0ZXJzLmFkZCh3KQogICAgICB0aGlzLl9jaGVja1dyaXRlcnMucHVzaCh3KQoKICAgICAgYXNzZXJ0KHcub3BlbmVkKQogICAgICBhc3NlcnQoIXcuY2xvc2VkKQoKICAgICAgdy51cGRhdGVBY3Rpdml0eSgpCiAgICAgIHJldHVybiB3CiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl9sb2NrLnVubG9jaygpCiAgICB9CiAgfQoKICBfdXBkYXRlQWxsKCkgewogICAgY29uc3QgcCA9IFtdCiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5hY3RpdmVXcml0ZXJzKSBwLnB1c2gody51cGRhdGUobnVsbCkuY2F0Y2goc2FmZXR5Q2F0Y2gpKQogICAgcmV0dXJuIFByb21pc2UuYWxsKHApCiAgfQoKICBnZXRXcml0ZXJFbmNyeXB0aW9uKCkgewogICAgaWYgKCF0aGlzLmVuY3J5cHRpb25LZXkpIHJldHVybiBudWxsCiAgICByZXR1cm4gdGhpcy5lbmNyeXB0aW9uLmdldFdyaXRlckVuY3J5cHRpb24oKQogIH0KCiAgX21ha2VXcml0ZXJDb3JlKGtleSkgewogICAgaWYgKHRoaXMuY2xvc2luZykgdGhyb3cgbmV3IEVycm9yKCdBdXRvYmFzZSBpcyBjbG9zaW5nJykKICAgIGlmICh0aGlzLl9pbnRlcnJ1cHRpbmcpIHRocm93IElOVEVSUlVQVCgpCgogICAgY29uc3QgbG9jYWwgPSBiNGEuZXF1YWxzKGtleSwgdGhpcy5sb2NhbC5rZXkpCiAgICBjb25zdCBlbmNyeXB0aW9uID0gdGhpcy5nZXRXcml0ZXJFbmNyeXB0aW9uKCkKCiAgICBjb25zdCBjb3JlID0gbG9jYWwKICAgICAgPyB0aGlzLmxvY2FsLnNlc3Npb24oeyB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UsIGVuY3J5cHRpb24sIGFjdGl2ZTogZmFsc2UgfSkKICAgICAgOiB0aGlzLnN0b3JlLmdldCh7CiAgICAgICAgICBrZXksCiAgICAgICAgICBjb21wYXQ6IGZhbHNlLAogICAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlLAogICAgICAgICAgZW5jcnlwdGlvbiwKICAgICAgICAgIGFjdGl2ZTogZmFsc2UKICAgICAgICB9KQoKICAgIHJldHVybiBjb3JlCiAgfQoKICBfbWFrZVdyaXRlcihrZXksIGxlbmd0aCwgaXNBY3RpdmUsIGlzUmVtb3ZlZCkgewogICAgY29uc3QgY29yZSA9IHRoaXMuX21ha2VXcml0ZXJDb3JlKGtleSkKICAgIGNvbnN0IHcgPSBuZXcgV3JpdGVyKHRoaXMsIGNvcmUsIGxlbmd0aCwgaXNSZW1vdmVkKQoKICAgIGlmICh0aGlzLl9pc0xvY2FsQ29yZShjb3JlKSkgewogICAgICBpZiAoaXNBY3RpdmUpIHRoaXMuX3NldExvY2FsV3JpdGVyKHcpIC8vIG9ubHkgc2V0IGFjdGl2ZSB3cml0ZXIKICAgICAgcmV0dXJuIHcKICAgIH0KCiAgICBjb3JlLm9uKCdhcHBlbmQnLCB0aGlzLl9vbnJlbW90ZXdyaXRlcmNoYW5nZUJvdW5kKQogICAgY29yZS5vbignZG93bmxvYWQnLCB0aGlzLl9vbnJlbW90ZXdyaXRlcmNoYW5nZUJvdW5kKQogICAgY29yZS5vbignbWFuaWZlc3QnLCB0aGlzLl9vbnJlbW90ZXdyaXRlcmNoYW5nZUJvdW5kKQoKICAgIHJldHVybiB3CiAgfQoKICBfdXBkYXRlTGluZWFyaXplcihpbmRleGVycywgaGVhZHMpIHsKICAgIC8vIG9ubHkgY3VycmVudCBhY3RpdmUgaW5kZXhlcnMgYXJlIHJlc2V0IHRvIHRydWUgYmVsb3cKICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLmFjdGl2ZVdyaXRlcnMpIHcuaXNBY3RpdmVJbmRleGVyID0gZmFsc2UKICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyKSB0aGlzLmxvY2FsV3JpdGVyLmlzQWN0aXZlSW5kZXhlciA9IGZhbHNlCgogICAgZm9yIChjb25zdCB3cml0ZXIgb2YgaW5kZXhlcnMpIHdyaXRlci5pc0FjdGl2ZUluZGV4ZXIgPSB0cnVlCgogICAgaWYgKHRoaXMuX2lzQWN0aXZlSW5kZXhlcigpICYmICF0aGlzLmlzSW5kZXhlcikgewogICAgICB0aGlzLl9zZXRMb2NhbEluZGV4ZXIoKQogICAgfSBlbHNlIGlmICghdGhpcy5faXNBY3RpdmVJbmRleGVyKCkgJiYgdGhpcy5pc0luZGV4ZXIpIHsKICAgICAgdGhpcy5fY2xlYXJMb2NhbEluZGV4ZXIoKQogICAgfQoKICAgIHRoaXMubGluZWFyaXplciA9IG5ldyBMaW5lYXJpemVyKGluZGV4ZXJzLCB7IGhlYWRzLCB3cml0ZXJzOiB0aGlzLmFjdGl2ZVdyaXRlcnMgfSkKCiAgICB0aGlzLl91cGRhdGVBY2tUaHJlc2hvbGQoKQogIH0KCiAgYXN5bmMgX3VwZGF0ZUxvY2FsV3JpdGVyKHN5cykgewogICAgaWYgKHRoaXMubG9jYWxXcml0ZXIgIT09IG51bGwgJiYgIXRoaXMubG9jYWxXcml0ZXIuY2xvc2VkKSByZXR1cm4KICAgIGF3YWl0IHRoaXMuX2dldFdyaXRlckJ5S2V5KHRoaXMubG9jYWwua2V5LCAtMSwgMCwgdHJ1ZSwgZmFsc2UsIHN5cykKICB9CgogIGFzeW5jIF9ib290c3RyYXBMaW5lYXJpemVyKCkgewogICAgY29uc3QgYm9vdHN0cmFwID0gdGhpcy5fbWFrZVdyaXRlcih0aGlzLmtleSwgMCwgdHJ1ZSwgZmFsc2UpCgogICAgdGhpcy5hY3RpdmVXcml0ZXJzLmFkZChib290c3RyYXApCiAgICB0aGlzLl9jaGVja1dyaXRlcnMucHVzaChib290c3RyYXApCiAgICBhd2FpdCBib290c3RyYXAucmVhZHkoKQogICAgdGhpcy5fZW5zdXJlV2FrZXVwKGJvb3RzdHJhcCkKCiAgICB0aGlzLl91cGRhdGVMaW5lYXJpemVyKFtib290c3RyYXBdLCBbXSkKICB9CgogIGFzeW5jIF9tYWtlTGluZWFyaXplcihzeXMpIHsKICAgIGlmIChzeXMgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIHRoaXMuX2Jvb3RzdHJhcExpbmVhcml6ZXIoKQogICAgfQoKICAgIGlmICh0aGlzLm9wZW5lZCB8fCAoYXdhaXQgc3lzLmhhc0xvY2FsKHRoaXMubG9jYWwua2V5KSkpIHsKICAgICAgYXdhaXQgdGhpcy5fdXBkYXRlTG9jYWxXcml0ZXIoc3lzKQogICAgfQoKICAgIGNvbnN0IGluZGV4ZXJzID0gW10KCiAgICBmb3IgKGNvbnN0IGhlYWQgb2Ygc3lzLmluZGV4ZXJzKSB7CiAgICAgIGNvbnN0IHdyaXRlciA9IGF3YWl0IHRoaXMuX2dldFdyaXRlckJ5S2V5KGhlYWQua2V5LCBoZWFkLmxlbmd0aCwgMCwgZmFsc2UsIGZhbHNlLCBzeXMpCiAgICAgIGluZGV4ZXJzLnB1c2god3JpdGVyKQogICAgfQoKICAgIGlmICghdGhpcy5faXNBY3RpdmVJbmRleGVyKCkpIHsKICAgICAgZm9yIChjb25zdCBrZXkgb2Ygc3lzLnBlbmRpbmdJbmRleGVycykgewogICAgICAgIGlmIChiNGEuZXF1YWxzKGtleSwgdGhpcy5sb2NhbC5rZXkpKSB7CiAgICAgICAgICB0aGlzLl9zZXRMb2NhbEluZGV4ZXIoKQogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLl91cGRhdGVMaW5lYXJpemVyKGluZGV4ZXJzLCBzeXMuaGVhZHMpCgogICAgZm9yIChjb25zdCB7IGtleSwgbGVuZ3RoIH0gb2Ygc3lzLmhlYWRzKSB7CiAgICAgIGF3YWl0IHRoaXMuX2dldFdyaXRlckJ5S2V5KGtleSwgbGVuZ3RoLCAwLCBmYWxzZSwgZmFsc2UsIHN5cykKICAgIH0KICB9CgogIGFzeW5jIF9jbGVhcldyaXRlcnMoKSB7CiAgICBhd2FpdCB0aGlzLmFjdGl2ZVdyaXRlcnMuY2xlYXIoKQogICAgaWYgKHRoaXMubG9jYWxXcml0ZXIgIT09IG51bGwpIGF3YWl0IHRoaXMubG9jYWxXcml0ZXIuY2xvc2UoKQogICAgdGhpcy5fY2hlY2tXcml0ZXJzID0gW10KICB9CgogIGFzeW5jIF9tYWtlTGluZWFyaXplckZyb21WaWV3U3RhdGUoKSB7CiAgICBjb25zdCBzeXMgPSBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmdldEluZGV4ZWRTeXN0ZW0oKQogICAgYXdhaXQgdGhpcy5fbWFrZUxpbmVhcml6ZXIoc3lzKQogICAgYXdhaXQgc3lzLmNsb3NlKCkKICB9CgogIGFzeW5jIF9ydW5Gb3JjZUZhc3RGb3J3YXJkKCkgewogICAgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybgogICAgY29uc3QgcmVjID0gdGhpcy5fYXBwbHlTdGF0ZSA/IGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUucmVjb3ZlckF0KCkgOiBudWxsCiAgICBhd2FpdCB0aGlzLl9ydW5GYXN0Rm9yd2FyZCgKICAgICAgbmV3IEZhc3RGb3J3YXJkKHRoaXMsIHRoaXMuY29yZS5rZXksIHsgZm9yY2U6IHRydWUsIGxlbmd0aDogcmVjID8gcmVjLmxlbmd0aCA6IDAgfSkKICAgICkKICB9CgogIC8vIGdlbmVyYWwgcmVwYWlyIG1ldGhvZCBmb3IgdHJ5aW5nIHRvIHJlY292ZXIKICBhc3luYyByZXBhaXIoKSB7CiAgICBhd2FpdCB0aGlzLmZvcmNlRmFzdEZvcndhcmQoKQogIH0KCiAgYXN5bmMgZm9yY2VGYXN0Rm9yd2FyZCgpIHsKICAgIGlmICh0aGlzLmlzRmFzdEZvcndhcmRpbmcoKSkgcmV0dXJuCiAgICBhd2FpdCB0aGlzLl9ydW5Gb3JjZUZhc3RGb3J3YXJkKCkKICAgIGF3YWl0IHRoaXMudXBkYXRlKCkKICB9CgogIGFzeW5jIF9hcHBseUZhc3RGb3J3YXJkKCkgewogICAgaWYgKAogICAgICAhdGhpcy5mYXN0Rm9yd2FyZFRvLmZvcmNlICYmCiAgICAgIHRoaXMuZmFzdEZvcndhcmRUby5sZW5ndGggPCB0aGlzLmNvcmUubGVuZ3RoICsgdGhpcy5mYXN0Rm9yd2FyZFRvLm1pbmltdW0KICAgICkgewogICAgICB0aGlzLmZhc3RGb3J3YXJkVG8gPSBudWxsCiAgICAgIHRoaXMuX3VwZGF0ZUFjdGl2aXR5KCkKICAgICAgLy8gc3RpbGwgbm90IHdvcnRoIGl0CiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IGNoYW5nZXMgPSB0aGlzLl9oYXNVcGRhdGUgPyBuZXcgVXBkYXRlQ2hhbmdlcyh0aGlzKSA6IG51bGwKICAgIGlmIChjaGFuZ2VzKSBjaGFuZ2VzLnRyYWNrKHRoaXMuX2FwcGx5U3RhdGUpCgogICAgLy8gY2xvc2UgZXhpc3Rpbmcgc3RhdGUKICAgIGlmICh0aGlzLl9hcHBseVN0YXRlKSBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmNsb3NlKCkKCiAgICBjb25zdCB7IGtleSwgbGVuZ3RoLCB2aWV3cywgaW5kZXhlcnMsIG1hbmlmZXN0VmVyc2lvbiwgZW50cm9weSB9ID0gdGhpcy5mYXN0Rm9yd2FyZFRvCgogICAgY29uc3QgZnJvbSA9IHRoaXMuY29yZS5zaWduZWRMZW5ndGgKICAgIGNvbnN0IGZmZWQgPSBuZXcgU2V0KCkKCiAgICB0aGlzLl9mbHVzaGluZysrCiAgICB0cnkgewogICAgICBjb25zdCBzdG9yZSA9IHRoaXMuX3ZpZXdTdG9yZS5hdG9taXplKCkKCiAgICAgIGNvbnN0IG1pZ3JhdGVkID0gIWI0YS5lcXVhbHMoa2V5LCB0aGlzLmNvcmUua2V5KQoKICAgICAgY29uc3Qgc3lzdGVtUmVmID0gYXdhaXQgdGhpcy5fdmlld1N0b3JlLmZpbmRWaWV3QnlLZXkoa2V5LCBpbmRleGVycywgbWFuaWZlc3RWZXJzaW9uLCBlbnRyb3B5KQogICAgICBmZmVkLmFkZChzeXN0ZW1SZWYpCgogICAgICBpZiAobWlncmF0ZWQpIHsKICAgICAgICBhd2FpdCB0aGlzLl9hcHBseUZhc3RGb3J3YXJkTWlncmF0aW9uKHN5c3RlbVJlZiwgeyBrZXksIGxlbmd0aCB9KQogICAgICB9IGVsc2UgewogICAgICAgIGF3YWl0IHN5c3RlbVJlZi5jYXRjaHVwKHN0b3JlLmF0b20sIGxlbmd0aCkKICAgICAgfQoKICAgICAgZm9yIChjb25zdCB2IG9mIHZpZXdzKSB7CiAgICAgICAgY29uc3QgcmVmID0gYXdhaXQgdGhpcy5fdmlld1N0b3JlLmZpbmRWaWV3QnlLZXkodi5rZXksIGluZGV4ZXJzLCBtYW5pZmVzdFZlcnNpb24sIGVudHJvcHkpCiAgICAgICAgaWYgKCFyZWYpIGNvbnRpbnVlIC8vIHVua25vd24sIHZpZXcgaWdub3JlZAogICAgICAgIGZmZWQuYWRkKHJlZikKCiAgICAgICAgaWYgKG1pZ3JhdGVkKSB7CiAgICAgICAgICBhd2FpdCB0aGlzLl9hcHBseUZhc3RGb3J3YXJkTWlncmF0aW9uKHJlZiwgdikKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXdhaXQgcmVmLmNhdGNodXAoc3RvcmUuYXRvbSwgdi5sZW5ndGgpCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoZmZlZC5zaXplICE9PSBzdG9yZS5nZXRWaWV3Q291bnQoKSkgewogICAgICAgIGZvciAoY29uc3QgcmVmIG9mIHN0b3JlLmdldFZpZXdzKCkpIHsKICAgICAgICAgIGlmIChmZmVkLmhhcyhyZWYpKSBjb250aW51ZQogICAgICAgICAgYXdhaXQgcmVmLmNhdGNodXAoc3RvcmUuYXRvbSwgMCkgLy8gaXRzIGdvbmUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIG1pZ3JhdGUgemVybyBsZW5ndGggY29yZXMKICAgICAgaWYgKG1pZ3JhdGVkKSB7CiAgICAgICAgY29uc3QgbWFuaWZlc3RzID0gYXdhaXQgdGhpcy5fdmlld1N0b3JlLmdldEluZGV4ZXJNYW5pZmVzdHMoaW5kZXhlcnMpCgogICAgICAgIGZvciAoY29uc3QgW25hbWUsIHJlZl0gb2YgdGhpcy5fdmlld1N0b3JlLmJ5TmFtZSkgewogICAgICAgICAgaWYgKGZmZWQuaGFzKHJlZikpIGNvbnRpbnVlCiAgICAgICAgICBhd2FpdCB0aGlzLl9taWdyYXRlVmlldyhtYW5pZmVzdHMsIG51bGwsIG5hbWUsIDAsIG1hbmlmZXN0VmVyc2lvbiwgZW50cm9weSwgW10sIG51bGwpCiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCB2YWx1ZSA9IGMuZW5jb2RlKG1lc3NhZ2VzLkJvb3RSZWNvcmQsIHsKICAgICAgICB2ZXJzaW9uOiBCT09UX1JFQ09SRF9WRVJTSU9OLAogICAgICAgIGtleSwKICAgICAgICBzeXN0ZW1MZW5ndGg6IGxlbmd0aCwKICAgICAgICBpbmRleGVyc1VwZGF0ZWQ6IGZhbHNlLAogICAgICAgIGZhc3RGb3J3YXJkaW5nOiB0cnVlLAogICAgICAgIHJlY292ZXJpZXM6IFJFQ09WRVJJRVMKICAgICAgfSkKCiAgICAgIGNvbnN0IGxvY2FsID0gc3RvcmUuZ2V0TG9jYWwoKQogICAgICBhd2FpdCBsb2NhbC5yZWFkeSgpCiAgICAgIGF3YWl0IGxvY2FsLnNldFVzZXJEYXRhKCdhdXRvYmFzZS9ib290JywgdmFsdWUpCgogICAgICBhd2FpdCBMb2NhbFN0YXRlLmNsZWFyKGxvY2FsKQoKICAgICAgaWYgKGNoYW5nZXMpIGNoYW5nZXMuZmluYWxpc2UoKQoKICAgICAgYXdhaXQgc3RvcmUuZmx1c2goKQogICAgICBhd2FpdCBzdG9yZS5jbG9zZSgpCiAgICB9IGZpbmFsbHkgewogICAgICBpZiAoLS10aGlzLl9mbHVzaGluZyA9PT0gMCkgdGhpcy5fZmx1c2hTaWduYWwubm90aWZ5KCkKICAgIH0KCiAgICBjb25zdCB0byA9IHRoaXMuY29yZS5zaWduZWRMZW5ndGgKCiAgICBmb3IgKGNvbnN0IHJlZiBvZiBmZmVkKSBhd2FpdCByZWYucmVsZWFzZSgpCgogICAgdGhpcy5yZWNvdmVyaWVzID0gUkVDT1ZFUklFUwogICAgdGhpcy5mYXN0Rm9yd2FyZFRvID0gbnVsbAogICAgdGhpcy5fcXVldWVGYXN0Rm9yd2FyZCgpCgogICAgYXdhaXQgdGhpcy5fY2xlYXJXcml0ZXJzKCkKCiAgICB0aGlzLl9hcHBseVN0YXRlID0gbmV3IEFwcGx5U3RhdGUodGhpcykKICAgIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUucmVhZHkoKQoKICAgIGlmIChjaGFuZ2VzKSBhd2FpdCB0aGlzLl9oYW5kbGVycy51cGRhdGUodGhpcy5fYXBwbHlTdGF0ZS52aWV3LCBjaGFuZ2VzKQoKICAgIGlmIChhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnNob3VsZE1pZ3JhdGUoKSkgewogICAgICBhd2FpdCB0aGlzLl9taWdyYXRlKCkKICAgIH0gZWxzZSB7CiAgICAgIGF3YWl0IHRoaXMuX21ha2VMaW5lYXJpemVyRnJvbVZpZXdTdGF0ZSgpCiAgICAgIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuY2F0Y2h1cCh0aGlzLmxpbmVhcml6ZXIpCiAgICB9CgogICAgaWYgKCF0aGlzLmxvY2FsV3JpdGVyIHx8IHRoaXMubG9jYWxXcml0ZXIuY2xvc2VkKSB7CiAgICAgIGF3YWl0IHRoaXMuX3VwZGF0ZUxvY2FsV3JpdGVyKHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtKQogICAgfQoKICAgIHRoaXMuX2NhdWdodHVwID0gdHJ1ZQoKICAgIHRoaXMuX3JlYm9vdGVkKCkKICAgIHRoaXMuZW1pdCgnZmFzdC1mb3J3YXJkJywgdG8sIGZyb20pCiAgfQoKICAvLyBUT0RPOiBub3QgYXRvbWljIGluIHJlZ2FyZHMgdG8gdGhlIGZmLCBmaXggdGhhdAogIGFzeW5jIF9hcHBseUZhc3RGb3J3YXJkTWlncmF0aW9uKHJlZiwgdikgewogICAgY29uc3QgbmV4dCA9IHRoaXMuc3RvcmUuZ2V0KHYua2V5KQogICAgYXdhaXQgbmV4dC5yZWFkeSgpCgogICAgY29uc3QgcHJvbG9ndWUgPSBuZXh0Lm1hbmlmZXN0ICYmIG5leHQubWFuaWZlc3QucHJvbG9ndWUKCiAgICBpZiAocHJvbG9ndWUgJiYgcHJvbG9ndWUubGVuZ3RoID4gMCAmJiByZWYuY29yZS5sZW5ndGggPj0gcHJvbG9ndWUubGVuZ3RoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgbmV4dC5jb3JlLmNvcHlQcm9sb2d1ZShyZWYuY29yZS5zdGF0ZSkKICAgICAgfSBjYXRjaCB7CiAgICAgICAgLy8gd2UgbWlnaHQgYmUgbWlzc2luZyBzb21lIG5vZGVzIGZvciB0aGlzLCBqdXN0IGlnbm9yZSwgb25seSBhbiBvcHRpbWlzYXRpb24KICAgICAgfQogICAgfQoKICAgIGNvbnN0IGJhdGNoID0gbmV4dC5zZXNzaW9uKHsgbmFtZTogJ2JhdGNoJywgb3ZlcndyaXRlOiB0cnVlLCBjaGVja291dDogdi5sZW5ndGggfSkKICAgIGF3YWl0IGJhdGNoLnJlYWR5KCkKCiAgICAvLyByZW1ha2UgdGhlIGJhdGNoLCByZXNldCBmcm9tIG91ciBwcm9sb2d1ZSBpbiBjYXNlIGl0IHJlcGxpY2F0ZWQgaW5iZXR3ZWVuCiAgICAvLyBUT0RPOiB3ZSBzaG91bGQgcmVhbGx5IGhhdmUgYW4gSEMgZnVuY3Rpb24gZm9yIHRoaXMKCiAgICBhd2FpdCByZWYuYmF0Y2guc3RhdGUubW92ZVRvKGJhdGNoLCBiYXRjaC5sZW5ndGgpCiAgICBhd2FpdCBiYXRjaC5jbG9zZSgpCgogICAgcmVmLm1pZ3JhdGVkKHRoaXMsIG5leHQpCiAgfQoKICBhc3luYyBfbWlncmF0ZVZpZXcoCiAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgc291cmNlLAogICAgbmFtZSwKICAgIGluZGV4ZWRMZW5ndGgsCiAgICBtYW5pZmVzdFZlcnNpb24sCiAgICBlbnRyb3B5LAogICAgbGlua2VkLAogICAgbWFuaWZlc3REYXRhCiAgKSB7CiAgICBjb25zdCByZWYgPSB0aGlzLl92aWV3U3RvcmUuYnlOYW1lLmdldChuYW1lKQoKICAgIGNvbnN0IHByb2xvZ3VlID0KICAgICAgaW5kZXhlZExlbmd0aCA9PT0gMAogICAgICAgID8gbnVsbAogICAgICAgIDogeyBsZW5ndGg6IGluZGV4ZWRMZW5ndGgsIGhhc2g6IGF3YWl0IHNvdXJjZS50cmVlSGFzaChpbmRleGVkTGVuZ3RoKSB9CgogICAgaWYgKG1hbmlmZXN0RGF0YSA9PT0gbnVsbCAmJiByZWYuY29yZS5tYW5pZmVzdC51c2VyRGF0YSAhPT0gbnVsbCkgewogICAgICBtYW5pZmVzdERhdGEgPSByZWYuY29yZS5tYW5pZmVzdC51c2VyRGF0YQogICAgfQoKICAgIGNvbnN0IG5leHQgPSB0aGlzLl92aWV3U3RvcmUuZ2V0Vmlld0NvcmUoCiAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgIG5hbWUsCiAgICAgIHByb2xvZ3VlLAogICAgICBtYW5pZmVzdFZlcnNpb24sCiAgICAgIGVudHJvcHksCiAgICAgIGxpbmtlZCwKICAgICAgbWFuaWZlc3REYXRhCiAgICApCiAgICBhd2FpdCBuZXh0LnJlYWR5KCkKCiAgICBpZiAoaW5kZXhlZExlbmd0aCA+IDApIHsKICAgICAgYXdhaXQgbmV4dC5jb3JlLmNvcHlQcm9sb2d1ZShzb3VyY2Uuc3RhdGUpCiAgICB9CgogICAgLy8gcmVtYWtlIHRoZSBiYXRjaCwgcmVzZXQgZnJvbSBvdXIgcHJvbG9ndWUgaW4gY2FzZSBpdCByZXBsaWNhdGVkIGluYmV0d2VlbgogICAgLy8gVE9ETzogd2Ugc2hvdWxkIHJlYWxseSBoYXZlIGFuIEhDIGZ1bmN0aW9uIGZvciB0aGlzCiAgICBjb25zdCBiYXRjaCA9IG5leHQuc2Vzc2lvbih7IG5hbWU6ICdiYXRjaCcsIG92ZXJ3cml0ZTogdHJ1ZSwgY2hlY2tvdXQ6IGluZGV4ZWRMZW5ndGggfSkKICAgIGF3YWl0IGJhdGNoLnJlYWR5KCkKCiAgICBpZiAoc291cmNlICE9PSBudWxsKSB7CiAgICAgIHdoaWxlIChiYXRjaC5sZW5ndGggPCBzb3VyY2UubGVuZ3RoKSB7CiAgICAgICAgYXdhaXQgYmF0Y2guYXBwZW5kKGF3YWl0IHNvdXJjZS5nZXQoYmF0Y2gubGVuZ3RoKSkKICAgICAgfQogICAgfQoKICAgIGF3YWl0IHJlZi5iYXRjaC5zdGF0ZS5tb3ZlVG8oYmF0Y2gsIGJhdGNoLmxlbmd0aCkKICAgIGF3YWl0IGJhdGNoLmNsb3NlKCkKCiAgICByZWYubWlncmF0ZWQodGhpcywgbmV4dCkKCiAgICByZXR1cm4gcmVmCiAgfQoKICBhc3luYyBfcHJlbWlncmF0ZSgpIHsKICAgIHRoaXMuX2ZsdXNoaW5nKysKICAgIHRyeSB7CiAgICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuX2FwcGx5U3RhdGUuaW5kZXhlZExlbmd0aAogICAgICBjb25zdCBzeXN0ZW0gPSB0aGlzLl9hcHBseVN0YXRlLnN5c3RlbQoKICAgICAgY29uc3QgaW5mbyA9IGF3YWl0IHN5c3RlbS5nZXRJbmRleGVkSW5mbyhsZW5ndGgpCiAgICAgIGNvbnN0IGluZGV4ZXJNYW5pZmVzdHMgPSBhd2FpdCB0aGlzLl92aWV3U3RvcmUuZ2V0SW5kZXhlck1hbmlmZXN0cyhpbmZvLmluZGV4ZXJzKQoKICAgICAgY29uc3QgeyB2aWV3cywgc3lzdGVtVmlldywgZW5jcnlwdGlvblZpZXcgfSA9IHRoaXMuX2FwcGx5U3RhdGUKCiAgICAgIGNvbnN0IG1hbmlmZXN0VmVyc2lvbiA9IHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmNvcmUubWFuaWZlc3QudmVyc2lvbgoKICAgICAgZm9yIChjb25zdCB2aWV3IG9mIHZpZXdzKSB7CiAgICAgICAgY29uc3QgdiA9IHRoaXMuX2FwcGx5U3RhdGUuZ2V0Vmlld0Zyb21TeXN0ZW0odmlldywgaW5mbykKICAgICAgICBjb25zdCBpbmRleGVkTGVuZ3RoID0gdiA/IHYubGVuZ3RoIDogMAoKICAgICAgICBjb25zdCByZWYgPSB0aGlzLl92aWV3U3RvcmUuZ2V0Vmlld0J5TmFtZSh2aWV3Lm5hbWUpCiAgICAgICAgY29uc3Qgc291cmNlID0gcmVmLmdldENvcmUoKQogICAgICAgIGF3YWl0IHNvdXJjZS5yZWFkeSgpCgogICAgICAgIGF3YWl0IHRoaXMuX21pZ3JhdGVWaWV3KAogICAgICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgICAgIHNvdXJjZSwKICAgICAgICAgIHZpZXcubmFtZSwKICAgICAgICAgIGluZGV4ZWRMZW5ndGgsCiAgICAgICAgICBtYW5pZmVzdFZlcnNpb24sCiAgICAgICAgICBpbmZvLmVudHJvcHksCiAgICAgICAgICBudWxsLAogICAgICAgICAgbnVsbAogICAgICAgICkKICAgICAgfQoKICAgICAgY29uc3Qgc291cmNlID0gZW5jcnlwdGlvblZpZXcucmVmLmdldENvcmUoKQogICAgICBhd2FpdCBzb3VyY2UucmVhZHkoKQoKICAgICAgY29uc3QgZW5jID0gYXdhaXQgdGhpcy5fbWlncmF0ZVZpZXcoCiAgICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgICBzb3VyY2UsCiAgICAgICAgJ19lbmNyeXB0aW9uJywKICAgICAgICBpbmZvLmVuY3J5cHRpb25MZW5ndGgsCiAgICAgICAgbWFuaWZlc3RWZXJzaW9uLAogICAgICAgIGluZm8uZW50cm9weSwKICAgICAgICBudWxsLAogICAgICAgIG51bGwKICAgICAgKQoKICAgICAgY29uc3QgbGlua2VkID0gW2VuYy5jb3JlLmtleV0KCiAgICAgIGNvbnN0IHN5c0NvcmUgPSBzeXN0ZW1WaWV3LnJlZi5nZXRDb3JlKCkKICAgICAgY29uc3QgcmVmID0gYXdhaXQgdGhpcy5fbWlncmF0ZVZpZXcoCiAgICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgICBzeXNDb3JlLAogICAgICAgICdfc3lzdGVtJywKICAgICAgICBsZW5ndGgsCiAgICAgICAgbWFuaWZlc3RWZXJzaW9uLAogICAgICAgIGluZm8uZW50cm9weSwKICAgICAgICBsaW5rZWQsCiAgICAgICAgbnVsbCwKICAgICAgICBudWxsCiAgICAgICkKCiAgICAgIHJldHVybiByZWYuY29yZS5rZXkKICAgIH0gZmluYWxseSB7CiAgICAgIGlmICgtLXRoaXMuX2ZsdXNoaW5nID09PSAwKSB0aGlzLl9mbHVzaFNpZ25hbC5ub3RpZnkoKQogICAgfQogIH0KCiAgYXN5bmMgX21pZ3JhdGUoKSB7CiAgICByZXR1cm4gdGhpcy5fcmVib290KGF3YWl0IHRoaXMuX3ByZW1pZ3JhdGUoKSkKICB9CgogIGFzeW5jIF9yZWJvb3Qoa2V5KSB7CiAgICBhd2FpdCB0aGlzLl9jbGVhcldyaXRlcnMoKQogICAgYXdhaXQgdGhpcy5fbWFrZUxpbmVhcml6ZXJGcm9tVmlld1N0YXRlKCkKCiAgICBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmZpbmFsaXplKGtleSkKCiAgICB0aGlzLl9hcHBseVN0YXRlID0gbmV3IEFwcGx5U3RhdGUodGhpcykKCiAgICBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnJlYWR5KCkKICAgIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuY2F0Y2h1cCh0aGlzLmxpbmVhcml6ZXIpCgogICAgLy8gZW5kIHNvZnQgc2h1dGRvd24KCiAgICB0aGlzLl9xdWV1ZUZhc3RGb3J3YXJkKCkKCiAgICB0aGlzLl9yZWJvb3RlZCgpCiAgfQoKICBfcmVib290ZWQoKSB7CiAgICB0aGlzLnJlY291cGxlKCkKICAgIHRoaXMuX3VwZGF0ZUFjdGl2aXR5KCkKCiAgICB0aGlzLmVtaXQoJ3JlYm9vdCcpCgogICAgLy8gZW5zdXJlIHdlIHJlLWV2YWx1dGUgb3VyIHN0YXRlCiAgICB0aGlzLl9ib290c3RyYXBXcml0ZXJzQ2hhbmdlZCA9IHRydWUKICAgIHRoaXMuX25lZWRzV2FrZXVwID0gdHJ1ZQoKICAgIHRoaXMudXBkYXRpbmcgPSB0cnVlCiAgICB0aGlzLl9xdWV1ZUJ1bXAoKQogIH0KCiAgX3NldExvY2FsV3JpdGVyKHcpIHsKICAgIHRoaXMubG9jYWxXcml0ZXIgPSB3CiAgICBpZiAodGhpcy5fYWNrSW50ZXJ2YWwpIHRoaXMuX3N0YXJ0QWNrVGltZXIoKQogIH0KCiAgX3Vuc2V0TG9jYWxXcml0ZXIoKSB7CiAgICBpZiAoIXRoaXMubG9jYWxXcml0ZXIpIHJldHVybgoKICAgIHRoaXMuX2Nsb3NlV3JpdGVyKHRoaXMubG9jYWxXcml0ZXIpCiAgICBpZiAodGhpcy5sb2NhbFdyaXRlci5pc0FjdGl2ZUluZGV4ZXIpIHRoaXMuX2NsZWFyTG9jYWxJbmRleGVyKCkKCiAgICB0aGlzLmxvY2FsV3JpdGVyID0gbnVsbAogIH0KCiAgX3NldExvY2FsSW5kZXhlcigpIHsKICAgIGFzc2VydCh0aGlzLmxvY2FsV3JpdGVyICE9PSBudWxsKQoKICAgIHRoaXMuaXNJbmRleGVyID0gdHJ1ZQogICAgdGhpcy5lbWl0KCdpcy1pbmRleGVyJykKICB9CgogIF9jbGVhckxvY2FsSW5kZXhlcigpIHsKICAgIGFzc2VydCh0aGlzLmxvY2FsV3JpdGVyICE9PSBudWxsKQoKICAgIGlmICh0aGlzLl9hY2tUaW1lcikgdGhpcy5fYWNrVGltZXIuc3RvcCgpCgogICAgdGhpcy5pc0luZGV4ZXIgPSBmYWxzZQogICAgdGhpcy5fYWNrVGltZXIgPSBudWxsCgogICAgdGhpcy5lbWl0KCdpcy1ub24taW5kZXhlcicpCiAgfQoKICBfaXNMb2NhbENvcmUoY29yZSkgewogICAgcmV0dXJuIGNvcmUud3JpdGFibGUgJiYgY29yZS5pZCA9PT0gdGhpcy5sb2NhbC5pZAogIH0KCiAgX2FkZExvY2FsSGVhZHMoKSB7CiAgICAvLyBub3Qgd3JpdGFibGUgYXRtLCB3aWxsIHByb3AgYmUgd3JpdGFibGUgaW4gYSBzdWJzZXF1ZW50IGJ1bXAgdGhvCiAgICBpZiAoIXRoaXMubG9jYWxXcml0ZXIgfHwgdGhpcy5sb2NhbFdyaXRlci5jbG9zZWQpIHJldHVybiBudWxsCiAgICAvLyBzYWZldHksIGxvY2Fsd3JpdGVyIGlzIHN0aWxsIHByb2Nlc3NpbmcsIHNob3VsZCBwcm9wIGJlIGFuIGFzc2VydGlvbgogICAgaWYgKCF0aGlzLmxvY2FsV3JpdGVyLmlkbGUoKSkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBsZW5ndGggPSB0aGlzLl9vcHRpbWlzdGljID09PSAtMSA/IHRoaXMuX2FwcGVuZGluZy5sZW5ndGggOiB0aGlzLl9vcHRpbWlzdGljIHx8IDEKCiAgICBjb25zdCBub2RlcyA9IG5ldyBBcnJheShsZW5ndGgpCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGhlYWRzID0gdGhpcy5saW5lYXJpemVyLmdldEhlYWRzKCkKICAgICAgY29uc3QgZGVwcyA9IG5ldyBTZXQodGhpcy5saW5lYXJpemVyLmhlYWRzKQogICAgICBjb25zdCBiYXRjaCA9IGxlbmd0aCAtIGkKICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9hcHBlbmRpbmdbaV0KCiAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLmxvY2FsV3JpdGVyLmFwcGVuZCh2YWx1ZSwgaGVhZHMsIGJhdGNoLCBkZXBzLCB0aGlzLl9vcHRpbWlzdGljID09PSAwKQoKICAgICAgdGhpcy5saW5lYXJpemVyLmFkZEhlYWQobm9kZSkKICAgICAgbm9kZXNbaV0gPSBub2RlCiAgICB9CgogICAgcmV0dXJuIG5vZGVzCiAgfQoKICBfZmx1c2hMb2NhbEhlYWRzKGxlbmd0aCkgewogICAgdGhpcy5fYXBwZW5kaW5nID0gbGVuZ3RoID09PSB0aGlzLl9hcHBlbmRpbmcubGVuZ3RoID8gbnVsbCA6IHRoaXMuX2FwcGVuZGluZy5zbGljZShsZW5ndGgpCiAgICB0aGlzLl9hcHBlbmRlZCArPSBsZW5ndGgKCiAgICBpZiAodGhpcy5fb3B0aW1pc3RpYyA+IC0xICYmIHRoaXMuX29wdGltaXN0aWMgPCBsZW5ndGgpIHRoaXMuX29wdGltaXN0aWMgPSAtMQogIH0KCiAgYXN5bmMgX2FkZFJlbW90ZUhlYWRzKCkgewogICAgbGV0IGFkZGVkID0gMAoKICAgIHdoaWxlICgKICAgICAgYWRkZWQgPCBSRU1PVEVfQUREX0JBVENIIHx8CiAgICAgICh0aGlzLmJpZ0JhdGNoZXMgJiYgIXRoaXMuX2luZGV4ZXJzSWRsZSgpICYmIGFkZGVkIDwgUkVNT1RFX0FERF9CQVRDSF9TQU5JVFkpCiAgICApIHsKICAgICAgYXdhaXQgdGhpcy5fdXBkYXRlQWxsKCkKCiAgICAgIGxldCBhZHZhbmNlZCA9IDAKCiAgICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLmFjdGl2ZVdyaXRlcnMpIHsKICAgICAgICBsZXQgbm9kZSA9IHcuYWR2YW5jZSgpCiAgICAgICAgaWYgKG5vZGUgPT09IG51bGwpIGNvbnRpbnVlCgogICAgICAgIGFkdmFuY2VkICs9IG5vZGUuYmF0Y2gKCiAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgIHRoaXMubGluZWFyaXplci5hZGRIZWFkKG5vZGUpCiAgICAgICAgICBpZiAobm9kZS5iYXRjaCA9PT0gMSkgYnJlYWsKICAgICAgICAgIG5vZGUgPSB3LmFkdmFuY2UoKQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGFkdmFuY2VkID09PSAwKSB7CiAgICAgICAgaWYgKHRoaXMuYmlnQmF0Y2hlcyAmJiAhdGhpcy5faW5kZXhlcnNJZGxlKCkgJiYgKGF3YWl0IHRoaXMuX3dhaXRGb3JJbmRleGVycygpKSkgY29udGludWUKICAgICAgICBicmVhawogICAgICB9CgogICAgICBhZGRlZCArPSBhZHZhbmNlZAogICAgfQoKICAgIHJldHVybiBhZGRlZAogIH0KCiAgYXN5bmMgX3dhaXRGb3JJbmRleGVycygpIHsKICAgIGNvbnN0IHByb21pc2VzID0gW10KCiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5saW5lYXJpemVyLmluZGV4ZXJzKSB7CiAgICAgIGlmICh3LmlkbGUoKSkgY29udGludWUKICAgICAgaWYgKGF3YWl0IHcuY29yZS5oYXMody5sZW5ndGgpKSBjb250aW51ZQogICAgICBwcm9taXNlcy5wdXNoKHcuY29yZS5nZXQody5sZW5ndGgsIHsgdGltZW91dDogMzAwMCB9KSkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHJlc3VsdCBvZiBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQocHJvbWlzZXMpKSB7CiAgICAgIGlmIChyZXN1bHQuc3RhdHVzICE9PSAncmVqZWN0ZWQnKSByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX2luZGV4ZXJzSWRsZSgpIHsKICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLmxpbmVhcml6ZXIuaW5kZXhlcnMpIHsKICAgICAgaWYgKCF3LmlkbGUoKSkgcmV0dXJuIGZhbHNlCiAgICB9CiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgX2RyYWluKCkgewogICAgY29uc3Qgd3JpdGFibGUgPSB0aGlzLndyaXRhYmxlCgogICAgd2hpbGUgKCF0aGlzLl9pbnRlcnJ1cHRpbmcgJiYgIXRoaXMucGF1c2VkKSB7CiAgICAgIGlmICh0aGlzLmZhc3RGb3J3YXJkVG8gIT09IG51bGwpIHsKICAgICAgICBhd2FpdCB0aGlzLl9hcHBseUZhc3RGb3J3YXJkKCkKICAgICAgICBjb250aW51ZSAvLyByZXZhbHVhdGUgY29uZGl0aW9ucy4uLgogICAgICB9CgogICAgICAvLyB3ZSBkZWZlciB0aGlzIHRvIHBvc3QgcmVhZHkgc28gaXRzIG5vdCBibG9ja2luZyByZWFkaW5nIHRoZSB2aWV3cwogICAgICBpZiAodGhpcy5fY2F1Z2h0dXAgPT09IGZhbHNlKSB7CiAgICAgICAgLy8gaWYgdGhlIGNhdGNodXAgZmFpbHMsIGp1c3QgZm9yY2UgZmYgaXQgdG8gcmVjb3ZlciwgbGVzcyB1c2VyIHBhaW4KICAgICAgICBpZiAoIShhd2FpdCB0aGlzLl9jYXRjaHVwQXBwbHlTdGF0ZSgpKSkgewogICAgICAgICAgYXdhaXQgdGhpcy5fcnVuRm9yY2VGYXN0Rm9yd2FyZCgpCiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGNvbnN0IHJlbW90ZUFkZGVkID0gYXdhaXQgdGhpcy5fYWRkUmVtb3RlSGVhZHMoKQogICAgICBjb25zdCBsb2NhbE5vZGVzID0gdGhpcy5fYXBwZW5kaW5nICE9PSBudWxsID8gdGhpcy5fYWRkTG9jYWxIZWFkcygpIDogbnVsbAoKICAgICAgaWYgKHRoaXMuX2ludGVycnVwdGluZykgcmV0dXJuCgogICAgICBpZiAocmVtb3RlQWRkZWQgPiAwIHx8IGxvY2FsTm9kZXMgIT09IG51bGwpIHsKICAgICAgICB0aGlzLnVwZGF0aW5nID0gdHJ1ZQogICAgICB9CgogICAgICBjb25zdCB1ID0gdGhpcy5saW5lYXJpemVyLnVwZGF0ZSgpCiAgICAgIGNvbnN0IHVwZGF0ZSA9IHUKICAgICAgICA/IGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUudXBkYXRlKHUsIGxvY2FsTm9kZXMpCiAgICAgICAgOiB7IHJlYm9vdDogZmFsc2UsIG1pZ3JhdGVkOiBmYWxzZSB9CgogICAgICBpZiAobG9jYWxOb2RlcykgdGhpcy5fZmx1c2hMb2NhbEhlYWRzKGxvY2FsTm9kZXMubGVuZ3RoKQoKICAgICAgaWYgKCF1cGRhdGUucmVib290KSB7CiAgICAgICAgaWYgKHRoaXMuX2FwcGx5U3RhdGUuc2hvdWxkRmx1c2goKSkgewogICAgICAgICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5mbHVzaCgpCiAgICAgICAgICB0aGlzLnVwZGF0aW5nID0gdHJ1ZQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2NoZWNrV3JpdGVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICBhd2FpdCB0aGlzLl9nY1dyaXRlcnMoKQogICAgICAgICAgY29udGludWUgLy8gcmVydW4gdGhlIHVwZGF0ZSBsb29wIGFzIGEgd3JpdGVyIG1pZ2h0IGhhdmUgYmVlbiBhZGRlZAogICAgICAgIH0KICAgICAgICBpZiAocmVtb3RlQWRkZWQgPj0gUkVNT1RFX0FERF9CQVRDSCkgY29udGludWUKICAgICAgICBicmVhawogICAgICB9CgogICAgICBhd2FpdCB0aGlzLl9nY1dyaXRlcnMoKQogICAgICBhd2FpdCB0aGlzLl9yZWJvb3QodGhpcy5fYXBwbHlTdGF0ZS5rZXkpCiAgICB9CgogICAgLy8gZW1pdCBzdGF0ZSBjaGFuZ2VzIHBvc3QgZHJhaW4KICAgIGlmICh3cml0YWJsZSAhPT0gdGhpcy53cml0YWJsZSkgewogICAgICBpZiAodGhpcy53cml0YWJsZSAmJiB0aGlzLl93cml0YWJsZSkgdGhpcy5fd3JpdGFibGUucmVzb2x2ZSh0cnVlKQogICAgICB0aGlzLmVtaXQod3JpdGFibGUgPyAndW53cml0YWJsZScgOiAnd3JpdGFibGUnKQogICAgfQogIH0KCiAgX3dha2V1cFBlZXIoc3RyZWFtKSB7CiAgICBpZiAoIXRoaXMud2FrZXVwU2Vzc2lvbikgcmV0dXJuCiAgICBjb25zdCB3YWtldXAgPSB0aGlzLl9nZXRXYWtldXAoKQogICAgaWYgKHdha2V1cC5sZW5ndGggPT09IDApIHJldHVybgogICAgdGhpcy53YWtldXBTZXNzaW9uLmFubm91bmNlQnlTdHJlYW0oc3RyZWFtLCB3YWtldXApCiAgfQoKICBfZ2V0V2FrZXVwKCkgewogICAgY29uc3Qgd3JpdGVycyA9IFtdCgogICAgZm9yIChjb25zdCB3IG9mIHRoaXMuYWN0aXZlV3JpdGVycykgewogICAgICBpZiAody5pc0FjdGl2ZUluZGV4ZXIgfHwgdy5mbHVzaGVkKCkpIGNvbnRpbnVlCiAgICAgIHdyaXRlcnMucHVzaCh7IGtleTogdy5jb3JlLmtleSwgbGVuZ3RoOiB3Lmxlbmd0aCB9KQogICAgfQoKICAgIHJldHVybiB3cml0ZXJzCiAgfQoKICBhc3luYyBfd2FrZXVwV3JpdGVyKGtleSwgbGVuZ3RoKSB7CiAgICB0aGlzLl9lbnN1cmVXYWtldXAoYXdhaXQgdGhpcy5fZ2V0V3JpdGVyQnlLZXkoa2V5LCAtMSwgbGVuZ3RoLCB0cnVlLCBmYWxzZSwgbnVsbCkpCiAgfQoKICAvLyBlbnN1cmUgd2FrZXVwIG9uIGFuIGV4aXN0aW5nIHdyaXRlciAodGhlIHdyaXRlciBjYWxscyB0aGlzIGluIGFkZGl0aW9uIHRvIGFib3ZlKQogIF9lbnN1cmVXYWtldXAodykgewogICAgaWYgKHcgPT09IG51bGwgfHwgdy5pc0Jvb3RzdHJhcCA9PT0gdHJ1ZSkgcmV0dXJuCiAgICB3LnNldEJvb3RzdHJhcCh0cnVlKSAvLyBldmVuIGlmIHR1cm4gZmFsc2UgYXQgZW5kIG9mIGRyYWluLCBoeXBlcmNvcmUgbWFrZXMgdGhlbSBsaW5nZXIgYSBiaXQgc28gbm8gY2h1cm4KICAgIHRoaXMuX2Jvb3RzdHJhcFdyaXRlcnMucHVzaCh3KQogICAgdGhpcy5fYm9vdHN0cmFwV3JpdGVyc0NoYW5nZWQgPSB0cnVlCiAgfQoKICBhc3luYyBfZHJhaW5XYWtldXAoKSB7CiAgICBjb25zdCBwcm9taXNlcyA9IFtdCgogICAgLy8gd2FybXVwIGFsbCB0aGUgYmVsb3cgZ2V0cwogICAgaWYgKHRoaXMuX25lZWRzV2FrZXVwKSB7CiAgICAgIGZvciAoY29uc3QgeyBrZXksIGxlbmd0aCB9IG9mIHRoaXMuX3dha2V1cCkgewogICAgICAgIGNvbnN0IHcgPSB0aGlzLmFjdGl2ZVdyaXRlcnMuZ2V0KGtleSkKICAgICAgICBpZiAodykgewogICAgICAgICAgaWYgKHcubGVuZ3RoIDwgbGVuZ3RoKSB3LnNlZW4obGVuZ3RoKQogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5nZXQoa2V5KSkKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX25lZWRzV2FrZXVwSGVhZHMpIHsKICAgICAgICBmb3IgKGNvbnN0IHsga2V5IH0gb2YgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uaGVhZHMpIHsKICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVdyaXRlcnMuaGFzKGtleSkpIGNvbnRpbnVlCiAgICAgICAgICBwcm9taXNlcy5wdXNoKHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmdldChrZXkpKQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZm9yIChjb25zdCBbaGV4LCBsZW5ndGhdIG9mIHRoaXMuX3dha2V1cEhpbnRzKSB7CiAgICAgIGNvbnN0IGtleSA9IGI0YS5mcm9tKGhleCwgJ2hleCcpCiAgICAgIGlmIChsZW5ndGggIT09IC0xKSB7CiAgICAgICAgY29uc3QgdyA9IHRoaXMuYWN0aXZlV3JpdGVycy5nZXQoa2V5KQogICAgICAgIGlmICh3KSB7CiAgICAgICAgICBpZiAody5sZW5ndGggPCBsZW5ndGgpIHcuc2VlbihsZW5ndGgpCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAgICAgfQogICAgICBwcm9taXNlcy5wdXNoKHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmdldChrZXkpKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChwcm9taXNlcykKCiAgICBpZiAodGhpcy5fbmVlZHNXYWtldXAgPT09IHRydWUpIHsKICAgICAgdGhpcy5fbmVlZHNXYWtldXAgPSBmYWxzZQoKICAgICAgZm9yIChjb25zdCB7IGtleSwgbGVuZ3RoIH0gb2YgdGhpcy5fd2FrZXVwKSB7CiAgICAgICAgaWYgKHRoaXMuYWN0aXZlV3JpdGVycy5oYXMoa2V5KSkgY29udGludWUKICAgICAgICBhd2FpdCB0aGlzLl93YWtldXBXcml0ZXIoa2V5LCBsZW5ndGgpCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9uZWVkc1dha2V1cEhlYWRzID09PSB0cnVlKSB7CiAgICAgICAgdGhpcy5fbmVlZHNXYWtldXBIZWFkcyA9IGZhbHNlCgogICAgICAgIGZvciAoY29uc3QgeyBrZXkgfSBvZiBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5oZWFkcykgewogICAgICAgICAgaWYgKHRoaXMuYWN0aXZlV3JpdGVycy5oYXMoa2V5KSkgY29udGludWUKICAgICAgICAgIGF3YWl0IHRoaXMuX3dha2V1cFdyaXRlcihrZXksIDApCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZm9yIChjb25zdCBbaGV4LCBsZW5ndGhdIG9mIHRoaXMuX3dha2V1cEhpbnRzKSB7CiAgICAgIGNvbnN0IGtleSA9IGI0YS5mcm9tKGhleCwgJ2hleCcpCiAgICAgIGlmICh0aGlzLmFjdGl2ZVdyaXRlcnMuaGFzKGtleSkpIGNvbnRpbnVlCiAgICAgIGlmIChsZW5ndGggIT09IC0xKSB7CiAgICAgICAgY29uc3QgaW5mbyA9IGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmdldChrZXkpCiAgICAgICAgaWYgKGluZm8gJiYgbGVuZ3RoIDw9IGluZm8ubGVuZ3RoKSBjb250aW51ZSAvLyBzdGFsZSBoaW50CiAgICAgIH0KICAgICAgYXdhaXQgdGhpcy5fd2FrZXVwV3JpdGVyKGtleSwgbGVuZ3RoID09PSAtMSA/IDAgOiBsZW5ndGgpCiAgICB9CgogICAgdGhpcy5fd2FrZXVwSGludHMuY2xlYXIoKQogIH0KCiAgcGF1c2UoKSB7CiAgICB0aGlzLnBhdXNlZCA9IHRydWUKICB9CgogIHJlc3VtZSgpIHsKICAgIHRoaXMucGF1c2VkID0gZmFsc2UKICAgIHRoaXMuX3F1ZXVlQnVtcCgpCiAgfQoKICB3YWl0Rm9yV3JpdGFibGUoKSB7CiAgICBpZiAodGhpcy53cml0YWJsZSkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKQogICAgaWYgKCF0aGlzLl93cml0YWJsZSkgdGhpcy5fd3JpdGFibGUgPSBycnAoKQogICAgcmV0dXJuIHRoaXMuX3dyaXRhYmxlLnByb21pc2UKICB9CgogIGFzeW5jIF9kcmFpbldpdGhJbnRlcnVwdCgpIHsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgdGhpcy5fZHJhaW4oKQogICAgICAgIHJldHVybgogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBpZiAodGhpcy5jbG9zaW5nIHx8ICF0aGlzLmZhc3RGb3J3YXJkVG8pIHRocm93IGVycgogICAgICAgIGlmIChEYXRlLm5vdygpIC0gdGhpcy5mYXN0Rm9yd2FyZEZhaWxlZEF0IDwgTUlOX0ZGX1dBSVQpIHRocm93IGVycgogICAgICAgIHRoaXMuZmFzdEZvcndhcmRGYWlsZWRBdCA9IERhdGUubm93KCkKICAgICAgICAvLyBpZiBhbiBGRiBpcyBlbmFibGVkIHJldHJ5CiAgICAgIH0KICAgIH0KICB9CgogIGFzeW5jIF9hZHZhbmNlKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAodGhpcy5wYXVzZWQgfHwgdGhpcy5faW50ZXJydXB0aW5nKSByZXR1cm4KCiAgICB0aGlzLl9kcmFpbmluZyA9IHRydWUKCiAgICBpZiAodGhpcy5fdXBkYXRlTG9jYWxDb3JlICE9PSBudWxsKSB7CiAgICAgIGF3YWl0IHRoaXMuX3JvdGF0ZUxvY2FsV3JpdGVyKHRoaXMuX3VwZGF0ZUxvY2FsQ29yZSkKICAgIH0KCiAgICBjb25zdCBsb2NhbCA9IHRoaXMubG9jYWwubGVuZ3RoCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fZHJhaW5XaXRoSW50ZXJ1cHQoKQoKICAgICAgLy8gbXVzdCBydW4gcG9zdCBkcmFpbiBzbyB0aGUgbGluZWFyaXplciBpcyBjYXVnaHQgdXAKICAgICAgaWYgKHRoaXMuX2NhdWdodHVwICYmICh0aGlzLl9uZWVkc1dha2V1cCA9PT0gdHJ1ZSB8fCB0aGlzLl93YWtldXBIaW50cy5zaXplID4gMCkpCiAgICAgICAgYXdhaXQgdGhpcy5fZHJhaW5XYWtldXAoKQoKICAgICAgLy8gY2hlY2sgaWYgd2Ugc2hvdWxkIHVwZGF0ZSBsb2NhbCB3cml0ZXIKICAgICAgaWYgKCF0aGlzLmxvY2FsV3JpdGVyIHx8IHRoaXMubG9jYWxXcml0ZXIuY2xvc2VkKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fdXBkYXRlTG9jYWxXcml0ZXIodGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0pCiAgICAgIH0KCiAgICAgIHRoaXMuX2RyYWluaW5nID0gZmFsc2UKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLl9vbkVycm9yKGVycikKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMuX2ludGVycnVwdGluZykgcmV0dXJuCgogICAgaWYgKHRoaXMubG9jYWxXcml0ZXIgJiYgIXRoaXMubG9jYWxXcml0ZXIuY2xvc2VkKSB7CiAgICAgIGlmICh0aGlzLl9hcHBseVN0YXRlLmlzTG9jYWxQZW5kaW5nSW5kZXhlcigpKSB0aGlzLmFjaygpLmNhdGNoKG5vb3ApCiAgICAgIGVsc2UgaWYgKHRoaXMuX3RyaWdnZXJBY2tBc2FwKCkpIHRoaXMuX2Fja1RpbWVyLmFzYXAoKQogICAgfQoKICAgIC8vIGtlZXAgYm9vdHN0cmFwcyBpbiBzeW5jIHdpdGggbGluZWFyaXplcgogICAgaWYgKHRoaXMudXBkYXRpbmcgPT09IHRydWUgfHwgdGhpcy5fYm9vdHN0cmFwV3JpdGVyc0NoYW5nZWQgPT09IHRydWUpIHsKICAgICAgdGhpcy5fdXBkYXRlQm9vdHN0cmFwV3JpdGVycygpCiAgICB9CgogICAgaWYgKHRoaXMudXBkYXRpbmcgPT09IHRydWUpIHsKICAgICAgdGhpcy51cGRhdGluZyA9IGZhbHNlCgogICAgICBpZiAobG9jYWwgIT09IHRoaXMubG9jYWwubGVuZ3RoKSB0aGlzLl9yZXNldEFja1RpY2soKQogICAgICBlbHNlIHRoaXMuX2Fja1RpY2srKwoKICAgICAgaWYgKCF0aGlzLl9pbnRlcnJ1cHRpbmcpIHRoaXMuZW1pdCgndXBkYXRlJykKICAgICAgdGhpcy5fd2FpdGluZy5ub3RpZnkobnVsbCkKICAgIH0KCiAgICBpZiAoIXRoaXMuX2ludGVycnVwdGluZykgYXdhaXQgdGhpcy5fZ2NXcml0ZXJzKCkKICB9CgogIF90cmlnZ2VyQWNrQXNhcCgpIHsKICAgIGlmICghdGhpcy5fYWNrVGltZXIpIHJldHVybiBmYWxzZQoKICAgIC8vIGZsdXNoIGlmIHRocmVzaG9sZCBpcyByZWFjaGVkIGFuZCB3ZSBhcmUgbm90IGFscmVhZHkgYWNraW5nCiAgICBpZiAodGhpcy5fYWNrVGlja1RocmVzaG9sZCAmJiAhdGhpcy5fYWNraW5nICYmIHRoaXMuX2Fja1RpY2sgPj0gdGhpcy5fYWNrVGlja1RocmVzaG9sZCkgewogICAgICBpZiAodGhpcy5fYWNrVGltZXIpIHsKICAgICAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5saW5lYXJpemVyLmluZGV4ZXJzKSB7CiAgICAgICAgICBpZiAody5jb3JlLmxlbmd0aCA+IHcubGVuZ3RoKSByZXR1cm4gZmFsc2UgLy8gd2FpdCBmb3IgdGhlIG5vcm1hbCBhY2sgY3ljbGUgaW4gdGhpcyBjYXNlCiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX3F1ZXVlRmFzdEZvcndhcmQoKSB7CiAgICBpZiAoIXRoaXMuY29yZS5vcGVuZWQpIHJldHVybgogICAgLy8gc2hvdWxkIGhhdmUgYSBiZXR0ZXIgd2F5IHRvIGdldCB0aGlzCiAgICBjb25zdCBsYXRlc3RTaWduZWRMZW5ndGggPSB0aGlzLmNvcmUuY29yZS5zdGF0ZS5sZW5ndGgKCiAgICBpZiAoIXRoaXMuZmFzdEZvcndhcmRFbmFibGVkIHx8IHRoaXMuZmFzdEZvcndhcmRpbmcgIT09IG51bGwgfHwgdGhpcy5faW50ZXJydXB0aW5nKSByZXR1cm4KCiAgICBpZiAobGF0ZXN0U2lnbmVkTGVuZ3RoIC0gdGhpcy5jb3JlLmxlbmd0aCA8IHRoaXMuZmFzdEZvcndhcmRNaW5pbXVtKSByZXR1cm4KICAgIGlmICh0aGlzLmZhc3RGb3J3YXJkVG8gIT09IG51bGwpIHJldHVybgogICAgaWYgKERhdGUubm93KCkgLSB0aGlzLmZhc3RGb3J3YXJkRmFpbGVkQXQgPCBNSU5fRkZfV0FJVCkgcmV0dXJuCgogICAgdGhpcy5fcnVuRmFzdEZvcndhcmQoCiAgICAgIG5ldyBGYXN0Rm9yd2FyZCh0aGlzLCB0aGlzLmNvcmUua2V5LCB7IG1pbmltdW06IHRoaXMuZmFzdEZvcndhcmRNaW5pbXVtIH0pCiAgICApLmNhdGNoKG5vb3ApCiAgfQoKICBfcXVldWVTdGF0aWNGYXN0Rm9yd2FyZChrZXkpIHsKICAgIGlmICghdGhpcy5mYXN0Rm9yd2FyZEVuYWJsZWQgfHwgdGhpcy5mYXN0Rm9yd2FyZGluZyAhPT0gbnVsbCB8fCB0aGlzLl9pbnRlcnJ1cHRpbmcpIHJldHVybgogICAgaWYgKHRoaXMuZmFzdEZvcndhcmRUbyAhPT0gbnVsbCkgcmV0dXJuCiAgICBpZiAoRGF0ZS5ub3coKSAtIHRoaXMuZmFzdEZvcndhcmRGYWlsZWRBdCA8IE1JTl9GRl9XQUlUKSByZXR1cm4KCiAgICB0aGlzLl9ydW5GYXN0Rm9yd2FyZChuZXcgRmFzdEZvcndhcmQodGhpcywga2V5LCB7IHZlcmlmaWVkOiBmYWxzZSB9KSkuY2F0Y2gobm9vcCkKICB9CgogIF91cGRhdGVBY3Rpdml0eSgpIHsKICAgIHRoaXMuYWN0aXZlV3JpdGVycy51cGRhdGVBY3Rpdml0eSgpCiAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZSkgewogICAgICBpZiAodGhpcy5pc0Zhc3RGb3J3YXJkaW5nKCkpIHRoaXMuX2FwcGx5U3RhdGUucGF1c2UoKQogICAgICBlbHNlIHRoaXMuX2FwcGx5U3RhdGUucmVzdW1lKCkKICAgIH0KCiAgICAvLyBpbiBjYXNlIHdlIGlnbm9yZWQgd2FrZXVwcyBjYXNlIHdlIHdlcmUgZmFzdCBmb3J3YXJkaW5nLCByZXF1ZXN0IHRoZW0gbm93IGlmIG5vdAogICAgaWYgKHRoaXMuX25lZWRzV2FrZXVwUmVxdWVzdCAmJiAhdGhpcy5pc0Zhc3RGb3J3YXJkaW5nKCkgJiYgdGhpcy53YWtldXBTZXNzaW9uKSB7CiAgICAgIHRoaXMuX25lZWRzV2FrZXVwUmVxdWVzdCA9IGZhbHNlCgogICAgICB0aGlzLndha2V1cFNlc3Npb24uYnJvYWRjYXN0TG9va3VwKHt9KQogICAgfQogIH0KCiAgX3ByZWZlckZhc3RGb3J3YXJkKCkgewogICAgdGhpcy5mYXN0Rm9yd2FyZE1pbmltdW0gPSAxCiAgICB0aGlzLl9xdWV1ZUZhc3RGb3J3YXJkKCkKICB9CgogIF9wb3N0QXBwbHkoKSB7CiAgICB0aGlzLmZhc3RGb3J3YXJkTWluaW11bSA9IEZhc3RGb3J3YXJkLk1JTklNVU0KICB9CgogIGFzeW5jIF9ydW5GYXN0Rm9yd2FyZChmZikgewogICAgdGhpcy5mYXN0Rm9yd2FyZGluZyA9IGZmCgogICAgdGhpcy5fdXBkYXRlQWN0aXZpdHkoKQoKICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZmLnVwZ3JhZGUoKQogICAgYXdhaXQgZmYuY2xvc2UoKQoKICAgIGlmICh0aGlzLmZhc3RGb3J3YXJkaW5nID09PSBmZikgdGhpcy5mYXN0Rm9yd2FyZGluZyA9IG51bGwKCiAgICBpZiAoIXJlc3VsdCkgewogICAgICBpZiAoZmYuZmFpbGVkKSB0aGlzLmZhc3RGb3J3YXJkRmFpbGVkQXQgPSBEYXRlLm5vdygpCiAgICAgIGVsc2UgdGhpcy5fcXVldWVGYXN0Rm9yd2FyZCgpCiAgICAgIHRoaXMuX3VwZGF0ZUFjdGl2aXR5KCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5mYXN0Rm9yd2FyZEZhaWxlZEF0ID0gMAogICAgdGhpcy5mYXN0Rm9yd2FyZFRvID0gcmVzdWx0CgogICAgaWYgKHRoaXMuX2FwcGx5U3RhdGUgJiYgdGhpcy5fYXBwbHlTdGF0ZS5hcHBseWluZyAmJiB0aGlzLmZhc3RGb3J3YXJkTWluaW11bSA9PT0gMSkgewogICAgICBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmNsb3NlKCkKICAgIH0KCiAgICB0aGlzLl9idW1wQWNrVGltZXIoKQogICAgdGhpcy5fcXVldWVCdW1wKCkKICB9CgogIC8vIHRyaWdnZXJlZCBmcm9tIGFwcGx5CiAgYXN5bmMgX2FkZFdyaXRlcihrZXksIHN5cykgewogICAgLy8ganVzdCBjb21wYXQgZm9yIG9sZCB2ZXJzaW9uCiAgICBhc3NlcnQoISF0aGlzLl9hcHBseVN0YXRlLmFwcGx5aW5nLCAnU3lzdGVtIGNoYW5nZXMgYXJlIG9ubHkgYWxsb3dlZCBpbiBhcHBseScpCgogICAgY29uc3Qgd3JpdGVyID0KICAgICAgKGF3YWl0IHRoaXMuX2dldFdyaXRlckJ5S2V5KGtleSwgLTEsIDAsIGZhbHNlLCB0cnVlLCBzeXMpKSB8fAogICAgICB0aGlzLl9tYWtlV3JpdGVyKGtleSwgMCwgdHJ1ZSwgZmFsc2UpCiAgICBhd2FpdCB3cml0ZXIucmVhZHkoKQoKICAgIGlmICghdGhpcy5hY3RpdmVXcml0ZXJzLmhhcyhrZXkpKSB7CiAgICAgIHRoaXMuYWN0aXZlV3JpdGVycy5hZGQod3JpdGVyKQogICAgICB0aGlzLl9jaGVja1dyaXRlcnMucHVzaCh3cml0ZXIpCiAgICAgIHRoaXMuX2Vuc3VyZVdha2V1cCh3cml0ZXIpCiAgICB9CgogICAgLy8gZmV0Y2ggYW55IG5vZGVzIG5lZWRlZCBmb3IgZGVwZW5kZW50cwogICAgdGhpcy5fcXVldWVCdW1wKCkKICB9CgogIC8vIHRyaWdnZXJlZCBmcm9tIGFwcGx5CiAgX3JlbW92ZVdyaXRlcihrZXkpIHsKICAgIC8vIGp1c3QgY29tcGF0IGZvciBvbGQgdmVyc2lvbgogICAgY29uc3QgdyA9IHRoaXMuYWN0aXZlV3JpdGVycy5nZXQoa2V5KQogICAgaWYgKHcpIHcuaXNSZW1vdmVkID0gdHJ1ZQoKICAgIHRoaXMuX3F1ZXVlQnVtcCgpCiAgfQoKICByZW1vdmVhYmxlKGtleSkgewogICAgcmV0dXJuIHRoaXMuX2FwcGx5U3RhdGUgPyB0aGlzLl9hcHBseVN0YXRlLnJlbW92ZWFibGUoa2V5KSA6IGZhbHNlCiAgfQoKICBfdXBkYXRlQWNrVGhyZXNob2xkKCkgewogICAgaWYgKHRoaXMuX2Fja1RocmVzaG9sZCA9PT0gMCkgcmV0dXJuCiAgICBpZiAodGhpcy5fYWNrVGltZXIpIHRoaXMuX2Fja1RpbWVyLmJhdSgpCiAgICB0aGlzLl9hY2tUaWNrID0gMAogICAgdGhpcy5fYWNrVGlja1RocmVzaG9sZCA9IHJhbmRvbTJvdmVyMSh0aGlzLmxpbmVhcml6ZXIuaW5kZXhlcnMubGVuZ3RoICogdGhpcy5fYWNrVGhyZXNob2xkKQogIH0KCiAgX3Jlc2V0QWNrVGljaygpIHsKICAgIHRoaXMuX2Fja1RpY2sgPSAwCiAgICBpZiAodGhpcy5fYWNrVGltZXIpIHRoaXMuX2Fja1RpbWVyLmJhdSgpCiAgfQoKICBfc2hpZnRXcml0ZXIodykgewogICAgdy5zaGlmdCgpCiAgICBpZiAody5mbHVzaGVkKCkpIHRoaXMuX2NoZWNrV3JpdGVycy5wdXNoKHcpCiAgfQp9CgpmdW5jdGlvbiB0b0tleShrKSB7CiAgcmV0dXJuIGI0YS5pc0J1ZmZlcihrKSA/IGsgOiBoeXBlcmNvcmVJZC5kZWNvZGUoaykKfQoKZnVuY3Rpb24gaXNBdXRvYmFzZU1lc3NhZ2UobXNnKSB7CiAgcmV0dXJuIG1zZy5jaGVja3BvaW50ID8gbXNnLmNoZWNrcG9pbnQubGVuZ3RoID4gMCA6IG1zZy5jaGVja3BvaW50ID09PSBudWxsCn0KCmZ1bmN0aW9uIGNvbXBhcmVOb2RlcyhhLCBiKSB7CiAgcmV0dXJuIGI0YS5jb21wYXJlKGEua2V5LCBiLmtleSkKfQoKZnVuY3Rpb24gcmFuZG9tMm92ZXIxKG4pIHsKICByZXR1cm4gTWF0aC5mbG9vcihuICsgTWF0aC5yYW5kb20oKSAqIG4pCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gY3Jhc2hTb29uKGVycikgewogIHF1ZXVlTWljcm90YXNrKCgpID0+IHsKICAgIHRocm93IGVycgogIH0pCiAgdGhyb3cgZXJyCn0KCmZ1bmN0aW9uIGlzT2JqZWN0KG9iaikgewogIHJldHVybiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGwKfQoKZnVuY3Rpb24gZW1pdFdhcm5pbmcoZXJyKSB7CiAgc2FmZXR5Q2F0Y2goZXJyKQogIHRoaXMuZW1pdCgnd2FybmluZycsIGVycikKfQoKZnVuY3Rpb24gbm9ybWFsaXplKHZhbHVlRW5jb2RpbmcsIHZhbHVlKSB7CiAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlcjogbnVsbCwgc3RhcnQ6IDAsIGVuZDogMCB9CiAgdmFsdWVFbmNvZGluZy5wcmVlbmNvZGUoc3RhdGUsIHZhbHVlKQogIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShzdGF0ZS5lbmQpCiAgdmFsdWVFbmNvZGluZy5lbmNvZGUoc3RhdGUsIHZhbHVlKQogIHN0YXRlLnN0YXJ0ID0gMAogIHJldHVybiB2YWx1ZUVuY29kaW5nLmRlY29kZShzdGF0ZSkKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBBY3RpdmVXcml0ZXJzIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMubWFwID0gbmV3IE1hcCgpCiAgfQoKICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLm1hcC5zaXplCiAgfQoKICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLm1hcC52YWx1ZXMoKQogIH0KCiAgZ2V0KGtleSkgewogICAgcmV0dXJuIHRoaXMubWFwLmdldChiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykpIHx8IG51bGwKICB9CgogIGhhcyhrZXkpIHsKICAgIHJldHVybiB0aGlzLmdldChrZXkpICE9PSBudWxsCiAgfQoKICBhZGQod3JpdGVyKSB7CiAgICB0aGlzLm1hcC5zZXQoYjRhLnRvU3RyaW5nKHdyaXRlci5jb3JlLmtleSwgJ2hleCcpLCB3cml0ZXIpCiAgfQoKICBkZWxldGUod3JpdGVyKSB7CiAgICB0aGlzLm1hcC5kZWxldGUoYjRhLnRvU3RyaW5nKHdyaXRlci5jb3JlLmtleSwgJ2hleCcpKQogIH0KCiAgdXBkYXRlQWN0aXZpdHkoKSB7CiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5tYXAudmFsdWVzKCkpIHcudXBkYXRlQWN0aXZpdHkoKQogIH0KCiAgY2xlYXIoKSB7CiAgICBjb25zdCBwID0gW10KICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLm1hcC52YWx1ZXMoKSkgcC5wdXNoKHcuY2xvc2UoKSkKICAgIHRoaXMubWFwLmNsZWFyKCkKCiAgICByZXR1cm4gUHJvbWlzZS5hbGwocCkKICB9Cn0KY29uc3QgU2lnbmFsUHJvbWlzZSA9IHJlcXVpcmUoJ3NpZ25hbC1wcm9taXNlJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQXBwZW5kQmF0Y2ggewogIGNvbnN0cnVjdG9yKGJhc2UpIHsKICAgIHRoaXMuYmFzZSA9IGJhc2UKICAgIHRoaXMuYmxvY2tzID0gW10KICAgIHRoaXMuY2xvc2VkID0gZmFsc2UKICAgIHRoaXMuZmx1c2hpbmcgPSBmYWxzZQogICAgdGhpcy5fZmx1c2hlZCA9IG51bGwKICB9CgogIGFzeW5jIF9hY3F1aXJlKCkgewogICAgd2hpbGUgKHRoaXMuYmFzZS5hY3RpdmVCYXRjaCAhPT0gbnVsbCAmJiB0aGlzLmJhc2UuYWN0aXZlQmF0Y2ggIT09IHRoaXMpCiAgICAgIGF3YWl0IHRoaXMuYmFzZS5hY3RpdmVCYXRjaC5mbHVzaGVkKCkKICAgIHRoaXMuYmFzZS5hY3RpdmVCYXRjaCA9IHRoaXMKICB9CgogIGFzeW5jIGFwcGVuZCh2YWx1ZSkgewogICAgaWYgKHRoaXMuYmFzZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLmJhc2UucmVhZHkoKQogICAgaWYgKHRoaXMuYmFzZS5fYWR2YW5jaW5nICE9PSBudWxsKSBhd2FpdCB0aGlzLmJhc2UuX2FkdmFuY2luZwoKICAgIGlmICh0aGlzLmNsb3NlZCkgdGhyb3cgbmV3IEVycm9yKCdCYXRjaCBpcyBjbG9zZWQnKQogICAgaWYgKHRoaXMuYmFzZS5hY3RpdmVCYXRjaCAhPT0gdGhpcykgYXdhaXQgdGhpcy5fYWNxdWlyZSgpCiAgICBpZiAodGhpcy5jbG9zZWQpIHRocm93IG5ldyBFcnJvcignQmF0Y2ggaXMgY2xvc2VkJykKCiAgICB0aGlzLmJsb2Nrcy5wdXNoKHZhbHVlKQogICAgcmV0dXJuIHRoaXMuYmFzZS5sb2NhbC5sZW5ndGggKyB0aGlzLmJsb2Nrcy5sZW5ndGgKICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgaWYgKHRoaXMuY2xvc2VkKSB0aHJvdyBuZXcgRXJyb3IoJ0JhdGNoIGlzIGNsb3NlZCcpCiAgICBpZiAodGhpcy5mbHVzaGluZykgcmV0dXJuIHRoaXMuZmx1c2hlZCgpCiAgICB0aGlzLmZsdXNoaW5nID0gdHJ1ZQogICAgaWYgKHRoaXMuYmxvY2tzLmxlbmd0aCkgYXdhaXQgdGhpcy5iYXNlLl9hcHBlbmRCYXRjaCh0aGlzLmJsb2NrcykKICAgIHJldHVybiB0aGlzLmNsb3NlKCkKICB9CgogIGZsdXNoZWQoKSB7CiAgICBpZiAodGhpcy5jbG9zZWQpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQogICAgaWYgKHRoaXMuX2ZsdXNoZWQpIHJldHVybiB0aGlzLl9mbHVzaGVkLndhaXQoKQogICAgdGhpcy5fZmx1c2hlZCA9IG5ldyBTaWduYWxQcm9taXNlKCkKICAgIHJldHVybiB0aGlzLl9mbHVzaGVkLndhaXQoKQogIH0KCiAgY2xvc2UoKSB7CiAgICBpZiAodGhpcy5iYXNlLmFjdGl2ZUJhdGNoICE9PSB0aGlzKSByZXR1cm4KICAgIHRoaXMuYmFzZS5hY3RpdmVCYXRjaCA9IG51bGwKICAgIHRoaXMuY2xvc2VkID0gdHJ1ZQogICAgaWYgKHRoaXMuX2ZsdXNoZWQpIHRoaXMuX2ZsdXNoZWQubm90aWZ5KG51bGwpCiAgfQp9CmNsYXNzIFB1YmxpY0FwcGx5Q2FsbHMgewogIGNvbnN0cnVjdG9yKGJhc2UpIHsKICAgIHRoaXMuYmFzZSA9IGJhc2UKICAgIHRoaXMuaW50ZXJuYWwgPSBmYWxzZQogIH0KCiAgZ2V0IGRpc2NvdmVyeUtleSgpIHsKICAgIHJldHVybiB0aGlzLmJhc2UuZGlzY292ZXJ5S2V5CiAgfQoKICBnZXQga2V5KCkgewogICAgcmV0dXJuIHRoaXMuYmFzZS5rZXkKICB9CgogIGdldCBpZCgpIHsKICAgIHJldHVybiB0aGlzLmJhc2UuaWQKICB9CgogIGFzeW5jIGFkZFdyaXRlcigpIHsKICAgIHRocm93IG5ldyBFcnJvcignTm90IGFsbG93ZWQgb24gdGhlIHB1YmxpYyB2aWV3JykKICB9CgogIGFzeW5jIGFja1dyaXRlcigpIHsKICAgIHRocm93IG5ldyBFcnJvcignTm90IGFsbG93ZWQgb24gdGhlIHB1YmxpYyB2aWV3JykKICB9CgogIGFzeW5jIHJlbW92ZVdyaXRlcigpIHsKICAgIHRocm93IG5ldyBFcnJvcignTm90IGFsbG93ZWQgb24gdGhlIHB1YmxpYyB2aWV3JykKICB9CgogIHByZWZlckZhc3RGb3J3YXJkKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgYWxsb3dlZCBvbiB0aGUgcHVibGljIHZpZXcnKQogIH0KCiAgaW50ZXJydXB0KCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgYWxsb3dlZCBvbiB0aGUgcHVibGljIHZpZXcnKQogIH0KCiAgcmVtb3ZlYWJsZSgpIHsKICAgIHRocm93IG5ldyBFcnJvcignTm90IGFsbG93ZWQgb24gdGhlIHB1YmxpYyB2aWV3JykKICB9CgogIGZvcmsoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhbGxvd2VkIG9uIHRoZSBwdWJsaWMgdmlldycpCiAgfQoKICBhbmNob3IoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhbGxvd2VkIG9uIHRoZSBwdWJsaWMgdmlldycpCiAgfQp9CgpjbGFzcyBQcml2YXRlQXBwbHlDYWxscyBleHRlbmRzIFB1YmxpY0FwcGx5Q2FsbHMgewogIGNvbnN0cnVjdG9yKHN0YXRlKSB7CiAgICBzdXBlcihzdGF0ZS5iYXNlKQogICAgdGhpcy5zdGF0ZSA9IHN0YXRlCiAgICB0aGlzLmludGVybmFsID0gdHJ1ZQogIH0KCiAgZ2V0IHN5c3RlbSgpIHsKICAgIHJldHVybiB0aGlzLnN0YXRlLnN5c3RlbQogIH0KCiAgYXN5bmMgYWRkV3JpdGVyKGtleSwgeyBpbmRleGVyID0gdHJ1ZSwgaXNJbmRleGVyID0gaW5kZXhlciB9ID0ge30pIHsKICAgIC8vIGp1c3QgY29tcGF0IGZvciBvbGQgdmVyc2lvbgogICAgYXdhaXQgdGhpcy5zdGF0ZS5zeXN0ZW0uYWRkKGtleSwgeyBpc0luZGV4ZXIgfSkKICAgIGF3YWl0IHRoaXMuYmFzZS5fYWRkV3JpdGVyKGtleSwgdGhpcy5zdGF0ZS5zeXN0ZW0pCiAgfQoKICBhc3luYyBhY2tXcml0ZXIoa2V5KSB7CiAgICBhd2FpdCB0aGlzLnN0YXRlLnN5c3RlbS5hY2soa2V5KQogIH0KCiAgYXN5bmMgcmVtb3ZlV3JpdGVyKGtleSkgewogICAgLy8ganVzdCBjb21wYXQgZm9yIG9sZCB2ZXJzaW9uCiAgICBpZiAoIXRoaXMuc3RhdGUucmVtb3ZlYWJsZShrZXkpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignTm90IGFsbG93ZWQgdG8gcmVtb3ZlIHRoZSBsYXN0IGluZGV4ZXInKQogICAgfQoKICAgIGF3YWl0IHRoaXMuc3RhdGUuc3lzdGVtLnJlbW92ZShrZXkpCiAgICB0aGlzLmJhc2UuX3JlbW92ZVdyaXRlcihrZXkpCiAgfQoKICBwcmVmZXJGYXN0Rm9yd2FyZCgpIHsKICAgIHRoaXMuYmFzZS5fcHJlZmVyRmFzdEZvcndhcmQoKQogIH0KCiAgaW50ZXJydXB0KHJlYXNvbikgewogICAgdGhpcy5iYXNlLl9pbnRlcnJ1cHQocmVhc29uKQogIH0KCiAgcmVtb3ZlYWJsZShrZXkpIHsKICAgIHJldHVybiB0aGlzLnN0YXRlLnJlbW92ZWFibGUoa2V5KQogIH0KCiAgYXN5bmMgZm9yayhpbmRleGVyS2V5cywgc3lzdGVtKSB7CiAgICBpZiAoIShhd2FpdCB0aGlzLnN0YXRlLnZhbGlkYXRlRm9yayhpbmRleGVyS2V5cywgc3lzdGVtKSkpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGluZGV4ZXJzID0gaW5kZXhlcktleXMubWFwKHRvSW5kZXhlcikKCiAgICB0aGlzLnN0YXRlLnBlbmRpbmdGb3JrID0geyBpbmRleGVycywgbGVuZ3RoOiBzeXN0ZW0ubGVuZ3RoIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgY3JlYXRlQW5jaG9yKCkgewogICAgcmV0dXJuIGF3YWl0IHRoaXMuc3RhdGUuY3JlYXRlQW5jaG9yKCkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0geyBQdWJsaWNBcHBseUNhbGxzLCBQcml2YXRlQXBwbHlDYWxscyB9CgpmdW5jdGlvbiB0b0luZGV4ZXIoa2V5KSB7CiAgcmV0dXJuIHsga2V5LCBsZW5ndGg6IDAgfSAvLyBsZW5ndGggaXMgbm90IHVzZWQsIGp1c3QgZm9yIGFwaSBjb21wYXQKfQpjb25zdCBSZWFkeVJlc291cmNlID0gcmVxdWlyZSgncmVhZHktcmVzb3VyY2UnKQpjb25zdCBhc3NlcnQgPSByZXF1aXJlKCduYW5vYXNzZXJ0JykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQoKY29uc3QgeyBwYXJ0aWFsU2lnbmF0dXJlIH0gPSByZXF1aXJlKCdoeXBlcmNvcmUvbGliL211bHRpc2lnLmpzJykKCmNvbnN0IFN5c3RlbVZpZXcgPSByZXF1aXJlKCcuL3N5c3RlbS5qcycpCmNvbnN0IHsgQXV0b2Jhc2VFbmNyeXB0aW9uIH0gPSByZXF1aXJlKCcuL2VuY3J5cHRpb24uanMnKQpjb25zdCBVcGRhdGVDaGFuZ2VzID0gcmVxdWlyZSgnLi91cGRhdGVzLmpzJykKY29uc3QgbWVzc2FnZXMgPSByZXF1aXJlKCcuL21lc3NhZ2VzLmpzJykKY29uc3QgeyBQcml2YXRlQXBwbHlDYWxscyB9ID0gcmVxdWlyZSgnLi9hcHBseS1jYWxscy5qcycpCmNvbnN0IHsgZW5jb2RlVmFsdWUgfSA9IHJlcXVpcmUoJy4vdmFsdWVzLmpzJykKY29uc3QgRm9yayA9IHJlcXVpcmUoJy4vZm9yay5qcycpCmNvbnN0IExvY2FsU3RhdGUgPSByZXF1aXJlKCcuL2xvY2FsLXN0YXRlLmpzJykKY29uc3QgeyBPUExPR19WRVJTSU9OLCBCT09UX1JFQ09SRF9WRVJTSU9OIH0gPSByZXF1aXJlKCcuL2NhcHMuanMnKQoKLy8gdG9kbzogZXhwb3NlIHRoaXMgYXMgYW4gb3B0aW9uCmNvbnN0IFNIT1VMRF9TSUdOX1RIUkVTSE9MRCA9IDAKCmNsYXNzIENoZWNrcG9pbnRDb3JlIHsKICBjb25zdHJ1Y3Rvcih2aWV3LCBjb3JlLCBzaWduZXIsIHBhdXNlZCkgewogICAgdGhpcy52aWV3ID0gdmlldwogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy5zaWduZXIgPSBzaWduZXIKICAgIHRoaXMubGVuZ3RoID0gMAogICAgdGhpcy5kaWdlc3QgPSBudWxsCiAgICB0aGlzLnNpZ25hdHVyZXMgPSB7IHN5c3RlbTogbnVsbCwgZW5jcnlwdGlvbjogbnVsbCwgdXNlcjogW10gfQogICAgdGhpcy5jbG9zZWQgPSBmYWxzZQogICAgdGhpcy5wYXVzZWQgPSBwYXVzZWQKICB9CgogIHBhdXNlKCkgewogICAgdGhpcy5wYXVzZWQgPSB0cnVlCiAgfQoKICByZXN1bWUoKSB7CiAgICBpZiAoIXRoaXMucGF1c2VkKSByZXR1cm4KICAgIHRoaXMucGF1c2VkID0gZmFsc2UKICAgIHRoaXMudXBkYXRlQmFja2dyb3VuZCgpCiAgfQoKICBhc3luYyB1cGRhdGUoKSB7CiAgICBpZiAoYXdhaXQgdGhpcy51cGRhdGVDaGVja3BvaW50cygpKSBhd2FpdCB0aGlzLnZpZXcubWF5YmVTaWduZWQoKQogIH0KCiAgYXN5bmMgdXBkYXRlQ2hlY2twb2ludHMoKSB7CiAgICBpZiAodGhpcy5jb3JlLmxlbmd0aCA8PSB0aGlzLmxlbmd0aCB8fCB0aGlzLmNsb3NlZCB8fCB0aGlzLnBhdXNlZCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgbGVuZ3RoID0gdGhpcy5jb3JlLmxlbmd0aAogICAgY29uc3QgdmFsdWUgPSBhd2FpdCB0aGlzLmNvcmUuZ2V0KGxlbmd0aCAtIDEpCgogICAgaWYgKGxlbmd0aCA8PSB0aGlzLmxlbmd0aCB8fCB0aGlzLmNsb3NlZCB8fCAhdmFsdWUuZGlnZXN0IHx8IHRoaXMucGF1c2VkKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBbZGlnZXN0LCBjaGVja3BvaW50c10gPSBhd2FpdCBQcm9taXNlLmFsbChbCiAgICAgIHRoaXMuX2luZmxhdGVEaWdlc3QobGVuZ3RoLCB2YWx1ZS5kaWdlc3QpLAogICAgICB0aGlzLl9pbmZsYXRlQWxsQ2hlY2twb2ludHMobGVuZ3RoLCB2YWx1ZS5jaGVja3BvaW50KQogICAgXSkKCiAgICBpZiAobGVuZ3RoIDw9IHRoaXMubGVuZ3RoIHx8IHRoaXMuY2xvc2VkIHx8ICFkaWdlc3QgfHwgIWNoZWNrcG9pbnRzIHx8IHRoaXMucGF1c2VkKSByZXR1cm4gZmFsc2UKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hlY2twb2ludHMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGNoZWNrcG9pbnRzW2ldID09PSBudWxsKSByZXR1cm4gZmFsc2UKICAgIH0KCiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aAogICAgdGhpcy5kaWdlc3QgPSBkaWdlc3QKICAgIHRoaXMuc2lnbmF0dXJlcyA9IGNoZWNrcG9pbnRzCgogICAgcmV0dXJuIHRydWUKICB9CgogIHVwZGF0ZUJhY2tncm91bmQoKSB7CiAgICByZXR1cm4gdGhpcy51cGRhdGUoKS5jYXRjaChzYWZldHlDYXRjaCkKICB9CgogIHVwZGF0ZUludGVybmFsU2lnbmF0dXJlcyhsZW5ndGgsIHNpZ25hdHVyZXMpIHsKICAgIHRoaXMuc2lnbmF0dXJlcy5zeXN0ZW0gPSB1cGRhdGVTaWduYXR1cmUobGVuZ3RoLCBzaWduYXR1cmVzLnN5c3RlbSwgdGhpcy5zaWduYXR1cmVzLnN5c3RlbSkKICAgIHRoaXMuc2lnbmF0dXJlcy5lbmNyeXB0aW9uID0gdXBkYXRlU2lnbmF0dXJlKAogICAgICBsZW5ndGgsCiAgICAgIHNpZ25hdHVyZXMuZW5jcnlwdGlvbiwKICAgICAgdGhpcy5zaWduYXR1cmVzLmVuY3J5cHRpb24KICAgICkKICB9CgogIHVwZGF0ZVVzZXJTaWduYXR1cmVzKGxlbmd0aCwgc2lnbmF0dXJlcykgewogICAgdGhpcy5zaWduYXR1cmVzLnVzZXIgPSB1cGRhdGVTaWduYXR1cmVzKGxlbmd0aCwgc2lnbmF0dXJlcywgdGhpcy5zaWduYXR1cmVzLnVzZXIpCiAgfQoKICBtYWtlQ2hlY2twb2ludHMobGVuZ3RoKSB7CiAgICByZXR1cm4gewogICAgICBzeXN0ZW06IG1ha2VDaGVja3BvaW50KGxlbmd0aCwgdGhpcy5zaWduYXR1cmVzLnN5c3RlbSksCiAgICAgIGVuY3J5cHRpb246IG1ha2VDaGVja3BvaW50KGxlbmd0aCwgdGhpcy5zaWduYXR1cmVzLmVuY3J5cHRpb24pLAogICAgICB1c2VyOiBtYWtlQ2hlY2twb2ludHMobGVuZ3RoLCB0aGlzLnNpZ25hdHVyZXMudXNlcikKICAgIH0KICB9CgogIG1ha2VEaWdlc3QobGVuZ3RoLCBrZXkpIHsKICAgIGlmICh0aGlzLmRpZ2VzdCAmJiAodGhpcy5kaWdlc3Qua2V5ID09PSBrZXkgfHwgYjRhLmVxdWFscyh0aGlzLmRpZ2VzdC5rZXksIGtleSkpKSB7CiAgICAgIHJldHVybiB7IGtleTogbnVsbCwgcG9pbnRlcjogbGVuZ3RoIC0gdGhpcy5kaWdlc3QuYXQgfQogICAgfQogICAgdGhpcy5kaWdlc3QgPSB7IGtleSwgYXQ6IGxlbmd0aCB9CiAgICByZXR1cm4geyBrZXksIHBvaW50ZXI6IDAgfQogIH0KCiAgYXN5bmMgcmVhZHkoKSB7CiAgICBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQogICAgdGhpcy5jb3JlLm9uKCdhcHBlbmQnLCB0aGlzLnVwZGF0ZUJhY2tncm91bmQuYmluZCh0aGlzKSkKICAgIGlmICh0aGlzLmNvcmUud3JpdGFibGUpIGF3YWl0IHRoaXMudXBkYXRlQ2hlY2twb2ludHMoKQogICAgdGhpcy51cGRhdGVCYWNrZ3JvdW5kKCkKICB9CgogIHNpZ25lZExlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLnNpZ25hdHVyZXMuc3lzdGVtID8gdGhpcy5zaWduYXR1cmVzLnN5c3RlbS5sZW5ndGggOiAwCiAgfQoKICBjbG9zZSgpIHsKICAgIHRoaXMuY2xvc2VkID0gdHJ1ZQogICAgcmV0dXJuIHRoaXMuY29yZS5jbG9zZSgpCiAgfQoKICBhc3luYyBfaW5mbGF0ZURpZ2VzdChsZW5ndGgsIGRpZykgewogICAgaWYgKCFkaWcpIHJldHVybiBudWxsCgogICAgaWYgKGRpZy5wb2ludGVyID09PSAwKSB7CiAgICAgIHJldHVybiB7IGtleTogZGlnLmtleSwgYXQ6IGxlbmd0aCB9CiAgICB9CgogICAgY29uc3QgbGVuID0gbGVuZ3RoIC0gZGlnLnBvaW50ZXIKCiAgICBpZiAodGhpcy5kaWdlc3QgJiYgbGVuID09PSB0aGlzLmRpZ2VzdC5hdCkgcmV0dXJuIHRoaXMuZGlnZXN0CiAgICBpZiAobGVuIDw9IDApIHJldHVybiBudWxsCgogICAgY29uc3QgeyBkaWdlc3QgfSA9IGF3YWl0IHRoaXMuY29yZS5nZXQobGVuIC0gMSkKICAgIGlmICghZGlnZXN0IHx8ICFkaWdlc3Qua2V5KSByZXR1cm4gbnVsbAoKICAgIHJldHVybiB7IGtleTogZGlnZXN0LmtleSwgYXQ6IGxlbiB9CiAgfQoKICBfc2FtZVNpZ25hdHVyZXMoYiwgYSkgewogICAgcmV0dXJuICgKICAgICAgc2FtZVNpZ25hdHVyZShhLnN5c3RlbSwgYi5zeXN0ZW0pICYmCiAgICAgIHNhbWVTaWduYXR1cmUoYS5lbmNyeXB0aW9uLCBiLmVuY3J5cHRpb24pICYmCiAgICAgIHNhbWVTaWduYXR1cmVzKGEudXNlciwgYi51c2VyKQogICAgKQogIH0KCiAgYXN5bmMgX2luZmxhdGVBbGxDaGVja3BvaW50cyhsZW5ndGgsIGNoZWNrcG9pbnRzKSB7CiAgICBpZiAoIWNoZWNrcG9pbnRzKSByZXR1cm4geyBzeXN0ZW06IG51bGwsIGVuY3J5cHRpb246IG51bGwsIHVzZXI6IFtdIH0KICAgIGlmICh0aGlzLl9zYW1lU2lnbmF0dXJlcyhjaGVja3BvaW50cywgdGhpcy5zaWduYXR1cmVzKSkgcmV0dXJuIHRoaXMuc2lnbmF0dXJlcwoKICAgIGNvbnN0IHN5c3RlbSA9IHRoaXMuX2luZmxhdGVTeXN0ZW1DaGVja3BvaW50KGNoZWNrcG9pbnRzLnN5c3RlbSwgbGVuZ3RoKQogICAgY29uc3QgZW5jcnlwdGlvbiA9IHRoaXMuX2luZmxhdGVFbmNyeXB0aW9uQ2hlY2twb2ludChjaGVja3BvaW50cy5lbmNyeXB0aW9uLCBsZW5ndGgpCgogICAgY29uc3QgdXNlciA9IGNoZWNrcG9pbnRzLnVzZXIgPyBuZXcgQXJyYXkoY2hlY2twb2ludHMudXNlci5sZW5ndGgpIDogW10KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHVzZXIubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgY2hrID0gY2hlY2twb2ludHMudXNlcltpXQogICAgICB1c2VyW2ldID0gdGhpcy5faW5mbGF0ZVVzZXJDaGVja3BvaW50KGNoaywgaSwgbGVuZ3RoKQogICAgfQoKICAgIGNvbnN0IFtzeXN0ZW1DaGVja3BvaW50LCBlbmNyeXB0aW9uQ2hlY2twb2ludCwgdXNlckNoZWNrcG9pbnRzXSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgICAgc3lzdGVtLAogICAgICBlbmNyeXB0aW9uLAogICAgICBQcm9taXNlLmFsbCh1c2VyKQogICAgXSkKCiAgICByZXR1cm4gewogICAgICBzeXN0ZW06IHN5c3RlbUNoZWNrcG9pbnQsCiAgICAgIGVuY3J5cHRpb246IGVuY3J5cHRpb25DaGVja3BvaW50LAogICAgICB1c2VyOiB1c2VyQ2hlY2twb2ludHMKICAgIH0KICB9CgogIGFzeW5jIF9pbmZsYXRlU3lzdGVtQ2hlY2twb2ludChjaGssIGNvcmVMZW5ndGgpIHsKICAgIGlmIChjaGsuY2hlY2twb2ludCkgewogICAgICBjb25zdCB7IHNpZ25hdHVyZSwgbGVuZ3RoIH0gPSBjaGsuY2hlY2twb2ludAogICAgICByZXR1cm4geyBzaWduYXR1cmUsIGxlbmd0aCwgYXQ6IGNvcmVMZW5ndGggfQogICAgfQoKICAgIGNvbnN0IGxlbiA9IGNvcmVMZW5ndGggLSBjaGsuY2hlY2twb2ludGVyCiAgICBpZiAodGhpcy5zaWduYXR1cmVzLnN5c3RlbSAmJiB0aGlzLnNpZ25hdHVyZXMuc3lzdGVtLmF0ID09PSBsZW4pIHsKICAgICAgcmV0dXJuIHRoaXMuc2lnbmF0dXJlcy5zeXN0ZW0KICAgIH0KCiAgICBpZiAobGVuIDw9IDApIHJldHVybiBudWxsCgogICAgY29uc3QgeyBjaGVja3BvaW50IH0gPSBhd2FpdCB0aGlzLmNvcmUuZ2V0KGxlbiAtIDEpCiAgICBpZiAoIWNoZWNrcG9pbnQgfHwgIWNoZWNrcG9pbnQuc3lzdGVtIHx8ICFjaGVja3BvaW50LnN5c3RlbS5jaGVja3BvaW50KSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHsgc2lnbmF0dXJlLCBsZW5ndGggfSA9IGNoZWNrcG9pbnQuc3lzdGVtLmNoZWNrcG9pbnQKICAgIHJldHVybiB7IHNpZ25hdHVyZSwgbGVuZ3RoLCBhdDogbGVuIH0KICB9CgogIGFzeW5jIF9pbmZsYXRlRW5jcnlwdGlvbkNoZWNrcG9pbnQoY2hrLCBjb3JlTGVuZ3RoKSB7CiAgICBpZiAoIWNoaykgcmV0dXJuIHsgbGVuZ3RoOiAwLCBzaWduYXR1cmU6IG51bGwsIGF0OiAwIH0KCiAgICBpZiAoY2hrLmNoZWNrcG9pbnQpIHsKICAgICAgY29uc3QgeyBzaWduYXR1cmUsIGxlbmd0aCB9ID0gY2hrLmNoZWNrcG9pbnQKICAgICAgcmV0dXJuIHsgc2lnbmF0dXJlLCBsZW5ndGgsIGF0OiBjb3JlTGVuZ3RoIH0KICAgIH0KCiAgICBjb25zdCBsZW4gPSBjb3JlTGVuZ3RoIC0gY2hrLmNoZWNrcG9pbnRlcgogICAgaWYgKHRoaXMuc2lnbmF0dXJlcy5lbmNyeXB0aW9uICYmIHRoaXMuc2lnbmF0dXJlcy5lbmNyeXB0aW9uLmF0ID09PSBsZW4pIHsKICAgICAgcmV0dXJuIHRoaXMuc2lnbmF0dXJlcy5lbmNyeXB0aW9uCiAgICB9CgogICAgaWYgKGxlbiA8PSAwKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHsgY2hlY2twb2ludCB9ID0gYXdhaXQgdGhpcy5jb3JlLmdldChsZW4gLSAxKQogICAgaWYgKCFjaGVja3BvaW50IHx8ICFjaGVja3BvaW50LmVuY3J5cHRpb24gfHwgIWNoZWNrcG9pbnQuZW5jcnlwdGlvbi5jaGVja3BvaW50KSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHsgc2lnbmF0dXJlLCBsZW5ndGggfSA9IGNoZWNrcG9pbnQuZW5jcnlwdGlvbi5jaGVja3BvaW50CiAgICByZXR1cm4geyBzaWduYXR1cmUsIGxlbmd0aCwgYXQ6IGxlbiB9CiAgfQoKICBhc3luYyBfaW5mbGF0ZVVzZXJDaGVja3BvaW50KGNoaywgaSwgY29yZUxlbmd0aCkgewogICAgaWYgKGNoay5jaGVja3BvaW50KSB7CiAgICAgIGNvbnN0IHsgc2lnbmF0dXJlLCBsZW5ndGggfSA9IGNoay5jaGVja3BvaW50CiAgICAgIHJldHVybiB7IHNpZ25hdHVyZSwgbGVuZ3RoLCBhdDogY29yZUxlbmd0aCB9CiAgICB9CgogICAgY29uc3QgbGVuID0gY29yZUxlbmd0aCAtIGNoay5jaGVja3BvaW50ZXIKICAgIGlmIChpIDwgdGhpcy5zaWduYXR1cmVzLnVzZXIubGVuZ3RoICYmIHRoaXMuc2lnbmF0dXJlcy51c2VyW2ldLmF0ID09PSBsZW4pIHsKICAgICAgcmV0dXJuIHRoaXMuc2lnbmF0dXJlcy51c2VyW2ldCiAgICB9CgogICAgaWYgKGxlbiA8PSAwKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHsgY2hlY2twb2ludCB9ID0gYXdhaXQgdGhpcy5jb3JlLmdldChsZW4gLSAxKQogICAgaWYgKCFjaGVja3BvaW50IHx8IGkgPj0gY2hlY2twb2ludC51c2VyLmxlbmd0aCB8fCAhY2hlY2twb2ludC51c2VyW2ldLmNoZWNrcG9pbnQpIHJldHVybiBudWxsCgogICAgY29uc3QgeyBzaWduYXR1cmUsIGxlbmd0aCB9ID0gY2hlY2twb2ludC51c2VyW2ldLmNoZWNrcG9pbnQKICAgIHJldHVybiB7IHNpZ25hdHVyZSwgbGVuZ3RoLCBhdDogbGVuIH0KICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQXBwbHlTdGF0ZSBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yKGJhc2UpIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgICB0aGlzLmVuY3J5cHRpb24gPSB0aGlzLmJhc2UuZW5jcnlwdGlvbgogICAgdGhpcy52YWx1ZUVuY29kaW5nID0gYmFzZS52YWx1ZUVuY29kaW5nCiAgICB0aGlzLnN0b3JlID0gYmFzZS5fdmlld1N0b3JlLmF0b21pemUoKQogICAgdGhpcy5rZXkgPSBudWxsCiAgICB0aGlzLnN5c3RlbSA9IG51bGwKICAgIHRoaXMudmlldyA9IG51bGwKICAgIHRoaXMudmlld3MgPSBbXQogICAgdGhpcy5zeXN0ZW1WaWV3ID0gbnVsbAogICAgdGhpcy5lbmNyeXB0aW9uVmlldyA9IG51bGwKICAgIHRoaXMuaG9zdGNhbGxzID0gbnVsbAogICAgdGhpcy5jaGFuZ2VzID0gYmFzZS5faGFzVXBkYXRlID8gbmV3IFVwZGF0ZUNoYW5nZXMoYmFzZSkgOiBudWxsCgogICAgdGhpcy51cGRhdGVzID0gW10KCiAgICB0aGlzLmxvY2FsID0gbnVsbAogICAgdGhpcy5sb2NhbFN0YXRlID0gbnVsbAoKICAgIHRoaXMuZmFzdEZvcndhcmRpbmcgPSBmYWxzZQogICAgdGhpcy5pbmRleGVyc1VwZGF0ZWQgPSBmYWxzZQogICAgdGhpcy5xdW9ydW0gPSAwCiAgICB0aGlzLm5lZWRzSW5kZXhlZExlbmd0aFVwZGF0ZSA9IGZhbHNlCiAgICB0aGlzLmludGVycnVwdGVkID0gZmFsc2UKICAgIHRoaXMuYXBwbHlpbmcgPSBudWxsCiAgICB0aGlzLmFwcGx5QmF0Y2ggPSBudWxsCgogICAgdGhpcy5sb2NhbENoZWNrcG9pbnQgPSBudWxsCiAgICB0aGlzLmxvY2FsSW5kZXhlciA9IGZhbHNlCgogICAgdGhpcy5zeXN0ZW1VcGdyYWRlID0gbnVsbAoKICAgIHRoaXMuY2hlY2twb2ludHMgPSBbXQogICAgdGhpcy5wZW5kaW5nVmlld3MgPSBudWxsCiAgICB0aGlzLnBlbmRpbmdGb3JrID0gbnVsbAogICAgdGhpcy5kaXJ0eSA9IGZhbHNlCiAgfQoKICBzaG91bGRGbHVzaCgpIHsKICAgIHJldHVybiB0aGlzLmRpcnR5CiAgfQoKICBhc3luYyBzaG91bGRXcml0ZSgpIHsKICAgIGlmICghdGhpcy5sb2NhbEluZGV4ZXIgfHwgIXRoaXMubG9jYWxDaGVja3BvaW50IHx8ICF0aGlzLmxvY2FsQ2hlY2twb2ludC5jb3JlLm9wZW5lZCkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBjb25zdCBpbmZvID0gYXdhaXQgdGhpcy5zeXN0ZW0uZ2V0SW5kZXhlZEluZm8odGhpcy5pbmRleGVkTGVuZ3RoKQogICAgaWYgKCFpbmZvLnZpZXdzLmxlbmd0aCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgeyBlbmNyeXB0aW9uLCB1c2VyIH0gPSB0aGlzLmxvY2FsQ2hlY2twb2ludC5zaWduYXR1cmVzCgogICAgLy8gdG9kbzogZG9lcyB0aGlzIGNvbmRpdGlvbiBob2xkIGZvciBzb2Z0LWZvcms/CiAgICBpZiAoaW5mby52aWV3cy5sZW5ndGggPiB1c2VyLmxlbmd0aCkgcmV0dXJuIHRydWUKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZm8udmlld3MubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHVzZXJbaV0ubGVuZ3RoICsgU0hPVUxEX1NJR05fVEhSRVNIT0xEIDwgaW5mby52aWV3c1tpXS5sZW5ndGgpIHJldHVybiB0cnVlCiAgICB9CgogICAgLy8gYWx3YXlzIGZsdXNoIGVuY3J5cHRpb24gc2lnbmF0dXJlCiAgICBpZiAoaW5mby5lbmNyeXB0aW9uTGVuZ3RoICE9PSAwKSB7CiAgICAgIGlmICghZW5jcnlwdGlvbiB8fCBlbmNyeXB0aW9uLmxlbmd0aCA8IGluZm8uZW5jcnlwdGlvbkxlbmd0aCkgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIGdldCBpbmRleGVkTGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuc3lzdGVtVmlldyA/IHRoaXMuc3lzdGVtVmlldy5pbmRleGVkTGVuZ3RoIDogMAogIH0KCiAgZ2V0IHN5c3RlbVJlZigpIHsKICAgIHJldHVybiB0aGlzLnN5c3RlbVZpZXcgPyB0aGlzLnN5c3RlbVZpZXcucmVmIDogbnVsbAogIH0KCiAgYXN5bmMgdmFsaWRhdGVGb3JrKGluZGV4ZXJLZXlzLCBzeXN0ZW0pIHsKICAgIGlmICghYjRhLmVxdWFscyhzeXN0ZW0ua2V5LCB0aGlzLnN5c3RlbS5jb3JlLmtleSkpIHJldHVybiBmYWxzZQogICAgaWYgKHRoaXMucGVuZGluZ0luZGV4ZWRMZW5ndGgoKSA8IHN5c3RlbS5sZW5ndGgpIHJldHVybiBmYWxzZQogICAgZm9yIChjb25zdCBrZXkgb2YgaW5kZXhlcktleXMpIHsKICAgICAgY29uc3QgaW5mbyA9IGF3YWl0IHRoaXMuc3lzdGVtLmdldChrZXkpCgogICAgICAvLyB3cml0ZXIgc2hvdWxkIGJlIGFjdGl2ZSBhbmQgd2UgbmVlZCBtYW5pZmVzdAogICAgICBpZiAoIWluZm8gfHwgIWluZm8ubGVuZ3RoIHx8IGluZm8uaXNSZW1vdmVkKSByZXR1cm4gZmFsc2UKICAgIH0KICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBzaG91bGRNaWdyYXRlKCkgewogICAgaWYgKCF0aGlzLmZhc3RGb3J3YXJkaW5nICYmICF0aGlzLmluZGV4ZXJzVXBkYXRlZCkgcmV0dXJuIGZhbHNlCiAgICBpZiAodGhpcy5zeXN0ZW0uaW5kZXhlcnMubGVuZ3RoID09PSAwKSByZXR1cm4gZmFsc2UgLy8gZ2VuZXNpcwoKICAgIC8vIHNhbml0eSwgcHJlZmVyIG1pZ3JhdGlvbgogICAgaWYgKCF0aGlzLnN5c3RlbS5jb3JlLm1hbmlmZXN0IHx8ICF0aGlzLnN5c3RlbS5jb3JlLm1hbmlmZXN0LnNpZ25lcnMpIHJldHVybiB0cnVlCgogICAgLy8gZWFzeSBtb2RlCiAgICBpZiAodGhpcy5zeXN0ZW0uaW5kZXhlcnMubGVuZ3RoICE9PSB0aGlzLnN5c3RlbS5jb3JlLm1hbmlmZXN0LnNpZ25lcnMubGVuZ3RoKSB7CiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgY29uc3QgbWFuaWZlc3RzID0gYXdhaXQgdGhpcy5zdG9yZS5nZXRJbmRleGVyTWFuaWZlc3RzKHRoaXMuc3lzdGVtLmluZGV4ZXJzKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zeXN0ZW0uY29yZS5tYW5pZmVzdC5zaWduZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHsgcHVibGljS2V5IH0gPSB0aGlzLnN5c3RlbS5jb3JlLm1hbmlmZXN0LnNpZ25lcnNbaV0KICAgICAgaWYgKCFiNGEuZXF1YWxzKHB1YmxpY0tleSwgbWFuaWZlc3RzW2ldLnNpZ25lcnNbMF0ucHVibGljS2V5KSkgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIGlzTG9jYWxQZW5kaW5nSW5kZXhlcigpIHsKICAgIGlmICh0aGlzLnN5c3RlbS5wZW5kaW5nSW5kZXhlcnMubGVuZ3RoID09PSAwKSByZXR1cm4gZmFsc2UKICAgIGNvbnN0IGtleSA9IHRoaXMuYmFzZS5sb2NhbC5rZXkKICAgIGZvciAoY29uc3QgayBvZiB0aGlzLnN5c3RlbS5wZW5kaW5nSW5kZXhlcnMpIHsKICAgICAgaWYgKGI0YS5lcXVhbHMoaywga2V5KSkgcmV0dXJuICFiNGEuZXF1YWxzKHRoaXMuYmFzZS5rZXksIGtleSkgJiYgdGhpcy5iYXNlLmxvY2FsLmxlbmd0aCA9PT0gMAogICAgfQogICAgcmV0dXJuIGZhbHNlCiAgfQoKICByZW1vdmVhYmxlKGtleSkgewogICAgaWYgKHRoaXMuc3lzdGVtLmluZGV4ZXJzLmxlbmd0aCAhPT0gMSkgcmV0dXJuIHRydWUKICAgIHJldHVybiAhYjRhLmVxdWFscyh0aGlzLnN5c3RlbS5pbmRleGVyc1swXS5rZXksIGtleSkKICB9CgogIGlzTG9jYWxJbmRleGVyKCkgewogICAgcmV0dXJuICEhdGhpcy5sb2NhbENoZWNrcG9pbnQKICB9CgogIF9jcmVhdGVDaGVja3BvaW50Q29yZShrZXksIGFjdGl2ZSwgc2lnbmVyLCBwYXVzZWQpIHsKICAgIGNvbnN0IGVuY3J5cHRpb24gPSB0aGlzLmJhc2UuZ2V0V3JpdGVyRW5jcnlwdGlvbihrZXkpCgogICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuYmFzZS5zdG9yZS5nZXQoewogICAgICBrZXksCiAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZSwKICAgICAgZW5jcnlwdGlvbiwKICAgICAgYWN0aXZlCiAgICB9KQoKICAgIHJldHVybiBuZXcgQ2hlY2twb2ludENvcmUodGhpcywgc2Vzc2lvbiwgc2lnbmVyLCBwYXVzZWQpCiAgfQoKICBhc3luYyBfb3BlbkludGVybmFsVmlldyhuYW1lLCBpbmRleGVkTGVuZ3RoKSB7CiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoeyBuYW1lIH0pCiAgICBhd2FpdCBjb3JlLnJlYWR5KCkKICAgIGF3YWl0IGNvcmUuc2V0VXNlckRhdGEoJ3JlZmVycmVyJywgdGhpcy5iYXNlLmtleSkKICAgIGF3YWl0IGNvcmUuc2V0VXNlckRhdGEoJ2F1dG9iYXNlL3ZpZXcnLCBiNGEuZnJvbShuYW1lKSkKCiAgICBjb25zdCByZWYgPSB0aGlzLnN0b3JlLmdldFZpZXdCeU5hbWUobmFtZSkKCiAgICByZXR1cm4geyByZWYsIGNvcmUsIGluZGV4ZWRMZW5ndGggfQogIH0KCiAgYXN5bmMgX29wZW4oKSB7CiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9ib290KCkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBhd2FpdCB0aGlzLl9mcmVlKCkKICAgICAgdGhyb3cgZXJyCiAgICB9CiAgfQoKICBhc3luYyBfYm9vdCgpIHsKICAgIGNvbnN0IGJvb3QgPSBhd2FpdCB0aGlzLmJhc2UuX2dldEJvb3RSZWNvcmQoKQoKICAgIHRoaXMuc3lzdGVtVmlldyA9IGF3YWl0IHRoaXMuX29wZW5JbnRlcm5hbFZpZXcoJ19zeXN0ZW0nLCBib290LnN5c3RlbUxlbmd0aCkKICAgIHRoaXMuZW5jcnlwdGlvblZpZXcgPSBhd2FpdCB0aGlzLl9vcGVuSW50ZXJuYWxWaWV3KCdfZW5jcnlwdGlvbicsIC0xKQoKICAgIGNvbnN0IHN5c0NvcmUgPSB0aGlzLnN5c3RlbVZpZXcuY29yZQogICAgaWYgKHN5c0NvcmUubWFuaWZlc3QudmVyc2lvbiA+PSAyKSB7CiAgICAgIGlmICh0aGlzLmVuY3J5cHRpb24gIT09IG51bGwpIGF3YWl0IHRoaXMuZW5jcnlwdGlvbi5yZWxvYWQodGhpcy5lbmNyeXB0aW9uVmlldy5jb3JlKQogICAgfQoKICAgIGNvbnN0IHN5c3RlbSA9IG5ldyBTeXN0ZW1WaWV3KHN5c0NvcmUpCiAgICBhd2FpdCBzeXN0ZW0ucmVhZHkoKQoKICAgIC8vIHJlc2V0IHNvIHdlIGRvbnQgdHJhY2sgX3N5c3RlbSBvciBfZW5jcnlwdGlvbgogICAgdGhpcy5zdG9yZS5vcGVuZWQgPSBbXQoKICAgIHRoaXMuaG9zdGNhbGxzID0gbmV3IFByaXZhdGVBcHBseUNhbGxzKHRoaXMpCiAgICBjb25zdCB2aWV3ID0gdGhpcy5iYXNlLl9oYXNPcGVuID8gdGhpcy5iYXNlLl9oYW5kbGVycy5vcGVuKHRoaXMuc3RvcmUsIHRoaXMuaG9zdGNhbGxzKSA6IG51bGwKCiAgICB0aGlzLnZpZXcgPSB2aWV3CiAgICB0aGlzLnN5c3RlbSA9IHN5c3RlbQoKICAgIC8vIGVuc3VyZSBhbGwgYXJlIHJlYWR5CiAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy5zdG9yZS5vcGVuZWQpIGF3YWl0IHYuYXRvbWljQmF0Y2gucmVhZHkoKQoKICAgIHRoaXMua2V5ID0gc3lzdGVtLmNvcmUua2V5CgogICAgdGhpcy5mYXN0Rm9yd2FyZGluZyA9IGJvb3QuZmFzdEZvcndhcmRpbmcKICAgIHRoaXMuaW5kZXhlcnNVcGRhdGVkID0gYm9vdC5pbmRleGVyc1VwZGF0ZWQKICAgIHRoaXMucXVvcnVtID0gc3lzQ29yZS5tYW5pZmVzdCA/IHN5c0NvcmUubWFuaWZlc3QucXVvcnVtIDogMAoKICAgIGNvbnN0IGFkZGVkID0gbmV3IFNldCgpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzeXN0ZW0udmlld3MubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgeyBrZXksIGxlbmd0aCB9ID0gc3lzdGVtLnZpZXdzW2ldCiAgICAgIGNvbnN0IHYgPSBhd2FpdCB0aGlzLnN0b3JlLmZpbmRWaWV3QnlLZXkoCiAgICAgICAga2V5LAogICAgICAgIHN5c3RlbS5pbmRleGVycywKICAgICAgICBzeXNDb3JlLm1hbmlmZXN0LnZlcnNpb24sCiAgICAgICAgc3lzdGVtLmVudHJvcHkKICAgICAgKQoKICAgICAgaWYgKHYgPT09IG51bGwpIHsKICAgICAgICB0aGlzLnZpZXdzLnB1c2goeyBuYW1lOiBudWxsLCBrZXksIGxlbmd0aCwgY29yZTogbnVsbCwgcmVmOiBudWxsLCBtYXBwZWRJbmRleDogaSB9KQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGF3YWl0IHYuYXRvbWljQmF0Y2gucmVhZHkoKQogICAgICBhd2FpdCB2LmNvcmUuc2V0VXNlckRhdGEoJ3JlZmVycmVyJywgdGhpcy5iYXNlLmtleSkKICAgICAgYXdhaXQgdi5jb3JlLnNldFVzZXJEYXRhKCdhdXRvYmFzZS92aWV3JywgYjRhLmZyb20odi5uYW1lKSkKCiAgICAgIHRoaXMudmlld3MucHVzaCh7IG5hbWU6IHYubmFtZSwga2V5LCBsZW5ndGgsIGNvcmU6IHYuYXRvbWljQmF0Y2gsIHJlZjogdiwgbWFwcGVkSW5kZXg6IGkgfSkKCiAgICAgIGFkZGVkLmFkZCh2KQogICAgfQoKICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLnN0b3JlLm9wZW5lZCkgewogICAgICBpZiAoYWRkZWQuaGFzKHYpKSBjb250aW51ZQogICAgICBjb25zdCBjb3JlID0gdi5hdG9taWNCYXRjaAoKICAgICAgdGhpcy52aWV3cy5wdXNoKHsKICAgICAgICBuYW1lOiB2Lm5hbWUsCiAgICAgICAga2V5OiBjb3JlLmtleSwKICAgICAgICBsZW5ndGg6IGNvcmUubGVuZ3RoLAogICAgICAgIGNvcmUsCiAgICAgICAgcmVmOiB2LAogICAgICAgIG1hcHBlZEluZGV4OiAtMQogICAgICB9KQogICAgfQoKICAgIHRoaXMubG9jYWwgPSB0aGlzLnN0b3JlLmdldExvY2FsKCkKICAgIGF3YWl0IHRoaXMubG9jYWwucmVhZHkoKQoKICAgIHRoaXMubG9jYWxTdGF0ZSA9IG5ldyBMb2NhbFN0YXRlKHRoaXMubG9jYWwpCgogICAgbGV0IGlzTG9jYWxJbmRleGVyID0gZmFsc2UKCiAgICBjb25zdCBwYXVzZWQgPSB0aGlzLmJhc2UuaXNGYXN0Rm9yd2FyZGluZygpCiAgICBjb25zdCBpbmYgPSBhd2FpdCB0aGlzLnN5c3RlbS5nZXRJbmRleGVkSW5mbygpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmYuaW5kZXhlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgaWR4ID0gaW5mLmluZGV4ZXJzW2ldCiAgICAgIGNvbnN0IGNoayA9IHRoaXMuX2NyZWF0ZUNoZWNrcG9pbnRDb3JlKGlkeC5rZXksIHRydWUsIGksIHBhdXNlZCkKICAgICAgYXdhaXQgY2hrLnJlYWR5KCkKICAgICAgdGhpcy5jaGVja3BvaW50cy5wdXNoKGNoaykKICAgICAgaWYgKGI0YS5lcXVhbHMoaWR4LmtleSwgdGhpcy5iYXNlLmxvY2FsLmtleSkpIGlzTG9jYWxJbmRleGVyID0gdHJ1ZQogICAgfQoKICAgIGNvbnN0IHNob3VsZFNpZ24gPSB0aGlzLnF1b3J1bSA+IDAgJiYgaXNMb2NhbEluZGV4ZXIKCiAgICBpZiAoc2hvdWxkU2lnbikgewogICAgICB0aGlzLmxvY2FsSW5kZXhlciA9IHRydWUKICAgICAgYXdhaXQgdGhpcy5fc3RhcnRMb2NhbENoZWNrcG9pbnQoKQogICAgfQoKICAgIGF3YWl0IHRoaXMuX3JlZnJlc2hXcml0ZXJzKCkKCiAgICAvLyBkZWZlcnJlZAogICAgdGhpcy5tYXliZVNpZ25lZCgpLmNhdGNoKG5vb3ApCiAgfQoKICBhc3luYyBfc3RhcnRMb2NhbENoZWNrcG9pbnQoKSB7CiAgICBmb3IgKGNvbnN0IGNoayBvZiB0aGlzLmNoZWNrcG9pbnRzKSB7CiAgICAgIGlmIChjaGsuY29yZS5pZCA9PT0gdGhpcy5iYXNlLmxvY2FsLmlkKSB7CiAgICAgICAgdGhpcy5sb2NhbENoZWNrcG9pbnQgPSBjaGsKICAgICAgICByZXR1cm4KICAgICAgfQogICAgfQoKICAgIHRoaXMubG9jYWxDaGVja3BvaW50ID0gdGhpcy5fY3JlYXRlQ2hlY2twb2ludENvcmUodGhpcy5iYXNlLmxvY2FsLmtleSwgZmFsc2UsIDAsIGZhbHNlKQogICAgYXdhaXQgdGhpcy5sb2NhbENoZWNrcG9pbnQucmVhZHkoKQogIH0KCiAgaW50ZXJydXB0KCkgewogICAgdGhpcy5pbnRlcnJ1cHRlZCA9IHRydWUKICAgIHRoaXMucGF1c2UoKQogIH0KCiAgcGF1c2UoKSB7CiAgICBmb3IgKGNvbnN0IGNoayBvZiB0aGlzLmNoZWNrcG9pbnRzKSB7CiAgICAgIGlmIChjaGsgIT09IHRoaXMubG9jYWxDaGVja3BvaW50KSBjaGsucGF1c2UoKQogICAgfQogIH0KCiAgcmVzdW1lKCkgewogICAgZm9yIChjb25zdCBjaGsgb2YgdGhpcy5jaGVja3BvaW50cykgewogICAgICBpZiAoY2hrICE9PSB0aGlzLmxvY2FsQ2hlY2twb2ludCkgY2hrLnJlc3VtZSgpCiAgICB9CiAgfQoKICBfY2hlY2tTeXN0ZW1VcGdyYWRlKCkgewogICAgaWYgKHRoaXMuc3lzdGVtVXBncmFkZSkgcmV0dXJuCgogICAgY29uc3QgdGFsbHkgPSBuZXcgTWFwKCkKCiAgICBmb3IgKGNvbnN0IGNoayBvZiB0aGlzLmNoZWNrcG9pbnRzKSB7CiAgICAgIGlmIChjaGsuc2lnbmVkTGVuZ3RoKCkgPD0gdGhpcy5zeXN0ZW0uY29yZS5zaWduZWRMZW5ndGgpIGNvbnRpbnVlCiAgICAgIGlmICghY2hrLmRpZ2VzdCkgY29udGludWUKCiAgICAgIGNvbnN0IGlkID0gYjRhLnRvU3RyaW5nKGNoay5kaWdlc3Qua2V5LCAnaGV4JykKICAgICAgY29uc3QgY250ID0gKHRhbGx5LmdldChpZCkgfHwgMCkgKyAxCgogICAgICBpZiAoY250ID49IHRoaXMucXVvcnVtKSB7CiAgICAgICAgdGhpcy5zeXN0ZW1VcGdyYWRlID0gY2hrLmRpZ2VzdC5rZXkKICAgICAgICB0aGlzLmJhc2UuX3F1ZXVlU3RhdGljRmFzdEZvcndhcmQodGhpcy5zeXN0ZW1VcGdyYWRlKQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICB0YWxseS5zZXQoaWQsIGNudCkKICAgIH0KICB9CgogIG1hcEluZGV4VG9WaWV3KGluZGV4KSB7CiAgICBmb3IgKGNvbnN0IHsgbWFwcGVkSW5kZXgsIHJlZiB9IG9mIHRoaXMudmlld3MpIHsKICAgICAgaWYgKG1hcHBlZEluZGV4ID09PSBpbmRleCkgcmV0dXJuIHJlZgogICAgfQogIH0KCiAgYXN5bmMgbWF5YmVTaWduZWQoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmICh0aGlzLmludGVycnVwdGVkKSByZXR1cm4KCiAgICBjb25zdCB0aHJlcyA9IHRoaXMuY2hlY2twb2ludHMubGVuZ3RoIC0gdGhpcy5xdW9ydW0KICAgIGlmICh0aHJlcyA8IDAgfHwgdGhpcy5jaGVja3BvaW50cy5sZW5ndGggPD0gdGhyZXMpIHJldHVybgoKICAgIHRoaXMuY2hlY2twb2ludHMuc29ydChjbXBDaGVja3BvaW50cykKCiAgICBjb25zdCBzaWduYWJsZUxlbmd0aCA9IHRoaXMuY2hlY2twb2ludHNbdGhyZXNdLnNpZ25lZExlbmd0aCgpCiAgICBpZiAoc2lnbmFibGVMZW5ndGggPD0gdGhpcy5zeXN0ZW0uY29yZS5zaWduZWRMZW5ndGgpIHJldHVybgoKICAgIGNvbnN0IGV4cGVjdGVkID0gdGhpcy5zeXN0ZW0uY29yZS5rZXkKCiAgICBpZiAoc2lnbmFibGVMZW5ndGggPiB0aGlzLmluZGV4ZWRMZW5ndGgpIHsKICAgICAgaWYgKCFiNGEuZXF1YWxzKGV4cGVjdGVkLCB0aGlzLmNoZWNrcG9pbnRzW3RocmVzXS5kaWdlc3Qua2V5KSkgdGhpcy5fY2hlY2tTeXN0ZW1VcGdyYWRlKCkKICAgICAgdGhpcy5uZWVkc0luZGV4ZWRMZW5ndGhVcGRhdGUgPSB0cnVlCiAgICAgIHJldHVybgogICAgfQoKICAgIGZvciAobGV0IGkgPSB0aHJlczsgaSA8IHRoaXMuY2hlY2twb2ludHMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgY2hrID0gdGhpcy5jaGVja3BvaW50c1tpXQogICAgICAvLyB3ZSBtdXN0IGFncmVlIG9uIHdoYXQgdGhlIHN5c3RlbSBpcyBvYnZzCiAgICAgIGlmICghYjRhLmVxdWFscyhleHBlY3RlZCwgY2hrLmRpZ2VzdC5rZXkpKSB7CiAgICAgICAgdGhpcy5fY2hlY2tTeXN0ZW1VcGdyYWRlKCkKICAgICAgICByZXR1cm4KICAgICAgfQogICAgICAvLyBpZiB3ZSBkb250IGhhdmUgdGhlIGluZGV4ZWQgc3RhdGUgb3Vyc2VsZiwgdGhlbiBubyB3YXkgZm9yIHVzIHRvIHZlcmlmeSAvIHBhdGNoCiAgICAgIGlmICghY2hrLnNpZ25hdHVyZXMuc3lzdGVtIHx8IGNoay5zaWduYXR1cmVzLnN5c3RlbS5sZW5ndGggPiB0aGlzLmluZGV4ZWRMZW5ndGgpIHsKICAgICAgICB0aGlzLm5lZWRzSW5kZXhlZExlbmd0aFVwZGF0ZSA9IHRydWUKICAgICAgICByZXR1cm4KICAgICAgfQogICAgfQoKICAgIHRoaXMubmVlZHNJbmRleGVkTGVuZ3RoVXBkYXRlID0gZmFsc2UKCiAgICBjb25zdCBjaGsgPSBbXQogICAgZm9yIChsZXQgaSA9IHRocmVzOyBpIDwgdGhpcy5jaGVja3BvaW50cy5sZW5ndGg7IGkrKykgewogICAgICBjaGsucHVzaCh7IHNpZ25lcjogdGhpcy5jaGVja3BvaW50c1tpXS5zaWduZXIsIHNpZ25hdHVyZXM6IHRoaXMuY2hlY2twb2ludHNbaV0uc2lnbmF0dXJlcyB9KQogICAgfQoKICAgIGNvbnN0IHsgc3lzdGVtIH0gPSB0aGlzLmNoZWNrcG9pbnRzW3RocmVzXS5zaWduYXR1cmVzCgogICAgYXdhaXQgdGhpcy5fYXNzZW1ibGVNdWx0aXNpZyhzeXN0ZW0ubGVuZ3RoLCBjaGspCiAgfQoKICBhc3luYyBfYXNzZW1ibGVNdWx0aXNpZyhzaWduYWJsZUxlbmd0aCwgY2hlY2twb2ludHMpIHsKICAgIGNvbnN0IHZpZXdzID0gbmV3IEFycmF5KHRoaXMudmlld3MubGVuZ3RoICsgMikgLy8gKzIgaXMgc3lzdGVtICsgZW5jcnlwdGlvbgoKICAgIGNvbnN0IHN5cyA9IGF3YWl0IHRoaXMuc3lzdGVtLmdldEluZGV4ZWRJbmZvKHNpZ25hYmxlTGVuZ3RoKQoKICAgIGlmICh0aGlzLmludGVycnVwdGVkKSByZXR1cm4KCiAgICBpZiAodGhpcy5wZW5kaW5nVmlld3MgJiYgdGhpcy5wZW5kaW5nVmlld3NbMF0ubGVuZ3RoID49IHNpZ25hYmxlTGVuZ3RoKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIHZpZXdzWzBdID0gY3JlYXRlQ2hlY2twb2ludFNpZ25hdHVyZShzaWduYWJsZUxlbmd0aCwgdGhpcy5zeXN0ZW1WaWV3LCBjaGVja3BvaW50cy5sZW5ndGgpCgogICAgaWYgKHN5cy5lbmNyeXB0aW9uTGVuZ3RoKSB7CiAgICAgIHZpZXdzWzFdID0gY3JlYXRlQ2hlY2twb2ludFNpZ25hdHVyZSgKICAgICAgICBzeXMuZW5jcnlwdGlvbkxlbmd0aCwKICAgICAgICB0aGlzLmVuY3J5cHRpb25WaWV3LAogICAgICAgIGNoZWNrcG9pbnRzLmxlbmd0aAogICAgICApCiAgICB9CgogICAgY29uc3Qgb2Zmc2V0ID0gMiAvLyBzeXN0ZW0gKyBlbmNyeXB0aW9uCgogICAgZm9yIChsZXQgaSA9IG9mZnNldDsgaSA8IHZpZXdzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHZpZXcgPSB0aGlzLnZpZXdzW2kgLSBvZmZzZXRdCiAgICAgIGNvbnN0IGNvcmUgPSB2aWV3LmNvcmUKCiAgICAgIGNvbnN0IHYgPSB0aGlzLmdldFZpZXdGcm9tU3lzdGVtKHZpZXcsIHN5cykKICAgICAgY29uc3QgbGVuZ3RoID0gdiA/IHYubGVuZ3RoIDogMAoKICAgICAgaWYgKCFjb3JlIHx8IGxlbmd0aCA8PSBjb3JlLnNpZ25lZExlbmd0aCkgY29udGludWUKCiAgICAgIGNvbnN0IHZpZXdJbmRleCA9IHZpZXcubWFwcGVkSW5kZXggKyBvZmZzZXQKICAgICAgdmlld3Nbdmlld0luZGV4XSA9IGNyZWF0ZUNoZWNrcG9pbnRTaWduYXR1cmUobGVuZ3RoLCB2aWV3LCBjaGVja3BvaW50cy5sZW5ndGgpCiAgICB9CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGVja3BvaW50cy5sZW5ndGg7IGkrKykgewogICAgICBhZGRDaGVja3BvaW50U2lnbmF0dXJlcyh2aWV3cywgY2hlY2twb2ludHMsIGkpCiAgICB9CgogICAgY29uc3QgcHJvbWlzZXMgPSBbXQogICAgZm9yIChjb25zdCB2aWV3IG9mIHZpZXdzKSB7CiAgICAgIGlmICghdmlldykgY29udGludWUKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmlldy5zaWduYXR1cmVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcHJvbWlzZXMucHVzaChzZXRQYXJ0aWFsU2lnbmF0dXJlKHZpZXcsIGkpKQogICAgICB9CiAgICB9CgogICAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpCgogICAgLy8gY2hlY2sgdGhhdCB0aGUgc3RhdGUgc3RpbGwgbG9va3MgZ29vZCwgY291cGxlIHJlcGxpY2F0ZSBpbmJldHdlZW4uLi4KICAgIGZvciAoY29uc3QgdiBvZiB2aWV3cykgewogICAgICBpZiAoIXYpIGNvbnRpbnVlCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHYuc2lnbmF0dXJlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICghdi5wYXJ0aWFsc1tpXSkgcmV0dXJuCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5pbnRlcnJ1cHRlZCkgcmV0dXJuCgogICAgaWYgKHRoaXMucGVuZGluZ1ZpZXdzICYmIHRoaXMucGVuZGluZ1ZpZXdzWzBdLmxlbmd0aCA+PSBzaWduYWJsZUxlbmd0aCkgewogICAgICByZXR1cm4KICAgIH0KICAgIC8vIHNraXBwZWQgc3lzdGVtIGZvciB3aGF0ZXZlciByZWFzb24uLi4KICAgIGlmICghdmlld3NbMF0pIHJldHVybgoKICAgIHRoaXMucGVuZGluZ1ZpZXdzID0gdmlld3MKICAgIHRoaXMuZGlydHkgPSB0cnVlCgogICAgLy8gVE9ETzogb25seSBuZWVkZWQgaWYgbm90IHVwZGF0aW5nLCB3b250IGNyYXNoIHNvIGtlZXBpbmcgZm9yIG5vdywganVzdCBsZXNzIGVmZmljaWVudAogICAgdGhpcy5iYXNlLl9xdWV1ZUJ1bXAoKQogIH0KCiAgX2Nsb3NlKCkgewogICAgaWYgKHRoaXMuaW50ZXJydXB0ZWQpIHJldHVybgogICAgcmV0dXJuIHRoaXMuX2ZyZWUoKQogIH0KCiAgYXN5bmMgX2ZyZWUoKSB7CiAgICB0aGlzLmludGVycnVwdGVkID0gdHJ1ZQogICAgaWYgKHRoaXMuYXBwbHlpbmcpIHRoaXMuX3Bvc3RBcHBseSgpCiAgICBmb3IgKGNvbnN0IGNoayBvZiB0aGlzLmNoZWNrcG9pbnRzKSBhd2FpdCBjaGsuY2xvc2UoKQogICAgaWYgKHRoaXMubG9jYWxDaGVja3BvaW50KSBhd2FpdCB0aGlzLmxvY2FsQ2hlY2twb2ludC5jbG9zZSgpCiAgICBpZiAodGhpcy52aWV3ICYmIHRoaXMuYmFzZS5faGFzQ2xvc2UpIGF3YWl0IHRoaXMuYmFzZS5faGFuZGxlcnMuY2xvc2UodGhpcy52aWV3KQogICAgaWYgKHRoaXMuc3lzdGVtKSBhd2FpdCB0aGlzLnN5c3RlbS5jbG9zZSgpCgogICAgY29uc3QgcHJvbWlzZXMgPSBbXQogICAgZm9yIChjb25zdCB2IG9mIHRoaXMudmlld3MpIHsKICAgICAgaWYgKHYucmVmKSBwcm9taXNlcy5wdXNoKHYucmVmLnJlbGVhc2UoKSkKICAgIH0KCiAgICBpZiAodGhpcy5zeXN0ZW1WaWV3KSBwcm9taXNlcy5wdXNoKHRoaXMuc3lzdGVtVmlldy5yZWYucmVsZWFzZSgpKQogICAgaWYgKHRoaXMuZW5jcnlwdGlvblZpZXcpIHByb21pc2VzLnB1c2godGhpcy5lbmNyeXB0aW9uVmlldy5yZWYucmVsZWFzZSgpKQoKICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKQogICAgYXdhaXQgdGhpcy5zdG9yZS5jbG9zZSgpCiAgfQoKICBfcHVzaFVwZGF0ZSh1KSB7CiAgICB1LnZlcnNpb24gPSAxCiAgICB1LnNlcSA9IHRoaXMudXBkYXRlcy5sZW5ndGggPT09IDAgPyAwIDogdGhpcy51cGRhdGVzW3RoaXMudXBkYXRlcy5sZW5ndGggLSAxXS5zZXEgKyAxCiAgICB1LnN5c3RlbUxlbmd0aCA9IHRoaXMuc3lzdGVtVmlldy5jb3JlLmxlbmd0aAogICAgdGhpcy51cGRhdGVzLnB1c2godSkKICAgIHRoaXMubG9jYWxTdGF0ZS5pbnNlcnRVcGRhdGUodSkKICB9CgogIGFzeW5jIGNhdGNodXAobGluZWFyaXplcikgewogICAgaWYgKCF0aGlzLm9wZW5lZCkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAoIXRoaXMuc3lzdGVtLmhlYWRzLmxlbmd0aCkgcmV0dXJuIHRydWUKCiAgICBjb25zdCB3cml0ZXJzID0gbmV3IE1hcCgpCgogICAgLy8gbG9hZCBsaW5lYXJpemVyLi4uCiAgICBjb25zdCB1cGRhdGVzID0gYXdhaXQgdGhpcy5sb2NhbFN0YXRlLmxpc3RVcGRhdGVzKCkKICAgIGNvbnN0IHN5cyA9IGF3YWl0IHRoaXMuc3lzdGVtLmNoZWNrb3V0KHRoaXMuaW5kZXhlZExlbmd0aCkKCiAgICBmb3IgKGNvbnN0IG5vZGUgb2YgdXBkYXRlcykgewogICAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcobm9kZS5rZXksICdoZXgnKQoKICAgICAgbGV0IHcgPSB3cml0ZXJzLmdldChoZXgpCgogICAgICBpZiAodyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgLy8gVE9ETzogd2UgYWN0dWFsbHkgaGF2ZSBhbGwgdGhlIHdyaXRlciBpbmZvIGFscmVhZHkgYnV0IG91ciBjdXJyZW50IG1ldGhvZHMgbWFrZSBpdCBoYXJkIHRvIHJldXNlIHRoYXQKICAgICAgICB3ID0gYXdhaXQgdGhpcy5iYXNlLl9nZXRXcml0ZXJCeUtleShub2RlLmtleSwgLTEsIDAsIHRydWUsIGZhbHNlLCBzeXMpCiAgICAgICAgd3JpdGVycy5zZXQoaGV4LCB3KQogICAgICB9CgogICAgICBpZiAody5sZW5ndGggPj0gbm9kZS5sZW5ndGgpIHsKICAgICAgICB0aGlzLmJhc2UuX3dhcm4obmV3IEVycm9yKCdVcGRhdGUgZXhwZWN0cyB3cml0ZXIgdG8gYmUgY29uc3VtZWQgaGVyZScpKQogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9CgogICAgICB3aGlsZSAody5sZW5ndGggPCBub2RlLmxlbmd0aCkgewogICAgICAgIGF3YWl0IHcudXBkYXRlKHN5cykKCiAgICAgICAgY29uc3QgbmV4dCA9IHcuYWR2YW5jZSgpCiAgICAgICAgaWYgKCFuZXh0KSB7CiAgICAgICAgICB0aGlzLmJhc2UuX3dhcm4obmV3IEVycm9yKCdOb2RlIG11c3QgZXhpc3QgZm9yIGNhdGNodXAnKSkKICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KCiAgICAgICAgbGluZWFyaXplci5hZGRIZWFkKG5leHQpCiAgICAgIH0KICAgIH0KCiAgICBhd2FpdCBzeXMuY2xvc2UoKQoKICAgIHRoaXMudXBkYXRlcyA9IHVwZGF0ZXMKCiAgICBpZiAodGhpcy5pbmRleGVyc1VwZGF0ZWQpIHsKICAgICAgdGhpcy5pbmRleGVyc1VwZGF0ZWQgPSBmYWxzZQogICAgICAvLyBpZiB3ZSB1cGRhdGVkIHRoZSBpbmRleGVycywgaW52YWxpZGF0ZSBhbGwgdGhlIGludGVybmFsIHN0YXRlIGFuZCByZWFwcGx5IGl0CiAgICAgIGF3YWl0IHRoaXMudHJ1bmNhdGUodGhpcy5pbmRleGVkTGVuZ3RoKQogICAgICBhd2FpdCB0aGlzLl9yb2xsYmFja1ZpZXdzKCkKCiAgICAgIGlmICh0aGlzLnR4ID09PSBudWxsKSB0aGlzLnR4ID0gdGhpcy5sb2NhbC5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKCiAgICAgIHdoaWxlICgKICAgICAgICB0aGlzLnVwZGF0ZXMubGVuZ3RoID4gMCAmJgogICAgICAgIHRoaXMudXBkYXRlc1t0aGlzLnVwZGF0ZXMubGVuZ3RoIC0gMV0uc3lzdGVtTGVuZ3RoID49IHRoaXMuaW5kZXhlZExlbmd0aAogICAgICApIHsKICAgICAgICBjb25zdCB1ID0gdGhpcy51cGRhdGVzLnBvcCgpCiAgICAgICAgdGhpcy5sb2NhbFN0YXRlLmRlbGV0ZVVwZGF0ZSh1KQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBvdGhlcndpc2Ugd2Uga25vdyB0aGUgaW50ZXJuYWwgc3RhdGUgaXMgY29ycmVjdCwgc28gd2UgY2Fycnkgb24KICAgICAgbGluZWFyaXplci51cGRhdGUoKQogICAgfQoKICAgIC8vIG11c3QgcmVmcmVzaCB0aGUgd3JpdGVycyBoZXJlIHNvIGlzUmVtb3ZlZCBpcyB1cCB0byBkYXRlCiAgICBhd2FpdCB0aGlzLl9yZWZyZXNoV3JpdGVycygpCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgZ2V0SW5kZXhlZFN5c3RlbSgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIGNvbnN0IGluZGV4ZWRMZW5ndGggPSB0aGlzLnBlbmRpbmdGb3JrID8gdGhpcy5wZW5kaW5nRm9yay5sZW5ndGggOiB0aGlzLmluZGV4ZWRMZW5ndGgKCiAgICBjb25zdCBzeXMgPSBhd2FpdCB0aGlzLnN5c3RlbS5jaGVja291dChpbmRleGVkTGVuZ3RoKQogICAgYXdhaXQgc3lzLnJlYWR5KCkKICAgIHJldHVybiBzeXMKICB9CgogIGdldFZpZXdGcm9tU3lzdGVtKHZpZXcsIHN5cyA9IHRoaXMuc3lzdGVtKSB7CiAgICBpZiAodmlldy5tYXBwZWRJbmRleCA9PT0gLTEgfHwgdmlldy5tYXBwZWRJbmRleCA+PSBzeXMudmlld3MubGVuZ3RoKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHN5cy52aWV3c1t2aWV3Lm1hcHBlZEluZGV4XQogIH0KCiAgYXN5bmMgcmVjb3ZlckF0KCkgewogICAgaWYgKCF0aGlzLnN5c3RlbVJlZikgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgYXdhaXQgdGhpcy5zeXN0ZW1SZWYuY29yZS5yZWFkeSgpCgogICAgY29uc3QgbHQgPSB0aGlzLnN5c3RlbVJlZi5jb3JlLmNvcmUuc3RhdGUubGVuZ3RoCgogICAgZm9yIGF3YWl0IChjb25zdCB7IGxlbmd0aCwgaW5mbyB9IG9mIFN5c3RlbVZpZXcuZmx1c2hlcyh0aGlzLnN5c3RlbVJlZi5jb3JlLnNlc3Npb24oKSwgewogICAgICByZXZlcnNlOiB0cnVlLAogICAgICBsdAogICAgfSkpIHsKICAgICAgbGV0IGNvbnNpc3RlbnQgPSB0cnVlCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZm8udmlld3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoaSA+PSB0aGlzLnZpZXdzLmxlbmd0aCkgY29udGludWUKICAgICAgICBpZiAoIWI0YS5lcXVhbHMoaW5mby52aWV3c1tpXS5rZXksIHRoaXMudmlld3NbaV0ua2V5KSkgY29udGludWUKCiAgICAgICAgaWYgKGluZm8udmlld3NbaV0ubGVuZ3RoID4gdGhpcy52aWV3c1tpXS5jb3JlLmNvcmUuc3RhdGUubGVuZ3RoKSB7CiAgICAgICAgICBjb25zaXN0ZW50ID0gZmFsc2UKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoY29uc2lzdGVudCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBsZW5ndGgsCiAgICAgICAgICBmb3JjZTogdHJ1ZSwKICAgICAgICAgIGtleTogdGhpcy5zeXN0ZW0uY29yZS5rZXksCiAgICAgICAgICBpbmRleGVyczogaW5mby5pbmRleGVycywKICAgICAgICAgIHZpZXdzOiBpbmZvLnZpZXdzCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIGJvb3RzdHJhcCgpIHsKICAgIHJldHVybiB0aGlzLnN5c3RlbS5hZGQodGhpcy5iYXNlLmtleSwgeyBpc0luZGV4ZXI6IHRydWUsIGlzUGVuZGluZzogZmFsc2UgfSkKICB9CgogIGFzeW5jIHVuZG8ocG9wcGVkKSB7CiAgICBpZiAoIXBvcHBlZCkgcmV0dXJuCgogICAgbGV0IGluZGV4ZXJzVXBkYXRlZCA9IGZhbHNlCiAgICB3aGlsZSAocG9wcGVkID4gMCkgewogICAgICBjb25zdCB1ID0gdGhpcy51cGRhdGVzLnBvcCgpCiAgICAgIHRoaXMubG9jYWxTdGF0ZS5kZWxldGVVcGRhdGUodSkKICAgICAgcG9wcGVkIC09IHUuYmF0Y2gKICAgICAgaWYgKHUuaW5kZXhlcnMpIGluZGV4ZXJzVXBkYXRlZCA9IHRydWUKICAgIH0KCiAgICBjb25zdCB1ID0gdGhpcy51cGRhdGVzLmxlbmd0aCA9PT0gMCA/IG51bGwgOiB0aGlzLnVwZGF0ZXNbdGhpcy51cGRhdGVzLmxlbmd0aCAtIDFdCiAgICBjb25zdCBzeXN0ZW1MZW5ndGggPSB1ID8gdS5zeXN0ZW1MZW5ndGggOiB0aGlzLmluZGV4ZWRMZW5ndGgKCiAgICBhd2FpdCB0aGlzLnRydW5jYXRlKHN5c3RlbUxlbmd0aCkKICAgIGlmIChpbmRleGVyc1VwZGF0ZWQpIGF3YWl0IHRoaXMuX3JvbGxiYWNrVmlld3MoKQogIH0KCiAgYXN5bmMgdHJ1bmNhdGUoc3lzdGVtTGVuZ3RoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmIChzeXN0ZW1MZW5ndGggPT09IHRoaXMuc3lzdGVtLmNvcmUubGVuZ3RoKSByZXR1cm4KCiAgICBhd2FpdCB0aGlzLnN5c3RlbS5jb3JlLnRydW5jYXRlKHN5c3RlbUxlbmd0aCkKCiAgICBjb25zdCBtaWdyYXRlZCA9IGF3YWl0IHRoaXMuc3lzdGVtLnVwZGF0ZSgpCgogICAgaWYgKHRoaXMuZW5jcnlwdGlvblZpZXcuY29yZS5sZW5ndGggIT09IHRoaXMuc3lzdGVtLmVuY3J5cHRpb25MZW5ndGgpIHsKICAgICAgYXdhaXQgdGhpcy5lbmNyeXB0aW9uVmlldy5jb3JlLnRydW5jYXRlKHRoaXMuc3lzdGVtLmVuY3J5cHRpb25MZW5ndGgpCiAgICB9CgogICAgZm9yIChjb25zdCB2aWV3IG9mIHRoaXMudmlld3MpIHsKICAgICAgaWYgKCF2aWV3LmNvcmUpIGNvbnRpbnVlCgogICAgICBjb25zdCB2ID0gdGhpcy5nZXRWaWV3RnJvbVN5c3RlbSh2aWV3KQoKICAgICAgaWYgKHYgJiYgdmlldy5jb3JlLmxlbmd0aCA9PT0gdi5sZW5ndGgpIGNvbnRpbnVlCiAgICAgIGlmICh2ID09PSBudWxsKSB2aWV3Lm1hcHBlZEluZGV4ID0gLTEgLy8gdW5tYXAKCiAgICAgIGF3YWl0IHZpZXcuY29yZS50cnVuY2F0ZSh2ID8gdi5sZW5ndGggOiAwKQogICAgfQoKICAgIGlmICghbWlncmF0ZWQpIHJldHVybgoKICAgIGF3YWl0IHRoaXMuX3JlZnJlc2hXcml0ZXJzKCkKICAgIGF3YWl0IHRoaXMuX3JvbGxiYWNrVmlld3MoKQogIH0KCiAgYXN5bmMgX3JlZnJlc2hXcml0ZXJzKCkgewogICAgLy8gVE9ETzogYWRkIHRoZSBzZXEgYXQgd2hpY2ggd2UgdXBkYXRlZCB0aGUgc3RhdGUgdG8gdGhlIHdyaXRlciBpbnN0YW5jZS4KICAgIC8vIHRoZW4gd2Uga25vdyBpZiBpdCB3YXMgdHJ1bmNhdGVkIG91dCB3aXRob3V0IHRoZSBsb29rdXAsIG1lYW5pbmcgZmFzdGVyIHRydW5jYXRpb25zCiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5iYXNlLmFjdGl2ZVdyaXRlcnMpIHsKICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuc3lzdGVtLmdldCh3LmNvcmUua2V5KQogICAgICBjb25zdCBib290c3RyYXBwZXIgPSB0aGlzLnN5c3RlbS5jb3JlLmxlbmd0aCA9PT0gMCAmJiBiNGEuZXF1YWxzKHcuY29yZS5rZXksIHRoaXMuYmFzZS5rZXkpCiAgICAgIGNvbnN0IGlzUmVtb3ZlZCA9IGRhdGEgPyBkYXRhLmlzUmVtb3ZlZCA6ICFib290c3RyYXBwZXIKICAgICAgdy5pc1JlbW92ZWQgPSBpc1JlbW92ZWQKICAgIH0KICB9CgogIGFzeW5jIF91cGRhdGVTeXN0ZW0oKSB7CiAgICBpZiAoIShhd2FpdCB0aGlzLnN5c3RlbS51cGRhdGUoKSkpIHJldHVybgogICAgYXdhaXQgdGhpcy5fcmVmcmVzaFdyaXRlcnMoKQogICAgYXdhaXQgdGhpcy5fcm9sbGJhY2tWaWV3cygpCiAgfQoKICBhc3luYyBfc2lnblZpZXdDb3JlKGNvcmUsIGxlbmd0aCkgewogICAgY29uc3QgcyA9IGF3YWl0IGNvcmUuc2lnbmFibGUobGVuZ3RoLCAwKQogICAgY29uc3Qgc2lnbmF0dXJlID0gY3J5cHRvLnNpZ24ocywgdGhpcy5iYXNlLmxvY2FsLmtleVBhaXIuc2VjcmV0S2V5KQogICAgcmV0dXJuIHsgc2lnbmF0dXJlLCBsZW5ndGggfQogIH0KCiAgYXN5bmMgX3NpZ25JbnRlcm5hbFZpZXdDb3JlcyhzeXMpIHsKICAgIHJldHVybiB7CiAgICAgIHN5c3RlbTogYXdhaXQgdGhpcy5fc2lnblZpZXdDb3JlKHRoaXMuc3lzdGVtVmlldy5jb3JlLCB0aGlzLnN5c3RlbVZpZXcuaW5kZXhlZExlbmd0aCksCiAgICAgIGVuY3J5cHRpb246IGF3YWl0IHRoaXMuX3NpZ25WaWV3Q29yZSh0aGlzLmVuY3J5cHRpb25WaWV3LmNvcmUsIHN5cy5lbmNyeXB0aW9uTGVuZ3RoKQogICAgfQogIH0KCiAgYXN5bmMgX3NpZ25Vc2VyVmlld0NvcmVzKHN5cykgewogICAgY29uc3QgcHJvbWlzZXMgPSBuZXcgQXJyYXkoc3lzLnZpZXdzLmxlbmd0aCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudmlld3MubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgdmlldyA9IHRoaXMudmlld3NbaV0KCiAgICAgIGNvbnN0IHYgPSB0aGlzLmdldFZpZXdGcm9tU3lzdGVtKHZpZXcsIHN5cykKICAgICAgY29uc3QgaW5kZXhlZExlbmd0aCA9IHYgPyB2Lmxlbmd0aCA6IDAKCiAgICAgIGlmICghaW5kZXhlZExlbmd0aCkgY29udGludWUKCiAgICAgIGNvbnN0IHZpZXdJbmRleCA9IHZpZXcubWFwcGVkSW5kZXgKICAgICAgcHJvbWlzZXNbdmlld0luZGV4XSA9IHRoaXMuX3NpZ25WaWV3Q29yZSh2aWV3LnJlZi5hdG9taWNCYXRjaCwgaW5kZXhlZExlbmd0aCkKICAgIH0KCiAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpCiAgfQoKICBhc3luYyBmaW5hbGl6ZShrZXkpIHsKICAgIHRoaXMubG9jYWxTdGF0ZS5zZXRCb290UmVjb3JkKHsKICAgICAgdmVyc2lvbjogQk9PVF9SRUNPUkRfVkVSU0lPTiwKICAgICAga2V5LAogICAgICBzeXN0ZW1MZW5ndGg6IHRoaXMuc3lzdGVtVmlldy5pbmRleGVkTGVuZ3RoLAogICAgICBpbmRleGVyc1VwZGF0ZWQ6IHRydWUsCiAgICAgIGZhc3RGb3J3YXJkaW5nOiBmYWxzZSwKICAgICAgcmVjb3ZlcmllczogdGhpcy5iYXNlLnJlY292ZXJpZXMKICAgIH0pCgogICAgYXdhaXQgdGhpcy5sb2NhbFN0YXRlLmZsdXNoKCkKCiAgICBhd2FpdCB0aGlzLnN0b3JlLmZsdXNoKCkKICAgIGF3YWl0IHRoaXMuY2xvc2UoKQogIH0KCiAgYXN5bmMgX2ZsdXNoKGxvY2FsTm9kZXMpIHsKICAgIGlmIChsb2NhbE5vZGVzKSBhd2FpdCB0aGlzLl9hcHBlbmRMb2NhbE5vZGVzKGxvY2FsTm9kZXMpCgogICAgdGhpcy5sb2NhbFN0YXRlLnNldEJvb3RSZWNvcmQoewogICAgICB2ZXJzaW9uOiBCT09UX1JFQ09SRF9WRVJTSU9OLAogICAgICBrZXk6IHRoaXMua2V5LAogICAgICBzeXN0ZW1MZW5ndGg6IHRoaXMuc3lzdGVtVmlldy5pbmRleGVkTGVuZ3RoLAogICAgICBpbmRleGVyc1VwZGF0ZWQ6IGZhbHNlLAogICAgICBmYXN0Rm9yd2FyZGluZzogZmFsc2UsCiAgICAgIHJlY292ZXJpZXM6IHRoaXMuYmFzZS5yZWNvdmVyaWVzCiAgICB9KQoKICAgIGF3YWl0IHRoaXMubG9jYWxTdGF0ZS5mbHVzaCgpCgogICAgaWYgKHRoaXMubG9jYWxDaGVja3BvaW50KSB7CiAgICAgIC8vIHdlIGhhdmUgdG8gZmx1c2ggaGVyZSBzbyB0aGUgY2hrcG9pbnQgY2FuIHVwZGF0ZQogICAgICAvLyBjb3VsZCBydW4gdGhlIGNoZWNrcG9pbnQgb24gdGhlIGJhdGNoIGJ1dCBhbHNvIG5vIGJpZyBkZWFkCiAgICAgIC8vIGFzIHRoZSAic2hvdWxkIHdlIHNpZ24iIGNoZWNrIGlzIHJlcnVuIG9uIGJvb3QuLi4KICAgICAgYXdhaXQgdGhpcy5zdG9yZS5mbHVzaCgpCiAgICAgIGF3YWl0IHRoaXMubG9jYWxDaGVja3BvaW50LnVwZGF0ZSgpCiAgICB9CgogICAgaWYgKHRoaXMucGVuZGluZ1ZpZXdzKSB7CiAgICAgIGNvbnN0IHZpZXdzID0gdGhpcy5wZW5kaW5nVmlld3MKICAgICAgdGhpcy5wZW5kaW5nVmlld3MgPSBudWxsCgogICAgICBmb3IgKGxldCBpID0gdmlld3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBjb25zdCB2ID0gdmlld3NbaV0KICAgICAgICBpZiAoIXYgfHwgdi5sZW5ndGggPD0gdi5jb3JlLnNpZ25lZExlbmd0aCkgY29udGludWUKICAgICAgICBjb25zdCBzaWduYXR1cmUgPSB2LmNvcmUuY29yZS52ZXJpZmllci5hc3NlbWJsZSh2LnBhcnRpYWxzKQogICAgICAgIHRyeSB7CiAgICAgICAgICBhd2FpdCB2LnJlZi5jb21taXQodGhpcy5zdG9yZS5hdG9tLCB2Lmxlbmd0aCwgc2lnbmF0dXJlKQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgLy8gVE9ETzogd2Ugc2hvdWxkIHByZXZhbGlkYXRlIGFsbCBzaWduYXR1cmVzIGluc3RlYWQgb2YgZHVyaW5nIGNvbW1pdCBzbyBpdCBjYW4gYmUgYWxsIG9yIG5vdGhpbmcsIGp1c3Qgc2xpZ2hseQogICAgICAgICAgLy8gZnJpZW5kbGllciB1eC4gbWlzc2luZyBoYyBhcGkgZm9yIHRoYXQKICAgICAgICAgIGlmICghdGhpcy5iYXNlLmNsb3NpbmcpIHRoaXMuYmFzZS5fd2FybihlcnIpCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGF3YWl0IHRoaXMuc3RvcmUuZmx1c2goKQoKICAgIHRoaXMuZmFzdEZvcndhcmRpbmcgPSBmYWxzZQogICAgaWYgKHRoaXMucGVuZGluZ1ZpZXdzID09PSBudWxsKSB0aGlzLmRpcnR5ID0gZmFsc2UKICB9CgogIF9pbmRleFVwZGF0ZXMoaW5kZXhlZCkgewogICAgbGV0IHNoaWZ0ID0gMAogICAgd2hpbGUgKGluZGV4ZWQgPiAwKSBpbmRleGVkIC09IHRoaXMudXBkYXRlc1tzaGlmdCsrXS5iYXRjaAoKICAgIGNvbnN0IGxhc3QgPSB0aGlzLnVwZGF0ZXNbc2hpZnQgLSAxXQoKICAgIHRoaXMuc3lzdGVtVmlldy5pbmRleGVkTGVuZ3RoID0gbGFzdC5zeXN0ZW1MZW5ndGgKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNoaWZ0OyBpKyspIHRoaXMubG9jYWxTdGF0ZS5kZWxldGVVcGRhdGUodGhpcy51cGRhdGVzW2ldKQogICAgdGhpcy51cGRhdGVzLnNwbGljZSgwLCBzaGlmdCkKCiAgICBpZiAoIXRoaXMubmVlZHNJbmRleGVkTGVuZ3RoVXBkYXRlKSByZXR1cm4KICAgIHRoaXMubWF5YmVTaWduZWQoKS5jYXRjaChub29wKQogIH0KCiAgcGVuZGluZ0luZGV4ZWRMZW5ndGgoKSB7CiAgICBsZXQgaW5kZXhlZCA9IHRoaXMuYXBwbHlpbmcuaW5kZXhlZC5sZW5ndGgKICAgIGlmICghdGhpcy5hcHBseWluZyB8fCAhdGhpcy51cGRhdGVzLmxlbmd0aCB8fCAhaW5kZXhlZCkgcmV0dXJuIHRoaXMuaW5kZXhlZExlbmd0aAoKICAgIGxldCBwb3MgPSAwCiAgICB3aGlsZSAoaW5kZXhlZCA+IDAgJiYgcG9zIDwgdGhpcy51cGRhdGVzLmxlbmd0aCkgewogICAgICBpbmRleGVkIC09IHRoaXMudXBkYXRlc1twb3MrK10uYmF0Y2gKICAgIH0KCiAgICBjb25zdCBsYXN0ID0gdGhpcy51cGRhdGVzW3BvcyAtIDFdCiAgICByZXR1cm4gbGFzdC5zeXN0ZW1MZW5ndGgKICB9CgogIGFzeW5jIF9hc3NlcnROb2RlKG5vZGUsIGJhdGNoKSB7CiAgICAvLyBoZWxwZnVsIGRhZyBoZWxwZXIsIHNvIGtlcHQgaGVyZQoKICAgIGNvbnN0IHYgPSAoYXdhaXQgdGhpcy5zeXN0ZW0uZ2V0KG5vZGUud3JpdGVyLmNvcmUua2V5KSkgfHwgeyBsZW5ndGg6IDAsIGlzUmVtb3ZlZDogZmFsc2UgfQogICAgY29uc3QgZXhwZWN0ZWQgPSB2Lmxlbmd0aCArIGJhdGNoCiAgICBpZiAobm9kZS5sZW5ndGggPT09IGV4cGVjdGVkKSByZXR1cm4KCiAgICBjb25zb2xlLnRyYWNlKAogICAgICAnSU5WQUxJRF9JTlNFUlRJT04nLAogICAgICAnbGVuZ3RoPScsCiAgICAgIG5vZGUubGVuZ3RoLAogICAgICAna2V5PScsCiAgICAgIG5vZGUud3JpdGVyLmNvcmUua2V5LAogICAgICAnbG9jYWw9JywKICAgICAgbm9kZS53cml0ZXIuY29yZS53cml0YWJsZSwKICAgICAgJ2JhdGNoPScsCiAgICAgIGJhdGNoLAogICAgICAnZGFnPScsCiAgICAgIHYKICAgICkKCiAgICBwcm9jZXNzLmV4aXQoMSkKICB9CgogIF9wb3N0QXBwbHkoKSB7CiAgICB0aGlzLmFwcGx5QmF0Y2ggPSB0aGlzLmFwcGx5aW5nID0gbnVsbAogICAgdGhpcy5iYXNlLl9wb3N0QXBwbHkoKQogIH0KCiAgYXN5bmMgX29wdGltaXN0aWNBcHBseSh1LCBub2RlLCBpbmRleGVkKSB7CiAgICBjb25zdCBjaGVja3BvaW50ID0gdGhpcy5zeXN0ZW0uY2hlY2twb2ludCgpCgogICAgdGhpcy5zeXN0ZW0uYWRkSGVhZChub2RlKQoKICAgIGNvbnN0IGFwcGx5QmF0Y2ggPSBbXQogICAgY29uc3Qga2V5ID0gbm9kZS53cml0ZXIuY29yZS5rZXkKCiAgICBhcHBseUJhdGNoLnB1c2goewogICAgICBpbmRleGVkLAogICAgICBvcHRpbWlzdGljOiB0cnVlLAogICAgICBmcm9tOiBub2RlLndyaXRlci5jb3JlLAogICAgICBsZW5ndGg6IG5vZGUubGVuZ3RoLAogICAgICB2YWx1ZTogbm9kZS52YWx1ZSwKICAgICAgaGVhZHM6IG5vZGUuYWN0dWFsSGVhZHMKICAgIH0pCgogICAgY29uc3QgcHJlID0gYXdhaXQgdGhpcy5zeXN0ZW0uZ2V0KGtleSkKICAgIGNvbnN0IHByZUxlbmd0aCA9IHByZSA/IHByZS5sZW5ndGggOiAwCgogICAgbGV0IGZhaWxlZCA9IGZhbHNlCgogICAgdGhpcy5hcHBseWluZyA9IHUKICAgIHRoaXMuYXBwbHlCYXRjaCA9IGFwcGx5QmF0Y2gKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuYmFzZS5faGFuZGxlcnMuYXBwbHkoYXBwbHlCYXRjaCwgdGhpcy52aWV3LCB0aGlzLmhvc3RjYWxscykKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAodGhpcy5iYXNlLmNsb3NpbmcpIHRocm93IGVycgogICAgICBmYWlsZWQgPSB0cnVlCiAgICB9CiAgICB0aGlzLl9wb3N0QXBwbHkoKQoKICAgIGlmICghZmFpbGVkKSB7CiAgICAgIGNvbnN0IHBvc3QgPSBhd2FpdCB0aGlzLnN5c3RlbS5nZXQoa2V5KQogICAgICAvLyBjaGVjayBpZiBhY2tlZCBieSBhZGRXcml0ZXIvcmVtb3ZlV3JpdGVyL2Fja1dyaXRlcgogICAgICBpZiAoIXBvc3QgfHwgcHJlTGVuZ3RoID09PSBwb3N0Lmxlbmd0aCkgZmFpbGVkID0gdHJ1ZQogICAgfQoKICAgIGlmICghZmFpbGVkKSB7CiAgICAgIC8vIHRlY2huaWNhbGx5IHdlIG9ubHkgbmVlZCB0byB0byB0aGlzIGlzIHRoZSB3cml0ZXIgd2FzIHJlbW92ZWQsIGJ1dCBoZXksIHRyaWNreSBsb2dpYwogICAgICBhd2FpdCB0aGlzLl9yZWZyZXNoV3JpdGVycygpCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgLy8gaXQgZmFpbGVkISByb2xsYmFjay4uLgoKICAgIHRoaXMuc3lzdGVtLmFwcGx5Q2hlY2twb2ludChjaGVja3BvaW50KQoKICAgIGlmICh0aGlzLmVuY3J5cHRpb25WaWV3LmNvcmUubGVuZ3RoICE9PSB0aGlzLnN5c3RlbS5lbmNyeXB0aW9uTGVuZ3RoKSB7CiAgICAgIGF3YWl0IHRoaXMuZW5jcnlwdGlvblZpZXcuY29yZS50cnVuY2F0ZSh0aGlzLnN5c3RlbS5lbmNyeXB0aW9uTGVuZ3RoKQogICAgfQoKICAgIGZvciAoY29uc3QgdmlldyBvZiB0aGlzLnZpZXdzKSB7CiAgICAgIGNvbnN0IHZpZXdMZW5ndGggPSB2aWV3LmNvcmUgPyB2aWV3LmNvcmUubGVuZ3RoIDogdmlldy5sZW5ndGgKICAgICAgY29uc3Qgdmlld0xvb2t1cCA9IHRoaXMuZ2V0Vmlld0Zyb21TeXN0ZW0odmlldykKICAgICAgY29uc3Qgdmlld1N5c3RlbUxlbmd0aCA9IHZpZXdMb29rdXAgPyB2aWV3TG9va3VwLmxlbmd0aCA6IDAKICAgICAgaWYgKHZpZXdTeXN0ZW1MZW5ndGggPT09IHZpZXdMZW5ndGgpIGNvbnRpbnVlCiAgICAgIGF3YWl0IHZpZXcuY29yZS50cnVuY2F0ZSh2aWV3U3lzdGVtTGVuZ3RoKQogICAgfQoKICAgIGF3YWl0IHRoaXMuX3JlZnJlc2hXcml0ZXJzKCkKCiAgICBhd2FpdCB0aGlzLl9yb2xsYmFja1ZpZXdzKCkKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX3N0YXJ0VHJhY2Uobm9kZSkgewogICAgdGhpcy5zeXN0ZW1SZWYudHJhY2VyLnN0YXJ0KCkKICAgIHRoaXMuZW5jcnlwdGlvblZpZXcucmVmLnRyYWNlci5zdGFydCgpCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudmlld3MubGVuZ3RoOyBpKyspIHRoaXMudmlld3NbaV0ucmVmLnRyYWNlci5zdGFydCgpCiAgfQoKICBfZW5kVHJhY2Uobm9kZSkgewogICAgY29uc3QgdHJhY2UgPSB7CiAgICAgIHN5c3RlbTogdGhpcy5zeXN0ZW1SZWYudHJhY2VyLmVuZCgpLAogICAgICBlbmNyeXB0aW9uOiB0aGlzLmVuY3J5cHRpb25WaWV3LnJlZi50cmFjZXIuZW5kKCksCiAgICAgIHVzZXI6IFtdCiAgICB9CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnZpZXdzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGJsb2NrcyA9IHRoaXMudmlld3NbaV0ucmVmLnRyYWNlci5lbmQoKQogICAgICBpZiAoYmxvY2tzLmxlbmd0aCkgdHJhY2UudXNlci5wdXNoKHsgdmlldzogaSwgYmxvY2tzIH0pCiAgICB9CgogICAgaWYgKHRyYWNlLnN5c3RlbS5sZW5ndGggfHwgdHJhY2UuZW5jcnlwdGlvbi5sZW5ndGggfHwgdHJhY2UudXNlci5sZW5ndGgpIG5vZGUudHJhY2UgPSB0cmFjZQogIH0KCiAgYXN5bmMgdXBkYXRlKHUsIGxvY2FsTm9kZXMpIHsKICAgIGlmICh0aGlzLmNoYW5nZXMgIT09IG51bGwpIHRoaXMuY2hhbmdlcy50cmFjayh0aGlzKQoKICAgIGxldCBiYXRjaCA9IDAKICAgIGxldCBhcHBseUJhdGNoID0gW10KICAgIGxldCBpbmRleGVyc1VwZGF0ZWQgPSAwCgogICAgbGV0IGogPSAwCiAgICBsZXQgaSA9IDAKICAgIGxldCBmb3JrZWRBdCA9IC0xCgogICAgd2hpbGUgKGkgPCBNYXRoLm1pbih1LmluZGV4ZWQubGVuZ3RoLCB1LnNoYXJlZCkpIHsKICAgICAgY29uc3Qgbm9kZSA9IHUuaW5kZXhlZFtpKytdCgogICAgICBpZiAobm9kZS5iYXRjaCA+IDEpIGNvbnRpbnVlCiAgICAgIHRoaXMuYmFzZS5fc2hpZnRXcml0ZXIobm9kZS53cml0ZXIpCgogICAgICBjb25zdCB1cGRhdGUgPSB0aGlzLnVwZGF0ZXNbaisrXQoKICAgICAgaWYgKHVwZGF0ZS5pbmRleGVycykgewogICAgICAgIGluZGV4ZXJzVXBkYXRlZCA9IGkKICAgICAgICBicmVhawogICAgICB9CiAgICB9CgogICAgaWYgKHUudW5kbykgYXdhaXQgdGhpcy51bmRvKHUudW5kbykKCiAgICBpZiAodGhpcy5zeXN0ZW0uYm9vdHN0cmFwcGluZykgYXdhaXQgdGhpcy5ib290c3RyYXAoKQoKICAgIGF3YWl0IHRoaXMuX3VwZGF0ZVN5c3RlbSgpCgogICAgLy8gT3JnYW5pemUgYnkgdmlldwogICAgY29uc3Qgd2FybXVwU3lzdGVtVmlldyA9IFtdCiAgICBjb25zdCB3YXJtdXBFbmNyeXB0aW9uVmlldyA9IFtdCiAgICBjb25zdCB3YXJtdXBVc2VyVmlldyA9IG5ldyBBcnJheSh0aGlzLnZpZXdzLmxlbmd0aCkKCiAgICBmb3IgKGxldCBrID0gdS5zaGFyZWQ7IGsgPCB1Lmxlbmd0aDsgaysrKSB7CiAgICAgIGNvbnN0IGluZGV4ZWQgPSBrIDwgdS5pbmRleGVkLmxlbmd0aAogICAgICBjb25zdCBub2RlID0gaW5kZXhlZCA/IHUuaW5kZXhlZFtrXSA6IHUudGlwW2sgLSB1LmluZGV4ZWQubGVuZ3RoXQogICAgICBpZiAoIW5vZGUudHJhY2UpIGNvbnRpbnVlCgogICAgICBpZiAobm9kZS50cmFjZS5zeXN0ZW0ubGVuZ3RoKSB3YXJtdXBTeXN0ZW1WaWV3LnB1c2goLi4ubm9kZS50cmFjZS5zeXN0ZW0pCiAgICAgIGlmIChub2RlLnRyYWNlLmVuY3J5cHRpb24ubGVuZ3RoKSB3YXJtdXBFbmNyeXB0aW9uVmlldy5wdXNoKC4uLm5vZGUudHJhY2UuZW5jcnlwdGlvbikKCiAgICAgIGZvciAoY29uc3QgdHJhY2Ugb2Ygbm9kZS50cmFjZS51c2VyKSB7CiAgICAgICAgLy8gQXNzZXJ0IChhcyB3YXJuaW5nKSB0aGF0IHRyYWNlIHZpZXcgc2hvdWxkIG9ubHkgYmUgY3VycmVudGx5IGluZGV4ZWQgdmlld3MKICAgICAgICBpZiAodHJhY2UudmlldyA+PSB0aGlzLnZpZXdzLmxlbmd0aCkgewogICAgICAgICAgY29uc29sZS53YXJuKAogICAgICAgICAgICAnT3Bsb2cgYmxvY2sgdHJhY2UgY29udGFpbnMgT09CIHZpZXcgaW5kZXgnLAogICAgICAgICAgICAndHJhY2UgdmlldycsCiAgICAgICAgICAgIHRyYWNlLnZpZXcsCiAgICAgICAgICAgICd2aWV3cy5sZW5ndGgnLAogICAgICAgICAgICB0aGlzLnZpZXdzLmxlbmd0aAogICAgICAgICAgKQogICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIHdhcm11cFVzZXJWaWV3W3RyYWNlLnZpZXddID0gd2FybXVwVXNlclZpZXdbdHJhY2Uudmlld10gfHwgW10KICAgICAgICB3YXJtdXBVc2VyVmlld1t0cmFjZS52aWV3XS5wdXNoKC4uLnRyYWNlLmJsb2NrcykKICAgICAgfQogICAgfQoKICAgIC8vIFJlcXVlc3QgcGVyIHZpZXcKICAgIGlmICh3YXJtdXBTeXN0ZW1WaWV3Lmxlbmd0aCkgdGhpcy5zeXN0ZW1WaWV3LmNvcmUuZG93bmxvYWQoeyBibG9ja3M6IHdhcm11cFN5c3RlbVZpZXcgfSkKICAgIGlmICh3YXJtdXBFbmNyeXB0aW9uVmlldy5sZW5ndGgpCiAgICAgIHRoaXMuZW5jcnlwdGlvblZpZXcuY29yZS5kb3dubG9hZCh7IGJsb2Nrczogd2FybXVwRW5jcnlwdGlvblZpZXcgfSkKICAgIGZvciAobGV0IGsgPSAwOyBrIDwgd2FybXVwVXNlclZpZXcubGVuZ3RoOyBrKyspIHsKICAgICAgY29uc3QgYmxvY2tzID0gd2FybXVwVXNlclZpZXdba10KICAgICAgaWYgKCFibG9ja3MpIGNvbnRpbnVlCgogICAgICBjb25zdCB2aWV3ID0gdGhpcy52aWV3c1trXQogICAgICB2aWV3LmNvcmUuZG93bmxvYWQoeyBibG9ja3MgfSkKICAgIH0KCiAgICBmb3IgKGkgPSB1LnNoYXJlZDsgaSA8IHUubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHRoaXMuYmFzZS5iYWNrb2ZmICE9PSBudWxsICYmIHRoaXMuYmFzZS5iYWNrb2ZmLmJhY2tvZmYoKSkgYXdhaXQgdGhpcy5iYXNlLmJhY2tvZmYud2FpdCgpCgogICAgICBjb25zdCBpbmRleGVkID0gaSA8IHUuaW5kZXhlZC5sZW5ndGgKICAgICAgY29uc3Qgbm9kZSA9IGluZGV4ZWQgPyB1LmluZGV4ZWRbaV0gOiB1LnRpcFtpIC0gdS5pbmRleGVkLmxlbmd0aF0KCiAgICAgIGJhdGNoKysKCiAgICAgIGlmIChub2RlLndyaXRlci5jb3JlLndyaXRhYmxlKSB0aGlzLl9zdGFydFRyYWNlKG5vZGUpCgogICAgICBjb25zdCBvcHRpbWlzdCA9CiAgICAgICAgbm9kZS53cml0ZXIuaXNSZW1vdmVkICYmCiAgICAgICAgbm9kZS5vcHRpbWlzdGljICYmCiAgICAgICAgYmF0Y2ggPT09IDEgJiYKICAgICAgICB0aGlzLmJhc2UuX2hhc09wdGltaXN0aWNBcHBseSA9PT0gdHJ1ZSAmJgogICAgICAgIChhd2FpdCB0aGlzLl9vcHRpbWlzdGljQXBwbHkodSwgbm9kZSwgaW5kZXhlZCkpCgogICAgICBpZiAoIW9wdGltaXN0KSB7CiAgICAgICAgaWYgKG5vZGUud3JpdGVyLmlzUmVtb3ZlZCAmJiAhbm9kZS53cml0ZXIuaXNBY3RpdmVJbmRleGVyKSB7CiAgICAgICAgICBpZiAobm9kZS5iYXRjaCA+IDEpIGNvbnRpbnVlCiAgICAgICAgICAvLyBpbiBjYXNlIHNvbWVvbmUgaXMgbGlua2luZyB0aGlzIG5vZGUgYW5kIHRoZXkgYXJlIG5vdCByZW1vdmVkCiAgICAgICAgICBjb25zdCB1ID0gewogICAgICAgICAgICBzZXE6IDAsCiAgICAgICAgICAgIGtleTogbm9kZS53cml0ZXIuY29yZS5rZXksCiAgICAgICAgICAgIGxlbmd0aDogbm9kZS5sZW5ndGgsCiAgICAgICAgICAgIGJhdGNoLAogICAgICAgICAgICBzeXN0ZW1MZW5ndGg6IDAsCiAgICAgICAgICAgIGluZGV4ZXJzOiBmYWxzZQogICAgICAgICAgfQogICAgICAgICAgdGhpcy5fcHVzaFVwZGF0ZSh1KQogICAgICAgICAgYmF0Y2ggPSAwCiAgICAgICAgICBhc3NlcnQoYXBwbHlCYXRjaC5sZW5ndGggPT09IDAsICdBcHBseSBiYXRjaCBzaG91bGQgbm90IGhhdmUgYmVlbiBtb2RpZmllZCcpCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgLy8gaW4gcHJvZCB3ZSBwcm9wIG5lZWQgdG8gZGlzYWJsZSB0aGlzIGFzc2VydGlvbiBhcyBpdHMgcHJldHR5IGV4cGVuc2l2ZSwKICAgICAgICAvLyBidXQgaXQgY2F0Y2hlcyBhIGxvdCBvZiBidWdzLCBzbyBoZXJlIGZvciBkZWJ1Z3MKICAgICAgICAvLyBhd2FpdCB0aGlzLl9hc3NlcnROb2RlKG5vZGUsIGJhdGNoKQoKICAgICAgICBjb25zdCBkZXBzID0gbm9kZS5jYXVzYWxEZXBlbmRlbmNpZXMoKQoKICAgICAgICAvLyBvbGRlc3QgLT4gbmV3ZXN0CiAgICAgICAgZm9yIChsZXQgaSA9IGRlcHMubGVuZ3RoIC0gMTsgaSA+PSAxOyBpLS0pIHsKICAgICAgICAgIGNvbnN0IGQgPSBkZXBzW2ldCiAgICAgICAgICBpZiAoYXdhaXQgdGhpcy5zeXN0ZW0ubGlua2FibGUoZC53cml0ZXIuY29yZS5rZXksIGQubGVuZ3RoKSkgewogICAgICAgICAgICB0aGlzLnN5c3RlbS5hZGRIZWFkKGRlcHNbaV0pCiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnN5c3RlbS5hZGRIZWFkKGRlcHNbMF0pCgogICAgICAgIGlmIChub2RlLnZhbHVlICE9PSBudWxsICYmICFub2RlLndyaXRlci5pc1JlbW92ZWQpIHsKICAgICAgICAgIGFwcGx5QmF0Y2gucHVzaCh7CiAgICAgICAgICAgIGluZGV4ZWQsCiAgICAgICAgICAgIG9wdGltaXN0aWM6IGZhbHNlLAogICAgICAgICAgICBmcm9tOiBub2RlLndyaXRlci5jb3JlLAogICAgICAgICAgICBsZW5ndGg6IG5vZGUubGVuZ3RoLAogICAgICAgICAgICB2YWx1ZTogbm9kZS52YWx1ZSwKICAgICAgICAgICAgaGVhZHM6IG5vZGUuYWN0dWFsSGVhZHMKICAgICAgICAgIH0pCiAgICAgICAgfQoKICAgICAgICBpZiAobm9kZS5iYXRjaCA+IDEpIGNvbnRpbnVlCgogICAgICAgIGlmIChhcHBseUJhdGNoLmxlbmd0aCAmJiB0aGlzLmJhc2UuX2hhc0FwcGx5ID09PSB0cnVlKSB7CiAgICAgICAgICB0aGlzLmFwcGx5aW5nID0gdQogICAgICAgICAgdGhpcy5hcHBseUJhdGNoID0gYXBwbHlCYXRjaAogICAgICAgICAgYXdhaXQgdGhpcy5iYXNlLl9oYW5kbGVycy5hcHBseShhcHBseUJhdGNoLCB0aGlzLnZpZXcsIHRoaXMuaG9zdGNhbGxzKQogICAgICAgICAgaWYgKGZvcmtlZEF0ID09PSAtMSAmJiB0aGlzLnBlbmRpbmdGb3JrKSBmb3JrZWRBdCA9IGkKICAgICAgICAgIHRoaXMuX3Bvc3RBcHBseSgpCiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCB1cGRhdGUgPSB7CiAgICAgICAgc2VxOiAwLAogICAgICAgIGtleTogbm9kZS53cml0ZXIuY29yZS5rZXksCiAgICAgICAgbGVuZ3RoOiBub2RlLmxlbmd0aCwKICAgICAgICBiYXRjaCwKICAgICAgICBzeXN0ZW1MZW5ndGg6IDAsCiAgICAgICAgaW5kZXhlcnM6IGZhbHNlCiAgICAgIH0KCiAgICAgIHVwZGF0ZS5pbmRleGVycyA9ICEhdGhpcy5zeXN0ZW0uaW5kZXhlclVwZGF0ZQoKICAgICAgaWYgKHRoaXMuc3lzdGVtLmluZGV4ZXJVcGRhdGUpIGF3YWl0IHRoaXMuX2dlbmVyYXRlTmV4dFZpZXdzKCkKCiAgICAgIGF3YWl0IHRoaXMuc3lzdGVtLmZsdXNoKHRoaXMudmlld3MpCiAgICAgIGF3YWl0IHRoaXMuc3lzdGVtLnVwZGF0ZSgpCgogICAgICBpZiAobm9kZS53cml0ZXIuY29yZS53cml0YWJsZSkgdGhpcy5fZW5kVHJhY2Uobm9kZSkKCiAgICAgIGJhdGNoID0gMAogICAgICBhcHBseUJhdGNoID0gW10KCiAgICAgIHRoaXMuX3B1c2hVcGRhdGUodXBkYXRlKQoKICAgICAgaWYgKCFpbmRleGVkIHx8IGluZGV4ZXJzVXBkYXRlZCkgY29udGludWUKCiAgICAgIHRoaXMuYmFzZS5fc2hpZnRXcml0ZXIobm9kZS53cml0ZXIpCgogICAgICBpZiAodXBkYXRlLmluZGV4ZXJzKSB7CiAgICAgICAgaW5kZXhlcnNVcGRhdGVkID0gaSArIDEKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLnBlbmRpbmdGb3JrKSB7CiAgICAgIGNvbnN0IHBlbmRpbmcgPSB0aGlzLnBlbmRpbmdGb3JrCiAgICAgIGlmIChwZW5kaW5nLmxlbmd0aCA+IHRoaXMuaW5kZXhlZExlbmd0aCkgdGhpcy5faW5kZXhVcGRhdGVzKHUuaW5kZXhlZC5sZW5ndGgpCgogICAgICBjb25zdCBmb3JrID0gbmV3IEZvcmsodGhpcy5iYXNlLCB0aGlzLnN0b3JlLCB0aGlzLCBwZW5kaW5nKQogICAgICBjb25zdCBmb3JrZWQgPSBhd2FpdCBmb3JrLnVwZ3JhZGUoKQoKICAgICAgaWYgKCFmb3JrZWQpIHRocm93IG5ldyBFcnJvcignRm9yayBmYWlsZWQnKQoKICAgICAgYXdhaXQgdGhpcy5fZmx1c2gobG9jYWxOb2RlcykKCiAgICAgIHJldHVybiB7CiAgICAgICAgcmVib290OiB0cnVlLAogICAgICAgIG1pZ3JhdGVkOiBmYWxzZQogICAgICB9CiAgICB9CgogICAgaWYgKHUuaW5kZXhlZC5sZW5ndGgpIHsKICAgICAgdGhpcy5faW5kZXhVcGRhdGVzKGluZGV4ZXJzVXBkYXRlZCB8fCB1LmluZGV4ZWQubGVuZ3RoKQogICAgfQoKICAgIGNvbnN0IG1pZ3JhdGVkID0gaW5kZXhlcnNVcGRhdGVkICE9PSAwCiAgICBpZiAobWlncmF0ZWQpIHRoaXMua2V5ID0gYXdhaXQgdGhpcy5iYXNlLl9wcmVtaWdyYXRlKCkKCiAgICBpZiAodGhpcy5jaGFuZ2VzICE9PSBudWxsKSB7CiAgICAgIHRoaXMuY2hhbmdlcy5maW5hbGlzZSgpCiAgICAgIGF3YWl0IHRoaXMuYmFzZS5faGFuZGxlcnMudXBkYXRlKHRoaXMudmlldywgdGhpcy5jaGFuZ2VzKQogICAgfQoKICAgIGF3YWl0IHRoaXMuX2ZsdXNoKGxvY2FsTm9kZXMpCgogICAgcmV0dXJuIHsKICAgICAgcmVib290OiBtaWdyYXRlZCwKICAgICAgbWlncmF0ZWQKICAgIH0KICB9CgogIGZsdXNoKCkgewogICAgcmV0dXJuIHRoaXMuX2ZsdXNoKG51bGwpCiAgfQoKICBhc3luYyBfYXBwZW5kTG9jYWxOb2Rlcyhsb2NhbE5vZGVzKSB7CiAgICBpZiAobG9jYWxOb2Rlcy5sZW5ndGggPT09IDApIHJldHVybiAvLyBqdXN0IGluIGNhc2UKCiAgICBjb25zdCBibG9ja3MgPSBuZXcgQXJyYXkobG9jYWxOb2Rlcy5sZW5ndGgpCiAgICBjb25zdCBsb2NhbCA9IHRoaXMubG9jYWwKCiAgICBpZiAoIWxvY2FsLm9wZW5lZCkgYXdhaXQgbG9jYWwucmVhZHkoKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHsgdmFsdWUsIGhlYWRzLCBiYXRjaCwgb3B0aW1pc3RpYywgdHJhY2UgfSA9IGxvY2FsTm9kZXNbaV0KCiAgICAgIGJsb2Nrc1tpXSA9IHsKICAgICAgICB2ZXJzaW9uOiBPUExPR19WRVJTSU9OLAogICAgICAgIG1heFN1cHBvcnRlZFZlcnNpb246IHRoaXMuYmFzZS5tYXhTdXBwb3J0ZWRWZXJzaW9uLAogICAgICAgIGNoZWNrcG9pbnQ6IG51bGwsCiAgICAgICAgZGlnZXN0OiBudWxsLAogICAgICAgIG9wdGltaXN0aWMsCiAgICAgICAgbm9kZTogewogICAgICAgICAgaGVhZHMsCiAgICAgICAgICBiYXRjaCwKICAgICAgICAgIHZhbHVlOiB2YWx1ZSA9PT0gbnVsbCA/IG51bGwgOiBjLmVuY29kZSh0aGlzLmJhc2UudmFsdWVFbmNvZGluZywgdmFsdWUpCiAgICAgICAgfSwKICAgICAgICB0cmFjZQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMubG9jYWxJbmRleGVyKSB7CiAgICAgIGNvbnN0IHNpZ25lZExlbmd0aCA9IHRoaXMubG9jYWxDaGVja3BvaW50LnNpZ25lZExlbmd0aCgpCiAgICAgIGNvbnN0IGxvY2FsID0gdGhpcy5sb2NhbAoKICAgICAgbGV0IHNpZ25lZEF0ID0gMAogICAgICBsZXQgaW50ZXJuYWxTaWduYXR1cmVzID0gbnVsbAogICAgICBsZXQgc2lnbmF0dXJlcyA9IG51bGwKCiAgICAgIGlmICh0aGlzLmluZGV4ZWRMZW5ndGggPiBzaWduZWRMZW5ndGgpIHsKICAgICAgICBjb25zdCBzeXMgPSBhd2FpdCB0aGlzLnN5c3RlbS5nZXRJbmRleGVkSW5mbyh0aGlzLmluZGV4ZWRMZW5ndGgpCiAgICAgICAgaW50ZXJuYWxTaWduYXR1cmVzID0gYXdhaXQgdGhpcy5fc2lnbkludGVybmFsVmlld0NvcmVzKHN5cykKICAgICAgICBzaWduYXR1cmVzID0gYXdhaXQgdGhpcy5fc2lnblVzZXJWaWV3Q29yZXMoc3lzKQogICAgICAgIHNpZ25lZEF0ID0gbG9jYWwubGVuZ3RoICsgYmxvY2tzLmxlbmd0aAogICAgICB9CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJsb2Nrcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGxlbmd0aCA9IGxvY2FsLmxlbmd0aCArIGkgKyAxCiAgICAgICAgaWYgKGxlbmd0aCA9PT0gc2lnbmVkQXQpIHsKICAgICAgICAgIHRoaXMubG9jYWxDaGVja3BvaW50LnVwZGF0ZUludGVybmFsU2lnbmF0dXJlcyhsZW5ndGgsIGludGVybmFsU2lnbmF0dXJlcykKICAgICAgICAgIHRoaXMubG9jYWxDaGVja3BvaW50LnVwZGF0ZVVzZXJTaWduYXR1cmVzKGxlbmd0aCwgc2lnbmF0dXJlcykKICAgICAgICB9CgogICAgICAgIGNvbnN0IGJsayA9IGJsb2Nrc1tpXQoKICAgICAgICBibGsuY2hlY2twb2ludCA9IHRoaXMubG9jYWxDaGVja3BvaW50Lm1ha2VDaGVja3BvaW50cyhsZW5ndGgpCiAgICAgICAgYmxrLmRpZ2VzdCA9IHRoaXMubG9jYWxDaGVja3BvaW50Lm1ha2VEaWdlc3QobGVuZ3RoLCB0aGlzLmtleSkKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKCF0aGlzLmxvY2FsQ2hlY2twb2ludCkgYXdhaXQgdGhpcy5fc3RhcnRMb2NhbENoZWNrcG9pbnQoKQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBibG9ja3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBsZW5ndGggPSBsb2NhbC5sZW5ndGggKyBpICsgMQogICAgICAgIGJsb2Nrc1tpXS5kaWdlc3QgPSB0aGlzLmxvY2FsQ2hlY2twb2ludC5tYWtlRGlnZXN0KGxlbmd0aCwgdGhpcy5rZXkpCiAgICAgIH0KICAgIH0KCiAgICBhd2FpdCBsb2NhbC5hcHBlbmQoYmxvY2tzKQogIH0KCiAgYXN5bmMgX3JvbGxiYWNrVmlld3MoKSB7CiAgICAvLyBlbmNyeXB0aW9uIHZpZXcga2V5IGlzIG5vdCBpbiBzeXN0ZW0gc28gbm8gbmVlZCB0byBoYW5kbGUgaGVyZQogICAgZm9yIChjb25zdCB2aWV3IG9mIHRoaXMudmlld3MpIHsKICAgICAgY29uc3QgdiA9IHRoaXMuZ2V0Vmlld0Zyb21TeXN0ZW0odmlldykKCiAgICAgIGlmICh2KSB7CiAgICAgICAgdmlldy5rZXkgPSB2LmtleQogICAgICB9IGVsc2UgewogICAgICAgIGF3YWl0IHRoaXMuX3Jlc2V0Vmlldyh2aWV3KQogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBjcmVhdGVBbmNob3IoKSB7CiAgICBjb25zdCBub2RlID0gdGhpcy5hcHBseUJhdGNoW3RoaXMuYXBwbHlCYXRjaC5sZW5ndGggLSAxXQogICAgY29uc3Qga2V5ID0gbm9kZS5mcm9tLmtleQogICAgY29uc3QgbGVuZ3RoID0gbm9kZS5sZW5ndGgKCiAgICBjb25zdCBpbmZvID0gYXdhaXQgdGhpcy5zeXN0ZW0uZ2V0KGtleSwgeyB1bmZsdXNoZWQ6IHRydWUgfSkKCiAgICBpZiAoIWluZm8gfHwgaW5mby5sZW5ndGggPCBsZW5ndGgpIHRocm93IG5ldyBFcnJvcignQW5jaG9yIG5vZGUgaXMgbm90IGluIHN5c3RlbScpCgogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDQwLCBidWZmZXI6IGI0YS5hbGxvYyg0MCkgfQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwga2V5KQogICAgYy51aW50NjQuZW5jb2RlKHN0YXRlLCBsZW5ndGgpCgogICAgY29uc3QgbmFtZXNwYWNlID0gY3J5cHRvLmhhc2goc3RhdGUuYnVmZmVyKQogICAgY29uc3QgbWFuaWZlc3REYXRhID0gYy5lbmNvZGUobWVzc2FnZXMuTWFuaWZlc3REYXRhLCB7IHZlcnNpb246IDAsIGxlZ2FjeUJsb2NrczogMCwgbmFtZXNwYWNlIH0pCgogICAgY29uc3QgcGFkZGluZyA9IHRoaXMuZW5jcnlwdGlvbiA/IEF1dG9iYXNlRW5jcnlwdGlvbi5QQURESU5HIDogMAogICAgY29uc3QgYmxvY2sgPSBlbmNvZGVWYWx1ZShudWxsLCB7IGhlYWRzOiBbeyBrZXksIGxlbmd0aCB9XSwgcGFkZGluZyB9KQogICAgaWYgKHRoaXMuZW5jcnlwdGlvbikgYXdhaXQgdGhpcy5lbmNyeXB0aW9uLmVuY3J5cHRBbmNob3IoYmxvY2ssIG5hbWVzcGFjZSkKCiAgICBjb25zdCByb290ID0geyBpbmRleDogMCwgc2l6ZTogYmxvY2suYnl0ZUxlbmd0aCwgaGFzaDogY3J5cHRvLmRhdGEoYmxvY2spIH0KICAgIGNvbnN0IGhhc2ggPSBjcnlwdG8udHJlZShbcm9vdF0pCiAgICBjb25zdCBwcm9sb2d1ZSA9IHsgaGFzaCwgbGVuZ3RoOiAxIH0KCiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5jcmVhdGVBbmNob3JDb3JlKHByb2xvZ3VlLCBtYW5pZmVzdERhdGEpCiAgICBhd2FpdCBjb3JlLnJlYWR5KCkKCiAgICBpZiAoY29yZS5sZW5ndGggPT09IDApIGF3YWl0IGNvcmUuYXBwZW5kKGJsb2NrLCB7IHdyaXRhYmxlOiB0cnVlLCBtYXhMZW5ndGg6IDEgfSkKCiAgICBhd2FpdCB0aGlzLnN5c3RlbS5hZGQoY29yZS5rZXksIHsgaXNJbmRleGVyOiBmYWxzZSwgbGVuZ3RoOiAwIH0pCiAgICBhd2FpdCB0aGlzLmJhc2UuX2FkZFdyaXRlcihjb3JlLmtleSwgdGhpcy5zeXN0ZW0pCgogICAgY29uc3QgYW5jaG9yID0geyBrZXk6IGNvcmUua2V5LCBsZW5ndGg6IGNvcmUubGVuZ3RoIH0KCiAgICBhd2FpdCBjb3JlLmNsb3NlKCkKICAgIGF3YWl0IHRoaXMuYmFzZS5oaW50V2FrZXVwKGFuY2hvcikKCiAgICByZXR1cm4gYW5jaG9yCiAgfQoKICBhc3luYyBfcmVzZXRWaWV3KHZpZXcpIHsKICAgIGNvbnN0IG1hbmlmZXN0cyA9IGF3YWl0IHRoaXMuc3RvcmUuZ2V0SW5kZXhlck1hbmlmZXN0cyh0aGlzLnN5c3RlbS5pbmRleGVycykKCiAgICBjb25zdCBtYW5pZmVzdERhdGEgPSB2aWV3LmNvcmUgPyB2aWV3LmNvcmUubWFuaWZlc3QudXNlckRhdGEgOiBudWxsCiAgICB2aWV3LmtleSA9IGF3YWl0IHRoaXMuc3RvcmUuY3JlYXRlVmlldygKICAgICAgbWFuaWZlc3RzLAogICAgICB2aWV3Lm5hbWUsCiAgICAgIG51bGwsCiAgICAgIHRoaXMuc3lzdGVtLmNvcmUubWFuaWZlc3QudmVyc2lvbiwKICAgICAgdGhpcy5zeXN0ZW0uZW50cm9weSwKICAgICAgbnVsbCwKICAgICAgbWFuaWZlc3REYXRhCiAgICApIC8vIHdpbGwgbmV2ZXIgYmUgc3lzdGVtIHNvIG5vIGxpbmtlZAogICAgdmlldy5sZW5ndGggPSAwCiAgfQoKICBhc3luYyBfZ2VuZXJhdGVOZXh0Vmlld3MoKSB7CiAgICBjb25zdCBzeXMgPSB0aGlzLnN5c3RlbQoKICAgIC8vIG5vdGUsIHRoaXMgaXMgdmVyeSBzdGF0ZSBkZXBlbmRlbnQgc28gY2FuIE9OTFkgYmUgY2FsbGVkIGF0IHRoZSBleGFjdCB0aW1lIGFuIGluZGV4ZXIgdXBncmFkZSBvY2N1cnMKICAgIGNvbnN0IG1hbmlmZXN0cyA9IGF3YWl0IHRoaXMuc3RvcmUuZ2V0SW5kZXhlck1hbmlmZXN0cyhzeXMuaW5kZXhlcnMpCiAgICBjb25zdCBlbnRyb3B5ID0gc3lzLnZlcnNpb24gPCAyID8gbnVsbCA6IHN5cy5nZXRFbnRyb3B5KHN5cy5pbmRleGVycywgc3lzLmZsdXNoTGVuZ3RoKCkpCgogICAgZm9yIChjb25zdCB2IG9mIHRoaXMudmlld3MpIHsKICAgICAgY29uc3QgbWFuaWZlc3REYXRhID0gdi5jb3JlID8gdi5jb3JlLm1hbmlmZXN0LnVzZXJEYXRhIDogbnVsbAoKICAgICAgY29uc3QgcHJvbG9ndWUgPSBhd2FpdCBnZXRQcm9sb2d1ZSh2KQogICAgICBjb25zdCBrZXkgPSBhd2FpdCB0aGlzLnN0b3JlLmNyZWF0ZVZpZXcoCiAgICAgICAgbWFuaWZlc3RzLAogICAgICAgIHYubmFtZSwKICAgICAgICBwcm9sb2d1ZSwKICAgICAgICBzeXMuY29yZS5tYW5pZmVzdC52ZXJzaW9uLAogICAgICAgIGVudHJvcHksCiAgICAgICAgbnVsbCwKICAgICAgICBtYW5pZmVzdERhdGEKICAgICAgKQoKICAgICAgdi5rZXkgPSBrZXkKICAgIH0KICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGdldFByb2xvZ3VlKHZpZXcpIHsKICBjb25zdCBsZW5ndGggPSB2aWV3LmNvcmUgPyB2aWV3LmNvcmUubGVuZ3RoIDogdmlldy5sZW5ndGgKICBpZiAoIWxlbmd0aCkgcmV0dXJuIG51bGwKCiAgY29uc3QgaGFzaCA9IGF3YWl0IHZpZXcuY29yZS50cmVlSGFzaChsZW5ndGgpCgogIHJldHVybiB7CiAgICBoYXNoLAogICAgbGVuZ3RoCiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIGNtcENoZWNrcG9pbnRzKGEsIGIpIHsKICByZXR1cm4gYS5zaWduZWRMZW5ndGgoKSAtIGIuc2lnbmVkTGVuZ3RoKCkKfQoKZnVuY3Rpb24gc2FtZVNpZ25hdHVyZShhLCBiKSB7CiAgaWYgKCFhIHx8ICFiKSByZXR1cm4gYSA9PT0gYgogIHJldHVybiBhLmxlbmd0aCA9PT0gYi5sZW5ndGgKfQoKZnVuY3Rpb24gc2FtZVNpZ25hdHVyZXMoYSwgYikgewogIGlmICghYSB8fCAhYikgcmV0dXJuIGEgPT09IGIKICBpZiAoYS5sZW5ndGggIT09IGIubGVuZ3RoKSByZXR1cm4gZmFsc2UKICBmb3IgKGxldCBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKyspIHsKICAgIGlmIChhW2ldLmxlbmd0aCAhPT0gYltpXS5sZW5ndGgpIHJldHVybiBmYWxzZQogIH0KICByZXR1cm4gdHJ1ZQp9CgpmdW5jdGlvbiBjcmVhdGVDaGVja3BvaW50U2lnbmF0dXJlKGxlbmd0aCwgdmlldywgY2hlY2twb2ludHMpIHsKICByZXR1cm4gewogICAgbGVuZ3RoLAogICAgY29yZTogdmlldy5jb3JlLAogICAgcmVmOiB2aWV3LnJlZiwKICAgIHNpZ25hdHVyZXM6IG5ldyBBcnJheShjaGVja3BvaW50cyksCiAgICBwYXJ0aWFsczogbmV3IEFycmF5KGNoZWNrcG9pbnRzKQogIH0KfQoKZnVuY3Rpb24gYWRkQ2hlY2twb2ludFNpZ25hdHVyZXMocGVuZGluZywgY2hlY2twb2ludHMsIGluZGV4KSB7CiAgY29uc3QgeyBzaWduZXIsIHNpZ25hdHVyZXMgfSA9IGNoZWNrcG9pbnRzW2luZGV4XQoKICBwZW5kaW5nWzBdLnNpZ25hdHVyZXNbaW5kZXhdID0gewogICAgc2lnbmF0dXJlOiBzaWduYXR1cmVzLnN5c3RlbS5zaWduYXR1cmUsCiAgICBsZW5ndGg6IHNpZ25hdHVyZXMuc3lzdGVtLmxlbmd0aCwKICAgIHNpZ25lcgogIH0KCiAgaWYgKHBlbmRpbmdbMV0pIHsKICAgIHBlbmRpbmdbMV0uc2lnbmF0dXJlc1tpbmRleF0gPSB7CiAgICAgIHNpZ25hdHVyZTogc2lnbmF0dXJlcy5lbmNyeXB0aW9uLnNpZ25hdHVyZSwKICAgICAgbGVuZ3RoOiBzaWduYXR1cmVzLmVuY3J5cHRpb24ubGVuZ3RoLAogICAgICBzaWduZXIKICAgIH0KICB9CgogIGZvciAobGV0IGkgPSAyOyBpIDwgcGVuZGluZy5sZW5ndGg7IGkrKykgewogICAgaWYgKCFwZW5kaW5nW2ldKSBjb250aW51ZQoKICAgIGNvbnN0IHsgbGVuZ3RoLCBzaWduYXR1cmUgfSA9IHNpZ25hdHVyZXMudXNlcltpIC0gMl0KCiAgICBwZW5kaW5nW2ldLnNpZ25hdHVyZXNbaW5kZXhdID0gewogICAgICBzaWduYXR1cmUsCiAgICAgIGxlbmd0aCwKICAgICAgc2lnbmVyCiAgICB9CiAgfQp9Cgphc3luYyBmdW5jdGlvbiBzZXRQYXJ0aWFsU2lnbmF0dXJlKHZpZXcsIGluZGV4KSB7CiAgY29uc3Qgc2lnID0gdmlldy5zaWduYXR1cmVzW2luZGV4XQogIGlmIChzaWcubGVuZ3RoIDwgdmlldy5sZW5ndGggJiYgc2lnLmxlbmd0aCA+IDApIGF3YWl0IHZpZXcuY29yZS5nZXQoc2lnLmxlbmd0aCAtIDEpCgogIHZpZXcucGFydGlhbHNbaW5kZXhdID0gYXdhaXQgcGFydGlhbFNpZ25hdHVyZSgKICAgIHZpZXcuY29yZSwKICAgIHNpZy5zaWduZXIsCiAgICB2aWV3Lmxlbmd0aCwKICAgIHNpZy5sZW5ndGgsCiAgICBzaWcuc2lnbmF0dXJlCiAgKQp9CgpmdW5jdGlvbiB1cGRhdGVTaWduYXR1cmUobGVuZ3RoLCBzaWcsIGV4aXN0aW5nKSB7CiAgcmV0dXJuIHNpZyA/IHsgc2lnbmF0dXJlOiBzaWcuc2lnbmF0dXJlLCBsZW5ndGg6IHNpZy5sZW5ndGgsIGF0OiBsZW5ndGggfSA6IGV4aXN0aW5nCn0KCmZ1bmN0aW9uIHVwZGF0ZVNpZ25hdHVyZXMobGVuZ3RoLCBzaWduYXR1cmVzLCBleGlzdGluZykgewogIGNvbnN0IHVwZGF0ZWQgPSBuZXcgQXJyYXkoc2lnbmF0dXJlcy5sZW5ndGgpCgogIGZvciAobGV0IGkgPSAwOyBpIDwgdXBkYXRlZC5sZW5ndGg7IGkrKykgewogICAgdXBkYXRlZFtpXSA9IHVwZGF0ZVNpZ25hdHVyZShsZW5ndGgsIHNpZ25hdHVyZXNbaV0sIGkgPCBleGlzdGluZy5sZW5ndGggPyBleGlzdGluZ1tpXSA6IG51bGwpCiAgfQoKICByZXR1cm4gdXBkYXRlZAp9CgpmdW5jdGlvbiBtYWtlQ2hlY2twb2ludChsZW5ndGgsIGNoaykgewogIGlmICghY2hrKSByZXR1cm4gbnVsbAoKICBjb25zdCBjaGVja3BvaW50ZXIgPSBsZW5ndGggLSBjaGsuYXQKCiAgcmV0dXJuIHsKICAgIGNoZWNrcG9pbnRlciwKICAgIGNoZWNrcG9pbnQ6IGNoZWNrcG9pbnRlciA9PT0gMCA/IHsgc2lnbmF0dXJlOiBjaGsuc2lnbmF0dXJlLCBsZW5ndGg6IGNoay5sZW5ndGggfSA6IG51bGwKICB9Cn0KCmZ1bmN0aW9uIG1ha2VDaGVja3BvaW50cyhsZW5ndGgsIHNpZ25hdHVyZXMpIHsKICBpZiAoIXNpZ25hdHVyZXMubGVuZ3RoKSByZXR1cm4gbnVsbAoKICBjb25zdCBjaGVja3BvaW50cyA9IG5ldyBBcnJheShzaWduYXR1cmVzLmxlbmd0aCkKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaWduYXR1cmVzLmxlbmd0aDsgaSsrKSB7CiAgICBjaGVja3BvaW50c1tpXSA9IG1ha2VDaGVja3BvaW50KGxlbmd0aCwgc2lnbmF0dXJlc1tpXSkKICB9CgogIHJldHVybiBjaGVja3BvaW50cwp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgbWVzc2FnZXMgPSByZXF1aXJlKCcuL21lc3NhZ2VzLmpzJykKCm1vZHVsZS5leHBvcnRzID0gYXN5bmMgZnVuY3Rpb24gYm9vdCgKICBjb3Jlc3RvcmUsCiAga2V5LAogIHsgZW5jcnlwdCwgZW5jcnlwdGlvbktleSwga2V5UGFpciwgZXhjbHVzaXZlID0gdHJ1ZSB9ID0ge30KKSB7CiAgY29uc3QgcmVzdWx0ID0gewogICAga2V5OiBudWxsLAogICAgbG9jYWw6IG51bGwsCiAgICBib290c3RyYXA6IG51bGwsCiAgICBlbmNyeXB0aW9uS2V5OiBudWxsLAogICAgYm9vdDogbnVsbAogIH0KCiAgY29uc3QgbWFuaWZlc3QgPSBrZXlQYWlyCiAgICA/IHsgdmVyc2lvbjogY29yZXN0b3JlLm1hbmlmZXN0VmVyc2lvbiwgc2lnbmVyczogW3sgcHVibGljS2V5OiBrZXlQYWlyLnB1YmxpY0tleSB9XSB9CiAgICA6IG51bGwKCiAgaWYgKGtleSkgewogICAgcmVzdWx0LmtleSA9IGtleQoKICAgIGNvbnN0IGJvb3RzdHJhcCA9IGNvcmVzdG9yZS5nZXQoeyBrZXksIGFjdGl2ZTogZmFsc2UsIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZSB9KQogICAgYXdhaXQgYm9vdHN0cmFwLnJlYWR5KCkKCiAgICBjb25zdCBsb2NhbEtleSA9IGF3YWl0IGJvb3RzdHJhcC5nZXRVc2VyRGF0YSgnYXV0b2Jhc2UvbG9jYWwnKQoKICAgIGlmIChrZXlQYWlyKSB7CiAgICAgIHJlc3VsdC5sb2NhbCA9IGNvcmVzdG9yZS5nZXQoewogICAgICAgIGtleVBhaXIsCiAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICBleGNsdXNpdmUsCiAgICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlLAogICAgICAgIG1hbmlmZXN0CiAgICAgIH0pCiAgICB9IGVsc2UgewogICAgICBpZiAoYm9vdHN0cmFwLndyaXRhYmxlICYmICFsb2NhbEtleSkgewogICAgICAgIHJlc3VsdC5sb2NhbCA9IGJvb3RzdHJhcC5zZXNzaW9uKHsKICAgICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgICBleGNsdXNpdmUsCiAgICAgICAgICB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UKICAgICAgICB9KQogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGxvY2FsID0gbG9jYWxLZXkKICAgICAgICAgID8gY29yZXN0b3JlLmdldCh7CiAgICAgICAgICAgICAga2V5OiBsb2NhbEtleSwKICAgICAgICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgICAgICAgIGV4Y2x1c2l2ZSwKICAgICAgICAgICAgICB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UKICAgICAgICAgICAgfSkKICAgICAgICAgIDogY29yZXN0b3JlLmdldCh7CiAgICAgICAgICAgICAgbmFtZTogJ2xvY2FsJywKICAgICAgICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgICAgICAgIGV4Y2x1c2l2ZSwKICAgICAgICAgICAgICB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UKICAgICAgICAgICAgfSkKCiAgICAgICAgYXdhaXQgbG9jYWwucmVhZHkoKQogICAgICAgIHJlc3VsdC5sb2NhbCA9IGxvY2FsCiAgICAgIH0KICAgIH0KCiAgICByZXN1bHQuYm9vdHN0cmFwID0gYm9vdHN0cmFwCiAgfSBlbHNlIHsKICAgIHJlc3VsdC5sb2NhbCA9IGtleVBhaXIKICAgICAgPyBjb3Jlc3RvcmUuZ2V0KHsKICAgICAgICAgIGtleVBhaXIsCiAgICAgICAgICBtYW5pZmVzdCwKICAgICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgICBleGNsdXNpdmUsCiAgICAgICAgICB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UKICAgICAgICB9KQogICAgICA6IGNvcmVzdG9yZS5nZXQoewogICAgICAgICAgbmFtZTogJ2xvY2FsJywKICAgICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgICBleGNsdXNpdmUsCiAgICAgICAgICB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UKICAgICAgICB9KQogICAgYXdhaXQgcmVzdWx0LmxvY2FsLnJlYWR5KCkKCiAgICBjb25zdCBrZXkgPSBhd2FpdCByZXN1bHQubG9jYWwuZ2V0VXNlckRhdGEoJ3JlZmVycmVyJykKICAgIGlmIChrZXkpIHsKICAgICAgcmVzdWx0LmtleSA9IGtleQogICAgICByZXN1bHQuYm9vdHN0cmFwID0gY29yZXN0b3JlLmdldCh7IGtleSwgYWN0aXZlOiBmYWxzZSwgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlIH0pCiAgICAgIGF3YWl0IHJlc3VsdC5ib290c3RyYXAucmVhZHkoKQogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0LmtleSA9IHJlc3VsdC5sb2NhbC5rZXkKICAgICAgcmVzdWx0LmJvb3RzdHJhcCA9IHJlc3VsdC5sb2NhbC5zZXNzaW9uKHsKICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZQogICAgICB9KQogICAgICBhd2FpdCByZXN1bHQuYm9vdHN0cmFwLnNldFVzZXJEYXRhKCdhdXRvYmFzZS9sb2NhbCcsIHJlc3VsdC5sb2NhbC5rZXkpCiAgICB9CiAgfQoKICBpZiAoa2V5IHx8IGtleVBhaXIpIHsKICAgIGF3YWl0IHJlc3VsdC5ib290c3RyYXAuc2V0VXNlckRhdGEoJ3JlZmVycmVyJywgcmVzdWx0LmtleSkKICAgIGF3YWl0IHJlc3VsdC5ib290c3RyYXAuc2V0VXNlckRhdGEoJ2F1dG9iYXNlL2xvY2FsJywgcmVzdWx0LmxvY2FsLmtleSkKICAgIGF3YWl0IHJlc3VsdC5sb2NhbC5zZXRVc2VyRGF0YSgncmVmZXJyZXInLCByZXN1bHQua2V5KQogIH0KCiAgY29uc3QgW2VuY3J5cHRpb25LZXlCdWZmZXIsIHBvaW50ZXJdID0gYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgcmVzdWx0LmxvY2FsLmdldFVzZXJEYXRhKCdhdXRvYmFzZS9lbmNyeXB0aW9uJyksCiAgICByZXN1bHQubG9jYWwuZ2V0VXNlckRhdGEoJ2F1dG9iYXNlL2Jvb3QnKQogIF0pCgogIGlmIChwb2ludGVyKSB7CiAgICByZXN1bHQuYm9vdCA9IGMuZGVjb2RlKG1lc3NhZ2VzLkJvb3RSZWNvcmQsIHBvaW50ZXIpCiAgfQoKICBpZiAoZW5jcnlwdGlvbktleUJ1ZmZlcikgewogICAgcmVzdWx0LmVuY3J5cHRpb25LZXkgPSBlbmNyeXB0aW9uS2V5QnVmZmVyCiAgfQoKICBpZiAoIXJlc3VsdC5lbmNyeXB0aW9uS2V5ICYmIChlbmNyeXB0aW9uS2V5IHx8IGVuY3J5cHQpKSB7CiAgICBpZiAoIWVuY3J5cHRpb25LZXkpCiAgICAgIGVuY3J5cHRpb25LZXkgPSAoYXdhaXQgY29yZXN0b3JlLmNyZWF0ZUtleVBhaXIoJ2F1dG9iYXNlL2VuY3J5cHRpb24nKSkuc2VjcmV0S2V5LnN1YmFycmF5KAogICAgICAgIDAsCiAgICAgICAgMzIKICAgICAgKQogICAgYXdhaXQgcmVzdWx0LmJvb3RzdHJhcC5zZXRVc2VyRGF0YSgnYXV0b2Jhc2UvZW5jcnlwdGlvbicsIGVuY3J5cHRpb25LZXkpIC8vIGxlZ2FjeSBzdXBwb3J0CiAgICBhd2FpdCByZXN1bHQubG9jYWwuc2V0VXNlckRhdGEoJ2F1dG9iYXNlL2VuY3J5cHRpb24nLCBlbmNyeXB0aW9uS2V5KQogICAgcmVzdWx0LmVuY3J5cHRpb25LZXkgPSBlbmNyeXB0aW9uS2V5CiAgfQoKICByZXR1cm4gcmVzdWx0Cn0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCgpjb25zdCBPUExPR19WRVJTSU9OID0gMgpjb25zdCBERUZBVUxUX0FVVE9CQVNFX1ZFUlNJT04gPSAxIC8vIGRlZmF1bHQKY29uc3QgTUFYX0FVVE9CQVNFX1ZFUlNJT04gPSAyIC8vIG9wdGlvbmFsIGZvcmsgc3VwcG9ydApjb25zdCBCT09UX1JFQ09SRF9WRVJTSU9OID0gMwoKY29uc3QgW05TX1NJR05FUl9OQU1FU1BBQ0UsIE5TX1ZJRVdfQkxPQ0tfS0VZLCBOU19IQVNIX0tFWSwgTlNfRU5DUllQVElPTl0gPSBjcnlwdG8ubmFtZXNwYWNlKAogICdhdXRvYmFzZScsCiAgNAopCgptb2R1bGUuZXhwb3J0cyA9IHsKICBPUExPR19WRVJTSU9OLAogIERFRkFVTFRfQVVUT0JBU0VfVkVSU0lPTiwKICBNQVhfQVVUT0JBU0VfVkVSU0lPTiwKICBCT09UX1JFQ09SRF9WRVJTSU9OLAogIE5TX1NJR05FUl9OQU1FU1BBQ0UsCiAgTlNfVklFV19CTE9DS19LRVksCiAgTlNfSEFTSF9LRVksCiAgTlNfRU5DUllQVElPTgp9CmNvbnN0IEJ1ZmZlck1hcCA9IHJlcXVpcmUoJ3RpbnktYnVmZmVyLW1hcCcpCgovLyBUaGlzIGlzIGJhc2ljYWxseSBqdXN0IGEgTWFwIGF0bSwgYnV0IGxlYXZpbmcgaXQgYXMgYW4gYWJzdHJhY3Rpb24gZm9yIG5vdwovLyBpbiBjYXNlIHdlIHdhbm5hIG9wdGltaXplIGl0IGZvciBvdXIgZXhhY3QgdXNlY2FzZQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBDbG9jayB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLnNlZW4gPSBuZXcgQnVmZmVyTWFwKCkKICB9CgogIGdldCBzaXplKCkgewogICAgcmV0dXJuIHRoaXMuc2Vlbi5zaXplCiAgfQoKICBoYXMoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5zZWVuLmhhcyhrZXkpCiAgfQoKICBpbmNsdWRlcyhrZXksIGxlbmd0aCkgewogICAgcmV0dXJuIHRoaXMuc2Vlbi5oYXMoa2V5KSAmJiB0aGlzLnNlZW4uZ2V0KGtleSkgPj0gbGVuZ3RoCiAgfQoKICBnZXQoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5zZWVuLmdldChrZXkpIHx8IDAKICB9CgogIHNldChrZXksIGxlbikgewogICAgdGhpcy5zZWVuLnNldChrZXksIGxlbikKICAgIHJldHVybiBsZW4KICB9CgogIGFkZChjbG9jaykgewogICAgZm9yIChjb25zdCBba2V5LCBsXSBvZiBjbG9jaykgewogICAgICBpZiAodGhpcy5nZXQoa2V5KSA8IGwpIHRoaXMuc2V0KGtleSwgbCkKICAgIH0KICB9CgogIFtTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgcmV0dXJuIHRoaXMuc2VlbltTeW1ib2wuaXRlcmF0b3JdKCkKICB9Cn0KY29uc3QgQnVmZmVyTWFwID0gcmVxdWlyZSgndGlueS1idWZmZXItbWFwJykKCmNvbnN0IENsb2NrID0gcmVxdWlyZSgnLi9jbG9jay5qcycpCgpjb25zdCBVTlNFRU4gPSAwCmNvbnN0IE5FV0VSID0gMQpjb25zdCBBQ0tFRCA9IDIKCi8vIENvbnNlbnN1cyBtYWNoaW5lIGZvciBBdXRvYmFzZS4gU29ydCBEQUcgbm9kZXMgdXNpbmcKLy8gdmVjdG9yIGNsb2NrcyB0byBkZXRlcm1pbmUgYSBnbG9iYWxseSBjb25zaXN0ZW50IHZpZXcKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ29uc2Vuc3VzIHsKICBjb25zdHJ1Y3RvcihpbmRleGVycykgewogICAgdGhpcy5tZXJnZXMgPSBuZXcgU2V0KCkKICAgIHRoaXMubWFqb3JpdHkgPSAoaW5kZXhlcnMubGVuZ3RoID4+PiAxKSArIDEKICAgIHRoaXMuaW5kZXhlcnMgPSBpbmRleGVycwogICAgdGhpcy5yZW1vdmVkID0gbmV3IENsb2NrKCkKICAgIHRoaXMudXBkYXRlZCA9IGZhbHNlCgogICAgdGhpcy53cml0ZXJzID0gbmV3IEJ1ZmZlck1hcCgpCiAgICBmb3IgKGNvbnN0IGlkeCBvZiB0aGlzLmluZGV4ZXJzKSB7CiAgICAgIHRoaXMud3JpdGVycy5zZXQoaWR4LmNvcmUua2V5LCBpZHgpCiAgICB9CiAgfQoKICBhZGRIZWFkKG5vZGUpIHsKICAgIGlmICghbm9kZS53cml0ZXIuaXNBY3RpdmVJbmRleGVyKSByZXR1cm4KICAgIGlmICh0aGlzLl9pc01lcmdlKG5vZGUpKSB0aGlzLm1lcmdlcy5hZGQobm9kZSkKICAgIHRoaXMudXBkYXRlZCA9IHRydWUKICAgIHJldHVybiBub2RlCiAgfQoKICAvKiBJbmRleGVyIE9ubHkgREFHIG1ldGhvZHMgKi8KCiAgX3RhaWxzKG5vZGUsIHRhaWxzKSB7CiAgICBjb25zdCB0YWlsU2V0ID0gbmV3IFNldCgpCiAgICBmb3IgKGNvbnN0IHQgb2YgdGFpbHMpIHsKICAgICAgaWYgKG5vZGUuY2xvY2suaW5jbHVkZXModC53cml0ZXIuY29yZS5rZXksIHQubGVuZ3RoKSkgdGFpbFNldC5hZGQodCkKICAgIH0KCiAgICByZXR1cm4gdGFpbFNldAogIH0KCiAgX3RhaWxzQW5kTWVyZ2VzKG5vZGUsIHRhaWxzKSB7CiAgICBjb25zdCBhbGwgPSB0aGlzLl90YWlscyhub2RlLCB0YWlscykKICAgIGZvciAoY29uc3QgbSBvZiB0aGlzLm1lcmdlcykgewogICAgICBpZiAobSAhPT0gbm9kZSAmJiBub2RlLmNsb2NrLmluY2x1ZGVzKG0ud3JpdGVyLmNvcmUua2V5LCBtLmxlbmd0aCkpIHsKICAgICAgICBhbGwuYWRkKG0pCiAgICAgIH0KICAgIH0KICAgIHJldHVybiBhbGwKICB9CgogIF9pc01lcmdlKG5vZGUpIHsKICAgIGlmICghbm9kZS53cml0ZXIuaXNBY3RpdmVJbmRleGVyKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBkZXBzID0gW10KCiAgICBmb3IgKGNvbnN0IGlkeCBvZiB0aGlzLmluZGV4ZXJzKSB7CiAgICAgIGxldCBzZXEgPSBub2RlLmNsb2NrLmdldChpZHguY29yZS5rZXkpIC0gMQoKICAgICAgaWYgKGlkeCA9PT0gbm9kZS53cml0ZXIpIHNlcS0tCgogICAgICBjb25zdCBoZWFkID0gaWR4LmdldChzZXEpCiAgICAgIGlmICghaGVhZCB8fCB0aGlzLnJlbW92ZWQuaW5jbHVkZXMoaGVhZC53cml0ZXIuY29yZS5rZXksIGhlYWQubGVuZ3RoKSkgY29udGludWUKCiAgICAgIGxldCBpc0RlcCA9IHRydWUKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZXBzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgZCA9IGRlcHNbaV0KICAgICAgICBpZiAoZCA9PT0gaGVhZCkgY29udGludWUKCiAgICAgICAgaWYgKGQuY2xvY2suaW5jbHVkZXMoaGVhZC53cml0ZXIuY29yZS5rZXksIGhlYWQubGVuZ3RoKSkgewogICAgICAgICAgaXNEZXAgPSBmYWxzZQogICAgICAgICAgYnJlYWsKICAgICAgICB9CgogICAgICAgIGlmIChoZWFkLmNsb2NrLmluY2x1ZGVzKGQud3JpdGVyLmNvcmUua2V5LCBkLmxlbmd0aCkpIHsKICAgICAgICAgIGNvbnN0IHBvcHBlZCA9IGRlcHMucG9wKCkKICAgICAgICAgIGlmIChkID09PSBwb3BwZWQpIGNvbnRpbnVlCiAgICAgICAgICBkZXBzW2ktLV0gPSBwb3BwZWQKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChpc0RlcCkgZGVwcy5wdXNoKGhlYWQpCiAgICB9CgogICAgcmV0dXJuIGRlcHMubGVuZ3RoID4gMQogIH0KCiAgX2luZGV4ZXJUYWlscygpIHsKICAgIGNvbnN0IHRhaWxzID0gbmV3IFNldCgpCiAgICBmb3IgKGNvbnN0IGlkeCBvZiB0aGlzLmluZGV4ZXJzKSB7CiAgICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMucmVtb3ZlZC5oYXMoaWR4LmNvcmUua2V5KSA/IHRoaXMucmVtb3ZlZC5nZXQoaWR4LmNvcmUua2V5KSA6IGlkeC5pbmRleGVkCgogICAgICBjb25zdCBoZWFkID0gaWR4LmdldChsZW5ndGgpCiAgICAgIGlmICghaGVhZCB8fCB0aGlzLnJlbW92ZWQuaW5jbHVkZXMoaGVhZC53cml0ZXIuY29yZS5rZXksIGhlYWQubGVuZ3RoKSkgY29udGludWUKCiAgICAgIGxldCBpc1RhaWwgPSB0cnVlCiAgICAgIGZvciAoY29uc3QgdCBvZiB0YWlscykgewogICAgICAgIGlmIChoZWFkLmNsb2NrLmluY2x1ZGVzKHQud3JpdGVyLmNvcmUua2V5LCB0Lmxlbmd0aCkpIHsKICAgICAgICAgIGlzVGFpbCA9IGZhbHNlCiAgICAgICAgICBicmVhawogICAgICAgIH0KCiAgICAgICAgaWYgKHQuY2xvY2suaW5jbHVkZXMoaGVhZC53cml0ZXIuY29yZS5rZXksIGhlYWQubGVuZ3RoKSkgewogICAgICAgICAgdGFpbHMuZGVsZXRlKHQpCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNUYWlsKSB0YWlscy5hZGQoaGVhZCkKICAgIH0KCiAgICByZXR1cm4gdGFpbHMKICB9CgogIC8vIHBhcmVudCBpcyBuZXdlciBpZiBmb3IgYW55IG5vZGUgaW4gcGFyZW50J3MgdmlldywKICAvLyBlaXRoZXIgbm9kZSBjYW4gc2VlIG9iamVjdCBvciBvYmplY3QgY2FuIHNlZSBub2RlCiAgX3N0cmljdGx5TmV3ZXIob2JqZWN0LCBwYXJlbnQpIHsKICAgIGlmICghcGFyZW50LmNsb2NrLmluY2x1ZGVzKG9iamVjdC53cml0ZXIuY29yZS5rZXksIG9iamVjdC5sZW5ndGgpKSByZXR1cm4gZmFsc2UKCiAgICBmb3IgKGNvbnN0IFtrZXksIGxhdGVzdF0gb2YgcGFyZW50LmNsb2NrKSB7CiAgICAgIGNvbnN0IG9sZGVzdCA9IHRoaXMucmVtb3ZlZC5nZXQoa2V5KQogICAgICBpZiAobGF0ZXN0IDw9IG9sZGVzdCkgY29udGludWUgLy8gY2hlY2sgcXVpY2tseSBpZiB3ZSByZW1vdmVkIGl0CgogICAgICAvLyBnZXQgdGhlIE5FWFQgbm9kZSBmcm9tIHRoZSB3cml0ZXIgZnJvbSB0aGUgb2JqZWN0cyBwb3YsIGFkanVzdCBpZiBpdHMgcmVtb3ZlZAogICAgICBsZXQgbGVuZ3RoID0gb2JqZWN0LmNsb2NrLmdldChrZXkpCiAgICAgIGlmIChsZW5ndGggPD0gb2xkZXN0KSBsZW5ndGggPSBvbGRlc3QKCiAgICAgIC8vIHNhbml0eSBjaGVjaywgbGlrZWx5IG5vdCBuZWVkZWQgYXMgc29tZW9uZSBoYXMgY2hlY2tlZCB0aGlzIGJlZm9yZSwgYnV0IGl0J3MgZnJlZQogICAgICBpZiAobGF0ZXN0IDwgbGVuZ3RoKSByZXR1cm4gZmFsc2UKCiAgICAgIC8vIGlmIHRoZSBzYW1lLCB0aGV5IGhhdmUgYm90aCBzZWVuIGl0LCBjb250aW51ZQogICAgICBpZiAobGF0ZXN0ID09PSBsZW5ndGgpIGNvbnRpbnVlCgogICAgICBjb25zdCB3cml0ZXIgPSB0aGlzLndyaXRlcnMuZ2V0KGtleSkKCiAgICAgIC8vIG1pZ2h0IG5vdCBiZSBpbiB0aGUgcmVtb3ZlZCBzZXQgYnV0IHRoZSB3cml0ZXIgY2FuIHRlbGwgdXMgaWYgaXQgd2FzIGluZGV4ZWQuLi4KICAgICAgY29uc3QgbmV4dCA9IHdyaXRlciAmJiB3cml0ZXIuZ2V0KGxlbmd0aCA+PSB3cml0ZXIuaW5kZXhlZCA/IGxlbmd0aCA6IHdyaXRlci5pbmRleGVkKQoKICAgICAgLy8gbm8gbmV4dCwgaXRzIGJlZW4gaW5kZXhlZCwgYm90aCBzZWVuIGl0CiAgICAgIGlmICghbmV4dCkgY29udGludWUKCiAgICAgIC8vIGlmIHRoZSBORVhUIG5vZGUgaGFzIHNlZW4gdGhlIG9iamVjdCBpdHMgZmluZSAtIG5ld2VyCiAgICAgIGlmIChuZXh0LmNsb2NrLmluY2x1ZGVzKG9iamVjdC53cml0ZXIuY29yZS5rZXksIG9iamVjdC5sZW5ndGgpKSBjb250aW51ZQoKICAgICAgLy8gb3RoZXJ3aXNlIHRoZSBwYXJlbnQgbXVzdCBhbHNvIE5PVCBoYXZlIHNlZW4gdGhlIG5leHQgbm9kZQogICAgICBpZiAobGF0ZXN0IDwgbmV4dC5sZW5ndGgpIGNvbnRpbnVlCgogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX2Fja3ModGFyZ2V0KSB7CiAgICBjb25zdCBhY2tzID0gdGFyZ2V0LndyaXRlci5pc0FjdGl2ZUluZGV4ZXIgPyBbdGFyZ2V0XSA6IFtdIC8vIFRPRE86IGNhbiBiZSBjYWNoZWQgb24gdGhlIHRhcmdldCBub2RlIGluIGZ1dHVyZSAoaWUgaWYgd2UgYWRkIG9uZSB3ZSBkb250IGhhdmUgdG8gY2hlY2sgaXQgYWdhaW4pCgogICAgZm9yIChjb25zdCBpZHggb2YgdGhpcy5pbmRleGVycykgewogICAgICBpZiAoaWR4ID09PSB0YXJnZXQud3JpdGVyKSBjb250aW51ZQoKICAgICAgbGV0IG5leHQgPSB0YXJnZXQuY2xvY2suZ2V0KGlkeC5jb3JlLmtleSkKICAgICAgaWYgKG5leHQgPCBpZHgubm9kZXMub2Zmc2V0KSBuZXh0ID0gaWR4Lm5vZGVzLm9mZnNldAoKICAgICAgY29uc3QgbmV4dEluZGV4Tm9kZSA9IGlkeC5nZXQobmV4dCA+PSBpZHguaW5kZXhlZCA/IG5leHQgOiBpZHguaW5kZXhlZCkKCiAgICAgIC8vIG5vIG5vZGUgLSBubyBhY2sKICAgICAgaWYgKCFuZXh0SW5kZXhOb2RlKSBjb250aW51ZQoKICAgICAgLy8gaWYgdGhlIG5leHQgaW5kZXggbm9kZSBkb2VzIG5vdCBzZWUgdGhlIHRhcmdldCwgbm8gYWNrCiAgICAgIGlmICghbmV4dEluZGV4Tm9kZS5jbG9jay5pbmNsdWRlcyh0YXJnZXQud3JpdGVyLmNvcmUua2V5LCB0YXJnZXQubGVuZ3RoKSkgY29udGludWUKCiAgICAgIC8vIGlmIHRoZSBuZXh0IGluZGV4IG5vZGUgaXMgbm90IHN0cmljdGx5IG5ld2VyLCBza2lwIHRvIGF2b2lkIGFtYmlnLi4uCiAgICAgIGlmICghdGhpcy5fc3RyaWN0bHlOZXdlcih0YXJnZXQsIG5leHRJbmRleE5vZGUpKSBjb250aW51ZQoKICAgICAgYWNrcy5wdXNoKG5leHRJbmRleE5vZGUpCiAgICB9CgogICAgcmV0dXJuIGFja3MKICB9CgogIGFja3NGcm9tTm9kZSh0YXJnZXQsIHZpZXcpIHsKICAgIGNvbnN0IGFja3MgPSBuZXcgU2V0KCkKCiAgICBpZiAoIXZpZXcgfHwgIXZpZXcuY2xvY2suaW5jbHVkZXModGFyZ2V0LndyaXRlci5jb3JlLmtleSwgdGFyZ2V0Lmxlbmd0aCkpIHJldHVybiBhY2tzCgogICAgYWNrcy5hZGQodmlldy53cml0ZXIpCgogICAgZm9yIChjb25zdCBpZHggb2YgdGhpcy5pbmRleGVycykgewogICAgICBpZiAoaWR4ID09PSB2aWV3LndyaXRlcikgY29udGludWUKCiAgICAgIGNvbnN0IGxlbmd0aCA9IHZpZXcuY2xvY2suZ2V0KGlkeC5jb3JlLmtleSkKICAgICAgaWYgKCFsZW5ndGgpIGNvbnRpbnVlCgogICAgICBpZiAodGFyZ2V0LmNsb2NrLmluY2x1ZGVzKGlkeC5jb3JlLmtleSwgbGVuZ3RoKSkgY29udGludWUKCiAgICAgIGNvbnN0IGhlYWQgPSBpZHguZ2V0KGxlbmd0aCAtIDEpCiAgICAgIGlmICghaGVhZCkgY29udGludWUKCiAgICAgIGlmIChoZWFkLmNsb2NrLmluY2x1ZGVzKHRhcmdldC53cml0ZXIuY29yZS5rZXksIHRhcmdldC5sZW5ndGgpKSB7CiAgICAgICAgYWNrcy5hZGQoaWR4KQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGFja3MKICB9CgogIF9hY2tlZEF0KGFja3MsIHBhcmVudCkgewogICAgbGV0IHNlZW4gPSAwCiAgICBsZXQgbWlzc2luZyA9IGFja3MubGVuZ3RoCgogICAgZm9yIChjb25zdCBub2RlIG9mIGFja3MpIHsKICAgICAgbWlzc2luZy0tCgogICAgICBpZiAoIXBhcmVudC5jbG9jay5pbmNsdWRlcyhub2RlLndyaXRlci5jb3JlLmtleSwgbm9kZS5sZW5ndGgpKSB7CiAgICAgICAgaWYgKHNlZW4gKyBtaXNzaW5nIDwgdGhpcy5tYWpvcml0eSkgcmV0dXJuIGZhbHNlCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgaWYgKCsrc2VlbiA+PSB0aGlzLm1ham9yaXR5KSByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgY29uZmlybXMoaW5kZXhlciwgdGFyZ2V0LCBhY2tzLCBsZW5ndGgpIHsKICAgIGlmICghbGVuZ3RoIHx8IHRoaXMucmVtb3ZlZC5nZXQoaW5kZXhlci5jb3JlLmtleSkgPj0gbGVuZ3RoKSByZXR1cm4gVU5TRUVOCiAgICAvLyBkZWYgZmVlbHMgbGlrZSB0aGVyZSBpcyBhIHNtYXJ0ZXIgd2F5IG9mIGRvaW5nIHRoaXMgcGFydAogICAgLy8gaWUgd2UganVzdCB3YW5uYSBmaW5kIGEgbm9kZSBmcm9tIHRoZSBpbmRleGVyIHRoYXQgaXMgc3RyaWN0bHkgbmV3ZXIgdGhhbiB0YXJnZXQKICAgIC8vIGFuZCBzZWVucyBhIG1haiBvZiB0aGUgYWNrcyAtIHRoYXRzIGl0CgogICAgbGV0IGp1bXAgPSB0cnVlCiAgICBsZXQgbmV3ZXIgPSB0cnVlCgogICAgZm9yIChsZXQgaSA9IGxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IGhlYWQgPSBpbmRleGVyLmdldChpKQogICAgICBpZiAoaGVhZCA9PT0gbnVsbCkgcmV0dXJuIFVOU0VFTgoKICAgICAgbGV0IHNlZW4gPSAwCgogICAgICBmb3IgKGNvbnN0IG5vZGUgb2YgYWNrcykgewogICAgICAgIC8vIGlmIChub2RlLndyaXRlciA9PT0gaW5kZXhlcikgY29udGludWUKICAgICAgICBpZiAoIWhlYWQuY2xvY2suaW5jbHVkZXMobm9kZS53cml0ZXIuY29yZS5rZXksIG5vZGUubGVuZ3RoKSkgY29udGludWUKICAgICAgICBpZiAoKytzZWVuID49IHRoaXMubWFqb3JpdHkpIGJyZWFrCiAgICAgIH0KCiAgICAgIGlmICghbmV3ZXIgJiYgc2VlbiA8IHRoaXMubWFqb3JpdHkpIHsKICAgICAgICBicmVhawogICAgICB9CgogICAgICBpZiAoIXRoaXMuX3N0cmljdGx5TmV3ZXIodGFyZ2V0LCBoZWFkKSkgewogICAgICAgIC8vIGFsbCBzdHJpY3RseSBuZXdlciBub2RlcyBhcmUgY2x1c3RlcmVkIHRvZ2V0aGVyIHNvIGJpc2VjdCB1bnRpbCB3ZSBmaW5kIHRoZSBjbHVzdGVyCiAgICAgICAgaWYgKGp1bXApIHsKICAgICAgICAgIGp1bXAgPSBmYWxzZQoKICAgICAgICAgIGxldCB0ID0gbGVuZ3RoIC0gMQogICAgICAgICAgbGV0IGIgPSAwCgogICAgICAgICAgd2hpbGUgKHQgPiBiKSB7CiAgICAgICAgICAgIGNvbnN0IG1pZCA9ICh0ICsgYikgPj4+IDEKICAgICAgICAgICAgY29uc3Qgbm9kZSA9IGluZGV4ZXIuZ2V0KG1pZCkKCiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICBub2RlID09PSBudWxsIHx8CiAgICAgICAgICAgICAgIW5vZGUuY2xvY2suaW5jbHVkZXModGFyZ2V0LndyaXRlci5jb3JlLmtleSwgdGFyZ2V0Lmxlbmd0aCkgfHwKICAgICAgICAgICAgICB0aGlzLl9zdHJpY3RseU5ld2VyKHRhcmdldCwgbm9kZSkKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgYiA9IG1pZCArIDEKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0ID0gbWlkIC0gMQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gKyAyIGluIGNhc2Ugd2UgYXJlIG9mZiBieSBvbmUgYW5kIHRoZSBpLS0uIGl0cyBmaW5lLCBqdXN0IGFuIG9wdGltaXNhdGlvbgogICAgICAgICAgaWYgKGIgKyAxIDwgaSkgaSA9IGIgKyAyCiAgICAgICAgfQoKICAgICAgICBuZXdlciA9IGZhbHNlCiAgICAgICAgY29udGludWUKICAgICAgfSBlbHNlIGlmIChzZWVuIDwgdGhpcy5tYWpvcml0eSkgewogICAgICAgIHJldHVybiBORVdFUgogICAgICB9CgogICAgICByZXR1cm4gQUNLRUQKICAgIH0KCiAgICByZXR1cm4gVU5TRUVOCiAgfQoKICBfaXNDb25maXJtZWQodGFyZ2V0LCBwYXJlbnQgPSBudWxsKSB7CiAgICBjb25zdCBhY2tzID0gdGhpcy5fYWNrcyh0YXJnZXQpCiAgICBjb25zdCBjb25mcyA9IG5ldyBTZXQoKQoKICAgIGlmIChhY2tzLmxlbmd0aCA8IHRoaXMubWFqb3JpdHkpIHJldHVybiBmYWxzZQogICAgbGV0IGFsbE5ld2VyID0gdHJ1ZQoKICAgIGZvciAoY29uc3QgaW5kZXhlciBvZiB0aGlzLmluZGV4ZXJzKSB7CiAgICAgIGNvbnN0IGxlbmd0aCA9IHBhcmVudAogICAgICAgID8gcGFyZW50LndyaXRlciA9PT0gaW5kZXhlcgogICAgICAgICAgPyBwYXJlbnQubGVuZ3RoIC0gMQogICAgICAgICAgOiBwYXJlbnQuY2xvY2suZ2V0KGluZGV4ZXIuY29yZS5rZXkpCiAgICAgICAgOiBpbmRleGVyLmxlbmd0aAoKICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5jb25maXJtcyhpbmRleGVyLCB0YXJnZXQsIGFja3MsIGxlbmd0aCkKCiAgICAgIGlmIChyZXN1bHQgPT09IEFDS0VEKSB7CiAgICAgICAgY29uZnMuYWRkKGluZGV4ZXIpCiAgICAgICAgaWYgKGNvbmZzLnNpemUgPj0gdGhpcy5tYWpvcml0eSkgewogICAgICAgICAgcmV0dXJuIHRydWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChyZXN1bHQgPT09IFVOU0VFTikgYWxsTmV3ZXIgPSBmYWxzZQogICAgfQoKICAgIGlmIChwYXJlbnQpIHJldHVybiB0aGlzLl9pc0NvbmZpcm1hYmxlQXQodGFyZ2V0LCBwYXJlbnQsIGFja3MsIGNvbmZzKQoKICAgIHJldHVybiBhbGxOZXdlcgogIH0KCiAgX2lzQ29uZmlybWFibGVBdCh0YXJnZXQsIHBhcmVudCwgYWNrcywgY29uZnMpIHsKICAgIGlmICghdGhpcy5fYWNrZWRBdChhY2tzLCBwYXJlbnQpKSByZXR1cm4gZmFsc2UKCiAgICBsZXQgcG90ZW50aWFsID0gY29uZnMuc2l6ZQoKICAgIGZvciAoY29uc3QgaW5kZXhlciBvZiB0aGlzLmluZGV4ZXJzKSB7CiAgICAgIGlmIChjb25mcy5oYXMoaW5kZXhlcikpIGNvbnRpbnVlCgogICAgICBjb25zdCBsZW5ndGggPSBwYXJlbnQuY2xvY2suZ2V0KGluZGV4ZXIuY29yZS5rZXkpCiAgICAgIGNvbnN0IGlzU2VlbiA9IHRhcmdldC5jbG9jay5pbmNsdWRlcyhpbmRleGVyLmNvcmUua2V5LCBsZW5ndGgpCgogICAgICAvLyBpZiB0aGUgdGFyZ2V0IGhhcyBzZWVuIHRoZSBsYXRlc3Qgbm9kZSwgaXQgY2FuIGZyZWVseSBiZSB1c2VkIHRvIGNvbmZpcm0gdGhlIHRhcmdldCBsYXRlcgogICAgICAvLyBvdGhlcndpc2UsIGNoZWNrIGlmIGEgbmV3ZXIgbm9kZSBpcyBzdHJpY3RseSBuZXdlci4uLgogICAgICBpZiAoIWlzU2VlbikgewogICAgICAgIGNvbnN0IGhlYWQgPSBpbmRleGVyLmdldChsZW5ndGggLSAxKQoKICAgICAgICAvLyB0aGUgbmV4dCBpbmRleGVyIGhlYWQgSEFTIHRvIGJlIHN0cmljdGx5IG5ld2VyIC0gbWVhbmluZyB0aGUgY3VycmVudCBvbmUgaGFzIHRvIGJlIGFsc28uCiAgICAgICAgaWYgKAogICAgICAgICAgaGVhZCAmJgogICAgICAgICAgIXRoaXMucmVtb3ZlZC5pbmNsdWRlcyhoZWFkLndyaXRlci5jb3JlLmtleSwgaGVhZC5sZW5ndGgpICYmCiAgICAgICAgICAhdGhpcy5fc3RyaWN0bHlOZXdlcih0YXJnZXQsIGhlYWQpCiAgICAgICAgKSB7CiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCsrcG90ZW50aWFsID49IHRoaXMubWFqb3JpdHkpIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICAvLyB0aGlzIGNhbiBnZXQgY2FsbGVkIG11bHRpcGxlIHRpbWVzIGZvciBzYW1lIG5vZGUKICByZW1vdmUobm9kZSkgewogICAgdGhpcy5tZXJnZXMuZGVsZXRlKG5vZGUpCiAgICB0aGlzLnJlbW92ZWQuc2V0KG5vZGUud3JpdGVyLmNvcmUua2V5LCBub2RlLmxlbmd0aCkKICAgIHJldHVybiBub2RlCiAgfQoKICBzaGlmdCgpIHsKICAgIGlmICghdGhpcy51cGRhdGVkKSByZXR1cm4gW10KCiAgICBjb25zdCB0YWlscyA9IHRoaXMuX2luZGV4ZXJUYWlscygpCgogICAgZm9yIChjb25zdCB0YWlsIG9mIHRhaWxzKSB7CiAgICAgIGlmICh0aGlzLl9pc0NvbmZpcm1lZCh0YWlsKSkgewogICAgICAgIHJldHVybiBbdGhpcy5yZW1vdmUodGFpbCldCiAgICAgIH0KICAgIH0KCiAgICBmb3IgKGNvbnN0IG1lcmdlIG9mIHRoaXMubWVyZ2VzKSB7CiAgICAgIGlmICh0aGlzLl9pc0NvbmZpcm1lZChtZXJnZSkpIHsKICAgICAgICByZXR1cm4gdGhpcy5feWllbGROZXh0KG1lcmdlLCB0YWlscykKICAgICAgfQogICAgfQoKICAgIHRoaXMudXBkYXRlZCA9IGZhbHNlCiAgICByZXR1cm4gW10KICB9CgogIC8vIHlpZWxkcyBuZXh0IGluZGV4ZXIgbm9kZQogIF95aWVsZE5leHQobm9kZSwgdGFpbHMpIHsKICAgIC8vIG9ubHkgc3RvcCB3aGVuIHdlIGZpbmQgYSB0YWlsCiAgICB3aGlsZSAoIXRhaWxzLmhhcyhub2RlKSkgewogICAgICBsZXQgbmV4dCA9IG51bGwKCiAgICAgIC8vIGZvciBtZXJnZXMgY2hlY2sgaWYgb25lIGZvcmsgaXMgY29uZmlybWVkCiAgICAgIGZvciAoY29uc3QgdCBvZiB0aGlzLl90YWlsc0FuZE1lcmdlcyhub2RlLCB0YWlscykpIHsKICAgICAgICBpZiAodGhpcy5faXNDb25maXJtZWQodCwgbm9kZSkpIHsKICAgICAgICAgIG5leHQgPSB0CiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKG5leHQpIHsKICAgICAgICBub2RlID0gbmV4dAogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIC8vIG90aGVyd2lzZSB5aWVsZCBhbGwgdGFpbHMKICAgICAgY29uc3QgdGFpbFNldCA9IFtdCiAgICAgIGZvciAoY29uc3QgdCBvZiB0aGlzLl90YWlscyhub2RlLCB0YWlscykpIHsKICAgICAgICB0YWlsU2V0LnB1c2godGhpcy5yZW1vdmUodCkpCiAgICAgIH0KCiAgICAgIHJldHVybiB0YWlsU2V0CiAgICB9CgogICAgcmV0dXJuIFt0aGlzLnJlbW92ZShub2RlKV0KICB9CgogIHNob3VsZEFjayh3cml0ZXIpIHsKICAgIGZvciAoY29uc3QgdCBvZiB0aGlzLl9pbmRleGVyVGFpbHMoKSkgewogICAgICBpZiAodC53cml0ZXIgPT09IHdyaXRlcikgY29udGludWUKICAgICAgaWYgKHRoaXMuX3Nob3VsZEFja05vZGUodCwgd3JpdGVyKSkgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF9zaG91bGRBY2tOb2RlKHRhcmdldCwgd3JpdGVyKSB7CiAgICBjb25zdCBoZWFkID0gd3JpdGVyLmhlYWQoKQogICAgY29uc3QgbmV4dCA9IHRhcmdldC5jbG9jay5nZXQod3JpdGVyLmNvcmUua2V5KQogICAgY29uc3QgbmV4dEluZGV4Tm9kZSA9IHdyaXRlci5nZXQobmV4dCA+PSB3cml0ZXIuaW5kZXhlZCA/IG5leHQgOiB3cml0ZXIuaW5kZXhlZCkKCiAgICAvLyBpZiB3ZSBoYXZlIG5vIG5leHQgbm9kZSBhbmQgd2UgZGlkbid0IHdyaXRlIHRhcmdldCB0aGVuIGFjawogICAgaWYgKCFuZXh0SW5kZXhOb2RlICYmIHdyaXRlciAhPT0gdGFyZ2V0LndyaXRlcikgcmV0dXJuIHRydWUKCiAgICAvLyBzaG9ydGN1dHMgaWYgd2UgaGF2ZSBuZXh0IG5vZGUKICAgIGlmIChuZXh0SW5kZXhOb2RlKSB7CiAgICAgIC8vIGlmIHRoZSBuZXh0IG5vZGUgZG9lcyBub3Qgc2VlIHRoZSB0YXJnZXQsIHNob3VsZCBhY2sKICAgICAgaWYgKCFuZXh0SW5kZXhOb2RlLmNsb2NrLmluY2x1ZGVzKHRhcmdldC53cml0ZXIuY29yZS5rZXksIHRhcmdldC5sZW5ndGgpKSB7CiAgICAgICAgcmV0dXJuICFoZWFkLmNsb2NrLmluY2x1ZGVzKHRhcmdldC53cml0ZXIuY29yZS5rZXksIHRhcmdldC5sZW5ndGgpCiAgICAgIH0KCiAgICAgIC8vIGlmIHRoZSBuZXh0IG5vZGUgaXMgbm90IHN0cmljdGx5IG5ld2VyLCBubyBwb2ludCBhY2tpbmcKICAgICAgaWYgKCF0aGlzLl9zdHJpY3RseU5ld2VyKHRhcmdldCwgbmV4dEluZGV4Tm9kZSkpIHJldHVybiBmYWxzZQogICAgfQoKICAgIC8vIG5vdyBjaGVjayBpZiB3ZSBjYW4gZG91YmxlIGNvbmZpcm0KICAgIGNvbnN0IGFja3MgPSB0aGlzLl9hY2tzKHRhcmdldCkKCiAgICAvLyBuZWVkIGVub3VnaCB0byBkb3VibGUgY29uZmlybQogICAgaWYgKGFja3MubGVuZ3RoID49IHRoaXMubWFqb3JpdHkpIHsKICAgICAgcmV0dXJuIHRoaXMuY29uZmlybXMod3JpdGVyLCB0YXJnZXQsIGFja3MsIHdyaXRlci5sZW5ndGgpID09PSBVTlNFRU4KICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9Cn0KY29uc3QgSHlwZXJjb3JlRW5jcnlwdGlvbiA9IHJlcXVpcmUoJ2h5cGVyY29yZS9saWIvZGVmYXVsdC1lbmNyeXB0aW9uLmpzJykKY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHJycCA9IHJlcXVpcmUoJ3Jlc29sdmUtcmVqZWN0LXByb21pc2UnKQpjb25zdCBSZWFkeVJlc291cmNlID0gcmVxdWlyZSgncmVhZHktcmVzb3VyY2UnKQoKY29uc3QgU3lzdGVtVmlldyA9IHJlcXVpcmUoJy4vc3lzdGVtLmpzJykKY29uc3QgeyBFbmNyeXB0aW9uRGVzY3JpcHRvciwgTWFuaWZlc3REYXRhIH0gPSByZXF1aXJlKCcuL21lc3NhZ2VzLmpzJykKY29uc3QgeyBOU19WSUVXX0JMT0NLX0tFWSwgTlNfSEFTSF9LRVksIE5TX0VOQ1JZUFRJT04gfSA9IHJlcXVpcmUoJy4vY2Fwcy5qcycpCgpjb25zdCBub25jZSA9IGI0YS5hbGxvYyhzb2RpdW0uY3J5cHRvX3N0cmVhbV9OT05DRUJZVEVTKQpjb25zdCBoYXNoID0gbm9uY2Uuc3ViYXJyYXkoMCwgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9CWVRFU19NSU4pCgpjbGFzcyBBdXRvYmFzZUVuY3J5cHRpb24gewogIHN0YXRpYyBQQURESU5HID0gOAoKICBjb25zdHJ1Y3RvcihlbmNyeXB0aW9uKSB7CiAgICB0aGlzLmVuY3J5cHRpb24gPSBlbmNyeXB0aW9uCgogICAgdGhpcy5jb21wYXQgPSBudWxsCiAgICB0aGlzLmtleXMgPSBudWxsCiAgICB0aGlzLmtleXNCeUlkID0gbmV3IE1hcCgpCiAgfQoKICBnZXQgaWQoKSB7CiAgICByZXR1cm4gdGhpcy5rZXlzID8gdGhpcy5rZXlzLmlkIDogMAogIH0KCiAgcGFkZGluZygpIHsKICAgIHJldHVybiBBdXRvYmFzZUVuY3J5cHRpb24uUEFERElORwogIH0KCiAgaXNDb21wYXQoKSB7CiAgICByZXR1cm4gZmFsc2UKICB9CgogIGxvYWQoa2V5cykgewogICAgaWYgKHRoaXMua2V5cyA9PT0gbnVsbCkgdGhpcy5rZXlzID0ga2V5cwogIH0KCiAgYXN5bmMgdXBkYXRlKGN0eCkgewogICAgaWYgKHRoaXMuaWQgIT09IDAgJiYgdGhpcy5pZCA9PT0gdGhpcy5lbmNyeXB0aW9uLmlkKSByZXR1cm4KICAgIGNvbnN0IGtleXMgPSBhd2FpdCB0aGlzLmdldCh0aGlzLmVuY3J5cHRpb24uaWQsIGN0eCkKICAgIGlmIChrZXlzKSB0aGlzLmtleXMgPSBrZXlzCiAgfQoKICBhc3luYyBnZXQoaWQsIGN0eCkgewogICAgaWYgKHRoaXMua2V5c0J5SWQuaGFzKGlkKSkgcmV0dXJuIHRoaXMua2V5c0J5SWQuZ2V0KGlkKQoKICAgIGNvbnN0IGtleXMgPSBhd2FpdCB0aGlzLmdldEtleXMoaWQsIGN0eCkKICAgIHRoaXMua2V5c0J5SWQuc2V0KGlkLCBrZXlzKQoKICAgIHJldHVybiBrZXlzCiAgfQoKICBhc3luYyBnZXRLZXlzKGlkLCBjdHgpIHsKICAgIGNvbnN0IGVudHJvcHkgPSBhd2FpdCB0aGlzLmVuY3J5cHRpb24uZ2V0KGlkKQogICAgaWYgKCFlbnRyb3B5KSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IGJsb2NrID0gdGhpcy5ibG9ja0tleShlbnRyb3B5LCBjdHgpCiAgICBjb25zdCBoYXNoID0gY3J5cHRvLmhhc2goW05TX0hBU0hfS0VZLCBibG9ja10pCgogICAgcmV0dXJuIHsKICAgICAgaWQsCiAgICAgIGJsb2NrLAogICAgICBoYXNoCiAgICB9CiAgfQoKICBibG9ja0tleShlbnRyb3B5LCBjdHgpIHsKICAgIHJldHVybiB0aGlzLmVuY3J5cHRpb24uYmxvY2tLZXkoZW50cm9weSwgY3R4KQogIH0KCiAgYXN5bmMgX2Vuc3VyZUNvbXBhdChjdHgpIHsKICAgIGlmICghdGhpcy5jb21wYXQpIHRoaXMuY29tcGF0ID0gdGhpcy5jb21wYXRLZXlzKGN0eCkKICB9CgogIGNvbXBhdEtleXMoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvbXBhdGFiaWxpdHkgbWV0aG9kIGlzIG5vdCBzcGVjaWZpZWQnKQogIH0KCiAgYXN5bmMgZW5jcnlwdChpbmRleCwgYmxvY2ssIGZvcmssIGN0eCkgewogICAgaWYgKHRoaXMuaXNDb21wYXQoY3R4LCBpbmRleCkpIHsKICAgICAgdGhpcy5fZW5zdXJlQ29tcGF0KGN0eCkKICAgICAgcmV0dXJuIEh5cGVyY29yZUVuY3J5cHRpb24uZW5jcnlwdCgKICAgICAgICBpbmRleCwKICAgICAgICBibG9jaywKICAgICAgICBmb3JrLAogICAgICAgIHRoaXMuY29tcGF0LmJsb2NrLAogICAgICAgIHRoaXMuY29tcGF0LmJsaW5kaW5nCiAgICAgICkKICAgIH0KCiAgICBhd2FpdCB0aGlzLnVwZGF0ZShjdHgpCgogICAgZW5jcnlwdEJsb2NrKGluZGV4LCBibG9jaywgdGhpcy5rZXlzLmlkLCB0aGlzLmtleXMuYmxvY2ssIHRoaXMua2V5cy5oYXNoKQogIH0KCiAgYXN5bmMgZGVjcnlwdChpbmRleCwgYmxvY2ssIGN0eCkgewogICAgaWYgKHRoaXMuaXNDb21wYXQoY3R4LCBpbmRleCkpIHsKICAgICAgdGhpcy5fZW5zdXJlQ29tcGF0KGN0eCkKICAgICAgcmV0dXJuIEh5cGVyY29yZUVuY3J5cHRpb24uZGVjcnlwdChpbmRleCwgYmxvY2ssIHRoaXMuY29tcGF0LmJsb2NrKQogICAgfQoKICAgIGNvbnN0IHBhZGRpbmcgPSBibG9jay5zdWJhcnJheSgwLCBBdXRvYmFzZUVuY3J5cHRpb24uUEFERElORykKICAgIGJsb2NrID0gYmxvY2suc3ViYXJyYXkoQXV0b2Jhc2VFbmNyeXB0aW9uLlBBRERJTkcpCgogICAgY29uc3QgdHlwZSA9IHBhZGRpbmdbMF0KICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuIGJsb2NrIC8vIHVuZW5jcnlwdGVkCgogICAgICBjYXNlIDE6CiAgICAgICAgYnJlYWsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnJlY29nbmlzZWQgZW5jcnlwdGlvbiB0eXBlJykKICAgIH0KCiAgICBjb25zdCBpZCA9IGMudWludDMyLmRlY29kZSh7IHN0YXJ0OiA0LCBlbmQ6IDgsIGJ1ZmZlcjogcGFkZGluZyB9KQoKICAgIGNvbnN0IGtleXMgPSBhd2FpdCB0aGlzLmdldChpZCwgY3R4KQoKICAgIGMudWludDY0LmVuY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IDgsIGJ1ZmZlcjogbm9uY2UgfSwgaW5kZXgpCiAgICBub25jZS5zZXQocGFkZGluZywgOCwgMTYpCgogICAgLy8gRGVjcnlwdCB0aGUgYmxvY2sgdXNpbmcgdGhlIGZ1bGwgbm9uY2UKICAgIGRlY3J5cHQoYmxvY2ssIG5vbmNlLCBrZXlzLmJsb2NrKQogIH0KfQoKY2xhc3MgVmlld0VuY3J5cHRpb24gZXh0ZW5kcyBBdXRvYmFzZUVuY3J5cHRpb24gewogIGNvbnN0cnVjdG9yKGVuY3J5cHRpb24sIG5hbWUpIHsKICAgIHN1cGVyKGVuY3J5cHRpb24pCiAgICB0aGlzLm5hbWUgPSBuYW1lCiAgfQoKICBpc0NvbXBhdChjdHgsIGluZGV4KSB7CiAgICBpZiAoY3R4Lm1hbmlmZXN0LnZlcnNpb24gPD0gMSkgcmV0dXJuIHRydWUKICAgIGlmICghY3R4Lm1hbmlmZXN0LnVzZXJEYXRhKSByZXR1cm4gZmFsc2UKICAgIGNvbnN0IHsgbGVnYWN5QmxvY2tzIH0gPSBjLmRlY29kZShNYW5pZmVzdERhdGEsIGN0eC5tYW5pZmVzdC51c2VyRGF0YSkKICAgIHJldHVybiBpbmRleCA8IGxlZ2FjeUJsb2NrcwogIH0KCiAgY29tcGF0S2V5cygpIHsKICAgIGNvbnN0IHsgYm9vdHN0cmFwLCBlbmNyeXB0aW9uS2V5IH0gPSB0aGlzLmVuY3J5cHRpb24uYmFzZQogICAgY29uc3QgYmxvY2sgPSBnZXRDb21wYXRCbG9ja0tleShib290c3RyYXAsIGVuY3J5cHRpb25LZXksIHRoaXMubmFtZSkKICAgIHJldHVybiB7CiAgICAgIGJsb2NrLAogICAgICBibGluZGluZzogY3J5cHRvLmhhc2goYmxvY2spCiAgICB9CiAgfQoKICBibG9ja0tleShlbnRyb3B5KSB7CiAgICByZXR1cm4gZ2V0Q29tcGF0QmxvY2tLZXkodGhpcy5lbmNyeXB0aW9uLmJhc2UuYm9vdHN0cmFwLCBlbnRyb3B5LCB0aGlzLm5hbWUpCiAgfQp9CgpjbGFzcyBXcml0ZXJFbmNyeXB0aW9uIGV4dGVuZHMgQXV0b2Jhc2VFbmNyeXB0aW9uIHsKICBpc0NvbXBhdChjdHgpIHsKICAgIHJldHVybiBjdHgubWFuaWZlc3QudmVyc2lvbiA8PSAxCiAgfQoKICBjb21wYXRLZXlzKGN0eCkgewogICAgcmV0dXJuIEh5cGVyY29yZUVuY3J5cHRpb24uZGVyaXZlS2V5cyh0aGlzLmVuY3J5cHRpb24uYmFzZS5lbmNyeXB0aW9uS2V5LCBjdHgua2V5KQogIH0KCiAgYmxvY2tLZXkoZW50cm9weSwgY3R4KSB7CiAgICBpZiAoY3R4Lm1hbmlmZXN0LnVzZXJEYXRhKSB7CiAgICAgIGNvbnN0IHVzZXJEYXRhID0gYy5kZWNvZGUoTWFuaWZlc3REYXRhLCBjdHgubWFuaWZlc3QudXNlckRhdGEpCiAgICAgIGlmICh1c2VyRGF0YS5uYW1lc3BhY2UgIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbmNyeXB0aW9uLmJsb2NrS2V5KGVudHJvcHksIHsga2V5OiB1c2VyRGF0YS5uYW1lc3BhY2UgfSkKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzLmVuY3J5cHRpb24uYmxvY2tLZXkoZW50cm9weSwgY3R4KQogIH0KfQoKY2xhc3MgRW5jcnlwdGlvblZpZXcgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvcihiYXNlLCBjb3JlKSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5iYXNlID0gYmFzZQogICAgdGhpcy5jb3JlID0gY29yZSB8fCBudWxsCgogICAgdGhpcy5zZXNzaW9ucyA9IG5ldyBNYXAoKQoKICAgIHRoaXMuX2luaXRpYWxpc2luZyA9IG51bGwKICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgYXdhaXQgdGhpcy5pbml0aWFsaXNlZCgpCiAgICBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQogIH0KCiAgaW5pdGlhbGlzZWQoKSB7CiAgICBpZiAodGhpcy5jb3JlICE9PSBudWxsKSByZXR1cm4gdGhpcy5jb3JlLnJlYWR5KCkKICAgIGlmICh0aGlzLl9pbml0aWFsaXNpbmcpIHJldHVybiB0aGlzLl9pbml0aWFsaXNpbmcKCiAgICB0aGlzLl9pbml0aWFsaXNpbmcgPSBycnAoKQoKICAgIHJldHVybiB0aGlzLl9pbml0aWFsaXNpbmcucHJvbWlzZQogIH0KCiAgX2Nsb3NlKCkgewogICAgaWYgKHRoaXMuX2luaXRpYWxpc2luZykgewogICAgICB0aGlzLl9pbml0aWFsaXNpbmcucmVqZWN0KG5ldyBFcnJvcignRW5jcnlwdGlvbiBjbG9zZWQnKSkKICAgICAgdGhpcy5faW5pdGlhbGlzaW5nID0gbnVsbAogICAgfQoKICAgIGlmICh0aGlzLmNvcmUpIHJldHVybiB0aGlzLmNvcmUuY2xvc2UoKQogIH0KCiAgZ2V0IGJvb3RzdHJhcHBlZCgpIHsKICAgIHJldHVybiAhISh0aGlzLmNvcmUgJiYgdGhpcy5jb3JlLmxlbmd0aCA+IDApCiAgfQoKICBnZXQgaWQoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlID8gdGhpcy5jb3JlLmxlbmd0aCA6IDAKICB9CgogIF9jcmVhdGVQYXlsb2FkKGtleSkgewogICAgcmV0dXJuIGtleQogIH0KCiAgYXN5bmMgcmVsb2FkKGNvcmUpIHsKICAgIGlmICh0aGlzLmNvcmUpIGF3YWl0IHRoaXMuY29yZS5jbG9zZSgpCgogICAgdGhpcy5jb3JlID0gY29yZQogICAgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKCiAgICBpZiAodGhpcy5faW5pdGlhbGlzaW5nKSB7CiAgICAgIHRoaXMuX2luaXRpYWxpc2luZy5yZXNvbHZlKCkKICAgICAgdGhpcy5faW5pdGlhbGlzaW5nID0gbnVsbAogICAgfQogIH0KCiAgdW5wYWNrKHR5cGUsIHBheWxvYWQpIHsKICAgIGlmICh0eXBlID4gMCkgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uJykKICAgIHJldHVybiBwYXlsb2FkCiAgfQoKICBhc3luYyB1cGRhdGUoa2V5KSB7CiAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgdGhpcy5fY3JlYXRlUGF5bG9hZChrZXkpCiAgICBjb25zdCBkZXNjID0geyB0eXBlOiAwLCBwYXlsb2FkIH0KCiAgICBhd2FpdCB0aGlzLmNvcmUuYXBwZW5kKGMuZW5jb2RlKEVuY3J5cHRpb25EZXNjcmlwdG9yLCBkZXNjKSkKICB9CgogIGFzeW5jIF9wcmVsb2FkKCkgewogICAgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICByZXR1cm4gdGhpcy5pZCgpCiAgfQoKICBnZXRWaWV3RW5jcnlwdGlvbihuYW1lKSB7CiAgICBpZiAodGhpcy5zZXNzaW9ucy5oYXMobmFtZSkpIHJldHVybiB0aGlzLnNlc3Npb25zLmdldChuYW1lKQoKICAgIGNvbnN0IGVuY3J5cHRpb24gPSBuZXcgVmlld0VuY3J5cHRpb24odGhpcywgbmFtZSkKICAgIHRoaXMuc2Vzc2lvbnMuc2V0KG5hbWUsIGVuY3J5cHRpb24pCgogICAgcmV0dXJuIGVuY3J5cHRpb24KICB9CgogIGdldFdyaXRlckVuY3J5cHRpb24oKSB7CiAgICByZXR1cm4gbmV3IFdyaXRlckVuY3J5cHRpb24odGhpcykKICB9CgogIGFzeW5jIGVuY3J5cHRBbmNob3IoYmxvY2ssIG5hbWVzcGFjZSkgewogICAgY29uc3QgZW50cm9weSA9IGF3YWl0IHRoaXMuZ2V0KHRoaXMuaWQpCiAgICBpZiAoIWVudHJvcHkpIHJldHVybiBudWxsCgogICAgY29uc3QgYmxvY2tLZXkgPSB0aGlzLmJsb2NrS2V5KGVudHJvcHksIHsga2V5OiBuYW1lc3BhY2UgfSkKICAgIGNvbnN0IGhhc2hLZXkgPSBjcnlwdG8uaGFzaChbTlNfSEFTSF9LRVksIGJsb2NrXSkKCiAgICBlbmNyeXB0QmxvY2soMCwgYmxvY2ssIHRoaXMuaWQsIGJsb2NrS2V5LCBoYXNoS2V5KQogIH0KCiAgYmxvY2tLZXkoZW50cm9weSwgY3R4KSB7CiAgICByZXR1cm4gZ2V0QmxvY2tLZXkodGhpcy5iYXNlLmJvb3RzdHJhcCwgdGhpcy5iYXNlLmVuY3J5cHRpb25LZXksIGVudHJvcHksIGN0eC5rZXkpCiAgfQoKICBhc3luYyBnZXQoZW5jcnlwdGlvbklkKSB7CiAgICBpZiAoZW5jcnlwdGlvbklkID09PSAwKSByZXR1cm4gU3lzdGVtVmlldy5HRU5FU0lTX0VOVFJPUFkKCiAgICBpZiAoIXRoaXMuY29yZSkgYXdhaXQgdGhpcy5pbml0aWFsaXNlZCgpCgogICAgY29uc3QgaW5kZXggPSBlbmNyeXB0aW9uSWQgLSAxCiAgICBjb25zdCBkZXNjID0gYXdhaXQgdGhpcy5jb3JlLmdldChpbmRleCkKICAgIGNvbnN0IHsgdHlwZSwgcGF5bG9hZCB9ID0gYy5kZWNvZGUoRW5jcnlwdGlvbkRlc2NyaXB0b3IsIGRlc2MpCgogICAgY29uc3Qga2V5ID0gdGhpcy51bnBhY2sodHlwZSwgcGF5bG9hZCkKICAgIHJldHVybiBrZXkKICB9CgogIGdldFN5c3RlbUVuY3J5cHRpb24oKSB7CiAgICByZXR1cm4gdGhpcy5nZXRWaWV3RW5jcnlwdGlvbignX3N5c3RlbScpCiAgfQoKICBzdGF0aWMgbmFtZXNwYWNlKGVudHJvcHkpIHsKICAgIHJldHVybiBjcnlwdG8uaGFzaChbTlNfRU5DUllQVElPTiwgZW50cm9weV0pCiAgfQoKICBzdGF0aWMgZ2V0QmxvY2tLZXkoYm9vdHN0cmFwLCBlbmNyeXB0aW9uS2V5LCBlbnRyb3B5LCBoeXBlcmNvcmVLZXkpIHsKICAgIHJldHVybiBnZXRCbG9ja0tleShib290c3RyYXAsIGVuY3J5cHRpb25LZXksIGVudHJvcHksIGh5cGVyY29yZUtleSkKICB9CgogIHN0YXRpYyBnZXRTeXN0ZW1FbmNyeXB0aW9uKGJhc2UsIGNvcmUpIHsKICAgIGNvbnN0IHZpZXcgPSBuZXcgRW5jcnlwdGlvblZpZXcoYmFzZSwgY29yZSkKICAgIHJldHVybiB2aWV3LmdldFN5c3RlbUVuY3J5cHRpb24oKQogIH0KCiAgc3RhdGljIGFzeW5jIHNldFN5c3RlbUVuY3J5cHRpb24oYmFzZSwgY29yZSwgb3B0cykgewogICAgaWYgKGJhc2UuZW5jcnlwdGlvbktleSA9PT0gbnVsbCkgcmV0dXJuIG51bGwKCiAgICBhd2FpdCBjb3JlLnJlYWR5KCkKICAgIGlmIChjb3JlLm1hbmlmZXN0LnZlcnNpb24gPT09IDEpIHsKICAgICAgY29uc3Qga2V5ID0gZ2V0Q29tcGF0QmxvY2tLZXkoYmFzZS5ib290c3RyYXAsIGJhc2UuZW5jcnlwdGlvbktleSwgJ19zeXN0ZW0nKQogICAgICByZXR1cm4gY29yZS5zZXRFbmNyeXB0aW9uS2V5KGtleSwgeyBibG9jazogdHJ1ZSB9KQogICAgfQoKICAgIGlmICghY29yZS5tYW5pZmVzdC5saW5rZWQubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignU3lzdGVtIG1hbmlmZXN0IGRvZXMgbm90IGxpbmsgZW5jcnlwdGlvbiB2aWV3JykKICAgIH0KCiAgICBjb25zdCBlbmMgPSBiYXNlLnN0b3JlLmdldCh7IGtleTogY29yZS5tYW5pZmVzdC5saW5rZWRbMF0sIGFjdGl2ZTogZmFsc2UgfSkKICAgIGNvbnN0IGVuY3J5cHRpb24gPSBFbmNyeXB0aW9uVmlldy5nZXRTeXN0ZW1FbmNyeXB0aW9uKGJhc2UsIGVuYykKCiAgICBhd2FpdCBjb3JlLnNldEVuY3J5cHRpb24oZW5jcnlwdGlvbiwgb3B0cykKCiAgICByZXR1cm4gZW5jCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBBdXRvYmFzZUVuY3J5cHRpb24sCiAgRW5jcnlwdGlvblZpZXcKfQoKZnVuY3Rpb24gZW5jcnlwdChibG9jaywgbm9uY2UsIGtleSkgewogIHNvZGl1bS5jcnlwdG9fc3RyZWFtX3hvcihibG9jaywgYmxvY2ssIG5vbmNlLCBrZXkpCn0KCmZ1bmN0aW9uIGRlY3J5cHQoYmxvY2ssIG5vbmNlLCBrZXkpIHsKICByZXR1cm4gZW5jcnlwdChibG9jaywgbm9uY2UsIGtleSkgLy8gc3ltbWV0cmljCn0KCmZ1bmN0aW9uIGdldEJsb2NrS2V5KGJvb3RzdHJhcCwgZW5jcnlwdGlvbktleSwgZW50cm9weSwgaHlwZXJjb3JlS2V5KSB7CiAgcmV0dXJuICgKICAgIGVuY3J5cHRpb25LZXkgJiYKICAgIGNyeXB0by5oYXNoKFtOU19WSUVXX0JMT0NLX0tFWSwgYm9vdHN0cmFwLCBlbmNyeXB0aW9uS2V5LCBlbnRyb3B5LCBoeXBlcmNvcmVLZXldKQogICkKfQoKZnVuY3Rpb24gZ2V0Q29tcGF0QmxvY2tLZXkoYm9vdHN0cmFwLCBlbmNyeXB0aW9uS2V5LCBuYW1lKSB7CiAgaWYgKHR5cGVvZiBuYW1lID09PSAnc3RyaW5nJykgcmV0dXJuIGdldENvbXBhdEJsb2NrS2V5KGJvb3RzdHJhcCwgZW5jcnlwdGlvbktleSwgYjRhLmZyb20obmFtZSkpCiAgcmV0dXJuIGVuY3J5cHRpb25LZXkgJiYgY3J5cHRvLmhhc2goW05TX1ZJRVdfQkxPQ0tfS0VZLCBib290c3RyYXAsIGVuY3J5cHRpb25LZXksIG5hbWVdKQp9CgpmdW5jdGlvbiBibG9ja2hhc2goYmxvY2ssIHBhZGRpbmcsIGhhc2hLZXkpIHsKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGhhc2gsIGJsb2NrLCBoYXNoS2V5KQogIHBhZGRpbmcuc2V0KGhhc2guc3ViYXJyYXkoMCwgOCkpIC8vIGNvcHkgZmlyc3QgOCBieXRlcyBvZiBoYXNoCiAgaGFzaC5maWxsKDApIC8vIGNsZWFyIG5vbmNlIGJ1ZmZlcgp9CgpmdW5jdGlvbiBlbmNyeXB0QmxvY2soaW5kZXgsIGJsb2NrLCBpZCwgYmxvY2tLZXksIGhhc2hLZXkpIHsKICBjb25zdCBwYWRkaW5nID0gYmxvY2suc3ViYXJyYXkoMCwgQXV0b2Jhc2VFbmNyeXB0aW9uLlBBRERJTkcpCiAgYmxvY2sgPSBibG9jay5zdWJhcnJheShBdXRvYmFzZUVuY3J5cHRpb24uUEFERElORykKCiAgYmxvY2toYXNoKGJsb2NrLCBwYWRkaW5nLCBoYXNoS2V5KQogIGMudWludDMyLmVuY29kZSh7IHN0YXJ0OiA0LCBlbmQ6IDgsIGJ1ZmZlcjogcGFkZGluZyB9LCBpZCkKCiAgYy51aW50NjQuZW5jb2RlKHsgc3RhcnQ6IDAsIGVuZDogOCwgYnVmZmVyOiBub25jZSB9LCBpbmRleCkKCiAgcGFkZGluZ1swXSA9IDEgLy8gdmVyc2lvbiBpbiBwbGFpbnRleHQKCiAgbm9uY2Uuc2V0KHBhZGRpbmcsIDgsIDE2KQoKICAvLyBUaGUgY29tYmluYXRpb24gb2YgaW5kZXgsIGtleSBpZCwgZm9yayBpZCBhbmQgYmxvY2sgaGFzaCBpcyB2ZXJ5IGxpa2VseQogIC8vIHRvIGJlIHVuaXF1ZSBmb3IgYSBnaXZlbiBIeXBlcmNvcmUgYW5kIHRoZXJlZm9yZSBvdXIgbm9uY2UgaXMgc3VpdGFibGUKICBlbmNyeXB0KGJsb2NrLCBub25jZSwgYmxvY2tLZXkpCn0KY29uc3QgcnJwID0gcmVxdWlyZSgncmVzb2x2ZS1yZWplY3QtcHJvbWlzZScpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKCmNvbnN0IFN5c3RlbVZpZXcgPSByZXF1aXJlKCcuL3N5c3RlbS5qcycpCmNvbnN0IHsgRW5jcnlwdGlvblZpZXcgfSA9IHJlcXVpcmUoJy4vZW5jcnlwdGlvbi5qcycpCgpjb25zdCBERUZBVUxUX09QX1RJTUVPVVQgPSA1XzAwMApjb25zdCBERUZBVUxUX01JTl9GRiA9IDE2Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEZhc3RGb3J3YXJkIHsKICBjb25zdHJ1Y3RvcigKICAgIGJhc2UsCiAgICBrZXksCiAgICB7CiAgICAgIHRpbWVvdXQgPSBERUZBVUxUX09QX1RJTUVPVVQsCiAgICAgIHZlcmlmaWVkID0gdHJ1ZSwKICAgICAgbWluaW11bSA9IERFRkFVTFRfTUlOX0ZGLAogICAgICBmb3JjZSA9IGZhbHNlLAogICAgICBsZW5ndGggPSAwCiAgICB9ID0ge30KICApIHsKICAgIHRoaXMuYmFzZSA9IGJhc2UKICAgIHRoaXMua2V5ID0ga2V5CiAgICB0aGlzLnRpbWVvdXQgPSB0aW1lb3V0CiAgICB0aGlzLmZvcmNlID0gZm9yY2UKICAgIHRoaXMuY29yZSA9IGJhc2Uuc3RvcmUuZ2V0KHsga2V5LCBhY3RpdmU6IHRydWUsIGVuY3J5cHRpb246IG51bGwgfSkKICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLnZpZXdzID0gW10KICAgIHRoaXMuZW5jcnlwdGlvbiA9IG51bGwKICAgIHRoaXMuZW50cm9weSA9IG51bGwKICAgIHRoaXMuaW5kZXhlcnMgPSBbXQogICAgdGhpcy5taW5pbXVtID0gbWluaW11bQogICAgdGhpcy52ZXJpZmllZCA9IHZlcmlmaWVkCiAgICB0aGlzLndhaXRpbmcgPSBuZXcgU2V0KCkKICAgIHRoaXMuY29yZXMgPSBbdGhpcy5jb3JlXQogICAgdGhpcy5zeXN0ZW0gPSBudWxsCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLnVwZ3JhZGluZyA9IG51bGwKICAgIHRoaXMuZmFpbGVkID0gZmFsc2UKICB9CgogIHN0YXRpYyBNSU5JTVVNID0gREVGQVVMVF9NSU5fRkYKCiAgYXN5bmMgdXBncmFkZSgpIHsKICAgIHRyeSB7CiAgICAgIGlmICghdGhpcy51cGdyYWRpbmcpIHRoaXMudXBncmFkaW5nID0gdGhpcy5fdXBncmFkZSgpCgogICAgICBpZiAoIShhd2FpdCB0aGlzLnVwZ3JhZGluZykpIHJldHVybiBudWxsCgogICAgICByZXR1cm4gewogICAgICAgIGxlbmd0aDogdGhpcy5sZW5ndGgsCiAgICAgICAgZm9yY2U6IHRoaXMuZm9yY2UsCiAgICAgICAga2V5OiB0aGlzLmtleSwKICAgICAgICBpbmRleGVyczogdGhpcy5pbmRleGVycywKICAgICAgICB2aWV3czogdGhpcy52aWV3cywKICAgICAgICBlbnRyb3B5OiB0aGlzLmVudHJvcHksCiAgICAgICAgbWFuaWZlc3RWZXJzaW9uOiB0aGlzLmNvcmUubWFuaWZlc3QudmVyc2lvbiwKICAgICAgICBtaW5pbXVtOiB0aGlzLm1pbmltdW0KICAgICAgfQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgICAgdGhpcy5mYWlsZWQgPSB0cnVlCiAgICAgIHJldHVybiBudWxsCiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCB0aGlzLmNsb3NlKCkKICAgIH0KICB9CgogIF93YWl0Rm9yQXBwZW5kKGNvcmUpIHsKICAgIGlmIChjb3JlLmxlbmd0aCA+IDApIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQoKICAgIGNvbnN0IHByb21pc2UgPSBycnAoKQogICAgY29uc3QgdGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5jbG9zZS5iaW5kKHRoaXMpLCB0aGlzLnRpbWVvdXQpCiAgICBjb25zdCB3YWl0ID0geyBwcm9taXNlLCB0aW1lb3V0IH0KCiAgICB0aGlzLndhaXRpbmcuYWRkKHdhaXQpCgogICAgY29yZS5vbmNlKCdhcHBlbmQnLCAoKSA9PiB7CiAgICAgIHRoaXMud2FpdGluZy5kZWxldGUod2FpdCkKICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpCiAgICAgIHByb21pc2UucmVzb2x2ZSgpCiAgICB9KQoKICAgIHJldHVybiBwcm9taXNlLnByb21pc2UKICB9CgogIF9taW5MZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5iYXNlLmNvcmUubGVuZ3RoICsgdGhpcy5taW5pbXVtCiAgfQoKICBhc3luYyBfdXBncmFkZSgpIHsKICAgIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCgogICAgaWYgKCF0aGlzLnZlcmlmaWVkKSBhd2FpdCB0aGlzLl93YWl0Rm9yQXBwZW5kKHRoaXMuY29yZSkKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuIGZhbHNlCgogICAgaWYgKHRoaXMuY29yZS5tYW5pZmVzdC5saW5rZWQpIHsKICAgICAgY29uc3QgYXBwZW5kcyA9IFtdCgogICAgICBmb3IgKGNvbnN0IGtleSBvZiB0aGlzLmNvcmUubWFuaWZlc3QubGlua2VkKSB7CiAgICAgICAgY29uc3QgY29yZSA9IHRoaXMuYmFzZS5zdG9yZS5nZXQoeyBrZXksIGFjdGl2ZTogdHJ1ZSB9KQogICAgICAgIHRoaXMuY29yZXMucHVzaChjb3JlKQoKICAgICAgICBhd2FpdCBjb3JlLnJlYWR5KCkKICAgICAgICBhcHBlbmRzLnB1c2godGhpcy5fd2FpdEZvckFwcGVuZChjb3JlKSkKICAgICAgfQoKICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoYXBwZW5kcykKICAgIH0KCiAgICBpZiAodGhpcy5sZW5ndGggPT09IDApIHRoaXMubGVuZ3RoID0gdGhpcy5jb3JlLmxlbmd0aAoKICAgIC8vIG5vdGUgd2UgdXNlIHRoZSBwZXJzaXN0ZWQgbGVuZ3RoIGhlcmUsIGFzIHdlIG1pZ2h0IGFzIHdlbGwgY29udGludWUgdGhhdCB3b3JrIGFzIHRoYXRzIH4gdGhlIHNhbWUgbGVuZ3RoCiAgICBpZiAoIXRoaXMuZm9yY2UgJiYgdGhpcy5sZW5ndGggPCB0aGlzLl9taW5MZW5ndGgoKSkgcmV0dXJuIGZhbHNlCiAgICBpZiAodGhpcy5sZW5ndGggPT09IDApIHJldHVybiBmYWxzZQoKICAgIGF3YWl0IHRoaXMuY29yZS5nZXQodGhpcy5sZW5ndGggLSAxLCB7IHRpbWVvdXQ6IHRoaXMudGltZW91dCB9KQogICAgYXdhaXQgdGhpcy5iYXNlLnJlYWR5KCkKCiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybiBmYWxzZQoKICAgIGlmICh0aGlzLmJhc2UuZW5jcnlwdGlvbktleSAmJiAhKGF3YWl0IHRoaXMuX2Vuc3VyZUVuY3J5cHRpb24oKSkpIHJldHVybiBmYWxzZQogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4gZmFsc2UKCiAgICB0aGlzLnN5c3RlbSA9IG5ldyBTeXN0ZW1WaWV3KHRoaXMuY29yZSwgeyBjaGVja291dDogdGhpcy5sZW5ndGggfSkKICAgIGF3YWl0IHRoaXMuc3lzdGVtLnJlYWR5KCkKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuIGZhbHNlCgogICAgdGhpcy5lbnRyb3B5ID0gdGhpcy5zeXN0ZW0uZW50cm9weQoKICAgIGlmICh0aGlzLmNvcmUubWFuaWZlc3QudmVyc2lvbiA+PSAyKSB7CiAgICAgIGNvbnN0IGxpbmtlZCA9IHRoaXMuY29yZS5tYW5pZmVzdC5saW5rZWQKCiAgICAgIGlmICh0aGlzLnN5c3RlbS5lbmNyeXB0aW9uTGVuZ3RoID09PSAwIHx8IGxpbmtlZCA9PT0gbnVsbCB8fCAhbGlua2VkLmxlbmd0aCkgewogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9CgogICAgICAvLyB0ZWNobmljYWxseSBkaXZlcmdlcyBmcm9tIHN5c3RlbS52aWV3cyB0byBpbmNsdWRlIGVuY3J5cHRpb24gaGVyZSwgYnV0IG1ha2VzIHNlbnNlCiAgICAgIHRoaXMudmlld3MucHVzaCh7CiAgICAgICAga2V5OiBsaW5rZWRbMF0sCiAgICAgICAgbGVuZ3RoOiB0aGlzLnN5c3RlbS5lbmNyeXB0aW9uTGVuZ3RoCiAgICAgIH0pCiAgICB9CgogICAgY29uc3QgcHJvbWlzZXMgPSBbXQoKICAgIC8vIGVuc3VyZSBsb2NhbCBrZXkgaXMgbG9jYWxseSBhdmFpbGFibGUgYWx3YXlzCiAgICBwcm9taXNlcy5wdXNoKHRoaXMuc3lzdGVtLmdldCh0aGlzLmJhc2UubG9jYWwua2V5LCB7IHRpbWVvdXQ6IHRoaXMudGltZW91dCB9KSkKCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uICYmIHRoaXMuZW5jcnlwdGlvbi5jb3JlKSB7CiAgICAgIHByb21pc2VzLnB1c2goCiAgICAgICAgdGhpcy5lbmNyeXB0aW9uLmNvcmUuZ2V0KHRoaXMuc3lzdGVtLmVuY3J5cHRpb25MZW5ndGggLSAxLCB7IHRpbWVvdXQ6IHRoaXMudGltZW91dCB9KQogICAgICApCiAgICB9CgogICAgZm9yIChjb25zdCB2IG9mIHRoaXMuc3lzdGVtLnZpZXdzKSB7CiAgICAgIHRoaXMudmlld3MucHVzaCh2KQogICAgICBjb25zdCBjb3JlID0gdGhpcy5iYXNlLnN0b3JlLmdldCh7IGtleTogdi5rZXksIGFjdGl2ZTogdHJ1ZSB9KQogICAgICB0aGlzLmNvcmVzLnB1c2goY29yZSkKICAgICAgaWYgKCF2Lmxlbmd0aCkgY29udGludWUgLy8gZW5jcnlwdGlvbiB2aWV3IGNhbiBiZSAwIGxlbmd0aAogICAgICBwcm9taXNlcy5wdXNoKGNvcmUuZ2V0KHYubGVuZ3RoIC0gMSwgeyB0aW1lb3V0OiB0aGlzLnRpbWVvdXQgfSkpCiAgICB9CgogICAgZm9yIChjb25zdCBpZHggb2YgdGhpcy5zeXN0ZW0uaW5kZXhlcnMpIHsKICAgICAgdGhpcy5pbmRleGVycy5wdXNoKGlkeCkKICAgICAgaWYgKGlkeC5sZW5ndGggPT09IDApIGNvbnRpbnVlIC8vIG5lZWQgdG8gbWFrZSBzdXJlIHdlIGhhdmUgbWFuaWZlc3QuLi4KICAgICAgY29uc3QgY29yZSA9IHRoaXMuYmFzZS5zdG9yZS5nZXQoeyBrZXk6IGlkeC5rZXksIGFjdGl2ZTogdHJ1ZSB9KQogICAgICB0aGlzLmNvcmVzLnB1c2goY29yZSkKICAgICAgcHJvbWlzZXMucHVzaChjb3JlLmdldChpZHgubGVuZ3RoIC0gMSwgeyB0aW1lb3V0OiB0aGlzLnRpbWVvdXQgfSkpCiAgICAgIHByb21pc2VzLnB1c2godGhpcy5zeXN0ZW0uZ2V0KGlkeC5rZXksIHsgdGltZW91dDogdGhpcy50aW1lb3V0IH0pKQogICAgfQoKICAgIGZvciAoY29uc3QgaGVhZCBvZiB0aGlzLnN5c3RlbS5oZWFkcykgewogICAgICBwcm9taXNlcy5wdXNoKHRoaXMuc3lzdGVtLmdldChoZWFkLmtleSwgeyB0aW1lb3V0OiB0aGlzLnRpbWVvdXQgfSkpCiAgICB9CgogICAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpCiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybiBmYWxzZQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBfZW5zdXJlRW5jcnlwdGlvbigpIHsKICAgIC8vIG9ubHkgbmVlZCBlbmNyeXB0aW9uIGlmIHdlIG1pZ3JhdGVkCiAgICBpZiAodGhpcy5jb3JlLmVuY3J5cHRpb24gIT09IG51bGwpIHJldHVybiB0cnVlCgogICAgY29uc3QgZW5jQ29yZSA9IHRoaXMuY29yZS5tYW5pZmVzdC52ZXJzaW9uIDw9IDEgPyBudWxsIDogdGhpcy5jb3Jlc1sxXQoKICAgIC8vIGV4cGVjdHMgaW50ZXJuYWwgdmlld3MgdG8gYmUgbG9hZGVkIGluIG9yZGVyCiAgICB0aGlzLmVuY3J5cHRpb24gPSBuZXcgRW5jcnlwdGlvblZpZXcodGhpcy5iYXNlLCBlbmNDb3JlKQogICAgY29uc3QgZW5jcnlwdGlvbiA9IHRoaXMuZW5jcnlwdGlvbi5nZXRWaWV3RW5jcnlwdGlvbignX3N5c3RlbScpCgogICAgYXdhaXQgdGhpcy5jb3JlLnNldEVuY3J5cHRpb24oZW5jcnlwdGlvbikKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgY2xvc2UoKSB7CiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICAgIGZvciAoY29uc3QgeyBwcm9taXNlLCB0aW1lb3V0IH0gb2YgdGhpcy53YWl0aW5nKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KQogICAgICBwcm9taXNlLnJlc29sdmUoKSAvLyBzaWxlbnRseSBiYWlsCiAgICB9CiAgICBpZiAodGhpcy5zeXN0ZW0pIGF3YWl0IHRoaXMuc3lzdGVtLmNsb3NlKCkKICAgIGlmICh0aGlzLmVuY3J5cHRpb24pIGF3YWl0IHRoaXMuZW5jcnlwdGlvbi5jbG9zZSgpCiAgICBmb3IgKGNvbnN0IGNvcmUgb2YgdGhpcy5jb3JlcykgYXdhaXQgY29yZS5jbG9zZSgpCiAgICBhd2FpdCB0aGlzLmNvcmUuY2xvc2UoKQogIH0KfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCgpjb25zdCBTeXN0ZW1WaWV3ID0gcmVxdWlyZSgnLi9zeXN0ZW0uanMnKQpjb25zdCB7IEVuY3J5cHRpb25WaWV3IH0gPSByZXF1aXJlKCcuL2VuY3J5cHRpb24uanMnKQpjb25zdCB7IE1hbmlmZXN0RGF0YSB9ID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEZvcmsgewogIGNvbnN0cnVjdG9yKGJhc2UsIHN0b3JlLCBzdGF0ZSwgZm9yaykgewogICAgdGhpcy5iYXNlID0gYmFzZQogICAgdGhpcy5zdG9yZSA9IHN0b3JlCiAgICB0aGlzLnN0YXRlID0gc3RhdGUKICAgIHRoaXMuaW5kZXhlcnMgPSBmb3JrLmluZGV4ZXJzCiAgICB0aGlzLmxlbmd0aCA9IGZvcmsubGVuZ3RoCiAgICB0aGlzLnN5c3RlbSA9IG51bGwKICAgIHRoaXMuZW5jcnlwdGlvbiA9IG51bGwKICAgIHRoaXMubWFuaWZlc3RzID0gbnVsbAogICAgdGhpcy5jb3JlcyA9IFtdCiAgfQoKICBhc3luYyB1cGdyYWRlKCkgewogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fdXBncmFkZSgpCiAgICAgIHJldHVybiB0cnVlCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCB0aGlzLmNsb3NlKCkKICAgIH0KICB9CgogIGFzeW5jIF91cGdyYWRlKCkgewogICAgdGhpcy5tYW5pZmVzdHMgPSBhd2FpdCB0aGlzLnN0b3JlLmdldEluZGV4ZXJNYW5pZmVzdHModGhpcy5pbmRleGVycykKCiAgICB0aGlzLnN5c3RlbSA9IG5ldyBTeXN0ZW1WaWV3KGF3YWl0IHRoaXMuX2dldCgnX3N5c3RlbScsIHRoaXMubGVuZ3RoKSkKICAgIHRoaXMuZW5jcnlwdGlvbiA9IG5ldyBFbmNyeXB0aW9uVmlldyh0aGlzLCBhd2FpdCB0aGlzLl9nZXQoJ19lbmNyeXB0aW9uJywgLTEpKQoKICAgIGF3YWl0IHRoaXMuc3lzdGVtLnJlYWR5KCkKICAgIGF3YWl0IHRoaXMuZW5jcnlwdGlvbi5yZWFkeSgpCgogICAgdGhpcy5lbnRyb3B5ID0gdGhpcy5zeXN0ZW0uZ2V0RW50cm9weSh0aGlzLmluZGV4ZXJzLCB0aGlzLmxlbmd0aCkKICAgIHRoaXMubWFuaWZlc3RWZXJzaW9uID0gTWF0aC5tYXgodGhpcy5zeXN0ZW0uY29yZS5tYW5pZmVzdC52ZXJzaW9uLCAyKSAvLyA+PSAyIHRvIHNpZ25hbCBuZXcgZW5jcnlwdGlvbgoKICAgIGNvbnN0IHZpZXdzID0gW10KICAgIGZvciAoY29uc3QgdmlldyBvZiB0aGlzLnN0YXRlLnZpZXdzKSB7CiAgICAgIGNvbnN0IHYgPSB0aGlzLmdldFZpZXdGcm9tU3lzdGVtKHZpZXcsIHRoaXMuc3lzdGVtKQogICAgICBjb25zdCBpbmRleGVkTGVuZ3RoID0gdiA/IHYubGVuZ3RoIDogMAoKICAgICAgY29uc3Qgc2Vzc2lvbiA9IGF3YWl0IHRoaXMuX2dldCh2aWV3Lm5hbWUsIGluZGV4ZWRMZW5ndGgpCiAgICAgIGF3YWl0IHNlc3Npb24ucmVhZHkoKQoKICAgICAgY29uc3QgbmV4dCA9IGF3YWl0IHRoaXMuY3JlYXRlVmlldyh2aWV3Lm5hbWUsIHNlc3Npb24sIG51bGwpCiAgICAgIGF3YWl0IG5leHQucmVhZHkoKQoKICAgICAgYXdhaXQgdGhpcy5fbWlncmF0ZSh2aWV3LnJlZiwgbmV4dCwgdmlldy5jb3JlLCBpbmRleGVkTGVuZ3RoKQoKICAgICAgLy8gdXBkYXRlIGtleQogICAgICB2aWV3cy5wdXNoKHsga2V5OiBuZXh0LmtleSwgbGVuZ3RoOiBpbmRleGVkTGVuZ3RoIH0pCiAgICB9CgogICAgLy8gaW50ZXJuYWwgdmlld3MgYXJlIGV4cGxpY2l0bHkgbWlncmF0ZWQKCiAgICBjb25zdCBlbnRyb3B5ID0gRW5jcnlwdGlvblZpZXcubmFtZXNwYWNlKHRoaXMuZW50cm9weSkKICAgIGF3YWl0IHRoaXMuZW5jcnlwdGlvbi51cGRhdGUoZW50cm9weSkKCiAgICBjb25zdCBzeXN0ZW0gPSB0aGlzLnN0b3JlLmdldFZpZXdCeU5hbWUoJ19zeXN0ZW0nKQogICAgY29uc3QgZW5jcnlwdGlvbiA9IHRoaXMuc3RvcmUuZ2V0Vmlld0J5TmFtZSgnX2VuY3J5cHRpb24nKQoKICAgIGNvbnN0IGVuYyA9IGF3YWl0IHRoaXMuY3JlYXRlVmlldygnX2VuY3J5cHRpb24nLCB0aGlzLmVuY3J5cHRpb24uY29yZSwgbnVsbCkKICAgIGF3YWl0IGVuYy5yZWFkeSgpCgogICAgYXdhaXQgdGhpcy5fbWlncmF0ZShlbmNyeXB0aW9uLCBlbmMsIHRoaXMuZW5jcnlwdGlvbi5jb3JlLCB0aGlzLmVuY3J5cHRpb24uY29yZS5sZW5ndGgpCgogICAgYXdhaXQgdGhpcy5zeXN0ZW0uZm9yayh0aGlzLmluZGV4ZXJzLCB0aGlzLm1hbmlmZXN0cywgdGhpcy5lbmNyeXB0aW9uLmNvcmUubGVuZ3RoLCB2aWV3cykKCiAgICBjb25zdCBzeXMgPSBhd2FpdCB0aGlzLmNyZWF0ZVZpZXcoJ19zeXN0ZW0nLCB0aGlzLnN5c3RlbS5jb3JlLCBbZW5jLmtleV0pCiAgICBhd2FpdCBzeXMucmVhZHkoKQoKICAgIGF3YWl0IHRoaXMuX21pZ3JhdGUoc3lzdGVtLCBzeXMsIHRoaXMuc3lzdGVtLmNvcmUsIHRoaXMuc3lzdGVtLmNvcmUubGVuZ3RoKQogIH0KCiAgYXN5bmMgY3JlYXRlVmlldyhuYW1lLCBjb3JlLCBsaW5rZWQpIHsKICAgIGNvbnN0IHByb2xvZ3VlID0gYXdhaXQgZ2V0UHJvbG9ndWUoY29yZSkKICAgIGNvbnN0IG1hbmlmZXN0RGF0YSA9IHRoaXMuX21hbmlmZXN0RGF0YShjb3JlKQoKICAgIHJldHVybiB0aGlzLnN0b3JlLmdldFZpZXdDb3JlKAogICAgICB0aGlzLm1hbmlmZXN0cywKICAgICAgbmFtZSwKICAgICAgcHJvbG9ndWUsCiAgICAgIHRoaXMubWFuaWZlc3RWZXJzaW9uLAogICAgICB0aGlzLmVudHJvcHksCiAgICAgIGxpbmtlZCwKICAgICAgbWFuaWZlc3REYXRhCiAgICApCiAgfQoKICBhc3luYyBfZ2V0KG5hbWUsIGxlbmd0aCkgewogICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsgbmFtZSB9KQogICAgdGhpcy5jb3Jlcy5wdXNoKGNvcmUpCgogICAgaWYgKGxlbmd0aCAhPT0gLTEpIGF3YWl0IGNvcmUudHJ1bmNhdGUobGVuZ3RoKQoKICAgIHJldHVybiBjb3JlCiAgfQoKICBnZXRWaWV3RnJvbVN5c3RlbSh2aWV3KSB7CiAgICBpZiAodmlldy5tYXBwZWRJbmRleCA9PT0gLTEgfHwgdmlldy5tYXBwZWRJbmRleCA+PSB0aGlzLnN5c3RlbS52aWV3cy5sZW5ndGgpIHJldHVybiBudWxsCiAgICByZXR1cm4gdGhpcy5zeXN0ZW0udmlld3Nbdmlldy5tYXBwZWRJbmRleF0KICB9CgogIF9tYW5pZmVzdERhdGEoc2Vzc2lvbikgewogICAgaWYgKHNlc3Npb24ubWFuaWZlc3QudmVyc2lvbiA+IDEpIHJldHVybiBzZXNzaW9uLm1hbmlmZXN0LnVzZXJEYXRhCiAgICByZXR1cm4gYy5lbmNvZGUoTWFuaWZlc3REYXRhLCB7IHZlcnNpb246IDAsIGxlZ2FjeUJsb2Nrczogc2Vzc2lvbi5sZW5ndGggfSkKICB9CgogIGFzeW5jIF9taWdyYXRlKHJlZiwgbmV4dCwgc291cmNlLCBsZW5ndGgpIHsKICAgIGlmIChsZW5ndGggPiAwKSB7CiAgICAgIGF3YWl0IG5leHQuY29yZS5jb3B5UHJvbG9ndWUoc291cmNlLnN0YXRlKQogICAgfQoKICAgIC8vIHJlbWFrZSB0aGUgYmF0Y2gsIHJlc2V0IGZyb20gb3VyIHByb2xvZ3VlIGluIGNhc2UgaXQgcmVwbGljYXRlZCBpbmJldHdlZW4KICAgIC8vIFRPRE86IHdlIHNob3VsZCByZWFsbHkgaGF2ZSBhbiBIQyBmdW5jdGlvbiBmb3IgdGhpcwogICAgY29uc3QgYmF0Y2ggPSBuZXh0LnNlc3Npb24oeyBuYW1lOiAnYmF0Y2gnLCBvdmVyd3JpdGU6IHRydWUsIGNoZWNrb3V0OiBsZW5ndGggfSkKICAgIGF3YWl0IGJhdGNoLnJlYWR5KCkKCiAgICBpZiAoc291cmNlICE9PSBudWxsKSB7CiAgICAgIHdoaWxlIChiYXRjaC5sZW5ndGggPCBzb3VyY2UubGVuZ3RoKSB7CiAgICAgICAgYXdhaXQgYmF0Y2guYXBwZW5kKGF3YWl0IHNvdXJjZS5nZXQoYmF0Y2gubGVuZ3RoKSkKICAgICAgfQogICAgfQoKICAgIGF3YWl0IHJlZi5iYXRjaC5zdGF0ZS5tb3ZlVG8oYmF0Y2gsIGJhdGNoLmxlbmd0aCkKICAgIGF3YWl0IGJhdGNoLmNsb3NlKCkKCiAgICByZWYubWlncmF0ZWQodGhpcy5iYXNlLCBuZXh0KQogIH0KCiAgYXN5bmMgY2xvc2UoKSB7CiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICAgIGlmICh0aGlzLnN5c3RlbSkgYXdhaXQgdGhpcy5zeXN0ZW0uY2xvc2UoKQogICAgaWYgKHRoaXMuZW5jcnlwdGlvbikgYXdhaXQgdGhpcy5lbmNyeXB0aW9uLmNsb3NlKCkKICAgIGZvciAoY29uc3QgY29yZSBvZiB0aGlzLmNvcmVzKSBhd2FpdCBjb3JlLmNsb3NlKCkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGdldFByb2xvZ3VlKGNvcmUpIHsKICBpZiAoIWNvcmUubGVuZ3RoKSByZXR1cm4gbnVsbAoKICByZXR1cm4gewogICAgaGFzaDogYXdhaXQgY29yZS50cmVlSGFzaCgpLAogICAgbGVuZ3RoOiBjb3JlLmxlbmd0aAogIH0KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBhc3NlcnQgPSByZXF1aXJlKCduYW5vYXNzZXJ0JykKCmNvbnN0IENsb2NrID0gcmVxdWlyZSgnLi9jbG9jay5qcycpCmNvbnN0IENvbnNlbnN1cyA9IHJlcXVpcmUoJy4vY29uc2Vuc3VzLmpzJykKY29uc3QgVG9wb2xpc3QgPSByZXF1aXJlKCcuL3RvcG9saXN0LmpzJykKCmNsYXNzIE5vZGUgewogIGNvbnN0cnVjdG9yKHdyaXRlciwgbGVuZ3RoLCB2YWx1ZSwgaGVhZHMsIGJhdGNoLCBkZXBlbmRlbmNpZXMsIG9wdGltaXN0aWMsIHRyYWNlKSB7CiAgICB0aGlzLndyaXRlciA9IHdyaXRlcgogICAgdGhpcy5sZW5ndGggPSBsZW5ndGgKICAgIHRoaXMudmFsdWUgPSB2YWx1ZQogICAgdGhpcy5oZWFkcyA9IGhlYWRzCiAgICB0aGlzLmFjdHVhbEhlYWRzID0gaGVhZHMuc2xpY2UoMCkgLy8gVE9ETzogd2Ugc2hvdWxkIHJlbW92ZSB0aGlzIGFuZCBqdXN0IG5vdCBtdXRhdGUgaGVhZHMuLi4KCiAgICB0aGlzLmRlcGVuZGVudHMgPSBuZXcgU2V0KCkKICAgIHRoaXMuZGVwZW5kZW5jaWVzID0gZGVwZW5kZW5jaWVzCiAgICB0aGlzLmluZGV4ID0gMCAvLyB1c2VkIGJ5IHRvcG9saXN0CgogICAgdGhpcy5vcHRpbWlzdGljID0gb3B0aW1pc3RpYyAmJiBiYXRjaCA9PT0gMSAmJiAhIXZhbHVlCgogICAgdGhpcy5iYXRjaCA9IGJhdGNoCiAgICB0aGlzLmRyb3BwZWQgPSAwCiAgICB0aGlzLnRyYWNlID0gdHJhY2UKCiAgICB0aGlzLmNsb2NrID0gbmV3IENsb2NrKCkKCiAgICB0aGlzLnlpZWxkZWQgPSBmYWxzZQogICAgdGhpcy55aWVsZGluZyA9IGZhbHNlCiAgfQoKICBpc1RhaWwoKSB7CiAgICByZXR1cm4gdGhpcy5kZXBlbmRlbmNpZXMuc2l6ZSA9PT0gdGhpcy5kcm9wcGVkCiAgfQoKICBjYXVzYWxEZXBlbmRlbmNpZXMoaWR4KSB7CiAgICBjb25zdCBvcmRlciA9IFt0aGlzXQogICAgY29uc3Qgc3RhY2sgPSBbdGhpc10KCiAgICBsZXQgdmlzaXRlZCA9IG51bGwKCiAgICB3aGlsZSAoc3RhY2subGVuZ3RoID4gMCkgewogICAgICBjb25zdCBub2RlID0gc3RhY2sucG9wKCkKICAgICAgZm9yIChjb25zdCBkZXAgb2Ygbm9kZS5kZXBlbmRlbmNpZXMpIHsKICAgICAgICBpZiAoIWRlcC53cml0ZXIuaXNSZW1vdmVkIHx8IGRlcC53cml0ZXIuaXNBY3RpdmVJbmRleGVyKSBjb250aW51ZQoKICAgICAgICAvLyBUT0RPOiByZXBsYWNlIHdpdGggImNvbG9yaW5nIiBidXQgb2sgZm9yIG5vdywgdGlueSBzZXQKICAgICAgICBpZiAodmlzaXRlZCA9PT0gbnVsbCkgdmlzaXRlZCA9IG5ldyBTZXQoKQogICAgICAgIGlmICh2aXNpdGVkLmhhcyhkZXApKSBjb250aW51ZQogICAgICAgIHZpc2l0ZWQuYWRkKGRlcCkKCiAgICAgICAgc3RhY2sucHVzaChkZXApCiAgICAgICAgb3JkZXIucHVzaChkZXApCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gb3JkZXIKICB9CgogIGNsZWFyKCkgewogICAgdGhpcy5jbG9jayA9IG51bGwKICAgIHRoaXMuZGVwZW5kZW50cyA9IG51bGwKICAgIHJldHVybiB0aGlzCiAgfQoKICByZXNldCgpIHsKICAgIHRoaXMueWllbGRlZCA9IGZhbHNlCiAgICB0aGlzLnlpZWxkaW5nID0gZmFsc2UKICAgIGZvciAoY29uc3QgZGVwIG9mIHRoaXMuZGVwZW5kZW50cykgZGVwLmRlcGVuZGVuY2llcy5hZGQodGhpcykKICAgIHRoaXMuZGVwZW5kZW50cy5jbGVhcigpCiAgfQoKICBhY3RpdmUoKSB7CiAgICBmb3IgKGNvbnN0IGRlcCBvZiB0aGlzLmRlcGVuZGVuY2llcykgewogICAgICBpZiAoZGVwLnlpZWxkZWQpIHsKICAgICAgICB0aGlzLmRlcGVuZGVuY2llcy5kZWxldGUoZGVwKSAvLyBub2RlcyBtaWdodCBiZSB5aWVsZGVkIGR1cmluZyBidWZmZXJpbmcKICAgICAgfSBlbHNlIHsKICAgICAgICBkZXAuZGVwZW5kZW50cy5hZGQodGhpcykKICAgICAgICB0aGlzLmNsb2NrLmFkZChkZXAuY2xvY2spCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy53cml0ZXIuaXNBY3RpdmVJbmRleGVyKSB0aGlzLmNsb2NrLnNldCh0aGlzLndyaXRlci5jb3JlLmtleSwgdGhpcy5sZW5ndGgpCiAgfQoKICB0aWVCcmVhayhub2RlKSB7CiAgICByZXR1cm4gdGllQnJlYWsodGhpcywgbm9kZSkKICB9CgogIGhhc0RlcGVuZGVuY3koZGVwKSB7CiAgICBmb3IgKGNvbnN0IGggb2YgdGhpcy5hY3R1YWxIZWFkcykgewogICAgICBpZiAoc2FtZU5vZGUoaCwgZGVwKSkgcmV0dXJuIHRydWUKICAgIH0KICAgIHJldHVybiBmYWxzZQogIH0KCiAgZ2V0IHJlZigpIHsKICAgIHJldHVybiB0aGlzLndyaXRlci5jb3JlLmtleS50b1N0cmluZygnaGV4Jykuc2xpY2UoMCwgMikgKyAnOicgKyB0aGlzLmxlbmd0aAogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBMaW5lYXJpemVyIHsKICBjb25zdHJ1Y3RvcihpbmRleGVycywgeyBoZWFkcyA9IFtdLCB3cml0ZXJzID0gbmV3IE1hcCgpIH0gPSB7fSkgewogICAgdGhpcy5oZWFkcyA9IG5ldyBTZXQoKQogICAgdGhpcy50YWlscyA9IG5ldyBTZXQoKQogICAgdGhpcy50aXAgPSBuZXcgVG9wb2xpc3QoKQogICAgdGhpcy5zaXplID0gMCAvLyB1c2VmdWwgZm9yIGRlYnVnZ2luZwogICAgdGhpcy51cGRhdGVkID0gZmFsc2UKICAgIHRoaXMuaW5kZXhlcnNVcGRhdGVkID0gZmFsc2UKICAgIHRoaXMud3JpdGVycyA9IHdyaXRlcnMKCiAgICB0aGlzLmNvbnNlbnN1cyA9IG5ldyBDb25zZW5zdXMoaW5kZXhlcnMpCiAgICB0aGlzLl9pbml0aWFsSGVhZHMgPSBoZWFkcy5zbGljZSgwKQogICAgdGhpcy5fc3RyaWN0bHlBZGRlZCA9IG51bGwKCiAgICBmb3IgKGNvbnN0IHsga2V5LCBsZW5ndGggfSBvZiBoZWFkcykgewogICAgICB0aGlzLmNvbnNlbnN1cy5yZW1vdmVkLnNldChrZXksIGxlbmd0aCkKICAgIH0KICB9CgogIGdldCBpbmRleGVycygpIHsKICAgIHJldHVybiB0aGlzLmNvbnNlbnN1cy5pbmRleGVycwogIH0KCiAgc3RhdGljIGNyZWF0ZU5vZGUod3JpdGVyLCBsZW5ndGgsIHZhbHVlLCBoZWFkcywgYmF0Y2gsIGRlcGVuZGVuY2llcywgb3B0aW1pc3RpYywgdHJhY2UpIHsKICAgIHJldHVybiBuZXcgTm9kZSh3cml0ZXIsIGxlbmd0aCwgdmFsdWUsIGhlYWRzLCBiYXRjaCwgZGVwZW5kZW5jaWVzLCBvcHRpbWlzdGljLCB0cmFjZSkKICB9CgogIC8vIHJldHVybnMgdGhlIGdsb2JhbCBsaW5rcyBvZiB0aGUgZGFnLCB1c2UgdGhpcyB0byBsaW5rIGFnYWluc3QgdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIGRhZwogIC8vIFRPRE86IHJlbmFtZSB0byBoZWFkcygpIGFuZCBtb3ZlIHRoZSBzZXRzIHRvIF8gcHJvcHMKICBnZXRIZWFkcygpIHsKICAgIGNvbnN0IGhlYWRzID0gdGhpcy5faW5pdGlhbEhlYWRzLnNsaWNlKDApCiAgICBmb3IgKGNvbnN0IG5vZGUgb2YgdGhpcy5oZWFkcykgaGVhZHMucHVzaCh7IGtleTogbm9kZS53cml0ZXIuY29yZS5rZXksIGxlbmd0aDogbm9kZS5sZW5ndGggfSkKICAgIHJldHVybiBoZWFkcwogIH0KCiAgLy8gVE9ETzogbWlnaHQgY29udGFpbiBkdXBzIGF0bSwgbmJkIGZvciBob3cgd2UgdXNlIGl0LCByZXR1cm5zIGFuIGFycmF5IG9mIHdyaXRlcnMgeW91IGNhbiAicHVsbCIKICAvLyB0byBnZXQgdGhlIGZ1bGwgZGFnIHZpZXcgYXQgYW55IHRpbWUKICBnZXRCb290c3RyYXBXcml0ZXJzKCkgewogICAgY29uc3Qgd3JpdGVycyA9IFtdCgogICAgZm9yIChjb25zdCBoZWFkIG9mIHRoaXMuaGVhZHMpIHdyaXRlcnMucHVzaChoZWFkLndyaXRlcikKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5jb25zZW5zdXMuaW5kZXhlcnMubGVuZ3RoOyBpKyspCiAgICAgIHdyaXRlcnMucHVzaCh0aGlzLmNvbnNlbnN1cy5pbmRleGVyc1tpXSkKCiAgICByZXR1cm4gd3JpdGVycwogIH0KCiAgYWRkSGVhZChub2RlKSB7CiAgICBub2RlLmFjdGl2ZSgpCgogICAgLy8gOTkuOTklIG9mIHRoZSB0aW1lIF9pbml0aWFsSGVhZHMgaXMgZW1wdHkuLi4KICAgIGlmICh0aGlzLl9pbml0aWFsSGVhZHMubGVuZ3RoID4gMCkgdGhpcy5fdXBkYXRlSW5pdGlhbEhlYWRzKG5vZGUpCgogICAgaWYgKG5vZGUuaXNUYWlsKCkpIHsKICAgICAgdGhpcy50YWlscy5hZGQobm9kZSkKICAgIH0KCiAgICBmb3IgKGNvbnN0IGhlYWQgb2YgdGhpcy5oZWFkcykgewogICAgICBpZiAobm9kZS5oYXNEZXBlbmRlbmN5KGhlYWQpKSB7CiAgICAgICAgdGhpcy5oZWFkcy5kZWxldGUoaGVhZCkKICAgICAgfQogICAgfQoKICAgIHRoaXMudGlwLmFkZChub2RlKQogICAgaWYgKG5vZGUud3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgdGhpcy5jb25zZW5zdXMuYWRkSGVhZChub2RlKQoKICAgIHRoaXMuc2l6ZSsrCiAgICB0aGlzLmhlYWRzLmFkZChub2RlKQoKICAgIHRoaXMudXBkYXRlZCA9IHRydWUKCiAgICByZXR1cm4gbm9kZQogIH0KCiAgdXBkYXRlKCkgewogICAgaWYgKCF0aGlzLnVwZGF0ZWQpIHJldHVybiBudWxsCiAgICB0aGlzLnVwZGF0ZWQgPSBmYWxzZQoKICAgIC8vIGdldCB0aGUgaW5kZXhlZCBub2RlcwogICAgY29uc3QgaW5kZXhlZCA9IFtdCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBjb25zdCBub2RlcyA9IHRoaXMuY29uc2Vuc3VzLnNoaWZ0KCkKICAgICAgaWYgKCFub2Rlcy5sZW5ndGgpIGJyZWFrCgogICAgICB0aGlzLl95aWVsZChub2RlcywgaW5kZXhlZCkKICAgIH0KCiAgICByZXR1cm4gdGhpcy50aXAuZmx1c2goaW5kZXhlZCkKICB9CgogIF91cGRhdGVJbml0aWFsSGVhZHMobm9kZSkgewogICAgZm9yIChjb25zdCBoZWFkIG9mIG5vZGUuYWN0dWFsSGVhZHMpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9pbml0aWFsSGVhZHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB7IGtleSwgbGVuZ3RoIH0gPSB0aGlzLl9pbml0aWFsSGVhZHNbaV0KICAgICAgICBpZiAobGVuZ3RoICE9PSBoZWFkLmxlbmd0aCB8fCAhYjRhLmVxdWFscyhrZXksIGhlYWQua2V5KSkgY29udGludWUKICAgICAgICB0aGlzLl9pbml0aWFsSGVhZHMuc3BsaWNlKGktLSwgMSkKICAgICAgfQogICAgfQogIH0KCiAgLyogQWNrIG1ldGhvZHMgKi8KCiAgc2hvdWxkQWNrKHdyaXRlciwgcGVuZGluZyA9IGZhbHNlKSB7CiAgICBpZiAoIXdyaXRlciB8fCAhd3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgcmV0dXJuIGZhbHNlCgogICAgLy8gYWxsIGluZGV4ZXJzIGhhdmUgdG8gZmx1c2hlZCB0byB0aGUgZGFnIGJlZm9yZSB3ZSBhY2sgYXMgYSBxdWljayAiZGVib3VuY2UiCiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5pbmRleGVycykgewogICAgICBpZiAody5sZW5ndGggIT09IHcuYXZhaWxhYmxlKSByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBsZXQgaXNIZWFkID0gZmFsc2UKCiAgICAvLyBpZiBBTlkgaGVhZCBpcyBub3QgYW4gaW5kZXhlciBhY2sKICAgIGZvciAoY29uc3QgaGVhZCBvZiB0aGlzLmhlYWRzKSB7CiAgICAgIGlmICghaGVhZC53cml0ZXIuaXNBY3RpdmVJbmRleGVyKSByZXR1cm4gdHJ1ZQogICAgICBpZiAoaGVhZC53cml0ZXIgPT09IHdyaXRlcikgaXNIZWFkID0gdHJ1ZQogICAgfQoKICAgIGlmICh0aGlzLmhlYWRzLnNpemUgPT09IDEgJiYgaXNIZWFkKSB7CiAgICAgIHJldHVybiBmYWxzZSAvLyBuZXZlciBzZWxmLWFjayEKICAgIH0KCiAgICBjb25zdCB2aXNpdGVkID0gbmV3IFNldCgpCgogICAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgbm9uLW51bGwgdmFsdWUKICAgIGxldCB2YWx1ZUNoZWNrID0gZmFsc2UKCiAgICBmb3IgKGNvbnN0IHRhaWwgb2YgdGhpcy50YWlscykgewogICAgICBpZiAocGVuZGluZyB8fCB0aGlzLl9ub25OdWxsKHRhaWwsIHZpc2l0ZWQpKSB7CiAgICAgICAgdmFsdWVDaGVjayA9IHRydWUKICAgICAgICBicmVhawogICAgICB9CiAgICB9CgogICAgaWYgKCF2YWx1ZUNoZWNrKSByZXR1cm4gZmFsc2UKCiAgICBpZiAodGhpcy5jb25zZW5zdXMuc2hvdWxkQWNrKHdyaXRlcikpIHJldHVybiB0cnVlCgogICAgcmV0dXJuIHRoaXMuX3Nob3VsZEFja0hlYWRzKHdyaXRlciwgcGVuZGluZykKICB9CgogIC8vIGNoZWNrIGlmIHRoZXJlIGlzIGFueSB2YWx1ZSBhYm92ZSB0aGlzIG5vZGUKICBfbm9uTnVsbCh0YXJnZXQsIHZpc2l0ZWQpIHsKICAgIGNvbnN0IHN0YWNrID0gW3RhcmdldF0KCiAgICB3aGlsZSAoc3RhY2subGVuZ3RoKSB7CiAgICAgIGNvbnN0IG5vZGUgPSBzdGFjay5wb3AoKQoKICAgICAgaWYgKHZpc2l0ZWQuaGFzKG5vZGUpKSBjb250aW51ZQogICAgICBpZiAobm9kZS52YWx1ZSAhPT0gbnVsbCkgcmV0dXJuIHRydWUKCiAgICAgIHZpc2l0ZWQuYWRkKG5vZGUpCgogICAgICBmb3IgKGNvbnN0IGRlcCBvZiBub2RlLmRlcGVuZGVudHMpIHsKICAgICAgICBzdGFjay5wdXNoKGRlcCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgLy8gYWNrIGlmIGFueSBoZWFkIGlzIGNsb3NlciB0byBjb25maXJtaW5nIGEgdmFsdWUKICBfc2hvdWxkQWNrSGVhZHMod3JpdGVyLCBwZW5kaW5nKSB7CiAgICBjb25zdCBwcmV2ID0gd3JpdGVyLmhlYWQoKQoKICAgIGZvciAoY29uc3QgaGVhZCBvZiB0aGlzLmhlYWRzKSB7CiAgICAgIC8vIG9ubHkgY2hlY2sgb3RoZXIgd3JpdGVycyBoZWFkcwogICAgICBpZiAoaGVhZC53cml0ZXIgPT09IHdyaXRlcikgY29udGludWUKCiAgICAgIGNvbnN0IHN0YWNrID0gW2hlYWRdCiAgICAgIGNvbnN0IHZpc2l0ZWQgPSBuZXcgU2V0KCkKCiAgICAgIHdoaWxlIChzdGFjay5sZW5ndGgpIHsKICAgICAgICBjb25zdCBub2RlID0gc3RhY2sucG9wKCkKCiAgICAgICAgaWYgKHZpc2l0ZWQuaGFzKG5vZGUpKSBjb250aW51ZQogICAgICAgIHZpc2l0ZWQuYWRkKG5vZGUpCgogICAgICAgIGlmIChwZW5kaW5nIHx8IG5vZGUudmFsdWUgIT09IG51bGwpIHsKICAgICAgICAgIGNvbnN0IGFja3MgPSB0aGlzLmNvbnNlbnN1cy5hY2tzRnJvbU5vZGUobm9kZSwgaGVhZCkKICAgICAgICAgIGNvbnN0IHByZXZBY2tzID0gdGhpcy5jb25zZW5zdXMuYWNrc0Zyb21Ob2RlKG5vZGUsIHByZXYpCgogICAgICAgICAgLy8gaGVhZCBzZWVzIG1vcmUgYWNrcwogICAgICAgICAgaWYgKGFja3Muc2l6ZSA+IHByZXZBY2tzLnNpemUpIHJldHVybiB0cnVlCgogICAgICAgICAgZm9yIChjb25zdCBpZHggb2YgYWNrcykgewogICAgICAgICAgICAvLyBoZWFkIHNlZXMgYWNrcyB0aGF0IHdyaXRlciBkb2VzIG5vdAogICAgICAgICAgICBpZiAoIXByZXZBY2tzLmhhcyhpZHgpKSByZXR1cm4gdHJ1ZQogICAgICAgICAgfQoKICAgICAgICAgIC8vIGJvdGggc2Vlbiwgbm8gcG9pbnQgZ29pbmcgYW55IGZ1cnRoZXIgZG93bgogICAgICAgICAgaWYgKHByZXZBY2tzLnNpemUgJiYgYWNrcy5zaXplKSBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgc3RhY2sucHVzaCguLi5ub2RlLmRlcGVuZGVuY2llcykKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgLyogRnVsbCBEQUcgbWV0aG9kcyAqLwoKICBfeWllbGQobm9kZXMsIGluZGV4ZWQgPSBbXSkgewogICAgY29uc3Qgb2Zmc2V0ID0gaW5kZXhlZC5sZW5ndGgKICAgIGNvbnN0IHRhaWxzID0gW10KCiAgICAvLyBkZXRlcm1pbmUgd2hpY2ggbm9kZXMgYXJlIHlpZWxkZWQKICAgIHdoaWxlIChub2Rlcy5sZW5ndGgpIHsKICAgICAgY29uc3Qgbm9kZSA9IG5vZGVzLnBvcCgpCgogICAgICBpZiAobm9kZS55aWVsZGluZykgY29udGludWUKICAgICAgbm9kZS55aWVsZGluZyA9IHRydWUKCiAgICAgIGlmIChub2RlLmlzVGFpbCgpKSB0YWlscy5wdXNoKG5vZGUpCgogICAgICBub2Rlcy5wdXNoKC4uLm5vZGUuZGVwZW5kZW5jaWVzKQogICAgfQoKICAgIHdoaWxlICh0YWlscy5sZW5ndGgpIHsKICAgICAgbGV0IHRhaWwgPSB0YWlscy5wb3AoKQoKICAgICAgZm9yICh0YWlsIG9mIHRoaXMuX3JlbW92ZUJhdGNoKHRhaWwpKSB7CiAgICAgICAgVG9wb2xpc3QuYWRkKHRhaWwsIGluZGV4ZWQsIG9mZnNldCkKICAgICAgfQoKICAgICAgZm9yIChjb25zdCBkZXAgb2YgdGFpbC5kZXBlbmRlbnRzKSB7CiAgICAgICAgaWYgKGRlcC5pc1RhaWwoKSAmJiBkZXAueWllbGRpbmcpIHRhaWxzLnB1c2goZGVwKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGluZGV4ZWQKICB9CgogIF9pc0Z1dHVyZVRhaWwobm9kZSkgewogICAgbGV0IGRyb3BwZWQgPSBub2RlLmRyb3BwZWQKCiAgICAvLyBhIHRhaWwgaGFzIG5vIHVueWllbGRlZCBkZXBlbmRlbmNpZXMKICAgIGZvciAoY29uc3QgZGVwIG9mIG5vZGUuZGVwZW5kZW5jaWVzKSB7CiAgICAgIGlmIChkZXAueWllbGRlZCkgY29udGludWUKICAgICAgaWYgKGRyb3BwZWQgPT09IDApIHJldHVybiBmYWxzZQogICAgICBkcm9wcGVkLS0KICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3JlbW92ZU5vZGUobm9kZSkgewogICAgdGhpcy50YWlscy5kZWxldGUobm9kZSkKICAgIHRoaXMuaGVhZHMuZGVsZXRlKG5vZGUpCiAgICB0aGlzLmNvbnNlbnN1cy5yZW1vdmUobm9kZSkKCiAgICAvLyB1cGRhdGUgdGhlIHRhaWxzZXQKICAgIGZvciAoY29uc3QgZCBvZiBub2RlLmRlcGVuZGVudHMpIHsKICAgICAgaWYgKGQueWllbGRpbmcgJiYgZC5kZXBlbmRlbmNpZXMuaGFzKG5vZGUpKQogICAgICAgIGQuZHJvcHBlZCsrIC8vIGtlZXAgbGlua3MgZm9yIHRoZSBpbmRleGVkIGJhdGNoCiAgICAgIGVsc2UgZC5kZXBlbmRlbmNpZXMuZGVsZXRlKG5vZGUpCiAgICAgIGlmICh0aGlzLl9pc0Z1dHVyZVRhaWwoZCkpIHRoaXMudGFpbHMuYWRkKGQpCiAgICB9CgogICAgbm9kZS55aWVsZGVkID0gdHJ1ZQogICAgdGhpcy5zaXplLS0KCiAgICBpZiAodGhpcy5oZWFkcy5zaXplID09PSAwKSB7CiAgICAgIC8vIGluIGNhc2Ugb2YgYSBzaW5nbGUgd3JpdGVyIHRoZSBkYWcgbWlnaHQgZHJhaW4gaW1tZWRpYXRlbHkuLi4KICAgICAgdGhpcy5faW5pdGlhbEhlYWRzLnB1c2goeyBrZXk6IG5vZGUud3JpdGVyLmNvcmUua2V5LCBsZW5ndGg6IG5vZGUubGVuZ3RoIH0pCiAgICB9CgogICAgcmV0dXJuIG5vZGUKICB9CgogIF9yZW1vdmVCYXRjaChub2RlKSB7CiAgICBjb25zdCBiYXRjaCA9IFt0aGlzLl9yZW1vdmVOb2RlKG5vZGUpXQoKICAgIHdoaWxlIChub2RlLmJhdGNoICE9PSAxKSB7CiAgICAgIC8vIGl0cyBhIGJhdGNoIQogICAgICBpZiAobm9kZS5kZXBlbmRlbnRzLnNpemUgPT09IDApIHsKICAgICAgICAvLyBiYWQgYmF0Y2ggbm9kZSwgYXV0byBjb3JyZWN0CiAgICAgICAgY29uc3QgbmV4dCA9IG5vZGUud3JpdGVyLmdldChub2RlLmxlbmd0aCkKICAgICAgICBpZiAobmV4dCAmJiBuZXh0LmJhdGNoID09PSBub2RlLmJhdGNoIC0gMSkgbm9kZS5kZXBlbmRlbnRzLmFkZChuZXh0KQogICAgICB9CgogICAgICBhc3NlcnQobm9kZS5kZXBlbmRlbnRzLnNpemUgPT09IDEsICdCYXRjaCBpcyBsaW5rZWQgcGFydGlhbGx5LCB3aGljaCBpcyBub3QgYWxsb3dlZCcpCgogICAgICBub2RlID0gZ2V0Rmlyc3Qobm9kZS5kZXBlbmRlbnRzKQogICAgICBiYXRjaC5wdXNoKHRoaXMuX3JlbW92ZU5vZGUobm9kZSkpCiAgICB9CgogICAgcmV0dXJuIGJhdGNoCiAgfQp9CgpmdW5jdGlvbiB0aWVCcmVhayhhLCBiKSB7CiAgcmV0dXJuIFRvcG9saXN0LmNvbXBhcmUoYSwgYikgPCAwIC8vIGxvd2VzdCBrZXkgd2lzCn0KCmZ1bmN0aW9uIGdldEZpcnN0KHNldCkgewogIHJldHVybiBzZXRbU3ltYm9sLml0ZXJhdG9yXSgpLm5leHQoKS52YWx1ZQp9CgpmdW5jdGlvbiBzYW1lTm9kZShhLCBiKSB7CiAgcmV0dXJuIGI0YS5lcXVhbHMoYS5rZXksIGIud3JpdGVyLmNvcmUua2V5KSAmJiBhLmxlbmd0aCA9PT0gYi5sZW5ndGgKfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBtZXNzYWdlcyA9IHJlcXVpcmUoJy4vbWVzc2FnZXMuanMnKQoKY29uc3QgR1RFID0gYjRhLmZyb20oW21lc3NhZ2VzLkxJTkVBUklaRVJfUFJFRklYXSkKY29uc3QgTFQgPSBiNGEuZnJvbShbbWVzc2FnZXMuTElORUFSSVpFUl9QUkVGSVggKyAxXSkKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgTG9jYWxTdGF0ZSB7CiAgY29uc3RydWN0b3IoY29yZSkgewogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy50eCA9IG51bGwKICB9CgogIHN0YXRpYyBjbGVhcihjb3JlKSB7CiAgICBjb25zdCB0eCA9IGNvcmUuc3RhdGUuc3RvcmFnZS53cml0ZSgpCiAgICB0eC5kZWxldGVMb2NhbFJhbmdlKEdURSwgTFQpCiAgICByZXR1cm4gdHguZmx1c2goKQogIH0KCiAgc3RhdGljIGFzeW5jIG1vdmVUbyhzcmMsIGRzdCkgewogICAgY29uc3QgYm9vdCA9IGF3YWl0IHNyYy5nZXRVc2VyRGF0YSgnYXV0b2Jhc2UvYm9vdCcpCiAgICBjb25zdCB0eCA9IGRzdC5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKCiAgICB0eC5kZWxldGVMb2NhbFJhbmdlKEdURSwgTFQpCgogICAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIHNyYy5zdGF0ZS5zdG9yYWdlLmNyZWF0ZUxvY2FsU3RyZWFtKHsgZ3RlOiBHVEUsIGx0OiBMVCB9KSkgewogICAgICB0eC5wdXRMb2NhbChkYXRhLmtleSwgZGF0YS52YWx1ZSkKICAgIH0KCiAgICB0eC5wdXRVc2VyRGF0YSgnYXV0b2Jhc2UvYm9vdCcsIGJvb3QpCgogICAgYXdhaXQgdHguZmx1c2goKQogIH0KCiAgc2V0Qm9vdFJlY29yZChib290KSB7CiAgICBpZiAodGhpcy50eCA9PT0gbnVsbCkgdGhpcy50eCA9IHRoaXMuY29yZS5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKCiAgICB0aGlzLnR4LnB1dFVzZXJEYXRhKCdhdXRvYmFzZS9ib290JywgYy5lbmNvZGUobWVzc2FnZXMuQm9vdFJlY29yZCwgYm9vdCkpCiAgfQoKICBhc3luYyBsaXN0VXBkYXRlcygpIHsKICAgIGNvbnN0IHVwZGF0ZXMgPSBbXQoKICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiB0aGlzLmNvcmUuc3RhdGUuc3RvcmFnZS5jcmVhdGVMb2NhbFN0cmVhbSh7IGd0ZTogR1RFLCBsdDogTFQgfSkpIHsKICAgICAgY29uc3QgdXBkYXRlID0gYy5kZWNvZGUobWVzc2FnZXMuTGluZWFyaXplclVwZGF0ZSwgZGF0YS52YWx1ZSkKICAgICAgY29uc3Qgc2VxID0gYy5kZWNvZGUobWVzc2FnZXMuTGluZWFyaXplcktleSwgZGF0YS5rZXkpCiAgICAgIHVwZGF0ZS5zZXEgPSBzZXEKICAgICAgdXBkYXRlcy5wdXNoKHVwZGF0ZSkKICAgIH0KCiAgICByZXR1cm4gdXBkYXRlcwogIH0KCiAgY2xlYXJVcGRhdGVzKCkgewogICAgaWYgKHRoaXMudHggPT09IG51bGwpIHRoaXMudHggPSB0aGlzLmNvcmUuc3RhdGUuc3RvcmFnZS53cml0ZSgpCgogICAgdGhpcy50eC5kZWxldGVMb2NhbFJhbmdlKEdURSwgTFQpCiAgfQoKICBkZWxldGVVcGRhdGUodXBkYXRlKSB7CiAgICBpZiAodGhpcy50eCA9PT0gbnVsbCkgdGhpcy50eCA9IHRoaXMuY29yZS5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKCiAgICB0aGlzLnR4LmRlbGV0ZUxvY2FsKGMuZW5jb2RlKG1lc3NhZ2VzLkxpbmVhcml6ZXJLZXksIHVwZGF0ZS5zZXEpKQogIH0KCiAgaW5zZXJ0VXBkYXRlKHVwZGF0ZSkgewogICAgaWYgKHRoaXMudHggPT09IG51bGwpIHRoaXMudHggPSB0aGlzLmNvcmUuc3RhdGUuc3RvcmFnZS53cml0ZSgpCgogICAgdGhpcy50eC5wdXRMb2NhbCgKICAgICAgYy5lbmNvZGUobWVzc2FnZXMuTGluZWFyaXplcktleSwgdXBkYXRlLnNlcSksCiAgICAgIGMuZW5jb2RlKG1lc3NhZ2VzLkxpbmVhcml6ZXJVcGRhdGUsIHVwZGF0ZSkKICAgICkKICB9CgogIGZsdXNoKCkgewogICAgaWYgKCF0aGlzLnR4KSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKCiAgICBjb25zdCBmbHVzaGluZyA9IHRoaXMudHguZmx1c2goKQogICAgdGhpcy50eCA9IG51bGwKICAgIHJldHVybiBmbHVzaGluZwogIH0KfQpjb25zdCBzY2hlbWEgPSByZXF1aXJlKCcuLi9lbmNvZGluZy9zcGVjL2F1dG9iYXNlJykKCm1vZHVsZS5leHBvcnRzID0gewogIFdha2V1cDogc2NoZW1hLnJlc29sdmVTdHJ1Y3QoJ0BhdXRvYmFzZS93YWtldXAnKSwKICBDbG9jazogc2NoZW1hLnJlc29sdmVTdHJ1Y3QoJ0BhdXRvYmFzZS9jbG9jaycpLAogIENoZWNrb3V0OiBzY2hlbWEucmVzb2x2ZVN0cnVjdCgnQGF1dG9iYXNlL2NoZWNrb3V0JyksCiAgQm9vdFJlY29yZDogc2NoZW1hLnJlc29sdmVTdHJ1Y3QoJ0BhdXRvYmFzZS9ib290LXJlY29yZCcpLAogIE9wbG9nTWVzc2FnZTogc2NoZW1hLnJlc29sdmVTdHJ1Y3QoJ0BhdXRvYmFzZS9vcGxvZy1tZXNzYWdlJyksCiAgQ2hlY2twb2ludDogc2NoZW1hLnJlc29sdmVTdHJ1Y3QoJ0BhdXRvYmFzZS9jaGVja3BvaW50JyksCiAgSW5mbzogc2NoZW1hLnJlc29sdmVTdHJ1Y3QoJ0BhdXRvYmFzZS9pbmZvJyksCiAgTWVtYmVyOiBzY2hlbWEucmVzb2x2ZVN0cnVjdCgnQGF1dG9iYXNlL21lbWJlcicpLAogIE1hbmlmZXN0RGF0YTogc2NoZW1hLnJlc29sdmVTdHJ1Y3QoJ0BhdXRvYmFzZS9tYW5pZmVzdC1kYXRhJyksCiAgTElORUFSSVpFUl9QUkVGSVg6IDEsCiAgTGluZWFyaXplcktleTogc2NoZW1hLnJlc29sdmVTdHJ1Y3QoJ0BhdXRvYmFzZS9saW5lYXJpemVyLWtleScpLAogIExpbmVhcml6ZXJVcGRhdGU6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvbGluZWFyaXplci11cGRhdGUnKSwKICBFbmNyeXB0aW9uRGVzY3JpcHRvcjogc2NoZW1hLnJlc29sdmVTdHJ1Y3QoJ0BhdXRvYmFzZS9lbmNyeXB0aW9uLWRlc2NyaXB0b3InKQp9CmNvbnN0IERFRkFVTFRfU0laRSA9IDMyCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIE5vZGVCdWZmZXIgewogIGNvbnN0cnVjdG9yKG9mZnNldCwgaHdtKSB7CiAgICB0aGlzLmh3bSA9IGh3bSB8fCBERUZBVUxUX1NJWkUKICAgIHRoaXMuZGVmYXVsdEh3bSA9IHRoaXMuaHdtCiAgICB0aGlzLm1hc2sgPSB0aGlzLmh3bSAtIDEKICAgIHRoaXMudG9wID0gMAogICAgdGhpcy5idG0gPSAwCiAgICB0aGlzLmJ1ZmZlciA9IG5ldyBBcnJheSh0aGlzLmh3bSkKICAgIHRoaXMub2Zmc2V0ID0gb2Zmc2V0IHx8IDAKICAgIHRoaXMubGVuZ3RoID0gdGhpcy5vZmZzZXQKICB9CgogIGdldCBzaXplKCkgewogICAgcmV0dXJuIHRoaXMubGVuZ3RoIC0gdGhpcy5vZmZzZXQKICB9CgogIGlzRW1wdHkoKSB7CiAgICByZXR1cm4gdGhpcy5sZW5ndGggPT09IHRoaXMub2Zmc2V0CiAgfQoKICBpc0Z1bGwoKSB7CiAgICByZXR1cm4gdGhpcy5zaXplID09PSB0aGlzLmJ1ZmZlci5sZW5ndGgKICB9CgogIGdyb3coKSB7CiAgICB0aGlzLmh3bSA8PD0gMQoKICAgIGNvbnN0IHNpemUgPSB0aGlzLnNpemUKICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBBcnJheSh0aGlzLmh3bSkKICAgIGNvbnN0IG1hc2sgPSB0aGlzLmh3bSAtIDEKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNpemU7IGkrKykgewogICAgICBidWZmZXJbaV0gPSB0aGlzLmJ1ZmZlclsodGhpcy5idG0gKyBpKSAmIHRoaXMubWFza10KICAgIH0KCiAgICB0aGlzLm1hc2sgPSBtYXNrCiAgICB0aGlzLnRvcCA9IHNpemUKICAgIHRoaXMuYnRtID0gMAogICAgdGhpcy5idWZmZXIgPSBidWZmZXIKICB9CgogIHB1c2goZGF0YSkgewogICAgaWYgKHRoaXMuaXNGdWxsKCkpIHRoaXMuZ3JvdygpCgogICAgdGhpcy5idWZmZXJbdGhpcy50b3BdID0gZGF0YQogICAgdGhpcy50b3AgPSAodGhpcy50b3AgKyAxKSAmIHRoaXMubWFzawoKICAgIHJldHVybiB0aGlzLmxlbmd0aCsrCiAgfQoKICBzaGlmdCgpIHsKICAgIGlmICh0aGlzLmlzRW1wdHkoKSkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBsYXN0ID0gdGhpcy5idWZmZXJbdGhpcy5idG1dCgogICAgdGhpcy5idWZmZXJbdGhpcy5idG1dID0gdW5kZWZpbmVkCiAgICB0aGlzLmJ0bSA9ICh0aGlzLmJ0bSArIDEpICYgdGhpcy5tYXNrCiAgICB0aGlzLm9mZnNldCsrCgogICAgLy8gcmVzZXQgb24gZW1wdHkKICAgIGlmICh0aGlzLmlzRW1wdHkoKSAmJiB0aGlzLmh3bSAhPT0gdGhpcy5kZWZhdWx0SHdtKSB7CiAgICAgIHRoaXMuYnVmZmVyID0gbmV3IEFycmF5KHRoaXMuZGVmYXVsdEh3bSkKICAgICAgdGhpcy5od20gPSB0aGlzLmJ1ZmZlci5sZW5ndGgKICAgICAgdGhpcy5tYXNrID0gdGhpcy5od20gLSAxCiAgICAgIHRoaXMudG9wID0gdGhpcy5idG0gPSAwCiAgICB9CgogICAgcmV0dXJuIGxhc3QKICB9CgogIGdldChzZXEpIHsKICAgIGlmIChzZXEgPCB0aGlzLm9mZnNldCB8fCBzZXEgPj0gdGhpcy5sZW5ndGgpIHJldHVybiBudWxsCiAgICByZXR1cm4gdGhpcy5idWZmZXJbKHRoaXMuYnRtICsgKHNlcSAtIHRoaXMub2Zmc2V0KSkgJiB0aGlzLm1hc2tdCiAgfQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IEh5cGVyY29yZSA9IHJlcXVpcmUoJ2h5cGVyY29yZScpCgpjb25zdCBtZXNzYWdlcyA9IHJlcXVpcmUoJy4vbWVzc2FnZXMuanMnKQoKY29uc3QgREVGQVVMVF9NQU5JRkVTVF9WRVJTSU9OID0gMQpjb25zdCBJTkRFWF9WRVJTSU9OID0gMQpjb25zdCBNQVhfVFJBQ0VfUEVSX1ZJRVcgPSAyNTYKCmNvbnN0IEVNUFRZID0gYjRhLmFsbG9jKDApCgpjb25zdCBbTlNfU0lHTkVSX05BTUVTUEFDRV0gPSBjcnlwdG8ubmFtZXNwYWNlKCdhdXRvYmFzZScsIDEpCgpjbGFzcyBWaWV3Q29yZSB7CiAgY29uc3RydWN0b3IobmFtZSwgY29yZSwgYmFzZSkgewogICAgdGhpcy5uYW1lID0gbmFtZQogICAgdGhpcy5jb3JlID0gbnVsbAogICAgdGhpcy5iYXRjaCA9IG51bGwKICAgIHRoaXMuYXRvbWljQmF0Y2ggPSBudWxsCiAgICB0aGlzLnRyYWNlciA9IG5ldyBUcmFjZXIoKQoKICAgIHRoaXMubWlncmF0ZWQoYmFzZSwgY29yZSkKICB9CgogIGdldENvcmUoKSB7CiAgICByZXR1cm4gdGhpcy5hdG9taWNCYXRjaCB8fCB0aGlzLmJhdGNoIHx8IHRoaXMuY29yZQogIH0KCiAgbWlncmF0ZWQoYmFzZSwgY29yZSkgewogICAgLy8gVE9ETzogY2xvc2Ugb2xkIGNvcmUgaWYgcHJlc2VudCwgZm9yIG5vdyB3ZSBqdXN0IGNsb3NlIHdoZW4gdGhlIGF1dG9iYXNlIGlzIGNsb3NlZCBpbmRpcmVjdGx5CiAgICAvLyBhdG0gaXRzIHVuc2FmZSB0byBkbyBhcyBtb3ZlVG8gaGFzIGEgYnVnIGR1ZSB0byBhIG1pc3NpbmcgcmVhZCBsb2NrIGluIGhjCiAgICB0aGlzLmNvcmUgPSBjb3JlCgogICAgaWYgKHRoaXMubmFtZSA9PT0gJ19zeXN0ZW0nKSB7CiAgICAgIGNvbnN0IGZmID0gYmFzZS5fcXVldWVGYXN0Rm9yd2FyZC5iaW5kKGJhc2UpCiAgICAgIHRoaXMuY29yZS5vbignYXBwZW5kJywgZmYpCiAgICAgIHRoaXMuY29yZS5yZWFkeSgpLnRoZW4oZmYsIGZmKQogICAgfQogIH0KCiAgYXN5bmMgbWF0Y2hlc0tleShrZXkpIHsKICAgIGlmICghdGhpcy5jb3JlLm9wZW5lZCkgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKICAgIHJldHVybiBiNGEuZXF1YWxzKHRoaXMuY29yZS5rZXksIGtleSkKICB9CgogIGFzeW5jIG1hdGNoZXNOYW1lc3BhY2UodGFyZ2V0KSB7CiAgICBpZiAoIXRoaXMuY29yZS5vcGVuZWQpIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCgogICAgaWYgKHRoaXMuY29yZS5tYW5pZmVzdCAmJiB0aGlzLmNvcmUubWFuaWZlc3Quc2lnbmVycy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG5zID0gdGhpcy5jb3JlLm1hbmlmZXN0LnNpZ25lcnNbMF0ubmFtZXNwYWNlCiAgICAgIGlmIChiNGEuZXF1YWxzKG5zLCB0YXJnZXQpKSByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgYXN5bmMgY29tbWl0KGF0b20sIGxlbmd0aCwgc2lnbmF0dXJlKSB7CiAgICAvLyBUT0RPOiBpcyB0aGlzIGhvdyBpdHMgc3VwcG9zZWQgYmUgZG9uZSBhdG9taWMgd2lzZT8KICAgIGF3YWl0IHRoaXMuY29yZS5jb21taXQodGhpcy5fZ2V0QXRvbWljQmF0Y2goYXRvbSksIHsgbGVuZ3RoLCBzaWduYXR1cmUgfSkKICB9CgogIGFzeW5jIHJlbGVhc2UoKSB7CiAgICBpZiAoIXRoaXMuYXRvbWljQmF0Y2gpIHJldHVybgogICAgYXdhaXQgdGhpcy5hdG9taWNCYXRjaC5yZWFkeSgpCiAgICBjb25zdCBzZXNzaW9ucyA9IHRoaXMuYXRvbWljQmF0Y2guc3RhdGUuc2Vzc2lvbnMKICAgIGZvciAobGV0IGkgPSBzZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBpZiAoIXNlc3Npb25zW2ldKSBicmVhayAvLyBjbG9zZWQgYmVmb3JlIHVzCiAgICAgIGF3YWl0IHNlc3Npb25zW2ldLmNsb3NlKCkKICAgIH0KICAgIGF3YWl0IHRoaXMuYXRvbWljQmF0Y2guY2xvc2UoKQogICAgdGhpcy5hdG9taWNCYXRjaCA9IG51bGwKICB9CgogIF9nZXRBdG9taWNCYXRjaChhdG9tKSB7CiAgICBpZiAodGhpcy5hdG9taWNCYXRjaCA9PT0gbnVsbCkgewogICAgICB0aGlzLmF0b21pY0JhdGNoID0gdGhpcy5iYXRjaC5zZXNzaW9uKHsgYXRvbSwgd3JpdGFibGU6IHRydWUgfSkKICAgIH0KCiAgICByZXR1cm4gdGhpcy5hdG9taWNCYXRjaAogIH0KCiAgYXN5bmMgY2F0Y2h1cChhdG9tLCBsZW5ndGgpIHsKICAgIGF3YWl0IHRoaXMucmVsZWFzZSgpCiAgICBjb25zdCBiYXRjaCA9IHRoaXMuX2dldEF0b21pY0JhdGNoKGF0b20pCiAgICBhd2FpdCBiYXRjaC5yZWFkeSgpCiAgICBhd2FpdCBiYXRjaC5zdGF0ZS5jYXRjaHVwKGxlbmd0aCkKICB9CgogIGNyZWF0ZVNlc3Npb24oYXRvbSwgdmFsdWVFbmNvZGluZykgewogICAgaWYgKHRoaXMuYmF0Y2ggPT09IG51bGwpIHsKICAgICAgdGhpcy5iYXRjaCA9IHRoaXMuY29yZS5zZXNzaW9uKHsgbmFtZTogJ2JhdGNoJywgd3JpdGFibGU6IHRydWUgfSkKICAgIH0KCiAgICBjb25zdCBzID0gYXRvbQogICAgICA/IHRoaXMuX2dldEF0b21pY0JhdGNoKGF0b20pLnNlc3Npb24oewogICAgICAgICAgdmFsdWVFbmNvZGluZywKICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgb25zZXE6IHRoaXMudHJhY2VyLm9uc2VxLmJpbmQodGhpcy50cmFjZXIpCiAgICAgICAgfSkKICAgICAgOiB0aGlzLmJhdGNoLnNlc3Npb24oeyB2YWx1ZUVuY29kaW5nLCB3cml0YWJsZTogZmFsc2UgfSkKCiAgICByZXR1cm4gcwogIH0KfQoKY2xhc3MgVHJhY2VyIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlCiAgICB0aGlzLnNlZW4gPSBuZXcgU2V0KCkKICB9CgogIHN0YXJ0KCkgewogICAgdGhpcy5lbmFibGVkID0gdHJ1ZQogICAgdGhpcy5zZWVuLmNsZWFyKCkKICB9CgogIGVuZCgpIHsKICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlCiAgICByZXR1cm4gWy4uLnRoaXMuc2Vlbi52YWx1ZXMoKV0KICB9CgogIG9uc2VxKHNlcSwgY29yZSkgewogICAgaWYgKCF0aGlzLmVuYWJsZWQpIHJldHVybgogICAgaWYgKHRoaXMuc2Vlbi5zaXplID49IE1BWF9UUkFDRV9QRVJfVklFVykgcmV0dXJuCiAgICBpZiAoc2VxID49IGNvcmUuc2lnbmVkTGVuZ3RoKSByZXR1cm4KCiAgICB0aGlzLnNlZW4uYWRkKHNlcSkKICB9Cn0KCmNsYXNzIEF1dG9TdG9yZSB7CiAgY29uc3RydWN0b3IoYmFzZSwgYnlOYW1lKSB7CiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgICB0aGlzLnN0b3JlID0gYmFzZS5zdG9yZQogICAgdGhpcy5ieU5hbWUgPSBieU5hbWUgfHwgbmV3IE1hcCgpCiAgICB0aGlzLm9wZW5lZCA9IFtdCiAgICB0aGlzLmF0b20gPSBudWxsCiAgICB0aGlzLmxvY2FsID0gbnVsbAogIH0KCiAgYXN5bmMgY2xvc2UoKSB7CiAgICBpZiAodGhpcy5sb2NhbCkgYXdhaXQgdGhpcy5sb2NhbC5jbG9zZSgpCiAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy5ieU5hbWUudmFsdWVzKCkpIHsKICAgICAgYXdhaXQgdi5yZWxlYXNlKCkKICAgIH0KICAgIGlmICh0aGlzLmF0b20pIHJldHVybgogICAgZm9yIChjb25zdCB2IG9mIHRoaXMuYnlOYW1lLnZhbHVlcygpKSB7CiAgICAgIGlmICh2LmNvcmUpIGF3YWl0IHYuY29yZS5jbG9zZSgpCiAgICAgIGlmICh2LmJhdGNoKSBhd2FpdCB2LmJhdGNoLmNsb3NlKCkKICAgIH0KICB9CgogIGFzeW5jIGV4cG9ydCgpIHsKICAgIGNvbnN0IHZpZXdzID0gW10KCiAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZV0gb2YgdGhpcy5ieU5hbWUpIHsKICAgICAgY29uc3QgY29yZSA9IGF3YWl0IHRoaXMuc3RvcmUuc3RvcmFnZS5leHBvcnQodmFsdWUuY29yZS5kaXNjb3ZlcnlLZXksIHsgYmF0Y2hlczogdHJ1ZSB9KQogICAgICB2aWV3cy5wdXNoKHsgbmFtZSwgY29yZSB9KQogICAgfQoKICAgIHJldHVybiB2aWV3cwogIH0KCiAgYXRvbWl6ZSgpIHsKICAgIGNvbnN0IHN0b3JlID0gbmV3IEF1dG9TdG9yZSh0aGlzLmJhc2UsIHRoaXMuYnlOYW1lKQogICAgc3RvcmUuYXRvbSA9IHRoaXMuc3RvcmUuc3RvcmFnZS5jcmVhdGVBdG9tKCkKICAgIHJldHVybiBzdG9yZQogIH0KCiAgYXN5bmMgdXBkYXRlTG9jYWwoKSB7CiAgICBpZiAoIXRoaXMubG9jYWwpIHJldHVybgogICAgYXdhaXQgdGhpcy5sb2NhbC5jbG9zZSgpCiAgICB0aGlzLmxvY2FsID0gbnVsbAogIH0KCiAgZmx1c2goKSB7CiAgICByZXR1cm4gdGhpcy5hdG9tID8gdGhpcy5hdG9tLmZsdXNoKCkgOiBQcm9taXNlLnJlc29sdmUoKQogIH0KCiAgZ2V0KG9wdHMsIG1vcmVPcHRzKSB7CiAgICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBuYW1lOiBvcHRzIH0KICAgIGlmIChtb3JlT3B0cykgb3B0cyA9IHsgLi4ub3B0cywgLi4ubW9yZU9wdHMgfQoKICAgIGNvbnN0IHsgbmFtZSwgdmFsdWVFbmNvZGluZyA9IG51bGwgfSA9IG9wdHMKCiAgICBpZiAoIW5hbWUpIHRocm93IG5ldyBFcnJvcignbmFtZSBpcyByZXF1aXJlZCcpCiAgICByZXR1cm4gdGhpcy5nZXRWaWV3QnlOYW1lKG5hbWUpLmNyZWF0ZVNlc3Npb24odGhpcy5hdG9tLCB2YWx1ZUVuY29kaW5nKQogIH0KCiAgZ2V0Vmlld0J5TmFtZShuYW1lKSB7CiAgICBsZXQgdmlldyA9IHRoaXMuYnlOYW1lLmdldChuYW1lKQoKICAgIGlmICghdmlldykgewogICAgICBjb25zdCBwcmVsb2FkID0gdGhpcy5fcHJlbG9hZChuYW1lKQogICAgICBjb25zdCBjb3JlID0gdGhpcy5iYXNlLnN0b3JlLmdldCh7IHByZWxvYWQgfSkKICAgICAgdmlldyA9IG5ldyBWaWV3Q29yZShuYW1lLCBjb3JlLCB0aGlzLmJhc2UpCiAgICAgIHRoaXMuYnlOYW1lLnNldChuYW1lLCB2aWV3KQogICAgfQoKICAgIGlmICh0aGlzLm9wZW5lZC5pbmRleE9mKHZpZXcpID09PSAtMSkgewogICAgICB0aGlzLm9wZW5lZC5wdXNoKHZpZXcpCiAgICB9CgogICAgcmV0dXJuIHZpZXcKICB9CgogIGdldExvY2FsKCkgewogICAgaWYgKHRoaXMubG9jYWwgIT09IG51bGwpIHJldHVybiB0aGlzLmxvY2FsCgogICAgdGhpcy5sb2NhbCA9IHRoaXMuYmFzZS5sb2NhbC5zZXNzaW9uKHsKICAgICAgYXRvbTogdGhpcy5hdG9tLAogICAgICB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UsCiAgICAgIGVuY3J5cHRpb246IHRoaXMuYmFzZS5nZXRXcml0ZXJFbmNyeXB0aW9uKHRoaXMuYmFzZS5sb2NhbC5rZXkpLAogICAgICBhY3RpdmU6IGZhbHNlCiAgICB9KQoKICAgIHJldHVybiB0aGlzLmxvY2FsCiAgfQoKICBnZXRWaWV3cygpIHsKICAgIHJldHVybiBbLi4udGhpcy5ieU5hbWUudmFsdWVzKCldCiAgfQoKICBnZXRWaWV3Q291bnQoKSB7CiAgICByZXR1cm4gdGhpcy5ieU5hbWUuc2l6ZQogIH0KCiAgZ2V0U3lzdGVtVmlldygpIHsKICAgIHJldHVybiB0aGlzLmdldFZpZXdCeU5hbWUoJ19zeXN0ZW0nKQogIH0KCiAgZ2V0U3lzdGVtQ29yZSgpIHsKICAgIHJldHVybiB0aGlzLmdldFN5c3RlbVZpZXcoKS5jb3JlCiAgfQoKICBnZXRFbmNyeXB0aW9uKG5hbWUpIHsKICAgIGlmICghdGhpcy5iYXNlLmVuY3J5cHRpb25LZXkpIHJldHVybiBudWxsCiAgICBpZiAobmFtZSA9PT0gJ19lbmNyeXB0aW9uJykgcmV0dXJuIG51bGwKCiAgICByZXR1cm4gdGhpcy5iYXNlLmVuY3J5cHRpb24uZ2V0Vmlld0VuY3J5cHRpb24obmFtZSkKICB9CgogIGFzeW5jIGdldEluZGV4ZXJNYW5pZmVzdHMoZW50cmllcykgewogICAgY29uc3QgbWFuaWZlc3RzID0gW10KICAgIGZvciAoY29uc3QgeyBrZXkgfSBvZiBlbnRyaWVzKSB7CiAgICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7IGtleSwgYWN0aXZlOiBmYWxzZSB9KQogICAgICBhd2FpdCBjb3JlLnJlYWR5KCkKICAgICAgaWYgKCFjb3JlLm1hbmlmZXN0KSBjb250aW51ZSAvLyBkYW5nZXIgYnV0IG9ubHkgZm9yIGJvb3RzdHJhcHBpbmcuLi4KICAgICAgbWFuaWZlc3RzLnB1c2goY29yZS5tYW5pZmVzdCkKICAgICAgYXdhaXQgY29yZS5jbG9zZSgpCiAgICB9CiAgICByZXR1cm4gbWFuaWZlc3RzCiAgfQoKICBnZXRWaWV3Q29yZShpbmRleGVyTWFuaWZlc3RzLCBuYW1lLCBwcm9sb2d1ZSwgbWFuaWZlc3RWZXJzaW9uLCBlbnRyb3B5LCBsaW5rZWQsIG1hbmlmZXN0RGF0YSkgewogICAgY29uc3QgbWFuaWZlc3QgPSB0aGlzLl9jcmVhdGVNYW5pZmVzdCgKICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgbmFtZSwKICAgICAgcHJvbG9ndWUsCiAgICAgIG1hbmlmZXN0VmVyc2lvbiwKICAgICAgZW50cm9weSwKICAgICAgbGlua2VkLAogICAgICBtYW5pZmVzdERhdGEKICAgICkKCiAgICByZXR1cm4gdGhpcy5iYXNlLnN0b3JlLmdldCh7CiAgICAgIG1hbmlmZXN0LAogICAgICBleGNsdXNpdmU6IGZhbHNlLAogICAgICBlbmNyeXB0aW9uOiB0aGlzLmdldEVuY3J5cHRpb24obmFtZSkKICAgIH0pCiAgfQoKICBsaXN0Vmlld3MoKSB7CiAgICBjb25zdCB2aWV3cyA9IFtdCiAgICBmb3IgKGNvbnN0IFtuYW1lLCByZWZdIG9mIHRoaXMuYnlOYW1lKSB7CiAgICAgIGNvbnN0IGNvcmUgPSByZWYuYmF0Y2ggfHwgcmVmLmNvcmUKICAgICAgdmlld3MucHVzaCh7IG5hbWUsIGtleTogY29yZS5rZXksIGxlbmd0aDogY29yZS5sZW5ndGgsIHNpZ25lZExlbmd0aDogY29yZS5zaWduZWRMZW5ndGggfSkKICAgIH0KICAgIHJldHVybiB2aWV3cwogIH0KCiAgY3JlYXRlQW5jaG9yQ29yZShwcm9sb2d1ZSwgbWFuaWZlc3REYXRhKSB7CiAgICBjb25zdCBtYW5pZmVzdCA9IHsKICAgICAgdmVyc2lvbjogMiwKICAgICAgaGFzaDogJ2JsYWtlMmInLAogICAgICBwcm9sb2d1ZSwKICAgICAgYWxsb3dQYXRjaDogZmFsc2UsCiAgICAgIHF1b3J1bTogMCwKICAgICAgc2lnbmVyczogW10sCiAgICAgIHVzZXJEYXRhOiBtYW5pZmVzdERhdGEsCiAgICAgIGxpbmtlZDogbnVsbAogICAgfQoKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7CiAgICAgIG1hbmlmZXN0LAogICAgICBhY3RpdmU6IGZhbHNlCiAgICB9KQoKICAgIHJldHVybiBjb3JlCiAgfQoKICBhc3luYyBjcmVhdGVWaWV3KAogICAgaW5kZXhlck1hbmlmZXN0cywKICAgIG5hbWUsCiAgICBwcm9sb2d1ZSwKICAgIG1hbmlmZXN0VmVyc2lvbiwKICAgIGVudHJvcHksCiAgICBsaW5rZWQsCiAgICBtYW5pZmVzdERhdGEKICApIHsKICAgIGNvbnN0IG1hbmlmZXN0ID0gdGhpcy5fY3JlYXRlTWFuaWZlc3QoCiAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgIG5hbWUsCiAgICAgIHByb2xvZ3VlLAogICAgICBtYW5pZmVzdFZlcnNpb24sCiAgICAgIGVudHJvcHksCiAgICAgIGxpbmtlZCwKICAgICAgbWFuaWZlc3REYXRhCiAgICApCgogICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsKICAgICAga2V5OiBIeXBlcmNvcmUua2V5KG1hbmlmZXN0KSwKICAgICAgbWFuaWZlc3QsCiAgICAgIGFjdGl2ZTogZmFsc2UKICAgIH0pCgogICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICBjb25zdCBrZXkgPSBjb3JlLmtleQoKICAgIGF3YWl0IGNvcmUuY2xvc2UoKQogICAgcmV0dXJuIGtleQogIH0KCiAgYXN5bmMgX3ByZWxvYWQobmFtZSkgewogICAgYXdhaXQgUHJvbWlzZS5yZXNvbHZlKCkKCiAgICBpZiAoIXRoaXMuYmFzZS5vcGVuaW5nKSB0aHJvdyBuZXcgRXJyb3IoJ0F1dG9iYXNlIGZhaWxlZCB0byBvcGVuJykKICAgIGF3YWl0IHRoaXMuYmFzZS5fcHJlb3BlbgoKICAgIGNvbnN0IGJvb3QgPSAoYXdhaXQgdGhpcy5iYXNlLl9nZXRTeXN0ZW1JbmZvKCkpIHx8IHsKICAgICAga2V5OiB0aGlzLmdldEJvb3RzdHJhcFN5c3RlbUtleSgpLAogICAgICBpbmRleGVyczogW10sCiAgICAgIHZpZXdzOiBbXSwKICAgICAgZW50cm9weTogbnVsbAogICAgfQogICAgY29uc3QgaW5kZXhlck1hbmlmZXN0cyA9IGF3YWl0IHRoaXMuZ2V0SW5kZXhlck1hbmlmZXN0cyhib290LmluZGV4ZXJzKQoKICAgIC8vIG5vIHN5c3RlbSwgZXZlcnl0aGluZyBpcyBmcmVzaAogICAgaWYgKGJvb3QuaW5kZXhlcnMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB0aGlzLl9mcmVzaENvcmVQcmVsb2FkKGluZGV4ZXJNYW5pZmVzdHMsIG5hbWUsIGJvb3QuZW50cm9weSkKICAgIH0KCiAgICAvLyBhc2tpbmcgZm9yIHRoZSBzeXN0ZW0sIGp1c3QgcmV0dXJuIGl0LCBlYXN5CiAgICBpZiAobmFtZSA9PT0gJ19zeXN0ZW0nKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAga2V5OiBib290LmtleSwKICAgICAgICBleGNsdXNpdmU6IGZhbHNlLAogICAgICAgIGVuY3J5cHRpb246IHRoaXMuZ2V0RW5jcnlwdGlvbihuYW1lKQogICAgICB9CiAgICB9CgogICAgaWYgKG5hbWUgPT09ICdfZW5jcnlwdGlvbicpIHsKICAgICAgY29uc3QgY29yZSA9IHRoaXMuZ2V0U3lzdGVtQ29yZSgpCiAgICAgIGF3YWl0IGNvcmUucmVhZHkoKQoKICAgICAgaWYgKCFjb3JlLm1hbmlmZXN0LmxpbmtlZCkgewogICAgICAgIHJldHVybiB0aGlzLl9mcmVzaENvcmVQcmVsb2FkKGluZGV4ZXJNYW5pZmVzdHMsIG5hbWUsIGJvb3QuZW50cm9weSkKICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICBrZXk6IGNvcmUubWFuaWZlc3QubGlua2VkWzBdLAogICAgICAgIGV4Y2x1c2l2ZTogZmFsc2UsCiAgICAgICAgZW5jcnlwdGlvbjogbnVsbAogICAgICB9CiAgICB9CgogICAgLy8gaW5mZXIgd2hpY2ggdmlldwogICAgY29uc3QgdiA9IGF3YWl0IHRoaXMuZmluZFZpZXdCeU5hbWUoaW5kZXhlck1hbmlmZXN0cywgYm9vdC52aWV3cywgbmFtZSwgYm9vdC5lbnRyb3B5KQoKICAgIC8vIG5ldyB2aWV3LCBmcmVzaAogICAgaWYgKHYgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIHRoaXMuX2ZyZXNoQ29yZVByZWxvYWQoaW5kZXhlck1hbmlmZXN0cywgbmFtZSwgYm9vdC5lbnRyb3B5KQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGtleTogdi5rZXksCiAgICAgIGV4Y2x1c2l2ZTogZmFsc2UsCiAgICAgIGVuY3J5cHRpb246IHRoaXMuZ2V0RW5jcnlwdGlvbihuYW1lKQogICAgfQogIH0KCiAgX2ZyZXNoQ29yZVByZWxvYWQoaW5kZXhlck1hbmlmZXN0cywgbmFtZSwgZW50cm9weSkgewogICAgaWYgKG5hbWUgPT09ICdfc3lzdGVtJykgcmV0dXJuIHRoaXMuX2ZyZXNoU3lzdGVtUHJlbG9hZChpbmRleGVyTWFuaWZlc3RzLCBlbnRyb3B5KQoKICAgIHJldHVybiB7CiAgICAgIG1hbmlmZXN0OiB0aGlzLl9jcmVhdGVNYW5pZmVzdCgKICAgICAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgICAgIG5hbWUsCiAgICAgICAgbnVsbCwKICAgICAgICBERUZBVUxUX01BTklGRVNUX1ZFUlNJT04sCiAgICAgICAgZW50cm9weSwKICAgICAgICBbXSwKICAgICAgICBudWxsCiAgICAgICksCiAgICAgIGV4Y2x1c2l2ZTogdHJ1ZSwKICAgICAgZW5jcnlwdGlvbjogdGhpcy5nZXRFbmNyeXB0aW9uKG5hbWUpCiAgICB9CiAgfQoKICBfZnJlc2hTeXN0ZW1QcmVsb2FkKGluZGV4ZXJNYW5pZmVzdHMsIGVudHJvcHkpIHsKICAgIHJldHVybiB7CiAgICAgIG1hbmlmZXN0OiB0aGlzLl9jcmVhdGVTeXN0ZW1NYW5pZmVzdCgKICAgICAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgICAgIG51bGwsCiAgICAgICAgREVGQVVMVF9NQU5JRkVTVF9WRVJTSU9OLAogICAgICAgIGVudHJvcHksCiAgICAgICAgbnVsbAogICAgICApLAogICAgICBleGNsdXNpdmU6IHRydWUsCiAgICAgIGVuY3J5cHRpb246IHRoaXMuZ2V0RW5jcnlwdGlvbignX3N5c3RlbScpCiAgICB9CiAgfQoKICBfZGVyaXZlU3RhdGljSGFzaChuYW1lKSB7CiAgICAvLyBrZXkgZG9lc250IG1hdHRlci4uLgogICAgcmV0dXJuIGNyeXB0by5oYXNoKFt0aGlzLmJhc2Uua2V5LCBiNGEuZnJvbShuYW1lKV0pCiAgfQoKICBfZGVyaXZlTmFtZXNwYWNlKG5hbWUsIGVudHJvcHkpIHsKICAgIGNvbnN0IGVuY3J5cHRpb25JZCA9IGNyeXB0by5oYXNoKHRoaXMuYmFzZS5lbmNyeXB0aW9uS2V5IHx8IEVNUFRZKQogICAgY29uc3QgdmVyc2lvbiA9IGMuZW5jb2RlKGMudWludCwgSU5ERVhfVkVSU0lPTikKICAgIGNvbnN0IGJvb3RzdHJhcCA9IHRoaXMuYmFzZS5rZXkKCiAgICByZXR1cm4gY3J5cHRvLmhhc2goWwogICAgICBOU19TSUdORVJfTkFNRVNQQUNFLAogICAgICB2ZXJzaW9uLAogICAgICBib290c3RyYXAsCiAgICAgIGVuY3J5cHRpb25JZCwKICAgICAgZW50cm9weSwKICAgICAgYjRhLmZyb20obmFtZSkKICAgIF0pCiAgfQoKICBhc3luYyBfZ2V0Q29yZU1hbmlmZXN0KGtleSkgewogICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsga2V5LCBhY3RpdmU6IGZhbHNlIH0pCiAgICBhd2FpdCBjb3JlLnJlYWR5KCkKICAgIGNvbnN0IG1hbmlmZXN0ID0gY29yZS5tYW5pZmVzdAogICAgYXdhaXQgY29yZS5jbG9zZSgpCiAgICByZXR1cm4gbWFuaWZlc3QKICB9CgogIGdldEJvb3RzdHJhcFN5c3RlbUtleSgpIHsKICAgIHJldHVybiBIeXBlcmNvcmUua2V5KHRoaXMuX2NyZWF0ZVN5c3RlbU1hbmlmZXN0KFtdLCBudWxsLCBERUZBVUxUX01BTklGRVNUX1ZFUlNJT04sIG51bGwpKQogIH0KCiAgYXN5bmMgZmluZFZpZXdCeUtleShrZXksIGluZGV4ZXJzLCBtYW5pZmVzdFZlcnNpb24sIGVudHJvcHkpIHsKICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLmJ5TmFtZS52YWx1ZXMoKSkgewogICAgICBpZiAoYXdhaXQgdi5tYXRjaGVzS2V5KGtleSkpIHJldHVybiB2CiAgICB9CgogICAgY29uc3QgbWFuaWZlc3QgPSBhd2FpdCB0aGlzLl9nZXRDb3JlTWFuaWZlc3Qoa2V5KQogICAgY29uc3QgdGFyZ2V0ID0gbWFuaWZlc3QgJiYgbWFuaWZlc3Quc2lnbmVycy5sZW5ndGggPyBtYW5pZmVzdC5zaWduZXJzWzBdLm5hbWVzcGFjZSA6IG51bGwKCiAgICBpZiAodGFyZ2V0KSB7CiAgICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLmJ5TmFtZS52YWx1ZXMoKSkgewogICAgICAgIGlmIChhd2FpdCB2Lm1hdGNoZXNOYW1lc3BhY2UodGFyZ2V0KSkgcmV0dXJuIHYKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGluZGV4ZXJNYW5pZmVzdHMgPSBhd2FpdCB0aGlzLmdldEluZGV4ZXJNYW5pZmVzdHMoaW5kZXhlcnMpCgogICAgaWYgKGVudHJvcHkgPT09IG51bGwpIHsKICAgICAgZW50cm9weSA9IGluZGV4ZXJNYW5pZmVzdHNbMF0uc2lnbmVyc1swXS5uYW1lc3BhY2UKICAgIH0KCiAgICBpZiAodGFyZ2V0KSB7CiAgICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLmJ5TmFtZS52YWx1ZXMoKSkgewogICAgICAgIGNvbnN0IG5hbWVzcGFjZSA9IHRoaXMuX2Rlcml2ZU5hbWVzcGFjZSh2Lm5hbWUsIGVudHJvcHkpCiAgICAgICAgaWYgKGI0YS5lcXVhbHMobmFtZXNwYWNlLCB0YXJnZXQpKSByZXR1cm4gdgogICAgICB9CiAgICB9CgogICAgLy8gcHJvYiB0aGUgZW1wdHkgcHJvbG9ndWUsIHdlIGRvbnQgaGF2ZSBtYW5pZmVzdCBmb3IgdGhvc2UgaW4gRkYgaWYgbGVuPTAKICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLmJ5TmFtZS52YWx1ZXMoKSkgewogICAgICBjb25zdCBtYW5pZmVzdERhdGEgPSB2LmNvcmUgPyB2LmNvcmUubWFuaWZlc3QudXNlckRhdGEgOiBudWxsCiAgICAgIGNvbnN0IG1hbmlmZXN0ID0gdGhpcy5fY3JlYXRlTWFuaWZlc3QoCiAgICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgICB2Lm5hbWUsCiAgICAgICAgbnVsbCwKICAgICAgICBtYW5pZmVzdFZlcnNpb24sCiAgICAgICAgZW50cm9weSwKICAgICAgICBbXSwKICAgICAgICBtYW5pZmVzdERhdGEKICAgICAgKQogICAgICBjb25zdCBtYW5pZmVzdEtleSA9IEh5cGVyY29yZS5rZXkobWFuaWZlc3QpCgogICAgICBpZiAoIWI0YS5lcXVhbHMobWFuaWZlc3RLZXksIGtleSkpIGNvbnRpbnVlCgogICAgICAvLyB3ZSBkaWRudCBoYXZlIHRoZSBjb3JlISB0aGlzIGlzIGJlY2F1c2UgaXQgaXMgZW1wdHksIGVuc3VyZSBpdHMgb24gZGlzawogICAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoeyBrZXk6IG1hbmlmZXN0S2V5LCBtYW5pZmVzdCwgYWN0aXZlOiBmYWxzZSB9KQogICAgICBhd2FpdCBjb3JlLnJlYWR5KCkKICAgICAgYXdhaXQgY29yZS5jbG9zZSgpCgogICAgICByZXR1cm4gdgogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBhc3luYyBmaW5kVmlld0J5TmFtZShpbmRleGVyTWFuaWZlc3RzLCB2aWV3cywgbmFtZSwgZW50cm9weSkgewogICAgaWYgKGluZGV4ZXJNYW5pZmVzdHMubGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbAoKICAgIGlmIChlbnRyb3B5ID09PSBudWxsKSBlbnRyb3B5ID0gaW5kZXhlck1hbmlmZXN0c1swXS5zaWduZXJzWzBdLm5hbWVzcGFjZQogICAgY29uc3QgbmFtZXNwYWNlID0gdGhpcy5fZGVyaXZlTmFtZXNwYWNlKG5hbWUsIGVudHJvcHkpCgogICAgZm9yIChjb25zdCB2IG9mIHZpZXdzKSB7CiAgICAgIGNvbnN0IG1hbmlmZXN0ID0gYXdhaXQgdGhpcy5fZ2V0Q29yZU1hbmlmZXN0KHYua2V5KQogICAgICBpZiAobWFuaWZlc3Quc2lnbmVycy5sZW5ndGggPT09IDApIGNvbnRpbnVlCgogICAgICBjb25zdCBzaWduZXIgPSBtYW5pZmVzdC5zaWduZXJzWzBdCgogICAgICBpZiAoYjRhLmVxdWFscyhzaWduZXIubmFtZXNwYWNlLCBuYW1lc3BhY2UpKSByZXR1cm4gdgogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBfY3JlYXRlTWFuaWZlc3QoaW5kZXhlck1hbmlmZXN0cywgbmFtZSwgcHJvbG9ndWUsIHZlcnNpb24sIGVudHJvcHksIGxpbmtlZCwgbWFuaWZlc3REYXRhKSB7CiAgICBpZiAoIWluZGV4ZXJNYW5pZmVzdHMubGVuZ3RoKSB7CiAgICAgIHByb2xvZ3VlID0gewogICAgICAgIGhhc2g6IHRoaXMuX2Rlcml2ZVN0YXRpY0hhc2gobmFtZSksCiAgICAgICAgbGVuZ3RoOiAwCiAgICAgIH0KICAgIH0gZWxzZSBpZiAocHJvbG9ndWUgJiYgcHJvbG9ndWUubGVuZ3RoID09PSAwKSB7CiAgICAgIC8vIGp1c3QgaW4gY2FzZQogICAgICBwcm9sb2d1ZSA9IG51bGwKICAgIH0KCiAgICBjb25zdCBzaWduZXJzID0gW10KCiAgICBpZiAoaW5kZXhlck1hbmlmZXN0cy5sZW5ndGggJiYgZW50cm9weSA9PT0gbnVsbCkgewogICAgICBlbnRyb3B5ID0gaW5kZXhlck1hbmlmZXN0c1swXS5zaWduZXJzWzBdLm5hbWVzcGFjZQogICAgfQoKICAgIGZvciAoY29uc3QgbWFuaWZlc3Qgb2YgaW5kZXhlck1hbmlmZXN0cykgewogICAgICBjb25zdCBzaWduZXIgPSBtYW5pZmVzdC5zaWduZXJzWzBdCgogICAgICBzaWduZXJzLnB1c2goewogICAgICAgIG5hbWVzcGFjZTogdGhpcy5fZGVyaXZlTmFtZXNwYWNlKG5hbWUsIGVudHJvcHkpLAogICAgICAgIHNpZ25hdHVyZTogJ2VkMjU1MTknLAogICAgICAgIHB1YmxpY0tleTogc2lnbmVyLnB1YmxpY0tleQogICAgICB9KQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb24sCiAgICAgIGhhc2g6ICdibGFrZTJiJywKICAgICAgcHJvbG9ndWUsCiAgICAgIGFsbG93UGF0Y2g6IHRydWUsCiAgICAgIHF1b3J1bTogTWF0aC5taW4oc2lnbmVycy5sZW5ndGgsIChzaWduZXJzLmxlbmd0aCA+PiAxKSArIDEpLAogICAgICBzaWduZXJzLAogICAgICB1c2VyRGF0YTogbWFuaWZlc3REYXRhLAogICAgICBsaW5rZWQ6IHZlcnNpb24gPiAxID8gbGlua2VkIDogbnVsbAogICAgfQogIH0KCiAgX2NyZWF0ZVN5c3RlbU1hbmlmZXN0KGluZGV4ZXJNYW5pZmVzdHMsIHByb2xvZ3VlLCB2ZXJzaW9uLCBlbnRyb3B5LCBtYW5pZmVzdERhdGEpIHsKICAgIGlmIChwcm9sb2d1ZSAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdDYW4gb25seSBkZXJpdmUgZnJlc2ggc3lzdGVtIGNvcmUnKQoKICAgIGNvbnN0IGxpbmtlZCA9IFtdCgogICAgaWYgKHZlcnNpb24gPiBERUZBVUxUX01BTklGRVNUX1ZFUlNJT04pIHsKICAgICAgY29uc3QgZW5jTWFuaWZlc3QgPSB0aGlzLl9jcmVhdGVNYW5pZmVzdCgKICAgICAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgICAgICdfZW5jcnlwdGlvbicsCiAgICAgICAgbnVsbCwKICAgICAgICB2ZXJzaW9uLAogICAgICAgIGVudHJvcHksCiAgICAgICAgW10sCiAgICAgICAgbWFuaWZlc3REYXRhCiAgICAgICkKICAgICAgbGlua2VkLnB1c2goSHlwZXJjb3JlLmtleShlbmNNYW5pZmVzdCkpCiAgICB9CgogICAgcmV0dXJuIHRoaXMuX2NyZWF0ZU1hbmlmZXN0KAogICAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgICAnX3N5c3RlbScsCiAgICAgIG51bGwsCiAgICAgIHZlcnNpb24sCiAgICAgIGVudHJvcHksCiAgICAgIGxpbmtlZCwKICAgICAgbWFuaWZlc3REYXRhCiAgICApCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IEF1dG9TdG9yZQpjb25zdCBIeXBlcmJlZSA9IHJlcXVpcmUoJ2h5cGVyYmVlJykKY29uc3QgU3ViRW5jb2RlciA9IHJlcXVpcmUoJ3N1Yi1lbmNvZGVyJykKY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKCmNvbnN0IHsgSW5mbywgTWVtYmVyIH0gPSByZXF1aXJlKCcuL21lc3NhZ2VzLmpzJykKY29uc3QgeyBERUZBVUxUX0FVVE9CQVNFX1ZFUlNJT04gfSA9IHJlcXVpcmUoJy4vY2Fwcy5qcycpCgpjb25zdCBzdWJzID0gbmV3IFN1YkVuY29kZXIoKQoKY29uc3QgRElHRVNUID0gc3Vicy5zdWIoYjRhLmZyb20oWzBdKSkKY29uc3QgTUVNQkVSUyA9IHN1YnMuc3ViKGI0YS5mcm9tKFsxXSkpCgpjb25zdCBJTkZPX0tFWSA9IERJR0VTVC5lbmNvZGUoJ2luZm8nKQoKY29uc3QgW0dFTkVTSVNfRU5UUk9QWSwgTlNfRU5UUk9QWV0gPSBjcnlwdG8ubmFtZXNwYWNlKCdhdXRvYmFzZS9lbnRyb3B5JywgMikKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU3lzdGVtVmlldyBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yKGNvcmUsIHsgY2hlY2tvdXQgPSAwLCBlbXB0eSA9IGZhbHNlIH0gPSB7fSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuY29yZSA9IGNvcmUKCiAgICAvLyBzZXNzaW9ucyBpcyBhIHdvcmthcm91bmQgZm9yIGJhdGNoZXMgbm90IGhhdmluZyBzZXNzaW9ucyBhdG0uLi4KICAgIHRoaXMuZGIgPSBuZXcgSHlwZXJiZWUoY29yZSwgewogICAgICBrZXlFbmNvZGluZzogJ2JpbmFyeScsCiAgICAgIGV4dGVuc2lvbjogZmFsc2UsCiAgICAgIGNoZWNrb3V0LAogICAgICBzZXNzaW9uczogdHlwZW9mIGNvcmUuc2Vzc2lvbiA9PT0gJ2Z1bmN0aW9uJwogICAgfSkKCiAgICB0aGlzLnZlcnNpb24gPSBERUZBVUxUX0FVVE9CQVNFX1ZFUlNJT04KICAgIHRoaXMubWVtYmVycyA9IDAKICAgIHRoaXMucGVuZGluZ0luZGV4ZXJzID0gW10KICAgIHRoaXMuaW5kZXhlcnMgPSBbXQogICAgdGhpcy5oZWFkcyA9IFtdCiAgICB0aGlzLnZpZXdzID0gW10KICAgIHRoaXMuZW5jcnlwdGlvbkxlbmd0aCA9IDAKICAgIHRoaXMuZW50cm9weSA9IG51bGwKCiAgICB0aGlzLmluZGV4ZXJVcGRhdGUgPSBmYWxzZQoKICAgIHRoaXMuX2VtcHR5ID0gZW1wdHkKICAgIHRoaXMuX2ZvcmsgPSAwCiAgICB0aGlzLl9sZW5ndGggPSAwCiAgICB0aGlzLl9jaGFuZ2VzID0gW10KICAgIHRoaXMuX2luZGV4ZXJNYXAgPSBuZXcgTWFwKCkKICAgIHRoaXMuX2Nsb2NrVXBkYXRlcyA9IG5ldyBNYXAoKQogIH0KCiAgc3RhdGljIEdFTkVTSVNfRU5UUk9QWSA9IEdFTkVTSVNfRU5UUk9QWQoKICBzdGF0aWMgYXN5bmMgZ2V0SW5kZXhlZEluZm8oY29yZSwgbGVuZ3RoKSB7CiAgICBjb25zdCBzeXMgPSBuZXcgdGhpcyhjb3JlLnNlc3Npb24oKSkKCiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgc3lzLmdldEluZGV4ZWRJbmZvKGxlbmd0aCkKICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IHN5cy5jbG9zZSgpCiAgICB9CiAgfQoKICBzdGF0aWMgYXN5bmMgKmZsdXNoZXMoY29yZSwgeyByZXZlcnNlLCBsdCA9IGNvcmUubGVuZ3RoLCBndGUgPSAwLCB3YWl0ID0gdHJ1ZSB9ID0ge30pIHsKICAgIGlmIChsdCA8PSAwKSByZXR1cm4KCiAgICAvLyBlbnN1cmUgYmxvY2sKICAgIGF3YWl0IGNvcmUuZ2V0KGx0IC0gMSkKICAgIGNvbnN0IHN5cyA9IG5ldyBTeXN0ZW1WaWV3KGNvcmUpCgogICAgdHJ5IHsKICAgICAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIHN5cy5kYi5jcmVhdGVIaXN0b3J5U3RyZWFtKHsgbHQsIGd0ZSwgd2FpdCwgcmV2ZXJzZTogdHJ1ZSB9KSkgewogICAgICAgIGlmICghYjRhLmVxdWFscyhkYXRhLmtleSwgSU5GT19LRVkpKSBjb250aW51ZQogICAgICAgIGNvbnN0IGluZm8gPSBjLmRlY29kZShJbmZvLCBkYXRhLnZhbHVlKQogICAgICAgIHlpZWxkIHsgbGVuZ3RoOiBkYXRhLnNlcSArIDEsIGluZm8gfQogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCBzeXMuY2xvc2UoKQogICAgfQogIH0KCiAgZ2V0IGJvb3RzdHJhcHBpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5tZW1iZXJzID09PSAwCiAgfQoKICBhc3luYyBjaGVja291dChsZW5ndGgpIHsKICAgIGNvbnN0IGNoZWNrb3V0ID0gbmV3IFN5c3RlbVZpZXcodGhpcy5jb3JlLnNlc3Npb24oKSwgewogICAgICBjaGVja291dDogbGVuZ3RoLAogICAgICBlbXB0eTogbGVuZ3RoID09PSAwCiAgICB9KQoKICAgIGF3YWl0IGNoZWNrb3V0LnJlYWR5KCkKCiAgICByZXR1cm4gY2hlY2tvdXQKICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgLy8gdGhpcyBzaG91bGQgTkVWRVIgZmFpbCwgaWYgc28gd2UgaGF2ZSBhIGJ1ZyBlbHNld2hlcmUgKHNob3VsZCBhbHdheXMgYmUgY29uc2lzdGVudCkKICAgIGNvbnN0IGluZm8gPSB0aGlzLl9lbXB0eQogICAgICA/IG51bGwKICAgICAgOiBhd2FpdCB0aGlzLmRiLmdldCgnaW5mbycsIHsKICAgICAgICAgIHZhbHVlRW5jb2Rpbmc6IEluZm8sCiAgICAgICAgICBrZXlFbmNvZGluZzogRElHRVNULAogICAgICAgICAgdXBkYXRlOiBmYWxzZSwKICAgICAgICAgIHdhaXQ6IGZhbHNlCiAgICAgICAgfSkKICAgIGF3YWl0IHRoaXMuX3Jlc2V0KGluZm8pCiAgfQoKICBhc3luYyBfY2xvc2UoKSB7CiAgICBhd2FpdCB0aGlzLmRiLmNsb3NlKCkKICB9CgogIGFzeW5jIGdldEluZGV4ZWRJbmZvKGxlbmd0aCA9IHRoaXMuY29yZS5zaWduZWRMZW5ndGgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIGlmIChsZW5ndGggPT09IHRoaXMuY29yZS5sZW5ndGgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uOiB0aGlzLnZlcnNpb24sCiAgICAgICAgbWVtYmVyczogdGhpcy5tZW1iZXJzLAogICAgICAgIHBlbmRpbmdJbmRleGVyczogdGhpcy5wZW5kaW5nSW5kZXhlcnMsCiAgICAgICAgaW5kZXhlcnM6IHRoaXMuaW5kZXhlcnMsCiAgICAgICAgaGVhZHM6IHRoaXMuaGVhZHMsCiAgICAgICAgdmlld3M6IHRoaXMudmlld3MsCiAgICAgICAgZW5jcnlwdGlvbkxlbmd0aDogdGhpcy5lbmNyeXB0aW9uTGVuZ3RoLAogICAgICAgIGVudHJvcHk6IHRoaXMuZW50cm9weQogICAgICB9CiAgICB9CgogICAgY29uc3Qgbm9kZSA9IGxlbmd0aCA9PT0gMCA/IG51bGwgOiBhd2FpdCB0aGlzLmRiLmdldEJ5U2VxKGxlbmd0aCAtIDEpCiAgICBpZiAobm9kZSA9PT0gbnVsbCkgewogICAgICByZXR1cm4gewogICAgICAgIHZlcnNpb246IERFRkFVTFRfQVVUT0JBU0VfVkVSU0lPTiwKICAgICAgICBtZW1iZXJzOiAwLAogICAgICAgIHBlbmRpbmdJbmRleGVyczogW10sCiAgICAgICAgaW5kZXhlcnM6IFtdLAogICAgICAgIGhlYWRzOiBbXSwKICAgICAgICB2aWV3czogW10sCiAgICAgICAgZW5jcnlwdGlvbkxlbmd0aDogMCwKICAgICAgICBlbnRyb3B5OiBudWxsCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYy5kZWNvZGUoSW5mbywgbm9kZS52YWx1ZSkKICB9CgogIHN0YXRpYyBzYW1lSW5kZXhlcnMoYSwgYikgewogICAgaWYgKGEubGVuZ3RoICE9PSBiLmxlbmd0aCkgcmV0dXJuIGZhbHNlCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICghYjRhLmVxdWFscyhhW2ldLmtleSwgYltpXS5jb3JlLmtleSkpIHJldHVybiBmYWxzZQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBzYW1lSW5kZXhlcnMoaW5kZXhlcnMpIHsKICAgIHJldHVybiBTeXN0ZW1WaWV3LnNhbWVJbmRleGVycyh0aGlzLmluZGV4ZXJzLCBpbmRleGVycykKICB9CgogIGFzeW5jIGhpc3Rvcnkoc2luY2UpIHsKICAgIGNvbnN0IGNoZWNrb3V0ID0gdGhpcy5kYi5jaGVja291dChzaW5jZSkKICAgIGNvbnN0IHNlZW4gPSBuZXcgTWFwKCkKCiAgICBjb25zdCBub2RlcyA9IFtdCiAgICBjb25zdCB1cGRhdGVzID0gW10KCiAgICBjb25zdCBjaGVja291dE5vZGUgPSBzaW5jZSA9PT0gMCA/IG51bGwgOiBhd2FpdCB0aGlzLmRiLmdldEJ5U2VxKHNpbmNlIC0gMSkKCiAgICBsZXQgcHJldkluZm8gPSBjaGVja291dE5vZGUgPT09IG51bGwgPyBudWxsIDogYy5kZWNvZGUoSW5mbywgY2hlY2tvdXROb2RlLnZhbHVlKQogICAgbGV0IHVwZGF0ZUJhdGNoID0gMAoKICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiB0aGlzLmRiLmNyZWF0ZUhpc3RvcnlTdHJlYW0oeyBndGU6IHNpbmNlIH0pKSB7CiAgICAgIGlmIChiNGEuZXF1YWxzKGRhdGEua2V5LCBJTkZPX0tFWSkpIHsKICAgICAgICBjb25zdCBpbmZvID0gYy5kZWNvZGUoSW5mbywgZGF0YS52YWx1ZSkKCiAgICAgICAgdXBkYXRlcy5wdXNoKHsKICAgICAgICAgIGJhdGNoOiB1cGRhdGVCYXRjaCwKICAgICAgICAgIGluZGV4ZXJzOiBwcmV2SW5mbyA9PT0gbnVsbCB8fCAhc2FtZUluZGV4ZXJzKGluZm8sIHByZXZJbmZvKSwKICAgICAgICAgIHN5c3RlbUxlbmd0aDogZGF0YS5zZXEgKyAxCiAgICAgICAgfSkKCiAgICAgICAgcHJldkluZm8gPSBpbmZvCiAgICAgICAgdXBkYXRlQmF0Y2ggPSAwCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgY29uc3Qga2V5ID0gZGF0YS5rZXkuc3ViYXJyYXkoMikKICAgICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpCiAgICAgIGNvbnN0IGxlbiA9IGMuZGVjb2RlKE1lbWJlciwgZGF0YS52YWx1ZSkubGVuZ3RoCgogICAgICBpZiAoIXNlZW4uaGFzKGhleCkpIHsKICAgICAgICBjb25zdCBub2RlID0gYXdhaXQgY2hlY2tvdXQuZ2V0KGRhdGEua2V5KQogICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICBzZWVuLnNldChoZXgsIDApCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IHsgbGVuZ3RoIH0gPSBjLmRlY29kZShNZW1iZXIsIG5vZGUudmFsdWUpCiAgICAgICAgICBzZWVuLnNldChoZXgsIGxlbmd0aCkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IHByZXYgPSBzZWVuLmdldChoZXgpCiAgICAgIGNvbnN0IGJhdGNoID0gbGVuIC0gcHJldgogICAgICBzZWVuLnNldChoZXgsIGxlbikKCiAgICAgIGlmIChiYXRjaCA9PT0gMCkgY29udGludWUKCiAgICAgIHVwZGF0ZUJhdGNoICs9IGJhdGNoCgogICAgICBpZiAobm9kZXMubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnN0IHRvcCA9IG5vZGVzW25vZGVzLmxlbmd0aCAtIDFdCiAgICAgICAgaWYgKGI0YS5lcXVhbHModG9wLmtleSwga2V5KSkgewogICAgICAgICAgdG9wLmxlbmd0aCA9IGxlbgogICAgICAgICAgdG9wLmJhdGNoICs9IGJhdGNoCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAgICAgfQoKICAgICAgbm9kZXMucHVzaCh7CiAgICAgICAga2V5LAogICAgICAgIGxlbmd0aDogbGVuLAogICAgICAgIGJhdGNoCiAgICAgIH0pCiAgICB9CgogICAgYXdhaXQgY2hlY2tvdXQuY2xvc2UoKQoKICAgIHJldHVybiB7IHVwZGF0ZXMsIG5vZGVzIH0KICB9CgogIGFzeW5jIHVwZGF0ZSgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIGlmICh0aGlzLl9mb3JrID09PSB0aGlzLmNvcmUuZm9yayAmJiB0aGlzLl9sZW5ndGggPT09IHRoaXMuY29yZS5sZW5ndGgpIHJldHVybiBmYWxzZQoKICAgIGF3YWl0IHRoaXMuX3Jlc2V0KAogICAgICB0aGlzLl9lbXB0eSA/IG51bGwgOiBhd2FpdCB0aGlzLmRiLmdldCgnaW5mbycsIHsgdmFsdWVFbmNvZGluZzogSW5mbywga2V5RW5jb2Rpbmc6IERJR0VTVCB9KQogICAgKQogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIF9yZXNldChpbmZvKSB7CiAgICB0aGlzLnZlcnNpb24gPSBpbmZvID09PSBudWxsID8gREVGQVVMVF9BVVRPQkFTRV9WRVJTSU9OIDogaW5mby52YWx1ZS52ZXJzaW9uCiAgICB0aGlzLm1lbWJlcnMgPSBpbmZvID09PSBudWxsID8gMCA6IGluZm8udmFsdWUubWVtYmVycwogICAgdGhpcy5wZW5kaW5nSW5kZXhlcnMgPSBpbmZvID09PSBudWxsID8gW10gOiBpbmZvLnZhbHVlLnBlbmRpbmdJbmRleGVycwogICAgdGhpcy5pbmRleGVycyA9IGluZm8gPT09IG51bGwgPyBbXSA6IGluZm8udmFsdWUuaW5kZXhlcnMKICAgIHRoaXMuaGVhZHMgPSBpbmZvID09PSBudWxsID8gW10gOiBpbmZvLnZhbHVlLmhlYWRzCiAgICB0aGlzLnZpZXdzID0gaW5mbyA9PT0gbnVsbCA/IFtdIDogaW5mby52YWx1ZS52aWV3cwogICAgdGhpcy5lbmNyeXB0aW9uTGVuZ3RoID0gaW5mbyA9PT0gbnVsbCA/IDAgOiBpbmZvLnZhbHVlLmVuY3J5cHRpb25MZW5ndGgKICAgIHRoaXMuZW50cm9weSA9IGluZm8gPT09IG51bGwgPyBudWxsIDogaW5mby52YWx1ZS5lbnRyb3B5CgogICAgdGhpcy5pbmRleGVyVXBkYXRlID0gZmFsc2UKICAgIHRoaXMuX2luZGV4ZXJNYXAuY2xlYXIoKQogICAgdGhpcy5fY2xvY2tVcGRhdGVzLmNsZWFyKCkKICAgIHRoaXMuX2xlbmd0aCA9IHRoaXMuY29yZS5sZW5ndGgKICAgIHRoaXMuX2ZvcmsgPSB0aGlzLmNvcmUuZm9yawogICAgdGhpcy5fY2hhbmdlcyA9IFtdCgogICAgZm9yIChjb25zdCBpZHggb2YgdGhpcy5pbmRleGVycykgewogICAgICB0aGlzLl9pbmRleGVyTWFwLnNldChiNGEudG9TdHJpbmcoaWR4LmtleSwgJ2hleCcpLCBpZHgpCiAgICB9CiAgfQoKICAvLyBoZWxwZXIgdXNlZCBieSBhcHBseS1zdGF0ZQogIGZsdXNoTGVuZ3RoKCkgewogICAgY29uc3QgaGVhZGVyID0gdGhpcy5jb3JlLmxlbmd0aCA/IDAgOiAxIC8vIGFjY291bnQgZm9yIGhlYWRlcgoKICAgIGxldCB1cGRhdGVzID0gdGhpcy5fY2hhbmdlcy5sZW5ndGggKyB0aGlzLl9jbG9ja1VwZGF0ZXMuc2l6ZQogICAgZm9yIChjb25zdCB7IGtleSB9IG9mIHRoaXMuX2NoYW5nZXMpIHsKICAgICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpCiAgICAgIGlmICh0aGlzLl9jbG9ja1VwZGF0ZXMuaGFzKGhleCkpIHVwZGF0ZXMtLSAvLyBzaGFyZWQgYXJlIHNraXBwZWQKICAgIH0KCiAgICByZXR1cm4gaGVhZGVyICsgdGhpcy5jb3JlLmxlbmd0aCArIHVwZGF0ZXMgKyAxCiAgfQoKICBhc3luYyBmbHVzaCh2aWV3cykgewogICAgY29uc3QgYmF0Y2ggPSB0aGlzLmRiLmJhdGNoKHsgdXBkYXRlOiBmYWxzZSB9KQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fY2hhbmdlcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjID0gdGhpcy5fY2hhbmdlc1tpXQogICAgICBpZiAodGhpcy5fY2xvY2tVcGRhdGVzLmhhcyhiNGEudG9TdHJpbmcoYy5rZXksICdoZXgnKSkpIGNvbnRpbnVlCiAgICAgIGF3YWl0IGJhdGNoLnB1dChjLmtleSwgYy52YWx1ZSwgeyB2YWx1ZUVuY29kaW5nOiBNZW1iZXIsIGtleUVuY29kaW5nOiBNRU1CRVJTIH0pCiAgICB9CgogICAgZm9yIChjb25zdCBbaGV4LCBsZW5ndGhdIG9mIHRoaXMuX2Nsb2NrVXBkYXRlcykgewogICAgICBjb25zdCBpc0luZGV4ZXIgPSB0aGlzLl9pbmRleGVyTWFwLmdldChoZXgpICE9PSB1bmRlZmluZWQKICAgICAgY29uc3Qga2V5ID0gYjRhLmZyb20oaGV4LCAnaGV4JykKCiAgICAgIGNvbnN0IGluZm8gPSBhd2FpdCB0aGlzLl9nZXQoa2V5LCAwKQoKICAgICAgY29uc3QgdmFsdWUgPSB7IGlzSW5kZXhlciwgaXNSZW1vdmVkOiBpbmZvID8gaW5mby5pc1JlbW92ZWQgOiB0cnVlLCBsZW5ndGggfQogICAgICBhd2FpdCBiYXRjaC5wdXQoa2V5LCB2YWx1ZSwgeyB2YWx1ZUVuY29kaW5nOiBNZW1iZXIsIGtleUVuY29kaW5nOiBNRU1CRVJTIH0pCiAgICB9CgogICAgaWYgKHRoaXMuaW5kZXhlclVwZGF0ZSkgewogICAgICB0aGlzLl9yZWZyZXNoRW50cm9weSh0aGlzLmNvcmUubGVuZ3RoICsgYmF0Y2gubGVuZ3RoICsgMSkKICAgIH0KCiAgICB0aGlzLl9jbG9ja1VwZGF0ZXMuY2xlYXIoKQoKICAgIGxldCBtYXhJbmRleCA9IC0xCiAgICBmb3IgKGNvbnN0IHZpZXcgb2Ygdmlld3MpIHsKICAgICAgaWYgKHZpZXcubWFwcGVkSW5kZXggPiBtYXhJbmRleCkgbWF4SW5kZXggPSB2aWV3Lm1hcHBlZEluZGV4CiAgICB9CgogICAgd2hpbGUgKHRoaXMudmlld3MubGVuZ3RoID4gbWF4SW5kZXggKyAxKSB0aGlzLnZpZXdzLnBvcCgpCgogICAgZm9yIChjb25zdCB2aWV3IG9mIHZpZXdzKSB7CiAgICAgIGNvbnN0IGxlbmd0aCA9IHZpZXcuY29yZSA/IHZpZXcuY29yZS5sZW5ndGggOiB2aWV3Lmxlbmd0aAogICAgICBpZiAoIWxlbmd0aCkgY29udGludWUKCiAgICAgIGNvbnN0IHYgPSB7IGtleTogdmlldy5rZXksIGxlbmd0aCB9CgogICAgICBpZiAodmlldy5tYXBwZWRJbmRleCAhPT0gLTEpIHsKICAgICAgICB0aGlzLnZpZXdzW3ZpZXcubWFwcGVkSW5kZXhdID0gdgogICAgICB9IGVsc2UgewogICAgICAgIHZpZXcubWFwcGVkSW5kZXggPSB0aGlzLnZpZXdzLnB1c2godikgLSAxCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBpbmZvID0gewogICAgICB2ZXJzaW9uOiB0aGlzLnZlcnNpb24sCiAgICAgIG1lbWJlcnM6IHRoaXMubWVtYmVycywKICAgICAgcGVuZGluZ0luZGV4ZXJzOiB0aGlzLnBlbmRpbmdJbmRleGVycywKICAgICAgaW5kZXhlcnM6IHRoaXMuaW5kZXhlcnMsCiAgICAgIGhlYWRzOiB0aGlzLmhlYWRzLAogICAgICB2aWV3czogdGhpcy52aWV3cywKICAgICAgZW5jcnlwdGlvbkxlbmd0aDogdGhpcy5lbmNyeXB0aW9uTGVuZ3RoLAogICAgICBlbnRyb3B5OiB0aGlzLmVudHJvcHkKICAgIH0KCiAgICBhd2FpdCBiYXRjaC5wdXQoJ2luZm8nLCBpbmZvLCB7IHZhbHVlRW5jb2Rpbmc6IEluZm8sIGtleUVuY29kaW5nOiBESUdFU1QgfSkKICAgIGF3YWl0IGJhdGNoLmZsdXNoKCkKCiAgICB0aGlzLl9sZW5ndGggPSB0aGlzLmNvcmUubGVuZ3RoIC8vIHNob3VsZCBiZSBvawogICAgdGhpcy5fY2hhbmdlcyA9IFtdCgogICAgaWYgKHRoaXMuaW5kZXhlclVwZGF0ZSkgdGhpcy5pbmRleGVyVXBkYXRlID0gZmFsc2UKICB9CgogIGdldEVudHJvcHkoaW5kZXhlcnMsIGxlbmd0aCkgewogICAgcmV0dXJuIGdlbmVyYXRlRW50cm9weShpbmRleGVycywgbGVuZ3RoLCB0aGlzLmVudHJvcHkpCiAgfQoKICBfcmVmcmVzaEVudHJvcHkobGVuZ3RoKSB7CiAgICBpZiAodGhpcy52ZXJzaW9uIDwgMikgcmV0dXJuCiAgICB0aGlzLmVudHJvcHkgPSB0aGlzLmdldEVudHJvcHkodGhpcy5pbmRleGVycywgbGVuZ3RoKQogIH0KCiAgY2hlY2twb2ludCgpIHsKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IHRoaXMudmVyc2lvbiwKICAgICAgbWVtYmVyczogdGhpcy5tZW1iZXJzLAogICAgICBwZW5kaW5nSW5kZXhlcnM6IHRoaXMucGVuZGluZ0luZGV4ZXJzLnNsaWNlKDApLAogICAgICBpbmRleGVyczogY2xvbmVOb2Rlcyh0aGlzLmluZGV4ZXJzKSwKICAgICAgaGVhZHM6IGNsb25lTm9kZXModGhpcy5oZWFkcyksCiAgICAgIHZpZXdzOiBjbG9uZU5vZGVzKHRoaXMudmlld3MpLAogICAgICBpbmRleGVyVXBkYXRlOiB0aGlzLmluZGV4ZXJVcGRhdGUsCiAgICAgIGVuY3J5cHRpb25MZW5ndGg6IHRoaXMuZW5jcnlwdGlvbkxlbmd0aCwKICAgICAgZW50cm9weTogdGhpcy5lbnRyb3B5ID8gYjRhLmZyb20odGhpcy5lbnRyb3B5KSA6IG51bGwsCiAgICAgIGNoYW5nZXM6IHRoaXMuX2NoYW5nZXMuc2xpY2UoMCksCiAgICAgIGNsb2NrVXBkYXRlczogbmV3IE1hcChbLi4udGhpcy5fY2xvY2tVcGRhdGVzXSkKICAgIH0KICB9CgogIGFwcGx5Q2hlY2twb2ludChjaGVja3BvaW50KSB7CiAgICB0aGlzLnZlcnNpb24gPSBjaGVja3BvaW50LnZlcnNpb24KICAgIHRoaXMubWVtYmVycyA9IGNoZWNrcG9pbnQubWVtYmVycwogICAgdGhpcy5wZW5kaW5nSW5kZXhlcnMgPSBjaGVja3BvaW50LnBlbmRpbmdJbmRleGVycwogICAgdGhpcy5pbmRleGVycyA9IGNoZWNrcG9pbnQuaW5kZXhlcnMKICAgIHRoaXMuaGVhZHMgPSBjaGVja3BvaW50LmhlYWRzCiAgICB0aGlzLnZpZXdzID0gY2hlY2twb2ludC52aWV3cwogICAgdGhpcy5pbmRleGVyVXBkYXRlID0gY2hlY2twb2ludC5pbmRleGVyVXBkYXRlCiAgICB0aGlzLmVuY3J5cHRpb25MZW5ndGggPSBjaGVja3BvaW50LmVuY3J5cHRpb25MZW5ndGgKICAgIHRoaXMuZW50cm9weSA9IGNoZWNrcG9pbnQuZW50cm9weQoKICAgIHRoaXMuX2NoYW5nZXMgPSBjaGVja3BvaW50LmNoYW5nZXMKICAgIHRoaXMuX2Nsb2NrVXBkYXRlcyA9IGNoZWNrcG9pbnQuY2xvY2tVcGRhdGVzCgogICAgdGhpcy5faW5kZXhlck1hcCA9IG5ldyBNYXAoKQogICAgZm9yIChjb25zdCBpZHggb2YgdGhpcy5pbmRleGVycykgewogICAgICB0aGlzLl9pbmRleGVyTWFwLnNldChiNGEudG9TdHJpbmcoaWR4LmtleSwgJ2hleCcpLCBpZHgpCiAgICB9CiAgfQoKICBhZGRIZWFkKG5vZGUpIHsKICAgIGNvbnN0IGggPSB7IGtleTogbm9kZS53cml0ZXIuY29yZS5rZXksIGxlbmd0aDogbm9kZS5sZW5ndGggfQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5oZWFkcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBoZWFkID0gdGhpcy5oZWFkc1tpXQoKICAgICAgaWYgKCFoYXNEZXBlbmRlbmN5KG5vZGUsIGhlYWQpKSB7CiAgICAgICAgaWYgKCFiNGEuZXF1YWxzKG5vZGUud3JpdGVyLmNvcmUua2V5LCBoZWFkLmtleSkpIGNvbnRpbnVlCgogICAgICAgIC8vIHRvZG86IHJlbW92ZSBpbiBuZXh0IG1ham9yIGJlY2F1c2UgYnVnIHdhcyBmaXhlZCBoZXJlOgogICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9hdXRvYmFzZS1uZXh0L3B1bGwvMjM3CgogICAgICAgIC8vIGZpbHRlciBvdXQgYW55IGJhZCBoZWFkcyBpbnRyb2R1Y2VkIGJ5IGEgYnVnIHRvCiAgICAgICAgLy8gcHJldmVudCBpbmNvbnNpc3RlbmNpZXMgYmVpbmcgd3JpdHRlbiB0byB0aGUgb3Bsb2cKICAgICAgICBpZiAoaGVhZC5sZW5ndGggPiBoLmxlbmd0aCkgcmV0dXJuIGZhbHNlCiAgICAgIH0KCiAgICAgIGNvbnN0IHBvcHBlZCA9IHRoaXMuaGVhZHMucG9wKCkKICAgICAgaWYgKHBvcHBlZCAhPT0gaGVhZCkgdGhpcy5oZWFkc1tpLS1dID0gcG9wcGVkCiAgICB9CgogICAgdGhpcy5oZWFkcy5wdXNoKGgpCgogICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGgua2V5LCAnaGV4JykKCiAgICB0aGlzLl9jbG9ja1VwZGF0ZXMuc2V0KGhleCwgaC5sZW5ndGgpCgogICAgaWYgKHRoaXMucGVuZGluZ0luZGV4ZXJzLmxlbmd0aCA+IDApIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBlbmRpbmdJbmRleGVycy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICghYjRhLmVxdWFscyh0aGlzLnBlbmRpbmdJbmRleGVyc1tpXSwgaC5rZXkpKSBjb250aW51ZQogICAgICAgIHRoaXMuX3VwZGF0ZUluZGV4ZXIoaC5rZXksIGgubGVuZ3RoLCB0cnVlLCBpKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBpZHggPSB0aGlzLl9pbmRleGVyTWFwLmdldChoZXgpCiAgICBpZiAoaWR4ICE9PSB1bmRlZmluZWQpIHsKICAgICAgaWR4Lmxlbmd0aCA9IGgubGVuZ3RoCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBfdXBkYXRlSW5kZXhlcihrZXksIGxlbmd0aCwgaXNJbmRleGVyLCBpKSB7CiAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykKCiAgICBpZiAoIWlzSW5kZXhlcikgewogICAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuX2luZGV4ZXJNYXAuZ2V0KGhleCkKICAgICAgaWYgKGV4aXN0aW5nKSB7CiAgICAgICAgdGhpcy5pbmRleGVyVXBkYXRlID0gdHJ1ZQogICAgICAgIHRoaXMuaW5kZXhlcnMuc3BsaWNlKHRoaXMuaW5kZXhlcnMuaW5kZXhPZihleGlzdGluZyksIDEpCiAgICAgICAgdGhpcy5faW5kZXhlck1hcC5kZWxldGUoaGV4KQogICAgICB9CiAgICAgIHJldHVybgogICAgfQoKICAgIGZvciAoOyBpIDwgdGhpcy5wZW5kaW5nSW5kZXhlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGI0YS5lcXVhbHModGhpcy5wZW5kaW5nSW5kZXhlcnNbaV0sIGtleSkpIHsKICAgICAgICBicmVhawogICAgICB9CiAgICB9CgogICAgaWYgKGxlbmd0aCA9PT0gMCkgewogICAgICBpZiAoaSA+PSB0aGlzLnBlbmRpbmdJbmRleGVycy5sZW5ndGgpIHRoaXMucGVuZGluZ0luZGV4ZXJzLnB1c2goa2V5KQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoaSA8IHRoaXMucGVuZGluZ0luZGV4ZXJzLmxlbmd0aCkgewogICAgICBjb25zdCB0b3AgPSB0aGlzLnBlbmRpbmdJbmRleGVycy5wb3AoKQogICAgICBpZiAoaSA8IHRoaXMucGVuZGluZ0luZGV4ZXJzLmxlbmd0aCkgdGhpcy5wZW5kaW5nSW5kZXhlcnNbaV0gPSB0b3AKICAgIH0KCiAgICBjb25zdCBpZHggPSB0aGlzLl9pbmRleGVyTWFwLmdldChoZXgpCgogICAgaWYgKGlkeCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGNvbnN0IG5ld0lkeCA9IHsga2V5LCBsZW5ndGggfQogICAgICB0aGlzLl9pbmRleGVyTWFwLnNldChoZXgsIG5ld0lkeCkKICAgICAgdGhpcy5pbmRleGVycy5wdXNoKG5ld0lkeCkKCiAgICAgIC8vIGJvb3RzdHJhcCBpcyAic2lsZW50bHkiIGFkZGVkIHNvIHRoYXQgaW5pdGlhbCB2aWV3cyBoYXZlIG5vIHByb2xvZ3VlCiAgICAgIGlmICghdGhpcy5ib290c3RyYXBwaW5nKSB0aGlzLmluZGV4ZXJVcGRhdGUgPSB0cnVlCiAgICB9IGVsc2UgewogICAgICBpZHgubGVuZ3RoID0gbGVuZ3RoCiAgICB9CiAgfQoKICBfc2Vlbkxlbmd0aChrZXkpIHsKICAgIHJldHVybiB0aGlzLl9jbG9ja1VwZGF0ZXMuZ2V0KGI0YS50b1N0cmluZyhrZXksICdoZXgnKSkgfHwgMAogIH0KCiAgYXN5bmMgYWNrKGtleSkgewogICAgY29uc3QgdmFsdWUgPSBhd2FpdCB0aGlzLl9nZXQoa2V5LCAwKQogICAgY29uc3QgbGVuZ3RoID0gdGhpcy5fc2Vlbkxlbmd0aChrZXkpCiAgICBpZiAodmFsdWUgJiYgdmFsdWUubGVuZ3RoID09PSBsZW5ndGgpIHJldHVybgoKICAgIGNvbnN0IGlzSW5kZXhlciA9IHZhbHVlID8gdmFsdWUuaXNJbmRleGVyIDogZmFsc2UKICAgIGNvbnN0IGlzUmVtb3ZlZCA9IHZhbHVlID8gdmFsdWUuaXNSZW1vdmVkIDogdHJ1ZQoKICAgIHRoaXMuX2NoYW5nZXMucHVzaCh7IGtleSwgdmFsdWU6IHsgaXNJbmRleGVyLCBpc1JlbW92ZWQsIGxlbmd0aCB9IH0pCiAgfQoKICBhc3luYyBhZGQoa2V5LCB7IGlzSW5kZXhlciA9IGZhbHNlLCBsZW5ndGggPSB0aGlzLl9zZWVuTGVuZ3RoKGtleSkgfSA9IHt9KSB7CiAgICBsZXQgdmFsdWUgPSBudWxsCiAgICBsZXQgZm91bmQgPSBmYWxzZQogICAgbGV0IGNoYW5nZWQgPSB0cnVlCgogICAgZm9yIChsZXQgaSA9IHRoaXMuX2NoYW5nZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgYyA9IHRoaXMuX2NoYW5nZXNbaV0KICAgICAgaWYgKGI0YS5lcXVhbHMoa2V5LCBjLmtleSkpIHsKICAgICAgICB2YWx1ZSA9IGMudmFsdWUKICAgICAgICBmb3VuZCA9IHRydWUKICAgICAgICBicmVhawogICAgICB9CiAgICB9CgogICAgaWYgKCFmb3VuZCkgewogICAgICBjb25zdCBub2RlID0gYXdhaXQgdGhpcy5kYi5nZXQoa2V5LCB7IHZhbHVlRW5jb2Rpbmc6IE1lbWJlciwga2V5RW5jb2Rpbmc6IE1FTUJFUlMgfSkKCiAgICAgIGlmIChub2RlKSB7CiAgICAgICAgdmFsdWUgPSBub2RlLnZhbHVlCiAgICAgICAgZm91bmQgPSB0cnVlCiAgICAgIH0KICAgIH0KCiAgICBsZXQgd2FzVHJhY2tlZCA9IGZhbHNlCiAgICBsZXQgd2FzSW5kZXhlciA9IGZhbHNlCgogICAgaWYgKGZvdW5kKSB7CiAgICAgIGlmICghdmFsdWUuaXNSZW1vdmVkKSB3YXNUcmFja2VkID0gdHJ1ZQogICAgICBpZiAodmFsdWUuaXNJbmRleGVyKSB3YXNJbmRleGVyID0gdHJ1ZQogICAgICBpZiAobGVuZ3RoIDwgdmFsdWUubGVuZ3RoKSBsZW5ndGggPSB2YWx1ZS5sZW5ndGgKICAgICAgaWYgKHZhbHVlLmxlbmd0aCA9PT0gbGVuZ3RoICYmIHZhbHVlLmlzSW5kZXhlciA9PT0gaXNJbmRleGVyICYmIHZhbHVlLmlzUmVtb3ZlZCA9PT0gZmFsc2UpCiAgICAgICAgY2hhbmdlZCA9IGZhbHNlCiAgICB9CgogICAgaWYgKGNoYW5nZWQpIHsKICAgICAgdGhpcy5fY2hhbmdlcy5wdXNoKHsga2V5LCB2YWx1ZTogeyBpc0luZGV4ZXIsIGlzUmVtb3ZlZDogZmFsc2UsIGxlbmd0aCB9IH0pCiAgICB9CgogICAgaWYgKCF3YXNUcmFja2VkKSB0aGlzLm1lbWJlcnMrKwogICAgaWYgKHdhc0luZGV4ZXIgfHwgaXNJbmRleGVyKSB0aGlzLl91cGRhdGVJbmRleGVyKGtleSwgbGVuZ3RoLCBpc0luZGV4ZXIsIDApCiAgfQoKICBhc3luYyByZW1vdmUoa2V5KSB7CiAgICBsZXQgaXNJbmRleGVyID0gZmFsc2UKCiAgICBmb3IgKGNvbnN0IGlkeCBvZiB0aGlzLmluZGV4ZXJzKSB7CiAgICAgIGlzSW5kZXhlciA9IGI0YS5lcXVhbHMoaWR4LmtleSwga2V5KQogICAgICBpZiAoaXNJbmRleGVyKSBicmVhawogICAgfQoKICAgIGlmIChpc0luZGV4ZXIpIHRoaXMuX3VwZGF0ZUluZGV4ZXIoa2V5LCBudWxsLCBmYWxzZSwgMCkKCiAgICBsZXQgdmFsdWUgPSBudWxsCiAgICBsZXQgZm91bmQgPSBmYWxzZQoKICAgIGZvciAobGV0IGkgPSB0aGlzLl9jaGFuZ2VzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IGMgPSB0aGlzLl9jaGFuZ2VzW2ldCiAgICAgIGlmIChiNGEuZXF1YWxzKGtleSwgYy5rZXkpKSB7CiAgICAgICAgdmFsdWUgPSBjLnZhbHVlCiAgICAgICAgZm91bmQgPSB0cnVlCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIGlmICghZm91bmQpIHsKICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IHRoaXMuZGIuZ2V0KGtleSwgeyB2YWx1ZUVuY29kaW5nOiBNZW1iZXIsIGtleUVuY29kaW5nOiBNRU1CRVJTIH0pCiAgICAgIGlmIChub2RlKSB7CiAgICAgICAgdmFsdWUgPSBub2RlLnZhbHVlCiAgICAgICAgZm91bmQgPSB0cnVlCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBjaGFuZ2VkID0gIWZvdW5kIHx8ICF2YWx1ZS5pc1JlbW92ZWQKICAgIGNvbnN0IHdhc1RyYWNrZWQgPSBmb3VuZCAmJiAhdmFsdWUuaXNSZW1vdmVkCiAgICBjb25zdCBsZW5ndGggPSBmb3VuZCA/IHZhbHVlLmxlbmd0aCA6IDAKCiAgICBpZiAoY2hhbmdlZCkgewogICAgICB0aGlzLl9jaGFuZ2VzLnB1c2goeyBrZXksIHZhbHVlOiB7IGlzSW5kZXhlcjogZmFsc2UsIGlzUmVtb3ZlZDogdHJ1ZSwgbGVuZ3RoIH0gfSkKICAgIH0KCiAgICBpZiAod2FzVHJhY2tlZCkgdGhpcy5tZW1iZXJzLS0KCiAgICByZXR1cm4gaXNJbmRleGVyCiAgfQoKICBhc3luYyBsaW5rYWJsZShrZXksIGxlbmd0aCkgewogICAgY29uc3QgbGVuID0gdGhpcy5fc2Vlbkxlbmd0aChrZXkpCiAgICBpZiAobGVuID4gMCkgcmV0dXJuIGxlbmd0aCA+IGxlbgoKICAgIGNvbnN0IGluZm8gPSBhd2FpdCB0aGlzLl9nZXQoa2V5LCAwKQogICAgY29uc3QgcHJldkxlbmd0aCA9IGluZm8gPyBpbmZvLmxlbmd0aCA6IDAKCiAgICByZXR1cm4gbGVuZ3RoID4gcHJldkxlbmd0aAogIH0KCiAgYXN5bmMgaGFzKGtleSwgb3B0cykgewogICAgLy8gY291bGQgYmUgb3B0aW1pc2VkLi4uCiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0KGtleSwgb3B0cykpICE9PSBudWxsCiAgfQoKICBhc3luYyBfZ2V0KGtleSwgdGltZW91dCkgewogICAgbGV0IHZhbHVlID0gbnVsbAogICAgbGV0IGZvdW5kID0gZmFsc2UKCiAgICBmb3IgKGxldCBpID0gdGhpcy5fY2hhbmdlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBjID0gdGhpcy5fY2hhbmdlc1tpXQogICAgICBpZiAoYjRhLmVxdWFscyhrZXksIGMua2V5KSkgewogICAgICAgIHZhbHVlID0gYy52YWx1ZQogICAgICAgIGZvdW5kID0gdHJ1ZQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KCiAgICBpZiAoIWZvdW5kKSB7CiAgICAgIGNvbnN0IG5vZGUgPSBhd2FpdCB0aGlzLmRiLmdldChrZXksIHsgdGltZW91dCwgdmFsdWVFbmNvZGluZzogTWVtYmVyLCBrZXlFbmNvZGluZzogTUVNQkVSUyB9KQogICAgICBpZiAobm9kZSkgewogICAgICAgIHZhbHVlID0gbm9kZS52YWx1ZQogICAgICAgIGZvdW5kID0gdHJ1ZQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZvdW5kID8gdmFsdWUgOiBudWxsCiAgfQoKICBhc3luYyBnZXQoa2V5LCBvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLl9lbXB0eSkgcmV0dXJuIG51bGwKCiAgICBsZXQgdmFsdWUgPSBhd2FpdCB0aGlzLl9nZXQoa2V5LCBvcHRzLnRpbWVvdXQgfHwgMCkKCiAgICBpZiAob3B0cy51bmZsdXNoZWQpIHsKICAgICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpCgogICAgICBmb3IgKGxldCBpID0gdGhpcy5fY2hhbmdlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGNvbnN0IGMgPSB0aGlzLl9jaGFuZ2VzW2ldCiAgICAgICAgaWYgKGI0YS5lcXVhbHMoYy5rZXksIGtleSkpIHZhbHVlID0gYy52YWx1ZQogICAgICB9CgogICAgICBpZiAodGhpcy5fY2xvY2tVcGRhdGVzLmhhcyhoZXgpKSB2YWx1ZS5sZW5ndGggPSB0aGlzLl9jbG9ja1VwZGF0ZXMuZ2V0KGhleCkKICAgIH0KCiAgICByZXR1cm4gb3B0cy5vbmx5QWN0aXZlICE9PSBmYWxzZSB8fCAhdmFsdWUuaXNSZW1vdmVkID8gdmFsdWUgOiBudWxsCiAgfQoKICBhc3luYyBoYXNMb2NhbChrZXkpIHsKICAgIGlmICh0aGlzLl9lbXB0eSkgcmV0dXJuIGZhbHNlCiAgICB0cnkgewogICAgICBjb25zdCBub2RlID0gYXdhaXQgdGhpcy5kYi5nZXQoa2V5LCB7CiAgICAgICAgdmFsdWVFbmNvZGluZzogTWVtYmVyLAogICAgICAgIGtleUVuY29kaW5nOiBNRU1CRVJTLAogICAgICAgIHVwZGF0ZTogZmFsc2UsCiAgICAgICAgd2FpdDogZmFsc2UKICAgICAgfSkKICAgICAgcmV0dXJuIG5vZGUgIT09IG51bGwKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICB9CgogIGFzeW5jIGdldExvY2FsTGVuZ3RoKGtleSkgewogICAgaWYgKHRoaXMuX2VtcHR5KSByZXR1cm4gMAogICAgdHJ5IHsKICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IHRoaXMuZGIuZ2V0KGtleSwgewogICAgICAgIHZhbHVlRW5jb2Rpbmc6IE1lbWJlciwKICAgICAgICBrZXlFbmNvZGluZzogTUVNQkVSUywKICAgICAgICB1cGRhdGU6IGZhbHNlLAogICAgICAgIHdhaXQ6IGZhbHNlCiAgICAgIH0pCiAgICAgIHJldHVybiBub2RlID09PSBudWxsID8gMCA6IG5vZGUudmFsdWUubGVuZ3RoCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIDAKICAgIH0KICB9CgogIGxpc3QoKSB7CiAgICAvLyBub3RlLCBOT1Qgc2FmZSB0byB1c2UgZHVyaW5nIGFwcGx5IGF0bQogICAgcmV0dXJuIHRoaXMuZGIuY3JlYXRlUmVhZFN0cmVhbSh7CiAgICAgIHZhbHVlRW5jb2Rpbmc6IE1lbWJlciwKICAgICAga2V5RW5jb2Rpbmc6IE1FTUJFUlMKICAgIH0pCiAgfQoKICBhc3luYyBpc0luZGV4ZWQoa2V5LCBsZW5ndGgpIHsKICAgIGNvbnN0IGNvID0gdGhpcy5kYi5jaGVja291dCh0aGlzLmNvcmUuaW5kZXhlZExlbmd0aCkKICAgIHRyeSB7CiAgICAgIGNvbnN0IG5vZGUgPSBhd2FpdCBjby5nZXQoa2V5LCB7IHZhbHVlRW5jb2Rpbmc6IE1lbWJlciwga2V5RW5jb2Rpbmc6IE1FTUJFUlMgfSkKICAgICAgcmV0dXJuIG5vZGUgIT09IG51bGwgJiYgbm9kZS52YWx1ZS5sZW5ndGggPj0gbGVuZ3RoCiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCBjby5jbG9zZSgpCiAgICB9CiAgfQoKICBhc3luYyBmb3JrKGluZGV4ZXJzLCBtYW5pZmVzdHMsIGVuY3J5cHRpb25MZW5ndGgsIHZpZXdzKSB7CiAgICB0aGlzLmluZGV4ZXJzID0gW10KICAgIHRoaXMucGVuZGluZ0luZGV4ZXJzID0gW10KICAgIHRoaXMudmlld3MgPSB2aWV3cwoKICAgIGlmICh0aGlzLnZlcnNpb24gPCAyKSB0aGlzLnZlcnNpb24gPSAyIC8vIGJ1bXAgdG8gZW5hYmxlIGVudHJvcHkKCiAgICBmb3IgKGNvbnN0IHsga2V5IH0gb2YgaW5kZXhlcnMpIHsKICAgICAgLy8gdG9kbzogcHJvYmFibHkgbmVlZCB0byBjaGVjayBpc1JlbW92ZWQgZXRjCiAgICAgIGNvbnN0IHsgbGVuZ3RoIH0gPSBhd2FpdCB0aGlzLmdldChrZXkpCiAgICAgIHRoaXMuaW5kZXhlcnMucHVzaCh7IGtleSwgbGVuZ3RoIH0pCiAgICB9CgogICAgdGhpcy5fcmVmcmVzaEVudHJvcHkodGhpcy5jb3JlLmxlbmd0aCkKCiAgICBjb25zdCBibG9ja3MgPSBbXQoKICAgIC8vIHRydW5jYXRlIG5lZWRzIHRvIHJlc3BlY3QgaHlwZXJjb3JlIGJhdGNoCiAgICBsZXQgdHJ1bmNhdGUgPSB0aGlzLmNvcmUubGVuZ3RoIC0gMQogICAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIHRoaXMuZGIuY3JlYXRlSGlzdG9yeVN0cmVhbSh7IGx0OiB0cnVuY2F0ZSwgcmV2ZXJzZTogdHJ1ZSB9KSkgewogICAgICBpZiAoYjRhLmVxdWFscyhkYXRhLmtleSwgSU5GT19LRVkpKSB7CiAgICAgICAgdHJ1bmNhdGUgPSBkYXRhLnNlcSArIDEKICAgICAgICBicmVhawogICAgICB9CgogICAgICBibG9ja3MucHVzaChkYXRhKQogICAgfQoKICAgIGF3YWl0IHRoaXMuY29yZS50cnVuY2F0ZSh0cnVuY2F0ZSwgdGhpcy5jb3JlLmZvcmspCgogICAgY29uc3QgYmF0Y2ggPSB0aGlzLmRiLmJhdGNoKHsgdXBkYXRlOiBmYWxzZSB9KQogICAgYXdhaXQgYmF0Y2gucmVhZHkoKQoKICAgIGZvciAoY29uc3QgeyBrZXksIHZhbHVlIH0gb2YgYmxvY2tzKSB7CiAgICAgIGF3YWl0IGJhdGNoLnB1dChrZXksIHZhbHVlKQogICAgfQoKICAgIGNvbnN0IGluZm8gPSB7CiAgICAgIHZlcnNpb246IHRoaXMudmVyc2lvbiwKICAgICAgbWVtYmVyczogdGhpcy5tZW1iZXJzLAogICAgICBwZW5kaW5nSW5kZXhlcnM6IHRoaXMucGVuZGluZ0luZGV4ZXJzLAogICAgICBpbmRleGVyczogdGhpcy5pbmRleGVycywKICAgICAgaGVhZHM6IHRoaXMuaGVhZHMsCiAgICAgIHZpZXdzOiB0aGlzLnZpZXdzLAogICAgICBlbmNyeXB0aW9uTGVuZ3RoLAogICAgICBlbnRyb3B5OiB0aGlzLmVudHJvcHkKICAgIH0KCiAgICBhd2FpdCBiYXRjaC5wdXQoJ2luZm8nLCBpbmZvLCB7IHZhbHVlRW5jb2Rpbmc6IEluZm8sIGtleUVuY29kaW5nOiBESUdFU1QgfSkKICAgIGF3YWl0IGJhdGNoLmZsdXNoKCkKCiAgICBhd2FpdCB0aGlzLl9yZXNldChhd2FpdCB0aGlzLmRiLmdldCgnaW5mbycsIHsgdmFsdWVFbmNvZGluZzogSW5mbywga2V5RW5jb2Rpbmc6IERJR0VTVCB9KSkKCiAgICByZXR1cm4gdHJ1bmNhdGUKICB9Cn0KCmZ1bmN0aW9uIGhhc0RlcGVuZGVuY3kobm9kZSwgZGVwKSB7CiAgZm9yIChjb25zdCBoIG9mIG5vZGUuYWN0dWFsSGVhZHMpIHsKICAgIGlmIChzYW1lTm9kZShoLCBkZXApKSByZXR1cm4gdHJ1ZQogIH0KICByZXR1cm4gZmFsc2UKfQoKZnVuY3Rpb24gc2FtZU5vZGUoYSwgYikgewogIHJldHVybiBiNGEuZXF1YWxzKGEua2V5LCBiLmtleSkgJiYgYS5sZW5ndGggPT09IGIubGVuZ3RoCn0KCmZ1bmN0aW9uIHNhbWVJbmRleGVycyhhLCBiKSB7CiAgaWYgKGEudmlld3MubGVuZ3RoID4gMCAmJiBiLnZpZXdzLmxlbmd0aCA+IDApIHJldHVybiBiNGEuZXF1YWxzKGEudmlld3NbMF0ua2V5LCBiLnZpZXdzWzBdLmtleSkKICBpZiAoYS5pbmRleGVycy5sZW5ndGggIT09IGIuaW5kZXhlcnMubGVuZ3RoKSByZXR1cm4gZmFsc2UKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmluZGV4ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoIWI0YS5lcXVhbHMoYS5pbmRleGVyc1tpXS5rZXksIGIuaW5kZXhlcnNbaV0ua2V5KSkgcmV0dXJuIGZhbHNlCiAgfQoKICByZXR1cm4gdHJ1ZQp9CgpmdW5jdGlvbiBjbG9uZU5vZGVzKGFycikgewogIGNvbnN0IGMgPSBbXQogIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICBjLnB1c2goeyBrZXk6IGFycltpXS5rZXksIGxlbmd0aDogYXJyW2ldLmxlbmd0aCB9KQogIH0KICByZXR1cm4gYwp9CgpmdW5jdGlvbiBnZW5lcmF0ZUVudHJvcHkoaW5kZXhlcnMsIGxlbmd0aCwgZW50cm9weSkgewogIGNvbnN0IGJ1ZmZlciA9IGI0YS5hbGxvYyg4ICsgMzIgKyBpbmRleGVycy5sZW5ndGggKiAzMikKICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGgsIGJ1ZmZlciB9CgogIGMudWludDY0LmVuY29kZShzdGF0ZSwgbGVuZ3RoKQogIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIGVudHJvcHkgfHwgR0VORVNJU19FTlRST1BZKQogIGZvciAoY29uc3QgeyBrZXkgfSBvZiBpbmRleGVycykgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwga2V5KQoKICByZXR1cm4gY3J5cHRvLmhhc2goW05TX0VOVFJPUFksIGJ1ZmZlcl0pCn0KY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQoKY29uc3QgTUFYX1dBSVQgPSAyICogNjAgKiAxMDAwCmNvbnN0IERFRkFVTFRfSU5URVJWQUwgPSAxMCAqIDEwMDAKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVGltZXIgewogIGNvbnN0cnVjdG9yKGhhbmRsZXIsIGludGVydmFsLCBvcHRzID0ge30pIHsKICAgIHRoaXMuaGFuZGxlciA9IGhhbmRsZXIgfHwgbm9vcAogICAgdGhpcy5pbnRlcnZhbCA9IGludGVydmFsIHx8IERFRkFVTFRfSU5URVJWQUwKICAgIHRoaXMubGltaXQgPSBvcHRzLmxpbWl0IHx8IE1BWF9XQUlUCgogICAgdGhpcy5fZXhlY3V0aW5nID0gbnVsbAoKICAgIHRoaXMuX2xpbWl0ID0gcmFuZG9tMm92ZXIxKHRoaXMubGltaXQpCiAgICB0aGlzLl90aW1lciA9IG51bGwKICAgIHRoaXMuX3Jlc29sdmUgPSBudWxsCiAgICB0aGlzLl9zdGFydCA9IDAKICAgIHRoaXMuX3N0b3BwZWQgPSBmYWxzZQogICAgdGhpcy5fYXNhcCA9IGZhbHNlCiAgICB0aGlzLl9zdGFuZGFsb25lID0gbmV3IFNldCgpCgogICAgdGhpcy5fdW5yZWYgPSBvcHRzLnVucmVmICE9PSBmYWxzZQogICAgdGhpcy5fdGltZXJDYWxsYmFjayA9IHRoaXMuX2V4ZWN1dGVCYWNrZ3JvdW5kLmJpbmQodGhpcykKICB9CgogIF9leGVjdXRlQmFja2dyb3VuZCgpIHsKICAgIHRoaXMuX2V4ZWN1dGluZyA9IHRoaXMuX2V4ZWN1dGUoKQogICAgdGhpcy5fZXhlY3V0aW5nLmNhdGNoKHNhZmV0eUNhdGNoKSAvLyBtYWtlIHN1cmUgaXQgZG9lc250IGNyYXNoIGluIHRoZSBiZwogIH0KCiAgYXN5bmMgX2V4ZWN1dGUoKSB7CiAgICB0aGlzLl9hc2FwID0gZmFsc2UKICAgIGF3YWl0IHRoaXMuaGFuZGxlcigpCiAgICB0aGlzLl9zdGFydCA9IDAKICAgIHRoaXMuX2V4ZWN1dGluZyA9IG51bGwKICAgIHRoaXMuYnVtcCgpCiAgfQoKICBidW1wKCkgewogICAgaWYgKHRoaXMuX3N0b3BwZWQgfHwgdGhpcy5fZXhlY3V0aW5nIHx8IHRoaXMuX2FzYXApIHJldHVybgoKICAgIGlmICghdGhpcy5fc3RhcnQpIHRoaXMuX3N0YXJ0ID0gRGF0ZS5ub3coKQogICAgZWxzZSBpZiAoRGF0ZS5ub3coKSAtIHRoaXMuX3N0YXJ0ID4gdGhpcy5fbGltaXQpIHJldHVybgoKICAgIGNvbnN0IGludGVydmFsID0gcmFuZG9tMm92ZXIxKHRoaXMuaW50ZXJ2YWwpCgogICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVyKQogICAgdGhpcy5fdGltZXIgPSBzZXRUaW1lb3V0KHRoaXMuX3RpbWVyQ2FsbGJhY2ssIGludGVydmFsKQogICAgaWYgKHRoaXMuX3VucmVmICYmIHRoaXMuX3RpbWVyLnVucmVmKSB0aGlzLl90aW1lci51bnJlZigpCiAgfQoKICBhc3luYyB0cmlnZ2VyKCkgewogICAgaWYgKHRoaXMuX3N0b3BwZWQpIHJldHVybgogICAgaWYgKHRoaXMuX2V4ZWN1dGluZykgYXdhaXQgdGhpcy5fZXhlY3V0aW5nCiAgICBpZiAodGhpcy5fc3RvcHBlZCkgcmV0dXJuCgogICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVyKQogICAgdGhpcy5fdGltZXIgPSBudWxsCgogICAgdGhpcy5fZXhlY3V0ZUJhY2tncm91bmQoKQogICAgYXdhaXQgdGhpcy5fZXhlY3V0aW5nCiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGlmICh0aGlzLl9leGVjdXRpbmcpIGF3YWl0IHRoaXMuX2V4ZWN1dGluZwogIH0KCiAgLy8gYnVzaW5lc3MtYXMtdXN1YWwKICBiYXUoKSB7CiAgICBpZiAoIXRoaXMuX2FzYXApIHJldHVybgogICAgdGhpcy5fYXNhcCA9IGZhbHNlCiAgICB0aGlzLmJ1bXAoKQogIH0KCiAgYXNhcCgpIHsKICAgIGlmICh0aGlzLl9hc2FwKSByZXR1cm4KICAgIHRoaXMuX2FzYXAgPSB0cnVlCgogICAgY29uc3QgaW50ZXJ2YWwgPSBNYXRoLmZsb29yKChNYXRoLnJhbmRvbSgpICogdGhpcy5pbnRlcnZhbCkgLyAzKQogICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVyKQogICAgdGhpcy5fdGltZXIgPSBzZXRUaW1lb3V0KHRoaXMuX3RpbWVyQ2FsbGJhY2ssIGludGVydmFsKQogICAgaWYgKHRoaXMuX3VucmVmICYmIHRoaXMuX3RpbWVyLnVucmVmKSB0aGlzLl90aW1lci51bnJlZigpCiAgfQoKICBzdG9wKCkgewogICAgaWYgKHRoaXMuX3RpbWVyKSBjbGVhclRpbWVvdXQodGhpcy5fdGltZXIpCiAgICB0aGlzLl90aW1lciA9IG51bGwKICAgIHRoaXMuX3N0YXJ0ID0gMAogICAgdGhpcy5fYXNhcCA9IGZhbHNlCiAgICB0aGlzLl9zdG9wcGVkID0gdHJ1ZQoKICAgIGZvciAoY29uc3QgeyB0aW1lciwgcmVzb2x2ZSB9IG9mIHRoaXMuX3N0YW5kYWxvbmUpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKQogICAgICByZXNvbHZlKCkKICAgIH0KCiAgICB0aGlzLl9zdGFuZGFsb25lLmNsZWFyKCkKICB9CgogIGFzYXBTdGFuZGFsb25lKCkgewogICAgY29uc3QgaW50ZXJ2YWwgPSBNYXRoLmZsb29yKChNYXRoLnJhbmRvbSgpICogdGhpcy5pbnRlcnZhbCkgLyAzKQogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgIGNvbnN0IHJlZiA9IHsgdGltZXI6IG51bGwsIHJlc29sdmUgfQogICAgICByZWYudGltZXIgPSBzZXRUaW1lb3V0KHJlc29sdmVTdGFuZGFsb25lLCBpbnRlcnZhbCwgcmVmLCB0aGlzLl9zdGFuZGFsb25lKQogICAgICBpZiAocmVmLnRpbWVyLnVucmVmKSByZWYudGltZXIudW5yZWYoKQogICAgICB0aGlzLl9zdGFuZGFsb25lLmFkZChyZWYpCiAgICB9KQogIH0KCiAgdW5yZWYoKSB7CiAgICBpZiAodGhpcy5fdGltZXIgJiYgdGhpcy5fdGltZXIudW5yZWYpIHRoaXMuX3RpbWVyLnVucmVmKCkKICB9Cn0KCmZ1bmN0aW9uIHJlc29sdmVTdGFuZGFsb25lKHJlZiwgc2V0KSB7CiAgc2V0LmRlbGV0ZShyZWYpCiAgcmVmLnJlc29sdmUoKQp9CgovLyByYW5kb20gdmFsdWUgeCBiZXR3ZWVuIG4gPD0geCA8IDJuCmZ1bmN0aW9uIHJhbmRvbTJvdmVyMShuKSB7CiAgcmV0dXJuIE1hdGguZmxvb3IobiArIE1hdGgucmFuZG9tKCkgKiBuKQp9CgpmdW5jdGlvbiBub29wKCkge30KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnbmFub2Fzc2VydCcpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFRvcG9MaXN0IHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMudGlwID0gW10KICAgIHRoaXMudW5kbyA9IDAKICAgIHRoaXMuc2hhcmVkID0gMAogIH0KCiAgc3RhdGljIGNvbXBhcmUoYSwgYikgewogICAgcmV0dXJuIGNtcChhLCBiKQogIH0KCiAgc3RhdGljIGFkZChub2RlLCBpbmRleGVkLCBvZmZzZXQpIHsKICAgIGFkZFNvcnRlZChub2RlLCBpbmRleGVkLCBvZmZzZXQpCiAgfQoKICBtYXJrKCkgewogICAgdGhpcy5zaGFyZWQgPSB0aGlzLnRpcC5sZW5ndGgKICAgIHRoaXMudW5kbyA9IDAKICB9CgogIC8vIHRvZG86IGJ1bXAgdG8gbmV3IGFwaSB0aGF0IGp1c3QgdHJhY2tzIHVuZG8KICBmbHVzaChpbmRleGVkID0gW10pIHsKICAgIGlmIChpbmRleGVkLmxlbmd0aCkgdGhpcy5fYXBwbHlJbmRleGVkKGluZGV4ZWQpCgogICAgY29uc3QgdSA9IHsKICAgICAgc2hhcmVkOiB0aGlzLnNoYXJlZCwKICAgICAgdW5kbzogdGhpcy51bmRvLAogICAgICBsZW5ndGg6IGluZGV4ZWQubGVuZ3RoICsgdGhpcy50aXAubGVuZ3RoLAogICAgICBpbmRleGVkLAogICAgICB0aXA6IHRoaXMudGlwCiAgICB9CgogICAgdGhpcy5tYXJrKCkKCiAgICByZXR1cm4gdQogIH0KCiAgcHJpbnQoKSB7CiAgICByZXR1cm4gdGhpcy50aXAubWFwKChuKSA9PiBuLndyaXRlci5jb3JlLmtleS50b1N0cmluZygpICsgbi5sZW5ndGgpCiAgfQoKICBfYXBwbHlJbmRleGVkKG5vZGVzKSB7CiAgICBhc3NlcnQobm9kZXMubGVuZ3RoIDw9IHRoaXMudGlwLmxlbmd0aCwgJ0luZGV4ZWQgYmF0Y2ggY2Fubm90IGV4Y2VlZCB0aXAnKQoKICAgIGxldCBzaGFyZWQgPSAwCgogICAgZm9yICg7IHNoYXJlZCA8IG5vZGVzLmxlbmd0aDsgc2hhcmVkKyspIHsKICAgICAgaWYgKHRoaXMudGlwW3NoYXJlZF0gIT09IG5vZGVzW3NoYXJlZF0pIGJyZWFrCiAgICB9CgogICAgLy8gcmVvcmRlcmluZwogICAgaWYgKHNoYXJlZCA8IG5vZGVzLmxlbmd0aCkgdGhpcy5fdHJhY2soc2hhcmVkKQoKICAgIGNvbnN0IHRpcCA9IFtdCgogICAgZm9yIChsZXQgaSA9IHNoYXJlZDsgaSA8IHRoaXMudGlwLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLnRpcFtpXQogICAgICBpZiAobm9kZS55aWVsZGVkKSBjb250aW51ZQogICAgICBjb25zdCBzID0gYWRkU29ydGVkKG5vZGUsIHRpcCwgMCkKICAgICAgaWYgKHMgPT09IHRpcC5sZW5ndGggLSAxKSBjb250aW51ZQogICAgICB0aGlzLl90cmFjayhzaGFyZWQgKyBzKQogICAgfQoKICAgIHRoaXMudGlwID0gdGlwCiAgfQoKICBhZGQobm9kZSkgewogICAgY29uc3Qgc2hhcmVkID0gYWRkU29ydGVkKG5vZGUsIHRoaXMudGlwLCAwKQogICAgdGhpcy5fdHJhY2soc2hhcmVkKQogIH0KCiAgX3RyYWNrKHNoYXJlZCkgewogICAgaWYgKHNoYXJlZCA8IHRoaXMuc2hhcmVkKSB7CiAgICAgIHRoaXMudW5kbyArPSB0aGlzLnNoYXJlZCAtIHNoYXJlZAogICAgICB0aGlzLnNoYXJlZCA9IHNoYXJlZAogICAgfQogIH0KfQoKZnVuY3Rpb24gaGFzT3B0aW1pc3RpY0RlcHMobm9kZSkgewogIGZvciAoY29uc3QgZCBvZiBub2RlLmRlcGVuZGVuY2llcykgewogICAgaWYgKGQub3B0aW1pc3RpYykgcmV0dXJuIHRydWUKICB9CiAgcmV0dXJuIGZhbHNlCn0KCi8vIHRoaXMgY2FuIGJlIG9wdGltaXNlZCB0byBvbmx5IHJldHVybiBvcHRpbWlzdGljIG5vZGVzIHRoYXQgd2Ugd2lsbCAidG91Y2giIHdoZW4gbW92aW5nIGRvd24gdGhlIG5vZGUKZnVuY3Rpb24gZ2V0T3B0aW1pc3RpY0RlcHMobm9kZSwgbGlzdCkgewogIGNvbnN0IGRlcHMgPSBuZXcgU2V0KCkKICBjb25zdCBzdGFjayA9IFtub2RlXQoKICB3aGlsZSAoc3RhY2subGVuZ3RoID4gMCkgewogICAgY29uc3QgbmV4dCA9IHN0YWNrLnBvcCgpCiAgICBpZiAoZGVwcy5oYXMobmV4dCkpIGNvbnRpbnVlCiAgICBpZiAobmV4dC5vcHRpbWlzdGljICYmIG5leHQgIT09IG5vZGUpIGRlcHMuYWRkKG5leHQpCiAgICBmb3IgKGNvbnN0IGQgb2YgbmV4dC5kZXBlbmRlbmNpZXMpIHsKICAgICAgaWYgKGQub3B0aW1pc3RpYykgc3RhY2sucHVzaChkKQogICAgfQogIH0KCiAgY29uc3QgcmVzdWx0ID0gW10KCiAgZm9yIChsZXQgaSA9IGxpc3QubGVuZ3RoIC0gMTsgZGVwcy5zaXplICE9PSByZXN1bHQubGVuZ3RoICYmIGkgPj0gMDsgaS0tKSB7CiAgICBjb25zdCBuID0gbGlzdFtpXQogICAgaWYgKGRlcHMuaGFzKG4pKSByZXN1bHQucHVzaChuKQogIH0KCiAgcmV0dXJuIHJlc3VsdC5yZXZlcnNlKCkKfQoKZnVuY3Rpb24gYWRkU29ydGVkT3B0aW1pc3RpYyhub2RlLCBsaXN0LCBvZmZzZXQpIHsKICBjb25zdCBvcHQgPSBnZXRPcHRpbWlzdGljRGVwcyhub2RlLCBsaXN0KQogIGNvbnN0IHBvcyA9IG5ldyBVaW50MzJBcnJheShvcHQubGVuZ3RoKQoKICBmb3IgKGxldCBpID0gMDsgaSA8IG9wdC5sZW5ndGg7IGkrKykgewogICAgY29uc3QgbiA9IG9wdFtpXQogICAgcG9zW2ldID0gbi5pbmRleAogICAgbW92ZURvd24obiwgbGlzdCwgb2Zmc2V0KQogIH0KCiAgbW92ZURvd25BbmRVcChub2RlLCBsaXN0LCBvZmZzZXQpCgogIGZvciAobGV0IGkgPSBvcHQubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgIG1vdmVPcHRpbWlzdGljVXAob3B0W2ldLCBsaXN0LCBvZmZzZXQpCiAgfQoKICBsZXQgc2hhcmVkID0gbm9kZS5pbmRleAoKICBmb3IgKGxldCBpID0gMDsgaSA8IG9wdC5sZW5ndGg7IGkrKykgewogICAgY29uc3QgaWR4ID0gcG9zW2ldCiAgICBjb25zdCBuID0gb3B0W2ldCgogICAgaWYgKGlkeCA9PT0gbi5pbmRleCkgY29udGludWUKCiAgICBpZiAoaWR4IDwgc2hhcmVkKSBzaGFyZWQgPSBpZHgKICAgIGlmIChuLmluZGV4IDwgc2hhcmVkKSBzaGFyZWQgPSBuLmluZGV4CiAgfQoKICByZXR1cm4gc2hhcmVkCn0KCmZ1bmN0aW9uIGFkZFNvcnRlZChub2RlLCBsaXN0LCBvZmZzZXQpIHsKICBsaXN0LnB1c2gobm9kZSkKICBub2RlLmluZGV4ID0gbGlzdC5sZW5ndGggLSAxCgogIC8vICJzbG93IiBwYXRoLCAxJSBvZiBub2RlcwogIGlmIChoYXNPcHRpbWlzdGljRGVwcyhub2RlKSkgcmV0dXJuIGFkZFNvcnRlZE9wdGltaXN0aWMobm9kZSwgbGlzdCwgb2Zmc2V0KQoKICBtb3ZlRG93bkFuZFVwKG5vZGUsIGxpc3QsIG9mZnNldCkKICByZXR1cm4gbm9kZS5pbmRleAp9CgpmdW5jdGlvbiBtb3ZlRG93bihub2RlLCBsaXN0LCBvZmZzZXQpIHsKICB3aGlsZSAobm9kZS5pbmRleCA+IG9mZnNldCkgewogICAgY29uc3QgcHJldiA9IGxpc3Rbbm9kZS5pbmRleCAtIDFdCiAgICBpZiAobGlua3Mobm9kZSwgcHJldikpIGJyZWFrCiAgICBsaXN0WyhwcmV2LmluZGV4ID0gbm9kZS5pbmRleCldID0gcHJldgogICAgbGlzdFstLW5vZGUuaW5kZXhdID0gbm9kZQogIH0KfQoKZnVuY3Rpb24gbW92ZU9wdGltaXN0aWNVcChub2RlLCBsaXN0LCBvZmZzZXQpIHsKICAvLyBpZiBvcHRpbWlzdGljIG1vdmUgYWxsIHRoZSB3YXkgdXAKICB3aGlsZSAobm9kZS5pbmRleCA8IGxpc3QubGVuZ3RoIC0gMSkgewogICAgY29uc3QgbmV4dCA9IGxpc3Rbbm9kZS5pbmRleCArIDFdCiAgICBpZiAobGlua3MobmV4dCwgbm9kZSkpIGJyZWFrCiAgICBsaXN0WyhuZXh0LmluZGV4ID0gbm9kZS5pbmRleCldID0gbmV4dAogICAgbGlzdFsrK25vZGUuaW5kZXhdID0gbm9kZQogIH0KCiAgLy8gc3RhYmxlIHNvcnQgaW4gY2FzZSBtdWx0aXBsZSBjaGlsZHJlbgogIHdoaWxlIChub2RlLmluZGV4ID4gb2Zmc2V0KSB7CiAgICBjb25zdCBwcmV2ID0gbGlzdFtub2RlLmluZGV4IC0gMV0KICAgIGlmICghcHJldi5vcHRpbWlzdGljKSBicmVhawogICAgY29uc3QgYyA9IGNtcChwcmV2LCBub2RlKQogICAgaWYgKGMgPD0gMCkgYnJlYWsKICAgIGxpc3RbKHByZXYuaW5kZXggPSBub2RlLmluZGV4KV0gPSBwcmV2CiAgICBsaXN0Wy0tbm9kZS5pbmRleF0gPSBub2RlCiAgfQp9CgpmdW5jdGlvbiBtb3ZlTm9uT3B0aW1pc3RpY1VwKG5vZGUsIGxpc3QsIG9mZnNldCkgewogIC8vIHN0YWJsZSBzb3J0IGFnYWluc3QgbmV4dCBub24gb3B0aW1pc3RpYyBub2RlCiAgd2hpbGUgKG5vZGUuaW5kZXggPCBsaXN0Lmxlbmd0aCAtIDEpIHsKICAgIGNvbnN0IG5leHQgPSBsaXN0W25vZGUuaW5kZXggKyAxXQogICAgY29uc3QgYyA9IGNtcE5vbk9wdGltaXN0aWMobm9kZSwgbmV4dCwgbGlzdCkKICAgIGlmIChjIDw9IDApIGJyZWFrCiAgICBsaXN0WyhuZXh0LmluZGV4ID0gbm9kZS5pbmRleCldID0gbmV4dAogICAgbGlzdFsrK25vZGUuaW5kZXhdID0gbm9kZQogIH0KfQoKZnVuY3Rpb24gbW92ZURvd25BbmRVcChub2RlLCBsaXN0LCBvZmZzZXQpIHsKICBtb3ZlRG93bihub2RlLCBsaXN0LCBvZmZzZXQpCgogIGlmIChub2RlLm9wdGltaXN0aWMpIG1vdmVPcHRpbWlzdGljVXAobm9kZSwgbGlzdCwgb2Zmc2V0KQogIGVsc2UgbW92ZU5vbk9wdGltaXN0aWNVcChub2RlLCBsaXN0LCBvZmZzZXQpCn0KCmZ1bmN0aW9uIGxpbmtzKGEsIGIpIHsKICBpZiAoYi5kZXBlbmRlbnRzLmhhcyhhKSkgcmV0dXJuIHRydWUKICByZXR1cm4gYS5sZW5ndGggPiAwICYmIGIubGVuZ3RoID09PSBhLmxlbmd0aCAtIDEgJiYgYS53cml0ZXIgPT09IGIud3JpdGVyCn0KCmZ1bmN0aW9uIGNtcE5vbk9wdGltaXN0aWMoYSwgYiwgbGlzdCkgewogIGlmICghYi5vcHRpbWlzdGljKSByZXR1cm4gY21wKGEsIGIpCgogIGZvciAobGV0IGkgPSBiLmluZGV4ICsgMTsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IG5vZGUgPSBsaXN0W2ldCiAgICBpZiAoIW5vZGUub3B0aW1pc3RpYykgcmV0dXJuIGNtcChhLCBub2RlKQogIH0KCiAgcmV0dXJuIC0xCn0KCmZ1bmN0aW9uIGNtcChhLCBiKSB7CiAgcmV0dXJuIGxpbmtzKGIsIGEpID8gLTEgOiBjbXBVbmxpbmtlZChhLCBiKQp9CgpmdW5jdGlvbiBjbXBVbmxpbmtlZChhLCBiKSB7CiAgY29uc3QgYyA9IGI0YS5jb21wYXJlKGEud3JpdGVyLmNvcmUua2V5LCBiLndyaXRlci5jb3JlLmtleSkKICByZXR1cm4gYyA9PT0gMCA/IChhLmxlbmd0aCA8IGIubGVuZ3RoID8gLTEgOiAxKSA6IGMKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFVwZGF0ZUNoYW5nZXMgewogIGNvbnN0cnVjdG9yKGJhc2UpIHsKICAgIHRoaXMuYmFzZSA9IGJhc2UKICAgIHRoaXMuYnlOYW1lID0gbmV3IE1hcCgpCiAgICB0aGlzLnRyYWNraW5nID0gbnVsbAogIH0KCiAgZ2V0IGRpc2NvdmVyeUtleSgpIHsKICAgIHJldHVybiB0aGlzLmJhc2UuZGlzY292ZXJ5S2V5CiAgfQoKICBnZXQga2V5KCkgewogICAgcmV0dXJuIHRoaXMuYmFzZS5rZXkKICB9CgogIGdldCBpZCgpIHsKICAgIHJldHVybiB0aGlzLmJhc2UuaWQKICB9CgogIGdldCBzeXN0ZW0oKSB7CiAgICByZXR1cm4gdGhpcy5iYXNlLnN5c3RlbQogIH0KCiAgdHJhY2soc3RhdGUpIHsKICAgIHRoaXMudHJhY2tpbmcgPSBbXQogICAgdGhpcy5ieU5hbWUuY2xlYXIoKQoKICAgIGlmICghc3RhdGUpIHJldHVybgoKICAgIGZvciAoY29uc3QgdiBvZiBzdGF0ZS52aWV3cykgewogICAgICBpZiAodi5yZWYpIHRoaXMuX2FkZCh2LnJlZikKICAgIH0KCiAgICB0aGlzLl9hZGQoc3RhdGUuc3lzdGVtVmlldy5yZWYpCiAgICB0aGlzLl9hZGQoc3RhdGUuZW5jcnlwdGlvblZpZXcucmVmKQogIH0KCiAgX2FkZChyZWYpIHsKICAgIHRoaXMudHJhY2tpbmcucHVzaCh7IHJlZiwgZnJvbTogcmVmLmF0b21pY0JhdGNoID8gcmVmLmF0b21pY0JhdGNoLmxlbmd0aCA6IDAgfSkKICB9CgogIGZpbmFsaXNlKCkgewogICAgaWYgKHRoaXMudHJhY2tpbmcgPT09IG51bGwpIHJldHVybgoKICAgIGZvciAoY29uc3QgeyByZWYsIGZyb20gfSBvZiB0aGlzLnRyYWNraW5nKSB7CiAgICAgIGNvbnN0IGNvcmUgPSByZWYuYXRvbWljQmF0Y2ggfHwgcmVmLmJhdGNoCiAgICAgIGNvbnN0IHRydW5jID0gcmVmLmF0b21pY0JhdGNoID8gcmVmLmF0b21pY0JhdGNoLnN0YXRlLmxhc3RUcnVuY2F0aW9uIDogbnVsbAoKICAgICAgdGhpcy5ieU5hbWUuc2V0KHJlZi5uYW1lLCB7CiAgICAgICAgZnJvbSwKICAgICAgICB0bzogY29yZSA/IGNvcmUubGVuZ3RoIDogZnJvbSwKICAgICAgICBzaGFyZWQ6IHRydW5jID8gdHJ1bmMudG8gOiBmcm9tCiAgICAgIH0pCiAgICB9CgogICAgdGhpcy50cmFja2luZyA9IG51bGwKICB9CgogIGdldChuYW1lKSB7CiAgICByZXR1cm4gdGhpcy5ieU5hbWUuZ2V0KG5hbWUpCiAgfQp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCB7IE9QTE9HX1ZFUlNJT04gfSA9IHJlcXVpcmUoJy4vY2Fwcy5qcycpCmNvbnN0IHsgT3Bsb2dNZXNzYWdlIH0gPSByZXF1aXJlKCcuL21lc3NhZ2VzLmpzJykKY29uc3QgeyBFbmNyeXB0aW9uVmlldyB9ID0gcmVxdWlyZSgnLi9lbmNyeXB0aW9uLmpzJykKCm1vZHVsZS5leHBvcnRzID0gewogIGVuY29kZVZhbHVlLAogIGRlY29kZVZhbHVlCn0KCmZ1bmN0aW9uIGVuY29kZVZhbHVlKHZhbHVlLCBvcHRzID0ge30pIHsKICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogMCwgYnVmZmVyOiBudWxsIH0KCiAgY29uc3QgbWVzc2FnZSA9IHsKICAgIHZlcnNpb246IG9wdHMudmVyc2lvbiB8fCBPUExPR19WRVJTSU9OLAogICAgZGlnZXN0OiBudWxsLAogICAgY2hlY2twb2ludDogbnVsbCwKICAgIG9wdGltaXN0aWM6ICEhb3B0cy5vcHRpbWlzdGljLAogICAgbm9kZTogewogICAgICBoZWFkczogb3B0cy5oZWFkcyB8fCBbXSwKICAgICAgYmF0Y2g6IDEsCiAgICAgIHZhbHVlCiAgICB9CiAgfQoKICBPcGxvZ01lc3NhZ2UucHJlZW5jb2RlKHN0YXRlLCBtZXNzYWdlKQoKICBpZiAob3B0cy5wYWRkaW5nKSB7CiAgICBzdGF0ZS5zdGFydCA9IG9wdHMucGFkZGluZwogICAgc3RhdGUuZW5kICs9IG9wdHMucGFkZGluZwogIH0KCiAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jKHN0YXRlLmVuZCkKCiAgT3Bsb2dNZXNzYWdlLmVuY29kZShzdGF0ZSwgbWVzc2FnZSkKCiAgaWYgKCFvcHRzLmVuY3J5cHRlZCkgcmV0dXJuIHN0YXRlLmJ1ZmZlcgoKICBpZiAoIW9wdHMub3B0aW1pc3RpYykgewogICAgdGhyb3cgbmV3IEVycm9yKCdFbmNvZGluZyBhbiBlbmNyeXB0ZWQgdmFsdWUgaXMgbm90IHN1cHBvcnRlZCcpCiAgfQoKICBjb25zdCBwYWRkaW5nID0gYjRhLmFsbG9jKDE2KSAvLyBtaW4gaGFzaCBsZW5ndGggaXMgMTYKICBjcnlwdG8uaGFzaChzdGF0ZS5idWZmZXIsIHBhZGRpbmcpCiAgcGFkZGluZ1swXSA9IDAKCiAgcmV0dXJuIGI0YS5jb25jYXQoW3BhZGRpbmcuc3ViYXJyYXkoMCwgOCksIHN0YXRlLmJ1ZmZlcl0pCn0KCmFzeW5jIGZ1bmN0aW9uIGRlY29kZVZhbHVlKHZhbHVlLCB7IGF1dG9iYXNlLCBlbmNyeXB0aW9uS2V5LCBrZXksIG1hbmlmZXN0LCBpbmRleCA9IDAgfSA9IHt9KSB7CiAgaWYgKGVuY3J5cHRpb25LZXkpIHsKICAgIGNvbnN0IGUgPSBuZXcgRW5jcnlwdGlvblZpZXcoeyBlbmNyeXB0aW9uS2V5LCBib290c3RyYXA6IGF1dG9iYXNlIH0pCiAgICBjb25zdCB3ID0gZS5nZXRXcml0ZXJFbmNyeXB0aW9uKCkKCiAgICBhd2FpdCB3LmRlY3J5cHQoaW5kZXgsIHZhbHVlLCB7IGtleSwgbWFuaWZlc3QgfSkKICAgIHZhbHVlID0gdmFsdWUuc3ViYXJyYXkoOCkKICB9CgogIGNvbnN0IG9wID0gYy5kZWNvZGUoT3Bsb2dNZXNzYWdlLCB2YWx1ZSkKICByZXR1cm4gb3Aubm9kZS52YWx1ZQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCBSZWFkeVJlc291cmNlID0gcmVxdWlyZSgncmVhZHktcmVzb3VyY2UnKQoKY29uc3QgV2FrZXVwRW50cnkgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBrZXk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEF1dG9XYWtldXAgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvcihiYXNlKSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5iYXNlID0gYmFzZQogICAgdGhpcy5mbHVzaGluZyA9IG51bGwKCiAgICB0aGlzLl9yb290U3RvcmUgPSB0aGlzLmJhc2Uuc3RvcmUKICAgIHRoaXMuX2FkZEJvdW5kID0gdGhpcy5hZGQuYmluZCh0aGlzKQogICAgdGhpcy5fcHJldXBkYXRlQm91bmQgPSB0aGlzLl9wcmV1cGRhdGUuYmluZCh0aGlzKQogICAgdGhpcy5fbmVlZHNGbHVzaCA9IGZhbHNlCiAgICB0aGlzLl9tYXAgPSBuZXcgTWFwKCkKICB9CgogIFtTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgcmV0dXJuIHRoaXMuX21hcC52YWx1ZXMoKQogIH0KCiAgYXN5bmMgX3ByZXVwZGF0ZShiYXRjaCwga2V5KSB7CiAgICB0aGlzLnF1ZXVlKGtleSwgYmF0Y2gubGVuZ3RoKQogICAgYXdhaXQgdGhpcy5mbHVzaCgpCiAgICB0aGlzLmJhc2UuX29ud2FrZXVwKCkKICB9CgogIGFzeW5jIF9zYXZlKCkgewogICAgY29uc3Qgc2xhYiA9IGI0YS5hbGxvY1Vuc2FmZSg4ICsgdGhpcy5fbWFwLnNpemUgKiA0MCkgLy8gMzIgKyA4CiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogMCwgYnVmZmVyOiBzbGFiIH0KCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB0aGlzLl9tYXAuc2l6ZSkKICAgIGZvciAoY29uc3QgbSBvZiB0aGlzLl9tYXAudmFsdWVzKCkpIFdha2V1cEVudHJ5LmVuY29kZShzdGF0ZSwgbSkKCiAgICBhd2FpdCB0aGlzLmJhc2UubG9jYWwuc2V0VXNlckRhdGEoJ2F1dG9iYXNlL3dha2V1cCcsIHNsYWIuc3ViYXJyYXkoMCwgc3RhdGUuc3RhcnQpKQogIH0KCiAgYXN5bmMgX2xvYWQoKSB7CiAgICBjb25zdCBidWZmZXIgPSBhd2FpdCB0aGlzLmJhc2UubG9jYWwuZ2V0VXNlckRhdGEoJ2F1dG9iYXNlL3dha2V1cCcpCiAgICBpZiAoIWJ1ZmZlcikgcmV0dXJuCgogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoLCBidWZmZXIgfQoKICAgIGxldCBsZW4gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgd2hpbGUgKGxlbi0tID4gMCkgewogICAgICBjb25zdCBtID0gV2FrZXVwRW50cnkuZGVjb2RlKHN0YXRlKQogICAgICB0aGlzLl9tYXAuc2V0KGI0YS50b1N0cmluZyhtLmtleSwgJ2hleCcpLCBtKQogICAgfQogIH0KCiAgYXN5bmMgX29wZW4oKSB7CiAgICBhd2FpdCB0aGlzLl9sb2FkKCkKCiAgICB0aGlzLl9yb290U3RvcmUud2F0Y2godGhpcy5fYWRkQm91bmQpCgogICAgZm9yIChjb25zdCBjb3JlIG9mIHRoaXMuX3Jvb3RTdG9yZS5jb3JlcykgewogICAgICBpZiAoY29yZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCBjb3JlLnJlYWR5KCkuY2F0Y2gobm9vcCkKICAgICAgaWYgKCFjb3JlLmNsb3NpbmcpIHRoaXMuYWRkKGNvcmUpCiAgICB9CiAgfQoKICBhc3luYyBfY2xvc2UoKSB7CiAgICB0aGlzLl9yb290U3RvcmUudW53YXRjaCh0aGlzLl9hZGRCb3VuZCkKCiAgICBmb3IgKGNvbnN0IGNvcmUgb2YgdGhpcy5fcm9vdFN0b3JlLmNvcmVzKSB7CiAgICAgIGlmIChjb3JlLm9wZW5lZCAmJiAhY29yZS5jbG9zaW5nKSB0aGlzLnJlbW92ZShjb3JlKQogICAgfQoKICAgIHRoaXMuX21hcC5jbGVhcigpCgogICAgd2hpbGUgKHRoaXMuZmx1c2hpbmcpIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLmZsdXNoaW5nCiAgICAgIH0gY2F0Y2gge30KICAgIH0KICB9CgogIHF1ZXVlKGtleSwgbGVuZ3RoKSB7CiAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykKICAgIGNvbnN0IG0gPSB0aGlzLl9tYXAuZ2V0KGhleCkKCiAgICBpZiAobSAmJiBtLmxlbmd0aCA+IGxlbmd0aCkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICB0aGlzLl9uZWVkc0ZsdXNoID0gdHJ1ZQogICAgdGhpcy5fbWFwLnNldChoZXgsIHsga2V5LCBsZW5ndGggfSkKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgdW5xdWV1ZShrZXksIGxlbmd0aCkgewogICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpCiAgICBjb25zdCBtID0gdGhpcy5fbWFwLmdldChoZXgpCgogICAgaWYgKCFtKSByZXR1cm4gdHJ1ZQogICAgaWYgKG0ubGVuZ3RoID4gbGVuZ3RoKSByZXR1cm4gZmFsc2UKCiAgICB0aGlzLl9uZWVkc0ZsdXNoID0gdHJ1ZQogICAgdGhpcy5fbWFwLmRlbGV0ZShoZXgpCgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgaWYgKHRoaXMuY2xvc2luZykgdGhyb3cgbmV3IEVycm9yKCdDbG9zaW5nJykKCiAgICAvLyB3YWl0IGZvciBzb21lb25lCiAgICBpZiAodGhpcy5mbHVzaGluZykgYXdhaXQgdGhpcy5mbHVzaGluZwoKICAgIC8vIGlmIGFub3RoZXIgc3RpbGwgYWN0aXZlIHRoZXkgZmx1c2hlZCB1cwogICAgaWYgKHRoaXMuZmx1c2hpbmcpIHJldHVybiB0aGlzLmZsdXNoaW5nCgogICAgaWYgKHRoaXMuX25lZWRzRmx1c2ggPT09IGZhbHNlKSByZXR1cm4KICAgIHRoaXMuX25lZWRzRmx1c2ggPSBmYWxzZQoKICAgIHRyeSB7CiAgICAgIHRoaXMuZmx1c2hpbmcgPSB0aGlzLl9zYXZlKCkKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZmx1c2hpbmcKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuZmx1c2hpbmcgPSBudWxsCiAgICB9CiAgfQoKICBhZGQoY29yZSkgewogICAgcmV0dXJuIHRoaXMuX2FkZChjb3JlKS5jYXRjaChzYWZldHlDYXRjaCkKICB9CgogIHJlbW92ZShjb3JlKSB7CiAgICByZXR1cm4gdGhpcy5fcmVtb3ZlKGNvcmUpCiAgfQoKICBhc3luYyBfYWRkKGNvcmUpIHsKICAgIGlmIChjb3JlLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IGNvcmUucmVhZHkoKQogICAgaWYgKGNvcmUuY2xvc2luZykgcmV0dXJuIGZhbHNlCgogICAgLy8gbG9jYWwgd3JpdGVyLCBubyBuZWVkCiAgICBpZiAoY29yZSA9PT0gdGhpcy5iYXNlLmxvY2FsLmNvcmUpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IHJ4ID0gY29yZS5zdG9yYWdlLnJlYWQoKQoKICAgIGNvbnN0IHJlZmVycmVyUHJvbWlzZSA9IHJ4LmdldFVzZXJEYXRhKCdyZWZlcnJlcicpCiAgICBjb25zdCB2aWV3UHJvbWlzZSA9IHJ4LmdldFVzZXJEYXRhKCdhdXRvYmFzZS92aWV3JykKCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgW3JlZmVycmVyLCB2aWV3XSA9IGF3YWl0IFByb21pc2UuYWxsKFtyZWZlcnJlclByb21pc2UsIHZpZXdQcm9taXNlXSkKICAgIGlmICh2aWV3KSByZXR1cm4gZmFsc2UKCiAgICBpZiAocmVmZXJyZXIgPT09IG51bGwgfHwgIWI0YS5lcXVhbHMocmVmZXJyZXIsIHRoaXMuYmFzZS5rZXkpKSByZXR1cm4gZmFsc2UKCiAgICBjb3JlLnByZXVwZGF0ZSA9IHRoaXMuX3ByZXVwZGF0ZUJvdW5kCgogICAgcmV0dXJuIHRydWUKICB9CgogIF9yZW1vdmUoY29yZSkgewogICAgaWYgKGNvcmUucHJldXBkYXRlICE9PSB0aGlzLl9wcmV1cGRhdGVCb3VuZCkgcmV0dXJuIGZhbHNlCiAgICBjb3JlLnByZXVwZGF0ZSA9IG51bGwKICAgIHJldHVybiB0cnVlCiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBSZWFkeVJlc291cmNlID0gcmVxdWlyZSgncmVhZHktcmVzb3VyY2UnKQpjb25zdCBhc3NlcnQgPSByZXF1aXJlKCduYW5vYXNzZXJ0JykKY29uc3QgU2lnbmFsUHJvbWlzZSA9IHJlcXVpcmUoJ3NpZ25hbC1wcm9taXNlJykKCmNvbnN0IExpbmVhcml6ZXIgPSByZXF1aXJlKCcuL2xpbmVhcml6ZXIuanMnKQpjb25zdCBOb2RlQnVmZmVyID0gcmVxdWlyZSgnLi9ub2RlLWJ1ZmZlci5qcycpCgpjb25zdCBNQVhfUFJFTE9BRCA9IDQKY29uc3QgTUFYX1BSRUZFVENIID0gMjU2Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFdyaXRlciBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yKGJhc2UsIGNvcmUsIGxlbmd0aCwgaXNSZW1vdmVkKSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5iYXNlID0gYmFzZQogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy5pc1JlbW92ZWQgPSBpc1JlbW92ZWQKICAgIHRoaXMudXBkYXRlZCA9IGZhbHNlCiAgICB0aGlzLnJhbmdlID0gbnVsbAogICAgdGhpcy5ub2RlcyA9IG5ldyBOb2RlQnVmZmVyKGxlbmd0aCkKICAgIHRoaXMubm9kZSA9IG51bGwKICAgIHRoaXMuaXNBY3RpdmUgPSBmYWxzZQogICAgdGhpcy5pc0N1cnJlbnRseUNvdXBsZWQgPSBmYWxzZQogICAgdGhpcy5pc0NvdXBsZWQgPSBmYWxzZSAvLyBtYWludGFpbmVkIGJ5IHVwZGF0ZUJvb3RzdHJhcFdyaXRlcnMKICAgIHRoaXMuaXNCb290c3RyYXAgPSBmYWxzZSAvLyBtYWludGFpbmVkIGJ5IHVwZGF0ZUJvb3RzdHJhcFdyaXRlcnMKICAgIHRoaXMuaXNBY3RpdmVJbmRleGVyID0gZmFsc2UKICAgIHRoaXMuYXZhaWxhYmxlID0gbGVuZ3RoCiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aAogICAgdGhpcy5zZWVuTGVuZ3RoID0gMAogICAgdGhpcy5yZWNvdmVyID0gZmFsc2UKICAgIHRoaXMuZnJvemVuID0gZmFsc2UKCiAgICB0aGlzLnN5bmNTaWduYWwgPSBudWxsCiAgfQoKICBfcGF1c2UoKSB7CiAgICBpZiAoIXRoaXMucmFuZ2UpIHJldHVybgogICAgdGhpcy5yYW5nZS5kZXN0cm95KCkKICAgIHRoaXMucmFuZ2UgPSBudWxsCiAgfQoKICBfcmVzdW1lKCkgewogICAgaWYgKHRoaXMucmFuZ2UpIHsKICAgICAgLy8gaWYgd2UgZGlkbnQgZmlsbCB1cCB0aGUgcHJlbG9hZCBidWZmZXIgeWV0LCBkbyBub3QgY29tbWl0IHRvIG1vcmUgd29yawogICAgICBpZiAodGhpcy5yYW5nZS5yYW5nZS5lbmQgPT09IHRoaXMubm9kZXMubGVuZ3RoICsgTUFYX1BSRUZFVENIKSByZXR1cm4KICAgICAgdGhpcy5yYW5nZS5kZXN0cm95KCkKICAgIH0KICAgIHRoaXMucmFuZ2UgPSB0aGlzLmNvcmUuZG93bmxvYWQoewogICAgICBzdGFydDogdGhpcy5ub2Rlcy5sZW5ndGgsCiAgICAgIGVuZDogdGhpcy5ub2Rlcy5sZW5ndGggKyBNQVhfUFJFRkVUQ0gsCiAgICAgIGxpbmVhcjogdHJ1ZQogICAgfSkKICB9CgogIF91cGRhdGVDb3VwbGluZygpIHsKICAgIGlmICghdGhpcy5iYXNlLl9jb3VwbGVyIHx8IHRoaXMuaXNDb3VwbGVkID09PSB0aGlzLmlzQ3VycmVudGx5Q291cGxlZCkgcmV0dXJuCgogICAgaWYgKHRoaXMuaXNDdXJyZW50bHlDb3VwbGVkKSB0aGlzLmJhc2UuX2NvdXBsZXIucmVtb3ZlKHRoaXMuY29yZSkKICAgIGVsc2UgdGhpcy5iYXNlLl9jb3VwbGVyLmFkZCh0aGlzLmNvcmUpCgogICAgdGhpcy5pc0N1cnJlbnRseUNvdXBsZWQgPSB0aGlzLmlzQ291cGxlZAogIH0KCiAgX3JlbW92ZUNvdXBsZSgpIHsKICAgIGlmICh0aGlzLmJhc2UuX2NvdXBsZXIgJiYgIXRoaXMuaXNDb3VwbGVkICYmIHRoaXMuaXNDdXJyZW50bHlDb3VwbGVkKSB7CiAgICAgIHRoaXMuaXNDdXJyZW50bHlDb3VwbGVkID0gZmFsc2UKICAgICAgdGhpcy5iYXNlLl9jb3VwbGVyLnJlbW92ZSh0aGlzLmNvcmUpCiAgICB9CiAgfQoKICB1cGRhdGVBY3Rpdml0eSgpIHsKICAgIGlmICghdGhpcy5jb3JlLm9wZW5lZCkgcmV0dXJuCgogICAgaWYgKHRoaXMuc2Vlbkxlbmd0aCA+IHRoaXMuY29yZS5sZW5ndGggfHwgdGhpcy5sZW5ndGggPCB0aGlzLmNvcmUubGVuZ3RoIHx8IHRoaXMuaXNCb290c3RyYXApIHsKICAgICAgLy8gaWYgd2UgaGF2ZSBzZWVuIGEgbGF0ZXIgY29yZSwgb3IgaWYgd2UgYXJlIGJlaGluZCwgb3IgaWYgYm9vdHN0cmFwCiAgICAgIHRoaXMuaXNBY3RpdmUgPSB0cnVlCiAgICAgIHRoaXMuY29yZS5zZXRBY3RpdmUodHJ1ZSkKICAgIH0gZWxzZSBpZiAodGhpcy5sZW5ndGggPT09IHRoaXMuY29yZS5sZW5ndGgpIHsKICAgICAgLy8gdGhpbmdzIGxvb2sgc3RlYWR5CiAgICAgIHRoaXMuaXNBY3RpdmUgPSBmYWxzZQogICAgICB0aGlzLmNvcmUuc2V0QWN0aXZlKGZhbHNlKQogICAgfQoKICAgIHRoaXMuX3VwZGF0ZUNvdXBsaW5nKCkKCiAgICBpZiAodGhpcy5jb3JlLndyaXRhYmxlKSByZXR1cm4KCiAgICBpZiAodGhpcy5iYXNlLmlzRmFzdEZvcndhcmRpbmcoKSB8fCAhdGhpcy5pc0FjdGl2ZSkgewogICAgICB0aGlzLl9wYXVzZSgpCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9yZXN1bWUoKQogICAgfQogIH0KCiAgc2V0Qm9vdHN0cmFwKGJvb2wpIHsKICAgIHRoaXMuaXNCb290c3RyYXAgPSBib29sCiAgICB0aGlzLnVwZGF0ZUFjdGl2aXR5KCkKICB9CgogIHNlZW4obGVuZ3RoKSB7CiAgICBpZiAobGVuZ3RoID4gdGhpcy5zZWVuTGVuZ3RoKSB0aGlzLnNlZW5MZW5ndGggPSBsZW5ndGgKICAgIHRoaXMudXBkYXRlQWN0aXZpdHkoKQogIH0KCiAgd2FpdEZvclN5bmNlZCgpIHsKICAgIGlmICh0aGlzLmNvcmUubGVuZ3RoID09PSB0aGlzLmxlbmd0aCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCiAgICBpZiAodGhpcy5zeW5jU2lnbmFsID09PSBudWxsKSB0aGlzLnN5bmNTaWduYWwgPSBuZXcgU2lnbmFsUHJvbWlzZSgpCiAgICByZXR1cm4gdGhpcy5zeW5jU2lnbmFsLndhaXQoKQogIH0KCiAgYXN5bmMgX29wZW4oKSB7CiAgICBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQogICAgYXdhaXQgdGhpcy5jb3JlLnNldFVzZXJEYXRhKCdyZWZlcnJlcicsIHRoaXMuYmFzZS5rZXkpCgogICAgLy8gYmFzZSBtaWdodCBiZSBjbG9zaW5nIGhlcmUKICAgIGlmICh0aGlzLmJhc2UuY2xvc2luZykgcmV0dXJuCgogICAgLy8gcmVtb3ZlIGxhdGVyCiAgICB0aGlzLnJlY292ZXIgPSBhdXRvUmVjb3Zlcih0aGlzLmNvcmUpCgogICAgLy8gYWRkIGl0IGFnYWluIGluY2FzZSBpdCB3YXNuJ3QgcmVhZGllZCBiZWZvcmUsIG9ubHkgbmVlZGVkIGlmIHRoaXMgaXMgdGhlIGZpcnN0IHRpbWUgd2Ugc2V0IHRoZSByZWZlcnJlci4uLgogICAgYXdhaXQgdGhpcy5iYXNlLl93YWtldXAuYWRkKHRoaXMuY29yZS5jb3JlKQoKICAgIHRoaXMudXBkYXRlQWN0aXZpdHkoKQoKICAgIGlmICh0aGlzLmNvcmUubGVuZ3RoID4gdGhpcy5sZW5ndGgpIHRoaXMuYmFzZS5fcXVldWVCdW1wKCkKCiAgICB0aGlzLmJhc2UuZW1pdCgnd3JpdGVyJywgdGhpcykKICB9CgogIF9jbG9zZSgpIHsKICAgIGlmICh0aGlzLnN5bmNTaWduYWwgIT09IG51bGwpIHRoaXMuc3luY1NpZ25hbC5ub3RpZnkoKQogICAgcmV0dXJuIHRoaXMuY29yZS5jbG9zZSgpCiAgfQoKICBnZXQgaW5kZXhlZCgpIHsKICAgIHJldHVybiB0aGlzLm5vZGVzLm9mZnNldAogIH0KCiAgaWRsZSgpIHsKICAgIHJldHVybiB0aGlzLmxlbmd0aCA9PT0gdGhpcy5hdmFpbGFibGUgJiYgdGhpcy5sZW5ndGggPT09IHRoaXMuY29yZS5sZW5ndGggJiYgdGhpcy5jb3JlLm9wZW5lZAogIH0KCiAgZmx1c2hlZCgpIHsKICAgIC8vIFRPRE86IHByb3AgYSBjbGVhbmVyIHdheSB0byBleHByZXNzIHRoaXMuLi4KICAgIHJldHVybiAoCiAgICAgIHRoaXMuc2Vlbkxlbmd0aCA8PSB0aGlzLmxlbmd0aCAmJgogICAgICB0aGlzLmxlbmd0aCA9PT0gdGhpcy5hdmFpbGFibGUgJiYKICAgICAgdGhpcy5sZW5ndGggPT09IHRoaXMuY29yZS5sZW5ndGggJiYKICAgICAgdGhpcy5zaGlmdGFibGUoKSA9PT0gZmFsc2UgJiYKICAgICAgIXRoaXMuY29yZS5jb3JlLnVwZ3JhZGluZyAmJgogICAgICB0aGlzLmNvcmUub3BlbmVkCiAgICApCiAgfQoKICBjb21wYXJlKHdyaXRlcikgewogICAgcmV0dXJuIGI0YS5jb21wYXJlKHRoaXMuY29yZS5rZXksIHdyaXRlci5jb3JlLmtleSkKICB9CgogIGhlYWQoKSB7CiAgICByZXR1cm4gdGhpcy5ub2Rlcy5nZXQodGhpcy5sZW5ndGggLSAxKQogIH0KCiAgYWR2YW5jZSgpIHsKICAgIGlmICh0aGlzLnN5bmNTaWduYWwgIT09IG51bGwgJiYgdGhpcy5sZW5ndGggKyAxID09PSB0aGlzLmNvcmUubGVuZ3RoKSB0aGlzLnN5bmNTaWduYWwubm90aWZ5KCkKICAgIHJldHVybiB0aGlzLmxlbmd0aCA8IHRoaXMuYXZhaWxhYmxlID8gdGhpcy5ub2Rlcy5nZXQodGhpcy5sZW5ndGgrKykgOiBudWxsCiAgfQoKICBzaGlmdGFibGUoKSB7CiAgICByZXR1cm4gdGhpcy5sZW5ndGggPiB0aGlzLm5vZGVzLm9mZnNldAogIH0KCiAgc2hpZnQoKSB7CiAgICBpZiAodGhpcy5zaGlmdGFibGUoKSA9PT0gZmFsc2UpIHJldHVybiBmYWxzZQoKICAgIGxldCBub2RlID0gdGhpcy5fc2hpZnRBbmRDbGVhcigpCiAgICB3aGlsZSAobm9kZS5iYXRjaCA+IDEpIG5vZGUgPSB0aGlzLl9zaGlmdEFuZENsZWFyKCkKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgZ2V0KHNlcSkgewogICAgcmV0dXJuIHNlcSA8IHRoaXMubGVuZ3RoID8gdGhpcy5ub2Rlcy5nZXQoc2VxKSA6IG51bGwKICB9CgogIGFwcGVuZCh2YWx1ZSwgaGVhZHMsIGJhdGNoLCBkZXBlbmRlbmNpZXMsIG9wdGltaXN0aWMpIHsKICAgIGNvbnN0IG5vZGUgPSBMaW5lYXJpemVyLmNyZWF0ZU5vZGUoCiAgICAgIHRoaXMsCiAgICAgIHRoaXMubm9kZXMubGVuZ3RoICsgMSwKICAgICAgdmFsdWUsCiAgICAgIGhlYWRzLAogICAgICBiYXRjaCwKICAgICAgZGVwZW5kZW5jaWVzLAogICAgICBvcHRpbWlzdGljCiAgICApCgogICAgbm9kZS5hY3R1YWxIZWFkcyA9IG5vZGUuaGVhZHMuc2xpY2UoMCkKCiAgICB0aGlzLm5vZGVzLnB1c2gobm9kZSkKICAgIHRoaXMuYXZhaWxhYmxlKysKICAgIHRoaXMubGVuZ3RoKysKCiAgICByZXR1cm4gbm9kZQogIH0KCiAgYXN5bmMgdXBkYXRlKGJvb3QpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKHRoaXMuZnJvemVuKSByZXR1cm4gZmFsc2UKCiAgICAvLyBpZiB0aGlzIGlzIGEgYm9vdCBub2RlLCBETyBOT1QsIHByZWxvYWQgYXMgdGhhdCB3aWxsIG1ha2UgaXQgbG9hZAogICAgLy8gYW5kIHJlamVjdCBub2RlcyBiYXNlZCBvbiB0aGUgdG1wIHN0YXRlIG9mIHRoZSBzeXN0ZW0uCiAgICAvLyBwcm9wIG5lZWRzIGEgYmV0dGVyIHNvbHV0aW9uIGJ1dCB0aGlzIHdvcmtzIGZvciBub3cKICAgIGNvbnN0IHByZWxvYWQgPSBib290ID8gMSA6IE1BWF9QUkVMT0FECgogICAgd2hpbGUgKHRoaXMuYXZhaWxhYmxlIC0gdGhpcy5sZW5ndGggPCBwcmVsb2FkKSB7CiAgICAgIC8vIHF1aWNrIHNhbml0eSBjaGVjawogICAgICBpZiAodGhpcy5ub2Rlcy5sZW5ndGggPT09IHRoaXMuY29yZS5sZW5ndGggfHwgdGhpcy5jb3JlLmxlbmd0aCA9PT0gMCkgYnJlYWsKCiAgICAgIC8vIGxvYWQgbmV4dCBub2RlCiAgICAgIGlmICh0aGlzLm5vZGUgPT09IG51bGwgJiYgIShhd2FpdCB0aGlzLl9sb2FkTmV4dE5vZGUoKSkpIGJyZWFrCiAgICAgIGlmICghKGF3YWl0IHRoaXMuX2Vuc3VyZU5vZGVEZXBlbmRlbmNpZXMoYm9vdCkpKSBicmVhawoKICAgICAgaWYgKHRoaXMucmVjb3ZlcikgdGhpcy5ub2RlLnZhbHVlID0gbnVsbAoKICAgICAgdGhpcy5ub2Rlcy5wdXNoKHRoaXMubm9kZSkKICAgICAgaWYgKHRoaXMubm9kZS5iYXRjaCA9PT0gMSkgdGhpcy5hdmFpbGFibGUgPSB0aGlzLm5vZGVzLmxlbmd0aAogICAgICB0aGlzLm5vZGUgPSBudWxsCiAgICB9CgogICAgdGhpcy51cGRhdGVBY3Rpdml0eSgpCgogICAgcmV0dXJuIHRoaXMubGVuZ3RoIDwgdGhpcy5hdmFpbGFibGUKICB9CgogIF9zaGlmdEFuZENsZWFyKCkgewogICAgY29uc3Qgbm9kZSA9IHRoaXMubm9kZXMuc2hpZnQoKQogICAgbm9kZS5jbGVhcigpCiAgICByZXR1cm4gbm9kZQogIH0KCiAgYXN5bmMgX2xvYWROZXh0Tm9kZSgpIHsKICAgIGNvbnN0IHNlcSA9IHRoaXMubm9kZXMubGVuZ3RoCgogICAgaWYgKCEoYXdhaXQgdGhpcy5jb3JlLmhhcyhzZXEpKSkgcmV0dXJuIGZhbHNlCgogICAgdHJ5IHsKICAgICAgY29uc3QgeyBub2RlLCBvcHRpbWlzdGljLCB0cmFjZSB9ID0gYXdhaXQgdGhpcy5jb3JlLmdldChzZXEsIHsgd2FpdDogZmFsc2UgfSkKCiAgICAgIGNvbnN0IHZhbHVlID0gbm9kZS52YWx1ZSA9PSBudWxsID8gbnVsbCA6IGMuZGVjb2RlKHRoaXMuYmFzZS52YWx1ZUVuY29kaW5nLCBub2RlLnZhbHVlKQogICAgICB0aGlzLm5vZGUgPSBMaW5lYXJpemVyLmNyZWF0ZU5vZGUoCiAgICAgICAgdGhpcywKICAgICAgICBzZXEgKyAxLAogICAgICAgIHZhbHVlLAogICAgICAgIG5vZGUuaGVhZHMsCiAgICAgICAgbm9kZS5iYXRjaCwKICAgICAgICBuZXcgU2V0KCksCiAgICAgICAgb3B0aW1pc3RpYywKICAgICAgICB0cmFjZQogICAgICApCiAgICAgIHJldHVybiB0cnVlCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5mcm96ZW4gPSB0cnVlCiAgICAgIHRocm93IGVycgogICAgfQogIH0KCiAgYXN5bmMgX2Vuc3VyZU5vZGVEZXBlbmRlbmNpZXMoYm9vdCkgewogICAgd2hpbGUgKHRoaXMubm9kZS5kZXBlbmRlbmNpZXMuc2l6ZSA8IHRoaXMubm9kZS5oZWFkcy5sZW5ndGgpIHsKICAgICAgY29uc3QgcmF3SGVhZCA9IHRoaXMubm9kZS5oZWFkc1t0aGlzLm5vZGUuZGVwZW5kZW5jaWVzLnNpemVdCgogICAgICBjb25zdCBoZWFkV3JpdGVyID0gYXdhaXQgdGhpcy5iYXNlLl9nZXRXcml0ZXJCeUtleSgKICAgICAgICByYXdIZWFkLmtleSwKICAgICAgICAtMSwKICAgICAgICByYXdIZWFkLmxlbmd0aCwKICAgICAgICB0cnVlLAogICAgICAgIGZhbHNlLAogICAgICAgIGJvb3QKICAgICAgKQoKICAgICAgaWYgKGhlYWRXcml0ZXIgIT09IHRoaXMgJiYgKGhlYWRXcml0ZXIgPT09IG51bGwgfHwgaGVhZFdyaXRlci5sZW5ndGggPCByYXdIZWFkLmxlbmd0aCkpIHsKICAgICAgICBpZiAoIWJvb3QpIHRoaXMuYmFzZS5fZW5zdXJlV2FrZXVwKGhlYWRXcml0ZXIpCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgIH0KCiAgICAgIGxldCBoZWFkTm9kZSA9IGhlYWRXcml0ZXIubm9kZXMuZ2V0KHJhd0hlYWQubGVuZ3RoIC0gMSkKCiAgICAgIC8vIGNvdWxkIGJlIGEgc3R1YiBub2RlCiAgICAgIGlmICghaGVhZE5vZGUpIHsKICAgICAgICBmb3IgKGNvbnN0IG5vZGUgb2YgdGhpcy5iYXNlLmxpbmVhcml6ZXIuaGVhZHMpIHsKICAgICAgICAgIGlmICghY29tcGFyZUhlYWQobm9kZSwgcmF3SGVhZCkpIGNvbnRpbnVlCiAgICAgICAgICBoZWFkTm9kZSA9IG5vZGUKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBUT0RPOiBnZW5lcmFsaXNlIERBRyB2YWxpZGF0aW9uIGFuZCBmcmVlemUgdGhlIHdyaXRlcgogICAgICBhc3NlcnQoIXRoaXMubm9kZS5kZXBlbmRlbmNpZXMuaGFzKGhlYWROb2RlKSwgJ0NvcnJ1cHRlZCBEQUcnKQoKICAgICAgLy8gVE9ETzogYmV0dGVyIHdheSB0byBzb2x2ZSB0aGUgc3R1YiBjaGVjayBpcyB0byBuZXZlciBtdXRhdGUgaGVhZHMgYmVsb3cKICAgICAgaWYgKGhlYWROb2RlID09PSBudWxsKSB7CiAgICAgICAgLy8gYWxyZWFkeSB5aWVsZGVkCiAgICAgICAgdGhpcy5ub2RlLmhlYWRzLnNwbGljZSh0aGlzLm5vZGUuZGVwZW5kZW5jaWVzLnNpemUsIDEpCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgdGhpcy5ub2RlLmRlcGVuZGVuY2llcy5hZGQoaGVhZE5vZGUpCiAgICB9CgogICAgLy8gYWx3YXlzIGxpbmsgcHJldmlvdXMgbm9kZSBpZiBpdCdzIG5vdCBpbmRleGVkCiAgICBjb25zdCBvZmZzZXQgPSB0aGlzLm5vZGUubGVuZ3RoIC0gMQogICAgaWYgKG9mZnNldCA+IHRoaXMuaW5kZXhlZCkgewogICAgICB0aGlzLm5vZGUuZGVwZW5kZW5jaWVzLmFkZCh0aGlzLm5vZGVzLmdldChvZmZzZXQgLSAxKSkKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KfQoKZnVuY3Rpb24gY29tcGFyZUhlYWQobm9kZSwgaGVhZCkgewogIGlmIChub2RlLmxlbmd0aCAhPT0gaGVhZC5sZW5ndGgpIHJldHVybiBmYWxzZQogIHJldHVybiBiNGEuZXF1YWxzKG5vZGUud3JpdGVyLmNvcmUua2V5LCBoZWFkLmtleSkKfQoKLy8gdGhpcyBpcyBhIGxpc3Qgb2YgcGVlcnMgd2UgYnVnZ2VkIGluIHRoZSBidGMgYW5kIHBsYW5iIHJvb20uCi8vIGFkZGluZyB0aGVtIGhlcmUgc28gbWlncmF0aW9uIGNhbiBydW4sIGNhbiBiZSByZW1vdmVkIGluIGEgbW9udGggb3Igc28gZnJvbSB0aW1lIG9mIGNvbW1pdAovLyBub3RlLCBubyBzZWN1cml0eSBpbXBsaWNhdGlvbnMgb2YgdGhpcywgd2UganVzdCBudWxsIHRoZW0gb3V0LgoKZnVuY3Rpb24gYXV0b1JlY292ZXIoY29yZSkgewogIGFzc2VydChjb3JlLm9wZW5lZCkKCiAgc3dpdGNoIChjb3JlLmlkKSB7CiAgICBjYXNlICdnaHJwZXhhYm91dGRtNDZvbWJxaG83bXJveGtuYXNzbm50cnh4M2N1YmZ1eDRxaTZ3Nmh5JzoKICAgIGNhc2UgJ3FvYWFuYW83MXM0aGUxcmNkMTk3ZDMzNnFlcHlrazQ0NjdnZW8xdXE4Y3duem1wYjc4Nm8nOgogICAgY2FzZSAnZm9taGR4Z240ajR0empxeTZ5N2lza2hmZmltem9rdDdrcmFkZHlkOG9yY2h0M3I4cTYxbyc6CiAgICBjYXNlICdkOGY1dGF4eHJpdDUxYXBmdG9pMzhlNWI4NmhiOThjZ2ZkN2RmcDN1bzF1b2g5NXF0NDlvJzoKICAgIGNhc2UgJ29ianlmNzV1Z2dzcXBqY3V0Njl4ZGdqNDZrczhyNzFqanJxN294ZGZzejk1c3N0Y2hrbm8nOgogICAgICByZXR1cm4gdHJ1ZQogIH0KCiAgcmV0dXJuIGZhbHNlCn0KewogICJuYW1lIjogImF1dG9iYXNlIiwKICAidmVyc2lvbiI6ICI3LjI0LjAiLAogICJkZXNjcmlwdGlvbiI6ICJBIG11bHRpd3JpdGVyIGRhdGEgc3RydWN0dXJlIGZvciBIeXBlcmNvcmUiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLiAtLXdyaXRlIiwKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBicml0dGxlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmVuY3J5cHRlZCI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYnJpdHRsZSB0ZXN0L2FsbC5qcyAtLWVuY3J5cHQtYWxsIiwKICAgICJ0ZXN0OmZpeHR1cmVzIjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBicml0dGxlIHRlc3QvZml4dHVyZXMvdGVzdHMvKi5qcyIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC9hbGwuanMiLAogICAgImZ1eno6Z2VuZXJhdGVkIjogImJyaXR0bGUgdGVzdC9yZWZlcmVuY2UvZnV6ei9nZW5lcmF0ZWQvKi5qcyIsCiAgICAiZnV6ejptYWluIjogIm5vZGUgdGVzdC9mdXp6L2luZGV4LmpzIiwKICAgICJmdXp6IjogIm5vZGUgdGVzdC9yZWZlcmVuY2UvZnV6ei9mdXp6LmpzIiwKICAgICJnZW5lcmF0ZS1maXh0dXJlcyI6ICJub2RlIHRlc3QvZml4dHVyZXMvZ2VuZXJhdGUvYWxsLmpzIgogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJsaWIvKioiLAogICAgImVuY29kaW5nLyoqIgogIF0sCiAgImltcG9ydHMiOiB7CiAgICAiZXZlbnRzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWV2ZW50cyIsCiAgICAgICJkZWZhdWx0IjogImV2ZW50cyIKICAgIH0KICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9hdXRvYmFzZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9hdXRvYmFzZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2F1dG9iYXNlI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi4xIiwKICAgICJiYXJlLWV2ZW50cyI6ICJeMi4yLjAiLAogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuMTYuMCIsCiAgICAiY29yZS1jb3VwbGVyIjogIl4yLjAuMCIsCiAgICAiZGVib3VuY2VpZnkiOiAiXjEuMC4wIiwKICAgICJoeXBlcmJlZSI6ICJeMi4yMi4wIiwKICAgICJoeXBlcmNvcmUiOiAiXjExLjQuMCIsCiAgICAiaHlwZXJjb3JlLWNyeXB0byI6ICJeMy40LjAiLAogICAgImh5cGVyY29yZS1pZC1lbmNvZGluZyI6ICJeMS4yLjAiLAogICAgImh5cGVyc2NoZW1hIjogIl4xLjEyLjEiLAogICAgImluZGV4LWVuY29kZXIiOiAiXjMuMy4yIiwKICAgICJuYW5vYXNzZXJ0IjogIl4yLjAuMCIsCiAgICAicHJvdG9tdXgtd2FrZXVwIjogIl4yLjAuMCIsCiAgICAicmVhZHktcmVzb3VyY2UiOiAiXjEuMC4wIiwKICAgICJyZXNvbHZlLXJlamVjdC1wcm9taXNlIjogIl4xLjEuMCIsCiAgICAic2FmZXR5LWNhdGNoIjogIl4xLjAuMiIsCiAgICAic2NvcGUtbG9jayI6ICJeMS4yLjQiLAogICAgInNpZ25hbC1wcm9taXNlIjogIl4xLjAuMyIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjEiLAogICAgInN1Yi1lbmNvZGVyIjogIl4yLjEuMSIsCiAgICAidGlueS1idWZmZXItbWFwIjogIl4xLjEuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYXV0b2Jhc2UtdGVzdC1oZWxwZXJzIjogIl4zLjAuMCIsCiAgICAiYnJpdHRsZSI6ICJeMy4xLjEiLAogICAgImNvcmVzdG9yZSI6ICJeNy4wLjE1IiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIiwKICAgICJyYWNoZSI6ICJeMS4wLjAiLAogICAgInNhbWUtZGF0YSI6ICJeMS4wLjAiLAogICAgInRhc2stYmFja29mZiI6ICJeMS4wLjAiLAogICAgInRlc3QtdG1wIjogIl4xLjIuMCIsCiAgICAidW5jYXVnaHRzIjogIl4xLjEuMCIKICB9LAogICJzdGFuZGFyZCI6IHsKICAgICJpZ25vcmUiOiBbCiAgICAgICIqKi90ZXN0L2Z1enovZ2VuZXJhdGVkLyoqIiwKICAgICAgIioqL3Rlc3QvcmVmZXJlbmNlLyoqIiwKICAgICAgImV4YW1wbGUubWpzIgogICAgXQogIH0KfQpmdW5jdGlvbiBpc0J1ZmZlcih2YWx1ZSkgewogIHJldHVybiBCdWZmZXIuaXNCdWZmZXIodmFsdWUpIHx8IHZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheQp9CgpmdW5jdGlvbiBpc0VuY29kaW5nKGVuY29kaW5nKSB7CiAgcmV0dXJuIEJ1ZmZlci5pc0VuY29kaW5nKGVuY29kaW5nKQp9CgpmdW5jdGlvbiBhbGxvYyhzaXplLCBmaWxsLCBlbmNvZGluZykgewogIHJldHVybiBCdWZmZXIuYWxsb2Moc2l6ZSwgZmlsbCwgZW5jb2RpbmcpCn0KCmZ1bmN0aW9uIGFsbG9jVW5zYWZlKHNpemUpIHsKICByZXR1cm4gQnVmZmVyLmFsbG9jVW5zYWZlKHNpemUpCn0KCmZ1bmN0aW9uIGFsbG9jVW5zYWZlU2xvdyhzaXplKSB7CiAgcmV0dXJuIEJ1ZmZlci5hbGxvY1Vuc2FmZVNsb3coc2l6ZSkKfQoKZnVuY3Rpb24gYnl0ZUxlbmd0aChzdHJpbmcsIGVuY29kaW5nKSB7CiAgcmV0dXJuIEJ1ZmZlci5ieXRlTGVuZ3RoKHN0cmluZywgZW5jb2RpbmcpCn0KCmZ1bmN0aW9uIGNvbXBhcmUoYSwgYikgewogIHJldHVybiBCdWZmZXIuY29tcGFyZShhLCBiKQp9CgpmdW5jdGlvbiBjb25jYXQoYnVmZmVycywgdG90YWxMZW5ndGgpIHsKICByZXR1cm4gQnVmZmVyLmNvbmNhdChidWZmZXJzLCB0b3RhbExlbmd0aCkKfQoKZnVuY3Rpb24gY29weShzb3VyY2UsIHRhcmdldCwgdGFyZ2V0U3RhcnQsIHN0YXJ0LCBlbmQpIHsKICByZXR1cm4gdG9CdWZmZXIoc291cmNlKS5jb3B5KHRhcmdldCwgdGFyZ2V0U3RhcnQsIHN0YXJ0LCBlbmQpCn0KCmZ1bmN0aW9uIGVxdWFscyhhLCBiKSB7CiAgcmV0dXJuIHRvQnVmZmVyKGEpLmVxdWFscyhiKQp9CgpmdW5jdGlvbiBmaWxsKGJ1ZmZlciwgdmFsdWUsIG9mZnNldCwgZW5kLCBlbmNvZGluZykgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLmZpbGwodmFsdWUsIG9mZnNldCwgZW5kLCBlbmNvZGluZykKfQoKZnVuY3Rpb24gZnJvbSh2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CiAgcmV0dXJuIEJ1ZmZlci5mcm9tKHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCn0KCmZ1bmN0aW9uIGluY2x1ZGVzKGJ1ZmZlciwgdmFsdWUsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikuaW5jbHVkZXModmFsdWUsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKQp9CgpmdW5jdGlvbiBpbmRleE9mKGJ1ZmZlciwgdmFsdWUsIGJ5ZmVPZmZzZXQsIGVuY29kaW5nKSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikuaW5kZXhPZih2YWx1ZSwgYnlmZU9mZnNldCwgZW5jb2RpbmcpCn0KCmZ1bmN0aW9uIGxhc3RJbmRleE9mKGJ1ZmZlciwgdmFsdWUsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikubGFzdEluZGV4T2YodmFsdWUsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKQp9CgpmdW5jdGlvbiBzd2FwMTYoYnVmZmVyKSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikuc3dhcDE2KCkKfQoKZnVuY3Rpb24gc3dhcDMyKGJ1ZmZlcikgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnN3YXAzMigpCn0KCmZ1bmN0aW9uIHN3YXA2NChidWZmZXIpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5zd2FwNjQoKQp9CgpmdW5jdGlvbiB0b0J1ZmZlcihidWZmZXIpIHsKICBpZiAoQnVmZmVyLmlzQnVmZmVyKGJ1ZmZlcikpIHJldHVybiBidWZmZXIKICByZXR1cm4gQnVmZmVyLmZyb20oYnVmZmVyLmJ1ZmZlciwgYnVmZmVyLmJ5dGVPZmZzZXQsIGJ1ZmZlci5ieXRlTGVuZ3RoKQp9CgpmdW5jdGlvbiB0b1N0cmluZyhidWZmZXIsIGVuY29kaW5nLCBzdGFydCwgZW5kKSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikudG9TdHJpbmcoZW5jb2RpbmcsIHN0YXJ0LCBlbmQpCn0KCmZ1bmN0aW9uIHdyaXRlKGJ1ZmZlciwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCwgZW5jb2RpbmcpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS53cml0ZShzdHJpbmcsIG9mZnNldCwgbGVuZ3RoLCBlbmNvZGluZykKfQoKZnVuY3Rpb24gcmVhZERvdWJsZUJFKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikucmVhZERvdWJsZUJFKG9mZnNldCkKfQoKZnVuY3Rpb24gcmVhZERvdWJsZUxFKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikucmVhZERvdWJsZUxFKG9mZnNldCkKfQoKZnVuY3Rpb24gcmVhZEZsb2F0QkUoYnVmZmVyLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5yZWFkRmxvYXRCRShvZmZzZXQpCn0KCmZ1bmN0aW9uIHJlYWRGbG9hdExFKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikucmVhZEZsb2F0TEUob2Zmc2V0KQp9CgpmdW5jdGlvbiByZWFkSW50MzJCRShidWZmZXIsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnJlYWRJbnQzMkJFKG9mZnNldCkKfQoKZnVuY3Rpb24gcmVhZEludDMyTEUoYnVmZmVyLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5yZWFkSW50MzJMRShvZmZzZXQpCn0KCmZ1bmN0aW9uIHJlYWRVSW50MzJCRShidWZmZXIsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnJlYWRVSW50MzJCRShvZmZzZXQpCn0KCmZ1bmN0aW9uIHJlYWRVSW50MzJMRShidWZmZXIsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnJlYWRVSW50MzJMRShvZmZzZXQpCn0KCmZ1bmN0aW9uIHdyaXRlRG91YmxlQkUoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikud3JpdGVEb3VibGVCRSh2YWx1ZSwgb2Zmc2V0KQp9CgpmdW5jdGlvbiB3cml0ZURvdWJsZUxFKGJ1ZmZlciwgdmFsdWUsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLndyaXRlRG91YmxlTEUodmFsdWUsIG9mZnNldCkKfQoKZnVuY3Rpb24gd3JpdGVGbG9hdEJFKGJ1ZmZlciwgdmFsdWUsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLndyaXRlRmxvYXRCRSh2YWx1ZSwgb2Zmc2V0KQp9CgpmdW5jdGlvbiB3cml0ZUZsb2F0TEUoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikud3JpdGVGbG9hdExFKHZhbHVlLCBvZmZzZXQpCn0KCmZ1bmN0aW9uIHdyaXRlSW50MzJCRShidWZmZXIsIHZhbHVlLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS53cml0ZUludDMyQkUodmFsdWUsIG9mZnNldCkKfQoKZnVuY3Rpb24gd3JpdGVJbnQzMkxFKGJ1ZmZlciwgdmFsdWUsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLndyaXRlSW50MzJMRSh2YWx1ZSwgb2Zmc2V0KQp9CgpmdW5jdGlvbiB3cml0ZVVJbnQzMkJFKGJ1ZmZlciwgdmFsdWUsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLndyaXRlVUludDMyQkUodmFsdWUsIG9mZnNldCkKfQoKZnVuY3Rpb24gd3JpdGVVSW50MzJMRShidWZmZXIsIHZhbHVlLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS53cml0ZVVJbnQzMkxFKHZhbHVlLCBvZmZzZXQpCn0KCm1vZHVsZS5leHBvcnRzID0gewogIGlzQnVmZmVyLAogIGlzRW5jb2RpbmcsCiAgYWxsb2MsCiAgYWxsb2NVbnNhZmUsCiAgYWxsb2NVbnNhZmVTbG93LAogIGJ5dGVMZW5ndGgsCiAgY29tcGFyZSwKICBjb25jYXQsCiAgY29weSwKICBlcXVhbHMsCiAgZmlsbCwKICBmcm9tLAogIGluY2x1ZGVzLAogIGluZGV4T2YsCiAgbGFzdEluZGV4T2YsCiAgc3dhcDE2LAogIHN3YXAzMiwKICBzd2FwNjQsCiAgdG9CdWZmZXIsCiAgdG9TdHJpbmcsCiAgd3JpdGUsCiAgcmVhZERvdWJsZUJFLAogIHJlYWREb3VibGVMRSwKICByZWFkRmxvYXRCRSwKICByZWFkRmxvYXRMRSwKICByZWFkSW50MzJCRSwKICByZWFkSW50MzJMRSwKICByZWFkVUludDMyQkUsCiAgcmVhZFVJbnQzMkxFLAogIHdyaXRlRG91YmxlQkUsCiAgd3JpdGVEb3VibGVMRSwKICB3cml0ZUZsb2F0QkUsCiAgd3JpdGVGbG9hdExFLAogIHdyaXRlSW50MzJCRSwKICB3cml0ZUludDMyTEUsCiAgd3JpdGVVSW50MzJCRSwKICB3cml0ZVVJbnQzMkxFCn0KewogICJuYW1lIjogImI0YSIsCiAgInZlcnNpb24iOiAiMS43LjMiLAogICJkZXNjcmlwdGlvbiI6ICJCcmlkZ2luZyB0aGUgZ2FwIGJldHdlZW4gYnVmZmVycyBhbmQgdHlwZWQgYXJyYXlzIiwKICAiZXhwb3J0cyI6IHsKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4iOiB7CiAgICAgICJyZWFjdC1uYXRpdmUiOiAiLi9yZWFjdC1uYXRpdmUuanMiLAogICAgICAiYnJvd3NlciI6ICIuL2Jyb3dzZXIuanMiLAogICAgICAiZGVmYXVsdCI6ICIuL2luZGV4LmpzIgogICAgfQogIH0sCiAgImZpbGVzIjogWwogICAgImJyb3dzZXIuanMiLAogICAgImluZGV4LmpzIiwKICAgICJyZWFjdC1uYXRpdmUuanMiLAogICAgImxpYiIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAibnBtIHJ1biBsaW50ICYmIG5wbSBydW4gdGVzdDpiYXJlICYmIG5wbSBydW4gdGVzdDpub2RlIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0Lm1qcyIsCiAgICAidGVzdDpub2RlIjogIm5vZGUgdGVzdC5tanMiLAogICAgImxpbnQiOiAicHJldHRpZXIgLiAtLWNoZWNrIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2I0YS5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iNGEvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iNGEjcmVhZG1lIiwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuNS4yIiwKICAgICJuYW5vYmVuY2giOiAiXjMuMC4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjEuMC4wIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXMiOiB7CiAgICAicmVhY3QtbmF0aXZlLWI0YSI6ICIqIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXNNZXRhIjogewogICAgInJlYWN0LW5hdGl2ZS1iNGEiOiB7CiAgICAgICJvcHRpb25hbCI6IHRydWUKICAgIH0KICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCkKY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9saWIvY29uc3RhbnRzJykKY29uc3QgSGFzaCA9IHJlcXVpcmUoJy4vbGliL2hhc2gnKQpjb25zdCBIbWFjID0gcmVxdWlyZSgnLi9saWIvaG1hYycpCmNvbnN0IHsgQ2lwaGVyaXYsIERlY2lwaGVyaXYgfSA9IHJlcXVpcmUoJy4vbGliL2NpcGhlcicpCmNvbnN0IHsgcmFuZG9tQnl0ZXMsIHJhbmRvbUZpbGwsIHJhbmRvbVVVSUQgfSA9IHJlcXVpcmUoJy4vbGliL3JhbmRvbScpCmNvbnN0IHBia2RmMiA9IHJlcXVpcmUoJy4vbGliL3Bia2RmMicpCmNvbnN0IHsgZ2VuZXJhdGVLZXlQYWlyIH0gPSByZXF1aXJlKCcuL2xpYi9rZXknKQpjb25zdCB7IHNpZ24sIHZlcmlmeSB9ID0gcmVxdWlyZSgnLi9saWIvc2lnbmF0dXJlJykKCmV4cG9ydHMuY29uc3RhbnRzID0gY29uc3RhbnRzCgpleHBvcnRzLkhhc2ggPSBIYXNoCgpleHBvcnRzLmNyZWF0ZUhhc2ggPSBmdW5jdGlvbiBjcmVhdGVIYXNoKGFsZ29yaXRobSwgb3B0cykgewogIHJldHVybiBuZXcgSGFzaChhbGdvcml0aG0sIG9wdHMpCn0KCmV4cG9ydHMuSG1hYyA9IEhtYWMKCmV4cG9ydHMuY3JlYXRlSG1hYyA9IGZ1bmN0aW9uIGNyZWF0ZUhtYWMoYWxnb3JpdGhtLCBrZXksIG9wdHMpIHsKICByZXR1cm4gbmV3IEhtYWMoYWxnb3JpdGhtLCBrZXksIG9wdHMpCn0KCmV4cG9ydHMuQ2lwaGVyaXYgPSBDaXBoZXJpdgoKZXhwb3J0cy5jcmVhdGVDaXBoZXJpdiA9IGZ1bmN0aW9uIGNyZWF0ZUNpcGhlcml2KGFsZ29yaXRobSwga2V5LCBpdiwgb3B0cykgewogIHJldHVybiBuZXcgQ2lwaGVyaXYoYWxnb3JpdGhtLCBrZXksIGl2LCBvcHRzKQp9CgpleHBvcnRzLkRlY2lwaGVyaXYgPSBEZWNpcGhlcml2CgpleHBvcnRzLmNyZWF0ZURlY2lwaGVyaXYgPSBmdW5jdGlvbiBjcmVhdGVEZWNpcGhlcml2KGFsZ29yaXRobSwga2V5LCBpdiwgb3B0cykgewogIHJldHVybiBuZXcgRGVjaXBoZXJpdihhbGdvcml0aG0sIGtleSwgaXYsIG9wdHMpCn0KCmV4cG9ydHMucmFuZG9tQnl0ZXMgPSByYW5kb21CeXRlcwoKZXhwb3J0cy5yYW5kb21GaWxsID0gcmFuZG9tRmlsbAoKLy8gRm9yIE5vZGUuanMgY29tcGF0aWJpbGl0eQpleHBvcnRzLnJhbmRvbUZpbGxTeW5jID0gZnVuY3Rpb24gcmFuZG9tRmlsbFN5bmMoYnVmZmVyLCBvZmZzZXQsIHNpemUpIHsKICByZXR1cm4gZXhwb3J0cy5yYW5kb21GaWxsKGJ1ZmZlciwgb2Zmc2V0LCBzaXplKQp9CgpleHBvcnRzLnJhbmRvbVVVSUQgPSByYW5kb21VVUlECgpleHBvcnRzLnBia2RmMiA9IHBia2RmMgoKLy8gRm9yIE5vZGUuanMgY29tcGF0aWJpbGl0eQpleHBvcnRzLnBia2RmMlN5bmMgPSBmdW5jdGlvbiBwYmtkZjJTeW5jKHBhc3N3b3JkLCBzYWx0LCBpdGVyYXRpb25zLCBrZXlsZW4sIGRpZ2VzdCkgewogIHJldHVybiBleHBvcnRzLnBia2RmMihwYXNzd29yZCwgc2FsdCwgaXRlcmF0aW9ucywga2V5bGVuLCBkaWdlc3QpCn0KCmV4cG9ydHMuZ2VuZXJhdGVLZXlQYWlyID0gZ2VuZXJhdGVLZXlQYWlyCgpleHBvcnRzLnNpZ24gPSBzaWduCgpleHBvcnRzLnZlcmlmeSA9IHZlcmlmeQoKLy8gRm9yIE5vZGUuanMgY29tcGF0aWJpbGl0eQpleHBvcnRzLndlYmNyeXB0byA9IHJlcXVpcmUoJy4vd2ViJykKY29uc3QgeyBUcmFuc2Zvcm0gfSA9IHJlcXVpcmUoJ2JhcmUtc3RyZWFtJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQpjb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgpjb25zdCB7CiAgY2lwaGVyOiB7CiAgICBBRVMxMjhFQ0IsCiAgICBBRVMxMjhDQkMsCiAgICBBRVMxMjhDVFIsCiAgICBBRVMxMjhPRkIsCiAgICBBRVMyNTZFQ0IsCiAgICBBRVMyNTZDQkMsCiAgICBBRVMyNTZDVFIsCiAgICBBRVMyNTZPRkIsCiAgICBBRVMxMjhHQ00sCiAgICBBRVMyNTZHQ00sCiAgICBDSEFDSEEyMFBPTFkxMzA1LAogICAgWENIQUNIQTIwUE9MWTEzMDUKICB9Cn0gPSBjb25zdGFudHMKCmNsYXNzIENyeXB0b0NpcGhlciB7CiAgY29uc3RydWN0b3IoYWxnb3JpdGhtLCBrZXksIGl2LCBlbmNyeXB0LCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgZW5jb2RpbmcgPSAndXRmOCcgfSA9IG9wdHMKCiAgICBpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycpIGtleSA9IEJ1ZmZlci5mcm9tKGtleSwgZW5jb2RpbmcpCiAgICBpZiAodHlwZW9mIGl2ID09PSAnc3RyaW5nJykgaXYgPSBCdWZmZXIuZnJvbShpdiwgZW5jb2RpbmcpCgogICAgaWYgKGtleS5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNpcGhlcktleUxlbmd0aChhbGdvcml0aG0pKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbnZhbGlkIGtleSBsZW5ndGgnKQogICAgfQoKICAgIGlmIChpdi5ieXRlTGVuZ3RoIDwgYmluZGluZy5jaXBoZXJJVkxlbmd0aChhbGdvcml0aG0pKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbnZhbGlkIGl2IGxlbmd0aCcpCiAgICB9CgogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5jaXBoZXJJbml0KAogICAgICBhbGdvcml0aG0sCiAgICAgIGtleS5idWZmZXIsCiAgICAgIGtleS5ieXRlT2Zmc2V0LAogICAgICBrZXkuYnl0ZUxlbmd0aCwKICAgICAgaXYuYnVmZmVyLAogICAgICBpdi5ieXRlT2Zmc2V0LAogICAgICBpdi5ieXRlTGVuZ3RoLAogICAgICBlbmNyeXB0CiAgICApCiAgfQoKICB1cGRhdGUoZGF0YSwgaW5wdXRFbmNvZGluZyA9ICd1dGY4Jywgb3V0cHV0RW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIGRhdGEgPSBCdWZmZXIuZnJvbShkYXRhLCBpbnB1dEVuY29kaW5nKQoKICAgIGNvbnN0IG91dCA9IG5ldyBBcnJheUJ1ZmZlcihiaW5kaW5nLmNpcGhlckJsb2NrU2l6ZSh0aGlzLl9oYW5kbGUpKQoKICAgIGNvbnN0IHdyaXR0ZW4gPSBiaW5kaW5nLmNpcGhlclVwZGF0ZSgKICAgICAgdGhpcy5faGFuZGxlLAogICAgICBkYXRhLmJ1ZmZlciwKICAgICAgZGF0YS5ieXRlT2Zmc2V0LAogICAgICBkYXRhLmJ5dGVMZW5ndGgsCiAgICAgIG91dAogICAgKQoKICAgIGNvbnN0IHJlc3VsdCA9IEJ1ZmZlci5mcm9tKG91dCwgMCwgd3JpdHRlbikKCiAgICByZXR1cm4gb3V0cHV0RW5jb2RpbmcgPyByZXN1bHQudG9TdHJpbmcob3V0cHV0RW5jb2RpbmcpIDogcmVzdWx0CiAgfQoKICBmaW5hbChvdXRwdXRFbmNvZGluZykgewogICAgY29uc3Qgb3V0ID0gbmV3IEFycmF5QnVmZmVyKGJpbmRpbmcuY2lwaGVyQmxvY2tTaXplKHRoaXMuX2hhbmRsZSkpCgogICAgY29uc3Qgd3JpdHRlbiA9IGJpbmRpbmcuY2lwaGVyRmluYWwodGhpcy5faGFuZGxlLCBvdXQpCgogICAgY29uc3QgcmVzdWx0ID0gQnVmZmVyLmZyb20ob3V0LCAwLCB3cml0dGVuKQoKICAgIHJldHVybiBvdXRwdXRFbmNvZGluZyA/IHJlc3VsdC50b1N0cmluZyhvdXRwdXRFbmNvZGluZykgOiByZXN1bHQKICB9CgogIHNldEF1dG9QYWRkaW5nKHBhZCkgewogICAgYmluZGluZy5jaXBoZXJTZXRQYWRkaW5nKHBhZCkKICB9Cn0KCmNsYXNzIENyeXB0b0F1dGhlbnRpY2F0ZWRDaXBoZXIgewogIGNvbnN0cnVjdG9yKGFsZ29yaXRobSwga2V5LCBub25jZSwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IGVuY29kaW5nID0gJ3V0ZjgnLCBhdXRoVGFnTGVuZ3RoID0gMTYgfSA9IG9wdHMKCiAgICBpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycpIGtleSA9IEJ1ZmZlci5mcm9tKGtleSwgZW5jb2RpbmcpCiAgICBpZiAodHlwZW9mIG5vbmNlID09PSAnc3RyaW5nJykgbm9uY2UgPSBCdWZmZXIuZnJvbShub25jZSwgZW5jb2RpbmcpCgogICAgaWYgKGtleS5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmFlYWRLZXlMZW5ndGgoYWxnb3JpdGhtKSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW52YWxpZCBrZXkgbGVuZ3RoJykKICAgIH0KCiAgICBpZiAobm9uY2UuYnl0ZUxlbmd0aCA8IGJpbmRpbmcuYWVhZE5vbmNlTGVuZ3RoKGFsZ29yaXRobSkpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0ludmFsaWQgbm9uY2UgbGVuZ3RoJykKICAgIH0KCiAgICB0aGlzLl9idWZmZXIgPSBbXQogICAgdGhpcy5fbm9uY2UgPSBub25jZQogICAgdGhpcy5fYXV0aFRhZyA9IG51bGwKICAgIHRoaXMuX2F1dGhUYWdMZW5ndGggPSBhdXRoVGFnTGVuZ3RoCiAgICB0aGlzLl9hZGRpdGlvbmFsRGF0YSA9IG51bGwKCiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLmFlYWRJbml0KAogICAgICBhbGdvcml0aG0sCiAgICAgIGtleS5idWZmZXIsCiAgICAgIGtleS5ieXRlT2Zmc2V0LAogICAgICBrZXkuYnl0ZUxlbmd0aCwKICAgICAgYXV0aFRhZ0xlbmd0aAogICAgKQogIH0KCiAgdXBkYXRlKGRhdGEsIGlucHV0RW5jb2RpbmcgPSAndXRmOCcsIG91dHB1dEVuY29kaW5nKSB7CiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSBkYXRhID0gQnVmZmVyLmZyb20oZGF0YSwgaW5wdXRFbmNvZGluZykKCiAgICB0aGlzLl9idWZmZXIucHVzaChkYXRhKQoKICAgIHJldHVybiBvdXRwdXRFbmNvZGluZyA/ICcnIDogQnVmZmVyLmFsbG9jKDApCiAgfQoKICBzZXRBQUQoYnVmZmVyLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgZW5jb2RpbmcgPSAndXRmOCcgfSA9IG9wdHMKCiAgICBpZiAodHlwZW9mIGJ1ZmZlciA9PT0gJ3N0cmluZycpIGJ1ZmZlciA9IEJ1ZmZlci5mcm9tKGJ1ZmZlciwgZW5jb2RpbmcpCgogICAgdGhpcy5fYWRkaXRpb25hbERhdGEgPSBidWZmZXIKICB9CgogIGdldEF1dGhUYWcoKSB7CiAgICByZXR1cm4gdGhpcy5fYXV0aFRhZwogIH0KCiAgc2V0QXV0aFRhZyhhdXRoVGFnLCBlbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBhdXRoVGFnID09PSAnc3RyaW5nJykgYXV0aFRhZyA9IEJ1ZmZlci5mcm9tKGF1dGhUYWcsIGVuY29kaW5nKQoKICAgIHRoaXMuX2F1dGhUYWcgPSBhdXRoVGFnCiAgfQp9CgpjbGFzcyBDcnlwdG9BdXRoZW50aWNhdGVkU2VhbCBleHRlbmRzIENyeXB0b0F1dGhlbnRpY2F0ZWRDaXBoZXIgewogIGZpbmFsKG91dHB1dEVuY29kaW5nKSB7CiAgICBjb25zdCBkYXRhID0gdGhpcy5fYnVmZmVyLmxlbmd0aCA9PT0gMSA/IHRoaXMuX2J1ZmZlclswXSA6IEJ1ZmZlci5jb25jYXQodGhpcy5fYnVmZmVyKQoKICAgIGNvbnN0IG5vbmNlID0gdGhpcy5fbm9uY2UKICAgIGNvbnN0IGFkID0gdGhpcy5fYWRkaXRpb25hbERhdGEgfHwgQnVmZmVyLmFsbG9jKDApCgogICAgY29uc3Qgb3V0ID0gbmV3IEFycmF5QnVmZmVyKGRhdGEuYnl0ZUxlbmd0aCArIGJpbmRpbmcuYWVhZE1heE92ZXJoZWFkKHRoaXMuX2hhbmRsZSkpCgogICAgYmluZGluZy5hZWFkU2VhbCgKICAgICAgdGhpcy5faGFuZGxlLAogICAgICBkYXRhLmJ1ZmZlciwKICAgICAgZGF0YS5ieXRlT2Zmc2V0LAogICAgICBkYXRhLmJ5dGVMZW5ndGgsCiAgICAgIG5vbmNlLmJ1ZmZlciwKICAgICAgbm9uY2UuYnl0ZU9mZnNldCwKICAgICAgbm9uY2UuYnl0ZUxlbmd0aCwKICAgICAgYWQuYnVmZmVyLAogICAgICBhZC5ieXRlT2Zmc2V0LAogICAgICBhZC5ieXRlTGVuZ3RoLAogICAgICBvdXQKICAgICkKCiAgICBjb25zdCB3cml0dGVuID0gb3V0LmJ5dGVMZW5ndGggLSB0aGlzLl9hdXRoVGFnTGVuZ3RoCgogICAgdGhpcy5fYXV0aFRhZyA9IEJ1ZmZlci5mcm9tKG91dCwgd3JpdHRlbikKCiAgICBjb25zdCByZXN1bHQgPSBCdWZmZXIuZnJvbShvdXQsIDAsIHdyaXR0ZW4pCgogICAgcmV0dXJuIG91dHB1dEVuY29kaW5nID8gcmVzdWx0LnRvU3RyaW5nKG91dHB1dEVuY29kaW5nKSA6IHJlc3VsdAogIH0KfQoKY2xhc3MgQ3J5cHRvQXV0aGVudGljYXRlZE9wZW4gZXh0ZW5kcyBDcnlwdG9BdXRoZW50aWNhdGVkQ2lwaGVyIHsKICBmaW5hbChvdXRwdXRFbmNvZGluZykgewogICAgdGhpcy5fYnVmZmVyLnB1c2godGhpcy5fYXV0aFRhZykKCiAgICBjb25zdCBkYXRhID0gQnVmZmVyLmNvbmNhdCh0aGlzLl9idWZmZXIpCgogICAgY29uc3Qgbm9uY2UgPSB0aGlzLl9ub25jZQogICAgY29uc3QgYWQgPSB0aGlzLl9hZGRpdGlvbmFsRGF0YSB8fCBCdWZmZXIuYWxsb2MoMCkKCiAgICBjb25zdCBvdXQgPSBuZXcgQXJyYXlCdWZmZXIoZGF0YS5ieXRlTGVuZ3RoKQoKICAgIGJpbmRpbmcuYWVhZE9wZW4oCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgZGF0YS5idWZmZXIsCiAgICAgIGRhdGEuYnl0ZU9mZnNldCwKICAgICAgZGF0YS5ieXRlTGVuZ3RoLAogICAgICBub25jZS5idWZmZXIsCiAgICAgIG5vbmNlLmJ5dGVPZmZzZXQsCiAgICAgIG5vbmNlLmJ5dGVMZW5ndGgsCiAgICAgIGFkLmJ1ZmZlciwKICAgICAgYWQuYnl0ZU9mZnNldCwKICAgICAgYWQuYnl0ZUxlbmd0aCwKICAgICAgb3V0CiAgICApCgogICAgY29uc3Qgd3JpdHRlbiA9IG91dC5ieXRlTGVuZ3RoIC0gdGhpcy5fYXV0aFRhZ0xlbmd0aAoKICAgIGNvbnN0IHJlc3VsdCA9IEJ1ZmZlci5mcm9tKG91dCwgMCwgd3JpdHRlbikKCiAgICByZXR1cm4gb3V0cHV0RW5jb2RpbmcgPyByZXN1bHQudG9TdHJpbmcob3V0cHV0RW5jb2RpbmcpIDogcmVzdWx0CiAgfQp9CgpleHBvcnRzLkNpcGhlcml2ID0gY2xhc3MgQ3J5cHRvQ2lwaGVyaXYgZXh0ZW5kcyBUcmFuc2Zvcm0gewogIGNvbnN0cnVjdG9yKGFsZ29yaXRobSwga2V5LCBpdiwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcihvcHRzKQoKICAgIGFsZ29yaXRobSA9IGNvbnN0YW50cy50b0NpcGhlcihhbGdvcml0aG0pCgogICAgc3dpdGNoIChhbGdvcml0aG0pIHsKICAgICAgY2FzZSBBRVMxMjhFQ0I6CiAgICAgIGNhc2UgQUVTMTI4Q0JDOgogICAgICBjYXNlIEFFUzEyOENUUjoKICAgICAgY2FzZSBBRVMxMjhPRkI6CiAgICAgIGNhc2UgQUVTMjU2RUNCOgogICAgICBjYXNlIEFFUzI1NkNCQzoKICAgICAgY2FzZSBBRVMyNTZDVFI6CiAgICAgIGNhc2UgQUVTMjU2T0ZCOgogICAgICAgIHRoaXMuX2NpcGhlciA9IG5ldyBDcnlwdG9DaXBoZXIoYWxnb3JpdGhtLCBrZXksIGl2LCB0cnVlLCBvcHRzKQogICAgICAgIGJyZWFrCgogICAgICBjYXNlIEFFUzEyOEdDTToKICAgICAgY2FzZSBBRVMyNTZHQ006CiAgICAgIGNhc2UgQ0hBQ0hBMjBQT0xZMTMwNToKICAgICAgY2FzZSBYQ0hBQ0hBMjBQT0xZMTMwNToKICAgICAgICB0aGlzLl9jaXBoZXIgPSBuZXcgQ3J5cHRvQXV0aGVudGljYXRlZFNlYWwoYWxnb3JpdGhtLCBrZXksIGl2LCBvcHRzKQogICAgICAgIGJyZWFrCiAgICB9CiAgfQoKICB1cGRhdGUoZGF0YSwgaW5wdXRFbmNvZGluZywgb3V0cHV0RW5jb2RpbmcpIHsKICAgIHJldHVybiB0aGlzLl9jaXBoZXIudXBkYXRlKGRhdGEsIGlucHV0RW5jb2RpbmcsIG91dHB1dEVuY29kaW5nKQogIH0KCiAgZmluYWwob3V0cHV0RW5jb2RpbmcpIHsKICAgIHJldHVybiB0aGlzLl9jaXBoZXIuZmluYWwob3V0cHV0RW5jb2RpbmcpCiAgfQoKICBzZXRBdXRvUGFkZGluZyhwYWQpIHsKICAgIHRoaXMuX2NpcGhlci5zZXRBdXRvUGFkZGluZyhwYWQpCgogICAgcmV0dXJuIHRoaXMKICB9CgogIHNldEFBRChidWZmZXIsIG9wdHMpIHsKICAgIHRoaXMuX2NpcGhlci5zZXRBQUQoYnVmZmVyLCBvcHRzKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBnZXRBdXRoVGFnKCkgewogICAgcmV0dXJuIHRoaXMuX2NpcGhlci5nZXRBdXRoVGFnKCkKICB9CgogIF90cmFuc2Zvcm0oZGF0YSwgZW5jb2RpbmcsIGNiKSB7CiAgICB0aGlzLnVwZGF0ZShkYXRhKQoKICAgIGNiKG51bGwpCiAgfQoKICBfZmx1c2goY2IpIHsKICAgIHRoaXMucHVzaCh0aGlzLmRpZ2VzdCgpKQoKICAgIGNiKG51bGwpCiAgfQp9CgpleHBvcnRzLkRlY2lwaGVyaXYgPSBjbGFzcyBDcnlwdG9EZWlwaGVyaXYgZXh0ZW5kcyBUcmFuc2Zvcm0gewogIGNvbnN0cnVjdG9yKGFsZ29yaXRobSwga2V5LCBpdiwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcihvcHRzKQoKICAgIGFsZ29yaXRobSA9IGNvbnN0YW50cy50b0NpcGhlcihhbGdvcml0aG0pCgogICAgc3dpdGNoIChhbGdvcml0aG0pIHsKICAgICAgY2FzZSBBRVMxMjhFQ0I6CiAgICAgIGNhc2UgQUVTMTI4Q0JDOgogICAgICBjYXNlIEFFUzEyOENUUjoKICAgICAgY2FzZSBBRVMxMjhPRkI6CiAgICAgIGNhc2UgQUVTMjU2RUNCOgogICAgICBjYXNlIEFFUzI1NkNCQzoKICAgICAgY2FzZSBBRVMyNTZDVFI6CiAgICAgIGNhc2UgQUVTMjU2T0ZCOgogICAgICAgIHRoaXMuX2NpcGhlciA9IG5ldyBDcnlwdG9DaXBoZXIoYWxnb3JpdGhtLCBrZXksIGl2LCBmYWxzZSwgb3B0cykKICAgICAgICBicmVhawoKICAgICAgY2FzZSBBRVMxMjhHQ006CiAgICAgIGNhc2UgQUVTMjU2R0NNOgogICAgICBjYXNlIENIQUNIQTIwUE9MWTEzMDU6CiAgICAgIGNhc2UgWENIQUNIQTIwUE9MWTEzMDU6CiAgICAgICAgdGhpcy5fY2lwaGVyID0gbmV3IENyeXB0b0F1dGhlbnRpY2F0ZWRPcGVuKGFsZ29yaXRobSwga2V5LCBpdiwgb3B0cykKICAgICAgICBicmVhawogICAgfQogIH0KCiAgdXBkYXRlKGRhdGEsIGlucHV0RW5jb2RpbmcsIG91dHB1dEVuY29kaW5nKSB7CiAgICByZXR1cm4gdGhpcy5fY2lwaGVyLnVwZGF0ZShkYXRhLCBpbnB1dEVuY29kaW5nLCBvdXRwdXRFbmNvZGluZykKICB9CgogIGZpbmFsKG91dHB1dEVuY29kaW5nKSB7CiAgICByZXR1cm4gdGhpcy5fY2lwaGVyLmZpbmFsKG91dHB1dEVuY29kaW5nKQogIH0KCiAgc2V0QXV0b1BhZGRpbmcocGFkKSB7CiAgICB0aGlzLl9jaXBoZXIuc2V0QXV0b1BhZGRpbmcocGFkKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBzZXRBQUQoYnVmZmVyLCBvcHRzKSB7CiAgICB0aGlzLl9jaXBoZXIuc2V0QUFEKGJ1ZmZlciwgb3B0cykKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgc2V0QXV0aFRhZyhhdXRoVGFnLCBlbmNvZGluZykgewogICAgdGhpcy5fY2lwaGVyLnNldEF1dGhUYWcoYXV0aFRhZywgZW5jb2RpbmcpCgogICAgcmV0dXJuIHRoaXMKICB9CgogIF90cmFuc2Zvcm0oZGF0YSwgZW5jb2RpbmcsIGNiKSB7CiAgICB0aGlzLnVwZGF0ZShkYXRhKQoKICAgIGNiKG51bGwpCiAgfQoKICBfZmx1c2goY2IpIHsKICAgIHRoaXMucHVzaCh0aGlzLmRpZ2VzdCgpKQoKICAgIGNiKG51bGwpCiAgfQp9CmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi9lcnJvcnMnKQoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gewogIGhhc2g6IHsKICAgIE1ENTogYmluZGluZy5NRDUsCiAgICBTSEExOiBiaW5kaW5nLlNIQTEsCiAgICBTSEEyNTY6IGJpbmRpbmcuU0hBMjU2LAogICAgU0hBNTEyOiBiaW5kaW5nLlNIQTUxMiwKICAgIEJMQUtFMkIyNTY6IGJpbmRpbmcuQkxBS0UyQjI1NgogIH0sCiAgc2lnbmF0dXJlOiB7CiAgICBFRDI1NTE5OiBiaW5kaW5nLkVEMjU1MTkKICB9LAogIGNpcGhlcjogewogICAgQUVTMTI4RUNCOiBiaW5kaW5nLkFFUzEyOEVDQiwKICAgIEFFUzEyOENCQzogYmluZGluZy5BRVMxMjhDQkMsCiAgICBBRVMxMjhDVFI6IGJpbmRpbmcuQUVTMTI4Q1RSLAogICAgQUVTMTI4T0ZCOiBiaW5kaW5nLkFFUzEyOE9GQiwKICAgIEFFUzI1NkVDQjogYmluZGluZy5BRVMyNTZFQ0IsCiAgICBBRVMyNTZDQkM6IGJpbmRpbmcuQUVTMjU2Q0JDLAogICAgQUVTMjU2Q1RSOiBiaW5kaW5nLkFFUzI1NkNUUiwKICAgIEFFUzI1Nk9GQjogYmluZGluZy5BRVMyNTZPRkIsCiAgICBBRVMxMjhHQ006IGJpbmRpbmcuQUVTMTI4R0NNLAogICAgQUVTMjU2R0NNOiBiaW5kaW5nLkFFUzI1NkdDTSwKICAgIENIQUNIQTIwUE9MWTEzMDU6IGJpbmRpbmcuQ0hBQ0hBMjBQT0xZMTMwNSwKICAgIFhDSEFDSEEyMFBPTFkxMzA1OiBiaW5kaW5nLlhDSEFDSEEyMFBPTFkxMzA1CiAgfSwKICBrZXlUeXBlOiB7CiAgICBFRDI1NTE5OiBiaW5kaW5nLkVEMjU1MTkKICB9Cn0KCmV4cG9ydHMudG9IYXNoID0gZnVuY3Rpb24gdG9IYXNoKGhhc2gpIHsKICBpZiAodHlwZW9mIGhhc2ggPT09ICdudW1iZXInKSByZXR1cm4gaGFzaAoKICBpZiAodHlwZW9mIGhhc2ggPT09ICdzdHJpbmcnKSB7CiAgICBoYXNoID0gaGFzaC5yZXBsYWNlKC8tL2csICcnKQoKICAgIGlmIChoYXNoIGluIGV4cG9ydHMuaGFzaCA9PT0gZmFsc2UpIHsKICAgICAgaGFzaCA9IGhhc2gudG9VcHBlckNhc2UoKQoKICAgICAgaWYgKGhhc2ggaW4gZXhwb3J0cy5oYXNoID09PSBmYWxzZSkgewogICAgICAgIHRocm93IGVycm9ycy5VTktOT1dOX0hBU0goYFVua25vd24gaGFzaCAnJHtoYXNofSdgKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGV4cG9ydHMuaGFzaFtoYXNoXQogIH0KCiAgdGhyb3cgbmV3IFR5cGVFcnJvcihgSGFzaCBtdXN0IGJlIGEgbnVtYmVyIG9yIHN0cmluZy4gUmVjZWl2ZWQgJHt0eXBlb2YgaGFzaH0gKCR7aGFzaH0pYCkKfQoKZXhwb3J0cy50b0NpcGhlciA9IGZ1bmN0aW9uIHRvQ2lwZXIoY2lwaGVyKSB7CiAgaWYgKHR5cGVvZiBjaXBoZXIgPT09ICdudW1iZXInKSByZXR1cm4gY2lwaGVyCgogIGlmICh0eXBlb2YgY2lwaGVyID09PSAnc3RyaW5nJykgewogICAgY2lwaGVyID0gY2lwaGVyLnJlcGxhY2UoLy0vZywgJycpCgogICAgaWYgKGNpcGhlciBpbiBleHBvcnRzLmNpcGhlciA9PT0gZmFsc2UpIHsKICAgICAgY2lwaGVyID0gY2lwaGVyLnRvVXBwZXJDYXNlKCkKCiAgICAgIGlmIChjaXBoZXIgaW4gZXhwb3J0cy5jaXBoZXIgPT09IGZhbHNlKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLlVOS05PV05fQ0lQSEVSKGBVbmtub3duIGNpcGhlciAnJHtjaXBoZXJ9J2ApCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZXhwb3J0cy5jaXBoZXJbY2lwaGVyXQogIH0KCiAgdGhyb3cgbmV3IFR5cGVFcnJvcihgQ2lwaGVyIG11c3QgYmUgYSBudW1iZXIgb3Igc3RyaW5nLiBSZWNlaXZlZCAke3R5cGVvZiBjaXBoZXJ9ICgke2NpcGhlcn0pYCkKfQoKZXhwb3J0cy50b0tleVR5cGUgPSBmdW5jdGlvbiB0b0tleVR5cGUodHlwZSkgewogIGlmICh0eXBlb2YgdHlwZSA9PT0gJ251bWJlcicpIHJldHVybiB0eXBlCgogIGlmICh0eXBlb2YgdHlwZSA9PT0gJ3N0cmluZycpIHsKICAgIHR5cGUgPSB0eXBlLnJlcGxhY2UoLy0vZywgJycpCgogICAgaWYgKHR5cGUgaW4gZXhwb3J0cy5rZXlUeXBlID09PSBmYWxzZSkgewogICAgICB0eXBlID0gdHlwZS50b1VwcGVyQ2FzZSgpCgogICAgICBpZiAodHlwZSBpbiBleHBvcnRzLmtleVR5cGUgPT09IGZhbHNlKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLlVOS05PV05fS0VZX1RZUEUoYFVua25vd24ga2V5IHR5cGUgJyR7dHlwZX0nYCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBleHBvcnRzLmtleVR5cGVbdHlwZV0KICB9CgogIHRocm93IG5ldyBUeXBlRXJyb3IoYEtleSB0eXBlIG11c3QgYmUgYSBudW1iZXIgb3Igc3RyaW5nLiBSZWNlaXZlZCAke3R5cGVvZiB0eXBlfSAoJHt0eXBlfSlgKQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ3J5cHRvRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobXNnLCBmbiA9IENyeXB0b0Vycm9yLCBjb2RlID0gZm4ubmFtZSkgewogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWApCiAgICB0aGlzLmNvZGUgPSBjb2RlCgogICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIGZuKQogICAgfQogIH0KCiAgZ2V0IG5hbWUoKSB7CiAgICByZXR1cm4gJ0NyeXB0b0Vycm9yJwogIH0KCiAgc3RhdGljIFVOS05PV05fSEFTSChtc2cpIHsKICAgIHJldHVybiBuZXcgQ3J5cHRvRXJyb3IobXNnLCBDcnlwdG9FcnJvci5VTktOT1dOX0hBU0gpCiAgfQoKICBzdGF0aWMgVU5LTk9XTl9DSVBIRVIobXNnKSB7CiAgICByZXR1cm4gbmV3IENyeXB0b0Vycm9yKG1zZywgQ3J5cHRvRXJyb3IuVU5LTk9XTl9DSVBIRVIpCiAgfQoKICBzdGF0aWMgVU5LTk9XTl9LRVlfVFlQRShtc2cpIHsKICAgIHJldHVybiBuZXcgQ3J5cHRvRXJyb3IobXNnLCBDcnlwdG9FcnJvci5VTktOT1dOX0tFWV9UWVBFKQogIH0KCiAgc3RhdGljIElOVkFMSURfQUNDRVNTKG1zZykgewogICAgcmV0dXJuIG5ldyBDcnlwdG9FcnJvcihtc2csIENyeXB0b0Vycm9yLklOVkFMSURfQUNDRVNTKQogIH0KCiAgc3RhdGljIElOVkFMSURfREFUQShtc2cpIHsKICAgIHJldHVybiBuZXcgQ3J5cHRvRXJyb3IobXNnLCBDcnlwdG9FcnJvci5JTlZBTElEX0RBVEEpCiAgfQoKICBzdGF0aWMgT1BFUkFUSU9OX0VSUk9SKG1zZykgewogICAgcmV0dXJuIG5ldyBDcnlwdG9FcnJvcihtc2csIENyeXB0b0Vycm9yLk9QRVJBVElPTl9FUlJPUikKICB9CgogIHN0YXRpYyBOT1RfU1VQUE9SVEVEKG1zZykgewogICAgcmV0dXJuIG5ldyBDcnlwdG9FcnJvcihtc2csIENyeXB0b0Vycm9yLk5PVF9TVVBQT1JURUQpCiAgfQp9CmNvbnN0IHsgVHJhbnNmb3JtIH0gPSByZXF1aXJlKCdiYXJlLXN0cmVhbScpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBDcnlwdG9IYXNoIGV4dGVuZHMgVHJhbnNmb3JtIHsKICBjb25zdHJ1Y3RvcihhbGdvcml0aG0sIG9wdHMgPSB7fSkgewogICAgc3VwZXIob3B0cykKCiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLmhhc2hJbml0KGNvbnN0YW50cy50b0hhc2goYWxnb3JpdGhtKSkKICB9CgogIHVwZGF0ZShkYXRhLCBlbmNvZGluZyA9ICd1dGY4JykgewogICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEsIGVuY29kaW5nKQoKICAgIGJpbmRpbmcuaGFzaFVwZGF0ZSh0aGlzLl9oYW5kbGUsIGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQsIGRhdGEuYnl0ZUxlbmd0aCkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgZGlnZXN0KGVuY29kaW5nKSB7CiAgICBjb25zdCBkaWdlc3QgPSBCdWZmZXIuZnJvbShiaW5kaW5nLmhhc2hGaW5hbCh0aGlzLl9oYW5kbGUpKQoKICAgIHJldHVybiBlbmNvZGluZyAmJiBlbmNvZGluZyAhPT0gJ2J1ZmZlcicgPyBkaWdlc3QudG9TdHJpbmcoZW5jb2RpbmcpIDogZGlnZXN0CiAgfQoKICBfdHJhbnNmb3JtKGRhdGEsIGVuY29kaW5nLCBjYikgewogICAgdGhpcy51cGRhdGUoZGF0YSkKCiAgICBjYihudWxsKQogIH0KCiAgX2ZsdXNoKGNiKSB7CiAgICB0aGlzLnB1c2godGhpcy5kaWdlc3QoKSkKCiAgICBjYihudWxsKQogIH0KfQpjb25zdCB7IFRyYW5zZm9ybSB9ID0gcmVxdWlyZSgnYmFyZS1zdHJlYW0nKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ3J5cHRvSG1hYyBleHRlbmRzIFRyYW5zZm9ybSB7CiAgY29uc3RydWN0b3IoYWxnb3JpdGhtLCBrZXksIG9wdHMgPSB7fSkgewogICAgc3VwZXIob3B0cykKCiAgICBjb25zdCB7IGVuY29kaW5nID0gJ3V0ZjgnIH0gPSBvcHRzCgogICAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnKSBrZXkgPSBCdWZmZXIuZnJvbShrZXksIGVuY29kaW5nKQoKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcuaG1hY0luaXQoCiAgICAgIGNvbnN0YW50cy50b0hhc2goYWxnb3JpdGhtKSwKICAgICAga2V5LmJ1ZmZlciwKICAgICAga2V5LmJ5dGVPZmZzZXQsCiAgICAgIGtleS5ieXRlTGVuZ3RoCiAgICApCiAgfQoKICB1cGRhdGUoZGF0YSwgZW5jb2RpbmcgPSAndXRmOCcpIHsKICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIGRhdGEgPSBCdWZmZXIuZnJvbShkYXRhLCBlbmNvZGluZykKCiAgICBiaW5kaW5nLmhtYWNVcGRhdGUodGhpcy5faGFuZGxlLCBkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0LCBkYXRhLmJ5dGVMZW5ndGgpCgogICAgcmV0dXJuIHRoaXMKICB9CgogIGRpZ2VzdChlbmNvZGluZykgewogICAgY29uc3QgZGlnZXN0ID0gQnVmZmVyLmZyb20oYmluZGluZy5obWFjRmluYWwodGhpcy5faGFuZGxlKSkKCiAgICByZXR1cm4gZW5jb2RpbmcgJiYgZW5jb2RpbmcgIT09ICdidWZmZXInID8gZGlnZXN0LnRvU3RyaW5nKGVuY29kaW5nKSA6IGRpZ2VzdAogIH0KCiAgX3RyYW5zZm9ybShkYXRhLCBlbmNvZGluZywgY2IpIHsKICAgIHRoaXMudXBkYXRlKGRhdGEpCgogICAgY2IobnVsbCkKICB9CgogIF9mbHVzaChjYikgewogICAgdGhpcy5wdXNoKHRoaXMuZGlnZXN0KCkpCgogICAgY2IobnVsbCkKICB9Cn0KY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQpjb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgpjb25zdCB7CiAga2V5VHlwZTogeyBFRDI1NTE5IH0KfSA9IGNvbnN0YW50cwoKY2xhc3MgQ3J5cHRvS2V5IHsKICBjb25zdHJ1Y3RvcihrZXlUeXBlKSB7CiAgICB0aGlzLl9rZXlUeXBlID0ga2V5VHlwZQogIH0KfQoKZXhwb3J0cy5LZXkgPSBDcnlwdG9LZXkKCmNsYXNzIENyeXB0b0VkMjU1MTlLZXkgZXh0ZW5kcyBDcnlwdG9LZXkgewogIGNvbnN0cnVjdG9yKGtleSkgewogICAgc3VwZXIoRUQyNTUxOSkKCiAgICB0aGlzLl9rZXkgPSBrZXkKICB9CgogIGdldCBhc3ltbWV0cmljS2V5VHlwZSgpIHsKICAgIHJldHVybiAnZWQyNTUxOScKICB9Cn0KCmNsYXNzIENyeXB0b0VkMjU1MTlQdWJsaWNLZXkgZXh0ZW5kcyBDcnlwdG9FZDI1NTE5S2V5IHsKICBnZXQgdHlwZSgpIHsKICAgIHJldHVybiAncHVibGljJwogIH0KfQoKZXhwb3J0cy5FZDI1NTE5UHVibGljS2V5ID0gQ3J5cHRvRWQyNTUxOVB1YmxpY0tleQoKY2xhc3MgQ3J5cHRvRWQyNTUxOVByaXZhdGVLZXkgZXh0ZW5kcyBDcnlwdG9FZDI1NTE5S2V5IHsKICBnZXQgdHlwZSgpIHsKICAgIHJldHVybiAncHJpdmF0ZScKICB9Cn0KCmV4cG9ydHMuRWQyNTUxOVByaXZhdGVLZXkgPSBDcnlwdG9FZDI1NTE5UHJpdmF0ZUtleQoKZXhwb3J0cy5nZW5lcmF0ZUtleVBhaXIgPSBmdW5jdGlvbiBnZW5lcmF0ZUtleVBhaXIodHlwZSwgb3B0cyA9IHt9KSB7CiAgdHlwZSA9IGNvbnN0YW50cy50b0tleVR5cGUodHlwZSkKCiAgc3dpdGNoICh0eXBlKSB7CiAgICBjYXNlIEVEMjU1MTk6IHsKICAgICAgY29uc3QgeyBwdWJsaWNLZXksIHByaXZhdGVLZXkgfSA9IGJpbmRpbmcuZWQyNTUxOUdlbmVyYXRlS2V5cGFpcigpCgogICAgICByZXR1cm4gewogICAgICAgIHB1YmxpY0tleTogbmV3IENyeXB0b0VkMjU1MTlQdWJsaWNLZXkocHVibGljS2V5KSwKICAgICAgICBwcml2YXRlS2V5OiBuZXcgQ3J5cHRvRWQyNTUxOVByaXZhdGVLZXkocHJpdmF0ZUtleSkKICAgICAgfQogICAgfQogIH0KfQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gcGJrZGYyKHBhc3N3b3JkLCBzYWx0LCBpdGVyYXRpb25zLCBrZXlsZW4sIGRpZ2VzdCwgY2IpIHsKICBpZiAoaXRlcmF0aW9ucyA8PSAwKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignaXRlcmF0aW9ucyBpcyBvdXQgb2YgcmFuZ2UnKQogIH0KCiAgaWYgKHR5cGVvZiBwYXNzd29yZCA9PT0gJ3N0cmluZycpIHBhc3N3b3JkID0gQnVmZmVyLmZyb20ocGFzc3dvcmQpCiAgaWYgKHR5cGVvZiBzYWx0ID09PSAnc3RyaW5nJykgc2FsdCA9IEJ1ZmZlci5mcm9tKHNhbHQpCgogIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5mcm9tKAogICAgYmluZGluZy5wYmtkZjIoCiAgICAgIHBhc3N3b3JkLmJ1ZmZlciwKICAgICAgcGFzc3dvcmQuYnl0ZU9mZnNldCwKICAgICAgcGFzc3dvcmQuYnl0ZUxlbmd0aCwKICAgICAgc2FsdC5idWZmZXIsCiAgICAgIHNhbHQuYnl0ZU9mZnNldCwKICAgICAgc2FsdC5ieXRlTGVuZ3RoLAogICAgICBpdGVyYXRpb25zLAogICAgICBjb25zdGFudHMudG9IYXNoKGRpZ2VzdCksCiAgICAgIGtleWxlbgogICAgKQogICkKCiAgaWYgKGNiKSBxdWV1ZU1pY3JvdGFzaygoKSA9PiBjYihudWxsLCBidWZmZXIpKQogIGVsc2UgcmV0dXJuIGJ1ZmZlcgp9CmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKCmV4cG9ydHMucmFuZG9tQnl0ZXMgPSBmdW5jdGlvbiByYW5kb21CeXRlcyhzaXplLCBjYikgewogIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShzaXplKQogIGV4cG9ydHMucmFuZG9tRmlsbChidWZmZXIpCiAgaWYgKGNiKSBxdWV1ZU1pY3JvdGFzaygoKSA9PiBjYihudWxsLCBidWZmZXIpKQogIGVsc2UgcmV0dXJuIGJ1ZmZlcgp9CgpleHBvcnRzLnJhbmRvbUZpbGwgPSBmdW5jdGlvbiByYW5kb21GaWxsKGJ1ZmZlciwgb2Zmc2V0LCBzaXplLCBjYikgewogIGlmICh0eXBlb2Ygb2Zmc2V0ID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9mZnNldAogICAgb2Zmc2V0ID0gdW5kZWZpbmVkCiAgfSBlbHNlIGlmICh0eXBlb2Ygc2l6ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBzaXplCiAgICBzaXplID0gdW5kZWZpbmVkCiAgfQoKICBjb25zdCBlbGVtZW50U2l6ZSA9IGJ1ZmZlci5CWVRFU19QRVJfRUxFTUVOVCB8fCAxCgogIGlmIChvZmZzZXQgPT09IHVuZGVmaW5lZCkgb2Zmc2V0ID0gMAogIGVsc2Ugb2Zmc2V0ICo9IGVsZW1lbnRTaXplCgogIGlmIChzaXplID09PSB1bmRlZmluZWQpIHNpemUgPSBidWZmZXIuYnl0ZUxlbmd0aCAtIG9mZnNldAogIGVsc2Ugc2l6ZSAqPSBlbGVtZW50U2l6ZQoKICBpZiAob2Zmc2V0IDwgMCB8fCBvZmZzZXQgPiBidWZmZXIuYnl0ZUxlbmd0aCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ29mZnNldCBpcyBvdXQgb2YgcmFuZ2UnKQogIH0KCiAgaWYgKHNpemUgPCAwIHx8IHNpemUgPiBidWZmZXIuYnl0ZUxlbmd0aCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ3NpemUgaXMgb3V0IG9mIHJhbmdlJykKICB9CgogIGlmIChvZmZzZXQgKyBzaXplID4gYnVmZmVyLmJ5dGVMZW5ndGgpIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdvZmZzZXQgKyBzaXplIGlzIG91dCBvZiByYW5nZScpCiAgfQoKICBsZXQgYXJyYXlidWZmZXIKCiAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhidWZmZXIpKSB7CiAgICBvZmZzZXQgKz0gYnVmZmVyLmJ5dGVPZmZzZXQKICAgIGFycmF5YnVmZmVyID0gYnVmZmVyLmJ1ZmZlcgogIH0gZWxzZSB7CiAgICBhcnJheWJ1ZmZlciA9IGJ1ZmZlcgogIH0KCiAgYmluZGluZy5yYW5kb21GaWxsKGFycmF5YnVmZmVyLCBvZmZzZXQsIHNpemUpCgogIGlmIChjYikgcXVldWVNaWNyb3Rhc2soKCkgPT4gY2IobnVsbCwgYnVmZmVyKSkKICBlbHNlIHJldHVybiBidWZmZXIKfQoKZXhwb3J0cy5yYW5kb21VVUlEID0gZnVuY3Rpb24gcmFuZG9tVVVJRCgpIHsKICBjb25zdCB1dWlkID0gZXhwb3J0cy5yYW5kb21CeXRlcygxNikKCiAgdXVpZFs2XSA9ICh1dWlkWzZdID4+PiA0KSB8IDBiMDEwMDAwMDAKICB1dWlkWzhdID0gKHV1aWRbOF0gPj4+IDIpIHwgMGIxMDAwMDAwMAoKICByZXR1cm4gKAogICAgdXVpZC5zdWJhcnJheSgwLCA0KS50b1N0cmluZygnaGV4JykgKwogICAgJy0nICsKICAgIHV1aWQuc3ViYXJyYXkoNCwgNikudG9TdHJpbmcoJ2hleCcpICsKICAgICctJyArCiAgICB1dWlkLnN1YmFycmF5KDYsIDgpLnRvU3RyaW5nKCdoZXgnKSArCiAgICAnLScgKwogICAgdXVpZC5zdWJhcnJheSg4LCAxMCkudG9TdHJpbmcoJ2hleCcpICsKICAgICctJyArCiAgICB1dWlkLnN1YmFycmF5KDEwLCAxNikudG9TdHJpbmcoJ2hleCcpCiAgKQp9CmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKY29uc3QgewogIGtleVR5cGU6IHsgRUQyNTUxOSB9Cn0gPSBjb25zdGFudHMKCmV4cG9ydHMuc2lnbiA9IGZ1bmN0aW9uIHNpZ24oYWxnb3JpdGhtLCBkYXRhLCBrZXkpIHsKICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KGRhdGEpKSB7CiAgICBkYXRhID0gQnVmZmVyLmNvZXJjZShkYXRhKQogIH0gZWxzZSB7CiAgICBkYXRhID0gQnVmZmVyLmZyb20oZGF0YSkKICB9CgogIHN3aXRjaCAoa2V5Ll9rZXlUeXBlKSB7CiAgICBjYXNlIEVEMjU1MTk6CiAgICAgIHJldHVybiBCdWZmZXIuZnJvbSgKICAgICAgICBiaW5kaW5nLmVkMjU1MTlTaWduKGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQsIGRhdGEuYnl0ZUxlbmd0aCwga2V5Ll9rZXkpCiAgICAgICkKICB9Cn0KCmV4cG9ydHMudmVyaWZ5ID0gZnVuY3Rpb24gdmVyaWZ5KGFsZ29yaXRobSwgZGF0YSwga2V5LCBzaWduYXR1cmUpIHsKICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KGRhdGEpKSB7CiAgICBkYXRhID0gQnVmZmVyLmNvZXJjZShkYXRhKQogIH0gZWxzZSB7CiAgICBkYXRhID0gQnVmZmVyLmZyb20oZGF0YSkKICB9CgogIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoc2lnbmF0dXJlKSkgewogICAgc2lnbmF0dXJlID0gQnVmZmVyLmNvZXJjZShzaWduYXR1cmUpCiAgfSBlbHNlIHsKICAgIHNpZ25hdHVyZSA9IEJ1ZmZlci5mcm9tKHNpZ25hdHVyZSkKICB9CgogIHN3aXRjaCAoa2V5Ll9rZXlUeXBlKSB7CiAgICBjYXNlIEVEMjU1MTk6CiAgICAgIHJldHVybiBiaW5kaW5nLmVkMjU1MTlWZXJpZnkoCiAgICAgICAgZGF0YS5idWZmZXIsCiAgICAgICAgZGF0YS5ieXRlT2Zmc2V0LAogICAgICAgIGRhdGEuYnl0ZUxlbmd0aCwKICAgICAgICBzaWduYXR1cmUuYnVmZmVyLAogICAgICAgIHNpZ25hdHVyZS5ieXRlT2Zmc2V0LAogICAgICAgIGtleS5fa2V5CiAgICAgICkKICB9Cn0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnLi4vLi4vLi4nKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vLi4vLi4vYmluZGluZycpCmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4uLy4uL2Vycm9ycycpCmNvbnN0IHsgRWQyNTUxOVB1YmxpY0tleSwgRWQyNTUxOVByaXZhdGVLZXkgfSA9IHJlcXVpcmUoJy4uLy4uL2tleScpCmNvbnN0IENyeXB0b0tleSA9IHJlcXVpcmUoJy4uL2NyeXB0by1rZXknKQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jZWQyNTUxOQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jZWQyNTUxOS1vcGVyYXRpb25zLXNpZ24KZXhwb3J0cy5zaWduID0gZnVuY3Rpb24gc2lnbihhbGdvcml0aG0sIGtleSwgZGF0YSkgewogIGlmIChrZXkudHlwZSAhPT0gJ3ByaXZhdGUnKSB7CiAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoJ011c3QgcGFzcyBwcml2YXRlIGtleSBmb3IgRWQyNTUxOSBzaWduaW5nJykKICB9CgogIGNvbnN0IHNpZ25hdHVyZSA9IGNyeXB0by5zaWduKG51bGwsIGRhdGEsIGtleS5faGFuZGxlKQoKICByZXR1cm4gc2lnbmF0dXJlLmJ1ZmZlci5zbGljZSgwLCBzaWduYXR1cmUuYnl0ZUxlbmd0aCkKfQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jZWQyNTUxOS1vcGVyYXRpb25zLXZlcmlmeQpleHBvcnRzLnZlcmlmeSA9IGZ1bmN0aW9uIHZlcmlmeShhbGdvcml0aG0sIGtleSwgc2lnbmF0dXJlLCBkYXRhKSB7CiAgaWYgKGtleS50eXBlICE9PSAncHVibGljJykgewogICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKCdNdXN0IHBhc3MgcHVibGljIGtleSBmb3IgRWQyNTUxOSB2ZXJpZmljYXRpb24nKQogIH0KCiAgcmV0dXJuIGNyeXB0by52ZXJpZnkobnVsbCwgZGF0YSwga2V5Ll9oYW5kbGUsIHNpZ25hdHVyZSkKfQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jZWQyNTUxOS1vcGVyYXRpb25zLWdlbmVyYXRlLWtleQpleHBvcnRzLmdlbmVyYXRlS2V5ID0gZnVuY3Rpb24gZ2VuZXJhdGVLZXkoYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKSB7CiAgZm9yIChjb25zdCB1c2FnZSBvZiB1c2FnZXMpIHsKICAgIGlmICh1c2FnZSAhPT0gJ3NpZ24nICYmIHVzYWdlICE9PSAndmVyaWZ5JykgewogICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoCiAgICAgICAgYFVzYWdlICcke3VzYWdlfScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBFZDI1NTE5IGdlbmVyYXRlS2V5KCkgb3BlcmF0aW9uYAogICAgICApCiAgICB9CiAgfQoKICBjb25zdCBrZXlzID0gY3J5cHRvLmdlbmVyYXRlS2V5UGFpcignZWQyNTUxOScpCgogIGFsZ29yaXRobSA9IHsgbmFtZTogJ0VkMjU1MTknIH0KCiAgcmV0dXJuIHsKICAgIHB1YmxpY0tleTogbmV3IENyeXB0b0tleSgncHVibGljJywgdHJ1ZSwgYWxnb3JpdGhtLCBbJ3ZlcmlmeSddLCBrZXlzLnB1YmxpY0tleSksCiAgICBwcml2YXRlS2V5OiBuZXcgQ3J5cHRvS2V5KCdwcml2YXRlJywgZXh0cmFjdGFibGUsIGFsZ29yaXRobSwgWydzaWduJ10sIGtleXMucHJpdmF0ZUtleSkKICB9Cn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2VkMjU1MTktb3BlcmF0aW9ucy1pbXBvcnQta2V5CmV4cG9ydHMuaW1wb3J0S2V5ID0gZnVuY3Rpb24gaW1wb3J0S2V5KGZvcm1hdCwga2V5RGF0YSwgYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKSB7CiAgc3dpdGNoIChmb3JtYXQpIHsKICAgIGNhc2UgJ3Nwa2knOgogICAgICBmb3IgKGNvbnN0IHVzYWdlIG9mIHVzYWdlcykgewogICAgICAgIGlmICh1c2FnZSAhPT0gJ3ZlcmlmeScpIHsKICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcigKICAgICAgICAgICAgYFVzYWdlICcke3VzYWdlfScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBFZDI1NTE5IGltcG9ydEtleSgpIG9wZXJhdGlvbmAKICAgICAgICAgICkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGtleURhdGEgPSBiaW5kaW5nLmVkMjU1MTlGcm9tU1BLSShrZXlEYXRhLmJ1ZmZlciwga2V5RGF0YS5ieXRlT2Zmc2V0LCBrZXlEYXRhLmJ5dGVMZW5ndGgpCgogICAgICByZXR1cm4gbmV3IENyeXB0b0tleSgKICAgICAgICAncHVibGljJywKICAgICAgICBleHRyYWN0YWJsZSwKICAgICAgICB7CiAgICAgICAgICBuYW1lOiAnRWQyNTUxOScKICAgICAgICB9LAogICAgICAgIHVzYWdlcywKICAgICAgICBuZXcgRWQyNTUxOVB1YmxpY0tleShrZXlEYXRhKQogICAgICApCiAgICBjYXNlICdwa2NzOCc6CiAgICAgIGZvciAoY29uc3QgdXNhZ2Ugb2YgdXNhZ2VzKSB7CiAgICAgICAgaWYgKHVzYWdlICE9PSAnc2lnbicpIHsKICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcigKICAgICAgICAgICAgYFVzYWdlICcke3VzYWdlfScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBFZDI1NTE5IGltcG9ydEtleSgpIG9wZXJhdGlvbmAKICAgICAgICAgICkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGtleURhdGEgPSBiaW5kaW5nLmVkMjU1MTlGcm9tUEtDUzgoa2V5RGF0YS5idWZmZXIsIGtleURhdGEuYnl0ZU9mZnNldCwga2V5RGF0YS5ieXRlTGVuZ3RoKQoKICAgICAgcmV0dXJuIG5ldyBDcnlwdG9LZXkoCiAgICAgICAgJ3ByaXZhdGUnLAogICAgICAgIGV4dHJhY3RhYmxlLAogICAgICAgIHsKICAgICAgICAgIG5hbWU6ICdFZDI1NTE5JwogICAgICAgIH0sCiAgICAgICAgdXNhZ2VzLAogICAgICAgIG5ldyBFZDI1NTE5UHJpdmF0ZUtleShrZXlEYXRhKQogICAgICApCiAgICBjYXNlICdyYXcnOgogICAgICBmb3IgKGNvbnN0IHVzYWdlIG9mIHVzYWdlcykgewogICAgICAgIGlmICh1c2FnZSAhPT0gJ3ZlcmlmeScpIHsKICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcigKICAgICAgICAgICAgYFVzYWdlICcke3VzYWdlfScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBFZDI1NTE5IGltcG9ydEtleSgpIG9wZXJhdGlvbmAKICAgICAgICAgICkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChrZXlEYXRhLmJ5dGVMZW5ndGggKiA4ICE9PSAyNTYpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdLZXkgbXVzdCBiZSAyNTYgYml0cycpCiAgICAgIH0KCiAgICAgIHJldHVybiBuZXcgQ3J5cHRvS2V5KAogICAgICAgICdwdWJsaWMnLAogICAgICAgIGV4dHJhY3RhYmxlLAogICAgICAgIHsKICAgICAgICAgIG5hbWU6ICdFZDI1NTE5JwogICAgICAgIH0sCiAgICAgICAgdXNhZ2VzLAogICAgICAgIG5ldyBFZDI1NTE5UHVibGljS2V5KGtleURhdGEuYnVmZmVyKQogICAgICApCiAgICBjYXNlICdqd2snOgogICAgICBjb25zdCBqd2sgPSBrZXlEYXRhCgogICAgICBpZiAoJ2QnIGluIGp3aykgewogICAgICAgIGlmICh1c2FnZXMuc29tZSgodXNhZ2UpID0+IHVzYWdlICE9PSAnc2lnbicpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoJ0pXSyBtdXN0IGJlIHZhbGlkIGZvciBzaWduaW5nJykKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHVzYWdlcy5zb21lKCh1c2FnZSkgPT4gdXNhZ2UgIT09ICd2ZXJpZnknKSkgewogICAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKCdKV0sgbXVzdCBiZSB2YWxpZCBmb3IgdmVyaWZpY2F0aW9uJykKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChqd2sua3R5ICE9PSAnT0tQJykgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0pXSyBrZXkgbXVzdCBiZSBhbiBvY3RldCBrZXktcGFpcicpCiAgICAgIH0KCiAgICAgIGlmIChqd2suY3J2ICE9PSAnRWQyNTUxOScpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdKV0sgbXVzdCB1c2UgdGhlIEVkMjU1MTkgY3VydmUnKQogICAgICB9CgogICAgICBpZiAoJ2FsZycgaW4gandrICYmIGp3ay5hbGcgIT09ICdFZDI1NTE5JyAmJiBqd2suYWxnICE9PSAnRWREU0EnKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnSldLIG11c3QgdXNlIHRoZSBFZDI1NTE5IGN1cnZlJykKICAgICAgfQoKICAgICAgaWYgKHVzYWdlcy5sZW5ndGggJiYgJ3VzZScgaW4gandrICYmIGp3ay51c2UgIT09ICdzaWcnKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnSldLIGNhbm5vdCBiZSB1c2VkIGZvciBzaWduYXR1cmVzJykKICAgICAgfQoKICAgICAgaWYgKCdleHQnIGluIGp3ayAmJiBqd2suZXh0ICE9PSBleHRyYWN0YWJsZSAmJiBleHRyYWN0YWJsZSkgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0pXSyBpcyBub3QgZXh0cmFjdGFibGUnKQogICAgICB9CgogICAgICBpZiAoJ2QnIGluIGp3aykgewogICAgICAgIGNvbnN0IGtleSA9IEJ1ZmZlci5jb25jYXQoWwogICAgICAgICAgQnVmZmVyLmZyb20oandrLmQsICdiYXNlNjR1cmwnKSwKICAgICAgICAgIEJ1ZmZlci5mcm9tKGp3ay54LCAnYmFzZTY0dXJsJykKICAgICAgICBdKQoKICAgICAgICBpZiAoa2V5LmJ5dGVMZW5ndGggKiA4ICE9PSA1MTIpIHsKICAgICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0tleSBtdXN0IGJlIDUxMiBiaXRzJykKICAgICAgICB9CgogICAgICAgIHJldHVybiBuZXcgQ3J5cHRvS2V5KAogICAgICAgICAgJ3ByaXZhdGUnLAogICAgICAgICAgZXh0cmFjdGFibGUsCiAgICAgICAgICB7CiAgICAgICAgICAgIG5hbWU6ICdFZDI1NTE5JwogICAgICAgICAgfSwKICAgICAgICAgIHVzYWdlcywKICAgICAgICAgIG5ldyBFZDI1NTE5UHJpdmF0ZUtleShrZXkuYnVmZmVyKQogICAgICAgICkKICAgICAgfQoKICAgICAgY29uc3Qga2V5ID0gQnVmZmVyLmZyb20oandrLngsICdiYXNlNjR1cmwnKQoKICAgICAgaWYgKGtleS5ieXRlTGVuZ3RoICogOCAhPT0gMjU2KSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnS2V5IG11c3QgYmUgMjU2IGJpdHMnKQogICAgICB9CgogICAgICByZXR1cm4gbmV3IENyeXB0b0tleSgKICAgICAgICAncHVibGljJywKICAgICAgICBleHRyYWN0YWJsZSwKICAgICAgICB7CiAgICAgICAgICBuYW1lOiAnRWQyNTUxOScKICAgICAgICB9LAogICAgICAgIHVzYWdlcywKICAgICAgICBuZXcgRWQyNTUxOVB1YmxpY0tleShrZXkuYnVmZmVyKQogICAgICApCiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICBgRm9ybWF0ICcke2Zvcm1hdH0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgRWQyNTUxOSBpbXBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICkKICB9Cn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2VkMjU1MTktb3BlcmF0aW9ucy1leHBvcnQta2V5CmV4cG9ydHMuZXhwb3J0S2V5ID0gZnVuY3Rpb24gZXhwb3J0S2V5KGZvcm1hdCwga2V5KSB7CiAgY29uc3QgZGF0YSA9IGtleS5faGFuZGxlCgogIHN3aXRjaCAoZm9ybWF0KSB7CiAgICBjYXNlICdzcGtpJzoKICAgICAgaWYgKGtleS50eXBlICE9PSAncHVibGljJykgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUygKICAgICAgICAgIGBLZXkgb2YgdHlwZSAnJHtrZXkudHlwZX0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgRWQyNTUxOSBleHBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgICB9CgogICAgICByZXR1cm4gYmluZGluZy5lZDI1NTE5VG9TUEtJKGRhdGEuX2tleSkKICAgIGNhc2UgJ3BrY3M4JzoKICAgICAgaWYgKGtleS50eXBlICE9PSAncHJpdmF0ZScpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoCiAgICAgICAgICBgS2V5IG9mIHR5cGUgJyR7a2V5LnR5cGV9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEVkMjU1MTkgZXhwb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgICAgfQoKICAgICAgcmV0dXJuIGJpbmRpbmcuZWQyNTUxOVRvUEtDUzgoZGF0YS5fa2V5KQogICAgY2FzZSAncmF3JzogewogICAgICBpZiAoa2V5LnR5cGUgIT09ICdwdWJsaWMnKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKAogICAgICAgICAgYEtleSBvZiB0eXBlICcke2tleS50eXBlfScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBFZDI1NTE5IGV4cG9ydEtleSgpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICAgIH0KCiAgICAgIHJldHVybiBkYXRhLl9rZXkuc2xpY2UoKQogICAgfQogICAgY2FzZSAnandrJzogewogICAgICBjb25zdCBidWZmZXIgPSBCdWZmZXIuZnJvbShkYXRhLl9rZXkpCgogICAgICBpZiAoa2V5LnR5cGUgPT09ICdwcml2YXRlJykgewogICAgICAgIGNvbnN0IGQgPSBidWZmZXIuc3ViYXJyYXkoMCwgMzIpLnRvU3RyaW5nKCdiYXNlNjR1cmwnKQogICAgICAgIGNvbnN0IHggPSBidWZmZXIuc3ViYXJyYXkoMzIpLnRvU3RyaW5nKCdiYXNlNjR1cmwnKQoKICAgICAgICByZXR1cm4gewogICAgICAgICAga3R5OiAnT0tQJywKICAgICAgICAgIGFsZzogJ0VkMjU1MTknLAogICAgICAgICAgY3J2OiAnRWQyNTUxOScsCiAgICAgICAgICB4LAogICAgICAgICAgZCwKICAgICAgICAgIGtleV9vcHM6IGtleS51c2FnZXMsCiAgICAgICAgICBleHQ6IGtleS5leHRyYWN0YWJsZQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICBrdHk6ICdPS1AnLAogICAgICAgIGFsZzogJ0VkMjU1MTknLAogICAgICAgIGNydjogJ0VkMjU1MTknLAogICAgICAgIHg6IGJ1ZmZlci50b1N0cmluZygnYmFzZTY0dXJsJyksCiAgICAgICAga2V5X29wczoga2V5LnVzYWdlcywKICAgICAgICBleHQ6IGtleS5leHRyYWN0YWJsZQogICAgICB9CiAgICB9CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICBgRm9ybWF0ICcke2Zvcm1hdH0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgSE1BQyBleHBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICkKICB9Cn0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnLi4vLi4vLi4nKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuLi8uLi9lcnJvcnMnKQpjb25zdCBDcnlwdG9LZXkgPSByZXF1aXJlKCcuLi9jcnlwdG8ta2V5JykKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2htYWMKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2htYWMtb3BlcmF0aW9ucy1zaWduCmV4cG9ydHMuc2lnbiA9IGZ1bmN0aW9uIHNpZ24oYWxnb3JpdGhtLCBrZXksIGRhdGEpIHsKICBjb25zdCBkaWdlc3QgPSBjcnlwdG8uY3JlYXRlSG1hYyhrZXkuYWxnb3JpdGhtLmhhc2gubmFtZSwga2V5Ll9oYW5kbGUpLnVwZGF0ZShkYXRhKS5kaWdlc3QoKQoKICByZXR1cm4gZGlnZXN0LmJ1ZmZlci5zbGljZSgwLCBkaWdlc3QuYnl0ZUxlbmd0aCkKfQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jaG1hYy1vcGVyYXRpb25zLXZlcmlmeQpleHBvcnRzLnZlcmlmeSA9IGZ1bmN0aW9uIHZlcmlmeShhbGdvcml0aG0sIGtleSwgc2lnbmF0dXJlLCBkYXRhKSB7CiAgY29uc3QgZGlnZXN0ID0gY3J5cHRvLmNyZWF0ZUhtYWMoa2V5LmFsZ29yaXRobS5oYXNoLm5hbWUsIGtleS5faGFuZGxlKS51cGRhdGUoZGF0YSkuZGlnZXN0KCkKCiAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhzaWduYXR1cmUpKSB7CiAgICBzaWduYXR1cmUgPSBCdWZmZXIuY29lcmNlKHNpZ25hdHVyZSkKICB9IGVsc2UgewogICAgc2lnbmF0dXJlID0gQnVmZmVyLmZyb20oc2lnbmF0dXJlKQogIH0KCiAgcmV0dXJuIHNpZ25hdHVyZS5lcXVhbHMoZGlnZXN0KQp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNobWFjLW9wZXJhdGlvbnMtZ2VuZXJhdGUta2V5CmV4cG9ydHMuZ2VuZXJhdGVLZXkgPSBmdW5jdGlvbiBnZW5lcmF0ZUtleShhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpIHsKICBmb3IgKGNvbnN0IHVzYWdlIG9mIHVzYWdlcykgewogICAgaWYgKHVzYWdlICE9PSAnc2lnbicgJiYgdXNhZ2UgIT09ICd2ZXJpZnknKSB7CiAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihgVXNhZ2UgJyR7dXNhZ2V9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEhNQUMgZ2VuZXJhdGVLZXkoKSBvcGVyYXRpb25gKQogICAgfQogIH0KCiAgY29uc3QgeyBsZW5ndGggPSBleHBvcnRzLmdldEtleUxlbmd0aChhbGdvcml0aG0pIH0gPSBhbGdvcml0aG0ubGVuZ3RoCgogIGxldCBoYXNoID0gYWxnb3JpdGhtLmhhc2gKCiAgaWYgKHR5cGVvZiBoYXNoID09PSAnc3RyaW5nJykgaGFzaCA9IHsgbmFtZTogaGFzaCB9CgogIGNvbnN0IGtleSA9IGNyeXB0by5jcmVhdGVIbWFjKGhhc2gubmFtZSwgY3J5cHRvLnJhbmRvbUJ5dGVzKGxlbmd0aCkpLmRpZ2VzdCgpCgogIHJldHVybiBuZXcgQ3J5cHRvS2V5KAogICAgJ3NlY3JldCcsCiAgICBleHRyYWN0YWJsZSwKICAgIHsKICAgICAgbmFtZTogJ0hNQUMnLAogICAgICBsZW5ndGgsCiAgICAgIGhhc2g6IHsKICAgICAgICBuYW1lOiBoYXNoLm5hbWUudG9VcHBlckNhc2UoKQogICAgICB9CiAgICB9LAogICAgdXNhZ2VzLAogICAga2V5CiAgKQp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNobWFjLW9wZXJhdGlvbnMtaW1wb3J0LWtleQpleHBvcnRzLmltcG9ydEtleSA9IGZ1bmN0aW9uIGltcG9ydEtleShmb3JtYXQsIGtleURhdGEsIGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykgewogIGZvciAoY29uc3QgdXNhZ2Ugb2YgdXNhZ2VzKSB7CiAgICBpZiAodXNhZ2UgIT09ICdzaWduJyAmJiB1c2FnZSAhPT0gJ3ZlcmlmeScpIHsKICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKGBJbnZhbGlkIHVzYWdlICR7dXNhZ2V9YCkKICAgIH0KICB9CgogIGxldCBoYXNoID0gYWxnb3JpdGhtLmhhc2gKCiAgaWYgKHR5cGVvZiBoYXNoID09PSAnc3RyaW5nJykgaGFzaCA9IHsgbmFtZTogaGFzaCB9CgogIGxldCBkYXRhCgogIHN3aXRjaCAoZm9ybWF0KSB7CiAgICBjYXNlICdyYXcnOgogICAgICBkYXRhID0ga2V5RGF0YQogICAgICBicmVhawogICAgY2FzZSAnandrJzoKICAgICAgY29uc3QgandrID0ga2V5RGF0YQoKICAgICAgaWYgKGp3ay5rdHkgIT09ICdvY3QnKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnSldLIGtleSBtdXN0IGJlIGFuIG9jdGV0IHNlcXVlbmNlJykKICAgICAgfQoKICAgICAgZGF0YSA9IEJ1ZmZlci5mcm9tKGp3ay5rLCAnYmFzZTY0dXJsJykKCiAgICAgIHN3aXRjaCAoaGFzaC5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICBjYXNlICdzaGEtMSc6CiAgICAgICAgICBpZiAoandrLmFsZyA9PT0gJ0hTMScpIGJyZWFrCiAgICAgICAgICBlbHNlIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0ludmFsaWQgSldLIGtleSBhbGdvcml0aG0nKQogICAgICAgIGNhc2UgJ3NoYS0yNTYnOgogICAgICAgICAgaWYgKGp3ay5hbGcgPT09ICdIUzI1NicpIGJyZWFrCiAgICAgICAgICBlbHNlIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0ludmFsaWQgSldLIGtleSBhbGdvcml0aG0nKQogICAgICAgIGNhc2UgJ3NoYS0zODQnOgogICAgICAgICAgaWYgKGp3ay5hbGcgPT09ICdIUzM4NCcpIGJyZWFrCiAgICAgICAgICBlbHNlIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0ludmFsaWQgSldLIGtleSBhbGdvcml0aG0nKQogICAgICAgIGNhc2UgJ3NoYS01MTInOgogICAgICAgICAgaWYgKGp3ay5hbGcgPT09ICdIUzUxMicpIGJyZWFrCiAgICAgICAgICBlbHNlIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0ludmFsaWQgSldLIGtleSBhbGdvcml0aG0nKQogICAgICB9CgogICAgICBpZiAodXNhZ2VzLmxlbmd0aCAmJiAndXNlJyBpbiBqd2sgJiYgandrLnVzZSAhPT0gJ3NpZ24nKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnSldLIGNhbm5vdCBiZSB1c2VkIGZvciBzaWduaW5nJykKICAgICAgfQoKICAgICAgaWYgKCdleHQnIGluIGp3ayAmJiBqd2suZXh0ICE9PSBleHRyYWN0YWJsZSAmJiBleHRyYWN0YWJsZSkgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0pXSyBpcyBub3QgZXh0cmFjdGFibGUnKQogICAgICB9CiAgICAgIGJyZWFrCiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICBgRm9ybWF0ICcke2Zvcm1hdH0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgSE1BQyBpbXBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICkKICB9CgogIGNvbnN0IGxlbmd0aCA9IGRhdGEuYnl0ZUxlbmd0aCAqIDgKCiAgaWYgKGxlbmd0aCA9PT0gMCkgewogICAgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnS2V5IGNhbm5vdCBiZSBlbXB0eScpCiAgfQoKICByZXR1cm4gbmV3IENyeXB0b0tleSgKICAgICdzZWNyZXQnLAogICAgZXh0cmFjdGFibGUsCiAgICB7CiAgICAgIG5hbWU6ICdITUFDJywKICAgICAgbGVuZ3RoLAogICAgICBoYXNoOiB7CiAgICAgICAgbmFtZTogaGFzaC5uYW1lLnRvVXBwZXJDYXNlKCkKICAgICAgfQogICAgfSwKICAgIHVzYWdlcywKICAgIGRhdGEKICApCn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2htYWMtb3BlcmF0aW9ucy1leHBvcnQta2V5CmV4cG9ydHMuZXhwb3J0S2V5ID0gZnVuY3Rpb24gZXhwb3J0S2V5KGZvcm1hdCwga2V5KSB7CiAgY29uc3QgZGF0YSA9IGtleS5faGFuZGxlCgogIHN3aXRjaCAoZm9ybWF0KSB7CiAgICBjYXNlICdyYXcnOgogICAgICByZXR1cm4gZGF0YS5idWZmZXIuc2xpY2UoMCwgZGF0YS5ieXRlTGVuZ3RoKQogICAgY2FzZSAnandrJzogewogICAgICBjb25zdCBqd2sgPSB7CiAgICAgICAga3R5OiAnb2N0JywKICAgICAgICBrOiBkYXRhLnRvU3RyaW5nKCdiYXNlNjR1cmwnKSwKICAgICAgICBhbGc6IG51bGwsCiAgICAgICAga2V5X29wczoga2V5LnVzYWdlcywKICAgICAgICBleHQ6IGtleS5leHRyYWN0YWJsZQogICAgICB9CgogICAgICBzd2l0Y2ggKGtleS5hbGdvcml0aG0uaGFzaC5uYW1lKSB7CiAgICAgICAgY2FzZSAnU0hBLTEnOgogICAgICAgICAgandrLmFsZyA9ICdIUzEnCiAgICAgICAgICBicmVhawogICAgICAgIGNhc2UgJ1NIQS0yNTYnOgogICAgICAgICAgandrLmFsZyA9ICdIUzI1NicKICAgICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAnU0hBLTM4NCc6CiAgICAgICAgICBqd2suYWxnID0gJ0hTMzg0JwogICAgICAgICAgYnJlYWsKICAgICAgICBjYXNlICdTSEEtNTEyJzoKICAgICAgICAgIGp3ay5hbGcgPSAnSFM1MTInCiAgICAgICAgICBicmVhawogICAgICB9CgogICAgICByZXR1cm4gandrCiAgICB9CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICBgRm9ybWF0ICcke2Zvcm1hdH0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgSE1BQyBleHBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICkKICB9Cn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2htYWMtb3BlcmF0aW9ucy1nZXQta2V5LWxlbmd0aApleHBvcnRzLmdldEtleUxlbmd0aCA9IGZ1bmN0aW9uIGdldEtleUxlbmd0aChhbGdvcml0aG0pIHsKICBjb25zdCB7IGxlbmd0aCwgaGFzaCB9ID0gYWxnb3JpdGhtCgogIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCkgewogICAgaWYgKGhhc2ggPT09ICdTSEEtMScgfHwgaGFzaCA9PT0gJ1NIQS0yNTYnKSByZXR1cm4gNTEyCiAgICBpZiAoaGFzaCA9PT0gJ1NIQS01MTInKSByZXR1cm4gMTAyNAoKICAgIHRocm93IGVycm9ycy5PUEVSQVRJT05fRVJST1IoYEludmFsaWQgaGFzaCAnJHtoYXNofSdgKQogIH0KCiAgaWYgKGxlbmd0aCA9PT0gMCkgewogICAgdGhyb3cgZXJyb3JzLk9QRVJBVElPTl9FUlJPUihgSW52YWxpZCBsZW5ndGggJHtsZW5ndGh9YCkKICB9CgogIHJldHVybiBsZW5ndGgKfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCcuLi8uLi8uLicpCmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4uLy4uL2Vycm9ycycpCmNvbnN0IENyeXB0b0tleSA9IHJlcXVpcmUoJy4uL2NyeXB0by1rZXknKQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jcGJrZGYyCgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNwYmtkZjItb3BlcmF0aW9ucy1kZXJpdmUtYml0cwpleHBvcnRzLmRlcml2ZUJpdHMgPSBmdW5jdGlvbiBkZXJpdmVCaXRzKGFsZ29yaXRobSwga2V5LCBsZW5ndGgpIHsKICBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQgfHwgbGVuZ3RoICUgOCkgewogICAgdGhyb3cgZXJyb3JzLk9QRVJBVElPTl9FUlJPUignTGVuZ3RoIG11c3QgYmUgbXVsdGlwbGUgb2YgOCcpCiAgfQoKICBpZiAoYWxnb3JpdGhtLml0ZXJhdGlvbnMgPT09IDApIHsKICAgIHRocm93IGVycm9ycy5PUEVSQVRJT05fRVJST1IoJ0l0ZXJhdGlvbnMgbXVzdCBiZSBub24tMCcpCiAgfQoKICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gbmV3IEFycmF5QnVmZmVyKDApCiAgfQoKICBsZXQgaGFzaCA9IGFsZ29yaXRobS5oYXNoCgogIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3N0cmluZycpIGhhc2ggPSB7IG5hbWU6IGhhc2ggfQoKICBjb25zdCByZXN1bHQgPSBjcnlwdG8ucGJrZGYyKAogICAga2V5Ll9oYW5kbGUsCiAgICBhbGdvcml0aG0uc2FsdCwKICAgIGFsZ29yaXRobS5pdGVyYXRpb25zLAogICAgbGVuZ3RoIC8gOCwKICAgIGhhc2gubmFtZQogICkKCiAgcmV0dXJuIHJlc3VsdC5idWZmZXIKfQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jcGJrZGYyLW9wZXJhdGlvbnMtaW1wb3J0LWtleQpleHBvcnRzLmltcG9ydEtleSA9IGZ1bmN0aW9uIGltcG9ydEtleShmb3JtYXQsIGtleURhdGEsIGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykgewogIGlmIChmb3JtYXQgIT09ICdyYXcnKSB7CiAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgYEZvcm1hdCAnJHtmb3JtYXR9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIFBCS0RGMiBpbXBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICApCiAgfQoKICBmb3IgKGNvbnN0IHVzYWdlIG9mIHVzYWdlcykgewogICAgaWYgKHVzYWdlICE9PSAnZGVyaXZlS2V5JyAmJiB1c2FnZSAhPT0gJ2Rlcml2ZUJpdHMnKSB7CiAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihgSW52YWxpZCB1c2FnZSAke3VzYWdlfWApCiAgICB9CiAgfQoKICBpZiAoZXh0cmFjdGFibGUpIHsKICAgIHRocm93IG5ldyBTeW50YXhFcnJvcignRXh0cmFjdGFibGUgbXVzdCBiZSBmYWxzZScpCiAgfQoKICByZXR1cm4gbmV3IENyeXB0b0tleSgKICAgICdzZWNyZXQnLAogICAgZXh0cmFjdGFibGUsCiAgICB7CiAgICAgIG5hbWU6ICdQQktERjInCiAgICB9LAogICAgdXNhZ2VzLAogICAga2V5RGF0YQogICkKfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCcuLi8uLi8uLicpCgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNzaGEKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI3NoYS1vcGVyYXRpb25zLWRpZ2VzdApleHBvcnRzLmRpZ2VzdCA9IGZ1bmN0aW9uIGRpZ2VzdChuYW1lLCBkYXRhKSB7CiAgY29uc3QgZGlnZXN0ID0gY3J5cHRvLmNyZWF0ZUhhc2gobmFtZSkudXBkYXRlKGRhdGEpLmRpZ2VzdCgpCgogIHJldHVybiBkaWdlc3QuYnVmZmVyLnNsaWNlKDAsIGRpZ2VzdC5ieXRlTGVuZ3RoKQp9Ci8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2NyeXB0b2tleS1pbnRlcmZhY2UKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBDcnlwdG9LZXkgewogIGNvbnN0cnVjdG9yKHR5cGUsIGV4dHJhY3RhYmxlLCBhbGdvcml0aG0sIHVzYWdlcywgaGFuZGxlID0gbnVsbCkgewogICAgdGhpcy5fdHlwZSA9IHR5cGUKICAgIHRoaXMuX2V4dHJhY3RhYmxlID0gZXh0cmFjdGFibGUKICAgIHRoaXMuX2FsZ29yaXRobSA9IGFsZ29yaXRobQogICAgdGhpcy5fdXNhZ2VzID0gdXNhZ2VzCiAgICB0aGlzLl9oYW5kbGUgPSBoYW5kbGUKICB9CgogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2RvbS1jcnlwdG9rZXktdHlwZQogIGdldCB0eXBlKCkgewogICAgcmV0dXJuIHRoaXMuX3R5cGUKICB9CgogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2RvbS1jcnlwdG9rZXktZXh0cmFjdGFibGUKICBnZXQgZXh0cmFjdGFibGUoKSB7CiAgICByZXR1cm4gdGhpcy5fZXh0cmFjdGFibGUKICB9CgogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2RvbS1jcnlwdG9rZXktYWxnb3JpdGhtCiAgZ2V0IGFsZ29yaXRobSgpIHsKICAgIHJldHVybiB0aGlzLl9hbGdvcml0aG0KICB9CgogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2RvbS1jcnlwdG9rZXktdXNhZ2VzCiAgZ2V0IHVzYWdlcygpIHsKICAgIHJldHVybiB0aGlzLl91c2FnZXMKICB9CgogIFtTeW1ib2wuZm9yKCdiYXJlLmluc3BlY3QnKV0oKSB7CiAgICByZXR1cm4gewogICAgICBfX3Byb3RvX186IHsgY29uc3RydWN0b3I6IENyeXB0b0tleSB9LAoKICAgICAgdHlwZTogdGhpcy50eXBlLAogICAgICBleHRyYWN0YWJsZTogdGhpcy5leHRyYWN0YWJsZSwKICAgICAgYWxnb3JpdGhtOiB0aGlzLmFsZ29yaXRobSwKICAgICAgdXNhZ2VzOiB0aGlzLnVzYWdlcwogICAgfQogIH0KfQp7CiAgIm5hbWUiOiAiYmFyZS1jcnlwdG8iLAogICJ2ZXJzaW9uIjogIjEuMTIuMCIsCiAgImRlc2NyaXB0aW9uIjogIkNyeXB0b2dyYXBoaWMgcHJpbWl0aXZlcyBmb3IgSmF2YVNjcmlwdCIsCiAgImV4cG9ydHMiOiB7CiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuIjogewogICAgICAidHlwZXMiOiAiLi9pbmRleC5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9pbmRleC5qcyIKICAgIH0sCiAgICAiLi93ZWIiOiB7CiAgICAgICJ0eXBlcyI6ICIuL3dlYi5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi93ZWIuanMiCiAgICB9LAogICAgIi4vZ2xvYmFsIjogewogICAgICAidHlwZXMiOiAiLi9nbG9iYWwuZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vZ2xvYmFsLmpzIgogICAgfSwKICAgICIuL2NvbnN0YW50cyI6ICIuL2xpYi9jb25zdGFudHMuanMiLAogICAgIi4vZXJyb3JzIjogIi4vbGliL2Vycm9ycy5qcyIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiaW5kZXguZC50cyIsCiAgICAid2ViLmpzIiwKICAgICJ3ZWIuZC50cyIsCiAgICAiZ2xvYmFsLmpzIiwKICAgICJnbG9iYWwuZC50cyIsCiAgICAiYmluZGluZy5jIiwKICAgICJiaW5kaW5nLmpzIiwKICAgICJDTWFrZUxpc3RzLnR4dCIsCiAgICAibGliIiwKICAgICJwcmVidWlsZHMiCiAgXSwKICAiYWRkb24iOiB0cnVlLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJhcmUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLWNyeXB0by5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLWNyeXB0by9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtY3J5cHRvI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLXN0cmVhbSI6ICJeMi42LjMiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYnVmZmVyIjogIl4zLjAuMSIsCiAgICAiYnJpdHRsZSI6ICJeMy41LjAiLAogICAgImNtYWtlLWJhcmUiOiAiXjEuMS42IiwKICAgICJjbWFrZS1mZXRjaCI6ICJeMS4wLjAiLAogICAgInByZXR0aWVyIjogIl4zLjQuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiCiAgfSwKICAicGVlckRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWJ1ZmZlciI6ICIqIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXNNZXRhIjogewogICAgImJhcmUtYnVmZmVyIjogewogICAgICAib3B0aW9uYWwiOiB0cnVlCiAgICB9CiAgfQp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJy4nKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuL2xpYi9lcnJvcnMnKQpjb25zdCBDcnlwdG9LZXkgPSByZXF1aXJlKCcuL2xpYi93ZWIvY3J5cHRvLWtleScpCmNvbnN0IGhtYWMgPSByZXF1aXJlKCcuL2xpYi93ZWIvYWxnb3JpdGhtL2htYWMnKQpjb25zdCBwYmtkZjIgPSByZXF1aXJlKCcuL2xpYi93ZWIvYWxnb3JpdGhtL3Bia2RmMicpCmNvbnN0IGVkMjU1MTkgPSByZXF1aXJlKCcuL2xpYi93ZWIvYWxnb3JpdGhtL2VkMjU1MTknKQpjb25zdCBzaGEgPSByZXF1aXJlKCcuL2xpYi93ZWIvYWxnb3JpdGhtL3NoYScpCgpleHBvcnRzLkNyeXB0b0tleSA9IENyeXB0b0tleQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jQ3J5cHRvLW1ldGhvZC1nZXRSYW5kb21WYWx1ZXMKZXhwb3J0cy5nZXRSYW5kb21WYWx1ZXMgPSBmdW5jdGlvbiBnZXRSYW5kb21WYWx1ZXMoYXJyYXkpIHsKICByZXR1cm4gY3J5cHRvLnJhbmRvbUZpbGxTeW5jKGFycmF5KQp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNkZm4tQ3J5cHRvLW1ldGhvZC1yYW5kb21VVUlECmV4cG9ydHMucmFuZG9tVVVJRCA9IGNyeXB0by5yYW5kb21VVUlECgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNzdWJ0bGVjcnlwdG8taW50ZXJmYWNlCmV4cG9ydHMuU3VidGxlQ3J5cHRvID0gY2xhc3MgU3VidGxlQ3J5cHRvIHsKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNTdWJ0bGVDcnlwdG8tbWV0aG9kLWdlbmVyYXRlS2V5CiAgYXN5bmMgZ2VuZXJhdGVLZXkoYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKSB7CiAgICBpZiAodHlwZW9mIGFsZ29yaXRobSA9PT0gJ3N0cmluZycpIGFsZ29yaXRobSA9IHsgbmFtZTogYWxnb3JpdGhtIH0KCiAgICBzd2l0Y2ggKGFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAnaG1hYyc6CiAgICAgICAgcmV0dXJuIGhtYWMuZ2VuZXJhdGVLZXkoYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKQogICAgICBjYXNlICdlZDI1NTE5JzoKICAgICAgICByZXR1cm4gZWQyNTUxOS5nZW5lcmF0ZUtleShhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgICBgQWxnb3JpdGhtICcke2FsZ29yaXRobS5uYW1lfScgZG9lcyBub3Qgc3VwcG9ydCB0aGUgZ2VuZXJhdGVLZXkoKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgfQogIH0KCiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jU3VidGxlQ3J5cHRvLW1ldGhvZC1pbXBvcnRLZXkKICBhc3luYyBpbXBvcnRLZXkoZm9ybWF0LCBrZXlEYXRhLCBhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpIHsKICAgIGlmICh0eXBlb2YgYWxnb3JpdGhtID09PSAnc3RyaW5nJykgYWxnb3JpdGhtID0geyBuYW1lOiBhbGdvcml0aG0gfQoKICAgIHN3aXRjaCAoZm9ybWF0KSB7CiAgICAgIGNhc2UgJ3Jhdyc6CiAgICAgIGNhc2UgJ3BrY3M4JzoKICAgICAgY2FzZSAnc3BraSc6CiAgICAgICAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhrZXlEYXRhKSkgewogICAgICAgICAga2V5RGF0YSA9IEJ1ZmZlci5mcm9tKGtleURhdGEpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGtleURhdGEgPSBCdWZmZXIuZnJvbShrZXlEYXRhLnNsaWNlKCkpCiAgICAgICAgfQogICAgICAgIGJyZWFrCiAgICB9CgogICAgc3dpdGNoIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIGNhc2UgJ2htYWMnOgogICAgICAgIHJldHVybiBobWFjLmltcG9ydEtleShmb3JtYXQsIGtleURhdGEsIGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykKICAgICAgY2FzZSAnZWQyNTUxOSc6CiAgICAgICAgcmV0dXJuIGVkMjU1MTkuaW1wb3J0S2V5KGZvcm1hdCwga2V5RGF0YSwgYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKQogICAgICBjYXNlICdwYmtkZjInOgogICAgICAgIHJldHVybiBwYmtkZjIuaW1wb3J0S2V5KGZvcm1hdCwga2V5RGF0YSwgYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgICAgYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IHN1cHBvcnQgdGhlIGltcG9ydEtleSgpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICB9CiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNTdWJ0bGVDcnlwdG8tbWV0aG9kLWV4cG9ydEtleQogIGFzeW5jIGV4cG9ydEtleShmb3JtYXQsIGtleSkgewogICAgaWYgKCFrZXkuZXh0cmFjdGFibGUpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKCdLZXkgaXMgbm90IGV4dHJhY3RhYmxlJykKICAgIH0KCiAgICBzd2l0Y2ggKGtleS5hbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIGNhc2UgJ2htYWMnOgogICAgICAgIHJldHVybiBobWFjLmV4cG9ydEtleShmb3JtYXQsIGtleSkKICAgICAgY2FzZSAnZWQyNTUxOSc6CiAgICAgICAgcmV0dXJuIGVkMjU1MTkuZXhwb3J0S2V5KGZvcm1hdCwga2V5KQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgICAgYEFsZ29yaXRobSAnJHtrZXkuYWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBzdXBwb3J0IHRoZSBleHBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgfQogIH0KCiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jU3VidGxlQ3J5cHRvLW1ldGhvZC1zaWduCiAgYXN5bmMgc2lnbihhbGdvcml0aG0sIGtleSwgZGF0YSkgewogICAgaWYgKHR5cGVvZiBhbGdvcml0aG0gPT09ICdzdHJpbmcnKSBhbGdvcml0aG0gPSB7IG5hbWU6IGFsZ29yaXRobSB9CgogICAgaWYgKGFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkgIT09IGtleS5hbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUyhgQWxnb3JpdGhtICcke2FsZ29yaXRobS5uYW1lfScgZG9lcyBub3QgbWF0Y2gga2V5J2ApCiAgICB9CgogICAgaWYgKCFrZXkudXNhZ2VzLmluY2x1ZGVzKCdzaWduJykpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKCdLZXkgY2Fubm90IGJlIHVzZWQgZm9yIHNpZ25pbmcnKQogICAgfQoKICAgIHN3aXRjaCAoYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdobWFjJzoKICAgICAgICByZXR1cm4gaG1hYy5zaWduKGFsZ29yaXRobSwga2V5LCBkYXRhKQogICAgICBjYXNlICdlZDI1NTE5JzoKICAgICAgICByZXR1cm4gZWQyNTUxOS5zaWduKGFsZ29yaXRobSwga2V5LCBkYXRhKQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgICAgYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IHN1cHBvcnQgdGhlIHNpZ24oKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgfQogIH0KCiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jU3VidGxlQ3J5cHRvLW1ldGhvZC12ZXJpZnkKICBhc3luYyB2ZXJpZnkoYWxnb3JpdGhtLCBrZXksIHNpZ25hdHVyZSwgZGF0YSkgewogICAgaWYgKHR5cGVvZiBhbGdvcml0aG0gPT09ICdzdHJpbmcnKSBhbGdvcml0aG0gPSB7IG5hbWU6IGFsZ29yaXRobSB9CgogICAgaWYgKGFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkgIT09IGtleS5hbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUyhgQWxnb3JpdGhtICcke2FsZ29yaXRobS5uYW1lfScgZG9lcyBub3QgbWF0Y2gga2V5J2ApCiAgICB9CgogICAgaWYgKCFrZXkudXNhZ2VzLmluY2x1ZGVzKCd2ZXJpZnknKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoJ0tleSBjYW5ub3QgYmUgdXNlZCBmb3IgdmVyaWZpY2F0aW9uJykKICAgIH0KCiAgICBzd2l0Y2ggKGFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAnaG1hYyc6CiAgICAgICAgcmV0dXJuIGhtYWMudmVyaWZ5KGFsZ29yaXRobSwga2V5LCBzaWduYXR1cmUsIGRhdGEpCiAgICAgIGNhc2UgJ2VkMjU1MTknOgogICAgICAgIHJldHVybiBlZDI1NTE5LnZlcmlmeShhbGdvcml0aG0sIGtleSwgc2lnbmF0dXJlLCBkYXRhKQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgICAgYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IHN1cHBvcnQgdGhlIHZlcmlmeSgpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICB9CiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNTdWJ0bGVDcnlwdG8tbWV0aG9kLWRlcml2ZUJpdHMKICBhc3luYyBkZXJpdmVCaXRzKGFsZ29yaXRobSwga2V5LCBsZW5ndGgpIHsKICAgIGlmICh0eXBlb2YgYWxnb3JpdGhtID09PSAnc3RyaW5nJykgYWxnb3JpdGhtID0geyBuYW1lOiBhbGdvcml0aG0gfQoKICAgIGlmIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpICE9PSBrZXkuYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IG1hdGNoIGtleSdgKQogICAgfQoKICAgIGlmICgha2V5LnVzYWdlcy5pbmNsdWRlcygnZGVyaXZlQml0cycpKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUygnS2V5IGNhbm5vdCBiZSB1c2VkIHRvIGRlcml2ZSBiaXRzJykKICAgIH0KCiAgICBzd2l0Y2ggKGFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAncGJrZGYyJzoKICAgICAgICByZXR1cm4gcGJrZGYyLmRlcml2ZUJpdHMoYWxnb3JpdGhtLCBrZXksIGxlbmd0aCkKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICAgIGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBzdXBwb3J0IHRoZSBkZXJpdmVCaXRzKCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgIH0KICB9CgogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI1N1YnRsZUNyeXB0by1tZXRob2QtZGVyaXZlS2V5CiAgYXN5bmMgZGVyaXZlS2V5KGFsZ29yaXRobSwgYmFzZUtleSwgZGVyaXZlZEtleVR5cGUsIGV4dHJhY3RhYmxlLCB1c2FnZXMpIHsKICAgIGlmICh0eXBlb2YgYWxnb3JpdGhtID09PSAnc3RyaW5nJykgYWxnb3JpdGhtID0geyBuYW1lOiBhbGdvcml0aG0gfQoKICAgIGlmICh0eXBlb2YgZGVyaXZlZEtleVR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgIGRlcml2ZWRLZXlUeXBlID0geyBuYW1lOiBkZXJpdmVkS2V5VHlwZSB9CiAgICB9CgogICAgaWYgKGFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkgIT09IGJhc2VLZXkuYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IG1hdGNoIGtleSdgKQogICAgfQoKICAgIGlmICghYmFzZUtleS51c2FnZXMuaW5jbHVkZXMoJ2Rlcml2ZUtleScpKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUygnS2V5IGNhbm5vdCBiZSB1c2VkIHRvIGRlcml2ZSBrZXknKQogICAgfQoKICAgIGxldCBsZW5ndGgKCiAgICBzd2l0Y2ggKGRlcml2ZWRLZXlUeXBlLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdobWFjJzoKICAgICAgICBsZW5ndGggPSBobWFjLmdldEtleUxlbmd0aChkZXJpdmVkS2V5VHlwZSkKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgICAgYEFsZ29yaXRobSAnJHtkZXJpdmVkS2V5VHlwZS5uYW1lfScgZG9lcyBub3Qgc3VwcG9ydCB0aGUgZ2V0S2V5TGVuZ3RoKCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgIH0KCiAgICBsZXQgc2VjcmV0CgogICAgc3dpdGNoIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIGNhc2UgJ3Bia2RmMic6CiAgICAgICAgc2VjcmV0ID0gcGJrZGYyLmRlcml2ZUJpdHMoYWxnb3JpdGhtLCBiYXNlS2V5LCBsZW5ndGgpCiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICAgIGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBzdXBwb3J0IHRoZSBkZXJpdmVCaXRzKCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgIH0KCiAgICByZXR1cm4gdGhpcy5pbXBvcnRLZXkoJ3JhdycsIHNlY3JldCwgZGVyaXZlZEtleVR5cGUsIGV4dHJhY3RhYmxlLCB1c2FnZXMpCiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNTdWJ0bGVDcnlwdG8tbWV0aG9kLWRpZ2VzdAogIGFzeW5jIGRpZ2VzdChhbGdvcml0aG0sIGRhdGEpIHsKICAgIGlmICh0eXBlb2YgYWxnb3JpdGhtID09PSAnc3RyaW5nJykgYWxnb3JpdGhtID0geyBuYW1lOiBhbGdvcml0aG0gfQoKICAgIHN3aXRjaCAoYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdzaGEtMSc6CiAgICAgICAgcmV0dXJuIHNoYS5kaWdlc3QoJ3NoYTEnLCBkYXRhKQogICAgICBjYXNlICdzaGEtMjU2JzoKICAgICAgICByZXR1cm4gc2hhLmRpZ2VzdCgnc2hhMjU2JywgZGF0YSkKICAgICAgY2FzZSAnc2hhLTUxMic6CiAgICAgICAgcmV0dXJuIHNoYS5kaWdlc3QoJ3NoYTUxMicsIGRhdGEpCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgICBgQWxnb3JpdGhtICcke2FsZ29yaXRobS5uYW1lfScgZG9lcyBub3Qgc3VwcG9ydCB0aGUgZGlnZXN0KCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgIH0KICB9Cn0KCmV4cG9ydHMuc3VidGxlID0gbmV3IGV4cG9ydHMuU3VidGxlQ3J5cHRvKCkKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2NyeXB0by1pbnRlcmZhY2UKZXhwb3J0cy5DcnlwdG8gPSBjbGFzcyBDcnlwdG8gewogIGdldCBzdWJ0bGUoKSB7CiAgICByZXR1cm4gZXhwb3J0cy5zdWJ0bGUKICB9CgogIGdldFJhbmRvbVZhbHVlcyhhcnJheSkgewogICAgcmV0dXJuIGV4cG9ydHMuZ2V0UmFuZG9tVmFsdWVzKGFycmF5KQogIH0KCiAgcmFuZG9tVVVJRCgpIHsKICAgIHJldHVybiBleHBvcnRzLnJhbmRvbVVVSUQoKQogIH0KfQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuL2xpYi9lcnJvcnMnKQoKY2xhc3MgRXZlbnRMaXN0ZW5lciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLmxpc3QgPSBbXQogICAgdGhpcy5jb3VudCA9IDAKICB9CgogIGFwcGVuZChjdHgsIG5hbWUsIGZuLCBvbmNlKSB7CiAgICB0aGlzLmNvdW50KysKICAgIGN0eC5lbWl0KCduZXdMaXN0ZW5lcicsIG5hbWUsIGZuKSAvLyBFbWl0IEJFRk9SRSBhZGRpbmcKICAgIHRoaXMubGlzdC5wdXNoKFtmbiwgb25jZV0pCiAgfQoKICBwcmVwZW5kKGN0eCwgbmFtZSwgZm4sIG9uY2UpIHsKICAgIHRoaXMuY291bnQrKwogICAgY3R4LmVtaXQoJ25ld0xpc3RlbmVyJywgbmFtZSwgZm4pIC8vIEVtaXQgQkVGT1JFIGFkZGluZwogICAgdGhpcy5saXN0LnVuc2hpZnQoW2ZuLCBvbmNlXSkKICB9CgogIHJlbW92ZShjdHgsIG5hbWUsIGZuKSB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IHRoaXMubGlzdC5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgY29uc3QgbCA9IHRoaXMubGlzdFtpXQoKICAgICAgaWYgKGxbMF0gPT09IGZuKSB7CiAgICAgICAgdGhpcy5saXN0LnNwbGljZShpLCAxKQoKICAgICAgICBpZiAodGhpcy5jb3VudCA9PT0gMSkgZGVsZXRlIGN0eC5fZXZlbnRzW25hbWVdCgogICAgICAgIGN0eC5lbWl0KCdyZW1vdmVMaXN0ZW5lcicsIG5hbWUsIGZuKSAvLyBFbWl0IEFGVEVSIHJlbW92aW5nCgogICAgICAgIHRoaXMuY291bnQtLQogICAgICAgIHJldHVybgogICAgICB9CiAgICB9CiAgfQoKICByZW1vdmVBbGwoY3R4LCBuYW1lKSB7CiAgICBjb25zdCBsaXN0ID0gWy4uLnRoaXMubGlzdF0KICAgIHRoaXMubGlzdCA9IFtdCgogICAgaWYgKHRoaXMuY291bnQgPT09IGxpc3QubGVuZ3RoKSBkZWxldGUgY3R4Ll9ldmVudHNbbmFtZV0KCiAgICBmb3IgKGxldCBpID0gbGlzdC5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjdHguZW1pdCgncmVtb3ZlTGlzdGVuZXInLCBuYW1lLCBsaXN0W2ldWzBdKSAvLyBFbWl0IEFGVEVSIHJlbW92aW5nCiAgICB9CgogICAgdGhpcy5jb3VudCAtPSBsaXN0Lmxlbmd0aAogIH0KCiAgZW1pdChjdHgsIG5hbWUsIC4uLmFyZ3MpIHsKICAgIGNvbnN0IGxpc3QgPSBbLi4udGhpcy5saXN0XQoKICAgIGZvciAobGV0IGkgPSAwLCBuID0gbGlzdC5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgY29uc3QgbCA9IGxpc3RbaV0KCiAgICAgIGlmIChsWzFdID09PSB0cnVlKSB0aGlzLnJlbW92ZShjdHgsIG5hbWUsIGxbMF0pCgogICAgICBSZWZsZWN0LmFwcGx5KGxbMF0sIGN0eCwgYXJncykKICAgIH0KCiAgICByZXR1cm4gbGlzdC5sZW5ndGggPiAwCiAgfQp9CgpmdW5jdGlvbiBhcHBlbmRMaXN0ZW5lcihjdHgsIG5hbWUsIGZuLCBvbmNlKSB7CiAgaWYgKGN0eC5fZXZlbnRzID09PSB1bmRlZmluZWQpIGN0eC5fZXZlbnRzID0gT2JqZWN0LmNyZWF0ZShudWxsKQogIGNvbnN0IGUgPSBjdHguX2V2ZW50c1tuYW1lXSB8fCAoY3R4Ll9ldmVudHNbbmFtZV0gPSBuZXcgRXZlbnRMaXN0ZW5lcigpKQogIGUuYXBwZW5kKGN0eCwgbmFtZSwgZm4sIG9uY2UpCiAgcmV0dXJuIGN0eAp9CgpmdW5jdGlvbiBwcmVwZW5kTGlzdGVuZXIoY3R4LCBuYW1lLCBmbiwgb25jZSkgewogIGlmIChjdHguX2V2ZW50cyA9PT0gdW5kZWZpbmVkKSBjdHguX2V2ZW50cyA9IE9iamVjdC5jcmVhdGUobnVsbCkKICBjb25zdCBlID0gY3R4Ll9ldmVudHNbbmFtZV0gfHwgKGN0eC5fZXZlbnRzW25hbWVdID0gbmV3IEV2ZW50TGlzdGVuZXIoKSkKICBlLnByZXBlbmQoY3R4LCBuYW1lLCBmbiwgb25jZSkKICByZXR1cm4gY3R4Cn0KCmZ1bmN0aW9uIHJlbW92ZUxpc3RlbmVyKGN0eCwgbmFtZSwgZm4pIHsKICBpZiAoY3R4Ll9ldmVudHMgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGN0eAogIGNvbnN0IGUgPSBjdHguX2V2ZW50c1tuYW1lXQogIGlmIChlICE9PSB1bmRlZmluZWQpIGUucmVtb3ZlKGN0eCwgbmFtZSwgZm4pCiAgcmV0dXJuIGN0eAp9CgpmdW5jdGlvbiB0aHJvd1VuaGFuZGxlZEVycm9yKC4uLmFyZ3MpIHsKICBsZXQgZXJyCgogIGlmIChhcmdzLmxlbmd0aCA+IDApIGVyciA9IGFyZ3NbMF0KCiAgaWYgKGVyciBpbnN0YW5jZW9mIEVycm9yID09PSBmYWxzZSkgZXJyID0gZXJyb3JzLlVOSEFORExFRF9FUlJPUihlcnIpCgogIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UoZXJyLCBleHBvcnRzLnByb3RvdHlwZS5lbWl0KQogIH0KCiAgcXVldWVNaWNyb3Rhc2soKCkgPT4gewogICAgdGhyb3cgZXJyCiAgfSkKfQoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gY2xhc3MgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuX2V2ZW50cyA9IE9iamVjdC5jcmVhdGUobnVsbCkKICB9CgogIGFkZExpc3RlbmVyKG5hbWUsIGZuKSB7CiAgICByZXR1cm4gYXBwZW5kTGlzdGVuZXIodGhpcywgbmFtZSwgZm4sIGZhbHNlKQogIH0KCiAgYWRkT25jZUxpc3RlbmVyKG5hbWUsIGZuKSB7CiAgICByZXR1cm4gYXBwZW5kTGlzdGVuZXIodGhpcywgbmFtZSwgZm4sIHRydWUpCiAgfQoKICBwcmVwZW5kTGlzdGVuZXIobmFtZSwgZm4pIHsKICAgIHJldHVybiBwcmVwZW5kTGlzdGVuZXIodGhpcywgbmFtZSwgZm4sIGZhbHNlKQogIH0KCiAgcHJlcGVuZE9uY2VMaXN0ZW5lcihuYW1lLCBmbikgewogICAgcmV0dXJuIHByZXBlbmRMaXN0ZW5lcih0aGlzLCBuYW1lLCBmbiwgdHJ1ZSkKICB9CgogIHJlbW92ZUxpc3RlbmVyKG5hbWUsIGZuKSB7CiAgICByZXR1cm4gcmVtb3ZlTGlzdGVuZXIodGhpcywgbmFtZSwgZm4pCiAgfQoKICBvbihuYW1lLCBmbikgewogICAgcmV0dXJuIGFwcGVuZExpc3RlbmVyKHRoaXMsIG5hbWUsIGZuLCBmYWxzZSkKICB9CgogIG9uY2UobmFtZSwgZm4pIHsKICAgIHJldHVybiBhcHBlbmRMaXN0ZW5lcih0aGlzLCBuYW1lLCBmbiwgdHJ1ZSkKICB9CgogIG9mZihuYW1lLCBmbikgewogICAgcmV0dXJuIHJlbW92ZUxpc3RlbmVyKHRoaXMsIG5hbWUsIGZuKQogIH0KCiAgZW1pdChuYW1lLCAuLi5hcmdzKSB7CiAgICBpZiAobmFtZSA9PT0gJ2Vycm9yJyAmJiB0aGlzLl9ldmVudHMgIT09IHVuZGVmaW5lZCAmJiB0aGlzLl9ldmVudHMuZXJyb3IgPT09IHVuZGVmaW5lZCkgewogICAgICB0aHJvd1VuaGFuZGxlZEVycm9yKC4uLmFyZ3MpCiAgICB9CgogICAgaWYgKHRoaXMuX2V2ZW50cyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2UKICAgIGNvbnN0IGUgPSB0aGlzLl9ldmVudHNbbmFtZV0KICAgIHJldHVybiBlID09PSB1bmRlZmluZWQgPyBmYWxzZSA6IGUuZW1pdCh0aGlzLCBuYW1lLCAuLi5hcmdzKQogIH0KCiAgbGlzdGVuZXJzKG5hbWUpIHsKICAgIGlmICh0aGlzLl9ldmVudHMgPT09IHVuZGVmaW5lZCkgcmV0dXJuIFtdCiAgICBjb25zdCBlID0gdGhpcy5fZXZlbnRzW25hbWVdCiAgICByZXR1cm4gZSA9PT0gdW5kZWZpbmVkID8gW10gOiBbLi4uZS5saXN0XQogIH0KCiAgbGlzdGVuZXJDb3VudChuYW1lKSB7CiAgICBpZiAodGhpcy5fZXZlbnRzID09PSB1bmRlZmluZWQpIHJldHVybiAwCiAgICBjb25zdCBlID0gdGhpcy5fZXZlbnRzW25hbWVdCiAgICByZXR1cm4gZSA9PT0gdW5kZWZpbmVkID8gMCA6IGUubGlzdC5sZW5ndGgKICB9CgogIGdldE1heExpc3RlbmVycygpIHsKICAgIHJldHVybiBFdmVudEVtaXR0ZXIuZGVmYXVsdE1heExpc3RlbmVycwogIH0KCiAgc2V0TWF4TGlzdGVuZXJzKG4pIHt9CgogIHJlbW92ZUFsbExpc3RlbmVycyhuYW1lKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICBmb3IgKGNvbnN0IGtleSBvZiBSZWZsZWN0Lm93bktleXModGhpcy5fZXZlbnRzKSkgewogICAgICAgIGlmIChrZXkgPT09ICdyZW1vdmVMaXN0ZW5lcicpIGNvbnRpbnVlCiAgICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoa2V5KQogICAgICB9CiAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCdyZW1vdmVMaXN0ZW5lcicpCiAgICB9IGVsc2UgewogICAgICBjb25zdCBlID0gdGhpcy5fZXZlbnRzW25hbWVdCiAgICAgIGlmIChlICE9PSB1bmRlZmluZWQpIGUucmVtb3ZlQWxsKHRoaXMsIG5hbWUpCiAgICB9CiAgICByZXR1cm4gdGhpcwogIH0KfQoKZXhwb3J0cy5FdmVudEVtaXR0ZXIgPSBleHBvcnRzCgpleHBvcnRzLmVycm9ycyA9IGVycm9ycwoKZXhwb3J0cy5kZWZhdWx0TWF4TGlzdGVuZXJzID0gMTAKCmV4cG9ydHMub24gPSBmdW5jdGlvbiBvbihlbWl0dGVyLCBuYW1lLCBvcHRzID0ge30pIHsKICBjb25zdCB7IHNpZ25hbCB9ID0gb3B0cwoKICBpZiAoc2lnbmFsICYmIHNpZ25hbC5hYm9ydGVkKSB7CiAgICB0aHJvdyBlcnJvcnMuT1BFUkFUSU9OX0FCT1JURUQoc2lnbmFsLnJlYXNvbikKICB9CgogIGxldCBlcnJvciA9IG51bGwKICBsZXQgZG9uZSA9IGZhbHNlCgogIGNvbnN0IGV2ZW50cyA9IFtdCiAgY29uc3QgcHJvbWlzZXMgPSBbXQoKICBpZiAobmFtZSAhPT0gJ2Vycm9yJykgZW1pdHRlci5vbignZXJyb3InLCBvbmVycm9yKQoKICBpZiAoc2lnbmFsKSBzaWduYWwuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBvbmFib3J0KQoKICBlbWl0dGVyLm9uKG5hbWUsIG9uZXZlbnQpCgogIHJldHVybiB7CiAgICBuZXh0KCkgewogICAgICBpZiAoZXZlbnRzLmxlbmd0aCkgewogICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyB2YWx1ZTogZXZlbnRzLnNoaWZ0KCksIGRvbmU6IGZhbHNlIH0pCiAgICAgIH0KCiAgICAgIGlmIChlcnJvcikgewogICAgICAgIGNvbnN0IGVyciA9IGVycm9yCgogICAgICAgIGVycm9yID0gbnVsbAoKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogICAgICB9CgogICAgICBpZiAoZG9uZSkgcmV0dXJuIG9uY2xvc2UoKQoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHByb21pc2VzLnB1c2goeyByZXNvbHZlLCByZWplY3QgfSkpCiAgICB9LAoKICAgIHJldHVybigpIHsKICAgICAgcmV0dXJuIG9uY2xvc2UoKQogICAgfSwKCiAgICB0aHJvdyhlcnIpIHsKICAgICAgcmV0dXJuIG9uZXJyb3IoZXJyKQogICAgfSwKCiAgICBbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgewogICAgICByZXR1cm4gdGhpcwogICAgfQogIH0KCiAgZnVuY3Rpb24gb25ldmVudCguLi5hcmdzKSB7CiAgICBpZiAocHJvbWlzZXMubGVuZ3RoKSB7CiAgICAgIHByb21pc2VzLnNoaWZ0KCkucmVzb2x2ZSh7IHZhbHVlOiBhcmdzLCBkb25lOiBmYWxzZSB9KQogICAgfSBlbHNlIHsKICAgICAgZXZlbnRzLnB1c2goYXJncykKICAgIH0KICB9CgogIGZ1bmN0aW9uIG9uZXJyb3IoZXJyKSB7CiAgICBlbWl0dGVyLm9mZihuYW1lLCBvbmV2ZW50KS5vZmYoJ2Vycm9yJywgb25lcnJvcikKCiAgICBpZiAocHJvbWlzZXMubGVuZ3RoKSB7CiAgICAgIHByb21pc2VzLnNoaWZ0KCkucmVqZWN0KGVycikKICAgIH0gZWxzZSB7CiAgICAgIGVycm9yID0gZXJyCiAgICB9CgogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGRvbmU6IHRydWUgfSkKICB9CgogIGZ1bmN0aW9uIG9uYWJvcnQoKSB7CiAgICBzaWduYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBvbmFib3J0KQoKICAgIG9uZXJyb3IoZXJyb3JzLk9QRVJBVElPTl9BQk9SVEVEKHNpZ25hbC5yZWFzb24pKQogIH0KCiAgZnVuY3Rpb24gb25jbG9zZSgpIHsKICAgIGVtaXR0ZXIub2ZmKG5hbWUsIG9uZXZlbnQpCgogICAgaWYgKG5hbWUgIT09ICdlcnJvcicpIGVtaXR0ZXIub2ZmKCdlcnJvcicsIG9uZXJyb3IpCgogICAgaWYgKHNpZ25hbCkgc2lnbmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2Fib3J0Jywgb25hYm9ydCkKCiAgICBkb25lID0gdHJ1ZQoKICAgIGlmIChwcm9taXNlcy5sZW5ndGgpIHByb21pc2VzLnNoaWZ0KCkucmVzb2x2ZSh7IGRvbmU6IHRydWUgfSkKCiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgZG9uZTogdHJ1ZSB9KQogIH0KfQoKZXhwb3J0cy5vbmNlID0gZnVuY3Rpb24gb25jZShlbWl0dGVyLCBuYW1lLCBvcHRzID0ge30pIHsKICBjb25zdCB7IHNpZ25hbCB9ID0gb3B0cwoKICBpZiAoc2lnbmFsICYmIHNpZ25hbC5hYm9ydGVkKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3JzLk9QRVJBVElPTl9BQk9SVEVEKHNpZ25hbC5yZWFzb24pKQogIH0KCiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIGlmIChuYW1lICE9PSAnZXJyb3InKSBlbWl0dGVyLm9uKCdlcnJvcicsIG9uZXJyb3IpCgogICAgaWYgKHNpZ25hbCkgc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoJ2Fib3J0Jywgb25hYm9ydCkKCiAgICBlbWl0dGVyLm9uY2UobmFtZSwgb25ldmVudCkKCiAgICBmdW5jdGlvbiBvbmV2ZW50KC4uLmFyZ3MpIHsKICAgICAgaWYgKG5hbWUgIT09ICdlcnJvcicpIGVtaXR0ZXIub2ZmKCdlcnJvcicsIG9uZXJyb3IpCgogICAgICBpZiAoc2lnbmFsKSBzaWduYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBvbmFib3J0KQoKICAgICAgcmVzb2x2ZShhcmdzKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uZXJyb3IoZXJyKSB7CiAgICAgIGVtaXR0ZXIub2ZmKG5hbWUsIG9uZXZlbnQpCgogICAgICBpZiAobmFtZSAhPT0gJ2Vycm9yJykgZW1pdHRlci5vZmYoJ2Vycm9yJywgb25lcnJvcikKCiAgICAgIHJlamVjdChlcnIpCiAgICB9CgogICAgZnVuY3Rpb24gb25hYm9ydCgpIHsKICAgICAgc2lnbmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2Fib3J0Jywgb25hYm9ydCkKCiAgICAgIG9uZXJyb3IoZXJyb3JzLk9QRVJBVElPTl9BQk9SVEVEKHNpZ25hbC5yZWFzb24pKQogICAgfQogIH0pCn0KCmV4cG9ydHMuZm9yd2FyZCA9IGZ1bmN0aW9uIGZvcndhcmQoZnJvbSwgdG8sIG5hbWVzLCBvcHRzID0ge30pIHsKICBpZiAodHlwZW9mIG5hbWVzID09PSAnc3RyaW5nJykgbmFtZXMgPSBbbmFtZXNdCgogIGNvbnN0IHsgZW1pdCA9IHRvLmVtaXQuYmluZCh0bykgfSA9IG9wdHMKCiAgY29uc3QgbGlzdGVuZXJzID0gbmFtZXMubWFwKAogICAgKG5hbWUpID0+CiAgICAgIGZ1bmN0aW9uIG9uZXZlbnQoLi4uYXJncykgewogICAgICAgIGVtaXQobmFtZSwgLi4uYXJncykKICAgICAgfQogICkKCiAgdG8ub24oJ25ld0xpc3RlbmVyJywgKG5hbWUpID0+IHsKICAgIGNvbnN0IGkgPSBuYW1lcy5pbmRleE9mKG5hbWUpCgogICAgaWYgKGkgIT09IC0xICYmIHRvLmxpc3RlbmVyQ291bnQobmFtZSkgPT09IDApIHsKICAgICAgZnJvbS5vbihuYW1lLCBsaXN0ZW5lcnNbaV0pCiAgICB9CiAgfSkub24oJ3JlbW92ZUxpc3RlbmVyJywgKG5hbWUpID0+IHsKICAgIGNvbnN0IGkgPSBuYW1lcy5pbmRleE9mKG5hbWUpCgogICAgaWYgKGkgIT09IC0xICYmIHRvLmxpc3RlbmVyQ291bnQobmFtZSkgPT09IDApIHsKICAgICAgZnJvbS5vZmYobmFtZSwgbGlzdGVuZXJzW2ldKQogICAgfQogIH0pCn0KCmV4cG9ydHMubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uIGxpc3RlbmVyQ291bnQoZW1pdHRlciwgbmFtZSkgewogIHJldHVybiBlbWl0dGVyLmxpc3RlbmVyQ291bnQobmFtZSkKfQoKZXhwb3J0cy5nZXRNYXhMaXN0ZW5lcnMgPSBmdW5jdGlvbiBnZXRNYXhMaXN0ZW5lcnMoZW1pdHRlcikgewogIGlmICh0eXBlb2YgZW1pdHRlci5nZXRNYXhMaXN0ZW5lcnMgPT09ICdmdW5jdGlvbicpIHsKICAgIHJldHVybiBlbWl0dGVyLmdldE1heExpc3RlbmVycygpCiAgfQoKICByZXR1cm4gZXhwb3J0cy5kZWZhdWx0TWF4TGlzdGVuZXJzCn0KCmV4cG9ydHMuc2V0TWF4TGlzdGVuZXJzID0gZnVuY3Rpb24gc2V0TWF4TGlzdGVuZXJzKG4sIC4uLmVtaXR0ZXJzKSB7CiAgaWYgKGVtaXR0ZXJzLmxlbmd0aCA9PT0gMCkgZXhwb3J0cy5kZWZhdWx0TWF4TGlzdGVuZXJzID0gbgogIGVsc2UgewogICAgZm9yIChjb25zdCBlbWl0dGVyIG9mIGVtaXR0ZXJzKSB7CiAgICAgIGlmICh0eXBlb2YgZW1pdHRlci5zZXRNYXhMaXN0ZW5lcnMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBlbWl0dGVyLnNldE1heExpc3RlbmVycyhuKQogICAgICB9CiAgICB9CiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgRXZlbnRFbWl0dGVyRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobXNnLCBjb2RlLCBmbiA9IEV2ZW50RW1pdHRlckVycm9yLCBvcHRzKSB7CiAgICBzdXBlcihgJHtjb2RlfTogJHttc2d9YCwgb3B0cykKICAgIHRoaXMuY29kZSA9IGNvZGUKCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgZm4pCiAgICB9CiAgfQoKICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiAnRXZlbnRFbWl0dGVyRXJyb3InCiAgfQoKICBzdGF0aWMgT1BFUkFUSU9OX0FCT1JURUQoY2F1c2UsIG1zZyA9ICdPcGVyYXRpb24gYWJvcnRlZCcpIHsKICAgIHJldHVybiBuZXcgRXZlbnRFbWl0dGVyRXJyb3IobXNnLCAnT1BFUkFUSU9OX0FCT1JURUQnLCBFdmVudEVtaXR0ZXJFcnJvci5PUEVSQVRJT05fQUJPUlRFRCwgewogICAgICBjYXVzZQogICAgfSkKICB9CgogIHN0YXRpYyBVTkhBTkRMRURfRVJST1IoY2F1c2UsIG1zZyA9ICdVbmhhbmRsZWQgZXJyb3InKSB7CiAgICByZXR1cm4gbmV3IEV2ZW50RW1pdHRlckVycm9yKG1zZywgJ1VOSEFORExFRF9FUlJPUicsIEV2ZW50RW1pdHRlckVycm9yLlVOSEFORExFRF9FUlJPUiwgewogICAgICBjYXVzZQogICAgfSkKICB9Cn0KewogICJuYW1lIjogImJhcmUtZXZlbnRzIiwKICAidmVyc2lvbiI6ICIyLjguMiIsCiAgImRlc2NyaXB0aW9uIjogIkV2ZW50IGVtaXR0ZXJzIGZvciBKYXZhU2NyaXB0IiwKICAiZXhwb3J0cyI6IHsKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4iOiB7CiAgICAgICJ0eXBlcyI6ICIuL2luZGV4LmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2luZGV4LmpzIgogICAgfSwKICAgICIuL2dsb2JhbCI6IHsKICAgICAgInR5cGVzIjogIi4vZ2xvYmFsLmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2dsb2JhbC5qcyIKICAgIH0sCiAgICAiLi93ZWIiOiB7CiAgICAgICJ0eXBlcyI6ICIuL3dlYi5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi93ZWIuanMiCiAgICB9LAogICAgIi4vZXJyb3JzIjogIi4vbGliL2Vycm9ycy5qcyIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiaW5kZXguZC50cyIsCiAgICAiZ2xvYmFsLmpzIiwKICAgICJnbG9iYWwuZC50cyIsCiAgICAid2ViLmpzIiwKICAgICJ3ZWIuZC50cyIsCiAgICAibGliIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJucG0gcnVuIGxpbnQgJiYgbnBtIHJ1biB0ZXN0OmJhcmUgJiYgbnBtIHJ1biB0ZXN0Om5vZGUiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QuanMiLAogICAgInRlc3Q6bm9kZSI6ICJub2RlIHRlc3QuanMiLAogICAgImxpbnQiOiAicHJldHRpZXIgLiAtLWNoZWNrIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtZXZlbnRzLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtZXZlbnRzL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1ldmVudHMjcmVhZG1lIiwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYWJvcnQtY29udHJvbGxlciI6ICJeMS4wLjAiLAogICAgImJyaXR0bGUiOiAiXjMuMy4yIiwKICAgICJwcmV0dGllciI6ICJeMy40LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIiwKICAgICJ1bmNhdWdodHMiOiAiXjEuMS4xIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1hYm9ydC1jb250cm9sbGVyIjogIioiCiAgfSwKICAicGVlckRlcGVuZGVuY2llc01ldGEiOiB7CiAgICAiYmFyZS1hYm9ydC1jb250cm9sbGVyIjogewogICAgICAib3B0aW9uYWwiOiB0cnVlCiAgICB9CiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZS5hZGRvbigpCmNvbnN0IEZJRk8gPSByZXF1aXJlKCdmYXN0LWZpZm8nKQpjb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdiYXJlLWV2ZW50cycpCmNvbnN0IHBhdGggPSByZXF1aXJlKCdiYXJlLXBhdGgnKQpjb25zdCB7IGZpbGVVUkxUb1BhdGggfSA9IHJlcXVpcmUoJ2JhcmUtdXJsJykKY29uc3QgeyBSZWFkYWJsZSwgV3JpdGFibGUgfSA9IHJlcXVpcmUoJ2JhcmUtc3RyZWFtJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4vYmluZGluZycpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vbGliL2NvbnN0YW50cycpCmNvbnN0IEZpbGVFcnJvciA9IHJlcXVpcmUoJy4vbGliL2Vycm9ycycpCgpjb25zdCBpc1dpbmRvd3MgPSBCYXJlLnBsYXRmb3JtID09PSAnd2luMzInCgpleHBvcnRzLmNvbnN0YW50cyA9IGNvbnN0YW50cwoKY2xhc3MgRmlsZVJlcXVlc3QgewogIHN0YXRpYyBfZnJlZSA9IFtdCgogIHN0YXRpYyBib3Jyb3coKSB7CiAgICBpZiAodGhpcy5fZnJlZS5sZW5ndGggPiAwKSByZXR1cm4gdGhpcy5fZnJlZS5wb3AoKQogICAgcmV0dXJuIG5ldyBGaWxlUmVxdWVzdCgpCiAgfQoKICBzdGF0aWMgcmV0dXJuKHJlcSkgewogICAgaWYgKHRoaXMuX2ZyZWUubGVuZ3RoIDwgMzIpIHRoaXMuX2ZyZWUucHVzaChyZXEucmVzZXQoKSkKICAgIGVsc2UgcmVxLmRlc3Ryb3koKQogIH0KCiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLl9yZXNldCgpCiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLnJlcXVlc3RJbml0KHRoaXMsIHRoaXMuX29ucmVzdWx0KQogIH0KCiAgZ2V0IGhhbmRsZSgpIHsKICAgIHJldHVybiB0aGlzLl9oYW5kbGUKICB9CgogIHJldGFpbih2YWx1ZSkgewogICAgdGhpcy5fcmV0YWluID0gdmFsdWUgLy8gVGllIHRoZSBsaWZldGltZSBvZiBgdmFsdWVgIHRvIHRoZSBsaWZldGltZSBvZiBgdGhpc2AKICB9CgogIHJlc2V0KCkgewogICAgaWYgKHRoaXMuX2hhbmRsZSA9PT0gbnVsbCkgcmV0dXJuIHRoaXMKCiAgICBiaW5kaW5nLnJlcXVlc3RSZXNldCh0aGlzLl9oYW5kbGUpCgogICAgdGhpcy5fcmVzZXQoKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuX2hhbmRsZSA9PT0gbnVsbCkgcmV0dXJuIHRoaXMKCiAgICBiaW5kaW5nLnJlcXVlc3REZXN0cm95KHRoaXMuX2hhbmRsZSkKCiAgICB0aGlzLl9yZXNldCgpCiAgICB0aGlzLl9oYW5kbGUgPSBudWxsCgogICAgcmV0dXJuIHRoaXMKICB9CgogIHRoZW4ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICByZXR1cm4gdGhpcy5fcHJvbWlzZS50aGVuKHJlc29sdmUsIHJlamVjdCkKICB9CgogIHJldHVybigpIHsKICAgIGlmICh0aGlzLl9oYW5kbGUgPT09IG51bGwpIHJldHVybiB0aGlzCgogICAgRmlsZVJlcXVlc3QucmV0dXJuKHRoaXMpCgogICAgcmV0dXJuIHRoaXMKICB9CgogIFtTeW1ib2wuZGlzcG9zZV0oKSB7CiAgICB0aGlzLnJldHVybigpCiAgfQoKICBfcmVzZXQoKSB7CiAgICBjb25zdCB7IHByb21pc2UsIHJlc29sdmUsIHJlamVjdCB9ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCkKCiAgICB0aGlzLl9wcm9taXNlID0gcHJvbWlzZQogICAgdGhpcy5fcmVzb2x2ZSA9IHJlc29sdmUKICAgIHRoaXMuX3JlamVjdCA9IHJlamVjdAogICAgdGhpcy5fcmV0YWluID0gbnVsbAogIH0KCiAgX29ucmVzdWx0KGVyciwgc3RhdHVzKSB7CiAgICBpZiAoZXJyKSB0aGlzLl9yZWplY3QoZXJyKQogICAgZWxzZSB0aGlzLl9yZXNvbHZlKHN0YXR1cykKICB9Cn0KCmZ1bmN0aW9uIG9rKHJlc3VsdCwgY2IpIHsKICBpZiAodHlwZW9mIHJlc3VsdCA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSByZXN1bHQKICAgIHJlc3VsdCA9IHVuZGVmaW5lZAogIH0KCiAgaWYgKGNiKSBjYihudWxsLCByZXN1bHQpCiAgZWxzZSByZXR1cm4gcmVzdWx0Cn0KCmZ1bmN0aW9uIGZhaWwoZXJyLCBjYikgewogIGlmIChjYikgY2IoZXJyKQogIGVsc2UgdGhyb3cgZXJyCn0KCmZ1bmN0aW9uIGRvbmUoZXJyLCByZXN1bHQsIGNiKSB7CiAgaWYgKHR5cGVvZiByZXN1bHQgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gcmVzdWx0CiAgICByZXN1bHQgPSB1bmRlZmluZWQKICB9CgogIGlmIChlcnIpIGZhaWwoZXJyLCBjYikKICBlbHNlIHJldHVybiBvayhyZXN1bHQsIGNiKQp9Cgphc3luYyBmdW5jdGlvbiBvcGVuKGZpbGVwYXRoLCBmbGFncyA9ICdyJywgbW9kZSA9IDBvNjY2LCBjYikgewogIGlmICh0eXBlb2YgZmxhZ3MgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gZmxhZ3MKICAgIGZsYWdzID0gJ3InCiAgICBtb2RlID0gMG82NjYKICB9IGVsc2UgaWYgKHR5cGVvZiBtb2RlID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG1vZGUKICAgIG1vZGUgPSAwbzY2NgogIH0KCiAgaWYgKHR5cGVvZiBmbGFncyA9PT0gJ3N0cmluZycpIGZsYWdzID0gdG9GbGFncyhmbGFncykKICBpZiAodHlwZW9mIG1vZGUgPT09ICdzdHJpbmcnKSBtb2RlID0gdG9Nb2RlKG1vZGUpCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGZkCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5vcGVuKHJlcS5oYW5kbGUsIGZpbGVwYXRoLCBmbGFncywgbW9kZSkKCiAgICBmZCA9IGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ29wZW4nLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBmZCwgY2IpCn0KCmZ1bmN0aW9uIG9wZW5TeW5jKGZpbGVwYXRoLCBmbGFncyA9ICdyJywgbW9kZSA9IDBvNjY2KSB7CiAgaWYgKHR5cGVvZiBmbGFncyA9PT0gJ3N0cmluZycpIGZsYWdzID0gdG9GbGFncyhmbGFncykKICBpZiAodHlwZW9mIG1vZGUgPT09ICdzdHJpbmcnKSBtb2RlID0gdG9Nb2RlKG1vZGUpCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIHJldHVybiBiaW5kaW5nLm9wZW5TeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoLCBmbGFncywgbW9kZSkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdvcGVuJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGNsb3NlKGZkLCBjYikgewogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcuY2xvc2UocmVxLmhhbmRsZSwgZmQpCgogICAgYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnY2xvc2UnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiBjbG9zZVN5bmMoZmQpIHsKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5jbG9zZVN5bmMocmVxLmhhbmRsZSwgZmQpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnY2xvc2UnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBhY2Nlc3MoZmlsZXBhdGgsIG1vZGUgPSBjb25zdGFudHMuRl9PSywgY2IpIHsKICBpZiAodHlwZW9mIG1vZGUgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gbW9kZQogICAgbW9kZSA9IGNvbnN0YW50cy5GX09LCiAgfQoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcuYWNjZXNzKHJlcS5oYW5kbGUsIGZpbGVwYXRoLCBtb2RlKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ2FjY2VzcycsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiBhY2Nlc3NTeW5jKGZpbGVwYXRoLCBtb2RlID0gY29uc3RhbnRzLkZfT0spIHsKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLmFjY2Vzc1N5bmMocmVxLmhhbmRsZSwgZmlsZXBhdGgsIG1vZGUpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnYWNjZXNzJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGV4aXN0cyhmaWxlcGF0aCwgY2IpIHsKICBsZXQgb2sgPSB0cnVlCiAgdHJ5IHsKICAgIGF3YWl0IGFjY2VzcyhmaWxlcGF0aCkKICB9IGNhdGNoIHsKICAgIG9rID0gZmFsc2UKICB9CgogIHJldHVybiBkb25lKG51bGwsIG9rLCBjYikKfQoKZnVuY3Rpb24gZXhpc3RzU3luYyhmaWxlcGF0aCkgewogIHRyeSB7CiAgICBhY2Nlc3NTeW5jKGZpbGVwYXRoKQogIH0gY2F0Y2ggewogICAgcmV0dXJuIGZhbHNlCiAgfQoKICByZXR1cm4gdHJ1ZQp9Cgphc3luYyBmdW5jdGlvbiByZWFkKGZkLCBidWZmZXIsIG9mZnNldCA9IDAsIGxlbiA9IGJ1ZmZlci5ieXRlTGVuZ3RoIC0gb2Zmc2V0LCBwb3MgPSAtMSwgY2IpIHsKICBpZiAodHlwZW9mIG9mZnNldCA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvZmZzZXQKICAgIG9mZnNldCA9IDAKICAgIGxlbiA9IGJ1ZmZlci5ieXRlTGVuZ3RoCiAgICBwb3MgPSAtMQogIH0gZWxzZSBpZiAodHlwZW9mIGxlbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBsZW4KICAgIGxlbiA9IGJ1ZmZlci5ieXRlTGVuZ3RoIC0gb2Zmc2V0CiAgICBwb3MgPSAtMQogIH0gZWxzZSBpZiAodHlwZW9mIHBvcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBwb3MKICAgIHBvcyA9IC0xCiAgfQoKICBpZiAodHlwZW9mIHBvcyAhPT0gJ251bWJlcicpIHBvcyA9IC0xCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBieXRlcwogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcucmVhZChyZXEuaGFuZGxlLCBmZCwgYnVmZmVyLCBvZmZzZXQsIGxlbiwgcG9zKQoKICAgIGJ5dGVzID0gYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAncmVhZCcsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgYnl0ZXMsIGNiKQp9CgpmdW5jdGlvbiByZWFkU3luYyhmZCwgYnVmZmVyLCBvZmZzZXQgPSAwLCBsZW4gPSBidWZmZXIuYnl0ZUxlbmd0aCAtIG9mZnNldCwgcG9zID0gLTEpIHsKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgcmV0dXJuIGJpbmRpbmcucmVhZFN5bmMocmVxLmhhbmRsZSwgZmQsIGJ1ZmZlciwgb2Zmc2V0LCBsZW4sIHBvcykKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdyZWFkJywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcmVhZHYoZmQsIGJ1ZmZlcnMsIHBvcyA9IC0xLCBjYikgewogIGlmICh0eXBlb2YgcG9zID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IHBvcwogICAgcG9zID0gLTEKICB9CgogIGlmICh0eXBlb2YgcG9zICE9PSAnbnVtYmVyJykgcG9zID0gLTEKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGJ5dGVzCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5yZWFkdihyZXEuaGFuZGxlLCBmZCwgYnVmZmVycywgcG9zKQoKICAgIGJ5dGVzID0gYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAncmVhZHYnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGJ5dGVzLCBjYikKfQoKZnVuY3Rpb24gcmVhZHZTeW5jKGZkLCBidWZmZXJzLCBwb3MgPSAtMSkgewogIGlmICh0eXBlb2YgcG9zICE9PSAnbnVtYmVyJykgcG9zID0gLTEKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIHJldHVybiBiaW5kaW5nLnJlYWR2U3luYyhyZXEuaGFuZGxlLCBmZCwgYnVmZmVycywgcG9zKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ3JlYWR2JywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gd3JpdGUoZmQsIGRhdGEsIG9mZnNldCA9IDAsIGxlbiwgcG9zID0gLTEsIGNiKSB7CiAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgbGV0IGVuY29kaW5nID0gbGVuCiAgICBjYiA9IHBvcwogICAgcG9zID0gb2Zmc2V0CgogICAgaWYgKHR5cGVvZiBwb3MgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSBwb3MKICAgICAgcG9zID0gLTEKICAgICAgZW5jb2RpbmcgPSAndXRmOCcKICAgIH0gZWxzZSBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gZW5jb2RpbmcKICAgICAgZW5jb2RpbmcgPSAndXRmOCcKICAgIH0KCiAgICBpZiAodHlwZW9mIHBvcyA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBwb3MKICAgICAgcG9zID0gLTEKICAgIH0KCiAgICBkYXRhID0gQnVmZmVyLmZyb20oZGF0YSwgZW5jb2RpbmcpCiAgICBvZmZzZXQgPSAwCiAgICBsZW4gPSBkYXRhLmJ5dGVMZW5ndGgKICB9IGVsc2UgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb2Zmc2V0CiAgICBvZmZzZXQgPSAwCiAgICBsZW4gPSBkYXRhLmJ5dGVMZW5ndGgKICAgIHBvcyA9IC0xCiAgfSBlbHNlIGlmICh0eXBlb2YgbGVuID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IGxlbgogICAgbGVuID0gZGF0YS5ieXRlTGVuZ3RoIC0gb2Zmc2V0CiAgICBwb3MgPSAtMQogIH0gZWxzZSBpZiAodHlwZW9mIHBvcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBwb3MKICAgIHBvcyA9IC0xCiAgfQoKICBpZiAodHlwZW9mIGxlbiAhPT0gJ251bWJlcicpIGxlbiA9IGRhdGEuYnl0ZUxlbmd0aCAtIG9mZnNldAogIGlmICh0eXBlb2YgcG9zICE9PSAnbnVtYmVyJykgcG9zID0gLTEKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGJ5dGVzCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy53cml0ZShyZXEuaGFuZGxlLCBmZCwgZGF0YSwgb2Zmc2V0LCBsZW4sIHBvcykKCiAgICBieXRlcyA9IGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ3dyaXRlJywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBieXRlcywgY2IpCn0KCmZ1bmN0aW9uIHdyaXRlU3luYyhmZCwgZGF0YSwgb2Zmc2V0ID0gMCwgbGVuLCBwb3MgPSAtMSkgewogIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgIGxldCBlbmNvZGluZyA9IGxlbgogICAgcG9zID0gb2Zmc2V0CgogICAgaWYgKHR5cGVvZiBwb3MgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gcG9zCiAgICAgIHBvcyA9IC0xCiAgICB9CgogICAgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEsIGVuY29kaW5nKQogICAgb2Zmc2V0ID0gMAogICAgbGVuID0gZGF0YS5ieXRlTGVuZ3RoCiAgfQoKICBpZiAodHlwZW9mIGxlbiAhPT0gJ251bWJlcicpIGxlbiA9IGRhdGEuYnl0ZUxlbmd0aCAtIG9mZnNldAogIGlmICh0eXBlb2YgcG9zICE9PSAnbnVtYmVyJykgcG9zID0gLTEKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIHJldHVybiBiaW5kaW5nLndyaXRlU3luYyhyZXEuaGFuZGxlLCBmZCwgZGF0YSwgb2Zmc2V0LCBsZW4sIHBvcykKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICd3cml0ZScsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHdyaXRldihmZCwgYnVmZmVycywgcG9zID0gLTEsIGNiKSB7CiAgaWYgKHR5cGVvZiBwb3MgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gcG9zCiAgICBwb3MgPSAtMQogIH0KCiAgaWYgKHR5cGVvZiBwb3MgIT09ICdudW1iZXInKSBwb3MgPSAtMQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgYnl0ZXMKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLndyaXRldihyZXEuaGFuZGxlLCBmZCwgYnVmZmVycywgcG9zKQoKICAgIGJ5dGVzID0gYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnd3JpdGV2JywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBieXRlcywgY2IpCn0KCmZ1bmN0aW9uIHdyaXRldlN5bmMoZmQsIGJ1ZmZlcnMsIHBvcyA9IC0xKSB7CiAgaWYgKHR5cGVvZiBwb3MgIT09ICdudW1iZXInKSBwb3MgPSAtMQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgcmV0dXJuIGJpbmRpbmcud3JpdGV2U3luYyhyZXEuaGFuZGxlLCBmZCwgYnVmZmVycywgcG9zKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ3dyaXRldicsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHN0YXQoZmlsZXBhdGgsIGNiKSB7CiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgc3QKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnN0YXQocmVxLmhhbmRsZSwgZmlsZXBhdGgpCgogICAgYXdhaXQgcmVxCgogICAgc3QgPSBuZXcgU3RhdHMoLi4uYmluZGluZy5yZXF1ZXN0UmVzdWx0U3RhdChyZXEuaGFuZGxlKSkKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdzdGF0JywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgc3QsIGNiKQp9CgpmdW5jdGlvbiBzdGF0U3luYyhmaWxlcGF0aCkgewogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcuc3RhdFN5bmMocmVxLmhhbmRsZSwgZmlsZXBhdGgpCgogICAgcmV0dXJuIG5ldyBTdGF0cyguLi5iaW5kaW5nLnJlcXVlc3RSZXN1bHRTdGF0KHJlcS5oYW5kbGUpKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3N0YXQnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gbHN0YXQoZmlsZXBhdGgsIGNiKSB7CiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgc3QKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLmxzdGF0KHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIGF3YWl0IHJlcQoKICAgIHN0ID0gbmV3IFN0YXRzKC4uLmJpbmRpbmcucmVxdWVzdFJlc3VsdFN0YXQocmVxLmhhbmRsZSkpCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnbHN0YXQnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBzdCwgY2IpCn0KCmZ1bmN0aW9uIGxzdGF0U3luYyhmaWxlcGF0aCkgewogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcubHN0YXRTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIHJldHVybiBuZXcgU3RhdHMoLi4uYmluZGluZy5yZXF1ZXN0UmVzdWx0U3RhdChyZXEuaGFuZGxlKSkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdsc3RhdCcsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBmc3RhdChmZCwgY2IpIHsKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgc3QKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLmZzdGF0KHJlcS5oYW5kbGUsIGZkKQoKICAgIGF3YWl0IHJlcQoKICAgIHN0ID0gbmV3IFN0YXRzKC4uLmJpbmRpbmcucmVxdWVzdFJlc3VsdFN0YXQocmVxLmhhbmRsZSkpCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnZnN0YXQnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIHN0LCBjYikKfQoKZnVuY3Rpb24gZnN0YXRTeW5jKGZkKSB7CiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcuZnN0YXRTeW5jKHJlcS5oYW5kbGUsIGZkKQoKICAgIHJldHVybiBuZXcgU3RhdHMoLi4uYmluZGluZy5yZXF1ZXN0UmVzdWx0U3RhdChyZXEuaGFuZGxlKSkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdmc3RhdCcsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGZ0cnVuY2F0ZShmZCwgbGVuID0gMCwgY2IpIHsKICBpZiAodHlwZW9mIGxlbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBsZW4KICAgIGxlbiA9IDAKICB9CgogIGlmICh0eXBlb2YgbGVuICE9PSAnbnVtYmVyJykgbGVuID0gMAoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLmZ0cnVuY2F0ZShyZXEuaGFuZGxlLCBmZCwgbGVuKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ2Z0cnVuY2F0ZScsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIGZ0cnVuY2F0ZVN5bmMoZmQsIGxlbiA9IDApIHsKICBpZiAodHlwZW9mIGxlbiAhPT0gJ251bWJlcicpIGxlbiA9IDAKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcuZnRydW5jYXRlU3luYyhyZXEuaGFuZGxlLCBmZCwgbGVuKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ2Z0cnVuY2F0ZScsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGNobW9kKGZpbGVwYXRoLCBtb2RlLCBjYikgewogIGlmICh0eXBlb2YgbW9kZSA9PT0gJ3N0cmluZycpIG1vZGUgPSB0b01vZGUobW9kZSkKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLmNobW9kKHJlcS5oYW5kbGUsIGZpbGVwYXRoLCBtb2RlKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ2NobW9kJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIGNobW9kU3luYyhmaWxlcGF0aCwgbW9kZSkgewogIGlmICh0eXBlb2YgbW9kZSA9PT0gJ3N0cmluZycpIG1vZGUgPSB0b01vZGUobW9kZSkKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5jaG1vZFN5bmMocmVxLmhhbmRsZSwgZmlsZXBhdGgsIG1vZGUpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnY2htb2QnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZmNobW9kKGZkLCBtb2RlLCBjYikgewogIGlmICh0eXBlb2YgbW9kZSA9PT0gJ3N0cmluZycpIG1vZGUgPSB0b01vZGUobW9kZSkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5mY2htb2QocmVxLmhhbmRsZSwgZmQsIG1vZGUpCgogICAgYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnZmNobW9kJywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gZmNobW9kU3luYyhmZCwgbW9kZSkgewogIGlmICh0eXBlb2YgbW9kZSA9PT0gJ3N0cmluZycpIG1vZGUgPSB0b01vZGUobW9kZSkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcuZmNobW9kU3luYyhyZXEuaGFuZGxlLCBmZCwgbW9kZSkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdmY2htb2QnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiB1dGltZXMoZmlsZXBhdGgsIGF0aW1lLCBtdGltZSwgY2IpIHsKICBpZiAodHlwZW9mIGF0aW1lICE9PSAnbnVtYmVyJykgYXRpbWUgPSBhdGltZS5nZXRUaW1lKCkgLyAxMDAwCiAgaWYgKHR5cGVvZiBtdGltZSAhPT0gJ251bWJlcicpIG10aW1lID0gbXRpbWUuZ2V0VGltZSgpIC8gMTAwMAoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcudXRpbWVzKHJlcS5oYW5kbGUsIGZpbGVwYXRoLCBhdGltZSwgbXRpbWUpCgogICAgYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAndXRpbWVzJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIHV0aW1lc1N5bmMoZmlsZXBhdGgsIGF0aW1lLCBtdGltZSkgewogIGlmICh0eXBlb2YgYXRpbWUgIT09ICdudW1iZXInKSBhdGltZSA9IGF0aW1lLmdldFRpbWUoKSAvIDEwMDAKICBpZiAodHlwZW9mIG10aW1lICE9PSAnbnVtYmVyJykgbXRpbWUgPSBtdGltZS5nZXRUaW1lKCkgLyAxMDAwCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcudXRpbWVzU3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCwgYXRpbWUsIG10aW1lKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3V0aW1lcycsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBta2RpcihmaWxlcGF0aCwgb3B0cywgY2IpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb3B0cwogICAgb3B0cyA9IHsgbW9kZTogMG83NzcgfQogIH0KCiAgaWYgKHR5cGVvZiBvcHRzID09PSAnbnVtYmVyJykgb3B0cyA9IHsgbW9kZTogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBjb25zdCBtb2RlID0gdHlwZW9mIG9wdHMubW9kZSA9PT0gJ251bWJlcicgPyBvcHRzLm1vZGUgOiAwbzc3NwoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIGlmIChvcHRzLnJlY3Vyc2l2ZSkgewogICAgbGV0IGVyciA9IG51bGwKICAgIHRyeSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgbWtkaXIoZmlsZXBhdGgsIHsgbW9kZSB9KQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBpZiAoZXJyLmNvZGUgIT09ICdFTk9FTlQnKSB7CiAgICAgICAgICBpZiAoIShhd2FpdCBzdGF0KGZpbGVwYXRoKSkuaXNEaXJlY3RvcnkoKSkgdGhyb3cgZXJyCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdoaWxlIChmaWxlcGF0aC5lbmRzV2l0aChwYXRoLnNlcCkpIGZpbGVwYXRoID0gZmlsZXBhdGguc2xpY2UoMCwgLTEpCiAgICAgICAgICBjb25zdCBpID0gZmlsZXBhdGgubGFzdEluZGV4T2YocGF0aC5zZXApCiAgICAgICAgICBpZiAoaSA8PSAwKSB0aHJvdyBlcnIKCiAgICAgICAgICBhd2FpdCBta2RpcihmaWxlcGF0aC5zbGljZSgwLCBpKSwgeyBtb2RlLCByZWN1cnNpdmU6IHRydWUgfSkKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCBta2RpcihmaWxlcGF0aCwgeyBtb2RlIH0pCiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgaWYgKCEoYXdhaXQgc3RhdChmaWxlcGF0aCkpLmlzRGlyZWN0b3J5KCkpIHRocm93IGVycgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnIgPSBlCiAgICB9CgogICAgcmV0dXJuIGRvbmUoZXJyLCBjYikKICB9CgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcubWtkaXIocmVxLmhhbmRsZSwgZmlsZXBhdGgsIG1vZGUpCgogICAgYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnbWtkaXInLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gbWtkaXJTeW5jKGZpbGVwYXRoLCBvcHRzKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnbnVtYmVyJykgb3B0cyA9IHsgbW9kZTogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBjb25zdCBtb2RlID0gdHlwZW9mIG9wdHMubW9kZSA9PT0gJ251bWJlcicgPyBvcHRzLm1vZGUgOiAwbzc3NwoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIGlmIChvcHRzLnJlY3Vyc2l2ZSkgewogICAgdHJ5IHsKICAgICAgbWtkaXJTeW5jKGZpbGVwYXRoLCB7IG1vZGUgfSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAoZXJyLmNvZGUgIT09ICdFTk9FTlQnKSB7CiAgICAgICAgaWYgKCFzdGF0U3luYyhmaWxlcGF0aCkuaXNEaXJlY3RvcnkoKSkgdGhyb3cgZXJyCiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2hpbGUgKGZpbGVwYXRoLmVuZHNXaXRoKHBhdGguc2VwKSkgZmlsZXBhdGggPSBmaWxlcGF0aC5zbGljZSgwLCAtMSkKICAgICAgICBjb25zdCBpID0gZmlsZXBhdGgubGFzdEluZGV4T2YocGF0aC5zZXApCiAgICAgICAgaWYgKGkgPD0gMCkgdGhyb3cgZXJyCgogICAgICAgIG1rZGlyU3luYyhmaWxlcGF0aC5zbGljZSgwLCBpKSwgeyBtb2RlLCByZWN1cnNpdmU6IHRydWUgfSkKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIG1rZGlyU3luYyhmaWxlcGF0aCwgeyBtb2RlIH0pCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBpZiAoIXN0YXRTeW5jKGZpbGVwYXRoKS5pc0RpcmVjdG9yeSgpKSB0aHJvdyBlcnIKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4KICB9CgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLm1rZGlyU3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCwgbW9kZSkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdta2RpcicsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBybWRpcihmaWxlcGF0aCwgY2IpIHsKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcucm1kaXIocmVxLmhhbmRsZSwgZmlsZXBhdGgpCgogICAgYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAncm1kaXInLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gcm1kaXJTeW5jKGZpbGVwYXRoKSB7CiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5ybWRpclN5bmMocmVxLmhhbmRsZSwgZmlsZXBhdGgpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAncm1kaXInLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcm0oZmlsZXBhdGgsIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7fQogIH0KCiAgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBjb25zdCBzdCA9IGF3YWl0IGxzdGF0KGZpbGVwYXRoKQoKICAgIGlmIChzdC5pc0RpcmVjdG9yeSgpKSB7CiAgICAgIGlmIChvcHRzLnJlY3Vyc2l2ZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBhd2FpdCBybWRpcihmaWxlcGF0aCkKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIGlmIChlcnIuY29kZSAhPT0gJ0VOT1RFTVBUWScpIHRocm93IGVycgoKICAgICAgICAgIGNvbnN0IGZpbGVzID0gYXdhaXQgcmVhZGRpcihmaWxlcGF0aCkKCiAgICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHsKICAgICAgICAgICAgYXdhaXQgcm0oZmlsZXBhdGggKyBwYXRoLnNlcCArIGZpbGUsIG9wdHMpCiAgICAgICAgICB9CgogICAgICAgICAgYXdhaXQgcm1kaXIoZmlsZXBhdGgpCiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBGaWxlRXJyb3IoJ2lzIGEgZGlyZWN0b3J5JywgewogICAgICAgICAgb3BlcmF0aW9uOiAncm0nLAogICAgICAgICAgY29kZTogJ0VJU0RJUicsCiAgICAgICAgICBwYXRoOiBmaWxlcGF0aAogICAgICAgIH0pCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGF3YWl0IHVubGluayhmaWxlcGF0aCkKICAgIH0KICB9IGNhdGNoIChlKSB7CiAgICBpZiAoZS5jb2RlICE9PSAnRU5PRU5UJyB8fCAhb3B0cy5mb3JjZSkgZXJyID0gZQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gcm1TeW5jKGZpbGVwYXRoLCBvcHRzKSB7CiAgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB0cnkgewogICAgY29uc3Qgc3QgPSBsc3RhdFN5bmMoZmlsZXBhdGgpCgogICAgaWYgKHN0LmlzRGlyZWN0b3J5KCkpIHsKICAgICAgaWYgKG9wdHMucmVjdXJzaXZlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJtZGlyU3luYyhmaWxlcGF0aCkKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIGlmIChlcnIuY29kZSAhPT0gJ0VOT1RFTVBUWScpIHRocm93IGVycgoKICAgICAgICAgIGNvbnN0IGZpbGVzID0gcmVhZGRpclN5bmMoZmlsZXBhdGgpCgogICAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7CiAgICAgICAgICAgIHJtU3luYyhmaWxlcGF0aCArIHBhdGguc2VwICsgZmlsZSwgb3B0cykKICAgICAgICAgIH0KCiAgICAgICAgICBybWRpclN5bmMoZmlsZXBhdGgpCiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBGaWxlRXJyb3IoJ2lzIGEgZGlyZWN0b3J5JywgewogICAgICAgICAgb3BlcmF0aW9uOiAncm0nLAogICAgICAgICAgY29kZTogJ0VJU0RJUicsCiAgICAgICAgICBwYXRoOiBmaWxlcGF0aAogICAgICAgIH0pCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHVubGlua1N5bmMoZmlsZXBhdGgpCiAgICB9CiAgfSBjYXRjaCAoZXJyKSB7CiAgICBpZiAoZXJyLmNvZGUgIT09ICdFTk9FTlQnIHx8ICFvcHRzLmZvcmNlKSB0aHJvdyBlcnIKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHVubGluayhmaWxlcGF0aCwgY2IpIHsKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcudW5saW5rKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3VubGluaycsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiB1bmxpbmtTeW5jKGZpbGVwYXRoKSB7CiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy51bmxpbmtTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3VubGluaycsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiByZW5hbWUoc3JjLCBkc3QsIGNiKSB7CiAgc3JjID0gdG9OYW1lc3BhY2VkUGF0aChzcmMpCiAgZHN0ID0gdG9OYW1lc3BhY2VkUGF0aChkc3QpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcucmVuYW1lKHJlcS5oYW5kbGUsIHNyYywgZHN0KQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3JlbmFtZScsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogc3JjLAogICAgICBkZXN0aW5hdGlvbjogZHN0CiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gcmVuYW1lU3luYyhzcmMsIGRzdCkgewogIHNyYyA9IHRvTmFtZXNwYWNlZFBhdGgoc3JjKQogIGRzdCA9IHRvTmFtZXNwYWNlZFBhdGgoZHN0KQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5yZW5hbWVTeW5jKHJlcS5oYW5kbGUsIHNyYywgZHN0KQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3JlbmFtZScsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogc3JjLAogICAgICBkZXN0aW5hdGlvbjogZHN0CiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gY29weUZpbGUoc3JjLCBkc3QsIG1vZGUgPSAwLCBjYikgewogIGlmICh0eXBlb2YgbW9kZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBtb2RlCiAgICBtb2RlID0gMAogIH0KCiAgc3JjID0gdG9OYW1lc3BhY2VkUGF0aChzcmMpCiAgZHN0ID0gdG9OYW1lc3BhY2VkUGF0aChkc3QpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcuY29weWZpbGUocmVxLmhhbmRsZSwgc3JjLCBkc3QsIG1vZGUpCgogICAgYXdhaXQgcmVxCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnY29weWZpbGUnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IHNyYywKICAgICAgZGVzdGluYXRpb246IGRzdAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIGNvcHlGaWxlU3luYyhzcmMsIGRzdCwgbW9kZSA9IDApIHsKICBzcmMgPSB0b05hbWVzcGFjZWRQYXRoKHNyYykKICBkc3QgPSB0b05hbWVzcGFjZWRQYXRoKGRzdCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcuY29weWZpbGVTeW5jKHJlcS5oYW5kbGUsIHNyYywgZHN0LCBtb2RlKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ2NvcHlmaWxlJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBzcmMsCiAgICAgIGRlc3RpbmF0aW9uOiBkc3QKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBjcChzcmMsIGRzdCwgb3B0cywgY2IpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb3B0cwogICAgb3B0cyA9IHt9CiAgfQoKICBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBzcmMgPSB0b05hbWVzcGFjZWRQYXRoKHNyYykKICBkc3QgPSB0b05hbWVzcGFjZWRQYXRoKGRzdCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgY29uc3Qgc3QgPSBhd2FpdCBsc3RhdChzcmMpCgogICAgaWYgKHN0LmlzRGlyZWN0b3J5KCkpIHsKICAgICAgaWYgKG9wdHMucmVjdXJzaXZlICE9PSB0cnVlKSB7CiAgICAgICAgdGhyb3cgbmV3IEZpbGVFcnJvcignaXMgYSBkaXJlY3RvcnknLCB7CiAgICAgICAgICBvcGVyYXRpb246ICdjcCcsCiAgICAgICAgICBjb2RlOiAnRUlTRElSJywKICAgICAgICAgIHBhdGg6IHNyYwogICAgICAgIH0pCiAgICAgIH0KCiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgbHN0YXQoZHN0KQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaWYgKGUuY29kZSA9PT0gJ0VOT0VOVCcpIHsKICAgICAgICAgIGF3YWl0IG1rZGlyKGRzdCwgeyBtb2RlOiBzdC5tb2RlLCByZWN1cnNpdmU6IHRydWUgfSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgZQogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgZGlyID0gYXdhaXQgb3BlbmRpcihzcmMpCiAgICAgIGZvciBhd2FpdCAoY29uc3QgeyBuYW1lIH0gb2YgZGlyKSB7CiAgICAgICAgYXdhaXQgY3AocGF0aC5qb2luKHNyYywgbmFtZSksIHBhdGguam9pbihkc3QsIG5hbWUpLCBvcHRzKQogICAgICB9CiAgICB9IGVsc2UgaWYgKHN0LmlzRmlsZSgpKSB7CiAgICAgIGF3YWl0IGNvcHlGaWxlKHNyYywgZHN0KQogICAgICBhd2FpdCBjaG1vZChkc3QsIHN0Lm1vZGUpCiAgICB9CiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gZQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKYXN5bmMgZnVuY3Rpb24gcmVhbHBhdGgoZmlsZXBhdGgsIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7fQogIH0KCiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgeyBlbmNvZGluZyA9ICd1dGY4JyB9ID0gb3B0cwoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCByZXMKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnJlYWxwYXRoKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIGF3YWl0IHJlcQoKICAgIHJlcyA9IEJ1ZmZlci5mcm9tKGJpbmRpbmcucmVxdWVzdFJlc3VsdFN0cmluZyhyZXEuaGFuZGxlKSkKCiAgICBpZiAoZW5jb2RpbmcgIT09ICdidWZmZXInKSByZXMgPSByZXMudG9TdHJpbmcoZW5jb2RpbmcpCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAncmVhbHBhdGgnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCByZXMsIGNiKQp9CgpmdW5jdGlvbiByZWFscGF0aFN5bmMoZmlsZXBhdGgsIG9wdHMpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBjb25zdCB7IGVuY29kaW5nID0gJ3V0ZjgnIH0gPSBvcHRzCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcucmVhbHBhdGhTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIGxldCByZXMgPSBCdWZmZXIuZnJvbShiaW5kaW5nLnJlcXVlc3RSZXN1bHRTdHJpbmcocmVxLmhhbmRsZSkpCgogICAgaWYgKGVuY29kaW5nICE9PSAnYnVmZmVyJykgcmVzID0gcmVzLnRvU3RyaW5nKGVuY29kaW5nKQoKICAgIHJldHVybiByZXMKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdyZWFscGF0aCcsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiByZWFkbGluayhmaWxlcGF0aCwgb3B0cywgY2IpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb3B0cwogICAgb3B0cyA9IHt9CiAgfQoKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBjb25zdCB7IGVuY29kaW5nID0gJ3V0ZjgnIH0gPSBvcHRzCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IHJlcwogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcucmVhZGxpbmsocmVxLmhhbmRsZSwgZmlsZXBhdGgpCgogICAgYXdhaXQgcmVxCgogICAgcmVzID0gQnVmZmVyLmZyb20oYmluZGluZy5yZXF1ZXN0UmVzdWx0U3RyaW5nKHJlcS5oYW5kbGUpKQoKICAgIGlmIChlbmNvZGluZyAhPT0gJ2J1ZmZlcicpIHJlcyA9IHJlcy50b1N0cmluZyhlbmNvZGluZykKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdyZWFkbGluaycsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIHJlcywgY2IpCn0KCmZ1bmN0aW9uIHJlYWRsaW5rU3luYyhmaWxlcGF0aCwgb3B0cykgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGNvbnN0IHsgZW5jb2RpbmcgPSAndXRmOCcgfSA9IG9wdHMKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5yZWFkbGlua1N5bmMocmVxLmhhbmRsZSwgZmlsZXBhdGgpCgogICAgbGV0IHJlcyA9IEJ1ZmZlci5mcm9tKGJpbmRpbmcucmVxdWVzdFJlc3VsdFN0cmluZyhyZXEuaGFuZGxlKSkKCiAgICBpZiAoZW5jb2RpbmcgIT09ICdidWZmZXInKSByZXMgPSByZXMudG9TdHJpbmcoZW5jb2RpbmcpCgogICAgcmV0dXJuIHJlcwogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3JlYWRsaW5rJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZVN5bWxpbmtUYXJnZXQodGFyZ2V0LCB0eXBlLCBmaWxlcGF0aCkgewogIGlmIChpc1dpbmRvd3MpIHsKICAgIGlmICh0eXBlID09PSAnanVuY3Rpb24nKSB0YXJnZXQgPSBwYXRoLnJlc29sdmUoZmlsZXBhdGgsICcuLicsIHRhcmdldCkKCiAgICBpZiAocGF0aC5pc0Fic29sdXRlKHRhcmdldCkpIHJldHVybiBwYXRoLnRvTmFtZXNwYWNlZFBhdGgodGFyZ2V0KQoKICAgIHJldHVybiB0YXJnZXQucmVwbGFjZSgvXC8vZywgcGF0aC5zZXApCiAgfQoKICByZXR1cm4gdGFyZ2V0Cn0KCmFzeW5jIGZ1bmN0aW9uIHN5bWxpbmsodGFyZ2V0LCBmaWxlcGF0aCwgdHlwZSwgY2IpIHsKICBpZiAodHlwZW9mIHR5cGUgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gdHlwZQogICAgdHlwZSA9IG51bGwKICB9CgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgaWYgKHR5cGVvZiB0eXBlID09PSAnc3RyaW5nJykgewogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgJ2ZpbGUnOgogICAgICBkZWZhdWx0OgogICAgICAgIHR5cGUgPSAwCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAnZGlyJzoKICAgICAgICB0eXBlID0gY29uc3RhbnRzLlVWX0ZTX1NZTUxJTktfRElSCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAnanVuY3Rpb24nOgogICAgICAgIHR5cGUgPSBjb25zdGFudHMuVVZfRlNfU1lNTElOS19KVU5DVElPTgogICAgICAgIGJyZWFrCiAgICB9CiAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSAhPT0gJ251bWJlcicpIHsKICAgIGlmIChpc1dpbmRvd3MpIHsKICAgICAgdGFyZ2V0ID0gcGF0aC5yZXNvbHZlKGZpbGVwYXRoLCAnLi4nLCB0YXJnZXQpCgogICAgICB0cnkgewogICAgICAgIHR5cGUgPSAoYXdhaXQgc3RhdCh0YXJnZXQpKS5pc0RpcmVjdG9yeSgpCiAgICAgICAgICA/IGNvbnN0YW50cy5VVl9GU19TWU1MSU5LX0RJUgogICAgICAgICAgOiBjb25zdGFudHMuVVZfRlNfU1lNTElOS19KVU5DVElPTgogICAgICB9IGNhdGNoIHsKICAgICAgICB0eXBlID0gMAogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0eXBlID0gMAogICAgfQogIH0KCiAgdGFyZ2V0ID0gbm9ybWFsaXplU3ltbGlua1RhcmdldCh0YXJnZXQpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcuc3ltbGluayhyZXEuaGFuZGxlLCB0YXJnZXQsIGZpbGVwYXRoLCB0eXBlKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3N5bWxpbmsnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IHRhcmdldCwKICAgICAgZGVzdGluYXRpb246IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gc3ltbGlua1N5bmModGFyZ2V0LCBmaWxlcGF0aCwgdHlwZSkgewogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgaWYgKHR5cGVvZiB0eXBlID09PSAnc3RyaW5nJykgewogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgJ2ZpbGUnOgogICAgICBkZWZhdWx0OgogICAgICAgIHR5cGUgPSAwCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAnZGlyJzoKICAgICAgICB0eXBlID0gY29uc3RhbnRzLlVWX0ZTX1NZTUxJTktfRElSCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAnanVuY3Rpb24nOgogICAgICAgIHR5cGUgPSBjb25zdGFudHMuVVZfRlNfU1lNTElOS19KVU5DVElPTgogICAgICAgIGJyZWFrCiAgICB9CiAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSAhPT0gJ251bWJlcicpIHsKICAgIGlmIChpc1dpbmRvd3MpIHsKICAgICAgdGFyZ2V0ID0gcGF0aC5yZXNvbHZlKGZpbGVwYXRoLCAnLi4nLCB0YXJnZXQpCgogICAgICB0cnkgewogICAgICAgIHR5cGUgPSBzdGF0U3luYyh0YXJnZXQpLmlzRGlyZWN0b3J5KCkKICAgICAgICAgID8gY29uc3RhbnRzLlVWX0ZTX1NZTUxJTktfRElSCiAgICAgICAgICA6IGNvbnN0YW50cy5VVl9GU19TWU1MSU5LX0pVTkNUSU9OCiAgICAgIH0gY2F0Y2ggewogICAgICAgIHR5cGUgPSAwCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHR5cGUgPSAwCiAgICB9CiAgfQoKICB0YXJnZXQgPSBub3JtYWxpemVTeW1saW5rVGFyZ2V0KHRhcmdldCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcuc3ltbGlua1N5bmMocmVxLmhhbmRsZSwgdGFyZ2V0LCBmaWxlcGF0aCwgdHlwZSkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdzeW1saW5rJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiB0YXJnZXQsCiAgICAgIGRlc3RpbmF0aW9uOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIG9wZW5kaXIoZmlsZXBhdGgsIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7fQogIH0KCiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZGlyCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5vcGVuZGlyKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIGF3YWl0IHJlcQoKICAgIGRpciA9IG5ldyBEaXIoZmlsZXBhdGgsIGJpbmRpbmcucmVxdWVzdFJlc3VsdERpcihyZXEuaGFuZGxlKSwgb3B0cykKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdvcGVuZGlyJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgZGlyLCBjYikKfQoKZnVuY3Rpb24gb3BlbmRpclN5bmMoZmlsZXBhdGgsIG9wdHMpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLm9wZW5kaXJTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIHJldHVybiBuZXcgRGlyKGZpbGVwYXRoLCBiaW5kaW5nLnJlcXVlc3RSZXN1bHREaXIocmVxLmhhbmRsZSksIG9wdHMpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnb3BlbmRpcicsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiByZWFkZGlyKGZpbGVwYXRoLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGNvbnN0IHsgd2l0aEZpbGVUeXBlcyA9IGZhbHNlIH0gPSBvcHRzCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgbGV0IHJlc3VsdCA9IFtdCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgY29uc3QgZGlyID0gYXdhaXQgb3BlbmRpcihmaWxlcGF0aCkKCiAgICBmb3IgYXdhaXQgKGNvbnN0IGVudHJ5IG9mIGRpcikgewogICAgICByZXN1bHQucHVzaCh3aXRoRmlsZVR5cGVzID8gZW50cnkgOiBlbnRyeS5uYW1lKQogICAgfQogIH0gY2F0Y2ggKGUpIHsKICAgIHJlc3VsdCA9IFtdCiAgICBlcnIgPSBlCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIHJlc3VsdCwgY2IpCn0KCmZ1bmN0aW9uIHJlYWRkaXJTeW5jKGZpbGVwYXRoLCBvcHRzKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgeyB3aXRoRmlsZVR5cGVzID0gZmFsc2UgfSA9IG9wdHMKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICBjb25zdCBkaXIgPSBvcGVuZGlyU3luYyhmaWxlcGF0aCwgb3B0cykKICBjb25zdCByZXN1bHQgPSBbXQoKICBmb3IgKGNvbnN0IGVudHJ5IG9mIGRpcikgewogICAgcmVzdWx0LnB1c2god2l0aEZpbGVUeXBlcyA/IGVudHJ5IDogZW50cnkubmFtZSkKICB9CgogIHJldHVybiByZXN1bHQKfQoKYXN5bmMgZnVuY3Rpb24gcmVhZEZpbGUoZmlsZXBhdGgsIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7fQogIH0KCiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgeyBlbmNvZGluZyA9ICdidWZmZXInIH0gPSBvcHRzCgogIGxldCBmZCA9IC0xCiAgbGV0IGJ1ZmZlciA9IG51bGwKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBmZCA9IGF3YWl0IG9wZW4oZmlsZXBhdGgsIG9wdHMuZmxhZyB8fCAncicpCgogICAgY29uc3Qgc3QgPSBhd2FpdCBmc3RhdChmZCkKCiAgICBsZXQgbGVuID0gMAoKICAgIGlmIChzdC5zaXplID09PSAwKSB7CiAgICAgIGNvbnN0IGJ1ZmZlcnMgPSBbXQoKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBidWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUoODE5MikKICAgICAgICBjb25zdCByID0gYXdhaXQgcmVhZChmZCwgYnVmZmVyKQogICAgICAgIGxlbiArPSByCiAgICAgICAgaWYgKHIgPT09IDApIGJyZWFrCiAgICAgICAgYnVmZmVycy5wdXNoKGJ1ZmZlci5zdWJhcnJheSgwLCByKSkKICAgICAgfQoKICAgICAgYnVmZmVyID0gQnVmZmVyLmNvbmNhdChidWZmZXJzKQogICAgfSBlbHNlIHsKICAgICAgYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKHN0LnNpemUpCgogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGNvbnN0IHIgPSBhd2FpdCByZWFkKGZkLCBsZW4gPyBidWZmZXIuc3ViYXJyYXkobGVuKSA6IGJ1ZmZlcikKICAgICAgICBsZW4gKz0gcgogICAgICAgIGlmIChyID09PSAwIHx8IGxlbiA9PT0gYnVmZmVyLmJ5dGVMZW5ndGgpIGJyZWFrCiAgICAgIH0KCiAgICAgIGlmIChsZW4gIT09IGJ1ZmZlci5ieXRlTGVuZ3RoKSBidWZmZXIgPSBidWZmZXIuc3ViYXJyYXkoMCwgbGVuKQogICAgfQoKICAgIGlmIChlbmNvZGluZyAhPT0gJ2J1ZmZlcicpIGJ1ZmZlciA9IGJ1ZmZlci50b1N0cmluZyhlbmNvZGluZykKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBlCiAgfSBmaW5hbGx5IHsKICAgIGlmIChmZCAhPT0gLTEpIGF3YWl0IGNsb3NlKGZkKQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBidWZmZXIsIGNiKQp9CgpmdW5jdGlvbiByZWFkRmlsZVN5bmMoZmlsZXBhdGgsIG9wdHMpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBjb25zdCB7IGVuY29kaW5nID0gJ2J1ZmZlcicgfSA9IG9wdHMKCiAgbGV0IGZkID0gLTEKICB0cnkgewogICAgZmQgPSBvcGVuU3luYyhmaWxlcGF0aCwgb3B0cy5mbGFnIHx8ICdyJykKCiAgICBjb25zdCBzdCA9IGZzdGF0U3luYyhmZCkKCiAgICBsZXQgYnVmZmVyCiAgICBsZXQgbGVuID0gMAoKICAgIGlmIChzdC5zaXplID09PSAwKSB7CiAgICAgIGNvbnN0IGJ1ZmZlcnMgPSBbXQoKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBidWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUoODE5MikKICAgICAgICBjb25zdCByID0gcmVhZFN5bmMoZmQsIGJ1ZmZlcikKICAgICAgICBsZW4gKz0gcgogICAgICAgIGlmIChyID09PSAwKSBicmVhawogICAgICAgIGJ1ZmZlcnMucHVzaChidWZmZXIuc3ViYXJyYXkoMCwgcikpCiAgICAgIH0KCiAgICAgIGJ1ZmZlciA9IEJ1ZmZlci5jb25jYXQoYnVmZmVycykKICAgIH0gZWxzZSB7CiAgICAgIGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShzdC5zaXplKQoKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBjb25zdCByID0gcmVhZFN5bmMoZmQsIGxlbiA/IGJ1ZmZlci5zdWJhcnJheShsZW4pIDogYnVmZmVyKQogICAgICAgIGxlbiArPSByCiAgICAgICAgaWYgKHIgPT09IDAgfHwgbGVuID09PSBidWZmZXIuYnl0ZUxlbmd0aCkgYnJlYWsKICAgICAgfQoKICAgICAgaWYgKGxlbiAhPT0gYnVmZmVyLmJ5dGVMZW5ndGgpIGJ1ZmZlciA9IGJ1ZmZlci5zdWJhcnJheSgwLCBsZW4pCiAgICB9CgogICAgaWYgKGVuY29kaW5nICE9PSAnYnVmZmVyJykgYnVmZmVyID0gYnVmZmVyLnRvU3RyaW5nKGVuY29kaW5nKQoKICAgIHJldHVybiBidWZmZXIKICB9IGZpbmFsbHkgewogICAgaWYgKGZkICE9PSAtMSkgY2xvc2VTeW5jKGZkKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gd3JpdGVGaWxlKGZpbGVwYXRoLCBkYXRhLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIGRhdGEgPSBCdWZmZXIuZnJvbShkYXRhLCBvcHRzLmVuY29kaW5nKQoKICBsZXQgZmQgPSAtMQogIGxldCBsZW4gPSAwCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgZmQgPSBhd2FpdCBvcGVuKGZpbGVwYXRoLCBvcHRzLmZsYWcgfHwgJ3cnLCBvcHRzLm1vZGUgfHwgMG82NjYpCgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgbGVuICs9IGF3YWl0IHdyaXRlKGZkLCBsZW4gPyBkYXRhLnN1YmFycmF5KGxlbikgOiBkYXRhKQogICAgICBpZiAobGVuID09PSBkYXRhLmJ5dGVMZW5ndGgpIGJyZWFrCiAgICB9CiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gZQogIH0gZmluYWxseSB7CiAgICBpZiAoZmQgIT09IC0xKSBhd2FpdCBjbG9zZShmZCkKICB9CgogIHJldHVybiBkb25lKGVyciwgbGVuLCBjYikKfQoKZnVuY3Rpb24gd3JpdGVGaWxlU3luYyhmaWxlcGF0aCwgZGF0YSwgb3B0cykgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIGRhdGEgPSBCdWZmZXIuZnJvbShkYXRhLCBvcHRzLmVuY29kaW5nKQoKICBsZXQgZmQgPSAtMQogIHRyeSB7CiAgICBmZCA9IG9wZW5TeW5jKGZpbGVwYXRoLCBvcHRzLmZsYWcgfHwgJ3cnLCBvcHRzLm1vZGUgfHwgMG82NjYpCgogICAgbGV0IGxlbiA9IDAKCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBsZW4gKz0gd3JpdGVTeW5jKGZkLCBsZW4gPyBkYXRhLnN1YmFycmF5KGxlbikgOiBkYXRhKQogICAgICBpZiAobGVuID09PSBkYXRhLmJ5dGVMZW5ndGgpIGJyZWFrCiAgICB9CiAgfSBmaW5hbGx5IHsKICAgIGlmIChmZCAhPT0gLTEpIGNsb3NlU3luYyhmZCkKICB9Cn0KCmZ1bmN0aW9uIGFwcGVuZEZpbGUoZmlsZXBhdGgsIGRhdGEsIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7fQogIH0KCiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgaWYgKCFvcHRzLmZsYWcpIG9wdHMgPSB7IC4uLm9wdHMsIGZsYWc6ICdhJyB9CgogIHJldHVybiB3cml0ZUZpbGUoZmlsZXBhdGgsIGRhdGEsIG9wdHMsIGNiKQp9CgpmdW5jdGlvbiBhcHBlbmRGaWxlU3luYyhmaWxlcGF0aCwgZGF0YSwgb3B0cykgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGlmICghb3B0cy5mbGFnKSBvcHRzID0geyAuLi5vcHRzLCBmbGFnOiAnYScgfQoKICByZXR1cm4gd3JpdGVGaWxlU3luYyhmaWxlcGF0aCwgZGF0YSwgb3B0cykKfQoKZnVuY3Rpb24gd2F0Y2goZmlsZXBhdGgsIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7fQogIH0KCiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICByZXR1cm4gbmV3IFdhdGNoZXIoZmlsZXBhdGgsIG9wdHMsIGNiKQp9CgpjbGFzcyBTdGF0cyB7CiAgY29uc3RydWN0b3IoCiAgICBkZXYsCiAgICBtb2RlLAogICAgbmxpbmssCiAgICB1aWQsCiAgICBnaWQsCiAgICByZGV2LAogICAgYmxrc2l6ZSwKICAgIGlubywKICAgIHNpemUsCiAgICBibG9ja3MsCiAgICBhdGltZU1zLAogICAgbXRpbWVNcywKICAgIGN0aW1lTXMsCiAgICBiaXJ0aHRpbWVNcwogICkgewogICAgdGhpcy5kZXYgPSBkZXYKICAgIHRoaXMubW9kZSA9IG1vZGUKICAgIHRoaXMubmxpbmsgPSBubGluawogICAgdGhpcy51aWQgPSB1aWQKICAgIHRoaXMuZ2lkID0gZ2lkCiAgICB0aGlzLnJkZXYgPSByZGV2CiAgICB0aGlzLmJsa3NpemUgPSBibGtzaXplCiAgICB0aGlzLmlubyA9IGlubwogICAgdGhpcy5zaXplID0gc2l6ZQogICAgdGhpcy5ibG9ja3MgPSBibG9ja3MKICAgIHRoaXMuYXRpbWVNcyA9IGF0aW1lTXMKICAgIHRoaXMubXRpbWVNcyA9IG10aW1lTXMKICAgIHRoaXMuY3RpbWVNcyA9IGN0aW1lTXMKICAgIHRoaXMuYmlydGh0aW1lTXMgPSBiaXJ0aHRpbWVNcwogICAgdGhpcy5hdGltZSA9IG5ldyBEYXRlKGF0aW1lTXMpCiAgICB0aGlzLm10aW1lID0gbmV3IERhdGUobXRpbWVNcykKICAgIHRoaXMuY3RpbWUgPSBuZXcgRGF0ZShjdGltZU1zKQogICAgdGhpcy5iaXJ0aHRpbWUgPSBuZXcgRGF0ZShiaXJ0aHRpbWVNcykKICB9CgogIGlzRGlyZWN0b3J5KCkgewogICAgcmV0dXJuICh0aGlzLm1vZGUgJiBjb25zdGFudHMuU19JRk1UKSA9PT0gY29uc3RhbnRzLlNfSUZESVIKICB9CgogIGlzRmlsZSgpIHsKICAgIHJldHVybiAodGhpcy5tb2RlICYgY29uc3RhbnRzLlNfSUZNVCkgPT09IGNvbnN0YW50cy5TX0lGUkVHCiAgfQoKICBpc0Jsb2NrRGV2aWNlKCkgewogICAgcmV0dXJuICh0aGlzLm1vZGUgJiBjb25zdGFudHMuU19JRk1UKSA9PT0gY29uc3RhbnRzLlNfSUZCTEsKICB9CgogIGlzQ2hhcmFjdGVyRGV2aWNlKCkgewogICAgcmV0dXJuICh0aGlzLm1vZGUgJiBjb25zdGFudHMuU19JRkNIUikgPT09IGNvbnN0YW50cy5TX0lGQ0hSCiAgfQoKICBpc0ZJRk8oKSB7CiAgICByZXR1cm4gKHRoaXMubW9kZSAmIGNvbnN0YW50cy5TX0lGTVQpID09PSBjb25zdGFudHMuU19JRklGTwogIH0KCiAgaXNTeW1ib2xpY0xpbmsoKSB7CiAgICByZXR1cm4gKHRoaXMubW9kZSAmIGNvbnN0YW50cy5TX0lGTVQpID09PSBjb25zdGFudHMuU19JRkxOSwogIH0KCiAgaXNTb2NrZXQoKSB7CiAgICByZXR1cm4gKHRoaXMubW9kZSAmIGNvbnN0YW50cy5TX0lGTVQpID09PSBjb25zdGFudHMuU19JRlNPQ0sKICB9Cn0KCmNsYXNzIERpciB7CiAgY29uc3RydWN0b3IocGF0aCwgaGFuZGxlLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgZW5jb2RpbmcgPSAndXRmOCcsIGJ1ZmZlclNpemUgPSAzMiB9ID0gb3B0cwoKICAgIHRoaXMucGF0aCA9IHBhdGgKCiAgICB0aGlzLl9lbmNvZGluZyA9IGVuY29kaW5nCiAgICB0aGlzLl9jYXBhY2l0eSA9IGJ1ZmZlclNpemUKICAgIHRoaXMuX2J1ZmZlciA9IG5ldyBGSUZPKCkKICAgIHRoaXMuX2VuZGVkID0gZmFsc2UKICAgIHRoaXMuX2hhbmRsZSA9IGhhbmRsZQogIH0KCiAgYXN5bmMgcmVhZChjYikgewogICAgaWYgKHRoaXMuX2J1ZmZlci5sZW5ndGgpIHJldHVybiBvayh0aGlzLl9idWZmZXIuc2hpZnQoKSwgY2IpCiAgICBpZiAodGhpcy5fZW5kZWQpIHJldHVybiBvayhudWxsLCBjYikKCiAgICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICAgIGxldCBlbnRyaWVzCiAgICBsZXQgZXJyID0gbnVsbAogICAgdHJ5IHsKICAgICAgcmVxLnJldGFpbihiaW5kaW5nLnJlYWRkaXIocmVxLmhhbmRsZSwgdGhpcy5faGFuZGxlLCB0aGlzLl9jYXBhY2l0eSkpCgogICAgICBhd2FpdCByZXEKCiAgICAgIGVudHJpZXMgPSBiaW5kaW5nLnJlcXVlc3RSZXN1bHREaXJlbnRzKHJlcS5oYW5kbGUpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgICAgb3BlcmF0aW9uOiAncmVhZGRpcicsCiAgICAgICAgY29kZTogZS5jb2RlLAogICAgICAgIHBhdGg6IHRoaXMucGF0aAogICAgICB9KQogICAgfQoKICAgIGlmIChlcnIpIHJldHVybiBmYWlsKGVyciwgY2IpCgogICAgaWYgKGVudHJpZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIHRoaXMuX2VuZGVkID0gdHJ1ZQoKICAgICAgcmV0dXJuIG9rKG51bGwsIGNiKQogICAgfQoKICAgIGZvciAoY29uc3QgZW50cnkgb2YgZW50cmllcykgewogICAgICBsZXQgbmFtZSA9IEJ1ZmZlci5mcm9tKGVudHJ5Lm5hbWUpCgogICAgICBpZiAodGhpcy5fZW5jb2RpbmcgIT09ICdidWZmZXInKSBuYW1lID0gbmFtZS50b1N0cmluZyh0aGlzLl9lbmNvZGluZykKCiAgICAgIHRoaXMuX2J1ZmZlci5wdXNoKG5ldyBEaXJlbnQodGhpcy5wYXRoLCBuYW1lLCBlbnRyeS50eXBlKSkKICAgIH0KCiAgICByZXR1cm4gb2sodGhpcy5fYnVmZmVyLnNoaWZ0KCksIGNiKQogIH0KCiAgcmVhZFN5bmMoKSB7CiAgICBpZiAodGhpcy5fYnVmZmVyLmxlbmd0aCkgcmV0dXJuIHRoaXMuX2J1ZmZlci5zaGlmdCgpCiAgICBpZiAodGhpcy5fZW5kZWQpIHJldHVybiBudWxsCgogICAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgICBsZXQgZW50cmllcwogICAgdHJ5IHsKICAgICAgcmVxLnJldGFpbihiaW5kaW5nLnJlYWRkaXJTeW5jKHJlcS5oYW5kbGUsIHRoaXMuX2hhbmRsZSwgdGhpcy5fY2FwYWNpdHkpKQoKICAgICAgZW50cmllcyA9IGJpbmRpbmcucmVxdWVzdFJlc3VsdERpcmVudHMocmVxLmhhbmRsZSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgICBvcGVyYXRpb246ICdyZWFkZGlyJywKICAgICAgICBjb2RlOiBlLmNvZGUsCiAgICAgICAgcGF0aDogdGhpcy5wYXRoCiAgICAgIH0pCiAgICB9CgogICAgaWYgKGVudHJpZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIHRoaXMuX2VuZGVkID0gdHJ1ZQoKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGVudHJpZXMpIHsKICAgICAgbGV0IG5hbWUgPSBCdWZmZXIuZnJvbShlbnRyeS5uYW1lKQoKICAgICAgaWYgKHRoaXMuX2VuY29kaW5nICE9PSAnYnVmZmVyJykgbmFtZSA9IG5hbWUudG9TdHJpbmcodGhpcy5fZW5jb2RpbmcpCgogICAgICB0aGlzLl9idWZmZXIucHVzaChuZXcgRGlyZW50KHRoaXMucGF0aCwgbmFtZSwgZW50cnkudHlwZSkpCiAgICB9CgogICAgcmV0dXJuIHRoaXMuX2J1ZmZlci5zaGlmdCgpCiAgfQoKICBhc3luYyBjbG9zZShjYikgewogICAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgICBsZXQgZXJyID0gbnVsbAogICAgdHJ5IHsKICAgICAgYmluZGluZy5jbG9zZWRpcihyZXEuaGFuZGxlLCB0aGlzLl9oYW5kbGUpCgogICAgICBhd2FpdCByZXEKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgICBvcGVyYXRpb246ICdjbG9zZWRpcicsCiAgICAgICAgY29kZTogZS5jb2RlLAogICAgICAgIHBhdGg6IHRoaXMucGF0aAogICAgICB9KQogICAgfQoKICAgIHRoaXMuX2hhbmRsZSA9IG51bGwKCiAgICByZXR1cm4gZG9uZShlcnIsIGNiKQogIH0KCiAgY2xvc2VTeW5jKCkgewogICAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgICB0cnkgewogICAgICBiaW5kaW5nLmNsb3NlZGlyU3luYyhyZXEuaGFuZGxlLCB0aGlzLl9oYW5kbGUpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgICAgb3BlcmF0aW9uOiAnY2xvc2VkaXInLAogICAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgICBwYXRoOiB0aGlzLnBhdGgKICAgICAgfSkKICAgIH0KCiAgICB0aGlzLl9oYW5kbGUgPSBudWxsCiAgfQoKICBbU3ltYm9sLmRpc3Bvc2VdKCkgewogICAgdGhpcy5jbG9zZVN5bmMoKQogIH0KCiAgYXN5bmMgW1N5bWJvbC5hc3luY0Rpc3Bvc2VdKCkgewogICAgYXdhaXQgdGhpcy5jbG9zZSgpCiAgfQoKICAqW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBjb25zdCBlbnRyeSA9IHRoaXMucmVhZFN5bmMoKQogICAgICBpZiAoZW50cnkgPT09IG51bGwpIGJyZWFrCiAgICAgIHlpZWxkIGVudHJ5CiAgICB9CgogICAgdGhpcy5jbG9zZVN5bmMoKQogIH0KCiAgYXN5bmMgKltTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBjb25zdCBlbnRyeSA9IGF3YWl0IHRoaXMucmVhZCgpCiAgICAgIGlmIChlbnRyeSA9PT0gbnVsbCkgYnJlYWsKICAgICAgeWllbGQgZW50cnkKICAgIH0KCiAgICBhd2FpdCB0aGlzLmNsb3NlKCkKICB9Cn0KCmNsYXNzIERpcmVudCB7CiAgY29uc3RydWN0b3IocGFyZW50UGF0aCwgbmFtZSwgdHlwZSkgewogICAgdGhpcy5wYXJlbnRQYXRoID0gcGFyZW50UGF0aAogICAgdGhpcy5uYW1lID0gbmFtZQogICAgdGhpcy50eXBlID0gdHlwZQogIH0KCiAgaXNGaWxlKCkgewogICAgcmV0dXJuIHRoaXMudHlwZSA9PT0gY29uc3RhbnRzLlVWX0RJUkVOVF9GSUxFCiAgfQoKICBpc0RpcmVjdG9yeSgpIHsKICAgIHJldHVybiB0aGlzLnR5cGUgPT09IGNvbnN0YW50cy5VVl9ESVJFTlRfRElSCiAgfQoKICBpc1N5bWJvbGljTGluaygpIHsKICAgIHJldHVybiB0aGlzLnR5cGUgPT09IGNvbnN0YW50cy5VVl9ESVJFTlRfTElOSwogIH0KCiAgaXNGSUZPKCkgewogICAgcmV0dXJuIHRoaXMudHlwZSA9PT0gY29uc3RhbnRzLlVWX0RJUkVOVF9GSUZPCiAgfQoKICBpc1NvY2tldCgpIHsKICAgIHJldHVybiB0aGlzLnR5cGUgPT09IGNvbnN0YW50cy5VVl9ESVJFTlRfU09DS0VUCiAgfQoKICBpc0NoYXJhY3RlckRldmljZSgpIHsKICAgIHJldHVybiB0aGlzLnR5cGUgPT09IGNvbnN0YW50cy5VVl9ESVJFTlRfQ0hBUgogIH0KCiAgaXNCbG9ja0RldmljZSgpIHsKICAgIHJldHVybiB0aGlzLnR5cGUgPT09IGNvbnN0YW50cy5VVl9ESVJFTlRfQkxPQ0sKICB9Cn0KCmNsYXNzIEZpbGVSZWFkU3RyZWFtIGV4dGVuZHMgUmVhZGFibGUgewogIGNvbnN0cnVjdG9yKHBhdGgsIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyBlYWdlck9wZW4gPSB0cnVlIH0gPSBvcHRzCgogICAgc3VwZXIoeyBlYWdlck9wZW4sIC4uLm9wdHMgfSkKCiAgICB0aGlzLnBhdGggPSBwYXRoCiAgICB0aGlzLmZkID0gdHlwZW9mIG9wdHMuZmQgPT09ICdudW1iZXInID8gb3B0cy5mZCA6IC0xCiAgICB0aGlzLmZsYWdzID0gb3B0cy5mbGFncyB8fCAncicKICAgIHRoaXMubW9kZSA9IG9wdHMubW9kZSB8fCAwbzY2NgoKICAgIHRoaXMuX29mZnNldCA9IG9wdHMuc3RhcnQgfHwgMAogICAgdGhpcy5fbWlzc2luZyA9IDAKCiAgICBpZiAob3B0cy5sZW5ndGgpIHsKICAgICAgdGhpcy5fbWlzc2luZyA9IG9wdHMubGVuZ3RoCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRzLmVuZCA9PT0gJ251bWJlcicpIHsKICAgICAgdGhpcy5fbWlzc2luZyA9IG9wdHMuZW5kIC0gdGhpcy5fb2Zmc2V0ICsgMQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fbWlzc2luZyA9IC0xCiAgICB9CiAgfQoKICBhc3luYyBfb3BlbihjYikgewogICAgbGV0IGVycgoKICAgIGlmICh0aGlzLmZkID09PSAtMSkgewogICAgICBlcnIgPSBudWxsCiAgICAgIHRyeSB7CiAgICAgICAgdGhpcy5mZCA9IGF3YWl0IG9wZW4odGhpcy5wYXRoLCB0aGlzLmZsYWdzLCB0aGlzLm1vZGUpCiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBlcnIgPSBlCiAgICAgIH0KCiAgICAgIGlmIChlcnIpIHJldHVybiBjYihlcnIpCiAgICB9CgogICAgbGV0IHN0CiAgICBlcnIgPSBudWxsCiAgICB0cnkgewogICAgICBzdCA9IGF3YWl0IGZzdGF0KHRoaXMuZmQpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGVyciA9IGUKICAgIH0KCiAgICBpZiAoZXJyKSByZXR1cm4gY2IoZXJyKQoKICAgIGlmICh0aGlzLl9taXNzaW5nID09PSAtMSkgdGhpcy5fbWlzc2luZyA9IHN0LnNpemUKCiAgICBpZiAoc3Quc2l6ZSA8IHRoaXMuX29mZnNldCkgewogICAgICB0aGlzLl9vZmZzZXQgPSBzdC5zaXplCiAgICAgIHRoaXMuX21pc3NpbmcgPSAwCiAgICB9IGVsc2UgaWYgKHN0LnNpemUgPCB0aGlzLl9vZmZzZXQgKyB0aGlzLl9taXNzaW5nKSB7CiAgICAgIHRoaXMuX21pc3NpbmcgPSBzdC5zaXplIC0gdGhpcy5fb2Zmc2V0CiAgICB9CgogICAgY2IobnVsbCkKICB9CgogIGFzeW5jIF9yZWFkKHNpemUpIHsKICAgIGlmICh0aGlzLl9taXNzaW5nIDw9IDApIHJldHVybiB0aGlzLnB1c2gobnVsbCkKCiAgICBjb25zdCBkYXRhID0gQnVmZmVyLmFsbG9jVW5zYWZlKE1hdGgubWluKHRoaXMuX21pc3NpbmcsIHNpemUpKQoKICAgIGxldCBsZW4KICAgIGxldCBlcnIgPSBudWxsCiAgICB0cnkgewogICAgICBsZW4gPSBhd2FpdCByZWFkKHRoaXMuZmQsIGRhdGEsIDAsIGRhdGEuYnl0ZUxlbmd0aCwgdGhpcy5fb2Zmc2V0KQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnIgPSBlCiAgICB9CgogICAgaWYgKGVycikgcmV0dXJuIHRoaXMuZGVzdHJveShlcnIpCgogICAgaWYgKGxlbiA9PT0gMCkgcmV0dXJuIHRoaXMucHVzaChudWxsKQoKICAgIGlmICh0aGlzLl9taXNzaW5nIDwgbGVuKSBsZW4gPSB0aGlzLl9taXNzaW5nCgogICAgdGhpcy5fbWlzc2luZyAtPSBsZW4KICAgIHRoaXMuX29mZnNldCArPSBsZW4KCiAgICB0aGlzLnB1c2goZGF0YS5zdWJhcnJheSgwLCBsZW4pKQogIH0KCiAgYXN5bmMgX2Rlc3Ryb3koZXJyLCBjYikgewogICAgaWYgKHRoaXMuZmQgPT09IC0xKSByZXR1cm4gY2IoZXJyKQoKICAgIGVyciA9IG51bGwKICAgIHRyeSB7CiAgICAgIGF3YWl0IGNsb3NlKHRoaXMuZmQpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGVyciA9IGUKICAgIH0KCiAgICBjYihlcnIpCiAgfQp9CgpjbGFzcyBGaWxlV3JpdGVTdHJlYW0gZXh0ZW5kcyBXcml0YWJsZSB7CiAgY29uc3RydWN0b3IocGF0aCwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IGVhZ2VyT3BlbiA9IHRydWUgfSA9IG9wdHMKCiAgICBzdXBlcih7IGVhZ2VyT3BlbiwgLi4ub3B0cyB9KQoKICAgIHRoaXMucGF0aCA9IHBhdGgKICAgIHRoaXMuZmQgPSB0eXBlb2Ygb3B0cy5mZCA9PT0gJ251bWJlcicgPyBvcHRzLmZkIDogLTEKICAgIHRoaXMuZmxhZ3MgPSBvcHRzLmZsYWdzIHx8ICd3JwogICAgdGhpcy5tb2RlID0gb3B0cy5tb2RlIHx8IDBvNjY2CiAgfQoKICBhc3luYyBfb3BlbihjYikgewogICAgaWYgKHRoaXMuZmQgIT09IC0xKSByZXR1cm4gY2IobnVsbCkKCiAgICBsZXQgZXJyID0gbnVsbAogICAgdHJ5IHsKICAgICAgdGhpcy5mZCA9IGF3YWl0IG9wZW4odGhpcy5wYXRoLCB0aGlzLmZsYWdzLCB0aGlzLm1vZGUpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGVyciA9IGUKICAgIH0KCiAgICBjYihlcnIpCiAgfQoKICBhc3luYyBfd3JpdGV2KGJhdGNoLCBjYikgewogICAgbGV0IGVyciA9IG51bGwKICAgIHRyeSB7CiAgICAgIGF3YWl0IHdyaXRldigKICAgICAgICB0aGlzLmZkLAogICAgICAgIGJhdGNoLm1hcCgoeyBjaHVuayB9KSA9PiBjaHVuaykKICAgICAgKQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnIgPSBlCiAgICB9CgogICAgY2IoZXJyKQogIH0KCiAgYXN5bmMgX2Rlc3Ryb3koZXJyLCBjYikgewogICAgaWYgKHRoaXMuZmQgPT09IC0xKSByZXR1cm4gY2IoZXJyKQoKICAgIGVyciA9IG51bGwKICAgIHRyeSB7CiAgICAgIGF3YWl0IGNsb3NlKHRoaXMuZmQpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGVyciA9IGUKICAgIH0KCiAgICBjYihlcnIpCiAgfQp9CgpjbGFzcyBXYXRjaGVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvcihwYXRoLCBvcHRzLCBvbmNoYW5nZSkgewogICAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIG9uY2hhbmdlID0gb3B0cwogICAgICBvcHRzID0ge30KICAgIH0KCiAgICBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICAgIGNvbnN0IHsgcGVyc2lzdGVudCA9IHRydWUsIHJlY3Vyc2l2ZSA9IGZhbHNlLCBlbmNvZGluZyA9ICd1dGY4JyB9ID0gb3B0cwoKICAgIHN1cGVyKCkKCiAgICB0aGlzLl9jbG9zZWQgPSBmYWxzZQogICAgdGhpcy5fZW5jb2RpbmcgPSBlbmNvZGluZwogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy53YXRjaGVySW5pdChwYXRoLCByZWN1cnNpdmUsIHRoaXMsIHRoaXMuX29uZXZlbnQsIHRoaXMuX29uY2xvc2UpCgogICAgaWYgKCFwZXJzaXN0ZW50KSB0aGlzLnVucmVmKCkKCiAgICBpZiAob25jaGFuZ2UpIHRoaXMub24oJ2NoYW5nZScsIG9uY2hhbmdlKQogIH0KCiAgY2xvc2UoKSB7CiAgICBpZiAodGhpcy5fY2xvc2VkKSByZXR1cm4KICAgIHRoaXMuX2Nsb3NlZCA9IHRydWUKCiAgICBiaW5kaW5nLndhdGNoZXJDbG9zZSh0aGlzLl9oYW5kbGUpCiAgfQoKICByZWYoKSB7CiAgICBpZiAodGhpcy5faGFuZGxlKSBiaW5kaW5nLndhdGNoZXJSZWYodGhpcy5faGFuZGxlKQogICAgcmV0dXJuIHRoaXMKICB9CgogIHVucmVmKCkgewogICAgaWYgKHRoaXMuX2hhbmRsZSkgYmluZGluZy53YXRjaGVyVW5yZWYodGhpcy5faGFuZGxlKQogICAgcmV0dXJuIHRoaXMKICB9CgogIFtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7CiAgICBjb25zdCBidWZmZXIgPSBbXQogICAgbGV0IGRvbmUgPSBmYWxzZQogICAgbGV0IGVycm9yID0gbnVsbAogICAgbGV0IG5leHQgPSBudWxsCgogICAgdGhpcy5vbignY2hhbmdlJywgKGV2ZW50VHlwZSwgZmlsZW5hbWUpID0+IHsKICAgICAgaWYgKG5leHQpIHsKICAgICAgICBuZXh0LnJlc29sdmUoeyBkb25lOiBmYWxzZSwgdmFsdWU6IHsgZXZlbnRUeXBlLCBmaWxlbmFtZSB9IH0pCiAgICAgICAgbmV4dCA9IG51bGwKICAgICAgfSBlbHNlIHsKICAgICAgICBidWZmZXIucHVzaCh7IGV2ZW50VHlwZSwgZmlsZW5hbWUgfSkKICAgICAgfQogICAgfSkKICAgICAgLm9uKCdlcnJvcicsIChlcnIpID0+IHsKICAgICAgICBkb25lID0gdHJ1ZQogICAgICAgIGVycm9yID0gZXJyCgogICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICBuZXh0LnJlamVjdChlcnJvcikKICAgICAgICAgIG5leHQgPSBudWxsCiAgICAgICAgfQogICAgICB9KQogICAgICAub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICAgIGRvbmUgPSB0cnVlCgogICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICBuZXh0LnJlc29sdmUoeyBkb25lIH0pCiAgICAgICAgICBuZXh0ID0gbnVsbAogICAgICAgIH0KICAgICAgfSkKCiAgICByZXR1cm4gewogICAgICBuZXh0OiAoKSA9PgogICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICAgIGlmIChlcnJvcikgcmV0dXJuIHJlamVjdChlcnJvcikKCiAgICAgICAgICBpZiAoYnVmZmVyLmxlbmd0aCkgcmV0dXJuIHJlc29sdmUoeyBkb25lOiBmYWxzZSwgdmFsdWU6IGJ1ZmZlci5zaGlmdCgpIH0pCgogICAgICAgICAgaWYgKGRvbmUpIHJldHVybiByZXNvbHZlKHsgZG9uZSB9KQoKICAgICAgICAgIG5leHQgPSB7IHJlc29sdmUsIHJlamVjdCB9CiAgICAgICAgfSkKICAgIH0KICB9CgogIF9vbmV2ZW50KGVyciwgZXZlbnRzLCBmaWxlbmFtZSkgewogICAgaWYgKGVycikgewogICAgICB0aGlzLmNsb3NlKCkKICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGVycikKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHBhdGggPQogICAgICAgIHRoaXMuX2VuY29kaW5nID09PSAnYnVmZmVyJwogICAgICAgICAgPyBCdWZmZXIuZnJvbShmaWxlbmFtZSkKICAgICAgICAgIDogQnVmZmVyLmZyb20oZmlsZW5hbWUpLnRvU3RyaW5nKHRoaXMuX2VuY29kaW5nKQoKICAgICAgaWYgKGV2ZW50cyAmIGJpbmRpbmcuVVZfUkVOQU1FKSB7CiAgICAgICAgdGhpcy5lbWl0KCdjaGFuZ2UnLCAncmVuYW1lJywgcGF0aCkKICAgICAgfQoKICAgICAgaWYgKGV2ZW50cyAmIGJpbmRpbmcuVVZfQ0hBTkdFKSB7CiAgICAgICAgdGhpcy5lbWl0KCdjaGFuZ2UnLCAnY2hhbmdlJywgcGF0aCkKICAgICAgfQogICAgfQogIH0KCiAgX29uY2xvc2UoKSB7CiAgICB0aGlzLl9oYW5kbGUgPSBudWxsCgogICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgfQp9CgpleHBvcnRzLmFjY2VzcyA9IGFjY2VzcwpleHBvcnRzLmFwcGVuZEZpbGUgPSBhcHBlbmRGaWxlCmV4cG9ydHMuY2htb2QgPSBjaG1vZAovLyBleHBvcnRzLmNob3duID0gY2hvd24gVE9ETwpleHBvcnRzLmNsb3NlID0gY2xvc2UKZXhwb3J0cy5jb3B5RmlsZSA9IGNvcHlGaWxlCmV4cG9ydHMuY3AgPSBjcApleHBvcnRzLmV4aXN0cyA9IGV4aXN0cwpleHBvcnRzLmZjaG1vZCA9IGZjaG1vZAovLyBleHBvcnRzLmZjaG93biA9IGZjaG93biBUT0RPCi8vIGV4cG9ydHMuZmRhdGFzeW5jID0gZmRhdGFzeW5jIFRPRE8KZXhwb3J0cy5mc3RhdCA9IGZzdGF0Ci8vIGV4cG9ydHMuZnN5bmMgPSBmc3luYyBUT0RPCmV4cG9ydHMuZnRydW5jYXRlID0gZnRydW5jYXRlCi8vIGV4cG9ydHMuZnV0aW1lcyA9IGZ1dGltZXMgVE9ETwovLyBleHBvcnRzLmxjaG1vZCA9IGxjaG1vZCBUT0RPCi8vIGV4cG9ydHMubGNob3duID0gbGNob3duIFRPRE8KLy8gZXhwb3J0cy5sdXRpbWVzID0gbHV0aW1lcyBUT0RPCi8vIGV4cG9ydHMubGluayA9IGxpbmsgVE9ETwpleHBvcnRzLmxzdGF0ID0gbHN0YXQKZXhwb3J0cy5ta2RpciA9IG1rZGlyCi8vIGV4cG9ydHMubWtkdGVtcCA9IG1rZHRlbXAgVE9ETwpleHBvcnRzLm9wZW4gPSBvcGVuCmV4cG9ydHMub3BlbmRpciA9IG9wZW5kaXIKZXhwb3J0cy5yZWFkID0gcmVhZApleHBvcnRzLnJlYWRGaWxlID0gcmVhZEZpbGUKZXhwb3J0cy5yZWFkZGlyID0gcmVhZGRpcgpleHBvcnRzLnJlYWRsaW5rID0gcmVhZGxpbmsKZXhwb3J0cy5yZWFkdiA9IHJlYWR2CmV4cG9ydHMucmVhbHBhdGggPSByZWFscGF0aApleHBvcnRzLnJlbmFtZSA9IHJlbmFtZQpleHBvcnRzLnJtID0gcm0KZXhwb3J0cy5ybWRpciA9IHJtZGlyCmV4cG9ydHMuc3RhdCA9IHN0YXQKLy8gZXhwb3J0cy5zdGF0ZnMgPSBzdGF0ZnMgVE9ETwpleHBvcnRzLnN5bWxpbmsgPSBzeW1saW5rCi8vIGV4cG9ydHMudHJ1bmNhdGUgPSB0cnVuY2F0ZSBUT0RPCmV4cG9ydHMudW5saW5rID0gdW5saW5rCmV4cG9ydHMudXRpbWVzID0gdXRpbWVzCmV4cG9ydHMud2F0Y2ggPSB3YXRjaApleHBvcnRzLndyaXRlID0gd3JpdGUKZXhwb3J0cy53cml0ZUZpbGUgPSB3cml0ZUZpbGUKZXhwb3J0cy53cml0ZXYgPSB3cml0ZXYKCmV4cG9ydHMuYWNjZXNzU3luYyA9IGFjY2Vzc1N5bmMKZXhwb3J0cy5hcHBlbmRGaWxlU3luYyA9IGFwcGVuZEZpbGVTeW5jCmV4cG9ydHMuY2htb2RTeW5jID0gY2htb2RTeW5jCi8vIGV4cG9ydHMuY2hvd25TeW5jID0gY2hvd25TeW5jIFRPRE8KZXhwb3J0cy5jbG9zZVN5bmMgPSBjbG9zZVN5bmMKZXhwb3J0cy5jb3B5RmlsZVN5bmMgPSBjb3B5RmlsZVN5bmMKZXhwb3J0cy5leGlzdHNTeW5jID0gZXhpc3RzU3luYwpleHBvcnRzLmZjaG1vZFN5bmMgPSBmY2htb2RTeW5jCi8vIGV4cG9ydHMuZmNob3duU3luYyA9IGZjaG93blN5bmMgVE9ETwovLyBleHBvcnRzLmZkYXRhc3luY1N5bmMgPSBmZGF0YXN5bmNTeW5jIFRPRE8KZXhwb3J0cy5mc3RhdFN5bmMgPSBmc3RhdFN5bmMKLy8gZXhwb3J0cy5mc3luY1N5bmMgPSBmc3luY1N5bmMgVE9ETwpleHBvcnRzLmZ0cnVuY2F0ZVN5bmMgPSBmdHJ1bmNhdGVTeW5jCi8vIGV4cG9ydHMuZnV0aW1lc1N5bmMgPSBmdXRpbWVzU3luYyBUT0RPCi8vIGV4cG9ydHMubGNobW9kU3luYyA9IGxjaG1vZFN5bmMgVE9ETwovLyBleHBvcnRzLmxjaG93blN5bmMgPSBsY2hvd25TeW5jIFRPRE8KLy8gZXhwb3J0cy5sdXRpbWVzU3luYyA9IGx1dGltZXNTeW5jIFRPRE8KLy8gZXhwb3J0cy5saW5rU3luYyA9IGxpbmtTeW5jIFRPRE8KZXhwb3J0cy5sc3RhdFN5bmMgPSBsc3RhdFN5bmMKZXhwb3J0cy5ta2RpclN5bmMgPSBta2RpclN5bmMKLy8gZXhwb3J0cy5ta2R0ZW1wU3luYyA9IG1rZHRlbXBTeW5jIFRPRE8KZXhwb3J0cy5vcGVuU3luYyA9IG9wZW5TeW5jCmV4cG9ydHMub3BlbmRpclN5bmMgPSBvcGVuZGlyU3luYwpleHBvcnRzLnJlYWRGaWxlU3luYyA9IHJlYWRGaWxlU3luYwpleHBvcnRzLnJlYWRTeW5jID0gcmVhZFN5bmMKZXhwb3J0cy5yZWFkZGlyU3luYyA9IHJlYWRkaXJTeW5jCmV4cG9ydHMucmVhZGxpbmtTeW5jID0gcmVhZGxpbmtTeW5jCmV4cG9ydHMucmVhZHZTeW5jID0gcmVhZHZTeW5jCmV4cG9ydHMucmVhbHBhdGhTeW5jID0gcmVhbHBhdGhTeW5jCmV4cG9ydHMucmVuYW1lU3luYyA9IHJlbmFtZVN5bmMKZXhwb3J0cy5ybVN5bmMgPSBybVN5bmMKZXhwb3J0cy5ybWRpclN5bmMgPSBybWRpclN5bmMKZXhwb3J0cy5zdGF0U3luYyA9IHN0YXRTeW5jCi8vIGV4cG9ydHMuc3RhdGZzU3luYyA9IHN0YXRmc1N5bmMgVE9ETwpleHBvcnRzLnN5bWxpbmtTeW5jID0gc3ltbGlua1N5bmMKLy8gZXhwb3J0cy50cnVuY2F0ZVN5bmMgPSB0cnVuY2F0ZVN5bmMgVE9ETwpleHBvcnRzLnVubGlua1N5bmMgPSB1bmxpbmtTeW5jCmV4cG9ydHMudXRpbWVzU3luYyA9IHV0aW1lc1N5bmMKZXhwb3J0cy53cml0ZUZpbGVTeW5jID0gd3JpdGVGaWxlU3luYwpleHBvcnRzLndyaXRlU3luYyA9IHdyaXRlU3luYwpleHBvcnRzLndyaXRldlN5bmMgPSB3cml0ZXZTeW5jCgpleHBvcnRzLnByb21pc2VzID0gcmVxdWlyZSgnLi9wcm9taXNlcycpCgpleHBvcnRzLlN0YXRzID0gU3RhdHMKZXhwb3J0cy5EaXIgPSBEaXIKZXhwb3J0cy5EaXJlbnQgPSBEaXJlbnQKZXhwb3J0cy5XYXRjaGVyID0gV2F0Y2hlcgoKZXhwb3J0cy5SZWFkU3RyZWFtID0gRmlsZVJlYWRTdHJlYW0KCmV4cG9ydHMuY3JlYXRlUmVhZFN0cmVhbSA9IGZ1bmN0aW9uIGNyZWF0ZVJlYWRTdHJlYW0ocGF0aCwgb3B0cykgewogIHJldHVybiBuZXcgRmlsZVJlYWRTdHJlYW0ocGF0aCwgb3B0cykKfQoKZXhwb3J0cy5Xcml0ZVN0cmVhbSA9IEZpbGVXcml0ZVN0cmVhbQoKZXhwb3J0cy5jcmVhdGVXcml0ZVN0cmVhbSA9IGZ1bmN0aW9uIGNyZWF0ZVdyaXRlU3RyZWFtKHBhdGgsIG9wdHMpIHsKICByZXR1cm4gbmV3IEZpbGVXcml0ZVN0cmVhbShwYXRoLCBvcHRzKQp9CgpmdW5jdGlvbiB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKSB7CiAgaWYgKHR5cGVvZiBmaWxlcGF0aCAhPT0gJ3N0cmluZycpIHsKICAgIGlmIChVUkwuaXNVUkwoZmlsZXBhdGgpKSBmaWxlcGF0aCA9IGZpbGVVUkxUb1BhdGgoZmlsZXBhdGgpCiAgICBlbHNlIGZpbGVwYXRoID0gZmlsZXBhdGgudG9TdHJpbmcoKQogIH0KCiAgcmV0dXJuIHBhdGgudG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKfQoKZnVuY3Rpb24gdG9GbGFncyhmbGFncykgewogIHN3aXRjaCAoZmxhZ3MpIHsKICAgIGNhc2UgJ3InOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fUkRPTkxZCiAgICBjYXNlICdycyc6IC8vIEZhbGwgdGhyb3VnaC4KICAgIGNhc2UgJ3NyJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX1JET05MWSB8IGNvbnN0YW50cy5PX1NZTkMKICAgIGNhc2UgJ3IrJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX1JEV1IKICAgIGNhc2UgJ3JzKyc6IC8vIEZhbGwgdGhyb3VnaC4KICAgIGNhc2UgJ3NyKyc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19SRFdSIHwgY29uc3RhbnRzLk9fU1lOQwoKICAgIGNhc2UgJ3cnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fVFJVTkMgfCBjb25zdGFudHMuT19DUkVBVCB8IGNvbnN0YW50cy5PX1dST05MWQogICAgY2FzZSAnd3gnOiAvLyBGYWxsIHRocm91Z2guCiAgICBjYXNlICd4dyc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19UUlVOQyB8IGNvbnN0YW50cy5PX0NSRUFUIHwgY29uc3RhbnRzLk9fV1JPTkxZIHwgY29uc3RhbnRzLk9fRVhDTAoKICAgIGNhc2UgJ3crJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX1RSVU5DIHwgY29uc3RhbnRzLk9fQ1JFQVQgfCBjb25zdGFudHMuT19SRFdSCiAgICBjYXNlICd3eCsnOiAvLyBGYWxsIHRocm91Z2guCiAgICBjYXNlICd4dysnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fVFJVTkMgfCBjb25zdGFudHMuT19DUkVBVCB8IGNvbnN0YW50cy5PX1JEV1IgfCBjb25zdGFudHMuT19FWENMCgogICAgY2FzZSAnYSc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19BUFBFTkQgfCBjb25zdGFudHMuT19DUkVBVCB8IGNvbnN0YW50cy5PX1dST05MWQogICAgY2FzZSAnYXgnOiAvLyBGYWxsIHRocm91Z2guCiAgICBjYXNlICd4YSc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19BUFBFTkQgfCBjb25zdGFudHMuT19DUkVBVCB8IGNvbnN0YW50cy5PX1dST05MWSB8IGNvbnN0YW50cy5PX0VYQ0wKICAgIGNhc2UgJ2FzJzogLy8gRmFsbCB0aHJvdWdoLgogICAgY2FzZSAnc2EnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fQVBQRU5EIHwgY29uc3RhbnRzLk9fQ1JFQVQgfCBjb25zdGFudHMuT19XUk9OTFkgfCBjb25zdGFudHMuT19TWU5DCgogICAgY2FzZSAnYSsnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fQVBQRU5EIHwgY29uc3RhbnRzLk9fQ1JFQVQgfCBjb25zdGFudHMuT19SRFdSCiAgICBjYXNlICdheCsnOiAvLyBGYWxsIHRocm91Z2guCiAgICBjYXNlICd4YSsnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fQVBQRU5EIHwgY29uc3RhbnRzLk9fQ1JFQVQgfCBjb25zdGFudHMuT19SRFdSIHwgY29uc3RhbnRzLk9fRVhDTAogICAgY2FzZSAnYXMrJzogLy8gRmFsbCB0aHJvdWdoLgogICAgY2FzZSAnc2ErJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX0FQUEVORCB8IGNvbnN0YW50cy5PX0NSRUFUIHwgY29uc3RhbnRzLk9fUkRXUiB8IGNvbnN0YW50cy5PX1NZTkMKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiAwCiAgfQp9CgpmdW5jdGlvbiB0b01vZGUobW9kZSkgewogIHJldHVybiBwYXJzZUludChtb2RlLCA4KQp9CmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKCm1vZHVsZS5leHBvcnRzID0gewogIE9fUkRXUjogYmluZGluZy5PX1JEV1IsCiAgT19SRE9OTFk6IGJpbmRpbmcuT19SRE9OTFksCiAgT19XUk9OTFk6IGJpbmRpbmcuT19XUk9OTFksCiAgT19DUkVBVDogYmluZGluZy5PX0NSRUFULAogIE9fVFJVTkM6IGJpbmRpbmcuT19UUlVOQywKICBPX0FQUEVORDogYmluZGluZy5PX0FQUEVORCwKCiAgRl9PSzogYmluZGluZy5GX09LIHx8IDAsCiAgUl9PSzogYmluZGluZy5SX09LIHx8IDAsCiAgV19PSzogYmluZGluZy5XX09LIHx8IDAsCiAgWF9PSzogYmluZGluZy5YX09LIHx8IDAsCgogIFNfSUZNVDogYmluZGluZy5TX0lGTVQsCiAgU19JRlJFRzogYmluZGluZy5TX0lGUkVHLAogIFNfSUZESVI6IGJpbmRpbmcuU19JRkRJUiwKICBTX0lGQ0hSOiBiaW5kaW5nLlNfSUZDSFIsCiAgU19JRkxOSzogYmluZGluZy5TX0lGTE5LLAogIFNfSUZCTEs6IGJpbmRpbmcuU19JRkJMSyB8fCAwLAogIFNfSUZJRk86IGJpbmRpbmcuU19JRklGTyB8fCAwLAogIFNfSUZTT0NLOiBiaW5kaW5nLlNfSUZTT0NLIHx8IDAsCgogIFNfSVJVU1I6IGJpbmRpbmcuU19JUlVTUiB8fCAwLAogIFNfSVdVU1I6IGJpbmRpbmcuU19JV1VTUiB8fCAwLAogIFNfSVhVU1I6IGJpbmRpbmcuU19JWFVTUiB8fCAwLAogIFNfSVJHUlA6IGJpbmRpbmcuU19JUkdSUCB8fCAwLAogIFNfSVdHUlA6IGJpbmRpbmcuU19JV0dSUCB8fCAwLAogIFNfSVhHUlA6IGJpbmRpbmcuU19JWEdSUCB8fCAwLAogIFNfSVJPVEg6IGJpbmRpbmcuU19JUk9USCB8fCAwLAogIFNfSVdPVEg6IGJpbmRpbmcuU19JV09USCB8fCAwLAogIFNfSVhPVEg6IGJpbmRpbmcuU19JWE9USCB8fCAwLAoKICBVVl9ESVJFTlRfVU5LTk9XTjogYmluZGluZy5VVl9ESVJFTlRfVU5LTk9XTiwKICBVVl9ESVJFTlRfRklMRTogYmluZGluZy5VVl9ESVJFTlRfRklMRSwKICBVVl9ESVJFTlRfRElSOiBiaW5kaW5nLlVWX0RJUkVOVF9ESVIsCiAgVVZfRElSRU5UX0xJTks6IGJpbmRpbmcuVVZfRElSRU5UX0xJTkssCiAgVVZfRElSRU5UX0ZJRk86IGJpbmRpbmcuVVZfRElSRU5UX0ZJRk8sCiAgVVZfRElSRU5UX1NPQ0tFVDogYmluZGluZy5VVl9ESVJFTlRfU09DS0VULAogIFVWX0RJUkVOVF9DSEFSOiBiaW5kaW5nLlVWX0RJUkVOVF9DSEFSLAogIFVWX0RJUkVOVF9CTE9DSzogYmluZGluZy5VVl9ESVJFTlRfQkxPQ0ssCgogIENPUFlGSUxFX0VYQ0w6IGJpbmRpbmcuVVZfRlNfQ09QWUZJTEVfRVhDTCwKICBDT1BZRklMRV9GSUNMT05FOiBiaW5kaW5nLlVWX0ZTX0NPUFlGSUxFX0ZJQ0xPTkUsCiAgQ09QWUZJTEVfRklDTE9ORV9GT1JDRTogYmluZGluZy5VVl9GU19DT1BZRklMRV9GSUNMT05FX0ZPUkNFLAogIFVWX0ZTX1NZTUxJTktfRElSOiBiaW5kaW5nLlVWX0ZTX1NZTUxJTktfRElSLAogIFVWX0ZTX1NZTUxJTktfSlVOQ1RJT046IGJpbmRpbmcuVVZfRlNfU1lNTElOS19KVU5DVElPTgp9CmNvbnN0IG9zID0gcmVxdWlyZSgnYmFyZS1vcycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEZpbGVFcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3Rvcihtc2csIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyBjb2RlLCBvcGVyYXRpb24gPSBudWxsLCBwYXRoID0gbnVsbCwgZGVzdGluYXRpb24gPSBudWxsLCBmZCA9IC0xIH0gPSBvcHRzCgogICAgaWYgKG9wZXJhdGlvbiAhPT0gbnVsbCkgbXNnICs9IGRlc2NyaWJlKG9wZXJhdGlvbiwgb3B0cykKCiAgICBzdXBlcihgJHtjb2RlfTogJHttc2d9YCkKCiAgICB0aGlzLmNvZGUgPSBjb2RlCgogICAgaWYgKG9wZXJhdGlvbiAhPT0gbnVsbCkgdGhpcy5vcGVyYXRpb24gPSBvcGVyYXRpb24KICAgIGlmIChwYXRoICE9PSBudWxsKSB0aGlzLnBhdGggPSBwYXRoCiAgICBpZiAoZGVzdGluYXRpb24gIT09IG51bGwpIHRoaXMuZGVzdGluYXRpb24gPSBkZXN0aW5hdGlvbgogICAgaWYgKGZkICE9PSAtMSkgdGhpcy5mZCA9IGZkCiAgfQoKICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiAnRmlsZUVycm9yJwogIH0KCiAgLy8gRm9yIE5vZGUuanMgY29tcGF0aWJpbGl0eQogIGdldCBlcnJubygpIHsKICAgIHJldHVybiBvcy5jb25zdGFudHMuZXJybm9zW3RoaXMuY29kZV0KICB9CgogIC8vIEZvciBOb2RlLmpzIGNvbXBhdGliaWxpdHkKICBnZXQgc3lzY2FsbCgpIHsKICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbgogIH0KCiAgLy8gRm9yIE5vZGUuanMgY29tcGF0aWJpbGl0eQogIGdldCBkZXN0KCkgewogICAgcmV0dXJuIHRoaXMuZGVzdGluYXRpb24KICB9Cn0KCmZ1bmN0aW9uIGRlc2NyaWJlKG9wZXJhdGlvbiwgb3B0cykgewogIGNvbnN0IHsgcGF0aCA9IG51bGwsIGRlc3RpbmF0aW9uID0gbnVsbCwgZmQgPSAtMSB9ID0gb3B0cwoKICBsZXQgcmVzdWx0ID0gYCwgJHtvcGVyYXRpb259YAoKICBpZiAocGF0aCAhPT0gbnVsbCkgewogICAgcmVzdWx0ICs9IGAgJHtKU09OLnN0cmluZ2lmeShwYXRoKX1gCgogICAgaWYgKGRlc3RpbmF0aW9uICE9PSBudWxsKSB7CiAgICAgIHJlc3VsdCArPSBgIC0+ICR7SlNPTi5zdHJpbmdpZnkoZGVzdGluYXRpb24pfWAKICAgIH0KICB9IGVsc2UgaWYgKGZkICE9PSAtMSkgewogICAgcmVzdWx0ICs9IGAgJHtmZH1gCiAgfQoKICByZXR1cm4gcmVzdWx0Cn0KewogICJuYW1lIjogImJhcmUtZnMiLAogICJ2ZXJzaW9uIjogIjQuNS4yIiwKICAiZGVzY3JpcHRpb24iOiAiTmF0aXZlIGZpbGUgc3lzdGVtIG9wZXJhdGlvbnMgZm9yIEphdmFzY3JpcHQiLAogICJleHBvcnRzIjogewogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLiI6IHsKICAgICAgInR5cGVzIjogIi4vaW5kZXguZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vaW5kZXguanMiCiAgICB9LAogICAgIi4vcHJvbWlzZXMiOiB7CiAgICAgICJ0eXBlcyI6ICIuL3Byb21pc2VzLmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL3Byb21pc2VzLmpzIgogICAgfSwKICAgICIuL2NvbnN0YW50cyI6IHsKICAgICAgInR5cGVzIjogIi4vbGliL2NvbnN0YW50cy5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9saWIvY29uc3RhbnRzLmpzIgogICAgfQogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJpbmRleC5kLnRzIiwKICAgICJwcm9taXNlcy5qcyIsCiAgICAicHJvbWlzZXMuZC50cyIsCiAgICAiYmluZGluZy5jIiwKICAgICJiaW5kaW5nLmpzIiwKICAgICJDTWFrZUxpc3RzLnR4dCIsCiAgICAibGliIiwKICAgICJwcmVidWlsZHMiCiAgXSwKICAiYWRkb24iOiB0cnVlLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJhcmUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLWZzLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtZnMvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLWZzI3JlYWRtZSIsCiAgImVuZ2luZXMiOiB7CiAgICAiYmFyZSI6ICI+PTEuMTYuMCIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1ldmVudHMiOiAiXjIuNS40IiwKICAgICJiYXJlLXBhdGgiOiAiXjMuMC4wIiwKICAgICJiYXJlLXN0cmVhbSI6ICJeMi42LjQiLAogICAgImJhcmUtdXJsIjogIl4yLjIuMiIsCiAgICAiZmFzdC1maWZvIjogIl4xLjMuMiIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1idWZmZXIiOiAiXjMuMC4yIiwKICAgICJiYXJlLWNyeXB0byI6ICJeMS4xMS4yIiwKICAgICJicml0dGxlIjogIl4zLjEuMSIsCiAgICAiY21ha2UtYmFyZSI6ICJeMS4xLjciLAogICAgInByZXR0aWVyIjogIl4zLjQuMSIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiCiAgfSwKICAicGVlckRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWJ1ZmZlciI6ICIqIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXNNZXRhIjogewogICAgImJhcmUtYnVmZmVyIjogewogICAgICAib3B0aW9uYWwiOiB0cnVlCiAgICB9CiAgfQp9CmNvbnN0IEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2JhcmUtZXZlbnRzJykKY29uc3QgZnMgPSByZXF1aXJlKCcuJykKCmNsYXNzIEZpbGVIYW5kbGUgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKGZkKSB7CiAgICB0aGlzLmZkID0gZmQKICB9CgogIGFzeW5jIGNsb3NlKCkgewogICAgYXdhaXQgZnMuY2xvc2UoZmQpCgogICAgdGhpcy5mZCA9IC0xCiAgICB0aGlzLmVtaXQoJ2Nsb3NlJykKICB9CgogIGFzeW5jIHJlYWQoYnVmZmVyLCAuLi5hcmdzKSB7CiAgICByZXR1cm4gewogICAgICBieXRlc1JlYWQ6IGF3YWl0IGZzLnJlYWQodGhpcy5mZCwgYnVmZmVyLCAuLi5hcmdzKSwKICAgICAgYnVmZmVyCiAgICB9CiAgfQoKICBhc3luYyByZWFkdihidWZmZXJzLCAuLi5hcmdzKSB7CiAgICByZXR1cm4gewogICAgICBieXRlc1JlYWQ6IGF3YWl0IGZzLnJlYWR2KHRoaXMuZmQsIGJ1ZmZlcnMsIC4uLmFyZ3MpLAogICAgICBidWZmZXJzCiAgICB9CiAgfQoKICBhc3luYyB3cml0ZShidWZmZXIsIC4uLmFyZ3MpIHsKICAgIHJldHVybiB7CiAgICAgIGJ5dGVzV3JpdHRlbjogYXdhaXQgZnMud3JpdGUodGhpcy5mZCwgYnVmZmVyLCAuLi5hcmdzKSwKICAgICAgYnVmZmVyCiAgICB9CiAgfQoKICBhc3luYyB3cml0ZXYoYnVmZmVycywgLi4uYXJncykgewogICAgcmV0dXJuIHsKICAgICAgYnl0ZXNXcml0dGVuOiBhd2FpdCBmcy53cml0ZXYodGhpcy5mZCwgYnVmZmVycywgLi4uYXJncyksCiAgICAgIGJ1ZmZlcnMKICAgIH0KICB9CgogIGFzeW5jIHN0YXQoKSB7CiAgICByZXR1cm4gZnMuZnN0YXQodGhpcy5mZCkKICB9CgogIGFzeW5jIGNobW9kKG1vZGUpIHsKICAgIGF3YWl0IGZzLmZjaG1vZCh0aGlzLmZkLCBtb2RlKQogIH0KCiAgY3JlYXRlUmVhZFN0cmVhbShvcHRzKSB7CiAgICByZXR1cm4gZnMuY3JlYXRlUmVhZFN0cmVhbShudWxsLCB7IC4uLm9wdHMsIGZkOiB0aGlzLmZkIH0pCiAgfQoKICBjcmVhdGVXcml0ZVN0cmVhbShvcHRzKSB7CiAgICByZXR1cm4gZnMuY3JlYXRlV3JpdGVTdHJlYW0obnVsbCwgeyAuLi5vcHRzLCBmZDogdGhpcy5mZCB9KQogIH0KCiAgYXN5bmMgW1N5bWJvbC5hc3luY0Rpc3Bvc2VdKCkgewogICAgYXdhaXQgdGhpcy5jbG9zZSgpCiAgfQp9CgpleHBvcnRzLm9wZW4gPSBhc3luYyBmdW5jdGlvbiBvcGVuKGZpbGVwYXRoLCBmbGFncywgbW9kZSkgewogIHJldHVybiBuZXcgRmlsZUhhbmRsZShhd2FpdCBmcy5vcGVuKGZpbGVwYXRoLCBmbGFncywgbW9kZSkpCn0KCmV4cG9ydHMuYWNjZXNzID0gZnMuYWNjZXNzCmV4cG9ydHMuYXBwZW5kRmlsZSA9IGZzLmFwcGVuZEZpbGUKZXhwb3J0cy5jaG1vZCA9IGZzLmNobW9kCmV4cG9ydHMuY29uc3RhbnRzID0gZnMuY29uc3RhbnRzCmV4cG9ydHMuY29weUZpbGUgPSBmcy5jb3B5RmlsZQpleHBvcnRzLmNwID0gZnMuY3AKZXhwb3J0cy5sc3RhdCA9IGZzLmxzdGF0CmV4cG9ydHMubWtkaXIgPSBmcy5ta2RpcgpleHBvcnRzLm9wZW5kaXIgPSBmcy5vcGVuZGlyCmV4cG9ydHMucmVhZEZpbGUgPSBmcy5yZWFkRmlsZQpleHBvcnRzLnJlYWRkaXIgPSBmcy5yZWFkZGlyCmV4cG9ydHMucmVhZGxpbmsgPSBmcy5yZWFkbGluawpleHBvcnRzLnJlYWxwYXRoID0gZnMucmVhbHBhdGgKZXhwb3J0cy5yZW5hbWUgPSBmcy5yZW5hbWUKZXhwb3J0cy5ybSA9IGZzLnJtCmV4cG9ydHMucm1kaXIgPSBmcy5ybWRpcgpleHBvcnRzLnN0YXQgPSBmcy5zdGF0CmV4cG9ydHMuc3ltbGluayA9IGZzLnN5bWxpbmsKZXhwb3J0cy51bmxpbmsgPSBmcy51bmxpbmsKZXhwb3J0cy51dGltZXMgPSBmcy51dGltZXMKZXhwb3J0cy53YXRjaCA9IGZzLndhdGNoCmV4cG9ydHMud3JpdGVGaWxlID0gZnMud3JpdGVGaWxlCm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZS5hZGRvbigpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuL2JpbmRpbmcnKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuL2xpYi9lcnJvcnMnKQpjb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2xpYi9jb25zdGFudHMnKQoKZXhwb3J0cy5jb25zdGFudHMgPSBjb25zdGFudHMKCmV4cG9ydHMuRU9MID0gYmluZGluZy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJyA/ICdcclxuJyA6ICdcbicKCmV4cG9ydHMucGxhdGZvcm0gPSBmdW5jdGlvbiBwbGF0Zm9ybSgpIHsKICByZXR1cm4gYmluZGluZy5wbGF0Zm9ybQp9CgpleHBvcnRzLmFyY2ggPSBmdW5jdGlvbiBhcmNoKCkgewogIHJldHVybiBiaW5kaW5nLmFyY2gKfQoKZXhwb3J0cy50eXBlID0gYmluZGluZy50eXBlCmV4cG9ydHMudmVyc2lvbiA9IGJpbmRpbmcudmVyc2lvbgpleHBvcnRzLnJlbGVhc2UgPSBiaW5kaW5nLnJlbGVhc2UKZXhwb3J0cy5tYWNoaW5lID0gYmluZGluZy5tYWNoaW5lCmV4cG9ydHMuZXhlY1BhdGggPSBiaW5kaW5nLmV4ZWNQYXRoCmV4cG9ydHMucGlkID0gYmluZGluZy5waWQKZXhwb3J0cy5wcGlkID0gYmluZGluZy5wcGlkCmV4cG9ydHMuY3dkID0gYmluZGluZy5jd2QKZXhwb3J0cy5jaGRpciA9IGJpbmRpbmcuY2hkaXIKZXhwb3J0cy50bXBkaXIgPSBiaW5kaW5nLnRtcGRpcgpleHBvcnRzLmhvbWVkaXIgPSBiaW5kaW5nLmhvbWVkaXIKZXhwb3J0cy5ob3N0bmFtZSA9IGJpbmRpbmcuaG9zdG5hbWUKZXhwb3J0cy51c2VySW5mbyA9IGJpbmRpbmcudXNlckluZm8KCmV4cG9ydHMua2lsbCA9IGZ1bmN0aW9uIGtpbGwocGlkLCBzaWduYWwgPSBjb25zdGFudHMuc2lnbmFscy5TSUdURVJNKSB7CiAgaWYgKHR5cGVvZiBzaWduYWwgPT09ICdzdHJpbmcnKSB7CiAgICBpZiAoc2lnbmFsIGluIGNvbnN0YW50cy5zaWduYWxzID09PSBmYWxzZSkgewogICAgICB0aHJvdyBlcnJvcnMuVU5LTk9XTl9TSUdOQUwoJ1Vua25vd24gc2lnbmFsOiAnICsgc2lnbmFsKQogICAgfQoKICAgIHNpZ25hbCA9IGNvbnN0YW50cy5zaWduYWxzW3NpZ25hbF0KICB9CgogIGJpbmRpbmcua2lsbChwaWQsIHNpZ25hbCkKfQoKZXhwb3J0cy5lbmRpYW5uZXNzID0gZnVuY3Rpb24gZW5kaWFubmVzcygpIHsKICByZXR1cm4gYmluZGluZy5pc0xpdHRsZUVuZGlhbiA/ICdMRScgOiAnQkUnCn0KCmV4cG9ydHMuYXZhaWxhYmxlUGFyYWxsZWxpc20gPSBiaW5kaW5nLmF2YWlsYWJsZVBhcmFsbGVsaXNtCgpleHBvcnRzLmNwdVVzYWdlID0gZnVuY3Rpb24gY3B1VXNhZ2UocHJldmlvdXMpIHsKICBjb25zdCBjdXJyZW50ID0gYmluZGluZy5jcHVVc2FnZSgpCgogIGlmIChwcmV2aW91cykgewogICAgcmV0dXJuIHsKICAgICAgdXNlcjogY3VycmVudC51c2VyIC0gcHJldmlvdXMudXNlciwKICAgICAgc3lzdGVtOiBjdXJyZW50LnN5c3RlbSAtIHByZXZpb3VzLnN5c3RlbQogICAgfQogIH0KCiAgcmV0dXJuIGN1cnJlbnQKfQoKZXhwb3J0cy50aHJlYWRDcHVVc2FnZSA9IGZ1bmN0aW9uIHRocmVhZENwdVVzYWdlKHByZXZpb3VzKSB7CiAgY29uc3QgY3VycmVudCA9IGJpbmRpbmcudGhyZWFkQ3B1VXNhZ2UoKQoKICBpZiAocHJldmlvdXMpIHsKICAgIHJldHVybiB7CiAgICAgIHVzZXI6IGN1cnJlbnQudXNlciAtIHByZXZpb3VzLnVzZXIsCiAgICAgIHN5c3RlbTogY3VycmVudC5zeXN0ZW0gLSBwcmV2aW91cy5zeXN0ZW0KICAgIH0KICB9CgogIHJldHVybiBjdXJyZW50Cn0KCmV4cG9ydHMucmVzb3VyY2VVc2FnZSA9IGJpbmRpbmcucmVzb3VyY2VVc2FnZQpleHBvcnRzLm1lbW9yeVVzYWdlID0gYmluZGluZy5tZW1vcnlVc2FnZQpleHBvcnRzLmZyZWVtZW0gPSBiaW5kaW5nLmZyZWVtZW0KZXhwb3J0cy50b3RhbG1lbSA9IGJpbmRpbmcudG90YWxtZW0KZXhwb3J0cy51cHRpbWUgPSBiaW5kaW5nLnVwdGltZQpleHBvcnRzLmxvYWRhdmcgPSBiaW5kaW5nLmxvYWRhdmcKZXhwb3J0cy5jcHVzID0gYmluZGluZy5jcHVzCgpleHBvcnRzLmdldFByb2Nlc3NUaXRsZSA9IGJpbmRpbmcuZ2V0UHJvY2Vzc1RpdGxlCgpleHBvcnRzLnNldFByb2Nlc3NUaXRsZSA9IGZ1bmN0aW9uIHNldFByb2Nlc3NUaXRsZSh0aXRsZSkgewogIGlmICh0eXBlb2YgdGl0bGUgIT09ICdzdHJpbmcnKSB0aXRsZSA9IHRpdGxlLnRvU3RyaW5nKCkKCiAgaWYgKHRpdGxlLmxlbmd0aCA+PSAyNTYpIHsKICAgIHRocm93IGVycm9ycy5USVRMRV9PVkVSRkxPVygnUHJvY2VzcyB0aXRsZSBpcyB0b28gbG9uZycpCiAgfQoKICBiaW5kaW5nLnNldFByb2Nlc3NUaXRsZSh0aXRsZSkKfQoKZXhwb3J0cy5nZXRFbnZLZXlzID0gYmluZGluZy5nZXRFbnZLZXlzCmV4cG9ydHMuZ2V0RW52ID0gYmluZGluZy5nZXRFbnYKZXhwb3J0cy5oYXNFbnYgPSBiaW5kaW5nLmhhc0VudgpleHBvcnRzLnNldEVudiA9IGJpbmRpbmcuc2V0RW52CmV4cG9ydHMudW5zZXRFbnYgPSBiaW5kaW5nLnVuc2V0RW52CmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKCm1vZHVsZS5leHBvcnRzID0gewogIHNpZ25hbHM6IGJpbmRpbmcuc2lnbmFscywKICBlcnJub3M6IGJpbmRpbmcuZXJybm9zCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBPU0Vycm9yIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yKG1zZywgY29kZSwgZm4gPSBPU0Vycm9yKSB7CiAgICBzdXBlcihgJHtjb2RlfTogJHttc2d9YCkKICAgIHRoaXMuY29kZSA9IGNvZGUKCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgZm4pCiAgICB9CiAgfQoKICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiAnT1NFcnJvcicKICB9CgogIHN0YXRpYyBVTktOT1dOX1NJR05BTChtc2cpIHsKICAgIHJldHVybiBuZXcgT1NFcnJvcihtc2csICdVTktOT1dOX1NJR05BTCcsIE9TRXJyb3IuVU5LTk9XTl9TSUdOQUwpCiAgfQoKICBzdGF0aWMgVElUTEVfT1ZFUkZMT1cobXNnKSB7CiAgICByZXR1cm4gbmV3IE9TRXJyb3IobXNnLCAnVElUTEVfT1ZFUkZMT1cnLCBPU0Vycm9yLlRJVExFX09WRVJGTE9XKQogIH0KfQp7CiAgIm5hbWUiOiAiYmFyZS1vcyIsCiAgInZlcnNpb24iOiAiMy42LjIiLAogICJkZXNjcmlwdGlvbiI6ICJPcGVyYXRpbmcgc3lzdGVtIHV0aWxpdGllcyBmb3IgSmF2YXNjcmlwdCIsCiAgImV4cG9ydHMiOiB7CiAgICAiLiI6IHsKICAgICAgInR5cGVzIjogIi4vaW5kZXguZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vaW5kZXguanMiCiAgICB9LAogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLi9jb25zdGFudHMiOiAiLi9saWIvY29uc3RhbnRzLmpzIiwKICAgICIuL2Vycm9ycyI6ICIuL2xpYi9lcnJvcnMuanMiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImluZGV4LmQudHMiLAogICAgImJpbmRpbmcuYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiLAogICAgImxpYiIsCiAgICAicHJlYnVpbGRzIgogIF0sCiAgImFkZG9uIjogdHJ1ZSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBiYXJlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1vcy5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLW9zL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1vcyNyZWFkbWUiLAogICJlbmdpbmVzIjogewogICAgImJhcmUiOiAiPj0xLjE0LjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMS4xIiwKICAgICJjbWFrZS1iYXJlIjogIl4xLjEuNiIsCiAgICAicHJldHRpZXIiOiAiXjMuNC4yIiwKICAgICJwcmV0dGllci1jb25maWctc3RhbmRhcmQiOiAiXjcuMC4wIgogIH0KfQovKiBnbG9iYWwgQmFyZSAqLwoKLy8gVGhpcyBleHBvcnQgU0hPVUxEIE5PVCBiZSBzaG9ydGVuZWQgaW4gYW55IHdheSBhcyBoYXZpbmcgdGhlIGZ1bGwKLy8gYG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSguLi4pYCBzdGF0ZW1lbnQgaXMgY3J1Y2lhbCBmb3Igc3ludGhlc2l6aW5nCi8vIEVTTSBleHBvcnRzLgoKaWYgKEJhcmUucGxhdGZvcm0gPT09ICd3aW4zMicpIHsKICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoJy4vbGliL3dpbjMyJykKfSBlbHNlIHsKICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoJy4vbGliL3Bvc2l4JykKfQptb2R1bGUuZXhwb3J0cyA9IHsKICBDSEFSX1VQUEVSQ0FTRV9BOiAweDQxLAogIENIQVJfTE9XRVJDQVNFX0E6IDB4NjEsCiAgQ0hBUl9VUFBFUkNBU0VfWjogMHg1YSwKICBDSEFSX0xPV0VSQ0FTRV9aOiAweDdhLAogIENIQVJfRE9UOiAweDJlLAogIENIQVJfRk9SV0FSRF9TTEFTSDogMHgyZiwKICBDSEFSX0JBQ0tXQVJEX1NMQVNIOiAweDVjLAogIENIQVJfQ09MT046IDB4M2EsCiAgQ0hBUl9RVUVTVElPTl9NQVJLOiAweDNmCn0KY29uc3Qgb3MgPSByZXF1aXJlKCdiYXJlLW9zJykKCmNvbnN0IHsgbm9ybWFsaXplU3RyaW5nIH0gPSByZXF1aXJlKCcuL3NoYXJlZCcpCmNvbnN0IHsKICBDSEFSX0RPVCwKICBDSEFSX0ZPUldBUkRfU0xBU0gKfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCmZ1bmN0aW9uIGlzUG9zaXhQYXRoU2VwYXJhdG9yIChjb2RlKSB7CiAgcmV0dXJuIGNvZGUgPT09IENIQVJfRk9SV0FSRF9TTEFTSAp9CgpleHBvcnRzLndpbjMyID0gcmVxdWlyZSgnLi93aW4zMicpCmV4cG9ydHMucG9zaXggPSBleHBvcnRzCgpleHBvcnRzLnNlcCA9ICcvJwpleHBvcnRzLmRlbGltaXRlciA9ICc6JwoKZXhwb3J0cy5yZXNvbHZlID0gZnVuY3Rpb24gcmVzb2x2ZSAoLi4uYXJncykgewogIGxldCByZXNvbHZlZFBhdGggPSAnJwogIGxldCByZXNvbHZlZEFic29sdXRlID0gZmFsc2UKCiAgZm9yIChsZXQgaSA9IGFyZ3MubGVuZ3RoIC0gMTsgaSA+PSAtMSAmJiAhcmVzb2x2ZWRBYnNvbHV0ZTsgaS0tKSB7CiAgICBjb25zdCBwYXRoID0gaSA+PSAwID8gYXJnc1tpXSA6IG9zLmN3ZCgpCgogICAgaWYgKHBhdGgubGVuZ3RoID09PSAwKSB7CiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgcmVzb2x2ZWRQYXRoID0gYCR7cGF0aH0vJHtyZXNvbHZlZFBhdGh9YAogICAgcmVzb2x2ZWRBYnNvbHV0ZSA9IHBhdGguY2hhckNvZGVBdCgwKSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNICiAgfQoKICByZXNvbHZlZFBhdGggPSBub3JtYWxpemVTdHJpbmcocmVzb2x2ZWRQYXRoLCAhcmVzb2x2ZWRBYnNvbHV0ZSwgJy8nLCBpc1Bvc2l4UGF0aFNlcGFyYXRvcikKCiAgaWYgKHJlc29sdmVkQWJzb2x1dGUpIHsKICAgIHJldHVybiBgLyR7cmVzb2x2ZWRQYXRofWAKICB9CgogIHJldHVybiByZXNvbHZlZFBhdGgubGVuZ3RoID4gMCA/IHJlc29sdmVkUGF0aCA6ICcuJwp9CgpleHBvcnRzLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uIG5vcm1hbGl6ZSAocGF0aCkgewogIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkgcmV0dXJuICcuJwoKICBjb25zdCBpc0Fic29sdXRlID0gcGF0aC5jaGFyQ29kZUF0KDApID09PSBDSEFSX0ZPUldBUkRfU0xBU0gKICBjb25zdCB0cmFpbGluZ1NlcGFyYXRvciA9IHBhdGguY2hhckNvZGVBdChwYXRoLmxlbmd0aCAtIDEpID09PSBDSEFSX0ZPUldBUkRfU0xBU0gKCiAgcGF0aCA9IG5vcm1hbGl6ZVN0cmluZyhwYXRoLCAhaXNBYnNvbHV0ZSwgJy8nLCBpc1Bvc2l4UGF0aFNlcGFyYXRvcikKCiAgaWYgKHBhdGgubGVuZ3RoID09PSAwKSB7CiAgICBpZiAoaXNBYnNvbHV0ZSkgcmV0dXJuICcvJwogICAgcmV0dXJuIHRyYWlsaW5nU2VwYXJhdG9yID8gJy4vJyA6ICcuJwogIH0KCiAgaWYgKHRyYWlsaW5nU2VwYXJhdG9yKSBwYXRoICs9ICcvJwoKICByZXR1cm4gaXNBYnNvbHV0ZSA/IGAvJHtwYXRofWAgOiBwYXRoCn0KCmV4cG9ydHMuaXNBYnNvbHV0ZSA9IGZ1bmN0aW9uIGlzQWJzb2x1dGUgKHBhdGgpIHsKICByZXR1cm4gcGF0aC5sZW5ndGggPiAwICYmIHBhdGguY2hhckNvZGVBdCgwKSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNICn0KCmV4cG9ydHMuam9pbiA9IGZ1bmN0aW9uIGpvaW4gKC4uLmFyZ3MpIHsKICBpZiAoYXJncy5sZW5ndGggPT09IDApIHJldHVybiAnLicKICBsZXQgam9pbmVkCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgKytpKSB7CiAgICBjb25zdCBhcmcgPSBhcmdzW2ldCiAgICBpZiAoYXJnLmxlbmd0aCA+IDApIHsKICAgICAgaWYgKGpvaW5lZCA9PT0gdW5kZWZpbmVkKSBqb2luZWQgPSBhcmcKICAgICAgZWxzZSBqb2luZWQgKz0gYC8ke2FyZ31gCiAgICB9CiAgfQogIGlmIChqb2luZWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuICcuJwogIHJldHVybiBleHBvcnRzLm5vcm1hbGl6ZShqb2luZWQpCn0KCmV4cG9ydHMucmVsYXRpdmUgPSBmdW5jdGlvbiByZWxhdGl2ZSAoZnJvbSwgdG8pIHsKICBpZiAoZnJvbSA9PT0gdG8pIHJldHVybiAnJwoKICBmcm9tID0gZXhwb3J0cy5yZXNvbHZlKGZyb20pCiAgdG8gPSBleHBvcnRzLnJlc29sdmUodG8pCgogIGlmIChmcm9tID09PSB0bykgcmV0dXJuICcnCgogIGNvbnN0IGZyb21TdGFydCA9IDEKICBjb25zdCBmcm9tRW5kID0gZnJvbS5sZW5ndGgKICBjb25zdCBmcm9tTGVuID0gZnJvbUVuZCAtIGZyb21TdGFydAogIGNvbnN0IHRvU3RhcnQgPSAxCiAgY29uc3QgdG9MZW4gPSB0by5sZW5ndGggLSB0b1N0YXJ0CgogIGNvbnN0IGxlbmd0aCA9IChmcm9tTGVuIDwgdG9MZW4gPyBmcm9tTGVuIDogdG9MZW4pCiAgbGV0IGxhc3RDb21tb25TZXAgPSAtMQogIGxldCBpID0gMAogIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IGZyb21Db2RlID0gZnJvbS5jaGFyQ29kZUF0KGZyb21TdGFydCArIGkpCiAgICBpZiAoZnJvbUNvZGUgIT09IHRvLmNoYXJDb2RlQXQodG9TdGFydCArIGkpKSB7CiAgICAgIGJyZWFrCiAgICB9IGVsc2UgaWYgKGZyb21Db2RlID09PSBDSEFSX0ZPUldBUkRfU0xBU0gpIHsKICAgICAgbGFzdENvbW1vblNlcCA9IGkKICAgIH0KICB9CiAgaWYgKGkgPT09IGxlbmd0aCkgewogICAgaWYgKHRvTGVuID4gbGVuZ3RoKSB7CiAgICAgIGlmICh0by5jaGFyQ29kZUF0KHRvU3RhcnQgKyBpKSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNIKSB7CiAgICAgICAgcmV0dXJuIHRvLnN1YnN0cmluZyh0b1N0YXJ0ICsgaSArIDEpCiAgICAgIH0KICAgICAgaWYgKGkgPT09IDApIHsKICAgICAgICByZXR1cm4gdG8uc3Vic3RyaW5nKHRvU3RhcnQgKyBpKQogICAgICB9CiAgICB9IGVsc2UgaWYgKGZyb21MZW4gPiBsZW5ndGgpIHsKICAgICAgaWYgKGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQgKyBpKSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNIKSB7CiAgICAgICAgbGFzdENvbW1vblNlcCA9IGkKICAgICAgfSBlbHNlIGlmIChpID09PSAwKSB7CiAgICAgICAgbGFzdENvbW1vblNlcCA9IDAKICAgICAgfQogICAgfQogIH0KCiAgbGV0IG91dCA9ICcnCiAgZm9yIChpID0gZnJvbVN0YXJ0ICsgbGFzdENvbW1vblNlcCArIDE7IGkgPD0gZnJvbUVuZDsgKytpKSB7CiAgICBpZiAoaSA9PT0gZnJvbUVuZCB8fCBmcm9tLmNoYXJDb2RlQXQoaSkgPT09IENIQVJfRk9SV0FSRF9TTEFTSCkgewogICAgICBvdXQgKz0gb3V0Lmxlbmd0aCA9PT0gMCA/ICcuLicgOiAnLy4uJwogICAgfQogIH0KCiAgcmV0dXJuIGAke291dH0ke3RvLnN1YnN0cmluZyh0b1N0YXJ0ICsgbGFzdENvbW1vblNlcCl9YAp9CgpleHBvcnRzLnRvTmFtZXNwYWNlZFBhdGggPSBmdW5jdGlvbiB0b05hbWVzcGFjZWRQYXRoIChwYXRoKSB7CiAgcmV0dXJuIHBhdGgKfQoKZXhwb3J0cy5kaXJuYW1lID0gZnVuY3Rpb24gZGlybmFtZSAocGF0aCkgewogIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkgcmV0dXJuICcuJwogIGNvbnN0IGhhc1Jvb3QgPSBwYXRoLmNoYXJDb2RlQXQoMCkgPT09IENIQVJfRk9SV0FSRF9TTEFTSAogIGxldCBlbmQgPSAtMQogIGxldCBtYXRjaGVkU2xhc2ggPSB0cnVlCiAgZm9yIChsZXQgaSA9IHBhdGgubGVuZ3RoIC0gMTsgaSA+PSAxOyAtLWkpIHsKICAgIGlmIChwYXRoLmNoYXJDb2RlQXQoaSkgPT09IENIQVJfRk9SV0FSRF9TTEFTSCkgewogICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgIGVuZCA9IGkKICAgICAgICBicmVhawogICAgICB9CiAgICB9IGVsc2UgewogICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZQogICAgfQogIH0KCiAgaWYgKGVuZCA9PT0gLTEpIHJldHVybiBoYXNSb290ID8gJy8nIDogJy4nCiAgaWYgKGhhc1Jvb3QgJiYgZW5kID09PSAxKSByZXR1cm4gJy8vJwogIHJldHVybiBwYXRoLnN1YnN0cmluZygwLCBlbmQpCn0KCmV4cG9ydHMuYmFzZW5hbWUgPSBmdW5jdGlvbiBiYXNlbmFtZSAocGF0aCwgc3VmZml4KSB7CiAgbGV0IHN0YXJ0ID0gMAogIGxldCBlbmQgPSAtMQogIGxldCBtYXRjaGVkU2xhc2ggPSB0cnVlCgogIGlmIChzdWZmaXggIT09IHVuZGVmaW5lZCAmJiBzdWZmaXgubGVuZ3RoID4gMCAmJiBzdWZmaXgubGVuZ3RoIDw9IHBhdGgubGVuZ3RoKSB7CiAgICBpZiAoc3VmZml4ID09PSBwYXRoKSB7IHJldHVybiAnJyB9CiAgICBsZXQgZXh0SWR4ID0gc3VmZml4Lmxlbmd0aCAtIDEKICAgIGxldCBmaXJzdE5vblNsYXNoRW5kID0gLTEKICAgIGZvciAobGV0IGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgIGNvbnN0IGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoaSkKICAgICAgaWYgKGNvZGUgPT09IENIQVJfRk9SV0FSRF9TTEFTSCkgewogICAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgICBzdGFydCA9IGkgKyAxCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZmlyc3ROb25TbGFzaEVuZCA9PT0gLTEpIHsKICAgICAgICAgIG1hdGNoZWRTbGFzaCA9IGZhbHNlCiAgICAgICAgICBmaXJzdE5vblNsYXNoRW5kID0gaSArIDEKICAgICAgICB9CiAgICAgICAgaWYgKGV4dElkeCA+PSAwKSB7CiAgICAgICAgICBpZiAoY29kZSA9PT0gc3VmZml4LmNoYXJDb2RlQXQoZXh0SWR4KSkgewogICAgICAgICAgICBpZiAoLS1leHRJZHggPT09IC0xKSB7CiAgICAgICAgICAgICAgZW5kID0gaQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBleHRJZHggPSAtMQogICAgICAgICAgICBlbmQgPSBmaXJzdE5vblNsYXNoRW5kCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKHN0YXJ0ID09PSBlbmQpIGVuZCA9IGZpcnN0Tm9uU2xhc2hFbmQKICAgIGVsc2UgaWYgKGVuZCA9PT0gLTEpIGVuZCA9IHBhdGgubGVuZ3RoCiAgICByZXR1cm4gcGF0aC5zdWJzdHJpbmcoc3RhcnQsIGVuZCkKICB9CgogIGZvciAobGV0IGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICBpZiAocGF0aC5jaGFyQ29kZUF0KGkpID09PSBDSEFSX0ZPUldBUkRfU0xBU0gpIHsKICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICBzdGFydCA9IGkgKyAxCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfSBlbHNlIGlmIChlbmQgPT09IC0xKSB7CiAgICAgIG1hdGNoZWRTbGFzaCA9IGZhbHNlCiAgICAgIGVuZCA9IGkgKyAxCiAgICB9CiAgfQoKICBpZiAoZW5kID09PSAtMSkgcmV0dXJuICcnCiAgcmV0dXJuIHBhdGguc3Vic3RyaW5nKHN0YXJ0LCBlbmQpCn0KCmV4cG9ydHMuZXh0bmFtZSA9IGZ1bmN0aW9uIGV4dG5hbWUgKHBhdGgpIHsKICBsZXQgc3RhcnREb3QgPSAtMQogIGxldCBzdGFydFBhcnQgPSAwCiAgbGV0IGVuZCA9IC0xCiAgbGV0IG1hdGNoZWRTbGFzaCA9IHRydWUKICBsZXQgcHJlRG90U3RhdGUgPSAwCiAgZm9yIChsZXQgaSA9IHBhdGgubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgIGNvbnN0IGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoaSkKICAgIGlmIChjb2RlID09PSBDSEFSX0ZPUldBUkRfU0xBU0gpIHsKICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICBzdGFydFBhcnQgPSBpICsgMQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgICAgY29udGludWUKICAgIH0KICAgIGlmIChlbmQgPT09IC0xKSB7CiAgICAgIG1hdGNoZWRTbGFzaCA9IGZhbHNlCiAgICAgIGVuZCA9IGkgKyAxCiAgICB9CiAgICBpZiAoY29kZSA9PT0gQ0hBUl9ET1QpIHsKICAgICAgaWYgKHN0YXJ0RG90ID09PSAtMSkgc3RhcnREb3QgPSBpCiAgICAgIGVsc2UgaWYgKHByZURvdFN0YXRlICE9PSAxKSBwcmVEb3RTdGF0ZSA9IDEKICAgIH0gZWxzZSBpZiAoc3RhcnREb3QgIT09IC0xKSB7CiAgICAgIHByZURvdFN0YXRlID0gLTEKICAgIH0KICB9CgogIGlmIChzdGFydERvdCA9PT0gLTEgfHwgZW5kID09PSAtMSB8fCBwcmVEb3RTdGF0ZSA9PT0gMCB8fCAocHJlRG90U3RhdGUgPT09IDEgJiYgc3RhcnREb3QgPT09IGVuZCAtIDEgJiYgc3RhcnREb3QgPT09IHN0YXJ0UGFydCArIDEpKSB7CiAgICByZXR1cm4gJycKICB9CiAgcmV0dXJuIHBhdGguc3Vic3RyaW5nKHN0YXJ0RG90LCBlbmQpCn0KY29uc3QgewogIENIQVJfRE9ULAogIENIQVJfRk9SV0FSRF9TTEFTSAp9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKZXhwb3J0cy5ub3JtYWxpemVTdHJpbmcgPSBmdW5jdGlvbiBub3JtYWxpemVTdHJpbmcgKHBhdGgsIGFsbG93QWJvdmVSb290LCBzZXBhcmF0b3IsIGlzUGF0aFNlcGFyYXRvcikgewogIGxldCByZXMgPSAnJwogIGxldCBsYXN0U2VnbWVudExlbmd0aCA9IDAKICBsZXQgbGFzdFNsYXNoID0gLTEKICBsZXQgZG90cyA9IDAKICBsZXQgY29kZSA9IDAKICBmb3IgKGxldCBpID0gMDsgaSA8PSBwYXRoLmxlbmd0aDsgKytpKSB7CiAgICBpZiAoaSA8IHBhdGgubGVuZ3RoKSB7CiAgICAgIGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoaSkKICAgIH0gZWxzZSBpZiAoaXNQYXRoU2VwYXJhdG9yKGNvZGUpKSB7CiAgICAgIGJyZWFrCiAgICB9IGVsc2UgewogICAgICBjb2RlID0gQ0hBUl9GT1JXQVJEX1NMQVNICiAgICB9CgogICAgaWYgKGlzUGF0aFNlcGFyYXRvcihjb2RlKSkgewogICAgICBpZiAobGFzdFNsYXNoID09PSBpIC0gMSB8fCBkb3RzID09PSAxKSA7CiAgICAgIGVsc2UgaWYgKGRvdHMgPT09IDIpIHsKICAgICAgICBpZiAocmVzLmxlbmd0aCA8IDIgfHwgbGFzdFNlZ21lbnRMZW5ndGggIT09IDIgfHwgcmVzLmNoYXJDb2RlQXQocmVzLmxlbmd0aCAtIDEpICE9PSBDSEFSX0RPVCB8fCByZXMuY2hhckNvZGVBdChyZXMubGVuZ3RoIC0gMikgIT09IENIQVJfRE9UKSB7CiAgICAgICAgICBpZiAocmVzLmxlbmd0aCA+IDIpIHsKICAgICAgICAgICAgY29uc3QgbGFzdFNsYXNoSW5kZXggPSByZXMubGFzdEluZGV4T2Yoc2VwYXJhdG9yKQogICAgICAgICAgICBpZiAobGFzdFNsYXNoSW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgICAgcmVzID0gJycKICAgICAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IDAKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXMgPSByZXMuc3Vic3RyaW5nKDAsIGxhc3RTbGFzaEluZGV4KQogICAgICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0KICAgICAgICAgICAgICAgIHJlcy5sZW5ndGggLSAxIC0gcmVzLmxhc3RJbmRleE9mKHNlcGFyYXRvcikKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0U2xhc2ggPSBpCiAgICAgICAgICAgIGRvdHMgPSAwCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICB9IGVsc2UgaWYgKHJlcy5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgcmVzID0gJycKICAgICAgICAgICAgbGFzdFNlZ21lbnRMZW5ndGggPSAwCiAgICAgICAgICAgIGxhc3RTbGFzaCA9IGkKICAgICAgICAgICAgZG90cyA9IDAKICAgICAgICAgICAgY29udGludWUKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGFsbG93QWJvdmVSb290KSB7CiAgICAgICAgICByZXMgKz0gcmVzLmxlbmd0aCA+IDAgPyBgJHtzZXBhcmF0b3J9Li5gIDogJy4uJwogICAgICAgICAgbGFzdFNlZ21lbnRMZW5ndGggPSAyCiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChyZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgcmVzICs9IGAke3NlcGFyYXRvcn0ke3BhdGguc3Vic3RyaW5nKGxhc3RTbGFzaCArIDEsIGkpfWAKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzID0gcGF0aC5zdWJzdHJpbmcobGFzdFNsYXNoICsgMSwgaSkKICAgICAgICB9CiAgICAgICAgbGFzdFNlZ21lbnRMZW5ndGggPSBpIC0gbGFzdFNsYXNoIC0gMQogICAgICB9CiAgICAgIGxhc3RTbGFzaCA9IGkKICAgICAgZG90cyA9IDAKICAgIH0gZWxzZSBpZiAoY29kZSA9PT0gQ0hBUl9ET1QgJiYgZG90cyAhPT0gLTEpIHsKICAgICAgKytkb3RzCiAgICB9IGVsc2UgewogICAgICBkb3RzID0gLTEKICAgIH0KICB9CiAgcmV0dXJuIHJlcwp9CmNvbnN0IG9zID0gcmVxdWlyZSgnYmFyZS1vcycpCgpjb25zdCB7IG5vcm1hbGl6ZVN0cmluZyB9ID0gcmVxdWlyZSgnLi9zaGFyZWQnKQpjb25zdCB7CiAgQ0hBUl9VUFBFUkNBU0VfQSwKICBDSEFSX0xPV0VSQ0FTRV9BLAogIENIQVJfVVBQRVJDQVNFX1osCiAgQ0hBUl9MT1dFUkNBU0VfWiwKICBDSEFSX0RPVCwKICBDSEFSX0ZPUldBUkRfU0xBU0gsCiAgQ0hBUl9CQUNLV0FSRF9TTEFTSCwKICBDSEFSX0NPTE9OLAogIENIQVJfUVVFU1RJT05fTUFSSwp9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKZnVuY3Rpb24gaXNXaW5kb3dzUGF0aFNlcGFyYXRvciAoY29kZSkgewogIHJldHVybiBjb2RlID09PSBDSEFSX0ZPUldBUkRfU0xBU0ggfHwgY29kZSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSAp9CgpmdW5jdGlvbiBpc1dpbmRvd3NEZXZpY2VSb290IChjb2RlKSB7CiAgcmV0dXJuIChjb2RlID49IENIQVJfVVBQRVJDQVNFX0EgJiYgY29kZSA8PSBDSEFSX1VQUEVSQ0FTRV9aKSB8fAogICAgICAgICAoY29kZSA+PSBDSEFSX0xPV0VSQ0FTRV9BICYmIGNvZGUgPD0gQ0hBUl9MT1dFUkNBU0VfWikKfQoKZXhwb3J0cy5wb3NpeCA9IHJlcXVpcmUoJy4vcG9zaXgnKQpleHBvcnRzLndpbjMyID0gZXhwb3J0cwoKZXhwb3J0cy5zZXAgPSAnXFwnCmV4cG9ydHMuZGVsaW1pdGVyID0gJzsnCgpleHBvcnRzLnJlc29sdmUgPSBmdW5jdGlvbiByZXNvbHZlICguLi5hcmdzKSB7CiAgbGV0IHJlc29sdmVkRGV2aWNlID0gJycKICBsZXQgcmVzb2x2ZWRUYWlsID0gJycKICBsZXQgcmVzb2x2ZWRBYnNvbHV0ZSA9IGZhbHNlCgogIGZvciAobGV0IGkgPSBhcmdzLmxlbmd0aCAtIDE7IGkgPj0gLTE7IGktLSkgewogICAgbGV0IHBhdGgKICAgIGlmIChpID49IDApIHsKICAgICAgcGF0aCA9IGFyZ3NbaV0KCiAgICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkgY29udGludWUKICAgIH0gZWxzZSBpZiAocmVzb2x2ZWREZXZpY2UubGVuZ3RoID09PSAwKSB7CiAgICAgIHBhdGggPSBvcy5jd2QoKQogICAgfSBlbHNlIHsKICAgICAgcGF0aCA9IG9zLmdldEVudihgPSR7cmVzb2x2ZWREZXZpY2V9YCkgfHwgb3MuY3dkKCkKCiAgICAgIGlmIChwYXRoID09PSB1bmRlZmluZWQgfHwgKHBhdGguc3Vic3RyaW5nKDAsIDIpLnRvTG93ZXJDYXNlKCkgIT09IHJlc29sdmVkRGV2aWNlLnRvTG93ZXJDYXNlKCkgJiYgcGF0aC5jaGFyQ29kZUF0KDIpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSkgewogICAgICAgIHBhdGggPSBgJHtyZXNvbHZlZERldmljZX1cXGAKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGxlbiA9IHBhdGgubGVuZ3RoCiAgICBsZXQgcm9vdEVuZCA9IDAKICAgIGxldCBkZXZpY2UgPSAnJwogICAgbGV0IGlzQWJzb2x1dGUgPSBmYWxzZQogICAgY29uc3QgY29kZSA9IHBhdGguY2hhckNvZGVBdCgwKQoKICAgIGlmIChsZW4gPT09IDEpIHsKICAgICAgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IoY29kZSkpIHsKICAgICAgICByb290RW5kID0gMQogICAgICAgIGlzQWJzb2x1dGUgPSB0cnVlCiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihjb2RlKSkgewogICAgICBpc0Fic29sdXRlID0gdHJ1ZQoKICAgICAgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KDEpKSkgewogICAgICAgIGxldCBqID0gMgogICAgICAgIGxldCBsYXN0ID0gagogICAgICAgIHdoaWxlIChqIDwgbGVuICYmICFpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChqKSkpIHsKICAgICAgICAgIGorKwogICAgICAgIH0KICAgICAgICBpZiAoaiA8IGxlbiAmJiBqICE9PSBsYXN0KSB7CiAgICAgICAgICBjb25zdCBmaXJzdFBhcnQgPSBwYXRoLnN1YnN0cmluZyhsYXN0LCBqKQogICAgICAgICAgbGFzdCA9IGoKICAgICAgICAgIHdoaWxlIChqIDwgbGVuICYmIGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGopKSkgewogICAgICAgICAgICBqKysKICAgICAgICAgIH0KICAgICAgICAgIGlmIChqIDwgbGVuICYmIGogIT09IGxhc3QpIHsKICAgICAgICAgICAgbGFzdCA9IGoKICAgICAgICAgICAgd2hpbGUgKGogPCBsZW4gJiYgIWlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGopKSkgewogICAgICAgICAgICAgIGorKwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChqID09PSBsZW4gfHwgaiAhPT0gbGFzdCkgewogICAgICAgICAgICAgIGRldmljZSA9IGBcXFxcJHtmaXJzdFBhcnR9XFwke3BhdGguc3Vic3RyaW5nKGxhc3QsIGopfWAKICAgICAgICAgICAgICByb290RW5kID0gagogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJvb3RFbmQgPSAxCiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNXaW5kb3dzRGV2aWNlUm9vdChjb2RlKSAmJiBwYXRoLmNoYXJDb2RlQXQoMSkgPT09IENIQVJfQ09MT04pIHsKICAgICAgZGV2aWNlID0gcGF0aC5zdWJzdHJpbmcoMCwgMikKICAgICAgcm9vdEVuZCA9IDIKICAgICAgaWYgKGxlbiA+IDIgJiYgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoMikpKSB7CiAgICAgICAgaXNBYnNvbHV0ZSA9IHRydWUKICAgICAgICByb290RW5kID0gMwogICAgICB9CiAgICB9CgogICAgaWYgKGRldmljZS5sZW5ndGggPiAwKSB7CiAgICAgIGlmIChyZXNvbHZlZERldmljZS5sZW5ndGggPiAwKSB7CiAgICAgICAgaWYgKGRldmljZS50b0xvd2VyQ2FzZSgpICE9PSByZXNvbHZlZERldmljZS50b0xvd2VyQ2FzZSgpKSB7IGNvbnRpbnVlIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXNvbHZlZERldmljZSA9IGRldmljZQogICAgICB9CiAgICB9CgogICAgaWYgKHJlc29sdmVkQWJzb2x1dGUpIHsKICAgICAgaWYgKHJlc29sdmVkRGV2aWNlLmxlbmd0aCA+IDApIHsgYnJlYWsgfQogICAgfSBlbHNlIHsKICAgICAgcmVzb2x2ZWRUYWlsID0gYCR7cGF0aC5zdWJzdHJpbmcocm9vdEVuZCl9XFwke3Jlc29sdmVkVGFpbH1gCiAgICAgIHJlc29sdmVkQWJzb2x1dGUgPSBpc0Fic29sdXRlCiAgICAgIGlmIChpc0Fic29sdXRlICYmIHJlc29sdmVkRGV2aWNlLmxlbmd0aCA+IDApIHsKICAgICAgICBicmVhawogICAgICB9CiAgICB9CiAgfQoKICByZXNvbHZlZFRhaWwgPSBub3JtYWxpemVTdHJpbmcocmVzb2x2ZWRUYWlsLCAhcmVzb2x2ZWRBYnNvbHV0ZSwgJ1xcJywgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcikKCiAgcmV0dXJuIHJlc29sdmVkQWJzb2x1dGUgPyBgJHtyZXNvbHZlZERldmljZX1cXCR7cmVzb2x2ZWRUYWlsfWAgOiBgJHtyZXNvbHZlZERldmljZX0ke3Jlc29sdmVkVGFpbH1gIHx8ICcuJwp9CgpleHBvcnRzLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uIG5vcm1hbGl6ZSAocGF0aCkgewogIGNvbnN0IGxlbiA9IHBhdGgubGVuZ3RoCiAgaWYgKGxlbiA9PT0gMCkgcmV0dXJuICcuJwogIGxldCByb290RW5kID0gMAogIGxldCBkZXZpY2UKICBsZXQgaXNBYnNvbHV0ZSA9IGZhbHNlCiAgY29uc3QgY29kZSA9IHBhdGguY2hhckNvZGVBdCgwKQoKICBpZiAobGVuID09PSAxKSB7CiAgICByZXR1cm4gY29kZSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNIID8gJ1xcJyA6IHBhdGgKICB9CgogIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGNvZGUpKSB7CiAgICBpc0Fic29sdXRlID0gdHJ1ZQoKICAgIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdCgxKSkpIHsKICAgICAgbGV0IGogPSAyCiAgICAgIGxldCBsYXN0ID0gagogICAgICB3aGlsZSAoaiA8IGxlbiAmJiAhaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaikpKSB7CiAgICAgICAgaisrCiAgICAgIH0KICAgICAgaWYgKGogPCBsZW4gJiYgaiAhPT0gbGFzdCkgewogICAgICAgIGNvbnN0IGZpcnN0UGFydCA9IHBhdGguc3Vic3RyaW5nKGxhc3QsIGopCiAgICAgICAgbGFzdCA9IGoKICAgICAgICB3aGlsZSAoaiA8IGxlbiAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChqKSkpIHsKICAgICAgICAgIGorKwogICAgICAgIH0KICAgICAgICBpZiAoaiA8IGxlbiAmJiBqICE9PSBsYXN0KSB7CiAgICAgICAgICBsYXN0ID0gagogICAgICAgICAgd2hpbGUgKGogPCBsZW4gJiYgIWlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGopKSkgewogICAgICAgICAgICBqKysKICAgICAgICAgIH0KICAgICAgICAgIGlmIChqID09PSBsZW4pIHsKICAgICAgICAgICAgcmV0dXJuIGBcXFxcJHtmaXJzdFBhcnR9XFwke3BhdGguc3Vic3RyaW5nKGxhc3QpfVxcYAogICAgICAgICAgfQogICAgICAgICAgaWYgKGogIT09IGxhc3QpIHsKICAgICAgICAgICAgZGV2aWNlID0gYFxcXFwke2ZpcnN0UGFydH1cXCR7cGF0aC5zdWJzdHJpbmcobGFzdCwgail9YAogICAgICAgICAgICByb290RW5kID0gagogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcm9vdEVuZCA9IDEKICAgIH0KICB9IGVsc2UgaWYgKGlzV2luZG93c0RldmljZVJvb3QoY29kZSkgJiYgcGF0aC5jaGFyQ29kZUF0KDEpID09PSBDSEFSX0NPTE9OKSB7CiAgICBkZXZpY2UgPSBwYXRoLnN1YnN0cmluZygwLCAyKQogICAgcm9vdEVuZCA9IDIKICAgIGlmIChsZW4gPiAyICYmIGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KDIpKSkgewogICAgICBpc0Fic29sdXRlID0gdHJ1ZQogICAgICByb290RW5kID0gMwogICAgfQogIH0KCiAgbGV0IHRhaWwgPSByb290RW5kIDwgbGVuID8gbm9ybWFsaXplU3RyaW5nKHBhdGguc3Vic3RyaW5nKHJvb3RFbmQpLCAhaXNBYnNvbHV0ZSwgJ1xcJywgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcikgOiAnJwogIGlmICh0YWlsLmxlbmd0aCA9PT0gMCAmJiAhaXNBYnNvbHV0ZSkgewogICAgdGFpbCA9ICcuJwogIH0KICBpZiAodGFpbC5sZW5ndGggPiAwICYmIGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGxlbiAtIDEpKSkgewogICAgdGFpbCArPSAnXFwnCiAgfQogIGlmIChkZXZpY2UgPT09IHVuZGVmaW5lZCkgewogICAgcmV0dXJuIGlzQWJzb2x1dGUgPyBgXFwke3RhaWx9YCA6IHRhaWwKICB9CiAgcmV0dXJuIGlzQWJzb2x1dGUgPyBgJHtkZXZpY2V9XFwke3RhaWx9YCA6IGAke2RldmljZX0ke3RhaWx9YAp9CgpleHBvcnRzLmlzQWJzb2x1dGUgPSBmdW5jdGlvbiBpc0Fic29sdXRlIChwYXRoKSB7CiAgY29uc3QgbGVuID0gcGF0aC5sZW5ndGgKICBpZiAobGVuID09PSAwKSByZXR1cm4gZmFsc2UKCiAgY29uc3QgY29kZSA9IHBhdGguY2hhckNvZGVBdCgwKQoKICByZXR1cm4gaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihjb2RlKSB8fCAobGVuID4gMiAmJiBpc1dpbmRvd3NEZXZpY2VSb290KGNvZGUpICYmIHBhdGguY2hhckNvZGVBdCgxKSA9PT0gQ0hBUl9DT0xPTiAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdCgyKSkpCn0KCmV4cG9ydHMuam9pbiA9IGZ1bmN0aW9uIGpvaW4gKC4uLmFyZ3MpIHsKICBpZiAoYXJncy5sZW5ndGggPT09IDApIHJldHVybiAnLicKCiAgbGV0IGpvaW5lZAogIGxldCBmaXJzdFBhcnQKICBmb3IgKGxldCBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyArK2kpIHsKICAgIGNvbnN0IGFyZyA9IGFyZ3NbaV0KICAgIGlmIChhcmcubGVuZ3RoID4gMCkgewogICAgICBpZiAoam9pbmVkID09PSB1bmRlZmluZWQpIGpvaW5lZCA9IGZpcnN0UGFydCA9IGFyZwogICAgICBlbHNlIGpvaW5lZCArPSBgXFwke2FyZ31gCiAgICB9CiAgfQoKICBpZiAoam9pbmVkID09PSB1bmRlZmluZWQpIHJldHVybiAnLicKCiAgbGV0IG5lZWRzUmVwbGFjZSA9IHRydWUKICBsZXQgc2xhc2hDb3VudCA9IDAKICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihmaXJzdFBhcnQuY2hhckNvZGVBdCgwKSkpIHsKICAgICsrc2xhc2hDb3VudAogICAgY29uc3QgZmlyc3RMZW4gPSBmaXJzdFBhcnQubGVuZ3RoCiAgICBpZiAoZmlyc3RMZW4gPiAxICYmIGlzV2luZG93c1BhdGhTZXBhcmF0b3IoZmlyc3RQYXJ0LmNoYXJDb2RlQXQoMSkpKSB7CiAgICAgICsrc2xhc2hDb3VudAogICAgICBpZiAoZmlyc3RMZW4gPiAyKSB7CiAgICAgICAgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IoZmlyc3RQYXJ0LmNoYXJDb2RlQXQoMikpKSB7CiAgICAgICAgICArK3NsYXNoQ291bnQKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbmVlZHNSZXBsYWNlID0gZmFsc2UKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgaWYgKG5lZWRzUmVwbGFjZSkgewogICAgd2hpbGUgKHNsYXNoQ291bnQgPCBqb2luZWQubGVuZ3RoICYmIGlzV2luZG93c1BhdGhTZXBhcmF0b3Ioam9pbmVkLmNoYXJDb2RlQXQoc2xhc2hDb3VudCkpKSB7CiAgICAgIHNsYXNoQ291bnQrKwogICAgfQoKICAgIGlmIChzbGFzaENvdW50ID49IDIpIHsKICAgICAgam9pbmVkID0gYFxcJHtqb2luZWQuc3Vic3RyaW5nKHNsYXNoQ291bnQpfWAKICAgIH0KICB9CgogIHJldHVybiBleHBvcnRzLm5vcm1hbGl6ZShqb2luZWQpCn0KCmV4cG9ydHMucmVsYXRpdmUgPSBmdW5jdGlvbiByZWxhdGl2ZSAoZnJvbSwgdG8pIHsKICBpZiAoZnJvbSA9PT0gdG8pIHJldHVybiAnJwoKICBjb25zdCBmcm9tT3JpZyA9IGV4cG9ydHMucmVzb2x2ZShmcm9tKQogIGNvbnN0IHRvT3JpZyA9IGV4cG9ydHMucmVzb2x2ZSh0bykKCiAgaWYgKGZyb21PcmlnID09PSB0b09yaWcpIHJldHVybiAnJwoKICBmcm9tID0gZnJvbU9yaWcudG9Mb3dlckNhc2UoKQogIHRvID0gdG9PcmlnLnRvTG93ZXJDYXNlKCkKCiAgaWYgKGZyb20gPT09IHRvKSByZXR1cm4gJycKCiAgbGV0IGZyb21TdGFydCA9IDAKICB3aGlsZSAoZnJvbVN0YXJ0IDwgZnJvbS5sZW5ndGggJiYgZnJvbS5jaGFyQ29kZUF0KGZyb21TdGFydCkgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpIHsKICAgIGZyb21TdGFydCsrCiAgfQogIGxldCBmcm9tRW5kID0gZnJvbS5sZW5ndGgKICB3aGlsZSAoZnJvbUVuZCAtIDEgPiBmcm9tU3RhcnQgJiYgZnJvbS5jaGFyQ29kZUF0KGZyb21FbmQgLSAxKSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkgewogICAgZnJvbUVuZC0tCiAgfQogIGNvbnN0IGZyb21MZW4gPSBmcm9tRW5kIC0gZnJvbVN0YXJ0CgogIGxldCB0b1N0YXJ0ID0gMAogIHdoaWxlICh0b1N0YXJ0IDwgdG8ubGVuZ3RoICYmIHRvLmNoYXJDb2RlQXQodG9TdGFydCkgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpIHsKICAgIHRvU3RhcnQrKwogIH0KICBsZXQgdG9FbmQgPSB0by5sZW5ndGgKICB3aGlsZSAodG9FbmQgLSAxID4gdG9TdGFydCAmJiB0by5jaGFyQ29kZUF0KHRvRW5kIC0gMSkgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpIHsKICAgIHRvRW5kLS0KICB9CiAgY29uc3QgdG9MZW4gPSB0b0VuZCAtIHRvU3RhcnQKCiAgY29uc3QgbGVuZ3RoID0gZnJvbUxlbiA8IHRvTGVuID8gZnJvbUxlbiA6IHRvTGVuCiAgbGV0IGxhc3RDb21tb25TZXAgPSAtMQogIGxldCBpID0gMAogIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IGZyb21Db2RlID0gZnJvbS5jaGFyQ29kZUF0KGZyb21TdGFydCArIGkpCiAgICBpZiAoZnJvbUNvZGUgIT09IHRvLmNoYXJDb2RlQXQodG9TdGFydCArIGkpKSB7CiAgICAgIGJyZWFrCiAgICB9IGVsc2UgaWYgKGZyb21Db2RlID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICAgIGxhc3RDb21tb25TZXAgPSBpCiAgICB9CiAgfQoKICBpZiAoaSAhPT0gbGVuZ3RoKSB7CiAgICBpZiAobGFzdENvbW1vblNlcCA9PT0gLTEpIHJldHVybiB0b09yaWcKICB9IGVsc2UgewogICAgaWYgKHRvTGVuID4gbGVuZ3RoKSB7CiAgICAgIGlmICh0by5jaGFyQ29kZUF0KHRvU3RhcnQgKyBpKSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkgewogICAgICAgIHJldHVybiB0b09yaWcuc3Vic3RyaW5nKHRvU3RhcnQgKyBpICsgMSkKICAgICAgfQogICAgICBpZiAoaSA9PT0gMikgewogICAgICAgIHJldHVybiB0b09yaWcuc3Vic3RyaW5nKHRvU3RhcnQgKyBpKQogICAgICB9CiAgICB9CiAgICBpZiAoZnJvbUxlbiA+IGxlbmd0aCkgewogICAgICBpZiAoZnJvbS5jaGFyQ29kZUF0KGZyb21TdGFydCArIGkpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICAgICAgbGFzdENvbW1vblNlcCA9IGkKICAgICAgfSBlbHNlIGlmIChpID09PSAyKSB7CiAgICAgICAgbGFzdENvbW1vblNlcCA9IDMKICAgICAgfQogICAgfQogICAgaWYgKGxhc3RDb21tb25TZXAgPT09IC0xKSBsYXN0Q29tbW9uU2VwID0gMAogIH0KCiAgbGV0IG91dCA9ICcnCiAgZm9yIChpID0gZnJvbVN0YXJ0ICsgbGFzdENvbW1vblNlcCArIDE7IGkgPD0gZnJvbUVuZDsgKytpKSB7CiAgICBpZiAoaSA9PT0gZnJvbUVuZCB8fCBmcm9tLmNoYXJDb2RlQXQoaSkgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpIHsKICAgICAgb3V0ICs9IG91dC5sZW5ndGggPT09IDAgPyAnLi4nIDogJ1xcLi4nCiAgICB9CiAgfQoKICB0b1N0YXJ0ICs9IGxhc3RDb21tb25TZXAKCiAgaWYgKG91dC5sZW5ndGggPiAwKSB7CiAgICByZXR1cm4gYCR7b3V0fSR7dG9PcmlnLnN1YnN0cmluZyh0b1N0YXJ0LCB0b0VuZCl9YAogIH0KICBpZiAodG9PcmlnLmNoYXJDb2RlQXQodG9TdGFydCkgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpIHsKICAgICsrdG9TdGFydAogIH0KICByZXR1cm4gdG9PcmlnLnN1YnN0cmluZyh0b1N0YXJ0LCB0b0VuZCkKfQoKZXhwb3J0cy50b05hbWVzcGFjZWRQYXRoID0gZnVuY3Rpb24gdG9OYW1lc3BhY2VkUGF0aCAocGF0aCkgewogIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHBhdGgKCiAgY29uc3QgcmVzb2x2ZWRQYXRoID0gZXhwb3J0cy5yZXNvbHZlKHBhdGgpCgogIGlmIChyZXNvbHZlZFBhdGgubGVuZ3RoIDw9IDIpIHJldHVybiBwYXRoCgogIGlmIChyZXNvbHZlZFBhdGguY2hhckNvZGVBdCgwKSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkgewogICAgaWYgKHJlc29sdmVkUGF0aC5jaGFyQ29kZUF0KDEpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICAgIGNvbnN0IGNvZGUgPSByZXNvbHZlZFBhdGguY2hhckNvZGVBdCgyKQogICAgICBpZiAoY29kZSAhPT0gQ0hBUl9RVUVTVElPTl9NQVJLICYmIGNvZGUgIT09IENIQVJfRE9UKSB7CiAgICAgICAgcmV0dXJuIGBcXFxcP1xcVU5DXFwke3Jlc29sdmVkUGF0aC5zdWJzdHJpbmcoMil9YAogICAgICB9CiAgICB9CiAgfSBlbHNlIGlmICgKICAgIGlzV2luZG93c0RldmljZVJvb3QocmVzb2x2ZWRQYXRoLmNoYXJDb2RlQXQoMCkpICYmCiAgICAgIHJlc29sdmVkUGF0aC5jaGFyQ29kZUF0KDEpID09PSBDSEFSX0NPTE9OICYmCiAgICAgIHJlc29sdmVkUGF0aC5jaGFyQ29kZUF0KDIpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNICiAgKSB7CiAgICByZXR1cm4gYFxcXFw/XFwke3Jlc29sdmVkUGF0aH1gCiAgfQoKICByZXR1cm4gcGF0aAp9CgpleHBvcnRzLmRpcm5hbWUgPSBmdW5jdGlvbiBkaXJuYW1lIChwYXRoKSB7CiAgY29uc3QgbGVuID0gcGF0aC5sZW5ndGgKICBpZiAobGVuID09PSAwKSByZXR1cm4gJy4nCiAgbGV0IHJvb3RFbmQgPSAtMQogIGxldCBvZmZzZXQgPSAwCiAgY29uc3QgY29kZSA9IHBhdGguY2hhckNvZGVBdCgwKQoKICBpZiAobGVuID09PSAxKSB7CiAgICByZXR1cm4gaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihjb2RlKSA/IHBhdGggOiAnLicKICB9CgogIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGNvZGUpKSB7CiAgICByb290RW5kID0gb2Zmc2V0ID0gMQoKICAgIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdCgxKSkpIHsKICAgICAgbGV0IGogPSAyCiAgICAgIGxldCBsYXN0ID0gagogICAgICB3aGlsZSAoaiA8IGxlbiAmJiAhaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaikpKSB7CiAgICAgICAgaisrCiAgICAgIH0KICAgICAgaWYgKGogPCBsZW4gJiYgaiAhPT0gbGFzdCkgewogICAgICAgIGxhc3QgPSBqCiAgICAgICAgd2hpbGUgKGogPCBsZW4gJiYgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaikpKSB7CiAgICAgICAgICBqKysKICAgICAgICB9CiAgICAgICAgaWYgKGogPCBsZW4gJiYgaiAhPT0gbGFzdCkgewogICAgICAgICAgbGFzdCA9IGoKICAgICAgICAgIHdoaWxlIChqIDwgbGVuICYmICFpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChqKSkpIHsKICAgICAgICAgICAgaisrCiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaiA9PT0gbGVuKSB7CiAgICAgICAgICAgIHJldHVybiBwYXRoCiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaiAhPT0gbGFzdCkgewogICAgICAgICAgICByb290RW5kID0gb2Zmc2V0ID0gaiArIDEKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9IGVsc2UgaWYgKGlzV2luZG93c0RldmljZVJvb3QoY29kZSkgJiYgcGF0aC5jaGFyQ29kZUF0KDEpID09PSBDSEFSX0NPTE9OKSB7CiAgICByb290RW5kID0gbGVuID4gMiAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdCgyKSkgPyAzIDogMgogICAgb2Zmc2V0ID0gcm9vdEVuZAogIH0KCiAgbGV0IGVuZCA9IC0xCiAgbGV0IG1hdGNoZWRTbGFzaCA9IHRydWUKICBmb3IgKGxldCBpID0gbGVuIC0gMTsgaSA+PSBvZmZzZXQ7IC0taSkgewogICAgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGkpKSkgewogICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgIGVuZCA9IGkKICAgICAgICBicmVhawogICAgICB9CiAgICB9IGVsc2UgewogICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZQogICAgfQogIH0KCiAgaWYgKGVuZCA9PT0gLTEpIHsKICAgIGlmIChyb290RW5kID09PSAtMSkgcmV0dXJuICcuJwoKICAgIGVuZCA9IHJvb3RFbmQKICB9CiAgcmV0dXJuIHBhdGguc3Vic3RyaW5nKDAsIGVuZCkKfQoKZXhwb3J0cy5iYXNlbmFtZSA9IGZ1bmN0aW9uIGJhc2VuYW1lIChwYXRoLCBzdWZmaXgpIHsKICBsZXQgc3RhcnQgPSAwCiAgbGV0IGVuZCA9IC0xCiAgbGV0IG1hdGNoZWRTbGFzaCA9IHRydWUKCiAgaWYgKHBhdGgubGVuZ3RoID49IDIgJiYgaXNXaW5kb3dzRGV2aWNlUm9vdChwYXRoLmNoYXJDb2RlQXQoMCkpICYmIHBhdGguY2hhckNvZGVBdCgxKSA9PT0gQ0hBUl9DT0xPTikgewogICAgc3RhcnQgPSAyCiAgfQoKICBpZiAoc3VmZml4ICE9PSB1bmRlZmluZWQgJiYgc3VmZml4Lmxlbmd0aCA+IDAgJiYgc3VmZml4Lmxlbmd0aCA8PSBwYXRoLmxlbmd0aCkgewogICAgaWYgKHN1ZmZpeCA9PT0gcGF0aCkgcmV0dXJuICcnCiAgICBsZXQgZXh0SWR4ID0gc3VmZml4Lmxlbmd0aCAtIDEKICAgIGxldCBmaXJzdE5vblNsYXNoRW5kID0gLTEKICAgIGZvciAobGV0IGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gc3RhcnQ7IC0taSkgewogICAgICBjb25zdCBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpCiAgICAgIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGNvZGUpKSB7CiAgICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICAgIHN0YXJ0ID0gaSArIDEKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChmaXJzdE5vblNsYXNoRW5kID09PSAtMSkgewogICAgICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2UKICAgICAgICAgIGZpcnN0Tm9uU2xhc2hFbmQgPSBpICsgMQogICAgICAgIH0KICAgICAgICBpZiAoZXh0SWR4ID49IDApIHsKICAgICAgICAgIGlmIChjb2RlID09PSBzdWZmaXguY2hhckNvZGVBdChleHRJZHgpKSB7CiAgICAgICAgICAgIGlmICgtLWV4dElkeCA9PT0gLTEpIHsKICAgICAgICAgICAgICBlbmQgPSBpCiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4dElkeCA9IC0xCiAgICAgICAgICAgIGVuZCA9IGZpcnN0Tm9uU2xhc2hFbmQKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAoc3RhcnQgPT09IGVuZCkgZW5kID0gZmlyc3ROb25TbGFzaEVuZAogICAgZWxzZSBpZiAoZW5kID09PSAtMSkgZW5kID0gcGF0aC5sZW5ndGgKICAgIHJldHVybiBwYXRoLnN1YnN0cmluZyhzdGFydCwgZW5kKQogIH0KICBmb3IgKGxldCBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IHN0YXJ0OyAtLWkpIHsKICAgIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChpKSkpIHsKICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICBzdGFydCA9IGkgKyAxCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfSBlbHNlIGlmIChlbmQgPT09IC0xKSB7CiAgICAgIG1hdGNoZWRTbGFzaCA9IGZhbHNlCiAgICAgIGVuZCA9IGkgKyAxCiAgICB9CiAgfQoKICBpZiAoZW5kID09PSAtMSkgcmV0dXJuICcnCiAgcmV0dXJuIHBhdGguc3Vic3RyaW5nKHN0YXJ0LCBlbmQpCn0KCmV4cG9ydHMuZXh0bmFtZSA9IGZ1bmN0aW9uIGV4dG5hbWUgKHBhdGgpIHsKICBsZXQgc3RhcnQgPSAwCiAgbGV0IHN0YXJ0RG90ID0gLTEKICBsZXQgc3RhcnRQYXJ0ID0gMAogIGxldCBlbmQgPSAtMQogIGxldCBtYXRjaGVkU2xhc2ggPSB0cnVlCiAgbGV0IHByZURvdFN0YXRlID0gMAoKICBpZiAocGF0aC5sZW5ndGggPj0gMiAmJiBwYXRoLmNoYXJDb2RlQXQoMSkgPT09IENIQVJfQ09MT04gJiYgaXNXaW5kb3dzRGV2aWNlUm9vdChwYXRoLmNoYXJDb2RlQXQoMCkpKSB7CiAgICBzdGFydCA9IHN0YXJ0UGFydCA9IDIKICB9CgogIGZvciAobGV0IGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gc3RhcnQ7IC0taSkgewogICAgY29uc3QgY29kZSA9IHBhdGguY2hhckNvZGVBdChpKQogICAgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IoY29kZSkpIHsKICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICBzdGFydFBhcnQgPSBpICsgMQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgICAgY29udGludWUKICAgIH0KICAgIGlmIChlbmQgPT09IC0xKSB7CiAgICAgIG1hdGNoZWRTbGFzaCA9IGZhbHNlCiAgICAgIGVuZCA9IGkgKyAxCiAgICB9CiAgICBpZiAoY29kZSA9PT0gQ0hBUl9ET1QpIHsKICAgICAgaWYgKHN0YXJ0RG90ID09PSAtMSkgc3RhcnREb3QgPSBpCiAgICAgIGVsc2UgaWYgKHByZURvdFN0YXRlICE9PSAxKSBwcmVEb3RTdGF0ZSA9IDEKICAgIH0gZWxzZSBpZiAoc3RhcnREb3QgIT09IC0xKSB7CiAgICAgIHByZURvdFN0YXRlID0gLTEKICAgIH0KICB9CgogIGlmIChzdGFydERvdCA9PT0gLTEgfHwgZW5kID09PSAtMSB8fCBwcmVEb3RTdGF0ZSA9PT0gMCB8fCAocHJlRG90U3RhdGUgPT09IDEgJiYgc3RhcnREb3QgPT09IGVuZCAtIDEgJiYgc3RhcnREb3QgPT09IHN0YXJ0UGFydCArIDEpKSB7CiAgICByZXR1cm4gJycKICB9CiAgcmV0dXJuIHBhdGguc3Vic3RyaW5nKHN0YXJ0RG90LCBlbmQpCn0KewogICJuYW1lIjogImJhcmUtcGF0aCIsCiAgInZlcnNpb24iOiAiMy4wLjAiLAogICJkZXNjcmlwdGlvbiI6ICJQYXRoIG1hbmlwdWxhdGlvbiBsaWJyYXJ5IGZvciBKYXZhU2NyaXB0IiwKICAiZXhwb3J0cyI6IHsKICAgICIuIjogIi4vaW5kZXguanMiLAogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLi9wb3NpeCI6ICIuL2xpYi9wb3NpeC5qcyIsCiAgICAiLi93aW4zMiI6ICIuL2xpYi93aW4zMi5qcyIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibGliIiwKICAgICJOT1RJQ0UiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJhcmUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXBhdGguZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1wYXRoL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1wYXRoI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLW9zIjogIl4zLjAuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4zLjIiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfQp9CmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBtID0gcmVxdWlyZSgnLi9saWIvbWVzc2FnZXMnKQpjb25zdCB7IHR5cGU6IHQsIHN0cmVhbTogcyB9ID0gcmVxdWlyZSgnLi9saWIvY29uc3RhbnRzJykKY29uc3QgSW5jb21pbmdSZXF1ZXN0ID0gcmVxdWlyZSgnLi9saWIvaW5jb21pbmctcmVxdWVzdCcpCmNvbnN0IEluY29taW5nU3RyZWFtID0gcmVxdWlyZSgnLi9saWIvaW5jb21pbmctc3RyZWFtJykKY29uc3QgT3V0Z29pbmdSZXF1ZXN0ID0gcmVxdWlyZSgnLi9saWIvb3V0Z29pbmctcmVxdWVzdCcpCmNvbnN0IE91dGdvaW5nU3RyZWFtID0gcmVxdWlyZSgnLi9saWIvb3V0Z29pbmctc3RyZWFtJykKY29uc3QgQ29tbWFuZFJvdXRlciA9IHJlcXVpcmUoJy4vbGliL2NvbW1hbmQtcm91dGVyJykKCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IGNsYXNzIFJQQyB7CiAgY29uc3RydWN0b3Ioc3RyZWFtLCBvbnJlcXVlc3QgPSBub29wKSB7CiAgICB0aGlzLl9zdHJlYW0gPSBzdHJlYW0KICAgIHRoaXMuX2lkID0gMAoKICAgIHRoaXMuX291dGdvaW5nUmVxdWVzdHMgPSBuZXcgTWFwKCkKICAgIHRoaXMuX291dGdvaW5nUmVzcG9uc2VzID0gbmV3IE1hcCgpCiAgICB0aGlzLl9pbmNvbWluZ1JlcXVlc3RzID0gbmV3IE1hcCgpCiAgICB0aGlzLl9pbmNvbWluZ1Jlc3BvbnNlcyA9IG5ldyBNYXAoKQogICAgdGhpcy5fcGVuZGluZ1JlcXVlc3RzID0gbmV3IFNldCgpCiAgICB0aGlzLl9wZW5kaW5nUmVzcG9uc2VzID0gbmV3IFNldCgpCgogICAgdGhpcy5fYnVmZmVyID0gW10KICAgIHRoaXMuX2J1ZmZlcmVkID0gMAogICAgdGhpcy5fZnJhbWUgPSAtMQogICAgdGhpcy5fZHJhaW5pbmcgPSBbXQoKICAgIGlmICh0eXBlb2Ygb25yZXF1ZXN0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIG9ucmVxdWVzdCA9IG9ucmVxdWVzdC5iaW5kKHRoaXMpCiAgICB9IGVsc2UgewogICAgICBvbnJlcXVlc3QgPSBvbnJlcXVlc3QuX29ucmVxdWVzdC5iaW5kKG9ucmVxdWVzdCkKICAgIH0KCiAgICB0aGlzLl9vbnJlcXVlc3QgPSBvbnJlcXVlc3QKICAgIHRoaXMuX29uZXJyb3IgPSB0aGlzLl9vbmVycm9yLmJpbmQodGhpcykKICAgIHRoaXMuX29uZGF0YSA9IHRoaXMuX29uZGF0YS5iaW5kKHRoaXMpCiAgICB0aGlzLl9vbmRyYWluID0gdGhpcy5fb25kcmFpbi5iaW5kKHRoaXMpCgogICAgdGhpcy5fc3RyZWFtCiAgICAgIC5vbignZXJyb3InLCB0aGlzLl9vbmVycm9yKQogICAgICAub24oJ2RhdGEnLCB0aGlzLl9vbmRhdGEpCiAgICAgIC5vbignZHJhaW4nLCB0aGlzLl9vbmRyYWluKQogIH0KCiAgcmVxdWVzdChjb21tYW5kKSB7CiAgICByZXR1cm4gbmV3IE91dGdvaW5nUmVxdWVzdCh0aGlzLCArK3RoaXMuX2lkLCBjb21tYW5kKQogIH0KCiAgX3NlbmRNZXNzYWdlKG1lc3NhZ2UsIGNiKSB7CiAgICBjb25zdCBoZWFkZXIgPSBjLmVuY29kZShtLmhlYWRlciwgbWVzc2FnZSkKCiAgICBsZXQgZmx1c2hlZCA9IHRoaXMuX3N0cmVhbS53cml0ZShoZWFkZXIpCgogICAgaWYgKG1lc3NhZ2UuZGF0YSkgZmx1c2hlZCA9IHRoaXMuX3N0cmVhbS53cml0ZShtZXNzYWdlLmRhdGEpCgogICAgaWYgKGNiKSB7CiAgICAgIGlmIChmbHVzaGVkKSBjYihudWxsKQogICAgICBlbHNlIHRoaXMuX2RyYWluaW5nLnB1c2goY2IpCiAgICB9CiAgfQoKICBfc2VuZFJlcXVlc3QocmVxdWVzdCwgZGF0YSA9IG51bGwpIHsKICAgIHRoaXMuX291dGdvaW5nUmVxdWVzdHMuc2V0KHJlcXVlc3QuaWQsIHJlcXVlc3QpCgogICAgdGhpcy5fc2VuZE1lc3NhZ2UoewogICAgICB0eXBlOiB0LlJFUVVFU1QsCiAgICAgIGlkOiByZXF1ZXN0LmlkLAogICAgICBjb21tYW5kOiByZXF1ZXN0LmNvbW1hbmQsCiAgICAgIHN0cmVhbTogMCwKICAgICAgZGF0YQogICAgfSkKICB9CgogIF9jcmVhdGVSZXF1ZXN0U3RyZWFtKHJlcXVlc3QsIGlzSW5pdGlhdG9yLCBvcHRzKSB7CiAgICBpZiAoaXNJbml0aWF0b3IpIHsKICAgICAgdGhpcy5fb3V0Z29pbmdSZXF1ZXN0cy5zZXQocmVxdWVzdC5pZCwgcmVxdWVzdCkKCiAgICAgIHJlcXVlc3QuX3JlcXVlc3RTdHJlYW0gPSBuZXcgT3V0Z29pbmdTdHJlYW0oCiAgICAgICAgdGhpcywKICAgICAgICByZXF1ZXN0LAogICAgICAgIHQuUkVRVUVTVCwKICAgICAgICBvcHRzCiAgICAgICkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2luY29taW5nUmVxdWVzdHMuc2V0KHJlcXVlc3QuaWQsIHJlcXVlc3QpCgogICAgICByZXF1ZXN0Ll9yZXF1ZXN0U3RyZWFtID0gbmV3IEluY29taW5nU3RyZWFtKAogICAgICAgIHRoaXMsCiAgICAgICAgcmVxdWVzdCwKICAgICAgICB0LlJFUVVFU1QsCiAgICAgICAgb3B0cwogICAgICApCgogICAgICByZXF1ZXN0Ll9yZXF1ZXN0U3RyZWFtLm9uKCdjbG9zZScsICgpID0+CiAgICAgICAgdGhpcy5faW5jb21pbmdSZXF1ZXN0cy5kZWxldGUocmVxdWVzdC5pZCkKICAgICAgKQogICAgfQogIH0KCiAgX3NlbmRSZXNwb25zZShyZXF1ZXN0LCBkYXRhKSB7CiAgICB0aGlzLl9zZW5kTWVzc2FnZSh7CiAgICAgIHR5cGU6IHQuUkVTUE9OU0UsCiAgICAgIGlkOiByZXF1ZXN0LmlkLAogICAgICBzdHJlYW06IDAsCiAgICAgIGVycm9yOiBudWxsLAogICAgICBkYXRhCiAgICB9KQogIH0KCiAgX2NyZWF0ZVJlc3BvbnNlU3RyZWFtKHJlcXVlc3QsIGlzSW5pdGlhdG9yLCBvcHRzKSB7CiAgICBpZiAoaXNJbml0aWF0b3IpIHsKICAgICAgdGhpcy5fb3V0Z29pbmdSZXNwb25zZXMuc2V0KHJlcXVlc3QuaWQsIHJlcXVlc3QpCgogICAgICByZXF1ZXN0Ll9yZXNwb25zZVN0cmVhbSA9IG5ldyBPdXRnb2luZ1N0cmVhbSgKICAgICAgICB0aGlzLAogICAgICAgIHJlcXVlc3QsCiAgICAgICAgdC5SRVNQT05TRSwKICAgICAgICBvcHRzCiAgICAgICkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2luY29taW5nUmVzcG9uc2VzLnNldChyZXF1ZXN0LmlkLCByZXF1ZXN0KQoKICAgICAgcmVxdWVzdC5fcmVzcG9uc2VTdHJlYW0gPSBuZXcgSW5jb21pbmdTdHJlYW0oCiAgICAgICAgdGhpcywKICAgICAgICByZXF1ZXN0LAogICAgICAgIHQuUkVTUE9OU0UsCiAgICAgICAgb3B0cwogICAgICApCgogICAgICByZXF1ZXN0Ll9yZXNwb25zZVN0cmVhbS5vbignY2xvc2UnLCAoKSA9PgogICAgICAgIHRoaXMuX2luY29taW5nUmVzcG9uc2VzLmRlbGV0ZShyZXF1ZXN0LmlkKQogICAgICApCiAgICB9CiAgfQoKICBfc2VuZEVycm9yKHJlcXVlc3QsIGVycikgewogICAgdGhpcy5fc2VuZE1lc3NhZ2UoewogICAgICB0eXBlOiB0LlJFU1BPTlNFLAogICAgICBpZDogcmVxdWVzdC5pZCwKICAgICAgc3RyZWFtOiAwLAogICAgICBlcnJvcjogZXJyLAogICAgICBkYXRhOiBudWxsCiAgICB9KQogIH0KCiAgX29uZXJyb3IoZXJyKSB7CiAgICB0aGlzLl9vbmRyYWluKGVycikKCiAgICAvLyBUT0RPIERlc3Ryb3kgcGVuZGluZyByZXF1ZXN0cyBhbmQgcmVzcG9uc2VzCiAgfQoKICBfb25kYXRhKGRhdGEpIHsKICAgIHRoaXMuX2J1ZmZlci5wdXNoKGRhdGEpCiAgICB0aGlzLl9idWZmZXJlZCArPSBkYXRhLmJ5dGVMZW5ndGgKCiAgICBpZiAodGhpcy5fZnJhbWUgPT09IC0xKSB7CiAgICAgIHRoaXMuX29uYmVmb3JlZnJhbWUoKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fb25hZnRlcmZyYW1lKCkKICAgIH0KICB9CgogIF9vbmJlZm9yZWZyYW1lKCkgewogICAgaWYgKHRoaXMuX2J1ZmZlcmVkIDwgNCkgcmV0dXJuCgogICAgY29uc3QgYnVmZmVyID0KICAgICAgdGhpcy5fYnVmZmVyLmxlbmd0aCA9PT0gMSA/IHRoaXMuX2J1ZmZlclswXSA6IGI0YS5jb25jYXQodGhpcy5fYnVmZmVyKQoKICAgIHRoaXMuX2J1ZmZlciA9IFtidWZmZXJdCiAgICB0aGlzLl9mcmFtZSA9IDQgKyBjLnVpbnQzMi5kZWNvZGUoYy5zdGF0ZSgwLCA0LCBidWZmZXIpKQoKICAgIHRoaXMuX29uYWZ0ZXJmcmFtZSgpCiAgfQoKICBfb25hZnRlcmZyYW1lKCkgewogICAgaWYgKHRoaXMuX2J1ZmZlcmVkIDwgdGhpcy5fZnJhbWUpIHJldHVybgoKICAgIGNvbnN0IGJ1ZmZlciA9CiAgICAgIHRoaXMuX2J1ZmZlci5sZW5ndGggPT09IDEgPyB0aGlzLl9idWZmZXJbMF0gOiBiNGEuY29uY2F0KHRoaXMuX2J1ZmZlcikKCiAgICBjb25zdCBmcmFtZSA9IHRoaXMuX2ZyYW1lCgogICAgdGhpcy5fYnVmZmVyZWQgLT0gZnJhbWUKICAgIHRoaXMuX2J1ZmZlciA9IHRoaXMuX2J1ZmZlcmVkID4gMCA/IFtidWZmZXIuc3ViYXJyYXkoZnJhbWUpXSA6IFtdCiAgICB0aGlzLl9mcmFtZSA9IC0xCgogICAgdGhpcy5fb25tZXNzYWdlKGJ1ZmZlci5zdWJhcnJheSgwLCBmcmFtZSkpCiAgICB0aGlzLl9vbmJlZm9yZWZyYW1lKCkKICB9CgogIGFzeW5jIF9vbm1lc3NhZ2UoYnVmZmVyKSB7CiAgICBsZXQgbWVzc2FnZQogICAgdHJ5IHsKICAgICAgbWVzc2FnZSA9IG0ubWVzc2FnZS5kZWNvZGUoYy5zdGF0ZSgwLCBidWZmZXIubGVuZ3RoLCBidWZmZXIpKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHNhZmV0eUNhdGNoKGVycikKCiAgICAgIHJldHVybiB0aGlzLl9zdHJlYW0uZGVzdHJveShlcnIpCiAgICB9CgogICAgc3dpdGNoIChtZXNzYWdlLnR5cGUpIHsKICAgICAgY2FzZSB0LlJFUVVFU1Q6CiAgICAgICAgY29uc3QgcmVxdWVzdCA9IG5ldyBJbmNvbWluZ1JlcXVlc3QoCiAgICAgICAgICB0aGlzLAogICAgICAgICAgbWVzc2FnZS5pZCwKICAgICAgICAgIG1lc3NhZ2UuY29tbWFuZCwKICAgICAgICAgIG1lc3NhZ2UuZGF0YQogICAgICAgICkKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF3YWl0IHRoaXMuX29ucmVxdWVzdChyZXF1ZXN0KQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgc2FmZXR5Q2F0Y2goZXJyKQoKICAgICAgICAgIHRoaXMuX3NlbmRFcnJvcihyZXF1ZXN0LCBlcnIpCiAgICAgICAgfQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgdC5SRVNQT05TRToKICAgICAgICB0cnkgewogICAgICAgICAgdGhpcy5fb25yZXNwb25zZShtZXNzYWdlKQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgICAgIH0KICAgICAgICBicmVhawogICAgICBjYXNlIHQuU1RSRUFNOgogICAgICAgIHRyeSB7CiAgICAgICAgICB0aGlzLl9vbnN0cmVhbShtZXNzYWdlKQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgICAgIH0KICAgIH0KICB9CgogIF9vbnJlc3BvbnNlKG1lc3NhZ2UpIHsKICAgIGlmIChtZXNzYWdlLmlkID09PSAwKSByZXR1cm4KCiAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fb3V0Z29pbmdSZXF1ZXN0cy5nZXQobWVzc2FnZS5pZCkKICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgIGlmIChtZXNzYWdlLmVycm9yKSB7CiAgICAgIHJlcXVlc3QuX3JlamVjdChtZXNzYWdlLmVycm9yKQogICAgfSBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSA9PT0gMCkgewogICAgICByZXF1ZXN0Ll9yZXNvbHZlKG1lc3NhZ2UuZGF0YSkKICAgIH0KICB9CgogIF9vbnN0cmVhbShtZXNzYWdlKSB7CiAgICBpZiAobWVzc2FnZS5pZCA9PT0gMCkgcmV0dXJuCgogICAgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5PUEVOKSB0aGlzLl9vbnN0cmVhbW9wZW4obWVzc2FnZSkKICAgIGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5DTE9TRSkgdGhpcy5fb25zdHJlYW1jbG9zZShtZXNzYWdlKQogICAgZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlBBVVNFKSB0aGlzLl9vbnN0cmVhbXBhdXNlKG1lc3NhZ2UpCiAgICBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVTVU1FKSB0aGlzLl9vbnN0cmVhbXJlc3VtZShtZXNzYWdlKQogICAgZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLkRBVEEpIHRoaXMuX29uc3RyZWFtZGF0YShtZXNzYWdlKQogICAgZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLkVORCkgdGhpcy5fb25zdHJlYW1lbmQobWVzc2FnZSkKICAgIGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5ERVNUUk9ZKSB0aGlzLl9vbnN0cmVhbWRlc3Ryb3kobWVzc2FnZSkKICB9CgogIF9vbnN0cmVhbW9wZW4obWVzc2FnZSkgewogICAgbGV0IHN0cmVhbQoKICAgIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVRVUVTVCkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fb3V0Z29pbmdSZXF1ZXN0cy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuX3BlbmRpbmdSZXF1ZXN0cy5hZGQobWVzc2FnZS5pZCkKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVxdWVzdFN0cmVhbQoKICAgICAgaWYgKHN0cmVhbS5fcGVuZGluZ09wZW4gPT09IG51bGwpIHsKICAgICAgICB0aGlzLl9wZW5kaW5nUmVxdWVzdHMuYWRkKG1lc3NhZ2UuaWQpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0gZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFU1BPTlNFKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9vdXRnb2luZ1Jlc3BvbnNlcy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuX3BlbmRpbmdSZXNwb25zZXMuYWRkKG1lc3NhZ2UuaWQpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3Jlc3BvbnNlU3RyZWFtCgogICAgICBpZiAoc3RyZWFtLl9wZW5kaW5nT3BlbiA9PT0gbnVsbCkgewogICAgICAgIHRoaXMuX3BlbmRpbmdSZXNwb25zZXMuYWRkKG1lc3NhZ2UuaWQpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIHN0cmVhbS5fY29udGludWVPcGVuKCkKICB9CgogIF9vbnN0cmVhbWNsb3NlKG1lc3NhZ2UpIHsKICAgIGxldCBzdHJlYW0KCiAgICBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFUVVFU1QpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX2luY29taW5nUmVxdWVzdHMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVxdWVzdFN0cmVhbQogICAgfSBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVTUE9OU0UpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX2luY29taW5nUmVzcG9uc2VzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3Jlc3BvbnNlU3RyZWFtCiAgICB9IGVsc2UgewogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAobWVzc2FnZS5lcnJvcikgc3RyZWFtLmRlc3Ryb3kobWVzc2FnZS5lcnJvcikKICAgIGVsc2Ugc3RyZWFtLnB1c2gobnVsbCkKICB9CgogIF9vbnN0cmVhbXBhdXNlKG1lc3NhZ2UpIHsKICAgIGxldCBzdHJlYW0KCiAgICBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFUVVFU1QpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX291dGdvaW5nUmVxdWVzdHMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVxdWVzdFN0cmVhbQogICAgfSBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVTUE9OU0UpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX291dGdvaW5nUmVzcG9uc2VzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3Jlc3BvbnNlU3RyZWFtCiAgICB9IGVsc2UgewogICAgICByZXR1cm4KICAgIH0KCiAgICBzdHJlYW0uY29yaygpCiAgfQoKICBfb25zdHJlYW1yZXN1bWUobWVzc2FnZSkgewogICAgbGV0IHN0cmVhbQoKICAgIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVRVUVTVCkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fb3V0Z29pbmdSZXF1ZXN0cy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXF1ZXN0U3RyZWFtCiAgICB9IGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVNQT05TRSkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fb3V0Z29pbmdSZXNwb25zZXMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVzcG9uc2VTdHJlYW0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIHN0cmVhbS51bmNvcmsoKQogIH0KCiAgX29uc3RyZWFtZGF0YShtZXNzYWdlKSB7CiAgICBsZXQgc3RyZWFtCgogICAgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVFVRVNUKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9pbmNvbWluZ1JlcXVlc3RzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3JlcXVlc3RTdHJlYW0KICAgIH0gZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFU1BPTlNFKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9pbmNvbWluZ1Jlc3BvbnNlcy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXNwb25zZVN0cmVhbQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHN0cmVhbS5wdXNoKG1lc3NhZ2UuZGF0YSkgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMuX3NlbmRNZXNzYWdlKHsKICAgICAgICB0eXBlOiB0LlNUUkVBTSwKICAgICAgICBpZDogc3RyZWFtLl9yZXF1ZXN0LmlkLAogICAgICAgIHN0cmVhbTogc3RyZWFtLl9tYXNrIHwgcy5QQVVTRSwKICAgICAgICBlcnJvcjogbnVsbCwKICAgICAgICBkYXRhOiBudWxsCiAgICAgIH0pCiAgICB9CiAgfQoKICBfb25zdHJlYW1lbmQobWVzc2FnZSkgewogICAgbGV0IHN0cmVhbQoKICAgIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVRVUVTVCkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5faW5jb21pbmdSZXF1ZXN0cy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXF1ZXN0U3RyZWFtCiAgICB9IGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVNQT05TRSkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5faW5jb21pbmdSZXNwb25zZXMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVzcG9uc2VTdHJlYW0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIHN0cmVhbS5wdXNoKG51bGwpCiAgfQoKICBfb25zdHJlYW1kZXN0cm95KG1lc3NhZ2UpIHsKICAgIGxldCBzdHJlYW0KCiAgICBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFUVVFU1QpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX291dGdvaW5nUmVxdWVzdHMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVxdWVzdFN0cmVhbQogICAgfSBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVTUE9OU0UpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX291dGdvaW5nUmVzcG9uc2VzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3Jlc3BvbnNlU3RyZWFtCiAgICB9IGVsc2UgewogICAgICByZXR1cm4KICAgIH0KCiAgICBzdHJlYW0uZGVzdHJveShtZXNzYWdlLmVycm9yKQogIH0KCiAgX29uZHJhaW4oZXJyID0gbnVsbCkgewogICAgY29uc3QgZHJhaW5pbmcgPSB0aGlzLl9kcmFpbmluZwoKICAgIHRoaXMuX2RyYWluaW5nID0gW10KCiAgICBmb3IgKGNvbnN0IGNiIG9mIGRyYWluaW5nKSBjYihlcnIpCiAgfQp9CgpleHBvcnRzLkNvbW1hbmRSb3V0ZXIgPSBDb21tYW5kUm91dGVyCgpmdW5jdGlvbiBub29wKCkge30KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSUENDb21tYW5kUm91dGVyIHsKICBjb25zdHJ1Y3RvcihvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgdmFsdWVFbmNvZGluZyA9IGMucmF3IH0gPSBvcHRzCgogICAgdGhpcy5fcmVzcG9uZGVycyA9IG5ldyBNYXAoKQogICAgdGhpcy5fZGVmYXVsdFZhbHVlRW5jb2RpbmcgPSB2YWx1ZUVuY29kaW5nCiAgfQoKICByZXNwb25kKGNvbW1hbmQsIG9wdHMgPSB7fSwgb25yZXF1ZXN0KSB7CiAgICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgb25yZXF1ZXN0ID0gb3B0cwogICAgICBvcHRzID0ge30KICAgIH0KCiAgICBjb25zdCB7CiAgICAgIHZhbHVlRW5jb2RpbmcgPSB0aGlzLl9kZWZhdWx0VmFsdWVFbmNvZGluZywKICAgICAgcmVxdWVzdEVuY29kaW5nID0gdmFsdWVFbmNvZGluZywKICAgICAgcmVzcG9uc2VFbmNvZGluZyA9IHZhbHVlRW5jb2RpbmcKICAgIH0gPSBvcHRzCgogICAgdGhpcy5fcmVzcG9uZGVycy5zZXQoY29tbWFuZCwgewogICAgICBvbnJlcXVlc3QsCiAgICAgIHJlcXVlc3RFbmNvZGluZywKICAgICAgcmVzcG9uc2VFbmNvZGluZwogICAgfSkKICB9CgogIGFzeW5jIF9vbnJlcXVlc3QocmVxKSB7CiAgICBjb25zdCByZXNwb25kZXIgPSB0aGlzLl9yZXNwb25kZXJzLmdldChyZXEuY29tbWFuZCkKCiAgICBpZiAocmVzcG9uZGVyID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgIGNvbnN0IHsgb25yZXF1ZXN0LCByZXF1ZXN0RW5jb2RpbmcsIHJlc3BvbnNlRW5jb2RpbmcgfSA9IHJlc3BvbmRlcgoKICAgIGxldCBkYXRhID0gcmVxLmRhdGEKCiAgICBpZiAocmVxdWVzdEVuY29kaW5nKSBkYXRhID0gYy5kZWNvZGUocmVxdWVzdEVuY29kaW5nLCBkYXRhKQoKICAgIGRhdGEgPSBhd2FpdCBvbnJlcXVlc3QocmVxLCBkYXRhKQoKICAgIGlmIChyZXEuc2VudCkgcmV0dXJuCgogICAgaWYgKHJlc3BvbnNlRW5jb2RpbmcpIGRhdGEgPSBjLmVuY29kZShyZXNwb25zZUVuY29kaW5nLCBkYXRhKQoKICAgIHJlcS5yZXBseShkYXRhKQogIH0KfQptb2R1bGUuZXhwb3J0cyA9IHsKICB0eXBlOiB7CiAgICBSRVFVRVNUOiAxLAogICAgUkVTUE9OU0U6IDIsCiAgICBTVFJFQU06IDMKICB9LAogIHN0cmVhbTogewogICAgT1BFTjogMHgxLAogICAgQ0xPU0U6IDB4MiwKICAgIFBBVVNFOiAweDQsCiAgICBSRVNVTUU6IDB4OCwKICAgIERBVEE6IDB4MTAsCiAgICBFTkQ6IDB4MjAsCiAgICBERVNUUk9ZOiAweDQwLAogICAgRVJST1I6IDB4ODAsCiAgICBSRVFVRVNUOiAweDEwMCwKICAgIFJFU1BPTlNFOiAweDIwMAogIH0KfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJQQ0Vycm9yIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yKG1zZywgY29kZSwgZm4gPSBSUENFcnJvcikgewogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWApCiAgICB0aGlzLmNvZGUgPSBjb2RlCgogICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIGZuKQogICAgfQogIH0KCiAgZ2V0IG5hbWUoKSB7CiAgICByZXR1cm4gJ1JQQ0Vycm9yJwogIH0KCiAgc3RhdGljIFVOS05PV05fTUVTU0FHRShtc2cpIHsKICAgIHJldHVybiBuZXcgUlBDRXJyb3IobXNnLCAnVU5LTk9XTl9NRVNTQUdFJywgUlBDRXJyb3IuVU5LTk9XTl9NRVNTQUdFKQogIH0KCiAgc3RhdGljIEFMUkVBRFlfU0VOVChtc2cpIHsKICAgIHJldHVybiBuZXcgUlBDRXJyb3IobXNnLCAnQUxSRUFEWV9TRU5UJywgUlBDRXJyb3IuQUxSRUFEWV9TRU5UKQogIH0KCiAgc3RhdGljIEFMUkVBRFlfUkVDRUlWRUQobXNnKSB7CiAgICByZXR1cm4gbmV3IFJQQ0Vycm9yKG1zZywgJ0FMUkVBRFlfUkVDRUlWRUQnLCBSUENFcnJvci5BTFJFQURZX1JFQ0VJVkVEKQogIH0KfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4vZXJyb3JzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUlBDSW5jb21pbmdSZXF1ZXN0IHsKICBjb25zdHJ1Y3RvcihycGMsIGlkLCBjb21tYW5kLCBkYXRhKSB7CiAgICB0aGlzLnJwYyA9IHJwYwogICAgdGhpcy5pZCA9IGlkCiAgICB0aGlzLmNvbW1hbmQgPSBjb21tYW5kCiAgICB0aGlzLmRhdGEgPSBkYXRhCiAgICB0aGlzLnNlbnQgPSBmYWxzZQogICAgdGhpcy5yZWNlaXZlZCA9IGZhbHNlCgogICAgdGhpcy5fcmVxdWVzdFN0cmVhbSA9IG51bGwKICAgIHRoaXMuX3Jlc3BvbnNlU3RyZWFtID0gbnVsbAogIH0KCiAgcmVwbHkoZGF0YSwgZW5jb2RpbmcpIHsKICAgIGlmICh0aGlzLnNlbnQpIHsKICAgICAgdGhyb3cgZXJyb3JzLkFMUkVBRFlfU0VOVCgnUmVzcG9uc2UgaGFzIGFscmVhZHkgYmVlbiBzZW50JykKICAgIH0KCiAgICBlbmNvZGluZyA9CiAgICAgIGVuY29kaW5nICYmIGVuY29kaW5nICE9PSAnYnVmZmVyJwogICAgICAgID8gYy5mcm9tKGVuY29kaW5nKQogICAgICAgIDogdHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnCiAgICAgICAgICA/IGMucmF3LnV0ZjgKICAgICAgICAgIDogbnVsbAoKICAgIHRoaXMuc2VudCA9IHRydWUKCiAgICB0aGlzLnJwYy5fc2VuZFJlc3BvbnNlKHRoaXMsIGVuY29kaW5nID8gYy5lbmNvZGUoZW5jb2RpbmcsIGRhdGEpIDogZGF0YSkKICB9CgogIGNyZWF0ZVJlc3BvbnNlU3RyZWFtKG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMuc2VudCkgewogICAgICB0aHJvdyBlcnJvcnMuQUxSRUFEWV9TRU5UKCdSZXNwb25zZSBoYXMgYWxyZWFkeSBiZWVuIHNlbnQnKQogICAgfQoKICAgIHRoaXMuc2VudCA9IHRydWUKCiAgICB0aGlzLnJwYy5fY3JlYXRlUmVzcG9uc2VTdHJlYW0odGhpcywgdHJ1ZSwgb3B0cykKCiAgICByZXR1cm4gdGhpcy5fcmVzcG9uc2VTdHJlYW0KICB9CgogIGNyZWF0ZVJlcXVlc3RTdHJlYW0ob3B0cyA9IHt9KSB7CiAgICBpZiAodGhpcy5yZWNlaXZlZCkgewogICAgICB0aHJvdyBlcnJvcnMuQUxSRUFEWV9SRUNFSVZFRCgnUmVxdWVzdCBoYXMgYWxyZWFkeSBiZWVuIHJlY2VpdmVkJykKICAgIH0KCiAgICB0aGlzLnJlY2VpdmVkID0gdHJ1ZQoKICAgIHRoaXMucnBjLl9jcmVhdGVSZXF1ZXN0U3RyZWFtKHRoaXMsIGZhbHNlLCBvcHRzKQoKICAgIHJldHVybiB0aGlzLl9yZXF1ZXN0U3RyZWFtCiAgfQp9CmNvbnN0IHsgUmVhZGFibGUgfSA9IHJlcXVpcmUoJ2JhcmUtc3RyZWFtJykKY29uc3QgeyB0eXBlOiB0LCBzdHJlYW06IHMgfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUlBDSW5jb21pbmdTdHJlYW0gZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3IocnBjLCByZXF1ZXN0LCB0eXBlLCBvcHRzKSB7CiAgICBzdXBlcih7IC4uLm9wdHMsIGVhZ2VyT3BlbjogdHJ1ZSB9KQoKICAgIHRoaXMuX3JwYyA9IHJwYwogICAgdGhpcy5fcmVxdWVzdCA9IHJlcXVlc3QKICAgIHRoaXMuX3R5cGUgPSB0eXBlCiAgICB0aGlzLl9tYXNrID0gdHlwZSA9PT0gdC5SRVFVRVNUID8gcy5SRVFVRVNUIDogcy5SRVNQT05TRQogIH0KCiAgX29wZW4oY2IpIHsKICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgIHsKICAgICAgICB0eXBlOiB0LlNUUkVBTSwKICAgICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgICBzdHJlYW06IHRoaXMuX21hc2sgfCBzLk9QRU4sCiAgICAgICAgZXJyb3I6IG51bGwsCiAgICAgICAgZGF0YTogbnVsbAogICAgICB9LAogICAgICBjYgogICAgKQogIH0KCiAgX3JlYWQoKSB7CiAgICB0aGlzLl9ycGMuX3NlbmRNZXNzYWdlKHsKICAgICAgdHlwZTogdC5TVFJFQU0sCiAgICAgIGlkOiB0aGlzLl9yZXF1ZXN0LmlkLAogICAgICBzdHJlYW06IHRoaXMuX21hc2sgfCBzLlJFU1VNRSwKICAgICAgZXJyb3I6IG51bGwsCiAgICAgIGRhdGE6IG51bGwKICAgIH0pCiAgfQoKICBfZGVzdHJveShlcnIsIGNiKSB7CiAgICBpZiAoZXJyKSB7CiAgICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgICAgewogICAgICAgICAgdHlwZTogdC5TVFJFQU0sCiAgICAgICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgICAgIHN0cmVhbTogdGhpcy5fbWFzayB8IHMuREVTVFJPWSB8IHMuRVJST1IsCiAgICAgICAgICBlcnJvcjogZXJyLAogICAgICAgICAgZGF0YTogbnVsbAogICAgICAgIH0sCiAgICAgICAgY2IKICAgICAgKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fcnBjLl9zZW5kTWVzc2FnZSgKICAgICAgICB7CiAgICAgICAgICB0eXBlOiB0LlNUUkVBTSwKICAgICAgICAgIGlkOiB0aGlzLl9yZXF1ZXN0LmlkLAogICAgICAgICAgc3RyZWFtOiB0aGlzLl9tYXNrIHwgcy5ERVNUUk9ZLAogICAgICAgICAgZXJyb3I6IG51bGwsCiAgICAgICAgICBkYXRhOiBudWxsCiAgICAgICAgfSwKICAgICAgICBjYgogICAgICApCiAgICB9CiAgfQp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgeyB0eXBlOiB0LCBzdHJlYW06IHMgfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi9lcnJvcnMnKQoKY29uc3QgZXJyb3IgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnV0ZjgucHJlZW5jb2RlKHN0YXRlLCBtLm1lc3NhZ2UpCiAgICBjLnV0ZjgucHJlZW5jb2RlKHN0YXRlLCBTdHJpbmcobS5jb2RlKSB8fCAnJykKICAgIGMuaW50LnByZWVuY29kZShzdGF0ZSwgTnVtYmVyKG0uZXJybm8pIHx8IDApCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudXRmOC5lbmNvZGUoc3RhdGUsIG0ubWVzc2FnZSkKICAgIGMudXRmOC5lbmNvZGUoc3RhdGUsIFN0cmluZyhtLmNvZGUpIHx8ICcnKQogICAgYy5pbnQuZW5jb2RlKHN0YXRlLCBOdW1iZXIobS5lcnJubykgfHwgMCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZXJyID0gbmV3IEVycm9yKGAke2MudXRmOC5kZWNvZGUoc3RhdGUpfWApCiAgICBlcnIuY29kZSA9IGMudXRmOC5kZWNvZGUoc3RhdGUpCiAgICBlcnIuZXJybm8gPSBjLmludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gZXJyCiAgfQp9CgpleHBvcnRzLmhlYWRlciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludDMyLnByZWVuY29kZShzdGF0ZSwgMCkgLy8gRnJhbWUKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udHlwZSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uaWQpCgogICAgbGV0IGhhc0RhdGEgPSBmYWxzZQoKICAgIHN3aXRjaCAobS50eXBlKSB7CiAgICAgIGNhc2UgdC5SRVFVRVNUOgogICAgICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uY29tbWFuZCkKICAgICAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0cmVhbSkKICAgICAgICBpZiAobS5zdHJlYW0gPT09IDApIGhhc0RhdGEgPSB0cnVlCiAgICAgICAgYnJlYWsKCiAgICAgIGNhc2UgdC5SRVNQT05TRToKICAgICAgICBjLmJvb2wucHJlZW5jb2RlKHN0YXRlLCAhIW0uZXJyb3IpCiAgICAgICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdHJlYW0pCgogICAgICAgIGlmIChtLmVycm9yKSBlcnJvci5wcmVlbmNvZGUoc3RhdGUsIG0uZXJyb3IpCiAgICAgICAgZWxzZSBpZiAobS5zdHJlYW0gPT09IDApIGhhc0RhdGEgPSB0cnVlCiAgICAgICAgYnJlYWsKCiAgICAgIGNhc2UgdC5TVFJFQU06CiAgICAgICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdHJlYW0pCgogICAgICAgIGlmIChtLnN0cmVhbSAmIHMuRVJST1IpIGVycm9yLnByZWVuY29kZShzdGF0ZSwgbS5lcnJvcikKICAgICAgICBlbHNlIGlmIChtLnN0cmVhbSAmIHMuREFUQSkgaGFzRGF0YSA9IHRydWUKICAgICAgICBicmVhawogICAgfQoKICAgIGlmIChoYXNEYXRhKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmRhdGEgPyBtLmRhdGEuYnl0ZUxlbmd0aCA6IDApCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZyYW1lID0gc3RhdGUuc3RhcnQKCiAgICBjLnVpbnQzMi5lbmNvZGUoc3RhdGUsIDApIC8vIEZyYW1lCgogICAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udHlwZSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uaWQpCgogICAgbGV0IGhhc0RhdGEgPSBmYWxzZQoKICAgIHN3aXRjaCAobS50eXBlKSB7CiAgICAgIGNhc2UgdC5SRVFVRVNUOgogICAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uY29tbWFuZCkKICAgICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0cmVhbSkKICAgICAgICBpZiAobS5zdHJlYW0gPT09IDApIGhhc0RhdGEgPSB0cnVlCiAgICAgICAgYnJlYWsKCiAgICAgIGNhc2UgdC5SRVNQT05TRToKICAgICAgICBjLmJvb2wuZW5jb2RlKHN0YXRlLCAhIW0uZXJyb3IpCiAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdHJlYW0pCgogICAgICAgIGlmIChtLmVycm9yKSBlcnJvci5lbmNvZGUoc3RhdGUsIG0uZXJyb3IpCiAgICAgICAgZWxzZSBpZiAobS5zdHJlYW0gPT09IDApIGhhc0RhdGEgPSB0cnVlCiAgICAgICAgYnJlYWsKCiAgICAgIGNhc2UgdC5TVFJFQU06CiAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdHJlYW0pCgogICAgICAgIGlmIChtLnN0cmVhbSAmIHMuRVJST1IpIGVycm9yLmVuY29kZShzdGF0ZSwgbS5lcnJvcikKICAgICAgICBlbHNlIGlmIChtLnN0cmVhbSAmIHMuREFUQSkgaGFzRGF0YSA9IHRydWUKICAgICAgICBicmVhawogICAgfQoKICAgIGlmIChoYXNEYXRhKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmRhdGEgPyBtLmRhdGEuYnl0ZUxlbmd0aCA6IDApCgogICAgY29uc3QgZW5kID0gc3RhdGUuc3RhcnQKCiAgICBzdGF0ZS5zdGFydCA9IGZyYW1lCgogICAgYy51aW50MzIuZW5jb2RlKAogICAgICBzdGF0ZSwKICAgICAgZW5kIC0gc3RhcnQgKyAoaGFzRGF0YSAmJiBtLmRhdGEgPyBtLmRhdGEuYnl0ZUxlbmd0aCA6IDApCiAgICApCgogICAgc3RhdGUuc3RhcnQgPSBlbmQKICB9Cn0KCmV4cG9ydHMubWVzc2FnZSA9IHsKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZyYW1lID0gYy51aW50MzIuZGVjb2RlKHN0YXRlKQoKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IGZyYW1lKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignT3V0IG9mIGJvdW5kcycpCgogICAgY29uc3QgdHlwZSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBpZCA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgdC5SRVFVRVNUOiB7CiAgICAgICAgY29uc3QgY29tbWFuZCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICAgICAgY29uc3Qgc3RyZWFtID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgICAgICBjb25zdCBkYXRhID0gc3RyZWFtID09PSAwID8gYy5idWZmZXIuZGVjb2RlKHN0YXRlKSA6IG51bGwKCiAgICAgICAgcmV0dXJuIHsgdHlwZSwgaWQsIGNvbW1hbmQsIHN0cmVhbSwgZGF0YSB9CiAgICAgIH0KCiAgICAgIGNhc2UgdC5SRVNQT05TRTogewogICAgICAgIGNvbnN0IGVyciA9IGMuYm9vbC5kZWNvZGUoc3RhdGUpCiAgICAgICAgY29uc3Qgc3RyZWFtID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgcmV0dXJuIHsgdHlwZSwgaWQsIHN0cmVhbSwgZXJyb3I6IGVycm9yLmRlY29kZShzdGF0ZSksIGRhdGE6IG51bGwgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHN0cmVhbSA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHsgdHlwZSwgaWQsIHN0cmVhbSwgZXJyb3I6IG51bGwsIGRhdGE6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsgdHlwZSwgaWQsIHN0cmVhbSwgZXJyb3I6IG51bGwsIGRhdGE6IG51bGwgfQogICAgICB9CgogICAgICBjYXNlIHQuU1RSRUFNOgogICAgICAgIGNvbnN0IHN0cmVhbSA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgICAgIGlmIChzdHJlYW0gJiBzLkVSUk9SKSB7CiAgICAgICAgICByZXR1cm4geyB0eXBlLCBpZCwgc3RyZWFtLCBlcnJvcjogZXJyb3IuZGVjb2RlKHN0YXRlKSwgZGF0YTogbnVsbCB9CiAgICAgICAgfQoKICAgICAgICBpZiAoc3RyZWFtICYgcy5EQVRBKSB7CiAgICAgICAgICByZXR1cm4geyB0eXBlLCBpZCwgc3RyZWFtLCBlcnJvcjogbnVsbCwgZGF0YTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKSB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4geyB0eXBlLCBpZCwgc3RyZWFtLCBlcnJvcjogbnVsbCwgZGF0YTogbnVsbCB9CgogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IGVycm9ycy5VTktOT1dOX01FU1NBR0UoYFVua25vd24gbWVzc2FnZSAnJHt0eXBlfSdgKQogICAgfQogIH0KfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4vZXJyb3JzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUlBDT3V0Z29pbmdSZXF1ZXN0IHsKICBjb25zdHJ1Y3RvcihycGMsIGlkLCBjb21tYW5kKSB7CiAgICB0aGlzLnJwYyA9IHJwYwogICAgdGhpcy5pZCA9IGlkCiAgICB0aGlzLmNvbW1hbmQgPSBjb21tYW5kCiAgICB0aGlzLnNlbnQgPSBmYWxzZQogICAgdGhpcy5yZWNlaXZlZCA9IGZhbHNlCgogICAgdGhpcy5fcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgdGhpcy5fcmVzb2x2ZSA9IHJlc29sdmUKICAgICAgdGhpcy5fcmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIHRoaXMuX3JlcXVlc3RTdHJlYW0gPSBudWxsCiAgICB0aGlzLl9yZXNwb25zZVN0cmVhbSA9IG51bGwKICB9CgogIHNlbmQoZGF0YSwgZW5jb2RpbmcpIHsKICAgIGlmICh0aGlzLnNlbnQpIHsKICAgICAgdGhyb3cgZXJyb3JzLkFMUkVBRFlfU0VOVCgnUmVxdWVzdCBoYXMgYWxyZWFkeSBiZWVuIHNlbnQnKQogICAgfQoKICAgIGVuY29kaW5nID0KICAgICAgZW5jb2RpbmcgJiYgZW5jb2RpbmcgIT09ICdidWZmZXInCiAgICAgICAgPyBjLmZyb20oZW5jb2RpbmcpCiAgICAgICAgOiB0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycKICAgICAgICAgID8gYy5yYXcudXRmOAogICAgICAgICAgOiBudWxsCgogICAgdGhpcy5zZW50ID0gdHJ1ZQoKICAgIHRoaXMucnBjLl9zZW5kUmVxdWVzdCh0aGlzLCBlbmNvZGluZyA/IGMuZW5jb2RlKGVuY29kaW5nLCBkYXRhKSA6IGRhdGEpCiAgfQoKICByZXBseShlbmNvZGluZykgewogICAgaWYgKHRoaXMucmVjZWl2ZWQpIHsKICAgICAgdGhyb3cgZXJyb3JzLkFMUkVBRFlfUkVDRUlWRUQoJ1Jlc3BvbnNlIGlzIGFscmVhZHkgYmVpbmcgcmVjZWl2ZWQnKQogICAgfQoKICAgIGVuY29kaW5nID0gZW5jb2RpbmcgJiYgZW5jb2RpbmcgIT09ICdidWZmZXInID8gYy5mcm9tKGVuY29kaW5nKSA6IG51bGwKCiAgICB0aGlzLnJlY2VpdmVkID0gdHJ1ZQoKICAgIHJldHVybiBlbmNvZGluZwogICAgICA/IHRoaXMuX3Byb21pc2UudGhlbigoZGF0YSkgPT4gYy5kZWNvZGUoZW5jb2RpbmcsIGRhdGEpKQogICAgICA6IHRoaXMuX3Byb21pc2UKICB9CgogIGNyZWF0ZVJlcXVlc3RTdHJlYW0ob3B0cyA9IHt9KSB7CiAgICBpZiAodGhpcy5zZW50KSB7CiAgICAgIHRocm93IGVycm9ycy5BTFJFQURZX1NFTlQoJ1JlcXVlc3QgaGFzIGFscmVhZHkgYmVlbiBzZW50JykKICAgIH0KCiAgICB0aGlzLnNlbnQgPSB0cnVlCgogICAgdGhpcy5ycGMuX2NyZWF0ZVJlcXVlc3RTdHJlYW0odGhpcywgdHJ1ZSwgb3B0cykKCiAgICByZXR1cm4gdGhpcy5fcmVxdWVzdFN0cmVhbQogIH0KCiAgY3JlYXRlUmVzcG9uc2VTdHJlYW0ob3B0cyA9IHt9KSB7CiAgICBpZiAodGhpcy5yZWNlaXZlZCkgewogICAgICB0aHJvdyBlcnJvcnMuQUxSRUFEWV9SRUNFSVZFRCgnUmVzcG9uc2UgaGFzIGFscmVhZHkgYmVlbiByZWNlaXZlZCcpCiAgICB9CgogICAgdGhpcy5yZWNlaXZlZCA9IHRydWUKCiAgICB0aGlzLnJwYy5fY3JlYXRlUmVzcG9uc2VTdHJlYW0odGhpcywgZmFsc2UsIG9wdHMpCgogICAgcmV0dXJuIHRoaXMuX3Jlc3BvbnNlU3RyZWFtCiAgfQp9CmNvbnN0IHsgV3JpdGFibGUgfSA9IHJlcXVpcmUoJ2JhcmUtc3RyZWFtJykKY29uc3QgeyB0eXBlOiB0LCBzdHJlYW06IHMgfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUlBDT3V0Z29pbmdTdHJlYW0gZXh0ZW5kcyBXcml0YWJsZSB7CiAgY29uc3RydWN0b3IocnBjLCByZXF1ZXN0LCB0eXBlLCBvcHRzKSB7CiAgICBzdXBlcih7IC4uLm9wdHMsIGVhZ2VyT3BlbjogdHJ1ZSB9KQoKICAgIHRoaXMuX3JwYyA9IHJwYwogICAgdGhpcy5fcmVxdWVzdCA9IHJlcXVlc3QKICAgIHRoaXMuX3R5cGUgPSB0eXBlCiAgICB0aGlzLl9tYXNrID0gdHlwZSA9PT0gdC5SRVFVRVNUID8gcy5SRVFVRVNUIDogcy5SRVNQT05TRQoKICAgIHRoaXMuX3BlbmRpbmdPcGVuID0gbnVsbAogIH0KCiAgX29wZW4oY2IpIHsKICAgIGxldCBwZW5kaW5nCgogICAgY29uc3Qgb25mbHVzaGVkID0gKCkgPT4gewogICAgICBpZiAocGVuZGluZy5oYXModGhpcy5fcmVxdWVzdC5pZCkpIHsKICAgICAgICBwZW5kaW5nLmRlbGV0ZSh0aGlzLl9yZXF1ZXN0LmlkKQoKICAgICAgICBjYihudWxsKQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3BlbmRpbmdPcGVuID0gY2IKICAgICAgfQogICAgfQoKICAgIHN3aXRjaCAodGhpcy5fdHlwZSkgewogICAgICBjYXNlIHQuUkVRVUVTVDoKICAgICAgICBwZW5kaW5nID0gdGhpcy5fcnBjLl9wZW5kaW5nUmVxdWVzdHMKCiAgICAgICAgdGhpcy5fcnBjLl9zZW5kTWVzc2FnZSgKICAgICAgICAgIHsKICAgICAgICAgICAgdHlwZTogdC5SRVFVRVNULAogICAgICAgICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgICAgICAgY29tbWFuZDogdGhpcy5fcmVxdWVzdC5jb21tYW5kLAogICAgICAgICAgICBzdHJlYW06IHMuT1BFTiwKICAgICAgICAgICAgZGF0YTogbnVsbAogICAgICAgICAgfSwKICAgICAgICAgIG9uZmx1c2hlZAogICAgICAgICkKICAgICAgICBicmVhawoKICAgICAgY2FzZSB0LlJFU1BPTlNFOgogICAgICAgIHBlbmRpbmcgPSB0aGlzLl9ycGMuX3BlbmRpbmdSZXNwb25zZXMKCiAgICAgICAgdGhpcy5fcnBjLl9zZW5kTWVzc2FnZSgKICAgICAgICAgIHsKICAgICAgICAgICAgdHlwZTogdC5SRVNQT05TRSwKICAgICAgICAgICAgaWQ6IHRoaXMuX3JlcXVlc3QuaWQsCiAgICAgICAgICAgIGVycm9yOiBmYWxzZSwKICAgICAgICAgICAgc3RyZWFtOiBzLk9QRU4sCiAgICAgICAgICAgIGRhdGE6IG51bGwKICAgICAgICAgIH0sCiAgICAgICAgICBvbmZsdXNoZWQKICAgICAgICApCiAgICAgICAgYnJlYWsKICAgIH0KICB9CgogIF9jb250aW51ZU9wZW4oKSB7CiAgICBpZiAodGhpcy5fcGVuZGluZ09wZW4gPT09IG51bGwpIHJldHVybgogICAgY29uc3QgY2IgPSB0aGlzLl9wZW5kaW5nT3BlbgogICAgdGhpcy5fcGVuZGluZ09wZW4gPSBudWxsCiAgICBjYigpCiAgfQoKICBfd3JpdGUoZGF0YSwgZW5jb2RpbmcsIGNiKSB7CiAgICB0aGlzLl9ycGMuX3NlbmRNZXNzYWdlKAogICAgICB7CiAgICAgICAgdHlwZTogdC5TVFJFQU0sCiAgICAgICAgaWQ6IHRoaXMuX3JlcXVlc3QuaWQsCiAgICAgICAgc3RyZWFtOiB0aGlzLl9tYXNrIHwgcy5EQVRBLAogICAgICAgIGVycm9yOiBudWxsLAogICAgICAgIGRhdGEKICAgICAgfSwKICAgICAgY2IKICAgICkKICB9CgogIF9maW5hbChjYikgewogICAgdGhpcy5fcnBjLl9zZW5kTWVzc2FnZSgKICAgICAgewogICAgICAgIHR5cGU6IHQuU1RSRUFNLAogICAgICAgIGlkOiB0aGlzLl9yZXF1ZXN0LmlkLAogICAgICAgIHN0cmVhbTogdGhpcy5fbWFzayB8IHMuRU5ELAogICAgICAgIGVycm9yOiBudWxsLAogICAgICAgIGRhdGE6IG51bGwKICAgICAgfSwKICAgICAgY2IKICAgICkKICB9CgogIF9kZXN0cm95KGVyciwgY2IpIHsKICAgIGlmIChlcnIpIHsKICAgICAgdGhpcy5fcnBjLl9zZW5kTWVzc2FnZSgKICAgICAgICB7CiAgICAgICAgICB0eXBlOiB0LlNUUkVBTSwKICAgICAgICAgIGlkOiB0aGlzLl9yZXF1ZXN0LmlkLAogICAgICAgICAgc3RyZWFtOiB0aGlzLl9tYXNrIHwgcy5DTE9TRSB8IHMuRVJST1IsCiAgICAgICAgICBlcnJvcjogZXJyLAogICAgICAgICAgZGF0YTogbnVsbAogICAgICAgIH0sCiAgICAgICAgY2IKICAgICAgKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fcnBjLl9zZW5kTWVzc2FnZSgKICAgICAgICB7CiAgICAgICAgICB0eXBlOiB0LlNUUkVBTSwKICAgICAgICAgIGlkOiB0aGlzLl9yZXF1ZXN0LmlkLAogICAgICAgICAgc3RyZWFtOiB0aGlzLl9tYXNrIHwgcy5DTE9TRSwKICAgICAgICAgIGVycm9yOiBudWxsLAogICAgICAgICAgZGF0YTogbnVsbAogICAgICAgIH0sCiAgICAgICAgY2IKICAgICAgKQogICAgfQogIH0KfQp7CiAgIm5hbWUiOiAiYmFyZS1ycGMiLAogICJ2ZXJzaW9uIjogIjAuMi4xMyIsCiAgImRlc2NyaXB0aW9uIjogImxpYnJwYyBBQkkgY29tcGF0aWJsZSBSUEMgZm9yIEJhcmUiLAogICJleHBvcnRzIjogewogICAgIi4iOiB7CiAgICAgICJ0eXBlcyI6ICIuL2luZGV4LmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2luZGV4LmpzIgogICAgfSwKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4vZXJyb3JzIjogewogICAgICAidHlwZXMiOiAiLi9saWIvZXJyb3JzLmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2xpYi9lcnJvcnMuanMiCiAgICB9CiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImluZGV4LmQudHMiLAogICAgImxpYiIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJhcmUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXJwYy5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXJwYy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtcnBjI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi42IiwKICAgICJiYXJlLXN0cmVhbSI6ICJeMi4xLjMiLAogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuMTUuMCIsCiAgICAic2FmZXR5LWNhdGNoIjogIl4xLjAuMiIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1idWZmZXIiOiAiXjMuMC4xIiwKICAgICJiYXJlLWlwYyI6ICJeMS4xLjAiLAogICAgImJyaXR0bGUiOiAiXjMuMi4xIiwKICAgICJwcmV0dGllciI6ICJeMy40LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1zdGFuZGFyZCI6ICJeNy4wLjAiCiAgfSwKICAicGVlckRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWJ1ZmZlciI6ICIqIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXNNZXRhIjogewogICAgImJhcmUtYnVmZmVyIjogewogICAgICAib3B0aW9uYWwiOiB0cnVlCiAgICB9CiAgfQp9CmNvbnN0IHN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQoKY29uc3QgZGVmYXVsdEVuY29kaW5nID0gJ3V0ZjgnCgptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBzdHJlYW0uU3RyZWFtCgpleHBvcnRzLnBpcGVsaW5lID0gc3RyZWFtLnBpcGVsaW5lCgpleHBvcnRzLmlzU3RyZWFtID0gc3RyZWFtLmlzU3RyZWFtCmV4cG9ydHMuaXNFbmRlZCA9IHN0cmVhbS5pc0VuZGVkCmV4cG9ydHMuaXNGaW5pc2hlZCA9IHN0cmVhbS5pc0ZpbmlzaGVkCmV4cG9ydHMuaXNEaXN0dXJiZWQgPSBzdHJlYW0uaXNEaXN0dXJiZWQKCmV4cG9ydHMuZ2V0U3RyZWFtRXJyb3IgPSBzdHJlYW0uZ2V0U3RyZWFtRXJyb3IKCmV4cG9ydHMuU3RyZWFtID0gZXhwb3J0cwoKZXhwb3J0cy5SZWFkYWJsZSA9IGNsYXNzIFJlYWRhYmxlIGV4dGVuZHMgc3RyZWFtLlJlYWRhYmxlIHsKICBjb25zdHJ1Y3RvcihvcHRzID0ge30pIHsKICAgIHN1cGVyKHsKICAgICAgLi4ub3B0cywKICAgICAgYnl0ZUxlbmd0aDogbnVsbCwKICAgICAgYnl0ZUxlbmd0aFJlYWRhYmxlOiBudWxsLAogICAgICBtYXA6IG51bGwsCiAgICAgIG1hcFJlYWRhYmxlOiBudWxsCiAgICB9KQoKICAgIGlmICh0aGlzLl9jb25zdHJ1Y3QpIHRoaXMuX29wZW4gPSB0aGlzLl9jb25zdHJ1Y3QKCiAgICBpZiAodGhpcy5fcmVhZCAhPT0gc3RyZWFtLlJlYWRhYmxlLnByb3RvdHlwZS5fcmVhZCkgewogICAgICB0aGlzLl9yZWFkID0gcmVhZC5iaW5kKHRoaXMsIHRoaXMuX3JlYWQpCiAgICB9CgogICAgaWYgKHRoaXMuX2Rlc3Ryb3kgIT09IHN0cmVhbS5TdHJlYW0ucHJvdG90eXBlLl9kZXN0cm95KSB7CiAgICAgIHRoaXMuX2Rlc3Ryb3kgPSBkZXN0cm95LmJpbmQodGhpcywgdGhpcy5fZGVzdHJveSkKICAgIH0KICB9CgogIHB1c2goY2h1bmssIGVuY29kaW5nKSB7CiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcpCiAgICB9CgogICAgcmV0dXJuIHN1cGVyLnB1c2goY2h1bmspCiAgfQoKICB1bnNoaWZ0KGNodW5rLCBlbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nKQogICAgfQoKICAgIHN1cGVyLnVuc2hpZnQoY2h1bmspCiAgfQp9CgpleHBvcnRzLldyaXRhYmxlID0gY2xhc3MgV3JpdGFibGUgZXh0ZW5kcyBzdHJlYW0uV3JpdGFibGUgewogIGNvbnN0cnVjdG9yKG9wdHMgPSB7fSkgewogICAgc3VwZXIoewogICAgICAuLi5vcHRzLAogICAgICBieXRlTGVuZ3RoOiBudWxsLAogICAgICBieXRlTGVuZ3RoV3JpdGFibGUsCiAgICAgIG1hcDogbnVsbCwKICAgICAgbWFwV3JpdGFibGU6IG51bGwKICAgIH0pCgogICAgaWYgKHRoaXMuX2NvbnN0cnVjdCkgdGhpcy5fb3BlbiA9IHRoaXMuX2NvbnN0cnVjdAoKICAgIGlmICh0aGlzLl93cml0ZSAhPT0gc3RyZWFtLldyaXRhYmxlLnByb3RvdHlwZS5fd3JpdGUpIHsKICAgICAgdGhpcy5fd3JpdGUgPSB3cml0ZS5iaW5kKHRoaXMsIHRoaXMuX3dyaXRlKQogICAgfQoKICAgIGlmICh0aGlzLl9kZXN0cm95ICE9PSBzdHJlYW0uU3RyZWFtLnByb3RvdHlwZS5fZGVzdHJveSkgewogICAgICB0aGlzLl9kZXN0cm95ID0gZGVzdHJveS5iaW5kKHRoaXMsIHRoaXMuX2Rlc3Ryb3kpCiAgICB9CiAgfQoKICB3cml0ZShjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgICBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gZW5jb2RpbmcKICAgICAgZW5jb2RpbmcgPSBudWxsCiAgICB9CgogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcpCiAgICB9IGVsc2UgewogICAgICBlbmNvZGluZyA9ICdidWZmZXInCiAgICB9CgogICAgY29uc3QgcmVzdWx0ID0gc3VwZXIud3JpdGUoeyBjaHVuaywgZW5jb2RpbmcgfSkKCiAgICBpZiAoY2IpIHN0cmVhbS5Xcml0YWJsZS5kcmFpbmVkKHRoaXMpLnRoZW4oKCkgPT4gY2IobnVsbCksIGNiKQoKICAgIHJldHVybiByZXN1bHQKICB9CgogIGVuZChjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gY2h1bmsKICAgICAgY2h1bmsgPSBudWxsCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGVuY29kaW5nCiAgICAgIGVuY29kaW5nID0gbnVsbAogICAgfQoKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nCiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZykKICAgIH0gZWxzZSB7CiAgICAgIGVuY29kaW5nID0gJ2J1ZmZlcicKICAgIH0KCiAgICBjb25zdCByZXN1bHQgPQogICAgICBjaHVuayAhPT0gdW5kZWZpbmVkICYmIGNodW5rICE9PSBudWxsCiAgICAgICAgPyBzdXBlci5lbmQoeyBjaHVuaywgZW5jb2RpbmcgfSkKICAgICAgICA6IHN1cGVyLmVuZCgpCgogICAgaWYgKGNiKSB0aGlzLm9uY2UoJ2ZpbmlzaCcsICgpID0+IGNiKG51bGwpKQoKICAgIHJldHVybiByZXN1bHQKICB9Cn0KCmV4cG9ydHMuRHVwbGV4ID0gY2xhc3MgRHVwbGV4IGV4dGVuZHMgc3RyZWFtLkR1cGxleCB7CiAgY29uc3RydWN0b3Iob3B0cyA9IHt9KSB7CiAgICBzdXBlcih7CiAgICAgIC4uLm9wdHMsCiAgICAgIGJ5dGVMZW5ndGg6IG51bGwsCiAgICAgIGJ5dGVMZW5ndGhSZWFkYWJsZTogbnVsbCwKICAgICAgYnl0ZUxlbmd0aFdyaXRhYmxlLAogICAgICBtYXA6IG51bGwsCiAgICAgIG1hcFJlYWRhYmxlOiBudWxsLAogICAgICBtYXBXcml0YWJsZTogbnVsbAogICAgfSkKCiAgICBpZiAodGhpcy5fY29uc3RydWN0KSB0aGlzLl9vcGVuID0gdGhpcy5fY29uc3RydWN0CgogICAgaWYgKHRoaXMuX3JlYWQgIT09IHN0cmVhbS5SZWFkYWJsZS5wcm90b3R5cGUuX3JlYWQpIHsKICAgICAgdGhpcy5fcmVhZCA9IHJlYWQuYmluZCh0aGlzLCB0aGlzLl9yZWFkKQogICAgfQoKICAgIGlmICh0aGlzLl93cml0ZSAhPT0gc3RyZWFtLkR1cGxleC5wcm90b3R5cGUuX3dyaXRlKSB7CiAgICAgIHRoaXMuX3dyaXRlID0gd3JpdGUuYmluZCh0aGlzLCB0aGlzLl93cml0ZSkKICAgIH0KCiAgICBpZiAodGhpcy5fZGVzdHJveSAhPT0gc3RyZWFtLlN0cmVhbS5wcm90b3R5cGUuX2Rlc3Ryb3kpIHsKICAgICAgdGhpcy5fZGVzdHJveSA9IGRlc3Ryb3kuYmluZCh0aGlzLCB0aGlzLl9kZXN0cm95KQogICAgfQogIH0KCiAgcHVzaChjaHVuaywgZW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZykKICAgIH0KCiAgICByZXR1cm4gc3VwZXIucHVzaChjaHVuaykKICB9CgogIHVuc2hpZnQoY2h1bmssIGVuY29kaW5nKSB7CiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcpCiAgICB9CgogICAgc3VwZXIudW5zaGlmdChjaHVuaykKICB9CgogIHdyaXRlKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSBlbmNvZGluZwogICAgICBlbmNvZGluZyA9IG51bGwKICAgIH0KCiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZwogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZykKICAgIH0gZWxzZSB7CiAgICAgIGVuY29kaW5nID0gJ2J1ZmZlcicKICAgIH0KCiAgICBjb25zdCByZXN1bHQgPSBzdXBlci53cml0ZSh7IGNodW5rLCBlbmNvZGluZyB9KQoKICAgIGlmIChjYikgc3RyZWFtLldyaXRhYmxlLmRyYWluZWQodGhpcykudGhlbigoKSA9PiBjYihudWxsKSwgY2IpCgogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgZW5kKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSBjaHVuawogICAgICBjaHVuayA9IG51bGwKICAgIH0gZWxzZSBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gZW5jb2RpbmcKICAgICAgZW5jb2RpbmcgPSBudWxsCiAgICB9CgogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcpCiAgICB9IGVsc2UgewogICAgICBlbmNvZGluZyA9ICdidWZmZXInCiAgICB9CgogICAgY29uc3QgcmVzdWx0ID0KICAgICAgY2h1bmsgIT09IHVuZGVmaW5lZCAmJiBjaHVuayAhPT0gbnVsbAogICAgICAgID8gc3VwZXIuZW5kKHsgY2h1bmssIGVuY29kaW5nIH0pCiAgICAgICAgOiBzdXBlci5lbmQoKQoKICAgIGlmIChjYikgdGhpcy5vbmNlKCdmaW5pc2gnLCAoKSA9PiBjYihudWxsKSkKCiAgICByZXR1cm4gcmVzdWx0CiAgfQp9CgpleHBvcnRzLlRyYW5zZm9ybSA9IGNsYXNzIFRyYW5zZm9ybSBleHRlbmRzIHN0cmVhbS5UcmFuc2Zvcm0gewogIGNvbnN0cnVjdG9yKG9wdHMgPSB7fSkgewogICAgc3VwZXIoewogICAgICAuLi5vcHRzLAogICAgICBieXRlTGVuZ3RoOiBudWxsLAogICAgICBieXRlTGVuZ3RoUmVhZGFibGU6IG51bGwsCiAgICAgIGJ5dGVMZW5ndGhXcml0YWJsZSwKICAgICAgbWFwOiBudWxsLAogICAgICBtYXBSZWFkYWJsZTogbnVsbCwKICAgICAgbWFwV3JpdGFibGU6IG51bGwKICAgIH0pCgogICAgaWYgKHRoaXMuX3RyYW5zZm9ybSAhPT0gc3RyZWFtLlRyYW5zZm9ybS5wcm90b3R5cGUuX3RyYW5zZm9ybSkgewogICAgICB0aGlzLl90cmFuc2Zvcm0gPSB0cmFuc2Zvcm0uYmluZCh0aGlzLCB0aGlzLl90cmFuc2Zvcm0pCiAgICB9IGVsc2UgewogICAgICB0aGlzLl90cmFuc2Zvcm0gPSBwYXNzdGhyb3VnaAogICAgfQogIH0KCiAgcHVzaChjaHVuaywgZW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZykKICAgIH0KCiAgICByZXR1cm4gc3VwZXIucHVzaChjaHVuaykKICB9CgogIHVuc2hpZnQoY2h1bmssIGVuY29kaW5nKSB7CiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcpCiAgICB9CgogICAgc3VwZXIudW5zaGlmdChjaHVuaykKICB9CgogIHdyaXRlKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSBlbmNvZGluZwogICAgICBlbmNvZGluZyA9IG51bGwKICAgIH0KCiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZwogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZykKICAgIH0gZWxzZSB7CiAgICAgIGVuY29kaW5nID0gJ2J1ZmZlcicKICAgIH0KCiAgICBjb25zdCByZXN1bHQgPSBzdXBlci53cml0ZSh7IGNodW5rLCBlbmNvZGluZyB9KQoKICAgIGlmIChjYikgc3RyZWFtLldyaXRhYmxlLmRyYWluZWQodGhpcykudGhlbigoKSA9PiBjYihudWxsKSwgY2IpCgogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgZW5kKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSBjaHVuawogICAgICBjaHVuayA9IG51bGwKICAgIH0gZWxzZSBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gZW5jb2RpbmcKICAgICAgZW5jb2RpbmcgPSBudWxsCiAgICB9CgogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcpCiAgICB9IGVsc2UgewogICAgICBlbmNvZGluZyA9ICdidWZmZXInCiAgICB9CgogICAgY29uc3QgcmVzdWx0ID0KICAgICAgY2h1bmsgIT09IHVuZGVmaW5lZCAmJiBjaHVuayAhPT0gbnVsbAogICAgICAgID8gc3VwZXIuZW5kKHsgY2h1bmssIGVuY29kaW5nIH0pCiAgICAgICAgOiBzdXBlci5lbmQoKQoKICAgIGlmIChjYikgdGhpcy5vbmNlKCdmaW5pc2gnLCAoKSA9PiBjYihudWxsKSkKCiAgICByZXR1cm4gcmVzdWx0CiAgfQp9CgpleHBvcnRzLlBhc3NUaHJvdWdoID0gY2xhc3MgUGFzc1Rocm91Z2ggZXh0ZW5kcyBleHBvcnRzLlRyYW5zZm9ybSB7fQoKZXhwb3J0cy5maW5pc2hlZCA9IGZ1bmN0aW9uIGZpbmlzaGVkKHN0cmVhbSwgb3B0cywgY2IpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb3B0cwogICAgb3B0cyA9IHt9CiAgfQoKICBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBjb25zdCB7IGNsZWFudXAgPSBmYWxzZSB9ID0gb3B0cwoKICBjb25zdCBkb25lID0gKCkgPT4gewogICAgY2IoZXhwb3J0cy5nZXRTdHJlYW1FcnJvcihzdHJlYW0sIHsgYWxsOiB0cnVlIH0pKQoKICAgIGlmIChjbGVhbnVwKSBkZXRhY2goKQogIH0KCiAgY29uc3QgZGV0YWNoID0gKCkgPT4gewogICAgc3RyZWFtLm9mZignY2xvc2UnLCBkb25lKQogICAgc3RyZWFtLm9mZignZXJyb3InLCBub29wKQogIH0KCiAgaWYgKHN0cmVhbS5kZXN0cm95ZWQpIHsKICAgIGRvbmUoKQogIH0gZWxzZSB7CiAgICBzdHJlYW0ub24oJ2Nsb3NlJywgZG9uZSkKICAgIHN0cmVhbS5vbignZXJyb3InLCBub29wKQogIH0KCiAgcmV0dXJuIGRldGFjaAp9CgpmdW5jdGlvbiByZWFkKHJlYWQsIGNiKSB7CiAgcmVhZC5jYWxsKHRoaXMsIDY1NTM2KQoKICBjYihudWxsKQp9CgpmdW5jdGlvbiB3cml0ZSh3cml0ZSwgZGF0YSwgY2IpIHsKICB3cml0ZS5jYWxsKHRoaXMsIGRhdGEuY2h1bmssIGRhdGEuZW5jb2RpbmcsIGNiKQp9CgpmdW5jdGlvbiB0cmFuc2Zvcm0odHJhbnNmb3JtLCBkYXRhLCBjYikgewogIHRyYW5zZm9ybS5jYWxsKHRoaXMsIGRhdGEuY2h1bmssIGRhdGEuZW5jb2RpbmcsIGNiKQp9CgpmdW5jdGlvbiBkZXN0cm95KGRlc3Ryb3ksIGNiKSB7CiAgZGVzdHJveS5jYWxsKHRoaXMsIGV4cG9ydHMuZ2V0U3RyZWFtRXJyb3IodGhpcyksIGNiKQp9CgpmdW5jdGlvbiBwYXNzdGhyb3VnaChkYXRhLCBjYikgewogIGNiKG51bGwsIGRhdGEuY2h1bmspCn0KCmZ1bmN0aW9uIGJ5dGVMZW5ndGhXcml0YWJsZShkYXRhKSB7CiAgcmV0dXJuIGRhdGEuY2h1bmsuYnl0ZUxlbmd0aAp9CgpmdW5jdGlvbiBub29wKCkge30KewogICJuYW1lIjogImJhcmUtc3RyZWFtIiwKICAidmVyc2lvbiI6ICIyLjcuMCIsCiAgImRlc2NyaXB0aW9uIjogIlN0cmVhbWluZyBkYXRhIGZvciBKYXZhU2NyaXB0IiwKICAiZXhwb3J0cyI6IHsKICAgICIuIjogewogICAgICAidHlwZXMiOiAiLi9pbmRleC5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9pbmRleC5qcyIKICAgIH0sCiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuL3Byb21pc2VzIjogIi4vcHJvbWlzZXMuanMiLAogICAgIi4vd2ViIjogewogICAgICAidHlwZXMiOiAiLi93ZWIuZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vd2ViLmpzIgogICAgfSwKICAgICIuL2dsb2JhbCI6ICIuL2dsb2JhbC5qcyIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiaW5kZXguZC50cyIsCiAgICAicHJvbWlzZXMuanMiLAogICAgIndlYi5qcyIsCiAgICAid2ViLmQudHMiLAogICAgImdsb2JhbC5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJhcmUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXN0cmVhbS5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXN0cmVhbS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtc3RyZWFtI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJzdHJlYW14IjogIl4yLjIxLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYnVmZmVyIjogIl4zLjAuMCIsCiAgICAiYmFyZS1ldmVudHMiOiAiXjIuNS40IiwKICAgICJicml0dGxlIjogIl4zLjUuMiIsCiAgICAicHJldHRpZXIiOiAiXjMuMy4zIiwKICAgICJwcmV0dGllci1jb25maWctc3RhbmRhcmQiOiAiXjcuMC4wIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1idWZmZXIiOiAiKiIsCiAgICAiYmFyZS1ldmVudHMiOiAiKiIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzTWV0YSI6IHsKICAgICJiYXJlLWJ1ZmZlciI6IHsKICAgICAgIm9wdGlvbmFsIjogdHJ1ZQogICAgfSwKICAgICJiYXJlLWV2ZW50cyI6IHsKICAgICAgIm9wdGlvbmFsIjogdHJ1ZQogICAgfQogIH0KfQptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUuYWRkb24oKQpjb25zdCBwYXRoID0gcmVxdWlyZSgnYmFyZS1wYXRoJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4vYmluZGluZycpCmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4vbGliL2Vycm9ycycpCmNvbnN0IFVSTFNlYXJjaFBhcmFtcyA9IHJlcXVpcmUoJy4vbGliL3VybC1zZWFyY2gtcGFyYW1zJykKCmNvbnN0IGtpbmQgPSBTeW1ib2wuZm9yKCdiYXJlLnVybC5raW5kJykKCmNvbnN0IGlzV2luZG93cyA9IEJhcmUucGxhdGZvcm0gPT09ICd3aW4zMicKCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IGNsYXNzIFVSTCB7CiAgc3RhdGljIGdldCBba2luZF0oKSB7CiAgICByZXR1cm4gMCAvLyBDb21wYXRpYmlsaXR5IHZlcnNpb24KICB9CgogIGNvbnN0cnVjdG9yKGlucHV0LCBiYXNlLCBvcHRzID0ge30pIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB0aHJvdyBlcnJvcnMuSU5WQUxJRF9VUkwoKQoKICAgIGlucHV0ID0gU3RyaW5nKGlucHV0KQoKICAgIGlmIChiYXNlICE9PSB1bmRlZmluZWQpIGJhc2UgPSBTdHJpbmcoYmFzZSkKCiAgICB0aGlzLl9jb21wb25lbnRzID0gbmV3IFVpbnQzMkFycmF5KDgpCgogICAgdGhpcy5fcGFyc2UoaW5wdXQsIGJhc2UsIG9wdHMudGhyb3cgIT09IGZhbHNlKQoKICAgIGlmICh0aGlzLl9ocmVmKSB0aGlzLl9wYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHRoaXMuc2VhcmNoLCB0aGlzKQogIH0KCiAgZ2V0IFtraW5kXSgpIHsKICAgIHJldHVybiBVUkxba2luZF0KICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1ocmVmCgogIGdldCBocmVmKCkgewogICAgcmV0dXJuIHRoaXMuX2hyZWYKICB9CgogIHNldCBocmVmKHZhbHVlKSB7CiAgICB0aGlzLl91cGRhdGUodmFsdWUpCgogICAgdGhpcy5fcGFyYW1zLl9wYXJzZSh0aGlzLnNlYXJjaCkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1wcm90b2NvbAoKICBnZXQgcHJvdG9jb2woKSB7CiAgICByZXR1cm4gdGhpcy5fc2xpY2UoMCwgdGhpcy5fY29tcG9uZW50c1swXSkgKyAnOicKICB9CgogIHNldCBwcm90b2NvbCh2YWx1ZSkgewogICAgdGhpcy5fdXBkYXRlKHRoaXMuX3JlcGxhY2UodmFsdWUucmVwbGFjZSgvOiskLywgJycpLCAwLCB0aGlzLl9jb21wb25lbnRzWzBdKSkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC11c2VybmFtZQoKICBnZXQgdXNlcm5hbWUoKSB7CiAgICByZXR1cm4gdGhpcy5fc2xpY2UodGhpcy5fY29tcG9uZW50c1swXSArIDMgLyogOi8vICovLCB0aGlzLl9jb21wb25lbnRzWzFdKQogIH0KCiAgc2V0IHVzZXJuYW1lKHZhbHVlKSB7CiAgICBpZiAoY2Fubm90SGF2ZUNyZWRlbnRpYWxzT3JQb3J0KHRoaXMpKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLnVzZXJuYW1lID09PSAnJykgdmFsdWUgKz0gJ0AnCgogICAgdGhpcy5fdXBkYXRlKHRoaXMuX3JlcGxhY2UodmFsdWUsIHRoaXMuX2NvbXBvbmVudHNbMF0gKyAzIC8qIDovLyAqLywgdGhpcy5fY29tcG9uZW50c1sxXSkpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtcGFzc3dvcmQKCiAgZ2V0IHBhc3N3b3JkKCkgewogICAgcmV0dXJuIHRoaXMuX2hyZWYuc2xpY2UodGhpcy5fY29tcG9uZW50c1sxXSArIDEgLyogOiAqLywgdGhpcy5fY29tcG9uZW50c1syXSAtIDEgLyogQCAqLykKICB9CgogIHNldCBwYXNzd29yZCh2YWx1ZSkgewogICAgaWYgKGNhbm5vdEhhdmVDcmVkZW50aWFsc09yUG9ydCh0aGlzKSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICBsZXQgc3RhcnQgPSB0aGlzLl9jb21wb25lbnRzWzFdICsgMSAvKiA6ICovCiAgICBsZXQgZW5kID0gdGhpcy5fY29tcG9uZW50c1syXSAtIDEgLyogQCAqLwoKICAgIGlmICh0aGlzLnBhc3N3b3JkID09PSAnJykgewogICAgICB2YWx1ZSA9ICc6JyArIHZhbHVlCiAgICAgIHN0YXJ0LS0KICAgIH0KCiAgICBpZiAodGhpcy51c2VybmFtZSA9PT0gJycpIHsKICAgICAgdmFsdWUgKz0gJ0AnCiAgICAgIGVuZCsrCiAgICB9CgogICAgdGhpcy5fdXBkYXRlKHRoaXMuX3JlcGxhY2UodmFsdWUsIHN0YXJ0LCBlbmQpKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsLWhvc3QKCiAgZ2V0IGhvc3QoKSB7CiAgICByZXR1cm4gdGhpcy5fc2xpY2UodGhpcy5fY29tcG9uZW50c1syXSwgdGhpcy5fY29tcG9uZW50c1s1XSkKICB9CgogIHNldCBob3N0KHZhbHVlKSB7CiAgICBpZiAoaGFzT3BhcXVlUGF0aCh0aGlzKSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLl91cGRhdGUoCiAgICAgIHRoaXMuX3JlcGxhY2UodmFsdWUsIHRoaXMuX2NvbXBvbmVudHNbMl0sIHRoaXMuX2NvbXBvbmVudHNbdmFsdWUuaW5jbHVkZXMoJzonKSA/IDUgOiAzXSkKICAgICkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1ob3N0bmFtZQoKICBnZXQgaG9zdG5hbWUoKSB7CiAgICByZXR1cm4gdGhpcy5fc2xpY2UodGhpcy5fY29tcG9uZW50c1syXSwgdGhpcy5fY29tcG9uZW50c1szXSkKICB9CgogIHNldCBob3N0bmFtZSh2YWx1ZSkgewogICAgaWYgKGhhc09wYXF1ZVBhdGgodGhpcykpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5fdXBkYXRlKHRoaXMuX3JlcGxhY2UodmFsdWUsIHRoaXMuX2NvbXBvbmVudHNbMl0sIHRoaXMuX2NvbXBvbmVudHNbM10pKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsLXBvcnQKCiAgZ2V0IHBvcnQoKSB7CiAgICByZXR1cm4gdGhpcy5fc2xpY2UodGhpcy5fY29tcG9uZW50c1szXSArIDEgLyogOiAqLywgdGhpcy5fY29tcG9uZW50c1s1XSkKICB9CgogIHNldCBwb3J0KHZhbHVlKSB7CiAgICBpZiAoY2Fubm90SGF2ZUNyZWRlbnRpYWxzT3JQb3J0KHRoaXMpKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGxldCBzdGFydCA9IHRoaXMuX2NvbXBvbmVudHNbM10gKyAxIC8qIDogKi8KCiAgICBpZiAodGhpcy5wb3J0ID09PSAnJykgewogICAgICB2YWx1ZSA9ICc6JyArIHZhbHVlCiAgICAgIHN0YXJ0LS0KICAgIH0KCiAgICB0aGlzLl91cGRhdGUodGhpcy5fcmVwbGFjZSh2YWx1ZSwgc3RhcnQsIHRoaXMuX2NvbXBvbmVudHNbNV0pKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsLXBhdGhuYW1lCgogIGdldCBwYXRobmFtZSgpIHsKICAgIHJldHVybiB0aGlzLl9zbGljZSh0aGlzLl9jb21wb25lbnRzWzVdLCB0aGlzLl9jb21wb25lbnRzWzZdIC0gMSAvKiA/ICovKQogIH0KCiAgc2V0IHBhdGhuYW1lKHZhbHVlKSB7CiAgICBpZiAoaGFzT3BhcXVlUGF0aCh0aGlzKSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodmFsdWVbMF0gIT09ICcvJyAmJiB2YWx1ZVswXSAhPT0gJ1xcJykgewogICAgICB2YWx1ZSA9ICcvJyArIHZhbHVlCiAgICB9CgogICAgdGhpcy5fdXBkYXRlKHRoaXMuX3JlcGxhY2UodmFsdWUsIHRoaXMuX2NvbXBvbmVudHNbNV0sIHRoaXMuX2NvbXBvbmVudHNbNl0gLSAxIC8qID8gKi8pKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsLXNlYXJjaAoKICBnZXQgc2VhcmNoKCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKHRoaXMuX2NvbXBvbmVudHNbNl0gLSAxIC8qID8gKi8sIHRoaXMuX2NvbXBvbmVudHNbN10gLSAxIC8qICMgKi8pCiAgfQoKICBzZXQgc2VhcmNoKHZhbHVlKSB7CiAgICBpZiAodmFsdWUgJiYgdmFsdWVbMF0gIT09ICc/JykgdmFsdWUgPSAnPycgKyB2YWx1ZQoKICAgIHRoaXMuX3VwZGF0ZSgKICAgICAgdGhpcy5fcmVwbGFjZSh2YWx1ZSwgdGhpcy5fY29tcG9uZW50c1s2XSAtIDEgLyogPyAqLywgdGhpcy5fY29tcG9uZW50c1s3XSAtIDEgLyogIyAqLykKICAgICkKCiAgICB0aGlzLl9wYXJhbXMuX3BhcnNlKHRoaXMuc2VhcmNoKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsLXNlYXJjaHBhcmFtcwoKICBnZXQgc2VhcmNoUGFyYW1zKCkgewogICAgcmV0dXJuIHRoaXMuX3BhcmFtcwogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsLWhhc2gKCiAgZ2V0IGhhc2goKSB7CiAgICByZXR1cm4gdGhpcy5fc2xpY2UodGhpcy5fY29tcG9uZW50c1s3XSAtIDEgLyogIyAqLykKICB9CgogIHNldCBoYXNoKHZhbHVlKSB7CiAgICBpZiAodmFsdWUgJiYgdmFsdWVbMF0gIT09ICcjJykgdmFsdWUgPSAnIycgKyB2YWx1ZQoKICAgIHRoaXMuX3VwZGF0ZSh0aGlzLl9yZXBsYWNlKHZhbHVlLCB0aGlzLl9jb21wb25lbnRzWzddIC0gMSAvKiAjICovKSkKICB9CgogIHRvU3RyaW5nKCkgewogICAgcmV0dXJuIHRoaXMuX2hyZWYKICB9CgogIHRvSlNPTigpIHsKICAgIHJldHVybiB0aGlzLl9ocmVmCiAgfQoKICBbU3ltYm9sLmZvcignYmFyZS5pbnNwZWN0JyldKCkgewogICAgcmV0dXJuIHsKICAgICAgX19wcm90b19fOiB7IGNvbnN0cnVjdG9yOiBVUkwgfSwKCiAgICAgIGhyZWY6IHRoaXMuaHJlZiwKICAgICAgcHJvdG9jb2w6IHRoaXMucHJvdG9jb2wsCiAgICAgIHVzZXJuYW1lOiB0aGlzLnVzZXJuYW1lLAogICAgICBwYXNzd29yZDogdGhpcy5wYXNzd29yZCwKICAgICAgaG9zdDogdGhpcy5ob3N0LAogICAgICBob3N0bmFtZTogdGhpcy5ob3N0bmFtZSwKICAgICAgcG9ydDogdGhpcy5wb3J0LAogICAgICBwYXRobmFtZTogdGhpcy5wYXRobmFtZSwKICAgICAgc2VhcmNoOiB0aGlzLnNlYXJjaCwKICAgICAgc2VhcmNoUGFyYW1zOiB0aGlzLnNlYXJjaFBhcmFtcywKICAgICAgaGFzaDogdGhpcy5oYXNoCiAgICB9CiAgfQoKICBfc2xpY2Uoc3RhcnQsIGVuZCA9IHRoaXMuX2hyZWYubGVuZ3RoKSB7CiAgICByZXR1cm4gdGhpcy5faHJlZi5zbGljZShzdGFydCwgZW5kKQogIH0KCiAgX3JlcGxhY2UocmVwbGFjZW1lbnQsIHN0YXJ0LCBlbmQgPSB0aGlzLl9ocmVmLmxlbmd0aCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKDAsIHN0YXJ0KSArIHJlcGxhY2VtZW50ICsgdGhpcy5fc2xpY2UoZW5kKQogIH0KCiAgX3BhcnNlKGlucHV0LCBiYXNlLCBzaG91bGRUaHJvdykgewogICAgdHJ5IHsKICAgICAgdGhpcy5faHJlZiA9IGJpbmRpbmcucGFyc2UoCiAgICAgICAgU3RyaW5nKGlucHV0KSwKICAgICAgICBiYXNlID8gU3RyaW5nKGJhc2UpIDogbnVsbCwKICAgICAgICB0aGlzLl9jb21wb25lbnRzLAogICAgICAgIHNob3VsZFRocm93CiAgICAgICkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAoZXJyIGluc3RhbmNlb2YgVHlwZUVycm9yKSB0aHJvdyBlcnIKCiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX1VSTChgSW52YWxpZCBVUkwgJyR7aW5wdXR9J2AsIGlucHV0KQogICAgfQogIH0KCiAgX3VwZGF0ZShpbnB1dCkgewogICAgdHJ5IHsKICAgICAgdGhpcy5fcGFyc2UoaW5wdXQsIG51bGwsIHRydWUpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIFR5cGVFcnJvcikgdGhyb3cgZXJyCiAgICB9CiAgfQp9CgovLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI3VybC1vcGFxdWUtcGF0aApmdW5jdGlvbiBoYXNPcGFxdWVQYXRoKHVybCkgewogIHJldHVybiB1cmwucGF0aG5hbWVbMF0gIT09ICcvJwp9CgovLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2Nhbm5vdC1oYXZlLWEtdXNlcm5hbWUtcGFzc3dvcmQtcG9ydApmdW5jdGlvbiBjYW5ub3RIYXZlQ3JlZGVudGlhbHNPclBvcnQodXJsKSB7CiAgcmV0dXJuIHVybC5ob3N0bmFtZSA9PT0gJycgfHwgdXJsLnByb3RvY29sID09PSAnZmlsZTonCn0KCmNvbnN0IFVSTCA9IGV4cG9ydHMKCmV4cG9ydHMuVVJMID0gVVJMCmV4cG9ydHMuVVJMU2VhcmNoUGFyYW1zID0gVVJMU2VhcmNoUGFyYW1zCgpleHBvcnRzLmVycm9ycyA9IGVycm9ycwoKZXhwb3J0cy5pc1VSTCA9IGZ1bmN0aW9uIGlzVVJMKHZhbHVlKSB7CiAgaWYgKHZhbHVlIGluc3RhbmNlb2YgVVJMKSByZXR1cm4gdHJ1ZQoKICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZVtraW5kXSA9PT0gVVJMW2tpbmRdCn0KCi8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1wYXJzZQpleHBvcnRzLnBhcnNlID0gZnVuY3Rpb24gcGFyc2UoaW5wdXQsIGJhc2UpIHsKICBjb25zdCB1cmwgPSBuZXcgVVJMKGlucHV0LCBiYXNlLCB7IHRocm93OiBmYWxzZSB9KQogIHJldHVybiB1cmwuX2hyZWYgPyB1cmwgOiBudWxsCn0KCi8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1jYW5wYXJzZQpleHBvcnRzLmNhblBhcnNlID0gZnVuY3Rpb24gY2FuUGFyc2UoaW5wdXQsIGJhc2UpIHsKICByZXR1cm4gYmluZGluZy5jYW5QYXJzZShTdHJpbmcoaW5wdXQpLCBiYXNlID8gU3RyaW5nKGJhc2UpIDogbnVsbCkKfQoKZXhwb3J0cy5maWxlVVJMVG9QYXRoID0gZnVuY3Rpb24gZmlsZVVSTFRvUGF0aCh1cmwpIHsKICBpZiAodHlwZW9mIHVybCA9PT0gJ3N0cmluZycpIHsKICAgIHVybCA9IG5ldyBVUkwodXJsKQogIH0KCiAgaWYgKHVybC5wcm90b2NvbCAhPT0gJ2ZpbGU6JykgewogICAgdGhyb3cgZXJyb3JzLklOVkFMSURfVVJMX1NDSEVNRSgnVGhlIFVSTCBtdXN0IHVzZSB0aGUgZmlsZTogcHJvdG9jb2wnKQogIH0KCiAgaWYgKGlzV2luZG93cykgewogICAgaWYgKC8lMmZ8JTVjL2kudGVzdCh1cmwucGF0aG5hbWUpKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0ZJTEVfVVJMX1BBVEgoCiAgICAgICAgJ1RoZSBmaWxlOiBVUkwgcGF0aCBtdXN0IG5vdCBpbmNsdWRlIGVuY29kZWQgXFwgb3IgLyBjaGFyYWN0ZXJzJwogICAgICApCiAgICB9CiAgfSBlbHNlIHsKICAgIGlmICh1cmwuaG9zdG5hbWUpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfRklMRV9VUkxfSE9TVCgiVGhlIGZpbGU6IFVSTCBob3N0IG11c3QgYmUgJ2xvY2FsaG9zdCcgb3IgZW1wdHkiKQogICAgfQoKICAgIGlmICgvJTJmL2kudGVzdCh1cmwucGF0aG5hbWUpKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0ZJTEVfVVJMX1BBVEgoJ1RoZSBmaWxlOiBVUkwgcGF0aCBtdXN0IG5vdCBpbmNsdWRlIGVuY29kZWQgLyBjaGFyYWN0ZXJzJykKICAgIH0KICB9CgogIGNvbnN0IHBhdGhuYW1lID0gcGF0aC5ub3JtYWxpemUoZGVjb2RlVVJJQ29tcG9uZW50KHVybC5wYXRobmFtZSkpCgogIGlmIChpc1dpbmRvd3MpIHsKICAgIGlmICh1cmwuaG9zdG5hbWUpIHJldHVybiAnXFxcXCcgKyB1cmwuaG9zdG5hbWUgKyBwYXRobmFtZQoKICAgIGNvbnN0IGxldHRlciA9IHBhdGhuYW1lLmNoYXJDb2RlQXQoMSkgfCAweDIwCgogICAgaWYgKGxldHRlciA8IDB4NjEgLyogYSAqLyB8fCBsZXR0ZXIgPiAweDdhIC8qIHogKi8gfHwgcGF0aG5hbWUuY2hhckNvZGVBdCgyKSAhPT0gMHgzYSAvKiA6ICovKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0ZJTEVfVVJMX1BBVEgoJ1RoZSBmaWxlOiBVUkwgcGF0aCBtdXN0IGJlIGFic29sdXRlJykKICAgIH0KCiAgICByZXR1cm4gcGF0aG5hbWUuc2xpY2UoMSkKICB9CgogIHJldHVybiBwYXRobmFtZQp9CgpleHBvcnRzLnBhdGhUb0ZpbGVVUkwgPSBmdW5jdGlvbiBwYXRoVG9GaWxlVVJMKHBhdGhuYW1lKSB7CiAgbGV0IHJlc29sdmVkID0gcGF0aC5yZXNvbHZlKHBhdGhuYW1lKQoKICBpZiAocGF0aG5hbWVbcGF0aG5hbWUubGVuZ3RoIC0gMV0gPT09ICcvJykgewogICAgcmVzb2x2ZWQgKz0gJy8nCiAgfSBlbHNlIGlmIChpc1dpbmRvd3MgJiYgcGF0aG5hbWVbcGF0aG5hbWUubGVuZ3RoIC0gMV0gPT09ICdcXCcpIHsKICAgIHJlc29sdmVkICs9ICdcXCcKICB9CgogIHJlc29sdmVkID0gcmVzb2x2ZWQKICAgIC5yZXBsYWNlQWxsKCclJywgJyUyNScpIC8vIE11c3QgYmUgZmlyc3QKICAgIC5yZXBsYWNlQWxsKCcjJywgJyUyMycpCiAgICAucmVwbGFjZUFsbCgnPycsICclM2YnKQogICAgLnJlcGxhY2VBbGwoJ1xuJywgJyUwYScpCiAgICAucmVwbGFjZUFsbCgnXHInLCAnJTBkJykKICAgIC5yZXBsYWNlQWxsKCdcdCcsICclMDknKQoKICBpZiAoIWlzV2luZG93cykgewogICAgcmVzb2x2ZWQgPSByZXNvbHZlZC5yZXBsYWNlQWxsKCdcXCcsICclNWMnKQogIH0KCiAgcmV0dXJuIG5ldyBVUkwoJ2ZpbGU6JyArIHJlc29sdmVkKQp9CgpleHBvcnRzLmZvcm1hdCA9IGZ1bmN0aW9uIGZvcm1hdChwYXJ0cykgewogIGNvbnN0IHsgcHJvdG9jb2wsIGF1dGgsIGhvc3QsIGhvc3RuYW1lLCBwb3J0LCBwYXRobmFtZSwgc2VhcmNoLCBxdWVyeSwgaGFzaCwgc2xhc2hlcyB9ID0gcGFydHMKCiAgbGV0IHJlc3VsdCA9ICcnCgogIGlmICh0eXBlb2YgcHJvdG9jb2wgPT09ICdzdHJpbmcnKSB7CiAgICByZXN1bHQgKz0gcHJvdG9jb2wKCiAgICBpZiAocHJvdG9jb2xbcHJvdG9jb2wubGVuZ3RoIC0gMV0gIT09ICc6JykgewogICAgICByZXN1bHQgKz0gJzonCiAgICB9CgogICAgaWYgKHNsYXNoZXMgPT09IHRydWUgfHwgL2h0dHBzP3xmdHB8Z29waGVyfGZpbGUvLnRlc3QocHJvdG9jb2wpKSB7CiAgICAgIHJlc3VsdCArPSAnLy8nCiAgICB9CiAgfQoKICBpZiAodHlwZW9mIGF1dGggPT09ICdzdHJpbmcnKSB7CiAgICBpZiAoaG9zdCB8fCBob3N0bmFtZSkgcmVzdWx0ICs9IGF1dGggKyAnQCcKICB9CgogIGlmICh0eXBlb2YgaG9zdCA9PT0gJ3N0cmluZycpIHJlc3VsdCArPSBob3N0CiAgZWxzZSB7CiAgICByZXN1bHQgKz0gaG9zdG5hbWUKCiAgICBpZiAocG9ydCkgcmVzdWx0ICs9ICc6JyArIHBvcnQKICB9CgogIGlmICh0eXBlb2YgcGF0aG5hbWUgPT09ICdzdHJpbmcnICYmIHBhdGhuYW1lICE9PSAnJykgewogICAgaWYgKHBhdGhuYW1lWzBdICE9PSAnLycpIHJlc3VsdCArPSAnLycKICAgIHJlc3VsdCArPSBwYXRobmFtZQogIH0KCiAgaWYgKHR5cGVvZiBzZWFyY2ggPT09ICdzdHJpbmcnKSB7CiAgICBpZiAoc2VhcmNoWzBdICE9PSAnPycpIHJlc3VsdCArPSAnPycKICAgIHJlc3VsdCArPSBzZWFyY2gKICB9IGVsc2UgaWYgKHR5cGVvZiBxdWVyeSA9PT0gJ29iamVjdCcgJiYgcXVlcnkgIT09IG51bGwpIHsKICAgIHJlc3VsdCArPSAnPycgKyBuZXcgVVJMU2VhcmNoUGFyYW1zKHF1ZXJ5KQogIH0KCiAgaWYgKHR5cGVvZiBoYXNoID09PSAnc3RyaW5nJykgewogICAgaWYgKGhhc2hbMF0gIT09ICcjJykgcmVzdWx0ICs9ICcjJwogICAgcmVzdWx0ICs9IGhhc2gKICB9CgogIHJldHVybiByZXN1bHQKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFVSTEVycm9yIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yKG1zZywgZm4gPSBVUkxFcnJvciwgY29kZSA9IGZuLm5hbWUpIHsKICAgIHN1cGVyKGAke2NvZGV9OiAke21zZ31gKQoKICAgIHRoaXMuY29kZSA9IGNvZGUKCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIGZuKQogIH0KCiAgZ2V0IG5hbWUoKSB7CiAgICByZXR1cm4gJ1VSTEVycm9yJwogIH0KCiAgc3RhdGljIElOVkFMSURfVVJMKG1zZywgaW5wdXQpIHsKICAgIGNvbnN0IGVyciA9IG5ldyBVUkxFcnJvcihtc2csIFVSTEVycm9yLklOVkFMSURfVVJMKQoKICAgIGVyci5pbnB1dCA9IGlucHV0CgogICAgcmV0dXJuIGVycgogIH0KCiAgc3RhdGljIElOVkFMSURfVVJMX1NDSEVNRShtc2cgPSAnSW52YWxpZCBVUkwnKSB7CiAgICByZXR1cm4gbmV3IFVSTEVycm9yKG1zZywgVVJMRXJyb3IuSU5WQUxJRF9VUkxfU0NIRU1FKQogIH0KCiAgc3RhdGljIElOVkFMSURfRklMRV9VUkxfSE9TVChtc2cgPSAnSW52YWxpZCBmaWxlOiBVUkwgaG9zdCcpIHsKICAgIHJldHVybiBuZXcgVVJMRXJyb3IobXNnLCBVUkxFcnJvci5JTlZBTElEX0ZJTEVfVVJMX0hPU1QpCiAgfQoKICBzdGF0aWMgSU5WQUxJRF9GSUxFX1VSTF9QQVRIKG1zZyA9ICdJbnZhbGlkIGZpbGU6IFVSTCBwYXRoJykgewogICAgcmV0dXJuIG5ldyBVUkxFcnJvcihtc2csIFVSTEVycm9yLklOVkFMSURfRklMRV9VUkxfUEFUSCkKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBVUkxTZWFyY2hQYXJhbXMgewogIHN0YXRpYyBfdXJscyA9IG5ldyBXZWFrTWFwKCkKCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsc2VhcmNocGFyYW1zLXVybHNlYXJjaHBhcmFtcwogIGNvbnN0cnVjdG9yKGluaXQsIHVybCA9IG51bGwpIHsKICAgIHRoaXMuX3BhcmFtcyA9IG5ldyBNYXAoKQoKICAgIGlmICh1cmwpIFVSTFNlYXJjaFBhcmFtcy5fdXJscy5zZXQodGhpcywgdXJsKQoKICAgIGlmICh0eXBlb2YgaW5pdCA9PT0gJ3N0cmluZycpIHsKICAgICAgdGhpcy5fcGFyc2UoaW5pdCkKICAgIH0gZWxzZSBpZiAoaW5pdCkgewogICAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZV0gb2YgdHlwZW9mIGluaXRbU3ltYm9sLml0ZXJhdG9yXSA9PT0gJ2Z1bmN0aW9uJwogICAgICAgID8gaW5pdAogICAgICAgIDogT2JqZWN0LmVudHJpZXMoaW5pdCkpIHsKICAgICAgICB0aGlzLmFwcGVuZChuYW1lLCB2YWx1ZSkKICAgICAgfQogICAgfQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsc2VhcmNocGFyYW1zLXNpemUKICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLl9wYXJhbXMubGVuZ3RoCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmxzZWFyY2hwYXJhbXMtYXBwZW5kCiAgYXBwZW5kKG5hbWUsIHZhbHVlID0gbnVsbCkgewogICAgaWYgKHZhbHVlID09PSBudWxsKSByZXR1cm4KCiAgICBsZXQgbGlzdCA9IHRoaXMuX3BhcmFtcy5nZXQobmFtZSkKCiAgICBpZiAobGlzdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGxpc3QgPSBbXQogICAgICB0aGlzLl9wYXJhbXMuc2V0KG5hbWUsIGxpc3QpCiAgICB9CgogICAgbGlzdC5wdXNoKHZhbHVlKQoKICAgIHRoaXMuX3VwZGF0ZSgpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmxzZWFyY2hwYXJhbXMtZGVsZXRlCiAgZGVsZXRlKG5hbWUsIHZhbHVlID0gbnVsbCkgewogICAgaWYgKHZhbHVlID09PSBudWxsKSB0aGlzLl9wYXJhbXMuZGVsZXRlKG5hbWUpCiAgICBlbHNlIHsKICAgICAgbGV0IGxpc3QgPSB0aGlzLl9wYXJhbXMuZ2V0KG5hbWUpCgogICAgICBpZiAobGlzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIGxpc3QgPSBsaXN0LmZpbHRlcigoZm91bmQpID0+IGZvdW5kICE9PSB2YWx1ZSkKCiAgICAgIGlmIChsaXN0Lmxlbmd0aCA9PT0gMCkgdGhpcy5fcGFyYW1zLmRlbGV0ZShuYW1lKQogICAgICBlbHNlIHRoaXMuX3BhcmFtcy5zZXQobmFtZSwgbGlzdCkKICAgIH0KCiAgICB0aGlzLl91cGRhdGUoKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsc2VhcmNocGFyYW1zLWdldAogIGdldChuYW1lKSB7CiAgICBjb25zdCBsaXN0ID0gdGhpcy5fcGFyYW1zLmdldChuYW1lKQoKICAgIGlmIChsaXN0ID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsCgogICAgcmV0dXJuIGxpc3RbMF0KICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybHNlYXJjaHBhcmFtcy1nZXRhbGwKICBnZXRBbGwobmFtZSkgewogICAgY29uc3QgbGlzdCA9IHRoaXMuX3BhcmFtcy5nZXQobmFtZSkKCiAgICBpZiAobGlzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gW10KCiAgICByZXR1cm4gQXJyYXkuZnJvbShsaXN0KQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsc2VhcmNocGFyYW1zLWhhcwogIGhhcyhuYW1lLCB2YWx1ZSA9IG51bGwpIHsKICAgIGNvbnN0IGxpc3QgPSB0aGlzLl9wYXJhbXMuZ2V0KG5hbWUpCgogICAgaWYgKGxpc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlCgogICAgaWYgKHZhbHVlID09PSBudWxsKSByZXR1cm4gdHJ1ZQoKICAgIHJldHVybiBsaXN0LmluY2x1ZGVzKHZhbHVlKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsc2VhcmNocGFyYW1zLXNldAogIHNldChuYW1lLCB2YWx1ZSA9IG51bGwpIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgdGhpcy5fcGFyYW1zLmRlbGV0ZShuYW1lKQogICAgZWxzZSB0aGlzLl9wYXJhbXMuc2V0KG5hbWUsIFt2YWx1ZV0pCgogICAgdGhpcy5fdXBkYXRlKCkKICB9CgogIHRvU3RyaW5nKCkgewogICAgcmV0dXJuIHRoaXMuX3NlcmlhbGl6ZSgpCiAgfQoKICB0b0pTT04oKSB7CiAgICByZXR1cm4gWy4uLnRoaXNdCiAgfQoKICAqW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZXNdIG9mIHRoaXMuX3BhcmFtcykgewogICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlcykgeWllbGQgW25hbWUsIHZhbHVlXQogICAgfQogIH0KCiAgW1N5bWJvbC5mb3IoJ2JhcmUuaW5zcGVjdCcpXSgpIHsKICAgIGNvbnN0IG9iamVjdCA9IHsKICAgICAgX19wcm90b19fOiB7IGNvbnN0cnVjdG9yOiBVUkxTZWFyY2hQYXJhbXMgfQogICAgfQoKICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlc10gb2YgdGhpcy5fcGFyYW1zKSB7CiAgICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAxKSBvYmplY3RbbmFtZV0gPSB2YWx1ZXNbMF0KICAgICAgZWxzZSBvYmplY3RbbmFtZV0gPSB2YWx1ZXMKICAgIH0KCiAgICByZXR1cm4gb2JqZWN0CiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtdXJsc2VhcmNocGFyYW1zLXVwZGF0ZQogIF91cGRhdGUoKSB7CiAgICBjb25zdCB1cmwgPSBVUkxTZWFyY2hQYXJhbXMuX3VybHMuZ2V0KHRoaXMpCgogICAgaWYgKHVybCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICB1cmwuc2VhcmNoID0gdGhpcy5fc2VyaWFsaXplKCkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jY29uY2VwdC11cmxlbmNvZGVkLXBhcnNlcgogIF9wYXJzZShpbnB1dCkgewogICAgaWYgKGlucHV0WzBdID09PSAnPycpIGlucHV0ID0gaW5wdXQuc3Vic3RyaW5nKDEpCgogICAgdGhpcy5fcGFyYW1zID0gbmV3IE1hcCgpCgogICAgZm9yIChjb25zdCBzZXF1ZW5jZSBvZiBpbnB1dC5zcGxpdCgnJicpKSB7CiAgICAgIGlmIChzZXF1ZW5jZS5sZW5ndGggPT09IDApIGNvbnRpbnVlCgogICAgICBsZXQgaSA9IHNlcXVlbmNlLmluZGV4T2YoJz0nKQogICAgICBpZiAoaSA9PT0gLTEpIGkgPSBzZXF1ZW5jZS5sZW5ndGgKCiAgICAgIGNvbnN0IG5hbWUgPSBkZWNvZGVVUklDb21wb25lbnQoc2VxdWVuY2Uuc3Vic3RyaW5nKDAsIGkpKQogICAgICBjb25zdCB2YWx1ZSA9IGRlY29kZVVSSUNvbXBvbmVudChzZXF1ZW5jZS5zdWJzdHJpbmcoaSArIDEsIHNlcXVlbmNlLmxlbmd0aCkpCgogICAgICBsZXQgbGlzdCA9IHRoaXMuX3BhcmFtcy5nZXQobmFtZSkKCiAgICAgIGlmIChsaXN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBsaXN0ID0gW10KICAgICAgICB0aGlzLl9wYXJhbXMuc2V0KG5hbWUsIGxpc3QpCiAgICAgIH0KCiAgICAgIGxpc3QucHVzaCh2YWx1ZSkKICAgIH0KICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jY29uY2VwdC11cmxlbmNvZGVkLXNlcmlhbGl6ZXIKICBfc2VyaWFsaXplKCkgewogICAgbGV0IG91dHB1dCA9ICcnCgogICAgZm9yIChsZXQgW25hbWUsIHZhbHVlc10gb2YgdGhpcy5fcGFyYW1zKSB7CiAgICAgIG5hbWUgPSBlbmNvZGVVUklDb21wb25lbnQobmFtZSkKCiAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgICAgaWYgKG91dHB1dCkgb3V0cHV0ICs9ICcmJwoKICAgICAgICBvdXRwdXQgKz0gbmFtZSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBvdXRwdXQKICB9Cn0KewogICJuYW1lIjogImJhcmUtdXJsIiwKICAidmVyc2lvbiI6ICIyLjMuMiIsCiAgImRlc2NyaXB0aW9uIjogIldIQVRXRyBVUkwgaW1wbGVtZW50YXRpb24gZm9yIEphdmFTY3JpcHQiLAogICJleHBvcnRzIjogewogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLiI6IHsKICAgICAgInR5cGVzIjogIi4vaW5kZXguZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vaW5kZXguanMiCiAgICB9LAogICAgIi4vZ2xvYmFsIjogewogICAgICAidHlwZXMiOiAiLi9nbG9iYWwuZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vZ2xvYmFsLmpzIgogICAgfQogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJpbmRleC5kLnRzIiwKICAgICJnbG9iYWwuanMiLAogICAgImdsb2JhbC5kLnRzIiwKICAgICJiaW5kaW5nLmMiLAogICAgImJpbmRpbmcuanMiLAogICAgIkNNYWtlTGlzdHMudHh0IiwKICAgICJsaWIiLAogICAgInByZWJ1aWxkcyIKICBdLAogICJhZGRvbiI6IHRydWUsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYmFyZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtdXJsLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtdXJsL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS11cmwiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1wYXRoIjogIl4zLjAuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4zLjIiLAogICAgImNtYWtlLWJhcmUiOiAiXjEuMS42IiwKICAgICJjbWFrZS1mZXRjaCI6ICJeMS4wLjAiLAogICAgInByZXR0aWVyIjogIl4zLjMuMyIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiCiAgfQp9CmNvbnN0IEZBQ1RPUiA9IG5ldyBVaW50MTZBcnJheSg4KQoKZnVuY3Rpb24gZmFjdG9yNDA5NiAoaSwgbikgewogIHdoaWxlIChuID4gMCkgewogICAgY29uc3QgZiA9IGkgJiA0MDk1CiAgICBGQUNUT1JbLS1uXSA9IGYKICAgIGkgPSAoaSAtIGYpIC8gNDA5NgogIH0KICByZXR1cm4gRkFDVE9SCn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQmlnU3BhcnNlQXJyYXkgewogIGNvbnN0cnVjdG9yICgpIHsKICAgIHRoaXMudGlueSA9IG5ldyBUaW55QXJyYXkoKQogICAgdGhpcy5tYXhMZW5ndGggPSA0MDk2CiAgICB0aGlzLmZhY3RvciA9IDEKICB9CgogIHNldCAoaW5kZXgsIHZhbCkgewogICAgaWYgKHZhbCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHdoaWxlIChpbmRleCA+PSB0aGlzLm1heExlbmd0aCkgewogICAgICAgIHRoaXMubWF4TGVuZ3RoICo9IDQwOTYKICAgICAgICB0aGlzLmZhY3RvcisrCiAgICAgICAgaWYgKCF0aGlzLnRpbnkuaXNFbXB0eWlzaCgpKSB7CiAgICAgICAgICBjb25zdCB0ID0gbmV3IFRpbnlBcnJheSgpCiAgICAgICAgICB0LnNldCgwLCB0aGlzLnRpbnkpCiAgICAgICAgICB0aGlzLnRpbnkgPSB0CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgY29uc3QgZiA9IGZhY3RvcjQwOTYoaW5kZXgsIHRoaXMuZmFjdG9yKQogICAgY29uc3QgbGFzdCA9IHRoaXMuZmFjdG9yIC0gMQoKICAgIGxldCB0aW55ID0gdGhpcy50aW55CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxhc3Q7IGkrKykgewogICAgICBjb25zdCBuZXh0ID0gdGlueS5nZXQoZltpXSkKICAgICAgaWYgKG5leHQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCkgcmV0dXJuCiAgICAgICAgdGlueSA9IHRpbnkuc2V0KGZbaV0sIG5ldyBUaW55QXJyYXkoKSkKICAgICAgfSBlbHNlIHsKICAgICAgICB0aW55ID0gbmV4dAogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRpbnkuc2V0KGZbbGFzdF0sIHZhbCkKICB9CgogIGdldCAoaW5kZXgpIHsKICAgIGlmIChpbmRleCA+PSB0aGlzLm1heExlbmd0aCkgcmV0dXJuCgogICAgY29uc3QgZiA9IGZhY3RvcjQwOTYoaW5kZXgsIHRoaXMuZmFjdG9yKQogICAgY29uc3QgbGFzdCA9IHRoaXMuZmFjdG9yIC0gMQoKICAgIGxldCB0aW55ID0gdGhpcy50aW55CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxhc3Q7IGkrKykgewogICAgICB0aW55ID0gdGlueS5nZXQoZltpXSkKICAgICAgaWYgKHRpbnkgPT09IHVuZGVmaW5lZCkgcmV0dXJuCiAgICB9CgogICAgcmV0dXJuIHRpbnkuZ2V0KGZbbGFzdF0pCiAgfQp9CgpjbGFzcyBUaW55QXJyYXkgewogIGNvbnN0cnVjdG9yICgpIHsKICAgIHRoaXMucyA9IDAKICAgIHRoaXMuYiA9IG5ldyBBcnJheSgxKQogICAgdGhpcy5mID0gbmV3IFVpbnQxNkFycmF5KDEpCiAgfQoKICBpc0VtcHR5aXNoICgpIHsKICAgIHJldHVybiB0aGlzLmIubGVuZ3RoID09PSAxICYmIHRoaXMuYlswXSA9PT0gdW5kZWZpbmVkCiAgfQoKICBnZXQgKGkpIHsKICAgIGlmICh0aGlzLnMgPT09IDEyKSByZXR1cm4gdGhpcy5iW2ldCiAgICBjb25zdCBmID0gaSA+Pj4gdGhpcy5zCiAgICBjb25zdCByID0gaSAmICh0aGlzLmIubGVuZ3RoIC0gMSkKICAgIHJldHVybiB0aGlzLmZbcl0gPT09IGYgPyB0aGlzLmJbcl0gOiB1bmRlZmluZWQKICB9CgogIHNldCAoaSwgdikgewogICAgd2hpbGUgKHRoaXMucyAhPT0gMTIpIHsKICAgICAgY29uc3QgZiA9IGkgPj4+IHRoaXMucwogICAgICBjb25zdCByID0gaSAmICh0aGlzLmIubGVuZ3RoIC0gMSkKICAgICAgY29uc3QgbyA9IHRoaXMuYltyXQoKICAgICAgaWYgKG8gPT09IHVuZGVmaW5lZCB8fCBmID09PSB0aGlzLmZbcl0pIHsKICAgICAgICB0aGlzLmJbcl0gPSB2CiAgICAgICAgdGhpcy5mW3JdID0gZgogICAgICAgIHJldHVybiB2CiAgICAgIH0KCiAgICAgIHRoaXMuZ3JvdygpCiAgICB9CgogICAgdGhpcy5iW2ldID0gdgogICAgcmV0dXJuIHYKICB9CgogIGdyb3cgKCkgewogICAgY29uc3Qgb3MgPSB0aGlzLnMKICAgIGNvbnN0IG9iID0gdGhpcy5iCiAgICBjb25zdCBvZiA9IHRoaXMuZgoKICAgIHRoaXMucyArPSA0CiAgICB0aGlzLmIgPSBuZXcgQXJyYXkodGhpcy5iLmxlbmd0aCA8PCA0KQogICAgdGhpcy5mID0gdGhpcy5zID09PSAxMiA/IG51bGwgOiBuZXcgVWludDhBcnJheSh0aGlzLmIubGVuZ3RoKQoKICAgIGNvbnN0IG0gPSB0aGlzLmIubGVuZ3RoIC0gMQoKICAgIGZvciAobGV0IG9yID0gMDsgb3IgPCBvYi5sZW5ndGg7IG9yKyspIHsKICAgICAgaWYgKG9iW29yXSA9PT0gdW5kZWZpbmVkKSBjb250aW51ZQoKICAgICAgY29uc3QgaSA9IG9mW29yXSA8PCBvcyB8IG9yCiAgICAgIGNvbnN0IGYgPSBpID4+PiB0aGlzLnMKICAgICAgY29uc3QgciA9IGkgJiBtCgogICAgICB0aGlzLmJbcl0gPSBvYltvcl0KICAgICAgaWYgKHRoaXMucyAhPT0gMTIpIHRoaXMuZltyXSA9IGYKICAgIH0KICB9Cn0KewogICJuYW1lIjogImJpZy1zcGFyc2UtYXJyYXkiLAogICJ2ZXJzaW9uIjogIjEuMC4zIiwKICAiZGVzY3JpcHRpb24iOiAiQSBzcGFyc2UgYXJyYXkgb3B0aW1pc2VkIGZvciBsb3cgbWVtb3J5IHdoaWxzdCBzdGlsbCBiZWluZyBmYXN0IiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4xLjEiLAogICAgInN0YW5kYXJkIjogIl4xNi4wLjMiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9iaWctc3BhcnNlLWFycmF5LmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9iaWctc3BhcnNlLWFycmF5L2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2JpZy1zcGFyc2UtYXJyYXkiCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmZ1bmN0aW9uIGJ5dGVMZW5ndGggKHNpemUpIHsKICByZXR1cm4gTWF0aC5jZWlsKHNpemUgLyA4KQp9CgpmdW5jdGlvbiBnZXQgKGJ1ZmZlciwgYml0KSB7CiAgY29uc3QgbiA9IGJ1ZmZlci5CWVRFU19QRVJfRUxFTUVOVCAqIDgKCiAgY29uc3Qgb2Zmc2V0ID0gYml0ICYgKG4gLSAxKQogIGNvbnN0IGkgPSAoYml0IC0gb2Zmc2V0KSAvIG4KCiAgcmV0dXJuIChidWZmZXJbaV0gJiAoMSA8PCBvZmZzZXQpKSAhPT0gMAp9CgpmdW5jdGlvbiBzZXQgKGJ1ZmZlciwgYml0LCB2YWx1ZSA9IHRydWUpIHsKICBjb25zdCBuID0gYnVmZmVyLkJZVEVTX1BFUl9FTEVNRU5UICogOAoKICBjb25zdCBvZmZzZXQgPSBiaXQgJiAobiAtIDEpCiAgY29uc3QgaSA9IChiaXQgLSBvZmZzZXQpIC8gbgogIGNvbnN0IG1hc2sgPSAxIDw8IG9mZnNldAoKICBpZiAodmFsdWUpIHsKICAgIGlmICgoYnVmZmVyW2ldICYgbWFzaykgIT09IDApIHJldHVybiBmYWxzZQogIH0gZWxzZSB7CiAgICBpZiAoKGJ1ZmZlcltpXSAmIG1hc2spID09PSAwKSByZXR1cm4gZmFsc2UKICB9CgogIGJ1ZmZlcltpXSBePSBtYXNrCiAgcmV0dXJuIHRydWUKfQoKZnVuY3Rpb24gc2V0UmFuZ2UgKGJ1ZmZlciwgc3RhcnQsIGVuZCwgdmFsdWUgPSB0cnVlKSB7CiAgY29uc3QgbiA9IGJ1ZmZlci5CWVRFU19QRVJfRUxFTUVOVCAqIDgKCiAgbGV0IHJlbWFpbmluZyA9IGVuZCAtIHN0YXJ0CiAgbGV0IG9mZnNldCA9IHN0YXJ0ICYgKG4gLSAxKQogIGxldCBpID0gKHN0YXJ0IC0gb2Zmc2V0KSAvIG4KCiAgbGV0IGNoYW5nZWQgPSBmYWxzZQoKICB3aGlsZSAocmVtYWluaW5nID4gMCkgewogICAgY29uc3QgbWFzayA9ICgyICoqIE1hdGgubWluKHJlbWFpbmluZywgbiAtIG9mZnNldCkgLSAxKSA8PCBvZmZzZXQKCiAgICBpZiAodmFsdWUpIHsKICAgICAgaWYgKChidWZmZXJbaV0gJiBtYXNrKSAhPT0gbWFzaykgewogICAgICAgIGJ1ZmZlcltpXSB8PSBtYXNrCiAgICAgICAgY2hhbmdlZCA9IHRydWUKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKChidWZmZXJbaV0gJiBtYXNrKSAhPT0gMCkgewogICAgICAgIGJ1ZmZlcltpXSAmPSB+bWFzawogICAgICAgIGNoYW5nZWQgPSB0cnVlCiAgICAgIH0KICAgIH0KCiAgICByZW1haW5pbmcgLT0gbiAtIG9mZnNldAogICAgb2Zmc2V0ID0gMAogICAgaSsrCiAgfQoKICByZXR1cm4gY2hhbmdlZAp9CgpmdW5jdGlvbiBmaWxsIChidWZmZXIsIHZhbHVlLCBzdGFydCA9IDAsIGVuZCA9IGJ1ZmZlci5ieXRlTGVuZ3RoICogOCkgewogIGNvbnN0IG4gPSBidWZmZXIuQllURVNfUEVSX0VMRU1FTlQgKiA4CiAgbGV0IGksIGoKCiAgewogICAgY29uc3Qgb2Zmc2V0ID0gc3RhcnQgJiAobiAtIDEpCiAgICBpID0gKHN0YXJ0IC0gb2Zmc2V0KSAvIG4KCiAgICBpZiAob2Zmc2V0ICE9PSAwKSB7CiAgICAgIGNvbnN0IG1hc2sgPSAoMiAqKiBNYXRoLm1pbihuIC0gb2Zmc2V0LCBlbmQgLSBzdGFydCkgLSAxKSA8PCBvZmZzZXQKCiAgICAgIGlmICh2YWx1ZSkgYnVmZmVyW2ldIHw9IG1hc2sKICAgICAgZWxzZSBidWZmZXJbaV0gJj0gfm1hc2sKCiAgICAgIGkrKwogICAgfQogIH0KCiAgewogICAgY29uc3Qgb2Zmc2V0ID0gZW5kICYgKG4gLSAxKQogICAgaiA9IChlbmQgLSBvZmZzZXQpIC8gbgoKICAgIGlmIChvZmZzZXQgIT09IDAgJiYgaiA+PSBpKSB7CiAgICAgIGNvbnN0IG1hc2sgPSAoMiAqKiBvZmZzZXQpIC0gMQoKICAgICAgaWYgKHZhbHVlKSBidWZmZXJbal0gfD0gbWFzawogICAgICBlbHNlIGJ1ZmZlcltqXSAmPSB+bWFzawogICAgfQogIH0KCiAgcmV0dXJuIGJ1ZmZlci5maWxsKHZhbHVlID8gKDIgKiogbikgLSAxIDogMCwgaSwgaikKfQoKZnVuY3Rpb24gdG9nZ2xlIChidWZmZXIsIGJpdCkgewogIGNvbnN0IG4gPSBidWZmZXIuQllURVNfUEVSX0VMRU1FTlQgKiA4CgogIGNvbnN0IG9mZnNldCA9IGJpdCAmIChuIC0gMSkKICBjb25zdCBpID0gKGJpdCAtIG9mZnNldCkgLyBuCiAgY29uc3QgbWFzayA9IDEgPDwgb2Zmc2V0CgogIGJ1ZmZlcltpXSBePSBtYXNrCiAgcmV0dXJuIChidWZmZXJbaV0gJiBtYXNrKSAhPT0gMAp9CgpmdW5jdGlvbiByZW1vdmUgKGJ1ZmZlciwgYml0KSB7CiAgcmV0dXJuIHNldChidWZmZXIsIGJpdCwgZmFsc2UpCn0KCmZ1bmN0aW9uIHJlbW92ZVJhbmdlIChidWZmZXIsIHN0YXJ0LCBlbmQpIHsKICByZXR1cm4gc2V0UmFuZ2UoYnVmZmVyLCBzdGFydCwgZW5kLCBmYWxzZSkKfQoKZnVuY3Rpb24gaW5kZXhPZiAoYnVmZmVyLCB2YWx1ZSwgcG9zaXRpb24gPSAwKSB7CiAgZm9yIChsZXQgaSA9IHBvc2l0aW9uLCBuID0gYnVmZmVyLmJ5dGVMZW5ndGggKiA4OyBpIDwgbjsgaSsrKSB7CiAgICBpZiAoZ2V0KGJ1ZmZlciwgaSkgPT09IHZhbHVlKSByZXR1cm4gaQogIH0KCiAgcmV0dXJuIC0xCn0KCmZ1bmN0aW9uIGxhc3RJbmRleE9mIChidWZmZXIsIHZhbHVlLCBwb3NpdGlvbiA9IGJ1ZmZlci5ieXRlTGVuZ3RoICogOCAtIDEpIHsKICBmb3IgKGxldCBpID0gcG9zaXRpb247IGkgPj0gMDsgaS0tKSB7CiAgICBpZiAoZ2V0KGJ1ZmZlciwgaSkgPT09IHZhbHVlKSByZXR1cm4gaQogIH0KCiAgcmV0dXJuIC0xCn0KCmZ1bmN0aW9uIG9mICguLi5iaXRzKSB7CiAgcmV0dXJuIGZyb20oYml0cykKfQoKZnVuY3Rpb24gZnJvbSAoYml0cykgewogIGNvbnN0IGJ1ZmZlciA9IGI0YS5hbGxvYyhieXRlTGVuZ3RoKGJpdHMubGVuZ3RoKSkKICBmb3IgKGxldCBpID0gMDsgaSA8IGJpdHMubGVuZ3RoOyBpKyspIHNldChidWZmZXIsIGksIGJpdHNbaV0pCiAgcmV0dXJuIGJ1ZmZlcgp9CgpmdW5jdGlvbiAqIGl0ZXJhdG9yIChidWZmZXIpIHsKICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1ZmZlci5ieXRlTGVuZ3RoICogODsgaSA8IG47IGkrKykgeWllbGQgZ2V0KGJ1ZmZlciwgaSkKfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgYnl0ZUxlbmd0aCwKICBnZXQsCiAgc2V0LAogIHNldFJhbmdlLAogIGZpbGwsCiAgdG9nZ2xlLAogIHJlbW92ZSwKICByZW1vdmVSYW5nZSwKICBpbmRleE9mLAogIGxhc3RJbmRleE9mLAogIG9mLAogIGZyb20sCiAgaXRlcmF0b3IKfQp7CiAgIm5hbWUiOiAiYml0cy10by1ieXRlcyIsCiAgInZlcnNpb24iOiAiMS4zLjAiLAogICJkZXNjcmlwdGlvbiI6ICJGdW5jdGlvbnMgZm9yIGRvaW5nIGJpdCBtYW5pcHVsYXRpb24gb2YgdHlwZWQgYXJyYXlzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QubWpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JpdHMtdG8tYnl0ZXMuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJLYXNwZXIgSXNhZ2VyIERhbHNnYXLDsCA8a2FzcGVyQGZ1bmt0aW9uZWwuY28+IiwKICAibGljZW5zZSI6ICJJU0MiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYml0cy10by1ieXRlcy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JpdHMtdG8tYnl0ZXMjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS41LjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjIuMy4xIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0KfQpjb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCBQcm90b211eCA9IHJlcXVpcmUoJ3Byb3RvbXV4JykKY29uc3QgeyBSZWFkYWJsZSB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGJpdGZpZWxkID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZCcpCmNvbnN0IGJpdHMgPSByZXF1aXJlKCdiaXRzLXRvLWJ5dGVzJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi9saWIvZXJyb3JzJykKCmV4cG9ydHMuU2VydmVyID0gY2xhc3MgQmxpbmRSZWxheVNlcnZlciBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIGNvbnN0IHsKICAgICAgY3JlYXRlU3RyZWFtCiAgICB9ID0gb3B0cwoKICAgIHRoaXMuX2NyZWF0ZVN0cmVhbSA9IGNyZWF0ZVN0cmVhbQogICAgdGhpcy5fcGFpcmluZyA9IG5ldyBNYXAoKQogICAgdGhpcy5fc2Vzc2lvbnMgPSBuZXcgU2V0KCkKICB9CgogIGdldCBzZXNzaW9ucyAoKSB7CiAgICByZXR1cm4gdGhpcy5fc2Vzc2lvbnNbU3ltYm9sLml0ZXJhdG9yXSgpCiAgfQoKICBhY2NlcHQgKHN0cmVhbSwgb3B0cykgewogICAgY29uc3Qgc2Vzc2lvbiA9IG5ldyBCbGluZFJlbGF5U2Vzc2lvbih0aGlzLCBzdHJlYW0sIG9wdHMpCgogICAgdGhpcy5fc2Vzc2lvbnMuYWRkKHNlc3Npb24pCgogICAgcmV0dXJuIHNlc3Npb24KICB9CgogIGFzeW5jIGNsb3NlICgpIHsKICAgIGNvbnN0IGVuZGluZyA9IFtdCgogICAgZm9yIChjb25zdCBzZXNzaW9uIG9mIHRoaXMuX3Nlc3Npb25zKSB7CiAgICAgIGVuZGluZy5wdXNoKHNlc3Npb24uZW5kKCkpCiAgICB9CgogICAgYXdhaXQgUHJvbWlzZS5hbGwoZW5kaW5nKQoKICAgIHRoaXMuX3BhaXJpbmcuY2xlYXIoKQogIH0KfQoKY2xhc3MgQmxpbmRSZWxheVNlc3Npb24gZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yIChzZXJ2ZXIsIHN0cmVhbSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgY29uc3QgewogICAgICBpZCwKICAgICAgaGFuZHNoYWtlLAogICAgICBoYW5kc2hha2VFbmNvZGluZwogICAgfSA9IG9wdHMKCiAgICB0aGlzLl9zZXJ2ZXIgPSBzZXJ2ZXIKICAgIHRoaXMuX211eCA9IFByb3RvbXV4LmZyb20oc3RyZWFtKQoKICAgIHRoaXMuX2NoYW5uZWwgPSB0aGlzLl9tdXguY3JlYXRlQ2hhbm5lbCh7CiAgICAgIHByb3RvY29sOiAnYmxpbmQtcmVsYXknLAogICAgICBpZCwKICAgICAgaGFuZHNoYWtlOiBoYW5kc2hha2UgPyBoYW5kc2hha2VFbmNvZGluZyB8fCBjLnJhdyA6IG51bGwsCiAgICAgIG9ub3BlbjogdGhpcy5fb25vcGVuLmJpbmQodGhpcyksCiAgICAgIG9uY2xvc2U6IHRoaXMuX29uY2xvc2UuYmluZCh0aGlzKSwKICAgICAgb25kZXN0cm95OiB0aGlzLl9vbmRlc3Ryb3kuYmluZCh0aGlzKQogICAgfSkKCiAgICB0aGlzLl9wYWlyID0gdGhpcy5fY2hhbm5lbC5hZGRNZXNzYWdlKHsKICAgICAgZW5jb2Rpbmc6IG0ucGFpciwKICAgICAgb25tZXNzYWdlOiB0aGlzLl9vbnBhaXIuYmluZCh0aGlzKQogICAgfSkKCiAgICB0aGlzLl91bnBhaXIgPSB0aGlzLl9jaGFubmVsLmFkZE1lc3NhZ2UoewogICAgICBlbmNvZGluZzogbS51bnBhaXIsCiAgICAgIG9ubWVzc2FnZTogdGhpcy5fb251bnBhaXIuYmluZCh0aGlzKQogICAgfSkKCiAgICB0aGlzLl9lbmRpbmcgPSBudWxsCiAgICB0aGlzLl9kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5fZXJyb3IgPSBudWxsCiAgICB0aGlzLl9wYWlyaW5nID0gbmV3IFNldCgpCiAgICB0aGlzLl9zdHJlYW1zID0gbmV3IE1hcCgpCgogICAgdGhpcy5fb25lcnJvciA9IChlcnIpID0+IHRoaXMuZW1pdCgnZXJyb3InLCBlcnIpCgogICAgdGhpcy5fY2hhbm5lbC5vcGVuKGhhbmRzaGFrZSkKICB9CgogIGdldCBjbG9zZWQgKCkgewogICAgcmV0dXJuIHRoaXMuX2NoYW5uZWwuY2xvc2VkCiAgfQoKICBnZXQgbXV4ICgpIHsKICAgIHJldHVybiB0aGlzLl9tdXgKICB9CgogIGdldCBzdHJlYW0gKCkgewogICAgcmV0dXJuIHRoaXMuX211eC5zdHJlYW0KICB9CgogIF9vbm9wZW4gKCkgewogICAgdGhpcy5lbWl0KCdvcGVuJykKICB9CgogIF9vbmNsb3NlICgpIHsKICAgIHRoaXMuX2VuZGluZyA9IFByb21pc2UucmVzb2x2ZSgpCgogICAgY29uc3QgZXJyID0gdGhpcy5fZXJyb3IgfHwgZXJyb3JzLkNIQU5ORUxfQ0xPU0VEKCkKCiAgICBmb3IgKGNvbnN0IHRva2VuIG9mIHRoaXMuX3BhaXJpbmcpIHsKICAgICAgdGhpcy5fc2VydmVyLl9wYWlyaW5nLmRlbGV0ZSh0b2tlbi50b1N0cmluZygnaGV4JykpCiAgICB9CgogICAgZm9yIChjb25zdCBzdHJlYW0gb2YgdGhpcy5fc3RyZWFtcy52YWx1ZXMoKSkgewogICAgICBzdHJlYW0KICAgICAgICAub2ZmKCdlcnJvcicsIHRoaXMuX29uZXJyb3IpCiAgICAgICAgLm9uKCdlcnJvcicsIG5vb3ApCiAgICAgICAgLmRlc3Ryb3koZXJyKQogICAgfQoKICAgIHRoaXMuX3BhaXJpbmcuY2xlYXIoKQogICAgdGhpcy5fc3RyZWFtcy5jbGVhcigpCgogICAgdGhpcy5fc2VydmVyLl9zZXNzaW9ucy5kZWxldGUodGhpcykKCiAgICB0aGlzLmVtaXQoJ2Nsb3NlJykKICB9CgogIF9vbmRlc3Ryb3kgKCkgewogICAgdGhpcy5fZGVzdHJveWVkID0gdHJ1ZQogICAgdGhpcy5lbWl0KCdkZXN0cm95JykKICB9CgogIF9vbnBhaXIgKHsgaXNJbml0aWF0b3IsIHRva2VuLCBpZDogcmVtb3RlSWQgfSkgewogICAgY29uc3Qga2V5U3RyaW5nID0gdG9rZW4udG9TdHJpbmcoJ2hleCcpCgogICAgbGV0IHBhaXIgPSB0aGlzLl9zZXJ2ZXIuX3BhaXJpbmcuZ2V0KGtleVN0cmluZykKCiAgICBpZiAocGFpciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHBhaXIgPSBuZXcgQmxpbmRSZWxheVBhaXIodG9rZW4pCiAgICAgIHRoaXMuX3NlcnZlci5fcGFpcmluZy5zZXQoa2V5U3RyaW5nLCBwYWlyKQogICAgfSBlbHNlIGlmIChwYWlyLmxpbmtzWytpc0luaXRpYXRvcl0pIHJldHVybgoKICAgIHRoaXMuX3BhaXJpbmcuYWRkKGtleVN0cmluZykKCiAgICBwYWlyLmxpbmtzWytpc0luaXRpYXRvcl0gPSBuZXcgQmxpbmRSZWxheUxpbmsodGhpcywgaXNJbml0aWF0b3IsIHJlbW90ZUlkKQoKICAgIGlmICghcGFpci5wYWlyZWQpIHJldHVybgoKICAgIHRoaXMuX3NlcnZlci5fcGFpcmluZy5kZWxldGUoa2V5U3RyaW5nKQoKICAgIC8vIDFzdCBwYXNzOiBDcmVhdGUgdGhlIHJhdyBzdHJlYW1zIG5lZWRlZCBmb3IgZWFjaCBlbmQgb2YgdGhlIGxpbmsuCiAgICBmb3IgKGNvbnN0IGxpbmsgb2YgcGFpci5saW5rcykgewogICAgICBsaW5rLmNyZWF0ZVN0cmVhbSgpCiAgICB9CgogICAgLy8gMm5kIHBhc3M6IENvbm5lY3QgdGhlIHJhdyBzdHJlYW1zIGFuZCBzZXQgdXAgaGFuZGxlcnMuCiAgICBmb3IgKGNvbnN0IHsgaXNJbml0aWF0b3IsIHNlc3Npb24sIHN0cmVhbSB9IG9mIHBhaXIubGlua3MpIHsKICAgICAgY29uc3QgcmVtb3RlID0gcGFpci5yZW1vdGUoaXNJbml0aWF0b3IpCgogICAgICBzdHJlYW0KICAgICAgICAub24oJ2Vycm9yJywgc2Vzc2lvbi5fb25lcnJvcikKICAgICAgICAub24oJ2Nsb3NlJywgKCkgPT4gc2Vzc2lvbi5fc3RyZWFtcy5kZWxldGUoa2V5U3RyaW5nKSkKICAgICAgICAucmVsYXlUbyhyZW1vdGUuc3RyZWFtKQoKICAgICAgc2Vzc2lvbi5fcGFpcmluZy5kZWxldGUoa2V5U3RyaW5nKQogICAgICBzZXNzaW9uLl9zdHJlYW1zLnNldChrZXlTdHJpbmcsIHN0cmVhbSkKICAgIH0KCiAgICAvLyAzcmQgcGFzczogTGV0IGVpdGhlciBlbmQgb2YgdGhlIGxpbmsga25vdyB0aGUgc3RyZWFtcyB3ZXJlIHNldCB1cC4KICAgIGZvciAoY29uc3QgeyBpc0luaXRpYXRvciwgc2Vzc2lvbiwgcmVtb3RlSWQsIHN0cmVhbSB9IG9mIHBhaXIubGlua3MpIHsKICAgICAgc2Vzc2lvbi5fcGFpci5zZW5kKHsKICAgICAgICBpc0luaXRpYXRvciwKICAgICAgICB0b2tlbiwKICAgICAgICBpZDogc3RyZWFtLmlkLAogICAgICAgIHNlcTogMAogICAgICB9KQoKICAgICAgc2Vzc2lvbi5fZW5kTWF5YmUoKQoKICAgICAgc2Vzc2lvbi5lbWl0KCdwYWlyJywgaXNJbml0aWF0b3IsIHRva2VuLCBzdHJlYW0sIHJlbW90ZUlkKQogICAgfQogIH0KCiAgX29udW5wYWlyICh7IHRva2VuIH0pIHsKICAgIGNvbnN0IGtleVN0cmluZyA9IHRva2VuLnRvU3RyaW5nKCdoZXgnKQoKICAgIGNvbnN0IHBhaXIgPSB0aGlzLl9zZXJ2ZXIuX3BhaXJpbmcuZ2V0KGtleVN0cmluZykKCiAgICBpZiAocGFpcikgewogICAgICBmb3IgKGNvbnN0IGxpbmsgb2YgcGFpci5saW5rcykgewogICAgICAgIGlmIChsaW5rKSBsaW5rLnNlc3Npb24uX3BhaXJpbmcuZGVsZXRlKGtleVN0cmluZykKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuX3NlcnZlci5fcGFpcmluZy5kZWxldGUoa2V5U3RyaW5nKQogICAgfQoKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuX3N0cmVhbXMuZ2V0KGtleVN0cmluZykKCiAgICBpZiAoc3RyZWFtKSB7CiAgICAgIHN0cmVhbQogICAgICAgIC5vZmYoJ2Vycm9yJywgdGhpcy5fb25lcnJvcikKICAgICAgICAub24oJ2Vycm9yJywgbm9vcCkKICAgICAgICAuZGVzdHJveShlcnJvcnMuUEFJUklOR19DQU5DRUxMRUQoKSkKCiAgICAgIHRoaXMuX3N0cmVhbXMuZGVsZXRlKGtleVN0cmluZykKICAgIH0KICB9CgogIGNvcmsgKCkgewogICAgdGhpcy5fY2hhbm5lbC5jb3JrKCkKICB9CgogIHVuY29yayAoKSB7CiAgICB0aGlzLl9jaGFubmVsLnVuY29yaygpCiAgfQoKICBhc3luYyBlbmQgKCkgewogICAgaWYgKHRoaXMuX2VuZGluZykgcmV0dXJuIHRoaXMuX2VuZGluZwoKICAgIHRoaXMuX2VuZGluZyA9IEV2ZW50RW1pdHRlci5vbmNlKHRoaXMsICdjbG9zZScpCiAgICB0aGlzLl9lbmRNYXliZSgpCgogICAgcmV0dXJuIHRoaXMuX2VuZGluZwogIH0KCiAgX2VuZE1heWJlICgpIHsKICAgIGlmICh0aGlzLl9lbmRpbmcgJiYgdGhpcy5fcGFpcmluZy5zaXplID09PSAwKSB7CiAgICAgIHRoaXMuX2NoYW5uZWwuY2xvc2UoKQogICAgfQogIH0KCiAgZGVzdHJveSAoZXJyKSB7CiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuX2Rlc3Ryb3llZCA9IHRydWUKCiAgICB0aGlzLl9lcnJvciA9IGVyciB8fCBlcnJvcnMuQ0hBTk5FTF9ERVNUUk9ZRUQoKQogICAgdGhpcy5fY2hhbm5lbC5jbG9zZSgpCiAgfQp9CgpjbGFzcyBCbGluZFJlbGF5UGFpciB7CiAgY29uc3RydWN0b3IgKHRva2VuKSB7CiAgICB0aGlzLnRva2VuID0gdG9rZW4KICAgIHRoaXMubGlua3MgPSBbbnVsbCwgbnVsbF0KICB9CgogIGdldCBwYWlyZWQgKCkgewogICAgcmV0dXJuIHRoaXMubGlua3NbMF0gIT09IG51bGwgJiYgdGhpcy5saW5rc1sxXSAhPT0gbnVsbAogIH0KCiAgcmVtb3RlIChpc0luaXRpYXRvcikgewogICAgcmV0dXJuIHRoaXMubGlua3NbaXNJbml0aWF0b3IgPyAwIDogMV0KICB9Cn0KCmNsYXNzIEJsaW5kUmVsYXlMaW5rIHsKICBjb25zdHJ1Y3RvciAoc2Vzc2lvbiwgaXNJbml0aWF0b3IsIHJlbW90ZUlkKSB7CiAgICB0aGlzLnNlc3Npb24gPSBzZXNzaW9uCiAgICB0aGlzLmlzSW5pdGlhdG9yID0gaXNJbml0aWF0b3IKICAgIHRoaXMucmVtb3RlSWQgPSByZW1vdGVJZAogICAgdGhpcy5zdHJlYW0gPSBudWxsCiAgfQoKICBjcmVhdGVTdHJlYW0gKCkgewogICAgaWYgKHRoaXMuc3RyZWFtKSByZXR1cm4KCiAgICB0aGlzLnN0cmVhbSA9IHRoaXMuc2Vzc2lvbi5fc2VydmVyLl9jcmVhdGVTdHJlYW0oewogICAgICBmaXJld2FsbDogdGhpcy5fb25maXJld2FsbC5iaW5kKHRoaXMpCiAgICB9KQogIH0KCiAgX29uZmlyZXdhbGwgKHNvY2tldCwgcG9ydCwgaG9zdCkgewogICAgdGhpcy5zdHJlYW0uY29ubmVjdChzb2NrZXQsIHRoaXMucmVtb3RlSWQsIHBvcnQsIGhvc3QpCgogICAgcmV0dXJuIGZhbHNlCiAgfQp9CgpleHBvcnRzLkNsaWVudCA9IGNsYXNzIEJsaW5kUmVsYXlDbGllbnQgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIHN0YXRpYyBfY2xpZW50cyA9IG5ldyBXZWFrTWFwKCkKCiAgc3RhdGljIGZyb20gKHN0cmVhbSwgb3B0cykgewogICAgbGV0IGNsaWVudCA9IHRoaXMuX2NsaWVudHMuZ2V0KHN0cmVhbSkKICAgIGlmIChjbGllbnQpIHJldHVybiBjbGllbnQKICAgIGNsaWVudCA9IG5ldyB0aGlzKHN0cmVhbSwgb3B0cykKICAgIHRoaXMuX2NsaWVudHMuc2V0KHN0cmVhbSwgY2xpZW50KQogICAgcmV0dXJuIGNsaWVudAogIH0KCiAgY29uc3RydWN0b3IgKHN0cmVhbSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgY29uc3QgewogICAgICBpZCwKICAgICAgaGFuZHNoYWtlLAogICAgICBoYW5kc2hha2VFbmNvZGluZwogICAgfSA9IG9wdHMKCiAgICB0aGlzLl9tdXggPSBQcm90b211eC5mcm9tKHN0cmVhbSkKCiAgICB0aGlzLl9jaGFubmVsID0gdGhpcy5fbXV4LmNyZWF0ZUNoYW5uZWwoewogICAgICBwcm90b2NvbDogJ2JsaW5kLXJlbGF5JywKICAgICAgaWQsCiAgICAgIGhhbmRzaGFrZTogaGFuZHNoYWtlID8gaGFuZHNoYWtlRW5jb2RpbmcgfHwgYy5yYXcgOiBudWxsLAogICAgICBvbm9wZW46IHRoaXMuX29ub3Blbi5iaW5kKHRoaXMpLAogICAgICBvbmNsb3NlOiB0aGlzLl9vbmNsb3NlLmJpbmQodGhpcyksCiAgICAgIG9uZGVzdHJveTogdGhpcy5fb25kZXN0cm95LmJpbmQodGhpcykKICAgIH0pCgogICAgdGhpcy5fcGFpciA9IHRoaXMuX2NoYW5uZWwuYWRkTWVzc2FnZSh7CiAgICAgIGVuY29kaW5nOiBtLnBhaXIsCiAgICAgIG9ubWVzc2FnZTogdGhpcy5fb25wYWlyLmJpbmQodGhpcykKICAgIH0pCgogICAgdGhpcy5fdW5wYWlyID0gdGhpcy5fY2hhbm5lbC5hZGRNZXNzYWdlKHsKICAgICAgZW5jb2Rpbmc6IG0udW5wYWlyCiAgICB9KQoKICAgIHRoaXMuX2VuZGluZyA9IGZhbHNlCiAgICB0aGlzLl9kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5fZXJyb3IgPSBudWxsCiAgICB0aGlzLl9yZXF1ZXN0cyA9IG5ldyBNYXAoKQoKICAgIHRoaXMuX2NoYW5uZWwub3BlbihoYW5kc2hha2UpCiAgfQoKICBnZXQgY2xvc2VkICgpIHsKICAgIHJldHVybiB0aGlzLl9jaGFubmVsLmNsb3NlZAogIH0KCiAgZ2V0IG11eCAoKSB7CiAgICByZXR1cm4gdGhpcy5fbXV4CiAgfQoKICBnZXQgc3RyZWFtICgpIHsKICAgIHJldHVybiB0aGlzLl9tdXguc3RyZWFtCiAgfQoKICBnZXQgcmVxdWVzdHMgKCkgewogICAgcmV0dXJuIHRoaXMuX3JlcXVlc3RzLnZhbHVlcygpCiAgfQoKICBfb25vcGVuICgpIHsKICAgIHRoaXMuZW1pdCgnb3BlbicpCiAgfQoKICBfb25jbG9zZSAoKSB7CiAgICB0aGlzLl9lbmRpbmcgPSBQcm9taXNlLnJlc29sdmUoKQoKICAgIGNvbnN0IGVyciA9IHRoaXMuX2Vycm9yIHx8IGVycm9ycy5DSEFOTkVMX0NMT1NFRCgpCgogICAgZm9yIChjb25zdCByZXF1ZXN0IG9mIHRoaXMuX3JlcXVlc3RzLnZhbHVlcygpKSB7CiAgICAgIHJlcXVlc3QuZGVzdHJveShlcnIpCiAgICB9CgogICAgdGhpcy5fcmVxdWVzdHMuY2xlYXIoKQoKICAgIHRoaXMuY29uc3RydWN0b3IuX2NsaWVudHMuZGVsZXRlKHRoaXMuc3RyZWFtKQoKICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogIH0KCiAgX29uZGVzdHJveSAoKSB7CiAgICB0aGlzLl9kZXN0cm95ZWQgPSB0cnVlCiAgICB0aGlzLmVtaXQoJ2Rlc3Ryb3knKQogIH0KCiAgX29ucGFpciAoeyBpc0luaXRpYXRvciwgdG9rZW4sIGlkOiByZW1vdGVJZCB9KSB7CiAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fcmVxdWVzdHMuZ2V0KHRva2VuLnRvU3RyaW5nKCdoZXgnKSkKCiAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkIHx8IHJlcXVlc3QuaXNJbml0aWF0b3IgIT09IGlzSW5pdGlhdG9yKSByZXR1cm4KCiAgICByZXF1ZXN0LnB1c2gocmVtb3RlSWQpCiAgICByZXF1ZXN0LnB1c2gobnVsbCkKCiAgICB0aGlzLmVtaXQoJ3BhaXInLCByZXF1ZXN0LmlzSW5pdGlhdG9yLCByZXF1ZXN0LnRva2VuLCByZXF1ZXN0LnN0cmVhbSwgcmVtb3RlSWQpCiAgfQoKICBwYWlyIChpc0luaXRpYXRvciwgdG9rZW4sIHN0cmVhbSkgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgdGhyb3cgZXJyb3JzLkNIQU5ORUxfREVTVFJPWUVEKCkKCiAgICBjb25zdCBrZXlTdHJpbmcgPSB0b2tlbi50b1N0cmluZygnaGV4JykKCiAgICBpZiAodGhpcy5fcmVxdWVzdHMuaGFzKGtleVN0cmluZykpIHRocm93IGVycm9ycy5BTFJFQURZX1BBSVJJTkcoKQoKICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgQmxpbmRSZWxheVJlcXVlc3QodGhpcywgaXNJbml0aWF0b3IsIHRva2VuLCBzdHJlYW0pCgogICAgdGhpcy5fcmVxdWVzdHMuc2V0KGtleVN0cmluZywgcmVxdWVzdCkKCiAgICByZXR1cm4gcmVxdWVzdAogIH0KCiAgdW5wYWlyICh0b2tlbikgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgdGhyb3cgZXJyb3JzLkNIQU5ORUxfREVTVFJPWUVEKCkKCiAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fcmVxdWVzdHMuZ2V0KHRva2VuLnRvU3RyaW5nKCdoZXgnKSkKCiAgICBpZiAocmVxdWVzdCkgcmVxdWVzdC5kZXN0cm95KGVycm9ycy5QQUlSSU5HX0NBTkNFTExFRCgpKQoKICAgIHRoaXMuX3VucGFpci5zZW5kKHsgdG9rZW4gfSkKICB9CgogIGNvcmsgKCkgewogICAgdGhpcy5fY2hhbm5lbC5jb3JrKCkKICB9CgogIHVuY29yayAoKSB7CiAgICB0aGlzLl9jaGFubmVsLnVuY29yaygpCiAgfQoKICBhc3luYyBlbmQgKCkgewogICAgaWYgKHRoaXMuX2VuZGluZykgcmV0dXJuIHRoaXMuX2VuZGluZwoKICAgIHRoaXMuX2VuZGluZyA9IEV2ZW50RW1pdHRlci5vbmNlKHRoaXMsICdjbG9zZScpCiAgICB0aGlzLl9lbmRNYXliZSgpCgogICAgcmV0dXJuIHRoaXMuX2VuZGluZwogIH0KCiAgX2VuZE1heWJlICgpIHsKICAgIGlmICh0aGlzLl9lbmRpbmcgJiYgdGhpcy5fcmVxdWVzdHMuc2l6ZSA9PT0gMCkgewogICAgICB0aGlzLl9jaGFubmVsLmNsb3NlKCkKICAgIH0KICB9CgogIGRlc3Ryb3kgKGVycikgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLl9kZXN0cm95ZWQgPSB0cnVlCgogICAgdGhpcy5fZXJyb3IgPSBlcnIgfHwgZXJyb3JzLkNIQU5ORUxfREVTVFJPWUVEKCkKICAgIHRoaXMuX2NoYW5uZWwuY2xvc2UoKQogIH0KfQoKY2xhc3MgQmxpbmRSZWxheVJlcXVlc3QgZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3IgKGNsaWVudCwgaXNJbml0aWF0b3IsIHRva2VuLCBzdHJlYW0pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmNsaWVudCA9IGNsaWVudAogICAgdGhpcy5pc0luaXRpYXRvciA9IGlzSW5pdGlhdG9yCiAgICB0aGlzLnRva2VuID0gdG9rZW4KICAgIHRoaXMuc3RyZWFtID0gc3RyZWFtCiAgfQoKICBfb3BlbiAoY2IpIHsKICAgIGlmICh0aGlzLmNsaWVudC5fZGVzdHJveWVkKSByZXR1cm4gY2IoZXJyb3JzLkNIQU5ORUxfREVTVFJPWUVEKCkpCgogICAgdGhpcy5jbGllbnQuX3BhaXIuc2VuZCh7CiAgICAgIGlzSW5pdGlhdG9yOiB0aGlzLmlzSW5pdGlhdG9yLAogICAgICB0b2tlbjogdGhpcy50b2tlbiwKICAgICAgaWQ6IHRoaXMuc3RyZWFtLmlkLAogICAgICBzZXE6IDAKICAgIH0pCgogICAgY2IobnVsbCkKICB9CgogIF9kZXN0cm95IChjYikgewogICAgdGhpcy5jbGllbnQuX3JlcXVlc3RzLmRlbGV0ZSh0aGlzLnRva2VuLnRvU3RyaW5nKCdoZXgnKSkKCiAgICBjYihudWxsKQoKICAgIHRoaXMuY2xpZW50Ll9lbmRNYXliZSgpCiAgfQp9CgpleHBvcnRzLnRva2VuID0gZnVuY3Rpb24gdG9rZW4gKGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZSgzMikpIHsKICBzb2RpdW0ucmFuZG9tYnl0ZXNfYnVmKGJ1ZikKICByZXR1cm4gYnVmCn0KCmZ1bmN0aW9uIG5vb3AgKCkge30KCmNvbnN0IG0gPSBleHBvcnRzLm1lc3NhZ2VzID0ge30KCmNvbnN0IGZsYWdzID0gYml0ZmllbGQoNykKCm0ucGFpciA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBmbGFncy5wcmVlbmNvZGUoc3RhdGUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnRva2VuKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc2VxKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgZmxhZ3MuZW5jb2RlKHN0YXRlLCBiaXRzLm9mKG0uaXNJbml0aWF0b3IpKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS50b2tlbikKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uaWQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnNlcSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IFtpc0luaXRpYXRvcl0gPSBiaXRzLml0ZXJhdG9yKGZsYWdzLmRlY29kZShzdGF0ZSkpCgogICAgcmV0dXJuIHsKICAgICAgaXNJbml0aWF0b3IsCiAgICAgIHRva2VuOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgaWQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzZXE6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CgptLnVucGFpciA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBmbGFncy5wcmVlbmNvZGUoc3RhdGUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnRva2VuKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgZmxhZ3MuZW5jb2RlKHN0YXRlLCBiaXRzLm9mKCkpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnRva2VuKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgZmxhZ3MuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHRva2VuOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEJsaW5kUmVsYXlFcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3RvciAobXNnLCBjb2RlLCBmbiA9IEJsaW5kUmVsYXlFcnJvcikgewogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWApCiAgICB0aGlzLmNvZGUgPSBjb2RlCgogICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIGZuKQogICAgfQogIH0KCiAgZ2V0IG5hbWUgKCkgewogICAgcmV0dXJuICdCbGluZFJlbGF5RXJyb3InCiAgfQoKICBzdGF0aWMgRFVQTElDQVRFX0NIQU5ORUwgKG1zZyA9ICdEdXBsaWNhdGUgY2hhbm5lbCcpIHsKICAgIHJldHVybiBuZXcgQmxpbmRSZWxheUVycm9yKG1zZywgJ0RVUExJQ0FURV9DSEFOTkVMJywgQmxpbmRSZWxheUVycm9yLkRVUExJQ0FURV9DSEFOTkVMKQogIH0KCiAgc3RhdGljIENIQU5ORUxfQ0xPU0VEIChtc2cgPSAnQ2hhbm5lbCBjbG9zZWQnKSB7CiAgICByZXR1cm4gbmV3IEJsaW5kUmVsYXlFcnJvcihtc2csICdDSEFOTkVMX0NMT1NFRCcsIEJsaW5kUmVsYXlFcnJvci5DSEFOTkVMX0NMT1NFRCkKICB9CgogIHN0YXRpYyBDSEFOTkVMX0RFU1RST1lFRCAobXNnID0gJ0NoYW5uZWwgZGVzdHJveWVkJykgewogICAgcmV0dXJuIG5ldyBCbGluZFJlbGF5RXJyb3IobXNnLCAnQ0hBTk5FTF9ERVNUUk9ZRUQnLCBCbGluZFJlbGF5RXJyb3IuQ0hBTk5FTF9ERVNUUk9ZRUQpCiAgfQoKICBzdGF0aWMgQUxSRUFEWV9QQUlSSU5HIChtc2cgPSAnQWxyZWFkeSBwYWlyaW5nJykgewogICAgcmV0dXJuIG5ldyBCbGluZFJlbGF5RXJyb3IobXNnLCAnQUxSRUFEWV9QQUlSSU5HJywgQmxpbmRSZWxheUVycm9yLkFMUkVBRFlfUEFJUklORykKICB9CgogIHN0YXRpYyBQQUlSSU5HX0NBTkNFTExFRCAobXNnID0gJ1BhaXJpbmcgY2FuY2VsbGVkJykgewogICAgcmV0dXJuIG5ldyBCbGluZFJlbGF5RXJyb3IobXNnLCAnUEFJUklOR19DQU5DRUxMRUQnLCBCbGluZFJlbGF5RXJyb3IuUEFJUklOR19DQU5DRUxMRUQpCiAgfQp9CnsKICAibmFtZSI6ICJibGluZC1yZWxheSIsCiAgInZlcnNpb24iOiAiMS40LjAiLAogICJkZXNjcmlwdGlvbiI6ICJCbGluZCByZWxheSBmb3IgVURYIG92ZXIgUHJvdG9tdXggY2hhbm5lbHMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYiIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0Lm1qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9ibGluZC1yZWxheS5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9ibGluZC1yZWxheS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JsaW5kLXJlbGF5I3JlYWRtZSIsCiAgImltcG9ydHMiOiB7CiAgICAiZXZlbnRzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWV2ZW50cyIsCiAgICAgICJkZWZhdWx0IjogImV2ZW50cyIKICAgIH0KICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNCIsCiAgICAiYmFyZS1ldmVudHMiOiAiXjIuMi4wIiwKICAgICJiaXRzLXRvLWJ5dGVzIjogIl4xLjMuMCIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xMi4wIiwKICAgICJjb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkIjogIl4xLjAuMCIsCiAgICAicHJvdG9tdXgiOiAiXjMuNS4xIiwKICAgICJzb2RpdW0tdW5pdmVyc2FsIjogIl41LjAuMCIsCiAgICAic3RyZWFteCI6ICJeMi4xNS4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjIuMSIsCiAgICAiaHlwZXJkaHQiOiAiXjYuNi4xIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIiwKICAgICJ1ZHgtbmF0aXZlIjogIl4xLjYuMSIKICB9Cn0KLy8gaHR0cHM6Ly9pcGluZm8uaW8vYm9nb24KCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgbmV0ID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZy1uZXQnKQoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gZnVuY3Rpb24gaXNCb2dvbiAoaXApIHsKICByZXR1cm4gaXNCb2dvbklQKGVuc3VyZUJ1ZmZlcihpcCkpCn0KCmV4cG9ydHMuaXNCb2dvbiA9IGV4cG9ydHMKCmV4cG9ydHMuaXNQcml2YXRlID0gZnVuY3Rpb24gaXNQcml2YXRlIChpcCkgewogIHJldHVybiBpc1ByaXZhdGVJUChlbnN1cmVCdWZmZXIoaXApKQp9CgpmdW5jdGlvbiBpc0JvZ29uSVAgKGlwKSB7CiAgcmV0dXJuIGlzUHJpdmF0ZUlQKGlwKSB8fCBpc1Jlc2VydmVkSVAoaXApCn0KCmZ1bmN0aW9uIGlzUHJpdmF0ZUlQIChpcCkgewogIHJldHVybiBpcC5ieXRlTGVuZ3RoID09PSA0ID8gaXNQcml2YXRlSVB2NChpcCkgOiBmYWxzZSAvLyBJUHY2IGhhcyBubyBwcml2YXRlIElQcwp9CgpmdW5jdGlvbiBpc1ByaXZhdGVJUHY0IChpcCkgewogIHJldHVybiAoCiAgICAvLyAxMC4wLjAuMC84ICBQcml2YXRlLXVzZSBuZXR3b3JrcwogICAgKGlwWzBdID09PSAxMCkgfHwKICAgIC8vIDEwMC42NC4wLjAvMTAgQ2Fycmllci1ncmFkZSBOQVQKICAgIChpcFswXSA9PT0gMTAwICYmIGlwWzFdID49IDY0ICYmIGlwWzFdIDw9IDEyNykgfHwKICAgIC8vIDEyNy4wLjAuMC84IExvb3BiYWNrICsgTmFtZSBjb2xsaXNpb24gb2NjdXJyZW5jZSAoMTI3LjAuNTMuNTMpCiAgICAoaXBbMF0gPT09IDEyNykgfHwKICAgIC8vIDE2OS4yNTQuMC4wLzE2ICBMaW5rIGxvY2FsCiAgICAoaXBbMF0gPT09IDE2OSAmJiBpcFsxXSA9PT0gMjU0KSB8fAogICAgLy8gMTcyLjE2LjAuMC8xMiBQcml2YXRlLXVzZSBuZXR3b3JrcwogICAgKGlwWzBdID09PSAxNzIgJiYgaXBbMV0gPj0gMTYgJiYgaXBbMV0gPD0gMzEpIHx8CiAgICAvLyAxOTIuMTY4LjAuMC8xNiAgUHJpdmF0ZS11c2UgbmV0d29ya3MKICAgIChpcFswXSA9PT0gMTkyICYmIGlwWzFdID09PSAxNjgpCiAgKQp9CgpmdW5jdGlvbiBpc1Jlc2VydmVkSVAgKGlwKSB7CiAgcmV0dXJuIGlwLmJ5dGVMZW5ndGggPT09IDQgPyBpc1Jlc2VydmVkSVB2NChpcCkgOiBpc1Jlc2VydmVkSVB2NihpcCkKfQoKZnVuY3Rpb24gaXNSZXNlcnZlZElQdjQgKGlwKSB7CiAgcmV0dXJuICgKICAgIC8vIDAuMC4wLjAvOCAiVGhpcyIgbmV0d29yawogICAgKGlwWzBdID09PSAwKSB8fAogICAgLy8gMTkyLjAuMC4wLzI0ICBJRVRGIHByb3RvY29sIGFzc2lnbm1lbnRzCiAgICAoaXBbMF0gPT09IDE5MiAmJiBpcFsxXSA9PT0gMCAmJiBpcFsyXSA9PT0gMCkgfHwKICAgIC8vIDE5Mi4wLjIuMC8yNCAgVEVTVC1ORVQtMQogICAgKGlwWzBdID09PSAxOTIgJiYgaXBbMV0gPT09IDAgJiYgaXBbMl0gPT09IDIpIHx8CiAgICAvLyAxOTguMTguMC4wLzE1IE5ldHdvcmsgaW50ZXJjb25uZWN0IGRldmljZSBiZW5jaG1hcmsgdGVzdGluZwogICAgKGlwWzBdID09PSAxOTggJiYgaXBbMV0gPj0gMTggJiYgaXBbMV0gPD0gMTkpIHx8CiAgICAvLyAxOTguNTEuMTAwLjAvMjQgVEVTVC1ORVQtMgogICAgKGlwWzBdID09PSAxOTggJiYgaXBbMV0gPT09IDUxICYmIGlwWzJdID09PSAxMDApIHx8CiAgICAvLyAyMDMuMC4xMTMuMC8yNCAgVEVTVC1ORVQtMwogICAgKGlwWzBdID09PSAyMDMgJiYgaXBbMV0gPT09IDAgJiYgaXBbMl0gPT09IDExMykgfHwKICAgIC8vIDIyNC4wLjAuMC80IE11bHRpY2FzdAogICAgKGlwWzBdID49IDIyNCAmJiBpcFswXSA8PSAyMzkpIHx8CiAgICAvLyAyNDAuMC4wLjAvNCBSZXNlcnZlZCBmb3IgZnV0dXJlIHVzZQogICAgKGlwWzBdID49IDI0MCkgfHwKICAgIC8vIDI1NS4yNTUuMjU1LjI1NS8zMgogICAgKGlwWzBdID09PSAyNTUgJiYgaXBbMV0gPT09IDI1NSAmJiBpcFsyXSA9PT0gMjU1ICYmIGlwWzNdID09PSAyNTUpCiAgKQp9CgpmdW5jdGlvbiBpc1Jlc2VydmVkSVB2NiAoaXApIHsKICByZXR1cm4gKAogICAgLy8gOjovMTI4IE5vZGUtc2NvcGUgdW5pY2FzdCB1bnNwZWNpZmllZCBhZGRyZXNzCiAgICAvLyA6OjEvMTI4IE5vZGUtc2NvcGUgdW5pY2FzdCBsb29wYmFjayBhZGRyZXNzCiAgICAoCiAgICAgIGlwWzBdID09PSAwICYmIGlwWzFdID09PSAwICYmIGlwWzJdID09PSAwICYmIGlwWzNdID09PSAwICYmIGlwWzRdID09PSAwICYmCiAgICAgIGlwWzVdID09PSAwICYmIGlwWzZdID09PSAwICYmIGlwWzddID09PSAwICYmIGlwWzhdID09PSAwICYmIGlwWzldID09PSAwICYmCiAgICAgIGlwWzEwXSA9PT0gMCAmJiBpcFsxMV0gPT09IDAgJiYgaXBbMTJdID09PSAwICYmIGlwWzEzXSA9PT0gMCAmJiBpcFsxNF0gPT09IDAgJiYKICAgICAgaXBbMTVdIDw9IDEKICAgICkgfHwKICAgIC8vIDo6ZmZmZjowOjAvOTYgSVB2NC1tYXBwZWQgYWRkcmVzc2VzCiAgICAvLyA6Oi85NiBJUHY0LWNvbXBhdGlibGUgYWRkcmVzc2VzCiAgICAoCiAgICAgIGlwWzBdID09PSAwICYmIGlwWzFdID09PSAwICYmIGlwWzJdID09PSAwICYmIGlwWzNdID09PSAwICYmIGlwWzRdID09PSAwICYmCiAgICAgIGlwWzVdID09PSAwICYmIGlwWzZdID09PSAwICYmIGlwWzddID09PSAwICYmIGlwWzhdID09PSAwICYmIGlwWzldID09PSAwICYmCiAgICAgIChpcFsxMF0gPT09IDAgfHwgaXBbMTBdID09PSAweGZmKSAmJgogICAgICAoaXBbMTFdID09PSAwIHx8IGlwWzExXSA9PT0gMHhmZikKICAgICkgfHwKICAgIC8vIDEwMDo6LzY0IFJlbW90ZWx5IHRyaWdnZXJlZCBibGFjayBob2xlIGFkZHJlc3NlcwogICAgKGlwWzBdID09PSAweDAxICYmIGlwWzFdID09PSAwICYmIGlwWzJdID09PSAwICYmIGlwWzNdID09PSAwICYmIGlwWzRdID09PSAwICYmIGlwWzVdID09PSAwICYmIGlwWzZdID09PSAwICYmIGlwWzddID09PSAwKSB8fAogICAgLy8gMjAwMToxMDo6LzI4IE92ZXJsYXkgcm91dGFibGUgY3J5cHRvZ3JhcGhpYyBoYXNoIGlkZW50aWZpZXJzIChPUkNISUQpCiAgICAoaXBbMF0gPT09IDB4MjAgJiYgaXBbMV0gPT09IDB4MDEgJiYgaXBbMl0gPT09IDAgJiYgaXBbM10gPj0gMHgxMCAmJiBpcFszXSA8PSAweDFmKSB8fAogICAgLy8gMjAwMToyMDo6LzI4IE92ZXJsYXkgcm91dGFibGUgY3J5cHRvZ3JhcGhpYyBoYXNoIGlkZW50aWZpZXJzIHZlcnNpb24gMiAoT1JDSElEdjIpCiAgICAoaXBbMF0gPT09IDB4MjAgJiYgaXBbMV0gPT09IDB4MDEgJiYgaXBbMl0gPT09IDAgJiYgaXBbM10gPj0gMHgyMCAmJiBpcFszXSA8PSAweDJmKSB8fAogICAgLy8gMjAwMTpkYjg6Oi8zMiBEb2N1bWVudGF0aW9uIHByZWZpeAogICAgKGlwWzBdID09PSAweDIwICYmIGlwWzFdID09PSAweDAxICYmIGlwWzJdID09PSAweDBkICYmIGlwWzNdID09PSAweGI4KSB8fAogICAgLy8gZmMwMDo6LzcgVW5pcXVlIGxvY2FsIGFkZHJlc3NlcyAoVUxBKQogICAgKGlwWzBdID49IDB4ZmMgJiYgaXBbMF0gPD0gMHhmZCkgfHwKICAgIC8vIGZlODA6Oi8xMCBMaW5rLWxvY2FsIHVuaWNhc3QKICAgIChpcFswXSA9PT0gMHhmZSAmJiBpcFsxXSA+PSAweDgwICYmIGlwWzFdIDw9IDB4YmYpIHx8CiAgICAvLyBmZjAwOjovOCBNdWx0aWNhc3QKICAgIChpcFswXSA9PT0gMHhmZikKICApCn0KCmNvbnN0IHN0YXRlID0gYy5zdGF0ZSgwLCAwLCBiNGEuYWxsb2NVbnNhZmUoMSAvKiBmYW1pbHkgKi8gKyAxNikpCgpmdW5jdGlvbiBlbnN1cmVCdWZmZXIgKGlwKSB7CiAgaWYgKGI0YS5pc0J1ZmZlcihpcCkpIHJldHVybiBpcAoKICBuZXQuaXAucHJlZW5jb2RlKHN0YXRlLCBpcCkKICBuZXQuaXAuZW5jb2RlKHN0YXRlLCBpcCkKCiAgY29uc3QgYnVmZmVyID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KDEgLyogZmFtaWx5ICovLCBzdGF0ZS5lbmQpCgogIHN0YXRlLnN0YXJ0ID0gMAogIHN0YXRlLmVuZCA9IDAKCiAgcmV0dXJuIGJ1ZmZlcgp9CnsKICAibmFtZSI6ICJib2dvbiIsCiAgInZlcnNpb24iOiAiMS4xLjAiLAogICJkZXNjcmlwdGlvbiI6ICJDaGVjayBpZiBhbiBJUCBpcyBhIGJvZ29uIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QubWpzIgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjExLjAiLAogICAgImNvbXBhY3QtZW5jb2RpbmctbmV0IjogIl4xLjIuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4wLjQiLAogICAgIm5hbm9iZW5jaCI6ICJeMi4xLjEiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvYm9nb24uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2JvZ29uL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2JvZ29uIgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgptb2R1bGUuZXhwb3J0cyA9IGNvZGVjcwoKY29kZWNzLmFzY2lpID0gY3JlYXRlU3RyaW5nKCdhc2NpaScpCmNvZGVjcy51dGY4ID0gY3JlYXRlU3RyaW5nKCd1dGYtOCcpCmNvZGVjcy5oZXggPSBjcmVhdGVTdHJpbmcoJ2hleCcpCmNvZGVjcy5iYXNlNjQgPSBjcmVhdGVTdHJpbmcoJ2Jhc2U2NCcpCmNvZGVjcy51Y3MyID0gY3JlYXRlU3RyaW5nKCd1Y3MyJykKY29kZWNzLnV0ZjE2bGUgPSBjcmVhdGVTdHJpbmcoJ3V0ZjE2bGUnKQpjb2RlY3MubmRqc29uID0gY3JlYXRlSlNPTih0cnVlKQpjb2RlY3MuanNvbiA9IGNyZWF0ZUpTT04oZmFsc2UpCmNvZGVjcy5iaW5hcnkgPSB7CiAgbmFtZTogJ2JpbmFyeScsCiAgZW5jb2RlOiBmdW5jdGlvbiBlbmNvZGVCaW5hcnkgKG9iaikgewogICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdzdHJpbmcnCiAgICAgID8gYjRhLmZyb20ob2JqLCAndXRmLTgnKQogICAgICA6IGI0YS50b0J1ZmZlcihvYmopCiAgfSwKICBkZWNvZGU6IGZ1bmN0aW9uIGRlY29kZUJpbmFyeSAoYnVmKSB7CiAgICByZXR1cm4gYjRhLnRvQnVmZmVyKGJ1ZikKICB9Cn0KCmZ1bmN0aW9uIGlzQ29tcGFjdEVuY29kaW5nIChjKSB7CiAgcmV0dXJuICEhKGMuZW5jb2RlICYmIGMuZGVjb2RlICYmIGMucHJlZW5jb2RlKQp9CgpmdW5jdGlvbiBmcm9tQ29tcGFjdEVuY29kaW5nIChjKSB7CiAgcmV0dXJuIHsKICAgIG5hbWU6ICdjb21wYWN0LWVuY29kaW5nJywKICAgIGVuY29kZTogZnVuY3Rpb24gZW5jb2RlV2l0aENvbXBhY3QgKHZhbHVlKSB7CiAgICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiAwLCBidWZmZXI6IG51bGwsIGNhY2hlOiBudWxsIH0KICAgICAgYy5wcmVlbmNvZGUoc3RhdGUsIHZhbHVlKQogICAgICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQogICAgICBjLmVuY29kZShzdGF0ZSwgdmFsdWUpCiAgICAgIHJldHVybiBzdGF0ZS5idWZmZXIKICAgIH0sCiAgICBkZWNvZGU6IGZ1bmN0aW9uIGRlY29kZVdpdGhDb21wYWN0IChidWZmZXIpIHsKICAgICAgcmV0dXJuIGMuZGVjb2RlKHsgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGgsIGJ1ZmZlciwgY2FjaGU6IG51bGwgfSkKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGNvZGVjcyAoZm10LCBmYWxsYmFjaykgewogIGlmICh0eXBlb2YgZm10ID09PSAnb2JqZWN0JyAmJiBmbXQpIHsKICAgIHJldHVybiBpc0NvbXBhY3RFbmNvZGluZyhmbXQpID8gZnJvbUNvbXBhY3RFbmNvZGluZyhmbXQpIDogZm10CiAgfQoKICBzd2l0Y2ggKGZtdCkgewogICAgY2FzZSAnbmRqc29uJzogcmV0dXJuIGNvZGVjcy5uZGpzb24KICAgIGNhc2UgJ2pzb24nOiByZXR1cm4gY29kZWNzLmpzb24KICAgIGNhc2UgJ2FzY2lpJzogcmV0dXJuIGNvZGVjcy5hc2NpaQogICAgY2FzZSAndXRmLTgnOgogICAgY2FzZSAndXRmOCc6IHJldHVybiBjb2RlY3MudXRmOAogICAgY2FzZSAnaGV4JzogcmV0dXJuIGNvZGVjcy5oZXgKICAgIGNhc2UgJ2Jhc2U2NCc6IHJldHVybiBjb2RlY3MuYmFzZTY0CiAgICBjYXNlICd1Y3MtMic6CiAgICBjYXNlICd1Y3MyJzogcmV0dXJuIGNvZGVjcy51Y3MyCiAgICBjYXNlICd1dGYxNi1sZSc6CiAgICBjYXNlICd1dGYxNmxlJzogcmV0dXJuIGNvZGVjcy51dGYxNmxlCiAgfQoKICByZXR1cm4gZmFsbGJhY2sgIT09IHVuZGVmaW5lZCA/IGZhbGxiYWNrIDogY29kZWNzLmJpbmFyeQp9CgpmdW5jdGlvbiBjcmVhdGVKU09OIChuZXdsaW5lKSB7CiAgcmV0dXJuIHsKICAgIG5hbWU6IG5ld2xpbmUgPyAnbmRqc29uJyA6ICdqc29uJywKICAgIGVuY29kZTogbmV3bGluZSA/IGVuY29kZU5ESlNPTiA6IGVuY29kZUpTT04sCiAgICBkZWNvZGU6IGZ1bmN0aW9uIGRlY29kZUpTT04gKGJ1ZikgewogICAgICByZXR1cm4gSlNPTi5wYXJzZShiNGEudG9TdHJpbmcoYnVmKSkKICAgIH0KICB9CgogIGZ1bmN0aW9uIGVuY29kZUpTT04gKHZhbCkgewogICAgcmV0dXJuIGI0YS5mcm9tKEpTT04uc3RyaW5naWZ5KHZhbCkpCiAgfQoKICBmdW5jdGlvbiBlbmNvZGVOREpTT04gKHZhbCkgewogICAgcmV0dXJuIGI0YS5mcm9tKEpTT04uc3RyaW5naWZ5KHZhbCkgKyAnXG4nKQogIH0KfQoKZnVuY3Rpb24gY3JlYXRlU3RyaW5nICh0eXBlKSB7CiAgcmV0dXJuIHsKICAgIG5hbWU6IHR5cGUsCiAgICBlbmNvZGU6IGZ1bmN0aW9uIGVuY29kZVN0cmluZyAodmFsKSB7CiAgICAgIGlmICh0eXBlb2YgdmFsICE9PSAnc3RyaW5nJykgdmFsID0gdmFsLnRvU3RyaW5nKCkKICAgICAgcmV0dXJuIGI0YS5mcm9tKHZhbCwgdHlwZSkKICAgIH0sCiAgICBkZWNvZGU6IGZ1bmN0aW9uIGRlY29kZVN0cmluZyAoYnVmKSB7CiAgICAgIHJldHVybiBiNGEudG9TdHJpbmcoYnVmLCB0eXBlKQogICAgfQogIH0KfQp7CiAgIm5hbWUiOiAiY29kZWNzIiwKICAidmVyc2lvbiI6ICIzLjEuMCIsCiAgImRlc2NyaXB0aW9uIjogIkNyZWF0ZSBhbiBiaW5hcnkgZW5jb2Rlci9kZWNvZGVyIGZvciBqc29uLCB1dGYtOCBvciBjdXN0b20gdHlwZXMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjMiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMi4xIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjExLjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9jb2RlY3MuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2NvZGVjcy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9jb2RlY3MiCn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBiaXRmaWVsZCAobGVuZ3RoKSB7CiAgaWYgKGxlbmd0aCA+IDY0KSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQml0ZmllbGQgY2Fubm90IGJlIGxhcmdlciB0aGFuIDY0IGJpdHMnKQoKICBsZXQgYnl0ZUxlbmd0aAogIGlmIChsZW5ndGggPCA4KSBieXRlTGVuZ3RoID0gMQogIGVsc2UgaWYgKGxlbmd0aCA8PSAxNikgYnl0ZUxlbmd0aCA9IDIKICBlbHNlIGlmIChsZW5ndGggPD0gMzIpIGJ5dGVMZW5ndGggPSA0CiAgZWxzZSBieXRlTGVuZ3RoID0gOAoKICByZXR1cm4gewogICAgcHJlZW5jb2RlIChzdGF0ZSkgewogICAgICBzdGF0ZS5lbmQrKyAvLyBMZW5ndGggYnl0ZSwgdXNlZCBmb3IgZGF0YSB3aGVuIGJ5dGVMZW5ndGggPT09IDEKCiAgICAgIGlmIChieXRlTGVuZ3RoID09PSAxKSA7CiAgICAgIGVsc2UgaWYgKGJ5dGVMZW5ndGggPT09IDIpIGMudWludDE2LnByZWVuY29kZShzdGF0ZSkKICAgICAgZWxzZSBpZiAoYnl0ZUxlbmd0aCA9PT0gNCkgYy51aW50MzIucHJlZW5jb2RlKHN0YXRlKQogICAgICBlbHNlIGMudWludDY0LnByZWVuY29kZShzdGF0ZSkKICAgIH0sCgogICAgZW5jb2RlIChzdGF0ZSwgYikgewogICAgICBpZiAoYnl0ZUxlbmd0aCA9PT0gMSkgOwogICAgICBlbHNlIGlmIChieXRlTGVuZ3RoID09PSAyKSBjLnVpbnQ4LmVuY29kZShzdGF0ZSwgMHhmZCkKICAgICAgZWxzZSBpZiAoYnl0ZUxlbmd0aCA9PT0gNCkgYy51aW50OC5lbmNvZGUoc3RhdGUsIDB4ZmUpCiAgICAgIGVsc2UgYy51aW50OC5lbmNvZGUoc3RhdGUsIDB4ZmYpCgogICAgICBpZiAodHlwZW9mIGIgPT09ICdudW1iZXInKSB7CiAgICAgICAgaWYgKGJ5dGVMZW5ndGggPT09IDEpIGMudWludDguZW5jb2RlKHN0YXRlLCBiKQogICAgICAgIGVsc2UgaWYgKGJ5dGVMZW5ndGggPT09IDIpIGMudWludDE2LmVuY29kZShzdGF0ZSwgYikKICAgICAgICBlbHNlIGlmIChieXRlTGVuZ3RoID09PSA0KSBjLnVpbnQzMi5lbmNvZGUoc3RhdGUsIGIpCiAgICAgICAgZWxzZSBjLnVpbnQ2NC5lbmNvZGUoc3RhdGUsIGIpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RhdGUuYnVmZmVyLnNldChiLCBzdGF0ZS5zdGFydCkKCiAgICAgICAgaWYgKGIuYnl0ZUxlbmd0aCA8IGJ5dGVMZW5ndGgpIHsKICAgICAgICAgIC8vIFplcm8tZmlsbCB0aGUgcmVzdCBvZiB0aGUgYnl0ZSBsZW5ndGguCiAgICAgICAgICBzdGF0ZS5idWZmZXIuZmlsbCgKICAgICAgICAgICAgMCwKICAgICAgICAgICAgc3RhdGUuc3RhcnQgKyBiLmJ5dGVMZW5ndGgsCiAgICAgICAgICAgIHN0YXRlLnN0YXJ0ICsgYnl0ZUxlbmd0aAogICAgICAgICAgKQogICAgICAgIH0KCiAgICAgICAgc3RhdGUuc3RhcnQgKz0gYnl0ZUxlbmd0aAogICAgICB9CiAgICB9LAoKICAgIGRlY29kZSAoc3RhdGUpIHsKICAgICAgY29uc3QgYnl0ZSA9IHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydF0KCiAgICAgIGxldCBieXRlTGVuZ3RoCiAgICAgIGlmIChieXRlIDw9IDB4ZmMpIGJ5dGVMZW5ndGggPSAxCiAgICAgIGVsc2UgaWYgKGJ5dGUgPT09IDB4ZmQpIGJ5dGVMZW5ndGggPSAyCiAgICAgIGVsc2UgaWYgKGJ5dGUgPT09IDB4ZmUpIGJ5dGVMZW5ndGggPSA0CiAgICAgIGVsc2UgYnl0ZUxlbmd0aCA9IDgKCiAgICAgIGlmIChieXRlTGVuZ3RoID4gMSkgc3RhdGUuc3RhcnQrKyAvLyBTa2lwIHRoZSBsZW5ndGggYnl0ZQoKICAgICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKCiAgICAgIGNvbnN0IGIgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIChzdGF0ZS5zdGFydCArPSBieXRlTGVuZ3RoKSkKCiAgICAgIHJldHVybiBsZW5ndGggPD0gOCA/IGIuc3ViYXJyYXkoMCwgMSkgOiBiCiAgICB9CiAgfQp9CnsKICAibmFtZSI6ICJjb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkIiwKICAidmVyc2lvbiI6ICIxLjAuMCIsCiAgImRlc2NyaXB0aW9uIjogIkNvbXBhY3QgY29kZWMgZm9yIGJpdGZpZWxkcyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0Lm1qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9jb21wYWN0LWVuY29kaW5nL2NvbXBhY3QtZW5jb2RpbmctYml0ZmllbGQuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJLYXNwZXIgSXNhZ2VyIERhbHNnYXLDsCA8a2FzcGVyQGZ1bmt0aW9uZWwuY28+IiwKICAibGljZW5zZSI6ICJJU0MiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vY29tcGFjdC1lbmNvZGluZy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vY29tcGFjdC1lbmNvZGluZy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjQuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMS4zLjUiLAogICAgInN0YW5kYXJkIjogIl4xNi4wLjMiCiAgfSwKICAic3RhbmRhcmQiOiB7CiAgICAiaWdub3JlIjogWwogICAgICAiX19zbmFwc2hvdHNfXy8qKiIKICAgIF0KICB9Cn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQoKY29uc3QgcG9ydCA9IGMudWludDE2Cgpjb25zdCBhZGRyZXNzID0gKGhvc3QsIGZhbWlseSkgPT4gewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICAgIGhvc3QucHJlZW5jb2RlKHN0YXRlLCBtLmhvc3QpCiAgICAgIHBvcnQucHJlZW5jb2RlKHN0YXRlLCBtLnBvcnQpCiAgICB9LAogICAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgICBob3N0LmVuY29kZShzdGF0ZSwgbS5ob3N0KQogICAgICBwb3J0LmVuY29kZShzdGF0ZSwgbS5wb3J0KQogICAgfSwKICAgIGRlY29kZSAoc3RhdGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBob3N0OiBob3N0LmRlY29kZShzdGF0ZSksCiAgICAgICAgZmFtaWx5LAogICAgICAgIHBvcnQ6IHBvcnQuZGVjb2RlKHN0YXRlKQogICAgICB9CiAgICB9CiAgfQp9Cgpjb25zdCBpcHY0ID0gewogIHByZWVuY29kZSAoc3RhdGUpIHsKICAgIHN0YXRlLmVuZCArPSA0CiAgfSwKICBlbmNvZGUgKHN0YXRlLCBzdHJpbmcpIHsKICAgIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgNAoKICAgIGxldCBpID0gMAoKICAgIHdoaWxlIChpIDwgc3RyaW5nLmxlbmd0aCkgewogICAgICBsZXQgbiA9IDAKICAgICAgbGV0IGMKCiAgICAgIHdoaWxlIChpIDwgc3RyaW5nLmxlbmd0aCAmJiAoYyA9IHN0cmluZy5jaGFyQ29kZUF0KGkrKykpICE9PSAvKiAuICovIDB4MmUpIHsKICAgICAgICBuID0gbiAqIDEwICsgKGMgLSAvKiAwICovIDB4MzApCiAgICAgIH0KCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KICAgIH0KCiAgICBzdGF0ZS5zdGFydCA9IGVuZAogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgNCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiAoCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArICcuJyArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArICcuJyArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArICcuJyArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogICAgKQogIH0KfQoKY29uc3QgaXB2NEFkZHJlc3MgPSBhZGRyZXNzKGlwdjQsIDQpCgpjb25zdCBpcHY2ID0gewogIHByZWVuY29kZSAoc3RhdGUpIHsKICAgIHN0YXRlLmVuZCArPSAxNgogIH0sCiAgZW5jb2RlIChzdGF0ZSwgc3RyaW5nKSB7CiAgICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgICBjb25zdCBlbmQgPSBzdGFydCArIDE2CgogICAgbGV0IGkgPSAwCiAgICBsZXQgc3BsaXQgPSBudWxsCgogICAgd2hpbGUgKGkgPCBzdHJpbmcubGVuZ3RoKSB7CiAgICAgIGxldCBuID0gMAogICAgICBsZXQgYwoKICAgICAgd2hpbGUgKGkgPCBzdHJpbmcubGVuZ3RoICYmIChjID0gc3RyaW5nLmNoYXJDb2RlQXQoaSsrKSkgIT09IC8qIDogKi8gMHgzYSkgewogICAgICAgIGlmIChjID49IDB4MzAgJiYgYyA8PSAweDM5KSBuID0gbiAqIDB4MTAgKyAoYyAtIC8qIDAgKi8gMHgzMCkKICAgICAgICBlbHNlIGlmIChjID49IDB4NDEgJiYgYyA8PSAweDQ2KSBuID0gbiAqIDB4MTAgKyAoYyAtIC8qIEEgKi8gMHg0MSArIDEwKQogICAgICAgIGVsc2UgaWYgKGMgPj0gMHg2MSAmJiBjIDw9IDB4NjYpIG4gPSBuICogMHgxMCArIChjIC0gLyogYSAqLyAweDYxICsgMTApCiAgICAgIH0KCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDgKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgoKICAgICAgaWYgKGkgPCBzdHJpbmcubGVuZ3RoICYmIHN0cmluZy5jaGFyQ29kZUF0KGkpID09PSAvKiA6ICovIDB4M2EpIHsKICAgICAgICBpKysKICAgICAgICBzcGxpdCA9IHN0YXRlLnN0YXJ0CiAgICAgIH0KICAgIH0KCiAgICBpZiAoc3BsaXQgIT09IG51bGwpIHsKICAgICAgY29uc3Qgb2Zmc2V0ID0gZW5kIC0gc3RhdGUuc3RhcnQKICAgICAgc3RhdGUuYnVmZmVyCiAgICAgICAgLmNvcHlXaXRoaW4oc3BsaXQgKyBvZmZzZXQsIHNwbGl0KQogICAgICAgIC5maWxsKDAsIHNwbGl0LCBzcGxpdCArIG9mZnNldCkKICAgIH0KCiAgICBzdGF0ZS5zdGFydCA9IGVuZAogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgMTYpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gKAogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikgKyAnOicgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikgKyAnOicgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikgKyAnOicgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikgKyAnOicgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikgKyAnOicgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikgKyAnOicgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikgKyAnOicgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikKICAgICkKICB9Cn0KCmNvbnN0IGlwdjZBZGRyZXNzID0gYWRkcmVzcyhpcHY2LCA2KQoKY29uc3QgaXAgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgc3RyaW5nKSB7CiAgICBjb25zdCBmYW1pbHkgPSBzdHJpbmcuaW5jbHVkZXMoJzonKSA/IDYgOiA0CiAgICBjLnVpbnQ4LnByZWVuY29kZShzdGF0ZSwgZmFtaWx5KQogICAgaWYgKGZhbWlseSA9PT0gNCkgaXB2NC5wcmVlbmNvZGUoc3RhdGUpCiAgICBlbHNlIGlwdjYucHJlZW5jb2RlKHN0YXRlKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgc3RyaW5nKSB7CiAgICBjb25zdCBmYW1pbHkgPSBzdHJpbmcuaW5jbHVkZXMoJzonKSA/IDYgOiA0CiAgICBjLnVpbnQ4LmVuY29kZShzdGF0ZSwgZmFtaWx5KQogICAgaWYgKGZhbWlseSA9PT0gNCkgaXB2NC5lbmNvZGUoc3RhdGUsIHN0cmluZykKICAgIGVsc2UgaXB2Ni5lbmNvZGUoc3RhdGUsIHN0cmluZykKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IGZhbWlseSA9IGMudWludDguZGVjb2RlKHN0YXRlKQogICAgaWYgKGZhbWlseSA9PT0gNCkgcmV0dXJuIGlwdjQuZGVjb2RlKHN0YXRlKQogICAgZWxzZSByZXR1cm4gaXB2Ni5kZWNvZGUoc3RhdGUpCiAgfQp9Cgpjb25zdCBpcEFkZHJlc3MgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgaXAucHJlZW5jb2RlKHN0YXRlLCBtLmhvc3QpCiAgICBwb3J0LnByZWVuY29kZShzdGF0ZSwgbS5wb3J0KQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgaXAuZW5jb2RlKHN0YXRlLCBtLmhvc3QpCiAgICBwb3J0LmVuY29kZShzdGF0ZSwgbS5wb3J0KQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgZmFtaWx5ID0gYy51aW50OC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBob3N0OiBmYW1pbHkgPT09IDQgPyBpcHY0LmRlY29kZShzdGF0ZSkgOiBpcHY2LmRlY29kZShzdGF0ZSksCiAgICAgIGZhbWlseSwKICAgICAgcG9ydDogcG9ydC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBwb3J0LAogIGlwdjQsCiAgaXB2NEFkZHJlc3MsCiAgaXB2NiwKICBpcHY2QWRkcmVzcywKICBpcCwKICBpcEFkZHJlc3MKfQp7CiAgIm5hbWUiOiAiY29tcGFjdC1lbmNvZGluZy1uZXQiLAogICJ2ZXJzaW9uIjogIjEuMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiQ29tcGFjdCBjb2RlY3MgZm9yIG5ldCB0eXBlcyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0Lm1qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9jb21wYWN0LWVuY29kaW5nL2NvbXBhY3QtZW5jb2RpbmctbmV0LmdpdCIKICB9LAogICJhdXRob3IiOiAiS2FzcGVyIElzYWdlciBEYWxzZ2Fyw7AgPGthc3BlckBmdW5rdGlvbmVsLmNvPiIsCiAgImxpY2Vuc2UiOiAiSVNDIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2NvbXBhY3QtZW5jb2RpbmcvY29tcGFjdC1lbmNvZGluZy1uZXQvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9jb21wYWN0LWVuY29kaW5nL2NvbXBhY3QtZW5jb2RpbmctbmV0I3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjQuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMS4zLjUiLAogICAgIm5hbm9iZW5jaCI6ICJeMi4xLjEiLAogICAgInN0YW5kYXJkIjogIl4xNi4wLjMiCiAgfQp9CmNvbnN0IExFID0gKGV4cG9ydHMuTEUgPQogIG5ldyBVaW50OEFycmF5KG5ldyBVaW50MTZBcnJheShbMHhmZl0pLmJ1ZmZlcilbMF0gPT09IDB4ZmYpCgpleHBvcnRzLkJFID0gIUxFCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCB7IEJFIH0gPSByZXF1aXJlKCcuL2VuZGlhbicpCgpleHBvcnRzLnN0YXRlID0gZnVuY3Rpb24gKHN0YXJ0ID0gMCwgZW5kID0gMCwgYnVmZmVyID0gbnVsbCkgewogIHJldHVybiB7IHN0YXJ0LCBlbmQsIGJ1ZmZlciB9Cn0KCmNvbnN0IHJhdyA9IChleHBvcnRzLnJhdyA9IHJlcXVpcmUoJy4vcmF3JykpCgpjb25zdCB1aW50ID0gKGV4cG9ydHMudWludCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSBuIDw9IDB4ZmMgPyAxIDogbiA8PSAweGZmZmYgPyAzIDogbiA8PSAweGZmZmZmZmZmID8gNSA6IDkKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgaWYgKG4gPD0gMHhmYykgdWludDguZW5jb2RlKHN0YXRlLCBuKQogICAgZWxzZSBpZiAobiA8PSAweGZmZmYpIHsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHhmZAogICAgICB1aW50MTYuZW5jb2RlKHN0YXRlLCBuKQogICAgfSBlbHNlIGlmIChuIDw9IDB4ZmZmZmZmZmYpIHsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHhmZQogICAgICB1aW50MzIuZW5jb2RlKHN0YXRlLCBuKQogICAgfSBlbHNlIHsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHhmZgogICAgICB1aW50NjQuZW5jb2RlKHN0YXRlLCBuKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBhID0gdWludDguZGVjb2RlKHN0YXRlKQogICAgaWYgKGEgPD0gMHhmYykgcmV0dXJuIGEKICAgIGlmIChhID09PSAweGZkKSByZXR1cm4gdWludDE2LmRlY29kZShzdGF0ZSkKICAgIGlmIChhID09PSAweGZlKSByZXR1cm4gdWludDMyLmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB1aW50NjQuZGVjb2RlKHN0YXRlKQogIH0KfSkKCmNvbnN0IHVpbnQ4ID0gKGV4cG9ydHMudWludDggPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gMQogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICB2YWxpZGF0ZVVpbnQobikKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLnN0YXJ0ID49IHN0YXRlLmVuZCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICB9Cn0pCgpjb25zdCB1aW50MTYgPSAoZXhwb3J0cy51aW50MTYgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gMgogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICB2YWxpZGF0ZVVpbnQobikKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDgKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgMikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKyBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMAogIH0KfSkKCmNvbnN0IHVpbnQyNCA9IChleHBvcnRzLnVpbnQyNCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSAzCiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHZhbGlkYXRlVWludChuKQogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gOAogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gMTYKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgMykgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiAoCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMHgxMDAwMAogICAgKQogIH0KfSkKCmNvbnN0IHVpbnQzMiA9IChleHBvcnRzLnVpbnQzMiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSA0CiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHZhbGlkYXRlVWludChuKQogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gOAogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gMTYKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDI0CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDQpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gKAogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMCArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwMDAgKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMDAwMDAKICAgICkKICB9Cn0pCgpjb25zdCB1aW50NDAgPSAoZXhwb3J0cy51aW50NDAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gNQogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICB2YWxpZGF0ZVVpbnQobikKICAgIGNvbnN0IHIgPSBNYXRoLmZsb29yKG4gLyAweDEwMCkKICAgIHVpbnQ4LmVuY29kZShzdGF0ZSwgbikKICAgIHVpbnQzMi5lbmNvZGUoc3RhdGUsIHIpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDUpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gdWludDguZGVjb2RlKHN0YXRlKSArIDB4MTAwICogdWludDMyLmRlY29kZShzdGF0ZSkKICB9Cn0pCgpjb25zdCB1aW50NDggPSAoZXhwb3J0cy51aW50NDggPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gNgogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICB2YWxpZGF0ZVVpbnQobikKICAgIGNvbnN0IHIgPSBNYXRoLmZsb29yKG4gLyAweDEwMDAwKQogICAgdWludDE2LmVuY29kZShzdGF0ZSwgbikKICAgIHVpbnQzMi5lbmNvZGUoc3RhdGUsIHIpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDYpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gdWludDE2LmRlY29kZShzdGF0ZSkgKyAweDEwMDAwICogdWludDMyLmRlY29kZShzdGF0ZSkKICB9Cn0pCgpjb25zdCB1aW50NTYgPSAoZXhwb3J0cy51aW50NTYgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gNwogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICB2YWxpZGF0ZVVpbnQobikKICAgIGNvbnN0IHIgPSBNYXRoLmZsb29yKG4gLyAweDEwMDAwMDApCiAgICB1aW50MjQuZW5jb2RlKHN0YXRlLCBuKQogICAgdWludDMyLmVuY29kZShzdGF0ZSwgcikKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgNykgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiB1aW50MjQuZGVjb2RlKHN0YXRlKSArIDB4MTAwMDAwMCAqIHVpbnQzMi5kZWNvZGUoc3RhdGUpCiAgfQp9KQoKY29uc3QgdWludDY0ID0gKGV4cG9ydHMudWludDY0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kICs9IDgKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgdmFsaWRhdGVVaW50KG4pCiAgICBjb25zdCByID0gTWF0aC5mbG9vcihuIC8gMHgxMDAwMDAwMDApCiAgICB1aW50MzIuZW5jb2RlKHN0YXRlLCBuKQogICAgdWludDMyLmVuY29kZShzdGF0ZSwgcikKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgOCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiB1aW50MzIuZGVjb2RlKHN0YXRlKSArIDB4MTAwMDAwMDAwICogdWludDMyLmRlY29kZShzdGF0ZSkKICB9Cn0pCgpjb25zdCBpbnQgPSAoZXhwb3J0cy5pbnQgPSB6aWdaYWdJbnQodWludCkpCmV4cG9ydHMuaW50OCA9IHppZ1phZ0ludCh1aW50OCkKZXhwb3J0cy5pbnQxNiA9IHppZ1phZ0ludCh1aW50MTYpCmV4cG9ydHMuaW50MjQgPSB6aWdaYWdJbnQodWludDI0KQpleHBvcnRzLmludDMyID0gemlnWmFnSW50KHVpbnQzMikKZXhwb3J0cy5pbnQ0MCA9IHppZ1phZ0ludCh1aW50NDApCmV4cG9ydHMuaW50NDggPSB6aWdaYWdJbnQodWludDQ4KQpleHBvcnRzLmludDU2ID0gemlnWmFnSW50KHVpbnQ1NikKZXhwb3J0cy5pbnQ2NCA9IHppZ1phZ0ludCh1aW50NjQpCgpjb25zdCBiaWd1aW50NjQgPSAoZXhwb3J0cy5iaWd1aW50NjQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gOAogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KAogICAgICBzdGF0ZS5idWZmZXIuYnVmZmVyLAogICAgICBzdGF0ZS5zdGFydCArIHN0YXRlLmJ1ZmZlci5ieXRlT2Zmc2V0LAogICAgICA4CiAgICApCiAgICB2aWV3LnNldEJpZ1VpbnQ2NCgwLCBuLCB0cnVlKSAvLyBsaXR0bGUgZW5kaWFuCiAgICBzdGF0ZS5zdGFydCArPSA4CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDgpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KAogICAgICBzdGF0ZS5idWZmZXIuYnVmZmVyLAogICAgICBzdGF0ZS5zdGFydCArIHN0YXRlLmJ1ZmZlci5ieXRlT2Zmc2V0LAogICAgICA4CiAgICApCiAgICBjb25zdCBuID0gdmlldy5nZXRCaWdVaW50NjQoMCwgdHJ1ZSkgLy8gbGl0dGxlIGVuZGlhbgogICAgc3RhdGUuc3RhcnQgKz0gOAogICAgcmV0dXJuIG4KICB9Cn0pCgpleHBvcnRzLmJpZ2ludDY0ID0gemlnWmFnQmlnSW50KGJpZ3VpbnQ2NCkKCmNvbnN0IGJpZ3VpbnQgPSAoZXhwb3J0cy5iaWd1aW50ID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgbGV0IGxlbiA9IDAKICAgIGZvciAobGV0IG0gPSBuOyBtOyBtID0gbSA+PiA2NG4pIGxlbisrCiAgICB1aW50LnByZWVuY29kZShzdGF0ZSwgbGVuKQogICAgc3RhdGUuZW5kICs9IDggKiBsZW4KICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgbGV0IGxlbiA9IDAKICAgIGZvciAobGV0IG0gPSBuOyBtOyBtID0gbSA+PiA2NG4pIGxlbisrCiAgICB1aW50LmVuY29kZShzdGF0ZSwgbGVuKQogICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldygKICAgICAgc3RhdGUuYnVmZmVyLmJ1ZmZlciwKICAgICAgc3RhdGUuc3RhcnQgKyBzdGF0ZS5idWZmZXIuYnl0ZU9mZnNldCwKICAgICAgOCAqIGxlbgogICAgKQogICAgZm9yIChsZXQgbSA9IG4sIGkgPSAwOyBtOyBtID0gbSA+PiA2NG4sIGkgKz0gOCkgewogICAgICB2aWV3LnNldEJpZ1VpbnQ2NChpLCBCaWdJbnQuYXNVaW50Tig2NCwgbSksIHRydWUpIC8vIGxpdHRsZSBlbmRpYW4KICAgIH0KICAgIHN0YXRlLnN0YXJ0ICs9IDggKiBsZW4KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgbGVuID0gdWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA4ICogbGVuKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldygKICAgICAgc3RhdGUuYnVmZmVyLmJ1ZmZlciwKICAgICAgc3RhdGUuc3RhcnQgKyBzdGF0ZS5idWZmZXIuYnl0ZU9mZnNldCwKICAgICAgOCAqIGxlbgogICAgKQogICAgbGV0IG4gPSAwbgogICAgZm9yIChsZXQgaSA9IGxlbiAtIDE7IGkgPj0gMDsgaS0tKQogICAgICBuID0gKG4gPDwgNjRuKSArIHZpZXcuZ2V0QmlnVWludDY0KGkgKiA4LCB0cnVlKSAvLyBsaXR0bGUgZW5kaWFuCiAgICBzdGF0ZS5zdGFydCArPSA4ICogbGVuCiAgICByZXR1cm4gbgogIH0KfSkKCmV4cG9ydHMuYmlnaW50ID0gemlnWmFnQmlnSW50KGJpZ3VpbnQpCgpleHBvcnRzLmxleGludCA9IHJlcXVpcmUoJy4vbGV4aW50JykKCmV4cG9ydHMuZmxvYXQzMiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSA0CiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoCiAgICAgIHN0YXRlLmJ1ZmZlci5idWZmZXIsCiAgICAgIHN0YXRlLnN0YXJ0ICsgc3RhdGUuYnVmZmVyLmJ5dGVPZmZzZXQsCiAgICAgIDQKICAgICkKICAgIHZpZXcuc2V0RmxvYXQzMigwLCBuLCB0cnVlKSAvLyBsaXR0bGUgZW5kaWFuCiAgICBzdGF0ZS5zdGFydCArPSA0CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDQpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KAogICAgICBzdGF0ZS5idWZmZXIuYnVmZmVyLAogICAgICBzdGF0ZS5zdGFydCArIHN0YXRlLmJ1ZmZlci5ieXRlT2Zmc2V0LAogICAgICA0CiAgICApCiAgICBjb25zdCBmbG9hdCA9IHZpZXcuZ2V0RmxvYXQzMigwLCB0cnVlKSAvLyBsaXR0bGUgZW5kaWFuCiAgICBzdGF0ZS5zdGFydCArPSA0CiAgICByZXR1cm4gZmxvYXQKICB9Cn0KCmV4cG9ydHMuZmxvYXQ2NCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSA4CiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoCiAgICAgIHN0YXRlLmJ1ZmZlci5idWZmZXIsCiAgICAgIHN0YXRlLnN0YXJ0ICsgc3RhdGUuYnVmZmVyLmJ5dGVPZmZzZXQsCiAgICAgIDgKICAgICkKICAgIHZpZXcuc2V0RmxvYXQ2NCgwLCBuLCB0cnVlKSAvLyBsaXR0bGUgZW5kaWFuCiAgICBzdGF0ZS5zdGFydCArPSA4CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDgpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KAogICAgICBzdGF0ZS5idWZmZXIuYnVmZmVyLAogICAgICBzdGF0ZS5zdGFydCArIHN0YXRlLmJ1ZmZlci5ieXRlT2Zmc2V0LAogICAgICA4CiAgICApCiAgICBjb25zdCBmbG9hdCA9IHZpZXcuZ2V0RmxvYXQ2NCgwLCB0cnVlKSAvLyBsaXR0bGUgZW5kaWFuCiAgICBzdGF0ZS5zdGFydCArPSA4CiAgICByZXR1cm4gZmxvYXQKICB9Cn0KCmNvbnN0IGJ1ZmZlciA9IChleHBvcnRzLmJ1ZmZlciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGlmIChiKSB1aW50OGFycmF5LnByZWVuY29kZShzdGF0ZSwgYikKICAgIGVsc2Ugc3RhdGUuZW5kKysKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgaWYgKGIpIHVpbnQ4YXJyYXkuZW5jb2RlKHN0YXRlLCBiKQogICAgZWxzZSBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAwCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGxlbiA9IHVpbnQuZGVjb2RlKHN0YXRlKQogICAgaWYgKGxlbiA9PT0gMCkgcmV0dXJuIG51bGwKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IGxlbikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIChzdGF0ZS5zdGFydCArPSBsZW4pKQogIH0KfSkKCmV4cG9ydHMuYmluYXJ5ID0gewogIC4uLmJ1ZmZlciwKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGlmICh0eXBlb2YgYiA9PT0gJ3N0cmluZycpIHV0ZjgucHJlZW5jb2RlKHN0YXRlLCBiKQogICAgZWxzZSBidWZmZXIucHJlZW5jb2RlKHN0YXRlLCBiKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBpZiAodHlwZW9mIGIgPT09ICdzdHJpbmcnKSB1dGY4LmVuY29kZShzdGF0ZSwgYikKICAgIGVsc2UgYnVmZmVyLmVuY29kZShzdGF0ZSwgYikKICB9Cn0KCmV4cG9ydHMuYXJyYXlidWZmZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICB1aW50LnByZWVuY29kZShzdGF0ZSwgYi5ieXRlTGVuZ3RoKQogICAgc3RhdGUuZW5kICs9IGIuYnl0ZUxlbmd0aAogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICB1aW50LmVuY29kZShzdGF0ZSwgYi5ieXRlTGVuZ3RoKQoKICAgIGNvbnN0IHZpZXcgPSBuZXcgVWludDhBcnJheShiKQoKICAgIHN0YXRlLmJ1ZmZlci5zZXQodmlldywgc3RhdGUuc3RhcnQpCiAgICBzdGF0ZS5zdGFydCArPSBiLmJ5dGVMZW5ndGgKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgbGVuID0gdWludC5kZWNvZGUoc3RhdGUpCgogICAgY29uc3QgYiA9IG5ldyBBcnJheUJ1ZmZlcihsZW4pCiAgICBjb25zdCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYikKCiAgICB2aWV3LnNldChzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIChzdGF0ZS5zdGFydCArPSBsZW4pKSkKCiAgICByZXR1cm4gYgogIH0KfQoKZnVuY3Rpb24gdHlwZWRhcnJheShUeXBlZEFycmF5LCBzd2FwKSB7CiAgY29uc3QgbiA9IFR5cGVkQXJyYXkuQllURVNfUEVSX0VMRU1FTlQKCiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgICB1aW50LnByZWVuY29kZShzdGF0ZSwgYi5sZW5ndGgpCiAgICAgIHN0YXRlLmVuZCArPSBiLmJ5dGVMZW5ndGgKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgICAgdWludC5lbmNvZGUoc3RhdGUsIGIubGVuZ3RoKQoKICAgICAgY29uc3QgdmlldyA9IG5ldyBVaW50OEFycmF5KGIuYnVmZmVyLCBiLmJ5dGVPZmZzZXQsIGIuYnl0ZUxlbmd0aCkKCiAgICAgIGlmIChCRSAmJiBzd2FwKSBzd2FwKHZpZXcpCgogICAgICBzdGF0ZS5idWZmZXIuc2V0KHZpZXcsIHN0YXRlLnN0YXJ0KQogICAgICBzdGF0ZS5zdGFydCArPSBiLmJ5dGVMZW5ndGgKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgY29uc3QgbGVuID0gdWludC5kZWNvZGUoc3RhdGUpCgogICAgICBsZXQgYiA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCwgKHN0YXRlLnN0YXJ0ICs9IGxlbiAqIG4pKQogICAgICBpZiAoYi5ieXRlTGVuZ3RoICE9PSBsZW4gKiBuKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgICBpZiAoYi5ieXRlT2Zmc2V0ICUgbiAhPT0gMCkgYiA9IG5ldyBVaW50OEFycmF5KGIpCgogICAgICBpZiAoQkUgJiYgc3dhcCkgc3dhcChiKQoKICAgICAgcmV0dXJuIG5ldyBUeXBlZEFycmF5KGIuYnVmZmVyLCBiLmJ5dGVPZmZzZXQsIGIuYnl0ZUxlbmd0aCAvIG4pCiAgICB9CiAgfQp9Cgpjb25zdCB1aW50OGFycmF5ID0gKGV4cG9ydHMudWludDhhcnJheSA9IHR5cGVkYXJyYXkoVWludDhBcnJheSkpCmV4cG9ydHMudWludDE2YXJyYXkgPSB0eXBlZGFycmF5KFVpbnQxNkFycmF5LCBiNGEuc3dhcDE2KQpleHBvcnRzLnVpbnQzMmFycmF5ID0gdHlwZWRhcnJheShVaW50MzJBcnJheSwgYjRhLnN3YXAzMikKCmV4cG9ydHMuaW50OGFycmF5ID0gdHlwZWRhcnJheShJbnQ4QXJyYXkpCmV4cG9ydHMuaW50MTZhcnJheSA9IHR5cGVkYXJyYXkoSW50MTZBcnJheSwgYjRhLnN3YXAxNikKZXhwb3J0cy5pbnQzMmFycmF5ID0gdHlwZWRhcnJheShJbnQzMkFycmF5LCBiNGEuc3dhcDMyKQoKZXhwb3J0cy5iaWd1aW50NjRhcnJheSA9IHR5cGVkYXJyYXkoQmlnVWludDY0QXJyYXksIGI0YS5zd2FwNjQpCmV4cG9ydHMuYmlnaW50NjRhcnJheSA9IHR5cGVkYXJyYXkoQmlnSW50NjRBcnJheSwgYjRhLnN3YXA2NCkKCmV4cG9ydHMuZmxvYXQzMmFycmF5ID0gdHlwZWRhcnJheShGbG9hdDMyQXJyYXksIGI0YS5zd2FwMzIpCmV4cG9ydHMuZmxvYXQ2NGFycmF5ID0gdHlwZWRhcnJheShGbG9hdDY0QXJyYXksIGI0YS5zd2FwNjQpCgpmdW5jdGlvbiBzdHJpbmcoZW5jb2RpbmcpIHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBzKSB7CiAgICAgIGNvbnN0IGxlbiA9IGI0YS5ieXRlTGVuZ3RoKHMsIGVuY29kaW5nKQogICAgICB1aW50LnByZWVuY29kZShzdGF0ZSwgbGVuKQogICAgICBzdGF0ZS5lbmQgKz0gbGVuCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBzKSB7CiAgICAgIGNvbnN0IGxlbiA9IGI0YS5ieXRlTGVuZ3RoKHMsIGVuY29kaW5nKQogICAgICB1aW50LmVuY29kZShzdGF0ZSwgbGVuKQogICAgICBiNGEud3JpdGUoc3RhdGUuYnVmZmVyLCBzLCBzdGF0ZS5zdGFydCwgZW5jb2RpbmcpCiAgICAgIHN0YXRlLnN0YXJ0ICs9IGxlbgogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICBjb25zdCBsZW4gPSB1aW50LmRlY29kZShzdGF0ZSkKICAgICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgbGVuKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgICByZXR1cm4gYjRhLnRvU3RyaW5nKAogICAgICAgIHN0YXRlLmJ1ZmZlciwKICAgICAgICBlbmNvZGluZywKICAgICAgICBzdGF0ZS5zdGFydCwKICAgICAgICAoc3RhdGUuc3RhcnQgKz0gbGVuKQogICAgICApCiAgICB9LAogICAgZml4ZWQobikgewogICAgICByZXR1cm4gewogICAgICAgIHByZWVuY29kZShzdGF0ZSkgewogICAgICAgICAgc3RhdGUuZW5kICs9IG4KICAgICAgICB9LAogICAgICAgIGVuY29kZShzdGF0ZSwgcykgewogICAgICAgICAgYjRhLndyaXRlKHN0YXRlLmJ1ZmZlciwgcywgc3RhdGUuc3RhcnQsIG4sIGVuY29kaW5nKQogICAgICAgICAgc3RhdGUuc3RhcnQgKz0gbgogICAgICAgIH0sCiAgICAgICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgICAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCBuKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgICAgICAgcmV0dXJuIGI0YS50b1N0cmluZygKICAgICAgICAgICAgc3RhdGUuYnVmZmVyLAogICAgICAgICAgICBlbmNvZGluZywKICAgICAgICAgICAgc3RhdGUuc3RhcnQsCiAgICAgICAgICAgIChzdGF0ZS5zdGFydCArPSBuKQogICAgICAgICAgKQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KfQoKY29uc3QgdXRmOCA9IChleHBvcnRzLnN0cmluZyA9IGV4cG9ydHMudXRmOCA9IHN0cmluZygndXRmLTgnKSkKZXhwb3J0cy5hc2NpaSA9IHN0cmluZygnYXNjaWknKQpleHBvcnRzLmhleCA9IHN0cmluZygnaGV4JykKZXhwb3J0cy5iYXNlNjQgPSBzdHJpbmcoJ2Jhc2U2NCcpCmV4cG9ydHMudWNzMiA9IGV4cG9ydHMudXRmMTZsZSA9IHN0cmluZygndXRmMTZsZScpCgpleHBvcnRzLmJvb2wgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBzdGF0ZS5lbmQrKwogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBiID8gMSA6IDAKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLnN0YXJ0ID49IHN0YXRlLmVuZCkgdGhyb3cgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9PT0gMQogIH0KfQoKY29uc3QgZml4ZWQgPSAoZXhwb3J0cy5maXhlZCA9IGZ1bmN0aW9uIGZpeGVkKG4pIHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBzKSB7CiAgICAgIGlmIChzLmJ5dGVMZW5ndGggIT09IG4pIHRocm93IG5ldyBFcnJvcignSW5jb3JyZWN0IGJ1ZmZlciBzaXplJykKICAgICAgc3RhdGUuZW5kICs9IG4KICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIHMpIHsKICAgICAgc3RhdGUuYnVmZmVyLnNldChzLCBzdGF0ZS5zdGFydCkKICAgICAgc3RhdGUuc3RhcnQgKz0gbgogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCBuKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0LCAoc3RhdGUuc3RhcnQgKz0gbikpCiAgICB9CiAgfQp9KQoKZXhwb3J0cy5maXhlZDMyID0gZml4ZWQoMzIpCmV4cG9ydHMuZml4ZWQ2NCA9IGZpeGVkKDY0KQoKZXhwb3J0cy5hcnJheSA9IGZ1bmN0aW9uIGFycmF5KGVuYykgewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIGxpc3QpIHsKICAgICAgdWludC5wcmVlbmNvZGUoc3RhdGUsIGxpc3QubGVuZ3RoKQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIGVuYy5wcmVlbmNvZGUoc3RhdGUsIGxpc3RbaV0pCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBsaXN0KSB7CiAgICAgIHVpbnQuZW5jb2RlKHN0YXRlLCBsaXN0Lmxlbmd0aCkKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSBlbmMuZW5jb2RlKHN0YXRlLCBsaXN0W2ldKQogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICBjb25zdCBsZW4gPSB1aW50LmRlY29kZShzdGF0ZSkKICAgICAgaWYgKGxlbiA+IDB4MTAwMDAwKSB0aHJvdyBuZXcgRXJyb3IoJ0FycmF5IGlzIHRvbyBiaWcnKQogICAgICBjb25zdCBhcnIgPSBuZXcgQXJyYXkobGVuKQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSBhcnJbaV0gPSBlbmMuZGVjb2RlKHN0YXRlKQogICAgICByZXR1cm4gYXJyCiAgICB9CiAgfQp9CgpleHBvcnRzLmZyYW1lID0gZnVuY3Rpb24gZnJhbWUoZW5jKSB7CiAgY29uc3QgZHVtbXkgPSBleHBvcnRzLnN0YXRlKCkKCiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgICBjb25zdCBlbmQgPSBzdGF0ZS5lbmQKICAgICAgZW5jLnByZWVuY29kZShzdGF0ZSwgbSkKICAgICAgdWludC5wcmVlbmNvZGUoc3RhdGUsIHN0YXRlLmVuZCAtIGVuZCkKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgZHVtbXkuZW5kID0gMAogICAgICBlbmMucHJlZW5jb2RlKGR1bW15LCBtKQogICAgICB1aW50LmVuY29kZShzdGF0ZSwgZHVtbXkuZW5kKQogICAgICBlbmMuZW5jb2RlKHN0YXRlLCBtKQogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICBjb25zdCBlbmQgPSBzdGF0ZS5lbmQKICAgICAgY29uc3QgbGVuID0gdWludC5kZWNvZGUoc3RhdGUpCiAgICAgIHN0YXRlLmVuZCA9IHN0YXRlLnN0YXJ0ICsgbGVuCiAgICAgIGNvbnN0IG0gPSBlbmMuZGVjb2RlKHN0YXRlKQogICAgICBzdGF0ZS5zdGFydCA9IHN0YXRlLmVuZAogICAgICBzdGF0ZS5lbmQgPSBlbmQKICAgICAgcmV0dXJuIG0KICAgIH0KICB9Cn0KCmV4cG9ydHMuZGF0ZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGQpIHsKICAgIGludC5wcmVlbmNvZGUoc3RhdGUsIGQuZ2V0VGltZSgpKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBkKSB7CiAgICBpbnQuZW5jb2RlKHN0YXRlLCBkLmdldFRpbWUoKSkKICB9LAogIGRlY29kZShzdGF0ZSwgZCkgewogICAgcmV0dXJuIG5ldyBEYXRlKGludC5kZWNvZGUoc3RhdGUpKQogIH0KfQoKZXhwb3J0cy5qc29uID0gewogIHByZWVuY29kZShzdGF0ZSwgdikgewogICAgdXRmOC5wcmVlbmNvZGUoc3RhdGUsIEpTT04uc3RyaW5naWZ5KHYpKQogIH0sCiAgZW5jb2RlKHN0YXRlLCB2KSB7CiAgICB1dGY4LmVuY29kZShzdGF0ZSwgSlNPTi5zdHJpbmdpZnkodikpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiBKU09OLnBhcnNlKHV0ZjguZGVjb2RlKHN0YXRlKSkKICB9Cn0KCmV4cG9ydHMubmRqc29uID0gewogIHByZWVuY29kZShzdGF0ZSwgdikgewogICAgdXRmOC5wcmVlbmNvZGUoc3RhdGUsIEpTT04uc3RyaW5naWZ5KHYpICsgJ1xuJykKICB9LAogIGVuY29kZShzdGF0ZSwgdikgewogICAgdXRmOC5lbmNvZGUoc3RhdGUsIEpTT04uc3RyaW5naWZ5KHYpICsgJ1xuJykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIEpTT04ucGFyc2UodXRmOC5kZWNvZGUoc3RhdGUpKQogIH0KfQoKLy8gc2ltcGxlIGhlbHBlciBmb3Igd2hlbiB5b3Ugd2FudCB0byBqdXN0IGV4cHJlc3Mgbm90aGluZwpleHBvcnRzLm5vbmUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICAvLyBkbyBub3RoaW5nCiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIC8vIGRvIG5vdGhpbmcKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIG51bGwKICB9Cn0KCi8vICJhbnkiIGVuY29kZXJzIGhlcmUgZm9yIGhlbHBpbmcganVzdCBzdHJ1Y3R1cmUgYW55IG9iamVjdCB3aXRob3V0IHNjaGVtYXRpc2luZyBpdAoKY29uc3QgYW55QXJyYXkgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBhcnIpIHsKICAgIHVpbnQucHJlZW5jb2RlKHN0YXRlLCBhcnIubGVuZ3RoKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgYW55LnByZWVuY29kZShzdGF0ZSwgYXJyW2ldKQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBhcnIpIHsKICAgIHVpbnQuZW5jb2RlKHN0YXRlLCBhcnIubGVuZ3RoKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgYW55LmVuY29kZShzdGF0ZSwgYXJyW2ldKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBhcnIgPSBbXQogICAgbGV0IGxlbiA9IHVpbnQuZGVjb2RlKHN0YXRlKQogICAgd2hpbGUgKGxlbi0tID4gMCkgewogICAgICBhcnIucHVzaChhbnkuZGVjb2RlKHN0YXRlKSkKICAgIH0KICAgIHJldHVybiBhcnIKICB9Cn0KCmNvbnN0IGFueU9iamVjdCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG8pIHsKICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhvKQogICAgdWludC5wcmVlbmNvZGUoc3RhdGUsIGtleXMubGVuZ3RoKQogICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykgewogICAgICB1dGY4LnByZWVuY29kZShzdGF0ZSwga2V5KQogICAgICBhbnkucHJlZW5jb2RlKHN0YXRlLCBvW2tleV0pCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG8pIHsKICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhvKQogICAgdWludC5lbmNvZGUoc3RhdGUsIGtleXMubGVuZ3RoKQogICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykgewogICAgICB1dGY4LmVuY29kZShzdGF0ZSwga2V5KQogICAgICBhbnkuZW5jb2RlKHN0YXRlLCBvW2tleV0pCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGxldCBsZW4gPSB1aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IG8gPSB7fQogICAgd2hpbGUgKGxlbi0tID4gMCkgewogICAgICBjb25zdCBrZXkgPSB1dGY4LmRlY29kZShzdGF0ZSkKICAgICAgb1trZXldID0gYW55LmRlY29kZShzdGF0ZSkKICAgIH0KICAgIHJldHVybiBvCiAgfQp9Cgpjb25zdCBhbnlUeXBlcyA9IFsKICBleHBvcnRzLm5vbmUsCiAgZXhwb3J0cy5ib29sLAogIGV4cG9ydHMuc3RyaW5nLAogIGV4cG9ydHMuYnVmZmVyLAogIGV4cG9ydHMudWludCwKICBleHBvcnRzLmludCwKICBleHBvcnRzLmZsb2F0NjQsCiAgYW55QXJyYXksCiAgYW55T2JqZWN0LAogIGV4cG9ydHMuZGF0ZQpdCgpjb25zdCBhbnkgPSAoZXhwb3J0cy5hbnkgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBvKSB7CiAgICBjb25zdCB0ID0gZ2V0VHlwZShvKQogICAgdWludC5wcmVlbmNvZGUoc3RhdGUsIHQpCiAgICBhbnlUeXBlc1t0XS5wcmVlbmNvZGUoc3RhdGUsIG8pCiAgfSwKICBlbmNvZGUoc3RhdGUsIG8pIHsKICAgIGNvbnN0IHQgPSBnZXRUeXBlKG8pCiAgICB1aW50LmVuY29kZShzdGF0ZSwgdCkKICAgIGFueVR5cGVzW3RdLmVuY29kZShzdGF0ZSwgbykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgdCA9IHVpbnQuZGVjb2RlKHN0YXRlKQogICAgaWYgKHQgPj0gYW55VHlwZXMubGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gdHlwZTogJyArIHQpCiAgICByZXR1cm4gYW55VHlwZXNbdF0uZGVjb2RlKHN0YXRlKQogIH0KfSkKCmNvbnN0IHBvcnQgPSAoZXhwb3J0cy5wb3J0ID0gdWludDE2KQoKY29uc3QgYWRkcmVzcyA9IChob3N0LCBmYW1pbHkpID0+IHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIGhvc3QucHJlZW5jb2RlKHN0YXRlLCBtLmhvc3QpCiAgICAgIHBvcnQucHJlZW5jb2RlKHN0YXRlLCBtLnBvcnQpCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIGhvc3QuZW5jb2RlKHN0YXRlLCBtLmhvc3QpCiAgICAgIHBvcnQuZW5jb2RlKHN0YXRlLCBtLnBvcnQpCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgaG9zdDogaG9zdC5kZWNvZGUoc3RhdGUpLAogICAgICAgIGZhbWlseSwKICAgICAgICBwb3J0OiBwb3J0LmRlY29kZShzdGF0ZSkKICAgICAgfQogICAgfQogIH0KfQoKY29uc3QgaXB2NCA9IChleHBvcnRzLmlwdjQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlKSB7CiAgICBzdGF0ZS5lbmQgKz0gNAogIH0sCiAgZW5jb2RlKHN0YXRlLCBzdHJpbmcpIHsKICAgIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgNAoKICAgIGxldCBpID0gMAoKICAgIHdoaWxlIChpIDwgc3RyaW5nLmxlbmd0aCkgewogICAgICBsZXQgbiA9IDAKICAgICAgbGV0IGMKCiAgICAgIHdoaWxlICgKICAgICAgICBpIDwgc3RyaW5nLmxlbmd0aCAmJgogICAgICAgIChjID0gc3RyaW5nLmNoYXJDb2RlQXQoaSsrKSkgIT09IC8qIC4gKi8gMHgyZQogICAgICApIHsKICAgICAgICBuID0gbiAqIDEwICsgKGMgLSAvKiAwICovIDB4MzApCiAgICAgIH0KCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KICAgIH0KCiAgICBzdGF0ZS5zdGFydCA9IGVuZAogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA0KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuICgKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsKICAgICAgJy4nICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsKICAgICAgJy4nICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsKICAgICAgJy4nICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgICApCiAgfQp9KQoKZXhwb3J0cy5pcHY0QWRkcmVzcyA9IGFkZHJlc3MoaXB2NCwgNCkKCmNvbnN0IGlwdjYgPSAoZXhwb3J0cy5pcHY2ID0gewogIHByZWVuY29kZShzdGF0ZSkgewogICAgc3RhdGUuZW5kICs9IDE2CiAgfSwKICBlbmNvZGUoc3RhdGUsIHN0cmluZykgewogICAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogICAgY29uc3QgZW5kID0gc3RhcnQgKyAxNgoKICAgIGxldCBpID0gMAogICAgbGV0IHNwbGl0ID0gbnVsbAoKICAgIHdoaWxlIChpIDwgc3RyaW5nLmxlbmd0aCkgewogICAgICBsZXQgbiA9IDAKICAgICAgbGV0IGMKCiAgICAgIHdoaWxlICgKICAgICAgICBpIDwgc3RyaW5nLmxlbmd0aCAmJgogICAgICAgIChjID0gc3RyaW5nLmNoYXJDb2RlQXQoaSsrKSkgIT09IC8qIDogKi8gMHgzYQogICAgICApIHsKICAgICAgICBpZiAoYyA+PSAweDMwICYmIGMgPD0gMHgzOSkgbiA9IG4gKiAweDEwICsgKGMgLSAvKiAwICovIDB4MzApCiAgICAgICAgZWxzZSBpZiAoYyA+PSAweDQxICYmIGMgPD0gMHg0NikgbiA9IG4gKiAweDEwICsgKGMgLSAvKiBBICovIDB4NDEgKyAxMCkKICAgICAgICBlbHNlIGlmIChjID49IDB4NjEgJiYgYyA8PSAweDY2KSBuID0gbiAqIDB4MTAgKyAoYyAtIC8qIGEgKi8gMHg2MSArIDEwKQogICAgICB9CgogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuID4+PiA4CiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KCiAgICAgIGlmIChpIDwgc3RyaW5nLmxlbmd0aCAmJiBzdHJpbmcuY2hhckNvZGVBdChpKSA9PT0gLyogOiAqLyAweDNhKSB7CiAgICAgICAgaSsrCiAgICAgICAgc3BsaXQgPSBzdGF0ZS5zdGFydAogICAgICB9CiAgICB9CgogICAgaWYgKHNwbGl0ICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IG9mZnNldCA9IGVuZCAtIHN0YXRlLnN0YXJ0CiAgICAgIHN0YXRlLmJ1ZmZlcgogICAgICAgIC5jb3B5V2l0aGluKHNwbGl0ICsgb2Zmc2V0LCBzcGxpdCkKICAgICAgICAuZmlsbCgwLCBzcGxpdCwgc3BsaXQgKyBvZmZzZXQpCiAgICB9CgogICAgc3RhdGUuc3RhcnQgPSBlbmQKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgMTYpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gKAogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikgKwogICAgICAnOicgKwogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikgKwogICAgICAnOicgKwogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikgKwogICAgICAnOicgKwogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikgKwogICAgICAnOicgKwogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikgKwogICAgICAnOicgKwogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikgKwogICAgICAnOicgKwogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikgKwogICAgICAnOicgKwogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikKICAgICkKICB9Cn0pCgpleHBvcnRzLmlwdjZBZGRyZXNzID0gYWRkcmVzcyhpcHY2LCA2KQoKY29uc3QgaXAgPSAoZXhwb3J0cy5pcCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHN0cmluZykgewogICAgY29uc3QgZmFtaWx5ID0gc3RyaW5nLmluY2x1ZGVzKCc6JykgPyA2IDogNAogICAgdWludDgucHJlZW5jb2RlKHN0YXRlLCBmYW1pbHkpCiAgICBpZiAoZmFtaWx5ID09PSA0KSBpcHY0LnByZWVuY29kZShzdGF0ZSkKICAgIGVsc2UgaXB2Ni5wcmVlbmNvZGUoc3RhdGUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHN0cmluZykgewogICAgY29uc3QgZmFtaWx5ID0gc3RyaW5nLmluY2x1ZGVzKCc6JykgPyA2IDogNAogICAgdWludDguZW5jb2RlKHN0YXRlLCBmYW1pbHkpCiAgICBpZiAoZmFtaWx5ID09PSA0KSBpcHY0LmVuY29kZShzdGF0ZSwgc3RyaW5nKQogICAgZWxzZSBpcHY2LmVuY29kZShzdGF0ZSwgc3RyaW5nKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmYW1pbHkgPSB1aW50OC5kZWNvZGUoc3RhdGUpCiAgICBpZiAoZmFtaWx5ID09PSA0KSByZXR1cm4gaXB2NC5kZWNvZGUoc3RhdGUpCiAgICBlbHNlIHJldHVybiBpcHY2LmRlY29kZShzdGF0ZSkKICB9Cn0pCgpleHBvcnRzLmlwQWRkcmVzcyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGlwLnByZWVuY29kZShzdGF0ZSwgbS5ob3N0KQogICAgcG9ydC5wcmVlbmNvZGUoc3RhdGUsIG0ucG9ydCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgaXAuZW5jb2RlKHN0YXRlLCBtLmhvc3QpCiAgICBwb3J0LmVuY29kZShzdGF0ZSwgbS5wb3J0KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmYW1pbHkgPSB1aW50OC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBob3N0OiBmYW1pbHkgPT09IDQgPyBpcHY0LmRlY29kZShzdGF0ZSkgOiBpcHY2LmRlY29kZShzdGF0ZSksCiAgICAgIGZhbWlseSwKICAgICAgcG9ydDogcG9ydC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBnZXRUeXBlKG8pIHsKICBpZiAobyA9PT0gbnVsbCB8fCBvID09PSB1bmRlZmluZWQpIHJldHVybiAwCiAgaWYgKHR5cGVvZiBvID09PSAnYm9vbGVhbicpIHJldHVybiAxCiAgaWYgKHR5cGVvZiBvID09PSAnc3RyaW5nJykgcmV0dXJuIDIKICBpZiAoYjRhLmlzQnVmZmVyKG8pKSByZXR1cm4gMwogIGlmICh0eXBlb2YgbyA9PT0gJ251bWJlcicpIHsKICAgIGlmIChOdW1iZXIuaXNJbnRlZ2VyKG8pKSByZXR1cm4gbyA+PSAwID8gNCA6IDUKICAgIHJldHVybiA2CiAgfQogIGlmIChBcnJheS5pc0FycmF5KG8pKSByZXR1cm4gNwogIGlmIChvIGluc3RhbmNlb2YgRGF0ZSkgcmV0dXJuIDkKICBpZiAodHlwZW9mIG8gPT09ICdvYmplY3QnKSByZXR1cm4gOAoKICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHR5cGUgZm9yICcgKyBvKQp9CgpleHBvcnRzLmZyb20gPSBmdW5jdGlvbiBmcm9tKGVuYykgewogIGlmICh0eXBlb2YgZW5jID09PSAnc3RyaW5nJykgcmV0dXJuIGZyb21OYW1lZChlbmMpCiAgaWYgKGVuYy5wcmVlbmNvZGUpIHJldHVybiBlbmMKICBpZiAoZW5jLmVuY29kaW5nTGVuZ3RoKSByZXR1cm4gZnJvbUFic3RyYWN0RW5jb2RlcihlbmMpCiAgcmV0dXJuIGZyb21Db2RlYyhlbmMpCn0KCmZ1bmN0aW9uIGZyb21OYW1lZChlbmMpIHsKICBzd2l0Y2ggKGVuYykgewogICAgY2FzZSAnYXNjaWknOgogICAgICByZXR1cm4gcmF3LmFzY2lpCiAgICBjYXNlICd1dGYtOCc6CiAgICBjYXNlICd1dGY4JzoKICAgICAgcmV0dXJuIHJhdy51dGY4CiAgICBjYXNlICdoZXgnOgogICAgICByZXR1cm4gcmF3LmhleAogICAgY2FzZSAnYmFzZTY0JzoKICAgICAgcmV0dXJuIHJhdy5iYXNlNjQKICAgIGNhc2UgJ3V0ZjE2LWxlJzoKICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgY2FzZSAndWNzLTInOgogICAgY2FzZSAndWNzMic6CiAgICAgIHJldHVybiByYXcudWNzMgogICAgY2FzZSAnbmRqc29uJzoKICAgICAgcmV0dXJuIHJhdy5uZGpzb24KICAgIGNhc2UgJ2pzb24nOgogICAgICByZXR1cm4gcmF3Lmpzb24KICAgIGNhc2UgJ2JpbmFyeSc6CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gcmF3LmJpbmFyeQogIH0KfQoKZnVuY3Rpb24gZnJvbUNvZGVjKGVuYykgewogIGxldCB0bXBNID0gbnVsbAogIGxldCB0bXBCdWYgPSBudWxsCgogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgdG1wTSA9IG0KICAgICAgdG1wQnVmID0gZW5jLmVuY29kZShtKQogICAgICBzdGF0ZS5lbmQgKz0gdG1wQnVmLmJ5dGVMZW5ndGgKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgcmF3LmVuY29kZShzdGF0ZSwgbSA9PT0gdG1wTSA/IHRtcEJ1ZiA6IGVuYy5lbmNvZGUobSkpCiAgICAgIHRtcE0gPSB0bXBCdWYgPSBudWxsCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIHJldHVybiBlbmMuZGVjb2RlKHJhdy5kZWNvZGUoc3RhdGUpKQogICAgfQogIH0KfQoKZnVuY3Rpb24gZnJvbUFic3RyYWN0RW5jb2RlcihlbmMpIHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIHN0YXRlLmVuZCArPSBlbmMuZW5jb2RpbmdMZW5ndGgobSkKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgZW5jLmVuY29kZShtLCBzdGF0ZS5idWZmZXIsIHN0YXRlLnN0YXJ0KQogICAgICBzdGF0ZS5zdGFydCArPSBlbmMuZW5jb2RlLmJ5dGVzCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIGNvbnN0IG0gPSBlbmMuZGVjb2RlKHN0YXRlLmJ1ZmZlciwgc3RhdGUuc3RhcnQsIHN0YXRlLmVuZCkKICAgICAgc3RhdGUuc3RhcnQgKz0gZW5jLmRlY29kZS5ieXRlcwogICAgICByZXR1cm4gbQogICAgfQogIH0KfQoKZXhwb3J0cy5lbmNvZGUgPSBmdW5jdGlvbiBlbmNvZGUoZW5jLCBtKSB7CiAgY29uc3Qgc3RhdGUgPSBleHBvcnRzLnN0YXRlKCkKICBlbmMucHJlZW5jb2RlKHN0YXRlLCBtKQogIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShzdGF0ZS5lbmQpCiAgZW5jLmVuY29kZShzdGF0ZSwgbSkKICByZXR1cm4gc3RhdGUuYnVmZmVyCn0KCmV4cG9ydHMuZGVjb2RlID0gZnVuY3Rpb24gZGVjb2RlKGVuYywgYnVmZmVyKSB7CiAgcmV0dXJuIGVuYy5kZWNvZGUoZXhwb3J0cy5zdGF0ZSgwLCBidWZmZXIuYnl0ZUxlbmd0aCwgYnVmZmVyKSkKfQoKZnVuY3Rpb24gemlnWmFnSW50KGVuYykgewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgICAgZW5jLnByZWVuY29kZShzdGF0ZSwgemlnWmFnRW5jb2RlSW50KG4pKQogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgbikgewogICAgICBlbmMuZW5jb2RlKHN0YXRlLCB6aWdaYWdFbmNvZGVJbnQobikpCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIHJldHVybiB6aWdaYWdEZWNvZGVJbnQoZW5jLmRlY29kZShzdGF0ZSkpCiAgICB9CiAgfQp9CgpmdW5jdGlvbiB6aWdaYWdEZWNvZGVJbnQobikgewogIHJldHVybiBuID09PSAwID8gbiA6IChuICYgMSkgPT09IDAgPyBuIC8gMiA6IC0obiArIDEpIC8gMgp9CgpmdW5jdGlvbiB6aWdaYWdFbmNvZGVJbnQobikgewogIC8vIDAsIC0xLCAxLCAtMiwgMiwgLi4uCiAgcmV0dXJuIG4gPCAwID8gMiAqIC1uIC0gMSA6IG4gPT09IDAgPyAwIDogMiAqIG4KfQoKZnVuY3Rpb24gemlnWmFnQmlnSW50KGVuYykgewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgICAgZW5jLnByZWVuY29kZShzdGF0ZSwgemlnWmFnRW5jb2RlQmlnSW50KG4pKQogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgbikgewogICAgICBlbmMuZW5jb2RlKHN0YXRlLCB6aWdaYWdFbmNvZGVCaWdJbnQobikpCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIHJldHVybiB6aWdaYWdEZWNvZGVCaWdJbnQoZW5jLmRlY29kZShzdGF0ZSkpCiAgICB9CiAgfQp9CgpmdW5jdGlvbiB6aWdaYWdEZWNvZGVCaWdJbnQobikgewogIHJldHVybiBuID09PSAwbiA/IG4gOiAobiAmIDFuKSA9PT0gMG4gPyBuIC8gMm4gOiAtKG4gKyAxbikgLyAybgp9CgpmdW5jdGlvbiB6aWdaYWdFbmNvZGVCaWdJbnQobikgewogIC8vIDAsIC0xLCAxLCAtMiwgMiwgLi4uCiAgcmV0dXJuIG4gPCAwbiA/IDJuICogLW4gLSAxbiA6IG4gPT09IDBuID8gMG4gOiAybiAqIG4KfQoKZnVuY3Rpb24gdmFsaWRhdGVVaW50KG4pIHsKICBpZiAobiA+PSAwID09PSBmYWxzZSAvKiBIYW5kbGVzIE5hTiBhcyB3ZWxsICovKQogICAgdGhyb3cgbmV3IEVycm9yKCd1aW50IG11c3QgYmUgcG9zaXRpdmUnKQp9Cm1vZHVsZS5leHBvcnRzID0gewogIHByZWVuY29kZSwKICBlbmNvZGUsCiAgZGVjb2RlCn0KCmZ1bmN0aW9uIHByZWVuY29kZShzdGF0ZSwgbnVtKSB7CiAgaWYgKG51bSA8IDI1MSkgewogICAgc3RhdGUuZW5kKysKICB9IGVsc2UgaWYgKG51bSA8IDI1NikgewogICAgc3RhdGUuZW5kICs9IDIKICB9IGVsc2UgaWYgKG51bSA8IDB4MTAwMDApIHsKICAgIHN0YXRlLmVuZCArPSAzCiAgfSBlbHNlIGlmIChudW0gPCAweDEwMDAwMDApIHsKICAgIHN0YXRlLmVuZCArPSA0CiAgfSBlbHNlIGlmIChudW0gPCAweDEwMDAwMDAwMCkgewogICAgc3RhdGUuZW5kICs9IDUKICB9IGVsc2UgewogICAgc3RhdGUuZW5kKysKICAgIGNvbnN0IGV4cCA9IE1hdGguZmxvb3IoTWF0aC5sb2cobnVtKSAvIE1hdGgubG9nKDIpKSAtIDMyCiAgICBwcmVlbmNvZGUoc3RhdGUsIGV4cCkKICAgIHN0YXRlLmVuZCArPSA2CiAgfQp9CgpmdW5jdGlvbiBlbmNvZGUoc3RhdGUsIG51bSkgewogIGNvbnN0IG1heCA9IDI1MQogIGNvbnN0IHggPSBudW0gLSBtYXgKCiAgaWYgKG51bSA8IG1heCkgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbnVtCiAgfSBlbHNlIGlmIChudW0gPCAyNTYpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG1heAogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0geAogIH0gZWxzZSBpZiAobnVtIDwgMHgxMDAwMCkgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbWF4ICsgMQogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gKHggPj4gOCkgJiAweGZmCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSB4ICYgMHhmZgogIH0gZWxzZSBpZiAobnVtIDwgMHgxMDAwMDAwKSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBtYXggKyAyCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSB4ID4+IDE2CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAoeCA+PiA4KSAmIDB4ZmYKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IHggJiAweGZmCiAgfSBlbHNlIGlmIChudW0gPCAweDEwMDAwMDAwMCkgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbWF4ICsgMwogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0geCA+PiAyNAogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gKHggPj4gMTYpICYgMHhmZgogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gKHggPj4gOCkgJiAweGZmCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSB4ICYgMHhmZgogIH0gZWxzZSB7CiAgICAvLyBuZWVkIHRvIHVzZSBNYXRoIGhlcmUgYXMgYml0d2lzZSBvcHMgYXJlIDMyIGJpdAogICAgY29uc3QgZXhwID0gTWF0aC5mbG9vcihNYXRoLmxvZyh4KSAvIE1hdGgubG9nKDIpKSAtIDMyCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweGZmCgogICAgZW5jb2RlKHN0YXRlLCBleHApCiAgICBjb25zdCByZW0gPSB4IC8gTWF0aC5wb3coMiwgZXhwIC0gMTEpCgogICAgZm9yIChsZXQgaSA9IDU7IGkgPj0gMDsgaS0tKSB7CiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IChyZW0gLyBNYXRoLnBvdygyLCA4ICogaSkpICYgMHhmZgogICAgfQogIH0KfQoKZnVuY3Rpb24gZGVjb2RlKHN0YXRlKSB7CiAgY29uc3QgbWF4ID0gMjUxCgogIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDEpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCgogIGNvbnN0IGZsYWcgPSBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KCiAgaWYgKGZsYWcgPCBtYXgpIHJldHVybiBmbGFnCgogIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IGZsYWcgLSBtYXggKyAxKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMuJykKICB9CgogIGlmIChmbGFnIDwgMjUyKSB7CiAgICByZXR1cm4gc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsgbWF4CiAgfQoKICBpZiAoZmxhZyA8IDI1MykgewogICAgcmV0dXJuICgKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA8PCA4KSArIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArIG1heAogICAgKQogIH0KCiAgaWYgKGZsYWcgPCAyNTQpIHsKICAgIHJldHVybiAoCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPDwgMTYpICsKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA8PCA4KSArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArCiAgICAgIG1heAogICAgKQogIH0KCiAgLy8gPDwgMjQgcmVzdWx0IG1heSBiZSBpbnRlcnByZXRlZCBhcyBuZWdhdGl2ZQogIGlmIChmbGFnIDwgMjU1KSB7CiAgICByZXR1cm4gKAogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMDAwMDAgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdIDw8IDE2KSArCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPDwgOCkgKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKwogICAgICBtYXgKICAgICkKICB9CgogIGNvbnN0IGV4cCA9IGRlY29kZShzdGF0ZSkKCiAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgNikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKCiAgbGV0IHJlbSA9IDAKICBmb3IgKGxldCBpID0gNTsgaSA+PSAwOyBpLS0pIHsKICAgIHJlbSArPSBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiBNYXRoLnBvdygyLCA4ICogaSkKICB9CgogIHJldHVybiByZW0gKiBNYXRoLnBvdygyLCBleHAgLSAxMSkgKyBtYXgKfQp7CiAgIm5hbWUiOiAiY29tcGFjdC1lbmNvZGluZyIsCiAgInZlcnNpb24iOiAiMi4xOC4wIiwKICAiZGVzY3JpcHRpb24iOiAiQSBzZXJpZXMgb2YgY29tcGFjdCBlbmNvZGluZyBzY2hlbWVzIGZvciBidWlsZGluZyBzbWFsbCBhbmQgZmFzdCBwYXJzZXJzIGFuZCBzZXJpYWxpemVycyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjMuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4wLjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMS4wLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLiAtLXdyaXRlIiwKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9jb21wYWN0LWVuY29kaW5nL2NvbXBhY3QtZW5jb2RpbmcuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2NvbXBhY3QtZW5jb2RpbmcvY29tcGFjdC1lbmNvZGluZy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2NvbXBhY3QtZW5jb2RpbmcvY29tcGFjdC1lbmNvZGluZyIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgeyBCRSB9ID0gcmVxdWlyZSgnLi9lbmRpYW4nKQoKZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gewogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgc3RhdGUuZW5kICs9IGIuYnl0ZUxlbmd0aAogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBzdGF0ZS5idWZmZXIuc2V0KGIsIHN0YXRlLnN0YXJ0KQogICAgc3RhdGUuc3RhcnQgKz0gYi5ieXRlTGVuZ3RoCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGIgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIHN0YXRlLmVuZCkKICAgIHN0YXRlLnN0YXJ0ID0gc3RhdGUuZW5kCiAgICByZXR1cm4gYgogIH0KfQoKY29uc3QgYnVmZmVyID0gKGV4cG9ydHMuYnVmZmVyID0gewogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgaWYgKGIpIHVpbnQ4YXJyYXkucHJlZW5jb2RlKHN0YXRlLCBiKQogICAgZWxzZSBzdGF0ZS5lbmQrKwogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBpZiAoYikgdWludDhhcnJheS5lbmNvZGUoc3RhdGUsIGIpCiAgICBlbHNlIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDAKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgYiA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCkKICAgIGlmIChiLmJ5dGVMZW5ndGggPT09IDApIHJldHVybiBudWxsCiAgICBzdGF0ZS5zdGFydCA9IHN0YXRlLmVuZAogICAgcmV0dXJuIGIKICB9Cn0pCgpleHBvcnRzLmJpbmFyeSA9IHsKICAuLi5idWZmZXIsCiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBpZiAodHlwZW9mIGIgPT09ICdzdHJpbmcnKSB1dGY4LnByZWVuY29kZShzdGF0ZSwgYikKICAgIGVsc2UgYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgYikKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgaWYgKHR5cGVvZiBiID09PSAnc3RyaW5nJykgdXRmOC5lbmNvZGUoc3RhdGUsIGIpCiAgICBlbHNlIGJ1ZmZlci5lbmNvZGUoc3RhdGUsIGIpCiAgfQp9CgpleHBvcnRzLmFycmF5YnVmZmVyID0gewogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgc3RhdGUuZW5kICs9IGIuYnl0ZUxlbmd0aAogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBjb25zdCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYikKCiAgICBzdGF0ZS5idWZmZXIuc2V0KHZpZXcsIHN0YXRlLnN0YXJ0KQogICAgc3RhdGUuc3RhcnQgKz0gYi5ieXRlTGVuZ3RoCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGIgPSBuZXcgQXJyYXlCdWZmZXIoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQpCiAgICBjb25zdCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYikKCiAgICB2aWV3LnNldChzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQpKQoKICAgIHN0YXRlLnN0YXJ0ID0gc3RhdGUuZW5kCgogICAgcmV0dXJuIGIKICB9Cn0KCmZ1bmN0aW9uIHR5cGVkYXJyYXkoVHlwZWRBcnJheSwgc3dhcCkgewogIGNvbnN0IG4gPSBUeXBlZEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UCgogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgICAgc3RhdGUuZW5kICs9IGIuYnl0ZUxlbmd0aAogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgYikgewogICAgICBjb25zdCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYi5idWZmZXIsIGIuYnl0ZU9mZnNldCwgYi5ieXRlTGVuZ3RoKQoKICAgICAgaWYgKEJFICYmIHN3YXApIHN3YXAodmlldykKCiAgICAgIHN0YXRlLmJ1ZmZlci5zZXQodmlldywgc3RhdGUuc3RhcnQpCiAgICAgIHN0YXRlLnN0YXJ0ICs9IGIuYnl0ZUxlbmd0aAogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICBsZXQgYiA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCkKICAgICAgaWYgKGIuYnl0ZU9mZnNldCAlIG4gIT09IDApIGIgPSBuZXcgVWludDhBcnJheShiKQoKICAgICAgaWYgKEJFICYmIHN3YXApIHN3YXAoYikKCiAgICAgIHN0YXRlLnN0YXJ0ID0gc3RhdGUuZW5kCgogICAgICByZXR1cm4gbmV3IFR5cGVkQXJyYXkoYi5idWZmZXIsIGIuYnl0ZU9mZnNldCwgYi5ieXRlTGVuZ3RoIC8gbikKICAgIH0KICB9Cn0KCmNvbnN0IHVpbnQ4YXJyYXkgPSAoZXhwb3J0cy51aW50OGFycmF5ID0gdHlwZWRhcnJheShVaW50OEFycmF5KSkKZXhwb3J0cy51aW50MTZhcnJheSA9IHR5cGVkYXJyYXkoVWludDE2QXJyYXksIGI0YS5zd2FwMTYpCmV4cG9ydHMudWludDMyYXJyYXkgPSB0eXBlZGFycmF5KFVpbnQzMkFycmF5LCBiNGEuc3dhcDMyKQoKZXhwb3J0cy5pbnQ4YXJyYXkgPSB0eXBlZGFycmF5KEludDhBcnJheSkKZXhwb3J0cy5pbnQxNmFycmF5ID0gdHlwZWRhcnJheShJbnQxNkFycmF5LCBiNGEuc3dhcDE2KQpleHBvcnRzLmludDMyYXJyYXkgPSB0eXBlZGFycmF5KEludDMyQXJyYXksIGI0YS5zd2FwMzIpCgpleHBvcnRzLmJpZ3VpbnQ2NGFycmF5ID0gdHlwZWRhcnJheShCaWdVaW50NjRBcnJheSwgYjRhLnN3YXA2NCkKZXhwb3J0cy5iaWdpbnQ2NGFycmF5ID0gdHlwZWRhcnJheShCaWdJbnQ2NEFycmF5LCBiNGEuc3dhcDY0KQoKZXhwb3J0cy5mbG9hdDMyYXJyYXkgPSB0eXBlZGFycmF5KEZsb2F0MzJBcnJheSwgYjRhLnN3YXAzMikKZXhwb3J0cy5mbG9hdDY0YXJyYXkgPSB0eXBlZGFycmF5KEZsb2F0NjRBcnJheSwgYjRhLnN3YXA2NCkKCmZ1bmN0aW9uIHN0cmluZyhlbmNvZGluZykgewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIHMpIHsKICAgICAgc3RhdGUuZW5kICs9IGI0YS5ieXRlTGVuZ3RoKHMsIGVuY29kaW5nKQogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgcykgewogICAgICBzdGF0ZS5zdGFydCArPSBiNGEud3JpdGUoc3RhdGUuYnVmZmVyLCBzLCBzdGF0ZS5zdGFydCwgZW5jb2RpbmcpCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIGNvbnN0IHMgPSBiNGEudG9TdHJpbmcoc3RhdGUuYnVmZmVyLCBlbmNvZGluZywgc3RhdGUuc3RhcnQpCiAgICAgIHN0YXRlLnN0YXJ0ID0gc3RhdGUuZW5kCiAgICAgIHJldHVybiBzCiAgICB9CiAgfQp9Cgpjb25zdCB1dGY4ID0gKGV4cG9ydHMuc3RyaW5nID0gZXhwb3J0cy51dGY4ID0gc3RyaW5nKCd1dGYtOCcpKQpleHBvcnRzLmFzY2lpID0gc3RyaW5nKCdhc2NpaScpCmV4cG9ydHMuaGV4ID0gc3RyaW5nKCdoZXgnKQpleHBvcnRzLmJhc2U2NCA9IHN0cmluZygnYmFzZTY0JykKZXhwb3J0cy51Y3MyID0gZXhwb3J0cy51dGYxNmxlID0gc3RyaW5nKCd1dGYxNmxlJykKCmV4cG9ydHMuYXJyYXkgPSBmdW5jdGlvbiBhcnJheShlbmMpIHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBsaXN0KSB7CiAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgbGlzdCkgZW5jLnByZWVuY29kZShzdGF0ZSwgdmFsdWUpCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBsaXN0KSB7CiAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgbGlzdCkgZW5jLmVuY29kZShzdGF0ZSwgdmFsdWUpCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIGNvbnN0IGFyciA9IFtdCiAgICAgIHdoaWxlIChzdGF0ZS5zdGFydCA8IHN0YXRlLmVuZCkgYXJyLnB1c2goZW5jLmRlY29kZShzdGF0ZSkpCiAgICAgIHJldHVybiBhcnIKICAgIH0KICB9Cn0KCmV4cG9ydHMuanNvbiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHYpIHsKICAgIHV0ZjgucHJlZW5jb2RlKHN0YXRlLCBKU09OLnN0cmluZ2lmeSh2KSkKICB9LAogIGVuY29kZShzdGF0ZSwgdikgewogICAgdXRmOC5lbmNvZGUoc3RhdGUsIEpTT04uc3RyaW5naWZ5KHYpKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gSlNPTi5wYXJzZSh1dGY4LmRlY29kZShzdGF0ZSkpCiAgfQp9CgpleHBvcnRzLm5kanNvbiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHYpIHsKICAgIHV0ZjgucHJlZW5jb2RlKHN0YXRlLCBKU09OLnN0cmluZ2lmeSh2KSArICdcbicpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHYpIHsKICAgIHV0ZjguZW5jb2RlKHN0YXRlLCBKU09OLnN0cmluZ2lmeSh2KSArICdcbicpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiBKU09OLnBhcnNlKHV0ZjguZGVjb2RlKHN0YXRlKSkKICB9Cn0KY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBDb3JlQ291cGxlciB7CiAgY29uc3RydWN0b3IgKHRhcmdldCwgd2FrZXVwKSB7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldAogICAgdGhpcy53YWtldXAgPSB3YWtldXAKICAgIHRoaXMuY291cGxlZCA9IG5ldyBTZXQoKQoKICAgIHRoaXMuX29ucGVlcmFkZEJvdW5kID0gdGhpcy5fb25wZWVyYWRkLmJpbmQodGhpcykKICAgIHRoaXMudGFyZ2V0Lm9uKCdwZWVyLWFkZCcsIHRoaXMuX29ucGVlcmFkZEJvdW5kKQogIH0KCiAgYWRkIChjb3JlKSB7CiAgICBjb25zdCBhZGRlZCA9IHRoaXMuY291cGxlZC5zaXplCiAgICB0aGlzLmNvdXBsZWQuYWRkKGNvcmUpCiAgICBpZiAoYWRkZWQgIT09IHRoaXMuY291cGxlZC5zaXplKSB0aGlzLl9jb3VwbGUoY29yZSkKICB9CgogIHJlbW92ZSAoY29yZSkgewogICAgdGhpcy5jb3VwbGVkLmRlbGV0ZShjb3JlKQogIH0KCiAgZGVzdHJveSAoKSB7CiAgICB0aGlzLnRhcmdldC5vZmYoJ3BlZXItYWRkJywgdGhpcy5fb25wZWVyYWRkQm91bmQpCiAgfQoKICBhc3luYyB1cGRhdGUgKHN0cmVhbSkgewogICAgY29uc3QgbXV4ZXIgPSBzdHJlYW0udXNlckRhdGEKICAgIGlmICghbXV4ZXIpIHJldHVybgoKICAgIHRyeSB7CiAgICAgIGlmICghKGF3YWl0IHRoaXMuX2hhc011eGVyKHRoaXMudGFyZ2V0LCBtdXhlcikpKSByZXR1cm4KCiAgICAgIGxldCB3YWtldXAgPSBudWxsCgogICAgICBmb3IgKGNvbnN0IGNvcmUgb2YgdGhpcy5jb3VwbGVkKSB7CiAgICAgICAgaWYgKGF3YWl0IHRoaXMuX2hhc011eGVyKGNvcmUsIG11eGVyKSkgY29udGludWUKICAgICAgICBpZiAod2FrZXVwID09PSBudWxsKSB3YWtldXAgPSBbXQogICAgICAgIHdha2V1cC5wdXNoKGNvcmUpCiAgICAgIH0KCiAgICAgIGlmICh3YWtldXAgIT09IG51bGwpIHsKICAgICAgICB0aGlzLndha2V1cChzdHJlYW0sIHdha2V1cCkKICAgICAgfQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgIH0KICB9CgogIGFzeW5jIF9jb3VwbGUgKGNvcmUpIHsKICAgIHRyeSB7CiAgICAgIGxldCB3YWtldXAgPSBudWxsCgogICAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy50YXJnZXQucGVlcnMpIHsKICAgICAgICBpZiAoYXdhaXQgdGhpcy5faGFzUGVlcihjb3JlLCBwZWVyKSkgY29udGludWUKICAgICAgICBpZiAod2FrZXVwID09PSBudWxsKSB3YWtldXAgPSBbXQogICAgICAgIHdha2V1cC5wdXNoKHBlZXIpCiAgICAgIH0KCiAgICAgIGlmICh3YWtldXAgIT09IG51bGwgJiYgdGhpcy5jb3VwbGVkLmhhcyhjb3JlKSkgewogICAgICAgIGZvciAoY29uc3QgcGVlciBvZiB3YWtldXApIHRoaXMud2FrZXVwKHBlZXIuc3RyZWFtLCBbY29yZV0pCiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICB9CiAgfQoKICBhc3luYyBfb25wZWVyYWRkIChwZWVyKSB7CiAgICB0cnkgewogICAgICBsZXQgd2FrZXVwID0gbnVsbAoKICAgICAgZm9yIChjb25zdCBjb3JlIG9mIHRoaXMuY291cGxlZCkgewogICAgICAgIGlmIChhd2FpdCB0aGlzLl9oYXNQZWVyKGNvcmUsIHBlZXIpKSBjb250aW51ZQogICAgICAgIGlmICh3YWtldXAgPT09IG51bGwpIHdha2V1cCA9IFtdCiAgICAgICAgd2FrZXVwLnB1c2goY29yZSkKICAgICAgfQoKICAgICAgaWYgKHdha2V1cCAhPT0gbnVsbCkgewogICAgICAgIHRoaXMud2FrZXVwKHBlZXIuc3RyZWFtLCB3YWtldXApCiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICB9CiAgfQoKICBfaGFzTXV4ZXIgKGNvcmUsIG11eGVyKSB7CiAgICBjb25zdCBjaCA9IG11eGVyLmdldExhc3RDaGFubmVsKHsgcHJvdG9jb2w6ICdoeXBlcmNvcmUnLCBpZDogY29yZS5kaXNjb3ZlcnlLZXkgfSkKICAgIGlmIChjaCkgcmV0dXJuIGNoLmZ1bGx5T3BlbmVkKCkKCiAgICBjb25zdCBjaGEgPSBtdXhlci5nZXRMYXN0Q2hhbm5lbCh7IHByb3RvY29sOiAnaHlwZXJjb3JlL2FscGhhJywgaWQ6IGNvcmUuZGlzY292ZXJ5S2V5IH0pCiAgICBpZiAoY2hhKSByZXR1cm4gY2hhLmZ1bGx5T3BlbmVkKCkKCiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKQogIH0KCiAgX2hhc1BlZXIgKGNvcmUsIHBlZXIpIHsKICAgIHJldHVybiB0aGlzLl9oYXNNdXhlcihjb3JlLCBwZWVyLnByb3RvbXV4KQogIH0KfQp7CiAgIm5hbWUiOiAiY29yZS1jb3VwbGVyIiwKICAidmVyc2lvbiI6ICIyLjAuMCIsCiAgImRlc2NyaXB0aW9uIjogIkNvdXBsZSB0aGUgcGVlcnMgb2YgY29yZXMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkIgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJzYWZldHktY2F0Y2giOiAiXjEuMC4yIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJjb3Jlc3RvcmUiOiAiXjYuMTguMiIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2NvcmUtY291cGxlci5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMiLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vY29yZS1jb3VwbGVyL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vY29yZS1jb3VwbGVyIgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IEh5cGVyY29yZSA9IHJlcXVpcmUoJ2h5cGVyY29yZScpCmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgSUQgPSByZXF1aXJlKCdoeXBlcmNvcmUtaWQtZW5jb2RpbmcnKQpjb25zdCB7IGlzQW5kcm9pZCB9ID0gcmVxdWlyZSgnd2hpY2gtcnVudGltZScpCmNvbnN0IHsgU1RPUkFHRV9FTVBUWSwgQVNTRVJUSU9OIH0gPSByZXF1aXJlKCdoeXBlcmNvcmUtZXJyb3JzJykKCmNvbnN0IGF1ZGl0U3RvcmUgPSByZXF1aXJlKCcuL2xpYi9hdWRpdC5qcycpCgpjb25zdCBbTlNdID0gY3J5cHRvLm5hbWVzcGFjZSgnY29yZXN0b3JlJywgMSkKY29uc3QgREVGQVVMVF9OQU1FU1BBQ0UgPSBiNGEuYWxsb2MoMzIpIC8vIFRoaXMgaXMgbWVhbnQgdG8gYmUgMzIgMC1ieXRlcwoKY2xhc3MgU3RyZWFtVHJhY2tlciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLnJlY29yZHMgPSBbXQogIH0KCiAgYWRkKHN0cmVhbSwgaXNFeHRlcm5hbCkgewogICAgY29uc3QgcmVjb3JkID0geyBpbmRleDogMCwgc3RyZWFtLCBpc0V4dGVybmFsIH0KICAgIHJlY29yZC5pbmRleCA9IHRoaXMucmVjb3Jkcy5wdXNoKHJlY29yZCkgLSAxCiAgICByZXR1cm4gcmVjb3JkCiAgfQoKICByZW1vdmUocmVjb3JkKSB7CiAgICBjb25zdCBwb3BwZWQgPSB0aGlzLnJlY29yZHMucG9wKCkKICAgIGlmIChwb3BwZWQgPT09IHJlY29yZCkgcmV0dXJuCiAgICB0aGlzLnJlY29yZHNbKHBvcHBlZC5pbmRleCA9IHJlY29yZC5pbmRleCldID0gcG9wcGVkCiAgfQoKICBhdHRhY2hBbGwoY29yZSkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnJlY29yZHMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcmVjb3JkID0gdGhpcy5yZWNvcmRzW2ldCiAgICAgIGNvbnN0IG11eGVyID0gcmVjb3JkLnN0cmVhbS5ub2lzZVN0cmVhbS51c2VyRGF0YQogICAgICBpZiAoIWNvcmUucmVwbGljYXRvci5hdHRhY2hlZChtdXhlcikpIGNvcmUucmVwbGljYXRvci5hdHRhY2hUbyhtdXhlcikKICAgIH0KICB9CgogIGRlc3Ryb3koKSB7CiAgICAvLyByZXZlcnNlIGlzIHNhZmVyIGNhdXNlIHdlIGRlbGV0ZSBtYgogICAgZm9yIChsZXQgaSA9IHRoaXMucmVjb3Jkcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCByZWNvcmQgPSB0aGlzLnJlY29yZHNbaV0KICAgICAgaWYgKCFyZWNvcmQuaXNFeHRlcm5hbCkgcmVjb3JkLnN0cmVhbS5kZXN0cm95KCkKICAgIH0KICB9Cn0KCmNsYXNzIFNlc3Npb25UcmFja2VyIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMubWFwID0gbmV3IE1hcCgpCiAgfQoKICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLm1hcC5zaXplCiAgfQoKICBnZXQoaWQpIHsKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5tYXAuZ2V0KGlkKQogICAgaWYgKGV4aXN0aW5nICE9PSB1bmRlZmluZWQpIHJldHVybiBleGlzdGluZwogICAgY29uc3QgZnJlc2ggPSBbXQogICAgdGhpcy5tYXAuc2V0KGlkLCBmcmVzaCkKICAgIHJldHVybiBmcmVzaAogIH0KCiAgZ2MoaWQpIHsKICAgIHRoaXMubWFwLmRlbGV0ZShpZCkKICB9CgogIGxpc3QoaWQpIHsKICAgIHJldHVybiBpZCA/IHRoaXMubWFwLmdldChpZCkgfHwgW10gOiBbLi4udGhpc10KICB9CgogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIGZvciAoY29uc3Qgc2Vzc2lvbnMgb2YgdGhpcy5tYXAudmFsdWVzKCkpIHsKICAgICAgeWllbGQqIHNlc3Npb25zW1N5bWJvbC5pdGVyYXRvcl0oKQogICAgfQogIH0KfQoKY2xhc3MgQ29yZVRyYWNrZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5tYXAgPSBuZXcgTWFwKCkKICAgIHRoaXMud2F0Y2hpbmcgPSBbXQoKICAgIHRoaXMuX2djaW5nID0gbmV3IFNldCgpCiAgICB0aGlzLl9nY0ludGVydmFsID0gbnVsbAogICAgdGhpcy5fZ2NDeWNsZUJvdW5kID0gdGhpcy5fZ2NDeWNsZS5iaW5kKHRoaXMpCiAgfQoKICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLm1hcC5zaXplCiAgfQoKICB3YXRjaChzdG9yZSkgewogICAgaWYgKHN0b3JlLndhdGNoSW5kZXggIT09IC0xKSByZXR1cm4KICAgIHN0b3JlLndhdGNoSW5kZXggPSB0aGlzLndhdGNoaW5nLnB1c2goc3RvcmUpIC0gMQogIH0KCiAgdW53YXRjaChzdG9yZSkgewogICAgaWYgKHN0b3JlLndhdGNoSW5kZXggPT09IC0xKSByZXR1cm4KICAgIGNvbnN0IGhlYWQgPSB0aGlzLndhdGNoaW5nLnBvcCgpCiAgICBpZiAoaGVhZCAhPT0gc3RvcmUpIHRoaXMud2F0Y2hpbmdbKGhlYWQud2F0Y2hJbmRleCA9IHN0b3JlLndhdGNoSW5kZXgpXSA9IGhlYWQKICAgIHN0b3JlLndhdGNoSW5kZXggPSAtMQogIH0KCiAgcmVzdW1lKGlkKSB7CiAgICBjb25zdCBjb3JlID0gdGhpcy5tYXAuZ2V0KGlkKQoKICAgIGlmICghY29yZSkgcmV0dXJuIG51bGwKCiAgICAvLyBzaWduYWwgYmFjayB0aGF0IHdlIGhhdmUgYSBjbG9zaW5nIG9uZSBzdG9yZWQKICAgIGlmIChjb3JlLmNsb3NpbmcpIHJldHVybiBjb3JlCgogICAgaWYgKGNvcmUuZ2MpIHsKICAgICAgdGhpcy5fZ2NpbmcuZGVsZXRlKGNvcmUpCiAgICAgIGlmICh0aGlzLl9nY2luZy5zaXplID09PSAwKSB0aGlzLl9zdG9wR0MoKQogICAgICBjb3JlLmdjID0gMAogICAgfQoKICAgIHJldHVybiBjb3JlCiAgfQoKICBvcGVuZWQoaWQpIHsKICAgIGNvbnN0IGNvcmUgPSB0aGlzLm1hcC5nZXQoaWQpCiAgICByZXR1cm4gISEoY29yZSAmJiBjb3JlLm9wZW5lZCAmJiAhY29yZS5jbG9zaW5nKQogIH0KCiAgZ2V0KGlkKSB7CiAgICAvLyB3ZSBhbGxvdyB5b3UgZG8gY2FsbCB0aGlzIGZyb20gdGhlIG91dHNpZGUsIHNvIHN1cHBvcnQgbm9ybWFsIGJ1ZmZlcnMgYWxzbwogICAgaWYgKGI0YS5pc0J1ZmZlcihpZCkpIGlkID0gYjRhLnRvU3RyaW5nKGlkLCAnaGV4JykKICAgIGNvbnN0IGNvcmUgPSB0aGlzLm1hcC5nZXQoaWQpCiAgICBpZiAoIWNvcmUgfHwgY29yZS5jbG9zaW5nKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIGNvcmUKICB9CgogIHNldChpZCwgY29yZSkgewogICAgdGhpcy5tYXAuc2V0KGlkLCBjb3JlKQogICAgaWYgKHRoaXMud2F0Y2hpbmcubGVuZ3RoID4gMCkgdGhpcy5fZW1pdChjb3JlKQogIH0KCiAgX2VtaXQoY29yZSkgewogICAgZm9yIChsZXQgaSA9IHRoaXMud2F0Y2hpbmcubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3Qgc3RvcmUgPSB0aGlzLndhdGNoaW5nW2ldCiAgICAgIGZvciAoY29uc3QgZm4gb2Ygc3RvcmUud2F0Y2hlcnMpIGZuKGNvcmUpCiAgICB9CiAgfQoKICBfZ2MoY29yZSkgewogICAgY29uc3QgaWQgPSB0b0hleChjb3JlLmRpc2NvdmVyeUtleSkKICAgIGlmICh0aGlzLm1hcC5nZXQoaWQpID09PSBjb3JlKSB0aGlzLm1hcC5kZWxldGUoaWQpCiAgfQoKICBfZ2NDeWNsZSgpIHsKICAgIGZvciAoY29uc3QgY29yZSBvZiB0aGlzLl9nY2luZykgewogICAgICBpZiAoKytjb3JlLmdjIDwgNCkgY29udGludWUKICAgICAgY29uc3QgZ2MgPSB0aGlzLl9nYy5iaW5kKHRoaXMsIGNvcmUpCiAgICAgIGNvcmUuY2xvc2UoKS50aGVuKGdjLCBnYykKICAgICAgdGhpcy5fZ2NpbmcuZGVsZXRlKGNvcmUpCiAgICB9CgogICAgaWYgKHRoaXMuX2djaW5nLnNpemUgPT09IDApIHRoaXMuX3N0b3BHQygpCiAgfQoKICBnYyhjb3JlKSB7CiAgICBjb3JlLmdjID0gMSAvLyBmaXJzdCBzdHJpa2UKICAgIHRoaXMuX2djaW5nLmFkZChjb3JlKQogICAgaWYgKHRoaXMuX2djaW5nLnNpemUgPT09IDEpIHRoaXMuX3N0YXJ0R0MoKQogIH0KCiAgX3N0b3BHQygpIHsKICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fZ2NJbnRlcnZhbCkKICAgIHRoaXMuX2djSW50ZXJ2YWwgPSBudWxsCiAgfQoKICBfc3RhcnRHQygpIHsKICAgIGlmICh0aGlzLl9nY0ludGVydmFsKSByZXR1cm4KICAgIHRoaXMuX2djSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLl9nY0N5Y2xlQm91bmQsIDIwMDApCiAgICBpZiAodGhpcy5fZ2NJbnRlcnZhbC51bnJlZikgdGhpcy5fZ2NJbnRlcnZhbC51bnJlZigpCiAgfQoKICBjbG9zZSgpIHsKICAgIHRoaXMuX3N0b3BHQygpCiAgICB0aGlzLl9nY2luZy5jbGVhcigpCgogICAgY29uc3QgYWxsID0gW10KICAgIGZvciAoY29uc3QgY29yZSBvZiB0aGlzLm1hcC52YWx1ZXMoKSkgewogICAgICBjb3JlLm9uaWRsZSA9IG5vb3AgLy8gbm8gcmVlbnRyeQogICAgICBhbGwucHVzaChjb3JlLmNsb3NlKCkpCiAgICB9CiAgICB0aGlzLm1hcC5jbGVhcigpCgogICAgcmV0dXJuIFByb21pc2UuYWxsKGFsbCkKICB9CgogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIGZvciAoY29uc3QgY29yZSBvZiB0aGlzLm1hcC52YWx1ZXMoKSkgewogICAgICBpZiAoIWNvcmUuY2xvc2luZykgeWllbGQgY29yZQogICAgfQogIH0KfQoKY2xhc3MgRmluZGluZ1BlZXJzIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuY291bnQgPSAwCiAgICB0aGlzLnBlbmRpbmcgPSBbXQogIH0KCiAgYWRkKGNvcmUpIHsKICAgIGlmICh0aGlzLmNvdW50ID09PSAwKSByZXR1cm4KICAgIHRoaXMucGVuZGluZy5wdXNoKGNvcmUuZmluZGluZ1BlZXJzKCkpCiAgfQoKICBpbmMoc2Vzc2lvbnMpIHsKICAgIGlmICgrK3RoaXMuY291bnQgIT09IDEpIHJldHVybgoKICAgIGZvciAoY29uc3QgY29yZSBvZiBzZXNzaW9ucykgewogICAgICB0aGlzLnBlbmRpbmcucHVzaChjb3JlLmZpbmRpbmdQZWVycygpKQogICAgfQogIH0KCiAgZGVjKHNlc3Npb25zKSB7CiAgICBpZiAoLS10aGlzLmNvdW50ICE9PSAwKSByZXR1cm4KICAgIHdoaWxlICh0aGlzLnBlbmRpbmcubGVuZ3RoID4gMCkgdGhpcy5wZW5kaW5nLnBvcCgpKCkKICB9Cn0KCmNsYXNzIENvcmVzdG9yZSBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yKHN0b3JhZ2UsIG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMucm9vdCA9IG9wdHMucm9vdCB8fCBudWxsCiAgICB0aGlzLnN0b3JhZ2UgPSB0aGlzLnJvb3QKICAgICAgPyB0aGlzLnJvb3Quc3RvcmFnZQogICAgICA6IEh5cGVyY29yZS5kZWZhdWx0U3RvcmFnZShzdG9yYWdlLCB7CiAgICAgICAgICBpZDogb3B0cy5pZCwKICAgICAgICAgIGFsbG93QmFja3VwOiBvcHRzLmFsbG93QmFja3VwLAogICAgICAgICAgcmVhZE9ubHk6IG9wdHMucmVhZE9ubHksCiAgICAgICAgICB3YWl0OiBvcHRzLndhaXQKICAgICAgICB9KQogICAgdGhpcy5zdHJlYW1UcmFja2VyID0gdGhpcy5yb290ID8gdGhpcy5yb290LnN0cmVhbVRyYWNrZXIgOiBuZXcgU3RyZWFtVHJhY2tlcigpCiAgICB0aGlzLmNvcmVzID0gdGhpcy5yb290ID8gdGhpcy5yb290LmNvcmVzIDogbmV3IENvcmVUcmFja2VyKCkKICAgIHRoaXMuc2Vzc2lvbnMgPSBuZXcgU2Vzc2lvblRyYWNrZXIoKQogICAgdGhpcy5jb3Jlc3RvcmVzID0gdGhpcy5yb290ID8gdGhpcy5yb290LmNvcmVzdG9yZXMgOiBuZXcgU2V0KCkKICAgIHRoaXMucmVhZE9ubHkgPSBvcHRzLndyaXRhYmxlID09PSBmYWxzZSB8fCAhIW9wdHMucmVhZE9ubHkKICAgIHRoaXMuZ2xvYmFsQ2FjaGUgPSB0aGlzLnJvb3QgPyB0aGlzLnJvb3QuZ2xvYmFsQ2FjaGUgOiBvcHRzLmdsb2JhbENhY2hlIHx8IG51bGwKICAgIHRoaXMucHJpbWFyeUtleSA9IHRoaXMucm9vdCA/IHRoaXMucm9vdC5wcmltYXJ5S2V5IDogb3B0cy5wcmltYXJ5S2V5IHx8IG51bGwKICAgIHRoaXMubnMgPSBvcHRzLm5hbWVzcGFjZSB8fCBERUZBVUxUX05BTUVTUEFDRQogICAgdGhpcy5tYW5pZmVzdFZlcnNpb24gPSBvcHRzLm1hbmlmZXN0VmVyc2lvbiB8fCAxCiAgICB0aGlzLnNob3VsZFN1c3BlbmQgPSBpc0FuZHJvaWQgPyAhIW9wdHMuc3VzcGVuZCA6IG9wdHMuc3VzcGVuZCAhPT0gZmFsc2UKICAgIHRoaXMuYWN0aXZlID0gb3B0cy5hY3RpdmUgIT09IGZhbHNlCgogICAgdGhpcy53YXRjaGVycyA9IG51bGwKICAgIHRoaXMud2F0Y2hJbmRleCA9IC0xCgogICAgdGhpcy5fZmluZGluZ1BlZXJzID0gbnVsbCAvLyBoZXJlIGZvciBsZWdhY3kKICAgIHRoaXMuX29uZ2NCb3VuZCA9IHRoaXMuX29uZ2MuYmluZCh0aGlzKQoKICAgIGlmIChvcHRzLnByaW1hcnlLZXkgJiYgIXRoaXMucm9vdCAmJiAhb3B0cy51bnNhZmUpIHsKICAgICAgdGhyb3cgQVNTRVJUSU9OKAogICAgICAgICdQYXNzaW5nIHRoZSBwcmltYXJ5IGtleSBpcyB1bnNhZmUgdW5sZXNzIHlvdSBrbm93IHdoYXQgeW91IGFyZSBkb2luZy4gU2V0IHVuc2FmZTogdHJ1ZSB0byBhY2tub3dsZWRnZSB0aGF0JwogICAgICApCiAgICB9CgogICAgaWYgKHRoaXMucm9vdCkgdGhpcy5jb3Jlc3RvcmVzLmFkZCh0aGlzKQoKICAgIHRoaXMucmVhZHkoKS5jYXRjaChub29wKQogIH0KCiAgd2F0Y2goZm4pIHsKICAgIGlmICh0aGlzLndhdGNoZXJzID09PSBudWxsKSB7CiAgICAgIHRoaXMud2F0Y2hlcnMgPSBuZXcgU2V0KCkKICAgICAgdGhpcy5jb3Jlcy53YXRjaCh0aGlzKQogICAgfQoKICAgIHRoaXMud2F0Y2hlcnMuYWRkKGZuKQogIH0KCiAgdW53YXRjaChmbikgewogICAgaWYgKHRoaXMud2F0Y2hlcnMgPT09IG51bGwpIHJldHVybgoKICAgIHRoaXMud2F0Y2hlcnMuZGVsZXRlKGZuKQoKICAgIGlmICh0aGlzLndhdGNoZXJzLnNpemUgPT09IDApIHsKICAgICAgdGhpcy53YXRjaGVycyA9IG51bGwKICAgICAgdGhpcy5jb3Jlcy51bndhdGNoKHRoaXMpCiAgICB9CiAgfQoKICBmaW5kaW5nUGVlcnMoKSB7CiAgICBpZiAodGhpcy5fZmluZGluZ1BlZXJzID09PSBudWxsKSB0aGlzLl9maW5kaW5nUGVlcnMgPSBuZXcgRmluZGluZ1BlZXJzKCkKICAgIHRoaXMuX2ZpbmRpbmdQZWVycy5pbmModGhpcy5zZXNzaW9ucykKICAgIGxldCBkb25lID0gZmFsc2UKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChkb25lKSByZXR1cm4KICAgICAgZG9uZSA9IHRydWUKICAgICAgdGhpcy5fZmluZGluZ1BlZXJzLmRlYyh0aGlzLnNlc3Npb25zKQogICAgfQogIH0KCiAgYXVkaXQob3B0cyA9IHt9KSB7CiAgICByZXR1cm4gYXVkaXRTdG9yZSh0aGlzLCBvcHRzKQogIH0KCiAgYXN5bmMgc3VzcGVuZCh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICBhd2FpdCBsb2coJ0ZsdXNoaW5nIGRiLi4uJykKICAgIC8vIElmIHJlYWRPbmx5IHdlIGRvbid0IG5lZWQgdG8gZmx1c2gKICAgIGlmICghdGhpcy5zdG9yYWdlLnJlYWRPbmx5KSBhd2FpdCB0aGlzLnN0b3JhZ2UuZGIuZmx1c2goKQogICAgaWYgKCF0aGlzLnNob3VsZFN1c3BlbmQpIHJldHVybgogICAgYXdhaXQgbG9nKCdTdXNwZW5kaW5nIGRiLi4uJykKICAgIGF3YWl0IHRoaXMuc3RvcmFnZS5zdXNwZW5kKCkKICB9CgogIHJlc3VtZSgpIHsKICAgIHJldHVybiB0aGlzLnN0b3JhZ2UucmVzdW1lKCkKICB9CgogIHNlc3Npb24ob3B0cykgewogICAgdGhpcy5fbWF5YmVDbG9zZWQoKQogICAgY29uc3Qgcm9vdCA9IHRoaXMucm9vdCB8fCB0aGlzCiAgICByZXR1cm4gbmV3IENvcmVzdG9yZShudWxsLCB7CiAgICAgIG1hbmlmZXN0VmVyc2lvbjogdGhpcy5tYW5pZmVzdFZlcnNpb24sCiAgICAgIC4uLm9wdHMsCiAgICAgIHJvb3QKICAgIH0pCiAgfQoKICBuYW1lc3BhY2UobmFtZSwgb3B0cykgewogICAgcmV0dXJuIHRoaXMuc2Vzc2lvbih7CiAgICAgIC4uLm9wdHMsCiAgICAgIG5hbWVzcGFjZTogZ2VuZXJhdGVOYW1lc3BhY2UodGhpcy5ucywgbmFtZSkKICAgIH0pCiAgfQoKICBsaXN0KG5hbWVzcGFjZSkgewogICAgcmV0dXJuIHRoaXMuc3RvcmFnZS5jcmVhdGVEaXNjb3ZlcnlLZXlTdHJlYW0obmFtZXNwYWNlKQogIH0KCiAgZ2V0QXV0aChkaXNjb3ZlcnlLZXkpIHsKICAgIHJldHVybiB0aGlzLnN0b3JhZ2UuZ2V0QXV0aChkaXNjb3ZlcnlLZXkpCiAgfQoKICBfb25nYyhzZXNzaW9uKSB7CiAgICBpZiAoc2Vzc2lvbi5zZXNzaW9ucy5sZW5ndGggPT09IDApIHRoaXMuc2Vzc2lvbnMuZ2Moc2Vzc2lvbi5pZCkKICB9CgogIGFzeW5jIF9nZXRPclNldFNlZWQoKSB7CiAgICBjb25zdCBzZWVkID0gYXdhaXQgdGhpcy5zdG9yYWdlLmdldFNlZWQoKQogICAgaWYgKHNlZWQgIT09IG51bGwpIHJldHVybiBzZWVkCiAgICByZXR1cm4gYXdhaXQgdGhpcy5zdG9yYWdlLnNldFNlZWQodGhpcy5wcmltYXJ5S2V5IHx8IGNyeXB0by5yYW5kb21CeXRlcygzMikpCiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIGlmICh0aGlzLnJvb3QgIT09IG51bGwpIHsKICAgICAgaWYgKHRoaXMucm9vdC5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJvb3QucmVhZHkoKQogICAgICB0aGlzLnByaW1hcnlLZXkgPSB0aGlzLnJvb3QucHJpbWFyeUtleQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBwcmltYXJ5S2V5ID0gYXdhaXQgdGhpcy5fZ2V0T3JTZXRTZWVkKCkKCiAgICBpZiAodGhpcy5wcmltYXJ5S2V5ID09PSBudWxsKSB7CiAgICAgIHRoaXMucHJpbWFyeUtleSA9IHByaW1hcnlLZXkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKCFiNGEuZXF1YWxzKHByaW1hcnlLZXksIHRoaXMucHJpbWFyeUtleSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdBbm90aGVyIGNvcmVzdG9yZSBpcyBzdG9yZWQgaGVyZScpCiAgICB9CiAgfQoKICBhc3luYyBfY2xvc2UoKSB7CiAgICBjb25zdCBjbG9zaW5nID0gW10KICAgIGNvbnN0IGhhbmdpbmcgPSBbLi4udGhpcy5zZXNzaW9uc10KICAgIGZvciAoY29uc3Qgc2VzcyBvZiBoYW5naW5nKSBjbG9zaW5nLnB1c2goc2Vzcy5jbG9zZSgpKQoKICAgIGlmICh0aGlzLndhdGNoZXJzICE9PSBudWxsKSB0aGlzLmNvcmVzLnVud2F0Y2godGhpcykKCiAgICBpZiAodGhpcy5yb290ICE9PSBudWxsKSB7CiAgICAgIGF3YWl0IFByb21pc2UuYWxsKGNsb3NpbmcpCiAgICAgIHJldHVybgogICAgfQoKICAgIGZvciAoY29uc3Qgc3RvcmUgb2YgdGhpcy5jb3Jlc3RvcmVzKSB7CiAgICAgIGNsb3NpbmcucHVzaChzdG9yZS5jbG9zZSgpKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsKGNsb3NpbmcpCgogICAgYXdhaXQgdGhpcy5jb3Jlcy5jbG9zZSgpCiAgICBhd2FpdCB0aGlzLnN0b3JhZ2UuY2xvc2UoKQogIH0KCiAgYXN5bmMgX2F0dGFjaE1heWJlKG11eGVyLCBkaXNjb3ZlcnlLZXkpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKAogICAgICAhdGhpcy5jb3Jlcy5vcGVuZWQodG9IZXgoZGlzY292ZXJ5S2V5KSkgJiYKICAgICAgIShhd2FpdCB0aGlzLnN0b3JhZ2UuaGFzQ29yZShkaXNjb3ZlcnlLZXksIHsgaWZNaWdyYXRlZDogdHJ1ZSB9KSkKICAgICkKICAgICAgcmV0dXJuCiAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4KCiAgICBjb25zdCBjb3JlID0gdGhpcy5fb3BlbkNvcmUoZGlzY292ZXJ5S2V5LCB7IGNyZWF0ZUlmTWlzc2luZzogZmFsc2UgfSkKCiAgICBpZiAoIWNvcmUpIHJldHVybgogICAgaWYgKCFjb3JlLm9wZW5lZCkgYXdhaXQgY29yZS5yZWFkeSgpCgogICAgaWYgKCFjb3JlLnJlcGxpY2F0b3IuYXR0YWNoZWQobXV4ZXIpKSB7CiAgICAgIGNvcmUucmVwbGljYXRvci5hdHRhY2hUbyhtdXhlcikKICAgIH0KCiAgICBjb3JlLmNoZWNrSWZJZGxlKCkKICB9CgogIF9zaG91bGRSZXBsaWNhdGUoY29yZSwgbXV4ZXIpIHsKICAgIHJldHVybiAoCiAgICAgIGNvcmUucmVwbGljYXRvci5kb3dubG9hZGluZyAmJiAhY29yZS5yZXBsaWNhdG9yLmF0dGFjaGVkKG11eGVyKSAmJiBjb3JlLm9wZW5lZCAmJiB0aGlzLmFjdGl2ZQogICAgKQogIH0KCiAgcmVwbGljYXRlKGlzSW5pdGlhdG9yLCBvcHRzKSB7CiAgICB0aGlzLl9tYXliZUNsb3NlZCgpCgogICAgY29uc3QgaXNFeHRlcm5hbCA9IGlzU3RyZWFtKGlzSW5pdGlhdG9yKQogICAgY29uc3Qgc3RyZWFtID0gSHlwZXJjb3JlLmNyZWF0ZVByb3RvY29sU3RyZWFtKGlzSW5pdGlhdG9yLCB7CiAgICAgIC4uLm9wdHMsCiAgICAgIG9uZGlzY292ZXJ5a2V5OiAoZGlzY292ZXJ5S2V5KSA9PiB7CiAgICAgICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuCiAgICAgICAgY29uc3QgbXV4ZXIgPSBzdHJlYW0ubm9pc2VTdHJlYW0udXNlckRhdGEKICAgICAgICByZXR1cm4gdGhpcy5fYXR0YWNoTWF5YmUobXV4ZXIsIGRpc2NvdmVyeUtleSkKICAgICAgfQogICAgfSkKCiAgICBpZiAodGhpcy5jb3Jlcy5zaXplID4gMCkgewogICAgICBjb25zdCBtdXhlciA9IHN0cmVhbS5ub2lzZVN0cmVhbS51c2VyRGF0YQogICAgICBjb25zdCB1bmNvcmsgPSBtdXhlci51bmNvcmsuYmluZChtdXhlcikKICAgICAgbXV4ZXIuY29yaygpCgogICAgICBmb3IgKGNvbnN0IGNvcmUgb2YgdGhpcy5jb3JlcykgewogICAgICAgIGlmICghdGhpcy5fc2hvdWxkUmVwbGljYXRlKGNvcmUsIG11eGVyKSkgewogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgICAgY29yZS5yZXBsaWNhdG9yLmF0dGFjaFRvKG11eGVyKQogICAgICB9CgogICAgICBzdHJlYW0ubm9pc2VTdHJlYW0ub3BlbmVkLnRoZW4odW5jb3JrKQogICAgfQoKICAgIGNvbnN0IHJlY29yZCA9IHRoaXMuc3RyZWFtVHJhY2tlci5hZGQoc3RyZWFtLCBpc0V4dGVybmFsKQogICAgc3RyZWFtLm9uY2UoJ2Nsb3NlJywgKCkgPT4gdGhpcy5zdHJlYW1UcmFja2VyLnJlbW92ZShyZWNvcmQpKQogICAgcmV0dXJuIHN0cmVhbQogIH0KCiAgX21heWJlQ2xvc2VkKCkgewogICAgaWYgKHRoaXMuY2xvc2luZyB8fCAodGhpcy5yb290ICE9PSBudWxsICYmIHRoaXMucm9vdC5jbG9zaW5nKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvcmVzdG9yZSBpcyBjbG9zZWQnKQogICAgfQogIH0KCiAgYXN5bmMgc3RhdGljaWZ5KGNvcmUsIG9wdHMpIHsKICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKCFjb3JlLm9wZW5lZCkgYXdhaXQgY29yZS5yZWFkeSgpCgogICAgY29uc3QgcnggPSBjb3JlLnN0YXRlLnN0b3JhZ2UucmVhZCgpCgogICAgY29uc3QgaGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKICAgIGNvbnN0IGF1dGhQcm9taXNlID0gcnguZ2V0QXV0aCgpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IFtoZWFkLCBhdXRoXSA9IGF3YWl0IFByb21pc2UuYWxsKFtoZWFkUHJvbWlzZSwgYXV0aFByb21pc2VdKQogICAgaWYgKCFoZWFkIHx8IGhlYWQubGVuZ3RoID09PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ0NvcmUgbXVzdCBoYXZlIGRhdGEnKQoKICAgIGNvbnN0IHByb2xvZ3VlID0gewogICAgICBsZW5ndGg6IGhlYWQubGVuZ3RoLAogICAgICBoYXNoOiBoZWFkLnJvb3RIYXNoCiAgICB9CgogICAgY29uc3QgbWFuaWZlc3QgPSB7CiAgICAgIHZlcnNpb246IDEsCiAgICAgIGhhc2g6IGF1dGgubWFuaWZlc3QuaGFzaCwKICAgICAgcXVvcnVtOiAwLAogICAgICBzaWduZXJzOiBbXSwKICAgICAgcHJvbG9ndWUKICAgIH0KCiAgICBjb25zdCBjID0gewogICAgICBrZXk6IG51bGwsCiAgICAgIGRpc2NvdmVyeUtleTogbnVsbCwKICAgICAgbWFuaWZlc3QsCiAgICAgIGNvcmU6IGNvcmUuc3RhdGUuc3RvcmFnZS5jb3JlCiAgICB9CgogICAgYy5rZXkgPSBIeXBlcmNvcmUua2V5KGMubWFuaWZlc3QpCiAgICBjLmRpc2NvdmVyeUtleSA9IEh5cGVyY29yZS5kaXNjb3ZlcnlLZXkoYy5rZXkpCgogICAgYXdhaXQgdGhpcy5zdG9yYWdlLmNyZWF0ZUNvcmUoYykKCiAgICBjb25zdCBzdGF0aWNDb3JlID0gdGhpcy5nZXQoeyAuLi5vcHRzLCBrZXk6IGMua2V5IH0pCiAgICBhd2FpdCBzdGF0aWNDb3JlLnJlYWR5KCkKICAgIHJldHVybiBzdGF0aWNDb3JlCiAgfQoKICBnZXQob3B0cykgewogICAgdGhpcy5fbWF5YmVDbG9zZWQoKQoKICAgIGlmIChiNGEuaXNCdWZmZXIob3B0cykgfHwgdHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBrZXk6IG9wdHMgfQogICAgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgICBjb25zdCBjb25mID0gewogICAgICBwcmVsb2FkOiBudWxsLAogICAgICBzZXNzaW9uczogbnVsbCwKICAgICAgb25nYzogbnVsbCwKICAgICAgY29yZTogbnVsbCwKICAgICAgYWN0aXZlOiBvcHRzLmFjdGl2ZSAhPT0gZmFsc2UsCiAgICAgIGVuY3J5cHRpb246IG9wdHMuZW5jcnlwdGlvbiB8fCBudWxsLAogICAgICBlbmNyeXB0aW9uS2V5OiBvcHRzLmVuY3J5cHRpb25LZXkgfHwgbnVsbCwgLy8gYmFjayBjb21wYXQsIHNob3VsZCByZW1vdmUKICAgICAgaXNCbG9ja0tleTogISFvcHRzLmlzQmxvY2tLZXksIC8vIGJhY2sgY29tcGF0LCBzaG91bGQgcmVtb3ZlCiAgICAgIHZhbHVlRW5jb2Rpbmc6IG9wdHMudmFsdWVFbmNvZGluZyB8fCBudWxsLAogICAgICBleGNsdXNpdmU6ICEhb3B0cy5leGNsdXNpdmUsCiAgICAgIG1hbmlmZXN0OiBvcHRzLm1hbmlmZXN0IHx8IG51bGwsCiAgICAgIGtleVBhaXI6IG9wdHMua2V5UGFpciB8fCBudWxsLAogICAgICBvbndhaXQ6IG9wdHMub253YWl0IHx8IG51bGwsCiAgICAgIHdhaXQ6IG9wdHMud2FpdCAhPT0gZmFsc2UsCiAgICAgIHRpbWVvdXQ6IG9wdHMudGltZW91dCB8fCAwLAogICAgICBkcmFmdDogISFvcHRzLmRyYWZ0LAogICAgICB3cml0YWJsZTogb3B0cy53cml0YWJsZSA9PT0gdW5kZWZpbmVkICYmIHRoaXMucmVhZE9ubHkgPyBmYWxzZSA6IG9wdHMud3JpdGFibGUKICAgIH0KCiAgICAvLyBuYW1lIHJlcXVpcmVzIHVzIHRvIHJ0IHRvIHN0b3JhZ2UgKyByZWFkeSwgc28gbmVlZHMgcHJlbG9hZAogICAgLy8gc2FtZSBnb2VzIGlmIHVzZXIgaGFzIGRlZmluZWQgYXN5bmMgcHJlbG9hZCBvYnZzCiAgICBpZiAob3B0cy5uYW1lIHx8IG9wdHMucHJlbG9hZCkgewogICAgICBjb25mLnByZWxvYWQgPSB0aGlzLl9wcmVsb2FkKG9wdHMpCiAgICAgIHJldHVybiB0aGlzLl9tYWtlU2Vzc2lvbihjb25mKQogICAgfQoKICAgIGlmIChvcHRzLmRpc2NvdmVyeUtleSAmJiAhb3B0cy5rZXkgJiYgIW9wdHMubWFuaWZlc3QpIHsKICAgICAgY29uZi5wcmVsb2FkID0gdGhpcy5fcHJlbG9hZENoZWNrSWZFeGlzdHMob3B0cykKICAgICAgcmV0dXJuIHRoaXMuX21ha2VTZXNzaW9uKGNvbmYpCiAgICB9CgogICAgLy8gaWYgbm90IG5vdCB3ZSBjYW4gc3luYyBjcmVhdGUgaXQsIHdoaWNoIGp1c3QgaXMgZWFzaWVyIGZvciB0aGUKICAgIC8vIHVwc3RyZWFtIHVzZXIgaW4gdGVybXMgb2YgZ3VhcmFudGVlcyAoa2V5IGlzIHRoZXJlIGV0YyBldGMpCiAgICBjb25zdCBjb3JlID0gdGhpcy5fb3BlbkNvcmUobnVsbCwgb3B0cykKCiAgICBjb25mLmNvcmUgPSBjb3JlCiAgICBjb25mLnNlc3Npb25zID0gdGhpcy5zZXNzaW9ucy5nZXQoY29yZS5pZCkKICAgIGNvbmYub25nYyA9IHRoaXMuX29uZ2NCb3VuZAoKICAgIHJldHVybiB0aGlzLl9tYWtlU2Vzc2lvbihjb25mKQogIH0KCiAgX21ha2VTZXNzaW9uKGNvbmYpIHsKICAgIGNvbnN0IHNlc3Npb24gPSBuZXcgSHlwZXJjb3JlKG51bGwsIG51bGwsIGNvbmYpCiAgICBpZiAodGhpcy5fZmluZGluZ1BlZXJzICE9PSBudWxsKSB0aGlzLl9maW5kaW5nUGVlcnMuYWRkKHNlc3Npb24pCiAgICByZXR1cm4gc2Vzc2lvbgogIH0KCiAgYXN5bmMgY3JlYXRlS2V5UGFpcihuYW1lLCBucyA9IHRoaXMubnMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgcmV0dXJuIGNyZWF0ZUtleVBhaXIodGhpcy5wcmltYXJ5S2V5LCBucywgbmFtZSkKICB9CgogIGFzeW5jIF9wcmVsb2FkQ2hlY2tJZkV4aXN0cyhvcHRzKSB7CiAgICBjb25zdCBoYXMgPSBhd2FpdCB0aGlzLnN0b3JhZ2UuaGFzQ29yZShvcHRzLmRpc2NvdmVyeUtleSkKICAgIGlmICghaGFzKSB0aHJvdyBTVE9SQUdFX0VNUFRZKCdObyBIeXBlcmNvcmUgaXMgc3RvcmVkIGhlcmUnKQogICAgcmV0dXJuIHRoaXMuX3ByZWxvYWQob3B0cykKICB9CgogIGFzeW5jIF9wcmVsb2FkKG9wdHMpIHsKICAgIGlmIChvcHRzLnByZWxvYWQpIG9wdHMgPSB7IC4uLm9wdHMsIC4uLihhd2FpdCBvcHRzLnByZWxvYWQpIH0KICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIGNvbnN0IGRpc2NvdmVyeUtleSA9IG9wdHMubmFtZQogICAgICA/IGF3YWl0IHRoaXMuc3RvcmFnZS5nZXRBbGlhcyh7IG5hbWU6IG9wdHMubmFtZSwgbmFtZXNwYWNlOiB0aGlzLm5zIH0pCiAgICAgIDogbnVsbAogICAgdGhpcy5fbWF5YmVDbG9zZWQoKQoKICAgIGNvbnN0IGNvcmUgPSB0aGlzLl9vcGVuQ29yZShkaXNjb3ZlcnlLZXksIG9wdHMpCgogICAgcmV0dXJuIHsKICAgICAgY29yZSwKICAgICAgc2Vzc2lvbnM6IHRoaXMuc2Vzc2lvbnMuZ2V0KGNvcmUuaWQpLAogICAgICBvbmdjOiB0aGlzLl9vbmdjQm91bmQsCiAgICAgIGVuY3J5cHRpb246IG9wdHMuZW5jcnlwdGlvbiB8fCBudWxsLAogICAgICBlbmNyeXB0aW9uS2V5OiBvcHRzLmVuY3J5cHRpb25LZXkgfHwgbnVsbCwgLy8gYmFjayBjb21wYXQsIHNob3VsZCByZW1vdmUKICAgICAgaXNCbG9ja0tleTogISFvcHRzLmlzQmxvY2tLZXkgLy8gYmFjayBjb21wYXQsIHNob3VsZCByZW1vdmUKICAgIH0KICB9CgogIF9hdXRoKGRpc2NvdmVyeUtleSwgb3B0cykgewogICAgY29uc3QgcmVzdWx0ID0gewogICAgICBrZXlQYWlyOiBudWxsLAogICAgICBrZXk6IG51bGwsCiAgICAgIGRpc2NvdmVyeUtleSwKICAgICAgbWFuaWZlc3Q6IG51bGwKICAgIH0KCiAgICBpZiAob3B0cy5uYW1lKSB7CiAgICAgIHJlc3VsdC5rZXlQYWlyID0gY3JlYXRlS2V5UGFpcih0aGlzLnByaW1hcnlLZXksIHRoaXMubnMsIG9wdHMubmFtZSkKICAgIH0gZWxzZSBpZiAob3B0cy5rZXlQYWlyKSB7CiAgICAgIHJlc3VsdC5rZXlQYWlyID0gb3B0cy5rZXlQYWlyCiAgICB9CgogICAgaWYgKG9wdHMubWFuaWZlc3QpIHsKICAgICAgcmVzdWx0Lm1hbmlmZXN0ID0gb3B0cy5tYW5pZmVzdAogICAgfSBlbHNlIGlmIChyZXN1bHQua2V5UGFpciAmJiAhcmVzdWx0LmRpc2NvdmVyeUtleSkgewogICAgICByZXN1bHQubWFuaWZlc3QgPSB7CiAgICAgICAgdmVyc2lvbjogdGhpcy5tYW5pZmVzdFZlcnNpb24sCiAgICAgICAgc2lnbmVyczogW3sgcHVibGljS2V5OiByZXN1bHQua2V5UGFpci5wdWJsaWNLZXkgfV0KICAgICAgfQogICAgfQoKICAgIGlmIChvcHRzLmtleSkgcmVzdWx0LmtleSA9IElELmRlY29kZShvcHRzLmtleSkKICAgIGVsc2UgaWYgKHJlc3VsdC5tYW5pZmVzdCkgcmVzdWx0LmtleSA9IEh5cGVyY29yZS5rZXkocmVzdWx0Lm1hbmlmZXN0KQoKICAgIGlmIChyZXN1bHQuZGlzY292ZXJ5S2V5KSByZXR1cm4gcmVzdWx0CgogICAgaWYgKG9wdHMuZGlzY292ZXJ5S2V5KSByZXN1bHQuZGlzY292ZXJ5S2V5ID0gSUQuZGVjb2RlKG9wdHMuZGlzY292ZXJ5S2V5KQogICAgZWxzZSBpZiAocmVzdWx0LmtleSkgcmVzdWx0LmRpc2NvdmVyeUtleSA9IGNyeXB0by5kaXNjb3ZlcnlLZXkocmVzdWx0LmtleSkKICAgIGVsc2UgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZGVyaXZlIGRpc2NvdmVyeSBmcm9tIGlucHV0JykKCiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICBfb3BlbkNvcmUoZGlzY292ZXJ5S2V5LCBvcHRzKSB7CiAgICBjb25zdCBhdXRoID0gdGhpcy5fYXV0aChkaXNjb3ZlcnlLZXksIG9wdHMpCgogICAgY29uc3QgaWQgPSB0b0hleChhdXRoLmRpc2NvdmVyeUtleSkKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5jb3Jlcy5yZXN1bWUoaWQpCiAgICBpZiAoZXhpc3RpbmcgJiYgIWV4aXN0aW5nLmNsb3NpbmcpIHJldHVybiBleGlzdGluZwoKICAgIGNvbnN0IGNvcmUgPSBIeXBlcmNvcmUuY3JlYXRlQ29yZSh0aGlzLnN0b3JhZ2UsIHsKICAgICAgcHJlb3BlbjogZXhpc3RpbmcgJiYgZXhpc3Rpbmcub3BlbmVkID8gZXhpc3RpbmcuY2xvc2luZyA6IG51bGwsIC8vIGFsd2F5cyB3YWl0IGZvciB0aGUgcHJldiBvbmUgdG8gY2xvc2UgZmlyc3QgaW4gYW55IGNhc2UuLi4KICAgICAgZWFnZXJVcGdyYWRlOiB0cnVlLAogICAgICBub3REb3dubG9hZGluZ0xpbmdlcjogb3B0cy5ub3REb3dubG9hZGluZ0xpbmdlciwKICAgICAgYWxsb3dGb3JrOiBvcHRzLmFsbG93Rm9yayAhPT0gZmFsc2UsCiAgICAgIGluZmxpZ2h0UmFuZ2U6IG9wdHMuaW5mbGlnaHRSYW5nZSwKICAgICAgY29tcGF0OiBmYWxzZSwgLy8gbm8gY29tcGF0IGZvciBub3cgOikKICAgICAgZm9yY2U6IG9wdHMuZm9yY2UsCiAgICAgIGNyZWF0ZUlmTWlzc2luZzogb3B0cy5jcmVhdGVJZk1pc3NpbmcsCiAgICAgIGRpc2NvdmVyeUtleTogYXV0aC5kaXNjb3ZlcnlLZXksCiAgICAgIG92ZXJ3cml0ZTogb3B0cy5vdmVyd3JpdGUsCiAgICAgIGtleTogYXV0aC5rZXksCiAgICAgIGtleVBhaXI6IGF1dGgua2V5UGFpciwKICAgICAgbGVnYWN5OiBvcHRzLmxlZ2FjeSwKICAgICAgbWFuaWZlc3Q6IGF1dGgubWFuaWZlc3QsCiAgICAgIGdsb2JhbENhY2hlOiBvcHRzLmdsb2JhbENhY2hlIHx8IHRoaXMuZ2xvYmFsQ2FjaGUgfHwgbnVsbCwKICAgICAgYWxpYXM6IG9wdHMubmFtZSA/IHsgbmFtZTogb3B0cy5uYW1lLCBuYW1lc3BhY2U6IHRoaXMubnMgfSA6IG51bGwKICAgIH0pCgogICAgY29yZS5vbmlkbGUgPSAoKSA9PiB7CiAgICAgIHRoaXMuY29yZXMuZ2MoY29yZSkKICAgIH0KCiAgICBjb3JlLnJlcGxpY2F0b3Iub25kb3dubG9hZGluZyA9ICgpID0+IHsKICAgICAgaWYgKHRoaXMuYWN0aXZlKSB0aGlzLnN0cmVhbVRyYWNrZXIuYXR0YWNoQWxsKGNvcmUpCiAgICB9CgogICAgdGhpcy5jb3Jlcy5zZXQoaWQsIGNvcmUpCiAgICByZXR1cm4gY29yZQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBDb3Jlc3RvcmUKCmZ1bmN0aW9uIGlzU3RyZWFtKHMpIHsKICByZXR1cm4gdHlwZW9mIHMgPT09ICdvYmplY3QnICYmIHMgJiYgdHlwZW9mIHMucGlwZSA9PT0gJ2Z1bmN0aW9uJwp9CgpmdW5jdGlvbiBnZW5lcmF0ZU5hbWVzcGFjZShuYW1lc3BhY2UsIG5hbWUpIHsKICBpZiAoIWI0YS5pc0J1ZmZlcihuYW1lKSkgbmFtZSA9IGI0YS5mcm9tKG5hbWUpCiAgY29uc3Qgb3V0ID0gYjRhLmFsbG9jVW5zYWZlU2xvdygzMikKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKG91dCwgW25hbWVzcGFjZSwgbmFtZV0pCiAgcmV0dXJuIG91dAp9CgpmdW5jdGlvbiBkZXJpdmVTZWVkKHByaW1hcnlLZXksIG5hbWVzcGFjZSwgbmFtZSkgewogIGlmICghYjRhLmlzQnVmZmVyKG5hbWUpKSBuYW1lID0gYjRhLmZyb20obmFtZSkKICBjb25zdCBvdXQgPSBiNGEuYWxsb2MoMzIpCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChvdXQsIFtOUywgbmFtZXNwYWNlLCBuYW1lXSwgcHJpbWFyeUtleSkKICByZXR1cm4gb3V0Cn0KCmZ1bmN0aW9uIGNyZWF0ZUtleVBhaXIocHJpbWFyeUtleSwgbmFtZXNwYWNlLCBuYW1lKSB7CiAgY29uc3Qgc2VlZCA9IGRlcml2ZVNlZWQocHJpbWFyeUtleSwgbmFtZXNwYWNlLCBuYW1lKQogIGNvbnN0IGJ1ZiA9IGI0YS5hbGxvYyhzb2RpdW0uY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMgKyBzb2RpdW0uY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMpCiAgY29uc3Qga2V5UGFpciA9IHsKICAgIHB1YmxpY0tleTogYnVmLnN1YmFycmF5KDAsIHNvZGl1bS5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUyksCiAgICBzZWNyZXRLZXk6IGJ1Zi5zdWJhcnJheShzb2RpdW0uY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgfQogIHNvZGl1bS5jcnlwdG9fc2lnbl9zZWVkX2tleXBhaXIoa2V5UGFpci5wdWJsaWNLZXksIGtleVBhaXIuc2VjcmV0S2V5LCBzZWVkKQogIHJldHVybiBrZXlQYWlyCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gdG9IZXgoZGlzY292ZXJ5S2V5KSB7CiAgcmV0dXJuIGI0YS50b1N0cmluZyhkaXNjb3ZlcnlLZXksICdoZXgnKQp9Cm1vZHVsZS5leHBvcnRzID0gYXN5bmMgZnVuY3Rpb24qIGF1ZGl0KHN0b3JlLCB7IGRyeVJ1biA9IGZhbHNlIH0gPSB7fSkgewogIGZvciBhd2FpdCAoY29uc3QgeyBkaXNjb3ZlcnlLZXksIGNvcmUgfSBvZiBzdG9yZS5zdG9yYWdlLmNyZWF0ZUNvcmVTdHJlYW0oKSkgewogICAgaWYgKGNvcmUudmVyc2lvbiA8IDEpIGNvbnRpbnVlIC8vIG5vdCBtaWdyYXRlZCwgaWdub3JlCgogICAgY29uc3QgYyA9IHN0b3JlLmdldCh7IGRpc2NvdmVyeUtleSwgYWN0aXZlOiBmYWxzZSB9KQogICAgYXdhaXQgYy5yZWFkeSgpCgogICAgeWllbGQgeyBkaXNjb3ZlcnlLZXksIGtleTogYy5rZXksIGF1ZGl0OiBhd2FpdCBjLmNvcmUuYXVkaXQoeyBkcnlSdW4gfSkgfQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IGMuY2xvc2UoKQogICAgfSBjYXRjaCB7CiAgICAgIC8vIGlnbm9yZSBpZiBmYWlsZWQsIHdlIGFyZSBhdWRpdGluZy4uLgogICAgfQogIH0KfQp7CiAgIm5hbWUiOiAiY29yZXN0b3JlIiwKICAidmVyc2lvbiI6ICI3LjcuMCIsCiAgImRlc2NyaXB0aW9uIjogIkEgSHlwZXJjb3JlIGZhY3RvcnkgdGhhdCBzaW1wbGlmaWVzIG1hbmFnaW5nIGNvbGxlY3Rpb25zIG9mIGNvcmVzLiIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibGliLyoiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjciLAogICAgImh5cGVyY29yZSI6ICJeMTEuMTkuMCIsCiAgICAiaHlwZXJjb3JlLWNyeXB0byI6ICJeMy40LjIiLAogICAgImh5cGVyY29yZS1lcnJvcnMiOiAiXjEuNC4wIiwKICAgICJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiAiXjEuMy4wIiwKICAgICJyZWFkeS1yZXNvdXJjZSI6ICJeMS4xLjEiLAogICAgInNvZGl1bS11bml2ZXJzYWwiOiAiXjUuMC4xIiwKICAgICJ3aGljaC1ydW50aW1lIjogIl4xLjIuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy43LjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiLAogICAgInJhY2hlIjogIl4xLjAuMCIsCiAgICAidGVzdC10bXAiOiAiXjEuMy4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAidGVzdCI6ICJwcmV0dGllciAtLWNoZWNrIC4gJiYgYnJpdHRsZSB0ZXN0LyouanMiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QvYmFzaWMuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9jb3Jlc3RvcmUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2ggSW5jIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vY29yZXN0b3JlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vY29yZXN0b3JlIgp9Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gZGVib3VuY2UgKHdvcmtlciwgY29udGV4dCA9IG51bGwpIHsKICBkZWJvdW5jZWQucnVubmluZyA9IG51bGwKICByZXR1cm4gZGVib3VuY2VkCgogIGFzeW5jIGZ1bmN0aW9uIGRlYm91bmNlZCAoKSB7CiAgICBpZiAoZGVib3VuY2VkLnJ1bm5pbmcgIT09IG51bGwpIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCBkZWJvdW5jZWQucnVubmluZwogICAgICB9IGNhdGNoIChfKSB7CiAgICAgICAgLy8gaWdub3JlIC0gZG8gbm90IGZhaWwgb24gb2xkIGVycm9ycwogICAgICB9CiAgICB9CgogICAgLy8gYW5vdGhlciAidGhyZWFkIiBiZWF0IHVzIHRvIGl0LCBqdXN0IHBpZ2d5IHBhY2sgb24gdGhhdCBvbmUKICAgIGlmIChkZWJvdW5jZWQucnVubmluZyAhPT0gbnVsbCkgcmV0dXJuIGRlYm91bmNlZC5ydW5uaW5nCgogICAgZGVib3VuY2VkLnJ1bm5pbmcgPSB3b3JrZXIuY2FsbChjb250ZXh0KQoKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCBkZWJvdW5jZWQucnVubmluZwogICAgfSBmaW5hbGx5IHsKICAgICAgZGVib3VuY2VkLnJ1bm5pbmcgPSBudWxsCiAgICB9CiAgfQp9CnsKICAibmFtZSI6ICJkZWJvdW5jZWlmeSIsCiAgInZlcnNpb24iOiAiMS4xLjAiLAogICJkZXNjcmlwdGlvbiI6ICJUaW55IGFzeW5jIGRlYm91bmNlciIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xNi4wLjMiLAogICAgInRhcGUiOiAiXjUuMS4xIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2RlYm91bmNlaWZ5LmdpdCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgdGFwZSB0ZXN0LmpzIgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2RlYm91bmNlaWZ5L2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2RlYm91bmNlaWZ5Igp9CmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKQpjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpCmNvbnN0IGZzeCA9IHJlcXVpcmUoJ2ZzLW5hdGl2ZS1leHRlbnNpb25zJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKY29uc3QgRkRMb2NrID0gcmVxdWlyZSgnZmQtbG9jaycpCgpjb25zdCBQTEFURk9STSA9IGdsb2JhbC5CYXJlID8gZ2xvYmFsLkJhcmUucGxhdGZvcm0gOiBnbG9iYWwucHJvY2Vzcy5wbGF0Zm9ybQpjb25zdCBJU19XSU4gPSBQTEFURk9STSA9PT0gJ3dpbjMyJwpjb25zdCBJU19MSU5VWCA9IFBMQVRGT1JNID09PSAnbGludXgnCmNvbnN0IE1PRElGSUVEX1NMQUNLID0gNTAwMApjb25zdCBFTVBUWSA9IGI0YS5hbGxvYygwKQpjb25zdCBBVFRSID0gSVNfTElOVVggPyAndXNlci5kZXZpY2UtZmlsZScgOiAnZGV2aWNlLWZpbGUnCgpjb25zdCBubCA9IElTX1dJTiA/ICdcclxuJyA6ICdcbicKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgRGV2aWNlRmlsZSBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yKGZpbGVuYW1lLCB7IGNyZWF0ZSA9IHRydWUsIHdhaXQgPSBmYWxzZSwgbG9jayA9IHdhaXQsIGRhdGEgPSB7fSB9ID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmZpbGVuYW1lID0gZmlsZW5hbWUKICAgIHRoaXMuZGF0YSA9IGRhdGEKICAgIHRoaXMubG9jayA9IG51bGwKCiAgICB0aGlzLl9jcmVhdGUgPSBjcmVhdGUKICAgIHRoaXMuX3dhaXQgPSB3YWl0CiAgICB0aGlzLl9sb2NrID0gbG9jawogIH0KCiAgYXN5bmMgX29wZW4oKSB7CiAgICBpZiAoYXdhaXQgdmVyaWZ5RGV2aWNlRmlsZSh0aGlzKSkgcmV0dXJuCiAgICBpZiAoIXRoaXMuX2NyZWF0ZSkgdGhyb3cgbmV3IEVycm9yKCdObyBkZXZpY2UgZmlsZSBwcmVzZW50JykKICAgIGF3YWl0IHdyaXRlRGV2aWNlRmlsZSh0aGlzKQogIH0KCiAgdHJhbnNmZXIoKSB7CiAgICByZXR1cm4gdGhpcy5sb2NrID8gdGhpcy5sb2NrLnRyYW5zZmVyKCkgOiAtMQogIH0KCiAgYXN5bmMgX2Nsb3NlKCkgewogICAgaWYgKHRoaXMubG9jaykgYXdhaXQgdGhpcy5sb2NrLmNsb3NlKCkKICB9CgogIGFzeW5jIHN1c3BlbmQoKSB7CiAgICBpZiAoIXRoaXMub3BlbmVkKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmICh0aGlzLmxvY2spIGF3YWl0IHRoaXMubG9jay5zdXNwZW5kKCkKICB9CgogIGFzeW5jIHJlc3VtZSgpIHsKICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKHRoaXMubG9jaykgYXdhaXQgdGhpcy5sb2NrLnJlc3VtZSgpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiB3cml0ZURldmljZUZpbGUoZGV2aWNlKSB7CiAgbGV0IHMgPSAnJwoKICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhkZXZpY2UuZGF0YSkpIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgY29udGludWUKICAgIHMgKz0ga2V5ICsgJz0nICsgdmFsdWUgKyBubAogIH0KCiAgYXdhaXQgZnMucHJvbWlzZXMubWtkaXIocGF0aC5kaXJuYW1lKGRldmljZS5maWxlbmFtZSksIHsgcmVjdXJzaXZlOiB0cnVlIH0pCgogIGNvbnN0IGZkID0gYXdhaXQgb3BlbihkZXZpY2UuZmlsZW5hbWUsICd3JykKCiAgZGV2aWNlLmxvY2sgPSBkZXZpY2UuX2xvY2sgPyBuZXcgRkRMb2NrKGZkLCB7IHdhaXQ6IGRldmljZS5fd2FpdCB9KSA6IG51bGwKCiAgaWYgKGRldmljZS5sb2NrKSB7CiAgICB0cnkgewogICAgICBhd2FpdCBkZXZpY2UubG9jay5yZWFkeSgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgYXdhaXQgZGV2aWNlLmxvY2suY2xvc2UoKQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIGNvbnN0IHN0ID0gYXdhaXQgZnN0YXQoZmQpCgogIGNvbnN0IGNyZWF0ZWQgPSBEYXRlLm5vdygpCgogIHMgKz0gJ2RldmljZS9wbGF0Zm9ybT0nICsgUExBVEZPUk0gKyBubAogIHMgKz0gJ2RldmljZS9pbm9kZT0nICsgc3QuaW5vICsgbmwKICBzICs9ICdkZXZpY2UvY3JlYXRlZD0nICsgY3JlYXRlZCArIG5sCgogIGlmIChhd2FpdCBzZXRBdHRyKGZkLCBBVFRSLCBiNGEuZnJvbSgnb3JpZ2luYWwnKSkpIHsKICAgIHMgKz0gJ2RldmljZS9hdHRyaWJ1dGU9b3JpZ2luYWwnICsgbmwKICB9CgogIGF3YWl0IHdyaXRlKGZkLCBiNGEuZnJvbShzKSkKCiAgaWYgKCFkZXZpY2UubG9jaykgYXdhaXQgY2xvc2UoZmQpCn0KCmFzeW5jIGZ1bmN0aW9uIHZlcmlmeURldmljZUZpbGUoZGV2aWNlKSB7CiAgbGV0IGZkID0gMAoKICB0cnkgewogICAgZmQgPSBhd2FpdCBvcGVuKGRldmljZS5maWxlbmFtZSwgJ3IrJykKICB9IGNhdGNoIChlKSB7CiAgICBmZCA9IDAKICB9CgogIGlmIChmZCA9PT0gMCkgcmV0dXJuIGZhbHNlCgogIGRldmljZS5sb2NrID0gZGV2aWNlLl9sb2NrID8gbmV3IEZETG9jayhmZCwgeyB3YWl0OiBkZXZpY2UuX3dhaXQgfSkgOiBudWxsCgogIGlmIChkZXZpY2UubG9jaykgewogICAgdHJ5IHsKICAgICAgYXdhaXQgZGV2aWNlLmxvY2sucmVhZHkoKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGF3YWl0IGRldmljZS5sb2NrLmNsb3NlKCkKICAgICAgdGhyb3cgZXJyCiAgICB9CiAgfQoKICBjb25zdCBidWYgPSBhd2FpdCByZWFkKGZkKQogIGNvbnN0IHJlc3VsdCA9IHt9CgogIGNvbnN0IHMgPSBiNGEudG9TdHJpbmcoYnVmKS50cmltKCkuc3BsaXQoJ1xuJykKCiAgbGV0IGlub2RlID0gMAogIGxldCBjcmVhdGVkID0gMAogIGxldCBhdHRyID0gJycKICBsZXQgcGxhdGZvcm0gPSAnJwoKICBmb3IgKGNvbnN0IGxuIG9mIHMpIHsKICAgIGNvbnN0IGkgPSBsbi5pbmRleE9mKCc9JykKICAgIGlmIChpID09PSAtMSkgY29udGludWUKCiAgICBjb25zdCBrID0gbG4uc2xpY2UoMCwgaSkudHJpbSgpCiAgICBjb25zdCB2ID0gbG4uc2xpY2UoaSArIDEpLnRyaW0oKQoKICAgIHN3aXRjaCAoaykgewogICAgICBjYXNlICdkZXZpY2UvcGxhdGZvcm0nOgogICAgICAgIHBsYXRmb3JtID0gdgogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ2RldmljZS9pbm9kZSc6CiAgICAgICAgaW5vZGUgPSBOdW1iZXIodikKICAgICAgICBicmVhawogICAgICBjYXNlICdkZXZpY2UvY3JlYXRlZCc6CiAgICAgICAgY3JlYXRlZCA9IE51bWJlcih2KQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ2RldmljZS9hdHRyaWJ1dGUnOgogICAgICAgIGF0dHIgPSB2CiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXN1bHRba10gPSB2CiAgICAgICAgYnJlYWsKICAgIH0KICB9CgogIGZvciAoY29uc3QgW2ssIHZdIG9mIE9iamVjdC5lbnRyaWVzKGRldmljZS5kYXRhKSkgewogICAgaWYgKHYgPT09IG51bGwpIGNvbnRpbnVlCiAgICBpZiAocmVzdWx0W2tdID09PSB1bmRlZmluZWQpIGNvbnRpbnVlIC8vIGFsbG93IHVwc2VydHMKICAgIGlmIChyZXN1bHRba10gIT09ICcnICsgdikgewogICAgICBhd2FpdCB0ZWFyZG93bigpCiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBkZXZpY2UgZmlsZSwgJyArIGsgKyAnIGhhcyBjaGFuZ2VkLiBXYXMgJyArIHJlc3VsdFtrXSArICcsIGlzICcgKyB2KQogICAgfQogIH0KCiAgY29uc3Qgc3QgPSBhd2FpdCBmc3RhdChmZCkKICBjb25zdCBhdCA9IGF3YWl0IGdldEF0dHIoZmQsIEFUVFIpCgogIGNvbnN0IHNhbWVBdHRyID0gYjRhLnRvU3RyaW5nKGF0IHx8IEVNUFRZKSA9PT0gYXR0cgogIGNvbnN0IG1vZGlmaWVkID0gTWF0aC5tYXgoc3QubXRpbWUuZ2V0VGltZSgpLCBzdC5iaXJ0aHRpbWUuZ2V0VGltZSgpKQoKICBpZiAocGxhdGZvcm0gJiYgcGxhdGZvcm0gIT09IFBMQVRGT1JNKSB7CiAgICBhd2FpdCB0ZWFyZG93bigpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZGV2aWNlIGZpbGUsIHdhcyBtYWRlIG9uIGRpZmZlcmVudCBwbGF0Zm9ybScpCiAgfQoKICBpZiAoIXNhbWVBdHRyKSB7CiAgICBhd2FpdCB0ZWFyZG93bigpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZGV2aWNlIGZpbGUsIHdhcyBtb3ZlZCB1bnNhZmVseScpCiAgfQoKICBpZiAoc3QuaW5vICE9PSBpbm9kZSB8fCAoY3JlYXRlZCAmJiBNYXRoLmFicyhtb2RpZmllZCAtIGNyZWF0ZWQpID49IE1PRElGSUVEX1NMQUNLKSkgewogICAgYXdhaXQgdGVhcmRvd24oKQogICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGRldmljZSBmaWxlLCB3YXMgbW9kaWZpZWQnKQogIH0KCiAgaWYgKCFkZXZpY2UubG9jaykgYXdhaXQgY2xvc2UoZmQpCgogIGRldmljZS5kYXRhID0gcmVzdWx0CiAgcmV0dXJuIHRydWUKCiAgYXN5bmMgZnVuY3Rpb24gdGVhcmRvd24gKCkgewogICAgaWYgKGRldmljZS5sb2NrKSBhd2FpdCBkZXZpY2UubG9jay5jbG9zZSgpCiAgICBlbHNlIGF3YWl0IGNsb3NlKGZkKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZ2V0QXR0cihmZCwgbmFtZSkgewogIHRyeSB7CiAgICByZXR1cm4gYXdhaXQgZnN4LmdldEF0dHIoZmQsIG5hbWUpCiAgfSBjYXRjaCB7CiAgICByZXR1cm4gbnVsbAogIH0KfQoKYXN5bmMgZnVuY3Rpb24gc2V0QXR0cihmZCwgbmFtZSwgdmFsdWUpIHsKICB0cnkgewogICAgYXdhaXQgZnN4LnNldEF0dHIoZmQsIG5hbWUsIHZhbHVlKQogICAgcmV0dXJuIHRydWUKICB9IGNhdGNoIHsKICAgIHJldHVybiBmYWxzZQogIH0KfQoKZnVuY3Rpb24gZnN0YXQoZmQpIHsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgZnMuZnN0YXQoZmQsIChlcnIsIHN0KSA9PiB7CiAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpCiAgICAgIHJlc29sdmUoc3QpCiAgICB9KQogIH0pCn0KCmZ1bmN0aW9uIGNsb3NlKGZkKSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIGZzLmNsb3NlKGZkLCAoZXJyLCBzdCkgPT4gewogICAgICBpZiAoZXJyKSByZWplY3QoZXJyKQogICAgICByZXNvbHZlKHN0KQogICAgfSkKICB9KQp9CgpmdW5jdGlvbiB3cml0ZShmZCwgYnVmKSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIGxldCBvZmZzZXQgPSAwCgogICAgb253cml0ZShudWxsLCAwKQoKICAgIGZ1bmN0aW9uIG9ud3JpdGUoZXJyLCB3cm90ZSkgewogICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycikKICAgICAgaWYgKG9mZnNldCA9PT0gYnVmLmJ5dGVMZW5ndGgpIHJldHVybiByZXNvbHZlKCkKICAgICAgb2Zmc2V0ICs9IHdyb3RlCiAgICAgIGZzLndyaXRlKGZkLCBidWYsIG9mZnNldCwgYnVmLmJ5dGVMZW5ndGggLSBvZmZzZXQsIG9mZnNldCwgb253cml0ZSkKICAgIH0KICB9KQp9CgpmdW5jdGlvbiByZWFkKGZkKSB7CiAgY29uc3QgYnVmID0gYjRhLmFsbG9jVW5zYWZlKDQwOTYpCgogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBsZXQgb2Zmc2V0ID0gMAoKICAgIGZzLnJlYWQoZmQsIGJ1ZiwgMCwgYnVmLmJ5dGVMZW5ndGgsIDAsIG9ucmVhZCkKCiAgICBmdW5jdGlvbiBvbnJlYWQoZXJyLCByZWFkKSB7CiAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3QoZXJyKQogICAgICBpZiAocmVhZCA9PT0gMCkgcmV0dXJuIHJlc29sdmUoYnVmLnN1YmFycmF5KDAsIG9mZnNldCkpCiAgICAgIG9mZnNldCArPSByZWFkCiAgICAgIGZzLnJlYWQoZmQsIGJ1Ziwgb2Zmc2V0LCBidWYuYnl0ZUxlbmd0aCAtIG9mZnNldCwgb2Zmc2V0LCBvbnJlYWQpCiAgICB9CiAgfSkKfQoKZnVuY3Rpb24gb3BlbihmaWxlbmFtZSwgZmxhZ3MpIHsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgZnMub3BlbihmaWxlbmFtZSwgZmxhZ3MsIChlcnIsIGZkKSA9PiB7CiAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpCiAgICAgIHJlc29sdmUoZmQpCiAgICB9KQogIH0pCn0KewogICJuYW1lIjogImRldmljZS1maWxlIiwKICAidmVyc2lvbiI6ICIyLjEuMyIsCiAgImRlc2NyaXB0aW9uIjogIkRldmljZSBvbmx5IGZpbGUiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjciLAogICAgImJhcmUtZnMiOiAiXjQuMC4xIiwKICAgICJiYXJlLXBhdGgiOiAiXjMuMC4wIiwKICAgICJmZC1sb2NrIjogIl4yLjEuMCIsCiAgICAiZnMtbmF0aXZlLWV4dGVuc2lvbnMiOiAiXjEuNC4wIiwKICAgICJyZWFkeS1yZXNvdXJjZSI6ICJeMS4yLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMTMuMSIsCiAgICAibHVudGUiOiAiXjEuMC4yIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4gJiYgbHVudGUiLAogICAgInRlc3QiOiAiYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgImltcG9ydHMiOiB7CiAgICAiZnMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZnMiLAogICAgICAiZGVmYXVsdCI6ICJmcyIKICAgIH0sCiAgICAicGF0aCI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1wYXRoIiwKICAgICAgImRlZmF1bHQiOiAicGF0aCIKICAgIH0KICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2RldmljZS1maWxlLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYyIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9kZXZpY2UtZmlsZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2RldmljZS1maWxlIgp9CmNvbnN0IHsgRXZlbnRFbWl0dGVyIH0gPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCBUYWJsZSA9IHJlcXVpcmUoJ2thZGVtbGlhLXJvdXRpbmctdGFibGUnKQpjb25zdCBUT1MgPSByZXF1aXJlKCd0aW1lLW9yZGVyZWQtc2V0JykKY29uc3QgVURYID0gcmVxdWlyZSgndWR4LW5hdGl2ZScpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IE5hdFNhbXBsZXIgPSByZXF1aXJlKCduYXQtc2FtcGxlcicpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IElPID0gcmVxdWlyZSgnLi9saWIvaW8nKQpjb25zdCBRdWVyeSA9IHJlcXVpcmUoJy4vbGliL3F1ZXJ5JykKY29uc3QgU2Vzc2lvbiA9IHJlcXVpcmUoJy4vbGliL3Nlc3Npb24nKQpjb25zdCBwZWVyID0gcmVxdWlyZSgnLi9saWIvcGVlcicpCmNvbnN0IHsgVU5LTk9XTl9DT01NQU5ELCBJTlZBTElEX1RPS0VOIH0gPSByZXF1aXJlKCcuL2xpYi9lcnJvcnMnKQpjb25zdCB7IFBJTkcsIFBJTkdfTkFULCBGSU5EX05PREUsIERPV05fSElOVCB9ID0gcmVxdWlyZSgnLi9saWIvY29tbWFuZHMnKQoKY29uc3QgVE1QID0gYjRhLmFsbG9jVW5zYWZlKDMyKQpjb25zdCBUSUNLX0lOVEVSVkFMID0gNTAwMApjb25zdCBTTEVFUElOR19JTlRFUlZBTCA9IDMgKiBUSUNLX0lOVEVSVkFMCmNvbnN0IFNUQUJMRV9USUNLUyA9IDI0MCAvLyBpZiBub3RoaW5nIG1ham9yIGJhZCBoYXBwZW5zIGluIH4yMG1pbnMgd2UgY2FuIGNvbnNpZGVyIHRoaXMgbm9kZSBzdGFibGUgKGlmIG5hdCBpcyBmcmllbmRseSkKY29uc3QgTU9SRV9TVEFCTEVfVElDS1MgPSAzICogU1RBQkxFX1RJQ0tTCmNvbnN0IFJFRlJFU0hfVElDS1MgPSA2MCAvLyByZWZyZXNoIGV2ZXJ5IH41bWluIHdoZW4gaWRsZQpjb25zdCBSRUNFTlRfTk9ERSA9IDEyIC8vIHdlJ3ZlIGhlYXJkIGZyb20gYSBub2RlIGxlc3MgdGhhbiAxbWluIGFnbwpjb25zdCBPTERfTk9ERSA9IDM2MCAvLyBpZiBhbiBub2RlIGhhcyBiZWVuIGFyb3VuZCBtb3JlIHRoYW4gMzAgbWluIHdlIGNvbnNpZGVyIGl0IG9sZAoKY2xhc3MgREhUIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvcihvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmJvb3RzdHJhcE5vZGVzID0gb3B0cy5ib290c3RyYXAgPT09IGZhbHNlID8gW10gOiAob3B0cy5ib290c3RyYXAgfHwgW10pLm1hcChwYXJzZU5vZGUpCiAgICB0aGlzLnRhYmxlID0gbmV3IFRhYmxlKHJhbmRvbUJ5dGVzKDMyKSkKICAgIHRoaXMubm9kZXMgPSBuZXcgVE9TKCkKICAgIHRoaXMudWR4ID0gb3B0cy51ZHggfHwgbmV3IFVEWCgpCiAgICB0aGlzLmlvID0gbmV3IElPKHRoaXMudGFibGUsIHRoaXMudWR4LCB7CiAgICAgIC4uLm9wdHMsCiAgICAgIG9ucmVxdWVzdDogdGhpcy5fb25yZXF1ZXN0LmJpbmQodGhpcyksCiAgICAgIG9ucmVzcG9uc2U6IHRoaXMuX29ucmVzcG9uc2UuYmluZCh0aGlzKSwKICAgICAgb250aW1lb3V0OiB0aGlzLl9vbnRpbWVvdXQuYmluZCh0aGlzKQogICAgfSkKCiAgICB0aGlzLmNvbmN1cnJlbmN5ID0gb3B0cy5jb25jdXJyZW5jeSB8fCAxMAogICAgdGhpcy5ib290c3RyYXBwZWQgPSBmYWxzZQogICAgdGhpcy5lcGhlbWVyYWwgPSB0cnVlCiAgICB0aGlzLmZpcmV3YWxsZWQgPSB0aGlzLmlvLmZpcmV3YWxsZWQKICAgIHRoaXMuYWRhcHRpdmUgPSB0eXBlb2Ygb3B0cy5lcGhlbWVyYWwgIT09ICdib29sZWFuJyAmJiBvcHRzLmFkYXB0aXZlICE9PSBmYWxzZQogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgdGhpcy5vbmxpbmUgPSB0cnVlCiAgICB0aGlzLnN0YXRzID0gewogICAgICBxdWVyaWVzOiB7IGFjdGl2ZTogMCwgdG90YWw6IDAgfSwKICAgICAgcmVxdWVzdHM6IHRoaXMuaW8uc3RhdHMucmVxdWVzdHMsCiAgICAgIGNvbW1hbmRzOiB7CiAgICAgICAgcGluZzogdGhpcy5pby5zdGF0cy5jb21tYW5kc1tQSU5HXSwKICAgICAgICBwaW5nTmF0OiB0aGlzLmlvLnN0YXRzLmNvbW1hbmRzW1BJTkdfTkFUXSwKICAgICAgICBmaW5kTm9kZTogdGhpcy5pby5zdGF0cy5jb21tYW5kc1tGSU5EX05PREVdLAogICAgICAgIGRvd25IaW50OiB0aGlzLmlvLnN0YXRzLmNvbW1hbmRzW0RPV05fSElOVF0KICAgICAgfQogICAgfQoKICAgIHRoaXMuX25hdCA9IG5ldyBOYXRTYW1wbGVyKCkKICAgIHRoaXMuX3F1aWNrRmlyZXdhbGwgPSBvcHRzLnF1aWNrRmlyZXdhbGwgIT09IGZhbHNlCiAgICB0aGlzLl9mb3JjZVBlcnNpc3RlbnQgPSBvcHRzLmVwaGVtZXJhbCA9PT0gZmFsc2UKICAgIHRoaXMuX3JlcGluZ2luZyA9IDAKICAgIHRoaXMuX2NoZWNrcyA9IDAKICAgIHRoaXMuX3RpY2sgPSByYW5kb21PZmZzZXQoMTAwKSAvLyBtYWtlIHN1cmUgdG8gcmFuZG9tIG9mZnNldCBhbGwgdGhlIG5ldHdvcmsgdGlja3MKICAgIHRoaXMuX3JlZnJlc2hUaWNrcyA9IHJhbmRvbU9mZnNldChSRUZSRVNIX1RJQ0tTKQogICAgdGhpcy5fc3RhYmxlVGlja3MgPSB0aGlzLmFkYXB0aXZlID8gU1RBQkxFX1RJQ0tTIDogMAogICAgdGhpcy5fdGlja0ludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5fb250aWNrLmJpbmQodGhpcyksIFRJQ0tfSU5URVJWQUwpCiAgICB0aGlzLl9sYXN0VGljayA9IERhdGUubm93KCkKICAgIHRoaXMuX2xhc3RIb3N0ID0gbnVsbAogICAgdGhpcy5fZmlsdGVyTm9kZSA9IG9wdHMuZmlsdGVyTm9kZSB8fCBvcHRzLmFkZE5vZGUgfHwgbnVsbCAvLyBvcHRzLmFkZE5vZGUgaXMgZGVwcmVjYXRpbmcsIHVzZSBvcHRzLmZpbHRlck5vZGUgaW5zdGVhZAogICAgdGhpcy5fb25yb3cgPSAocm93KSA9PiByb3cub24oJ2Z1bGwnLCAobm9kZSkgPT4gdGhpcy5fb25mdWxscm93KG5vZGUsIHJvdykpCiAgICB0aGlzLl9ub25lUGVyc2lzdGVudFNhbXBsZXMgPSBbXQogICAgdGhpcy5fYm9vdHN0cmFwcGluZyA9IHRoaXMuX2Jvb3RzdHJhcCgpCiAgICB0aGlzLl9ib290c3RyYXBwaW5nLmNhdGNoKG5vb3ApCgogICAgdGhpcy50YWJsZS5vbigncm93JywgdGhpcy5fb25yb3cpCgogICAgdGhpcy5pby5uZXR3b3JrSW50ZXJmYWNlcy5vbignY2hhbmdlJywgKGludGVyZmFjZXMpID0+IHRoaXMuX29ubmV0d29ya2NoYW5nZShpbnRlcmZhY2VzKSkKCiAgICBpZiAob3B0cy5ub2RlcykgewogICAgICBmb3IgKGxldCBpID0gb3B0cy5ub2Rlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIHRoaXMuYWRkTm9kZShvcHRzLm5vZGVzW2ldKQogICAgICB9CiAgICB9CiAgfQoKICBzdGF0aWMgYm9vdHN0cmFwcGVyKHBvcnQsIGhvc3QsIG9wdHMpIHsKICAgIGlmICghcG9ydCkgdGhyb3cgbmV3IEVycm9yKCdQb3J0IGlzIHJlcXVpcmVkJykKICAgIGlmICghaG9zdCkgdGhyb3cgbmV3IEVycm9yKCdIb3N0IGlzIHJlcXVpcmVkJykKICAgIGlmIChob3N0ID09PSAnMC4wLjAuMCcgfHwgaG9zdCA9PT0gJzo6JykgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGhvc3QnKQogICAgaWYgKCFVRFguaXNJUHY0KGhvc3QpKSB0aHJvdyBuZXcgRXJyb3IoJ0hvc3QgbXVzdCBiZSBhIElQdjQgYWRkcmVzcycpCgogICAgY29uc3QgZGh0ID0gbmV3IHRoaXMoewogICAgICBwb3J0LAogICAgICBlcGhlbWVyYWw6IGZhbHNlLAogICAgICBmaXJld2FsbGVkOiBmYWxzZSwKICAgICAgYW55UG9ydDogZmFsc2UsCiAgICAgIGJvb3RzdHJhcDogW10sCiAgICAgIC4uLm9wdHMKICAgIH0pCiAgICBkaHQuX25hdC5hZGQoaG9zdCwgcG9ydCkKICAgIHJldHVybiBkaHQKICB9CgogIGdldCBpZCgpIHsKICAgIHJldHVybiB0aGlzLmVwaGVtZXJhbCA/IG51bGwgOiB0aGlzLnRhYmxlLmlkCiAgfQoKICBnZXQgaG9zdCgpIHsKICAgIHJldHVybiB0aGlzLl9uYXQuaG9zdAogIH0KCiAgZ2V0IHBvcnQoKSB7CiAgICByZXR1cm4gdGhpcy5fbmF0LnBvcnQKICB9CgogIGdldCByYW5kb21pemVkKCkgewogICAgcmV0dXJuIHRoaXMuX25hdC5ob3N0ICE9PSBudWxsICYmIHRoaXMuX25hdC5wb3J0ID09PSAwCiAgfQoKICBnZXQgc29ja2V0KCkgewogICAgcmV0dXJuIHRoaXMuZmlyZXdhbGxlZCA/IHRoaXMuaW8uY2xpZW50U29ja2V0IDogdGhpcy5pby5zZXJ2ZXJTb2NrZXQKICB9CgogIG9ubWVzc2FnZShzb2NrZXQsIGJ1ZiwgcmluZm8pIHsKICAgIGlmIChidWYuYnl0ZUxlbmd0aCA+IDEpIHRoaXMuaW8ub25tZXNzYWdlKHNvY2tldCwgYnVmLCByaW5mbykKICB9CgogIGJpbmQoKSB7CiAgICByZXR1cm4gdGhpcy5pby5iaW5kKCkKICB9CgogIGFzeW5jIHN1c3BlbmQoeyBsb2cgPSBub29wIH0gPSB7fSkgewogICAgbG9nKCdTdXNwZW5kaW5nIHdhaXRpbmcgZm9yIGlvIGJpbmQuLi4nKQogICAgYXdhaXQgdGhpcy5pby5iaW5kKCkKICAgIGxvZygnRG9uZSwgY29udGludWluZycpCiAgICBpZiAodGhpcy5zdXNwZW5kZWQgfHwgdGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5zdXNwZW5kZWQgPSB0cnVlCiAgICBjbGVhckludGVydmFsKHRoaXMuX3RpY2tJbnRlcnZhbCkKICAgIGxvZygnRG9uZSwgc3VzcGVuZGluZyBpbycpCiAgICBhd2FpdCB0aGlzLmlvLnN1c3BlbmQoeyBsb2cgfSkKICAgIGxvZygnRG9uZSwgZGh0IHN1c3BlbmRlZCcpCiAgICB0aGlzLmVtaXQoJ3N1c3BlbmQnKQogIH0KCiAgYXN5bmMgcmVzdW1lKHsgbG9nID0gbm9vcCB9ID0ge30pIHsKICAgIGlmICghdGhpcy5zdXNwZW5kZWQgfHwgdGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgdGhpcy5fdGlja0ludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5fb250aWNrLmJpbmQodGhpcyksIFRJQ0tfSU5URVJWQUwpCiAgICB0aGlzLl9vbndha2V1cCgpCiAgICBsb2coJ1Jlc3VtaW5nIGlvJykKICAgIGF3YWl0IHRoaXMuaW8ucmVzdW1lKCkKICAgIGxvZygnRG9uZSwgZGh0IHJlc3VtZWQnKQogICAgdGhpcy5pby5uZXR3b3JrSW50ZXJmYWNlcy5vbignY2hhbmdlJywgKGludGVyZmFjZXMpID0+IHRoaXMuX29ubmV0d29ya2NoYW5nZShpbnRlcmZhY2VzKSkKICAgIHRoaXMucmVmcmVzaCgpCiAgICB0aGlzLmVtaXQoJ3Jlc3VtZScpCiAgfQoKICBhZGRyZXNzKCkgewogICAgY29uc3Qgc29ja2V0ID0gdGhpcy5zb2NrZXQKICAgIHJldHVybiBzb2NrZXQgPyBzb2NrZXQuYWRkcmVzcygpIDogbnVsbAogIH0KCiAgbG9jYWxBZGRyZXNzKCkgewogICAgaWYgKCF0aGlzLmlvLnNlcnZlclNvY2tldCkgcmV0dXJuIG51bGwKCiAgICByZXR1cm4gewogICAgICBob3N0OiBsb2NhbElQKHRoaXMudWR4KSwKICAgICAgcG9ydDogdGhpcy5pby5zZXJ2ZXJTb2NrZXQuYWRkcmVzcygpLnBvcnQKICAgIH0KICB9CgogIHJlbW90ZUFkZHJlc3MoKSB7CiAgICBpZiAoIXRoaXMuaG9zdCkgcmV0dXJuIG51bGwKICAgIGlmICghdGhpcy5wb3J0KSByZXR1cm4gbnVsbAogICAgaWYgKHRoaXMuZmlyZXdhbGxlZCkgcmV0dXJuIG51bGwKICAgIGlmICghdGhpcy5pby5zZXJ2ZXJTb2NrZXQpIHJldHVybiBudWxsCgogICAgY29uc3QgcG9ydCA9IHRoaXMuaW8uc2VydmVyU29ja2V0LmFkZHJlc3MoKS5wb3J0CiAgICBpZiAocG9ydCAhPT0gdGhpcy5wb3J0KSByZXR1cm4gbnVsbAoKICAgIHJldHVybiB7CiAgICAgIGhvc3Q6IHRoaXMuaG9zdCwKICAgICAgcG9ydAogICAgfQogIH0KCiAgYWRkTm9kZSh7IGhvc3QsIHBvcnQgfSkgewogICAgdGhpcy5fYWRkTm9kZSh7CiAgICAgIGlkOiBwZWVyLmlkKGhvc3QsIHBvcnQpLAogICAgICBwb3J0LAogICAgICBob3N0LAogICAgICB0b2tlbjogbnVsbCwKICAgICAgdG86IG51bGwsCiAgICAgIHNhbXBsZWQ6IDAsCiAgICAgIGFkZGVkOiB0aGlzLl90aWNrLAogICAgICBwaW5nZWQ6IDAsCiAgICAgIHNlZW46IDAsCiAgICAgIGRvd25IaW50czogMCwKICAgICAgcHJldjogbnVsbCwKICAgICAgbmV4dDogbnVsbAogICAgfSkKICB9CgogIHRvQXJyYXkob3B0cykgewogICAgY29uc3QgbGltaXQgPSBvcHRzICYmIG9wdHMubGltaXQKICAgIGlmIChsaW1pdCA9PT0gMCkgcmV0dXJuIFtdCiAgICByZXR1cm4gdGhpcy5ub2Rlcy50b0FycmF5KHsgbGltaXQsIHJldmVyc2U6IHRydWUgfSkubWFwKCh7IGhvc3QsIHBvcnQgfSkgPT4gKHsgaG9zdCwgcG9ydCB9KSkKICB9CgogIGFzeW5jIGZ1bGx5Qm9vdHN0cmFwcGVkKCkgewogICAgcmV0dXJuIHRoaXMuX2Jvb3RzdHJhcHBpbmcKICB9CgogIHJlYWR5KCkgewogICAgLy8gRGVwcmVjYXRpbmcsIHVzZSBmdWxseUJvb3RzdHJhcHBlZCBpbnN0ZWFkIChyZW1vdmVkIG9uIG5leHQgbWFqb3IpCiAgICByZXR1cm4gdGhpcy5mdWxseUJvb3RzdHJhcHBlZCgpCiAgfQoKICBmaW5kTm9kZSh0YXJnZXQsIG9wdHMpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdOb2RlIGRlc3Ryb3llZCcpCiAgICB0aGlzLl9yZWZyZXNoVGlja3MgPSBSRUZSRVNIX1RJQ0tTCiAgICByZXR1cm4gbmV3IFF1ZXJ5KHRoaXMsIHRhcmdldCwgdHJ1ZSwgRklORF9OT0RFLCBudWxsLCBvcHRzKQogIH0KCiAgcXVlcnkoeyB0YXJnZXQsIGNvbW1hbmQsIHZhbHVlIH0sIG9wdHMpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdOb2RlIGRlc3Ryb3llZCcpCiAgICB0aGlzLl9yZWZyZXNoVGlja3MgPSBSRUZSRVNIX1RJQ0tTCiAgICByZXR1cm4gbmV3IFF1ZXJ5KHRoaXMsIHRhcmdldCwgZmFsc2UsIGNvbW1hbmQsIHZhbHVlIHx8IG51bGwsIG9wdHMpCiAgfQoKICBwaW5nKHsgaG9zdCwgcG9ydCB9LCBvcHRzKSB7CiAgICBsZXQgdmFsdWUgPSBudWxsCgogICAgaWYgKG9wdHMgJiYgb3B0cy5zaXplICYmIG9wdHMuc2l6ZSA+IDApIHZhbHVlID0gYjRhLmFsbG9jKG9wdHMuc2l6ZSkKCiAgICBjb25zdCByZXEgPSB0aGlzLmlvLmNyZWF0ZVJlcXVlc3QoCiAgICAgIHsgaWQ6IG51bGwsIGhvc3QsIHBvcnQgfSwKICAgICAgbnVsbCwKICAgICAgdHJ1ZSwKICAgICAgUElORywKICAgICAgbnVsbCwKICAgICAgdmFsdWUsCiAgICAgIChvcHRzICYmIG9wdHMuc2Vzc2lvbikgfHwgbnVsbCwKICAgICAgb3B0cyAmJiBvcHRzLnR0bAogICAgKQogICAgcmV0dXJuIHRoaXMuX3JlcXVlc3RUb1Byb21pc2UocmVxLCBvcHRzKQogIH0KCiAgcmVxdWVzdCh7IHRva2VuID0gbnVsbCwgY29tbWFuZCwgdGFyZ2V0ID0gbnVsbCwgdmFsdWUgPSBudWxsIH0sIHsgaG9zdCwgcG9ydCB9LCBvcHRzKSB7CiAgICBjb25zdCByZXEgPSB0aGlzLmlvLmNyZWF0ZVJlcXVlc3QoCiAgICAgIHsgaWQ6IG51bGwsIGhvc3QsIHBvcnQgfSwKICAgICAgdG9rZW4sCiAgICAgIGZhbHNlLAogICAgICBjb21tYW5kLAogICAgICB0YXJnZXQsCiAgICAgIHZhbHVlLAogICAgICAob3B0cyAmJiBvcHRzLnNlc3Npb24pIHx8IG51bGwsCiAgICAgIG9wdHMgJiYgb3B0cy50dGwKICAgICkKICAgIHJldHVybiB0aGlzLl9yZXF1ZXN0VG9Qcm9taXNlKHJlcSwgb3B0cykKICB9CgogIHNlc3Npb24oKSB7CiAgICByZXR1cm4gbmV3IFNlc3Npb24odGhpcykKICB9CgogIF9yZXF1ZXN0VG9Qcm9taXNlKHJlcSwgb3B0cykgewogICAgaWYgKHJlcSA9PT0gbnVsbCkgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignTm9kZSBkZXN0cm95ZWQnKSkKCiAgICBpZiAob3B0cyAmJiBvcHRzLnNvY2tldCkgcmVxLnNvY2tldCA9IG9wdHMuc29ja2V0CiAgICBpZiAob3B0cyAmJiBvcHRzLnJldHJ5ID09PSBmYWxzZSkgcmVxLnJldHJpZXMgPSAwCgogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgcmVxLm9ucmVzcG9uc2UgPSByZXNvbHZlCiAgICAgIHJlcS5vbmVycm9yID0gcmVqZWN0CiAgICAgIHJlcS5zZW5kKCkKICAgIH0pCiAgfQoKICBhc3luYyBfYm9vdHN0cmFwKCkgewogICAgY29uc3Qgc2VsZiA9IHRoaXMKCiAgICBhd2FpdCBQcm9taXNlLnJlc29sdmUoKSAvLyB3YWl0IGEgdGljaywgc28gYXBpcyBjYW4gYmUgdXNlZCBmcm9tIHRoZSBvdXRzaWRlCiAgICBhd2FpdCB0aGlzLmlvLmJpbmQoKQoKICAgIHRoaXMuZW1pdCgnbGlzdGVuaW5nJykKCiAgICAvLyBUT0RPOiBzb21lIHBhcGVycyBkZXNjcmliZSBtb3JlIGFkdmFuY2VkIHdheXMgb2YgYm9vdHN0cmFwcGluZyAtIHdlIHNob3VsZCBwcm9iIGxvb2sgaW50byB0aGF0CgogICAgbGV0IGZpcnN0ID0gdGhpcy5maXJld2FsbGVkICYmIHRoaXMuX3F1aWNrRmlyZXdhbGwgJiYgIXRoaXMuX2ZvcmNlUGVyc2lzdGVudAogICAgbGV0IHRlc3ROYXQgPSBmYWxzZQoKICAgIGNvbnN0IG9ubHlGaXJld2FsbCA9ICF0aGlzLl9mb3JjZVBlcnNpc3RlbnQKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDI7IGkrKykgewogICAgICBhd2FpdCB0aGlzLl9iYWNrZ3JvdW5kUXVlcnkodGhpcy50YWJsZS5pZCkub24oJ2RhdGEnLCBvbmRhdGEpLmZpbmlzaGVkKCkKCiAgICAgIGlmICh0aGlzLmJvb3RzdHJhcHBlZCB8fCAoIXRlc3ROYXQgJiYgIXRoaXMuX2ZvcmNlUGVyc2lzdGVudCkpIGJyZWFrCiAgICAgIGlmICghKGF3YWl0IHRoaXMuX3VwZGF0ZU5ldHdvcmtTdGF0ZShvbmx5RmlyZXdhbGwpKSkgYnJlYWsKICAgIH0KCiAgICBpZiAodGhpcy5ib290c3RyYXBwZWQpIHJldHVybgogICAgdGhpcy5ib290c3RyYXBwZWQgPSB0cnVlCgogICAgdGhpcy5lbWl0KCdyZWFkeScpCgogICAgZnVuY3Rpb24gb25kYXRhKGRhdGEpIHsKICAgICAgLy8gU2ltcGxlIFFVSUNLIG5hdCBoZXVyaXN0aWMuCiAgICAgIC8vIElmIHdlIGdldCBPTkUgcG9zaXRpdmUgbmF0IHBpbmcgYmVmb3JlIHRoZSBib290c3RyYXAgcXVlcnkgZmluaXNoZXMKICAgICAgLy8gdGhlbiB3ZSBhbHdheXMgdG8gYSBuYXQgdGVzdCwgbm8gbWF0dGVyIGlmIHdlIGFyZSBhZGFwdGl2ZS4uLgogICAgICAvLyBUaGlzIHNob3VsZCBiZSBleHBhbmRlZCBpbiB0aGUgZnV0dXJlIHRvIHRyeSBtb3JlIHRoYW4gb25lIG5vZGUgZXRjLCBub3QgYWx3YXlzIGhpdCB0aGUgZmlyc3QgZXRjCiAgICAgIC8vIElmIHRoaXMgZmFpbHMsIHRoZW4gbmJkLCBhcyB0aGUgb25zdGFibGUgaG9vayB3aWxsIHBpY2sgaXQgdXAgbGF0ZXIuCgogICAgICBpZiAoIWZpcnN0KSByZXR1cm4KICAgICAgZmlyc3QgPSBmYWxzZQoKICAgICAgY29uc3QgdmFsdWUgPSBiNGEuYWxsb2NVbnNhZmUoMikKICAgICAgYy51aW50MTYuZW5jb2RlKHsgc3RhcnQ6IDAsIGVuZDogMiwgYnVmZmVyOiB2YWx1ZSB9LCBzZWxmLmlvLnNlcnZlclNvY2tldC5hZGRyZXNzKCkucG9ydCkKCiAgICAgIHNlbGYuX3JlcXVlc3QoCiAgICAgICAgZGF0YS5mcm9tLAogICAgICAgIGZhbHNlLAogICAgICAgIHRydWUsCiAgICAgICAgUElOR19OQVQsCiAgICAgICAgbnVsbCwKICAgICAgICB2YWx1ZSwKICAgICAgICBudWxsLAogICAgICAgICgpID0+IHsKICAgICAgICAgIHRlc3ROYXQgPSB0cnVlCiAgICAgICAgfSwKICAgICAgICBub29wCiAgICAgICkKICAgIH0KICB9CgogIHJlZnJlc2goKSB7CiAgICBjb25zdCBub2RlID0gdGhpcy50YWJsZS5yYW5kb20oKQogICAgdGhpcy5fYmFja2dyb3VuZFF1ZXJ5KG5vZGUgPyBub2RlLmlkIDogdGhpcy50YWJsZS5pZCkub24oJ2Vycm9yJywgbm9vcCkKICB9CgogIGFzeW5jIGRlc3Ryb3koKSB7CiAgICBjb25zdCBlbWl0Q2xvc2UgPSAhdGhpcy5kZXN0cm95ZWQKICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQogICAgY2xlYXJJbnRlcnZhbCh0aGlzLl90aWNrSW50ZXJ2YWwpCiAgICBhd2FpdCB0aGlzLmlvLmRlc3Ryb3koKQogICAgaWYgKGVtaXRDbG9zZSkgdGhpcy5lbWl0KCdjbG9zZScpCiAgfQoKICBfcmVxdWVzdCh0bywgZm9yY2UsIGludGVybmFsLCBjb21tYW5kLCB0YXJnZXQsIHZhbHVlLCBzZXNzaW9uLCBvbnJlc3BvbnNlLCBvbmVycm9yKSB7CiAgICBjb25zdCByZXEgPSB0aGlzLmlvLmNyZWF0ZVJlcXVlc3QodG8sIG51bGwsIGludGVybmFsLCBjb21tYW5kLCB0YXJnZXQsIHZhbHVlLCBzZXNzaW9uKQogICAgaWYgKHJlcSA9PT0gbnVsbCkgcmV0dXJuIG51bGwKCiAgICByZXEub25yZXNwb25zZSA9IG9ucmVzcG9uc2UKICAgIHJlcS5vbmVycm9yID0gb25lcnJvcgogICAgcmVxLnNlbmQoZm9yY2UpCgogICAgcmV0dXJuIHJlcQogIH0KCiAgX25hdEFkZChob3N0LCBwb3J0KSB7CiAgICBjb25zdCBwcmV2SG9zdCA9IHRoaXMuX25hdC5ob3N0CiAgICBjb25zdCBwcmV2UG9ydCA9IHRoaXMuX25hdC5wb3J0CgogICAgdGhpcy5fbmF0LmFkZChob3N0LCBwb3J0KQoKICAgIGlmIChwcmV2SG9zdCA9PT0gdGhpcy5fbmF0Lmhvc3QgJiYgcHJldlBvcnQgPT09IHRoaXMuX25hdC5wb3J0KSByZXR1cm4KCiAgICB0aGlzLmVtaXQoJ25hdC11cGRhdGUnLCB0aGlzLl9uYXQuaG9zdCwgdGhpcy5fbmF0LnBvcnQpCiAgfQoKICAvLyB3ZSBkb24ndCBjaGVjayB0aGF0IHRoaXMgaXMgYSBib290c3RyYXAgbm9kZSBidXQgd2UgbGltaXQgdGhlIHNhbXBsZSBzaXplIHRvIHZlcnkgZmV3IG5vZGVzLCBzbyBmaW5lCiAgX3NhbXBsZUJvb3RzdHJhcE1heWJlKGZyb20sIHRvKSB7CiAgICBpZiAodGhpcy5fbm9uZVBlcnNpc3RlbnRTYW1wbGVzLmxlbmd0aCA+PSBNYXRoLm1heCgxLCB0aGlzLmJvb3RzdHJhcE5vZGVzLmxlbmd0aCkpIHJldHVybgogICAgY29uc3QgaWQgPSBmcm9tLmhvc3QgKyAnOicgKyBmcm9tLnBvcnQKICAgIGlmICh0aGlzLl9ub25lUGVyc2lzdGVudFNhbXBsZXMuaW5kZXhPZihpZCkgPiAtMSkgcmV0dXJuCiAgICB0aGlzLl9ub25lUGVyc2lzdGVudFNhbXBsZXMucHVzaChpZCkKICAgIHRoaXMuX25hdEFkZCh0by5ob3N0LCB0by5wb3J0KQogIH0KCiAgX2FkZE5vZGVGcm9tTmV0d29yayhzYW1wbGUsIGZyb20sIHRvKSB7CiAgICBpZiAodGhpcy5fZmlsdGVyTm9kZSAhPT0gbnVsbCAmJiAhdGhpcy5fZmlsdGVyTm9kZShmcm9tKSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoZnJvbS5pZCA9PT0gbnVsbCkgewogICAgICB0aGlzLl9zYW1wbGVCb290c3RyYXBNYXliZShmcm9tLCB0bykKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3Qgb2xkTm9kZSA9IHRoaXMudGFibGUuZ2V0KGZyb20uaWQpCgogICAgLy8gcmVmcmVzaCBpdCwgaWYgd2UndmUgc2VlbiB0aGlzIGJlZm9yZQogICAgaWYgKG9sZE5vZGUpIHsKICAgICAgaWYgKHNhbXBsZSAmJiAob2xkTm9kZS5zYW1wbGVkID09PSAwIHx8IHRoaXMuX3RpY2sgLSBvbGROb2RlLnNhbXBsZWQgPj0gT0xEX05PREUpKSB7CiAgICAgICAgb2xkTm9kZS50byA9IHRvCiAgICAgICAgb2xkTm9kZS5zYW1wbGVkID0gdGhpcy5fdGljawogICAgICAgIHRoaXMuX25hdEFkZCh0by5ob3N0LCB0by5wb3J0KQogICAgICB9CgogICAgICBvbGROb2RlLnBpbmdlZCA9IG9sZE5vZGUuc2VlbiA9IHRoaXMuX3RpY2sKICAgICAgdGhpcy5ub2Rlcy5hZGQob2xkTm9kZSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5fYWRkTm9kZSh7CiAgICAgIGlkOiBmcm9tLmlkLAogICAgICBwb3J0OiBmcm9tLnBvcnQsCiAgICAgIGhvc3Q6IGZyb20uaG9zdCwKICAgICAgdG8sCiAgICAgIHNhbXBsZWQ6IDAsCiAgICAgIGFkZGVkOiB0aGlzLl90aWNrLAogICAgICBwaW5nZWQ6IHRoaXMuX3RpY2ssIC8vIGxhc3QgdGltZSB3ZSBpbnRlcmFjdGVkIHdpdGggdGhlbQogICAgICBzZWVuOiB0aGlzLl90aWNrLCAvLyBsYXN0IHRpbWUgd2UgaGVhcmQgZnJvbSB0aGVtCiAgICAgIGRvd25IaW50czogMCwKICAgICAgcHJldjogbnVsbCwKICAgICAgbmV4dDogbnVsbAogICAgfSkKICB9CgogIF9hZGROb2RlKG5vZGUpIHsKICAgIGlmICh0aGlzLm5vZGVzLmhhcyhub2RlKSB8fCBiNGEuZXF1YWxzKG5vZGUuaWQsIHRoaXMudGFibGUuaWQpKSByZXR1cm4KCiAgICBub2RlLmFkZGVkID0gbm9kZS5waW5nZWQgPSBub2RlLnNlZW4gPSB0aGlzLl90aWNrCgogICAgaWYgKCF0aGlzLnRhYmxlLmFkZChub2RlKSkgcmV0dXJuCiAgICB0aGlzLm5vZGVzLmFkZChub2RlKQoKICAgIGlmIChub2RlLnRvICYmIG5vZGUuc2FtcGxlZCA9PT0gMCkgewogICAgICBub2RlLnNhbXBsZWQgPSB0aGlzLl90aWNrCiAgICAgIHRoaXMuX25hdEFkZChub2RlLnRvLmhvc3QsIG5vZGUudG8ucG9ydCkKICAgIH0KCiAgICB0aGlzLmVtaXQoJ2FkZC1ub2RlJywgbm9kZSkKICB9CgogIF9yZW1vdmVTdGFsZU5vZGUobm9kZSwgbGFzdFNlZW4pIHsKICAgIGlmIChub2RlLnNlZW4gPD0gbGFzdFNlZW4pIHRoaXMuX3JlbW92ZU5vZGUobm9kZSkKICB9CgogIF9yZW1vdmVOb2RlKG5vZGUpIHsKICAgIGlmICghdGhpcy5ub2Rlcy5oYXMobm9kZSkpIHJldHVybgoKICAgIHRoaXMudGFibGUucmVtb3ZlKG5vZGUuaWQpCiAgICB0aGlzLm5vZGVzLnJlbW92ZShub2RlKQoKICAgIHRoaXMuZW1pdCgncmVtb3ZlLW5vZGUnLCBub2RlKQogIH0KCiAgX29ud2FrZXVwKCkgewogICAgdGhpcy5fdGljayArPSAyICogT0xEX05PREUgLy8gYnVtcCB0aGUgdGljayBlbm91Z2ggdGhhdCBldmVyeXRoaW5nIGFwcGVhcnMgb2xkLgogICAgdGhpcy5fdGljayArPSA4IC0gKHRoaXMuX3RpY2sgJiA3KSAtIDIgLy8gdHJpZ2dlcnMgYSBzZXJpZXMgb2YgcGluZ3MgaW4gdHdvIHRpY2tzCiAgICB0aGlzLl9zdGFibGVUaWNrcyA9IE1PUkVfU1RBQkxFX1RJQ0tTCiAgICB0aGlzLl9yZWZyZXNoVGlja3MgPSAxIC8vIHRyaWdnZXJzIGEgcmVmcmVzaCBuZXh0IHRpY2sgKGFsbG93IG5ldHdvcmsgdGltZSB0byB3YWtlIHVwIGFsc28pCiAgICB0aGlzLl9sYXN0SG9zdCA9IG51bGwgLy8gY2xlYXIgbmV0d29yayBjYWNoZSBjaGVjawoKICAgIGlmICh0aGlzLmFkYXB0aXZlKSB7CiAgICAgIC8vIFRPRE86IHJlLWVuYWJsZSB0aGlzIGFzIHNvb24gYXMgd2UgZmluZCBvdXQgd2h5IHRoaXMgaXMgb3ZlciB0cmlnZ2VyaW5nIGluIHNvbWUgZWRnZSBjYXNlcwogICAgICAvLyB0aGlzLmZpcmV3YWxsZWQgPSB0cnVlCiAgICAgIC8vIHRoaXMuaW8uZmlyZXdhbGxlZCA9IHRydWUKCiAgICAgIGlmICghdGhpcy5lcGhlbWVyYWwpIHsKICAgICAgICB0aGlzLmVwaGVtZXJhbCA9IHRydWUKICAgICAgICB0aGlzLmlvLmVwaGVtZXJhbCA9IHRydWUKICAgICAgICB0aGlzLmVtaXQoJ2VwaGVtZXJhbCcpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmVtaXQoJ3dha2V1cCcpCiAgfQoKICBfb25mdWxscm93KG5ld05vZGUsIHJvdykgewogICAgaWYgKCF0aGlzLmJvb3RzdHJhcHBlZCB8fCB0aGlzLl9yZXBpbmdpbmcgPj0gMykgcmV0dXJuCgogICAgbGV0IG9sZGVzdCA9IG51bGwKICAgIGZvciAoY29uc3Qgbm9kZSBvZiByb3cubm9kZXMpIHsKICAgICAgaWYgKG5vZGUucGluZ2VkID09PSB0aGlzLl90aWNrKSBjb250aW51ZQogICAgICBpZiAoCiAgICAgICAgb2xkZXN0ID09PSBudWxsIHx8CiAgICAgICAgb2xkZXN0LnBpbmdlZCA+IG5vZGUucGluZ2VkIHx8CiAgICAgICAgKG9sZGVzdC5waW5nZWQgPT09IG5vZGUucGluZ2VkICYmIG9sZGVzdC5hZGRlZCA+IG5vZGUuYWRkZWQpCiAgICAgICkgewogICAgICAgIG9sZGVzdCA9IG5vZGUKICAgICAgfQogICAgfQoKICAgIGlmIChvbGRlc3QgPT09IG51bGwpIHJldHVybgogICAgaWYgKHRoaXMuX3RpY2sgLSBvbGRlc3QucGluZ2VkIDwgUkVDRU5UX05PREUgJiYgdGhpcy5fdGljayAtIG9sZGVzdC5hZGRlZCA+IE9MRF9OT0RFKSByZXR1cm4KCiAgICB0aGlzLl9yZXBpbmdBbmRTd2FwKG5ld05vZGUsIG9sZGVzdCkKICB9CgogIF9vbm5ldHdvcmtjaGFuZ2UoaW50ZXJmYWNlcykgewogICAgdGhpcy5lbWl0KCduZXR3b3JrLWNoYW5nZScsIGludGVyZmFjZXMpCiAgICB0aGlzLmVtaXQoJ25ldHdvcmstdXBkYXRlJykKICB9CgogIF9yZXBpbmdBbmRTd2FwKG5ld05vZGUsIG9sZE5vZGUpIHsKICAgIGNvbnN0IHNlbGYgPSB0aGlzCiAgICBjb25zdCBsYXN0U2VlbiA9IG9sZE5vZGUuc2VlbgoKICAgIG9sZE5vZGUucGluZ2VkID0gdGhpcy5fdGljawoKICAgIHRoaXMuX3JlcGluZ2luZysrCiAgICB0aGlzLl9yZXF1ZXN0KAogICAgICB7IGlkOiBudWxsLCBob3N0OiBvbGROb2RlLmhvc3QsIHBvcnQ6IG9sZE5vZGUucG9ydCB9LAogICAgICBmYWxzZSwKICAgICAgdHJ1ZSwKICAgICAgUElORywKICAgICAgbnVsbCwKICAgICAgbnVsbCwKICAgICAgbnVsbCwKICAgICAgb25zdWNjZXNzLAogICAgICBvbnN3YXAKICAgICkKCiAgICBmdW5jdGlvbiBvbnN1Y2Nlc3MobSkgewogICAgICBpZiAob2xkTm9kZS5zZWVuIDw9IGxhc3RTZWVuKSByZXR1cm4gb25zd2FwKCkKICAgICAgc2VsZi5fcmVwaW5naW5nLS0KICAgIH0KCiAgICBmdW5jdGlvbiBvbnN3YXAoZSkgewogICAgICBzZWxmLl9yZXBpbmdpbmctLQogICAgICBzZWxmLl9yZW1vdmVOb2RlKG9sZE5vZGUpCiAgICAgIHNlbGYuX2FkZE5vZGUobmV3Tm9kZSkKICAgIH0KICB9CgogIF9vbnJlcXVlc3QocmVxLCBleHRlcm5hbCkgewogICAgaWYgKHJlcS5mcm9tLmlkICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX2FkZE5vZGVGcm9tTmV0d29yayghZXh0ZXJuYWwsIHJlcS5mcm9tLCByZXEudG8pCiAgICB9CgogICAgaWYgKHJlcS5pbnRlcm5hbCkgewogICAgICBzd2l0Y2ggKHJlcS5jb21tYW5kKSB7CiAgICAgICAgLy8gc3RhbmRhcmQga2VlcCBhbGl2ZSBjYWxsCiAgICAgICAgY2FzZSBQSU5HOiB7CiAgICAgICAgICByZXEuc2VuZFJlcGx5KDAsIG51bGwsIGZhbHNlLCBmYWxzZSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICAvLyBjaGVjayBpZiB0aGUgb3RoZXIgc2lkZSBjYW4gcmVjZWl2ZSBhIG1lc3NhZ2UgdG8gdGhlaXIgb3RoZXIgc29ja2V0CiAgICAgICAgY2FzZSBQSU5HX05BVDogewogICAgICAgICAgaWYgKHJlcS52YWx1ZSA9PT0gbnVsbCB8fCByZXEudmFsdWUuYnl0ZUxlbmd0aCA8IDIpIHJldHVybgogICAgICAgICAgY29uc3QgcG9ydCA9IGMudWludDE2LmRlY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IDIsIGJ1ZmZlcjogcmVxLnZhbHVlIH0pCiAgICAgICAgICBpZiAocG9ydCA9PT0gMCkgcmV0dXJuCiAgICAgICAgICByZXEuZnJvbS5wb3J0ID0gcG9ydAogICAgICAgICAgcmVxLnNlbmRSZXBseSgwLCBudWxsLCBmYWxzZSwgZmFsc2UpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgLy8gZW1wdHkgZGh0IHJlcGx5IGJhY2sKICAgICAgICBjYXNlIEZJTkRfTk9ERTogewogICAgICAgICAgaWYgKCFyZXEudGFyZ2V0KSByZXR1cm4KICAgICAgICAgIHJlcS5zZW5kUmVwbHkoMCwgbnVsbCwgZmFsc2UsIHRydWUpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgLy8gInRoaXMgaXMgbm9kZSB5b3Ugc2VudCBtZSBpcyBkb3duIiAtIGxldCdzIHRyeSB0byBwaW5nIGl0CiAgICAgICAgY2FzZSBET1dOX0hJTlQ6IHsKICAgICAgICAgIGlmIChyZXEudmFsdWUgPT09IG51bGwgfHwgcmVxLnZhbHVlLmJ5dGVMZW5ndGggPCA2KSByZXR1cm4KICAgICAgICAgIGlmICh0aGlzLl9jaGVja3MgPCAxMCkgewogICAgICAgICAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKFRNUCwgcmVxLnZhbHVlLnN1YmFycmF5KDAsIDYpKQogICAgICAgICAgICBjb25zdCBub2RlID0gdGhpcy50YWJsZS5nZXQoVE1QKQogICAgICAgICAgICBpZiAobm9kZSAmJiAobm9kZS5waW5nZWQgPCB0aGlzLl90aWNrIHx8IG5vZGUuZG93bkhpbnRzID09PSAwKSkgewogICAgICAgICAgICAgIG5vZGUuZG93bkhpbnRzKysKICAgICAgICAgICAgICB0aGlzLl9jaGVjayhub2RlKQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXEuc2VuZFJlcGx5KDAsIG51bGwsIGZhbHNlLCBmYWxzZSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgfQoKICAgICAgcmVxLnNlbmRSZXBseShVTktOT1dOX0NPTU1BTkQsIG51bGwsIGZhbHNlLCByZXEudGFyZ2V0ICE9PSBudWxsKQogICAgICByZXR1cm4KICAgIH0KCiAgICAvLyBhc2sgdGhlIHVzZXIgdG8gaGFuZGxlIGl0IG9yIHJlcGx5IGJhY2sgd2l0aCBhIGJhZCBjb21tYW5kCiAgICBpZiAodGhpcy5vbnJlcXVlc3QocmVxKSA9PT0gZmFsc2UpIHsKICAgICAgcmVxLnNlbmRSZXBseShVTktOT1dOX0NPTU1BTkQsIG51bGwsIGZhbHNlLCByZXEudGFyZ2V0ICE9PSBudWxsKQogICAgfQogIH0KCiAgb25yZXF1ZXN0KHJlcSkgewogICAgcmV0dXJuIHRoaXMuZW1pdCgncmVxdWVzdCcsIHJlcSkKICB9CgogIF9vbnJlc3BvbnNlKHJlcywgZXh0ZXJuYWwpIHsKICAgIHRoaXMuX2FkZE5vZGVGcm9tTmV0d29yayghZXh0ZXJuYWwsIHJlcy5mcm9tLCByZXMudG8pCiAgfQoKICBfb250aW1lb3V0KHJlcSkgewogICAgaWYgKCFyZXEudG8uaWQpIHJldHVybgogICAgY29uc3Qgbm9kZSA9IHRoaXMudGFibGUuZ2V0KHJlcS50by5pZCkKICAgIGlmIChub2RlKSB0aGlzLl9yZW1vdmVOb2RlKG5vZGUpCiAgfQoKICBfcGluZ1NvbWUoKSB7CiAgICBsZXQgY250ID0gdGhpcy5pby5pbmZsaWdodC5sZW5ndGggPiAyID8gMyA6IDUKICAgIGxldCBvbGRlc3QgPSB0aGlzLm5vZGVzLm9sZGVzdAoKICAgIC8vIHRpbnkgZGh0LCBwaW5nZWQgdGhlIGJvb3RzdHJhcCBhZ2FpbgogICAgaWYgKCFvbGRlc3QpIHsKICAgICAgdGhpcy5yZWZyZXNoKCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gd2UndmUgcmVjZW50bHkgcGluZ2VkIHRoZSBvbGRlc3Qgb25lLCBzbyBvbmx5IHRyaWdnZXIgYSBjb3VwbGUgb2YgcmVwaW5ncwogICAgaWYgKHRoaXMuX3RpY2sgLSBvbGRlc3QucGluZ2VkIDwgUkVDRU5UX05PREUpIHsKICAgICAgY250ID0gMgogICAgfQoKICAgIHdoaWxlIChjbnQtLSkgewogICAgICBpZiAoIW9sZGVzdCB8fCB0aGlzLl90aWNrID09PSBvbGRlc3QucGluZ2VkKSBjb250aW51ZQogICAgICB0aGlzLl9jaGVjayhvbGRlc3QpCiAgICAgIG9sZGVzdCA9IG9sZGVzdC5uZXh0CiAgICB9CiAgfQoKICBfY2hlY2sobm9kZSkgewogICAgbm9kZS5waW5nZWQgPSB0aGlzLl90aWNrCgogICAgY29uc3QgbGFzdFNlZW4gPSBub2RlLnNlZW4KICAgIGNvbnN0IG9ucmVzcG9uc2UgPSAoKSA9PiB7CiAgICAgIHRoaXMuX2NoZWNrcy0tCiAgICAgIHRoaXMuX3JlbW92ZVN0YWxlTm9kZShub2RlLCBsYXN0U2VlbikKICAgIH0KICAgIGNvbnN0IG9uZXJyb3IgPSAoKSA9PiB7CiAgICAgIHRoaXMuX2NoZWNrcy0tCiAgICAgIHRoaXMuX3JlbW92ZU5vZGUobm9kZSkKICAgIH0KCiAgICB0aGlzLl9jaGVja3MrKwogICAgdGhpcy5fcmVxdWVzdCgKICAgICAgeyBpZDogbnVsbCwgaG9zdDogbm9kZS5ob3N0LCBwb3J0OiBub2RlLnBvcnQgfSwKICAgICAgZmFsc2UsCiAgICAgIHRydWUsCiAgICAgIFBJTkcsCiAgICAgIG51bGwsCiAgICAgIG51bGwsCiAgICAgIG51bGwsCiAgICAgIG9ucmVzcG9uc2UsCiAgICAgIG9uZXJyb3IKICAgICkKICB9CgogIF9vbnRpY2soKSB7CiAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKQoKICAgIGlmICh0aW1lIC0gdGhpcy5fbGFzdFRpY2sgPiBTTEVFUElOR19JTlRFUlZBTCAmJiB0aGlzLnN1c3BlbmRlZCA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5fb253YWtldXAoKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fdGljaysrCiAgICB9CgogICAgdGhpcy5fbGFzdFRpY2sgPSB0aW1lCgogICAgaWYgKCF0aGlzLmJvb3RzdHJhcHBlZCB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCgogICAgaWYgKHRoaXMuYWRhcHRpdmUgJiYgdGhpcy5lcGhlbWVyYWwgJiYgLS10aGlzLl9zdGFibGVUaWNrcyA8PSAwKSB7CiAgICAgIGlmICh0aGlzLl9sYXN0SG9zdCA9PT0gdGhpcy5fbmF0Lmhvc3QpIHsKICAgICAgICAvLyBkbyBub3QgcmVjaGVjayB0aGUgc2FtZSBuZXR3b3JrLi4uCiAgICAgICAgdGhpcy5fc3RhYmxlVGlja3MgPSBNT1JFX1NUQUJMRV9USUNLUwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3VwZGF0ZU5ldHdvcmtTdGF0ZSgpIC8vIHRoZSBwcm9taXNlIHJldHVybmVkIGhlcmUgbmV2ZXIgZmFpbHMgc28ganVzdCBpZ25vcmUgaXQKICAgICAgfQogICAgfQoKICAgIGlmICgodGhpcy5fdGljayAmIDcpID09PSAwKSB7CiAgICAgIHRoaXMuX3BpbmdTb21lKCkKICAgIH0KCiAgICBpZiAoCiAgICAgICgodGhpcy5fdGljayAmIDYzKSA9PT0gMCAmJiB0aGlzLm5vZGVzLmxlbmd0aCA8IHRoaXMudGFibGUuaykgfHwKICAgICAgLS10aGlzLl9yZWZyZXNoVGlja3MgPD0gMAogICAgKSB7CiAgICAgIHRoaXMucmVmcmVzaCgpCiAgICB9CiAgfQoKICBhc3luYyBfdXBkYXRlTmV0d29ya1N0YXRlKG9ubHlGaXJld2FsbCA9IGZhbHNlKSB7CiAgICBpZiAoIXRoaXMuZXBoZW1lcmFsKSByZXR1cm4gZmFsc2UKICAgIGlmIChvbmx5RmlyZXdhbGwgJiYgIXRoaXMuZmlyZXdhbGxlZCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgeyBob3N0LCBwb3J0IH0gPSB0aGlzLl9uYXQKCiAgICBpZiAoIW9ubHlGaXJld2FsbCkgewogICAgICAvLyByZW1lbWJlciB3aGF0IGhvc3Qgd2UgY2hlY2tlZCBhbmQgcmVzZXQgdGhlIGNvdW50ZXIKICAgICAgdGhpcy5fc3RhYmxlVGlja3MgPSBNT1JFX1NUQUJMRV9USUNLUwogICAgICB0aGlzLl9sYXN0SG9zdCA9IGhvc3QKICAgIH0KCiAgICAvLyBjaGVjayBpZiB3ZSBoYXZlIGEgY29uc2lzdGVudCBob3N0IGFuZCBwb3J0CiAgICBpZiAoaG9zdCA9PT0gbnVsbCB8fCBwb3J0ID09PSAwKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnN0IG5hdFNhbXBsZXIgPSB0aGlzLmZpcmV3YWxsZWQgPyBuZXcgTmF0U2FtcGxlcigpIDogdGhpcy5fbmF0CgogICAgLy8gYXNrIHJlbW90ZSBub2RlcyB0byBwaW5nIHVzIG9uIG91ciBzZXJ2ZXIgc29ja2V0IHRvIHNlZSBpZiB3ZSBoYXZlIHRoZSBwb3J0IG9wZW4KICAgIGNvbnN0IGZpcmV3YWxsZWQgPSB0aGlzLmZpcmV3YWxsZWQgJiYgKGF3YWl0IHRoaXMuX2NoZWNrSWZGaXJld2FsbGVkKG5hdFNhbXBsZXIpKQogICAgaWYgKGZpcmV3YWxsZWQpIHJldHVybiBmYWxzZQoKICAgIHRoaXMuZmlyZXdhbGxlZCA9IHRoaXMuaW8uZmlyZXdhbGxlZCA9IGZhbHNlCgogICAgLy8gaW5jYXNlIGl0J3MgY2FsbGVkIGluIHBhcmFsbGVsIGZvciBzb21lIHJlYXNvbiwgb3IgaWYgb3VyIG5hdCBzdGF0dXMgc29tZWhvdyBjaGFuZ2VkCiAgICBpZiAoIXRoaXMuZXBoZW1lcmFsIHx8IGhvc3QgIT09IHRoaXMuX25hdC5ob3N0IHx8IHBvcnQgIT09IHRoaXMuX25hdC5wb3J0KSByZXR1cm4gZmFsc2UKICAgIC8vIGlmIHRoZSBmaXJld2FsbCBwcm9iZSByZXR1cm5lZCBhIGRpZmZlcmVudCBob3N0IC8gbm9uIGNvbnNpc3RlbnQgcG9ydCwgYmFpbCBhcyB3ZWxsCiAgICBpZiAobmF0U2FtcGxlci5ob3N0ICE9PSBob3N0IHx8IG5hdFNhbXBsZXIucG9ydCA9PT0gMCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgaWQgPSBwZWVyLmlkKG5hdFNhbXBsZXIuaG9zdCwgbmF0U2FtcGxlci5wb3J0KQoKICAgIGlmICghb25seUZpcmV3YWxsKSB7CiAgICAgIHRoaXMuZXBoZW1lcmFsID0gdGhpcy5pby5lcGhlbWVyYWwgPSBmYWxzZQogICAgfQoKICAgIGlmIChuYXRTYW1wbGVyICE9PSB0aGlzLl9uYXQpIHsKICAgICAgY29uc3QgcHJldkhvc3QgPSB0aGlzLl9uYXQuaG9zdAogICAgICBjb25zdCBwcmV2UG9ydCA9IHRoaXMuX25hdC5wb3J0CgogICAgICB0aGlzLl9ub25lUGVyc2lzdGVudFNhbXBsZXMgPSBbXQogICAgICB0aGlzLl9uYXQgPSBuYXRTYW1wbGVyCgogICAgICBpZiAocHJldkhvc3QgIT09IHRoaXMuX25hdC5ob3N0IHx8IHByZXZQb3J0ICE9PSB0aGlzLl9uYXQucG9ydCkgewogICAgICAgIHRoaXMuZW1pdCgnbmF0LXVwZGF0ZScsIHRoaXMuX25hdC5ob3N0LCB0aGlzLl9uYXQucG9ydCkKICAgICAgfQogICAgfQoKICAgIC8vIFRPRE86IHdlIHNob3VsZCBtYWtlIHRoaXMgYSBiaXQgbW9yZSBkZWZlbnNpdmUgaW4gdGVybXMgb2YgdXNpbmcgbW9yZQogICAgLy8gcmVzb3VyY2VzIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZSBuZXcgcm91dGluZyB0YWJsZSBjb250YWlucyBhcyBtYW55IGFsaXZlIG5vZGVzCiAgICAvLyBhcyBwb3NzaWJsZSwgdnMgYmxpbmRseSBjb3B5aW5nIHRoZW0gb3Zlci4uLgoKICAgIC8vIGFsbCBnb29kISBjb3B5IG92ZXIgdGhlIG9sZCByb3V0aW5nIHRhYmxlIHRvIHRoZSBuZXcgb25lCiAgICBpZiAoIWI0YS5lcXVhbHModGhpcy50YWJsZS5pZCwgaWQpKSB7CiAgICAgIGNvbnN0IG5vZGVzID0gdGhpcy50YWJsZS50b0FycmF5KCkKCiAgICAgIHRoaXMudGFibGUgPSB0aGlzLmlvLnRhYmxlID0gbmV3IFRhYmxlKGlkKQoKICAgICAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSB7CiAgICAgICAgaWYgKGI0YS5lcXVhbHMobm9kZS5pZCwgaWQpKSBjb250aW51ZQogICAgICAgIGlmICghdGhpcy50YWJsZS5hZGQobm9kZSkpIHRoaXMubm9kZXMucmVtb3ZlKG5vZGUpCiAgICAgIH0KCiAgICAgIHRoaXMudGFibGUub24oJ3JvdycsIHRoaXMuX29ucm93KQoKICAgICAgLy8gd2UgbmVlZCB0byByZWJvb3RzdHJhcC9yZWZyZXNoIHNpbmNlIHdlIHVwZGF0ZWQgb3VyIGlkCiAgICAgIGlmICh0aGlzLmJvb3RzdHJhcHBlZCkgdGhpcy5yZWZyZXNoKCkKICAgIH0KCiAgICBpZiAoIXRoaXMuZXBoZW1lcmFsKSB7CiAgICAgIHRoaXMuZW1pdCgncGVyc2lzdGVudCcpCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jICpfcmVzb2x2ZUJvb3RzdHJhcE5vZGVzKCkgewogICAgZm9yIChsZXQgeyBob3N0LCBwb3J0IH0gb2YgdGhpcy5ib290c3RyYXBOb2RlcykgewogICAgICBsZXQgZG9Mb29rdXAgPSBmYWxzZQoKICAgICAgaWYgKGhvc3QuaW5kZXhPZignQCcpID09PSAtMSkgewogICAgICAgIGRvTG9va3VwID0gdHJ1ZQogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IFtzdWdnZXN0ZWRJUCwgZmFsbGJhY2tIb3N0XSA9IGhvc3Quc3BsaXQoJ0AnKQogICAgICAgIHRyeSB7CiAgICAgICAgICBhd2FpdCB0aGlzLnBpbmcoeyBob3N0OiBzdWdnZXN0ZWRJUCwgcG9ydCB9KQogICAgICAgICAgaG9zdCA9IHN1Z2dlc3RlZElQCiAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICBob3N0ID0gZmFsbGJhY2tIb3N0CiAgICAgICAgICBkb0xvb2t1cCA9IHRydWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChkb0xvb2t1cCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBob3N0ID0gVURYLmlzSVB2NChob3N0KSA/IGhvc3QgOiAoYXdhaXQgdGhpcy51ZHgubG9va3VwKGhvc3QsIHsgZmFtaWx5OiA0IH0pKS5ob3N0CiAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAgICAgfQoKICAgICAgeWllbGQgewogICAgICAgIGlkOiBwZWVyLmlkKGhvc3QsIHBvcnQpLAogICAgICAgIGhvc3QsCiAgICAgICAgcG9ydAogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBfYWRkQm9vdHN0cmFwTm9kZXMobm9kZXMpIHsKICAgIGZvciBhd2FpdCAoY29uc3Qgbm9kZSBvZiB0aGlzLl9yZXNvbHZlQm9vdHN0cmFwTm9kZXMoKSkgewogICAgICBub2Rlcy5wdXNoKG5vZGUpCiAgICB9CiAgfQoKICBhc3luYyBfY2hlY2tJZkZpcmV3YWxsZWQobmF0U2FtcGxlciA9IG5ldyBOYXRTYW1wbGVyKCkpIHsKICAgIGNvbnN0IG5vZGVzID0gW10KICAgIGZvciAobGV0IG5vZGUgPSB0aGlzLm5vZGVzLmxhdGVzdDsgbm9kZSAmJiBub2Rlcy5sZW5ndGggPCA1OyBub2RlID0gbm9kZS5wcmV2KSB7CiAgICAgIG5vZGVzLnB1c2gobm9kZSkKICAgIH0KCiAgICBpZiAobm9kZXMubGVuZ3RoIDwgNSkgYXdhaXQgdGhpcy5fYWRkQm9vdHN0cmFwTm9kZXMobm9kZXMpCiAgICAvLyBpZiBubyBub2RlcyBhcmUgYXZhaWxhYmxlLCBpbmNsdWRpbmcgYm9vdHN0cmFwcGVycyAtIGJhaWwKICAgIGlmIChub2Rlcy5sZW5ndGggPT09IDApIHJldHVybiB0cnVlCgogICAgY29uc3QgaG9zdHMgPSBuZXcgU2V0KCkKICAgIGNvbnN0IHZhbHVlID0gYjRhLmFsbG9jVW5zYWZlKDIpCgogICAgYy51aW50MTYuZW5jb2RlKHsgc3RhcnQ6IDAsIGVuZDogMiwgYnVmZmVyOiB2YWx1ZSB9LCB0aGlzLmlvLnNlcnZlclNvY2tldC5hZGRyZXNzKCkucG9ydCkKCiAgICAvLyBkb3VibGUgY2hlY2sgdGhleSBhY3R1YWxseSBjYW1lIG9uIHRoZSBzZXJ2ZXIgc29ja2V0Li4uCiAgICB0aGlzLmlvLnNlcnZlclNvY2tldC5vbignbWVzc2FnZScsIG9ubWVzc2FnZSkKCiAgICBjb25zdCBwb25ncyA9IGF3YWl0IHJlcXVlc3RBbGwodGhpcywgdHJ1ZSwgUElOR19OQVQsIHZhbHVlLCBub2RlcykKCiAgICBsZXQgY291bnQgPSAwCiAgICBmb3IgKGNvbnN0IHJlcyBvZiBwb25ncykgewogICAgICBpZiAoaG9zdHMuaGFzKHJlcy5mcm9tLmhvc3QpKSB7CiAgICAgICAgY291bnQrKwogICAgICAgIG5hdFNhbXBsZXIuYWRkKHJlcy50by5ob3N0LCByZXMudG8ucG9ydCkKICAgICAgfQogICAgfQoKICAgIHRoaXMuaW8uc2VydmVyU29ja2V0LnJlbW92ZUxpc3RlbmVyKCdtZXNzYWdlJywgb25tZXNzYWdlKQoKICAgIC8vIGlmIHdlIGdvdCBubyBvciB2ZXJ5IGZldyByZXBsaWVzLCBjb25zaWRlciBpdCBhIGZsdWtlCiAgICBpZiAoY291bnQgPCAobm9kZXMubGVuZ3RoID49IDUgPyAzIDogMSkpIHJldHVybiB0cnVlCgogICAgLy8gY2hlY2sgdGhhdCB0aGUgc2VydmVyIHNvY2tldCBoYXMgdGhlIHNhbWUgaXAgYXMgdGhlIGNsaWVudCBzb2NrZXQKICAgIGlmIChuYXRTYW1wbGVyLmhvc3QgPT09IG51bGwgfHwgdGhpcy5fbmF0Lmhvc3QgIT09IG5hdFNhbXBsZXIuaG9zdCkgcmV0dXJuIHRydWUKCiAgICAvLyBjaGVjayB0aGF0IHRoZSBsb2NhbCBwb3J0IG9mIHRoZSBzZXJ2ZXIgc29ja2V0IGlzIHRoZSBzYW1lIGFzIHRoZSByZW1vdGUgcG9ydAogICAgLy8gVE9ETzogd2UgbWlnaHQgd2FudCBhIGZsYWcgdG8gb3B0IG91dCBvZiB0aGlzIGhldXJpc3RpYyBmb3Igc3BlY2lmaWMgcmVtYXBwZWQgcG9ydCBzZXJ2ZXJzCiAgICBpZiAobmF0U2FtcGxlci5wb3J0ID09PSAwIHx8IG5hdFNhbXBsZXIucG9ydCAhPT0gdGhpcy5pby5zZXJ2ZXJTb2NrZXQuYWRkcmVzcygpLnBvcnQpIHsKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKCiAgICBmdW5jdGlvbiBvbm1lc3NhZ2UoXywgeyBob3N0IH0pIHsKICAgICAgaG9zdHMuYWRkKGhvc3QpCiAgICB9CiAgfQoKICBfYmFja2dyb3VuZFF1ZXJ5KHRhcmdldCkgewogICAgdGhpcy5fcmVmcmVzaFRpY2tzID0gUkVGUkVTSF9USUNLUwoKICAgIGNvbnN0IGJhY2tncm91bmRDb24gPSBNYXRoLm1pbih0aGlzLmNvbmN1cnJlbmN5LCBNYXRoLm1heCgyLCAodGhpcy5jb25jdXJyZW5jeSAvIDgpIHwgMCkpCiAgICBjb25zdCBxID0gbmV3IFF1ZXJ5KHRoaXMsIHRhcmdldCwgdHJ1ZSwgRklORF9OT0RFLCBudWxsLCB7CiAgICAgIGNvbmN1cnJlbmN5OiBiYWNrZ3JvdW5kQ29uLAogICAgICBtYXhTbG93OiAwCiAgICB9KQoKICAgIHEub24oJ2RhdGEnLCAoKSA9PiB7CiAgICAgIC8vIHlpZWxkIHRvIG90aGVyIHRyYWZmaWMKICAgICAgcS5jb25jdXJyZW5jeSA9IHRoaXMuaW8uaW5mbGlnaHQubGVuZ3RoIDwgMyA/IHRoaXMuY29uY3VycmVuY3kgOiBiYWNrZ3JvdW5kQ29uCiAgICB9KQoKICAgIHJldHVybiBxCiAgfQoKICAvLyBjYWxsZWQgYnkgdGhlIHF1ZXJ5CiAgX29ubGluZSgpIHsKICAgIGlmICh0aGlzLm9ubGluZSkgcmV0dXJuCiAgICB0aGlzLm9ubGluZSA9IHRydWUKICAgIHRoaXMuZW1pdCgnbmV0d29yay11cGRhdGUnKQogIH0KCiAgLy8gY2FsbGVkIGJ5IHRoZSBxdWVyeQogIF9vZmZsaW5lKCkgewogICAgaWYgKCF0aGlzLm9ubGluZSkgcmV0dXJuCiAgICB0aGlzLm9ubGluZSA9IGZhbHNlCiAgICB0aGlzLmVtaXQoJ25ldHdvcmstdXBkYXRlJykKICB9Cn0KCkRIVC5PSyA9IDAKREhULkVSUk9SX1VOS05PV05fQ09NTUFORCA9IFVOS05PV05fQ09NTUFORApESFQuRVJST1JfSU5WQUxJRF9UT0tFTiA9IElOVkFMSURfVE9LRU4KCm1vZHVsZS5leHBvcnRzID0gREhUCgpmdW5jdGlvbiBsb2NhbElQKHVkeCwgZmFtaWx5ID0gNCkgewogIGxldCBob3N0ID0gbnVsbAoKICBmb3IgKGNvbnN0IG4gb2YgdWR4Lm5ldHdvcmtJbnRlcmZhY2VzKCkpIHsKICAgIGlmIChuLmZhbWlseSAhPT0gZmFtaWx5IHx8IG4uaW50ZXJuYWwpIGNvbnRpbnVlCgogICAgLy8gbWFjIHJlYWxseSBsaWtlcyBlbjAsIG1iIGEgYmV0dGVyIHdheSBidXQgdGhpcyBzaG91bGRudCBiZSBiYWQgYW55d2hlcmUgc28gcmV0dXJuIG5vdwogICAgaWYgKG4ubmFtZSA9PT0gJ2VuMCcpIHJldHVybiBuLmhvc3QKCiAgICAvLyBvdGhlcndpc2UgcGljayB0aGUgZmlyc3Qgbm9uIGludGVybmFsIGhvc3QgKGxldCB0aGUgbG9vcCBjb250aW51ZSBpbiBjYXNlIHdlIHNlZSBlbjApCiAgICBpZiAoaG9zdCA9PT0gbnVsbCkgaG9zdCA9IG4uaG9zdAogIH0KCiAgcmV0dXJuIGhvc3QgfHwgKGZhbWlseSA9PT0gNCA/ICcxMjcuMC4wLjEnIDogJzo6MScpCn0KCmZ1bmN0aW9uIHBhcnNlTm9kZShzKSB7CiAgaWYgKHR5cGVvZiBzID09PSAnb2JqZWN0JykgcmV0dXJuIHMKICBpZiAodHlwZW9mIHMgPT09ICdudW1iZXInKSByZXR1cm4geyBob3N0OiAnMTI3LjAuMC4xJywgcG9ydDogcyB9CiAgY29uc3QgW2hvc3QsIHBvcnRdID0gcy5zcGxpdCgnOicpCiAgaWYgKCFwb3J0KSB0aHJvdyBuZXcgRXJyb3IoJ0Jvb3RzdHJhcCBub2RlIGZvcm1hdCBpcyBob3N0OnBvcnQnKQoKICByZXR1cm4gewogICAgaG9zdCwKICAgIHBvcnQ6IE51bWJlcihwb3J0KQogIH0KfQoKZnVuY3Rpb24gcmFuZG9tQnl0ZXMobikgewogIGNvbnN0IGIgPSBiNGEuYWxsb2MobikKICBzb2RpdW0ucmFuZG9tYnl0ZXNfYnVmKGIpCiAgcmV0dXJuIGIKfQoKZnVuY3Rpb24gcmFuZG9tT2Zmc2V0KG4pIHsKICByZXR1cm4gbiAtICgoTWF0aC5yYW5kb20oKSAqIDAuNSAqIG4pIHwgMCkKfQoKZnVuY3Rpb24gcmVxdWVzdEFsbChkaHQsIGludGVybmFsLCBjb21tYW5kLCB2YWx1ZSwgbm9kZXMpIHsKICBsZXQgbWlzc2luZyA9IG5vZGVzLmxlbmd0aAogIGNvbnN0IHJlcGxpZXMgPSBbXQoKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgIGZvciAoY29uc3Qgbm9kZSBvZiBub2RlcykgewogICAgICBjb25zdCByZXEgPSBkaHQuX3JlcXVlc3QoCiAgICAgICAgbm9kZSwKICAgICAgICBmYWxzZSwKICAgICAgICBpbnRlcm5hbCwKICAgICAgICBjb21tYW5kLAogICAgICAgIG51bGwsCiAgICAgICAgdmFsdWUsCiAgICAgICAgbnVsbCwKICAgICAgICBvbnN1Y2Nlc3MsCiAgICAgICAgb25lcnJvcgogICAgICApCiAgICAgIGlmICghcmVxKSByZXR1cm4gcmVzb2x2ZShyZXBsaWVzKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uc3VjY2VzcyhyZXMpIHsKICAgICAgcmVwbGllcy5wdXNoKHJlcykKICAgICAgaWYgKC0tbWlzc2luZyA9PT0gMCkgcmVzb2x2ZShyZXBsaWVzKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uZXJyb3IoKSB7CiAgICAgIGlmICgtLW1pc3NpbmcgPT09IDApIHJlc29sdmUocmVwbGllcykKICAgIH0KICB9KQp9CgpmdW5jdGlvbiBub29wKCkge30KZXhwb3J0cy5QSU5HID0gMApleHBvcnRzLlBJTkdfTkFUID0gMQpleHBvcnRzLkZJTkRfTk9ERSA9IDIKZXhwb3J0cy5ET1dOX0hJTlQgPSAzCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgREhURXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobXNnLCBjb2RlLCBmbiA9IERIVEVycm9yKSB7CiAgICBzdXBlcihgJHtjb2RlfTogJHttc2d9YCkKICAgIHRoaXMuY29kZSA9IGNvZGUKCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgZm4pCiAgICB9CiAgfQoKICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiAnREhURXJyb3InCiAgfQoKICBzdGF0aWMgVU5LTk9XTl9DT01NQU5EID0gMQogIHN0YXRpYyBJTlZBTElEX1RPS0VOID0gMgoKICBzdGF0aWMgUkVRVUVTVF9USU1FT1VUKG1zZyA9ICdSZXF1ZXN0IHRpbWVkIG91dCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnUkVRVUVTVF9USU1FT1VUJywgREhURXJyb3IuUkVRVUVTVF9USU1FT1VUKQogIH0KCiAgc3RhdGljIFJFUVVFU1RfREVTVFJPWUVEKG1zZyA9ICdSZXF1ZXN0IGRlc3Ryb3llZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnUkVRVUVTVF9ERVNUUk9ZRUQnLCBESFRFcnJvci5SRVFVRVNUX0RFU1RST1lFRCkKICB9CgogIHN0YXRpYyBJT19TVVNQRU5ERUQobXNnID0gJ0kvTyBzdXNwZW5kZWQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0lPX1NVU1BFTkRFRCcsIERIVEVycm9yLklPX1NVU1BFTkRFRCkKICB9Cn0KY29uc3QgRklGTyA9IHJlcXVpcmUoJ2Zhc3QtZmlmbycpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHBlZXIgPSByZXF1aXJlKCcuL3BlZXInKQpjb25zdCB7IElOVkFMSURfVE9LRU4sIFJFUVVFU1RfVElNRU9VVCwgUkVRVUVTVF9ERVNUUk9ZRUQsIElPX1NVU1BFTkRFRCB9ID0gcmVxdWlyZSgnLi9lcnJvcnMnKQoKY29uc3QgVkVSU0lPTiA9IDBiMTEKY29uc3QgUkVTUE9OU0VfSUQgPSAoMGIwMDAxIDw8IDQpIHwgVkVSU0lPTgpjb25zdCBSRVFVRVNUX0lEID0gKDBiMDAwMCA8PCA0KSB8IFZFUlNJT04KY29uc3QgRU1QVFlfQVJSQVkgPSBbXQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBJTyB7CiAgY29uc3RydWN0b3IoCiAgICB0YWJsZSwKICAgIHVkeCwKICAgIHsKICAgICAgbWF4V2luZG93ID0gODAsCiAgICAgIHBvcnQgPSAwLAogICAgICBob3N0ID0gJzAuMC4wLjAnLAogICAgICBhbnlQb3J0ID0gdHJ1ZSwKICAgICAgZmlyZXdhbGxlZCA9IHRydWUsCiAgICAgIG9ucmVxdWVzdCwKICAgICAgb25yZXNwb25zZSA9IG5vb3AsCiAgICAgIG9udGltZW91dCA9IG5vb3AKICAgIH0gPSB7fQogICkgewogICAgdGhpcy50YWJsZSA9IHRhYmxlCiAgICB0aGlzLnVkeCA9IHVkeAogICAgdGhpcy5pbmZsaWdodCA9IFtdCiAgICB0aGlzLmNsaWVudFNvY2tldCA9IG51bGwKICAgIHRoaXMuc2VydmVyU29ja2V0ID0gbnVsbAogICAgdGhpcy5maXJld2FsbGVkID0gZmlyZXdhbGxlZCAhPT0gZmFsc2UKICAgIHRoaXMuZXBoZW1lcmFsID0gdHJ1ZQogICAgdGhpcy5jb25nZXN0aW9uID0gbmV3IENvbmdlc3Rpb25XaW5kb3cobWF4V2luZG93KQogICAgdGhpcy5uZXR3b3JrSW50ZXJmYWNlcyA9IHVkeC53YXRjaE5ldHdvcmtJbnRlcmZhY2VzKCkKICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKCiAgICB0aGlzLnN0YXRzID0gewogICAgICByZXF1ZXN0czogeyBhY3RpdmU6IDAsIHRvdGFsOiAwIH0sCiAgICAgIGNvbW1hbmRzOiBbCiAgICAgICAgeyB0eDogMCwgcng6IDAgfSwgLy8gdHggPSB0cmFuc21pdHRlZCwgcnggPSByZWNlaXZlZAogICAgICAgIHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgICAgeyB0eDogMCwgcng6IDAgfSwKICAgICAgICB7IHR4OiAwLCByeDogMCB9CiAgICAgIF0KICAgIH0KCiAgICB0aGlzLm9ucmVxdWVzdCA9IG9ucmVxdWVzdAogICAgdGhpcy5vbnJlc3BvbnNlID0gb25yZXNwb25zZQogICAgdGhpcy5vbnRpbWVvdXQgPSBvbnRpbWVvdXQKCiAgICB0aGlzLl9wZW5kaW5nID0gbmV3IEZJRk8oKQogICAgdGhpcy5fcm90YXRlU2VjcmV0cyA9IDEwCiAgICB0aGlzLl90aWQgPSAoTWF0aC5yYW5kb20oKSAqIDY1NTM2KSB8IDAKICAgIHRoaXMuX3NlY3JldHMgPSBudWxsCiAgICB0aGlzLl9kcmFpbkludGVydmFsID0gbnVsbAogICAgdGhpcy5fZGVzdHJveWluZyA9IG51bGwKICAgIHRoaXMuX2JpbmRpbmcgPSBudWxsCgogICAgLy8gcG9ydCBjYW4gYmUgYSBudW1iZXIgb3IgYSByYW5nZSBbc3RhcnQsIHRvXQogICAgdGhpcy5wb3J0UmFuZ2UgPSBwb3J0Lmxlbmd0aCA/IHBvcnQgOiBwb3J0ID09PSAwID8gWzAsIDBdIDogW3BvcnQsIHBvcnQgKyA1XQoKICAgIHRoaXMuX2hvc3QgPSBob3N0CiAgICB0aGlzLl9hbnlQb3J0ID0gYW55UG9ydCAhPT0gZmFsc2UKICAgIHRoaXMuX2JvdW5kU2VydmVyUG9ydCA9IDAKICAgIHRoaXMuX2JvdW5kQ2xpZW50UG9ydCA9IDAKICB9CgogIG9ubWVzc2FnZShzb2NrZXQsIGJ1ZmZlciwgeyBob3N0LCBwb3J0IH0pIHsKICAgIGlmIChidWZmZXIuYnl0ZUxlbmd0aCA8IDIgfHwgIShwb3J0ID4gMCAmJiBwb3J0IDwgNjU1MzYpIHx8IHRoaXMuc3VzcGVuZGVkID09PSB0cnVlKSByZXR1cm4KCiAgICBjb25zdCBmcm9tID0geyBpZDogbnVsbCwgaG9zdCwgcG9ydCB9CiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDEsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGgsIGJ1ZmZlciB9CiAgICBjb25zdCBleHBlY3RlZFNvY2tldCA9IHRoaXMuZmlyZXdhbGxlZCA/IHRoaXMuY2xpZW50U29ja2V0IDogdGhpcy5zZXJ2ZXJTb2NrZXQKICAgIGNvbnN0IGV4dGVybmFsID0gc29ja2V0ICE9PSBleHBlY3RlZFNvY2tldAoKICAgIGlmIChidWZmZXJbMF0gPT09IFJFUVVFU1RfSUQpIHsKICAgICAgY29uc3QgcmVxID0gUmVxdWVzdC5kZWNvZGUodGhpcywgc29ja2V0LCBmcm9tLCBzdGF0ZSkKICAgICAgaWYgKHJlcSA9PT0gbnVsbCkgcmV0dXJuCiAgICAgIGlmICgKICAgICAgICByZXEudG9rZW4gIT09IG51bGwgJiYKICAgICAgICAhYjRhLmVxdWFscyhyZXEudG9rZW4sIHRoaXMudG9rZW4ocmVxLmZyb20sIDEpKSAmJgogICAgICAgICFiNGEuZXF1YWxzKHJlcS50b2tlbiwgdGhpcy50b2tlbihyZXEuZnJvbSwgMCkpCiAgICAgICkgewogICAgICAgIHJlcS5lcnJvcihJTlZBTElEX1RPS0VOLCB7IHRva2VuOiB0cnVlIH0pCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgdGhpcy5vbnJlcXVlc3QocmVxLCBleHRlcm5hbCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKGJ1ZmZlclswXSA9PT0gUkVTUE9OU0VfSUQpIHsKICAgICAgY29uc3QgcmVzID0gZGVjb2RlUmVwbHkoZnJvbSwgc3RhdGUpCiAgICAgIGlmIChyZXMgPT09IG51bGwpIHJldHVybgoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmluZmxpZ2h0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgcmVxID0gdGhpcy5pbmZsaWdodFtpXQogICAgICAgIGlmIChyZXEudGlkICE9PSByZXMudGlkKSBjb250aW51ZQoKICAgICAgICByZXMucnR0ID0gRGF0ZS5ub3coKSAtIHJlcS5fdGltZXN0YW1wCgogICAgICAgIGlmIChpID09PSB0aGlzLmluZmxpZ2h0Lmxlbmd0aCAtIDEpIHRoaXMuaW5mbGlnaHQucG9wKCkKICAgICAgICBlbHNlIHRoaXMuaW5mbGlnaHRbaV0gPSB0aGlzLmluZmxpZ2h0LnBvcCgpCgogICAgICAgIGlmIChyZXEuc2Vzc2lvbikgcmVxLnNlc3Npb24uX2RldGFjaChyZXEpCgogICAgICAgIC8vIFRPRE86IEF1dG8gcmV0cnkgaGVyZSBpZiBlcnJvcnMuSU5WQUxJRF9UT0tFTiBpcyByZXR1cm5lZD8KCiAgICAgICAgaWYgKHJlcS5fdGltZW91dCkgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHJlcS5fdGltZW91dCkKICAgICAgICAgIHJlcS5fdGltZW91dCA9IG51bGwKICAgICAgICB9CgogICAgICAgIHRoaXMuY29uZ2VzdGlvbi5yZWN2KCkKCiAgICAgICAgaWYgKHJlcS5pbnRlcm5hbCAmJiByZXEuY29tbWFuZCA8IHRoaXMuc3RhdHMuY29tbWFuZHMubGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLnN0YXRzLmNvbW1hbmRzW3JlcS5jb21tYW5kXS5yeCsrCiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0YXRzLnJlcXVlc3RzLmFjdGl2ZS0tCgogICAgICAgIHRoaXMub25yZXNwb25zZShyZXMsIGV4dGVybmFsKQogICAgICAgIHJlcS5vbnJlc3BvbnNlKHJlcywgcmVxKQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KICB9CgogIHRva2VuKGFkZHIsIGkpIHsKICAgIGlmICh0aGlzLl9zZWNyZXRzID09PSBudWxsKSB7CiAgICAgIGNvbnN0IGJ1ZiA9IGI0YS5hbGxvYyg2NCkKICAgICAgdGhpcy5fc2VjcmV0cyA9IFtidWYuc3ViYXJyYXkoMCwgMzIpLCBidWYuc3ViYXJyYXkoMzIsIDY0KV0KICAgICAgc29kaXVtLnJhbmRvbWJ5dGVzX2J1Zih0aGlzLl9zZWNyZXRzWzBdKQogICAgICBzb2RpdW0ucmFuZG9tYnl0ZXNfYnVmKHRoaXMuX3NlY3JldHNbMV0pCiAgICB9CgogICAgY29uc3QgdG9rZW4gPSBiNGEuYWxsb2NVbnNhZmUoMzIpCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKHRva2VuLCBiNGEuZnJvbShhZGRyLmhvc3QpLCB0aGlzLl9zZWNyZXRzW2ldKQogICAgcmV0dXJuIHRva2VuCiAgfQoKICBhc3luYyBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3lpbmcpIHJldHVybiB0aGlzLl9kZXN0cm95aW5nCiAgICB0aGlzLl9kZXN0cm95aW5nID0gdGhpcy5fZGVzdHJveSgpCiAgICByZXR1cm4gdGhpcy5fZGVzdHJveWluZwogIH0KCiAgYXN5bmMgX2Rlc3Ryb3koKSB7CiAgICAvLyBzaW1wbGlmaWVzIHRpbWluZyB0byBhd2FpdCB0aGUgYmluZCBoZXJlIGFsc28sIGFsdGhvdWdoIGl0IG1pZ2h0IGJlIHVubmVlZGVkCiAgICBhd2FpdCB0aGlzLmJpbmQoKQogICAgYXdhaXQgdGhpcy5fY2xlYXIoZmFsc2UpCiAgfQoKICBhc3luYyBfY2xlYXIoc3VzcGVuZGVkKSB7CiAgICBpZiAodGhpcy5fZHJhaW5JbnRlcnZhbCkgewogICAgICBjbGVhckludGVydmFsKHRoaXMuX2RyYWluSW50ZXJ2YWwpCiAgICAgIHRoaXMuX2RyYWluSW50ZXJ2YWwgPSBudWxsCiAgICB9CgogICAgd2hpbGUgKHRoaXMuaW5mbGlnaHQubGVuZ3RoKSB7CiAgICAgIGNvbnN0IHJlcSA9IHRoaXMuaW5mbGlnaHQucG9wKCkKICAgICAgaWYgKHJlcS5fdGltZW91dCkgY2xlYXJUaW1lb3V0KHJlcS5fdGltZW91dCkKICAgICAgcmVxLl90aW1lb3V0ID0gbnVsbAogICAgICByZXEuZGVzdHJveWVkID0gdHJ1ZQoKICAgICAgaWYgKHJlcS5zZXNzaW9uKSByZXEuc2Vzc2lvbi5fZGV0YWNoKHJlcSkKCiAgICAgIHRoaXMuY29uZ2VzdGlvbi5yZWN2KCkKICAgICAgdGhpcy5zdGF0cy5yZXF1ZXN0cy5hY3RpdmUtLQoKICAgICAgcmVxLm9uZXJyb3Ioc3VzcGVuZGVkID8gSU9fU1VTUEVOREVEKCkgOiBSRVFVRVNUX0RFU1RST1lFRCgpLCByZXEpCiAgICB9CgogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKFt0aGlzLnNlcnZlclNvY2tldC5jbG9zZSgpLCB0aGlzLmNsaWVudFNvY2tldC5jbG9zZSgpXSkKCiAgICB0aGlzLm5ldHdvcmtJbnRlcmZhY2VzLmRlc3Ryb3koKQogIH0KCiAgYXN5bmMgc3VzcGVuZCgpIHsKICAgIHRoaXMuc3VzcGVuZGVkID0gdHJ1ZQogICAgYXdhaXQgdGhpcy5fY2xlYXIodHJ1ZSkKCiAgICB0aGlzLmNvbmdlc3Rpb24uY2xlYXIoKQoKICAgIGlmICh0aGlzLl9kcmFpbkludGVydmFsKSB7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fZHJhaW5JbnRlcnZhbCkKICAgICAgdGhpcy5fZHJhaW5JbnRlcnZhbCA9IG51bGwKICAgIH0KICB9CgogIGFzeW5jIF9yZWJpbmQoYmluZGluZykgewogICAgaWYgKGJpbmRpbmcpIGF3YWl0IGJpbmRpbmcKICAgIGlmICh0aGlzLl9kZXN0cm95aW5nKSByZXR1cm4gdGhpcy5fZGVzdHJveWluZwogICAgYXdhaXQgdGhpcy5fYmluZFNvY2tldHMoKQogICAgdGhpcy5uZXR3b3JrSW50ZXJmYWNlcyA9IHRoaXMudWR4LndhdGNoTmV0d29ya0ludGVyZmFjZXMoKQogIH0KCiAgcmVzdW1lKCkgewogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgY29uc3QgYmluZGluZyA9IHRoaXMuX2JpbmRpbmcKICAgIHRoaXMuX2JpbmRpbmcgPSB0aGlzLl9yZWJpbmQoYmluZGluZykKICAgIHJldHVybiB0aGlzLl9iaW5kaW5nCiAgfQoKICBiaW5kKCkgewogICAgaWYgKHRoaXMuX2JpbmRpbmcpIHJldHVybiB0aGlzLl9iaW5kaW5nCiAgICB0aGlzLl9iaW5kaW5nID0gdGhpcy5fYmluZFNvY2tldHMoKQogICAgcmV0dXJuIHRoaXMuX2JpbmRpbmcKICB9CgogIGFzeW5jIF9iaW5kU29ja2V0cygpIHsKICAgIGNvbnN0IHNlcnZlclNvY2tldCA9IHRoaXMudWR4LmNyZWF0ZVNvY2tldCgpCgogICAgY29uc3QgY2FuZGlkYXRlUG9ydHMgPSBbXQoKICAgIC8vIFJldHJ5aW5nIHByZXZpb3VzIHBvcnQgYWx3YXlzIGhhcyBwcmVjZWRlbmNlCiAgICBpZiAodGhpcy5fYm91bmRTZXJ2ZXJQb3J0KSBjYW5kaWRhdGVQb3J0cy5wdXNoKHRoaXMuX2JvdW5kU2VydmVyUG9ydCkKCiAgICBmb3IgKGxldCBpID0gdGhpcy5wb3J0UmFuZ2VbMF07IGkgPCB0aGlzLnBvcnRSYW5nZVsxXTsgaSsrKSBjYW5kaWRhdGVQb3J0cy5wdXNoKGkpCgogICAgZm9yIChjb25zdCBwb3J0IG9mIGNhbmRpZGF0ZVBvcnRzKSB7CiAgICAgIGlmIChzZXJ2ZXJTb2NrZXQuYm91bmQpIGJyZWFrCgogICAgICB0cnkgewogICAgICAgIHNlcnZlclNvY2tldC5iaW5kKHBvcnQsIHRoaXMuX2hvc3QpCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmICghdGhpcy5fYW55UG9ydCkgewogICAgICAgICAgYXdhaXQgc2VydmVyU29ja2V0LmNsb3NlKCkKICAgICAgICAgIHRocm93IGVycgogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmICghc2VydmVyU29ja2V0LmJvdW5kKSB7CiAgICAgIHRyeSB7CiAgICAgICAgc2VydmVyU29ja2V0LmJpbmQoMCwgdGhpcy5faG9zdCkKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgYXdhaXQgc2VydmVyU29ja2V0LmNsb3NlKCkKICAgICAgICB0aHJvdyBlcnIKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGNsaWVudFNvY2tldCA9IHRoaXMudWR4LmNyZWF0ZVNvY2tldCgpCgogICAgdHJ5IHsKICAgICAgY2xpZW50U29ja2V0LmJpbmQodGhpcy5fYm91bmRDbGllbnRQb3J0IHx8IDAsIHRoaXMuX2hvc3QpCiAgICB9IGNhdGNoIHsKICAgICAgdHJ5IHsKICAgICAgICBjbGllbnRTb2NrZXQuYmluZCgwLCB0aGlzLl9ob3N0KQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBhd2FpdCBzZXJ2ZXJTb2NrZXQuY2xvc2UoKQogICAgICAgIGF3YWl0IGNsaWVudFNvY2tldC5jbG9zZSgpCiAgICAgICAgdGhyb3cgZXJyCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9ib3VuZFNlcnZlclBvcnQgPSBzZXJ2ZXJTb2NrZXQuYWRkcmVzcygpLnBvcnQKICAgIHRoaXMuX2JvdW5kQ2xpZW50UG9ydCA9IGNsaWVudFNvY2tldC5hZGRyZXNzKCkucG9ydAoKICAgIHRoaXMuY2xpZW50U29ja2V0ID0gY2xpZW50U29ja2V0CiAgICB0aGlzLnNlcnZlclNvY2tldCA9IHNlcnZlclNvY2tldAoKICAgIHRoaXMuc2VydmVyU29ja2V0Lm9uKCdtZXNzYWdlJywgdGhpcy5vbm1lc3NhZ2UuYmluZCh0aGlzLCB0aGlzLnNlcnZlclNvY2tldCkpCiAgICB0aGlzLmNsaWVudFNvY2tldC5vbignbWVzc2FnZScsIHRoaXMub25tZXNzYWdlLmJpbmQodGhpcywgdGhpcy5jbGllbnRTb2NrZXQpKQoKICAgIGlmICh0aGlzLl9kcmFpbkludGVydmFsID09PSBudWxsKSB7CiAgICAgIHRoaXMuX2RyYWluSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLl9kcmFpbi5iaW5kKHRoaXMpLCA3NTApCiAgICAgIGlmICh0aGlzLl9kcmFpbkludGVydmFsLnVucmVmKSB0aGlzLl9kcmFpbkludGVydmFsLnVucmVmKCkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHJlcSBvZiB0aGlzLmluZmxpZ2h0KSB7CiAgICAgIGlmICghcmVxLnNvY2tldCkgcmVxLnNvY2tldCA9IHRoaXMuZmlyZXdhbGxlZCA/IHRoaXMuY2xpZW50U29ja2V0IDogdGhpcy5zZXJ2ZXJTb2NrZXQKICAgICAgcmVxLnNlbnQgPSAwCiAgICAgIHJlcS5zZW5kKGZhbHNlKQogICAgfQogIH0KCiAgX2RyYWluKCkgewogICAgaWYgKHRoaXMuX3NlY3JldHMgIT09IG51bGwgJiYgLS10aGlzLl9yb3RhdGVTZWNyZXRzID09PSAwKSB7CiAgICAgIHRoaXMuX3JvdGF0ZVNlY3JldHMgPSAxMAogICAgICBjb25zdCB0bXAgPSB0aGlzLl9zZWNyZXRzWzBdCiAgICAgIHRoaXMuX3NlY3JldHNbMF0gPSB0aGlzLl9zZWNyZXRzWzFdCiAgICAgIHRoaXMuX3NlY3JldHNbMV0gPSB0bXAKICAgICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaCh0bXAsIHRtcCkKICAgIH0KCiAgICB0aGlzLmNvbmdlc3Rpb24uZHJhaW4oKQoKICAgIHdoaWxlICghdGhpcy5jb25nZXN0aW9uLmlzRnVsbCgpKSB7CiAgICAgIGNvbnN0IHAgPSB0aGlzLl9wZW5kaW5nLnNoaWZ0KCkKICAgICAgaWYgKHAgPT09IHVuZGVmaW5lZCkgcmV0dXJuCiAgICAgIHAuX3NlbmROb3coKQogICAgfQogIH0KCiAgY3JlYXRlUmVxdWVzdCh0bywgdG9rZW4sIGludGVybmFsLCBjb21tYW5kLCB0YXJnZXQsIHZhbHVlLCBzZXNzaW9uLCB0dGwpIHsKICAgIGlmICh0aGlzLl9kZXN0cm95aW5nICE9PSBudWxsKSByZXR1cm4gbnVsbAoKICAgIGlmICh0aGlzLl90aWQgPT09IDY1NTM2KSB0aGlzLl90aWQgPSAwCgogICAgY29uc3QgdGlkID0gdGhpcy5fdGlkKysKICAgIGNvbnN0IHNvY2tldCA9IHRoaXMuZmlyZXdhbGxlZCA/IHRoaXMuY2xpZW50U29ja2V0IDogdGhpcy5zZXJ2ZXJTb2NrZXQKCiAgICBjb25zdCByZXEgPSBuZXcgUmVxdWVzdCgKICAgICAgdGhpcywKICAgICAgc29ja2V0LAogICAgICB0aWQsCiAgICAgIG51bGwsCiAgICAgIHRvLAogICAgICB0b2tlbiwKICAgICAgaW50ZXJuYWwsCiAgICAgIGNvbW1hbmQsCiAgICAgIHRhcmdldCwKICAgICAgdmFsdWUsCiAgICAgIHNlc3Npb24sCiAgICAgIHR0bCB8fCAwCiAgICApCiAgICB0aGlzLmluZmxpZ2h0LnB1c2gocmVxKQogICAgaWYgKHNlc3Npb24pIHNlc3Npb24uX2F0dGFjaChyZXEpCgogICAgaWYgKGludGVybmFsICYmIGNvbW1hbmQgPCB0aGlzLnN0YXRzLmNvbW1hbmRzLmxlbmd0aCkgewogICAgICB0aGlzLnN0YXRzLmNvbW1hbmRzW2NvbW1hbmRdLnR4KysKICAgIH0KCiAgICB0aGlzLnN0YXRzLnJlcXVlc3RzLmFjdGl2ZSsrCiAgICB0aGlzLnN0YXRzLnJlcXVlc3RzLnRvdGFsKysKCiAgICByZXR1cm4gcmVxCiAgfQp9CgpjbGFzcyBSZXF1ZXN0IHsKICBjb25zdHJ1Y3Rvcihpbywgc29ja2V0LCB0aWQsIGZyb20sIHRvLCB0b2tlbiwgaW50ZXJuYWwsIGNvbW1hbmQsIHRhcmdldCwgdmFsdWUsIHNlc3Npb24sIHR0bCkgewogICAgdGhpcy5zb2NrZXQgPSBzb2NrZXQKICAgIHRoaXMudGlkID0gdGlkCiAgICB0aGlzLmZyb20gPSBmcm9tCiAgICB0aGlzLnRvID0gdG8KICAgIHRoaXMudG9rZW4gPSB0b2tlbgogICAgdGhpcy5jb21tYW5kID0gY29tbWFuZAogICAgdGhpcy50YXJnZXQgPSB0YXJnZXQKICAgIHRoaXMudmFsdWUgPSB2YWx1ZQogICAgdGhpcy5pbnRlcm5hbCA9IGludGVybmFsCiAgICB0aGlzLnNlc3Npb24gPSBzZXNzaW9uCiAgICB0aGlzLnR0bCA9IHR0bAogICAgdGhpcy5pbmRleCA9IC0xCiAgICB0aGlzLnNlbnQgPSAwCiAgICB0aGlzLnJldHJpZXMgPSAzCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCgogICAgdGhpcy5vbmN5Y2xlID0gbm9vcAogICAgdGhpcy5vbmVycm9yID0gbm9vcAogICAgdGhpcy5vbnJlc3BvbnNlID0gbm9vcAoKICAgIHRoaXMuX2J1ZmZlciA9IG51bGwKICAgIHRoaXMuX2lvID0gaW8KICAgIHRoaXMuX3RpbWVvdXQgPSBudWxsCiAgICB0aGlzLl90aW1lc3RhbXAgPSBEYXRlLm5vdygpCiAgfQoKICBzdGF0aWMgZGVjb2RlKGlvLCBzb2NrZXQsIGZyb20sIHN0YXRlKSB7CiAgICB0cnkgewogICAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICAgIGNvbnN0IHRpZCA9IGMudWludDE2LmRlY29kZShzdGF0ZSkKICAgICAgY29uc3QgdG8gPSBwZWVyLmlwdjQuZGVjb2RlKHN0YXRlKQogICAgICBjb25zdCBpZCA9IGZsYWdzICYgMSA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgICBjb25zdCB0b2tlbiA9IGZsYWdzICYgMiA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgICBjb25zdCBpbnRlcm5hbCA9IChmbGFncyAmIDQpICE9PSAwCiAgICAgIGNvbnN0IGNvbW1hbmQgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgICBjb25zdCB0YXJnZXQgPSBmbGFncyAmIDggPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgICAgY29uc3QgdmFsdWUgPSBmbGFncyAmIDE2ID8gYy5idWZmZXIuZGVjb2RlKHN0YXRlKSA6IG51bGwKCiAgICAgIGlmIChpZCAhPT0gbnVsbCkgZnJvbS5pZCA9IHZhbGlkYXRlSWQoaWQsIGZyb20pCgogICAgICByZXR1cm4gbmV3IFJlcXVlc3QoCiAgICAgICAgaW8sCiAgICAgICAgc29ja2V0LAogICAgICAgIHRpZCwKICAgICAgICBmcm9tLAogICAgICAgIHRvLAogICAgICAgIHRva2VuLAogICAgICAgIGludGVybmFsLAogICAgICAgIGNvbW1hbmQsCiAgICAgICAgdGFyZ2V0LAogICAgICAgIHZhbHVlLAogICAgICAgIG51bGwsCiAgICAgICAgMAogICAgICApCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIG51bGwKICAgIH0KICB9CgogIHJlcGx5KHZhbHVlLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHNvY2tldCA9IG9wdHMuc29ja2V0IHx8IHRoaXMuc29ja2V0CiAgICBjb25zdCB0byA9IG9wdHMudG8gfHwgdGhpcy5mcm9tCiAgICB0aGlzLl9zZW5kUmVwbHkoMCwgdmFsdWUgfHwgbnVsbCwgb3B0cy50b2tlbiAhPT0gZmFsc2UsIG9wdHMuY2xvc2VyTm9kZXMgIT09IGZhbHNlLCB0bywgc29ja2V0KQogIH0KCiAgZXJyb3IoY29kZSwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCBzb2NrZXQgPSBvcHRzLnNvY2tldCB8fCB0aGlzLnNvY2tldAogICAgY29uc3QgdG8gPSBvcHRzLnRvIHx8IHRoaXMuZnJvbQogICAgdGhpcy5fc2VuZFJlcGx5KGNvZGUsIG51bGwsIG9wdHMudG9rZW4gPT09IHRydWUsIG9wdHMuY2xvc2VyTm9kZXMgIT09IGZhbHNlLCB0bywgc29ja2V0KQogIH0KCiAgcmVsYXkodmFsdWUsIHRvLCBvcHRzKSB7CiAgICBjb25zdCBzb2NrZXQgPSAob3B0cyAmJiBvcHRzLnNvY2tldCkgfHwgdGhpcy5zb2NrZXQKICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuX2VuY29kZVJlcXVlc3QobnVsbCwgdmFsdWUsIHRvLCBzb2NrZXQpCiAgICBzb2NrZXQudHJ5U2VuZChidWZmZXIsIHRvLnBvcnQsIHRvLmhvc3QsIHRoaXMudHRsKQogIH0KCiAgc2VuZChmb3JjZSA9IGZhbHNlKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgoKICAgIGlmICh0aGlzLnNvY2tldCA9PT0gbnVsbCkgcmV0dXJuCiAgICBpZiAodGhpcy5fYnVmZmVyID09PSBudWxsKSB7CiAgICAgIHRoaXMuX2J1ZmZlciA9IHRoaXMuX2VuY29kZVJlcXVlc3QodGhpcy50b2tlbiwgdGhpcy52YWx1ZSwgdGhpcy50bywgdGhpcy5zb2NrZXQpCiAgICB9CgogICAgaWYgKCFmb3JjZSAmJiB0aGlzLl9pby5jb25nZXN0aW9uLmlzRnVsbCgpKSB7CiAgICAgIHRoaXMuX2lvLl9wZW5kaW5nLnB1c2godGhpcykKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5fc2VuZE5vdygpCiAgfQoKICBzZW5kUmVwbHkoZXJyb3IsIHZhbHVlLCB0b2tlbiwgaGFzQ2xvc2VyTm9kZXMpIHsKICAgIHRoaXMuX3NlbmRSZXBseShlcnJvciwgdmFsdWUsIHRva2VuLCBoYXNDbG9zZXJOb2RlcywgdGhpcy5mcm9tLCB0aGlzLnNvY2tldCwgbnVsbCkKICB9CgogIF9zZW5kTm93KCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuc2VudCsrCiAgICB0aGlzLl9pby5jb25nZXN0aW9uLnNlbmQoKQogICAgdGhpcy5zb2NrZXQudHJ5U2VuZCh0aGlzLl9idWZmZXIsIHRoaXMudG8ucG9ydCwgdGhpcy50by5ob3N0LCB0aGlzLnR0bCkKICAgIGlmICh0aGlzLl90aW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5fdGltZW91dCkKICAgIHRoaXMuX3RpbWVvdXQgPSBzZXRUaW1lb3V0KG9uY3ljbGUsIDEwMDAsIHRoaXMpCiAgfQoKICBkZXN0cm95KGVycikgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQoKICAgIGlmICh0aGlzLl90aW1lb3V0KSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lb3V0KQogICAgICB0aGlzLl90aW1lb3V0ID0gbnVsbAogICAgfQoKICAgIGNvbnN0IGkgPSB0aGlzLl9pby5pbmZsaWdodC5pbmRleE9mKHRoaXMpCiAgICBpZiAoaSA9PT0gLTEpIHJldHVybgoKICAgIGlmIChpID09PSB0aGlzLl9pby5pbmZsaWdodC5sZW5ndGggLSAxKSB0aGlzLl9pby5pbmZsaWdodC5wb3AoKQogICAgZWxzZSB0aGlzLl9pby5pbmZsaWdodFtpXSA9IHRoaXMuX2lvLmluZmxpZ2h0LnBvcCgpCgogICAgaWYgKHRoaXMuc2Vzc2lvbikgdGhpcy5zZXNzaW9uLl9kZXRhY2godGhpcykKCiAgICB0aGlzLl9pby5zdGF0cy5yZXF1ZXN0cy5hY3RpdmUtLQogICAgdGhpcy5faW8uY29uZ2VzdGlvbi5yZWN2KCkKCiAgICB0aGlzLm9uZXJyb3IoZXJyIHx8IFJFUVVFU1RfREVTVFJPWUVEKCksIHRoaXMpCiAgfQoKICBfc2VuZFJlcGx5KGVycm9yLCB2YWx1ZSwgdG9rZW4sIGhhc0Nsb3Nlck5vZGVzLCBmcm9tLCBzb2NrZXQpIHsKICAgIGlmIChzb2NrZXQgPT09IG51bGwgfHwgdGhpcy5kZXN0cm95ZWQpIHJldHVybgoKICAgIGNvbnN0IGlkID0gdGhpcy5faW8uZXBoZW1lcmFsID09PSBmYWxzZSAmJiBzb2NrZXQgPT09IHRoaXMuX2lvLnNlcnZlclNvY2tldAogICAgY29uc3QgY2xvc2VyTm9kZXMgPQogICAgICB0aGlzLnRhcmdldCAhPT0gbnVsbCAmJiBoYXNDbG9zZXJOb2RlcyA/IHRoaXMuX2lvLnRhYmxlLmNsb3Nlc3QodGhpcy50YXJnZXQpIDogRU1QVFlfQVJSQVkKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiAxICsgMSArIDYgKyAyLCBidWZmZXI6IG51bGwgfSAvLyAodHlwZSB8IHZlcnNpb24pICsgZmxhZ3MgKyB0byArIHRpZAoKICAgIGlmIChpZCkgc3RhdGUuZW5kICs9IDMyCiAgICBpZiAodG9rZW4pIHN0YXRlLmVuZCArPSAzMgogICAgaWYgKGNsb3Nlck5vZGVzLmxlbmd0aCA+IDApIHBlZXIuaXB2NEFycmF5LnByZWVuY29kZShzdGF0ZSwgY2xvc2VyTm9kZXMpCiAgICBpZiAoZXJyb3IgPiAwKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBlcnJvcikKICAgIGlmICh2YWx1ZSkgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCB2YWx1ZSkKCiAgICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gUkVTUE9OU0VfSUQKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9CiAgICAgIChpZCA/IDEgOiAwKSB8CiAgICAgICh0b2tlbiA/IDIgOiAwKSB8CiAgICAgIChjbG9zZXJOb2Rlcy5sZW5ndGggPiAwID8gNCA6IDApIHwKICAgICAgKGVycm9yID4gMCA/IDggOiAwKSB8CiAgICAgICh2YWx1ZSA/IDE2IDogMCkKCiAgICBjLnVpbnQxNi5lbmNvZGUoc3RhdGUsIHRoaXMudGlkKQogICAgcGVlci5pcHY0LmVuY29kZShzdGF0ZSwgZnJvbSkKCiAgICBpZiAoaWQpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIHRoaXMuX2lvLnRhYmxlLmlkKQogICAgaWYgKHRva2VuKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCB0aGlzLl9pby50b2tlbihmcm9tLCAxKSkKICAgIGlmIChjbG9zZXJOb2Rlcy5sZW5ndGggPiAwKSBwZWVyLmlwdjRBcnJheS5lbmNvZGUoc3RhdGUsIGNsb3Nlck5vZGVzKQogICAgaWYgKGVycm9yID4gMCkgYy51aW50LmVuY29kZShzdGF0ZSwgZXJyb3IpCiAgICBpZiAodmFsdWUpIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgdmFsdWUpCgogICAgc29ja2V0LnRyeVNlbmQoc3RhdGUuYnVmZmVyLCBmcm9tLnBvcnQsIGZyb20uaG9zdCwgdGhpcy50dGwpCiAgfQoKICBfZW5jb2RlUmVxdWVzdCh0b2tlbiwgdmFsdWUsIHRvLCBzb2NrZXQpIHsKICAgIGNvbnN0IGlkID0gdGhpcy5faW8uZXBoZW1lcmFsID09PSBmYWxzZSAmJiBzb2NrZXQgPT09IHRoaXMuX2lvLnNlcnZlclNvY2tldAogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDEgKyAxICsgNiArIDIsIGJ1ZmZlcjogbnVsbCB9IC8vICh0eXBlIHwgdmVyc2lvbikgKyBmbGFncyArIHRvICsgdGlkCgogICAgaWYgKGlkKSBzdGF0ZS5lbmQgKz0gMzIKICAgIGlmICh0b2tlbikgc3RhdGUuZW5kICs9IDMyCgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdGhpcy5jb21tYW5kKQoKICAgIGlmICh0aGlzLnRhcmdldCkgc3RhdGUuZW5kICs9IDMyCiAgICBpZiAodmFsdWUpIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdmFsdWUpCgogICAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHN0YXRlLmVuZCkKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IFJFUVVFU1RfSUQKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9CiAgICAgIChpZCA/IDEgOiAwKSB8CiAgICAgICh0b2tlbiA/IDIgOiAwKSB8CiAgICAgICh0aGlzLmludGVybmFsID8gNCA6IDApIHwKICAgICAgKHRoaXMudGFyZ2V0ID8gOCA6IDApIHwKICAgICAgKHZhbHVlID8gMTYgOiAwKQoKICAgIGMudWludDE2LmVuY29kZShzdGF0ZSwgdGhpcy50aWQpCiAgICBwZWVyLmlwdjQuZW5jb2RlKHN0YXRlLCB0bykKCiAgICBpZiAoaWQpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIHRoaXMuX2lvLnRhYmxlLmlkKQogICAgaWYgKHRva2VuKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCB0b2tlbikKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB0aGlzLmNvbW1hbmQpCgogICAgaWYgKHRoaXMudGFyZ2V0KSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCB0aGlzLnRhcmdldCkKICAgIGlmICh2YWx1ZSkgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB2YWx1ZSkKCiAgICByZXR1cm4gc3RhdGUuYnVmZmVyCiAgfQp9CgpjbGFzcyBDb25nZXN0aW9uV2luZG93IHsKICBjb25zdHJ1Y3RvcihtYXhXaW5kb3cpIHsKICAgIHRoaXMuX2kgPSAwCiAgICB0aGlzLl90b3RhbCA9IDAKICAgIHRoaXMuX3dpbmRvdyA9IFswLCAwLCAwLCAwXQogICAgdGhpcy5fbWF4V2luZG93ID0gbWF4V2luZG93CiAgfQoKICBjbGVhcigpIHsKICAgIHRoaXMuX2kgPSAwCiAgICB0aGlzLl90b3RhbCA9IDAKICAgIHRoaXMuX3dpbmRvdyA9IFswLCAwLCAwLCAwXQogIH0KCiAgaXNGdWxsKCkgewogICAgcmV0dXJuIHRoaXMuX3RvdGFsID49IDIgKiB0aGlzLl9tYXhXaW5kb3cgfHwgdGhpcy5fd2luZG93W3RoaXMuX2ldID49IHRoaXMuX21heFdpbmRvdwogIH0KCiAgcmVjdigpIHsKICAgIGlmICh0aGlzLl93aW5kb3dbdGhpcy5faV0gPiAwKSB7CiAgICAgIHRoaXMuX3dpbmRvd1t0aGlzLl9pXS0tCiAgICAgIHRoaXMuX3RvdGFsLS0KICAgIH0KICB9CgogIHNlbmQoKSB7CiAgICB0aGlzLl90b3RhbCsrCiAgICB0aGlzLl93aW5kb3dbdGhpcy5faV0rKwogIH0KCiAgZHJhaW4oKSB7CiAgICB0aGlzLl9pID0gKHRoaXMuX2kgKyAxKSAmIDMKICAgIHRoaXMuX3RvdGFsIC09IHRoaXMuX3dpbmRvd1t0aGlzLl9pXQogICAgdGhpcy5fd2luZG93W3RoaXMuX2ldID0gMCAvLyBjbGVhciBvbGRlc3QKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gb25jeWNsZShyZXEpIHsKICByZXEuX3RpbWVvdXQgPSBudWxsCiAgcmVxLm9uY3ljbGUocmVxKQogIGlmIChyZXEuc2VudCA+PSByZXEucmV0cmllcykgewogICAgcmVxLmRlc3Ryb3koUkVRVUVTVF9USU1FT1VUKCkpCiAgICByZXEuX2lvLm9udGltZW91dChyZXEpCiAgfSBlbHNlIHsKICAgIHJlcS5zZW5kKCkKICB9Cn0KCmZ1bmN0aW9uIGRlY29kZVJlcGx5KGZyb20sIHN0YXRlKSB7CiAgdHJ5IHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHRpZCA9IGMudWludDE2LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHRvID0gcGVlci5pcHY0LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGlkID0gZmxhZ3MgJiAxID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICBjb25zdCB0b2tlbiA9IGZsYWdzICYgMiA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgY29uc3QgY2xvc2VyTm9kZXMgPSBmbGFncyAmIDQgPyBwZWVyLmlwdjRBcnJheS5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgY29uc3QgZXJyb3IgPSBmbGFncyAmIDggPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIGNvbnN0IHZhbHVlID0gZmxhZ3MgJiAxNiA/IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkgOiBudWxsCgogICAgaWYgKGlkICE9PSBudWxsKSBmcm9tLmlkID0gdmFsaWRhdGVJZChpZCwgZnJvbSkKCiAgICByZXR1cm4geyB0aWQsIHJ0dDogMCwgZnJvbSwgdG8sIHRva2VuLCBjbG9zZXJOb2RlcywgZXJyb3IsIHZhbHVlIH0KICB9IGNhdGNoIHsKICAgIHJldHVybiBudWxsCiAgfQp9CgpmdW5jdGlvbiB2YWxpZGF0ZUlkKGlkLCBmcm9tKSB7CiAgY29uc3QgZXhwZWN0ZWQgPSBwZWVyLmlkKGZyb20uaG9zdCwgZnJvbS5wb3J0KQogIHJldHVybiBiNGEuZXF1YWxzKGV4cGVjdGVkLCBpZCkgPyBleHBlY3RlZCA6IG51bGwKfQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBuZXQgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nLW5ldCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBpcHY0ID0gewogIC4uLm5ldC5pcHY0QWRkcmVzcywKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGlwID0gbmV0LmlwdjRBZGRyZXNzLmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIGlkOiBudWxsLCAvLyBwb3B1bGF0ZWQgYnkgdGhlIGNhbGxlZQogICAgICBob3N0OiBpcC5ob3N0LAogICAgICBwb3J0OiBpcC5wb3J0CiAgICB9CiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsgaWQsIGlwdjQsIGlwdjRBcnJheTogYy5hcnJheShpcHY0KSB9CgpmdW5jdGlvbiBpZChob3N0LCBwb3J0LCBvdXQgPSBiNGEuYWxsb2NVbnNhZmVTbG93KDMyKSkgewogIGNvbnN0IGFkZHIgPSBvdXQuc3ViYXJyYXkoMCwgNikKICBpcHY0LmVuY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IDYsIGJ1ZmZlcjogYWRkciB9LCB7IGhvc3QsIHBvcnQgfSkKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKG91dCwgYWRkcikKICByZXR1cm4gb3V0Cn0KY29uc3QgeyBSZWFkYWJsZSwgZ2V0U3RyZWFtRXJyb3IgfSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBwZWVyID0gcmVxdWlyZSgnLi9wZWVyJykKY29uc3QgeyBET1dOX0hJTlQgfSA9IHJlcXVpcmUoJy4vY29tbWFuZHMnKQoKY29uc3QgRE9ORSA9IFtdCmNvbnN0IERPV04gPSBbXQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBRdWVyeSBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3RvcihkaHQsIHRhcmdldCwgaW50ZXJuYWwsIGNvbW1hbmQsIHZhbHVlLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICBkaHQuc3RhdHMucXVlcmllcy50b3RhbCsrCiAgICBkaHQuc3RhdHMucXVlcmllcy5hY3RpdmUrKwoKICAgIHRoaXMuZm9yY2UgPSAhIW9wdHMuZm9yY2UKICAgIHRoaXMuZGh0ID0gZGh0CiAgICB0aGlzLmsgPSB0aGlzLmRodC50YWJsZS5rCiAgICB0aGlzLnRhcmdldCA9IHRhcmdldAogICAgdGhpcy5pbnRlcm5hbCA9IGludGVybmFsCiAgICB0aGlzLmNvbW1hbmQgPSBjb21tYW5kCiAgICB0aGlzLnZhbHVlID0gdmFsdWUKICAgIHRoaXMuZXJyb3JzID0gMAogICAgdGhpcy5zdWNjZXNzZXMgPSAwCiAgICB0aGlzLmNvbmN1cnJlbmN5ID0gb3B0cy5jb25jdXJyZW5jeSB8fCB0aGlzLmRodC5jb25jdXJyZW5jeQogICAgdGhpcy5pbmZsaWdodCA9IDAKICAgIHRoaXMubWFwID0gb3B0cy5tYXAgfHwgZGVmYXVsdE1hcAogICAgdGhpcy5yZXRyaWVzID0gb3B0cy5yZXRyaWVzID09PSAwID8gMCA6IG9wdHMucmV0cmllcyB8fCAzCiAgICB0aGlzLm1heFNsb3cgPSBvcHRzLm1heFNsb3cgPT09IDAgPyAwIDogb3B0cy5tYXhTbG93IHx8IDUKICAgIHRoaXMuY2xvc2VzdFJlcGxpZXMgPSBbXQoKICAgIHRoaXMuX3Nsb3cgPSAwCiAgICB0aGlzLl9vbmxpbmUgPSBmYWxzZQogICAgdGhpcy5fc2xvd2Rvd24gPSBmYWxzZQogICAgdGhpcy5fc2VlbiA9IG5ldyBNYXAoKQogICAgdGhpcy5fcGVuZGluZyA9IFtdCiAgICB0aGlzLl9mcm9tVGFibGUgPSBmYWxzZQogICAgdGhpcy5fY29tbWl0ID0gb3B0cy5jb21taXQgPT09IHRydWUgPyBhdXRvQ29tbWl0IDogb3B0cy5jb21taXQgfHwgbnVsbAogICAgdGhpcy5fY29tbWl0aW5nID0gZmFsc2UKICAgIHRoaXMuX3Nlc3Npb24gPSBvcHRzLnNlc3Npb24gfHwgZGh0LnNlc3Npb24oKQogICAgdGhpcy5fYXV0b0Rlc3Ryb3lTZXNzaW9uID0gIW9wdHMuc2Vzc2lvbgogICAgdGhpcy5fb25seUNsb3Nlc3ROb2RlcyA9IGZhbHNlCgogICAgdGhpcy5fb252aXNpdGJvdW5kID0gdGhpcy5fb252aXNpdC5iaW5kKHRoaXMpCiAgICB0aGlzLl9vbmVycm9yYm91bmQgPSB0aGlzLl9vbmVycm9yLmJpbmQodGhpcykKICAgIHRoaXMuX29uY3ljbGVib3VuZCA9IHRoaXMuX29uY3ljbGUuYmluZCh0aGlzKQoKICAgIGNvbnN0IG5vZGVzID0gb3B0cy5ub2RlcyB8fCBvcHRzLmNsb3Nlc3ROb2RlcwogICAgY29uc3QgcmVwbGllcyA9IG9wdHMucmVwbGllcyB8fCBvcHRzLmNsb3Nlc3RSZXBsaWVzCgogICAgLy8gYWRkIHRoZW0gcmV2ZXJzZSBhcyB3ZSBwb3AgYmVsb3cKICAgIGlmIChub2RlcykgewogICAgICBmb3IgKGxldCBpID0gbm9kZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBjb25zdCBub2RlID0gbm9kZXNbaV0KICAgICAgICB0aGlzLl9hZGRQZW5kaW5nKAogICAgICAgICAgewogICAgICAgICAgICBpZDogbm9kZS5pZCB8fCBwZWVyLmlkKG5vZGUuaG9zdCwgbm9kZS5wb3J0KSwKICAgICAgICAgICAgaG9zdDogbm9kZS5ob3N0LAogICAgICAgICAgICBwb3J0OiBub2RlLnBvcnQKICAgICAgICAgIH0sCiAgICAgICAgICBudWxsCiAgICAgICAgKQogICAgICB9CiAgICB9IGVsc2UgaWYgKHJlcGxpZXMpIHsKICAgICAgZm9yIChsZXQgaSA9IHJlcGxpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICB0aGlzLl9hZGRQZW5kaW5nKHJlcGxpZXNbaV0uZnJvbSwgbnVsbCkKICAgICAgfQogICAgfQoKICAgIGlmIChvcHRzLm9ubHlDbG9zZXN0Tm9kZXMpIHRoaXMuX29ubHlDbG9zZXN0Tm9kZXMgPSB0cnVlCiAgfQoKICBnZXQgY2xvc2VzdE5vZGVzKCkgewogICAgY29uc3Qgbm9kZXMgPSBuZXcgQXJyYXkodGhpcy5jbG9zZXN0UmVwbGllcy5sZW5ndGgpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICBub2Rlc1tpXSA9IHRoaXMuY2xvc2VzdFJlcGxpZXNbaV0uZnJvbQogICAgfQoKICAgIHJldHVybiBub2RlcwogIH0KCiAgZmluaXNoZWQoKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHsKICAgICAgICBjb25zdCBlcnJvciA9IGdldFN0cmVhbUVycm9yKHRoaXMpCiAgICAgICAgaWYgKGVycm9yKSByZWplY3QoZXJyb3IpCiAgICAgICAgZWxzZSByZXNvbHZlKCkKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgY29uc3Qgc2VsZiA9IHRoaXMKICAgICAgbGV0IGVycm9yID0gbnVsbAoKICAgICAgdGhpcy5yZXN1bWUoKQogICAgICB0aGlzLm9uKCdlcnJvcicsIG9uZXJyb3IpCiAgICAgIHRoaXMub24oJ2Nsb3NlJywgb25jbG9zZSkKCiAgICAgIGZ1bmN0aW9uIG9uY2xvc2UoKSB7CiAgICAgICAgc2VsZi5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBvbmVycm9yKQogICAgICAgIHNlbGYucmVtb3ZlTGlzdGVuZXIoJ2Nsb3NlJywgb25jbG9zZSkKICAgICAgICBpZiAoZXJyb3IpIHJlamVjdChlcnJvcikKICAgICAgICBlbHNlIHJlc29sdmUoKQogICAgICB9CgogICAgICBmdW5jdGlvbiBvbmVycm9yKGVycikgewogICAgICAgIGVycm9yID0gZXJyCiAgICAgIH0KICAgIH0pCiAgfQoKICBfYWRkRnJvbVRhYmxlKCkgewogICAgaWYgKHRoaXMuX3BlbmRpbmcubGVuZ3RoID49IHRoaXMuaykgcmV0dXJuCiAgICB0aGlzLl9mcm9tVGFibGUgPSB0cnVlCgogICAgY29uc3QgY2xvc2VzdCA9IHRoaXMuZGh0LnRhYmxlLmNsb3Nlc3QodGhpcy50YXJnZXQsIHRoaXMuayAtIHRoaXMuX3BlbmRpbmcubGVuZ3RoKQoKICAgIGZvciAoY29uc3Qgbm9kZSBvZiBjbG9zZXN0KSB7CiAgICAgIHRoaXMuX2FkZFBlbmRpbmcoeyBpZDogbm9kZS5pZCwgaG9zdDogbm9kZS5ob3N0LCBwb3J0OiBub2RlLnBvcnQgfSwgbnVsbCkKICAgIH0KICB9CgogIGFzeW5jIF9vcGVuKGNiKSB7CiAgICB0aGlzLl9hZGRGcm9tVGFibGUoKQogICAgaWYgKHRoaXMuX3BlbmRpbmcubGVuZ3RoID49IHRoaXMuaykgcmV0dXJuIGNiKG51bGwpCgogICAgZm9yIGF3YWl0IChjb25zdCBub2RlIG9mIHRoaXMuZGh0Ll9yZXNvbHZlQm9vdHN0cmFwTm9kZXMoKSkgewogICAgICB0aGlzLl9hZGRQZW5kaW5nKG5vZGUsIG51bGwpCiAgICB9CgogICAgY2IobnVsbCkKICB9CgogIF9pc0Nsb3NlcihpZCkgewogICAgcmV0dXJuICgKICAgICAgdGhpcy5jbG9zZXN0UmVwbGllcy5sZW5ndGggPCB0aGlzLmsgfHwKICAgICAgdGhpcy5fY29tcGFyZShpZCwgdGhpcy5jbG9zZXN0UmVwbGllc1t0aGlzLmNsb3Nlc3RSZXBsaWVzLmxlbmd0aCAtIDFdLmZyb20uaWQpIDwgMAogICAgKQogIH0KCiAgX2FkZFBlbmRpbmcobm9kZSwgcmVmKSB7CiAgICBpZiAodGhpcy5fb25seUNsb3Nlc3ROb2RlcykgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgYWRkciA9IG5vZGUuaG9zdCArICc6JyArIG5vZGUucG9ydAogICAgY29uc3QgcmVmcyA9IHRoaXMuX3NlZW4uZ2V0KGFkZHIpCiAgICBjb25zdCBpc0Nsb3NlciA9IHRoaXMuX2lzQ2xvc2VyKG5vZGUuaWQpCgogICAgaWYgKHJlZnMgPT09IERPTkUpIHsKICAgICAgcmV0dXJuIGlzQ2xvc2VyCiAgICB9CgogICAgaWYgKHJlZnMgPT09IERPV04pIHsKICAgICAgaWYgKHJlZikgdGhpcy5fZG93bkhpbnQocmVmLCBub2RlKQogICAgICByZXR1cm4gaXNDbG9zZXIKICAgIH0KCiAgICBpZiAocmVmcykgewogICAgICBpZiAocmVmICE9PSBudWxsKSByZWZzLnB1c2gocmVmKQogICAgICByZXR1cm4gaXNDbG9zZXIKICAgIH0KCiAgICBpZiAoIWlzQ2xvc2VyKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIHRoaXMuX3NlZW4uc2V0KGFkZHIsIHJlZiA9PT0gbnVsbCA/IFtdIDogW3JlZl0pCiAgICB0aGlzLl9wZW5kaW5nLnB1c2gobm9kZSkKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3JlYWQoY2IpIHsKICAgIHRoaXMuX3JlYWRNb3JlKCkKICAgIGNiKG51bGwpCiAgfQoKICBfcmVhZE1vcmUoKSB7CiAgICBpZiAodGhpcy5kZXN0cm95aW5nIHx8IHRoaXMuX2NvbW1pdGluZykgcmV0dXJuCgogICAgY29uc3QgY29uY3VycmVuY3kgPSAodGhpcy5fc2xvd2Rvd24gPyAzIDogdGhpcy5jb25jdXJyZW5jeSkgKyB0aGlzLl9zbG93CgogICAgd2hpbGUgKHRoaXMuaW5mbGlnaHQgPCBjb25jdXJyZW5jeSAmJiB0aGlzLl9wZW5kaW5nLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgbmV4dCA9IHRoaXMuX3BlbmRpbmcucG9wKCkKICAgICAgaWYgKG5leHQgJiYgbmV4dC5pZCAmJiAhdGhpcy5faXNDbG9zZXIobmV4dC5pZCkpIGNvbnRpbnVlCiAgICAgIHRoaXMuX3Zpc2l0KG5leHQpCiAgICB9CgogICAgLy8gaWYgcmV1c2luZyBjbG9zZXN0IG5vZGVzLCBzbG93IGRvd24gYWZ0ZXIgdGhlIGZpcnN0IHJlYWRNb3JlIHRpY2sgdG8gYWxsb3cKICAgIC8vIHRoZSBjbG9zZXN0IG5vZGUgYSBjaGFuY2UgdG8gcmVwbHkgYmVmb3JlIGdvaW5nIGJyb2FkIHRvIHF1ZXN0aW9uIG1vcmUKICAgIGlmICghdGhpcy5fZnJvbVRhYmxlICYmIHRoaXMuc3VjY2Vzc2VzID09PSAwICYmIHRoaXMuZXJyb3JzID09PSAwKSB7CiAgICAgIHRoaXMuX3Nsb3dkb3duID0gdHJ1ZQogICAgfQoKICAgIGlmICh0aGlzLl9wZW5kaW5nLmxlbmd0aCA+IDApIHJldHVybgoKICAgIC8vIGlmIG5vIGluZmxpZ2h0IE9SIGFsbCB0aGUgcXVlcmllcyB3ZSBhcmUgd2FpdGluZyBvbiBhcmUgbWFya2VkIGFzIHNsb3cgKHdpdGhpbiBvdXIgbGltaXRzKSBhbmQgd2UgaGF2ZSBhIGZ1bGwgcmVzdWx0LgogICAgaWYgKAogICAgICB0aGlzLmluZmxpZ2h0ID09PSAwIHx8CiAgICAgICh0aGlzLl9zbG93IDw9IHRoaXMubWF4U2xvdyAmJgogICAgICAgIHRoaXMuX3Nsb3cgPT09IHRoaXMuaW5mbGlnaHQgJiYKICAgICAgICB0aGlzLmNsb3Nlc3RSZXBsaWVzLmxlbmd0aCA+PSB0aGlzLmspCiAgICApIHsKICAgICAgLy8gaWYgbW9yZSB0aGFuIDMvNCBmYWlsZWQgYW5kIHdlIG9ubHkgdXNlZCBjYWNoZWQgbm9kZXMsIHRyeSBhZ2FpbiBmcm9tIHRoZSByb3V0aW5nIHRhYmxlCiAgICAgIGlmICghdGhpcy5fZnJvbVRhYmxlICYmIHRoaXMuc3VjY2Vzc2VzIDwgdGhpcy5rIC8gNCkgewogICAgICAgIHRoaXMuX2FkZEZyb21UYWJsZSgpCiAgICAgICAgdGhpcy5fcmVhZE1vcmUoKQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICB0aGlzLl9mbHVzaCgpCiAgICB9CiAgfQoKICBfZmx1c2goKSB7CiAgICBpZiAodGhpcy5fY29tbWl0aW5nKSByZXR1cm4KICAgIHRoaXMuX2NvbW1pdGluZyA9IHRydWUKCiAgICBpZiAodGhpcy5fY29tbWl0ID09PSBudWxsKSB7CiAgICAgIHRoaXMucHVzaChudWxsKQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBwID0gW10KICAgIGZvciAoY29uc3QgbSBvZiB0aGlzLmNsb3Nlc3RSZXBsaWVzKSBwLnB1c2godGhpcy5fY29tbWl0KG0sIHRoaXMuZGh0LCB0aGlzKSkKICAgIHRoaXMuX2VuZEFmdGVyQ29tbWl0KHApCiAgfQoKICBfZW5kQWZ0ZXJDb21taXQocHMpIHsKICAgIGlmICghcHMubGVuZ3RoKSB7CiAgICAgIHRoaXMuZGVzdHJveShuZXcgRXJyb3IoJ1RvbyBmZXcgbm9kZXMgcmVzcG9uZGVkJykpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IHNlbGYgPSB0aGlzCgogICAgbGV0IHBlbmRpbmcgPSBwcy5sZW5ndGgKICAgIGxldCBzdWNjZXNzID0gMAoKICAgIGZvciAoY29uc3QgcCBvZiBwcykgcC50aGVuKG9uZG9uZSwgb25lcnJvcikKCiAgICBmdW5jdGlvbiBvbmRvbmUoKSB7CiAgICAgIHN1Y2Nlc3MrKwogICAgICBpZiAoLS1wZW5kaW5nID09PSAwKSBzZWxmLnB1c2gobnVsbCkKICAgIH0KCiAgICBmdW5jdGlvbiBvbmVycm9yKGVycikgewogICAgICBpZiAoLS1wZW5kaW5nID4gMCkgcmV0dXJuCiAgICAgIGlmIChzdWNjZXNzKSBzZWxmLnB1c2gobnVsbCkKICAgICAgZWxzZSBzZWxmLmRlc3Ryb3koZXJyKQogICAgfQogIH0KCiAgX2RlYyhyZXEpIHsKICAgIGlmIChyZXEub25jeWNsZSA9PT0gbm9vcCkgewogICAgICB0aGlzLl9zbG93LS0KICAgIH0gZWxzZSB7CiAgICAgIHJlcS5vbmN5Y2xlID0gbm9vcAogICAgfQogICAgdGhpcy5pbmZsaWdodC0tCiAgfQoKICBfb252aXNpdChtLCByZXEpIHsKICAgIHRoaXMuX2RlYyhyZXEpCgogICAgdGhpcy5fb25saW5lID0gdHJ1ZQogICAgaWYgKCF0aGlzLmRodC5vbmxpbmUpIHRoaXMuZGh0Ll9vbmxpbmUoKQoKICAgIGNvbnN0IGFkZHIgPSByZXEudG8uaG9zdCArICc6JyArIHJlcS50by5wb3J0CiAgICB0aGlzLl9zZWVuLnNldChhZGRyLCBET05FKQoKICAgIGlmICh0aGlzLl9jb21taXRpbmcpIHJldHVybgoKICAgIGlmIChtLmVycm9yID09PSAwKSB0aGlzLnN1Y2Nlc3NlcysrCiAgICBlbHNlIHRoaXMuZXJyb3JzKysKCiAgICBpZiAobS5lcnJvciA9PT0gMCAmJiBtLmZyb20uaWQgIT09IG51bGwgJiYgdGhpcy5faXNDbG9zZXIobS5mcm9tLmlkKSkgdGhpcy5fcHVzaENsb3Nlc3QobSkKCiAgICBpZiAobS5jbG9zZXJOb2RlcyAhPT0gbnVsbCkgewogICAgICBmb3IgKGNvbnN0IG5vZGUgb2YgbS5jbG9zZXJOb2RlcykgewogICAgICAgIG5vZGUuaWQgPSBwZWVyLmlkKG5vZGUuaG9zdCwgbm9kZS5wb3J0KQogICAgICAgIGlmICh0aGlzLmRodC5fZmlsdGVyTm9kZSAhPT0gbnVsbCAmJiAhdGhpcy5kaHQuX2ZpbHRlck5vZGUobm9kZSkpIGNvbnRpbnVlCiAgICAgICAgaWYgKGI0YS5lcXVhbHMobm9kZS5pZCwgdGhpcy5kaHQudGFibGUuaWQpKSBjb250aW51ZQogICAgICAgIC8vIFRPRE86IHdlIGNvdWxkIGNvbnRpbnVlIGhlcmUgaW5zdGVhZCBvZiBicmVha2luZyB0byBlbnN1cmUgdGhhdCBvbmUgb2YgdGhlIG5vZGVzIGluIHRoZSBjbG9zZXIgbGlzdAogICAgICAgIC8vIGlzIGxhdGVyIG1hcmtlZCBhcyBET1dOIHRoYXQgd2UgZ29zc2lwIHRoYXQgYmFjawogICAgICAgIGlmICghdGhpcy5fYWRkUGVuZGluZyhub2RlLCBtLmZyb20pKSBicmVhawogICAgICB9CiAgICB9CgogICAgaWYgKCF0aGlzLl9mcm9tVGFibGUgJiYgdGhpcy5zdWNjZXNzZXMgKyB0aGlzLmVycm9ycyA+PSB0aGlzLmNvbmN1cnJlbmN5KSB7CiAgICAgIHRoaXMuX3Nsb3dkb3duID0gZmFsc2UKICAgIH0KCiAgICBpZiAobS5lcnJvciAhPT0gMCkgewogICAgICB0aGlzLl9yZWFkTW9yZSgpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IGRhdGEgPSB0aGlzLm1hcChtKQogICAgaWYgKCFkYXRhIHx8IHRoaXMucHVzaChkYXRhKSAhPT0gZmFsc2UpIHsKICAgICAgdGhpcy5fcmVhZE1vcmUoKQogICAgfQogIH0KCiAgX29uZXJyb3IoZXJyLCByZXEpIHsKICAgIGNvbnN0IGFkZHIgPSByZXEudG8uaG9zdCArICc6JyArIHJlcS50by5wb3J0CiAgICBjb25zdCByZWZzID0gdGhpcy5fc2Vlbi5nZXQoYWRkcikKCiAgICBpZiAoZXJyLmNvZGUgPT09ICdSRVFVRVNUX1RJTUVPVVQnKSB7CiAgICAgIHRoaXMuX3NlZW4uc2V0KGFkZHIsIERPV04pCiAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiByZWZzKSB0aGlzLl9kb3duSGludChub2RlLCByZXEudG8pCiAgICB9CgogICAgdGhpcy5fZGVjKHJlcSkKICAgIHRoaXMuZXJyb3JzKysKICAgIHRoaXMuX3JlYWRNb3JlKCkKICB9CgogIF9vbmN5Y2xlKHJlcSkgewogICAgcmVxLm9uY3ljbGUgPSBub29wCiAgICB0aGlzLl9zbG93KysKICAgIHRoaXMuX3JlYWRNb3JlKCkKICB9CgogIF9kb3duSGludChub2RlLCBkb3duKSB7CiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogNiwgYnVmZmVyOiBiNGEuYWxsb2NVbnNhZmUoNikgfQogICAgcGVlci5pcHY0LmVuY29kZShzdGF0ZSwgZG93bikKICAgIHRoaXMuZGh0Ll9yZXF1ZXN0KG5vZGUsIGZhbHNlLCB0cnVlLCBET1dOX0hJTlQsIG51bGwsIHN0YXRlLmJ1ZmZlciwgdGhpcy5fc2Vzc2lvbiwgbm9vcCwgbm9vcCkKICB9CgogIF9wdXNoQ2xvc2VzdChtKSB7CiAgICB0aGlzLmNsb3Nlc3RSZXBsaWVzLnB1c2gobSkKICAgIGZvciAobGV0IGkgPSB0aGlzLmNsb3Nlc3RSZXBsaWVzLmxlbmd0aCAtIDI7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHByZXYgPSB0aGlzLmNsb3Nlc3RSZXBsaWVzW2ldCiAgICAgIGNvbnN0IGNtcCA9IHRoaXMuX2NvbXBhcmUocHJldi5mcm9tLmlkLCBtLmZyb20uaWQpCiAgICAgIC8vIGlmIHNvcnRlZCwgZG9uZSEKICAgICAgaWYgKGNtcCA8IDApIGJyZWFrCiAgICAgIC8vIGlmIGR1cCwgc3BsaWNlIGl0IG91dCAocmFyZSkKICAgICAgaWYgKGNtcCA9PT0gMCkgewogICAgICAgIHRoaXMuY2xvc2VzdFJlcGxpZXMuc3BsaWNlKGkgKyAxLCAxKQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgICAgLy8gc3dhcCBhbmQgY29udGludWUgZG93bgogICAgICB0aGlzLmNsb3Nlc3RSZXBsaWVzW2kgKyAxXSA9IHByZXYKICAgICAgdGhpcy5jbG9zZXN0UmVwbGllc1tpXSA9IG0KICAgIH0KICAgIGlmICh0aGlzLmNsb3Nlc3RSZXBsaWVzLmxlbmd0aCA+IHRoaXMuaykgdGhpcy5jbG9zZXN0UmVwbGllcy5wb3AoKQogIH0KCiAgX2NvbXBhcmUoYSwgYikgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChhW2ldID09PSBiW2ldKSBjb250aW51ZQogICAgICBjb25zdCB0ID0gdGhpcy50YXJnZXRbaV0KICAgICAgcmV0dXJuICh0IF4gYVtpXSkgLSAodCBeIGJbaV0pCiAgICB9CiAgICByZXR1cm4gMAogIH0KCiAgX3Zpc2l0KHRvKSB7CiAgICB0aGlzLmluZmxpZ2h0KysKCiAgICBjb25zdCByZXEgPSB0aGlzLmRodC5fcmVxdWVzdCgKICAgICAgdG8sCiAgICAgIHRoaXMuZm9yY2UsCiAgICAgIHRoaXMuaW50ZXJuYWwsCiAgICAgIHRoaXMuY29tbWFuZCwKICAgICAgdGhpcy50YXJnZXQsCiAgICAgIHRoaXMudmFsdWUsCiAgICAgIHRoaXMuX3Nlc3Npb24sCiAgICAgIHRoaXMuX29udmlzaXRib3VuZCwKICAgICAgdGhpcy5fb25lcnJvcmJvdW5kCiAgICApCiAgICBpZiAocmVxID09PSBudWxsKSB7CiAgICAgIHRoaXMuZGVzdHJveShuZXcgRXJyb3IoJ05vZGUgd2FzIGRlc3Ryb3llZCcpKQogICAgICByZXR1cm4KICAgIH0KICAgIHJlcS5yZXRyaWVzID0gdGhpcy5yZXRyaWVzCiAgICByZXEub25jeWNsZSA9IHRoaXMuX29uY3ljbGVib3VuZAogICAgaWYgKHRoaXMuZm9yY2UpIHJlcS5yZXRyaWVzID0gMAogIH0KCiAgX2Rlc3Ryb3koY2IpIHsKICAgIHRoaXMuZGh0LnN0YXRzLnF1ZXJpZXMuYWN0aXZlLS0KICAgIGlmICghdGhpcy5fb25saW5lICYmIHRoaXMuZGh0Lm9ubGluZSkgdGhpcy5kaHQuX29mZmxpbmUoKQogICAgaWYgKHRoaXMuX2F1dG9EZXN0cm95U2Vzc2lvbikgdGhpcy5fc2Vzc2lvbi5kZXN0cm95KCkKICAgIGNiKG51bGwpCiAgfQp9CgpmdW5jdGlvbiBhdXRvQ29tbWl0KHJlcGx5LCBkaHQsIHF1ZXJ5KSB7CiAgaWYgKCFyZXBseS50b2tlbikgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignTm8gdG9rZW4gcmVjZWl2ZWQgZm9yIGNsb3Nlc3Qgbm9kZScpKQogIHJldHVybiBkaHQucmVxdWVzdCgKICAgIHsKICAgICAgdG9rZW46IHJlcGx5LnRva2VuLAogICAgICB0YXJnZXQ6IHF1ZXJ5LnRhcmdldCwKICAgICAgY29tbWFuZDogcXVlcnkuY29tbWFuZCwKICAgICAgdmFsdWU6IHF1ZXJ5LnZhbHVlCiAgICB9LAogICAgcmVwbHkuZnJvbQogICkKfQoKZnVuY3Rpb24gZGVmYXVsdE1hcChtKSB7CiAgcmV0dXJuIG0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU2Vzc2lvbiB7CiAgY29uc3RydWN0b3IoZGh0KSB7CiAgICB0aGlzLmRodCA9IGRodAogICAgdGhpcy5pbmZsaWdodCA9IFtdCiAgfQoKICBfYXR0YWNoKHJlcSkgewogICAgcmVxLmluZGV4ID0gdGhpcy5pbmZsaWdodC5wdXNoKHJlcSkgLSAxCiAgfQoKICBfZGV0YWNoKHJlcSkgewogICAgY29uc3QgaSA9IHJlcS5pbmRleAogICAgaWYgKGkgPT09IC0xKSByZXR1cm4KICAgIHJlcS5pbmRleCA9IC0xCgogICAgaWYgKGkgPT09IHRoaXMuaW5mbGlnaHQubGVuZ3RoIC0gMSkgdGhpcy5pbmZsaWdodC5wb3AoKQogICAgZWxzZSB7CiAgICAgIGNvbnN0IHJlcSA9ICh0aGlzLmluZmxpZ2h0W2ldID0gdGhpcy5pbmZsaWdodC5wb3AoKSkKICAgICAgcmVxLmluZGV4ID0gaQogICAgfQogIH0KCiAgcXVlcnkoeyB0YXJnZXQsIGNvbW1hbmQsIHZhbHVlIH0sIG9wdHMgPSB7fSkgewogICAgcmV0dXJuIHRoaXMuZGh0LnF1ZXJ5KHsgdGFyZ2V0LCBjb21tYW5kLCB2YWx1ZSB9LCB7IC4uLm9wdHMsIHNlc3Npb246IHRoaXMgfSkKICB9CgogIHJlcXVlc3QoeyB0b2tlbiwgY29tbWFuZCwgdGFyZ2V0LCB2YWx1ZSB9LCB7IGhvc3QsIHBvcnQgfSwgb3B0cyA9IHt9KSB7CiAgICByZXR1cm4gdGhpcy5kaHQucmVxdWVzdCgKICAgICAgeyB0b2tlbiwgY29tbWFuZCwgdGFyZ2V0LCB2YWx1ZSB9LAogICAgICB7IGhvc3QsIHBvcnQgfSwKICAgICAgeyAuLi5vcHRzLCBzZXNzaW9uOiB0aGlzIH0KICAgICkKICB9CgogIHBpbmcoeyBob3N0LCBwb3J0IH0sIG9wdHMgPSB7fSkgewogICAgcmV0dXJuIHRoaXMuZGh0LnBpbmcoeyBob3N0LCBwb3J0IH0sIHsgLi4ub3B0cywgc2Vzc2lvbjogdGhpcyB9KQogIH0KCiAgZGVzdHJveShlcnIpIHsKICAgIHdoaWxlICh0aGlzLmluZmxpZ2h0Lmxlbmd0aCkgewogICAgICBjb25zdCByZXEgPSB0aGlzLmluZmxpZ2h0WzBdCiAgICAgIC8vIHByZXZlbnQgZGVzdHJveWVkIHJlcXVlc3RzIGZyb20gY29udHJpYnV0aW5nIHRvIGNvbmdlc3Rpb24gY291bnRzCiAgICAgIHRoaXMuZGh0LmlvLmNvbmdlc3Rpb24ucmVjdigpCiAgICAgIHJlcS5kZXN0cm95KGVycikKICAgIH0KICB9Cn0KewogICJuYW1lIjogImRodC1ycGMiLAogICJ2ZXJzaW9uIjogIjYuMjAuMiIsCiAgImRlc2NyaXB0aW9uIjogIk1ha2UgUlBDIGNhbGxzIG92ZXIgYSBLYWRlbWxpYSBiYXNlZCBESFQiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYi8qLmpzIgogIF0sCiAgImltcG9ydHMiOiB7CiAgICAiZXZlbnRzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWV2ZW50cyIsCiAgICAgICJkZWZhdWx0IjogImV2ZW50cyIKICAgIH0KICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMSIsCiAgICAiYmFyZS1ldmVudHMiOiAiXjIuMi4wIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjExLjAiLAogICAgImNvbXBhY3QtZW5jb2RpbmctbmV0IjogIl4xLjIuMCIsCiAgICAiZmFzdC1maWZvIjogIl4xLjEuMCIsCiAgICAia2FkZW1saWEtcm91dGluZy10YWJsZSI6ICJeMS4wLjEiLAogICAgIm5hdC1zYW1wbGVyIjogIl4xLjAuMSIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjAiLAogICAgInN0cmVhbXgiOiAiXjIuMTMuMiIsCiAgICAidGltZS1vcmRlcmVkLXNldCI6ICJeMi4wLjAiLAogICAgInVkeC1uYXRpdmUiOiAiXjEuNS4zIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjAuMCIsCiAgICAibHVudGUiOiAiXjEuMy4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIiwKICAgICJ0ZXN0LXN1c3BlbmQiOiAiXjEuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAidGVzdCI6ICJucG0gcnVuIHRlc3Q6bm9kZSAmJiBucG0gcnVuIHRlc3Q6YmFyZSIsCiAgICAidGVzdDpiYXJlIjogImJyaXR0bGUtYmFyZSAtLWNvdmVyYWdlIHRlc3QuanMiLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuICYmIGx1bnRlIiwKICAgICJ0ZXN0Om5vZGUiOiAiYnJpdHRsZS1ub2RlIC0tY292ZXJhZ2UgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9kaHQtcnBjLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9kaHQtcnBjL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2RodC1ycGMiCn0KbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCdiYXJlLWV2ZW50cycpCnsKICAibmFtZSI6ICJldmVudHMtdW5pdmVyc2FsIiwKICAidmVyc2lvbiI6ICIxLjAuMSIsCiAgImRlc2NyaXB0aW9uIjogIlVuaXZlcnNhbCB3cmFwcGVyIGZvciB0aGUgTm9kZS5qcyBldmVudHMgbW9kdWxlIiwKICAiZXhwb3J0cyI6IHsKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4iOiB7CiAgICAgICJiYXJlIjogIi4vYmFyZS5qcyIsCiAgICAgICJyZWFjdC1uYXRpdmUiOiAiLi9yZWFjdC1uYXRpdmUuanMiLAogICAgICAiZGVmYXVsdCI6ICIuL2RlZmF1bHQuanMiCiAgICB9CiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImRlZmF1bHQuanMiLAogICAgImJhcmUuanMiLAogICAgInJlYWN0LW5hdGl2ZS5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2V2ZW50cy11bml2ZXJzYWwuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vZXZlbnRzLXVuaXZlcnNhbC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2V2ZW50cy11bml2ZXJzYWwjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtZXZlbnRzIjogIl4yLjcuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAicHJldHRpZXIiOiAiXjMuNC4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4xLjAuMCIKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBGaXhlZEZJRk8gewogIGNvbnN0cnVjdG9yIChod20pIHsKICAgIGlmICghKGh3bSA+IDApIHx8ICgoaHdtIC0gMSkgJiBod20pICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ01heCBzaXplIGZvciBhIEZpeGVkRklGTyBzaG91bGQgYmUgYSBwb3dlciBvZiB0d28nKQogICAgdGhpcy5idWZmZXIgPSBuZXcgQXJyYXkoaHdtKQogICAgdGhpcy5tYXNrID0gaHdtIC0gMQogICAgdGhpcy50b3AgPSAwCiAgICB0aGlzLmJ0bSA9IDAKICAgIHRoaXMubmV4dCA9IG51bGwKICB9CgogIGNsZWFyICgpIHsKICAgIHRoaXMudG9wID0gdGhpcy5idG0gPSAwCiAgICB0aGlzLm5leHQgPSBudWxsCiAgICB0aGlzLmJ1ZmZlci5maWxsKHVuZGVmaW5lZCkKICB9CgogIHB1c2ggKGRhdGEpIHsKICAgIGlmICh0aGlzLmJ1ZmZlclt0aGlzLnRvcF0gIT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlCiAgICB0aGlzLmJ1ZmZlclt0aGlzLnRvcF0gPSBkYXRhCiAgICB0aGlzLnRvcCA9ICh0aGlzLnRvcCArIDEpICYgdGhpcy5tYXNrCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgc2hpZnQgKCkgewogICAgY29uc3QgbGFzdCA9IHRoaXMuYnVmZmVyW3RoaXMuYnRtXQogICAgaWYgKGxhc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHVuZGVmaW5lZAogICAgdGhpcy5idWZmZXJbdGhpcy5idG1dID0gdW5kZWZpbmVkCiAgICB0aGlzLmJ0bSA9ICh0aGlzLmJ0bSArIDEpICYgdGhpcy5tYXNrCiAgICByZXR1cm4gbGFzdAogIH0KCiAgcGVlayAoKSB7CiAgICByZXR1cm4gdGhpcy5idWZmZXJbdGhpcy5idG1dCiAgfQoKICBpc0VtcHR5ICgpIHsKICAgIHJldHVybiB0aGlzLmJ1ZmZlclt0aGlzLmJ0bV0gPT09IHVuZGVmaW5lZAogIH0KfQpjb25zdCBGaXhlZEZJRk8gPSByZXF1aXJlKCcuL2ZpeGVkLXNpemUnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBGYXN0RklGTyB7CiAgY29uc3RydWN0b3IgKGh3bSkgewogICAgdGhpcy5od20gPSBod20gfHwgMTYKICAgIHRoaXMuaGVhZCA9IG5ldyBGaXhlZEZJRk8odGhpcy5od20pCiAgICB0aGlzLnRhaWwgPSB0aGlzLmhlYWQKICAgIHRoaXMubGVuZ3RoID0gMAogIH0KCiAgY2xlYXIgKCkgewogICAgdGhpcy5oZWFkID0gdGhpcy50YWlsCiAgICB0aGlzLmhlYWQuY2xlYXIoKQogICAgdGhpcy5sZW5ndGggPSAwCiAgfQoKICBwdXNoICh2YWwpIHsKICAgIHRoaXMubGVuZ3RoKysKICAgIGlmICghdGhpcy5oZWFkLnB1c2godmFsKSkgewogICAgICBjb25zdCBwcmV2ID0gdGhpcy5oZWFkCiAgICAgIHRoaXMuaGVhZCA9IHByZXYubmV4dCA9IG5ldyBGaXhlZEZJRk8oMiAqIHRoaXMuaGVhZC5idWZmZXIubGVuZ3RoKQogICAgICB0aGlzLmhlYWQucHVzaCh2YWwpCiAgICB9CiAgfQoKICBzaGlmdCAoKSB7CiAgICBpZiAodGhpcy5sZW5ndGggIT09IDApIHRoaXMubGVuZ3RoLS0KICAgIGNvbnN0IHZhbCA9IHRoaXMudGFpbC5zaGlmdCgpCiAgICBpZiAodmFsID09PSB1bmRlZmluZWQgJiYgdGhpcy50YWlsLm5leHQpIHsKICAgICAgY29uc3QgbmV4dCA9IHRoaXMudGFpbC5uZXh0CiAgICAgIHRoaXMudGFpbC5uZXh0ID0gbnVsbAogICAgICB0aGlzLnRhaWwgPSBuZXh0CiAgICAgIHJldHVybiB0aGlzLnRhaWwuc2hpZnQoKQogICAgfQoKICAgIHJldHVybiB2YWwKICB9CgogIHBlZWsgKCkgewogICAgY29uc3QgdmFsID0gdGhpcy50YWlsLnBlZWsoKQogICAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkICYmIHRoaXMudGFpbC5uZXh0KSByZXR1cm4gdGhpcy50YWlsLm5leHQucGVlaygpCiAgICByZXR1cm4gdmFsCiAgfQoKICBpc0VtcHR5ICgpIHsKICAgIHJldHVybiB0aGlzLmxlbmd0aCA9PT0gMAogIH0KfQp7CiAgIm5hbWUiOiAiZmFzdC1maWZvIiwKICAidmVyc2lvbiI6ICIxLjMuMiIsCiAgImRlc2NyaXB0aW9uIjogIkEgZmFzdCBmaWZvIGltcGxlbWVudGF0aW9uIHNpbWlsYXIgdG8gdGhlIG9uZSBwb3dlcmluZyBuZXh0VGljayBpbiBOb2RlLmpzIGNvcmUiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiLi9pbmRleC5qcyIsCiAgICAiLi9maXhlZC1zaXplLmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIsCiAgICAiYnJpdHRsZSI6ICJeMy4zLjIiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9mYXN0LWZpZm8uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2Zhc3QtZmlmby9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9mYXN0LWZpZm8iCn0KY29uc3QgZnMgPSByZXF1aXJlKCdmcycpCmNvbnN0IGZzeCA9IHJlcXVpcmUoJ2ZzLW5hdGl2ZS1leHRlbnNpb25zJykKY29uc3Qgb25leGl0ID0gcmVxdWlyZSgncmVzb3VyY2Utb24tZXhpdCcpCmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEZETG9jayBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yKGZkLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgd2FpdCA9IGZhbHNlIH0gPSBvcHRzCgogICAgc3VwZXIoKQoKICAgIHRoaXMuX2ZkID0gZmQKICAgIHRoaXMuX3dhaXQgPSB3YWl0CiAgICB0aGlzLl9sb2NrZWQgPSBmYWxzZQoKICAgIG9uZXhpdC5hZGQodGhpcywgY2xvc2VTeW5jKQogIH0KCiAgYXN5bmMgX29wZW4oKSB7CiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9yZXN1bWUoKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIG9uZXhpdC5yZW1vdmUodGhpcykKICAgICAgYXdhaXQgY2xvc2UodGhpcykKICAgICAgdGhyb3cgZXJyCiAgICB9CiAgfQoKICBhc3luYyBfY2xvc2UoKSB7CiAgICBvbmV4aXQucmVtb3ZlKHRoaXMpCiAgICBhd2FpdCBjbG9zZSh0aGlzKQogIH0KCiAgdHJhbnNmZXIoKSB7CiAgICBjb25zdCBmZCA9IHRoaXMuX2ZkCiAgICBpZiAoZmQgPT09IC0xKSB0aHJvdyBuZXcgRXJyb3IoJ0xvY2sgaGFzIGFscmVhZHkgYmVlbiB0cmFuc2ZlcnJlZCcpCiAgICB0aGlzLl9mZCA9IC0xCiAgICBvbmV4aXQucmVtb3ZlKHRoaXMpCiAgICByZXR1cm4gZmQKICB9CgogIGFzeW5jIHN1c3BlbmQoKSB7CiAgICBpZiAoIXRoaXMub3BlbmVkKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIHJldHVybiB0aGlzLl9zdXNwZW5kKCkKICB9CgogIGFzeW5jIF9zdXNwZW5kKCkgewogICAgaWYgKHRoaXMuX2ZkID09PSAtMSB8fCB0aGlzLl9sb2NrZWQgPT09IGZhbHNlKSByZXR1cm4KICAgIGZzeC51bmxvY2sodGhpcy5fZmQpCiAgICB0aGlzLl9sb2NrZWQgPSBmYWxzZQogIH0KCiAgYXN5bmMgcmVzdW1lKCkgewogICAgaWYgKCF0aGlzLm9wZW5lZCkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICByZXR1cm4gdGhpcy5fcmVzdW1lKCkKICB9CgogIGFzeW5jIF9yZXN1bWUoKSB7CiAgICBpZiAodGhpcy5fZmQgPT09IC0xIHx8IHRoaXMuX2xvY2tlZCA9PT0gdHJ1ZSkgcmV0dXJuCiAgICBpZiAodGhpcy5fd2FpdCkgYXdhaXQgZnN4LndhaXRGb3JMb2NrKHRoaXMuX2ZkKQogICAgZWxzZSBpZiAoIWZzeC50cnlMb2NrKHRoaXMuX2ZkKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZpbGUgZGVzY3JpcHRvciBjb3VsZCBub3QgYmUgbG9ja2VkJykKICAgIH0KICAgIHRoaXMuX2xvY2tlZCA9IHRydWUKICB9Cn0KCmZ1bmN0aW9uIGNsb3NlKGxvY2spIHsKICBjb25zdCBmZCA9IGxvY2suX2ZkCiAgaWYgKGZkID09PSAtMSkgcmV0dXJuCiAgbG9jay5fZmQgPSAtMQogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gZnMuY2xvc2UoZmQsICgpID0+IHJlc29sdmUoKSkpCn0KCmZ1bmN0aW9uIGNsb3NlU3luYyhsb2NrKSB7CiAgY29uc3QgZmQgPSBsb2NrLl9mZAogIGlmIChmZCA9PT0gLTEpIHJldHVybgogIGxvY2suX2ZkID0gLTEKICB0cnkgewogICAgZnMuY2xvc2VTeW5jKGZkKQogIH0gY2F0Y2gge30KfQp7CiAgIm5hbWUiOiAiZmQtbG9jayIsCiAgInZlcnNpb24iOiAiMi4xLjEiLAogICJkZXNjcmlwdGlvbiI6ICJTdGF0ZWZ1bCBmaWxlIGRlc2NyaXB0b3IgbG9ja3MgZm9yIEphdmFTY3JpcHQiLAogICJleHBvcnRzIjogewogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLiI6ICIuL2luZGV4LmpzIgogIH0sCiAgImltcG9ydHMiOiB7CiAgICAiZnMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZnMiLAogICAgICAiZGVmYXVsdCI6ICJmcyIKICAgIH0KICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAibnBtIHJ1biBsaW50ICYmIG5wbSBydW4gdGVzdDpiYXJlICYmIG5wbSBydW4gdGVzdDpub2RlIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0LmpzIiwKICAgICJ0ZXN0Om5vZGUiOiAibm9kZSB0ZXN0LmpzIiwKICAgICJsaW50IjogInByZXR0aWVyIC0tY2hlY2sgLiIsCiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9mZC1sb2NrLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2ZkLWxvY2svaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9mZC1sb2NrI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWZzIjogIl40LjUuMCIsCiAgICAiZnMtbmF0aXZlLWV4dGVuc2lvbnMiOiAiXjEuNC40IiwKICAgICJyZWFkeS1yZXNvdXJjZSI6ICJeMS4yLjAiLAogICAgInJlc291cmNlLW9uLWV4aXQiOiAiXjEuMC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjMuMiIsCiAgICAicHJldHRpZXIiOiAiXjMuNC4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIKICB9Cn0KZXhwb3J0cy5mdWxsUm9vdHMgPSBmdW5jdGlvbiAoaW5kZXgsIHJlc3VsdCkgewogIGlmIChpbmRleCAmIDEpIHRocm93IG5ldyBFcnJvcignWW91IGNhbiBvbmx5IGxvb2sgdXAgcm9vdHMgZm9yIGRlcHRoKDApIGJsb2NrcycpCiAgaWYgKCFyZXN1bHQpIHJlc3VsdCA9IFtdCgogIGluZGV4IC89IDIKCiAgbGV0IG9mZnNldCA9IDAKICBsZXQgZmFjdG9yID0gMQoKICB3aGlsZSAodHJ1ZSkgewogICAgaWYgKCFpbmRleCkgcmV0dXJuIHJlc3VsdAogICAgd2hpbGUgKGZhY3RvciAqIDIgPD0gaW5kZXgpIGZhY3RvciAqPSAyCiAgICByZXN1bHQucHVzaChvZmZzZXQgKyBmYWN0b3IgLSAxKQogICAgb2Zmc2V0ID0gb2Zmc2V0ICsgMiAqIGZhY3RvcgogICAgaW5kZXggLT0gZmFjdG9yCiAgICBmYWN0b3IgPSAxCiAgfQp9CgpleHBvcnRzLmZ1dHVyZVJvb3RzID0gZnVuY3Rpb24gKGluZGV4LCByZXN1bHQpIHsKICBpZiAoaW5kZXggJiAxKSB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBjYW4gb25seSBsb29rIHVwIGZ1dHVyZSByb290cyBmb3IgZGVwdGgoMCkgYmxvY2tzJykKICBpZiAoIXJlc3VsdCkgcmVzdWx0ID0gW10KCiAgbGV0IGZhY3RvciA9IDEKCiAgLy8gbWFrZSBmaXJzdCByb290CiAgd2hpbGUgKGZhY3RvciAqIDIgPD0gaW5kZXgpIGZhY3RvciAqPSAyCgogIC8vIGZ1bGwgZmFjdG9yIG9mIDIgLSBkb25lCiAgaWYgKGZhY3RvciAqIDIgLSAyID09PSBpbmRleCkgcmV0dXJuIHJlc3VsdAoKICBsZXQgcG9zID0gZmFjdG9yIC8gMiAtIDEKCiAgLy8gd2hpbGUgaXRzIG5vdCBhIGZ1bGwgdHJlZQogIHdoaWxlICgocG9zICsgZmFjdG9yIC8gMiAtIDEpICE9PSBpbmRleCkgewogICAgcG9zICs9IGZhY3RvcgoKICAgIC8vIHJlYWQgdG9vIGZhciwgdG8gdG8gbGVmdCBjaGlsZAogICAgd2hpbGUgKChwb3MgKyBmYWN0b3IgLyAyIC0gMSkgPiBpbmRleCkgewogICAgICBmYWN0b3IgLz0gMgogICAgICBwb3MgLT0gZmFjdG9yIC8gMgogICAgfQoKICAgIC8vIHRoZSAiZ2FwIiBpcyBhIGZ1dHVyZSByb290CiAgICByZXN1bHQucHVzaChwb3MgLSBmYWN0b3IgLyAyKQogIH0KCiAgcmV0dXJuIHJlc3VsdAp9CgpleHBvcnRzLnBhdGNoID0gZnVuY3Rpb24gKGZyb20sIHRvKSB7CiAgaWYgKGZyb20gPT09IDAgfHwgZnJvbSA+PSB0bykgcmV0dXJuIFtdCgogIGNvbnN0IHJvb3RzID0gZXhwb3J0cy5mdWxsUm9vdHMoZnJvbSkKICBjb25zdCB0YXJnZXQgPSBleHBvcnRzLmZ1bGxSb290cyh0bykKCiAgLy8gZmlyc3QgZmluZCB0aGUgZmlyc3Qgcm9vdCB0aGF0IGlzIGRpZmZlcmVudAoKICBsZXQgaSA9IDAKICBmb3IgKDsgaSA8IHRhcmdldC5sZW5ndGg7IGkrKykgewogICAgaWYgKGkgPj0gcm9vdHMubGVuZ3RoIHx8IHJvb3RzW2ldICE9PSB0YXJnZXRbaV0pIGJyZWFrCiAgfQoKICBjb25zdCBwYXRjaCA9IFtdCgogIGlmIChpIDwgcm9vdHMubGVuZ3RoKSB7CiAgICAvLyBub3cgd2UgbmVlZCB0byBncm93IHRoZSBuZXdlc3Qgcm9vdCB1bnRpbCBpdCBoaXRzIHRoZSBkaWZmIG9uZQogICAgbGV0IHByZXYgPSByb290cy5sZW5ndGggLSAxCgogICAgY29uc3QgaXRlID0gZXhwb3J0cy5pdGVyYXRvcihyb290c1twcmV2LS1dKQoKICAgIHdoaWxlIChpdGUuaW5kZXggIT09IHRhcmdldFtpXSkgewogICAgICBpdGUuc2libGluZygpCgogICAgICBpZiAocHJldiA+PSAwICYmIGl0ZS5pbmRleCA9PT0gcm9vdHNbcHJldl0pIHsKICAgICAgICBwcmV2LS0KICAgICAgfSBlbHNlIHsKICAgICAgICBwYXRjaC5wdXNoKGl0ZS5pbmRleCkKICAgICAgfQoKICAgICAgcGF0Y2gucHVzaChpdGUucGFyZW50KCkpCiAgICB9CgogICAgaSsrIC8vIHBhdGNoZWQgdG8gbmV4dCByb290LCBzbyBpbmMKICB9CgogIC8vIGluY2x1ZGUgdGhlIHJlc3QKCiAgZm9yICg7IGkgPCB0YXJnZXQubGVuZ3RoOyBpKyspIHBhdGNoLnB1c2godGFyZ2V0W2ldKQoKICByZXR1cm4gcGF0Y2gKfQoKZXhwb3J0cy5kZXB0aCA9IGZ1bmN0aW9uIChpbmRleCkgewogIGxldCBkZXB0aCA9IDAKCiAgaW5kZXggKz0gMQogIHdoaWxlICghKGluZGV4ICYgMSkpIHsKICAgIGRlcHRoKysKICAgIGluZGV4ID0gcmlnaHRTaGlmdChpbmRleCkKICB9CgogIHJldHVybiBkZXB0aAp9CgpleHBvcnRzLnNpYmxpbmcgPSBmdW5jdGlvbiAoaW5kZXgsIGRlcHRoKSB7CiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQogIGNvbnN0IG9mZnNldCA9IGV4cG9ydHMub2Zmc2V0KGluZGV4LCBkZXB0aCkKCiAgcmV0dXJuIGV4cG9ydHMuaW5kZXgoZGVwdGgsIG9mZnNldCAmIDEgPyBvZmZzZXQgLSAxIDogb2Zmc2V0ICsgMSkKfQoKZXhwb3J0cy5wYXJlbnQgPSBmdW5jdGlvbiAoaW5kZXgsIGRlcHRoKSB7CiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQogIGNvbnN0IG9mZnNldCA9IGV4cG9ydHMub2Zmc2V0KGluZGV4LCBkZXB0aCkKCiAgcmV0dXJuIGV4cG9ydHMuaW5kZXgoZGVwdGggKyAxLCByaWdodFNoaWZ0KG9mZnNldCkpCn0KCmV4cG9ydHMubGVmdENoaWxkID0gZnVuY3Rpb24gKGluZGV4LCBkZXB0aCkgewogIGlmICghKGluZGV4ICYgMSkpIHJldHVybiAtMQogIGlmICghZGVwdGgpIGRlcHRoID0gZXhwb3J0cy5kZXB0aChpbmRleCkKICByZXR1cm4gZXhwb3J0cy5pbmRleChkZXB0aCAtIDEsIGV4cG9ydHMub2Zmc2V0KGluZGV4LCBkZXB0aCkgKiAyKQp9CgpleHBvcnRzLnJpZ2h0Q2hpbGQgPSBmdW5jdGlvbiAoaW5kZXgsIGRlcHRoKSB7CiAgaWYgKCEoaW5kZXggJiAxKSkgcmV0dXJuIC0xCiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQogIHJldHVybiBleHBvcnRzLmluZGV4KGRlcHRoIC0gMSwgMSArIChleHBvcnRzLm9mZnNldChpbmRleCwgZGVwdGgpICogMikpCn0KCmV4cG9ydHMuY2hpbGRyZW4gPSBmdW5jdGlvbiAoaW5kZXgsIGRlcHRoKSB7CiAgaWYgKCEoaW5kZXggJiAxKSkgcmV0dXJuIG51bGwKCiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQogIGNvbnN0IG9mZnNldCA9IGV4cG9ydHMub2Zmc2V0KGluZGV4LCBkZXB0aCkgKiAyCgogIHJldHVybiBbCiAgICBleHBvcnRzLmluZGV4KGRlcHRoIC0gMSwgb2Zmc2V0KSwKICAgIGV4cG9ydHMuaW5kZXgoZGVwdGggLSAxLCBvZmZzZXQgKyAxKQogIF0KfQoKZXhwb3J0cy5sZWZ0U3BhbiA9IGZ1bmN0aW9uIChpbmRleCwgZGVwdGgpIHsKICBpZiAoIShpbmRleCAmIDEpKSByZXR1cm4gaW5kZXgKICBpZiAoIWRlcHRoKSBkZXB0aCA9IGV4cG9ydHMuZGVwdGgoaW5kZXgpCiAgcmV0dXJuIGV4cG9ydHMub2Zmc2V0KGluZGV4LCBkZXB0aCkgKiB0d29Qb3coZGVwdGggKyAxKQp9CgpleHBvcnRzLnJpZ2h0U3BhbiA9IGZ1bmN0aW9uIChpbmRleCwgZGVwdGgpIHsKICBpZiAoIShpbmRleCAmIDEpKSByZXR1cm4gaW5kZXgKICBpZiAoIWRlcHRoKSBkZXB0aCA9IGV4cG9ydHMuZGVwdGgoaW5kZXgpCiAgcmV0dXJuIChleHBvcnRzLm9mZnNldChpbmRleCwgZGVwdGgpICsgMSkgKiB0d29Qb3coZGVwdGggKyAxKSAtIDIKfQoKZXhwb3J0cy5uZXh0TGVhZiA9IGZ1bmN0aW9uIChpbmRleCkgewogIGxldCBmYWN0b3IgPSAxCiAgbGV0IHIgPSBpbmRleAoKICB3aGlsZSAoKHIgJiAxKSA9PT0gMSkgewogICAgciA9IChyIC0gMSkgLyAyCiAgICBmYWN0b3IgKj0gMgogIH0KCiAgcmV0dXJuIGluZGV4ICsgZmFjdG9yICsgMQp9CgpleHBvcnRzLmNvdW50ID0gZnVuY3Rpb24gKGluZGV4LCBkZXB0aCkgewogIGlmICghKGluZGV4ICYgMSkpIHJldHVybiAxCiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQogIHJldHVybiB0d29Qb3coZGVwdGggKyAxKSAtIDEKfQoKZXhwb3J0cy5jb3VudExlYXZlcyA9IGZ1bmN0aW9uIChpbmRleCkgewogIHJldHVybiAoZXhwb3J0cy5jb3VudChpbmRleCkgKyAxKSAvIDIKfQoKZXhwb3J0cy5zcGFucyA9IGZ1bmN0aW9uIChpbmRleCwgZGVwdGgpIHsKICBpZiAoIShpbmRleCAmIDEpKSByZXR1cm4gW2luZGV4LCBpbmRleF0KICBpZiAoIWRlcHRoKSBkZXB0aCA9IGV4cG9ydHMuZGVwdGgoaW5kZXgpCgogIGNvbnN0IG9mZnNldCA9IGV4cG9ydHMub2Zmc2V0KGluZGV4LCBkZXB0aCkKICBjb25zdCB3aWR0aCA9IHR3b1BvdyhkZXB0aCArIDEpCgogIHJldHVybiBbb2Zmc2V0ICogd2lkdGgsIChvZmZzZXQgKyAxKSAqIHdpZHRoIC0gMl0KfQoKZXhwb3J0cy5pbmRleCA9IGZ1bmN0aW9uIChkZXB0aCwgb2Zmc2V0KSB7CiAgcmV0dXJuICgxICsgMiAqIG9mZnNldCkgKiB0d29Qb3coZGVwdGgpIC0gMQp9CgpleHBvcnRzLm9mZnNldCA9IGZ1bmN0aW9uIChpbmRleCwgZGVwdGgpIHsKICBpZiAoIShpbmRleCAmIDEpKSByZXR1cm4gaW5kZXggLyAyCiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQoKICByZXR1cm4gKChpbmRleCArIDEpIC8gdHdvUG93KGRlcHRoKSAtIDEpIC8gMgp9CgpleHBvcnRzLml0ZXJhdG9yID0gZnVuY3Rpb24gKGluZGV4KSB7CiAgY29uc3QgaXRlID0gbmV3IEl0ZXJhdG9yKCkKICBpdGUuc2VlayhpbmRleCB8fCAwKQogIHJldHVybiBpdGUKfQoKZnVuY3Rpb24gdHdvUG93IChuKSB7CiAgcmV0dXJuIG4gPCAzMSA/IDEgPDwgbiA6ICgoMSA8PCAzMCkgKiAoMSA8PCAobiAtIDMwKSkpCn0KCmZ1bmN0aW9uIHJpZ2h0U2hpZnQgKG4pIHsKICByZXR1cm4gKG4gLSAobiAmIDEpKSAvIDIKfQoKZnVuY3Rpb24gSXRlcmF0b3IgKCkgewogIHRoaXMuaW5kZXggPSAwCiAgdGhpcy5vZmZzZXQgPSAwCiAgdGhpcy5mYWN0b3IgPSAwCn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5zZWVrID0gZnVuY3Rpb24gKGluZGV4KSB7CiAgdGhpcy5pbmRleCA9IGluZGV4CiAgaWYgKHRoaXMuaW5kZXggJiAxKSB7CiAgICB0aGlzLm9mZnNldCA9IGV4cG9ydHMub2Zmc2V0KGluZGV4KQogICAgdGhpcy5mYWN0b3IgPSB0d29Qb3coZXhwb3J0cy5kZXB0aChpbmRleCkgKyAxKQogIH0gZWxzZSB7CiAgICB0aGlzLm9mZnNldCA9IGluZGV4IC8gMgogICAgdGhpcy5mYWN0b3IgPSAyCiAgfQp9CgpJdGVyYXRvci5wcm90b3R5cGUuaXNMZWZ0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiAodGhpcy5vZmZzZXQgJiAxKSA9PT0gMAp9CgpJdGVyYXRvci5wcm90b3R5cGUuaXNSaWdodCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gKHRoaXMub2Zmc2V0ICYgMSkgPT09IDEKfQoKSXRlcmF0b3IucHJvdG90eXBlLmlzUm9vdCA9IGZ1bmN0aW9uIChsZW5ndGgpIHsKICBjb25zdCBjdXJyZW50TGVuZ3RoID0gMSArICh0aGlzLmluZGV4ICsgdGhpcy5mYWN0b3IgLyAyIC0gMSkgLyAyCiAgaWYgKGxlbmd0aCA8IGN1cnJlbnRMZW5ndGgpIHJldHVybiBmYWxzZQoKICBjb25zdCBmYWN0b3IgPSB0aGlzLmZhY3RvciAqIDIKICBjb25zdCBpbmRleCA9ICh0aGlzLm9mZnNldCAmIDEpCiAgICA/IHRoaXMuaW5kZXggLSB0aGlzLmZhY3RvciAvIDIKICAgIDogdGhpcy5pbmRleCArIHRoaXMuZmFjdG9yIC8gMgoKICBjb25zdCBwYXJlbnRMZW5ndGggPSAxICsgKGluZGV4ICsgZmFjdG9yIC8gMiAtIDEpIC8gMgogIHJldHVybiBwYXJlbnRMZW5ndGggPiBsZW5ndGgKfQoKSXRlcmF0b3IucHJvdG90eXBlLmNvbnRhaW5zID0gZnVuY3Rpb24gKGluZGV4KSB7CiAgcmV0dXJuIGluZGV4ID4gdGhpcy5pbmRleAogICAgPyBpbmRleCA8ICh0aGlzLmluZGV4ICsgdGhpcy5mYWN0b3IgLyAyKQogICAgOiBpbmRleCA8IHRoaXMuaW5kZXgKICAgICAgPyBpbmRleCA+ICh0aGlzLmluZGV4IC0gdGhpcy5mYWN0b3IgLyAyKQogICAgICA6IHRydWUKfQoKSXRlcmF0b3IucHJvdG90eXBlLnByZXYgPSBmdW5jdGlvbiAoKSB7CiAgaWYgKCF0aGlzLm9mZnNldCkgcmV0dXJuIHRoaXMuaW5kZXgKICB0aGlzLm9mZnNldC0tCiAgdGhpcy5pbmRleCAtPSB0aGlzLmZhY3RvcgogIHJldHVybiB0aGlzLmluZGV4Cn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5uZXh0ID0gZnVuY3Rpb24gKCkgewogIHRoaXMub2Zmc2V0KysKICB0aGlzLmluZGV4ICs9IHRoaXMuZmFjdG9yCiAgcmV0dXJuIHRoaXMuaW5kZXgKfQoKSXRlcmF0b3IucHJvdG90eXBlLmNvdW50ID0gZnVuY3Rpb24gKCkgewogIGlmICghKHRoaXMuaW5kZXggJiAxKSkgcmV0dXJuIDEKICByZXR1cm4gdGhpcy5mYWN0b3IgLSAxCn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5jb3VudExlYXZlcyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gKHRoaXMuY291bnQoKSArIDEpIC8gMgp9CgpJdGVyYXRvci5wcm90b3R5cGUuc2libGluZyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5pc0xlZnQoKSA/IHRoaXMubmV4dCgpIDogdGhpcy5wcmV2KCkKfQoKSXRlcmF0b3IucHJvdG90eXBlLnBhcmVudCA9IGZ1bmN0aW9uICgpIHsKICBpZiAodGhpcy5vZmZzZXQgJiAxKSB7CiAgICB0aGlzLmluZGV4IC09IHRoaXMuZmFjdG9yIC8gMgogICAgdGhpcy5vZmZzZXQgPSAodGhpcy5vZmZzZXQgLSAxKSAvIDIKICB9IGVsc2UgewogICAgdGhpcy5pbmRleCArPSB0aGlzLmZhY3RvciAvIDIKICAgIHRoaXMub2Zmc2V0IC89IDIKICB9CiAgdGhpcy5mYWN0b3IgKj0gMgogIHJldHVybiB0aGlzLmluZGV4Cn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5sZWZ0U3BhbiA9IGZ1bmN0aW9uICgpIHsKICB0aGlzLmluZGV4ID0gdGhpcy5pbmRleCAtIHRoaXMuZmFjdG9yIC8gMiArIDEKICB0aGlzLm9mZnNldCA9IHRoaXMuaW5kZXggLyAyCiAgdGhpcy5mYWN0b3IgPSAyCiAgcmV0dXJuIHRoaXMuaW5kZXgKfQoKSXRlcmF0b3IucHJvdG90eXBlLnBlZWtMZWZ0U3BhbiA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5pbmRleCAtIHRoaXMuZmFjdG9yIC8gMiArIDEKfQoKSXRlcmF0b3IucHJvdG90eXBlLnJpZ2h0U3BhbiA9IGZ1bmN0aW9uICgpIHsKICB0aGlzLmluZGV4ID0gdGhpcy5pbmRleCArIHRoaXMuZmFjdG9yIC8gMiAtIDEKICB0aGlzLm9mZnNldCA9IHRoaXMuaW5kZXggLyAyCiAgdGhpcy5mYWN0b3IgPSAyCiAgcmV0dXJuIHRoaXMuaW5kZXgKfQoKSXRlcmF0b3IucHJvdG90eXBlLnBlZWtSaWdodFNwYW4gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuaW5kZXggKyB0aGlzLmZhY3RvciAvIDIgLSAxCn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5sZWZ0Q2hpbGQgPSBmdW5jdGlvbiAoKSB7CiAgaWYgKHRoaXMuZmFjdG9yID09PSAyKSByZXR1cm4gdGhpcy5pbmRleAogIHRoaXMuZmFjdG9yIC89IDIKICB0aGlzLmluZGV4IC09IHRoaXMuZmFjdG9yIC8gMgogIHRoaXMub2Zmc2V0ICo9IDIKICByZXR1cm4gdGhpcy5pbmRleAp9CgpJdGVyYXRvci5wcm90b3R5cGUucmlnaHRDaGlsZCA9IGZ1bmN0aW9uICgpIHsKICBpZiAodGhpcy5mYWN0b3IgPT09IDIpIHJldHVybiB0aGlzLmluZGV4CiAgdGhpcy5mYWN0b3IgLz0gMgogIHRoaXMuaW5kZXggKz0gdGhpcy5mYWN0b3IgLyAyCiAgdGhpcy5vZmZzZXQgPSAyICogdGhpcy5vZmZzZXQgKyAxCiAgcmV0dXJuIHRoaXMuaW5kZXgKfQoKSXRlcmF0b3IucHJvdG90eXBlLm5leHRUcmVlID0gZnVuY3Rpb24gKCkgewogIHRoaXMuaW5kZXggPSB0aGlzLmluZGV4ICsgdGhpcy5mYWN0b3IgLyAyICsgMQogIHRoaXMub2Zmc2V0ID0gdGhpcy5pbmRleCAvIDIKICB0aGlzLmZhY3RvciA9IDIKICByZXR1cm4gdGhpcy5pbmRleAp9CgpJdGVyYXRvci5wcm90b3R5cGUucHJldlRyZWUgPSBmdW5jdGlvbiAoKSB7CiAgaWYgKCF0aGlzLm9mZnNldCkgewogICAgdGhpcy5pbmRleCA9IDAKICAgIHRoaXMuZmFjdG9yID0gMgogIH0gZWxzZSB7CiAgICB0aGlzLmluZGV4ID0gdGhpcy5pbmRleCAtIHRoaXMuZmFjdG9yIC8gMiAtIDEKICAgIHRoaXMub2Zmc2V0ID0gdGhpcy5pbmRleCAvIDIKICAgIHRoaXMuZmFjdG9yID0gMgogIH0KICByZXR1cm4gdGhpcy5pbmRleAp9CgpJdGVyYXRvci5wcm90b3R5cGUuZnVsbFJvb3QgPSBmdW5jdGlvbiAoaW5kZXgpIHsKICBpZiAoaW5kZXggPD0gdGhpcy5pbmRleCB8fCAodGhpcy5pbmRleCAmIDEpID4gMCkgcmV0dXJuIGZhbHNlCiAgd2hpbGUgKGluZGV4ID4gdGhpcy5pbmRleCArIHRoaXMuZmFjdG9yICsgdGhpcy5mYWN0b3IgLyAyKSB7CiAgICB0aGlzLmluZGV4ICs9IHRoaXMuZmFjdG9yIC8gMgogICAgdGhpcy5mYWN0b3IgKj0gMgogICAgdGhpcy5vZmZzZXQgLz0gMgogIH0KICByZXR1cm4gdHJ1ZQp9CnsKICAibmFtZSI6ICJmbGF0LXRyZWUiLAogICJ2ZXJzaW9uIjogIjEuMTMuMCIsCiAgImRlc2NyaXB0aW9uIjogIkEgc2VyaWVzIG9mIGZ1bmN0aW9ucyB0byBtYXAgYSBiaW5hcnkgdHJlZSB0byBhIGxpc3QiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjMuMiIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2ZsYXQtdHJlZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvZmxhdC10cmVlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2ZsYXQtdHJlZSIKfQpyZXF1aXJlLmFkZG9uID0gcmVxdWlyZSgncmVxdWlyZS1hZGRvbicpCgptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUuYWRkb24oJy4nLCBfX2ZpbGVuYW1lKQpjb25zdCB7IGlzV2luZG93cyB9ID0gcmVxdWlyZSgnd2hpY2gtcnVudGltZScpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuL2JpbmRpbmcnKQoKZnVuY3Rpb24gb253b3JrKGVyciwgcmVzdWx0KSB7CiAgaWYgKGVycikgdGhpcy5yZWplY3QoZXJyKQogIGVsc2UgdGhpcy5yZXNvbHZlKHJlc3VsdCkKfQoKZXhwb3J0cy50cnlMb2NrID0gZnVuY3Rpb24gdHJ5TG9jayhmZCwgb2Zmc2V0ID0gMCwgbGVuZ3RoID0gMCwgb3B0cyA9IHt9KSB7CiAgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICdvYmplY3QnKSB7CiAgICBvcHRzID0gb2Zmc2V0CiAgICBvZmZzZXQgPSAwCiAgfQoKICBpZiAodHlwZW9mIGxlbmd0aCA9PT0gJ29iamVjdCcpIHsKICAgIG9wdHMgPSBsZW5ndGgKICAgIGxlbmd0aCA9IDAKICB9CgogIGlmICh0eXBlb2Ygb3B0cyAhPT0gJ29iamVjdCcgfHwgb3B0cyA9PT0gbnVsbCkgewogICAgb3B0cyA9IHt9CiAgfQoKICB0cnkgewogICAgYmluZGluZy50cnlMb2NrKGZkLCBvZmZzZXQsIGxlbmd0aCwgb3B0cy5zaGFyZWQgIT09IHRydWUpCiAgfSBjYXRjaCAoZXJyKSB7CiAgICBpZiAoZXJyLmNvZGUgPT09ICdFQUdBSU4nKSByZXR1cm4gZmFsc2UKICAgIHRocm93IGVycgogIH0KCiAgcmV0dXJuIHRydWUKfQoKZXhwb3J0cy53YWl0Rm9yTG9jayA9IGZ1bmN0aW9uIHdhaXRGb3JMb2NrKAogIGZkLAogIG9mZnNldCA9IDAsCiAgbGVuZ3RoID0gMCwKICBvcHRzID0ge30KKSB7CiAgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICdvYmplY3QnKSB7CiAgICBvcHRzID0gb2Zmc2V0CiAgICBvZmZzZXQgPSAwCiAgfQoKICBpZiAodHlwZW9mIGxlbmd0aCA9PT0gJ29iamVjdCcpIHsKICAgIG9wdHMgPSBsZW5ndGgKICAgIGxlbmd0aCA9IDAKICB9CgogIGlmICh0eXBlb2Ygb3B0cyAhPT0gJ29iamVjdCcgfHwgb3B0cyA9PT0gbnVsbCkgewogICAgb3B0cyA9IHt9CiAgfQoKICBjb25zdCByZXEgPSB7CiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLndhaXRGb3JMb2NrKAogICAgICBmZCwKICAgICAgb2Zmc2V0LAogICAgICBsZW5ndGgsCiAgICAgIG9wdHMuc2hhcmVkICE9PSB0cnVlLAogICAgICByZXEsCiAgICAgIG9ud29yawogICAgKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICB9CgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMudHJ5RG93bmdyYWRlTG9jayA9IGZ1bmN0aW9uIHRyeURvd25ncmFkZUxvY2soCiAgZmQsCiAgb2Zmc2V0ID0gMCwKICBsZW5ndGggPSAwCikgewogIHRyeSB7CiAgICBiaW5kaW5nLnRyeURvd25ncmFkZUxvY2soZmQsIG9mZnNldCwgbGVuZ3RoKQogIH0gY2F0Y2ggKGVycikgewogICAgaWYgKGVyci5jb2RlID09PSAnRUFHQUlOJykgcmV0dXJuIGZhbHNlCiAgICB0aHJvdyBlcnIKICB9CgogIHJldHVybiB0cnVlCn0KCmV4cG9ydHMud2FpdEZvckRvd25ncmFkZUxvY2sgPSBmdW5jdGlvbiBkb3duZ3JhZGVMb2NrKAogIGZkLAogIG9mZnNldCA9IDAsCiAgbGVuZ3RoID0gMAopIHsKICBjb25zdCByZXEgPSB7CiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLndhaXRGb3JEb3duZ3JhZGVMb2NrKGZkLCBvZmZzZXQsIGxlbmd0aCwgcmVxLCBvbndvcmspCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy50cnlVcGdyYWRlTG9jayA9IGZ1bmN0aW9uIHRyeVVwZ3JhZGVMb2NrKGZkLCBvZmZzZXQgPSAwLCBsZW5ndGggPSAwKSB7CiAgdHJ5IHsKICAgIGJpbmRpbmcudHJ5VXBncmFkZUxvY2soZmQsIG9mZnNldCwgbGVuZ3RoKQogIH0gY2F0Y2ggKGVycikgewogICAgaWYgKGVyci5jb2RlID09PSAnRUFHQUlOJykgcmV0dXJuIGZhbHNlCiAgICB0aHJvdyBlcnIKICB9CgogIHJldHVybiB0cnVlCn0KCmV4cG9ydHMud2FpdEZvclVwZ3JhZGVMb2NrID0gZnVuY3Rpb24gdXBncmFkZUxvY2soZmQsIG9mZnNldCA9IDAsIGxlbmd0aCA9IDApIHsKICBjb25zdCByZXEgPSB7CiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLndhaXRGb3JVcGdyYWRlTG9jayhmZCwgb2Zmc2V0LCBsZW5ndGgsIHJlcSwgb253b3JrKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICB9CgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMudW5sb2NrID0gZnVuY3Rpb24gdW5sb2NrKGZkLCBvZmZzZXQgPSAwLCBsZW5ndGggPSAwKSB7CiAgYmluZGluZy51bmxvY2soZmQsIG9mZnNldCwgbGVuZ3RoKQp9CgpleHBvcnRzLnRyaW0gPSBmdW5jdGlvbiB0cmltKGZkLCBvZmZzZXQsIGxlbmd0aCkgewogIGNvbnN0IHJlcSA9IHsKICAgIGhhbmRsZTogbnVsbCwKICAgIHJlc29sdmU6IG51bGwsCiAgICByZWplY3Q6IG51bGwKICB9CgogIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgIHJlcS5yZWplY3QgPSByZWplY3QKICB9KQoKICB0cnkgewogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcudHJpbShmZCwgb2Zmc2V0LCBsZW5ndGgsIHJlcSwgb253b3JrKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICB9CgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMuc3BhcnNlID0gZnVuY3Rpb24gc3BhcnNlKGZkKSB7CiAgLy8gU2hvcnQgY2lyY3VpdCBvbiBldmVyeXRoaW5nIGJ1dCBXaW5kb3dzCiAgaWYgKCFpc1dpbmRvd3MpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQoKICBjb25zdCByZXEgPSB7CiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLnNwYXJzZShmZCwgcmVxLCBvbndvcmspCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5zd2FwID0gZnVuY3Rpb24gc3dhcChmcm9tLCB0bykgewogIGNvbnN0IHJlcSA9IHsKICAgIGhhbmRsZTogbnVsbCwKICAgIHJlc29sdmU6IG51bGwsCiAgICByZWplY3Q6IG51bGwKICB9CgogIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgIHJlcS5yZWplY3QgPSByZWplY3QKICB9KQoKICB0cnkgewogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcuc3dhcChmcm9tLCB0bywgcmVxLCBvbndvcmspCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5nZXRBdHRyID0gZnVuY3Rpb24gZ2V0QXR0cihmZCwgbmFtZSkgewogIGNvbnN0IHJlcSA9IHsKICAgIGhhbmRsZTogbnVsbCwKICAgIHJlc29sdmU6IG51bGwsCiAgICByZWplY3Q6IG51bGwKICB9CgogIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgIHJlcS5yZWplY3QgPSByZWplY3QKICB9KQoKICB0cnkgewogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcuZ2V0QXR0cihmZCwgbmFtZSwgcmVxLCBvbndvcmspCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UudGhlbigoYnVmZmVyKSA9PgogICAgYnVmZmVyID09PSBudWxsID8gbnVsbCA6IEJ1ZmZlci5mcm9tKGJ1ZmZlcikKICApCn0KCmV4cG9ydHMuc2V0QXR0ciA9IGZ1bmN0aW9uIHNldEF0dHIoZmQsIG5hbWUsIHZhbHVlLCBlbmNvZGluZykgewogIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB2YWx1ZSA9IEJ1ZmZlci5mcm9tKHZhbHVlLCBlbmNvZGluZykKCiAgY29uc3QgcmVxID0gewogICAgdmFsdWUsCiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLnNldEF0dHIoCiAgICAgIGZkLAogICAgICBuYW1lLAogICAgICB2YWx1ZS5idWZmZXIsCiAgICAgIHZhbHVlLmJ5dGVPZmZzZXQsCiAgICAgIHZhbHVlLmJ5dGVMZW5ndGgsCiAgICAgIHJlcSwKICAgICAgb253b3JrCiAgICApCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5yZW1vdmVBdHRyID0gZnVuY3Rpb24gcmVtb3ZlQXR0cihmZCwgbmFtZSkgewogIGNvbnN0IHJlcSA9IHsKICAgIGhhbmRsZTogbnVsbCwKICAgIHJlc29sdmU6IG51bGwsCiAgICByZWplY3Q6IG51bGwKICB9CgogIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgIHJlcS5yZWplY3QgPSByZWplY3QKICB9KQoKICB0cnkgewogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcucmVtb3ZlQXR0cihmZCwgbmFtZSwgcmVxLCBvbndvcmspCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5saXN0QXR0cnMgPSBmdW5jdGlvbiBsaXN0QXR0cnMoZmQpIHsKICBjb25zdCByZXEgPSB7CiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLmxpc3RBdHRycyhmZCwgcmVxLCBvbndvcmspCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQp7CiAgIm5hbWUiOiAiZnMtbmF0aXZlLWV4dGVuc2lvbnMiLAogICJ2ZXJzaW9uIjogIjEuNC41IiwKICAiZGVzY3JpcHRpb24iOiAiTmF0aXZlIGZpbGUgc3lzdGVtIGV4dGVuc2lvbnMgZm9yIGFkdmFuY2VkIGZpbGUgb3BlcmF0aW9ucyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibWFjcm9zLmgiLAogICAgImJpbmRpbmcuYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiLAogICAgImluY2x1ZGUiLAogICAgInNyYyIsCiAgICAicHJlYnVpbGRzIgogIF0sCiAgImltcG9ydHMiOiB7CiAgICAiY2hpbGRfcHJvY2VzcyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1zdWJwcm9jZXNzIiwKICAgICAgImRlZmF1bHQiOiAiY2hpbGRfcHJvY2VzcyIKICAgIH0sCiAgICAiZnMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZnMiLAogICAgICAiZGVmYXVsdCI6ICJmcyIKICAgIH0sCiAgICAiZnMvKiI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1mcy8qIiwKICAgICAgImRlZmF1bHQiOiAiZnMvKiIKICAgIH0sCiAgICAicGF0aCI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1wYXRoIiwKICAgICAgImRlZmF1bHQiOiAicGF0aCIKICAgIH0KICB9LAogICJhZGRvbiI6IHRydWUsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJucG0gcnVuIGxpbnQgJiYgbnBtIHJ1biB0ZXN0OmJhcmUgJiYgbnBtIHJ1biB0ZXN0Om5vZGUiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QuanMiLAogICAgInRlc3Q6bm9kZSI6ICJub2RlIHRlc3QuanMiLAogICAgImxpbnQiOiAicHJldHRpZXIgLiAtLWNoZWNrIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2ZzLW5hdGl2ZS1leHRlbnNpb25zLmdpdCIKICB9LAogICJhdXRob3IiOiAiS2FzcGVyIElzYWdlciBEYWxzZ2Fyw7AgPGthc3BlckBmdW5rdGlvbmVsLmNvPiIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2ZzLW5hdGl2ZS1leHRlbnNpb25zI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJyZXF1aXJlLWFkZG9uIjogIl4xLjEuMCIsCiAgICAid2hpY2gtcnVudGltZSI6ICJeMS4yLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtY29tcGF0LW5hcGkiOiAiXjEuMy44IiwKICAgICJiYXJlLWZzIjogIl40LjQuNCIsCiAgICAiYmFyZS1wYXRoIjogIl4zLjAuMCIsCiAgICAiYmFyZS1zdWJwcm9jZXNzIjogIl40LjAuNSIsCiAgICAiYnJpdHRsZSI6ICJeMy4xLjEiLAogICAgImNtYWtlLWJhcmUiOiAiXjEuMS4xMCIsCiAgICAiY21ha2UtZmV0Y2giOiAiXjEuNC43IiwKICAgICJjbWFrZS1uYXBpIjogIl4xLjAuNSIsCiAgICAiY21ha2UtbnBtIjogIl4xLjEuMCIsCiAgICAibWluaW1pc3QiOiAiXjEuMi42IiwKICAgICJwcmV0dGllciI6ICJeMy41LjMiLAogICAgInByZXR0aWVyLWNvbmZpZy1zdGFuZGFyZCI6ICJeNy4wLjAiLAogICAgInRlc3QtdG1wIjogIl4xLjIuMSIKICB9Cn0KY29uc3QgY29kZWNzID0gcmVxdWlyZSgnY29kZWNzJykKY29uc3QgeyBSZWFkYWJsZSB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IG11dGV4aWZ5ID0gcmVxdWlyZSgnbXV0ZXhpZnkvcHJvbWlzZScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKY29uc3QgZGVib3VuY2UgPSByZXF1aXJlKCdkZWJvdW5jZWlmeScpCmNvbnN0IFJhY2hlID0gcmVxdWlyZSgncmFjaGUnKQpjb25zdCBycnAgPSByZXF1aXJlKCdyZXNvbHZlLXJlamVjdC1wcm9taXNlJykKCmNvbnN0IHsgYWxsOiB1bnNsYWJBbGwgfSA9IHJlcXVpcmUoJ3Vuc2xhYicpCgpjb25zdCBSYW5nZUl0ZXJhdG9yID0gcmVxdWlyZSgnLi9pdGVyYXRvcnMvcmFuZ2UnKQpjb25zdCBIaXN0b3J5SXRlcmF0b3IgPSByZXF1aXJlKCcuL2l0ZXJhdG9ycy9oaXN0b3J5JykKY29uc3QgRGlmZkl0ZXJhdG9yID0gcmVxdWlyZSgnLi9pdGVyYXRvcnMvZGlmZicpCmNvbnN0IExvY2FsQmxvY2tJdGVyYXRvciA9IHJlcXVpcmUoJy4vaXRlcmF0b3JzL2xvY2FsJykKY29uc3QgRXh0ZW5zaW9uID0gcmVxdWlyZSgnLi9saWIvZXh0ZW5zaW9uJykKY29uc3QgeyBZb2xvSW5kZXgsIE5vZGUsIEhlYWRlciB9ID0gcmVxdWlyZSgnLi9saWIvbWVzc2FnZXMnKQpjb25zdCB7IEJMT0NLX05PVF9BVkFJTEFCTEUsIERFQ09ESU5HX0VSUk9SIH0gPSByZXF1aXJlKCdoeXBlcmNvcmUtZXJyb3JzJykKCmNvbnN0IFQgPSA1CmNvbnN0IE1JTl9LRVlTID0gVCAtIDEKY29uc3QgTUFYX0NISUxEUkVOID0gTUlOX0tFWVMgKiAyICsgMQoKY29uc3QgU0VQID0gYjRhLmFsbG9jKDEpCmNvbnN0IEVNUFRZID0gYjRhLmFsbG9jKDApCgpjbGFzcyBLZXkgewogIGNvbnN0cnVjdG9yIChzZXEsIHZhbHVlKSB7CiAgICB0aGlzLnNlcSA9IHNlcQogICAgdGhpcy52YWx1ZSA9IHZhbHVlCiAgfQp9CgpjbGFzcyBDaGlsZCB7CiAgY29uc3RydWN0b3IgKHNlcSwgb2Zmc2V0LCB2YWx1ZSkgewogICAgdGhpcy5zZXEgPSBzZXEKICAgIHRoaXMub2Zmc2V0ID0gb2Zmc2V0CiAgICB0aGlzLnZhbHVlID0gdmFsdWUKICB9Cn0KCmNsYXNzIENhY2hlIHsKICBjb25zdHJ1Y3RvciAocmFjaGUpIHsKICAgIHRoaXMua2V5cyA9IHJhY2hlCiAgICB0aGlzLmxlbmd0aCA9IDAKICB9CgogIGdldCAoc2VxKSB7CiAgICByZXR1cm4gdGhpcy5rZXlzLmdldChzZXEpIHx8IG51bGwKICB9CgogIHNldCAoc2VxLCBrZXkpIHsKICAgIHRoaXMua2V5cy5zZXQoc2VxLCBrZXkpCiAgICBpZiAoc2VxID49IHRoaXMubGVuZ3RoKSB0aGlzLmxlbmd0aCA9IHNlcSArIDEKICB9CgogIGdjIChsZW5ndGgpIHsKICAgIC8vIGlmIHdlIG5lZWQgdG8gIndvcmsiIG1vcmUgdGhhbiAxMjggdGlja3MsIGp1c3QgYnVzdCB0aGUgY2FjaGUuLi4KICAgIGlmICh0aGlzLmxlbmd0aCAtIGxlbmd0aCA+IDEyOCkgewogICAgICB0aGlzLmtleXMuY2xlYXIoKQogICAgfSBlbHNlIHsKICAgICAgZm9yIChsZXQgaSA9IGxlbmd0aDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLmtleXMuZGVsZXRlKGkpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aAogIH0KCiAgY2xlYXIgKCkgewogICAgdGhpcy5rZXlzLmNsZWFyKCkKICB9Cn0KCmNsYXNzIFBvaW50ZXJzIHsKICBjb25zdHJ1Y3RvciAoZGVjb2RlZCkgewogICAgdGhpcy5sZXZlbHMgPSBkZWNvZGVkLmxldmVscy5tYXAobCA9PiB7CiAgICAgIGNvbnN0IGNoaWxkcmVuID0gW10KICAgICAgY29uc3Qga2V5cyA9IFtdCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGwua2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGtleXMucHVzaChuZXcgS2V5KGwua2V5c1tpXSwgbnVsbCkpCiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbC5jaGlsZHJlbi5sZW5ndGg7IGkgKz0gMikgewogICAgICAgIGNoaWxkcmVuLnB1c2gobmV3IENoaWxkKGwuY2hpbGRyZW5baV0sIGwuY2hpbGRyZW5baSArIDFdLCBudWxsKSkKICAgICAgfQoKICAgICAgcmV0dXJuIHsga2V5cywgY2hpbGRyZW4gfQogICAgfSkKICB9CgogIGdldCAoaSkgewogICAgcmV0dXJuIHRoaXMubGV2ZWxzW2ldCiAgfQoKICBoYXNLZXkgKHNlcSkgewogICAgZm9yIChjb25zdCBsdmwgb2YgdGhpcy5sZXZlbHMpIHsKICAgICAgZm9yIChjb25zdCBrZXkgb2YgbHZsLmtleXMpIHsKICAgICAgICBpZiAoa2V5LnNlcSA9PT0gc2VxKSByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2UKICB9Cn0KCmZ1bmN0aW9uIGluZmxhdGUgKGVudHJ5KSB7CiAgaWYgKGVudHJ5LmluZmxhdGVkID09PSBudWxsKSB7CiAgICBlbnRyeS5pbmZsYXRlZCA9IFlvbG9JbmRleC5kZWNvZGUoZW50cnkuaW5kZXgpCiAgICBlbnRyeS5pbmRleCA9IG51bGwKICB9CiAgcmV0dXJuIG5ldyBQb2ludGVycyhlbnRyeS5pbmZsYXRlZCkKfQoKZnVuY3Rpb24gZGVmbGF0ZSAoaW5kZXgpIHsKICBjb25zdCBsZXZlbHMgPSBpbmRleC5tYXAobCA9PiB7CiAgICBjb25zdCBrZXlzID0gW10KICAgIGNvbnN0IGNoaWxkcmVuID0gW10KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGwudmFsdWUua2V5cy5sZW5ndGg7IGkrKykgewogICAgICBrZXlzLnB1c2gobC52YWx1ZS5rZXlzW2ldLnNlcSkKICAgIH0KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGwudmFsdWUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgY2hpbGRyZW4ucHVzaChsLnZhbHVlLmNoaWxkcmVuW2ldLnNlcSwgbC52YWx1ZS5jaGlsZHJlbltpXS5vZmZzZXQpCiAgICB9CgogICAgcmV0dXJuIHsga2V5cywgY2hpbGRyZW4gfQogIH0pCgogIHJldHVybiBZb2xvSW5kZXguZW5jb2RlKHsgbGV2ZWxzIH0pCn0KCmNsYXNzIFRyZWVOb2RlIHsKICBjb25zdHJ1Y3RvciAoYmxvY2ssIGtleXMsIGNoaWxkcmVuLCBvZmZzZXQpIHsKICAgIHRoaXMuYmxvY2sgPSBibG9jawogICAgdGhpcy5vZmZzZXQgPSBvZmZzZXQKICAgIHRoaXMua2V5cyA9IGtleXMKICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbgogICAgdGhpcy5jaGFuZ2VkID0gZmFsc2UKCiAgICB0aGlzLnByZWxvYWQoKQogIH0KCiAgcHJlbG9hZCAoKSB7CiAgICBpZiAodGhpcy5ibG9jayA9PT0gbnVsbCkgcmV0dXJuCgogICAgY29uc3QgY29yZSA9IGdldEJhY2tpbmdDb3JlKHRoaXMuYmxvY2sudHJlZS5jb3JlKQogICAgaWYgKCFjb3JlKSByZXR1cm4KCiAgICBjb25zdCBiaXRmaWVsZCA9IGNvcmUuY29yZS5iaXRmaWVsZAogICAgY29uc3QgYmxvY2tzID0gW10KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMua2V5cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBrID0gdGhpcy5rZXlzW2ldCiAgICAgIGlmIChrLnZhbHVlKSBjb250aW51ZQogICAgICBpZiAoay5zZXEgPj0gY29yZS5zaWduZWRMZW5ndGggfHwgKGJpdGZpZWxkICYmIGJpdGZpZWxkLmdldChrLnNlcSkpKSBjb250aW51ZQogICAgICBibG9ja3MucHVzaChrLnNlcSkKICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjID0gdGhpcy5jaGlsZHJlbltpXQogICAgICBpZiAoYy52YWx1ZSkgY29udGludWUKICAgICAgaWYgKGMuc2VxID49IGNvcmUuc2lnbmVkTGVuZ3RoIHx8IChiaXRmaWVsZCAmJiBiaXRmaWVsZC5nZXQoYy5zZXEpKSkgY29udGludWUKICAgICAgYmxvY2tzLnB1c2goYy5zZXEpCiAgICB9CgogICAgaWYgKGJsb2Nrcy5sZW5ndGgpIGNvcmUuZG93bmxvYWQoeyBibG9ja3MgfSkKICB9CgogIGFzeW5jIGluc2VydEtleSAoa2V5LCB2YWx1ZSwgY2hpbGQsIG5vZGUsIGVuY29kaW5nLCBjYXMpIHsKICAgIGxldCBzID0gMAogICAgbGV0IGUgPSB0aGlzLmtleXMubGVuZ3RoCiAgICBsZXQgYwoKICAgIHdoaWxlIChzIDwgZSkgewogICAgICBjb25zdCBtaWQgPSAocyArIGUpID4+IDEKICAgICAgYyA9IGI0YS5jb21wYXJlKGtleS52YWx1ZSwgYXdhaXQgdGhpcy5nZXRLZXkobWlkKSkKCiAgICAgIGlmIChjID09PSAwKSB7CiAgICAgICAgaWYgKGNhcykgewogICAgICAgICAgY29uc3QgcHJldiA9IGF3YWl0IHRoaXMuZ2V0S2V5Tm9kZShtaWQpCiAgICAgICAgICBpZiAoIShhd2FpdCBjYXMocHJldi5maW5hbChlbmNvZGluZyksIG5vZGUpKSkgcmV0dXJuIHRydWUKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmJsb2NrLnRyZWUudHJlZS5hbHdheXNEdXBsaWNhdGUpIHsKICAgICAgICAgIGNvbnN0IHByZXYgPSBhd2FpdCB0aGlzLmdldEtleU5vZGUobWlkKQogICAgICAgICAgaWYgKHNhbWVWYWx1ZShwcmV2LnZhbHVlLCB2YWx1ZSkpIHJldHVybiB0cnVlCiAgICAgICAgfQogICAgICAgIHRoaXMuY2hhbmdlZCA9IHRydWUKICAgICAgICB0aGlzLmtleXNbbWlkXSA9IGtleQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KCiAgICAgIGlmIChjIDwgMCkgZSA9IG1pZAogICAgICBlbHNlIHMgPSBtaWQgKyAxCiAgICB9CgogICAgY29uc3QgaSA9IGMgPCAwID8gZSA6IHMKICAgIHRoaXMua2V5cy5zcGxpY2UoaSwgMCwga2V5KQogICAgaWYgKGNoaWxkKSB0aGlzLmNoaWxkcmVuLnNwbGljZShpICsgMSwgMCwgbmV3IENoaWxkKDAsIDAsIGNoaWxkKSkKICAgIHRoaXMuY2hhbmdlZCA9IHRydWUKCiAgICByZXR1cm4gdGhpcy5rZXlzLmxlbmd0aCA8IE1BWF9DSElMRFJFTgogIH0KCiAgcmVtb3ZlS2V5IChpbmRleCkgewogICAgdGhpcy5rZXlzLnNwbGljZShpbmRleCwgMSkKICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCkgewogICAgICB0aGlzLmNoaWxkcmVuW2luZGV4ICsgMV0uc2VxID0gMCAvLyBtYXJrIGFzIGZyZWVkCiAgICAgIHRoaXMuY2hpbGRyZW4uc3BsaWNlKGluZGV4ICsgMSwgMSkKICAgIH0KICAgIHRoaXMuY2hhbmdlZCA9IHRydWUKICB9CgogIGFzeW5jIHNpYmxpbmdzIChwYXJlbnQpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFyZW50LmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChwYXJlbnQuY2hpbGRyZW5baV0udmFsdWUgPT09IHRoaXMpIHsKICAgICAgICBjb25zdCBbbGVmdCwgcmlnaHRdID0gYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgICAgICAgaSA/IHBhcmVudC5nZXRDaGlsZE5vZGUoaSAtIDEpIDogbnVsbCwKICAgICAgICAgIGkgPCBwYXJlbnQuY2hpbGRyZW4ubGVuZ3RoIC0gMSA/IHBhcmVudC5nZXRDaGlsZE5vZGUoaSArIDEpIDogbnVsbAogICAgICAgIF0pCiAgICAgICAgcmV0dXJuIHsgbGVmdCwgaW5kZXg6IGksIHJpZ2h0IH0KICAgICAgfQogICAgfQoKICAgIHRocm93IG5ldyBFcnJvcignQmFkIHBhcmVudCcpCiAgfQoKICBtZXJnZSAobm9kZSwgbWVkaWFuKSB7CiAgICB0aGlzLmNoYW5nZWQgPSB0cnVlCiAgICB0aGlzLmtleXMucHVzaChtZWRpYW4pCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUua2V5cy5sZW5ndGg7IGkrKykgdGhpcy5rZXlzLnB1c2gobm9kZS5rZXlzW2ldKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB0aGlzLmNoaWxkcmVuLnB1c2gobm9kZS5jaGlsZHJlbltpXSkKICB9CgogIGFzeW5jIHNwbGl0ICgpIHsKICAgIGNvbnN0IGxlbiA9IHRoaXMua2V5cy5sZW5ndGggPj4gMQogICAgY29uc3QgcmlnaHQgPSBUcmVlTm9kZS5jcmVhdGUodGhpcy5ibG9jaykKCiAgICB3aGlsZSAocmlnaHQua2V5cy5sZW5ndGggPCBsZW4pIHJpZ2h0LmtleXMucHVzaCh0aGlzLmtleXMucG9wKCkpCiAgICByaWdodC5rZXlzLnJldmVyc2UoKQoKICAgIGF3YWl0IHRoaXMuZ2V0S2V5KHRoaXMua2V5cy5sZW5ndGggLSAxKSAvLyBtYWtlIHN1cmUgdGhlIG1lZGlhbiBpcyBsb2FkZWQKICAgIGNvbnN0IG1lZGlhbiA9IHRoaXMua2V5cy5wb3AoKQoKICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCkgewogICAgICB3aGlsZSAocmlnaHQuY2hpbGRyZW4ubGVuZ3RoIDwgbGVuICsgMSkgcmlnaHQuY2hpbGRyZW4ucHVzaCh0aGlzLmNoaWxkcmVuLnBvcCgpKQogICAgICByaWdodC5jaGlsZHJlbi5yZXZlcnNlKCkKICAgIH0KCiAgICB0aGlzLmNoYW5nZWQgPSB0cnVlCgogICAgcmV0dXJuIHsKICAgICAgbGVmdDogdGhpcywKICAgICAgbWVkaWFuLAogICAgICByaWdodAogICAgfQogIH0KCiAgZ2V0S2V5Tm9kZSAoaW5kZXgpIHsKICAgIHJldHVybiB0aGlzLmJsb2NrLnRyZWUuZ2V0QmxvY2sodGhpcy5rZXlzW2luZGV4XS5zZXEpCiAgfQoKICBhc3luYyBnZXRDaGlsZE5vZGUgKGluZGV4KSB7CiAgICBjb25zdCBjaGlsZCA9IHRoaXMuY2hpbGRyZW5baW5kZXhdCiAgICBpZiAoY2hpbGQudmFsdWUpIHJldHVybiBjaGlsZC52YWx1ZQogICAgY29uc3QgYmxvY2sgPSBjaGlsZC5zZXEgPT09IHRoaXMuYmxvY2suc2VxID8gdGhpcy5ibG9jayA6IGF3YWl0IHRoaXMuYmxvY2sudHJlZS5nZXRCbG9jayhjaGlsZC5zZXEpCiAgICByZXR1cm4gKGNoaWxkLnZhbHVlID0gYmxvY2suZ2V0VHJlZU5vZGUoY2hpbGQub2Zmc2V0KSkKICB9CgogIHNldEtleSAoaW5kZXgsIGtleSkgewogICAgdGhpcy5rZXlzW2luZGV4XSA9IGtleQogICAgdGhpcy5jaGFuZ2VkID0gdHJ1ZQogIH0KCiAgYXN5bmMgZ2V0S2V5IChpbmRleCkgewogICAgY29uc3Qga2V5ID0gdGhpcy5rZXlzW2luZGV4XQogICAgaWYgKGtleS52YWx1ZSkgcmV0dXJuIGtleS52YWx1ZQogICAgY29uc3QgayA9IGtleS5zZXEgPT09IHRoaXMuYmxvY2suc2VxID8gdGhpcy5ibG9jay5rZXkgOiBhd2FpdCB0aGlzLmJsb2NrLnRyZWUuZ2V0S2V5KGtleS5zZXEpCiAgICByZXR1cm4gKGtleS52YWx1ZSA9IGspCiAgfQoKICBpbmRleENoYW5nZXMgKGluZGV4LCBzZXEpIHsKICAgIGNvbnN0IG9mZnNldCA9IGluZGV4LnB1c2gobnVsbCkgLSAxCiAgICB0aGlzLmNoYW5nZWQgPSBmYWxzZQoKICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdGhpcy5jaGlsZHJlbikgewogICAgICBpZiAoIWNoaWxkLnZhbHVlIHx8ICFjaGlsZC52YWx1ZS5jaGFuZ2VkKSBjb250aW51ZQogICAgICBjaGlsZC5zZXEgPSBzZXEKICAgICAgY2hpbGQub2Zmc2V0ID0gY2hpbGQudmFsdWUuaW5kZXhDaGFuZ2VzKGluZGV4LCBzZXEpCiAgICAgIGluZGV4W2NoaWxkLm9mZnNldF0gPSBjaGlsZAogICAgfQoKICAgIHJldHVybiBvZmZzZXQKICB9CgogIHVwZGF0ZUNoaWxkcmVuIChzZXEsIGJsb2NrKSB7CiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRoaXMuY2hpbGRyZW4pIHsKICAgICAgaWYgKCFjaGlsZC52YWx1ZSB8fCBjaGlsZC5zZXEgIT09IHNlcSkgY29udGludWUKICAgICAgY2hpbGQudmFsdWUuYmxvY2sgPSBibG9jawogICAgICBjaGlsZC52YWx1ZS51cGRhdGVDaGlsZHJlbihzZXEsIGJsb2NrKQogICAgfQogIH0KCiAgc3RhdGljIGNyZWF0ZSAoYmxvY2spIHsKICAgIGNvbnN0IG5vZGUgPSBuZXcgVHJlZU5vZGUoYmxvY2ssIFtdLCBbXSwgMCkKICAgIG5vZGUuY2hhbmdlZCA9IHRydWUKICAgIHJldHVybiBub2RlCiAgfQp9CgpjbGFzcyBCbG9ja0VudHJ5IHsKICBjb25zdHJ1Y3RvciAoc2VxLCB0cmVlLCBlbnRyeSkgewogICAgdGhpcy5zZXEgPSBzZXEKICAgIHRoaXMudHJlZSA9IHRyZWUKICAgIHRoaXMuaW5kZXggPSBudWxsCiAgICB0aGlzLmVudHJ5ID0gZW50cnkKICAgIHRoaXMua2V5ID0gZW50cnkua2V5CiAgICB0aGlzLnZhbHVlID0gZW50cnkudmFsdWUKICB9CgogIGlzVGFyZ2V0IChrZXkpIHsKICAgIHJldHVybiBiNGEuZXF1YWxzKHRoaXMua2V5LCBrZXkpCiAgfQoKICBpbmZsYXRlICgpIHsKICAgIGlmICh0aGlzLmluZGV4ID09PSBudWxsKSB7CiAgICAgIHRoaXMuaW5kZXggPSBpbmZsYXRlKHRoaXMuZW50cnkpCiAgICB9CiAgfQoKICBpc0RlbGV0aW9uICgpIHsKICAgIGlmICh0aGlzLnZhbHVlICE9PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgICBpZiAodGhpcy5pbmRleCA9PT0gbnVsbCkgewogICAgICB0aGlzLmluZGV4ID0gaW5mbGF0ZSh0aGlzLmVudHJ5KQogICAgfQoKICAgIHJldHVybiAhdGhpcy5pbmRleC5oYXNLZXkodGhpcy5zZXEpCiAgfQoKICBmaW5hbCAoZW5jb2RpbmcpIHsKICAgIHJldHVybiB7CiAgICAgIHNlcTogdGhpcy5zZXEsCiAgICAgIGtleTogZW5jb2Rpbmcua2V5ID8gZW5jb2Rpbmcua2V5LmRlY29kZSh0aGlzLmtleSkgOiB0aGlzLmtleSwKICAgICAgdmFsdWU6IHRoaXMudmFsdWUgJiYgKGVuY29kaW5nLnZhbHVlID8gZW5jb2RpbmcudmFsdWUuZGVjb2RlKHRoaXMudmFsdWUpIDogdGhpcy52YWx1ZSkKICAgIH0KICB9CgogIGdldFRyZWVOb2RlIChvZmZzZXQpIHsKICAgIGlmICh0aGlzLmluZGV4ID09PSBudWxsKSB7CiAgICAgIHRoaXMuaW5kZXggPSBpbmZsYXRlKHRoaXMuZW50cnkpCiAgICB9CiAgICBjb25zdCBlbnRyeSA9IHRoaXMuaW5kZXguZ2V0KG9mZnNldCkKICAgIHJldHVybiBuZXcgVHJlZU5vZGUodGhpcywgZW50cnkua2V5cywgZW50cnkuY2hpbGRyZW4sIG9mZnNldCkKICB9Cn0KCmNsYXNzIENhY2hlTG9jayB7CiAgY29uc3RydWN0b3IgKCkgewogICAgdGhpcy5tYXAgPSBuZXcgTWFwKCkKICB9CgogIGVudGVyIChzZXEpIHsKICAgIGNvbnN0IHBlbmRpbmcgPSB0aGlzLm1hcC5nZXQoc2VxKQoKICAgIGlmICghcGVuZGluZykgewogICAgICB0aGlzLm1hcC5zZXQoc2VxLCBbXSkKICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCiAgICB9CgogICAgY29uc3QgeyByZXNvbHZlLCBwcm9taXNlIH0gPSBycnAoKQogICAgcGVuZGluZy5wdXNoKHJlc29sdmUpCiAgICByZXR1cm4gcHJvbWlzZQogIH0KCiAgZXhpdCAoc2VxKSB7CiAgICBjb25zdCBwZW5kaW5nID0gdGhpcy5tYXAuZ2V0KHNlcSkKICAgIGlmICghcGVuZGluZy5sZW5ndGgpIHsKICAgICAgdGhpcy5tYXAuZGVsZXRlKHNlcSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgcGVuZGluZy5wb3AoKSgpCiAgfQp9CgpjbGFzcyBCYXRjaEVudHJ5IGV4dGVuZHMgQmxvY2tFbnRyeSB7CiAgY29uc3RydWN0b3IgKHNlcSwgdHJlZSwga2V5LCB2YWx1ZSwgaW5kZXgpIHsKICAgIHN1cGVyKHNlcSwgdHJlZSwgeyBrZXksIHZhbHVlLCBpbmRleDogbnVsbCwgaW5mbGF0ZWQ6IG51bGwgfSkKICAgIHRoaXMucGVuZGluZ0luZGV4ID0gaW5kZXgKICB9CgogIGlzVGFyZ2V0IChrZXkpIHsKICAgIHJldHVybiBmYWxzZQogIH0KCiAgZ2V0VHJlZU5vZGUgKG9mZnNldCkgewogICAgcmV0dXJuIHRoaXMucGVuZGluZ0luZGV4W29mZnNldF0udmFsdWUKICB9Cn0KCmNsYXNzIEh5cGVyYmVlIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IgKGNvcmUsIG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQogICAgLy8gdGhpcy5mZWVkIGlzIG5vdyBkZXByZWNhdGVkLCBhbmQgd2lsbCBiZSB0aGlzLmNvcmUgZ29pbmcgZm9yd2FyZAogICAgdGhpcy5mZWVkID0gY29yZQogICAgdGhpcy5jb3JlID0gY29yZQoKICAgIHRoaXMua2V5RW5jb2RpbmcgPSBvcHRzLmtleUVuY29kaW5nID8gY29kZWNzKG9wdHMua2V5RW5jb2RpbmcpIDogbnVsbAogICAgdGhpcy52YWx1ZUVuY29kaW5nID0gb3B0cy52YWx1ZUVuY29kaW5nID8gY29kZWNzKG9wdHMudmFsdWVFbmNvZGluZykgOiBudWxsCiAgICB0aGlzLmV4dGVuc2lvbiA9IG9wdHMuZXh0ZW5zaW9uICE9PSBmYWxzZSA/IGdldEV4dGVuc2lvbih0aGlzLCBvcHRzKSA6IG51bGwKICAgIHRoaXMubWV0YWRhdGEgPSBvcHRzLm1ldGFkYXRhIHx8IG51bGwKICAgIHRoaXMubG9jayA9IG9wdHMubG9jayB8fCBtdXRleGlmeSgpCiAgICB0aGlzLnNlcCA9IG9wdHMuc2VwIHx8IFNFUAogICAgdGhpcy5yZWFkb25seSA9ICEhb3B0cy5yZWFkb25seQogICAgdGhpcy5wcmVmaXggPSBvcHRzLnByZWZpeCB8fCBudWxsCgogICAgLy8gSW4gYSBmdXR1cmUgdmVyc2lvbiwgdGhpcyBzaG91bGQgYmUgZmFsc2UgYnkgZGVmYXVsdAogICAgdGhpcy5hbHdheXNEdXBsaWNhdGUgPSBvcHRzLmFsd2F5c0R1cGxpY2F0ZSAhPT0gZmFsc2UKCiAgICB0aGlzLl91bnByZWZpeGVkS2V5RW5jb2RpbmcgPSB0aGlzLmtleUVuY29kaW5nCiAgICB0aGlzLl9zdWIgPSAhIXRoaXMucHJlZml4CiAgICB0aGlzLl9jaGVja291dCA9IG9wdHMuY2hlY2tvdXQgfHwgMAogICAgdGhpcy5fdmlldyA9ICEhb3B0cy5fdmlldwoKICAgIHRoaXMuX29uYXBwZW5kQm91bmQgPSB0aGlzLl92aWV3ID8gbnVsbCA6IHRoaXMuX29uYXBwZW5kLmJpbmQodGhpcykKICAgIHRoaXMuX29udHJ1bmNhdGVCb3VuZCA9IHRoaXMuX3ZpZXcgPyBudWxsIDogdGhpcy5fb250cnVuY2F0ZS5iaW5kKHRoaXMpCiAgICB0aGlzLl93YXRjaGVycyA9IHRoaXMuX29uYXBwZW5kQm91bmQgPyBbXSA6IG51bGwKICAgIHRoaXMuX2VudHJ5V2F0Y2hlcnMgPSB0aGlzLl9vbmFwcGVuZEJvdW5kID8gW10gOiBudWxsCiAgICB0aGlzLl9zZXNzaW9ucyA9IG9wdHMuc2Vzc2lvbnMgIT09IGZhbHNlCgogICAgdGhpcy5fa2V5Q2FjaGUgPSBudWxsCiAgICB0aGlzLl9ub2RlQ2FjaGUgPSBudWxsCiAgICB0aGlzLl9jYWNoZUxvY2sgPSBuZXcgQ2FjaGVMb2NrKCkKCiAgICB0aGlzLl9iYXRjaGVzID0gW10KCiAgICBpZiAodGhpcy5fd2F0Y2hlcnMpIHsKICAgICAgdGhpcy5jb3JlLm9uKCdhcHBlbmQnLCB0aGlzLl9vbmFwcGVuZEJvdW5kKQogICAgICB0aGlzLmNvcmUub24oJ3RydW5jYXRlJywgdGhpcy5fb250cnVuY2F0ZUJvdW5kKQogICAgfQoKICAgIGlmICh0aGlzLnByZWZpeCAmJiBvcHRzLl9zdWIpIHsKICAgICAgdGhpcy5rZXlFbmNvZGluZyA9IHByZWZpeEVuY29kaW5nKHRoaXMucHJlZml4LCB0aGlzLmtleUVuY29kaW5nKQogICAgfQoKICAgIHRoaXMucmVhZHkoKS5jYXRjaChzYWZldHlDYXRjaCkKICB9CgogIGFzeW5jIF9vcGVuICgpIHsKICAgIGlmICh0aGlzLmNvcmUub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKCiAgICAvLyBzbmFwc2hvdAogICAgaWYgKHRoaXMuX2NoZWNrb3V0ID09PSAtMSkgdGhpcy5fY2hlY2tvdXQgPSBNYXRoLm1heCgxLCB0aGlzLmNvcmUubGVuZ3RoKQoKICAgIGNvbnN0IGJhc2VDYWNoZSA9IFJhY2hlLmZyb20odGhpcy5jb3JlLmdsb2JhbENhY2hlKQogICAgdGhpcy5fa2V5Q2FjaGUgPSBuZXcgQ2FjaGUoYmFzZUNhY2hlKQogICAgdGhpcy5fbm9kZUNhY2hlID0gbmV3IENhY2hlKFJhY2hlLmZyb20oYmFzZUNhY2hlKSkKICB9CgogIGdldCB2ZXJzaW9uICgpIHsKICAgIHJldHVybiBNYXRoLm1heCgxLCB0aGlzLl9jaGVja291dCB8fCB0aGlzLmNvcmUubGVuZ3RoKQogIH0KCiAgZ2V0IGlkICgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUuaWQKICB9CgogIGdldCBrZXkgKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5rZXkKICB9CgogIGdldCBkaXNjb3ZlcnlLZXkgKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkKICB9CgogIGdldCB3cml0YWJsZSAoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLndyaXRhYmxlCiAgfQoKICBnZXQgcmVhZGFibGUgKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5yZWFkYWJsZQogIH0KCiAgcmVwbGljYXRlIChpc0luaXRpYXRvciwgb3B0cykgewogICAgcmV0dXJuIHRoaXMuY29yZS5yZXBsaWNhdGUoaXNJbml0aWF0b3IsIG9wdHMpCiAgfQoKICB1cGRhdGUgKG9wdHMpIHsKICAgIHJldHVybiB0aGlzLmNvcmUudXBkYXRlKG9wdHMpCiAgfQoKICBwZWVrIChyYW5nZSwgb3B0cykgewogICAgcmV0dXJuIGl0ZXJhdG9yUGVlayh0aGlzLmNyZWF0ZVJhbmdlSXRlcmF0b3IocmFuZ2UsIHsgLi4ub3B0cywgbGltaXQ6IDEgfSkpCiAgfQoKICBjcmVhdGVSYW5nZUl0ZXJhdG9yIChyYW5nZSwgb3B0cyA9IHt9KSB7CiAgICAvLyBiYWNrd2FyZHMgY29tcGF0IHJhbmdlIGFyZwogICAgb3B0cyA9IG9wdHMgPyB7IC4uLm9wdHMsIC4uLnJhbmdlIH0gOiByYW5nZQoKICAgIGNvbnN0IGV4dGVuc2lvbiA9IChvcHRzLmV4dGVuc2lvbiA9PT0gZmFsc2UgJiYgb3B0cy5saW1pdCAhPT0gMCkgPyBudWxsIDogdGhpcy5leHRlbnNpb24KICAgIGNvbnN0IGtleUVuY29kaW5nID0gb3B0cy5rZXlFbmNvZGluZyA/IGNvZGVjcyhvcHRzLmtleUVuY29kaW5nKSA6IHRoaXMua2V5RW5jb2RpbmcKCiAgICBpZiAoZXh0ZW5zaW9uKSB7CiAgICAgIGNvbnN0IHsgb25zZXEsIG9ud2FpdCB9ID0gb3B0cwogICAgICBsZXQgdmVyc2lvbiA9IDAKICAgICAgbGV0IG5leHQgPSAwCgogICAgICBvcHRzID0gZW5jUmFuZ2Uoa2V5RW5jb2RpbmcsIHsKICAgICAgICAuLi5vcHRzLAogICAgICAgIHN1YjogdGhpcy5fc3ViLAogICAgICAgIG9uc2VxIChzZXEpIHsKICAgICAgICAgIGlmICghdmVyc2lvbikgdmVyc2lvbiA9IHNlcSArIDEKICAgICAgICAgIGlmIChuZXh0KSBuZXh0LS0KICAgICAgICAgIGlmIChvbnNlcSkgb25zZXEoc2VxKQogICAgICAgIH0sCiAgICAgICAgb253YWl0IChzZXEpIHsKICAgICAgICAgIGlmICghbmV4dCkgewogICAgICAgICAgICBuZXh0ID0gRXh0ZW5zaW9uLkJBVENIX1NJWkUKICAgICAgICAgICAgZXh0ZW5zaW9uLml0ZXJhdG9yKGl0ZS5zbmFwc2hvdCh2ZXJzaW9uKSkKICAgICAgICAgIH0KICAgICAgICAgIGlmIChvbndhaXQpIG9ud2FpdChzZXEpCiAgICAgICAgfQogICAgICB9KQogICAgfSBlbHNlIHsKICAgICAgb3B0cyA9IGVuY1JhbmdlKGtleUVuY29kaW5nLCB7IC4uLm9wdHMsIHN1YjogdGhpcy5fc3ViIH0pCiAgICB9CgogICAgY29uc3QgaXRlID0gbmV3IFJhbmdlSXRlcmF0b3IobmV3IEJhdGNoKHRoaXMsIHRoaXMuX21ha2VTbmFwc2hvdCgpLCBudWxsLCBmYWxzZSwgb3B0cyksIG51bGwsIG9wdHMpCiAgICByZXR1cm4gaXRlCiAgfQoKICBjcmVhdGVSZWFkU3RyZWFtIChyYW5nZSwgb3B0cykgewogICAgY29uc3Qgc2lnbmFsID0gKG9wdHMgJiYgb3B0cy5zaWduYWwpIHx8IG51bGwKICAgIHJldHVybiBpdGVyYXRvclRvU3RyZWFtKHRoaXMuY3JlYXRlUmFuZ2VJdGVyYXRvcihyYW5nZSwgb3B0cyksIHNpZ25hbCkKICB9CgogIGNyZWF0ZUhpc3RvcnlTdHJlYW0gKG9wdHMpIHsKICAgIGNvbnN0IHNlc3Npb24gPSAob3B0cyAmJiBvcHRzLmxpdmUpID8gdGhpcy5jb3JlLnNlc3Npb24oKSA6IHRoaXMuX21ha2VTbmFwc2hvdCgpCiAgICBjb25zdCBzaWduYWwgPSAob3B0cyAmJiBvcHRzLnNpZ25hbCkgfHwgbnVsbAogICAgcmV0dXJuIGl0ZXJhdG9yVG9TdHJlYW0obmV3IEhpc3RvcnlJdGVyYXRvcihuZXcgQmF0Y2godGhpcywgc2Vzc2lvbiwgbnVsbCwgZmFsc2UsIG9wdHMpLCBvcHRzKSwgc2lnbmFsKQogIH0KCiAgY3JlYXRlRGlmZlN0cmVhbSAocmlnaHQsIHJhbmdlLCBvcHRzKSB7CiAgICBpZiAodHlwZW9mIHJpZ2h0ID09PSAnbnVtYmVyJykgcmlnaHQgPSB0aGlzLmNoZWNrb3V0KE1hdGgubWF4KDEsIHJpZ2h0KSwgeyByZXVzZVNlc3Npb246IHRydWUgfSkKCiAgICAvLyBiYWNrd2FyZHMgY29tcGF0IHJhbmdlIGFyZwogICAgb3B0cyA9IG9wdHMgPyB7IC4uLm9wdHMsIC4uLnJhbmdlIH0gOiByYW5nZQoKICAgIGNvbnN0IHNpZ25hbCA9IChvcHRzICYmIG9wdHMuc2lnbmFsKSB8fCBudWxsCgogICAgY29uc3Qga2V5RW5jb2RpbmcgPSBvcHRzICYmIG9wdHMua2V5RW5jb2RpbmcgPyBjb2RlY3Mob3B0cy5rZXlFbmNvZGluZykgOiB0aGlzLmtleUVuY29kaW5nCiAgICBpZiAoa2V5RW5jb2RpbmcpIG9wdHMgPSBlbmNSYW5nZShrZXlFbmNvZGluZywgeyAuLi5vcHRzLCBzdWI6IHRoaXMuX3N1YiB9KQoKICAgIGxldCBkb25lCiAgICBsZXQgY2xvc2luZwogICAgbGV0IGl0ZQoKICAgIGNvbnN0IGxlZnQgPSB0aGlzCgogICAgY29uc3QgcnMgPSBuZXcgUmVhZGFibGUoewogICAgICBzaWduYWwsCiAgICAgIGVhZ2VyT3BlbjogdHJ1ZSwKICAgICAgYXN5bmMgb3BlbiAoY2IpIHsKICAgICAgICB0cnkgewogICAgICAgICAgaWYgKHJpZ2h0Lm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHJpZ2h0LnJlYWR5KCkKICAgICAgICAgIGlmIChsZWZ0Lm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IGxlZnQucmVhZHkoKQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgY2IoZXJyKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQoKICAgICAgICBpZiAoY2xvc2luZykgewogICAgICAgICAgY2IobnVsbCkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgaWYgKGxlZnQuY29yZS5jbG9zaW5nIHx8IHJpZ2h0LmNvcmUuY2xvc2luZykgewogICAgICAgICAgY2IobmV3IEVycm9yKCdCZWUgY2xvc2VkJykpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIGNvbnN0IHNuYXBzaG90ID0gcmlnaHQudmVyc2lvbiA+IGxlZnQudmVyc2lvbgogICAgICAgICAgPyByaWdodC5fbWFrZVNuYXBzaG90KCkKICAgICAgICAgIDogbGVmdC5fbWFrZVNuYXBzaG90KCkKCiAgICAgICAgZG9uZSA9IGNiCiAgICAgICAgaXRlID0gbmV3IERpZmZJdGVyYXRvcigKICAgICAgICAgIG5ldyBCYXRjaChsZWZ0LCBzbmFwc2hvdCwgbnVsbCwgZmFsc2UsIG9wdHMpLAogICAgICAgICAgbmV3IEJhdGNoKHJpZ2h0LCBzbmFwc2hvdCwgbnVsbCwgZmFsc2UsIG9wdHMpLAogICAgICAgICAgb3B0cwogICAgICAgICkKICAgICAgICBpdGUub3BlbigpLnRoZW4oZmluLCBmaW4pCiAgICAgIH0sCiAgICAgIHJlYWQgKGNiKSB7CiAgICAgICAgZG9uZSA9IGNiCiAgICAgICAgaXRlLm5leHQoKS50aGVuKHB1c2gsIGZpbikKICAgICAgfSwKICAgICAgcHJlZGVzdHJveSAoKSB7CiAgICAgICAgaWYgKCFpdGUpIHsKICAgICAgICAgIGNsb3NpbmcgPSBQcm9taXNlLnJlc29sdmUoKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjbG9zaW5nID0gaXRlLmNsb3NlKCkKICAgICAgICAgIGNsb3NpbmcuY2F0Y2gobm9vcCkKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3kgKGNiKSB7CiAgICAgICAgZG9uZSA9IGNiCiAgICAgICAgaWYgKCFjbG9zaW5nKSBjbG9zaW5nID0gaXRlLmNsb3NlKCkKICAgICAgICBjbG9zaW5nLnRoZW4oZmluLCBmaW4pCiAgICAgIH0KICAgIH0pCgogICAgcmV0dXJuIHJzCgogICAgZnVuY3Rpb24gZmluIChlcnIpIHsKICAgICAgZG9uZShlcnIpCiAgICB9CgogICAgZnVuY3Rpb24gcHVzaCAodmFsKSB7CiAgICAgIHJzLnB1c2godmFsKQogICAgICBkb25lKG51bGwpCiAgICB9CiAgfQoKICBnZXQgKGtleSwgb3B0cykgewogICAgY29uc3QgYiA9IG5ldyBCYXRjaCh0aGlzLCB0aGlzLl9tYWtlU25hcHNob3QoKSwgbnVsbCwgdHJ1ZSwgb3B0cykKICAgIHJldHVybiBiLmdldChrZXkpCiAgfQoKICBnZXRCeVNlcSAoc2VxLCBvcHRzKSB7CiAgICBjb25zdCBiID0gbmV3IEJhdGNoKHRoaXMsIHRoaXMuX21ha2VTbmFwc2hvdCgpLCBudWxsLCB0cnVlLCBvcHRzKQogICAgcmV0dXJuIGIuZ2V0QnlTZXEoc2VxKQogIH0KCiAgcHV0IChrZXksIHZhbHVlLCBvcHRzKSB7CiAgICBjb25zdCBiID0gbmV3IEJhdGNoKHRoaXMsIHRoaXMuY29yZSwgbnVsbCwgdHJ1ZSwgb3B0cykKICAgIHJldHVybiBiLnB1dChrZXksIHZhbHVlLCBvcHRzKQogIH0KCiAgYmF0Y2ggKG9wdHMpIHsKICAgIHJldHVybiBuZXcgQmF0Y2godGhpcywgdGhpcy5jb3JlLCBtdXRleGlmeSgpLCB0cnVlLCBvcHRzKQogIH0KCiAgZGVsIChrZXksIG9wdHMpIHsKICAgIGNvbnN0IGIgPSBuZXcgQmF0Y2godGhpcywgdGhpcy5jb3JlLCBudWxsLCB0cnVlLCBvcHRzKQogICAgcmV0dXJuIGIuZGVsKGtleSwgb3B0cykKICB9CgogIHdhdGNoIChyYW5nZSwgb3B0cykgewogICAgaWYgKCF0aGlzLl93YXRjaGVycykgdGhyb3cgbmV3IEVycm9yKCdDYW4gb25seSB3YXRjaCB0aGUgbWFpbiBiZWUgaW5zdGFuY2UnKQogICAgcmV0dXJuIG5ldyBXYXRjaGVyKHRoaXMsIHJhbmdlLCBvcHRzKQogIH0KCiAgYXN5bmMgZ2V0QW5kV2F0Y2ggKGtleSwgb3B0cykgewogICAgaWYgKCF0aGlzLl93YXRjaGVycykgdGhyb3cgbmV3IEVycm9yKCdDYW4gb25seSB3YXRjaCB0aGUgbWFpbiBiZWUgaW5zdGFuY2UnKQoKICAgIGNvbnN0IHdhdGNoZXIgPSBuZXcgRW50cnlXYXRjaGVyKHRoaXMsIGtleSwgb3B0cykKICAgIGF3YWl0IHdhdGNoZXIuX2RlYm91bmNlZFVwZGF0ZSgpCgogICAgaWYgKHRoaXMuY2xvc2luZykgewogICAgICBhd2FpdCB3YXRjaGVyLmNsb3NlKCkKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCZWUgY2xvc2VkJykKICAgIH0KCiAgICByZXR1cm4gd2F0Y2hlcgogIH0KCiAgX29uYXBwZW5kICgpIHsKICAgIGZvciAoY29uc3Qgd2F0Y2hlciBvZiB0aGlzLl93YXRjaGVycykgewogICAgICB3YXRjaGVyLl9vbmFwcGVuZCgpCiAgICB9CgogICAgZm9yIChjb25zdCB3YXRjaGVyIG9mIHRoaXMuX2VudHJ5V2F0Y2hlcnMpIHsKICAgICAgd2F0Y2hlci5fb25hcHBlbmQoKQogICAgfQogIH0KCiAgX29udHJ1bmNhdGUgKGxlbmd0aCkgewogICAgZm9yIChjb25zdCB3YXRjaGVyIG9mIHRoaXMuX3dhdGNoZXJzKSB7CiAgICAgIHdhdGNoZXIuX29udHJ1bmNhdGUoKQogICAgfQoKICAgIGZvciAoY29uc3Qgd2F0Y2hlciBvZiB0aGlzLl9lbnRyeVdhdGNoZXJzKSB7CiAgICAgIHdhdGNoZXIuX29udHJ1bmNhdGUoKQogICAgfQoKICAgIHRoaXMuX25vZGVDYWNoZS5nYyhsZW5ndGgpCiAgICB0aGlzLl9rZXlDYWNoZS5nYyhsZW5ndGgpCiAgfQoKICBfbWFrZVNuYXBzaG90ICgpIHsKICAgIGlmICh0aGlzLl9zZXNzaW9ucyA9PT0gZmFsc2UpIHJldHVybiB0aGlzLmNvcmUKICAgIC8vIFRPRE86IGJldHRlciBpZiB3ZSBjb3VsZCBlbmNhcHN1bGF0ZSB0aGlzIGluIGh5cGVyY29yZSBpbiB0aGUgZnV0dXJlCiAgICByZXR1cm4gKHRoaXMuX2NoZWNrb3V0IDw9IHRoaXMuY29yZS5sZW5ndGggfHwgdGhpcy5fY2hlY2tvdXQgPD0gMSkgPyB0aGlzLmNvcmUuc25hcHNob3QoKSA6IHRoaXMuY29yZS5zZXNzaW9uKHsgc25hcHNob3Q6IGZhbHNlIH0pCiAgfQoKICBhc3luYyBjbGVhclVubGlua2VkIChvcHRpb25zID0ge30pIHsKICAgIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIGNvbnN0IHsgZ3RlID0gMCwgbHQgPSB0aGlzLnZlcnNpb24gLSAxLCBiYXRjaFNpemUgPSA0MDk2LCB3YWl0ID0gdHJ1ZSB9ID0gb3B0aW9ucwogICAgY29uc3QgY2hlY2tvdXQgPSB0aGlzLnZlcnNpb24KCiAgICBsZXQgcHJldiA9IHRoaXMuYmF0Y2goeyB3YWl0OiBmYWxzZSwgY2hlY2tvdXQ6IGd0ZSB9KQogICAgbGV0IGIgPSB0aGlzLmJhdGNoKHsgd2FpdCwgY2hlY2tvdXQgfSkKCiAgICBjb25zdCBpdGVCYXRjaCA9IHRoaXMuYmF0Y2goeyB3YWl0OiBmYWxzZSwgY2hlY2tvdXQgfSkKICAgIGNvbnN0IGl0ZSA9IG5ldyBMb2NhbEJsb2NrSXRlcmF0b3IoaXRlQmF0Y2gsIHsgZ3RlLCBsdCB9KQogICAgYXdhaXQgaXRlLm9wZW4oKQoKICAgIGxldCB0aWNrcyA9IDAKCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBjb25zdCBkYXRhID0gYXdhaXQgaXRlLm5leHQoKQogICAgICBpZiAoIWRhdGEpIGJyZWFrCgogICAgICBpZiAoIShhd2FpdCBpc0xpbmtlZChiLCBkYXRhKSkpIHsKICAgICAgICBpZiAoYi5jb3JlLmNsb3NpbmcgfHwgdGhpcy5jb3JlLmNsb3NpbmcgfHwgdGhpcy5jbG9zaW5nKSBicmVhawogICAgICAgIGF3YWl0IHRoaXMuY29yZS5jbGVhcihkYXRhLnNlcSkKICAgICAgfQoKICAgICAgY29uc3QgcHJldk5vZGUgPSBhd2FpdCBwcmV2LmdldChkYXRhLmtleSwgeyBmaW5hbGl6ZTogZmFsc2UgfSkuY2F0Y2godG9OdWxsKQoKICAgICAgaWYgKHByZXZOb2RlICYmICEoYXdhaXQgaXNMaW5rZWQoYiwgcHJldk5vZGUpKSkgewogICAgICAgIGlmIChiLmNvcmUuY2xvc2luZyB8fCB0aGlzLmNvcmUuY2xvc2luZyB8fCB0aGlzLmNsb3NpbmcpIGJyZWFrCiAgICAgICAgYXdhaXQgdGhpcy5jb3JlLmNsZWFyKHByZXZOb2RlLnNlcSkKICAgICAgfQoKICAgICAgaWYgKHRpY2tzKysgPj0gYmF0Y2hTaXplKSB7CiAgICAgICAgdGlja3MgPSAwCiAgICAgICAgYXdhaXQgcHJldi5jbG9zZSgpCiAgICAgICAgYXdhaXQgYi5jbG9zZSgpCgogICAgICAgIHByZXYgPSB0aGlzLmJhdGNoKHsgd2FpdDogZmFsc2UsIGNoZWNrb3V0OiBndGUgfSkKICAgICAgICBiID0gdGhpcy5iYXRjaCh7IHdhaXQsIGNoZWNrb3V0IH0pCiAgICAgIH0KICAgIH0KCiAgICBpZiAoYi5jb3JlLmNsb3NpbmcgfHwgdGhpcy5jb3JlLmNsb3NpbmcgfHwgdGhpcy5jbG9zaW5nKSB0aHJvdyBuZXcgRXJyb3IoJ0NvcmUgaXMgY2xvc2VkJykKCiAgICBhd2FpdCBiLmNsb3NlKCkKICAgIGF3YWl0IHByZXYuY2xvc2UoKQogICAgYXdhaXQgaXRlLmNsb3NlKCkKICAgIGF3YWl0IGl0ZUJhdGNoLmNsb3NlKCkKCiAgICByZXR1cm4gbHQKICB9CgogIGNoZWNrb3V0ICh2ZXJzaW9uLCBvcHRzID0ge30pIHsKICAgIGlmICh2ZXJzaW9uID09PSAwKSB2ZXJzaW9uID0gMQoKICAgIC8vIHNhbWUgYXMgYWJvdmUsIGp1c3QgY2hlY2tvdXQgaXNuJ3Qgc2V0IHlldC4uLgogICAgY29uc3Qgc25hcCA9IChvcHRzLnJldXNlU2Vzc2lvbiB8fCB0aGlzLl9zZXNzaW9ucyA9PT0gZmFsc2UpCiAgICAgID8gdGhpcy5jb3JlCiAgICAgIDogKHZlcnNpb24gPD0gdGhpcy5jb3JlLmxlbmd0aCB8fCB2ZXJzaW9uIDw9IDEpID8gdGhpcy5jb3JlLnNuYXBzaG90KCkgOiB0aGlzLmNvcmUuc2Vzc2lvbih7IHNuYXBzaG90OiBmYWxzZSB9KQoKICAgIHJldHVybiBuZXcgSHlwZXJiZWUoc25hcCwgewogICAgICBfdmlldzogdHJ1ZSwKICAgICAgX3N1YjogZmFsc2UsCiAgICAgIHByZWZpeDogdGhpcy5wcmVmaXgsCiAgICAgIHNlcDogdGhpcy5zZXAsCiAgICAgIGxvY2s6IHRoaXMubG9jaywKICAgICAgY2hlY2tvdXQ6IHZlcnNpb24sCiAgICAgIGtleUVuY29kaW5nOiBvcHRzLmtleUVuY29kaW5nIHx8IHRoaXMua2V5RW5jb2RpbmcsCiAgICAgIHZhbHVlRW5jb2Rpbmc6IG9wdHMudmFsdWVFbmNvZGluZyB8fCB0aGlzLnZhbHVlRW5jb2RpbmcsCiAgICAgIGV4dGVuc2lvbjogdGhpcy5leHRlbnNpb24gIT09IG51bGwgPyB0aGlzLmV4dGVuc2lvbiA6IGZhbHNlCiAgICB9KQogIH0KCiAgc25hcHNob3QgKG9wdHMpIHsKICAgIHJldHVybiB0aGlzLmNoZWNrb3V0KCh0aGlzLmNvcmUub3BlbmVkID09PSBmYWxzZSB8fCB0aGlzLl9jaGVja291dCA8PSAwKSA/IC0xIDogTWF0aC5tYXgoMSwgdGhpcy52ZXJzaW9uKSwgb3B0cykKICB9CgogIHN1YiAocHJlZml4LCBvcHRzID0ge30pIHsKICAgIGxldCBzZXAgPSBvcHRzLnNlcCB8fCB0aGlzLnNlcAogICAgaWYgKCFiNGEuaXNCdWZmZXIoc2VwKSkgc2VwID0gYjRhLmZyb20oc2VwKQoKICAgIHByZWZpeCA9IGI0YS5jb25jYXQoW3RoaXMucHJlZml4IHx8IEVNUFRZLCBiNGEuZnJvbShwcmVmaXgpLCBzZXBdKQoKICAgIGNvbnN0IHZhbHVlRW5jb2RpbmcgPSBjb2RlY3Mob3B0cy52YWx1ZUVuY29kaW5nIHx8IHRoaXMudmFsdWVFbmNvZGluZykKICAgIGNvbnN0IGtleUVuY29kaW5nID0gY29kZWNzKG9wdHMua2V5RW5jb2RpbmcgfHwgdGhpcy5fdW5wcmVmaXhlZEtleUVuY29kaW5nKQoKICAgIHJldHVybiBuZXcgSHlwZXJiZWUodGhpcy5jb3JlLCB7CiAgICAgIF92aWV3OiB0cnVlLAogICAgICBfc3ViOiB0cnVlLAogICAgICBwcmVmaXgsCiAgICAgIHNlcDogdGhpcy5zZXAsCiAgICAgIGxvY2s6IHRoaXMubG9jaywKICAgICAgY2hlY2tvdXQ6IHRoaXMuX2NoZWNrb3V0LAogICAgICB2YWx1ZUVuY29kaW5nLAogICAgICBrZXlFbmNvZGluZywKICAgICAgZXh0ZW5zaW9uOiB0aGlzLmV4dGVuc2lvbiAhPT0gbnVsbCA/IHRoaXMuZXh0ZW5zaW9uIDogZmFsc2UsCiAgICAgIG1ldGFkYXRhOiB0aGlzLm1ldGFkYXRhCiAgICB9KQogIH0KCiAgYXN5bmMgZ2V0SGVhZGVyIChvcHRzKSB7CiAgICBjb25zdCBibGsgPSBhd2FpdCB0aGlzLmNvcmUuZ2V0KDAsIG9wdHMpCiAgICB0cnkgewogICAgICByZXR1cm4gYmxrICYmIEhlYWRlci5kZWNvZGUoYmxrKQogICAgfSBjYXRjaCB7CiAgICAgIHRocm93IERFQ09ESU5HX0VSUk9SKCkKICAgIH0KICB9CgogIGFzeW5jIF9jbG9zZSAoKSB7CiAgICBpZiAoIXRoaXMuX3ZpZXcpIHsKICAgICAgaWYgKHRoaXMuX2tleUNhY2hlKSB0aGlzLl9rZXlDYWNoZS5jbGVhcigpCiAgICAgIGlmICh0aGlzLl9ub2RlQ2FjaGUpIHRoaXMuX25vZGVDYWNoZS5jbGVhcigpCiAgICB9CgogICAgaWYgKHRoaXMuX3dhdGNoZXJzKSB7CiAgICAgIHRoaXMuY29yZS5vZmYoJ2FwcGVuZCcsIHRoaXMuX29uYXBwZW5kQm91bmQpCiAgICAgIHRoaXMuY29yZS5vZmYoJ3RydW5jYXRlJywgdGhpcy5fb250cnVuY2F0ZUJvdW5kKQoKICAgICAgd2hpbGUgKHRoaXMuX3dhdGNoZXJzLmxlbmd0aCkgewogICAgICAgIGF3YWl0IHRoaXMuX3dhdGNoZXJzW3RoaXMuX3dhdGNoZXJzLmxlbmd0aCAtIDFdLmNsb3NlKCkKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLl9lbnRyeVdhdGNoZXJzKSB7CiAgICAgIHdoaWxlICh0aGlzLl9lbnRyeVdhdGNoZXJzLmxlbmd0aCkgewogICAgICAgIGF3YWl0IHRoaXMuX2VudHJ5V2F0Y2hlcnNbdGhpcy5fZW50cnlXYXRjaGVycy5sZW5ndGggLSAxXS5jbG9zZSgpCiAgICAgIH0KICAgIH0KCiAgICB3aGlsZSAodGhpcy5fYmF0Y2hlcy5sZW5ndGgpIHsKICAgICAgYXdhaXQgdGhpcy5fYmF0Y2hlc1t0aGlzLl9iYXRjaGVzLmxlbmd0aCAtIDFdLmNsb3NlKCkKICAgIH0KCiAgICByZXR1cm4gdGhpcy5jb3JlLmNsb3NlKCkKICB9CgogIHN0YXRpYyBhc3luYyBpc0h5cGVyYmVlIChjb3JlLCBvcHRzKSB7CiAgICBhd2FpdCBjb3JlLnJlYWR5KCkKCiAgICBjb25zdCBibGswID0gYXdhaXQgY29yZS5nZXQoMCwgb3B0cykKICAgIGlmIChibGswID09PSBudWxsKSB0aHJvdyBCTE9DS19OT1RfQVZBSUxBQkxFKCkKCiAgICB0cnkgewogICAgICByZXR1cm4gSGVhZGVyLmRlY29kZShibGswKS5wcm90b2NvbCA9PT0gJ2h5cGVyYmVlJwogICAgfSBjYXRjaCAoZXJyKSB7IC8vIHVuZGVjb2RhYmxlCiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0KfQoKY2xhc3MgQmF0Y2ggewogIGNvbnN0cnVjdG9yICh0cmVlLCBjb3JlLCBiYXRjaExvY2ssIGNhY2hlLCBvcHRpb25zID0ge30pIHsKICAgIHRoaXMudHJlZSA9IHRyZWUKICAgIC8vIHRoaXMuZmVlZCBpcyBub3cgZGVwcmVjYXRlZCwgYW5kIHdpbGwgYmUgdGhpcy5jb3JlIGdvaW5nIGZvcndhcmQKICAgIHRoaXMuZmVlZCA9IGNvcmUKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMuaW5kZXggPSB0cmVlLl9iYXRjaGVzLnB1c2godGhpcykgLSAxCiAgICB0aGlzLmJsb2NrcyA9IGNhY2hlID8gbmV3IE1hcCgpIDogbnVsbAogICAgdGhpcy5hdXRvRmx1c2ggPSAhYmF0Y2hMb2NrCiAgICB0aGlzLm1heEJsb2Nrc0NhY2hlZCA9IG9wdGlvbnMubWF4QmxvY2tzQ2FjaGVkIHx8IDEyOAogICAgdGhpcy5yb290U2VxID0gMAogICAgdGhpcy5yb290ID0gbnVsbAogICAgdGhpcy5sZW5ndGggPSAwCiAgICB0aGlzLmNoZWNrb3V0ID0gb3B0aW9ucy5jaGVja291dCA9PT0gdW5kZWZpbmVkID8gLTEgOiBvcHRpb25zLmNoZWNrb3V0CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zCiAgICB0aGlzLmxvY2tlZCA9IG51bGwKICAgIHRoaXMuYmF0Y2hMb2NrID0gYmF0Y2hMb2NrCiAgICB0aGlzLm9uc2VxID0gdGhpcy5vcHRpb25zLm9uc2VxIHx8IG5vb3AKICAgIHRoaXMuYXBwZW5kaW5nID0gbnVsbAogICAgdGhpcy5pc1NuYXBzaG90ID0gdGhpcy5jb3JlICE9PSB0aGlzLnRyZWUuY29yZQogICAgdGhpcy5zaG91bGRVcGRhdGUgPSB0aGlzLm9wdGlvbnMudXBkYXRlICE9PSBmYWxzZQogICAgdGhpcy51cGRhdGluZyA9IG51bGwKICAgIHRoaXMuZW5jb2RpbmcgPSB7CiAgICAgIGtleTogb3B0aW9ucy5rZXlFbmNvZGluZyA/IGNvZGVjcyhvcHRpb25zLmtleUVuY29kaW5nKSA6IHRyZWUua2V5RW5jb2RpbmcsCiAgICAgIHZhbHVlOiBvcHRpb25zLnZhbHVlRW5jb2RpbmcgPyBjb2RlY3Mob3B0aW9ucy52YWx1ZUVuY29kaW5nKSA6IHRyZWUudmFsdWVFbmNvZGluZwogICAgfQogIH0KCiAgYXN5bmMgcmVhZHkgKCkgewogICAgaWYgKHRoaXMuY29yZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQogICAgaWYgKHRoaXMudHJlZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnRyZWUucmVhZHkoKQogIH0KCiAgYXN5bmMgbG9jayAoKSB7CiAgICBpZiAodGhpcy50cmVlLnJlYWRvbmx5KSB0aHJvdyBuZXcgRXJyb3IoJ0h5cGVyYmVlIGlzIG1hcmtlZCBhcyByZWFkLW9ubHknKQogICAgaWYgKHRoaXMubG9ja2VkID09PSBudWxsKSB0aGlzLmxvY2tlZCA9IGF3YWl0IHRoaXMudHJlZS5sb2NrKCkKICB9CgogIGdldCB2ZXJzaW9uICgpIHsKICAgIGlmICh0aGlzLmNoZWNrb3V0ICE9PSAtMSkgcmV0dXJuIE1hdGgubWF4KDEsIHRoaXMuY2hlY2tvdXQpCiAgICByZXR1cm4gTWF0aC5tYXgoMSwgdGhpcy50cmVlLl9jaGVja291dCB8fCAodGhpcy5jb3JlLmxlbmd0aCArIHRoaXMubGVuZ3RoKSkKICB9CgogIGFzeW5jIGdldFJvb3QgKGVuc3VyZUhlYWRlcikgewogICAgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAoZW5zdXJlSGVhZGVyKSB7CiAgICAgIGlmICh0aGlzLmNvcmUubGVuZ3RoID09PSAwICYmIHRoaXMuY29yZS53cml0YWJsZSAmJiAhdGhpcy50cmVlLnJlYWRvbmx5KSB7CiAgICAgICAgYXdhaXQgdGhpcy5jb3JlLmFwcGVuZChIZWFkZXIuZW5jb2RlKHsKICAgICAgICAgIHByb3RvY29sOiAnaHlwZXJiZWUnLAogICAgICAgICAgbWV0YWRhdGE6IHRoaXMudHJlZS5tZXRhZGF0YQogICAgICAgIH0pKQogICAgICB9CiAgICB9CiAgICBpZiAodGhpcy50cmVlLl9jaGVja291dCA9PT0gMCAmJiB0aGlzLmNoZWNrb3V0ID09PSAtMSAmJiB0aGlzLnNob3VsZFVwZGF0ZSkgewogICAgICBpZiAodGhpcy51cGRhdGluZyA9PT0gbnVsbCkgdGhpcy51cGRhdGluZyA9IHRoaXMuY29yZS51cGRhdGUoKQogICAgICBhd2FpdCB0aGlzLnVwZGF0aW5nCiAgICB9CiAgICBpZiAodGhpcy52ZXJzaW9uIDwgMikgcmV0dXJuIG51bGwKICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXRCbG9jayh0aGlzLnZlcnNpb24gLSAxKSkuZ2V0VHJlZU5vZGUoMCkKICB9CgogIGFzeW5jIGdldEtleSAoc2VxKSB7CiAgICBhd2FpdCB0aGlzLnRyZWUuX2NhY2hlTG9jay5lbnRlcihzZXEpCgogICAgdHJ5IHsKICAgICAgY29uc3QgayA9IHRoaXMuY29yZS5mb3JrID09PSB0aGlzLnRyZWUuY29yZS5mb3JrID8gdGhpcy50cmVlLl9rZXlDYWNoZS5nZXQoc2VxKSA6IG51bGwKICAgICAgaWYgKGsgIT09IG51bGwpIHJldHVybiBrCiAgICAgIGNvbnN0IGtleSA9IChhd2FpdCB0aGlzLl9nZXRCbG9jayhzZXEpKS5rZXkKICAgICAgaWYgKHRoaXMuY29yZS5mb3JrID09PSB0aGlzLnRyZWUuY29yZS5mb3JrKSB0aGlzLnRyZWUuX2tleUNhY2hlLnNldChzZXEsIGtleSkKICAgICAgcmV0dXJuIGtleQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy50cmVlLl9jYWNoZUxvY2suZXhpdChzZXEpCiAgICB9CiAgfQoKICBhc3luYyBfZ2V0Tm9kZSAoc2VxKSB7CiAgICBjb25zdCBjYWNoZWQgPSAodGhpcy50cmVlLl9ub2RlQ2FjaGUgIT09IG51bGwgJiYgdGhpcy5jb3JlLmZvcmsgPT09IHRoaXMudHJlZS5jb3JlLmZvcmspID8gdGhpcy50cmVlLl9ub2RlQ2FjaGUuZ2V0KHNlcSkgOiBudWxsCiAgICBpZiAoY2FjaGVkICE9PSBudWxsKSByZXR1cm4gY2FjaGVkCiAgICBjb25zdCBlbnRyeSA9IGF3YWl0IHRoaXMuY29yZS5nZXQoc2VxLCB7IC4uLnRoaXMub3B0aW9ucywgdmFsdWVFbmNvZGluZzogTm9kZSB9KQogICAgaWYgKGVudHJ5ID09PSBudWxsKSB0aHJvdyBCTE9DS19OT1RfQVZBSUxBQkxFKCkKICAgIGNvbnN0IHdyYXAgPSBjb3B5RW50cnkoZW50cnkpCiAgICBpZiAodGhpcy5jb3JlLmZvcmsgPT09IHRoaXMudHJlZS5jb3JlLmZvcmsgJiYgdGhpcy50cmVlLl9ub2RlQ2FjaGUgIT09IG51bGwpIHRoaXMudHJlZS5fbm9kZUNhY2hlLnNldChzZXEsIHdyYXApCiAgICByZXR1cm4gd3JhcAogIH0KCiAgYXN5bmMgZ2V0QmxvY2sgKHNlcSkgewogICAgaWYgKHRoaXMucm9vdFNlcSA9PT0gMCkgdGhpcy5yb290U2VxID0gc2VxCiAgICBhd2FpdCB0aGlzLnRyZWUuX2NhY2hlTG9jay5lbnRlcihzZXEpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2dldEJsb2NrKHNlcSkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMudHJlZS5fY2FjaGVMb2NrLmV4aXQoc2VxKQogICAgfQogIH0KCiAgYXN5bmMgX2dldEJsb2NrIChzZXEpIHsKICAgIGxldCBiID0gdGhpcy5ibG9ja3MgJiYgdGhpcy5ibG9ja3MuZ2V0KHNlcSkKICAgIGlmIChiKSByZXR1cm4gYgogICAgdGhpcy5vbnNlcShzZXEpCiAgICBjb25zdCBlbnRyeSA9IGF3YWl0IHRoaXMuX2dldE5vZGUoc2VxKQogICAgYiA9IHRoaXMuYmxvY2tzICYmIHRoaXMuYmxvY2tzLmdldChzZXEpCiAgICBpZiAoYikgcmV0dXJuIGIKICAgIGIgPSBuZXcgQmxvY2tFbnRyeShzZXEsIHRoaXMsIGVudHJ5KQogICAgaWYgKHRoaXMuYmxvY2tzICYmICh0aGlzLmJsb2Nrcy5zaXplIC0gdGhpcy5sZW5ndGgpIDwgdGhpcy5tYXhCbG9ja3NDYWNoZWQpIHRoaXMuYmxvY2tzLnNldChzZXEsIGIpCiAgICByZXR1cm4gYgogIH0KCiAgX29ud2FpdCAoa2V5KSB7CiAgICB0aGlzLm9wdGlvbnMub253YWl0ID0gbnVsbAogICAgdGhpcy50cmVlLmV4dGVuc2lvbi5nZXQodGhpcy5yb290U2VxICsgMSwga2V5KQogIH0KCiAgX2dldEVuY29kaW5nIChvcHRzKSB7CiAgICBpZiAoIW9wdHMpIHJldHVybiB0aGlzLmVuY29kaW5nCiAgICByZXR1cm4gewogICAgICBrZXk6IG9wdHMua2V5RW5jb2RpbmcgPyBjb2RlY3Mob3B0cy5rZXlFbmNvZGluZykgOiB0aGlzLmVuY29kaW5nLmtleSwKICAgICAgdmFsdWU6IG9wdHMudmFsdWVFbmNvZGluZyA/IGNvZGVjcyhvcHRzLnZhbHVlRW5jb2RpbmcpIDogdGhpcy5lbmNvZGluZy52YWx1ZQogICAgfQogIH0KCiAgcGVlayAocmFuZ2UsIG9wdHMpIHsKICAgIHJldHVybiBpdGVyYXRvclBlZWsodGhpcy5jcmVhdGVSYW5nZUl0ZXJhdG9yKHJhbmdlLCB7IC4uLm9wdHMsIGxpbWl0OiAxIH0pKQogIH0KCiAgY3JlYXRlUmFuZ2VJdGVyYXRvciAocmFuZ2UsIG9wdHMgPSB7fSkgewogICAgLy8gYmFja3dhcmRzIGNvbXBhdCByYW5nZSBhcmcKICAgIG9wdHMgPSBvcHRzID8geyAuLi5vcHRzLCAuLi5yYW5nZSB9IDogcmFuZ2UKCiAgICBjb25zdCBlbmNvZGluZyA9IHRoaXMuX2dldEVuY29kaW5nKG9wdHMpCiAgICByZXR1cm4gbmV3IFJhbmdlSXRlcmF0b3IodGhpcywgZW5jb2RpbmcsIGVuY1JhbmdlKGVuY29kaW5nLmtleSwgeyAuLi5vcHRzLCBzdWI6IHRoaXMudHJlZS5fc3ViIH0pKQogIH0KCiAgY3JlYXRlUmVhZFN0cmVhbSAocmFuZ2UsIG9wdHMpIHsKICAgIGNvbnN0IHNpZ25hbCA9IChvcHRzICYmIG9wdHMuc2lnbmFsKSB8fCBudWxsCiAgICByZXR1cm4gaXRlcmF0b3JUb1N0cmVhbSh0aGlzLmNyZWF0ZVJhbmdlSXRlcmF0b3IocmFuZ2UsIG9wdHMpLCBzaWduYWwpCiAgfQoKICBhc3luYyBnZXRCeVNlcSAoc2VxLCBvcHRzKSB7CiAgICBjb25zdCBlbmNvZGluZyA9IHRoaXMuX2dldEVuY29kaW5nKG9wdHMpCgogICAgdHJ5IHsKICAgICAgY29uc3QgYmxvY2sgPSAoYXdhaXQgdGhpcy5nZXRCbG9jayhzZXEpKS5maW5hbChlbmNvZGluZykKICAgICAgcmV0dXJuIHsga2V5OiBibG9jay5rZXksIHZhbHVlOiBibG9jay52YWx1ZSB9CiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCB0aGlzLl9jbG9zZVNuYXBzaG90KCkKICAgIH0KICB9CgogIGFzeW5jIGdldCAoa2V5LCBvcHRzKSB7CiAgICBjb25zdCBlbmNvZGluZyA9IHRoaXMuX2dldEVuY29kaW5nKG9wdHMpCiAgICBjb25zdCBmaW5hbGl6ZSA9IG9wdHMgPyBvcHRzLmZpbmFsaXplICE9PSBmYWxzZSA6IHRydWUKCiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0KGtleSwgZW5jb2RpbmcsIGZpbmFsaXplKQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgdGhpcy5fY2xvc2VTbmFwc2hvdCgpCiAgICB9CiAgfQoKICBhc3luYyBfZ2V0IChrZXksIGVuY29kaW5nLCBmaW5hbGl6ZSkgewogICAga2V5ID0gZW5jKGVuY29kaW5nLmtleSwga2V5KQoKICAgIGlmICh0aGlzLnRyZWUuZXh0ZW5zaW9uICE9PSBudWxsICYmIHRoaXMub3B0aW9ucy5leHRlbnNpb24gIT09IGZhbHNlKSB7CiAgICAgIHRoaXMub3B0aW9ucy5vbndhaXQgPSB0aGlzLl9vbndhaXQuYmluZCh0aGlzLCBrZXkpCiAgICB9CgogICAgbGV0IG5vZGUgPSBhd2FpdCB0aGlzLmdldFJvb3QoZmFsc2UpCiAgICBpZiAoIW5vZGUpIHJldHVybiBudWxsCgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKG5vZGUuYmxvY2suaXNUYXJnZXQoa2V5KSkgewogICAgICAgIHJldHVybiBub2RlLmJsb2NrLmlzRGVsZXRpb24oKSA/IG51bGwgOiAoZmluYWxpemUgPyBub2RlLmJsb2NrLmZpbmFsKGVuY29kaW5nKSA6IG5vZGUuYmxvY2spCiAgICAgIH0KCiAgICAgIGxldCBzID0gMAogICAgICBsZXQgZSA9IG5vZGUua2V5cy5sZW5ndGgKICAgICAgbGV0IGMKCiAgICAgIHdoaWxlIChzIDwgZSkgewogICAgICAgIGNvbnN0IG1pZCA9IChzICsgZSkgPj4gMQoKICAgICAgICBjID0gYjRhLmNvbXBhcmUoa2V5LCBhd2FpdCBub2RlLmdldEtleShtaWQpKQoKICAgICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgICAgY29uc3QgYmxvY2sgPSBhd2FpdCB0aGlzLmdldEJsb2NrKG5vZGUua2V5c1ttaWRdLnNlcSkKICAgICAgICAgIHJldHVybiBmaW5hbGl6ZSA/IGJsb2NrLmZpbmFsKGVuY29kaW5nKSA6IGJsb2NrCiAgICAgICAgfQoKICAgICAgICBpZiAoYyA8IDApIGUgPSBtaWQKICAgICAgICBlbHNlIHMgPSBtaWQgKyAxCiAgICAgIH0KCiAgICAgIGlmICghbm9kZS5jaGlsZHJlbi5sZW5ndGgpIHJldHVybiBudWxsCgogICAgICBjb25zdCBpID0gYyA8IDAgPyBlIDogcwogICAgICBub2RlID0gYXdhaXQgbm9kZS5nZXRDaGlsZE5vZGUoaSkKICAgIH0KICB9CgogIGFzeW5jIGxpbmtzIChrZXksIHNlcSkgewogICAgbGV0IG5vZGUgPSBhd2FpdCB0aGlzLmdldFJvb3QoZmFsc2UpCiAgICBpZiAoIW5vZGUpIHJldHVybiBmYWxzZQoKICAgIGlmIChub2RlLmJsb2NrLnNlcSA9PT0gc2VxKSByZXR1cm4gdHJ1ZQoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmIChub2RlLmJsb2NrLmlzVGFyZ2V0KGtleSkp","IHJldHVybiBmYWxzZQoKICAgICAgbGV0IHMgPSAwCiAgICAgIGxldCBlID0gbm9kZS5rZXlzLmxlbmd0aAogICAgICBsZXQgYwoKICAgICAgd2hpbGUgKHMgPCBlKSB7CiAgICAgICAgY29uc3QgbWlkID0gKHMgKyBlKSA+PiAxCgogICAgICAgIGlmIChub2RlLmtleXNbbWlkXS5zZXEgPT09IHNlcSkgcmV0dXJuIHRydWUKICAgICAgICBjID0gYjRhLmNvbXBhcmUoa2V5LCBhd2FpdCBub2RlLmdldEtleShtaWQpKQoKICAgICAgICBpZiAoYyA9PT0gMCkgcmV0dXJuIGZhbHNlCgogICAgICAgIGlmIChjIDwgMCkgZSA9IG1pZAogICAgICAgIGVsc2UgcyA9IG1pZCArIDEKICAgICAgfQoKICAgICAgaWYgKCFub2RlLmNoaWxkcmVuLmxlbmd0aCkgcmV0dXJuIGZhbHNlCgogICAgICBjb25zdCBpID0gYyA8IDAgPyBlIDogcwogICAgICBub2RlID0gYXdhaXQgbm9kZS5nZXRDaGlsZE5vZGUoaSkKICAgICAgaWYgKG5vZGUuYmxvY2suc2VxID09PSBzZXEpIHJldHVybiB0cnVlCiAgICB9CiAgfQoKICBhc3luYyBwdXQgKGtleSwgdmFsdWUsIG9wdHMpIHsKICAgIGNvbnN0IHJlbGVhc2UgPSB0aGlzLmJhdGNoTG9jayA/IGF3YWl0IHRoaXMuYmF0Y2hMb2NrKCkgOiBudWxsCgogICAgY29uc3QgY2FzID0gKG9wdHMgJiYgb3B0cy5jYXMpIHx8IG51bGwKICAgIGNvbnN0IGVuY29kaW5nID0gdGhpcy5fZ2V0RW5jb2Rpbmcob3B0cykKCiAgICBpZiAoIXRoaXMubG9ja2VkKSBhd2FpdCB0aGlzLmxvY2soKQogICAgaWYgKCFyZWxlYXNlKSByZXR1cm4gdGhpcy5fcHV0KGtleSwgdmFsdWUsIGVuY29kaW5nLCBjYXMpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3B1dChrZXksIHZhbHVlLCBlbmNvZGluZywgY2FzKQogICAgfSBmaW5hbGx5IHsKICAgICAgcmVsZWFzZSgpCiAgICB9CiAgfQoKICBhc3luYyBfcHV0IChrZXksIHZhbHVlLCBlbmNvZGluZywgY2FzKSB7CiAgICBjb25zdCBuZXdOb2RlID0gewogICAgICBzZXE6IDAsCiAgICAgIGtleSwKICAgICAgdmFsdWUKICAgIH0KICAgIGtleSA9IGVuYyhlbmNvZGluZy5rZXksIGtleSkKICAgIHZhbHVlID0gZW5jKGVuY29kaW5nLnZhbHVlLCB2YWx1ZSkKCiAgICBjb25zdCBzdGFjayA9IFtdCgogICAgbGV0IHJvb3QKICAgIGxldCBub2RlID0gcm9vdCA9IGF3YWl0IHRoaXMuZ2V0Um9vdCh0cnVlKQogICAgaWYgKCFub2RlKSBub2RlID0gcm9vdCA9IFRyZWVOb2RlLmNyZWF0ZShudWxsKQoKICAgIGNvbnN0IHNlcSA9IG5ld05vZGUuc2VxID0gdGhpcy5jb3JlLmxlbmd0aCArIHRoaXMubGVuZ3RoCiAgICBjb25zdCB0YXJnZXQgPSBuZXcgS2V5KHNlcSwga2V5KQoKICAgIHdoaWxlIChub2RlLmNoaWxkcmVuLmxlbmd0aCkgewogICAgICBzdGFjay5wdXNoKG5vZGUpCiAgICAgIG5vZGUuY2hhbmdlZCA9IHRydWUgLy8gY2hhbmdlZCwgYnV0IGNvbXByZXNzaWJsZQoKICAgICAgbGV0IHMgPSAwCiAgICAgIGxldCBlID0gbm9kZS5rZXlzLmxlbmd0aAogICAgICBsZXQgYwoKICAgICAgd2hpbGUgKHMgPCBlKSB7CiAgICAgICAgY29uc3QgbWlkID0gKHMgKyBlKSA+PiAxCiAgICAgICAgYyA9IGI0YS5jb21wYXJlKHRhcmdldC52YWx1ZSwgYXdhaXQgbm9kZS5nZXRLZXkobWlkKSkKCiAgICAgICAgaWYgKGMgPT09IDApIHsKICAgICAgICAgIGlmIChjYXMpIHsKICAgICAgICAgICAgY29uc3QgcHJldiA9IGF3YWl0IG5vZGUuZ2V0S2V5Tm9kZShtaWQpCiAgICAgICAgICAgIGlmICghKGF3YWl0IGNhcyhwcmV2LmZpbmFsKGVuY29kaW5nKSwgbmV3Tm9kZSkpKSByZXR1cm4gdGhpcy5fdW5sb2NrTWF5YmUoKQogICAgICAgICAgfQogICAgICAgICAgaWYgKCF0aGlzLnRyZWUuYWx3YXlzRHVwbGljYXRlKSB7CiAgICAgICAgICAgIGNvbnN0IHByZXYgPSBhd2FpdCBub2RlLmdldEtleU5vZGUobWlkKQogICAgICAgICAgICBpZiAoc2FtZVZhbHVlKHByZXYudmFsdWUsIHZhbHVlKSkgcmV0dXJuIHRoaXMuX3VubG9ja01heWJlKCkKICAgICAgICAgIH0KICAgICAgICAgIG5vZGUuc2V0S2V5KG1pZCwgdGFyZ2V0KQogICAgICAgICAgcmV0dXJuIHRoaXMuX2FwcGVuZChyb290LCBzZXEsIGtleSwgdmFsdWUpCiAgICAgICAgfQoKICAgICAgICBpZiAoYyA8IDApIGUgPSBtaWQKICAgICAgICBlbHNlIHMgPSBtaWQgKyAxCiAgICAgIH0KCiAgICAgIGNvbnN0IGkgPSBjIDwgMCA/IGUgOiBzCiAgICAgIG5vZGUgPSBhd2FpdCBub2RlLmdldENoaWxkTm9kZShpKQogICAgfQoKICAgIGxldCBuZWVkc1NwbGl0ID0gIShhd2FpdCBub2RlLmluc2VydEtleSh0YXJnZXQsIHZhbHVlLCBudWxsLCBuZXdOb2RlLCBlbmNvZGluZywgY2FzKSkKICAgIGlmICghbm9kZS5jaGFuZ2VkKSByZXR1cm4gdGhpcy5fdW5sb2NrTWF5YmUoKQoKICAgIHdoaWxlIChuZWVkc1NwbGl0KSB7CiAgICAgIGNvbnN0IHBhcmVudCA9IHN0YWNrLnBvcCgpCiAgICAgIGNvbnN0IHsgbWVkaWFuLCByaWdodCB9ID0gYXdhaXQgbm9kZS5zcGxpdCgpCgogICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgbmVlZHNTcGxpdCA9ICEoYXdhaXQgcGFyZW50Lmluc2VydEtleShtZWRpYW4sIHZhbHVlLCByaWdodCwgbnVsbCwgZW5jb2RpbmcsIG51bGwpKQogICAgICAgIG5vZGUgPSBwYXJlbnQKICAgICAgfSBlbHNlIHsKICAgICAgICByb290ID0gVHJlZU5vZGUuY3JlYXRlKG5vZGUuYmxvY2spCiAgICAgICAgcm9vdC5jaGFuZ2VkID0gdHJ1ZQogICAgICAgIHJvb3Qua2V5cy5wdXNoKG1lZGlhbikKICAgICAgICByb290LmNoaWxkcmVuLnB1c2gobmV3IENoaWxkKDAsIDAsIG5vZGUpLCBuZXcgQ2hpbGQoMCwgMCwgcmlnaHQpKQogICAgICAgIG5lZWRzU3BsaXQgPSBmYWxzZQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXMuX2FwcGVuZChyb290LCBzZXEsIGtleSwgdmFsdWUpCiAgfQoKICBhc3luYyBkZWwgKGtleSwgb3B0cykgewogICAgY29uc3QgcmVsZWFzZSA9IHRoaXMuYmF0Y2hMb2NrID8gYXdhaXQgdGhpcy5iYXRjaExvY2soKSA6IG51bGwKICAgIGNvbnN0IGNhcyA9IChvcHRzICYmIG9wdHMuY2FzKSB8fCBudWxsCiAgICBjb25zdCBlbmNvZGluZyA9IHRoaXMuX2dldEVuY29kaW5nKG9wdHMpCgogICAgaWYgKCF0aGlzLmxvY2tlZCkgYXdhaXQgdGhpcy5sb2NrKCkKICAgIGlmICghcmVsZWFzZSkgcmV0dXJuIHRoaXMuX2RlbChrZXksIGVuY29kaW5nLCBjYXMpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2RlbChrZXksIGVuY29kaW5nLCBjYXMpCiAgICB9IGZpbmFsbHkgewogICAgICByZWxlYXNlKCkKICAgIH0KICB9CgogIGFzeW5jIF9kZWwgKGtleSwgZW5jb2RpbmcsIGNhcykgewogICAgY29uc3QgZGVsTm9kZSA9IHsKICAgICAgc2VxOiAwLAogICAgICBrZXksCiAgICAgIHZhbHVlOiBudWxsCiAgICB9CgogICAga2V5ID0gZW5jKGVuY29kaW5nLmtleSwga2V5KQoKICAgIGNvbnN0IHN0YWNrID0gW10KCiAgICBsZXQgbm9kZSA9IGF3YWl0IHRoaXMuZ2V0Um9vdCh0cnVlKQogICAgaWYgKCFub2RlKSByZXR1cm4gdGhpcy5fdW5sb2NrTWF5YmUoKQoKICAgIGNvbnN0IHNlcSA9IGRlbE5vZGUuc2VxID0gdGhpcy5jb3JlLmxlbmd0aCArIHRoaXMubGVuZ3RoCgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgc3RhY2sucHVzaChub2RlKQoKICAgICAgbGV0IHMgPSAwCiAgICAgIGxldCBlID0gbm9kZS5rZXlzLmxlbmd0aAogICAgICBsZXQgYwoKICAgICAgd2hpbGUgKHMgPCBlKSB7CiAgICAgICAgY29uc3QgbWlkID0gKHMgKyBlKSA+PiAxCiAgICAgICAgYyA9IGI0YS5jb21wYXJlKGtleSwgYXdhaXQgbm9kZS5nZXRLZXkobWlkKSkKCiAgICAgICAgaWYgKGMgPT09IDApIHsKICAgICAgICAgIGlmIChjYXMpIHsKICAgICAgICAgICAgY29uc3QgcHJldiA9IGF3YWl0IG5vZGUuZ2V0S2V5Tm9kZShtaWQpCiAgICAgICAgICAgIGlmICghKGF3YWl0IGNhcyhwcmV2LmZpbmFsKGVuY29kaW5nKSwgZGVsTm9kZSkpKSByZXR1cm4gdGhpcy5fdW5sb2NrTWF5YmUoKQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUuY2hpbGRyZW4ubGVuZ3RoKSBhd2FpdCBzZXRLZXlUb05lYXJlc3RMZWFmKG5vZGUsIG1pZCwgc3RhY2spCiAgICAgICAgICBlbHNlIG5vZGUucmVtb3ZlS2V5KG1pZCkKICAgICAgICAgIC8vIHdlIG1hcmsgdGhlc2UgYXMgY2hhbmdlZCBsYXRlLCBzbyB3ZSBkb24ndCByZXdyaXRlIHRoZW0gaWYgaXQgaXMgYSA0MDQKICAgICAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiBzdGFjaykgbm9kZS5jaGFuZ2VkID0gdHJ1ZQogICAgICAgICAgcmV0dXJuIHRoaXMuX2FwcGVuZChhd2FpdCByZWJhbGFuY2Uoc3RhY2spLCBzZXEsIGtleSwgbnVsbCkKICAgICAgICB9CgogICAgICAgIGlmIChjIDwgMCkgZSA9IG1pZAogICAgICAgIGVsc2UgcyA9IG1pZCArIDEKICAgICAgfQoKICAgICAgaWYgKCFub2RlLmNoaWxkcmVuLmxlbmd0aCkgcmV0dXJuIHRoaXMuX3VubG9ja01heWJlKCkKCiAgICAgIGNvbnN0IGkgPSBjIDwgMCA/IGUgOiBzCiAgICAgIG5vZGUgPSBhd2FpdCBub2RlLmdldENoaWxkTm9kZShpKQogICAgfQogIH0KCiAgYXN5bmMgX2Nsb3NlU25hcHNob3QgKCkgewogICAgaWYgKHRoaXMuaXNTbmFwc2hvdCkgewogICAgICBhd2FpdCB0aGlzLmNvcmUuY2xvc2UoKQogICAgICB0aGlzLl9maW5hbGl6ZSgpCiAgICB9CiAgfQoKICBhc3luYyBjbG9zZSAoKSB7CiAgICBpZiAodGhpcy5pc1NuYXBzaG90KSByZXR1cm4gdGhpcy5fY2xvc2VTbmFwc2hvdCgpCgogICAgdGhpcy5yb290ID0gbnVsbAogICAgaWYgKHRoaXMuYmxvY2tzKSB0aGlzLmJsb2Nrcy5jbGVhcigpCiAgICB0aGlzLmxlbmd0aCA9IDAKICAgIHRoaXMuX3VubG9jaygpCiAgfQoKICBkZXN0cm95ICgpIHsgLy8gY29tcGF0LCByZW1vdmUgbGF0ZXIKICAgIHRoaXMuY2xvc2UoKS5jYXRjaChub29wKQogIH0KCiAgdG9CbG9ja3MgKCkgewogICAgaWYgKHRoaXMuYXBwZW5kaW5nKSByZXR1cm4gdGhpcy5hcHBlbmRpbmcKCiAgICBjb25zdCBiYXRjaCA9IG5ldyBBcnJheSh0aGlzLmxlbmd0aCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qgc2VxID0gdGhpcy5jb3JlLmxlbmd0aCArIGkKICAgICAgY29uc3QgeyBwZW5kaW5nSW5kZXgsIGtleSwgdmFsdWUgfSA9IHRoaXMuYmxvY2tzLmdldChzZXEpCgogICAgICBpZiAoaSA8IHRoaXMubGVuZ3RoIC0gMSkgewogICAgICAgIHBlbmRpbmdJbmRleFswXSA9IG51bGwKICAgICAgICBsZXQgaiA9IDAKCiAgICAgICAgd2hpbGUgKGogPCBwZW5kaW5nSW5kZXgubGVuZ3RoKSB7CiAgICAgICAgICBjb25zdCBpZHggPSBwZW5kaW5nSW5kZXhbal0KICAgICAgICAgIGlmIChpZHggIT09IG51bGwgJiYgaWR4LnNlcSA9PT0gc2VxKSB7CiAgICAgICAgICAgIGlkeC5vZmZzZXQgPSBqKysKICAgICAgICAgICAgY29udGludWUKICAgICAgICAgIH0KICAgICAgICAgIGlmIChqID09PSBwZW5kaW5nSW5kZXgubGVuZ3RoIC0gMSkgcGVuZGluZ0luZGV4LnBvcCgpCiAgICAgICAgICBlbHNlIHBlbmRpbmdJbmRleFtqXSA9IHBlbmRpbmdJbmRleC5wb3AoKQogICAgICAgIH0KICAgICAgfQoKICAgICAgYmF0Y2hbaV0gPSBOb2RlLmVuY29kZSh7CiAgICAgICAga2V5LAogICAgICAgIHZhbHVlLAogICAgICAgIGluZGV4OiBkZWZsYXRlKHBlbmRpbmdJbmRleCkKICAgICAgfSkKICAgIH0KCiAgICB0aGlzLmFwcGVuZGluZyA9IGJhdGNoCiAgICByZXR1cm4gYmF0Y2gKICB9CgogIGZsdXNoICgpIHsKICAgIGlmICghdGhpcy5sZW5ndGgpIHJldHVybiB0aGlzLmNsb3NlKCkKCiAgICBjb25zdCBiYXRjaCA9IHRoaXMudG9CbG9ja3MoKQoKICAgIHRoaXMucm9vdCA9IG51bGwKICAgIHRoaXMuYmxvY2tzLmNsZWFyKCkKICAgIHRoaXMubGVuZ3RoID0gMAoKICAgIHJldHVybiB0aGlzLl9hcHBlbmRCYXRjaChiYXRjaCkKICB9CgogIF91bmxvY2tNYXliZSAoKSB7CiAgICBpZiAodGhpcy5hdXRvRmx1c2gpIHRoaXMuX3VubG9jaygpCiAgfQoKICBfdW5sb2NrICgpIHsKICAgIGNvbnN0IGxvY2tlZCA9IHRoaXMubG9ja2VkCiAgICB0aGlzLmxvY2tlZCA9IG51bGwKICAgIGlmIChsb2NrZWQgIT09IG51bGwpIGxvY2tlZCgpCiAgICB0aGlzLl9maW5hbGl6ZSgpCiAgfQoKICBfZmluYWxpemUgKCkgewogICAgLy8gdGVjaG5pY2FsbHkgZmluYWxpemUgY2FuIGJlIGNhbGxlZCBtb3JlIHRoYW4gb25jZSwgc28gaGVyZSB3ZSBqdXN0IGNoZWNrIGlmIHdlIGFscmVhZHkgaGF2ZSBiZWVuIHJlbW92ZWQKICAgIGlmICh0aGlzLmluZGV4ID49IHRoaXMudHJlZS5fYmF0Y2hlcy5sZW5ndGggfHwgdGhpcy50cmVlLl9iYXRjaGVzW3RoaXMuaW5kZXhdICE9PSB0aGlzKSByZXR1cm4KICAgIGNvbnN0IHRvcCA9IHRoaXMudHJlZS5fYmF0Y2hlcy5wb3AoKQogICAgaWYgKHRvcCA9PT0gdGhpcykgcmV0dXJuCiAgICB0b3AuaW5kZXggPSB0aGlzLmluZGV4CiAgICB0aGlzLnRyZWUuX2JhdGNoZXNbdG9wLmluZGV4XSA9IHRvcAogIH0KCiAgX2FwcGVuZCAocm9vdCwgc2VxLCBrZXksIHZhbHVlKSB7CiAgICBjb25zdCBpbmRleCA9IFtdCiAgICByb290LmluZGV4Q2hhbmdlcyhpbmRleCwgc2VxKQogICAgaW5kZXhbMF0gPSBuZXcgQ2hpbGQoc2VxLCAwLCByb290KQoKICAgIGlmICghdGhpcy5hdXRvRmx1c2gpIHsKICAgICAgY29uc3QgYmxvY2sgPSBuZXcgQmF0Y2hFbnRyeShzZXEsIHRoaXMsIGtleSwgdmFsdWUsIGluZGV4KQogICAgICByb290LmJsb2NrID0gYmxvY2sKICAgICAgdGhpcy5yb290ID0gcm9vdAogICAgICB0aGlzLmxlbmd0aCsrCiAgICAgIHRoaXMuYmxvY2tzLnNldChzZXEsIGJsb2NrKQoKICAgICAgcm9vdC51cGRhdGVDaGlsZHJlbihzZXEsIGJsb2NrKQogICAgICByZXR1cm4KICAgIH0KCiAgICByZXR1cm4gdGhpcy5fYXBwZW5kQmF0Y2goTm9kZS5lbmNvZGUoewogICAgICBrZXksCiAgICAgIHZhbHVlLAogICAgICBpbmRleDogZGVmbGF0ZShpbmRleCkKICAgIH0pKQogIH0KCiAgYXN5bmMgX2FwcGVuZEJhdGNoIChyYXcpIHsKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuY29yZS5hcHBlbmQocmF3KQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fdW5sb2NrKCkKICAgIH0KICB9Cn0KCmNsYXNzIEVudHJ5V2F0Y2hlciBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yIChiZWUsIGtleSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5rZXlFbmNvZGluZyA9IG9wdHMua2V5RW5jb2RpbmcgfHwgYmVlLmtleUVuY29kaW5nCiAgICB0aGlzLnZhbHVlRW5jb2RpbmcgPSBvcHRzLnZhbHVlRW5jb2RpbmcgfHwgYmVlLnZhbHVlRW5jb2RpbmcKCiAgICB0aGlzLmluZGV4ID0gYmVlLl9lbnRyeVdhdGNoZXJzLnB1c2godGhpcykgLSAxCiAgICB0aGlzLmJlZSA9IGJlZQoKICAgIHRoaXMua2V5ID0ga2V5CiAgICB0aGlzLm5vZGUgPSBudWxsCgogICAgdGhpcy5fZm9yY2VVcGRhdGUgPSBmYWxzZQogICAgdGhpcy5fZGVib3VuY2VkVXBkYXRlID0gZGVib3VuY2UodGhpcy5fcHJvY2Vzc1VwZGF0ZS5iaW5kKHRoaXMpKQogIH0KCiAgX2Nsb3NlICgpIHsKICAgIGNvbnN0IHRvcCA9IHRoaXMuYmVlLl9lbnRyeVdhdGNoZXJzLnBvcCgpCiAgICBpZiAodG9wICE9PSB0aGlzKSB7CiAgICAgIHRvcC5pbmRleCA9IHRoaXMuaW5kZXgKICAgICAgdGhpcy5iZWUuX2VudHJ5V2F0Y2hlcnNbdG9wLmluZGV4XSA9IHRvcAogICAgfQogIH0KCiAgX29uYXBwZW5kICgpIHsKICAgIHRoaXMuX2RlYm91bmNlZFVwZGF0ZSgpCiAgfQoKICBfb250cnVuY2F0ZSAoKSB7CiAgICB0aGlzLl9mb3JjZVVwZGF0ZSA9IHRydWUKICAgIHRoaXMuX2RlYm91bmNlZFVwZGF0ZSgpCiAgfQoKICBhc3luYyBfcHJvY2Vzc1VwZGF0ZSAoKSB7CiAgICBjb25zdCBmb3JjZSA9IHRoaXMuX2ZvcmNlVXBkYXRlCiAgICB0aGlzLl9mb3JjZVVwZGF0ZSA9IGZhbHNlCgogICAgbGV0IG5ld05vZGUKICAgIHRyeSB7CiAgICAgIG5ld05vZGUgPSBhd2FpdCB0aGlzLmJlZS5nZXQodGhpcy5rZXksIHsKICAgICAgICBrZXlFbmNvZGluZzogdGhpcy5rZXlFbmNvZGluZywKICAgICAgICB2YWx1ZUVuY29kaW5nOiB0aGlzLnZhbHVlRW5jb2RpbmcKICAgICAgfSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaWYgKGUuY29kZSA9PT0gJ1NOQVBTSE9UX05PVF9BVkFJTEFCTEUnKSB7CiAgICAgICAgLy8gVGhlcmUgd2FzIGEgdHJ1bmNhdGUgZXZlbnQgYmVmb3JlIHRoZSBnZXQgcmVzb2x2ZWQKICAgICAgICAvLyBTbyB0aGlzIGhhbmRsZXIgd2lsbCBydW4gYWdhaW4gYW55d2F5CiAgICAgICAgcmV0dXJuCiAgICAgIH0gZWxzZSBpZiAodGhpcy5iZWUuY2xvc2luZykgewogICAgICAgIHRoaXMuY2xvc2UoKS5jYXRjaChzYWZldHlDYXRjaCkKICAgICAgICByZXR1cm4KICAgICAgfQogICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKGZvcmNlIHx8IG5ld05vZGU/LnNlcSAhPT0gdGhpcy5ub2RlPy5zZXEpIHsKICAgICAgdGhpcy5ub2RlID0gbmV3Tm9kZQogICAgICB0aGlzLmVtaXQoJ3VwZGF0ZScpCiAgICB9CiAgfQp9CgpjbGFzcyBXYXRjaGVyIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IgKGJlZSwgcmFuZ2UsIG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMua2V5RW5jb2RpbmcgPSBvcHRzLmtleUVuY29kaW5nIHx8IGJlZS5rZXlFbmNvZGluZwogICAgdGhpcy52YWx1ZUVuY29kaW5nID0gb3B0cy52YWx1ZUVuY29kaW5nIHx8IGJlZS52YWx1ZUVuY29kaW5nCiAgICB0aGlzLmluZGV4ID0gYmVlLl93YXRjaGVycy5wdXNoKHRoaXMpIC0gMQogICAgdGhpcy5iZWUgPSBiZWUKICAgIHRoaXMuY29yZSA9IGJlZS5jb3JlCgogICAgdGhpcy5sYXRlc3REaWZmID0gMAogICAgdGhpcy5yYW5nZSA9IHJhbmdlCiAgICB0aGlzLm1hcCA9IG9wdHMubWFwIHx8IGRlZmF1bHRXYXRjaE1hcAoKICAgIHRoaXMuY3VycmVudCA9IG51bGwKICAgIHRoaXMucHJldmlvdXMgPSBudWxsCiAgICB0aGlzLmN1cnJlbnRNYXBwZWQgPSBudWxsCiAgICB0aGlzLnByZXZpb3VzTWFwcGVkID0gbnVsbAogICAgdGhpcy5zdHJlYW0gPSBudWxsCgogICAgdGhpcy5fbG9jayA9IG11dGV4aWZ5KCkKICAgIHRoaXMuX2Zsb3dpbmcgPSBmYWxzZQogICAgdGhpcy5fcmVzb2x2ZU9uQ2hhbmdlID0gbnVsbAogICAgdGhpcy5fZGlmZmVyID0gb3B0cy5kaWZmZXIgfHwgZGVmYXVsdERpZmZlcgogICAgdGhpcy5fZWFnZXIgPSAhIW9wdHMuZWFnZXIKICAgIHRoaXMuX29uY2hhbmdlID0gb3B0cy5vbmNoYW5nZSB8fCBudWxsCgogICAgdGhpcy5vbignbmV3TGlzdGVuZXInLCBhdXRvRmxvd09uVXBkYXRlKQoKICAgIHRoaXMucmVhZHkoKS5jYXRjaChzYWZldHlDYXRjaCkKICB9CgogIGFzeW5jIF9jb25zdW1lICgpIHsKICAgIGlmICh0aGlzLl9mbG93aW5nKSByZXR1cm4KICAgIHRyeSB7CiAgICAgIGZvciBhd2FpdCAoY29uc3QgXyBvZiB0aGlzKSB7fSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICB9IGNhdGNoIHt9CiAgfQoKICBhc3luYyBfb3BlbiAoKSB7CiAgICBhd2FpdCB0aGlzLmJlZS5yZWFkeSgpCgogICAgY29uc3Qgb3B0cyA9IHsKICAgICAga2V5RW5jb2Rpbmc6IHRoaXMua2V5RW5jb2RpbmcsCiAgICAgIHZhbHVlRW5jb2Rpbmc6IHRoaXMudmFsdWVFbmNvZGluZwogICAgfQoKICAgIC8vIFBvaW50IGZyb20gd2hpY2ggdG8gc3RhcnQgd2F0Y2hpbmcKICAgIHRoaXMuY3VycmVudCA9IHRoaXMuX2VhZ2VyID8gdGhpcy5iZWUuY2hlY2tvdXQoMSwgb3B0cykgOiB0aGlzLmJlZS5zbmFwc2hvdChvcHRzKQogICAgYXdhaXQgdGhpcy5jdXJyZW50LnJlYWR5KCkKCiAgICBpZiAodGhpcy5fb25jaGFuZ2UpIHsKICAgICAgaWYgKHRoaXMuX2VhZ2VyKSBhd2FpdCB0aGlzLl9vbmNoYW5nZSgpCiAgICAgIHRoaXMuX2NvbnN1bWUoKQogICAgfQogIH0KCiAgW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSAoKSB7CiAgICB0aGlzLl9mbG93aW5nID0gdHJ1ZQogICAgcmV0dXJuIHRoaXMKICB9CgogIF9vbnRydW5jYXRlICgpIHsKICAgIHRoaXMuX29uYXBwZW5kKCkKICB9CgogIF9vbmFwcGVuZCAoKSB7CiAgICBjb25zdCByZXNvbHZlID0gdGhpcy5fcmVzb2x2ZU9uQ2hhbmdlCiAgICB0aGlzLl9yZXNvbHZlT25DaGFuZ2UgPSBudWxsCiAgICBpZiAocmVzb2x2ZSkgcmVzb2x2ZSgpCiAgfQoKICBhc3luYyBfd2FpdEZvckNoYW5nZXMgKCkgewogICAgaWYgKHRoaXMuY3VycmVudC52ZXJzaW9uIDwgdGhpcy5iZWUudmVyc2lvbiB8fCB0aGlzLmNsb3NpbmcpIHJldHVybgoKICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gewogICAgICB0aGlzLl9yZXNvbHZlT25DaGFuZ2UgPSByZXNvbHZlCiAgICB9KQogIH0KCiAgYXN5bmMgbmV4dCAoKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fbmV4dCgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuIHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9CiAgICAgIGF3YWl0IHRoaXMuY2xvc2UoKQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIGFzeW5jIF9uZXh0ICgpIHsKICAgIGNvbnN0IHJlbGVhc2UgPSBhd2FpdCB0aGlzLl9sb2NrKCkKCiAgICB0cnkgewogICAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4geyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH0KCiAgICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBhd2FpdCB0aGlzLl93YWl0Rm9yQ2hhbmdlcygpCgogICAgICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybiB7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfQoKICAgICAgICBhd2FpdCB0aGlzLl9jbG9zZVByZXZpb3VzKCkKICAgICAgICB0aGlzLnByZXZpb3VzID0gdGhpcy5jdXJyZW50LnNuYXBzaG90KCkKCiAgICAgICAgYXdhaXQgdGhpcy5fY2xvc2VDdXJyZW50KCkKICAgICAgICB0aGlzLmN1cnJlbnQgPSB0aGlzLmJlZS5zbmFwc2hvdCh7CiAgICAgICAgICBrZXlFbmNvZGluZzogdGhpcy5rZXlFbmNvZGluZywKICAgICAgICAgIHZhbHVlRW5jb2Rpbmc6IHRoaXMudmFsdWVFbmNvZGluZwogICAgICAgIH0pCgogICAgICAgIGF3YWl0IHRoaXMuY3VycmVudC5yZWFkeSgpCiAgICAgICAgYXdhaXQgdGhpcy5wcmV2aW91cy5yZWFkeSgpCgogICAgICAgIGlmICh0aGlzLmN1cnJlbnQuY29yZS5mb3JrICE9PSB0aGlzLnByZXZpb3VzLmNvcmUuZm9yaykgewogICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3lpZWxkKCkKICAgICAgICB9CgogICAgICAgIHRoaXMuc3RyZWFtID0gdGhpcy5fZGlmZmVyKHRoaXMuY3VycmVudCwgdGhpcy5wcmV2aW91cywgdGhpcy5yYW5nZSkKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiB0aGlzLnN0cmVhbSkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl95aWVsZCgpCiAgICAgICAgICB9CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIHRoaXMuc3RyZWFtID0gbnVsbAogICAgICAgIH0KICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgcmVsZWFzZSgpCiAgICB9CiAgfQoKICBhc3luYyBfeWllbGQgKCkgewogICAgdGhpcy5jdXJyZW50TWFwcGVkID0gdGhpcy5tYXAodGhpcy5jdXJyZW50KQogICAgdGhpcy5wcmV2aW91c01hcHBlZCA9IHRoaXMubWFwKHRoaXMucHJldmlvdXMpCgogICAgaWYgKHRoaXMuX29uY2hhbmdlKSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgdGhpcy5fb25jaGFuZ2UoKQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmVtaXQoJ3VwZGF0ZScpCiAgICByZXR1cm4geyBkb25lOiBmYWxzZSwgdmFsdWU6IFt0aGlzLmN1cnJlbnRNYXBwZWQsIHRoaXMucHJldmlvdXNNYXBwZWRdIH0KICB9CgogIGFzeW5jIHJldHVybiAoKSB7CiAgICBhd2FpdCB0aGlzLmNsb3NlKCkKICAgIHJldHVybiB7IGRvbmU6IHRydWUgfQogIH0KCiAgYXN5bmMgX2Nsb3NlICgpIHsKICAgIGNvbnN0IHRvcCA9IHRoaXMuYmVlLl93YXRjaGVycy5wb3AoKQogICAgaWYgKHRvcCAhPT0gdGhpcykgewogICAgICB0b3AuaW5kZXggPSB0aGlzLmluZGV4CiAgICAgIHRoaXMuYmVlLl93YXRjaGVyc1t0b3AuaW5kZXhdID0gdG9wCiAgICB9CgogICAgaWYgKHRoaXMuc3RyZWFtICYmICF0aGlzLnN0cmVhbS5kZXN0cm95aW5nKSB7CiAgICAgIHRoaXMuc3RyZWFtLmRlc3Ryb3koKQogICAgfQoKICAgIHRoaXMuX29uYXBwZW5kKCkgLy8gQ29udGludWUgZXhlY3V0aW9uIGJlaW5nIGNsb3NlZAoKICAgIGF3YWl0IHRoaXMuX2Nsb3NlQ3VycmVudCgpLmNhdGNoKHNhZmV0eUNhdGNoKQogICAgYXdhaXQgdGhpcy5fY2xvc2VQcmV2aW91cygpLmNhdGNoKHNhZmV0eUNhdGNoKQoKICAgIGNvbnN0IHJlbGVhc2UgPSBhd2FpdCB0aGlzLl9sb2NrKCkKICAgIHJlbGVhc2UoKQogIH0KCiAgZGVzdHJveSAoKSB7CiAgICByZXR1cm4gdGhpcy5jbG9zZSgpCiAgfQoKICBhc3luYyBfY2xvc2VDdXJyZW50ICgpIHsKICAgIGlmICh0aGlzLmN1cnJlbnRNYXBwZWQpIGF3YWl0IHRoaXMuY3VycmVudE1hcHBlZC5jbG9zZSgpCiAgICBpZiAodGhpcy5jdXJyZW50KSBhd2FpdCB0aGlzLmN1cnJlbnQuY2xvc2UoKQogICAgdGhpcy5jdXJyZW50ID0gdGhpcy5jdXJyZW50TWFwcGVkID0gbnVsbAogIH0KCiAgYXN5bmMgX2Nsb3NlUHJldmlvdXMgKCkgewogICAgaWYgKHRoaXMucHJldmlvdXNNYXBwZWQpIGF3YWl0IHRoaXMucHJldmlvdXNNYXBwZWQuY2xvc2UoKQogICAgaWYgKHRoaXMucHJldmlvdXMpIGF3YWl0IHRoaXMucHJldmlvdXMuY2xvc2UoKQogICAgdGhpcy5wcmV2aW91cyA9IHRoaXMucHJldmlvdXNNYXBwZWQgPSBudWxsCiAgfQp9CgpmdW5jdGlvbiBhdXRvRmxvd09uVXBkYXRlIChuYW1lKSB7CiAgaWYgKG5hbWUgPT09ICd1cGRhdGUnKSB0aGlzLl9jb25zdW1lKCkKfQoKZnVuY3Rpb24gZGVmYXVsdFdhdGNoTWFwIChzbmFwc2hvdCkgewogIHJldHVybiBzbmFwc2hvdAp9Cgphc3luYyBmdW5jdGlvbiBsZWFmU2l6ZSAobm9kZSwgZ29MZWZ0KSB7CiAgd2hpbGUgKG5vZGUuY2hpbGRyZW4ubGVuZ3RoKSBub2RlID0gYXdhaXQgbm9kZS5nZXRDaGlsZE5vZGUoZ29MZWZ0ID8gMCA6IG5vZGUuY2hpbGRyZW4ubGVuZ3RoIC0gMSkKICByZXR1cm4gbm9kZS5rZXlzLmxlbmd0aAp9Cgphc3luYyBmdW5jdGlvbiBzZXRLZXlUb05lYXJlc3RMZWFmIChub2RlLCBpbmRleCwgc3RhY2spIHsKICBsZXQgW2xlZnQsIHJpZ2h0XSA9IGF3YWl0IFByb21pc2UuYWxsKFtub2RlLmdldENoaWxkTm9kZShpbmRleCksIG5vZGUuZ2V0Q2hpbGROb2RlKGluZGV4ICsgMSldKQogIGNvbnN0IFtscywgcnNdID0gYXdhaXQgUHJvbWlzZS5hbGwoW2xlYWZTaXplKGxlZnQsIGZhbHNlKSwgbGVhZlNpemUocmlnaHQsIHRydWUpXSkKCiAgaWYgKGxzIDwgcnMpIHsgLy8gaWYgZmV3ZXIgbGVhdmVzIG9uIHRoZSBsZWZ0CiAgICBzdGFjay5wdXNoKHJpZ2h0KQogICAgd2hpbGUgKHJpZ2h0LmNoaWxkcmVuLmxlbmd0aCkgc3RhY2sucHVzaChyaWdodCA9IHJpZ2h0LmNoaWxkcmVuWzBdLnZhbHVlKQogICAgbm9kZS5rZXlzW2luZGV4XSA9IHJpZ2h0LmtleXMuc2hpZnQoKQogIH0gZWxzZSB7IC8vIGlmIGZld2VyIGxlYXZlcyBvbiB0aGUgcmlnaHQKICAgIHN0YWNrLnB1c2gobGVmdCkKICAgIHdoaWxlIChsZWZ0LmNoaWxkcmVuLmxlbmd0aCkgc3RhY2sucHVzaChsZWZ0ID0gbGVmdC5jaGlsZHJlbltsZWZ0LmNoaWxkcmVuLmxlbmd0aCAtIDFdLnZhbHVlKQogICAgbm9kZS5rZXlzW2luZGV4XSA9IGxlZnQua2V5cy5wb3AoKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcmViYWxhbmNlIChzdGFjaykgewogIGNvbnN0IHJvb3QgPSBzdGFja1swXQoKICB3aGlsZSAoc3RhY2subGVuZ3RoID4gMSkgewogICAgY29uc3Qgbm9kZSA9IHN0YWNrLnBvcCgpCiAgICBjb25zdCBwYXJlbnQgPSBzdGFja1tzdGFjay5sZW5ndGggLSAxXQoKICAgIGlmIChub2RlLmtleXMubGVuZ3RoID49IE1JTl9LRVlTKSByZXR1cm4gcm9vdAoKICAgIGxldCB7IGxlZnQsIGluZGV4LCByaWdodCB9ID0gYXdhaXQgbm9kZS5zaWJsaW5ncyhwYXJlbnQpCgogICAgLy8gbWF5YmUgYm9ycm93IGZyb20gbGVmdCBzaWJsaW5nPwogICAgaWYgKGxlZnQgJiYgbGVmdC5rZXlzLmxlbmd0aCA+IE1JTl9LRVlTKSB7CiAgICAgIGxlZnQuY2hhbmdlZCA9IHRydWUKICAgICAgbm9kZS5rZXlzLnVuc2hpZnQocGFyZW50LmtleXNbaW5kZXggLSAxXSkKICAgICAgaWYgKGxlZnQuY2hpbGRyZW4ubGVuZ3RoKSBub2RlLmNoaWxkcmVuLnVuc2hpZnQobGVmdC5jaGlsZHJlbi5wb3AoKSkKICAgICAgcGFyZW50LmtleXNbaW5kZXggLSAxXSA9IGxlZnQua2V5cy5wb3AoKQogICAgICByZXR1cm4gcm9vdAogICAgfQoKICAgIC8vIG1heWJlIGJvcnJvdyBmcm9tIHJpZ2h0IHNpYmxpbmc/CiAgICBpZiAocmlnaHQgJiYgcmlnaHQua2V5cy5sZW5ndGggPiBNSU5fS0VZUykgewogICAgICByaWdodC5jaGFuZ2VkID0gdHJ1ZQogICAgICBub2RlLmtleXMucHVzaChwYXJlbnQua2V5c1tpbmRleF0pCiAgICAgIGlmIChyaWdodC5jaGlsZHJlbi5sZW5ndGgpIG5vZGUuY2hpbGRyZW4ucHVzaChyaWdodC5jaGlsZHJlbi5zaGlmdCgpKQogICAgICBwYXJlbnQua2V5c1tpbmRleF0gPSByaWdodC5rZXlzLnNoaWZ0KCkKICAgICAgcmV0dXJuIHJvb3QKICAgIH0KCiAgICAvLyBtZXJnZSBub2RlIHdpdGggYW5vdGhlciBzaWJsaW5nCiAgICBpZiAobGVmdCkgewogICAgICBpbmRleC0tCiAgICAgIHJpZ2h0ID0gbm9kZQogICAgfSBlbHNlIHsKICAgICAgbGVmdCA9IG5vZGUKICAgIH0KCiAgICBsZWZ0Lm1lcmdlKHJpZ2h0LCBwYXJlbnQua2V5c1tpbmRleF0pCiAgICBwYXJlbnQucmVtb3ZlS2V5KGluZGV4KQogIH0KCiAgLy8gY2hlY2sgaWYgdGhlIHRyZWUgc2hydW5rCiAgaWYgKCFyb290LmtleXMubGVuZ3RoICYmIHJvb3QuY2hpbGRyZW4ubGVuZ3RoKSByZXR1cm4gcm9vdC5nZXRDaGlsZE5vZGUoMCkKICByZXR1cm4gcm9vdAp9CgpmdW5jdGlvbiBpdGVyYXRvclRvU3RyZWFtIChpdGUsIHNpZ25hbCkgewogIGxldCBkb25lCiAgbGV0IGNsb3NpbmcKCiAgY29uc3QgcnMgPSBuZXcgUmVhZGFibGUoewogICAgc2lnbmFsLAogICAgb3BlbiAoY2IpIHsKICAgICAgZG9uZSA9IGNiCiAgICAgIGl0ZS5vcGVuKCkudGhlbihmaW4sIGZpbikKICAgIH0sCiAgICByZWFkIChjYikgewogICAgICBkb25lID0gY2IKICAgICAgaXRlLm5leHQoKS50aGVuKHB1c2gsIGZpbikKICAgIH0sCiAgICBwcmVkZXN0cm95ICgpIHsKICAgICAgY2xvc2luZyA9IGl0ZS5jbG9zZSgpCiAgICAgIGNsb3NpbmcuY2F0Y2gobm9vcCkKICAgIH0sCiAgICBkZXN0cm95IChjYikgewogICAgICBkb25lID0gY2IKICAgICAgaWYgKCFjbG9zaW5nKSBjbG9zaW5nID0gaXRlLmNsb3NlKCkKICAgICAgY2xvc2luZy50aGVuKGZpbiwgZmluKQogICAgfQogIH0pCgogIHJldHVybiBycwoKICBmdW5jdGlvbiBmaW4gKGVycikgewogICAgZG9uZShlcnIpCiAgfQoKICBmdW5jdGlvbiBwdXNoICh2YWwpIHsKICAgIHJzLnB1c2godmFsKQogICAgZG9uZShudWxsKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gaXRlcmF0b3JQZWVrIChpdGUpIHsKICB0cnkgewogICAgYXdhaXQgaXRlLm9wZW4oKQogICAgcmV0dXJuIGF3YWl0IGl0ZS5uZXh0KCkKICB9IGZpbmFsbHkgewogICAgYXdhaXQgaXRlLmNsb3NlKCkKICB9Cn0KCmZ1bmN0aW9uIGVuY1JhbmdlIChlLCBvcHRzKSB7CiAgaWYgKCFlKSByZXR1cm4gb3B0cwoKICBpZiAoZS5lbmNvZGVSYW5nZSkgewogICAgY29uc3QgciA9IGUuZW5jb2RlUmFuZ2UoeyBndDogb3B0cy5ndCwgZ3RlOiBvcHRzLmd0ZSwgbHQ6IG9wdHMubHQsIGx0ZTogb3B0cy5sdGUgfSkKICAgIG9wdHMuZ3QgPSByLmd0CiAgICBvcHRzLmd0ZSA9IHIuZ3RlCiAgICBvcHRzLmx0ID0gci5sdAogICAgb3B0cy5sdGUgPSByLmx0ZQogICAgcmV0dXJuIG9wdHMKICB9CgogIGlmIChvcHRzLmd0ICE9PSB1bmRlZmluZWQpIG9wdHMuZ3QgPSBlbmMoZSwgb3B0cy5ndCkKICBpZiAob3B0cy5ndGUgIT09IHVuZGVmaW5lZCkgb3B0cy5ndGUgPSBlbmMoZSwgb3B0cy5ndGUpCiAgaWYgKG9wdHMubHQgIT09IHVuZGVmaW5lZCkgb3B0cy5sdCA9IGVuYyhlLCBvcHRzLmx0KQogIGlmIChvcHRzLmx0ZSAhPT0gdW5kZWZpbmVkKSBvcHRzLmx0ZSA9IGVuYyhlLCBvcHRzLmx0ZSkKICBpZiAob3B0cy5zdWIgJiYgIW9wdHMuZ3QgJiYgIW9wdHMuZ3RlKSBvcHRzLmd0ID0gZW5jKGUsIFNFUCkKICBpZiAob3B0cy5zdWIgJiYgIW9wdHMubHQgJiYgIW9wdHMubHRlKSBvcHRzLmx0ID0gYnVtcChlbmMoZSwgRU1QVFkpKQoKICByZXR1cm4gb3B0cwp9CgpmdW5jdGlvbiBidW1wIChrZXkpIHsKICAvLyBrZXkgc2hvdWxkIGhhdmUgYmVlbiBjb3BpZWQgYnkgZW5jIGFib3ZlIGJlZm9yZSBoaXR0aW5nIHRoaXMKICBrZXlba2V5Lmxlbmd0aCAtIDFdKysKICByZXR1cm4ga2V5Cn0KCmZ1bmN0aW9uIGVuYyAoZSwgdikgewogIGlmICh2ID09PSB1bmRlZmluZWQgfHwgdiA9PT0gbnVsbCkgcmV0dXJuIG51bGwKICBpZiAoZSAhPT0gbnVsbCkgcmV0dXJuIGUuZW5jb2RlKHYpCiAgaWYgKHR5cGVvZiB2ID09PSAnc3RyaW5nJykgcmV0dXJuIGI0YS5mcm9tKHYpCiAgcmV0dXJuIHYKfQoKZnVuY3Rpb24gcHJlZml4RW5jb2RpbmcgKHByZWZpeCwga2V5RW5jb2RpbmcpIHsKICByZXR1cm4gewogICAgZW5jb2RlIChrZXkpIHsKICAgICAgcmV0dXJuIGI0YS5jb25jYXQoW3ByZWZpeCwgYjRhLmlzQnVmZmVyKGtleSkgPyBrZXkgOiBlbmMoa2V5RW5jb2RpbmcsIGtleSldKQogICAgfSwKICAgIGRlY29kZSAoa2V5KSB7CiAgICAgIGNvbnN0IHNsaWNlZCA9IGtleS5zbGljZShwcmVmaXgubGVuZ3RoLCBrZXkubGVuZ3RoKQogICAgICByZXR1cm4ga2V5RW5jb2RpbmcgPyBrZXlFbmNvZGluZy5kZWNvZGUoc2xpY2VkKSA6IHNsaWNlZAogICAgfQogIH0KfQoKZnVuY3Rpb24gY29weUVudHJ5IChlbnRyeSkgewogIGxldCBrZXkgPSBlbnRyeS5rZXkKICBsZXQgdmFsdWUgPSBlbnRyeS52YWx1ZQogIGxldCBpbmRleCA9IGVudHJ5LmluZGV4CgogIC8vIGtleSwgdmFsdWUgYW5kIGluZGV4IGFsbCByZWZlciB0byB0aGUgc2FtZSBidWZmZXIgKG9uZSBoeXBlcmNvcmUgYmxvY2spCiAgLy8gSWYgdG9nZXRoZXIgdGhleSBhcmUgbGFyZ2VyIHRoYW4gaGFsZiB0aGUgYnVmZmVyJ3MgYnl0ZUxlbmd0aCwKICAvLyB0aGlzIG1lYW5zIHRoYXQgdGhleSBnb3QgdGhlaXIgb3duIHByaXZhdGUgc2xhYiAoc2VlIEJ1ZmZlci5hbGxvY1Vuc2FmZSBkb2NzKQogIC8vIHNvIG5vIG5lZWQgdG8gdW5zbGFiCiAgY29uc3Qgc2l6ZSA9IGtleS5ieXRlTGVuZ3RoICsgKHZhbHVlID09PSBudWxsID8gMCA6IHZhbHVlLmJ5dGVMZW5ndGgpICsgKGluZGV4ID09PSBudWxsID8gMCA6IGluZGV4LmJ5dGVMZW5ndGgpCiAgaWYgKDIgKiBzaXplIDwga2V5LmJ1ZmZlci5ieXRlTGVuZ3RoKSB7CiAgICBjb25zdCBbbmV3S2V5LCBuZXdWYWx1ZSwgbmV3SW5kZXhdID0gdW5zbGFiQWxsKFtlbnRyeS5rZXksIGVudHJ5LnZhbHVlLCBlbnRyeS5pbmRleF0pCiAgICBrZXkgPSBuZXdLZXkKICAgIHZhbHVlID0gbmV3VmFsdWUKICAgIGluZGV4ID0gbmV3SW5kZXgKICB9CgogIHJldHVybiB7CiAgICBrZXksCiAgICB2YWx1ZSwKICAgIGluZGV4LAogICAgaW5mbGF0ZWQ6IG51bGwKICB9Cn0KCmZ1bmN0aW9uIGRlZmF1bHREaWZmZXIgKGN1cnJlbnRTbmFwLCBwcmV2aW91c1NuYXAsIG9wdHMpIHsKICByZXR1cm4gY3VycmVudFNuYXAuY3JlYXRlRGlmZlN0cmVhbShwcmV2aW91c1NuYXAsIG9wdHMpCn0KCmZ1bmN0aW9uIHRvTnVsbCAoKSB7CiAgcmV0dXJuIG51bGwKfQoKZnVuY3Rpb24gZ2V0QmFja2luZ0NvcmUgKGNvcmUpIHsKICBpZiAoY29yZS5jb3JlKSByZXR1cm4gY29yZQogIGlmIChjb3JlLmdldEJhY2tpbmdDb3JlKSByZXR1cm4gY29yZS5nZXRCYWNraW5nQ29yZSgpLnNlc3Npb24KICByZXR1cm4gbnVsbAp9CgpmdW5jdGlvbiBzYW1lVmFsdWUgKGEsIGIpIHsKICByZXR1cm4gYSA9PT0gYiB8fCAoYSAhPT0gbnVsbCAmJiBiICE9PSBudWxsICYmIGI0YS5lcXVhbHMoYSwgYikpCn0KCmZ1bmN0aW9uIG5vb3AgKCkge30KCmZ1bmN0aW9uIGdldEV4dGVuc2lvbiAoZGIsIG9wdHMpIHsKICBpZiAob3B0cy5leHRlbnNpb24gPT09IGZhbHNlKSByZXR1cm4gbnVsbAogIGlmIChvcHRzLmV4dGVuc2lvbiAmJiBvcHRzLmV4dGVuc2lvbiAhPT0gdHJ1ZSkgcmV0dXJuIG9wdHMuZXh0ZW5zaW9uCiAgcmV0dXJuIEV4dGVuc2lvbi5yZWdpc3RlcihkYikKfQoKYXN5bmMgZnVuY3Rpb24gaXNMaW5rZWQgKGJhdGNoLCBibG9jaykgewogIGNvbnN0IHNlcSA9IGJsb2NrLnNlcQogIGJsb2NrLmluZmxhdGUoKQoKICBjb25zdCBrZXlzID0gW2Jsb2NrLmtleV0KICBjb25zdCB3YWl0ID0gYmF0Y2gub3B0aW9ucy53YWl0CgogIGZvciAoY29uc3QgbCBvZiBibG9jay5pbmRleC5sZXZlbHMpIHsKICAgIGlmICghbC5rZXlzLmxlbmd0aCkgY29udGludWUKICAgIGJhdGNoLm9wdGlvbnMud2FpdCA9IGZhbHNlCiAgICB0cnkgewogICAgICBrZXlzLnB1c2goYXdhaXQgYmF0Y2guZ2V0S2V5KGwua2V5c1swXS5zZXEpKQogICAgfSBjYXRjaCB7fQogICAgYmF0Y2gub3B0aW9ucy53YWl0ID0gd2FpdAogIH0KCiAgZm9yIChjb25zdCBrIG9mIGtleXMpIHsKICAgIGlmIChhd2FpdCBiYXRjaC5saW5rcyhrLCBzZXEpKSByZXR1cm4gdHJ1ZQogIH0KCiAgaWYgKGJhdGNoLmNvcmUuY2xvc2luZykgdGhyb3cgbmV3IEVycm9yKCdDb3JlIGlzIGNsb3NlZCcpCgogIHJldHVybiBmYWxzZQp9Cgptb2R1bGUuZXhwb3J0cyA9IEh5cGVyYmVlCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjbGFzcyBTdWJUcmVlIHsKICBjb25zdHJ1Y3RvciAobm9kZSwgcGFyZW50KSB7CiAgICB0aGlzLm5vZGUgPSBub2RlCiAgICB0aGlzLnBhcmVudCA9IHBhcmVudAoKICAgIHRoaXMuaXNLZXkgPSBub2RlLmNoaWxkcmVuLmxlbmd0aCA9PT0gMAogICAgdGhpcy5pID0gdGhpcy5pc0tleSA/IDEgOiAwCiAgICB0aGlzLm4gPSAwCgogICAgY29uc3QgY2hpbGQgPSB0aGlzLmlzS2V5ID8gbnVsbCA6IHRoaXMubm9kZS5jaGlsZHJlblswXQogICAgdGhpcy5zZXEgPSBjaGlsZCAhPT0gbnVsbCA/IGNoaWxkLnNlcSA6IHRoaXMubm9kZS5rZXlzWzBdLnNlcQogICAgdGhpcy5vZmZzZXQgPSBjaGlsZCAhPT0gbnVsbCA/IGNoaWxkLm9mZnNldCA6IDAKICB9CgogIG5leHQgKCkgewogICAgdGhpcy5pKysKICAgIHRoaXMuaXNLZXkgPSAodGhpcy5pICYgMSkgPT09IDEKICAgIGlmICghdGhpcy5pc0tleSAmJiAhdGhpcy5ub2RlLmNoaWxkcmVuLmxlbmd0aCkgdGhpcy5pKysKICAgIHJldHVybiB0aGlzLnVwZGF0ZSgpCiAgfQoKICBhc3luYyBiaXNlY3QgKGtleSwgaW5jbCkgewogICAgbGV0IHMgPSAwCiAgICBsZXQgZSA9IHRoaXMubm9kZS5rZXlzLmxlbmd0aAogICAgbGV0IGMKCiAgICB3aGlsZSAocyA8IGUpIHsKICAgICAgY29uc3QgbWlkID0gKHMgKyBlKSA+PiAxCiAgICAgIGMgPSBjbXAoa2V5LCBhd2FpdCB0aGlzLm5vZGUuZ2V0S2V5KG1pZCkpCgogICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgIGlmIChpbmNsKSB0aGlzLmkgPSBtaWQgKiAyICsgMQogICAgICAgIGVsc2UgdGhpcy5pID0gbWlkICogMiArICh0aGlzLm5vZGUuY2hpbGRyZW4ubGVuZ3RoID8gMiA6IDMpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQoKICAgICAgaWYgKGMgPCAwKSBlID0gbWlkCiAgICAgIGVsc2UgcyA9IG1pZCArIDEKICAgIH0KCiAgICBjb25zdCBpID0gYyA8IDAgPyBlIDogcwogICAgdGhpcy5pID0gMiAqIGkgKyAodGhpcy5ub2RlLmNoaWxkcmVuLmxlbmd0aCA/IDAgOiAxKQogICAgcmV0dXJuIHRoaXMubm9kZS5jaGlsZHJlbi5sZW5ndGggPT09IDAKICB9CgogIHVwZGF0ZSAoKSB7CiAgICB0aGlzLmlzS2V5ID0gKHRoaXMuaSAmIDEpID09PSAxCiAgICB0aGlzLm4gPSB0aGlzLmkgPj4gMQogICAgaWYgKHRoaXMubiA+PSAodGhpcy5pc0tleSA/IHRoaXMubm9kZS5rZXlzLmxlbmd0aCA6IHRoaXMubm9kZS5jaGlsZHJlbi5sZW5ndGgpKSByZXR1cm4gZmFsc2UKICAgIGNvbnN0IGNoaWxkID0gdGhpcy5pc0tleSA/IG51bGwgOiB0aGlzLm5vZGUuY2hpbGRyZW5bdGhpcy5uXQogICAgdGhpcy5zZXEgPSBjaGlsZCAhPT0gbnVsbCA/IGNoaWxkLnNlcSA6IHRoaXMubm9kZS5rZXlzW3RoaXMubl0uc2VxCiAgICB0aGlzLm9mZnNldCA9IGNoaWxkICE9PSBudWxsID8gY2hpbGQub2Zmc2V0IDogMAogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIGtleSAoKSB7CiAgICByZXR1cm4gdGhpcy5uIDwgdGhpcy5ub2RlLmtleXMubGVuZ3RoID8gdGhpcy5ub2RlLmdldEtleSh0aGlzLm4pIDogKHRoaXMucGFyZW50ICYmIHRoaXMucGFyZW50LmtleSgpKQogIH0KCiAgYXN5bmMgY29tcGFyZSAodHJlZSkgewogICAgY29uc3QgW2EsIGJdID0gYXdhaXQgUHJvbWlzZS5hbGwoW3RoaXMua2V5KCksIHRyZWUua2V5KCldKQogICAgcmV0dXJuIGNtcChhLCBiKQogIH0KfQoKY2xhc3MgVHJlZUl0ZXJhdG9yIHsKICBjb25zdHJ1Y3RvciAoYmF0Y2gsIG9wdHMpIHsKICAgIHRoaXMuYmF0Y2ggPSBiYXRjaAogICAgdGhpcy5zdGFjayA9IFtdCiAgICB0aGlzLmx0ID0gb3B0cy5sdCB8fCBvcHRzLmx0ZSB8fCBudWxsCiAgICB0aGlzLmx0ZSA9ICEhb3B0cy5sdGUKICAgIHRoaXMuZ3QgPSBvcHRzLmd0IHx8IG9wdHMuZ3RlIHx8IG51bGwKICAgIHRoaXMuZ3RlID0gISFvcHRzLmd0ZQogICAgdGhpcy5zZWVraW5nID0gISF0aGlzLmd0CiAgICB0aGlzLmVuY29kaW5nID0gb3B0cy5lbmNvZGluZyB8fCBiYXRjaC5lbmNvZGluZwogIH0KCiAgYXN5bmMgb3BlbiAoKSB7CiAgICBjb25zdCBub2RlID0gYXdhaXQgdGhpcy5iYXRjaC5nZXRSb290KGZhbHNlKQogICAgaWYgKCFub2RlIHx8ICFub2RlLmtleXMubGVuZ3RoKSByZXR1cm4KICAgIGNvbnN0IHRyZWUgPSBuZXcgU3ViVHJlZShub2RlLCBudWxsKQogICAgaWYgKHRoaXMuc2Vla2luZyAmJiAhKGF3YWl0IHRoaXMuX3NlZWsodHJlZSkpKSByZXR1cm4KICAgIHRoaXMuc3RhY2sucHVzaCh0cmVlKQogIH0KCiAgYXN5bmMgX3NlZWsgKHRyZWUpIHsKICAgIGNvbnN0IGRvbmUgPSBhd2FpdCB0cmVlLmJpc2VjdCh0aGlzLmd0LCB0aGlzLmd0ZSkKICAgIGNvbnN0IG9vYiA9ICF0cmVlLnVwZGF0ZSgpCiAgICBpZiAoZG9uZSB8fCBvb2IpIHsKICAgICAgdGhpcy5zZWVraW5nID0gZmFsc2UKICAgICAgaWYgKG9vYikgcmV0dXJuIGZhbHNlCiAgICB9CiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgcGVlayAoKSB7CiAgICBpZiAoIXRoaXMuc3RhY2subGVuZ3RoKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHRoaXMuc3RhY2tbdGhpcy5zdGFjay5sZW5ndGggLSAxXQogIH0KCiAgc2tpcCAoKSB7CiAgICBpZiAoIXRoaXMuc3RhY2subGVuZ3RoKSByZXR1cm4KICAgIGlmICghdGhpcy5zdGFja1t0aGlzLnN0YWNrLmxlbmd0aCAtIDFdLm5leHQoKSkgdGhpcy5zdGFjay5wb3AoKQogIH0KCiAgYXN5bmMgbmV4dEtleSAoKSB7CiAgICBsZXQgbiA9IG51bGwKICAgIHdoaWxlICh0aGlzLnN0YWNrLmxlbmd0aCAmJiBuID09PSBudWxsKSBuID0gYXdhaXQgdGhpcy5uZXh0KCkKICAgIGlmIChuID09PSBudWxsKSByZXR1cm4gbnVsbAogICAgaWYgKCF0aGlzLmx0KSByZXR1cm4gbi5maW5hbCh0aGlzLmVuY29kaW5nKQoKICAgIGNvbnN0IGMgPSBjbXAobi5rZXksIHRoaXMubHQpCiAgICBpZiAodGhpcy5sdGUgPyBjIDw9IDAgOiBjIDwgMCkgcmV0dXJuIG4uZmluYWwodGhpcy5lbmNvZGluZykKICAgIHRoaXMuc3RhY2sgPSBbXQogICAgcmV0dXJuIG51bGwKICB9CgogIGFzeW5jIG5leHQgKCkgewogICAgaWYgKCF0aGlzLnN0YWNrLmxlbmd0aCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCB0b3AgPSB0aGlzLnN0YWNrW3RoaXMuc3RhY2subGVuZ3RoIC0gMV0KICAgIGNvbnN0IHsgaXNLZXksIG4sIHNlcSB9ID0gdG9wCgogICAgaWYgKCF0b3AubmV4dCgpKSB7CiAgICAgIHRoaXMuc3RhY2sucG9wKCkKICAgIH0KCiAgICBpZiAoaXNLZXkpIHsKICAgICAgdGhpcy5zZWVraW5nID0gZmFsc2UKICAgICAgcmV0dXJuIHRoaXMuYmF0Y2guZ2V0QmxvY2soc2VxKQogICAgfQoKICAgIGNvbnN0IGNoaWxkID0gYXdhaXQgdG9wLm5vZGUuZ2V0Q2hpbGROb2RlKG4pCiAgICB0b3Aubm9kZS5jaGlsZHJlbltuXSA9IG51bGwgLy8gdW5saW5rIHRvIHNhdmUgbWVtb3J5CiAgICBjb25zdCB0cmVlID0gbmV3IFN1YlRyZWUoY2hpbGQsIHRvcCkKICAgIGlmICh0aGlzLnNlZWtpbmcgJiYgIShhd2FpdCB0aGlzLl9zZWVrKHRyZWUpKSkgcmV0dXJuIG51bGwKICAgIHRoaXMuc3RhY2sucHVzaCh0cmVlKQoKICAgIHJldHVybiBudWxsCiAgfQoKICBjbG9zZSAoKSB7CiAgICByZXR1cm4gdGhpcy5iYXRjaC5fY2xvc2VTbmFwc2hvdCgpCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIERpZmZJdGVyYXRvciB7CiAgY29uc3RydWN0b3IgKGxlZnQsIHJpZ2h0LCBvcHRzID0ge30pIHsKICAgIHRoaXMubGVmdCA9IG5ldyBUcmVlSXRlcmF0b3IobGVmdCwgb3B0cykKICAgIHRoaXMucmlnaHQgPSBuZXcgVHJlZUl0ZXJhdG9yKHJpZ2h0LCBvcHRzKQogICAgdGhpcy5saW1pdCA9IHR5cGVvZiBvcHRzLmxpbWl0ID09PSAnbnVtYmVyJyA/IG9wdHMubGltaXQgOiAtMQogIH0KCiAgYXN5bmMgb3BlbiAoKSB7CiAgICBhd2FpdCBQcm9taXNlLmFsbChbdGhpcy5sZWZ0Lm9wZW4oKSwgdGhpcy5yaWdodC5vcGVuKCldKQogIH0KCiAgYXN5bmMgbmV4dCAoKSB7CiAgICBpZiAodGhpcy5saW1pdCA9PT0gMCkgcmV0dXJuIG51bGwKICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuX25leHQoKQogICAgaWYgKCFyZXMgfHwgKHJlcy5sZWZ0ID09PSBudWxsICYmIHJlcy5yaWdodCA9PT0gbnVsbCkpIHJldHVybiBudWxsCiAgICB0aGlzLmxpbWl0LS0KICAgIHJldHVybiByZXMKICB9CgogIGFzeW5jIF9uZXh0ICgpIHsKICAgIGNvbnN0IGEgPSB0aGlzLmxlZnQKICAgIGNvbnN0IGIgPSB0aGlzLnJpZ2h0CgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgY29uc3QgW2wsIHJdID0gYXdhaXQgUHJvbWlzZS5hbGwoW2EucGVlaygpLCBiLnBlZWsoKV0pCgogICAgICBpZiAoIWwgJiYgIXIpIHJldHVybiBudWxsCiAgICAgIGlmICghbCkgcmV0dXJuIHsgbGVmdDogbnVsbCwgcmlnaHQ6IGF3YWl0IGIubmV4dEtleSgpIH0KICAgICAgaWYgKCFyKSByZXR1cm4geyBsZWZ0OiBhd2FpdCBhLm5leHRLZXkoKSwgcmlnaHQ6IG51bGwgfQoKICAgICAgaWYgKGwuc2VxID09PSByLnNlcSAmJiBsLmlzS2V5ID09PSByLmlzS2V5ICYmIGwub2Zmc2V0ID09PSByLm9mZnNldCkgewogICAgICAgIGEuc2tpcCgpCiAgICAgICAgYi5za2lwKCkKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBjb25zdCBjID0gYXdhaXQgbC5jb21wYXJlKHIpCgogICAgICBpZiAobC5pc0tleSAmJiAhci5pc0tleSkgewogICAgICAgIGF3YWl0IGIubmV4dCgpCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgaWYgKCFsLmlzS2V5ICYmIHIuaXNLZXkpIHsKICAgICAgICBhd2FpdCBhLm5leHQoKQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGlmIChsLmlzS2V5ICYmIHIuaXNLZXkpIHsKICAgICAgICBpZiAoYyA9PT0gMCkgcmV0dXJuIHsgbGVmdDogYXdhaXQgYS5uZXh0S2V5KCksIHJpZ2h0OiBhd2FpdCBiLm5leHRLZXkoKSB9CiAgICAgICAgaWYgKGMgPCAwKSByZXR1cm4geyBsZWZ0OiBhd2FpdCBhLm5leHRLZXkoKSwgcmlnaHQ6IG51bGwgfQogICAgICAgIHJldHVybiB7IGxlZnQ6IG51bGwsIHJpZ2h0OiBhd2FpdCBiLm5leHRLZXkoKSB9CiAgICAgIH0KCiAgICAgIGlmIChjID09PSAwKSBhd2FpdCBQcm9taXNlLmFsbChbYS5uZXh0KCksIGIubmV4dCgpXSkKICAgICAgZWxzZSBpZiAoYyA8IDApIGF3YWl0IGIubmV4dCgpCiAgICAgIGVsc2UgYXdhaXQgYS5uZXh0KCkKICAgIH0KICB9CgogIGFzeW5jIGNsb3NlICgpIHsKICAgIGF3YWl0IFByb21pc2UuYWxsKFt0aGlzLmxlZnQuY2xvc2UoKSwgdGhpcy5yaWdodC5jbG9zZSgpXSkKICB9Cn0KCmZ1bmN0aW9uIGNtcCAoYSwgYikgewogIGlmICghYSkgcmV0dXJuIGIgPyAxIDogMAogIGlmICghYikgcmV0dXJuIGEgPyAtMSA6IDAKICByZXR1cm4gYjRhLmNvbXBhcmUoYSwgYikKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEhpc3RvcnlJdGVyYXRvciB7CiAgY29uc3RydWN0b3IgKGJhdGNoLCBvcHRzID0ge30pIHsKICAgIHRoaXMuYmF0Y2ggPSBiYXRjaAogICAgdGhpcy5vcHRpb25zID0gb3B0cwogICAgdGhpcy5saXZlID0gISFvcHRzLmxpdmUKICAgIHRoaXMuZ3RlID0gMAogICAgdGhpcy5sdCA9IDAKICAgIHRoaXMucmV2ZXJzZSA9ICEhb3B0cy5yZXZlcnNlCiAgICB0aGlzLmxpbWl0ID0gdHlwZW9mIG9wdHMubGltaXQgPT09ICdudW1iZXInID8gb3B0cy5saW1pdCA6IC0xCiAgICB0aGlzLmVuY29kaW5nID0gb3B0cy5lbmNvZGluZyB8fCBiYXRjaC5lbmNvZGluZwogICAgaWYgKHRoaXMubGl2ZSAmJiB0aGlzLnJldmVyc2UpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgaGF2ZSBib3RoIGxpdmUgYW5kIHJldmVyc2UgZW5hYmxlZCcpCiAgICB9CiAgfQoKICBhc3luYyBvcGVuICgpIHsKICAgIGF3YWl0IHRoaXMuYmF0Y2guZ2V0Um9vdChmYWxzZSkgLy8gZG9lcyB0aGUgdXBkYXRlIGRhbmNlCiAgICB0aGlzLmd0ZSA9IGd0ZSh0aGlzLm9wdGlvbnMsIHRoaXMuYmF0Y2gudmVyc2lvbikKICAgIHRoaXMubHQgPSB0aGlzLmxpdmUgPyBJbmZpbml0eSA6IGx0KHRoaXMub3B0aW9ucywgdGhpcy5iYXRjaC52ZXJzaW9uKQogIH0KCiAgYXN5bmMgbmV4dCAoKSB7CiAgICBpZiAodGhpcy5saW1pdCA9PT0gMCkgcmV0dXJuIG51bGwKICAgIGlmICh0aGlzLmxpbWl0ID4gMCkgdGhpcy5saW1pdC0tCgogICAgaWYgKHRoaXMuZ3RlID49IHRoaXMubHQpIHJldHVybiBudWxsCgogICAgaWYgKHRoaXMucmV2ZXJzZSkgewogICAgICBpZiAodGhpcy5sdCA8PSAxKSByZXR1cm4gbnVsbAogICAgICByZXR1cm4gZmluYWwoYXdhaXQgdGhpcy5iYXRjaC5nZXRCbG9jaygtLXRoaXMubHQpLCB0aGlzLmVuY29kaW5nKQogICAgfQoKICAgIHJldHVybiBmaW5hbChhd2FpdCB0aGlzLmJhdGNoLmdldEJsb2NrKHRoaXMuZ3RlKyspLCB0aGlzLmVuY29kaW5nKQogIH0KCiAgY2xvc2UgKCkgewogICAgcmV0dXJuIHRoaXMuYmF0Y2guX2Nsb3NlU25hcHNob3QoKQogIH0KfQoKZnVuY3Rpb24gZmluYWwgKG5vZGUsIGVuY29kaW5nKSB7CiAgY29uc3QgdHlwZSA9IG5vZGUuaXNEZWxldGlvbigpID8gJ2RlbCcgOiAncHV0JwogIHJldHVybiB7IHR5cGUsIC4uLm5vZGUuZmluYWwoZW5jb2RpbmcpIH0KfQoKZnVuY3Rpb24gZ3RlIChvcHRzLCB2ZXJzaW9uKSB7CiAgaWYgKG9wdHMuZ3QpIHJldHVybiAob3B0cy5ndCA8IDAgPyAob3B0cy5ndCArIHZlcnNpb24pIDogb3B0cy5ndCkgKyAxCiAgY29uc3QgZ3RlID0gb3B0cy5ndGUgfHwgb3B0cy5zaW5jZSB8fCAxCiAgcmV0dXJuIGd0ZSA8IDAgPyBndGUgKyB2ZXJzaW9uIDogZ3RlCn0KCmZ1bmN0aW9uIGx0IChvcHRzLCB2ZXJzaW9uKSB7CiAgaWYgKG9wdHMubHRlID09PSAwIHx8IG9wdHMubHQgPT09IDAgfHwgb3B0cy5lbmQgPT09IDApIHJldHVybiAwCiAgaWYgKG9wdHMubHRlKSByZXR1cm4gKG9wdHMubHRlIDwgMCA/IChvcHRzLmx0ZSArIHZlcnNpb24pIDogb3B0cy5sdGUpICsgMQogIGNvbnN0IGx0ID0gb3B0cy5sdCB8fCBvcHRzLmVuZCB8fCB2ZXJzaW9uCiAgcmV0dXJuIGx0IDwgMCA/IGx0ICsgdmVyc2lvbiA6IGx0Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBMb2NhbEJsb2Nrc0l0ZXJhdG9yIHsKICBjb25zdHJ1Y3RvciAoYmF0Y2gsIG9wdHMgPSB7fSkgewogICAgdGhpcy5iYXRjaCA9IGJhdGNoCiAgICB0aGlzLm9wdGlvbnMgPSBvcHRzCiAgICB0aGlzLmd0ZSA9IDAKICAgIHRoaXMubHQgPSAwCiAgICB0aGlzLmxpbWl0ID0gdHlwZW9mIG9wdHMubGltaXQgPT09ICdudW1iZXInID8gb3B0cy5saW1pdCA6IC0xCiAgfQoKICBhc3luYyBvcGVuICgpIHsKICAgIGF3YWl0IHRoaXMuYmF0Y2guZ2V0Um9vdChmYWxzZSkgLy8gZG9lcyB0aGUgdXBkYXRlIGRhbmNlCiAgICB0aGlzLmd0ZSA9IGd0ZSh0aGlzLm9wdGlvbnMsIHRoaXMuYmF0Y2gudmVyc2lvbikKICAgIHRoaXMubHQgPSBsdCh0aGlzLm9wdGlvbnMsIHRoaXMuYmF0Y2gudmVyc2lvbikKICB9CgogIGFzeW5jIG5leHQgKCkgewogICAgaWYgKHRoaXMubGltaXQgPT09IDApIHJldHVybiBudWxsCiAgICBpZiAodGhpcy5saW1pdCA+IDApIHRoaXMubGltaXQtLQoKICAgIHdoaWxlICh0aGlzLmd0ZSA8IHRoaXMubHQpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5iYXRjaC5nZXRCbG9jayh0aGlzLmd0ZSsrKQogICAgICB9IGNhdGNoIHsKICAgICAgICBjb250aW51ZQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIGNsb3NlICgpIHsKICAgIHJldHVybiB0aGlzLmJhdGNoLl9jbG9zZVNuYXBzaG90KCkKICB9Cn0KCmZ1bmN0aW9uIGd0ZSAob3B0cywgdmVyc2lvbikgewogIGlmIChvcHRzLmd0KSByZXR1cm4gKG9wdHMuZ3QgPCAwID8gKG9wdHMuZ3QgKyB2ZXJzaW9uKSA6IG9wdHMuZ3QpICsgMQogIGNvbnN0IGd0ZSA9IG9wdHMuZ3RlIHx8IG9wdHMuc2luY2UgfHwgMQogIHJldHVybiBndGUgPCAwID8gZ3RlICsgdmVyc2lvbiA6IGd0ZQp9CgpmdW5jdGlvbiBsdCAob3B0cywgdmVyc2lvbikgewogIGlmIChvcHRzLmx0ZSA9PT0gMCB8fCBvcHRzLmx0ID09PSAwIHx8IG9wdHMuZW5kID09PSAwKSByZXR1cm4gMAogIGlmIChvcHRzLmx0ZSkgcmV0dXJuIChvcHRzLmx0ZSA8IDAgPyAob3B0cy5sdGUgKyB2ZXJzaW9uKSA6IG9wdHMubHRlKSArIDEKICBjb25zdCBsdCA9IG9wdHMubHQgfHwgb3B0cy5lbmQgfHwgdmVyc2lvbgogIHJldHVybiBsdCA8IDAgPyBsdCArIHZlcnNpb24gOiBsdAp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJhbmdlSXRlcmF0b3IgewogIGNvbnN0cnVjdG9yIChiYXRjaCwgZW5jb2RpbmcsIG9wdHMgPSB7fSkgewogICAgdGhpcy5iYXRjaCA9IGJhdGNoCiAgICB0aGlzLnN0YWNrID0gW10KICAgIHRoaXMub3BlbmVkID0gZmFsc2UKICAgIHRoaXMuZW5jb2RpbmcgPSBlbmNvZGluZyB8fCBiYXRjaC5lbmNvZGluZwoKICAgIHRoaXMuX2xpbWl0ID0gdHlwZW9mIG9wdHMubGltaXQgPT09ICdudW1iZXInID8gb3B0cy5saW1pdCA6IC0xCiAgICB0aGlzLl9nSW5jbCA9ICFvcHRzLmd0CiAgICB0aGlzLl9nS2V5ID0gb3B0cy5ndCB8fCBvcHRzLmd0ZSB8fCBudWxsCiAgICB0aGlzLl9sSW5jbCA9ICFvcHRzLmx0CiAgICB0aGlzLl9sS2V5ID0gb3B0cy5sdCB8fCBvcHRzLmx0ZSB8fCBudWxsCiAgICB0aGlzLl9yZXZlcnNlID0gISFvcHRzLnJldmVyc2UKICAgIHRoaXMuX3ZlcnNpb24gPSAwCiAgICB0aGlzLl9jaGVja3BvaW50ID0gKG9wdHMuY2hlY2twb2ludCAmJiBvcHRzLmNoZWNrcG9pbnQubGVuZ3RoKSA/IG9wdHMuY2hlY2twb2ludCA6IG51bGwKICAgIHRoaXMuX25leHRpbmcgPSBmYWxzZQogIH0KCiAgc25hcHNob3QgKHZlcnNpb24gPSB0aGlzLmJhdGNoLnZlcnNpb24pIHsKICAgIGNvbnN0IGNoZWNrcG9pbnQgPSBbXQogICAgZm9yIChjb25zdCBzIG9mIHRoaXMuc3RhY2spIHsKICAgICAgbGV0IHsgbm9kZSwgaSB9ID0gcwogICAgICBpZiAodGhpcy5fbmV4dGluZyAmJiBzID09PSB0aGlzLnN0YWNrW3RoaXMuc3RhY2subGVuZ3RoIC0gMV0pIGkgPSB0aGlzLl9yZXZlcnNlID8gaSArIDEgOiBpIC0gMQogICAgICBpZiAoIW5vZGUuYmxvY2spIGNvbnRpbnVlCiAgICAgIGlmIChpIDwgMCkgY29udGludWUKICAgICAgY2hlY2twb2ludC5wdXNoKG5vZGUuYmxvY2suc2VxLCBub2RlLm9mZnNldCwgaSkKICAgIH0KCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICBndGU6IHRoaXMuX2dJbmNsID8gdGhpcy5fZ0tleSA6IG51bGwsCiAgICAgIGd0OiB0aGlzLl9nSW5jbCA/IG51bGwgOiB0aGlzLl9nS2V5LAogICAgICBsdGU6IHRoaXMuX2xJbmNsID8gdGhpcy5fbEtleSA6IG51bGwsCiAgICAgIGx0OiB0aGlzLl9sSW5jbCA/IG51bGwgOiB0aGlzLl9sS2V5LAogICAgICBsaW1pdDogdGhpcy5fbGltaXQsCiAgICAgIHJldmVyc2U6IHRoaXMuX3JldmVyc2UsCiAgICAgIGVuZGVkOiB0aGlzLm9wZW5lZCAmJiAhY2hlY2twb2ludC5sZW5ndGgsCiAgICAgIGNoZWNrcG9pbnQ6IHRoaXMub3BlbmVkID8gY2hlY2twb2ludCA6IFtdCiAgICB9CiAgfQoKICBhc3luYyBvcGVuICgpIHsKICAgIGF3YWl0IHRoaXMuX29wZW4oKQogICAgdGhpcy5vcGVuZWQgPSB0cnVlCiAgfQoKICBhc3luYyBfb3BlbiAoKSB7CiAgICBpZiAodGhpcy5fY2hlY2twb2ludCkgewogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRoaXMuX2NoZWNrcG9pbnQubGVuZ3RoOyBqICs9IDMpIHsKICAgICAgICBjb25zdCBzZXEgPSB0aGlzLl9jaGVja3BvaW50W2pdCiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy5fY2hlY2twb2ludFtqICsgMV0KICAgICAgICBjb25zdCBpID0gdGhpcy5fY2hlY2twb2ludFtqICsgMl0KICAgICAgICB0aGlzLnN0YWNrLnB1c2goewogICAgICAgICAgbm9kZTogKGF3YWl0IHRoaXMuYmF0Y2guZ2V0QmxvY2soc2VxKSkuZ2V0VHJlZU5vZGUob2Zmc2V0KSwKICAgICAgICAgIGkKICAgICAgICB9KQogICAgICB9CiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuX25leHRpbmcgPSB0cnVlCgogICAgbGV0IG5vZGUgPSBhd2FpdCB0aGlzLmJhdGNoLmdldFJvb3QoZmFsc2UpCiAgICBpZiAoIW5vZGUpIHsKICAgICAgdGhpcy5fbmV4dGluZyA9IGZhbHNlCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IGluY2wgPSB0aGlzLl9yZXZlcnNlID8gdGhpcy5fbEluY2wgOiB0aGlzLl9nSW5jbAogICAgY29uc3Qgc3RhcnQgPSB0aGlzLl9yZXZlcnNlID8gdGhpcy5fbEtleSA6IHRoaXMuX2dLZXkKCiAgICBpZiAoIXN0YXJ0KSB7CiAgICAgIHRoaXMuc3RhY2sucHVzaCh7IG5vZGUsIGk6IHRoaXMuX3JldmVyc2UgPyBub2RlLmtleXMubGVuZ3RoIDw8IDEgOiAwIH0pCiAgICAgIHRoaXMuX25leHRpbmcgPSBmYWxzZQogICAgICByZXR1cm4KICAgIH0KCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBjb25zdCBlbnRyeSA9IHsgbm9kZSwgaTogdGhpcy5fcmV2ZXJzZSA/IG5vZGUua2V5cy5sZW5ndGggPDwgMSA6IDAgfQoKICAgICAgbGV0IHMgPSAwCiAgICAgIGxldCBlID0gbm9kZS5rZXlzLmxlbmd0aAogICAgICBsZXQgYwoKICAgICAgd2hpbGUgKHMgPCBlKSB7CiAgICAgICAgY29uc3QgbWlkID0gKHMgKyBlKSA+PiAxCiAgICAgICAgYyA9IGI0YS5jb21wYXJlKHN0YXJ0LCBhd2FpdCBub2RlLmdldEtleShtaWQpKQoKICAgICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgICAgaWYgKGluY2wpIGVudHJ5LmkgPSBtaWQgKiAyICsgMQogICAgICAgICAgZWxzZSBlbnRyeS5pID0gbWlkICogMiArICh0aGlzLl9yZXZlcnNlID8gMCA6IDIpCiAgICAgICAgICB0aGlzLnN0YWNrLnB1c2goZW50cnkpCiAgICAgICAgICB0aGlzLl9uZXh0aW5nID0gZmFsc2UKICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgaWYgKGMgPCAwKSBlID0gbWlkCiAgICAgICAgZWxzZSBzID0gbWlkICsgMQogICAgICB9CgogICAgICBjb25zdCBpID0gYyA8IDAgPyBlIDogcwogICAgICBlbnRyeS5pID0gMiAqIGkgKyAodGhpcy5fcmV2ZXJzZSA/IC0xIDogMSkKCiAgICAgIGlmIChlbnRyeS5pID49IDAgJiYgZW50cnkuaSA8PSAobm9kZS5rZXlzLmxlbmd0aCA8PCAxKSkgdGhpcy5zdGFjay5wdXNoKGVudHJ5KQogICAgICBpZiAoIW5vZGUuY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5fbmV4dGluZyA9IGZhbHNlCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIG5vZGUgPSBhd2FpdCBub2RlLmdldENoaWxkTm9kZShpKQogICAgfQogIH0KCiAgYXN5bmMgbmV4dCAoKSB7CiAgICAvLyBUT0RPOiB0aGlzIG5leHRpbmcgZmxhZyBpcyBvbmx5IG5lZWRlZCBpZiBzb21lb25lIGFza3MgZm9yIGEgc25hcHNob3QgZHVyaW5nCiAgICAvLyBhIGxvb2t1cCAoaWUgdGhlIGV4dGVuc2lvbiwgcHJldHR5IGltcG9ydGFudC4uLikuCiAgICAvLyBBIGJldHRlciBzb2x1dGlvbiB3b3VsZCBiZSB0byByZWZhY3RvciB0aGlzIHNvIHRvcC5pIGlzIGluY3JlbWVudGVkIGVhZ2VybHkKICAgIC8vIHRvIGdldCB0aGUgY3VycmVudCBibG9jayBpbnN0ZWFkIG9mIHRoZSB3YXkgaXQgaXMgZG9uZSBub3cgKCsraSB2cyBpKyspCiAgICB0aGlzLl9uZXh0aW5nID0gdHJ1ZQoKICAgIGNvbnN0IGVuZCA9IHRoaXMuX3JldmVyc2UgPyB0aGlzLl9nS2V5IDogdGhpcy5fbEtleQogICAgY29uc3QgaW5jbCA9IHRoaXMuX3JldmVyc2UgPyB0aGlzLl9nSW5jbCA6IHRoaXMuX2xJbmNsCgogICAgd2hpbGUgKHRoaXMuc3RhY2subGVuZ3RoICYmICh0aGlzLl9saW1pdCA9PT0gLTEgfHwgdGhpcy5fbGltaXQgPiAwKSkgewogICAgICBjb25zdCB0b3AgPSB0aGlzLnN0YWNrW3RoaXMuc3RhY2subGVuZ3RoIC0gMV0KICAgICAgY29uc3QgaXNLZXkgPSAodG9wLmkgJiAxKSA9PT0gMQogICAgICBjb25zdCBuID0gdGhpcy5fcmV2ZXJzZQogICAgICAgID8gKHRvcC5pIDwgMCA/IHRvcC5ub2RlLmtleXMubGVuZ3RoIDogdG9wLmktLSA+PiAxKQogICAgICAgIDogdG9wLmkrKyA+PiAxCgogICAgICBpZiAoIWlzS2V5KSB7CiAgICAgICAgaWYgKCF0b3Aubm9kZS5jaGlsZHJlbi5sZW5ndGgpIGNvbnRpbnVlCiAgICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IHRvcC5ub2RlLmdldENoaWxkTm9kZShuKQogICAgICAgIGlmICh0b3Aubm9kZS5ibG9jay5zZXEgPCB0aGlzLmJhdGNoLmNvcmUubGVuZ3RoKSB7CiAgICAgICAgICB0b3Aubm9kZS5jaGlsZHJlbltuXS52YWx1ZSA9IG51bGwgLy8gdW5saW5rIGl0IHRvIHNhdmUgbWVtb3J5CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RhY2sucHVzaCh7IGk6IHRoaXMuX3JldmVyc2UgPyBub2RlLmtleXMubGVuZ3RoIDw8IDEgOiAwLCBub2RlIH0pCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgaWYgKG4gPj0gdG9wLm5vZGUua2V5cy5sZW5ndGgpIHsKICAgICAgICB0aGlzLnN0YWNrLnBvcCgpCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgY29uc3Qga2V5ID0gdG9wLm5vZGUua2V5c1tuXQogICAgICBjb25zdCBibG9jayA9IGF3YWl0IHRoaXMuYmF0Y2guZ2V0QmxvY2soa2V5LnNlcSkKICAgICAgaWYgKGVuZCkgewogICAgICAgIGNvbnN0IGMgPSBiNGEuY29tcGFyZShibG9jay5rZXksIGVuZCkKICAgICAgICBpZiAoYyA9PT0gMCA/ICFpbmNsIDogKHRoaXMuX3JldmVyc2UgPyBjIDwgMCA6IGMgPiAwKSkgewogICAgICAgICAgdGhpcy5fbGltaXQgPSAwCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQogICAgICBpZiAodGhpcy5fbGltaXQgPiAwKSB0aGlzLl9saW1pdC0tCiAgICAgIHRoaXMuX25leHRpbmcgPSBmYWxzZQogICAgICByZXR1cm4gYmxvY2suZmluYWwodGhpcy5lbmNvZGluZykKICAgIH0KCiAgICB0aGlzLl9uZXh0aW5nID0gZmFsc2UKICAgIHJldHVybiBudWxsCiAgfQoKICBjbG9zZSAoKSB7CiAgICByZXR1cm4gdGhpcy5iYXRjaC5fY2xvc2VTbmFwc2hvdCgpCiAgfQp9CmNvbnN0IHsgRXh0ZW5zaW9uIH0gPSByZXF1aXJlKCcuL21lc3NhZ2VzJykKCi8vIGNvbnN0IE1BWF9BQ1RJVkUgPSAzMgpjb25zdCBGTFVTSF9CQVRDSCA9IDEyOApjb25zdCBNQVhfUEFTU0lWRV9CQVRDSCA9IDIwNDgKY29uc3QgTUFYX0FDVElWRV9CQVRDSCA9IE1BWF9QQVNTSVZFX0JBVENIICsgRkxVU0hfQkFUQ0gKCmNsYXNzIEJhdGNoIHsKICBjb25zdHJ1Y3RvciAob3V0Z29pbmcsIGZyb20pIHsKICAgIHRoaXMuYmxvY2tzID0gW10KICAgIHRoaXMuc3RhcnQgPSAwCiAgICB0aGlzLmVuZCA9IDAKICAgIHRoaXMub3V0Z29pbmcgPSBvdXRnb2luZwogICAgdGhpcy5mcm9tID0gZnJvbQogIH0KCiAgcHVzaCAoc2VxKSB7CiAgICBjb25zdCBsZW4gPSB0aGlzLmJsb2Nrcy5wdXNoKHNlcSkKICAgIGlmIChsZW4gPT09IDEgfHwgc2VxIDwgdGhpcy5zdGFydCkgdGhpcy5zdGFydCA9IHNlcQogICAgaWYgKGxlbiA9PT0gMSB8fCBzZXEgPj0gdGhpcy5lbmQpIHRoaXMuZW5kID0gc2VxICsgMQogICAgaWYgKGxlbiA+PSBGTFVTSF9CQVRDSCkgewogICAgICB0aGlzLnNlbmQoKQogICAgICB0aGlzLmNsZWFyKCkKICAgIH0KICB9CgogIHNlbmQgKCkgewogICAgaWYgKCF0aGlzLmJsb2Nrcy5sZW5ndGgpIHJldHVybgogICAgdGhpcy5vdXRnb2luZy5zZW5kKEV4dGVuc2lvbi5lbmNvZGUoeyBjYWNoZTogeyBibG9ja3M6IHRoaXMuYmxvY2tzLCBzdGFydDogdGhpcy5zdGFydCwgZW5kOiB0aGlzLmVuZCB9IH0pLCB0aGlzLmZyb20pCiAgfQoKICBjbGVhciAoKSB7CiAgICB0aGlzLnN0YXJ0ID0gdGhpcy5lbmQgPSAwCiAgICB0aGlzLmJsb2NrcyA9IFtdCiAgfQp9CgpjbGFzcyBIeXBlcmJlZUV4dGVuc2lvbiB7CiAgY29uc3RydWN0b3IgKGRiKSB7CiAgICB0aGlzLmVuY29kaW5nID0gbnVsbAogICAgdGhpcy5vdXRnb2luZyA9IG51bGwKICAgIHRoaXMuZGIgPSBkYgogICAgdGhpcy5hY3RpdmUgPSAwCiAgfQoKICBnZXQgKHZlcnNpb24sIGtleSkgewogICAgdGhpcy5vdXRnb2luZy5icm9hZGNhc3QoRXh0ZW5zaW9uLmVuY29kZSh7IGdldDogeyB2ZXJzaW9uLCBrZXkgfSB9KSkKICB9CgogIGl0ZXJhdG9yIChzbmFwc2hvdCkgewogICAgaWYgKHNuYXBzaG90LmVuZGVkKSByZXR1cm4KICAgIGlmIChzbmFwc2hvdC5saW1pdCA9PT0gMCkgcmV0dXJuCiAgICBpZiAoc25hcHNob3QubGltaXQgPT09IC0xKSBzbmFwc2hvdC5saW1pdCA9IDAKICAgIHRoaXMub3V0Z29pbmcuYnJvYWRjYXN0KEV4dGVuc2lvbi5lbmNvZGUoeyBpdGVyYXRvcjogc25hcHNob3QgfSkpCiAgfQoKICBvbm1lc3NhZ2UgKGJ1ZiwgZnJvbSkgewogICAgLy8gVE9ETzogaGFuZGxlIG1heCBhY3RpdmUgZXh0ZW5zaW9uIG1lc3NhZ2VzCiAgICAvLyB0aGlzLmFjdGl2ZSsrCgogICAgY29uc3QgbWVzc2FnZSA9IGRlY29kZShidWYpCiAgICBpZiAoIW1lc3NhZ2UpIHJldHVybgoKICAgIGlmIChtZXNzYWdlLmNhY2hlKSB0aGlzLm9uY2FjaGUobWVzc2FnZS5jYWNoZSwgZnJvbSkKICAgIGlmIChtZXNzYWdlLmdldCkgdGhpcy5vbmdldChtZXNzYWdlLmdldCwgZnJvbSkKICAgIGlmIChtZXNzYWdlLml0ZXJhdG9yKSB0aGlzLm9uaXRlcmF0b3IobWVzc2FnZS5pdGVyYXRvciwgZnJvbSkKICB9CgogIG9uY2FjaGUgKG1lc3NhZ2UsIGZyb20pIHsKICAgIGlmICghbWVzc2FnZS5ibG9ja3MubGVuZ3RoKSByZXR1cm4KICAgIHRoaXMuZGIuY29yZS5kb3dubG9hZChtZXNzYWdlKQogIH0KCiAgb25nZXQgKG1lc3NhZ2UsIGZyb20pIHsKICAgIGlmICghbWVzc2FnZS52ZXJzaW9uIHx8IG1lc3NhZ2UudmVyc2lvbiA+IHRoaXMuZGIudmVyc2lvbikgcmV0dXJuCgogICAgY29uc3QgYiA9IG5ldyBCYXRjaCh0aGlzLm91dGdvaW5nLCBmcm9tKQogICAgY29uc3QgZGIgPSB0aGlzLmRiLmNoZWNrb3V0KG1lc3NhZ2UudmVyc2lvbikKCiAgICBkYi5nZXQobWVzc2FnZS5rZXksIHsgZXh0ZW5zaW9uOiBmYWxzZSwgd2FpdDogZmFsc2UsIHVwZGF0ZTogZmFsc2UsIG9uc2VxIH0pLnRoZW4oZG9uZSwgZG9uZSkKCiAgICBmdW5jdGlvbiBkb25lICgpIHsKICAgICAgZGIuY2xvc2UoKS5jYXRjaChub29wKQogICAgICBiLnNlbmQoKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uc2VxIChzZXEpIHsKICAgICAgYi5wdXNoKHNlcSkKICAgIH0KICB9CgogIGFzeW5jIG9uaXRlcmF0b3IgKG1lc3NhZ2UsIGZyb20pIHsKICAgIGlmICghbWVzc2FnZS52ZXJzaW9uIHx8IG1lc3NhZ2UudmVyc2lvbiA+IHRoaXMuZGIudmVyc2lvbikgcmV0dXJuCgogICAgY29uc3QgYiA9IG5ldyBCYXRjaCh0aGlzLm91dGdvaW5nLCBmcm9tKQogICAgY29uc3Qgc2VxcyA9IG5ldyBTZXQoKQoKICAgIGxldCBza2lwID0gbWVzc2FnZS5jaGVja3BvaW50Lmxlbmd0aAogICAgbGV0IHdvcmsgPSAwCgogICAgY29uc3QgZGIgPSB0aGlzLmRiLmNoZWNrb3V0KG1lc3NhZ2UudmVyc2lvbikKICAgIGNvbnN0IGl0ZSA9IGRiLmNyZWF0ZVJhbmdlSXRlcmF0b3IoewogICAgICAuLi5tZXNzYWdlLAogICAgICB3YWl0OiBmYWxzZSwKICAgICAgZXh0ZW5zaW9uOiBmYWxzZSwKICAgICAgdXBkYXRlOiBmYWxzZSwKICAgICAgbGltaXQ6IG1lc3NhZ2UubGltaXQgPT09IDAgPyAtMSA6IG1lc3NhZ2UubGltaXQsCiAgICAgIG9uc2VxIChzZXEpIHsKICAgICAgICBpZiAoc2tpcCAmJiBza2lwLS0pIHJldHVybgogICAgICAgIGlmIChzZXFzLmhhcyhzZXEpKSByZXR1cm4KICAgICAgICB3b3JrKysKICAgICAgICBzZXFzLmFkZChzZXEpCiAgICAgICAgYi5wdXNoKHNlcSkKICAgICAgfQogICAgfSkKCiAgICB0cnkgewogICAgICBhd2FpdCBpdGUub3BlbigpCiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bm1vZGlmaWVkLWxvb3AtY29uZGl0aW9uCiAgICAgIHdoaWxlICh3b3JrIDwgTUFYX0FDVElWRV9CQVRDSCkgewogICAgICAgIGlmICghKGF3YWl0IGl0ZS5uZXh0KCkpKSBicmVhawogICAgICB9CiAgICB9IGNhdGNoIChfKSB7CiAgICAgIC8vIGRvIG5vdGhpbmcKICAgIH0gZmluYWxseSB7CiAgICAgIGl0ZS5jbG9zZSgpLmNhdGNoKG5vb3ApCiAgICAgIGRiLmNsb3NlKCkuY2F0Y2gobm9vcCkKICAgICAgYi5zZW5kKCkKICAgIH0KICB9CgogIHN0YXRpYyByZWdpc3RlciAoZGIpIHsKICAgIGNvbnN0IGUgPSBuZXcgdGhpcyhkYikKICAgIGUub3V0Z29pbmcgPSBkYi5jb3JlLnJlZ2lzdGVyRXh0ZW5zaW9uKCdoeXBlcmJlZScsIGUpCiAgICByZXR1cm4gZQogIH0KfQoKSHlwZXJiZWVFeHRlbnNpb24uQkFUQ0hfU0laRSA9IE1BWF9QQVNTSVZFX0JBVENICgptb2R1bGUuZXhwb3J0cyA9IEh5cGVyYmVlRXh0ZW5zaW9uCgpmdW5jdGlvbiBkZWNvZGUgKGJ1ZikgewogIHRyeSB7CiAgICByZXR1cm4gRXh0ZW5zaW9uLmRlY29kZShidWYpCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gbnVsbAogIH0KfQoKZnVuY3Rpb24gbm9vcCAoKSB7fQovLyBUaGlzIGZpbGUgaXMgYXV0byBnZW5lcmF0ZWQgYnkgdGhlIHByb3RvY29sLWJ1ZmZlcnMgY29tcGlsZXIKCi8qIGVzbGludC1kaXNhYmxlIHF1b3RlcyAqLwovKiBlc2xpbnQtZGlzYWJsZSBpbmRlbnQgKi8KLyogZXNsaW50LWRpc2FibGUgbm8tcmVkZWNsYXJlICovCi8qIGVzbGludC1kaXNhYmxlIGNhbWVsY2FzZSAqLwovKiBlc2xpbnQtZGlzYWJsZSBuby12YXIgKi8KCi8vIFJlbWVtYmVyIHRvIGBucG0gaW5zdGFsbCAtLXNhdmUgcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3NgCnZhciBlbmNvZGluZ3MgPSByZXF1aXJlKCdwcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncycpCnZhciBiNGEgPSByZXF1aXJlKCdiNGEnKQp2YXIgdmFyaW50ID0gZW5jb2RpbmdzLnZhcmludAp2YXIgc2tpcCA9IGVuY29kaW5ncy5za2lwCgp2YXIgWW9sb0luZGV4ID0gZXhwb3J0cy5Zb2xvSW5kZXggPSB7CiAgYnVmZmVyOiB0cnVlLAogIGVuY29kaW5nTGVuZ3RoOiBudWxsLAogIGVuY29kZTogbnVsbCwKICBkZWNvZGU6IG51bGwKfQoKdmFyIEhlYWRlciA9IGV4cG9ydHMuSGVhZGVyID0gewogIGJ1ZmZlcjogdHJ1ZSwKICBlbmNvZGluZ0xlbmd0aDogbnVsbCwKICBlbmNvZGU6IG51bGwsCiAgZGVjb2RlOiBudWxsCn0KCnZhciBOb2RlID0gZXhwb3J0cy5Ob2RlID0gewogIGJ1ZmZlcjogdHJ1ZSwKICBlbmNvZGluZ0xlbmd0aDogbnVsbCwKICBlbmNvZGU6IG51bGwsCiAgZGVjb2RlOiBudWxsCn0KCnZhciBFeHRlbnNpb24gPSBleHBvcnRzLkV4dGVuc2lvbiA9IHsKICBidWZmZXI6IHRydWUsCiAgZW5jb2RpbmdMZW5ndGg6IG51bGwsCiAgZW5jb2RlOiBudWxsLAogIGRlY29kZTogbnVsbAp9CgpkZWZpbmVZb2xvSW5kZXgoKQpkZWZpbmVIZWFkZXIoKQpkZWZpbmVOb2RlKCkKZGVmaW5lRXh0ZW5zaW9uKCkKCmZ1bmN0aW9uIGRlZmluZVlvbG9JbmRleCAoKSB7CiAgdmFyIExldmVsID0gWW9sb0luZGV4LkxldmVsID0gewogICAgYnVmZmVyOiB0cnVlLAogICAgZW5jb2RpbmdMZW5ndGg6IG51bGwsCiAgICBlbmNvZGU6IG51bGwsCiAgICBkZWNvZGU6IG51bGwKICB9CgogIGRlZmluZUxldmVsKCkKCiAgZnVuY3Rpb24gZGVmaW5lTGV2ZWwgKCkgewogICAgTGV2ZWwuZW5jb2RpbmdMZW5ndGggPSBlbmNvZGluZ0xlbmd0aAogICAgTGV2ZWwuZW5jb2RlID0gZW5jb2RlCiAgICBMZXZlbC5kZWNvZGUgPSBkZWNvZGUKCiAgICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAob2JqKSB7CiAgICAgIHZhciBsZW5ndGggPSAwCiAgICAgIGlmIChkZWZpbmVkKG9iai5rZXlzKSkgewogICAgICAgIHZhciBwYWNrZWRMZW4gPSAwCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmoua2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5rZXlzW2ldKSkgY29udGludWUKICAgICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5rZXlzW2ldKQogICAgICAgICAgcGFja2VkTGVuICs9IGxlbgogICAgICAgIH0KICAgICAgICBpZiAocGFja2VkTGVuKSB7CiAgICAgICAgICBsZW5ndGggKz0gMSArIHBhY2tlZExlbiArIHZhcmludC5lbmNvZGluZ0xlbmd0aChwYWNrZWRMZW4pCiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5jaGlsZHJlbikpIHsKICAgICAgICB2YXIgcGFja2VkTGVuID0gMAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmNoaWxkcmVuW2ldKSkgY29udGludWUKICAgICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5jaGlsZHJlbltpXSkKICAgICAgICAgIHBhY2tlZExlbiArPSBsZW4KICAgICAgICB9CiAgICAgICAgaWYgKHBhY2tlZExlbikgewogICAgICAgICAgbGVuZ3RoICs9IDEgKyBwYWNrZWRMZW4gKyB2YXJpbnQuZW5jb2RpbmdMZW5ndGgocGFja2VkTGVuKQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbGVuZ3RoCiAgICB9CgogICAgZnVuY3Rpb24gZW5jb2RlIChvYmosIGJ1Ziwgb2Zmc2V0KSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghYnVmKSBidWYgPSBiNGEuYWxsb2NVbnNhZmUoZW5jb2RpbmdMZW5ndGgob2JqKSkKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICBpZiAoZGVmaW5lZChvYmoua2V5cykpIHsKICAgICAgICB2YXIgcGFja2VkTGVuID0gMAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmoua2V5c1tpXSkpIGNvbnRpbnVlCiAgICAgICAgICBwYWNrZWRMZW4gKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGluZ0xlbmd0aChvYmoua2V5c1tpXSkKICAgICAgICB9CiAgICAgICAgaWYgKHBhY2tlZExlbikgewogICAgICAgICAgYnVmW29mZnNldCsrXSA9IDEwCiAgICAgICAgICB2YXJpbnQuZW5jb2RlKHBhY2tlZExlbiwgYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5rZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmtleXNbaV0pKSBjb250aW51ZQogICAgICAgICAgZW5jb2RpbmdzLnZhcmludC5lbmNvZGUob2JqLmtleXNbaV0sIGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5jaGlsZHJlbikpIHsKICAgICAgICB2YXIgcGFja2VkTGVuID0gMAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmNoaWxkcmVuW2ldKSkgY29udGludWUKICAgICAgICAgIHBhY2tlZExlbiArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5jaGlsZHJlbltpXSkKICAgICAgICB9CiAgICAgICAgaWYgKHBhY2tlZExlbikgewogICAgICAgICAgYnVmW29mZnNldCsrXSA9IDE4CiAgICAgICAgICB2YXJpbnQuZW5jb2RlKHBhY2tlZExlbiwgYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5jaGlsZHJlbltpXSkpIGNvbnRpbnVlCiAgICAgICAgICBlbmNvZGluZ3MudmFyaW50LmVuY29kZShvYmouY2hpbGRyZW5baV0sIGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgICAgfQogICAgICB9CiAgICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICByZXR1cm4gYnVmCiAgICB9CgogICAgZnVuY3Rpb24gZGVjb2RlIChidWYsIG9mZnNldCwgZW5kKSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghZW5kKSBlbmQgPSBidWYubGVuZ3RoCiAgICAgIGlmICghKGVuZCA8PSBidWYubGVuZ3RoICYmIG9mZnNldCA8PSBidWYubGVuZ3RoKSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICB2YXIgb2JqID0gewogICAgICAgIGtleXM6IFtdLAogICAgICAgIGNoaWxkcmVuOiBbXQogICAgICB9CiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgaWYgKGVuZCA8PSBvZmZzZXQpIHsKICAgICAgICAgIGRlY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICAgICAgcmV0dXJuIG9iagogICAgICAgIH0KICAgICAgICB2YXIgcHJlZml4ID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIHZhciB0YWcgPSBwcmVmaXggPj4gMwogICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICB2YXIgcGFja2VkRW5kID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBwYWNrZWRFbmQgKz0gb2Zmc2V0CiAgICAgICAgICB3aGlsZSAob2Zmc2V0IDwgcGFja2VkRW5kKSB7CiAgICAgICAgICAgIG9iai5rZXlzLnB1c2goZW5jb2RpbmdzLnZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpKQogICAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICB2YXIgcGFja2VkRW5kID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBwYWNrZWRFbmQgKz0gb2Zmc2V0CiAgICAgICAgICB3aGlsZSAob2Zmc2V0IDwgcGFja2VkRW5kKSB7CiAgICAgICAgICAgIG9iai5jaGlsZHJlbi5wdXNoKGVuY29kaW5ncy52YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KSkKICAgICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICB9CiAgICAgICAgICBicmVhawogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIG9mZnNldCA9IHNraXAocHJlZml4ICYgNywgYnVmLCBvZmZzZXQpCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBZb2xvSW5kZXguZW5jb2RpbmdMZW5ndGggPSBlbmNvZGluZ0xlbmd0aAogIFlvbG9JbmRleC5lbmNvZGUgPSBlbmNvZGUKICBZb2xvSW5kZXguZGVjb2RlID0gZGVjb2RlCgogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChvYmopIHsKICAgIHZhciBsZW5ndGggPSAwCiAgICBpZiAoZGVmaW5lZChvYmoubGV2ZWxzKSkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5sZXZlbHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoIWRlZmluZWQob2JqLmxldmVsc1tpXSkpIGNvbnRpbnVlCiAgICAgICAgdmFyIGxlbiA9IExldmVsLmVuY29kaW5nTGVuZ3RoKG9iai5sZXZlbHNbaV0pCiAgICAgICAgbGVuZ3RoICs9IHZhcmludC5lbmNvZGluZ0xlbmd0aChsZW4pCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgfQogICAgcmV0dXJuIGxlbmd0aAogIH0KCiAgZnVuY3Rpb24gZW5jb2RlIChvYmosIGJ1Ziwgb2Zmc2V0KSB7CiAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgaWYgKCFidWYpIGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShlbmNvZGluZ0xlbmd0aChvYmopKQogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgaWYgKGRlZmluZWQob2JqLmxldmVscykpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmoubGV2ZWxzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5sZXZlbHNbaV0pKSBjb250aW51ZQogICAgICAgIGJ1ZltvZmZzZXQrK10gPSAxMAogICAgICAgIHZhcmludC5lbmNvZGUoTGV2ZWwuZW5jb2RpbmdMZW5ndGgob2JqLmxldmVsc1tpXSksIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgICAgTGV2ZWwuZW5jb2RlKG9iai5sZXZlbHNbaV0sIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBMZXZlbC5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgfQogICAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICByZXR1cm4gYnVmCiAgfQoKICBmdW5jdGlvbiBkZWNvZGUgKGJ1Ziwgb2Zmc2V0LCBlbmQpIHsKICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICBpZiAoIWVuZCkgZW5kID0gYnVmLmxlbmd0aAogICAgaWYgKCEoZW5kIDw9IGJ1Zi5sZW5ndGggJiYgb2Zmc2V0IDw9IGJ1Zi5sZW5ndGgpKSB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgbWVzc2FnZSBpcyBub3QgdmFsaWQiKQogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgdmFyIG9iaiA9IHsKICAgICAgbGV2ZWxzOiBbXQogICAgfQogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKGVuZCA8PSBvZmZzZXQpIHsKICAgICAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgICByZXR1cm4gb2JqCiAgICAgIH0KICAgICAgdmFyIHByZWZpeCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgIHZhciB0YWcgPSBwcmVmaXggPj4gMwogICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgIGNhc2UgMToKICAgICAgICB2YXIgbGVuID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIG9iai5sZXZlbHMucHVzaChMZXZlbC5kZWNvZGUoYnVmLCBvZmZzZXQsIG9mZnNldCArIGxlbikpCiAgICAgICAgb2Zmc2V0ICs9IExldmVsLmRlY29kZS5ieXRlcwogICAgICAgIGJyZWFrCiAgICAgICAgZGVmYXVsdDoKICAgICAgICBvZmZzZXQgPSBza2lwKHByZWZpeCAmIDcsIGJ1Ziwgb2Zmc2V0KQogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBkZWZpbmVIZWFkZXIgKCkgewogIHZhciBNZXRhZGF0YSA9IEhlYWRlci5NZXRhZGF0YSA9IHsKICAgIGJ1ZmZlcjogdHJ1ZSwKICAgIGVuY29kaW5nTGVuZ3RoOiBudWxsLAogICAgZW5jb2RlOiBudWxsLAogICAgZGVjb2RlOiBudWxsCiAgfQoKICBkZWZpbmVNZXRhZGF0YSgpCgogIGZ1bmN0aW9uIGRlZmluZU1ldGFkYXRhICgpIHsKICAgIE1ldGFkYXRhLmVuY29kaW5nTGVuZ3RoID0gZW5jb2RpbmdMZW5ndGgKICAgIE1ldGFkYXRhLmVuY29kZSA9IGVuY29kZQogICAgTWV0YWRhdGEuZGVjb2RlID0gZGVjb2RlCgogICAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKG9iaikgewogICAgICB2YXIgbGVuZ3RoID0gMAogICAgICBpZiAoZGVmaW5lZChvYmouY29udGVudEZlZWQpKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGluZ0xlbmd0aChvYmouY29udGVudEZlZWQpCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoudXNlckRhdGEpKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGluZ0xlbmd0aChvYmoudXNlckRhdGEpCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICByZXR1cm4gbGVuZ3RoCiAgICB9CgogICAgZnVuY3Rpb24gZW5jb2RlIChvYmosIGJ1Ziwgb2Zmc2V0KSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghYnVmKSBidWYgPSBiNGEuYWxsb2NVbnNhZmUoZW5jb2RpbmdMZW5ndGgob2JqKSkKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICBpZiAoZGVmaW5lZChvYmouY29udGVudEZlZWQpKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDEwCiAgICAgICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmouY29udGVudEZlZWQsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLnVzZXJEYXRhKSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSAxOAogICAgICAgIGVuY29kaW5ncy5ieXRlcy5lbmNvZGUob2JqLnVzZXJEYXRhLCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICByZXR1cm4gYnVmCiAgICB9CgogICAgZnVuY3Rpb24gZGVjb2RlIChidWYsIG9mZnNldCwgZW5kKSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghZW5kKSBlbmQgPSBidWYubGVuZ3RoCiAgICAgIGlmICghKGVuZCA8PSBidWYubGVuZ3RoICYmIG9mZnNldCA8PSBidWYubGVuZ3RoKSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICB2YXIgb2JqID0gewogICAgICAgIGNvbnRlbnRGZWVkOiBudWxsLAogICAgICAgIHVzZXJEYXRhOiBudWxsCiAgICAgIH0KICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBpZiAoZW5kIDw9IG9mZnNldCkgewogICAgICAgICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgICAgICByZXR1cm4gb2JqCiAgICAgICAgfQogICAgICAgIHZhciBwcmVmaXggPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgdmFyIHRhZyA9IHByZWZpeCA+PiAzCiAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgIG9iai5jb250ZW50RmVlZCA9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZS5ieXRlcwogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgIG9iai51c2VyRGF0YSA9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZS5ieXRlcwogICAgICAgICAgYnJlYWsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBvZmZzZXQgPSBza2lwKHByZWZpeCAmIDcsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgSGVhZGVyLmVuY29kaW5nTGVuZ3RoID0gZW5jb2RpbmdMZW5ndGgKICBIZWFkZXIuZW5jb2RlID0gZW5jb2RlCiAgSGVhZGVyLmRlY29kZSA9IGRlY29kZQoKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAob2JqKSB7CiAgICB2YXIgbGVuZ3RoID0gMAogICAgaWYgKCFkZWZpbmVkKG9iai5wcm90b2NvbCkpIHRocm93IG5ldyBFcnJvcigicHJvdG9jb2wgaXMgcmVxdWlyZWQiKQogICAgdmFyIGxlbiA9IGVuY29kaW5ncy5zdHJpbmcuZW5jb2RpbmdMZW5ndGgob2JqLnByb3RvY29sKQogICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgIGlmIChkZWZpbmVkKG9iai5tZXRhZGF0YSkpIHsKICAgICAgdmFyIGxlbiA9IE1ldGFkYXRhLmVuY29kaW5nTGVuZ3RoKG9iai5tZXRhZGF0YSkKICAgICAgbGVuZ3RoICs9IHZhcmludC5lbmNvZGluZ0xlbmd0aChsZW4pCiAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICB9CiAgICByZXR1cm4gbGVuZ3RoCiAgfQoKICBmdW5jdGlvbiBlbmNvZGUgKG9iaiwgYnVmLCBvZmZzZXQpIHsKICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICBpZiAoIWJ1ZikgYnVmID0gYjRhLmFsbG9jVW5zYWZlKGVuY29kaW5nTGVuZ3RoKG9iaikpCiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICBpZiAoIWRlZmluZWQob2JqLnByb3RvY29sKSkgdGhyb3cgbmV3IEVycm9yKCJwcm90b2NvbCBpcyByZXF1aXJlZCIpCiAgICBidWZbb2Zmc2V0KytdID0gMTAKICAgIGVuY29kaW5ncy5zdHJpbmcuZW5jb2RlKG9iai5wcm90b2NvbCwgYnVmLCBvZmZzZXQpCiAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnN0cmluZy5lbmNvZGUuYnl0ZXMKICAgIGlmIChkZWZpbmVkKG9iai5tZXRhZGF0YSkpIHsKICAgICAgYnVmW29mZnNldCsrXSA9IDE4CiAgICAgIHZhcmludC5lbmNvZGUoTWV0YWRhdGEuZW5jb2RpbmdMZW5ndGgob2JqLm1ldGFkYXRhKSwgYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgIE1ldGFkYXRhLmVuY29kZShvYmoubWV0YWRhdGEsIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gTWV0YWRhdGEuZW5jb2RlLmJ5dGVzCiAgICB9CiAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgIHJldHVybiBidWYKICB9CgogIGZ1bmN0aW9uIGRlY29kZSAoYnVmLCBvZmZzZXQsIGVuZCkgewogICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgIGlmICghZW5kKSBlbmQgPSBidWYubGVuZ3RoCiAgICBpZiAoIShlbmQgPD0gYnVmLmxlbmd0aCAmJiBvZmZzZXQgPD0gYnVmLmxlbmd0aCkpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICB2YXIgb2JqID0gewogICAgICBwcm90b2NvbDogIiIsCiAgICAgIG1ldGFkYXRhOiBudWxsCiAgICB9CiAgICB2YXIgZm91bmQwID0gZmFsc2UKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmIChlbmQgPD0gb2Zmc2V0KSB7CiAgICAgICAgaWYgKCFmb3VuZDApIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICAgICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgICAgcmV0dXJuIG9iagogICAgICB9CiAgICAgIHZhciBwcmVmaXggPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICB2YXIgdGFnID0gcHJlZml4ID4+IDMKICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICBjYXNlIDE6CiAgICAgICAgb2JqLnByb3RvY29sID0gZW5jb2RpbmdzLnN0cmluZy5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5zdHJpbmcuZGVjb2RlLmJ5dGVzCiAgICAgICAgZm91bmQwID0gdHJ1ZQogICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAyOgogICAgICAgIHZhciBsZW4gPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgb2JqLm1ldGFkYXRhID0gTWV0YWRhdGEuZGVjb2RlKGJ1Ziwgb2Zmc2V0LCBvZmZzZXQgKyBsZW4pCiAgICAgICAgb2Zmc2V0ICs9IE1ldGFkYXRhLmRlY29kZS5ieXRlcwogICAgICAgIGJyZWFrCiAgICAgICAgZGVmYXVsdDoKICAgICAgICBvZmZzZXQgPSBza2lwKHByZWZpeCAmIDcsIGJ1Ziwgb2Zmc2V0KQogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBkZWZpbmVOb2RlICgpIHsKICBOb2RlLmVuY29kaW5nTGVuZ3RoID0gZW5jb2RpbmdMZW5ndGgKICBOb2RlLmVuY29kZSA9IGVuY29kZQogIE5vZGUuZGVjb2RlID0gZGVjb2RlCgogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChvYmopIHsKICAgIHZhciBsZW5ndGggPSAwCiAgICBpZiAoIWRlZmluZWQob2JqLmluZGV4KSkgdGhyb3cgbmV3IEVycm9yKCJpbmRleCBpcyByZXF1aXJlZCIpCiAgICB2YXIgbGVuID0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kaW5nTGVuZ3RoKG9iai5pbmRleCkKICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICBpZiAoIWRlZmluZWQob2JqLmtleSkpIHRocm93IG5ldyBFcnJvcigia2V5IGlzIHJlcXVpcmVkIikKICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLmtleSkKICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICBpZiAoZGVmaW5lZChvYmoudmFsdWUpKSB7CiAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLnZhbHVlKQogICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgfQogICAgcmV0dXJuIGxlbmd0aAogIH0KCiAgZnVuY3Rpb24gZW5jb2RlIChvYmosIGJ1Ziwgb2Zmc2V0KSB7CiAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgaWYgKCFidWYpIGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShlbmNvZGluZ0xlbmd0aChvYmopKQogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgaWYgKCFkZWZpbmVkKG9iai5pbmRleCkpIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgcmVxdWlyZWQiKQogICAgYnVmW29mZnNldCsrXSA9IDEwCiAgICBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlKG9iai5pbmRleCwgYnVmLCBvZmZzZXQpCiAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgaWYgKCFkZWZpbmVkKG9iai5rZXkpKSB0aHJvdyBuZXcgRXJyb3IoImtleSBpcyByZXF1aXJlZCIpCiAgICBidWZbb2Zmc2V0KytdID0gMTgKICAgIGVuY29kaW5ncy5ieXRlcy5lbmNvZGUob2JqLmtleSwgYnVmLCBvZmZzZXQpCiAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgaWYgKGRlZmluZWQob2JqLnZhbHVlKSkgewogICAgICBidWZbb2Zmc2V0KytdID0gMjYKICAgICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmoudmFsdWUsIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgfQogICAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICByZXR1cm4gYnVmCiAgfQoKICBmdW5jdGlvbiBkZWNvZGUgKGJ1Ziwgb2Zmc2V0LCBlbmQpIHsKICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICBpZiAoIWVuZCkgZW5kID0gYnVmLmxlbmd0aAogICAgaWYgKCEoZW5kIDw9IGJ1Zi5sZW5ndGggJiYgb2Zmc2V0IDw9IGJ1Zi5sZW5ndGgpKSB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgbWVzc2FnZSBpcyBub3QgdmFsaWQiKQogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgdmFyIG9iaiA9IHsKICAgICAgaW5kZXg6IG51bGwsCiAgICAgIGtleTogbnVsbCwKICAgICAgdmFsdWU6IG51bGwKICAgIH0KICAgIHZhciBmb3VuZDAgPSBmYWxzZQogICAgdmFyIGZvdW5kMSA9IGZhbHNlCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAoZW5kIDw9IG9mZnNldCkgewogICAgICAgIGlmICghZm91bmQwIHx8ICFmb3VuZDEpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICAgICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgICAgcmV0dXJuIG9iagogICAgICB9CiAgICAgIHZhciBwcmVmaXggPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICB2YXIgdGFnID0gcHJlZml4ID4+IDMKICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICBjYXNlIDE6CiAgICAgICAgb2JqLmluZGV4ID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZS5ieXRlcwogICAgICAgIGZvdW5kMCA9IHRydWUKICAgICAgICBicmVhawogICAgICAgIGNhc2UgMjoKICAgICAgICBvYmoua2V5ID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZS5ieXRlcwogICAgICAgIGZvdW5kMSA9IHRydWUKICAgICAgICBicmVhawogICAgICAgIGNhc2UgMzoKICAgICAgICBvYmoudmFsdWUgPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlLmJ5dGVzCiAgICAgICAgYnJlYWsKICAgICAgICBkZWZhdWx0OgogICAgICAgIG9mZnNldCA9IHNraXAocHJlZml4ICYgNywgYnVmLCBvZmZzZXQpCiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGRlZmluZUV4dGVuc2lvbiAoKSB7CiAgdmFyIEdldCA9IEV4dGVuc2lvbi5HZXQgPSB7CiAgICBidWZmZXI6IHRydWUsCiAgICBlbmNvZGluZ0xlbmd0aDogbnVsbCwKICAgIGVuY29kZTogbnVsbCwKICAgIGRlY29kZTogbnVsbAogIH0KCiAgdmFyIEl0ZXJhdG9yID0gRXh0ZW5zaW9uLkl0ZXJhdG9yID0gewogICAgYnVmZmVyOiB0cnVlLAogICAgZW5jb2RpbmdMZW5ndGg6IG51bGwsCiAgICBlbmNvZGU6IG51bGwsCiAgICBkZWNvZGU6IG51bGwKICB9CgogIHZhciBDYWNoZSA9IEV4dGVuc2lvbi5DYWNoZSA9IHsKICAgIGJ1ZmZlcjogdHJ1ZSwKICAgIGVuY29kaW5nTGVuZ3RoOiBudWxsLAogICAgZW5jb2RlOiBudWxsLAogICAgZGVjb2RlOiBudWxsCiAgfQoKICBkZWZpbmVHZXQoKQogIGRlZmluZUl0ZXJhdG9yKCkKICBkZWZpbmVDYWNoZSgpCgogIGZ1bmN0aW9uIGRlZmluZUdldCAoKSB7CiAgICBHZXQuZW5jb2RpbmdMZW5ndGggPSBlbmNvZGluZ0xlbmd0aAogICAgR2V0LmVuY29kZSA9IGVuY29kZQogICAgR2V0LmRlY29kZSA9IGRlY29kZQoKICAgIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChvYmopIHsKICAgICAgdmFyIGxlbmd0aCA9IDAKICAgICAgaWYgKGRlZmluZWQob2JqLnZlcnNpb24pKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLnZlcnNpb24pCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoua2V5KSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLmtleSkKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIHJldHVybiBsZW5ndGgKICAgIH0KCiAgICBmdW5jdGlvbiBlbmNvZGUgKG9iaiwgYnVmLCBvZmZzZXQpIHsKICAgICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgICAgaWYgKCFidWYpIGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShlbmNvZGluZ0xlbmd0aChvYmopKQogICAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICAgIGlmIChkZWZpbmVkKG9iai52ZXJzaW9uKSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSA4CiAgICAgICAgZW5jb2RpbmdzLnZhcmludC5lbmNvZGUob2JqLnZlcnNpb24sIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5rZXkpKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDE4CiAgICAgICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmoua2V5LCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICByZXR1cm4gYnVmCiAgICB9CgogICAgZnVuY3Rpb24gZGVjb2RlIChidWYsIG9mZnNldCwgZW5kKSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghZW5kKSBlbmQgPSBidWYubGVuZ3RoCiAgICAgIGlmICghKGVuZCA8PSBidWYubGVuZ3RoICYmIG9mZnNldCA8PSBidWYubGVuZ3RoKSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICB2YXIgb2JqID0gewogICAgICAgIHZlcnNpb246IDAsCiAgICAgICAga2V5OiBudWxsCiAgICAgIH0KICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBpZiAoZW5kIDw9IG9mZnNldCkgewogICAgICAgICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgICAgICByZXR1cm4gb2JqCiAgICAgICAgfQogICAgICAgIHZhciBwcmVmaXggPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgdmFyIHRhZyA9IHByZWZpeCA+PiAzCiAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgIG9iai52ZXJzaW9uID0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICBvYmoua2V5ID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBicmVhawogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIG9mZnNldCA9IHNraXAocHJlZml4ICYgNywgYnVmLCBvZmZzZXQpCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkZWZpbmVJdGVyYXRvciAoKSB7CiAgICBJdGVyYXRvci5lbmNvZGluZ0xlbmd0aCA9IGVuY29kaW5nTGVuZ3RoCiAgICBJdGVyYXRvci5lbmNvZGUgPSBlbmNvZGUKICAgIEl0ZXJhdG9yLmRlY29kZSA9IGRlY29kZQoKICAgIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChvYmopIHsKICAgICAgdmFyIGxlbmd0aCA9IDAKICAgICAgaWYgKGRlZmluZWQob2JqLnZlcnNpb24pKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLnZlcnNpb24pCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmouZ3RlKSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLmd0ZSkKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5ndCkpIHsKICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kaW5nTGVuZ3RoKG9iai5ndCkKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5sdGUpKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGluZ0xlbmd0aChvYmoubHRlKQogICAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmx0KSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLmx0KQogICAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmxpbWl0KSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5saW1pdCkKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5yZXZlcnNlKSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYm9vbC5lbmNvZGluZ0xlbmd0aChvYmoucmV2ZXJzZSkKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5jaGVja3BvaW50KSkgewogICAgICAgIHZhciBwYWNrZWRMZW4gPSAwCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouY2hlY2twb2ludC5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5jaGVja3BvaW50W2ldKSkgY29udGludWUKICAgICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5jaGVja3BvaW50W2ldKQogICAgICAgICAgcGFja2VkTGVuICs9IGxlbgogICAgICAgIH0KICAgICAgICBpZiAocGFja2VkTGVuKSB7CiAgICAgICAgICBsZW5ndGggKz0gMSArIHBhY2tlZExlbiArIHZhcmludC5lbmNvZGluZ0xlbmd0aChwYWNrZWRMZW4pCiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBsZW5ndGgKICAgIH0KCiAgICBmdW5jdGlvbiBlbmNvZGUgKG9iaiwgYnVmLCBvZmZzZXQpIHsKICAgICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgICAgaWYgKCFidWYpIGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShlbmNvZGluZ0xlbmd0aChvYmopKQogICAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICAgIGlmIChkZWZpbmVkKG9iai52ZXJzaW9uKSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSA4CiAgICAgICAgZW5jb2RpbmdzLnZhcmludC5lbmNvZGUob2JqLnZlcnNpb24sIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5ndGUpKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDE4CiAgICAgICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmouZ3RlLCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5ndCkpIHsKICAgICAgICBidWZbb2Zmc2V0KytdID0gMjYKICAgICAgICBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlKG9iai5ndCwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoubHRlKSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSAzNAogICAgICAgIGVuY29kaW5ncy5ieXRlcy5lbmNvZGUob2JqLmx0ZSwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoubHQpKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDQyCiAgICAgICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmoubHQsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmxpbWl0KSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSA0OAogICAgICAgIGVuY29kaW5ncy52YXJpbnQuZW5jb2RlKG9iai5saW1pdCwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLnJldmVyc2UpKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDU2CiAgICAgICAgZW5jb2RpbmdzLmJvb2wuZW5jb2RlKG9iai5yZXZlcnNlLCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJvb2wuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmNoZWNrcG9pbnQpKSB7CiAgICAgICAgdmFyIHBhY2tlZExlbiA9IDAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5jaGVja3BvaW50Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmNoZWNrcG9pbnRbaV0pKSBjb250aW51ZQogICAgICAgICAgcGFja2VkTGVuICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLmNoZWNrcG9pbnRbaV0pCiAgICAgICAgfQogICAgICAgIGlmIChwYWNrZWRMZW4pIHsKICAgICAgICAgIGJ1ZltvZmZzZXQrK10gPSA2NgogICAgICAgICAgdmFyaW50LmVuY29kZShwYWNrZWRMZW4sIGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouY2hlY2twb2ludC5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5jaGVja3BvaW50W2ldKSkgY29udGludWUKICAgICAgICAgIGVuY29kaW5ncy52YXJpbnQuZW5jb2RlKG9iai5jaGVja3BvaW50W2ldLCBidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kZS5ieXRlcwogICAgICAgIH0KICAgICAgfQogICAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgcmV0dXJuIGJ1ZgogICAgfQoKICAgIGZ1bmN0aW9uIGRlY29kZSAoYnVmLCBvZmZzZXQsIGVuZCkgewogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgICBpZiAoIWVuZCkgZW5kID0gYnVmLmxlbmd0aAogICAgICBpZiAoIShlbmQgPD0gYnVmLmxlbmd0aCAmJiBvZmZzZXQgPD0gYnVmLmxlbmd0aCkpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgICAgdmFyIG9iaiA9IHsKICAgICAgICB2ZXJzaW9uOiAwLAogICAgICAgIGd0ZTogbnVsbCwKICAgICAgICBndDogbnVsbCwKICAgICAgICBsdGU6IG51bGwsCiAgICAgICAgbHQ6IG51bGwsCiAgICAgICAgbGltaXQ6IDAsCiAgICAgICAgcmV2ZXJzZTogZmFsc2UsCiAgICAgICAgY2hlY2twb2ludDogW10KICAgICAgfQogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGlmIChlbmQgPD0gb2Zmc2V0KSB7CiAgICAgICAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgICAgIHJldHVybiBvYmoKICAgICAgICB9CiAgICAgICAgdmFyIHByZWZpeCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICB2YXIgdGFnID0gcHJlZml4ID4+IDMKICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgb2JqLnZlcnNpb24gPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgIG9iai5ndGUgPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICBvYmouZ3QgPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICBvYmoubHRlID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSA1OgogICAgICAgICAgb2JqLmx0ID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSA2OgogICAgICAgICAgb2JqLmxpbWl0ID0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICBvYmoucmV2ZXJzZSA9IGVuY29kaW5ncy5ib29sLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYm9vbC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICB2YXIgcGFja2VkRW5kID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBwYWNrZWRFbmQgKz0gb2Zmc2V0CiAgICAgICAgICB3aGlsZSAob2Zmc2V0IDwgcGFja2VkRW5kKSB7CiAgICAgICAgICAgIG9iai5jaGVja3BvaW50LnB1c2goZW5jb2RpbmdzLnZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpKQogICAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgb2Zmc2V0ID0gc2tpcChwcmVmaXggJiA3LCBidWYsIG9mZnNldCkKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGRlZmluZUNhY2hlICgpIHsKICAgIENhY2hlLmVuY29kaW5nTGVuZ3RoID0gZW5jb2RpbmdMZW5ndGgKICAgIENhY2hlLmVuY29kZSA9IGVuY29kZQogICAgQ2FjaGUuZGVjb2RlID0gZGVjb2RlCgogICAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKG9iaikgewogICAgICB2YXIgbGVuZ3RoID0gMAogICAgICBpZiAoIWRlZmluZWQob2JqLnN0YXJ0KSkgdGhyb3cgbmV3IEVycm9yKCJzdGFydCBpcyByZXF1aXJlZCIpCiAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5zdGFydCkKICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgaWYgKCFkZWZpbmVkKG9iai5lbmQpKSB0aHJvdyBuZXcgRXJyb3IoImVuZCBpcyByZXF1aXJlZCIpCiAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5lbmQpCiAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIGlmIChkZWZpbmVkKG9iai5ibG9ja3MpKSB7CiAgICAgICAgdmFyIHBhY2tlZExlbiA9IDAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5ibG9ja3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmouYmxvY2tzW2ldKSkgY29udGludWUKICAgICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5ibG9ja3NbaV0pCiAgICAgICAgICBwYWNrZWRMZW4gKz0gbGVuCiAgICAgICAgfQogICAgICAgIGlmIChwYWNrZWRMZW4pIHsKICAgICAgICAgIGxlbmd0aCArPSAxICsgcGFja2VkTGVuICsgdmFyaW50LmVuY29kaW5nTGVuZ3RoKHBhY2tlZExlbikKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGxlbmd0aAogICAgfQoKICAgIGZ1bmN0aW9uIGVuY29kZSAob2JqLCBidWYsIG9mZnNldCkgewogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgICBpZiAoIWJ1ZikgYnVmID0gYjRhLmFsbG9jVW5zYWZlKGVuY29kaW5nTGVuZ3RoKG9iaikpCiAgICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgICAgaWYgKCFkZWZpbmVkKG9iai5zdGFydCkpIHRocm93IG5ldyBFcnJvcigic3RhcnQgaXMgcmVxdWlyZWQiKQogICAgICBidWZbb2Zmc2V0KytdID0gOAogICAgICBlbmNvZGluZ3MudmFyaW50LmVuY29kZShvYmouc3RhcnQsIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgaWYgKCFkZWZpbmVkKG9iai5lbmQpKSB0aHJvdyBuZXcgRXJyb3IoImVuZCBpcyByZXF1aXJlZCIpCiAgICAgIGJ1ZltvZmZzZXQrK10gPSAxNgogICAgICBlbmNvZGluZ3MudmFyaW50LmVuY29kZShvYmouZW5kLCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgIGlmIChkZWZpbmVkKG9iai5ibG9ja3MpKSB7CiAgICAgICAgdmFyIHBhY2tlZExlbiA9IDAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5ibG9ja3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmouYmxvY2tzW2ldKSkgY29udGludWUKICAgICAgICAgIHBhY2tlZExlbiArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5ibG9ja3NbaV0pCiAgICAgICAgfQogICAgICAgIGlmIChwYWNrZWRMZW4pIHsKICAgICAgICAgIGJ1ZltvZmZzZXQrK10gPSAyNgogICAgICAgICAgdmFyaW50LmVuY29kZShwYWNrZWRMZW4sIGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouYmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmJsb2Nrc1tpXSkpIGNvbnRpbnVlCiAgICAgICAgICBlbmNvZGluZ3MudmFyaW50LmVuY29kZShvYmouYmxvY2tzW2ldLCBidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kZS5ieXRlcwogICAgICAgIH0KICAgICAgfQogICAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgcmV0dXJuIGJ1ZgogICAgfQoKICAgIGZ1bmN0aW9uIGRlY29kZSAoYnVmLCBvZmZzZXQsIGVuZCkgewogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgICBpZiAoIWVuZCkgZW5kID0gYnVmLmxlbmd0aAogICAgICBpZiAoIShlbmQgPD0gYnVmLmxlbmd0aCAmJiBvZmZzZXQgPD0gYnVmLmxlbmd0aCkpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgICAgdmFyIG9iaiA9IHsKICAgICAgICBzdGFydDogMCwKICAgICAgICBlbmQ6IDAsCiAgICAgICAgYmxvY2tzOiBbXQogICAgICB9CiAgICAgIHZhciBmb3VuZDAgPSBmYWxzZQogICAgICB2YXIgZm91bmQxID0gZmFsc2UKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBpZiAoZW5kIDw9IG9mZnNldCkgewogICAgICAgICAgaWYgKCFmb3VuZDAgfHwgIWZvdW5kMSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgICAgICAgIGRlY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICAgICAgcmV0dXJuIG9iagogICAgICAgIH0KICAgICAgICB2YXIgcHJlZml4ID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIHZhciB0YWcgPSBwcmVmaXggPj4gMwogICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICBvYmouc3RhcnQgPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgZm91bmQwID0gdHJ1ZQogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgIG9iai5lbmQgPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgZm91bmQxID0gdHJ1ZQogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgIHZhciBwYWNrZWRFbmQgPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIHBhY2tlZEVuZCArPSBvZmZzZXQKICAgICAgICAgIHdoaWxlIChvZmZzZXQgPCBwYWNrZWRFbmQpIHsKICAgICAgICAgICAgb2JqLmJsb2Nrcy5wdXNoKGVuY29kaW5ncy52YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KSkKICAgICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICB9CiAgICAgICAgICBicmVhawogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIG9mZnNldCA9IHNraXAocHJlZml4ICYgNywgYnVmLCBvZmZzZXQpCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBFeHRlbnNpb24uZW5jb2RpbmdMZW5ndGggPSBlbmNvZGluZ0xlbmd0aAogIEV4dGVuc2lvbi5lbmNvZGUgPSBlbmNvZGUKICBFeHRlbnNpb24uZGVjb2RlID0gZGVjb2RlCgogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChvYmopIHsKICAgIHZhciBsZW5ndGggPSAwCiAgICBpZiAoZGVmaW5lZChvYmouY2FjaGUpKSB7CiAgICAgIHZhciBsZW4gPSBDYWNoZS5lbmNvZGluZ0xlbmd0aChvYmouY2FjaGUpCiAgICAgIGxlbmd0aCArPSB2YXJpbnQuZW5jb2RpbmdMZW5ndGgobGVuKQogICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgfQogICAgaWYgKGRlZmluZWQob2JqLmdldCkpIHsKICAgICAgdmFyIGxlbiA9IEdldC5lbmNvZGluZ0xlbmd0aChvYmouZ2V0KQogICAgICBsZW5ndGggKz0gdmFyaW50LmVuY29kaW5nTGVuZ3RoKGxlbikKICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgIH0KICAgIGlmIChkZWZpbmVkKG9iai5pdGVyYXRvcikpIHsKICAgICAgdmFyIGxlbiA9IEl0ZXJhdG9yLmVuY29kaW5nTGVuZ3RoKG9iai5pdGVyYXRvcikKICAgICAgbGVuZ3RoICs9IHZhcmludC5lbmNvZGluZ0xlbmd0aChsZW4pCiAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICB9CiAgICByZXR1cm4gbGVuZ3RoCiAgfQoKICBmdW5jdGlvbiBlbmNvZGUgKG9iaiwgYnVmLCBvZmZzZXQpIHsKICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICBpZiAoIWJ1ZikgYnVmID0gYjRhLmFsbG9jVW5zYWZlKGVuY29kaW5nTGVuZ3RoKG9iaikpCiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICBpZiAoZGVmaW5lZChvYmouY2FjaGUpKSB7CiAgICAgIGJ1ZltvZmZzZXQrK10gPSAxMAogICAgICB2YXJpbnQuZW5jb2RlKENhY2hlLmVuY29kaW5nTGVuZ3RoKG9iai5jYWNoZSksIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgICBDYWNoZS5lbmNvZGUob2JqLmNhY2hlLCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IENhY2hlLmVuY29kZS5ieXRlcwogICAgfQogICAgaWYgKGRlZmluZWQob2JqLmdldCkpIHsKICAgICAgYnVmW29mZnNldCsrXSA9IDE4CiAgICAgIHZhcmludC5lbmNvZGUoR2V0LmVuY29kaW5nTGVuZ3RoKG9iai5nZXQpLCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgR2V0LmVuY29kZShvYmouZ2V0LCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IEdldC5lbmNvZGUuYnl0ZXMKICAgIH0KICAgIGlmIChkZWZpbmVkKG9iai5pdGVyYXRvcikpIHsKICAgICAgYnVmW29mZnNldCsrXSA9IDI2CiAgICAgIHZhcmludC5lbmNvZGUoSXRlcmF0b3IuZW5jb2RpbmdMZW5ndGgob2JqLml0ZXJhdG9yKSwgYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgIEl0ZXJhdG9yLmVuY29kZShvYmouaXRlcmF0b3IsIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gSXRlcmF0b3IuZW5jb2RlLmJ5dGVzCiAgICB9CiAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgIHJldHVybiBidWYKICB9CgogIGZ1bmN0aW9uIGRlY29kZSAoYnVmLCBvZmZzZXQsIGVuZCkgewogICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgIGlmICghZW5kKSBlbmQgPSBidWYubGVuZ3RoCiAgICBpZiAoIShlbmQgPD0gYnVmLmxlbmd0aCAmJiBvZmZzZXQgPD0gYnVmLmxlbmd0aCkpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICB2YXIgb2JqID0gewogICAgICBjYWNoZTogbnVsbCwKICAgICAgZ2V0OiBudWxsLAogICAgICBpdGVyYXRvcjogbnVsbAogICAgfQogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKGVuZCA8PSBvZmZzZXQpIHsKICAgICAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgICByZXR1cm4gb2JqCiAgICAgIH0KICAgICAgdmFyIHByZWZpeCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgIHZhciB0YWcgPSBwcmVmaXggPj4gMwogICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgIGNhc2UgMToKICAgICAgICB2YXIgbGVuID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIG9iai5jYWNoZSA9IENhY2hlLmRlY29kZShidWYsIG9mZnNldCwgb2Zmc2V0ICsgbGVuKQogICAgICAgIG9mZnNldCArPSBDYWNoZS5kZWNvZGUuYnl0ZXMKICAgICAgICBicmVhawogICAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgbGVuID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIG9iai5nZXQgPSBHZXQuZGVjb2RlKGJ1Ziwgb2Zmc2V0LCBvZmZzZXQgKyBsZW4pCiAgICAgICAgb2Zmc2V0ICs9IEdldC5kZWNvZGUuYnl0ZXMKICAgICAgICBicmVhawogICAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgbGVuID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIG9iai5pdGVyYXRvciA9IEl0ZXJhdG9yLmRlY29kZShidWYsIG9mZnNldCwgb2Zmc2V0ICsgbGVuKQogICAgICAgIG9mZnNldCArPSBJdGVyYXRvci5kZWNvZGUuYnl0ZXMKICAgICAgICBicmVhawogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgb2Zmc2V0ID0gc2tpcChwcmVmaXggJiA3LCBidWYsIG9mZnNldCkKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gZGVmaW5lZCAodmFsKSB7CiAgcmV0dXJuIHZhbCAhPT0gbnVsbCAmJiB2YWwgIT09IHVuZGVmaW5lZCAmJiAodHlwZW9mIHZhbCAhPT0gJ251bWJlcicgfHwgIWlzTmFOKHZhbCkpCn0KewogICJuYW1lIjogImh5cGVyYmVlIiwKICAidmVyc2lvbiI6ICIyLjI2LjUiLAogICJkZXNjcmlwdGlvbiI6ICJBbiBhcHBlbmQtb25seSBCLXRyZWUgcnVubmluZyBvbiBhIEh5cGVyY29yZS4iLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYi8qKi5qcyIsCiAgICAiaXRlcmF0b3JzLyoqLmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi4wIiwKICAgICJjb2RlY3MiOiAiXjMuMC4wIiwKICAgICJkZWJvdW5jZWlmeSI6ICJeMS4wLjAiLAogICAgImh5cGVyY29yZS1lcnJvcnMiOiAiXjEuMC4wIiwKICAgICJtdXRleGlmeSI6ICJeMS40LjAiLAogICAgInByb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzIjogIl4xLjIuMCIsCiAgICAicmFjaGUiOiAiXjEuMC4wIiwKICAgICJyZWFkeS1yZXNvdXJjZSI6ICJeMS4wLjAiLAogICAgInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiAiXjEuMS4wIiwKICAgICJzYWZldHktY2F0Y2giOiAiXjEuMC4yIiwKICAgICJzdHJlYW14IjogIl4yLjEyLjQiLAogICAgInVuc2xhYiI6ICJeMS4yLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMS4wIiwKICAgICJoeXBlcmNvcmUiOiAiXjExLjAuMCIsCiAgICAicHJvdG9jb2wtYnVmZmVycyI6ICJeNC4yLjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiLAogICAgInN1Yi1lbmNvZGVyIjogIl4xLjAuNiIsCiAgICAidHJlZS10by1zdHJpbmciOiAiXjEuMS4xIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QvKi5qcyIsCiAgICAicHJvdG9idWYiOiAicHJvdG9jb2wtYnVmZmVycyBzY2hlbWEucHJvdG8gLW8gLi9saWIvbWVzc2FnZXMuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmJlZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmJlZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyYmVlIgp9CmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgovLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9NZXJrbGVfdHJlZSNTZWNvbmRfcHJlaW1hZ2VfYXR0YWNrCmNvbnN0IExFQUZfVFlQRSA9IGI0YS5mcm9tKFswXSkKY29uc3QgUEFSRU5UX1RZUEUgPSBiNGEuZnJvbShbMV0pCmNvbnN0IFJPT1RfVFlQRSA9IGI0YS5mcm9tKFsyXSkKCmNvbnN0IEhZUEVSQ09SRSA9IGI0YS5mcm9tKCdoeXBlcmNvcmUnKQoKZXhwb3J0cy5rZXlQYWlyID0gZnVuY3Rpb24gKHNlZWQpIHsKICAvLyBrZXkgcGFpcnMgbWlnaHQgc3RheSBhcm91bmQgZm9yIGEgd2hpbGUsIHNvIGJldHRlciBub3QgdG8gdXNlIGEgZGVmYXVsdCBzbGFiIHRvIGF2b2lkIHJldGFpbmluZyBpdCBjb21wbGV0ZWx5CiAgY29uc3Qgc2xhYiA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coc29kaXVtLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTICsgc29kaXVtLmNyeXB0b19zaWduX1NFQ1JFVEtFWUJZVEVTKQogIGNvbnN0IHB1YmxpY0tleSA9IHNsYWIuc3ViYXJyYXkoMCwgc29kaXVtLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogIGNvbnN0IHNlY3JldEtleSA9IHNsYWIuc3ViYXJyYXkoc29kaXVtLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQoKICBpZiAoc2VlZCkgc29kaXVtLmNyeXB0b19zaWduX3NlZWRfa2V5cGFpcihwdWJsaWNLZXksIHNlY3JldEtleSwgc2VlZCkKICBlbHNlIHNvZGl1bS5jcnlwdG9fc2lnbl9rZXlwYWlyKHB1YmxpY0tleSwgc2VjcmV0S2V5KQoKICByZXR1cm4gewogICAgcHVibGljS2V5LAogICAgc2VjcmV0S2V5CiAgfQp9CgpleHBvcnRzLnZhbGlkYXRlS2V5UGFpciA9IGZ1bmN0aW9uIChrZXlQYWlyKSB7CiAgY29uc3QgcGsgPSBiNGEuYWxsb2NVbnNhZmUoc29kaXVtLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogIHNvZGl1bS5jcnlwdG9fc2lnbl9lZDI1NTE5X3NrX3RvX3BrKHBrLCBrZXlQYWlyLnNlY3JldEtleSkKICByZXR1cm4gYjRhLmVxdWFscyhwaywga2V5UGFpci5wdWJsaWNLZXkpCn0KCmV4cG9ydHMuc2lnbiA9IGZ1bmN0aW9uIChtZXNzYWdlLCBzZWNyZXRLZXkpIHsKICAvLyBEZWRpY2F0ZWQgc2xhYiBmb3IgdGhlIHNpZ25hdHVyZSwgdG8gYXZvaWQgcmV0YWluaW5nIHVubmVlZGVkIG1lbSBhbmQgZm9yIHNlY3VyaXR5CiAgY29uc3Qgc2lnbmF0dXJlID0gYjRhLmFsbG9jVW5zYWZlU2xvdyhzb2RpdW0uY3J5cHRvX3NpZ25fQllURVMpCiAgc29kaXVtLmNyeXB0b19zaWduX2RldGFjaGVkKHNpZ25hdHVyZSwgbWVzc2FnZSwgc2VjcmV0S2V5KQogIHJldHVybiBzaWduYXR1cmUKfQoKZXhwb3J0cy52ZXJpZnkgPSBmdW5jdGlvbiAobWVzc2FnZSwgc2lnbmF0dXJlLCBwdWJsaWNLZXkpIHsKICBpZiAoc2lnbmF0dXJlLmJ5dGVMZW5ndGggIT09IHNvZGl1bS5jcnlwdG9fc2lnbl9CWVRFUykgcmV0dXJuIGZhbHNlCiAgaWYgKHB1YmxpY0tleS5ieXRlTGVuZ3RoICE9PSBzb2RpdW0uY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpIHJldHVybiBmYWxzZQogIHJldHVybiBzb2RpdW0uY3J5cHRvX3NpZ25fdmVyaWZ5X2RldGFjaGVkKHNpZ25hdHVyZSwgbWVzc2FnZSwgcHVibGljS2V5KQp9CgpleHBvcnRzLmVuY3J5cHQgPSBmdW5jdGlvbiAobWVzc2FnZSwgcHVibGljS2V5KSB7CiAgY29uc3QgY2lwaGVydGV4dCA9IGI0YS5hbGxvYyhtZXNzYWdlLmJ5dGVMZW5ndGggKyBzb2RpdW0uY3J5cHRvX2JveF9TRUFMQllURVMpCiAgc29kaXVtLmNyeXB0b19ib3hfc2VhbChjaXBoZXJ0ZXh0LCBtZXNzYWdlLCBwdWJsaWNLZXkpCiAgcmV0dXJuIGNpcGhlcnRleHQKfQoKZXhwb3J0cy5kZWNyeXB0ID0gZnVuY3Rpb24gKGNpcGhlcnRleHQsIGtleVBhaXIpIHsKICBpZiAoY2lwaGVydGV4dC5ieXRlTGVuZ3RoIDwgc29kaXVtLmNyeXB0b19ib3hfU0VBTEJZVEVTKSByZXR1cm4gbnVsbAoKICBjb25zdCBwbGFpbnRleHQgPSBiNGEuYWxsb2MoY2lwaGVydGV4dC5ieXRlTGVuZ3RoIC0gc29kaXVtLmNyeXB0b19ib3hfU0VBTEJZVEVTKQoKICBpZiAoIXNvZGl1bS5jcnlwdG9fYm94X3NlYWxfb3BlbihwbGFpbnRleHQsIGNpcGhlcnRleHQsIGtleVBhaXIucHVibGljS2V5LCBrZXlQYWlyLnNlY3JldEtleSkpIHsKICAgIHJldHVybiBudWxsCiAgfQoKICByZXR1cm4gcGxhaW50ZXh0Cn0KCmV4cG9ydHMuZW5jcnlwdGlvbktleVBhaXIgPSBmdW5jdGlvbiAoc2VlZCkgewogIGNvbnN0IHB1YmxpY0tleSA9IGI0YS5hbGxvYyhzb2RpdW0uY3J5cHRvX2JveF9QVUJMSUNLRVlCWVRFUykKICBjb25zdCBzZWNyZXRLZXkgPSBiNGEuYWxsb2Moc29kaXVtLmNyeXB0b19ib3hfU0VDUkVUS0VZQllURVMpCgogIGlmIChzZWVkKSB7CiAgICBzb2RpdW0uY3J5cHRvX2JveF9zZWVkX2tleXBhaXIocHVibGljS2V5LCBzZWNyZXRLZXksIHNlZWQpCiAgfSBlbHNlIHsKICAgIHNvZGl1bS5jcnlwdG9fYm94X2tleXBhaXIocHVibGljS2V5LCBzZWNyZXRLZXkpCiAgfQoKICByZXR1cm4gewogICAgcHVibGljS2V5LAogICAgc2VjcmV0S2V5CiAgfQp9CgpleHBvcnRzLmRhdGEgPSBmdW5jdGlvbiAoZGF0YSkgewogIGNvbnN0IG91dCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChvdXQsIFsKICAgIExFQUZfVFlQRSwKICAgIGMuZW5jb2RlKGMudWludDY0LCBkYXRhLmJ5dGVMZW5ndGgpLAogICAgZGF0YQogIF0pCgogIHJldHVybiBvdXQKfQoKZXhwb3J0cy5wYXJlbnQgPSBmdW5jdGlvbiAoYSwgYikgewogIGlmIChhLmluZGV4ID4gYi5pbmRleCkgewogICAgY29uc3QgdG1wID0gYQogICAgYSA9IGIKICAgIGIgPSB0bXAKICB9CgogIGNvbnN0IG91dCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChvdXQsIFsKICAgIFBBUkVOVF9UWVBFLAogICAgYy5lbmNvZGUoYy51aW50NjQsIGEuc2l6ZSArIGIuc2l6ZSksCiAgICBhLmhhc2gsCiAgICBiLmhhc2gKICBdKQoKICByZXR1cm4gb3V0Cn0KCmV4cG9ydHMudHJlZSA9IGZ1bmN0aW9uIChyb290cywgb3V0KSB7CiAgY29uc3QgYnVmZmVycyA9IG5ldyBBcnJheSgzICogcm9vdHMubGVuZ3RoICsgMSkKICBsZXQgaiA9IDAKCiAgYnVmZmVyc1tqKytdID0gUk9PVF9UWVBFCgogIGZvciAobGV0IGkgPSAwOyBpIDwgcm9vdHMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHIgPSByb290c1tpXQogICAgYnVmZmVyc1tqKytdID0gci5oYXNoCiAgICBidWZmZXJzW2orK10gPSBjLmVuY29kZShjLnVpbnQ2NCwgci5pbmRleCkKICAgIGJ1ZmZlcnNbaisrXSA9IGMuZW5jb2RlKGMudWludDY0LCByLnNpemUpCiAgfQoKICBpZiAoIW91dCkgb3V0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKQogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2gob3V0LCBidWZmZXJzKQogIHJldHVybiBvdXQKfQoKZXhwb3J0cy5oYXNoID0gZnVuY3Rpb24gKGRhdGEsIG91dCkgewogIGlmICghb3V0KSBvdXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCiAgaWYgKCFBcnJheS5pc0FycmF5KGRhdGEpKSBkYXRhID0gW2RhdGFdCgogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2gob3V0LCBkYXRhKQoKICByZXR1cm4gb3V0Cn0KCmV4cG9ydHMucmFuZG9tQnl0ZXMgPSBmdW5jdGlvbiAobikgewogIGNvbnN0IGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShuKQogIHNvZGl1bS5yYW5kb21ieXRlc19idWYoYnVmKQogIHJldHVybiBidWYKfQoKZXhwb3J0cy5kaXNjb3ZlcnlLZXkgPSBmdW5jdGlvbiAoa2V5KSB7CiAgaWYgKCFrZXkgfHwga2V5LmJ5dGVMZW5ndGggIT09IDMyKSB0aHJvdyBuZXcgRXJyb3IoJ011c3QgcGFzcyBhIDMyIGJ5dGUgYnVmZmVyJykKICAvLyBEaXNjb3Zlcnkga2V5cyBtaWdodCBzdGF5IGFyb3VuZCBmb3IgYSB3aGlsZSwgc28gYmV0dGVyIG5vdCB0byB1c2Ugc2xhYiBtZW1vcnkgKGZvciBiZXR0ZXIgZ2MpCiAgY29uc3QgZGlnZXN0ID0gYjRhLmFsbG9jVW5zYWZlU2xvdygzMikKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGRpZ2VzdCwgSFlQRVJDT1JFLCBrZXkpCiAgcmV0dXJuIGRpZ2VzdAp9CgppZiAoc29kaXVtLnNvZGl1bV9mcmVlKSB7CiAgZXhwb3J0cy5mcmVlID0gZnVuY3Rpb24gKHNlY3VyZUJ1ZikgewogICAgaWYgKHNlY3VyZUJ1Zi5zZWN1cmUpIHNvZGl1bS5zb2RpdW1fZnJlZShzZWN1cmVCdWYpCiAgfQp9IGVsc2UgewogIGV4cG9ydHMuZnJlZSA9IGZ1bmN0aW9uICgpIHt9Cn0KCmV4cG9ydHMubmFtZXNwYWNlID0gZnVuY3Rpb24gKG5hbWUsIGNvdW50KSB7CiAgY29uc3QgaWRzID0gdHlwZW9mIGNvdW50ID09PSAnbnVtYmVyJyA/IHJhbmdlKGNvdW50KSA6IGNvdW50CgogIC8vIE5hbWVzcGFjZXMgYXJlIGxvbmctbGl2ZWQsIHNvIGJldHRlciB0byB1c2UgYSBkZWRpY2F0ZWQgc2xhYgogIGNvbnN0IGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coMzIgKiBpZHMubGVuZ3RoKQoKICBjb25zdCBsaXN0ID0gbmV3IEFycmF5KGlkcy5sZW5ndGgpCgogIC8vIG5zIGlzIGVtaGVtZXJhbCwgc28gZGVmYXVsdCBzbGFiCiAgY29uc3QgbnMgPSBiNGEuYWxsb2NVbnNhZmUoMzMpCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChucy5zdWJhcnJheSgwLCAzMiksIHR5cGVvZiBuYW1lID09PSAnc3RyaW5nJyA/IGI0YS5mcm9tKG5hbWUpIDogbmFtZSkKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICBsaXN0W2ldID0gYnVmLnN1YmFycmF5KDMyICogaSwgMzIgKiBpICsgMzIpCiAgICBuc1szMl0gPSBpZHNbaV0KICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2gobGlzdFtpXSwgbnMpCiAgfQoKICByZXR1cm4gbGlzdAp9CgpmdW5jdGlvbiByYW5nZSAoY291bnQpIHsKICBjb25zdCBhcnIgPSBuZXcgQXJyYXkoY291bnQpCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSBhcnJbaV0gPSBpCiAgcmV0dXJuIGFycgp9CnsKICAibmFtZSI6ICJoeXBlcmNvcmUtY3J5cHRvIiwKICAidmVyc2lvbiI6ICIzLjYuMSIsCiAgImRlc2NyaXB0aW9uIjogIlRoZSBjcnlwdG8gcHJpbWl0aXZlcyB1c2VkIGluIGh5cGVyY29yZSwgZXh0cmFjdGVkIGludG8gYSBzZXBhcmF0ZSBtb2R1bGUiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjYiLAogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuMTUuMCIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuNS4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvaHlwZXJjb3JlLWNyeXB0by5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvaHlwZXJjb3JlLWNyeXB0by9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9oeXBlcmNvcmUtY3J5cHRvIgp9CmNvbnN0IElkRW5jID0gcmVxdWlyZSgnaHlwZXJjb3JlLWlkLWVuY29kaW5nJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgSHlwZXJjb3JlRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IgKG1zZywgY29kZSwgZm4gPSBIeXBlcmNvcmVFcnJvciwgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgaWYgKGRpc2NvdmVyeUtleSkgbXNnID0gYCR7bXNnfSAoZGlzY292ZXJ5IGtleTogJHtJZEVuYy5ub3JtYWxpemUoZGlzY292ZXJ5S2V5KX0pYAogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWApCgogICAgdGhpcy5jb2RlID0gY29kZQogICAgdGhpcy5kaXNjb3ZlcnlLZXkgPSBkaXNjb3ZlcnlLZXkKCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgZm4pCiAgICB9CiAgfQoKICBnZXQgbmFtZSAoKSB7CiAgICByZXR1cm4gJ0h5cGVyY29yZUVycm9yJwogIH0KCiAgc3RhdGljIEFTU0VSVElPTiAobXNnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7IC8vIEVSUl9BU1NFUlRJT04gaXMgcGlja2VkIHVwIGJ5IHNhZmV0eS1jYXRjaCBhbHNvCiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0VSUl9BU1NFUlRJT04nLCBIeXBlcmNvcmVFcnJvci5BU1NFUlQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBCQURfQVJHVU1FTlQgKG1zZywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdCQURfQVJHVU1FTlQnLCBIeXBlcmNvcmVFcnJvci5CQURfQVJHVU1FTlQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBTVE9SQUdFX0VNUFRZIChtc2csIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnU1RPUkFHRV9FTVBUWScsIEh5cGVyY29yZUVycm9yLlNUT1JBR0VfRU1QVFksIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBTVE9SQUdFX0NPTkZMSUNUIChtc2csIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnU1RPUkFHRV9DT05GTElDVCcsIEh5cGVyY29yZUVycm9yLlNUT1JBR0VfQ09ORkxJQ1QsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBJTlZBTElEX1NJR05BVFVSRSAobXNnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0lOVkFMSURfU0lHTkFUVVJFJywgSHlwZXJjb3JlRXJyb3IuSU5WQUxJRF9TSUdOQVRVUkUsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBJTlZBTElEX0NBUEFCSUxJVFkgKG1zZywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdJTlZBTElEX0NBUEFCSUxJVFknLCBIeXBlcmNvcmVFcnJvci5JTlZBTElEX0NBUEFCSUxJVFksIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBJTlZBTElEX0NIRUNLU1VNIChtc2cgPSAnSW52YWxpZCBjaGVja3N1bScsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnSU5WQUxJRF9DSEVDS1NVTScsIEh5cGVyY29yZUVycm9yLklOVkFMSURfQ0hFQ0tTVU0sIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBJTlZBTElEX09QRVJBVElPTiAobXNnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0lOVkFMSURfT1BFUkFUSU9OJywgSHlwZXJjb3JlRXJyb3IuSU5WQUxJRF9PUEVSQVRJT04sIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBJTlZBTElEX1BST09GIChtc2cgPSAnUHJvb2Ygbm90IHZlcmlmaWFibGUnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0lOVkFMSURfUFJPT0YnLCBIeXBlcmNvcmVFcnJvci5JTlZBTElEX1BST09GLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgQkxPQ0tfTk9UX0FWQUlMQUJMRSAobXNnID0gJ0Jsb2NrIGlzIG5vdCBhdmFpbGFibGUnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0JMT0NLX05PVF9BVkFJTEFCTEUnLCBIeXBlcmNvcmVFcnJvci5CTE9DS19OT1RfQVZBSUxBQkxFLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgU05BUFNIT1RfTk9UX0FWQUlMQUJMRSAobXNnID0gJ1NuYXBzaG90IGlzIG5vdCBhdmFpbGFibGUnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ1NOQVBTSE9UX05PVF9BVkFJTEFCTEUnLCBIeXBlcmNvcmVFcnJvci5TTkFQU0hPVF9OT1RfQVZBSUxBQkxFLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgUkVRVUVTVF9DQU5DRUxMRUQgKG1zZyA9ICdSZXF1ZXN0IHdhcyBjYW5jZWxsZWQnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ1JFUVVFU1RfQ0FOQ0VMTEVEJywgSHlwZXJjb3JlRXJyb3IuUkVRVUVTVF9DQU5DRUxMRUQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBSRVFVRVNUX1RJTUVPVVQgKG1zZyA9ICdSZXF1ZXN0IHRpbWVkIG91dCcsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnUkVRVUVTVF9USU1FT1VUJywgSHlwZXJjb3JlRXJyb3IuUkVRVUVTVF9USU1FT1VULCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgU0VTU0lPTl9OT1RfV1JJVEFCTEUgKG1zZyA9ICdTZXNzaW9uIGlzIG5vdCB3cml0YWJsZScsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnU0VTU0lPTl9OT1RfV1JJVEFCTEUnLCBIeXBlcmNvcmVFcnJvci5TRVNTSU9OX05PVF9XUklUQUJMRSwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIFNFU1NJT05fQ0xPU0VEIChtc2cgPSAnU2Vzc2lvbiBpcyBjbG9zZWQnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ1NFU1NJT05fQ0xPU0VEJywgSHlwZXJjb3JlRXJyb3IuU0VTU0lPTl9DTE9TRUQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBCQVRDSF9VTkZMVVNIRUQgKG1zZyA9ICdCYXRjaCBub3QgeWV0IGZsdXNoZWQnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0JBVENIX1VORkxVU0hFRCcsIEh5cGVyY29yZUVycm9yLkJBVENIX1VORkxVU0hFRCwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIEJBVENIX0FMUkVBRFlfRVhJU1RTIChtc2cgPSAnQmF0Y2ggYWxyZWFkeSBleGlzdHMnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0JBVENIX0FMUkVBRFlfRVhJU1RTJywgSHlwZXJjb3JlRXJyb3IuQkFUQ0hfQUxSRUFEWV9FWElTVFMsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBCQVRDSF9BTFJFQURZX0ZMVVNIRUQgKG1zZyA9ICdCYXRjaCBoYXMgYWxyZWFkeSBiZWVuIGZsdXNoZWQnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0JBVENIX0FMUkVBRFlfRkxVU0hFRCcsIEh5cGVyY29yZUVycm9yLkJBVENIX0FMUkVBRFlfRkxVU0hFRCwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIE9QTE9HX0NPUlJVUFQgKG1zZyA9ICdPcGxvZyBmaWxlIGFwcGVhcnMgY29ycnVwdCBvciBvdXQgb2YgZGF0ZScsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnT1BMT0dfQ09SUlVQVCcsIEh5cGVyY29yZUVycm9yLk9QTE9HX0NPUlJVUFQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBPUExPR19IRUFERVJfT1ZFUkZMT1cgKG1zZyA9ICdPcGxvZyBoZWFkZXIgZXhjZWVkcyBwYWdlIHNpemUnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ09QTE9HX0hFQURFUl9PVkVSRkxPVycsIEh5cGVyY29yZUVycm9yLk9QTE9HX0hFQURFUl9PVkVSRkxPVywgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIElOVkFMSURfT1BMT0dfVkVSU0lPTiAobXNnID0gJ0ludmFsaWQgaGVhZGVyIHZlcnNpb24nLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0lOVkFMSURfT1BMT0dfVkVSU0lPTicsIEh5cGVyY29yZUVycm9yLklOVkFMSURfT1BMT0dfVkVSU0lPTiwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIFdSSVRFX0ZBSUxFRCAobXNnID0gJ1dyaXRlIHRvIHN0b3JhZ2UgZmFpbGVkJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdXUklURV9GQUlMRUQnLCBIeXBlcmNvcmVFcnJvci5XUklURV9GQUlMRUQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBERUNPRElOR19FUlJPUiAobXNnID0gJ0RlY29kaW5nIGVycm9yJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdERUNPRElOR19FUlJPUicsIEh5cGVyY29yZUVycm9yLkRFQ09ESU5HX0VSUk9SLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgU0VTU0lPTl9NT1ZFRCAobXNnID0gJ1Nlc3Npb24gbW92ZWQnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ1NFU1NJT05fTU9WRUQnLCBIeXBlcmNvcmVFcnJvci5TRVNTSU9OX01PVkVELCBkaXNjb3ZlcnlLZXkpCiAgfQp9CnsKICAibmFtZSI6ICJoeXBlcmNvcmUtZXJyb3JzIiwKICAidmVyc2lvbiI6ICIxLjUuMCIsCiAgImRlc2NyaXB0aW9uIjogIkh5cGVyY29yZSBlcnJvcnMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyY29yZS1lcnJvcnMuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJjb3JlLWVycm9ycy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyY29yZS1lcnJvcnMjcmVhZG1lIiwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjciLAogICAgImJyaXR0bGUiOiAiXjMuMS4zIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiAiXjEuMy4wIgogIH0KfQpjb25zdCB6MzIgPSByZXF1aXJlKCd6MzInKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgZW5jb2RlLAogIGRlY29kZSwKICBub3JtYWxpemUsCiAgaXNWYWxpZAp9CgpmdW5jdGlvbiBlbmNvZGUgKGtleSkgewogIGlmICghYjRhLmlzQnVmZmVyKGtleSkpIHRocm93IG5ldyBFcnJvcignS2V5IG11c3QgYmUgYSBCdWZmZXInKQogIGlmIChrZXkuYnl0ZUxlbmd0aCAhPT0gMzIpIHRocm93IG5ldyBFcnJvcignS2V5IG11c3QgYmUgMzItYnl0ZXMgbG9uZycpCiAgcmV0dXJuIHozMi5lbmNvZGUoa2V5KQp9CgpmdW5jdGlvbiBkZWNvZGUgKGlkKSB7CiAgaWYgKGI0YS5pc0J1ZmZlcihpZCkpIHsKICAgIGlmIChpZC5ieXRlTGVuZ3RoICE9PSAzMikgdGhyb3cgbmV3IEVycm9yKCdJRCBtdXN0IGJlIDMyLWJ5dGVzIGxvbmcnKQogICAgcmV0dXJuIGlkCiAgfQogIGlmICh0eXBlb2YgaWQgPT09ICdzdHJpbmcnKSB7CiAgICBpZiAoaWQuc3RhcnRzV2l0aCgncGVhcjovLycpKSBpZCA9IGlkLnNsaWNlKDcpLnNwbGl0KCcvJylbMF0KICAgIGlmIChpZC5sZW5ndGggPT09IDUyKSByZXR1cm4gejMyLmRlY29kZShpZCkKICAgIGlmIChpZC5sZW5ndGggPT09IDY0KSB7CiAgICAgIGNvbnN0IGJ1ZiA9IGI0YS5mcm9tKGlkLCAnaGV4JykKICAgICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoID09PSAzMikgcmV0dXJuIGJ1ZgogICAgfQogIH0KICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgSHlwZXJjb3JlIGtleScpCn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZSAoYW55KSB7CiAgcmV0dXJuIGVuY29kZShkZWNvZGUoYW55KSkKfQoKZnVuY3Rpb24gaXNWYWxpZCAoYW55KSB7CiAgdHJ5IHsKICAgIGRlY29kZShhbnkpCiAgICByZXR1cm4gdHJ1ZQogIH0gY2F0Y2ggewogICAgcmV0dXJuIGZhbHNlCiAgfQp9CnsKICAibmFtZSI6ICJoeXBlcmNvcmUtaWQtZW5jb2RpbmciLAogICJ2ZXJzaW9uIjogIjEuMy4wIiwKICAiZGVzY3JpcHRpb24iOiAiQ29udmVydCBIeXBlcmNvcmUga2V5cyB0by9mcm9tIHotYmFzZTMyIG9yIGhleCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNS4zIiwKICAgICJ6MzIiOiAiXjEuMC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjEuMSIsCiAgICAiaHlwZXJjb3JlIjogIl4xMC4wLjAiLAogICAgInJhbmRvbS1hY2Nlc3MtbWVtb3J5IjogIl42LjAuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIKICB9LAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmNvcmUtaWQtZW5jb2RpbmcuZ2l0IgogIH0sCiAgImtleXdvcmRzIjogW10sCiAgImF1dGhvciI6ICIiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJjb3JlLWlkLWVuY29kaW5nL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJjb3JlLWlkLWVuY29kaW5nI3JlYWRtZSIKfQpjb25zdCBSb2Nrc0RCID0gcmVxdWlyZSgncm9ja3NkYi1uYXRpdmUnKQpjb25zdCBycnAgPSByZXF1aXJlKCdyZXNvbHZlLXJlamVjdC1wcm9taXNlJykKY29uc3QgU2NvcGVMb2NrID0gcmVxdWlyZSgnc2NvcGUtbG9jaycpCmNvbnN0IERldmljZUZpbGUgPSByZXF1aXJlKCdkZXZpY2UtZmlsZScpCmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJykKY29uc3QgZnMgPSByZXF1aXJlKCdmcycpCmNvbnN0IFZpZXcgPSByZXF1aXJlKCcuL2xpYi92aWV3LmpzJykKCmNvbnN0IFZFUlNJT04gPSAxCmNvbnN0IENPTFVNTl9GQU1JTFkgPSAnY29yZXN0b3JlJwoKY29uc3QgeyBzdG9yZSwgY29yZSB9ID0gcmVxdWlyZSgnLi9saWIva2V5cy5qcycpCgpjb25zdCB7IENvcmVzdG9yZVJYLCBDb3Jlc3RvcmVUWCwgQ29yZVRYLCBDb3JlUlggfSA9IHJlcXVpcmUoJy4vbGliL3R4LmpzJykKCmNvbnN0IHsKICBjcmVhdGVDb3JlU3RyZWFtLAogIGNyZWF0ZUFsaWFzU3RyZWFtLAogIGNyZWF0ZURpc2NvdmVyeUtleVN0cmVhbSwKICBjcmVhdGVCbG9ja1N0cmVhbSwKICBjcmVhdGVCaXRmaWVsZFN0cmVhbSwKICBjcmVhdGVVc2VyRGF0YVN0cmVhbSwKICBjcmVhdGVUcmVlTm9kZVN0cmVhbSwKICBjcmVhdGVMb2NhbFN0cmVhbQp9ID0gcmVxdWlyZSgnLi9saWIvc3RyZWFtcy5qcycpCgpjb25zdCBFTVBUWSA9IG5ldyBWaWV3KCkKCmNsYXNzIEF0b20gewogIGNvbnN0cnVjdG9yKGRiKSB7CiAgICB0aGlzLmRiID0gZGIKICAgIHRoaXMudmlldyA9IG5ldyBWaWV3KCkKICAgIHRoaXMuZmx1c2hlZFByb21pc2UgPSBudWxsCiAgICB0aGlzLmZsdXNoaW5nID0gZmFsc2UKICAgIHRoaXMuZmx1c2hlcyA9IFtdCiAgfQoKICBvbmZsdXNoKGZuKSB7CiAgICB0aGlzLmZsdXNoZXMucHVzaChmbikKICB9CgogIGZsdXNoZWQoKSB7CiAgICBpZiAoIXRoaXMuZmx1c2hpbmcpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQogICAgaWYgKHRoaXMuZmx1c2hlZFByb21pc2UgIT09IG51bGwpIHJldHVybiB0aGlzLmZsdXNoZWRQcm9taXNlLnByb21pc2UKICAgIHRoaXMuZmx1c2hlZFByb21pc2UgPSBycnAoKQogICAgcmV0dXJuIHRoaXMuZmx1c2hlZFByb21pc2UucHJvbWlzZQogIH0KCiAgX3Jlc29sdmUoKSB7CiAgICBjb25zdCBmID0gdGhpcy5mbHVzaGVkUHJvbWlzZQogICAgdGhpcy5mbHVzaGVkUHJvbWlzZSA9IG51bGwKICAgIGYucmVzb2x2ZSgpCiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGlmICh0aGlzLmZsdXNoaW5nKSB0aHJvdyBuZXcgRXJyb3IoJ0F0b20gYWxyZWFkeSBmbHVzaGluZycpCiAgICB0aGlzLmZsdXNoaW5nID0gdHJ1ZQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IFZpZXcuZmx1c2godGhpcy52aWV3LmNoYW5nZXMsIHRoaXMuZGIpCiAgICAgIHRoaXMudmlldy5yZXNldCgpCgogICAgICBjb25zdCBwcm9taXNlcyA9IFtdCiAgICAgIGNvbnN0IGxlbiA9IHRoaXMuZmx1c2hlcy5sZW5ndGggLy8gaW4gY2FzZSBvZiByZWVudHJ5CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHByb21pc2VzLnB1c2godGhpcy5mbHVzaGVzW2ldKCkpCgogICAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcykKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuZmx1c2hpbmcgPSBmYWxzZQogICAgICBpZiAodGhpcy5mbHVzaGVkUHJvbWlzZSAhPT0gbnVsbCkgdGhpcy5fcmVzb2x2ZSgpCiAgICB9CiAgfQp9CgpjbGFzcyBIeXBlcmNvcmVTdG9yYWdlIHsKICBjb25zdHJ1Y3RvcihzdG9yZSwgZGIsIGNvcmUsIHZpZXcsIGF0b20pIHsKICAgIHRoaXMuc3RvcmUgPSBzdG9yZQogICAgdGhpcy5kYiA9IGRiCiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICB0aGlzLnZpZXcgPSB2aWV3CiAgICB0aGlzLmF0b20gPSBhdG9tCgogICAgdGhpcy52aWV3LnJlYWRTdGFydCgpCiAgfQoKICBnZXQgcmVhZE9ubHkoKSB7CiAgICByZXR1cm4gdGhpcy5zdG9yZS5yZWFkT25seQogIH0KCiAgZ2V0IGRlcGVuZGVuY2llcygpIHsKICAgIHJldHVybiB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzCiAgfQoKICBnZXREZXBlbmRlbmN5TGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5kZXBlbmRlbmNpZXMubGVuZ3RoCiAgICAgID8gdGhpcy5jb3JlLmRlcGVuZGVuY2llc1t0aGlzLmNvcmUuZGVwZW5kZW5jaWVzLmxlbmd0aCAtIDFdLmxlbmd0aAogICAgICA6IC0xCiAgfQoKICBnZXREZXBlbmRlbmN5KGxlbmd0aCkgewogICAgZm9yIChsZXQgaSA9IHRoaXMuY29yZS5kZXBlbmRlbmNpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgZGVwID0gdGhpcy5jb3JlLmRlcGVuZGVuY2llc1tpXQogICAgICBpZiAoZGVwLmxlbmd0aCA8IGxlbmd0aCkgcmV0dXJuIGRlcAogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBzZXREZXBlbmRlbmN5SGVhZChkZXApIHsKICAgIGNvbnN0IGRlcHMgPSB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzCgogICAgZm9yIChsZXQgaSA9IGRlcHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgZCA9IGRlcHNbaV0KCiAgICAgIGlmIChkLmRhdGFQb2ludGVyICE9PSBkZXAuZGF0YVBvaW50ZXIpIGNvbnRpbnVlCgogICAgICAvLyBjaGVjayBpZiBub3RoaW5nIGNoYW5nZWQKICAgICAgaWYgKGQubGVuZ3RoID09PSBkZXAubGVuZ3RoICYmIGkgPT09IGRlcHMubGVuZ3RoIC0gMSkgcmV0dXJuCgogICAgICB0aGlzLmNvcmUgPSB7CiAgICAgICAgY29yZVBvaW50ZXI6IHRoaXMuY29yZS5jb3JlUG9pbnRlciwKICAgICAgICBkYXRhUG9pbnRlcjogdGhpcy5jb3JlLmRhdGFQb2ludGVyLAogICAgICAgIGRlcGVuZGVuY2llczogZGVwcy5zbGljZSgwLCBpICsgMSkKICAgICAgfQoKICAgICAgdGhpcy5jb3JlLmRlcGVuZGVuY2llc1tpXSA9IHsKICAgICAgICBkYXRhUG9pbnRlcjogZGVwLmRhdGFQb2ludGVyLAogICAgICAgIGxlbmd0aDogZGVwLmxlbmd0aAogICAgICB9CiAgICB9CgogICAgdGhpcy5jb3JlLmRlcGVuZGVuY2llcyA9IFsKICAgICAgewogICAgICAgIGRhdGFQb2ludGVyOiBkZXAuZGF0YVBvaW50ZXIsCiAgICAgICAgbGVuZ3RoOiBkZXAubGVuZ3RoCiAgICAgIH0KICAgIF0KICB9CgogIC8vIFRPRE86IHRoaXMgbWlnaHQgaGF2ZSB0byBiZSBhc3luYyBpZiB0aGUgZGVwZW5kZW50cyBoYXZlIGNoYW5nZWQsIGJ1dCBwcm9wIG9rIGZvciBub3cKICB1cGRhdGVEZXBlbmRlbmN5TGVuZ3RoKGxlbmd0aCwgdHJ1bmNhdGVkKSB7CiAgICBjb25zdCBkZXBzID0gdGhpcy5jb3JlLmRlcGVuZGVuY2llcwoKICAgIGNvbnN0IGkgPSB0aGlzLmZpbmREZXBlbmRlbmN5SW5kZXgobGVuZ3RoLCB0cnVuY2F0ZWQpCiAgICBpZiAoaSA9PT0gLTEpIHRocm93IG5ldyBFcnJvcignRGVwZW5kZW5jeSBub3QgZm91bmQnKQoKICAgIHRoaXMuY29yZSA9IHsKICAgICAgY29yZVBvaW50ZXI6IHRoaXMuY29yZS5jb3JlUG9pbnRlciwKICAgICAgZGF0YVBvaW50ZXI6IHRoaXMuY29yZS5kYXRhUG9pbnRlciwKICAgICAgZGVwZW5kZW5jaWVzOiBkZXBzLnNsaWNlKDAsIGkgKyAxKQogICAgfQoKICAgIGlmICh0aGlzLmNvcmUuZGVwZW5kZW5jaWVzW2ldLmxlbmd0aCAhPT0gbGVuZ3RoKSB7CiAgICAgIHRoaXMuY29yZS5kZXBlbmRlbmNpZXNbaV0gPSB7CiAgICAgICAgZGF0YVBvaW50ZXI6IGRlcHNbaV0uZGF0YVBvaW50ZXIsCiAgICAgICAgbGVuZ3RoCiAgICAgIH0KICAgIH0KICB9CgogIGZpbmREZXBlbmRlbmN5SW5kZXgobGVuZ3RoLCB0cnVuY2F0ZWQpIHsKICAgIGNvbnN0IGRlcHMgPSB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzCgogICAgaWYgKHRydW5jYXRlZCkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRlcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoZGVwc1tpXS5sZW5ndGggPj0gbGVuZ3RoKSByZXR1cm4gaQogICAgICB9CgogICAgICByZXR1cm4gLTEKICAgIH0KCiAgICBmb3IgKGxldCBpID0gZGVwcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBpZiAoZGVwc1tpXS5sZW5ndGggPD0gbGVuZ3RoKSByZXR1cm4gaQogICAgfQoKICAgIHJldHVybiAtMQogIH0KCiAgZ2V0IHNuYXBzaG90dGVkKCkgewogICAgcmV0dXJuIHRoaXMuZGIuX3NuYXBzaG90ICE9PSBudWxsCiAgfQoKICBzbmFwc2hvdCgpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlU3RvcmFnZSgKICAgICAgdGhpcy5zdG9yZSwKICAgICAgdGhpcy5kYi5zbmFwc2hvdCgpLAogICAgICB0aGlzLmNvcmUsCiAgICAgIHRoaXMudmlldy5zbmFwc2hvdCgpLAogICAgICB0aGlzLmF0b20KICAgICkKICB9CgogIGNvbXBhY3QoKSB7CiAgICByZXR1cm4gUHJvbWlzZS5hbGwoWwogICAgICB0aGlzLmRiLmNvbXBhY3RSYW5nZShjb3JlLmNvcmUodGhpcy5jb3JlLmNvcmVQb2ludGVyKSwgY29yZS5jb3JlKHRoaXMuY29yZS5jb3JlUG9pbnRlcikpLAogICAgICB0aGlzLmRiLmNvbXBhY3RSYW5nZShjb3JlLmRhdGEodGhpcy5jb3JlLmRhdGFQb2ludGVyKSwgY29yZS5kYXRhKHRoaXMuY29yZS5kYXRhUG9pbnRlcikpCiAgICBdKQogIH0KCiAgYXRvbWl6ZShhdG9tKSB7CiAgICBpZiAodGhpcy5hdG9tICYmIHRoaXMuYXRvbSAhPT0gYXRvbSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBhdG9taXplIGFuZCBhdG9taXplZCBzZXNzaW9uIHdpdGggYSBuZXcgYXRvbScpCiAgICB9CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZVN0b3JhZ2UodGhpcy5zdG9yZSwgdGhpcy5kYi5zZXNzaW9uKCksIHRoaXMuY29yZSwgYXRvbS52aWV3LCBhdG9tKQogIH0KCiAgY3JlYXRlQXRvbSgpIHsKICAgIHJldHVybiB0aGlzLnN0b3JlLmNyZWF0ZUF0b20oKQogIH0KCiAgY3JlYXRlQmxvY2tTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIGNyZWF0ZUJsb2NrU3RyZWFtKHRoaXMuY29yZSwgdGhpcy5kYiwgdGhpcy52aWV3LCBvcHRzKQogIH0KCiAgY3JlYXRlVHJlZU5vZGVTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIGNyZWF0ZVRyZWVOb2RlU3RyZWFtKHRoaXMuY29yZSwgdGhpcy5kYiwgdGhpcy52aWV3LCBvcHRzKQogIH0KCiAgY3JlYXRlQml0ZmllbGRTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIGNyZWF0ZUJpdGZpZWxkU3RyZWFtKHRoaXMuY29yZSwgdGhpcy5kYiwgdGhpcy52aWV3LCBvcHRzKQogIH0KCiAgY3JlYXRlVXNlckRhdGFTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIGNyZWF0ZVVzZXJEYXRhU3RyZWFtKHRoaXMuY29yZSwgdGhpcy5kYiwgdGhpcy52aWV3LCBvcHRzKQogIH0KCiAgY3JlYXRlTG9jYWxTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIGNyZWF0ZUxvY2FsU3RyZWFtKHRoaXMuY29yZSwgdGhpcy5kYiwgdGhpcy52aWV3LCBvcHRzKQogIH0KCiAgYXN5bmMgcmVzdW1lU2Vzc2lvbihuYW1lKSB7CiAgICBjb25zdCByeCA9IHRoaXMucmVhZCgpCiAgICBjb25zdCBleGlzdGluZ1Nlc3Npb25zUHJvbWlzZSA9IHJ4LmdldFNlc3Npb25zKCkKCiAgICByeC50cnlGbHVzaCgpCiAgICBjb25zdCBleGlzdGluZ1Nlc3Npb25zID0gYXdhaXQgZXhpc3RpbmdTZXNzaW9uc1Byb21pc2UKCiAgICBjb25zdCBzZXNzaW9ucyA9IGV4aXN0aW5nU2Vzc2lvbnMgfHwgW10KICAgIGNvbnN0IHNlc3Npb24gPSBnZXRCYXRjaChzZXNzaW9ucywgbmFtZSwgZmFsc2UpCgogICAgaWYgKHNlc3Npb24gPT09IG51bGwpIHJldHVybiBudWxsCgogICAgY29uc3QgY29yZSA9IHsKICAgICAgY29yZVBvaW50ZXI6IHRoaXMuY29yZS5jb3JlUG9pbnRlciwKICAgICAgZGF0YVBvaW50ZXI6IHNlc3Npb24uZGF0YVBvaW50ZXIsCiAgICAgIGRlcGVuZGVuY2llczogW10KICAgIH0KCiAgICBjb25zdCBjb3JlUnggPSBuZXcgQ29yZVJYKGNvcmUsIHRoaXMuZGIsIHRoaXMudmlldykKCiAgICBjb25zdCBkZXBlbmRlbmN5UHJvbWlzZSA9IGNvcmVSeC5nZXREZXBlbmRlbmN5KCkKICAgIGNvcmVSeC50cnlGbHVzaCgpCgogICAgY29uc3QgZGVwZW5kZW5jeSA9IGF3YWl0IGRlcGVuZGVuY3lQcm9taXNlCiAgICBpZiAoZGVwZW5kZW5jeSkgY29yZS5kZXBlbmRlbmNpZXMgPSB0aGlzLl9hZGREZXBlbmRlbmN5KGRlcGVuZGVuY3kpCgogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVTdG9yYWdlKAogICAgICB0aGlzLnN0b3JlLAogICAgICB0aGlzLmRiLnNlc3Npb24oKSwKICAgICAgY29yZSwKICAgICAgdGhpcy5hdG9tID8gdGhpcy52aWV3IDogbmV3IFZpZXcoKSwKICAgICAgdGhpcy5hdG9tCiAgICApCiAgfQoKICBhc3luYyBjcmVhdGVTZXNzaW9uKG5hbWUsIGhlYWQpIHsKICAgIGNvbnN0IHJ4ID0gdGhpcy5yZWFkKCkKCiAgICBjb25zdCBleGlzdGluZ1Nlc3Npb25zUHJvbWlzZSA9IHJ4LmdldFNlc3Npb25zKCkKICAgIGNvbnN0IGV4aXN0aW5nSGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgW2V4aXN0aW5nU2Vzc2lvbnMsIGV4aXN0aW5nSGVhZF0gPSBhd2FpdCBQcm9taXNlLmFsbChbCiAgICAgIGV4aXN0aW5nU2Vzc2lvbnNQcm9taXNlLAogICAgICBleGlzdGluZ0hlYWRQcm9taXNlCiAgICBdKQogICAgaWYgKGhlYWQgPT09IG51bGwpIGhlYWQgPSBleGlzdGluZ0hlYWQKCiAgICBpZiAoZXhpc3RpbmdIZWFkICE9PSBudWxsICYmIGhlYWQubGVuZ3RoID4gZXhpc3RpbmdIZWFkLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgaGVhZCBwYXNzZWQsIGFoZWFkIG9mIGNvcmUnKQogICAgfQoKICAgIGNvbnN0IHNlc3Npb25zID0gZXhpc3RpbmdTZXNzaW9ucyB8fCBbXQogICAgY29uc3Qgc2Vzc2lvbiA9IGdldEJhdGNoKHNlc3Npb25zLCBuYW1lLCB0cnVlKQogICAgY29uc3QgZnJlc2ggPSBzZXNzaW9uLmRhdGFQb2ludGVyID09PSAtMQoKICAgIGlmIChmcmVzaCkgewogICAgICBzZXNzaW9uLmRhdGFQb2ludGVyID0gYXdhaXQgdGhpcy5zdG9yZS5fYWxsb2NEYXRhKCkKICAgIH0KCiAgICBjb25zdCB0eCA9IHRoaXMud3JpdGUoKQoKICAgIHR4LnNldFNlc3Npb25zKHNlc3Npb25zKQoKICAgIGNvbnN0IGxlbmd0aCA9IGhlYWQgPT09IG51bGwgPyAwIDogaGVhZC5sZW5ndGgKICAgIGNvbnN0IGNvcmUgPSB7CiAgICAgIGNvcmVQb2ludGVyOiB0aGlzLmNvcmUuY29yZVBvaW50ZXIsCiAgICAgIGRhdGFQb2ludGVyOiBzZXNzaW9uLmRhdGFQb2ludGVyLAogICAgICBkZXBlbmRlbmNpZXM6IHRoaXMuX2FkZERlcGVuZGVuY3koewogICAgICAgIGRhdGFQb2ludGVyOiB0aGlzLmNvcmUuZGF0YVBvaW50ZXIsCiAgICAgICAgbGVuZ3RoCiAgICAgIH0pCiAgICB9CgogICAgY29uc3QgY29yZVR4ID0gbmV3IENvcmVUWChjb3JlLCB0aGlzLmRiLCB0eC52aWV3LCB0eC5jaGFuZ2VzKQoKICAgIGlmIChsZW5ndGggPiAwKSBjb3JlVHguc2V0SGVhZChoZWFkKQogICAgY29yZVR4LnNldERlcGVuZGVuY3koY29yZS5kZXBlbmRlbmNpZXNbY29yZS5kZXBlbmRlbmNpZXMubGVuZ3RoIC0gMV0pCgogICAgaWYgKCFmcmVzaCkgewogICAgICAvLyBudWtlIGFsbCBleGlzdGluZyBzdGF0ZS4uLgogICAgICBjb3JlVHguZGVsZXRlQmxvY2tSYW5nZSgwLCAtMSkKICAgICAgY29yZVR4LmRlbGV0ZVRyZWVOb2RlUmFuZ2UoMCwgLTEpCiAgICAgIGNvcmVUeC5kZWxldGVCaXRmaWVsZFBhZ2VSYW5nZSgwLCAtMSkKICAgIH0KCiAgICBhd2FpdCB0eC5mbHVzaCgpCgogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVTdG9yYWdlKAogICAgICB0aGlzLnN0b3JlLAogICAgICB0aGlzLmRiLnNlc3Npb24oKSwKICAgICAgY29yZSwKICAgICAgdGhpcy5hdG9tID8gdGhpcy52aWV3IDogbmV3IFZpZXcoKSwKICAgICAgdGhpcy5hdG9tCiAgICApCiAgfQoKICBhc3luYyBjcmVhdGVBdG9taWNTZXNzaW9uKGF0b20sIGhlYWQpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGhlYWQgPT09IG51bGwgPyAwIDogaGVhZC5sZW5ndGgKICAgIGNvbnN0IGNvcmUgPSB7CiAgICAgIGNvcmVQb2ludGVyOiB0aGlzLmNvcmUuY29yZVBvaW50ZXIsCiAgICAgIGRhdGFQb2ludGVyOiB0aGlzLmNvcmUuZGF0YVBvaW50ZXIsCiAgICAgIGRlcGVuZGVuY2llczogdGhpcy5fYWRkRGVwZW5kZW5jeShudWxsKQogICAgfQoKICAgIGNvbnN0IGNvcmVUeCA9IG5ldyBDb3JlVFgoY29yZSwgdGhpcy5kYiwgYXRvbS52aWV3LCBbXSkKCiAgICBpZiAobGVuZ3RoID4gMCkgY29yZVR4LnNldEhlYWQoaGVhZCkKCiAgICBhd2FpdCBjb3JlVHguZmx1c2goKQoKICAgIHJldHVybiB0aGlzLmF0b21pemUoYXRvbSkKICB9CgogIF9hZGREZXBlbmRlbmN5KGRlcCkgewogICAgY29uc3QgZGVwcyA9IFtdCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGQgPSB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzW2ldCgogICAgICBpZiAoZGVwICE9PSBudWxsICYmIGQubGVuZ3RoID4gZGVwLmxlbmd0aCkgewogICAgICAgIGlmIChkLmRhdGFQb2ludGVyICE9PSBkZXAuZGF0YVBvaW50ZXIpIHsKICAgICAgICAgIGRlcHMucHVzaCh7IGRhdGFQb2ludGVyOiBkLmRhdGFQb2ludGVyLCBsZW5ndGg6IGRlcC5sZW5ndGggfSkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlcHMKICAgICAgfQoKICAgICAgZGVwcy5wdXNoKGQpCiAgICB9CgogICAgaWYgKAogICAgICBkZXAgIT09IG51bGwgJiYKICAgICAgKGRlcHMubGVuZ3RoID09PSAwIHx8IGRlcHNbZGVwcy5sZW5ndGggLSAxXS5kYXRhUG9pbnRlciAhPT0gZGVwLmRhdGFQb2ludGVyKQogICAgKSB7CiAgICAgIGRlcHMucHVzaChkZXApCiAgICB9CiAgICByZXR1cm4gZGVwcwogIH0KCiAgcmVhZCgpIHsKICAgIHJldHVybiBuZXcgQ29yZVJYKHRoaXMuY29yZSwgdGhpcy5kYiwgdGhpcy52aWV3KQogIH0KCiAgd3JpdGUoKSB7CiAgICByZXR1cm4gbmV3IENvcmVUWCh0aGlzLmNvcmUsIHRoaXMuZGIsIHRoaXMuYXRvbSA/IHRoaXMudmlldyA6IG51bGwsIFtdKQogIH0KCiAgY2xvc2UoKSB7CiAgICBpZiAodGhpcy52aWV3ICE9PSBudWxsKSB7CiAgICAgIHRoaXMudmlldy5yZWFkU3RvcCgpCiAgICAgIHRoaXMudmlldyA9IG51bGwKICAgIH0KCiAgICByZXR1cm4gdGhpcy5kYi5jbG9zZSgpCiAgfQoKICBzdGF0aWMgYXN5bmMgZXhwb3J0KHB0ciwgZGIsIHsgYmF0Y2hlcyA9IGZhbHNlIH0gPSB7fSkgewogICAgY29uc3QgcnggPSBuZXcgQ29yZVJYKHB0ciwgZGIsIEVNUFRZKQoKICAgIGNvbnN0IGNvcmUgPSB7CiAgICAgIGhlYWQ6IG51bGwsCiAgICAgIGF1dGg6IG51bGwsCiAgICAgIHNlc3Npb25zOiBbXSwKICAgICAgZGF0YTogbnVsbAogICAgfQoKICAgIGNvbnN0IHNlc3Npb25zUHJvbWlzZSA9IHJ4LmdldFNlc3Npb25zKCkKICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCiAgICBjb25zdCBhdXRoUHJvbWlzZSA9IHJ4LmdldEF1dGgoKQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBbc2Vzc2lvbnMsIGhlYWQsIGF1dGhdID0gYXdhaXQgUHJvbWlzZS5hbGwoW3Nlc3Npb25zUHJvbWlzZSwgaGVhZFByb21pc2UsIGF1dGhQcm9taXNlXSkKCiAgICBjb3JlLmhlYWQgPSBoZWFkCiAgICBjb3JlLmF1dGggPSB7IC4uLmF1dGgsIGtleVBhaXI6IG51bGwgfQogICAgaWYgKHNlc3Npb25zKSBjb3JlLnNlc3Npb25zID0gc2Vzc2lvbnMubWFwKChzKSA9PiBzLm5hbWUpCgogICAgY29uc3QgZGF0YSA9IFtdCgogICAgZGF0YS5wdXNoKGV4cG9ydERhdGEocHRyLCBkYikpCgogICAgaWYgKGJhdGNoZXMpIHsKICAgICAgZm9yIChjb25zdCB7IGRhdGFQb2ludGVyIH0gb2Ygc2Vzc2lvbnMpIHsKICAgICAgICBkYXRhLnB1c2goZXhwb3J0RGF0YSh7IGRhdGFQb2ludGVyLCBkZXBlbmRlbmNpZXM6IFtdIH0sIGRiKSkKICAgICAgfQogICAgfQoKICAgIGNvcmUuZGF0YSA9IGF3YWl0IFByb21pc2UuYWxsKGRhdGEpCgogICAgcmV0dXJuIGNvcmUKICB9Cn0KCmNsYXNzIENvcmVzdG9yZVN0b3JhZ2UgewogIGNvbnN0cnVjdG9yKGRiLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHN0b3JhZ2UgPSB0eXBlb2YgZGIgPT09ICdzdHJpbmcnID8gZGIgOiBudWxsCgogICAgdGhpcy5ib290c3RyYXAgPSBzdG9yYWdlICE9PSBudWxsCiAgICB0aGlzLnBhdGggPSBzdG9yYWdlICE9PSBudWxsID8gc3RvcmFnZSA6IHBhdGguam9pbihkYi5wYXRoLCAnLi4nKQogICAgdGhpcy5yZWFkT25seSA9ICEhb3B0cy5yZWFkT25seQogICAgdGhpcy5hbGxvd0JhY2t1cCA9ICEhb3B0cy5hbGxvd0JhY2t1cAogICAgdGhpcy5kZXZpY2VGaWxlID0gbnVsbAogICAgdGhpcy53YWl0ID0gISFvcHRzLndhaXQKCiAgICAvLyB0bXAgc3luYyBmaXggZm9yIHNpbXBsaWN0eSBzaW5jZSBub3Qgc3VwZXIgZGVwbG95ZWQgeWV0CiAgICBpZiAodGhpcy5ib290c3RyYXAgJiYgIXRoaXMucmVhZE9ubHkpIHRtcEZpeFN0b3JhZ2UodGhpcy5wYXRoKQoKICAgIHRoaXMuaWQgPSBvcHRzLmlkIHx8IG51bGwKICAgIHRoaXMudmlldyA9IG51bGwKICAgIHRoaXMuZW50ZXJzID0gMAogICAgdGhpcy5sb2NrID0gbmV3IFNjb3BlTG9jaygpCiAgICB0aGlzLmZsdXNoaW5nID0gbnVsbAogICAgdGhpcy52ZXJzaW9uID0gMAogICAgdGhpcy5taWdyYXRpbmcgPSBudWxsCgogICAgaWYgKCh0aGlzLmJvb3RzdHJhcCAmJiAhdGhpcy5yZWFkT25seSAmJiAhdGhpcy5hbGxvd0JhY2t1cCkgfHwgdGhpcy53YWl0KSB7CiAgICAgIGNvbnN0IGNvcmVzdG9yZUZpbGUgPSBwYXRoLmpvaW4odGhpcy5wYXRoLCAnQ09SRVNUT1JFJykKCiAgICAgIHRoaXMuZGV2aWNlRmlsZSA9IG5ldyBEZXZpY2VGaWxlKGNvcmVzdG9yZUZpbGUsIHsKICAgICAgICBsb2NrOiB0cnVlLAogICAgICAgIHdhaXQ6IHRoaXMud2FpdCwKICAgICAgICBkYXRhOiB7IGlkOiB0aGlzLmlkIH0KICAgICAgfSkKICAgIH0KCiAgICBjb25zdCBkYlBhdGggPSBwYXRoLmpvaW4odGhpcy5wYXRoLCAnZGInKQoKICAgIHRoaXMucm9ja3MgPSBzdG9yYWdlID09PSBudWxsID8gZGIgOiBuZXcgUm9ja3NEQihkYlBhdGgsIHsgLi4ub3B0cywgbG9jazogdGhpcy5kZXZpY2VGaWxlIH0pCiAgICB0aGlzLmRiID0gY3JlYXRlQ29sdW1uRmFtaWx5KHRoaXMucm9ja3MsIG9wdHMpCiAgfQoKICBnZXQgb3BlbmVkKCkgewogICAgcmV0dXJuIHRoaXMuZGIub3BlbmVkCiAgfQoKICBnZXQgY2xvc2VkKCkgewogICAgcmV0dXJuIHRoaXMuZGIuY2xvc2VkCiAgfQoKICBhc3luYyByZWFkeSgpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCiAgICByZXR1cm4gdGhpcy5kYi5yZWFkeSgpCiAgfQoKICBjb21wYWN0KCkgewogICAgcmV0dXJuIHRoaXMuZGIuY29tcGFjdFJhbmdlKCkKICB9CgogIGFzeW5jIGF1ZGl0KCkgewogICAgZm9yIGF3YWl0IChjb25zdCB7IGNvcmUgfSBvZiB0aGlzLmNyZWF0ZUNvcmVTdHJlYW0oKSkgewogICAgICBjb25zdCBjb3JlUnggPSBuZXcgQ29yZVJYKGNvcmUsIHRoaXMuZGIsIEVNUFRZKQogICAgICBjb25zdCBhdXRoUHJvbWlzZSA9IGNvcmVSeC5nZXRBdXRoKCkKCiAgICAgIGNvcmVSeC50cnlGbHVzaCgpCgogICAgICBjb25zdCBhdXRoID0gYXdhaXQgYXV0aFByb21pc2UKCiAgICAgIGlmICghYXV0aC5tYW5pZmVzdCB8fCBhdXRoLm1hbmlmZXN0LnZlcnNpb24gPiAwKSBjb250aW51ZQogICAgICBpZiAoYXV0aC5tYW5pZmVzdC5saW5rZWQgPT09IG51bGwpIGNvbnRpbnVlCgogICAgICBhdXRoLm1hbmlmZXN0LmxpbmtlZCA9IG51bGwKICAgICAgY29uc3QgY29yZVR4ID0gbmV3IENvcmVUWChjb3JlLCB0aGlzLmRiLCBudWxsLCBbXSkKICAgICAgY29yZVR4LnNldEF1dGgoYXV0aCkKICAgICAgYXdhaXQgY29yZVR4LmZsdXNoKCkKICAgIH0KICB9CgogIGFzeW5jIGRlbGV0ZUNvcmUocHRyKSB7CiAgICBjb25zdCByeCA9IG5ldyBDb3JlUlgocHRyLCB0aGlzLmRiLCBFTVBUWSkKCiAgICBjb25zdCBhdXRoUHJvbWlzZSA9IHJ4LmdldEF1dGgoKQogICAgY29uc3Qgc2Vzc2lvbnNQcm9taXNlID0gcnguZ2V0U2Vzc2lvbnMoKQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBhdXRoID0gYXdhaXQgYXV0aFByb21pc2UKICAgIGNvbnN0IHNlc3Npb25zID0gYXdhaXQgc2Vzc2lvbnNQcm9taXNlCgogICAgLy8gbm8gY29yZSBzdG9yZWQgaGVyZQogICAgaWYgKCFhdXRoKSByZXR1cm4KCiAgICBjb25zdCB0eCA9IHRoaXMuZGIud3JpdGUoeyBhdXRvRGVzdHJveTogdHJ1ZSB9KQoKICAgIHR4LnRyeURlbGV0ZShzdG9yZS5jb3JlKGF1dGguZGlzY292ZXJ5S2V5KSkKCiAgICAvLyBjbGVhciBjb3JlCiAgICBjb25zdCBzdGFydCA9IGNvcmUuY29yZShwdHIuY29yZVBvaW50ZXIpCiAgICBjb25zdCBlbmQgPSBjb3JlLmNvcmUocHRyLmNvcmVQb2ludGVyICsgMSkKICAgIHR4LnRyeURlbGV0ZVJhbmdlKHN0YXJ0LCBlbmQpCgogICAgaWYgKHNlc3Npb25zKSB7CiAgICAgIGZvciAoY29uc3QgeyBkYXRhUG9pbnRlciB9IG9mIHNlc3Npb25zKSB7CiAgICAgICAgY29uc3Qgc3RhcnQgPSBjb3JlLmRhdGEoZGF0YVBvaW50ZXIpCiAgICAgICAgY29uc3QgZW5kID0gY29yZS5kYXRhKGRhdGFQb2ludGVyICsgMSkKICAgICAgICB0eC50cnlEZWxldGVSYW5nZShzdGFydCwgZW5kKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHR4LmZsdXNoKCkKICB9CgogIHN0YXRpYyBpc0NvcmVTdG9yYWdlKGRiKSB7CiAgICByZXR1cm4gaXNDb3Jlc3RvcmVTdG9yYWdlKGRiKQogIH0KCiAgc3RhdGljIGZyb20oZGIpIHsKICAgIGlmIChpc0NvcmVzdG9yZVN0b3JhZ2UoZGIpKSByZXR1cm4gZGIKICAgIHJldHVybiBuZXcgdGhpcyhkYikKICB9CgogIGFzeW5jIF9mbHVzaCgpIHsKICAgIHdoaWxlICh0aGlzLmVudGVycyA+IDApIHsKICAgICAgYXdhaXQgdGhpcy5sb2NrLmxvY2soKQogICAgICBhd2FpdCB0aGlzLmxvY2sudW5sb2NrKCkKICAgIH0KICB9CgogIC8vIHJ1bnMgcHJlIGFueSBvdGhlciBtdXRhdGlvbiBhbmQgcmVhZAogIGFzeW5jIF9taWdyYXRlU3RvcmUoKSB7CiAgICBjb25zdCB2aWV3ID0gYXdhaXQgdGhpcy5fZW50ZXIoKQoKICAgIHRyeSB7CiAgICAgIGlmICh0aGlzLnZlcnNpb24gPT09IFZFUlNJT04pIHJldHVybgoKICAgICAgYXdhaXQgdGhpcy5fcHJlb3BlbgogICAgICBhd2FpdCB0aGlzLmRiLnJlYWR5KCkKCiAgICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIHZpZXcpCiAgICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCgogICAgICByeC50cnlGbHVzaCgpCiAgICAgIGNvbnN0IGhlYWQgPSBhd2FpdCBoZWFkUHJvbWlzZQoKICAgICAgY29uc3QgdmVyc2lvbiA9IGhlYWQgPT09IG51bGwgPyAwIDogaGVhZC52ZXJzaW9uCiAgICAgIGlmICh2ZXJzaW9uID09PSBWRVJTSU9OKSB7CiAgICAgICAgdGhpcy52ZXJzaW9uID0gVkVSU0lPTgogICAgICAgIHJldHVybgogICAgICB9CgogICAgICBjb25zdCB0YXJnZXQgPSB7IHZlcnNpb246IFZFUlNJT04sIGRyeVJ1bjogZmFsc2UgfQoKICAgICAgc3dpdGNoICh2ZXJzaW9uKSB7CiAgICAgICAgY2FzZSAwOiB7CiAgICAgICAgICBhd2FpdCByZXF1aXJlKCcuL21pZ3JhdGlvbnMvMCcpLnN0b3JlKHRoaXMsIHRhcmdldCkKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgJ1Vuc3VwcG9ydGVkIHZlcnNpb246ICcgKyB2ZXJzaW9uICsgJyAtIHlvdSBzaG91bGQgcHJvYmFibHkgdXBncmFkZSB5b3VyIGRlcGVuZGVuY2llcycKICAgICAgICAgICkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMudmVyc2lvbiA9IFZFUlNJT04KICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IHRoaXMuX2V4aXQoKQogICAgfQogIH0KCiAgLy8gcnVucyBwcmUgdGhlIGNvcmUgaXMgcmV0dXJuZWQgdG8gdGhlIHVzZXIKICBhc3luYyBfbWlncmF0ZUNvcmUoY29yZSwgZGlzY292ZXJ5S2V5LCB2ZXJzaW9uLCBsb2NrZWQpIHsKICAgIGNvbnN0IHZpZXcgPSBsb2NrZWQgPyB0aGlzLnZpZXcgOiBhd2FpdCB0aGlzLl9lbnRlcigpCiAgICB0cnkgewogICAgICBpZiAodmVyc2lvbiA9PT0gVkVSU0lPTikgcmV0dXJuCgogICAgICBjb25zdCB0YXJnZXQgPSB7IHZlcnNpb246IFZFUlNJT04sIGRyeVJ1bjogZmFsc2UgfQoKICAgICAgc3dpdGNoICh2ZXJzaW9uKSB7CiAgICAgICAgY2FzZSAwOiB7CiAgICAgICAgICBhd2FpdCByZXF1aXJlKCcuL21pZ3JhdGlvbnMvMCcpLmNvcmUoY29yZSwgdGFyZ2V0KQogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAnVW5zdXBwb3J0ZWQgdmVyc2lvbjogJyArIHZlcnNpb24gKyAnIC0geW91IHNob3VsZCBwcm9iYWJseSB1cGdyYWRlIHlvdXIgZGVwZW5kZW5jaWVzJwogICAgICAgICAgKQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGxvY2tlZCA9PT0gZmFsc2UpIHJldHVybgoKICAgICAgLy8gaWYgaXRzIGxvY2tlZCwgdGhlbiBtb3ZlIHRoZSBjb3JlIHN0YXRlIGludG8gdGhlIG1lbXZpZXcKICAgICAgLy8gaW4gY2FzZSB0aGUgY29yZSBpcyByZW9wZW5lZCBmcm9tIHRoZSBtZW12aWV3LCBwcmUgZmx1c2gKCiAgICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIEVNUFRZKQogICAgICBjb25zdCB0eCA9IG5ldyBDb3Jlc3RvcmVUWCh2aWV3KQoKICAgICAgY29uc3QgY29yZVByb21pc2UgPSByeC5nZXRDb3JlKGRpc2NvdmVyeUtleSkKICAgICAgcngudHJ5Rmx1c2goKQoKICAgICAgdHgucHV0Q29yZShkaXNjb3ZlcnlLZXksIGF3YWl0IGNvcmVQcm9taXNlKQogICAgICB0eC5hcHBseSgpCiAgICB9IGZpbmFsbHkgewogICAgICBpZiAoIWxvY2tlZCkgYXdhaXQgdGhpcy5fZXhpdCgpCiAgICB9CiAgfQoKICBhc3luYyBfZW50ZXIoKSB7CiAgICB0aGlzLmVudGVycysrCiAgICBhd2FpdCB0aGlzLmxvY2subG9jaygpCiAgICBpZiAodGhpcy52aWV3ID09PSBudWxsKSB0aGlzLnZpZXcgPSBuZXcgVmlldygpCiAgICByZXR1cm4gdGhpcy52aWV3CiAgfQoKICBhc3luYyBfZXhpdCgpIHsKICAgIHRoaXMuZW50ZXJzLS0KCiAgICBpZiAodGhpcy5mbHVzaGluZyA9PT0gbnVsbCkgdGhpcy5mbHVzaGluZyA9IHJycCgpCiAgICBjb25zdCBmbHVzaGVkID0gdGhpcy5mbHVzaGluZy5wcm9taXNlCgogICAgaWYgKHRoaXMuZW50ZXJzID09PSAwIHx8IHRoaXMudmlldy5zaXplKCkgPiAxMjgpIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCBWaWV3LmZsdXNoKHRoaXMudmlldy5jaGFuZ2VzLCB0aGlzLmRiKQogICAgICAgIHRoaXMuZmx1c2hpbmcucmVzb2x2ZSgpCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIHRoaXMuZmx1c2hpbmcucmVqZWN0KGVycikKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICB0aGlzLmZsdXNoaW5nID0gbnVsbAogICAgICAgIHRoaXMudmlldyA9IG51bGwKICAgICAgfQogICAgfQoKICAgIHRoaXMubG9jay51bmxvY2soKQogICAgcmV0dXJuIGZsdXNoZWQKICB9CgogIC8vIHdoZW4gdXNlZCB3aXRoIGNvcmUgY2F0Y2hlcyB0aGlzIGlzbnQgdHJhbnNhY3Rpb25hbCBmb3Igc2ltcGxpY2l0eSwgSE9XRVZFUiwgaXRzIGp1c3QgYSBudW1iZXIKICAvLyBzbyB3b3J0aCB0aGUgdHJhZGVvZmYKICBhc3luYyBfYWxsb2NEYXRhKCkgewogICAgbGV0IGRhdGFQb2ludGVyID0gMAoKICAgIGNvbnN0IHZpZXcgPSBhd2FpdCB0aGlzLl9lbnRlcigpCiAgICBjb25zdCB0eCA9IG5ldyBDb3Jlc3RvcmVUWCh2aWV3KQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IGhlYWQgPSBhd2FpdCB0aGlzLl9nZXRIZWFkKHZpZXcpCgogICAgICBkYXRhUG9pbnRlciA9IGhlYWQuYWxsb2NhdGVkLmRhdGFzKysKCiAgICAgIHR4LnNldEhlYWQoaGVhZCkKICAgICAgdHguYXBwbHkoKQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgdGhpcy5fZXhpdCgpCiAgICB9CgogICAgcmV0dXJuIGRhdGFQb2ludGVyCiAgfQoKICAvLyBleHBvc2VzIGhlcmUgc28gbWlncmF0aW9ucyBjYW4gZWFzaWx5IGFjY2VzcyB0aGUgaGVhZCBpbiBhbiBpbml0IHN0YXRlCiAgYXN5bmMgX2dldEhlYWQodmlldykgewogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgdmlldykKICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgaGVhZCA9IGF3YWl0IGhlYWRQcm9taXNlCiAgICByZXR1cm4gaGVhZCA9PT0gbnVsbCA/IGluaXRTdG9yZUhlYWQoKSA6IGhlYWQKICB9CgogIGNyZWF0ZUF0b20oKSB7CiAgICByZXR1cm4gbmV3IEF0b20odGhpcy5kYikKICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgYXdhaXQgdGhpcy5yb2Nrcy5mbHVzaCgpCiAgfQoKICBhc3luYyBjbG9zZSgpIHsKICAgIGlmICh0aGlzLmRiLmNsb3NlZCkgcmV0dXJuCiAgICBhd2FpdCB0aGlzLl9mbHVzaCgpCiAgICBhd2FpdCB0aGlzLmRiLmNsb3NlKCkKICAgIGF3YWl0IHRoaXMucm9ja3MuY2xvc2UoKQogICAgaWYgKHRoaXMuZGV2aWNlRmlsZSkgYXdhaXQgdGhpcy5kZXZpY2VGaWxlLmNsb3NlKCkKICB9CgogIGFzeW5jIGNsZWFyKCkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBjb25zdCB2aWV3ID0gYXdhaXQgdGhpcy5fZW50ZXIoKQogICAgY29uc3QgdHggPSBuZXcgQ29yZXN0b3JlVFgodmlldykKCiAgICB0eC5jbGVhcigpCiAgICB0eC5hcHBseSgpCgogICAgYXdhaXQgdGhpcy5fZXhpdCgpCiAgfQoKICBjcmVhdGVDb3JlU3RyZWFtKCkgewogICAgLy8gVE9ETzogYmUgbmljZSB0byBydW4gdGhlIG1naXJhdGlvbiBoZXJlIGFsc28sIGJ1dCB0b28gbXVjaCBwbHVtYmluZyBhdG0KICAgIHJldHVybiBjcmVhdGVDb3JlU3RyZWFtKHRoaXMuZGIsIEVNUFRZKQogIH0KCiAgY3JlYXRlQWxpYXNTdHJlYW0obmFtZXNwYWNlKSB7CiAgICAvLyBUT0RPOiBiZSBuaWNlIHRvIHJ1biB0aGUgbWdpcmF0aW9uIGhlcmUgYWxzbywgYnV0IHRvbyBtdWNoIHBsdW1iaW5nIGF0bQogICAgcmV0dXJuIGNyZWF0ZUFsaWFzU3RyZWFtKHRoaXMuZGIsIEVNUFRZLCBuYW1lc3BhY2UpCiAgfQoKICBjcmVhdGVEaXNjb3ZlcnlLZXlTdHJlYW0obmFtZXNwYWNlKSB7CiAgICByZXR1cm4gY3JlYXRlRGlzY292ZXJ5S2V5U3RyZWFtKHRoaXMuZGIsIEVNUFRZLCBuYW1lc3BhY2UpCiAgfQoKICBhc3luYyBnZXRBbGlhcyhhbGlhcykgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCBFTVBUWSkKICAgIGNvbnN0IGRpc2NvdmVyeUtleVByb21pc2UgPSByeC5nZXRDb3JlQnlBbGlhcyhhbGlhcykKICAgIHJ4LnRyeUZsdXNoKCkKICAgIHJldHVybiBkaXNjb3ZlcnlLZXlQcm9taXNlCiAgfQoKICBhc3luYyBnZXRTZWVkKCkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCBFTVBUWSkKICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IGhlYWQgPSBhd2FpdCBoZWFkUHJvbWlzZQogICAgcmV0dXJuIGhlYWQgPT09IG51bGwgPyBudWxsIDogaGVhZC5zZWVkCiAgfQoKICBhc3luYyBzZXRTZWVkKHNlZWQsIHsgb3ZlcndyaXRlID0gdHJ1ZSB9ID0ge30pIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgY29uc3QgdmlldyA9IGF3YWl0IHRoaXMuX2VudGVyKCkKICAgIGNvbnN0IHR4ID0gbmV3IENvcmVzdG9yZVRYKHZpZXcpCgogICAgdHJ5IHsKICAgICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgdmlldykKICAgICAgY29uc3QgaGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKCiAgICAgIHJ4LnRyeUZsdXNoKCkKCiAgICAgIGNvbnN0IGhlYWQgPSAoYXdhaXQgaGVhZFByb21pc2UpIHx8IGluaXRTdG9yZUhlYWQoKQoKICAgICAgaWYgKGhlYWQuc2VlZCA9PT0gbnVsbCB8fCBvdmVyd3JpdGUpIGhlYWQuc2VlZCA9IHNlZWQKICAgICAgdHguc2V0SGVhZChoZWFkKQogICAgICB0eC5hcHBseSgpCgogICAgICByZXR1cm4gaGVhZC5zZWVkCiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCB0aGlzLl9leGl0KCkKICAgIH0KICB9CgogIGFzeW5jIGdldERlZmF1bHREaXNjb3ZlcnlLZXkoKSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSBhd2FpdCB0aGlzLl9taWdyYXRlU3RvcmUoKQoKICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIEVNUFRZKQogICAgY29uc3QgaGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgaGVhZCA9IGF3YWl0IGhlYWRQcm9taXNlCiAgICByZXR1cm4gaGVhZCA9PT0gbnVsbCA/IG51bGwgOiBoZWFkLmRlZmF1bHREaXNjb3ZlcnlLZXkKICB9CgogIGFzeW5jIHNldERlZmF1bHREaXNjb3ZlcnlLZXkoZGlzY292ZXJ5S2V5LCB7IG92ZXJ3cml0ZSA9IHRydWUgfSA9IHt9KSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSBhd2FpdCB0aGlzLl9taWdyYXRlU3RvcmUoKQoKICAgIGNvbnN0IHZpZXcgPSBhd2FpdCB0aGlzLl9lbnRlcigpCiAgICBjb25zdCB0eCA9IG5ldyBDb3Jlc3RvcmVUWCh2aWV3KQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIHZpZXcpCiAgICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCgogICAgICByeC50cnlGbHVzaCgpCgogICAgICBjb25zdCBoZWFkID0gKGF3YWl0IGhlYWRQcm9taXNlKSB8fCBpbml0U3RvcmVIZWFkKCkKCiAgICAgIGlmIChoZWFkLmRlZmF1bHREaXNjb3ZlcnlLZXkgPT09IG51bGwgfHwgb3ZlcndyaXRlKSBoZWFkLmRlZmF1bHREaXNjb3ZlcnlLZXkgPSBkaXNjb3ZlcnlLZXkKICAgICAgdHguc2V0SGVhZChoZWFkKQogICAgICB0eC5hcHBseSgpCgogICAgICByZXR1cm4gaGVhZC5kZWZhdWx0RGlzY292ZXJ5S2V5CiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCB0aGlzLl9leGl0KCkKICAgIH0KICB9CgogIGFzeW5jIGhhc0NvcmUoZGlzY292ZXJ5S2V5LCB7IGlmTWlncmF0ZWQgPSBmYWxzZSB9ID0ge30pIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgRU1QVFkpCiAgICBjb25zdCBwcm9taXNlID0gcnguZ2V0Q29yZShkaXNjb3ZlcnlLZXkpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IGNvcmUgPSBhd2FpdCBwcm9taXNlCgogICAgaWYgKGNvcmUgPT09IG51bGwpIHJldHVybiBmYWxzZQogICAgaWYgKGNvcmUudmVyc2lvbiAhPT0gVkVSU0lPTiAmJiBpZk1pZ3JhdGVkKSByZXR1cm4gZmFsc2UKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgZ2V0QXV0aChkaXNjb3ZlcnlLZXkpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgRU1QVFkpCiAgICBjb25zdCBjb3JlUHJvbWlzZSA9IHJ4LmdldENvcmUoZGlzY292ZXJ5S2V5KQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBjb3JlID0gYXdhaXQgY29yZVByb21pc2UKICAgIGlmIChjb3JlID09PSBudWxsKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHJlYWQgPSB0aGlzLmRiLnJlYWQoeyBhdXRvRGVzdHJveTogdHJ1ZSB9KQogICAgY29uc3QgYXV0aFByb21pc2UgPSBDb3JlUlguZ2V0QXV0aChyZWFkLCBjb3JlKQoKICAgIHJlYWQudHJ5Rmx1c2goKQoKICAgIHJldHVybiBhdXRoUHJvbWlzZQogIH0KCiAgYXN5bmMgZ2V0SW5mbyhkaXNjb3ZlcnlLZXksIG9wdHMpIHsKICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXRJbmZvcyhbZGlzY292ZXJ5S2V5XSwgb3B0cykpWzBdCiAgfQoKICBhc3luYyBnZXRJbmZvcyhkaXNjb3ZlcnlLZXlzLCB7IGF1dGggPSB0cnVlLCBoZWFkID0gdHJ1ZSwgaGludHMgPSB0cnVlIH0gPSB7fSkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCBFTVBUWSkKICAgIGNvbnN0IGNvcmVQcm9taXNlcyA9IG5ldyBBcnJheShkaXNjb3ZlcnlLZXlzLmxlbmd0aCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRpc2NvdmVyeUtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29yZVByb21pc2VzW2ldID0gcnguZ2V0Q29yZShkaXNjb3ZlcnlLZXlzW2ldKQogICAgfQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBjb3JlcyA9IGF3YWl0IFByb21pc2UuYWxsKGNvcmVQcm9taXNlcykKICAgIGNvbnN0IHJlYWQgPSB0aGlzLmRiLnJlYWQoeyBhdXRvRGVzdHJveTogdHJ1ZSB9KQoKICAgIGNvbnN0IHJlc3VsdFByb21pc2VzID0gbmV3IEFycmF5KGNvcmVzLmxlbmd0aCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvcmVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdFByb21pc2VzW2ldID0gY29yZXNbaV0KICAgICAgICA/IGdldEluZm9Gcm9tQmF0Y2gocmVhZCwgY29yZXNbaV0sIGRpc2NvdmVyeUtleXNbaV0sIGF1dGgsIGhlYWQsIGhpbnRzKQogICAgICAgIDogbnVsbAogICAgfQoKICAgIHJlYWQudHJ5Rmx1c2goKQoKICAgIHJldHVybiBQcm9taXNlLmFsbChyZXN1bHRQcm9taXNlcykKICB9CgogIGFzeW5jIHN1c3BlbmQoKSB7CiAgICBhd2FpdCB0aGlzLmRiLnN1c3BlbmQoKQogICAgaWYgKHRoaXMuZGV2aWNlRmlsZSkgYXdhaXQgdGhpcy5kZXZpY2VGaWxlLnN1c3BlbmQoKQogIH0KCiAgYXN5bmMgcmVzdW1lKCkgewogICAgaWYgKHRoaXMuZGV2aWNlRmlsZSkgYXdhaXQgdGhpcy5kZXZpY2VGaWxlLnJlc3VtZSgpCiAgICBhd2FpdCB0aGlzLmRiLnJlc3VtZSgpCiAgfQoKICBhc3luYyByZXN1bWVDb3JlKGRpc2NvdmVyeUtleSkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBpZiAoIWRpc2NvdmVyeUtleSkgewogICAgICBkaXNjb3ZlcnlLZXkgPSBhd2FpdCB0aGlzLmdldERlZmF1bHREaXNjb3ZlcnlLZXkoKQogICAgICBpZiAoIWRpc2NvdmVyeUtleSkgcmV0dXJuIG51bGwKICAgIH0KCiAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCBFTVBUWSkKICAgIGNvbnN0IGNvcmVQcm9taXNlID0gcnguZ2V0Q29yZShkaXNjb3ZlcnlLZXkpCgogICAgcngudHJ5Rmx1c2goKQogICAgY29uc3QgY29yZSA9IGF3YWl0IGNvcmVQcm9taXNlCgogICAgaWYgKGNvcmUgPT09IG51bGwpIHJldHVybiBudWxsCiAgICByZXR1cm4gdGhpcy5fcmVzdW1lRnJvbVBvaW50ZXJzKEVNUFRZLCBkaXNjb3ZlcnlLZXksIGZhbHNlLCBjb3JlKQogIH0KCiAgYXN5bmMgZXhwb3J0KGRpc2NvdmVyeUtleSwgb3B0cykgewogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgRU1QVFkpCiAgICBjb25zdCBjb3JlUHJvbWlzZSA9IHJ4LmdldENvcmUoZGlzY292ZXJ5S2V5KQoKICAgIHJ4LnRyeUZsdXNoKCkKICAgIGNvbnN0IGNvcmUgPSBhd2FpdCBjb3JlUHJvbWlzZQogICAgaWYgKGNvcmUgPT09IG51bGwpIHJldHVybiBudWxsCgogICAgbGV0IHsgZGF0YVBvaW50ZXIsIGNvcmVQb2ludGVyIH0gPSBjb3JlCgogICAgY29uc3QgcHRyID0geyBjb3JlUG9pbnRlciwgZGF0YVBvaW50ZXIsIGRlcGVuZGVuY2llczogW10gfQoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVSWCh7IGRhdGFQb2ludGVyLCBjb3JlUG9pbnRlcjogMCwgZGVwZW5kZW5jaWVzOiBbXSB9LCB0aGlzLmRiLCBFTVBUWSkKICAgICAgY29uc3QgZGVwZW5kZW5jeVByb21pc2UgPSByeC5nZXREZXBlbmRlbmN5KCkKICAgICAgcngudHJ5Rmx1c2goKQogICAgICBjb25zdCBkZXBlbmRlbmN5ID0gYXdhaXQgZGVwZW5kZW5jeVByb21pc2UKICAgICAgaWYgKCFkZXBlbmRlbmN5KSBicmVhawogICAgICBwdHIuZGVwZW5kZW5jaWVzLnB1c2goZGVwZW5kZW5jeSkKICAgICAgZGF0YVBvaW50ZXIgPSBkZXBlbmRlbmN5LmRhdGFQb2ludGVyCiAgICB9CgogICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuZGIuc2Vzc2lvbigpCiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgSHlwZXJjb3JlU3RvcmFnZS5leHBvcnQocHRyLCBzZXNzaW9uLCBvcHRzKQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgc2Vzc2lvbi5jbG9zZSgpCiAgICB9CiAgfQoKICBhc3luYyBfcmVzdW1lRnJvbVBvaW50ZXJzKHZpZXcsIGRpc2NvdmVyeUtleSwgY3JlYXRlLCB7IHZlcnNpb24sIGNvcmVQb2ludGVyLCBkYXRhUG9pbnRlciB9KSB7CiAgICBjb25zdCBjb3JlID0geyBjb3JlUG9pbnRlciwgZGF0YVBvaW50ZXIsIGRlcGVuZGVuY2llczogW10gfQoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVSWCh7IGRhdGFQb2ludGVyLCBjb3JlUG9pbnRlcjogMCwgZGVwZW5kZW5jaWVzOiBbXSB9LCB0aGlzLmRiLCB2aWV3KQogICAgICBjb25zdCBkZXBlbmRlbmN5UHJvbWlzZSA9IHJ4LmdldERlcGVuZGVuY3koKQogICAgICByeC50cnlGbHVzaCgpCiAgICAgIGNvbnN0IGRlcGVuZGVuY3kgPSBhd2FpdCBkZXBlbmRlbmN5UHJvbWlzZQogICAgICBpZiAoIWRlcGVuZGVuY3kpIGJyZWFrCiAgICAgIGNvcmUuZGVwZW5kZW5jaWVzLnB1c2goZGVwZW5kZW5jeSkKICAgICAgZGF0YVBvaW50ZXIgPSBkZXBlbmRlbmN5LmRhdGFQb2ludGVyCiAgICB9CgogICAgY29uc3QgcmVzdWx0ID0gbmV3IEh5cGVyY29yZVN0b3JhZ2UodGhpcywgdGhpcy5kYi5zZXNzaW9uKCksIGNvcmUsIEVNUFRZLCBudWxsKQoKICAgIGlmICh2ZXJzaW9uIDwgVkVSU0lPTikgYXdhaXQgdGhpcy5fbWlncmF0ZUNvcmUocmVzdWx0LCBkaXNjb3ZlcnlLZXksIHZlcnNpb24sIGNyZWF0ZSkKICAgIHJldHVybiByZXN1bHQKICB9CgogIC8vIG5vdCBhbGxvd2VkIHRvIHRocm93IHZhbGlkYXRpb24gZXJyb3JzIGFzIGl0cyBhIHNoYXJlZCB0eCEKICBhc3luYyBfY3JlYXRlKAogICAgdmlldywKICAgIHsga2V5LCBtYW5pZmVzdCwga2V5UGFpciwgZW5jcnlwdGlvbktleSwgZGlzY292ZXJ5S2V5LCBhbGlhcywgdXNlckRhdGEsIGNvcmU6IHB0cnMgfQogICkgewogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgdmlldykKICAgIGNvbnN0IHR4ID0gbmV3IENvcmVzdG9yZVRYKHZpZXcpCgogICAgY29uc3QgY29yZVByb21pc2UgPSByeC5nZXRDb3JlKGRpc2NvdmVyeUtleSkKICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGxldCBbY29yZSwgaGVhZF0gPSBhd2FpdCBQcm9taXNlLmFsbChbY29yZVByb21pc2UsIGhlYWRQcm9taXNlXSkKICAgIGlmIChjb3JlKSByZXR1cm4gdGhpcy5fcmVzdW1lRnJvbVBvaW50ZXJzKHZpZXcsIGRpc2NvdmVyeUtleSwgdHJ1ZSwgY29yZSkKCiAgICBpZiAoaGVhZCA9PT0gbnVsbCkgaGVhZCA9IGluaXRTdG9yZUhlYWQoKQogICAgaWYgKGhlYWQuZGVmYXVsdERpc2NvdmVyeUtleSA9PT0gbnVsbCkgaGVhZC5kZWZhdWx0RGlzY292ZXJ5S2V5ID0gZGlzY292ZXJ5S2V5CgogICAgY29uc3QgY29yZVBvaW50ZXIgPSBwdHJzID8gcHRycy5jb3JlUG9pbnRlciA6IGhlYWQuYWxsb2NhdGVkLmNvcmVzKysKICAgIGNvbnN0IGRhdGFQb2ludGVyID0gcHRycyA/IHB0cnMuZGF0YVBvaW50ZXIgOiBoZWFkLmFsbG9jYXRlZC5kYXRhcysrCgogICAgY29yZSA9IHsgdmVyc2lvbjogVkVSU0lPTiwgY29yZVBvaW50ZXIsIGRhdGFQb2ludGVyLCBhbGlhcyB9CgogICAgdHguc2V0SGVhZChoZWFkKQogICAgdHgucHV0Q29yZShkaXNjb3ZlcnlLZXksIGNvcmUpCiAgICBpZiAoYWxpYXMpIHR4LnB1dENvcmVCeUFsaWFzKGFsaWFzLCBkaXNjb3ZlcnlLZXkpCgogICAgY29uc3QgcHRyID0geyBjb3JlUG9pbnRlciwgZGF0YVBvaW50ZXIsIGRlcGVuZGVuY2llczogW10gfQogICAgY29uc3QgY3R4ID0gbmV3IENvcmVUWChwdHIsIHRoaXMuZGIsIHZpZXcsIHR4LmNoYW5nZXMpCgogICAgY3R4LnNldEF1dGgoewogICAgICBrZXksCiAgICAgIGRpc2NvdmVyeUtleSwKICAgICAgbWFuaWZlc3QsCiAgICAgIGtleVBhaXIsCiAgICAgIGVuY3J5cHRpb25LZXkKICAgIH0pCgogICAgaWYgKHVzZXJEYXRhKSB7CiAgICAgIGZvciAoY29uc3QgeyBrZXksIHZhbHVlIH0gb2YgdXNlckRhdGEpIHsKICAgICAgICBjdHgucHV0VXNlckRhdGEoa2V5LCB2YWx1ZSkKICAgICAgfQogICAgfQoKICAgIHR4LmFwcGx5KCkKCiAgICByZXR1cm4gbmV3IEh5cGVyY29yZVN0b3JhZ2UodGhpcywgdGhpcy5kYi5zZXNzaW9uKCksIHB0ciwgRU1QVFksIG51bGwpCiAgfQoKICBhc3luYyBjcmVhdGVDb3JlKGRhdGEpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgY29uc3QgdmlldyA9IGF3YWl0IHRoaXMuX2VudGVyKCkKCiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fY3JlYXRlKHZpZXcsIGRhdGEpCiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCB0aGlzLl9leGl0KCkKICAgIH0KICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gQ29yZXN0b3JlU3RvcmFnZQoKZnVuY3Rpb24gaW5pdFN0b3JlSGVhZCgpIHsKICByZXR1cm4gewogICAgdmVyc2lvbjogMCwgLy8gY2F1c2Ugd2Ugd2FubmEgcnVuIHRoZSBtaWdyYXRpb24KICAgIGFsbG9jYXRlZDogewogICAgICBkYXRhczogMCwKICAgICAgY29yZXM6IDAKICAgIH0sCiAgICBzZWVkOiBudWxsLAogICAgZGVmYXVsdERpc2NvdmVyeUtleTogbnVsbAogIH0KfQoKZnVuY3Rpb24gZ2V0QmF0Y2goc2Vzc2lvbnMsIG5hbWUsIGFsbG9jKSB7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZXNzaW9ucy5sZW5ndGg7IGkrKykgewogICAgaWYgKHNlc3Npb25zW2ldLm5hbWUgPT09IG5hbWUpIHJldHVybiBzZXNzaW9uc1tpXQogIH0KCiAgaWYgKCFhbGxvYykgcmV0dXJuIG51bGwKCiAgY29uc3QgcmVzdWx0ID0geyBuYW1lLCBkYXRhUG9pbnRlcjogLTEgfQogIHNlc3Npb25zLnB1c2gocmVzdWx0KQogIHJldHVybiByZXN1bHQKfQoKZnVuY3Rpb24gaXNDb3Jlc3RvcmVTdG9yYWdlKHMpIHsKICByZXR1cm4gdHlwZW9mIHMgPT09ICdvYmplY3QnICYmICEhcyAmJiB0eXBlb2Ygcy5zZXREZWZhdWx0RGlzY292ZXJ5S2V5ID09PSAnZnVuY3Rpb24nCn0KCmZ1bmN0aW9uIGNyZWF0ZUNvbHVtbkZhbWlseShkYiwgb3B0cyA9IHt9KSB7CiAgY29uc3QgewogICAgdGFibGVDYWNoZUluZGV4QW5kRmlsdGVyQmxvY2tzID0gdHJ1ZSwKICAgIGJsb2NrQ2FjaGUgPSB0cnVlLAogICAgb3B0aW1pemVGaWx0ZXJzRm9yTWVtb3J5ID0gZmFsc2UKICB9ID0gb3B0cwoKICBjb25zdCBjb2wgPSBuZXcgUm9ja3NEQi5Db2x1bW5GYW1pbHkoQ09MVU1OX0ZBTUlMWSwgewogICAgZW5hYmxlQmxvYkZpbGVzOiB0cnVlLAogICAgbWluQmxvYlNpemU6IDQwOTYsCiAgICBibG9iRmlsZVNpemU6IDI1NiAqIDEwMjQgKiAxMDI0LAogICAgZW5hYmxlQmxvYkdhcmJhZ2VDb2xsZWN0aW9uOiB0cnVlLAogICAgdGFibGVCbG9ja1NpemU6IDgxOTIsCiAgICB0YWJsZUNhY2hlSW5kZXhBbmRGaWx0ZXJCbG9ja3MsCiAgICB0YWJsZUZvcm1hdFZlcnNpb246IDYsCiAgICBvcHRpbWl6ZUZpbHRlcnNGb3JNZW1vcnksCiAgICBibG9ja0NhY2hlCiAgfSkKCiAgcmV0dXJuIGRiLmNvbHVtbkZhbWlseShjb2wpCn0KCi8vIFRPRE86IHJlbW92ZSBpbiBsaWtlIDMtNiBtbwpmdW5jdGlvbiB0bXBGaXhTdG9yYWdlKHApIHsKICAvLyBpZiBDT1JFU1RPUkUgZmlsZSBpcyB3cml0dGVuLCBuZXcgZm9ybWF0CiAgaWYgKGZzLmV4aXN0c1N5bmMocGF0aC5qb2luKHAsICdDT1JFU1RPUkUnKSkpIHJldHVybgoKICBsZXQgZmlsZXMgPSBbXQoKICB0cnkgewogICAgZmlsZXMgPSBmcy5yZWFkZGlyU3luYyhwKQogIH0gY2F0Y2gge30KCiAgY29uc3Qgbm90Um9ja3MgPSBuZXcgU2V0KFsKICAgICdDT1JFU1RPUkUnLAogICAgJ3ByaW1hcnkta2V5JywKICAgICdjb3JlcycsCiAgICAnYXBwLXByZWZlcmVuY2VzJywKICAgICdjYWNoZScsCiAgICAncHJlZmVyZW5jZXMuanNvbicsCiAgICAnZGInLAogICAgJ2Nsb25lJywKICAgICdjb3JlJywKICAgICdub3RpZmljYXRpb25zJwogIF0pCgogIGZvciAoY29uc3QgZiBvZiBmaWxlcykgewogICAgaWYgKG5vdFJvY2tzLmhhcyhmKSkgY29udGludWUKCiAgICB0cnkgewogICAgICBmcy5ta2RpclN5bmMocGF0aC5qb2luKHAsICdkYicpKQogICAgfSBjYXRjaCB7fQoKICAgIGZzLnJlbmFtZVN5bmMocGF0aC5qb2luKHAsIGYpLCBwYXRoLmpvaW4ocCwgJ2RiJywgZikpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBleHBvcnREYXRhKHB0ciwgZGIsIG9wdHMpIHsKICAvLyBqdXN0IG5lZWQgZGF0YVBvaW50ZXIKICBjb25zdCByZWFkcyA9IFsKICAgIHRvQXJyYXkoY3JlYXRlQmxvY2tTdHJlYW0ocHRyLCBkYiwgRU1QVFksIG9wdHMpKSwKICAgIHRvQXJyYXkoY3JlYXRlVHJlZU5vZGVTdHJlYW0ocHRyLCBkYiwgRU1QVFksIG9wdHMpKSwKICAgIHRvQXJyYXkoY3JlYXRlQml0ZmllbGRTdHJlYW0ocHRyLCBkYiwgRU1QVFksIG9wdHMpKQogIF0KCiAgY29uc3QgW2Jsb2NrcywgdHJlZSwgYml0ZmllbGRdID0gYXdhaXQgUHJvbWlzZS5hbGwocmVhZHMpCgogIHJldHVybiB7CiAgICBibG9ja3MsCiAgICB0cmVlLAogICAgYml0ZmllbGQKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHRvQXJyYXkoc3RyZWFtKSB7CiAgY29uc3QgYWxsID0gW10KICBmb3IgYXdhaXQgKGNvbnN0IGUgb2Ygc3RyZWFtKSBhbGwucHVzaChlKQogIHJldHVybiBhbGwKfQoKZnVuY3Rpb24gbm9vcCgpIHt9Cgphc3luYyBmdW5jdGlvbiBnZXRJbmZvRnJvbUJhdGNoKGRiLCBjLCBkaXNjb3ZlcnlLZXksIGdldEF1dGgsIGdldEhlYWQsIGdldEhpbnRzKSB7CiAgY29uc3QgYXV0aFByb21pc2UgPSBnZXRBdXRoID8gQ29yZVJYLmdldEF1dGgoZGIsIGMpIDogbnVsbAogIGNvbnN0IGhlYWRQcm9taXNlID0gZ2V0SGVhZCA/IENvcmVSWC5nZXRIZWFkKGRiLCBjKSA6IG51bGwKICBjb25zdCBoaW50c1Byb21pc2UgPSBnZXRIaW50cyA/IENvcmVSWC5nZXRIaW50cyhkYiwgYykgOiBudWxsCgogIC8vIGVuc3VyZSBubyB1bmNhdWdodHMKICBpZiAoYXV0aFByb21pc2UpIGF1dGhQcm9taXNlLmNhdGNoKG5vb3ApCiAgaWYgKGhlYWRQcm9taXNlKSBoZWFkUHJvbWlzZS5jYXRjaChub29wKQogIGlmIChoaW50c1Byb21pc2UpIGhpbnRzUHJvbWlzZS5jYXRjaChub29wKQoKICByZXR1cm4gewogICAgZGlzY292ZXJ5S2V5LAogICAgY29yZTogYywKICAgIGF1dGg6IGF3YWl0IGF1dGhQcm9taXNlLAogICAgaGVhZDogYXdhaXQgaGVhZFByb21pc2UsCiAgICBoaW50czogYXdhaXQgaGludHNQcm9taXNlCiAgfQp9CmNvbnN0IHsgUmVhZGFibGUsIGdldFN0cmVhbUVycm9yIH0gPSByZXF1aXJlKCdzdHJlYW14JykKY29uc3QgeyBjb3JlIH0gPSByZXF1aXJlKCcuL2tleXMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBCbG9ja1N0cmVhbSBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3Rvcihjb3JlLCBkYiwgdXBkYXRlcywgc3RhcnQsIGVuZCwgcmV2ZXJzZSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMuZGIgPSBkYgogICAgdGhpcy51cGRhdGVzID0gdXBkYXRlcwogICAgdGhpcy5zdGFydCA9IHN0YXJ0CiAgICB0aGlzLmVuZCA9IGVuZAogICAgdGhpcy5yZXZlcnNlID0gcmV2ZXJzZSA9PT0gdHJ1ZQoKICAgIHRoaXMuX2RyYWluZWQgPSB0cnVlCiAgICB0aGlzLl9jb25zdW1lZCA9IDAKICAgIHRoaXMuX3N0cmVhbSA9IG51bGwKICAgIHRoaXMuX29uY2xvc2VCb3VuZCA9IHRoaXMuX29uY2xvc2UuYmluZCh0aGlzKQogICAgdGhpcy5fbWF5YmVEcmFpbkJvdW5kID0gdGhpcy5fbWF5YmVEcmFpbi5iaW5kKHRoaXMpCgogICAgdGhpcy5fdXBkYXRlKCkKICB9CgogIF91cGRhdGUoKSB7CiAgICBpZiAodGhpcy5fY29uc3VtZWQgPiB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzLmxlbmd0aCkgcmV0dXJuCgogICAgY29uc3QgZGVwcyA9IHRoaXMuY29yZS5kZXBlbmRlbmNpZXMKICAgIGNvbnN0IGluZGV4ID0gdGhpcy5fZmluZERlcGVuZGVuY3lJbmRleChkZXBzKQoKICAgIGNvbnN0IGN1cnIgPSBpbmRleCA8IGRlcHMubGVuZ3RoID8gZGVwc1tpbmRleF0gOiBudWxsCiAgICBjb25zdCBwcmV2ID0gaW5kZXggPiAwICYmIGluZGV4IC0gMSA8IGRlcHMubGVuZ3RoID8gZGVwc1tpbmRleCAtIDFdIDogbnVsbAoKICAgIGNvbnN0IHN0YXJ0ID0gcHJldiAmJiBwcmV2Lmxlbmd0aCA+IHRoaXMuc3RhcnQgPyBwcmV2Lmxlbmd0aCA6IHRoaXMuc3RhcnQKICAgIGNvbnN0IGVuZCA9IGN1cnIgJiYgKHRoaXMuZW5kID09PSAtMSB8fCBjdXJyLmxlbmd0aCA8IHRoaXMuZW5kKSA/IGN1cnIubGVuZ3RoIDogdGhpcy5lbmQKCiAgICBjb25zdCBwdHIgPSBjdXJyID8gY3Vyci5kYXRhUG9pbnRlciA6IHRoaXMuY29yZS5kYXRhUG9pbnRlcgoKICAgIHRoaXMuX21ha2VTdHJlYW0oY29yZS5ibG9jayhwdHIsIHN0YXJ0KSwgY29yZS5ibG9jayhwdHIsIGVuZCkpCiAgfQoKICBfZmluZERlcGVuZGVuY3lJbmRleChkZXBzKSB7CiAgICBpZiAoIXRoaXMucmV2ZXJzZSkgcmV0dXJuIHRoaXMuX2NvbnN1bWVkKysKCiAgICBsZXQgaSA9IGRlcHMubGVuZ3RoIC0gdGhpcy5fY29uc3VtZWQrKwogICAgd2hpbGUgKGkgPiAwKSB7CiAgICAgIGlmIChkZXBzW2kgLSAxXS5sZW5ndGggPD0gdGhpcy5lbmQpIHJldHVybiBpCiAgICAgIGktLQogICAgICB0aGlzLl9jb25zdW1lZCsrCiAgICB9CgogICAgcmV0dXJuIDAKICB9CgogIF9wcmVkZXN0cm95KCkgewogICAgaWYgKHRoaXMuX3N0cmVhbSAhPT0gbnVsbCkgdGhpcy5fc3RyZWFtLmRlc3Ryb3koKQogIH0KCiAgX3JlYWQoY2IpIHsKICAgIHRoaXMuX2RyYWluZWQgPSB0aGlzLl9vbnJlYWRhYmxlKCkKICAgIGNiKG51bGwpCiAgfQoKICBfbWF5YmVEcmFpbigpIHsKICAgIGlmICh0aGlzLl9kcmFpbmVkID09PSB0cnVlKSByZXR1cm4KICAgIHRoaXMuX2RyYWluZWQgPSB0aGlzLl9vbnJlYWRhYmxlKCkKICB9CgogIF9vbnJlYWRhYmxlKCkgewogICAgaWYgKHRoaXMuX3N0cmVhbSA9PT0gbnVsbCkgewogICAgICB0aGlzLnB1c2gobnVsbCkKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBsZXQgZGF0YSA9IHRoaXMuX3N0cmVhbS5yZWFkKCkKCiAgICBpZiAoZGF0YSA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogICAgZG8gewogICAgICB0aGlzLnB1c2goZGF0YSkKICAgICAgZGF0YSA9IHRoaXMuX3N0cmVhbS5yZWFkKCkKICAgIH0gd2hpbGUgKGRhdGEgIT09IG51bGwpCgogICAgcmV0dXJuIHRydWUKICB9CgogIF9vbmNsb3NlKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWluZykgcmV0dXJuCgogICAgY29uc3QgZXJyID0gZ2V0U3RyZWFtRXJyb3IodGhpcy5fc3RyZWFtKQoKICAgIGlmIChlcnIgIT09IG51bGwpIHsKICAgICAgdGhpcy5kZXN0cm95KGVycikKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gZW1wdHkgdGhlIGN1cnJlbnQgc3RyZWFtCiAgICBpZiAodGhpcy5fb25yZWFkYWJsZSgpID09PSB0cnVlKSB0aGlzLl9kcmFpbmVkID0gdHJ1ZQoKICAgIHRoaXMuX3N0cmVhbSA9IG51bGwKCiAgICB0aGlzLl91cGRhdGUoKQogICAgdGhpcy5fbWF5YmVEcmFpbigpCiAgfQoKICBfbWFrZVN0cmVhbShzdGFydCwgZW5kKSB7CiAgICB0aGlzLl9zdHJlYW0gPSB0aGlzLnVwZGF0ZXMuaXRlcmF0b3IodGhpcy5kYiwgc3RhcnQsIGVuZCwgdGhpcy5yZXZlcnNlKQogICAgdGhpcy5fc3RyZWFtLm9uKCdyZWFkYWJsZScsIHRoaXMuX21heWJlRHJhaW5Cb3VuZCkKICAgIHRoaXMuX3N0cmVhbS5vbignZXJyb3InLCBub29wKQogICAgdGhpcy5fc3RyZWFtLm9uKCdjbG9zZScsIHRoaXMuX29uY2xvc2VCb3VuZCkKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCB7IFJlYWRhYmxlIH0gPSByZXF1aXJlKCdzdHJlYW14JykKCi8vIHVzZWQgZm9yIHJldHVybmVkIGEgc3RyZWFtIHRoYXQganVzdCBlcnJvcnMgKGR1cmluZyByZWFkIGR1cmluZyB0ZWFyZG93bikKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ2xvc2VFcnJvclN0cmVhbSBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3RvcihlcnIpIHsKICAgIHN1cGVyKCkKICAgIHRoaXMuZXJyb3IgPSBlcnIKICB9CgogIF9vcGVuKGNiKSB7CiAgICBjYih0aGlzLmVycm9yKQogIH0KfQpjb25zdCB7IFVJTlQsIFNUUklORyB9ID0gcmVxdWlyZSgnaW5kZXgtZW5jb2RlcicpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IFRMX0hFQUQgPSAwCmNvbnN0IFRMX0NPUkVfQllfREtFWSA9IDEKY29uc3QgVExfQ09SRV9CWV9BTElBUyA9IDIKY29uc3QgVExfQ09SRSA9IDMKY29uc3QgVExfREFUQSA9IDQKCmNvbnN0IFRMX0VORCA9IFRMX0RBVEEgKyAxCgpjb25zdCBDT1JFX0FVVEggPSAwCmNvbnN0IENPUkVfU0VTU0lPTlMgPSAxCgpjb25zdCBEQVRBX0hFQUQgPSAwCmNvbnN0IERBVEFfREVQRU5ERU5DWSA9IDEKY29uc3QgREFUQV9ISU5UUyA9IDIKY29uc3QgREFUQV9CTE9DSyA9IDMKY29uc3QgREFUQV9UUkVFID0gNApjb25zdCBEQVRBX0JJVEZJRUxEID0gNQpjb25zdCBEQVRBX1VTRVJfREFUQSA9IDYKY29uc3QgREFUQV9MT0NBTCA9IDcKCmNvbnN0IHNsYWIgPSB7IGJ1ZmZlcjogYjRhLmFsbG9jVW5zYWZlKDY1NTM2KSwgc3RhcnQ6IDAsIGVuZDogMCB9Cgpjb25zdCBzdG9yZSA9IHt9CmNvbnN0IGNvcmUgPSB7fQoKc3RvcmUuY2xlYXIgPSBmdW5jdGlvbiAoKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgbGV0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgMCkKICBjb25zdCBhID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKICBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0VORCkKICBjb25zdCBiID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKICByZXR1cm4gW2EsIGJdCn0KCnN0b3JlLmhlYWQgPSBmdW5jdGlvbiAoKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9IRUFEKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9CgpzdG9yZS5jb3JlID0gZnVuY3Rpb24gKGRpc2NvdmVyeUtleSkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRV9CWV9ES0VZKQogIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIGRpc2NvdmVyeUtleSkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKc3RvcmUuY29yZVN0YXJ0ID0gZnVuY3Rpb24gKCkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRV9CWV9ES0VZKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9CgpzdG9yZS5jb3JlRW5kID0gZnVuY3Rpb24gKCkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRV9CWV9ES0VZICsgMSkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKc3RvcmUuY29yZUJ5QWxpYXMgPSBmdW5jdGlvbiAoeyBuYW1lc3BhY2UsIG5hbWUgfSkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRV9CWV9BTElBUykKICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBuYW1lc3BhY2UpCiAgU1RSSU5HLmVuY29kZShzdGF0ZSwgbmFtZSkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKc3RvcmUuY29yZUJ5QWxpYXNTdGFydCA9IGZ1bmN0aW9uIChuYW1lc3BhY2UpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0NPUkVfQllfQUxJQVMpCiAgaWYgKG5hbWVzcGFjZSkgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbmFtZXNwYWNlKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9CgpzdG9yZS5jb3JlQnlBbGlhc0VuZCA9IGZ1bmN0aW9uIChuYW1lc3BhY2UpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CgogIGlmIChuYW1lc3BhY2UpIHsKICAgIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9DT1JFX0JZX0FMSUFTKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbmFtZXNwYWNlKQogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHhmZgogIH0gZWxzZSB7CiAgICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRV9CWV9BTElBUyArIDEpCiAgfQoKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKc3RvcmUuYWxpYXMgPSBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlciwgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGggfQogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBucwogIGNvbnN0IG5hbWVzcGFjZSA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgY29uc3QgbmFtZSA9IFNUUklORy5kZWNvZGUoc3RhdGUpCiAgcmV0dXJuIHsgbmFtZXNwYWNlLCBuYW1lIH0KfQoKc3RvcmUuZGlzY292ZXJ5S2V5ID0gZnVuY3Rpb24gKGJ1ZmZlcikgewogIGNvbnN0IHN0YXRlID0geyBidWZmZXIsIHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoIH0KICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gbnMKICByZXR1cm4gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKfQoKY29yZS5jb3JlID0gZnVuY3Rpb24gKHB0cikgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLmRhdGEgPSBmdW5jdGlvbiAocHRyKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUuYXV0aCA9IGZ1bmN0aW9uIChwdHIpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0NPUkUpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgQ09SRV9BVVRIKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLnNlc3Npb25zID0gZnVuY3Rpb24gKHB0cikgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBDT1JFX1NFU1NJT05TKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLmhlYWQgPSBmdW5jdGlvbiAocHRyKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfSEVBRCkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS5kZXBlbmRlbmN5ID0gZnVuY3Rpb24gKHB0cikgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfREFUQSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBEQVRBX0RFUEVOREVOQ1kpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUuaGludHMgPSBmdW5jdGlvbiAocHRyKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfSElOVFMpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUuYmxvY2sgPSBmdW5jdGlvbiAocHRyLCBpbmRleCkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfREFUQSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBEQVRBX0JMT0NLKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBpbmRleCkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS50cmVlID0gZnVuY3Rpb24gKHB0ciwgaW5kZXgpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0RBVEEpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgREFUQV9UUkVFKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBpbmRleCkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS5iaXRmaWVsZCA9IGZ1bmN0aW9uIChwdHIsIGluZGV4LCB0eXBlKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfQklURklFTEQpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIGluZGV4KQogIFVJTlQuZW5jb2RlKHN0YXRlLCB0eXBlKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLnVzZXJEYXRhID0gZnVuY3Rpb24gKHB0ciwga2V5KSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfVVNFUl9EQVRBKQogIFNUUklORy5lbmNvZGUoc3RhdGUsIGtleSkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS51c2VyRGF0YUVuZCA9IGZ1bmN0aW9uIChwdHIpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0RBVEEpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgREFUQV9VU0VSX0RBVEEgKyAxKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLmxvY2FsID0gZnVuY3Rpb24gKHB0ciwga2V5KSB7CiAgaWYgKGtleS5ieXRlTGVuZ3RoID4gMjA0OCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdsb2NhbCBrZXlzIGhhcyBhbiB1cHBlciBsaW1pdCBvZiAyMDQ4IGJ5dGVzIGF0bScpCiAgfQoKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0RBVEEpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgREFUQV9MT0NBTCkKCiAgc3RhdGUuYnVmZmVyLnNldChrZXksIHN0YXRlLnN0YXJ0KQogIHN0YXRlLnN0YXJ0ICs9IGtleS5ieXRlTGVuZ3RoCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUubG9jYWxFbmQgPSBmdW5jdGlvbiAocHRyKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfTE9DQUwgKyAxKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLmJsb2NrSW5kZXggPSBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlciwgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGggfQogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBucwogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBwdHIKICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gdHlwZQogIHJldHVybiBVSU5ULmRlY29kZShzdGF0ZSkKfQoKY29yZS5iaXRmaWVsZEluZGV4QW5kVHlwZSA9IGZ1bmN0aW9uIChidWZmZXIpIHsKICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyLCBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCB9CiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIG5zCiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIHB0cgogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyB0eXBlCiAgcmV0dXJuIFtVSU5ULmRlY29kZShzdGF0ZSksIFVJTlQuZGVjb2RlKHN0YXRlKV0KfQoKY29yZS51c2VyRGF0YUtleSA9IGZ1bmN0aW9uIChidWZmZXIpIHsKICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyLCBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCB9CiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIG5zCiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIHB0cgogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyB0eXBlCiAgcmV0dXJuIFNUUklORy5kZWNvZGUoc3RhdGUpCn0KCmNvcmUubG9jYWxLZXkgPSBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlciwgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGggfQogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBucwogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBwdHIKICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gdHlwZQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIHN0YXRlLmVuZCkKfQoKbW9kdWxlLmV4cG9ydHMgPSB7IHN0b3JlLCBjb3JlIH0KCmZ1bmN0aW9uIGFsbG9jKCkgewogIGlmIChzbGFiLmJ1ZmZlci5ieXRlTGVuZ3RoIC0gc2xhYi5zdGFydCA8IDQwOTYpIHsKICAgIHNsYWIuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHNsYWIuYnVmZmVyLmJ5dGVMZW5ndGgpCiAgICBzbGFiLnN0YXJ0ID0gMAogIH0KICByZXR1cm4gc2xhYgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IEJsb2NrRGVwZW5kZW5jeVN0cmVhbSA9IHJlcXVpcmUoJy4vYmxvY2stZGVwZW5kZW5jeS1zdHJlYW0uanMnKQpjb25zdCB7IGNvcmUsIHN0b3JlIH0gPSByZXF1aXJlKCcuL2tleXMuanMnKQpjb25zdCBzY2hlbWEgPSByZXF1aXJlKCcuLi9zcGVjL2h5cGVyc2NoZW1hJykKCmNvbnN0IENPUkVTVE9SRV9DT1JFID0gc2NoZW1hLmdldEVuY29kaW5nKCdAY29yZXN0b3JlL2NvcmUnKQpjb25zdCBDT1JFX1RSRUVfTk9ERSA9IHNjaGVtYS5nZXRFbmNvZGluZygnQGNvcmUvdHJlZS1ub2RlJykKY29uc3QgRU1QVFkgPSBiNGEuYWxsb2MoMCkKCm1vZHVsZS5leHBvcnRzID0gewogIGNyZWF0ZUJsb2NrU3RyZWFtLAogIGNyZWF0ZUJpdGZpZWxkU3RyZWFtLAogIGNyZWF0ZVVzZXJEYXRhU3RyZWFtLAogIGNyZWF0ZUNvcmVTdHJlYW0sCiAgY3JlYXRlQWxpYXNTdHJlYW0sCiAgY3JlYXRlRGlzY292ZXJ5S2V5U3RyZWFtLAogIGNyZWF0ZVRyZWVOb2RlU3RyZWFtLAogIGNyZWF0ZUxvY2FsU3RyZWFtCn0KCmZ1bmN0aW9uIGNyZWF0ZUNvcmVTdHJlYW0oZGIsIHZpZXcpIHsKICBjb25zdCBzdGFydCA9IHN0b3JlLmNvcmVTdGFydCgpCiAgY29uc3QgZW5kID0gc3RvcmUuY29yZUVuZCgpCgogIGNvbnN0IGl0ZSA9IHZpZXcuaXRlcmF0b3IoZGIsIHN0YXJ0LCBlbmQsIGZhbHNlKQoKICBpdGUuX3JlYWRhYmxlU3RhdGUubWFwID0gbWFwQ29yZQogIHJldHVybiBpdGUKfQoKZnVuY3Rpb24gY3JlYXRlRGlzY292ZXJ5S2V5U3RyZWFtKGRiLCB2aWV3LCBuYW1lc3BhY2UpIHsKICBjb25zdCBzdGFydCA9IG5hbWVzcGFjZSA/IHN0b3JlLmNvcmVCeUFsaWFzU3RhcnQobmFtZXNwYWNlKSA6IHN0b3JlLmNvcmVTdGFydCgpCiAgY29uc3QgZW5kID0gbmFtZXNwYWNlID8gc3RvcmUuY29yZUJ5QWxpYXNFbmQobmFtZXNwYWNlKSA6IHN0b3JlLmNvcmVFbmQoKQoKICBjb25zdCBpdGUgPSB2aWV3Lml0ZXJhdG9yKGRiLCBzdGFydCwgZW5kLCBmYWxzZSkKCiAgaXRlLl9yZWFkYWJsZVN0YXRlLm1hcCA9IG5hbWVzcGFjZSA/IG1hcE5hbWVzcGFjZURpc2NvdmVyeUtleXMgOiBtYXBBbGxEaXNjb3ZlcnlLZXlzCiAgcmV0dXJuIGl0ZQp9CgpmdW5jdGlvbiBjcmVhdGVBbGlhc1N0cmVhbShkYiwgdmlldywgbmFtZXNwYWNlKSB7CiAgY29uc3Qgc3RhcnQgPSBzdG9yZS5jb3JlQnlBbGlhc1N0YXJ0KG5hbWVzcGFjZSkKICBjb25zdCBlbmQgPSBzdG9yZS5jb3JlQnlBbGlhc0VuZChuYW1lc3BhY2UpCgogIGNvbnN0IGl0ZSA9IHZpZXcuaXRlcmF0b3IoZGIsIHN0YXJ0LCBlbmQsIGZhbHNlKQoKICBpdGUuX3JlYWRhYmxlU3RhdGUubWFwID0gbWFwQWxpYXMKICByZXR1cm4gaXRlCn0KCmZ1bmN0aW9uIGNyZWF0ZUJsb2NrSXRlcmF0b3IocHRyLCBkYiwgdmlldywgc3RhcnQsIGVuZCwgcmV2ZXJzZSkgewogIGlmIChwdHIuZGVwZW5kZW5jaWVzLmxlbmd0aCA+IDApIHsKICAgIHJldHVybiBuZXcgQmxvY2tEZXBlbmRlbmN5U3RyZWFtKHB0ciwgZGIsIHZpZXcsIHN0YXJ0LCBlbmQsIHJldmVyc2UpCiAgfQoKICBjb25zdCBzID0gY29yZS5ibG9jayhwdHIuZGF0YVBvaW50ZXIsIHN0YXJ0KQogIGNvbnN0IGUgPSBjb3JlLmJsb2NrKHB0ci5kYXRhUG9pbnRlciwgZW5kID09PSAtMSA/IEluZmluaXR5IDogZW5kKQogIHJldHVybiB2aWV3Lml0ZXJhdG9yKGRiLCBzLCBlLCByZXZlcnNlKQp9CgpmdW5jdGlvbiBjcmVhdGVCbG9ja1N0cmVhbSgKICBwdHIsCiAgZGIsCiAgdmlldywKICB7IGd0ID0gLTEsIGd0ZSA9IGd0ICsgMSwgbHRlID0gLTEsIGx0ID0gbHRlID09PSAtMSA/IC0xIDogbHRlICsgMSwgcmV2ZXJzZSA9IGZhbHNlIH0gPSB7fQopIHsKICBjb25zdCBpdGUgPSBjcmVhdGVCbG9ja0l0ZXJhdG9yKHB0ciwgZGIsIHZpZXcsIGd0ZSwgbHQsIHJldmVyc2UpCgogIGl0ZS5fcmVhZGFibGVTdGF0ZS5tYXAgPSBtYXBCbG9jawogIHJldHVybiBpdGUKfQoKZnVuY3Rpb24gY3JlYXRlQml0ZmllbGRTdHJlYW0oCiAgcHRyLAogIGRiLAogIHZpZXcsCiAgeyBndCA9IC0xLCBndGUgPSBndCArIDEsIGx0ZSA9IC0xLCBsdCA9IGx0ZSA9PT0gLTEgPyAtMSA6IGx0ZSArIDEsIHJldmVyc2UgPSBmYWxzZSB9ID0ge30KKSB7CiAgY29uc3QgcyA9IGNvcmUuYml0ZmllbGQocHRyLmRhdGFQb2ludGVyLCBndGUsIDApCiAgY29uc3QgZSA9IGNvcmUuYml0ZmllbGQocHRyLmRhdGFQb2ludGVyLCBsdCA9PT0gLTEgPyBJbmZpbml0eSA6IGx0LCAwKQogIGNvbnN0IGl0ZSA9IHZpZXcuaXRlcmF0b3IoZGIsIHMsIGUsIGZhbHNlKQoKICBpdGUuX3JlYWRhYmxlU3RhdGUubWFwID0gbWFwQml0ZmllbGQKICByZXR1cm4gaXRlCn0KCi8vIE5PVEU6IHRoaXMgZG9lcyBub3QgZG8gZGVwZW5kZW5jeSBsb29rdXBzIGF0bQpmdW5jdGlvbiBjcmVhdGVUcmVlTm9kZVN0cmVhbSgKICBwdHIsCiAgZGIsCiAgdmlldywKICB7IGd0ID0gLTEsIGd0ZSA9IGd0ICsgMSwgbHRlID0gLTEsIGx0ID0gbHRlID09PSAtMSA/IC0xIDogbHRlICsgMSwgcmV2ZXJzZSA9IGZhbHNlIH0gPSB7fQopIHsKICBjb25zdCBzID0gY29yZS50cmVlKHB0ci5kYXRhUG9pbnRlciwgZ3RlLCAwKQogIGNvbnN0IGUgPSBjb3JlLnRyZWUocHRyLmRhdGFQb2ludGVyLCBsdCA9PT0gLTEgPyBJbmZpbml0eSA6IGx0LCAwKQogIGNvbnN0IGl0ZSA9IHZpZXcuaXRlcmF0b3IoZGIsIHMsIGUsIGZhbHNlKQoKICBpdGUuX3JlYWRhYmxlU3RhdGUubWFwID0gbWFwVHJlZU5vZGUKICByZXR1cm4gaXRlCn0KCmZ1bmN0aW9uIGNyZWF0ZVVzZXJEYXRhU3RyZWFtKAogIHB0ciwKICBkYiwKICB2aWV3LAogIHsgZ3QgPSBudWxsLCBndGUgPSAnJywgbHRlID0gbnVsbCwgbHQgPSBudWxsLCByZXZlcnNlID0gZmFsc2UgfSA9IHt9CikgewogIGlmIChndCAhPT0gbnVsbCB8fCBsdGUgIT09IG51bGwpIHsKICAgIHRocm93IG5ldyBFcnJvcignZ3QgYW5kIGx0ZSBub3QgeWV0IHN1cHBvcnRlZCBmb3IgdXNlciBkYXRhIHN0cmVhbXMnKQogIH0KCiAgY29uc3QgcyA9IGNvcmUudXNlckRhdGEocHRyLmRhdGFQb2ludGVyLCBndGUpCiAgY29uc3QgZSA9IGx0ID09PSBudWxsID8gY29yZS51c2VyRGF0YUVuZChwdHIuZGF0YVBvaW50ZXIpIDogY29yZS51c2VyRGF0YShwdHIuZGF0YVBvaW50ZXIsIGx0KQogIGNvbnN0IGl0ZSA9IHZpZXcuaXRlcmF0b3IoZGIsIHMsIGUsIGZhbHNlKQoKICBpdGUuX3JlYWRhYmxlU3RhdGUubWFwID0gbWFwVXNlckRhdGEKICByZXR1cm4gaXRlCn0KCmZ1bmN0aW9uIGNyZWF0ZUxvY2FsU3RyZWFtKAogIHB0ciwKICBkYiwKICB2aWV3LAogIHsgZ3QgPSBudWxsLCBndGUgPSBFTVBUWSwgbHRlID0gbnVsbCwgbHQgPSBudWxsLCByZXZlcnNlID0gZmFsc2UgfSA9IHt9CikgewogIGlmIChndCAhPT0gbnVsbCB8fCBsdGUgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignZ3QgYW5kIGx0ZSBub3QgeWV0IHN1cHBvcnRlZCBmb3IgbG9jYWwgc3RyZWFtcycpCgogIGNvbnN0IHMgPSBjb3JlLmxvY2FsKHB0ci5kYXRhUG9pbnRlciwgZ3RlKQogIGNvbnN0IGUgPSBsdCA9PT0gbnVsbCA/IGNvcmUubG9jYWxFbmQocHRyLmRhdGFQb2ludGVyKSA6IGNvcmUubG9jYWwocHRyLmRhdGFQb2ludGVyLCBsdCkKICBjb25zdCBpdGUgPSB2aWV3Lml0ZXJhdG9yKGRiLCBzLCBlLCBmYWxzZSkKCiAgaXRlLl9yZWFkYWJsZVN0YXRlLm1hcCA9IG1hcExvY2FsCiAgcmV0dXJuIGl0ZQp9CgpmdW5jdGlvbiBtYXBCaXRmaWVsZChkYXRhKSB7CiAgY29uc3QgW2luZGV4LCB0eXBlXSA9IGNvcmUuYml0ZmllbGRJbmRleEFuZFR5cGUoZGF0YS5rZXkpCiAgaWYgKHR5cGUgIT09IDApIHJldHVybiBudWxsIC8vIGlnbm9yZSBmb3Igbm93CiAgcmV0dXJuIHsgaW5kZXgsIHBhZ2U6IGRhdGEudmFsdWUgfQp9CgpmdW5jdGlvbiBtYXBMb2NhbChkYXRhKSB7CiAgY29uc3Qga2V5ID0gY29yZS5sb2NhbEtleShkYXRhLmtleSkKICByZXR1cm4geyBrZXksIHZhbHVlOiBkYXRhLnZhbHVlIH0KfQoKZnVuY3Rpb24gbWFwVXNlckRhdGEoZGF0YSkgewogIGNvbnN0IGtleSA9IGNvcmUudXNlckRhdGFLZXkoZGF0YS5rZXkpCiAgcmV0dXJuIHsga2V5LCB2YWx1ZTogZGF0YS52YWx1ZSB9Cn0KCmZ1bmN0aW9uIG1hcENvcmUoZGF0YSkgewogIGNvbnN0IGRpc2NvdmVyeUtleSA9IHN0b3JlLmRpc2NvdmVyeUtleShkYXRhLmtleSkKICBjb25zdCBjb3JlID0gQ09SRVNUT1JFX0NPUkUuZGVjb2RlKHsKICAgIHN0YXJ0OiAwLAogICAgZW5kOiBkYXRhLnZhbHVlLmJ5dGVMZW5ndGgsCiAgICBidWZmZXI6IGRhdGEudmFsdWUKICB9KQogIHJldHVybiB7IGRpc2NvdmVyeUtleSwgY29yZSB9Cn0KCmZ1bmN0aW9uIG1hcEFsbERpc2NvdmVyeUtleXMoZGF0YSkgewogIHJldHVybiBzdG9yZS5kaXNjb3ZlcnlLZXkoZGF0YS5rZXkpCn0KCmZ1bmN0aW9uIG1hcE5hbWVzcGFjZURpc2NvdmVyeUtleXMoZGF0YSkgewogIHJldHVybiBkYXRhLnZhbHVlCn0KCmZ1bmN0aW9uIG1hcEFsaWFzKGRhdGEpIHsKICBjb25zdCBhbGlhcyA9IHN0b3JlLmFsaWFzKGRhdGEua2V5KQogIHJldHVybiB7IGFsaWFzLCBkaXNjb3ZlcnlLZXk6IGRhdGEudmFsdWUgfQp9CgpmdW5jdGlvbiBtYXBCbG9jayhkYXRhKSB7CiAgcmV0dXJuIHsgaW5kZXg6IGNvcmUuYmxvY2tJbmRleChkYXRhLmtleSksIHZhbHVlOiBkYXRhLnZhbHVlIH0KfQoKZnVuY3Rpb24gbWFwVHJlZU5vZGUoZGF0YSkgewogIHJldHVybiBDT1JFX1RSRUVfTk9ERS5kZWNvZGUoewogICAgc3RhcnQ6IDAsCiAgICBlbmQ6IGRhdGEudmFsdWUuYnl0ZUxlbmd0aCwKICAgIGJ1ZmZlcjogZGF0YS52YWx1ZQogIH0pCn0KY29uc3Qgc2NoZW1hID0gcmVxdWlyZSgnLi4vc3BlYy9oeXBlcnNjaGVtYScpCmNvbnN0IHsgc3RvcmUsIGNvcmUgfSA9IHJlcXVpcmUoJy4va2V5cy5qcycpCmNvbnN0IFZpZXcgPSByZXF1aXJlKCcuL3ZpZXcuanMnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBmbGF0ID0gcmVxdWlyZSgnZmxhdC10cmVlJykKCmNvbnN0IENPUkVTVE9SRV9IRUFEID0gc2NoZW1hLmdldEVuY29kaW5nKCdAY29yZXN0b3JlL2hlYWQnKQpjb25zdCBDT1JFU1RPUkVfQ09SRSA9IHNjaGVtYS5nZXRFbmNvZGluZygnQGNvcmVzdG9yZS9jb3JlJykKCmNvbnN0IENPUkVfQVVUSCA9IHNjaGVtYS5nZXRFbmNvZGluZygnQGNvcmUvYXV0aCcpCmNvbnN0IENPUkVfU0VTU0lPTlMgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0Bjb3JlL3Nlc3Npb25zJykKY29uc3QgQ09SRV9IRUFEID0gc2NoZW1hLmdldEVuY29kaW5nKCdAY29yZS9oZWFkJykKY29uc3QgQ09SRV9UUkVFX05PREUgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0Bjb3JlL3RyZWUtbm9kZScpCmNvbnN0IENPUkVfREVQRU5ERU5DWSA9IHNjaGVtYS5nZXRFbmNvZGluZygnQGNvcmUvZGVwZW5kZW5jeScpCmNvbnN0IENPUkVfSElOVFMgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0Bjb3JlL2hpbnRzJykKCmNsYXNzIENvcmVUWCB7CiAgY29uc3RydWN0b3IoY29yZSwgZGIsIHZpZXcsIGNoYW5nZXMpIHsKICAgIGlmIChkYi5zbmFwc2hvdHRlZCkgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3Qgb3BlbiBjb3JlIHR4IG9uIHNuYXBzaG90JykKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMuZGIgPSBkYgogICAgdGhpcy52aWV3ID0gdmlldwogICAgdGhpcy5jaGFuZ2VzID0gY2hhbmdlcwogIH0KCiAgc2V0QXV0aChhdXRoKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5hdXRoKHRoaXMuY29yZS5jb3JlUG9pbnRlciksIGVuY29kZShDT1JFX0FVVEgsIGF1dGgpLCBudWxsXSkKICB9CgogIHNldFNlc3Npb25zKHNlc3Npb25zKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5zZXNzaW9ucyh0aGlzLmNvcmUuY29yZVBvaW50ZXIpLCBlbmNvZGUoQ09SRV9TRVNTSU9OUywgc2Vzc2lvbnMpLCBudWxsXSkKICB9CgogIHNldEhlYWQoaGVhZCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUuaGVhZCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIpLCBlbmNvZGUoQ09SRV9IRUFELCBoZWFkKSwgbnVsbF0pCiAgfQoKICBkZWxldGVIZWFkKCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUuaGVhZCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIpLCBudWxsLCBudWxsXSkKICB9CgogIHNldERlcGVuZGVuY3koZGVwKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5kZXBlbmRlbmN5KHRoaXMuY29yZS5kYXRhUG9pbnRlciksIGVuY29kZShDT1JFX0RFUEVOREVOQ1ksIGRlcCksIG51bGxdKQogIH0KCiAgc2V0SGludHMoaGludHMpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLmhpbnRzKHRoaXMuY29yZS5kYXRhUG9pbnRlciksIGVuY29kZShDT1JFX0hJTlRTLCBoaW50cyksIG51bGxdKQogIH0KCiAgcHV0QmxvY2soaW5kZXgsIGRhdGEpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLmJsb2NrKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgaW5kZXgpLCBkYXRhLCBudWxsXSkKICB9CgogIGRlbGV0ZUJsb2NrKGluZGV4KSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5ibG9jayh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGluZGV4KSwgbnVsbCwgbnVsbF0pCiAgfQoKICBkZWxldGVCbG9ja1JhbmdlKHN0YXJ0LCBlbmQpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFsKICAgICAgY29yZS5ibG9jayh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIHN0YXJ0KSwKICAgICAgbnVsbCwKICAgICAgY29yZS5ibG9jayh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGVuZCA9PT0gLTEgPyBJbmZpbml0eSA6IGVuZCkKICAgIF0pCiAgfQoKICBwdXRCaXRmaWVsZFBhZ2UoaW5kZXgsIGRhdGEpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLmJpdGZpZWxkKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgaW5kZXgsIDApLCBkYXRhLCBudWxsXSkKICB9CgogIGRlbGV0ZUJpdGZpZWxkUGFnZShpbmRleCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUuYml0ZmllbGQodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBpbmRleCwgMCksIG51bGwsIG51bGxdKQogIH0KCiAgZGVsZXRlQml0ZmllbGRQYWdlUmFuZ2Uoc3RhcnQsIGVuZCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goWwogICAgICBjb3JlLmJpdGZpZWxkKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgc3RhcnQsIDApLAogICAgICBudWxsLAogICAgICBjb3JlLmJpdGZpZWxkKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgZW5kID09PSAtMSA/IEluZmluaXR5IDogZW5kLCAwKQogICAgXSkKICB9CgogIHB1dFRyZWVOb2RlKG5vZGUpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFsKICAgICAgY29yZS50cmVlKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgbm9kZS5pbmRleCksCiAgICAgIGVuY29kZShDT1JFX1RSRUVfTk9ERSwgbm9kZSksCiAgICAgIG51bGwKICAgIF0pCiAgfQoKICBkZWxldGVUcmVlTm9kZShpbmRleCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUudHJlZSh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGluZGV4KSwgbnVsbCwgbnVsbF0pCiAgfQoKICBkZWxldGVUcmVlTm9kZVJhbmdlKHN0YXJ0LCBlbmQpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFsKICAgICAgY29yZS50cmVlKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgc3RhcnQpLAogICAgICBudWxsLAogICAgICBjb3JlLnRyZWUodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBlbmQgPT09IC0xID8gSW5maW5pdHkgOiBlbmQpCiAgICBdKQogIH0KCiAgcHV0VXNlckRhdGEoa2V5LCB2YWx1ZSkgewogICAgY29uc3QgYnVmZmVyID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IGI0YS5mcm9tKHZhbHVlKSA6IHZhbHVlCiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS51c2VyRGF0YSh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGtleSksIGJ1ZmZlciwgbnVsbF0pCiAgfQoKICBkZWxldGVVc2VyRGF0YShrZXkpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLnVzZXJEYXRhKHRoaXMuY29yZS5kYXRhUG9pbnRlciwga2V5KSwgbnVsbCwgbnVsbF0pCiAgfQoKICBwdXRMb2NhbChrZXksIHZhbHVlKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5sb2NhbCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGtleSksIHZhbHVlLCBudWxsXSkKICB9CgogIGRlbGV0ZUxvY2FsKGtleSkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUubG9jYWwodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBrZXkpLCBudWxsLCBudWxsXSkKICB9CgogIGRlbGV0ZUxvY2FsUmFuZ2Uoc3RhcnQsIGVuZCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goWwogICAgICBjb3JlLmxvY2FsKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgc3RhcnQpLAogICAgICBudWxsLAogICAgICBlbmQgPT09IG51bGwgPyBjb3JlLmxvY2FsRW5kKHRoaXMuY29yZS5kYXRhUG9pbnRlcikgOiBjb3JlLmxvY2FsKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgZW5kKQogICAgXSkKICB9CgogIGZsdXNoKCkgewogICAgY29uc3QgY2hhbmdlcyA9IHRoaXMuY2hhbmdlcwogICAgaWYgKGNoYW5nZXMgPT09IG51bGwpIHJldHVybiBQcm9taXNlLnJlc29sdmUoIXRoaXMudmlldykKCiAgICB0aGlzLmNoYW5nZXMgPSBudWxsCgogICAgaWYgKHRoaXMudmlldykgewogICAgICB0aGlzLnZpZXcuYXBwbHkoY2hhbmdlcykKICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxzZSkKICAgIH0KCiAgICByZXR1cm4gVmlldy5mbHVzaChjaGFuZ2VzLCB0aGlzLmRiKQogIH0KfQoKY2xhc3MgQ29yZVJYIHsKICBjb25zdHJ1Y3Rvcihjb3JlLCBkYiwgdmlldykgewogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy5yZWFkID0gZGIucmVhZCh7IGF1dG9EZXN0cm95OiB0cnVlIH0pCiAgICB0aGlzLnZpZXcgPSB2aWV3CgogICAgdmlldy5yZWFkU3RhcnQoKQogIH0KCiAgc3RhdGljIGFzeW5jIGdldEF1dGgoZGIsIGMpIHsKICAgIHJldHVybiBhd2FpdCBkZWNvZGUoQ09SRV9BVVRILCBhd2FpdCBkYi5nZXQoY29yZS5hdXRoKGMuY29yZVBvaW50ZXIpKSkKICB9CgogIGFzeW5jIGdldEF1dGgoKSB7CiAgICByZXR1cm4gYXdhaXQgZGVjb2RlKENPUkVfQVVUSCwgYXdhaXQgdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUuYXV0aCh0aGlzLmNvcmUuY29yZVBvaW50ZXIpKSkKICB9CgogIGFzeW5jIGdldFNlc3Npb25zKCkgewogICAgcmV0dXJuIGF3YWl0IGRlY29kZSgKICAgICAgQ09SRV9TRVNTSU9OUywKICAgICAgYXdhaXQgdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUuc2Vzc2lvbnModGhpcy5jb3JlLmNvcmVQb2ludGVyKSkKICAgICkKICB9CgogIHN0YXRpYyBhc3luYyBnZXRIZWFkKGRiLCBjKSB7CiAgICByZXR1cm4gYXdhaXQgZGVjb2RlKENPUkVfSEVBRCwgYXdhaXQgZGIuZ2V0KGNvcmUuaGVhZChjLmRhdGFQb2ludGVyKSkpCiAgfQoKICBhc3luYyBnZXRIZWFkKCkgewogICAgcmV0dXJuIGF3YWl0IGRlY29kZShDT1JFX0hFQUQsIGF3YWl0IHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBjb3JlLmhlYWQodGhpcy5jb3JlLmRhdGFQb2ludGVyKSkpCiAgfQoKICBhc3luYyBnZXREZXBlbmRlbmN5KCkgewogICAgcmV0dXJuIGF3YWl0IGRlY29kZSgKICAgICAgQ09SRV9ERVBFTkRFTkNZLAogICAgICBhd2FpdCB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgY29yZS5kZXBlbmRlbmN5KHRoaXMuY29yZS5kYXRhUG9pbnRlcikpCiAgICApCiAgfQoKICBzdGF0aWMgYXN5bmMgZ2V0SGludHMoZGIsIGMpIHsKICAgIHJldHVybiBhd2FpdCBkZWNvZGUoQ09SRV9ISU5UUywgYXdhaXQgZGIuZ2V0KGNvcmUuaGludHMoYy5kYXRhUG9pbnRlcikpKQogIH0KCiAgYXN5bmMgZ2V0SGludHMoKSB7CiAgICByZXR1cm4gYXdhaXQgZGVjb2RlKAogICAgICBDT1JFX0hJTlRTLAogICAgICBhd2FpdCB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgY29yZS5oaW50cyh0aGlzLmNvcmUuZGF0YVBvaW50ZXIpKQogICAgKQogIH0KCiAgZ2V0QmxvY2soaW5kZXgpIHsKICAgIGNvbnN0IGRlcCA9IGZpbmRCbG9ja0RlcGVuZGVuY3kodGhpcy5jb3JlLmRlcGVuZGVuY2llcywgaW5kZXgpCiAgICBjb25zdCBkYXRhID0gZGVwID09PSBudWxsID8gdGhpcy5jb3JlLmRhdGFQb2ludGVyIDogZGVwLmRhdGFQb2ludGVyCiAgICByZXR1cm4gdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUuYmxvY2soZGF0YSwgaW5kZXgpKQogIH0KCiAgZ2V0Qml0ZmllbGRQYWdlKGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUuYml0ZmllbGQodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBpbmRleCwgMCkpCiAgfQoKICBhc3luYyBnZXRUcmVlTm9kZShpbmRleCkgewogICAgY29uc3QgZGVwID0gZmluZFRyZWVEZXBlbmRlbmN5KHRoaXMuY29yZS5kZXBlbmRlbmNpZXMsIGluZGV4KQogICAgY29uc3QgZGF0YSA9IGRlcCA9PT0gbnVsbCA/IHRoaXMuY29yZS5kYXRhUG9pbnRlciA6IGRlcC5kYXRhUG9pbnRlcgogICAgcmV0dXJuIGRlY29kZShDT1JFX1RSRUVfTk9ERSwgYXdhaXQgdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUudHJlZShkYXRhLCBpbmRleCkpKQogIH0KCiAgYXN5bmMgaGFzVHJlZU5vZGUoaW5kZXgpIHsKICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXRUcmVlTm9kZShpbmRleCkpICE9PSBudWxsCiAgfQoKICBnZXRVc2VyRGF0YShrZXkpIHsKICAgIHJldHVybiB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgY29yZS51c2VyRGF0YSh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGtleSkpCiAgfQoKICBnZXRMb2NhbChrZXkpIHsKICAgIHJldHVybiB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgY29yZS5sb2NhbCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGtleSkpCiAgfQoKICB0cnlGbHVzaCgpIHsKICAgIHRoaXMucmVhZC50cnlGbHVzaCgpCiAgICB0aGlzLl9mcmVlKCkKICB9CgogIGRlc3Ryb3koKSB7CiAgICB0aGlzLnJlYWQuZGVzdHJveSgpCiAgICB0aGlzLl9mcmVlKCkKICB9CgogIF9mcmVlKCkgewogICAgaWYgKHRoaXMudmlldyA9PT0gbnVsbCkgcmV0dXJuCiAgICB0aGlzLnZpZXcucmVhZFN0b3AoKQogICAgdGhpcy52aWV3ID0gbnVsbAogIH0KfQoKY2xhc3MgQ29yZXN0b3JlVFggewogIGNvbnN0cnVjdG9yKHZpZXcpIHsKICAgIHRoaXMudmlldyA9IHZpZXcKICAgIHRoaXMuY2hhbmdlcyA9IFtdCiAgfQoKICBzZXRIZWFkKGhlYWQpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtzdG9yZS5oZWFkKCksIGVuY29kZShDT1JFU1RPUkVfSEVBRCwgaGVhZCksIG51bGxdKQogIH0KCiAgcHV0Q29yZShkaXNjb3ZlcnlLZXksIHB0cikgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW3N0b3JlLmNvcmUoZGlzY292ZXJ5S2V5KSwgZW5jb2RlKENPUkVTVE9SRV9DT1JFLCBwdHIpLCBudWxsXSkKICB9CgogIHB1dENvcmVCeUFsaWFzKGFsaWFzLCBkaXNjb3ZlcnlLZXkpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtzdG9yZS5jb3JlQnlBbGlhcyhhbGlhcyksIGRpc2NvdmVyeUtleSwgbnVsbF0pCiAgfQoKICBjbGVhcigpIHsKICAgIGNvbnN0IFtzdGFydCwgZW5kXSA9IHN0b3JlLmNsZWFyKCkKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtzdGFydCwgbnVsbCwgZW5kXSkKICB9CgogIGFwcGx5KCkgewogICAgaWYgKHRoaXMuY2hhbmdlcyA9PT0gbnVsbCkgcmV0dXJuCiAgICB0aGlzLnZpZXcuYXBwbHkodGhpcy5jaGFuZ2VzKQogICAgdGhpcy5jaGFuZ2VzID0gbnVsbAogIH0KfQoKY2xhc3MgQ29yZXN0b3JlUlggewogIGNvbnN0cnVjdG9yKGRiLCB2aWV3KSB7CiAgICB0aGlzLnJlYWQgPSBkYi5yZWFkKHsgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKICAgIHRoaXMudmlldyA9IHZpZXcKCiAgICB2aWV3LnJlYWRTdGFydCgpCiAgfQoKICBhc3luYyBnZXRIZWFkKCkgewogICAgcmV0dXJuIGRlY29kZShDT1JFU1RPUkVfSEVBRCwgYXdhaXQgdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIHN0b3JlLmhlYWQoKSkpCiAgfQoKICBhc3luYyBnZXRDb3JlKGRpc2NvdmVyeUtleSkgewogICAgcmV0dXJuIGRlY29kZShDT1JFU1RPUkVfQ09SRSwgYXdhaXQgdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIHN0b3JlLmNvcmUoZGlzY292ZXJ5S2V5KSkpCiAgfQoKICBnZXRDb3JlQnlBbGlhcyhhbGlhcykgewogICAgcmV0dXJuIHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBzdG9yZS5jb3JlQnlBbGlhcyhhbGlhcykpCiAgfQoKICB0cnlGbHVzaCgpIHsKICAgIHRoaXMucmVhZC50cnlGbHVzaCgpCiAgICB0aGlzLl9mcmVlKCkKICB9CgogIGRlc3Ryb3koKSB7CiAgICB0aGlzLnJlYWQuZGVzdHJveSgpCiAgICB0aGlzLl9mcmVlKCkKICB9CgogIF9mcmVlKCkgewogICAgaWYgKHRoaXMudmlldyA9PT0gbnVsbCkgcmV0dXJuCiAgICB0aGlzLnZpZXcucmVhZFN0b3AoKQogICAgdGhpcy52aWV3ID0gbnVsbAogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSB7IENvcmVzdG9yZVRYLCBDb3Jlc3RvcmVSWCwgQ29yZVRYLCBDb3JlUlggfQoKZnVuY3Rpb24gZmluZEJsb2NrRGVwZW5kZW5jeShkZXBlbmRlbmNpZXMsIGluZGV4KSB7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZXBlbmRlbmNpZXMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IGRlcCA9IGRlcGVuZGVuY2llc1tpXQogICAgaWYgKGluZGV4IDwgZGVwLmxlbmd0aCkgcmV0dXJuIGRlcAogIH0KCiAgcmV0dXJuIG51bGwKfQoKZnVuY3Rpb24gZmluZFRyZWVEZXBlbmRlbmN5KGRlcGVuZGVuY2llcywgaW5kZXgpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IGRlcGVuZGVuY2llcy5sZW5ndGg7IGkrKykgewogICAgY29uc3QgZGVwID0gZGVwZW5kZW5jaWVzW2ldCiAgICBpZiAoZmxhdC5yaWdodFNwYW4oaW5kZXgpIDw9IChkZXAubGVuZ3RoIC0gMSkgKiAyKSByZXR1cm4gZGVwCiAgfQoKICByZXR1cm4gbnVsbAp9CgpmdW5jdGlvbiBkZWNvZGUoZW5jLCBidWZmZXIpIHsKICBpZiAoYnVmZmVyID09PSBudWxsKSByZXR1cm4gbnVsbAogIHJldHVybiBlbmMuZGVjb2RlKHsgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGgsIGJ1ZmZlciB9KQp9CgpmdW5jdGlvbiBlbmNvZGUoZW5jLCBtKSB7CiAgLy8gVE9ETzogdXNlIGZhbmN5IHNsYWIgZm9yIHNtYWxsIG1lc3NhZ2VzCiAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDAsIGJ1ZmZlcjogbnVsbCB9CiAgZW5jLnByZWVuY29kZShzdGF0ZSwgbSkKICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQogIGVuYy5lbmNvZGUoc3RhdGUsIG0pCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlcgp9CmNvbnN0IHsgUmVhZGFibGUsIGdldFN0cmVhbUVycm9yIH0gPSByZXF1aXJlKCdzdHJlYW14JykKY29uc3QgQ2xvc2VFcnJvclN0cmVhbSA9IHJlcXVpcmUoJy4vY2xvc2UtZXJyb3Itc3RyZWFtLmpzJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNsYXNzIE92ZXJsYXlTdHJlYW0gZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3Ioc3RyZWFtLCBzdGFydCwgZW5kLCByZXZlcnNlLCBjaGFuZ2VzLCBjbGVhcmVkKSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5zdGFydCA9IHN0YXJ0CiAgICB0aGlzLmVuZCA9IGVuZAogICAgdGhpcy5yZXZlcnNlID0gcmV2ZXJzZQogICAgdGhpcy5jaGFuZ2VzID0gY2hhbmdlcwogICAgdGhpcy5jbGVhcmVkID0gY2xlYXJlZAogICAgdGhpcy5jaGFuZ2UgPSAwCiAgICB0aGlzLnJhbmdlID0gMAoKICAgIHRoaXMuX3N0cmVhbSA9IHN0cmVhbQogICAgdGhpcy5fZHJhaW5lZCA9IGZhbHNlCgogICAgdGhpcy5fc3RyZWFtLm9uKCdyZWFkYWJsZScsIHRoaXMuX2RyYWluTWF5YmUuYmluZCh0aGlzKSkKICAgIHRoaXMuX3N0cmVhbS5vbignZXJyb3InLCBub29wKQogICAgdGhpcy5fc3RyZWFtLm9uKCdjbG9zZScsIHRoaXMuX29uY2xvc2UuYmluZCh0aGlzKSkKICB9CgogIF9kcmFpbk1heWJlKCkgewogICAgaWYgKHRoaXMuX2RyYWluZWQgPT09IHRydWUpIHJldHVybgogICAgdGhpcy5fZHJhaW5lZCA9IHRoaXMuX29ucmVhZGFibGUoKQogIH0KCiAgX29uY2xvc2UoKSB7CiAgICBpZiAodGhpcy5kZXN0cm95aW5nKSByZXR1cm4KCiAgICBjb25zdCBlcnIgPSBnZXRTdHJlYW1FcnJvcih0aGlzLl9zdHJlYW0pCgogICAgaWYgKGVyciAhPT0gbnVsbCkgewogICAgICB0aGlzLmRlc3Ryb3koZXJyKQogICAgICByZXR1cm4KICAgIH0KCiAgICB3aGlsZSAodGhpcy5jaGFuZ2UgPCB0aGlzLmNoYW5nZXMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IGMgPSB0aGlzLmNoYW5nZXNbdGhpcy5jaGFuZ2UrK10KICAgICAgY29uc3Qga2V5ID0gY1swXQogICAgICBjb25zdCB2YWx1ZSA9IGNbMV0KCiAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0aGlzLl9pblJhbmdlKGtleSkpIHRoaXMucHVzaCh7IGtleSwgdmFsdWUgfSkKICAgIH0KCiAgICB0aGlzLnB1c2gobnVsbCkKICAgIHRoaXMuX3N0cmVhbSA9IG51bGwKICB9CgogIF9vbnJlYWRhYmxlKCkgewogICAgbGV0IGRhdGEgPSB0aGlzLl9zdHJlYW0ucmVhZCgpCiAgICBpZiAoZGF0YSA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogICAgbGV0IGRyYWluZWQgPSBmYWxzZQoKICAgIGRvIHsKICAgICAgaWYgKHRoaXMuX3B1c2goZGF0YSkgPT09IHRydWUpIGRyYWluZWQgPSB0cnVlCiAgICAgIGRhdGEgPSB0aGlzLl9zdHJlYW0ucmVhZCgpCiAgICB9IHdoaWxlIChkYXRhICE9PSBudWxsKQoKICAgIHJldHVybiBkcmFpbmVkCiAgfQoKICBfcmVhZChjYikgewogICAgdGhpcy5fZHJhaW5lZCA9IHRoaXMuX29ucmVhZGFibGUoKQogICAgY2IobnVsbCkKICB9CgogIF9wcmVkZXN0cm95KCkgewogICAgdGhpcy5zdHJlYW0uZGVzdHJveSgpCiAgfQoKICBfcHVzaChlbnRyeSkgewogICAgY29uc3Qga2V5ID0gZW50cnkua2V5CgogICAgd2hpbGUgKHRoaXMucmFuZ2UgPCB0aGlzLmNsZWFyZWQubGVuZ3RoKSB7CiAgICAgIGNvbnN0IGMgPSB0aGlzLmNsZWFyZWRbdGhpcy5yYW5nZV0KCiAgICAgIC8vIHdlIG1vdmVkIHBhc3QgdGhlIHJhbmdlCiAgICAgIGlmICh0aGlzLnJldmVyc2UgPyBiNGEuY29tcGFyZShrZXksIGNbMF0pIDwgMCA6IGI0YS5jb21wYXJlKGNbMl0sIGtleSkgPD0gMCkgewogICAgICAgIHRoaXMucmFuZ2UrKwogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIC8vIHdlIGRpZG50IG1vdmUgcGFzdCBhbmQgYXJlIGluLCBkcm9wCiAgICAgIGlmIChiNGEuY29tcGFyZShjWzBdLCBrZXkpIDw9IDAgJiYgYjRhLmNvbXBhcmUoa2V5LCBjWzJdKSA8IDApIHsKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQoKICAgICAgYnJlYWsKICAgIH0KCiAgICBsZXQgdXBkYXRlZCA9IGZhbHNlCgogICAgd2hpbGUgKHRoaXMuY2hhbmdlIDwgdGhpcy5jaGFuZ2VzLmxlbmd0aCkgewogICAgICBjb25zdCBjID0gdGhpcy5jaGFuZ2VzW3RoaXMuY2hhbmdlXQogICAgICBjb25zdCBrZXkgPSBjWzBdCiAgICAgIGNvbnN0IHZhbHVlID0gdHlwZW9mIGNbMV0gPT09ICdzdHJpbmcnID8gYjRhLmZyb20oY1sxXSkgOiBjWzFdCiAgICAgIGNvbnN0IGNtcCA9IGI0YS5jb21wYXJlKGtleSwgZW50cnkua2V5KQoKICAgICAgLy8gc2FtZSB2YWx1ZSwgaWYgbm90IGRlbGV0ZWQsIHJldHVybiBuZXcgb25lCiAgICAgIGlmIChjbXAgPT09IDApIHsKICAgICAgICB0aGlzLmNoYW5nZSsrCiAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHRoaXMuX2luUmFuZ2Uoa2V5KSA9PT0gZmFsc2UpIHJldHVybiB1cGRhdGVkCiAgICAgICAgdGhpcy5wdXNoKHsga2V5LCB2YWx1ZSB9KQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KCiAgICAgIC8vIHdlIG1vdmVkIHBhc3QgdGhlIGNoYW5nZSwgcHVzaCBpdAogICAgICBpZiAodGhpcy5yZXZlcnNlID8gY21wID4gMCA6IGNtcCA8IDApIHsKICAgICAgICB0aGlzLmNoYW5nZSsrCiAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHRoaXMuX2luUmFuZ2Uoa2V5KSA9PT0gZmFsc2UpIGNvbnRpbnVlCiAgICAgICAgdGhpcy5wdXNoKHsga2V5LCB2YWx1ZSB9KQogICAgICAgIHVwZGF0ZWQgPSB0cnVlCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgdGhpcy5wdXNoKGVudHJ5KQogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHRoaXMucHVzaChlbnRyeSkKICAgIHJldHVybiB0cnVlCiAgfQoKICBfaW5SYW5nZShrZXkpIHsKICAgIHJldHVybiBiNGEuY29tcGFyZSh0aGlzLnN0YXJ0LCBrZXkpIDw9IDAgJiYgYjRhLmNvbXBhcmUoa2V5LCB0aGlzLmVuZCkgPCAwCiAgfQp9CgpjbGFzcyBPdmVybGF5IHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuaW5kZXhlZCA9IDAKICAgIHRoaXMuY2hhbmdlcyA9IG51bGwKICAgIHRoaXMuY2xlYXJlZCA9IG51bGwKICAgIHRoaXMucmV2ZXJzZSA9IGZhbHNlCiAgfQoKICB1cGRhdGUodmlldywgcmV2ZXJzZSkgewogICAgaWYgKHZpZXcuaW5kZXhlZCA9PT0gdGhpcy5pbmRleGVkKSByZXR1cm4KCiAgICBjb25zdCBjaGFuZ2VzID0gdmlldy5tYXAgPT09IG51bGwgPyBbXSA6IFsuLi52aWV3Lm1hcC52YWx1ZXMoKV0KICAgIGNvbnN0IGNsZWFyZWQgPSB2aWV3LmNsZWFyZWQgPT09IG51bGwgPyBbXSA6IHZpZXcuY2xlYXJlZC5zbGljZSgwKQoKICAgIGNvbnN0IGNtcCA9IHJldmVyc2UgPyBjbXBDaGFuZ2VSZXZlcnNlIDogY21wQ2hhbmdlCgogICAgY2hhbmdlcy5zb3J0KGNtcCkKICAgIGNsZWFyZWQuc29ydChjbXApCgogICAgdGhpcy5pbmRleGVkID0gdmlldy5pbmRleGVkCiAgICB0aGlzLmNoYW5nZXMgPSBjaGFuZ2VzCiAgICB0aGlzLmNsZWFyZWQgPSBjbGVhcmVkCiAgICB0aGlzLnJldmVyc2UgPSByZXZlcnNlCiAgfQoKICBjcmVhdGVTdHJlYW0oc3RyZWFtLCBzdGFydCwgZW5kLCByZXZlcnNlKSB7CiAgICByZXR1cm4gbmV3IE92ZXJsYXlTdHJlYW0oCiAgICAgIHN0cmVhbSwKICAgICAgc3RhcnQsCiAgICAgIGVuZCwKICAgICAgcmV2ZXJzZSwKICAgICAgdGhpcy5yZXZlcnNlID09PSByZXZlcnNlID8gdGhpcy5jaGFuZ2VzIDogcmV2ZXJzZUFycmF5KHRoaXMuY2hhbmdlcyksCiAgICAgIHRoaXMucmV2ZXJzZSA9PT0gcmV2ZXJzZSA/IHRoaXMuY2xlYXJlZCA6IHJldmVyc2VBcnJheSh0aGlzLmNsZWFyZWQpCiAgICApCiAgfQp9CgpjbGFzcyBWaWV3IHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMubWFwID0gbnVsbAogICAgdGhpcy5pbmRleGVkID0gMAogICAgdGhpcy5jaGFuZ2VzID0gbnVsbAogICAgdGhpcy5jbGVhcmVkID0gbnVsbAogICAgdGhpcy5vdmVybGF5ID0gbnVsbAogICAgdGhpcy5zbmFwID0gbnVsbAogICAgdGhpcy5yZWFkZXJzID0gMAogIH0KCiAgc25hcHNob3QoKSB7CiAgICBpZiAodGhpcy5fYXR0YWNoZWQoKSkgcmV0dXJuIHRoaXMuc25hcC5zbmFwc2hvdCgpCgogICAgY29uc3Qgc25hcCA9IG5ldyBWaWV3KCkKCiAgICBzbmFwLm1hcCA9IHRoaXMubWFwCiAgICBzbmFwLmluZGV4ZWQgPSB0aGlzLmluZGV4ZWQKICAgIHNuYXAuY2hhbmdlcyA9IHRoaXMuY2hhbmdlcwogICAgc25hcC5jbGVhcmVkID0gdGhpcy5jbGVhcmVkCgogICAgaWYgKHRoaXMuX2Zyb3plbigpKSByZXR1cm4gc25hcAoKICAgIHRoaXMucmVhZGVycysrCiAgICBzbmFwLnNuYXAgPSB0aGlzCgogICAgcmV0dXJuIHNuYXAKICB9CgogIHJlYWRTdGFydCgpIHsKICAgIGlmICh0aGlzLnNuYXAgIT09IG51bGwpIHRoaXMucmVhZGVycysrCiAgfQoKICByZWFkU3RvcCgpIHsKICAgIGlmICh0aGlzLnNuYXAgIT09IG51bGwgJiYgLS10aGlzLnJlYWRlcnMgPT09IDApIHRoaXMuc25hcC5yZWFkZXJzLS0KICB9CgogIHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5jaGFuZ2VzID09PSBudWxsID8gMCA6IHRoaXMuY2hhbmdlcy5sZW5ndGgKICB9CgogIHVwZGF0ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5jaGFuZ2VzID09PSBudWxsCiAgfQoKICBnZXQocmVhZCwga2V5KSB7CiAgICByZXR1cm4gdGhpcy5jaGFuZ2VzID09PSBudWxsID8gcmVhZC5nZXQoa2V5KSA6IHRoaXMuX2luZGV4QW5kR2V0KHJlYWQsIGtleSkKICB9CgogIHJlc2V0KCkgewogICAgdGhpcy5pbmRleGVkID0gMAogICAgdGhpcy5zbmFwID0gdGhpcy5tYXAgPSB0aGlzLmNoYW5nZXMgPSB0aGlzLmNsZWFyZWQgPSB0aGlzLm92ZXJsYXkgPSBudWxsCiAgfQoKICBpdGVyYXRvcihkYiwgc3RhcnQsIGVuZCwgcmV2ZXJzZSkgewogICAgaWYgKGRiQ2xvc2luZyhkYikpIHJldHVybiBuZXcgQ2xvc2VFcnJvclN0cmVhbShuZXcgRXJyb3IoJ1JvY2tzREIgc2Vzc2lvbiBpcyBjbG9zZWQnKSkKCiAgICBjb25zdCBzdHJlYW0gPSBkYi5pdGVyYXRvcih7IGd0ZTogc3RhcnQsIGx0OiBlbmQsIHJldmVyc2UgfSkKICAgIGlmICh0aGlzLmNoYW5nZXMgPT09IG51bGwpIHJldHVybiBzdHJlYW0KCiAgICB0aGlzLl9pbmRleCgpCgogICAgaWYgKHRoaXMub3ZlcmxheSA9PT0gbnVsbCkgdGhpcy5vdmVybGF5ID0gbmV3IE92ZXJsYXkoKQogICAgdGhpcy5vdmVybGF5LnVwZGF0ZSh0aGlzLCByZXZlcnNlKQogICAgcmV0dXJuIHRoaXMub3ZlcmxheS5jcmVhdGVTdHJlYW0oc3RyZWFtLCBzdGFydCwgZW5kLCByZXZlcnNlKQogIH0KCiAgX2luZGV4QW5kR2V0KHJlYWQsIGtleSkgewogICAgdGhpcy5faW5kZXgoKQogICAgY29uc3QgY2hhbmdlID0gdGhpcy5tYXAuZ2V0KGI0YS50b1N0cmluZyhrZXksICdoZXgnKSkKCiAgICBpZiAoY2hhbmdlID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xlYXJlZCA9PT0gbnVsbCA/IHJlYWQuZ2V0KGtleSkgOiB0aGlzLl9yZWFkQW5kTWF5YmVEcm9wKHJlYWQsIGtleSkKICAgIH0KCiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNoYW5nZVsxXSkKICB9CgogIGFzeW5jIF9yZWFkQW5kTWF5YmVEcm9wKHJlYWQsIGtleSkgewogICAgY29uc3QgY2xlYXJlZCA9IHRoaXMuY2xlYXJlZCAvLyBpbiBjYXNlIGl0cyBjbGVhcmVkCiAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IHJlYWQuZ2V0KGtleSkKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIG51bGwKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNsZWFyZWQubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYyA9IGNsZWFyZWRbaV0KICAgICAgLy8gY2hlY2sgaWYgaW4gcmFuZ2UKICAgICAgaWYgKGI0YS5jb21wYXJlKGNbMF0sIGtleSkgPD0gMCAmJiBiNGEuY29tcGFyZShrZXksIGNbMl0pIDwgMCkgcmV0dXJuIG51bGwKICAgIH0KCiAgICByZXR1cm4gdmFsdWUKICB9CgogIF9hdHRhY2hlZCgpIHsKICAgIHJldHVybiB0aGlzLnNuYXAgIT09IG51bGwgJiYgdGhpcy5jaGFuZ2VzID09PSB0aGlzLnNuYXAuY2hhbmdlcwogIH0KCiAgX2Zyb3plbigpIHsKICAgIHJldHVybiB0aGlzLmNoYW5nZXMgPT09IG51bGwgfHwgKHRoaXMuc25hcCAhPT0gbnVsbCAmJiB0aGlzLmNoYW5nZXMgIT09IHRoaXMuc25hcC5jaGFuZ2VzKQogIH0KCiAgX2luZGV4KCkgewogICAgLy8gaWYgd2UgYXJlIGEgc25hcCBhbmQgd2UgYXJlIHN0aWxsIGF0dGFjaGVkIChpZSBubyBtdXRhdGlvbnMpLCBzaW1wbHkgY29weSB0aGUgcmVmcwogICAgaWYgKHRoaXMuX2F0dGFjaGVkKCkpIHsKICAgICAgdGhpcy5zbmFwLl9pbmRleCgpCiAgICAgIHRoaXMubWFwID0gdGhpcy5zbmFwLm1hcAogICAgICB0aGlzLmNsZWFyZWQgPSB0aGlzLnNuYXAuY2xlYXJlZAogICAgICB0aGlzLmluZGV4ZWQgPSB0aGlzLnNuYXAuaW5kZXhlZAogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5tYXAgPT09IG51bGwpIHRoaXMubWFwID0gbmV3IE1hcCgpCiAgICBpZiAodGhpcy5jaGFuZ2VzLmxlbmd0aCA9PT0gdGhpcy5pbmRleGVkKSByZXR1cm4KCiAgICB3aGlsZSAodGhpcy5pbmRleGVkIDwgdGhpcy5jaGFuZ2VzLmxlbmd0aCkgewogICAgICBjb25zdCBjID0gdGhpcy5jaGFuZ2VzW3RoaXMuaW5kZXhlZCsrXQoKICAgICAgaWYgKGNbMl0gPT09IG51bGwpIHRoaXMubWFwLnNldChiNGEudG9TdHJpbmcoY1swXSwgJ2hleCcpLCBjKQogICAgICBlbHNlIHRoaXMuX2luZGV4UmFuZ2UoYykKICAgIH0KICB9CgogIF9pbmRleFJhbmdlKHJhbmdlKSB7CiAgICBjb25zdCBzID0gYjRhLnRvU3RyaW5nKHJhbmdlWzBdLCAnaGV4JykKICAgIGNvbnN0IGUgPSBiNGEudG9TdHJpbmcocmFuZ2VbMl0sICdoZXgnKQoKICAgIGZvciAoY29uc3QgW2tleSwgY10gb2YgdGhpcy5tYXApIHsKICAgICAgaWYgKHMgPD0ga2V5ICYmIGtleSA8IGUpIHRoaXMubWFwLnNldChrZXksIFtjWzBdLCBudWxsLCBudWxsXSkKICAgIH0KCiAgICBpZiAodGhpcy5jbGVhcmVkID09PSBudWxsKSB0aGlzLmNsZWFyZWQgPSBbXQogICAgdGhpcy5jbGVhcmVkLnB1c2gocmFuZ2UpCiAgfQoKICBhcHBseShjaGFuZ2VzKSB7CiAgICBpZiAodGhpcy5zbmFwICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ0lsbGVnYWwgdG8gcHVzaCBjaGFuZ2VzIHRvIGEgc25hcHNob3QnKQoKICAgIGlmICh0aGlzLnJlYWRlcnMgIT09IDAgJiYgdGhpcy5jaGFuZ2VzICE9PSBudWxsKSB7CiAgICAgIHRoaXMuY2hhbmdlcyA9IHRoaXMuY2hhbmdlcy5zbGljZSgwKQogICAgICB0aGlzLmNsZWFyZWQgPSB0aGlzLmNsZWFyZWQgPT09IG51bGwgPyBudWxsIDogdGhpcy5jbGVhcmVkLnNsaWNlKDApCiAgICAgIHRoaXMubWFwID0gdGhpcy5tYXAgPT09IG51bGwgPyBudWxsIDogbmV3IE1hcChbLi4udGhpcy5tYXBdKQogICAgfQoKICAgIGlmICh0aGlzLmNoYW5nZXMgPT09IG51bGwpIHsKICAgICAgdGhpcy5jaGFuZ2VzID0gY2hhbmdlcwogICAgICByZXR1cm4KICAgIH0KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgdGhpcy5jaGFuZ2VzLnB1c2goY2hhbmdlc1tpXSkKICAgIH0KICB9CgogIHN0YXRpYyBhc3luYyBmbHVzaChjaGFuZ2VzLCBkYikgewogICAgaWYgKGNoYW5nZXMgPT09IG51bGwpIHJldHVybiB0cnVlCgogICAgY29uc3QgdyA9IGRiLndyaXRlKHsgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKCiAgICBmb3IgKGNvbnN0IFtzdGFydCwgdmFsdWUsIGVuZF0gb2YgY2hhbmdlcykgewogICAgICBpZiAoZW5kICE9PSBudWxsKSB3LnRyeURlbGV0ZVJhbmdlKHN0YXJ0LCBlbmQpCiAgICAgIGVsc2UgaWYgKHZhbHVlICE9PSBudWxsKSB3LnRyeVB1dChzdGFydCwgdmFsdWUpCiAgICAgIGVsc2Ugdy50cnlEZWxldGUoc3RhcnQpCiAgICB9CgogICAgYXdhaXQgdy5mbHVzaCgpCgogICAgcmV0dXJuIHRydWUKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gVmlldwoKZnVuY3Rpb24gY21wQ2hhbmdlKGEsIGIpIHsKICBjb25zdCBjID0gYjRhLmNvbXBhcmUoYVswXSwgYlswXSkKICByZXR1cm4gYyA9PT0gMCA/IGI0YS5jb21wYXJlKGFbMl0sIGJbMl0pIDogYwp9CgpmdW5jdGlvbiBjbXBDaGFuZ2VSZXZlcnNlKGEsIGIpIHsKICByZXR1cm4gY21wQ2hhbmdlKGIsIGEpCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gcmV2ZXJzZUFycmF5KGxpc3QpIHsKICBjb25zdCByID0gbmV3IEFycmF5KGxpc3QubGVuZ3RoKQogIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgcltyLmxlbmd0aCAtIDEgLSBpXSA9IGxpc3RbaV0KICByZXR1cm4gcgp9CgovLyBUT0RPOiBleHBvc2UgZnJvbSByb2NrcyBpbnN0ZWFkCmZ1bmN0aW9uIGRiQ2xvc2luZyhkYikgewogIHJldHVybiBkYi5fc3RhdGUuY2xvc2luZyB8fCBkYi5faW5kZXggPT09IC0xCn0KY29uc3QgZnMgPSByZXF1aXJlKCdmcycpCmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJykKY29uc3QgeyBSZWFkYWJsZSB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGZsYXQgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBtID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCmNvbnN0IFZpZXcgPSByZXF1aXJlKCcuLi8uLi9saWIvdmlldy5qcycpCmNvbnN0IHsgQ29yZXN0b3JlVFgsIENvcmVUWCwgQ29yZXN0b3JlUlggfSA9IHJlcXVpcmUoJy4uLy4uL2xpYi90eC5qcycpCgpjb25zdCBFTVBUWV9OT0RFID0gYjRhLmFsbG9jKDQwKQpjb25zdCBFTVBUWV9QQUdFID0gYjRhLmFsbG9jKDQwOTYpCgpsZXQgVFJFRV8wMV9TS0lQID0gbnVsbApsZXQgVFJFRV8wNF9TS0lQID0gbnVsbApsZXQgVFJFRV8xNl9TS0lQID0gbnVsbAoKY2xhc3MgQ29yZUxpc3RTdHJlYW0gZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3IgKHN0b3JhZ2UpIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLnN0b3JhZ2UgPSBzdG9yYWdlCiAgICB0aGlzLnN0YWNrID0gW10KICB9CgogIGFzeW5jIF9vcGVuIChjYikgewogICAgZm9yIChjb25zdCBhIG9mIGF3YWl0IHJlYWRkaXIocGF0aC5qb2luKHRoaXMuc3RvcmFnZSwgJ2NvcmVzJykpKSB7CiAgICAgIGZvciAoY29uc3QgYiBvZiBhd2FpdCByZWFkZGlyKHBhdGguam9pbih0aGlzLnN0b3JhZ2UsICdjb3JlcycsIGEpKSkgewogICAgICAgIGZvciAoY29uc3QgZGtleSBvZiBhd2FpdCByZWFkZGlyKHBhdGguam9pbih0aGlzLnN0b3JhZ2UsICdjb3JlcycsIGEsIGIpKSkgewogICAgICAgICAgdGhpcy5zdGFjay5wdXNoKHBhdGguam9pbih0aGlzLnN0b3JhZ2UsICdjb3JlcycsIGEsIGIsIGRrZXkpKQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGNiKG51bGwpCiAgfQoKICBhc3luYyBfcmVhZCAoY2IpIHsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGNvbnN0IG5leHQgPSB0aGlzLnN0YWNrLnBvcCgpCiAgICAgIGlmICghbmV4dCkgewogICAgICAgIHRoaXMucHVzaChudWxsKQogICAgICAgIGJyZWFrCiAgICAgIH0KCiAgICAgIGNvbnN0IG9wbG9nID0gcGF0aC5qb2luKG5leHQsICdvcGxvZycpCiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlYWRPcGxvZyhvcGxvZykKICAgICAgaWYgKCFyZXN1bHQpIGNvbnRpbnVlCgogICAgICB0aGlzLnB1c2gocmVzdWx0KQogICAgICBicmVhawogICAgfQoKICAgIGNiKG51bGwpCiAgfQp9CgpmdW5jdGlvbiBkZWNvZGVPcGxvZ0hlYWRlciAoc3RhdGUpIHsKICBjLnVpbnQzMi5kZWNvZGUoc3RhdGUpIC8vIGNrc3VtLCBpZ25vcmUgZm9yIG5vdwoKICBjb25zdCBsID0gYy51aW50MzIuZGVjb2RlKHN0YXRlKQogIGNvbnN0IGxlbmd0aCA9IGwgPj4gMgogIGNvbnN0IGhlYWRlckJpdCA9IGwgJiAxCiAgY29uc3QgcGFydGlhbEJpdCA9IGwgJiAyCgogIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IGxlbmd0aCkgcmV0dXJuIG51bGwKCiAgY29uc3QgZW5kID0gc3RhdGUuc3RhcnQgKyBsZW5ndGgKICBjb25zdCByZXN1bHQgPSB7IGhlYWRlcjogaGVhZGVyQml0LCBwYXJ0aWFsOiBwYXJ0aWFsQml0ICE9PSAwLCBieXRlTGVuZ3RoOiBsZW5ndGggKyA4LCBtZXNzYWdlOiBudWxsIH0KCiAgdHJ5IHsKICAgIHJlc3VsdC5tZXNzYWdlID0gbS5vcGxvZy5oZWFkZXIuZGVjb2RlKHsgc3RhcnQ6IHN0YXRlLnN0YXJ0LCBlbmQsIGJ1ZmZlcjogc3RhdGUuYnVmZmVyIH0pCiAgfSBjYXRjaCB7CiAgICByZXR1cm4gbnVsbAogIH0KCiAgc3RhdGUuc3RhcnQgPSBlbmQKICByZXR1cm4gcmVzdWx0Cn0KCmZ1bmN0aW9uIGRlY29kZU9wbG9nRW50cnkgKHN0YXRlKSB7CiAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgOCkgcmV0dXJuIG51bGwKCiAgYy51aW50MzIuZGVjb2RlKHN0YXRlKSAvLyBja3N1bSwgaWdub3JlIGZvciBub3cKCiAgY29uc3QgbCA9IGMudWludDMyLmRlY29kZShzdGF0ZSkKICBjb25zdCBsZW5ndGggPSBsID4+PiAyCiAgY29uc3QgaGVhZGVyQml0ID0gbCAmIDEKICBjb25zdCBwYXJ0aWFsQml0ID0gbCAmIDIKCiAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgbGVuZ3RoKSByZXR1cm4gbnVsbAoKICBjb25zdCBlbmQgPSBzdGF0ZS5zdGFydCArIGxlbmd0aAoKICBjb25zdCByZXN1bHQgPSB7IGhlYWRlcjogaGVhZGVyQml0LCBwYXJ0aWFsOiBwYXJ0aWFsQml0ICE9PSAwLCBieXRlTGVuZ3RoOiBsZW5ndGggKyA4LCBtZXNzYWdlOiBudWxsIH0KCiAgdHJ5IHsKICAgIHJlc3VsdC5tZXNzYWdlID0gbS5vcGxvZy5lbnRyeS5kZWNvZGUoeyBzdGFydDogc3RhdGUuc3RhcnQsIGVuZCwgYnVmZmVyOiBzdGF0ZS5idWZmZXIgfSkKICB9IGNhdGNoIHsKICAgIHJldHVybiBudWxsCiAgfQoKICBzdGF0ZS5zdGFydCA9IGVuZAoKICByZXR1cm4gcmVzdWx0Cn0KCm1vZHVsZS5leHBvcnRzID0geyBzdG9yZSwgY29yZSB9Cgphc3luYyBmdW5jdGlvbiBzdG9yZSAoc3RvcmFnZSwgeyB2ZXJzaW9uLCBkcnlSdW4gPSB0cnVlLCBnYyA9IHRydWUgfSkgewogIGNvbnN0IHN0cmVhbSA9IG5ldyBDb3JlTGlzdFN0cmVhbShzdG9yYWdlLnBhdGgpCiAgY29uc3QgdmlldyA9IG5ldyBWaWV3KCkKCiAgY29uc3QgdHggPSBuZXcgQ29yZXN0b3JlVFgodmlldykKICBjb25zdCBoZWFkID0gYXdhaXQgc3RvcmFnZS5fZ2V0SGVhZCh2aWV3KQogIGNvbnN0IHByaW1hcnlLZXlGaWxlID0gcGF0aC5qb2luKHN0b3JhZ2UucGF0aCwgJ3ByaW1hcnkta2V5JykKCiAgY29uc3QgcHJpbWFyeUtleSA9IGF3YWl0IHJlYWRGaWxlKHByaW1hcnlLZXlGaWxlKQoKICBpZiAoIWhlYWQuc2VlZCkgaGVhZC5zZWVkID0gcHJpbWFyeUtleQoKICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2Ygc3RyZWFtKSB7CiAgICBjb25zdCBrZXkgPSBkYXRhLmhlYWRlci5rZXkKICAgIGNvbnN0IGRpc2NvdmVyeUtleSA9IGNyeXB0by5kaXNjb3ZlcnlLZXkoZGF0YS5oZWFkZXIua2V5KQogICAgY29uc3QgZmlsZXMgPSBnZXRGaWxlcyhkYXRhLnBhdGgpCgogICAgaWYgKGhlYWQuZGVmYXVsdERpc2NvdmVyeUtleSA9PT0gbnVsbCkgaGVhZC5kZWZhdWx0RGlzY292ZXJ5S2V5ID0gZGlzY292ZXJ5S2V5CgogICAgY29uc3QgY29yZSA9IHsKICAgICAgdmVyc2lvbjogMCwgLy8gbmVlZCBsYXRlciBtaWdyYXRpb24KICAgICAgY29yZVBvaW50ZXI6IGhlYWQuYWxsb2NhdGVkLmNvcmVzKyssCiAgICAgIGRhdGFQb2ludGVyOiBoZWFkLmFsbG9jYXRlZC5kYXRhcysrLAogICAgICBhbGlhczogbnVsbAogICAgfQoKICAgIGNvbnN0IHB0ciA9IHsgdmVyc2lvbjogMCwgY29yZVBvaW50ZXI6IGNvcmUuY29yZVBvaW50ZXIsIGRhdGFQb2ludGVyOiBjb3JlLmRhdGFQb2ludGVyLCBkZXBlbmRlbmNpZXM6IFtdIH0KICAgIGNvbnN0IGN0eCA9IG5ldyBDb3JlVFgocHRyLCBzdG9yYWdlLmRiLCB2aWV3LCBbXSkKICAgIGNvbnN0IHVzZXJEYXRhID0gbmV3IE1hcCgpCiAgICBjb25zdCB0cmVlTm9kZXMgPSBuZXcgTWFwKCkKCiAgICBjb25zdCBhdXRoID0gewogICAgICBrZXksCiAgICAgIGRpc2NvdmVyeUtleSwKICAgICAgbWFuaWZlc3Q6IGRhdGEuaGVhZGVyLm1hbmlmZXN0LAogICAgICBrZXlQYWlyOiBkYXRhLmhlYWRlci5rZXlQYWlyLAogICAgICBlbmNyeXB0aW9uS2V5OiBudWxsCiAgICB9CgogICAgY29uc3QgdHJlZSA9IHsKICAgICAgbGVuZ3RoOiAwLAogICAgICBmb3JrOiAwLAogICAgICByb290SGFzaDogbnVsbCwKICAgICAgc2lnbmF0dXJlOiBudWxsCiAgICB9CgogICAgaWYgKGRhdGEuaGVhZGVyLnRyZWUgJiYgZGF0YS5oZWFkZXIudHJlZS5sZW5ndGgpIHsKICAgICAgdHJlZS5sZW5ndGggPSBkYXRhLmhlYWRlci50cmVlLmxlbmd0aAogICAgICB0cmVlLmZvcmsgPSBkYXRhLmhlYWRlci50cmVlLmZvcmsKICAgICAgdHJlZS5yb290SGFzaCA9IGRhdGEuaGVhZGVyLnRyZWUucm9vdEhhc2gKICAgICAgdHJlZS5zaWduYXR1cmUgPSBkYXRhLmhlYWRlci50cmVlLnNpZ25hdHVyZQogICAgfQoKICAgIGZvciAoY29uc3QgeyBrZXksIHZhbHVlIH0gb2YgZGF0YS5oZWFkZXIudXNlckRhdGEpIHsKICAgICAgdXNlckRhdGEuc2V0KGtleSwgdmFsdWUpCiAgICB9CgogICAgZm9yIChjb25zdCBlIG9mIGRhdGEuZW50cmllcykgewogICAgICBpZiAoZS51c2VyRGF0YSkgdXNlckRhdGEuc2V0KGUudXNlckRhdGEua2V5LCBlLnVzZXJEYXRhLnZhbHVlKQoKICAgICAgaWYgKGUudHJlZU5vZGVzKSB7CiAgICAgICAgZm9yIChjb25zdCBub2RlIG9mIGUudHJlZU5vZGVzKSB7CiAgICAgICAgICB0cmVlTm9kZXMuc2V0KG5vZGUuaW5kZXgsIG5vZGUpCiAgICAgICAgICBjdHgucHV0VHJlZU5vZGUobm9kZSkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChlLnRyZWVVcGdyYWRlKSB7CiAgICAgICAgaWYgKGUudHJlZVVwZ3JhZGUuYW5jZXN0b3JzICE9PSB0cmVlLmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmZsdXNoZWQgdHJ1bmNhdGlvbnMgbm90IG1pZ3JhdGUtYWJsZSBhdG0nKQogICAgICAgIH0KCiAgICAgICAgdHJlZS5sZW5ndGggPSBlLnRyZWVVcGdyYWRlLmxlbmd0aAogICAgICAgIHRyZWUuZm9yayA9IGUudHJlZVVwZ3JhZGUuZm9yawogICAgICAgIHRyZWUucm9vdEhhc2ggPSBudWxsCiAgICAgICAgdHJlZS5zaWduYXR1cmUgPSBlLnRyZWVVcGdyYWRlLnNpZ25hdHVyZQogICAgICB9CiAgICB9CgogICAgaWYgKHVzZXJEYXRhLmhhcygnY29yZXN0b3JlL25hbWUnKSAmJiB1c2VyRGF0YS5oYXMoJ2NvcmVzdG9yZS9uYW1lc3BhY2UnKSkgewogICAgICBjb3JlLmFsaWFzID0gewogICAgICAgIG5hbWU6IGI0YS50b1N0cmluZyh1c2VyRGF0YS5nZXQoJ2NvcmVzdG9yZS9uYW1lJykpLAogICAgICAgIG5hbWVzcGFjZTogdXNlckRhdGEuZ2V0KCdjb3Jlc3RvcmUvbmFtZXNwYWNlJykKICAgICAgfQogICAgICB1c2VyRGF0YS5kZWxldGUoJ2NvcmVzdG9yZS9uYW1lJykKICAgICAgdXNlckRhdGEuZGVsZXRlKCdjb3Jlc3RvcmUvbmFtZXNwYWNlJykKICAgIH0KCiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiB1c2VyRGF0YSkgewogICAgICBjdHgucHV0VXNlckRhdGEoa2V5LCB2YWx1ZSkKICAgIH0KCiAgICBjdHguc2V0QXV0aChhdXRoKQoKICAgIGNvbnN0IGdldFRyZWVOb2RlID0gKGluZGV4KSA9PiAodHJlZU5vZGVzLmdldChpbmRleCkgfHwgZ2V0VHJlZU5vZGVGcm9tRmlsZShmaWxlcy50cmVlLCBpbmRleCkpCgogICAgaWYgKHRyZWUubGVuZ3RoKSB7CiAgICAgIGlmICh0cmVlLnJvb3RIYXNoID09PSBudWxsKSB0cmVlLnJvb3RIYXNoID0gY3J5cHRvLnRyZWUoYXdhaXQgZ2V0Um9vdHModHJlZS5sZW5ndGgsIGdldFRyZWVOb2RlKSkKICAgICAgY3R4LnNldEhlYWQodHJlZSkKICAgIH0KCiAgICB0eC5wdXRDb3JlKGRpc2NvdmVyeUtleSwgY29yZSkKICAgIGlmIChjb3JlLmFsaWFzKSB0eC5wdXRDb3JlQnlBbGlhcyhjb3JlLmFsaWFzLCBkaXNjb3ZlcnlLZXkpCgogICAgYXdhaXQgY3R4LmZsdXNoKCkKICB9CgogIGhlYWQudmVyc2lvbiA9IHZlcnNpb24KICB0eC5zZXRIZWFkKGhlYWQpCiAgdHguYXBwbHkoKQoKICBpZiAoZHJ5UnVuKSByZXR1cm4KCiAgYXdhaXQgVmlldy5mbHVzaCh2aWV3LmNoYW5nZXMsIHN0b3JhZ2UuZGIpCgogIGlmIChnYykgYXdhaXQgcm0ocHJpbWFyeUtleUZpbGUpCn0KCmNsYXNzIEJsb2NrU2xpY2VyIHsKICBjb25zdHJ1Y3RvciAoZmlsZW5hbWUpIHsKICAgIHRoaXMuc3RyZWFtID0gZnMuY3JlYXRlUmVhZFN0cmVhbShmaWxlbmFtZSkKICAgIHRoaXMuY2xvc2VkID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB0aGlzLnN0cmVhbS5vbmNlKCdjbG9zZScsIHJlc29sdmUpKQogICAgdGhpcy5vZmZzZXQgPSAwCiAgICB0aGlzLm92ZXJmbG93ID0gbnVsbAogIH0KCiAgYXN5bmMgdGFrZSAob2Zmc2V0LCBzaXplKSB7CiAgICBsZXQgYnVmZmVyID0gbnVsbAogICAgaWYgKG9mZnNldCA8IHRoaXMub2Zmc2V0KSB0aHJvdyBuZXcgRXJyb3IoJ292ZXJyZWFkJykKCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBsZXQgZGF0YSA9IG51bGwKCiAgICAgIGlmICh0aGlzLm92ZXJmbG93KSB7CiAgICAgICAgZGF0YSA9IHRoaXMub3ZlcmZsb3cKICAgICAgICB0aGlzLm92ZXJmbG93ID0gbnVsbAogICAgICB9IGVsc2UgewogICAgICAgIGRhdGEgPSB0aGlzLnN0cmVhbS5yZWFkKCkKCiAgICAgICAgaWYgKCFkYXRhKSB7CiAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHRoaXMuc3RyZWFtLm9uY2UoJ3JlYWRhYmxlJywgcmVzb2x2ZSkpCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAgICAgfQoKICAgICAgbGV0IGNodW5rID0gbnVsbAoKICAgICAgaWYgKHRoaXMub2Zmc2V0ID09PSBvZmZzZXQgfHwgYnVmZmVyKSB7CiAgICAgICAgY2h1bmsgPSBkYXRhCiAgICAgIH0gZWxzZSBpZiAodGhpcy5vZmZzZXQgKyBkYXRhLmJ5dGVMZW5ndGggPiBvZmZzZXQpIHsKICAgICAgICBjaHVuayA9IGRhdGEuc3ViYXJyYXkob2Zmc2V0IC0gdGhpcy5vZmZzZXQpCiAgICAgIH0KCiAgICAgIHRoaXMub2Zmc2V0ICs9IGRhdGEuYnl0ZUxlbmd0aAogICAgICBpZiAoIWNodW5rKSBjb250aW51ZQoKICAgICAgaWYgKGJ1ZmZlcikgYnVmZmVyID0gYjRhLmNvbmNhdChbYnVmZmVyLCBjaHVua10pCiAgICAgIGVsc2UgYnVmZmVyID0gY2h1bmsKCiAgICAgIGlmIChidWZmZXIuYnl0ZUxlbmd0aCA8IHNpemUpIGNvbnRpbnVlCgogICAgICBjb25zdCByZXN1bHQgPSBidWZmZXIuc3ViYXJyYXkoMCwgc2l6ZSkKICAgICAgdGhpcy5vdmVyZmxvdyA9IHNpemUgPT09IGJ1ZmZlci5ieXRlTGVuZ3RoID8gbnVsbCA6IGJ1ZmZlci5zdWJhcnJheShyZXN1bHQuYnl0ZUxlbmd0aCkKICAgICAgdGhpcy5vZmZzZXQgLT0gKHRoaXMub3ZlcmZsb3cgPyB0aGlzLm92ZXJmbG93LmJ5dGVMZW5ndGggOiAwKQogICAgICByZXR1cm4gcmVzdWx0CiAgICB9CiAgfQoKICBjbG9zZSAoKSB7CiAgICB0aGlzLnN0cmVhbS5vbignZXJyb3InLCBub29wKQogICAgdGhpcy5zdHJlYW0uZGVzdHJveSgpCiAgICByZXR1cm4gdGhpcy5jbG9zZWQKICB9Cn0KCmNsYXNzIFRyZWVTbGljZXIgewogIGNvbnN0cnVjdG9yICgpIHsKICAgIHRoaXMuYnVmZmVyID0gbnVsbAogICAgdGhpcy5vZmZzZXQgPSAwCiAgfQoKICBnZXQgc2l6ZSAoKSB7CiAgICByZXR1cm4gdGhpcy5idWZmZXIgPT09IG51bGwgPyAwIDogdGhpcy5idWZmZXIuYnl0ZUxlbmd0aAogIH0KCiAgcHVzaCAoZGF0YSkgewogICAgaWYgKHRoaXMuYnVmZmVyID09PSBudWxsKSB0aGlzLmJ1ZmZlciA9IGRhdGEKICAgIGVsc2UgdGhpcy5idWZmZXIgPSBiNGEuY29uY2F0KFt0aGlzLmJ1ZmZlciwgZGF0YV0pCiAgICB0aGlzLm9mZnNldCArPSBkYXRhLmJ5dGVMZW5ndGgKICB9CgogIHNraXAgKCkgewogICAgbGV0IHNraXBwZWQgPSAwCgogICAgaWYgKFRSRUVfMDFfU0tJUCA9PT0gbnVsbCkgewogICAgICBUUkVFXzE2X1NLSVAgPSBiNGEuYWxsb2MoMTYgKiA0MCAqIDEwMCkKICAgICAgVFJFRV8wNF9TS0lQID0gVFJFRV8xNl9TS0lQLnN1YmFycmF5KDAsIDQgKiA0MCAqIDEwMCkKICAgICAgVFJFRV8wMV9TS0lQID0gVFJFRV8xNl9TS0lQLnN1YmFycmF5KDAsIDEgKiA0MCAqIDEwMCkKICAgIH0KCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAodGhpcy5idWZmZXIuYnl0ZUxlbmd0aCA+PSBUUkVFXzE2X1NLSVAuYnl0ZUxlbmd0aCkgewogICAgICAgIGlmIChiNGEuZXF1YWxzKHRoaXMuYnVmZmVyLnN1YmFycmF5KDAsIFRSRUVfMTZfU0tJUC5ieXRlTGVuZ3RoKSwgVFJFRV8xNl9TS0lQKSkgewogICAgICAgICAgdGhpcy5idWZmZXIgPSB0aGlzLmJ1ZmZlci5zdWJhcnJheShUUkVFXzE2X1NLSVAuYnl0ZUxlbmd0aCkKICAgICAgICAgIHNraXBwZWQgKz0gMTYwMAogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RoID49IFRSRUVfMDRfU0tJUC5ieXRlTGVuZ3RoKSB7CiAgICAgICAgaWYgKGI0YS5lcXVhbHModGhpcy5idWZmZXIuc3ViYXJyYXkoMCwgVFJFRV8wNF9TS0lQLmJ5dGVMZW5ndGgpLCBUUkVFXzA0X1NLSVApKSB7CiAgICAgICAgICB0aGlzLmJ1ZmZlciA9IHRoaXMuYnVmZmVyLnN1YmFycmF5KFRSRUVfMDRfU0tJUC5ieXRlTGVuZ3RoKQogICAgICAgICAgc2tpcHBlZCArPSA0MDAKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5idWZmZXIuYnl0ZUxlbmd0aCA+PSBUUkVFXzAxX1NLSVAuYnl0ZUxlbmd0aCkgewogICAgICAgIGlmIChiNGEuZXF1YWxzKHRoaXMuYnVmZmVyLnN1YmFycmF5KDAsIFRSRUVfMDFfU0tJUC5ieXRlTGVuZ3RoKSwgVFJFRV8wMV9TS0lQKSkgewogICAgICAgICAgdGhpcy5idWZmZXIgPSB0aGlzLmJ1ZmZlci5zdWJhcnJheShUUkVFXzAxX1NLSVAuYnl0ZUxlbmd0aCkKICAgICAgICAgIHNraXBwZWQgKz0gMTAwCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAgICAgfQogICAgICBicmVhawogICAgfQoKICAgIHJldHVybiBza2lwcGVkCiAgfQoKICB0YWtlICgpIHsKICAgIGNvbnN0IGxlbiA9IDQwCgogICAgaWYgKGxlbiA8PSB0aGlzLnNpemUpIHsKICAgICAgY29uc3QgY2h1bmsgPSB0aGlzLmJ1ZmZlci5zdWJhcnJheSgwLCBsZW4pCiAgICAgIHRoaXMuYnVmZmVyID0gdGhpcy5idWZmZXIuc3ViYXJyYXkobGVuKQogICAgICByZXR1cm4gY2h1bmsKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KfQoKYXN5bmMgZnVuY3Rpb24gY29yZSAoY29yZSwgeyB2ZXJzaW9uLCBkcnlSdW4gPSB0cnVlLCBnYyA9IHRydWUgfSkgewogIGlmIChkcnlSdW4pIHJldHVybiAvLyBkcnlSdW4gbW9kZSBub3Qgc3VwcG9ydGVkIGF0bQoKICBjb25zdCByeCA9IGNvcmUucmVhZCgpCgogIGNvbnN0IHByb21pc2VzID0gW3J4LmdldEF1dGgoKSwgcnguZ2V0SGVhZCgpXQogIHJ4LnRyeUZsdXNoKCkKCiAgY29uc3QgW2F1dGgsIGhlYWRdID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpCgogIGlmICghYXV0aCkgcmV0dXJuCgogIGNvbnN0IGRrID0gYjRhLnRvU3RyaW5nKGF1dGguZGlzY292ZXJ5S2V5LCAnaGV4JykKICBjb25zdCBmaWxlcyA9IGdldEZpbGVzKHBhdGguam9pbihjb3JlLnN0b3JlLnBhdGgsICdjb3JlcycsIGRrLnNsaWNlKDAsIDIpLCBkay5zbGljZSgyLCA0KSwgZGspKQoKICBpZiAoaGVhZCA9PT0gbnVsbCB8fCBoZWFkLmxlbmd0aCA9PT0gMCkgewogICAgYXdhaXQgY29tbWl0Q29yZU1pZ3JhdGlvbihhdXRoLCBjb3JlLCB2ZXJzaW9uKQogICAgaWYgKGdjKSBhd2FpdCBydW5HQygpCiAgICByZXR1cm4gLy8gbm8gZGF0YQogIH0KCiAgY29uc3Qgb3Bsb2cgPSBhd2FpdCByZWFkT3Bsb2coZmlsZXMub3Bsb2cpCiAgaWYgKCFvcGxvZykgewogICAgY29uc3Qgd3JpdGFibGUgPSAhIWF1dGgua2V5UGFpcgoKICAgIGlmICh3cml0YWJsZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIG9wbG9nIGF2YWlsYWJsZSB3cml0YWJsZSBjb3JlIGZvciAnICsgZmlsZXMub3Bsb2cgKyAnLCBsZW5ndGggPSAnICsgKGhlYWQgPyBoZWFkLmxlbmd0aCA6IDApKQogICAgfQoKICAgIC8vIGlmIG5vdCB3cml0YWJsZSwganVzdCBudWtlIGl0IHRvIHJlY292ZXIsIHNvbWUgYmFkIHN0YXRlIGhhcHBlbmVkIGhlcmUsIHByb3AgY29ycnVwdGlvbiBmcm9tIGVhcmxpZXIgdmVyc2lvbnMKICAgIGNvbnN0IHcgPSBjb3JlLndyaXRlKCkKCiAgICB3LmRlbGV0ZUJsb2NrUmFuZ2UoMCwgLTEpCiAgICB3LmRlbGV0ZVRyZWVOb2RlUmFuZ2UoMCwgLTEpCiAgICB3LmRlbGV0ZUJpdGZpZWxkUGFnZVJhbmdlKDAsIC0xKQogICAgdy5kZWxldGVIZWFkKCkKCiAgICBhd2FpdCB3LmZsdXNoKCkKCiAgICBhd2FpdCBjb21taXRDb3JlTWlncmF0aW9uKGF1dGgsIGNvcmUsIHZlcnNpb24pCiAgICBpZiAoZ2MpIGF3YWl0IHJ1bkdDKCkKICAgIHJldHVybiAvLyBubyBkYXRhCiAgfQoKICBjb25zdCB0cmVlRGF0YSA9IG5ldyBUcmVlU2xpY2VyKCkKCiAgbGV0IHRyZWVJbmRleCA9IDAKCiAgaWYgKGF3YWl0IGV4aXN0cyhmaWxlcy50cmVlKSkgewogICAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIGZzLmNyZWF0ZVJlYWRTdHJlYW0oZmlsZXMudHJlZSkpIHsKICAgICAgdHJlZURhdGEucHVzaChkYXRhKQoKICAgICAgbGV0IHdyaXRlID0gbnVsbAoKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBjb25zdCBza2lwID0gdHJlZURhdGEuc2tpcCgpCiAgICAgICAgdHJlZUluZGV4ICs9IHNraXAKCiAgICAgICAgY29uc3QgYnVmID0gdHJlZURhdGEudGFrZSgpCiAgICAgICAgaWYgKGJ1ZiA9PT0gbnVsbCkgYnJlYWsKCiAgICAgICAgY29uc3QgaW5kZXggPSB0cmVlSW5kZXgrKwogICAgICAgIGlmIChiNGEuZXF1YWxzKGJ1ZiwgRU1QVFlfTk9ERSkpIGNvbnRpbnVlCgogICAgICAgIGlmICh3cml0ZSA9PT0gbnVsbCkgd3JpdGUgPSBjb3JlLndyaXRlKCkKICAgICAgICB3cml0ZS5wdXRUcmVlTm9kZShkZWNvZGVUcmVlTm9kZShpbmRleCwgYnVmKSkKICAgICAgfQoKICAgICAgaWYgKHdyaXRlICE9PSBudWxsKSBhd2FpdCB3cml0ZS5mbHVzaCgpCiAgICB9CiAgfQoKICBjb25zdCBidWYgPSBbXQogIGlmIChhd2FpdCBleGlzdHMoZmlsZXMuYml0ZmllbGQpKSB7CiAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgZnMuY3JlYXRlUmVhZFN0cmVhbShmaWxlcy5iaXRmaWVsZCkpIHsKICAgICAgYnVmLnB1c2goZGF0YSkKICAgIH0KICB9CgogIGxldCBiaXRmaWVsZCA9IGI0YS5jb25jYXQoYnVmKQogIGlmIChiaXRmaWVsZC5ieXRlTGVuZ3RoICYgNDA5NSkgYml0ZmllbGQgPSBiNGEuY29uY2F0KFtiaXRmaWVsZCwgYjRhLmFsbG9jKDQwOTYgLSAoYml0ZmllbGQuYnl0ZUxlbmd0aCAmIDQwOTUpKV0pCgogIGNvbnN0IHBhZ2VzID0gbmV3IE1hcCgpCiAgY29uc3QgaGVhZGVyQml0cyA9IG5ldyBNYXAoKQoKICBjb25zdCByb290cyA9IGF3YWl0IGdldFJvb3RzRnJvbVN0b3JhZ2UoY29yZSwgaGVhZC5sZW5ndGgpCgogIGZvciAoY29uc3QgZSBvZiBvcGxvZy5lbnRyaWVzKSB7CiAgICBpZiAoIWUuYml0ZmllbGQpIGNvbnRpbnVlCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlLmJpdGZpZWxkLmxlbmd0aDsgaSsrKSB7CiAgICAgIGhlYWRlckJpdHMuc2V0KGkgKyBlLmJpdGZpZWxkLnN0YXJ0LCAhZS5iaXRmaWVsZC5kcm9wKQogICAgfQogIH0KCiAgbGV0IGJhdGNoID0gW10KCiAgY29uc3QgY2FjaGUgPSBuZXcgTWFwKCkKICBjb25zdCBibG9ja3MgPSBuZXcgQmxvY2tTbGljZXIoZmlsZXMuZGF0YSkKCiAgZm9yIChjb25zdCBpbmRleCBvZiBhbGxCaXRzKGJpdGZpZWxkKSkgewogICAgaWYgKGhlYWRlckJpdHMuZ2V0KGluZGV4KSA9PT0gZmFsc2UpIGNvbnRpbnVlCiAgICBpZiAoaW5kZXggPj0gaGVhZC5sZW5ndGgpIGNvbnRpbnVlCgogICAgc2V0Qml0SW5QYWdlKGluZGV4KQoKICAgIGJhdGNoLnB1c2goaW5kZXgpCiAgICBpZiAoYmF0Y2gubGVuZ3RoIDwgMTAyNCkgY29udGludWUKCiAgICBhd2FpdCB3cml0ZUJsb2Nrc0JhdGNoKCkKICAgIGNvbnRpbnVlCiAgfQoKICBpZiAoYmF0Y2gubGVuZ3RoKSBhd2FpdCB3cml0ZUJsb2Nrc0JhdGNoKCkKCiAgYXdhaXQgYmxvY2tzLmNsb3NlKCkKCiAgY29uc3QgdyA9IGNvcmUud3JpdGUoKQoKICBmb3IgKGNvbnN0IFtpbmRleCwgYml0XSBvZiBoZWFkZXJCaXRzKSB7CiAgICBpZiAoIWJpdCkgY29udGludWUKICAgIGlmIChpbmRleCA+PSBoZWFkLmxlbmd0aCkgY29udGludWUKCiAgICBzZXRCaXRJblBhZ2UoaW5kZXgpCgogICAgY29uc3QgYmxrID0gYXdhaXQgZ2V0QmxvY2tGcm9tRmlsZShmaWxlcy5kYXRhLCBjb3JlLCBpbmRleCwgcm9vdHMsIGNhY2hlKQogICAgdy5wdXRCbG9jayhpbmRleCwgYmxrKQogIH0KCiAgZm9yIChjb25zdCBbaW5kZXgsIHBhZ2VdIG9mIHBhZ2VzKSB7CiAgICB3LnB1dEJpdGZpZWxkUGFnZShpbmRleCwgYjRhLmZyb20ocGFnZS5idWZmZXIsIHBhZ2UuYnl0ZU9mZnNldCwgcGFnZS5ieXRlTGVuZ3RoKSkKICB9CgogIGF3YWl0IHcuZmx1c2goKQoKICBsZXQgY29udGlndW91c0xlbmd0aCA9IDAKICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgY29yZS5jcmVhdGVCbG9ja1N0cmVhbSgpKSB7CiAgICBpZiAoZGF0YS5pbmRleCA9PT0gY29udGlndW91c0xlbmd0aCkgY29udGlndW91c0xlbmd0aCsrCiAgICBlbHNlIGJyZWFrCiAgfQoKICBpZiAoY29udGlndW91c0xlbmd0aCkgewogICAgY29uc3QgdyA9IGNvcmUud3JpdGUoKQogICAgdy5zZXRIaW50cyh7IGNvbnRpZ3VvdXNMZW5ndGggfSkKICAgIGF3YWl0IHcuZmx1c2goKQogIH0KCiAgYXdhaXQgY29tbWl0Q29yZU1pZ3JhdGlvbihhdXRoLCBjb3JlLCB2ZXJzaW9uKQoKICBpZiAoZ2MpIGF3YWl0IHJ1bkdDKCkKCiAgYXN5bmMgZnVuY3Rpb24gcnVuR0MgKCkgewogICAgYXdhaXQgcm0oZmlsZXMucGF0aCkKICAgIGF3YWl0IHJtZGlyKHBhdGguam9pbihmaWxlcy5wYXRoLCAnLi4nKSkKICAgIGF3YWl0IHJtZGlyKHBhdGguam9pbihmaWxlcy5wYXRoLCAnLi4vLi4nKSkKICAgIGF3YWl0IHJtZGlyKHBhdGguam9pbihjb3JlLnN0b3JlLnBhdGgsICdjb3JlcycpKQogIH0KCiAgZnVuY3Rpb24gc2V0Qml0SW5QYWdlIChpbmRleCkgewogICAgY29uc3QgbiA9IGluZGV4ICYgMzI3NjcKICAgIGNvbnN0IHAgPSAoaW5kZXggLSBuKSAvIDMyNzY4CgogICAgbGV0IHBhZ2UgPSBwYWdlcy5nZXQocCkKCiAgICBpZiAoIXBhZ2UpIHsKICAgICAgcGFnZSA9IG5ldyBVaW50MzJBcnJheSgxMDI0KQogICAgICBwYWdlcy5zZXQocCwgcGFnZSkKICAgIH0KCiAgICBjb25zdCBvID0gbiAmIDMxCiAgICBjb25zdCBiID0gKG4gLSBvKSAvIDMyCiAgICBjb25zdCB2ID0gMSA8PCBvCgogICAgcGFnZVtiXSB8PSB2CiAgfQoKICBhc3luYyBmdW5jdGlvbiB3cml0ZUJsb2Nrc0JhdGNoICgpIHsKICAgIGNvbnN0IHJlYWQgPSBjb3JlLnJlYWQoKQogICAgY29uc3QgcHJvbWlzZXMgPSBbXQogICAgZm9yIChjb25zdCBpbmRleCBvZiBiYXRjaCkgcHJvbWlzZXMucHVzaChnZXRCeXRlUmFuZ2VGcm9tU3RvcmFnZShyZWFkLCAyICogaW5kZXgsIHJvb3RzLCBjYWNoZSkpCiAgICByZWFkLnRyeUZsdXNoKCkKCiAgICBjb25zdCByID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpCiAgICBjb25zdCB0eCA9IGNvcmUud3JpdGUoKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgci5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBpbmRleCA9IGJhdGNoW2ldCiAgICAgIGNvbnN0IFtvZmZzZXQsIHNpemVdID0gcltpXQoKICAgICAgY29uc3QgYmxrID0gYXdhaXQgYmxvY2tzLnRha2Uob2Zmc2V0LCBzaXplKQogICAgICB0eC5wdXRCbG9jayhpbmRleCwgYmxrKQogICAgfQoKICAgIGJhdGNoID0gW10KICAgIGlmIChjYWNoZS5zaXplID4gMTYzODQpIGNhY2hlLmNsZWFyKCkKCiAgICBhd2FpdCB0eC5mbHVzaCgpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBjb21taXRDb3JlTWlncmF0aW9uIChhdXRoLCBjb3JlLCB2ZXJzaW9uKSB7CiAgY29uc3QgdmlldyA9IG5ldyBWaWV3KCkKICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWChjb3JlLmRiLCB2aWV3KQoKICBjb25zdCBzdG9yZUNvcmVQcm9taXNlID0gcnguZ2V0Q29yZShhdXRoLmRpc2NvdmVyeUtleSkKICByeC50cnlGbHVzaCgpCgogIGNvbnN0IHN0b3JlQ29yZSA9IGF3YWl0IHN0b3JlQ29yZVByb21pc2UKCiAgc3RvcmVDb3JlLnZlcnNpb24gPSB2ZXJzaW9uCgogIGNvbnN0IHR4ID0gbmV3IENvcmVzdG9yZVRYKHZpZXcpCgogIHR4LnB1dENvcmUoYXV0aC5kaXNjb3ZlcnlLZXksIHN0b3JlQ29yZSkKICB0eC5hcHBseSgpCgogIGF3YWl0IFZpZXcuZmx1c2godmlldy5jaGFuZ2VzLCBjb3JlLmRiKQp9Cgphc3luYyBmdW5jdGlvbiBnZXRCbG9ja0Zyb21GaWxlIChmaWxlLCBjb3JlLCBpbmRleCwgcm9vdHMsIGNhY2hlKSB7CiAgY29uc3QgcnggPSBjb3JlLnJlYWQoKQogIGNvbnN0IHByb21pc2UgPSBnZXRCeXRlUmFuZ2VGcm9tU3RvcmFnZShyeCwgMiAqIGluZGV4LCByb290cywgY2FjaGUpCiAgcngudHJ5Rmx1c2goKQogIGNvbnN0IFtvZmZzZXQsIHNpemVdID0gYXdhaXQgcHJvbWlzZQoKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgIHJlYWRBbGwoZmlsZSwgc2l6ZSwgb2Zmc2V0LCBmdW5jdGlvbiAoZXJyLCBidWYpIHsKICAgICAgaWYgKGVycikgcmV0dXJuIHJlc29sdmUobnVsbCkKICAgICAgcmVzb2x2ZShidWYpCiAgICB9KQogIH0pCn0KCmZ1bmN0aW9uIGdldEZpbGVzIChkaXIpIHsKICByZXR1cm4gewogICAgcGF0aDogZGlyLAogICAgb3Bsb2c6IHBhdGguam9pbihkaXIsICdvcGxvZycpLAogICAgZGF0YTogcGF0aC5qb2luKGRpciwgJ2RhdGEnKSwKICAgIHRyZWU6IHBhdGguam9pbihkaXIsICd0cmVlJyksCiAgICBiaXRmaWVsZDogcGF0aC5qb2luKGRpciwgJ2JpdGZpZWxkJykKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGdldFJvb3RzRnJvbVN0b3JhZ2UgKGNvcmUsIGxlbmd0aCkgewogIGNvbnN0IGFsbCA9IFtdCiAgY29uc3QgcnggPSBjb3JlLnJlYWQoKQogIGZvciAoY29uc3QgaW5kZXggb2YgZmxhdC5mdWxsUm9vdHMoMiAqIGxlbmd0aCkpIHsKICAgIGFsbC5wdXNoKHJ4LmdldFRyZWVOb2RlKGluZGV4KSkKICB9CiAgcngudHJ5Rmx1c2goKQogIHJldHVybiBQcm9taXNlLmFsbChhbGwpCn0KCmFzeW5jIGZ1bmN0aW9uIGdldFJvb3RzIChsZW5ndGgsIGdldFRyZWVOb2RlKSB7CiAgY29uc3QgYWxsID0gW10KICBmb3IgKGNvbnN0IGluZGV4IG9mIGZsYXQuZnVsbFJvb3RzKDIgKiBsZW5ndGgpKSB7CiAgICBhbGwucHVzaChhd2FpdCBnZXRUcmVlTm9kZShpbmRleCkpCiAgfQogIHJldHVybiBhbGwKfQoKZnVuY3Rpb24gZ2V0Q2FjaGVkIChyZWFkLCBjYWNoZSwgaW5kZXgpIHsKICBpZiAoY2FjaGUuaGFzKGluZGV4KSkgcmV0dXJuIGNhY2hlLmdldChpbmRleCkKICBjb25zdCBwID0gcmVhZC5nZXRUcmVlTm9kZShpbmRleCkKICBjYWNoZS5zZXQoaW5kZXgsIHApCiAgcmV0dXJuIHAKfQoKYXN5bmMgZnVuY3Rpb24gZ2V0Qnl0ZVJhbmdlRnJvbVN0b3JhZ2UgKHJlYWQsIGluZGV4LCByb290cywgY2FjaGUpIHsKICBjb25zdCBwcm9taXNlcyA9IFtnZXRDYWNoZWQocmVhZCwgY2FjaGUsIGluZGV4KSwgZ2V0Qnl0ZU9mZnNldEZyb21TdG9yYWdlKHJlYWQsIGluZGV4LCByb290cywgY2FjaGUpXQogIGNvbnN0IFtub2RlLCBvZmZzZXRdID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpCiAgaWYgKCFub2RlKSB0aHJvdyBuZXcgRXJyb3IoJ05vZGUgbm90IGZvdW5kIGR1cmluZyBtaWdyYXRpb246ICcgKyBpbmRleCkKICByZXR1cm4gW29mZnNldCwgbm9kZS5zaXplXQp9Cgphc3luYyBmdW5jdGlvbiBnZXRCeXRlT2Zmc2V0RnJvbVN0b3JhZ2UgKHJ4LCBpbmRleCwgcm9vdHMsIGNhY2hlKSB7CiAgaWYgKGluZGV4ID09PSAwKSByZXR1cm4gMAogIGlmICgoaW5kZXggJiAxKSA9PT0gMSkgaW5kZXggPSBmbGF0LmxlZnRTcGFuKGluZGV4KQoKICBsZXQgaGVhZCA9IDAKICBsZXQgb2Zmc2V0ID0gMAoKICBmb3IgKGNvbnN0IG5vZGUgb2Ygcm9vdHMpIHsgLy8gYWxsIGFzeW5jIHRpY2tzIGhhcHBlbiBvbmNlIHdlIGZpbmQgdGhlIHJvb3Qgc28gc2FmZQogICAgaGVhZCArPSAyICogKChub2RlLmluZGV4IC0gaGVhZCkgKyAxKQoKICAgIGlmIChpbmRleCA+PSBoZWFkKSB7CiAgICAgIG9mZnNldCArPSBub2RlLnNpemUKICAgICAgY29udGludWUKICAgIH0KCiAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKG5vZGUuaW5kZXgpCiAgICBjb25zdCBwcm9taXNlcyA9IFtdCgogICAgd2hpbGUgKGl0ZS5pbmRleCAhPT0gaW5kZXgpIHsKICAgICAgaWYgKGluZGV4IDwgaXRlLmluZGV4KSB7CiAgICAgICAgaXRlLmxlZnRDaGlsZCgpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcHJvbWlzZXMucHVzaChnZXRDYWNoZWQocngsIGNhY2hlLCBpdGUubGVmdENoaWxkKCkpKQogICAgICAgIGl0ZS5zaWJsaW5nKCkKICAgICAgfQogICAgfQoKICAgIGNvbnN0IG5vZGVzID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpCiAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIG9mZnNldCArPSBub2RlLnNpemUKCiAgICByZXR1cm4gb2Zmc2V0CiAgfQoKICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBmaW5kIG9mZnNldCcpCn0KCmZ1bmN0aW9uIGRlY29kZVRyZWVOb2RlIChpbmRleCwgYnVmKSB7CiAgcmV0dXJuIHsgaW5kZXgsIHNpemU6IGMuZGVjb2RlKGMudWludDY0LCBidWYpLCBoYXNoOiBidWYuc3ViYXJyYXkoOCkgfQp9Cgphc3luYyBmdW5jdGlvbiBnZXRUcmVlTm9kZUZyb21GaWxlIChmaWxlLCBpbmRleCkgewogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgcmVhZEFsbChmaWxlLCA0MCwgaW5kZXggKiA0MCwgZnVuY3Rpb24gKGVyciwgYnVmKSB7CiAgICAgIGlmIChlcnIpIHJldHVybiByZXNvbHZlKG51bGwpCiAgICAgIHJlc29sdmUoZGVjb2RlVHJlZU5vZGUoaW5kZXgsIGJ1ZikpCiAgICB9KQogIH0pCn0KCmZ1bmN0aW9uIHJlYWRBbGwgKGZpbGVuYW1lLCBsZW5ndGgsIHBvcywgY2IpIHsKICBjb25zdCBidWYgPSBiNGEuYWxsb2MobGVuZ3RoKQoKICBmcy5vcGVuKGZpbGVuYW1lLCAncicsIGZ1bmN0aW9uIChlcnIsIGZkKSB7CiAgICBpZiAoZXJyKSByZXR1cm4gY2IoZXJyKQoKICAgIGxldCBvZmZzZXQgPSAwCgogICAgZnMucmVhZChmZCwgYnVmLCBvZmZzZXQsIGJ1Zi5ieXRlTGVuZ3RoLCBwb3MsIGZ1bmN0aW9uIGxvb3AgKGVyciwgcmVhZCkgewogICAgICBpZiAoZXJyKSByZXR1cm4gZG9uZShlcnIpCiAgICAgIGlmIChyZWFkID09PSAwKSByZXR1cm4gZG9uZShuZXcgRXJyb3IoJ1BhcnRpYWwgcmVhZCcpKQogICAgICBvZmZzZXQgKz0gcmVhZAogICAgICBpZiAob2Zmc2V0ID09PSBidWYuYnl0ZUxlbmd0aCkgcmV0dXJuIGRvbmUobnVsbCwgYnVmKQogICAgICBmcy5yZWFkKGZkLCBvZmZzZXQsIGJ1Zi5ieXRlTGVuZ3RoIC0gb2Zmc2V0LCBidWYsIHBvcyArIG9mZnNldCwgbG9vcCkKICAgIH0pCgogICAgZnVuY3Rpb24gZG9uZSAoZXJyLCB2YWx1ZSkgewogICAgICBmcy5jbG9zZShmZCwgKCkgPT4gY2IoZXJyLCB2YWx1ZSkpCiAgICB9CiAgfSkKfQoKYXN5bmMgZnVuY3Rpb24gcmVhZGRpciAoZGlyKSB7CiAgdHJ5IHsKICAgIHJldHVybiBhd2FpdCBmcy5wcm9taXNlcy5yZWFkZGlyKGRpcikKICB9IGNhdGNoIHsKICAgIHJldHVybiBbXQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZXhpc3RzIChmaWxlKSB7CiAgdHJ5IHsKICAgIGF3YWl0IGZzLnByb21pc2VzLnN0YXQoZmlsZSkKICAgIHJldHVybiB0cnVlCiAgfSBjYXRjaCB7CiAgICByZXR1cm4gZmFsc2UKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJlYWRGaWxlIChmaWxlKSB7CiAgdHJ5IHsKICAgIHJldHVybiBhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShmaWxlKQogIH0gY2F0Y2ggewogICAgcmV0dXJuIG51bGwKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJtIChkaXIpIHsKICB0cnkgewogICAgYXdhaXQgZnMucHJvbWlzZXMucm0oZGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KQogIH0gY2F0Y2gge30KfQoKYXN5bmMgZnVuY3Rpb24gcm1kaXIgKGRpcikgewogIHRyeSB7CiAgICBhd2FpdCBmcy5wcm9taXNlcy5ybWRpcihkaXIpCiAgfSBjYXRjaCB7fQp9CgpmdW5jdGlvbiAqIGFsbEJpdHMgKGJ1ZmZlcikgewogIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyLmJ5dGVMZW5ndGg7IGkgKz0gRU1QVFlfUEFHRS5ieXRlTGVuZ3RoKSB7CiAgICBjb25zdCBwYWdlID0gYnVmZmVyLnN1YmFycmF5KGksIGkgKyBFTVBUWV9OT0RFLmJ5dGVMZW5ndGgpCiAgICBpZiAoYjRhLmVxdWFscyhwYWdlLCBFTVBUWV9QQUdFKSkgY29udGludWUKCiAgICBjb25zdCB2aWV3ID0gbmV3IFVpbnQzMkFycmF5KHBhZ2UuYnVmZmVyLCBwYWdlLmJ5dGVPZmZzZXQsIEVNUFRZX1BBR0UuYnl0ZUxlbmd0aCAvIDQpCgogICAgZm9yIChsZXQgaiA9IDA7IGogPCB2aWV3Lmxlbmd0aDsgaisrKSB7CiAgICAgIGNvbnN0IG4gPSB2aWV3W2pdCiAgICAgIGlmIChuID09PSAwKSBjb250aW51ZQoKICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCAzMjsgaysrKSB7CiAgICAgICAgY29uc3QgbSA9IDEgPDwgawogICAgICAgIGlmIChuICYgbSkgeWllbGQgaSAqIDggKyBqICogMzIgKyBrCiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHJlYWRPcGxvZyAob3Bsb2cpIHsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgIGZzLnJlYWRGaWxlKG9wbG9nLCBmdW5jdGlvbiAoZXJyLCBidWZmZXIpIHsKICAgICAgaWYgKGVycikgcmV0dXJuIHJlc29sdmUobnVsbCkKCiAgICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCwgYnVmZmVyIH0KICAgICAgY29uc3QgaGVhZGVycyA9IFsxLCAwXQoKICAgICAgY29uc3QgaDEgPSBkZWNvZGVPcGxvZ0hlYWRlcihzdGF0ZSkKICAgICAgc3RhdGUuc3RhcnQgPSA0MDk2CgogICAgICBjb25zdCBoMiA9IGRlY29kZU9wbG9nSGVhZGVyKHN0YXRlKQogICAgICBzdGF0ZS5zdGFydCA9IDQwOTYgKiAyCgogICAgICBpZiAoIWgxICYmICFoMikgcmV0dXJuIHJlc29sdmUobnVsbCkKCiAgICAgIGlmIChoMSAmJiAhaDIpIHsKICAgICAgICBoZWFkZXJzWzBdID0gaDEuaGVhZGVyCiAgICAgICAgaGVhZGVyc1sxXSA9IGgxLmhlYWRlcgogICAgICB9IGVsc2UgaWYgKCFoMSAmJiBoMikgewogICAgICAgIGhlYWRlcnNbMF0gPSAoaDIuaGVhZGVyICsgMSkgJiAxCiAgICAgICAgaGVhZGVyc1sxXSA9IGgyLmhlYWRlcgogICAgICB9IGVsc2UgewogICAgICAgIGhlYWRlcnNbMF0gPSBoMS5oZWFkZXIKICAgICAgICBoZWFkZXJzWzFdID0gaDIuaGVhZGVyCiAgICAgIH0KCiAgICAgIGNvbnN0IGhlYWRlciA9IChoZWFkZXJzWzBdICsgaGVhZGVyc1sxXSkgJiAxCiAgICAgIGNvbnN0IHJlc3VsdCA9IHsgcGF0aDogcGF0aC5kaXJuYW1lKG9wbG9nKSwgaGVhZGVyOiBudWxsLCBlbnRyaWVzOiBbXSB9CiAgICAgIGNvbnN0IGRlY29kZWQgPSBbXQoKICAgICAgcmVzdWx0LmhlYWRlciA9IGhlYWRlciA/IGgyLm1lc3NhZ2UgOiBoMS5tZXNzYWdlCgogICAgICBpZiAocmVzdWx0LmhlYWRlci5leHRlcm5hbCkgewogICAgICAgIGZzLnJlYWRGaWxlKHBhdGguam9pbihvcGxvZywgJy4uL2hlYWRlcicpLCBmdW5jdGlvbiAoZXJyLCBidWZmZXIpIHsKICAgICAgICAgIGlmIChlcnIpIHJldHVybiByZXNvbHZlKG51bGwpCiAgICAgICAgICBjb25zdCBzdGFydCA9IHJlc3VsdC5oZWFkZXIuZXh0ZXJuYWwuc3RhcnQKICAgICAgICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgcmVzdWx0LmhlYWRlci5leHRlcm5hbC5sZW5ndGgKICAgICAgICAgIHJlc3VsdC5oZWFkZXIgPSBtLm9wbG9nLmhlYWRlci5kZWNvZGUoeyBidWZmZXIsIHN0YXJ0LCBlbmQgfSkKICAgICAgICAgIGZpbmlzaCgpCiAgICAgICAgfSkKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgZmluaXNoKCkKCiAgICAgIGZ1bmN0aW9uIGZpbmlzaCAoKSB7CiAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgIGNvbnN0IGVudHJ5ID0gZGVjb2RlT3Bsb2dFbnRyeShzdGF0ZSkKICAgICAgICAgIGlmICghZW50cnkpIGJyZWFrCiAgICAgICAgICBpZiAoZW50cnkuaGVhZGVyICE9PSBoZWFkZXIpIGJyZWFrCgogICAgICAgICAgZGVjb2RlZC5wdXNoKGVudHJ5KQogICAgICAgIH0KCiAgICAgICAgd2hpbGUgKGRlY29kZWQubGVuZ3RoID4gMCAmJiBkZWNvZGVkW2RlY29kZWQubGVuZ3RoIC0gMV0ucGFydGlhbCkgZGVjb2RlZC5wb3AoKQoKICAgICAgICBmb3IgKGNvbnN0IGUgb2YgZGVjb2RlZCkgewogICAgICAgICAgcmVzdWx0LmVudHJpZXMucHVzaChlLm1lc3NhZ2UpCiAgICAgICAgfQoKICAgICAgICByZXNvbHZlKHJlc3VsdCkKICAgICAgfQogICAgfSkKICB9KQp9CgpmdW5jdGlvbiBub29wICgpIHt9Ci8vIG5lZWRlZCBoZXJlIGZvciBjb21wYXQsIGNvcGllZCBmcm9tIG9sZCBoeXBlcmNvcmUsIGRvIG5vdCBjaGFuZ2UgdGhpcwoKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgRU1QVFkgPSBiNGEuYWxsb2MoMCkKY29uc3QgREVGQVVMVF9OQU1FU1BBQ0UgPSBiNGEuZnJvbSgnNDE0NGVlYTUzMWU0ODNkNTRlMGMxNGY0Y2E2OGUwNjQ0ZjM1NTM0M2ZmNmZjYjBmMDA1MjAwZTEyY2Q3NDdjYicsICdoZXgnKQoKY29uc3QgaGFzaGVzID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIHNtYWxsIHVpbnQKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGlmIChtID09PSAnYmxha2UyYicpIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGhhc2g6ICcgKyBtKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAobiA9PT0gMCkgcmV0dXJuICdibGFrZTJiJwogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGhhc2ggaWQ6ICcgKyBuKQogIH0KfQoKY29uc3Qgc2lnbmF0dXJlcyA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBzbWFsbCB1aW50CiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBpZiAobSA9PT0gJ2VkMjU1MTknKSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApCiAgICAgIHJldHVybgogICAgfQoKICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBzaWduYXR1cmU6ICcgKyBtKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAobiA9PT0gMCkgcmV0dXJuICdlZDI1NTE5JwogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHNpZ25hdHVyZSBpZDogJyArIG4pCiAgfQp9Cgpjb25zdCBzaWduZXIgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc2lnbmF0dXJlcy5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHNpZ25hdHVyZXMuZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ubmFtZXNwYWNlKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzaWduYXR1cmU6IHNpZ25hdHVyZXMuZGVjb2RlKHN0YXRlKSwKICAgICAgbmFtZXNwYWNlOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgcHVibGljS2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qgc2lnbmVyQXJyYXkgPSBjLmFycmF5KHNpZ25lcikKCmNvbnN0IHByb2xvZ3VlID0gewogIHByZWVuY29kZSAoc3RhdGUsIHApIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIHAuaGFzaCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHAubGVuZ3RoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgcCkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgcC5oYXNoKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgcC5sZW5ndGgpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBoYXNoOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgbWFuaWZlc3R2MCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBoYXNoZXMucHJlZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBzdGF0ZS5lbmQrKyAvLyB0eXBlCgogICAgaWYgKG0ucHJvbG9ndWUgJiYgbS5zaWduZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlLmhhc2gpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChtLnF1b3J1bSA9PT0gMSAmJiBtLnNpZ25lcnMubGVuZ3RoID09PSAxICYmICFtLmFsbG93UGF0Y2gpIHsKICAgICAgc2lnbmVyLnByZWVuY29kZShzdGF0ZSwgbS5zaWduZXJzWzBdKQogICAgfSBlbHNlIHsKICAgICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5xdW9ydW0pCiAgICAgIHNpZ25lckFycmF5LnByZWVuY29kZShzdGF0ZSwgbS5zaWduZXJzKQogICAgfQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgaGFzaGVzLmVuY29kZShzdGF0ZSwgbS5oYXNoKQoKICAgIGlmIChtLnByb2xvZ3VlICYmIG0uc2lnbmVycy5sZW5ndGggPT09IDApIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkKICAgICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5wcm9sb2d1ZS5oYXNoKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAobS5xdW9ydW0gPT09IDEgJiYgbS5zaWduZXJzLmxlbmd0aCA9PT0gMSAmJiAhbS5hbGxvd1BhdGNoKSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpCiAgICAgIHNpZ25lci5lbmNvZGUoc3RhdGUsIG0uc2lnbmVyc1swXSkKICAgIH0gZWxzZSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDIpCiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uYWxsb3dQYXRjaCA/IDEgOiAwKQogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnF1b3J1bSkKICAgICAgc2lnbmVyQXJyYXkuZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCiAgICB9CiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBoYXNoID0gaGFzaGVzLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHR5cGUgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmICh0eXBlID4gMikgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHR5cGU6ICcgKyB0eXBlKQoKICAgIGlmICh0eXBlID09PSAwKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmVyc2lvbjogMCwKICAgICAgICBoYXNoLAogICAgICAgIGFsbG93UGF0Y2g6IGZhbHNlLAogICAgICAgIHF1b3J1bTogMCwKICAgICAgICBzaWduZXJzOiBbXSwKICAgICAgICBwcm9sb2d1ZTogewogICAgICAgICAgaGFzaDogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgICAgICBsZW5ndGg6IDAKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAodHlwZSA9PT0gMSkgewogICAgICByZXR1cm4gewogICAgICAgIHZlcnNpb246IDAsCiAgICAgICAgaGFzaCwKICAgICAgICBhbGxvd1BhdGNoOiBmYWxzZSwKICAgICAgICBxdW9ydW06IDEsCiAgICAgICAgc2lnbmVyczogW3NpZ25lci5kZWNvZGUoc3RhdGUpXSwKICAgICAgICBwcm9sb2d1ZTogbnVsbAogICAgICB9CiAgICB9CgogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IDAsCiAgICAgIGhhc2gsCiAgICAgIGFsbG93UGF0Y2g6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBxdW9ydW06IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduZXJzOiBzaWduZXJBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICBwcm9sb2d1ZTogbnVsbAogICAgfQogIH0KfQoKY29uc3QgbWFuaWZlc3QgPSBleHBvcnRzLm1hbmlmZXN0ID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIHZlcnNpb24KICAgIGlmIChtLnZlcnNpb24gPT09IDApIHJldHVybiBtYW5pZmVzdHYwLnByZWVuY29kZShzdGF0ZSwgbSkKCiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgaGFzaGVzLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQoKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucXVvcnVtKQogICAgc2lnbmVyQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCiAgICBpZiAobS5wcm9sb2d1ZSkgcHJvbG9ndWUucHJlZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgaWYgKG0udmVyc2lvbiA9PT0gMCkgcmV0dXJuIG1hbmlmZXN0djAuZW5jb2RlKHN0YXRlLCBtKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIChtLmFsbG93UGF0Y2ggPyAxIDogMCkgfCAobS5wcm9sb2d1ZSA/IDIgOiAwKSB8IChtLnVuZW5jcnlwdGVkID8gNCA6IDApKQogICAgaGFzaGVzLmVuY29kZShzdGF0ZSwgbS5oYXNoKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucXVvcnVtKQogICAgc2lnbmVyQXJyYXkuZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCiAgICBpZiAobS5wcm9sb2d1ZSkgcHJvbG9ndWUuZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgdiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAodiA9PT0gMCkgcmV0dXJuIG1hbmlmZXN0djAuZGVjb2RlKHN0YXRlKQogICAgaWYgKHYgIT09IDEpIHRocm93IG5ldyBFcnJvcignVW5rbm93biB2ZXJzaW9uOiAnICsgdikKCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBoYXNoID0gaGFzaGVzLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHF1b3J1bSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBzaWduZXJzID0gc2lnbmVyQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgdW5lbmNyeXB0ZWQgPSAoZmxhZ3MgJiA0KSAhPT0gMAoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IDEsCiAgICAgIGhhc2gsCiAgICAgIGFsbG93UGF0Y2g6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBxdW9ydW0sCiAgICAgIHNpZ25lcnMsCiAgICAgIHByb2xvZ3VlOiAoZmxhZ3MgJiAyKSA9PT0gMCA/IG51bGwgOiBwcm9sb2d1ZS5kZWNvZGUoc3RhdGUpLAogICAgICB1bmVuY3J5cHRlZAogICAgfQogIH0KfQoKY29uc3Qgbm9kZSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLmluZGV4KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5zaXplKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbi5oYXNoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5pbmRleCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uc2l6ZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG4uaGFzaCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGluZGV4OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2l6ZTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGhhc2g6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBub2RlQXJyYXkgPSBjLmFycmF5KG5vZGUpCgpjb25zdCB3aXJlID0gZXhwb3J0cy53aXJlID0ge30KCndpcmUuaGFuZHNoYWtlID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIDEpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmNhcGFiaWxpdHkpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnNlZWtzID8gMSA6IDApCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmNhcGFiaWxpdHkpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBzZWVrczogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIGNhcGFiaWxpdHk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZXF1ZXN0QmxvY2sgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgYikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGluZGV4OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbm9kZXM6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZXF1ZXN0U2VlayA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBzKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBzLmJ5dGVzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgcy5wYWRkaW5nKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgcykgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgcy5ieXRlcykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHMucGFkZGluZykKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGJ5dGVzOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgcGFkZGluZzogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlcXVlc3RVcGdyYWRlID0gewogIHByZWVuY29kZSAoc3RhdGUsIHUpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUuc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICB9LAogIGVuY29kZSAoc3RhdGUsIHUpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUuc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5yZXF1ZXN0ID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5mb3JrKQoKICAgIGlmIChtLmJsb2NrKSByZXF1ZXN0QmxvY2sucHJlZW5jb2RlKHN0YXRlLCBtLmJsb2NrKQogICAgaWYgKG0uaGFzaCkgcmVxdWVzdEJsb2NrLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgaWYgKG0uc2VlaykgcmVxdWVzdFNlZWsucHJlZW5jb2RlKHN0YXRlLCBtLnNlZWspCiAgICBpZiAobS51cGdyYWRlKSByZXF1ZXN0VXBncmFkZS5wcmVlbmNvZGUoc3RhdGUsIG0udXBncmFkZSkKICAgIGlmIChtLnByaW9yaXR5KSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnByaW9yaXR5KQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSAobS5ibG9jayA/IDEgOiAwKSB8IChtLmhhc2ggPyAyIDogMCkgfCAobS5zZWVrID8gNCA6IDApIHwgKG0udXBncmFkZSA/IDggOiAwKSB8IChtLm1hbmlmZXN0ID8gMTYgOiAwKSB8IChtLnByaW9yaXR5ID8gMzIgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZm9yaykKCiAgICBpZiAobS5ibG9jaykgcmVxdWVzdEJsb2NrLmVuY29kZShzdGF0ZSwgbS5ibG9jaykKICAgIGlmIChtLmhhc2gpIHJlcXVlc3RCbG9jay5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGlmIChtLnNlZWspIHJlcXVlc3RTZWVrLmVuY29kZShzdGF0ZSwgbS5zZWVrKQogICAgaWYgKG0udXBncmFkZSkgcmVxdWVzdFVwZ3JhZGUuZW5jb2RlKHN0YXRlLCBtLnVwZ3JhZGUpCiAgICBpZiAobS5wcmlvcml0eSkgYy51aW50LmVuY29kZShzdGF0ZSwgbS5wcmlvcml0eSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBpZDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGZvcms6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBibG9jazogZmxhZ3MgJiAxID8gcmVxdWVzdEJsb2NrLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBoYXNoOiBmbGFncyAmIDIgPyByZXF1ZXN0QmxvY2suZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHNlZWs6IGZsYWdzICYgNCA/IHJlcXVlc3RTZWVrLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB1cGdyYWRlOiBmbGFncyAmIDggPyByZXF1ZXN0VXBncmFkZS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgbWFuaWZlc3Q6IChmbGFncyAmIDE2KSAhPT0gMCwKICAgICAgcHJpb3JpdHk6IGZsYWdzICYgMzIgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCndpcmUuY2FuY2VsID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICB9LAogIGRlY29kZSAoc3RhdGUsIG0pIHsKICAgIHJldHVybiB7CiAgICAgIHJlcXVlc3Q6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBkYXRhVXBncmFkZSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1LnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCB1Lm5vZGVzKQogICAgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgdS5hZGRpdGlvbmFsTm9kZXMpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHUuc2lnbmF0dXJlKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgdSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgdS5ub2RlcykKICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIHUuYWRkaXRpb25hbE5vZGVzKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB1LnNpZ25hdHVyZSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbm9kZXM6IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICBhZGRpdGlvbmFsTm9kZXM6IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGRhdGFTZWVrID0gewogIHByZWVuY29kZSAoc3RhdGUsIHMpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHMuYnl0ZXMpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBzLm5vZGVzKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgcykgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgcy5ieXRlcykKICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIHMubm9kZXMpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBieXRlczogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgZGF0YUJsb2NrID0gewogIHByZWVuY29kZSAoc3RhdGUsIGIpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIGIudmFsdWUpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgYikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgYi52YWx1ZSkKICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpbmRleDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHZhbHVlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpIHx8IEVNUFRZLAogICAgICBub2Rlczogbm9kZUFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGRhdGFIYXNoID0gewogIHByZWVuY29kZSAoc3RhdGUsIGIpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgYikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpbmRleDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5kYXRhID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmZvcmspCgogICAgaWYgKG0uYmxvY2spIGRhdGFCbG9jay5wcmVlbmNvZGUoc3RhdGUsIG0uYmxvY2spCiAgICBpZiAobS5oYXNoKSBkYXRhSGFzaC5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGlmIChtLnNlZWspIGRhdGFTZWVrLnByZWVuY29kZShzdGF0ZSwgbS5zZWVrKQogICAgaWYgKG0udXBncmFkZSkgZGF0YVVwZ3JhZGUucHJlZW5jb2RlKHN0YXRlLCBtLnVwZ3JhZGUpCiAgICBpZiAobS5tYW5pZmVzdCkgbWFuaWZlc3QucHJlZW5jb2RlKHN0YXRlLCBtLm1hbmlmZXN0KQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSAobS5ibG9jayA/IDEgOiAwKSB8IChtLmhhc2ggPyAyIDogMCkgfCAobS5zZWVrID8gNCA6IDApIHwgKG0udXBncmFkZSA/IDggOiAwKSB8IChtLm1hbmlmZXN0ID8gMTYgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZXF1ZXN0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5mb3JrKQoKICAgIGlmIChtLmJsb2NrKSBkYXRhQmxvY2suZW5jb2RlKHN0YXRlLCBtLmJsb2NrKQogICAgaWYgKG0uaGFzaCkgZGF0YUhhc2guZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBpZiAobS5zZWVrKSBkYXRhU2Vlay5lbmNvZGUoc3RhdGUsIG0uc2VlaykKICAgIGlmIChtLnVwZ3JhZGUpIGRhdGFVcGdyYWRlLmVuY29kZShzdGF0ZSwgbS51cGdyYWRlKQogICAgaWYgKG0ubWFuaWZlc3QpIG1hbmlmZXN0LmVuY29kZShzdGF0ZSwgbS5tYW5pZmVzdCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICByZXF1ZXN0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgZm9yazogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGJsb2NrOiBmbGFncyAmIDEgPyBkYXRhQmxvY2suZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGhhc2g6IGZsYWdzICYgMiA/IGRhdGFIYXNoLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBzZWVrOiBmbGFncyAmIDQgPyBkYXRhU2Vlay5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdXBncmFkZTogZmxhZ3MgJiA4ID8gZGF0YVVwZ3JhZGUuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIG1hbmlmZXN0OiBmbGFncyAmIDE2ID8gbWFuaWZlc3QuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCndpcmUubm9EYXRhID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICB9LAogIGRlY29kZSAoc3RhdGUsIG0pIHsKICAgIHJldHVybiB7CiAgICAgIHJlcXVlc3Q6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLndhbnQgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLnVud2FudCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUgKHN0YXRlLCBtKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUucmFuZ2UgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBpZiAobS5sZW5ndGggIT09IDEpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgKG0uZHJvcCA/IDEgOiAwKSB8IChtLmxlbmd0aCA9PT0gMSA/IDIgOiAwKSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBpZiAobS5sZW5ndGggIT09IDEpIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGRyb3A6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogKGZsYWdzICYgMikgIT09IDAgPyAxIDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUuYml0ZmllbGQgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludDMyYXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLmJpdGZpZWxkKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludDMyYXJyYXkuZW5jb2RlKHN0YXRlLCBtLmJpdGZpZWxkKQogIH0sCiAgZGVjb2RlIChzdGF0ZSwgbSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBiaXRmaWVsZDogYy51aW50MzJhcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLnN5bmMgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZm9yaykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZW1vdGVMZW5ndGgpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAobS5jYW5VcGdyYWRlID8gMSA6IDApIHwgKG0udXBsb2FkaW5nID8gMiA6IDApIHwgKG0uZG93bmxvYWRpbmcgPyA0IDogMCkgfCAobS5oYXNNYW5pZmVzdCA/IDggOiAwKSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZm9yaykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZW1vdGVMZW5ndGgpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgZm9yazogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHJlbW90ZUxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGNhblVwZ3JhZGU6IChmbGFncyAmIDEpICE9PSAwLAogICAgICB1cGxvYWRpbmc6IChmbGFncyAmIDIpICE9PSAwLAogICAgICBkb3dubG9hZGluZzogKGZsYWdzICYgNCkgIT09IDAsCiAgICAgIGhhc01hbmlmZXN0OiAoZmxhZ3MgJiA4KSAhPT0gMAogICAgfQogIH0KfQoKd2lyZS5yZW9yZ0hpbnQgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5mcm9tKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS50bykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uYW5jZXN0b3JzKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5mcm9tKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS50bykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uYW5jZXN0b3JzKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgZnJvbTogYy51aW50LmVuY29kZShzdGF0ZSksCiAgICAgIHRvOiBjLnVpbnQuZW5jb2RlKHN0YXRlKSwKICAgICAgYW5jZXN0b3JzOiBjLnVpbnQuZW5jb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5leHRlbnNpb24gPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWUpCiAgICBjLnJhdy5wcmVlbmNvZGUoc3RhdGUsIG0ubWVzc2FnZSkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgbS5uYW1lKQogICAgYy5yYXcuZW5jb2RlKHN0YXRlLCBtLm1lc3NhZ2UpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBuYW1lOiBjLnN0cmluZy5kZWNvZGUoc3RhdGUpLAogICAgICBtZXNzYWdlOiBjLnJhdy5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBrZXlWYWx1ZSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBwKSB7CiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIHAua2V5KQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBwLnZhbHVlKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgcCkgewogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCBwLmtleSkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgcC52YWx1ZSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGtleTogYy5zdHJpbmcuZGVjb2RlKHN0YXRlKSwKICAgICAgdmFsdWU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHRyZWVVcGdyYWRlID0gewogIHByZWVuY29kZSAoc3RhdGUsIHUpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUuZm9yaykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUuYW5jZXN0b3JzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHUuc2lnbmF0dXJlKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgdSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5mb3JrKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5hbmNlc3RvcnMpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgdS5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBmb3JrOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYW5jZXN0b3JzOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBiaXRmaWVsZFVwZGF0ZSA9IHsgLy8gVE9ETzogY2FuIG1heWJlIGJlIGZvbGRlZCBpbnRvIGEgSEFWRSBsYXRlciBvbiB3aXRoIHRoZSBtb3N0IHJlY2VudCBzcGVjCiAgcHJlZW5jb2RlIChzdGF0ZSwgYikgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIuc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLmxlbmd0aCkKICB9LAogIGVuY29kZSAoc3RhdGUsIGIpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IGIuZHJvcCA/IDEgOiAwCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5sZW5ndGgpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBkcm9wOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBvcGxvZyA9IGV4cG9ydHMub3Bsb2cgPSB7fQoKb3Bsb2cuZW50cnkgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGlmIChtLnVzZXJEYXRhKSBrZXlWYWx1ZS5wcmVlbmNvZGUoc3RhdGUsIG0udXNlckRhdGEpCiAgICBpZiAobS50cmVlTm9kZXMpIG5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0udHJlZU5vZGVzKQogICAgaWYgKG0udHJlZVVwZ3JhZGUpIHRyZWVVcGdyYWRlLnByZWVuY29kZShzdGF0ZSwgbS50cmVlVXBncmFkZSkKICAgIGlmIChtLmJpdGZpZWxkKSBiaXRmaWVsZFVwZGF0ZS5wcmVlbmNvZGUoc3RhdGUsIG0uYml0ZmllbGQpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjb25zdCBzID0gc3RhdGUuc3RhcnQrKwogICAgbGV0IGZsYWdzID0gMAoKICAgIGlmIChtLnVzZXJEYXRhKSB7CiAgICAgIGZsYWdzIHw9IDEKICAgICAga2V5VmFsdWUuZW5jb2RlKHN0YXRlLCBtLnVzZXJEYXRhKQogICAgfQogICAgaWYgKG0udHJlZU5vZGVzKSB7CiAgICAgIGZsYWdzIHw9IDIKICAgICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgbS50cmVlTm9kZXMpCiAgICB9CiAgICBpZiAobS50cmVlVXBncmFkZSkgewogICAgICBmbGFncyB8PSA0CiAgICAgIHRyZWVVcGdyYWRlLmVuY29kZShzdGF0ZSwgbS50cmVlVXBncmFkZSkKICAgIH0KICAgIGlmIChtLmJpdGZpZWxkKSB7CiAgICAgIGZsYWdzIHw9IDgKICAgICAgYml0ZmllbGRVcGRhdGUuZW5jb2RlKHN0YXRlLCBtLmJpdGZpZWxkKQogICAgfQoKICAgIHN0YXRlLmJ1ZmZlcltzXSA9IGZsYWdzCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICB1c2VyRGF0YTogKGZsYWdzICYgMSkgIT09IDAgPyBrZXlWYWx1ZS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdHJlZU5vZGVzOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdHJlZVVwZ3JhZGU6IChmbGFncyAmIDQpICE9PSAwID8gdHJlZVVwZ3JhZGUuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGJpdGZpZWxkOiAoZmxhZ3MgJiA4KSAhPT0gMCA/IGJpdGZpZWxkVXBkYXRlLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBrZXlQYWlyID0gewogIHByZWVuY29kZSAoc3RhdGUsIGtwKSB7CiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIGtwLnB1YmxpY0tleSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwga3Auc2VjcmV0S2V5KQogIH0sCiAgZW5jb2RlIChzdGF0ZSwga3ApIHsKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwga3AucHVibGljS2V5KQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBrcC5zZWNyZXRLZXkpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBwdWJsaWNLZXk6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSksCiAgICAgIHNlY3JldEtleTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVvcmdIaW50ID0gewogIHByZWVuY29kZSAoc3RhdGUsIHIpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHIuZnJvbSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHIudG8pCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCByLmFuY2VzdG9ycykKICB9LAogIGVuY29kZSAoc3RhdGUsIHIpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHIuZnJvbSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHIudG8pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCByLmFuY2VzdG9ycykKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGZyb206IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICB0bzogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGFuY2VzdG9yczogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlb3JnSGludEFycmF5ID0gYy5hcnJheShyZW9yZ0hpbnQpCgpjb25zdCBoaW50cyA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBoKSB7CiAgICByZW9yZ0hpbnRBcnJheS5wcmVlbmNvZGUoc3RhdGUsIGgucmVvcmdzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgaC5jb250aWd1b3VzTGVuZ3RoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgaCkgewogICAgcmVvcmdIaW50QXJyYXkuZW5jb2RlKHN0YXRlLCBoLnJlb3JncykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGguY29udGlndW91c0xlbmd0aCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHJlb3JnczogcmVvcmdIaW50QXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgY29udGlndW91c0xlbmd0aDogc3RhdGUuc3RhcnQgPCBzdGF0ZS5lbmQgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCmNvbnN0IHRyZWVIZWFkZXIgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgdCkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdC5mb3JrKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdC5sZW5ndGgpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHQucm9vdEhhc2gpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHQuc2lnbmF0dXJlKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgdCkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdC5mb3JrKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdC5sZW5ndGgpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHQucm9vdEhhc2gpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHQuc2lnbmF0dXJlKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgZm9yazogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHJvb3RIYXNoOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHR5cGVzID0gewogIHByZWVuY29kZSAoc3RhdGUsIHQpIHsKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgdC50cmVlKQogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCB0LmJpdGZpZWxkKQogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCB0LnNpZ25lcikKICB9LAogIGVuY29kZSAoc3RhdGUsIHQpIHsKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgdC50cmVlKQogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCB0LmJpdGZpZWxkKQogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCB0LnNpZ25lcikKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHRyZWU6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSksCiAgICAgIGJpdGZpZWxkOiBjLnN0cmluZy5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduZXI6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGV4dGVybmFsSGVhZGVyID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qga2V5VmFsdWVBcnJheSA9IGMuYXJyYXkoa2V5VmFsdWUpCgpvcGxvZy5oZWFkZXIgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgaCkgewogICAgc3RhdGUuZW5kICs9IDIgLy8gdmVyc2lvbiArIGZsYWdzCiAgICBpZiAoaC5leHRlcm5hbCkgewogICAgICBleHRlcm5hbEhlYWRlci5wcmVlbmNvZGUoc3RhdGUsIGguZXh0ZXJuYWwpCiAgICAgIHJldHVybgogICAgfQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgaC5rZXkpCiAgICBpZiAoaC5tYW5pZmVzdCkgbWFuaWZlc3QucHJlZW5jb2RlKHN0YXRlLCBoLm1hbmlmZXN0KQogICAgaWYgKGgua2V5UGFpcikga2V5UGFpci5wcmVlbmNvZGUoc3RhdGUsIGgua2V5UGFpcikKICAgIGtleVZhbHVlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBoLnVzZXJEYXRhKQogICAgdHJlZUhlYWRlci5wcmVlbmNvZGUoc3RhdGUsIGgudHJlZSkKICAgIGhpbnRzLnByZWVuY29kZShzdGF0ZSwgaC5oaW50cykKICB9LAogIGVuY29kZSAoc3RhdGUsIGgpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpCiAgICBpZiAoaC5leHRlcm5hbCkgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKSAvLyBPTkxZIHNldCB0aGUgZmlyc3QgYmlnIGZvciBjbGFyaXR5CiAgICAgIGV4dGVybmFsSGVhZGVyLmVuY29kZShzdGF0ZSwgaC5leHRlcm5hbCkKICAgICAgcmV0dXJuCiAgICB9CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAoaC5tYW5pZmVzdCA/IDIgOiAwKSB8IChoLmtleVBhaXIgPyA0IDogMCkpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBoLmtleSkKICAgIGlmIChoLm1hbmlmZXN0KSBtYW5pZmVzdC5lbmNvZGUoc3RhdGUsIGgubWFuaWZlc3QpCiAgICBpZiAoaC5rZXlQYWlyKSBrZXlQYWlyLmVuY29kZShzdGF0ZSwgaC5rZXlQYWlyKQogICAga2V5VmFsdWVBcnJheS5lbmNvZGUoc3RhdGUsIGgudXNlckRhdGEpCiAgICB0cmVlSGVhZGVyLmVuY29kZShzdGF0ZSwgaC50cmVlKQogICAgaGludHMuZW5jb2RlKHN0YXRlLCBoLmhpbnRzKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgaWYgKHZlcnNpb24gPiAxKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBoZWFkZXIgdmVyc2lvbi4gRXhwZWN0ZWQgPD0gMSwgZ290ICcgKyB2ZXJzaW9uKQogICAgfQoKICAgIGlmICh2ZXJzaW9uID09PSAwKSB7CiAgICAgIGNvbnN0IG9sZCA9IHsKICAgICAgICB0eXBlczogdHlwZXMuZGVjb2RlKHN0YXRlKSwKICAgICAgICB1c2VyRGF0YToga2V5VmFsdWVBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICAgIHRyZWU6IHRyZWVIZWFkZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgICBzaWduZXI6IGtleVBhaXIuZGVjb2RlKHN0YXRlKSwKICAgICAgICBoaW50czogaGludHMuZGVjb2RlKHN0YXRlKQogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGV4dGVybmFsOiBudWxsLAogICAgICAgIGtleTogb2xkLnNpZ25lci5wdWJsaWNLZXksCiAgICAgICAgbWFuaWZlc3Q6IHsKICAgICAgICAgIHZlcnNpb246IDAsCiAgICAgICAgICBoYXNoOiBvbGQudHlwZXMudHJlZSwKICAgICAgICAgIGFsbG93UGF0Y2g6IGZhbHNlLAogICAgICAgICAgcXVvcnVtOiAxLAogICAgICAgICAgc2lnbmVyczogW3sKICAgICAgICAgICAgc2lnbmF0dXJlOiBvbGQudHlwZXMuc2lnbmVyLAogICAgICAgICAgICBuYW1lc3BhY2U6IERFRkFVTFRfTkFNRVNQQUNFLAogICAgICAgICAgICBwdWJsaWNLZXk6IG9sZC5zaWduZXIucHVibGljS2V5CiAgICAgICAgICB9XSwKICAgICAgICAgIHByb2xvZ3VlOiBudWxsCiAgICAgICAgfSwKICAgICAgICBrZXlQYWlyOiBvbGQuc2lnbmVyLnNlY3JldEtleSA/IG9sZC5zaWduZXIgOiBudWxsLAogICAgICAgIHVzZXJEYXRhOiBvbGQudXNlckRhdGEsCiAgICAgICAgdHJlZTogb2xkLnRyZWUsCiAgICAgICAgaGludHM6IG9sZC5oaW50cwogICAgICB9CiAgICB9CgogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmIChmbGFncyAmIDEpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBleHRlcm5hbDogZXh0ZXJuYWxIZWFkZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgICBrZXk6IG51bGwsCiAgICAgICAgbWFuaWZlc3Q6IG51bGwsCiAgICAgICAga2V5UGFpcjogbnVsbCwKICAgICAgICB1c2VyRGF0YTogbnVsbCwKICAgICAgICB0cmVlOiBudWxsLAogICAgICAgIGhpbnRzOiBudWxsCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gewogICAgICBleHRlcm5hbDogbnVsbCwKICAgICAga2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgbWFuaWZlc3Q6IChmbGFncyAmIDIpICE9PSAwID8gbWFuaWZlc3QuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGtleVBhaXI6IChmbGFncyAmIDQpICE9PSAwID8ga2V5UGFpci5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdXNlckRhdGE6IGtleVZhbHVlQXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgdHJlZTogdHJlZUhlYWRlci5kZWNvZGUoc3RhdGUpLAogICAgICBoaW50czogaGludHMuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgdWludEFycmF5ID0gYy5hcnJheShjLnVpbnQpCgpjb25zdCBtdWx0aXNpZ0lucHV0ID0gewogIHByZWVuY29kZSAoc3RhdGUsIGlucCkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgaW5wLnNpZ25lcikKICAgIGMuZml4ZWQ2NC5wcmVlbmNvZGUoc3RhdGUsIGlucC5zaWduYXR1cmUpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBpbnAucGF0Y2gpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBpbnApIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGlucC5zaWduZXIpCiAgICBjLmZpeGVkNjQuZW5jb2RlKHN0YXRlLCBpbnAuc2lnbmF0dXJlKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgaW5wLnBhdGNoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc2lnbmVyOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmZpeGVkNjQuZGVjb2RlKHN0YXRlKSwKICAgICAgcGF0Y2g6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBwYXRjaEVuY29kaW5ndjAgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4ubGVuZ3RoKQogICAgdWludEFycmF5LnByZWVuY29kZShzdGF0ZSwgbi5ub2RlcykKICB9LAogIGVuY29kZSAoc3RhdGUsIG4pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLmxlbmd0aCkKICAgIHVpbnRBcnJheS5lbmNvZGUoc3RhdGUsIG4ubm9kZXMpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiB1aW50QXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgbXVsdGlzaWdJbnB1dHYwID0gewogIHByZWVuY29kZSAoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCsrCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLnNpZ25lcikKICAgIGMuZml4ZWQ2NC5wcmVlbmNvZGUoc3RhdGUsIG4uc2lnbmF0dXJlKQogICAgaWYgKG4ucGF0Y2gpIHBhdGNoRW5jb2Rpbmd2MC5wcmVlbmNvZGUoc3RhdGUsIG4ucGF0Y2gpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLnBhdGNoID8gMSA6IDApCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLnNpZ25lcikKICAgIGMuZml4ZWQ2NC5lbmNvZGUoc3RhdGUsIG4uc2lnbmF0dXJlKQogICAgaWYgKG4ucGF0Y2gpIHBhdGNoRW5jb2Rpbmd2MC5lbmNvZGUoc3RhdGUsIG4ucGF0Y2gpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBzaWduZXI6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuZml4ZWQ2NC5kZWNvZGUoc3RhdGUpLAogICAgICBwYXRjaDogKGZsYWdzICYgMSkgPyBwYXRjaEVuY29kaW5ndjAuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IG11bHRpc2lnSW5wdXRBcnJheXYwID0gYy5hcnJheShtdWx0aXNpZ0lucHV0djApCmNvbnN0IG11bHRpc2lnSW5wdXRBcnJheSA9IGMuYXJyYXkobXVsdGlzaWdJbnB1dCkKCmNvbnN0IGNvbXBhY3ROb2RlID0gewogIHByZWVuY29kZSAoc3RhdGUsIG4pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4uaW5kZXgpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLnNpemUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBuLmhhc2gpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLmluZGV4KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5zaXplKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbi5oYXNoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaXplOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgaGFzaDogYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGNvbXBhY3ROb2RlQXJyYXkgPSBjLmFycmF5KGNvbXBhY3ROb2RlKQoKZXhwb3J0cy5tdWx0aVNpZ25hdHVyZXYwID0gewogIHByZWVuY29kZSAoc3RhdGUsIHMpIHsKICAgIG11bHRpc2lnSW5wdXRBcnJheXYwLnByZWVuY29kZShzdGF0ZSwgcy5wcm9vZnMpCiAgICBjb21wYWN0Tm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgcy5wYXRjaCkKICB9LAogIGVuY29kZSAoc3RhdGUsIHMpIHsKICAgIG11bHRpc2lnSW5wdXRBcnJheXYwLmVuY29kZShzdGF0ZSwgcy5wcm9vZnMpCiAgICBjb21wYWN0Tm9kZUFycmF5LmVuY29kZShzdGF0ZSwgcy5wYXRjaCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHByb29mczogbXVsdGlzaWdJbnB1dEFycmF5djAuZGVjb2RlKHN0YXRlKSwKICAgICAgcGF0Y2g6IGNvbXBhY3ROb2RlQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKZXhwb3J0cy5tdWx0aVNpZ25hdHVyZSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBzKSB7CiAgICBtdWx0aXNpZ0lucHV0QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBzLnByb29mcykKICAgIGNvbXBhY3ROb2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBzLnBhdGNoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgcykgewogICAgbXVsdGlzaWdJbnB1dEFycmF5LmVuY29kZShzdGF0ZSwgcy5wcm9vZnMpCiAgICBjb21wYWN0Tm9kZUFycmF5LmVuY29kZShzdGF0ZSwgcy5wYXRjaCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHByb29mczogbXVsdGlzaWdJbnB1dEFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIHBhdGNoOiBjb21wYWN0Tm9kZUFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KewogICJuYW1lIjogImh5cGVyY29yZS1zdG9yYWdlIiwKICAidmVyc2lvbiI6ICIyLjQuMSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibGliLyouanMiLAogICAgInNwZWMvaHlwZXJzY2hlbWEvKi5qcyIsCiAgICAibWlncmF0aW9ucy8wLyouanMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIiwKICAgICJsaW50IjogInByZXR0aWVyIC0tY2hlY2sgLiAmJiBsdW50ZSIsCiAgICAidGVzdCI6ICJub2RlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDpnZW5lcmF0ZSI6ICJicml0dGxlIC1yIHRlc3QvYWxsLmpzIHRlc3QvKi5qcyIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYy4iLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJkZXNjcmlwdGlvbiI6ICJTdG9yYWdlIGVuZ2luZSBmb3IgSHlwZXJjb3JlIiwKICAiaW1wb3J0cyI6IHsKICAgICJmcyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1mcyIsCiAgICAgICJkZWZhdWx0IjogImZzIgogICAgfSwKICAgICJwYXRoIjogewogICAgICAiYmFyZSI6ICJiYXJlLXBhdGgiLAogICAgICAiZGVmYXVsdCI6ICJwYXRoIgogICAgfQogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi43IiwKICAgICJiYXJlLWZzIjogIl40LjAuMSIsCiAgICAiYmFyZS1wYXRoIjogIl4zLjAuMCIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xNi4wIiwKICAgICJkZXZpY2UtZmlsZSI6ICJeMi4xLjIiLAogICAgImZsYXQtdHJlZSI6ICJeMS4xMi4xIiwKICAgICJoeXBlcmNvcmUtY3J5cHRvIjogIl4zLjQuMiIsCiAgICAiaHlwZXJzY2hlbWEiOiAiXjEuNy4wIiwKICAgICJpbmRleC1lbmNvZGVyIjogIl4zLjMuMiIsCiAgICAicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6ICJeMS4wLjAiLAogICAgInJvY2tzZGItbmF0aXZlIjogIl4zLjExLjAiLAogICAgInNjb3BlLWxvY2siOiAiXjEuMi40IiwKICAgICJzdHJlYW14IjogIl4yLjIxLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuNy4wIiwKICAgICJsdW50ZSI6ICJeMS4yLjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiLAogICAgInRlc3QtdG1wIjogIl4xLjMuMSIKICB9Cn0KLy8gVGhpcyBmaWxlIGlzIGF1dG9nZW5lcmF0ZWQgYnkgdGhlIGh5cGVyc2NoZW1hIGNvbXBpbGVyCi8vIFNjaGVtYSBWZXJzaW9uOiAxCi8qIGVzbGludC1kaXNhYmxlIGNhbWVsY2FzZSAqLwovKiBlc2xpbnQtZGlzYWJsZSBxdW90ZXMgKi8KLyogZXNsaW50LWRpc2FibGUgc3BhY2UtYmVmb3JlLWZ1bmN0aW9uLXBhcmVuICovCgpjb25zdCB7IGMgfSA9IHJlcXVpcmUoJ2h5cGVyc2NoZW1hL3J1bnRpbWUnKQoKY29uc3QgVkVSU0lPTiA9IDEKCi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtdmFycwpsZXQgdmVyc2lvbiA9IFZFUlNJT04KCi8vIEBjb3Jlc3RvcmUvYWxsb2NhdGVkCmNvbnN0IGVuY29kaW5nMCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uY29yZXMpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmRhdGFzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmNvcmVzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5kYXRhcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGNvcmVzOiByMCwKICAgICAgZGF0YXM6IHIxCiAgICB9CiAgfQp9CgovLyBAY29yZXN0b3JlL2hlYWQKY29uc3QgZW5jb2RpbmcxID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgNCBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5hbGxvY2F0ZWQpIGVuY29kaW5nMC5wcmVlbmNvZGUoc3RhdGUsIG0uYWxsb2NhdGVkKQogICAgaWYgKG0uc2VlZCkgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5zZWVkKQogICAgaWYgKG0uZGVmYXVsdERpc2NvdmVyeUtleSkgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5kZWZhdWx0RGlzY292ZXJ5S2V5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9CiAgICAgIChtLmFsbG9jYXRlZCA/IDEgOiAwKSB8CiAgICAgIChtLnNlZWQgPyAyIDogMCkgfAogICAgICAobS5kZWZhdWx0RGlzY292ZXJ5S2V5ID8gNCA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0uYWxsb2NhdGVkKSBlbmNvZGluZzAuZW5jb2RlKHN0YXRlLCBtLmFsbG9jYXRlZCkKICAgIGlmIChtLnNlZWQpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0uc2VlZCkKICAgIGlmIChtLmRlZmF1bHREaXNjb3ZlcnlLZXkpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0uZGVmYXVsdERpc2NvdmVyeUtleSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IHIwLAogICAgICBhbGxvY2F0ZWQ6IChmbGFncyAmIDEpICE9PSAwID8gZW5jb2RpbmcwLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBzZWVkOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgZGVmYXVsdERpc2NvdmVyeUtleTogKGZsYWdzICYgNCkgIT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCi8vIEBjb3Jlc3RvcmUvYWxpYXMKY29uc3QgZW5jb2RpbmcyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCBtLm5hbWUpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnN0cmluZy5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgbmFtZTogcjAsCiAgICAgIG5hbWVzcGFjZTogcjEKICAgIH0KICB9Cn0KCi8vIEBjb3Jlc3RvcmUvY29yZQpjb25zdCBlbmNvZGluZzMgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmNvcmVQb2ludGVyKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5kYXRhUG9pbnRlcikKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDEgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0uYWxpYXMpIGVuY29kaW5nMi5wcmVlbmNvZGUoc3RhdGUsIG0uYWxpYXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gbS5hbGlhcyA/IDEgOiAwCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5jb3JlUG9pbnRlcikKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZGF0YVBvaW50ZXIpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5hbGlhcykgZW5jb2RpbmcyLmVuY29kZShzdGF0ZSwgbS5hbGlhcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjIgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IHIwLAogICAgICBjb3JlUG9pbnRlcjogcjEsCiAgICAgIGRhdGFQb2ludGVyOiByMiwKICAgICAgYWxpYXM6IChmbGFncyAmIDEpICE9PSAwID8gZW5jb2RpbmcyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBlbmNvZGluZzRfZW51bSA9IHsKICBibGFrZTJiOiAnYmxha2UyYicKfQoKLy8gQGNvcmUvaGFzaGVzIGVudW0KY29uc3QgZW5jb2Rpbmc0ID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBlbnVtIGlzIDAgc28gYWx3YXlzIG9uZSBieXRlCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzd2l0Y2ggKG0pIHsKICAgICAgY2FzZSAnYmxha2UyYic6CiAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBlbnVtJykKICAgIH0KICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHN3aXRjaCAoYy51aW50LmRlY29kZShzdGF0ZSkpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHJldHVybiAnYmxha2UyYicKICAgICAgZGVmYXVsdDogcmV0dXJuIG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IGVuY29kaW5nNV9lbnVtID0gewogIGVkMjU1MTk6ICdlZDI1NTE5Jwp9CgovLyBAY29yZS9zaWduYXR1cmVzIGVudW0KY29uc3QgZW5jb2Rpbmc1ID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBlbnVtIGlzIDAgc28gYWx3YXlzIG9uZSBieXRlCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzd2l0Y2ggKG0pIHsKICAgICAgY2FzZSAnZWQyNTUxOSc6CiAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBlbnVtJykKICAgIH0KICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHN3aXRjaCAoYy51aW50LmRlY29kZShzdGF0ZSkpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHJldHVybiAnZWQyNTUxOScKICAgICAgZGVmYXVsdDogcmV0dXJuIG51bGwKICAgIH0KICB9Cn0KCi8vIEBjb3JlL3RyZWUtbm9kZQpjb25zdCBlbmNvZGluZzYgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmluZGV4KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zaXplKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmluZGV4KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zaXplKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5oYXNoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMiA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IHIwLAogICAgICBzaXplOiByMSwKICAgICAgaGFzaDogcjIKICAgIH0KICB9Cn0KCi8vIEBjb3JlL3NpZ25lcgpjb25zdCBlbmNvZGluZzcgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBlbmNvZGluZzUucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ubmFtZXNwYWNlKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGVuY29kaW5nNS5lbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBlbmNvZGluZzUuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjIgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHNpZ25hdHVyZTogcjAsCiAgICAgIG5hbWVzcGFjZTogcjEsCiAgICAgIHB1YmxpY0tleTogcjIKICAgIH0KICB9Cn0KCi8vIEBjb3JlL3Byb2xvZ3VlCmNvbnN0IGVuY29kaW5nOCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGhhc2g6IHIwLAogICAgICBsZW5ndGg6IHIxCiAgICB9CiAgfQp9CgovLyBAY29yZS9tYW5pZmVzdC5zaWduZXJzCmNvbnN0IGVuY29kaW5nOV80ID0gYy5hcnJheShlbmNvZGluZzcpCi8vIEBjb3JlL21hbmlmZXN0LmxpbmtlZApjb25zdCBlbmNvZGluZzlfNiA9IGMuYXJyYXkoYy5maXhlZDMyKQoKLy8gQGNvcmUvbWFuaWZlc3QKY29uc3QgZW5jb2Rpbmc5ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgOCBzbyBhbHdheXMgb25lIGJ5dGUKICAgIGVuY29kaW5nNC5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucXVvcnVtKQogICAgZW5jb2Rpbmc5XzQucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCgogICAgaWYgKG0ucHJvbG9ndWUpIGVuY29kaW5nOC5wcmVlbmNvZGUoc3RhdGUsIG0ucHJvbG9ndWUpCiAgICBpZiAobS5saW5rZWQpIGVuY29kaW5nOV82LnByZWVuY29kZShzdGF0ZSwgbS5saW5rZWQpCiAgICBpZiAobS51c2VyRGF0YSkgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnVzZXJEYXRhKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9CiAgICAgIChtLmFsbG93UGF0Y2ggPyAxIDogMCkgfAogICAgICAobS5wcm9sb2d1ZSA/IDIgOiAwKSB8CiAgICAgIChtLmxpbmtlZCA/IDQgOiAwKSB8CiAgICAgIChtLnVzZXJEYXRhID8gOCA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBlbmNvZGluZzQuZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnF1b3J1bSkKICAgIGVuY29kaW5nOV80LmVuY29kZShzdGF0ZSwgbS5zaWduZXJzKQoKICAgIGlmIChtLnByb2xvZ3VlKSBlbmNvZGluZzguZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlKQogICAgaWYgKG0ubGlua2VkKSBlbmNvZGluZzlfNi5lbmNvZGUoc3RhdGUsIG0ubGlua2VkKQogICAgaWYgKG0udXNlckRhdGEpIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS51c2VyRGF0YSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IHIwLAogICAgICBoYXNoOiBlbmNvZGluZzQuZGVjb2RlKHN0YXRlKSwKICAgICAgcXVvcnVtOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYWxsb3dQYXRjaDogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIHNpZ25lcnM6IGVuY29kaW5nOV80LmRlY29kZShzdGF0ZSksCiAgICAgIHByb2xvZ3VlOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGVuY29kaW5nOC5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgbGlua2VkOiAoZmxhZ3MgJiA0KSAhPT0gMCA/IGVuY29kaW5nOV82LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB1c2VyRGF0YTogKGZsYWdzICYgOCkgIT09IDAgPyBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKLy8gQGNvcmUva2V5UGFpcgpjb25zdCBlbmNvZGluZzEwID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS5zZWNyZXRLZXkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0uc2VjcmV0S2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy5idWZmZXIuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHB1YmxpY0tleTogcjAsCiAgICAgIHNlY3JldEtleTogcjEKICAgIH0KICB9Cn0KCi8vIEBjb3JlL2F1dGgubWFuaWZlc3QKY29uc3QgZW5jb2RpbmcxMV8yID0gYy5mcmFtZShlbmNvZGluZzkpCgovLyBAY29yZS9hdXRoCmNvbnN0IGVuY29kaW5nMTEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0uZGlzY292ZXJ5S2V5KQogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgNCBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5tYW5pZmVzdCkgZW5jb2RpbmcxMV8yLnByZWVuY29kZShzdGF0ZSwgbS5tYW5pZmVzdCkKICAgIGlmIChtLmtleVBhaXIpIGVuY29kaW5nMTAucHJlZW5jb2RlKHN0YXRlLCBtLmtleVBhaXIpCiAgICBpZiAobS5lbmNyeXB0aW9uS2V5KSBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0uZW5jcnlwdGlvbktleSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPQogICAgICAobS5tYW5pZmVzdCA/IDEgOiAwKSB8CiAgICAgIChtLmtleVBhaXIgPyAyIDogMCkgfAogICAgICAobS5lbmNyeXB0aW9uS2V5ID8gNCA6IDApCgogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmRpc2NvdmVyeUtleSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLm1hbmlmZXN0KSBlbmNvZGluZzExXzIuZW5jb2RlKHN0YXRlLCBtLm1hbmlmZXN0KQogICAgaWYgKG0ua2V5UGFpcikgZW5jb2RpbmcxMC5lbmNvZGUoc3RhdGUsIG0ua2V5UGFpcikKICAgIGlmIChtLmVuY3J5cHRpb25LZXkpIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS5lbmNyeXB0aW9uS2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAga2V5OiByMCwKICAgICAgZGlzY292ZXJ5S2V5OiByMSwKICAgICAgbWFuaWZlc3Q6IChmbGFncyAmIDEpICE9PSAwID8gZW5jb2RpbmcxMV8yLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBrZXlQYWlyOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGVuY29kaW5nMTAuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGVuY3J5cHRpb25LZXk6IChmbGFncyAmIDQpICE9PSAwID8gYy5idWZmZXIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCi8vIEBjb3JlL2hlYWQKY29uc3QgZW5jb2RpbmcxMiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZm9yaykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5yb290SGFzaCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZm9yaykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5yb290SGFzaCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIyID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIzID0gYy5idWZmZXIuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGZvcms6IHIwLAogICAgICBsZW5ndGg6IHIxLAogICAgICByb290SGFzaDogcjIsCiAgICAgIHNpZ25hdHVyZTogcjMKICAgIH0KICB9Cn0KCi8vIEBjb3JlL2hpbnRzCmNvbnN0IGVuY29kaW5nMTMgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAyIHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLmNvbnRpZ3VvdXNMZW5ndGgpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uY29udGlndW91c0xlbmd0aCkKICAgIGlmIChtLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVtb3RlQ29udGlndW91c0xlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPQogICAgICAobS5jb250aWd1b3VzTGVuZ3RoID8gMSA6IDApIHwKICAgICAgKG0ucmVtb3RlQ29udGlndW91c0xlbmd0aCA/IDIgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLmNvbnRpZ3VvdXNMZW5ndGgpIGMudWludC5lbmNvZGUoc3RhdGUsIG0uY29udGlndW91c0xlbmd0aCkKICAgIGlmIChtLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVtb3RlQ29udGlndW91c0xlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IChmbGFncyAmIDEpICE9PSAwID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwLAogICAgICByZW1vdGVDb250aWd1b3VzTGVuZ3RoOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgfQogIH0KfQoKLy8gQGNvcmUvc2Vzc2lvbgpjb25zdCBlbmNvZGluZzE0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWUpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmRhdGFQb2ludGVyKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIG0ubmFtZSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZGF0YVBvaW50ZXIpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy5zdHJpbmcuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IHIwLAogICAgICBkYXRhUG9pbnRlcjogcjEKICAgIH0KICB9Cn0KCi8vIEBjb3JlL3Nlc3Npb25zCmNvbnN0IGVuY29kaW5nMTUgPSBjLmFycmF5KGVuY29kaW5nMTQpCgovLyBAY29yZS9kZXBlbmRlbmN5CmNvbnN0IGVuY29kaW5nMTYgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmRhdGFQb2ludGVyKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZGF0YVBvaW50ZXIpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGRhdGFQb2ludGVyOiByMCwKICAgICAgbGVuZ3RoOiByMQogICAgfQogIH0KfQoKZnVuY3Rpb24gc2V0VmVyc2lvbih2KSB7CiAgdmVyc2lvbiA9IHYKfQoKZnVuY3Rpb24gZW5jb2RlKG5hbWUsIHZhbHVlLCB2ID0gVkVSU0lPTikgewogIHZlcnNpb24gPSB2CiAgcmV0dXJuIGMuZW5jb2RlKGdldEVuY29kaW5nKG5hbWUpLCB2YWx1ZSkKfQoKZnVuY3Rpb24gZGVjb2RlKG5hbWUsIGJ1ZmZlciwgdiA9IFZFUlNJT04pIHsKICB2ZXJzaW9uID0gdgogIHJldHVybiBjLmRlY29kZShnZXRFbmNvZGluZyhuYW1lKSwgYnVmZmVyKQp9CgpmdW5jdGlvbiBnZXRFbnVtKG5hbWUpIHsKICBzd2l0Y2ggKG5hbWUpIHsKICAgIGNhc2UgJ0Bjb3JlL2hhc2hlcyc6CiAgICAgIHJldHVybiBlbmNvZGluZzRfZW51bQogICAgY2FzZSAnQGNvcmUvc2lnbmF0dXJlcyc6CiAgICAgIHJldHVybiBlbmNvZGluZzVfZW51bQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbnVtIG5vdCBmb3VuZCAnICsgbmFtZSkKICB9Cn0KCmZ1bmN0aW9uIGdldEVuY29kaW5nKG5hbWUpIHsKICBzd2l0Y2ggKG5hbWUpIHsKICAgIGNhc2UgJ0Bjb3Jlc3RvcmUvYWxsb2NhdGVkJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMAogICAgY2FzZSAnQGNvcmVzdG9yZS9oZWFkJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMQogICAgY2FzZSAnQGNvcmVzdG9yZS9hbGlhcyc6CiAgICAgIHJldHVybiBlbmNvZGluZzIKICAgIGNhc2UgJ0Bjb3Jlc3RvcmUvY29yZSc6CiAgICAgIHJldHVybiBlbmNvZGluZzMKICAgIGNhc2UgJ0Bjb3JlL2hhc2hlcyc6CiAgICAgIHJldHVybiBlbmNvZGluZzQKICAgIGNhc2UgJ0Bjb3JlL3NpZ25hdHVyZXMnOgogICAgICByZXR1cm4gZW5jb2Rpbmc1CiAgICBjYXNlICdAY29yZS90cmVlLW5vZGUnOgogICAgICByZXR1cm4gZW5jb2Rpbmc2CiAgICBjYXNlICdAY29yZS9zaWduZXInOgogICAgICByZXR1cm4gZW5jb2Rpbmc3CiAgICBjYXNlICdAY29yZS9wcm9sb2d1ZSc6CiAgICAgIHJldHVybiBlbmNvZGluZzgKICAgIGNhc2UgJ0Bjb3JlL21hbmlmZXN0JzoKICAgICAgcmV0dXJuIGVuY29kaW5nOQogICAgY2FzZSAnQGNvcmUva2V5UGFpcic6CiAgICAgIHJldHVybiBlbmNvZGluZzEwCiAgICBjYXNlICdAY29yZS9hdXRoJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTEKICAgIGNhc2UgJ0Bjb3JlL2hlYWQnOgogICAgICByZXR1cm4gZW5jb2RpbmcxMgogICAgY2FzZSAnQGNvcmUvaGludHMnOgogICAgICByZXR1cm4gZW5jb2RpbmcxMwogICAgY2FzZSAnQGNvcmUvc2Vzc2lvbic6CiAgICAgIHJldHVybiBlbmNvZGluZzE0CiAgICBjYXNlICdAY29yZS9zZXNzaW9ucyc6CiAgICAgIHJldHVybiBlbmNvZGluZzE1CiAgICBjYXNlICdAY29yZS9kZXBlbmRlbmN5JzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTYKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcignRW5jb2RlciBub3QgZm91bmQgJyArIG5hbWUpCiAgfQp9CgpmdW5jdGlvbiBnZXRTdHJ1Y3QobmFtZSwgdiA9IFZFUlNJT04pIHsKICBjb25zdCBlbmMgPSBnZXRFbmNvZGluZyhuYW1lKQogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgZW5jLnByZWVuY29kZShzdGF0ZSwgbSkKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgZW5jLmVuY29kZShzdGF0ZSwgbSkKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgcmV0dXJuIGVuYy5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZXNvbHZlU3RydWN0ID0gZ2V0U3RydWN0IC8vIGNvbXBhdAoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgcmVzb2x2ZVN0cnVjdCwKICBnZXRTdHJ1Y3QsCiAgZ2V0RW51bSwKICBnZXRFbmNvZGluZywKICBlbmNvZGUsCiAgZGVjb2RlLAogIHNldFZlcnNpb24sCiAgdmVyc2lvbgp9CmNvbnN0IHsgRXZlbnRFbWl0dGVyIH0gPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCBpc09wdGlvbnMgPSByZXF1aXJlKCdpcy1vcHRpb25zJykKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IENvcmVTdG9yYWdlID0gcmVxdWlyZSgnaHlwZXJjb3JlLXN0b3JhZ2UnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IE5vaXNlU2VjcmV0U3RyZWFtID0gcmVxdWlyZSgnQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbScpCmNvbnN0IFByb3RvbXV4ID0gcmVxdWlyZSgncHJvdG9tdXgnKQpjb25zdCBpZCA9IHJlcXVpcmUoJ2h5cGVyY29yZS1pZC1lbmNvZGluZycpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKCmNvbnN0IGluc3BlY3QgPSByZXF1aXJlKCcuL2xpYi9pbnNwZWN0JykKY29uc3QgQ29yZSA9IHJlcXVpcmUoJy4vbGliL2NvcmUnKQpjb25zdCBJbmZvID0gcmVxdWlyZSgnLi9saWIvaW5mbycpCmNvbnN0IERvd25sb2FkID0gcmVxdWlyZSgnLi9saWIvZG93bmxvYWQnKQpjb25zdCBEZWZhdWx0RW5jcnlwdGlvbiA9IHJlcXVpcmUoJy4vbGliL2RlZmF1bHQtZW5jcnlwdGlvbicpCmNvbnN0IGNhcHMgPSByZXF1aXJlKCcuL2xpYi9jYXBzJykKY29uc3QgUmVwbGljYXRvciA9IHJlcXVpcmUoJy4vbGliL3JlcGxpY2F0b3InKQpjb25zdCB7IG1hbmlmZXN0SGFzaCwgY3JlYXRlTWFuaWZlc3QgfSA9IHJlcXVpcmUoJy4vbGliL3ZlcmlmaWVyJykKY29uc3QgeyBSZWFkU3RyZWFtLCBXcml0ZVN0cmVhbSwgQnl0ZVN0cmVhbSB9ID0gcmVxdWlyZSgnLi9saWIvc3RyZWFtcycpCmNvbnN0IHsgTWVya2xlVHJlZSB9ID0gcmVxdWlyZSgnLi9saWIvbWVya2xlLXRyZWUnKQpjb25zdCB7CiAgQVNTRVJUSU9OLAogIEJBRF9BUkdVTUVOVCwKICBTRVNTSU9OX0NMT1NFRCwKICBTRVNTSU9OX01PVkVELAogIFNFU1NJT05fTk9UX1dSSVRBQkxFLAogIFNOQVBTSE9UX05PVF9BVkFJTEFCTEUsCiAgREVDT0RJTkdfRVJST1IKfSA9IHJlcXVpcmUoJ2h5cGVyY29yZS1lcnJvcnMnKQoKLy8gSHlwZXJjb3JlIGFjdHVhbGx5IGRvZXMgbm90IGhhdmUgYW55IG5vdGlvbiBvZiBtYXgvbWluIGJsb2NrIHNpemVzCi8vIGJ1dCB3ZSBlbmZvcmNlIDE1bWIgdG8gZW5zdXJlIHNtb290aCByZXBsaWNhdGlvbiAoZWFjaCBibG9jayBpcyB0cmFuc21pdHRlZCBhdG9taWNhbGx5KQpjb25zdCBNQVhfU1VHR0VTVEVEX0JMT0NLX1NJWkUgPSAxNSAqIDEwMjQgKiAxMDI0CgpjbGFzcyBIeXBlcmNvcmUgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKHN0b3JhZ2UsIGtleSwgb3B0cykgewogICAgc3VwZXIoKQoKICAgIGlmIChpc09wdGlvbnMoc3RvcmFnZSkgJiYgIXN0b3JhZ2UuZGIpIHsKICAgICAgb3B0cyA9IHN0b3JhZ2UKICAgICAgc3RvcmFnZSA9IG51bGwKICAgICAga2V5ID0gb3B0cy5rZXkgfHwgbnVsbAogICAgfSBlbHNlIGlmIChpc09wdGlvbnMoa2V5KSkgewogICAgICBvcHRzID0ga2V5CiAgICAgIGtleSA9IG9wdHMua2V5IHx8IG51bGwKICAgIH0KCiAgICBpZiAoa2V5ICYmIHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnKSBrZXkgPSBpZC5kZWNvZGUoa2V5KQogICAgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgICBpZiAoIXN0b3JhZ2UpIHN0b3JhZ2UgPSBvcHRzLnN0b3JhZ2UKCiAgICB0aGlzLmNvcmUgPSBudWxsCiAgICB0aGlzLnN0YXRlID0gbnVsbAogICAgdGhpcy5lbmNyeXB0aW9uID0gbnVsbAogICAgdGhpcy5leHRlbnNpb25zID0gbmV3IE1hcCgpCgogICAgdGhpcy52YWx1ZUVuY29kaW5nID0gbnVsbAogICAgdGhpcy5lbmNvZGVCYXRjaCA9IG51bGwKICAgIHRoaXMuYWN0aXZlUmVxdWVzdHMgPSBbXQogICAgdGhpcy5zZXNzaW9ucyA9IG51bGwKICAgIHRoaXMub25nYyA9IG51bGwKCiAgICB0aGlzLmtleVBhaXIgPSBvcHRzLmtleVBhaXIgfHwgbnVsbAogICAgdGhpcy5yZWFkYWJsZSA9IHRydWUKICAgIHRoaXMud3JpdGFibGUgPSBmYWxzZQogICAgdGhpcy5leGNsdXNpdmUgPSBmYWxzZQogICAgdGhpcy5vcGVuZWQgPSBmYWxzZQogICAgdGhpcy5jbG9zZWQgPSBmYWxzZQogICAgdGhpcy53ZWFrID0gISFvcHRzLndlYWsKICAgIHRoaXMuc25hcHNob3R0ZWQgPSAhIW9wdHMuc25hcHNob3QKICAgIHRoaXMub25zZXEgPSBvcHRzLm9uc2VxIHx8IG51bGwKICAgIHRoaXMub253YWl0ID0gb3B0cy5vbndhaXQgfHwgbnVsbAogICAgdGhpcy53YWl0ID0gb3B0cy53YWl0ICE9PSBmYWxzZQogICAgdGhpcy50aW1lb3V0ID0gb3B0cy50aW1lb3V0IHx8IDAKICAgIHRoaXMucHJlbG9hZCA9IG51bGwKICAgIHRoaXMuY2xvc2luZyA9IG51bGwKICAgIHRoaXMub3BlbmluZyA9IG51bGwKCiAgICB0aGlzLl9yZWFkb25seSA9IG9wdHMud3JpdGFibGUgPT09IGZhbHNlCiAgICB0aGlzLl9wcmVhcHBlbmQgPSBwcmVhcHBlbmQuYmluZCh0aGlzKQogICAgdGhpcy5fc25hcHNob3QgPSBudWxsCiAgICB0aGlzLl9maW5kaW5nUGVlcnMgPSAwCiAgICB0aGlzLl9hY3RpdmUgPSBvcHRzLndlYWsgPyAhIW9wdHMuYWN0aXZlIDogb3B0cy5hY3RpdmUgIT09IGZhbHNlCgogICAgdGhpcy5fc2Vzc2lvbkluZGV4ID0gLTEKICAgIHRoaXMuX3N0YXRlSW5kZXggPSAtMSAvLyBtYWludGFpbmVkIGJ5IHNlc3Npb24gc3RhdGUKICAgIHRoaXMuX21vbml0b3JJbmRleCA9IC0xIC8vIG1haW50YWluZWQgYnkgcmVwbGljYXRpb24gc3RhdGUKCiAgICB0aGlzLm9wZW5pbmcgPSB0aGlzLl9vcGVuKHN0b3JhZ2UsIGtleSwgb3B0cykKICAgIHRoaXMub3BlbmluZy5jYXRjaChzYWZldHlDYXRjaCkKCiAgICB0aGlzLm9uKCduZXdMaXN0ZW5lcicsIG1heWJlQWRkTW9uaXRvcikKICB9CgogIFtTeW1ib2wuZm9yKCdub2RlanMudXRpbC5pbnNwZWN0LmN1c3RvbScpXShkZXB0aCwgb3B0cykgewogICAgcmV0dXJuIGluc3BlY3QodGhpcywgZGVwdGgsIG9wdHMpCiAgfQoKICBzdGF0aWMgTUFYX1NVR0dFU1RFRF9CTE9DS19TSVpFID0gTUFYX1NVR0dFU1RFRF9CTE9DS19TSVpFCgogIHN0YXRpYyBEZWZhdWx0RW5jcnlwdGlvbiA9IERlZmF1bHRFbmNyeXB0aW9uCgogIHN0YXRpYyBrZXkobWFuaWZlc3QsIHsgY29tcGF0LCB2ZXJzaW9uLCBuYW1lc3BhY2UgfSA9IHt9KSB7CiAgICBpZiAoYjRhLmlzQnVmZmVyKG1hbmlmZXN0KSkgewogICAgICBtYW5pZmVzdCA9IHsgdmVyc2lvbiwgc2lnbmVyczogW3sgcHVibGljS2V5OiBtYW5pZmVzdCwgbmFtZXNwYWNlIH1dIH0KICAgIH0KICAgIHJldHVybiBjb21wYXQgPyBtYW5pZmVzdC5zaWduZXJzWzBdLnB1YmxpY0tleSA6IG1hbmlmZXN0SGFzaChjcmVhdGVNYW5pZmVzdChtYW5pZmVzdCkpCiAgfQoKICBzdGF0aWMgZGlzY292ZXJ5S2V5KGtleSkgewogICAgcmV0dXJuIGNyeXB0by5kaXNjb3ZlcnlLZXkoa2V5KQogIH0KCiAgc3RhdGljIGJsb2NrRW5jcnlwdGlvbktleShrZXksIGVuY3J5cHRpb25LZXkpIHsKICAgIHJldHVybiBEZWZhdWx0RW5jcnlwdGlvbi5ibG9ja0VuY3J5cHRpb25LZXkoa2V5LCBlbmNyeXB0aW9uS2V5KQogIH0KCiAgc3RhdGljIGdldFByb3RvY29sTXV4ZXIoc3RyZWFtKSB7CiAgICByZXR1cm4gc3RyZWFtLm5vaXNlU3RyZWFtLnVzZXJEYXRhCiAgfQoKICBzdGF0aWMgY3JlYXRlQ29yZShzdG9yYWdlLCBvcHRzKSB7CiAgICByZXR1cm4gbmV3IENvcmUoSHlwZXJjb3JlLmRlZmF1bHRTdG9yYWdlKHN0b3JhZ2UpLCB7IGF1dG9DbG9zZTogZmFsc2UsIC4uLm9wdHMgfSkKICB9CgogIHN0YXRpYyBjcmVhdGVQcm90b2NvbFN0cmVhbShpc0luaXRpYXRvciwgb3B0cyA9IHt9KSB7CiAgICBsZXQgb3V0ZXJTdHJlYW0gPSBQcm90b211eC5pc1Byb3RvbXV4KGlzSW5pdGlhdG9yKQogICAgICA/IGlzSW5pdGlhdG9yLnN0cmVhbQogICAgICA6IGlzU3RyZWFtKGlzSW5pdGlhdG9yKQogICAgICAgID8gaXNJbml0aWF0b3IKICAgICAgICA6IG9wdHMuc3RyZWFtCgogICAgbGV0IG5vaXNlU3RyZWFtID0gbnVsbAoKICAgIGlmIChvdXRlclN0cmVhbSkgewogICAgICBub2lzZVN0cmVhbSA9IG91dGVyU3RyZWFtLm5vaXNlU3RyZWFtCiAgICB9IGVsc2UgewogICAgICBub2lzZVN0cmVhbSA9IG5ldyBOb2lzZVNlY3JldFN0cmVhbShpc0luaXRpYXRvciwgbnVsbCwgb3B0cykKICAgICAgb3V0ZXJTdHJlYW0gPSBub2lzZVN0cmVhbS5yYXdTdHJlYW0KICAgIH0KICAgIGlmICghbm9pc2VTdHJlYW0pIHRocm93IEJBRF9BUkdVTUVOVCgnSW52YWxpZCBzdHJlYW0nLCB0aGlzLmRpc2NvdmVyeUtleSkKCiAgICBpZiAoIW5vaXNlU3RyZWFtLnVzZXJEYXRhKSB7CiAgICAgIGNvbnN0IHByb3RvY29sID0gUHJvdG9tdXguZnJvbShub2lzZVN0cmVhbSkKCiAgICAgIGlmIChvcHRzLmtlZXBBbGl2ZSAhPT0gZmFsc2UgJiYgbm9pc2VTdHJlYW0ua2VlcEFsaXZlID09PSAwKSB7CiAgICAgICAgbm9pc2VTdHJlYW0uc2V0S2VlcEFsaXZlKDUwMDApCiAgICAgIH0KICAgICAgbm9pc2VTdHJlYW0udXNlckRhdGEgPSBwcm90b2NvbAogICAgfQoKICAgIGlmIChvcHRzLm9uZGlzY292ZXJ5a2V5KSB7CiAgICAgIG5vaXNlU3RyZWFtLnVzZXJEYXRhLnBhaXIoeyBwcm90b2NvbDogJ2h5cGVyY29yZS9hbHBoYScgfSwgb3B0cy5vbmRpc2NvdmVyeWtleSkKICAgIH0KCiAgICByZXR1cm4gb3V0ZXJTdHJlYW0KICB9CgogIHN0YXRpYyBkZWZhdWx0U3RvcmFnZShzdG9yYWdlLCBvcHRzID0ge30pIHsKICAgIGlmIChDb3JlU3RvcmFnZS5pc0NvcmVTdG9yYWdlKHN0b3JhZ2UpKSByZXR1cm4gc3RvcmFnZQoKICAgIGNvbnN0IGRpcmVjdG9yeSA9IHN0b3JhZ2UKICAgIHJldHVybiBuZXcgQ29yZVN0b3JhZ2UoZGlyZWN0b3J5LCBvcHRzKQogIH0KCiAgc3RhdGljIGNsZWFyUmVxdWVzdHMoc2Vzc2lvbiwgZXJyKSB7CiAgICByZXR1cm4gUmVwbGljYXRvci5jbGVhclJlcXVlc3RzKHNlc3Npb24sIGVycikKICB9CgogIHNuYXBzaG90KG9wdHMpIHsKICAgIHJldHVybiB0aGlzLnNlc3Npb24oeyAuLi5vcHRzLCBzbmFwc2hvdDogdHJ1ZSB9KQogIH0KCiAgY29tcGFjdCgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUuY29tcGFjdCgpCiAgfQoKICBzZXNzaW9uKG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMuY2xvc2luZykgewogICAgICAvLyBUaGlzIG1ha2VzIHRoZSBjbG9zaW5nIGxvZ2ljIGEgbG90IGVhc2llci4gSWYgdGhpcyB0dXJucyBvdXQgdG8gYmUgYSBwcm9ibGVtCiAgICAgIC8vIGluIHByYWN0aWNlLCBvcGVuIGFuIGlzc3VlIGFuZCB3ZSdsbCB0cnkgdG8gbWFrZSBhIHNvbHV0aW9uIGZvciBpdC4KICAgICAgdGhyb3cgU0VTU0lPTl9DTE9TRUQoJ0Nhbm5vdCBtYWtlIHNlc3Npb25zIG9uIGEgY2xvc2luZyBjb3JlJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CiAgICBpZiAob3B0cy5jaGVja291dCAhPT0gdW5kZWZpbmVkICYmICFvcHRzLm5hbWUgJiYgIW9wdHMuYXRvbSkgewogICAgICB0aHJvdyBBU1NFUlRJT04oJ0NoZWNrb3V0cyBhcmUgb25seSBzdXBwb3J0ZWQgb24gYXRvbXMgb3IgbmFtZWQgc2Vzc2lvbnMnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICBjb25zdCB3YWl0ID0gb3B0cy53YWl0ID09PSBmYWxzZSA/IGZhbHNlIDogdGhpcy53YWl0CiAgICBjb25zdCB3cml0YWJsZSA9IG9wdHMud3JpdGFibGUgPT09IHVuZGVmaW5lZCA/ICF0aGlzLl9yZWFkb25seSA6IG9wdHMud3JpdGFibGUgPT09IHRydWUKICAgIGNvbnN0IG9ud2FpdCA9IG9wdHMub253YWl0ID09PSB1bmRlZmluZWQgPyB0aGlzLm9ud2FpdCA6IG9wdHMub253YWl0CiAgICBjb25zdCBvbnNlcSA9IG9wdHMub25zZXEgPT09IHVuZGVmaW5lZCA/IHRoaXMub25zZXEgOiBvcHRzLm9uc2VxCiAgICBjb25zdCB0aW1lb3V0ID0gb3B0cy50aW1lb3V0ID09PSB1bmRlZmluZWQgPyB0aGlzLnRpbWVvdXQgOiBvcHRzLnRpbWVvdXQKICAgIGNvbnN0IHdlYWsgPSBvcHRzLndlYWsgPT09IHVuZGVmaW5lZCA/IHRoaXMud2VhayA6IG9wdHMud2VhawogICAgY29uc3QgQ2x6ID0gb3B0cy5jbGFzcyB8fCBIeXBlcmNvcmUKICAgIGNvbnN0IHMgPSBuZXcgQ2x6KG51bGwsIHRoaXMua2V5LCB7CiAgICAgIC4uLm9wdHMsCiAgICAgIHdhaXQsCiAgICAgIG9ud2FpdCwKICAgICAgb25zZXEsCiAgICAgIHRpbWVvdXQsCiAgICAgIHdyaXRhYmxlLAogICAgICB3ZWFrLAogICAgICBwYXJlbnQ6IHRoaXMKICAgIH0pCgogICAgcmV0dXJuIHMKICB9CgogIGFzeW5jIHNldEVuY3J5cHRpb25LZXkoa2V5LCBvcHRzKSB7CiAgICBpZiAoIXRoaXMub3BlbmVkKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGNvbnN0IGVuY3J5cHRpb24gPSB0aGlzLl9nZXRFbmNyeXB0aW9uUHJvdmlkZXIoeyBrZXksIGJsb2NrOiAhIShvcHRzICYmIG9wdHMuYmxvY2spIH0pCiAgICByZXR1cm4gdGhpcy5zZXRFbmNyeXB0aW9uKGVuY3J5cHRpb24pCiAgfQoKICBhc3luYyBzZXRFbmNyeXB0aW9uKGVuY3J5cHRpb24pIHsKICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMub3BlbmluZwoKICAgIGlmIChlbmNyeXB0aW9uID09PSBudWxsKSB7CiAgICAgIHRoaXMuZW5jcnlwdGlvbiA9IGVuY3J5cHRpb24KICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKCFpc0VuY3J5cHRpb25Qcm92aWRlcihlbmNyeXB0aW9uKSkgewogICAgICB0aHJvdyBBU1NFUlRJT04oJ1Byb3ZpZGVyIGRvZXMgbm90IHNhdGlzZnkgSHlwZXJjb3JlRW5jcnlwdGlvbiBpbnRlcmZhY2UnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICB0aGlzLmVuY3J5cHRpb24gPSBlbmNyeXB0aW9uCiAgfQoKICBzZXRLZXlQYWlyKGtleVBhaXIpIHsKICAgIHRoaXMua2V5UGFpciA9IGtleVBhaXIKICB9CgogIHNldEFjdGl2ZShib29sKSB7CiAgICBjb25zdCBhY3RpdmUgPSAhIWJvb2wKICAgIGlmIChhY3RpdmUgPT09IHRoaXMuX2FjdGl2ZSB8fCB0aGlzLmNsb3NpbmcpIHJldHVybgogICAgdGhpcy5fYWN0aXZlID0gYWN0aXZlCiAgICBpZiAoIXRoaXMub3BlbmVkKSByZXR1cm4KICAgIHRoaXMuY29yZS5yZXBsaWNhdG9yLnVwZGF0ZUFjdGl2aXR5KHRoaXMuX2FjdGl2ZSA/IDEgOiAtMSkKICB9CgogIGFzeW5jIF9vcGVuKHN0b3JhZ2UsIGtleSwgb3B0cykgewogICAgY29uc3QgcHJlbG9hZCA9IG9wdHMucHJlbG9hZCB8fCAob3B0cy5wYXJlbnQgJiYgb3B0cy5wYXJlbnQucHJlbG9hZCkKCiAgICBpZiAocHJlbG9hZCkgewogICAgICB0aGlzLnNlc3Npb25zID0gW10gLy8gaW4gY2FzZSBzb21lb25lIGxvb2tzIGF0IGl0IGxpa2Ugd2l0aCBwZWVycwogICAgICB0aGlzLnByZWxvYWQgPSBwcmVsb2FkCiAgICAgIG9wdHMgPSB7IC4uLm9wdHMsIC4uLihhd2FpdCB0aGlzLnByZWxvYWQpIH0KICAgICAgdGhpcy5wcmVsb2FkID0gbnVsbAogICAgfQoKICAgIGNvbnN0IHBhcmVudCA9IG9wdHMucGFyZW50IHx8IG51bGwKICAgIGNvbnN0IGNvcmUgPSBvcHRzLmNvcmUgfHwgKHBhcmVudCAmJiBwYXJlbnQuY29yZSkKICAgIGNvbnN0IHNlc3Npb25zID0gb3B0cy5zZXNzaW9ucyB8fCAocGFyZW50ICYmIHBhcmVudC5zZXNzaW9ucykKICAgIGNvbnN0IG9uZ2MgPSBvcHRzLm9uZ2MgfHwgKHBhcmVudCAmJiBwYXJlbnQub25nYykKCiAgICBpZiAoY29yZSkgdGhpcy5jb3JlID0gY29yZQogICAgaWYgKG9uZ2MpIHRoaXMub25nYyA9IG9uZ2MKICAgIGlmIChzZXNzaW9ucykgdGhpcy5zZXNzaW9ucyA9IHNlc3Npb25zCgogICAgaWYgKHRoaXMuc2Vzc2lvbnMgPT09IG51bGwpIHRoaXMuc2Vzc2lvbnMgPSBbXQogICAgdGhpcy5fc2Vzc2lvbkluZGV4ID0gdGhpcy5zZXNzaW9ucy5wdXNoKHRoaXMpIC0gMQoKICAgIGlmICh0aGlzLmNvcmUgPT09IG51bGwpIGluaXRPbmNlKHRoaXMsIHN0b3JhZ2UsIGtleSwgb3B0cykKICAgIGlmICh0aGlzLl9tb25pdG9ySW5kZXggPT09IC0yKSB0aGlzLmNvcmUuYWRkTW9uaXRvcih0aGlzKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX29wZW5TZXNzaW9uKG9wdHMpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKHRoaXMuY29yZS5hdXRvQ2xvc2UgJiYgdGhpcy5jb3JlLmhhc1Nlc3Npb24oKSA9PT0gZmFsc2UpIGF3YWl0IHRoaXMuY29yZS5jbG9zZSgpCgogICAgICBpZiAodGhpcy5leGNsdXNpdmUpIHRoaXMuY29yZS51bmxvY2tFeGNsdXNpdmUoKQoKICAgICAgdGhpcy5jb3JlLnJlbW92ZU1vbml0b3IodGhpcykKICAgICAgdGhpcy5fcmVtb3ZlU2Vzc2lvbigpCgogICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gbnVsbCkgdGhpcy5zdGF0ZS5yZW1vdmVTZXNzaW9uKHRoaXMpCgogICAgICB0aGlzLmNsb3NlZCA9IHRydWUKICAgICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgICAgIHRocm93IGVycgogICAgfQoKICAgIHRoaXMuZW1pdCgncmVhZHknKQoKICAgIC8vIGlmIHdlIGFyZSBhIHdlYWsgc2Vzc2lvbiB0aGUgY29yZSBtaWdodCBoYXZlIGNsb3NlZC4uLgogICAgaWYgKHRoaXMuY29yZS5jbG9zaW5nKSB0aGlzLmNsb3NlKCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgfQoKICBfcmVtb3ZlU2Vzc2lvbigpIHsKICAgIGlmICh0aGlzLl9zZXNzaW9uSW5kZXggPT09IC0xKSByZXR1cm4KICAgIGNvbnN0IGhlYWQgPSB0aGlzLnNlc3Npb25zLnBvcCgpCiAgICBpZiAoaGVhZCAhPT0gdGhpcykgdGhpcy5zZXNzaW9uc1soaGVhZC5fc2Vzc2lvbkluZGV4ID0gdGhpcy5fc2Vzc2lvbkluZGV4KV0gPSBoZWFkCiAgICB0aGlzLl9zZXNzaW9uSW5kZXggPSAtMQogICAgaWYgKHRoaXMub25nYyAhPT0gbnVsbCkgdGhpcy5vbmdjKHRoaXMpCiAgfQoKICBhc3luYyBfb3BlblNlc3Npb24ob3B0cykgewogICAgaWYgKHRoaXMuY29yZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQoKICAgIGlmICh0aGlzLmtleVBhaXIgPT09IG51bGwpIHRoaXMua2V5UGFpciA9IG9wdHMua2V5UGFpciB8fCB0aGlzLmNvcmUuaGVhZGVyLmtleVBhaXIKCiAgICBjb25zdCBwYXJlbnQgPSBvcHRzLnBhcmVudCB8fCBudWxsCiAgICBpZiAocGFyZW50ICYmIHBhcmVudC5lbmNyeXB0aW9uKSB0aGlzLmVuY3J5cHRpb24gPSBwYXJlbnQuZW5jcnlwdGlvbgoKICAgIGNvbnN0IGUgPSBnZXRFbmNyeXB0aW9uT3B0aW9uKG9wdHMpCiAgICBpZiAoIXRoaXMuZW5jcnlwdGlvbikgdGhpcy5lbmNyeXB0aW9uID0gdGhpcy5fZ2V0RW5jcnlwdGlvblByb3ZpZGVyKGUpCgogICAgdGhpcy53cml0YWJsZSA9IHRoaXMuX2lzV3JpdGFibGUoKQoKICAgIGlmIChvcHRzLnZhbHVlRW5jb2RpbmcpIHsKICAgICAgdGhpcy52YWx1ZUVuY29kaW5nID0gYy5mcm9tKG9wdHMudmFsdWVFbmNvZGluZykKICAgIH0KICAgIGlmIChvcHRzLmVuY29kZUJhdGNoKSB7CiAgICAgIHRoaXMuZW5jb2RlQmF0Y2ggPSBvcHRzLmVuY29kZUJhdGNoCiAgICB9CgogICAgaWYgKHBhcmVudCkgewogICAgICBpZiAocGFyZW50Ll9zdGF0ZUluZGV4ID09PSAtMSkgYXdhaXQgcGFyZW50LnJlYWR5KCkKICAgICAgaWYgKCF0aGlzLmtleVBhaXIpIHRoaXMua2V5UGFpciA9IHBhcmVudC5rZXlQYWlyCgogICAgICBjb25zdCBwcyA9IHBhcmVudC5zdGF0ZQoKICAgICAgaWYgKHBzKSB7CiAgICAgICAgY29uc3Qgc2hvdWxkU25hcHNob3QgPSB0aGlzLnNuYXBzaG90dGVkICYmICFwcy5pc1NuYXBzaG90KCkKICAgICAgICB0aGlzLnN0YXRlID0gc2hvdWxkU25hcHNob3QgPyBhd2FpdCBwcy5zbmFwc2hvdCgpIDogcHMucmVmKCkKICAgICAgfQoKICAgICAgaWYgKHRoaXMuc25hcHNob3R0ZWQgJiYgdGhpcy5jb3JlICYmICF0aGlzLl9zbmFwc2hvdCkgewogICAgICAgIHRoaXMuX3VwZGF0ZVNuYXBzaG90KCkKICAgICAgfQogICAgfQoKICAgIGlmIChvcHRzLmV4Y2x1c2l2ZSAmJiBvcHRzLndyaXRhYmxlICE9PSBmYWxzZSkgewogICAgICB0aGlzLmV4Y2x1c2l2ZSA9IHRydWUKICAgICAgYXdhaXQgdGhpcy5jb3JlLmxvY2tFeGNsdXNpdmUoKQogICAgfQoKICAgIGNvbnN0IHBhcmVudFN0YXRlID0gcGFyZW50ID8gcGFyZW50LnN0YXRlIDogdGhpcy5jb3JlLnN0YXRlCiAgICBjb25zdCBjaGVja291dCA9IG9wdHMuY2hlY2tvdXQgPT09IHVuZGVmaW5lZCA/IC0xIDogb3B0cy5jaGVja291dAogICAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlCgogICAgaWYgKG9wdHMuYXRvbSkgewogICAgICB0aGlzLnN0YXRlID0gYXdhaXQgcGFyZW50U3RhdGUuY3JlYXRlU2Vzc2lvbihudWxsLCBmYWxzZSwgb3B0cy5hdG9tKQogICAgICBpZiAoc3RhdGUpIHN0YXRlLnVucmVmKCkKICAgIH0gZWxzZSBpZiAob3B0cy5uYW1lKSB7CiAgICAgIC8vIHRvZG86IG5lZWQgdG8gbWFrZSBuYW1lZCBzZXNzaW9ucyBzYWZlIGJlZm9yZSByZWFkeQogICAgICAvLyBhdG0gd2UgYWx3YXlzIGNvcHkgdGhlIHN0YXRlIGluIHBhc3NDYXBhYmlsaXRpZXMKICAgICAgdGhpcy5zdGF0ZSA9IGF3YWl0IHBhcmVudFN0YXRlLmNyZWF0ZVNlc3Npb24ob3B0cy5uYW1lLCAhIW9wdHMub3ZlcndyaXRlLCBudWxsKQogICAgICBpZiAoc3RhdGUpIHN0YXRlLnVucmVmKCkgLy8gcmVmJ2VkIGFib3ZlIGluIHNldHVwIHNlc3Npb24KICAgIH0KCiAgICBpZiAodGhpcy5zdGF0ZSAmJiBjaGVja291dCAhPT0gLTEpIHsKICAgICAgaWYgKCFvcHRzLm5hbWUgJiYgIW9wdHMuYXRvbSkgewogICAgICAgIHRocm93IEFTU0VSVElPTignQ2hlY2tvdXRzIG11c3QgYmUgbmFtZWQgb3IgYXRvbWl6ZWQnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgICAgfQogICAgICBpZiAoY2hlY2tvdXQgPiB0aGlzLnN0YXRlLmxlbmd0aCkgewogICAgICAgIHRocm93IEFTU0VSVElPTigKICAgICAgICAgIGBJbnZhbGlkIGNoZWNrb3V0ICR7Y2hlY2tvdXR9IGZvciAke29wdHMubmFtZX0sIGxlbmd0aCBpcyAke3RoaXMuc3RhdGUubGVuZ3RofWAsCiAgICAgICAgICB0aGlzLmRpc2NvdmVyeUtleQogICAgICAgICkKICAgICAgfQogICAgICBpZiAodGhpcy5zdGF0ZS5wcm9sb2d1ZSAmJiBjaGVja291dCA8IHRoaXMuc3RhdGUucHJvbG9ndWUubGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgQVNTRVJUSU9OKAogICAgICAgICAgYEludmFsaWQgY2hlY2tvdXQgJHtjaGVja291dH0gZm9yICR7b3B0cy5uYW1lfSwgcHJvbG9ndWUgbGVuZ3RoIGlzICR7dGhpcy5zdGF0ZS5wcm9sb2d1ZS5sZW5ndGh9YCwKICAgICAgICAgIHRoaXMuZGlzY292ZXJ5S2V5CiAgICAgICAgKQogICAgICB9CiAgICAgIGlmIChjaGVja291dCA8IHRoaXMuc3RhdGUubGVuZ3RoKSBhd2FpdCB0aGlzLnN0YXRlLnRydW5jYXRlKGNoZWNrb3V0LCB0aGlzLmZvcmspCiAgICB9CgogICAgaWYgKHRoaXMuc3RhdGUgPT09IG51bGwpIHsKICAgICAgdGhpcy5zdGF0ZSA9IHRoaXMuY29yZS5zdGF0ZS5yZWYoKQogICAgfQoKICAgIHRoaXMud3JpdGFibGUgPSB0aGlzLl9pc1dyaXRhYmxlKCkKCiAgICBpZiAodGhpcy5zbmFwc2hvdHRlZCAmJiB0aGlzLmNvcmUpIHRoaXMuX3VwZGF0ZVNuYXBzaG90KCkKCiAgICB0aGlzLnN0YXRlLmFkZFNlc3Npb24odGhpcykKICAgIC8vIFRPRE86IHdlIG5lZWQgdG8gcmV3b3JrIHRoZSBjb3JlIHJlZmVyZW5jZSBmbG93LCBhcyB0aGUgc3RhdGUgYW5kIHNlc3Npb24gZG8gbm90IGFsd2F5cyBhZ3JlZSBub3cgZHVlIHRvIG1vdmVUbwogICAgdGhpcy5jb3JlID0gdGhpcy5zdGF0ZS5jb3JlIC8vIGluIGNhc2UgaXQgd2FzIHdyb25nLi4uCgogICAgaWYgKG9wdHMudXNlckRhdGEpIHsKICAgICAgY29uc3QgdHggPSB0aGlzLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQogICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvcHRzLnVzZXJEYXRhKSkgewogICAgICAgIHR4LnB1dFVzZXJEYXRhKGtleSwgdmFsdWUpCiAgICAgIH0KICAgICAgYXdhaXQgdHguZmx1c2goKQogICAgfQoKICAgIGlmIChvcHRzLm1hbmlmZXN0ICYmICF0aGlzLmNvcmUuaGVhZGVyLm1hbmlmZXN0KSB7CiAgICAgIGF3YWl0IHRoaXMuY29yZS5zZXRNYW5pZmVzdChjcmVhdGVNYW5pZmVzdChvcHRzLm1hbmlmZXN0KSkKICAgIH0KCiAgICB0aGlzLmNvcmUucmVwbGljYXRvci51cGRhdGVBY3Rpdml0eSh0aGlzLl9hY3RpdmUgPyAxIDogMCkKCiAgICB0aGlzLm9wZW5lZCA9IHRydWUKICB9CgogIGdldCByZXBsaWNhdG9yKCkgewogICAgcmV0dXJuIHRoaXMuY29yZSA9PT0gbnVsbCA/IG51bGwgOiB0aGlzLmNvcmUucmVwbGljYXRvcgogIH0KCiAgX2dldFNuYXBzaG90KCkgewogICAgcmV0dXJuIHsKICAgICAgbGVuZ3RoOiB0aGlzLnN0YXRlLmxlbmd0aCwKICAgICAgYnl0ZUxlbmd0aDogdGhpcy5zdGF0ZS5ieXRlTGVuZ3RoLAogICAgICBmb3JrOiB0aGlzLnN0YXRlLmZvcmsKICAgIH0KICB9CgogIF91cGRhdGVTbmFwc2hvdCgpIHsKICAgIGNvbnN0IHByZXYgPSB0aGlzLl9zbmFwc2hvdAogICAgY29uc3QgbmV4dCA9ICh0aGlzLl9zbmFwc2hvdCA9IHRoaXMuX2dldFNuYXBzaG90KCkpCgogICAgaWYgKCFwcmV2KSByZXR1cm4gdHJ1ZQogICAgcmV0dXJuIHByZXYubGVuZ3RoICE9PSBuZXh0Lmxlbmd0aCB8fCBwcmV2LmZvcmsgIT09IG5leHQuZm9yawogIH0KCiAgX2lzV3JpdGFibGUoKSB7CiAgICBpZiAodGhpcy5fcmVhZG9ubHkpIHJldHVybiBmYWxzZQogICAgaWYgKHRoaXMuc3RhdGUgJiYgIXRoaXMuc3RhdGUuaXNEZWZhdWx0KCkpIHJldHVybiB0cnVlCiAgICByZXR1cm4gISEodGhpcy5rZXlQYWlyICYmIHRoaXMua2V5UGFpci5zZWNyZXRLZXkpCiAgfQoKICBjbG9zZSh7IGVycm9yIH0gPSB7fSkgewogICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuIHRoaXMuY2xvc2luZwoKICAgIHRoaXMuY2xvc2luZyA9IHRoaXMuX2Nsb3NlKGVycm9yIHx8IG51bGwpCiAgICByZXR1cm4gdGhpcy5jbG9zaW5nCiAgfQoKICBjbGVhclJlcXVlc3RzKGFjdGl2ZVJlcXVlc3RzLCBlcnJvcikgewogICAgaWYgKCFhY3RpdmVSZXF1ZXN0cy5sZW5ndGgpIHJldHVybgogICAgaWYgKHRoaXMuY29yZSkgdGhpcy5jb3JlLnJlcGxpY2F0b3IuY2xlYXJSZXF1ZXN0cyhhY3RpdmVSZXF1ZXN0cywgZXJyb3IpCiAgfQoKICBhc3luYyBfY2xvc2UoZXJyb3IpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLm9wZW5pbmcKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKCF0aGlzLmNsb3NlZCkgdGhyb3cgZXJyCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5jbG9zZWQgPT09IHRydWUpIHJldHVybgoKICAgIHRoaXMuY29yZS5yZW1vdmVNb25pdG9yKHRoaXMpCiAgICB0aGlzLnN0YXRlLnJlbW92ZVNlc3Npb24odGhpcykKICAgIHRoaXMuX3JlbW92ZVNlc3Npb24oKQoKICAgIHRoaXMucmVhZGFibGUgPSBmYWxzZQogICAgdGhpcy53cml0YWJsZSA9IGZhbHNlCiAgICB0aGlzLm9wZW5lZCA9IGZhbHNlCgogICAgY29uc3QgZ2MgPSBbXQogICAgZm9yIChjb25zdCBleHQgb2YgdGhpcy5leHRlbnNpb25zLnZhbHVlcygpKSB7CiAgICAgIGlmIChleHQuc2Vzc2lvbiA9PT0gdGhpcykgZ2MucHVzaChleHQpCiAgICB9CiAgICBmb3IgKGNvbnN0IGV4dCBvZiBnYykgZXh0LmRlc3Ryb3koKQoKICAgIHRoaXMuY29yZS5yZXBsaWNhdG9yLmZpbmRpbmdQZWVycyAtPSB0aGlzLl9maW5kaW5nUGVlcnMKICAgIHRoaXMuY29yZS5yZXBsaWNhdG9yLmNsZWFyUmVxdWVzdHModGhpcy5hY3RpdmVSZXF1ZXN0cywgZXJyb3IpCiAgICB0aGlzLmNvcmUucmVwbGljYXRvci51cGRhdGVBY3Rpdml0eSh0aGlzLl9hY3RpdmUgPyAtMSA6IDApCgogICAgdGhpcy5fZmluZGluZ1BlZXJzID0gMAoKICAgIHRoaXMuc3RhdGUudW5yZWYoKQoKICAgIGlmICh0aGlzLmV4Y2x1c2l2ZSkgdGhpcy5jb3JlLnVubG9ja0V4Y2x1c2l2ZSgpCgogICAgaWYgKHRoaXMuY29yZS5oYXNTZXNzaW9uKCkpIHsKICAgICAgLy8gZW1pdCAiZmFrZSIgY2xvc2UgYXMgdGhpcyBpcyBhIHNlc3Npb24KICAgICAgdGhpcy5jbG9zZWQgPSB0cnVlCiAgICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5jb3JlLmF1dG9DbG9zZSkgYXdhaXQgdGhpcy5jb3JlLmNsb3NlKCkKCiAgICB0aGlzLmNsb3NlZCA9IHRydWUKICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogIH0KCiAgYXN5bmMgY29tbWl0KHNlc3Npb24sIG9wdHMpIHsKICAgIGF3YWl0IHRoaXMucmVhZHkoKQogICAgYXdhaXQgc2Vzc2lvbi5yZWFkeSgpCgogICAgcmV0dXJuIHRoaXMuc3RhdGUuY29tbWl0KHNlc3Npb24uc3RhdGUsIHsga2V5UGFpcjogdGhpcy5rZXlQYWlyLCAuLi5vcHRzIH0pCiAgfQoKICByZXBsaWNhdGUoaXNJbml0aWF0b3IsIG9wdHMgPSB7fSkgewogICAgLy8gT25seSBsaW1pdGF0aW9uIGhlcmUgaXMgdGhhdCBvbmRpc2NvdmVyeWtleSBkb2Vzbid0IHdvcmsgYXRtIHdoZW4gcGFzc2luZyBhIG11eGVyIGRpcmVjdGx5LAogICAgLy8gYmVjYXVzZSBpdCBkb2Vzbid0IHJlYWxseSBtYWtlIGEgbG90IG9mIHNlbnNlLgogICAgaWYgKFByb3RvbXV4LmlzUHJvdG9tdXgoaXNJbml0aWF0b3IpKSByZXR1cm4gdGhpcy5fYXR0YWNoVG9NdXhlcihpc0luaXRpYXRvcikKCiAgICAvLyBpZiBzYW1lIHN0cmVhbSBpcyBwYXNzZWQgdHdpY2UsIGlnbm9yZSB0aGUgMm5kIG9uZSBiZWZvcmUgd2UgbWFrZSBzZXNzaW9ucyBldGMKICAgIGlmIChpc1N0cmVhbShpc0luaXRpYXRvcikgJiYgdGhpcy5faXNBdHRhY2hlZChpc0luaXRpYXRvcikpIHJldHVybiBpc0luaXRpYXRvcgoKICAgIGNvbnN0IHByb3RvY29sU3RyZWFtID0gSHlwZXJjb3JlLmNyZWF0ZVByb3RvY29sU3RyZWFtKGlzSW5pdGlhdG9yLCBvcHRzKQogICAgY29uc3Qgbm9pc2VTdHJlYW0gPSBwcm90b2NvbFN0cmVhbS5ub2lzZVN0cmVhbQogICAgY29uc3QgcHJvdG9jb2wgPSBub2lzZVN0cmVhbS51c2VyRGF0YQoKICAgIHRoaXMuX2F0dGFjaFRvTXV4ZXIocHJvdG9jb2wpCgogICAgcmV0dXJuIHByb3RvY29sU3RyZWFtCiAgfQoKICBfaXNBdHRhY2hlZChzdHJlYW0pIHsKICAgIHJldHVybiAoCiAgICAgIHN0cmVhbS51c2VyRGF0YSAmJgogICAgICB0aGlzLmNvcmUgJiYKICAgICAgdGhpcy5jb3JlLnJlcGxpY2F0b3IgJiYKICAgICAgdGhpcy5jb3JlLnJlcGxpY2F0b3IuYXR0YWNoZWQoc3RyZWFtLnVzZXJEYXRhKQogICAgKQogIH0KCiAgX2F0dGFjaFRvTXV4ZXIobXV4KSB7CiAgICBpZiAodGhpcy5vcGVuZWQpIHsKICAgICAgdGhpcy5jb3JlLnJlcGxpY2F0b3IuYXR0YWNoVG8obXV4KQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5vcGVuaW5nLnRoZW4oKCkgPT4gdGhpcy5jb3JlLnJlcGxpY2F0b3IuYXR0YWNoVG8obXV4KSwgbXV4LmRlc3Ryb3kuYmluZChtdXgpKQogICAgfQoKICAgIHJldHVybiBtdXgKICB9CgogIGdldCBpZCgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUgPT09IG51bGwgPyBudWxsIDogdGhpcy5jb3JlLmlkCiAgfQoKICBnZXQga2V5KCkgewogICAgcmV0dXJuIHRoaXMuY29yZSA9PT0gbnVsbCA/IG51bGwgOiB0aGlzLmNvcmUua2V5CiAgfQoKICBnZXQgZGlzY292ZXJ5S2V5KCkgewogICAgcmV0dXJuIHRoaXMuY29yZSA9PT0gbnVsbCA/IG51bGwgOiB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5CiAgfQoKICBnZXQgbWFuaWZlc3QoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlID09PSBudWxsID8gbnVsbCA6IHRoaXMuY29yZS5tYW5pZmVzdAogIH0KCiAgZ2V0IGxlbmd0aCgpIHsKICAgIGlmICh0aGlzLl9zbmFwc2hvdCkgcmV0dXJuIHRoaXMuX3NuYXBzaG90Lmxlbmd0aAogICAgcmV0dXJuIHRoaXMub3BlbmVkID09PSBmYWxzZSA/IDAgOiB0aGlzLnN0YXRlLmxlbmd0aAogIH0KCiAgZ2V0IHNpZ25lZExlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLm9wZW5lZCA9PT0gZmFsc2UgPyAwIDogdGhpcy5zdGF0ZS5zaWduZWRMZW5ndGgoKQogIH0KCiAgLyoqCiAgICogRGVwcmVjYXRlZC4gVXNlIGBjb25zdCB7IGJ5dGVMZW5ndGggfSA9IGF3YWl0IGNvcmUuaW5mbygpYC4KICAgKi8KICBnZXQgYnl0ZUxlbmd0aCgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIHJldHVybiAwCiAgICBpZiAodGhpcy5fc25hcHNob3QpIHJldHVybiB0aGlzLl9zbmFwc2hvdC5ieXRlTGVuZ3RoCiAgICByZXR1cm4gdGhpcy5zdGF0ZS5ieXRlTGVuZ3RoIC0gdGhpcy5zdGF0ZS5sZW5ndGggKiB0aGlzLnBhZGRpbmcKICB9CgogIGdldCByZW1vdGVDb250aWd1b3VzTGVuZ3RoKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgcmV0dXJuIDAKICAgIHJldHVybiBNYXRoLm1pbih0aGlzLmNvcmUuc3RhdGUubGVuZ3RoLCB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpCiAgfQoKICBnZXQgY29udGlndW91c0xlbmd0aCgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIHJldHVybiAwCiAgICByZXR1cm4gTWF0aC5taW4odGhpcy5jb3JlLnN0YXRlLmxlbmd0aCwgdGhpcy5jb3JlLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoKQogIH0KCiAgZ2V0IGNvbnRpZ3VvdXNCeXRlTGVuZ3RoKCkgewogICAgcmV0dXJuIDAKICB9CgogIGdldCBmb3JrKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgcmV0dXJuIDAKICAgIHJldHVybiB0aGlzLnN0YXRlLmZvcmsKICB9CgogIGdldCBwYWRkaW5nKCkgewogICAgaWYgKHRoaXMuZW5jcnlwdGlvbiAmJiB0aGlzLmtleSAmJiB0aGlzLm1hbmlmZXN0KSB7CiAgICAgIHJldHVybiB0aGlzLmVuY3J5cHRpb24ucGFkZGluZyh0aGlzLmNvcmUsIHRoaXMubGVuZ3RoKQogICAgfQoKICAgIHJldHVybiAwCiAgfQoKICBnZXQgcGVlcnMoKSB7CiAgICByZXR1cm4gdGhpcy5vcGVuZWQgPT09IGZhbHNlID8gW10gOiB0aGlzLmNvcmUucmVwbGljYXRvci5wZWVycwogIH0KCiAgZ2V0IGdsb2JhbENhY2hlKCkgewogICAgcmV0dXJuIHRoaXMub3BlbmVkID09PSBmYWxzZSA/IG51bGwgOiB0aGlzLmNvcmUuZ2xvYmFsQ2FjaGUKICB9CgogIHJlYWR5KCkgewogICAgcmV0dXJuIHRoaXMub3BlbmluZwogIH0KCiAgYXN5bmMgc2V0VXNlckRhdGEoa2V5LCB2YWx1ZSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IHRoaXMuZ2V0VXNlckRhdGEoa2V5KQogICAgaWYgKGV4aXN0aW5nICYmIGI0YS5pc0J1ZmZlcih2YWx1ZSkgJiYgYjRhLmVxdWFscyhleGlzdGluZywgdmFsdWUpKSByZXR1cm4KICAgIGF3YWl0IHRoaXMuc3RhdGUuc2V0VXNlckRhdGEoa2V5LCB2YWx1ZSkKICB9CgogIGFzeW5jIGdldFVzZXJEYXRhKGtleSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBjb25zdCBiYXRjaCA9IHRoaXMuc3RhdGUuc3RvcmFnZS5yZWFkKCkKICAgIGNvbnN0IHAgPSBiYXRjaC5nZXRVc2VyRGF0YShrZXkpCiAgICBiYXRjaC50cnlGbHVzaCgpCiAgICByZXR1cm4gcAogIH0KCiAgdHJhbnNmZXJTZXNzaW9uKGNvcmUpIHsKICAgIC8vIHRvZG86IHZhbGlkYXRlIHdlIGNhbiBtb3ZlCgogICAgaWYgKHRoaXMud2VhayA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5jb3JlLmFjdGl2ZVNlc3Npb25zLS0KICAgICAgY29yZS5hY3RpdmVTZXNzaW9ucysrCiAgICB9CgogICAgaWYgKHRoaXMuX21vbml0b3JJbmRleCA+PSAwKSB7CiAgICAgIHRoaXMuY29yZS5yZW1vdmVNb25pdG9yKHRoaXMpCiAgICAgIGNvcmUuYWRkTW9uaXRvcih0aGlzKQogICAgfQoKICAgIGNvbnN0IG9sZCA9IHRoaXMuY29yZQoKICAgIHRoaXMuY29yZSA9IGNvcmUKCiAgICBvbGQucmVwbGljYXRvci5jbGVhclJlcXVlc3RzKHRoaXMuYWN0aXZlUmVxdWVzdHMsIFNFU1NJT05fTU9WRUQoKSkKCiAgICB0aGlzLmVtaXQoJ21pZ3JhdGUnLCB0aGlzLmtleSkKICB9CgogIGZpbmRpbmdQZWVycygpIHsKICAgIHRoaXMuX2ZpbmRpbmdQZWVycysrCiAgICBpZiAodGhpcy5jb3JlICE9PSBudWxsICYmICF0aGlzLmNsb3NpbmcpIHRoaXMuY29yZS5yZXBsaWNhdG9yLmZpbmRpbmdQZWVycysrCgogICAgbGV0IG9uY2UgPSB0cnVlCgogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKHRoaXMuY2xvc2luZyB8fCAhb25jZSkgcmV0dXJuCiAgICAgIG9uY2UgPSBmYWxzZQogICAgICB0aGlzLl9maW5kaW5nUGVlcnMtLQogICAgICBpZiAodGhpcy5jb3JlICE9PSBudWxsICYmIC0tdGhpcy5jb3JlLnJlcGxpY2F0b3IuZmluZGluZ1BlZXJzID09PSAwKSB7CiAgICAgICAgdGhpcy5jb3JlLnJlcGxpY2F0b3IudXBkYXRlQWxsKCkKICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgaW5mbyhvcHRzKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKCiAgICByZXR1cm4gSW5mby5mcm9tKHRoaXMsIG9wdHMpCiAgfQoKICBhc3luYyB1cGRhdGUob3B0cykgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBpZiAodGhpcy5jbG9zaW5nICE9PSBudWxsKSByZXR1cm4gZmFsc2UKICAgIGlmICh0aGlzLnNuYXBzaG90dGVkKSByZXR1cm4gZmFsc2UKCiAgICBpZiAodGhpcy53cml0YWJsZSAmJiAoIW9wdHMgfHwgb3B0cy5mb3JjZSAhPT0gdHJ1ZSkpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IHJlbW90ZVdhaXQgPSB0aGlzLl9zaG91bGRXYWl0KG9wdHMsIHRoaXMuY29yZS5yZXBsaWNhdG9yLmZpbmRpbmdQZWVycyA+IDApCgogICAgbGV0IHVwZ3JhZGVkID0gZmFsc2UKCiAgICBpZiAoYXdhaXQgdGhpcy5jb3JlLnJlcGxpY2F0b3IuYXBwbHlQZW5kaW5nUmVvcmcoKSkgewogICAgICB1cGdyYWRlZCA9IHRydWUKICAgIH0KCiAgICBpZiAoIXVwZ3JhZGVkICYmIHJlbW90ZVdhaXQpIHsKICAgICAgY29uc3QgYWN0aXZlUmVxdWVzdHMgPSAob3B0cyAmJiBvcHRzLmFjdGl2ZVJlcXVlc3RzKSB8fCB0aGlzLmFjdGl2ZVJlcXVlc3RzCiAgICAgIGNvbnN0IHJlcSA9IHRoaXMuY29yZS5yZXBsaWNhdG9yLmFkZFVwZ3JhZGUoYWN0aXZlUmVxdWVzdHMpCgogICAgICB0cnkgewogICAgICAgIHVwZ3JhZGVkID0gYXdhaXQgcmVxLnByb21pc2UKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKGlzU2Vzc2lvbk1vdmVkKGVycikpIHJldHVybiB0aGlzLnVwZGF0ZShvcHRzKQogICAgICAgIHRocm93IGVycgogICAgICB9CiAgICB9CgogICAgaWYgKCF1cGdyYWRlZCkgcmV0dXJuIGZhbHNlCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgc2VlayhieXRlcywgb3B0cykgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBpZiAoIWlzVmFsaWRJbmRleChieXRlcykpIHRocm93IEFTU0VSVElPTignc2VlayBpcyBpbnZhbGlkJywgdGhpcy5kaXNjb3ZlcnlLZXkpCgogICAgY29uc3QgYWN0aXZlUmVxdWVzdHMgPSAob3B0cyAmJiBvcHRzLmFjdGl2ZVJlcXVlc3RzKSB8fCB0aGlzLmFjdGl2ZVJlcXVlc3RzCgogICAgaWYgKHRoaXMuZW5jcnlwdGlvbiAmJiAhdGhpcy5jb3JlLm1hbmlmZXN0KSB7CiAgICAgIGNvbnN0IHJlcSA9IHRoaXMucmVwbGljYXRvci5hZGRVcGdyYWRlKGFjdGl2ZVJlcXVlc3RzKQogICAgICB0cnkgewogICAgICAgIGF3YWl0IHJlcS5wcm9taXNlCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmIChpc1Nlc3Npb25Nb3ZlZChlcnIpKSByZXR1cm4gdGhpcy5zZWVrKGJ5dGVzLCBvcHRzKQogICAgICAgIHRocm93IGVycgogICAgICB9CiAgICB9CgogICAgY29uc3QgcyA9IE1lcmtsZVRyZWUuc2Vlayh0aGlzLnN0YXRlLCBieXRlcywgdGhpcy5wYWRkaW5nKQoKICAgIGNvbnN0IG9mZnNldCA9IGF3YWl0IHMudXBkYXRlKCkKICAgIGlmIChvZmZzZXQpIHJldHVybiBvZmZzZXQKCiAgICBpZiAodGhpcy5jbG9zaW5nICE9PSBudWxsKSB7CiAgICAgIHRocm93IFNFU1NJT05fQ0xPU0VEKCdjYW5ub3Qgc2VlayBvbiBhIGNsb3NlZCBzZXNzaW9uJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgaWYgKCF0aGlzLl9zaG91bGRXYWl0KG9wdHMsIHRoaXMud2FpdCkpIHJldHVybiBudWxsCgogICAgY29uc3QgcmVxID0gdGhpcy5jb3JlLnJlcGxpY2F0b3IuYWRkU2VlayhhY3RpdmVSZXF1ZXN0cywgcykKCiAgICBjb25zdCB0aW1lb3V0ID0gb3B0cyAmJiBvcHRzLnRpbWVvdXQgIT09IHVuZGVmaW5lZCA/IG9wdHMudGltZW91dCA6IHRoaXMudGltZW91dAogICAgaWYgKHRpbWVvdXQpIHJlcS5jb250ZXh0LnNldFRpbWVvdXQocmVxLCB0aW1lb3V0KQoKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCByZXEucHJvbWlzZQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmIChpc1Nlc3Npb25Nb3ZlZChlcnIpKSByZXR1cm4gdGhpcy5zZWVrKGJ5dGVzLCBvcHRzKQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIGFzeW5jIGhhcyhzdGFydCwgZW5kID0gc3RhcnQgKyAxKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGlmICghaXNWYWxpZEluZGV4KHN0YXJ0KSB8fCAhaXNWYWxpZEluZGV4KGVuZCkpIHsKICAgICAgdGhyb3cgQVNTRVJUSU9OKCdoYXMgcmFuZ2UgaXMgaW52YWxpZCcsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIGlmICh0aGlzLnN0YXRlLmlzRGVmYXVsdCgpKSB7CiAgICAgIGlmIChlbmQgPT09IHN0YXJ0ICsgMSkgcmV0dXJuIHRoaXMuY29yZS5iaXRmaWVsZC5nZXQoc3RhcnQpCgogICAgICBjb25zdCBpID0gdGhpcy5jb3JlLmJpdGZpZWxkLmZpcnN0VW5zZXQoc3RhcnQpCiAgICAgIHJldHVybiBpID09PSAtMSB8fCBpID49IGVuZAogICAgfQoKICAgIGlmIChlbmQgPT09IHN0YXJ0ICsgMSkgewogICAgICBjb25zdCByeCA9IHRoaXMuc3RhdGUuc3RvcmFnZS5yZWFkKCkKICAgICAgY29uc3QgYmxvY2sgPSByeC5nZXRCbG9jayhzdGFydCkKICAgICAgcngudHJ5Rmx1c2goKQoKICAgICAgcmV0dXJuIChhd2FpdCBibG9jaykgIT09IG51bGwKICAgIH0KCiAgICBsZXQgY291bnQgPSAwCgogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdGF0ZS5zdG9yYWdlLmNyZWF0ZUJsb2NrU3RyZWFtKHsgZ3RlOiBzdGFydCwgbHQ6IGVuZCB9KQogICAgZm9yIGF3YWl0IChjb25zdCBibG9jayBvZiBzdHJlYW0pIHsKICAgICAgaWYgKGJsb2NrID09PSBudWxsKSByZXR1cm4gZmFsc2UKICAgICAgY291bnQrKwogICAgfQoKICAgIHJldHVybiBjb3VudCA9PT0gZW5kIC0gc3RhcnQKICB9CgogIGFzeW5jIGdldChpbmRleCwgb3B0cykgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBpZiAoIWlzVmFsaWRJbmRleChpbmRleCkpIHRocm93IEFTU0VSVElPTignYmxvY2sgaW5kZXggaXMgaW52YWxpZCcsIHRoaXMuZGlzY292ZXJ5S2V5KQoKICAgIGlmICh0aGlzLmNsb3NpbmcgIT09IG51bGwpIHsKICAgICAgdGhyb3cgU0VTU0lPTl9DTE9TRUQoJ2Nhbm5vdCBnZXQgb24gYSBjbG9zZWQgc2Vzc2lvbicsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIGNvbnN0IGVuY29kaW5nID0KICAgICAgKG9wdHMgJiYgb3B0cy52YWx1ZUVuY29kaW5nICYmIGMuZnJvbShvcHRzLnZhbHVlRW5jb2RpbmcpKSB8fCB0aGlzLnZhbHVlRW5jb2RpbmcKCiAgICBpZiAodGhpcy5vbnNlcSAhPT0gbnVsbCkgdGhpcy5vbnNlcShpbmRleCwgdGhpcykKCiAgICBjb25zdCByZXEgPSB0aGlzLl9nZXQoaW5kZXgsIG9wdHMpCgogICAgbGV0IGJsb2NrID0gYXdhaXQgcmVxCiAgICBpZiAoIWJsb2NrKSByZXR1cm4gbnVsbAoKICAgIGlmIChvcHRzICYmIG9wdHMucmF3KSByZXR1cm4gYmxvY2sKCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uICYmICghb3B0cyB8fCBvcHRzLmRlY3J5cHQgIT09IGZhbHNlKSkgewogICAgICAvLyBDb3B5IHRoZSBibG9jayBhcyBpdCBtaWdodCBiZSBzaGFyZWQgd2l0aCBvdGhlciBzZXNzaW9ucy4KICAgICAgYmxvY2sgPSBiNGEuZnJvbShibG9jaykKCiAgICAgIGF3YWl0IHRoaXMuZW5jcnlwdGlvbi5kZWNyeXB0KGluZGV4LCBibG9jaywgdGhpcy5jb3JlKQogICAgfQoKICAgIHJldHVybiB0aGlzLl9kZWNvZGUoZW5jb2RpbmcsIGJsb2NrLCBpbmRleCkKICB9CgogIGFzeW5jIGNsZWFyKHN0YXJ0LCBlbmQgPSBzdGFydCArIDEsIG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgaWYgKHRoaXMuY2xvc2luZyAhPT0gbnVsbCkgewogICAgICB0aHJvdyBTRVNTSU9OX0NMT1NFRCgnY2Fubm90IGNsZWFyIG9uIGEgY2xvc2VkIHNlc3Npb24nLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICBpZiAodHlwZW9mIGVuZCA9PT0gJ29iamVjdCcpIHsKICAgICAgb3B0cyA9IGVuZAogICAgICBlbmQgPSBzdGFydCArIDEKICAgIH0KCiAgICBpZiAoIWlzVmFsaWRJbmRleChzdGFydCkgfHwgIWlzVmFsaWRJbmRleChlbmQpKSB7CiAgICAgIHRocm93IEFTU0VSVElPTignY2xlYXIgcmFuZ2UgaXMgaW52YWxpZCcsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIGNvbnN0IGNsZWFyZWQgPSBvcHRzICYmIG9wdHMuZGlmZiA/IHsgYmxvY2tzOiAwIH0gOiBudWxsCgogICAgaWYgKHN0YXJ0ID49IGVuZCkgcmV0dXJuIGNsZWFyZWQKICAgIGlmIChzdGFydCA+PSB0aGlzLmxlbmd0aCkgcmV0dXJuIGNsZWFyZWQKCiAgICBhd2FpdCB0aGlzLnN0YXRlLmNsZWFyKHN0YXJ0LCBlbmQsIGNsZWFyZWQpCgogICAgcmV0dXJuIGNsZWFyZWQKICB9CgogIGFzeW5jIHB1cmdlKCkgewogICAgYXdhaXQgdGhpcy5fY2xvc2VBbGxTZXNzaW9ucyhudWxsKQogICAgYXdhaXQgdGhpcy5jb3JlLnB1cmdlKCkKICB9CgogIGFzeW5jIF9nZXQoaW5kZXgsIG9wdHMpIHsKICAgIGNvbnN0IGJsb2NrID0gYXdhaXQgcmVhZEJsb2NrKHRoaXMuc3RhdGUuc3RvcmFnZS5yZWFkKCksIGluZGV4KQoKICAgIGlmIChibG9jayAhPT0gbnVsbCkgcmV0dXJuIGJsb2NrCgogICAgaWYgKHRoaXMuY2xvc2luZyAhPT0gbnVsbCkgewogICAgICB0aHJvdyBTRVNTSU9OX0NMT1NFRCgnY2Fubm90IGdldCBvbiBhIGNsb3NlZCBzZXNzaW9uJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgLy8gc25hcHNob3Qgc2hvdWxkIGNoZWNrIGlmIGNvcmUgaGFzIGJsb2NrCiAgICBpZiAodGhpcy5fc25hcHNob3QgIT09IG51bGwpIHsKICAgICAgY2hlY2tTbmFwc2hvdCh0aGlzLCBpbmRleCkKICAgICAgY29uc3QgY29yZUJsb2NrID0gYXdhaXQgcmVhZEJsb2NrKHRoaXMuY29yZS5zdGF0ZS5zdG9yYWdlLnJlYWQoKSwgaW5kZXgpCgogICAgICBjaGVja1NuYXBzaG90KHRoaXMsIGluZGV4KQogICAgICBpZiAoY29yZUJsb2NrICE9PSBudWxsKSByZXR1cm4gY29yZUJsb2NrCiAgICB9CgogICAgLy8gbGV0cyBjaGVjayB0aGUgYml0ZmllbGQgdG8gc2VlIGlmIHdlIGdvdCBpdCBkdXJpbmcgdGhlIGFib3ZlIGFzeW5jIGNhbGxzCiAgICAvLyB0aGlzIGlzIHRoZSBsYXN0IHJlc29ydCBiZWZvcmUgcmVwbGljYXRpb24sIHNvIGFsd2F5cyBzYWZlLgogICAgaWYgKHRoaXMuY29yZS5iaXRmaWVsZC5nZXQoaW5kZXgpKSB7CiAgICAgIGNvbnN0IGNvcmVCbG9jayA9IGF3YWl0IHJlYWRCbG9jayh0aGlzLnN0YXRlLnN0b3JhZ2UucmVhZCgpLCBpbmRleCkKICAgICAgLy8gVE9ETzogdGhpcyBzaG91bGQgbm90IGJlIG5lZWRlZCwgb25seSBuZWVkZWQgYXRtIGluIGNhc2Ugd2UgYXJlIGRvaW5nIGEgbW92ZVRvIGR1cmluZyB0aGlzICh3ZSBzaG91bGQgZml4KQogICAgICBpZiAoY29yZUJsb2NrICE9PSBudWxsKSByZXR1cm4gY29yZUJsb2NrCiAgICB9CgogICAgaWYgKCF0aGlzLl9zaG91bGRXYWl0KG9wdHMsIHRoaXMud2FpdCkpIHJldHVybiBudWxsCgogICAgaWYgKG9wdHMgJiYgb3B0cy5vbndhaXQpIG9wdHMub253YWl0KGluZGV4LCB0aGlzKQogICAgaWYgKHRoaXMub253YWl0KSB0aGlzLm9ud2FpdChpbmRleCwgdGhpcykKCiAgICBjb25zdCBhY3RpdmVSZXF1ZXN0cyA9IChvcHRzICYmIG9wdHMuYWN0aXZlUmVxdWVzdHMpIHx8IHRoaXMuYWN0aXZlUmVxdWVzdHMKCiAgICBjb25zdCByZXEgPSB0aGlzLmNvcmUucmVwbGljYXRvci5hZGRCbG9jayhhY3RpdmVSZXF1ZXN0cywgaW5kZXgpCiAgICByZXEuc25hcHNob3QgPSBpbmRleCA8IHRoaXMubGVuZ3RoCgogICAgY29uc3QgdGltZW91dCA9IG9wdHMgJiYgb3B0cy50aW1lb3V0ICE9PSB1bmRlZmluZWQgPyBvcHRzLnRpbWVvdXQgOiB0aGlzLnRpbWVvdXQKICAgIGlmICh0aW1lb3V0KSByZXEuY29udGV4dC5zZXRUaW1lb3V0KHJlcSwgdGltZW91dCkKCiAgICBsZXQgcmVwbGljYXRlZEJsb2NrID0gbnVsbAoKICAgIHRyeSB7CiAgICAgIHJlcGxpY2F0ZWRCbG9jayA9IGF3YWl0IHJlcS5wcm9taXNlCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKGlzU2Vzc2lvbk1vdmVkKGVycikpIHJldHVybiB0aGlzLl9nZXQoaW5kZXgsIG9wdHMpCiAgICAgIHRocm93IGVycgogICAgfQoKICAgIGlmICh0aGlzLl9zbmFwc2hvdCAhPT0gbnVsbCkgY2hlY2tTbmFwc2hvdCh0aGlzLCBpbmRleCkKICAgIHJldHVybiBtYXliZVVuc2xhYihyZXBsaWNhdGVkQmxvY2spCiAgfQoKICBfc2hvdWxkV2FpdChvcHRzLCBkZWZhdWx0VmFsdWUpIHsKICAgIGlmIChvcHRzKSB7CiAgICAgIGlmIChvcHRzLndhaXQgPT09IGZhbHNlKSByZXR1cm4gZmFsc2UKICAgICAgaWYgKG9wdHMud2FpdCA9PT0gdHJ1ZSkgcmV0dXJuIHRydWUKICAgIH0KICAgIHJldHVybiBkZWZhdWx0VmFsdWUKICB9CgogIGNyZWF0ZVJlYWRTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIG5ldyBSZWFkU3RyZWFtKHRoaXMsIG9wdHMpCiAgfQoKICBjcmVhdGVXcml0ZVN0cmVhbSgpIHsKICAgIHJldHVybiBuZXcgV3JpdGVTdHJlYW0odGhpcykKICB9CgogIGNyZWF0ZUJ5dGVTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIG5ldyBCeXRlU3RyZWFtKHRoaXMsIG9wdHMpCiAgfQoKICBkb3dubG9hZChyYW5nZSkgewogICAgcmV0dXJuIG5ldyBEb3dubG9hZCh0aGlzLCByYW5nZSkKICB9CgogIC8vIFRPRE86IGdldCByaWQgb2YgdGhpcyAvIGRlcHJlY2F0ZSBpdD8KICB1bmRvd25sb2FkKHJhbmdlKSB7CiAgICByYW5nZS5kZXN0cm95KG51bGwpCiAgfQoKICAvLyBUT0RPOiBnZXQgcmlkIG9mIHRoaXMgLyBkZXByZWNhdGUgaXQ/CiAgY2FuY2VsKHJlcXVlc3QpIHsKICAgIC8vIERvIG5vdGhpbmcgZm9yIG5vdwogIH0KCiAgYXN5bmMgdHJ1bmNhdGUobmV3TGVuZ3RoID0gMCwgb3B0cyA9IHt9KSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKCiAgICBjb25zdCB7CiAgICAgIGZvcmsgPSB0aGlzLnN0YXRlLmZvcmsgKyAxLAogICAgICBrZXlQYWlyID0gdGhpcy5rZXlQYWlyLAogICAgICBzaWduYXR1cmUgPSBudWxsCiAgICB9ID0gdHlwZW9mIG9wdHMgPT09ICdudW1iZXInID8geyBmb3JrOiBvcHRzIH0gOiBvcHRzCgogICAgY29uc3QgaXNEZWZhdWx0ID0gdGhpcy5zdGF0ZSA9PT0gdGhpcy5jb3JlLnN0YXRlCiAgICBjb25zdCB3cml0YWJsZSA9ICF0aGlzLl9yZWFkb25seSAmJiAhIShzaWduYXR1cmUgfHwgKGtleVBhaXIgJiYga2V5UGFpci5zZWNyZXRLZXkpKQogICAgaWYgKGlzRGVmYXVsdCAmJiB3cml0YWJsZSA9PT0gZmFsc2UgJiYgKG5ld0xlbmd0aCA+IDAgfHwgZm9yayAhPT0gdGhpcy5zdGF0ZS5mb3JrKSkgewogICAgICB0aHJvdyBTRVNTSU9OX05PVF9XUklUQUJMRSgnY2Fubm90IGFwcGVuZCB0byBhIG5vbi13cml0YWJsZSBjb3JlJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgYXdhaXQgdGhpcy5zdGF0ZS50cnVuY2F0ZShuZXdMZW5ndGgsIGZvcmssIHsga2V5UGFpciwgc2lnbmF0dXJlIH0pCgogICAgLy8gVE9ETzogU2hvdWxkIHByb3BhZ2F0ZSBmcm9tIGFuIGV2ZW50IHRyaWdnZXJlZCBieSB0aGUgb3Bsb2cKICAgIGlmICh0aGlzLnN0YXRlID09PSB0aGlzLmNvcmUuc3RhdGUpIHRoaXMuY29yZS5yZXBsaWNhdG9yLnVwZGF0ZUFsbCgpCiAgfQoKICBhc3luYyBhcHBlbmQoYmxvY2tzLCBvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwoKICAgIGNvbnN0IGlzRGVmYXVsdCA9IHRoaXMuc3RhdGUgPT09IHRoaXMuY29yZS5zdGF0ZQogICAgY29uc3QgZGVmYXVsdEtleVBhaXIgPSB0aGlzLnN0YXRlLm5hbWUgPT09IG51bGwgPyB0aGlzLmtleVBhaXIgOiBudWxsCgogICAgY29uc3QgeyBrZXlQYWlyID0gZGVmYXVsdEtleVBhaXIsIHNpZ25hdHVyZSA9IG51bGwsIG1heExlbmd0aCwgcG9zdGFwcGVuZCA9IG51bGwgfSA9IG9wdHMKICAgIGNvbnN0IHdyaXRhYmxlID0KICAgICAgIWlzRGVmYXVsdCB8fCAhIXNpZ25hdHVyZSB8fCAhIShrZXlQYWlyICYmIGtleVBhaXIuc2VjcmV0S2V5KSB8fCBvcHRzLndyaXRhYmxlID09PSB0cnVlCgogICAgaWYgKHRoaXMuX3JlYWRvbmx5IHx8IHdyaXRhYmxlID09PSBmYWxzZSkgewogICAgICB0aHJvdyBTRVNTSU9OX05PVF9XUklUQUJMRSgnY2Fubm90IGFwcGVuZCB0byBhIHJlYWRvbmx5IGNvcmUnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICBibG9ja3MgPSBBcnJheS5pc0FycmF5KGJsb2NrcykgPyBibG9ja3MgOiBbYmxvY2tzXQoKICAgIGNvbnN0IHByZWFwcGVuZCA9IHRoaXMuZW5jcnlwdGlvbiAmJiB0aGlzLl9wcmVhcHBlbmQKCiAgICBjb25zdCBidWZmZXJzID0gdGhpcy5lbmNvZGVCYXRjaCAhPT0gbnVsbCA/IHRoaXMuZW5jb2RlQmF0Y2goYmxvY2tzKSA6IG5ldyBBcnJheShibG9ja3MubGVuZ3RoKQoKICAgIGlmICh0aGlzLmVuY29kZUJhdGNoID09PSBudWxsKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgYnVmZmVyc1tpXSA9IHRoaXMuX2VuY29kZSh0aGlzLnZhbHVlRW5jb2RpbmcsIGJsb2Nrc1tpXSkKICAgICAgfQogICAgfQogICAgZm9yIChjb25zdCBiIG9mIGJ1ZmZlcnMpIHsKICAgICAgaWYgKGIuYnl0ZUxlbmd0aCA+IE1BWF9TVUdHRVNURURfQkxPQ0tfU0laRSkgewogICAgICAgIHRocm93IEJBRF9BUkdVTUVOVCgKICAgICAgICAgICdBcHBlbmRlZCBibG9jayBleGNlZWRzIHRoZSBtYXhpbXVtIHN1Z2dlc3RlZCBibG9jayBzaXplJywKICAgICAgICAgIHRoaXMuZGlzY292ZXJ5S2V5CiAgICAgICAgKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXMuc3RhdGUuYXBwZW5kKGJ1ZmZlcnMsIHsga2V5UGFpciwgc2lnbmF0dXJlLCBwcmVhcHBlbmQsIHBvc3RhcHBlbmQsIG1heExlbmd0aCB9KQogIH0KCiAgYXN5bmMgc2lnbmFibGUobGVuZ3RoID0gLTEsIGZvcmsgPSAtMSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBpZiAobGVuZ3RoID09PSAtMSkgbGVuZ3RoID0gdGhpcy5sZW5ndGgKICAgIGlmIChmb3JrID09PSAtMSkgZm9yayA9IHRoaXMuZm9yawoKICAgIHJldHVybiBjYXBzLnRyZWVTaWduYWJsZSh0aGlzLmtleSwgYXdhaXQgdGhpcy50cmVlSGFzaChsZW5ndGgpLCBsZW5ndGgsIGZvcmspCiAgfQoKICBhc3luYyB0cmVlSGFzaChsZW5ndGggPSAtMSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBpZiAobGVuZ3RoID09PSAtMSkgbGVuZ3RoID0gdGhpcy5sZW5ndGgKCiAgICBjb25zdCByb290cyA9IGF3YWl0IE1lcmtsZVRyZWUuZ2V0Um9vdHModGhpcy5zdGF0ZSwgbGVuZ3RoKQogICAgcmV0dXJuIGNyeXB0by50cmVlKHJvb3RzKQogIH0KCiAgYXN5bmMgbWlzc2luZ05vZGVzKGluZGV4KSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIHJldHVybiBhd2FpdCBNZXJrbGVUcmVlLm1pc3NpbmdOb2Rlcyh0aGlzLmNvcmUuc3RhdGUsIDIgKiBpbmRleCwgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkKICB9CgogIGFzeW5jIHByb29mKG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgY29uc3QgcnggPSB0aGlzLnN0YXRlLnN0b3JhZ2UucmVhZCgpCiAgICBjb25zdCBwcm9vZlByb21pc2UgPSBNZXJrbGVUcmVlLnByb29mKHRoaXMuc3RhdGUsIHJ4LCBvcHRzKQogICAgY29uc3QgYmxvY2tQcm9taXNlID0gb3B0cyAmJiBvcHRzLmJsb2NrID8gcnguZ2V0QmxvY2sob3B0cy5ibG9jay5pbmRleCkgOiBudWxsCiAgICByeC50cnlGbHVzaCgpCiAgICBjb25zdCBbcHJvb2YsIGJsb2NrXSA9IGF3YWl0IFByb21pc2UuYWxsKFtwcm9vZlByb21pc2UsIGJsb2NrUHJvbWlzZV0pCiAgICBjb25zdCBzZXR0bGVkID0gYXdhaXQgcHJvb2Yuc2V0dGxlKCkKICAgIGlmIChibG9jaykgc2V0dGxlZC5ibG9jay52YWx1ZSA9IGJsb2NrCiAgICByZXR1cm4gc2V0dGxlZAogIH0KCiAgYXN5bmMgYXBwbHlQcm9vZihwcm9vZiwgZnJvbSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICByZXR1cm4gdGhpcy5jb3JlLnZlcmlmeShwcm9vZiwgZnJvbSkKICB9CgogIGFzeW5jIHZlcmlmeUZ1bGx5UmVtb3RlKHByb29mKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGNvbnN0IGJhdGNoID0gYXdhaXQgTWVya2xlVHJlZS52ZXJpZnlGdWxseVJlbW90ZSh0aGlzLnN0YXRlLCBwcm9vZikKICAgIGF3YWl0IHRoaXMuY29yZS5fdmVyaWZ5QmF0Y2hVcGdyYWRlKGJhdGNoLCBwcm9vZi5tYW5pZmVzdCkKICAgIHJldHVybiBiYXRjaAogIH0KCiAgcmVnaXN0ZXJFeHRlbnNpb24obmFtZSwgaGFuZGxlcnMgPSB7fSkgewogICAgaWYgKHRoaXMuZXh0ZW5zaW9ucy5oYXMobmFtZSkpIHsKICAgICAgY29uc3QgZXh0ID0gdGhpcy5leHRlbnNpb25zLmdldChuYW1lKQogICAgICBleHQuaGFuZGxlcnMgPSBoYW5kbGVycwogICAgICBleHQuZW5jb2RpbmcgPSBjLmZyb20oaGFuZGxlcnMuZW5jb2RpbmcgfHwgYy5idWZmZXIpCiAgICAgIGV4dC5zZXNzaW9uID0gdGhpcwogICAgICByZXR1cm4gZXh0CiAgICB9CgogICAgY29uc3QgZXh0ID0gewogICAgICBuYW1lLAogICAgICBoYW5kbGVycywKICAgICAgZW5jb2Rpbmc6IGMuZnJvbShoYW5kbGVycy5lbmNvZGluZyB8fCBjLmJ1ZmZlciksCiAgICAgIHNlc3Npb246IHRoaXMsCiAgICAgIHNlbmQobWVzc2FnZSwgcGVlcikgewogICAgICAgIGNvbnN0IGJ1ZmZlciA9IGMuZW5jb2RlKHRoaXMuZW5jb2RpbmcsIG1lc3NhZ2UpCiAgICAgICAgcGVlci5leHRlbnNpb24obmFtZSwgYnVmZmVyKQogICAgICB9LAogICAgICBicm9hZGNhc3QobWVzc2FnZSkgewogICAgICAgIGNvbnN0IGJ1ZmZlciA9IGMuZW5jb2RlKHRoaXMuZW5jb2RpbmcsIG1lc3NhZ2UpCiAgICAgICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMuc2Vzc2lvbi5wZWVycykgewogICAgICAgICAgcGVlci5leHRlbnNpb24obmFtZSwgYnVmZmVyKQogICAgICAgIH0KICAgICAgfSwKICAgICAgZGVzdHJveSgpIHsKICAgICAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5zZXNzaW9uLnBlZXJzKSB7CiAgICAgICAgICBpZiAocGVlci5leHRlbnNpb25zLmdldChuYW1lKSA9PT0gZXh0KSBwZWVyLmV4dGVuc2lvbnMuZGVsZXRlKG5hbWUpCiAgICAgICAgfQogICAgICAgIHRoaXMuc2Vzc2lvbi5leHRlbnNpb25zLmRlbGV0ZShuYW1lKQogICAgICB9LAogICAgICBfb25tZXNzYWdlKHN0YXRlLCBwZWVyKSB7CiAgICAgICAgY29uc3QgbSA9IHRoaXMuZW5jb2RpbmcuZGVjb2RlKHN0YXRlKQogICAgICAgIGlmICh0aGlzLmhhbmRsZXJzLm9ubWVzc2FnZSkgdGhpcy5oYW5kbGVycy5vbm1lc3NhZ2UobSwgcGVlcikKICAgICAgfQogICAgfQoKICAgIHRoaXMuZXh0ZW5zaW9ucy5zZXQobmFtZSwgZXh0KQoKICAgIGlmICh0aGlzLmNvcmUgPT09IG51bGwpIHRoaXMuX21vbml0b3JJbmRleCA9IC0yCiAgICBlbHNlIHRoaXMuY29yZS5hZGRNb25pdG9yKHRoaXMpCgogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHsKICAgICAgcGVlci5leHRlbnNpb25zLnNldChuYW1lLCBleHQpCiAgICB9CgogICAgcmV0dXJuIGV4dAogIH0KCiAgX2VuY29kZShlbmMsIHZhbCkgewogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiB0aGlzLnBhZGRpbmcsIGVuZDogdGhpcy5wYWRkaW5nLCBidWZmZXI6IG51bGwgfQoKICAgIGlmIChiNGEuaXNCdWZmZXIodmFsKSkgewogICAgICBpZiAoc3RhdGUuc3RhcnQgPT09IDApIHJldHVybiB2YWwKICAgICAgc3RhdGUuZW5kICs9IHZhbC5ieXRlTGVuZ3RoCiAgICB9IGVsc2UgaWYgKGVuYykgewogICAgICBlbmMucHJlZW5jb2RlKHN0YXRlLCB2YWwpCiAgICB9IGVsc2UgewogICAgICB2YWwgPSBiNGEuZnJvbSh2YWwpCiAgICAgIGlmIChzdGF0ZS5zdGFydCA9PT0gMCkgcmV0dXJuIHZhbAogICAgICBzdGF0ZS5lbmQgKz0gdmFsLmJ5dGVMZW5ndGgKICAgIH0KCiAgICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQoKICAgIGlmIChlbmMpIGVuYy5lbmNvZGUoc3RhdGUsIHZhbCkKICAgIGVsc2Ugc3RhdGUuYnVmZmVyLnNldCh2YWwsIHN0YXRlLnN0YXJ0KQoKICAgIHJldHVybiBzdGF0ZS5idWZmZXIKICB9CgogIF9kZWNvZGUoZW5jLCBibG9jaywgaW5kZXgpIHsKICAgIGlmICh0aGlzLmVuY3J5cHRpb24pIGJsb2NrID0gYmxvY2suc3ViYXJyYXkodGhpcy5lbmNyeXB0aW9uLnBhZGRpbmcodGhpcy5jb3JlLCBpbmRleCkpCiAgICB0cnkgewogICAgICBpZiAoZW5jKSByZXR1cm4gYy5kZWNvZGUoZW5jLCBibG9jaykKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aHJvdyBERUNPRElOR19FUlJPUihlcnIubWVzc2FnZSwgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CiAgICByZXR1cm4gYmxvY2sKICB9CgogIF9nZXRFbmNyeXB0aW9uUHJvdmlkZXIoZSkgewogICAgaWYgKGlzRW5jcnlwdGlvblByb3ZpZGVyKGUpKSByZXR1cm4gZQogICAgaWYgKCFlIHx8ICFlLmtleSkgcmV0dXJuIG51bGwKICAgIHJldHVybiBuZXcgRGVmYXVsdEVuY3J5cHRpb24oZS5rZXksIHRoaXMua2V5LCB7IGJsb2NrOiBlLmJsb2NrLCBjb21wYXQ6IHRoaXMuY29yZS5jb21wYXQgfSkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gSHlwZXJjb3JlCgpmdW5jdGlvbiBpc1N0cmVhbShzKSB7CiAgcmV0dXJuIHR5cGVvZiBzID09PSAnb2JqZWN0JyAmJiBzICYmIHR5cGVvZiBzLnBpcGUgPT09ICdmdW5jdGlvbicKfQoKYXN5bmMgZnVuY3Rpb24gcHJlYXBwZW5kKGJsb2NrcykgewogIGNvbnN0IG9mZnNldCA9IHRoaXMuc3RhdGUubGVuZ3RoCiAgY29uc3QgZm9yayA9IHRoaXMuc3RhdGUuZW5jcnlwdGlvbkZvcmsKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBibG9ja3MubGVuZ3RoOyBpKyspIHsKICAgIGF3YWl0IHRoaXMuZW5jcnlwdGlvbi5lbmNyeXB0KG9mZnNldCArIGksIGJsb2Nrc1tpXSwgZm9yaywgdGhpcy5jb3JlKQogIH0KfQoKZnVuY3Rpb24gaXNWYWxpZEluZGV4KGluZGV4KSB7CiAgcmV0dXJuIGluZGV4ID09PSAwIHx8IGluZGV4ID4gMAp9CgpmdW5jdGlvbiBtYXliZVVuc2xhYihibG9jaykgewogIC8vIFVuc2xhYiBvbmx5IHdoZW4gaXQgdGFrZXMgdXAgbGVzcyB0aGVuIGhhbGYgdGhlIHNsYWIKICByZXR1cm4gYmxvY2sgIT09IG51bGwgJiYgMiAqIGJsb2NrLmJ5dGVMZW5ndGggPCBibG9jay5idWZmZXIuYnl0ZUxlbmd0aCA/IHVuc2xhYihibG9jaykgOiBibG9jawp9CgpmdW5jdGlvbiBjaGVja1NuYXBzaG90KHNuYXBzaG90LCBpbmRleCkgewogIGlmIChpbmRleCA+PSBzbmFwc2hvdC5zdGF0ZS5zbmFwc2hvdENvbXBhdExlbmd0aCkgewogICAgdGhyb3cgU05BUFNIT1RfTk9UX0FWQUlMQUJMRSgKICAgICAgYHNuYXBzaG90IGF0IGluZGV4ICR7aW5kZXh9IG5vdCBhdmFpbGFibGUgKG1heCBjb21wYXQgbGVuZ3RoICR7c25hcHNob3Quc3RhdGUuc25hcHNob3RDb21wYXRMZW5ndGh9KWAsCiAgICAgIHNuYXBzaG90LmRpc2NvdmVyeUtleQogICAgKQogIH0KfQoKZnVuY3Rpb24gcmVhZEJsb2NrKHJ4LCBpbmRleCkgewogIGNvbnN0IHByb21pc2UgPSByeC5nZXRCbG9jayhpbmRleCkKICByeC50cnlGbHVzaCgpCiAgcmV0dXJuIHByb21pc2UKfQoKZnVuY3Rpb24gaW5pdE9uY2Uoc2Vzc2lvbiwgc3RvcmFnZSwga2V5LCBvcHRzKSB7CiAgaWYgKHN0b3JhZ2UgPT09IG51bGwpIHN0b3JhZ2UgPSBvcHRzLnN0b3JhZ2UgfHwgbnVsbAogIGlmIChrZXkgPT09IG51bGwpIGtleSA9IG9wdHMua2V5IHx8IG51bGwKCiAgc2Vzc2lvbi5jb3JlID0gbmV3IENvcmUoSHlwZXJjb3JlLmRlZmF1bHRTdG9yYWdlKHN0b3JhZ2UpLCB7CiAgICBwcmVvcGVuOiBvcHRzLnByZW9wZW4sCiAgICBlYWdlclVwZ3JhZGU6IG9wdHMuZWFnZXJVcGdyYWRlICE9PSBmYWxzZSwKICAgIG5vdERvd25sb2FkaW5nTGluZ2VyOiBvcHRzLm5vdERvd25sb2FkaW5nTGluZ2VyLAogICAgYWxsb3dGb3JrOiBvcHRzLmFsbG93Rm9yayAhPT0gZmFsc2UsCiAgICBhbGxvd1B1c2g6ICEhb3B0cy5hbGxvd1B1c2gsCiAgICBhbHdheXNMYXRlc3RCbG9jazogISFvcHRzLmFsbG93TGF0ZXN0QmxvY2ssCiAgICBpbmZsaWdodFJhbmdlOiBvcHRzLmluZmxpZ2h0UmFuZ2UsCiAgICBjb21wYXQ6IG9wdHMuY29tcGF0ID09PSB0cnVlLAogICAgZm9yY2U6IG9wdHMuZm9yY2UsCiAgICBjcmVhdGVJZk1pc3Npbmc6IG9wdHMuY3JlYXRlSWZNaXNzaW5nLAogICAgZGlzY292ZXJ5S2V5OiBvcHRzLmRpc2NvdmVyeUtleSwKICAgIG92ZXJ3cml0ZTogb3B0cy5vdmVyd3JpdGUsCiAgICBrZXksCiAgICBrZXlQYWlyOiBvcHRzLmtleVBhaXIsCiAgICBsZWdhY3k6IG9wdHMubGVnYWN5LAogICAgbWFuaWZlc3Q6IG9wdHMubWFuaWZlc3QsCiAgICBnbG9iYWxDYWNoZTogb3B0cy5nbG9iYWxDYWNoZSB8fCBudWxsIC8vIHNlc3Npb24gaXMgYSB0ZW1wIG9wdGlvbiwgbm90IHRvIGJlIHJlbGllZCBvbiB1bmxlc3MgeW91IGtub3cgd2hhdCB5b3UgYXJlIGRvaW5nIChubyBzZW12ZXIgZ3VhcmFudGVlcykKICB9KQp9CgpmdW5jdGlvbiBtYXliZUFkZE1vbml0b3IobmFtZSkgewogIGlmIChuYW1lID09PSAnYXBwZW5kJyB8fCBuYW1lID09PSAndHJ1bmNhdGUnKSByZXR1cm4KICBpZiAodGhpcy5fbW9uaXRvckluZGV4ID49IDAgfHwgdGhpcy5jbG9zaW5nKSByZXR1cm4KCiAgaWYgKHRoaXMuY29yZSA9PT0gbnVsbCkgewogICAgdGhpcy5fbW9uaXRvckluZGV4ID0gLTIKICB9IGVsc2UgewogICAgdGhpcy5jb3JlLmFkZE1vbml0b3IodGhpcykKICB9Cn0KCmZ1bmN0aW9uIGlzU2Vzc2lvbk1vdmVkKGVycikgewogIHJldHVybiBlcnIuY29kZSA9PT0gJ1NFU1NJT05fTU9WRUQnCn0KCmZ1bmN0aW9uIGdldEVuY3J5cHRpb25PcHRpb24ob3B0cykgewogIC8vIG9sZCBzdHlsZSwgc3VwcG9ydGVkIGZvciBub3cgYnV0IHdpbGwgZ28gYXdheQogIGlmIChvcHRzLmVuY3J5cHRpb25LZXkpIHJldHVybiB7IGtleTogb3B0cy5lbmNyeXB0aW9uS2V5LCBibG9jazogISFvcHRzLmlzQmxvY2tLZXkgfQogIGlmICghb3B0cy5lbmNyeXB0aW9uKSByZXR1cm4gbnVsbAogIHJldHVybiBiNGEuaXNCdWZmZXIob3B0cy5lbmNyeXB0aW9uKSA/IHsga2V5OiBvcHRzLmVuY3J5cHRpb24gfSA6IG9wdHMuZW5jcnlwdGlvbgp9CgpmdW5jdGlvbiBpc0VuY3J5cHRpb25Qcm92aWRlcihlKSB7CiAgcmV0dXJuIGUgJiYgaXNGdW5jdGlvbihlLnBhZGRpbmcpICYmIGlzRnVuY3Rpb24oZS5lbmNyeXB0KSAmJiBpc0Z1bmN0aW9uKGUuZGVjcnlwdCkKfQoKZnVuY3Rpb24gaXNGdW5jdGlvbihmbikgewogIHJldHVybiAhIWZuICYmIHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJwp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBmbGF0ID0gcmVxdWlyZSgnZmxhdC10cmVlJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgeyBNZXJrbGVUcmVlIH0gPSByZXF1aXJlKCcuL21lcmtsZS10cmVlJykKCm1vZHVsZS5leHBvcnRzID0gYXN5bmMgZnVuY3Rpb24gYXVkaXRDb3JlKAogIGNvcmUsCiAgeyB0cmVlID0gdHJ1ZSwgYmxvY2tzID0gdHJ1ZSwgYml0ZmllbGQgPSB0cnVlLCBkcnlSdW4gPSBmYWxzZSB9ID0ge30KKSB7CiAgY29uc3QgbGVuZ3RoID0gY29yZS5zdGF0ZS5sZW5ndGgKICBjb25zdCBzdGF0cyA9IHsKICAgIHRyZWVOb2RlczogMCwKICAgIGJsb2NrczogMCwKICAgIGJpdHM6IDAsCiAgICBkcm9wcGVkVHJlZU5vZGVzOiAwLAogICAgZHJvcHBlZEJsb2NrczogMCwKICAgIGRyb3BwZWRCaXRzOiAwLAogICAgY29ycnVwdDogZmFsc2UKICB9CgogIC8vIGF1ZGl0IHRoZSB0cmVlCiAgaWYgKHRyZWUpIHsKICAgIGxldCB0eCA9IG51bGwKCiAgICBjb25zdCByb290cyA9IGF3YWl0IE1lcmtsZVRyZWUuZ2V0Um9vdHNGcm9tU3RvcmFnZShjb3JlLnN0YXRlLnN0b3JhZ2UsIGxlbmd0aCkKICAgIGNvbnN0IHN0YWNrID0gW10KCiAgICBmb3IgKGNvbnN0IHIgb2Ygcm9vdHMpIHsKICAgICAgaWYgKHIgPT09IG51bGwpIHsKICAgICAgICBpZiAoIWRyeVJ1bikgewogICAgICAgICAgY29uc3Qgc3RvcmFnZSA9IGNvcmUuc3RhdGUuc3RvcmFnZQogICAgICAgICAgYXdhaXQgc3RvcmFnZS5zdG9yZS5kZWxldGVDb3JlKHN0b3JhZ2UuY29yZSkKICAgICAgICAgIHJldHVybiBudWxsCiAgICAgICAgfQoKICAgICAgICBzdGF0cy5jb3JydXB0ID0gdHJ1ZQogICAgICB9CgogICAgICBzdGFjay5wdXNoKHIpCiAgICB9CgogICAgc3RhdHMudHJlZU5vZGVzICs9IHJvb3RzLmxlbmd0aAoKICAgIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG5vZGUgPSBzdGFjay5wb3AoKQoKICAgICAgaWYgKChub2RlLmluZGV4ICYgMSkgPT09IDApIGNvbnRpbnVlCgogICAgICBjb25zdCBbbGVmdCwgcmlnaHRdID0gZmxhdC5jaGlsZHJlbihub2RlLmluZGV4KQoKICAgICAgY29uc3QgcnggPSBjb3JlLnN0YXRlLnN0b3JhZ2UucmVhZCgpCiAgICAgIGNvbnN0IGxlZnROb2RlUHJvbWlzZSA9IHJ4LmdldFRyZWVOb2RlKGxlZnQpCiAgICAgIGNvbnN0IHJpZ2h0Tm9kZVByb21pc2UgPSByeC5nZXRUcmVlTm9kZShyaWdodCkKCiAgICAgIHJ4LnRyeUZsdXNoKCkKCiAgICAgIGNvbnN0IFtsZWZ0Tm9kZSwgcmlnaHROb2RlXSA9IGF3YWl0IFByb21pc2UuYWxsKFtsZWZ0Tm9kZVByb21pc2UsIHJpZ2h0Tm9kZVByb21pc2VdKQoKICAgICAgaWYgKGlzQmFkVHJlZShub2RlLCBsZWZ0Tm9kZSwgcmlnaHROb2RlKSkgewogICAgICAgIGlmICghdHggJiYgIXN0YXRzLmNvcnJ1cHQpIHR4ID0gY29yZS5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKICAgICAgICBjb25zdCBbbCwgcl0gPSBmbGF0LnNwYW5zKG5vZGUuaW5kZXgpCiAgICAgICAgdHguZGVsZXRlVHJlZU5vZGVSYW5nZShsLCByICsgMSkKICAgICAgICBzdGF0cy5kcm9wcGVkVHJlZU5vZGVzKysKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBpZiAoIWxlZnROb2RlKSBjb250aW51ZQoKICAgICAgc3RhdHMudHJlZU5vZGVzICs9IDIKICAgICAgc3RhY2sucHVzaChsZWZ0Tm9kZSwgcmlnaHROb2RlKQogICAgfQoKICAgIGlmICh0eCAmJiAhZHJ5UnVuKSBhd2FpdCB0eC5mbHVzaCgpCiAgfQoKICAvLyBhdWRpdCB0aGUgYmxvY2tzCiAgaWYgKGJsb2NrcykgewogICAgbGV0IHR4ID0gbnVsbAoKICAgIGZvciBhd2FpdCAoY29uc3QgYmxvY2sgb2YgY29yZS5zdGF0ZS5zdG9yYWdlLmNyZWF0ZUJsb2NrU3RyZWFtKCkpIHsKICAgICAgaWYgKCFjb3JlLmJpdGZpZWxkLmdldChibG9jay5pbmRleCkpIHsKICAgICAgICBpZiAoIXR4ICYmICFzdGF0cy5jb3JydXB0KSB0eCA9IGNvcmUuc3RhdGUuc3RvcmFnZS53cml0ZSgpCiAgICAgICAgdHguZGVsZXRlQmxvY2soYmxvY2suaW5kZXgpCiAgICAgICAgc3RhdHMuZHJvcHBlZEJsb2NrcysrCiAgICAgIH0KCiAgICAgIGNvbnN0IHJ4ID0gY29yZS5zdGF0ZS5zdG9yYWdlLnJlYWQoKQogICAgICBjb25zdCB0cmVlTm9kZVByb21pc2UgPSByeC5nZXRUcmVlTm9kZSgyICogYmxvY2suaW5kZXgpCgogICAgICByeC50cnlGbHVzaCgpCgogICAgICBjb25zdCB0cmVlTm9kZSA9IGF3YWl0IHRyZWVOb2RlUHJvbWlzZQoKICAgICAgaWYgKGlzQmFkQmxvY2sodHJlZU5vZGUsIGJsb2NrLnZhbHVlKSkgewogICAgICAgIGlmICghdHggJiYgIXN0YXRzLmNvcnJ1cHQpIHR4ID0gY29yZS5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKICAgICAgICB0eC5kZWxldGVCbG9jayhibG9jay5pbmRleCkKICAgICAgICBzdGF0cy5kcm9wcGVkQmxvY2tzKysKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBzdGF0cy5ibG9ja3MrKwogICAgfQoKICAgIGlmICh0eCAmJiAhZHJ5UnVuKSBhd2FpdCB0eC5mbHVzaCgpCiAgfQoKICBpZiAoYml0ZmllbGQpIHsKICAgIGxldCB0eCA9IG51bGwKCiAgICBmb3IgKGNvbnN0IGluZGV4IG9mIGFsbEJpdHMoY29yZS5iaXRmaWVsZCkpIHsKICAgICAgY29uc3QgcnggPSBjb3JlLnN0YXRlLnN0b3JhZ2UucmVhZCgpCiAgICAgIGNvbnN0IGJsb2NrUHJvbWlzZSA9IHJ4LmdldEJsb2NrKGluZGV4KQoKICAgICAgcngudHJ5Rmx1c2goKQoKICAgICAgY29uc3QgYmxvY2sgPSBhd2FpdCBibG9ja1Byb21pc2UKICAgICAgaWYgKCFibG9jaykgewogICAgICAgIHN0YXRzLmRyb3BwZWRCaXRzKysKICAgICAgICBpZiAoZHJ5UnVuKSBjb250aW51ZQoKICAgICAgICBpZiAoIXR4ICYmICFzdGF0cy5jb3JydXB0KSB0eCA9IGNvcmUuc3RhdGUuc3RvcmFnZS53cml0ZSgpCgogICAgICAgIGNvcmUuYml0ZmllbGQuc2V0KGluZGV4LCBmYWxzZSkKCiAgICAgICAgY29uc3QgcGFnZSA9IGNvcmUuYml0ZmllbGQuZ2V0Qml0ZmllbGQoaW5kZXgpCiAgICAgICAgaWYgKHBhZ2UuYml0ZmllbGQpIHR4LnB1dEJpdGZpZWxkUGFnZShwYWdlLmluZGV4LCBwYWdlLmJpdGZpZWxkKQogICAgICAgIGVsc2UgdHguZGVsZXRlQml0ZmllbGRQYWdlKHBhZ2UuaW5kZXgpCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgc3RhdHMuYml0cysrCiAgICB9CgogICAgaWYgKHR4ICYmICFkcnlSdW4pIGF3YWl0IHR4LmZsdXNoKCkKICB9CgogIHJldHVybiBzdGF0cwp9CgpmdW5jdGlvbiBpc0JhZEJsb2NrKG5vZGUsIGJsb2NrKSB7CiAgaWYgKCFub2RlKSByZXR1cm4gdHJ1ZQogIGNvbnN0IGhhc2ggPSBjcnlwdG8uZGF0YShibG9jaykKICByZXR1cm4gIWI0YS5lcXVhbHMoaGFzaCwgbm9kZS5oYXNoKSB8fCBub2RlLnNpemUgIT09IGJsb2NrLmJ5dGVMZW5ndGgKfQoKZnVuY3Rpb24gaXNCYWRUcmVlKHBhcmVudCwgbGVmdCwgcmlnaHQpIHsKICBpZiAoIWxlZnQgJiYgIXJpZ2h0KSByZXR1cm4gZmFsc2UKICBpZiAoIWxlZnQgfHwgIXJpZ2h0KSByZXR1cm4gdHJ1ZQogIGNvbnN0IGhhc2ggPSBjcnlwdG8ucGFyZW50KGxlZnQsIHJpZ2h0KQogIHJldHVybiAhYjRhLmVxdWFscyhoYXNoLCBwYXJlbnQuaGFzaCkgfHwgcGFyZW50LnNpemUgIT09IGxlZnQuc2l6ZSArIHJpZ2h0LnNpemUKfQoKZnVuY3Rpb24qIGFsbEJpdHMoYml0ZmllbGQpIHsKICBsZXQgaSA9IDAKICBpZiAoYml0ZmllbGQuZ2V0KDApKSB5aWVsZCAwCiAgd2hpbGUgKHRydWUpIHsKICAgIGkgPSBiaXRmaWVsZC5maW5kRmlyc3QodHJ1ZSwgaSArIDEpCiAgICBpZiAoaSA9PT0gLTEpIGJyZWFrCiAgICB5aWVsZCBpCiAgfQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHF1aWNrYml0ID0gcmVxdWlyZSgnLi9jb21wYXQnKS5xdWlja2JpdAoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBCaXRJbnRlcmx1ZGUgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5yYW5nZXMgPSBbXQogIH0KCiAgY29udGlndW91c0xlbmd0aChmcm9tKSB7CiAgICBmb3IgKGNvbnN0IHIgb2YgdGhpcy5yYW5nZXMpIHsKICAgICAgaWYgKHIuc3RhcnQgPiBmcm9tKSBicmVhawogICAgICBpZiAoIXIudmFsdWUgJiYgci5zdGFydCA8PSBmcm9tKSByZXR1cm4gci5zdGFydAogICAgfQoKICAgIC8vIFRPRE86IGJlIHNtYXJ0ZXIKICAgIHdoaWxlICh0aGlzLmdldChmcm9tKSA9PT0gdHJ1ZSkgZnJvbSsrCiAgICByZXR1cm4gZnJvbQogIH0KCiAgZ2V0KGluZGV4KSB7CiAgICBsZXQgc3RhcnQgPSAwCiAgICBsZXQgZW5kID0gdGhpcy5yYW5nZXMubGVuZ3RoCgogICAgd2hpbGUgKHN0YXJ0IDwgZW5kKSB7CiAgICAgIGNvbnN0IG1pZCA9IChzdGFydCArIGVuZCkgPj4gMQogICAgICBjb25zdCByID0gdGhpcy5yYW5nZXNbbWlkXQoKICAgICAgaWYgKGluZGV4IDwgci5zdGFydCkgewogICAgICAgIGVuZCA9IG1pZAogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGlmIChpbmRleCA+PSByLmVuZCkgewogICAgICAgIGlmIChtaWQgPT09IHN0YXJ0KSBicmVhawogICAgICAgIHN0YXJ0ID0gbWlkCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgcmV0dXJuIHIudmFsdWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIHNldFJhbmdlKHN0YXJ0LCBlbmQsIHZhbHVlKSB7CiAgICBpZiAoc3RhcnQgPT09IGVuZCkgcmV0dXJuCgogICAgbGV0IHIgPSBudWxsCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnJhbmdlcy5sZW5ndGg7IGkrKykgewogICAgICByID0gdGhpcy5yYW5nZXNbaV0KCiAgICAgIC8vIGlmIGFscmVhZHkgaW5zaWRlLCBzdG9wCiAgICAgIGlmIChyLnN0YXJ0IDw9IHN0YXJ0ICYmIGVuZCA8PSByLmVuZCkgewogICAgICAgIGlmICh2YWx1ZSA9PT0gci52YWx1ZSkgcmV0dXJuCgogICAgICAgIGNvbnN0IHJhbmdlcyA9IG1lcmdlUmFuZ2VzKHIsIHsgc3RhcnQsIGVuZCwgdmFsdWUgfSkKICAgICAgICB0aGlzLnJhbmdlcy5zcGxpY2UoaSwgMSwgLi4ucmFuZ2VzKQoKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgLy8gd2Ugd2FubmEgb3ZlcnVuIHRoZSBpbnRlcnZhbAogICAgICBpZiAoc3RhcnQgPiByLmVuZCkgewogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIC8vIHdlIG92ZXJyYW4gYnV0IHRoaXMgaW50ZXJ2YWwgaXMgZW5kaW5nIGFmdGVyIHVzLCBtb3ZlIGl0IGJhY2sKICAgICAgaWYgKGVuZCA+PSByLnN0YXJ0ICYmIGVuZCA8PSByLmVuZCkgewogICAgICAgIHIuc3RhcnQgPSByLnZhbHVlID09PSB2YWx1ZSA/IHN0YXJ0IDogZW5kCiAgICAgICAgaWYgKHIudmFsdWUgIT09IHZhbHVlKSB0aGlzLnJhbmdlcy5zcGxpY2UoaSwgMCwgeyBzdGFydCwgZW5kLCB2YWx1ZSB9KQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICAvLyB3ZSBvdmVycmFuIGJ1dCBvdXIgc3RhcnQgaXMgY29udGFpbmVkIGluIHRoaXMgaW50ZXJ2YWwsIG1vdmUgc3RhcnQgYmFjawogICAgICBpZiAoc3RhcnQgPj0gci5zdGFydCAmJiBzdGFydCA8PSByLmVuZCkgewogICAgICAgIGlmIChyLnZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgci5lbmQgPSBzdGFydCAvLyBDcm9wIGN1cnJlbnQgY29tcGFyaXNvbgoKICAgICAgICAgIC8vIElmIHRoZXJlJ3MgYSBuZXh0IHJhbmdlCiAgICAgICAgICBpZiAodGhpcy5yYW5nZXMubGVuZ3RoIC0gMSA+IGkpIHsKICAgICAgICAgICAgY29uc3QgbmV4dCA9IHRoaXMucmFuZ2VzW2kgKyAxXQogICAgICAgICAgICAvLyBJZiB0aGUgc2FtZSwgZ28gbmV4dAogICAgICAgICAgICBpZiAobmV4dC52YWx1ZSA9PT0gdmFsdWUpIGNvbnRpbnVlCiAgICAgICAgICAgIC8vIEVsc2Ugd2Ugb3ZlcmxhcCBzbyB1cGRhdGUgbmV4dCByYW5nZQogICAgICAgICAgICBpZiAobmV4dC5zdGFydCA8IGVuZCkgbmV4dC5zdGFydCA9IGVuZAogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMucmFuZ2VzLnNwbGljZSgrK2ksIDAsIHsgc3RhcnQsIGVuZCwgdmFsdWUgfSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgc3RhcnQgPSByLnN0YXJ0CiAgICAgIH0KCiAgICAgIGxldCByZW1vdmUgPSAwCgogICAgICBmb3IgKGxldCBqID0gaTsgaiA8IHRoaXMucmFuZ2VzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgY29uc3QgbiA9IHRoaXMucmFuZ2VzW2pdCiAgICAgICAgaWYgKG4uc3RhcnQgPiBlbmQgfHwgbi52YWx1ZSAhPT0gdmFsdWUpIGJyZWFrCiAgICAgICAgaWYgKG4uc3RhcnQgPD0gZW5kICYmIG4uZW5kID4gZW5kKSBlbmQgPSBuLmVuZAogICAgICAgIHJlbW92ZSsrCiAgICAgIH0KCiAgICAgIHRoaXMucmFuZ2VzLnNwbGljZShpLCByZW1vdmUsIHsgc3RhcnQsIGVuZCwgdmFsdWUgfSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHIgIT09IG51bGwpIHsKICAgICAgaWYgKHN0YXJ0IDw9IHIuZW5kICYmIGVuZCA+IHIuZW5kKSB7CiAgICAgICAgci5lbmQgPSBlbmQKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgLy8gd2UgbmV2ZXIKICAgICAgaWYgKHIuZW5kID4gc3RhcnQpIHJldHVybgogICAgfQoKICAgIHRoaXMucmFuZ2VzLnB1c2goeyBzdGFydCwgZW5kLCB2YWx1ZSB9KQogIH0KCiAgZmx1c2godHgsIGJpdGZpZWxkKSB7CiAgICBpZiAoIXRoaXMucmFuZ2VzLmxlbmd0aCkgcmV0dXJuIFtdCgogICAgbGV0IGluZGV4ID0gdGhpcy5yYW5nZXNbMF0uc3RhcnQKICAgIGNvbnN0IGZpbmFsID0gdGhpcy5yYW5nZXNbdGhpcy5yYW5nZXMubGVuZ3RoIC0gMV0uZW5kCgogICAgbGV0IGkgPSAwCgogICAgd2hpbGUgKGluZGV4IDwgZmluYWwpIHsKICAgICAgY29uc3QgcGFnZSA9IGJpdGZpZWxkLmdldEJpdGZpZWxkKGluZGV4KSAvLyByZWFkIG9ubHkKICAgICAgY29uc3QgcGFnZUluZGV4ID0gcGFnZSA/IHBhZ2UuaW5kZXggOiBiaXRmaWVsZC5nZXRQYWdlSW5kZXgoaW5kZXgpCgogICAgICBjb25zdCBidWYgPSBiNGEuYWxsb2NVbnNhZmUoYml0ZmllbGQuZ2V0UGFnZUJ5dGVMZW5ndGgoKSkKCiAgICAgIGlmIChwYWdlKSB7CiAgICAgICAgY29uc3Qgc3JjID0gcGFnZS5iaXRmaWVsZCAvLyBVaW50MzJBcnJheQogICAgICAgIGJ1Zi5zZXQoYjRhLmZyb20oc3JjLmJ1ZmZlciwgc3JjLmJ5dGVPZmZzZXQsIHNyYy5ieXRlTGVuZ3RoKSwgMCkKICAgICAgfSBlbHNlIHsKICAgICAgICBiNGEuZmlsbChidWYsIDApCiAgICAgIH0KCiAgICAgIGNvbnN0IGxhc3QgPSAocGFnZUluZGV4ICsgMSkgKiAoYnVmLmJ5dGVMZW5ndGggPDwgMykKICAgICAgY29uc3Qgb2Zmc2V0ID0gcGFnZUluZGV4ICogKGJ1Zi5ieXRlTGVuZ3RoIDw8IDMpCgogICAgICBsZXQgaGFzVmFsdWUgPSBmYWxzZQoKICAgICAgd2hpbGUgKGkgPCB0aGlzLnJhbmdlcy5sZW5ndGgpIHsKICAgICAgICBjb25zdCB7IHN0YXJ0LCBlbmQsIHZhbHVlIH0gPSB0aGlzLnJhbmdlc1tpXQoKICAgICAgICBpZiAoIWhhc1ZhbHVlICYmIHZhbHVlKSBoYXNWYWx1ZSA9IHRydWUKCiAgICAgICAgY29uc3QgZnJvbSA9IHN0YXJ0IDwgaW5kZXggPyBpbmRleCA6IHN0YXJ0CiAgICAgICAgY29uc3QgdG8gPSBlbmQgPCBsYXN0ID8gZW5kIDogbGFzdAoKICAgICAgICBxdWlja2JpdC5maWxsKGJ1ZiwgdmFsdWUsIGZyb20gLSBvZmZzZXQsIHRvIC0gb2Zmc2V0KQoKICAgICAgICBpbmRleCA9IHRvCgogICAgICAgIGlmICh0byA9PT0gbGFzdCkgYnJlYWsKCiAgICAgICAgaSsrCiAgICAgIH0KCiAgICAgIGlmIChwYWdlIHx8IGhhc1ZhbHVlKSB0eC5wdXRCaXRmaWVsZFBhZ2UocGFnZUluZGV4LCBidWYpCiAgICB9CgogICAgcmV0dXJuIHRoaXMucmFuZ2VzCiAgfQp9CgpmdW5jdGlvbiBtZXJnZVJhbmdlcyhhLCBiKSB7CiAgY29uc3QgcmFuZ2VzID0gW10KICBpZiAoYS5zdGFydCA8IGIuc3RhcnQpIHJhbmdlcy5wdXNoKHsgc3RhcnQ6IGEuc3RhcnQsIGVuZDogYi5zdGFydCwgdmFsdWU6IGEudmFsdWUgfSkKICByYW5nZXMucHVzaCh7IHN0YXJ0OiBiLnN0YXJ0LCBlbmQ6IGIuZW5kLCB2YWx1ZTogYi52YWx1ZSB9KQogIGlmIChiLmVuZCA8IGEuZW5kKSByYW5nZXMucHVzaCh7IHN0YXJ0OiBiLmVuZCwgZW5kOiBhLmVuZCwgdmFsdWU6IGEudmFsdWUgfSkKCiAgcmV0dXJuIHJhbmdlcwp9CmNvbnN0IEJpZ1NwYXJzZUFycmF5ID0gcmVxdWlyZSgnYmlnLXNwYXJzZS1hcnJheScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHF1aWNrYml0ID0gcmVxdWlyZSgnLi9jb21wYXQnKS5xdWlja2JpdAoKY29uc3QgQklUU19QRVJfUEFHRSA9IDMyNzY4CmNvbnN0IEJZVEVTX1BFUl9QQUdFID0gQklUU19QRVJfUEFHRSAvIDgKY29uc3QgV09SRFNfUEVSX1BBR0UgPSBCWVRFU19QRVJfUEFHRSAvIDQKY29uc3QgQklUU19QRVJfU0VHTUVOVCA9IDIwOTcxNTIKY29uc3QgQllURVNfUEVSX1NFR01FTlQgPSBCSVRTX1BFUl9TRUdNRU5UIC8gOApjb25zdCBXT1JEU19QRVJfU0VHTUVOVCA9IEJZVEVTX1BFUl9TRUdNRU5UIC8gNApjb25zdCBJTklUSUFMX1dPUkRTX1BFUl9TRUdNRU5UID0gMTAyNApjb25zdCBQQUdFU19QRVJfU0VHTUVOVCA9IEJJVFNfUEVSX1NFR01FTlQgLyBCSVRTX1BFUl9QQUdFCmNvbnN0IFNFR01FTlRfR1JPV1RIX0ZBQ1RPUiA9IDQKCmNsYXNzIEJpdGZpZWxkUGFnZSB7CiAgY29uc3RydWN0b3IoaW5kZXgsIHNlZ21lbnQpIHsKICAgIHRoaXMuaW5kZXggPSBpbmRleAogICAgdGhpcy5vZmZzZXQgPSBpbmRleCAqIEJZVEVTX1BFUl9QQUdFIC0gc2VnbWVudC5vZmZzZXQKICAgIHRoaXMuYml0ZmllbGQgPSBudWxsCiAgICB0aGlzLnNlZ21lbnQgPSBzZWdtZW50CgogICAgc2VnbWVudC5hZGQodGhpcykKICB9CgogIGdldCB0cmVlKCkgewogICAgcmV0dXJuIHRoaXMuc2VnbWVudC50cmVlCiAgfQoKICBnZXQoaW5kZXgsIGRpcnR5KSB7CiAgICByZXR1cm4gcXVpY2tiaXQuZ2V0KHRoaXMuYml0ZmllbGQsIGluZGV4KQogIH0KCiAgc2V0KGluZGV4LCB2YWwpIHsKICAgIGlmIChxdWlja2JpdC5zZXQodGhpcy5iaXRmaWVsZCwgaW5kZXgsIHZhbCkpIHsKICAgICAgdGhpcy50cmVlLnVwZGF0ZSh0aGlzLm9mZnNldCAqIDggKyBpbmRleCkKICAgIH0KICB9CgogIHNldFJhbmdlKHN0YXJ0LCBlbmQsIHZhbCkgewogICAgcXVpY2tiaXQuZmlsbCh0aGlzLmJpdGZpZWxkLCB2YWwsIHN0YXJ0LCBlbmQpCgogICAgbGV0IGkgPSBNYXRoLmZsb29yKHN0YXJ0IC8gMTI4KQogICAgY29uc3QgbiA9IGkgKyBNYXRoLmNlaWwoKGVuZCAtIHN0YXJ0KSAvIDEyOCkKCiAgICB3aGlsZSAoaSA8PSBuKSB0aGlzLnRyZWUudXBkYXRlKHRoaXMub2Zmc2V0ICogOCArIGkrKyAqIDEyOCkKICB9CgogIGZpbmRGaXJzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICByZXR1cm4gcXVpY2tiaXQuZmluZEZpcnN0KHRoaXMuYml0ZmllbGQsIHZhbCwgcG9zaXRpb24pCiAgfQoKICBmaW5kTGFzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICByZXR1cm4gcXVpY2tiaXQuZmluZExhc3QodGhpcy5iaXRmaWVsZCwgdmFsLCBwb3NpdGlvbikKICB9CgogIGNvdW50KHN0YXJ0LCBsZW5ndGgsIHZhbCkgewogICAgY29uc3QgZW5kID0gc3RhcnQgKyBsZW5ndGgKCiAgICBsZXQgaSA9IHN0YXJ0CiAgICBsZXQgYyA9IDAKCiAgICB3aGlsZSAobGVuZ3RoID4gMCkgewogICAgICBjb25zdCBsID0gdGhpcy5maW5kRmlyc3QodmFsLCBpKQogICAgICBpZiAobCA9PT0gLTEgfHwgbCA+PSBlbmQpIHJldHVybiBjCgogICAgICBjb25zdCBoID0gdGhpcy5maW5kRmlyc3QoIXZhbCwgbCArIDEpCiAgICAgIGlmIChoID09PSAtMSB8fCBoID49IGVuZCkgcmV0dXJuIGMgKyBlbmQgLSBsCgogICAgICBjICs9IGggLSBsCiAgICAgIGxlbmd0aCAtPSBoIC0gaQogICAgICBpID0gaAogICAgfQoKICAgIHJldHVybiBjCiAgfQp9CgpjbGFzcyBCaXRmaWVsZFNlZ21lbnQgewogIGNvbnN0cnVjdG9yKGluZGV4LCBiaXRmaWVsZCkgewogICAgdGhpcy5pbmRleCA9IGluZGV4CiAgICB0aGlzLm9mZnNldCA9IGluZGV4ICogQllURVNfUEVSX1NFR01FTlQKICAgIHRoaXMudHJlZSA9IHF1aWNrYml0LkluZGV4LmZyb20oYml0ZmllbGQsIEJZVEVTX1BFUl9TRUdNRU5UKQogICAgdGhpcy5wYWdlcyA9IG5ldyBBcnJheShQQUdFU19QRVJfU0VHTUVOVCkKICB9CgogIGdldCBiaXRmaWVsZCgpIHsKICAgIHJldHVybiB0aGlzLnRyZWUuZmllbGQKICB9CgogIGFkZChwYWdlKSB7CiAgICBjb25zdCBpID0gcGFnZS5pbmRleCAtIHRoaXMuaW5kZXggKiBQQUdFU19QRVJfU0VHTUVOVAogICAgdGhpcy5wYWdlc1tpXSA9IHBhZ2UKCiAgICBjb25zdCBzdGFydCA9IGkgKiBXT1JEU19QRVJfUEFHRQogICAgY29uc3QgZW5kID0gc3RhcnQgKyBXT1JEU19QRVJfUEFHRQoKICAgIGlmIChlbmQgPj0gdGhpcy5iaXRmaWVsZC5sZW5ndGgpIHRoaXMucmVhbGxvY2F0ZShlbmQpCgogICAgcGFnZS5iaXRmaWVsZCA9IHRoaXMuYml0ZmllbGQuc3ViYXJyYXkoc3RhcnQsIGVuZCkKICB9CgogIHJlYWxsb2NhdGUobGVuZ3RoKSB7CiAgICBsZXQgdGFyZ2V0ID0gdGhpcy5iaXRmaWVsZC5sZW5ndGgKICAgIHdoaWxlICh0YXJnZXQgPCBsZW5ndGgpIHRhcmdldCAqPSBTRUdNRU5UX0dST1dUSF9GQUNUT1IKCiAgICBjb25zdCBiaXRmaWVsZCA9IG5ldyBVaW50MzJBcnJheSh0YXJnZXQpCiAgICBiaXRmaWVsZC5zZXQodGhpcy5iaXRmaWVsZCkKCiAgICB0aGlzLnRyZWUgPSBxdWlja2JpdC5JbmRleC5mcm9tKGJpdGZpZWxkLCBCWVRFU19QRVJfU0VHTUVOVCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGFnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcGFnZSA9IHRoaXMucGFnZXNbaV0KICAgICAgaWYgKCFwYWdlKSBjb250aW51ZQoKICAgICAgY29uc3Qgc3RhcnQgPSBpICogV09SRFNfUEVSX1BBR0UKICAgICAgY29uc3QgZW5kID0gc3RhcnQgKyBXT1JEU19QRVJfUEFHRQoKICAgICAgcGFnZS5iaXRmaWVsZCA9IGJpdGZpZWxkLnN1YmFycmF5KHN0YXJ0LCBlbmQpCiAgICB9CiAgfQoKICBmaW5kRmlyc3QodmFsLCBwb3NpdGlvbikgewogICAgcG9zaXRpb24gPSB0aGlzLnRyZWUuc2tpcEZpcnN0KCF2YWwsIHBvc2l0aW9uKQoKICAgIGxldCBqID0gcG9zaXRpb24gJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChwb3NpdGlvbiAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIGlmIChpID49IFBBR0VTX1BFUl9TRUdNRU5UKSByZXR1cm4gLTEKCiAgICB3aGlsZSAoaSA8IHRoaXMucGFnZXMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IHAgPSB0aGlzLnBhZ2VzW2ldCgogICAgICBsZXQgaW5kZXggPSAtMQoKICAgICAgaWYgKHApIGluZGV4ID0gcC5maW5kRmlyc3QodmFsLCBqKQogICAgICBlbHNlIGlmICghdmFsKSBpbmRleCA9IGoKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBpICogQklUU19QRVJfUEFHRSArIGluZGV4CgogICAgICBqID0gMAogICAgICBpKysKICAgIH0KCiAgICByZXR1cm4gLTEKICB9CgogIGZpbmRMYXN0KHZhbCwgcG9zaXRpb24pIHsKICAgIHBvc2l0aW9uID0gdGhpcy50cmVlLnNraXBMYXN0KCF2YWwsIHBvc2l0aW9uKQoKICAgIGxldCBqID0gcG9zaXRpb24gJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChwb3NpdGlvbiAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIGlmIChpID49IFBBR0VTX1BFUl9TRUdNRU5UKSByZXR1cm4gLTEKCiAgICB3aGlsZSAoaSA+PSAwKSB7CiAgICAgIGNvbnN0IHAgPSB0aGlzLnBhZ2VzW2ldCgogICAgICBsZXQgaW5kZXggPSAtMQoKICAgICAgaWYgKHApIGluZGV4ID0gcC5maW5kTGFzdCh2YWwsIGopCiAgICAgIGVsc2UgaWYgKCF2YWwpIGluZGV4ID0gagoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIGkgKiBCSVRTX1BFUl9QQUdFICsgaW5kZXgKCiAgICAgIGogPSBCSVRTX1BFUl9QQUdFIC0gMQogICAgICBpLS0KICAgIH0KCiAgICByZXR1cm4gLTEKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQml0ZmllbGQgewogIHN0YXRpYyBCSVRTX1BFUl9QQUdFID0gQklUU19QRVJfUEFHRQogIHN0YXRpYyBCWVRFU19QRVJfUEFHRSA9IEJZVEVTX1BFUl9QQUdFCgogIGNvbnN0cnVjdG9yKGJ1ZmZlcikgewogICAgdGhpcy5yZXN1bWVkID0gISEoYnVmZmVyICYmIGJ1ZmZlci5ieXRlTGVuZ3RoID49IDApCgogICAgdGhpcy5fcGFnZXMgPSBuZXcgQmlnU3BhcnNlQXJyYXkoKQogICAgdGhpcy5fc2VnbWVudHMgPSBuZXcgQmlnU3BhcnNlQXJyYXkoKQoKICAgIGNvbnN0IHZpZXcgPSB0aGlzLnJlc3VtZWQKICAgICAgPyBuZXcgVWludDMyQXJyYXkoYnVmZmVyLmJ1ZmZlciwgYnVmZmVyLmJ5dGVPZmZzZXQsIE1hdGguZmxvb3IoYnVmZmVyLmJ5dGVMZW5ndGggLyA0KSkKICAgICAgOiBuZXcgVWludDMyQXJyYXkoSU5JVElBTF9XT1JEU19QRVJfU0VHTUVOVCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZpZXcubGVuZ3RoOyBpICs9IFdPUkRTX1BFUl9TRUdNRU5UKSB7CiAgICAgIGxldCBiaXRmaWVsZCA9IHZpZXcuc3ViYXJyYXkoaSwgaSArIFdPUkRTX1BFUl9TRUdNRU5UKQogICAgICBsZXQgbGVuZ3RoID0gV09SRFNfUEVSX1NFR01FTlQKCiAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgbGVuZ3RoID0gSU5JVElBTF9XT1JEU19QRVJfU0VHTUVOVAogICAgICAgIHdoaWxlIChsZW5ndGggPCBiaXRmaWVsZC5sZW5ndGgpIGxlbmd0aCAqPSBTRUdNRU5UX0dST1dUSF9GQUNUT1IKICAgICAgfQoKICAgICAgaWYgKGJpdGZpZWxkLmxlbmd0aCAhPT0gbGVuZ3RoKSB7CiAgICAgICAgY29uc3QgY29weSA9IG5ldyBVaW50MzJBcnJheShsZW5ndGgpCiAgICAgICAgY29weS5zZXQoYml0ZmllbGQsIDApCiAgICAgICAgYml0ZmllbGQgPSBjb3B5CiAgICAgIH0KCiAgICAgIGNvbnN0IHNlZ21lbnQgPSBuZXcgQml0ZmllbGRTZWdtZW50KGkgLyBXT1JEU19QRVJfU0VHTUVOVCwgYml0ZmllbGQpCiAgICAgIHRoaXMuX3NlZ21lbnRzLnNldChzZWdtZW50LmluZGV4LCBzZWdtZW50KQoKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBiaXRmaWVsZC5sZW5ndGg7IGogKz0gV09SRFNfUEVSX1BBR0UpIHsKICAgICAgICBjb25zdCBwYWdlID0gbmV3IEJpdGZpZWxkUGFnZSgoaSArIGopIC8gV09SRFNfUEVSX1BBR0UsIHNlZ21lbnQpCiAgICAgICAgdGhpcy5fcGFnZXMuc2V0KHBhZ2UuaW5kZXgsIHBhZ2UpCiAgICAgIH0KICAgIH0KICB9CgogIHN0YXRpYyBmcm9tKGJpdGZpZWxkKSB7CiAgICByZXR1cm4gbmV3IEJpdGZpZWxkKGJpdGZpZWxkLnRvQnVmZmVyKGJpdGZpZWxkLl9wYWdlcy5tYXhMZW5ndGggKiBCSVRTX1BFUl9QQUdFKSkKICB9CgogIHRvQnVmZmVyKGxlbmd0aCkgewogICAgY29uc3QgcGFnZXMgPSBNYXRoLmNlaWwobGVuZ3RoIC8gQklUU19QRVJfUEFHRSkKICAgIGNvbnN0IGJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShwYWdlcyAqIEJZVEVTX1BFUl9QQUdFKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFnZXM7IGkrKykgewogICAgICBjb25zdCBwYWdlID0gdGhpcy5fcGFnZXMuZ2V0KGkpCiAgICAgIGNvbnN0IG9mZnNldCA9IGkgKiBCWVRFU19QRVJfUEFHRQoKICAgICAgaWYgKHBhZ2UpIHsKICAgICAgICBjb25zdCBidWYgPSBiNGEuZnJvbSgKICAgICAgICAgIHBhZ2UuYml0ZmllbGQuYnVmZmVyLAogICAgICAgICAgcGFnZS5iaXRmaWVsZC5ieXRlT2Zmc2V0LAogICAgICAgICAgcGFnZS5iaXRmaWVsZC5ieXRlTGVuZ3RoCiAgICAgICAgKQoKICAgICAgICBidWZmZXIuc2V0KGJ1Ziwgb2Zmc2V0KQogICAgICB9IGVsc2UgewogICAgICAgIGJ1ZmZlci5maWxsKDAsIG9mZnNldCwgb2Zmc2V0ICsgQllURVNfUEVSX1BBR0UpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYnVmZmVyCiAgfQoKICBnZXRCaXRmaWVsZChpbmRleCkgewogICAgY29uc3QgaSA9IHRoaXMuZ2V0UGFnZUluZGV4KGluZGV4KQoKICAgIGNvbnN0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKICAgIHJldHVybiBwIHx8IG51bGwKICB9CgogIG1lcmdlKGJpdGZpZWxkLCBsZW5ndGgpIHsKICAgIGxldCBpID0gMAoKICAgIHdoaWxlIChpIDwgbGVuZ3RoKSB7CiAgICAgIGNvbnN0IHN0YXJ0ID0gYml0ZmllbGQuZmlyc3RTZXQoaSkKICAgICAgaWYgKHN0YXJ0ID09PSAtMSkgYnJlYWsKCiAgICAgIGkgPSBiaXRmaWVsZC5maXJzdFVuc2V0KHN0YXJ0KQoKICAgICAgaWYgKGkgPT09IC0xIHx8IGkgPiBsZW5ndGgpIGkgPSBsZW5ndGgKCiAgICAgIHRoaXMuc2V0UmFuZ2Uoc3RhcnQsIGksIHRydWUpCgogICAgICBpZiAoaSA+PSBsZW5ndGgpIGJyZWFrCiAgICB9CiAgfQoKICBnZXQoaW5kZXgpIHsKICAgIGNvbnN0IGogPSBpbmRleCAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGNvbnN0IGkgPSAoaW5kZXggLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICBjb25zdCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCgogICAgcmV0dXJuIHAgPyBwLmdldChqKSA6IGZhbHNlCiAgfQoKICBnZXRQYWdlQnl0ZUxlbmd0aCgpIHsKICAgIHJldHVybiBCWVRFU19QRVJfUEFHRQogIH0KCiAgZ2V0UGFnZUluZGV4KGluZGV4KSB7CiAgICBjb25zdCBqID0gaW5kZXggJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICByZXR1cm4gKGluZGV4IC0gaikgLyBCSVRTX1BFUl9QQUdFCiAgfQoKICBnZXRQYWdlKGluZGV4LCBjcmVhdGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmdldFBhZ2VJbmRleChpbmRleCkKCiAgICBsZXQgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgIGlmIChwKSByZXR1cm4gcAoKICAgIGlmICghY3JlYXRlKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IGsgPSBNYXRoLmZsb29yKGkgLyBQQUdFU19QRVJfU0VHTUVOVCkKICAgIGNvbnN0IHMgPQogICAgICB0aGlzLl9zZWdtZW50cy5nZXQoaykgfHwKICAgICAgdGhpcy5fc2VnbWVudHMuc2V0KAogICAgICAgIGssCiAgICAgICAgbmV3IEJpdGZpZWxkU2VnbWVudCgKICAgICAgICAgIGssCiAgICAgICAgICBuZXcgVWludDMyQXJyYXkoayA9PT0gMCA/IElOSVRJQUxfV09SRFNfUEVSX1NFR01FTlQgOiBXT1JEU19QRVJfU0VHTUVOVCkKICAgICAgICApCiAgICAgICkKCiAgICBwID0gdGhpcy5fcGFnZXMuc2V0KGksIG5ldyBCaXRmaWVsZFBhZ2UoaSwgcykpCgogICAgcmV0dXJuIHAKICB9CgogIHNldChpbmRleCwgdmFsKSB7CiAgICBjb25zdCBqID0gaW5kZXggJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBjb25zdCBpID0gKGluZGV4IC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgbGV0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKCiAgICBpZiAoIXAgJiYgdmFsKSB7CiAgICAgIGNvbnN0IGsgPSBNYXRoLmZsb29yKGkgLyBQQUdFU19QRVJfU0VHTUVOVCkKICAgICAgY29uc3QgcyA9CiAgICAgICAgdGhpcy5fc2VnbWVudHMuZ2V0KGspIHx8CiAgICAgICAgdGhpcy5fc2VnbWVudHMuc2V0KAogICAgICAgICAgaywKICAgICAgICAgIG5ldyBCaXRmaWVsZFNlZ21lbnQoCiAgICAgICAgICAgIGssCiAgICAgICAgICAgIG5ldyBVaW50MzJBcnJheShrID09PSAwID8gSU5JVElBTF9XT1JEU19QRVJfU0VHTUVOVCA6IFdPUkRTX1BFUl9TRUdNRU5UKQogICAgICAgICAgKQogICAgICAgICkKCiAgICAgIHAgPSB0aGlzLl9wYWdlcy5zZXQoaSwgbmV3IEJpdGZpZWxkUGFnZShpLCBzKSkKICAgIH0KCiAgICBpZiAocCkgcC5zZXQoaiwgdmFsKQogIH0KCiAgc2V0UmFuZ2Uoc3RhcnQsIGVuZCwgdmFsKSB7CiAgICBsZXQgaiA9IHN0YXJ0ICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgbGV0IGkgPSAoc3RhcnQgLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICB3aGlsZSAoc3RhcnQgPCBlbmQpIHsKICAgICAgbGV0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKCiAgICAgIGlmICghcCAmJiB2YWwpIHsKICAgICAgICBjb25zdCBrID0gTWF0aC5mbG9vcihpIC8gUEFHRVNfUEVSX1NFR01FTlQpCiAgICAgICAgY29uc3QgcyA9CiAgICAgICAgICB0aGlzLl9zZWdtZW50cy5nZXQoaykgfHwKICAgICAgICAgIHRoaXMuX3NlZ21lbnRzLnNldCgKICAgICAgICAgICAgaywKICAgICAgICAgICAgbmV3IEJpdGZpZWxkU2VnbWVudCgKICAgICAgICAgICAgICBrLAogICAgICAgICAgICAgIG5ldyBVaW50MzJBcnJheShrID09PSAwID8gSU5JVElBTF9XT1JEU19QRVJfU0VHTUVOVCA6IFdPUkRTX1BFUl9TRUdNRU5UKQogICAgICAgICAgICApCiAgICAgICAgICApCgogICAgICAgIHAgPSB0aGlzLl9wYWdlcy5zZXQoaSwgbmV3IEJpdGZpZWxkUGFnZShpLCBzKSkKICAgICAgfQoKICAgICAgY29uc3Qgb2Zmc2V0ID0gaSAqIEJJVFNfUEVSX1BBR0UKICAgICAgY29uc3QgbGFzdCA9IE1hdGgubWluKGVuZCAtIG9mZnNldCwgQklUU19QRVJfUEFHRSkKICAgICAgY29uc3QgcmFuZ2UgPSBsYXN0IC0gagoKICAgICAgaWYgKHApIHAuc2V0UmFuZ2UoaiwgbGFzdCwgdmFsKQoKICAgICAgaiA9IDAKICAgICAgaSsrCiAgICAgIHN0YXJ0ICs9IHJhbmdlCiAgICB9CiAgfQoKICBmaW5kRmlyc3QodmFsLCBwb3NpdGlvbikgewogICAgbGV0IGogPSBwb3NpdGlvbiAmIChCSVRTX1BFUl9TRUdNRU5UIC0gMSkKICAgIGxldCBpID0gKHBvc2l0aW9uIC0gaikgLyBCSVRTX1BFUl9TRUdNRU5UCgogICAgd2hpbGUgKGkgPCB0aGlzLl9zZWdtZW50cy5tYXhMZW5ndGgpIHsKICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZ21lbnRzLmdldChpKQoKICAgICAgbGV0IGluZGV4ID0gLTEKCiAgICAgIGlmIChzKSBpbmRleCA9IHMuZmluZEZpcnN0KHZhbCwgaikKICAgICAgZWxzZSBpZiAoIXZhbCkgaW5kZXggPSBqCgogICAgICBpZiAoaW5kZXggIT09IC0xKSByZXR1cm4gaSAqIEJJVFNfUEVSX1NFR01FTlQgKyBpbmRleAoKICAgICAgaiA9IDAKICAgICAgaSsrCiAgICB9CgogICAgcmV0dXJuIHZhbCA/IC0xIDogdGhpcy5fc2VnbWVudHMubWF4TGVuZ3RoICogQklUU19QRVJfU0VHTUVOVAogIH0KCiAgZmlyc3RTZXQocG9zaXRpb24pIHsKICAgIHJldHVybiB0aGlzLmZpbmRGaXJzdCh0cnVlLCBwb3NpdGlvbikKICB9CgogIGZpcnN0VW5zZXQocG9zaXRpb24pIHsKICAgIHJldHVybiB0aGlzLmZpbmRGaXJzdChmYWxzZSwgcG9zaXRpb24pCiAgfQoKICBmaW5kTGFzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICBsZXQgaiA9IHBvc2l0aW9uICYgKEJJVFNfUEVSX1NFR01FTlQgLSAxKQogICAgbGV0IGkgPSAocG9zaXRpb24gLSBqKSAvIEJJVFNfUEVSX1NFR01FTlQKCiAgICB3aGlsZSAoaSA+PSAwKSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLl9zZWdtZW50cy5nZXQoaSkKCiAgICAgIGxldCBpbmRleCA9IC0xCgogICAgICBpZiAocykgaW5kZXggPSBzLmZpbmRMYXN0KHZhbCwgaikKICAgICAgZWxzZSBpZiAoIXZhbCkgaW5kZXggPSBqCgogICAgICBpZiAoaW5kZXggIT09IC0xKSByZXR1cm4gaSAqIEJJVFNfUEVSX1NFR01FTlQgKyBpbmRleAoKICAgICAgaiA9IEJJVFNfUEVSX1NFR01FTlQgLSAxCiAgICAgIGktLQogICAgfQoKICAgIHJldHVybiAtMQogIH0KCiAgbGFzdFNldChwb3NpdGlvbikgewogICAgcmV0dXJuIHRoaXMuZmluZExhc3QodHJ1ZSwgcG9zaXRpb24pCiAgfQoKICBsYXN0VW5zZXQocG9zaXRpb24pIHsKICAgIHJldHVybiB0aGlzLmZpbmRMYXN0KGZhbHNlLCBwb3NpdGlvbikKICB9CgogIGhhc1NldChzdGFydCwgbGVuZ3RoKSB7CiAgICBjb25zdCBlbmQgPSBzdGFydCArIGxlbmd0aAoKICAgIGxldCBqID0gc3RhcnQgJiAoQklUU19QRVJfU0VHTUVOVCAtIDEpCiAgICBsZXQgaSA9IChzdGFydCAtIGopIC8gQklUU19QRVJfU0VHTUVOVAoKICAgIHdoaWxlIChpIDwgdGhpcy5fc2VnbWVudHMubWF4TGVuZ3RoKSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLl9zZWdtZW50cy5nZXQoaSkKCiAgICAgIGxldCBpbmRleCA9IC0xCgogICAgICBpZiAocykgaW5kZXggPSBzLmZpbmRGaXJzdCh0cnVlLCBqKQoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIGkgKiBCSVRTX1BFUl9TRUdNRU5UICsgaW5kZXggPCBlbmQKCiAgICAgIGogPSAwCiAgICAgIGkrKwoKICAgICAgaWYgKGkgKiBCSVRTX1BFUl9TRUdNRU5UID49IGVuZCkgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBjb3VudChzdGFydCwgbGVuZ3RoLCB2YWwpIHsKICAgIGxldCBqID0gc3RhcnQgJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChzdGFydCAtIGopIC8gQklUU19QRVJfUEFHRQogICAgbGV0IGMgPSAwCgogICAgd2hpbGUgKGxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgICAgY29uc3QgZW5kID0gTWF0aC5taW4oaiArIGxlbmd0aCwgQklUU19QRVJfUEFHRSkKICAgICAgY29uc3QgcmFuZ2UgPSBlbmQgLSBqCgogICAgICBpZiAocCkgYyArPSBwLmNvdW50KGosIHJhbmdlLCB2YWwpCiAgICAgIGVsc2UgaWYgKCF2YWwpIGMgKz0gcmFuZ2UKCiAgICAgIGogPSAwCiAgICAgIGkrKwogICAgICBsZW5ndGggLT0gcmFuZ2UKICAgIH0KCiAgICByZXR1cm4gYwogIH0KCiAgY291bnRTZXQoc3RhcnQsIGxlbmd0aCkgewogICAgcmV0dXJuIHRoaXMuY291bnQoc3RhcnQsIGxlbmd0aCwgdHJ1ZSkKICB9CgogIGNvdW50VW5zZXQoc3RhcnQsIGxlbmd0aCkgewogICAgcmV0dXJuIHRoaXMuY291bnQoc3RhcnQsIGxlbmd0aCwgZmFsc2UpCiAgfQoKICAqd2FudChzdGFydCwgbGVuZ3RoKSB7CiAgICBjb25zdCBqID0gc3RhcnQgJiAoQklUU19QRVJfU0VHTUVOVCAtIDEpCiAgICBsZXQgaSA9IChzdGFydCAtIGopIC8gQklUU19QRVJfU0VHTUVOVAoKICAgIHdoaWxlIChsZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLl9zZWdtZW50cy5nZXQoaSkKCiAgICAgIGlmIChzKSB7CiAgICAgICAgLy8gV2UgYWx3YXlzIHNlbmQgYXQgbGVhc3QgNCBLaUIgd29ydGggb2YgYml0ZmllbGQgaW4gYSB3YW50LCByb3VuZGluZwogICAgICAgIC8vIHRvIHRoZSBuZWFyZXN0IDQgS2lCLgogICAgICAgIGNvbnN0IGVuZCA9IGNlaWxUbyhjbGFtcChsZW5ndGggLyA4LCA0MDk2LCBCWVRFU19QRVJfU0VHTUVOVCksIDQwOTYpCgogICAgICAgIHlpZWxkIHsKICAgICAgICAgIHN0YXJ0OiBpICogQklUU19QRVJfU0VHTUVOVCwKICAgICAgICAgIGJpdGZpZWxkOiBzLmJpdGZpZWxkLnN1YmFycmF5KDAsIGVuZCAvIDQpCiAgICAgICAgfQogICAgICB9CgogICAgICBpKysKICAgICAgbGVuZ3RoIC09IEJJVFNfUEVSX1NFR01FTlQKICAgIH0KICB9CgogIGNsZWFyKHR4KSB7CiAgICByZXR1cm4gdHguZGVsZXRlQml0ZmllbGRQYWdlUmFuZ2UoMCwgLTEpCiAgfQoKICBvbnVwZGF0ZShyYW5nZXMpIHsKICAgIGZvciAoY29uc3QgeyBzdGFydCwgZW5kLCB2YWx1ZSB9IG9mIHJhbmdlcykgewogICAgICB0aGlzLnNldFJhbmdlKHN0YXJ0LCBlbmQsIHZhbHVlKQogICAgfQogIH0KCiAgc3RhdGljIGFzeW5jIG9wZW4oc3RvcmFnZSwgbGVuZ3RoKSB7CiAgICBpZiAobGVuZ3RoID09PSAwKSByZXR1cm4gbmV3IEJpdGZpZWxkKHN0b3JhZ2UsIG51bGwpCgogICAgY29uc3QgcGFnZXMgPSBNYXRoLmNlaWwobGVuZ3RoIC8gQklUU19QRVJfUEFHRSkKICAgIGNvbnN0IGJ1ZmZlciA9IGI0YS5hbGxvYyhwYWdlcyAqIEJZVEVTX1BFUl9QQUdFKQogICAgY29uc3Qgc3RyZWFtID0gc3RvcmFnZS5jcmVhdGVCaXRmaWVsZFN0cmVhbSh7IGx0OiBwYWdlcyB9KQoKICAgIGZvciBhd2FpdCAoY29uc3QgeyBpbmRleCwgcGFnZSB9IG9mIHN0cmVhbSkgewogICAgICBidWZmZXIuc2V0KHBhZ2UsIGluZGV4ICogQllURVNfUEVSX1BBR0UpCiAgICB9CgogICAgcmV0dXJuIG5ldyBCaXRmaWVsZChidWZmZXIpCiAgfQp9CgpmdW5jdGlvbiBjbGFtcChuLCBtaW4sIG1heCkgewogIHJldHVybiBNYXRoLm1pbihNYXRoLm1heChuLCBtaW4pLCBtYXgpCn0KCmZ1bmN0aW9uIGNlaWxUbyhuLCBtdWx0aXBsZSA9IDEpIHsKICBjb25zdCByZW1haW5kZXIgPSBuICUgbXVsdGlwbGUKICBpZiAocmVtYWluZGVyID09PSAwKSByZXR1cm4gbgogIHJldHVybiBuICsgbXVsdGlwbGUgLSByZW1haW5kZXIKfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKCi8vIFRPRE86IHJlbmFtZSB0aGlzIHRvICJjcnlwdG8iIGFuZCBtb3ZlIGV2ZXJ5dGhpbmcgaGFzaGluZyByZWxhdGVkIGV0YyBpbiBoZXJlCi8vIEFsc28gbGV0cyBtb3ZlIHRoZSB0cmVlIHN0dWZmIGZyb20gaHlwZXJjb3JlLWNyeXB0byBoZXJlCgpjb25zdCBbCiAgVFJFRSwKICBSRVBMSUNBVEVfSU5JVElBVE9SLAogIFJFUExJQ0FURV9SRVNQT05ERVIsCiAgTUFOSUZFU1QsCiAgREVGQVVMVF9OQU1FU1BBQ0UsCiAgREVGQVVMVF9FTkNSWVBUSU9OCl0gPSBjcnlwdG8ubmFtZXNwYWNlKCdoeXBlcmNvcmUnLCA2KQoKZXhwb3J0cy5NQU5JRkVTVCA9IE1BTklGRVNUCmV4cG9ydHMuREVGQVVMVF9OQU1FU1BBQ0UgPSBERUZBVUxUX05BTUVTUEFDRQpleHBvcnRzLkRFRkFVTFRfRU5DUllQVElPTiA9IERFRkFVTFRfRU5DUllQVElPTgoKZXhwb3J0cy5yZXBsaWNhdGUgPSBmdW5jdGlvbiAoaXNJbml0aWF0b3IsIGtleSwgaGFuZHNoYWtlSGFzaCkgewogIGNvbnN0IG91dCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKAogICAgb3V0LAogICAgW2lzSW5pdGlhdG9yID8gUkVQTElDQVRFX0lOSVRJQVRPUiA6IFJFUExJQ0FURV9SRVNQT05ERVIsIGtleV0sCiAgICBoYW5kc2hha2VIYXNoCiAgKQogIHJldHVybiBvdXQKfQoKZXhwb3J0cy50cmVlU2lnbmFibGUgPSBmdW5jdGlvbiAobWFuaWZlc3RIYXNoLCB0cmVlSGFzaCwgbGVuZ3RoLCBmb3JrKSB7CiAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDExMiwgYnVmZmVyOiBiNGEuYWxsb2NVbnNhZmUoMTEyKSB9CiAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgVFJFRSkKICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtYW5pZmVzdEhhc2gpCiAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgdHJlZUhhc2gpCiAgYy51aW50NjQuZW5jb2RlKHN0YXRlLCBsZW5ndGgpCiAgYy51aW50NjQuZW5jb2RlKHN0YXRlLCBmb3JrKQogIHJldHVybiBzdGF0ZS5idWZmZXIKfQoKZXhwb3J0cy50cmVlU2lnbmFibGVDb21wYXQgPSBmdW5jdGlvbiAoaGFzaCwgbGVuZ3RoLCBmb3JrLCBub0hlYWRlcikgewogIGNvbnN0IGVuZCA9IG5vSGVhZGVyID8gNDggOiA4MAogIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kLCBidWZmZXI6IGI0YS5hbGxvY1Vuc2FmZShlbmQpIH0KICBpZiAoIW5vSGVhZGVyKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBUUkVFKSAvLyB1bHRyYSBsZWdhY3kgbW9kZSwga2lsbCBpbiBmdXR1cmUgbWFqb3IKICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBoYXNoKQogIGMudWludDY0LmVuY29kZShzdGF0ZSwgbGVuZ3RoKQogIGMudWludDY0LmVuY29kZShzdGF0ZSwgZm9yaykKICByZXR1cm4gc3RhdGUuYnVmZmVyCn0KLy8gRXhwb3J0IHRoZSBhcHByb3ByaWF0ZSB2ZXJzaW9uIG9mIGBxdWlja2JpdC11bml2ZXJzYWxgIGFzIHRoZSBwbGFpbiBpbXBvcnQKLy8gbWF5IHJlc29sdmUgdG8gYW4gb2xkZXIgdmVyc2lvbiBpbiBzb21lIGVudmlyb25tZW50cwpsZXQgcXVpY2tiaXQgPSByZXF1aXJlKCdxdWlja2JpdC11bml2ZXJzYWwnKQppZiAoCiAgdHlwZW9mIHF1aWNrYml0LmZpbmRGaXJzdCAhPT0gJ2Z1bmN0aW9uJyB8fAogIHR5cGVvZiBxdWlja2JpdC5maW5kTGFzdCAhPT0gJ2Z1bmN0aW9uJyB8fAogIHR5cGVvZiBxdWlja2JpdC5jbGVhciAhPT0gJ2Z1bmN0aW9uJwopIHsKICAvLyBUaGlzIHNob3VsZCBhbHdheXMgbG9hZCB0aGUgZmFsbGJhY2sgZnJvbSB0aGUgbG9jYWxseSBpbnN0YWxsZWQgdmVyc2lvbgogIHF1aWNrYml0ID0gcmVxdWlyZSgncXVpY2tiaXQtdW5pdmVyc2FsL2ZhbGxiYWNrJykKfQpleHBvcnRzLnF1aWNrYml0ID0gcXVpY2tiaXQKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IGZsYXQgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBxdWlja2JpdCA9IHJlcXVpcmUoJ3F1aWNrYml0LXVuaXZlcnNhbCcpCmNvbnN0IEJpdGZpZWxkID0gcmVxdWlyZSgnLi9iaXRmaWVsZCcpCgpjb25zdCBNQVhfQkFUQ0hfVVNFRCA9IDQgKiAxMDI0ICogMTAyNApjb25zdCBNSU5fQkFUQ0hfVVNFRCA9IDUxMiAqIDEwMjQKCi8vIGp1c3QgaW4gaXRzIG93biBmaWxlIGFzIGl0cyBhIGJpdCBpbnZvbHZlZAoKbW9kdWxlLmV4cG9ydHMgPSBjb3B5UHJvbG9ndWUKCmFzeW5jIGZ1bmN0aW9uIGNvcHlQcm9sb2d1ZShzcmMsIGRzdCkgewogIGNvbnN0IHByb2xvZ3VlID0gZHN0LmhlYWRlci5tYW5pZmVzdC5wcm9sb2d1ZQoKICBpZiAoc3JjLmxlbmd0aCA8IHByb2xvZ3VlLmxlbmd0aCB8fCBwcm9sb2d1ZS5sZW5ndGggPT09IDApIHJldHVybgoKICBjb25zdCBzdGFjayA9IFtdCiAgY29uc3Qgcm9vdHMgPSBmbGF0LmZ1bGxSb290cyhwcm9sb2d1ZS5sZW5ndGggKiAyKQogIGNvbnN0IGJhdGNoID0geyByb290cywgZmlyc3Q6IHRydWUsIGxhc3Q6IGZhbHNlLCBjb250aWc6IDAsIHVzZWQ6IDAsIHRyZWU6IFtdLCBibG9ja3M6IFtdIH0KCiAgZm9yIChsZXQgaSA9IDA7IGkgPCByb290cy5sZW5ndGg7IGkrKykgewogICAgY29uc3Qgbm9kZSA9IHJvb3RzW2ldCiAgICBiYXRjaC50cmVlLnB1c2gobm9kZSkKICAgIHN0YWNrLnB1c2gobm9kZSkKICB9CgogIGxldCBsYXN0UGFnZSA9IC0xCiAgbGV0IGxhc3RCbG9jayA9IC0xCgogIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiBzcmMuc3RvcmFnZS5jcmVhdGVCbG9ja1N0cmVhbSh7CiAgICBndGU6IDAsCiAgICBsdDogcHJvbG9ndWUubGVuZ3RoLAogICAgcmV2ZXJzZTogdHJ1ZQogIH0pKSB7CiAgICBpZiAod2Fsa1RyZWUoc3RhY2ssIGRhdGEuaW5kZXggKiAyLCBiYXRjaCkgPT09IGZhbHNlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBibG9jayBvciB0cmVlIG5vZGUgZm9yICcgKyBkYXRhLmluZGV4KQogICAgfQoKICAgIGJhdGNoLmNvbnRpZyA9IGRhdGEuaW5kZXggKyAxID09PSBsYXN0QmxvY2sgPyBiYXRjaC5jb250aWcgKyAxIDogMQogICAgbGFzdEJsb2NrID0gZGF0YS5pbmRleAoKICAgIGNvbnN0IHBhZ2UgPSBnZXRCaXRmaWVsZFBhZ2UoZGF0YS5pbmRleCkKICAgIGJhdGNoLmJsb2Nrcy5wdXNoKGRhdGEpCgogICAgaWYgKGxhc3RQYWdlICE9PSBwYWdlKSBiYXRjaC51c2VkICs9IDQwOTYKICAgIGJhdGNoLnVzZWQgKz0gTWF0aC5tYXgoZGF0YS52YWx1ZS5ieXRlTGVuZ3RoLCAxMjgpIC8vIDEyOCBpcyBqdXN0IGEgc2FuaXR5IG51bWJlciB0byBhdm9pZCBtZWdhIGJhdGNoZXMKCiAgICAvLyBhbHdheXMgc2FmZSB0byBwYXJ0aWFsbHkgZmx1c2ggc28gd2UgZG8gdGhhdCBvbmRlbWFuZCB0byByZWR1Y2UgbWVtb3J5IHVzYWdlLi4uCiAgICBpZiAoKGJhdGNoLnVzZWQgPj0gTUlOX0JBVENIX1VTRUQgJiYgcGFnZSAhPT0gbGFzdFBhZ2UpIHx8IGJhdGNoLnVzZWQgPj0gTUFYX0JBVENIX1VTRUQpIHsKICAgICAgYXdhaXQgZmx1c2hCYXRjaChwcm9sb2d1ZSwgc3JjLCBkc3QsIGJhdGNoKQogICAgfQoKICAgIGxhc3RQYWdlID0gcGFnZQogIH0KCiAgaWYgKGxhc3RCbG9jayAhPT0gMCkgYmF0Y2guY29udGlnID0gMAoKICBiYXRjaC5sYXN0ID0gdHJ1ZQogIGF3YWl0IGZsdXNoQmF0Y2gocHJvbG9ndWUsIHNyYywgZHN0LCBiYXRjaCkKfQoKYXN5bmMgZnVuY3Rpb24gZmx1c2hCYXRjaChwcm9sb2d1ZSwgc3JjLCBkc3QsIGJhdGNoKSB7CiAgY29uc3Qgbm9kZVByb21pc2VzID0gW10KCiAgY29uc3Qgc3JjUmVhZGVyID0gc3JjLnN0b3JhZ2UucmVhZCgpCiAgZm9yIChjb25zdCBpbmRleCBvZiBiYXRjaC50cmVlKSB7CiAgICBub2RlUHJvbWlzZXMucHVzaChzcmNSZWFkZXIuZ2V0VHJlZU5vZGUoaW5kZXgpKQogIH0KICBzcmNSZWFkZXIudHJ5Rmx1c2goKQoKICBjb25zdCBub2RlcyA9IGF3YWl0IFByb21pc2UuYWxsKG5vZGVQcm9taXNlcykKCiAgY29uc3QgcGFnZVByb21pc2VzID0gW10KICBjb25zdCBkc3RSZWFkZXIgPSBkc3Quc3RvcmFnZS5yZWFkKCkKCiAgY29uc3QgaGVhZFByb21pc2UgPSBiYXRjaC5maXJzdCA/IGRzdFJlYWRlci5nZXRIZWFkKCkgOiBudWxsCiAgaWYgKGhlYWRQcm9taXNlKSBoZWFkUHJvbWlzZS5jYXRjaChub29wKQoKICBsZXQgbGFzdFBhZ2UgPSAtMQogIGZvciAoY29uc3QgeyBpbmRleCB9IG9mIGJhdGNoLmJsb2NrcykgewogICAgY29uc3QgcGFnZSA9IGdldEJpdGZpZWxkUGFnZShpbmRleCkKICAgIGlmIChwYWdlID09PSBsYXN0UGFnZSkgY29udGludWUKICAgIGxhc3RQYWdlID0gcGFnZQogICAgcGFnZVByb21pc2VzLnB1c2goZHN0UmVhZGVyLmdldEJpdGZpZWxkUGFnZShwYWdlKSkKICB9CgogIGRzdFJlYWRlci50cnlGbHVzaCgpCgogIGNvbnN0IHBhZ2VzID0gYXdhaXQgUHJvbWlzZS5hbGwocGFnZVByb21pc2VzKQogIGNvbnN0IGhlYWQgPSBoZWFkUHJvbWlzZSA9PT0gbnVsbCA/IG51bGwgOiBhd2FpdCBoZWFkUHJvbWlzZQogIGNvbnN0IHVzZXJEYXRhID0gW10KCiAgLy8gcmVhZHMgZG9uZSEKCiAgaWYgKGJhdGNoLmZpcnN0KSB7CiAgICBjb25zdCByb290cyA9IG5vZGVzLnNsaWNlKDAsIGJhdGNoLnJvb3RzLmxlbmd0aCkKCiAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygcm9vdHMpIHsKICAgICAgaWYgKCFub2RlKSB0aHJvdyBuZXcgRXJyb3IoJ01pc3Npbmcgbm9kZXMgZm9yIHByb2xvZ3VlIGhhc2gnKQogICAgfQoKICAgIGNvbnN0IHRyZWVIYXNoID0gY3J5cHRvLnRyZWUocm9vdHMpCiAgICBpZiAoIWI0YS5lcXVhbHModHJlZUhhc2gsIHByb2xvZ3VlLmhhc2gpKSB0aHJvdyBuZXcgRXJyb3IoJ1Byb2xvZ3VlIGRvZXMgbm90IG1hdGNoIHNvdXJjZScpCiAgfQoKICBpZiAoYmF0Y2guZmlyc3QpIHsKICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiBzcmMuc3RvcmFnZS5jcmVhdGVVc2VyRGF0YVN0cmVhbSgpKSB1c2VyRGF0YS5wdXNoKGRhdGEpCiAgfQoKICBmb3IgKGxldCBpID0gMDsgaSA8IHBhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoIXBhZ2VzW2ldKSBwYWdlc1tpXSA9IGI0YS5hbGxvYyg0MDk2KQogIH0KCiAgY29uc3QgdHggPSBkc3Quc3RvcmFnZS53cml0ZSgpCgogIGZvciAoY29uc3Qgbm9kZSBvZiBub2RlcykgdHgucHV0VHJlZU5vZGUobm9kZSkKCiAgbGFzdFBhZ2UgPSAtMQogIGxldCBwYWdlSW5kZXggPSAtMQoKICBmb3IgKGNvbnN0IHsgaW5kZXgsIHZhbHVlIH0gb2YgYmF0Y2guYmxvY2tzKSB7CiAgICBjb25zdCBwYWdlID0gZ2V0Qml0ZmllbGRQYWdlKGluZGV4KQoKICAgIGlmIChwYWdlICE9PSBsYXN0UGFnZSkgewogICAgICBsYXN0UGFnZSA9IHBhZ2UKICAgICAgcGFnZUluZGV4KysKICAgICAgLy8gcXVldWUgdGhlIHBhZ2Ugbm93LCB3ZSBtdXRhdGUgaXQgYmVsb3cgYnV0IGl0cyB0aGUgc2FtZSByZWYKICAgICAgdHgucHV0Qml0ZmllbGRQYWdlKHBhZ2VJbmRleCwgcGFnZXNbcGFnZUluZGV4XSkKICAgIH0KCiAgICBjb25zdCBwYWdlQnVmZmVyID0gcGFnZXNbcGFnZUluZGV4XQogICAgcXVpY2tiaXQuc2V0KHBhZ2VCdWZmZXIsIGdldEJpdGZpZWxkT2Zmc2V0KGluZGV4KSwgdHJ1ZSkKICAgIHR4LnB1dEJsb2NrKGluZGV4LCB2YWx1ZSkKICB9CgogIGZvciAoY29uc3QgeyBrZXksIHZhbHVlIH0gb2YgdXNlckRhdGEpIHsKICAgIHR4LnB1dFVzZXJEYXRhKGtleSwgdmFsdWUpCiAgfQoKICBsZXQgdXBncmFkZWQgPSBiYXRjaC5maXJzdCAmJiAhaGVhZAogIGlmICh1cGdyYWRlZCkgewogICAgdHguc2V0SGVhZChwcm9sb2d1ZVRvVHJlZShwcm9sb2d1ZSkpCiAgfQoKICBhd2FpdCB0eC5mbHVzaCgpCgogIGlmICh1cGdyYWRlZCkgewogICAgY29uc3Qgcm9vdHMgPSBub2Rlcy5zbGljZSgwLCBiYXRjaC5yb290cy5sZW5ndGgpCiAgICBkc3Quc3RhdGUuc2V0Um9vdHMocm9vdHMpCiAgICBkc3QuaGVhZGVyLnRyZWUgPSBwcm9sb2d1ZVRvVHJlZShwcm9sb2d1ZSkKICB9CgogIGlmICh1c2VyRGF0YS5sZW5ndGggPiAwKSB7CiAgICBkc3QuaGVhZGVyLnVzZXJEYXRhID0gdXNlckRhdGEuY29uY2F0KGRzdC5oZWFkZXIudXNlckRhdGEpCiAgfQoKICBpZiAoYmF0Y2guY29udGlnKSB7CiAgICAvLyBUT0RPOiB3ZSBuZWVkIHRvIHBlcnNpc3QgdGhpcyBzb21laG93CiAgICBkc3QuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGggPSBiYXRjaC5jb250aWcKICB9CgogIGxldCBzdGFydCA9IDAKICBsZXQgbGVuZ3RoID0gMAoKICAvLyB1cGRhdGUgaW4gbWVtb3J5IGJpdGZpZWxkCiAgZm9yIChjb25zdCB7IGluZGV4IH0gb2YgYmF0Y2guYmxvY2tzKSB7CiAgICBpZiAoc3RhcnQgPT09IDAgfHwgc3RhcnQgLSAxID09PSBpbmRleCkgewogICAgICBsZW5ndGgrKwogICAgfSBlbHNlIHsKICAgICAgaWYgKGxlbmd0aCA+IDApIHNpZ25hbFJlcGxpY2F0b3IoZHN0LCB1cGdyYWRlZCwgc3RhcnQsIGxlbmd0aCkKICAgICAgdXBncmFkZWQgPSBmYWxzZQogICAgICBsZW5ndGggPSAxCiAgICB9CgogICAgc3RhcnQgPSBpbmRleAogICAgZHN0LmJpdGZpZWxkLnNldChpbmRleCwgdHJ1ZSkKICB9CgogIGlmIChsZW5ndGggPiAwKSBzaWduYWxSZXBsaWNhdG9yKGRzdCwgdXBncmFkZWQsIHN0YXJ0LCBsZW5ndGgpCgogIC8vIHVubGluawogIGJhdGNoLnRyZWUgPSBbXQogIGJhdGNoLmJsb2NrcyA9IFtdCiAgYmF0Y2guZmlyc3QgPSBmYWxzZQogIGJhdGNoLnVzZWQgPSAwCn0KCmZ1bmN0aW9uIHNpZ25hbFJlcGxpY2F0b3IoY29yZSwgdXBncmFkZWQsIHN0YXJ0LCBsZW5ndGgpIHsKICBpZiAodXBncmFkZWQpIHsKICAgIGNvcmUucmVwbGljYXRvci5jb3JrKCkKICAgIGNvcmUucmVwbGljYXRvci5vbmhhdmUoc3RhcnQsIGxlbmd0aCwgZmFsc2UpCiAgICBjb3JlLnJlcGxpY2F0b3Iub251cGdyYWRlKCkKICAgIGNvcmUucmVwbGljYXRvci51bmNvcmsoKQogIH0gZWxzZSB7CiAgICBjb3JlLnJlcGxpY2F0b3Iub25oYXZlKHN0YXJ0LCBsZW5ndGgsIGZhbHNlKQogIH0KfQoKZnVuY3Rpb24gcHJvbG9ndWVUb1RyZWUocHJvbG9ndWUpIHsKICByZXR1cm4gewogICAgZm9yazogMCwKICAgIGxlbmd0aDogcHJvbG9ndWUubGVuZ3RoLAogICAgcm9vdEhhc2g6IHByb2xvZ3VlLmhhc2gsCiAgICBzaWduYXR1cmU6IG51bGwKICB9Cn0KCmZ1bmN0aW9uIGdldEJpdGZpZWxkUGFnZShpbmRleCkgewogIHJldHVybiBNYXRoLmZsb29yKGluZGV4IC8gQml0ZmllbGQuQklUU19QRVJfUEFHRSkKfQoKZnVuY3Rpb24gZ2V0Qml0ZmllbGRPZmZzZXQoaW5kZXgpIHsKICByZXR1cm4gaW5kZXggJiAoQml0ZmllbGQuQklUU19QRVJfUEFHRSAtIDEpCn0KCmZ1bmN0aW9uIHdhbGtUcmVlKHN0YWNrLCB0YXJnZXQsIGJhdGNoKSB7CiAgd2hpbGUgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgIGNvbnN0IG5vZGUgPSBzdGFjay5wb3AoKQoKICAgIGlmICgobm9kZSAmIDEpID09PSAwKSB7CiAgICAgIGlmIChub2RlID09PSB0YXJnZXQpIHJldHVybiB0cnVlCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihub2RlKQogICAgaWYgKCFpdGUuY29udGFpbnModGFyZ2V0KSkgY29udGludWUKCiAgICB3aGlsZSAoKGl0ZS5pbmRleCAmIDEpICE9PSAwKSB7CiAgICAgIGNvbnN0IGxlZnQgPSBpdGUubGVmdENoaWxkKCkKICAgICAgY29uc3QgcmlnaHQgPSBpdGUuc2libGluZygpIC8vIGlzIHJpZ2h0IGNoaWxkCgogICAgICBiYXRjaC50cmVlLnB1c2gobGVmdCwgcmlnaHQpCgogICAgICBpZiAoaXRlLmNvbnRhaW5zKHRhcmdldCkpIHN0YWNrLnB1c2gobGVmdCkKICAgICAgZWxzZSBpdGUuc2libGluZygpCiAgICB9CgogICAgaWYgKGl0ZS5pbmRleCA9PT0gdGFyZ2V0KSByZXR1cm4gdHJ1ZQogIH0KCiAgcmV0dXJuIGZhbHNlCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKY29uc3QgejMyID0gcmVxdWlyZSgnejMyJykKY29uc3QgTXV0ZXggPSByZXF1aXJlKCcuL211dGV4JykKY29uc3QgeyBNZXJrbGVUcmVlLCBSZW9yZ0JhdGNoIH0gPSByZXF1aXJlKCcuL21lcmtsZS10cmVlJykKY29uc3QgQml0SW50ZXJsdWRlID0gcmVxdWlyZSgnLi9iaXQtaW50ZXJsdWRlJykKY29uc3QgQml0ZmllbGQgPSByZXF1aXJlKCcuL2JpdGZpZWxkJykKY29uc3QgUmVtb3RlQml0ZmllbGQgPSByZXF1aXJlKCcuL3JlbW90ZS1iaXRmaWVsZCcpCmNvbnN0IHsKICBCQURfQVJHVU1FTlQsCiAgU1RPUkFHRV9FTVBUWSwKICBTVE9SQUdFX0NPTkZMSUNULAogIElOVkFMSURfU0lHTkFUVVJFLAogIElOVkFMSURfQ0hFQ0tTVU0KfSA9IHJlcXVpcmUoJ2h5cGVyY29yZS1lcnJvcnMnKQpjb25zdCBWZXJpZmllciA9IHJlcXVpcmUoJy4vdmVyaWZpZXInKQpjb25zdCBhdWRpdCA9IHJlcXVpcmUoJy4vYXVkaXQnKQpjb25zdCBjb3B5UHJvbG9ndWUgPSByZXF1aXJlKCcuL2NvcHktcHJvbG9ndWUnKQpjb25zdCBTZXNzaW9uU3RhdGUgPSByZXF1aXJlKCcuL3Nlc3Npb24tc3RhdGUnKQpjb25zdCBSZXBsaWNhdG9yID0gcmVxdWlyZSgnLi9yZXBsaWNhdG9yJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ29yZSB7CiAgY29uc3RydWN0b3IoZGIsIG9wdHMgPSB7fSkgewogICAgdGhpcy5kYiA9IGRiCiAgICB0aGlzLnN0b3JhZ2UgPSBudWxsCiAgICB0aGlzLnJlcGxpY2F0b3IgPSBuZXcgUmVwbGljYXRvcih0aGlzLCBvcHRzKQogICAgdGhpcy5zZXNzaW9uU3RhdGVzID0gW10KICAgIHRoaXMubW9uaXRvcnMgPSBbXQogICAgdGhpcy5hY3RpdmVTZXNzaW9ucyA9IDAKICAgIHRoaXMuZ2MgPSAwIC8vIGNvcmVzdG9yZSB1c2VzIHRoaXMgdG8gbWFpbiBhIGdjIHN0cmlrZSBwb29sCgogICAgdGhpcy5pZCA9IG9wdHMua2V5ID8gejMyLmVuY29kZShvcHRzLmtleSkgOiBudWxsCiAgICB0aGlzLmtleSA9IG9wdHMua2V5IHx8IG51bGwKICAgIHRoaXMuZGlzY292ZXJ5S2V5ID0gb3B0cy5kaXNjb3ZlcnlLZXkgfHwgKG9wdHMua2V5ICYmIGNyeXB0by5kaXNjb3ZlcnlLZXkob3B0cy5rZXkpKSB8fCBudWxsCiAgICB0aGlzLm1hbmlmZXN0ID0gbnVsbAogICAgdGhpcy5vcGVuaW5nID0gbnVsbAogICAgdGhpcy5jbG9zaW5nID0gbnVsbAogICAgdGhpcy5leGNsdXNpdmUgPSBudWxsCgogICAgdGhpcy5wcmV1cGRhdGUgPSBudWxsCiAgICB0aGlzLmhlYWRlciA9IG51bGwKICAgIHRoaXMuY29tcGF0ID0gZmFsc2UKICAgIHRoaXMuYml0ZmllbGQgPSBudWxsCiAgICB0aGlzLnZlcmlmaWVyID0gbnVsbAogICAgdGhpcy50cnVuY2F0aW5nID0gMAogICAgdGhpcy51cGRhdGluZyA9IGZhbHNlCiAgICB0aGlzLnNraXBCaXRmaWVsZCA9IG51bGwKICAgIHRoaXMuZ2xvYmFsQ2FjaGUgPSBvcHRzLmdsb2JhbENhY2hlIHx8IG51bGwKICAgIHRoaXMuYXV0b0Nsb3NlID0gb3B0cy5hdXRvQ2xvc2UgIT09IGZhbHNlCiAgICB0aGlzLm9uaWRsZSA9IG5vb3AKCiAgICB0aGlzLnN0YXRlID0gbnVsbAogICAgdGhpcy5vcGVuZWQgPSBmYWxzZQogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5jbG9zZWQgPSBmYWxzZQoKICAgIHRoaXMuaGludHNDaGFuZ2VkID0gZmFsc2UKCiAgICB0aGlzLl9iaXRmaWVsZCA9IG51bGwKICAgIHRoaXMuX3ZlcmlmaWVzID0gbnVsbAogICAgdGhpcy5fdmVyaWZpZXNGbHVzaGVkID0gbnVsbAogICAgdGhpcy5fbGVnYWN5ID0gISFvcHRzLmxlZ2FjeQoKICAgIHRoaXMub3BlbmluZyA9IHRoaXMuX29wZW4ob3B0cykKICAgIHRoaXMub3BlbmluZy5jYXRjaChub29wKQogIH0KCiAgcmVhZHkoKSB7CiAgICByZXR1cm4gdGhpcy5vcGVuaW5nCiAgfQoKICBhZGRNb25pdG9yKHMpIHsKICAgIGlmIChzLl9tb25pdG9ySW5kZXggPj0gMCkgcmV0dXJuCiAgICBzLl9tb25pdG9ySW5kZXggPSB0aGlzLm1vbml0b3JzLnB1c2gocykgLSAxCiAgfQoKICByZW1vdmVNb25pdG9yKHMpIHsKICAgIGlmIChzLl9tb25pdG9ySW5kZXggPCAwKSByZXR1cm4KICAgIGNvbnN0IGhlYWQgPSB0aGlzLm1vbml0b3JzLnBvcCgpCiAgICBpZiAoaGVhZCAhPT0gcykgdGhpcy5tb25pdG9yc1soaGVhZC5fbW9uaXRvckluZGV4ID0gcy5fbW9uaXRvckluZGV4KV0gPSBoZWFkCiAgICBzLl9tb25pdG9ySW5kZXggPSAtMQogIH0KCiAgZW1pdE1hbmlmZXN0KCkgewogICAgZm9yIChsZXQgaSA9IHRoaXMubW9uaXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgdGhpcy5tb25pdG9yc1tpXS5lbWl0KCdtYW5pZmVzdCcpCiAgICB9CiAgfQoKICBjcmVhdGVVc2VyRGF0YVN0cmVhbShvcHRzLCBzZXNzaW9uID0gdGhpcy5zdGF0ZSkgewogICAgcmV0dXJuIHNlc3Npb24uc3RvcmFnZS5jcmVhdGVVc2VyRGF0YVN0cmVhbShvcHRzKQogIH0KCiAgYWxsU2Vzc2lvbnMoKSB7CiAgICBjb25zdCBzZXNzaW9ucyA9IFtdCiAgICBmb3IgKGNvbnN0IHN0YXRlIG9mIHRoaXMuc2Vzc2lvblN0YXRlcykgewogICAgICBpZiAoc3RhdGUuc2Vzc2lvbnMubGVuZ3RoKSBzZXNzaW9ucy5wdXNoKC4uLnN0YXRlLnNlc3Npb25zKQogICAgfQogICAgcmV0dXJuIHNlc3Npb25zCiAgfQoKICBoYXNTZXNzaW9uKCkgewogICAgcmV0dXJuIHRoaXMuYWN0aXZlU2Vzc2lvbnMgIT09IDAKICB9CgogIGNvbXBhY3QoKSB7CiAgICBjb25zdCBjb21wYWN0aW5nID0gW10KICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLnNlc3Npb25TdGF0ZXMpIHsKICAgICAgY29tcGFjdGluZy5wdXNoKHMuc3RvcmFnZS5jb21wYWN0KCkpCiAgICB9CiAgICByZXR1cm4gUHJvbWlzZS5hbGwoY29tcGFjdGluZykKICB9CgogIGNoZWNrSWZJZGxlKCkgewogICAgaWYgKCF0aGlzLm9wZW5lZCB8fCB0aGlzLmRlc3Ryb3llZCA9PT0gdHJ1ZSB8fCB0aGlzLmhhc1Nlc3Npb24oKSA9PT0gdHJ1ZSkgcmV0dXJuCiAgICBpZiAodGhpcy5yZXBsaWNhdG9yLmlkbGUoKSA9PT0gZmFsc2UpIHJldHVybgogICAgaWYgKHRoaXMuc3RhdGUgPT09IG51bGwgfHwgdGhpcy5zdGF0ZS5tdXRleC5pZGxlKCkgPT09IGZhbHNlKSByZXR1cm4KICAgIHRoaXMub25pZGxlKCkKICB9CgogIGFzeW5jIGxvY2tFeGNsdXNpdmUoKSB7CiAgICBpZiAodGhpcy5leGNsdXNpdmUgPT09IG51bGwpIHRoaXMuZXhjbHVzaXZlID0gbmV3IE11dGV4KCkKICAgIGF3YWl0IHRoaXMuZXhjbHVzaXZlLmxvY2soKQogIH0KCiAgdW5sb2NrRXhjbHVzaXZlKCkgewogICAgaWYgKHRoaXMuZXhjbHVzaXZlICE9PSBudWxsKSB0aGlzLmV4Y2x1c2l2ZS51bmxvY2soKQogIH0KCiAgYXN5bmMgX29wZW4ob3B0cykgewogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fdHJ5T3BlbihvcHRzKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMub25pZGxlKCkKICAgICAgdGhyb3cgZXJyCiAgICB9CgogICAgdGhpcy5vcGVuZWQgPSB0cnVlCiAgfQoKICBhc3luYyBfdHJ5T3BlbihvcHRzKSB7CiAgICBpZiAob3B0cy5wcmVvcGVuKSBhd2FpdCBvcHRzLnByZW9wZW4gLy8ganVzdCBhIGhvb2sgdG8gYWxsb3cgZXhjbHVzaXZlIGFjY2VzcyBoZXJlLi4uCgogICAgbGV0IHN0b3JhZ2UgPSBhd2FpdCB0aGlzLmRiLnJlc3VtZUNvcmUodGhpcy5kaXNjb3ZlcnlLZXkpCgogICAgbGV0IG92ZXJ3cml0ZSA9IG9wdHMub3ZlcndyaXRlID09PSB0cnVlCgogICAgY29uc3QgZm9yY2UgPSBvcHRzLmZvcmNlID09PSB0cnVlCiAgICBjb25zdCBjcmVhdGVJZk1pc3NpbmcgPSBvcHRzLmNyZWF0ZUlmTWlzc2luZyAhPT0gZmFsc2UKICAgIC8vIGtpbGwgdGhpcyBmbGFnIHNvb24KICAgIGNvbnN0IGxlZ2FjeSA9ICEhb3B0cy5sZWdhY3kKCiAgICAvLyBkZWZhdWx0IHRvIHRydWUgZm9yIG5vdyBpZiBubyBtYW5pZmVzdCBpcyBwcm92aWRlZAogICAgbGV0IGNvbXBhdCA9IG9wdHMuY29tcGF0ID09PSB0cnVlIHx8IChvcHRzLmNvbXBhdCAhPT0gZmFsc2UgJiYgIW9wdHMubWFuaWZlc3QpCgogICAgbGV0IGhlYWRlciA9IHN0b3JhZ2UgPyBwYXJzZUhlYWRlcihhd2FpdCBnZXRDb3JlSW5mbyhzdG9yYWdlKSkgOiBudWxsCgogICAgY29uc3QgaGFkTWFuaWZlc3QgPSAhIWhlYWRlciAmJiAhIWhlYWRlci5tYW5pZmVzdCAmJiAhIWhlYWRlci5rZXkKICAgIGNvbnN0IGhhZEtleVBhaXIgPSAhIWhlYWRlciAmJiAhIWhlYWRlci5rZXlQYWlyCgogICAgaWYgKGZvcmNlICYmIG9wdHMua2V5ICYmIGhlYWRlciAmJiAhYjRhLmVxdWFscyhoZWFkZXIua2V5LCBvcHRzLmtleSkpIHsKICAgICAgb3ZlcndyaXRlID0gdHJ1ZQogICAgfQoKICAgIGlmICghaGVhZGVyICYmIG9wdHMuZGlzY292ZXJ5S2V5ICYmICEob3B0cy5rZXkgfHwgb3B0cy5tYW5pZmVzdCkpIHsKICAgICAgdGhyb3cgU1RPUkFHRV9FTVBUWSgnTm8gSHlwZXJjb3JlIGlzIHN0b3JlZCBoZXJlJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgaWYgKCFoZWFkZXIgfHwgb3ZlcndyaXRlKSB7CiAgICAgIGlmICghY3JlYXRlSWZNaXNzaW5nKSB7CiAgICAgICAgdGhyb3cgU1RPUkFHRV9FTVBUWSgnTm8gSHlwZXJjb3JlIGlzIHN0b3JlZCBoZXJlJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICAgIH0KCiAgICAgIGlmIChjb21wYXQpIHsKICAgICAgICBpZiAob3B0cy5rZXkgJiYgb3B0cy5rZXlQYWlyICYmICFiNGEuZXF1YWxzKG9wdHMua2V5LCBvcHRzLmtleVBhaXIucHVibGljS2V5KSkgewogICAgICAgICAgdGhyb3cgQkFEX0FSR1VNRU5UKCdLZXkgbXVzdCBtYXRjaCBwdWJsaWNLZXkgd2hlbiBpbiBjb21wYXQgbW9kZScsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3Qga2V5UGFpciA9IG9wdHMua2V5UGFpciB8fCAob3B0cy5rZXkgPyBudWxsIDogY3J5cHRvLmtleVBhaXIoKSkKCiAgICAgIGNvbnN0IGRlZmF1bHRNYW5pZmVzdCA9CiAgICAgICAgIW9wdHMubWFuaWZlc3QgJiYKICAgICAgICAoISFvcHRzLmNvbXBhdCB8fCAhb3B0cy5rZXkgfHwgISEoa2V5UGFpciAmJiBiNGEuZXF1YWxzKG9wdHMua2V5LCBrZXlQYWlyLnB1YmxpY0tleSkpKQogICAgICBjb25zdCBtYW5pZmVzdCA9IGRlZmF1bHRNYW5pZmVzdAogICAgICAgID8gVmVyaWZpZXIuZGVmYXVsdFNpZ25lck1hbmlmZXN0KG9wdHMua2V5IHx8IGtleVBhaXIucHVibGljS2V5KQogICAgICAgIDogVmVyaWZpZXIuY3JlYXRlTWFuaWZlc3Qob3B0cy5tYW5pZmVzdCkKCiAgICAgIGhlYWRlciA9IHsKICAgICAgICBrZXk6IG9wdHMua2V5IHx8IChjb21wYXQgPyBtYW5pZmVzdC5zaWduZXJzWzBdLnB1YmxpY0tleSA6IFZlcmlmaWVyLm1hbmlmZXN0SGFzaChtYW5pZmVzdCkpLAogICAgICAgIG1hbmlmZXN0LAogICAgICAgIGtleVBhaXI6IGtleVBhaXIKICAgICAgICAgID8geyBwdWJsaWNLZXk6IGtleVBhaXIucHVibGljS2V5LCBzZWNyZXRLZXk6IGtleVBhaXIuc2VjcmV0S2V5IHx8IG51bGwgfQogICAgICAgICAgOiBudWxsLAogICAgICAgIGZyb3plbjogZmFsc2UsCiAgICAgICAgdHJlZTogewogICAgICAgICAgZm9yazogMCwKICAgICAgICAgIGxlbmd0aDogMCwKICAgICAgICAgIHJvb3RIYXNoOiBudWxsLAogICAgICAgICAgc2lnbmF0dXJlOiBudWxsCiAgICAgICAgfSwKICAgICAgICBoaW50czogewogICAgICAgICAgcmVvcmdzOiBbXSwKICAgICAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IDAsCiAgICAgICAgICByZW1vdGVDb250aWd1b3VzTGVuZ3RoOiAwCiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCBkaXNjb3ZlcnlLZXkgPSBvcHRzLmRpc2NvdmVyeUtleSB8fCBjcnlwdG8uZGlzY292ZXJ5S2V5KGhlYWRlci5rZXkpCgogICAgICBzdG9yYWdlID0gYXdhaXQgdGhpcy5kYi5jcmVhdGVDb3JlKHsKICAgICAgICBrZXk6IGhlYWRlci5rZXksCiAgICAgICAgbWFuaWZlc3QsCiAgICAgICAga2V5UGFpciwKICAgICAgICBmcm96ZW46IGZhbHNlLAogICAgICAgIGRpc2NvdmVyeUtleSwKICAgICAgICB1c2VyRGF0YTogb3B0cy51c2VyRGF0YSB8fCBbXSwKICAgICAgICBhbGlhczogb3B0cy5hbGlhcyB8fCBudWxsCiAgICAgIH0pCiAgICB9CgogICAgLy8gdW5zbGFiIHRoZSBsb25nIGxpdmVkIGJ1ZmZlcnMgdG8gYXZvaWQga2VlcGluZyB0aGUgc2xhYiBhbGl2ZQogICAgaGVhZGVyLmtleSA9IHVuc2xhYihoZWFkZXIua2V5KQoKICAgIGlmIChoZWFkZXIudHJlZSkgewogICAgICBoZWFkZXIudHJlZS5yb290SGFzaCA9IHVuc2xhYihoZWFkZXIudHJlZS5yb290SGFzaCkKICAgICAgaGVhZGVyLnRyZWUuc2lnbmF0dXJlID0gdW5zbGFiKGhlYWRlci50cmVlLnNpZ25hdHVyZSkKICAgIH0KCiAgICBpZiAoaGVhZGVyLmtleVBhaXIpIHsKICAgICAgaGVhZGVyLmtleVBhaXIucHVibGljS2V5ID0gdW5zbGFiKGhlYWRlci5rZXlQYWlyLnB1YmxpY0tleSkKICAgICAgaGVhZGVyLmtleVBhaXIuc2VjcmV0S2V5ID0gdW5zbGFiKGhlYWRlci5rZXlQYWlyLnNlY3JldEtleSkKICAgIH0KCiAgICBpZiAoaGVhZGVyLmtleVBhaXIpIHsKICAgICAgaGVhZGVyLmtleVBhaXIucHVibGljS2V5ID0gdW5zbGFiKGhlYWRlci5rZXlQYWlyLnB1YmxpY0tleSkKICAgICAgaGVhZGVyLmtleVBhaXIuc2VjcmV0S2V5ID0gdW5zbGFiKGhlYWRlci5rZXlQYWlyLnNlY3JldEtleSkKICAgIH0KCiAgICBpZiAob3B0cy5tYW5pZmVzdCkgewogICAgICAvLyBpZiB3ZSBwcm92aWRlIGEgbWFuaWZlc3QgYW5kIG5vIGtleSwgdmVyaWZ5IHRoYXQgdGhlIHN0b3JlZCBrZXkgaXMgdGhlIHNhbWUKICAgICAgaWYgKAogICAgICAgICFvcHRzLmtleSAmJgogICAgICAgICFWZXJpZmllci5pc1ZhbGlkTWFuaWZlc3QoaGVhZGVyLmtleSwgVmVyaWZpZXIuY3JlYXRlTWFuaWZlc3Qob3B0cy5tYW5pZmVzdCkpCiAgICAgICkgewogICAgICAgIHRocm93IFNUT1JBR0VfQ09ORkxJQ1QoJ01hbmlmZXN0IGRvZXMgbm90IGhhc2ggdG8gcHJvdmlkZWQga2V5JywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICAgIH0KCiAgICAgIGlmICghaGVhZGVyLm1hbmlmZXN0KSBoZWFkZXIubWFuaWZlc3QgPSBvcHRzLm1hbmlmZXN0CiAgICB9CgogICAgaWYgKG9wdHMua2V5ICYmICFiNGEuZXF1YWxzKGhlYWRlci5rZXksIG9wdHMua2V5KSkgewogICAgICB0aHJvdyBTVE9SQUdFX0NPTkZMSUNUKCdBbm90aGVyIEh5cGVyY29yZSBpcyBzdG9yZWQgaGVyZScsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIC8vIGlmIHdlIHNpZ25hbGxlZCBjb21wYXQsIGJ1dCBhbHJlYWR5IG5vdyB0aGlzIGNvcmUgaXNuJ3QgZGlzYWJsZSBpdAogICAgaWYgKGNvbXBhdCAmJiBoZWFkZXIubWFuaWZlc3QgJiYgIVZlcmlmaWVyLmlzQ29tcGF0KGhlYWRlci5rZXksIGhlYWRlci5tYW5pZmVzdCkpIHsKICAgICAgY29tcGF0ID0gZmFsc2UKICAgIH0gZWxzZSBpZiAoIWNvbXBhdCAmJiBoZWFkZXIubWFuaWZlc3QgJiYgVmVyaWZpZXIuaXNDb21wYXQoaGVhZGVyLmtleSwgaGVhZGVyLm1hbmlmZXN0KSkgewogICAgICBjb21wYXQgPSB0cnVlCiAgICB9CgogICAgY29uc3QgcHJvbG9ndWUgPSBoZWFkZXIubWFuaWZlc3QgPyBoZWFkZXIubWFuaWZlc3QucHJvbG9ndWUgOiBudWxsCgogICAgY29uc3QgYml0ZmllbGQgPSBhd2FpdCBCaXRmaWVsZC5vcGVuKHN0b3JhZ2UsIGhlYWRlci50cmVlLmxlbmd0aCkKCiAgICBjb25zdCB0cmVlSW5mbyA9IHsKICAgICAgZm9yazogaGVhZGVyLnRyZWUuZm9yaywKICAgICAgbGVuZ3RoOiBoZWFkZXIudHJlZS5sZW5ndGgsCiAgICAgIHNpZ25hdHVyZTogaGVhZGVyLnRyZWUuc2lnbmF0dXJlLAogICAgICByb290czogaGVhZGVyLnRyZWUubGVuZ3RoCiAgICAgICAgPyBhd2FpdCBNZXJrbGVUcmVlLmdldFJvb3RzRnJvbVN0b3JhZ2Uoc3RvcmFnZSwgaGVhZGVyLnRyZWUubGVuZ3RoKQogICAgICAgIDogW10sCiAgICAgIHByb2xvZ3VlCiAgICB9CgogICAgaWYgKG92ZXJ3cml0ZSkgewogICAgICBjb25zdCB0eCA9IHN0b3JhZ2Uud3JpdGUoKQogICAgICB0eC5kZWxldGVUcmVlTm9kZVJhbmdlKDAsIC0xKQogICAgICB0eC5kZWxldGVCbG9ja1JhbmdlKDAsIC0xKQogICAgICBiaXRmaWVsZC5jbGVhcih0eCkKICAgICAgYXdhaXQgdHguZmx1c2goKQogICAgfQoKICAgIGNvbnN0IGxlbiA9IGJpdGZpZWxkLmZpbmRGaXJzdChmYWxzZSwgaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgpCiAgICBpZiAoaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGggIT09IGxlbiAmJiAhc3RvcmFnZS5yZWFkT25seSkgewogICAgICBoZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCA9IGxlbgogICAgICBjb25zdCB0eCA9IHN0b3JhZ2Uud3JpdGUoKQogICAgICB0eC5zZXRIaW50cyhoZWFkZXIuaGludHMpCiAgICAgIGF3YWl0IHR4LmZsdXNoKCkKICAgIH0KCiAgICAvLyB0byB1bnNsYWIKICAgIGlmIChoZWFkZXIubWFuaWZlc3QpIHsKICAgICAgaGVhZGVyLm1hbmlmZXN0ID0gVmVyaWZpZXIuY3JlYXRlTWFuaWZlc3QoaGVhZGVyLm1hbmlmZXN0KQogICAgICBpZiAoIWhhZE1hbmlmZXN0IHx8IChoZWFkZXIua2V5UGFpciAmJiAhaGFkS2V5UGFpcikpIHsKICAgICAgICBjb25zdCB0eCA9IHN0b3JhZ2Uud3JpdGUoKQogICAgICAgIHR4LnNldEF1dGgoewogICAgICAgICAga2V5OiBoZWFkZXIua2V5LAogICAgICAgICAgZGlzY292ZXJ5S2V5OiBjcnlwdG8uZGlzY292ZXJ5S2V5KGhlYWRlci5rZXkpLAogICAgICAgICAgbWFuaWZlc3Q6IGhlYWRlci5tYW5pZmVzdCwKICAgICAgICAgIGtleVBhaXI6IGhlYWRlci5rZXlQYWlyCiAgICAgICAgfSkKICAgICAgICBhd2FpdCB0eC5mbHVzaCgpCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCB2ZXJpZmllciA9IGhlYWRlci5tYW5pZmVzdAogICAgICA/IG5ldyBWZXJpZmllcihoZWFkZXIua2V5LCBoZWFkZXIubWFuaWZlc3QsIHsgY3J5cHRvLCBsZWdhY3kgfSkKICAgICAgOiBudWxsCgogICAgdGhpcy5zdG9yYWdlID0gc3RvcmFnZQogICAgdGhpcy5oZWFkZXIgPSBoZWFkZXIKICAgIHRoaXMuY29tcGF0ID0gY29tcGF0CiAgICB0aGlzLmJpdGZpZWxkID0gYml0ZmllbGQKICAgIHRoaXMudmVyaWZpZXIgPSB2ZXJpZmllcgogICAgdGhpcy5zdGF0ZSA9IG5ldyBTZXNzaW9uU3RhdGUodGhpcywgbnVsbCwgc3RvcmFnZSwgdHJlZUluZm8sIG51bGwpCgogICAgaWYgKHRoaXMua2V5ID09PSBudWxsKSB0aGlzLmtleSA9IHRoaXMuaGVhZGVyLmtleQogICAgaWYgKHRoaXMuZGlzY292ZXJ5S2V5ID09PSBudWxsKSB0aGlzLmRpc2NvdmVyeUtleSA9IGNyeXB0by5kaXNjb3ZlcnlLZXkodGhpcy5rZXkpCiAgICBpZiAodGhpcy5pZCA9PT0gbnVsbCkgdGhpcy5pZCA9IHozMi5lbmNvZGUodGhpcy5rZXkpCiAgICBpZiAodGhpcy5tYW5pZmVzdCA9PT0gbnVsbCkgdGhpcy5tYW5pZmVzdCA9IHRoaXMuaGVhZGVyLm1hbmlmZXN0CiAgfQoKICBhc3luYyBhdWRpdChvcHRzKSB7CiAgICBhd2FpdCB0aGlzLnN0YXRlLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCBhdWRpdCh0aGlzLCBvcHRzKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5zdGF0ZS5fdW5sb2NrKCkKICAgIH0KICB9CgogIGFzeW5jIHNldE1hbmlmZXN0KG1hbmlmZXN0KSB7CiAgICBhd2FpdCB0aGlzLnN0YXRlLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGlmIChtYW5pZmVzdCAmJiB0aGlzLmhlYWRlci5tYW5pZmVzdCA9PT0gbnVsbCkgewogICAgICAgIGlmICghVmVyaWZpZXIuaXNWYWxpZE1hbmlmZXN0KHRoaXMuaGVhZGVyLmtleSwgbWFuaWZlc3QpKSB7CiAgICAgICAgICB0aHJvdyBJTlZBTElEX0NIRUNLU1VNKCdNYW5pZmVzdCBoYXNoIGRvZXMgbm90IG1hdGNoJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICAgICAgfQoKICAgICAgICBjb25zdCB0eCA9IHRoaXMuc3RhdGUuY3JlYXRlV3JpdGVCYXRjaCgpCiAgICAgICAgdGhpcy5fc2V0TWFuaWZlc3QodHgsIFZlcmlmaWVyLmNyZWF0ZU1hbmlmZXN0KG1hbmlmZXN0KSwgbnVsbCkKICAgICAgICBhd2FpdCB0aGlzLnN0YXRlLmZsdXNoKCkKICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5zdGF0ZS5fdW5sb2NrKCkKICAgIH0KICB9CgogIF9zZXRNYW5pZmVzdCh0eCwgbWFuaWZlc3QsIGtleVBhaXIpIHsKICAgIGlmICghbWFuaWZlc3QgJiYgYjRhLmVxdWFscyhrZXlQYWlyLnB1YmxpY0tleSwgdGhpcy5oZWFkZXIua2V5KSkgewogICAgICBtYW5pZmVzdCA9IFZlcmlmaWVyLmRlZmF1bHRTaWduZXJNYW5pZmVzdCh0aGlzLmhlYWRlci5rZXkpCiAgICB9CiAgICBpZiAoIW1hbmlmZXN0KSByZXR1cm4KCiAgICBjb25zdCB2ZXJpZmllciA9IG5ldyBWZXJpZmllcih0aGlzLmhlYWRlci5rZXksIG1hbmlmZXN0LCB7IGxlZ2FjeTogdGhpcy5fbGVnYWN5IH0pCgogICAgaWYgKHZlcmlmaWVyLnByb2xvZ3VlKSB0aGlzLnN0YXRlLnByb2xvZ3VlID0gT2JqZWN0LmFzc2lnbih7fSwgdmVyaWZpZXIucHJvbG9ndWUpCgogICAgdGhpcy5tYW5pZmVzdCA9IHRoaXMuaGVhZGVyLm1hbmlmZXN0ID0gbWFuaWZlc3QKCiAgICB0eC5zZXRBdXRoKHsKICAgICAga2V5OiB0aGlzLmhlYWRlci5rZXksCiAgICAgIGRpc2NvdmVyeUtleTogdGhpcy5kaXNjb3ZlcnlLZXksCiAgICAgIG1hbmlmZXN0LAogICAgICBrZXlQYWlyOiB0aGlzLmhlYWRlci5rZXlQYWlyCiAgICAgIC8vIFRPRE86IGVuY3J5cHRpb25LZXk/CiAgICB9KQoKICAgIHRoaXMuY29tcGF0ID0gdmVyaWZpZXIuY29tcGF0CiAgICB0aGlzLnZlcmlmaWVyID0gdmVyaWZpZXIKCiAgICB0aGlzLnJlcGxpY2F0b3Iub251cGdyYWRlKCkKICAgIHRoaXMuZW1pdE1hbmlmZXN0KCkKICB9CgogIGFzeW5jIGNvcHlQcm9sb2d1ZShzcmMpIHsKICAgIGF3YWl0IHRoaXMuc3RhdGUubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgc3JjLm11dGV4LmxvY2soKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuc3RhdGUubXV0ZXgudW5sb2NrKCkKICAgICAgdGhyb3cgZXJyCiAgICB9CgogICAgdHJ5IHsKICAgICAgYXdhaXQgY29weVByb2xvZ3VlKHNyYywgdGhpcykKICAgIH0gZmluYWxseSB7CiAgICAgIHNyYy5tdXRleC51bmxvY2soKQogICAgICB0aGlzLnN0YXRlLm11dGV4LnVubG9jaygpCiAgICAgIHRoaXMuY2hlY2tJZklkbGUoKQogICAgfQogIH0KCiAgZmx1c2hlZCgpIHsKICAgIHJldHVybiB0aGlzLnN0YXRlLmZsdXNoZWQoKQogIH0KCiAgYXN5bmMgX3ZhbGlkYXRlQ29tbWl0KHN0YXRlLCB0cmVlTGVuZ3RoKSB7CiAgICBpZiAodGhpcy5zdGF0ZS5sZW5ndGggPiBzdGF0ZS5sZW5ndGgpIHsKICAgICAgcmV0dXJuIGZhbHNlIC8vIFRPRE86IHBhcnRpYWwgY29tbWl0IGFuZCB0cnVuY2F0aW9uIHBvc3NpYmxlIGluIHRoZSBmdXR1cmUKICAgIH0KCiAgICBpZiAodGhpcy5zdGF0ZS5sZW5ndGggPiB0cmVlTGVuZ3RoKSB7CiAgICAgIGZvciAoY29uc3Qgcm9vdCBvZiB0aGlzLnN0YXRlLnJvb3RzKSB7CiAgICAgICAgY29uc3QgYmF0Y2hSb290ID0gYXdhaXQgTWVya2xlVHJlZS5nZXQoc3RhdGUsIHJvb3QuaW5kZXgpCiAgICAgICAgaWYgKGJhdGNoUm9vdC5zaXplICE9PSByb290LnNpemUgfHwgIWI0YS5lcXVhbHMoYmF0Y2hSb290Lmhhc2gsIHJvb3QuaGFzaCkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLnZlcmlmaWVyID09PSBudWxsKSB7CiAgICAgIHJldHVybiBmYWxzZSAvLyBlYXNpZXIgdG8gYXNzZXJ0IHRoYW4gdXBzZXJ0CiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIF92ZXJpZnlCYXRjaFVwZ3JhZGUoYmF0Y2gsIG1hbmlmZXN0KSB7CiAgICBpZiAoIXRoaXMuaGVhZGVyLm1hbmlmZXN0KSB7CiAgICAgIC8vIGNvbXBhdCwgZHJvcCBhdCBzb21lIHBvaW50CiAgICAgIGlmICghbWFuaWZlc3QpIG1hbmlmZXN0ID0gVmVyaWZpZXIuZGVmYXVsdFNpZ25lck1hbmlmZXN0KHRoaXMuaGVhZGVyLmtleSkKCiAgICAgIGlmICgKICAgICAgICAhbWFuaWZlc3QgfHwKICAgICAgICAhKAogICAgICAgICAgVmVyaWZpZXIuaXNWYWxpZE1hbmlmZXN0KHRoaXMuaGVhZGVyLmtleSwgbWFuaWZlc3QpIHx8CiAgICAgICAgICBWZXJpZmllci5pc0NvbXBhdCh0aGlzLmhlYWRlci5rZXksIG1hbmlmZXN0KQogICAgICAgICkKICAgICAgKSB7CiAgICAgICAgdGhyb3cgSU5WQUxJRF9TSUdOQVRVUkUoJ1Byb29mIGNvbnRhaW5zIGFuIGludmFsaWQgbWFuaWZlc3QnLCB0aGlzLmRpc2NvdmVyeUtleSkgLy8gVE9ETzogcHJvcGVyIGVycm9yIHR5cGUKICAgICAgfQogICAgfQoKICAgIGNvbnN0IHZlcmlmaWVyID0KICAgICAgdGhpcy52ZXJpZmllciB8fAogICAgICBuZXcgVmVyaWZpZXIodGhpcy5oZWFkZXIua2V5LCBWZXJpZmllci5jcmVhdGVNYW5pZmVzdChtYW5pZmVzdCksIHsgbGVnYWN5OiB0aGlzLl9sZWdhY3kgfSkKCiAgICBpZiAoIXZlcmlmaWVyLnZlcmlmeShiYXRjaCwgYmF0Y2guc2lnbmF0dXJlKSkgewogICAgICB0aHJvdyBJTlZBTElEX1NJR05BVFVSRSgnUHJvb2YgY29udGFpbnMgYW4gaW52YWxpZCBzaWduYXR1cmUnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICByZXR1cm4gbWFuaWZlc3QKICB9CgogIGFzeW5jIF92ZXJpZnlFeGNsdXNpdmUoeyBiYXRjaCwgYml0ZmllbGQsIHZhbHVlLCBtYW5pZmVzdCB9KSB7CiAgICBtYW5pZmVzdCA9IHRoaXMuX3ZlcmlmeUJhdGNoVXBncmFkZShiYXRjaCwgbWFuaWZlc3QpCgogICAgaWYgKAogICAgICAhKGF3YWl0IHRoaXMuc3RhdGUuX3ZlcmlmeUJsb2NrKAogICAgICAgIGJhdGNoLAogICAgICAgIGJpdGZpZWxkLAogICAgICAgIHZhbHVlLAogICAgICAgIHRoaXMuaGVhZGVyLm1hbmlmZXN0ID8gbnVsbCA6IG1hbmlmZXN0CiAgICAgICkpCiAgICApIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgaWYgKCFiYXRjaC51cGdyYWRlZCAmJiBiaXRmaWVsZCkgewogICAgICB0aGlzLnJlcGxpY2F0b3Iub25oYXZlKGJpdGZpZWxkLnN0YXJ0LCBiaXRmaWVsZC5sZW5ndGgsIGJpdGZpZWxkLmRyb3ApCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIF92ZXJpZnlTaGFyZWQoKSB7CiAgICBpZiAoIXRoaXMuX3ZlcmlmaWVzLmxlbmd0aCkgcmV0dXJuIGZhbHNlCgogICAgYXdhaXQgdGhpcy5zdGF0ZS5tdXRleC5sb2NrKCkKCiAgICBjb25zdCB0eCA9IHRoaXMuc3RhdGUuY3JlYXRlV3JpdGVCYXRjaCgpCgogICAgY29uc3QgdmVyaWZpZXMgPSB0aGlzLl92ZXJpZmllcwogICAgdGhpcy5fdmVyaWZpZXMgPSBudWxsCiAgICB0aGlzLl92ZXJpZmllZCA9IG51bGwKCiAgICB0cnkgewogICAgICBmb3IgKGNvbnN0IHsgYmF0Y2gsIGJpdGZpZWxkLCB2YWx1ZSB9IG9mIHZlcmlmaWVzKSB7CiAgICAgICAgaWYgKCFiYXRjaC5jb21taXRhYmxlKCkpIGNvbnRpbnVlCgogICAgICAgIGlmIChiaXRmaWVsZCkgewogICAgICAgICAgdHgucHV0QmxvY2soYml0ZmllbGQuc3RhcnQsIHZhbHVlKQogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgYml0cyA9IG5ldyBCaXRJbnRlcmx1ZGUoKQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2ZXJpZmllcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHsgYmF0Y2gsIGJpdGZpZWxkLCBtYW5pZmVzdCB9ID0gdmVyaWZpZXNbaV0KCiAgICAgICAgaWYgKCFiYXRjaC5jb21taXRhYmxlKCkpIHsKICAgICAgICAgIHZlcmlmaWVzW2ldID0gbnVsbCAvLyBzaWduYWwgdGhhdCB3ZSBjYW5ub3QgY29tbWl0IHRoaXMgb25lCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgaWYgKGJpdGZpZWxkKSB7CiAgICAgICAgICBiaXRzLnNldFJhbmdlKGJpdGZpZWxkLnN0YXJ0LCBiaXRmaWVsZC5zdGFydCArIDEsIHRydWUpCiAgICAgICAgfQoKICAgICAgICAvLyBpZiB3ZSBnb3QgYSBtYW5pZmVzdCBBTkQgaXRzIHN0cmljdGx5IGEgbm9uIGNvbXBhdCBvbmUsIGxldHMgc3RvcmUgaXQKICAgICAgICBpZiAobWFuaWZlc3QgJiYgdGhpcy5oZWFkZXIubWFuaWZlc3QgPT09IG51bGwpIHsKICAgICAgICAgIGlmICghVmVyaWZpZXIuaXNWYWxpZE1hbmlmZXN0KHRoaXMuaGVhZGVyLmtleSwgbWFuaWZlc3QpKSB7CiAgICAgICAgICAgIHRocm93IElOVkFMSURfQ0hFQ0tTVU0oJ01hbmlmZXN0IGhhc2ggZG9lcyBub3QgbWF0Y2gnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX3NldE1hbmlmZXN0KHR4LCBtYW5pZmVzdCwgbnVsbCkKICAgICAgICB9CgogICAgICAgIGlmIChiYXRjaC5jb21taXRhYmxlKCkpIGJhdGNoLmNvbW1pdCh0eCkKICAgICAgfQoKICAgICAgY29uc3QgcmFuZ2VzID0gYml0cy5mbHVzaCh0eCwgdGhpcy5iaXRmaWVsZCkKCiAgICAgIGF3YWl0IHRoaXMuc3RhdGUuZmx1c2goKQoKICAgICAgZm9yIChjb25zdCB7IHN0YXJ0LCBlbmQsIHZhbHVlIH0gb2YgcmFuZ2VzKSB7CiAgICAgICAgdGhpcy5fc2V0Qml0ZmllbGRSYW5nZXMoc3RhcnQsIGVuZCwgdmFsdWUpCiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVyaWZpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBiaXRmaWVsZCA9IHZlcmlmaWVzW2ldICYmIHZlcmlmaWVzW2ldLmJpdGZpZWxkCiAgICAgICAgaWYgKGJpdGZpZWxkKSB7CiAgICAgICAgICB0aGlzLnVwZGF0ZUNvbnRpZ3VvdXNMZW5ndGgoYml0ZmllbGQpCiAgICAgICAgICB0aGlzLnJlcGxpY2F0b3Iub25oYXZlKGJpdGZpZWxkLnN0YXJ0LCBiaXRmaWVsZC5sZW5ndGgsIGJpdGZpZWxkLmRyb3ApCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5oaW50c0NoYW5nZWQpIGF3YWl0IHRoaXMuZmx1c2hIaW50cygpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLnN0YXRlLl9jbGVhckFjdGl2ZUJhdGNoKCkKICAgICAgdGhpcy5zdGF0ZS5tdXRleC51bmxvY2soKQogICAgfQoKICAgIHJldHVybiB2ZXJpZmllc1swXSAhPT0gbnVsbAogIH0KCiAgYXN5bmMgZmx1c2hIaW50cygpIHsKICAgIGlmICghdGhpcy5oaW50c0NoYW5nZWQpIHJldHVybgogICAgdGhpcy5oaW50c0NoYW5nZWQgPSBmYWxzZSAvLyB3ZSB1bnNldCB0aGlzIGltbWVkaWF0ZWx5IGFzIGEgImRlYm91bmNlIgoKICAgIGNvbnN0IHR4ID0gdGhpcy5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKCiAgICB0eC5zZXRIaW50cyh7CiAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IHRoaXMuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgsCiAgICAgIHJlbW90ZUNvbnRpZ3VvdXNMZW5ndGg6IHRoaXMuaGVhZGVyLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgKICAgIH0pCgogICAgYXdhaXQgdHguZmx1c2goKQogIH0KCiAgYXN5bmMgY2hlY2tDb25mbGljdChwcm9vZiwgZnJvbSkgewogICAgaWYgKHRoaXMuc3RhdGUubGVuZ3RoIDwgcHJvb2YudXBncmFkZS5sZW5ndGggfHwgcHJvb2YuZm9yayAhPT0gdGhpcy5zdGF0ZS5mb3JrKSB7CiAgICAgIC8vIG91dCBvZiBkYXRlIHRoaXMgcHJvb2YgLSBpZ25vcmUgZm9yIG5vdwogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICAvLyBzYW5pdHkgY2hlY2sgLT4gbm8gbWFuaWZlc3QsIG5vIHdheSB0byB2ZXJpZnkKICAgIGlmICghdGhpcy5oZWFkZXIubWFuaWZlc3QpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc3QgYmF0Y2ggPSBNZXJrbGVUcmVlLnZlcmlmeUZ1bGx5UmVtb3RlKHRoaXMuc3RhdGUsIHByb29mKQoKICAgIHRyeSB7CiAgICAgIHRoaXMuX3ZlcmlmeUJhdGNoVXBncmFkZShiYXRjaCwgcHJvb2YubWFuaWZlc3QpCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBjb25zdCByb290cyA9IGF3YWl0IE1lcmtsZVRyZWUuZ2V0Um9vdHNGcm9tU3RvcmFnZSh0aGlzLnN0b3JhZ2UsIHByb29mLnVwZ3JhZGUubGVuZ3RoKQogICAgY29uc3QgcmVtb3RlVHJlZUhhc2ggPSBjcnlwdG8udHJlZShwcm9vZi51cGdyYWRlLm5vZGVzKQogICAgY29uc3QgbG9jYWxUcmVlSGFzaCA9IGNyeXB0by50cmVlKHJvb3RzKQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJ4ID0gdGhpcy5zdGF0ZS5zdG9yYWdlLnJlYWQoKQogICAgICBjb25zdCB0cmVlUHJvb2ZQcm9taXNlID0gTWVya2xlVHJlZS5wcm9vZih0aGlzLnN0YXRlLCByeCwgewogICAgICAgIGJsb2NrOiBudWxsLAogICAgICAgIGhhc2g6IG51bGwsCiAgICAgICAgc2VlazogbnVsbCwKICAgICAgICB1cGdyYWRlOiB7CiAgICAgICAgICBzdGFydDogMCwKICAgICAgICAgIGxlbmd0aDogcHJvb2YudXBncmFkZS5sZW5ndGgKICAgICAgICB9CiAgICAgIH0pCgogICAgICByeC50cnlGbHVzaCgpCgogICAgICBjb25zdCB0cmVlUHJvb2YgPSBhd2FpdCB0cmVlUHJvb2ZQcm9taXNlCgogICAgICBjb25zdCB2ZXJpZnlCYXRjaCA9IE1lcmtsZVRyZWUudmVyaWZ5RnVsbHlSZW1vdGUodGhpcy5zdGF0ZSwgYXdhaXQgdHJlZVByb29mLnNldHRsZSgpKQogICAgICB0aGlzLl92ZXJpZnlCYXRjaFVwZ3JhZGUodmVyaWZ5QmF0Y2gsIHRoaXMuaGVhZGVyLm1hbmlmZXN0KQogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgLy8gYm90aCBwcm9vZnMgYXJlIHZhbGlkLCBub3cgY2hlY2sgaWYgdGhleSBmb3JrZWQKICAgIGlmIChiNGEuZXF1YWxzKGxvY2FsVHJlZUhhc2gsIHJlbW90ZVRyZWVIYXNoKSkgcmV0dXJuIGZhbHNlCgogICAgYXdhaXQgdGhpcy5zdGF0ZS5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBjb25zdCB0eCA9IHRoaXMuc3RhdGUuY3JlYXRlV3JpdGVCYXRjaCgpCgogICAgICB0aGlzLmhlYWRlci5mcm96ZW4gPSB0cnVlCgogICAgICB0eC5zZXRBdXRoKHsKICAgICAgICBrZXk6IHRoaXMuaGVhZGVyLmtleSwKICAgICAgICBkaXNjb3ZlcnlLZXk6IHRoaXMuZGlzY292ZXJ5S2V5LAogICAgICAgIG1hbmlmZXN0OiB0aGlzLmhlYWRlci5tYW5pZmVzdCwKICAgICAgICBrZXlQYWlyOiB0aGlzLmhlYWRlci5rZXlQYWlyLAogICAgICAgIGZyb3plbjogdHJ1ZQogICAgICB9KQoKICAgICAgYXdhaXQgdGhpcy5zdGF0ZS5mbHVzaCgpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLnN0YXRlLm11dGV4LnVubG9jaygpCiAgICB9CgogICAgLy8gdG1wIGxvZyBzbyB3ZSBjYW4gc2VlIHRoZXNlCiAgICBjb25zdCBpZCA9IGI0YS50b1N0cmluZyh0aGlzLmRpc2NvdmVyeUtleSwgJ2hleCcpCiAgICBjb25zb2xlLmxvZygKICAgICAgJ1toeXBlcmNvcmVdIGNvbmZsaWN0IGRldGVjdGVkIGluICcgKwogICAgICAgIGlkICsKICAgICAgICAnICh3cml0YWJsZT0nICsKICAgICAgICAhIXRoaXMuaGVhZGVyLmtleVBhaXIgKwogICAgICAgICcscXVvcnVtPScgKwogICAgICAgIHRoaXMuaGVhZGVyLm1hbmlmZXN0LnF1b3J1bSArCiAgICAgICAgJyknCiAgICApCiAgICBhd2FpdCB0aGlzLl9vbmNvbmZsaWN0KHByb29mKQogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIHZlcmlmeVJlb3JnKHByb29mKSB7CiAgICBjb25zdCBiYXRjaCA9IG5ldyBSZW9yZ0JhdGNoKHRoaXMuc3RhdGUpCiAgICBhd2FpdCBNZXJrbGVUcmVlLnJlb3JnKHRoaXMuc3RhdGUsIHByb29mLCBiYXRjaCkKICAgIGNvbnN0IG1hbmlmZXN0ID0gdGhpcy5fdmVyaWZ5QmF0Y2hVcGdyYWRlKGJhdGNoLCBwcm9vZi5tYW5pZmVzdCkKCiAgICBpZiAobWFuaWZlc3QgJiYgIXRoaXMuaGVhZGVyLm1hbmlmZXN0KSB7CiAgICAgIGF3YWl0IHRoaXMuc3RhdGUubXV0ZXgubG9jaygpCiAgICAgIHRyeSB7CiAgICAgICAgaWYgKG1hbmlmZXN0ICYmIHRoaXMuaGVhZGVyLm1hbmlmZXN0ID09PSBudWxsKSB7CiAgICAgICAgICBjb25zdCB0eCA9IHRoaXMuc3RhdGUuY3JlYXRlV3JpdGVCYXRjaCgpCiAgICAgICAgICB0aGlzLl9zZXRNYW5pZmVzdCh0eCwgVmVyaWZpZXIuY3JlYXRlTWFuaWZlc3QobWFuaWZlc3QpLCBudWxsKQogICAgICAgICAgYXdhaXQgdGhpcy5zdGF0ZS5mbHVzaCgpCiAgICAgICAgfQogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRoaXMuc3RhdGUuX3VubG9jaygpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYmF0Y2gKICB9CgogIGFzeW5jIHZlcmlmeShwcm9vZiwgZnJvbSkgewogICAgLy8gV2UgY2Fubm90IGFwcGx5ICJvdGhlciBmb3JrcyIgYXRtLgogICAgLy8gV2Ugc2hvdWxkIHByb2JhYmx5IHN0aWxsIHRyeSBhbmQgdGhleSBhcmUgbGlrZWx5IHN1cGVyIHNpbWlsYXIgZm9yIG5vbiB1cGdyYWRlcwogICAgLy8gYnV0IHRoaXMgaXMgZWFzeSBhdG0gKGFuZCB0aGUgYWJvdmUgbGF5ZXIgd2lsbCBqdXN0IHJldHJ5KQogICAgaWYgKHByb29mLmZvcmsgIT09IHRoaXMuc3RhdGUuZm9yaykgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgYmF0Y2ggPSBhd2FpdCBNZXJrbGVUcmVlLnZlcmlmeSh0aGlzLnN0YXRlLCBwcm9vZikKCiAgICBpZiAoYmF0Y2gudXBncmFkZWQgJiYgYmF0Y2gubGVuZ3RoIDw9IHRoaXMuc3RhdGUubGVuZ3RoKSB7CiAgICAgIGF3YWl0IGJhdGNoLmRvd25ncmFkZSgpCiAgICB9CgogICAgaWYgKCFiYXRjaC5jb21taXRhYmxlKCkpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc3QgdmFsdWUgPSAocHJvb2YuYmxvY2sgJiYgcHJvb2YuYmxvY2sudmFsdWUpIHx8IG51bGwKICAgIGNvbnN0IG9wID0gewogICAgICBiYXRjaCwKICAgICAgYml0ZmllbGQ6IHZhbHVlICYmIHsgZHJvcDogZmFsc2UsIHN0YXJ0OiBwcm9vZi5ibG9jay5pbmRleCwgbGVuZ3RoOiAxIH0sCiAgICAgIHZhbHVlLAogICAgICBtYW5pZmVzdDogcHJvb2YubWFuaWZlc3QsCiAgICAgIGZyb20KICAgIH0KCiAgICBpZiAoYmF0Y2gudXBncmFkZWQpIHsKICAgICAgcmV0dXJuIHRoaXMuX3ZlcmlmeUV4Y2x1c2l2ZShvcCkKICAgIH0KCiAgICBpZiAodGhpcy5fdmVyaWZpZXMgIT09IG51bGwpIHsKICAgICAgY29uc3QgdmVyaWZpZXMgPSB0aGlzLl92ZXJpZmllcwogICAgICBjb25zdCBpID0gdmVyaWZpZXMucHVzaChvcCkKICAgICAgYXdhaXQgdGhpcy5fdmVyaWZpZWQKICAgICAgcmV0dXJuIHZlcmlmaWVzW2ldICE9PSBudWxsCiAgICB9CgogICAgdGhpcy5fdmVyaWZpZXMgPSBbb3BdCiAgICB0aGlzLl92ZXJpZmllZCA9IHRoaXMuX3ZlcmlmeVNoYXJlZCgpCgogICAgcmV0dXJuIHRoaXMuX3ZlcmlmaWVkCiAgfQoKICBhc3luYyByZW9yZyhiYXRjaCkgewogICAgaWYgKCFiYXRjaC5jb21taXRhYmxlKCkpIHJldHVybiBmYWxzZQoKICAgIHRoaXMudHJ1bmNhdGluZysrCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5zdGF0ZS5yZW9yZyhiYXRjaCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMudHJ1bmNhdGluZy0tCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIG9wZW5Ta2lwQml0ZmllbGQoKSB7CiAgICBpZiAodGhpcy5za2lwQml0ZmllbGQgIT09IG51bGwpIHJldHVybiB0aGlzLnNraXBCaXRmaWVsZAogICAgdGhpcy5za2lwQml0ZmllbGQgPSBuZXcgUmVtb3RlQml0ZmllbGQoKQogICAgY29uc3QgYnVmID0gdGhpcy5iaXRmaWVsZC50b0J1ZmZlcih0aGlzLnN0YXRlLmxlbmd0aCkKICAgIGNvbnN0IGJpdGZpZWxkID0gbmV3IFVpbnQzMkFycmF5KGJ1Zi5idWZmZXIsIGJ1Zi5ieXRlT2Zmc2V0LCBidWYuYnl0ZUxlbmd0aCAvIDQpCiAgICB0aGlzLnNraXBCaXRmaWVsZC5pbnNlcnQoMCwgYml0ZmllbGQpCiAgICByZXR1cm4gdGhpcy5za2lwQml0ZmllbGQKICB9CgogIF9zZXRCaXRmaWVsZFJhbmdlcyhzdGFydCwgZW5kLCB2YWx1ZSkgewogICAgdGhpcy5iaXRmaWVsZC5zZXRSYW5nZShzdGFydCwgZW5kLCB2YWx1ZSkKICAgIGlmICh0aGlzLnNraXBCaXRmaWVsZCAhPT0gbnVsbCkgdGhpcy5za2lwQml0ZmllbGQuc2V0UmFuZ2Uoc3RhcnQsIGVuZCwgdmFsdWUpCiAgfQoKICBjbG9zZSgpIHsKICAgIGlmICghdGhpcy5jbG9zaW5nKSB0aGlzLmNsb3NpbmcgPSB0aGlzLl9jbG9zZSgpCiAgICByZXR1cm4gdGhpcy5jbG9zaW5nCiAgfQoKICB1cGRhdGVDb250aWd1b3VzTGVuZ3RoKGJpdGZpZWxkKSB7CiAgICBjb25zdCBjb250aWcgPSB1cGRhdGVDb250aWdCYXRjaCh0aGlzLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoLCBiaXRmaWVsZCwgdGhpcy5iaXRmaWVsZCkKCiAgICBpZiAoY29udGlnLmxlbmd0aCAhPT0gLTEgJiYgY29udGlnLmxlbmd0aCAhPT0gdGhpcy5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCkgewogICAgICB0aGlzLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoID0gY29udGlnLmxlbmd0aAogICAgICB0aGlzLmhpbnRzQ2hhbmdlZCA9IHRydWUKICAgIH0KICB9CgogIHVwZGF0ZVJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgobGVuZ3RoKSB7CiAgICB0aGlzLmhlYWRlci5oaW50cy5yZW1vdGVDb250aWd1b3VzTGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLmhpbnRzQ2hhbmdlZCA9IHRydWUKCiAgICBmb3IgKGxldCBpID0gdGhpcy5tb25pdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICB0aGlzLm1vbml0b3JzW2ldLmVtaXQoJ3JlbW90ZS1jb250aWd1b3VzLWxlbmd0aCcsIGxlbmd0aCkKICAgIH0KICB9CgogIG9uYXBwZW5kKHRyZWUsIGJpdGZpZWxkKSB7CiAgICB0aGlzLmhlYWRlci50cmVlID0gdHJlZQoKICAgIGlmICghYml0ZmllbGQpIHsKICAgICAgdGhpcy5yZXBsaWNhdG9yLm9udXBncmFkZSgpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMucmVwbGljYXRvci5jb3JrKCkKCiAgICBjb25zdCB7IHN0YXJ0LCBsZW5ndGgsIGRyb3AgfSA9IGJpdGZpZWxkCgogICAgdGhpcy5fc2V0Qml0ZmllbGRSYW5nZXMoc3RhcnQsIHN0YXJ0ICsgbGVuZ3RoLCB0cnVlKQogICAgdGhpcy51cGRhdGVDb250aWd1b3VzTGVuZ3RoKHsgc3RhcnQsIGxlbmd0aCwgZHJvcDogZmFsc2UgfSkKCiAgICB0aGlzLnJlcGxpY2F0b3Iub251cGdyYWRlKCkKICAgIHRoaXMucmVwbGljYXRvci5vbmhhdmUoc3RhcnQsIGxlbmd0aCwgZHJvcCkKICAgIHRoaXMucmVwbGljYXRvci51bmNvcmsoKQogIH0KCiAgb250cnVuY2F0ZSh0cmVlLCB7IHN0YXJ0LCBsZW5ndGggfSkgewogICAgaWYgKHRyZWUpIHRoaXMuaGVhZGVyLnRyZWUgPSB0cmVlCgogICAgdGhpcy5yZXBsaWNhdG9yLmNvcmsoKQoKICAgIHRoaXMucmVwbGljYXRvci5vbnRydW5jYXRlKHN0YXJ0LCBsZW5ndGgpCiAgICB0aGlzLnJlcGxpY2F0b3Iub25oYXZlKHN0YXJ0LCBsZW5ndGgsIHRydWUpCiAgICB0aGlzLnJlcGxpY2F0b3Iub251cGdyYWRlKCkKICAgIHRoaXMucmVwbGljYXRvci51bmNvcmsoKQoKICAgIGZvciAoY29uc3Qgc2Vzc2lvblN0YXRlIG9mIHRoaXMuc2Vzc2lvblN0YXRlcykgewogICAgICBpZiAoc3RhcnQgPCBzZXNzaW9uU3RhdGUuc25hcHNob3RDb21wYXRMZW5ndGgpIHNlc3Npb25TdGF0ZS5zbmFwc2hvdENvbXBhdExlbmd0aCA9IHN0YXJ0CiAgICB9CgogICAgdGhpcy5fc2V0Qml0ZmllbGRSYW5nZXMoc3RhcnQsIHN0YXJ0ICsgbGVuZ3RoLCBmYWxzZSkKICAgIHRoaXMudXBkYXRlQ29udGlndW91c0xlbmd0aCh7IHN0YXJ0LCBsZW5ndGgsIGRyb3A6IHRydWUgfSkKICB9CgogIGFzeW5jIF9vbmNvbmZsaWN0KHByb29mKSB7CiAgICBhd2FpdCB0aGlzLnJlcGxpY2F0b3Iub25jb25mbGljdCgpCgogICAgZm9yIChsZXQgaSA9IHRoaXMubW9uaXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgcyA9IHRoaXMubW9uaXRvcnNbaV0KICAgICAgcy5lbWl0KCdjb25mbGljdCcsIHByb29mLnVwZ3JhZGUubGVuZ3RoLCBwcm9vZi5mb3JrLCBwcm9vZikKICAgIH0KCiAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoJ1R3byBjb25mbGljdGluZyBzaWduYXR1cmVzIGV4aXN0IGZvciBsZW5ndGggJyArIHByb29mLnVwZ3JhZGUubGVuZ3RoKQogICAgYXdhaXQgdGhpcy5jbG9zZUFsbFNlc3Npb25zKGVycikKICB9CgogIGFzeW5jIGNsb3NlQWxsU2Vzc2lvbnMoZXJyKSB7CiAgICAvLyB0aGlzLnNlc3Npb25zIG1vZGlmaWVzIGl0c2VsZiB3aGVuIGEgc2Vzc2lvbiBjbG9zZXMKICAgIC8vIFRoaXMgd2F5IHdlIGVuc3VyZSB3ZSBpbmRlZWQgaXRlcmF0ZSBvdmVyIGFsbCBzZXNzaW9ucwogICAgY29uc3Qgc2Vzc2lvbnMgPSB0aGlzLmFsbFNlc3Npb25zKCkKCiAgICBjb25zdCBhbGwgPSBbXQogICAgZm9yIChjb25zdCBzIG9mIHNlc3Npb25zKSBhbGwucHVzaChzLmNsb3NlKHsgZXJyb3I6IGVyciwgZm9yY2U6IGZhbHNlIH0pKSAvLyBmb3JjZSBmYWxzZSBvciBlbHNlIGluZmluaXRlIHJlY3Vyc2lvbgogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKGFsbCkKICB9CgogIGFzeW5jIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQgPT09IHRydWUpIHJldHVybgogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCgogICAgaWYgKHRoaXMuaGFzU2Vzc2lvbigpID09PSB0cnVlKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBkZXN0cm95IHdoaWxlIHNlc3Npb25zIGFyZSBvcGVuJykKCiAgICBjb25zdCB3ZWFrU2Vzc2lvbnMgPSB0aGlzLmFsbFNlc3Npb25zKCkKCiAgICBpZiAodGhpcy5yZXBsaWNhdG9yKSB0aGlzLnJlcGxpY2F0b3IuZGVzdHJveSgpCiAgICBpZiAodGhpcy5zdGF0ZSkgYXdhaXQgdGhpcy5zdGF0ZS5jbG9zZSgpCgogICAgLy8gY2xvc2UgYWxsIHBlbmRpbmcgd2VhayBzZXNzaW9ucy4uLgogICAgZm9yIChjb25zdCBzIG9mIHdlYWtTZXNzaW9ucykgcy5jbG9zZSgpLmNhdGNoKG5vb3ApCiAgfQoKICBhc3luYyBfY2xvc2UoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGlmICh0aGlzLmhhc1Nlc3Npb24oKSA9PT0gdHJ1ZSkgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgY2xvc2Ugd2hpbGUgc2Vzc2lvbnMgYXJlIG9wZW4nKQoKICAgIGlmICh0aGlzLnJlcGxpY2F0b3IpIGF3YWl0IHRoaXMucmVwbGljYXRvci5jbG9zZSgpCgogICAgYXdhaXQgdGhpcy5kZXN0cm95KCkKICAgIGlmICh0aGlzLmF1dG9DbG9zZSkgYXdhaXQgdGhpcy5zdG9yYWdlLnN0b3JlLmNsb3NlKCkKCiAgICB0aGlzLmNsb3NlZCA9IHRydWUKICB9Cn0KCmZ1bmN0aW9uIHVwZGF0ZUNvbnRpZ0JhdGNoKHN0YXJ0LCB1cGQsIGJpdGZpZWxkKSB7CiAgY29uc3QgZW5kID0gdXBkLnN0YXJ0ICsgdXBkLmxlbmd0aAoKICBsZXQgYyA9IHN0YXJ0CgogIGlmICh1cGQuZHJvcCkgewogICAgLy8gSWYgd2UgZHJvcHBlZCBhIGJsb2NrIGluIHRoZSBjdXJyZW50IGNvbnRpZyByYW5nZSwgImRvd25ncmFkZSIgaXQKICAgIGlmIChjID4gdXBkLnN0YXJ0KSB7CiAgICAgIGMgPSB1cGQuc3RhcnQKICAgIH0KICB9IGVsc2UgewogICAgaWYgKGMgPD0gZW5kICYmIGMgPj0gdXBkLnN0YXJ0KSB7CiAgICAgIGMgPSBlbmQKICAgICAgd2hpbGUgKGJpdGZpZWxkLmdldChjKSkgYysrCiAgICB9CiAgfQoKICBpZiAoYyA9PT0gc3RhcnQpIHsKICAgIHJldHVybiB7CiAgICAgIGxlbmd0aDogLTEKICAgIH0KICB9CgogIGlmIChjID4gc3RhcnQpIHsKICAgIHJldHVybiB7CiAgICAgIGxlbmd0aDogYwogICAgfQogIH0KCiAgcmV0dXJuIHsKICAgIGxlbmd0aDogYwogIH0KfQoKZnVuY3Rpb24gZ2V0RGVmYXVsdFRyZWUoKSB7CiAgcmV0dXJuIHsKICAgIGZvcms6IDAsCiAgICBsZW5ndGg6IDAsCiAgICByb290SGFzaDogbnVsbCwKICAgIHNpZ25hdHVyZTogbnVsbAogIH0KfQoKZnVuY3Rpb24gcGFyc2VIZWFkZXIoaW5mbykgewogIGlmICghaW5mbykgcmV0dXJuIG51bGwKCiAgcmV0dXJuIHsKICAgIGtleTogaW5mby5rZXksCiAgICBtYW5pZmVzdDogaW5mby5tYW5pZmVzdCwKICAgIGV4dGVybmFsOiBudWxsLAogICAga2V5UGFpcjogaW5mby5rZXlQYWlyLAogICAgdHJlZTogaW5mby5oZWFkIHx8IGdldERlZmF1bHRUcmVlKCksCiAgICBoaW50czogewogICAgICByZW9yZ3M6IFtdLAogICAgICBjb250aWd1b3VzTGVuZ3RoOiBpbmZvLmhpbnRzID8gaW5mby5oaW50cy5jb250aWd1b3VzTGVuZ3RoIDogMCwKICAgICAgcmVtb3RlQ29udGlndW91c0xlbmd0aDogaW5mby5oaW50cyA/IGluZm8uaGludHMucmVtb3RlQ29udGlndW91c0xlbmd0aCA6IDAKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKYXN5bmMgZnVuY3Rpb24gZ2V0Q29yZUluZm8oc3RvcmFnZSkgewogIGNvbnN0IHIgPSBzdG9yYWdlLnJlYWQoKQoKICBjb25zdCBhdXRoID0gci5nZXRBdXRoKCkKICBjb25zdCBoZWFkID0gci5nZXRIZWFkKCkKICBjb25zdCBoaW50cyA9IHIuZ2V0SGludHMoKQoKICByLnRyeUZsdXNoKCkKCiAgY29uc3QgW2F1dGhJbmZvLCBoZWFkSW5mbywgaGludHNJbmZvXSA9IGF3YWl0IFByb21pc2UuYWxsKFthdXRoLCBoZWFkLCBoaW50c10pCiAgcmV0dXJuIHsKICAgIC4uLmF1dGhJbmZvLAogICAgaGVhZDogaGVhZEluZm8sCiAgICBoaW50czogaGludHNJbmZvCiAgfQp9CmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHsgREVGQVVMVF9FTkNSWVBUSU9OIH0gPSByZXF1aXJlKCcuL2NhcHMnKQoKY29uc3Qgbm9uY2UgPSBiNGEuYWxsb2Moc29kaXVtLmNyeXB0b19zdHJlYW1fTk9OQ0VCWVRFUykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgRGVmYXVsdEVuY3J5cHRpb24gewogIHN0YXRpYyBQQURESU5HID0gOAoKICBjb25zdHJ1Y3RvcihlbmNyeXB0aW9uS2V5LCBoeXBlcmNvcmVLZXksIG9wdHMgPSB7fSkgewogICAgdGhpcy5rZXkgPSBlbmNyeXB0aW9uS2V5CiAgICB0aGlzLmNvbXBhdCA9IG9wdHMuY29tcGF0ID09PSB0cnVlCgogICAgY29uc3Qga2V5cyA9IERlZmF1bHRFbmNyeXB0aW9uLmRlcml2ZUtleXMoZW5jcnlwdGlvbktleSwgaHlwZXJjb3JlS2V5LCBvcHRzKQoKICAgIHRoaXMuYmxvY2tLZXkgPSBrZXlzLmJsb2NrCiAgICB0aGlzLmJsaW5kaW5nS2V5ID0ga2V5cy5ibGluZGluZwogIH0KCiAgc3RhdGljIGRlcml2ZUtleXMoZW5jcnlwdGlvbktleSwgaHlwZXJjb3JlS2V5LCB7IGJsb2NrID0gZmFsc2UsIGNvbXBhdCA9IGZhbHNlIH0gPSB7fSkgewogICAgY29uc3Qgc3ViS2V5cyA9IGI0YS5hbGxvYygyICogc29kaXVtLmNyeXB0b19zdHJlYW1fS0VZQllURVMpCgogICAgY29uc3QgYmxvY2tLZXkgPSBibG9jayA/IGVuY3J5cHRpb25LZXkgOiBzdWJLZXlzLnN1YmFycmF5KDAsIHNvZGl1bS5jcnlwdG9fc3RyZWFtX0tFWUJZVEVTKQogICAgY29uc3QgYmxpbmRpbmdLZXkgPSBzdWJLZXlzLnN1YmFycmF5KHNvZGl1bS5jcnlwdG9fc3RyZWFtX0tFWUJZVEVTKQoKICAgIGlmICghYmxvY2spIHsKICAgICAgaWYgKGNvbXBhdCkgewogICAgICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2goYmxvY2tLZXksIFtlbmNyeXB0aW9uS2V5XSwgaHlwZXJjb3JlS2V5KQogICAgICB9IGVsc2UgewogICAgICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2goYmxvY2tLZXksIFtERUZBVUxUX0VOQ1JZUFRJT04sIGh5cGVyY29yZUtleSwgZW5jcnlwdGlvbktleV0pCiAgICAgIH0KICAgIH0KCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGJsaW5kaW5nS2V5LCBibG9ja0tleSkKCiAgICByZXR1cm4gewogICAgICBibGluZGluZzogYmxpbmRpbmdLZXksCiAgICAgIGJsb2NrOiBibG9ja0tleQogICAgfQogIH0KCiAgc3RhdGljIGJsb2NrRW5jcnlwdGlvbktleShoeXBlcmNvcmVLZXksIGVuY3J5cHRpb25LZXkpIHsKICAgIGNvbnN0IGJsb2NrS2V5ID0gYjRhLmFsbG9jKHNvZGl1bS5jcnlwdG9fc3RyZWFtX0tFWUJZVEVTKQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChibG9ja0tleSwgW0RFRkFVTFRfRU5DUllQVElPTiwgaHlwZXJjb3JlS2V5LCBlbmNyeXB0aW9uS2V5XSkKICAgIHJldHVybiBibG9ja0tleQogIH0KCiAgc3RhdGljIGVuY3J5cHQoaW5kZXgsIGJsb2NrLCBmb3JrLCBibG9ja0tleSwgYmxpbmRpbmdLZXkpIHsKICAgIGNvbnN0IHBhZGRpbmcgPSBibG9jay5zdWJhcnJheSgwLCBEZWZhdWx0RW5jcnlwdGlvbi5QQURESU5HKQogICAgYmxvY2sgPSBibG9jay5zdWJhcnJheShEZWZhdWx0RW5jcnlwdGlvbi5QQURESU5HKQoKICAgIGMudWludDY0LmVuY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IDgsIGJ1ZmZlcjogcGFkZGluZyB9LCBmb3JrKQogICAgYy51aW50NjQuZW5jb2RlKHsgc3RhcnQ6IDAsIGVuZDogOCwgYnVmZmVyOiBub25jZSB9LCBpbmRleCkKCiAgICAvLyBaZXJvIG91dCBhbnkgcHJldmlvdXMgcGFkZGluZy4KICAgIG5vbmNlLmZpbGwoMCwgOCwgOCArIHBhZGRpbmcuYnl0ZUxlbmd0aCkKCiAgICAvLyBCbGluZCB0aGUgZm9yayBJRCwgcG9zc2libHkgcmlza2luZyByZXVzaW5nIHRoZSBub25jZSBvbiBhIHJlb3JnIG9mIHRoZQogICAgLy8gSHlwZXJjb3JlLiBUaGlzIGlzIGZpbmUgYXMgdGhlIGJsaW5kaW5nIGlzIGJlc3QtZWZmb3J0IGFuZCB0aGUgbGF0ZXN0CiAgICAvLyBmb3JrIElEIHNoYXJlZCBvbiByZXBsaWNhdGlvbiBhbnl3YXkuCiAgICBzb2RpdW0uY3J5cHRvX3N0cmVhbV94b3IocGFkZGluZywgcGFkZGluZywgbm9uY2UsIGJsaW5kaW5nS2V5KQoKICAgIG5vbmNlLnNldChwYWRkaW5nLCA4KQoKICAgIC8vIFRoZSBjb21iaW5hdGlvbiBvZiBhIChibGluZGVkKSBmb3JrIElEIGFuZCBhIGJsb2NrIGluZGV4IGlzIHVuaXF1ZSBmb3IgYQogICAgLy8gZ2l2ZW4gSHlwZXJjb3JlIGFuZCBpcyB0aGVyZWZvcmUgYSB2YWxpZCBub25jZSBmb3IgZW5jcnlwdGluZyB0aGUgYmxvY2suCiAgICBzb2RpdW0uY3J5cHRvX3N0cmVhbV94b3IoYmxvY2ssIGJsb2NrLCBub25jZSwgYmxvY2tLZXkpCiAgfQoKICBzdGF0aWMgZGVjcnlwdChpbmRleCwgYmxvY2ssIGJsb2NrS2V5KSB7CiAgICBjb25zdCBwYWRkaW5nID0gYmxvY2suc3ViYXJyYXkoMCwgRGVmYXVsdEVuY3J5cHRpb24uUEFERElORykKICAgIGJsb2NrID0gYmxvY2suc3ViYXJyYXkoRGVmYXVsdEVuY3J5cHRpb24uUEFERElORykKCiAgICBjLnVpbnQ2NC5lbmNvZGUoeyBzdGFydDogMCwgZW5kOiA4LCBidWZmZXI6IG5vbmNlIH0sIGluZGV4KQoKICAgIG5vbmNlLnNldChwYWRkaW5nLCA4KQoKICAgIC8vIERlY3J5cHQgdGhlIGJsb2NrIHVzaW5nIHRoZSBibGluZGVkIGZvcmsgSUQuCiAgICBzb2RpdW0uY3J5cHRvX3N0cmVhbV94b3IoYmxvY2ssIGJsb2NrLCBub25jZSwgYmxvY2tLZXkpCiAgfQoKICBlbmNyeXB0KGluZGV4LCBibG9jaywgZm9yaywgY29yZSkgewogICAgaWYgKGNvcmUuY29tcGF0ICE9PSB0aGlzLmNvbXBhdCkgdGhpcy5fcmVsb2FkKGNvcmUpCiAgICByZXR1cm4gRGVmYXVsdEVuY3J5cHRpb24uZW5jcnlwdChpbmRleCwgYmxvY2ssIGZvcmssIHRoaXMuYmxvY2tLZXksIHRoaXMuYmxpbmRpbmdLZXkpCiAgfQoKICBkZWNyeXB0KGluZGV4LCBibG9jaywgY29yZSkgewogICAgaWYgKGNvcmUuY29tcGF0ICE9PSB0aGlzLmNvbXBhdCkgdGhpcy5fcmVsb2FkKGNvcmUpCiAgICByZXR1cm4gRGVmYXVsdEVuY3J5cHRpb24uZGVjcnlwdChpbmRleCwgYmxvY2ssIHRoaXMuYmxvY2tLZXkpCiAgfQoKICBwYWRkaW5nKCkgewogICAgcmV0dXJuIERlZmF1bHRFbmNyeXB0aW9uLlBBRERJTkcKICB9CgogIF9yZWxvYWQoY29yZSkgewogICAgY29uc3QgYmxvY2sgPSBiNGEuZXF1YWxzKHRoaXMua2V5LCB0aGlzLmJsb2NrS2V5KQogICAgY29uc3Qga2V5cyA9IERlZmF1bHRFbmNyeXB0aW9uLmRlcml2ZUtleXModGhpcy5rZXksIGNvcmUua2V5LCB7IGJsb2NrLCBjb21wYXQ6IGNvcmUuY29tcGF0IH0pCgogICAgdGhpcy5ibG9ja0tleSA9IGtleXMuYmxvY2tLZXkKICAgIHRoaXMuYmxpbmRpbmdLZXkgPSBrZXlzLmJsaW5kaW5nS2V5CiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgRG93bmxvYWQgewogIGNvbnN0cnVjdG9yKHNlc3Npb24sIHJhbmdlKSB7CiAgICB0aGlzLnNlc3Npb24gPSBzZXNzaW9uCiAgICB0aGlzLnJhbmdlID0gcmFuZ2UKICAgIHRoaXMucmVxdWVzdCA9IG51bGwKICAgIHRoaXMub3BlbmVkID0gZmFsc2UKICAgIHRoaXMub3BlbmluZyA9IHRoaXMuX29wZW4oKQogICAgdGhpcy5vcGVuaW5nLmNhdGNoKG5vb3ApCiAgfQoKICByZWFkeSgpIHsKICAgIHJldHVybiB0aGlzLm9wZW5pbmcKICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgaWYgKHRoaXMuc2Vzc2lvbi5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnNlc3Npb24ub3BlbmluZwogICAgdGhpcy5fZG93bmxvYWQoKQogICAgdGhpcy5vcGVuZWQgPSB0cnVlCiAgfQoKICBhc3luYyBkb25lKCkgewogICAgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucmVxdWVzdC5wcm9taXNlCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKGlzU2Vzc2lvbk1vdmVkKGVycikpIHJldHVybiB0aGlzLl9kb3dubG9hZCgpCiAgICAgIHRocm93IGVycgogICAgfQogIH0KCiAgX2Rvd25sb2FkKCkgewogICAgY29uc3QgYWN0aXZlUmVxdWVzdHMgPSAodGhpcy5yYW5nZSAmJiB0aGlzLnJhbmdlLmFjdGl2ZVJlcXVlc3RzKSB8fCB0aGlzLnNlc3Npb24uYWN0aXZlUmVxdWVzdHMKICAgIHRoaXMucmVxdWVzdCA9IHRoaXMuc2Vzc2lvbi5jb3JlLnJlcGxpY2F0b3IuYWRkUmFuZ2UoYWN0aXZlUmVxdWVzdHMsIHRoaXMucmFuZ2UpCiAgICB0aGlzLnJlcXVlc3QucHJvbWlzZS5jYXRjaChub29wKQogICAgcmV0dXJuIHRoaXMucmVxdWVzdC5wcm9taXNlCiAgfQoKICAvKioKICAgKiBEZXByZWNhdGVkLiBVc2UgYHJhbmdlLmRvbmUoKWAuCiAgICovCiAgZG93bmxvYWRlZCgpIHsKICAgIHJldHVybiB0aGlzLmRvbmUoKQogIH0KCiAgZGVzdHJveSgpIHsKICAgIHRoaXMuX2Rlc3Ryb3lCYWNrZ3JvdW5kKCkuY2F0Y2gobm9vcCkKICB9CgogIGFzeW5jIF9kZXN0cm95QmFja2dyb3VuZCgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKHRoaXMucmVxdWVzdC5jb250ZXh0KSB0aGlzLnJlcXVlc3QuY29udGV4dC5kZXRhY2godGhpcy5yZXF1ZXN0KQogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CgpmdW5jdGlvbiBpc1Nlc3Npb25Nb3ZlZChlcnIpIHsKICByZXR1cm4gZXJyLmNvZGUgPT09ICdTRVNTSU9OX01PVkVEJwp9CmNvbnN0IFRJQ0tTID0gMTYKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgSG90c3dhcFF1ZXVlIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMucHJpb3JpdGllcyA9IFtbXSwgW10sIFtdXQogIH0KCiAgKnBpY2socGVlcikgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnByaW9yaXRpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgLy8gdHJ5IGZpcnN0IG9uZSBtb3JlIHRoYW4gc2Vjb25kIG9uZSBldGMgZXRjCiAgICAgIGxldCB0aWNrcyA9ICh0aGlzLnByaW9yaXRpZXMubGVuZ3RoIC0gaSkgKiBUSUNLUwogICAgICBjb25zdCBxdWV1ZSA9IHRoaXMucHJpb3JpdGllc1tpXQoKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBxdWV1ZS5sZW5ndGg7IGorKykgewogICAgICAgIGNvbnN0IHIgPSBqICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogcXVldWUubGVuZ3RoIC0gaikKICAgICAgICBjb25zdCBhID0gcXVldWVbal0KICAgICAgICBjb25zdCBiID0gcXVldWVbcl0KCiAgICAgICAgaWYgKHIgIT09IGopIHsKICAgICAgICAgIHF1ZXVlWyhiLmhvdHN3YXAuaW5kZXggPSBqKV0gPSBiCiAgICAgICAgICBxdWV1ZVsoYS5ob3Rzd2FwLmluZGV4ID0gcildID0gYQogICAgICAgIH0KCiAgICAgICAgaWYgKGhhc0luZmxpZ2h0KGIsIHBlZXIpKSBjb250aW51ZQoKICAgICAgICB5aWVsZCBiCgogICAgICAgIGlmICgtLXRpY2tzIDw9IDApIGJyZWFrCiAgICAgIH0KICAgIH0KICB9CgogIGFkZChibG9jaykgewogICAgaWYgKGJsb2NrLmhvdHN3YXAgIT09IG51bGwpIHRoaXMucmVtb3ZlKGJsb2NrKQogICAgaWYgKGJsb2NrLmluZmxpZ2h0Lmxlbmd0aCA9PT0gMCB8fCBibG9jay5pbmZsaWdodC5sZW5ndGggPj0gMykgcmV0dXJuCgogICAgLy8gVE9ETzogYWxzbyB1c2Ugb3RoZXIgc3R1ZmYgdG8gZGV0ZXJtaW5lIHF1ZXVlIHByaW8KICAgIGNvbnN0IHF1ZXVlID0gdGhpcy5wcmlvcml0aWVzW2Jsb2NrLmluZmxpZ2h0Lmxlbmd0aCAtIDFdCgogICAgY29uc3QgaW5kZXggPSBxdWV1ZS5wdXNoKGJsb2NrKSAtIDEKICAgIGJsb2NrLmhvdHN3YXAgPSB7IHJlZjogdGhpcywgcXVldWUsIGluZGV4IH0KICB9CgogIHJlbW92ZShibG9jaykgewogICAgY29uc3QgaG90c3dhcCA9IGJsb2NrLmhvdHN3YXAKICAgIGlmIChob3Rzd2FwID09PSBudWxsKSByZXR1cm4KCiAgICBibG9jay5ob3Rzd2FwID0gbnVsbAogICAgY29uc3QgaGVhZCA9IGhvdHN3YXAucXVldWUucG9wKCkKICAgIGlmIChoZWFkID09PSBibG9jaykgcmV0dXJuCiAgICBob3Rzd2FwLnF1ZXVlWyhoZWFkLmhvdHN3YXAuaW5kZXggPSBob3Rzd2FwLmluZGV4KV0gPSBoZWFkCiAgfQp9CgpmdW5jdGlvbiBoYXNJbmZsaWdodChibG9jaywgcGVlcikgewogIGZvciAobGV0IGogPSAwOyBqIDwgYmxvY2suaW5mbGlnaHQubGVuZ3RoOyBqKyspIHsKICAgIGlmIChibG9jay5pbmZsaWdodFtqXS5wZWVyID09PSBwZWVyKSByZXR1cm4gdHJ1ZQogIH0KICByZXR1cm4gZmFsc2UKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEluZm8gewogIGNvbnN0cnVjdG9yKG9wdHMgPSB7fSkgewogICAgdGhpcy5rZXkgPSBvcHRzLmtleQogICAgdGhpcy5kaXNjb3ZlcnlLZXkgPSBvcHRzLmRpc2NvdmVyeUtleQogICAgdGhpcy5sZW5ndGggPSBvcHRzLmxlbmd0aCB8fCAwCiAgICB0aGlzLmNvbnRpZ3VvdXNMZW5ndGggPSBvcHRzLmNvbnRpZ3VvdXNMZW5ndGggfHwgMAogICAgdGhpcy5ieXRlTGVuZ3RoID0gb3B0cy5ieXRlTGVuZ3RoIHx8IDAKICAgIHRoaXMuZm9yayA9IG9wdHMuZm9yayB8fCAwCiAgICB0aGlzLnBhZGRpbmcgPSBvcHRzLnBhZGRpbmcgfHwgMAogICAgdGhpcy5zdG9yYWdlID0gb3B0cy5zdG9yYWdlIHx8IG51bGwKICB9CgogIHN0YXRpYyBhc3luYyBmcm9tKHNlc3Npb24sIG9wdHMgPSB7fSkgewogICAgcmV0dXJuIG5ldyBJbmZvKHsKICAgICAga2V5OiBzZXNzaW9uLmtleSwKICAgICAgZGlzY292ZXJ5S2V5OiBzZXNzaW9uLmRpc2NvdmVyeUtleSwKICAgICAgbGVuZ3RoOiBzZXNzaW9uLmxlbmd0aCwKICAgICAgY29udGlndW91c0xlbmd0aDogc2Vzc2lvbi5jb250aWd1b3VzTGVuZ3RoLAogICAgICBieXRlTGVuZ3RoOiBzZXNzaW9uLmJ5dGVMZW5ndGgsCiAgICAgIGZvcms6IHNlc3Npb24uZm9yaywKICAgICAgcGFkZGluZzogc2Vzc2lvbi5wYWRkaW5nLAogICAgICBzdG9yYWdlOiBvcHRzLnN0b3JhZ2UgPyBhd2FpdCB0aGlzLnN0b3JhZ2Uoc2Vzc2lvbikgOiBudWxsCiAgICB9KQogIH0KCiAgc3RhdGljIGFzeW5jIHN0b3JhZ2Uoc2Vzc2lvbikgewogICAgY29uc3QgeyBvcGxvZywgdHJlZSwgYmxvY2tzLCBiaXRmaWVsZCB9ID0gc2Vzc2lvbi5jb3JlCiAgICB0cnkgewogICAgICByZXR1cm4gewogICAgICAgIG9wbG9nOiBhd2FpdCBJbmZvLmJ5dGVzVXNlZChvcGxvZy5zdG9yYWdlKSwKICAgICAgICB0cmVlOiBhd2FpdCBJbmZvLmJ5dGVzVXNlZCh0cmVlLnN0b3JhZ2UpLAogICAgICAgIGJsb2NrczogYXdhaXQgSW5mby5ieXRlc1VzZWQoYmxvY2tzLnN0b3JhZ2UpLAogICAgICAgIGJpdGZpZWxkOiBhd2FpdCBJbmZvLmJ5dGVzVXNlZChiaXRmaWVsZC5zdG9yYWdlKQogICAgICB9CiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIG51bGwKICAgIH0KICB9CgogIHN0YXRpYyBieXRlc1VzZWQoZmlsZSkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgZmlsZS5zdGF0KChlcnIsIHN0KSA9PiB7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgcmVzb2x2ZSgwKSAvLyBwcm9iIGp1c3QgZmlsZSBub3QgZm91bmQgKFRPRE8sIGltcHJvdmUpCiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3QuYmxvY2tzICE9PSAnbnVtYmVyJykgewogICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignY2Fubm90IGRldGVybWluZSBieXRlcyB1c2VkJykpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc29sdmUoc3QuYmxvY2tzICogNTEyKQogICAgICAgIH0KICAgICAgfSkKICAgIH0pCiAgfQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChjb3JlLCBkZXB0aCwgb3B0cykgewogIGxldCBpbmRlbnQgPSAnJwogIGlmICh0eXBlb2Ygb3B0cy5pbmRlbnRhdGlvbkx2bCA9PT0gJ251bWJlcicpIHsKICAgIHdoaWxlIChpbmRlbnQubGVuZ3RoIDwgb3B0cy5pbmRlbnRhdGlvbkx2bCkgaW5kZW50ICs9ICcgJwogIH0KCiAgbGV0IHBlZXJzID0gJycKICBjb25zdCBtaW4gPSBNYXRoLm1pbihjb3JlLnBlZXJzLmxlbmd0aCwgNSkKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBtaW47IGkrKykgewogICAgY29uc3QgcGVlciA9IGNvcmUucGVlcnNbaV0KCiAgICBwZWVycyArPSBgJHtpbmRlbnR9ICAgIFBlZXIoXG5gCiAgICBwZWVycyArPSBgJHtpbmRlbnR9ICAgICAgcmVtb3RlUHVibGljS2V5OiAke29wdHMuc3R5bGl6ZSh0b0hleChwZWVyLnJlbW90ZVB1YmxpY0tleSksICdzdHJpbmcnKX1cbmAKICAgIHBlZXJzICs9IGAke2luZGVudH0gICAgICByZW1vdGVMZW5ndGg6ICR7b3B0cy5zdHlsaXplKHBlZXIucmVtb3RlTGVuZ3RoLCAnbnVtYmVyJyl9XG5gCiAgICBwZWVycyArPSBgJHtpbmRlbnR9ICAgICAgcmVtb3RlRm9yazogJHtvcHRzLnN0eWxpemUocGVlci5yZW1vdGVGb3JrLCAnbnVtYmVyJyl9XG5gCiAgICBwZWVycyArPSBgJHtpbmRlbnR9ICAgICAgcmVtb3RlQ2FuVXBncmFkZTogJHtvcHRzLnN0eWxpemUocGVlci5yZW1vdGVDYW5VcGdyYWRlLCAnYm9vbGVhbicpfVxuYAogICAgcGVlcnMgKz0gYCR7aW5kZW50fSAgICApXG5gCiAgfQoKICBpZiAoY29yZS5wZWVycy5sZW5ndGggPiA1KSB7CiAgICBwZWVycyArPSBgJHtpbmRlbnR9ICAuLi4gYW5kICR7Y29yZS5wZWVycy5sZW5ndGggLSA1fSBtb3JlXG5gCiAgfQoKICBpZiAocGVlcnMpIHBlZXJzID0gYFtcbiR7cGVlcnN9JHtpbmRlbnR9ICBdYAogIGVsc2UgcGVlcnMgPSBgWyAke29wdHMuc3R5bGl6ZSgwLCAnbnVtYmVyJyl9IF1gCgogIHJldHVybiAoCiAgICBgJHtjb3JlLmNvbnN0cnVjdG9yLm5hbWV9KFxuYCArCiAgICBgJHtpbmRlbnR9ICBpZDogJHtvcHRzLnN0eWxpemUoY29yZS5pZCwgJ3N0cmluZycpfVxuYCArCiAgICBgJHtpbmRlbnR9ICBrZXk6ICR7b3B0cy5zdHlsaXplKHRvSGV4KGNvcmUua2V5KSwgJ3N0cmluZycpfVxuYCArCiAgICBgJHtpbmRlbnR9ICBkaXNjb3ZlcnlLZXk6ICR7b3B0cy5zdHlsaXplKHRvSGV4KGNvcmUuZGlzY292ZXJ5S2V5KSwgJ3N0cmluZycpfVxuYCArCiAgICBgJHtpbmRlbnR9ICBvcGVuZWQ6ICR7b3B0cy5zdHlsaXplKGNvcmUub3BlbmVkLCAnYm9vbGVhbicpfVxuYCArCiAgICBgJHtpbmRlbnR9ICBjbG9zZWQ6ICR7b3B0cy5zdHlsaXplKGNvcmUuY2xvc2VkLCAnYm9vbGVhbicpfVxuYCArCiAgICBgJHtpbmRlbnR9ICBzbmFwc2hvdHRlZDogJHtvcHRzLnN0eWxpemUoY29yZS5zbmFwc2hvdHRlZCwgJ2Jvb2xlYW4nKX1cbmAgKwogICAgYCR7aW5kZW50fSAgd3JpdGFibGU6ICR7b3B0cy5zdHlsaXplKGNvcmUud3JpdGFibGUsICdib29sZWFuJyl9XG5gICsKICAgIGAke2luZGVudH0gIGxlbmd0aDogJHtvcHRzLnN0eWxpemUoY29yZS5sZW5ndGgsICdudW1iZXInKX1cbmAgKwogICAgYCR7aW5kZW50fSAgZm9yazogJHtvcHRzLnN0eWxpemUoY29yZS5mb3JrLCAnbnVtYmVyJyl9XG5gICsKICAgIGAke2luZGVudH0gIHNlc3Npb25zOiBbICR7b3B0cy5zdHlsaXplKGNvcmUuc2Vzc2lvbnMubGVuZ3RoLCAnbnVtYmVyJyl9IF1cbmAgKwogICAgYCR7aW5kZW50fSAgYWN0aXZlUmVxdWVzdHM6IFsgJHtvcHRzLnN0eWxpemUoY29yZS5hY3RpdmVSZXF1ZXN0cy5sZW5ndGgsICdudW1iZXInKX0gXVxuYCArCiAgICBgJHtpbmRlbnR9ICBwZWVyczogJHtwZWVyc31cbmAgKwogICAgYCR7aW5kZW50fSlgCiAgKQp9CgpmdW5jdGlvbiB0b0hleChidWYpIHsKICByZXR1cm4gYnVmICYmIGI0YS50b1N0cmluZyhidWYsICdoZXgnKQp9CmNvbnN0IGZsYXQgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKY29uc3QgY2FwcyA9IHJlcXVpcmUoJy4vY2FwcycpCmNvbnN0IHsKICBJTlZBTElEX1BST09GLAogIElOVkFMSURfQ0hFQ0tTVU0sCiAgSU5WQUxJRF9PUEVSQVRJT04sCiAgQkFEX0FSR1VNRU5ULAogIEFTU0VSVElPTgp9ID0gcmVxdWlyZSgnaHlwZXJjb3JlLWVycm9ycycpCgpjbGFzcyBOb2RlUXVldWUgewogIGNvbnN0cnVjdG9yKG5vZGVzLCBleHRyYSA9IG51bGwpIHsKICAgIHRoaXMuaSA9IDAKICAgIHRoaXMubm9kZXMgPSBub2RlcwogICAgdGhpcy5leHRyYSA9IGV4dHJhCiAgICB0aGlzLmxlbmd0aCA9IG5vZGVzLmxlbmd0aCArICh0aGlzLmV4dHJhID09PSBudWxsID8gMCA6IDEpCiAgfQoKICBzaGlmdChpbmRleCkgewogICAgaWYgKHRoaXMuZXh0cmEgIT09IG51bGwgJiYgdGhpcy5leHRyYS5pbmRleCA9PT0gaW5kZXgpIHsKICAgICAgY29uc3Qgbm9kZSA9IHRoaXMuZXh0cmEKICAgICAgdGhpcy5leHRyYSA9IG51bGwKICAgICAgdGhpcy5sZW5ndGgtLQogICAgICByZXR1cm4gbm9kZQogICAgfQoKICAgIGlmICh0aGlzLmkgPj0gdGhpcy5ub2Rlcy5sZW5ndGgpIHsKICAgICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0V4cGVjdGVkIG5vZGUgJyArIGluZGV4ICsgJywgZ290IChuaWwpJykKICAgIH0KCiAgICBjb25zdCBub2RlID0gdGhpcy5ub2Rlc1t0aGlzLmkrK10KICAgIGlmIChub2RlLmluZGV4ICE9PSBpbmRleCkgewogICAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTignRXhwZWN0ZWQgbm9kZSAnICsgaW5kZXggKyAnLCBnb3Qgbm9kZSAnICsgbm9kZS5pbmRleCkKICAgIH0KCiAgICB0aGlzLmxlbmd0aC0tCiAgICByZXR1cm4gbm9kZQogIH0KfQoKY2xhc3MgTWVya2xlVHJlZUJhdGNoIHsKICBjb25zdHJ1Y3RvcihzZXNzaW9uKSB7CiAgICB0aGlzLmZvcmsgPSBzZXNzaW9uLmZvcmsKICAgIHRoaXMucm9vdHMgPSBbLi4uc2Vzc2lvbi5yb290c10KICAgIHRoaXMubGVuZ3RoID0gc2Vzc2lvbi5sZW5ndGgKICAgIHRoaXMuc2lnbmF0dXJlID0gc2Vzc2lvbi5zaWduYXR1cmUKICAgIHRoaXMuYW5jZXN0b3JzID0gc2Vzc2lvbi5sZW5ndGgKICAgIHRoaXMuYnl0ZUxlbmd0aCA9IHNlc3Npb24uYnl0ZUxlbmd0aAogICAgdGhpcy5wcm9sb2d1ZSA9IHNlc3Npb24ucHJvbG9ndWUKICAgIHRoaXMuaGFzaENhY2hlZCA9IG51bGwKCiAgICB0aGlzLmNvbW1pdHRlZCA9IGZhbHNlCiAgICB0aGlzLnRydW5jYXRlZCA9IGZhbHNlCiAgICB0aGlzLnRyZWVMZW5ndGggPSBzZXNzaW9uLmxlbmd0aAogICAgdGhpcy50cmVlRm9yayA9IHNlc3Npb24uZm9yawogICAgdGhpcy5zdG9yYWdlID0gc2Vzc2lvbi5zdG9yYWdlCiAgICB0aGlzLnNlc3Npb24gPSBzZXNzaW9uCiAgICB0aGlzLm5vZGVzID0gW10KICAgIHRoaXMudXBncmFkZWQgPSBmYWxzZQogIH0KCiAgY2hlY2tvdXQobGVuZ3RoLCBhZGRpdGlvbmFsUm9vdHMpIHsKICAgIGNvbnN0IHJvb3RzID0gW10KICAgIGxldCByID0gMAoKICAgIGNvbnN0IGhlYWQgPSAyICogbGVuZ3RoIC0gMgogICAgY29uc3QgZ2FwcyA9IG5ldyBTZXQoKQogICAgY29uc3QgYWxsID0gbmV3IE1hcCgpCgogICAgLy8gYWRkaXRpb25hbCByb290cyBpcyBzbyB0aGUgb3JpZ2luYWwgcm9vdHMgY2FuIGJlIHBhc3NlZCAod2UgbXV0YXRlIHRoZSBhcnJheSBpbiBhcHBlbmRSb290KQogICAgaWYgKGFkZGl0aW9uYWxSb290cykgewogICAgICBmb3IgKGNvbnN0IG5vZGUgb2YgYWRkaXRpb25hbFJvb3RzKSBhbGwuc2V0KG5vZGUuaW5kZXgsIG5vZGUpCiAgICB9CgogICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMubm9kZXMpIGFsbC5zZXQobm9kZS5pbmRleCwgbm9kZSkKCiAgICBmb3IgKGNvbnN0IGluZGV4IG9mIGZsYXQuZnVsbFJvb3RzKGhlYWQgKyAyKSkgewogICAgICBjb25zdCBsZWZ0ID0gZmxhdC5sZWZ0U3BhbihpbmRleCkKICAgICAgaWYgKGxlZnQgIT09IDApIGdhcHMuYWRkKGxlZnQgLSAxKQoKICAgICAgaWYgKHIgPCB0aGlzLnJvb3RzLmxlbmd0aCAmJiB0aGlzLnJvb3RzW3JdLmluZGV4ID09PSBpbmRleCkgewogICAgICAgIHJvb3RzLnB1c2godGhpcy5yb290c1tyKytdKQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KICAgICAgY29uc3Qgbm9kZSA9IGFsbC5nZXQoaW5kZXgpCiAgICAgIGlmICghbm9kZSkgdGhyb3cgbmV3IEJBRF9BUkdVTUVOVCgncm9vdCBtaXNzaW5nIGZvciBnaXZlbiBsZW5ndGgnKQogICAgICByb290cy5wdXNoKG5vZGUpCiAgICB9CgogICAgdGhpcy5yb290cyA9IHJvb3RzCiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aAogICAgdGhpcy5ieXRlTGVuZ3RoID0gdG90YWxTaXplKHJvb3RzKQogICAgdGhpcy5oYXNoQ2FjaGVkID0gbnVsbAogICAgdGhpcy5zaWduYXR1cmUgPSBudWxsCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5ub2Rlc1tpXS5pbmRleAogICAgICBpZiAoaW5kZXggPD0gaGVhZCAmJiAhZ2Fwcy5oYXMoaW5kZXgpKSBjb250aW51ZQogICAgICBjb25zdCBsYXN0ID0gdGhpcy5ub2Rlcy5wb3AoKQogICAgICBpZiAoaSA8IHRoaXMubm9kZXMubGVuZ3RoKSB0aGlzLm5vZGVzW2ktLV0gPSBsYXN0CiAgICB9CiAgfQoKICBwcnVuZShsZW5ndGgpIHsKICAgIGlmIChsZW5ndGggPT09IDApIHJldHVybgoKICAgIGNvbnN0IGhlYWQgPSAyICogbGVuZ3RoIC0gMgogICAgY29uc3QgZ2FwcyA9IG5ldyBTZXQoKQoKICAgIC8vIFRPRE86IG1ha2UgYSBmdW5jdGlvbiBmb3IgdGhpcyBpbiBmbGF0LXRyZWUKICAgIGZvciAoY29uc3QgaW5kZXggb2YgZmxhdC5mdWxsUm9vdHMoaGVhZCArIDIpKSB7CiAgICAgIGNvbnN0IGxlZnQgPSBmbGF0LmxlZnRTcGFuKGluZGV4KQogICAgICBpZiAobGVmdCAhPT0gMCkgZ2Fwcy5hZGQobGVmdCAtIDEpCiAgICB9CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5ub2Rlc1tpXS5pbmRleAogICAgICBpZiAoaW5kZXggPiBoZWFkIHx8IGdhcHMuaGFzKGluZGV4KSkgY29udGludWUKICAgICAgY29uc3QgbGFzdCA9IHRoaXMubm9kZXMucG9wKCkKICAgICAgaWYgKGkgPCB0aGlzLm5vZGVzLmxlbmd0aCkgdGhpcy5ub2Rlc1tpLS1dID0gbGFzdAogICAgfQogIH0KCiAgY2xvbmUoKSB7CiAgICBjb25zdCBiID0gbmV3IE1lcmtsZVRyZWVCYXRjaCh0aGlzLnNlc3Npb24pCgogICAgYi5mb3JrID0gdGhpcy5mb3JrCiAgICBiLnJvb3RzID0gWy4uLnRoaXMucm9vdHNdCiAgICBiLmxlbmd0aCA9IHRoaXMubGVuZ3RoCiAgICBiLmJ5dGVMZW5ndGggPSB0aGlzLmJ5dGVMZW5ndGgKICAgIGIuc2lnbmF0dXJlID0gdGhpcy5zaWduYXR1cmUKICAgIGIudHJlZUxlbmd0aCA9IHRoaXMudHJlZUxlbmd0aAogICAgYi50cmVlRm9yayA9IHRoaXMudHJlZUZvcmsKICAgIGIudHJlZSA9IHRoaXMudHJlZQogICAgYi5ub2RlcyA9IFsuLi50aGlzLm5vZGVzXQogICAgYi51cGdyYWRlZCA9IHRoaXMudXBncmFkZWQKCiAgICByZXR1cm4gYgogIH0KCiAgaGFzaCgpIHsKICAgIGlmICh0aGlzLmhhc2hDYWNoZWQgPT09IG51bGwpIHRoaXMuaGFzaENhY2hlZCA9IHVuc2xhYihjcnlwdG8udHJlZSh0aGlzLnJvb3RzKSkKICAgIHJldHVybiB0aGlzLmhhc2hDYWNoZWQKICB9CgogIHNpZ25hYmxlKG1hbmlmZXN0SGFzaCkgewogICAgcmV0dXJuIGNhcHMudHJlZVNpZ25hYmxlKG1hbmlmZXN0SGFzaCwgdGhpcy5oYXNoKCksIHRoaXMubGVuZ3RoLCB0aGlzLmZvcmspCiAgfQoKICBzaWduYWJsZUNvbXBhdChub0hlYWRlcikgewogICAgcmV0dXJuIGNhcHMudHJlZVNpZ25hYmxlQ29tcGF0KHRoaXMuaGFzaCgpLCB0aGlzLmxlbmd0aCwgdGhpcy5mb3JrLCBub0hlYWRlcikKICB9CgogIGdldChpbmRleCkgewogICAgaWYgKGluZGV4ID49IHRoaXMubGVuZ3RoICogMikgewogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGZvciAoY29uc3QgbiBvZiB0aGlzLm5vZGVzKSB7CiAgICAgIGlmIChuLmluZGV4ID09PSBpbmRleCkgcmV0dXJuIG4KICAgIH0KCiAgICByZXR1cm4gZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZSh0aGlzLnNlc3Npb24uc3RvcmFnZSwgaW5kZXgpCiAgfQoKICAvLyBkZXByZWNhdGVkLCB1c2Ugc3NzaW9uIHByb29mIGluc3RlYWQKICBwcm9vZihiYXRjaCwgeyBibG9jaywgaGFzaCwgc2VlaywgdXBncmFkZSB9KSB7CiAgICByZXR1cm4gZ2VuZXJhdGVQcm9vZih0aGlzLnNlc3Npb24sIGJhdGNoLCBibG9jaywgaGFzaCwgc2VlaywgdXBncmFkZSkKICB9CgogIHZlcmlmeVVwZ3JhZGUocHJvb2YpIHsKICAgIGNvbnN0IHVudmVyaWZpZWQgPSB2ZXJpZnlUcmVlKHByb29mLCB0aGlzLm5vZGVzKQoKICAgIGlmICghcHJvb2YudXBncmFkZSkgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0V4cGVjdGVkIHVwZ3JhZGUgcHJvb2YnKQoKICAgIHJldHVybiB2ZXJpZnlVcGdyYWRlKHByb29mLCB1bnZlcmlmaWVkLCB0aGlzKQogIH0KCiAgYWRkTm9kZXNVbnNhZmUobm9kZXMpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgdGhpcy5ub2Rlcy5wdXNoKG5vZGVzW2ldKQogICAgfQogIH0KCiAgYXBwZW5kKGJ1ZikgewogICAgY29uc3QgaGVhZCA9IHRoaXMubGVuZ3RoICogMgogICAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihoZWFkKQogICAgY29uc3Qgbm9kZSA9IGJsb2NrTm9kZShoZWFkLCBidWYpCgogICAgdGhpcy5hcHBlbmRSb290KG5vZGUsIGl0ZSkKICB9CgogIGFwcGVuZFJvb3Qobm9kZSwgaXRlKSB7CiAgICBub2RlID0gdW5zbGFiTm9kZShub2RlKQogICAgdGhpcy5oYXNoQ2FjaGVkID0gbnVsbAogICAgdGhpcy51cGdyYWRlZCA9IHRydWUKICAgIHRoaXMubGVuZ3RoICs9IGl0ZS5mYWN0b3IgLyAyCiAgICB0aGlzLmJ5dGVMZW5ndGggKz0gbm9kZS5zaXplCiAgICB0aGlzLnJvb3RzLnB1c2gobm9kZSkKICAgIHRoaXMubm9kZXMucHVzaChub2RlKQoKICAgIHdoaWxlICh0aGlzLnJvb3RzLmxlbmd0aCA+IDEpIHsKICAgICAgY29uc3QgYSA9IHRoaXMucm9vdHNbdGhpcy5yb290cy5sZW5ndGggLSAxXQogICAgICBjb25zdCBiID0gdGhpcy5yb290c1t0aGlzLnJvb3RzLmxlbmd0aCAtIDJdCgogICAgICAvLyBUT0RPOiBqdXN0IGhhdmUgYSBwZWVrIHNpYmxpbmcgaW5zdGVhZD8gKHByZXR0eSBzdXJlIGl0J3MgYWx3YXlzIHRoZSBsZWZ0IHNpYiBhcyB3ZWxsKQogICAgICBpZiAoaXRlLnNpYmxpbmcoKSAhPT0gYi5pbmRleCkgewogICAgICAgIGl0ZS5zaWJsaW5nKCkgLy8gdW5zZXQgc28gaXQgYWx3YXlzIHBvaW50cyB0byBsYXN0IHJvb3QKICAgICAgICBicmVhawogICAgICB9CgogICAgICBjb25zdCBub2RlID0gdW5zbGFiTm9kZShwYXJlbnROb2RlKGl0ZS5wYXJlbnQoKSwgYSwgYikpCiAgICAgIHRoaXMubm9kZXMucHVzaChub2RlKQogICAgICB0aGlzLnJvb3RzLnBvcCgpCiAgICAgIHRoaXMucm9vdHMucG9wKCkKICAgICAgdGhpcy5yb290cy5wdXNoKG5vZGUpCiAgICB9CiAgfQoKICBjb21taXRhYmxlKCkgewogICAgcmV0dXJuICgKICAgICAgdGhpcy50cmVlRm9yayA9PT0gdGhpcy5zZXNzaW9uLmZvcmsgJiYKICAgICAgKHRoaXMudXBncmFkZWQKICAgICAgICA/IHRoaXMudHJlZUxlbmd0aCA9PT0gdGhpcy5zZXNzaW9uLmxlbmd0aAogICAgICAgIDogdGhpcy50cmVlTGVuZ3RoIDw9IHRoaXMuc2Vzc2lvbi5sZW5ndGgpCiAgICApCiAgfQoKICBjb21taXQodHgpIHsKICAgIGlmICh0eCA9PT0gdW5kZWZpbmVkKSB0aHJvdyBJTlZBTElEX09QRVJBVElPTignTm8gZGF0YWJhc2UgYmF0Y2ggd2FzIHBhc3NlZCcpCiAgICBpZiAoIXRoaXMuY29tbWl0YWJsZSgpKSB7CiAgICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdUcmVlIHdhcyBtb2RpZmllZCBkdXJpbmcgYmF0Y2gsIHJlZnVzaW5nIHRvIGNvbW1pdCcpCiAgICB9CgogICAgaWYgKHRoaXMudXBncmFkZWQpIHRoaXMuX2NvbW1pdFVwZ3JhZGUodHgpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGVzW2ldCiAgICAgIHR4LnB1dFRyZWVOb2RlKG5vZGUpCiAgICB9CgogICAgdGhpcy5jb21taXR0ZWQgPSB0cnVlCgogICAgcmV0dXJuIHRoaXMKICB9CgogIF9jb21taXRVcGdyYWRlKHR4KSB7CiAgICAvLyBUT0RPOiBJZiBlYXN5IHRvIGRldGVjdCwgd2Ugc2hvdWxkIHJlZnVzZSBhbiB0cnVuYythcHBlbmQgaGVyZSB3aXRob3V0IGEgZm9yayBpZAogICAgLy8gY2hhbmdlLiBXaWxsIG9ubHkgaGFwcGVuIG9uIHVzZXIgZXJyb3Igc28gbW9zdGx5IHRvIHByZXZlbnQgdGhhdC4KCiAgICBpZiAodGhpcy5hbmNlc3RvcnMgPCB0aGlzLnRyZWVMZW5ndGgpIHsKICAgICAgdHguZGVsZXRlVHJlZU5vZGVSYW5nZSh0aGlzLmFuY2VzdG9ycyAqIDIsIHRoaXMudHJlZUxlbmd0aCAqIDIpCgogICAgICBpZiAodGhpcy5hbmNlc3RvcnMgPiAwKSB7CiAgICAgICAgY29uc3QgaGVhZCA9IHRoaXMuYW5jZXN0b3JzICogMgogICAgICAgIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IoaGVhZCAtIDIpCgogICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICBpZiAoaXRlLmNvbnRhaW5zKGhlYWQpICYmIGl0ZS5pbmRleCA8IGhlYWQpIHsKICAgICAgICAgICAgdHguZGVsZXRlVHJlZU5vZGUoaXRlLmluZGV4KQogICAgICAgICAgfQogICAgICAgICAgaWYgKGl0ZS5vZmZzZXQgPT09IDApIGJyZWFrCiAgICAgICAgICBpdGUucGFyZW50KCkKICAgICAgICB9CgogICAgICAgIHRoaXMudHJ1bmNhdGVkID0gdHJ1ZQogICAgICB9CiAgICB9CiAgfQoKICBzZWVrKGJ5dGVzLCBwYWRkaW5nKSB7CiAgICByZXR1cm4gbmV3IEJ5dGVTZWVrZXIodGhpcywgdGhpcywgYnl0ZXMsIHBhZGRpbmcpCiAgfQoKICBieXRlUmFuZ2UoaW5kZXgpIHsKICAgIGNvbnN0IHJ4ID0gdGhpcy5zdG9yYWdlLnJlYWQoKQogICAgY29uc3QgcmFuZ2UgPSBnZXRCeXRlUmFuZ2UodGhpcywgaW5kZXgsIHJ4KQogICAgcngudHJ5Rmx1c2goKQoKICAgIHJldHVybiByYW5nZQogIH0KCiAgYnl0ZU9mZnNldChpbmRleCkgewogICAgaWYgKGluZGV4ID09PSAyICogdGhpcy5sZW5ndGgpIHJldHVybiB0aGlzLmJ5dGVMZW5ndGgKCiAgICBjb25zdCByeCA9IHRoaXMuc3RvcmFnZS5yZWFkKCkKICAgIGNvbnN0IG9mZnNldCA9IGdldEJ5dGVPZmZzZXQodGhpcywgaW5kZXgsIHJ4KQogICAgcngudHJ5Rmx1c2goKQoKICAgIHJldHVybiBvZmZzZXQKICB9CgogIGFzeW5jIGRvd25ncmFkZSgpIHsKICAgIGlmICghdGhpcy51cGdyYWRlZCkgcmV0dXJuIHRydWUKCiAgICBjb25zdCByeCA9IHRoaXMuc3RvcmFnZS5yZWFkKCkKICAgIGNvbnN0IG5vZGVQcm9taXNlcyA9IFtdCgogICAgZm9yIChjb25zdCByIG9mIHRoaXMucm9vdHMpIHsKICAgICAgbm9kZVByb21pc2VzLnB1c2gocnguZ2V0VHJlZU5vZGUoci5pbmRleCkpCiAgICB9CgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IG5vZGVzID0gYXdhaXQgUHJvbWlzZS5hbGwobm9kZVByb21pc2VzKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5yb290cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCByb290ID0gdGhpcy5yb290c1tpXQogICAgICBjb25zdCBub2RlID0gbm9kZXNbaV0KCiAgICAgIGlmICghbm9kZSkgcmV0dXJuIGZhbHNlCiAgICAgIGlmICghYjRhLmVxdWFscyhub2RlLmhhc2gsIHJvb3QuaGFzaCkpIHJldHVybiBmYWxzZQogICAgfQoKICAgIHRoaXMudXBncmFkZWQgPSBmYWxzZQogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIHJlc3RvcmUobGVuZ3RoKSB7CiAgICBpZiAobGVuZ3RoID09PSB0aGlzLmxlbmd0aCkgcmV0dXJuIHRoaXMKCiAgICBjb25zdCByb290cyA9IHVuc2xhYk5vZGVzKGF3YWl0IE1lcmtsZVRyZWUuZ2V0Um9vdHNGcm9tU3RvcmFnZSh0aGlzLnN0b3JhZ2UsIGxlbmd0aCkpCgogICAgdGhpcy5yb290cyA9IHJvb3RzCiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aAogICAgdGhpcy5ieXRlTGVuZ3RoID0gdG90YWxTaXplKHJvb3RzKQogICAgdGhpcy5hbmNlc3RvcnMgPSBsZW5ndGgKCiAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygcm9vdHMpIHRoaXMuYnl0ZUxlbmd0aCArPSBub2RlLnNpemUKCiAgICByZXR1cm4gdGhpcwogIH0KfQoKY2xhc3MgUmVvcmdCYXRjaCBleHRlbmRzIE1lcmtsZVRyZWVCYXRjaCB7CiAgY29uc3RydWN0b3Ioc2Vzc2lvbikgewogICAgc3VwZXIoc2Vzc2lvbikKCiAgICB0aGlzLnJvb3RzID0gW10KICAgIHRoaXMubGVuZ3RoID0gMAogICAgdGhpcy5ieXRlTGVuZ3RoID0gMAogICAgdGhpcy5kaWZmID0gbnVsbAogICAgdGhpcy5hbmNlc3RvcnMgPSAwCiAgICAvLyBXZSBzZXQgdXBncmFkZWQgYmVjYXVzZSByZW9yZ3MgYXJlIHNpZ25lZCBzbyBoaXQgd2lsbAogICAgLy8gaGl0IHRoZSBzYW1lIGNvZGUgcGF0aHMgKGxpa2UgdGhlIHRyZWVMZW5ndGggY2hlY2sgaW4gY29tbWl0KQogICAgdGhpcy51cGdyYWRlZCA9IHRydWUKICAgIHRoaXMud2FudCA9IHsKICAgICAgbm9kZXM6IDAsCiAgICAgIHN0YXJ0OiAwLAogICAgICBlbmQ6IDAKICAgIH0KICB9CgogIGdldCBmaW5pc2hlZCgpIHsKICAgIHJldHVybiB0aGlzLndhbnQgPT09IG51bGwKICB9CgogIHVwZGF0ZShwcm9vZikgewogICAgaWYgKHRoaXMud2FudCA9PT0gbnVsbCkgcmV0dXJuIHRydWUKCiAgICBjb25zdCBub2RlcyA9IFtdCiAgICBjb25zdCByb290ID0gdmVyaWZ5VHJlZShwcm9vZiwgbm9kZXMpCgogICAgaWYgKHJvb3QgPT09IG51bGwgfHwgIWI0YS5lcXVhbHMocm9vdC5oYXNoLCB0aGlzLmRpZmYuaGFzaCkpIHJldHVybiBmYWxzZQoKICAgIHRoaXMubm9kZXMucHVzaCguLi5ub2RlcykKICAgIHJldHVybiB0aGlzLl91cGRhdGUobm9kZXMpCiAgfQoKICBhc3luYyBfdXBkYXRlKG5vZGVzKSB7CiAgICBjb25zdCBuID0gbmV3IE1hcCgpCiAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIG4uc2V0KG5vZGUuaW5kZXgsIG5vZGUpCgogICAgbGV0IGRpZmYgPSBudWxsCiAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKHRoaXMuZGlmZi5pbmRleCkKICAgIGNvbnN0IHN0YXJ0aW5nRGlmZiA9IHRoaXMuZGlmZgoKICAgIHdoaWxlICgoaXRlLmluZGV4ICYgMSkgIT09IDApIHsKICAgICAgY29uc3QgbGVmdCA9IG4uZ2V0KGl0ZS5sZWZ0Q2hpbGQoKSkKICAgICAgaWYgKCFsZWZ0KSBicmVhawoKICAgICAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCBnZXRUcmVlTm9kZUZyb21TdG9yYWdlKHRoaXMuc2Vzc2lvbi5zdG9yYWdlLCBsZWZ0LmluZGV4KQogICAgICBpZiAoIWV4aXN0aW5nIHx8ICFiNGEuZXF1YWxzKGV4aXN0aW5nLmhhc2gsIGxlZnQuaGFzaCkpIHsKICAgICAgICBkaWZmID0gbGVmdAogICAgICB9IGVsc2UgewogICAgICAgIGRpZmYgPSBuLmdldChpdGUuc2libGluZygpKQogICAgICB9CiAgICB9CgogICAgaWYgKCh0aGlzLmRpZmYuaW5kZXggJiAxKSA9PT0gMCkgcmV0dXJuIHRydWUKICAgIGlmIChkaWZmID09PSBudWxsKSByZXR1cm4gZmFsc2UKICAgIGlmIChzdGFydGluZ0RpZmYgIT09IHRoaXMuZGlmZikgcmV0dXJuIGZhbHNlCgogICAgcmV0dXJuIHRoaXMuX3VwZGF0ZURpZmZSb290KGRpZmYpCiAgfQoKICBfdXBkYXRlRGlmZlJvb3QoZGlmZikgewogICAgaWYgKHRoaXMud2FudCA9PT0gbnVsbCkgcmV0dXJuIHRydWUKCiAgICBjb25zdCBzcGFucyA9IGZsYXQuc3BhbnMoZGlmZi5pbmRleCkKICAgIGNvbnN0IHN0YXJ0ID0gc3BhbnNbMF0gLyAyCiAgICBjb25zdCBlbmQgPSBNYXRoLm1pbih0aGlzLnRyZWVMZW5ndGgsIHNwYW5zWzFdIC8gMiArIDEpCiAgICBjb25zdCBsZW4gPSBlbmQgLSBzdGFydAoKICAgIHRoaXMuYW5jZXN0b3JzID0gc3RhcnQKICAgIHRoaXMuZGlmZiA9IGRpZmYKCiAgICBpZiAoKGRpZmYuaW5kZXggJiAxKSA9PT0gMCB8fCB0aGlzLndhbnQuc3RhcnQgPj0gdGhpcy50cmVlTGVuZ3RoIHx8IGxlbiA8PSAwKSB7CiAgICAgIHRoaXMud2FudCA9IG51bGwKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICB0aGlzLndhbnQuc3RhcnQgPSBzdGFydAogICAgdGhpcy53YW50LmVuZCA9IGVuZAogICAgdGhpcy53YW50Lm5vZGVzID0gbG9nMihzcGFuc1sxXSAtIHNwYW5zWzBdICsgMikgLSAxCgogICAgcmV0dXJuIGZhbHNlCiAgfQp9CgpjbGFzcyBCeXRlU2Vla2VyIHsKICBjb25zdHJ1Y3RvcihzZXNzaW9uLCBieXRlcywgcGFkZGluZyA9IDApIHsKICAgIHRoaXMuc2Vzc2lvbiA9IHNlc3Npb24KICAgIHRoaXMuYnl0ZXMgPSBieXRlcwogICAgdGhpcy5wYWRkaW5nID0gcGFkZGluZwoKICAgIGNvbnN0IHNpemUgPSBzZXNzaW9uLmJ5dGVMZW5ndGggLSBzZXNzaW9uLmxlbmd0aCAqIHBhZGRpbmcKCiAgICB0aGlzLnN0YXJ0ID0gYnl0ZXMgPj0gc2l6ZSA/IHNlc3Npb24ubGVuZ3RoIDogMAogICAgdGhpcy5lbmQgPSBieXRlcyA8IHNpemUgPyBzZXNzaW9uLmxlbmd0aCA6IDAKICB9CgogIGFzeW5jIF9zZWVrKGJ5dGVzKSB7CiAgICBpZiAoIWJ5dGVzKSByZXR1cm4gWzAsIDBdCgogICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMuc2Vzc2lvbi5yb290cykgewogICAgICAvLyBhbGwgYXN5bmMgdGlja3MgaGFwcGVuIG9uY2Ugd2UgZmluZCB0aGUgcm9vdCBzbyBzYWZlCiAgICAgIGNvbnN0IHNpemUgPSBnZXRVbnBhZGRlZFNpemUobm9kZSwgdGhpcy5wYWRkaW5nLCBudWxsKQoKICAgICAgaWYgKGJ5dGVzID09PSBzaXplKSByZXR1cm4gW2ZsYXQucmlnaHRTcGFuKG5vZGUuaW5kZXgpICsgMiwgMF0KICAgICAgaWYgKGJ5dGVzID4gc2l6ZSkgewogICAgICAgIGJ5dGVzIC09IHNpemUKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKG5vZGUuaW5kZXgpCgogICAgICB3aGlsZSAoKGl0ZS5pbmRleCAmIDEpICE9PSAwKSB7CiAgICAgICAgY29uc3QgbCA9IGF3YWl0IGdldFRyZWVOb2RlRnJvbVN0b3JhZ2UodGhpcy5zZXNzaW9uLnN0b3JhZ2UsIGl0ZS5sZWZ0Q2hpbGQoKSkKCiAgICAgICAgaWYgKGwpIHsKICAgICAgICAgIGNvbnN0IHNpemUgPSBnZXRVbnBhZGRlZFNpemUobCwgdGhpcy5wYWRkaW5nLCBpdGUpCgogICAgICAgICAgaWYgKHNpemUgPT09IGJ5dGVzKSByZXR1cm4gW2l0ZS5yaWdodFNwYW4oKSArIDIsIDBdCiAgICAgICAgICBpZiAoc2l6ZSA+IGJ5dGVzKSBjb250aW51ZQogICAgICAgICAgYnl0ZXMgLT0gc2l6ZQogICAgICAgICAgaXRlLnNpYmxpbmcoKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpdGUucGFyZW50KCkKICAgICAgICAgIHJldHVybiBbaXRlLmluZGV4LCBieXRlc10KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBbaXRlLmluZGV4LCBieXRlc10KICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgYXN5bmMgdXBkYXRlKCkgewogICAgLy8gVE9ETzogY29tYmluZSBfc2VlayBhbmQgdGhpcywgbXVjaCBzaW1wbGVyCiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLl9zZWVrKHRoaXMuYnl0ZXMpCiAgICBpZiAoIXJlcykgcmV0dXJuIG51bGwKICAgIGlmICgocmVzWzBdICYgMSkgPT09IDApIHJldHVybiBbcmVzWzBdIC8gMiwgcmVzWzFdXQoKICAgIGNvbnN0IHNwYW4gPSBmbGF0LnNwYW5zKHJlc1swXSkKICAgIHRoaXMuc3RhcnQgPSBzcGFuWzBdIC8gMgogICAgdGhpcy5lbmQgPSBzcGFuWzFdIC8gMiArIDEKCiAgICByZXR1cm4gbnVsbAogIH0KfQoKY2xhc3MgVHJlZVByb29mIHsKICBjb25zdHJ1Y3RvcihzZXNzaW9uLCBibG9jaywgaGFzaCwgc2VlaywgdXBncmFkZSkgewogICAgdGhpcy5mb3JrID0gc2Vzc2lvbi5mb3JrCiAgICB0aGlzLnNpZ25hdHVyZSA9IHNlc3Npb24uc2lnbmF0dXJlCgogICAgdGhpcy5ibG9jayA9IGJsb2NrCiAgICB0aGlzLmhhc2ggPSBoYXNoCiAgICB0aGlzLnNlZWsgPSBzZWVrCiAgICB0aGlzLnVwZ3JhZGUgPSB1cGdyYWRlCgogICAgdGhpcy5wZW5kaW5nID0gewogICAgICBub2RlOiBudWxsLAogICAgICBzZWVrOiBudWxsLAogICAgICB1cGdyYWRlOiBudWxsLAogICAgICBhZGRpdGlvbmFsVXBncmFkZTogbnVsbAogICAgfQogIH0KCiAgYXN5bmMgc2V0dGxlKCkgewogICAgY29uc3QgcmVzdWx0ID0gewogICAgICBmb3JrOiB0aGlzLmZvcmssCiAgICAgIGJsb2NrOiBudWxsLAogICAgICBoYXNoOiBudWxsLAogICAgICBzZWVrOiBudWxsLAogICAgICB1cGdyYWRlOiBudWxsLAogICAgICBtYW5pZmVzdDogbnVsbAogICAgfQoKICAgIGNvbnN0IFtwTm9kZSwgcFNlZWssIHBVcGdyYWRlLCBwQWRkaXRpb25hbF0gPSBhd2FpdCBzZXR0bGVQcm9vZih0aGlzLnBlbmRpbmcpCgogICAgaWYgKHRoaXMuYmxvY2spIHsKICAgICAgaWYgKHBOb2RlID09PSBudWxsKSB0aHJvdyBJTlZBTElEX09QRVJBVElPTignSW52YWxpZCBibG9jayByZXF1ZXN0JykKICAgICAgcmVzdWx0LmJsb2NrID0gewogICAgICAgIGluZGV4OiB0aGlzLmJsb2NrLmluZGV4LAogICAgICAgIHZhbHVlOiBudWxsLCAvLyBwb3B1bGF0ZWQgdXBzdHJlYW0sIGFsbG9jIGl0IGhlcmUgZm9yIHNpbXBsaWNpdHkKICAgICAgICBub2RlczogcE5vZGUKICAgICAgfQogICAgfSBlbHNlIGlmICh0aGlzLmhhc2gpIHsKICAgICAgaWYgKHBOb2RlID09PSBudWxsKSB0aHJvdyBJTlZBTElEX09QRVJBVElPTignSW52YWxpZCBibG9jayByZXF1ZXN0JykKICAgICAgcmVzdWx0Lmhhc2ggPSB7CiAgICAgICAgaW5kZXg6IHRoaXMuaGFzaC5pbmRleCwKICAgICAgICBub2RlczogcE5vZGUKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLnNlZWsgJiYgcFNlZWsgIT09IG51bGwpIHsKICAgICAgcmVzdWx0LnNlZWsgPSB7CiAgICAgICAgYnl0ZXM6IHRoaXMuc2Vlay5ieXRlcywKICAgICAgICBub2RlczogcFNlZWsKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLnVwZ3JhZGUpIHsKICAgICAgcmVzdWx0LnVwZ3JhZGUgPSB7CiAgICAgICAgc3RhcnQ6IHRoaXMudXBncmFkZS5zdGFydCwKICAgICAgICBsZW5ndGg6IHRoaXMudXBncmFkZS5sZW5ndGgsCiAgICAgICAgbm9kZXM6IHBVcGdyYWRlLAogICAgICAgIGFkZGl0aW9uYWxOb2RlczogcEFkZGl0aW9uYWwgfHwgW10sCiAgICAgICAgc2lnbmF0dXJlOiB0aGlzLnNpZ25hdHVyZQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdAogIH0KfQoKY2xhc3MgTWVya2xlVHJlZSB7CiAgc3RhdGljIGhhc2gocykgewogICAgcmV0dXJuIHVuc2xhYihjcnlwdG8udHJlZShzLnJvb3RzKSkKICB9CgogIHN0YXRpYyBzaWduYWJsZShzLCBuYW1lc3BhY2UpIHsKICAgIHJldHVybiBjYXBzLnRyZWVTaWduYWJsZShuYW1lc3BhY2UsIE1lcmtsZVRyZWUuaGFzaChzKSwgcy5sZW5ndGgsIHMuZm9yaykKICB9CgogIHN0YXRpYyBzaXplKHJvb3RzKSB7CiAgICByZXR1cm4gdG90YWxTaXplKHJvb3RzKQogIH0KCiAgc3RhdGljIHNwYW4ocm9vdHMpIHsKICAgIHJldHVybiB0b3RhbFNwYW4ocm9vdHMpCiAgfQoKICBzdGF0aWMgZ2V0Um9vdHMoc2Vzc2lvbiwgbGVuZ3RoKSB7CiAgICByZXR1cm4gTWVya2xlVHJlZS5nZXRSb290c0Zyb21TdG9yYWdlKHNlc3Npb24uc3RvcmFnZSwgbGVuZ3RoKQogIH0KCiAgc3RhdGljIGdldFJvb3RzRnJvbVN0b3JhZ2Uoc3RvcmFnZSwgbGVuZ3RoKSB7CiAgICBjb25zdCBpbmRleGVzID0gZmxhdC5mdWxsUm9vdHMoMiAqIGxlbmd0aCkKICAgIGNvbnN0IHJvb3RzID0gbmV3IEFycmF5KGluZGV4ZXMubGVuZ3RoKQogICAgY29uc3QgcnggPSBzdG9yYWdlLnJlYWQoKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXhlcy5sZW5ndGg7IGkrKykgewogICAgICByb290c1tpXSA9IGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaW5kZXhlc1tpXSkKICAgIH0KCiAgICByeC50cnlGbHVzaCgpCgogICAgcmV0dXJuIFByb21pc2UuYWxsKHJvb3RzKQogIH0KCiAgc3RhdGljIGFzeW5jIHVwZ3JhZGVhYmxlKHNlc3Npb24sIGxlbmd0aCkgewogICAgY29uc3QgaW5kZXhlcyA9IGZsYXQuZnVsbFJvb3RzKDIgKiBsZW5ndGgpCiAgICBjb25zdCByb290cyA9IG5ldyBBcnJheShpbmRleGVzLmxlbmd0aCkKICAgIGNvbnN0IHJ4ID0gc2Vzc2lvbi5zdG9yYWdlLnJlYWQoKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXhlcy5sZW5ndGg7IGkrKykgewogICAgICByb290c1tpXSA9IHJ4LmdldFRyZWVOb2RlKGluZGV4ZXNbaV0pCiAgICB9CgogICAgcngudHJ5Rmx1c2goKQoKICAgIGZvciAoY29uc3Qgbm9kZSBvZiBhd2FpdCBQcm9taXNlLmFsbChyb290cykpIHsKICAgICAgaWYgKG5vZGUgPT09IG51bGwpIHJldHVybiBmYWxzZQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBzdGF0aWMgc2VlayhzZXNzaW9uLCBieXRlcywgcGFkZGluZykgewogICAgcmV0dXJuIG5ldyBCeXRlU2Vla2VyKHNlc3Npb24sIGJ5dGVzLCBwYWRkaW5nKQogIH0KCiAgc3RhdGljIGdldChzZXNzaW9uLCBpbmRleCkgewogICAgcmV0dXJuIGdldFRyZWVOb2RlRnJvbVN0b3JhZ2Uoc2Vzc2lvbi5zdG9yYWdlLCBpbmRleCkKICB9CgogIHN0YXRpYyBhc3luYyB0cnVuY2F0ZShzZXNzaW9uLCBsZW5ndGgsIGJhdGNoLCBmb3JrID0gYmF0Y2guZm9yaykgewogICAgY29uc3QgaGVhZCA9IGxlbmd0aCAqIDIKICAgIGNvbnN0IGZ1bGxSb290cyA9IGZsYXQuZnVsbFJvb3RzKGhlYWQpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmdWxsUm9vdHMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qgcm9vdCA9IGZ1bGxSb290c1tpXQogICAgICBpZiAoaSA8IGJhdGNoLnJvb3RzLmxlbmd0aCAmJiBiYXRjaC5yb290c1tpXS5pbmRleCA9PT0gcm9vdCkgY29udGludWUKCiAgICAgIHdoaWxlIChiYXRjaC5yb290cy5sZW5ndGggPiBpKSBiYXRjaC5yb290cy5wb3AoKQogICAgICBiYXRjaC5yb290cy5wdXNoKHVuc2xhYk5vZGUoYXdhaXQgZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZU9yRXJyb3Ioc2Vzc2lvbi5zdG9yYWdlLCByb290KSkpCiAgICB9CgogICAgd2hpbGUgKGJhdGNoLnJvb3RzLmxlbmd0aCA+IGZ1bGxSb290cy5sZW5ndGgpIHsKICAgICAgYmF0Y2gucm9vdHMucG9wKCkKICAgIH0KCiAgICBiYXRjaC5mb3JrID0gZm9yawogICAgYmF0Y2gubGVuZ3RoID0gbGVuZ3RoCiAgICBiYXRjaC5hbmNlc3RvcnMgPSBsZW5ndGgKICAgIGJhdGNoLmJ5dGVMZW5ndGggPSB0b3RhbFNpemUoYmF0Y2gucm9vdHMpCiAgICBiYXRjaC51cGdyYWRlZCA9IHRydWUKCiAgICByZXR1cm4gYmF0Y2gKICB9CgogIHN0YXRpYyBhc3luYyByZW9yZyhzZXNzaW9uLCBwcm9vZiwgYmF0Y2gpIHsKICAgIGxldCB1bnZlcmlmaWVkID0gbnVsbAoKICAgIGlmIChwcm9vZi5ibG9jayB8fCBwcm9vZi5oYXNoIHx8IHByb29mLnNlZWspIHsKICAgICAgdW52ZXJpZmllZCA9IHZlcmlmeVRyZWUocHJvb2YsIGJhdGNoLm5vZGVzKQogICAgfQoKICAgIGlmICghdmVyaWZ5VXBncmFkZShwcm9vZiwgdW52ZXJpZmllZCwgYmF0Y2gpKSB7CiAgICAgIHRocm93IElOVkFMSURfUFJPT0YoJ0ZvcmsgcHJvb2Ygbm90IHZlcmlmaWFibGUnKQogICAgfQoKICAgIGZvciAoY29uc3Qgcm9vdCBvZiBiYXRjaC5yb290cykgewogICAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IGdldFRyZWVOb2RlRnJvbVN0b3JhZ2Uoc2Vzc2lvbi5zdG9yYWdlLCByb290LmluZGV4KQogICAgICBpZiAoZXhpc3RpbmcgJiYgYjRhLmVxdWFscyhleGlzdGluZy5oYXNoLCByb290Lmhhc2gpKSBjb250aW51ZQogICAgICBiYXRjaC5fdXBkYXRlRGlmZlJvb3Qocm9vdCkKICAgICAgYnJlYWsKICAgIH0KCiAgICBpZiAoYmF0Y2guZGlmZiAhPT0gbnVsbCkgewogICAgICBhd2FpdCBiYXRjaC5fdXBkYXRlKGJhdGNoLm5vZGVzKQogICAgfSBlbHNlIHsKICAgICAgYmF0Y2gud2FudCA9IG51bGwKICAgICAgYmF0Y2guYW5jZXN0b3JzID0gYmF0Y2gubGVuZ3RoCiAgICB9CgogICAgcmV0dXJuIGJhdGNoCiAgfQoKICBzdGF0aWMgdmVyaWZ5RnVsbHlSZW1vdGUoc2Vzc2lvbiwgcHJvb2YpIHsKICAgIC8vIFRPRE86IGltcGwgdGhpcyBsZXNzIGhhY2tpc2hseQogICAgY29uc3QgYmF0Y2ggPSBuZXcgTWVya2xlVHJlZUJhdGNoKHNlc3Npb24pCgogICAgYmF0Y2guZm9yayA9IHByb29mLmZvcmsKICAgIGJhdGNoLnJvb3RzID0gW10KICAgIGJhdGNoLmxlbmd0aCA9IDAKICAgIGJhdGNoLmFuY2VzdG9ycyA9IDAKICAgIGJhdGNoLmJ5dGVMZW5ndGggPSAwCgogICAgbGV0IHVudmVyaWZpZWQgPSB2ZXJpZnlUcmVlKHByb29mLCBiYXRjaC5ub2RlcykKCiAgICBpZiAocHJvb2YudXBncmFkZSkgewogICAgICBpZiAodmVyaWZ5VXBncmFkZShwcm9vZiwgdW52ZXJpZmllZCwgYmF0Y2gpKSB7CiAgICAgICAgdW52ZXJpZmllZCA9IG51bGwKICAgICAgfQogICAgfQoKICAgIHJldHVybiBiYXRjaAogIH0KCiAgc3RhdGljIGFzeW5jIHZlcmlmeShzZXNzaW9uLCBwcm9vZikgewogICAgY29uc3QgYmF0Y2ggPSBuZXcgTWVya2xlVHJlZUJhdGNoKHNlc3Npb24pCgogICAgbGV0IHVudmVyaWZpZWQgPSB2ZXJpZnlUcmVlKHByb29mLCBiYXRjaC5ub2RlcykKCiAgICBpZiAocHJvb2YudXBncmFkZSkgewogICAgICBpZiAodmVyaWZ5VXBncmFkZShwcm9vZiwgdW52ZXJpZmllZCwgYmF0Y2gpKSB7CiAgICAgICAgdW52ZXJpZmllZCA9IG51bGwKICAgICAgfQogICAgfQoKICAgIGlmICh1bnZlcmlmaWVkKSB7CiAgICAgIGNvbnN0IHZlcmlmaWVkID0gYXdhaXQgZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZU9yRXJyb3Ioc2Vzc2lvbi5zdG9yYWdlLCB1bnZlcmlmaWVkLmluZGV4KQogICAgICBpZiAoIWI0YS5lcXVhbHModmVyaWZpZWQuaGFzaCwgdW52ZXJpZmllZC5oYXNoKSkgewogICAgICAgIHRocm93IElOVkFMSURfQ0hFQ0tTVU0oJ0ludmFsaWQgY2hlY2tzdW0gYXQgbm9kZSAnICsgdW52ZXJpZmllZC5pbmRleCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBiYXRjaAogIH0KCiAgc3RhdGljIHByb29mKHNlc3Npb24sIHJ4LCB7IGJsb2NrLCBoYXNoLCBzZWVrLCB1cGdyYWRlIH0pIHsKICAgIHJldHVybiBnZW5lcmF0ZVByb29mKHNlc3Npb24sIHJ4LCBibG9jaywgaGFzaCwgc2VlaywgdXBncmFkZSkKICB9CgogIHN0YXRpYyBtYXhNaXNzaW5nTm9kZXMoaW5kZXgsIGxlbmd0aCkgewogICAgY29uc3QgaGVhZCA9IDIgKiBsZW5ndGgKICAgIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IoaW5kZXgpCgogICAgLy8gU2VlIGl0ZXJhdG9yLnJpZ2h0U3BhbigpCiAgICBjb25zdCBpdGVSaWdodFNwYW4gPSBpdGUuaW5kZXggKyBpdGUuZmFjdG9yIC8gMiAtIDEKICAgIC8vIElmIHRoZSBpbmRleCBpcyBub3QgaW4gdGhlIGN1cnJlbnQgdHJlZSwgd2UgZG8gbm90IGtub3cgaG93IG1hbnkgbWlzc2luZyBub2RlcyB0aGVyZSBhcmUuLi4KICAgIGlmIChpdGVSaWdodFNwYW4gPj0gaGVhZCkgcmV0dXJuIDAKCiAgICBmb3IgKGNvbnN0IHIgb2YgZmxhdC5mdWxsUm9vdHMoaGVhZCkpIHsKICAgICAgaWYgKHIgPT09IGluZGV4KSByZXR1cm4gMAogICAgfQoKICAgIGxldCBjbnQgPSAwCiAgICB3aGlsZSAoIWl0ZS5jb250YWlucyhoZWFkKSkgewogICAgICBjbnQrKwogICAgICBpdGUucGFyZW50KCkKICAgIH0KCiAgICByZXR1cm4gY250CiAgfQoKICBzdGF0aWMgYXN5bmMgbWlzc2luZ05vZGVzKHNlc3Npb24sIGluZGV4LCBsZW5ndGgpIHsKICAgIGNvbnN0IGhlYWQgPSAyICogbGVuZ3RoCiAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKGluZGV4KQoKICAgIC8vIFNlZSBpdGVyYXRvci5yaWdodFNwYW4oKQogICAgY29uc3QgaXRlUmlnaHRTcGFuID0gaXRlLmluZGV4ICsgaXRlLmZhY3RvciAvIDIgLSAxCiAgICAvLyBJZiB0aGUgaW5kZXggaXMgbm90IGluIHRoZSBjdXJyZW50IHRyZWUsIHdlIGRvIG5vdCBrbm93IGhvdyBtYW55IG1pc3Npbmcgbm9kZXMgdGhlcmUgYXJlLi4uCiAgICBpZiAoaXRlUmlnaHRTcGFuID49IGhlYWQpIHJldHVybiAwCgogICAgbGV0IGNudCA9IDAKICAgIC8vIFRPRE86IHdlIGNvdWxkIHByb3AgdXNlIGEgcmVhZCBiYXRjaCBoZXJlIGFuZCBkbyB0aGlzIGluIGJsb2NrcyBvZiBYIGZvciBwZXJmCiAgICB3aGlsZSAoIWl0ZS5jb250YWlucyhoZWFkKSAmJiAhKGF3YWl0IGhhc1RyZWVOb2RlKHNlc3Npb24uc3RvcmFnZSwgaXRlLmluZGV4KSkpIHsKICAgICAgY250KysKICAgICAgaWYgKGNudCA+PSAxMDI0KSB7CiAgICAgICAgdGhyb3cgQVNTRVJUSU9OKCdCYWQgYXJndW1lbnRzIHRvIG1pc3NpbmdOb2RlcyBpbmRleD0nICsgaW5kZXggKyAnIGF0IGxlbmd0aD0nICsgbGVuZ3RoKQogICAgICB9CiAgICAgIGl0ZS5wYXJlbnQoKQogICAgfQoKICAgIHJldHVybiBjbnQKICB9CgogIHN0YXRpYyBieXRlT2Zmc2V0KHNlc3Npb24sIGluZGV4KSB7CiAgICByZXR1cm4gZ2V0Qnl0ZU9mZnNldFNlc3Npb24oc2Vzc2lvbiwgaW5kZXgsIG51bGwpCiAgfQoKICBzdGF0aWMgYnl0ZVJhbmdlKHNlc3Npb24sIGluZGV4KSB7CiAgICBjb25zdCByeCA9IHNlc3Npb24uc3RvcmFnZS5yZWFkKCkKICAgIGNvbnN0IG9mZnNldCA9IGdldEJ5dGVPZmZzZXRTZXNzaW9uKHNlc3Npb24sIGluZGV4LCByeCkKICAgIGNvbnN0IHNpemUgPSBnZXROb2RlU2l6ZShpbmRleCwgcngpCiAgICByeC50cnlGbHVzaCgpCiAgICByZXR1cm4gUHJvbWlzZS5hbGwoW29mZnNldCwgc2l6ZV0pCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBNZXJrbGVUcmVlQmF0Y2gsCiAgUmVvcmdCYXRjaCwKICBNZXJrbGVUcmVlCn0KCmFzeW5jIGZ1bmN0aW9uIGdldE5vZGVTaXplKGluZGV4LCByeCkgewogIHJldHVybiAoYXdhaXQgZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpbmRleCkpLnNpemUKfQoKYXN5bmMgZnVuY3Rpb24gZ2V0Qnl0ZU9mZnNldFNlc3Npb24oc2Vzc2lvbiwgaW5kZXgsIHJ4KSB7CiAgaWYgKGluZGV4ID09PSAyICogc2Vzc2lvbi5sZW5ndGgpIHJldHVybiBzZXNzaW9uLmJ5dGVMZW5ndGgKCiAgY29uc3QgdHJlZU5vZGVzID0KICAgIHJ4ID09PSBudWxsCiAgICAgID8gYXdhaXQgZ2V0Qnl0ZU9mZnNldEJhdGNoRmx1c2goc2Vzc2lvbi5yb290cywgaW5kZXgsIHNlc3Npb24uc3RvcmFnZS5yZWFkKCkpCiAgICAgIDogYXdhaXQgZ2V0Qnl0ZU9mZnNldEJhdGNoKHNlc3Npb24ucm9vdHMsIGluZGV4LCByeCkKCiAgbGV0IG9mZnNldCA9IDAKICBmb3IgKGNvbnN0IG5vZGUgb2YgdHJlZU5vZGVzKSBvZmZzZXQgKz0gbm9kZS5zaXplCgogIHJldHVybiBvZmZzZXQKfQoKYXN5bmMgZnVuY3Rpb24gZ2V0Qnl0ZU9mZnNldCh0cmVlLCBpbmRleCwgcngpIHsKICBpZiAoaW5kZXggPT09IDIgKiB0cmVlLmxlbmd0aCkgcmV0dXJuIHRyZWUuYnl0ZUxlbmd0aAoKICBjb25zdCB0cmVlTm9kZXMgPSBhd2FpdCBnZXRCeXRlT2Zmc2V0QmF0Y2godHJlZS5yb290cywgaW5kZXgsIHJ4KQoKICBsZXQgb2Zmc2V0ID0gMAogIGZvciAoY29uc3Qgbm9kZSBvZiB0cmVlTm9kZXMpIG9mZnNldCArPSBub2RlLnNpemUKCiAgcmV0dXJuIG9mZnNldAp9CgpmdW5jdGlvbiBnZXRCeXRlT2Zmc2V0QmF0Y2hGbHVzaChyb290cywgaW5kZXgsIHJ4KSB7CiAgY29uc3QgdHJlZU5vZGVzID0gZ2V0Qnl0ZU9mZnNldEJhdGNoKHJvb3RzLCBpbmRleCwgcngpCiAgcngudHJ5Rmx1c2goKQogIHJldHVybiB0cmVlTm9kZXMKfQoKZnVuY3Rpb24gZ2V0Qnl0ZU9mZnNldEJhdGNoKHJvb3RzLCBpbmRleCwgcngpIHsKICBpZiAoKGluZGV4ICYgMSkgPT09IDEpIGluZGV4ID0gZmxhdC5sZWZ0U3BhbihpbmRleCkKCiAgbGV0IGhlYWQgPSAwCiAgbGV0IGNudCA9IDAKCiAgY29uc3QgcHJvbWlzZXMgPSBbXQoKICBmb3IgKGNvbnN0IG5vZGUgb2Ygcm9vdHMpIHsKICAgIC8vIGFsbCBhc3luYyB0aWNrcyBoYXBwZW4gb25jZSB3ZSBmaW5kIHRoZSByb290IHNvIHNhZmUKICAgIGhlYWQgKz0gMiAqIChub2RlLmluZGV4IC0gaGVhZCArIDEpCgogICAgaWYgKGluZGV4ID49IGhlYWQpIHsKICAgICAgcHJvbWlzZXMucHVzaChub2RlLnNpemUpCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihub2RlLmluZGV4KQoKICAgIHdoaWxlIChpdGUuaW5kZXggIT09IGluZGV4KSB7CiAgICAgIGlmICgrK2NudCA+PSAxMDI0KSB0aHJvdyBBU1NFUlRJT04oJ0JhZCBnZXRCeXRlT2Zmc2V0U2Vzc2lvbiBpbmRleD0nICsgaW5kZXgpCgogICAgICBpZiAoaW5kZXggPCBpdGUuaW5kZXgpIHsKICAgICAgICBpdGUubGVmdENoaWxkKCkKICAgICAgfSBlbHNlIHsKICAgICAgICBwcm9taXNlcy5wdXNoKGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaXRlLmxlZnRDaGlsZCgpKSkKICAgICAgICBpdGUuc2libGluZygpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpCiAgfQoKICB0aHJvdyBBU1NFUlRJT04oJ0ZhaWxlZCB0byBmaW5kIG9mZnNldCcpCn0KCmZ1bmN0aW9uIGdldEJ5dGVSYW5nZSh0cmVlLCBpbmRleCwgcngpIHsKICBjb25zdCBoZWFkID0gMiAqIHRyZWUubGVuZ3RoCiAgaWYgKCgoaW5kZXggJiAxKSA9PT0gMCA/IGluZGV4IDogZmxhdC5yaWdodFNwYW4oaW5kZXgpKSA+PSBoZWFkKSB7CiAgICB0aHJvdyBCQURfQVJHVU1FTlQoJ0luZGV4IGlzIG91dCBvZiBib3VuZHMnKQogIH0KCiAgY29uc3Qgb2Zmc2V0ID0gZ2V0Qnl0ZU9mZnNldCh0cmVlLCBpbmRleCwgcngpCiAgY29uc3Qgc2l6ZSA9IGdldE5vZGVTaXplKGluZGV4LCByeCkKCiAgcmV0dXJuIFByb21pc2UuYWxsKFtvZmZzZXQsIHNpemVdKQp9CgovLyBBbGwgdGhlIG1ldGhvZHMgbmVlZGVkIGZvciBwcm9vZiB2ZXJpZmljYXRpb24KCmZ1bmN0aW9uIHZlcmlmeVRyZWUoeyBibG9jaywgaGFzaCwgc2VlayB9LCBub2RlcykgewogIGNvbnN0IHVudHJ1c3RlZE5vZGUgPSBibG9jawogICAgPyB7IGluZGV4OiAyICogYmxvY2suaW5kZXgsIHZhbHVlOiBibG9jay52YWx1ZSwgbm9kZXM6IGJsb2NrLm5vZGVzIH0KICAgIDogaGFzaAogICAgICA/IHsgaW5kZXg6IGhhc2guaW5kZXgsIHZhbHVlOiBudWxsLCBub2RlczogaGFzaC5ub2RlcyB9CiAgICAgIDogbnVsbAoKICBpZiAodW50cnVzdGVkTm9kZSA9PT0gbnVsbCAmJiAoIXNlZWsgfHwgIXNlZWsubm9kZXMubGVuZ3RoKSkgcmV0dXJuIG51bGwKCiAgbGV0IHJvb3QgPSBudWxsCgogIGlmIChzZWVrICYmIHNlZWsubm9kZXMubGVuZ3RoKSB7CiAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKHNlZWsubm9kZXNbMF0uaW5kZXgpCiAgICBjb25zdCBxID0gbmV3IE5vZGVRdWV1ZShzZWVrLm5vZGVzKQoKICAgIHJvb3QgPSBxLnNoaWZ0KGl0ZS5pbmRleCkKICAgIG5vZGVzLnB1c2gocm9vdCkKCiAgICB3aGlsZSAocS5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG5vZGUgPSBxLnNoaWZ0KGl0ZS5zaWJsaW5nKCkpCgogICAgICByb290ID0gcGFyZW50Tm9kZShpdGUucGFyZW50KCksIHJvb3QsIG5vZGUpCiAgICAgIG5vZGVzLnB1c2gobm9kZSkKICAgICAgbm9kZXMucHVzaChyb290KQogICAgfQogIH0KCiAgaWYgKHVudHJ1c3RlZE5vZGUgPT09IG51bGwpIHJldHVybiByb290CgogIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IodW50cnVzdGVkTm9kZS5pbmRleCkKICBjb25zdCBibG9ja0hhc2ggPSB1bnRydXN0ZWROb2RlLnZhbHVlICYmIGJsb2NrTm9kZShpdGUuaW5kZXgsIHVudHJ1c3RlZE5vZGUudmFsdWUpCgogIGNvbnN0IHEgPSBuZXcgTm9kZVF1ZXVlKHVudHJ1c3RlZE5vZGUubm9kZXMsIHJvb3QpCgogIHJvb3QgPSBibG9ja0hhc2ggfHwgcS5zaGlmdChpdGUuaW5kZXgpCiAgbm9kZXMucHVzaChyb290KQoKICB3aGlsZSAocS5sZW5ndGggPiAwKSB7CiAgICBjb25zdCBub2RlID0gcS5zaGlmdChpdGUuc2libGluZygpKQoKICAgIHJvb3QgPSBwYXJlbnROb2RlKGl0ZS5wYXJlbnQoKSwgcm9vdCwgbm9kZSkKICAgIG5vZGVzLnB1c2gobm9kZSkKICAgIG5vZGVzLnB1c2gocm9vdCkKICB9CgogIHJldHVybiByb290Cn0KCmZ1bmN0aW9uIHZlcmlmeVVwZ3JhZGUoeyBmb3JrLCB1cGdyYWRlIH0sIGJsb2NrUm9vdCwgYmF0Y2gpIHsKICBjb25zdCBwcm9sb2d1ZSA9IGJhdGNoLnByb2xvZ3VlCgogIGlmIChwcm9sb2d1ZSkgewogICAgY29uc3QgeyBzdGFydCwgbGVuZ3RoIH0gPSB1cGdyYWRlCiAgICBpZiAoc3RhcnQgPCBwcm9sb2d1ZS5sZW5ndGggJiYgKHN0YXJ0ICE9PSAwIHx8IGxlbmd0aCA8IHByb2xvZ3VlLmxlbmd0aCkpIHsKICAgICAgdGhyb3cgSU5WQUxJRF9QUk9PRignVXBncmFkZSBkb2VzIG5vdCBzYXRpc2Z5IHByb2xvZ3VlJykKICAgIH0KICB9CgogIGNvbnN0IHEgPSBuZXcgTm9kZVF1ZXVlKHVwZ3JhZGUubm9kZXMsIGJsb2NrUm9vdCkKCiAgbGV0IGdyb3cgPSBiYXRjaC5yb290cy5sZW5ndGggPiAwCiAgbGV0IGkgPSAwCgogIGNvbnN0IHRvID0gMiAqICh1cGdyYWRlLnN0YXJ0ICsgdXBncmFkZS5sZW5ndGgpCiAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcigwKQoKICBmb3IgKDsgaXRlLmZ1bGxSb290KHRvKTsgaXRlLm5leHRUcmVlKCkpIHsKICAgIGlmIChpIDwgYmF0Y2gucm9vdHMubGVuZ3RoICYmIGJhdGNoLnJvb3RzW2ldLmluZGV4ID09PSBpdGUuaW5kZXgpIHsKICAgICAgaSsrCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgaWYgKGdyb3cpIHsKICAgICAgZ3JvdyA9IGZhbHNlCiAgICAgIGNvbnN0IHJvb3QgPSBpdGUuaW5kZXgKICAgICAgaWYgKGkgPCBiYXRjaC5yb290cy5sZW5ndGgpIHsKICAgICAgICBpdGUuc2VlayhiYXRjaC5yb290c1tiYXRjaC5yb290cy5sZW5ndGggLSAxXS5pbmRleCkKICAgICAgICB3aGlsZSAoaXRlLmluZGV4ICE9PSByb290KSB7CiAgICAgICAgICBiYXRjaC5hcHBlbmRSb290KHEuc2hpZnQoaXRlLnNpYmxpbmcoKSksIGl0ZSkKICAgICAgICB9CiAgICAgICAgY29udGludWUKICAgICAgfQogICAgfQoKICAgIGJhdGNoLmFwcGVuZFJvb3QocS5zaGlmdChpdGUuaW5kZXgpLCBpdGUpCiAgfQoKICBpZiAocHJvbG9ndWUgJiYgYmF0Y2gubGVuZ3RoID09PSBwcm9sb2d1ZS5sZW5ndGgpIHsKICAgIGlmICghYjRhLmVxdWFscyhwcm9sb2d1ZS5oYXNoLCBiYXRjaC5oYXNoKCkpKSB7CiAgICAgIHRocm93IElOVkFMSURfUFJPT0YoJ0ludmFsaWQgaGFzaCcpCiAgICB9CiAgfQoKICBjb25zdCBleHRyYSA9IHVwZ3JhZGUuYWRkaXRpb25hbE5vZGVzCgogIGl0ZS5zZWVrKGJhdGNoLnJvb3RzW2JhdGNoLnJvb3RzLmxlbmd0aCAtIDFdLmluZGV4KQogIGkgPSAwCgogIHdoaWxlIChpIDwgZXh0cmEubGVuZ3RoICYmIGV4dHJhW2ldLmluZGV4ID09PSBpdGUuc2libGluZygpKSB7CiAgICBiYXRjaC5hcHBlbmRSb290KGV4dHJhW2krK10sIGl0ZSkKICB9CgogIHdoaWxlIChpIDwgZXh0cmEubGVuZ3RoKSB7CiAgICBjb25zdCBub2RlID0gZXh0cmFbaSsrXQoKICAgIHdoaWxlIChub2RlLmluZGV4ICE9PSBpdGUuaW5kZXgpIHsKICAgICAgaWYgKGl0ZS5mYWN0b3IgPT09IDIpIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdVbmV4cGVjdGVkIG5vZGU6ICcgKyBub2RlLmluZGV4KQogICAgICBpdGUubGVmdENoaWxkKCkKICAgIH0KCiAgICBiYXRjaC5hcHBlbmRSb290KG5vZGUsIGl0ZSkKICAgIGl0ZS5zaWJsaW5nKCkKICB9CgogIGJhdGNoLnNpZ25hdHVyZSA9IHVuc2xhYih1cGdyYWRlLnNpZ25hdHVyZSkKICBiYXRjaC5mb3JrID0gZm9yawoKICByZXR1cm4gcS5leHRyYSA9PT0gbnVsbAp9Cgphc3luYyBmdW5jdGlvbiBzZWVrRnJvbUhlYWQoc2Vzc2lvbiwgaGVhZCwgYnl0ZXMsIHBhZGRpbmcpIHsKICBjb25zdCByb290cyA9IGZsYXQuZnVsbFJvb3RzKGhlYWQpCgogIGZvciAobGV0IGkgPSAwOyBpIDwgcm9vdHMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHJvb3QgPSByb290c1tpXQogICAgY29uc3Qgbm9kZSA9IGF3YWl0IGdldFRyZWVOb2RlRnJvbVN0b3JhZ2Uoc2Vzc2lvbi5zdG9yYWdlLCByb290KQogICAgY29uc3Qgc2l6ZSA9IGdldFVucGFkZGVkU2l6ZShub2RlLCBwYWRkaW5nLCBudWxsKQoKICAgIGlmIChieXRlcyA9PT0gc2l6ZSkgcmV0dXJuIHJvb3QKICAgIGlmIChieXRlcyA+IHNpemUpIHsKICAgICAgYnl0ZXMgLT0gc2l6ZQogICAgICBjb250aW51ZQogICAgfQoKICAgIHJldHVybiBzZWVrVHJ1c3RlZFRyZWUoc2Vzc2lvbiwgcm9vdCwgYnl0ZXMsIHBhZGRpbmcpCiAgfQoKICByZXR1cm4gaGVhZAp9CgovLyB0cnVzdCB0aGF0IGJ5dGVzIGFyZSB3aXRoaW4gdGhlIHJvb3QgdHJlZSBhbmQgZmluZCB0aGUgYmxvY2sgYXQgYnl0ZXMKCmFzeW5jIGZ1bmN0aW9uIHNlZWtUcnVzdGVkVHJlZShzZXNzaW9uLCByb290LCBieXRlcywgcGFkZGluZykgewogIGlmICghYnl0ZXMpIHJldHVybiByb290CgogIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3Iocm9vdCkKICBsZXQgY250ID0gMAoKICB3aGlsZSAoKGl0ZS5pbmRleCAmIDEpICE9PSAwKSB7CiAgICBpZiAoKytjbnQgPj0gMTAyNCkgdGhyb3cgQVNTRVJUSU9OKCdCYWQgc2Vla1RydXN0ZWQgYnl0ZXM9JyArIGJ5dGVzICsgJywgcGFkZGRpbmc9JyArIHBhZGRpbmcpCiAgICBjb25zdCBsID0gYXdhaXQgZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZShzZXNzaW9uLnN0b3JhZ2UsIGl0ZS5sZWZ0Q2hpbGQoKSkKCiAgICBpZiAobCkgewogICAgICBjb25zdCBzaXplID0gZ2V0VW5wYWRkZWRTaXplKGwsIHBhZGRpbmcsIGl0ZSkKICAgICAgaWYgKHNpemUgPT09IGJ5dGVzKSByZXR1cm4gaXRlLmluZGV4CiAgICAgIGlmIChzaXplID4gYnl0ZXMpIGNvbnRpbnVlCiAgICAgIGJ5dGVzIC09IHNpemUKICAgICAgaXRlLnNpYmxpbmcoKQogICAgfSBlbHNlIHsKICAgICAgaXRlLnBhcmVudCgpCiAgICAgIHJldHVybiBpdGUuaW5kZXgKICAgIH0KICB9CgogIHJldHVybiBpdGUuaW5kZXgKfQoKLy8gdHJ5IHRvIGZpbmQgdGhlIGJsb2NrIGF0IGJ5dGVzIHdpdGhvdXQgdHJ1c3RpbmcgdGhhdCBpcyAqaXMqIHdpdGhpbiB0aGUgcm9vdCBwYXNzZWQKCmFzeW5jIGZ1bmN0aW9uIHNlZWtVbnRydXN0ZWRUcmVlKHNlc3Npb24sIHJvb3QsIGJ5dGVzLCBwYWRkaW5nKSB7CiAgY29uc3Qgb2Zmc2V0ID0KICAgIChhd2FpdCBnZXRCeXRlT2Zmc2V0U2Vzc2lvbihzZXNzaW9uLCByb290LCBudWxsKSkgLQogICAgKHBhZGRpbmcgPyAocGFkZGluZyAqIGZsYXQubGVmdFNwYW4ocm9vdCkpIC8gMiA6IDApCgogIGlmIChvZmZzZXQgPiBieXRlcykgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0ludmFsaWQgc2VlaycpCiAgaWYgKG9mZnNldCA9PT0gYnl0ZXMpIHJldHVybiByb290CgogIGJ5dGVzIC09IG9mZnNldAoKICBjb25zdCBub2RlID0gYXdhaXQgZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZU9yRXJyb3Ioc2Vzc2lvbi5zdG9yYWdlLCByb290KQoKICBpZiAoZ2V0VW5wYWRkZWRTaXplKG5vZGUsIHBhZGRpbmcsIG51bGwpIDw9IGJ5dGVzKSB0aHJvdyBJTlZBTElEX09QRVJBVElPTignSW52YWxpZCBzZWVrJykKCiAgcmV0dXJuIHNlZWtUcnVzdGVkVHJlZShzZXNzaW9uLCByb290LCBieXRlcywgcGFkZGluZykKfQoKLy8gQmVsb3cgaXMgcHJvb2YgcHJvZHVjdGlvbiwgaWUsIGNvbnN0cnVjdCBwcm9vZnMgdG8gdmVyaWZ5IGEgcmVxdWVzdAovLyBOb3RlLCB0aGF0IGFsbCB0aGVzZSBtZXRob2RzIGFyZSBzeW5jIGFzIHdlIGNhbiBzdGF0aWNhbGx5IGluZmVyIHdoaWNoIG5vZGVzCi8vIGFyZSBuZWVkZWQgZm9yIHRoZSByZW1vdGUgdG8gdmVyaWZ5IGdpdmVuIHRoZXkgYXJndW1lbnRzIHRoZXkgcGFzc2VkIHVzCgpmdW5jdGlvbiBzZWVrUHJvb2Yoc2Vzc2lvbiwgcngsIHNlZWtSb290LCByb290LCBwKSB7CiAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihzZWVrUm9vdCkKICBsZXQgY250ID0gMAoKICBwLnNlZWsgPSBbXQogIHAuc2Vlay5wdXNoKGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaXRlLmluZGV4KSkKCiAgd2hpbGUgKGl0ZS5pbmRleCAhPT0gcm9vdCkgewogICAgaWYgKCsrY250ID49IDEwMjQpIHRocm93IEFTU0VSVElPTignQmFkIHNlZWtQcm9vZiBzZWVrUm9vdD0nICsgc2Vla1Jvb3QgKyAnLCByb290PScgKyByb290KQogICAgaXRlLnNpYmxpbmcoKQogICAgcC5zZWVrLnB1c2goZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpdGUuaW5kZXgpKQogICAgaXRlLnBhcmVudCgpCiAgfQp9CgpmdW5jdGlvbiBibG9ja0FuZFNlZWtQcm9vZihzZXNzaW9uLCByeCwgbm9kZSwgc2Vlaywgc2Vla1Jvb3QsIHJvb3QsIHApIHsKICBpZiAoIW5vZGUpIHJldHVybiBzZWVrUHJvb2Yoc2Vzc2lvbiwgcngsIHNlZWtSb290LCByb290LCBwKQoKICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKG5vZGUuaW5kZXgpCiAgbGV0IGNudCA9IDAKCiAgcC5ub2RlID0gW10KICBpZiAoIW5vZGUudmFsdWUpIHAubm9kZS5wdXNoKGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaXRlLmluZGV4KSkKCiAgd2hpbGUgKGl0ZS5pbmRleCAhPT0gcm9vdCkgewogICAgaWYgKCsrY250ID49IDEwMjQpIHsKICAgICAgdGhyb3cgQVNTRVJUSU9OKCdCYWQgYmxvY2tBbmRTZWVrUHJvb2Ygc2Vla1Jvb3Q9JyArIHNlZWtSb290ICsgJywgcm9vdD0nICsgcm9vdCkKICAgIH0KICAgIGl0ZS5zaWJsaW5nKCkKCiAgICBpZiAoc2VlayAmJiBpdGUuY29udGFpbnMoc2Vla1Jvb3QpICYmIGl0ZS5pbmRleCAhPT0gc2Vla1Jvb3QpIHsKICAgICAgc2Vla1Byb29mKHNlc3Npb24sIHJ4LCBzZWVrUm9vdCwgaXRlLmluZGV4LCBwKQogICAgfSBlbHNlIHsKICAgICAgcC5ub2RlLnB1c2goZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpdGUuaW5kZXgpKQogICAgfQoKICAgIGl0ZS5wYXJlbnQoKQogIH0KfQoKZnVuY3Rpb24gdXBncmFkZVByb29mKHNlc3Npb24sIHJ4LCBub2RlLCBzZWVrLCBmcm9tLCB0bywgc3ViVHJlZSwgcCkgewogIGlmIChmcm9tID09PSAwKSBwLnVwZ3JhZGUgPSBbXQoKICBmb3IgKGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IoMCk7IGl0ZS5mdWxsUm9vdCh0byk7IGl0ZS5uZXh0VHJlZSgpKSB7CiAgICAvLyBjaGVjayBpZiB0aGV5IGFscmVhZHkgaGF2ZSB0aGUgbm9kZQogICAgaWYgKGl0ZS5pbmRleCArIGl0ZS5mYWN0b3IgLyAyIDwgZnJvbSkgY29udGludWUKCiAgICAvLyBjb25uZWN0IGV4aXN0aW5nIHRyZWUKICAgIGlmIChwLnVwZ3JhZGUgPT09IG51bGwgJiYgaXRlLmNvbnRhaW5zKGZyb20gLSAyKSkgewogICAgICBwLnVwZ3JhZGUgPSBbXQoKICAgICAgY29uc3Qgcm9vdCA9IGl0ZS5pbmRleAogICAgICBjb25zdCB0YXJnZXQgPSBmcm9tIC0gMgogICAgICBsZXQgY250ID0gMAoKICAgICAgaXRlLnNlZWsodGFyZ2V0KQoKICAgICAgd2hpbGUgKGl0ZS5pbmRleCAhPT0gcm9vdCkgewogICAgICAgIGlmICgrK2NudCA+PSAxMDI0KSB0aHJvdyBBU1NFUlRJT04oJ0JhZCB1cGdyYWRlUHJvb2YgdGFyZ2V0PScgKyB0YXJnZXQgKyAnLCByb290PScgKyByb290KQoKICAgICAgICBpdGUuc2libGluZygpCiAgICAgICAgaWYgKGl0ZS5pbmRleCA+IHRhcmdldCkgewogICAgICAgICAgaWYgKHAubm9kZSA9PT0gbnVsbCAmJiBwLnNlZWsgPT09IG51bGwgJiYgaXRlLmNvbnRhaW5zKHN1YlRyZWUpKSB7CiAgICAgICAgICAgIGJsb2NrQW5kU2Vla1Byb29mKHNlc3Npb24sIHJ4LCBub2RlLCBzZWVrLCBzdWJUcmVlLCBpdGUuaW5kZXgsIHApCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwLnVwZ3JhZGUucHVzaChnZXRUcmVlTm9kZU9yRXJyb3IocngsIGl0ZS5pbmRleCkpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGl0ZS5wYXJlbnQoKQogICAgICB9CgogICAgICBjb250aW51ZQogICAgfQoKICAgIGlmIChwLnVwZ3JhZGUgPT09IG51bGwpIHsKICAgICAgcC51cGdyYWRlID0gW10KICAgIH0KCiAgICAvLyBpZiB0aGUgc3VidHJlZSBpbmNsdWRlZCBpcyBhIGNoaWxkIG9mIHRoaXMgdHJlZSwgaW5jbHVkZSB0aGF0IG9uZQogICAgLy8gaW5zdGVhZCBvZiBhIGR1cCBub2RlCiAgICBpZiAocC5ub2RlID09PSBudWxsICYmIHAuc2VlayA9PT0gbnVsbCAmJiBpdGUuY29udGFpbnMoc3ViVHJlZSkpIHsKICAgICAgYmxvY2tBbmRTZWVrUHJvb2Yoc2Vzc2lvbiwgcngsIG5vZGUsIHNlZWssIHN1YlRyZWUsIGl0ZS5pbmRleCwgcCkKICAgICAgY29udGludWUKICAgIH0KCiAgICAvLyBhZGQgcm9vdCAoY2FuIGJlIG9wdGltaXNlZCBzaW5jZSB0aGUgcm9vdCBtaWdodCBiZSBpbiB0cmVlLnJvb3RzKQogICAgcC51cGdyYWRlLnB1c2goZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpdGUuaW5kZXgpKQogIH0KfQoKZnVuY3Rpb24gYWRkaXRpb25hbFVwZ3JhZGVQcm9vZihzZXNzaW9uLCByeCwgZnJvbSwgdG8sIHApIHsKICBpZiAoZnJvbSA9PT0gMCkgcC5hZGRpdGlvbmFsVXBncmFkZSA9IFtdCgogIGZvciAoY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcigwKTsgaXRlLmZ1bGxSb290KHRvKTsgaXRlLm5leHRUcmVlKCkpIHsKICAgIC8vIGNoZWNrIGlmIHRoZXkgYWxyZWFkeSBoYXZlIHRoZSBub2RlCiAgICBpZiAoaXRlLmluZGV4ICsgaXRlLmZhY3RvciAvIDIgPCBmcm9tKSBjb250aW51ZQoKICAgIC8vIGNvbm5lY3QgZXhpc3RpbmcgdHJlZQogICAgaWYgKHAuYWRkaXRpb25hbFVwZ3JhZGUgPT09IG51bGwgJiYgaXRlLmNvbnRhaW5zKGZyb20gLSAyKSkgewogICAgICBwLmFkZGl0aW9uYWxVcGdyYWRlID0gW10KCiAgICAgIGNvbnN0IHJvb3QgPSBpdGUuaW5kZXgKICAgICAgY29uc3QgdGFyZ2V0ID0gZnJvbSAtIDIKICAgICAgbGV0IGNudCA9IDAKCiAgICAgIGl0ZS5zZWVrKHRhcmdldCkKCiAgICAgIHdoaWxlIChpdGUuaW5kZXggIT09IHJvb3QpIHsKICAgICAgICBpZiAoKytjbnQgPj0gMTAyNCkgewogICAgICAgICAgdGhyb3cgQVNTRVJUSU9OKAogICAgICAgICAgICAnQmFkIGFyZ3VtZW50cyB0byBhZGRpdGlvbmFsVXBncmFkZVByb29mIHJvb3Q9JyArIHJvb3QgKyAnIHRhcmdldD0nICsgdGFyZ2V0CiAgICAgICAgICApCiAgICAgICAgfQogICAgICAgIGl0ZS5zaWJsaW5nKCkKICAgICAgICBpZiAoaXRlLmluZGV4ID4gdGFyZ2V0KSB7CiAgICAgICAgICBwLmFkZGl0aW9uYWxVcGdyYWRlLnB1c2goZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpdGUuaW5kZXgpKQogICAgICAgIH0KICAgICAgICBpdGUucGFyZW50KCkKICAgICAgfQoKICAgICAgY29udGludWUKICAgIH0KCiAgICBpZiAocC5hZGRpdGlvbmFsVXBncmFkZSA9PT0gbnVsbCkgewogICAgICBwLmFkZGl0aW9uYWxVcGdyYWRlID0gW10KICAgIH0KCiAgICAvLyBhZGQgcm9vdCAoY2FuIGJlIG9wdGltaXNlZCBzaW5jZSB0aGUgcm9vdCBpcyBpbiB0cmVlLnJvb3RzKQogICAgcC5hZGRpdGlvbmFsVXBncmFkZS5wdXNoKGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaXRlLmluZGV4KSkKICB9Cn0KCmZ1bmN0aW9uIG5vZGVzVG9Sb290KGluZGV4LCBub2RlcywgaGVhZCkgewogIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IoaW5kZXgpCgogIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZXM7IGkrKykgewogICAgaXRlLnBhcmVudCgpCiAgICBpZiAoaXRlLmNvbnRhaW5zKGhlYWQpKSB0aHJvdyBJTlZBTElEX09QRVJBVElPTignTm9kZXMgaXMgb3V0IG9mIGJvdW5kcycpCiAgfQoKICByZXR1cm4gaXRlLmluZGV4Cn0KCmZ1bmN0aW9uIHRvdGFsU2l6ZShub2RlcykgewogIGxldCBzID0gMAogIGZvciAoY29uc3Qgbm9kZSBvZiBub2RlcykgcyArPSBub2RlLnNpemUKICByZXR1cm4gcwp9CgpmdW5jdGlvbiB0b3RhbFNwYW4obm9kZXMpIHsKICBsZXQgcyA9IDAKICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIHMgKz0gMiAqIChub2RlLmluZGV4IC0gcyArIDEpCiAgcmV0dXJuIHMKfQoKZnVuY3Rpb24gYmxvY2tOb2RlKGluZGV4LCB2YWx1ZSkgewogIHJldHVybiB7IGluZGV4LCBzaXplOiB2YWx1ZS5ieXRlTGVuZ3RoLCBoYXNoOiBjcnlwdG8uZGF0YSh2YWx1ZSkgfQp9CgpmdW5jdGlvbiBwYXJlbnROb2RlKGluZGV4LCBhLCBiKSB7CiAgcmV0dXJuIHsgaW5kZXgsIHNpemU6IGEuc2l6ZSArIGIuc2l6ZSwgaGFzaDogY3J5cHRvLnBhcmVudChhLCBiKSB9Cn0KCmZ1bmN0aW9uIGxvZzIobikgewogIGxldCByZXMgPSAxCgogIHdoaWxlIChuID4gMikgewogICAgbiAvPSAyCiAgICByZXMrKwogIH0KCiAgcmV0dXJuIHJlcwp9CgpmdW5jdGlvbiBub3JtYWxpemVJbmRleGVkKGJsb2NrLCBoYXNoKSB7CiAgaWYgKGJsb2NrKSB7CiAgICByZXR1cm4gewogICAgICB2YWx1ZTogdHJ1ZSwKICAgICAgaW5kZXg6IGJsb2NrLmluZGV4ICogMiwKICAgICAgbm9kZXM6IGJsb2NrLm5vZGVzLAogICAgICBsYXN0SW5kZXg6IGJsb2NrLmluZGV4CiAgICB9CiAgfQogIGlmIChoYXNoKSB7CiAgICByZXR1cm4gewogICAgICB2YWx1ZTogZmFsc2UsCiAgICAgIGluZGV4OiBoYXNoLmluZGV4LAogICAgICBub2RlczogaGFzaC5ub2RlcywKICAgICAgbGFzdEluZGV4OiBmbGF0LnJpZ2h0U3BhbihoYXNoLmluZGV4KSAvIDIKICAgIH0KICB9CiAgcmV0dXJuIG51bGwKfQoKYXN5bmMgZnVuY3Rpb24gZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpbmRleCkgewogIGNvbnN0IG5vZGUgPSBhd2FpdCByeC5nZXRUcmVlTm9kZShpbmRleCkKICBpZiAobm9kZSA9PT0gbnVsbCkgewogICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0V4cGVjdGVkIHRyZWUgbm9kZSAnICsgaW5kZXggKyAnIGZyb20gc3RvcmFnZSwgZ290IChuaWwpJykKICB9CiAgcmV0dXJuIG5vZGUKfQoKZnVuY3Rpb24gZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZU9yRXJyb3Ioc3RvcmFnZSwgaW5kZXgpIHsKICBjb25zdCByeCA9IHN0b3JhZ2UucmVhZCgpCiAgY29uc3QgcCA9IGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaW5kZXgpCiAgcngudHJ5Rmx1c2goKQogIHJldHVybiBwCn0KCmZ1bmN0aW9uIGdldFRyZWVOb2RlRnJvbVN0b3JhZ2Uoc3RvcmFnZSwgaW5kZXgpIHsKICBjb25zdCByeCA9IHN0b3JhZ2UucmVhZCgpCiAgY29uc3Qgbm9kZSA9IHJ4LmdldFRyZWVOb2RlKGluZGV4KQogIHJ4LnRyeUZsdXNoKCkKICByZXR1cm4gbm9kZQp9CgpmdW5jdGlvbiBoYXNUcmVlTm9kZShzdG9yYWdlLCBpbmRleCkgewogIGNvbnN0IHJ4ID0gc3RvcmFnZS5yZWFkKCkKICBjb25zdCBoYXMgPSByeC5oYXNUcmVlTm9kZShpbmRleCkKICByeC50cnlGbHVzaCgpCiAgcmV0dXJuIGhhcwp9Cgphc3luYyBmdW5jdGlvbiBzZXR0bGVQcm9vZihwKSB7CiAgY29uc3QgcmVzdWx0ID0gWwogICAgcC5ub2RlICYmIFByb21pc2UuYWxsKHAubm9kZSksCiAgICBwLnNlZWsgJiYgUHJvbWlzZS5hbGwocC5zZWVrKSwKICAgIHAudXBncmFkZSAmJiBQcm9taXNlLmFsbChwLnVwZ3JhZGUpLAogICAgcC5hZGRpdGlvbmFsVXBncmFkZSAmJiBQcm9taXNlLmFsbChwLmFkZGl0aW9uYWxVcGdyYWRlKQogIF0KCiAgdHJ5IHsKICAgIHJldHVybiBhd2FpdCBQcm9taXNlLmFsbChyZXN1bHQpCiAgfSBjYXRjaCAoZXJyKSB7CiAgICBpZiAocC5ub2RlKSBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQocC5ub2RlKQogICAgaWYgKHAuc2VlaykgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHAuc2VlaykKICAgIGlmIChwLnVwZ3JhZGUpIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChwLnVwZ3JhZGUpCiAgICBpZiAocC5hZGRpdGlvbmFsVXBncmFkZSkgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHAuYWRkaXRpb25hbFVwZ3JhZGUpCiAgICB0aHJvdyBlcnIKICB9Cn0KCi8vIHRyZWUgY2FuIGJlIGVpdGhlciB0aGUgbWVya2xlIHRyZWUgb3IgYSBtZXJrbGUgdHJlZSBiYXRjaAphc3luYyBmdW5jdGlvbiBnZW5lcmF0ZVByb29mKHNlc3Npb24sIHJ4LCBibG9jaywgaGFzaCwgc2VlaywgdXBncmFkZSkgewogIC8vIEltcG9ydGFudCB0aGF0IHRoaXMgZG9lcyBub3QgdGhyb3cgaW5iZXR3ZWVuIG1ha2luZyB0aGUgcHJvbWlzZSBhcnJheXMKICAvLyBhbmQgZmluYWxpc2UgYmVpbmcgY2FsbGVkLCBvdGhlcndpc2UgdGhlcmUgd2lsbCBiZSBsaW5nZXJpbmcgcHJvbWlzZXMgaW4gdGhlIGJhY2tncm91bmQKCiAgaWYgKHNlc3Npb24ucHJvbG9ndWUgJiYgdXBncmFkZSkgewogICAgdXBncmFkZS5zdGFydCA9IHVwZ3JhZGUuc3RhcnQgPCBzZXNzaW9uLnByb2xvZ3VlLmxlbmd0aCA/IDAgOiB1cGdyYWRlLnN0YXJ0CiAgICB1cGdyYWRlLmxlbmd0aCA9CiAgICAgIHVwZ3JhZGUuc3RhcnQgPCBzZXNzaW9uLnByb2xvZ3VlLmxlbmd0aCA/IHNlc3Npb24ucHJvbG9ndWUubGVuZ3RoIDogdXBncmFkZS5sZW5ndGgKICB9CgogIGNvbnN0IGhlYWQgPSAyICogc2Vzc2lvbi5sZW5ndGgKICBjb25zdCBmcm9tID0gdXBncmFkZSA/IHVwZ3JhZGUuc3RhcnQgKiAyIDogMAogIGNvbnN0IHRvID0gdXBncmFkZSA/IGZyb20gKyB1cGdyYWRlLmxlbmd0aCAqIDIgOiBoZWFkCiAgY29uc3Qgbm9kZSA9IG5vcm1hbGl6ZUluZGV4ZWQoYmxvY2ssIGhhc2gpCgogIC8vIGNhbid0IGRvIGFueXRoaW5nIGFzIHdlIGhhdmUgbm8gZGF0YS4uLgogIGlmIChoZWFkID09PSAwKSByZXR1cm4gbmV3IFRyZWVQcm9vZihzZXNzaW9uLCBudWxsLCBudWxsLCBudWxsLCBudWxsKQoKICBpZiAoZnJvbSA+PSB0byB8fCB0byA+IGhlYWQpIHsKICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdJbnZhbGlkIHVwZ3JhZGUnKQogIH0KICBpZiAoc2VlayAmJiB1cGdyYWRlICYmIG5vZGUgIT09IG51bGwgJiYgbm9kZS5pbmRleCA+PSBmcm9tKSB7CiAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTignQ2Fubm90IGJvdGggZG8gYSBzZWVrIGFuZCBibG9jay9oYXNoIHJlcXVlc3Qgd2hlbiB1cGdyYWRpbmcnKQogIH0KCiAgbGV0IHN1YlRyZWUgPSBoZWFkCgogIGNvbnN0IHAgPSBuZXcgVHJlZVByb29mKHNlc3Npb24sIGJsb2NrLCBoYXNoLCBzZWVrLCB1cGdyYWRlKQoKICBpZiAobm9kZSAhPT0gbnVsbCAmJiAoIXVwZ3JhZGUgfHwgbm9kZS5sYXN0SW5kZXggPCB1cGdyYWRlLnN0YXJ0KSkgewogICAgc3ViVHJlZSA9IG5vZGVzVG9Sb290KG5vZGUuaW5kZXgsIG5vZGUubm9kZXMsIHRvKQogICAgY29uc3Qgc2Vla1Jvb3QgPSBzZWVrCiAgICAgID8gYXdhaXQgc2Vla1VudHJ1c3RlZFRyZWUoc2Vzc2lvbiwgc3ViVHJlZSwgc2Vlay5ieXRlcywgc2Vlay5wYWRkaW5nKQogICAgICA6IGhlYWQKICAgIGJsb2NrQW5kU2Vla1Byb29mKHNlc3Npb24sIHJ4LCBub2RlLCBzZWVrLCBzZWVrUm9vdCwgc3ViVHJlZSwgcC5wZW5kaW5nKQogIH0gZWxzZSBpZiAoKG5vZGUgfHwgc2VlaykgJiYgdXBncmFkZSkgewogICAgc3ViVHJlZSA9IHNlZWsgPyBhd2FpdCBzZWVrRnJvbUhlYWQoc2Vzc2lvbiwgdG8sIHNlZWsuYnl0ZXMsIHNlZWsucGFkZGluZykgOiBub2RlLmluZGV4CiAgfQoKICBpZiAodXBncmFkZSkgewogICAgdXBncmFkZVByb29mKHNlc3Npb24sIHJ4LCBub2RlLCBzZWVrLCBmcm9tLCB0bywgc3ViVHJlZSwgcC5wZW5kaW5nKQogICAgaWYgKGhlYWQgPiB0bykgYWRkaXRpb25hbFVwZ3JhZGVQcm9vZihzZXNzaW9uLCByeCwgdG8sIGhlYWQsIHAucGVuZGluZykKICB9CgogIHJldHVybiBwCn0KCmZ1bmN0aW9uIGdldFVucGFkZGVkU2l6ZShub2RlLCBwYWRkaW5nLCBpdGUpIHsKICByZXR1cm4gcGFkZGluZyA9PT0gMAogICAgPyBub2RlLnNpemUKICAgIDogbm9kZS5zaXplIC0gcGFkZGluZyAqIChpdGUgPyBpdGUuY291bnRMZWF2ZXMoKSA6IGZsYXQuY291bnRMZWF2ZXMobm9kZS5pbmRleCkpCn0KCmZ1bmN0aW9uIHVuc2xhYk5vZGVzKG5vZGVzKSB7CiAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSB1bnNsYWJOb2RlKG5vZGUpCiAgcmV0dXJuIG5vZGVzCn0KCmZ1bmN0aW9uIHVuc2xhYk5vZGUobm9kZSkgewogIGlmIChub2RlID09PSBudWxsKSByZXR1cm4gbm9kZQogIG5vZGUuaGFzaCA9IHVuc2xhYihub2RlLmhhc2gpCiAgcmV0dXJuIG5vZGUKfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHsgREVGQVVMVF9OQU1FU1BBQ0UgfSA9IHJlcXVpcmUoJy4vY2FwcycpCmNvbnN0IHsgSU5WQUxJRF9PUExPR19WRVJTSU9OIH0gPSByZXF1aXJlKCdoeXBlcmNvcmUtZXJyb3JzJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKCmNvbnN0IEVNUFRZID0gYjRhLmFsbG9jKDApCgpjb25zdCBNQU5JRkVTVF9QQVRDSCA9IDBiMDAwMDAwMDEKY29uc3QgTUFOSUZFU1RfUFJPTE9HVUUgPSAwYjAwMDAwMDEwCmNvbnN0IE1BTklGRVNUX0xJTktFRCA9IDBiMDAwMDAxMDAKY29uc3QgTUFOSUZFU1RfVVNFUl9EQVRBID0gMGIwMDAwMTAwMAoKY29uc3QgaGFzaGVzID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gc21hbGwgdWludAogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBpZiAobSA9PT0gJ2JsYWtlMmInKSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApCiAgICAgIHJldHVybgogICAgfQoKICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBoYXNoOiAnICsgbSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAobiA9PT0gMCkgcmV0dXJuICdibGFrZTJiJwogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGhhc2ggaWQ6ICcgKyBuKQogIH0KfQoKY29uc3Qgc2lnbmF0dXJlcyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIHNtYWxsIHVpbnQKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgaWYgKG0gPT09ICdlZDI1NTE5JykgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAwKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gc2lnbmF0dXJlOiAnICsgbSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAobiA9PT0gMCkgcmV0dXJuICdlZDI1NTE5JwogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHNpZ25hdHVyZSBpZDogJyArIG4pCiAgfQp9Cgpjb25zdCBzaWduZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzaWduYXR1cmVzLnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzaWduYXR1cmVzLmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzaWduYXR1cmU6IHNpZ25hdHVyZXMuZGVjb2RlKHN0YXRlKSwKICAgICAgbmFtZXNwYWNlOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgcHVibGljS2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qgc2lnbmVyQXJyYXkgPSBjLmFycmF5KHNpZ25lcikKCmNvbnN0IHByb2xvZ3VlID0gewogIHByZWVuY29kZShzdGF0ZSwgcCkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgcC5oYXNoKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgcC5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHApIHsKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIHAuaGFzaCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHAubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBoYXNoOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgbWFuaWZlc3R2MCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGhhc2hlcy5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIHN0YXRlLmVuZCsrIC8vIHR5cGUKCiAgICBpZiAobS5wcm9sb2d1ZSAmJiBtLnNpZ25lcnMubGVuZ3RoID09PSAwKSB7CiAgICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ucHJvbG9ndWUuaGFzaCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKG0ucXVvcnVtID09PSAxICYmIG0uc2lnbmVycy5sZW5ndGggPT09IDEgJiYgIW0uYWxsb3dQYXRjaCkgewogICAgICBzaWduZXIucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnNbMF0pCiAgICB9IGVsc2UgewogICAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnF1b3J1bSkKICAgICAgc2lnbmVyQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGhhc2hlcy5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKCiAgICBpZiAobS5wcm9sb2d1ZSAmJiBtLnNpZ25lcnMubGVuZ3RoID09PSAwKSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApCiAgICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucHJvbG9ndWUuaGFzaCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKG0ucXVvcnVtID09PSAxICYmIG0uc2lnbmVycy5sZW5ndGggPT09IDEgJiYgIW0uYWxsb3dQYXRjaCkgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKQogICAgICBzaWduZXIuZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnNbMF0pCiAgICB9IGVsc2UgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAyKQogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmFsbG93UGF0Y2ggPyAxIDogMCkKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5xdW9ydW0pCiAgICAgIHNpZ25lckFycmF5LmVuY29kZShzdGF0ZSwgbS5zaWduZXJzKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBoYXNoID0gaGFzaGVzLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHR5cGUgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmICh0eXBlID4gMikgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHR5cGU6ICcgKyB0eXBlKQoKICAgIGlmICh0eXBlID09PSAwKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmVyc2lvbjogMCwKICAgICAgICBoYXNoLAogICAgICAgIGFsbG93UGF0Y2g6IGZhbHNlLAogICAgICAgIHF1b3J1bTogMCwKICAgICAgICBzaWduZXJzOiBbXSwKICAgICAgICBwcm9sb2d1ZTogewogICAgICAgICAgaGFzaDogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgICAgICBsZW5ndGg6IDAKICAgICAgICB9LAogICAgICAgIGxpbmtlZDogbnVsbCwKICAgICAgICB1c2VyRGF0YTogbnVsbAogICAgICB9CiAgICB9CgogICAgaWYgKHR5cGUgPT09IDEpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uOiAwLAogICAgICAgIGhhc2gsCiAgICAgICAgYWxsb3dQYXRjaDogZmFsc2UsCiAgICAgICAgcXVvcnVtOiAxLAogICAgICAgIHNpZ25lcnM6IFtzaWduZXIuZGVjb2RlKHN0YXRlKV0sCiAgICAgICAgcHJvbG9ndWU6IG51bGwsCiAgICAgICAgbGlua2VkOiBudWxsLAogICAgICAgIHVzZXJEYXRhOiBudWxsCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogMCwKICAgICAgaGFzaCwKICAgICAgYWxsb3dQYXRjaDogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIHF1b3J1bTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25lcnM6IHNpZ25lckFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIHByb2xvZ3VlOiBudWxsLAogICAgICBsaW5rZWQ6IG51bGwsCiAgICAgIHVzZXJEYXRhOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBmaXhlZDMyQXJyYXkgPSBjLmFycmF5KGMuZml4ZWQzMikKCmNvbnN0IG1hbmlmZXN0ID0gKGV4cG9ydHMubWFuaWZlc3QgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyB2ZXJzaW9uCgogICAgaWYgKG0udmVyc2lvbiA9PT0gMCkgcmV0dXJuIG1hbmlmZXN0djAucHJlZW5jb2RlKHN0YXRlLCBtKQoKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBoYXNoZXMucHJlZW5jb2RlKHN0YXRlLCBtLmhhc2gpCgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5xdW9ydW0pCiAgICBzaWduZXJBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmVycykKCiAgICBpZiAobS5wcm9sb2d1ZSkgcHJvbG9ndWUucHJlZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlKQogICAgaWYgKG0ubGlua2VkKSBmaXhlZDMyQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLmxpbmtlZCkKICAgIGlmIChtLnVzZXJEYXRhKSBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0udXNlckRhdGEpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKCiAgICBpZiAobS52ZXJzaW9uID09PSAwKSByZXR1cm4gbWFuaWZlc3R2MC5lbmNvZGUoc3RhdGUsIG0pCgogICAgbGV0IGZsYWdzID0gMAogICAgaWYgKG0uYWxsb3dQYXRjaCkgZmxhZ3MgfD0gTUFOSUZFU1RfUEFUQ0gKICAgIGlmIChtLnByb2xvZ3VlKSBmbGFncyB8PSBNQU5JRkVTVF9QUk9MT0dVRQogICAgaWYgKG0ubGlua2VkKSBmbGFncyB8PSBNQU5JRkVTVF9MSU5LRUQKICAgIGlmIChtLnVzZXJEYXRhKSBmbGFncyB8PSBNQU5JRkVTVF9VU0VSX0RBVEEKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICAgIGhhc2hlcy5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnF1b3J1bSkKICAgIHNpZ25lckFycmF5LmVuY29kZShzdGF0ZSwgbS5zaWduZXJzKQoKICAgIGlmIChtLnByb2xvZ3VlKSBwcm9sb2d1ZS5lbmNvZGUoc3RhdGUsIG0ucHJvbG9ndWUpCiAgICBpZiAobS5saW5rZWQpIGZpeGVkMzJBcnJheS5lbmNvZGUoc3RhdGUsIG0ubGlua2VkKQogICAgaWYgKG0udXNlckRhdGEpIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS51c2VyRGF0YSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgaWYgKHZlcnNpb24gPT09IDApIHJldHVybiBtYW5pZmVzdHYwLmRlY29kZShzdGF0ZSkKICAgIGlmICh2ZXJzaW9uID4gMikgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHZlcnNpb246ICcgKyB2ZXJzaW9uKQoKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGhhc2ggPSBoYXNoZXMuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcXVvcnVtID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHNpZ25lcnMgPSBzaWduZXJBcnJheS5kZWNvZGUoc3RhdGUpCgogICAgY29uc3QgaGFzUGF0Y2ggPSAoZmxhZ3MgJiBNQU5JRkVTVF9QQVRDSCkgIT09IDAKICAgIGNvbnN0IGhhc1Byb2xvZ3VlID0gKGZsYWdzICYgTUFOSUZFU1RfUFJPTE9HVUUpICE9PSAwCiAgICBjb25zdCBoYXNMaW5rZWQgPSAoZmxhZ3MgJiBNQU5JRkVTVF9MSU5LRUQpICE9PSAwCiAgICBjb25zdCBoYXNVc2VyRGF0YSA9IChmbGFncyAmIE1BTklGRVNUX1VTRVJfREFUQSkgIT09IDAKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICBoYXNoLAogICAgICBhbGxvd1BhdGNoOiBoYXNQYXRjaCwKICAgICAgcXVvcnVtLAogICAgICBzaWduZXJzLAogICAgICBwcm9sb2d1ZTogaGFzUHJvbG9ndWUgPyBwcm9sb2d1ZS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgbGlua2VkOiBoYXNMaW5rZWQgPyBmaXhlZDMyQXJyYXkuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHVzZXJEYXRhOiBoYXNVc2VyRGF0YSA/IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9KQoKY29uc3Qgbm9kZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4uaW5kZXgpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLnNpemUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBuLmhhc2gpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uaW5kZXgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLnNpemUpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBuLmhhc2gpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGluZGV4OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2l6ZTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGhhc2g6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBub2RlQXJyYXkgPSBjLmFycmF5KG5vZGUpCgpjb25zdCB3aXJlID0gKGV4cG9ydHMud2lyZSA9IHt9KQoKd2lyZS5oYW5kc2hha2UgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCAxKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5jYXBhYmlsaXR5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnNlZWtzID8gMSA6IDApCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmNhcGFiaWxpdHkpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIHNlZWtzOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgY2FwYWJpbGl0eTogdW5zbGFiKGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpKQogICAgfQogIH0KfQoKY29uc3QgcmVxdWVzdEJsb2NrID0gewogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpbmRleDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVxdWVzdFNlZWsgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBzKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBzLmJ5dGVzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgcy5wYWRkaW5nKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBzKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBzLmJ5dGVzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgcy5wYWRkaW5nKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBieXRlczogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHBhZGRpbmc6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZXF1ZXN0VXBncmFkZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHUpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUuc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgdSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUucmVxdWVzdCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5mb3JrKQoKICAgIGlmIChtLmJsb2NrKSByZXF1ZXN0QmxvY2sucHJlZW5jb2RlKHN0YXRlLCBtLmJsb2NrKQogICAgaWYgKG0uaGFzaCkgcmVxdWVzdEJsb2NrLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgaWYgKG0uc2VlaykgcmVxdWVzdFNlZWsucHJlZW5jb2RlKHN0YXRlLCBtLnNlZWspCiAgICBpZiAobS51cGdyYWRlKSByZXF1ZXN0VXBncmFkZS5wcmVlbmNvZGUoc3RhdGUsIG0udXBncmFkZSkKICAgIGlmIChtLnByaW9yaXR5KSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnByaW9yaXR5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9CiAgICAgIChtLmJsb2NrID8gMSA6IDApIHwKICAgICAgKG0uaGFzaCA/IDIgOiAwKSB8CiAgICAgIChtLnNlZWsgPyA0IDogMCkgfAogICAgICAobS51cGdyYWRlID8gOCA6IDApIHwKICAgICAgKG0ubWFuaWZlc3QgPyAxNiA6IDApIHwKICAgICAgKG0ucHJpb3JpdHkgPyAzMiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5mb3JrKQoKICAgIGlmIChtLmJsb2NrKSByZXF1ZXN0QmxvY2suZW5jb2RlKHN0YXRlLCBtLmJsb2NrKQogICAgaWYgKG0uaGFzaCkgcmVxdWVzdEJsb2NrLmVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgaWYgKG0uc2VlaykgcmVxdWVzdFNlZWsuZW5jb2RlKHN0YXRlLCBtLnNlZWspCiAgICBpZiAobS51cGdyYWRlKSByZXF1ZXN0VXBncmFkZS5lbmNvZGUoc3RhdGUsIG0udXBncmFkZSkKICAgIGlmIChtLnByaW9yaXR5KSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnByaW9yaXR5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgaWQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBmb3JrOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYmxvY2s6IGZsYWdzICYgMSA/IHJlcXVlc3RCbG9jay5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgaGFzaDogZmxhZ3MgJiAyID8gcmVxdWVzdEJsb2NrLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBzZWVrOiBmbGFncyAmIDQgPyByZXF1ZXN0U2Vlay5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdXBncmFkZTogZmxhZ3MgJiA4ID8gcmVxdWVzdFVwZ3JhZGUuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIG1hbmlmZXN0OiAoZmxhZ3MgJiAxNikgIT09IDAsCiAgICAgIHByaW9yaXR5OiBmbGFncyAmIDMyID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCiAgICB9CiAgfQp9Cgp3aXJlLmNhbmNlbCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZXF1ZXN0KQogIH0sCiAgZGVjb2RlKHN0YXRlLCBtKSB7CiAgICByZXR1cm4gewogICAgICByZXF1ZXN0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgZGF0YVVwZ3JhZGUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1LnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCB1Lm5vZGVzKQogICAgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgdS5hZGRpdGlvbmFsTm9kZXMpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHUuc2lnbmF0dXJlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1LnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgICBub2RlQXJyYXkuZW5jb2RlKHN0YXRlLCB1Lm5vZGVzKQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgdS5hZGRpdGlvbmFsTm9kZXMpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHUuc2lnbmF0dXJlKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgYWRkaXRpb25hbE5vZGVzOiBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBkYXRhU2VlayA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHMpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHMuYnl0ZXMpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBzLm5vZGVzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBzKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBzLmJ5dGVzKQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgcy5ub2RlcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgYnl0ZXM6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBub2Rlczogbm9kZUFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGRhdGFCbG9jayA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIGIudmFsdWUpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBiLnZhbHVlKQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICB2YWx1ZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKSB8fCBFTVBUWSwKICAgICAgbm9kZXM6IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBkYXRhSGFzaCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBub2Rlczogbm9kZUFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUuZGF0YSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmZvcmspCgogICAgaWYgKG0uYmxvY2spIGRhdGFCbG9jay5wcmVlbmNvZGUoc3RhdGUsIG0uYmxvY2spCiAgICBpZiAobS5oYXNoKSBkYXRhSGFzaC5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGlmIChtLnNlZWspIGRhdGFTZWVrLnByZWVuY29kZShzdGF0ZSwgbS5zZWVrKQogICAgaWYgKG0udXBncmFkZSkgZGF0YVVwZ3JhZGUucHJlZW5jb2RlKHN0YXRlLCBtLnVwZ3JhZGUpCiAgICBpZiAobS5tYW5pZmVzdCkgbWFuaWZlc3QucHJlZW5jb2RlKHN0YXRlLCBtLm1hbmlmZXN0KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9CiAgICAgIChtLmJsb2NrID8gMSA6IDApIHwKICAgICAgKG0uaGFzaCA/IDIgOiAwKSB8CiAgICAgIChtLnNlZWsgPyA0IDogMCkgfAogICAgICAobS51cGdyYWRlID8gOCA6IDApIHwKICAgICAgKG0ubWFuaWZlc3QgPyAxNiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmZvcmspCgogICAgaWYgKG0uYmxvY2spIGRhdGFCbG9jay5lbmNvZGUoc3RhdGUsIG0uYmxvY2spCiAgICBpZiAobS5oYXNoKSBkYXRhSGFzaC5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGlmIChtLnNlZWspIGRhdGFTZWVrLmVuY29kZShzdGF0ZSwgbS5zZWVrKQogICAgaWYgKG0udXBncmFkZSkgZGF0YVVwZ3JhZGUuZW5jb2RlKHN0YXRlLCBtLnVwZ3JhZGUpCiAgICBpZiAobS5tYW5pZmVzdCkgbWFuaWZlc3QuZW5jb2RlKHN0YXRlLCBtLm1hbmlmZXN0KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgcmVxdWVzdDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGZvcms6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBibG9jazogZmxhZ3MgJiAxID8gZGF0YUJsb2NrLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBoYXNoOiBmbGFncyAmIDIgPyBkYXRhSGFzaC5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgc2VlazogZmxhZ3MgJiA0ID8gZGF0YVNlZWsuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHVwZ3JhZGU6IGZsYWdzICYgOCA/IGRhdGFVcGdyYWRlLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBtYW5pZmVzdDogZmxhZ3MgJiAxNiA/IG1hbmlmZXN0LmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgp3aXJlLm5vRGF0YSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVhc29uID8gMSA6IDApCiAgICBpZiAobS5yZWFzb24pIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVhc29uKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlYXNvbiA/IDEgOiAwKQogICAgaWYgKG0ucmVhc29uKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlYXNvbikKICB9LAogIGRlY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgcmVxdWVzdCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmbGFncyA9IHN0YXRlLnN0YXJ0IDwgc3RhdGUuZW5kID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCiAgICByZXR1cm4gewogICAgICByZXF1ZXN0LAogICAgICByZWFzb246IGZsYWdzICYgMSA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgfQogIH0KfQoKd2lyZS53YW50ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS51bndhbnQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSwgbSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLnJhbmdlID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBpZiAobS5sZW5ndGggIT09IDEpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAobS5kcm9wID8gMSA6IDApIHwgKG0ubGVuZ3RoID09PSAxID8gMiA6IDApKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGlmIChtLmxlbmd0aCAhPT0gMSkgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBkcm9wOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IChmbGFncyAmIDIpICE9PSAwID8gMSA6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLmJpdGZpZWxkID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludDMyYXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLmJpdGZpZWxkKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50MzJhcnJheS5lbmNvZGUoc3RhdGUsIG0uYml0ZmllbGQpCiAgfSwKICBkZWNvZGUoc3RhdGUsIG0pIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYml0ZmllbGQ6IGMudWludDMyYXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5zeW5jID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZm9yaykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZW1vdGVMZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoCiAgICAgIHN0YXRlLAogICAgICAobS5jYW5VcGdyYWRlID8gMSA6IDApIHwKICAgICAgICAobS51cGxvYWRpbmcgPyAyIDogMCkgfAogICAgICAgIChtLmRvd25sb2FkaW5nID8gNCA6IDApIHwKICAgICAgICAobS5oYXNNYW5pZmVzdCA/IDggOiAwKSB8CiAgICAgICAgKG0uYWxsb3dQdXNoID8gMTYgOiAwKQogICAgKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5mb3JrKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlbW90ZUxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGZvcms6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICByZW1vdGVMZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBjYW5VcGdyYWRlOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgdXBsb2FkaW5nOiAoZmxhZ3MgJiAyKSAhPT0gMCwKICAgICAgZG93bmxvYWRpbmc6IChmbGFncyAmIDQpICE9PSAwLAogICAgICBoYXNNYW5pZmVzdDogKGZsYWdzICYgOCkgIT09IDAsCiAgICAgIGFsbG93UHVzaDogKGZsYWdzICYgMTYpICE9PSAwCiAgICB9CiAgfQp9Cgp3aXJlLnJlb3JnSGludCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZnJvbSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udG8pCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmFuY2VzdG9ycykKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5mcm9tKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS50bykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uYW5jZXN0b3JzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBmcm9tOiBjLnVpbnQuZW5jb2RlKHN0YXRlKSwKICAgICAgdG86IGMudWludC5lbmNvZGUoc3RhdGUpLAogICAgICBhbmNlc3RvcnM6IGMudWludC5lbmNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLmV4dGVuc2lvbiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgbS5uYW1lKQogICAgYy5yYXcucHJlZW5jb2RlKHN0YXRlLCBtLm1lc3NhZ2UpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgbS5uYW1lKQogICAgYy5yYXcuZW5jb2RlKHN0YXRlLCBtLm1lc3NhZ2UpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSksCiAgICAgIG1lc3NhZ2U6IGMucmF3LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGtleVZhbHVlID0gewogIHByZWVuY29kZShzdGF0ZSwgcCkgewogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCBwLmtleSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgcC52YWx1ZSkKICB9LAogIGVuY29kZShzdGF0ZSwgcCkgewogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCBwLmtleSkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgcC52YWx1ZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAga2V5OiBjLnN0cmluZy5kZWNvZGUoc3RhdGUpLAogICAgICB2YWx1ZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgdHJlZVVwZ3JhZGUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1LmZvcmspCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1LmFuY2VzdG9ycykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCB1LnNpZ25hdHVyZSkKICB9LAogIGVuY29kZShzdGF0ZSwgdSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5mb3JrKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5hbmNlc3RvcnMpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgdS5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGZvcms6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBhbmNlc3RvcnM6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGJpdGZpZWxkVXBkYXRlID0gewogIC8vIFRPRE86IGNhbiBtYXliZSBiZSBmb2xkZWQgaW50byBhIEhBVkUgbGF0ZXIgb24gd2l0aCB0aGUgbW9zdCByZWNlbnQgc3BlYwogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIuc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gYi5kcm9wID8gMSA6IDAKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGIuc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgZHJvcDogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qgb3Bsb2cgPSAoZXhwb3J0cy5vcGxvZyA9IHt9KQoKb3Bsb2cuZW50cnkgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgaWYgKG0udXNlckRhdGEpIGtleVZhbHVlLnByZWVuY29kZShzdGF0ZSwgbS51c2VyRGF0YSkKICAgIGlmIChtLnRyZWVOb2Rlcykgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgbS50cmVlTm9kZXMpCiAgICBpZiAobS50cmVlVXBncmFkZSkgdHJlZVVwZ3JhZGUucHJlZW5jb2RlKHN0YXRlLCBtLnRyZWVVcGdyYWRlKQogICAgaWYgKG0uYml0ZmllbGQpIGJpdGZpZWxkVXBkYXRlLnByZWVuY29kZShzdGF0ZSwgbS5iaXRmaWVsZCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgcyA9IHN0YXRlLnN0YXJ0KysKICAgIGxldCBmbGFncyA9IDAKCiAgICBpZiAobS51c2VyRGF0YSkgewogICAgICBmbGFncyB8PSAxCiAgICAgIGtleVZhbHVlLmVuY29kZShzdGF0ZSwgbS51c2VyRGF0YSkKICAgIH0KICAgIGlmIChtLnRyZWVOb2RlcykgewogICAgICBmbGFncyB8PSAyCiAgICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIG0udHJlZU5vZGVzKQogICAgfQogICAgaWYgKG0udHJlZVVwZ3JhZGUpIHsKICAgICAgZmxhZ3MgfD0gNAogICAgICB0cmVlVXBncmFkZS5lbmNvZGUoc3RhdGUsIG0udHJlZVVwZ3JhZGUpCiAgICB9CiAgICBpZiAobS5iaXRmaWVsZCkgewogICAgICBmbGFncyB8PSA4CiAgICAgIGJpdGZpZWxkVXBkYXRlLmVuY29kZShzdGF0ZSwgbS5iaXRmaWVsZCkKICAgIH0KCiAgICBzdGF0ZS5idWZmZXJbc10gPSBmbGFncwogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICB1c2VyRGF0YTogKGZsYWdzICYgMSkgIT09IDAgPyBrZXlWYWx1ZS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdHJlZU5vZGVzOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdHJlZVVwZ3JhZGU6IChmbGFncyAmIDQpICE9PSAwID8gdHJlZVVwZ3JhZGUuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGJpdGZpZWxkOiAoZmxhZ3MgJiA4KSAhPT0gMCA/IGJpdGZpZWxkVXBkYXRlLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBrZXlQYWlyID0gewogIHByZWVuY29kZShzdGF0ZSwga3ApIHsKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwga3AucHVibGljS2V5KQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBrcC5zZWNyZXRLZXkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGtwKSB7CiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIGtwLnB1YmxpY0tleSkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwga3Auc2VjcmV0S2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBwdWJsaWNLZXk6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSksCiAgICAgIHNlY3JldEtleTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVvcmdIaW50ID0gewogIHByZWVuY29kZShzdGF0ZSwgcikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgci5mcm9tKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgci50bykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHIuYW5jZXN0b3JzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCByKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCByLmZyb20pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCByLnRvKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgci5hbmNlc3RvcnMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGZyb206IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICB0bzogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGFuY2VzdG9yczogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlb3JnSGludEFycmF5ID0gYy5hcnJheShyZW9yZ0hpbnQpCgpjb25zdCBoaW50cyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGgpIHsKICAgIHJlb3JnSGludEFycmF5LnByZWVuY29kZShzdGF0ZSwgaC5yZW9yZ3MpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBoLmNvbnRpZ3VvdXNMZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGgpIHsKICAgIHJlb3JnSGludEFycmF5LmVuY29kZShzdGF0ZSwgaC5yZW9yZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBoLmNvbnRpZ3VvdXNMZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHJlb3JnczogcmVvcmdIaW50QXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgY29udGlndW91c0xlbmd0aDogc3RhdGUuc3RhcnQgPCBzdGF0ZS5lbmQgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCmNvbnN0IHRyZWVIZWFkZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCB0KSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB0LmZvcmspCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB0Lmxlbmd0aCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdC5yb290SGFzaCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdC5zaWduYXR1cmUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHQpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHQuZm9yaykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHQubGVuZ3RoKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB0LnJvb3RIYXNoKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB0LnNpZ25hdHVyZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgZm9yazogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHJvb3RIYXNoOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHR5cGVzID0gewogIHByZWVuY29kZShzdGF0ZSwgdCkgewogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCB0LnRyZWUpCiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIHQuYml0ZmllbGQpCiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIHQuc2lnbmVyKQogIH0sCiAgZW5jb2RlKHN0YXRlLCB0KSB7CiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIHQudHJlZSkKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgdC5iaXRmaWVsZCkKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgdC5zaWduZXIpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHRyZWU6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSksCiAgICAgIGJpdGZpZWxkOiBjLnN0cmluZy5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduZXI6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGV4dGVybmFsSGVhZGVyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qga2V5VmFsdWVBcnJheSA9IGMuYXJyYXkoa2V5VmFsdWUpCgpvcGxvZy5oZWFkZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBoKSB7CiAgICBzdGF0ZS5lbmQgKz0gMiAvLyB2ZXJzaW9uICsgZmxhZ3MKICAgIGlmIChoLmV4dGVybmFsKSB7CiAgICAgIGV4dGVybmFsSGVhZGVyLnByZWVuY29kZShzdGF0ZSwgaC5leHRlcm5hbCkKICAgICAgcmV0dXJuCiAgICB9CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBoLmtleSkKICAgIGlmIChoLm1hbmlmZXN0KSBtYW5pZmVzdC5wcmVlbmNvZGUoc3RhdGUsIGgubWFuaWZlc3QpCiAgICBpZiAoaC5rZXlQYWlyKSBrZXlQYWlyLnByZWVuY29kZShzdGF0ZSwgaC5rZXlQYWlyKQogICAga2V5VmFsdWVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIGgudXNlckRhdGEpCiAgICB0cmVlSGVhZGVyLnByZWVuY29kZShzdGF0ZSwgaC50cmVlKQogICAgaGludHMucHJlZW5jb2RlKHN0YXRlLCBoLmhpbnRzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBoKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKQogICAgaWYgKGguZXh0ZXJuYWwpIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMSkgLy8gT05MWSBzZXQgdGhlIGZpcnN0IGJpZyBmb3IgY2xhcml0eQogICAgICBleHRlcm5hbEhlYWRlci5lbmNvZGUoc3RhdGUsIGguZXh0ZXJuYWwpCiAgICAgIHJldHVybgogICAgfQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgKGgubWFuaWZlc3QgPyAyIDogMCkgfCAoaC5rZXlQYWlyID8gNCA6IDApKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgaC5rZXkpCiAgICBpZiAoaC5tYW5pZmVzdCkgbWFuaWZlc3QuZW5jb2RlKHN0YXRlLCBoLm1hbmlmZXN0KQogICAgaWYgKGgua2V5UGFpcikga2V5UGFpci5lbmNvZGUoc3RhdGUsIGgua2V5UGFpcikKICAgIGtleVZhbHVlQXJyYXkuZW5jb2RlKHN0YXRlLCBoLnVzZXJEYXRhKQogICAgdHJlZUhlYWRlci5lbmNvZGUoc3RhdGUsIGgudHJlZSkKICAgIGhpbnRzLmVuY29kZShzdGF0ZSwgaC5oaW50cykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgaWYgKHZlcnNpb24gPiAxKSB7CiAgICAgIHRocm93IElOVkFMSURfT1BMT0dfVkVSU0lPTignSW52YWxpZCBoZWFkZXIgdmVyc2lvbi4gRXhwZWN0ZWQgPD0gMSwgZ290ICcgKyB2ZXJzaW9uKQogICAgfQoKICAgIGlmICh2ZXJzaW9uID09PSAwKSB7CiAgICAgIGNvbnN0IG9sZCA9IHsKICAgICAgICB0eXBlczogdHlwZXMuZGVjb2RlKHN0YXRlKSwKICAgICAgICB1c2VyRGF0YToga2V5VmFsdWVBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICAgIHRyZWU6IHRyZWVIZWFkZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgICBzaWduZXI6IGtleVBhaXIuZGVjb2RlKHN0YXRlKSwKICAgICAgICBoaW50czogaGludHMuZGVjb2RlKHN0YXRlKQogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGV4dGVybmFsOiBudWxsLAogICAgICAgIGtleTogb2xkLnNpZ25lci5wdWJsaWNLZXksCiAgICAgICAgbWFuaWZlc3Q6IHsKICAgICAgICAgIHZlcnNpb246IDAsCiAgICAgICAgICBoYXNoOiBvbGQudHlwZXMudHJlZSwKICAgICAgICAgIGFsbG93UGF0Y2g6IGZhbHNlLAogICAgICAgICAgcXVvcnVtOiAxLAogICAgICAgICAgc2lnbmVyczogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc2lnbmF0dXJlOiBvbGQudHlwZXMuc2lnbmVyLAogICAgICAgICAgICAgIG5hbWVzcGFjZTogREVGQVVMVF9OQU1FU1BBQ0UsCiAgICAgICAgICAgICAgcHVibGljS2V5OiBvbGQuc2lnbmVyLnB1YmxpY0tleQogICAgICAgICAgICB9CiAgICAgICAgICBdLAogICAgICAgICAgcHJvbG9ndWU6IG51bGwsCiAgICAgICAgICBsaW5rZWQ6IG51bGwsCiAgICAgICAgICB1c2VyRGF0YTogbnVsbAogICAgICAgIH0sCiAgICAgICAga2V5UGFpcjogb2xkLnNpZ25lci5zZWNyZXRLZXkgPyBvbGQuc2lnbmVyIDogbnVsbCwKICAgICAgICB1c2VyRGF0YTogb2xkLnVzZXJEYXRhLAogICAgICAgIHRyZWU6IG9sZC50cmVlLAogICAgICAgIGhpbnRzOiBvbGQuaGludHMKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAoZmxhZ3MgJiAxKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZXh0ZXJuYWw6IGV4dGVybmFsSGVhZGVyLmRlY29kZShzdGF0ZSksCiAgICAgICAga2V5OiBudWxsLAogICAgICAgIG1hbmlmZXN0OiBudWxsLAogICAgICAgIGtleVBhaXI6IG51bGwsCiAgICAgICAgdXNlckRhdGE6IG51bGwsCiAgICAgICAgdHJlZTogbnVsbCwKICAgICAgICBoaW50czogbnVsbAogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZXh0ZXJuYWw6IG51bGwsCiAgICAgIGtleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIG1hbmlmZXN0OiAoZmxhZ3MgJiAyKSAhPT0gMCA/IG1hbmlmZXN0LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBrZXlQYWlyOiAoZmxhZ3MgJiA0KSAhPT0gMCA/IGtleVBhaXIuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHVzZXJEYXRhOiBrZXlWYWx1ZUFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIHRyZWU6IHRyZWVIZWFkZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgaGludHM6IGhpbnRzLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHVpbnRBcnJheSA9IGMuYXJyYXkoYy51aW50KQoKY29uc3QgbXVsdGlzaWdJbnB1dCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGlucCkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgaW5wLnNpZ25lcikKICAgIGMuZml4ZWQ2NC5wcmVlbmNvZGUoc3RhdGUsIGlucC5zaWduYXR1cmUpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBpbnAucGF0Y2gpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGlucCkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgaW5wLnNpZ25lcikKICAgIGMuZml4ZWQ2NC5lbmNvZGUoc3RhdGUsIGlucC5zaWduYXR1cmUpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBpbnAucGF0Y2gpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHNpZ25lcjogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25hdHVyZTogYy5maXhlZDY0LmRlY29kZShzdGF0ZSksCiAgICAgIHBhdGNoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcGF0Y2hFbmNvZGluZ3YwID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4ubGVuZ3RoKQogICAgdWludEFycmF5LnByZWVuY29kZShzdGF0ZSwgbi5ub2RlcykKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4ubGVuZ3RoKQogICAgdWludEFycmF5LmVuY29kZShzdGF0ZSwgbi5ub2RlcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBub2RlczogdWludEFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IG11bHRpc2lnSW5wdXR2MCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCsrCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLnNpZ25lcikKICAgIGMuZml4ZWQ2NC5wcmVlbmNvZGUoc3RhdGUsIG4uc2lnbmF0dXJlKQogICAgaWYgKG4ucGF0Y2gpIHBhdGNoRW5jb2Rpbmd2MC5wcmVlbmNvZGUoc3RhdGUsIG4ucGF0Y2gpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4ucGF0Y2ggPyAxIDogMCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uc2lnbmVyKQogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgbi5zaWduYXR1cmUpCiAgICBpZiAobi5wYXRjaCkgcGF0Y2hFbmNvZGluZ3YwLmVuY29kZShzdGF0ZSwgbi5wYXRjaCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgc2lnbmVyOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmZpeGVkNjQuZGVjb2RlKHN0YXRlKSwKICAgICAgcGF0Y2g6IGZsYWdzICYgMSA/IHBhdGNoRW5jb2Rpbmd2MC5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKY29uc3QgbXVsdGlzaWdJbnB1dEFycmF5djAgPSBjLmFycmF5KG11bHRpc2lnSW5wdXR2MCkKY29uc3QgbXVsdGlzaWdJbnB1dEFycmF5ID0gYy5hcnJheShtdWx0aXNpZ0lucHV0KQoKY29uc3QgY29tcGFjdE5vZGUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLmluZGV4KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5zaXplKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbi5oYXNoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLmluZGV4KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5zaXplKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbi5oYXNoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpbmRleDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpemU6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBoYXNoOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgY29tcGFjdE5vZGVBcnJheSA9IGMuYXJyYXkoY29tcGFjdE5vZGUpCgpleHBvcnRzLm11bHRpU2lnbmF0dXJldjAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBzKSB7CiAgICBtdWx0aXNpZ0lucHV0QXJyYXl2MC5wcmVlbmNvZGUoc3RhdGUsIHMucHJvb2ZzKQogICAgY29tcGFjdE5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIHMucGF0Y2gpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHMpIHsKICAgIG11bHRpc2lnSW5wdXRBcnJheXYwLmVuY29kZShzdGF0ZSwgcy5wcm9vZnMpCiAgICBjb21wYWN0Tm9kZUFycmF5LmVuY29kZShzdGF0ZSwgcy5wYXRjaCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcHJvb2ZzOiBtdWx0aXNpZ0lucHV0QXJyYXl2MC5kZWNvZGUoc3RhdGUpLAogICAgICBwYXRjaDogY29tcGFjdE5vZGVBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CgpleHBvcnRzLm11bHRpU2lnbmF0dXJlID0gewogIHByZWVuY29kZShzdGF0ZSwgcykgewogICAgbXVsdGlzaWdJbnB1dEFycmF5LnByZWVuY29kZShzdGF0ZSwgcy5wcm9vZnMpCiAgICBjb21wYWN0Tm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgcy5wYXRjaCkKICB9LAogIGVuY29kZShzdGF0ZSwgcykgewogICAgbXVsdGlzaWdJbnB1dEFycmF5LmVuY29kZShzdGF0ZSwgcy5wcm9vZnMpCiAgICBjb21wYWN0Tm9kZUFycmF5LmVuY29kZShzdGF0ZSwgcy5wYXRjaCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcHJvb2ZzOiBtdWx0aXNpZ0lucHV0QXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgcGF0Y2g6IGNvbXBhY3ROb2RlQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGZsYXQgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQpjb25zdCB7IE1lcmtsZVRyZWUgfSA9IHJlcXVpcmUoJy4vbWVya2xlLXRyZWUnKQpjb25zdCB7IG11bHRpU2lnbmF0dXJlLCBtdWx0aVNpZ25hdHVyZXYwIH0gPSByZXF1aXJlKCcuL21lc3NhZ2VzJykKCm1vZHVsZS5leHBvcnRzID0gewogIGFzc2VtYmxldjAsCiAgYXNzZW1ibGUsCiAgaW5mbGF0ZXYwLAogIGluZmxhdGUsCiAgcGFydGlhbFNpZ25hdHVyZSwKICBzaWduYWJsZUxlbmd0aAp9CgpmdW5jdGlvbiBpbmZsYXRldjAoZGF0YSkgewogIHJldHVybiBjLmRlY29kZShtdWx0aVNpZ25hdHVyZXYwLCBkYXRhKQp9CgpmdW5jdGlvbiBpbmZsYXRlKGRhdGEpIHsKICByZXR1cm4gYy5kZWNvZGUobXVsdGlTaWduYXR1cmUsIGRhdGEpCn0KCmFzeW5jIGZ1bmN0aW9uIHBhcnRpYWxTaWduYXR1cmUoCiAgY29yZSwKICBzaWduZXIsCiAgZnJvbSwKICB0byA9IGNvcmUuc3RhdGUubGVuZ3RoLAogIHNpZ25hdHVyZSA9IGNvcmUuc3RhdGUuc2lnbmF0dXJlCikgewogIGlmIChmcm9tID4gY29yZS5zdGF0ZS5sZW5ndGgpIHJldHVybiBudWxsCiAgY29uc3Qgbm9kZXMgPSB0byA8PSBmcm9tID8gbnVsbCA6IGF3YWl0IHVwZ3JhZGVOb2Rlcyhjb3JlLCBmcm9tLCB0bykKCiAgaWYgKHNpZ25hdHVyZS5ieXRlTGVuZ3RoICE9PSA2NCkgewogICAgc2lnbmF0dXJlID0gYy5kZWNvZGUobXVsdGlTaWduYXR1cmUsIHNpZ25hdHVyZSkucHJvb2ZzWzBdLnNpZ25hdHVyZQogIH0KCiAgcmV0dXJuIHsKICAgIHNpZ25lciwKICAgIHNpZ25hdHVyZSwKICAgIHBhdGNoOiBub2RlcyA/IHRvIC0gZnJvbSA6IDAsCiAgICBub2RlcwogIH0KfQoKYXN5bmMgZnVuY3Rpb24gdXBncmFkZU5vZGVzKGNvcmUsIGZyb20sIHRvKSB7CiAgY29uc3QgcnggPSBjb3JlLnN0YXRlLnN0b3JhZ2UucmVhZCgpCiAgbGV0IHAgPSBudWxsCiAgdHJ5IHsKICAgIHAgPSBhd2FpdCBNZXJrbGVUcmVlLnByb29mKGNvcmUuc3RhdGUsIHJ4LCB7IHVwZ3JhZGU6IHsgc3RhcnQ6IGZyb20sIGxlbmd0aDogdG8gLSBmcm9tIH0gfSkKICB9IGNhdGNoIChlcnIpIHsKICAgIHJ4LmRlc3Ryb3koKQogICAgdGhyb3cgZXJyCiAgfQogIHJ4LnRyeUZsdXNoKCkKICByZXR1cm4gKGF3YWl0IHAuc2V0dGxlKCkpLnVwZ3JhZGUubm9kZXMKfQoKZnVuY3Rpb24gc2lnbmFibGVMZW5ndGgobGVuZ3RocywgcXVvcnVtKSB7CiAgaWYgKHF1b3J1bSA8PSAwKSBxdW9ydW0gPSAxCiAgaWYgKHF1b3J1bSA+IGxlbmd0aHMubGVuZ3RoKSByZXR1cm4gMAoKICByZXR1cm4gbGVuZ3Rocy5zb3J0KGNtcClbcXVvcnVtIC0gMV0KfQoKZnVuY3Rpb24gY21wKGEsIGIpIHsKICByZXR1cm4gYiAtIGEKfQoKZnVuY3Rpb24gYXNzZW1ibGV2MChpbnB1dHMpIHsKICBjb25zdCBwcm9vZnMgPSBbXQogIGNvbnN0IHBhdGNoID0gW10KCiAgZm9yIChjb25zdCB1IG9mIGlucHV0cykgewogICAgcHJvb2ZzLnB1c2goY29tcHJlc3NQcm9vZih1LCBwYXRjaCkpCiAgfQoKICByZXR1cm4gYy5lbmNvZGUobXVsdGlTaWduYXR1cmV2MCwgeyBwcm9vZnMsIHBhdGNoIH0pCn0KCmZ1bmN0aW9uIGFzc2VtYmxlKGlucHV0cykgewogIGNvbnN0IHByb29mcyA9IFtdCiAgY29uc3QgcGF0Y2ggPSBbXQogIGNvbnN0IHNlZW4gPSBuZXcgU2V0KCkKCiAgZm9yIChjb25zdCB1IG9mIGlucHV0cykgewogICAgaWYgKHUubm9kZXMpIHsKICAgICAgZm9yIChjb25zdCBub2RlIG9mIHUubm9kZXMpIHsKICAgICAgICBpZiAoc2Vlbi5oYXMobm9kZS5pbmRleCkpIGNvbnRpbnVlCiAgICAgICAgc2Vlbi5hZGQobm9kZS5pbmRleCkKICAgICAgICBwYXRjaC5wdXNoKG5vZGUpCiAgICAgIH0KICAgIH0KCiAgICBwcm9vZnMucHVzaCh7CiAgICAgIHNpZ25lcjogdS5zaWduZXIsCiAgICAgIHNpZ25hdHVyZTogdS5zaWduYXR1cmUsCiAgICAgIHBhdGNoOiB1LnBhdGNoCiAgICB9KQogIH0KCiAgcmV0dXJuIGMuZW5jb2RlKG11bHRpU2lnbmF0dXJlLCB7IHByb29mcywgcGF0Y2ggfSkKfQoKZnVuY3Rpb24gY29tcGFyZU5vZGUoYSwgYikgewogIGlmIChhLmluZGV4ICE9PSBiLmluZGV4KSByZXR1cm4gZmFsc2UKICBpZiAoYS5zaXplICE9PSBiLnNpemUpIHJldHVybiBmYWxzZQogIHJldHVybiBiNGEuZXF1YWxzKGEuaGFzaCwgYi5oYXNoKQp9CgpmdW5jdGlvbiBjb21wcmVzc1Byb29mKHByb29mLCBub2RlcykgewogIHJldHVybiB7CiAgICBzaWduZXI6IHByb29mLnNpZ25lciwKICAgIHNpZ25hdHVyZTogcHJvb2Yuc2lnbmF0dXJlLAogICAgcGF0Y2g6IHByb29mLnBhdGNoID8gY29tcHJlc3NVcGdyYWRlKHByb29mLCBub2RlcykgOiBudWxsCiAgfQp9CgpmdW5jdGlvbiBjb21wcmVzc1VwZ3JhZGUocCwgbm9kZXMpIHsKICBjb25zdCB1ID0gewogICAgc3RhcnQ6IGZsYXQucmlnaHRTcGFuKHAubm9kZXNbcC5ub2Rlcy5sZW5ndGggLSAxXS5pbmRleCkgLyAyICsgMSwKICAgIGxlbmd0aDogcC5wYXRjaCwKICAgIG5vZGVzOiBbXQogIH0KCiAgZm9yIChjb25zdCBub2RlIG9mIHAubm9kZXMpIHsKICAgIGxldCBwcmVzZW50ID0gZmFsc2UKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKCFjb21wYXJlTm9kZShub2Rlc1tpXSwgbm9kZSkpIGNvbnRpbnVlCgogICAgICB1Lm5vZGVzLnB1c2goaSkKICAgICAgcHJlc2VudCA9IHRydWUKICAgICAgYnJlYWsKICAgIH0KCiAgICBpZiAocHJlc2VudCkgY29udGludWUKICAgIHUubm9kZXMucHVzaChub2Rlcy5wdXNoKG5vZGUpIC0gMSkKICB9CgogIHJldHVybiB1Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBNdXRleCB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLmxvY2tlZCA9IGZhbHNlCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCgogICAgdGhpcy5fZGVzdHJveWluZyA9IG51bGwKICAgIHRoaXMuX2Rlc3Ryb3lFcnJvciA9IG51bGwKICAgIHRoaXMuX3F1ZXVlID0gW10KICAgIHRoaXMuX2VucXVldWUgPSAocmVzb2x2ZSwgcmVqZWN0KSA9PiB0aGlzLl9xdWV1ZS5wdXNoKFtyZXNvbHZlLCByZWplY3RdKQogIH0KCiAgaWRsZSgpIHsKICAgIHJldHVybiB0aGlzLl9xdWV1ZS5sZW5ndGggPT09IDAgJiYgdGhpcy5sb2NrZWQgPT09IGZhbHNlCiAgfQoKICBsb2NrKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCh0aGlzLl9kZXN0cm95RXJyb3IgfHwgbmV3IEVycm9yKCdNdXRleCBoYXMgYmVlbiBkZXN0cm95ZWQnKSkKICAgIH0KICAgIGlmICh0aGlzLmxvY2tlZCkgcmV0dXJuIG5ldyBQcm9taXNlKHRoaXMuX2VucXVldWUpCiAgICB0aGlzLmxvY2tlZCA9IHRydWUKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQogIH0KCiAgdW5sb2NrKCkgewogICAgaWYgKCF0aGlzLl9xdWV1ZS5sZW5ndGgpIHsKICAgICAgdGhpcy5sb2NrZWQgPSBmYWxzZQogICAgICByZXR1cm4KICAgIH0KICAgIHRoaXMuX3F1ZXVlLnNoaWZ0KClbMF0oKQogIH0KCiAgZGVzdHJveShlcnIpIHsKICAgIGlmICghdGhpcy5fZGVzdHJveWluZykgewogICAgICB0aGlzLl9kZXN0cm95aW5nID0gdGhpcy5sb2NrZWQgPyB0aGlzLmxvY2soKS5jYXRjaCgoKSA9PiB7fSkgOiBQcm9taXNlLnJlc29sdmUoKQogICAgfQoKICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQogICAgaWYgKGVycikgdGhpcy5fZGVzdHJveUVycm9yID0gZXJyCgogICAgaWYgKGVycikgewogICAgICB3aGlsZSAodGhpcy5fcXVldWUubGVuZ3RoKSB0aGlzLl9xdWV1ZS5zaGlmdCgpWzFdKGVycikKICAgIH0KCiAgICByZXR1cm4gdGhpcy5fZGVzdHJveWluZwogIH0KfQpjb25zdCBGSUZPID0gcmVxdWlyZSgnZmFzdC1maWZvJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUmVjZWl2ZXJRdWV1ZSB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLnF1ZXVlID0gbmV3IEZJRk8oKQogICAgdGhpcy5wcmlvcml0eSA9IFtdCiAgICB0aGlzLnJlcXVlc3RzID0gbmV3IE1hcCgpCiAgICB0aGlzLmxlbmd0aCA9IDAKICB9CgogIHB1c2gocmVxKSB7CiAgICAvLyBUT0RPOiB1c2UgYSBoZWFwIGF0IHNvbWUgcG9pbnQgaWYgd2Ugd2FubmEgc3VwcG9ydCBtdWx0aXBsZSBwcmlvcwogICAgaWYgKHJlcS5wcmlvcml0eSA+IDApIHRoaXMucHJpb3JpdHkucHVzaChyZXEpCiAgICBlbHNlIHRoaXMucXVldWUucHVzaChyZXEpCgogICAgdGhpcy5yZXF1ZXN0cy5zZXQocmVxLmlkLCByZXEpCiAgICB0aGlzLmxlbmd0aCsrCiAgfQoKICBzaGlmdCgpIHsKICAgIHdoaWxlICh0aGlzLnByaW9yaXR5Lmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgbXNnID0gdGhpcy5wcmlvcml0eS5wb3AoKQogICAgICBjb25zdCByZXEgPSB0aGlzLl9wcm9jZXNzUmVxdWVzdChtc2cpCiAgICAgIGlmIChyZXEgIT09IG51bGwpIHJldHVybiByZXEKICAgIH0KCiAgICB3aGlsZSAodGhpcy5xdWV1ZS5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG1zZyA9IHRoaXMucXVldWUuc2hpZnQoKQogICAgICBjb25zdCByZXEgPSB0aGlzLl9wcm9jZXNzUmVxdWVzdChtc2cpCiAgICAgIGlmIChyZXEgIT09IG51bGwpIHJldHVybiByZXEKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgX3Byb2Nlc3NSZXF1ZXN0KHJlcSkgewogICAgaWYgKHJlcS5ibG9jayB8fCByZXEuaGFzaCB8fCByZXEuc2VlayB8fCByZXEudXBncmFkZSB8fCByZXEubWFuaWZlc3QpIHsKICAgICAgdGhpcy5yZXF1ZXN0cy5kZWxldGUocmVxLmlkKQogICAgICB0aGlzLmxlbmd0aC0tCiAgICAgIHJldHVybiByZXEKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgY2xlYXIoKSB7CiAgICB0aGlzLnF1ZXVlLmNsZWFyKCkKICAgIHRoaXMucHJpb3JpdHkgPSBbXQogICAgdGhpcy5sZW5ndGggPSAwCiAgICB0aGlzLnJlcXVlc3RzLmNsZWFyKCkKICB9CgogIGRlbGV0ZShpZCkgewogICAgY29uc3QgcmVxID0gdGhpcy5yZXF1ZXN0cy5nZXQoaWQpCiAgICBpZiAoIXJlcSkgcmV0dXJuCgogICAgcmVxLmJsb2NrID0gbnVsbAogICAgcmVxLmhhc2ggPSBudWxsCiAgICByZXEuc2VlayA9IG51bGwKICAgIHJlcS51cGdyYWRlID0gbnVsbAogICAgcmVxLm1hbmlmZXN0ID0gZmFsc2UKCiAgICB0aGlzLnJlcXVlc3RzLmRlbGV0ZShpZCkKICAgIHRoaXMubGVuZ3RoLS0KCiAgICBpZiAodGhpcy5sZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5xdWV1ZS5jbGVhcigpCiAgICAgIHRoaXMucHJpb3JpdHkgPSBbXQogICAgfQogIH0KfQpjb25zdCBCaWdTcGFyc2VBcnJheSA9IHJlcXVpcmUoJ2JpZy1zcGFyc2UtYXJyYXknKQpjb25zdCBxdWlja2JpdCA9IHJlcXVpcmUoJy4vY29tcGF0JykucXVpY2tiaXQKCmNvbnN0IEJJVFNfUEVSX1BBR0UgPSAzMjc2OApjb25zdCBCWVRFU19QRVJfUEFHRSA9IEJJVFNfUEVSX1BBR0UgLyA4CmNvbnN0IFdPUkRTX1BFUl9QQUdFID0gQllURVNfUEVSX1BBR0UgLyA0CmNvbnN0IEJJVFNfUEVSX1NFR01FTlQgPSAyMDk3MTUyCmNvbnN0IEJZVEVTX1BFUl9TRUdNRU5UID0gQklUU19QRVJfU0VHTUVOVCAvIDgKY29uc3QgUEFHRVNfUEVSX1NFR01FTlQgPSBCSVRTX1BFUl9TRUdNRU5UIC8gQklUU19QRVJfUEFHRQoKY2xhc3MgUmVtb3RlQml0ZmllbGRQYWdlIHsKICBjb25zdHJ1Y3RvcihpbmRleCwgYml0ZmllbGQsIHNlZ21lbnQpIHsKICAgIHRoaXMuaW5kZXggPSBpbmRleAogICAgdGhpcy5vZmZzZXQgPSBpbmRleCAqIEJZVEVTX1BFUl9QQUdFIC0gc2VnbWVudC5vZmZzZXQKICAgIHRoaXMuYml0ZmllbGQgPSBiaXRmaWVsZAogICAgdGhpcy5zZWdtZW50ID0gc2VnbWVudAoKICAgIHNlZ21lbnQuYWRkKHRoaXMpCiAgfQoKICBnZXQgdHJlZSgpIHsKICAgIHJldHVybiB0aGlzLnNlZ21lbnQudHJlZQogIH0KCiAgZ2V0KGluZGV4KSB7CiAgICByZXR1cm4gcXVpY2tiaXQuZ2V0KHRoaXMuYml0ZmllbGQsIGluZGV4KQogIH0KCiAgc2V0KGluZGV4LCB2YWwpIHsKICAgIGlmIChxdWlja2JpdC5zZXQodGhpcy5iaXRmaWVsZCwgaW5kZXgsIHZhbCkpIHsKICAgICAgdGhpcy50cmVlLnVwZGF0ZSh0aGlzLm9mZnNldCAqIDggKyBpbmRleCkKICAgIH0KICB9CgogIHNldFJhbmdlKHN0YXJ0LCBlbmQsIHZhbCkgewogICAgcXVpY2tiaXQuZmlsbCh0aGlzLmJpdGZpZWxkLCB2YWwsIHN0YXJ0LCBlbmQpCgogICAgbGV0IGkgPSBNYXRoLmZsb29yKHN0YXJ0IC8gMTI4KQogICAgY29uc3QgbiA9IGkgKyBNYXRoLmNlaWwoKGVuZCAtIHN0YXJ0KSAvIDEyOCkKCiAgICB3aGlsZSAoaSA8PSBuKSB0aGlzLnRyZWUudXBkYXRlKHRoaXMub2Zmc2V0ICogOCArIGkrKyAqIDEyOCkKICB9CgogIGZpbmRGaXJzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICByZXR1cm4gcXVpY2tiaXQuZmluZEZpcnN0KHRoaXMuYml0ZmllbGQsIHZhbCwgcG9zaXRpb24pCiAgfQoKICBmaW5kTGFzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICByZXR1cm4gcXVpY2tiaXQuZmluZExhc3QodGhpcy5iaXRmaWVsZCwgdmFsLCBwb3NpdGlvbikKICB9CgogIGluc2VydChzdGFydCwgYml0ZmllbGQpIHsKICAgIHRoaXMuYml0ZmllbGQuc2V0KGJpdGZpZWxkLCBzdGFydCAvIDMyKQogICAgdGhpcy5zZWdtZW50LnJlZnJlc2goKQogIH0KCiAgY2xlYXIoc3RhcnQsIGJpdGZpZWxkKSB7CiAgICBxdWlja2JpdC5jbGVhcih0aGlzLmJpdGZpZWxkLCB7IGZpZWxkOiBiaXRmaWVsZCwgb2Zmc2V0OiBzdGFydCB9KQogIH0KfQoKY2xhc3MgUmVtb3RlQml0ZmllbGRTZWdtZW50IHsKICBjb25zdHJ1Y3RvcihpbmRleCkgewogICAgdGhpcy5pbmRleCA9IGluZGV4CiAgICB0aGlzLm9mZnNldCA9IGluZGV4ICogQllURVNfUEVSX1NFR01FTlQKICAgIHRoaXMudHJlZSA9IHF1aWNrYml0LkluZGV4LmZyb20oW10sIEJZVEVTX1BFUl9TRUdNRU5UKQogICAgdGhpcy5wYWdlcyA9IG5ldyBBcnJheShQQUdFU19QRVJfU0VHTUVOVCkKICAgIHRoaXMucGFnZXNMZW5ndGggPSAwCiAgfQoKICBnZXQgY2h1bmtzKCkgewogICAgcmV0dXJuIHRoaXMudHJlZS5jaHVua3MKICB9CgogIHJlZnJlc2goKSB7CiAgICB0aGlzLnRyZWUgPSBxdWlja2JpdC5JbmRleC5mcm9tKHRoaXMudHJlZS5jaHVua3MsIEJZVEVTX1BFUl9TRUdNRU5UKQogIH0KCiAgYWRkKHBhZ2UpIHsKICAgIGNvbnN0IHBhZ2VJbmRleCA9IHBhZ2UuaW5kZXggLSB0aGlzLmluZGV4ICogUEFHRVNfUEVSX1NFR01FTlQKICAgIGlmIChwYWdlSW5kZXggPj0gdGhpcy5wYWdlc0xlbmd0aCkgdGhpcy5wYWdlc0xlbmd0aCA9IHBhZ2VJbmRleCArIDEKCiAgICB0aGlzLnBhZ2VzW3BhZ2VJbmRleF0gPSBwYWdlCgogICAgY29uc3QgY2h1bmsgPSB7IGZpZWxkOiBwYWdlLmJpdGZpZWxkLCBvZmZzZXQ6IHBhZ2Uub2Zmc2V0IH0KCiAgICB0aGlzLmNodW5rcy5wdXNoKGNodW5rKQoKICAgIGZvciAobGV0IGkgPSB0aGlzLmNodW5rcy5sZW5ndGggLSAyOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBwcmV2ID0gdGhpcy5jaHVua3NbaV0KICAgICAgaWYgKHByZXYub2Zmc2V0IDw9IGNodW5rLm9mZnNldCkgYnJlYWsKICAgICAgdGhpcy5jaHVua3NbaV0gPSBjaHVuawogICAgICB0aGlzLmNodW5rc1tpICsgMV0gPSBwcmV2CiAgICB9CiAgfQoKICBmaW5kRmlyc3QodmFsLCBwb3NpdGlvbikgewogICAgcG9zaXRpb24gPSB0aGlzLnRyZWUuc2tpcEZpcnN0KCF2YWwsIHBvc2l0aW9uKQoKICAgIGxldCBqID0gcG9zaXRpb24gJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChwb3NpdGlvbiAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIGlmIChpID49IFBBR0VTX1BFUl9TRUdNRU5UKSByZXR1cm4gLTEKCiAgICB3aGlsZSAoaSA8IHRoaXMucGFnZXNMZW5ndGgpIHsKICAgICAgY29uc3QgcCA9IHRoaXMucGFnZXNbaV0KCiAgICAgIGxldCBpbmRleCA9IC0xCgogICAgICBpZiAocCkgaW5kZXggPSBwLmZpbmRGaXJzdCh2YWwsIGopCiAgICAgIGVsc2UgaWYgKCF2YWwpIGluZGV4ID0gagoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIGkgKiBCSVRTX1BFUl9QQUdFICsgaW5kZXgKCiAgICAgIGogPSAwCiAgICAgIGkrKwogICAgfQoKICAgIHJldHVybiB2YWwgfHwgdGhpcy5wYWdlc0xlbmd0aCA9PT0gUEFHRVNfUEVSX1NFR01FTlQgPyAtMSA6IHRoaXMucGFnZXNMZW5ndGggKiBCSVRTX1BFUl9QQUdFCiAgfQoKICBmaW5kTGFzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICBwb3NpdGlvbiA9IHRoaXMudHJlZS5za2lwTGFzdCghdmFsLCBwb3NpdGlvbikKCiAgICBsZXQgaiA9IHBvc2l0aW9uICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgbGV0IGkgPSAocG9zaXRpb24gLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICBpZiAoaSA+PSBQQUdFU19QRVJfU0VHTUVOVCkgcmV0dXJuIC0xCgogICAgd2hpbGUgKGkgPj0gMCkgewogICAgICBjb25zdCBwID0gdGhpcy5wYWdlc1tpXQoKICAgICAgbGV0IGluZGV4ID0gLTEKCiAgICAgIGlmIChwKSBpbmRleCA9IHAuZmluZExhc3QodmFsLCBqKQogICAgICBlbHNlIGlmICghdmFsKSBpbmRleCA9IGoKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBpICogQklUU19QRVJfUEFHRSArIGluZGV4CgogICAgICBqID0gQklUU19QRVJfUEFHRSAtIDEKICAgICAgaS0tCiAgICB9CgogICAgcmV0dXJuIC0xCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJlbW90ZUJpdGZpZWxkIHsKICBzdGF0aWMgQklUU19QRVJfUEFHRSA9IEJJVFNfUEVSX1BBR0UKCiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLl9wYWdlcyA9IG5ldyBCaWdTcGFyc2VBcnJheSgpCiAgICB0aGlzLl9zZWdtZW50cyA9IG5ldyBCaWdTcGFyc2VBcnJheSgpCiAgICB0aGlzLl9tYXhTZWdtZW50cyA9IDAKICB9CgogIGdldEJpdGZpZWxkKGluZGV4KSB7CiAgICBjb25zdCBqID0gaW5kZXggJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBjb25zdCBpID0gKGluZGV4IC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgY29uc3QgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQogICAgcmV0dXJuIHAgfHwgbnVsbAogIH0KCiAgZ2V0KGluZGV4KSB7CiAgICBjb25zdCBqID0gaW5kZXggJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBjb25zdCBpID0gKGluZGV4IC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgY29uc3QgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgIHJldHVybiBwID8gcC5nZXQoaikgOiBmYWxzZQogIH0KCiAgc2V0KGluZGV4LCB2YWwpIHsKICAgIGNvbnN0IGogPSBpbmRleCAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGNvbnN0IGkgPSAoaW5kZXggLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICBsZXQgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgIGlmICghcCAmJiB2YWwpIHsKICAgICAgY29uc3QgayA9IE1hdGguZmxvb3IoaSAvIFBBR0VTX1BFUl9TRUdNRU5UKQogICAgICBjb25zdCBzID0gdGhpcy5fc2VnbWVudHMuZ2V0KGspIHx8IHRoaXMuX3NlZ21lbnRzLnNldChrLCBuZXcgUmVtb3RlQml0ZmllbGRTZWdtZW50KGspKQogICAgICBpZiAodGhpcy5fbWF4U2VnbWVudHMgPD0gaykgdGhpcy5fbWF4U2VnbWVudHMgPSBrICsgMQoKICAgICAgcCA9IHRoaXMuX3BhZ2VzLnNldChpLCBuZXcgUmVtb3RlQml0ZmllbGRQYWdlKGksIG5ldyBVaW50MzJBcnJheShXT1JEU19QRVJfUEFHRSksIHMpKQogICAgfQoKICAgIGlmIChwKSBwLnNldChqLCB2YWwpCiAgfQoKICBzZXRSYW5nZShzdGFydCwgZW5kLCB2YWwpIHsKICAgIGxldCBqID0gc3RhcnQgJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChzdGFydCAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIHdoaWxlIChzdGFydCA8IGVuZCkgewogICAgICBsZXQgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgICAgaWYgKCFwICYmIHZhbCkgewogICAgICAgIGNvbnN0IGsgPSBNYXRoLmZsb29yKGkgLyBQQUdFU19QRVJfU0VHTUVOVCkKICAgICAgICBjb25zdCBzID0gdGhpcy5fc2VnbWVudHMuZ2V0KGspIHx8IHRoaXMuX3NlZ21lbnRzLnNldChrLCBuZXcgUmVtb3RlQml0ZmllbGRTZWdtZW50KGspKQogICAgICAgIGlmICh0aGlzLl9tYXhTZWdtZW50cyA8PSBrKSB0aGlzLl9tYXhTZWdtZW50cyA9IGsgKyAxCgogICAgICAgIHAgPSB0aGlzLl9wYWdlcy5zZXQoaSwgbmV3IFJlbW90ZUJpdGZpZWxkUGFnZShpLCBuZXcgVWludDMyQXJyYXkoV09SRFNfUEVSX1BBR0UpLCBzKSkKICAgICAgfQoKICAgICAgY29uc3Qgb2Zmc2V0ID0gaSAqIEJJVFNfUEVSX1BBR0UKICAgICAgY29uc3QgbGFzdCA9IE1hdGgubWluKGVuZCAtIG9mZnNldCwgQklUU19QRVJfUEFHRSkKICAgICAgY29uc3QgcmFuZ2UgPSBsYXN0IC0gagoKICAgICAgaWYgKHApIHAuc2V0UmFuZ2UoaiwgbGFzdCwgdmFsKQoKICAgICAgaiA9IDAKICAgICAgaSsrCiAgICAgIHN0YXJ0ICs9IHJhbmdlCiAgICB9CiAgfQoKICBmaW5kRmlyc3QodmFsLCBwb3NpdGlvbikgewogICAgbGV0IGogPSBwb3NpdGlvbiAmIChCSVRTX1BFUl9TRUdNRU5UIC0gMSkKICAgIGxldCBpID0gKHBvc2l0aW9uIC0gaikgLyBCSVRTX1BFUl9TRUdNRU5UCgogICAgd2hpbGUgKGkgPCB0aGlzLl9tYXhTZWdtZW50cykgewogICAgICBjb25zdCBzID0gdGhpcy5fc2VnbWVudHMuZ2V0KGkpCgogICAgICBsZXQgaW5kZXggPSAtMQoKICAgICAgaWYgKHMpIGluZGV4ID0gcy5maW5kRmlyc3QodmFsLCBqKQogICAgICBlbHNlIGlmICghdmFsKSBpbmRleCA9IGoKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBpICogQklUU19QRVJfU0VHTUVOVCArIGluZGV4CgogICAgICBqID0gMAogICAgICBpKysKICAgIH0KCiAgICAvLyBGb3IgdGhlIHZhbCA9PT0gZmFsc2UgY2FzZSwgd2UgYWx3YXlzIHJldHVybiBhdCBsZWFzdAogICAgLy8gdGhlICdwb3NpdGlvbicsIGFsc28gaWYgbm90aGluZyB3YXMgZm91bmQKICAgIHJldHVybiB2YWwgPyAtMSA6IE1hdGgubWF4KHBvc2l0aW9uLCB0aGlzLl9tYXhTZWdtZW50cyAqIEJJVFNfUEVSX1NFR01FTlQpCiAgfQoKICBmaXJzdFNldChwb3NpdGlvbikgewogICAgcmV0dXJuIHRoaXMuZmluZEZpcnN0KHRydWUsIHBvc2l0aW9uKQogIH0KCiAgZmlyc3RVbnNldChwb3NpdGlvbikgewogICAgcmV0dXJuIHRoaXMuZmluZEZpcnN0KGZhbHNlLCBwb3NpdGlvbikKICB9CgogIGZpbmRMYXN0KHZhbCwgcG9zaXRpb24pIHsKICAgIGxldCBqID0gcG9zaXRpb24gJiAoQklUU19QRVJfU0VHTUVOVCAtIDEpCiAgICBsZXQgaSA9IChwb3NpdGlvbiAtIGopIC8gQklUU19QRVJfU0VHTUVOVAoKICAgIHdoaWxlIChpID49IDApIHsKICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZ21lbnRzLmdldChpKQoKICAgICAgbGV0IGluZGV4ID0gLTEKCiAgICAgIGlmIChzKSBpbmRleCA9IHMuZmluZExhc3QodmFsLCBqKQogICAgICBlbHNlIGlmICghdmFsKSBpbmRleCA9IGoKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBpICogQklUU19QRVJfU0VHTUVOVCArIGluZGV4CgogICAgICBqID0gQklUU19QRVJfU0VHTUVOVCAtIDEKICAgICAgaS0tCiAgICB9CgogICAgcmV0dXJuIC0xCiAgfQoKICBsYXN0U2V0KHBvc2l0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5maW5kTGFzdCh0cnVlLCBwb3NpdGlvbikKICB9CgogIGxhc3RVbnNldChwb3NpdGlvbikgewogICAgcmV0dXJuIHRoaXMuZmluZExhc3QoZmFsc2UsIHBvc2l0aW9uKQogIH0KCiAgaW5zZXJ0KHN0YXJ0LCBiaXRmaWVsZCkgewogICAgaWYgKHN0YXJ0ICUgMzIgIT09IDApIHJldHVybiBmYWxzZQoKICAgIGxldCBsZW5ndGggPSBiaXRmaWVsZC5ieXRlTGVuZ3RoICogOAoKICAgIGxldCBqID0gc3RhcnQgJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChzdGFydCAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIHdoaWxlIChsZW5ndGggPiAwKSB7CiAgICAgIGxldCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCgogICAgICBpZiAoIXApIHsKICAgICAgICBjb25zdCBrID0gTWF0aC5mbG9vcihpIC8gUEFHRVNfUEVSX1NFR01FTlQpCiAgICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZ21lbnRzLmdldChrKSB8fCB0aGlzLl9zZWdtZW50cy5zZXQoaywgbmV3IFJlbW90ZUJpdGZpZWxkU2VnbWVudChrKSkKICAgICAgICBpZiAodGhpcy5fbWF4U2VnbWVudHMgPD0gaykgdGhpcy5fbWF4U2VnbWVudHMgPSBrICsgMQoKICAgICAgICBwID0gdGhpcy5fcGFnZXMuc2V0KGksIG5ldyBSZW1vdGVCaXRmaWVsZFBhZ2UoaSwgbmV3IFVpbnQzMkFycmF5KFdPUkRTX1BFUl9QQUdFKSwgcykpCiAgICAgIH0KCiAgICAgIGNvbnN0IGVuZCA9IE1hdGgubWluKGogKyBsZW5ndGgsIEJJVFNfUEVSX1BBR0UpCiAgICAgIGNvbnN0IHJhbmdlID0gZW5kIC0gagoKICAgICAgcC5pbnNlcnQoaiwgYml0ZmllbGQuc3ViYXJyYXkoMCwgcmFuZ2UgLyAzMikpCgogICAgICBiaXRmaWVsZCA9IGJpdGZpZWxkLnN1YmFycmF5KHJhbmdlIC8gMzIpCgogICAgICBqID0gMAogICAgICBpKysKICAgICAgbGVuZ3RoIC09IHJhbmdlCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIGNsZWFyKHN0YXJ0LCBiaXRmaWVsZCkgewogICAgaWYgKHN0YXJ0ICUgMzIgIT09IDApIHJldHVybiBmYWxzZQoKICAgIGxldCBsZW5ndGggPSBiaXRmaWVsZC5ieXRlTGVuZ3RoICogOAoKICAgIGxldCBqID0gc3RhcnQgJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChzdGFydCAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIHdoaWxlIChsZW5ndGggPiAwKSB7CiAgICAgIGxldCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCgogICAgICBpZiAoIXApIHsKICAgICAgICBjb25zdCBrID0gTWF0aC5mbG9vcihpIC8gUEFHRVNfUEVSX1NFR01FTlQpCiAgICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZ21lbnRzLmdldChrKSB8fCB0aGlzLl9zZWdtZW50cy5zZXQoaywgbmV3IFJlbW90ZUJpdGZpZWxkU2VnbWVudChrKSkKICAgICAgICBpZiAodGhpcy5fbWF4U2VnbWVudHMgPD0gaykgdGhpcy5fbWF4U2VnbWVudHMgPSBrICsgMQoKICAgICAgICBwID0gdGhpcy5fcGFnZXMuc2V0KGksIG5ldyBSZW1vdGVCaXRmaWVsZFBhZ2UoaSwgbmV3IFVpbnQzMkFycmF5KFdPUkRTX1BFUl9QQUdFKSwgcykpCiAgICAgIH0KCiAgICAgIGNvbnN0IGVuZCA9IE1hdGgubWluKGogKyBsZW5ndGgsIEJJVFNfUEVSX1BBR0UpCiAgICAgIGNvbnN0IHJhbmdlID0gZW5kIC0gagoKICAgICAgcC5jbGVhcihqLCBiaXRmaWVsZC5zdWJhcnJheSgwLCByYW5nZSAvIDMyKSkKCiAgICAgIGJpdGZpZWxkID0gYml0ZmllbGQuc3ViYXJyYXkocmFuZ2UgLyAzMikKCiAgICAgIGogPSAwCiAgICAgIGkrKwogICAgICBsZW5ndGggLT0gcmFuZ2UKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KfQovKiBERVYgRE9DUwogIEV2ZXJ5IGh5cGVyY29yZSBoYXMgb25lIFJlcGxpY2F0b3Igb2JqZWN0IG1hbmFnaW5nIGl0cyBjb25uZWN0aW9ucyB0byBvdGhlciBwZWVycy4KICBUaGVyZSBpcyBvbmUgUGVlciBvYmplY3QgcGVyIHBlZXIgY29ubmVjdGVkIHRvIHRoZSBIeXBlcmNvcmUuCiAgSHlwZXJjb3JlcyBkbyBub3Qga25vdyBhYm91dCBvdGhlciBoeXBlcmNvcmVzLCBzbyB3aGVuIGEgcGVlciBpcyBjb25uZWN0ZWQgdG8gbXVsdGlwbGUgY29yZXMsIHRoZXJlIGV4aXN0cyBvbmUgUGVlciBvYmplY3QgcGVyIGNvcmUuCgogIEh5cGVyY29yZSBpbmRpY2F0ZXMgYmxvY2sgc2hvdWxkIGJlIGRvd25sb2FkZWQgdGhyb3VnaCBtZXRob2RzIGxpa2UgUmVwbGljYXRvci5hZGRSYW5nZSBvciBSZXBsaWNhdG9yLmFkZEJsb2NrCiAgSHlwZXJjb3JlIGNhbGxzIFJlcGxpY2F0b3IudXBkYXRlQWN0aXZpdHkgZXZlcnkgdGltZSBhIGh5cGVyY29yZSBzZXNzaW9uIG9wZW5zL2Nsb3NlcwogIFJlcGxpY2F0b3IudXBkYXRlQWN0aXZpdHkgZW5zdXJlcyB0aGUgSHlwZXJjb3JlIGlzIGRvd25sb2FkaW5nIGJsb2NrcyBhcyBleHBlY3RlZAogIFJlcGxpY2F0b3Iga2VlcHMgdHJhY2sgb2Y6CiAgICAtIFdoaWNoIGJsb2NrcyBuZWVkIHRvIGJlIGRvd25sb2FkZWQgKFJlcGxpY2F0b3IuX2Jsb2NrcykKICAgIC0gV2hpY2ggYmxvY2tzIGN1cnJlbnRseSBoYXZlIGluZmxpZ2h0IHJlcXVlc3RzIChSZXBsaWNhdG9yLl9pbmZsaWdodCkKCiAgQmxvY2tzIGFyZSByZXF1ZXN0ZWQgZnJvbSByZW1vdGUgcGVlcnMgYnkgUGVlciBvYmplY3RzLiBUaGUgZmxvdyBpczoKICAgIC0gVGhlIHJlcGxpY2F0b3IncyB1cGRhdGVQZWVyIG1ldGhvZCBnZXRzIGNhbGxlZAogICAgLSBUaGUgcmVwbGljYXRvciBkZXRlY3RzIHdoZXRoZXIgdGhlIFBlZXIgY2FuIGFjY2VwdCBtb3JlIHJlcXVlc3RzIChmb3IgZXhhbXBsZSBieSBjaGVja2luZyBpZiBpdCdzIG1heGVkIG91dCBvbiBpbmZsaWdodCBibG9ja3MpCiAgICAtIFRoZSByZXBsaWNhdG9yIHRoZW4gdGVsbHMgdGhlIFBlZXIgd2hhdCB0byByZXF1ZXN0IChlLmcuIFBlZXJfcmVxdWVzdFJhbmdlIG9yIFBlZXIuX3JlcXVlc3RCbG9jayBtZXRob2RzKQoKICBUaGUgUGVlciBvYmplY3QgaXMgcmVzcG9uc2libGUgZm9yIHRyYWNraW5nCiAgICAtIFdoaWNoIGJsb2NrcyBkb2VzIHRoZSBQZWVyIGhhdmUgYXZhaWxhYmxlICh0cmFja2VkIGluIHJlbW90ZUJpdGZpZWxkKQogICAgLSBXaGljaCBibG9ja3MgYXJlIHlvdSBhY3RpdmVseSBsb29raW5nIGZvciBmcm9tIHRoaXMgcGVlciAodHJhY2tlZCBpbiBtaXNzaW5nQmxvY2tzKQogICAgLSBIb3cgbWFueSBibG9ja3MgYXJlIGN1cnJlbnRseSBpbmZsaWdodCAodHJhY2tlZCBpbiBpbmZsaWdodCkKICBUaGUgUGVlciB1c2VzIHRoaXMgaW5mb3JtYXRpb24gdG8gZGVjaWRlIHdoaWNoIGJsb2NrcyB0byByZXF1ZXN0IGZyb20gdGhlIHBlZXIgaW4gcmVzcG9uc2UgdG8gX3JlcXVlc3RSYW5nZSByZXF1ZXN0cyBhbmQgdGhlIGxpa2UuCiovCgpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IFJhbmRvbUl0ZXJhdG9yID0gcmVxdWlyZSgncmFuZG9tLWFycmF5LWl0ZXJhdG9yJykKY29uc3QgZmxhdFRyZWUgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQpjb25zdCBNdXRleCA9IHJlcXVpcmUoJy4vbXV0ZXgnKQpjb25zdCBSZWNlaXZlclF1ZXVlID0gcmVxdWlyZSgnLi9yZWNlaXZlci1xdWV1ZScpCmNvbnN0IEhvdHN3YXBRdWV1ZSA9IHJlcXVpcmUoJy4vaG90c3dhcC1xdWV1ZScpCmNvbnN0IFJlbW90ZUJpdGZpZWxkID0gcmVxdWlyZSgnLi9yZW1vdGUtYml0ZmllbGQnKQpjb25zdCB7IE1lcmtsZVRyZWUgfSA9IHJlcXVpcmUoJy4vbWVya2xlLXRyZWUnKQpjb25zdCB7CiAgUkVRVUVTVF9DQU5DRUxMRUQsCiAgUkVRVUVTVF9USU1FT1VULAogIElOVkFMSURfQ0FQQUJJTElUWSwKICBTTkFQU0hPVF9OT1RfQVZBSUxBQkxFLAogIEFTU0VSVElPTgp9ID0gcmVxdWlyZSgnaHlwZXJjb3JlLWVycm9ycycpCmNvbnN0IG0gPSByZXF1aXJlKCcuL21lc3NhZ2VzJykKY29uc3QgY2FwcyA9IHJlcXVpcmUoJy4vY2FwcycpCgpjb25zdCBERUZBVUxUX01BWF9JTkZMSUdIVCA9IFsxNiwgNTEyXQpjb25zdCBTQ0FMRV9MQVRFTkNZID0gNTAKY29uc3QgREVGQVVMVF9TRUdNRU5UX1NJWkUgPSAyNTYgKiAxMDI0ICogOCAvLyAyNTYgS2lCIGluIGJpdHMKY29uc3QgTk9UX0RPV05MT0FESU5HX1NMQUNLID0gKDIwMDAwICsgTWF0aC5yYW5kb20oKSAqIDIwMDAwKSB8IDAKY29uc3QgTUFYX1BFRVJTX1VQR1JBREUgPSAzCmNvbnN0IExBU1RfQkxPQ0tTID0gMjU2CmNvbnN0IE1BWF9SRU1PVEVfU0VHTUVOVFMgPSAyMDQ4Cgpjb25zdCBNQVhfUkFOR0VTID0gNjQKCmNvbnN0IE5PVF9BVkFJTEFCTEUgPSAxCmNvbnN0IElOVkFMSURfUkVRVUVTVCA9IDIKY29uc3QgTUFYX0lOVkFMSURfUkVRVUVTVFMgPSA2NApjb25zdCBNQVhfQkFDS09GRlMgPSBNQVhfSU5WQUxJRF9SRVFVRVNUUyAvIDIKCmNvbnN0IFBSSU9SSVRZID0gewogIE5PUk1BTDogMCwKICBISUdIOiAxLAogIFZFUllfSElHSDogMiwKICBDQU5DRUxMRUQ6IDI1NSAvLyByZXNlcnZlZCB0byBtYXJrIGNhbmNlbGxhdGlvbgp9CgpjbGFzcyBBdHRhY2hhYmxlIHsKICBjb25zdHJ1Y3RvcihyZXBsaWNhdG9yKSB7CiAgICB0aGlzLnJlcGxpY2F0b3IgPSByZXBsaWNhdG9yCiAgICB0aGlzLnJlc29sdmVkID0gZmFsc2UKICAgIHRoaXMucHJvY2Vzc2luZyA9IGZhbHNlCiAgICB0aGlzLnJlZnMgPSBbXQogIH0KCiAgYXR0YWNoKHNlc3Npb24pIHsKICAgIGNvbnN0IHIgPSB7CiAgICAgIGNvbnRleHQ6IHRoaXMsCiAgICAgIHNlc3Npb24sCiAgICAgIHNpbmRleDogMCwKICAgICAgcmluZGV4OiAwLAogICAgICBzbmFwc2hvdDogdHJ1ZSwKICAgICAgcmVzb2x2ZTogbnVsbCwKICAgICAgcmVqZWN0OiBudWxsLAogICAgICBwcm9taXNlOiBudWxsLAogICAgICB0aW1lb3V0OiBudWxsCiAgICB9CgogICAgci5zaW5kZXggPSBzZXNzaW9uLnB1c2gocikgLSAxCiAgICByLnJpbmRleCA9IHRoaXMucmVmcy5wdXNoKHIpIC0gMQogICAgci5wcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICByLnJlc29sdmUgPSByZXNvbHZlCiAgICAgIHIucmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIHJldHVybiByCiAgfQoKICBkZXRhY2gociwgZXJyID0gbnVsbCkgewogICAgaWYgKHIuY29udGV4dCAhPT0gdGhpcykgcmV0dXJuIGZhbHNlCgogICAgdGhpcy5fZGV0YWNoKHIpCiAgICB0aGlzLl9jYW5jZWwociwgZXJyKQogICAgdGhpcy5nYygpCgogICAgcmV0dXJuIHRydWUKICB9CgogIF9kZXRhY2gocikgewogICAgY29uc3QgcmggPSB0aGlzLnJlZnMucG9wKCkKICAgIGNvbnN0IHNoID0gci5zZXNzaW9uLnBvcCgpCgogICAgaWYgKHIucmluZGV4IDwgdGhpcy5yZWZzLmxlbmd0aCkgdGhpcy5yZWZzWyhyaC5yaW5kZXggPSByLnJpbmRleCldID0gcmgKICAgIGlmIChyLnNpbmRleCA8IHIuc2Vzc2lvbi5sZW5ndGgpIHIuc2Vzc2lvblsoc2guc2luZGV4ID0gci5zaW5kZXgpXSA9IHNoCgogICAgZGVzdHJveVJlcXVlc3RUaW1lb3V0KHIpCiAgICByLmNvbnRleHQgPSBudWxsCgogICAgcmV0dXJuIHIKICB9CgogIGdjKCkgewogICAgaWYgKHRoaXMucmVmcy5sZW5ndGggPT09IDAgJiYgIXRoaXMucHJvY2Vzc2luZykgdGhpcy5fdW5yZWYoKQogIH0KCiAgcHJvY2Vzc2VkKCkgewogICAgdGhpcy5wcm9jZXNzaW5nID0gZmFsc2UKICAgIHRoaXMuZ2MoKQogIH0KCiAgX2NhbmNlbChyLCBlcnIpIHsKICAgIHIucmVqZWN0KGVyciB8fCBSRVFVRVNUX0NBTkNFTExFRCgpKQogIH0KCiAgX3VucmVmKCkgewogICAgLy8gb3ZlcndyaXRlIG1lCiAgfQoKICByZXNvbHZlKHZhbCkgewogICAgdGhpcy5yZXNvbHZlZCA9IHRydWUKICAgIHdoaWxlICh0aGlzLnJlZnMubGVuZ3RoID4gMCkgewogICAgICB0aGlzLl9kZXRhY2godGhpcy5yZWZzW3RoaXMucmVmcy5sZW5ndGggLSAxXSkucmVzb2x2ZSh2YWwpCiAgICB9CiAgfQoKICByZWplY3QoZXJyKSB7CiAgICB0aGlzLnJlc29sdmVkID0gdHJ1ZQogICAgd2hpbGUgKHRoaXMucmVmcy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuX2RldGFjaCh0aGlzLnJlZnNbdGhpcy5yZWZzLmxlbmd0aCAtIDFdKS5yZWplY3QoZXJyKQogICAgfQogIH0KCiAgc2V0VGltZW91dChyLCBtcykgewogICAgZGVzdHJveVJlcXVlc3RUaW1lb3V0KHIpCiAgICByLnRpbWVvdXQgPSBzZXRUaW1lb3V0KG9ucmVxdWVzdHRpbWVvdXQsIG1zLCByKQogIH0KfQoKY2xhc3MgQmxvY2tSZXF1ZXN0IGV4dGVuZHMgQXR0YWNoYWJsZSB7CiAgY29uc3RydWN0b3IocmVwbGljYXRvciwgdHJhY2tlciwgaW5kZXgsIHByaW9yaXR5KSB7CiAgICBzdXBlcihyZXBsaWNhdG9yKQoKICAgIHRoaXMuaW5kZXggPSBpbmRleAogICAgdGhpcy5wcmlvcml0eSA9IHByaW9yaXR5CiAgICB0aGlzLmluZmxpZ2h0ID0gW10KICAgIHRoaXMucXVldWVkID0gZmFsc2UKICAgIHRoaXMuaG90c3dhcCA9IG51bGwKICAgIHRoaXMudHJhY2tlciA9IHRyYWNrZXIKICB9CgogIF91bnJlZigpIHsKICAgIHRoaXMucXVldWVkID0gZmFsc2UKCiAgICBmb3IgKGNvbnN0IHJlcSBvZiB0aGlzLmluZmxpZ2h0KSB7CiAgICAgIHJlcS5wZWVyLl9jYW5jZWxSZXF1ZXN0KHJlcSkKICAgIH0KCiAgICB0aGlzLnRyYWNrZXIucmVtb3ZlKHRoaXMuaW5kZXgpCiAgICByZW1vdmVIb3Rzd2FwKHRoaXMpCiAgfQp9CgpjbGFzcyBSYW5nZVJlcXVlc3QgZXh0ZW5kcyBBdHRhY2hhYmxlIHsKICBjb25zdHJ1Y3RvcihyZXBsaWNhdG9yLCByYW5nZXMsIHN0YXJ0LCBlbmQsIGxpbmVhciwgaWZBdmFpbGFibGUsIGJsb2NrcykgewogICAgc3VwZXIocmVwbGljYXRvcikKCiAgICB0aGlzLnN0YXJ0ID0gc3RhcnQKICAgIHRoaXMuZW5kID0gZW5kCiAgICB0aGlzLmxpbmVhciA9IGxpbmVhcgogICAgdGhpcy5pZkF2YWlsYWJsZSA9IGlmQXZhaWxhYmxlCiAgICB0aGlzLmJsb2NrcyA9IGJsb2NrcwogICAgdGhpcy5yYW5nZXMgPSByYW5nZXMKICAgIHJhbmdlcy5wdXNoKHRoaXMpCgogICAgaWYgKHRoaXMuZW5kID09PSAtMSkgewogICAgICB0aGlzLnJlcGxpY2F0b3IuX2Fsd2F5c0xhdGVzdEJsb2NrKysKICAgIH0KCiAgICAvLyBBcyBwYXNzZWQgYnkgdGhlIHVzZXIsIGltbXV0CiAgICB0aGlzLnVzZXJTdGFydCA9IHN0YXJ0CiAgICB0aGlzLnVzZXJFbmQgPSBlbmQKICB9CgogIF91bnJlZigpIHsKICAgIGNvbnN0IHJhbmdlSW5kZXggPSB0aGlzLnJhbmdlcy5pbmRleE9mKHRoaXMpCiAgICBpZiAocmFuZ2VJbmRleCA9PT0gLTEpIHJldHVybgoKICAgIGNvbnN0IGggPSB0aGlzLnJhbmdlcy5wb3AoKQogICAgaWYgKGggIT09IHRoaXMpIHsKICAgICAgdGhpcy5yYW5nZXNbcmFuZ2VJbmRleF0gPSBoCiAgICB9CgogICAgaWYgKHRoaXMuZW5kID09PSAtMSkgewogICAgICB0aGlzLnJlcGxpY2F0b3IuX2Fsd2F5c0xhdGVzdEJsb2NrLS0KICAgIH0KICB9CgogIF9jYW5jZWwocikgewogICAgci5yZXNvbHZlKGZhbHNlKQogIH0KfQoKY2xhc3MgVXBncmFkZVJlcXVlc3QgZXh0ZW5kcyBBdHRhY2hhYmxlIHsKICBjb25zdHJ1Y3RvcihyZXBsaWNhdG9yLCBmb3JrLCBsZW5ndGgpIHsKICAgIHN1cGVyKHJlcGxpY2F0b3IpCgogICAgdGhpcy5mb3JrID0gZm9yawogICAgdGhpcy5sZW5ndGggPSBsZW5ndGgKICAgIHRoaXMuaW5mbGlnaHQgPSBbXQogIH0KCiAgX3VucmVmKCkgewogICAgaWYgKHRoaXMucmVwbGljYXRvci5lYWdlclVwZ3JhZGUgPT09IHRydWUgfHwgdGhpcy5pbmZsaWdodC5sZW5ndGggPiAwKSByZXR1cm4KICAgIHRoaXMucmVwbGljYXRvci5fdXBncmFkZSA9IG51bGwKICB9CgogIF9jYW5jZWwocikgewogICAgci5yZXNvbHZlKGZhbHNlKQogIH0KfQoKY2xhc3MgU2Vla1JlcXVlc3QgZXh0ZW5kcyBBdHRhY2hhYmxlIHsKICBjb25zdHJ1Y3RvcihyZXBsaWNhdG9yLCBzZWVrcywgc2Vla2VyKSB7CiAgICBzdXBlcihyZXBsaWNhdG9yKQoKICAgIHRoaXMuc2Vla2VyID0gc2Vla2VyCiAgICB0aGlzLmluZmxpZ2h0ID0gW10KICAgIHRoaXMuc2Vla3MgPSBzZWVrcwogIH0KCiAgX3VucmVmKCkgewogICAgaWYgKHRoaXMuaW5mbGlnaHQubGVuZ3RoID4gMCkgcmV0dXJuCiAgICBjb25zdCBpID0gdGhpcy5zZWVrcy5pbmRleE9mKHRoaXMpCiAgICBpZiAoaSA9PT0gLTEpIHJldHVybgogICAgY29uc3QgaCA9IHRoaXMuc2Vla3MucG9wKCkKICAgIGlmIChpIDwgdGhpcy5zZWVrcy5sZW5ndGgpIHRoaXMuc2Vla3NbaV0gPSBoCiAgfQp9CgpjbGFzcyBJbmZsaWdodFRyYWNrZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5fcmVxdWVzdHMgPSBbXQogICAgdGhpcy5fZnJlZSA9IFtdCiAgICB0aGlzLl9hY3RpdmUgPSAwCiAgfQoKICBnZXQgaWRsZSgpIHsKICAgIHJldHVybiB0aGlzLl9hY3RpdmUgPT09IDAKICB9CgogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIGZvciAoY29uc3QgcmVxIG9mIHRoaXMuX3JlcXVlc3RzKSB7CiAgICAgIGlmIChyZXEgIT09IG51bGwpIHlpZWxkIHJlcQogICAgfQogIH0KCiAgYWRkKHJlcSkgewogICAgY29uc3QgaWQgPSB0aGlzLl9mcmVlLmxlbmd0aCA/IHRoaXMuX2ZyZWUucG9wKCkgOiB0aGlzLl9yZXF1ZXN0cy5wdXNoKG51bGwpCiAgICByZXEuaWQgPSBpZAogICAgdGhpcy5fcmVxdWVzdHNbaWQgLSAxXSA9IHJlcQogICAgdGhpcy5fYWN0aXZlKysKICAgIHJldHVybiByZXEKICB9CgogIGdldChpZCkgewogICAgcmV0dXJuIGlkIDw9IHRoaXMuX3JlcXVlc3RzLmxlbmd0aCA/IHRoaXMuX3JlcXVlc3RzW2lkIC0gMV0gOiBudWxsCiAgfQoKICByZW1vdmUoaWQsIHJvdW5kdHJpcCkgewogICAgaWYgKGlkID4gdGhpcy5fcmVxdWVzdHMubGVuZ3RoKSByZXR1cm4KICAgIGlmICh0aGlzLl9yZXF1ZXN0c1tpZCAtIDFdKSB0aGlzLl9hY3RpdmUtLQogICAgdGhpcy5fcmVxdWVzdHNbaWQgLSAxXSA9IG51bGwKICAgIGlmIChyb3VuZHRyaXAgPT09IHRydWUpIHRoaXMuX2ZyZWUucHVzaChpZCkKICB9CgogIHJldXNhYmxlKGlkKSB7CiAgICB0aGlzLl9mcmVlLnB1c2goaWQpCiAgfQp9CgpjbGFzcyBCbG9ja1RyYWNrZXIgewogIGNvbnN0cnVjdG9yKHJlcGxpY2F0b3IpIHsKICAgIHRoaXMuX3JlcGxpY2F0b3IgPSByZXBsaWNhdG9yCiAgICB0aGlzLl9tYXAgPSBuZXcgTWFwKCkKICB9CgogIFtTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgcmV0dXJuIHRoaXMuX21hcC52YWx1ZXMoKQogIH0KCiAgaXNFbXB0eSgpIHsKICAgIHJldHVybiB0aGlzLl9tYXAuc2l6ZSA9PT0gMAogIH0KCiAgaGFzKGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5fbWFwLmhhcyhpbmRleCkKICB9CgogIGdldChpbmRleCkgewogICAgcmV0dXJuIHRoaXMuX21hcC5nZXQoaW5kZXgpIHx8IG51bGwKICB9CgogIGFkZChpbmRleCwgcHJpb3JpdHkpIHsKICAgIGxldCBiID0gdGhpcy5fbWFwLmdldChpbmRleCkKICAgIGlmIChiKSByZXR1cm4gYgoKICAgIGIgPSBuZXcgQmxvY2tSZXF1ZXN0KHRoaXMuX3JlcGxpY2F0b3IsIHRoaXMsIGluZGV4LCBwcmlvcml0eSkKICAgIHRoaXMuX21hcC5zZXQoaW5kZXgsIGIpCgogICAgcmV0dXJuIGIKICB9CgogIHJlbW92ZShpbmRleCkgewogICAgY29uc3QgYiA9IHRoaXMuZ2V0KGluZGV4KQogICAgdGhpcy5fbWFwLmRlbGV0ZShpbmRleCkKICAgIHJldHVybiBiCiAgfQp9CgpjbGFzcyBSb3VuZHRyaXBRdWV1ZSB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLnF1ZXVlID0gW10KICAgIHRoaXMudGljayA9IDAKICB9CgogIGNsZWFyKCkgewogICAgY29uc3QgaWRzID0gbmV3IEFycmF5KHRoaXMucXVldWUubGVuZ3RoKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpZHMubGVuZ3RoOyBpKyspIHsKICAgICAgaWRzW2ldID0gdGhpcy5xdWV1ZVtpXVsxXQogICAgfQoKICAgIHRoaXMucXVldWUgPSBbXQoKICAgIHJldHVybiBpZHMKICB9CgogIGFkZChpZCkgewogICAgdGhpcy5xdWV1ZS5wdXNoKFsrK3RoaXMudGljaywgaWRdKQogIH0KCiAgZmx1c2godGljaykgewogICAgbGV0IGZsdXNoZWQgPSBudWxsCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0aGlzLnF1ZXVlW2ldWzBdID4gdGljaykgYnJlYWsKICAgICAgaWYgKGZsdXNoZWQgPT09IG51bGwpIGZsdXNoZWQgPSBbXQogICAgICBmbHVzaGVkLnB1c2godGhpcy5xdWV1ZVtpXVsxXSkKICAgIH0KCiAgICBpZiAoZmx1c2hlZCAhPT0gbnVsbCkgdGhpcy5xdWV1ZS5zcGxpY2UoMCwgZmx1c2hlZC5sZW5ndGgpCiAgICByZXR1cm4gZmx1c2hlZAogIH0KfQoKY2xhc3MgUHJvb2ZSZXF1ZXN0IHsKICBjb25zdHJ1Y3Rvcihtc2csIHByb29mLCBibG9jaywgbWFuaWZlc3QpIHsKICAgIHRoaXMubXNnID0gbXNnCiAgICB0aGlzLnByb29mID0gcHJvb2YKICAgIHRoaXMuYmxvY2sgPSBibG9jawogICAgdGhpcy5tYW5pZmVzdCA9IG1hbmlmZXN0CiAgfQoKICBhc3luYyBmdWxmaWxsKCkgewogICAgaWYgKHRoaXMucHJvb2YgPT09IG51bGwpIHJldHVybiBudWxsCgogICAgY29uc3QgW3Byb29mLCBibG9ja10gPSBhd2FpdCBQcm9taXNlLmFsbChbdGhpcy5wcm9vZi5zZXR0bGUoKSwgdGhpcy5ibG9ja10pCgogICAgaWYgKHRoaXMubWFuaWZlc3QpIHByb29mLm1hbmlmZXN0ID0gdGhpcy5tYW5pZmVzdAogICAgaWYgKCFibG9jayAmJiBwcm9vZi5ibG9jaykgcmV0dXJuIG51bGwKCiAgICBpZiAoYmxvY2spIHByb29mLmJsb2NrLnZhbHVlID0gYmxvY2sKICAgIHJldHVybiBwcm9vZgogIH0KfQoKY2xhc3MgUGVlciB7CiAgY29uc3RydWN0b3IocmVwbGljYXRvciwgcHJvdG9tdXgsIGNoYW5uZWwsIGluZmxpZ2h0UmFuZ2UpIHsKICAgIHRoaXMuY29yZSA9IHJlcGxpY2F0b3IuY29yZQogICAgdGhpcy5yZXBsaWNhdG9yID0gcmVwbGljYXRvcgogICAgdGhpcy5zdHJlYW0gPSBwcm90b211eC5zdHJlYW0KICAgIHRoaXMucHJvdG9tdXggPSBwcm90b211eAogICAgdGhpcy5yZW1vdGVQdWJsaWNLZXkgPSB0aGlzLnN0cmVhbS5yZW1vdGVQdWJsaWNLZXkKICAgIHRoaXMucmVtb3RlU3VwcG9ydHNTZWVrcyA9IGZhbHNlCiAgICB0aGlzLmluZmxpZ2h0UmFuZ2UgPSBpbmZsaWdodFJhbmdlCiAgICB0aGlzLnJlbW90ZVNlZ21lbnRzV2FudGVkID0gbmV3IFNldCgpCiAgICB0aGlzLmZ1bGx5RG93bmxvYWRlZFNpZ25hbGVkID0gZmFsc2UKCiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlCiAgICB0aGlzLnJlbW92ZWQgPSBmYWxzZQoKICAgIHRoaXMuY2hhbm5lbCA9IGNoYW5uZWwKICAgIHRoaXMuY2hhbm5lbC51c2VyRGF0YSA9IHRoaXMKCiAgICB0aGlzLndpcmVTeW5jID0gdGhpcy5jaGFubmVsLm1lc3NhZ2VzWzBdCiAgICB0aGlzLndpcmVSZXF1ZXN0ID0gdGhpcy5jaGFubmVsLm1lc3NhZ2VzWzFdCiAgICB0aGlzLndpcmVDYW5jZWwgPSB0aGlzLmNoYW5uZWwubWVzc2FnZXNbMl0KICAgIHRoaXMud2lyZURhdGEgPSB0aGlzLmNoYW5uZWwubWVzc2FnZXNbM10KICAgIHRoaXMud2lyZU5vRGF0YSA9IHRoaXMuY2hhbm5lbC5tZXNzYWdlc1s0XQogICAgdGhpcy53aXJlV2FudCA9IHRoaXMuY2hhbm5lbC5tZXNzYWdlc1s1XQogICAgdGhpcy53aXJlVW53YW50ID0gdGhpcy5jaGFubmVsLm1lc3NhZ2VzWzZdCiAgICB0aGlzLndpcmVCaXRmaWVsZCA9IHRoaXMuY2hhbm5lbC5tZXNzYWdlc1s3XQogICAgdGhpcy53aXJlUmFuZ2UgPSB0aGlzLmNoYW5uZWwubWVzc2FnZXNbOF0KICAgIHRoaXMud2lyZUV4dGVuc2lvbiA9IHRoaXMuY2hhbm5lbC5tZXNzYWdlc1s5XQoKICAgIC8vIFNhbWUgc3RhdHMgYXMgcmVwbGljYXRvciwgYnV0IGZvciB0aGlzIHNwZWNpZmljIHBlZXIKICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgIHdpcmVTeW5jOiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlUmVxdWVzdDogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZUNhbmNlbDogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZURhdGE6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVXYW50OiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlQml0ZmllbGQ6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVSYW5nZTogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZUV4dGVuc2lvbjogeyB0eDogMCwgcng6IDAgfSwKICAgICAgaG90c3dhcHM6IDAsCiAgICAgIGludmFsaWREYXRhOiAwLAogICAgICBpbnZhbGlkUmVxdWVzdHM6IDAsCiAgICAgIGJhY2tvZmZzOiAwCiAgICB9CgogICAgdGhpcy5yZWNlaXZlclF1ZXVlID0gbmV3IFJlY2VpdmVyUXVldWUoKQogICAgdGhpcy5yZWNlaXZlckJ1c3kgPSBmYWxzZQoKICAgIC8vIG1vc3Qgb2Z0ZW4gbm90IHVzZWQsIHNvIG1hZGUgb24gZGVtYW5kCiAgICB0aGlzLnJvdW5kdHJpcFF1ZXVlID0gbnVsbAoKICAgIHRoaXMuaW5mbGlnaHQgPSAwCiAgICB0aGlzLmRhdGFQcm9jZXNzaW5nID0gMAoKICAgIHRoaXMuY2FuVXBncmFkZSA9IHRydWUKCiAgICB0aGlzLm5lZWRzU3luYyA9IGZhbHNlCiAgICB0aGlzLnN5bmNzUHJvY2Vzc2luZyA9IDAKICAgIHRoaXMubGFzdFVwZ3JhZGFibGVMZW5ndGggPSAwCiAgICB0aGlzLmxhc3RVcGdyYWRhYmxlRm9yayA9IDAKCiAgICB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoID0gMAoKICAgIC8vIFRPRE86IHR3ZWFrIHBpcGVsaW5pbmcgc28gdGhhdCBkYXRhIHNlbnQgQkVGT1JFIHJlbW90ZU9wZW5lZCBpcyBub3QgY2FwIHZlcmlmaWVkIQogICAgLy8gd2UgbWlnaHQgd2FubmEgdHdlYWsgdGhhdCB3aXRoIHNvbWUgY3J5cHRvLCBpZSB1c2UgdGhlIGNhcCB0byBlbmNyeXB0IGl0Li4uCiAgICAvLyBvciBqdXN0IGJlIGF3YXJlIG9mIHRoYXQsIHRvIG9ubHkgcHVzaCBub24gbGVha3kgZGF0YQoKICAgIHRoaXMucmVtb3RlT3BlbmVkID0gZmFsc2UKICAgIHRoaXMucmVtb3RlQml0ZmllbGQgPSBuZXcgUmVtb3RlQml0ZmllbGQoKQogICAgdGhpcy5taXNzaW5nQmxvY2tzID0gbmV3IFJlbW90ZUJpdGZpZWxkKCkKCiAgICB0aGlzLnB1c2hlZExlbmd0aCA9IDAKCiAgICB0aGlzLnJlbW90ZUZvcmsgPSAwCiAgICB0aGlzLnJlbW90ZUxlbmd0aCA9IDAKICAgIHRoaXMucmVtb3RlQ2FuVXBncmFkZSA9IGZhbHNlCiAgICB0aGlzLnJlbW90ZVVwbG9hZGluZyA9IHRydWUKICAgIHRoaXMucmVtb3RlRG93bmxvYWRpbmcgPSB0cnVlCiAgICB0aGlzLnJlbW90ZVN5bmNlZCA9IGZhbHNlCiAgICB0aGlzLnJlbW90ZUhhc01hbmlmZXN0ID0gZmFsc2UKICAgIHRoaXMucmVtb3RlQWxsb3dQdXNoID0gZmFsc2UKICAgIHRoaXMucmVtb3RlUmVxdWVzdHMgPSBuZXcgTWFwKCkKCiAgICB0aGlzLnNlZ21lbnRzV2FudGVkID0gbmV3IFNldCgpCiAgICB0aGlzLmJyb2FkY2FzdGVkTm9uU3BhcnNlID0gZmFsc2UKCiAgICB0aGlzLmxlbmd0aEFja2VkID0gMAoKICAgIHRoaXMuZXh0ZW5zaW9ucyA9IG5ldyBNYXAoKQogICAgdGhpcy5sYXN0RXh0ZW5zaW9uU2VudCA9ICcnCiAgICB0aGlzLmxhc3RFeHRlbnNpb25SZWN2ID0gJycKCiAgICByZXBsaWNhdG9yLl9pZkF2YWlsYWJsZSsrCiAgICByZXBsaWNhdG9yLl9hY3RpdmUrKwogIH0KCiAgZ2V0IHJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5yZW1vdGVCaXRmaWVsZC5maW5kRmlyc3QoZmFsc2UsIHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpCiAgfQoKICBnZXRNYXhJbmZsaWdodCgpIHsKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtLnJhd1N0cmVhbQogICAgaWYgKCFzdHJlYW0udWR4KSByZXR1cm4gTWF0aC5taW4odGhpcy5pbmZsaWdodFJhbmdlWzFdLCB0aGlzLmluZmxpZ2h0UmFuZ2VbMF0gKiAzKQoKICAgIGNvbnN0IHNjYWxlID0KICAgICAgc3RyZWFtLnJ0dCA8PSBTQ0FMRV9MQVRFTkNZCiAgICAgICAgPyAxCiAgICAgICAgOiAoc3RyZWFtLnJ0dCAvIFNDQUxFX0xBVEVOQ1kpICogTWF0aC5taW4oMSwgMiAvIHRoaXMucmVwbGljYXRvci5wZWVycy5sZW5ndGgpCiAgICByZXR1cm4gTWF0aC5tYXgoCiAgICAgIHRoaXMuaW5mbGlnaHRSYW5nZVswXSwKICAgICAgTWF0aC5yb3VuZChNYXRoLm1pbih0aGlzLmluZmxpZ2h0UmFuZ2VbMV0sIHRoaXMuaW5mbGlnaHRSYW5nZVswXSAqIHNjYWxlKSkKICAgICkKICB9CgogIGdldE1heEhvdHN3YXBJbmZsaWdodCgpIHsKICAgIGNvbnN0IGluZiA9IHRoaXMuZ2V0TWF4SW5mbGlnaHQoKQogICAgcmV0dXJuIE1hdGgubWF4KDE2LCBpbmYgLyAyKQogIH0KCiAgc2lnbmFsVXBncmFkZSgpIHsKICAgIGlmICh0aGlzLmZ1bGx5RG93bmxvYWRlZFNpZ25hbGVkICYmICF0aGlzLnJlcGxpY2F0b3IuZnVsbHlEb3dubG9hZGVkKCkpIHsKICAgICAgdGhpcy5mdWxseURvd25sb2FkZWRTaWduYWxlZCA9IGZhbHNlCiAgICB9CiAgICBpZiAodGhpcy5fc2hvdWxkVXBkYXRlQ2FuVXBncmFkZSgpID09PSB0cnVlKSB0aGlzLl91cGRhdGVDYW5VcGdyYWRlQW5kU3luYygpCiAgICBlbHNlIHRoaXMuc2VuZFN5bmMoKQogIH0KCiAgX21hcmtJbmZsaWdodChpbmRleCkgewogICAgdGhpcy5taXNzaW5nQmxvY2tzLnNldChpbmRleCwgZmFsc2UpCiAgfQoKICBicm9hZGNhc3RSYW5nZShzdGFydCwgbGVuZ3RoLCBkcm9wKSB7CiAgICBpZiAoIXRoaXMuaXNBY3RpdmUoKSkgcmV0dXJuCgogICAgaWYgKGRyb3ApIHRoaXMuX3VuY2xlYXJMb2NhbFJhbmdlKHN0YXJ0LCBsZW5ndGgpCiAgICBlbHNlIHRoaXMuX2NsZWFyTG9jYWxSYW5nZShzdGFydCwgbGVuZ3RoKQoKICAgIGNvbnN0IGkgPSBNYXRoLmZsb29yKHN0YXJ0IC8gREVGQVVMVF9TRUdNRU5UX1NJWkUpCiAgICBjb25zdCBmdWxseUNvbnRpZyA9IHRoaXMuY29yZS5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCA9PT0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aAoKICAgIGlmICgKICAgICAgc3RhcnQgKyBMQVNUX0JMT0NLUyA8IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggJiYKICAgICAgIXRoaXMucmVtb3RlU2VnbWVudHNXYW50ZWQuaGFzKGkpICYmCiAgICAgICFkcm9wICYmCiAgICAgICFmdWxseUNvbnRpZwogICAgKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGxldCBmb3JjZSA9IGZhbHNlCiAgICBpZiAoZnVsbHlDb250aWcgJiYgIWRyb3ApIHsKICAgICAgc3RhcnQgPSAwCiAgICAgIGxlbmd0aCA9IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgKCiAgICAgIC8vIEFsd2F5cyBzZW5kIHRoZSBicm9hZGNhc3Qgd2hlbiB3ZSBzd2l0Y2ggZnJvbSBzcGFyc2UgdG8gZnVsbHkgY29udGlndW91cywgc28gcmVtb3RlIGtub3dzIHRvbwogICAgICBpZiAoIXRoaXMuZnVsbHlEb3dubG9hZGVkU2lnbmFsZWQpIHsKICAgICAgICB0aGlzLmZ1bGx5RG93bmxvYWRlZFNpZ25hbGVkID0gdHJ1ZQogICAgICAgIGZvcmNlID0gdHJ1ZQogICAgICB9CiAgICB9CgogICAgLy8gVE9ETzogY29uc2lkZXIgYWxzbyBhZGRpbmcgZWFybHktcmV0dXJucyBvbiB0aGUgZHJvcD09PXRydWUgY2FzZQogICAgaWYgKCFmb3JjZSAmJiAhZHJvcCkgewogICAgICAvLyBObyBuZWVkIHRvIGJyb2FkY2FzdCBpZiB0aGUgcmVtb3RlIGFscmVhZHkgaGFzIHRoaXMgcmFuZ2UKCiAgICAgIGlmICh0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoID49IHN0YXJ0ICsgbGVuZ3RoKSByZXR1cm4KCiAgICAgIGlmIChsZW5ndGggPT09IDEpIHsKICAgICAgICBpZiAodGhpcy5yZW1vdGVCaXRmaWVsZC5nZXQoc3RhcnQpKSByZXR1cm4KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5yZW1vdGVCaXRmaWVsZC5maXJzdFVuc2V0KHN0YXJ0KSA+PSBzdGFydCArIGxlbmd0aCkgcmV0dXJuCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLndpcmVSYW5nZS5zZW5kKHsKICAgICAgZHJvcCwKICAgICAgc3RhcnQsCiAgICAgIGxlbmd0aAogICAgfSkKICAgIGluY3JlbWVudFR4KHRoaXMuc3RhdHMud2lyZVJhbmdlLCB0aGlzLnJlcGxpY2F0b3Iuc3RhdHMud2lyZVJhbmdlKQogIH0KCiAgZXh0ZW5zaW9uKG5hbWUsIG1lc3NhZ2UpIHsKICAgIHRoaXMud2lyZUV4dGVuc2lvbi5zZW5kKHsgbmFtZTogbmFtZSA9PT0gdGhpcy5sYXN0RXh0ZW5zaW9uU2VudCA/ICcnIDogbmFtZSwgbWVzc2FnZSB9KQogICAgaW5jcmVtZW50VHgodGhpcy5zdGF0cy53aXJlRXh0ZW5zaW9uLCB0aGlzLnJlcGxpY2F0b3Iuc3RhdHMud2lyZUV4dGVuc2lvbikKICAgIHRoaXMubGFzdEV4dGVuc2lvblNlbnQgPSBuYW1lCiAgfQoKICBvbmV4dGVuc2lvbihtZXNzYWdlKSB7CiAgICBjb25zdCBuYW1lID0gbWVzc2FnZS5uYW1lIHx8IHRoaXMubGFzdEV4dGVuc2lvblJlY3YKICAgIHRoaXMubGFzdEV4dGVuc2lvblJlY3YgPSBuYW1lCiAgICBjb25zdCBleHQgPSB0aGlzLmV4dGVuc2lvbnMuZ2V0KG5hbWUpCiAgICBpZiAoZXh0KSB7CiAgICAgIGV4dC5fb25tZXNzYWdlKHsgc3RhcnQ6IDAsIGVuZDogbWVzc2FnZS5tZXNzYWdlLmJ5dGVMZW5ndGgsIGJ1ZmZlcjogbWVzc2FnZS5tZXNzYWdlIH0sIHRoaXMpCiAgICB9CiAgfQoKICBzZW5kU3luYygpIHsKICAgIGlmICh0aGlzLnN5bmNzUHJvY2Vzc2luZyAhPT0gMCkgewogICAgICB0aGlzLm5lZWRzU3luYyA9IHRydWUKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMuY29yZS5zdGF0ZS5mb3JrICE9PSB0aGlzLnJlbW90ZUZvcmspIHsKICAgICAgdGhpcy5jYW5VcGdyYWRlID0gZmFsc2UKICAgIH0KCiAgICB0aGlzLm5lZWRzU3luYyA9IGZhbHNlCgogICAgdGhpcy53aXJlU3luYy5zZW5kKHsKICAgICAgZm9yazogdGhpcy5jb3JlLnN0YXRlLmZvcmssCiAgICAgIGxlbmd0aDogdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCwKICAgICAgcmVtb3RlTGVuZ3RoOiB0aGlzLmNvcmUuc3RhdGUuZm9yayA9PT0gdGhpcy5yZW1vdGVGb3JrID8gdGhpcy5yZW1vdGVMZW5ndGggOiAwLAogICAgICBjYW5VcGdyYWRlOiB0aGlzLmNhblVwZ3JhZGUsCiAgICAgIHVwbG9hZGluZzogdHJ1ZSwKICAgICAgZG93bmxvYWRpbmc6IHRoaXMucmVwbGljYXRvci5pc0Rvd25sb2FkaW5nKCksCiAgICAgIGhhc01hbmlmZXN0OiAhIXRoaXMuY29yZS5oZWFkZXIubWFuaWZlc3QgJiYgdGhpcy5jb3JlLmNvbXBhdCA9PT0gZmFsc2UsCiAgICAgIGFsbG93UHVzaDogdGhpcy5yZXBsaWNhdG9yLmFsbG93UHVzaAogICAgfSkKICAgIGluY3JlbWVudFR4KHRoaXMuc3RhdHMud2lyZVN5bmMsIHRoaXMucmVwbGljYXRvci5zdGF0cy53aXJlU3luYykKICB9CgogIG9ub3Blbih7IHNlZWtzLCBjYXBhYmlsaXR5IH0pIHsKICAgIGNvbnN0IGV4cGVjdGVkID0gY2Fwcy5yZXBsaWNhdGUoCiAgICAgIHRoaXMuc3RyZWFtLmlzSW5pdGlhdG9yID09PSBmYWxzZSwKICAgICAgdGhpcy5jb3JlLmtleSwKICAgICAgdGhpcy5zdHJlYW0uaGFuZHNoYWtlSGFzaAogICAgKQoKICAgIGlmIChiNGEuZXF1YWxzKGNhcGFiaWxpdHksIGV4cGVjdGVkKSAhPT0gdHJ1ZSkgewogICAgICAvLyBUT0RPOiBjaGFuZ2UgdGhpcyB0byBhIHJlamVjdGlvbiBpbnN0ZWFkLCBsZXNzIGxlYWthZ2UKICAgICAgdGhyb3cgSU5WQUxJRF9DQVBBQklMSVRZKCdSZW1vdGUgc2VudCBhbiBpbnZhbGlkIHJlcGxpY2F0aW9uIGNhcGFiaWxpdHknKQogICAgfQoKICAgIGlmICh0aGlzLnJlbW90ZU9wZW5lZCA9PT0gdHJ1ZSkgcmV0dXJuCiAgICB0aGlzLnJlbW90ZU9wZW5lZCA9IHRydWUKICAgIHRoaXMucmVtb3RlU3VwcG9ydHNTZWVrcyA9IHNlZWtzCgogICAgdGhpcy5wcm90b211eC5jb3JrKCkKCiAgICB0aGlzLnNlbmRTeW5jKCkKCiAgICBjb25zdCBjb250aWcgPSBNYXRoLm1pbih0aGlzLmNvcmUuc3RhdGUubGVuZ3RoLCB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgpCiAgICBpZiAoY29udGlnID4gMCkgewogICAgICB0aGlzLmJyb2FkY2FzdFJhbmdlKDAsIGNvbnRpZywgZmFsc2UpCgogICAgICBpZiAoY29udGlnID09PSB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5icm9hZGNhc3RlZE5vblNwYXJzZSA9IHRydWUKICAgICAgfQogICAgfQoKICAgIHRoaXMucmVwbGljYXRvci5faWZBdmFpbGFibGUtLQogICAgdGhpcy5yZXBsaWNhdG9yLl9hZGRQZWVyKHRoaXMpCgogICAgdGhpcy5wcm90b211eC51bmNvcmsoKQoKICAgIHRoaXMuY29yZS5jaGVja0lmSWRsZSgpCiAgfQoKICBvbmNsb3NlKGlzUmVtb3RlKSB7CiAgICAvLyB3ZSBtaWdodCBoYXZlIHNpZ25hbGxlZCB0byB0aGUgcmVtb3RlIHRoYXQgd2UgYXJlIGRvbmUgKGllIG5vdCBkb3dubG9hZGluZykgYW5kIHRoZSByZW1vdGUgbWlnaHQgYWdyZWUgb24gdGhhdAogICAgLy8gaWYgdGhhdCBoYXBwZW5zLCB0aGUgY2hhbm5lbCBtaWdodCBiZSBjbG9zZWQgYnkgdGhlIHJlbW90ZS4gaWYgc28ganVzdCByZW5lZ290aWF0ZSBpdC4KICAgIC8vIFRPRE86IGFkZCBhIENMT1NFX1JFQVNPTiB0byBtdXggdG8gd2UgY2FuIG1ha2UgdGhpcyBjbGVhbmVyLi4uCiAgICBjb25zdCByZW9wZW4gPQogICAgICBpc1JlbW90ZSA9PT0gdHJ1ZSAmJgogICAgICB0aGlzLnJlbW90ZU9wZW5lZCA9PT0gdHJ1ZSAmJgogICAgICB0aGlzLnJlbW90ZURvd25sb2FkaW5nID09PSBmYWxzZSAmJgogICAgICB0aGlzLnJlbW90ZVVwbG9hZGluZyA9PT0gdHJ1ZSAmJgogICAgICB0aGlzLnJlcGxpY2F0b3IuZG93bmxvYWRpbmcgPT09IHRydWUKCiAgICBpZiAodGhpcy5yZW1vdGVPcGVuZWQgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMucmVwbGljYXRvci5faWZBdmFpbGFibGUtLQogICAgICB0aGlzLnJlcGxpY2F0b3IudXBkYXRlQWxsKCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5yZW1vdGVPcGVuZWQgPSBmYWxzZQogICAgdGhpcy5yZW1vdmVkID0gdHJ1ZQogICAgdGhpcy5yZW1vdGVSZXF1ZXN0cy5jbGVhcigpIC8vIGNhbmNlbCBhbGwKICAgIHRoaXMucmVjZWl2ZXJRdWV1ZS5jbGVhcigpCgogICAgaWYgKHRoaXMucm91bmR0cmlwUXVldWUgIT09IG51bGwpIHsKICAgICAgZm9yIChjb25zdCBpZCBvZiB0aGlzLnJvdW5kdHJpcFF1ZXVlLmNsZWFyKCkpIHRoaXMucmVwbGljYXRvci5faW5mbGlnaHQucmV1c2FibGUoaWQpCiAgICB9CgogICAgdGhpcy5yZXBsaWNhdG9yLl9yZW1vdmVQZWVyKHRoaXMpCgogICAgaWYgKHJlb3BlbikgewogICAgICB0aGlzLnJlcGxpY2F0b3IuX21ha2VQZWVyKHRoaXMucHJvdG9tdXgpCiAgICB9CiAgfQoKICBjbG9zZUlmSWRsZSgpIHsKICAgIGlmICh0aGlzLnJlbW90ZURvd25sb2FkaW5nID09PSBmYWxzZSAmJiB0aGlzLnJlcGxpY2F0b3IuaXNEb3dubG9hZGluZygpID09PSBmYWxzZSkgewogICAgICAvLyBpZGxpbmcsIHNodXQgaXQgZG93bi4uLgogICAgICB0aGlzLmNoYW5uZWwuY2xvc2UoKQogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgYXN5bmMgb25zeW5jKG1zZykgewogICAgY29uc3QgewogICAgICBmb3JrLAogICAgICBsZW5ndGgsCiAgICAgIHJlbW90ZUxlbmd0aCwKICAgICAgY2FuVXBncmFkZSwKICAgICAgdXBsb2FkaW5nLAogICAgICBkb3dubG9hZGluZywKICAgICAgaGFzTWFuaWZlc3QsCiAgICAgIGFsbG93UHVzaAogICAgfSA9IG1zZwoKICAgIGNvbnN0IGxlbmd0aENoYW5nZWQgPSBsZW5ndGggIT09IHRoaXMucmVtb3RlTGVuZ3RoCiAgICBjb25zdCBzYW1lRm9yayA9IGZvcmsgPT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrCgogICAgdGhpcy5yZW1vdGVTeW5jZWQgPSB0cnVlCiAgICB0aGlzLnJlbW90ZUZvcmsgPSBmb3JrCiAgICB0aGlzLnJlbW90ZUxlbmd0aCA9IGxlbmd0aAogICAgdGhpcy5yZW1vdGVDYW5VcGdyYWRlID0gY2FuVXBncmFkZQogICAgdGhpcy5yZW1vdGVVcGxvYWRpbmcgPSB1cGxvYWRpbmcKICAgIHRoaXMucmVtb3RlRG93bmxvYWRpbmcgPSBkb3dubG9hZGluZwogICAgdGhpcy5yZW1vdGVIYXNNYW5pZmVzdCA9IGhhc01hbmlmZXN0CiAgICB0aGlzLnJlbW90ZUFsbG93UHVzaCA9IGFsbG93UHVzaAoKICAgIGlmICh0aGlzLmNsb3NlSWZJZGxlKCkpIHJldHVybgoKICAgIHRoaXMubGVuZ3RoQWNrZWQgPSBzYW1lRm9yayA/IHJlbW90ZUxlbmd0aCA6IDAKICAgIHRoaXMuc3luY3NQcm9jZXNzaW5nKysKCiAgICB0aGlzLnJlcGxpY2F0b3IuX3VwZGF0ZUZvcmsodGhpcykKCiAgICBpZiAodGhpcy5yZW1vdGVMZW5ndGggPiB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoICYmIHRoaXMubGVuZ3RoQWNrZWQgPT09IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpIHsKICAgICAgaWYgKHRoaXMucmVwbGljYXRvci5fYWRkVXBncmFkZU1heWJlKCkgIT09IG51bGwpIHRoaXMuX3VwZGF0ZSgpCiAgICB9CgogICAgY29uc3QgdXBncmFkZSA9CiAgICAgIGxlbmd0aENoYW5nZWQgPT09IGZhbHNlIHx8IHNhbWVGb3JrID09PSBmYWxzZQogICAgICAgID8gdGhpcy5jYW5VcGdyYWRlICYmIHNhbWVGb3JrCiAgICAgICAgOiBhd2FpdCB0aGlzLl9jYW5VcGdyYWRlKGxlbmd0aCwgZm9yaykKCiAgICBpZiAobGVuZ3RoID09PSB0aGlzLnJlbW90ZUxlbmd0aCAmJiBmb3JrID09PSB0aGlzLmNvcmUuc3RhdGUuZm9yaykgewogICAgICB0aGlzLmNhblVwZ3JhZGUgPSB1cGdyYWRlCiAgICAgIGlmICh1cGdyYWRlKSB7CiAgICAgICAgdGhpcy5sYXN0VXBncmFkYWJsZUZvcmsgPSBmb3JrCiAgICAgICAgdGhpcy5sYXN0VXBncmFkYWJsZUxlbmd0aCA9IGxlbmd0aAogICAgICB9CiAgICB9CgogICAgaWYgKC0tdGhpcy5zeW5jc1Byb2Nlc3NpbmcgIT09IDApIHJldHVybiAvLyBpZSBub3QgbGF0ZXN0CgogICAgaWYgKAogICAgICB0aGlzLm5lZWRzU3luYyA9PT0gdHJ1ZSB8fAogICAgICAodGhpcy5jb3JlLnN0YXRlLmZvcmsgPT09IHRoaXMucmVtb3RlRm9yayAmJiB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoID4gdGhpcy5yZW1vdGVMZW5ndGgpCiAgICApIHsKICAgICAgdGhpcy5zaWduYWxVcGdyYWRlKCkKICAgIH0KCiAgICB0aGlzLl91cGRhdGUoKQogIH0KCiAgX3Nob3VsZFVwZGF0ZUNhblVwZ3JhZGUoKSB7CiAgICByZXR1cm4gKAogICAgICB0aGlzLmNvcmUuc3RhdGUuZm9yayA9PT0gdGhpcy5yZW1vdGVGb3JrICYmCiAgICAgIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggPiB0aGlzLnJlbW90ZUxlbmd0aCAmJgogICAgICB0aGlzLmNhblVwZ3JhZGUgPT09IGZhbHNlICYmCiAgICAgIHRoaXMuc3luY3NQcm9jZXNzaW5nID09PSAwCiAgICApCiAgfQoKICBhc3luYyBfdXBkYXRlQ2FuVXBncmFkZUFuZFN5bmMoKSB7CiAgICBjb25zdCB7IGxlbmd0aCwgZm9yayB9ID0gdGhpcy5jb3JlLnN0YXRlCgogICAgY29uc3QgcmVtb3RlTGVuZ3RoID0gdGhpcy5yZW1vdGVMZW5ndGgKICAgIGNvbnN0IHJlbW90ZUZvcmsgPSB0aGlzLnJlbW90ZUZvcmsKICAgIGNvbnN0IGNhblVwZ3JhZGUgPSBhd2FpdCB0aGlzLl9jYW5VcGdyYWRlKHRoaXMucmVtb3RlTGVuZ3RoLCB0aGlzLnJlbW90ZUZvcmspCgogICAgaWYgKAogICAgICB0aGlzLnN5bmNzUHJvY2Vzc2luZyA+IDAgfHwKICAgICAgbGVuZ3RoICE9PSB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoIHx8CiAgICAgIGZvcmsgIT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrCiAgICApIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICBpZiAocmVtb3RlTGVuZ3RoICE9PSB0aGlzLnJlbW90ZUxlbmd0aCB8fCByZW1vdGVGb3JrICE9PSB0aGlzLnJlbW90ZUZvcmspIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICBpZiAoY2FuVXBncmFkZSA9PT0gdGhpcy5jYW5VcGdyYWRlKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuY2FuVXBncmFkZSA9IGNhblVwZ3JhZGUKICAgIGlmIChjYW5VcGdyYWRlKSB7CiAgICAgIHRoaXMubGFzdFVwZ3JhZGFibGVMZW5ndGggPSB0aGlzLnJlbW90ZUxlbmd0aAogICAgICB0aGlzLmxhc3RVcGdyYWRhYmxlRm9yayA9IHRoaXMucmVtb3RlRm9yawogICAgfQoKICAgIHRoaXMuc2VuZFN5bmMoKQogIH0KCiAgLy8gU2FmZSB0byBjYWxsIGluIHRoZSBiYWNrZ3JvdW5kIC0gbmV2ZXIgZmFpbHMKICBhc3luYyBfY2FuVXBncmFkZShyZW1vdGVMZW5ndGgsIHJlbW90ZUZvcmspIHsKICAgIGlmIChyZW1vdGVGb3JrICE9PSB0aGlzLmNvcmUuc3RhdGUuZm9yaykgcmV0dXJuIGZhbHNlCgogICAgaWYgKHJlbW90ZUxlbmd0aCA9PT0gMCkgcmV0dXJuIHRydWUKICAgIGlmIChyZW1vdGVMZW5ndGggPj0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkgcmV0dXJuIGZhbHNlCgogICAgdHJ5IHsKICAgICAgLy8gUmVseSBvbiBjYWNoaW5nIHRvIG1ha2Ugc3VyZSB0aGlzIGlzIGNoZWFwLi4uCiAgICAgIGNvbnN0IGNhblVwZ3JhZGUgPSBhd2FpdCBNZXJrbGVUcmVlLnVwZ3JhZGVhYmxlKHRoaXMuY29yZS5zdGF0ZSwgcmVtb3RlTGVuZ3RoKQoKICAgICAgaWYgKHJlbW90ZUZvcmsgIT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrKSByZXR1cm4gZmFsc2UKCiAgICAgIHJldHVybiBjYW5VcGdyYWRlCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQoKICBhc3luYyBfZ2V0UHJvb2YoYmF0Y2gsIG1zZywgcHVzaGluZykgewogICAgbGV0IGJsb2NrID0gbnVsbAoKICAgIGlmIChtc2cuYmxvY2spIHsKICAgICAgY29uc3QgaW5kZXggPSBtc2cuYmxvY2suaW5kZXgKCiAgICAgIGlmICghcHVzaGluZyAmJiAobXNnLmZvcmsgIT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrIHx8ICF0aGlzLmNvcmUuYml0ZmllbGQuZ2V0KGluZGV4KSkpIHsKICAgICAgICByZXR1cm4gbmV3IFByb29mUmVxdWVzdChtc2csIG51bGwsIG51bGwsIG51bGwpCiAgICAgIH0KCiAgICAgIGJsb2NrID0gYmF0Y2guZ2V0QmxvY2soaW5kZXgpCiAgICAgIGJsb2NrLmNhdGNoKG5vb3ApCiAgICB9CgogICAgY29uc3QgbWFuaWZlc3QgPSBtc2cubWFuaWZlc3QgJiYgIXRoaXMuY29yZS5jb21wYXQgPyB0aGlzLmNvcmUuaGVhZGVyLm1hbmlmZXN0IDogbnVsbAoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHByb29mID0gYXdhaXQgTWVya2xlVHJlZS5wcm9vZih0aGlzLmNvcmUuc3RhdGUsIGJhdGNoLCBtc2cpCiAgICAgIHJldHVybiBuZXcgUHJvb2ZSZXF1ZXN0KG1zZywgcHJvb2YsIGJsb2NrLCBtYW5pZmVzdCkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBiYXRjaC5kZXN0cm95KCkKCiAgICAgIHRoaXMucmVwbGljYXRvci5fb25pbnZhbGlkcmVxdWVzdChlcnIsIG1zZywgdGhpcykKCiAgICAgIGlmICh0aGlzLnN0YXRzLmludmFsaWRSZXF1ZXN0cyA+PSBNQVhfSU5WQUxJRF9SRVFVRVNUUykgdGhyb3cgZXJyCgogICAgICBhd2FpdCBiYWNrb2ZmKHRoaXMuc3RhdHMuaW52YWxpZFJlcXVlc3RzKQogICAgICByZXR1cm4gbnVsbAogICAgfQogIH0KCiAgYXN5bmMgb25yZXF1ZXN0KG1zZykgewogICAgY29uc3Qgc2l6ZSA9IHRoaXMucmVtb3RlUmVxdWVzdHMuc2l6ZQogICAgdGhpcy5yZW1vdGVSZXF1ZXN0cy5zZXQobXNnLmlkLCBtc2cpCgogICAgLy8gaWYgc2l6ZSBkaWRudCBjaGFuZ2UgLT4gaWQgb3ZlcndyaXRlIC0+IG9sZCBvbmUgaXMgZGVsZXRlZCwgY2FuY2VsIGN1cnJlbnQgYW5kIHJlLWFkZAogICAgaWYgKHNpemUgPT09IHRoaXMucmVtb3RlUmVxdWVzdHMuc2l6ZSkgewogICAgICB0aGlzLl9jYW5jZWwobXNnLmlkKQogICAgICB0aGlzLnJlbW90ZVJlcXVlc3RzLnNldChtc2cuaWQsIG1zZykKICAgIH0KCiAgICBpZiAoIXRoaXMucHJvdG9tdXguZHJhaW5lZCB8fCB0aGlzLnJlY2VpdmVyUXVldWUubGVuZ3RoKSB7CiAgICAgIHRoaXMucmVjZWl2ZXJRdWV1ZS5wdXNoKG1zZykKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMucmVwbGljYXRvci5kZXN0cm95ZWQpIHJldHVybgoKICAgIGF3YWl0IHRoaXMuX2hhbmRsZVJlcXVlc3QobXNnKQogIH0KCiAgb25jYW5jZWwobXNnKSB7CiAgICB0aGlzLl9jYW5jZWwobXNnLnJlcXVlc3QpCiAgfQoKICBfY2FuY2VsKGlkKSB7CiAgICB0aGlzLnJlbW90ZVJlcXVlc3RzLmRlbGV0ZShpZCkKICAgIHRoaXMucmVjZWl2ZXJRdWV1ZS5kZWxldGUoaWQpCiAgfQoKICBvbmRyYWluKCkgewogICAgcmV0dXJuIHRoaXMuX2hhbmRsZVJlcXVlc3RzKCkKICB9CgogIGFzeW5jIF9oYW5kbGVSZXF1ZXN0cygpIHsKICAgIGlmICh0aGlzLnJlY2VpdmVyQnVzeSB8fCB0aGlzLnJlcGxpY2F0b3IuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMucmVjZWl2ZXJCdXN5ID0gdHJ1ZQogICAgdGhpcy5wcm90b211eC5jb3JrKCkKCiAgICB3aGlsZSAoCiAgICAgIHRoaXMucmVtb3RlT3BlbmVkICYmCiAgICAgIHRoaXMucHJvdG9tdXguZHJhaW5lZCAmJgogICAgICB0aGlzLnJlY2VpdmVyUXVldWUubGVuZ3RoID4gMCAmJgogICAgICAhdGhpcy5yZW1vdmVkCiAgICApIHsKICAgICAgY29uc3QgbXNnID0gdGhpcy5yZWNlaXZlclF1ZXVlLnNoaWZ0KCkKICAgICAgYXdhaXQgdGhpcy5faGFuZGxlUmVxdWVzdChtc2cpCiAgICB9CgogICAgdGhpcy5wcm90b211eC51bmNvcmsoKQogICAgdGhpcy5yZWNlaXZlckJ1c3kgPSBmYWxzZQogIH0KCiAgYXN5bmMgcHVzaChpbmRleCkgewogICAgaWYgKCF0aGlzLnJlbW90ZUFsbG93UHVzaCkgcmV0dXJuCiAgICBpZiAodGhpcy5jb3JlLnN0YXRlLmZvcmsgIT09IHRoaXMucmVtb3RlRm9yaykgcmV0dXJuCiAgICBpZiAodGhpcy5yZW1vdGVCaXRmaWVsZC5nZXQoaW5kZXgpKSByZXR1cm4KCiAgICBjb25zdCBtc2cgPSB7CiAgICAgIGlkOiAwLAogICAgICBmb3JrOiB0aGlzLmNvcmUuc3RhdGUuZm9yaywKICAgICAgYmxvY2s6IG51bGwsCiAgICAgIGhhc2g6IG51bGwsCiAgICAgIHNlZWs6IG51bGwsCiAgICAgIHVwZ3JhZGU6IG51bGwsCiAgICAgIG1hbmlmZXN0OiB0aGlzLnJlbW90ZUxlbmd0aCA9PT0gMCwKICAgICAgcHJpb3JpdHk6IDAKICAgIH0KCiAgICBjb25zdCByZW1vdGVMZW5ndGggPSBNYXRoLm1heCh0aGlzLnJlbW90ZUxlbmd0aCwgdGhpcy5wdXNoZWRMZW5ndGgpCgogICAgbXNnLmJsb2NrID0gewogICAgICBpbmRleCwKICAgICAgbm9kZXM6IE1lcmtsZVRyZWUubWF4TWlzc2luZ05vZGVzKDIgKiBpbmRleCwgcmVtb3RlTGVuZ3RoKQogICAgfQoKICAgIGlmIChpbmRleCA+PSB0aGlzLnJlbW90ZUxlbmd0aCkgewogICAgICBtc2cudXBncmFkZSA9IHsKICAgICAgICBzdGFydDogcmVtb3RlTGVuZ3RoLAogICAgICAgIGxlbmd0aDogdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCAtIHJlbW90ZUxlbmd0aAogICAgICB9CiAgICB9CgogICAgbGV0IHJlcSA9IG51bGwKICAgIGNvbnN0IGJhdGNoID0gdGhpcy5jb3JlLnN0b3JhZ2UucmVhZCgpCiAgICB0cnkgewogICAgICByZXEgPSBhd2FpdCB0aGlzLl9nZXRQcm9vZihiYXRjaCwgbXNnLCB0cnVlKQogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChyZXEgPT09IG51bGwpIHJldHVybgogICAgYmF0Y2gudHJ5Rmx1c2goKQoKICAgIGF3YWl0IHRoaXMuX2Z1bGZpbGxSZXF1ZXN0KHJlcSwgdHJ1ZSkKICB9CgogIGFzeW5jIF9oYW5kbGVSZXF1ZXN0KG1zZykgewogICAgY29uc3QgYmF0Y2ggPSB0aGlzLmNvcmUuc3RvcmFnZS5yZWFkKCkKCiAgICAvLyBUT0RPOiBjb3VsZCBzdGlsbCBiZSBhbnN3ZXJhYmxlIGlmIChpbmRleCwgZm9yaykgaXMgYW4gYW5jZXN0b3Igb2YgdGhlIGN1cnJlbnQgZm9yawogICAgY29uc3QgcmVxID0KICAgICAgbXNnLmZvcmsgPT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrCiAgICAgICAgPyBhd2FpdCB0aGlzLl9nZXRQcm9vZihiYXRjaCwgbXNnLCBmYWxzZSkKICAgICAgICA6IG5ldyBQcm9vZlJlcXVlc3QobXNnLCBudWxsLCBudWxsLCBudWxsKQoKICAgIGlmIChyZXEgPT09IG51bGwpIHsKICAgICAgdGhpcy53aXJlTm9EYXRhLnNlbmQoeyByZXF1ZXN0OiBtc2cuaWQsIHJlYXNvbjogSU5WQUxJRF9SRVFVRVNUIH0pCiAgICAgIHJldHVybgogICAgfQoKICAgIGJhdGNoLnRyeUZsdXNoKCkKCiAgICBhd2FpdCB0aGlzLl9mdWxmaWxsUmVxdWVzdChyZXEsIGZhbHNlKQogIH0KCiAgYXN5bmMgX2Z1bGZpbGxSZXF1ZXN0KHJlcSwgcHVzaGluZykgewogICAgY29uc3QgcHJvb2YgPSBhd2FpdCByZXEuZnVsZmlsbCgpCgogICAgaWYgKCFwdXNoaW5nKSB7CiAgICAgIC8vIGlmIGNhbmNlbGxlZCBkbyBub3QgcmVwbHkKICAgICAgaWYgKHRoaXMucmVtb3RlUmVxdWVzdHMuZ2V0KHJlcS5tc2cuaWQpICE9PSByZXEubXNnKSB7CiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIC8vIHN5bmMgZnJvbSBub3cgb24sIHNvIHNhZmUgdG8gZGVsZXRlIGZyb20gdGhlIG1hcAogICAgICB0aGlzLnJlbW90ZVJlcXVlc3RzLmRlbGV0ZShyZXEubXNnLmlkKQogICAgfSBlbHNlIGlmICghdGhpcy5yZW1vdGVBbGxvd1B1c2gpIHsKICAgICAgLy8gaWYgcHVzaGluZyBidXQgcmVtb3RlIGRpc2FibGVkIGl0LCBqdXN0IGRyb3AgaXQKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKCF0aGlzLmlzQWN0aXZlKCkgJiYgcHJvb2YuYmxvY2sgIT09IG51bGwpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHByb29mID09PSBudWxsKSB7CiAgICAgIGlmIChyZXEubXNnLm1hbmlmZXN0ICYmIHRoaXMuY29yZS5oZWFkZXIubWFuaWZlc3QpIHsKICAgICAgICBjb25zdCBtYW5pZmVzdCA9IHRoaXMuY29yZS5oZWFkZXIubWFuaWZlc3QKICAgICAgICB0aGlzLndpcmVEYXRhLnNlbmQoewogICAgICAgICAgcmVxdWVzdDogcmVxLm1zZy5pZCwKICAgICAgICAgIGZvcms6IHRoaXMuY29yZS5zdGF0ZS5mb3JrLAogICAgICAgICAgYmxvY2s6IG51bGwsCiAgICAgICAgICBoYXNoOiBudWxsLAogICAgICAgICAgc2VlazogbnVsbCwKICAgICAgICAgIHVwZ3JhZGU6IG51bGwsCiAgICAgICAgICBtYW5pZmVzdAogICAgICAgIH0pCiAgICAgICAgaW5jcmVtZW50VHgodGhpcy5zdGF0cy53aXJlRGF0YSwgdGhpcy5yZXBsaWNhdG9yLnN0YXRzLndpcmVEYXRhKQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICB0aGlzLndpcmVOb0RhdGEuc2VuZCh7IHJlcXVlc3Q6IHJlcS5tc2cuaWQsIHJlYXNvbjogTk9UX0FWQUlMQUJMRSB9KQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAocHJvb2YuYmxvY2sgIT09IG51bGwpIHsKICAgICAgdGhpcy5yZXBsaWNhdG9yLl9vbnVwbG9hZChwcm9vZi5ibG9jay5pbmRleCwgcHJvb2YuYmxvY2sudmFsdWUuYnl0ZUxlbmd0aCwgdGhpcykKICAgIH0KCiAgICBpZiAocHJvb2YudXBncmFkZSkgewogICAgICBjb25zdCByZW1vdGVMZW5ndGggPSBwcm9vZi51cGdyYWRlLnN0YXJ0ICsgcHJvb2YudXBncmFkZS5sZW5ndGgKICAgICAgaWYgKHJlbW90ZUxlbmd0aCA+IHRoaXMucHVzaGVkTGVuZ3RoKSB0aGlzLnB1c2hlZExlbmd0aCA9IHJlbW90ZUxlbmd0aAogICAgfQoKICAgIHRoaXMud2lyZURhdGEuc2VuZCh7CiAgICAgIHJlcXVlc3Q6IHJlcS5tc2cuaWQsCiAgICAgIGZvcms6IHJlcS5tc2cuZm9yaywKICAgICAgYmxvY2s6IHByb29mLmJsb2NrLAogICAgICBoYXNoOiBwcm9vZi5oYXNoLAogICAgICBzZWVrOiBwcm9vZi5zZWVrLAogICAgICB1cGdyYWRlOiBwcm9vZi51cGdyYWRlLAogICAgICBtYW5pZmVzdDogcHJvb2YubWFuaWZlc3QKICAgIH0pCiAgICBpbmNyZW1lbnRUeCh0aGlzLnN0YXRzLndpcmVEYXRhLCB0aGlzLnJlcGxpY2F0b3Iuc3RhdHMud2lyZURhdGEpCiAgfQoKICBfY2FuY2VsUmVxdWVzdChyZXEpIHsKICAgIGlmIChyZXEucHJpb3JpdHkgPT09IFBSSU9SSVRZLkNBTkNFTExFRCkgcmV0dXJuCiAgICAvLyBtYXJrIGFzIGNhbmNlbGxlZCBhbHNvIGFuZCBhdm9pZCByZS1lbnRyeQogICAgcmVxLnByaW9yaXR5ID0gUFJJT1JJVFkuQ0FOQ0VMTEVECgogICAgdGhpcy5pbmZsaWdodC0tCiAgICB0aGlzLnJlcGxpY2F0b3IuX3JlcXVlc3REb25lKHJlcS5pZCwgZmFsc2UpCgogICAgLy8gY2xlYXIgaW5mbGlnaHQgc3RhdGUKICAgIGlmIChpc0Jsb2NrUmVxdWVzdChyZXEpKSB0aGlzLnJlcGxpY2F0b3IuX3VubWFya0luZmxpZ2h0KHJlcS5ibG9jay5pbmRleCkKICAgIGlmIChpc1VwZ3JhZGVSZXF1ZXN0KHJlcSkpIHRoaXMucmVwbGljYXRvci5fY2xlYXJJbmZsaWdodFVwZ3JhZGUocmVxKQoKICAgIGlmICh0aGlzLnJvdW5kdHJpcFF1ZXVlID09PSBudWxsKSB0aGlzLnJvdW5kdHJpcFF1ZXVlID0gbmV3IFJvdW5kdHJpcFF1ZXVlKCkKICAgIHRoaXMucm91bmR0cmlwUXVldWUuYWRkKHJlcS5pZCkKICAgIHRoaXMud2lyZUNhbmNlbC5zZW5kKHsgcmVxdWVzdDogcmVxLmlkIH0pCiAgICBpbmNyZW1lbnRUeCh0aGlzLnN0YXRzLndpcmVDYW5jZWwsIHRoaXMucmVwbGljYXRvci5zdGF0cy53aXJlQ2FuY2VsKQogIH0KCiAgX2NoZWNrSWZDb25mbGljdCgpIHsKICAgIHRoaXMucGF1c2VkID0gdHJ1ZQoKICAgIGNvbnN0IGxlbmd0aCA9IE1hdGgubWluKHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgsIHRoaXMucmVtb3RlTGVuZ3RoKQogICAgaWYgKGxlbmd0aCA9PT0gMCkgcmV0dXJuIC8vIHBhdXNlIGFuZCBpZ25vcmUKCiAgICB0aGlzLndpcmVSZXF1ZXN0LnNlbmQoewogICAgICBpZDogMCwgLy8gVE9ETzogdXNlIGFuIG1vcmUgZXhwbGljaXQgaWQgZm9yIHRoaXMgZXZlbnR1YWxseS4uLgogICAgICBmb3JrOiB0aGlzLnJlbW90ZUZvcmssCiAgICAgIGJsb2NrOiBudWxsLAogICAgICBoYXNoOiBudWxsLAogICAgICBzZWVrOiBudWxsLAogICAgICB1cGdyYWRlOiB7CiAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgbGVuZ3RoCiAgICAgIH0KICAgIH0pCgogICAgaW5jcmVtZW50VHgodGhpcy5zdGF0cy53aXJlUmVxdWVzdCwgdGhpcy5yZXBsaWNhdG9yLnN0YXRzLndpcmVSZXF1ZXN0KQogIH0KCiAgX3VubWFya0luZmxpZ2h0QmxvY2tSZXF1ZXN0KHJlcSwgZGF0YSkgewogICAgaWYgKGlzQmxvY2tSZXF1ZXN0KHJlcSkpIHRoaXMucmVwbGljYXRvci5fdW5tYXJrSW5mbGlnaHQocmVxLmJsb2NrLmluZGV4KQogICAgZWxzZSBpZiAoZGF0YS5ibG9jayAmJiAhcmVxKSB0aGlzLnJlcGxpY2F0b3IuX3VubWFya0luZmxpZ2h0KGRhdGEuYmxvY2suaW5kZXgpCiAgfQoKICBhc3luYyBvbmRhdGEoZGF0YSkgewogICAgaWYgKGRhdGEucmVxdWVzdCAhPT0gMCkgcmV0dXJuIHRoaXMuX2hhbmRsZURhdGEoZGF0YSkKCiAgICBhd2FpdCB0aGlzLnJlcGxpY2F0b3IuX3B1c2hMb2NrLmxvY2soKQogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5faGFuZGxlRGF0YShkYXRhKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5yZXBsaWNhdG9yLl9wdXNoTG9jay51bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgX2hhbmRsZURhdGEoZGF0YSkgewogICAgLy8gYWx3YXlzIGFsbG93IGEgZm9yayBjb25mbGljdCBwcm9vZiB0byBiZSBzZW50CiAgICBpZiAoZGF0YS5yZXF1ZXN0ID09PSAwICYmIGRhdGEudXBncmFkZSAmJiBkYXRhLnVwZ3JhZGUuc3RhcnQgPT09IDApIHsKICAgICAgaWYgKGF3YWl0IHRoaXMuY29yZS5jaGVja0NvbmZsaWN0KGRhdGEsIHRoaXMpKSByZXR1cm4KICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZQogICAgfQoKICAgIGNvbnN0IHJlcSA9IGRhdGEucmVxdWVzdCA+IDAgPyB0aGlzLnJlcGxpY2F0b3IuX2luZmxpZ2h0LmdldChkYXRhLnJlcXVlc3QpIDogbnVsbAogICAgY29uc3QgcmVvcmcgPSBkYXRhLmZvcmsgPiB0aGlzLmNvcmUuc3RhdGUuZm9yawoKICAgIC8vIG5vIHB1c2ggYXRtLCBUT0RPOiBjaGVjayBpZiB0aGlzIHNhdGlzZmllcyBhbm90aGVyIHBlbmRpbmcgcmVxdWVzdAogICAgLy8gYWxsb3cgcmVvcmcgcHVzaGVzIHRobyBhcyB0aG9zZSBhcmUgbm90IHdyaXR0ZW4gdG8gc3RvcmFnZSBzbyB3ZSdsbCB0YWtlIGFsbCB0aGUgaGVscCB3ZSBjYW4gZ2V0CiAgICBpZiAocmVxID09PSBudWxsICYmIHJlb3JnID09PSBmYWxzZSAmJiAhdGhpcy5yZXBsaWNhdG9yLmFsbG93UHVzaCkgewogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAocmVxID09PSBudWxsICYmIHJlb3JnID09PSBmYWxzZSAmJiBkYXRhLmJsb2NrKSB7CiAgICAgIC8vIG1hcmsgdGhpcyBhcyBpbmZsaWdodCB0byBhdm9pZCBwYXJhbGxlbCByZXF1ZXN0cwogICAgICB0aGlzLnJlcGxpY2F0b3IuX21hcmtJbmZsaWdodChkYXRhLmJsb2NrLmluZGV4KQogICAgfQoKICAgIGlmIChyZXEgIT09IG51bGwpIHsKICAgICAgaWYgKHJlcS5wZWVyICE9PSB0aGlzKSByZXR1cm4KICAgICAgdGhpcy5fb25yZXF1ZXN0cm91bmR0cmlwKHJlcSkKICAgIH0KCiAgICB0cnkgewogICAgICBpZiAocmVvcmcgPT09IHRydWUpIHJldHVybiBhd2FpdCB0aGlzLnJlcGxpY2F0b3IuX29ucmVvcmdkYXRhKHRoaXMsIHJlcSwgZGF0YSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgIHRoaXMuX3VubWFya0luZmxpZ2h0QmxvY2tSZXF1ZXN0KHJlcSwgZGF0YSkKCiAgICAgIHRoaXMucGF1c2VkID0gdHJ1ZQogICAgICB0aGlzLnJlcGxpY2F0b3IuX29uaW52YWxpZGRhdGEoZXJyLCByZXEsIGRhdGEsIHRoaXMpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuZGF0YVByb2Nlc3NpbmcrKwogICAgaWYgKGlzQmxvY2tSZXF1ZXN0KHJlcSkpIHRoaXMucmVwbGljYXRvci5fbWFya1Byb2Nlc3NpbmcocmVxLmJsb2NrLmluZGV4KQoKICAgIHRyeSB7CiAgICAgIGlmICghdGhpcy5yZXBsaWNhdG9yLl9tYXRjaGluZ1JlcXVlc3QocmVxLCBkYXRhKSB8fCAhKGF3YWl0IHRoaXMuY29yZS52ZXJpZnkoZGF0YSwgdGhpcykpKSB7CiAgICAgICAgdGhpcy5yZXBsaWNhdG9yLl9vbm5vZGF0YSh0aGlzLCByZXEsIDApCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgIHRoaXMuX3VubWFya0luZmxpZ2h0QmxvY2tSZXF1ZXN0KHJlcSwgZGF0YSkKCiAgICAgIGlmIChlcnIuY29kZSA9PT0gJ1dSSVRFX0ZBSUxFRCcpIHsKICAgICAgICAvLyBGb3IgZXhhbXBsZSwgd2UgZG9uJ3Qgd2FudCB0byBrZWVwIHB1bGxpbmcgZGF0YSB3aGVuIHN0b3JhZ2UgaXMgZnVsbAogICAgICAgIC8vIFRPRE86IG5vdGlmeSB0aGUgdXNlciBzb21laG93CiAgICAgICAgdGhpcy5wYXVzZWQgPSB0cnVlCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmNvcmUuY2xvc2VkICYmICFpc0NyaXRpY2FsRXJyb3IoZXJyKSkgcmV0dXJuCgogICAgICBpZiAoZXJyLmNvZGUgIT09ICdJTlZBTElEX09QRVJBVElPTicpIHsKICAgICAgICAvLyBtaWdodCBiZSBhIGZvcmssIHZlcmlmeQogICAgICAgIHRoaXMuX2NoZWNrSWZDb25mbGljdCgpCiAgICAgIH0KCiAgICAgIC8vIGlmIHB1c2ggbW9kZSwgd2UgTUlHSFQgZ2V0IGFuIG9jY2FzaW9uYWwgYmFkIG1lc3NhZ2UKICAgICAgLy8gbm8gbmVlZCB0byBtZWdhIGJhaWwgZm9yIHRoYXQuIFRPRE86IHJhdGUgbGltaXQgaW5zdGVhZCBhcyBhIGdlbmVyYWwgdGhpbmcKICAgICAgaWYgKCF0aGlzLnJlcGxpY2F0b3IuYWxsb3dQdXNoKSB7CiAgICAgICAgdGhpcy5wYXVzZWQgPSB0cnVlCiAgICAgIH0KCiAgICAgIHRoaXMucmVwbGljYXRvci5fb25ub2RhdGEodGhpcywgcmVxLCAwKQogICAgICB0aGlzLnJlcGxpY2F0b3IuX29uaW52YWxpZGRhdGEoZXJyLCByZXEsIGRhdGEsIHRoaXMpCiAgICAgIHJldHVybgogICAgfSBmaW5hbGx5IHsKICAgICAgaWYgKGlzQmxvY2tSZXF1ZXN0KHJlcSkpIHRoaXMucmVwbGljYXRvci5fbWFya1Byb2Nlc3NlZChyZXEuYmxvY2suaW5kZXgpCiAgICAgIHRoaXMuZGF0YVByb2Nlc3NpbmctLQogICAgfQoKICAgIHRoaXMucmVwbGljYXRvci5fb25kYXRhKHRoaXMsIHJlcSwgZGF0YSkKCiAgICBpZiAodGhpcy5fc2hvdWxkVXBkYXRlQ2FuVXBncmFkZSgpID09PSB0cnVlKSB7CiAgICAgIHRoaXMuX3VwZGF0ZUNhblVwZ3JhZGVBbmRTeW5jKCkKICAgIH0KICB9CgogIG9ubm9kYXRhKHsgcmVxdWVzdCwgcmVhc29uIH0pIHsKICAgIGNvbnN0IHJlcSA9IHJlcXVlc3QgPiAwID8gdGhpcy5yZXBsaWNhdG9yLl9pbmZsaWdodC5nZXQocmVxdWVzdCkgOiBudWxsCgogICAgaWYgKHJlcSA9PT0gbnVsbCB8fCByZXEucGVlciAhPT0gdGhpcykgewogICAgICB0aGlzLnJlcGxpY2F0b3IudXBkYXRlQWxsKCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5fb25yZXF1ZXN0cm91bmR0cmlwKHJlcSkKICAgIHRoaXMucmVwbGljYXRvci5fb25ub2RhdGEodGhpcywgcmVxLCByZWFzb24pCiAgfQoKICBfb25yZXF1ZXN0cm91bmR0cmlwKHJlcSkgewogICAgaWYgKHJlcS5wcmlvcml0eSA9PT0gUFJJT1JJVFkuQ0FOQ0VMTEVEKSByZXR1cm4KICAgIC8vIHRvIGF2b2lkIHJlLWVudHJ5IHdlIGFsc28ganVzdCBtYXJrIGl0IGFzIGNhbmNlbGxlZAogICAgcmVxLnByaW9yaXR5ID0gUFJJT1JJVFkuQ0FOQ0VMTEVECgogICAgdGhpcy5pbmZsaWdodC0tCiAgICB0aGlzLnJlcGxpY2F0b3IuX3JlcXVlc3REb25lKHJlcS5pZCwgdHJ1ZSkKICAgIGlmICh0aGlzLnJvdW5kdHJpcFF1ZXVlID09PSBudWxsKSByZXR1cm4KICAgIGNvbnN0IGZsdXNoZWQgPSB0aGlzLnJvdW5kdHJpcFF1ZXVlLmZsdXNoKHJlcS5ydCkKICAgIGlmIChmbHVzaGVkID09PSBudWxsKSByZXR1cm4KICAgIGZvciAoY29uc3QgaWQgb2YgZmx1c2hlZCkgdGhpcy5yZXBsaWNhdG9yLl9pbmZsaWdodC5yZXVzYWJsZShpZCkKICB9CgogIG9ud2FudCh7IHN0YXJ0LCBsZW5ndGggfSkgewogICAgY29uc3QgaSA9IE1hdGguZmxvb3Ioc3RhcnQgLyBERUZBVUxUX1NFR01FTlRfU0laRSkKICAgIGlmICh0aGlzLnJlbW90ZVNlZ21lbnRzV2FudGVkLnNpemUgPj0gTUFYX1JFTU9URV9TRUdNRU5UUykgdGhpcy5yZW1vdGVTZWdtZW50c1dhbnRlZC5jbGVhcigpIC8vIGp1c3QgaW4gY2FzZSBvZiBhYnVzZQogICAgdGhpcy5yZW1vdGVTZWdtZW50c1dhbnRlZC5hZGQoaSkKICAgIHRoaXMucmVwbGljYXRvci5fb253YW50KHRoaXMsIHN0YXJ0LCBsZW5ndGgpCiAgfQoKICBvbnVud2FudCgpIHsKICAgIC8vIFRPRE8KICB9CgogIG9uYml0ZmllbGQoeyBzdGFydCwgYml0ZmllbGQgfSkgewogICAgaWYgKHN0YXJ0IDwgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCkgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCA9IHN0YXJ0IC8vIGJpdGZpZWxkIGlzIGFsd2F5cyB0aGUgdHJ1dGgKICAgIHRoaXMucmVtb3RlQml0ZmllbGQuaW5zZXJ0KHN0YXJ0LCBiaXRmaWVsZCkKICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5pbnNlcnQoc3RhcnQsIGJpdGZpZWxkKQogICAgdGhpcy5fY2xlYXJMb2NhbFJhbmdlKHN0YXJ0LCBiaXRmaWVsZC5ieXRlTGVuZ3RoICogOCkKICAgIHRoaXMuX3VwZGF0ZSgpCiAgfQoKICBfY2xlYXJMb2NhbFJhbmdlKHN0YXJ0LCBsZW5ndGgpIHsKICAgIGNvbnN0IGJpdGZpZWxkID0gdGhpcy5jb3JlLnNraXBCaXRmaWVsZCA9PT0gbnVsbCA/IHRoaXMuY29yZS5iaXRmaWVsZCA6IHRoaXMuY29yZS5za2lwQml0ZmllbGQKCiAgICBpZiAobGVuZ3RoID09PSAxKSB7CiAgICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5zZXQoc3RhcnQsIHRoaXMuX3JlbW90ZUhhc0Jsb2NrKHN0YXJ0KSAmJiAhYml0ZmllbGQuZ2V0KHN0YXJ0KSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgY29udGlnID0gTWF0aC5taW4odGhpcy5jb3JlLnN0YXRlLmxlbmd0aCwgdGhpcy5jb3JlLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoKQoKICAgIGlmIChzdGFydCArIGxlbmd0aCA8IGNvbnRpZykgewogICAgICB0aGlzLm1pc3NpbmdCbG9ja3Muc2V0UmFuZ2Uoc3RhcnQsIGNvbnRpZywgZmFsc2UpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IHJlbSA9IHN0YXJ0ICYgMzI3NjcKICAgIGlmIChyZW0gPiAwKSB7CiAgICAgIHN0YXJ0IC09IHJlbQogICAgICBsZW5ndGggKz0gcmVtCiAgICB9CgogICAgY29uc3QgZW5kID0gc3RhcnQgKyBNYXRoLm1pbihsZW5ndGgsIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpCiAgICB3aGlsZSAoc3RhcnQgPCBlbmQpIHsKICAgICAgY29uc3QgbG9jYWwgPSBiaXRmaWVsZC5nZXRCaXRmaWVsZChzdGFydCkKCiAgICAgIGlmIChsb2NhbCAmJiBsb2NhbC5iaXRmaWVsZCkgewogICAgICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5jbGVhcihzdGFydCwgbG9jYWwuYml0ZmllbGQpCiAgICAgIH0KCiAgICAgIHN0YXJ0ICs9IDMyNzY4CiAgICB9CiAgfQoKICBfcmVzZXRNaXNzaW5nQmxvY2soaW5kZXgpIHsKICAgIGNvbnN0IGJpdGZpZWxkID0gdGhpcy5jb3JlLnNraXBCaXRmaWVsZCA9PT0gbnVsbCA/IHRoaXMuY29yZS5iaXRmaWVsZCA6IHRoaXMuY29yZS5za2lwQml0ZmllbGQKICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5zZXQoaW5kZXgsIHRoaXMuX3JlbW90ZUhhc0Jsb2NrKGluZGV4KSAmJiAhYml0ZmllbGQuZ2V0KGluZGV4KSkKICB9CgogIF91bmNsZWFyTG9jYWxSYW5nZShzdGFydCwgbGVuZ3RoKSB7CiAgICBpZiAobGVuZ3RoID09PSAxKSB7CiAgICAgIHRoaXMuX3Jlc2V0TWlzc2luZ0Jsb2NrKHN0YXJ0KQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCByZW0gPSBzdGFydCAmIDIwOTcxNTEKICAgIGlmIChyZW0gPiAwKSB7CiAgICAgIHN0YXJ0IC09IHJlbQogICAgICBsZW5ndGggKz0gcmVtCiAgICB9CgogICAgY29uc3QgZml4ZWRTdGFydCA9IHN0YXJ0CgogICAgY29uc3QgZW5kID0gc3RhcnQgKyBNYXRoLm1pbihsZW5ndGgsIHRoaXMucmVtb3RlTGVuZ3RoKQogICAgd2hpbGUgKHN0YXJ0IDwgZW5kKSB7CiAgICAgIGNvbnN0IHJlbW90ZSA9IHRoaXMucmVtb3RlQml0ZmllbGQuZ2V0Qml0ZmllbGQoc3RhcnQpCiAgICAgIGlmIChyZW1vdGUgJiYgcmVtb3RlLmJpdGZpZWxkKSB7CiAgICAgICAgdGhpcy5taXNzaW5nQmxvY2tzLmluc2VydChzdGFydCwgcmVtb3RlLmJpdGZpZWxkKQogICAgICB9CgogICAgICBzdGFydCArPSAyMDk3MTUyCiAgICB9CgogICAgdGhpcy5fY2xlYXJMb2NhbFJhbmdlKGZpeGVkU3RhcnQsIGxlbmd0aCkKICB9CgogIGFzeW5jIG9ucmFuZ2UoeyBkcm9wLCBzdGFydCwgbGVuZ3RoIH0pIHsKICAgIGNvbnN0IGhhcyA9IGRyb3AgPT09IGZhbHNlCgogICAgaWYgKGRyb3AgPT09IHRydWUgJiYgc3RhcnQgPCB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoKSB7CiAgICAgIHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGggPSBzdGFydAogICAgfQoKICAgIGlmIChzdGFydCA9PT0gMCAmJiBkcm9wID09PSBmYWxzZSkgewogICAgICBpZiAobGVuZ3RoID4gdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCkgewogICAgICAgIHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGggPSBsZW5ndGgKICAgICAgICBpZiAoCiAgICAgICAgICB0aGlzLnJlbW90ZUZvcmsgPT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrICYmCiAgICAgICAgICBsZW5ndGggPiB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgKICAgICAgICApIHsKICAgICAgICAgIHRoaXMuY29yZS51cGRhdGVSZW1vdGVDb250aWd1b3VzTGVuZ3RoKGxlbmd0aCkKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAobGVuZ3RoID09PSAxKSB7CiAgICAgIGNvbnN0IGJpdGZpZWxkID0gdGhpcy5jb3JlLnNraXBCaXRmaWVsZCA9PT0gbnVsbCA/IHRoaXMuY29yZS5iaXRmaWVsZCA6IHRoaXMuY29yZS5za2lwQml0ZmllbGQKICAgICAgdGhpcy5yZW1vdGVCaXRmaWVsZC5zZXQoc3RhcnQsIGhhcykKICAgICAgdGhpcy5taXNzaW5nQmxvY2tzLnNldChzdGFydCwgaGFzICYmICFiaXRmaWVsZC5nZXQoc3RhcnQpKQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgcmFuZ2VTdGFydCA9IHRoaXMucmVtb3RlQml0ZmllbGQuZmluZEZpcnN0KCFoYXMsIHN0YXJ0KQogICAgICBjb25zdCByYW5nZUVuZCA9IGxlbmd0aCArIHN0YXJ0CgogICAgICBpZiAocmFuZ2VTdGFydCAhPT0gLTEgJiYgcmFuZ2VTdGFydCA8IHJhbmdlRW5kKSB7CiAgICAgICAgdGhpcy5yZW1vdGVCaXRmaWVsZC5zZXRSYW5nZShyYW5nZVN0YXJ0LCByYW5nZUVuZCwgaGFzKQogICAgICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5zZXRSYW5nZShyYW5nZVN0YXJ0LCByYW5nZUVuZCwgaGFzKQogICAgICAgIGlmIChoYXMpIHRoaXMuX2NsZWFyTG9jYWxSYW5nZShyYW5nZVN0YXJ0LCByYW5nZUVuZCAtIHJhbmdlU3RhcnQpCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5jb3JlLmhpbnRzQ2hhbmdlZCkgYXdhaXQgdGhpcy5jb3JlLmZsdXNoSGludHMoKQogICAgaWYgKGRyb3AgPT09IGZhbHNlKSB0aGlzLl91cGRhdGUoKQogIH0KCiAgb25yZW9yZ2hpbnQoKSB7CiAgICAvLyBUT0RPCiAgfQoKICBfdXBkYXRlKCkgewogICAgLy8gVE9ETzogaWYgdGhpcyBpcyBpbiBhIGJhdGNoIG9yIHNpbWlsYXIgaXQgd291bGQgYmUgYmV0dGVyIHRvIGRlZmVyIGl0CiAgICAvLyB3ZSBjb3VsZCBkbyB0aGF0IHdpdGggbmV4dFRpY2svbWljcm90aWNrIG1iPyAoY29tYmluZWQgd2l0aCBhIHByb3BlcnR5IG9uIHRoZSBzZXNzaW9uIHRvIHNpZ25hbCByZWFkIGJ1ZmZlciBtYikKICAgIHRoaXMucmVwbGljYXRvci51cGRhdGVQZWVyKHRoaXMpCiAgfQoKICBhc3luYyBfb25jb25mbGljdCgpIHsKICAgIHRoaXMucHJvdG9tdXguY29yaygpCiAgICBpZiAodGhpcy5yZW1vdGVMZW5ndGggPiAwICYmIHRoaXMuY29yZS5zdGF0ZS5mb3JrID09PSB0aGlzLnJlbW90ZUZvcmspIHsKICAgICAgYXdhaXQgdGhpcy5vbnJlcXVlc3QoewogICAgICAgIGlkOiAwLAogICAgICAgIGZvcms6IHRoaXMuY29yZS5zdGF0ZS5mb3JrLAogICAgICAgIGJsb2NrOiBudWxsLAogICAgICAgIGhhc2g6IG51bGwsCiAgICAgICAgc2VlazogbnVsbCwKICAgICAgICB1cGdyYWRlOiB7CiAgICAgICAgICBzdGFydDogMCwKICAgICAgICAgIGxlbmd0aDogTWF0aC5taW4odGhpcy5jb3JlLnN0YXRlLmxlbmd0aCwgdGhpcy5yZW1vdGVMZW5ndGgpCiAgICAgICAgfQogICAgICB9KQogICAgfQogICAgdGhpcy5jaGFubmVsLmNsb3NlKCkKICAgIHRoaXMucHJvdG9tdXgudW5jb3JrKCkKICB9CgogIF9tYWtlUmVxdWVzdChuZWVkc1VwZ3JhZGUsIHByaW9yaXR5LCBtaW5MZW5ndGgpIHsKICAgIGlmIChuZWVkc1VwZ3JhZGUgPT09IHRydWUgJiYgdGhpcy5yZXBsaWNhdG9yLl9zaG91bGRVcGdyYWRlKHRoaXMpID09PSBmYWxzZSkgewogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIC8vIGVuc3VyZSB0aGF0IHRoZSByZW1vdGUgaGFzIHNpZ25hbGxlZCB0aGV5IGhhdmUgdGhlIGxlbmd0aCB3ZSByZXF1ZXN0CiAgICBpZiAodGhpcy5yZW1vdGVMZW5ndGggPCBtaW5MZW5ndGgpIHsKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBpZiAobmVlZHNVcGdyYWRlID09PSBmYWxzZSAmJiB0aGlzLnJlcGxpY2F0b3IuX2F1dG9VcGdyYWRlKHRoaXMpID09PSB0cnVlKSB7CiAgICAgIG5lZWRzVXBncmFkZSA9IHRydWUKICAgIH0KCiAgICByZXR1cm4gewogICAgICBwZWVyOiB0aGlzLAogICAgICBydDogdGhpcy5yb3VuZHRyaXBRdWV1ZSA9PT0gbnVsbCA/IDAgOiB0aGlzLnJvdW5kdHJpcFF1ZXVlLnRpY2ssCiAgICAgIGlkOiAwLAogICAgICBmb3JrOiB0aGlzLnJlbW90ZUZvcmssCiAgICAgIGJsb2NrOiBudWxsLAogICAgICBoYXNoOiBudWxsLAogICAgICBzZWVrOiBudWxsLAogICAgICB1cGdyYWRlOgogICAgICAgIG5lZWRzVXBncmFkZSA9PT0gZmFsc2UKICAgICAgICAgID8gbnVsbAogICAgICAgICAgOiB7IHN0YXJ0OiB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoLCBsZW5ndGg6IHRoaXMucmVtb3RlTGVuZ3RoIC0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCB9LAogICAgICAvLyByZW1vdGUgbWFuaWZlc3QgY2hlY2sgY2FuIGJlIHJlbW92ZWQgZXZlbnR1YWxseS4uLgogICAgICBtYW5pZmVzdDogdGhpcy5jb3JlLmhlYWRlci5tYW5pZmVzdCA9PT0gbnVsbCAmJiB0aGlzLnJlbW90ZUhhc01hbmlmZXN0ID09PSB0cnVlLAogICAgICBwcmlvcml0eSwKICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICBlbGFwc2VkOiAwCiAgICB9CiAgfQoKICBfcmVxdWVzdE1hbmlmZXN0KCkgewogICAgY29uc3QgcmVxID0gdGhpcy5fbWFrZVJlcXVlc3QoZmFsc2UsIDAsIDApCiAgICB0aGlzLl9zZW5kKHJlcSkKICB9CgogIF9pbmNsdWRlTGFzdEJsb2NrKCkgewogICAgaWYgKHRoaXMucmVwbGljYXRvci5fYWx3YXlzTGF0ZXN0QmxvY2sgPT09IDApIHJldHVybiBudWxsCgogICAgY29uc3QgaW5kZXggPSB0aGlzLnJlbW90ZUxlbmd0aCAtIDEKCiAgICAvLyBvbmx5IHZhbGlkIGlmIGl0cyBhbiBPT0IgZ2V0CiAgICBpZiAoaW5kZXggPCB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoKSByZXR1cm4gbnVsbAoKICAgIC8vIGRvIHRoZSBub3JtYWwgY2hlY2tzCiAgICBpZiAoIXRoaXMuX3JlbW90ZUhhc0Jsb2NrKGluZGV4KSkgcmV0dXJuIG51bGwKICAgIGlmICghdGhpcy5fY2FuUmVxdWVzdChpbmRleCkpIHJldHVybiBudWxsCgogICAgLy8gYXRtIHdlIG9ubHkgZXZlciBkbyBvbmUgdXBncmFkZSByZXF1ZXN0IGluIHBhcmFsbGVsLCBpZiB0aGF0IGNoYW5nZXMKICAgIC8vIHRoZW4gd2Ugc2hvdWxkIGFkZCBzb21lIGNoZWNrIGhlcmUgZm9yIGluZmxpZ2h0cyB0byBhdm9pZCBvdmVyIHJlcXVlc3RpbmcKICAgIGNvbnN0IGIgPSB0aGlzLnJlcGxpY2F0b3IuX2Jsb2Nrcy5hZGQoaW5kZXgsIFBSSU9SSVRZLk5PUk1BTCkKICAgIHJldHVybiBiCiAgfQoKICBfcmVxdWVzdFVwZ3JhZGUodSkgewogICAgY29uc3QgcmVxID0gdGhpcy5fbWFrZVJlcXVlc3QodHJ1ZSwgMCwgMCkKICAgIGlmIChyZXEgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGIgPSB0aGlzLl9pbmNsdWRlTGFzdEJsb2NrKCkKCiAgICBpZiAoYikgdGhpcy5fc2VuZEJsb2NrUmVxdWVzdChyZXEsIGIpCiAgICBlbHNlIHRoaXMuX3NlbmQocmVxKQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfcmVxdWVzdFNlZWsocykgewogICAgLy8gaWYgcmVwbGljYXRvciBpcyB1cGRhdGluZyB0aGUgc2Vla3MgZXRjLCBiYWlsIGFuZCB3YWl0IGZvciBpdCB0byBkcmFpbgogICAgaWYgKHRoaXMucmVwbGljYXRvci5fdXBkYXRlc1BlbmRpbmcgPiAwKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCB7IGxlbmd0aCwgZm9yayB9ID0gdGhpcy5jb3JlLnN0YXRlCgogICAgaWYgKGZvcmsgIT09IHRoaXMucmVtb3RlRm9yaykgcmV0dXJuIGZhbHNlCgogICAgaWYgKHMuc2Vla2VyLnN0YXJ0ID49IGxlbmd0aCkgewogICAgICBjb25zdCByZXEgPSB0aGlzLl9tYWtlUmVxdWVzdCh0cnVlLCAwLCAwKQoKICAgICAgLy8gV2UgbmVlZCBhbiB1cGdyYWRlIGZvciB0aGUgc2VlaywgaWYgbm9uIGNhbiBiZSBwcm92aWRlZCwgc2tpcAogICAgICBpZiAocmVxID09PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgICAgIHJlcS5zZWVrID0gdGhpcy5yZW1vdGVTdXBwb3J0c1NlZWtzCiAgICAgICAgPyB7IGJ5dGVzOiBzLnNlZWtlci5ieXRlcywgcGFkZGluZzogcy5zZWVrZXIucGFkZGluZyB9CiAgICAgICAgOiBudWxsCgogICAgICBzLmluZmxpZ2h0LnB1c2gocmVxKQogICAgICB0aGlzLl9zZW5kKHJlcSkKCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgY29uc3QgbGVuID0gcy5zZWVrZXIuZW5kIC0gcy5zZWVrZXIuc3RhcnQKICAgIGNvbnN0IG9mZiA9IHMuc2Vla2VyLnN0YXJ0ICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbGVuKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgbGV0IGluZGV4ID0gb2ZmICsgaQogICAgICBpZiAoaW5kZXggPiBzLnNlZWtlci5lbmQpIGluZGV4IC09IGxlbgoKICAgICAgaWYgKHRoaXMuX3JlbW90ZUhhc0Jsb2NrKGluZGV4KSA9PT0gZmFsc2UpIGNvbnRpbnVlCiAgICAgIGlmICh0aGlzLmNvcmUuYml0ZmllbGQuZ2V0KGluZGV4KSA9PT0gdHJ1ZSkgY29udGludWUKICAgICAgaWYgKCF0aGlzLl9jYW5SZXF1ZXN0KGluZGV4KSkgY29udGludWUKCiAgICAgIC8vIENoZWNrIGlmIHRoaXMgYmxvY2sgaXMgY3VycmVudGx5IGluZmxpZ2h0IC0gaWYgc28gcGljayBhbm90aGVyCiAgICAgIGNvbnN0IGIgPSB0aGlzLnJlcGxpY2F0b3IuX2Jsb2Nrcy5nZXQoaW5kZXgpCiAgICAgIGlmIChiICE9PSBudWxsICYmIGIuaW5mbGlnaHQubGVuZ3RoID4gMCkgY29udGludWUKCiAgICAgIC8vIEJsb2NrIGlzIG5vdCBpbmZsaWdodCwgYnV0IHdlIG9ubHkgd2FudCB0aGUgaGFzaCwgY2hlY2sgaWYgdGhhdCBpcyBpbmZsaWdodAogICAgICBjb25zdCBoID0gdGhpcy5yZXBsaWNhdG9yLl9oYXNoZXMuYWRkKGluZGV4LCBQUklPUklUWS5OT1JNQUwpCiAgICAgIGlmIChoLmluZmxpZ2h0Lmxlbmd0aCA+IDApIGNvbnRpbnVlCgogICAgICBjb25zdCByZXEgPSB0aGlzLl9tYWtlUmVxdWVzdChmYWxzZSwgaC5wcmlvcml0eSwgaW5kZXggKyAxKQogICAgICBpZiAocmVxID09PSBudWxsKSBjb250aW51ZQoKICAgICAgY29uc3Qgbm9kZXMgPSBmbGF0VHJlZS5kZXB0aChzLnNlZWtlci5zdGFydCArIHMuc2Vla2VyLmVuZCAtIDEpCgogICAgICByZXEuaGFzaCA9IHsgaW5kZXg6IDIgKiBpbmRleCwgbm9kZXMgfQogICAgICByZXEuc2VlayA9IHRoaXMucmVtb3RlU3VwcG9ydHNTZWVrcwogICAgICAgID8geyBieXRlczogcy5zZWVrZXIuYnl0ZXMsIHBhZGRpbmc6IHMuc2Vla2VyLnBhZGRpbmcgfQogICAgICAgIDogbnVsbAoKICAgICAgcy5pbmZsaWdodC5wdXNoKHJlcSkKICAgICAgaC5pbmZsaWdodC5wdXNoKHJlcSkKICAgICAgdGhpcy5fc2VuZChyZXEpCgogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHRoaXMuX21heWJlV2FudChzLnNlZWtlci5zdGFydCwgbGVuKQogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBfY2FuUmVxdWVzdChpbmRleCkgewogICAgaWYgKCEoaW5kZXggPj0gMCkpIHRocm93IEFTU0VSVElPTignYmFkIGluZGV4IHRvIF9jYW5SZXF1ZXN0OiAnICsgaW5kZXgpCgogICAgaWYgKHRoaXMucmVtb3RlTGVuZ3RoID49IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpIHsKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBpZiAoaW5kZXggPCB0aGlzLmxhc3RVcGdyYWRhYmxlTGVuZ3RoICYmIHRoaXMubGFzdFVwZ3JhZGFibGVGb3JrID09PSB0aGlzLmNvcmUuc3RhdGUuZm9yaykgewogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGlmICh0aGlzLmNhblVwZ3JhZGUgJiYgdGhpcy5zeW5jc1Byb2Nlc3NpbmcgPT09IDApIHsKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF9yZW1vdGVIYXNCbG9jayhpbmRleCkgewogICAgcmV0dXJuIGluZGV4IDwgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCB8fCB0aGlzLnJlbW90ZUJpdGZpZWxkLmdldChpbmRleCkgPT09IHRydWUKICB9CgogIF9zZW5kQmxvY2tSZXF1ZXN0KHJlcSwgYikgewogICAgcmVxLmJsb2NrID0geyBpbmRleDogYi5pbmRleCwgbm9kZXM6IDAgfQogICAgdGhpcy5yZXBsaWNhdG9yLl9tYXJrSW5mbGlnaHQoYi5pbmRleCkKCiAgICBiLmluZmxpZ2h0LnB1c2gocmVxKQogICAgdGhpcy5yZXBsaWNhdG9yLmhvdHN3YXBzLmFkZChiKQogICAgdGhpcy5fc2VuZChyZXEpCiAgfQoKICBfcmVxdWVzdEJsb2NrKGIpIHsKICAgIGNvbnN0IHsgbGVuZ3RoLCBmb3JrIH0gPSB0aGlzLmNvcmUuc3RhdGUKCiAgICBpZiAodGhpcy5fcmVtb3RlSGFzQmxvY2soYi5pbmRleCkgPT09IGZhbHNlIHx8IGZvcmsgIT09IHRoaXMucmVtb3RlRm9yaykgewogICAgICB0aGlzLl9tYXliZVdhbnQoYi5pbmRleCkKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgaWYgKCF0aGlzLl9jYW5SZXF1ZXN0KGIuaW5kZXgpKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCByZXEgPSB0aGlzLl9tYWtlUmVxdWVzdChiLmluZGV4ID49IGxlbmd0aCwgYi5wcmlvcml0eSwgYi5pbmRleCArIDEpCiAgICBpZiAocmVxID09PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgICB0aGlzLl9zZW5kQmxvY2tSZXF1ZXN0KHJlcSwgYikKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3JlcXVlc3RSYW5nZUJsb2NrKGluZGV4LCBsZW5ndGgpIHsKICAgIGlmICh0aGlzLmNvcmUuYml0ZmllbGQuZ2V0KGluZGV4KSA9PT0gdHJ1ZSB8fCAhdGhpcy5fY2FuUmVxdWVzdChpbmRleCkpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGIgPSB0aGlzLnJlcGxpY2F0b3IuX2Jsb2Nrcy5hZGQoaW5kZXgsIFBSSU9SSVRZLk5PUk1BTCkKICAgIGlmIChiLmluZmxpZ2h0Lmxlbmd0aCA+IDApIHsKICAgICAgdGhpcy5taXNzaW5nQmxvY2tzLnNldChpbmRleCwgZmFsc2UpIC8vIGluIGNhc2Ugd2UgbWlzc2VkIHNvbWUgc3RhdGVzIGp1c3Qgc2V0IHRoZW0gb25kZW1hbmQsIG5iZAogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBjb25zdCByZXEgPSB0aGlzLl9tYWtlUmVxdWVzdChpbmRleCA+PSBsZW5ndGgsIGIucHJpb3JpdHksIGluZGV4ICsgMSkKCiAgICAvLyBJZiB0aGUgcmVxdWVzdCBjYW5ub3QgYmUgc2F0aXNmaWVkLCBkZWFsbG9jIHRoZSBibG9jayByZXF1ZXN0IGlmIG5vIG9uZSBpcyBzdWJzY3JpYmVkIHRvIGl0CiAgICBpZiAocmVxID09PSBudWxsKSB7CiAgICAgIGIuZ2MoKQogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICB0aGlzLl9zZW5kQmxvY2tSZXF1ZXN0KHJlcSwgYikKCiAgICAvLyBEb24ndCB0aGluayB0aGlzIHdpbGwgZXZlciBoYXBwZW4sIGFzIHRoZSBwZW5kaW5nIHF1ZXVlIGlzIGRyYWluZWQgYmVmb3JlIHRoZSByYW5nZSBxdWV1ZQogICAgLy8gYnV0IGRvZXNuJ3QgaHVydCB0byBjaGVjayB0aGlzIGV4cGxpY2l0bHkgaGVyZSBhbHNvLgogICAgaWYgKGIucXVldWVkKSBiLnF1ZXVlZCA9IGZhbHNlCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX2ZpbmROZXh0KGkpIHsKICAgIGlmIChpIDwgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCkgewogICAgICBpZiAodGhpcy5jb3JlLnNraXBCaXRmaWVsZCA9PT0gbnVsbCkgdGhpcy5yZXBsaWNhdG9yLl9vcGVuU2tpcEJpdGZpZWxkKCkKICAgICAgaSA9IHRoaXMuY29yZS5za2lwQml0ZmllbGQuZmluZEZpcnN0KGZhbHNlLCBpKQogICAgICBpZiAoaSA8IHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGggJiYgaSA+IC0xKSByZXR1cm4gaQogICAgICBpID0gdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aAogICAgfQoKICAgIHJldHVybiB0aGlzLm1pc3NpbmdCbG9ja3MuZmluZEZpcnN0KHRydWUsIGkpCiAgfQoKICBfcmVxdWVzdFJhbmdlKHIpIHsKICAgIGlmICh0aGlzLnN5bmNzUHJvY2Vzc2luZyA+IDApIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IHsgbGVuZ3RoLCBmb3JrIH0gPSB0aGlzLmNvcmUuc3RhdGUKCiAgICBpZiAoci5ibG9ja3MpIHsKICAgICAgbGV0IG1pbiA9IC0xCiAgICAgIGxldCBtYXggPSAtMQoKICAgICAgZm9yIChsZXQgaSA9IHIuc3RhcnQ7IGkgPCByLmVuZDsgaSsrKSB7CiAgICAgICAgY29uc3QgaW5kZXggPSByLmJsb2Nrc1tpXQogICAgICAgIGlmIChtaW4gPT09IC0xIHx8IGluZGV4IDwgbWluKSBtaW4gPSBpbmRleAogICAgICAgIGlmIChtYXggPT09IC0xIHx8IGluZGV4ID4gbWF4KSBtYXggPSBpbmRleAogICAgICAgIGNvbnN0IGhhcyA9IGluZGV4IDwgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCB8fCB0aGlzLm1pc3NpbmdCbG9ja3MuZ2V0KGluZGV4KSA9PT0gdHJ1ZQogICAgICAgIGlmIChoYXMgPT09IHRydWUgJiYgdGhpcy5fcmVxdWVzdFJhbmdlQmxvY2soaW5kZXgsIGxlbmd0aCkpIHJldHVybiB0cnVlCiAgICAgIH0KCiAgICAgIGlmIChtaW4gPiAtMSkgdGhpcy5fbWF5YmVXYW50KG1pbiwgbWF4IC0gbWluKQogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICAvLyBpZiB3ZSBjYW4gdXBncmFkZSB0aGUgcmVtb3RlLCBvciB0aGUgcmVtb3RlIGlzIGFoZWFkLCB0aGVuIGFsbCB0aGUgcmVtb3RlcyBibG9ja3MgYXJlIHZhbGlkCiAgICAvLyBvdGhlcndpc2UgdHJ1bmNhdGUgdG8gdGhlIGxhc3QgbGVuZ3RoIHRoZSByZW1vdGUgaGFzIGFja2VkIGZvciB1cwogICAgY29uc3QgbWF4TG9jYWxMZW5ndGggPQogICAgICB0aGlzLmNhblVwZ3JhZGUgfHwgdGhpcy5yZW1vdGVMZW5ndGggPj0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aAogICAgICAgID8gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aAogICAgICAgIDogZm9yayA9PT0gdGhpcy5sYXN0VXBncmFkYWJsZUZvcmsKICAgICAgICAgID8gTWF0aC5taW4odGhpcy5sYXN0VXBncmFkYWJsZUxlbmd0aCwgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkKICAgICAgICAgIDogMAoKICAgIGNvbnN0IGVuZCA9IE1hdGgubWluKAogICAgICBtYXhMb2NhbExlbmd0aCwKICAgICAgTWF0aC5taW4oci5lbmQgPT09IC0xID8gdGhpcy5yZW1vdGVMZW5ndGggOiByLmVuZCwgdGhpcy5yZW1vdGVMZW5ndGgpCiAgICApCiAgICBpZiAoZW5kIDw9IHIuc3RhcnQgfHwgZm9yayAhPT0gdGhpcy5yZW1vdGVGb3JrKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBsZW4gPSBlbmQgLSByLnN0YXJ0CiAgICBjb25zdCBvZmYgPSByLnN0YXJ0ICsgKHIubGluZWFyID8gMCA6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGxlbikpCgogICAgbGV0IGkgPSBvZmYKICAgIC8vIHNob3VsZCBiZSB3YXkgbGVzcyB0aGFuIHRoaXMsIGJ1dCB0aGlzIGlzIHdvcnN0IGNhc2UgdXBwZXIgYm91bmQgZm9yIHRoZSBza2lwbGlzdAogICAgbGV0IHRyaWVzID0gdGhpcy5pbmZsaWdodAoKICAgIGRvIHsKICAgICAgaSA9IHRoaXMuX2ZpbmROZXh0KGkpCiAgICAgIGlmIChpID09PSAtMSB8fCBpID49IGVuZCkgYnJlYWsKCiAgICAgIGlmICh0aGlzLl9yZXF1ZXN0UmFuZ2VCbG9jayhpLCBsZW5ndGgpKSByZXR1cm4gdHJ1ZQogICAgICBpKysKICAgIH0gd2hpbGUgKHRyaWVzLS0gPiAwKQoKICAgIGkgPSByLnN0YXJ0CgogICAgZG8gewogICAgICBpID0gdGhpcy5fZmluZE5leHQoaSkKICAgICAgaWYgKGkgPT09IC0xIHx8IGkgPj0gb2ZmKSBicmVhawoKICAgICAgaWYgKHRoaXMuX3JlcXVlc3RSYW5nZUJsb2NrKGksIGxlbmd0aCkpIHJldHVybiB0cnVlCiAgICAgIGkrKwogICAgfSB3aGlsZSAodHJpZXMtLSA+IDApCgogICAgdGhpcy5fbWF5YmVXYW50KHIuc3RhcnQsIGxlbikKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX3JlcXVlc3RGb3JrUHJvb2YoZikgewogICAgaWYgKCF0aGlzLnJlbW90ZUxlbmd0aCkgcmV0dXJuCgogICAgY29uc3QgcmVxID0gdGhpcy5fbWFrZVJlcXVlc3QoZmFsc2UsIDAsIDApCgogICAgcmVxLnVwZ3JhZGUgPSB7IHN0YXJ0OiAwLCBsZW5ndGg6IHRoaXMucmVtb3RlTGVuZ3RoIH0KICAgIHJlcS5tYW5pZmVzdCA9ICF0aGlzLmNvcmUuaGVhZGVyLm1hbmlmZXN0CgogICAgZi5pbmZsaWdodC5wdXNoKHJlcSkKICAgIHRoaXMuX3NlbmQocmVxKQogIH0KCiAgX3JlcXVlc3RGb3JrUmFuZ2UoZikgewogICAgaWYgKGYuZm9yayAhPT0gdGhpcy5yZW1vdGVGb3JrIHx8IGYuYmF0Y2gud2FudCA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgZW5kID0gTWF0aC5taW4oZi5iYXRjaC53YW50LmVuZCwgdGhpcy5yZW1vdGVMZW5ndGgpCiAgICBpZiAoZW5kIDwgZi5iYXRjaC53YW50LnN0YXJ0KSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBsZW4gPSBlbmQgLSBmLmJhdGNoLndhbnQuc3RhcnQKICAgIGNvbnN0IG9mZiA9IGYuYmF0Y2gud2FudC5zdGFydCArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGxlbikKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIGxldCBpbmRleCA9IG9mZiArIGkKICAgICAgaWYgKGluZGV4ID49IGVuZCkgaW5kZXggLT0gbGVuCgogICAgICBpZiAodGhpcy5fcmVtb3RlSGFzQmxvY2soaW5kZXgpID09PSBmYWxzZSkgY29udGludWUKCiAgICAgIGNvbnN0IHJlcSA9IHRoaXMuX21ha2VSZXF1ZXN0KGZhbHNlLCAwLCAwKQoKICAgICAgcmVxLmhhc2ggPSB7IGluZGV4OiAyICogaW5kZXgsIG5vZGVzOiBmLmJhdGNoLndhbnQubm9kZXMgfQoKICAgICAgZi5pbmZsaWdodC5wdXNoKHJlcSkKICAgICAgdGhpcy5fc2VuZChyZXEpCgogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHRoaXMuX21heWJlV2FudChmLmJhdGNoLndhbnQuc3RhcnQsIGxlbikKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX21heWJlV2FudChzdGFydCwgbGVuZ3RoID0gMSkgewogICAgaWYgKHN0YXJ0ICsgbGVuZ3RoIDw9IHRoaXMucmVtb3RlQ29udGlndW91c0xlbmd0aCkgcmV0dXJuCgogICAgbGV0IGkgPSBNYXRoLmZsb29yKHN0YXJ0IC8gREVGQVVMVF9TRUdNRU5UX1NJWkUpCiAgICBjb25zdCBuID0gTWF0aC5jZWlsKChzdGFydCArIGxlbmd0aCkgLyBERUZBVUxUX1NFR01FTlRfU0laRSkKCiAgICBmb3IgKDsgaSA8IG47IGkrKykgewogICAgICBpZiAodGhpcy5zZWdtZW50c1dhbnRlZC5oYXMoaSkpIGNvbnRpbnVlCiAgICAgIHRoaXMuc2VnbWVudHNXYW50ZWQuYWRkKGkpCgogICAgICB0aGlzLndpcmVXYW50LnNlbmQoewogICAgICAgIHN0YXJ0OiBpICogREVGQVVMVF9TRUdNRU5UX1NJWkUsCiAgICAgICAgbGVuZ3RoOiBERUZBVUxUX1NFR01FTlRfU0laRQogICAgICB9KQogICAgICBpbmNyZW1lbnRUeCh0aGlzLnN0YXRzLndpcmVXYW50LCB0aGlzLnJlcGxpY2F0b3Iuc3RhdHMud2lyZVdhbnQpCiAgICB9CiAgfQoKICBpc0FjdGl2ZSgpIHsKICAgIGlmICh0aGlzLnBhdXNlZCB8fCB0aGlzLnJlbW92ZWQgfHwgdGhpcy5jb3JlLmhlYWRlci5mcm96ZW4pIHJldHVybiBmYWxzZQogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIF9zZW5kKHJlcSkgewogICAgY29uc3QgZm9yayA9IHRoaXMuY29yZS5zdGF0ZS5mb3JrCgogICAgdGhpcy5pbmZsaWdodCsrCiAgICB0aGlzLnJlcGxpY2F0b3IuX2luZmxpZ2h0LmFkZChyZXEpCgogICAgaWYgKHJlcS51cGdyYWRlICE9PSBudWxsICYmIHJlcS5mb3JrID09PSBmb3JrKSB7CiAgICAgIGNvbnN0IHUgPSB0aGlzLnJlcGxpY2F0b3IuX2FkZFVwZ3JhZGUoKQogICAgICB1LmluZmxpZ2h0LnB1c2gocmVxKQogICAgfQoKICAgIHRyeSB7CiAgICAgIGlmIChyZXEuYmxvY2sgIT09IG51bGwgJiYgcmVxLmZvcmsgPT09IGZvcmspIHsKICAgICAgICByZXEuYmxvY2subm9kZXMgPSBhd2FpdCBNZXJrbGVUcmVlLm1pc3NpbmdOb2RlcygKICAgICAgICAgIHRoaXMuY29yZS5zdGF0ZSwKICAgICAgICAgIDIgKiByZXEuYmxvY2suaW5kZXgsCiAgICAgICAgICB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoCiAgICAgICAgKQogICAgICAgIGlmIChyZXEucHJpb3JpdHkgPT09IFBSSU9SSVRZLkNBTkNFTExFRCkgcmV0dXJuCiAgICAgIH0KICAgICAgaWYgKHJlcS5oYXNoICE9PSBudWxsICYmIHJlcS5mb3JrID09PSBmb3JrICYmIHJlcS5oYXNoLm5vZGVzID09PSAwKSB7CiAgICAgICAgcmVxLmhhc2gubm9kZXMgPSBhd2FpdCBNZXJrbGVUcmVlLm1pc3NpbmdOb2RlcygKICAgICAgICAgIHRoaXMuY29yZS5zdGF0ZSwKICAgICAgICAgIHJlcS5oYXNoLmluZGV4LAogICAgICAgICAgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aAogICAgICAgICkKICAgICAgICBpZiAocmVxLnByaW9yaXR5ID09PSBQUklPUklUWS5DQU5DRUxMRUQpIHJldHVybgoKICAgICAgICAvLyBub2RlcyA9PT0gMCwgd2UgYWxyZWFkeSBoYXZlIGl0LCBiYWlsCiAgICAgICAgaWYgKHJlcS5oYXNoLm5vZGVzID09PSAwICYmIChyZXEuaGFzaC5pbmRleCAmIDEpID09PSAwKSB7CiAgICAgICAgICB0aGlzLmluZmxpZ2h0LS0KICAgICAgICAgIHRoaXMucmVwbGljYXRvci5fcmVzb2x2ZUhhc2hMb2NhbGx5KHRoaXMsIHJlcSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuc3RyZWFtLmRlc3Ryb3koZXJyKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLndpcmVSZXF1ZXN0LnNlbmQocmVxKQogICAgaW5jcmVtZW50VHgodGhpcy5zdGF0cy53aXJlUmVxdWVzdCwgdGhpcy5yZXBsaWNhdG9yLnN0YXRzLndpcmVSZXF1ZXN0KQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSZXBsaWNhdG9yIHsKICBzdGF0aWMgUGVlciA9IFBlZXIgLy8gaGFjayB0byBiZSBhYmxlIHRvIGFjY2VzcyBQZWVyIGZyb20gb3V0c2lkZSB0aGlzIG1vZHVsZQoKICBjb25zdHJ1Y3RvcigKICAgIGNvcmUsCiAgICB7CiAgICAgIG5vdERvd25sb2FkaW5nTGluZ2VyID0gTk9UX0RPV05MT0FESU5HX1NMQUNLLAogICAgICBlYWdlclVwZ3JhZGUgPSB0cnVlLAogICAgICBhbGxvd0ZvcmsgPSB0cnVlLAogICAgICBhbGxvd1B1c2ggPSBmYWxzZSwKICAgICAgYWx3YXlzTGF0ZXN0QmxvY2sgPSBmYWxzZSwKICAgICAgaW5mbGlnaHRSYW5nZSA9IG51bGwKICAgIH0gPSB7fQogICkgewogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy5lYWdlclVwZ3JhZGUgPSBlYWdlclVwZ3JhZGUKICAgIHRoaXMuYWxsb3dGb3JrID0gYWxsb3dGb3JrCiAgICB0aGlzLmFsbG93UHVzaCA9IGFsbG93UHVzaAogICAgdGhpcy5vbmRvd25sb2FkaW5nID0gbnVsbCAvLyBvcHRpb25hbCBleHRlcm5hbCBob29rIGZvciBtb25pdG9yaW5nIGRvd25sb2FkaW5nIHN0YXR1cwogICAgdGhpcy5wZWVycyA9IFtdCiAgICB0aGlzLmZpbmRpbmdQZWVycyA9IDAgLy8gdXBkYXRhYmxlIGZyb20gdGhlIG91dHNpZGUKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICAgIHRoaXMuZG93bmxvYWRpbmcgPSBmYWxzZQogICAgdGhpcy5hY3RpdmVTZXNzaW9ucyA9IDAKCiAgICB0aGlzLmhvdHN3YXBzID0gbmV3IEhvdHN3YXBRdWV1ZSgpCiAgICB0aGlzLmluZmxpZ2h0UmFuZ2UgPSBpbmZsaWdodFJhbmdlIHx8IERFRkFVTFRfTUFYX0lORkxJR0hUCgogICAgLy8gTm90ZTogbm9kYXRhIGFuZCB1bndhbnQgbm90IGN1cnJlbnRseSB0cmFja2VkCiAgICAvLyB0eCA9IHRyYW5zbWl0dGVkLCByeCA9IHJlY2VpdmVkCiAgICB0aGlzLnN0YXRzID0gewogICAgICB3aXJlU3luYzogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZVJlcXVlc3Q6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVDYW5jZWw6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVEYXRhOiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlV2FudDogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZUJpdGZpZWxkOiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlUmFuZ2U6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVFeHRlbnNpb246IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIGhvdHN3YXBzOiAwLAogICAgICBpbnZhbGlkRGF0YTogMCwKICAgICAgaW52YWxpZFJlcXVlc3RzOiAwLAogICAgICBiYWNrb2ZmczogMAogICAgfQoKICAgIHRoaXMuX2F0dGFjaGVkID0gbmV3IFNldCgpCiAgICB0aGlzLl9pbmZsaWdodCA9IG5ldyBJbmZsaWdodFRyYWNrZXIoKQogICAgdGhpcy5fYmxvY2tzID0gbmV3IEJsb2NrVHJhY2tlcih0aGlzKQogICAgdGhpcy5faGFzaGVzID0gbmV3IEJsb2NrVHJhY2tlcih0aGlzKQoKICAgIHRoaXMuX2Fsd2F5c0xhdGVzdEJsb2NrID0gYWx3YXlzTGF0ZXN0QmxvY2sgPyAxIDogMAogICAgdGhpcy5fcXVldWVkID0gW10KCiAgICB0aGlzLl9zZWVrcyA9IFtdCiAgICB0aGlzLl91cGdyYWRlID0gbnVsbAogICAgdGhpcy5fcmVvcmdzID0gW10KICAgIHRoaXMuX3JhbmdlcyA9IFtdCgogICAgdGhpcy5fcHVzaExvY2sgPSBuZXcgTXV0ZXgoKQogICAgdGhpcy5faGFkUGVlcnMgPSBmYWxzZQogICAgdGhpcy5fYWN0aXZlID0gMAogICAgdGhpcy5faWZBdmFpbGFibGUgPSAwCiAgICB0aGlzLl91cGRhdGVzUGVuZGluZyA9IDAKICAgIHRoaXMuX2FwcGx5aW5nUmVvcmcgPSBudWxsCiAgICB0aGlzLl9tYW5pZmVzdFBlZXIgPSBudWxsCiAgICB0aGlzLl9ub3REb3dubG9hZGluZ0xpbmdlciA9IG5vdERvd25sb2FkaW5nTGluZ2VyCiAgICB0aGlzLl9kb3dubG9hZGluZ1RpbWVyID0gbnVsbAoKICAgIGNvbnN0IHNlbGYgPSB0aGlzCiAgICB0aGlzLl9vbnN0cmVhbWNsb3NlID0gb25zdHJlYW1jbG9zZQoKICAgIGZ1bmN0aW9uIG9uc3RyZWFtY2xvc2UoKSB7CiAgICAgIHNlbGYuZGV0YWNoRnJvbSh0aGlzLnVzZXJEYXRhKQogICAgfQogIH0KCiAgdXBkYXRlQWN0aXZpdHkoaW5jLCBzZXNzaW9uKSB7CiAgICB0aGlzLmFjdGl2ZVNlc3Npb25zICs9IGluYwogICAgdGhpcy5zZXREb3dubG9hZGluZyh0aGlzLmFjdGl2ZVNlc3Npb25zICE9PSAwLCBzZXNzaW9uKQogIH0KCiAgaXNEb3dubG9hZGluZygpIHsKICAgIHJldHVybiB0aGlzLmRvd25sb2FkaW5nIHx8ICF0aGlzLl9pbmZsaWdodC5pZGxlCiAgfQoKICBhc3luYyBwdXNoKGluZGV4KSB7CiAgICBjb25zdCBhbGwgPSBbXQogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHsKICAgICAgYWxsLnB1c2gocGVlci5wdXNoKGluZGV4KSkKICAgIH0KICAgIGF3YWl0IFByb21pc2UuYWxsKGFsbCkKICB9CgogIHNldEFsbG93UHVzaChhbGxvd1B1c2gpIHsKICAgIGlmIChhbGxvd1B1c2ggPT09IHRoaXMuYWxsb3dQdXNoKSByZXR1cm4KICAgIHRoaXMuYWxsb3dQdXNoID0gYWxsb3dQdXNoCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5zZW5kU3luYygpCiAgfQoKICBzZXREb3dubG9hZGluZyhkb3dubG9hZGluZykgewogICAgY2xlYXJUaW1lb3V0KHRoaXMuX2Rvd25sb2FkaW5nVGltZXIpCgogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIGlmIChkb3dubG9hZGluZyB8fCB0aGlzLl9ub3REb3dubG9hZGluZ0xpbmdlciA9PT0gMCkgewogICAgICB0aGlzLnNldERvd25sb2FkaW5nTm93KGRvd25sb2FkaW5nKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLl9kb3dubG9hZGluZ1RpbWVyID0gc2V0VGltZW91dCgKICAgICAgc2V0RG93bmxvYWRpbmdMYXRlciwKICAgICAgdGhpcy5fbm90RG93bmxvYWRpbmdMaW5nZXIsCiAgICAgIHRoaXMsCiAgICAgIGRvd25sb2FkaW5nCiAgICApCiAgICBpZiAodGhpcy5fZG93bmxvYWRpbmdUaW1lci51bnJlZikgdGhpcy5fZG93bmxvYWRpbmdUaW1lci51bnJlZigpCiAgfQoKICBzZXREb3dubG9hZGluZ05vdyhkb3dubG9hZGluZykgewogICAgdGhpcy5fZG93bmxvYWRpbmdUaW1lciA9IG51bGwKICAgIGlmICh0aGlzLmRvd25sb2FkaW5nID09PSBkb3dubG9hZGluZykgcmV0dXJuCiAgICB0aGlzLmRvd25sb2FkaW5nID0gZG93bmxvYWRpbmcKICAgIGlmICghZG93bmxvYWRpbmcgJiYgdGhpcy5pc0Rvd25sb2FkaW5nKCkpIHJldHVybgoKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSBwZWVyLnNpZ25hbFVwZ3JhZGUoKQoKICAgIGlmIChkb3dubG9hZGluZykgewogICAgICAvLyByZXN0YXJ0IGNoYW5uZWwgaWYgbmVlZGVkLi4uCiAgICAgIGZvciAoY29uc3QgcHJvdG9tdXggb2YgdGhpcy5fYXR0YWNoZWQpIHsKICAgICAgICBpZiAoIXByb3RvbXV4LnN0cmVhbS5oYW5kc2hha2VIYXNoKSBjb250aW51ZQogICAgICAgIGlmIChwcm90b211eC5vcGVuZWQoeyBwcm90b2NvbDogJ2h5cGVyY29yZS9hbHBoYScsIGlkOiB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5IH0pKSBjb250aW51ZQogICAgICAgIHRoaXMuX21ha2VQZWVyKHByb3RvbXV4LCB0cnVlKQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5jbG9zZUlmSWRsZSgpCiAgICB9CgogICAgaWYgKHRoaXMub25kb3dubG9hZGluZyAhPT0gbnVsbCAmJiBkb3dubG9hZGluZykgdGhpcy5vbmRvd25sb2FkaW5nKCkKICB9CgogIGNvcmsoKSB7CiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5wcm90b211eC5jb3JrKCkKICB9CgogIHVuY29yaygpIHsKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSBwZWVyLnByb3RvbXV4LnVuY29yaygpCiAgfQoKICAvLyBDYWxsZWQgZXh0ZXJuYWxseSB3aGVuIGEgcmFuZ2Ugb2YgbmV3IGJsb2NrcyBoYXMgYmVlbiBwcm9jZXNzZWQvcmVtb3ZlZAogIG9uaGF2ZShzdGFydCwgbGVuZ3RoLCBkcm9wID0gZmFsc2UpIHsKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSBwZWVyLmJyb2FkY2FzdFJhbmdlKHN0YXJ0LCBsZW5ndGgsIGRyb3ApCiAgfQoKICAvLyBDYWxsZWQgZXh0ZXJuYWxseSB3aGVuIGEgdHJ1bmNhdGlvbiB1cGdyYWRlIGhhcyBiZWVuIHByb2Nlc3NlZAogIG9udHJ1bmNhdGUobmV3TGVuZ3RoLCB0cnVuY2F0ZWQpIHsKICAgIGNvbnN0IG5vdGlmeSA9IFtdCgogICAgZm9yIChjb25zdCBibGsgb2YgdGhpcy5fYmxvY2tzKSB7CiAgICAgIGlmIChibGsuaW5kZXggPCBuZXdMZW5ndGgpIGNvbnRpbnVlCiAgICAgIG5vdGlmeS5wdXNoKGJsaykKICAgIH0KCiAgICBmb3IgKGNvbnN0IGJsayBvZiBub3RpZnkpIHsKICAgICAgZm9yIChjb25zdCByIG9mIGJsay5yZWZzKSB7CiAgICAgICAgaWYgKHIuc25hcHNob3QgPT09IGZhbHNlKSBjb250aW51ZQogICAgICAgIGJsay5kZXRhY2gociwgU05BUFNIT1RfTk9UX0FWQUlMQUJMRSgpKQogICAgICB9CiAgICB9CgogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHBlZXIuX3VuY2xlYXJMb2NhbFJhbmdlKG5ld0xlbmd0aCwgdHJ1bmNhdGVkKQogIH0KCiAgLy8gQ2FsbGVkIGV4dGVybmFsbHkgd2hlbiBhIHVwZ3JhZGUgaGFzIGJlZW4gcHJvY2Vzc2VkCiAgb251cGdyYWRlKCkgewogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHBlZXIuc2lnbmFsVXBncmFkZSgpCiAgICBpZiAodGhpcy5fYmxvY2tzLmlzRW1wdHkoKSA9PT0gZmFsc2UpIHRoaXMuX3Jlc29sdmVCbG9ja3NMb2NhbGx5KCkKICAgIGlmICh0aGlzLl91cGdyYWRlICE9PSBudWxsKSB0aGlzLl9yZXNvbHZlVXBncmFkZVJlcXVlc3QobnVsbCkKICAgIGlmICghdGhpcy5fYmxvY2tzLmlzRW1wdHkoKSB8fCB0aGlzLl9yYW5nZXMubGVuZ3RoICE9PSAwIHx8IHRoaXMuX3NlZWtzLmxlbmd0aCAhPT0gMCkgewogICAgICB0aGlzLl91cGRhdGVOb25QcmltYXJ5KHRydWUpCiAgICB9CiAgfQoKICAvLyBDYWxsZWQgZXh0ZXJuYWxseSB3aGVuIGEgY29uZmxpY3QgaGFzIGJlZW4gZGV0ZWN0ZWQgYW5kIHZlcmlmaWVkCiAgYXN5bmMgb25jb25mbGljdCgpIHsKICAgIGNvbnN0IGFsbCA9IFtdCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgewogICAgICBhbGwucHVzaChwZWVyLl9vbmNvbmZsaWN0KCkpCiAgICB9CiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoYWxsKQogIH0KCiAgYXN5bmMgYXBwbHlQZW5kaW5nUmVvcmcoKSB7CiAgICBpZiAodGhpcy5fYXBwbHlpbmdSZW9yZyAhPT0gbnVsbCkgewogICAgICBhd2FpdCB0aGlzLl9hcHBseWluZ1Jlb3JnCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgZm9yIChsZXQgaSA9IHRoaXMuX3Jlb3Jncy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBmID0gdGhpcy5fcmVvcmdzW2ldCiAgICAgIGlmIChmLmJhdGNoICE9PSBudWxsICYmIGYuYmF0Y2guZmluaXNoZWQpIHsKICAgICAgICBhd2FpdCB0aGlzLl9hcHBseVJlb3JnKGYpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgYWRkVXBncmFkZShzZXNzaW9uKSB7CiAgICBpZiAodGhpcy5fdXBncmFkZSAhPT0gbnVsbCkgewogICAgICBjb25zdCByZWYgPSB0aGlzLl91cGdyYWRlLmF0dGFjaChzZXNzaW9uKQogICAgICB0aGlzLl9jaGVja1VwZ3JhZGVJZkF2YWlsYWJsZSgpCiAgICAgIHJldHVybiByZWYKICAgIH0KCiAgICBjb25zdCByZWYgPSB0aGlzLl9hZGRVcGdyYWRlKCkuYXR0YWNoKHNlc3Npb24pCgogICAgdGhpcy51cGRhdGVBbGwoKQoKICAgIHJldHVybiByZWYKICB9CgogIGFkZEJsb2NrKHNlc3Npb24sIGluZGV4KSB7CiAgICBjb25zdCBiID0gdGhpcy5fYmxvY2tzLmFkZChpbmRleCwgUFJJT1JJVFkuSElHSCkKICAgIGNvbnN0IHJlZiA9IGIuYXR0YWNoKHNlc3Npb24pCgogICAgdGhpcy5fcXVldWVCbG9jayhiKQogICAgdGhpcy51cGRhdGVBbGwoKQoKICAgIHJldHVybiByZWYKICB9CgogIGFkZFNlZWsoc2Vzc2lvbiwgc2Vla2VyKSB7CiAgICBjb25zdCBzID0gbmV3IFNlZWtSZXF1ZXN0KHRoaXMsIHRoaXMuX3NlZWtzLCBzZWVrZXIpCiAgICBjb25zdCByZWYgPSBzLmF0dGFjaChzZXNzaW9uKQoKICAgIHRoaXMuX3NlZWtzLnB1c2gocykKICAgIHRoaXMudXBkYXRlQWxsKCkKCiAgICByZXR1cm4gcmVmCiAgfQoKICBhZGRSYW5nZSgKICAgIHNlc3Npb24sCiAgICB7CiAgICAgIHN0YXJ0ID0gMCwKICAgICAgZW5kID0gLTEsCiAgICAgIGxlbmd0aCA9IHRvTGVuZ3RoKHN0YXJ0LCBlbmQpLAogICAgICBibG9ja3MgPSBudWxsLAogICAgICBsaW5lYXIgPSBmYWxzZSwKICAgICAgaWZBdmFpbGFibGUgPSBmYWxzZQogICAgfSA9IHt9CiAgKSB7CiAgICBpZiAoYmxvY2tzICE9PSBudWxsKSB7CiAgICAgIC8vIGlmIHVzaW5nIGJsb2Nrcywgc3RhcnQsIGVuZCBqdXN0IGFjdHMgYXMgZnJhbWVzIGFyb3VuZCB0aGUgYmxvY2tzIGFycmF5CiAgICAgIHN0YXJ0ID0gMAogICAgICBlbmQgPSBsZW5ndGggPSBibG9ja3MubGVuZ3RoCiAgICB9CgogICAgY29uc3QgciA9IG5ldyBSYW5nZVJlcXVlc3QoCiAgICAgIHRoaXMsCiAgICAgIHRoaXMuX3JhbmdlcywKICAgICAgc3RhcnQsCiAgICAgIGxlbmd0aCA9PT0gLTEgPyAtMSA6IHN0YXJ0ICsgbGVuZ3RoLAogICAgICBsaW5lYXIsCiAgICAgIGlmQXZhaWxhYmxlLAogICAgICBibG9ja3MKICAgICkKCiAgICBjb25zdCByZWYgPSByLmF0dGFjaChzZXNzaW9uKQoKICAgIC8vIFRyaWdnZXIgdGhpcyB0byBzZWUgaWYgdGhpcyBpcyBhbHJlYWR5IHJlc29sdmVkLi4uCiAgICAvLyBBbHNvIGF1dG8gY29tcHJlc3NlcyB0aGUgcmFuZ2UgYmFzZWQgb24gbG9jYWwgYml0ZmllbGQKICAgIGNsYW1wUmFuZ2UodGhpcy5jb3JlLCByKQoKICAgIGlmIChyLmVuZCAhPT0gLTEgJiYgci5zdGFydCA+PSByLmVuZCkgewogICAgICB0aGlzLl9yZXNvbHZlUmFuZ2VSZXF1ZXN0KHIpCiAgICAgIHJldHVybiByZWYKICAgIH0KCiAgICB0aGlzLnVwZGF0ZUFsbCgpCgogICAgcmV0dXJuIHJlZgogIH0KCiAgY2FuY2VsKHJlZikgewogICAgcmVmLmNvbnRleHQuZGV0YWNoKHJlZiwgbnVsbCkKICB9CgogIHN0YXRpYyBjbGVhclJlcXVlc3RzKHNlc3Npb24sIGVycikgewogICAgaWYgKHNlc3Npb24ubGVuZ3RoID09PSAwKSByZXR1cm4KCiAgICBjb25zdCB1cGRhdGVkID0gbmV3IFNldCgpCgogICAgd2hpbGUgKHNlc3Npb24ubGVuZ3RoID4gMCkgewogICAgICBjb25zdCByZWYgPSBzZXNzaW9uW3Nlc3Npb24ubGVuZ3RoIC0gMV0KICAgICAgdXBkYXRlZC5hZGQocmVmLmNvbnRleHQucmVwbGljYXRvcikKICAgICAgcmVmLmNvbnRleHQuZGV0YWNoKHJlZiwgZXJyKQogICAgfQoKICAgIGZvciAoY29uc3QgcmVwbGljYXRvciBvZiB1cGRhdGVkKSB7CiAgICAgIHJlcGxpY2F0b3IudXBkYXRlQWxsKCkKICAgIH0KICB9CgogIGNsZWFyUmVxdWVzdHMoc2Vzc2lvbiwgZXJyID0gbnVsbCkgewogICAgbGV0IGNsZWFyZWQgPSBmYWxzZQogICAgd2hpbGUgKHNlc3Npb24ubGVuZ3RoID4gMCkgewogICAgICBjb25zdCByZWYgPSBzZXNzaW9uW3Nlc3Npb24ubGVuZ3RoIC0gMV0KICAgICAgcmVmLmNvbnRleHQuZGV0YWNoKHJlZiwgZXJyKQogICAgICBjbGVhcmVkID0gdHJ1ZQogICAgfQoKICAgIGlmIChjbGVhcmVkKSB0aGlzLnVwZGF0ZUFsbCgpCiAgfQoKICBfbWF0Y2hpbmdSZXF1ZXN0KHJlcSwgZGF0YSkgewogICAgaWYgKHRoaXMuYWxsb3dQdXNoKSB7CiAgICAgIHJldHVybiB0cnVlCiAgICB9CiAgICBpZiAoZGF0YS5ibG9jayAhPT0gbnVsbCAmJiAocmVxLmJsb2NrID09PSBudWxsIHx8IHJlcS5ibG9jay5pbmRleCAhPT0gZGF0YS5ibG9jay5pbmRleCkpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgICBpZiAoZGF0YS5oYXNoICE9PSBudWxsICYmIChyZXEuaGFzaCA9PT0gbnVsbCB8fCByZXEuaGFzaC5pbmRleCAhPT0gZGF0YS5oYXNoLmluZGV4KSkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICAgIGlmIChkYXRhLnNlZWsgIT09IG51bGwgJiYgKHJlcS5zZWVrID09PSBudWxsIHx8IHJlcS5zZWVrLmJ5dGVzICE9PSBkYXRhLnNlZWsuYnl0ZXMpKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogICAgaWYgKGRhdGEudXBncmFkZSAhPT0gbnVsbCAmJiByZXEudXBncmFkZSA9PT0gbnVsbCkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICAgIHJldHVybiByZXEuZm9yayA9PT0gZGF0YS5mb3JrCiAgfQoKICBfYWRkVXBncmFkZU1heWJlKCkgewogICAgcmV0dXJuIHRoaXMuZWFnZXJVcGdyYWRlID09PSB0cnVlID8gdGhpcy5fYWRkVXBncmFkZSgpIDogdGhpcy5fdXBncmFkZQogIH0KCiAgLy8gVE9ETzogdGhpcyBmdW5jdGlvbiBpcyBPVkVSIGNhbGxlZCBhdG0sIGF0IGVhY2ggdXBkYXRlUGVlci91cGRhdGVBbGwKICAvLyBpbnN0ZWFkIGl0cyBtb3JlIGVmZmljaWVudCB0byBvbmx5IGNhbGwgaXQgd2hlbiB0aGUgY29uZGl0aW9ucyBpbiBoZXJlIGNoYW5nZSAtIGllIG9uIHN5bmMvYWRkL3JlbW92ZSBwZWVyCiAgLy8gRG8gdGhpcyB3aGVuIHdlIGhhdmUgbW9yZSB0ZXN0cy4KICBfY2hlY2tVcGdyYWRlSWZBdmFpbGFibGUoKSB7CiAgICBpZiAodGhpcy5faWZBdmFpbGFibGUgPiAwICYmIHRoaXMucGVlcnMubGVuZ3RoIDwgTUFYX1BFRVJTX1VQR1JBREUpIHJldHVybgogICAgaWYgKHRoaXMuX3VwZ3JhZGUgPT09IG51bGwgfHwgdGhpcy5fdXBncmFkZS5yZWZzLmxlbmd0aCA9PT0gMCkgcmV0dXJuCiAgICBpZiAodGhpcy5faGFkUGVlcnMgPT09IGZhbHNlICYmIHRoaXMuZmluZGluZ1BlZXJzID4gMCkgcmV0dXJuCgogICAgY29uc3QgbWF4UGVlcnMgPSBNYXRoLm1pbih0aGlzLnBlZXJzLmxlbmd0aCwgTUFYX1BFRVJTX1VQR1JBREUpCgogICAgLy8gY2hlY2sgaWYgYSBwZWVyIGNhbiB1cGdyYWRlIHVzCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtYXhQZWVyczsgaSsrKSB7CiAgICAgIGNvbnN0IHBlZXIgPSB0aGlzLnBlZXJzW2ldCgogICAgICBpZiAocGVlci5yZW1vdGVTeW5jZWQgPT09IGZhbHNlKSByZXR1cm4KCiAgICAgIGlmICh0aGlzLmNvcmUuc3RhdGUubGVuZ3RoID09PSAwICYmIHBlZXIucmVtb3RlTGVuZ3RoID4gMCkgcmV0dXJuCgogICAgICBpZiAocGVlci5yZW1vdGVMZW5ndGggPD0gdGhpcy5fdXBncmFkZS5sZW5ndGggfHwgcGVlci5yZW1vdGVGb3JrICE9PSB0aGlzLl91cGdyYWRlLmZvcmspIHsKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBpZiAocGVlci5zeW5jc1Byb2Nlc3NpbmcgPiAwKSByZXR1cm4KCiAgICAgIGlmIChwZWVyLmxlbmd0aEFja2VkICE9PSB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoICYmIHBlZXIucmVtb3RlRm9yayA9PT0gdGhpcy5jb3JlLnN0YXRlLmZvcmspIHsKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgaWYgKHBlZXIucmVtb3RlQ2FuVXBncmFkZSA9PT0gdHJ1ZSkgcmV0dXJuCiAgICB9CgogICAgLy8gY2hlY2sgaWYgcmVvcmdzIGluIHByb2dyZXNzLi4uCgogICAgaWYgKHRoaXMuX2FwcGx5aW5nUmVvcmcgIT09IG51bGwpIHJldHVybgoKICAgIC8vIFRPRE86IHdlIHByb2Igc2hvdWxkIE5PVCB3YWl0IGZvciBpbmZsaWdodCByZW9yZ3MgaGVyZSwgc2VlbXMgYmV0dGVyIHRvIGp1c3QgcmVzb2x2ZSB0aGUgdXBncmFkZQogICAgLy8gYW5kIHRoZW4gYXBwbHkgdGhlIHJlb3JnIG9uIHRoZSBuZXh0IGNhbGwgaW4gY2FzZSBpdCdzIHNsb3cgLSBuZWVkcyBzb21lIHRlc3RpbmcgaW4gcHJhY3RpY2UKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3Jlb3Jncy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCByID0gdGhpcy5fcmVvcmdzW2ldCiAgICAgIGlmIChyLmluZmxpZ2h0Lmxlbmd0aCA+IDApIHJldHVybgogICAgfQoKICAgIC8vIGlmIHNvbWV0aGluZyBpcyBpbmZsaWdodCwgd2FpdCBmb3IgdGhhdCBmaXJzdAogICAgaWYgKHRoaXMuX3VwZ3JhZGUuaW5mbGlnaHQubGVuZ3RoID4gMCkgcmV0dXJuCgogICAgLy8gbm90aGluZyB0byBkbywgaW5kaWNhdGUgbm8gdXBkYXRlIGF2YWlsCgogICAgY29uc3QgdSA9IHRoaXMuX3VwZ3JhZGUKICAgIHRoaXMuX3VwZ3JhZGUgPSBudWxsCiAgICB1LnJlc29sdmUoZmFsc2UpCiAgfQoKICBfYWRkVXBncmFkZSgpIHsKICAgIGlmICh0aGlzLl91cGdyYWRlICE9PSBudWxsKSByZXR1cm4gdGhpcy5fdXBncmFkZQoKICAgIC8vIFRPRE86IG5lZWRzIGEgcmVvcmc6IHRydWUvZmFsc2UgZmxhZyB0byBpbmRpY2F0ZSBpZiB0aGUgdXNlciByZXF1ZXN0ZWQgYSByZW9yZwogICAgdGhpcy5fdXBncmFkZSA9IG5ldyBVcGdyYWRlUmVxdWVzdCh0aGlzLCB0aGlzLmNvcmUuc3RhdGUuZm9yaywgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkKCiAgICByZXR1cm4gdGhpcy5fdXBncmFkZQogIH0KCiAgX2FkZFJlb3JnKGZvcmssIHBlZXIpIHsKICAgIGlmICh0aGlzLmFsbG93Rm9yayA9PT0gZmFsc2UpIHJldHVybiBudWxsCgogICAgLy8gVE9ETzogZWFnZXIgZ2Mgb2xkIHJlb3JncyBmcm9tIHRoZSBzYW1lIHBlZXIKICAgIC8vIG5vdCBzdXBlciBpbXBvcnRhbnQgYmVjYXVzZSB0aGV5J2xsIGdldCBnYydlZCB3aGVuIHRoZSByZXF1ZXN0IGZpbmlzaGVzCiAgICAvLyBidXQganVzdCBzcGFtIHRoZSByZW1vdGUgY2FuIGRvIC4uLgoKICAgIGZvciAoY29uc3QgZiBvZiB0aGlzLl9yZW9yZ3MpIHsKICAgICAgaWYgKGYuZm9yayA+IGZvcmsgJiYgZi5iYXRjaCAhPT0gbnVsbCkgcmV0dXJuIG51bGwKICAgICAgaWYgKGYuZm9yayA9PT0gZm9yaykgcmV0dXJuIGYKICAgIH0KCiAgICBjb25zdCBmID0gewogICAgICBmb3JrLAogICAgICBpbmZsaWdodDogW10sCiAgICAgIGJhdGNoOiBudWxsCiAgICB9CgogICAgdGhpcy5fcmVvcmdzLnB1c2goZikKCiAgICAvLyBtYWludGFpbiBzb3J0ZWQgYnkgZm9yawogICAgbGV0IGkgPSB0aGlzLl9yZW9yZ3MubGVuZ3RoIC0gMQogICAgd2hpbGUgKGkgPiAwICYmIHRoaXMuX3Jlb3Jnc1tpIC0gMV0uZm9yayA+IGZvcmspIHsKICAgICAgdGhpcy5fcmVvcmdzW2ldID0gdGhpcy5fcmVvcmdzW2kgLSAxXQogICAgICB0aGlzLl9yZW9yZ3NbLS1pXSA9IGYKICAgIH0KCiAgICByZXR1cm4gZgogIH0KCiAgX3Nob3VsZFVwZ3JhZGUocGVlcikgewogICAgaWYgKHRoaXMuX3VwZ3JhZGUgIT09IG51bGwgJiYgdGhpcy5fdXBncmFkZS5pbmZsaWdodC5sZW5ndGggPiAwKSByZXR1cm4gZmFsc2UKICAgIHJldHVybiAoCiAgICAgIHBlZXIucmVtb3RlQ2FuVXBncmFkZSA9PT0gdHJ1ZSAmJgogICAgICBwZWVyLnJlbW90ZUxlbmd0aCA+IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggJiYKICAgICAgcGVlci5sZW5ndGhBY2tlZCA9PT0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aAogICAgKQogIH0KCiAgX2F1dG9VcGdyYWRlKHBlZXIpIHsKICAgIHJldHVybiAoCiAgICAgIHRoaXMuX3VwZ3JhZGUgIT09IG51bGwgJiYKICAgICAgcGVlci5yZW1vdGVGb3JrID09PSB0aGlzLmNvcmUuc3RhdGUuZm9yayAmJgogICAgICB0aGlzLl9zaG91bGRVcGdyYWRlKHBlZXIpCiAgICApCiAgfQoKICBfYWRkUGVlcihwZWVyKSB7CiAgICB0aGlzLl9oYWRQZWVycyA9IHRydWUKICAgIHRoaXMucGVlcnMucHVzaChwZWVyKQogICAgdGhpcy51cGRhdGVQZWVyKHBlZXIpCiAgICB0aGlzLl9vbnBlZXJ1cGRhdGUodHJ1ZSwgcGVlcikKICB9CgogIF9yZXF1ZXN0RG9uZShpZCwgcm91bmR0cmlwKSB7CiAgICB0aGlzLl9pbmZsaWdodC5yZW1vdmUoaWQsIHJvdW5kdHJpcCkKICAgIGlmICh0aGlzLmlzRG93bmxvYWRpbmcoKSA9PT0gdHJ1ZSkgcmV0dXJuCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5zaWduYWxVcGdyYWRlKCkKICB9CgogIF9yZW1vdmVQZWVyKHBlZXIpIHsKICAgIHRoaXMucGVlcnMuc3BsaWNlKHRoaXMucGVlcnMuaW5kZXhPZihwZWVyKSwgMSkKCiAgICBpZiAodGhpcy5fbWFuaWZlc3RQZWVyID09PSBwZWVyKSB0aGlzLl9tYW5pZmVzdFBlZXIgPSBudWxsCgogICAgZm9yIChjb25zdCByZXEgb2YgdGhpcy5faW5mbGlnaHQpIHsKICAgICAgaWYgKHJlcS5wZWVyICE9PSBwZWVyKSBjb250aW51ZQogICAgICB0aGlzLl9pbmZsaWdodC5yZW1vdmUocmVxLmlkLCB0cnVlKQogICAgICB0aGlzLl9jbGVhclJlcXVlc3QocGVlciwgcmVxKQogICAgfQoKICAgIHRoaXMuX29ucGVlcnVwZGF0ZShmYWxzZSwgcGVlcikKICAgIHRoaXMudXBkYXRlQWxsKCkKICB9CgogIF9xdWV1ZUJsb2NrKGIpIHsKICAgIGlmIChiLmluZmxpZ2h0Lmxlbmd0aCA+IDAgfHwgYi5xdWV1ZWQgPT09IHRydWUpIHJldHVybgogICAgYi5xdWV1ZWQgPSB0cnVlCiAgICB0aGlzLl9xdWV1ZWQucHVzaChiKQogIH0KCiAgX3Jlc29sdmVIYXNoTG9jYWxseShwZWVyLCByZXEpIHsKICAgIHRoaXMuX3JlcXVlc3REb25lKHJlcS5pZCwgZmFsc2UpCiAgICB0aGlzLl9yZXNvbHZlQmxvY2tSZXF1ZXN0KHRoaXMuX2hhc2hlcywgcmVxLmhhc2guaW5kZXggLyAyLCBudWxsLCByZXEpCiAgICB0aGlzLnVwZGF0ZVBlZXIocGVlcikKICB9CgogIC8vIFJ1bnMgaW4gdGhlIGJhY2tncm91bmQgLSBub3QgYWxsb3dlZCB0byB0aHJvdwogIGFzeW5jIF9yZXNvbHZlQmxvY2tzTG9jYWxseSgpIHsKICAgIC8vIFRPRE86IGNoZWNrIGlmIGZvcmsgY29tcGF0IGV0Yy4gUmVxdWlyZXMgdGhhdCB3ZSBwYXNzIGRvd24gdHJ1bmNhdGlvbiBpbmZvCgogICAgY29uc3QgY2xlYXIgPSBbXQogICAgY29uc3QgYmxvY2tzID0gW10KCiAgICBjb25zdCByZWFkZXIgPSB0aGlzLmNvcmUuc3RvcmFnZS5yZWFkKCkKICAgIGZvciAoY29uc3QgYiBvZiB0aGlzLl9ibG9ja3MpIHsKICAgICAgaWYgKHRoaXMuY29yZS5iaXRmaWVsZC5nZXQoYi5pbmRleCkgPT09IGZhbHNlKSBjb250aW51ZQogICAgICBibG9ja3MucHVzaCh0aGlzLl9yZXNvbHZlTG9jYWxCbG9jayhiLCByZWFkZXIsIGNsZWFyKSkKICAgIH0KICAgIHJlYWRlci50cnlGbHVzaCgpCgogICAgYXdhaXQgUHJvbWlzZS5hbGwoYmxvY2tzKQoKICAgIGlmICghY2xlYXIubGVuZ3RoKSByZXR1cm4KCiAgICAvLyBDdXJyZW50bHkgdGhlIGJsb2NrIHRyYWNrZXIgZG9lcyBub3Qgc3VwcG9ydCBkZWxldGVzIGR1cmluZyBpdGVyYXRpb24sIHNvIHdlIG1ha2UKICAgIC8vIHN1cmUgdG8gY2xlYXIgdGhlbSBhZnRlcndhcmRzLgogICAgZm9yIChjb25zdCBiIG9mIGNsZWFyKSB7CiAgICAgIHRoaXMuX2Jsb2Nrcy5yZW1vdmUoYi5pbmRleCkKICAgICAgcmVtb3ZlSG90c3dhcChiKQogICAgfQogIH0KCiAgYXN5bmMgX3Jlc29sdmVMb2NhbEJsb2NrKGIsIHJlYWRlciwgcmVzb2x2ZWQpIHsKICAgIHRyeSB7CiAgICAgIGIucmVzb2x2ZShhd2FpdCByZWFkZXIuZ2V0QmxvY2soYi5pbmRleCkpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgYi5yZWplY3QoZXJyKQogICAgICByZXR1cm4KICAgIH0KCiAgICByZXNvbHZlZC5wdXNoKGIpCiAgfQoKICBfcmVzb2x2ZUJsb2NrUmVxdWVzdCh0cmFja2VyLCBpbmRleCwgdmFsdWUsIHJlcSkgewogICAgY29uc3QgYiA9IHRyYWNrZXIucmVtb3ZlKGluZGV4KQogICAgaWYgKGIgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIHJlbW92ZUluZmxpZ2h0KGIuaW5mbGlnaHQsIHJlcSkKICAgIHJlbW92ZUhvdHN3YXAoYikKICAgIGIucXVldWVkID0gZmFsc2UKCiAgICBiLnJlc29sdmUodmFsdWUpCgogICAgaWYgKGIuaW5mbGlnaHQubGVuZ3RoID4gMCkgewogICAgICAvLyBpZiBhbnl0aGluZyBpcyBzdGlsbCBpbmZsaWdodCwgY2FuY2VsIGl0CiAgICAgIGZvciAobGV0IGkgPSBiLmluZmxpZ2h0Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgY29uc3QgcmVxID0gYi5pbmZsaWdodFtpXQogICAgICAgIHJlcS5wZWVyLl9jYW5jZWxSZXF1ZXN0KHJlcSkKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfcmVzb2x2ZVVwZ3JhZGVSZXF1ZXN0KHJlcSkgewogICAgaWYgKHJlcSAhPT0gbnVsbCkgcmVtb3ZlSW5mbGlnaHQodGhpcy5fdXBncmFkZS5pbmZsaWdodCwgcmVxKQoKICAgIGlmICgKICAgICAgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCA9PT0gdGhpcy5fdXBncmFkZS5sZW5ndGggJiYKICAgICAgdGhpcy5jb3JlLnN0YXRlLmZvcmsgPT09IHRoaXMuX3VwZ3JhZGUuZm9yawogICAgKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnN0IHUgPSB0aGlzLl91cGdyYWRlCiAgICB0aGlzLl91cGdyYWRlID0gbnVsbAogICAgdS5yZXNvbHZlKHRydWUpCgogICAgcmV0dXJuIHRydWUKICB9CgogIF9yZXNvbHZlUmFuZ2VSZXF1ZXN0KHJlcSkgewogICAgcmVxLnJlc29sdmUodHJ1ZSkKICAgIHJlcS5nYygpCiAgfQoKICBfY2xlYXJJbmZsaWdodEJsb2NrKHRyYWNrZXIsIHJlcSkgewogICAgY29uc3QgaXNCbG9jayA9IHRyYWNrZXIgPT09IHRoaXMuX2Jsb2NrcwogICAgY29uc3QgaW5kZXggPSBpc0Jsb2NrID09PSB0cnVlID8gcmVxLmJsb2NrLmluZGV4IDogcmVxLmhhc2guaW5kZXggLyAyCiAgICBjb25zdCBiID0gdHJhY2tlci5nZXQoaW5kZXgpCgogICAgaWYgKGIgPT09IG51bGwgfHwgcmVtb3ZlSW5mbGlnaHQoYi5pbmZsaWdodCwgcmVxKSA9PT0gZmFsc2UpIHJldHVybgoKICAgIGlmIChyZW1vdmVIb3Rzd2FwKGIpID09PSB0cnVlICYmIGIuaW5mbGlnaHQubGVuZ3RoID4gMCkgewogICAgICB0aGlzLmhvdHN3YXBzLmFkZChiKQogICAgfQoKICAgIGlmIChiLnJlZnMubGVuZ3RoID4gMCAmJiBpc0Jsb2NrID09PSB0cnVlKSB7CiAgICAgIHRoaXMuX3F1ZXVlQmxvY2soYikKICAgICAgcmV0dXJuCiAgICB9CgogICAgYi5nYygpCiAgfQoKICBfY2xlYXJJbmZsaWdodFVwZ3JhZGUocmVxKSB7CiAgICBpZiAodGhpcy5fdXBncmFkZSA9PT0gbnVsbCB8fCByZW1vdmVJbmZsaWdodCh0aGlzLl91cGdyYWRlLmluZmxpZ2h0LCByZXEpID09PSBmYWxzZSkgcmV0dXJuCiAgICB0aGlzLl91cGdyYWRlLmdjKCkKICB9CgogIF9jbGVhckluZmxpZ2h0U2Vla3MocmVxKSB7CiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5fc2Vla3MpIHsKICAgICAgaWYgKHJlbW92ZUluZmxpZ2h0KHMuaW5mbGlnaHQsIHJlcSkgPT09IGZhbHNlKSBjb250aW51ZQogICAgICBzLmdjKCkKICAgIH0KICB9CgogIF9jbGVhckluZmxpZ2h0UmVvcmdzKHJlcSkgewogICAgZm9yIChjb25zdCByIG9mIHRoaXMuX3Jlb3JncykgewogICAgICByZW1vdmVJbmZsaWdodChyLmluZmxpZ2h0LCByZXEpCiAgICB9CiAgfQoKICBfY2xlYXJPbGRSZW9yZ3MoZm9yaykgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9yZW9yZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgZiA9IHRoaXMuX3Jlb3Jnc1tpXQogICAgICBpZiAoZi5mb3JrID49IGZvcmspIGNvbnRpbnVlCiAgICAgIGlmIChpID09PSB0aGlzLl9yZW9yZ3MubGVuZ3RoIC0gMSkgdGhpcy5fcmVvcmdzLnBvcCgpCiAgICAgIGVsc2UgdGhpcy5fcmVvcmdzW2ldID0gdGhpcy5fcmVvcmdzLnBvcCgpCiAgICAgIGktLQogICAgfQogIH0KCiAgLy8gInNsb3ciIHVwZGF0ZXMgaGVyZSAtIGFzeW5jIGJ1dCBub3QgYWxsb3dlZCB0byBldmVyIHRocm93CiAgYXN5bmMgX3VwZGF0ZU5vblByaW1hcnkodXBkYXRlQWxsKSB7CiAgICAvLyBDaGVjayBpZiBydW5uaW5nLCBpZiBzbyBza2lwIGl0IGFuZCB0aGUgcnVubmluZyBvbmUgd2lsbCBpc3N1ZSBhbm90aGVyIHVwZGF0ZSBmb3IgdXMgKGRlYm91bmNlKQogICAgd2hpbGUgKCsrdGhpcy5fdXBkYXRlc1BlbmRpbmcgPT09IDEpIHsKICAgICAgbGV0IGxlbiA9IE1hdGgubWluKE1BWF9SQU5HRVMsIHRoaXMuX3Jhbmdlcy5sZW5ndGgpCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgY29uc3QgciA9IHRoaXMuX3Jhbmdlc1tpXQoKICAgICAgICBjbGFtcFJhbmdlKHRoaXMuY29yZSwgcikKCiAgICAgICAgaWYgKHIuZW5kICE9PSAtMSAmJiByLnN0YXJ0ID49IHIuZW5kKSB7CiAgICAgICAgICB0aGlzLl9yZXNvbHZlUmFuZ2VSZXF1ZXN0KHIpCiAgICAgICAgICBpLS0KICAgICAgICAgIGlmIChsZW4gPiB0aGlzLl9yYW5nZXMubGVuZ3RoKSBsZW4tLQogICAgICAgICAgaWYgKHRoaXMuX3Jhbmdlcy5sZW5ndGggPT09IE1BWF9SQU5HRVMpIHVwZGF0ZUFsbCA9IHRydWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fc2Vla3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBzID0gdGhpcy5fc2Vla3NbaV0KCiAgICAgICAgbGV0IGVyciA9IG51bGwKICAgICAgICBsZXQgcmVzID0gbnVsbAoKICAgICAgICB0cnkgewogICAgICAgICAgcmVzID0gYXdhaXQgcy5zZWVrZXIudXBkYXRlKCkKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgZXJyID0gZXJyb3IKICAgICAgICB9CgogICAgICAgIGlmICghcmVzICYmICFlcnIpIGNvbnRpbnVlCgogICAgICAgIGlmIChpIDwgdGhpcy5fc2Vla3MubGVuZ3RoIC0gMSkgdGhpcy5fc2Vla3NbaV0gPSB0aGlzLl9zZWVrcy5wb3AoKQogICAgICAgIGVsc2UgdGhpcy5fc2Vla3MucG9wKCkKCiAgICAgICAgaS0tCgogICAgICAgIGlmIChlcnIpIHMucmVqZWN0KGVycikKICAgICAgICBlbHNlIHMucmVzb2x2ZShyZXMpCiAgICAgIH0KCiAgICAgIC8vIE5vIGFkZGl0aW9uYWwgdXBkYXRlcyBzY2hlZHVsZWQgLSBicmVhawogICAgICBpZiAoLS10aGlzLl91cGRhdGVzUGVuZGluZyA9PT0gMCkgYnJlYWsKICAgICAgLy8gRGVib3VuY2UgdGhlIGFkZGl0aW9uYWwgdXBkYXRlcyAtIGNvbnRpbnVlCiAgICAgIHRoaXMuX3VwZGF0ZXNQZW5kaW5nID0gMAogICAgfQoKICAgIGlmICh0aGlzLl9pbmZsaWdodC5pZGxlIHx8IHVwZGF0ZUFsbCkgdGhpcy51cGRhdGVBbGwoKQogIH0KCiAgX21heWJlUmVzb2x2ZUlmQXZhaWxhYmxlUmFuZ2VzKCkgewogICAgaWYgKHRoaXMuX2lmQXZhaWxhYmxlID4gMCB8fCAhdGhpcy5faW5mbGlnaHQuaWRsZSB8fCAhdGhpcy5fcmFuZ2VzLmxlbmd0aCkgcmV0dXJuCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBlZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0aGlzLnBlZXJzW2ldLmRhdGFQcm9jZXNzaW5nID4gMCkgcmV0dXJuCiAgICB9CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9yYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgciA9IHRoaXMuX3Jhbmdlc1tpXQoKICAgICAgaWYgKHIuaWZBdmFpbGFibGUpIHsKICAgICAgICB0aGlzLl9yZXNvbHZlUmFuZ2VSZXF1ZXN0KHIpCiAgICAgICAgaS0tCiAgICAgIH0KICAgIH0KICB9CgogIF9jbGVhclJlcXVlc3QocGVlciwgcmVxKSB7CiAgICBpZiAocmVxLmJsb2NrICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX2NsZWFySW5mbGlnaHRCbG9jayh0aGlzLl9ibG9ja3MsIHJlcSkKICAgICAgdGhpcy5fdW5tYXJrSW5mbGlnaHQocmVxLmJsb2NrLmluZGV4KQogICAgfQoKICAgIGlmIChyZXEuaGFzaCAhPT0gbnVsbCkgewogICAgICB0aGlzLl9jbGVhckluZmxpZ2h0QmxvY2sodGhpcy5faGFzaGVzLCByZXEpCiAgICB9CgogICAgaWYgKHJlcS51cGdyYWRlICE9PSBudWxsICYmIHRoaXMuX3VwZ3JhZGUgIT09IG51bGwpIHsKICAgICAgdGhpcy5fY2xlYXJJbmZsaWdodFVwZ3JhZGUocmVxKQogICAgfQoKICAgIGlmICh0aGlzLl9zZWVrcy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuX2NsZWFySW5mbGlnaHRTZWVrcyhyZXEpCiAgICB9CgogICAgaWYgKHRoaXMuX3Jlb3Jncy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuX2NsZWFySW5mbGlnaHRSZW9yZ3MocmVxKQogICAgfQogIH0KCiAgX29ubm9kYXRhKHBlZXIsIHJlcSwgcmVhc29uKSB7CiAgICBpZiAocmVhc29uID09PSBJTlZBTElEX1JFUVVFU1QpIHsKICAgICAgcGVlci5zdGF0cy5iYWNrb2ZmcysrCiAgICAgIHRoaXMuc3RhdHMuYmFja29mZnMrKwoKICAgICAgaWYgKHBlZXIuc3RhdHMuYmFja29mZnMgPj0gTUFYX0JBQ0tPRkZTKSB7CiAgICAgICAgcGVlci5wYXVzZWQgPSB0cnVlCiAgICAgIH0KICAgIH0KCiAgICBpZiAocmVxKSB7CiAgICAgIHRoaXMuX2NsZWFyUmVxdWVzdChwZWVyLCByZXEpCiAgICB9CgogICAgdGhpcy51cGRhdGVBbGwoKQogIH0KCiAgX29wZW5Ta2lwQml0ZmllbGQoKSB7CiAgICAvLyB0ZWNobmljYWxseSB0aGUgc2tpcCBiaXRmaWVsZCBnZXRzIGJpdHMgY2xlYXJlZCBpZiAuY2xlYXIoKSBpcyBjYWxsZWQKICAgIC8vIGFsc28gd2hpY2ggbWlnaHQgYmUgaW4gaW5mbGlnaHQgYWxzbywgYnV0IHRoYXQganVzdCByZXN1bHRzIGluIHRoYXQgc2VjdGlvbiBiZWluZyBvdmVyY2FsbGVkIHNob3J0bHkKICAgIC8vIHdvcnN0IGNhc2UsIHNvIG9rIGZvciBub3cKCiAgICBjb25zdCBiaXRmaWVsZCA9IHRoaXMuY29yZS5vcGVuU2tpcEJpdGZpZWxkKCkKCiAgICBmb3IgKGNvbnN0IHJlcSBvZiB0aGlzLl9pbmZsaWdodCkgewogICAgICBpZiAocmVxLmJsb2NrKSBiaXRmaWVsZC5zZXQocmVxLmJsb2NrLmluZGV4LCB0cnVlKSAvLyBza2lwCiAgICB9CiAgfQoKICBfbWFya1Byb2Nlc3NpbmcoaW5kZXgpIHsKICAgIGNvbnN0IGIgPSB0aGlzLl9ibG9ja3MuZ2V0KGluZGV4KQogICAgaWYgKGIpIHsKICAgICAgYi5wcm9jZXNzaW5nID0gdHJ1ZQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBoID0gdGhpcy5faGFzaGVzLmdldChpbmRleCkKICAgIGlmIChoKSBoLnByb2Nlc3NpbmcgPSB0cnVlCiAgfQoKICBfbWFya1Byb2Nlc3NlZChpbmRleCkgewogICAgY29uc3QgYiA9IHRoaXMuX2Jsb2Nrcy5nZXQoaW5kZXgpCiAgICBpZiAoYikgcmV0dXJuIGIucHJvY2Vzc2VkKCkKCiAgICBjb25zdCBoID0gdGhpcy5faGFzaGVzLmdldChpbmRleCkKICAgIGlmIChoKSBoLnByb2Nlc3NlZCgpCiAgfQoKICBfbWFya0luZmxpZ2h0KGluZGV4KSB7CiAgICBpZiAodGhpcy5jb3JlLnNraXBCaXRmaWVsZCAhPT0gbnVsbCkgdGhpcy5jb3JlLnNraXBCaXRmaWVsZC5zZXQoaW5kZXgsIHRydWUpCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5fbWFya0luZmxpZ2h0KGluZGV4KQogIH0KCiAgX3VubWFya0luZmxpZ2h0KGluZGV4KSB7CiAgICBpZiAodGhpcy5jb3JlLnNraXBCaXRmaWVsZCAhPT0gbnVsbCkgewogICAgICB0aGlzLmNvcmUuc2tpcEJpdGZpZWxkLnNldChpbmRleCwgdGhpcy5jb3JlLmJpdGZpZWxkLmdldChpbmRleCkpCiAgICB9CiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5fcmVzZXRNaXNzaW5nQmxvY2soaW5kZXgpCiAgfQoKICBmdWxseURvd25sb2FkZWQoKSB7CiAgICBpZiAoIXRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpIHJldHVybiBmYWxzZQogICAgcmV0dXJuIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggPT09IHRoaXMuY29yZS5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aAogIH0KCiAgX29uZGF0YShwZWVyLCByZXEsIGRhdGEpIHsKICAgIGlmIChyZXEpIHsKICAgICAgcmVxLmVsYXBzZWQgPSBEYXRlLm5vdygpIC0gcmVxLnRpbWVzdGFtcAogICAgfQoKICAgIGlmIChkYXRhLmJsb2NrICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX3Jlc29sdmVCbG9ja1JlcXVlc3QodGhpcy5fYmxvY2tzLCBkYXRhLmJsb2NrLmluZGV4LCBkYXRhLmJsb2NrLnZhbHVlLCByZXEpCiAgICAgIHRoaXMuX29uZG93bmxvYWQoZGF0YS5ibG9jay5pbmRleCwgZGF0YS5ibG9jay52YWx1ZS5ieXRlTGVuZ3RoLCBwZWVyLCByZXEpCiAgICB9CgogICAgaWYgKGRhdGEuaGFzaCAhPT0gbnVsbCAmJiAoZGF0YS5oYXNoLmluZGV4ICYgMSkgPT09IDApIHsKICAgICAgdGhpcy5fcmVzb2x2ZUJsb2NrUmVxdWVzdCh0aGlzLl9oYXNoZXMsIGRhdGEuaGFzaC5pbmRleCAvIDIsIG51bGwsIHJlcSkKICAgIH0KCiAgICBpZiAodGhpcy5fdXBncmFkZSAhPT0gbnVsbCkgewogICAgICB0aGlzLl9yZXNvbHZlVXBncmFkZVJlcXVlc3QocmVxKQogICAgfQoKICAgIGlmICh0aGlzLl9zZWVrcy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuX2NsZWFySW5mbGlnaHRTZWVrcyhyZXEpCiAgICB9CgogICAgaWYgKHRoaXMuX3Jlb3Jncy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuX2NsZWFySW5mbGlnaHRSZW9yZ3MocmVxKQogICAgfQoKICAgIGlmICh0aGlzLl9tYW5pZmVzdFBlZXIgPT09IHBlZXIgJiYgdGhpcy5jb3JlLmhlYWRlci5tYW5pZmVzdCAhPT0gbnVsbCkgewogICAgICB0aGlzLl9tYW5pZmVzdFBlZXIgPSBudWxsCiAgICB9CgogICAgaWYgKHRoaXMuX3NlZWtzLmxlbmd0aCA+IDAgfHwgdGhpcy5fcmFuZ2VzLmxlbmd0aCA+IDApIHsKICAgICAgdGhpcy5fdXBkYXRlTm9uUHJpbWFyeSh0aGlzLl9zZWVrcy5sZW5ndGggPiAwKQogICAgfQoKICAgIHRoaXMudXBkYXRlUGVlcihwZWVyKQogIH0KCiAgX29ud2FudChwZWVyLCBzdGFydCwgbGVuZ3RoKSB7CiAgICBpZiAoIXBlZXIuaXNBY3RpdmUoKSkgcmV0dXJuCgogICAgY29uc3QgY29udGlnID0gTWF0aC5taW4odGhpcy5jb3JlLnN0YXRlLmxlbmd0aCwgdGhpcy5jb3JlLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoKQoKICAgIGlmIChzdGFydCArIGxlbmd0aCA8IGNvbnRpZyB8fCB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoID09PSBjb250aWcpIHsKICAgICAgcGVlci53aXJlUmFuZ2Uuc2VuZCh7CiAgICAgICAgZHJvcDogZmFsc2UsCiAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgbGVuZ3RoOiBjb250aWcKICAgICAgfSkKICAgICAgaW5jcmVtZW50VHgocGVlci5zdGF0cy53aXJlUmFuZ2UsIHRoaXMuc3RhdHMud2lyZVJhbmdlKQogICAgICByZXR1cm4KICAgIH0KCiAgICBsZW5ndGggPSBNYXRoLm1pbihsZW5ndGgsIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggLSBzdGFydCkKCiAgICBwZWVyLnByb3RvbXV4LmNvcmsoKQoKICAgIGZvciAoY29uc3QgbXNnIG9mIHRoaXMuY29yZS5iaXRmaWVsZC53YW50KHN0YXJ0LCBsZW5ndGgpKSB7CiAgICAgIHBlZXIud2lyZUJpdGZpZWxkLnNlbmQobXNnKQogICAgICBpbmNyZW1lbnRUeChwZWVyLnN0YXRzLndpcmVCaXRmaWVsZCwgdGhpcy5zdGF0cy53aXJlQml0ZmllbGQpCiAgICB9CgogICAgcGVlci5wcm90b211eC51bmNvcmsoKQogIH0KCiAgYXN5bmMgX29ucmVvcmdkYXRhKHBlZXIsIHJlcSwgZGF0YSkgewogICAgY29uc3QgbmV3QmF0Y2ggPSBkYXRhLnVwZ3JhZGUgJiYgKGF3YWl0IHRoaXMuY29yZS52ZXJpZnlSZW9yZyhkYXRhKSkKICAgIGNvbnN0IGYgPSB0aGlzLl9hZGRSZW9yZyhkYXRhLmZvcmssIHBlZXIpCgogICAgaWYgKGYgPT09IG51bGwpIHsKICAgICAgdGhpcy51cGRhdGVBbGwoKQogICAgICByZXR1cm4KICAgIH0KCiAgICByZW1vdmVJbmZsaWdodChmLmluZmxpZ2h0LCByZXEpCgogICAgaWYgKGYuYmF0Y2gpIHsKICAgICAgYXdhaXQgZi5iYXRjaC51cGRhdGUoZGF0YSkKICAgIH0gZWxzZSBpZiAoZGF0YS51cGdyYWRlKSB7CiAgICAgIGYuYmF0Y2ggPSBuZXdCYXRjaAoKICAgICAgLy8gUmVtb3ZlICJvbGRlciIgcmVvcmdzIGluIHByb2dyZXNzIGFzIHdlIGp1c3QgdmVyaWZpZWQgdGhpcyBvbmUuCiAgICAgIHRoaXMuX2NsZWFyT2xkUmVvcmdzKGYuZm9yaykKICAgIH0KCiAgICBpZiAoZi5iYXRjaCAmJiBmLmJhdGNoLmZpbmlzaGVkKSB7CiAgICAgIGlmICh0aGlzLl9hZGRVcGdyYWRlTWF5YmUoKSAhPT0gbnVsbCkgewogICAgICAgIGF3YWl0IHRoaXMuX2FwcGx5UmVvcmcoZikKICAgICAgfQogICAgfQoKICAgIHRoaXMudXBkYXRlQWxsKCkKICB9CgogIC8vIE5ldmVyIHRocm93cywgYWxsb3dlZCB0byBydW4gaW4gdGhlIGJhY2tncm91bmQKICBhc3luYyBfYXBwbHlSZW9yZyhmKSB7CiAgICAvLyBUT0RPOiBtb3JlIG9wdGltYWwgaGVyZSB0byBjaGVjayBpZiBwb3RlbnRpYWxseSBhIGJldHRlciByZW9yZwogICAgLy8gaXMgYXZhaWxhYmxlLCBpZSBoaWdoZXIgZm9yaywgYW5kIHJlcXVlc3QgdGhhdCBvbmUgZmlyc3QuCiAgICAvLyBUaGlzIHdpbGwgcmVxdWVzdCB0aGF0IG9uZSBhZnRlciB0aGlzIGZpbmlzaGVzLCB3aGljaCBpcyBmaW5lLCBidXQgd2UKICAgIC8vIHNob3VsZCBpbnZlc3RpZ2F0ZSB0aGUgY29tcGxleGl0eSBpbiBnb2luZyB0aGUgb3RoZXIgd2F5CgogICAgY29uc3QgdSA9IHRoaXMuX3VwZ3JhZGUKCiAgICB0aGlzLl9yZW9yZ3MgPSBbXSAvLyBjbGVhciBhbGwgYXMgdGhlIG5vZGVzIGFyZSBhZ2FpbnN0IHRoZSBvbGQgdHJlZSAtIGVhc2llcgogICAgdGhpcy5fYXBwbHlpbmdSZW9yZyA9IHRoaXMuY29yZS5yZW9yZyhmLmJhdGNoLCBudWxsKSAvLyBUT0RPOiBudWxsIHNob3VsZCBiZSB0aGUgZmlyc3QvbGFzdCBwZWVyPwoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2FwcGx5aW5nUmVvcmcKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLl91cGdyYWRlID0gbnVsbAogICAgICB1LnJlamVjdChlcnIpCiAgICB9CgogICAgdGhpcy5fYXBwbHlpbmdSZW9yZyA9IG51bGwKCiAgICBpZiAodGhpcy5fdXBncmFkZSAhPT0gbnVsbCkgewogICAgICB0aGlzLl9yZXNvbHZlVXBncmFkZVJlcXVlc3QobnVsbCkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgdGhpcy5fdXBkYXRlRm9yayhwZWVyKQoKICAgIC8vIFRPRE86IGFsbCB0aGUgcmVtYWluaW5nIGlzIGEgdG1wIHdvcmthcm91bmQgdW50aWwgd2UgaGF2ZSBhIGZsYWcvd2F5IGZvciBBTllfRk9SSwogICAgZm9yIChjb25zdCByIG9mIHRoaXMuX3JhbmdlcykgewogICAgICByLnN0YXJ0ID0gci51c2VyU3RhcnQKICAgICAgci5lbmQgPSByLnVzZXJFbmQKICAgIH0KCiAgICB0aGlzLnVwZGF0ZUFsbCgpCiAgfQoKICBfbWF5YmVVcGRhdGUoKSB7CiAgICByZXR1cm4gdGhpcy5fdXBncmFkZSAhPT0gbnVsbCAmJiB0aGlzLl91cGdyYWRlLmluZmxpZ2h0Lmxlbmd0aCA9PT0gMAogIH0KCiAgX21heWJlUmVxdWVzdE1hbmlmZXN0KCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5oZWFkZXIubWFuaWZlc3QgPT09IG51bGwgJiYgdGhpcy5fbWFuaWZlc3RQZWVyID09PSBudWxsCiAgfQoKICBfdXBkYXRlRm9yayhwZWVyKSB7CiAgICBpZiAoCiAgICAgIHRoaXMuX2FwcGx5aW5nUmVvcmcgIT09IG51bGwgfHwKICAgICAgdGhpcy5hbGxvd0ZvcmsgPT09IGZhbHNlIHx8CiAgICAgIHBlZXIucmVtb3RlRm9yayA8PSB0aGlzLmNvcmUuc3RhdGUuZm9yawogICAgKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnN0IGYgPSB0aGlzLl9hZGRSZW9yZyhwZWVyLnJlbW90ZUZvcmssIHBlZXIpCgogICAgLy8gVE9ETzogb25lIHBlciBwZWVyIGlzIGJldHRlcgogICAgaWYgKGYgIT09IG51bGwgJiYgZi5iYXRjaCA9PT0gbnVsbCAmJiBmLmluZmxpZ2h0Lmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gcGVlci5fcmVxdWVzdEZvcmtQcm9vZihmKQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX3VwZGF0ZUhvdHN3YXAocGVlcikgewogICAgY29uc3QgbWF4SG90c3dhcHMgPSBwZWVyLmdldE1heEhvdHN3YXBJbmZsaWdodCgpCiAgICBpZiAoIXBlZXIuaXNBY3RpdmUoKSB8fCBwZWVyLmluZmxpZ2h0ID49IG1heEhvdHN3YXBzKSByZXR1cm4KCiAgICBmb3IgKGNvbnN0IGIgb2YgdGhpcy5ob3Rzd2Fwcy5waWNrKHBlZXIpKSB7CiAgICAgIGlmIChwZWVyLl9yZXF1ZXN0QmxvY2soYikgPT09IGZhbHNlKSBjb250aW51ZQogICAgICBwZWVyLnN0YXRzLmhvdHN3YXBzKysKICAgICAgcGVlci5yZXBsaWNhdG9yLnN0YXRzLmhvdHN3YXBzKysKICAgICAgaWYgKHBlZXIuaW5mbGlnaHQgPj0gbWF4SG90c3dhcHMpIGJyZWFrCiAgICB9CiAgfQoKICBfdXBkYXRlUGVlcihwZWVyKSB7CiAgICBpZiAoIXBlZXIuaXNBY3RpdmUoKSB8fCBwZWVyLmluZmxpZ2h0ID49IHBlZXIuZ2V0TWF4SW5mbGlnaHQoKSB8fCAhcGVlci5yZW1vdGVVcGxvYWRpbmcpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgLy8gRWFnZXJseSByZXF1ZXN0IHRoZSBtYW5pZmVzdCBldmVuIGlmIHRoZSByZW1vdGUgbGVuZ3RoIGlzIDAuIElmIG5vdCAwIHdlJ2xsIGdldCBhcyBwYXJ0IG9mIHRoZSB1cGdyYWRlIHJlcXVlc3QuLi4KICAgIGlmICgKICAgICAgdGhpcy5fbWF5YmVSZXF1ZXN0TWFuaWZlc3QoKSA9PT0gdHJ1ZSAmJgogICAgICBwZWVyLnJlbW90ZUxlbmd0aCA9PT0gMCAmJgogICAgICBwZWVyLnJlbW90ZUhhc01hbmlmZXN0ID09PSB0cnVlCiAgICApIHsKICAgICAgdGhpcy5fbWFuaWZlc3RQZWVyID0gcGVlcgogICAgICBwZWVyLl9yZXF1ZXN0TWFuaWZlc3QoKQogICAgfQoKICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLl9zZWVrcykgewogICAgICBpZiAocy5pbmZsaWdodC5sZW5ndGggPiAwKSBjb250aW51ZSAvLyBUT0RPOiBvbmUgcGVyIHBlZXIgaXMgYmV0dGVyCiAgICAgIGlmIChwZWVyLl9yZXF1ZXN0U2VlayhzKSA9PT0gdHJ1ZSkgewogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KCiAgICAvLyBJbXBsaWVkIHRoYXQgYW55IGJsb2NrIGluIHRoZSBxdWV1ZSBzaG91bGQgYmUgcmVxdWVzdGVkLCBubyBtYXR0ZXIgaG93IG1hbnkgaW5mbGlnaHRzCiAgICBjb25zdCBibGtzID0gbmV3IFJhbmRvbUl0ZXJhdG9yKHRoaXMuX3F1ZXVlZCkKCiAgICBmb3IgKGNvbnN0IGIgb2YgYmxrcykgewogICAgICBpZiAoYi5xdWV1ZWQgPT09IGZhbHNlIHx8IHBlZXIuX3JlcXVlc3RCbG9jayhiKSA9PT0gdHJ1ZSkgewogICAgICAgIGIucXVldWVkID0gZmFsc2UKICAgICAgICBibGtzLmRlcXVldWUoKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF91cGRhdGVQZWVyTm9uUHJpbWFyeShwZWVyKSB7CiAgICBpZiAoIXBlZXIuaXNBY3RpdmUoKSB8fCBwZWVyLmluZmxpZ2h0ID49IHBlZXIuZ2V0TWF4SW5mbGlnaHQoKSB8fCAhcGVlci5yZW1vdGVVcGxvYWRpbmcpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc3QgcmFuZ2VzID0gbmV3IFJhbmRvbUl0ZXJhdG9yKHRoaXMuX3JhbmdlcykKICAgIGxldCB0cmllZCA9IDAKCiAgICBmb3IgKGNvbnN0IHIgb2YgcmFuZ2VzKSB7CiAgICAgIGlmIChwZWVyLl9yZXF1ZXN0UmFuZ2UocikgPT09IHRydWUpIHsKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIGlmICgrK3RyaWVkID49IE1BWF9SQU5HRVMpIGJyZWFrCiAgICB9CgogICAgLy8gSXRlcmF0ZSBmcm9tIG5ld2VzdCBmb3JrIHRvIG9sZGVzdCBmb3JrLi4uCiAgICBmb3IgKGxldCBpID0gdGhpcy5fcmVvcmdzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IGYgPSB0aGlzLl9yZW9yZ3NbaV0KICAgICAgaWYgKGYuYmF0Y2ggIT09IG51bGwgJiYgZi5pbmZsaWdodC5sZW5ndGggPT09IDAgJiYgcGVlci5fcmVxdWVzdEZvcmtSYW5nZShmKSA9PT0gdHJ1ZSkgewogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5fbWF5YmVVcGRhdGUoKSA9PT0gdHJ1ZSAmJiBwZWVyLl9yZXF1ZXN0VXBncmFkZSh0aGlzLl91cGdyYWRlKSA9PT0gdHJ1ZSkgewogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgdXBkYXRlUGVlcihwZWVyKSB7CiAgICAvLyBRdWljayBzaG9ydGN1dCB0byB3YWl0IGZvciBmbHVzaGluZyByZW9yZ3MgLSBub3QgbmVlZGVkIGJ1dCBsZXNzIHdhaXN0ZWQgcmVxdWVzdHMKICAgIGlmICh0aGlzLl9hcHBseWluZ1Jlb3JnICE9PSBudWxsKSByZXR1cm4KCiAgICB3aGlsZSAodGhpcy5fdXBkYXRlUGVlcihwZWVyKSA9PT0gdHJ1ZSk7CiAgICB3aGlsZSAodGhpcy5fdXBkYXRlUGVlck5vblByaW1hcnkocGVlcikgPT09IHRydWUpOwoKICAgIGlmICh0aGlzLnBlZXJzLmxlbmd0aCA+IDEgJiYgdGhpcy5fYmxvY2tzLmlzRW1wdHkoKSA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5fdXBkYXRlSG90c3dhcChwZWVyKQogICAgfQoKICAgIHRoaXMuX2NoZWNrVXBncmFkZUlmQXZhaWxhYmxlKCkKICAgIHRoaXMuX21heWJlUmVzb2x2ZUlmQXZhaWxhYmxlUmFuZ2VzKCkKICB9CgogIHVwZGF0ZUFsbCgpIHsKICAgIC8vIFF1aWNrIHNob3J0Y3V0IHRvIHdhaXQgZm9yIGZsdXNoaW5nIHJlb3JncyAtIG5vdCBuZWVkZWQgYnV0IGxlc3Mgd2Fpc3RlZCByZXF1ZXN0cwogICAgaWYgKHRoaXMuX2FwcGx5aW5nUmVvcmcgIT09IG51bGwpIHJldHVybgoKICAgIGNvbnN0IHBlZXJzID0gbmV3IFJhbmRvbUl0ZXJhdG9yKHRoaXMucGVlcnMpCgogICAgZm9yIChjb25zdCBwZWVyIG9mIHBlZXJzKSB7CiAgICAgIGlmICh0aGlzLl91cGRhdGVQZWVyKHBlZXIpID09PSB0cnVlKSB7CiAgICAgICAgcGVlcnMucmVxdWV1ZSgpCiAgICAgIH0KICAgIH0KCiAgICAvLyBDaGVjayBpZiB3ZSBjYW4gc2tpcCB0aGUgbm9uIHByaW1hcnkgY2hlY2sgZnVsbHkKICAgIGlmICh0aGlzLl9tYXliZVVwZGF0ZSgpID09PSBmYWxzZSAmJiB0aGlzLl9yYW5nZXMubGVuZ3RoID09PSAwICYmIHRoaXMuX3Jlb3Jncy5sZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5fY2hlY2tVcGdyYWRlSWZBdmFpbGFibGUoKQogICAgICByZXR1cm4KICAgIH0KCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgcGVlcnMucmVzdGFydCgpKSB7CiAgICAgIGlmICh0aGlzLl91cGRhdGVQZWVyTm9uUHJpbWFyeShwZWVyKSA9PT0gdHJ1ZSkgewogICAgICAgIHBlZXJzLnJlcXVldWUoKQogICAgICB9CiAgICB9CgogICAgdGhpcy5fY2hlY2tVcGdyYWRlSWZBdmFpbGFibGUoKQogICAgdGhpcy5fbWF5YmVSZXNvbHZlSWZBdmFpbGFibGVSYW5nZXMoKQogIH0KCiAgb25wZWVyZGVzdHJveSgpIHsKICAgIGlmICgtLXRoaXMuX2FjdGl2ZSA9PT0gMCkgdGhpcy5jb3JlLmNoZWNrSWZJZGxlKCkKICB9CgogIGF0dGFjaGVkKHByb3RvbXV4KSB7CiAgICByZXR1cm4gdGhpcy5fYXR0YWNoZWQuaGFzKHByb3RvbXV4KQogIH0KCiAgYXR0YWNoVG8ocHJvdG9tdXgpIHsKICAgIGlmICh0aGlzLmNvcmUuY2xvc2VkKSByZXR1cm4KCiAgICBjb25zdCBtYWtlUGVlciA9IHRoaXMuX21ha2VQZWVyLmJpbmQodGhpcywgcHJvdG9tdXgpCgogICAgdGhpcy5fYXR0YWNoZWQuYWRkKHByb3RvbXV4KQogICAgcHJvdG9tdXgucGFpcih7IHByb3RvY29sOiAnaHlwZXJjb3JlL2FscGhhJywgaWQ6IHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkgfSwgbWFrZVBlZXIpCiAgICBwcm90b211eC5zdHJlYW0uc2V0TWF4TGlzdGVuZXJzKDApCiAgICBwcm90b211eC5zdHJlYW0ub24oJ2Nsb3NlJywgdGhpcy5fb25zdHJlYW1jbG9zZSkKCiAgICB0aGlzLl9pZkF2YWlsYWJsZSsrCiAgICB0aGlzLl9hY3RpdmUrKwoKICAgIHByb3RvbXV4LnN0cmVhbS5vcGVuZWQudGhlbigob3BlbmVkKSA9PiB7CiAgICAgIHRoaXMuX2lmQXZhaWxhYmxlLS0KICAgICAgdGhpcy5fYWN0aXZlLS0KCiAgICAgIGlmIChvcGVuZWQgJiYgIXRoaXMuZGVzdHJveWVkKSBtYWtlUGVlcigpCiAgICAgIHRoaXMuX2NoZWNrVXBncmFkZUlmQXZhaWxhYmxlKCkKCiAgICAgIHRoaXMuY29yZS5jaGVja0lmSWRsZSgpCiAgICB9KQogIH0KCiAgZGV0YWNoRnJvbShwcm90b211eCkgewogICAgaWYgKHRoaXMuX2F0dGFjaGVkLmRlbGV0ZShwcm90b211eCkpIHsKICAgICAgcHJvdG9tdXguc3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIHRoaXMuX29uc3RyZWFtY2xvc2UpCiAgICAgIHByb3RvbXV4LnVucGFpcih7IHByb3RvY29sOiAnaHlwZXJjb3JlL2FscGhhJywgaWQ6IHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkgfSkKICAgIH0KICB9CgogIGlkbGUoKSB7CiAgICByZXR1cm4gdGhpcy5wZWVycy5sZW5ndGggPT09IDAgJiYgdGhpcy5fYWN0aXZlID09PSAwCiAgfQoKICBjbG9zZSgpIHsKICAgIGNvbnN0IHdhaXRpbmcgPSBbXQoKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSB7CiAgICAgIHdhaXRpbmcucHVzaChwZWVyLmNoYW5uZWwuZnVsbHlDbG9zZWQoKSkKICAgIH0KCiAgICB0aGlzLmRlc3Ryb3koKQogICAgcmV0dXJuIFByb21pc2UuYWxsKHdhaXRpbmcpCiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQoKICAgIGlmICh0aGlzLl9kb3dubG9hZGluZ1RpbWVyKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9kb3dubG9hZGluZ1RpbWVyKQogICAgICB0aGlzLl9kb3dubG9hZGluZ1RpbWVyID0gbnVsbAogICAgfQoKICAgIHdoaWxlICh0aGlzLnBlZXJzLmxlbmd0aCkgewogICAgICBjb25zdCBwZWVyID0gdGhpcy5wZWVyc1t0aGlzLnBlZXJzLmxlbmd0aCAtIDFdCiAgICAgIHRoaXMuZGV0YWNoRnJvbShwZWVyLnByb3RvbXV4KQogICAgICBwZWVyLmNoYW5uZWwuY2xvc2UoKSAvLyBwZWVyIGlzIHJlbW92ZWQgZnJvbSBhcnJheSBpbiBvbmNsb3NlCiAgICB9CgogICAgZm9yIChjb25zdCBwcm90b211eCBvZiB0aGlzLl9hdHRhY2hlZCkgewogICAgICB0aGlzLmRldGFjaEZyb20ocHJvdG9tdXgpCiAgICB9CiAgfQoKICBfbWFrZVBlZXIocHJvdG9tdXgpIHsKICAgIGNvbnN0IHJlcGxpY2F0b3IgPSB0aGlzCiAgICBpZiAocHJvdG9tdXgub3BlbmVkKHsgcHJvdG9jb2w6ICdoeXBlcmNvcmUvYWxwaGEnLCBpZDogdGhpcy5jb3JlLmRpc2NvdmVyeUtleSB9KSkgewogICAgICByZXR1cm4gb25ub2NoYW5uZWwoKQogICAgfQoKICAgIGNvbnN0IGNoYW5uZWwgPSBwcm90b211eC5jcmVhdGVDaGFubmVsKHsKICAgICAgdXNlckRhdGE6IG51bGwsCiAgICAgIHByb3RvY29sOiAnaHlwZXJjb3JlL2FscGhhJywKICAgICAgYWxpYXNlczogWydoeXBlcmNvcmUnXSwKICAgICAgaWQ6IHRoaXMuY29yZS5kaXNjb3ZlcnlLZXksCiAgICAgIGhhbmRzaGFrZTogbS53aXJlLmhhbmRzaGFrZSwKICAgICAgbWVzc2FnZXM6IFsKICAgICAgICB7IGVuY29kaW5nOiBtLndpcmUuc3luYywgb25tZXNzYWdlOiBvbndpcmVzeW5jIH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLnJlcXVlc3QsIG9ubWVzc2FnZTogb253aXJlcmVxdWVzdCB9LAogICAgICAgIHsgZW5jb2Rpbmc6IG0ud2lyZS5jYW5jZWwsIG9ubWVzc2FnZTogb253aXJlY2FuY2VsIH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLmRhdGEsIG9ubWVzc2FnZTogb253aXJlZGF0YSB9LAogICAgICAgIHsgZW5jb2Rpbmc6IG0ud2lyZS5ub0RhdGEsIG9ubWVzc2FnZTogb253aXJlbm9kYXRhIH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLndhbnQsIG9ubWVzc2FnZTogb253aXJld2FudCB9LAogICAgICAgIHsgZW5jb2Rpbmc6IG0ud2lyZS51bndhbnQsIG9ubWVzc2FnZTogb253aXJldW53YW50IH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLmJpdGZpZWxkLCBvbm1lc3NhZ2U6IG9ud2lyZWJpdGZpZWxkIH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLnJhbmdlLCBvbm1lc3NhZ2U6IG9ud2lyZXJhbmdlIH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLmV4dGVuc2lvbiwgb25tZXNzYWdlOiBvbndpcmVleHRlbnNpb24gfQogICAgICBdLAogICAgICBvbm9wZW46IG9ud2lyZW9wZW4sCiAgICAgIG9uY2xvc2U6IG9ud2lyZWNsb3NlLAogICAgICBvbmRyYWluOiBvbndpcmVkcmFpbiwKICAgICAgb25kZXN0cm95OiBvbndpcmVkZXN0cm95CiAgICB9KQoKICAgIGlmIChjaGFubmVsID09PSBudWxsKSByZXR1cm4gb25ub2NoYW5uZWwoKQoKICAgIGNvbnN0IHBlZXIgPSBuZXcgUGVlcihyZXBsaWNhdG9yLCBwcm90b211eCwgY2hhbm5lbCwgdGhpcy5pbmZsaWdodFJhbmdlKQogICAgY29uc3Qgc3RyZWFtID0gcHJvdG9tdXguc3RyZWFtCgogICAgcGVlci5jaGFubmVsLm9wZW4oewogICAgICBzZWVrczogdHJ1ZSwKICAgICAgY2FwYWJpbGl0eTogY2Fwcy5yZXBsaWNhdGUoc3RyZWFtLmlzSW5pdGlhdG9yLCB0aGlzLmNvcmUua2V5LCBzdHJlYW0uaGFuZHNoYWtlSGFzaCkKICAgIH0pCgogICAgcmV0dXJuIHRydWUKCiAgICBmdW5jdGlvbiBvbm5vY2hhbm5lbCgpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQoKICBfb25wZWVydXBkYXRlKGFkZGVkLCBwZWVyKSB7CiAgICBjb25zdCBuYW1lID0gYWRkZWQgPyAncGVlci1hZGQnIDogJ3BlZXItcmVtb3ZlJwogICAgY29uc3Qgc2Vzc2lvbnMgPSB0aGlzLmNvcmUubW9uaXRvcnMKCiAgICBmb3IgKGxldCBpID0gc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgc2Vzc2lvbnNbaV0uZW1pdChuYW1lLCBwZWVyKQoKICAgICAgaWYgKGFkZGVkKSB7CiAgICAgICAgZm9yIChjb25zdCBleHQgb2Ygc2Vzc2lvbnNbaV0uZXh0ZW5zaW9ucy52YWx1ZXMoKSkgewogICAgICAgICAgcGVlci5leHRlbnNpb25zLnNldChleHQubmFtZSwgZXh0KQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgX29uZG93bmxvYWQoaW5kZXgsIGJ5dGVMZW5ndGgsIGZyb20sIHJlcSkgewogICAgY29uc3Qgc2Vzc2lvbnMgPSB0aGlzLmNvcmUubW9uaXRvcnMKCiAgICBmb3IgKGxldCBpID0gc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgcyA9IHNlc3Npb25zW2ldCiAgICAgIHMuZW1pdCgnZG93bmxvYWQnLCBpbmRleCwgYnl0ZUxlbmd0aCAtIHMucGFkZGluZywgZnJvbSwgcmVxKQogICAgfQogIH0KCiAgX29udXBsb2FkKGluZGV4LCBieXRlTGVuZ3RoLCBmcm9tKSB7CiAgICBjb25zdCBzZXNzaW9ucyA9IHRoaXMuY29yZS5tb25pdG9ycwoKICAgIGZvciAobGV0IGkgPSBzZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBzID0gc2Vzc2lvbnNbaV0KICAgICAgcy5lbWl0KCd1cGxvYWQnLCBpbmRleCwgYnl0ZUxlbmd0aCAtIHMucGFkZGluZywgZnJvbSkKICAgIH0KICB9CgogIF9vbmludmFsaWRkYXRhKGVyciwgcmVxLCByZXMsIGZyb20pIHsKICAgIGNvbnN0IHNlc3Npb25zID0gdGhpcy5jb3JlLm1vbml0b3JzCgogICAgdGhpcy5zdGF0cy5pbnZhbGlkRGF0YSsrCiAgICBmcm9tLnN0YXRzLmludmFsaWREYXRhKysKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2Vzc2lvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgc2Vzc2lvbnNbaV0uZW1pdCgndmVyaWZpY2F0aW9uLWVycm9yJywgZXJyLCByZXEsIHJlcywgZnJvbSkKICAgIH0KICB9CgogIF9vbmludmFsaWRyZXF1ZXN0KGVyciwgcmVxLCBmcm9tKSB7CiAgICBjb25zdCBzZXNzaW9ucyA9IHRoaXMuY29yZS5tb25pdG9ycwoKICAgIGZyb20uc3RhdHMuaW52YWxpZFJlcXVlc3RzKysKICAgIHRoaXMuc3RhdHMuaW52YWxpZFJlcXVlc3RzKysKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2Vzc2lvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgc2Vzc2lvbnNbaV0uZW1pdCgnaW52YWxpZC1yZXF1ZXN0JywgZXJyLCByZXEsIGZyb20pCiAgICB9CiAgfQp9CgpmdW5jdGlvbiByZW1vdmVIb3Rzd2FwKGJsb2NrKSB7CiAgaWYgKGJsb2NrLmhvdHN3YXAgPT09IG51bGwpIHJldHVybiBmYWxzZQogIGJsb2NrLmhvdHN3YXAucmVmLnJlbW92ZShibG9jaykKICByZXR1cm4gdHJ1ZQp9CgpmdW5jdGlvbiByZW1vdmVJbmZsaWdodChpbmYsIHJlcSkgewogIGNvbnN0IGkgPSBpbmYuaW5kZXhPZihyZXEpCiAgaWYgKGkgPT09IC0xKSByZXR1cm4gZmFsc2UKICBpZiAoaSA8IGluZi5sZW5ndGggLSAxKSBpbmZbaV0gPSBpbmYucG9wKCkKICBlbHNlIGluZi5wb3AoKQogIHJldHVybiB0cnVlCn0KCmZ1bmN0aW9uIHRvTGVuZ3RoKHN0YXJ0LCBlbmQpIHsKICByZXR1cm4gZW5kID09PSAtMSA/IC0xIDogZW5kIDwgc3RhcnQgPyAwIDogZW5kIC0gc3RhcnQKfQoKZnVuY3Rpb24gY2xhbXBSYW5nZShjb3JlLCByKSB7CiAgaWYgKHIuYmxvY2tzID09PSBudWxsKSB7CiAgICBjb25zdCBzdGFydCA9IGNvcmUuYml0ZmllbGQuZmlyc3RVbnNldChyLnN0YXJ0KQoKICAgIGlmIChyLmVuZCA9PT0gLTEpIHIuc3RhcnQgPSBzdGFydCA9PT0gLTEgPyBjb3JlLnN0YXRlLmxlbmd0aCA6IHN0YXJ0CiAgICBlbHNlIGlmIChzdGFydCA9PT0gLTEgfHwgc3RhcnQgPj0gci5lbmQpIHIuc3RhcnQgPSByLmVuZAogICAgZWxzZSB7CiAgICAgIHIuc3RhcnQgPSBzdGFydAoKICAgICAgY29uc3QgZW5kID0gY29yZS5iaXRmaWVsZC5sYXN0VW5zZXQoci5lbmQgLSAxKQoKICAgICAgaWYgKGVuZCA9PT0gLTEgfHwgc3RhcnQgPj0gZW5kICsgMSkgci5lbmQgPSByLnN0YXJ0CiAgICAgIGVsc2Ugci5lbmQgPSBlbmQgKyAxCiAgICB9CiAgfSBlbHNlIHsKICAgIHdoaWxlIChyLnN0YXJ0IDwgci5lbmQgJiYgY29yZS5iaXRmaWVsZC5nZXQoci5ibG9ja3Nbci5zdGFydF0pKSByLnN0YXJ0KysKICAgIHdoaWxlIChyLnN0YXJ0IDwgci5lbmQgJiYgY29yZS5iaXRmaWVsZC5nZXQoci5ibG9ja3Nbci5lbmQgLSAxXSkpIHIuZW5kLS0KICB9Cn0KCmZ1bmN0aW9uIG9ucmVxdWVzdHRpbWVvdXQocmVxKSB7CiAgaWYgKHJlcS5jb250ZXh0KSByZXEuY29udGV4dC5kZXRhY2gocmVxLCBSRVFVRVNUX1RJTUVPVVQoKSkKfQoKZnVuY3Rpb24gZGVzdHJveVJlcXVlc3RUaW1lb3V0KHJlcSkgewogIGlmIChyZXEudGltZW91dCAhPT0gbnVsbCkgewogICAgY2xlYXJUaW1lb3V0KHJlcS50aW1lb3V0KQogICAgcmVxLnRpbWVvdXQgPSBudWxsCiAgfQp9CgpmdW5jdGlvbiBpc0NyaXRpY2FsRXJyb3IoZXJyKSB7CiAgLy8gVE9ETzogZXhwb3NlIC5jcml0aWNhbCBvciBzaW1pbGFyIG9uIHRoZSBoeXBlcmNvcmUgZXJyb3JzIHRoYXQgYXJlIGNyaXRpY2FsIChpZiBhbGwgbm90IGFyZSkKICByZXR1cm4gZXJyLm5hbWUgPT09ICdIeXBlcmNvcmVFcnJvcicKfQoKZnVuY3Rpb24gb253aXJlb3BlbihtLCBjKSB7CiAgcmV0dXJuIGMudXNlckRhdGEub25vcGVuKG0pCn0KCmZ1bmN0aW9uIG9ud2lyZWNsb3NlKGlzUmVtb3RlLCBjKSB7CiAgcmV0dXJuIGMudXNlckRhdGEub25jbG9zZShpc1JlbW90ZSkKfQoKZnVuY3Rpb24gb253aXJlZGVzdHJveShjKSB7CiAgYy51c2VyRGF0YS5yZXBsaWNhdG9yLm9ucGVlcmRlc3Ryb3koKQp9CgpmdW5jdGlvbiBvbndpcmVkcmFpbihjKSB7CiAgcmV0dXJuIGMudXNlckRhdGEub25kcmFpbigpCn0KCmZ1bmN0aW9uIG9ud2lyZXN5bmMobSwgYykgewogIGluY3JlbWVudFJ4KGMudXNlckRhdGEuc3RhdHMud2lyZVN5bmMsIGMudXNlckRhdGEucmVwbGljYXRvci5zdGF0cy53aXJlU3luYykKICByZXR1cm4gYy51c2VyRGF0YS5vbnN5bmMobSkKfQoKZnVuY3Rpb24gb253aXJlcmVxdWVzdChtLCBjKSB7CiAgaW5jcmVtZW50UngoYy51c2VyRGF0YS5zdGF0cy53aXJlUmVxdWVzdCwgYy51c2VyRGF0YS5yZXBsaWNhdG9yLnN0YXRzLndpcmVSZXF1ZXN0KQogIHJldHVybiBjLnVzZXJEYXRhLm9ucmVxdWVzdChtKQp9CgpmdW5jdGlvbiBvbndpcmVjYW5jZWwobSwgYykgewogIGluY3JlbWVudFJ4KGMudXNlckRhdGEuc3RhdHMud2lyZUNhbmNlbCwgYy51c2VyRGF0YS5yZXBsaWNhdG9yLnN0YXRzLndpcmVDYW5jZWwpCiAgcmV0dXJuIGMudXNlckRhdGEub25jYW5jZWwobSkKfQoKZnVuY3Rpb24gb253aXJlZGF0YShtLCBjKSB7CiAgaW5jcmVtZW50UngoYy51c2VyRGF0YS5zdGF0cy53aXJlRGF0YSwgYy51c2VyRGF0YS5yZXBsaWNhdG9yLnN0YXRzLndpcmVEYXRhKQogIHJldHVybiBjLnVzZXJEYXRhLm9uZGF0YShtKQp9CgpmdW5jdGlvbiBvbndpcmVub2RhdGEobSwgYykgewogIHJldHVybiBjLnVzZXJEYXRhLm9ubm9kYXRhKG0pCn0KCmZ1bmN0aW9uIG9ud2lyZXdhbnQobSwgYykgewogIGluY3JlbWVudFJ4KGMudXNlckRhdGEuc3RhdHMud2lyZVdhbnQsIGMudXNlckRhdGEucmVwbGljYXRvci5zdGF0cy53aXJlV2FudCkKICByZXR1cm4gYy51c2VyRGF0YS5vbndhbnQobSkKfQoKZnVuY3Rpb24gb253aXJldW53YW50KG0sIGMpIHsKICByZXR1cm4gYy51c2VyRGF0YS5vbnVud2FudChtKQp9CgpmdW5jdGlvbiBvbndpcmViaXRmaWVsZChtLCBjKSB7CiAgaW5jcmVtZW50UngoYy51c2VyRGF0YS5zdGF0cy53aXJlQml0ZmllbGQsIGMudXNlckRhdGEucmVwbGljYXRvci5zdGF0cy53aXJlQml0ZmllbGQpCiAgcmV0dXJuIGMudXNlckRhdGEub25iaXRmaWVsZChtKQp9CgpmdW5jdGlvbiBvbndpcmVyYW5nZShtLCBjKSB7CiAgaW5jcmVtZW50UngoYy51c2VyRGF0YS5zdGF0cy53aXJlUmFuZ2UsIGMudXNlckRhdGEucmVwbGljYXRvci5zdGF0cy53aXJlUmFuZ2UpCiAgcmV0dXJuIGMudXNlckRhdGEub25yYW5nZShtKQp9CgpmdW5jdGlvbiBvbndpcmVleHRlbnNpb24obSwgYykgewogIGluY3JlbWVudFJ4KGMudXNlckRhdGEuc3RhdHMud2lyZUV4dGVuc2lvbiwgYy51c2VyRGF0YS5yZXBsaWNhdG9yLnN0YXRzLndpcmVFeHRlbnNpb24pCiAgcmV0dXJuIGMudXNlckRhdGEub25leHRlbnNpb24obSkKfQoKZnVuY3Rpb24gc2V0RG93bmxvYWRpbmdMYXRlcihyZXBsLCBkb3dubG9hZGluZywgc2Vzc2lvbikgewogIHJlcGwuc2V0RG93bmxvYWRpbmdOb3coZG93bmxvYWRpbmcsIHNlc3Npb24pCn0KCmZ1bmN0aW9uIGlzQmxvY2tSZXF1ZXN0KHJlcSkgewogIHJldHVybiByZXEgIT09IG51bGwgJiYgcmVxLmJsb2NrICE9PSBudWxsCn0KCmZ1bmN0aW9uIGlzVXBncmFkZVJlcXVlc3QocmVxKSB7CiAgcmV0dXJuIHJlcSAhPT0gbnVsbCAmJiByZXEudXBncmFkZSAhPT0gbnVsbAp9CgpmdW5jdGlvbiBpbmNyZW1lbnRUeChzdGF0czEsIHN0YXRzMikgewogIHN0YXRzMS50eCsrCiAgc3RhdHMyLnR4KysKfQoKZnVuY3Rpb24gaW5jcmVtZW50Ungoc3RhdHMxLCBzdGF0czIpIHsKICBzdGF0czEucngrKwogIHN0YXRzMi5yeCsrCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gYmFja29mZih0aW1lcykgewogIGNvbnN0IHNsZWVwID0gdGltZXMgPCAyID8gMjAwIDogdGltZXMgPCA1ID8gNTAwIDogdGltZXMgPCA0MCA/IDEwMDAgOiA1MDAwCiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIHNsZWVwKSkKfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnbmFub2Fzc2VydCcpCmNvbnN0IGZsYXQgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQpjb25zdCBxdWlja2JpdCA9IHJlcXVpcmUoJ3F1aWNrYml0LXVuaXZlcnNhbCcpCgpjb25zdCB7IElOVkFMSURfT1BFUkFUSU9OLCBJTlZBTElEX1NJR05BVFVSRSB9ID0gcmVxdWlyZSgnaHlwZXJjb3JlLWVycm9ycycpCgpjb25zdCBNdXRleCA9IHJlcXVpcmUoJy4vbXV0ZXgnKQpjb25zdCBCaXRmaWVsZCA9IHJlcXVpcmUoJy4vYml0ZmllbGQnKQpjb25zdCB7IE1lcmtsZVRyZWUsIE1lcmtsZVRyZWVCYXRjaCB9ID0gcmVxdWlyZSgnLi9tZXJrbGUtdHJlZScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFNlc3Npb25TdGF0ZSB7CiAgY29uc3RydWN0b3IoY29yZSwgcGFyZW50LCBzdG9yYWdlLCB0cmVlSW5mbywgbmFtZSkgewogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy5pbmRleCA9IHRoaXMuY29yZS5zZXNzaW9uU3RhdGVzLnB1c2godGhpcykgLSAxCgogICAgdGhpcy5zdG9yYWdlID0gc3RvcmFnZQogICAgdGhpcy5uYW1lID0gbmFtZQogICAgdGhpcy5zZXNzaW9ucyA9IFtdCgogICAgLy8gc21hbGwgaGFjayB0byBjbG9zZSBvbGQgc3RvcmFnZXMgYXMgbGF0ZSBhcyBwb3NzaWJsZS4KICAgIC8vIFRPRE86IGFkZCBhIHJlYWQgbG9jayBzbyB3ZSBjYW4gYXZvaWQgdGhhdAogICAgdGhpcy5saW5nZXJzID0gbnVsbAoKICAgIHRoaXMucGFyZW50ID0gcGFyZW50CiAgICB0aGlzLmF0b21pemVkID0gbnVsbAogICAgdGhpcy5tdXRleCA9IG5ldyBNdXRleCgpCgogICAgLy8gbWVya2xlIHN0YXRlCiAgICB0aGlzLnJvb3RzID0gdHJlZUluZm8ucm9vdHMubGVuZ3RoID8gdHJlZUluZm8ucm9vdHMgOiBbXQogICAgdGhpcy5mb3JrID0gdHJlZUluZm8uZm9yayB8fCAwCiAgICB0aGlzLmxlbmd0aCA9IE1lcmtsZVRyZWUuc3Bhbih0aGlzLnJvb3RzKSAvIDIKICAgIHRoaXMuYnl0ZUxlbmd0aCA9IE1lcmtsZVRyZWUuc2l6ZSh0aGlzLnJvb3RzKQogICAgdGhpcy5wcm9sb2d1ZSA9IHRyZWVJbmZvLnByb2xvZ3VlIHx8IG51bGwKICAgIHRoaXMuc2lnbmF0dXJlID0gdHJlZUluZm8uc2lnbmF0dXJlIHx8IG51bGwKCiAgICB0aGlzLnNuYXBzaG90Q29tcGF0TGVuZ3RoID0gdGhpcy5pc1NuYXBzaG90KCkKICAgICAgPyBNYXRoLm1pbih0aGlzLmxlbmd0aCwgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkKICAgICAgOiAtMQogICAgdGhpcy5sYXN0VHJ1bmNhdGlvbiA9IG51bGwKCiAgICB0aGlzLmFjdGl2ZSA9IDAKCiAgICB0aGlzLl9hY3RpdmVUeCA9IG51bGwKICAgIHRoaXMuX3BlbmRpbmdCaXRmaWVsZCA9IG51bGwKCiAgICB0aGlzLnJlZigpCiAgfQoKICBpc1NuYXBzaG90KCkgewogICAgcmV0dXJuIHRoaXMuc3RvcmFnZS5zbmFwc2hvdHRlZAogIH0KCiAgaXNEZWZhdWx0KCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5zdGF0ZSA9PT0gdGhpcyB8fCB0aGlzLmlzQXRvbWljRGVmYXVsdCgpCiAgfQoKICBpc0F0b21pY0RlZmF1bHQoKSB7CiAgICByZXR1cm4gISF0aGlzLnN0b3JhZ2UuYXRvbSAmJiAhIXRoaXMucGFyZW50ICYmIHRoaXMucGFyZW50LmlzRGVmYXVsdCgpCiAgfQoKICBjcmVhdGVUcmVlQmF0Y2goKSB7CiAgICByZXR1cm4gbmV3IE1lcmtsZVRyZWVCYXRjaCh0aGlzKQogIH0KCiAgYWRkU2Vzc2lvbihzKSB7CiAgICBpZiAocy5fc3RhdGVJbmRleCAhPT0gLTEpIHJldHVybgogICAgcy5fc3RhdGVJbmRleCA9IHRoaXMuc2Vzc2lvbnMucHVzaChzKSAtIDEKICAgIGlmIChzLndlYWsgPT09IGZhbHNlKSB0aGlzLmNvcmUuYWN0aXZlU2Vzc2lvbnMrKwogIH0KCiAgcmVtb3ZlU2Vzc2lvbihzKSB7CiAgICBpZiAocy5fc3RhdGVJbmRleCA9PT0gLTEpIHJldHVybgogICAgY29uc3QgaGVhZCA9IHRoaXMuc2Vzc2lvbnMucG9wKCkKICAgIGlmIChoZWFkICE9PSBzKSB0aGlzLnNlc3Npb25zWyhoZWFkLl9zdGF0ZUluZGV4ID0gcy5fc3RhdGVJbmRleCldID0gaGVhZAogICAgcy5fc3RhdGVJbmRleCA9IC0xCiAgICBpZiAocy53ZWFrID09PSBmYWxzZSkgdGhpcy5jb3JlLmFjdGl2ZVNlc3Npb25zLS0KICAgIHRoaXMuY29yZS5jaGVja0lmSWRsZSgpCiAgfQoKICBmbHVzaGVkTGVuZ3RoKCkgewogICAgaWYgKHRoaXMuaXNEZWZhdWx0KCkgfHwgdGhpcy5pc1NuYXBzaG90KCkpIHJldHVybiB0aGlzLmxlbmd0aAogICAgY29uc3QgZGVwcyA9IHRoaXMuc3RvcmFnZS5kZXBlbmRlbmNpZXMKICAgIGlmIChkZXBzLmxlbmd0aCkgcmV0dXJuIGRlcHNbZGVwcy5sZW5ndGggLSAxXS5sZW5ndGgKICAgIHJldHVybiAwCiAgfQoKICBzaWduZWRMZW5ndGgoKSB7CiAgICBjb25zdCBsID0gTWF0aC5taW4odGhpcy5mbHVzaGVkTGVuZ3RoKCksIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpCiAgICByZXR1cm4gdGhpcy5pc1NuYXBzaG90KCkgJiYgbCA+IHRoaXMuc25hcHNob3RDb21wYXRMZW5ndGggPyB0aGlzLnNuYXBzaG90Q29tcGF0TGVuZ3RoIDogbAogIH0KCiAgdW5yZWYoKSB7CiAgICBpZiAoLS10aGlzLmFjdGl2ZSA+IDApIHJldHVybgogICAgdGhpcy5jbG9zZSgpLmNhdGNoKG5vb3ApIC8vIHRlY2huaWNhbGx5IGFzeW5jLCBidXQgb25seSBmb3IgdGhlIGxhc3QgZGIgc2Vzc2lvbgogIH0KCiAgcmVmKCkgewogICAgdGhpcy5hY3RpdmUrKwogICAgcmV0dXJuIHRoaXMKICB9CgogIGhhc2goKSB7CiAgICByZXR1cm4gTWVya2xlVHJlZS5oYXNoKHRoaXMpCiAgfQoKICBzZXRSb290cyhyb290cykgewogICAgdGhpcy5yb290cyA9IHJvb3RzCiAgICB0aGlzLmxlbmd0aCA9IE1lcmtsZVRyZWUuc3Bhbihyb290cykgLyAyCiAgICB0aGlzLmJ5dGVMZW5ndGggPSBNZXJrbGVUcmVlLnNpemUocm9vdHMpCiAgfQoKICBnZXQgZW5jcnlwdGlvbkZvcmsoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLmhlYWRlci50cmVlLmZvcmsKICB9CgogIGFzeW5jIHVwZGF0ZVNuYXBzaG90U3RvcmFnZShzdG9yYWdlKSB7CiAgICBpZiAoIXRoaXMuYXRvbWl6ZWQgfHwgIXRoaXMuYXRvbWl6ZWQuZmx1c2hpbmcpIHJldHVybiB0aGlzLnRyZWVJbmZvKCkKICAgIGF3YWl0IHRoaXMuYXRvbWl6ZWQuZmx1c2hlZCgpCgogICAgbGV0IHJ4ID0gc3RvcmFnZS5yZWFkKCkKICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCiAgICBjb25zdCBhdXRoUHJvbWlzZSA9IHJ4LmdldEF1dGgoKQogICAgY29uc3QgZGVwUHJvbWlzZSA9IHJ4LmdldERlcGVuZGVuY3koKQoKICAgIHJ4LnRyeUZsdXNoKCkKICAgIGNvbnN0IFtoZWFkLCBhdXRoLCBkZXBdID0gYXdhaXQgUHJvbWlzZS5hbGwoW2hlYWRQcm9taXNlLCBhdXRoUHJvbWlzZSwgZGVwUHJvbWlzZV0pCgogICAgc3RvcmFnZS5zZXREZXBlbmRlbmN5SGVhZChkZXApCgogICAgY29uc3QgZm9yayA9IGhlYWQgPyBoZWFkLmZvcmsgOiAwCiAgICBjb25zdCBsZW5ndGggPSBoZWFkID8gaGVhZC5sZW5ndGggOiAwCgogICAgcnggPSBzdG9yYWdlLnJlYWQoKQogICAgY29uc3Qgcm9vdFByb21pc2VzID0gW10KICAgIGZvciAoY29uc3QgciBvZiBmbGF0LmZ1bGxSb290cyhsZW5ndGggKiAyKSkgewogICAgICByb290UHJvbWlzZXMucHVzaChyeC5nZXRUcmVlTm9kZShyKSkKICAgIH0KCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3Qgcm9vdHMgPSBhd2FpdCBQcm9taXNlLmFsbChyb290UHJvbWlzZXMpCgogICAgLy8gZGJsIGNoZWNrIGlmIHdlIGFyZSBoaXR0aW5nIGFuIHJlZ3Jlc3Npb24gZnJvbSBlYXJsZXIKICAgIGZvciAoY29uc3Qgcm9vdCBvZiByb290cykgewogICAgICBpZiAocm9vdCA9PT0gbnVsbCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICdCYWQgc25hcHNob3QgZnJvbSBhdG9taXplZCBzZXNzaW9uLCBpZCA9ICcgKwogICAgICAgICAgICB0aGlzLmNvcmUuaWQgKwogICAgICAgICAgICAnIGxlbmd0aCA9ICcgKwogICAgICAgICAgICBsZW5ndGggKwogICAgICAgICAgICAnIGZvcmsgPSAnICsKICAgICAgICAgICAgZm9yawogICAgICAgICkKICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGZvcmssCiAgICAgIHJvb3RzLAogICAgICBsZW5ndGgsCiAgICAgIHByb2xvZ3VlOiBhdXRoLm1hbmlmZXN0ICYmIGF1dGgubWFuaWZlc3QucHJvbG9ndWUsCiAgICAgIHNpZ25hdHVyZTogaGVhZCAmJiBoZWFkLnNpZ25hdHVyZQogICAgfQogIH0KCiAgdHJlZUluZm8oKSB7CiAgICByZXR1cm4gewogICAgICBmb3JrOiB0aGlzLmZvcmssCiAgICAgIHJvb3RzOiB0aGlzLnJvb3RzLnNsaWNlKCksCiAgICAgIGxlbmd0aDogdGhpcy5sZW5ndGgsCiAgICAgIHByb2xvZ3VlOiB0aGlzLnByb2xvZ3VlLAogICAgICBzaWduYXR1cmU6IHRoaXMuc2lnbmF0dXJlCiAgICB9CiAgfQoKICBhc3luYyBjbG9zZSgpIHsKICAgIGlmICh0aGlzLmluZGV4ID09PSAtMSkgcmV0dXJuCgogICAgdGhpcy5hY3RpdmUgPSAwCiAgICB0aGlzLm11dGV4LmRlc3Ryb3kobmV3IEVycm9yKCdDbG9zZWQnKSkuY2F0Y2gobm9vcCkKICAgIGlmICh0aGlzLnBhcmVudCAmJiB0aGlzLnBhcmVudC5hdG9taXplZCkgdGhpcy5wYXJlbnQuYXRvbWl6ZWQgPSBudWxsCgogICAgY29uc3QgY2xvc2luZyA9IHRoaXMuc3RvcmFnZS5jbG9zZSgpCgogICAgY29uc3QgaGVhZCA9IHRoaXMuY29yZS5zZXNzaW9uU3RhdGVzLnBvcCgpCiAgICBpZiAoaGVhZCAhPT0gdGhpcykgdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXNbKGhlYWQuaW5kZXggPSB0aGlzLmluZGV4KV0gPSBoZWFkCgogICAgdGhpcy5pbmRleCA9IC0xCiAgICB0aGlzLmNvcmUuY2hlY2tJZklkbGUoKQoKICAgIGlmICh0aGlzLmxpbmdlcnMgIT09IG51bGwpIHsKICAgICAgZm9yIChjb25zdCBzdG9yYWdlIG9mIHRoaXMubGluZ2VycykgYXdhaXQgc3RvcmFnZS5jbG9zZSgpCiAgICB9CgogICAgcmV0dXJuIGNsb3NpbmcKICB9CgogIGFzeW5jIHNuYXBzaG90KCkgewogICAgY29uc3Qgc3RvcmFnZSA9IHRoaXMuc3RvcmFnZS5zbmFwc2hvdCgpCiAgICBjb25zdCB0cmVlSW5mbyA9IGF3YWl0IHRoaXMudXBkYXRlU25hcHNob3RTdG9yYWdlKHN0b3JhZ2UpCgogICAgY29uc3QgcyA9IG5ldyBTZXNzaW9uU3RhdGUodGhpcy5jb3JlLCBudWxsLCBzdG9yYWdlLCB0cmVlSW5mbywgdGhpcy5uYW1lKQoKICAgIHJldHVybiBzCiAgfQoKICB1cGRhdGVEZXBlbmRlbmN5KHR4LCBsZW5ndGgpIHsKICAgIGNvbnN0IGRlcGVuZGVuY3kgPSB1cGRhdGVEZXBlbmRlbmN5KHRoaXMsIGxlbmd0aCwgZmFsc2UpCiAgICBpZiAoZGVwZW5kZW5jeSkgdHguc2V0RGVwZW5kZW5jeShkZXBlbmRlbmN5KQogICAgcmV0dXJuIGRlcGVuZGVuY3kKICB9CgogIF9jbGVhckFjdGl2ZUJhdGNoKCkgewogICAgdGhpcy5fYWN0aXZlVHggPSBudWxsCiAgfQoKICBjcmVhdGVXcml0ZUJhdGNoKCkgewogICAgYXNzZXJ0KCF0aGlzLl9hY3RpdmVUeCAmJiAhdGhpcy5zdG9yYWdlLnNuYXBzaG90dGVkKQoKICAgIHRoaXMuX2FjdGl2ZVR4ID0gdGhpcy5zdG9yYWdlLndyaXRlKCkKICAgIHJldHVybiB0aGlzLl9hY3RpdmVUeAogIH0KCiAgX3VubG9jaygpIHsKICAgIHRoaXMuX2NsZWFyQWN0aXZlQmF0Y2goKQogICAgdGhpcy5tdXRleC51bmxvY2soKQogICAgdGhpcy5jb3JlLmNoZWNrSWZJZGxlKCkKICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgY29uc3QgdHggPSB0aGlzLl9hY3RpdmVUeAogICAgdGhpcy5fYWN0aXZlVHggPSBudWxsCgogICAgdHJ5IHsKICAgICAgaWYgKCEoYXdhaXQgdHguZmx1c2goKSkpIHJldHVybiBmYWxzZQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fY2xlYXJBY3RpdmVCYXRjaCgpCiAgICB9CgogICAgdGhpcy5sYXN0VHJ1bmNhdGlvbiA9IG51bGwKICAgIHJldHVybiB0cnVlCiAgfQoKICBfcHJlY29tbWl0KCkgewogICAgdGhpcy5jb21taXRpbmcgPSB0cnVlCiAgfQoKICBhc3luYyBfY29tbWl0KCkgewogICAgYXdhaXQgdGhpcy5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBjb25zdCBiaXRmaWVsZCA9IHRoaXMuX3BlbmRpbmdCaXRmaWVsZAogICAgICB0aGlzLl9wZW5kaW5nQml0ZmllbGQgPSBudWxsCiAgICAgIHRoaXMubGFzdFRydW5jYXRpb24gPSBudWxsCiAgICAgIGF3YWl0IHRoaXMucGFyZW50Ll9vbmNvbW1pdCh0aGlzLCBiaXRmaWVsZCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuY29tbWl0aW5nID0gZmFsc2UKICAgICAgdGhpcy5tdXRleC51bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgX29uY29tbWl0KHNyYywgYml0ZmllbGQpIHsKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgY29uc3QgY3Vyckxlbmd0aCA9IHRoaXMubGVuZ3RoCgogICAgICAvLyBsb2FkIGRlcGVuZGVuY3kgaW50byBtZW1vcnkKICAgICAgY29uc3QgcnggPSB0aGlzLnN0b3JhZ2UucmVhZCgpCiAgICAgIGNvbnN0IGRlcGVuZGVuY3lQcm9taXNlID0gcnguZ2V0RGVwZW5kZW5jeSgpCgogICAgICByeC50cnlGbHVzaCgpCgogICAgICBjb25zdCBkZXBlbmRlbmN5ID0gYXdhaXQgZGVwZW5kZW5jeVByb21pc2UKCiAgICAgIHRoaXMuZm9yayA9IHNyYy5mb3JrCiAgICAgIHRoaXMubGVuZ3RoID0gc3JjLmxlbmd0aAogICAgICB0aGlzLmJ5dGVMZW5ndGggPSBzcmMuYnl0ZUxlbmd0aAogICAgICB0aGlzLnJvb3RzID0gc3JjLnJvb3RzLnNsaWNlKCkKICAgICAgdGhpcy5zaWduYXR1cmUgPSBzcmMuc2lnbmF0dXJlCgogICAgICBjb25zdCB0cmVlID0gewogICAgICAgIGZvcms6IHRoaXMuZm9yaywKICAgICAgICBsZW5ndGg6IHRoaXMubGVuZ3RoLAogICAgICAgIHJvb3RIYXNoOiB0aGlzLmhhc2goKSwKICAgICAgICBzaWduYXR1cmU6IHRoaXMuc2lnbmF0dXJlCiAgICAgIH0KCiAgICAgIGlmIChkZXBlbmRlbmN5KSB0aGlzLnN0b3JhZ2Uuc2V0RGVwZW5kZW5jeUhlYWQoZGVwZW5kZW5jeSkKCiAgICAgIGNvbnN0IGIgPSBiaXRmaWVsZAoKICAgICAgaWYgKGIgJiYgYi50cnVuY2F0ZWQgJiYgYi5zdGFydCA8IGN1cnJMZW5ndGgpIHsKICAgICAgICB0aGlzLm9udHJ1bmNhdGUodHJlZSwgYi5zdGFydCwgY3Vyckxlbmd0aCwgdHJ1ZSkKICAgICAgICBpZiAoIWIgfHwgYi5hcHBlbmRzID09PSAwKSByZXR1cm4KICAgICAgfQoKICAgICAgY29uc3QgYXBwZW5kID0gYiA/IHsgc3RhcnQ6IGIuc3RhcnQsIGxlbmd0aDogYi5hcHBlbmRzLCBkcm9wOiBmYWxzZSB9IDogbnVsbAoKICAgICAgdGhpcy5vbmFwcGVuZCh0cmVlLCBhcHBlbmQsIHRydWUpCgogICAgICBpZiAodGhpcy5jb3JlLmhpbnRzQ2hhbmdlZCAmJiB0aGlzLmlzRGVmYXVsdCgpKSBhd2FpdCB0aGlzLmNvcmUuZmx1c2hIaW50cygpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLm11dGV4LnVubG9jaygpCiAgICAgIHRoaXMuY29yZS5jaGVja0lmSWRsZSgpCiAgICB9CiAgfQoKICBhc3luYyBzZXRVc2VyRGF0YShrZXksIHZhbHVlKSB7CiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHR4ID0gdGhpcy5jcmVhdGVXcml0ZUJhdGNoKCkKICAgICAgdHgucHV0VXNlckRhdGEoa2V5LCB2YWx1ZSkKCiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmZsdXNoKCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX3VubG9jaygpCiAgICB9CiAgfQoKICBhc3luYyBfdmVyaWZ5QmxvY2soYmF0Y2gsIGJpdGZpZWxkLCB2YWx1ZSwgbWFuaWZlc3QsIGZyb20pIHsKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgaWYgKGJhdGNoLnVwZ3JhZGVkICYmIGJhdGNoLmxlbmd0aCA8PSB0aGlzLmxlbmd0aCkgewogICAgICAgIGF3YWl0IGJhdGNoLmRvd25ncmFkZSgpCiAgICAgIH0KCiAgICAgIGlmICghYmF0Y2guY29tbWl0YWJsZSgpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmNvcmUucHJldXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgYXdhaXQgdGhpcy5jb3JlLnByZXVwZGF0ZShiYXRjaCwgdGhpcy5jb3JlLmhlYWRlci5rZXkpCiAgICAgIH0KCiAgICAgIGNvbnN0IHR4ID0gdGhpcy5jcmVhdGVXcml0ZUJhdGNoKCkKICAgICAgdGhpcy51cGRhdGluZyA9IHRydWUKCiAgICAgIGlmIChiaXRmaWVsZCkgewogICAgICAgIHR4LnB1dEJsb2NrKGJpdGZpZWxkLnN0YXJ0LCB2YWx1ZSkKICAgICAgfQoKICAgICAgaWYgKGJpdGZpZWxkICYmIHRoaXMuaXNEZWZhdWx0KCkpIHsKICAgICAgICBhd2FpdCBzdG9yZUJpdGZpZWxkUmFuZ2UodGhpcy5zdG9yYWdlLCB0eCwgYml0ZmllbGQuc3RhcnQsIGJpdGZpZWxkLnN0YXJ0ICsgMSwgdHJ1ZSkKICAgICAgfQoKICAgICAgaWYgKG1hbmlmZXN0KSB0aGlzLmNvcmUuX3NldE1hbmlmZXN0KHR4LCBtYW5pZmVzdCwgbnVsbCkKCiAgICAgIGFzc2VydChiYXRjaC5jb21taXRhYmxlKCksICdTaG91bGQgc3RpbGwgYmUgY29tbWl0YWJsZScpCiAgICAgIGJhdGNoLmNvbW1pdCh0eCkKCiAgICAgIGNvbnN0IGhlYWQgPSB7CiAgICAgICAgZm9yazogYmF0Y2guZm9yaywKICAgICAgICBsZW5ndGg6IGJhdGNoLmxlbmd0aCwKICAgICAgICByb290SGFzaDogYmF0Y2guaGFzaCgpLAogICAgICAgIHNpZ25hdHVyZTogYmF0Y2guc2lnbmF0dXJlCiAgICAgIH0KCiAgICAgIGlmIChiYXRjaC51cGdyYWRlZCkgdHguc2V0SGVhZChoZWFkKQoKICAgICAgY29uc3QgZmx1c2hlZCA9IGF3YWl0IHRoaXMuZmx1c2goKQoKICAgICAgaWYgKGJhdGNoLnVwZ3JhZGVkKSB7CiAgICAgICAgdGhpcy5yb290cyA9IGJhdGNoLnJvb3RzCiAgICAgICAgdGhpcy5sZW5ndGggPSBiYXRjaC5sZW5ndGgKICAgICAgICB0aGlzLmJ5dGVMZW5ndGggPSBiYXRjaC5ieXRlTGVuZ3RoCiAgICAgICAgdGhpcy5mb3JrID0gYmF0Y2guZm9yawogICAgICAgIHRoaXMuc2lnbmF0dXJlID0gYmF0Y2guc2lnbmF0dXJlCgogICAgICAgIHRoaXMub25hcHBlbmQoaGVhZCwgYml0ZmllbGQsIGZsdXNoZWQpCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmNvcmUuaGludHNDaGFuZ2VkICYmIHRoaXMuaXNEZWZhdWx0KCkpIGF3YWl0IHRoaXMuY29yZS5mbHVzaEhpbnRzKCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX2NsZWFyQWN0aXZlQmF0Y2goKQogICAgICB0aGlzLnVwZGF0aW5nID0gZmFsc2UKICAgICAgdGhpcy5tdXRleC51bmxvY2soKQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyB0cnVuY2F0ZShsZW5ndGgsIGZvcmssIHsgc2lnbmF0dXJlLCBrZXlQYWlyIH0gPSB7fSkgewogICAgaWYgKCFrZXlQYWlyICYmIHRoaXMuaXNEZWZhdWx0KCkpIGtleVBhaXIgPSB0aGlzLmNvcmUuaGVhZGVyLmtleVBhaXIKCiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGlmICh0aGlzLnByb2xvZ3VlICYmIGxlbmd0aCA8IHRoaXMucHJvbG9ndWUubGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ1RydW5jYXRpb24gYnJlYWtzIHByb2xvZ3VlJywgdGhpcy5jb3JlLmRpc2NvdmVyeUtleSkKICAgICAgfQogICAgICBpZiAobGVuZ3RoID4gdGhpcy5sZW5ndGgpIHsKICAgICAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTigKICAgICAgICAgICdOb3QgYSB0cnVuY2F0aW9uLCAnICsgbGVuZ3RoICsgJyBtdXN0IGJlIGxlc3Mgb3IgZXF1YWwgdG8gJyArIHRoaXMubGVuZ3RoLAogICAgICAgICAgdGhpcy5jb3JlLmRpc2NvdmVyeUtleQogICAgICAgICkKICAgICAgfQoKICAgICAgY29uc3QgYmF0Y2ggPSB0aGlzLmNyZWF0ZVRyZWVCYXRjaCgpCiAgICAgIGF3YWl0IE1lcmtsZVRyZWUudHJ1bmNhdGUodGhpcywgbGVuZ3RoLCBiYXRjaCwgZm9yaykKCiAgICAgIGlmICghc2lnbmF0dXJlICYmIGtleVBhaXIgJiYgbGVuZ3RoID4gMCkgc2lnbmF0dXJlID0gdGhpcy5jb3JlLnZlcmlmaWVyLnNpZ24oYmF0Y2gsIGtleVBhaXIpCiAgICAgIGlmIChzaWduYXR1cmUpIGJhdGNoLnNpZ25hdHVyZSA9IHNpZ25hdHVyZQoKICAgICAgY29uc3QgdHggPSB0aGlzLmNyZWF0ZVdyaXRlQmF0Y2goKQoKICAgICAgLy8gdXBzZXJ0IGNvbXBhdCBtYW5pZmVzdAogICAgICBpZiAodGhpcy5jb3JlLnZlcmlmaWVyID09PSBudWxsICYmIGtleVBhaXIpIHRoaXMuY29yZS5fc2V0TWFuaWZlc3QodHgsIG51bGwsIGtleVBhaXIpCgogICAgICBjb25zdCB7IGRlcGVuZGVuY3ksIHRyZWUsIHJvb3RzIH0gPSBhd2FpdCB0aGlzLl90cnVuY2F0ZSh0eCwgYmF0Y2gpCgogICAgICBmb3IgKGNvbnN0IHNlc3Npb25TdGF0ZSBvZiB0aGlzLmNvcmUuc2Vzc2lvblN0YXRlcykgewogICAgICAgIGlmICgKICAgICAgICAgIHNlc3Npb25TdGF0ZS5pc1NuYXBzaG90KCkgJiYKICAgICAgICAgIHNlc3Npb25TdGF0ZS5uYW1lID09PSB0aGlzLm5hbWUgJiYKICAgICAgICAgIGxlbmd0aCA8IHNlc3Npb25TdGF0ZS5zbmFwc2hvdENvbXBhdExlbmd0aAogICAgICAgICkgewogICAgICAgICAgc2Vzc2lvblN0YXRlLnNuYXBzaG90Q29tcGF0TGVuZ3RoID0gbGVuZ3RoCiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCBmbHVzaGVkID0gYXdhaXQgdGhpcy5mbHVzaCgpCgogICAgICB0aGlzLmZvcmsgPSB0cmVlLmZvcmsKICAgICAgdGhpcy5sZW5ndGggPSB0cmVlLmxlbmd0aAogICAgICB0aGlzLmJ5dGVMZW5ndGggPSBNZXJrbGVUcmVlLnNpemUocm9vdHMpCiAgICAgIHRoaXMucm9vdHMgPSByb290cwogICAgICB0aGlzLnNpZ25hdHVyZSA9IHRyZWUuc2lnbmF0dXJlCgogICAgICBpZiAoZGVwZW5kZW5jeSkgdGhpcy5zdG9yYWdlLnNldERlcGVuZGVuY3lIZWFkKGRlcGVuZGVuY3kpCgogICAgICB0aGlzLm9udHJ1bmNhdGUodHJlZSwgdHJlZS5sZW5ndGgsIGJhdGNoLnRyZWVMZW5ndGgsIGZsdXNoZWQpCgogICAgICBpZiAodGhpcy5jb3JlLmhpbnRzQ2hhbmdlZCAmJiB0aGlzLmlzRGVmYXVsdCgpKSBhd2FpdCB0aGlzLmNvcmUuZmx1c2hIaW50cygpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl91bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgcmVvcmcoYmF0Y2gpIHsKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgY29uc3Qgc3RvcmFnZSA9IHRoaXMuY3JlYXRlV3JpdGVCYXRjaCgpCgogICAgdHJ5IHsKICAgICAgaWYgKCFiYXRjaC5jb21taXRhYmxlKCkpIHJldHVybiBmYWxzZQoKICAgICAgY29uc3QgeyBkZXBlbmRlbmN5LCB0cmVlIH0gPSBhd2FpdCB0aGlzLl90cnVuY2F0ZShzdG9yYWdlLCBiYXRjaCkKCiAgICAgIGNvbnN0IGZsdXNoZWQgPSBhd2FpdCB0aGlzLmZsdXNoKCkKCiAgICAgIHRoaXMuZm9yayA9IGJhdGNoLmZvcmsKICAgICAgdGhpcy5sZW5ndGggPSBiYXRjaC5sZW5ndGgKICAgICAgdGhpcy5ieXRlTGVuZ3RoID0gYmF0Y2guYnl0ZUxlbmd0aAogICAgICB0aGlzLnJvb3RzID0gYmF0Y2gucm9vdHMKICAgICAgdGhpcy5zaWduYXR1cmUgPSBiYXRjaC5zaWduYXR1cmUKCiAgICAgIGlmIChkZXBlbmRlbmN5KSB0aGlzLnN0b3JhZ2Uuc2V0RGVwZW5kZW5jeUhlYWQoZGVwZW5kZW5jeSkKCiAgICAgIHRoaXMub250cnVuY2F0ZSh0cmVlLCBiYXRjaC5hbmNlc3RvcnMsIGJhdGNoLnRyZWVMZW5ndGgsIGZsdXNoZWQpCgogICAgICBpZiAodGhpcy5jb3JlLmhpbnRzQ2hhbmdlZCAmJiB0aGlzLmlzRGVmYXVsdCgpKSBhd2FpdCB0aGlzLmNvcmUuZmx1c2hIaW50cygpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl91bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgX3RydW5jYXRlKHN0b3JhZ2UsIGJhdGNoKSB7CiAgICBzdG9yYWdlLmRlbGV0ZUJsb2NrUmFuZ2UoYmF0Y2guYW5jZXN0b3JzLCBiYXRjaC50cmVlTGVuZ3RoKQoKICAgIGFzc2VydChiYXRjaC5jb21taXRhYmxlKCksICdCYXRjaCBtdXN0IGJlIGNvbW1pdGFibGUnKQoKICAgIGNvbnN0IHRyZWUgPSB7CiAgICAgIGZvcms6IGJhdGNoLmZvcmssCiAgICAgIGxlbmd0aDogYmF0Y2gubGVuZ3RoLAogICAgICByb290SGFzaDogYmF0Y2guaGFzaCgpLAogICAgICBzaWduYXR1cmU6IGJhdGNoLnNpZ25hdHVyZQogICAgfQoKICAgIHN0b3JhZ2Uuc2V0SGVhZCh0cmVlKQogICAgYmF0Y2guY29tbWl0KHN0b3JhZ2UpCgogICAgY29uc3QgdHJ1bmNhdGVkID0gYmF0Y2gubGVuZ3RoIDwgdGhpcy5mbHVzaGVkTGVuZ3RoKCkKICAgIGNvbnN0IGRlcGVuZGVuY3kgPSB0cnVuY2F0ZWQgPyB1cGRhdGVEZXBlbmRlbmN5KHRoaXMsIGJhdGNoLmxlbmd0aCwgdHJ1ZSkgOiBudWxsCgogICAgaWYgKGRlcGVuZGVuY3kpIHN0b3JhZ2Uuc2V0RGVwZW5kZW5jeShkZXBlbmRlbmN5KQoKICAgIGlmICh0aGlzLmlzRGVmYXVsdCgpKSB7CiAgICAgIGF3YWl0IHN0b3JlQml0ZmllbGRSYW5nZSh0aGlzLnN0b3JhZ2UsIHN0b3JhZ2UsIGJhdGNoLmFuY2VzdG9ycywgYmF0Y2gudHJlZUxlbmd0aCwgZmFsc2UpCiAgICAgIGlmIChiYXRjaC5hbmNlc3RvcnMgPCB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgpIHsKICAgICAgICB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGggPSBNYXRoLm1pbigKICAgICAgICAgIGJhdGNoLmxlbmd0aCwKICAgICAgICAgIHRoaXMuY29yZS5oZWFkZXIuaGludHMucmVtb3RlQ29udGlndW91c0xlbmd0aAogICAgICAgICkKICAgICAgICBzdG9yYWdlLnNldEhpbnRzKHsKICAgICAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IGJhdGNoLmFuY2VzdG9ycywKICAgICAgICAgIHJlbW90ZUNvbnRpZ3VvdXNMZW5ndGg6IHRoaXMuY29yZS5oZWFkZXIuaGludHMucmVtb3RlQ29udGlndW91c0xlbmd0aAogICAgICAgIH0pCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4geyBkZXBlbmRlbmN5LCB0cmVlLCByb290czogYmF0Y2gucm9vdHMgfQogIH0KCiAgYXN5bmMgY2xlYXIoc3RhcnQsIGVuZCwgY2xlYXJlZCkgewogICAgYXdhaXQgdGhpcy5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBjb25zdCB0eCA9IHRoaXMuY3JlYXRlV3JpdGVCYXRjaCgpCgogICAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKHN0YXJ0ICogMikKICAgICAgd2hpbGUgKCFpc1Jvb3RJbmRleChpdGUuaW5kZXgsIHRoaXMucm9vdHMpKSB7CiAgICAgICAgY29uc3QgYSA9IGl0ZS5pbmRleAogICAgICAgIGNvbnN0IGIgPSBpdGUuc2libGluZygpCiAgICAgICAgaXRlLnBhcmVudCgpCgogICAgICAgIGNvbnN0IFtsZWZ0LCByaWdodF0gPSBmbGF0LnNwYW5zKGIpCiAgICAgICAgY29uc3QgcyA9IGxlZnQgLyAyCiAgICAgICAgY29uc3QgZSA9IHJpZ2h0IC8gMiArIDEKICAgICAgICBjb25zdCBoYXMgPSBzIDw9IHN0YXJ0ICYmIGUgPD0gZW5kID8gZmFsc2UgOiB0aGlzLmNvcmUuYml0ZmllbGQuaGFzU2V0KHMsIGUgLSBzKQogICAgICAgIGlmIChoYXMpIGJyZWFrCgogICAgICAgIHR4LmRlbGV0ZVRyZWVOb2RlKGEpCiAgICAgICAgdHguZGVsZXRlVHJlZU5vZGUoYikKICAgICAgfQoKICAgICAgaWYgKHRoaXMuaXNEZWZhdWx0KCkpIHsKICAgICAgICBhd2FpdCBzdG9yZUJpdGZpZWxkUmFuZ2UodGhpcy5zdG9yYWdlLCB0eCwgc3RhcnQsIGVuZCwgZmFsc2UpCiAgICAgICAgaWYgKHN0YXJ0IDwgdGhpcy5jb3JlLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoKSB7CiAgICAgICAgICB0eC5zZXRIaW50cyh7CiAgICAgICAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IHN0YXJ0LAogICAgICAgICAgICByZW1vdGVDb250aWd1b3VzTGVuZ3RoOiB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgKICAgICAgICAgIH0pCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoZW5kIC0gc3RhcnQgPT09IDEpIHR4LmRlbGV0ZUJsb2NrKHN0YXJ0KQogICAgICBlbHNlIHR4LmRlbGV0ZUJsb2NrUmFuZ2Uoc3RhcnQsIGVuZCkKCiAgICAgIGNvbnN0IGRlcGVuZGVuY3kgPSBzdGFydCA8IHRoaXMuZmx1c2hlZExlbmd0aCgpID8gdXBkYXRlRGVwZW5kZW5jeSh0aGlzLCBzdGFydCwgdHJ1ZSkgOiBudWxsCgogICAgICBjb25zdCBmbHVzaGVkID0gYXdhaXQgdGhpcy5mbHVzaCgpCgogICAgICBpZiAoZGVwZW5kZW5jeSkgdGhpcy5zdG9yYWdlLnNldERlcGVuZGVuY3lIZWFkKGRlcGVuZGVuY3kpCgogICAgICAvLyB0b2RvOiBhdG9taWMgZXZlbnQgaGFuZGxlCiAgICAgIGlmICh0aGlzLmlzRGVmYXVsdCgpICYmIGZsdXNoZWQpIHsKICAgICAgICBjb25zdCBsZW5ndGggPSBlbmQgLSBzdGFydAoKICAgICAgICB0aGlzLmNvcmUudXBkYXRlQ29udGlndW91c0xlbmd0aCh7IHN0YXJ0LCBsZW5ndGgsIGRyb3A6IHRydWUgfSkKICAgICAgICB0aGlzLmNvcmUuX3NldEJpdGZpZWxkUmFuZ2VzKHN0YXJ0LCBlbmQsIGZhbHNlKQogICAgICAgIHRoaXMuY29yZS5yZXBsaWNhdG9yLm9uaGF2ZShzdGFydCwgbGVuZ3RoLCB0cnVlKQoKICAgICAgICBpZiAodGhpcy5jb3JlLmhpbnRzQ2hhbmdlZCkgYXdhaXQgdGhpcy5jb3JlLmZsdXNoSGludHMoKQogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl91bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgYXBwZW5kKHZhbHVlcywgeyBzaWduYXR1cmUsIGtleVBhaXIsIHByZWFwcGVuZCwgcG9zdGFwcGVuZCwgbWF4TGVuZ3RoID0gLTEgfSA9IHt9KSB7CiAgICBpZiAoIWtleVBhaXIgJiYgdGhpcy5pc0RlZmF1bHQoKSkga2V5UGFpciA9IHRoaXMuY29yZS5oZWFkZXIua2V5UGFpcgoKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgaWYgKG1heExlbmd0aCA+PSAwICYmIHRoaXMubGVuZ3RoICsgdmFsdWVzLmxlbmd0aCA+IG1heExlbmd0aCkgewogICAgICAgIHJldHVybiB7IGxlbmd0aDogdGhpcy5sZW5ndGgsIGJ5dGVMZW5ndGg6IHRoaXMuYnl0ZUxlbmd0aCB9CiAgICAgIH0KCiAgICAgIGNvbnN0IHR4ID0gdGhpcy5jcmVhdGVXcml0ZUJhdGNoKCkKCiAgICAgIC8vIHVwc2VydCBjb21wYXQgbWFuaWZlc3QKICAgICAgaWYgKHRoaXMuY29yZS52ZXJpZmllciA9PT0gbnVsbCAmJiBrZXlQYWlyKSB0aGlzLmNvcmUuX3NldE1hbmlmZXN0KHR4LCBudWxsLCBrZXlQYWlyKQoKICAgICAgaWYgKHByZWFwcGVuZCkgYXdhaXQgcHJlYXBwZW5kKHZhbHVlcykKCiAgICAgIGlmICghdmFsdWVzLmxlbmd0aCkgewogICAgICAgIGF3YWl0IHRoaXMuZmx1c2goKQogICAgICAgIHJldHVybiB7IGxlbmd0aDogdGhpcy5sZW5ndGgsIGJ5dGVMZW5ndGg6IHRoaXMuYnl0ZUxlbmd0aCB9CiAgICAgIH0KCiAgICAgIGNvbnN0IGJhdGNoID0gdGhpcy5jcmVhdGVUcmVlQmF0Y2goKQogICAgICBmb3IgKGNvbnN0IHZhbCBvZiB2YWx1ZXMpIGJhdGNoLmFwcGVuZCh2YWwpCgogICAgICAvLyBvbmx5IG11bHRpc2lnIGNhbiBoYXZlIHByb2xvZ3VlIHNvIHNpZ25hdHVyZSBpcyBhbHdheXMgcHJlc2VudAogICAgICBpZiAodGhpcy5wcm9sb2d1ZSAmJiBiYXRjaC5sZW5ndGggPCB0aGlzLnByb2xvZ3VlLmxlbmd0aCkgewogICAgICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdBcHBlbmQgaXMgbm90IGNvbnNpc3RlbnQgd2l0aCBwcm9sb2d1ZScsIHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkpCiAgICAgIH0KCiAgICAgIGlmICghc2lnbmF0dXJlICYmIGtleVBhaXIpIHNpZ25hdHVyZSA9IHRoaXMuY29yZS52ZXJpZmllci5zaWduKGJhdGNoLCBrZXlQYWlyKQogICAgICBpZiAoc2lnbmF0dXJlKSBiYXRjaC5zaWduYXR1cmUgPSBzaWduYXR1cmUKCiAgICAgIGJhdGNoLmNvbW1pdCh0eCkKCiAgICAgIGNvbnN0IHRyZWUgPSB7CiAgICAgICAgZm9yazogYmF0Y2guZm9yaywKICAgICAgICBsZW5ndGg6IGJhdGNoLmxlbmd0aCwKICAgICAgICByb290SGFzaDogYmF0Y2guaGFzaCgpLAogICAgICAgIHNpZ25hdHVyZTogYmF0Y2guc2lnbmF0dXJlCiAgICAgIH0KCiAgICAgIHR4LnNldEhlYWQodHJlZSkKCiAgICAgIGlmICh0aGlzLmlzRGVmYXVsdCgpKSB7CiAgICAgICAgYXdhaXQgc3RvcmVCaXRmaWVsZFJhbmdlKHRoaXMuc3RvcmFnZSwgdHgsIGJhdGNoLmFuY2VzdG9ycywgYmF0Y2gubGVuZ3RoLCB0cnVlKQogICAgICAgIGlmICh0aGlzLmxlbmd0aCA9PT0gdGhpcy5jb3JlLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoKSB7CiAgICAgICAgICB0eC5zZXRIaW50cyh7CiAgICAgICAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IHRoaXMubGVuZ3RoICsgdmFsdWVzLmxlbmd0aCwKICAgICAgICAgICAgcmVtb3RlQ29udGlndW91c0xlbmd0aDogdGhpcy5jb3JlLmhlYWRlci5oaW50cy5yZW1vdGVDb250aWd1b3VzTGVuZ3RoCiAgICAgICAgICB9KQogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0eC5wdXRCbG9jayh0aGlzLmxlbmd0aCArIGksIHZhbHVlc1tpXSkKICAgICAgfQoKICAgICAgY29uc3QgYml0ZmllbGQgPSB7CiAgICAgICAgZHJvcDogZmFsc2UsCiAgICAgICAgc3RhcnQ6IGJhdGNoLmFuY2VzdG9ycywKICAgICAgICBsZW5ndGg6IHZhbHVlcy5sZW5ndGgKICAgICAgfQoKICAgICAgY29uc3QgZmx1c2hlZCA9IGF3YWl0IHRoaXMuZmx1c2goKQoKICAgICAgdGhpcy5mb3JrID0gYmF0Y2guZm9yawogICAgICB0aGlzLnJvb3RzID0gYmF0Y2gucm9vdHMKICAgICAgdGhpcy5sZW5ndGggPSBiYXRjaC5sZW5ndGgKICAgICAgdGhpcy5ieXRlTGVuZ3RoID0gYmF0Y2guYnl0ZUxlbmd0aAogICAgICB0aGlzLnNpZ25hdHVyZSA9IGJhdGNoLnNpZ25hdHVyZQoKICAgICAgaWYgKHBvc3RhcHBlbmQpIGF3YWl0IHBvc3RhcHBlbmQodmFsdWVzKQoKICAgICAgdGhpcy5vbmFwcGVuZCh0cmVlLCBiaXRmaWVsZCwgZmx1c2hlZCkKCiAgICAgIGlmICh0aGlzLmNvcmUuaGludHNDaGFuZ2VkICYmIHRoaXMuaXNEZWZhdWx0KCkpIGF3YWl0IHRoaXMuY29yZS5mbHVzaEhpbnRzKCkKCiAgICAgIHJldHVybiB7IGxlbmd0aDogdGhpcy5sZW5ndGgsIGJ5dGVMZW5ndGg6IHRoaXMuYnl0ZUxlbmd0aCB9CiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl91bmxvY2soKQogICAgfQogIH0KCiAgb25hcHBlbmQodHJlZSwgYml0ZmllbGQsIGZsdXNoZWQpIHsKICAgIGlmICghZmx1c2hlZCkgdGhpcy5fdXBkYXRlQml0ZmllbGQoYml0ZmllbGQpCiAgICBlbHNlIGlmICh0aGlzLmlzRGVmYXVsdCgpKSB0aGlzLmNvcmUub25hcHBlbmQodHJlZSwgYml0ZmllbGQpCgogICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgdGhpcy5zZXNzaW9uc1tpXS5lbWl0KCdhcHBlbmQnKQogICAgfQogIH0KCiAgb250cnVuY2F0ZSh0cmVlLCB0bywgZnJvbSwgZmx1c2hlZCkgewogICAgY29uc3QgYml0ZmllbGQgPSB7IHN0YXJ0OiB0bywgbGVuZ3RoOiBmcm9tIC0gdG8sIGRyb3A6IHRydWUgfQoKICAgIHRoaXMubGFzdFRydW5jYXRpb24gPSB7IGZyb20sIHRvIH0KCiAgICBpZiAoIWZsdXNoZWQpIHRoaXMuX3VwZGF0ZUJpdGZpZWxkKGJpdGZpZWxkKQogICAgZWxzZSBpZiAodGhpcy5pc0RlZmF1bHQoKSkgdGhpcy5jb3JlLm9udHJ1bmNhdGUodHJlZSwgYml0ZmllbGQpCgogICAgZm9yIChjb25zdCBzZXNzaW9uU3RhdGUgb2YgdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXMpIHsKICAgICAgaWYgKAogICAgICAgIHNlc3Npb25TdGF0ZS5pc1NuYXBzaG90KCkgJiYKICAgICAgICBzZXNzaW9uU3RhdGUubmFtZSA9PT0gdGhpcy5uYW1lICYmCiAgICAgICAgdG8gPCBzZXNzaW9uU3RhdGUuc25hcHNob3RDb21wYXRMZW5ndGgKICAgICAgKSB7CiAgICAgICAgc2Vzc2lvblN0YXRlLnNuYXBzaG90Q29tcGF0TGVuZ3RoID0gdG8KICAgICAgfQogICAgfQoKICAgIGZvciAobGV0IGkgPSB0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIHRoaXMuc2Vzc2lvbnNbaV0uZW1pdCgndHJ1bmNhdGUnLCB0bywgdHJlZS5mb3JrKQogICAgfQogIH0KCiAgX3VwZGF0ZUJpdGZpZWxkKGJpdGZpZWxkLCBmbHVzaGVkKSB7CiAgICBpZiAoIWJpdGZpZWxkKSByZXR1cm4KCiAgICBjb25zdCBwID0gdGhpcy5fcGVuZGluZ0JpdGZpZWxkCiAgICBjb25zdCBiID0gYml0ZmllbGQKCiAgICBpZiAoYi5kcm9wKSB7CiAgICAgIC8vIHRydW5jYXRpb24gbXVzdCBiZSBmcm9tIGVuZAogICAgICBpZiAocCAmJiBiLnN0YXJ0ICsgYi5sZW5ndGggIT09IHAuc3RhcnQgKyBwLmFwcGVuZHMpIHsKICAgICAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTignQXRvbWljIHRydW5jYXRpb25zIG11c3QgYmUgY29udGlndW91cycsIHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkpCiAgICAgIH0KCiAgICAgIC8vIGFjdHVhbCB0cnVuY2F0aW9uCiAgICAgIGlmIChwID09PSBudWxsIHx8IGIuc3RhcnQgPCBwLnN0YXJ0KSB7CiAgICAgICAgdGhpcy5fcGVuZGluZ0JpdGZpZWxkID0geyB0cnVuY2F0ZWQ6IHRydWUsIHN0YXJ0OiBiLnN0YXJ0LCBhcHBlbmRzOiAwIH0KICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgLy8ganVzdCBjbGVhcmluZyBiYXRjaCBkYXRhCiAgICAgIHAuYXBwZW5kcyA9IGIuc3RhcnQgLSBwLnN0YXJ0CgogICAgICAvLyB3ZSBjbGVhcmVkIHRoZSBjdXJyZW50IGJhdGNoCiAgICAgIGlmIChwLmFwcGVuZHMgPT09IDApIHRoaXMuX3BlbmRpbmdCaXRmaWVsZCA9IG51bGwKCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChwID09PSBudWxsKSB7CiAgICAgIHRoaXMuX3BlbmRpbmdCaXRmaWVsZCA9IHsgdHJ1bmNhdGVkOiBmYWxzZSwgc3RhcnQ6IGIuc3RhcnQsIGFwcGVuZHM6IGIubGVuZ3RoIH0KICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKGIuc3RhcnQgIT09IHAuc3RhcnQgKyBwLmFwcGVuZHMpIHsKICAgICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0F0b21pYyBvcGVyYXRpb25zIG11c3QgYmUgY29udGlndW91cycsIHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgcC5hcHBlbmRzICs9IGIubGVuZ3RoCiAgfQoKICBhc3luYyBjYXRjaHVwKGxlbmd0aCkgewogICAgYXNzZXJ0KCF0aGlzLmlzRGVmYXVsdCgpLCAnQ2Fubm90IGNhdGNodXAgc2lnbmVkIHN0YXRlJykgLy8gVE9ETzogbWFrZSB0aGlzIGNoZWNrIGJldHRlcgoKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgY29uc3Qgb3JpZ0xlbmd0aCA9IHRoaXMubGVuZ3RoCgogICAgICBsZXQgc2hhcmVkTGVuZ3RoID0gMAogICAgICBmb3IgKGxldCBpID0gdGhpcy5zdG9yYWdlLmRlcGVuZGVuY2llcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGNvbnN0IGRlcCA9IHRoaXMuc3RvcmFnZS5kZXBlbmRlbmNpZXNbaV0KICAgICAgICBpZiAoZGVwLmRhdGFQb2ludGVyID09PSB0aGlzLmNvcmUuc3RhdGUuc3RvcmFnZS5jb3JlLmRhdGFQb2ludGVyKSB7CiAgICAgICAgICBzaGFyZWRMZW5ndGggPSBkZXAubGVuZ3RoCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgdHggPSB0aGlzLmNyZWF0ZVdyaXRlQmF0Y2goKQogICAgICBjb25zdCByeCA9IHRoaXMuY29yZS5zdGF0ZS5zdG9yYWdlLnJlYWQoKQogICAgICBjb25zdCByb290UHJvbWlzZXMgPSBbXQoKICAgICAgZm9yIChjb25zdCByb290IG9mIGZsYXQuZnVsbFJvb3RzKGxlbmd0aCAqIDIpKSB7CiAgICAgICAgcm9vdFByb21pc2VzLnB1c2gocnguZ2V0VHJlZU5vZGUocm9vdCkpCiAgICAgIH0KCiAgICAgIHJ4LnRyeUZsdXNoKCkKCiAgICAgIGNvbnN0IHJvb3RzID0gYXdhaXQgUHJvbWlzZS5hbGwocm9vdFByb21pc2VzKQogICAgICBjb25zdCB0cnVuY2F0aW5nID0gc2hhcmVkTGVuZ3RoIDwgb3JpZ0xlbmd0aAoKICAgICAgZm9yIChjb25zdCBub2RlIG9mIHJvb3RzKSB7CiAgICAgICAgaWYgKG5vZGUgPT09IG51bGwpIHsKICAgICAgICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKAogICAgICAgICAgICAnSW52YWxpZCBjYXRjaHVwIGxlbmd0aCwgdHJlZSBub2RlcyBub3QgYXZhaWxhYmxlJywKICAgICAgICAgICAgdGhpcy5jb3JlLmRpc2NvdmVyeUtleQogICAgICAgICAgKQogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgZm9yayA9IHRydW5jYXRpbmcgPyB0aGlzLmZvcmsgKyAxIDogdGhpcy5mb3JrCgogICAgICAvLyBvdmVyd3JpdGUgaXQgYXRtLCBUT0RPOiBrZWVwIHdoYXQgd2UgY2FuIGNvbm5lY3QgdG8gdGhlIHRyZWUKICAgICAgdHguZGVsZXRlQmxvY2tSYW5nZSgwLCAtMSkKICAgICAgdHguZGVsZXRlVHJlZU5vZGVSYW5nZSgwLCAtMSkKICAgICAgdHguZGVsZXRlQml0ZmllbGRQYWdlUmFuZ2UoMCwgLTEpCgogICAgICBjb25zdCB0cmVlID0gewogICAgICAgIGZvcmssCiAgICAgICAgbGVuZ3RoLAogICAgICAgIHJvb3RIYXNoOiBjcnlwdG8udHJlZShyb290cyksCiAgICAgICAgc2lnbmF0dXJlOiBudWxsCiAgICAgIH0KCiAgICAgIHR4LnNldEhlYWQodHJlZSkKCiAgICAgIC8vIHByb3AgYSBiZXR0ZXIgd2F5IHRvIGRvIHRoaXMKICAgICAgY29uc3QgZGVwID0gdXBkYXRlRGVwZW5kZW5jeSh0aGlzLCBzaGFyZWRMZW5ndGgsIHRydWUpCiAgICAgIGRlcC5sZW5ndGggPSBsZW5ndGgKCiAgICAgIHR4LnNldERlcGVuZGVuY3koZGVwKQoKICAgICAgY29uc3QgZmx1c2hlZCA9IGF3YWl0IHRoaXMuZmx1c2goKQoKICAgICAgdGhpcy5zdG9yYWdlLnNldERlcGVuZGVuY3lIZWFkKGRlcCkKCiAgICAgIHRoaXMuZm9yayA9IHRyZWUuZm9yawogICAgICB0aGlzLnJvb3RzID0gcm9vdHMKICAgICAgdGhpcy5sZW5ndGggPSB0cmVlLmxlbmd0aAogICAgICB0aGlzLmJ5dGVMZW5ndGggPSBNZXJrbGVUcmVlLnNpemUocm9vdHMpCgogICAgICBpZiAodHJ1bmNhdGluZykgdGhpcy5vbnRydW5jYXRlKHRyZWUsIHNoYXJlZExlbmd0aCwgb3JpZ0xlbmd0aCwgZmx1c2hlZCkKICAgICAgaWYgKHNoYXJlZExlbmd0aCA8IGxlbmd0aCkgdGhpcy5vbmFwcGVuZCh0cmVlLCBudWxsLCBmbHVzaGVkKQoKICAgICAgaWYgKHRoaXMuY29yZS5oaW50c0NoYW5nZWQgJiYgdGhpcy5pc0RlZmF1bHQoKSkgYXdhaXQgdGhpcy5jb3JlLmZsdXNoSGludHMoKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5tdXRleC51bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgX292ZXJ3cml0ZShzb3VyY2UsIGZvcmssIGxlbmd0aCwgdHJlZUxlbmd0aCwgc2lnbmF0dXJlKSB7CiAgICBjb25zdCBibG9ja1Byb21pc2VzID0gW10KICAgIGNvbnN0IHRyZWVQcm9taXNlcyA9IFtdCiAgICBjb25zdCByb290UHJvbWlzZXMgPSBbXQoKICAgIGNvbnN0IHJ4ID0gc291cmNlLnN0b3JhZ2UucmVhZCgpCgogICAgZm9yIChjb25zdCByb290IG9mIGZsYXQuZnVsbFJvb3RzKGxlbmd0aCAqIDIpKSB7CiAgICAgIHJvb3RQcm9taXNlcy5wdXNoKHJ4LmdldFRyZWVOb2RlKHJvb3QpKQogICAgfQoKICAgIGZvciAoY29uc3QgaW5kZXggb2YgZmxhdC5wYXRjaCh0cmVlTGVuZ3RoICogMiwgbGVuZ3RoICogMikpIHsKICAgICAgdHJlZVByb21pc2VzLnB1c2gocnguZ2V0VHJlZU5vZGUoaW5kZXgpKQogICAgfQoKICAgIGZvciAobGV0IGkgPSB0cmVlTGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgdHJlZVByb21pc2VzLnB1c2gocnguZ2V0VHJlZU5vZGUoaSAqIDIpKQogICAgICB0cmVlUHJvbWlzZXMucHVzaChyeC5nZXRUcmVlTm9kZShpICogMiArIDEpKQogICAgICBibG9ja1Byb21pc2VzLnB1c2gocnguZ2V0QmxvY2soaSkpCiAgICB9CgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IGJsb2NrcyA9IGF3YWl0IFByb21pc2UuYWxsKGJsb2NrUHJvbWlzZXMpCiAgICBjb25zdCBub2RlcyA9IGF3YWl0IFByb21pc2UuYWxsKHRyZWVQcm9taXNlcykKICAgIGNvbnN0IHJvb3RzID0gYXdhaXQgUHJvbWlzZS5hbGwocm9vdFByb21pc2VzKQoKICAgIGlmICh0aGlzLmNvcmUuZGVzdHJveWVkKSB0aHJvdyBuZXcgRXJyb3IoJ0NvcmUgZGVzdHJveWVkJykKCiAgICBpZiAoc2lnbmF0dXJlKSB7CiAgICAgIGNvbnN0IGJhdGNoID0gdGhpcy5jcmVhdGVUcmVlQmF0Y2goKQogICAgICBiYXRjaC5yb290cyA9IHJvb3RzCiAgICAgIGJhdGNoLmxlbmd0aCA9IGxlbmd0aAoKICAgICAgaWYgKCF0aGlzLmNvcmUudmVyaWZpZXIudmVyaWZ5KGJhdGNoLCBzaWduYXR1cmUpKSB7CiAgICAgICAgdGhyb3cgSU5WQUxJRF9TSUdOQVRVUkUoCiAgICAgICAgICAnU2lnbmF0dXJlIGlzIG5vdCB2YWxpZCBvdmVyIGNvbW1pdHRlZCB0cmVlJywKICAgICAgICAgIHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkKICAgICAgICApCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCB0eCA9IHRoaXMuY3JlYXRlV3JpdGVCYXRjaCgpCgogICAgLy8gdHJ1bmNhdGUgZXhpc3RpbmcgdHJlZQogICAgaWYgKHRyZWVMZW5ndGggPCB0aGlzLmxlbmd0aCkgewogICAgICB0eC5kZWxldGVCbG9ja1JhbmdlKHRyZWVMZW5ndGgsIHRoaXMubGVuZ3RoKQogICAgfQoKICAgIGZvciAoY29uc3Qgcm9vdCBvZiByb290cykgdHgucHV0VHJlZU5vZGUocm9vdCkKCiAgICAvLyBubyBub2RlcyB3aWxsIGJlIGNvcGllZCBpbiBzaGFsbG93IG1vZGUKICAgIGZvciAoY29uc3Qgbm9kZSBvZiBub2RlcykgewogICAgICBpZiAobm9kZSAhPT0gbnVsbCkgdHgucHV0VHJlZU5vZGUobm9kZSkKICAgIH0KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJsb2Nrcy5sZW5ndGg7IGkrKykgewogICAgICBhc3NlcnQoYmxvY2tzW2ldICE9PSBudWxsLCAnaGFzIGJsb2NrJykKICAgICAgdHgucHV0QmxvY2soaSArIHRyZWVMZW5ndGgsIGJsb2Nrc1tpXSkKICAgIH0KCiAgICBjb25zdCB0b3RhbExlbmd0aCA9IE1hdGgubWF4KGxlbmd0aCwgdGhpcy5sZW5ndGgpCgogICAgaWYgKHRvdGFsTGVuZ3RoID4gdHJlZUxlbmd0aCkgewogICAgICBjb25zdCBmaXJzdFBhZ2UgPSBnZXRCaXRmaWVsZFBhZ2UodHJlZUxlbmd0aCkKICAgICAgY29uc3QgbGFzdFBhZ2UgPSBnZXRCaXRmaWVsZFBhZ2UodG90YWxMZW5ndGggLSAxKQoKICAgICAgY29uc3Qgc3J4ID0gdGhpcy5zdG9yYWdlLnJlYWQoKQogICAgICBjb25zdCBiaXRmaWVsZFBhZ2VQcm9taXNlID0gc3J4LmdldEJpdGZpZWxkUGFnZShmaXJzdFBhZ2UpCiAgICAgIHNyeC50cnlGbHVzaCgpCgogICAgICBjb25zdCBiaXRmaWVsZFBhZ2UgPSBhd2FpdCBiaXRmaWVsZFBhZ2VQcm9taXNlCgogICAgICBsZXQgaW5kZXggPSB0cmVlTGVuZ3RoCgogICAgICBmb3IgKGxldCBpID0gZmlyc3RQYWdlOyBpIDw9IGxhc3RQYWdlOyBpKyspIHsKICAgICAgICBjb25zdCBwYWdlID0gYjRhLmFsbG9jKEJpdGZpZWxkLkJZVEVTX1BFUl9QQUdFKQogICAgICAgIHR4LnB1dEJpdGZpZWxkUGFnZShpLCBwYWdlKQoKICAgICAgICAvLyBjb3B5IGV4aXN0aW5nIGJpdHMgaW4KICAgICAgICBpZiAoaSA9PT0gZmlyc3RQYWdlICYmIGJpdGZpZWxkUGFnZSkgcGFnZS5zZXQoYml0ZmllbGRQYWdlKQoKICAgICAgICBpZiAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGluZGV4ID0gZmlsbEJpdGZpZWxkUGFnZShwYWdlLCBpbmRleCwgbGVuZ3RoLCBpLCB0cnVlKQogICAgICAgICAgaWYgKGluZGV4IDwgbGVuZ3RoKSBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgaWYgKGluZGV4IDwgdGhpcy5sZW5ndGgpIHsKICAgICAgICAgIGluZGV4ID0gZmlsbEJpdGZpZWxkUGFnZShwYWdlLCBpbmRleCwgdGhpcy5sZW5ndGgsIGksIGZhbHNlKQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGNvbnN0IHRyZWUgPSB7CiAgICAgIGZvcmssCiAgICAgIGxlbmd0aCwKICAgICAgcm9vdEhhc2g6IGNyeXB0by50cmVlKHJvb3RzKSwKICAgICAgc2lnbmF0dXJlCiAgICB9CgogICAgY29uc3QgdXBncmFkZWQgPSB0cmVlTGVuZ3RoIDwgdGhpcy5sZW5ndGggfHwgdGhpcy5sZW5ndGggPCBsZW5ndGggfHwgdHJlZS5mb3JrICE9PSB0aGlzLmZvcmsKCiAgICBpZiAodXBncmFkZWQpIHR4LnNldEhlYWQodHJlZSkKCiAgICBjb25zdCBmbHVzaGVkID0gYXdhaXQgdGhpcy5mbHVzaCgpCgogICAgdGhpcy5mb3JrID0gdHJlZS5mb3JrCiAgICB0aGlzLnJvb3RzID0gcm9vdHMKICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLmJ5dGVMZW5ndGggPSBNZXJrbGVUcmVlLnNpemUocm9vdHMpCiAgICB0aGlzLnNpZ25hdHVyZSA9IHNpZ25hdHVyZQoKICAgIHJldHVybiB7IHRyZWUsIGZsdXNoZWQgfQogIH0KCiAgYXN5bmMgY29tbWl0KHN0YXRlLCB7IHNpZ25hdHVyZSwga2V5UGFpciwgbGVuZ3RoID0gc3RhdGUubGVuZ3RoLCB0cmVlTGVuZ3RoID0gLTEgfSA9IHt9KSB7CiAgICBhc3NlcnQoCiAgICAgIHRoaXMuaXNEZWZhdWx0KCkgfHwgKHRoaXMucGFyZW50ICYmIHRoaXMucGFyZW50LmlzRGVmYXVsdCgpKSwKICAgICAgJ0NhbiBvbmx5IGNvbW1pdCBpbnRvIGRlZmF1bHQgc3RhdGUnCiAgICApCgogICAgbGV0IHNyY0xvY2tlZCA9IGZhbHNlCiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHN0YXRlLm11dGV4LmxvY2soKQogICAgICBzcmNMb2NrZWQgPSB0cnVlCgogICAgICBpZiAodHJlZUxlbmd0aCA9PT0gLTEpIHRyZWVMZW5ndGggPSBzdGF0ZS5mbHVzaGVkTGVuZ3RoKCkKCiAgICAgIGlmICghKGF3YWl0IHRoaXMuY29yZS5fdmFsaWRhdGVDb21taXQoc3RhdGUsIHRyZWVMZW5ndGgpKSkgcmV0dXJuIG51bGwKICAgICAgaWYgKHRoaXMubGVuZ3RoID4gbGVuZ3RoKSByZXR1cm4gbnVsbAoKICAgICAgaWYgKHRoaXMubGVuZ3RoIDwgbGVuZ3RoICYmICFzaWduYXR1cmUpIHsKICAgICAgICBpZiAoIWtleVBhaXIpIGtleVBhaXIgPSB0aGlzLmNvcmUuaGVhZGVyLmtleVBhaXIKICAgICAgICBjb25zdCBiYXRjaCA9IHN0YXRlLmNyZWF0ZVRyZWVCYXRjaCgpCiAgICAgICAgaWYgKGxlbmd0aCAhPT0gYmF0Y2gubGVuZ3RoKSBhd2FpdCBiYXRjaC5yZXN0b3JlKGxlbmd0aCkKICAgICAgICBzaWduYXR1cmUgPSB0aGlzLmNvcmUudmVyaWZpZXIuc2lnbihiYXRjaCwga2V5UGFpcikKICAgICAgfQoKICAgICAgY29uc3QgeyB0cmVlLCBmbHVzaGVkIH0gPSBhd2FpdCB0aGlzLl9vdmVyd3JpdGUoCiAgICAgICAgc3RhdGUsCiAgICAgICAgdGhpcy5mb3JrLAogICAgICAgIGxlbmd0aCwKICAgICAgICB0cmVlTGVuZ3RoLAogICAgICAgIHNpZ25hdHVyZQogICAgICApCgogICAgICAvLyBnYyBibG9ja3MgZnJvbSBzb3VyY2UKICAgICAgaWYgKHRyZWVMZW5ndGggPCBsZW5ndGgpIHsKICAgICAgICBjb25zdCB0eCA9IHN0YXRlLmNyZWF0ZVdyaXRlQmF0Y2goKQoKICAgICAgICB0eC5kZWxldGVCbG9ja1JhbmdlKHRyZWVMZW5ndGgsIGxlbmd0aCkKICAgICAgICBjb25zdCBkZXBlbmRlbmN5ID0gc3RhdGUudXBkYXRlRGVwZW5kZW5jeSh0eCwgbGVuZ3RoKQoKICAgICAgICBhd2FpdCBzdGF0ZS5mbHVzaCh0eCkKCiAgICAgICAgaWYgKGRlcGVuZGVuY3kpIHN0YXRlLnN0b3JhZ2Uuc2V0RGVwZW5kZW5jeUhlYWQoZGVwZW5kZW5jeSkKICAgICAgfQoKICAgICAgY29uc3QgYml0ZmllbGQgPSB7IHN0YXJ0OiB0cmVlTGVuZ3RoLCBsZW5ndGg6IGxlbmd0aCAtIHRyZWVMZW5ndGgsIGRyb3A6IGZhbHNlIH0KICAgICAgdGhpcy5vbmFwcGVuZCh0cmVlLCBiaXRmaWVsZCwgZmx1c2hlZCkKCiAgICAgIHJldHVybiB7CiAgICAgICAgbGVuZ3RoOiB0aGlzLmxlbmd0aCwKICAgICAgICBieXRlTGVuZ3RoOiB0aGlzLmJ5dGVMZW5ndGgKICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy51cGRhdGluZyA9IGZhbHNlCiAgICAgIHRoaXMubXV0ZXgudW5sb2NrKCkKCiAgICAgIGlmIChzcmNMb2NrZWQpIHsKICAgICAgICBzdGF0ZS5tdXRleC51bmxvY2soKQogICAgICAgIHN0YXRlLl9jbGVhckFjdGl2ZUJhdGNoKCkKICAgICAgfQoKICAgICAgdGhpcy5jb3JlLmNoZWNrSWZJZGxlKCkKICAgIH0KICB9CgogIGFzeW5jIF9nZXRUcmVlSGVhZEF0KGxlbmd0aCkgewogICAgaWYgKGxlbmd0aCA9PT0gbnVsbCkgcmV0dXJuIHRoaXMudHJlZUluZm8oKQoKICAgIGNvbnN0IGhlYWQgPSBnZXREZWZhdWx0VHJlZSgpCgogICAgaGVhZC5sZW5ndGggPSBsZW5ndGgKCiAgICBjb25zdCByb290cyA9IGF3YWl0IE1lcmtsZVRyZWUuZ2V0Um9vdHNGcm9tU3RvcmFnZSh0aGlzLnN0b3JhZ2UsIGxlbmd0aCkKICAgIGNvbnN0IHJvb3RIYXNoID0gY3J5cHRvLnRyZWUocm9vdHMpCgogICAgaGVhZC5mb3JrID0gdGhpcy5mb3JrCiAgICBoZWFkLnJvb3RIYXNoID0gcm9vdEhhc2gKCiAgICBpZiAobGVuZ3RoID09PSB0aGlzLmxlbmd0aCkgaGVhZC5zaWduYXR1cmUgPSB0aGlzLnNpZ25hdHVyZQoKICAgIHJldHVybiBoZWFkCiAgfQoKICBfbW92ZVRvQ29yZShjb3JlLCB0cnVuY2F0ZWQsIGFwcGVuZGVkKSB7CiAgICBjb25zdCBoZWFkID0gdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXMucG9wKCkKICAgIGlmIChoZWFkICE9PSB0aGlzKSB0aGlzLmNvcmUuc2Vzc2lvblN0YXRlc1soaGVhZC5pbmRleCA9IHRoaXMuaW5kZXgpXSA9IGhlYWQKCiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICB0aGlzLmluZGV4ID0gdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXMucHVzaCh0aGlzKSAtIDEKCiAgICBmb3IgKGxldCBpID0gdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBzID0gdGhpcy5zZXNzaW9uc1tpXQogICAgICBjb25zdCBtYW5pZmVzdCA9IHMubWFuaWZlc3QKICAgICAgcy50cmFuc2ZlclNlc3Npb24odGhpcy5jb3JlKQogICAgICBpZiAoIW1hbmlmZXN0ICYmIHMubWFuaWZlc3QpIHMuZW1pdCgnbWFuaWZlc3QnKQogICAgICBpZiAodHJ1bmNhdGVkKSBzLmVtaXQoJ3RydW5jYXRlJywgdHJ1bmNhdGVkLnRvLCB0cnVuY2F0ZWQuZm9yaykKICAgICAgaWYgKGFwcGVuZGVkKSBzLmVtaXQoJ2FwcGVuZCcpCiAgICB9CiAgfQoKICBhc3luYyBtb3ZlVG8oY29yZSwgbGVuZ3RoKSB7CiAgICBjb25zdCBzdGF0ZSA9IGNvcmUuc3RhdGUKCiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIC8vIGlmIChzdGF0ZS5zdG9yYWdlICYmIChhd2FpdCBzdGF0ZS5zdG9yYWdlLnJlc3VtZVNlc3Npb24odGhpcy5uYW1lKSkgIT09IG51bGwpIHsKICAgICAgLy8gICB0aHJvdyBTVE9SQUdFX0NPTkZMSUNUKCdCYXRjaCBoYXMgYWxyZWFkeSBiZWVuIGNyZWF0ZWQnKQogICAgICAvLyB9CgogICAgICBjb25zdCB0cmVlTGVuZ3RoID0gdGhpcy5sZW5ndGgKCiAgICAgIGxldCB0cnVuY2F0ZWQgPSBudWxsCiAgICAgIGxldCBhcHBlbmRlZCA9IGZhbHNlCgogICAgICBpZiAoIXRoaXMuaXNTbmFwc2hvdCgpKSB7CiAgICAgICAgaWYgKHRoaXMubGluZ2VycyA9PT0gbnVsbCkgdGhpcy5saW5nZXJzID0gW10KICAgICAgICB0aGlzLmxpbmdlcnMucHVzaCh0aGlzLnN0b3JhZ2UpCgogICAgICAgIGNvbnN0IHJlc3VtZWQgPSBhd2FpdCBzdGF0ZS5zdG9yYWdlLnJlc3VtZVNlc3Npb24odGhpcy5uYW1lKQoKICAgICAgICBjb25zdCB0cnVuY2F0aW9uID0gbGVuZ3RoIDwgdGhpcy5sZW5ndGggPyBhd2FpdCB0cnVuY2F0ZUFuZEZsdXNoKHRoaXMsIGxlbmd0aCkgOiBudWxsCiAgICAgICAgY29uc3QgdHJlZUluZm8gPSB0cnVuY2F0aW9uCiAgICAgICAgICA/IHRydW5jYXRpb24udHJlZQogICAgICAgICAgOiByZXN1bWVkCiAgICAgICAgICAgID8gbnVsbAogICAgICAgICAgICA6IGF3YWl0IHN0YXRlLl9nZXRUcmVlSGVhZEF0KHRoaXMubGVuZ3RoKQoKICAgICAgICBjb25zdCBmb3JrID0gdHJ1bmNhdGlvbiA/IHRoaXMuZm9yayArIDEgOiB0aGlzLmZvcmsKCiAgICAgICAgLy8gdG9kbzogdmFsaWRhdGUgdHJlZUluZm8KCiAgICAgICAgbGV0IHN0b3JhZ2UgPSBudWxsCgogICAgICAgIGlmIChyZXN1bWVkKSB7CiAgICAgICAgICBzdG9yYWdlID0gcmVzdW1lZAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0cmVlSW5mby5mb3JrID0gZm9yawogICAgICAgICAgc3RvcmFnZSA9IGF3YWl0IHN0YXRlLnN0b3JhZ2UuY3JlYXRlU2Vzc2lvbih0aGlzLm5hbWUsIHRyZWVJbmZvKQogICAgICAgIH0KCiAgICAgICAgY29uc3Qgcm9vdHMgPSBhd2FpdCBNZXJrbGVUcmVlLmdldFJvb3RzRnJvbVN0b3JhZ2Uoc3RvcmFnZSwgbGVuZ3RoKQoKICAgICAgICB0aGlzLnN0b3JhZ2UgPSBzdG9yYWdlCiAgICAgICAgdGhpcy5wcm9sb2d1ZSA9IHN0YXRlLnByb2xvZ3VlCiAgICAgICAgdGhpcy5mb3JrID0gZm9yawogICAgICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoCiAgICAgICAgdGhpcy5ieXRlTGVuZ3RoID0gTWVya2xlVHJlZS5zaXplKHJvb3RzKQogICAgICAgIHRoaXMucm9vdHMgPSByb290cwoKICAgICAgICBpZiAodHJ1bmNhdGlvbikgewogICAgICAgICAgY29uc3QgeyBkZXBlbmRlbmN5IH0gPSB0cnVuY2F0aW9uCgogICAgICAgICAgaWYgKGRlcGVuZGVuY3kpIHRoaXMuc3RvcmFnZS5zZXREZXBlbmRlbmN5SGVhZChkZXBlbmRlbmN5KQogICAgICAgICAgdHJ1bmNhdGVkID0geyB0bzogdHJlZUxlbmd0aCwgZm9yayB9CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5sZW5ndGggPiB0cmVlTGVuZ3RoKSB7CiAgICAgICAgICBhcHBlbmRlZCA9IHRydWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSB0aGlzLmNvcmUuc2Vzc2lvblN0YXRlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXNbaV0KICAgICAgICBpZiAoc3RhdGUgPT09IHRoaXMpIGNvbnRpbnVlCiAgICAgICAgaWYgKHN0YXRlLm5hbWUgPT09IHRoaXMubmFtZSkgc3RhdGUuX21vdmVUb0NvcmUoY29yZS5jb3JlKQogICAgICB9CgogICAgICB0aGlzLl9tb3ZlVG9Db3JlKGNvcmUuY29yZSwgdHJ1bmNhdGVkLCBhcHBlbmRlZCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMubXV0ZXgudW5sb2NrKCkKICAgIH0KICB9CgogIGFzeW5jIGNyZWF0ZVNlc3Npb24obmFtZSwgb3ZlcndyaXRlLCBhdG9tKSB7CiAgICBsZXQgc3RvcmFnZSA9IG51bGwKICAgIGxldCB0cmVlSW5mbyA9IG51bGwKCiAgICBpZiAoIWF0b20gJiYgIW92ZXJ3cml0ZSAmJiB0aGlzLnN0b3JhZ2UpIHsKICAgICAgc3RvcmFnZSA9IGF3YWl0IHRoaXMuc3RvcmFnZS5yZXN1bWVTZXNzaW9uKG5hbWUpCgogICAgICBpZiAoc3RvcmFnZSAhPT0gbnVsbCkgdHJlZUluZm8gPSAoYXdhaXQgZ2V0Q29yZUhlYWQoc3RvcmFnZSkpIHx8IGdldERlZmF1bHRUcmVlKCkKICAgIH0KCiAgICBjb25zdCBsZW5ndGggPSB0cmVlSW5mbyA/IHRyZWVJbmZvLmxlbmd0aCA6IHRoaXMubGVuZ3RoCgogICAgaWYgKHN0b3JhZ2UgPT09IG51bGwpIHsKICAgICAgdHJlZUluZm8gPSBhd2FpdCB0aGlzLl9nZXRUcmVlSGVhZEF0KGxlbmd0aCkKCiAgICAgIGlmIChhdG9tKSB7CiAgICAgICAgc3RvcmFnZSA9IGF3YWl0IHRoaXMuc3RvcmFnZS5jcmVhdGVBdG9taWNTZXNzaW9uKGF0b20sIHRyZWVJbmZvKQogICAgICB9IGVsc2UgewogICAgICAgIHN0b3JhZ2UgPSBhd2FpdCB0aGlzLnN0b3JhZ2UuY3JlYXRlU2Vzc2lvbihuYW1lLCB0cmVlSW5mbykKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLmF0b21pemVkICYmIGF0b20pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdTZXNzaW9uIGFscmVhZHkgYXRvbWl6ZWQnKQogICAgfQoKICAgIGNvbnN0IGhlYWQgPSB7CiAgICAgIGZvcms6IHRoaXMuZm9yaywKICAgICAgcm9vdHM6CiAgICAgICAgbGVuZ3RoID09PSB0aGlzLmxlbmd0aAogICAgICAgICAgPyB0aGlzLnJvb3RzLnNsaWNlKCkKICAgICAgICAgIDogYXdhaXQgTWVya2xlVHJlZS5nZXRSb290c0Zyb21TdG9yYWdlKHN0b3JhZ2UsIGxlbmd0aCksCiAgICAgIGxlbmd0aCwKICAgICAgcHJvbG9ndWU6IHRoaXMucHJvbG9ndWUsCiAgICAgIHNpZ25hdHVyZTogbGVuZ3RoID09PSB0aGlzLmxlbmd0aCA/IHRoaXMuc2lnbmF0dXJlIDogbnVsbAogICAgfQoKICAgIGNvbnN0IHN0YXRlID0gbmV3IFNlc3Npb25TdGF0ZSgKICAgICAgdGhpcy5jb3JlLAogICAgICBhdG9tID8gdGhpcyA6IG51bGwsCiAgICAgIHN0b3JhZ2UsCiAgICAgIGhlYWQsCiAgICAgIGF0b20gPyB0aGlzLm5hbWUgOiBuYW1lCiAgICApCgogICAgaWYgKGF0b20pIHsKICAgICAgdGhpcy5hdG9taXplZCA9IGF0b20KICAgICAgYXRvbS5vbmZsdXNoKHN0YXRlLl9jb21taXQuYmluZChzdGF0ZSkpCiAgICB9CgogICAgcmV0dXJuIHN0YXRlCiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIGdldEJpdGZpZWxkUGFnZShpbmRleCkgewogIHJldHVybiBNYXRoLmZsb29yKGluZGV4IC8gQml0ZmllbGQuQklUU19QRVJfUEFHRSkKfQoKZnVuY3Rpb24gZmlsbEJpdGZpZWxkUGFnZShwYWdlLCBzdGFydCwgZW5kLCBwYWdlSW5kZXgsIHZhbHVlKSB7CiAgY29uc3Qgb2Zmc2V0ID0gcGFnZUluZGV4ICogQml0ZmllbGQuQklUU19QRVJfUEFHRQogIGNvbnN0IG1heCA9IG9mZnNldCArIEJpdGZpZWxkLkJJVFNfUEVSX1BBR0UKCiAgY29uc3QgaW5kZXggPSBtYXggPCBlbmQgPyBtYXggOiBlbmQKCiAgY29uc3QgZnJvbSA9IHN0YXJ0IC0gb2Zmc2V0CiAgY29uc3QgdG8gPSBpbmRleCAtIG9mZnNldAoKICBxdWlja2JpdC5maWxsKHBhZ2UsIHZhbHVlLCBmcm9tLCB0bykKCiAgcmV0dXJuIGluZGV4Cn0KCmFzeW5jIGZ1bmN0aW9uIHN0b3JlQml0ZmllbGRSYW5nZShzdG9yYWdlLCB0eCwgZnJvbSwgdG8sIHZhbHVlKSB7CiAgaWYgKGZyb20gPj0gdG8pIHJldHVybgoKICBjb25zdCBmaXJzdFBhZ2UgPSBnZXRCaXRmaWVsZFBhZ2UoZnJvbSkKICBjb25zdCBsYXN0UGFnZSA9IGdldEJpdGZpZWxkUGFnZSh0byAtIDEpCgogIGxldCBpbmRleCA9IGZyb20KCiAgY29uc3QgcnggPSBzdG9yYWdlLnJlYWQoKQoKICBjb25zdCBwcm9taXNlcyA9IFtdCiAgZm9yIChsZXQgaSA9IGZpcnN0UGFnZTsgaSA8PSBsYXN0UGFnZTsgaSsrKSB7CiAgICBwcm9taXNlcy5wdXNoKHJ4LmdldEJpdGZpZWxkUGFnZShpKSkKICB9CgogIHJ4LnRyeUZsdXNoKCkKCiAgY29uc3QgcGFnZXMgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcykKICBjb25zdCBjbnQgPSBsYXN0UGFnZSAtIGZpcnN0UGFnZSArIDEKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBjbnQ7IGkrKykgewogICAgY29uc3QgcGFnZUluZGV4ID0gaSArIGZpcnN0UGFnZQogICAgaWYgKCFwYWdlc1tpXSkgcGFnZXNbaV0gPSBiNGEuYWxsb2MoQml0ZmllbGQuQllURVNfUEVSX1BBR0UpCgogICAgaW5kZXggPSBmaWxsQml0ZmllbGRQYWdlKHBhZ2VzW2ldLCBpbmRleCwgdG8sIHBhZ2VJbmRleCwgdmFsdWUpCiAgICB0eC5wdXRCaXRmaWVsZFBhZ2UocGFnZUluZGV4LCBwYWdlc1tpXSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHRydW5jYXRlQW5kRmx1c2gocywgbGVuZ3RoKSB7CiAgY29uc3QgYmF0Y2ggPSBzLmNyZWF0ZVRyZWVCYXRjaCgpCiAgYXdhaXQgTWVya2xlVHJlZS50cnVuY2F0ZShzLCBsZW5ndGgsIGJhdGNoLCBzLmZvcmspCiAgY29uc3QgdHggPSBzLmNyZWF0ZVdyaXRlQmF0Y2goKQoKICBjb25zdCBpbmZvID0gYXdhaXQgcy5fdHJ1bmNhdGUodHgsIGJhdGNoKQogIGNvbnN0IGZsdXNoZWQgPSBhd2FpdCBzLmZsdXNoKCkKCiAgcmV0dXJuIHsKICAgIHRyZWU6IGluZm8udHJlZSwKICAgIHJvb3RzOiBpbmZvLnJvb3RzLAogICAgZGVwZW5kZW5jeTogaW5mby5kZXBlbmRlbmN5LAogICAgZmx1c2hlZAogIH0KfQoKZnVuY3Rpb24gdXBkYXRlRGVwZW5kZW5jeShzdGF0ZSwgbGVuZ3RoLCB0cnVuY2F0ZWQpIHsKICBjb25zdCBpID0gc3RhdGUuc3RvcmFnZS5maW5kRGVwZW5kZW5jeUluZGV4KGxlbmd0aCwgdHJ1bmNhdGVkKQogIGlmIChpID09PSAtMSkgcmV0dXJuIG51bGwgLy8gc2tpcCBkZWZhdWx0IHN0YXRlIGFuZCBvdmVybGF5cyBvZiBkZWZhdWx0CgogIHJldHVybiB7CiAgICBkYXRhUG9pbnRlcjogc3RhdGUuc3RvcmFnZS5kZXBlbmRlbmNpZXNbaV0uZGF0YVBvaW50ZXIsCiAgICBsZW5ndGgKICB9Cn0KCmZ1bmN0aW9uIGdldERlZmF1bHRUcmVlKCkgewogIHJldHVybiB7CiAgICBmb3JrOiAwLAogICAgbGVuZ3RoOiAwLAogICAgcm9vdEhhc2g6IG51bGwsCiAgICBzaWduYXR1cmU6IG51bGwKICB9Cn0KCmZ1bmN0aW9uIGdldENvcmVIZWFkKHN0b3JhZ2UpIHsKICBjb25zdCBiID0gc3RvcmFnZS5yZWFkKCkKICBjb25zdCBwID0gYi5nZXRIZWFkKCkKICBiLnRyeUZsdXNoKCkKICByZXR1cm4gcAp9CgpmdW5jdGlvbiBpc1Jvb3RJbmRleChpbmRleCwgcm9vdHMpIHsKICBmb3IgKGNvbnN0IG5vZGUgb2Ygcm9vdHMpIHsKICAgIGlmIChub2RlLmluZGV4ID09PSBpbmRleCkgcmV0dXJuIHRydWUKICB9CgogIHJldHVybiBmYWxzZQp9CmNvbnN0IHsgV3JpdGFibGUsIFJlYWRhYmxlIH0gPSByZXF1aXJlKCdzdHJlYW14JykKCmNsYXNzIFJlYWRTdHJlYW0gZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3IoY29yZSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy5zdGFydCA9IG9wdHMuc3RhcnQgfHwgMAogICAgdGhpcy5lbmQgPSB0eXBlb2Ygb3B0cy5lbmQgPT09ICdudW1iZXInID8gb3B0cy5lbmQgOiAtMQogICAgdGhpcy5zbmFwc2hvdCA9ICFvcHRzLmxpdmUgJiYgb3B0cy5zbmFwc2hvdCAhPT0gZmFsc2UKICAgIHRoaXMubGl2ZSA9IHRoaXMuZW5kID09PSAtMSA/ICEhb3B0cy5saXZlIDogZmFsc2UKICAgIHRoaXMud2FpdCA9IHR5cGVvZiBvcHRzLndhaXQgPT09ICdib29sZWFuJyA/IG9wdHMud2FpdCA6IHRoaXMuY29yZS53YWl0CiAgICB0aGlzLnRpbWVvdXQgPSBvcHRzLnRpbWVvdXQgfHwgY29yZS50aW1lb3V0CiAgfQoKICBfb3BlbihjYikgewogICAgdGhpcy5fb3BlblAoKS50aGVuKGNiLCBjYikKICB9CgogIF9yZWFkKGNiKSB7CiAgICB0aGlzLl9yZWFkUCgpLnRoZW4oY2IsIGNiKQogIH0KCiAgYXN5bmMgX29wZW5QKCkgewogICAgaWYgKHRoaXMuZW5kID09PSAtMSkgYXdhaXQgdGhpcy5jb3JlLnVwZGF0ZSgpCiAgICBlbHNlIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCiAgICBpZiAodGhpcy5zbmFwc2hvdCAmJiB0aGlzLmVuZCA9PT0gLTEpIHRoaXMuZW5kID0gdGhpcy5jb3JlLmxlbmd0aAogIH0KCiAgYXN5bmMgX3JlYWRQKCkgewogICAgY29uc3QgZW5kID0gdGhpcy5saXZlID8gLTEgOiB0aGlzLmVuZCA9PT0gLTEgPyB0aGlzLmNvcmUubGVuZ3RoIDogdGhpcy5lbmQKICAgIGlmIChlbmQgPj0gMCAmJiB0aGlzLnN0YXJ0ID49IGVuZCkgewogICAgICB0aGlzLnB1c2gobnVsbCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5wdXNoKGF3YWl0IHRoaXMuY29yZS5nZXQodGhpcy5zdGFydCsrLCB7IHdhaXQ6IHRoaXMud2FpdCwgdGltZW91dDogdGhpcy50aW1lb3V0IH0pKQogIH0KfQoKZXhwb3J0cy5SZWFkU3RyZWFtID0gUmVhZFN0cmVhbQoKY2xhc3MgV3JpdGVTdHJlYW0gZXh0ZW5kcyBXcml0YWJsZSB7CiAgY29uc3RydWN0b3IoY29yZSkgewogICAgc3VwZXIoKQogICAgdGhpcy5jb3JlID0gY29yZQogIH0KCiAgX3dyaXRldihiYXRjaCwgY2IpIHsKICAgIHRoaXMuX3dyaXRldlAoYmF0Y2gpLnRoZW4oY2IsIGNiKQogIH0KCiAgYXN5bmMgX3dyaXRldlAoYmF0Y2gpIHsKICAgIGF3YWl0IHRoaXMuY29yZS5hcHBlbmQoYmF0Y2gpCiAgfQp9CgpleHBvcnRzLldyaXRlU3RyZWFtID0gV3JpdGVTdHJlYW0KCmNsYXNzIEJ5dGVTdHJlYW0gZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3IoY29yZSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5fY29yZSA9IGNvcmUKICAgIHRoaXMuX2luZGV4ID0gMAogICAgdGhpcy5fcmFuZ2UgPSBudWxsCgogICAgdGhpcy5fYnl0ZU9mZnNldCA9IG9wdHMuYnl0ZU9mZnNldCB8fCAwCiAgICB0aGlzLl9ieXRlTGVuZ3RoID0gdHlwZW9mIG9wdHMuYnl0ZUxlbmd0aCA9PT0gJ251bWJlcicgPyBvcHRzLmJ5dGVMZW5ndGggOiAtMQogICAgdGhpcy5fcHJlZmV0Y2ggPSB0eXBlb2Ygb3B0cy5wcmVmZXRjaCA9PT0gJ251bWJlcicgPyBvcHRzLnByZWZldGNoIDogMzIKCiAgICB0aGlzLl9hcHBseU9mZnNldCA9IHRoaXMuX2J5dGVPZmZzZXQgPiAwCiAgfQoKICBfb3BlbihjYikgewogICAgdGhpcy5fb3BlbnAoKS50aGVuKGNiLCBjYikKICB9CgogIF9yZWFkKGNiKSB7CiAgICB0aGlzLl9yZWFkcCgpLnRoZW4oY2IsIGNiKQogIH0KCiAgYXN5bmMgX29wZW5wKCkgewogICAgaWYgKHRoaXMuX2J5dGVMZW5ndGggPT09IC0xKSB7CiAgICAgIGF3YWl0IHRoaXMuX2NvcmUudXBkYXRlKCkKICAgICAgdGhpcy5fYnl0ZUxlbmd0aCA9IE1hdGgubWF4KHRoaXMuX2NvcmUuYnl0ZUxlbmd0aCAtIHRoaXMuX2J5dGVPZmZzZXQsIDApCiAgICB9CiAgfQoKICBhc3luYyBfcmVhZHAoKSB7CiAgICBsZXQgZGF0YSA9IG51bGwKCiAgICBpZiAodGhpcy5fYnl0ZUxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLnB1c2gobnVsbCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgbGV0IHJlbGF0aXZlT2Zmc2V0ID0gMAoKICAgIGlmICh0aGlzLl9hcHBseU9mZnNldCkgewogICAgICB0aGlzLl9hcHBseU9mZnNldCA9IGZhbHNlCgogICAgICBjb25zdCBbYmxvY2ssIGJ5dGVPZmZzZXRdID0gYXdhaXQgdGhpcy5fY29yZS5zZWVrKHRoaXMuX2J5dGVPZmZzZXQpCgogICAgICB0aGlzLl9pbmRleCA9IGJsb2NrCiAgICAgIHJlbGF0aXZlT2Zmc2V0ID0gYnl0ZU9mZnNldAogICAgfQoKICAgIHRoaXMuX3ByZWRvd25sb2FkKHRoaXMuX2luZGV4ICsgMSkKICAgIGRhdGEgPSBhd2FpdCB0aGlzLl9jb3JlLmdldCh0aGlzLl9pbmRleCsrLCB7IHZhbHVlRW5jb2Rpbmc6ICdiaW5hcnknIH0pCgogICAgaWYgKHJlbGF0aXZlT2Zmc2V0ID4gMCkgZGF0YSA9IGRhdGEuc3ViYXJyYXkocmVsYXRpdmVPZmZzZXQpCgogICAgaWYgKGRhdGEuYnl0ZUxlbmd0aCA+IHRoaXMuX2J5dGVMZW5ndGgpIGRhdGEgPSBkYXRhLnN1YmFycmF5KDAsIHRoaXMuX2J5dGVMZW5ndGgpCiAgICB0aGlzLl9ieXRlTGVuZ3RoIC09IGRhdGEuYnl0ZUxlbmd0aAoKICAgIHRoaXMucHVzaChkYXRhKQogICAgaWYgKHRoaXMuX2J5dGVMZW5ndGggPT09IDApIHRoaXMucHVzaChudWxsKQogIH0KCiAgX3ByZWRvd25sb2FkKGluZGV4KSB7CiAgICBpZiAodGhpcy5fcmFuZ2UpIHRoaXMuX3JhbmdlLmRlc3Ryb3koKQogICAgdGhpcy5fcmFuZ2UgPSB0aGlzLl9jb3JlLmRvd25sb2FkKHsgc3RhcnQ6IGluZGV4LCBlbmQ6IGluZGV4ICsgdGhpcy5fcHJlZmV0Y2gsIGxpbmVhcjogdHJ1ZSB9KQogIH0KCiAgX2Rlc3Ryb3koY2IpIHsKICAgIGlmICh0aGlzLl9yYW5nZSkgdGhpcy5fcmFuZ2UuZGVzdHJveSgpCiAgICBjYihudWxsKQogIH0KfQoKZXhwb3J0cy5CeXRlU3RyZWFtID0gQnl0ZVN0cmVhbQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBmbGF0ID0gcmVxdWlyZSgnZmxhdC10cmVlJykKY29uc3QgeyBCQURfQVJHVU1FTlQgfSA9IHJlcXVpcmUoJ2h5cGVyY29yZS1lcnJvcnMnKQpjb25zdCB1bnNsYWIgPSByZXF1aXJlKCd1bnNsYWInKQoKY29uc3QgbSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMnKQpjb25zdCBtdWx0aXNpZyA9IHJlcXVpcmUoJy4vbXVsdGlzaWcnKQpjb25zdCBjYXBzID0gcmVxdWlyZSgnLi9jYXBzJykKCmNsYXNzIFNpZ25lciB7CiAgY29uc3RydWN0b3IoCiAgICBtYW5pZmVzdEhhc2gsCiAgICB2ZXJzaW9uLAogICAgaW5kZXgsCiAgICB7IHNpZ25hdHVyZSA9ICdlZDI1NTE5JywgcHVibGljS2V5LCBuYW1lc3BhY2UgPSBjYXBzLkRFRkFVTFRfTkFNRVNQQUNFIH0gPSB7fQogICkgewogICAgaWYgKCFwdWJsaWNLZXkpIHRocm93IEJBRF9BUkdVTUVOVCgncHVibGljIGtleSBpcyByZXF1aXJlZCBmb3IgYSBzaWduZXInKQogICAgaWYgKHNpZ25hdHVyZSAhPT0gJ2VkMjU1MTknKSB0aHJvdyBCQURfQVJHVU1FTlQoJ09ubHkgRWQyNTUxOSBzaWduYXR1cmVzIGFyZSBzdXBwb3J0ZWQnKQoKICAgIHRoaXMubWFuaWZlc3RIYXNoID0gbWFuaWZlc3RIYXNoCiAgICB0aGlzLnZlcnNpb24gPSB2ZXJzaW9uCiAgICB0aGlzLnNpZ25lciA9IGluZGV4CiAgICB0aGlzLnNpZ25hdHVyZSA9IHNpZ25hdHVyZQogICAgdGhpcy5wdWJsaWNLZXkgPSBwdWJsaWNLZXkKICAgIHRoaXMubmFtZXNwYWNlID0gbmFtZXNwYWNlCiAgfQoKICBfY3R4KCkgewogICAgcmV0dXJuIHRoaXMudmVyc2lvbiA9PT0gMCA/IHRoaXMubmFtZXNwYWNlIDogdGhpcy5tYW5pZmVzdEhhc2gKICB9CgogIHZlcmlmeShiYXRjaCwgc2lnbmF0dXJlKSB7CiAgICByZXR1cm4gY3J5cHRvLnZlcmlmeShiYXRjaC5zaWduYWJsZSh0aGlzLl9jdHgoKSksIHNpZ25hdHVyZSwgdGhpcy5wdWJsaWNLZXkpCiAgfQoKICBzaWduKGJhdGNoLCBrZXlQYWlyKSB7CiAgICByZXR1cm4gY3J5cHRvLnNpZ24oYmF0Y2guc2lnbmFibGUodGhpcy5fY3R4KCkpLCBrZXlQYWlyLnNlY3JldEtleSkKICB9Cn0KCmNsYXNzIENvbXBhdFNpZ25lciBleHRlbmRzIFNpZ25lciB7CiAgY29uc3RydWN0b3IoaW5kZXgsIHNpZ25lciwgbGVnYWN5KSB7CiAgICBzdXBlcihudWxsLCAwLCBpbmRleCwgc2lnbmVyKQogICAgdGhpcy5sZWdhY3kgPSBsZWdhY3kKICB9CgogIHZlcmlmeShiYXRjaCwgc2lnbmF0dXJlKSB7CiAgICByZXR1cm4gY3J5cHRvLnZlcmlmeShiYXRjaC5zaWduYWJsZUNvbXBhdCh0aGlzLmxlZ2FjeSksIHNpZ25hdHVyZSwgdGhpcy5wdWJsaWNLZXkpCiAgfQoKICBzaWduKGJhdGNoLCBrZXlQYWlyKSB7CiAgICByZXR1cm4gY3J5cHRvLnNpZ24oYmF0Y2guc2lnbmFibGVDb21wYXQodGhpcy5sZWdhY3kpLCBrZXlQYWlyLnNlY3JldEtleSkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVmVyaWZpZXIgewogIGNvbnN0cnVjdG9yKAogICAgbWFuaWZlc3RIYXNoLAogICAgbWFuaWZlc3QsCiAgICB7IGNvbXBhdCA9IGlzQ29tcGF0KG1hbmlmZXN0SGFzaCwgbWFuaWZlc3QpLCBsZWdhY3kgPSBmYWxzZSB9ID0ge30KICApIHsKICAgIGNvbnN0IHNlbGYgPSB0aGlzCgogICAgdGhpcy5tYW5pZmVzdEhhc2ggPSBtYW5pZmVzdEhhc2gKICAgIHRoaXMuY29tcGF0ID0gY29tcGF0IHx8IG1hbmlmZXN0ID09PSBudWxsCiAgICB0aGlzLnZlcnNpb24gPSB0aGlzLmNvbXBhdCA/IDAgOiB0eXBlb2YgbWFuaWZlc3QudmVyc2lvbiA9PT0gJ251bWJlcicgPyBtYW5pZmVzdC52ZXJzaW9uIDogMQogICAgdGhpcy5oYXNoID0gbWFuaWZlc3QuaGFzaCB8fCAnYmxha2UyYicKICAgIHRoaXMuYWxsb3dQYXRjaCA9ICF0aGlzLmNvbXBhdCAmJiAhIW1hbmlmZXN0LmFsbG93UGF0Y2gKICAgIHRoaXMucXVvcnVtID0gdGhpcy5jb21wYXQgPyAxIDogZGVmYXVsdFF1b3J1bShtYW5pZmVzdCkKCiAgICB0aGlzLnNpZ25lcnMgPSBtYW5pZmVzdC5zaWduZXJzID8gbWFuaWZlc3Quc2lnbmVycy5tYXAoY3JlYXRlU2lnbmVyKSA6IFtdCiAgICB0aGlzLnByb2xvZ3VlID0gdGhpcy5jb21wYXQgPyBudWxsIDogbWFuaWZlc3QucHJvbG9ndWUgfHwgbnVsbAoKICAgIGZ1bmN0aW9uIGNyZWF0ZVNpZ25lcihzaWduZXIsIGluZGV4KSB7CiAgICAgIHJldHVybiBzZWxmLmNvbXBhdAogICAgICAgID8gbmV3IENvbXBhdFNpZ25lcihpbmRleCwgc2lnbmVyLCBsZWdhY3kpCiAgICAgICAgOiBuZXcgU2lnbmVyKG1hbmlmZXN0SGFzaCwgc2VsZi52ZXJzaW9uLCBpbmRleCwgc2lnbmVyKQogICAgfQogIH0KCiAgX3ZlcmlmeUNvbXBhdChiYXRjaCwgc2lnbmF0dXJlKSB7CiAgICBpZiAoIXNpZ25hdHVyZSkgcmV0dXJuIGZhbHNlCgogICAgaWYgKHRoaXMuY29tcGF0IHx8ICghdGhpcy5hbGxvd1BhdGNoICYmIHRoaXMuc2lnbmVycy5sZW5ndGggPT09IDEpKSB7CiAgICAgIHJldHVybiAhIXNpZ25hdHVyZSAmJiB0aGlzLnNpZ25lcnNbMF0udmVyaWZ5KGJhdGNoLCBzaWduYXR1cmUpCiAgICB9CgogICAgcmV0dXJuIHRoaXMuX3ZlcmlmeU11bHRpKGJhdGNoLCBzaWduYXR1cmUpCiAgfQoKICBfaW5mbGF0ZShzaWduYXR1cmUpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPj0gMSkgcmV0dXJuIG11bHRpc2lnLmluZmxhdGUoc2lnbmF0dXJlKQogICAgY29uc3QgeyBwcm9vZnMsIHBhdGNoIH0gPSBtdWx0aXNpZy5pbmZsYXRldjAoc2lnbmF0dXJlKQoKICAgIHJldHVybiB7CiAgICAgIHByb29mczogcHJvb2ZzLm1hcChwcm9vZlRvVmVyc2lvbjEpLAogICAgICBwYXRjaAogICAgfQogIH0KCiAgX3ZlcmlmeU11bHRpKGJhdGNoLCBzaWduYXR1cmUpIHsKICAgIGlmICghc2lnbmF0dXJlIHx8IHRoaXMucXVvcnVtID09PSAwKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCB7IHByb29mcywgcGF0Y2ggfSA9IHRoaXMuX2luZmxhdGUoc2lnbmF0dXJlKQogICAgaWYgKHByb29mcy5sZW5ndGggPCB0aGlzLnF1b3J1bSkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgdHJpZWQgPSBuZXcgVWludDhBcnJheSh0aGlzLnNpZ25lcnMubGVuZ3RoKQogICAgY29uc3Qgbm9kZXMgPSB0aGlzLmFsbG93UGF0Y2ggJiYgcGF0Y2gubGVuZ3RoID8gdG9NYXAocGF0Y2gpIDogbnVsbAoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5xdW9ydW07IGkrKykgewogICAgICBjb25zdCBpbnAgPSBwcm9vZnNbaV0KCiAgICAgIGxldCB0cmVlID0gYmF0Y2gKCiAgICAgIGlmIChpbnAucGF0Y2ggJiYgdGhpcy5hbGxvd1BhdGNoKSB7CiAgICAgICAgdHJlZSA9IGJhdGNoLmNsb25lKCkKCiAgICAgICAgY29uc3QgdXBncmFkZSA9IGdlbmVyYXRlVXBncmFkZShub2RlcywgYmF0Y2gubGVuZ3RoLCBpbnAucGF0Y2gpCiAgICAgICAgY29uc3QgcHJvb2YgPSB7CiAgICAgICAgICBmb3JrOiB0cmVlLmZvcmssCiAgICAgICAgICBibG9jazogbnVsbCwKICAgICAgICAgIGhhc2g6IG51bGwsCiAgICAgICAgICBzZWVrOiBudWxsLAogICAgICAgICAgdXBncmFkZSwKICAgICAgICAgIG1hbmlmZXN0OiBudWxsCiAgICAgICAgfQoKICAgICAgICB0cnkgewogICAgICAgICAgaWYgKCF0cmVlLnZlcmlmeVVwZ3JhZGUocHJvb2YpKSByZXR1cm4gZmFsc2UKICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGlucC5zaWduZXIgPj0gdGhpcy5zaWduZXJzLmxlbmd0aCB8fCB0cmllZFtpbnAuc2lnbmVyXSkgcmV0dXJuIGZhbHNlCiAgICAgIHRyaWVkW2lucC5zaWduZXJdID0gMQoKICAgICAgY29uc3QgcyA9IHRoaXMuc2lnbmVyc1tpbnAuc2lnbmVyXQogICAgICBpZiAoIXMudmVyaWZ5KHRyZWUsIGlucC5zaWduYXR1cmUpKSByZXR1cm4gZmFsc2UKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgdmVyaWZ5KGJhdGNoLCBzaWduYXR1cmUpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIHsKICAgICAgcmV0dXJuIHRoaXMuX3ZlcmlmeUNvbXBhdChiYXRjaCwgc2lnbmF0dXJlKQogICAgfQoKICAgIGlmICh0aGlzLnByb2xvZ3VlICE9PSBudWxsICYmIGJhdGNoLmxlbmd0aCA8PSB0aGlzLnByb2xvZ3VlLmxlbmd0aCkgewogICAgICByZXR1cm4gYmF0Y2gubGVuZ3RoID09PSB0aGlzLnByb2xvZ3VlLmxlbmd0aCAmJiBiNGEuZXF1YWxzKGJhdGNoLmhhc2goKSwgdGhpcy5wcm9sb2d1ZS5oYXNoKQogICAgfQoKICAgIHJldHVybiB0aGlzLl92ZXJpZnlNdWx0aShiYXRjaCwgc2lnbmF0dXJlKQogIH0KCiAgLy8gVE9ETzogYmV0dGVyIGFwaSBmb3IgdGhpcyB0aGF0IGlzIG1vcmUgLi4uIG11bHRpc2lnLWV5CiAgc2lnbihiYXRjaCwga2V5UGFpcikgewogICAgaWYgKCFrZXlQYWlyIHx8ICFrZXlQYWlyLnNlY3JldEtleSkgdGhyb3cgQkFEX0FSR1VNRU5UKCdObyBrZXkgcGFpciB3YXMgcGFzc2VkJykKCiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5zaWduZXJzKSB7CiAgICAgIGlmIChiNGEuZXF1YWxzKHMucHVibGljS2V5LCBrZXlQYWlyLnB1YmxpY0tleSkpIHsKICAgICAgICBjb25zdCBzaWduYXR1cmUgPSBzLnNpZ24oYmF0Y2gsIGtleVBhaXIpCiAgICAgICAgaWYgKHRoaXMuc2lnbmVycy5sZW5ndGggIT09IDEgfHwgdGhpcy52ZXJzaW9uID09PSAwKSByZXR1cm4gc2lnbmF0dXJlCiAgICAgICAgcmV0dXJuIHRoaXMuYXNzZW1ibGUoW3sgc2lnbmVyOiAwLCBzaWduYXR1cmUsIHBhdGNoOiAwLCBub2RlczogbnVsbCB9XSkKICAgICAgfQogICAgfQoKICAgIHRocm93IEJBRF9BUkdVTUVOVCgnUHVibGljIGtleSBpcyBub3QgYSBkZWNsYXJlZCBzaWduZXInKQogIH0KCiAgYXNzZW1ibGUoaW5wdXRzKSB7CiAgICByZXR1cm4gdGhpcy52ZXJzaW9uID09PSAwID8gbXVsdGlzaWcuYXNzZW1ibGV2MChpbnB1dHMpIDogbXVsdGlzaWcuYXNzZW1ibGUoaW5wdXRzKQogIH0KCiAgc3RhdGljIG1hbmlmZXN0SGFzaChtYW5pZmVzdCkgewogICAgcmV0dXJuIG1hbmlmZXN0SGFzaChtYW5pZmVzdCkKICB9CgogIHN0YXRpYyBlbmNvZGVNYW5pZmVzdChtYW5pZmVzdCkgewogICAgcmV0dXJuIGMuZW5jb2RlKG0ubWFuaWZlc3QsIG1hbmlmZXN0KQogIH0KCiAgc3RhdGljIGRlY29kZU1hbmlmZXN0KG1hbmlmZXN0KSB7CiAgICByZXR1cm4gYy5kZWNvZGUobS5tYW5pZmVzdCwgbWFuaWZlc3QpCiAgfQoKICBzdGF0aWMgZGVmYXVsdFNpZ25lck1hbmlmZXN0KHB1YmxpY0tleSkgewogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogMSwKICAgICAgaGFzaDogJ2JsYWtlMmInLAogICAgICBhbGxvd1BhdGNoOiBmYWxzZSwKICAgICAgcXVvcnVtOiAxLAogICAgICBzaWduZXJzOiBbCiAgICAgICAgewogICAgICAgICAgc2lnbmF0dXJlOiAnZWQyNTUxOScsCiAgICAgICAgICBuYW1lc3BhY2U6IGNhcHMuREVGQVVMVF9OQU1FU1BBQ0UsCiAgICAgICAgICBwdWJsaWNLZXkKICAgICAgICB9CiAgICAgIF0sCiAgICAgIHByb2xvZ3VlOiBudWxsLAogICAgICBsaW5rZWQ6IG51bGwsCiAgICAgIHVzZXJEYXRhOiBudWxsCiAgICB9CiAgfQoKICBzdGF0aWMgZnJvbU1hbmlmZXN0KG1hbmlmZXN0LCBvcHRzKSB7CiAgICBjb25zdCBtID0gdGhpcy5jcmVhdGVNYW5pZmVzdChtYW5pZmVzdCkKICAgIHJldHVybiBuZXcgdGhpcyhtYW5pZmVzdEhhc2gobSksIG0sIG9wdHMpCiAgfQoKICBzdGF0aWMgY3JlYXRlTWFuaWZlc3QoaW5wKSB7CiAgICBpZiAoIWlucCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBtYW5pZmVzdCA9IHsKICAgICAgdmVyc2lvbjogZ2V0TWFuaWZlc3RWZXJzaW9uKGlucCksIC8vIGRlZmF1bHRzIHRvIHYxCiAgICAgIGhhc2g6ICdibGFrZTJiJywKICAgICAgYWxsb3dQYXRjaDogISFpbnAuYWxsb3dQYXRjaCwKICAgICAgcXVvcnVtOiBkZWZhdWx0UXVvcnVtKGlucCksCiAgICAgIHNpZ25lcnM6IGlucC5zaWduZXJzID8gaW5wLnNpZ25lcnMubWFwKHBhcnNlU2lnbmVyKSA6IFtdLAogICAgICBwcm9sb2d1ZTogbnVsbCwKICAgICAgbGlua2VkOiBudWxsLAogICAgICB1c2VyRGF0YTogaW5wLnVzZXJEYXRhIHx8IG51bGwKICAgIH0KCiAgICBpZiAoaW5wLmhhc2ggJiYgaW5wLmhhc2ggIT09ICdibGFrZTJiJykgdGhyb3cgQkFEX0FSR1VNRU5UKCdPbmx5IEJsYWtlMmIgaGFzaGVzIGFyZSBzdXBwb3J0ZWQnKQoKICAgIGlmIChpbnAucHJvbG9ndWUpIHsKICAgICAgaWYgKAogICAgICAgICEoYjRhLmlzQnVmZmVyKGlucC5wcm9sb2d1ZS5oYXNoKSAmJiBpbnAucHJvbG9ndWUuaGFzaC5ieXRlTGVuZ3RoID09PSAzMikgfHwKICAgICAgICAhKGlucC5wcm9sb2d1ZS5sZW5ndGggPj0gMCkKICAgICAgKSB7CiAgICAgICAgdGhyb3cgQkFEX0FSR1VNRU5UKCdJbnZhbGlkIHByb2xvZ3VlJykKICAgICAgfQoKICAgICAgbWFuaWZlc3QucHJvbG9ndWUgPSBpbnAucHJvbG9ndWUKICAgICAgbWFuaWZlc3QucHJvbG9ndWUuaGFzaCA9IHVuc2xhYihtYW5pZmVzdC5wcm9sb2d1ZS5oYXNoKQogICAgfQoKICAgIGlmIChtYW5pZmVzdC51c2VyRGF0YSAhPT0gbnVsbCAmJiBtYW5pZmVzdC52ZXJzaW9uIDwgMikgewogICAgICB0aHJvdyBCQURfQVJHVU1FTlQoJ0ludmFsaWQgZmllbGQ6IHVzZXJEYXRhJykKICAgIH0KCiAgICBpZiAoaW5wLmxpbmtlZCAmJiBpbnAubGlua2VkLmxlbmd0aCkgewogICAgICBpZiAobWFuaWZlc3QudmVyc2lvbiA8IDIpIHRocm93IEJBRF9BUkdVTUVOVCgnSW52YWxpZCBmaWVsZDogbGlua2VkJykKCiAgICAgIGZvciAoY29uc3Qga2V5IG9mIGlucC5saW5rZWQpIHsKICAgICAgICBpZiAoIShiNGEuaXNCdWZmZXIoa2V5KSAmJiBrZXkuYnl0ZUxlbmd0aCA9PT0gMzIpKSB7CiAgICAgICAgICB0aHJvdyBCQURfQVJHVU1FTlQoJ0ludmFsaWQga2V5JykKICAgICAgICB9CiAgICAgIH0KCiAgICAgIG1hbmlmZXN0LmxpbmtlZCA9IGlucC5saW5rZWQKICAgIH0KCiAgICByZXR1cm4gbWFuaWZlc3QKICB9CgogIHN0YXRpYyBpc1ZhbGlkTWFuaWZlc3Qoa2V5LCBtYW5pZmVzdCkgewogICAgcmV0dXJuIGI0YS5lcXVhbHMoa2V5LCBtYW5pZmVzdEhhc2gobWFuaWZlc3QpKQogIH0KCiAgc3RhdGljIGlzQ29tcGF0KGtleSwgbWFuaWZlc3QpIHsKICAgIHJldHVybiBpc0NvbXBhdChrZXksIG1hbmlmZXN0KQogIH0KCiAgc3RhdGljIHNpZ24obWFuaWZlc3QsIGJhdGNoLCBrZXlQYWlyLCBvcHRzKSB7CiAgICByZXR1cm4gVmVyaWZpZXIuZnJvbU1hbmlmZXN0KG1hbmlmZXN0LCBvcHRzKS5zaWduKGJhdGNoLCBrZXlQYWlyKQogIH0KfQoKZnVuY3Rpb24gdG9NYXAobm9kZXMpIHsKICBjb25zdCBtID0gbmV3IE1hcCgpCiAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSBtLnNldChub2RlLmluZGV4LCBub2RlKQogIHJldHVybiBtCn0KCmZ1bmN0aW9uIGlzQ29tcGF0KGtleSwgbWFuaWZlc3QpIHsKICByZXR1cm4gISEoCiAgICBtYW5pZmVzdCAmJgogICAgbWFuaWZlc3Quc2lnbmVycy5sZW5ndGggPT09IDEgJiYKICAgIGI0YS5lcXVhbHMoa2V5LCBtYW5pZmVzdC5zaWduZXJzWzBdLnB1YmxpY0tleSkKICApCn0KCmZ1bmN0aW9uIGRlZmF1bHRRdW9ydW0obWFuKSB7CiAgaWYgKHR5cGVvZiBtYW4ucXVvcnVtID09PSAnbnVtYmVyJykgcmV0dXJuIG1hbi5xdW9ydW0KICBpZiAoIW1hbi5zaWduZXJzIHx8ICFtYW4uc2lnbmVycy5sZW5ndGgpIHJldHVybiAwCiAgcmV0dXJuIChtYW4uc2lnbmVycy5sZW5ndGggPj4gMSkgKyAxCn0KCmZ1bmN0aW9uIGdlbmVyYXRlVXBncmFkZShwYXRjaCwgc3RhcnQsIGxlbmd0aCkgewogIGNvbnN0IHVwZ3JhZGUgPSB7IHN0YXJ0LCBsZW5ndGgsIG5vZGVzOiBudWxsLCBhZGRpdGlvbmFsTm9kZXM6IFtdLCBzaWduYXR1cmU6IG51bGwgfQoKICBjb25zdCBmcm9tID0gc3RhcnQgKiAyCiAgY29uc3QgdG8gPSBmcm9tICsgbGVuZ3RoICogMgoKICBmb3IgKGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IoMCk7IGl0ZS5mdWxsUm9vdCh0byk7IGl0ZS5uZXh0VHJlZSgpKSB7CiAgICBpZiAoaXRlLmluZGV4ICsgaXRlLmZhY3RvciAvIDIgPCBmcm9tKSBjb250aW51ZQoKICAgIGlmICh1cGdyYWRlLm5vZGVzID09PSBudWxsICYmIGl0ZS5jb250YWlucyhmcm9tIC0gMikpIHsKICAgICAgdXBncmFkZS5ub2RlcyA9IFtdCgogICAgICBjb25zdCByb290ID0gaXRlLmluZGV4CiAgICAgIGNvbnN0IHRhcmdldCA9IGZyb20gLSAyCgogICAgICBpdGUuc2Vlayh0YXJnZXQpCgogICAgICB3aGlsZSAoaXRlLmluZGV4ICE9PSByb290KSB7CiAgICAgICAgaXRlLnNpYmxpbmcoKQogICAgICAgIGlmIChpdGUuaW5kZXggPiB0YXJnZXQpIHVwZ3JhZGUubm9kZXMucHVzaChwYXRjaC5nZXQoaXRlLmluZGV4KSkKICAgICAgICBpdGUucGFyZW50KCkKICAgICAgfQoKICAgICAgY29udGludWUKICAgIH0KCiAgICBpZiAodXBncmFkZS5ub2RlcyA9PT0gbnVsbCkgdXBncmFkZS5ub2RlcyA9IFtdCiAgICB1cGdyYWRlLm5vZGVzLnB1c2gocGF0Y2guZ2V0KGl0ZS5pbmRleCkpCiAgfQoKICBpZiAodXBncmFkZS5ub2RlcyA9PT0gbnVsbCkgdXBncmFkZS5ub2RlcyA9IFtdCiAgcmV0dXJuIHVwZ3JhZGUKfQoKZnVuY3Rpb24gcGFyc2VTaWduZXIoc2lnbmVyKSB7CiAgdmFsaWRhdGVTaWduZXIoc2lnbmVyKQogIHJldHVybiB7CiAgICBzaWduYXR1cmU6ICdlZDI1NTE5JywKICAgIG5hbWVzcGFjZTogdW5zbGFiKHNpZ25lci5uYW1lc3BhY2UgfHwgY2Fwcy5ERUZBVUxUX05BTUVTUEFDRSksCiAgICBwdWJsaWNLZXk6IHVuc2xhYihzaWduZXIucHVibGljS2V5KQogIH0KfQoKZnVuY3Rpb24gdmFsaWRhdGVTaWduZXIoc2lnbmVyKSB7CiAgaWYgKCFzaWduZXIgfHwgIXNpZ25lci5wdWJsaWNLZXkpIHRocm93IEJBRF9BUkdVTUVOVCgnU2lnbmVyIG1pc3NpbmcgcHVibGljIGtleScpCiAgaWYgKHNpZ25lci5zaWduYXR1cmUgJiYgc2lnbmVyLnNpZ25hdHVyZSAhPT0gJ2VkMjU1MTknKSB7CiAgICB0aHJvdyBCQURfQVJHVU1FTlQoJ09ubHkgRWQyNTUxOSBzaWduYXR1cmVzIGFyZSBzdXBwb3J0ZWQnKQogIH0KfQoKZnVuY3Rpb24gbWFuaWZlc3RIYXNoKG1hbmlmZXN0KSB7CiAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDMyLCBidWZmZXI6IG51bGwgfQogIG0ubWFuaWZlc3QucHJlZW5jb2RlKHN0YXRlLCBtYW5pZmVzdCkKICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQogIGMucmF3LmVuY29kZShzdGF0ZSwgY2Fwcy5NQU5JRkVTVCkKICBtLm1hbmlmZXN0LmVuY29kZShzdGF0ZSwgbWFuaWZlc3QpCiAgcmV0dXJuIGNyeXB0by5oYXNoKHN0YXRlLmJ1ZmZlcikKfQoKZnVuY3Rpb24gcHJvb2ZUb1ZlcnNpb24xKHByb29mKSB7CiAgcmV0dXJuIHsKICAgIHNpZ25lcjogcHJvb2Yuc2lnbmVyLAogICAgc2lnbmF0dXJlOiBwcm9vZi5zaWduYXR1cmUsCiAgICBwYXRjaDogcHJvb2YucGF0Y2ggPyBwcm9vZi5wYXRjaC5sZW5ndGggOiAwCiAgfQp9CgpmdW5jdGlvbiBnZXRNYW5pZmVzdFZlcnNpb24oaW5wKSB7CiAgaWYgKHR5cGVvZiBpbnAudmVyc2lvbiA9PT0gJ251bWJlcicpIHJldHVybiBpbnAudmVyc2lvbgogIGlmIChpbnAubGlua2VkICYmIGlucC5saW5rZWQubGVuZ3RoKSByZXR1cm4gMgogIGlmIChpbnAudXNlckRhdGEpIHJldHVybiAyCiAgcmV0dXJuIDEKfQp7CiAgIm5hbWUiOiAiaHlwZXJjb3JlIiwKICAidmVyc2lvbiI6ICIxMS4yMS41IiwKICAiZGVzY3JpcHRpb24iOiAiSHlwZXJjb3JlIGlzIGEgc2VjdXJlLCBkaXN0cmlidXRlZCBhcHBlbmQtb25seSBsb2ciLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIiwKICAgICJsaW50IjogInByZXR0aWVyIC0tY2hlY2sgLiAmJiBsdW50ZSIsCiAgICAidGVzdCI6ICJicml0dGxlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDpnZW5lcmF0ZSI6ICJicml0dGxlIC1yIHRlc3QvYWxsLmpzIHRlc3QvKi5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmNvcmUuZ2l0IgogIH0sCiAgImNvbnRyaWJ1dG9ycyI6IFsKICAgIHsKICAgICAgIm5hbWUiOiAiTWF0aGlhcyBCdXVzIiwKICAgICAgImVtYWlsIjogIm1hdGhpYXNidXVzQGdtYWlsLmNvbSIsCiAgICAgICJ1cmwiOiAiaHR0cHM6Ly9tYWZpbnRvLnNoIgogICAgfSwKICAgIHsKICAgICAgIm5hbWUiOiAiQW5kcmV3IE9zaGVyb2ZmIiwKICAgICAgImVtYWlsIjogImFuZHJld29zaEBnbWFpbC5jb20iLAogICAgICAidXJsIjogImh0dHBzOi8vYW5kcmV3b3NoLmNvbSIKICAgIH0KICBdLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmNvcmUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmNvcmUjcmVhZG1lIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImVycm9ycy5qcyIsCiAgICAibWVzc2FnZXMuanMiLAogICAgImxpYi8qKi5qcyIKICBdLAogICJpbXBvcnRzIjogewogICAgImV2ZW50cyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1ldmVudHMiLAogICAgICAiZGVmYXVsdCI6ICJldmVudHMiCiAgICB9CiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiAiXjYuMC4wIiwKICAgICJiNGEiOiAiXjEuMS4wIiwKICAgICJiYXJlLWV2ZW50cyI6ICJeMi4yLjAiLAogICAgImJpZy1zcGFyc2UtYXJyYXkiOiAiXjEuMC4zIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjExLjAiLAogICAgImZhc3QtZmlmbyI6ICJeMS4zLjAiLAogICAgImZsYXQtdHJlZSI6ICJeMS45LjAiLAogICAgImh5cGVyY29yZS1jcnlwdG8iOiAiXjMuMi4xIiwKICAgICJoeXBlcmNvcmUtZXJyb3JzIjogIl4xLjUuMCIsCiAgICAiaHlwZXJjb3JlLWlkLWVuY29kaW5nIjogIl4xLjIuMCIsCiAgICAiaHlwZXJjb3JlLXN0b3JhZ2UiOiAiXjIuMC4wIiwKICAgICJpcy1vcHRpb25zIjogIl4xLjAuMSIsCiAgICAibmFub2Fzc2VydCI6ICJeMi4wLjAiLAogICAgInByb3RvbXV4IjogIl4zLjUuMCIsCiAgICAicXVpY2tiaXQtdW5pdmVyc2FsIjogIl4yLjIuMCIsCiAgICAicmFuZG9tLWFycmF5LWl0ZXJhdG9yIjogIl4xLjAuMCIsCiAgICAic2FmZXR5LWNhdGNoIjogIl4xLjAuMSIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjEiLAogICAgInN0cmVhbXgiOiAiXjIuMTIuNCIsCiAgICAidW5zbGFiIjogIl4xLjMuMCIsCiAgICAiejMyIjogIl4xLjAuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4wLjAiLAogICAgImRlYnVnZ2luZy1zdHJlYW0iOiAiXjMuMS4wIiwKICAgICJoeXBlcnN3YXJtIjogIl40LjMuNiIsCiAgICAibHVudGUiOiAiXjEuMy4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIiwKICAgICJyYWNoZSI6ICJeMS4wLjAiLAogICAgInJhbmdlLXBhcnNlciI6ICJeMS4yLjEiLAogICAgInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiAiXjEuMS4wIiwKICAgICJzcGVlZG9tZXRlciI6ICJeMS4xLjAiLAogICAgInRlc3QtdG1wIjogIl4xLjAuMiIsCiAgICAidGlueS1ieXRlLXNpemUiOiAiXjEuMS4wIiwKICAgICJ1ZHgtbmF0aXZlIjogIl4xLjYuMSIsCiAgICAidW5jYXVnaHRzIjogIl4xLjEuMCIKICB9Cn0KY29uc3QgREhUID0gcmVxdWlyZSgnZGh0LXJwYycpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgbSA9IHJlcXVpcmUoJy4vbGliL21lc3NhZ2VzJykKY29uc3QgU29ja2V0UG9vbCA9IHJlcXVpcmUoJy4vbGliL3NvY2tldC1wb29sJykKY29uc3QgUGVyc2lzdGVudCA9IHJlcXVpcmUoJy4vbGliL3BlcnNpc3RlbnQnKQpjb25zdCBSb3V0ZXIgPSByZXF1aXJlKCcuL2xpYi9yb3V0ZXInKQpjb25zdCBDYWNoZSA9IHJlcXVpcmUoJ3hhY2hlJykKY29uc3QgU2VydmVyID0gcmVxdWlyZSgnLi9saWIvc2VydmVyJykKY29uc3QgY29ubmVjdCA9IHJlcXVpcmUoJy4vbGliL2Nvbm5lY3QnKQpjb25zdCB7IEZJUkVXQUxMLCBCT09UU1RSQVBfTk9ERVMsIEtOT1dOX05PREVTLCBDT01NQU5EUyB9ID0gcmVxdWlyZSgnLi9saWIvY29uc3RhbnRzJykKY29uc3QgeyBoYXNoLCBjcmVhdGVLZXlQYWlyIH0gPSByZXF1aXJlKCcuL2xpYi9jcnlwdG8nKQpjb25zdCB7IGRlY29kZSB9ID0gcmVxdWlyZSgnaHlwZXJjb3JlLWlkLWVuY29kaW5nJykKY29uc3QgUmF3U3RyZWFtU2V0ID0gcmVxdWlyZSgnLi9saWIvcmF3LXN0cmVhbS1zZXQnKQpjb25zdCBDb25uZWN0aW9uUG9vbCA9IHJlcXVpcmUoJy4vbGliL2Nvbm5lY3Rpb24tcG9vbCcpCmNvbnN0IHsgU1RSRUFNX05PVF9DT05ORUNURUQgfSA9IHJlcXVpcmUoJy4vbGliL2Vycm9ycycpCgpjbGFzcyBIeXBlckRIVCBleHRlbmRzIERIVCB7CiAgY29uc3RydWN0b3Iob3B0cyA9IHt9KSB7CiAgICBjb25zdCBwb3J0ID0gb3B0cy5wb3J0IHx8IDQ5NzM3CiAgICBjb25zdCBib290c3RyYXAgPSBvcHRzLmJvb3RzdHJhcCB8fCBCT09UU1RSQVBfTk9ERVMKICAgIGNvbnN0IG5vZGVzID0gb3B0cy5ub2RlcyB8fCBLTk9XTl9OT0RFUwoKICAgIHN1cGVyKHsgLi4ub3B0cywgcG9ydCwgYm9vdHN0cmFwLCBub2RlcywgZmlsdGVyTm9kZSB9KQoKICAgIGNvbnN0IHsgcm91dGVyLCByZWxheUFkZHJlc3NlcywgcGVyc2lzdGVudCB9ID0gZGVmYXVsdENhY2hlT3B0cyhvcHRzKQoKICAgIHRoaXMuZGVmYXVsdEtleVBhaXIgPSBvcHRzLmtleVBhaXIgfHwgY3JlYXRlS2V5UGFpcihvcHRzLnNlZWQpCiAgICB0aGlzLmxpc3RlbmluZyA9IG5ldyBTZXQoKQogICAgdGhpcy5jb25uZWN0aW9uS2VlcEFsaXZlID0KICAgICAgb3B0cy5jb25uZWN0aW9uS2VlcEFsaXZlID09PSBmYWxzZSA/IDAgOiBvcHRzLmNvbm5lY3Rpb25LZWVwQWxpdmUgfHwgNTAwMAoKICAgIC8vIHN0YXRzIGlzIGluaGVyaXRlZCBmcm9tIGRodC1ycGMgc28gZndkIHRoZSBvbmVzIGZyb20gdGhlcmUKICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgIHB1bmNoZXM6IHsgY29uc2lzdGVudDogMCwgcmFuZG9tOiAwLCBvcGVuOiAwIH0sCiAgICAgIHJlbGF5aW5nOiB7IGF0dGVtcHRzOiAwLCBzdWNjZXNzZXM6IDAsIGFib3J0czogMCB9LAogICAgICAuLi50aGlzLnN0YXRzCiAgICB9CiAgICB0aGlzLnJhd1N0cmVhbXMgPSBuZXcgUmF3U3RyZWFtU2V0KHRoaXMpCgogICAgdGhpcy5fcm91dGVyID0gbmV3IFJvdXRlcih0aGlzLCByb3V0ZXIpCiAgICB0aGlzLl9zb2NrZXRQb29sID0gbmV3IFNvY2tldFBvb2wodGhpcywgb3B0cy5ob3N0IHx8ICcwLjAuMC4wJykKICAgIHRoaXMuX3BlcnNpc3RlbnQgPSBudWxsCiAgICB0aGlzLl92YWxpZGF0ZWRMb2NhbEFkZHJlc3NlcyA9IG5ldyBNYXAoKQogICAgdGhpcy5fcmVsYXlBZGRyZXNzZXNDYWNoZSA9IG5ldyBDYWNoZShyZWxheUFkZHJlc3NlcykKCiAgICB0aGlzLl9kZWZlclJhbmRvbVB1bmNoID0gISFvcHRzLmRlZmVyUmFuZG9tUHVuY2gKICAgIHRoaXMuX2xhc3RSYW5kb21QdW5jaCA9IHRoaXMuX2RlZmVyUmFuZG9tUHVuY2ggPyBEYXRlLm5vdygpIDogMAogICAgdGhpcy5fY29ubmVjdGFibGUgPSB0cnVlCiAgICB0aGlzLl9yYW5kb21QdW5jaEludGVydmFsID0gb3B0cy5yYW5kb21QdW5jaEludGVydmFsIHx8IDIwMDAwIC8vIG1pbiAyMHMgYmV0d2VlbiByYW5kb20gcHVuY2hlcy4uLgogICAgdGhpcy5fcmFuZG9tUHVuY2hlcyA9IDAKICAgIHRoaXMuX3JhbmRvbVB1bmNoTGltaXQgPSAxIC8vIHNldCB0byBvbmUgZm9yIGV4dHJhIHNhZmV0eSBmb3Igbm93CgogICAgdGhpcy5vbmNlKCdwZXJzaXN0ZW50JywgKCkgPT4gewogICAgICB0aGlzLl9wZXJzaXN0ZW50ID0gbmV3IFBlcnNpc3RlbnQodGhpcywgcGVyc2lzdGVudCkKICAgIH0pCgogICAgdGhpcy5vbignbmV0d29yay1jaGFuZ2UnLCAoKSA9PiB7CiAgICAgIGZvciAoY29uc3Qgc2VydmVyIG9mIHRoaXMubGlzdGVuaW5nKSBzZXJ2ZXIucmVmcmVzaCgpCiAgICB9KQoKICAgIHRoaXMub24oJ25ldHdvcmstdXBkYXRlJywgKCkgPT4gewogICAgICBpZiAoIXRoaXMub25saW5lKSByZXR1cm4KICAgICAgZm9yIChjb25zdCBzZXJ2ZXIgb2YgdGhpcy5saXN0ZW5pbmcpIHNlcnZlci5ub3RpZnlPbmxpbmUoKQogICAgfSkKICB9CgogIGNvbm5lY3QocmVtb3RlUHVibGljS2V5LCBvcHRzKSB7CiAgICByZXR1cm4gY29ubmVjdCh0aGlzLCBkZWNvZGUocmVtb3RlUHVibGljS2V5KSwgb3B0cykKICB9CgogIGNyZWF0ZVNlcnZlcihvcHRzLCBvbmNvbm5lY3Rpb24pIHsKICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHRoaXMuY3JlYXRlU2VydmVyKHt9LCBvcHRzKQogICAgaWYgKG9wdHMgJiYgb3B0cy5vbmNvbm5lY3Rpb24pIG9uY29ubmVjdGlvbiA9IG9wdHMub25jb25uZWN0aW9uCiAgICBjb25zdCBzID0gbmV3IFNlcnZlcih0aGlzLCBvcHRzKQogICAgaWYgKG9uY29ubmVjdGlvbikgcy5vbignY29ubmVjdGlvbicsIG9uY29ubmVjdGlvbikKICAgIHJldHVybiBzCiAgfQoKICBwb29sKCkgewogICAgcmV0dXJuIG5ldyBDb25uZWN0aW9uUG9vbCh0aGlzKQogIH0KCiAgYXN5bmMgcmVzdW1lKHsgbG9nID0gbm9vcCB9ID0ge30pIHsKICAgIGlmICh0aGlzLl9kZWZlclJhbmRvbVB1bmNoKSB0aGlzLl9sYXN0UmFuZG9tUHVuY2ggPSBEYXRlLm5vdygpCiAgICBhd2FpdCBzdXBlci5yZXN1bWUoeyBsb2cgfSkKICAgIGNvbnN0IHJlc3VtaW5nID0gW10KICAgIGZvciAoY29uc3Qgc2VydmVyIG9mIHRoaXMubGlzdGVuaW5nKSByZXN1bWluZy5wdXNoKHNlcnZlci5yZXN1bWUoKSkKICAgIGxvZygnUmVzdW1pbmcgaHlwZXJkaHQgc2VydmVycycpCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQocmVzdW1pbmcpCiAgICBsb2coJ0RvbmUsIGh5cGVyZGh0IGZ1bGx5IHJlc3VtZWQnKQogIH0KCiAgYXN5bmMgc3VzcGVuZCh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICB0aGlzLl9jb25uZWN0YWJsZSA9IGZhbHNlIC8vIGp1c3Qgc28gbm90aGluZyBnZXRzIGNvbm5lY3RlZCBkdXJpbmcgc3VzcGVuc2lvbgogICAgY29uc3Qgc3VzcGVuZGluZyA9IFtdCiAgICBmb3IgKGNvbnN0IHNlcnZlciBvZiB0aGlzLmxpc3RlbmluZykgc3VzcGVuZGluZy5wdXNoKHNlcnZlci5zdXNwZW5kKCkpCiAgICBsb2coJ1N1c3BlbmRpbmcgYWxsIGh5cGVyZGh0IHNlcnZlcnMnKQogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHN1c3BlbmRpbmcpCiAgICBsb2coJ0RvbmUsIGNsZWFyaW5nIGFsbCByYXcgc3RyZWFtcycpCiAgICBhd2FpdCB0aGlzLnJhd1N0cmVhbXMuY2xlYXIoKQogICAgbG9nKCdEb25lLCBzdXNwZW5kaW5nIGRodC1ycGMnKQogICAgYXdhaXQgc3VwZXIuc3VzcGVuZCh7IGxvZyB9KQogICAgbG9nKCdEb25lLCBjbGVhcmluZyByYXcgc3RyZWFtcyBhZ2FpbicpCiAgICBhd2FpdCB0aGlzLnJhd1N0cmVhbXMuY2xlYXIoKQogICAgbG9nKCdEb25lLCBoeXBlcmRodCBmdWxseSBzdXNwZW5kZWQnKQogICAgdGhpcy5fY29ubmVjdGFibGUgPSB0cnVlCiAgfQoKICBhc3luYyBkZXN0cm95KHsgZm9yY2UgPSBmYWxzZSB9ID0ge30pIHsKICAgIGlmICghZm9yY2UpIHsKICAgICAgY29uc3QgY2xvc2luZyA9IFtdCiAgICAgIGZvciAoY29uc3Qgc2VydmVyIG9mIHRoaXMubGlzdGVuaW5nKSBjbG9zaW5nLnB1c2goc2VydmVyLmNsb3NlKCkpCiAgICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChjbG9zaW5nKQogICAgfQogICAgdGhpcy5fcm91dGVyLmRlc3Ryb3koKQogICAgaWYgKHRoaXMuX3BlcnNpc3RlbnQpIHRoaXMuX3BlcnNpc3RlbnQuZGVzdHJveSgpCiAgICBhd2FpdCB0aGlzLnJhd1N0cmVhbXMuY2xlYXIoKQogICAgYXdhaXQgdGhpcy5fc29ja2V0UG9vbC5kZXN0cm95KCkKICAgIGF3YWl0IHN1cGVyLmRlc3Ryb3koKQogIH0KCiAgYXN5bmMgdmFsaWRhdGVMb2NhbEFkZHJlc3NlcyhhZGRyZXNzZXMpIHsKICAgIGNvbnN0IGxpc3QgPSBbXQogICAgY29uc3Qgc29ja3MgPSBbXQogICAgY29uc3Qgd2FpdGluZyA9IFtdCgogICAgZm9yIChjb25zdCBhZGRyIG9mIGFkZHJlc3NlcykgewogICAgICBjb25zdCB7IGhvc3QgfSA9IGFkZHIKCiAgICAgIGlmICh0aGlzLl92YWxpZGF0ZWRMb2NhbEFkZHJlc3Nlcy5oYXMoaG9zdCkpIHsKICAgICAgICBpZiAoYXdhaXQgdGhpcy5fdmFsaWRhdGVkTG9jYWxBZGRyZXNzZXMuZ2V0KGhvc3QpKSB7CiAgICAgICAgICBsaXN0LnB1c2goYWRkcikKICAgICAgICB9CiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgY29uc3Qgc29jayA9IHRoaXMudWR4LmNyZWF0ZVNvY2tldCgpCiAgICAgIHRyeSB7CiAgICAgICAgc29jay5iaW5kKDAsIGhvc3QpCiAgICAgIH0gY2F0Y2ggewogICAgICAgIHRoaXMuX3ZhbGlkYXRlZExvY2FsQWRkcmVzc2VzLnNldChob3N0LCBQcm9taXNlLnJlc29sdmUoZmFsc2UpKQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIHNvY2tzLnB1c2goc29jaykKCiAgICAgIC8vIHNlbWkgdGVycmlibGUgaGV1cmlzdGljIHVudGlsIHdlIHByb3BlciBmaXggbG9jYWwgY29ubmVjdGlvbnMgYnkgcmFjaW5nIHRoZW0gdG8gdGhlIHJlbW90ZS4uLgogICAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBzb2NrLm9uKCdtZXNzYWdlJywgKCkgPT4gcmVzb2x2ZSh0cnVlKSkKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHJlc29sdmUoZmFsc2UpLCA1MDApCiAgICAgICAgc29jay50cnlTZW5kKGI0YS5hbGxvYygxKSwgc29jay5hZGRyZXNzKCkucG9ydCwgYWRkci5ob3N0KQogICAgICB9KQoKICAgICAgdGhpcy5fdmFsaWRhdGVkTG9jYWxBZGRyZXNzZXMuc2V0KGhvc3QsIHByb21pc2UpCiAgICAgIHdhaXRpbmcucHVzaChhZGRyKQogICAgfQoKICAgIGZvciAoY29uc3QgYWRkciBvZiB3YWl0aW5nKSB7CiAgICAgIGNvbnN0IHsgaG9zdCB9ID0gYWRkcgogICAgICBpZiAodGhpcy5fdmFsaWRhdGVkTG9jYWxBZGRyZXNzZXMuaGFzKGhvc3QpKSB7CiAgICAgICAgaWYgKGF3YWl0IHRoaXMuX3ZhbGlkYXRlZExvY2FsQWRkcmVzc2VzLmdldChob3N0KSkgewogICAgICAgICAgbGlzdC5wdXNoKGFkZHIpCiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KICAgIH0KCiAgICBmb3IgKGNvbnN0IHNvY2sgb2Ygc29ja3MpIGF3YWl0IHNvY2suY2xvc2UoKQoKICAgIHJldHVybiBsaXN0CiAgfQoKICBmaW5kUGVlcihwdWJsaWNLZXksIG9wdHMgPSB7fSkgewogICAgY29uc3QgdGFyZ2V0ID0gb3B0cy5oYXNoID09PSBmYWxzZSA/IHB1YmxpY0tleSA6IGhhc2gocHVibGljS2V5KQogICAgb3B0cyA9IHsgLi4ub3B0cywgbWFwOiBtYXBGaW5kUGVlciB9CiAgICByZXR1cm4gdGhpcy5xdWVyeSh7IHRhcmdldCwgY29tbWFuZDogQ09NTUFORFMuRklORF9QRUVSLCB2YWx1ZTogbnVsbCB9LCBvcHRzKQogIH0KCiAgbG9va3VwKHRhcmdldCwgb3B0cyA9IHt9KSB7CiAgICBvcHRzID0geyAuLi5vcHRzLCBtYXA6IG1hcExvb2t1cCB9CiAgICByZXR1cm4gdGhpcy5xdWVyeSh7IHRhcmdldCwgY29tbWFuZDogQ09NTUFORFMuTE9PS1VQLCB2YWx1ZTogbnVsbCB9LCBvcHRzKQogIH0KCiAgbG9va3VwQW5kVW5hbm5vdW5jZSh0YXJnZXQsIGtleVBhaXIsIG9wdHMgPSB7fSkgewogICAgY29uc3QgdW5hbm5vdW5jZXMgPSBbXQogICAgY29uc3QgZGh0ID0gdGhpcwogICAgY29uc3QgdXNlckNvbW1pdCA9IG9wdHMuY29tbWl0IHx8IG5vb3AKICAgIGNvbnN0IHNpZ25VbmFubm91bmNlID0gb3B0cy5zaWduVW5hbm5vdW5jZSB8fCBQZXJzaXN0ZW50LnNpZ25VbmFubm91bmNlCgogICAgaWYgKHRoaXMuX3BlcnNpc3RlbnQgIT09IG51bGwpIHsKICAgICAgLy8gdW5saW5rIHNlbGYKICAgICAgdGhpcy5fcGVyc2lzdGVudC51bmFubm91bmNlKHRhcmdldCwga2V5UGFpci5wdWJsaWNLZXkpCiAgICB9CgogICAgb3B0cyA9IHsgLi4ub3B0cywgbWFwLCBjb21taXQgfQogICAgcmV0dXJuIHRoaXMucXVlcnkoeyB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLkxPT0tVUCwgdmFsdWU6IG51bGwgfSwgb3B0cykKCiAgICBhc3luYyBmdW5jdGlvbiBjb21taXQocmVwbHksIGRodCwgcXVlcnkpIHsKICAgICAgYXdhaXQgUHJvbWlzZS5hbGwodW5hbm5vdW5jZXMpIC8vIGNhbiBuZXZlciBmYWlsLCBjYXVnaHQgYmVsb3cKICAgICAgcmV0dXJuIHVzZXJDb21taXQocmVwbHksIGRodCwgcXVlcnkpCiAgICB9CgogICAgZnVuY3Rpb24gbWFwKHJlcGx5KSB7CiAgICAgIGNvbnN0IGRhdGEgPSBtYXBMb29rdXAocmVwbHkpCgogICAgICBpZiAoIWRhdGEgfHwgIWRhdGEudG9rZW4pIHJldHVybiBkYXRhCgogICAgICBsZXQgZm91bmQgPSBkYXRhLnBlZXJzLmxlbmd0aCA+PSAyMAogICAgICBmb3IgKGxldCBpID0gMDsgIWZvdW5kICYmIGkgPCBkYXRhLnBlZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm91bmQgPSBiNGEuZXF1YWxzKGRhdGEucGVlcnNbaV0ucHVibGljS2V5LCBrZXlQYWlyLnB1YmxpY0tleSkKICAgICAgfQoKICAgICAgaWYgKCFmb3VuZCkgcmV0dXJuIGRhdGEKCiAgICAgIGlmICghZGF0YS5mcm9tLmlkKSByZXR1cm4gZGF0YQoKICAgICAgdW5hbm5vdW5jZXMucHVzaCgKICAgICAgICBkaHQKICAgICAgICAgIC5fcmVxdWVzdFVuYW5ub3VuY2Uoa2V5UGFpciwgZGh0LCB0YXJnZXQsIGRhdGEudG9rZW4sIGRhdGEuZnJvbSwgc2lnblVuYW5ub3VuY2UpCiAgICAgICAgICAuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgICAgICkKCiAgICAgIHJldHVybiBkYXRhCiAgICB9CiAgfQoKICB1bmFubm91bmNlKHRhcmdldCwga2V5UGFpciwgb3B0cyA9IHt9KSB7CiAgICByZXR1cm4gdGhpcy5sb29rdXBBbmRVbmFubm91bmNlKHRhcmdldCwga2V5UGFpciwgb3B0cykuZmluaXNoZWQoKQogIH0KCiAgYW5ub3VuY2UodGFyZ2V0LCBrZXlQYWlyLCByZWxheUFkZHJlc3Nlcywgb3B0cyA9IHt9KSB7CiAgICBjb25zdCBzaWduQW5ub3VuY2UgPSBvcHRzLnNpZ25Bbm5vdW5jZSB8fCBQZXJzaXN0ZW50LnNpZ25Bbm5vdW5jZQogICAgY29uc3QgYnVtcCA9IG9wdHMuYnVtcCB8fCAwCgogICAgb3B0cyA9IHsgLi4ub3B0cywgY29tbWl0IH0KCiAgICByZXR1cm4gb3B0cy5jbGVhciA/IHRoaXMubG9va3VwQW5kVW5hbm5vdW5jZSh0YXJnZXQsIGtleVBhaXIsIG9wdHMpIDogdGhpcy5sb29rdXAodGFyZ2V0LCBvcHRzKQoKICAgIGZ1bmN0aW9uIGNvbW1pdChyZXBseSwgZGh0KSB7CiAgICAgIHJldHVybiBkaHQuX3JlcXVlc3RBbm5vdW5jZSgKICAgICAgICBrZXlQYWlyLAogICAgICAgIGRodCwKICAgICAgICB0YXJnZXQsCiAgICAgICAgcmVwbHkudG9rZW4sCiAgICAgICAgcmVwbHkuZnJvbSwKICAgICAgICByZWxheUFkZHJlc3NlcywKICAgICAgICBzaWduQW5ub3VuY2UsCiAgICAgICAgYnVtcAogICAgICApCiAgICB9CiAgfQoKICBhc3luYyBpbW11dGFibGVHZXQodGFyZ2V0LCBvcHRzID0ge30pIHsKICAgIG9wdHMgPSB7IC4uLm9wdHMsIG1hcDogbWFwSW1tdXRhYmxlIH0KCiAgICBjb25zdCBxdWVyeSA9IHRoaXMucXVlcnkoeyB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLklNTVVUQUJMRV9HRVQsIHZhbHVlOiBudWxsIH0sIG9wdHMpCiAgICBjb25zdCBjaGVjayA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKCiAgICBmb3IgYXdhaXQgKGNvbnN0IG5vZGUgb2YgcXVlcnkpIHsKICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gbm9kZQogICAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGNoZWNrLCB2YWx1ZSkKICAgICAgaWYgKGI0YS5lcXVhbHMoY2hlY2ssIHRhcmdldCkpIHJldHVybiBub2RlCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIGFzeW5jIGltbXV0YWJsZVB1dCh2YWx1ZSwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB0YXJnZXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKHRhcmdldCwgdmFsdWUpCgogICAgb3B0cyA9IHsKICAgICAgLi4ub3B0cywKICAgICAgbWFwOiBtYXBJbW11dGFibGUsCiAgICAgIGNvbW1pdChyZXBseSwgZGh0KSB7CiAgICAgICAgcmV0dXJuIGRodC5yZXF1ZXN0KAogICAgICAgICAgeyB0b2tlbjogcmVwbHkudG9rZW4sIHRhcmdldCwgY29tbWFuZDogQ09NTUFORFMuSU1NVVRBQkxFX1BVVCwgdmFsdWUgfSwKICAgICAgICAgIHJlcGx5LmZyb20KICAgICAgICApCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBxdWVyeSA9IHRoaXMucXVlcnkoeyB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLklNTVVUQUJMRV9HRVQsIHZhbHVlOiBudWxsIH0sIG9wdHMpCiAgICBhd2FpdCBxdWVyeS5maW5pc2hlZCgpCgogICAgcmV0dXJuIHsgaGFzaDogdGFyZ2V0LCBjbG9zZXN0Tm9kZXM6IHF1ZXJ5LmNsb3Nlc3ROb2RlcyB9CiAgfQoKICBhc3luYyBtdXRhYmxlR2V0KHB1YmxpY0tleSwgb3B0cyA9IHt9KSB7CiAgICBsZXQgcmVmcmVzaCA9IG9wdHMucmVmcmVzaCB8fCBudWxsCiAgICBsZXQgc2lnbmVkID0gbnVsbAogICAgbGV0IHJlc3VsdCA9IG51bGwKCiAgICBvcHRzID0geyAuLi5vcHRzLCBtYXA6IG1hcE11dGFibGUsIGNvbW1pdDogcmVmcmVzaCA/IGNvbW1pdCA6IG51bGwgfQoKICAgIGNvbnN0IHRhcmdldCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2godGFyZ2V0LCBwdWJsaWNLZXkpCgogICAgY29uc3QgdXNlclNlcSA9IG9wdHMuc2VxIHx8IDAKICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5xdWVyeSgKICAgICAgeyB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLk1VVEFCTEVfR0VULCB2YWx1ZTogYy5lbmNvZGUoYy51aW50LCB1c2VyU2VxKSB9LAogICAgICBvcHRzCiAgICApCiAgICBjb25zdCBsYXRlc3QgPSBvcHRzLmxhdGVzdCAhPT0gZmFsc2UKCiAgICBmb3IgYXdhaXQgKGNvbnN0IG5vZGUgb2YgcXVlcnkpIHsKICAgICAgaWYgKHJlc3VsdCAmJiBub2RlLnNlcSA8PSByZXN1bHQuc2VxKSBjb250aW51ZQogICAgICBpZiAoCiAgICAgICAgbm9kZS5zZXEgPCB1c2VyU2VxIHx8CiAgICAgICAgIVBlcnNpc3RlbnQudmVyaWZ5TXV0YWJsZShub2RlLnNpZ25hdHVyZSwgbm9kZS5zZXEsIG5vZGUudmFsdWUsIHB1YmxpY0tleSkKICAgICAgKQogICAgICAgIGNvbnRpbnVlCiAgICAgIGlmICghbGF0ZXN0KSByZXR1cm4gbm9kZQogICAgICBpZiAoIXJlc3VsdCB8fCBub2RlLnNlcSA+IHJlc3VsdC5zZXEpIHJlc3VsdCA9IG5vZGUKICAgIH0KCiAgICByZXR1cm4gcmVzdWx0CgogICAgZnVuY3Rpb24gY29tbWl0KHJlcGx5LCBkaHQpIHsKICAgICAgaWYgKCFzaWduZWQgJiYgcmVzdWx0ICYmIHJlZnJlc2gpIHsKICAgICAgICBpZiAocmVmcmVzaChyZXN1bHQpKSB7CiAgICAgICAgICBzaWduZWQgPSBjLmVuY29kZShtLm11dGFibGVQdXRSZXF1ZXN0LCB7CiAgICAgICAgICAgIHB1YmxpY0tleSwKICAgICAgICAgICAgc2VxOiByZXN1bHQuc2VxLAogICAgICAgICAgICB2YWx1ZTogcmVzdWx0LnZhbHVlLAogICAgICAgICAgICBzaWduYXR1cmU6IHJlc3VsdC5zaWduYXR1cmUKICAgICAgICAgIH0pCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlZnJlc2ggPSBudWxsCiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gc2lnbmVkCiAgICAgICAgPyBkaHQucmVxdWVzdCgKICAgICAgICAgICAgeyB0b2tlbjogcmVwbHkudG9rZW4sIHRhcmdldCwgY29tbWFuZDogQ09NTUFORFMuTVVUQUJMRV9QVVQsIHZhbHVlOiBzaWduZWQgfSwKICAgICAgICAgICAgcmVwbHkuZnJvbQogICAgICAgICAgKQogICAgICAgIDogUHJvbWlzZS5yZXNvbHZlKG51bGwpCiAgICB9CiAgfQoKICBhc3luYyBtdXRhYmxlUHV0KGtleVBhaXIsIHZhbHVlLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHNpZ25NdXRhYmxlID0gb3B0cy5zaWduTXV0YWJsZSB8fCBQZXJzaXN0ZW50LnNpZ25NdXRhYmxlCgogICAgY29uc3QgdGFyZ2V0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaCh0YXJnZXQsIGtleVBhaXIucHVibGljS2V5KQoKICAgIGNvbnN0IHNlcSA9IG9wdHMuc2VxIHx8IDAKICAgIGNvbnN0IHNpZ25hdHVyZSA9IGF3YWl0IHNpZ25NdXRhYmxlKHNlcSwgdmFsdWUsIGtleVBhaXIpCgogICAgY29uc3Qgc2lnbmVkID0gYy5lbmNvZGUobS5tdXRhYmxlUHV0UmVxdWVzdCwgewogICAgICBwdWJsaWNLZXk6IGtleVBhaXIucHVibGljS2V5LAogICAgICBzZXEsCiAgICAgIHZhbHVlLAogICAgICBzaWduYXR1cmUKICAgIH0pCgogICAgb3B0cyA9IHsKICAgICAgLi4ub3B0cywKICAgICAgbWFwOiBtYXBNdXRhYmxlLAogICAgICBjb21taXQocmVwbHksIGRodCkgewogICAgICAgIHJldHVybiBkaHQucmVxdWVzdCgKICAgICAgICAgIHsgdG9rZW46IHJlcGx5LnRva2VuLCB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLk1VVEFCTEVfUFVULCB2YWx1ZTogc2lnbmVkIH0sCiAgICAgICAgICByZXBseS5mcm9tCiAgICAgICAgKQogICAgICB9CiAgICB9CgogICAgLy8gdXNlIHNlcSA9IDAsIGZvciB0aGUgcXVlcnkgcGFydCBoZXJlLCBhcyB3ZSBkb24ndCBjYXJlIGFib3V0IHRoZSBhY3R1YWwgdmFsdWVzCiAgICBjb25zdCBxdWVyeSA9IHRoaXMucXVlcnkoCiAgICAgIHsgdGFyZ2V0LCBjb21tYW5kOiBDT01NQU5EUy5NVVRBQkxFX0dFVCwgdmFsdWU6IGMuZW5jb2RlKGMudWludCwgMCkgfSwKICAgICAgb3B0cwogICAgKQogICAgYXdhaXQgcXVlcnkuZmluaXNoZWQoKQoKICAgIHJldHVybiB7IHB1YmxpY0tleToga2V5UGFpci5wdWJsaWNLZXksIGNsb3Nlc3ROb2RlczogcXVlcnkuY2xvc2VzdE5vZGVzLCBzZXEsIHNpZ25hdHVyZSB9CiAgfQoKICBvbnJlcXVlc3QocmVxKSB7CiAgICBzd2l0Y2ggKHJlcS5jb21tYW5kKSB7CiAgICAgIGNhc2UgQ09NTUFORFMuUEVFUl9IQU5EU0hBS0U6IHsKICAgICAgICB0aGlzLl9yb3V0ZXIub25wZWVyaGFuZHNoYWtlKHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIGNhc2UgQ09NTUFORFMuUEVFUl9IT0xFUFVOQ0g6IHsKICAgICAgICB0aGlzLl9yb3V0ZXIub25wZWVyaG9sZXB1bmNoKHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMuX3BlcnNpc3RlbnQgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIHN3aXRjaCAocmVxLmNvbW1hbmQpIHsKICAgICAgY2FzZSBDT01NQU5EUy5GSU5EX1BFRVI6IHsKICAgICAgICB0aGlzLl9wZXJzaXN0ZW50Lm9uZmluZHBlZXIocmVxKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgICAgY2FzZSBDT01NQU5EUy5MT09LVVA6IHsKICAgICAgICB0aGlzLl9wZXJzaXN0ZW50Lm9ubG9va3VwKHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIGNhc2UgQ09NTUFORFMuQU5OT1VOQ0U6IHsKICAgICAgICB0aGlzLl9wZXJzaXN0ZW50Lm9uYW5ub3VuY2UocmVxKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgICAgY2FzZSBDT01NQU5EUy5VTkFOTk9VTkNFOiB7CiAgICAgICAgdGhpcy5fcGVyc2lzdGVudC5vbnVuYW5ub3VuY2UocmVxKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgICAgY2FzZSBDT01NQU5EUy5NVVRBQkxFX1BVVDogewogICAgICAgIHRoaXMuX3BlcnNpc3RlbnQub25tdXRhYmxlcHV0KHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIGNhc2UgQ09NTUFORFMuTVVUQUJMRV9HRVQ6IHsKICAgICAgICB0aGlzLl9wZXJzaXN0ZW50Lm9ubXV0YWJsZWdldChyZXEpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgICBjYXNlIENPTU1BTkRTLklNTVVUQUJMRV9QVVQ6IHsKICAgICAgICB0aGlzLl9wZXJzaXN0ZW50Lm9uaW1tdXRhYmxlcHV0KHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIGNhc2UgQ09NTUFORFMuSU1NVVRBQkxFX0dFVDogewogICAgICAgIHRoaXMuX3BlcnNpc3RlbnQub25pbW11dGFibGVnZXQocmVxKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIHN0YXRpYyBrZXlQYWlyKHNlZWQpIHsKICAgIHJldHVybiBjcmVhdGVLZXlQYWlyKHNlZWQpCiAgfQoKICBzdGF0aWMgaGFzaChkYXRhKSB7CiAgICByZXR1cm4gaGFzaChkYXRhKQogIH0KCiAgc3RhdGljIGNvbm5lY3RSYXdTdHJlYW0oZW5jcnlwdGVkU3RyZWFtLCByYXdTdHJlYW0sIHJlbW90ZUlkKSB7CiAgICBjb25zdCBzdHJlYW0gPSBlbmNyeXB0ZWRTdHJlYW0ucmF3U3RyZWFtCgogICAgaWYgKCFzdHJlYW0uY29ubmVjdGVkKSB0aHJvdyBTVFJFQU1fTk9UX0NPTk5FQ1RFRCgpCgogICAgcmF3U3RyZWFtLmNvbm5lY3Qoc3RyZWFtLnNvY2tldCwgcmVtb3RlSWQsIHN0cmVhbS5yZW1vdGVQb3J0LCBzdHJlYW0ucmVtb3RlSG9zdCkKICB9CgogIGNyZWF0ZVJhd1N0cmVhbShvcHRzKSB7CiAgICByZXR1cm4gdGhpcy5yYXdTdHJlYW1zLmFkZChvcHRzKQogIH0KCiAgYXN5bmMgX3JlcXVlc3RBbm5vdW5jZShrZXlQYWlyLCBkaHQsIHRhcmdldCwgdG9rZW4sIGZyb20sIHJlbGF5QWRkcmVzc2VzLCBzaWduLCBidW1wKSB7CiAgICBjb25zdCBhbm4gPSB7CiAgICAgIHBlZXI6IHsKICAgICAgICBwdWJsaWNLZXk6IGtleVBhaXIucHVibGljS2V5LAogICAgICAgIHJlbGF5QWRkcmVzc2VzOiByZWxheUFkZHJlc3NlcyB8fCBbXQogICAgICB9LAogICAgICByZWZyZXNoOiBudWxsLAogICAgICBzaWduYXR1cmU6IG51bGwsCiAgICAgIGJ1bXAKICAgIH0KCiAgICBhbm4uc2lnbmF0dXJlID0gYXdhaXQgc2lnbih0YXJnZXQsIHRva2VuLCBmcm9tLmlkLCBhbm4sIGtleVBhaXIpCgogICAgY29uc3QgdmFsdWUgPSBjLmVuY29kZShtLmFubm91bmNlLCBhbm4pCgogICAgcmV0dXJuIGRodC5yZXF1ZXN0KAogICAgICB7CiAgICAgICAgdG9rZW4sCiAgICAgICAgdGFyZ2V0LAogICAgICAgIGNvbW1hbmQ6IENPTU1BTkRTLkFOTk9VTkNFLAogICAgICAgIHZhbHVlCiAgICAgIH0sCiAgICAgIGZyb20KICAgICkKICB9CgogIGFzeW5jIF9yZXF1ZXN0VW5hbm5vdW5jZShrZXlQYWlyLCBkaHQsIHRhcmdldCwgdG9rZW4sIGZyb20sIHNpZ24pIHsKICAgIGNvbnN0IHVuYW5uID0gewogICAgICBwZWVyOiB7CiAgICAgICAgcHVibGljS2V5OiBrZXlQYWlyLnB1YmxpY0tleSwKICAgICAgICByZWxheUFkZHJlc3NlczogW10KICAgICAgfSwKICAgICAgc2lnbmF0dXJlOiBudWxsCiAgICB9CgogICAgdW5hbm4uc2lnbmF0dXJlID0gYXdhaXQgc2lnbih0YXJnZXQsIHRva2VuLCBmcm9tLmlkLCB1bmFubiwga2V5UGFpcikKCiAgICBjb25zdCB2YWx1ZSA9IGMuZW5jb2RlKG0uYW5ub3VuY2UsIHVuYW5uKQoKICAgIHJldHVybiBkaHQucmVxdWVzdCgKICAgICAgewogICAgICAgIHRva2VuLAogICAgICAgIHRhcmdldCwKICAgICAgICBjb21tYW5kOiBDT01NQU5EUy5VTkFOTk9VTkNFLAogICAgICAgIHZhbHVlCiAgICAgIH0sCiAgICAgIGZyb20KICAgICkKICB9Cn0KCkh5cGVyREhULkJPT1RTVFJBUCA9IEJPT1RTVFJBUF9OT0RFUwpIeXBlckRIVC5GSVJFV0FMTCA9IEZJUkVXQUxMCgptb2R1bGUuZXhwb3J0cyA9IEh5cGVyREhUCgpmdW5jdGlvbiBtYXBMb29rdXAobm9kZSkgewogIGlmICghbm9kZS52YWx1ZSkgcmV0dXJuIG51bGwKCiAgY29uc3QgbCA9IGMuZGVjb2RlKG0ubG9va3VwUmF3UmVwbHksIG5vZGUudmFsdWUpCgogIHRyeSB7CiAgICByZXR1cm4gewogICAgICB0b2tlbjogbm9kZS50b2tlbiwKICAgICAgZnJvbTogbm9kZS5mcm9tLAogICAgICB0bzogbm9kZS50bywKICAgICAgcGVlcnM6IGwucGVlcnMsCiAgICAgIGJ1bXA6IGwuYnVtcAogICAgfQogIH0gY2F0Y2ggewogICAgcmV0dXJuIG51bGwKICB9Cn0KCmZ1bmN0aW9uIG1hcEZpbmRQZWVyKG5vZGUpIHsKICBpZiAoIW5vZGUudmFsdWUpIHJldHVybiBudWxsCgogIHRyeSB7CiAgICByZXR1cm4gewogICAgICB0b2tlbjogbm9kZS50b2tlbiwKICAgICAgZnJvbTogbm9kZS5mcm9tLAogICAgICB0bzogbm9kZS50bywKICAgICAgcGVlcjogYy5kZWNvZGUobS5wZWVyLCBub2RlLnZhbHVlKQogICAgfQogIH0gY2F0Y2ggewogICAgcmV0dXJuIG51bGwKICB9Cn0KCmZ1bmN0aW9uIG1hcEltbXV0YWJsZShub2RlKSB7CiAgaWYgKCFub2RlLnZhbHVlKSByZXR1cm4gbnVsbAoKICByZXR1cm4gewogICAgdG9rZW46IG5vZGUudG9rZW4sCiAgICBmcm9tOiBub2RlLmZyb20sCiAgICB0bzogbm9kZS50bywKICAgIHZhbHVlOiBub2RlLnZhbHVlCiAgfQp9CgpmdW5jdGlvbiBtYXBNdXRhYmxlKG5vZGUpIHsKICBpZiAoIW5vZGUudmFsdWUpIHJldHVybiBudWxsCgogIHRyeSB7CiAgICBjb25zdCB7IHNlcSwgdmFsdWUsIHNpZ25hdHVyZSB9ID0gYy5kZWNvZGUobS5tdXRhYmxlR2V0UmVzcG9uc2UsIG5vZGUudmFsdWUpCgogICAgcmV0dXJuIHsKICAgICAgdG9rZW46IG5vZGUudG9rZW4sCiAgICAgIGZyb206IG5vZGUuZnJvbSwKICAgICAgdG86IG5vZGUudG8sCiAgICAgIHNlcSwKICAgICAgdmFsdWUsCiAgICAgIHNpZ25hdHVyZQogICAgfQogIH0gY2F0Y2ggewogICAgcmV0dXJuIG51bGwKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gZmlsdGVyTm9kZShub2RlKSB7CiAgLy8gYWx3YXlzIHNraXAgdGhlc2UgdGVzdG5ldCBub2RlcyB0aGF0IGdvdCBtaXhlZCBpbiBieSBhY2NpZGVudCwgdW50aWwgdGhleSBnZXQgdXBkYXRlZAogIHJldHVybiAoCiAgICAhKG5vZGUucG9ydCA9PT0gNDk3MzggJiYgKG5vZGUuaG9zdCA9PT0gJzEzNC4yMDkuMjguOTgnIHx8IG5vZGUuaG9zdCA9PT0gJzE2Ny45OS4xNDIuMTg1JykpICYmCiAgICAhKG5vZGUucG9ydCA9PT0gOTQwMCAmJiBub2RlLmhvc3QgPT09ICczNS4yMzMuNDcuMjUyJykgJiYKICAgICEobm9kZS5ob3N0ID09PSAnMTUwLjEzNi4xNDIuMTE2JykKICApCn0KCmNvbnN0IGRlZmF1bHRNYXhTaXplID0gNjU1MzYKY29uc3QgZGVmYXVsdE1heEFnZSA9IDIwICogNjAgKiAxMDAwIC8vIDIwIG1pbnV0ZXMKCmZ1bmN0aW9uIGRlZmF1bHRDYWNoZU9wdHMob3B0cykgewogIGNvbnN0IG1heFNpemUgPSBvcHRzLm1heFNpemUgfHwgZGVmYXVsdE1heFNpemUKICBjb25zdCBtYXhBZ2UgPSBvcHRzLm1heEFnZSB8fCBkZWZhdWx0TWF4QWdlCgogIHJldHVybiB7CiAgICByb3V0ZXI6IHsKICAgICAgZm9yd2FyZHM6IHsgbWF4U2l6ZSwgbWF4QWdlIH0KICAgIH0sCiAgICByZWxheUFkZHJlc3NlczogeyBtYXhTaXplOiBNYXRoLm1pbihtYXhTaXplLCA1MTIpLCBtYXhBZ2U6IDAgfSwKICAgIHBlcnNpc3RlbnQ6IHsKICAgICAgcmVjb3JkczogeyBtYXhTaXplLCBtYXhBZ2UgfSwKICAgICAgcmVmcmVzaGVzOiB7IG1heFNpemUsIG1heEFnZSB9LAogICAgICBtdXRhYmxlczogewogICAgICAgIG1heFNpemU6IChtYXhTaXplIC8gMikgfCAwLAogICAgICAgIG1heEFnZTogb3B0cy5tYXhBZ2UgfHwgNDggKiA2MCAqIDYwICogMTAwMCAvLyA0OCBob3VycwogICAgICB9LAogICAgICBpbW11dGFibGVzOiB7CiAgICAgICAgbWF4U2l6ZTogKG1heFNpemUgLyAyKSB8IDAsCiAgICAgICAgbWF4QWdlOiBvcHRzLm1heEFnZSB8fCA0OCAqIDYwICogNjAgKiAxMDAwIC8vIDQ4IGhvdXJzCiAgICAgIH0sCiAgICAgIGJ1bXBzOiB7IG1heFNpemUsIG1heEFnZSB9CiAgICB9CiAgfQp9CmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBTaWduYWwgPSByZXF1aXJlKCdzaWduYWwtcHJvbWlzZScpCmNvbnN0IHsgZW5jb2RlVW5zbGFiIH0gPSByZXF1aXJlKCcuL2VuY29kZScpCmNvbnN0IFNsZWVwZXIgPSByZXF1aXJlKCcuL3NsZWVwZXInKQpjb25zdCBtID0gcmVxdWlyZSgnLi9tZXNzYWdlcycpCmNvbnN0IFBlcnNpc3RlbnQgPSByZXF1aXJlKCcuL3BlcnNpc3RlbnQnKQpjb25zdCB7IENPTU1BTkRTIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgpjb25zdCBNSU5fQUNUSVZFID0gMwoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBBbm5vdW5jZXIgewogIGNvbnN0cnVjdG9yKGRodCwga2V5UGFpciwgdGFyZ2V0LCBvcHRzID0ge30pIHsKICAgIHRoaXMuZGh0ID0gZGh0CiAgICB0aGlzLmtleVBhaXIgPSBrZXlQYWlyCiAgICB0aGlzLnRhcmdldCA9IHRhcmdldAogICAgdGhpcy5yZWxheXMgPSBbXQogICAgdGhpcy5yZWxheUFkZHJlc3NlcyA9IFtdCiAgICB0aGlzLnN0b3BwZWQgPSBmYWxzZQogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgdGhpcy5yZWNvcmQgPSBlbmNvZGVVbnNsYWIobS5wZWVyLCB7IHB1YmxpY0tleToga2V5UGFpci5wdWJsaWNLZXksIHJlbGF5QWRkcmVzc2VzOiBbXSB9KQogICAgdGhpcy5vbmxpbmUgPSBuZXcgU2lnbmFsKCkKCiAgICB0aGlzLl9yZWZyZXNoaW5nID0gZmFsc2UKICAgIHRoaXMuX2Nsb3Nlc3ROb2RlcyA9IG51bGwKICAgIHRoaXMuX2FjdGl2ZSA9IG51bGwKICAgIHRoaXMuX3NsZWVwZXIgPSBuZXcgU2xlZXBlcigpCiAgICB0aGlzLl9yZXN1bWVkID0gbmV3IFNpZ25hbCgpCiAgICB0aGlzLl9zaWduQW5ub3VuY2UgPSBvcHRzLnNpZ25Bbm5vdW5jZSB8fCBQZXJzaXN0ZW50LnNpZ25Bbm5vdW5jZQogICAgdGhpcy5fc2lnblVuYW5ub3VuY2UgPSBvcHRzLnNpZ25VbmFubm91bmNlIHx8IFBlcnNpc3RlbnQuc2lnblVuYW5ub3VuY2UKICAgIHRoaXMuX3VwZGF0aW5nID0gbnVsbAogICAgdGhpcy5fYWN0aXZlUXVlcnkgPSBudWxsCiAgICB0aGlzLl91bmFubm91bmNpbmcgPSBudWxsCgogICAgdGhpcy5fc2VydmVyUmVsYXlzID0gW25ldyBNYXAoKSwgbmV3IE1hcCgpLCBuZXcgTWFwKCldCiAgfQoKICBpc1JlbGF5KGFkZHIpIHsKICAgIGNvbnN0IGlkID0gYWRkci5ob3N0ICsgJzonICsgYWRkci5wb3J0CiAgICBjb25zdCBbYSwgYiwgY10gPSB0aGlzLl9zZXJ2ZXJSZWxheXMKICAgIHJldHVybiBhLmhhcyhpZCkgfHwgYi5oYXMoaWQpIHx8IGMuaGFzKGlkKQogIH0KCiAgYXN5bmMgc3VzcGVuZCh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIHJldHVybgogICAgdGhpcy5zdXNwZW5kZWQgPSB0cnVlCgogICAgbG9nKCdTdXNwZW5kaW5nIGFubm91bmNlcicpCgogICAgLy8gU3VzcGVuZCBoYXMgaXRzIG93biBzbGVlcCBsb2dpYwogICAgLy8gc28gd2UgZG9uJ3Qgd2FudCB0byBoYW5nIG9uIHRoaXMgb25lCiAgICB0aGlzLm9ubGluZS5ub3RpZnkoKQoKICAgIGlmICh0aGlzLl9hY3RpdmVRdWVyeSkgdGhpcy5fYWN0aXZlUXVlcnkuZGVzdHJveSgpCgogICAgdGhpcy5fc2xlZXBlci5yZXN1bWUoKQogICAgaWYgKHRoaXMuX3VwZGF0aW5nKSBhd2FpdCB0aGlzLl91cGRhdGluZwogICAgbG9nKCdTdXNwZW5kaW5nIGFubm91bmNlciAocG9zdCB1cGRhdGUpJykKCiAgICBpZiAodGhpcy5zdXNwZW5kZWQgPT09IGZhbHNlIHx8IHRoaXMuc3RvcHBlZCkgcmV0dXJuCgogICAgbG9nKCdTdXNwZW5kaW5nIGFubm91bmNlciAocHJlIHVuYW5ub3VuY2UpJykKICAgIGF3YWl0IHRoaXMuX3VuYW5ub3VuY2VDdXJyZW50KCkKICAgIGxvZygnU3VzcGVuZGluZyBhbm5vdW5jZXIgKHBvc3QgdW5hbm5vdW5jZSknKQogIH0KCiAgcmVzdW1lKCkgewogICAgaWYgKCF0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCgogICAgdGhpcy5yZWZyZXNoKCkKICAgIHRoaXMuX3NsZWVwZXIucmVzdW1lKCkKICAgIHRoaXMuX3Jlc3VtZWQubm90aWZ5KCkKICB9CgogIHJlZnJlc2goKSB7CiAgICBpZiAodGhpcy5zdG9wcGVkKSByZXR1cm4KICAgIHRoaXMuX3JlZnJlc2hpbmcgPSB0cnVlCiAgfQoKICBhc3luYyBzdGFydCgpIHsKICAgIGlmICh0aGlzLnN0b3BwZWQpIHJldHVybgogICAgdGhpcy5fYWN0aXZlID0gdGhpcy5fcnVuVXBkYXRlKCkKICAgIGF3YWl0IHRoaXMuX2FjdGl2ZQogICAgaWYgKHRoaXMuc3RvcHBlZCkgcmV0dXJuCiAgICB0aGlzLl9hY3RpdmUgPSB0aGlzLl9iYWNrZ3JvdW5kKCkKICB9CgogIGFzeW5jIHN0b3AoKSB7CiAgICB0aGlzLnN0b3BwZWQgPSB0cnVlCiAgICB0aGlzLm9ubGluZS5ub3RpZnkoKSAvLyBCcmVhayBvdXQgb2YgdGhlIF9iYWNrZ3JvdW5kIGxvb3AgaWYgd2UncmUgb2ZmbGluZQogICAgdGhpcy5fc2xlZXBlci5yZXN1bWUoKQogICAgdGhpcy5fcmVzdW1lZC5ub3RpZnkoKQogICAgYXdhaXQgdGhpcy5fYWN0aXZlCiAgICBhd2FpdCB0aGlzLl91bmFubm91bmNlQ3VycmVudCgpCiAgfQoKICBhc3luYyBfdW5hbm5vdW5jZUN1cnJlbnQoKSB7CiAgICB3aGlsZSAodGhpcy5fdW5hbm5vdW5jaW5nICE9PSBudWxsKSBhd2FpdCB0aGlzLl91bmFubm91bmNpbmcKICAgIGNvbnN0IHVuID0gKHRoaXMuX3VuYW5ub3VuY2luZyA9IHRoaXMuX3VuYW5ub3VuY2VBbGwodGhpcy5fc2VydmVyUmVsYXlzWzJdLnZhbHVlcygpKSkKICAgIGF3YWl0IHRoaXMuX3VuYW5ub3VuY2luZwogICAgaWYgKHVuID09PSB0aGlzLl91bmFubm91bmNpbmcpIHRoaXMuX3VuYW5ub3VuY2luZyA9IG51bGwKICB9CgogIGFzeW5jIF9iYWNrZ3JvdW5kKCkgewogICAgd2hpbGUgKCF0aGlzLmRodC5kZXN0cm95ZWQgJiYgIXRoaXMuc3RvcHBlZCkgewogICAgICB0cnkgewogICAgICAgIHRoaXMuX3JlZnJlc2hpbmcgPSBmYWxzZQoKICAgICAgICAvLyB+NW1pbiArLQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTAwICYmICF0aGlzLnN0b3BwZWQgJiYgIXRoaXMuX3JlZnJlc2hpbmcgJiYgIXRoaXMuc3VzcGVuZGVkOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHBpbmdzID0gW10KCiAgICAgICAgICBmb3IgKGNvbnN0IG5vZGUgb2YgdGhpcy5fc2VydmVyUmVsYXlzWzJdLnZhbHVlcygpKSB7CiAgICAgICAgICAgIHBpbmdzLnB1c2godGhpcy5kaHQucGluZyhub2RlKSkKICAgICAgICAgIH0KCiAgICAgICAgICBjb25zdCBhY3RpdmUgPSBhd2FpdCByZXNvbHZlZChwaW5ncykKICAgICAgICAgIGlmIChhY3RpdmUgPCBNYXRoLm1pbihwaW5ncy5sZW5ndGgsIE1JTl9BQ1RJVkUpKSB7CiAgICAgICAgICAgIHRoaXMucmVmcmVzaCgpIC8vIHdlIGxvc3QgdG9vIG1hbnkgcmVsYXkgbm9kZXMsIHJldHJ5IGFsbAogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0aGlzLnN0b3BwZWQpIHJldHVybgoKICAgICAgICAgIGlmICghdGhpcy5zdXNwZW5kZWQgJiYgIXRoaXMuX3JlZnJlc2hpbmcpIGF3YWl0IHRoaXMuX3NsZWVwZXIucGF1c2UoMzAwMCkKICAgICAgICB9CgogICAgICAgIHdoaWxlICghdGhpcy5zdG9wcGVkICYmIHRoaXMuc3VzcGVuZGVkKSBhd2FpdCB0aGlzLl9yZXN1bWVkLndhaXQoKQoKICAgICAgICBpZiAoIXRoaXMuc3RvcHBlZCkgYXdhaXQgdGhpcy5fcnVuVXBkYXRlKCkKCiAgICAgICAgd2hpbGUgKCF0aGlzLmRodC5vbmxpbmUgJiYgIXRoaXMuc3RvcHBlZCAmJiAhdGhpcy5zdXNwZW5kZWQpIHsKICAgICAgICAgIC8vIEJlaW5nIG9mZmxpbmUgY2FuIG1ha2UgX2JhY2tncm91bmQgcmVwZWF0IHZlcnkgcXVpY2tseQogICAgICAgICAgLy8gU28gd2FpdCB1bnRpbCB3ZSdyZSBiYWNrIG9ubGluZQogICAgICAgICAgYXdhaXQgdGhpcy5vbmxpbmUud2FpdCgpCiAgICAgICAgfQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgIH0KICAgIH0KICB9CgogIGFzeW5jIF9ydW5VcGRhdGUoKSB7CiAgICB0aGlzLl91cGRhdGluZyA9IHRoaXMuX3VwZGF0ZSgpCiAgICBhd2FpdCB0aGlzLl91cGRhdGluZwogICAgdGhpcy5fdXBkYXRpbmcgPSBudWxsCiAgfQoKICBhc3luYyBfdXBkYXRlKCkgewogICAgd2hpbGUgKHRoaXMuX3VuYW5ub3VuY2luZykgYXdhaXQgdGhpcy5fdW5hbm5vdW5jaW5nCgogICAgdGhpcy5fY3ljbGUoKQoKICAgIGNvbnN0IHEgPSAodGhpcy5fYWN0aXZlUXVlcnkgPSB0aGlzLmRodC5maW5kUGVlcih0aGlzLnRhcmdldCwgewogICAgICBoYXNoOiBmYWxzZSwKICAgICAgbm9kZXM6IHRoaXMuX2Nsb3Nlc3ROb2RlcwogICAgfSkpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgcS5maW5pc2hlZCgpCiAgICB9IGNhdGNoIHsKICAgICAgLy8gaWdub3JlIGZhaWx1cmVzLi4uCiAgICB9CgogICAgdGhpcy5fYWN0aXZlUXVlcnkgPSBudWxsCgogICAgaWYgKHRoaXMuc3RvcHBlZCB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCgogICAgY29uc3QgYW5uID0gW10KICAgIGNvbnN0IHJlcGxpZXMgPSBwaWNrQmVzdChxLmNsb3Nlc3RSZXBsaWVzKQoKICAgIGNvbnN0IHJlbGF5cyA9IFtdCiAgICBjb25zdCByZWxheUFkZHJlc3NlcyA9IFtdCgogICAgaWYgKCF0aGlzLmRodC5maXJld2FsbGVkKSB7CiAgICAgIGNvbnN0IGFkZHIgPSB0aGlzLmRodC5yZW1vdGVBZGRyZXNzKCkKICAgICAgaWYgKGFkZHIpIHJlbGF5QWRkcmVzc2VzLnB1c2goYWRkcikKICAgIH0KCiAgICBmb3IgKGNvbnN0IG1zZyBvZiByZXBsaWVzKSB7CiAgICAgIGFubi5wdXNoKHRoaXMuX2NvbW1pdChtc2csIHJlbGF5cywgcmVsYXlBZGRyZXNzZXMpKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChhbm4pCiAgICBpZiAodGhpcy5zdG9wcGVkIHx8IHRoaXMuc3VzcGVuZGVkKSByZXR1cm4KCiAgICB0aGlzLl9jbG9zZXN0Tm9kZXMgPSBxLmNsb3Nlc3ROb2RlcwogICAgdGhpcy5yZWxheXMgPSByZWxheXMKICAgIHRoaXMucmVsYXlBZGRyZXNzZXMgPSByZWxheUFkZHJlc3NlcwoKICAgIGNvbnN0IHJlbW92ZWQgPSBbXQogICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgdGhpcy5fc2VydmVyUmVsYXlzWzFdKSB7CiAgICAgIGlmICghdGhpcy5fc2VydmVyUmVsYXlzWzJdLmhhcyhrZXkpKSByZW1vdmVkLnB1c2godmFsdWUpCiAgICB9CgogICAgYXdhaXQgdGhpcy5fdW5hbm5vdW5jZUFsbChyZW1vdmVkKQogIH0KCiAgX3VuYW5ub3VuY2VBbGwocmVsYXlzKSB7CiAgICBjb25zdCB1bmFubiA9IFtdCiAgICBmb3IgKGNvbnN0IHIgb2YgcmVsYXlzKSB1bmFubi5wdXNoKHRoaXMuX3VuYW5ub3VuY2UocikpCiAgICByZXR1cm4gUHJvbWlzZS5hbGxTZXR0bGVkKHVuYW5uKQogIH0KCiAgYXN5bmMgX3VuYW5ub3VuY2UodG8pIHsKICAgIGNvbnN0IHVuYW5uID0gewogICAgICBwZWVyOiB7CiAgICAgICAgcHVibGljS2V5OiB0aGlzLmtleVBhaXIucHVibGljS2V5LAogICAgICAgIHJlbGF5QWRkcmVzc2VzOiBbXQogICAgICB9LAogICAgICByZWZyZXNoOiBudWxsLAogICAgICBzaWduYXR1cmU6IG51bGwKICAgIH0KCiAgICBjb25zdCB7IGZyb20sIHRva2VuLCB2YWx1ZSB9ID0gYXdhaXQgdGhpcy5kaHQucmVxdWVzdCgKICAgICAgewogICAgICAgIHRva2VuOiBudWxsLAogICAgICAgIGNvbW1hbmQ6IENPTU1BTkRTLkZJTkRfUEVFUiwKICAgICAgICB0YXJnZXQ6IHRoaXMudGFyZ2V0LAogICAgICAgIHZhbHVlOiBudWxsCiAgICAgIH0sCiAgICAgIHRvCiAgICApCgogICAgaWYgKCF0b2tlbiB8fCAhZnJvbS5pZCB8fCAhdmFsdWUpIHJldHVybgoKICAgIHVuYW5uLnNpZ25hdHVyZSA9IGF3YWl0IHRoaXMuX3NpZ25VbmFubm91bmNlKHRoaXMudGFyZ2V0LCB0b2tlbiwgZnJvbS5pZCwgdW5hbm4sIHRoaXMua2V5UGFpcikKCiAgICBhd2FpdCB0aGlzLmRodC5yZXF1ZXN0KAogICAgICB7CiAgICAgICAgdG9rZW4sCiAgICAgICAgY29tbWFuZDogQ09NTUFORFMuVU5BTk5PVU5DRSwKICAgICAgICB0YXJnZXQ6IHRoaXMudGFyZ2V0LAogICAgICAgIHZhbHVlOiBjLmVuY29kZShtLmFubm91bmNlLCB1bmFubikKICAgICAgfSwKICAgICAgdG8KICAgICkKICB9CgogIGFzeW5jIF9jb21taXQobXNnLCByZWxheXMsIHJlbGF5QWRkcmVzc2VzKSB7CiAgICBjb25zdCBhbm4gPSB7CiAgICAgIHBlZXI6IHsKICAgICAgICBwdWJsaWNLZXk6IHRoaXMua2V5UGFpci5wdWJsaWNLZXksCiAgICAgICAgcmVsYXlBZGRyZXNzZXM6IFtdCiAgICAgIH0sCiAgICAgIHJlZnJlc2g6IG51bGwsCiAgICAgIHNpZ25hdHVyZTogbnVsbAogICAgfQoKICAgIGFubi5zaWduYXR1cmUgPSBhd2FpdCB0aGlzLl9zaWduQW5ub3VuY2UodGhpcy50YXJnZXQsIG1zZy50b2tlbiwgbXNnLmZyb20uaWQsIGFubiwgdGhpcy5rZXlQYWlyKQoKICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZGh0LnJlcXVlc3QoCiAgICAgIHsKICAgICAgICB0b2tlbjogbXNnLnRva2VuLAogICAgICAgIGNvbW1hbmQ6IENPTU1BTkRTLkFOTk9VTkNFLAogICAgICAgIHRhcmdldDogdGhpcy50YXJnZXQsCiAgICAgICAgdmFsdWU6IGMuZW5jb2RlKG0uYW5ub3VuY2UsIGFubikKICAgICAgfSwKICAgICAgbXNnLmZyb20KICAgICkKCiAgICBpZiAocmVzLmVycm9yICE9PSAwKSByZXR1cm4KCiAgICBpZiAocmVsYXlBZGRyZXNzZXMubGVuZ3RoIDwgMykgcmVsYXlBZGRyZXNzZXMucHVzaCh7IGhvc3Q6IG1zZy5mcm9tLmhvc3QsIHBvcnQ6IG1zZy5mcm9tLnBvcnQgfSkKICAgIHJlbGF5cy5wdXNoKHsgcmVsYXlBZGRyZXNzOiBtc2cuZnJvbSwgcGVlckFkZHJlc3M6IG1zZy50byB9KQoKICAgIHRoaXMuX3NlcnZlclJlbGF5c1syXS5zZXQobXNnLmZyb20uaG9zdCArICc6JyArIG1zZy5mcm9tLnBvcnQsIG1zZy5mcm9tKQogIH0KCiAgX2N5Y2xlKCkgewogICAgY29uc3QgdG1wID0gdGhpcy5fc2VydmVyUmVsYXlzWzBdCiAgICB0aGlzLl9zZXJ2ZXJSZWxheXNbMF0gPSB0aGlzLl9zZXJ2ZXJSZWxheXNbMV0KICAgIHRoaXMuX3NlcnZlclJlbGF5c1sxXSA9IHRoaXMuX3NlcnZlclJlbGF5c1syXQogICAgdGhpcy5fc2VydmVyUmVsYXlzWzJdID0gdG1wCiAgICB0bXAuY2xlYXIoKQogIH0KfQoKZnVuY3Rpb24gcmVzb2x2ZWQocHMpIHsKICBsZXQgcmVwbGllZCA9IDAKICBsZXQgdGlja3MgPSBwcy5sZW5ndGggKyAxCgogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgZm9yIChjb25zdCBwIG9mIHBzKSBwLnRoZW4ocHVzaCwgdGljaykKICAgIHRpY2soKQoKICAgIGZ1bmN0aW9uIHB1c2godikgewogICAgICByZXBsaWVkKysKICAgICAgdGljaygpCiAgICB9CgogICAgZnVuY3Rpb24gdGljaygpIHsKICAgICAgaWYgKC0tdGlja3MgPT09IDApIHJlc29sdmUocmVwbGllZCkKICAgIH0KICB9KQp9CgpmdW5jdGlvbiBwaWNrQmVzdChyZXBsaWVzKSB7CiAgLy8gVE9ETzogcGljayB0aGUgb25lcyBjbG9zZXN0IHRvIHVzIFJUVCB3aXNlCiAgcmV0dXJuIHJlcGxpZXMuc2xpY2UoMCwgMykKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IE5vaXNlU2VjcmV0U3RyZWFtID0gcmVxdWlyZSgnQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHJlbGF5ID0gcmVxdWlyZSgnYmxpbmQtcmVsYXknKQpjb25zdCB7IGlzUHJpdmF0ZSwgaXNCb2dvbiB9ID0gcmVxdWlyZSgnYm9nb24nKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IHVuc2xhYiA9IHJlcXVpcmUoJ3Vuc2xhYicpCmNvbnN0IFNlbWFwaG9yZSA9IHJlcXVpcmUoJy4vc2VtYXBob3JlJykKY29uc3QgTm9pc2VXcmFwID0gcmVxdWlyZSgnLi9ub2lzZS13cmFwJykKY29uc3QgU2VjdXJlUGF5bG9hZCA9IHJlcXVpcmUoJy4vc2VjdXJlLXBheWxvYWQnKQpjb25zdCBIb2xlcHVuY2hlciA9IHJlcXVpcmUoJy4vaG9sZXB1bmNoZXInKQpjb25zdCBTbGVlcGVyID0gcmVxdWlyZSgnLi9zbGVlcGVyJykKY29uc3QgeyBGSVJFV0FMTCwgRVJST1IgfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKY29uc3QgeyB1bnNsYWJiZWRIYXNoIH0gPSByZXF1aXJlKCcuL2NyeXB0bycpCmNvbnN0IHsKICBDQU5OT1RfSE9MRVBVTkNILAogIEhBTkRTSEFLRV9JTlZBTElELAogIEhPTEVQVU5DSF9BQk9SVEVELAogIEhPTEVQVU5DSF9JTlZBTElELAogIEhPTEVQVU5DSF9QUk9CRV9USU1FT1VULAogIEhPTEVQVU5DSF9ET1VCTEVfUkFORE9NSVpFRF9OQVRTLAogIFBFRVJfQ09OTkVDVElPTl9GQUlMRUQsCiAgUEVFUl9OT1RfRk9VTkQsCiAgUkVNT1RFX0FCT1JURUQsCiAgUkVNT1RFX05PVF9IT0xFUFVOQ0hBQkxFLAogIFJFTU9URV9OT1RfSE9MRVBVTkNISU5HLAogIFNFUlZFUl9FUlJPUiwKICBTRVJWRVJfSU5DT01QQVRJQkxFLAogIFJFTEFZX0FCT1JURUQsCiAgU1VTUEVOREVECn0gPSByZXF1aXJlKCcuL2Vycm9ycycpCgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGNvbm5lY3QoZGh0LCBwdWJsaWNLZXksIG9wdHMgPSB7fSkgewogIGNvbnN0IHBvb2wgPSBvcHRzLnBvb2wgfHwgbnVsbAoKICBpZiAocG9vbCAmJiBwb29sLmhhcyhwdWJsaWNLZXkpKSByZXR1cm4gcG9vbC5nZXQocHVibGljS2V5KQoKICBwdWJsaWNLZXkgPSB1bnNsYWIocHVibGljS2V5KQoKICBjb25zdCBrZXlQYWlyID0gb3B0cy5rZXlQYWlyIHx8IGRodC5kZWZhdWx0S2V5UGFpcgogIGNvbnN0IHJlbGF5VGhyb3VnaCA9IHNlbGVjdFJlbGF5KG9wdHMucmVsYXlUaHJvdWdoIHx8IG51bGwpCiAgY29uc3QgZW5jcnlwdGVkU29ja2V0ID0gKG9wdHMuY3JlYXRlU2VjcmV0U3RyZWFtIHx8IGRlZmF1bHRDcmVhdGVTZWNyZXRTdHJlYW0pKHRydWUsIG51bGwsIHsKICAgIHB1YmxpY0tleToga2V5UGFpci5wdWJsaWNLZXksCiAgICByZW1vdGVQdWJsaWNLZXk6IHB1YmxpY0tleSwKICAgIGF1dG9TdGFydDogZmFsc2UsCiAgICBrZWVwQWxpdmU6IGRodC5jb25uZWN0aW9uS2VlcEFsaXZlCiAgfSkKCiAgLy8gaW4gY2FzZSBhIHNvY2tldCBpcyBtYWRlIGR1cmluZyBzdXNwZW5kZWQgc3RhdGUsIGRlc3Ryb3kgaXQgaW1tZWRpYXRlbHkKICBpZiAoZGh0LnN1c3BlbmRlZCB8fCAhZGh0Ll9jb25uZWN0YWJsZSkgewogICAgZW5jcnlwdGVkU29ja2V0LmRlc3Ryb3koU1VTUEVOREVEKCkpCiAgICByZXR1cm4gZW5jcnlwdGVkU29ja2V0CiAgfQoKICBpZiAocG9vbCkgcG9vbC5fYXR0YWNoU3RyZWFtKGVuY3J5cHRlZFNvY2tldCwgZmFsc2UpCgogIGNvbnN0IGlkID0gYjRhLnRvU3RyaW5nKHB1YmxpY0tleSwgJ2hleCcpCiAgY29uc3QgYyA9IHsKICAgIGlkLAogICAgZGh0LAogICAgc2Vzc2lvbjogZGh0LnNlc3Npb24oKSwKICAgIHJlbGF5QWRkcmVzc2VzOiBvcHRzLnJlbGF5QWRkcmVzc2VzIHx8IFtdLAogICAgcmVtb3RlUmVsYXlBZGRyZXNzZXM6IFtdLAogICAgcG9vbCwKICAgIHJvdW5kOiAwLAogICAgdGFyZ2V0OiB1bnNsYWJiZWRIYXNoKHB1YmxpY0tleSksCiAgICByZW1vdGVQdWJsaWNLZXk6IHB1YmxpY0tleSwKICAgIHJldXNhYmxlU29ja2V0OiAhIW9wdHMucmV1c2FibGVTb2NrZXQsCiAgICBoYW5kc2hha2U6IChvcHRzLmNyZWF0ZUhhbmRzaGFrZSB8fCBkZWZhdWx0Q3JlYXRlSGFuZHNoYWtlKShrZXlQYWlyLCBwdWJsaWNLZXkpLAogICAgcmVxdWVzdDogbnVsbCwKICAgIHJlcXVlc3Rpbmc6IGZhbHNlLAogICAgbGFuOiBvcHRzLmxvY2FsQ29ubmVjdGlvbiAhPT0gZmFsc2UsCiAgICBmaXJld2FsbDogRklSRVdBTEwuVU5LTk9XTiwKICAgIHJhd1N0cmVhbTogZGh0LmNyZWF0ZVJhd1N0cmVhbSh7IGZyYW1lZDogdHJ1ZSwgZmlyZXdhbGwgfSksCiAgICBjb25uZWN0OiBudWxsLAogICAgcXVlcnk6IG51bGwsCiAgICBwdW5jaGVyOiBudWxsLAogICAgcGF5bG9hZDogbnVsbCwKICAgIHBhc3NpdmVDb25uZWN0VGltZW91dDogbnVsbCwKICAgIHNlcnZlclNvY2tldDogbnVsbCwKICAgIHNlcnZlckFkZHJlc3M6IG51bGwsCiAgICBvbnNvY2tldDogbnVsbCwKICAgIHNsZWVwZXI6IG5ldyBTbGVlcGVyKCksCiAgICBlbmNyeXB0ZWRTb2NrZXQsCgogICAgLy8gUmVsYXkgc3RhdGUKICAgIHJlbGF5VGltZW91dDogbnVsbCwKICAgIHJlbGF5VGhyb3VnaCwKICAgIHJlbGF5VG9rZW46IHJlbGF5VGhyb3VnaCA/IHJlbGF5LnRva2VuKCkgOiBudWxsLAogICAgcmVsYXlTb2NrZXQ6IG51bGwsCiAgICByZWxheUNsaWVudDogbnVsbCwKICAgIHJlbGF5UGFpcmVkOiBmYWxzZSwKICAgIHJlbGF5S2VlcEFsaXZlOiBvcHRzLnJlbGF5S2VlcEFsaXZlIHx8IDUwMDAKICB9CgogIC8vIElmIHRoZSByYXcgc3RyZWFtIHJlY2VpdmVzIGFuIGVycm9yIHNpZ25hbCBwcmUgY29ubmVjdCAoaWUgZnJvbSB0aGUgZmlyZXdhbGwgaG9vayksIG1ha2Ugc3VyZQogIC8vIHRvIGZvcndhcmQgdGhhdCB0byB0aGUgZW5jcnlwdGVkIHNvY2tldCBmb3IgcHJvcGVyIHRlYXJkb3duCiAgYy5yYXdTdHJlYW0ub24oJ2Vycm9yJywgYXV0b0Rlc3Ryb3kpCiAgYy5yYXdTdHJlYW0ub25jZSgnY29ubmVjdCcsICgpID0+IHsKICAgIGMucmF3U3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIGF1dG9EZXN0cm95KQogIH0pCgogIGVuY3J5cHRlZFNvY2tldC5vbignY2xvc2UnLCBmdW5jdGlvbiAoKSB7CiAgICBpZiAoYy5wYXNzaXZlQ29ubmVjdFRpbWVvdXQpIGNsZWFyUGFzc2l2ZUNvbm5lY3RUaW1lb3V0KGMpCiAgICBpZiAoYy5xdWVyeSkgYy5xdWVyeS5kZXN0cm95KCkKICAgIGlmIChjLnB1bmNoZXIpIGMucHVuY2hlci5kZXN0cm95KCkKICAgIGlmIChjLnJhd1N0cmVhbSkgYy5yYXdTdHJlYW0uZGVzdHJveSgpCiAgICBjLnNlc3Npb24uZGVzdHJveSgpCiAgICBjLnNsZWVwZXIucmVzdW1lKCkKICB9KQoKICAvLyBTYWZlIHRvIHJ1biBpbiB0aGUgYmFja2dyb3VuZCAtIG5ldmVyIHRocm93cwogIGlmIChkaHQuc3VzcGVuZGVkKSBlbmNyeXB0ZWRTb2NrZXQuZGVzdHJveShTVVNQRU5ERUQoKSkKICBlbHNlIGNvbm5lY3RBbmRIb2xlcHVuY2goYywgb3B0cykKCiAgcmV0dXJuIGVuY3J5cHRlZFNvY2tldAoKICBmdW5jdGlvbiBhdXRvRGVzdHJveShlcnIpIHsKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBlcnIpCiAgfQoKICBmdW5jdGlvbiBmaXJld2FsbChzb2NrZXQsIHBvcnQsIGhvc3QpIHsKICAgIC8vIENoZWNrIGlmIHRoZSB0cmFmZmljIG9yaWdpbmF0ZWQgZnJvbSB0aGUgc29ja2V0IG9uIHdoaWNoIHdlJ3JlIGV4cGVjdGluZyByZWxheSB0cmFmZmljLiBJZiBzbywKICAgIC8vIHdlIGhhdmVuJ3QgaG9sZSBwdW5jaGVkIHlldCBhbmQgdGhlIG90aGVyIHNpZGUgaXMganVzdCBzZW5kaW5nIHVzIHRyYWZmaWMgdGhyb3VnaCB0aGUgcmVsYXkuCiAgICBpZiAoYy5yZWxheVNvY2tldCAmJiBpc1JlbGF5KGMucmVsYXlTb2NrZXQsIHNvY2tldCwgcG9ydCwgaG9zdCkpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgaWYgKGMub25zb2NrZXQpIHsKICAgICAgYy5vbnNvY2tldChzb2NrZXQsIHBvcnQsIGhvc3QpCiAgICB9IGVsc2UgewogICAgICBjLnNlcnZlclNvY2tldCA9IHNvY2tldAogICAgICBjLnNlcnZlckFkZHJlc3MgPSB7IHBvcnQsIGhvc3QgfQogICAgfQogICAgcmV0dXJuIGZhbHNlCiAgfQp9CgpmdW5jdGlvbiBpc0RvbmUoYykgewogIC8vIHdlIGFyZSBkZXN0cm95aW5nIG9yIHRoZSBwdW5jaGVyIGlzIGNvbm5lY3RlZCAtIGRvbmUKICBpZiAoYy5lbmNyeXB0ZWRTb2NrZXQuZGVzdHJveWluZyB8fCAhIShjLnB1bmNoZXIgJiYgYy5wdW5jaGVyLmNvbm5lY3RlZCkpIHsKICAgIHJldHVybiB0cnVlCiAgfQogIC8vIG5vdCBkZXN0cm95aW5nLCBidXQgbm8gcmF3IHN0cmVhbSAtIGRlZiBub3QgZG9uZQogIGlmIChjLmVuY3J5cHRlZFNvY2tldC5yYXdTdHJlYW0gPT09IG51bGwpIHsKICAgIHJldHVybiBmYWxzZQogIH0KICAvLyB3ZSBhcmUgcmVsYXllZCwgYnV0IHRoZSBwdW5jaGVyIGlzIG5vdCBkb25lIHlldAogIGlmIChjLnJlbGF5U29ja2V0ICYmICEhKGMucHVuY2hlciAmJiAhYy5wdW5jaGVyLmNvbm5lY3RlZCAmJiAhYy5wdW5jaGVyLmRlc3Ryb3llZCkpIHsKICAgIHJldHVybiBmYWxzZQogIH0KICAvLyB3ZSBhcmUgZG9uZQogIHJldHVybiB0cnVlCn0KCmFzeW5jIGZ1bmN0aW9uIHJldHJ5Um91dGUoYywgcm91dGUpIHsKICBjb25zdCByZWYgPSBjLmRodC5fc29ja2V0UG9vbC5sb29rdXAocm91dGUuc29ja2V0KQoKICBpZiAoIXJlZikgewogICAgaWYgKHJvdXRlLnNvY2tldCA9PT0gYy5kaHQuc29ja2V0KSB7CiAgICAgIGF3YWl0IGNvbm5lY3RUaHJvdWdoTm9kZShjLCByb3V0ZS5hZGRyZXNzLCBjLmRodC5zb2NrZXQpCiAgICB9CiAgICByZXR1cm4KICB9CgogIHJlZi5hY3RpdmUoKQoKICB0cnkgewogICAgYXdhaXQgY29ubmVjdFRocm91Z2hOb2RlKGMsIHJvdXRlLmFkZHJlc3MsIHJvdXRlLnNvY2tldCkKICB9IGNhdGNoIHsKICAgIC8vIGlmIGVycm9yLCBqdXN0IGlnbm9yZSwgYW5kIGNvbnRpbnVlIHRocm91Z2ggdGhlIGV4aXN0aW5nIHN0cmF0CiAgfQoKICByZWYuaW5hY3RpdmUoKQp9Cgphc3luYyBmdW5jdGlvbiBjb25uZWN0QW5kSG9sZXB1bmNoKGMsIG9wdHMpIHsKICBjb25zdCByb3V0ZSA9IGMucmV1c2FibGVTb2NrZXQgPyBjLmRodC5fc29ja2V0UG9vbC5yb3V0ZXMuZ2V0KGMucmVtb3RlUHVibGljS2V5KSA6IG51bGwKCiAgaWYgKHJvdXRlKSB7CiAgICBhd2FpdCByZXRyeVJvdXRlKGMsIHJvdXRlKQogICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCiAgfQoKICBhd2FpdCBmaW5kQW5kQ29ubmVjdChjLCBvcHRzKQogIGlmIChpc0RvbmUoYykpIHJldHVybgoKICBpZiAoIWMuY29ubmVjdCkgewogICAgLy8gVE9ETzoganVzdCBhIHF1aWNrIGZpeCBmb3Igbm93LCBzaG91bGQgcmV0cnkgcHJvYgogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIEhBTkRTSEFLRV9JTlZBTElEKCkpCiAgICByZXR1cm4KICB9CgogIGF3YWl0IGhvbGVwdW5jaChjLCBvcHRzKQp9CgpmdW5jdGlvbiBnZXRGaXJzdFJlbW90ZUFkZHJlc3MoYWRkcnMsIHNlcnZlckFkZHJlc3MpIHsKICBmb3IgKGNvbnN0IGFkZHIgb2YgYWRkcnMpIHsKICAgIGlmIChpc0JvZ29uKGFkZHIuaG9zdCkpIGNvbnRpbnVlCiAgICByZXR1cm4gYWRkcgogIH0KCiAgcmV0dXJuIHNlcnZlckFkZHJlc3MKfQoKYXN5bmMgZnVuY3Rpb24gaG9sZXB1bmNoKGMsIG9wdHMpIHsKICBsZXQgeyByZWxheUFkZHJlc3MsIHNlcnZlckFkZHJlc3MsIGNsaWVudEFkZHJlc3MsIHBheWxvYWQgfSA9IGMuY29ubmVjdAoKICBjb25zdCByZW1vdGVIb2xlcHVuY2hhYmxlID0gISEocGF5bG9hZC5ob2xlcHVuY2ggJiYgcGF5bG9hZC5ob2xlcHVuY2gucmVsYXlzLmxlbmd0aCkKCiAgY29uc3QgcmVsYXllZCA9IGRpZmZBZGRyZXNzKHNlcnZlckFkZHJlc3MsIHJlbGF5QWRkcmVzcykKCiAgaWYgKHBheWxvYWQuZmlyZXdhbGwgPT09IEZJUkVXQUxMLk9QRU4gfHwgKHJlbGF5ZWQgJiYgIXJlbW90ZUhvbGVwdW5jaGFibGUpKSB7CiAgICBjb25zdCBhZGRyID0gZ2V0Rmlyc3RSZW1vdGVBZGRyZXNzKHBheWxvYWQuYWRkcmVzc2VzNCwgc2VydmVyQWRkcmVzcykKICAgIGlmIChhZGRyKSB7CiAgICAgIGNvbnN0IHNvY2tldCA9IGMuZGh0LnNvY2tldAogICAgICBjLmRodC5zdGF0cy5wdW5jaGVzLm9wZW4rKwogICAgICBjLm9uc29ja2V0KHNvY2tldCwgYWRkci5wb3J0LCBhZGRyLmhvc3QpCiAgICAgIHJldHVybgogICAgfQogICAgLy8gVE9ETzogY2hlY2sgYWxsIGFkZHJlc3NlcyBhbHNvIG9idnMKICB9CgogIGNvbnN0IG9uYWJvcnQgPSAoKSA9PiB7CiAgICBjLnNlc3Npb24uZGVzdHJveSgpCiAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgSE9MRVBVTkNIX0FCT1JURUQoKSkKICB9CgogIGlmIChjLmZpcmV3YWxsID09PSBGSVJFV0FMTC5PUEVOKSB7CiAgICBjLnBhc3NpdmVDb25uZWN0VGltZW91dCA9IHNldFRpbWVvdXQob25hYm9ydCwgMTAwMDApCiAgICByZXR1cm4KICB9CgogIC8vIFRPRE86IHdvdWxkIGJlIGJldHRlciB0byBqdXN0IHRyeSBsb2NhbCBhZGRycyBpbiB0aGUgYmFja2dyb3VuZCB3aGlsc3QgY29udGludWluZyB3aXRoIG90aGVyIHN0cmF0ZWdpZXMuLi4KICBpZiAoYy5sYW4gJiYgcmVsYXllZCAmJiBjbGllbnRBZGRyZXNzLmhvc3QgPT09IHNlcnZlckFkZHJlc3MuaG9zdCkgewogICAgY29uc3Qgc2VydmVyQWRkcmVzc2VzID0gcGF5bG9hZC5hZGRyZXNzZXM0LmZpbHRlcihvbmx5UHJpdmF0ZUhvc3RzKQoKICAgIGlmIChzZXJ2ZXJBZGRyZXNzZXMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBteUFkZHJlc3NlcyA9IEhvbGVwdW5jaGVyLmxvY2FsQWRkcmVzc2VzKGMuZGh0LmlvLnNlcnZlclNvY2tldCkKICAgICAgY29uc3QgYWRkciA9IEhvbGVwdW5jaGVyLm1hdGNoQWRkcmVzcyhteUFkZHJlc3Nlcywgc2VydmVyQWRkcmVzc2VzKSB8fCBzZXJ2ZXJBZGRyZXNzZXNbMF0KCiAgICAgIGNvbnN0IHNvY2tldCA9IGMuZGh0LmlvLnNlcnZlclNvY2tldAogICAgICB0cnkgewogICAgICAgIGF3YWl0IGMuZGh0LnBpbmcoYWRkcikKICAgICAgfSBjYXRjaCB7CiAgICAgICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIEhPTEVQVU5DSF9BQk9SVEVEKCkpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgYy5vbnNvY2tldChzb2NrZXQsIGFkZHIucG9ydCwgYWRkci5ob3N0KQogICAgICByZXR1cm4KICAgIH0KICB9CgogIGlmICghcmVtb3RlSG9sZXB1bmNoYWJsZSkgewogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIENBTk5PVF9IT0xFUFVOQ0goKSkKICAgIHJldHVybgogIH0KCiAgYy5wdW5jaGVyID0gbmV3IEhvbGVwdW5jaGVyKGMuZGh0LCBjLnNlc3Npb24sIHRydWUsIHBheWxvYWQuZmlyZXdhbGwpCgogIGMucHVuY2hlci5vbmNvbm5lY3QgPSBjLm9uc29ja2V0CiAgYy5wdW5jaGVyLm9uYWJvcnQgPSBvbmFib3J0CgogIGNvbnN0IHNlcnZlclJlbGF5ID0gcGlja1NlcnZlclJlbGF5KHBheWxvYWQuaG9sZXB1bmNoLnJlbGF5cywgcmVsYXlBZGRyZXNzKQoKICAvLyBCZWdpbiBob2xlcHVuY2hpbmchCgogIGxldCBwcm9iZQogIHRyeSB7CiAgICBwcm9iZSA9IGF3YWl0IHByb2JlUm91bmQoYywgb3B0cy5mYXN0T3BlbiA9PT0gZmFsc2UgPyBudWxsIDogc2VydmVyQWRkcmVzcywgc2VydmVyUmVsYXksIHRydWUpCiAgfSBjYXRjaCAoZXJyKSB7CiAgICBkZXN0cm95UHVuY2hlcihjKQogICAgLy8gVE9ETzogd2Ugc2hvdWxkIHJldHJ5IGhlcmUgd2l0aCBzb21lIG9mIHRoZSBvdGhlciByZWxheXMsIGJhaWwgZm9yIG5vdwogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIGVycikKICAgIHJldHVybgogIH0KCiAgaWYgKGlzRG9uZShjKSB8fCAhcHJvYmUpIHJldHVybgogIGNvbnN0IHsgdG9rZW4sIHBlZXJBZGRyZXNzIH0gPSBwcm9iZQoKICAvLyBJZiB0aGUgcmVsYXkgdGhlIHNlcnZlciBwaWNrZWQgaXMgdGhlIHNhbWUgYXMgdGhlIHJlbGF5IHRoZSBjbGllbnQgcGlja2VkLAogIC8vIHRoZW4gd2UgY2FuIHVzZSB0aGUgcGVlckFkZHJlc3MgdGhhdCByb3VuZCBvbmUgaW5kaWNhdGVzIHRoZSBzZXJ2ZXIgd2FudHMgdG8gdXNlLgogIC8vIFRoaXMgc2hhdmVzIG9mZiBhIHJvdW5kdHJpcCBpZiB0aGUgc2VydmVyIGNob3NlIHRvIHJlcm9sbCBpdHMgc29ja2V0IGR1ZSB0byBzb21lIE5BVAogIC8vIGlzc3VlIHdpdGggdGhlIGZpcnN0IG9uZSBpdCBwaWNrZWQgKGllIG1vYmlsZSBuYXQgaW5jb25zaXN0ZW5jaWVzLi4uKS4KICAvLyBJZiB0aGUgcmVsYXlzIHdlcmUgZGlmZmVyZW50LCB0aGVuIHRoZSBzZXJ2ZXIgd291bGQgbm90IGhhdmUgYSBVRFAgc2Vzc2lvbiBvcGVuIG9uIHRoaXMgYWRkcmVzcwogIC8vIHRvIHRoZSBjbGllbnQgcmVsYXksIHdoaWNoIHJvdW5kMiB1c2VzLgogIGlmICgKICAgICFkaWZmQWRkcmVzcyhzZXJ2ZXJSZWxheS5yZWxheUFkZHJlc3MsIHJlbGF5QWRkcmVzcykgJiYKICAgIGRpZmZBZGRyZXNzKHNlcnZlckFkZHJlc3MsIHBlZXJBZGRyZXNzKQogICkgewogICAgc2VydmVyQWRkcmVzcyA9IHBlZXJBZGRyZXNzCiAgICBhd2FpdCBjLnB1bmNoZXIub3BlblNlc3Npb24oc2VydmVyQWRkcmVzcykKICAgIGlmIChpc0RvbmUoYykpIHJldHVybgogIH0KCiAgLy8gVE9ETzogc3RpbGwgY29udGludWUgaGVyZSBpZiBhIGxvY2FsIGNvbm5lY3Rpb24gbWlnaHQgd29yaywgYnV0IHRoZW4gZG8gbm90IGhvbGVwdW5jaC4uLgogIGlmICgKICAgIG9wdHMuaG9sZXB1bmNoICYmCiAgICAhb3B0cy5ob2xlcHVuY2goCiAgICAgIGMucHVuY2hlci5yZW1vdGVGaXJld2FsbCwKICAgICAgYy5wdW5jaGVyLm5hdC5maXJld2FsbCwKICAgICAgYy5wdW5jaGVyLnJlbW90ZUFkZHJlc3NlcywKICAgICAgYy5wdW5jaGVyLm5hdC5hZGRyZXNzZXMKICAgICkKICApIHsKICAgIGF3YWl0IGFib3J0KGMsIHNlcnZlclJlbGF5LCBIT0xFUFVOQ0hfQUJPUlRFRCgnQ2xpZW50IGFib3J0ZWQgaG9sZXB1bmNoJykpCiAgICByZXR1cm4KICB9CgogIHRyeSB7CiAgICBhd2FpdCByb3VuZFB1bmNoKGMsIHNlcnZlckFkZHJlc3MsIHRva2VuLCByZWxheUFkZHJlc3MsIHNlcnZlclJlbGF5LCBmYWxzZSkKICB9IGNhdGNoIChlcnIpIHsKICAgIGRlc3Ryb3lQdW5jaGVyKGMpCiAgICAvLyBUT0RPOiByZXRyeSB3aXRoIGFub3RoZXIgcmVsYXk/CiAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgZXJyKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZmluZEFuZENvbm5lY3QoYywgb3B0cykgewogIGxldCBhdHRlbXB0cyA9IDAKICBsZXQgY2xvc2VzdE5vZGVzID0gb3B0cy5yZWxheUFkZHJlc3NlcyAmJiBvcHRzLnJlbGF5QWRkcmVzc2VzLmxlbmd0aCA/IG9wdHMucmVsYXlBZGRyZXNzZXMgOiBudWxsCgogIGlmICghY2xvc2VzdE5vZGVzKSB7CiAgICBjb25zdCBjYWNoZWRSZWxheUFkZHJlc3NlcyA9IGMuZGh0Ll9yZWxheUFkZHJlc3Nlc0NhY2hlLmdldChjLmlkKQogICAgaWYgKGNhY2hlZFJlbGF5QWRkcmVzc2VzKSBjbG9zZXN0Tm9kZXMgPSBjYWNoZWRSZWxheUFkZHJlc3NlcwogIH0KCiAgaWYgKGMuZGh0Ll9wZXJzaXN0ZW50KSB7CiAgICAvLyBjaGVjayBpZiB3ZSBrbm93IHRoZSByb3V0ZSBvdXJzZWxmLi4uCiAgICBjb25zdCByb3V0ZSA9IGMuZGh0Ll9yb3V0ZXIuZ2V0KGMudGFyZ2V0KQogICAgaWYgKHJvdXRlICYmIHJvdXRlLnJlbGF5ICE9PSBudWxsKSB7CiAgICAgIGNsb3Nlc3ROb2RlcyA9IFt7IGhvc3Q6IHJvdXRlLnJlbGF5Lmhvc3QsIHBvcnQ6IHJvdXRlLnJlbGF5LnBvcnQgfV0KICAgIH0KICB9CgogIC8vIDIgaXMgaG93IG1hbnkgcGFyYWxsZWwgY29ubmVjdCBhdHRlbXB0cyB3ZSB3YW50IHRvIGRvLCB3ZSBjYW4gbWFrZSB0aGlzIGNvbmZpZ3VyYWJsZQogIGNvbnN0IHNlbSA9IG5ldyBTZW1hcGhvcmUoMikKICBjb25zdCBzaWduYWwgPSBzZW0uc2lnbmFsLmJpbmQoc2VtKQogIGNvbnN0IHRyaWVzID0gY2xvc2VzdE5vZGVzICE9PSBudWxsID8gMiA6IDEKCiAgdHJ5IHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdHJpZXMgJiYgIWlzRG9uZShjKSAmJiAhYy5jb25uZWN0OyBpKyspIHsKICAgICAgYy5xdWVyeSA9IGMuZGh0LmZpbmRQZWVyKGMudGFyZ2V0LCB7CiAgICAgICAgaGFzaDogZmFsc2UsCiAgICAgICAgc2Vzc2lvbjogYy5zZXNzaW9uLAogICAgICAgIGNsb3Nlc3ROb2RlcywKICAgICAgICBvbmx5Q2xvc2VzdE5vZGVzOiBjbG9zZXN0Tm9kZXMgIT09IG51bGwsCiAgICAgICAgcmV0cmllczogY2xvc2VzdE5vZGVzID8gMSA6IDMKICAgICAgfSkKCiAgICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiBjLnF1ZXJ5KSB7CiAgICAgICAgYXdhaXQgc2VtLndhaXQoKQogICAgICAgIGlmIChpc0RvbmUoYykpIHJldHVybgoKICAgICAgICBpZiAoYy5jb25uZWN0KSB7CiAgICAgICAgICBzZW0uc2lnbmFsKCkKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQoKICAgICAgICBjLnJlbW90ZVJlbGF5QWRkcmVzc2VzLnB1c2goZGF0YS5mcm9tKQogICAgICAgIGF0dGVtcHRzKysKICAgICAgICBjb25uZWN0VGhyb3VnaE5vZGUoYywgZGF0YS5mcm9tLCBudWxsKS50aGVuKHNpZ25hbCwgc2lnbmFsKQogICAgICB9CgogICAgICBjbG9zZXN0Tm9kZXMgPSBudWxsCgogICAgICBpZiAoYXR0ZW1wdHMgPiAwKSBhd2FpdCBzZW0uZmx1c2goKQogICAgfQoKICAgIGMucXVlcnkgPSBudWxsCiAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4KCiAgICAvLyBmbHVzaCB0aGUgc2VtYXBob3JlCiAgICBhd2FpdCBzZW0uZmx1c2goKQogICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCiAgfSBjYXRjaCAoZXJyKSB7CiAgICBjLnF1ZXJ5ID0gbnVsbAogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIGVycikKICAgIHJldHVybgogIH0KCiAgaWYgKCFjLmNvbm5lY3QpIHsKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBhdHRlbXB0cyA/IFBFRVJfQ09OTkVDVElPTl9GQUlMRUQoKSA6IFBFRVJfTk9UX0ZPVU5EKCkpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBjb25uZWN0VGhyb3VnaE5vZGUoYywgYWRkcmVzcywgc29ja2V0KSB7CiAgaWYgKCFjLnJlcXVlc3RpbmcpIHsKICAgIC8vIElmIHdlIGhhdmUgYSBzdGFibGUgc2VydmVyIGFkZHJlc3MsIHNlbmQgaXQgb3ZlciBub3cKICAgIGNvbnN0IGFkZHIgPSBjLmRodC5yZW1vdGVBZGRyZXNzKCkKICAgIGNvbnN0IGxvY2FsQWRkcnMgPSBjLmxhbiA/IEhvbGVwdW5jaGVyLmxvY2FsQWRkcmVzc2VzKGMuZGh0LmlvLnNlcnZlclNvY2tldCkgOiBudWxsCiAgICBjb25zdCBhZGRyZXNzZXM0ID0gW10KCiAgICBpZiAoYWRkcikgYWRkcmVzc2VzNC5wdXNoKGFkZHIpCiAgICBpZiAobG9jYWxBZGRycykgYWRkcmVzc2VzNC5wdXNoKC4uLmxvY2FsQWRkcnMpCgogICAgYy5maXJld2FsbCA9IGFkZHIgPyBGSVJFV0FMTC5PUEVOIDogRklSRVdBTEwuVU5LTk9XTgogICAgYy5yZXF1ZXN0aW5nID0gdHJ1ZQogICAgYy5yZXF1ZXN0ID0gYXdhaXQgYy5oYW5kc2hha2Uuc2VuZCh7CiAgICAgIGVycm9yOiBFUlJPUi5OT05FLAogICAgICBmaXJld2FsbDogYy5maXJld2FsbCwKICAgICAgaG9sZXB1bmNoOiBudWxsLAogICAgICBhZGRyZXNzZXM0LAogICAgICBhZGRyZXNzZXM2OiBbXSwKICAgICAgdWR4OiB7CiAgICAgICAgcmV1c2FibGVTb2NrZXQ6IGMucmV1c2FibGVTb2NrZXQsCiAgICAgICAgaWQ6IGMucmF3U3RyZWFtLmlkLAogICAgICAgIHNlcTogMAogICAgICB9LAogICAgICBzZWNyZXRTdHJlYW06IHt9LAogICAgICByZWxheVRocm91Z2g6IGMucmVsYXlUaHJvdWdoID8geyBwdWJsaWNLZXk6IGMucmVsYXlUaHJvdWdoLCB0b2tlbjogYy5yZWxheVRva2VuIH0gOiBudWxsCiAgICB9KQogICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCiAgfQoKICBjb25zdCB7IHNlcnZlckFkZHJlc3MsIGNsaWVudEFkZHJlc3MsIHJlbGF5ZWQsIG5vaXNlIH0gPSBhd2FpdCBjLmRodC5fcm91dGVyLnBlZXJIYW5kc2hha2UoCiAgICBjLnRhcmdldCwKICAgIHsgbm9pc2U6IGMucmVxdWVzdCwgc29ja2V0LCBzZXNzaW9uOiBjLnNlc3Npb24gfSwKICAgIGFkZHJlc3MKICApCiAgaWYgKGlzRG9uZShjKSB8fCBjLmNvbm5lY3QpIHJldHVybgoKICBjb25zdCBwYXlsb2FkID0gYXdhaXQgYy5oYW5kc2hha2UucmVjdihub2lzZSkKICBpZiAoaXNEb25lKGMpIHx8ICFwYXlsb2FkKSByZXR1cm4KCiAgaWYgKHBheWxvYWQudmVyc2lvbiAhPT0gMSkgewogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIFNFUlZFUl9JTkNPTVBBVElCTEUoKSkKICAgIHJldHVybgogIH0KICBpZiAocGF5bG9hZC5lcnJvciAhPT0gRVJST1IuTk9ORSkgewogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIFNFUlZFUl9FUlJPUigpKQogICAgcmV0dXJuCiAgfQogIGlmICghcGF5bG9hZC51ZHgpIHsKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBTRVJWRVJfRVJST1IoJ1NlcnZlciBkaWQgbm90IHNlbmQgVURYIGRhdGEnKSkKICAgIHJldHVybgogIH0KCiAgY29uc3QgaHMgPSBjLmhhbmRzaGFrZS5maW5hbCgpCgogIGMuaGFuZHNoYWtlID0gbnVsbAogIGMucmVxdWVzdCA9IG51bGwKICBjLnJlcXVlc3RpbmcgPSBmYWxzZQogIGMuY29ubmVjdCA9IHsKICAgIHJlbGF5ZWQsCiAgICByZWxheUFkZHJlc3M6IGFkZHJlc3MsCiAgICBjbGllbnRBZGRyZXNzLAogICAgc2VydmVyQWRkcmVzcywKICAgIHBheWxvYWQKICB9CgogIGMucGF5bG9hZCA9IG5ldyBTZWN1cmVQYXlsb2FkKGhzLmhvbGVwdW5jaFNlY3JldCkKCiAgYy5vbnNvY2tldCA9IGZ1bmN0aW9uIChzb2NrZXQsIHBvcnQsIGhvc3QpIHsKICAgIGlmIChjLnJhd1N0cmVhbSA9PT0gbnVsbCkgcmV0dXJuIC8vIEFscmVhZHkgaG9sZSBwdW5jaGVkCgogICAgaWYgKGMucmF3U3RyZWFtLmNvbm5lY3RlZCkgewogICAgICBjb25zdCByZW1vdGVDaGFuZ2luZyA9IGMucmF3U3RyZWFtLmNoYW5nZVJlbW90ZShzb2NrZXQsIGMuY29ubmVjdC5wYXlsb2FkLnVkeC5pZCwgcG9ydCwgaG9zdCkKCiAgICAgIGlmIChyZW1vdGVDaGFuZ2luZykgcmVtb3RlQ2hhbmdpbmcuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgICB9IGVsc2UgewogICAgICAvLyBjYWNoZSB0aGUgcmVsYXkgYWRkcnMgZm9yIGEgZnV0dXJlIHJlY29ubmVjdCwgd2UgcHJlZmVyIHRoZSByZW1vdGUgb25lIHNvIHRoZXkKICAgICAgLy8gY2FuIGdpdmUgdXMgdGhlIGNvcnJlY3Qgb25lcyBmcm9tIHRoZWlyIHBvdgogICAgICBpZiAocGF5bG9hZC5yZWxheUFkZHJlc3NlcyAmJiBwYXlsb2FkLnJlbGF5QWRkcmVzc2VzLmxlbmd0aCkgewogICAgICAgIGMuZGh0Ll9yZWxheUFkZHJlc3Nlc0NhY2hlLnNldChjLmlkLCBwYXlsb2FkLnJlbGF5QWRkcmVzc2VzKQogICAgICB9IGVsc2UgaWYgKGMucmVtb3RlUmVsYXlBZGRyZXNzZXMubGVuZ3RoKSB7CiAgICAgICAgYy5kaHQuX3JlbGF5QWRkcmVzc2VzQ2FjaGUuc2V0KGMuaWQsIGMucmVtb3RlUmVsYXlBZGRyZXNzZXMpCiAgICAgIH0KCiAgICAgIGMucmF3U3RyZWFtLmNvbm5lY3Qoc29ja2V0LCBjLmNvbm5lY3QucGF5bG9hZC51ZHguaWQsIHBvcnQsIGhvc3QpCiAgICAgIGMuZW5jcnlwdGVkU29ja2V0LnN0YXJ0KGMucmF3U3RyZWFtLCB7IGhhbmRzaGFrZTogaHMgfSkKICAgIH0KCiAgICBpZiAoYy5yZXVzYWJsZVNvY2tldCAmJiBwYXlsb2FkLnVkeC5yZXVzYWJsZVNvY2tldCkgewogICAgICBjLmRodC5fc29ja2V0UG9vbC5yb3V0ZXMuYWRkKGMucmVtb3RlUHVibGljS2V5LCBjLnJhd1N0cmVhbSkKICAgIH0KCiAgICBpZiAoYy5wdW5jaGVyKSB7CiAgICAgIGMucHVuY2hlci5vbmFib3J0ID0gbm9vcAogICAgICBjLnB1bmNoZXIuZGVzdHJveSgpCiAgICB9CgogICAgaWYgKGMucGFzc2l2ZUNvbm5lY3RUaW1lb3V0KSB7CiAgICAgIGNsZWFyUGFzc2l2ZUNvbm5lY3RUaW1lb3V0KGMpCiAgICB9CgogICAgYy5yYXdTdHJlYW0gPSBudWxsCiAgfQoKICBpZiAocGF5bG9hZC5yZWxheVRocm91Z2ggfHwgYy5yZWxheVRocm91Z2gpIHsKICAgIHJlbGF5Q29ubmVjdGlvbihjLCBjLnJlbGF5VGhyb3VnaCwgcGF5bG9hZCwgaHMpCiAgfQoKICBpZiAoYy5zZXJ2ZXJTb2NrZXQpIHsKICAgIGMub25zb2NrZXQoYy5zZXJ2ZXJTb2NrZXQsIGMuc2VydmVyQWRkcmVzcy5wb3J0LCBjLnNlcnZlckFkZHJlc3MuaG9zdCkKICAgIHJldHVybgogIH0KCiAgaWYgKCFyZWxheWVkKSB7CiAgICBjLm9uc29ja2V0KHNvY2tldCB8fCBjLmRodC5zb2NrZXQsIGFkZHJlc3MucG9ydCwgYWRkcmVzcy5ob3N0KQogIH0KCiAgYy5zZXNzaW9uLmRlc3Ryb3koKQp9Cgphc3luYyBmdW5jdGlvbiB1cGRhdGVIb2xlcHVuY2goYywgcGVlckFkZHJlc3MsIHJlbGF5QWRkciwgcGF5bG9hZCkgewogIGNvbnN0IGhvbGVwdW5jaCA9IGF3YWl0IGMuZGh0Ll9yb3V0ZXIucGVlckhvbGVwdW5jaCgKICAgIGMudGFyZ2V0LAogICAgewogICAgICBpZDogYy5jb25uZWN0LnBheWxvYWQuaG9sZXB1bmNoLmlkLAogICAgICBwYXlsb2FkOiBjLnBheWxvYWQuZW5jcnlwdChwYXlsb2FkKSwKICAgICAgcGVlckFkZHJlc3MsCiAgICAgIHNvY2tldDogYy5wdW5jaGVyLnNvY2tldCwKICAgICAgc2Vzc2lvbjogYy5zZXNzaW9uCiAgICB9LAogICAgcmVsYXlBZGRyCiAgKQoKICBpZiAoaXNEb25lKGMpKSByZXR1cm4gbnVsbAoKICBjb25zdCByZW1vdGVQYXlsb2FkID0gYy5wYXlsb2FkLmRlY3J5cHQoaG9sZXB1bmNoLnBheWxvYWQpCiAgaWYgKCFyZW1vdGVQYXlsb2FkKSB7CiAgICB0aHJvdyBIT0xFUFVOQ0hfSU5WQUxJRCgpCiAgfQoKICBjb25zdCB7IGVycm9yLCBmaXJld2FsbCwgcHVuY2hpbmcsIGFkZHJlc3NlcywgcmVtb3RlVG9rZW4gfSA9IHJlbW90ZVBheWxvYWQKCiAgaWYgKGVycm9yID09PSBFUlJPUi5UUllfTEFURVIgJiYgYy5yZWxheVRva2VuICYmIHBheWxvYWQucHVuY2hpbmcpIHsKICAgIHJldHVybiB7CiAgICAgIHRyeUxhdGVyOiB0cnVlLAogICAgICAuLi5ob2xlcHVuY2gsCiAgICAgIHBheWxvYWQ6IHJlbW90ZVBheWxvYWQKICAgIH0KICB9CgogIGlmIChlcnJvciAhPT0gRVJST1IuTk9ORSkgewogICAgdGhyb3cgUkVNT1RFX0FCT1JURUQoJ1JlbW90ZSBhYm9ydGVkIHdpdGggZXJyb3IgY29kZSAnICsgZXJyb3IpCiAgfQoKICBjb25zdCBlY2hvZWQgPSAhIShyZW1vdGVUb2tlbiAmJiBwYXlsb2FkLnRva2VuICYmIGI0YS5lcXVhbHMocmVtb3RlVG9rZW4sIHBheWxvYWQudG9rZW4pKQoKICBjLnB1bmNoZXIudXBkYXRlUmVtb3RlKHsKICAgIHB1bmNoaW5nLAogICAgZmlyZXdhbGwsCiAgICBhZGRyZXNzZXMsCiAgICB2ZXJpZmllZDogZWNob2VkID8gcGVlckFkZHJlc3MuaG9zdCA6IG51bGwKICB9KQoKICByZXR1cm4gewogICAgdHJ5TGF0ZXI6IGZhbHNlLAogICAgLi4uaG9sZXB1bmNoLAogICAgcGF5bG9hZDogcmVtb3RlUGF5bG9hZAogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcHJvYmVSb3VuZChjLCBzZXJ2ZXJBZGRyZXNzLCBzZXJ2ZXJSZWxheSwgcmV0cnkpIHsKICAvLyBPcGVuIGEgcXVpY2sgbG93IHR0bCBzZXNzaW9uIGFnYWluc3Qgd2hhdCB3ZSB0aGluayBpcyB0aGUgc2VydmVyCiAgaWYgKHNlcnZlckFkZHJlc3MpIGF3YWl0IGMucHVuY2hlci5vcGVuU2Vzc2lvbihzZXJ2ZXJBZGRyZXNzKQoKICBpZiAoaXNEb25lKGMpKSByZXR1cm4gbnVsbAoKICBjb25zdCByZXBseSA9IGF3YWl0IHVwZGF0ZUhvbGVwdW5jaChjLCBzZXJ2ZXJSZWxheS5wZWVyQWRkcmVzcywgc2VydmVyUmVsYXkucmVsYXlBZGRyZXNzLCB7CiAgICBlcnJvcjogRVJST1IuTk9ORSwKICAgIGZpcmV3YWxsOiBjLnB1bmNoZXIubmF0LmZpcmV3YWxsLAogICAgcm91bmQ6IGMucm91bmQrKywKICAgIGNvbm5lY3RlZDogZmFsc2UsCiAgICBwdW5jaGluZzogZmFsc2UsCiAgICBhZGRyZXNzZXM6IGMucHVuY2hlci5uYXQuYWRkcmVzc2VzLAogICAgcmVtb3RlQWRkcmVzczogc2VydmVyQWRkcmVzcywKICAgIHRva2VuOiBudWxsLAogICAgcmVtb3RlVG9rZW46IG51bGwKICB9KQoKICBpZiAoaXNEb25lKGMpIHx8ICFyZXBseSkgcmV0dXJuIG51bGwKCiAgY29uc3QgeyBwZWVyQWRkcmVzcyB9ID0gcmVwbHkKICBjb25zdCB7IGFkZHJlc3MsIHRva2VuIH0gPSByZXBseS5wYXlsb2FkCgogIGMucHVuY2hlci5uYXQuYWRkKHJlcGx5LnRvLCByZXBseS5mcm9tKQoKICAvLyBPcGVuIGFub3RoZXIgcXVpY2sgbG93IHR0bCBzZXNzaW9uIGFnYWluc3Qgd2hhdCB0aGUgc2VydmVyIHNheXMgdGhlaXIgYWRkcmVzcyBpcywKICAvLyBpZiB0aGV5IGhhdmVuJ3Qgc2FpZCB0aGV5IGFyZSByYW5kb20geWV0CiAgaWYgKAogICAgYy5wdW5jaGVyLnJlbW90ZUZpcmV3YWxsIDwgRklSRVdBTEwuUkFORE9NICYmCiAgICBhZGRyZXNzICYmCiAgICBhZGRyZXNzLmhvc3QgJiYKICAgIGFkZHJlc3MucG9ydCAmJgogICAgZGlmZkFkZHJlc3MoYWRkcmVzcywgc2VydmVyQWRkcmVzcykKICApIHsKICAgIGF3YWl0IGMucHVuY2hlci5vcGVuU2Vzc2lvbihhZGRyZXNzKQogICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuIG51bGwKICB9CgogIC8vIElmIHRoZSByZW1vdGUgdG9sZCB1cyB0aGV5IGRpZG4ndCBrbm93IHRoZWlyIG5hdCBmaXJld2FsbCB5ZXQsIGdpdmUgdGhlbSBhIGNoYW5jZSB0byBmaWd1cmUgaXQgb3V0CiAgLy8gVGhleSBtaWdodCBzYXkgdGhpcyB0byBzZWUgaWYgdGhlICJmYXN0IG1vZGUiIHB1bmNoIGNvbWVzIHRocm91Z2ggZmlyc3QuCiAgaWYgKGMucHVuY2hlci5yZW1vdGVGaXJld2FsbCA9PT0gRklSRVdBTEwuVU5LTk9XTikgewogICAgYXdhaXQgYy5zbGVlcGVyLnBhdXNlKDEwMDApCiAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4gbnVsbAogIH0KCiAgbGV0IHN0YWJsZSA9IGF3YWl0IGMucHVuY2hlci5hbmFseXplKGZhbHNlKQogIGlmIChpc0RvbmUoYykpIHJldHVybiBudWxsCgogIC8vIElmIHRoZSBzb2NrZXQgc2VlbXMgdW5zdGFibGUsIHRyeSB0byBtYWtlIGl0IHN0YWJsZSBieSBzZXR0aW5nIHRoZSAiYWxsb3dSZW9wZW4iIGZsYWcKICAvLyBNb3N0bHkgcmVsZXZhbnQgZm9yIG1vYmlsZSBuZXR3b3JrcwogIGlmICghc3RhYmxlKSB7CiAgICBzdGFibGUgPSBhd2FpdCBjLnB1bmNoZXIuYW5hbHl6ZSh0cnVlKQogICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuIG51bGwKICAgIGlmIChzdGFibGUpIHJldHVybiBwcm9iZVJvdW5kKGMsIHNlcnZlckFkZHJlc3MsIHNlcnZlclJlbGF5LCBmYWxzZSkKICB9CgogIGlmICgoYy5wdW5jaGVyLnJlbW90ZUZpcmV3YWxsID09PSBGSVJFV0FMTC5VTktOT1dOIHx8ICF0b2tlbikgJiYgcmV0cnkpIHsKICAgIHJldHVybiBwcm9iZVJvdW5kKGMsIHNlcnZlckFkZHJlc3MsIHNlcnZlclJlbGF5LCBmYWxzZSkKICB9CgogIGlmICgKICAgIGMucHVuY2hlci5yZW1vdGVGaXJld2FsbCA9PT0gRklSRVdBTEwuVU5LTk9XTiB8fAogICAgYy5wdW5jaGVyLm5hdC5maXJld2FsbCA9PT0gRklSRVdBTEwuVU5LTk9XTgogICkgewogICAgYXdhaXQgYWJvcnQoYywgc2VydmVyUmVsYXksIEhPTEVQVU5DSF9QUk9CRV9USU1FT1VUKCkpCiAgICByZXR1cm4gbnVsbAogIH0KCiAgaWYgKGMucHVuY2hlci5yZW1vdGVGaXJld2FsbCA+PSBGSVJFV0FMTC5SQU5ET00gJiYgYy5wdW5jaGVyLm5hdC5maXJld2FsbCA+PSBGSVJFV0FMTC5SQU5ET00pIHsKICAgIGF3YWl0IGFib3J0KGMsIHNlcnZlclJlbGF5LCBIT0xFUFVOQ0hfRE9VQkxFX1JBTkRPTUlaRURfTkFUUygpKQogICAgcmV0dXJuIG51bGwKICB9CgogIHJldHVybiB7IHRva2VuLCBwZWVyQWRkcmVzcyB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJvdW5kUHVuY2goYywgc2VydmVyQWRkcmVzcywgcmVtb3RlVG9rZW4sIGNsaWVudFJlbGF5LCBzZXJ2ZXJSZWxheSwgZGVsYXllZCkgewogIC8vIFdlIGFyZSBnb3NzaXBpbmcgb3VyIGZpbmFsIE5BVCBzdGF0dXMgdG8gdGhlIG90aGVyIHBlZXIgbm93CiAgLy8gc28gbWFrZSBzdXJlIHdlIGRvbid0IHVwZGF0ZSBvdXIgbG9jYWwgdmlldyBmb3Igbm93IGFzIHRoYXQgY2FuIG1ha2UgdGhpbmdzIHdlaXJkCiAgYy5wdW5jaGVyLm5hdC5mcmVlemUoKQoKICBjb25zdCBpc1JhbmRvbSA9CiAgICBjLnB1bmNoZXIucmVtb3RlRmlyZXdhbGwgPj0gRklSRVdBTEwuUkFORE9NIHx8IGMucHVuY2hlci5uYXQuZmlyZXdhbGwgPj0gRklSRVdBTEwuUkFORE9NCiAgaWYgKGlzUmFuZG9tKSB7CiAgICB3aGlsZSAoCiAgICAgIGMuZGh0Ll9yYW5kb21QdW5jaGVzID49IGMuZGh0Ll9yYW5kb21QdW5jaExpbWl0IHx8CiAgICAgIERhdGUubm93KCkgLSBjLmRodC5fbGFzdFJhbmRvbVB1bmNoIDwgYy5kaHQuX3JhbmRvbVB1bmNoSW50ZXJ2YWwKICAgICkgewogICAgICAvLyBpZiBubyByZWxheSBjYW4gaGVscCwgYmFpbAogICAgICBpZiAoIWMucmVsYXlUb2tlbikgdGhyb3cgSE9MRVBVTkNIX0FCT1JURUQoKQoKICAgICAgaWYgKCFkZWxheWVkKSB7CiAgICAgICAgZGVsYXllZCA9IHRydWUKICAgICAgICBhd2FpdCB1cGRhdGVIb2xlcHVuY2goYywgc2VydmVyQWRkcmVzcywgY2xpZW50UmVsYXksIHsKICAgICAgICAgIGVycm9yOiBFUlJPUi5OT05FLAogICAgICAgICAgZmlyZXdhbGw6IGMucHVuY2hlci5uYXQuZmlyZXdhbGwsCiAgICAgICAgICByb3VuZDogYy5yb3VuZCsrLAogICAgICAgICAgY29ubmVjdGVkOiBmYWxzZSwKICAgICAgICAgIHB1bmNoaW5nOiBmYWxzZSwKICAgICAgICAgIGFkZHJlc3NlczogYy5wdW5jaGVyLm5hdC5hZGRyZXNzZXMsCiAgICAgICAgICByZW1vdGVBZGRyZXNzOiBudWxsLAogICAgICAgICAgdG9rZW46IGMucGF5bG9hZC50b2tlbihzZXJ2ZXJBZGRyZXNzKSwKICAgICAgICAgIHJlbW90ZVRva2VuCiAgICAgICAgfSkKICAgICAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4KICAgICAgfQoKICAgICAgYXdhaXQgdHJ5TGF0ZXIoYykKICAgICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCiAgICB9CiAgfQoKICAvLyBpbmNyZW1lbnQgbm93LCBzbyB3ZSBjYW4gY29tbWl0IHRvIHB1bmNoaW5nCiAgaWYgKGlzUmFuZG9tKSBjLmRodC5fcmFuZG9tUHVuY2hlcysrCgogIGxldCByZXBseQoKICB0cnkgewogICAgLy8gaWYgZGVsYXllZCBzd2l0Y2ggdG8gdGhlIHNlcnZlcnMgY2hvc2VuIHJlbGF5IC0gd2UgdmFsaWRhdGVkIGFueXdheQogICAgcmVwbHkgPSBhd2FpdCB1cGRhdGVIb2xlcHVuY2goCiAgICAgIGMsCiAgICAgIGRlbGF5ZWQgPyBzZXJ2ZXJSZWxheS5wZWVyQWRkcmVzcyA6IHNlcnZlckFkZHJlc3MsCiAgICAgIGRlbGF5ZWQgPyBzZXJ2ZXJSZWxheS5yZWxheUFkZHJlc3MgOiBjbGllbnRSZWxheSwKICAgICAgewogICAgICAgIGVycm9yOiBFUlJPUi5OT05FLAogICAgICAgIGZpcmV3YWxsOiBjLnB1bmNoZXIubmF0LmZpcmV3YWxsLAogICAgICAgIHJvdW5kOiBjLnJvdW5kKyssCiAgICAgICAgY29ubmVjdGVkOiBmYWxzZSwKICAgICAgICBwdW5jaGluZzogdHJ1ZSwKICAgICAgICBhZGRyZXNzZXM6IGMucHVuY2hlci5uYXQuYWRkcmVzc2VzLAogICAgICAgIHJlbW90ZUFkZHJlc3M6IG51bGwsCiAgICAgICAgdG9rZW46IGRlbGF5ZWQgPyBudWxsIDogYy5wYXlsb2FkLnRva2VuKHNlcnZlckFkZHJlc3MpLAogICAgICAgIHJlbW90ZVRva2VuCiAgICAgIH0KICAgICkKICB9IGZpbmFsbHkgewogICAgLy8gZGVjcmVtZW50IGFzIHB1bmNoIGluY3JlbWVudHMgZm9yIHVzCiAgICBpZiAoaXNSYW5kb20pIGMuZGh0Ll9yYW5kb21QdW5jaGVzLS0KICB9CgogIGlmIChpc0RvbmUoYykpIHJldHVybgogIGlmICghcmVwbHkpIHJldHVybgoKICBpZiAocmVwbHkudHJ5TGF0ZXIpIHsKICAgIGF3YWl0IHRyeUxhdGVyKGMpCiAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4KICAgIHJldHVybiByb3VuZFB1bmNoKGMsIHNlcnZlckFkZHJlc3MsIHJlbW90ZVRva2VuLCBjbGllbnRSZWxheSwgc2VydmVyUmVsYXksIHRydWUpCiAgfQoKICBpZiAoIWMucHVuY2hlci5yZW1vdGVIb2xlcHVuY2hpbmcpIHsKICAgIHRocm93IFJFTU9URV9OT1RfSE9MRVBVTkNISU5HKCkKICB9CgogIGlmICghKGF3YWl0IGMucHVuY2hlci5wdW5jaCgpKSkgewogICAgdGhyb3cgUkVNT1RFX05PVF9IT0xFUFVOQ0hBQkxFKCkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHRyeUxhdGVyKGMpIHsKICBpZiAoIWMucmVsYXlUb2tlbikgdGhyb3cgSE9MRVBVTkNIX0FCT1JURUQoKQogIGF3YWl0IGMuc2xlZXBlci5wYXVzZSgxMDAwMCArIE1hdGgucm91bmQoTWF0aC5yYW5kb20oKSAqIDEwMDAwKSkKfQoKZnVuY3Rpb24gbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIGVycikgewogIGlmIChpc0RvbmUoYykpIHJldHVybgogIGlmIChjLmVuY3J5cHRlZFNvY2tldC5yYXdTdHJlYW0pIHJldHVybgogIGlmIChjLnJlbGF5U29ja2V0KSByZXR1cm4gLy8gd2FpdGluZyBmb3IgdGhlIHJlbGF5CiAgaWYgKGMucHVuY2hlciAmJiAhYy5wdW5jaGVyLmRlc3Ryb3llZCkgcmV0dXJuIC8vIHdhaXRpbmcgZm9yIHRoZSBwdW5jaGVyCiAgYy5zZXNzaW9uLmRlc3Ryb3koKQogIGMuZW5jcnlwdGVkU29ja2V0LmRlc3Ryb3koZXJyKQp9Cgphc3luYyBmdW5jdGlvbiBhYm9ydChjLCB7IHBlZXJBZGRyZXNzLCByZWxheUFkZHJlc3MgfSwgZXJyKSB7CiAgdHJ5IHsKICAgIGF3YWl0IHVwZGF0ZUhvbGVwdW5jaChwZWVyQWRkcmVzcywgcmVsYXlBZGRyZXNzLCB7CiAgICAgIGVycm9yOiBFUlJPUi5BQk9SVEVELAogICAgICBmaXJld2FsbDogRklSRVdBTEwuVU5LTk9XTiwKICAgICAgcm91bmQ6IGMucm91bmQrKywKICAgICAgY29ubmVjdGVkOiBmYWxzZSwKICAgICAgcHVuY2hpbmc6IGZhbHNlLAogICAgICBhZGRyZXNzZXM6IG51bGwsCiAgICAgIHJlbW90ZUFkZHJlc3M6IG51bGwsCiAgICAgIHRva2VuOiBudWxsLAogICAgICByZW1vdGVUb2tlbjogbnVsbAogICAgfSkKICB9IGNhdGNoIHt9CgogIGRlc3Ryb3lQdW5jaGVyKGMpCiAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIGVycikKfQoKZnVuY3Rpb24gcmVsYXlDb25uZWN0aW9uKGMsIHJlbGF5VGhyb3VnaCwgcGF5bG9hZCwgaHMpIHsKICBsZXQgaXNJbml0aWF0b3IKICBsZXQgcHVibGljS2V5CiAgbGV0IHRva2VuCgogIGlmIChwYXlsb2FkLnJlbGF5VGhyb3VnaCkgewogICAgaXNJbml0aWF0b3IgPSBmYWxzZQogICAgcHVibGljS2V5ID0gcGF5bG9hZC5yZWxheVRocm91Z2gucHVibGljS2V5CiAgICB0b2tlbiA9IHBheWxvYWQucmVsYXlUaHJvdWdoLnRva2VuCiAgfSBlbHNlIHsKICAgIGlzSW5pdGlhdG9yID0gdHJ1ZQogICAgcHVibGljS2V5ID0gcmVsYXlUaHJvdWdoCiAgICB0b2tlbiA9IGMucmVsYXlUb2tlbgogIH0KCiAgYy5yZWxheVRva2VuID0gdG9rZW4KICBjLnJlbGF5U29ja2V0ID0gYy5kaHQuY29ubmVjdChwdWJsaWNLZXkpCiAgYy5yZWxheVNvY2tldC5zZXRLZWVwQWxpdmUoYy5yZWxheUtlZXBBbGl2ZSkKICBjLnJlbGF5Q2xpZW50ID0gcmVsYXkuQ2xpZW50LmZyb20oYy5yZWxheVNvY2tldCwgeyBpZDogYy5yZWxheVNvY2tldC5wdWJsaWNLZXkgfSkKICBjLnJlbGF5VGltZW91dCA9IHNldFRpbWVvdXQob25hYm9ydCwgMTUwMDAsIG51bGwpCgogIGMucmVsYXlDbGllbnQucGFpcihpc0luaXRpYXRvciwgdG9rZW4sIGMucmF3U3RyZWFtKS5vbignZXJyb3InLCBvbmFib3J0KS5vbignZGF0YScsIG9uZGF0YSkKCiAgZnVuY3Rpb24gb25kYXRhKHJlbW90ZUlkKSB7CiAgICBpZiAoYy5yZWxheVRpbWVvdXQpIGNsZWFyUmVsYXlUaW1lb3V0KGMpCiAgICBpZiAoYy5yYXdTdHJlYW0gPT09IG51bGwpIHsKICAgICAgb25hYm9ydChudWxsKQogICAgICByZXR1cm4KICAgIH0KCiAgICBjLnJlbGF5UGFpcmVkID0gdHJ1ZQoKICAgIGNvbnN0IHsgcmVtb3RlUG9ydCwgcmVtb3RlSG9zdCwgc29ja2V0IH0gPSBjLnJlbGF5U29ja2V0LnJhd1N0cmVhbQoKICAgIGMucmF3U3RyZWFtCiAgICAgIC5vbignY2xvc2UnLCAoKSA9PiBjLnJlbGF5U29ja2V0LmRlc3Ryb3koKSkKICAgICAgLmNvbm5lY3Qoc29ja2V0LCByZW1vdGVJZCwgcmVtb3RlUG9ydCwgcmVtb3RlSG9zdCkKCiAgICBjLmVuY3J5cHRlZFNvY2tldC5zdGFydChjLnJhd1N0cmVhbSwgeyBoYW5kc2hha2U6IGhzIH0pCiAgfQoKICBmdW5jdGlvbiBvbmFib3J0KGVycikgewogICAgaWYgKGMucmVsYXlUaW1lb3V0KSBjbGVhclJlbGF5VGltZW91dChjKQogICAgY29uc3Qgc29ja2V0ID0gYy5yZWxheVNvY2tldAogICAgYy5yZWxheVRva2VuID0gbnVsbAogICAgYy5yZWxheVNvY2tldCA9IG51bGwKICAgIGlmIChzb2NrZXQpIHNvY2tldC5kZXN0cm95KCkKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBlcnIgfHwgUkVMQVlfQUJPUlRFRCgpKQogIH0KfQoKZnVuY3Rpb24gY2xlYXJQYXNzaXZlQ29ubmVjdFRpbWVvdXQoYykgewogIGNsZWFyVGltZW91dChjLnBhc3NpdmVDb25uZWN0VGltZW91dCkKICBjLnBhc3NpdmVDb25uZWN0VGltZW91dCA9IG51bGwKfQoKZnVuY3Rpb24gY2xlYXJSZWxheVRpbWVvdXQoYykgewogIGNsZWFyVGltZW91dChjLnJlbGF5VGltZW91dCkKICBjLnJlbGF5VGltZW91dCA9IG51bGwKfQoKZnVuY3Rpb24gZGVzdHJveVB1bmNoZXIoYykgewogIGlmIChjLnB1bmNoZXIpIGMucHVuY2hlci5kZXN0cm95KCkKICBjLnNlc3Npb24uZGVzdHJveSgpCn0KCmZ1bmN0aW9uIHBpY2tTZXJ2ZXJSZWxheShyZWxheXMsIGNsaWVudFJlbGF5KSB7CiAgZm9yIChjb25zdCByIG9mIHJlbGF5cykgewogICAgaWYgKCFkaWZmQWRkcmVzcyhyLnJlbGF5QWRkcmVzcywgY2xpZW50UmVsYXkpKSByZXR1cm4gcgogIH0KICByZXR1cm4gcmVsYXlzWzBdCn0KCmZ1bmN0aW9uIGRpZmZBZGRyZXNzKGEsIGIpIHsKICByZXR1cm4gYS5ob3N0ICE9PSBiLmhvc3QgfHwgYS5wb3J0ICE9PSBiLnBvcnQKfQoKZnVuY3Rpb24gZGVmYXVsdENyZWF0ZUhhbmRzaGFrZShrZXlQYWlyLCByZW1vdGVQdWJsaWNLZXkpIHsKICByZXR1cm4gbmV3IE5vaXNlV3JhcChrZXlQYWlyLCByZW1vdGVQdWJsaWNLZXkpCn0KCmZ1bmN0aW9uIGRlZmF1bHRDcmVhdGVTZWNyZXRTdHJlYW0oaXNJbml0aWF0b3IsIHJhd1N0cmVhbSwgb3B0cykgewogIHJldHVybiBuZXcgTm9pc2VTZWNyZXRTdHJlYW0oaXNJbml0aWF0b3IsIHJhd1N0cmVhbSwgb3B0cykKfQoKZnVuY3Rpb24gb25seVByaXZhdGVIb3N0cyhhZGRyKSB7CiAgcmV0dXJuIGlzUHJpdmF0ZShhZGRyLmhvc3QpCn0KCmZ1bmN0aW9uIGlzUmVsYXkocmVsYXlTb2NrZXQsIHNvY2tldCwgcG9ydCwgaG9zdCkgewogIGNvbnN0IHN0cmVhbSA9IHJlbGF5U29ja2V0LnJhd1N0cmVhbQogIGlmICghc3RyZWFtKSByZXR1cm4gZmFsc2UKICBpZiAoc3RyZWFtLnNvY2tldCAhPT0gc29ja2V0KSByZXR1cm4gZmFsc2UKICByZXR1cm4gcG9ydCA9PT0gc3RyZWFtLnJlbW90ZVBvcnQgJiYgaG9zdCA9PT0gc3RyZWFtLnJlbW90ZUhvc3QKfQoKZnVuY3Rpb24gc2VsZWN0UmVsYXkocmVsYXlUaHJvdWdoKSB7CiAgaWYgKHR5cGVvZiByZWxheVRocm91Z2ggPT09ICdmdW5jdGlvbicpIHJlbGF5VGhyb3VnaCA9IHJlbGF5VGhyb3VnaCgpCiAgaWYgKHJlbGF5VGhyb3VnaCA9PT0gbnVsbCkgcmV0dXJuIG51bGwKICBpZiAoQXJyYXkuaXNBcnJheShyZWxheVRocm91Z2gpKQogICAgcmV0dXJuIHJlbGF5VGhyb3VnaFtNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiByZWxheVRocm91Z2gubGVuZ3RoKV0KICByZXR1cm4gcmVsYXlUaHJvdWdoCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuL2Vycm9ycycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENvbm5lY3Rpb25Qb29sIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvcihkaHQpIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLl9kaHQgPSBkaHQKICAgIHRoaXMuX3NlcnZlcnMgPSBuZXcgTWFwKCkKICAgIHRoaXMuX2Nvbm5lY3RpbmcgPSBuZXcgTWFwKCkKICAgIHRoaXMuX2Nvbm5lY3Rpb25zID0gbmV3IE1hcCgpCiAgfQoKICBfYXR0YWNoU2VydmVyKHNlcnZlcikgewogICAgY29uc3Qga2V5U3RyaW5nID0gYjRhLnRvU3RyaW5nKHNlcnZlci5wdWJsaWNLZXksICdoZXgnKQoKICAgIHRoaXMuX3NlcnZlcnMuc2V0KGtleVN0cmluZywgc2VydmVyKQoKICAgIHNlcnZlcgogICAgICAub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICAgIHRoaXMuX3NlcnZlcnMuZGVsZXRlKGtleVN0cmluZykKICAgICAgfSkKICAgICAgLm9uKCdjb25uZWN0aW9uJywgKHNvY2tldCkgPT4gewogICAgICAgIHRoaXMuX2F0dGFjaFN0cmVhbShzb2NrZXQsIHRydWUpCiAgICAgIH0pCiAgfQoKICBfYXR0YWNoU3RyZWFtKHN0cmVhbSwgb3BlbmVkKSB7CiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuZ2V0KHN0cmVhbS5yZW1vdGVQdWJsaWNLZXkpCgogICAgaWYgKGV4aXN0aW5nKSB7CiAgICAgIGNvbnN0IGtlZXBOZXcgPQogICAgICAgIHN0cmVhbS5pc0luaXRpYXRvciA9PT0gZXhpc3RpbmcuaXNJbml0aWF0b3IgfHwKICAgICAgICBiNGEuY29tcGFyZShzdHJlYW0ucHVibGljS2V5LCBzdHJlYW0ucmVtb3RlUHVibGljS2V5KSA+IDAKCiAgICAgIGlmIChrZWVwTmV3KSB7CiAgICAgICAgbGV0IGNsb3NlZCA9IGZhbHNlCgogICAgICAgIGNvbnN0IG9uY2xvc2UgPSAoKSA9PiB7CiAgICAgICAgICBjbG9zZWQgPSB0cnVlCiAgICAgICAgfQoKICAgICAgICBleGlzdGluZwogICAgICAgICAgLm9uKCdlcnJvcicsIG5vb3ApCiAgICAgICAgICAub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICAgICAgICBpZiAoY2xvc2VkKSByZXR1cm4KCiAgICAgICAgICAgIHN0cmVhbS5vZmYoJ2Vycm9yJywgbm9vcCkub2ZmKCdjbG9zZScsIG9uY2xvc2UpCgogICAgICAgICAgICB0aGlzLl9hdHRhY2hTdHJlYW0oc3RyZWFtLCBvcGVuZWQpCiAgICAgICAgICB9KQogICAgICAgICAgLmRlc3Ryb3koZXJyb3JzLkRVUExJQ0FURV9DT05ORUNUSU9OKCkpCgogICAgICAgIHN0cmVhbS5vbignZXJyb3InLCBub29wKS5vbignY2xvc2UnLCBvbmNsb3NlKQogICAgICB9IGVsc2UgewogICAgICAgIHN0cmVhbS5vbignZXJyb3InLCBub29wKS5kZXN0cm95KGVycm9ycy5EVVBMSUNBVEVfQ09OTkVDVElPTigpKQogICAgICB9CgogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBzZXNzaW9uID0gbmV3IENvbm5lY3Rpb25SZWYodGhpcywgc3RyZWFtKQoKICAgIGNvbnN0IGtleVN0cmluZyA9IGI0YS50b1N0cmluZyhzdHJlYW0ucmVtb3RlUHVibGljS2V5LCAnaGV4JykKCiAgICBpZiAob3BlbmVkKSB7CiAgICAgIHRoaXMuX2Nvbm5lY3Rpb25zLnNldChrZXlTdHJpbmcsIHNlc3Npb24pCgogICAgICBzdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICAgIHRoaXMuX2Nvbm5lY3Rpb25zLmRlbGV0ZShrZXlTdHJpbmcpCiAgICAgIH0pCgogICAgICB0aGlzLmVtaXQoJ2Nvbm5lY3Rpb24nLCBzdHJlYW0sIHNlc3Npb24pCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9jb25uZWN0aW5nLnNldChrZXlTdHJpbmcsIHNlc3Npb24pCgogICAgICBzdHJlYW0KICAgICAgICAub24oJ2Vycm9yJywgbm9vcCkKICAgICAgICAub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICAgICAgaWYgKG9wZW5lZCkgdGhpcy5fY29ubmVjdGlvbnMuZGVsZXRlKGtleVN0cmluZykKICAgICAgICAgIGVsc2UgdGhpcy5fY29ubmVjdGluZy5kZWxldGUoa2V5U3RyaW5nKQogICAgICAgIH0pCiAgICAgICAgLm9uKCdvcGVuJywgKCkgPT4gewogICAgICAgICAgb3BlbmVkID0gdHJ1ZQoKICAgICAgICAgIHRoaXMuX2Nvbm5lY3RpbmcuZGVsZXRlKGtleVN0cmluZykKICAgICAgICAgIHRoaXMuX2Nvbm5lY3Rpb25zLnNldChrZXlTdHJpbmcsIHNlc3Npb24pCgogICAgICAgICAgc3RyZWFtLm9mZignZXJyb3InLCBub29wKQoKICAgICAgICAgIHRoaXMuZW1pdCgnY29ubmVjdGlvbicsIHN0cmVhbSwgc2Vzc2lvbikKICAgICAgICB9KQogICAgfQoKICAgIHJldHVybiBzZXNzaW9uCiAgfQoKICBnZXQgY29ubmVjdGluZygpIHsKICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW5nLnNpemUKICB9CgogIGdldCBjb25uZWN0aW9ucygpIHsKICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9ucy52YWx1ZXMoKQogIH0KCiAgaGFzKHB1YmxpY0tleSkgewogICAgY29uc3Qga2V5U3RyaW5nID0gYjRhLnRvU3RyaW5nKHB1YmxpY0tleSwgJ2hleCcpCgogICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb25zLmhhcyhrZXlTdHJpbmcpIHx8IHRoaXMuX2Nvbm5lY3RpbmcuaGFzKGtleVN0cmluZykKICB9CgogIGdldChwdWJsaWNLZXkpIHsKICAgIGNvbnN0IGtleVN0cmluZyA9IGI0YS50b1N0cmluZyhwdWJsaWNLZXksICdoZXgnKQoKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5fY29ubmVjdGlvbnMuZ2V0KGtleVN0cmluZykgfHwgdGhpcy5fY29ubmVjdGluZy5nZXQoa2V5U3RyaW5nKQoKICAgIHJldHVybiBleGlzdGluZz8uX3N0cmVhbSB8fCBudWxsCiAgfQp9CgpjbGFzcyBDb25uZWN0aW9uUmVmIHsKICBjb25zdHJ1Y3Rvcihwb29sLCBzdHJlYW0pIHsKICAgIHRoaXMuX3Bvb2wgPSBwb29sCiAgICB0aGlzLl9zdHJlYW0gPSBzdHJlYW0KICAgIHRoaXMuX3JlZnMgPSAwCiAgfQoKICBhY3RpdmUoKSB7CiAgICB0aGlzLl9yZWZzKysKICB9CgogIGluYWN0aXZlKCkgewogICAgdGhpcy5fcmVmcy0tCiAgfQoKICByZWxlYXNlKCkgewogICAgdGhpcy5fc3RyZWFtLmRlc3Ryb3koKQogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQoKY29uc3QgQ09NTUFORFMgPSAoZXhwb3J0cy5DT01NQU5EUyA9IHsKICBQRUVSX0hBTkRTSEFLRTogMCwKICBQRUVSX0hPTEVQVU5DSDogMSwKICBGSU5EX1BFRVI6IDIsCiAgTE9PS1VQOiAzLAogIEFOTk9VTkNFOiA0LAogIFVOQU5OT1VOQ0U6IDUsCiAgTVVUQUJMRV9QVVQ6IDYsCiAgTVVUQUJMRV9HRVQ6IDcsCiAgSU1NVVRBQkxFX1BVVDogOCwKICBJTU1VVEFCTEVfR0VUOiA5Cn0pCgpleHBvcnRzLkJPT1RTVFJBUF9OT0RFUyA9IGdsb2JhbC5QZWFyPy5jb25maWcuZGh0Py5ib290c3RyYXAgfHwgWwogICc4OC45OS4zLjg2QG5vZGUxLmh5cGVyZGh0Lm9yZzo0OTczNycsCiAgJzE0Mi45My45MC4xMTNAbm9kZTIuaHlwZXJkaHQub3JnOjQ5NzM3JywKICAnMTM4LjY4LjE0Ny44QG5vZGUzLmh5cGVyZGh0Lm9yZzo0OTczNycKXQoKZXhwb3J0cy5LTk9XTl9OT0RFUyA9IGdsb2JhbC5QZWFyPy5jb25maWcuZGh0Py5ub2RlcyB8fCBbXQoKZXhwb3J0cy5GSVJFV0FMTCA9IHsKICBVTktOT1dOOiAwLAogIE9QRU46IDEsCiAgQ09OU0lTVEVOVDogMiwKICBSQU5ET006IDMKfQoKZXhwb3J0cy5FUlJPUiA9IHsKICAvLyBub2lzZSAvIGNvbm5lY3Rpb24gcmVsYXRlZAogIE5PTkU6IDAsCiAgQUJPUlRFRDogMSwKICBWRVJTSU9OX01JU01BVENIOiAyLAogIFRSWV9MQVRFUjogMywKICAvLyBkaHQgcmVsYXRlZAogIFNFUV9SRVVTRUQ6IDE2LAogIFNFUV9UT09fTE9XOiAxNwp9Cgpjb25zdCBbTlNfQU5OT1VOQ0UsIE5TX1VOQU5OT1VOQ0UsIE5TX01VVEFCTEVfUFVULCBOU19QRUVSX0hBTkRTSEFLRSwgTlNfUEVFUl9IT0xFUFVOQ0hdID0KICBjcnlwdG8ubmFtZXNwYWNlKCdoeXBlcnN3YXJtL2RodCcsIFsKICAgIENPTU1BTkRTLkFOTk9VTkNFLAogICAgQ09NTUFORFMuVU5BTk5PVU5DRSwKICAgIENPTU1BTkRTLk1VVEFCTEVfUFVULAogICAgQ09NTUFORFMuUEVFUl9IQU5EU0hBS0UsCiAgICBDT01NQU5EUy5QRUVSX0hPTEVQVU5DSAogIF0pCgpleHBvcnRzLk5TID0gewogIEFOTk9VTkNFOiBOU19BTk5PVU5DRSwKICBVTkFOTk9VTkNFOiBOU19VTkFOTk9VTkNFLAogIE1VVEFCTEVfUFVUOiBOU19NVVRBQkxFX1BVVCwKICBQRUVSX0hBTkRTSEFLRTogTlNfUEVFUl9IQU5EU0hBS0UsCiAgUEVFUl9IT0xFUFVOQ0g6IE5TX1BFRVJfSE9MRVBVTkNICn0KY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpmdW5jdGlvbiBoYXNoKGRhdGEpIHsKICBjb25zdCBvdXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChvdXQsIGRhdGEpCiAgcmV0dXJuIG91dAp9CgpmdW5jdGlvbiB1bnNsYWJiZWRIYXNoKGRhdGEpIHsKICBjb25zdCBvdXQgPSBiNGEuYWxsb2NVbnNhZmVTbG93KDMyKQogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2gob3V0LCBkYXRhKQogIHJldHVybiBvdXQKfQoKZnVuY3Rpb24gY3JlYXRlS2V5UGFpcihzZWVkKSB7CiAgY29uc3QgcHVibGljS2V5ID0gYjRhLmFsbG9jKDMyKQogIGNvbnN0IHNlY3JldEtleSA9IGI0YS5hbGxvYyg2NCkKICBpZiAoc2VlZCkgc29kaXVtLmNyeXB0b19zaWduX3NlZWRfa2V5cGFpcihwdWJsaWNLZXksIHNlY3JldEtleSwgc2VlZCkKICBlbHNlIHNvZGl1bS5jcnlwdG9fc2lnbl9rZXlwYWlyKHB1YmxpY0tleSwgc2VjcmV0S2V5KQogIHJldHVybiB7IHB1YmxpY0tleSwgc2VjcmV0S2V5IH0KfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgaGFzaCwKICB1bnNsYWJiZWRIYXNoLAogIGNyZWF0ZUtleVBhaXIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjZW5jID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCgpmdW5jdGlvbiBlbmNvZGVVbnNsYWIoZW5jLCBtKSB7CiAgLy8gRmFzdGVyIHRoYW4gdW5zbGFiKGMuZW5jb2RlKGVuYywgZGF0YSkpIGJlY2F1c2UgaXQgYXZvaWRzIHRoZSBtZW0gY29weS4KICAvLyBNYWtlcyBzZW5zZSB0byBwdXQgaW4gY29tcGFjdC1lbmNvZGluZyB3aGVuIHdlIG5lZWQgaXQgaW4gb3RoZXIgbW9kdWxlcyB0b28KICBjb25zdCBzdGF0ZSA9IGNlbmMuc3RhdGUoKQogIGVuYy5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlU2xvdyhzdGF0ZS5lbmQpCiAgZW5jLmVuY29kZShzdGF0ZSwgbSkKICByZXR1cm4gc3RhdGUuYnVmZmVyCn0KCm1vZHVsZS5leHBvcnRzID0gewogIGVuY29kZVVuc2xhYgp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgREhURXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobXNnLCBjb2RlLCBmbiA9IERIVEVycm9yKSB7CiAgICBzdXBlcihgJHtjb2RlfTogJHttc2d9YCkKICAgIHRoaXMuY29kZSA9IGNvZGUKCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgZm4pCiAgICB9CiAgfQoKICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiAnREhURXJyb3InCiAgfQoKICBzdGF0aWMgQkFEX0hBTkRTSEFLRV9SRVBMWShtc2cgPSAnQmFkIGhhbmRzaGFrZSByZXBseScpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnQkFEX0hBTkRTSEFLRV9SRVBMWScsIERIVEVycm9yLkJBRF9IQU5EU0hBS0VfUkVQTFkpCiAgfQoKICBzdGF0aWMgQkFEX0hPTEVQVU5DSF9SRVBMWShtc2cgPSAnQmFkIGhvbGVwdW5jaCByZXBseScpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnQkFEX0hPTEVQVU5DSF9SRVBMWScsIERIVEVycm9yLkJBRF9IT0xFUFVOQ0hfUkVQTFkpCiAgfQoKICBzdGF0aWMgSE9MRVBVTkNIX0FCT1JURUQobXNnID0gJ0hvbGVwdW5jaCBhYm9ydGVkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdIT0xFUFVOQ0hfQUJPUlRFRCcsIERIVEVycm9yLkhPTEVQVU5DSF9BQk9SVEVEKQogIH0KCiAgc3RhdGljIEhPTEVQVU5DSF9JTlZBTElEKG1zZyA9ICdJbnZhbGlkIGhvbGVwdW5jaCBwYXlsb2FkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdIT0xFUFVOQ0hfSU5WQUxJRCcsIERIVEVycm9yLkhPTEVQVU5DSF9JTlZBTElEKQogIH0KCiAgc3RhdGljIEhPTEVQVU5DSF9QUk9CRV9USU1FT1VUKG1zZyA9ICdIb2xlcHVuY2hpbmcgcHJvYmUgZGlkIG5vdCBmaW5pc2ggaW4gdGltZScpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnSE9MRVBVTkNIX1BST0JFX1RJTUVPVVQnLCBESFRFcnJvci5IT0xFUFVOQ0hfUFJPQkVfVElNRU9VVCkKICB9CgogIHN0YXRpYyBIT0xFUFVOQ0hfRE9VQkxFX1JBTkRPTUlaRURfTkFUUyhtc2cgPSAnQm90aCByZW1vdGUgYW5kIGxvY2FsIE5BVHMgYXJlIHJhbmRvbWl6ZWQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKAogICAgICBtc2csCiAgICAgICdIT0xFUFVOQ0hfRE9VQkxFX1JBTkRPTUlaRURfTkFUUycsCiAgICAgIERIVEVycm9yLkhPTEVQVU5DSF9ET1VCTEVfUkFORE9NSVpFRF9OQVRTCiAgICApCiAgfQoKICBzdGF0aWMgQ0FOTk9UX0hPTEVQVU5DSChtc2cgPSAnQ2Fubm90IGhvbGVwdW5jaCB0byByZW1vdGUnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0NBTk5PVF9IT0xFUFVOQ0gnLCBESFRFcnJvci5DQU5OT1RfSE9MRVBVTkNIKQogIH0KCiAgc3RhdGljIFJFTU9URV9OT1RfSE9MRVBVTkNISU5HKG1zZyA9ICdSZW1vdGUgaXMgbm90IGhvbGVwdW5jaGluZycpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnUkVNT1RFX05PVF9IT0xFUFVOQ0hJTkcnLCBESFRFcnJvci5SRU1PVEVfTk9UX0hPTEVQVU5DSElORykKICB9CgogIHN0YXRpYyBSRU1PVEVfTk9UX0hPTEVQVU5DSEFCTEUobXNnID0gJ1JlbW90ZSBpcyBub3QgaG9sZXB1bmNoYWJsZScpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnUkVNT1RFX05PVF9IT0xFUFVOQ0hBQkxFJywgREhURXJyb3IuUkVNT1RFX05PVF9IT0xFUFVOQ0hBQkxFKQogIH0KCiAgc3RhdGljIFJFTU9URV9BQk9SVEVEKG1zZyA9ICdSZW1vdGUgYWJvcnRlZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnUkVNT1RFX0FCT1JURUQnLCBESFRFcnJvci5SRU1PVEVfQUJPUlRFRCkKICB9CgogIHN0YXRpYyBIQU5EU0hBS0VfVU5GSU5JU0hFRChtc2cgPSAnSGFuZHNoYWtlIGRpZCBub3QgZmluaXNoJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdIQU5EU0hBS0VfVU5GSU5JU0hFRCcsIERIVEVycm9yLkhBTkRTSEFLRV9VTkZJTklTSEVEKQogIH0KCiAgc3RhdGljIEhBTkRTSEFLRV9JTlZBTElEKG1zZyA9ICdSZWNlaXZlZCBpbnZhbGlkIGhhbmRzaGFrZScpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnSEFORFNIQUtFX0lOVkFMSUQnLCBESFRFcnJvci5IQU5EU0hBS0VfSU5WQUxJRCkKICB9CgogIHN0YXRpYyBBTFJFQURZX0xJU1RFTklORyhtc2cgPSAnQWxyZWFkeSBsaXN0ZW5pbmcnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0FMUkVBRFlfTElTVEVOSU5HJywgREhURXJyb3IuQUxSRUFEWV9MSVNURU5JTkcpCiAgfQoKICBzdGF0aWMgS0VZUEFJUl9BTFJFQURZX1VTRUQobXNnID0gJ0tleXBhaXIgYWxyZWFkeSB1c2VkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdLRVlQQUlSX0FMUkVBRFlfVVNFRCcsIERIVEVycm9yLktFWVBBSVJfQUxSRUFEWV9VU0VEKQogIH0KCiAgc3RhdGljIE5PREVfREVTVFJPWUVEKG1zZyA9ICdOb2RlIGRlc3Ryb3llZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnTk9ERV9ERVNUUk9ZRUQnLCBESFRFcnJvci5OT0RFX0RFU1RST1lFRCkKICB9CgogIHN0YXRpYyBQRUVSX0NPTk5FQ1RJT05fRkFJTEVEKG1zZyA9ICdDb3VsZCBub3QgY29ubmVjdCB0byBwZWVyJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdQRUVSX0NPTk5FQ1RJT05fRkFJTEVEJywgREhURXJyb3IuUEVFUl9DT05ORUNUSU9OX0ZBSUxFRCkKICB9CgogIHN0YXRpYyBQRUVSX05PVF9GT1VORChtc2cgPSAnUGVlciBub3QgZm91bmQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ1BFRVJfTk9UX0ZPVU5EJywgREhURXJyb3IuUEVFUl9OT1RfRk9VTkQpCiAgfQoKICBzdGF0aWMgU1RSRUFNX05PVF9DT05ORUNURUQobXNnID0gJ1N0cmVhbSBpcyBub3QgY29ubmVjdGVkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdTVFJFQU1fTk9UX0NPTk5FQ1RFRCcsIERIVEVycm9yLlNUUkVBTV9ESVNDT05ORUNURUQpCiAgfQoKICBzdGF0aWMgU0VSVkVSX0lOQ09NUEFUSUJMRShtc2cgPSAnU2VydmVyIGlzIHVzaW5nIGFuIGluY29tcGF0aWJsZSB2ZXJzaW9uJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdTRVJWRVJfSU5DT01QQVRJQkxFJywgREhURXJyb3IuU0VSVkVSX0lOQ09NUEFUSUJMRSkKICB9CgogIHN0YXRpYyBTRVJWRVJfRVJST1IobXNnID0gJ1NlcnZlciByZXR1cm5lZCBhbiBlcnJvcicpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnU0VSVkVSX0VSUk9SJywgREhURXJyb3IuU0VSVkVSX0VSUk9SKQogIH0KCiAgc3RhdGljIERVUExJQ0FURV9DT05ORUNUSU9OKG1zZyA9ICdEdXBsaWNhdGUgY29ubmVjdGlvbicpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnRFVQTElDQVRFX0NPTk5FQ1RJT04nLCBESFRFcnJvci5EVVBMSUNBVEVfQ09OTkVDVElPTikKICB9CgogIHN0YXRpYyBSRUxBWV9BQk9SVEVEKG1zZyA9ICdSZWxheSBhYm9ydGVkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdSRUxBWV9BQk9SVEVEJywgREhURXJyb3IuUkVMQVlfQUJPUlRFRCkKICB9CgogIHN0YXRpYyBTVVNQRU5ERUQobXNnID0gJ1N1c3BlbmRlZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnU1VTUEVOREVEJywgREhURXJyb3IuU1VTUEVOREVEKQogIH0KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBOYXQgPSByZXF1aXJlKCcuL25hdCcpCmNvbnN0IFNsZWVwZXIgPSByZXF1aXJlKCcuL3NsZWVwZXInKQpjb25zdCB7IEZJUkVXQUxMIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgpjb25zdCBCSVJUSERBWV9TT0NLRVRTID0gMjU2CmNvbnN0IEhPTEVQVU5DSCA9IGI0YS5mcm9tKFswXSkKY29uc3QgSE9MRVBVTkNIX1RUTCA9IDUKY29uc3QgREVGQVVMVF9UVEwgPSA2NApjb25zdCBNQVhfUkVPUEVOUyA9IDMKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgSG9sZXB1bmNoZXIgewogIGNvbnN0cnVjdG9yKGRodCwgc2Vzc2lvbiwgaXNJbml0aWF0b3IsIHJlbW90ZUZpcmV3YWxsID0gRklSRVdBTEwuVU5LTk9XTikgewogICAgY29uc3QgaG9sZGVyID0gZGh0Ll9zb2NrZXRQb29sLmFjcXVpcmUoKQoKICAgIHRoaXMuZGh0ID0gZGh0CiAgICB0aGlzLnNlc3Npb24gPSBzZXNzaW9uCgogICAgdGhpcy5uYXQgPSBuZXcgTmF0KGRodCwgc2Vzc2lvbiwgaG9sZGVyLnNvY2tldCkKICAgIHRoaXMubmF0LmF1dG9TYW1wbGUoKQoKICAgIHRoaXMuaXNJbml0aWF0b3IgPSBpc0luaXRpYXRvcgoKICAgIC8vIGV2ZW50cwogICAgdGhpcy5vbmNvbm5lY3QgPSBub29wCiAgICB0aGlzLm9uYWJvcnQgPSBub29wCgogICAgdGhpcy5wdW5jaGluZyA9IGZhbHNlCiAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLnJhbmRvbWl6ZWQgPSBmYWxzZQoKICAgIC8vIHRyYWNrIHJlbW90ZSBzdGF0ZQogICAgdGhpcy5yZW1vdGVGaXJld2FsbCA9IHJlbW90ZUZpcmV3YWxsCiAgICB0aGlzLnJlbW90ZUFkZHJlc3NlcyA9IFtdCiAgICB0aGlzLnJlbW90ZUhvbGVwdW5jaGluZyA9IGZhbHNlCgogICAgdGhpcy5fc2xlZXBlciA9IG5ldyBTbGVlcGVyKCkKICAgIHRoaXMuX3Jlb3BlbmluZyA9IG51bGwKICAgIHRoaXMuX3RpbWVvdXQgPSBudWxsCiAgICB0aGlzLl9wdW5jaGluZyA9IG51bGwKICAgIHRoaXMuX2FsbEhvbGRlcnMgPSBbXQogICAgdGhpcy5faG9sZGVyID0gdGhpcy5fYWRkUmVmKGhvbGRlcikKICB9CgogIGdldCBzb2NrZXQoKSB7CiAgICByZXR1cm4gdGhpcy5faG9sZGVyLnNvY2tldAogIH0KCiAgdXBkYXRlUmVtb3RlKHsgcHVuY2hpbmcsIGZpcmV3YWxsLCBhZGRyZXNzZXMsIHZlcmlmaWVkIH0pIHsKICAgIGNvbnN0IHJlbW90ZUFkZHJlc3NlcyA9IFtdCgogICAgaWYgKGFkZHJlc3NlcykgewogICAgICBmb3IgKGNvbnN0IGFkZHIgb2YgYWRkcmVzc2VzKSB7CiAgICAgICAgcmVtb3RlQWRkcmVzc2VzLnB1c2goewogICAgICAgICAgaG9zdDogYWRkci5ob3N0LAogICAgICAgICAgcG9ydDogYWRkci5wb3J0LAogICAgICAgICAgdmVyaWZpZWQ6IHZlcmlmaWVkID09PSBhZGRyLmhvc3QgfHwgdGhpcy5faXNWZXJpZmllZChhZGRyLmhvc3QpCiAgICAgICAgfSkKICAgICAgfQogICAgfQoKICAgIHRoaXMucmVtb3RlRmlyZXdhbGwgPSBmaXJld2FsbAogICAgdGhpcy5yZW1vdGVBZGRyZXNzZXMgPSByZW1vdGVBZGRyZXNzZXMKICAgIHRoaXMucmVtb3RlSG9sZXB1bmNoaW5nID0gcHVuY2hpbmcKICB9CgogIF9pc1ZlcmlmaWVkKGhvc3QpIHsKICAgIGZvciAoY29uc3QgYWRkciBvZiB0aGlzLnJlbW90ZUFkZHJlc3NlcykgewogICAgICBpZiAoYWRkci52ZXJpZmllZCAmJiBhZGRyLmhvc3QgPT09IGhvc3QpIHsKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2UKICB9CgogIHBpbmcoYWRkciwgc29ja2V0ID0gdGhpcy5faG9sZGVyLnNvY2tldCkgewogICAgcmV0dXJuIGhvbGVwdW5jaChzb2NrZXQsIGFkZHIsIGZhbHNlKQogIH0KCiAgb3BlblNlc3Npb24oYWRkciwgc29ja2V0ID0gdGhpcy5faG9sZGVyLnNvY2tldCkgewogICAgcmV0dXJuIGhvbGVwdW5jaChzb2NrZXQsIGFkZHIsIHRydWUpCiAgfQoKICBhc3luYyBhbmFseXplKGFsbG93UmVvcGVuKSB7CiAgICBhd2FpdCB0aGlzLm5hdC5hbmFseXppbmcKICAgIGlmICh0aGlzLl91bnN0YWJsZSgpKSB7CiAgICAgIGlmICghYWxsb3dSZW9wZW4pIHJldHVybiBmYWxzZQogICAgICBpZiAoIXRoaXMuX3Jlb3BlbmluZykgdGhpcy5fcmVvcGVuaW5nID0gdGhpcy5fcmVvcGVuKCkKICAgICAgcmV0dXJuIHRoaXMuX3Jlb3BlbmluZwogICAgfQogICAgcmV0dXJuIHRydWUKICB9CgogIF91bnN0YWJsZSgpIHsKICAgIC8vIFRPRE8hITogV2UgbmVlZCBhbiBhZGRpdGlvbmFsIGhldXJpc3RpYyBoZXJlLi4uIElmIHdlIHdlcmUgTk9UIHJhbmRvbSBpbiB0aGUgcGFzdCB3ZSBzaG91bGQgYWxzbyBkbyB0aGlzLgogICAgY29uc3QgZmlyZXdhbGwgPSB0aGlzLm5hdC5maXJld2FsbAogICAgcmV0dXJuICgKICAgICAgKHRoaXMucmVtb3RlRmlyZXdhbGwgPj0gRklSRVdBTEwuUkFORE9NICYmIGZpcmV3YWxsID49IEZJUkVXQUxMLlJBTkRPTSkgfHwKICAgICAgZmlyZXdhbGwgPT09IEZJUkVXQUxMLlVOS05PV04KICAgICkKICB9CgogIF9yZXNldCgpIHsKICAgIGNvbnN0IHByZXYgPSB0aGlzLl9ob2xkZXIKCiAgICB0aGlzLl9hbGxIb2xkZXJzLnBvcCgpCiAgICB0aGlzLl9ob2xkZXIgPSB0aGlzLl9hZGRSZWYodGhpcy5kaHQuX3NvY2tldFBvb2wuYWNxdWlyZSgpKQoKICAgIHByZXYucmVsZWFzZSgpCiAgICB0aGlzLm5hdC5kZXN0cm95KCkKCiAgICB0aGlzLm5hdCA9IG5ldyBOYXQodGhpcy5kaHQsIHRoaXMuc2Vzc2lvbiwgdGhpcy5faG9sZGVyLnNvY2tldCkKICAgIC8vIFRPRE86IG1heWJlIG1ha2UgYXV0byBzYW1wbGluZyBjb25maWd1cmFibGUgc29tZWhvdz8KICAgIHRoaXMubmF0LmF1dG9TYW1wbGUoKQogIH0KCiAgX2FkZFJlZihyZWYpIHsKICAgIHRoaXMuX2FsbEhvbGRlcnMucHVzaChyZWYpCiAgICByZWYub25ob2xlcHVuY2htZXNzYWdlID0gKG1zZywgcmluZm8pID0+IHRoaXMuX29uaG9sZXB1bmNobWVzc2FnZShtc2csIHJpbmZvLCByZWYpCiAgICByZXR1cm4gcmVmCiAgfQoKICBfb25ob2xlcHVuY2htZXNzYWdlKF8sIGFkZHIsIHJlZikgewogICAgaWYgKCF0aGlzLmlzSW5pdGlhdG9yKSB7CiAgICAgIC8vIFRPRE86IHdlIGRvbid0IG5lZWQgdGhpcyBpZiB3ZSBoYWQgYSB3YXkgdG8gY29ubmVjdCBhIHNvY2tldCB0byBtYW55IGhvc3RzCiAgICAgIGhvbGVwdW5jaChyZWYuc29ja2V0LCBhZGRyLCBmYWxzZSkgLy8gbmV2ZXIgZmFpbHMKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMuY29ubmVjdGVkKSByZXR1cm4KCiAgICB0aGlzLmNvbm5lY3RlZCA9IHRydWUKICAgIHRoaXMucHVuY2hpbmcgPSBmYWxzZQoKICAgIGZvciAoY29uc3QgciBvZiB0aGlzLl9hbGxIb2xkZXJzKSB7CiAgICAgIGlmIChyID09PSByZWYpIGNvbnRpbnVlCiAgICAgIHIucmVsZWFzZSgpCiAgICB9CgogICAgdGhpcy5fYWxsSG9sZGVyc1swXSA9IHJlZgogICAgd2hpbGUgKHRoaXMuX2FsbEhvbGRlcnMubGVuZ3RoID4gMSkgdGhpcy5fYWxsSG9sZGVycy5wb3AoKQoKICAgIHRoaXMuX2RlY3JlbWVudFJhbmRvbWl6ZWQoKQogICAgdGhpcy5vbmNvbm5lY3QocmVmLnNvY2tldCwgYWRkci5wb3J0LCBhZGRyLmhvc3QpCiAgfQoKICBfZG9uZSgpIHsKICAgIHJldHVybiB0aGlzLmRlc3Ryb3llZCB8fCB0aGlzLmNvbm5lY3RlZAogIH0KCiAgYXN5bmMgX3Jlb3BlbigpIHsKICAgIGZvciAobGV0IGkgPSAwOyB0aGlzLl91bnN0YWJsZSgpICYmIGkgPCBNQVhfUkVPUEVOUyAmJiAhdGhpcy5fZG9uZSgpICYmICF0aGlzLnB1bmNoaW5nOyBpKyspIHsKICAgICAgdGhpcy5fcmVzZXQoKQogICAgICBhd2FpdCB0aGlzLm5hdC5hbmFseXppbmcKICAgIH0KCiAgICByZXR1cm4gY29lcmNlRmlyZXdhbGwodGhpcy5uYXQuZmlyZXdhbGwpID09PSBGSVJFV0FMTC5DT05TSVNURU5UCiAgfQoKICBwdW5jaCgpIHsKICAgIGlmICghdGhpcy5fcHVuY2hpbmcpIHRoaXMuX3B1bmNoaW5nID0gdGhpcy5fcHVuY2goKQogICAgcmV0dXJuIHRoaXMuX3B1bmNoaW5nCiAgfQoKICBhc3luYyBfcHVuY2goKSB7CiAgICBpZiAodGhpcy5fZG9uZSgpIHx8ICF0aGlzLnJlbW90ZUFkZHJlc3Nlcy5sZW5ndGgpIHJldHVybiBmYWxzZQoKICAgIHRoaXMucHVuY2hpbmcgPSB0cnVlCgogICAgLy8gQ29lcmNlIGludG8gY29uc2lzdGVuY3kgZm9yIG5vdy4gT2J2cyB3ZSBjb3VsZCBtYWtlIHRoaXMgdGhpcyBtb3JlIGVmZmljaWVudCBpZiB3ZSB1c2UgdGhhdCBpbmZvCiAgICAvLyBidXQgdGhhdCdzIHNlbGRvbWx5IHVzZWQgc2luY2UgdGhvc2Ugd2lsbCBqdXN0IHVzZSB0Y3AgbW9zdCBvZiB0aGUgdGltZS4KCiAgICBjb25zdCBsb2NhbCA9IGNvZXJjZUZpcmV3YWxsKHRoaXMubmF0LmZpcmV3YWxsKQogICAgY29uc3QgcmVtb3RlID0gY29lcmNlRmlyZXdhbGwodGhpcy5yZW1vdGVGaXJld2FsbCkKCiAgICAvLyBOb3RlIHRoYXQgbW9zdCBvZiB0aGVzZSBhc3luYyBmdW5jdGlvbnMgYXJlIG1lYW50IHRvIHJ1biBpbiB0aGUgYmFja2dyb3VuZAogICAgLy8gd2hpY2ggaXMgd2h5IHdlIGRvbid0IGF3YWl0IHRoZW0gaGVyZSBhbmQgd2h5IHRoZXkgYXJlIG5vdCBhbGxvd2VkIHRvIHRocm93CgogICAgbGV0IHJlbW90ZVZlcmlmaWVkQWRkcmVzcyA9IG51bGwKICAgIGZvciAoY29uc3QgYWRkciBvZiB0aGlzLnJlbW90ZUFkZHJlc3NlcykgewogICAgICBpZiAoYWRkci52ZXJpZmllZCkgewogICAgICAgIHJlbW90ZVZlcmlmaWVkQWRkcmVzcyA9IGFkZHIKICAgICAgICBicmVhawogICAgICB9CiAgICB9CgogICAgaWYgKGxvY2FsID09PSBGSVJFV0FMTC5DT05TSVNURU5UICYmIHJlbW90ZSA9PT0gRklSRVdBTEwuQ09OU0lTVEVOVCkgewogICAgICB0aGlzLmRodC5zdGF0cy5wdW5jaGVzLmNvbnNpc3RlbnQrKwogICAgICB0aGlzLl9jb25zaXN0ZW50UHJvYmUoKQogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGlmICghcmVtb3RlVmVyaWZpZWRBZGRyZXNzKSByZXR1cm4gZmFsc2UKCiAgICBpZiAobG9jYWwgPT09IEZJUkVXQUxMLkNPTlNJU1RFTlQgJiYgcmVtb3RlID49IEZJUkVXQUxMLlJBTkRPTSkgewogICAgICB0aGlzLmRodC5zdGF0cy5wdW5jaGVzLnJhbmRvbSsrCiAgICAgIHRoaXMuX2luY3JlbWVudFJhbmRvbWl6ZWQoKQogICAgICB0aGlzLl9yYW5kb21Qcm9iZXMocmVtb3RlVmVyaWZpZWRBZGRyZXNzKQogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGlmIChsb2NhbCA+PSBGSVJFV0FMTC5SQU5ET00gJiYgcmVtb3RlID09PSBGSVJFV0FMTC5DT05TSVNURU5UKSB7CiAgICAgIHRoaXMuZGh0LnN0YXRzLnB1bmNoZXMucmFuZG9tKysKICAgICAgdGhpcy5faW5jcmVtZW50UmFuZG9taXplZCgpCiAgICAgIGF3YWl0IHRoaXMuX29wZW5CaXJ0aGRheVNvY2tldHMocmVtb3RlVmVyaWZpZWRBZGRyZXNzKQogICAgICBpZiAodGhpcy5wdW5jaGluZykgdGhpcy5fa2VlcEFsaXZlUmFuZG9tTmF0KHJlbW90ZVZlcmlmaWVkQWRkcmVzcykKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIC8vIE5vdGUgdGhhdCB0aGlzIG5ldmVyIHRocm93cyBzbyBpdCBpcyBzYWZlIHRvIHJ1biBpbiB0aGUgYmFja2dyb3VuZAogIGFzeW5jIF9jb25zaXN0ZW50UHJvYmUoKSB7CiAgICAvLyBIZXJlIHdlIGRvIHRoZSBzbGVlcCBmaXJzdCBiZWNhdXNlIHRoZSAiZmFzdCBvcGVuIiBtb2RlIGluIHRoZSBzZXJ2ZXIganVzdCBmaXJlZCBhIHBpbmcKICAgIGlmICghdGhpcy5pc0luaXRpYXRvcikgYXdhaXQgdGhpcy5fc2xlZXBlci5wYXVzZSgxMDAwKQoKICAgIGxldCB0cmllcyA9IDAKCiAgICB3aGlsZSAodGhpcy5wdW5jaGluZyAmJiB0cmllcysrIDwgMTApIHsKICAgICAgZm9yIChjb25zdCBhZGRyIG9mIHRoaXMucmVtb3RlQWRkcmVzc2VzKSB7CiAgICAgICAgLy8gb25seSB0cnkgdW52ZXJpZmllZCBhZGRyZXNzZXMgZXZlcnkgNCB0aWNrcwogICAgICAgIGlmICghYWRkci52ZXJpZmllZCAmJiAodHJpZXMgJiAzKSAhPT0gMCkgY29udGludWUKICAgICAgICBhd2FpdCBob2xlcHVuY2godGhpcy5faG9sZGVyLnNvY2tldCwgYWRkciwgZmFsc2UpCiAgICAgIH0KICAgICAgaWYgKHRoaXMucHVuY2hpbmcpIGF3YWl0IHRoaXMuX3NsZWVwZXIucGF1c2UoMTAwMCkKICAgIH0KCiAgICB0aGlzLl9hdXRvRGVzdHJveSgpCiAgfQoKICAvLyBOb3RlIHRoYXQgdGhpcyBuZXZlciB0aHJvd3Mgc28gaXQgaXMgc2FmZSB0byBydW4gaW4gdGhlIGJhY2tncm91bmQKICBhc3luYyBfcmFuZG9tUHJvYmVzKHJlbW90ZUFkZHIpIHsKICAgIGxldCB0cmllcyA9IDE3NTAgLy8gfjM1cwoKICAgIHdoaWxlICh0aGlzLnB1bmNoaW5nICYmIHRyaWVzLS0gPiAwKSB7CiAgICAgIGNvbnN0IGFkZHIgPSB7IGhvc3Q6IHJlbW90ZUFkZHIuaG9zdCwgcG9ydDogcmFuZG9tUG9ydCgpIH0KICAgICAgYXdhaXQgaG9sZXB1bmNoKHRoaXMuX2hvbGRlci5zb2NrZXQsIGFkZHIsIGZhbHNlKQogICAgICBpZiAodGhpcy5wdW5jaGluZykgYXdhaXQgdGhpcy5fc2xlZXBlci5wYXVzZSgyMCkKICAgIH0KCiAgICB0aGlzLl9hdXRvRGVzdHJveSgpCiAgfQoKICAvLyBOb3RlIHRoYXQgdGhpcyBuZXZlciB0aHJvd3Mgc28gaXQgaXMgc2FmZSB0byBydW4gaW4gdGhlIGJhY2tncm91bmQKICBhc3luYyBfa2VlcEFsaXZlUmFuZG9tTmF0KHJlbW90ZUFkZHIpIHsKICAgIGxldCBpID0gMAogICAgbGV0IGxvd1RUTFJvdW5kcyA9IDEKCiAgICAvLyBUT0RPOiBleHBlcmltZW50IHdpdGggdGhpcyBoZXJlLiBXZSBqdXN0IGJ1cnN0ZWQgYWxsIHRoZSBtZXNzYWdlcyBpbgogICAgLy8gb3Blbk90aGVyU29ja2V0cyB0byBlbnN1cmUgdGhlIHNvY2tldHMgYXJlIG9wZW4sIHNvIGl0J3MgcG90ZW50aWFsbHkKICAgIC8vIGEgZ29vZCBpZGVhIHRvIHNsb3cgZG93biBmb3IgYSBiaXQuCiAgICBhd2FpdCB0aGlzLl9zbGVlcGVyLnBhdXNlKDEwMCkKCiAgICBsZXQgdHJpZXMgPSAxNzUwIC8vIH4zNXMKCiAgICB3aGlsZSAodGhpcy5wdW5jaGluZyAmJiB0cmllcy0tID4gMCkgewogICAgICBpZiAoaSA9PT0gdGhpcy5fYWxsSG9sZGVycy5sZW5ndGgpIHsKICAgICAgICBpID0gMAogICAgICAgIGlmIChsb3dUVExSb3VuZHMgPiAwKSBsb3dUVExSb3VuZHMtLQogICAgICB9CgogICAgICBhd2FpdCBob2xlcHVuY2godGhpcy5fYWxsSG9sZGVyc1tpKytdLnNvY2tldCwgcmVtb3RlQWRkciwgbG93VFRMUm91bmRzID4gMCkKICAgICAgaWYgKHRoaXMucHVuY2hpbmcpIGF3YWl0IHRoaXMuX3NsZWVwZXIucGF1c2UoMjApCiAgICB9CgogICAgdGhpcy5fYXV0b0Rlc3Ryb3koKQogIH0KCiAgYXN5bmMgX29wZW5CaXJ0aGRheVNvY2tldHMocmVtb3RlQWRkcikgewogICAgd2hpbGUgKHRoaXMucHVuY2hpbmcgJiYgdGhpcy5fYWxsSG9sZGVycy5sZW5ndGggPCBCSVJUSERBWV9TT0NLRVRTKSB7CiAgICAgIGNvbnN0IHJlZiA9IHRoaXMuX2FkZFJlZih0aGlzLmRodC5fc29ja2V0UG9vbC5hY3F1aXJlKCkpCiAgICAgIGF3YWl0IGhvbGVwdW5jaChyZWYuc29ja2V0LCByZW1vdGVBZGRyLCBIT0xFUFVOQ0hfVFRMKQogICAgfQogIH0KCiAgX2F1dG9EZXN0cm95KCkgewogICAgaWYgKCF0aGlzLmNvbm5lY3RlZCkgdGhpcy5kZXN0cm95KCkKICB9CgogIF9pbmNyZW1lbnRSYW5kb21pemVkKCkgewogICAgaWYgKCF0aGlzLnJhbmRvbWl6ZWQpIHsKICAgICAgdGhpcy5yYW5kb21pemVkID0gdHJ1ZQogICAgICB0aGlzLmRodC5fcmFuZG9tUHVuY2hlcysrCiAgICB9CiAgfQoKICBfZGVjcmVtZW50UmFuZG9taXplZCgpIHsKICAgIGlmICh0aGlzLnJhbmRvbWl6ZWQpIHsKICAgICAgdGhpcy5kaHQuX2xhc3RSYW5kb21QdW5jaCA9IERhdGUubm93KCkKICAgICAgdGhpcy5yYW5kb21pemVkID0gZmFsc2UKICAgICAgdGhpcy5kaHQuX3JhbmRvbVB1bmNoZXMtLQogICAgfQogIH0KCiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICAgIHRoaXMucHVuY2hpbmcgPSBmYWxzZQoKICAgIGZvciAoY29uc3QgcmVmIG9mIHRoaXMuX2FsbEhvbGRlcnMpIHJlZi5yZWxlYXNlKCkKICAgIHRoaXMuX2FsbEhvbGRlcnMgPSBbXQogICAgdGhpcy5uYXQuZGVzdHJveSgpCgogICAgaWYgKCF0aGlzLmNvbm5lY3RlZCkgewogICAgICB0aGlzLl9kZWNyZW1lbnRSYW5kb21pemVkKCkKICAgICAgdGhpcy5vbmFib3J0KCkKICAgIH0KICB9CgogIHN0YXRpYyBwaW5nKHNvY2tldCwgYWRkcikgewogICAgcmV0dXJuIGhvbGVwdW5jaChzb2NrZXQsIGFkZHIsIGZhbHNlKQogIH0KCiAgc3RhdGljIGxvY2FsQWRkcmVzc2VzKHNvY2tldCkgewogICAgcmV0dXJuIGxvY2FsQWRkcmVzc2VzKHNvY2tldCkKICB9CgogIHN0YXRpYyBtYXRjaEFkZHJlc3MobXlBZGRyZXNzZXMsIGV4dGVybmFsQWRkcmVzc2VzKSB7CiAgICByZXR1cm4gbWF0Y2hBZGRyZXNzKG15QWRkcmVzc2VzLCBleHRlcm5hbEFkZHJlc3NlcykKICB9Cn0KCmZ1bmN0aW9uIGhvbGVwdW5jaChzb2NrZXQsIGFkZHIsIGxvd1RUTCkgewogIHJldHVybiBzb2NrZXQuc2VuZChIT0xFUFVOQ0gsIGFkZHIucG9ydCwgYWRkci5ob3N0LCBsb3dUVEwgPyBIT0xFUFVOQ0hfVFRMIDogREVGQVVMVF9UVEwpCn0KCmZ1bmN0aW9uIHJhbmRvbVBvcnQoKSB7CiAgcmV0dXJuICgxMDAwICsgTWF0aC5yYW5kb20oKSAqIDY0NTM2KSB8IDAKfQoKZnVuY3Rpb24gY29lcmNlRmlyZXdhbGwoZncpIHsKICByZXR1cm4gZncgPT09IEZJUkVXQUxMLk9QRU4gPyBGSVJFV0FMTC5DT05TSVNURU5UIDogZncKfQoKZnVuY3Rpb24gbG9jYWxBZGRyZXNzZXMoc29ja2V0KSB7CiAgY29uc3QgYWRkcnMgPSBbXQogIGNvbnN0IHsgaG9zdCwgcG9ydCB9ID0gc29ja2V0LmFkZHJlc3MoKQoKICBpZiAoaG9zdCA9PT0gJzEyNy4wLjAuMScpIHJldHVybiBbeyBob3N0LCBwb3J0IH1dCgogIGZvciAoY29uc3QgbiBvZiBzb2NrZXQudWR4Lm5ldHdvcmtJbnRlcmZhY2VzKCkpIHsKICAgIGlmIChuLmZhbWlseSAhPT0gNCB8fCBuLmludGVybmFsKSBjb250aW51ZQoKICAgIGFkZHJzLnB1c2goeyBob3N0OiBuLmhvc3QsIHBvcnQgfSkKICB9CgogIGlmIChhZGRycy5sZW5ndGggPT09IDApIHsKICAgIGFkZHJzLnB1c2goeyBob3N0OiAnMTI3LjAuMC4xJywgcG9ydCB9KQogIH0KCiAgcmV0dXJuIGFkZHJzCn0KCmZ1bmN0aW9uIG1hdGNoQWRkcmVzcyhsb2NhbEFkZHJlc3NlcywgcmVtb3RlTG9jYWxBZGRyZXNzZXMpIHsKICBpZiAocmVtb3RlTG9jYWxBZGRyZXNzZXMubGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbAoKICBsZXQgYmVzdCA9IHsgc2VnbWVudDogMSwgYWRkcjogbnVsbCB9CgogIGZvciAoY29uc3QgbG9jYWxBZGRyZXNzIG9mIGxvY2FsQWRkcmVzc2VzKSB7CiAgICAvLyA9PiAxOTIuMTY4LjEyMi4yMzgKICAgIGNvbnN0IGEgPSBsb2NhbEFkZHJlc3MuaG9zdC5zcGxpdCgnLicpCgogICAgZm9yIChjb25zdCByZW1vdGVBZGRyZXNzIG9mIHJlbW90ZUxvY2FsQWRkcmVzc2VzKSB7CiAgICAgIC8vID0+IDE5Mi4xNjguMC4yMwogICAgICAvLyA9PiAxOTIuMTY4LjEyMi4xCiAgICAgIGNvbnN0IGIgPSByZW1vdGVBZGRyZXNzLmhvc3Quc3BsaXQoJy4nKQoKICAgICAgLy8gTWF0Y2hlcyAxOTIuKi4qLioKICAgICAgaWYgKGFbMF0gPT09IGJbMF0pIHsKICAgICAgICBpZiAoYmVzdC5zZWdtZW50ID09PSAxKSBiZXN0ID0geyBzZWdtZW50OiAyLCBhZGRyOiByZW1vdGVBZGRyZXNzIH0KCiAgICAgICAgLy8gTWF0Y2hlcyAxOTIuMTY4LiouKgogICAgICAgIGlmIChhWzFdID09PSBiWzFdKSB7CiAgICAgICAgICBpZiAoYmVzdC5zZWdtZW50ID09PSAyKSBiZXN0ID0geyBzZWdtZW50OiAzLCBhZGRyOiByZW1vdGVBZGRyZXNzIH0KCiAgICAgICAgICAvLyBNYXRjaGVzIDE5Mi4xNjguMTIyLioKICAgICAgICAgIGlmIChhWzJdID09PSBiWzJdKSByZXR1cm4gcmVtb3RlQWRkcmVzcwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIGJlc3QuYWRkcgp9CgpmdW5jdGlvbiBub29wKCkge30KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBuZXQgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nLW5ldCcpCgpjb25zdCBpcHY0ID0gewogIC4uLm5ldC5pcHY0QWRkcmVzcywKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGlwID0gbmV0LmlwdjRBZGRyZXNzLmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIGhvc3Q6IGlwLmhvc3QsCiAgICAgIHBvcnQ6IGlwLnBvcnQKICAgIH0KICB9Cn0KCmNvbnN0IGlwdjRBcnJheSA9IGMuYXJyYXkoaXB2NCkKCmNvbnN0IGlwdjYgPSB7CiAgLi4ubmV0LmlwdjZBZGRyZXNzLAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgaXAgPSBuZXQuaXB2NkFkZHJlc3MuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgaG9zdDogaXAuaG9zdCwKICAgICAgcG9ydDogaXAucG9ydAogICAgfQogIH0KfQoKY29uc3QgaXB2NkFycmF5ID0gYy5hcnJheShpcHY2KQoKZXhwb3J0cy5oYW5kc2hha2UgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQgKz0gMSArIDEgKyAobS5wZWVyQWRkcmVzcyA/IDYgOiAwKSArIChtLnJlbGF5QWRkcmVzcyA/IDYgOiAwKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLm5vaXNlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLnBlZXJBZGRyZXNzID8gMSA6IDApIHwgKG0ucmVsYXlBZGRyZXNzID8gMiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLm1vZGUpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0ubm9pc2UpCgogICAgaWYgKG0ucGVlckFkZHJlc3MpIGlwdjQuZW5jb2RlKHN0YXRlLCBtLnBlZXJBZGRyZXNzKQogICAgaWYgKG0ucmVsYXlBZGRyZXNzKSBpcHY0LmVuY29kZShzdGF0ZSwgbS5yZWxheUFkZHJlc3MpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBtb2RlOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbm9pc2U6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSksCiAgICAgIHBlZXJBZGRyZXNzOiBmbGFncyAmIDEgPyBpcHY0LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICByZWxheUFkZHJlc3M6IGZsYWdzICYgMiA/IGlwdjQuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IHJlbGF5SW5mbyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCArPSAxMgogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBpcHY0LmVuY29kZShzdGF0ZSwgbS5yZWxheUFkZHJlc3MpCiAgICBpcHY0LmVuY29kZShzdGF0ZSwgbS5wZWVyQWRkcmVzcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcmVsYXlBZGRyZXNzOiBpcHY0LmRlY29kZShzdGF0ZSksCiAgICAgIHBlZXJBZGRyZXNzOiBpcHY0LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlbGF5SW5mb0FycmF5ID0gYy5hcnJheShyZWxheUluZm8pCgpjb25zdCBob2xlcHVuY2hJbmZvID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5pZCkKICAgIHJlbGF5SW5mb0FycmF5LnByZWVuY29kZShzdGF0ZSwgbS5yZWxheXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uaWQpCiAgICByZWxheUluZm9BcnJheS5lbmNvZGUoc3RhdGUsIG0ucmVsYXlzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpZDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHJlbGF5czogcmVsYXlJbmZvQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgdWR4SW5mbyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCArPSAyIC8vIHZlcnNpb24gKyBmZWF0dXJlcwogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc2VxKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZXVzYWJsZVNvY2tldCA/IDEgOiAwKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc2VxKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGZlYXR1cmVzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICByZXVzYWJsZVNvY2tldDogKGZlYXR1cmVzICYgMSkgIT09IDAsCiAgICAgIGlkOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2VxOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qgc2VjcmV0U3RyZWFtSW5mbyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIDEpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZWxheVRocm91Z2hJbmZvID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgMSkgLy8gdmVyc2lvbgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgMCkgLy8gZmxhZ3MKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS50b2tlbikKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgMSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0udG9rZW4pCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICBwdWJsaWNLZXk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICB0b2tlbjogYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmV4cG9ydHMubm9pc2VQYXlsb2FkID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kICs9IDQgLy8gdmVyc2lvbiArIGZsYWdzICsgZXJyb3IgKyBmaXJld2FsbAogICAgaWYgKG0uaG9sZXB1bmNoKSBob2xlcHVuY2hJbmZvLnByZWVuY29kZShzdGF0ZSwgbS5ob2xlcHVuY2gpCiAgICBpZiAobS5hZGRyZXNzZXM0ICYmIG0uYWRkcmVzc2VzNC5sZW5ndGgpIGlwdjRBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0uYWRkcmVzc2VzNCkKICAgIGlmIChtLmFkZHJlc3NlczYgJiYgbS5hZGRyZXNzZXM2Lmxlbmd0aCkgaXB2NkFycmF5LnByZWVuY29kZShzdGF0ZSwgbS5hZGRyZXNzZXM2KQogICAgaWYgKG0udWR4KSB1ZHhJbmZvLnByZWVuY29kZShzdGF0ZSwgbS51ZHgpCiAgICBpZiAobS5zZWNyZXRTdHJlYW0pIHNlY3JldFN0cmVhbUluZm8ucHJlZW5jb2RlKHN0YXRlLCBtLnNlY3JldFN0cmVhbSkKICAgIGlmIChtLnJlbGF5VGhyb3VnaCkgcmVsYXlUaHJvdWdoSW5mby5wcmVlbmNvZGUoc3RhdGUsIG0ucmVsYXlUaHJvdWdoKQogICAgaWYgKG0ucmVsYXlBZGRyZXNzZXMpIGlwdjRBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0ucmVsYXlBZGRyZXNzZXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGxldCBmbGFncyA9IDAKCiAgICBpZiAobS5ob2xlcHVuY2gpIGZsYWdzIHw9IDEKICAgIGlmIChtLmFkZHJlc3NlczQgJiYgbS5hZGRyZXNzZXM0Lmxlbmd0aCkgZmxhZ3MgfD0gMgogICAgaWYgKG0uYWRkcmVzc2VzNiAmJiBtLmFkZHJlc3NlczYubGVuZ3RoKSBmbGFncyB8PSA0CiAgICBpZiAobS51ZHgpIGZsYWdzIHw9IDgKICAgIGlmIChtLnNlY3JldFN0cmVhbSkgZmxhZ3MgfD0gMTYKICAgIGlmIChtLnJlbGF5VGhyb3VnaCkgZmxhZ3MgfD0gMzIKICAgIGlmIChtLnJlbGF5QWRkcmVzc2VzKSBmbGFncyB8PSA2NAoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpIC8vIHZlcnNpb24KICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5lcnJvcikKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZmlyZXdhbGwpCgogICAgaWYgKG0uaG9sZXB1bmNoKSBob2xlcHVuY2hJbmZvLmVuY29kZShzdGF0ZSwgbS5ob2xlcHVuY2gpCiAgICBpZiAobS5hZGRyZXNzZXM0ICYmIG0uYWRkcmVzc2VzNC5sZW5ndGgpIGlwdjRBcnJheS5lbmNvZGUoc3RhdGUsIG0uYWRkcmVzc2VzNCkKICAgIGlmIChtLmFkZHJlc3NlczYgJiYgbS5hZGRyZXNzZXM2Lmxlbmd0aCkgaXB2NkFycmF5LmVuY29kZShzdGF0ZSwgbS5hZGRyZXNzZXM2KQogICAgaWYgKG0udWR4KSB1ZHhJbmZvLmVuY29kZShzdGF0ZSwgbS51ZHgpCiAgICBpZiAobS5zZWNyZXRTdHJlYW0pIHNlY3JldFN0cmVhbUluZm8uZW5jb2RlKHN0YXRlLCBtLnNlY3JldFN0cmVhbSkKICAgIGlmIChtLnJlbGF5VGhyb3VnaCkgcmVsYXlUaHJvdWdoSW5mby5lbmNvZGUoc3RhdGUsIG0ucmVsYXlUaHJvdWdoKQogICAgaWYgKG0ucmVsYXlBZGRyZXNzZXMpIGlwdjRBcnJheS5lbmNvZGUoc3RhdGUsIG0ucmVsYXlBZGRyZXNzZXMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmICh2ZXJzaW9uICE9PSAxKSB7CiAgICAgIC8vIERvIG5vdCBhdHRlbXB0IHRvIGRlY29kZSBidXQgcmV0dXJuIHRoaXMgYmFjayB0byB0aGUgdXNlciBzbyB0aGV5IGNhbgogICAgICAvLyBhY3R1YWxseSBoYW5kbGUgaXQKICAgICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uLAogICAgICAgIGVycm9yOiAwLAogICAgICAgIGZpcmV3YWxsOiAwLAogICAgICAgIGhvbGVwdW5jaDogbnVsbCwKICAgICAgICBhZGRyZXNzZXM0OiBbXSwKICAgICAgICBhZGRyZXNzZXM2OiBbXSwKICAgICAgICB1ZHg6IG51bGwsCiAgICAgICAgc2VjcmV0U3RyZWFtOiBudWxsLAogICAgICAgIHJlbGF5VGhyb3VnaDogbnVsbCwKICAgICAgICByZWxheUFkZHJlc3NlczogbnVsbAogICAgICB9CiAgICB9CgogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb24sCiAgICAgIGVycm9yOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgZmlyZXdhbGw6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBob2xlcHVuY2g6IChmbGFncyAmIDEpICE9PSAwID8gaG9sZXB1bmNoSW5mby5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgYWRkcmVzc2VzNDogKGZsYWdzICYgMikgIT09IDAgPyBpcHY0QXJyYXkuZGVjb2RlKHN0YXRlKSA6IFtdLAogICAgICBhZGRyZXNzZXM2OiAoZmxhZ3MgJiA0KSAhPT0gMCA/IGlwdjZBcnJheS5kZWNvZGUoc3RhdGUpIDogW10sCiAgICAgIHVkeDogKGZsYWdzICYgOCkgIT09IDAgPyB1ZHhJbmZvLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBzZWNyZXRTdHJlYW06IChmbGFncyAmIDE2KSAhPT0gMCA/IHNlY3JldFN0cmVhbUluZm8uZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHJlbGF5VGhyb3VnaDogKGZsYWdzICYgMzIpICE9PSAwID8gcmVsYXlUaHJvdWdoSW5mby5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgcmVsYXlBZGRyZXNzZXM6IChmbGFncyAmIDY0KSAhPT0gMCA/IGlwdjRBcnJheS5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKZXhwb3J0cy5ob2xlcHVuY2ggPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQgKz0gMgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS5wYXlsb2FkKQogICAgaWYgKG0ucGVlckFkZHJlc3MpIGlwdjQucHJlZW5jb2RlKHN0YXRlLCBtLnBlZXJBZGRyZXNzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IG0ucGVlckFkZHJlc3MgPyAxIDogMAogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLm1vZGUpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnBheWxvYWQpCiAgICBpZiAobS5wZWVyQWRkcmVzcykgaXB2NC5lbmNvZGUoc3RhdGUsIG0ucGVlckFkZHJlc3MpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIG1vZGU6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBpZDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHBheWxvYWQ6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSksCiAgICAgIHBlZXJBZGRyZXNzOiBmbGFncyAmIDEgPyBpcHY0LmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9CgpleHBvcnRzLmhvbGVwdW5jaFBheWxvYWQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQgKz0gNCAvLyBmbGFncyArIGVycm9yICsgZmlyZXdhbGwgKyByb3VuZAogICAgaWYgKG0uYWRkcmVzc2VzKSBpcHY0QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLmFkZHJlc3NlcykKICAgIGlmIChtLnJlbW90ZUFkZHJlc3MpIHN0YXRlLmVuZCArPSA2CiAgICBpZiAobS50b2tlbikgc3RhdGUuZW5kICs9IDMyCiAgICBpZiAobS5yZW1vdGVUb2tlbikgc3RhdGUuZW5kICs9IDMyCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0KICAgICAgKG0uY29ubmVjdGVkID8gMSA6IDApIHwKICAgICAgKG0ucHVuY2hpbmcgPyAyIDogMCkgfAogICAgICAobS5hZGRyZXNzZXMgPyA0IDogMCkgfAogICAgICAobS5yZW1vdGVBZGRyZXNzID8gOCA6IDApIHwKICAgICAgKG0udG9rZW4gPyAxNiA6IDApIHwKICAgICAgKG0ucmVtb3RlVG9rZW4gPyAzMiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmVycm9yKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5maXJld2FsbCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucm91bmQpCgogICAgaWYgKG0uYWRkcmVzc2VzKSBpcHY0QXJyYXkuZW5jb2RlKHN0YXRlLCBtLmFkZHJlc3NlcykKICAgIGlmIChtLnJlbW90ZUFkZHJlc3MpIGlwdjQuZW5jb2RlKHN0YXRlLCBtLnJlbW90ZUFkZHJlc3MpCiAgICBpZiAobS50b2tlbikgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS50b2tlbikKICAgIGlmIChtLnJlbW90ZVRva2VuKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnJlbW90ZVRva2VuKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgZXJyb3I6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBmaXJld2FsbDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHJvdW5kOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgY29ubmVjdGVkOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgcHVuY2hpbmc6IChmbGFncyAmIDIpICE9PSAwLAogICAgICBhZGRyZXNzZXM6IChmbGFncyAmIDQpICE9PSAwID8gaXB2NEFycmF5LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICByZW1vdGVBZGRyZXNzOiAoZmxhZ3MgJiA4KSAhPT0gMCA/IGlwdjQuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHRva2VuOiAoZmxhZ3MgJiAxNikgIT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHJlbW90ZVRva2VuOiAoZmxhZ3MgJiAzMikgIT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IHBlZXIgPSAoZXhwb3J0cy5wZWVyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kICs9IDMyCiAgICBpcHY0QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLnJlbGF5QWRkcmVzc2VzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICAgIGlwdjRBcnJheS5lbmNvZGUoc3RhdGUsIG0ucmVsYXlBZGRyZXNzZXMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHB1YmxpY0tleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIHJlbGF5QWRkcmVzc2VzOiBpcHY0QXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfSkKCmNvbnN0IHBlZXJzID0gKGV4cG9ydHMucGVlcnMgPSBjLmFycmF5KHBlZXIpKQoKY29uc3QgcmF3UGVlcnMgPSBjLmFycmF5KGMucmF3KQoKZXhwb3J0cy5sb29rdXBSYXdSZXBseSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHJhd1BlZXJzLnByZWVuY29kZShzdGF0ZSwgbS5wZWVycykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uYnVtcCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgcmF3UGVlcnMuZW5jb2RlKHN0YXRlLCBtLnBlZXJzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5idW1wKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBwZWVyczogcGVlcnMuZGVjb2RlKHN0YXRlKSwKICAgICAgYnVtcDogc3RhdGUuc3RhcnQgPCBzdGF0ZS5lbmQgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCmV4cG9ydHMuYW5ub3VuY2UgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgaWYgKG0ucGVlcikgcGVlci5wcmVlbmNvZGUoc3RhdGUsIG0ucGVlcikKICAgIGlmIChtLnJlZnJlc2gpIHN0YXRlLmVuZCArPSAzMgogICAgaWYgKG0uc2lnbmF0dXJlKSBzdGF0ZS5lbmQgKz0gNjQKICAgIGlmIChtLmJ1bXApIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uYnVtcCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSAobS5wZWVyID8gMSA6IDApIHwgKG0ucmVmcmVzaCA/IDIgOiAwKSB8IChtLnNpZ25hdHVyZSA/IDQgOiAwKSB8IChtLmJ1bXAgPyA4IDogMCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgaWYgKG0ucGVlcikgcGVlci5lbmNvZGUoc3RhdGUsIG0ucGVlcikKICAgIGlmIChtLnJlZnJlc2gpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucmVmcmVzaCkKICAgIGlmIChtLnNpZ25hdHVyZSkgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBpZiAobS5idW1wKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmJ1bXApCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBwZWVyOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IHBlZXIuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHJlZnJlc2g6IChmbGFncyAmIDIpICE9PSAwID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBzaWduYXR1cmU6IChmbGFncyAmIDQpICE9PSAwID8gYy5maXhlZDY0LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBidW1wOiAoZmxhZ3MgJiA4KSAhPT0gMCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgfQogIH0KfQoKZXhwb3J0cy5tdXRhYmxlU2lnbmFibGUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnNlcSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zZXEpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0udmFsdWUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHNlcTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHZhbHVlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CgpleHBvcnRzLm11dGFibGVQdXRSZXF1ZXN0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnNlcSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICAgIGMuZml4ZWQ2NC5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc2VxKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnZhbHVlKQogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHB1YmxpY0tleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIHNlcTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHZhbHVlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuZml4ZWQ2NC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CgpleHBvcnRzLm11dGFibGVHZXRSZXNwb25zZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc2VxKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnZhbHVlKQogICAgYy5maXhlZDY0LnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc2VxKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnZhbHVlKQogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHNlcTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHZhbHVlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuZml4ZWQ2NC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CmNvbnN0IHsgRklSRVdBTEwgfSA9IHJlcXVpcmUoJy4uL2xpYi9jb25zdGFudHMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBOYXQgewogIGNvbnN0cnVjdG9yKGRodCwgc2Vzc2lvbiwgc29ja2V0KSB7CiAgICB0aGlzLl9zYW1wbGVzSG9zdCA9IFtdCiAgICB0aGlzLl9zYW1wbGVzRnVsbCA9IFtdCiAgICB0aGlzLl92aXNpdGVkID0gbmV3IE1hcCgpCiAgICB0aGlzLl9yZXNvbHZlID0gbnVsbAogICAgdGhpcy5fbWluU2FtcGxlcyA9IDQKICAgIHRoaXMuX2F1dG9TYW1wbGluZyA9IGZhbHNlCgogICAgdGhpcy5kaHQgPSBkaHQKICAgIHRoaXMuc2Vzc2lvbiA9IHNlc3Npb24KICAgIHRoaXMuc29ja2V0ID0gc29ja2V0CgogICAgdGhpcy5zYW1wbGVkID0gMAogICAgdGhpcy5maXJld2FsbCA9IGRodC5maXJld2FsbGVkID8gRklSRVdBTEwuVU5LTk9XTiA6IEZJUkVXQUxMLk9QRU4KICAgIHRoaXMuYWRkcmVzc2VzID0gbnVsbAoKICAgIHRoaXMuYW5hbHl6aW5nID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgdGhpcy5fcmVzb2x2ZSA9IHJlc29sdmUKICAgIH0pCiAgfQoKICBhdXRvU2FtcGxlKHJldHJ5ID0gdHJ1ZSkgewogICAgaWYgKHRoaXMuX2F1dG9TYW1wbGluZykgcmV0dXJuCiAgICB0aGlzLl9hdXRvU2FtcGxpbmcgPSB0cnVlCgogICAgY29uc3Qgc2VsZiA9IHRoaXMKICAgIGNvbnN0IHNvY2tldCA9IHRoaXMuc29ja2V0CiAgICBjb25zdCBtYXhQaW5ncyA9IHRoaXMuX21pblNhbXBsZXMKCiAgICBsZXQgc2tpcCA9IHRoaXMuZGh0Lm5vZGVzLmxlbmd0aCA+PSA4ID8gNSA6IDAKICAgIGxldCBwZW5kaW5nID0gMAoKICAgIC8vIFRPRE86IGl0IHdvdWxkIGJlIGJlc3QgdG8gcGljayB0aGUgbm9kZXMgdG8gaGVscCB1cyBiYXNlZCBvbiBsYXRlbmN5IHRvIHVzCiAgICAvLyBUaGF0IHNob3VsZCByZWR1Y2UgY29ubmVjdCBsYXRlbmN5IGluIGdlbmVyYWwuIFdlIHNob3VsZCBpbnZlc3RpZ2F0ZSB0cmFja2luZyB0aGF0IGxhdGVyIG9uLgoKICAgIC8vIFRPRE8gMjogdHJ5IHRvIHBpY2sgbm9kZXMgd2l0aCBkaWZmZXJlbnQgSVBzIGFzIHdlbGwsIGFzIHRoYXQnbGwgaGVscCBtdWx0aSBJUCBjZWxsIGNvbm5lY3Rpb25zLi4uCiAgICAvLyBJZiB3ZSBleHBvc2UgdGhpcyBmcm9tIHRoZSBuYXQgc2FtcGxlciB0aGVuIHRoZSBESFQgc2hvdWxkIGJlIGFibGUgdG8gaGVscCB1cyBmaWx0ZXIgb3V0IHNjYW1zIGFzIHdlbGwuLi4KCiAgICBmb3IgKAogICAgICBsZXQgbm9kZSA9IHRoaXMuZGh0Lm5vZGVzLmxhdGVzdDsKICAgICAgbm9kZSAmJiB0aGlzLnNhbXBsZWQgKyBwZW5kaW5nIDwgbWF4UGluZ3M7CiAgICAgIG5vZGUgPSBub2RlLnByZXYKICAgICkgewogICAgICBpZiAoc2tpcCA+IDApIHsKICAgICAgICBza2lwLS0KICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBjb25zdCByZWYgPSBub2RlLmhvc3QgKyAnOicgKyBub2RlLnBvcnQKCiAgICAgIGlmICh0aGlzLl92aXNpdGVkLmhhcyhyZWYpKSBjb250aW51ZQogICAgICB0aGlzLl92aXNpdGVkLnNldChyZWYsIDEpCgogICAgICBwZW5kaW5nKysKICAgICAgdGhpcy5zZXNzaW9uLnBpbmcobm9kZSwgeyBzb2NrZXQsIHJldHJ5OiBmYWxzZSB9KS50aGVuKG9ucG9uZywgb25za2lwKQogICAgfQoKICAgIHBlbmRpbmcrKwogICAgb25za2lwKCkKCiAgICBmdW5jdGlvbiBvbnBvbmcocmVzKSB7CiAgICAgIHNlbGYuYWRkKHJlcy50bywgcmVzLmZyb20pCiAgICAgIG9uc2tpcCgpCiAgICB9CgogICAgZnVuY3Rpb24gb25za2lwKCkgewogICAgICBpZiAoLS1wZW5kaW5nID09PSAwICYmIHNlbGYuc2FtcGxlZCA8IHNlbGYuX21pblNhbXBsZXMpIHsKICAgICAgICBpZiAocmV0cnkpIHsKICAgICAgICAgIHNlbGYuX2F1dG9TYW1wbGluZyA9IGZhbHNlCiAgICAgICAgICBzZWxmLmF1dG9TYW1wbGUoZmFsc2UpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgc2VsZi5fcmVzb2x2ZSgpCiAgICAgIH0KICAgIH0KICB9CgogIGRlc3Ryb3koKSB7CiAgICB0aGlzLl9hdXRvU2FtcGxpbmcgPSB0cnVlCiAgICB0aGlzLl9taW5TYW1wbGVzID0gMAogICAgdGhpcy5fcmVzb2x2ZSgpCiAgfQoKICB1bmZyZWV6ZSgpIHsKICAgIHRoaXMuZnJvemVuID0gZmFsc2UKICAgIHRoaXMuX3VwZGF0ZUZpcmV3YWxsKCkKICAgIHRoaXMuX3VwZGF0ZUFkZHJlc3NlcygpCiAgfQoKICBmcmVlemUoKSB7CiAgICB0aGlzLmZyb3plbiA9IHRydWUKICB9CgogIF91cGRhdGVGaXJld2FsbCgpIHsKICAgIGlmICghdGhpcy5kaHQuZmlyZXdhbGxlZCkgewogICAgICB0aGlzLmZpcmV3YWxsID0gRklSRVdBTEwuT1BFTgogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5zYW1wbGVkIDwgMykgcmV0dXJuCgogICAgY29uc3QgbWF4ID0gdGhpcy5fc2FtcGxlc0Z1bGxbMF0uaGl0cwoKICAgIGlmIChtYXggPj0gMykgewogICAgICB0aGlzLmZpcmV3YWxsID0gRklSRVdBTEwuQ09OU0lTVEVOVAogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAobWF4ID09PSAxKSB7CiAgICAgIHRoaXMuZmlyZXdhbGwgPSBGSVJFV0FMTC5SQU5ET00KICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gZWxzZSBtYXggPT09IDIKCiAgICAvLyAxIGhvc3QsID49IDQgdG90YWwgc2FtcGxlcyBpZSwgMiBiYWQgb25lcyAtPiByYW5kb20KICAgIGlmICh0aGlzLl9zYW1wbGVzSG9zdC5sZW5ndGggPT09IDEgJiYgdGhpcy5zYW1wbGVkID4gMykgewogICAgICB0aGlzLmZpcmV3YWxsID0gRklSRVdBTEwuUkFORE9NCiAgICAgIHJldHVybgogICAgfQoKICAgIC8vIGRvdWJsZSBoaXQgb24gdHdvIGRpZmZlcmVudCBpcHMgLT4gYXNzdW1lIGNvbnNpc3RlbnQKICAgIGlmICh0aGlzLl9zYW1wbGVzSG9zdC5sZW5ndGggPiAxICYmIHRoaXMuX3NhbXBsZXNGdWxsWzFdLmhpdHMgPiAxKSB7CiAgICAgIHRoaXMuZmlyZXdhbGwgPSBGSVJFV0FMTC5DT05TSVNURU5UCiAgICAgIHJldHVybgogICAgfQoKICAgIC8vICg0IGlzIGp1c3QgbWVhbnMgLSBhbGwgdGhlIHNhbXBsZXMgd2UgZXhwZWN0KSAtIG5vIGRlY2lzaW9uIC0gYXNzdW1lIHJhbmRvbQogICAgaWYgKHRoaXMuc2FtcGxlZCA+IDQpIHsKICAgICAgdGhpcy5maXJld2FsbCA9IEZJUkVXQUxMLlJBTkRPTQogICAgfQogIH0KCiAgX3VwZGF0ZUFkZHJlc3NlcygpIHsKICAgIGlmICh0aGlzLmZpcmV3YWxsID09PSBGSVJFV0FMTC5VTktOT1dOKSB7CiAgICAgIHRoaXMuYWRkcmVzc2VzID0gbnVsbAogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5maXJld2FsbCA9PT0gRklSRVdBTEwuUkFORE9NKSB7CiAgICAgIHRoaXMuYWRkcmVzc2VzID0gW3RoaXMuX3NhbXBsZXNIb3N0WzBdXQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5maXJld2FsbCA9PT0gRklSRVdBTEwuQ09OU0lTVEVOVCkgewogICAgICB0aGlzLmFkZHJlc3NlcyA9IFtdCiAgICAgIGZvciAoY29uc3QgYWRkciBvZiB0aGlzLl9zYW1wbGVzRnVsbCkgewogICAgICAgIGlmIChhZGRyLmhpdHMgPj0gMiB8fCB0aGlzLmFkZHJlc3Nlcy5sZW5ndGggPCAyKSB0aGlzLmFkZHJlc3Nlcy5wdXNoKGFkZHIpCiAgICAgIH0KICAgIH0KICB9CgogIHVwZGF0ZSgpIHsKICAgIGlmICh0aGlzLmRodC5maXJld2FsbGVkICYmIHRoaXMuZmlyZXdhbGwgPT09IEZJUkVXQUxMLk9QRU4pIHsKICAgICAgdGhpcy5maXJld2FsbCA9IEZJUkVXQUxMLlVOS05PV04KICAgIH0KICAgIHRoaXMuX3VwZGF0ZUZpcmV3YWxsKCkKICAgIHRoaXMuX3VwZGF0ZUFkZHJlc3NlcygpCiAgfQoKICBhZGQoYWRkciwgZnJvbSkgewogICAgY29uc3QgcmVmID0gZnJvbS5ob3N0ICsgJzonICsgZnJvbS5wb3J0CgogICAgaWYgKHRoaXMuX3Zpc2l0ZWQuZ2V0KHJlZikgPT09IDIpIHJldHVybgogICAgdGhpcy5fdmlzaXRlZC5zZXQocmVmLCAyKQoKICAgIGFkZFNhbXBsZSh0aGlzLl9zYW1wbGVzSG9zdCwgYWRkci5ob3N0LCAwKQogICAgYWRkU2FtcGxlKHRoaXMuX3NhbXBsZXNGdWxsLCBhZGRyLmhvc3QsIGFkZHIucG9ydCkKCiAgICBpZiAoKCsrdGhpcy5zYW1wbGVkID49IDMgfHwgIXRoaXMuZGh0LmZpcmV3YWxsZWQpICYmICF0aGlzLmZyb3plbikgewogICAgICB0aGlzLnVwZGF0ZSgpCiAgICB9CgogICAgaWYgKHRoaXMuZmlyZXdhbGwgPT09IEZJUkVXQUxMLkNPTlNJU1RFTlQgfHwgdGhpcy5maXJld2FsbCA9PT0gRklSRVdBTEwuT1BFTikgewogICAgICB0aGlzLl9yZXNvbHZlKCkKICAgIH0gZWxzZSBpZiAodGhpcy5zYW1wbGVkID49IHRoaXMuX21pblNhbXBsZXMpIHsKICAgICAgdGhpcy5fcmVzb2x2ZSgpCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBhZGRTYW1wbGUoc2FtcGxlcywgaG9zdCwgcG9ydCkgewogIGZvciAobGV0IGkgPSAwOyBpIDwgc2FtcGxlcy5sZW5ndGg7IGkrKykgewogICAgY29uc3QgcyA9IHNhbXBsZXNbaV0KCiAgICBpZiAocy5wb3J0ICE9PSBwb3J0IHx8IHMuaG9zdCAhPT0gaG9zdCkgY29udGludWUKICAgIHMuaGl0cysrCgogICAgZm9yICg7IGkgPiAwOyBpLS0pIHsKICAgICAgY29uc3QgcHJldiA9IHNhbXBsZXNbaSAtIDFdCiAgICAgIGlmIChwcmV2LmhpdHMgPj0gcy5oaXRzKSByZXR1cm4KICAgICAgc2FtcGxlc1tpIC0gMV0gPSBzCiAgICAgIHNhbXBsZXNbaV0gPSBwcmV2CiAgICB9CgogICAgcmV0dXJuCiAgfQoKICBzYW1wbGVzLnB1c2goewogICAgaG9zdCwKICAgIHBvcnQsCiAgICBoaXRzOiAxCiAgfSkKfQpjb25zdCBOb2lzZVNlY3JldFN0cmVhbSA9IHJlcXVpcmUoJ0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0nKQpjb25zdCBOb2lzZUhhbmRzaGFrZSA9IHJlcXVpcmUoJ25vaXNlLWhhbmRzaGFrZScpCmNvbnN0IGN1cnZlID0gcmVxdWlyZSgnbm9pc2UtY3VydmUtZWQnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBtID0gcmVxdWlyZSgnLi9tZXNzYWdlcycpCmNvbnN0IHsgTlMgfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKY29uc3QgeyBIQU5EU0hBS0VfVU5GSU5JU0hFRCB9ID0gcmVxdWlyZSgnLi9lcnJvcnMnKQoKY29uc3QgTk9JU0VfUFJPTE9VR0UgPSBOUy5QRUVSX0hBTkRTSEFLRQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBOb2lzZVdyYXAgewogIGNvbnN0cnVjdG9yKGtleVBhaXIsIHJlbW90ZVB1YmxpY0tleSkgewogICAgdGhpcy5pc0luaXRpYXRvciA9ICEhcmVtb3RlUHVibGljS2V5CiAgICB0aGlzLnJlbW90ZVB1YmxpY0tleSA9IHJlbW90ZVB1YmxpY0tleQogICAgdGhpcy5rZXlQYWlyID0ga2V5UGFpcgogICAgdGhpcy5oYW5kc2hha2UgPSBuZXcgTm9pc2VIYW5kc2hha2UoJ0lLJywgdGhpcy5pc0luaXRpYXRvciwga2V5UGFpciwgeyBjdXJ2ZSB9KQogICAgdGhpcy5oYW5kc2hha2UuaW5pdGlhbGlzZShOT0lTRV9QUk9MT1VHRSwgcmVtb3RlUHVibGljS2V5KQogIH0KCiAgc2VuZChwYXlsb2FkKSB7CiAgICBjb25zdCBidWYgPSBjLmVuY29kZShtLm5vaXNlUGF5bG9hZCwgcGF5bG9hZCkKICAgIHJldHVybiB0aGlzLmhhbmRzaGFrZS5zZW5kKGJ1ZikKICB9CgogIHJlY3YoYnVmKSB7CiAgICBjb25zdCBwYXlsb2FkID0gYy5kZWNvZGUobS5ub2lzZVBheWxvYWQsIHRoaXMuaGFuZHNoYWtlLnJlY3YoYnVmKSkKICAgIHRoaXMucmVtb3RlUHVibGljS2V5ID0gYjRhLnRvQnVmZmVyKHRoaXMuaGFuZHNoYWtlLnJzKQogICAgcmV0dXJuIHBheWxvYWQKICB9CgogIGZpbmFsKCkgewogICAgaWYgKCF0aGlzLmhhbmRzaGFrZS5jb21wbGV0ZSkgdGhyb3cgSEFORFNIQUtFX1VORklOSVNIRUQoKQoKICAgIGNvbnN0IGhvbGVwdW5jaFNlY3JldCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGhvbGVwdW5jaFNlY3JldCwgTlMuUEVFUl9IT0xFUFVOQ0gsIHRoaXMuaGFuZHNoYWtlLmhhc2gpCgogICAgcmV0dXJuIHsKICAgICAgaXNJbml0aWF0b3I6IHRoaXMuaXNJbml0aWF0b3IsCiAgICAgIHB1YmxpY0tleTogdGhpcy5rZXlQYWlyLnB1YmxpY0tleSwKICAgICAgc3RyZWFtSWQ6IHRoaXMuc3RyZWFtSWQsCiAgICAgIHJlbW90ZVB1YmxpY0tleTogdGhpcy5yZW1vdGVQdWJsaWNLZXksCiAgICAgIHJlbW90ZUlkOiBOb2lzZVNlY3JldFN0cmVhbS5pZCh0aGlzLmhhbmRzaGFrZS5oYXNoLCAhdGhpcy5pc0luaXRpYXRvciksCiAgICAgIGhvbGVwdW5jaFNlY3JldCwKICAgICAgaGFzaDogYjRhLnRvQnVmZmVyKHRoaXMuaGFuZHNoYWtlLmhhc2gpLAogICAgICByeDogYjRhLnRvQnVmZmVyKHRoaXMuaGFuZHNoYWtlLnJ4KSwKICAgICAgdHg6IGI0YS50b0J1ZmZlcih0aGlzLmhhbmRzaGFrZS50eCkKICAgIH0KICB9Cn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgUmVjb3JkQ2FjaGUgPSByZXF1aXJlKCdyZWNvcmQtY2FjaGUnKQpjb25zdCBDYWNoZSA9IHJlcXVpcmUoJ3hhY2hlJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKCmNvbnN0IHsgZW5jb2RlVW5zbGFiIH0gPSByZXF1aXJlKCcuL2VuY29kZScpCmNvbnN0IG0gPSByZXF1aXJlKCcuL21lc3NhZ2VzJykKY29uc3QgeyBOUywgRVJST1IgfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCmNvbnN0IEVNUFRZID0gYjRhLmFsbG9jKDApCmNvbnN0IFRNUCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKY29uc3QgTUFYX0JVTVBfRFJJRlQgPSA2MF8wMDAKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUGVyc2lzdGVudCB7CiAgY29uc3RydWN0b3IoZGh0LCBvcHRzKSB7CiAgICB0aGlzLmRodCA9IGRodAogICAgdGhpcy5yZWNvcmRzID0gbmV3IFJlY29yZENhY2hlKG9wdHMucmVjb3JkcykKICAgIHRoaXMuYnVtcHMgPSBuZXcgQ2FjaGUob3B0cy5idW1wcykKICAgIHRoaXMucmVmcmVzaGVzID0gbmV3IENhY2hlKG9wdHMucmVmcmVzaGVzKQogICAgdGhpcy5tdXRhYmxlcyA9IG5ldyBDYWNoZShvcHRzLm11dGFibGVzKQogICAgdGhpcy5pbW11dGFibGVzID0gbmV3IENhY2hlKG9wdHMuaW1tdXRhYmxlcykKICB9CgogIG9ubG9va3VwKHJlcSkgewogICAgaWYgKCFyZXEudGFyZ2V0KSByZXR1cm4KCiAgICBjb25zdCBrID0gYjRhLnRvU3RyaW5nKHJlcS50YXJnZXQsICdoZXgnKQogICAgY29uc3QgcmVjb3JkcyA9IHRoaXMucmVjb3Jkcy5nZXQoaywgMjApCiAgICBjb25zdCBidW1wID0gdGhpcy5idW1wcy5nZXQoaykgfHwgMAogICAgY29uc3QgZndkID0gdGhpcy5kaHQuX3JvdXRlci5nZXQoaykKCiAgICBpZiAoZndkICYmIHJlY29yZHMubGVuZ3RoIDwgMjApIHJlY29yZHMucHVzaChmd2QucmVjb3JkKQoKICAgIHJlcS5yZXBseShyZWNvcmRzLmxlbmd0aCA/IGMuZW5jb2RlKG0ubG9va3VwUmF3UmVwbHksIHsgcGVlcnM6IHJlY29yZHMsIGJ1bXAgfSkgOiBudWxsKQogIH0KCiAgb25maW5kcGVlcihyZXEpIHsKICAgIGlmICghcmVxLnRhcmdldCkgcmV0dXJuCiAgICBjb25zdCBmd2QgPSB0aGlzLmRodC5fcm91dGVyLmdldChyZXEudGFyZ2V0KQogICAgcmVxLnJlcGx5KGZ3ZCA/IGZ3ZC5yZWNvcmQgOiBudWxsKQogIH0KCiAgdW5hbm5vdW5jZSh0YXJnZXQsIHB1YmxpY0tleSkgewogICAgY29uc3QgayA9IGI0YS50b1N0cmluZyh0YXJnZXQsICdoZXgnKQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChUTVAsIHB1YmxpY0tleSkKCiAgICBpZiAoYjRhLmVxdWFscyhUTVAsIHRhcmdldCkpIHRoaXMuZGh0Ll9yb3V0ZXIuZGVsZXRlKGspCiAgICB0aGlzLnJlY29yZHMucmVtb3ZlKGssIHB1YmxpY0tleSkKICB9CgogIG9udW5hbm5vdW5jZShyZXEpIHsKICAgIGlmICghcmVxLnRhcmdldCB8fCAhcmVxLnRva2VuKSByZXR1cm4KCiAgICBjb25zdCB1bmFubiA9IGRlY29kZShtLmFubm91bmNlLCByZXEudmFsdWUpCiAgICBpZiAodW5hbm4gPT09IG51bGwpIHJldHVybgoKICAgIGNvbnN0IHsgcGVlciwgc2lnbmF0dXJlIH0gPSB1bmFubgogICAgaWYgKCFwZWVyIHx8ICFzaWduYXR1cmUpIHJldHVybgoKICAgIGNvbnN0IHNpZ25hYmxlID0gYW5uU2lnbmFibGUocmVxLnRhcmdldCwgcmVxLnRva2VuLCB0aGlzLmRodC5pZCwgdW5hbm4sIE5TLlVOQU5OT1VOQ0UpCgogICAgaWYgKCFzb2RpdW0uY3J5cHRvX3NpZ25fdmVyaWZ5X2RldGFjaGVkKHNpZ25hdHVyZSwgc2lnbmFibGUsIHBlZXIucHVibGljS2V5KSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLnVuYW5ub3VuY2UocmVxLnRhcmdldCwgcGVlci5wdWJsaWNLZXkpCiAgICByZXEucmVwbHkobnVsbCwgeyB0b2tlbjogZmFsc2UsIGNsb3Nlck5vZGVzOiBmYWxzZSB9KQogIH0KCiAgX29ucmVmcmVzaCh0b2tlbiwgcmVxKSB7CiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKFRNUCwgdG9rZW4pCiAgICBjb25zdCBhY3RpdmVSZWZyZXNoID0gYjRhLnRvU3RyaW5nKFRNUCwgJ2hleCcpCgogICAgY29uc3QgciA9IHRoaXMucmVmcmVzaGVzLmdldChhY3RpdmVSZWZyZXNoKQogICAgaWYgKCFyKSByZXR1cm4KCiAgICBjb25zdCB7IGFubm91bmNlU2VsZiwgaywgcmVjb3JkIH0gPSByCiAgICBjb25zdCBwdWJsaWNLZXkgPSByZWNvcmQuc3ViYXJyYXkoMCwgMzIpCgogICAgaWYgKGFubm91bmNlU2VsZikgewogICAgICB0aGlzLmRodC5fcm91dGVyLnNldChrLCB7CiAgICAgICAgcmVsYXk6IHJlcS5mcm9tLAogICAgICAgIHJlY29yZCwKICAgICAgICBvbmNvbm5lY3Q6IG51bGwsCiAgICAgICAgb25ob2xlcHVuY2g6IG51bGwKICAgICAgfSkKICAgICAgdGhpcy5yZWNvcmRzLnJlbW92ZShrLCBwdWJsaWNLZXkpCiAgICB9IGVsc2UgewogICAgICB0aGlzLnJlY29yZHMuYWRkKGssIHB1YmxpY0tleSwgcmVjb3JkKQogICAgfQoKICAgIHRoaXMucmVmcmVzaGVzLmRlbGV0ZShhY3RpdmVSZWZyZXNoKQogICAgdGhpcy5yZWZyZXNoZXMuc2V0KGI0YS50b1N0cmluZyh0b2tlbiwgJ2hleCcpLCByKQoKICAgIHJlcS5yZXBseShudWxsLCB7IHRva2VuOiBmYWxzZSwgY2xvc2VyTm9kZXM6IGZhbHNlIH0pCiAgfQoKICBvbmFubm91bmNlKHJlcSkgewogICAgaWYgKCFyZXEudGFyZ2V0IHx8ICFyZXEudG9rZW4gfHwgIXRoaXMuZGh0LmlkKSByZXR1cm4KCiAgICBjb25zdCBhbm4gPSBkZWNvZGUobS5hbm5vdW5jZSwgcmVxLnZhbHVlKQogICAgaWYgKGFubiA9PT0gbnVsbCkgcmV0dXJuCgogICAgY29uc3Qgc2lnbmFibGUgPSBhbm5TaWduYWJsZShyZXEudGFyZ2V0LCByZXEudG9rZW4sIHRoaXMuZGh0LmlkLCBhbm4sIE5TLkFOTk9VTkNFKQogICAgY29uc3QgeyBwZWVyLCByZWZyZXNoLCBzaWduYXR1cmUsIGJ1bXAgfSA9IGFubgoKICAgIGlmICghcGVlcikgewogICAgICBpZiAoIXJlZnJlc2gpIHJldHVybgogICAgICB0aGlzLl9vbnJlZnJlc2gocmVmcmVzaCwgcmVxKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoIXNpZ25hdHVyZSB8fCAhc29kaXVtLmNyeXB0b19zaWduX3ZlcmlmeV9kZXRhY2hlZChzaWduYXR1cmUsIHNpZ25hYmxlLCBwZWVyLnB1YmxpY0tleSkpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gVE9ETzogaXQgd291bGQgYmUgcG90ZW50aWFsbHkgYmUgbW9yZSBvcHRpbWFsIHRvIGFsbG93IG1vcmUgdGhhbiAzIGFkZHJlc3NlcyBoZXJlIGZvciBhIGZpbmRQZWVyIHJlc3BvbnNlCiAgICAvLyBhbmQgb25seSB1c2UgbWF4IDMgZm9yIGEgbG9va3VwIHJlcGx5CiAgICBpZiAocGVlci5yZWxheUFkZHJlc3Nlcy5sZW5ndGggPiAzKSB7CiAgICAgIHBlZXIucmVsYXlBZGRyZXNzZXMgPSBwZWVyLnJlbGF5QWRkcmVzc2VzLnNsaWNlKDAsIDMpCiAgICB9CgogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChUTVAsIHBlZXIucHVibGljS2V5KQoKICAgIGNvbnN0IGsgPSBiNGEudG9TdHJpbmcocmVxLnRhcmdldCwgJ2hleCcpCiAgICBjb25zdCBhbm5vdW5jZVNlbGYgPSBiNGEuZXF1YWxzKFRNUCwgcmVxLnRhcmdldCkKICAgIGNvbnN0IHJlY29yZCA9IGVuY29kZVVuc2xhYihtLnBlZXIsIHBlZXIpCgogICAgaWYgKGFubm91bmNlU2VsZikgewogICAgICB0aGlzLmRodC5fcm91dGVyLnNldChrLCB7CiAgICAgICAgcmVsYXk6IHJlcS5mcm9tLAogICAgICAgIHJlY29yZCwKICAgICAgICBvbmNvbm5lY3Q6IG51bGwsCiAgICAgICAgb25ob2xlcHVuY2g6IG51bGwKICAgICAgfSkKICAgICAgdGhpcy5yZWNvcmRzLnJlbW92ZShrLCBwZWVyLnB1YmxpY0tleSkKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGN1cnJlbnRCdW1wID0gdGhpcy5idW1wcy5nZXQoaykgfHwgMAogICAgICBpZiAoYnVtcCA+IGN1cnJlbnRCdW1wICYmIGJ1bXAgPD0gRGF0ZS5ub3coKSArIE1BWF9CVU1QX0RSSUZUKSB0aGlzLmJ1bXBzLnNldChrLCBidW1wKQogICAgICB0aGlzLnJlY29yZHMuYWRkKGssIHBlZXIucHVibGljS2V5LCByZWNvcmQpCiAgICB9CgogICAgaWYgKHJlZnJlc2gpIHsKICAgICAgdGhpcy5yZWZyZXNoZXMuc2V0KGI0YS50b1N0cmluZyhyZWZyZXNoLCAnaGV4JyksIHsgaywgcmVjb3JkLCBhbm5vdW5jZVNlbGYgfSkKICAgIH0KCiAgICByZXEucmVwbHkobnVsbCwgeyB0b2tlbjogZmFsc2UsIGNsb3Nlck5vZGVzOiBmYWxzZSB9KQogIH0KCiAgb25tdXRhYmxlZ2V0KHJlcSkgewogICAgaWYgKCFyZXEudGFyZ2V0IHx8ICFyZXEudmFsdWUpIHJldHVybgoKICAgIGxldCBzZXEgPSAwCiAgICB0cnkgewogICAgICBzZXEgPSBjLmRlY29kZShjLnVpbnQsIHJlcS52YWx1ZSkKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBrID0gYjRhLnRvU3RyaW5nKHJlcS50YXJnZXQsICdoZXgnKQogICAgY29uc3QgdmFsdWUgPSB0aGlzLm11dGFibGVzLmdldChrKQoKICAgIGlmICghdmFsdWUpIHsKICAgICAgcmVxLnJlcGx5KG51bGwpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IGxvY2FsU2VxID0gYy5kZWNvZGUoYy51aW50LCB2YWx1ZSkKICAgIHJlcS5yZXBseShsb2NhbFNlcSA8IHNlcSA/IG51bGwgOiB2YWx1ZSkKICB9CgogIG9ubXV0YWJsZXB1dChyZXEpIHsKICAgIGlmICghcmVxLnRhcmdldCB8fCAhcmVxLnRva2VuIHx8ICFyZXEudmFsdWUpIHJldHVybgoKICAgIGNvbnN0IHAgPSBkZWNvZGUobS5tdXRhYmxlUHV0UmVxdWVzdCwgcmVxLnZhbHVlKQogICAgaWYgKCFwKSByZXR1cm4KCiAgICBjb25zdCB7IHB1YmxpY0tleSwgc2VxLCB2YWx1ZSwgc2lnbmF0dXJlIH0gPSBwCgogICAgY29uc3QgaGFzaCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goaGFzaCwgcHVibGljS2V5KQogICAgaWYgKCFiNGEuZXF1YWxzKGhhc2gsIHJlcS50YXJnZXQpKSByZXR1cm4KCiAgICBpZiAoIXZhbHVlIHx8ICF2ZXJpZnlNdXRhYmxlKHNpZ25hdHVyZSwgc2VxLCB2YWx1ZSwgcHVibGljS2V5KSkgcmV0dXJuCgogICAgY29uc3QgayA9IGI0YS50b1N0cmluZyhoYXNoLCAnaGV4JykKICAgIGNvbnN0IGxvY2FsID0gdGhpcy5tdXRhYmxlcy5nZXQoaykKCiAgICBpZiAobG9jYWwpIHsKICAgICAgY29uc3QgZXhpc3RpbmcgPSBjLmRlY29kZShtLm11dGFibGVHZXRSZXNwb25zZSwgbG9jYWwpCiAgICAgIGlmIChleGlzdGluZy52YWx1ZSAmJiBleGlzdGluZy5zZXEgPT09IHNlcSAmJiBiNGEuY29tcGFyZSh2YWx1ZSwgZXhpc3RpbmcudmFsdWUpICE9PSAwKSB7CiAgICAgICAgcmVxLmVycm9yKEVSUk9SLlNFUV9SRVVTRUQpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgaWYgKHNlcSA8IGV4aXN0aW5nLnNlcSkgewogICAgICAgIHJlcS5lcnJvcihFUlJPUi5TRVFfVE9PX0xPVykKICAgICAgICByZXR1cm4KICAgICAgfQogICAgfQoKICAgIHRoaXMubXV0YWJsZXMuc2V0KGssIGVuY29kZVVuc2xhYihtLm11dGFibGVHZXRSZXNwb25zZSwgeyBzZXEsIHZhbHVlLCBzaWduYXR1cmUgfSkpCiAgICByZXEucmVwbHkobnVsbCkKICB9CgogIG9uaW1tdXRhYmxlZ2V0KHJlcSkgewogICAgaWYgKCFyZXEudGFyZ2V0KSByZXR1cm4KCiAgICBjb25zdCBrID0gYjRhLnRvU3RyaW5nKHJlcS50YXJnZXQsICdoZXgnKQogICAgY29uc3QgdmFsdWUgPSB0aGlzLmltbXV0YWJsZXMuZ2V0KGspCgogICAgcmVxLnJlcGx5KHZhbHVlIHx8IG51bGwpCiAgfQoKICBvbmltbXV0YWJsZXB1dChyZXEpIHsKICAgIGlmICghcmVxLnRhcmdldCB8fCAhcmVxLnRva2VuIHx8ICFyZXEudmFsdWUpIHJldHVybgoKICAgIGNvbnN0IGhhc2ggPSBiNGEuYWxsb2MoMzIpCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGhhc2gsIHJlcS52YWx1ZSkKICAgIGlmICghYjRhLmVxdWFscyhoYXNoLCByZXEudGFyZ2V0KSkgcmV0dXJuCgogICAgY29uc3QgayA9IGI0YS50b1N0cmluZyhoYXNoLCAnaGV4JykKICAgIHRoaXMuaW1tdXRhYmxlcy5zZXQoaywgdW5zbGFiKHJlcS52YWx1ZSkpCgogICAgcmVxLnJlcGx5KG51bGwpCiAgfQoKICBkZXN0cm95KCkgewogICAgdGhpcy5yZWNvcmRzLmRlc3Ryb3koKQogICAgdGhpcy5yZWZyZXNoZXMuZGVzdHJveSgpCiAgICB0aGlzLm11dGFibGVzLmRlc3Ryb3koKQogICAgdGhpcy5pbW11dGFibGVzLmRlc3Ryb3koKQogIH0KCiAgc3RhdGljIHNpZ25NdXRhYmxlKHNlcSwgdmFsdWUsIGtleVBhaXIpIHsKICAgIGNvbnN0IHNpZ25hYmxlID0gYjRhLmFsbG9jVW5zYWZlKDMyICsgMzIpCiAgICBjb25zdCBoYXNoID0gc2lnbmFibGUuc3ViYXJyYXkoMzIpCgogICAgc2lnbmFibGUuc2V0KE5TLk1VVEFCTEVfUFVULCAwKQoKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goaGFzaCwgYy5lbmNvZGUobS5tdXRhYmxlU2lnbmFibGUsIHsgc2VxLCB2YWx1ZSB9KSkKICAgIHJldHVybiBzaWduKHNpZ25hYmxlLCBrZXlQYWlyKQogIH0KCiAgc3RhdGljIHZlcmlmeU11dGFibGUoc2lnbmF0dXJlLCBzZXEsIHZhbHVlLCBwdWJsaWNLZXkpIHsKICAgIHJldHVybiB2ZXJpZnlNdXRhYmxlKHNpZ25hdHVyZSwgc2VxLCB2YWx1ZSwgcHVibGljS2V5KQogIH0KCiAgc3RhdGljIHNpZ25Bbm5vdW5jZSh0YXJnZXQsIHRva2VuLCBpZCwgYW5uLCBrZXlQYWlyKSB7CiAgICByZXR1cm4gc2lnbihhbm5TaWduYWJsZSh0YXJnZXQsIHRva2VuLCBpZCwgYW5uLCBOUy5BTk5PVU5DRSksIGtleVBhaXIpCiAgfQoKICBzdGF0aWMgc2lnblVuYW5ub3VuY2UodGFyZ2V0LCB0b2tlbiwgaWQsIGFubiwga2V5UGFpcikgewogICAgcmV0dXJuIHNpZ24oYW5uU2lnbmFibGUodGFyZ2V0LCB0b2tlbiwgaWQsIGFubiwgTlMuVU5BTk5PVU5DRSksIGtleVBhaXIpCiAgfQp9CgpmdW5jdGlvbiB2ZXJpZnlNdXRhYmxlKHNpZ25hdHVyZSwgc2VxLCB2YWx1ZSwgcHVibGljS2V5KSB7CiAgY29uc3Qgc2lnbmFibGUgPSBiNGEuYWxsb2NVbnNhZmUoMzIgKyAzMikKICBjb25zdCBoYXNoID0gc2lnbmFibGUuc3ViYXJyYXkoMzIpCgogIHNpZ25hYmxlLnNldChOUy5NVVRBQkxFX1BVVCwgMCkKCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChoYXNoLCBjLmVuY29kZShtLm11dGFibGVTaWduYWJsZSwgeyBzZXEsIHZhbHVlIH0pKQogIHJldHVybiBzb2RpdW0uY3J5cHRvX3NpZ25fdmVyaWZ5X2RldGFjaGVkKHNpZ25hdHVyZSwgc2lnbmFibGUsIHB1YmxpY0tleSkKfQoKZnVuY3Rpb24gYW5uU2lnbmFibGUodGFyZ2V0LCB0b2tlbiwgaWQsIGFubiwgbnMpIHsKICBjb25zdCBzaWduYWJsZSA9IGI0YS5hbGxvY1Vuc2FmZSgzMiArIDMyKQogIGNvbnN0IGhhc2ggPSBzaWduYWJsZS5zdWJhcnJheSgzMikKCiAgc2lnbmFibGUuc2V0KG5zLCAwKQoKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKGhhc2gsIFsKICAgIHRhcmdldCwKICAgIGlkLAogICAgdG9rZW4sCiAgICBjLmVuY29kZShtLnBlZXIsIGFubi5wZWVyKSwgLy8gbm90ZSB0aGF0IHRoaXMgaXMgdGhlIHBhcnRpYWwgZW5jb2Rpbmcgb2YgdGhlIGFubm91bmNlIG1lc3NhZ2Ugc28gd2UgY291bGQganVzdCB1c2UgdGhhdCBmb3IgcGVyZgogICAgYW5uLnJlZnJlc2ggfHwgRU1QVFkKICBdKQoKICByZXR1cm4gc2lnbmFibGUKfQoKZnVuY3Rpb24gc2lnbihzaWduYWJsZSwga2V5UGFpcikgewogIGlmIChrZXlQYWlyLnNpZ24pIHsKICAgIHJldHVybiBrZXlQYWlyLnNpZ24oc2lnbmFibGUpCiAgfQogIGNvbnN0IHNlY3JldEtleSA9IGtleVBhaXIuc2VjcmV0S2V5ID8ga2V5UGFpci5zZWNyZXRLZXkgOiBrZXlQYWlyCiAgY29uc3Qgc2lnbmF0dXJlID0gYjRhLmFsbG9jVW5zYWZlKDY0KQogIHNvZGl1bS5jcnlwdG9fc2lnbl9kZXRhY2hlZChzaWduYXR1cmUsIHNpZ25hYmxlLCBzZWNyZXRLZXkpCiAgcmV0dXJuIHNpZ25hdHVyZQp9CgpmdW5jdGlvbiBkZWNvZGUoZW5jLCB2YWwpIHsKICB0cnkgewogICAgcmV0dXJuIHZhbCAmJiBjLmRlY29kZShlbmMsIHZhbCkKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBudWxsCiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUmF3U3RyZWFtU2V0IHsKICBjb25zdHJ1Y3RvcihkaHQpIHsKICAgIHRoaXMuX2RodCA9IGRodAoKICAgIHRoaXMuX3ByZWZpeCA9IDE2IC0gMSAvLyAxNiBpcyB0aGUgZGVmYXVsdCBzdHJlYW0tc2V0IHNpZGUgaW4gdWR4CiAgICB0aGlzLl9zdHJlYW1zID0gbmV3IE1hcCgpCiAgfQoKICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLl9zdHJlYW1zLnNpemUKICB9CgogIFtTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgcmV0dXJuIHRoaXMuX3N0cmVhbXMudmFsdWVzKCkKICB9CgogIGFkZChvcHRzKSB7CiAgICBjb25zdCBzZWxmID0gdGhpcwoKICAgIC8vIFRPRE86IHdlIHNob3VsZCBwcm9iIGhhdmUgYSB1ZHggaGVscGVyIGZvciBpZCBnZW5lcmF0aW9uLCBnaXZlbiB0aGUgc2xpZ2h0IGNvbXBsZXhpdHkKICAgIC8vIG9mIHRoZSBiZWxvdy4gcmVxdWlyZXMgYSBQUk5HIGluIHVkeCB0aG8uCgogICAgbGV0IGlkID0gMAoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlkID0gKE1hdGgucmFuZG9tKCkgKiAweDEwMDAwMDAwMCkgPj4+IDAKCiAgICAgIGlmICh0aGlzLl9zdHJlYW1zLmhhcyhpZCAmIHRoaXMuX3ByZWZpeCkpIGNvbnRpbnVlCiAgICAgIGJyZWFrCiAgICB9CgogICAgLy8gYWx3YXlzIGhhdmUgfjUwJSBjaGFuZ2Ugb2Ygcm9sbGluZyBhIGZyZWUgb25lCiAgICBpZiAoMiAqIHRoaXMuX3N0cmVhbXMuc2l6ZSA+PSB0aGlzLl9wcmVmaXgpIHsKICAgICAgLy8gaWUgMGIxMTExMSA9IDBiMTExMSArIDEgKyAwYjExMTEKICAgICAgdGhpcy5fcHJlZml4ID0gMiAqIHRoaXMuX3ByZWZpeCArIDEKCiAgICAgIC8vIG1vdmUgdGhlIHByZWZpeGVzIG92ZXIKICAgICAgY29uc3QgbmV4dCA9IG5ldyBNYXAoKQogICAgICBmb3IgKGNvbnN0IHN0cmVhbSBvZiB0aGlzLl9zdHJlYW1zLnZhbHVlcygpKSB7CiAgICAgICAgbmV4dC5zZXQoc3RyZWFtLmlkICYgdGhpcy5fcHJlZml4LCBzdHJlYW0pCiAgICAgIH0KICAgICAgdGhpcy5fc3RyZWFtcyA9IG5leHQKICAgIH0KCiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLl9kaHQudWR4LmNyZWF0ZVN0cmVhbShpZCwgb3B0cykKICAgIHRoaXMuX3N0cmVhbXMuc2V0KGlkICYgdGhpcy5fcHJlZml4LCBzdHJlYW0pCgogICAgc3RyZWFtLm9uKCdjbG9zZScsIG9uY2xvc2UpCgogICAgcmV0dXJuIHN0cmVhbQoKICAgIGZ1bmN0aW9uIG9uY2xvc2UoKSB7CiAgICAgIHNlbGYuX3N0cmVhbXMuZGVsZXRlKGlkICYgc2VsZi5fcHJlZml4KQogICAgfQogIH0KCiAgYXN5bmMgY2xlYXIoKSB7CiAgICBjb25zdCBkZXN0cm95aW5nID0gW10KCiAgICBmb3IgKGNvbnN0IHN0cmVhbSBvZiB0aGlzLl9zdHJlYW1zLnZhbHVlcygpKSB7CiAgICAgIGRlc3Ryb3lpbmcucHVzaChuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc3RyZWFtLm9uY2UoJ2Nsb3NlJywgcmVzb2x2ZSkuZGVzdHJveSgpKSkKICAgIH0KCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoZGVzdHJveWluZykKICB9Cn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBDYWNoZSA9IHJlcXVpcmUoJ3hhY2hlJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCB7IGhhbmRzaGFrZSwgaG9sZXB1bmNoIH0gPSByZXF1aXJlKCcuL21lc3NhZ2VzJykKY29uc3QgeyBDT01NQU5EUyB9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQpjb25zdCB7IEJBRF9IQU5EU0hBS0VfUkVQTFksIEJBRF9IT0xFUFVOQ0hfUkVQTFkgfSA9IHJlcXVpcmUoJy4vZXJyb3JzJykKCmNvbnN0IEZST01fQ0xJRU5UID0gMApjb25zdCBGUk9NX1NFUlZFUiA9IDEKY29uc3QgRlJPTV9SRUxBWSA9IDIKY29uc3QgRlJPTV9TRUNPTkRfUkVMQVkgPSAzCmNvbnN0IFJFUExZID0gNAoKLy8gVE9ETzogV2hpbGUgdGhlIGN1cnJlbnQgZGVzaWduIGlzIHZlcnkgdHJ1c3RsZXNzIGluIHJlZ2FyZHMgdG8gY2xpZW50cy9zZXJ2ZXJzIHRydXN0aW5nIHRoZSBESFQsCi8vIHdlIHNob3VsZCBhZGQgYSBidW5jaCBvZiByYXRlIGxpbWl0cyBldmVyeXdoZXJlLCBlc3BlY2lhbGx5IGluY2x1ZGluZyBoZXJlIHRvIGF2b2lkIGJhZCB1c2VycwovLyB1c2luZyBhIERIVCBub2RlIHRvIHJlbGF5IHRyYWZmaWMgaW5kaXNjcmltaW5hdGVseSB1c2luZyB0aGUgY29ubmVjdC9ob2xlcHVuY2ggbWVzc2FnZXMuCi8vIFRoYXQncyBtb3N0bHkgZnJvbSBhbiBhYnVzZSBQT1YgYXMgbm9uZSBvZiB0aGUgbWVzc3NhZ2VzIGRvIGFtcGxpY2F0aW9uLgoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSb3V0ZXIgewogIGNvbnN0cnVjdG9yKGRodCwgb3B0cykgewogICAgdGhpcy5kaHQgPSBkaHQKICAgIHRoaXMuZm9yd2FyZHMgPSBuZXcgQ2FjaGUob3B0cy5mb3J3YXJkcykKICB9CgogIHNldCh0YXJnZXQsIHN0YXRlKSB7CiAgICBpZiAoc3RhdGUub25wZWVyaGFuZHNoYWtlKSB7CiAgICAgIHRoaXMuZm9yd2FyZHMucmV0YWluKHRvU3RyaW5nKHRhcmdldCksIHN0YXRlKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5mb3J3YXJkcy5zZXQodG9TdHJpbmcodGFyZ2V0KSwgc3RhdGUpCiAgICB9CiAgfQoKICBnZXQodGFyZ2V0KSB7CiAgICByZXR1cm4gdGhpcy5mb3J3YXJkcy5nZXQodG9TdHJpbmcodGFyZ2V0KSkKICB9CgogIGRlbGV0ZSh0YXJnZXQpIHsKICAgIHRoaXMuZm9yd2FyZHMuZGVsZXRlKHRvU3RyaW5nKHRhcmdldCkpCiAgfQoKICBkZXN0cm95KCkgewogICAgdGhpcy5mb3J3YXJkcy5kZXN0cm95KCkKICB9CgogIGFzeW5jIHBlZXJIYW5kc2hha2UodGFyZ2V0LCB7IG5vaXNlLCBwZWVyQWRkcmVzcywgcmVsYXlBZGRyZXNzLCBzb2NrZXQsIHNlc3Npb24gfSwgdG8pIHsKICAgIGNvbnN0IGRodCA9IHRoaXMuZGh0CgogICAgY29uc3QgcmVxdWVzdFZhbHVlID0gYy5lbmNvZGUoaGFuZHNoYWtlLCB7CiAgICAgIG1vZGU6IEZST01fQ0xJRU5ULAogICAgICBub2lzZSwKICAgICAgcGVlckFkZHJlc3MsCiAgICAgIHJlbGF5QWRkcmVzcwogICAgfSkKCiAgICBjb25zdCByZXMgPSBhd2FpdCBkaHQucmVxdWVzdCgKICAgICAgeyBjb21tYW5kOiBDT01NQU5EUy5QRUVSX0hBTkRTSEFLRSwgdGFyZ2V0LCB2YWx1ZTogcmVxdWVzdFZhbHVlIH0sCiAgICAgIHRvLAogICAgICB7IHNvY2tldCwgc2Vzc2lvbiB9CiAgICApCgogICAgY29uc3QgaHMgPSBkZWNvZGUoaGFuZHNoYWtlLCByZXMudmFsdWUpCiAgICBpZiAoCiAgICAgICFocyB8fAogICAgICBocy5tb2RlICE9PSBSRVBMWSB8fAogICAgICB0by5ob3N0ICE9PSByZXMuZnJvbS5ob3N0IHx8CiAgICAgIHRvLnBvcnQgIT09IHJlcy5mcm9tLnBvcnQgfHwKICAgICAgIWhzLm5vaXNlCiAgICApIHsKICAgICAgdGhyb3cgQkFEX0hBTkRTSEFLRV9SRVBMWSgpCiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgbm9pc2U6IGhzLm5vaXNlLAogICAgICByZWxheWVkOiAhIWhzLnBlZXJBZGRyZXNzLAogICAgICBzZXJ2ZXJBZGRyZXNzOiBocy5wZWVyQWRkcmVzcyB8fCB0bywKICAgICAgY2xpZW50QWRkcmVzczogcmVzLnRvCiAgICB9CiAgfQoKICBhc3luYyBvbnBlZXJoYW5kc2hha2UocmVxKSB7CiAgICBjb25zdCBocyA9IHJlcS52YWx1ZSAmJiBkZWNvZGUoaGFuZHNoYWtlLCByZXEudmFsdWUpCiAgICBpZiAoIWhzKSByZXR1cm4KCiAgICBjb25zdCB7IG1vZGUsIG5vaXNlLCBwZWVyQWRkcmVzcywgcmVsYXlBZGRyZXNzIH0gPSBocwoKICAgIGNvbnN0IHN0YXRlID0gcmVxLnRhcmdldCAmJiB0aGlzLmdldChyZXEudGFyZ2V0KQogICAgY29uc3QgaXNTZXJ2ZXIgPSAhIShzdGF0ZSAmJiBzdGF0ZS5vbnBlZXJoYW5kc2hha2UpCiAgICBjb25zdCByZWxheSA9IHN0YXRlICYmIHN0YXRlLnJlbGF5CgogICAgaWYgKGlzU2VydmVyKSB7CiAgICAgIGxldCByZXBseSA9IG51bGwKICAgICAgdHJ5IHsKICAgICAgICByZXBseSA9IG5vaXNlICYmIChhd2FpdCBzdGF0ZS5vbnBlZXJoYW5kc2hha2UoeyBub2lzZSwgcGVlckFkZHJlc3MgfSwgcmVxKSkKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHNhZmV0eUNhdGNoKGUpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgaWYgKCFyZXBseSB8fCAhcmVwbHkubm9pc2UpIHJldHVybgogICAgICBjb25zdCBvcHRzID0geyBzb2NrZXQ6IHJlcGx5LnNvY2tldCwgY2xvc2VyTm9kZXM6IGZhbHNlLCB0b2tlbjogZmFsc2UgfQoKICAgICAgc3dpdGNoIChtb2RlKSB7CiAgICAgICAgY2FzZSBGUk9NX0NMSUVOVDogewogICAgICAgICAgcmVxLnJlcGx5KAogICAgICAgICAgICBjLmVuY29kZShoYW5kc2hha2UsIHsgbW9kZTogUkVQTFksIG5vaXNlOiByZXBseS5ub2lzZSwgcGVlckFkZHJlc3M6IG51bGwgfSksCiAgICAgICAgICAgIG9wdHMKICAgICAgICAgICkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICBjYXNlIEZST01fUkVMQVk6IHsKICAgICAgICAgIHJlcS5yZWxheSgKICAgICAgICAgICAgYy5lbmNvZGUoaGFuZHNoYWtlLCB7IG1vZGU6IEZST01fU0VSVkVSLCBub2lzZTogcmVwbHkubm9pc2UsIHBlZXJBZGRyZXNzIH0pLAogICAgICAgICAgICByZXEuZnJvbSwKICAgICAgICAgICAgb3B0cwogICAgICAgICAgKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIGNhc2UgRlJPTV9TRUNPTkRfUkVMQVk6IHsKICAgICAgICAgIGlmICghcmVsYXlBZGRyZXNzKSByZXR1cm4KICAgICAgICAgIHJlcS5yZWxheSgKICAgICAgICAgICAgYy5lbmNvZGUoaGFuZHNoYWtlLCB7IG1vZGU6IEZST01fU0VSVkVSLCBub2lzZTogcmVwbHkubm9pc2UsIHBlZXJBZGRyZXNzIH0pLAogICAgICAgICAgICByZWxheUFkZHJlc3MsCiAgICAgICAgICAgIG9wdHMKICAgICAgICAgICkKICAgICAgICAgIHJldHVybiAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICBjYXNlIEZST01fQ0xJRU5UOiB7CiAgICAgICAgICAvLyBUT0RPOiBpZiBubyByZWxheSBpcyBrbm93biByb3V0ZSBjbG9zZXIgdG8gdGhlIHRhcmdldCBpbnN0ZWFkIG9mIHRpbWluZyBvdXQKICAgICAgICAgIGlmICghbm9pc2UpIHJldHVybgogICAgICAgICAgaWYgKCFyZWxheSAmJiAhcmVsYXlBZGRyZXNzKSB7CiAgICAgICAgICAgIC8vIGhlbHAgdGhlIHVzZXIgcm91dGUKICAgICAgICAgICAgcmVxLnJlcGx5KG51bGwsIHsgdG9rZW46IGZhbHNlLCBjbG9zZXJOb2RlczogdHJ1ZSB9KQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgIH0KICAgICAgICAgIHJlcS5yZWxheSgKICAgICAgICAgICAgYy5lbmNvZGUoaGFuZHNoYWtlLCB7CiAgICAgICAgICAgICAgbW9kZTogRlJPTV9SRUxBWSwKICAgICAgICAgICAgICBub2lzZSwKICAgICAgICAgICAgICBwZWVyQWRkcmVzczogcmVxLmZyb20sCiAgICAgICAgICAgICAgcmVsYXlBZGRyZXNzOiBudWxsCiAgICAgICAgICAgIH0pLAogICAgICAgICAgICByZWxheUFkZHJlc3MgfHwgcmVsYXkKICAgICAgICAgICkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICBjYXNlIEZST01fUkVMQVk6IHsKICAgICAgICAgIGlmICghcmVsYXkgfHwgIW5vaXNlKSByZXR1cm4KICAgICAgICAgIHJlcS5yZWxheSgKICAgICAgICAgICAgYy5lbmNvZGUoaGFuZHNoYWtlLCB7CiAgICAgICAgICAgICAgbW9kZTogRlJPTV9TRUNPTkRfUkVMQVksCiAgICAgICAgICAgICAgbm9pc2UsCiAgICAgICAgICAgICAgcGVlckFkZHJlc3MsCiAgICAgICAgICAgICAgcmVsYXlBZGRyZXNzOiByZXEuZnJvbQogICAgICAgICAgICB9KSwKICAgICAgICAgICAgcmVsYXkKICAgICAgICAgICkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICBjYXNlIEZST01fU0VSVkVSOiB7CiAgICAgICAgICBpZiAoIXBlZXJBZGRyZXNzIHx8ICFub2lzZSkgcmV0dXJuCiAgICAgICAgICByZXEucmVwbHkoCiAgICAgICAgICAgIGMuZW5jb2RlKGhhbmRzaGFrZSwgeyBtb2RlOiBSRVBMWSwgbm9pc2UsIHBlZXJBZGRyZXNzOiByZXEuZnJvbSwgcmVsYXlBZGRyZXNzOiBudWxsIH0pLAogICAgICAgICAgICB7IHRvOiBwZWVyQWRkcmVzcywgY2xvc2VyTm9kZXM6IGZhbHNlLCB0b2tlbjogZmFsc2UgfQogICAgICAgICAgKQogICAgICAgICAgcmV0dXJuIC8vIGVzbGludC1kaXNhYmxlLWxpbmUKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGFzeW5jIHBlZXJIb2xlcHVuY2godGFyZ2V0LCB7IGlkLCBwYXlsb2FkLCBwZWVyQWRkcmVzcywgc29ja2V0LCBzZXNzaW9uIH0sIHRvKSB7CiAgICBjb25zdCBkaHQgPSB0aGlzLmRodAogICAgY29uc3QgcmVxdWVzdFZhbHVlID0gYy5lbmNvZGUoaG9sZXB1bmNoLCB7CiAgICAgIG1vZGU6IEZST01fQ0xJRU5ULAogICAgICBpZCwKICAgICAgcGF5bG9hZCwKICAgICAgcGVlckFkZHJlc3MKICAgIH0pCgogICAgY29uc3QgcmVzID0gYXdhaXQgZGh0LnJlcXVlc3QoCiAgICAgIHsgY29tbWFuZDogQ09NTUFORFMuUEVFUl9IT0xFUFVOQ0gsIHRhcmdldCwgdmFsdWU6IHJlcXVlc3RWYWx1ZSB9LAogICAgICB0bywKICAgICAgeyBzb2NrZXQsIHNlc3Npb24gfQogICAgKQoKICAgIGNvbnN0IGhwID0gZGVjb2RlKGhvbGVwdW5jaCwgcmVzLnZhbHVlKQogICAgaWYgKCFocCB8fCBocC5tb2RlICE9PSBSRVBMWSB8fCB0by5ob3N0ICE9PSByZXMuZnJvbS5ob3N0IHx8IHRvLnBvcnQgIT09IHJlcy5mcm9tLnBvcnQpIHsKICAgICAgdGhyb3cgQkFEX0hPTEVQVU5DSF9SRVBMWSgpCiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZnJvbTogcmVzLmZyb20sCiAgICAgIHRvOiByZXMudG8sCiAgICAgIHBheWxvYWQ6IGhwLnBheWxvYWQsCiAgICAgIHBlZXJBZGRyZXNzOiBocC5wZWVyQWRkcmVzcyB8fCB0bwogICAgfQogIH0KCiAgYXN5bmMgb25wZWVyaG9sZXB1bmNoKHJlcSkgewogICAgY29uc3QgaHAgPSByZXEudmFsdWUgJiYgZGVjb2RlKGhvbGVwdW5jaCwgcmVxLnZhbHVlKQogICAgaWYgKCFocCkgcmV0dXJuCgogICAgY29uc3QgeyBtb2RlLCBpZCwgcGF5bG9hZCwgcGVlckFkZHJlc3MgfSA9IGhwCgogICAgY29uc3Qgc3RhdGUgPSByZXEudGFyZ2V0ICYmIHRoaXMuZ2V0KHJlcS50YXJnZXQpCiAgICBjb25zdCBpc1NlcnZlciA9ICEhKHN0YXRlICYmIHN0YXRlLm9ucGVlcmhvbGVwdW5jaCkKICAgIGNvbnN0IHJlbGF5ID0gc3RhdGUgJiYgc3RhdGUucmVsYXkKCiAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgY2FzZSBGUk9NX0NMSUVOVDogewogICAgICAgIGlmICghcGVlckFkZHJlc3MgJiYgIXJlbGF5KSByZXR1cm4KICAgICAgICByZXEucmVsYXkoCiAgICAgICAgICBjLmVuY29kZShob2xlcHVuY2gsIHsgbW9kZTogRlJPTV9SRUxBWSwgaWQsIHBheWxvYWQsIHBlZXJBZGRyZXNzOiByZXEuZnJvbSB9KSwKICAgICAgICAgIHBlZXJBZGRyZXNzIHx8IHJlbGF5CiAgICAgICAgKQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIGNhc2UgRlJPTV9SRUxBWTogewogICAgICAgIGlmICghaXNTZXJ2ZXIgfHwgIXBlZXJBZGRyZXNzKSByZXR1cm4KICAgICAgICBsZXQgcmVwbHkgPSBudWxsCiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJlcGx5ID0gYXdhaXQgc3RhdGUub25wZWVyaG9sZXB1bmNoKHsgaWQsIHBheWxvYWQsIHBlZXJBZGRyZXNzIH0sIHJlcSkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBzYWZldHlDYXRjaChlKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIGlmICghcmVwbHkpIHJldHVybgogICAgICAgIGNvbnN0IG9wdHMgPSB7IHNvY2tldDogcmVwbHkuc29ja2V0LCBjbG9zZXJOb2RlczogZmFsc2UsIHRva2VuOiBmYWxzZSB9CiAgICAgICAgcmVxLnJlbGF5KAogICAgICAgICAgYy5lbmNvZGUoaG9sZXB1bmNoLCB7IG1vZGU6IEZST01fU0VSVkVSLCBpZDogMCwgcGF5bG9hZDogcmVwbHkucGF5bG9hZCwgcGVlckFkZHJlc3MgfSksCiAgICAgICAgICByZXEuZnJvbSwKICAgICAgICAgIG9wdHMKICAgICAgICApCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgY2FzZSBGUk9NX1NFUlZFUjogewogICAgICAgIHJlcS5yZXBseShjLmVuY29kZShob2xlcHVuY2gsIHsgbW9kZTogUkVQTFksIGlkLCBwYXlsb2FkLCBwZWVyQWRkcmVzczogcmVxLmZyb20gfSksIHsKICAgICAgICAgIHRvOiBwZWVyQWRkcmVzcywKICAgICAgICAgIGNsb3Nlck5vZGVzOiBmYWxzZSwKICAgICAgICAgIHRva2VuOiBmYWxzZQogICAgICAgIH0pCiAgICAgICAgcmV0dXJuIC8vIGVzbGludC1kaXNhYmxlLWxpbmUKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gZGVjb2RlKGVuYywgdmFsKSB7CiAgdHJ5IHsKICAgIHJldHVybiBjLmRlY29kZShlbmMsIHZhbCkKICB9IGNhdGNoIHsKICAgIHJldHVybiBudWxsCiAgfQp9CgpmdW5jdGlvbiB0b1N0cmluZyh0KSB7CiAgcmV0dXJuIHR5cGVvZiB0ID09PSAnc3RyaW5nJyA/IHQgOiBiNGEudG9TdHJpbmcodCwgJ2hleCcpCn0KY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHsgaG9sZXB1bmNoUGF5bG9hZCB9ID0gcmVxdWlyZSgnLi9tZXNzYWdlcycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEhvbGVwdW5jaFBheWxvYWQgewogIGNvbnN0cnVjdG9yKGhvbGVwdW5jaFNlY3JldCkgewogICAgdGhpcy5fc2hhcmVkU2VjcmV0ID0gaG9sZXB1bmNoU2VjcmV0CiAgICB0aGlzLl9sb2NhbFNlY3JldCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKCiAgICBzb2RpdW0ucmFuZG9tYnl0ZXNfYnVmKHRoaXMuX2xvY2FsU2VjcmV0KQogIH0KCiAgZGVjcnlwdChidWZmZXIpIHsKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMjQsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGggLSAxNiwgYnVmZmVyIH0KCiAgICBpZiAoc3RhdGUuZW5kIDw9IHN0YXRlLnN0YXJ0KSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IG5vbmNlID0gYnVmZmVyLnN1YmFycmF5KDAsIDI0KQogICAgY29uc3QgbXNnID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0LCBzdGF0ZS5lbmQpCiAgICBjb25zdCBjaXBoZXIgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQpCgogICAgaWYgKCFzb2RpdW0uY3J5cHRvX3NlY3JldGJveF9vcGVuX2Vhc3kobXNnLCBjaXBoZXIsIG5vbmNlLCB0aGlzLl9zaGFyZWRTZWNyZXQpKSByZXR1cm4gbnVsbAoKICAgIHRyeSB7CiAgICAgIHJldHVybiBob2xlcHVuY2hQYXlsb2FkLmRlY29kZShzdGF0ZSkKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gbnVsbAogICAgfQogIH0KCiAgZW5jcnlwdChwYXlsb2FkKSB7CiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDI0LCBlbmQ6IDI0LCBidWZmZXI6IG51bGwgfQogICAgaG9sZXB1bmNoUGF5bG9hZC5wcmVlbmNvZGUoc3RhdGUsIHBheWxvYWQpCiAgICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kICsgMTYpCgogICAgY29uc3Qgbm9uY2UgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoMCwgMjQpCiAgICBjb25zdCBtc2cgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIHN0YXRlLmVuZCkKICAgIGNvbnN0IGNpcGhlciA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCkKCiAgICBob2xlcHVuY2hQYXlsb2FkLmVuY29kZShzdGF0ZSwgcGF5bG9hZCkKICAgIHNvZGl1bS5yYW5kb21ieXRlc19idWYobm9uY2UpCiAgICBzb2RpdW0uY3J5cHRvX3NlY3JldGJveF9lYXN5KGNpcGhlciwgbXNnLCBub25jZSwgdGhpcy5fc2hhcmVkU2VjcmV0KQoKICAgIHJldHVybiBzdGF0ZS5idWZmZXIKICB9CgogIHRva2VuKGFkZHIpIHsKICAgIGNvbnN0IG91dCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2gob3V0LCBiNGEuZnJvbShhZGRyLmhvc3QpLCB0aGlzLl9sb2NhbFNlY3JldCkKICAgIHJldHVybiBvdXQKICB9Cn0KY29uc3QgRE9ORSA9IFByb21pc2UucmVzb2x2ZSh0cnVlKQpjb25zdCBERVNUUk9ZRUQgPSBQcm9taXNlLnJlc29sdmUoZmFsc2UpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFNlbWFwaG9yZSB7CiAgY29uc3RydWN0b3IobGltaXQgPSAxKSB7CiAgICB0aGlzLmxpbWl0ID0gbGltaXQKICAgIHRoaXMuYWN0aXZlID0gMAogICAgdGhpcy53YWl0aW5nID0gW10KCiAgICB0aGlzLmZsdXNoZWRQcm9taXNlID0gbnVsbAogICAgdGhpcy5mbHVzaGVkUmVzb2x2ZSA9IG51bGwKCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCgogICAgdGhpcy5fb253YWl0ID0gdGhpcy5fcXVldWVXYWl0aW5nLmJpbmQodGhpcykKICAgIHRoaXMuX29uZmx1c2ggPSB0aGlzLl9xdWV1ZUZsdXNoZWQuYmluZCh0aGlzKQogIH0KCiAgX3F1ZXVlV2FpdGluZyhyZXNvbHZlKSB7CiAgICB0aGlzLndhaXRpbmcucHVzaChyZXNvbHZlKQogIH0KCiAgX3F1ZXVlRmx1c2hlZChyZXNvbHZlKSB7CiAgICB0aGlzLmZsdXNoZWRSZXNvbHZlID0gcmVzb2x2ZQogIH0KCiAgd2FpdCgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCA9PT0gdHJ1ZSkgcmV0dXJuIERFU1RST1lFRAoKICAgIGlmICh0aGlzLmFjdGl2ZSA8IHRoaXMubGltaXQgJiYgdGhpcy53YWl0aW5nLmxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLmFjdGl2ZSsrCiAgICAgIHJldHVybiBET05FCiAgICB9CgogICAgcmV0dXJuIG5ldyBQcm9taXNlKHRoaXMuX29ud2FpdCkKICB9CgogIHNpZ25hbCgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCA9PT0gdHJ1ZSkgcmV0dXJuCgogICAgdGhpcy5hY3RpdmUtLQogICAgd2hpbGUgKHRoaXMuYWN0aXZlIDwgdGhpcy5saW1pdCAmJiB0aGlzLndhaXRpbmcubGVuZ3RoID4gMCAmJiB0aGlzLmRlc3Ryb3llZCA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5hY3RpdmUrKwogICAgICB0aGlzLndhaXRpbmcuc2hpZnQoKSh0cnVlKQogICAgfQoKICAgIGlmICh0aGlzLmFjdGl2ZSA9PT0gMCAmJiB0aGlzLmZsdXNoZWRSZXNvbHZlKSB7CiAgICAgIGNvbnN0IHJlc29sdmUgPSB0aGlzLmZsdXNoZWRSZXNvbHZlCiAgICAgIHRoaXMuZmx1c2hlZFJlc29sdmUgPSBudWxsCiAgICAgIHRoaXMuZmx1c2hlZFByb21pc2UgPSBudWxsCiAgICAgIHJlc29sdmUodHJ1ZSkKICAgIH0KICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkID09PSB0cnVlKSByZXR1cm4KICAgIGlmICh0aGlzLmFjdGl2ZSA9PT0gMCkgcmV0dXJuCiAgICBpZiAodGhpcy5mbHVzaGVkUHJvbWlzZSkgcmV0dXJuIHRoaXMuZmx1c2hlZFByb21pc2UKICAgIHRoaXMuZmx1c2hlZFByb21pc2UgPSBuZXcgUHJvbWlzZSh0aGlzLl9vbmZsdXNoKQogICAgcmV0dXJuIHRoaXMuZmx1c2hlZFByb21pc2UKICB9CgogIGRlc3Ryb3koKSB7CiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICAgIHRoaXMuYWN0aXZlID0gMAogICAgd2hpbGUgKHRoaXMud2FpdGluZy5sZW5ndGgpIHRoaXMud2FpdGluZy5wb3AoKShmYWxzZSkKICAgIGlmICh0aGlzLmZsdXNoZWRSZXNvbHZlKSB0aGlzLmZsdXNoZWRSZXNvbHZlKGZhbHNlKQogIH0KfQpjb25zdCB7IEV2ZW50RW1pdHRlciB9ID0gcmVxdWlyZSgnZXZlbnRzJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCBOb2lzZVNlY3JldFN0cmVhbSA9IHJlcXVpcmUoJ0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0nKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCByZWxheSA9IHJlcXVpcmUoJ2JsaW5kLXJlbGF5JykKY29uc3QgTm9pc2VXcmFwID0gcmVxdWlyZSgnLi9ub2lzZS13cmFwJykKY29uc3QgQW5ub3VuY2VyID0gcmVxdWlyZSgnLi9hbm5vdW5jZXInKQpjb25zdCB7IEZJUkVXQUxMLCBFUlJPUiB9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQpjb25zdCB7IHVuc2xhYmJlZEhhc2ggfSA9IHJlcXVpcmUoJy4vY3J5cHRvJykKY29uc3QgU2VjdXJlUGF5bG9hZCA9IHJlcXVpcmUoJy4vc2VjdXJlLXBheWxvYWQnKQpjb25zdCBIb2xlcHVuY2hlciA9IHJlcXVpcmUoJy4vaG9sZXB1bmNoZXInKQpjb25zdCB7IGlzUHJpdmF0ZSB9ID0gcmVxdWlyZSgnYm9nb24nKQpjb25zdCB7IEFMUkVBRFlfTElTVEVOSU5HLCBOT0RFX0RFU1RST1lFRCwgS0VZUEFJUl9BTFJFQURZX1VTRUQgfSA9IHJlcXVpcmUoJy4vZXJyb3JzJykKCmNvbnN0IEhBTkRTSEFLRV9DTEVBUl9XQUlUID0gMTAwMDAKY29uc3QgSEFORFNIQUtFX0lOSVRJQUxfVElNRU9VVCA9IDEwMDAwCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFNlcnZlciBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IoZGh0LCBvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmRodCA9IGRodAogICAgdGhpcy50YXJnZXQgPSBudWxsCgogICAgdGhpcy5jbG9zZWQgPSBmYWxzZQogICAgdGhpcy5maXJld2FsbCA9IG9wdHMuZmlyZXdhbGwgfHwgKCgpID0+IGZhbHNlKQogICAgdGhpcy5ob2xlcHVuY2ggPSBvcHRzLmhvbGVwdW5jaCB8fCAoKCkgPT4gdHJ1ZSkKICAgIHRoaXMucmVsYXlUaHJvdWdoID0gb3B0cy5yZWxheVRocm91Z2ggfHwgbnVsbAogICAgdGhpcy5yZWxheUtlZXBBbGl2ZSA9IG9wdHMucmVsYXlLZWVwQWxpdmUgfHwgNTAwMAogICAgdGhpcy5wb29sID0gb3B0cy5wb29sIHx8IG51bGwKICAgIHRoaXMuY3JlYXRlSGFuZHNoYWtlID0gb3B0cy5jcmVhdGVIYW5kc2hha2UgfHwgZGVmYXVsdENyZWF0ZUhhbmRzaGFrZQogICAgdGhpcy5jcmVhdGVTZWNyZXRTdHJlYW0gPSBvcHRzLmNyZWF0ZVNlY3JldFN0cmVhbSB8fCBkZWZhdWx0Q3JlYXRlU2VjcmV0U3RyZWFtCiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCiAgICB0aGlzLmhhbmRzaGFrZUNsZWFyV2FpdCA9IG9wdHMuaGFuZHNoYWtlQ2xlYXJXYWl0IHx8IEhBTkRTSEFLRV9DTEVBUl9XQUlUCgogICAgdGhpcy5fc2hhcmVMb2NhbEFkZHJlc3MgPSBvcHRzLnNoYXJlTG9jYWxBZGRyZXNzICE9PSBmYWxzZQogICAgdGhpcy5fcmV1c2FibGVTb2NrZXQgPSAhIW9wdHMucmV1c2FibGVTb2NrZXQKICAgIHRoaXMuX25ldmVyUHVuY2ggPSBvcHRzLmhvbGVwdW5jaCA9PT0gZmFsc2UgLy8gdXNlZnVsIGZvciBmdWxseSBkaXNhYmxpbmcgcHVuY2hpbmcKICAgIHRoaXMuX2tleVBhaXIgPSBudWxsCiAgICB0aGlzLl9hbm5vdW5jZXIgPSBudWxsCiAgICB0aGlzLl9jb25uZWN0cyA9IG5ldyBNYXAoKQogICAgdGhpcy5faG9sZXB1bmNoZXMgPSBbXQogICAgdGhpcy5fbGlzdGVuaW5nID0gbnVsbAogICAgdGhpcy5fY2xvc2luZyA9IG51bGwKICB9CgogIGdldCBsaXN0ZW5pbmcoKSB7CiAgICByZXR1cm4gdGhpcy5fbGlzdGVuaW5nICE9PSBudWxsCiAgfQoKICBnZXQgcHVibGljS2V5KCkgewogICAgcmV0dXJuIHRoaXMuX2tleVBhaXIgJiYgdGhpcy5fa2V5UGFpci5wdWJsaWNLZXkKICB9CgogIGdldCByZWxheUFkZHJlc3NlcygpIHsKICAgIHJldHVybiB0aGlzLl9hbm5vdW5jZXIgPyB0aGlzLl9hbm5vdW5jZXIucmVsYXlBZGRyZXNzZXMgOiBbXQogIH0KCiAgb25jb25uZWN0aW9uKGVuY3J5cHRlZFNvY2tldCkgewogICAgdGhpcy5lbWl0KCdjb25uZWN0aW9uJywgZW5jcnlwdGVkU29ja2V0KQogIH0KCiAgYXN5bmMgc3VzcGVuZCh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICBsb2coJ1N1c3BlbmRpbmcgaHlwZXJkaHQgc2VydmVyJykKICAgIGlmICh0aGlzLl9saXN0ZW5pbmcgIT09IG51bGwpIGF3YWl0IHRoaXMuX2xpc3RlbmluZwogICAgbG9nKCdTdXNwZW5kaW5nIGh5cGVyZGh0IHNlcnZlciAocG9zdCBsaXN0ZW5pbmcpJykKICAgIHRoaXMuc3VzcGVuZGVkID0gdHJ1ZQogICAgdGhpcy5fY2xlYXJBbGwoKQogICAgcmV0dXJuIHRoaXMuX2Fubm91bmNlciA/IHRoaXMuX2Fubm91bmNlci5zdXNwZW5kKHsgbG9nIH0pIDogUHJvbWlzZS5yZXNvbHZlKCkKICB9CgogIGFzeW5jIHJlc3VtZSgpIHsKICAgIGlmICh0aGlzLl9saXN0ZW5pbmcgIT09IG51bGwpIGF3YWl0IHRoaXMuX2xpc3RlbmluZwogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgcmV0dXJuIHRoaXMuX2Fubm91bmNlciA/IHRoaXMuX2Fubm91bmNlci5yZXN1bWUoKSA6IFByb21pc2UucmVzb2x2ZSgpCiAgfQoKICBhZGRyZXNzKCkgewogICAgaWYgKCF0aGlzLl9rZXlQYWlyKSByZXR1cm4gbnVsbAoKICAgIHJldHVybiB7CiAgICAgIHB1YmxpY0tleTogdGhpcy5fa2V5UGFpci5wdWJsaWNLZXksCiAgICAgIGhvc3Q6IHRoaXMuZGh0Lmhvc3QsCiAgICAgIHBvcnQ6IHRoaXMuZGh0LnBvcnQKICAgIH0KICB9CgogIGNsb3NlKCkgewogICAgaWYgKHRoaXMuX2Nsb3NpbmcpIHJldHVybiB0aGlzLl9jbG9zaW5nCiAgICB0aGlzLl9jbG9zaW5nID0gdGhpcy5fY2xvc2UoKQogICAgcmV0dXJuIHRoaXMuX2Nsb3NpbmcKICB9CgogIF9nYygpIHsKICAgIHRoaXMuZGh0Lmxpc3RlbmluZy5kZWxldGUodGhpcykKICAgIGlmICh0aGlzLnRhcmdldCkgdGhpcy5kaHQuX3JvdXRlci5kZWxldGUodGhpcy50YXJnZXQpCiAgfQoKICBhc3luYyBfc3RvcExpc3RlbmluZygpIHsKICAgIHRyeSB7CiAgICAgIGlmICh0aGlzLl9hbm5vdW5jZXIpIGF3YWl0IHRoaXMuX2Fubm91bmNlci5zdG9wKCkKICAgIH0gY2F0Y2ggewogICAgICAvLyBpZ25vcmUKICAgIH0KCiAgICB0aGlzLl9hbm5vdW5jZXIgPSBudWxsCiAgICB0aGlzLl9saXN0ZW5pbmcgPSBudWxsCiAgICB0aGlzLl9rZXlQYWlyID0gbnVsbAogIH0KCiAgYXN5bmMgX2Nsb3NlKCkgewogICAgaWYgKHRoaXMuX2xpc3RlbmluZyA9PT0gbnVsbCkgewogICAgICB0aGlzLmNsb3NlZCA9IHRydWUKICAgICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2xpc3RlbmluZwogICAgfSBjYXRjaCB7fQoKICAgIHRoaXMuX2djKCkKICAgIHRoaXMuX2NsZWFyQWxsKCkKCiAgICBhd2FpdCB0aGlzLl9zdG9wTGlzdGVuaW5nKCkKCiAgICB0aGlzLmNsb3NlZCA9IHRydWUKICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogIH0KCiAgX2NsZWFyQWxsKCkgewogICAgd2hpbGUgKHRoaXMuX2hvbGVwdW5jaGVzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgaCA9IHRoaXMuX2hvbGVwdW5jaGVzLnBvcCgpCiAgICAgIGlmIChoICYmIGgucHVuY2hlcikgaC5wdW5jaGVyLmRlc3Ryb3koKQogICAgICBpZiAoaCAmJiBoLmNsZWFyaW5nKSBjbGVhclRpbWVvdXQoaC5jbGVhcmluZykKICAgICAgaWYgKGggJiYgaC5wcmVwdW5jaGluZykgY2xlYXJUaW1lb3V0KGgucHJlcHVuY2hpbmcpCiAgICAgIGlmIChoICYmIGgucmF3U3RyZWFtKSBoLnJhd1N0cmVhbS5kZXN0cm95KCkKICAgIH0KCiAgICB0aGlzLl9jb25uZWN0cy5jbGVhcigpCiAgfQoKICBhc3luYyBsaXN0ZW4oa2V5UGFpciA9IHRoaXMuZGh0LmRlZmF1bHRLZXlQYWlyLCBvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLl9saXN0ZW5pbmcgIT09IG51bGwpIHRocm93IEFMUkVBRFlfTElTVEVOSU5HKCkKICAgIGlmICh0aGlzLmRodC5kZXN0cm95ZWQpIHRocm93IE5PREVfREVTVFJPWUVEKCkKCiAgICB0aGlzLl9saXN0ZW5pbmcgPSB0aGlzLl9saXN0ZW4oa2V5UGFpciwgb3B0cykKICAgIGF3YWl0IHRoaXMuX2xpc3RlbmluZwogICAgcmV0dXJuIHRoaXMKICB9CgogIGFzeW5jIF9saXN0ZW4oa2V5UGFpciwgb3B0cykgewogICAgLy8gRnJvbSBub3cgb24sIHRoZSBESFQgb2JqZWN0IHdoaWNoIGNyZWF0ZWQgbWUgaXMgcmVzcG9uc2libGUgZm9yIGNsb3NpbmcgbWUKICAgIHRoaXMuZGh0Lmxpc3RlbmluZy5hZGQodGhpcykKCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLmRodC5iaW5kKCkKICAgICAgaWYgKHRoaXMuX2Nsb3NpbmcpIHJldHVybgoKICAgICAgZm9yIChjb25zdCBzIG9mIHRoaXMuZGh0Lmxpc3RlbmluZykgewogICAgICAgIGlmIChzLl9rZXlQYWlyICYmIGI0YS5lcXVhbHMocy5fa2V5UGFpci5wdWJsaWNLZXksIGtleVBhaXIucHVibGljS2V5KSkgewogICAgICAgICAgdGhyb3cgS0VZUEFJUl9BTFJFQURZX1VTRUQoKQogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy50YXJnZXQgPSB1bnNsYWJiZWRIYXNoKGtleVBhaXIucHVibGljS2V5KQogICAgICB0aGlzLl9rZXlQYWlyID0ga2V5UGFpcgogICAgICB0aGlzLl9hbm5vdW5jZXIgPSBuZXcgQW5ub3VuY2VyKHRoaXMuZGh0LCBrZXlQYWlyLCB0aGlzLnRhcmdldCwgb3B0cykKCiAgICAgIHRoaXMuZGh0Ll9yb3V0ZXIuc2V0KHRoaXMudGFyZ2V0LCB7CiAgICAgICAgcmVsYXk6IG51bGwsCiAgICAgICAgcmVjb3JkOiB0aGlzLl9hbm5vdW5jZXIucmVjb3JkLAogICAgICAgIG9ucGVlcmhhbmRzaGFrZTogdGhpcy5fb25wZWVyaGFuZHNoYWtlLmJpbmQodGhpcyksCiAgICAgICAgb25wZWVyaG9sZXB1bmNoOiB0aGlzLl9vbnBlZXJob2xlcHVuY2guYmluZCh0aGlzKQogICAgICB9KQoKICAgICAgLy8gd2FybSBpdCB1cCBmb3Igbm93CiAgICAgIHRoaXMuX2xvY2FsQWRkcmVzc2VzKCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCgogICAgICBhd2FpdCB0aGlzLl9hbm5vdW5jZXIuc3RhcnQoKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGF3YWl0IHRoaXMuX3N0b3BMaXN0ZW5pbmcoKQogICAgICB0aGlzLl9nYygpCiAgICAgIHRocm93IGVycgogICAgfQoKICAgIGlmICh0aGlzLl9jbG9zaW5nKSByZXR1cm4KICAgIGlmICh0aGlzLnN1c3BlbmRlZCkgYXdhaXQgdGhpcy5fYW5ub3VuY2VyLnN1c3BlbmQoKQoKICAgIGlmICh0aGlzLl9jbG9zaW5nKSByZXR1cm4KICAgIGlmICh0aGlzLmRodC5kZXN0cm95ZWQpIHRocm93IE5PREVfREVTVFJPWUVEKCkKCiAgICBpZiAodGhpcy5wb29sKSB0aGlzLnBvb2wuX2F0dGFjaFNlcnZlcih0aGlzKQoKICAgIHRoaXMuZW1pdCgnbGlzdGVuaW5nJykKICB9CgogIHJlZnJlc2goKSB7CiAgICBpZiAodGhpcy5fYW5ub3VuY2VyICYmICF0aGlzLnN1c3BlbmRlZCkgdGhpcy5fYW5ub3VuY2VyLnJlZnJlc2goKQogIH0KCiAgbm90aWZ5T25saW5lKCkgewogICAgaWYgKHRoaXMuX2Fubm91bmNlcikgdGhpcy5fYW5ub3VuY2VyLm9ubGluZS5ub3RpZnkoKQogIH0KCiAgX2xvY2FsQWRkcmVzc2VzKCkgewogICAgcmV0dXJuIHRoaXMuZGh0LnZhbGlkYXRlTG9jYWxBZGRyZXNzZXMoSG9sZXB1bmNoZXIubG9jYWxBZGRyZXNzZXModGhpcy5kaHQuaW8uc2VydmVyU29ja2V0KSkKICB9CgogIGFzeW5jIF9hZGRIYW5kc2hha2Uoaywgbm9pc2UsIGNsaWVudEFkZHJlc3MsIHsgZnJvbSwgdG86IHNlcnZlckFkZHJlc3MsIHNvY2tldCB9LCBkaXJlY3QpIHsKICAgIGxldCBpZCA9IHRoaXMuX2hvbGVwdW5jaGVzLmluZGV4T2YobnVsbCkKICAgIGlmIChpZCA9PT0gLTEpIGlkID0gdGhpcy5faG9sZXB1bmNoZXMucHVzaChudWxsKSAtIDEKCiAgICBjb25zdCBocyA9IHsKICAgICAgcm91bmQ6IDAsCiAgICAgIHJlcGx5OiBudWxsLAogICAgICBwdW5jaGVyOiBudWxsLAogICAgICBwYXlsb2FkOiBudWxsLAogICAgICByYXdTdHJlYW06IG51bGwsCiAgICAgIGVuY3J5cHRlZFNvY2tldDogbnVsbCwKICAgICAgcHJlcHVuY2hpbmc6IG51bGwsCiAgICAgIGZpcmV3YWxsZWQ6IHRydWUsCiAgICAgIGNsZWFyaW5nOiBudWxsLAogICAgICBvbnNvY2tldDogbnVsbCwKICAgICAgYWJvcnRlZDogZmFsc2UsCgogICAgICAvLyBSZWxheSBzdGF0ZQogICAgICByZWxheVRpbWVvdXQ6IG51bGwsCiAgICAgIHJlbGF5VG9rZW46IG51bGwsCiAgICAgIHJlbGF5U29ja2V0OiBudWxsLAogICAgICByZWxheUNsaWVudDogbnVsbCwKICAgICAgcmVsYXlQYWlyZWQ6IGZhbHNlCiAgICB9CgogICAgdGhpcy5faG9sZXB1bmNoZXNbaWRdID0gaHMKCiAgICBjb25zdCBoYW5kc2hha2UgPSB0aGlzLmNyZWF0ZUhhbmRzaGFrZSh0aGlzLl9rZXlQYWlyLCBudWxsKQoKICAgIGxldCByZW1vdGVQYXlsb2FkCiAgICB0cnkgewogICAgICByZW1vdGVQYXlsb2FkID0gYXdhaXQgaGFuZHNoYWtlLnJlY3Yobm9pc2UpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgICB0aGlzLl9jbGVhckxhdGVyKGhzLCBpZCwgaykKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBpZiAodGhpcy5fY2xvc2luZyB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuIG51bGwKCiAgICB0cnkgewogICAgICBocy5maXJld2FsbGVkID0gYXdhaXQgdGhpcy5maXJld2FsbChoYW5kc2hha2UucmVtb3RlUHVibGljS2V5LCByZW1vdGVQYXlsb2FkLCBjbGllbnRBZGRyZXNzKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgIH0KCiAgICBpZiAodGhpcy5fY2xvc2luZyB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuIG51bGwKCiAgICBpZiAoaHMuZmlyZXdhbGxlZCkgewogICAgICB0aGlzLl9jbGVhckxhdGVyKGhzLCBpZCwgaykKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBjb25zdCBlcnJvciA9CiAgICAgIHJlbW90ZVBheWxvYWQudmVyc2lvbiA9PT0gMQogICAgICAgID8gcmVtb3RlUGF5bG9hZC51ZHgKICAgICAgICAgID8gRVJST1IuTk9ORQogICAgICAgICAgOiBFUlJPUi5BQk9SVEVECiAgICAgICAgOiBFUlJPUi5WRVJTSU9OX01JU01BVENICgogICAgY29uc3QgYWRkcmVzc2VzID0gW10KICAgIGNvbnN0IG91clJlbW90ZUFkZHIgPSB0aGlzLmRodC5yZW1vdGVBZGRyZXNzKCkKICAgIGNvbnN0IG91ckxvY2FsQWRkcnMgPSB0aGlzLl9zaGFyZUxvY2FsQWRkcmVzcyA/IGF3YWl0IHRoaXMuX2xvY2FsQWRkcmVzc2VzKCkgOiBudWxsCgogICAgaWYgKHRoaXMuX2Nsb3NpbmcgfHwgdGhpcy5zdXNwZW5kZWQpIHJldHVybiBudWxsCgogICAgaWYgKG91clJlbW90ZUFkZHIpIGFkZHJlc3Nlcy5wdXNoKG91clJlbW90ZUFkZHIpCiAgICBpZiAob3VyTG9jYWxBZGRycykgYWRkcmVzc2VzLnB1c2goLi4ub3VyTG9jYWxBZGRycykKCiAgICBpZiAoZXJyb3IgPT09IEVSUk9SLk5PTkUpIHsKICAgICAgaHMucmF3U3RyZWFtID0gdGhpcy5kaHQuY3JlYXRlUmF3U3RyZWFtKHsKICAgICAgICBmcmFtZWQ6IHRydWUsCiAgICAgICAgZmlyZXdhbGwoc29ja2V0LCBwb3J0LCBob3N0KSB7CiAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgdHJhZmZpYyBvcmlnaW5hdGVkIGZyb20gdGhlIHNvY2tldCBvbiB3aGljaCB3ZSdyZSBleHBlY3RpbmcgcmVsYXkgdHJhZmZpYy4gSWYgc28sCiAgICAgICAgICAvLyB3ZSBoYXZlbid0IGhvbGUgcHVuY2hlZCB5ZXQgYW5kIHRoZSBvdGhlciBzaWRlIGlzIGp1c3Qgc2VuZGluZyB1cyB0cmFmZmljIHRocm91Z2ggdGhlIHJlbGF5LgogICAgICAgICAgaWYgKGhzLnJlbGF5U29ja2V0ICYmIGlzUmVsYXkoaHMucmVsYXlTb2NrZXQsIHNvY2tldCwgcG9ydCwgaG9zdCkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgICB9CgogICAgICAgICAgaHMub25zb2NrZXQoc29ja2V0LCBwb3J0LCBob3N0KQogICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQogICAgICB9KQoKICAgICAgaHMucmF3U3RyZWFtLm9uKCdlcnJvcicsIGF1dG9EZXN0cm95KQoKICAgICAgLy8gSGFuZGxlcyB0aGUgY2FzZSB3aGVyZSBvbnNvY2tldCBpcyBuZXZlciBjYWxsZWQsIGJ1dCB0aGUgc3RyZWFtIGdvdCBzZXR1cAogICAgICAvLyBUaGlzIGNhbiBoYXBwZW4gb24gYSByZWxheWVkIGNvbm5lY3Rpb24gd2hpY2ggbmV2ZXIgY29ubmVjdHMgZGlyZWN0bHkKICAgICAgLy8gKG9uc29ja2V0IGlzIGNhbGxlZCB0aGVyZSBvbmx5IHdoZW4gdGhlIGRpcmVjdCBjb25uZWN0aW9uIGlzIGVzdGFibGlzaGVkKQogICAgICBjb25zdCBvbnJhd3N0cmVhbWNsb3NlID0gKCkgPT4gewogICAgICAgIGlmICh0aGlzLl9jbG9zaW5nKSByZXR1cm4KICAgICAgICB0aGlzLl9jbGVhckxhdGVyKGhzLCBpZCwgaykKICAgICAgfQogICAgICBocy5yYXdTdHJlYW0ub24oJ2Nsb3NlJywgb25yYXdzdHJlYW1jbG9zZSkKCiAgICAgIGhzLm9uc29ja2V0ID0gKHNvY2tldCwgcG9ydCwgaG9zdCkgPT4gewogICAgICAgIGlmIChocy5yYXdTdHJlYW0gPT09IG51bGwpIHJldHVybiAvLyBBbHJlYWR5IGhvbGUgcHVuY2hlZAoKICAgICAgICB0aGlzLl9jbGVhckxhdGVyKGhzLCBpZCwgaykKCiAgICAgICAgaWYgKGhzLnByZXB1bmNoaW5nKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQoaHMucHJlcHVuY2hpbmcpCiAgICAgICAgICBocy5wcmVwdW5jaGluZyA9IG51bGwKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9yZXVzYWJsZVNvY2tldCAmJiByZW1vdGVQYXlsb2FkLnVkeC5yZXVzYWJsZVNvY2tldCkgewogICAgICAgICAgdGhpcy5kaHQuX3NvY2tldFBvb2wucm91dGVzLmFkZChoYW5kc2hha2UucmVtb3RlUHVibGljS2V5LCBocy5yYXdTdHJlYW0pCiAgICAgICAgfQoKICAgICAgICBocy5yYXdTdHJlYW0ucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgYXV0b0Rlc3Ryb3kpCiAgICAgICAgaHMucmF3U3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIG9ucmF3c3RyZWFtY2xvc2UpCgogICAgICAgIGlmIChocy5yYXdTdHJlYW0uY29ubmVjdGVkKSB7CiAgICAgICAgICBjb25zdCByZW1vdGVDaGFuZ2luZyA9IGhzLnJhd1N0cmVhbS5jaGFuZ2VSZW1vdGUoc29ja2V0LCByZW1vdGVQYXlsb2FkLnVkeC5pZCwgcG9ydCwgaG9zdCkKCiAgICAgICAgICBpZiAocmVtb3RlQ2hhbmdpbmcpIHJlbW90ZUNoYW5naW5nLmNhdGNoKHNhZmV0eUNhdGNoKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBocy5yYXdTdHJlYW0uY29ubmVjdChzb2NrZXQsIHJlbW90ZVBheWxvYWQudWR4LmlkLCBwb3J0LCBob3N0KQogICAgICAgICAgaHMuZW5jcnlwdGVkU29ja2V0ID0gdGhpcy5jcmVhdGVTZWNyZXRTdHJlYW0oZmFsc2UsIGhzLnJhd1N0cmVhbSwgewogICAgICAgICAgICBoYW5kc2hha2U6IGgsCiAgICAgICAgICAgIGtlZXBBbGl2ZTogdGhpcy5kaHQuY29ubmVjdGlvbktlZXBBbGl2ZQogICAgICAgICAgfSkKCiAgICAgICAgICB0aGlzLm9uY29ubmVjdGlvbihocy5lbmNyeXB0ZWRTb2NrZXQpCiAgICAgICAgfQoKICAgICAgICBpZiAoaHMucHVuY2hlcikgewogICAgICAgICAgaHMucHVuY2hlci5vbmFib3J0ID0gbm9vcAogICAgICAgICAgaHMucHVuY2hlci5kZXN0cm95KCkKICAgICAgICB9CgogICAgICAgIGhzLnJhd1N0cmVhbSA9IG51bGwKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYXV0b0Rlc3Ryb3koKSB7CiAgICAgICAgaWYgKGhzLnB1bmNoZXIpIGhzLnB1bmNoZXIuZGVzdHJveSgpCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCByZWxheUFkZHJlc3NlcyA9IHRoaXMucmVsYXlBZGRyZXNzZXMKICAgIGNvbnN0IHJlbGF5VGhyb3VnaCA9IHNlbGVjdFJlbGF5KHRoaXMucmVsYXlUaHJvdWdoKQoKICAgIGlmIChyZWxheVRocm91Z2gpIGhzLnJlbGF5VG9rZW4gPSByZWxheS50b2tlbigpCgogICAgdHJ5IHsKICAgICAgaHMucmVwbHkgPSBhd2FpdCBoYW5kc2hha2Uuc2VuZCh7CiAgICAgICAgZXJyb3IsCiAgICAgICAgZmlyZXdhbGw6IG91clJlbW90ZUFkZHIgPyBGSVJFV0FMTC5PUEVOIDogRklSRVdBTEwuVU5LTk9XTiwKICAgICAgICBob2xlcHVuY2g6IG91clJlbW90ZUFkZHIgPyBudWxsIDogeyBpZCwgcmVsYXlzOiB0aGlzLl9hbm5vdW5jZXIucmVsYXlzIH0sCiAgICAgICAgYWRkcmVzc2VzNDogYWRkcmVzc2VzLAogICAgICAgIGFkZHJlc3NlczY6IG51bGwsCiAgICAgICAgdWR4OiB7CiAgICAgICAgICByZXVzYWJsZVNvY2tldDogdGhpcy5fcmV1c2FibGVTb2NrZXQsCiAgICAgICAgICBpZDogaHMucmF3U3RyZWFtID8gaHMucmF3U3RyZWFtLmlkIDogMCwKICAgICAgICAgIHNlcTogMAogICAgICAgIH0sCiAgICAgICAgc2VjcmV0U3RyZWFtOiB7fSwKICAgICAgICByZWxheVRocm91Z2g6IHJlbGF5VGhyb3VnaCA/IHsgcHVibGljS2V5OiByZWxheVRocm91Z2gsIHRva2VuOiBocy5yZWxheVRva2VuIH0gOiBudWxsLAogICAgICAgIHJlbGF5QWRkcmVzc2VzOiByZWxheUFkZHJlc3Nlcy5sZW5ndGggPyByZWxheUFkZHJlc3NlcyA6IG51bGwKICAgICAgfSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgIGhzLnJhd1N0cmVhbS5kZXN0cm95KCkKICAgICAgdGhpcy5fY2xlYXJMYXRlcihocywgaWQsIGspCiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgaWYgKHRoaXMuX2Nsb3NpbmcgfHwgdGhpcy5zdXNwZW5kZWQpIHsKICAgICAgaHMucmF3U3RyZWFtLmRlc3Ryb3koKQogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGNvbnN0IGggPSBoYW5kc2hha2UuZmluYWwoKQoKICAgIGlmIChlcnJvciAhPT0gRVJST1IuTk9ORSkgewogICAgICBocy5yYXdTdHJlYW0uZGVzdHJveSgpCiAgICAgIHRoaXMuX2NsZWFyTGF0ZXIoaHMsIGlkLCBrKQogICAgICByZXR1cm4gaHMKICAgIH0KCiAgICBpZiAocmVtb3RlUGF5bG9hZC5maXJld2FsbCA9PT0gRklSRVdBTEwuT1BFTiB8fCBkaXJlY3QpIHsKICAgICAgY29uc3Qgc29jayA9IGRpcmVjdCA/IHNvY2tldCA6IHRoaXMuZGh0LnNvY2tldAogICAgICB0aGlzLmRodC5zdGF0cy5wdW5jaGVzLm9wZW4rKwogICAgICBocy5vbnNvY2tldChzb2NrLCBjbGllbnRBZGRyZXNzLnBvcnQsIGNsaWVudEFkZHJlc3MuaG9zdCkKICAgICAgcmV0dXJuIGhzCiAgICB9CgogICAgaWYgKHJlbGF5VGhyb3VnaCB8fCByZW1vdGVQYXlsb2FkLnJlbGF5VGhyb3VnaCkgewogICAgICB0aGlzLl9yZWxheUNvbm5lY3Rpb24oaHMsIHJlbGF5VGhyb3VnaCwgcmVtb3RlUGF5bG9hZCwgaCkKICAgIH0KCiAgICBjb25zdCBvbmFib3J0ID0gKCkgPT4gewogICAgICBocy5hYm9ydGVkID0gdHJ1ZQogICAgICBpZiAoaHMucHJlcHVuY2hpbmcpIGNsZWFyVGltZW91dChocy5wcmVwdW5jaGluZykKICAgICAgaHMucHJlcHVuY2hpbmcgPSBudWxsCiAgICAgIGlmIChocy5yYXdTdHJlYW0uZGVzdHJveWVkKSB7CiAgICAgICAgdGhpcy5fY2xlYXJMYXRlcihocywgaWQsIGspCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIGhzLnJhd1N0cmVhbS5vbignY2xvc2UnLCAoKSA9PiB0aGlzLl9jbGVhckxhdGVyKGhzLCBpZCwgaykpCiAgICAgIGlmIChocy5yZWxheVRva2VuID09PSBudWxsKSBocy5yYXdTdHJlYW0uZGVzdHJveSgpCiAgICB9CgogICAgaWYgKCFkaXJlY3QgJiYgY2xpZW50QWRkcmVzcy5ob3N0ID09PSBzZXJ2ZXJBZGRyZXNzLmhvc3QpIHsKICAgICAgY29uc3QgY2xpZW50QWRkcmVzc2VzID0gcmVtb3RlUGF5bG9hZC5hZGRyZXNzZXM0LmZpbHRlcihvbmx5UHJpdmF0ZUhvc3RzKQoKICAgICAgaWYgKGNsaWVudEFkZHJlc3Nlcy5sZW5ndGggPiAwICYmIHRoaXMuX3NoYXJlTG9jYWxBZGRyZXNzKSB7CiAgICAgICAgY29uc3QgbXlBZGRyZXNzZXMgPSBhd2FpdCB0aGlzLl9sb2NhbEFkZHJlc3NlcygpCiAgICAgICAgY29uc3QgYWRkciA9IEhvbGVwdW5jaGVyLm1hdGNoQWRkcmVzcyhteUFkZHJlc3NlcywgY2xpZW50QWRkcmVzc2VzKQoKICAgICAgICBpZiAoYWRkcikgewogICAgICAgICAgaHMucHJlcHVuY2hpbmcgPSBzZXRUaW1lb3V0KG9uYWJvcnQsIEhBTkRTSEFLRV9JTklUSUFMX1RJTUVPVVQpCiAgICAgICAgICByZXR1cm4gaHMKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5fY2xvc2luZyB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuIG51bGwKCiAgICBpZiAob3VyUmVtb3RlQWRkciB8fCB0aGlzLl9uZXZlclB1bmNoKSB7CiAgICAgIGhzLnByZXB1bmNoaW5nID0gc2V0VGltZW91dChvbmFib3J0LCBIQU5EU0hBS0VfSU5JVElBTF9USU1FT1VUKQogICAgICByZXR1cm4gaHMKICAgIH0KCiAgICBocy5wYXlsb2FkID0gbmV3IFNlY3VyZVBheWxvYWQoaC5ob2xlcHVuY2hTZWNyZXQpCiAgICBocy5wdW5jaGVyID0gbmV3IEhvbGVwdW5jaGVyKHRoaXMuZGh0LCB0aGlzLmRodC5zZXNzaW9uKCksIGZhbHNlLCByZW1vdGVQYXlsb2FkLmZpcmV3YWxsKQoKICAgIGhzLnB1bmNoZXIub25jb25uZWN0ID0gaHMub25zb2NrZXQKICAgIGhzLnB1bmNoZXIub25hYm9ydCA9IG9uYWJvcnQKICAgIGhzLnByZXB1bmNoaW5nID0gc2V0VGltZW91dChocy5wdW5jaGVyLmRlc3Ryb3kuYmluZChocy5wdW5jaGVyKSwgSEFORFNIQUtFX0lOSVRJQUxfVElNRU9VVCkKCiAgICByZXR1cm4gaHMKICB9CgogIF9jbGVhckxhdGVyKGhzLCBpZCwgaykgewogICAgaWYgKGhzLmNsZWFyaW5nKSByZXR1cm4KICAgIGhzLmNsZWFyaW5nID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLl9jbGVhcihocywgaWQsIGspLCB0aGlzLmhhbmRzaGFrZUNsZWFyV2FpdCkKICB9CgogIF9jbGVhcihocywgaWQsIGspIHsKICAgIGlmIChpZCA+PSB0aGlzLl9ob2xlcHVuY2hlcy5sZW5ndGggfHwgdGhpcy5faG9sZXB1bmNoZXNbaWRdICE9PSBocykgcmV0dXJuCiAgICBpZiAoaHMuY2xlYXJpbmcpIGNsZWFyVGltZW91dChocy5jbGVhcmluZykKCiAgICB0aGlzLl9ob2xlcHVuY2hlc1tpZF0gPSBudWxsCiAgICB3aGlsZSAoCiAgICAgIHRoaXMuX2hvbGVwdW5jaGVzLmxlbmd0aCA+IDAgJiYKICAgICAgdGhpcy5faG9sZXB1bmNoZXNbdGhpcy5faG9sZXB1bmNoZXMubGVuZ3RoIC0gMV0gPT09IG51bGwKICAgICkgewogICAgICB0aGlzLl9ob2xlcHVuY2hlcy5wb3AoKQogICAgfQogICAgdGhpcy5fY29ubmVjdHMuZGVsZXRlKGspCiAgfQoKICBhc3luYyBfb25wZWVyaGFuZHNoYWtlKHsgbm9pc2UsIHBlZXJBZGRyZXNzIH0sIHJlcSkgewogICAgY29uc3QgayA9IGI0YS50b1N0cmluZyhub2lzZSwgJ2hleCcpCgogICAgLy8gVGhlIG5leHQgY291cGxlIG9mIHN0YXRlbWVudHMgTVVTVCBydW4gd2l0aGluIHRoZSBzYW1lIHRpY2sgdG8gcHJldmVudAogICAgLy8gYSBtYWxpY2lvdXMgcGVlciBmcm9tIGZsb29kaW5nIHVzIHdpdGggaGFuZHNoYWtlcy4KICAgIGxldCBwID0gdGhpcy5fY29ubmVjdHMuZ2V0KGspCiAgICBpZiAoIXApIHsKICAgICAgcCA9IHRoaXMuX2FkZEhhbmRzaGFrZShrLCBub2lzZSwgcGVlckFkZHJlc3MgfHwgcmVxLmZyb20sIHJlcSwgIXBlZXJBZGRyZXNzKQogICAgICB0aGlzLl9jb25uZWN0cy5zZXQoaywgcCkKICAgIH0KCiAgICBjb25zdCBoID0gYXdhaXQgcAogICAgaWYgKCFoKSByZXR1cm4gbnVsbAoKICAgIGlmICh0aGlzLl9jbG9zaW5nICE9PSBudWxsIHx8IHRoaXMuc3VzcGVuZGVkKSByZXR1cm4gbnVsbAoKICAgIHJldHVybiB7IHNvY2tldDogaC5wdW5jaGVyICYmIGgucHVuY2hlci5zb2NrZXQsIG5vaXNlOiBoLnJlcGx5IH0KICB9CgogIGFzeW5jIF9vbnBlZXJob2xlcHVuY2goeyBpZCwgcGVlckFkZHJlc3MsIHBheWxvYWQgfSwgcmVxKSB7CiAgICBjb25zdCBoID0gaWQgPCB0aGlzLl9ob2xlcHVuY2hlcy5sZW5ndGggPyB0aGlzLl9ob2xlcHVuY2hlc1tpZF0gOiBudWxsCiAgICBpZiAoIWgpIHJldHVybiBudWxsCgogICAgaWYgKCFwZWVyQWRkcmVzcyB8fCB0aGlzLl9jbG9zaW5nICE9PSBudWxsIHx8IHRoaXMuc3VzcGVuZGVkKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHAgPSBoLnB1bmNoZXIKICAgIGlmICghcCB8fCAhcC5zb2NrZXQpIHJldHVybiB0aGlzLl9hYm9ydChoKSAvLyBub3Qgb3BlbmVkCgogICAgY29uc3QgcmVtb3RlUGF5bG9hZCA9IGgucGF5bG9hZC5kZWNyeXB0KHBheWxvYWQpCiAgICBpZiAoIXJlbW90ZVBheWxvYWQpIHJldHVybiBudWxsCgogICAgY29uc3QgaXNTZXJ2ZXJSZWxheSA9IHRoaXMuX2Fubm91bmNlci5pc1JlbGF5KHJlcS5mcm9tKQogICAgY29uc3QgeyBlcnJvciwgZmlyZXdhbGwsIHJvdW5kLCBwdW5jaGluZywgYWRkcmVzc2VzLCByZW1vdGVBZGRyZXNzLCByZW1vdGVUb2tlbiB9ID0KICAgICAgcmVtb3RlUGF5bG9hZAoKICAgIGlmIChlcnJvciAhPT0gRVJST1IuTk9ORSkgewogICAgICAvLyBXZSBhY3R1YWxseSBkbyBub3QgbmVlZCB0byBzZXQgdGhlIHJvdW5kIGhlcmUsIGJ1dCBqdXN0IGRvIGl0IGZvciBjb25zaXN0ZW5jeS4KICAgICAgaWYgKHJvdW5kID49IGgucm91bmQpIGgucm91bmQgPSByb3VuZAogICAgICByZXR1cm4gdGhpcy5fYWJvcnQoaCkKICAgIH0KCiAgICBjb25zdCB0b2tlbiA9IGgucGF5bG9hZC50b2tlbihwZWVyQWRkcmVzcykKICAgIGNvbnN0IGVjaG9lZCA9IGlzU2VydmVyUmVsYXkgJiYgISFyZW1vdGVUb2tlbiAmJiBiNGEuZXF1YWxzKHRva2VuLCByZW1vdGVUb2tlbikKCiAgICAvLyBVcGRhdGUgb3VyIGhldXJpc3RpY3MgaGVyZQogICAgaWYgKHJlcS5zb2NrZXQgPT09IHAuc29ja2V0KSB7CiAgICAgIHAubmF0LmFkZChyZXEudG8sIHJlcS5mcm9tKQogICAgfQoKICAgIGlmIChyb3VuZCA+PSBoLnJvdW5kKSB7CiAgICAgIGgucm91bmQgPSByb3VuZAogICAgICBwLnVwZGF0ZVJlbW90ZSh7IHB1bmNoaW5nLCBmaXJld2FsbCwgYWRkcmVzc2VzLCB2ZXJpZmllZDogZWNob2VkID8gcGVlckFkZHJlc3MuaG9zdCA6IG51bGwgfSkKICAgIH0KCiAgICAvLyBXYWl0IGZvciB0aGUgYW5hbHl6ZXIgdG8gcmVhY2ggYSBjb25jbHVzaW9uLi4uCiAgICBsZXQgc3RhYmxlID0gYXdhaXQgcC5hbmFseXplKGZhbHNlKQogICAgaWYgKHAuZGVzdHJveWVkKSByZXR1cm4gbnVsbAoKICAgIGlmICghcC5yZW1vdGVIb2xlcHVuY2hpbmcgJiYgIXN0YWJsZSkgewogICAgICBzdGFibGUgPSBhd2FpdCBwLmFuYWx5emUodHJ1ZSkKICAgICAgaWYgKHAuZGVzdHJveWVkKSByZXR1cm4gbnVsbAogICAgICBpZiAoIXN0YWJsZSkgcmV0dXJuIHRoaXMuX2Fib3J0KGgpCiAgICB9CgogICAgLy8gRmFzdCBtb2RlISBJZiB3ZSBhcmUgY29uc2lzdGVudCBhbmQgdGhlIHJlbW90ZSBoYXMgb3BlbmVkIGEgc2Vzc2lvbiB0byB1cyAocmVtb3RlQWRkcmVzcykKICAgIC8vIHRoZW4gZmlyZSBhIHF1aWNrIHB1bmNoIGJhY2suIE5vdGUgdGhlIGF3YWl0IGhlcmUganVzdCB3YWl0cyBmb3IgdGhlIHVkcCBzb2NrZXQgdG8gZmx1c2guCiAgICBpZiAoCiAgICAgIGlzQ29uc2lzdGVudChwLm5hdC5maXJld2FsbCkgJiYKICAgICAgcmVtb3RlQWRkcmVzcyAmJgogICAgICBoYXNTYW1lQWRkcihwLm5hdC5hZGRyZXNzZXMsIHJlbW90ZUFkZHJlc3MpCiAgICApIHsKICAgICAgYXdhaXQgcC5waW5nKHBlZXJBZGRyZXNzKQogICAgICBpZiAocC5kZXN0cm95ZWQpIHJldHVybiBudWxsCiAgICB9CgogICAgLy8gUmVtb3RlIHNhaWQgdGhleSBhcmUgcHVuY2hpbmcgKG9yIHdpbGxpbmcgdG8pLCBzbyB3ZSB3aWxsIHB1bmNoIGFzIHdlbGwuCiAgICAvLyBOb3RlIHRoYXQgdGhpcyByZXR1cm5zIHdoZW4gdGhlIHB1bmNoaW5nIGhhcyBTVEFSVEVELCBzbyBubyBndWFyYW50ZWUKICAgIC8vIHdlIHdpbGwgaGF2ZSBhIGNvbm5lY3Rpb24gYWZ0ZXIgdGhpcyBwcm9taXNlIGV0Yy4KICAgIGlmIChwLnJlbW90ZUhvbGVwdW5jaGluZykgewogICAgICAvLyBUT0RPOiBzdGlsbCBjb250aW51ZSBoZXJlIGlmIGEgbG9jYWwgY29ubmVjdGlvbiBtaWdodCB3b3JrLCBidXQgdGhlbiBkbyBub3QgaG9sZXB1bmNoLi4uCiAgICAgIGlmICghdGhpcy5ob2xlcHVuY2gocC5yZW1vdGVGaXJld2FsbCwgcC5uYXQuZmlyZXdhbGwsIHAucmVtb3RlQWRkcmVzc2VzLCBwLm5hdC5hZGRyZXNzZXMpKSB7CiAgICAgICAgcmV0dXJuIHAuZGVzdHJveWVkID8gbnVsbCA6IHRoaXMuX2Fib3J0KGgpCiAgICAgIH0KCiAgICAgIGlmIChoLnByZXB1bmNoaW5nKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KGgucHJlcHVuY2hpbmcpCiAgICAgICAgaC5wcmVwdW5jaGluZyA9IG51bGwKICAgICAgfQoKICAgICAgaWYgKHAucmVtb3RlRmlyZXdhbGwgPj0gRklSRVdBTEwuUkFORE9NIHx8IHAubmF0LmZpcmV3YWxsID49IEZJUkVXQUxMLlJBTkRPTSkgewogICAgICAgIGlmICgKICAgICAgICAgIHRoaXMuZGh0Ll9yYW5kb21QdW5jaGVzID49IHRoaXMuZGh0Ll9yYW5kb21QdW5jaExpbWl0IHx8CiAgICAgICAgICBEYXRlLm5vdygpIC0gdGhpcy5kaHQuX2xhc3RSYW5kb21QdW5jaCA8IHRoaXMuZGh0Ll9yYW5kb21QdW5jaEludGVydmFsCiAgICAgICAgKSB7CiAgICAgICAgICBpZiAoIWgucmVsYXlUb2tlbikgcmV0dXJuIHRoaXMuX2Fib3J0KGgsIEVSUk9SLlRSWV9MQVRFUikKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHNvY2tldDogcC5zb2NrZXQsCiAgICAgICAgICAgIHBheWxvYWQ6IGgucGF5bG9hZC5lbmNyeXB0KHsKICAgICAgICAgICAgICBlcnJvcjogRVJST1IuVFJZX0xBVEVSLAogICAgICAgICAgICAgIGZpcmV3YWxsOiBwLm5hdC5maXJld2FsbCwKICAgICAgICAgICAgICByb3VuZDogaC5yb3VuZCwKICAgICAgICAgICAgICBjb25uZWN0ZWQ6IHAuY29ubmVjdGVkLAogICAgICAgICAgICAgIHB1bmNoaW5nOiBwLnB1bmNoaW5nLAogICAgICAgICAgICAgIGFkZHJlc3NlczogcC5uYXQuYWRkcmVzc2VzLAogICAgICAgICAgICAgIHJlbW90ZUFkZHJlc3M6IG51bGwsCiAgICAgICAgICAgICAgdG9rZW46IGlzU2VydmVyUmVsYXkgPyB0b2tlbiA6IG51bGwsCiAgICAgICAgICAgICAgcmVtb3RlVG9rZW46IHJlbW90ZVBheWxvYWQudG9rZW4KICAgICAgICAgICAgfSkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IHB1bmNoaW5nID0gYXdhaXQgcC5wdW5jaCgpCiAgICAgIGlmIChwLmRlc3Ryb3llZCkgcmV0dXJuIG51bGwKICAgICAgaWYgKCFwdW5jaGluZykgcmV0dXJuIHRoaXMuX2Fib3J0KGgpCiAgICB9CgogICAgLy8gRnJlZXplIHRoYXQgYW5hbHlzaXMgYXMgc29vbiBhcyB3ZSBoYXZlIGEgcmVzdWx0IHdlIGFyZSBnaXZpbmcgdG8gdGhlIG90aGVyIHBlZXIKICAgIGlmIChwLm5hdC5maXJld2FsbCAhPT0gRklSRVdBTEwuVU5LTk9XTikgewogICAgICBwLm5hdC5mcmVlemUoKQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIHNvY2tldDogcC5zb2NrZXQsCiAgICAgIHBheWxvYWQ6IGgucGF5bG9hZC5lbmNyeXB0KHsKICAgICAgICBlcnJvcjogRVJST1IuTk9ORSwKICAgICAgICBmaXJld2FsbDogcC5uYXQuZmlyZXdhbGwsCiAgICAgICAgcm91bmQ6IGgucm91bmQsCiAgICAgICAgY29ubmVjdGVkOiBwLmNvbm5lY3RlZCwKICAgICAgICBwdW5jaGluZzogcC5wdW5jaGluZywKICAgICAgICBhZGRyZXNzZXM6IHAubmF0LmFkZHJlc3NlcywKICAgICAgICByZW1vdGVBZGRyZXNzOiBudWxsLAogICAgICAgIHRva2VuOiBpc1NlcnZlclJlbGF5ID8gdG9rZW4gOiBudWxsLAogICAgICAgIHJlbW90ZVRva2VuOiByZW1vdGVQYXlsb2FkLnRva2VuCiAgICAgIH0pCiAgICB9CiAgfQoKICBfYWJvcnQoaCwgZXJyb3IgPSBFUlJPUi5BQk9SVEVEKSB7CiAgICBpZiAoIWgucGF5bG9hZCkgewogICAgICBpZiAoaC5wdW5jaGVyKSBoLnB1bmNoZXIuZGVzdHJveSgpCiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgY29uc3QgcGF5bG9hZCA9IGgucGF5bG9hZC5lbmNyeXB0KHsKICAgICAgZXJyb3IsCiAgICAgIGZpcmV3YWxsOiBGSVJFV0FMTC5VTktOT1dOLAogICAgICByb3VuZDogaC5yb3VuZCwKICAgICAgY29ubmVjdGVkOiBmYWxzZSwKICAgICAgcHVuY2hpbmc6IGZhbHNlLAogICAgICBhZGRyZXNzZXM6IG51bGwsCiAgICAgIHJlbW90ZUFkZHJlc3M6IG51bGwsCiAgICAgIHRva2VuOiBudWxsLAogICAgICByZW1vdGVUb2tlbjogbnVsbAogICAgfSkKCiAgICBoLnB1bmNoZXIuZGVzdHJveSgpCgogICAgcmV0dXJuIHsgc29ja2V0OiB0aGlzLmRodC5zb2NrZXQsIHBheWxvYWQgfQogIH0KCiAgX3JlbGF5Q29ubmVjdGlvbihocywgcmVsYXlUaHJvdWdoLCByZW1vdGVQYXlsb2FkLCBoKSB7CiAgICB0aGlzLmRodC5zdGF0cy5yZWxheWluZy5hdHRlbXB0cysrCgogICAgbGV0IGlzSW5pdGlhdG9yCiAgICBsZXQgcHVibGljS2V5CiAgICBsZXQgdG9rZW4KCiAgICBpZiAocmVsYXlUaHJvdWdoKSB7CiAgICAgIGlzSW5pdGlhdG9yID0gdHJ1ZQogICAgICBwdWJsaWNLZXkgPSByZWxheVRocm91Z2gKICAgICAgdG9rZW4gPSBocy5yZWxheVRva2VuCiAgICB9IGVsc2UgewogICAgICBpc0luaXRpYXRvciA9IGZhbHNlCiAgICAgIHB1YmxpY0tleSA9IHJlbW90ZVBheWxvYWQucmVsYXlUaHJvdWdoLnB1YmxpY0tleQogICAgICB0b2tlbiA9IHJlbW90ZVBheWxvYWQucmVsYXlUaHJvdWdoLnRva2VuCiAgICB9CgogICAgaHMucmVsYXlUb2tlbiA9IHRva2VuCiAgICBocy5yZWxheVNvY2tldCA9IHRoaXMuZGh0LmNvbm5lY3QocHVibGljS2V5KQogICAgaHMucmVsYXlTb2NrZXQuc2V0S2VlcEFsaXZlKHRoaXMucmVsYXlLZWVwQWxpdmUpCiAgICBocy5yZWxheUNsaWVudCA9IHJlbGF5LkNsaWVudC5mcm9tKGhzLnJlbGF5U29ja2V0LCB7IGlkOiBocy5yZWxheVNvY2tldC5wdWJsaWNLZXkgfSkKICAgIGhzLnJlbGF5VGltZW91dCA9IHNldFRpbWVvdXQob25hYm9ydCwgMTUwMDApCgogICAgaHMucmVsYXlDbGllbnQKICAgICAgLnBhaXIoaXNJbml0aWF0b3IsIHRva2VuLCBocy5yYXdTdHJlYW0pCiAgICAgIC5vbignZXJyb3InLCBvbmFib3J0KQogICAgICAub24oJ2RhdGEnLCAocmVtb3RlSWQpID0+IHsKICAgICAgICBpZiAoaHMucmVsYXlUaW1lb3V0KSBjbGVhclJlbGF5VGltZW91dChocykKICAgICAgICBpZiAoaHMucmF3U3RyZWFtID09PSBudWxsKSB7CiAgICAgICAgICBvbmFib3J0KG51bGwpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIGhzLnJlbGF5UGFpcmVkID0gdHJ1ZQogICAgICAgIHRoaXMuZGh0LnN0YXRzLnJlbGF5aW5nLnN1Y2Nlc3NlcysrCgogICAgICAgIGlmIChocy5wcmVwdW5jaGluZykgY2xlYXJUaW1lb3V0KGhzLnByZXB1bmNoaW5nKQogICAgICAgIGhzLnByZXB1bmNoaW5nID0gbnVsbAoKICAgICAgICBjb25zdCB7IHJlbW90ZVBvcnQsIHJlbW90ZUhvc3QsIHNvY2tldCB9ID0gaHMucmVsYXlTb2NrZXQucmF3U3RyZWFtCgogICAgICAgIGhzLnJhd1N0cmVhbQogICAgICAgICAgLm9uKCdjbG9zZScsICgpID0+IGhzLnJlbGF5U29ja2V0LmRlc3Ryb3koKSkKICAgICAgICAgIC5jb25uZWN0KHNvY2tldCwgcmVtb3RlSWQsIHJlbW90ZVBvcnQsIHJlbW90ZUhvc3QpCgogICAgICAgIGhzLmVuY3J5cHRlZFNvY2tldCA9IHRoaXMuY3JlYXRlU2VjcmV0U3RyZWFtKGZhbHNlLCBocy5yYXdTdHJlYW0sIHsgaGFuZHNoYWtlOiBoIH0pCgogICAgICAgIHRoaXMub25jb25uZWN0aW9uKGhzLmVuY3J5cHRlZFNvY2tldCkKICAgICAgfSkKCiAgICBjb25zdCBkaHQgPSB0aGlzLmRodAogICAgZnVuY3Rpb24gb25hYm9ydCgpIHsKICAgICAgaWYgKCFocy5yZWxheVBhaXJlZCkgZGh0LnN0YXRzLnJlbGF5aW5nLmFib3J0cysrCiAgICAgIGlmIChocy5yZWxheVRpbWVvdXQpIGNsZWFyUmVsYXlUaW1lb3V0KGhzKQogICAgICBjb25zdCBzb2NrZXQgPSBocy5yZWxheVNvY2tldAogICAgICBocy5yZWxheVRva2VuID0gbnVsbAogICAgICBocy5yZWxheVNvY2tldCA9IG51bGwKICAgICAgaWYgKHNvY2tldCkgc29ja2V0LmRlc3Ryb3koKQogICAgICBpZiAoaHMuYWJvcnRlZCAmJiBocy5yYXdTdHJlYW0pIGhzLnJhd1N0cmVhbS5kZXN0cm95KCkKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGNsZWFyUmVsYXlUaW1lb3V0KGhzKSB7CiAgY2xlYXJUaW1lb3V0KGhzLnJlbGF5VGltZW91dCkKICBocy5yZWxheVRpbWVvdXQgPSBudWxsCn0KCmZ1bmN0aW9uIGlzQ29uc2lzdGVudChmdykgewogIHJldHVybiBmdyA9PT0gRklSRVdBTEwuT1BFTiB8fCBmdyA9PT0gRklSRVdBTEwuQ09OU0lTVEVOVAp9CgpmdW5jdGlvbiBoYXNTYW1lQWRkcihhZGRycywgb3RoZXIpIHsKICBpZiAoYWRkcnMgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICBmb3IgKGNvbnN0IGFkZHIgb2YgYWRkcnMpIHsKICAgIGlmIChhZGRyLnBvcnQgPT09IG90aGVyLnBvcnQgJiYgYWRkci5ob3N0ID09PSBvdGhlci5ob3N0KSByZXR1cm4gdHJ1ZQogIH0KICByZXR1cm4gZmFsc2UKfQoKZnVuY3Rpb24gZGVmYXVsdENyZWF0ZUhhbmRzaGFrZShrZXlQYWlyLCByZW1vdGVQdWJsaWNLZXkpIHsKICByZXR1cm4gbmV3IE5vaXNlV3JhcChrZXlQYWlyLCByZW1vdGVQdWJsaWNLZXkpCn0KCmZ1bmN0aW9uIGRlZmF1bHRDcmVhdGVTZWNyZXRTdHJlYW0oaXNJbml0aWF0b3IsIHJhd1N0cmVhbSwgb3B0cykgewogIHJldHVybiBuZXcgTm9pc2VTZWNyZXRTdHJlYW0oaXNJbml0aWF0b3IsIHJhd1N0cmVhbSwgb3B0cykKfQoKZnVuY3Rpb24gb25seVByaXZhdGVIb3N0cyhhZGRyKSB7CiAgcmV0dXJuIGlzUHJpdmF0ZShhZGRyLmhvc3QpCn0KCmZ1bmN0aW9uIGlzUmVsYXkocmVsYXlTb2NrZXQsIHNvY2tldCwgcG9ydCwgaG9zdCkgewogIGNvbnN0IHN0cmVhbSA9IHJlbGF5U29ja2V0LnJhd1N0cmVhbQogIGlmICghc3RyZWFtKSByZXR1cm4gZmFsc2UKICBpZiAoc3RyZWFtLnNvY2tldCAhPT0gc29ja2V0KSByZXR1cm4gZmFsc2UKICByZXR1cm4gcG9ydCA9PT0gc3RyZWFtLnJlbW90ZVBvcnQgJiYgaG9zdCA9PT0gc3RyZWFtLnJlbW90ZUhvc3QKfQoKZnVuY3Rpb24gc2VsZWN0UmVsYXkocmVsYXlUaHJvdWdoKSB7CiAgaWYgKHR5cGVvZiByZWxheVRocm91Z2ggPT09ICdmdW5jdGlvbicpIHJlbGF5VGhyb3VnaCA9IHJlbGF5VGhyb3VnaCgpCiAgaWYgKHJlbGF5VGhyb3VnaCA9PT0gbnVsbCkgcmV0dXJuIG51bGwKICBpZiAoQXJyYXkuaXNBcnJheShyZWxheVRocm91Z2gpKSB7CiAgICByZXR1cm4gcmVsYXlUaHJvdWdoW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHJlbGF5VGhyb3VnaC5sZW5ndGgpXQogIH0KICByZXR1cm4gcmVsYXlUaHJvdWdoCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFNsZWVwZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5fdGltZW91dCA9IG51bGwKICAgIHRoaXMuX3Jlc29sdmUgPSBudWxsCgogICAgdGhpcy5fc3RhcnQgPSAocmVzb2x2ZSkgPT4gewogICAgICB0aGlzLl9yZXNvbHZlID0gcmVzb2x2ZQogICAgfQoKICAgIHRoaXMuX3RyaWdnZXIgPSAoKSA9PiB7CiAgICAgIGlmICh0aGlzLl9yZXNvbHZlID09PSBudWxsKSByZXR1cm4KICAgICAgY29uc3QgcmVzb2x2ZSA9IHRoaXMuX3Jlc29sdmUKICAgICAgdGhpcy5fdGltZW91dCA9IG51bGwKICAgICAgdGhpcy5fcmVzb2x2ZSA9IG51bGwKICAgICAgcmVzb2x2ZSgpCiAgICB9CiAgfQoKICBwYXVzZShtcykgewogICAgY29uc3QgcCA9IG5ldyBQcm9taXNlKHRoaXMuX3N0YXJ0KQogICAgaWYgKHRoaXMuX3RpbWVvdXQgIT09IG51bGwpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVvdXQpCiAgICAgIHRoaXMuX3RyaWdnZXIoKQogICAgfQogICAgdGhpcy5fdGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5fdHJpZ2dlciwgbXMpCiAgICByZXR1cm4gcAogIH0KCiAgcmVzdW1lKCkgewogICAgaWYgKHRoaXMuX3RpbWVvdXQgIT09IG51bGwpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVvdXQpCiAgICAgIHRoaXMuX3RyaWdnZXIoKQogICAgfQogIH0KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgTElOR0VSX1RJTUUgPSAzMDAwCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFNvY2tldFBvb2wgewogIGNvbnN0cnVjdG9yKGRodCwgaG9zdCkgewogICAgdGhpcy5fZGh0ID0gZGh0CiAgICB0aGlzLl9zb2NrZXRzID0gbmV3IE1hcCgpCiAgICB0aGlzLl9saW5nZXJpbmcgPSBuZXcgU2V0KCkgLy8gdXBkYXRlZCBieSB0aGUgcmVmCiAgICB0aGlzLl9ob3N0ID0gaG9zdAoKICAgIHRoaXMucm91dGVzID0gbmV3IFNvY2tldFJvdXRlcyh0aGlzKQogIH0KCiAgX29ubWVzc2FnZShyZWYsIGRhdGEsIGFkZHJlc3MpIHsKICAgIHRoaXMuX2RodC5vbm1lc3NhZ2UocmVmLnNvY2tldCwgZGF0YSwgYWRkcmVzcykKICB9CgogIF9hZGQocmVmKSB7CiAgICB0aGlzLl9zb2NrZXRzLnNldChyZWYuc29ja2V0LCByZWYpCiAgfQoKICBfcmVtb3ZlKHJlZikgewogICAgdGhpcy5fc29ja2V0cy5kZWxldGUocmVmLnNvY2tldCkKICAgIHRoaXMuX2xpbmdlcmluZy5kZWxldGUocmVmKQogIH0KCiAgbG9va3VwKHNvY2tldCkgewogICAgcmV0dXJuIHRoaXMuX3NvY2tldHMuZ2V0KHNvY2tldCkgfHwgbnVsbAogIH0KCiAgc2V0UmV1c2FibGUoc29ja2V0LCBib29sKSB7CiAgICBjb25zdCByZWYgPSB0aGlzLmxvb2t1cChzb2NrZXQpCiAgICBpZiAocmVmKSByZWYucmV1c2FibGUgPSBib29sCiAgfQoKICBhY3F1aXJlKCkgewogICAgLy8gVE9ETzogRW5hYmxlIHNvY2tldCByZXVzZQogICAgcmV0dXJuIG5ldyBTb2NrZXRSZWYodGhpcykKICB9CgogIGFzeW5jIGRlc3Ryb3koKSB7CiAgICBjb25zdCBjbG9zaW5nID0gW10KCiAgICBmb3IgKGNvbnN0IHJlZiBvZiB0aGlzLl9zb2NrZXRzLnZhbHVlcygpKSB7CiAgICAgIHJlZi5fdW5saW5nZXIoKQogICAgICBjbG9zaW5nLnB1c2gocmVmLnNvY2tldC5jbG9zZSgpKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChjbG9zaW5nKQogIH0KfQoKY2xhc3MgU29ja2V0Um91dGVzIHsKICBjb25zdHJ1Y3Rvcihwb29sKSB7CiAgICB0aGlzLl9wb29sID0gcG9vbAogICAgdGhpcy5fcm91dGVzID0gbmV3IE1hcCgpCiAgfQoKICBhZGQocHVibGljS2V5LCByYXdTdHJlYW0pIHsKICAgIGlmIChyYXdTdHJlYW0uc29ja2V0KSB0aGlzLl9vbmNvbm5lY3QocHVibGljS2V5LCByYXdTdHJlYW0pCiAgICBlbHNlIHJhd1N0cmVhbS5vbignY29ubmVjdCcsIHRoaXMuX29uY29ubmVjdC5iaW5kKHRoaXMsIHB1YmxpY0tleSwgcmF3U3RyZWFtKSkKICB9CgogIGdldChwdWJsaWNLZXkpIHsKICAgIGNvbnN0IGlkID0gYjRhLnRvU3RyaW5nKHB1YmxpY0tleSwgJ2hleCcpCiAgICBjb25zdCByb3V0ZSA9IHRoaXMuX3JvdXRlcy5nZXQoaWQpCiAgICBpZiAoIXJvdXRlKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHJvdXRlCiAgfQoKICBfb25jb25uZWN0KHB1YmxpY0tleSwgcmF3U3RyZWFtKSB7CiAgICBjb25zdCBpZCA9IGI0YS50b1N0cmluZyhwdWJsaWNLZXksICdoZXgnKQogICAgY29uc3Qgc29ja2V0ID0gcmF3U3RyZWFtLnNvY2tldAoKICAgIGxldCByb3V0ZSA9IHRoaXMuX3JvdXRlcy5nZXQoaWQpCgogICAgaWYgKCFyb3V0ZSkgewogICAgICBjb25zdCBnYyA9ICgpID0+IHsKICAgICAgICBpZiAodGhpcy5fcm91dGVzLmdldChpZCkgPT09IHJvdXRlKSB0aGlzLl9yb3V0ZXMuZGVsZXRlKGlkKQogICAgICAgIHNvY2tldC5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBnYykKICAgICAgfQoKICAgICAgcm91dGUgPSB7CiAgICAgICAgc29ja2V0LAogICAgICAgIGFkZHJlc3M6IHsgaG9zdDogcmF3U3RyZWFtLnJlbW90ZUhvc3QsIHBvcnQ6IHJhd1N0cmVhbS5yZW1vdGVQb3J0IH0sCiAgICAgICAgZ2MKICAgICAgfQoKICAgICAgdGhpcy5fcm91dGVzLnNldChpZCwgcm91dGUpCiAgICAgIHNvY2tldC5vbignY2xvc2UnLCBnYykKICAgIH0KCiAgICB0aGlzLl9wb29sLnNldFJldXNhYmxlKHNvY2tldCwgdHJ1ZSkKCiAgICByYXdTdHJlYW0ub24oJ2Vycm9yJywgKCkgPT4gewogICAgICB0aGlzLl9wb29sLnNldFJldXNhYmxlKHNvY2tldCwgZmFsc2UpCiAgICAgIGlmICghcm91dGUpIHJvdXRlID0gdGhpcy5fcm91dGVzLmdldChpZCkKICAgICAgaWYgKHJvdXRlICYmIHJvdXRlLnNvY2tldCA9PT0gc29ja2V0KSByb3V0ZS5nYygpCiAgICB9KQogIH0KfQoKLy8gVE9ETzogd2Ugc2hvdWxkIGp1c3QgbWFrZSBzb21lICJ1c2VyIGRhdGEiIG9iamVjdCBvbiB1ZHggdG8gYWxsb3cgdG8gYXR0YWNoIHRoaXMgaW5mbwpjbGFzcyBTb2NrZXRSZWYgewogIGNvbnN0cnVjdG9yKHBvb2wpIHsKICAgIHRoaXMuX3Bvb2wgPSBwb29sCgogICAgLy8gRXZlbnRzCiAgICB0aGlzLm9uaG9sZXB1bmNobWVzc2FnZSA9IG5vb3AKCiAgICAvLyBXaGV0aGVyIGl0IHNob3VsZCB0ZWFyZG93biBpbW1lZGlhdGVseSBvciB3YWl0IGEgYml0CiAgICB0aGlzLnJldXNhYmxlID0gZmFsc2UKCiAgICB0aGlzLnNvY2tldCA9IHBvb2wuX2RodC51ZHguY3JlYXRlU29ja2V0KCkKICAgIHRoaXMuc29ja2V0CiAgICAgIC5vbignY2xvc2UnLCB0aGlzLl9vbmNsb3NlLmJpbmQodGhpcykpCiAgICAgIC5vbignbWVzc2FnZScsIHRoaXMuX29ubWVzc2FnZS5iaW5kKHRoaXMpKQogICAgICAub24oJ2lkbGUnLCB0aGlzLl9vbmlkbGUuYmluZCh0aGlzKSkKICAgICAgLm9uKCdidXN5JywgdGhpcy5fb25idXN5LmJpbmQodGhpcykpCiAgICAgIC5iaW5kKDAsIHRoaXMuX3Bvb2wuX2hvc3QpCgogICAgdGhpcy5fcmVmcyA9IDEKICAgIHRoaXMuX3JlbGVhc2VkID0gZmFsc2UKICAgIHRoaXMuX2Nsb3NlZCA9IGZhbHNlCgogICAgdGhpcy5fdGltZW91dCA9IG51bGwKICAgIHRoaXMuX3dhc0J1c3kgPSBmYWxzZQoKICAgIHRoaXMuX3Bvb2wuX2FkZCh0aGlzKQogIH0KCiAgX29uY2xvc2UoKSB7CiAgICB0aGlzLl9wb29sLl9yZW1vdmUodGhpcykKICB9CgogIF9vbm1lc3NhZ2UoZGF0YSwgYWRkcmVzcykgewogICAgaWYgKGRhdGEuYnl0ZUxlbmd0aCA+IDEpIHsKICAgICAgdGhpcy5fcG9vbC5fb25tZXNzYWdlKHRoaXMsIGRhdGEsIGFkZHJlc3MpCiAgICB9IGVsc2UgewogICAgICB0aGlzLm9uaG9sZXB1bmNobWVzc2FnZShkYXRhLCBhZGRyZXNzLCB0aGlzKQogICAgfQogIH0KCiAgX29uaWRsZSgpIHsKICAgIHRoaXMuX2Nsb3NlTWF5YmUoKQogIH0KCiAgX29uYnVzeSgpIHsKICAgIHRoaXMuX3dhc0J1c3kgPSB0cnVlCiAgICB0aGlzLl91bmxpbmdlcigpCiAgfQoKICBfcmVzZXQoKSB7CiAgICB0aGlzLm9uaG9sZXB1bmNobWVzc2FnZSA9IG5vb3AKICB9CgogIF9jbG9zZU1heWJlKCkgewogICAgaWYgKHRoaXMuX3JlZnMgPT09IDAgJiYgdGhpcy5zb2NrZXQuaWRsZSAmJiAhdGhpcy5fdGltZW91dCkgdGhpcy5fY2xvc2UoKQogIH0KCiAgX2xpbmdlcmluZ0Nsb3NlKCkgewogICAgdGhpcy5fcG9vbC5fbGluZ2VyaW5nLmRlbGV0ZSh0aGlzKQogICAgdGhpcy5fdGltZW91dCA9IG51bGwKICAgIHRoaXMuX2Nsb3NlTWF5YmUoKQogIH0KCiAgX2Nsb3NlKCkgewogICAgdGhpcy5fdW5saW5nZXIoKQoKICAgIGlmICh0aGlzLnJldXNhYmxlICYmIHRoaXMuX3dhc0J1c3kpIHsKICAgICAgdGhpcy5fd2FzQnVzeSA9IGZhbHNlCiAgICAgIHRoaXMuX3Bvb2wuX2xpbmdlcmluZy5hZGQodGhpcykKICAgICAgdGhpcy5fdGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5fbGluZ2VyaW5nQ2xvc2UuYmluZCh0aGlzKSwgTElOR0VSX1RJTUUpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuX2Nsb3NlZCA9IHRydWUKICAgIHRoaXMuc29ja2V0LmNsb3NlKCkKICB9CgogIF91bmxpbmdlcigpIHsKICAgIGlmICh0aGlzLl90aW1lb3V0ICE9PSBudWxsKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lb3V0KQogICAgICB0aGlzLl9wb29sLl9saW5nZXJpbmcuZGVsZXRlKHRoaXMpCiAgICAgIHRoaXMuX3RpbWVvdXQgPSBudWxsCiAgICB9CiAgfQoKICBnZXQgZnJlZSgpIHsKICAgIHJldHVybiB0aGlzLl9yZWZzID09PSAwCiAgfQoKICBhY3RpdmUoKSB7CiAgICB0aGlzLl9yZWZzKysKICAgIHRoaXMuX3VubGluZ2VyKCkKICB9CgogIGluYWN0aXZlKCkgewogICAgdGhpcy5fcmVmcy0tCiAgICB0aGlzLl9jbG9zZU1heWJlKCkKICB9CgogIGFkZHJlc3MoKSB7CiAgICByZXR1cm4gdGhpcy5zb2NrZXQuYWRkcmVzcygpCiAgfQoKICByZWxlYXNlKCkgewogICAgaWYgKHRoaXMuX3JlbGVhc2VkKSByZXR1cm4KCiAgICB0aGlzLl9yZWxlYXNlZCA9IHRydWUKICAgIHRoaXMuX3Jlc2V0KCkKCiAgICB0aGlzLl9yZWZzLS0KICAgIHRoaXMuX2Nsb3NlTWF5YmUoKQogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CnsKICAibmFtZSI6ICJoeXBlcmRodCIsCiAgInZlcnNpb24iOiAiNi4yNy4xIiwKICAiZGVzY3JpcHRpb24iOiAiVGhlIERIVCBwb3dlcmluZyBIeXBlcnN3YXJtIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImJyb3dzZXIiOiAiYnJvd3Nlci5qcyIsCiAgImJpbiI6IHsKICAgICJoeXBlcmRodCI6ICIuL2Jpbi5qcyIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiYnJvd3Nlci5qcyIsCiAgICAidGVzdG5ldC5qcyIsCiAgICAiYmluLmpzIiwKICAgICJsaWIvKiouanMiCiAgXSwKICAiaW1wb3J0cyI6IHsKICAgICJldmVudHMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZXZlbnRzIiwKICAgICAgImRlZmF1bHQiOiAiZXZlbnRzIgogICAgfSwKICAgICJjaGlsZF9wcm9jZXNzIjogewogICAgICAiYmFyZSI6ICJiYXJlLW5vZGUtY2hpbGQtcHJvY2VzcyIsCiAgICAgICJkZWZhdWx0IjogImNoaWxkX3Byb2Nlc3MiCiAgICB9CiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiAiXjYuNi4yIiwKICAgICJiNGEiOiAiXjEuMy4xIiwKICAgICJiYXJlLWV2ZW50cyI6ICJeMi4yLjAiLAogICAgImJsaW5kLXJlbGF5IjogIl4xLjMuMCIsCiAgICAiYm9nb24iOiAiXjEuMC4wIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjQuMSIsCiAgICAiY29tcGFjdC1lbmNvZGluZy1uZXQiOiAiXjEuMC4xIiwKICAgICJkaHQtcnBjIjogIl42LjE1LjEiLAogICAgImh5cGVyY29yZS1jcnlwdG8iOiAiXjMuMy4wIiwKICAgICJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiAiXjEuMi4wIiwKICAgICJub2lzZS1jdXJ2ZS1lZCI6ICJeMi4wLjAiLAogICAgIm5vaXNlLWhhbmRzaGFrZSI6ICJeNC4wLjAiLAogICAgInJlY29yZC1jYWNoZSI6ICJeMS4xLjEiLAogICAgInNhZmV0eS1jYXRjaCI6ICJeMS4wLjEiLAogICAgInNpZ25hbC1wcm9taXNlIjogIl4xLjAuMyIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjEiLAogICAgInN0cmVhbXgiOiAiXjIuMTYuMSIsCiAgICAidW5zbGFiIjogIl4xLjMuMCIsCiAgICAieGFjaGUiOiAiXjEuMS4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLW5vZGUtY2hpbGQtcHJvY2VzcyI6ICJeMS4wLjEiLAogICAgImJyaXR0bGUiOiAiXjMuMC4wIiwKICAgICJncmFjZWZ1bC1nb29kYnllIjogIl4xLjMuMCIsCiAgICAibmV3bGluZS1kZWNvZGVyIjogIl4xLjAuMiIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgInRlc3QiOiAicHJldHRpZXIgLS1jaGVjayAuICYmIG5vZGUgdGVzdC9hbGwuanMiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmdlbmVyYXRlIjogImJyaXR0bGUgLXIgdGVzdC9hbGwuanMgdGVzdC8qLmpzIiwKICAgICJpbnRlZ3JhdGlvbiI6ICJicml0dGxlIHRlc3QvaW50ZWdyYXRpb24vKi5qcyIsCiAgICAiZW5kLXRvLWVuZCI6ICJicml0dGxlIHRlc3QvZW5kLXRvLWVuZC8qLmpzIgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJkaXJlY3RvcmllcyI6IHsKICAgICJsaWIiOiAibGliIiwKICAgICJ0ZXN0IjogInRlc3QiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJkaHQuZ2l0IgogIH0sCiAgImtleXdvcmRzIjogW10sCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmRodC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyZGh0I3JlYWRtZSIKfQp7CiAgIm5hbWUiOiAiaHlwZXJzY2hlbWEiLAogICJ2ZXJzaW9uIjogIjEuMTguMCIsCiAgImRlc2NyaXB0aW9uIjogIkNyZWF0ZSByZWdpc3RyaWVzIG9mIGRlY2xhcmF0aXZlIGNvbXBhY3QtZW5jb2Rpbmcgc2NoZW1hcyIsCiAgImZpbGVzIjogWwogICAgImxpYi8qLmpzIiwKICAgICJidWlsZGVyLm1qcyIsCiAgICAiYnVpbGRlci5janMiLAogICAgInJ1bnRpbWUubWpzIiwKICAgICJydW50aW1lLmNqcyIsCiAgICAicHJpbWl0aXZlcy5tanMiLAogICAgInByaW1pdGl2ZXMuY2pzIgogIF0sCiAgImV4cG9ydHMiOiB7CiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuIjogewogICAgICAiaW1wb3J0IjogIi4vYnVpbGRlci5tanMiLAogICAgICAiZGVmYXVsdCI6ICIuL2J1aWxkZXIuY2pzIgogICAgfSwKICAgICIuL3J1bnRpbWUiOiB7CiAgICAgICJpbXBvcnQiOiAiLi9ydW50aW1lLm1qcyIsCiAgICAgICJkZWZhdWx0IjogIi4vcnVudGltZS5janMiCiAgICB9LAogICAgIi4vcHJpbWl0aXZlcyI6IHsKICAgICAgImltcG9ydCI6ICIuL3ByaW1pdGl2ZXMubWpzIiwKICAgICAgImRlZmF1bHQiOiAiLi9wcmltaXRpdmVzLmNqcyIKICAgIH0KICB9LAogICJpbXBvcnRzIjogewogICAgImZzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWZzIiwKICAgICAgImRlZmF1bHQiOiAiZnMiCiAgICB9LAogICAgInBhdGgiOiB7CiAgICAgICJiYXJlIjogImJhcmUtcGF0aCIsCiAgICAgICJkZWZhdWx0IjogInBhdGgiCiAgICB9CiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLiAtLXdyaXRlIiwKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBicml0dGxlIHRlc3QvaW5kZXguanMiLAogICAgInRlc3Q6YmFyZSI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYmFyZSB0ZXN0L2luZGV4LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyc2NoZW1hLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyc2NoZW1hL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJzY2hlbWEjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtZnMiOiAiXjQuMC4xIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjE1LjAiLAogICAgImdlbmVyYXRlLW9iamVjdC1wcm9wZXJ0eSI6ICJeMi4wLjAiLAogICAgImdlbmVyYXRlLXN0cmluZyI6ICJeMS4wLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuNy4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjEuMC4wIiwKICAgICJ0ZXN0LXRtcCI6ICJeMS4zLjAiCiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gewogIGM6IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQp9CmNvbnN0IHsgRXZlbnRFbWl0dGVyIH0gPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCB7IGdldFN0cmVhbUVycm9yIH0gPSByZXF1aXJlKCdzdHJlYW14JykKY29uc3QgREhUID0gcmVxdWlyZSgnaHlwZXJkaHQnKQpjb25zdCBzcHEgPSByZXF1aXJlKCdzaHVmZmxlZC1wcmlvcml0eS1xdWV1ZScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHVuc2xhYiA9IHJlcXVpcmUoJ3Vuc2xhYicpCgpjb25zdCBQZWVySW5mbyA9IHJlcXVpcmUoJy4vbGliL3BlZXItaW5mbycpCmNvbnN0IFJldHJ5VGltZXIgPSByZXF1aXJlKCcuL2xpYi9yZXRyeS10aW1lcicpCmNvbnN0IENvbm5lY3Rpb25TZXQgPSByZXF1aXJlKCcuL2xpYi9jb25uZWN0aW9uLXNldCcpCmNvbnN0IFBlZXJEaXNjb3ZlcnkgPSByZXF1aXJlKCcuL2xpYi9wZWVyLWRpc2NvdmVyeScpCgpjb25zdCBNQVhfUEVFUlMgPSA2NApjb25zdCBNQVhfUEFSQUxMRUwgPSAzCmNvbnN0IE1BWF9DTElFTlRfQ09OTkVDVElPTlMgPSBJbmZpbml0eSAvLyBUT0RPOiBDaGFuZ2UKY29uc3QgTUFYX1NFUlZFUl9DT05ORUNUSU9OUyA9IEluZmluaXR5Cgpjb25zdCBFUlJfTUlTU0lOR19UT1BJQyA9ICdUb3BpYyBpcyByZXF1aXJlZCBhbmQgbXVzdCBiZSBhIDMyLWJ5dGUgYnVmZmVyJwpjb25zdCBFUlJfREVTVFJPWUVEID0gJ1N3YXJtIGhhcyBiZWVuIGRlc3Ryb3llZCcKY29uc3QgRVJSX0RVUExJQ0FURSA9ICdEdXBsaWNhdGUgY29ubmVjdGlvbicKY29uc3QgRVJSX0ZJUkVXQUxMID0gJ1BlZXIgaXMgZmlyZXdhbGxlZCcKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgSHlwZXJzd2FybSBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3Iob3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCiAgICBjb25zdCB7CiAgICAgIHNlZWQsCiAgICAgIHJlbGF5VGhyb3VnaCwKICAgICAga2V5UGFpciA9IERIVC5rZXlQYWlyKHNlZWQpLAogICAgICBtYXhQZWVycyA9IE1BWF9QRUVSUywKICAgICAgbWF4Q2xpZW50Q29ubmVjdGlvbnMgPSBNQVhfQ0xJRU5UX0NPTk5FQ1RJT05TLAogICAgICBtYXhTZXJ2ZXJDb25uZWN0aW9ucyA9IE1BWF9TRVJWRVJfQ09OTkVDVElPTlMsCiAgICAgIG1heFBhcmFsbGVsID0gTUFYX1BBUkFMTEVMLAogICAgICBmaXJld2FsbCA9IGFsbG93QWxsCiAgICB9ID0gb3B0cwogICAgdGhpcy5rZXlQYWlyID0ga2V5UGFpcgoKICAgIHRoaXMuZGh0ID0KICAgICAgb3B0cy5kaHQgfHwKICAgICAgbmV3IERIVCh7CiAgICAgICAgYm9vdHN0cmFwOiBvcHRzLmJvb3RzdHJhcCwKICAgICAgICBub2Rlczogb3B0cy5ub2RlcywKICAgICAgICBwb3J0OiBvcHRzLnBvcnQsCiAgICAgICAgZGVmZXJSYW5kb21QdW5jaDogb3B0cy5kZWZlclJhbmRvbVB1bmNoLAogICAgICAgIHJhbmRvbVB1bmNoSW50ZXJ2YWw6IG9wdHMucmFuZG9tUHVuY2hJbnRlcnZhbAogICAgICB9KQogICAgdGhpcy5zZXJ2ZXIgPSB0aGlzLmRodC5jcmVhdGVTZXJ2ZXIoCiAgICAgIHsKICAgICAgICBmaXJld2FsbDogdGhpcy5faGFuZGxlRmlyZXdhbGwuYmluZCh0aGlzKSwKICAgICAgICByZWxheVRocm91Z2g6IHRoaXMuX21heWJlUmVsYXlDb25uZWN0aW9uLmJpbmQodGhpcyksCiAgICAgICAgaGFuZHNoYWtlQ2xlYXJXYWl0OiBvcHRzLmhhbmRzaGFrZUNsZWFyV2FpdAogICAgICB9LAogICAgICB0aGlzLl9oYW5kbGVTZXJ2ZXJDb25uZWN0aW9uLmJpbmQodGhpcykKICAgICkKCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCiAgICB0aGlzLm1heFBlZXJzID0gbWF4UGVlcnMKICAgIHRoaXMubWF4Q2xpZW50Q29ubmVjdGlvbnMgPSBtYXhDbGllbnRDb25uZWN0aW9ucwogICAgdGhpcy5tYXhTZXJ2ZXJDb25uZWN0aW9ucyA9IG1heFNlcnZlckNvbm5lY3Rpb25zCiAgICB0aGlzLm1heFBhcmFsbGVsID0gbWF4UGFyYWxsZWwKICAgIHRoaXMucmVsYXlUaHJvdWdoID0gcmVsYXlUaHJvdWdoID8gdG9SZWxheUZ1bmN0aW9uKHJlbGF5VGhyb3VnaCkgOiBudWxsCgogICAgdGhpcy5jb25uZWN0aW5nID0gMAogICAgdGhpcy5jb25uZWN0aW9ucyA9IG5ldyBTZXQoKQogICAgdGhpcy5wZWVycyA9IG5ldyBNYXAoKQogICAgdGhpcy5leHBsaWNpdFBlZXJzID0gbmV3IFNldCgpCiAgICB0aGlzLmxpc3RlbmluZyA9IG51bGwKICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgIHVwZGF0ZXM6IDAsCiAgICAgIGNvbm5lY3RzOiB7CiAgICAgICAgY2xpZW50OiB7CiAgICAgICAgICBvcGVuZWQ6IDAsCiAgICAgICAgICBjbG9zZWQ6IDAsCiAgICAgICAgICBhdHRlbXB0ZWQ6IDAKICAgICAgICB9LAogICAgICAgIHNlcnZlcjogewogICAgICAgICAgLy8gTm90ZTogdGhlcmUgaXMgbm8gbm90aW9uIG9mICdhdHRlbXB0cycgZm9yIHNlcnZlciBjb25uZWN0aW9ucwogICAgICAgICAgb3BlbmVkOiAwLAogICAgICAgICAgY2xvc2VkOiAwCiAgICAgICAgfQogICAgICB9LAogICAgICBiYW5uZWRQZWVyczogMAogICAgfQoKICAgIHRoaXMuX2Rpc2NvdmVyeSA9IG5ldyBNYXAoKQogICAgdGhpcy5fdGltZXIgPSBuZXcgUmV0cnlUaW1lcih0aGlzLl9yZXF1ZXVlLmJpbmQodGhpcyksIHsKICAgICAgYmFja29mZnM6IG9wdHMuYmFja29mZnMsCiAgICAgIGppdHRlcjogb3B0cy5qaXR0ZXIKICAgIH0pCiAgICB0aGlzLl9xdWV1ZSA9IHNwcSgpCgogICAgdGhpcy5fYWxsQ29ubmVjdGlvbnMgPSBuZXcgQ29ubmVjdGlvblNldCgpCiAgICB0aGlzLl9wZW5kaW5nRmx1c2hlcyA9IFtdCiAgICB0aGlzLl9mbHVzaFRpY2sgPSAwCgogICAgdGhpcy5fZHJhaW5pbmdRdWV1ZSA9IGZhbHNlCiAgICB0aGlzLl9jbGllbnRDb25uZWN0aW9ucyA9IDAKICAgIHRoaXMuX3NlcnZlckNvbm5lY3Rpb25zID0gMAogICAgdGhpcy5fZmlyZXdhbGwgPSBmaXJld2FsbAoKICAgIHRoaXMuZGh0Lm9uKCduZXR3b3JrLWNoYW5nZScsIHRoaXMuX2hhbmRsZU5ldHdvcmtDaGFuZ2UuYmluZCh0aGlzKSkKICAgIHRoaXMuZGh0Lm9uKCduZXR3b3JrLXVwZGF0ZScsIHRoaXMuX2hhbmRsZU5ldHdvcmtVcGRhdGUuYmluZCh0aGlzKSkKICAgIHRoaXMub24oJ3VwZGF0ZScsIHRoaXMuX2hhbmRsZVVwZGF0ZSkKICB9CgogIF9tYXliZVJlbGF5Q29ubmVjdGlvbihmb3JjZSkgewogICAgaWYgKCF0aGlzLnJlbGF5VGhyb3VnaCkgcmV0dXJuIG51bGwKICAgIHJldHVybiB0aGlzLnJlbGF5VGhyb3VnaChmb3JjZSwgdGhpcykKICB9CgogIF9lbnF1ZXVlKHBlZXJJbmZvKSB7CiAgICBpZiAocGVlckluZm8ucXVldWVkKSByZXR1cm4KICAgIHBlZXJJbmZvLnF1ZXVlZCA9IHRydWUKICAgIHBlZXJJbmZvLl9mbHVzaFRpY2sgPSB0aGlzLl9mbHVzaFRpY2sKICAgIHRoaXMuX3F1ZXVlLmFkZChwZWVySW5mbykKCiAgICB0aGlzLl9hdHRlbXB0Q2xpZW50Q29ubmVjdGlvbnMoKQogIH0KCiAgX3JlcXVldWUoYmF0Y2gpIHsKICAgIGlmICh0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCiAgICBmb3IgKGNvbnN0IHBlZXJJbmZvIG9mIGJhdGNoKSB7CiAgICAgIHBlZXJJbmZvLndhaXRpbmcgPSBmYWxzZQoKICAgICAgaWYgKAogICAgICAgIHBlZXJJbmZvLl91cGRhdGVQcmlvcml0eSgpID09PSBmYWxzZSB8fAogICAgICAgIHRoaXMuX2FsbENvbm5lY3Rpb25zLmhhcyhwZWVySW5mby5wdWJsaWNLZXkpIHx8CiAgICAgICAgcGVlckluZm8ucXVldWVkCiAgICAgICkKICAgICAgICBjb250aW51ZQogICAgICBwZWVySW5mby5xdWV1ZWQgPSB0cnVlCiAgICAgIHBlZXJJbmZvLl9mbHVzaFRpY2sgPSB0aGlzLl9mbHVzaFRpY2sKICAgICAgdGhpcy5fcXVldWUuYWRkKHBlZXJJbmZvKQogICAgfQoKICAgIHRoaXMuX2F0dGVtcHRDbGllbnRDb25uZWN0aW9ucygpCiAgfQoKICBfZmx1c2hNYXliZShwZWVySW5mbykgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9wZW5kaW5nRmx1c2hlcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBmbHVzaCA9IHRoaXMuX3BlbmRpbmdGbHVzaGVzW2ldCiAgICAgIGlmIChwZWVySW5mby5fZmx1c2hUaWNrID4gZmx1c2gudGljaykgY29udGludWUKICAgICAgaWYgKC0tZmx1c2gubWlzc2luZyA+IDApIGNvbnRpbnVlCiAgICAgIGZsdXNoLm9uZmx1c2godHJ1ZSkKICAgICAgdGhpcy5fcGVuZGluZ0ZsdXNoZXMuc3BsaWNlKGktLSwgMSkKICAgIH0KICB9CgogIF9mbHVzaEFsbE1heWJlKCkgewogICAgaWYgKAogICAgICB0aGlzLmNvbm5lY3RpbmcgPiAwIHx8CiAgICAgICh0aGlzLl9hbGxDb25uZWN0aW9ucy5zaXplIDwgdGhpcy5tYXhQZWVycyAmJgogICAgICAgIHRoaXMuX2NsaWVudENvbm5lY3Rpb25zIDwgdGhpcy5tYXhDbGllbnRDb25uZWN0aW9ucykKICAgICkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICB3aGlsZSAodGhpcy5fcGVuZGluZ0ZsdXNoZXMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IGZsdXNoID0gdGhpcy5fcGVuZGluZ0ZsdXNoZXMucG9wKCkKICAgICAgZmx1c2gub25mbHVzaCh0cnVlKQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfc2hvdWxkQ29ubmVjdEV4cGxpY2l0KCkgewogICAgcmV0dXJuICF0aGlzLmRlc3Ryb3llZCAmJiAhdGhpcy5zdXNwZW5kZWQgJiYgdGhpcy5jb25uZWN0aW5nIDwgdGhpcy5tYXhQYXJhbGxlbAogIH0KCiAgX3Nob3VsZENvbm5lY3QoKSB7CiAgICByZXR1cm4gKAogICAgICAhdGhpcy5kZXN0cm95ZWQgJiYKICAgICAgIXRoaXMuc3VzcGVuZGVkICYmCiAgICAgIHRoaXMuY29ubmVjdGluZyA8IHRoaXMubWF4UGFyYWxsZWwgJiYKICAgICAgdGhpcy5fYWxsQ29ubmVjdGlvbnMuc2l6ZSA8IHRoaXMubWF4UGVlcnMgJiYKICAgICAgdGhpcy5fY2xpZW50Q29ubmVjdGlvbnMgPCB0aGlzLm1heENsaWVudENvbm5lY3Rpb25zCiAgICApCiAgfQoKICBfc2hvdWxkUmVxdWV1ZShwZWVySW5mbykgewogICAgaWYgKHRoaXMuc3VzcGVuZGVkKSByZXR1cm4gZmFsc2UKICAgIGlmIChwZWVySW5mby5leHBsaWNpdCkgcmV0dXJuIHRydWUKICAgIGZvciAoY29uc3QgdG9waWMgb2YgcGVlckluZm8udG9waWNzKSB7CiAgICAgIGlmICh0aGlzLl9kaXNjb3ZlcnkuaGFzKGI0YS50b1N0cmluZyh0b3BpYywgJ2hleCcpKSAmJiAhdGhpcy5kZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2UKICB9CgogIF9jb25uZWN0KHBlZXJJbmZvLCBxdWV1ZWQpIHsKICAgIGlmIChwZWVySW5mby5iYW5uZWQgfHwgdGhpcy5fYWxsQ29ubmVjdGlvbnMuaGFzKHBlZXJJbmZvLnB1YmxpY0tleSkpIHsKICAgICAgaWYgKHF1ZXVlZCkgdGhpcy5fZmx1c2hNYXliZShwZWVySW5mbykKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gVE9ETzogU3VwcG9ydCBhc3luYyBmaXJld2FsbGluZyBhdCBzb21lIHBvaW50LgogICAgaWYgKHRoaXMuX2hhbmRsZUZpcmV3YWxsKHBlZXJJbmZvLnB1YmxpY0tleSwgbnVsbCkpIHsKICAgICAgaWYgKHF1ZXVlZCkgdGhpcy5fZmx1c2hNYXliZShwZWVySW5mbykKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgcmVsYXlUaHJvdWdoID0gdGhpcy5fbWF5YmVSZWxheUNvbm5lY3Rpb24ocGVlckluZm8uZm9yY2VSZWxheWluZykKICAgIGNvbnN0IGNvbm4gPSB0aGlzLmRodC5jb25uZWN0KHBlZXJJbmZvLnB1YmxpY0tleSwgewogICAgICByZWxheUFkZHJlc3NlczogcGVlckluZm8ucmVsYXlBZGRyZXNzZXMsCiAgICAgIGtleVBhaXI6IHRoaXMua2V5UGFpciwKICAgICAgcmVsYXlUaHJvdWdoCiAgICB9KQogICAgdGhpcy5fYWxsQ29ubmVjdGlvbnMuYWRkKGNvbm4pCgogICAgdGhpcy5zdGF0cy5jb25uZWN0cy5jbGllbnQuYXR0ZW1wdGVkKysKCiAgICB0aGlzLmNvbm5lY3RpbmcrKwogICAgdGhpcy5fY2xpZW50Q29ubmVjdGlvbnMrKwogICAgbGV0IG9wZW5lZCA9IGZhbHNlCgogICAgY29uc3Qgb25lcnJvciA9IChlcnIpID0+IHsKICAgICAgaWYgKHRoaXMucmVsYXlUaHJvdWdoICYmIHNob3VsZEZvcmNlUmVsYXlpbmcoZXJyLmNvZGUpKSB7CiAgICAgICAgcGVlckluZm8uZm9yY2VSZWxheWluZyA9IHRydWUKICAgICAgICAvLyBSZXNldCB0aGUgYXR0ZW1wdHMgaW4gb3JkZXIgdG8gZmFzdCBjb25uZWN0IHRvIHJlbGF5CiAgICAgICAgcGVlckluZm8uYXR0ZW1wdHMgPSAwCiAgICAgIH0KICAgIH0KCiAgICAvLyBSZW1vdmVkIG9uY2UgYSBjb25uZWN0aW9uIGlzIG9wZW5lZAogICAgY29ubi5vbignZXJyb3InLCBvbmVycm9yKQoKICAgIGNvbm4ub24oJ29wZW4nLCAoKSA9PiB7CiAgICAgIG9wZW5lZCA9IHRydWUKICAgICAgdGhpcy5zdGF0cy5jb25uZWN0cy5jbGllbnQub3BlbmVkKysKCiAgICAgIHRoaXMuX2Nvbm5lY3REb25lKCkKICAgICAgdGhpcy5jb25uZWN0aW9ucy5hZGQoY29ubikKICAgICAgY29ubi5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBvbmVycm9yKQogICAgICBwZWVySW5mby5fY29ubmVjdGVkKCkKICAgICAgcGVlckluZm8uY2xpZW50ID0gdHJ1ZQogICAgICB0aGlzLmVtaXQoJ2Nvbm5lY3Rpb24nLCBjb25uLCBwZWVySW5mbykKICAgICAgaWYgKHF1ZXVlZCkgdGhpcy5fZmx1c2hNYXliZShwZWVySW5mbykKCiAgICAgIHRoaXMuZW1pdCgndXBkYXRlJykKICAgIH0pCiAgICBjb25uLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgaWYgKCFvcGVuZWQpIHRoaXMuX2Nvbm5lY3REb25lKCkKICAgICAgdGhpcy5zdGF0cy5jb25uZWN0cy5jbGllbnQuY2xvc2VkKysKCiAgICAgIGNvbnN0IGVyciA9IGdldFN0cmVhbUVycm9yKGNvbm4pCiAgICAgIGlmIChzaG91bGRCYW4oZXJyKSkgewogICAgICAgIHRoaXMuX2JhblBlZXIocGVlckluZm8sIHRydWUsIGVycikKICAgICAgfQoKICAgICAgdGhpcy5jb25uZWN0aW9ucy5kZWxldGUoY29ubikKICAgICAgdGhpcy5fYWxsQ29ubmVjdGlvbnMuZGVsZXRlKGNvbm4pCiAgICAgIHRoaXMuX2NsaWVudENvbm5lY3Rpb25zLS0KICAgICAgcGVlckluZm8uX2Rpc2Nvbm5lY3RlZCgpCgogICAgICBwZWVySW5mby53YWl0aW5nID0gdGhpcy5fc2hvdWxkUmVxdWV1ZShwZWVySW5mbykgJiYgdGhpcy5fdGltZXIuYWRkKHBlZXJJbmZvKQogICAgICB0aGlzLl9tYXliZURlbGV0ZVBlZXIocGVlckluZm8pCgogICAgICBpZiAoIW9wZW5lZCAmJiBxdWV1ZWQpIHRoaXMuX2ZsdXNoTWF5YmUocGVlckluZm8pCgogICAgICB0aGlzLl9hdHRlbXB0Q2xpZW50Q29ubmVjdGlvbnMoKQoKICAgICAgdGhpcy5lbWl0KCd1cGRhdGUnKQogICAgfSkKCiAgICB0aGlzLmVtaXQoJ3VwZGF0ZScpCiAgfQoKICBfY29ubmVjdERvbmUoKSB7CiAgICB0aGlzLmNvbm5lY3RpbmctLQoKICAgIGlmICh0aGlzLmNvbm5lY3RpbmcgPCB0aGlzLm1heFBhcmFsbGVsKSB0aGlzLl9hdHRlbXB0Q2xpZW50Q29ubmVjdGlvbnMoKQogICAgaWYgKHRoaXMuY29ubmVjdGluZyA9PT0gMCkgdGhpcy5fZmx1c2hBbGxNYXliZSgpCiAgfQoKICAvLyBDYWxsZWQgd2hlbiB0aGUgUGVlclF1ZXVlIGluZGljYXRlcyBhIGNvbm5lY3Rpb24gc2hvdWxkIGJlIGF0dGVtcHRlZC4KICBfYXR0ZW1wdENsaWVudENvbm5lY3Rpb25zKCkgewogICAgLy8gR3VhcmQgYWdhaW5zdCByZS1lbnRyaWVzIC0gdW5zdXJlIGlmIGl0IHN0aWxsIG5lZWRlZCBidXQgZG9lc24ndCBodXJ0CiAgICBpZiAodGhpcy5fZHJhaW5pbmdRdWV1ZSB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCiAgICB0aGlzLl9kcmFpbmluZ1F1ZXVlID0gdHJ1ZQoKICAgIGZvciAoY29uc3QgcGVlckluZm8gb2YgdGhpcy5leHBsaWNpdFBlZXJzKSB7CiAgICAgIGlmICghdGhpcy5fc2hvdWxkQ29ubmVjdEV4cGxpY2l0KCkpIGJyZWFrCiAgICAgIGlmICgKICAgICAgICBwZWVySW5mby5hdHRlbXB0cyA+PSA1IHx8CiAgICAgICAgRGF0ZS5ub3coKSAtIHBlZXJJbmZvLmRpc2Nvbm5lY3RlZFRpbWUgPCBwZWVySW5mby5hdHRlbXB0cyAqIDEwMDAKICAgICAgKQogICAgICAgIGNvbnRpbnVlCiAgICAgIHRoaXMuX2Nvbm5lY3QocGVlckluZm8sIGZhbHNlKQogICAgfQoKICAgIHdoaWxlICh0aGlzLl9xdWV1ZS5sZW5ndGggJiYgdGhpcy5fc2hvdWxkQ29ubmVjdCgpKSB7CiAgICAgIGNvbnN0IHBlZXJJbmZvID0gdGhpcy5fcXVldWUuc2hpZnQoKQogICAgICBwZWVySW5mby5xdWV1ZWQgPSBmYWxzZQogICAgICB0aGlzLl9jb25uZWN0KHBlZXJJbmZvLCB0cnVlKQogICAgfQogICAgdGhpcy5fZHJhaW5pbmdRdWV1ZSA9IGZhbHNlCiAgICBpZiAodGhpcy5jb25uZWN0aW5nID09PSAwKSB0aGlzLl9mbHVzaEFsbE1heWJlKCkKICB9CgogIF9oYW5kbGVGaXJld2FsbChyZW1vdGVQdWJsaWNLZXksIHBheWxvYWQpIHsKICAgIGlmIChiNGEuZXF1YWxzKHJlbW90ZVB1YmxpY0tleSwgdGhpcy5rZXlQYWlyLnB1YmxpY0tleSkpIHJldHVybiB0cnVlCgogICAgbGV0IHBlZXJJbmZvID0gdGhpcy5wZWVycy5nZXQoYjRhLnRvU3RyaW5nKHJlbW90ZVB1YmxpY0tleSwgJ2hleCcpKQogICAgaWYgKHBlZXJJbmZvICYmIHBlZXJJbmZvLmJhbm5lZCkgcmV0dXJuIHRydWUKCiAgICBjb25zdCBmaXJld2FsbGVkID0gdGhpcy5fZmlyZXdhbGwocmVtb3RlUHVibGljS2V5LCBwYXlsb2FkKQogICAgaWYgKGZpcmV3YWxsZWQpIHsKICAgICAgaWYgKCFwZWVySW5mbykgcGVlckluZm8gPSB0aGlzLl91cHNlcnRQZWVyKHJlbW90ZVB1YmxpY0tleSkKICAgICAgdGhpcy5fYmFuUGVlcihwZWVySW5mbywgdHJ1ZSwgbmV3IEVycm9yKEVSUl9GSVJFV0FMTCkpCiAgICB9CgogICAgcmV0dXJuIGZpcmV3YWxsZWQKICB9CgogIF9oYW5kbGVTZXJ2ZXJDb25uZWN0aW9uU3dhcChleGlzdGluZywgY29ubikgewogICAgbGV0IGNsb3NlZCA9IGZhbHNlCgogICAgZXhpc3Rpbmcub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICBpZiAoY2xvc2VkKSByZXR1cm4KCiAgICAgIGNvbm4ucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgbm9vcCkKICAgICAgY29ubi5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBvbmNsb3NlKQoKICAgICAgdGhpcy5faGFuZGxlU2VydmVyQ29ubmVjdGlvbihjb25uKQogICAgfSkKCiAgICBjb25uLm9uKCdlcnJvcicsIG5vb3ApCiAgICBjb25uLm9uKCdjbG9zZScsIG9uY2xvc2UpCgogICAgZnVuY3Rpb24gb25jbG9zZSgpIHsKICAgICAgY2xvc2VkID0gdHJ1ZQogICAgfQogIH0KCiAgLy8gQ2FsbGVkIHdoZW4gdGhlIERIVCByZWNlaXZlcyBhIG5ldyBzZXJ2ZXIgY29ubmVjdGlvbi4KICBfaGFuZGxlU2VydmVyQ29ubmVjdGlvbihjb25uKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQgfHwgdGhpcy5zdXNwZW5kZWQpIHsKICAgICAgLy8gVE9ETzogSW52ZXN0aWdhdGUgd2h5IGEgZmluYWwgc2VydmVyIGNvbm5lY3Rpb24gY2FuIGJlIHJlY2VpdmVkIGFmdGVyIGNsb3NlCiAgICAgIGNvbm4ub24oJ2Vycm9yJywgbm9vcCkKICAgICAgcmV0dXJuIGNvbm4uZGVzdHJveShFUlJfREVTVFJPWUVEKQogICAgfQoKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5fYWxsQ29ubmVjdGlvbnMuZ2V0KGNvbm4ucmVtb3RlUHVibGljS2V5KQoKICAgIGlmIChleGlzdGluZykgewogICAgICAvLyBJZiBib3RoIGNvbm5lY3Rpb25zIGFyZSBmcm9tIHRoZSBzYW1lIHBlZXIsCiAgICAgIC8vIC0gcGljayB0aGUgbmV3IG9uZSBpZiB0aGUgZXhpc3Rpbmcgc3RyZWFtIGlzIGFscmVhZHkgZXN0YWJsaXNoZWQgKGhhcyBzZW50IGFuZCByZWNlaXZlZCBieXRlcyksCiAgICAgIC8vICAgYmVjYXVzZSB0aGUgb3RoZXIgY2xpZW50IG11c3QgaGF2ZSBsb3N0IHRoYXQgY29ubmVjdGlvbiBhbmQgYmUgcmVjb25uZWN0aW5nCiAgICAgIC8vIC0gb3RoZXJ3aXNlLCBwaWNrIHRoZSBvbmUgdGhhdHMgZXhwZWN0ZWQgdG8gaW5pdGlhdGUgaW4gYSB0aWUgYnJlYWsKICAgICAgY29uc3QgZXhpc3RpbmdJc091dGRhdGVkID0gZXhpc3RpbmcucmF3Qnl0ZXNSZWFkID4gMCAmJiBleGlzdGluZy5yYXdCeXRlc1dyaXR0ZW4gPiAwCiAgICAgIGNvbnN0IGV4cGVjdGVkSW5pdGlhdG9yID0gYjRhLmNvbXBhcmUoY29ubi5wdWJsaWNLZXksIGNvbm4ucmVtb3RlUHVibGljS2V5KSA+IDAKICAgICAgY29uc3Qga2VlcE5ldyA9IGV4aXN0aW5nSXNPdXRkYXRlZCB8fCBleHBlY3RlZEluaXRpYXRvciA9PT0gY29ubi5pc0luaXRpYXRvcgoKICAgICAgaWYgKGtlZXBOZXcgPT09IGZhbHNlKSB7CiAgICAgICAgZXhpc3Rpbmcuc2VuZEtlZXBBbGl2ZSgpCiAgICAgICAgY29ubi5vbignZXJyb3InLCBub29wKQogICAgICAgIGNvbm4uZGVzdHJveShuZXcgRXJyb3IoRVJSX0RVUExJQ0FURSkpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIGV4aXN0aW5nLm9uKCdlcnJvcicsIG5vb3ApCiAgICAgIGV4aXN0aW5nLmRlc3Ryb3kobmV3IEVycm9yKEVSUl9EVVBMSUNBVEUpKQogICAgICB0aGlzLl9oYW5kbGVTZXJ2ZXJDb25uZWN0aW9uU3dhcChleGlzdGluZywgY29ubikKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gV2hlbiByZWFjaGluZyBoZXJlLCB0aGUgY29ubmVjdGlvbiB3aWxsIGFsd2F5cyBiZSAnb3BlbmVkJyBuZXh0IHRpY2sKICAgIHRoaXMuc3RhdHMuY29ubmVjdHMuc2VydmVyLm9wZW5lZCsrCgogICAgY29uc3QgcGVlckluZm8gPSB0aGlzLl91cHNlcnRQZWVyKGNvbm4ucmVtb3RlUHVibGljS2V5LCBudWxsKQoKICAgIHRoaXMuY29ubmVjdGlvbnMuYWRkKGNvbm4pCiAgICB0aGlzLl9hbGxDb25uZWN0aW9ucy5hZGQoY29ubikKICAgIHRoaXMuX3NlcnZlckNvbm5lY3Rpb25zKysKCiAgICBjb25uLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgY29uc3QgZXJyID0gZ2V0U3RyZWFtRXJyb3IoY29ubikKICAgICAgaWYgKHNob3VsZEJhbihlcnIpKSB7CiAgICAgICAgdGhpcy5fYmFuUGVlcihwZWVySW5mbywgdHJ1ZSwgZXJyKQogICAgICB9CgogICAgICB0aGlzLmNvbm5lY3Rpb25zLmRlbGV0ZShjb25uKQogICAgICB0aGlzLl9hbGxDb25uZWN0aW9ucy5kZWxldGUoY29ubikKICAgICAgdGhpcy5fc2VydmVyQ29ubmVjdGlvbnMtLQogICAgICB0aGlzLnN0YXRzLmNvbm5lY3RzLnNlcnZlci5jbG9zZWQrKwoKICAgICAgdGhpcy5fbWF5YmVEZWxldGVQZWVyKHBlZXJJbmZvKQoKICAgICAgdGhpcy5fYXR0ZW1wdENsaWVudENvbm5lY3Rpb25zKCkKCiAgICAgIHRoaXMuZW1pdCgndXBkYXRlJykKICAgIH0pCiAgICBwZWVySW5mby5jbGllbnQgPSBmYWxzZQogICAgdGhpcy5lbWl0KCdjb25uZWN0aW9uJywgY29ubiwgcGVlckluZm8pCgogICAgdGhpcy5lbWl0KCd1cGRhdGUnKQogIH0KCiAgX3Vwc2VydFBlZXIocHVibGljS2V5LCByZWxheUFkZHJlc3NlcykgewogICAgaWYgKGI0YS5lcXVhbHMocHVibGljS2V5LCB0aGlzLmtleVBhaXIucHVibGljS2V5KSkgcmV0dXJuIG51bGwKICAgIGNvbnN0IGtleVN0cmluZyA9IGI0YS50b1N0cmluZyhwdWJsaWNLZXksICdoZXgnKQogICAgbGV0IHBlZXJJbmZvID0gdGhpcy5wZWVycy5nZXQoa2V5U3RyaW5nKQoKICAgIGlmIChwZWVySW5mbykgewogICAgICBwZWVySW5mby5yZWxheUFkZHJlc3NlcyA9IHJlbGF5QWRkcmVzc2VzIC8vIG5ldyBpcyBhbHdheXMgYmV0dGVyCiAgICAgIHJldHVybiBwZWVySW5mbwogICAgfQoKICAgIHBlZXJJbmZvID0gbmV3IFBlZXJJbmZvKHsKICAgICAgcHVibGljS2V5LAogICAgICByZWxheUFkZHJlc3NlcwogICAgfSkKCiAgICB0aGlzLnBlZXJzLnNldChrZXlTdHJpbmcsIHBlZXJJbmZvKQogICAgcmV0dXJuIHBlZXJJbmZvCiAgfQoKICBfaGFuZGxlVXBkYXRlKCkgewogICAgdGhpcy5zdGF0cy51cGRhdGVzKysKICB9CgogIF9tYXliZURlbGV0ZVBlZXIocGVlckluZm8pIHsKICAgIGlmICghcGVlckluZm8uc2hvdWxkR0MoKSkgcmV0dXJuCgogICAgY29uc3QgaGFzQWN0aXZlQ29ubiA9IHRoaXMuX2FsbENvbm5lY3Rpb25zLmhhcyhwZWVySW5mby5wdWJsaWNLZXkpCiAgICBpZiAoaGFzQWN0aXZlQ29ubikgcmV0dXJuCgogICAgY29uc3Qga2V5U3RyaW5nID0gYjRhLnRvU3RyaW5nKHBlZXJJbmZvLnB1YmxpY0tleSwgJ2hleCcpCiAgICB0aGlzLnBlZXJzLmRlbGV0ZShrZXlTdHJpbmcpCiAgfQoKICAvKgogICAqIENhbGxlZCB3aGVuIGEgcGVlciBpcyBhY3RpdmVseSBkaXNjb3ZlcmVkIGR1cmluZyBhIGxvb2t1cC4KICAgKgogICAqIFRocmVlIGNvbmRpdGlvbnM6CiAgICogIDEuIE5vdCBhIGtub3duIHBlZXIgLS0gaW5zZXJ0IGludG8gcXVldWUKICAgKiAgMi4gQSBrbm93biBwZWVyIHdpdGggbm9ybWFsIHByaW9yaXR5IC0tIGRvIG5vdGhpbmcKICAgKiAgMy4gQSBrbm93biBwZWVyIHdpdGggbG93IHByaW9yaXR5IC0tIGJ1bXAgcHJpb3JpdHksIGJlY2F1c2UgaXQncyBiZWVuIHJlZGlzY292ZXJlZAogICAqLwogIF9oYW5kbGVQZWVyKHBlZXIsIHRvcGljKSB7CiAgICBjb25zdCBwZWVySW5mbyA9IHRoaXMuX3Vwc2VydFBlZXIocGVlci5wdWJsaWNLZXksIHBlZXIucmVsYXlBZGRyZXNzZXMpCiAgICBpZiAocGVlckluZm8pIHBlZXJJbmZvLl90b3BpYyh0b3BpYykKICAgIGlmICghcGVlckluZm8gfHwgdGhpcy5fYWxsQ29ubmVjdGlvbnMuaGFzKHBlZXIucHVibGljS2V5KSkgcmV0dXJuCiAgICBpZiAoIXBlZXJJbmZvLnByaW9yaXRpemVkIHx8IHBlZXJJbmZvLnNlcnZlcikgcGVlckluZm8uX3Jlc2V0KCkKICAgIGlmIChwZWVySW5mby5fdXBkYXRlUHJpb3JpdHkoKSkgewogICAgICB0aGlzLl9lbnF1ZXVlKHBlZXJJbmZvKQogICAgfQogIH0KCiAgYXN5bmMgX2hhbmRsZU5ldHdvcmtVcGRhdGUoKSB7CiAgICBpZiAoIXRoaXMub25saW5lKSByZXR1cm4KICAgIHRoaXMuX2hhbmRsZU5ldHdvcmtDaGFuZ2UoKQogIH0KCiAgYXN5bmMgX2hhbmRsZU5ldHdvcmtDaGFuZ2UoKSB7CiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIHJldHVybgoKICAgIC8vIHByaW9yaXRpemUgZmlndXJpbmcgb3V0IGlmIGV4aXN0aW5nIGNvbm5lY3Rpb25zIGFyZSBkZWFkCiAgICBmb3IgKGNvbnN0IGNvbm4gb2YgdGhpcy5fYWxsQ29ubmVjdGlvbnMpIHsKICAgICAgY29ubi5zZW5kS2VlcEFsaXZlKCkKICAgIH0KCiAgICBjb25zdCByZWZyZXNoZXMgPSBbXQoKICAgIGZvciAoY29uc3QgZGlzY292ZXJ5IG9mIHRoaXMuX2Rpc2NvdmVyeS52YWx1ZXMoKSkgewogICAgICByZWZyZXNoZXMucHVzaChkaXNjb3ZlcnkucmVmcmVzaCgpKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChyZWZyZXNoZXMpCiAgfQoKICBfYmFuUGVlcihwZWVySW5mbywgYmFubmVkLCBlcnIpIHsKICAgIHBlZXJJbmZvLmJhbihiYW5uZWQpCiAgICB0aGlzLnN0YXRzLmJhbm5lZFBlZXJzKysKICAgIHRoaXMuZW1pdCgnYmFuJywgcGVlckluZm8sIGVycikKICB9CgogIHN0YXR1cyhrZXkpIHsKICAgIHJldHVybiB0aGlzLl9kaXNjb3ZlcnkuZ2V0KGI0YS50b1N0cmluZyhrZXksICdoZXgnKSkgfHwgbnVsbAogIH0KCiAgbGlzdGVuKCkgewogICAgaWYgKCF0aGlzLmxpc3RlbmluZykgewogICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcignU3dhcm0gZGVzdHJveWVkJykKICAgICAgdGhpcy5saXN0ZW5pbmcgPSB0aGlzLnNlcnZlci5saXN0ZW4odGhpcy5rZXlQYWlyKQogICAgfQogICAgcmV0dXJuIHRoaXMubGlzdGVuaW5nCiAgfQoKICAvLyBPYmplY3QgdGhhdCBleHBvc2VzIGEgY2FuY2VsbGF0aW9uIG1ldGhvZCAoZGVzdHJveSkKICAvLyBUT0RPOiBXaGVuIHlvdSByZWpvaW4sIGl0IHNob3VsZCByZWFubm91bmNlICsgYnVtcCBsb29rdXAgcHJpb3JpdHkKICBqb2luKHRvcGljLCBvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdTd2FybSBkZXN0cm95ZWQnKQogICAgaWYgKCF0b3BpYykgdGhyb3cgbmV3IEVycm9yKEVSUl9NSVNTSU5HX1RPUElDKQogICAgdG9waWMgPSB1bnNsYWIodG9waWMpCgogICAgY29uc3QgdG9waWNTdHJpbmcgPSBiNGEudG9TdHJpbmcodG9waWMsICdoZXgnKQoKICAgIGxldCBkaXNjb3ZlcnkgPSB0aGlzLl9kaXNjb3ZlcnkuZ2V0KHRvcGljU3RyaW5nKQoKICAgIGlmIChkaXNjb3ZlcnkgJiYgIWRpc2NvdmVyeS5kZXN0cm95ZWQpIHsKICAgICAgcmV0dXJuIGRpc2NvdmVyeS5zZXNzaW9uKG9wdHMpCiAgICB9CgogICAgZGlzY292ZXJ5ID0gbmV3IFBlZXJEaXNjb3ZlcnkodGhpcywgdG9waWMsIHsKICAgICAgbGltaXQ6IG9wdHMubGltaXQsCiAgICAgIHdhaXQ6IGRpc2NvdmVyeSA/IGRpc2NvdmVyeS5kZXN0cm95KCkgOiBudWxsLAogICAgICBzdXNwZW5kZWQ6IHRoaXMuc3VzcGVuZGVkLAogICAgICBvbnBlZXI6IChwZWVyKSA9PiB0aGlzLl9oYW5kbGVQZWVyKHBlZXIsIHRvcGljKQogICAgfSkKICAgIHRoaXMuX2Rpc2NvdmVyeS5zZXQodG9waWNTdHJpbmcsIGRpc2NvdmVyeSkKICAgIHJldHVybiBkaXNjb3Zlcnkuc2Vzc2lvbihvcHRzKQogIH0KCiAgLy8gUmV0dXJucyBhIHByb21pc2UKICBhc3luYyBsZWF2ZSh0b3BpYykgewogICAgaWYgKCF0b3BpYykgdGhyb3cgbmV3IEVycm9yKEVSUl9NSVNTSU5HX1RPUElDKQogICAgY29uc3QgdG9waWNTdHJpbmcgPSBiNGEudG9TdHJpbmcodG9waWMsICdoZXgnKQogICAgaWYgKCF0aGlzLl9kaXNjb3ZlcnkuaGFzKHRvcGljU3RyaW5nKSkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCgogICAgY29uc3QgZGlzY292ZXJ5ID0gdGhpcy5fZGlzY292ZXJ5LmdldCh0b3BpY1N0cmluZykKCiAgICB0cnkgewogICAgICBhd2FpdCBkaXNjb3ZlcnkuZGVzdHJveSgpCiAgICB9IGNhdGNoIHsKICAgICAgLy8gaWdub3JlLCBwcm9wIG5ldHdvcmsKICAgIH0KCiAgICBpZiAodGhpcy5fZGlzY292ZXJ5LmdldCh0b3BpY1N0cmluZykgPT09IGRpc2NvdmVyeSkgewogICAgICB0aGlzLl9kaXNjb3ZlcnkuZGVsZXRlKHRvcGljU3RyaW5nKQogICAgfQogIH0KCiAgam9pblBlZXIocHVibGljS2V5KSB7CiAgICBjb25zdCBwZWVySW5mbyA9IHRoaXMuX3Vwc2VydFBlZXIocHVibGljS2V5LCBudWxsKQogICAgaWYgKCFwZWVySW5mbykgcmV0dXJuCiAgICBpZiAoIXRoaXMuZXhwbGljaXRQZWVycy5oYXMocGVlckluZm8pKSB7CiAgICAgIHBlZXJJbmZvLmV4cGxpY2l0ID0gdHJ1ZQogICAgICB0aGlzLmV4cGxpY2l0UGVlcnMuYWRkKHBlZXJJbmZvKQogICAgfQogICAgaWYgKHRoaXMuX2FsbENvbm5lY3Rpb25zLmhhcyhwdWJsaWNLZXkpKSByZXR1cm4KICAgIGlmIChwZWVySW5mby5fdXBkYXRlUHJpb3JpdHkoKSkgewogICAgICB0aGlzLl9lbnF1ZXVlKHBlZXJJbmZvKQogICAgfQogIH0KCiAgbGVhdmVQZWVyKHB1YmxpY0tleSkgewogICAgY29uc3Qga2V5U3RyaW5nID0gYjRhLnRvU3RyaW5nKHB1YmxpY0tleSwgJ2hleCcpCiAgICBpZiAoIXRoaXMucGVlcnMuaGFzKGtleVN0cmluZykpIHJldHVybgoKICAgIGNvbnN0IHBlZXJJbmZvID0gdGhpcy5wZWVycy5nZXQoa2V5U3RyaW5nKQogICAgcGVlckluZm8uZXhwbGljaXQgPSBmYWxzZQogICAgdGhpcy5leHBsaWNpdFBlZXJzLmRlbGV0ZShwZWVySW5mbykKICAgIHRoaXMuX21heWJlRGVsZXRlUGVlcihwZWVySW5mbykKICB9CgogIC8vIFJldHVybnMgYSBwcm9taXNlCiAgYXN5bmMgZmx1c2goKSB7CiAgICBjb25zdCBhbGxGbHVzaGVkID0gWy4uLnRoaXMuX2Rpc2NvdmVyeS52YWx1ZXMoKV0ubWFwKCh2KSA9PiB2LmZsdXNoZWQoKSkKICAgIGF3YWl0IFByb21pc2UuYWxsKGFsbEZsdXNoZWQpCiAgICBpZiAodGhpcy5fZmx1c2hBbGxNYXliZSgpKSByZXR1cm4gdHJ1ZQogICAgY29uc3QgcGVuZGluZ1NpemUgPSB0aGlzLl9hbGxDb25uZWN0aW9ucy5zaXplIC0gdGhpcy5jb25uZWN0aW9ucy5zaXplCiAgICBpZiAoIXRoaXMuX3F1ZXVlLmxlbmd0aCAmJiAhcGVuZGluZ1NpemUpIHJldHVybiB0cnVlCiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgdGhpcy5fcGVuZGluZ0ZsdXNoZXMucHVzaCh7CiAgICAgICAgb25mbHVzaDogcmVzb2x2ZSwKICAgICAgICBtaXNzaW5nOiB0aGlzLl9xdWV1ZS5sZW5ndGggKyBwZW5kaW5nU2l6ZSwKICAgICAgICB0aWNrOiB0aGlzLl9mbHVzaFRpY2srKwogICAgICB9KQogICAgfSkKICB9CgogIGFzeW5jIGNsZWFyKCkgewogICAgY29uc3QgY2xlYXJlZCA9IFByb21pc2UuYWxsU2V0dGxlZChbLi4udGhpcy5fZGlzY292ZXJ5LnZhbHVlcygpXS5tYXAoKGQpID0+IGQuZGVzdHJveSgpKSkKICAgIHRoaXMuX2Rpc2NvdmVyeS5jbGVhcigpCiAgICByZXR1cm4gY2xlYXJlZAogIH0KCiAgYXN5bmMgZGVzdHJveSh7IGZvcmNlIH0gPSB7fSkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkICYmICFmb3JjZSkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKCiAgICB0aGlzLl90aW1lci5kZXN0cm95KCkKCiAgICBpZiAoIWZvcmNlKSBhd2FpdCB0aGlzLmNsZWFyKCkKCiAgICBhd2FpdCB0aGlzLnNlcnZlci5jbG9zZSgpCgogICAgd2hpbGUgKHRoaXMuX3BlbmRpbmdGbHVzaGVzLmxlbmd0aCkgewogICAgICBjb25zdCBmbHVzaCA9IHRoaXMuX3BlbmRpbmdGbHVzaGVzLnBvcCgpCiAgICAgIGZsdXNoLm9uZmx1c2goZmFsc2UpCiAgICB9CgogICAgYXdhaXQgdGhpcy5kaHQuZGVzdHJveSh7IGZvcmNlIH0pCiAgfQoKICBhc3luYyBzdXNwZW5kKHsgbG9nID0gbm9vcCB9ID0ge30pIHsKICAgIGlmICh0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCgogICAgY29uc3QgcHJvbWlzZXMgPSBbXQoKICAgIHByb21pc2VzLnB1c2godGhpcy5zZXJ2ZXIuc3VzcGVuZCh7IGxvZyB9KSkKCiAgICBmb3IgKGNvbnN0IGRpc2NvdmVyeSBvZiB0aGlzLl9kaXNjb3ZlcnkudmFsdWVzKCkpIHsKICAgICAgcHJvbWlzZXMucHVzaChkaXNjb3Zlcnkuc3VzcGVuZCh7IGxvZyB9KSkKICAgIH0KCiAgICBjb25zdCBwZW5kaW5nID0gW10KICAgIGZvciAoY29uc3QgY29ubmVjdGlvbiBvZiB0aGlzLl9hbGxDb25uZWN0aW9ucykgewogICAgICBjb25uZWN0aW9uLmRlc3Ryb3koKQogICAgICBwZW5kaW5nLnB1c2gobmV3IFByb21pc2UoKHJlc29sdmUpID0+IGNvbm5lY3Rpb24ub24oJ2Nsb3NlJywgcmVzb2x2ZSkpKQogICAgfQoKICAgIHRoaXMuc3VzcGVuZGVkID0gdHJ1ZQoKICAgIGxvZygnU3VzcGVuZGluZyBzZXJ2ZXIgYW5kIGRpc2NvdmVyeS4uLiAoJyArIHByb21pc2VzLmxlbmd0aCArICcpJykKICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChwcm9taXNlcykKICAgIGxvZygnRG9uZSwgc3VzcGVuZGluZyB0aGUgZGh0Li4uJykKICAgIGF3YWl0IHRoaXMuZGh0LnN1c3BlbmQoeyBsb2cgfSkKICAgIGxvZygnRG9uZSwgc3dhcm0gZnVsbHkgc3VzcGVuZGVkJykKCiAgICBhd2FpdCBQcm9taXNlLmFsbChwZW5kaW5nKQoKICAgIC8vIHJlc2V0IHF1ZXVlCiAgICB0aGlzLl90aW1lci5kZXN0cm95KCkKICAgIHRoaXMuX3RpbWVyID0gbmV3IFJldHJ5VGltZXIodGhpcy5fcmVxdWV1ZS5iaW5kKHRoaXMpLCB7CiAgICAgIGJhY2tvZmZzOiB0aGlzLl90aW1lci5iYWNrb2ZmcywKICAgICAgaml0dGVyOiB0aGlzLl90aW1lci5qaXR0ZXIKICAgIH0pCiAgICB0aGlzLl9xdWV1ZSA9IHNwcSgpCiAgfQoKICBhc3luYyByZXN1bWUoeyBsb2cgPSBub29wIH0gPSB7fSkgewogICAgaWYgKCF0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCgogICAgbG9nKCdSZXN1bWluZyB0aGUgZGh0JykKICAgIGF3YWl0IHRoaXMuZGh0LnJlc3VtZSgpCiAgICBsb2coJ0RvbmUsIHJlc3VtaW5nIHRoZSBzZXJ2ZXInKQogICAgYXdhaXQgdGhpcy5zZXJ2ZXIucmVzdW1lKCkKICAgIGxvZygnRG9uZSwgYWxsIGRpc2NvdmVyeScpCgogICAgZm9yIChjb25zdCBkaXNjb3Zlcnkgb2YgdGhpcy5fZGlzY292ZXJ5LnZhbHVlcygpKSB7CiAgICAgIGRpc2NvdmVyeS5yZXN1bWUoKQogICAgfQoKICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKICAgIHRoaXMuX2F0dGVtcHRDbGllbnRDb25uZWN0aW9ucygpCiAgfQoKICB0b3BpY3MoKSB7CiAgICByZXR1cm4gdGhpcy5fZGlzY292ZXJ5LnZhbHVlcygpCiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIGFsbG93QWxsKCkgewogIHJldHVybiBmYWxzZQp9CgpmdW5jdGlvbiBzaG91bGRGb3JjZVJlbGF5aW5nKGNvZGUpIHsKICByZXR1cm4gKAogICAgY29kZSA9PT0gJ0hPTEVQVU5DSF9BQk9SVEVEJyB8fAogICAgY29kZSA9PT0gJ0hPTEVQVU5DSF9ET1VCTEVfUkFORE9NSVpFRF9OQVRTJyB8fAogICAgY29kZSA9PT0gJ1JFTU9URV9OT1RfSE9MRVBVTkNIQUJMRScKICApCn0KCmZ1bmN0aW9uIHNob3VsZEJhbigpIHsKICAvLyByZXR1cm4gISFlcnIgJiYgZXJyLm5hbWUgPT09ICdIeXBlcmNvcmVFcnJvcicgJiYgZXJyLmNvZGUgPT09ICdJTlZBTElEX09QRVJBVElPTicKICByZXR1cm4gZmFsc2UKfQoKZnVuY3Rpb24gdG9SZWxheUZ1bmN0aW9uKHJlbGF5VGhyb3VnaCkgewogIHJldHVybiB0eXBlb2YgcmVsYXlUaHJvdWdoID09PSAnZnVuY3Rpb24nCiAgICA/IHJlbGF5VGhyb3VnaAogICAgOiAoZm9yY2UsIHN3YXJtKSA9PiAoZm9yY2UgfHwgc3dhcm0uZGh0LnJhbmRvbWl6ZWQgPyByZWxheVRocm91Z2ggOiBudWxsKQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQnVsa1RpbWVyIHsKICBjb25zdHJ1Y3Rvcih0aW1lLCBmbikgewogICAgdGhpcy5fdGltZSA9IHRpbWUKICAgIHRoaXMuX2ZuID0gZm4KICAgIHRoaXMuX2ludGVydmFsID0gbnVsbAogICAgdGhpcy5fbmV4dCA9IFtdCiAgICB0aGlzLl9wZW5kaW5nID0gW10KICAgIHRoaXMuX2Rlc3Ryb3llZCA9IGZhbHNlCiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLl9kZXN0cm95ZWQgPSB0cnVlCiAgICBjbGVhckludGVydmFsKHRoaXMuX2ludGVydmFsKQogICAgdGhpcy5faW50ZXJ2YWwgPSBudWxsCiAgfQoKICBfb250aWNrKCkgewogICAgaWYgKCF0aGlzLl9uZXh0Lmxlbmd0aCAmJiAhdGhpcy5fcGVuZGluZy5sZW5ndGgpIHJldHVybgogICAgaWYgKHRoaXMuX25leHQubGVuZ3RoKSB0aGlzLl9mbih0aGlzLl9uZXh0KQogICAgdGhpcy5fbmV4dCA9IHRoaXMuX3BlbmRpbmcKICAgIHRoaXMuX3BlbmRpbmcgPSBbXQogIH0KCiAgYWRkKGluZm8pIHsKICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHJldHVybgogICAgaWYgKCF0aGlzLl9pbnRlcnZhbCkgewogICAgICB0aGlzLl9pbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuX29udGljay5iaW5kKHRoaXMpLCBNYXRoLmZsb29yKHRoaXMuX3RpbWUgKiAwLjY2KSkKICAgIH0KCiAgICB0aGlzLl9wZW5kaW5nLnB1c2goaW5mbykKICB9Cn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ29ubmVjdGlvblNldCB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLl9ieVB1YmxpY0tleSA9IG5ldyBNYXAoKQogIH0KCiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy5fYnlQdWJsaWNLZXkudmFsdWVzKCkKICB9CgogIGdldCBzaXplKCkgewogICAgcmV0dXJuIHRoaXMuX2J5UHVibGljS2V5LnNpemUKICB9CgogIGhhcyhwdWJsaWNLZXkpIHsKICAgIHJldHVybiB0aGlzLl9ieVB1YmxpY0tleS5oYXModG9IZXgocHVibGljS2V5KSkKICB9CgogIGdldChwdWJsaWNLZXkpIHsKICAgIHJldHVybiB0aGlzLl9ieVB1YmxpY0tleS5nZXQodG9IZXgocHVibGljS2V5KSkKICB9CgogIGFkZChjb25uZWN0aW9uKSB7CiAgICB0aGlzLl9ieVB1YmxpY0tleS5zZXQoYjRhLnRvU3RyaW5nKGNvbm5lY3Rpb24ucmVtb3RlUHVibGljS2V5LCAnaGV4JyksIGNvbm5lY3Rpb24pCiAgfQoKICBkZWxldGUoY29ubmVjdGlvbikgewogICAgY29uc3Qga2V5U3RyaW5nID0gYjRhLnRvU3RyaW5nKGNvbm5lY3Rpb24ucmVtb3RlUHVibGljS2V5LCAnaGV4JykKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5fYnlQdWJsaWNLZXkuZ2V0KGtleVN0cmluZykKICAgIGlmIChleGlzdGluZyAhPT0gY29ubmVjdGlvbikgcmV0dXJuCiAgICB0aGlzLl9ieVB1YmxpY0tleS5kZWxldGUoa2V5U3RyaW5nKQogIH0KfQoKZnVuY3Rpb24gdG9IZXgoYikgewogIHJldHVybiB0eXBlb2YgYiA9PT0gJ3N0cmluZycgPyBiIDogYjRhLnRvU3RyaW5nKGIsICdoZXgnKQp9CmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IFJFRlJFU0hfSU5URVJWQUwgPSAxMDAwICogNjAgKiAxMCAvLyAxMCBtaW4KY29uc3QgUkFORE9NX0pJVFRFUiA9IDEwMDAgKiA2MCAqIDIgLy8gMiBtaW4KY29uc3QgREVMQVlfR1JBQ0VfUEVSSU9EID0gMTAwMCAqIDMwIC8vIDMwcwoKY29uc3QgTUFYX0RJU0NPVkVSWV9DQUNIRSA9IDY0Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFBlZXJEaXNjb3ZlcnkgewogIGNvbnN0cnVjdG9yKAogICAgc3dhcm0sCiAgICB0b3BpYywKICAgIHsgbGltaXQgPSBJbmZpbml0eSwgd2FpdCA9IG51bGwsIHN1c3BlbmRlZCA9IGZhbHNlLCBvbnBlZXIgPSBub29wLCBvbmVycm9yID0gc2FmZXR5Q2F0Y2ggfQogICkgewogICAgdGhpcy5saW1pdCA9IGxpbWl0CiAgICB0aGlzLnN3YXJtID0gc3dhcm0KICAgIHRoaXMudG9waWMgPSB0b3BpYwogICAgdGhpcy5pc0NsaWVudCA9IGZhbHNlCiAgICB0aGlzLmlzU2VydmVyID0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWluZyA9IG51bGwKICAgIHRoaXMuc3VzcGVuZGVkID0gc3VzcGVuZGVkCgogICAgdGhpcy5fc2Vzc2lvbnMgPSBbXQogICAgdGhpcy5fY2xpZW50U2Vzc2lvbnMgPSAwCiAgICB0aGlzLl9zZXJ2ZXJTZXNzaW9ucyA9IDAKCiAgICB0aGlzLl9vbnBlZXIgPSBvbnBlZXIKICAgIHRoaXMuX29uZXJyb3IgPSBvbmVycm9yCgogICAgdGhpcy5fZGlzY292ZXJlZCA9IG5ldyBTZXQoKQogICAgdGhpcy5fYWN0aXZlUXVlcnkgPSBudWxsCiAgICB0aGlzLl90aW1lciA9IG51bGwKICAgIHRoaXMuX2N1cnJlbnRSZWZyZXNoID0gbnVsbAogICAgdGhpcy5fY2xvc2VzdE5vZGVzID0gbnVsbAogICAgdGhpcy5fZmlyc3RBbm5vdW5jZSA9IHRydWUKICAgIHRoaXMuX25lZWRzVW5hbm5vdW5jZSA9IGZhbHNlCiAgICB0aGlzLl9yZWZyZXNoZXMgPSAwCiAgICB0aGlzLl93YWl0ID0gd2FpdAogIH0KCiAgc2Vzc2lvbih7IHNlcnZlciA9IHRydWUsIGNsaWVudCA9IHRydWUsIGxpbWl0ID0gSW5maW5pdHksIG9uZXJyb3IgPSBzYWZldHlDYXRjaCB9KSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcignUGVlckRpc2NvdmVyeSBpcyBkZXN0cm95ZWQnKQogICAgY29uc3Qgc2Vzc2lvbiA9IG5ldyBQZWVyRGlzY292ZXJ5U2Vzc2lvbih0aGlzKQogICAgc2Vzc2lvbi5yZWZyZXNoKHsgc2VydmVyLCBjbGllbnQsIGxpbWl0IH0pLmNhdGNoKG9uZXJyb3IpCiAgICB0aGlzLl9zZXNzaW9ucy5wdXNoKHNlc3Npb24pCiAgICByZXR1cm4gc2Vzc2lvbgogIH0KCiAgX3JlZnJlc2hMYXRlcihlYWdlcikgewogICAgY29uc3Qgaml0dGVyID0gTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogUkFORE9NX0pJVFRFUikKICAgIGNvbnN0IGRlbGF5ID0gIWVhZ2VyID8gUkVGUkVTSF9JTlRFUlZBTCArIGppdHRlciA6IGppdHRlcgoKICAgIGlmICh0aGlzLl90aW1lcikgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVyKQoKICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCkKICAgIHRoaXMuX3RpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIC8vIElmIHlvdXIgbGFwdG9wIHdlbnQgdG8gc2xlZXAsIGFuZCBpcyBjb21pbmcgYmFjayBvbmxpbmUuLi4KICAgICAgY29uc3Qgb3ZlcmR1ZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWUgPiBkZWxheSArIERFTEFZX0dSQUNFX1BFUklPRAogICAgICBpZiAob3ZlcmR1ZSkgdGhpcy5fcmVmcmVzaExhdGVyKHRydWUpCiAgICAgIGVsc2UgdGhpcy5yZWZyZXNoKCkuY2F0Y2godGhpcy5fb25lcnJvcikKICAgIH0sIGRlbGF5KQogIH0KCiAgX2lzQWN0aXZlKCkgewogICAgcmV0dXJuICF0aGlzLmRlc3Ryb3llZCAmJiAhdGhpcy5zdXNwZW5kZWQKICB9CgogIC8vIFRPRE86IEFsbG93IGFubm91bmNlIHRvIGJlIGFuIGFyZ3VtZW50IHRvIHRoaXMKICAvLyBUT0RPOiBNYXliZSBhbm5vdW5jZSBzaG91bGQgYmUgYSBzZXR0ZXI/CiAgYXN5bmMgX3JlZnJlc2goKSB7CiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIHJldHVybgogICAgY29uc3QgY2xvY2sgPSArK3RoaXMuX3JlZnJlc2hlcwoKICAgIGlmICh0aGlzLl93YWl0KSB7CiAgICAgIGF3YWl0IHRoaXMuX3dhaXQKICAgICAgdGhpcy5fd2FpdCA9IG51bGwKICAgICAgaWYgKGNsb2NrICE9PSB0aGlzLl9yZWZyZXNoZXMgfHwgIXRoaXMuX2lzQWN0aXZlKCkpIHJldHVybgogICAgfQoKICAgIGNvbnN0IGNsZWFyID0gdGhpcy5pc1NlcnZlciAmJiB0aGlzLl9maXJzdEFubm91bmNlCiAgICBpZiAoY2xlYXIpIHRoaXMuX2ZpcnN0QW5ub3VuY2UgPSBmYWxzZQoKICAgIGNvbnN0IG9wdHMgPSB7CiAgICAgIGNsZWFyLAogICAgICBjbG9zZXN0Tm9kZXM6IHRoaXMuX2Nsb3Nlc3ROb2RlcwogICAgfQoKICAgIGlmICh0aGlzLmlzU2VydmVyKSB7CiAgICAgIGF3YWl0IHRoaXMuc3dhcm0ubGlzdGVuKCkKICAgICAgLy8gaWYgYSBwYXJhbGxlbCByZWZyZXNoIGlzIGhhcHBlbmluZywgeWllbGQgdG8gdGhlIG5ldyBvbmUKICAgICAgaWYgKGNsb2NrICE9PSB0aGlzLl9yZWZyZXNoZXMgfHwgIXRoaXMuX2lzQWN0aXZlKCkpIHJldHVybgogICAgICB0aGlzLl9uZWVkc1VuYW5ub3VuY2UgPSB0cnVlCiAgICB9CgogICAgbGV0IGxpbWl0ID0gdGhpcy5saW1pdAoKICAgIGlmIChsaW1pdCA8IEluZmluaXR5ICYmIGxpbWl0ID4gMCkgewogICAgICBmb3IgKGNvbnN0IGlkIG9mIHRoaXMuX2Rpc2NvdmVyZWQpIHsKICAgICAgICBpZiAoIXRoaXMuc3dhcm0uY29ubmVjdGlvbnMuaGFzKGlkKSkgY29udGludWUKICAgICAgICBpZiAoLS1saW1pdCA9PT0gMCkgYnJlYWsKICAgICAgfQogICAgfQoKICAgIHRoaXMuX2Rpc2NvdmVyZWQuY2xlYXIoKQoKICAgIGNvbnN0IGFubm91bmNpbmcgPSB0aGlzLmlzU2VydmVyCiAgICBjb25zdCBxdWVyeSA9ICh0aGlzLl9hY3RpdmVRdWVyeSA9IGFubm91bmNpbmcKICAgICAgPyB0aGlzLnN3YXJtLmRodC5hbm5vdW5jZSgKICAgICAgICAgIHRoaXMudG9waWMsCiAgICAgICAgICB0aGlzLnN3YXJtLmtleVBhaXIsCiAgICAgICAgICB0aGlzLnN3YXJtLnNlcnZlci5yZWxheUFkZHJlc3NlcywKICAgICAgICAgIG9wdHMKICAgICAgICApCiAgICAgIDogdGhpcy5fbmVlZHNVbmFubm91bmNlCiAgICAgICAgPyB0aGlzLnN3YXJtLmRodC5sb29rdXBBbmRVbmFubm91bmNlKHRoaXMudG9waWMsIHRoaXMuc3dhcm0ua2V5UGFpciwgb3B0cykKICAgICAgICA6IHRoaXMuc3dhcm0uZGh0Lmxvb2t1cCh0aGlzLnRvcGljLCBvcHRzKSkKCiAgICB0cnkgewogICAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgdGhpcy5fYWN0aXZlUXVlcnkpIHsKICAgICAgICBpZiAoIXRoaXMuaXNDbGllbnQgfHwgIXRoaXMuX2lzQWN0aXZlKCkpIGNvbnRpbnVlCiAgICAgICAgZm9yIChjb25zdCBwZWVyIG9mIGRhdGEucGVlcnMpIHsKICAgICAgICAgIGlmIChsaW1pdCA8IEluZmluaXR5KSB7CiAgICAgICAgICAgIGNvbnN0IGlkID0gYjRhLnRvU3RyaW5nKHBlZXIucHVibGljS2V5LCAnaGV4JykKCiAgICAgICAgICAgIGlmICh0aGlzLl9kaXNjb3ZlcmVkLnNpemUgPCBNQVhfRElTQ09WRVJZX0NBQ0hFKSB7CiAgICAgICAgICAgICAgdGhpcy5fZGlzY292ZXJlZC5hZGQoaWQpCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChsaW1pdCA9PT0gMCkgY29udGludWUKCiAgICAgICAgICAgIC8vIHRoZXJlIGlzIGEgY2hhbmNlIGl0IGhhcyB1cGRhdGVkIGEgY29ubmVjdGlvbiBkdXJpbmcgZGlzY292ZXJ5IGFuZCB3ZSBnbyBvdmVyCiAgICAgICAgICAgIC8vIHRoZSBsaW1pdCAtIHRoYXRzIGFjY2VwdGFibGUgdG8gYXZvaWQgYSBjb21wbGV4aXR5IHNwaXJhbCBoZXJlLgogICAgICAgICAgICBpZiAoIXRoaXMuc3dhcm0uY29ubmVjdGlvbnMuaGFzKGlkKSkgbGltaXQtLQogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMuX29ucGVlcihwZWVyLCBkYXRhKQogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmICh0aGlzLl9pc0FjdGl2ZSgpKSB0aHJvdyBlcnIKICAgIH0gZmluYWxseSB7CiAgICAgIGlmICh0aGlzLl9hY3RpdmVRdWVyeSA9PT0gcXVlcnkpIHsKICAgICAgICB0aGlzLl9hY3RpdmVRdWVyeSA9IG51bGwKICAgICAgICBpZiAoIXRoaXMuZGVzdHJveWVkICYmICF0aGlzLnN1c3BlbmRlZCkgdGhpcy5fcmVmcmVzaExhdGVyKGZhbHNlKQogICAgICB9CiAgICB9CgogICAgLy8gVGhpcyBpcyBzZXQgYXQgdGhlIHZlcnkgZW5kLCB3aGVuIHRoZSBxdWVyeSBjb21wbGV0ZXMgc3VjY2Vzc2Z1bGx5LgogICAgdGhpcy5fY2xvc2VzdE5vZGVzID0gcXVlcnkuY2xvc2VzdE5vZGVzCgogICAgaWYgKGNsb2NrICE9PSB0aGlzLl9yZWZyZXNoZXMpIHJldHVybgoKICAgIC8vIEluIHRoaXMgaXMgdGhlIGxhdGVzdCBxdWVyeSwgdW5hbm5vdW5jZSBoYXMgYmVlbiBmdWxmaWxsZWQgYXMgd2VsbAogICAgaWYgKCFhbm5vdW5jaW5nKSB0aGlzLl9uZWVkc1VuYW5ub3VuY2UgPSBmYWxzZQogIH0KCiAgYXN5bmMgcmVmcmVzaCgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdQZWVyRGlzY292ZXJ5IGlzIGRlc3Ryb3llZCcpCgogICAgY29uc3Qgc2VydmVyID0gdGhpcy5fc2VydmVyU2Vzc2lvbnMgPiAwCiAgICBjb25zdCBjbGllbnQgPSB0aGlzLl9jbGllbnRTZXNzaW9ucyA+IDAKCiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIHJldHVybgoKICAgIGlmIChzZXJ2ZXIgPT09IHRoaXMuaXNTZXJ2ZXIgJiYgY2xpZW50ID09PSB0aGlzLmlzQ2xpZW50KSB7CiAgICAgIGlmICh0aGlzLl9jdXJyZW50UmVmcmVzaCkgcmV0dXJuIHRoaXMuX2N1cnJlbnRSZWZyZXNoCiAgICAgIHRoaXMuX2N1cnJlbnRSZWZyZXNoID0gdGhpcy5fcmVmcmVzaCgpCiAgICB9IGVsc2UgewogICAgICBpZiAodGhpcy5fYWN0aXZlUXVlcnkpIHRoaXMuX2FjdGl2ZVF1ZXJ5LmRlc3Ryb3koKQogICAgICB0aGlzLmlzU2VydmVyID0gc2VydmVyCiAgICAgIHRoaXMuaXNDbGllbnQgPSBjbGllbnQKICAgICAgdGhpcy5fY3VycmVudFJlZnJlc2ggPSB0aGlzLl9yZWZyZXNoKCkKICAgIH0KCiAgICBjb25zdCByZWZyZXNoID0gdGhpcy5fY3VycmVudFJlZnJlc2gKICAgIHRyeSB7CiAgICAgIGF3YWl0IHJlZnJlc2gKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gZmFsc2UKICAgIH0gZmluYWxseSB7CiAgICAgIGlmIChyZWZyZXNoID09PSB0aGlzLl9jdXJyZW50UmVmcmVzaCkgewogICAgICAgIHRoaXMuX2N1cnJlbnRSZWZyZXNoID0gbnVsbAogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIGZsdXNoZWQoKSB7CiAgICBpZiAodGhpcy5zd2FybS5saXN0ZW5pbmcpIGF3YWl0IHRoaXMuc3dhcm0ubGlzdGVuaW5nCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fY3VycmVudFJlZnJlc2gKICAgICAgcmV0dXJuIHRydWUKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICB9CgogIGFzeW5jIF9kZXN0cm95TWF5YmUoKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgoKICAgIHRyeSB7CiAgICAgIGlmICh0aGlzLl9zZXNzaW9ucy5sZW5ndGggPT09IDApIGF3YWl0IHRoaXMuc3dhcm0ubGVhdmUodGhpcy50b3BpYykKICAgICAgZWxzZSBpZiAodGhpcy5fc2VydmVyU2Vzc2lvbnMgPT09IDAgJiYgdGhpcy5fbmVlZHNVbmFubm91bmNlKSBhd2FpdCB0aGlzLnJlZnJlc2goKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIC8vIGlnbm9yZSBuZXR3b3JrIGZhaWx1cmVzIGhlcmUsIGFzIHdlIGFyZSB0ZWFyaW5nIGRvd24KICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgfQogIH0KCiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3lpbmcpIHJldHVybiB0aGlzLmRlc3Ryb3lpbmcKICAgIHRoaXMuZGVzdHJveWluZyA9IHRoaXMuX2Rlc3Ryb3koKQogICAgcmV0dXJuIHRoaXMuZGVzdHJveWluZwogIH0KCiAgYXN5bmMgX2Fib3J0KGxvZykgewogICAgY29uc3QgaWQgPSBsb2cgPT09IG5vb3AgPyAnJyA6IGI0YS50b1N0cmluZyh0aGlzLnRvcGljLCAnaGV4JykKCiAgICBsb2coJ0Fib3J0aW5nIGRpc2NvdmVyeScsIGlkKQogICAgaWYgKHRoaXMuX3dhaXQpIGF3YWl0IHRoaXMuX3dhaXQKICAgIGxvZygnQWJvcnRpbmcgZGlzY292ZXJ5IChwb3N0IHdhaXQpJywgaWQpCgogICAgaWYgKHRoaXMuX2FjdGl2ZVF1ZXJ5KSB7CiAgICAgIHRoaXMuX2FjdGl2ZVF1ZXJ5LmRlc3Ryb3koKQogICAgICB0aGlzLl9hY3RpdmVRdWVyeSA9IG51bGwKICAgIH0KICAgIGlmICh0aGlzLl90aW1lcikgewogICAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZXIpCiAgICAgIHRoaXMuX3RpbWVyID0gbnVsbAogICAgfQoKICAgIGxldCBub2RlcyA9IHRoaXMuX2Nsb3Nlc3ROb2RlcwoKICAgIGlmICh0aGlzLl9jdXJyZW50UmVmcmVzaCkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuX2N1cnJlbnRSZWZyZXNoCiAgICAgIH0gY2F0Y2ggewogICAgICAgIC8vIElmIHRoZSBkZXN0cm95IGNhdXNlcyB0aGUgcmVmcmVzaCB0byBmYWlsLCBzdXBwcmVzcyBpdC4KICAgICAgfQogICAgfQoKICAgIGxvZygnQWJvcnRpbmcgZGlzY292ZXJ5IChwb3N0IHJlZnJlc2gpJywgaWQpCiAgICBpZiAodGhpcy5faXNBY3RpdmUoKSkgcmV0dXJuCgogICAgaWYgKCFub2Rlcykgbm9kZXMgPSB0aGlzLl9jbG9zZXN0Tm9kZXMKICAgIGVsc2UgaWYgKHRoaXMuX2Nsb3Nlc3ROb2RlcyAhPT0gbm9kZXMpIHsKICAgICAgY29uc3QgbGVuID0gbm9kZXMubGVuZ3RoCiAgICAgIGZvciAoY29uc3QgbmV3ZXIgb2YgdGhpcy5fY2xvc2VzdE5vZGVzKSB7CiAgICAgICAgaWYgKG5ld2VyLmlkICYmICFoYXNOb2RlKG5vZGVzLCBsZW4sIG5ld2VyKSkgbm9kZXMucHVzaChuZXdlcikKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLl9uZWVkc1VuYW5ub3VuY2UpIHsKICAgICAgbG9nKCdVbmFubm91bmNpbmcgZGlzY292ZXJ5JywgaWQpCiAgICAgIGlmIChub2RlcyAmJiBub2Rlcy5sZW5ndGgpCiAgICAgICAgYXdhaXQgdGhpcy5zd2FybS5kaHQudW5hbm5vdW5jZSh0aGlzLnRvcGljLCB0aGlzLnN3YXJtLmtleVBhaXIsIHsKICAgICAgICAgIGNsb3Nlc3ROb2Rlczogbm9kZXMsCiAgICAgICAgICBvbmx5Q2xvc2VzdE5vZGVzOiB0cnVlLAogICAgICAgICAgZm9yY2U6IHRydWUKICAgICAgICB9KQogICAgICB0aGlzLl9uZWVkc1VuYW5ub3VuY2UgPSBmYWxzZQogICAgICBsb2coJ1VuYW5ub3VuY2luZyBkaXNjb3ZlcnkgKGRvbmUpJywgaWQpCiAgICB9CiAgfQoKICBfZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICAgIHJldHVybiB0aGlzLl9hYm9ydChub29wKQogIH0KCiAgYXN5bmMgc3VzcGVuZCh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIHJldHVybgogICAgdGhpcy5zdXNwZW5kZWQgPSB0cnVlCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9hYm9ydChsb2cpCiAgICB9IGNhdGNoIHsKICAgICAgLy8gaWdub3JlCiAgICB9CiAgfQoKICByZXN1bWUoKSB7CiAgICBpZiAoIXRoaXMuc3VzcGVuZGVkKSByZXR1cm4KICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKICAgIHRoaXMucmVmcmVzaCgpLmNhdGNoKG5vb3ApCiAgfQp9CgpjbGFzcyBQZWVyRGlzY292ZXJ5U2Vzc2lvbiB7CiAgY29uc3RydWN0b3IoZGlzY292ZXJ5KSB7CiAgICB0aGlzLmRpc2NvdmVyeSA9IGRpc2NvdmVyeQogICAgdGhpcy5pc0NsaWVudCA9IGZhbHNlCiAgICB0aGlzLmlzU2VydmVyID0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICB9CgogIGdldCBzd2FybSgpIHsKICAgIHJldHVybiB0aGlzLmRpc2NvdmVyeS5zd2FybQogIH0KCiAgZ2V0IHRvcGljKCkgewogICAgcmV0dXJuIHRoaXMuZGlzY292ZXJ5LnRvcGljCiAgfQoKICBhc3luYyByZWZyZXNoKHsgY2xpZW50ID0gdGhpcy5pc0NsaWVudCwgc2VydmVyID0gdGhpcy5pc1NlcnZlciwgbGltaXQgPSBJbmZpbml0eSB9ID0ge30pIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdQZWVyRGlzY292ZXJ5IGlzIGRlc3Ryb3llZCcpCiAgICBpZiAoIWNsaWVudCAmJiAhc2VydmVyKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCByZWZyZXNoIHdpdGggbmVpdGhlciBjbGllbnQgbm9yIHNlcnZlciBvcHRpb24nKQoKICAgIGlmIChjbGllbnQgIT09IHRoaXMuaXNDbGllbnQpIHsKICAgICAgdGhpcy5pc0NsaWVudCA9IGNsaWVudAogICAgICB0aGlzLmRpc2NvdmVyeS5fY2xpZW50U2Vzc2lvbnMgKz0gY2xpZW50ID8gMSA6IC0xCiAgICB9CgogICAgaWYgKHNlcnZlciAhPT0gdGhpcy5pc1NlcnZlcikgewogICAgICB0aGlzLmlzU2VydmVyID0gc2VydmVyCiAgICAgIHRoaXMuZGlzY292ZXJ5Ll9zZXJ2ZXJTZXNzaW9ucyArPSBzZXJ2ZXIgPyAxIDogLTEKICAgIH0KCiAgICB0aGlzLmRpc2NvdmVyeS5saW1pdCA9IGxpbWl0CgogICAgcmV0dXJuIHRoaXMuZGlzY292ZXJ5LnJlZnJlc2goKQogIH0KCiAgYXN5bmMgZmx1c2hlZCgpIHsKICAgIHJldHVybiB0aGlzLmRpc2NvdmVyeS5mbHVzaGVkKCkKICB9CgogIGFzeW5jIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCgogICAgaWYgKHRoaXMuaXNDbGllbnQpIHRoaXMuZGlzY292ZXJ5Ll9jbGllbnRTZXNzaW9ucy0tCiAgICBpZiAodGhpcy5pc1NlcnZlcikgdGhpcy5kaXNjb3ZlcnkuX3NlcnZlclNlc3Npb25zLS0KCiAgICBjb25zdCBpbmRleCA9IHRoaXMuZGlzY292ZXJ5Ll9zZXNzaW9ucy5pbmRleE9mKHRoaXMpCiAgICBjb25zdCBoZWFkID0gdGhpcy5kaXNjb3ZlcnkuX3Nlc3Npb25zLnBvcCgpCgogICAgaWYgKGhlYWQgIT09IHRoaXMpIHRoaXMuZGlzY292ZXJ5Ll9zZXNzaW9uc1tpbmRleF0gPSBoZWFkCgogICAgcmV0dXJuIHRoaXMuZGlzY292ZXJ5Ll9kZXN0cm95TWF5YmUoKQogIH0KfQoKZnVuY3Rpb24gaGFzTm9kZShub2RlcywgbGVuLCBub2RlKSB7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgY29uc3QgZXhpc3RpbmcgPSBub2Rlc1tpXQogICAgaWYgKGV4aXN0aW5nLmlkICYmIGI0YS5lcXVhbHMoZXhpc3RpbmcuaWQsIG5vZGUuaWQpKSByZXR1cm4gdHJ1ZQogIH0KCiAgcmV0dXJuIGZhbHNlCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCB7IEV2ZW50RW1pdHRlciB9ID0gcmVxdWlyZSgnZXZlbnRzJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKCmNvbnN0IE1JTl9DT05ORUNUSU9OX1RJTUUgPSAxNTAwMAoKY29uc3QgVkVSWV9MT1dfUFJJT1JJVFkgPSAwCmNvbnN0IExPV19QUklPUklUWSA9IDEKY29uc3QgTk9STUFMX1BSSU9SSVRZID0gMgpjb25zdCBISUdIX1BSSU9SSVRZID0gMwpjb25zdCBWRVJZX0hJR0hfUFJJT1JJVFkgPSA0Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFBlZXJJbmZvIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3Rvcih7IHB1YmxpY0tleSwgcmVsYXlBZGRyZXNzZXMgfSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMucHVibGljS2V5ID0gdW5zbGFiKHB1YmxpY0tleSkKICAgIHRoaXMucmVsYXlBZGRyZXNzZXMgPSByZWxheUFkZHJlc3NlcwoKICAgIHRoaXMucmVjb25uZWN0aW5nID0gdHJ1ZQogICAgdGhpcy5wcm92ZW4gPSBmYWxzZQogICAgdGhpcy5jb25uZWN0ZWRUaW1lID0gLTEKICAgIHRoaXMuZGlzY29ubmVjdGVkVGltZSA9IDAKICAgIHRoaXMuYmFubmVkID0gZmFsc2UKICAgIHRoaXMudHJpZWQgPSBmYWxzZQogICAgdGhpcy5leHBsaWNpdCA9IGZhbHNlCiAgICB0aGlzLndhaXRpbmcgPSBmYWxzZQogICAgdGhpcy5mb3JjZVJlbGF5aW5nID0gZmFsc2UKCiAgICAvLyBTZXQgYnkgdGhlIFN3YXJtCiAgICB0aGlzLnF1ZXVlZCA9IGZhbHNlCiAgICB0aGlzLmNsaWVudCA9IGZhbHNlCiAgICB0aGlzLnRvcGljcyA9IFtdIC8vIFRPRE86IHJlbW92ZSBvbiBuZXh0IG1ham9yIChjaGVjayB3aXRoIG1hZmludG9zaCBmb3IgY29udGV4dCkKCiAgICB0aGlzLmF0dGVtcHRzID0gMAogICAgdGhpcy5wcmlvcml0eSA9IE5PUk1BTF9QUklPUklUWQoKICAgIC8vIFVzZWQgYnkgc2h1ZmZsZWQtcHJpb3JpdHktcXVldWUKICAgIHRoaXMuX2luZGV4ID0gMAoKICAgIC8vIFVzZWQgZm9yIGZsdXNoIG1hbmFnZW1lbnQKICAgIHRoaXMuX2ZsdXNoVGljayA9IDAKCiAgICAvLyBVc2VkIGZvciB0b3BpYyBtdWx0aXBsZXhpbmcKICAgIHRoaXMuX3NlZW5Ub3BpY3MgPSBuZXcgU2V0KCkKICB9CgogIGdldCBzZXJ2ZXIoKSB7CiAgICByZXR1cm4gIXRoaXMuY2xpZW50CiAgfQoKICBnZXQgcHJpb3JpdGl6ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5wcmlvcml0eSA+PSBOT1JNQUxfUFJJT1JJVFkKICB9CgogIF9nZXRQcmlvcml0eSgpIHsKICAgIGNvbnN0IHBlZXJJc1N0YWxlID0gdGhpcy50cmllZCAmJiAhdGhpcy5wcm92ZW4KICAgIGlmIChwZWVySXNTdGFsZSB8fCB0aGlzLmF0dGVtcHRzID4gMykgcmV0dXJuIFZFUllfTE9XX1BSSU9SSVRZCiAgICBpZiAodGhpcy5hdHRlbXB0cyA9PT0gMykgcmV0dXJuIExPV19QUklPUklUWQogICAgaWYgKHRoaXMuYXR0ZW1wdHMgPT09IDIpIHJldHVybiBISUdIX1BSSU9SSVRZCiAgICBpZiAodGhpcy5hdHRlbXB0cyA9PT0gMSkgcmV0dXJuIFZFUllfSElHSF9QUklPUklUWQogICAgcmV0dXJuIE5PUk1BTF9QUklPUklUWQogIH0KCiAgX2Nvbm5lY3RlZCgpIHsKICAgIHRoaXMucHJvdmVuID0gdHJ1ZQogICAgdGhpcy5jb25uZWN0ZWRUaW1lID0gRGF0ZS5ub3coKQogIH0KCiAgX2Rpc2Nvbm5lY3RlZCgpIHsKICAgIHRoaXMuZGlzY29ubmVjdGVkVGltZSA9IERhdGUubm93KCkKICAgIGlmICh0aGlzLmNvbm5lY3RlZFRpbWUgPiAtMSkgewogICAgICBpZiAodGhpcy5kaXNjb25uZWN0ZWRUaW1lIC0gdGhpcy5jb25uZWN0ZWRUaW1lID49IE1JTl9DT05ORUNUSU9OX1RJTUUpIHRoaXMuYXR0ZW1wdHMgPSAwIC8vIGZhc3QgcmV0cnkKICAgICAgdGhpcy5jb25uZWN0ZWRUaW1lID0gLTEKICAgIH0KICAgIHRoaXMuYXR0ZW1wdHMrKwogIH0KCiAgX2RlcHJpb3JpdGl6ZSgpIHsKICAgIHRoaXMuYXR0ZW1wdHMgPSAzCiAgfQoKICBfcmVzZXQoKSB7CiAgICB0aGlzLmNsaWVudCA9IGZhbHNlCiAgICB0aGlzLnByb3ZlbiA9IGZhbHNlCiAgICB0aGlzLnRyaWVkID0gZmFsc2UKICAgIHRoaXMuYXR0ZW1wdHMgPSAwCiAgfQoKICBfdXBkYXRlUHJpb3JpdHkoKSB7CiAgICBpZiAodGhpcy5leHBsaWNpdCAmJiB0aGlzLmF0dGVtcHRzID4gMykgdGhpcy5fZGVwcmlvcml0aXplKCkKICAgIGlmICh0aGlzLmJhbm5lZCB8fCB0aGlzLnF1ZXVlZCB8fCB0aGlzLmF0dGVtcHRzID4gMykgcmV0dXJuIGZhbHNlCiAgICB0aGlzLnByaW9yaXR5ID0gdGhpcy5fZ2V0UHJpb3JpdHkoKQogICAgcmV0dXJuIHRydWUKICB9CgogIF90b3BpYyh0b3BpYykgewogICAgY29uc3QgdG9waWNTdHJpbmcgPSBiNGEudG9TdHJpbmcodG9waWMsICdoZXgnKQogICAgaWYgKHRoaXMuX3NlZW5Ub3BpY3MuaGFzKHRvcGljU3RyaW5nKSkgcmV0dXJuCiAgICB0aGlzLl9zZWVuVG9waWNzLmFkZCh0b3BpY1N0cmluZykKICAgIHRoaXMudG9waWNzLnB1c2godG9waWMpCiAgICB0aGlzLmVtaXQoJ3RvcGljJywgdG9waWMpCiAgfQoKICByZWNvbm5lY3QodmFsKSB7CiAgICB0aGlzLnJlY29ubmVjdGluZyA9ICEhdmFsCiAgfQoKICBiYW4odmFsKSB7CiAgICB0aGlzLmJhbm5lZCA9ICEhdmFsCiAgfQoKICBzaG91bGRHQygpIHsKICAgIHJldHVybiAhKHRoaXMuYmFubmVkIHx8IHRoaXMucXVldWVkIHx8IHRoaXMuZXhwbGljaXQgfHwgdGhpcy53YWl0aW5nKQogIH0KfQpjb25zdCBCdWxrVGltZXIgPSByZXF1aXJlKCcuL2J1bGstdGltZXInKQoKY29uc3QgQkFDS09GRl9KSVRURVIgPSA1MDAKY29uc3QgQkFDS09GRl9TID0gMTAwMCArIE1hdGgucm91bmQoQkFDS09GRl9KSVRURVIgKiBNYXRoLnJhbmRvbSgpKQpjb25zdCBCQUNLT0ZGX00gPSA1MDAwICsgTWF0aC5yb3VuZCgyICogQkFDS09GRl9KSVRURVIgKiBNYXRoLnJhbmRvbSgpKQpjb25zdCBCQUNLT0ZGX0wgPSAxNTAwMCArIE1hdGgucm91bmQoNCAqIEJBQ0tPRkZfSklUVEVSICogTWF0aC5yYW5kb20oKSkKY29uc3QgQkFDS09GRl9YID0gMTAwMCAqIDYwICogMTAgKyBNYXRoLnJvdW5kKDI0MCAqIEJBQ0tPRkZfSklUVEVSICogTWF0aC5yYW5kb20oKSkKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUmV0cnlUaW1lciB7CiAgY29uc3RydWN0b3IoCiAgICBwdXNoLAogICAgeyBiYWNrb2ZmcyA9IFtCQUNLT0ZGX1MsIEJBQ0tPRkZfTSwgQkFDS09GRl9MLCBCQUNLT0ZGX1hdLCBqaXR0ZXIgPSBCQUNLT0ZGX0pJVFRFUiB9ID0ge30KICApIHsKICAgIHRoaXMuaml0dGVyID0gaml0dGVyCiAgICB0aGlzLmJhY2tvZmZzID0gYmFja29mZnMKCiAgICB0aGlzLl9zVGltZXIgPSBuZXcgQnVsa1RpbWVyKGJhY2tvZmZzWzBdICsgTWF0aC5yb3VuZChqaXR0ZXIgKiBNYXRoLnJhbmRvbSgpKSwgcHVzaCkKICAgIHRoaXMuX21UaW1lciA9IG5ldyBCdWxrVGltZXIoYmFja29mZnNbMV0gKyBNYXRoLnJvdW5kKGppdHRlciAqIE1hdGgucmFuZG9tKCkpLCBwdXNoKQogICAgdGhpcy5fbFRpbWVyID0gbmV3IEJ1bGtUaW1lcihiYWNrb2Zmc1syXSArIE1hdGgucm91bmQoaml0dGVyICogTWF0aC5yYW5kb20oKSksIHB1c2gpCiAgICB0aGlzLl94VGltZXIgPSBuZXcgQnVsa1RpbWVyKGJhY2tvZmZzWzNdICsgTWF0aC5yb3VuZChqaXR0ZXIgKiBNYXRoLnJhbmRvbSgpKSwgcHVzaCkKICB9CgogIF9zZWxlY3RSZXRyeVRpbWVyKHBlZXJJbmZvKSB7CiAgICBpZiAocGVlckluZm8uYmFubmVkIHx8ICFwZWVySW5mby5yZWNvbm5lY3RpbmcpIHJldHVybiBudWxsCgogICAgaWYgKHBlZXJJbmZvLmF0dGVtcHRzID4gMykgewogICAgICByZXR1cm4gcGVlckluZm8uZXhwbGljaXQgPyB0aGlzLl94VGltZXIgOiBudWxsCiAgICB9CgogICAgaWYgKHBlZXJJbmZvLmF0dGVtcHRzID09PSAwKSByZXR1cm4gdGhpcy5fc1RpbWVyCiAgICBpZiAocGVlckluZm8ucHJvdmVuKSB7CiAgICAgIHN3aXRjaCAocGVlckluZm8uYXR0ZW1wdHMpIHsKICAgICAgICBjYXNlIDE6CiAgICAgICAgICByZXR1cm4gdGhpcy5fc1RpbWVyCiAgICAgICAgY2FzZSAyOgogICAgICAgICAgcmV0dXJuIHRoaXMuX21UaW1lcgogICAgICAgIGNhc2UgMzoKICAgICAgICAgIHJldHVybiB0aGlzLl9sVGltZXIKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgc3dpdGNoIChwZWVySW5mby5hdHRlbXB0cykgewogICAgICAgIGNhc2UgMToKICAgICAgICAgIHJldHVybiB0aGlzLl9tVGltZXIKICAgICAgICBjYXNlIDI6CiAgICAgICAgICByZXR1cm4gdGhpcy5fbFRpbWVyCiAgICAgICAgY2FzZSAzOgogICAgICAgICAgcmV0dXJuIHRoaXMuX2xUaW1lcgogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIGFkZChwZWVySW5mbykgewogICAgY29uc3QgdGltZXIgPSB0aGlzLl9zZWxlY3RSZXRyeVRpbWVyKHBlZXJJbmZvKQogICAgaWYgKCF0aW1lcikgcmV0dXJuIGZhbHNlCgogICAgdGltZXIuYWRkKHBlZXJJbmZvKQogICAgcmV0dXJuIHRydWUKICB9CgogIGRlc3Ryb3koKSB7CiAgICB0aGlzLl9zVGltZXIuZGVzdHJveSgpCiAgICB0aGlzLl9tVGltZXIuZGVzdHJveSgpCiAgICB0aGlzLl9sVGltZXIuZGVzdHJveSgpCiAgICB0aGlzLl94VGltZXIuZGVzdHJveSgpCiAgfQp9CnsKICAibmFtZSI6ICJoeXBlcnN3YXJtIiwKICAidmVyc2lvbiI6ICI0LjE2LjAiLAogICJkZXNjcmlwdGlvbiI6ICJBIGRpc3RyaWJ1dGVkIG5ldHdvcmtpbmcgc3RhY2sgZm9yIGNvbm5lY3RpbmcgcGVlcnMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibGliLyoqLmpzIgogIF0sCiAgImltcG9ydHMiOiB7CiAgICAiZXZlbnRzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWV2ZW50cyIsCiAgICAgICJkZWZhdWx0IjogImV2ZW50cyIKICAgIH0KICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjMuMSIsCiAgICAiYmFyZS1ldmVudHMiOiAiXjIuMi4wIiwKICAgICJoeXBlcmRodCI6ICJeNi4yMS4wIiwKICAgICJzYWZldHktY2F0Y2giOiAiXjEuMC4yIiwKICAgICJzaHVmZmxlZC1wcmlvcml0eS1xdWV1ZSI6ICJeMi4xLjAiLAogICAgInN0cmVhbXgiOiAiXjIuMjIuMSIsCiAgICAidW5zbGFiIjogIl4xLjMuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4wLjIiLAogICAgImh5cGVyY29yZS1jcnlwdG8iOiAiXjMuNC4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4iLAogICAgInRlc3QiOiAibm9kZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDpnZW5lcmF0ZSI6ICJicml0dGxlIC1yIHRlc3QvYWxsLmpzIHRlc3QvKi5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyc3dhcm0uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAiY29udHJpYnV0b3JzIjogWwogICAgIkRhdmlkIE1hcmsgQ2xlbWVudHMgKEBkYXZpZG1hcmtjbGVtKSIsCiAgICAiQW5kcmV3IE9zaGVyb2ZmIChAYW5kcmV3b3NoKSIKICBdLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcnN3YXJtL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJzd2FybSIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgRU1QVFkgPSBiNGEuYWxsb2MoMCkKY29uc3QgTUFYID0gYjRhLmZyb20oWzB4ZmZdKQpjb25zdCBCVUZGRVIgPSB7fQoKQlVGRkVSLnByZWVuY29kZSA9IGZ1bmN0aW9uIChzdGF0ZSwgYnVmKSB7CiAgaWYgKGJ1ZiA9PT0gbnVsbCkgYnVmID0gRU1QVFkKCiAgbGV0IGkgPSAwCiAgbGV0IGV4dHJhID0gMwoKICB3aGlsZSAoKGkgPSBiNGEuaW5kZXhPZihidWYsIDB4MDAsIGkpKSA+IC0xKSB7CiAgICBpKysKICAgIGV4dHJhKysKICB9CgogIHN0YXRlLmVuZCArPSBidWYuYnl0ZUxlbmd0aCArIGV4dHJhCn0KCkJVRkZFUi5lbmNvZGUgPSBmdW5jdGlvbiAoc3RhdGUsIGJ1ZikgewogIGlmIChidWYgPT09IG51bGwpIGJ1ZiA9IEVNUFRZCgogIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4MDAKCiAgbGV0IHByZXYgPSAwCiAgbGV0IGkgPSAwCgogIHdoaWxlICgoaSA9IGI0YS5pbmRleE9mKGJ1ZiwgMHgwMCwgaSkpID4gLTEpIHsKICAgIGNvbnN0IHNsaWNlID0gYnVmLnN1YmFycmF5KHByZXYsICsraSkKCiAgICBzdGF0ZS5idWZmZXIuc2V0KHNsaWNlLCBzdGF0ZS5zdGFydCkKICAgIHN0YXRlLnN0YXJ0ICs9IHNsaWNlLmJ5dGVMZW5ndGgKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4MDIKICAgIHByZXYgPSBpCiAgfQoKICBjb25zdCBzbGljZSA9IGJ1Zi5zdWJhcnJheShwcmV2KQoKICBzdGF0ZS5idWZmZXIuc2V0KHNsaWNlLCBzdGF0ZS5zdGFydCkKICBzdGF0ZS5zdGFydCArPSBzbGljZS5ieXRlTGVuZ3RoCgogIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4MDAKICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweDAxCn0KCkJVRkZFUi5kZWNvZGUgPSBmdW5jdGlvbiAoc3RhdGUpIHsKICBpZiAoc3RhdGUuc3RhcnQgPj0gc3RhdGUuZW5kKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogIGlmIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gIT09IDB4MDApIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzdGFydCBvZiBzdHJpbmcnKQoKICBsZXQgZXNjYXBlZCA9IG51bGwKCiAgbGV0IHByZXYgPSBzdGF0ZS5zdGFydAogIGxldCBpID0gc3RhdGUuc3RhcnQKCiAgd2hpbGUgKChpID0gYjRhLmluZGV4T2Yoc3RhdGUuYnVmZmVyLCAweDAwLCBpKSkgPiAtMSkgewogICAgY29uc3QgbmV4dCA9ICsraSA8IHN0YXRlLmVuZCA/IHN0YXRlLmJ1ZmZlcltpXSA6IDB4MDAKCiAgICBpKysKCiAgICBpZiAobmV4dCA9PT0gMHgwMSkgewogICAgICBicmVhawogICAgfQoKICAgIGlmIChuZXh0ID09PSAweDAyKSB7CiAgICAgIGlmIChlc2NhcGVkID09PSBudWxsKSBlc2NhcGVkID0gW10KICAgICAgZXNjYXBlZC5wdXNoKHN0YXRlLmJ1ZmZlci5zdWJhcnJheShwcmV2LCBpIC0gMSkpCiAgICAgIHByZXYgPSBpCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHZhbHVlIGluIHRlcm1pbmF0b3InKQogIH0KCiAgaWYgKGkgPT09IC0xKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHRlcm1pbmF0b3IgZm91bmQnKQogIH0KCiAgc3RhdGUuc3RhcnQgPSBpCiAgY29uc3QgbGFzdCA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShwcmV2LCBpIC0gMikKICBpZiAoZXNjYXBlZCA9PT0gbnVsbCkgcmV0dXJuIGxhc3QKCiAgZXNjYXBlZC5wdXNoKGxhc3QpCiAgcmV0dXJuIGI0YS5jb25jYXQoZXNjYXBlZCkKfQoKLy8gVE9ETzogY2FuIGJlIG9wdGltaXNlZCBhIGxvdAoKY29uc3QgU1RSSU5HID0ge30KClNUUklORy5wcmVlbmNvZGUgPSBmdW5jdGlvbiAoc3RhdGUsIHN0cikgewogIEJVRkZFUi5wcmVlbmNvZGUoc3RhdGUsIGI0YS5mcm9tKHN0ciB8fCAnJykpCn0KClNUUklORy5lbmNvZGUgPSBmdW5jdGlvbiAoc3RhdGUsIHN0cikgewogIEJVRkZFUi5lbmNvZGUoc3RhdGUsIGI0YS5mcm9tKHN0ciB8fCAnJykpCn0KClNUUklORy5kZWNvZGUgPSBmdW5jdGlvbiAoc3RhdGUsIHN0cikgewogIHJldHVybiBiNGEudG9TdHJpbmcoQlVGRkVSLmRlY29kZShzdGF0ZSkpCn0KCmNvbnN0IFVJTlQgPSB7fQoKVUlOVC5wcmVlbmNvZGUgPSBmdW5jdGlvbiAoc3RhdGUsIG4pIHsKICBzdGF0ZS5lbmQgKz0gbiA8PSAweGZiID8gMSA6IG4gPD0gMHhmZmZmID8gMyA6IG4gPD0gMHhmZmZmZmZmZiA/IDUgOiAobiA9PT0gSW5maW5pdHkgPyAxIDogOSkKfQoKVUlOVC5lbmNvZGUgPSBmdW5jdGlvbiAoc3RhdGUsIG4pIHsKICBpZiAobiA9PT0gSW5maW5pdHkpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4ZmYKICAgIHJldHVybgogIH0KCiAgaWYgKG4gPD0gMHhmYikgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgogICAgcmV0dXJuCiAgfQoKICBpZiAobiA8PSAweGZmZmYpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4ZmMKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDgKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KICAgIHJldHVybgogIH0KCiAgaWYgKG4gPD0gMHhmZmZmZmZmZikgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHhmZAogICAgZW5jb2RlVWludDMyKHN0YXRlLCBuKQogICAgcmV0dXJuCiAgfQoKICBpZiAoTnVtYmVyLmlzU2FmZUludGVnZXIobikpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4ZmUKCiAgICBjb25zdCByID0gTWF0aC5mbG9vcihuIC8gMHgxMDAwMDAwMDApCiAgICBlbmNvZGVVaW50MzIoc3RhdGUsIHIpCiAgICBlbmNvZGVVaW50MzIoc3RhdGUsIG4pCiAgICByZXR1cm4KICB9CgogIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBudW1iZXIgJyArIG4pCn0KClVJTlQuZGVjb2RlID0gZnVuY3Rpb24gKHN0YXRlKSB7CiAgaWYgKHN0YXRlLnN0YXJ0ID49IHN0YXRlLmVuZCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKCiAgY29uc3QgYSA9IHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQoKICBpZiAoYSA8PSAweGZiKSByZXR1cm4gYQoKICBpZiAoYSA9PT0gMHhmYykgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgMikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiAoCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgICApCiAgfQoKICBpZiAoYSA9PT0gMHhmZCkgewogICAgcmV0dXJuIGRlY29kZVVpbnQzMihzdGF0ZSkKICB9CgogIGlmIChhID09PSAweGZlKSB7CiAgICByZXR1cm4gKAogICAgICBkZWNvZGVVaW50MzIoc3RhdGUpICogMHgxMDAwMDAwMDAgKwogICAgICBkZWNvZGVVaW50MzIoc3RhdGUpCiAgICApCiAgfQoKICByZXR1cm4gSW5maW5pdHkKfQoKY29uc3QgQk9PTCA9IHt9CgpCT09MLnByZWVuY29kZSA9IChzdGF0ZSwgYikgPT4gVUlOVC5wcmVlbmNvZGUoc3RhdGUsIGIgPyAxIDogMCkKQk9PTC5lbmNvZGUgPSAoc3RhdGUsIGIpID0+IFVJTlQuZW5jb2RlKHN0YXRlLCBiID8gMSA6IDApCkJPT0wuZGVjb2RlID0gKHN0YXRlLCBiKSA9PiAhIVVJTlQuZGVjb2RlKHN0YXRlKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBJbmRleEVuY29kZXIgewogIGNvbnN0cnVjdG9yIChlbmNvZGluZ3MsIHsgcHJlZml4ID0gLTEgfSA9IHt9KSB7CiAgICB0aGlzLmVuY29kaW5ncyA9IGVuY29kaW5ncwogICAgdGhpcy5wcmVmaXggPSBwcmVmaXgKICB9CgogIHN0YXRpYyBCVUZGRVIgPSBCVUZGRVIKICBzdGF0aWMgU1RSSU5HID0gU1RSSU5HCiAgc3RhdGljIFVJTlQgPSBVSU5UCiAgc3RhdGljIEJPT0wgPSBCT09MCgogIHN0YXRpYyBsb29rdXAgKGMpIHsKICAgIHN3aXRjaCAoYykgewogICAgICBjYXNlICd1aW50JzogcmV0dXJuIFVJTlQKICAgICAgY2FzZSAndWludDgnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50MTYnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50MjQnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50MzInOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50NDAnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50NDgnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50NTYnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50NjQnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICdzdHJpbmcnOiByZXR1cm4gU1RSSU5HCiAgICAgIGNhc2UgJ3V0ZjgnOiByZXR1cm4gU1RSSU5HCiAgICAgIGNhc2UgJ2FzY2lpJzogcmV0dXJuIFNUUklORwogICAgICBjYXNlICdoZXgnOiByZXR1cm4gU1RSSU5HCiAgICAgIGNhc2UgJ2Jhc2U2NCc6IHJldHVybiBTVFJJTkcKICAgICAgY2FzZSAnZml4ZWQzMic6IHJldHVybiBCVUZGRVIKICAgICAgY2FzZSAnZml4ZWQ2NCc6IHJldHVybiBCVUZGRVIKICAgICAgY2FzZSAnYnVmZmVyJzogcmV0dXJuIEJVRkZFUgogICAgICBjYXNlICdib29sJzogcmV0dXJuIEJPT0wKICAgIH0KCiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gdHlwZScpCiAgfQoKICBlbmNvZGUgKGtleXMpIHsKICAgIHJldHVybiB0aGlzLl9lbmNvZGUoa2V5cywgZmFsc2UpCiAgfQoKICBfZW5jb2RlIChrZXlzLCB0ZXJtaW5hdGUpIHsKICAgIGlmIChiNGEuaXNCdWZmZXIoa2V5cykpIHJldHVybiBrZXlzCgogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDAsIGJ1ZmZlcjogbnVsbCB9CgogICAgaWYgKHRoaXMucHJlZml4ICE9PSAtMSkgVUlOVC5wcmVlbmNvZGUoc3RhdGUsIHRoaXMucHJlZml4KQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHRoaXMuZW5jb2RpbmdzW2ldLnByZWVuY29kZShzdGF0ZSwga2V5c1tpXSkKICAgIH0KCiAgICBpZiAodGVybWluYXRlICYmIGtleXMubGVuZ3RoIDwgdGhpcy5lbmNvZGluZ3MubGVuZ3RoKSB7CiAgICAgIHN0YXRlLmVuZCsrCiAgICB9CgogICAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHN0YXRlLmVuZCkKCiAgICBpZiAodGhpcy5wcmVmaXggIT09IC0xKSBVSU5ULmVuY29kZShzdGF0ZSwgdGhpcy5wcmVmaXgpCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgdGhpcy5lbmNvZGluZ3NbaV0uZW5jb2RlKHN0YXRlLCBrZXlzW2ldKQogICAgfQoKICAgIGlmICh0ZXJtaW5hdGUgJiYga2V5cy5sZW5ndGggPCB0aGlzLmVuY29kaW5ncy5sZW5ndGgpIHsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gTUFYWzBdCiAgICB9CgogICAgcmV0dXJuIHN0YXRlLmJ1ZmZlcgogIH0KCiAgZGVjb2RlIChidWZmZXIpIHsKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCwgYnVmZmVyIH0KICAgIGNvbnN0IHJlc3VsdCA9IFtdCgogICAgaWYgKHRoaXMucHJlZml4ICE9PSAtMSkgVUlOVC5kZWNvZGUoc3RhdGUpCiAgICBmb3IgKGNvbnN0IGVuYyBvZiB0aGlzLmVuY29kaW5ncykgewogICAgICBjb25zdCBrZXkgPSBzdGF0ZS5zdGFydCA8IHN0YXRlLmVuZCA/IGVuYy5kZWNvZGUoc3RhdGUpIDogKGVuYyA9PT0gVUlOVCA/IDAgOiBudWxsKQogICAgICByZXN1bHQucHVzaChrZXkpCiAgICB9CgogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgZW5jb2RlUmFuZ2UgKHsgZ3QsIGd0ZSwgbHQsIGx0ZSB9KSB7CiAgICBjb25zdCByYW5nZSA9IHsKICAgICAgZ3Q6IGd0ICYmIHRoaXMuX2VuY29kZShndCwgdHJ1ZSksCiAgICAgIGd0ZTogZ3RlICYmIHRoaXMuX2VuY29kZShndGUsIGZhbHNlKSwKICAgICAgbHQ6IGx0ICYmIHRoaXMuX2VuY29kZShsdCwgZmFsc2UpLAogICAgICBsdGU6IGx0ZSAmJiB0aGlzLl9lbmNvZGUobHRlLCB0cnVlKQogICAgfQoKICAgIGlmICh0aGlzLnByZWZpeCAhPT0gLTEpIHsKICAgICAgaWYgKCFndCAmJiAhZ3RlKSByYW5nZS5ndGUgPSBlbmNvZGVVaW50KHRoaXMucHJlZml4KQogICAgICBpZiAoIWx0ICYmICFsdGUpIHJhbmdlLmx0ID0gZW5jb2RlVWludCh0aGlzLnByZWZpeCArIDEpCiAgICB9CgogICAgcmV0dXJuIHJhbmdlCiAgfQp9CgpmdW5jdGlvbiBlbmNvZGVVaW50IChuKSB7CiAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDAsIGJ1ZmZlcjogbnVsbCB9CiAgVUlOVC5wcmVlbmNvZGUoc3RhdGUsIG4pCiAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHN0YXRlLmVuZCkKICBVSU5ULmVuY29kZShzdGF0ZSwgbikKICByZXR1cm4gc3RhdGUuYnVmZmVyCn0KCmZ1bmN0aW9uIGVuY29kZVVpbnQzMiAoc3RhdGUsIG4pIHsKICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuID4+PiAyNAogIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDE2CiAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gOAogIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KfQoKZnVuY3Rpb24gZGVjb2RlVWludDMyIChzdGF0ZSwgbikgewogIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDQpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgcmV0dXJuICgKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwMDAwMCArCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMDAwICsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwICsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogICkKfQp7CiAgIm5hbWUiOiAiaW5kZXgtZW5jb2RlciIsCiAgInZlcnNpb24iOiAiMy40LjAiLAogICJkZXNjcmlwdGlvbiI6ICJFbmNvZGUgbXVsdGlwbGUgdmFsdWVzIGludG8gc29ydGVkIGtleXMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjQiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMi4xIiwKICAgICJoeXBlcmJlZSI6ICJeMi4xMC41IiwKICAgICJoeXBlcmNvcmUiOiAiXjEwLjkuMiIsCiAgICAicmFuZG9tLWFjY2Vzcy1tZW1vcnkiOiAiXjYuMi4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9pbmRleC1lbmNvZGVyLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9pbmRleC1lbmNvZGVyL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaW5kZXgtZW5jb2RlciIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpc09wdGlvbnMgKG9wdHMpIHsKICByZXR1cm4gdHlwZW9mIG9wdHMgPT09ICdvYmplY3QnICYmIG9wdHMgJiYgIWI0YS5pc0J1ZmZlcihvcHRzKQp9CnsKICAibmFtZSI6ICJpcy1vcHRpb25zIiwKICAidmVyc2lvbiI6ICIxLjAuMiIsCiAgImRlc2NyaXB0aW9uIjogIkVhc2lseSBjaGVjayBpZiBpbnB1dCBpcyBhbiBvcHRpb25zIG1hcCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjEuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjExLjAuMSIsCiAgICAidGFwZSI6ICJeNC45LjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9pcy1vcHRpb25zLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9pcy1vcHRpb25zL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2lzLW9wdGlvbnMiCn0KY29uc3QgeyBFdmVudEVtaXR0ZXIgfSA9IHJlcXVpcmUoJ2V2ZW50cycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJvdXRpbmdUYWJsZSBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IgKGlkLCBvcHRzKSB7CiAgICBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICAgIHN1cGVyKCkKCiAgICB0aGlzLmlkID0gaWQKICAgIHRoaXMuayA9IG9wdHMuayB8fCAyMAogICAgdGhpcy5zaXplID0gMAogICAgdGhpcy5yb3dzID0gbmV3IEFycmF5KGlkLmxlbmd0aCAqIDgpCiAgfQoKICBhZGQgKG5vZGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLl9kaWZmKG5vZGUuaWQpCgogICAgbGV0IHJvdyA9IHRoaXMucm93c1tpXQoKICAgIGlmICghcm93KSB7CiAgICAgIHJvdyA9IHRoaXMucm93c1tpXSA9IG5ldyBSb3codGhpcywgaSkKICAgICAgdGhpcy5lbWl0KCdyb3cnLCByb3cpCiAgICB9CgogICAgY29uc3QgbGVuID0gcm93Lm5vZGVzLmxlbmd0aAogICAgaWYgKCFyb3cuYWRkKG5vZGUsIHRoaXMuaykpIHJldHVybiBmYWxzZQoKICAgIHRoaXMuc2l6ZSArPSByb3cubm9kZXMubGVuZ3RoIC0gbGVuCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgcmVtb3ZlIChpZCkgewogICAgY29uc3QgaSA9IHRoaXMuX2RpZmYoaWQpCiAgICBjb25zdCByb3cgPSB0aGlzLnJvd3NbaV0KICAgIGlmICghcm93KSByZXR1cm4gZmFsc2UKICAgIGlmICghcm93LnJlbW92ZShpZCkpIHJldHVybiBmYWxzZQogICAgdGhpcy5zaXplLS0KICAgIHJldHVybiB0cnVlCiAgfQoKICBnZXQgKGlkKSB7CiAgICBjb25zdCBpID0gdGhpcy5fZGlmZihpZCkKICAgIGNvbnN0IHJvdyA9IHRoaXMucm93c1tpXQogICAgaWYgKCFyb3cpIHJldHVybiBudWxsCiAgICByZXR1cm4gcm93LmdldChpZCkKICB9CgogIGhhcyAoaWQpIHsKICAgIHJldHVybiB0aGlzLmdldChpZCkgIT09IG51bGwKICB9CgogIHJhbmRvbSAoKSB7CiAgICBsZXQgbiA9IChNYXRoLnJhbmRvbSgpICogdGhpcy5zaXplKSB8IDAKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucm93cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCByID0gdGhpcy5yb3dzW2ldCiAgICAgIGlmICghcikgY29udGludWUKICAgICAgaWYgKG4gPCByLm5vZGVzLmxlbmd0aCkgcmV0dXJuIHIubm9kZXNbbl0KICAgICAgbiAtPSByLm5vZGVzLmxlbmd0aAogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBjbG9zZXN0IChpZCwgaykgewogICAgaWYgKCFrKSBrID0gdGhpcy5rCgogICAgY29uc3QgcmVzdWx0ID0gW10KICAgIGNvbnN0IGQgPSB0aGlzLl9kaWZmKGlkKQoKICAgIC8vIHB1c2ggY2xvc2Ugbm9kZXMKICAgIGZvciAobGV0IGkgPSBkOyBpID49IDAgJiYgcmVzdWx0Lmxlbmd0aCA8IGs7IGktLSkgdGhpcy5fcHVzaE5vZGVzKGksIGssIHJlc3VsdCkKCiAgICAvLyBpZiB3ZSBkb24ndCBoYXZlIGVub3VnaCBjbG9zZSBub2RlcywgcG9wdWxhdGUgZnJvbSBvdGhlciByb3dzLCByZSB0aGUgcGFwZXIKICAgIGZvciAobGV0IGkgPSBkICsgMTsgaSA8IHRoaXMucm93cy5sZW5ndGggJiYgcmVzdWx0Lmxlbmd0aCA8IGs7IGkrKykgdGhpcy5fcHVzaE5vZGVzKGksIGssIHJlc3VsdCkKCiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICBfcHVzaE5vZGVzIChpLCBrLCByZXN1bHQpIHsKICAgIGNvbnN0IHJvdyA9IHRoaXMucm93c1tpXQogICAgaWYgKCFyb3cpIHJldHVybgoKICAgIGNvbnN0IG1pc3NpbmcgPSBNYXRoLm1pbihrIC0gcmVzdWx0Lmxlbmd0aCwgcm93Lm5vZGVzLmxlbmd0aCkKICAgIGZvciAobGV0IGogPSAwOyBqIDwgbWlzc2luZzsgaisrKSByZXN1bHQucHVzaChyb3cubm9kZXNbal0pCiAgfQoKICB0b0FycmF5ICgpIHsKICAgIHJldHVybiB0aGlzLmNsb3Nlc3QodGhpcy5pZCwgSW5maW5pdHkpCiAgfQoKICBfZGlmZiAoaWQpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaWQubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYSA9IGlkW2ldCiAgICAgIGNvbnN0IGIgPSB0aGlzLmlkW2ldCgogICAgICBpZiAoYSAhPT0gYikgcmV0dXJuIGkgKiA4ICsgTWF0aC5jbHozMihhIF4gYikgLSAyNAogICAgfQoKICAgIHJldHVybiB0aGlzLnJvd3MubGVuZ3RoIC0gMQogIH0KfQoKY2xhc3MgUm93IGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvciAodGFibGUsIGluZGV4KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5kYXRhID0gbnVsbCAvLyBjYW4gYmUgdXNlZCBiZSB1cHN0cmVhbSBmb3Igd2hhdGV2cwogICAgdGhpcy5ieXRlT2Zmc2V0ID0gaW5kZXggPj4gMwogICAgdGhpcy5pbmRleCA9IGluZGV4CiAgICB0aGlzLnRhYmxlID0gdGFibGUKICAgIHRoaXMubm9kZXMgPSBbXQogIH0KCiAgYWRkIChub2RlKSB7CiAgICBjb25zdCBpZCA9IG5vZGUuaWQKCiAgICBsZXQgbCA9IDAKICAgIGxldCByID0gdGhpcy5ub2Rlcy5sZW5ndGggLSAxCgogICAgd2hpbGUgKGwgPD0gcikgewogICAgICBjb25zdCBtID0gKGwgKyByKSA+PiAxCiAgICAgIGNvbnN0IGMgPSB0aGlzLmNvbXBhcmUoaWQsIHRoaXMubm9kZXNbbV0uaWQpCgogICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgIHRoaXMubm9kZXNbbV0gPSBub2RlCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQoKICAgICAgaWYgKGMgPCAwKSByID0gbSAtIDEKICAgICAgZWxzZSBsID0gbSArIDEKICAgIH0KCiAgICBpZiAodGhpcy5ub2Rlcy5sZW5ndGggPj0gdGhpcy50YWJsZS5rKSB7CiAgICAgIHRoaXMuZW1pdCgnZnVsbCcsIG5vZGUpCiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIHRoaXMuaW5zZXJ0KGwsIG5vZGUpCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgcmVtb3ZlIChpZCkgewogICAgbGV0IGwgPSAwCiAgICBsZXQgciA9IHRoaXMubm9kZXMubGVuZ3RoIC0gMQoKICAgIHdoaWxlIChsIDw9IHIpIHsKICAgICAgY29uc3QgbSA9IChsICsgcikgPj4gMQogICAgICBjb25zdCBjID0gdGhpcy5jb21wYXJlKGlkLCB0aGlzLm5vZGVzW21dLmlkKQoKICAgICAgaWYgKGMgPT09IDApIHsKICAgICAgICB0aGlzLnNwbGljZShtKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KCiAgICAgIGlmIChjIDwgMCkgciA9IG0gLSAxCiAgICAgIGVsc2UgbCA9IG0gKyAxCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBnZXQgKGlkKSB7CiAgICBsZXQgbCA9IDAKICAgIGxldCByID0gdGhpcy5ub2Rlcy5sZW5ndGggLSAxCgogICAgd2hpbGUgKGwgPD0gcikgewogICAgICBjb25zdCBtID0gKGwgKyByKSA+PiAxCiAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGVzW21dCiAgICAgIGNvbnN0IGMgPSB0aGlzLmNvbXBhcmUoaWQsIG5vZGUuaWQpCgogICAgICBpZiAoYyA9PT0gMCkgcmV0dXJuIG5vZGUKICAgICAgaWYgKGMgPCAwKSByID0gbSAtIDEKICAgICAgZWxzZSBsID0gbSArIDEKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgaW5zZXJ0IChpLCBub2RlKSB7CiAgICB0aGlzLm5vZGVzLnB1c2gobm9kZSkgLy8gcHVzaCBub2RlIG9yIG51bGwgb3Igd2hhdGV2cywganVzdCB0cnlpbmcgdG8gbm90IGJlIHBvbHltb3JwaGljCiAgICBmb3IgKGxldCBqID0gdGhpcy5ub2Rlcy5sZW5ndGggLSAxOyBqID4gaTsgai0tKSB0aGlzLm5vZGVzW2pdID0gdGhpcy5ub2Rlc1tqIC0gMV0KICAgIHRoaXMubm9kZXNbaV0gPSBub2RlCiAgICB0aGlzLmVtaXQoJ2FkZCcsIG5vZGUpCiAgfQoKICBzcGxpY2UgKGkpIHsKICAgIGZvciAoOyBpIDwgdGhpcy5ub2Rlcy5sZW5ndGggLSAxOyBpKyspIHRoaXMubm9kZXNbaV0gPSB0aGlzLm5vZGVzW2kgKyAxXQogICAgdGhpcy5lbWl0KCdyZW1vdmUnLCB0aGlzLm5vZGVzLnBvcCgpKQogIH0KCiAgLy8gdmVyeSBsaWtlbHkgdGhleSBkaXZlcmdlIGFmdGVyIGEgY291cGxlIG9mIGJ5dGVzIHNvIGEgc2ltcGxlIGltcGwsIGxpa2UgdGhpcyBpcyBwcm9wIGZhc3Rlc3QgdnMgQnVmZmVyLmNvbXBhcmUKICBjb21wYXJlIChhLCBiKSB7CiAgICBmb3IgKGxldCBpID0gdGhpcy5ieXRlT2Zmc2V0OyBpIDwgYS5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBhaSA9IGFbaV0KICAgICAgY29uc3QgYmkgPSBiW2ldCiAgICAgIGlmIChhaSA9PT0gYmkpIGNvbnRpbnVlCiAgICAgIHJldHVybiBhaSA8IGJpID8gLTEgOiAxCiAgICB9CiAgICByZXR1cm4gMAogIH0KfQp7CiAgIm5hbWUiOiAia2FkZW1saWEtcm91dGluZy10YWJsZSIsCiAgInZlcnNpb24iOiAiMS4wLjYiLAogICJkZXNjcmlwdGlvbiI6ICJYT1IgYmFzZWQgcm91dGluZyB0YWJsZSB1c2VkIGZvciBQMlAgbmV0d29ya3Mgc3VjaCBhcyBhIEthZGVtbGlhIERIVC4iLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiaW1wb3J0cyI6IHsKICAgICJldmVudHMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZXZlbnRzIiwKICAgICAgImRlZmF1bHQiOiAiZXZlbnRzIgogICAgfQogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWV2ZW50cyI6ICJeMi4yLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMy4yIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAia2V5d29yZHMiOiBbCiAgICAia2FkZW1saWEiLAogICAgInAycCIsCiAgICAiay1idWNrZXQiLAogICAgImstYnVja2V0cyIsCiAgICAieG9yIiwKICAgICJyb3V0aW5nIiwKICAgICJkaXN0cmlidXRlZCIsCiAgICAic3lzdGVtcyIKICBdLAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2thZGVtbGlhLXJvdXRpbmctdGFibGUiCn0KdmFyIHF1ZXVlVGljayA9IHJlcXVpcmUoJ3F1ZXVlLXRpY2snKQoKdmFyIG11dGV4aWZ5ID0gZnVuY3Rpb24gKCkgewogIHZhciBxdWV1ZSA9IFtdCiAgdmFyIHVzZWQgPSBudWxsCgogIHZhciBjYWxsID0gZnVuY3Rpb24gKCkgewogICAgdXNlZChyZWxlYXNlKQogIH0KCiAgdmFyIGFjcXVpcmUgPSBmdW5jdGlvbiAoZm4pIHsKICAgIGlmICh1c2VkKSByZXR1cm4gcXVldWUucHVzaChmbikKICAgIHVzZWQgPSBmbgogICAgYWNxdWlyZS5sb2NrZWQgPSB0cnVlCiAgICBxdWV1ZVRpY2soY2FsbCkKICAgIHJldHVybiAwCiAgfQoKICBhY3F1aXJlLmxvY2tlZCA9IGZhbHNlCgogIHZhciByZWxlYXNlID0gZnVuY3Rpb24gKGZuLCBlcnIsIHZhbHVlKSB7CiAgICB1c2VkID0gbnVsbAogICAgYWNxdWlyZS5sb2NrZWQgPSBmYWxzZQogICAgaWYgKHF1ZXVlLmxlbmd0aCkgYWNxdWlyZShxdWV1ZS5zaGlmdCgpKQogICAgaWYgKGZuKSBmbihlcnIsIHZhbHVlKQogIH0KCiAgcmV0dXJuIGFjcXVpcmUKfQoKbW9kdWxlLmV4cG9ydHMgPSBtdXRleGlmeQp7CiAgIm5hbWUiOiAibXV0ZXhpZnkiLAogICJ2ZXJzaW9uIjogIjEuNC4wIiwKICAiZGVzY3JpcHRpb24iOiAibXV0ZXggbG9jayBmb3IgamF2YXNjcmlwdCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAicXVldWUtdGljayI6ICJeMS4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xNC4zLjMiLAogICAgInRhcGUiOiAiXjMuMC4yIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJ0YXBlIHRlc3QuanMiLAogICAgInBvc3R0ZXN0IjogIm5wbSBydW4gbGludCIsCiAgICAibGludCI6ICJzdGFuZGFyZCIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9tdXRleGlmeS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvbXV0ZXhpZnkvaXNzdWVzIgogIH0sCiAgImtleXdvcmRzIjogWwogICAgIm11dGV4IiwKICAgICJsb2NrIgogIF0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvbXV0ZXhpZnkiCn0KdmFyIG11dGV4aWZ5ID0gcmVxdWlyZSgnLicpCgp2YXIgbXV0ZXhpZnlQcm9taXNlID0gZnVuY3Rpb24gKCkgewogIHZhciBsb2NrID0gbXV0ZXhpZnkoKQoKICB2YXIgYWNxdWlyZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShsb2NrKQogIH0KCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGFjcXVpcmUsICdsb2NrZWQnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGxvY2subG9ja2VkIH0sCiAgICBlbnVtZXJhYmxlOiB0cnVlCiAgfSkKCiAgcmV0dXJuIGFjcXVpcmUKfQoKbW9kdWxlLmV4cG9ydHMgPSBtdXRleGlmeVByb21pc2UKbW9kdWxlLmV4cG9ydHMgPSBhc3NlcnQKCmNsYXNzIEFzc2VydGlvbkVycm9yIGV4dGVuZHMgRXJyb3Ige30KQXNzZXJ0aW9uRXJyb3IucHJvdG90eXBlLm5hbWUgPSAnQXNzZXJ0aW9uRXJyb3InCgovKioKICogTWluaW1hbCBhc3NlcnQgZnVuY3Rpb24KICogQHBhcmFtICB7YW55fSB0IFZhbHVlIHRvIGNoZWNrIGlmIGZhbHN5CiAqIEBwYXJhbSAge3N0cmluZz19IG0gT3B0aW9uYWwgYXNzZXJ0aW9uIGVycm9yIG1lc3NhZ2UKICogQHRocm93cyB7QXNzZXJ0aW9uRXJyb3J9CiAqLwpmdW5jdGlvbiBhc3NlcnQgKHQsIG0pIHsKICBpZiAoIXQpIHsKICAgIHZhciBlcnIgPSBuZXcgQXNzZXJ0aW9uRXJyb3IobSkKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UoZXJyLCBhc3NlcnQpCiAgICB0aHJvdyBlcnIKICB9Cn0KewogICJuYW1lIjogIm5hbm9hc3NlcnQiLAogICJ2ZXJzaW9uIjogIjIuMC4wIiwKICAiZGVzY3JpcHRpb24iOiAiTmFub3NjYWxlIGFzc2VydGlvbiBtb2R1bGUiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJ0YXBlIjogIl40LjkuMSIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAidGFwZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2VtaWxiYXllcy9uYW5vYXNzZXJ0LmdpdCIKICB9LAogICJrZXl3b3JkcyI6IFsKICAgICJhc3NlcnQiLAogICAgInVuYXNzZXJ0IiwKICAgICJwb3dlci1hc3NlcnQiLAogICAgInRpbnkiLAogICAgIm5hbm8iLAogICAgInBpY28iCiAgXSwKICAiYXV0aG9yIjogIkVtaWwgQmF5IDxnaXRodWJAdGl4ei5kaz4iLAogICJsaWNlbnNlIjogIklTQyIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9lbWlsYmF5ZXMvbmFub2Fzc2VydC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2VtaWxiYXllcy9uYW5vYXNzZXJ0I3JlYWRtZSIKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIE5hdFNhbXBsZXIgewogIGNvbnN0cnVjdG9yICgpIHsKICAgIHRoaXMuaG9zdCA9IG51bGwKICAgIHRoaXMucG9ydCA9IDAKICAgIHRoaXMuc2l6ZSA9IDAKCiAgICB0aGlzLl9hID0gbnVsbAogICAgdGhpcy5fYiA9IG51bGwKICAgIHRoaXMuX3RocmVzaG9sZCA9IDAKICAgIHRoaXMuX3RvcCA9IDAKICAgIHRoaXMuX3NhbXBsZXMgPSBbXQogIH0KCiAgYWRkIChob3N0LCBwb3J0KSB7CiAgICBjb25zdCBhID0gdGhpcy5fYnVtcChob3N0LCBwb3J0LCAyKQogICAgY29uc3QgYiA9IHRoaXMuX2J1bXAoaG9zdCwgMCwgMSkKCiAgICBpZiAodGhpcy5fc2FtcGxlcy5sZW5ndGggPCAzMikgewogICAgICB0aGlzLnNpemUrKwogICAgICB0aGlzLl90aHJlc2hvbGQgPSB0aGlzLnNpemUgLSAodGhpcy5zaXplIDwgNCA/IDAgOiB0aGlzLnNpemUgPCA4ID8gMSA6IHRoaXMuc2l6ZSA8IDEyID8gMiA6IDMpCiAgICAgIHRoaXMuX3NhbXBsZXMucHVzaChhLCBiKQogICAgICB0aGlzLl90b3AgKz0gMgogICAgfSBlbHNlIHsKICAgICAgaWYgKHRoaXMuX3RvcCA9PT0gMzIpIHRoaXMuX3RvcCA9IDAKCiAgICAgIGNvbnN0IG9hID0gdGhpcy5fc2FtcGxlc1t0aGlzLl90b3BdCiAgICAgIHRoaXMuX3NhbXBsZXNbdGhpcy5fdG9wKytdID0gYQogICAgICBvYS5oaXRzLS0KCiAgICAgIGNvbnN0IG9iID0gdGhpcy5fc2FtcGxlc1t0aGlzLl90b3BdCiAgICAgIHRoaXMuX3NhbXBsZXNbdGhpcy5fdG9wKytdID0gYgogICAgICBvYi5oaXRzLS0KICAgIH0KCiAgICBpZiAodGhpcy5fYSA9PT0gbnVsbCB8fCB0aGlzLl9hLmhpdHMgPCBhLmhpdHMpIHRoaXMuX2EgPSBhCiAgICBpZiAodGhpcy5fYiA9PT0gbnVsbCB8fCB0aGlzLl9iLmhpdHMgPCBiLmhpdHMpIHRoaXMuX2IgPSBiCgogICAgaWYgKHRoaXMuX2EuaGl0cyA+PSB0aGlzLl90aHJlc2hvbGQpIHsKICAgICAgdGhpcy5ob3N0ID0gdGhpcy5fYS5ob3N0CiAgICAgIHRoaXMucG9ydCA9IHRoaXMuX2EucG9ydAogICAgfSBlbHNlIGlmICh0aGlzLl9iLmhpdHMgPj0gdGhpcy5fdGhyZXNob2xkKSB7CiAgICAgIHRoaXMuaG9zdCA9IHRoaXMuX2IuaG9zdAogICAgICB0aGlzLnBvcnQgPSAwCiAgICB9IGVsc2UgewogICAgICB0aGlzLmhvc3QgPSBudWxsCiAgICAgIHRoaXMucG9ydCA9IDAKICAgIH0KCiAgICByZXR1cm4gYS5oaXRzCiAgfQoKICBfYnVtcCAoaG9zdCwgcG9ydCwgaW5jKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykgewogICAgICBjb25zdCBqID0gKHRoaXMuX3RvcCAtIGluYyAtICgyICogaSkpICYgMzEKICAgICAgaWYgKGogPj0gdGhpcy5fc2FtcGxlcy5sZW5ndGgpIHJldHVybiB7IGhvc3QsIHBvcnQsIGhpdHM6IDEgfQogICAgICBjb25zdCBzID0gdGhpcy5fc2FtcGxlc1tqXQogICAgICBpZiAocy5wb3J0ID09PSBwb3J0ICYmIHMuaG9zdCA9PT0gaG9zdCkgewogICAgICAgIHMuaGl0cysrCiAgICAgICAgcmV0dXJuIHMKICAgICAgfQogICAgfQogICAgcmV0dXJuIHsgaG9zdCwgcG9ydCwgaGl0czogMSB9CiAgfQp9CnsKICAibmFtZSI6ICJuYXQtc2FtcGxlciIsCiAgInZlcnNpb24iOiAiMS4wLjEiLAogICJkZXNjcmlwdGlvbiI6ICJTYW1wbGUgYWRkcmVzc2VzIHRvIGZpZ3VyZSBvdXQgaWYgYSBob3N0ICsgcG9ydCBpcyBjb25zaXN0ZW50IiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE2LjAuMyIsCiAgICAidGFwZSI6ICJeNS4yLjIiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvbmF0LXNhbXBsZXIuZ2l0IgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiB0YXBlIHRlc3QuanMiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvbmF0LXNhbXBsZXIvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvbmF0LXNhbXBsZXIiCn0KLyogZXNsaW50LWRpc2FibGUgY2FtZWxjYXNlICovCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBhc3NlcnQgPSByZXF1aXJlKCduYW5vYXNzZXJ0JykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IERITEVOID0gc29kaXVtLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfQllURVMKY29uc3QgUEtMRU4gPSBzb2RpdW0uY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9CWVRFUwpjb25zdCBTQ0FMQVJMRU4gPSBzb2RpdW0uY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9CWVRFUwpjb25zdCBTS0xFTiA9IHNvZGl1bS5jcnlwdG9fc2lnbl9TRUNSRVRLRVlCWVRFUwpjb25zdCBBTEcgPSAnRWQyNTUxOScKCm1vZHVsZS5leHBvcnRzID0gewogIERITEVOLAogIFBLTEVOLAogIFNDQUxBUkxFTiwKICBTS0xFTiwKICBBTEcsCiAgbmFtZTogQUxHLAogIGdlbmVyYXRlS2V5UGFpciwKICBkaAp9CgpmdW5jdGlvbiBnZW5lcmF0ZUtleVBhaXIgKHByaXZLZXkpIHsKICBpZiAocHJpdktleSkgcmV0dXJuIGdlbmVyYXRlU2VlZEtleVBhaXIocHJpdktleS5zdWJhcnJheSgwLCAzMikpCgogIGNvbnN0IGtleVBhaXIgPSB7fQogIGtleVBhaXIuc2VjcmV0S2V5ID0gYjRhLmFsbG9jKFNLTEVOKQogIGtleVBhaXIucHVibGljS2V5ID0gYjRhLmFsbG9jKFBLTEVOKQoKICBzb2RpdW0uY3J5cHRvX3NpZ25fa2V5cGFpcihrZXlQYWlyLnB1YmxpY0tleSwga2V5UGFpci5zZWNyZXRLZXkpCiAgcmV0dXJuIGtleVBhaXIKfQoKZnVuY3Rpb24gZ2VuZXJhdGVTZWVkS2V5UGFpciAoc2VlZCkgewogIGNvbnN0IGtleVBhaXIgPSB7fQogIGtleVBhaXIuc2VjcmV0S2V5ID0gYjRhLmFsbG9jKFNLTEVOKQogIGtleVBhaXIucHVibGljS2V5ID0gYjRhLmFsbG9jKFBLTEVOKQoKICBzb2RpdW0uY3J5cHRvX3NpZ25fc2VlZF9rZXlwYWlyKGtleVBhaXIucHVibGljS2V5LCBrZXlQYWlyLnNlY3JldEtleSwgc2VlZCkKICByZXR1cm4ga2V5UGFpcgp9CgpmdW5jdGlvbiBkaCAocHVibGljS2V5LCB7IHNjYWxhciwgc2VjcmV0S2V5IH0pIHsKICAvLyB0d2Vha2VkIGtleXMgZXhwb3NlIHNjYWxhciBkaXJlY3RseQogIGlmICghc2NhbGFyKSB7CiAgICBhc3NlcnQoc2VjcmV0S2V5LmJ5dGVMZW5ndGggPT09IFNLTEVOKQoKICAgIC8vIGxpYnNvZGl1bSBzdG9yZXMgc2VlZCBub3QgYWN0dWFsIHNjYWxhcgogICAgY29uc3Qgc2sgPSBiNGEuYWxsb2MoNjQpCiAgICBzb2RpdW0uY3J5cHRvX2hhc2hfc2hhNTEyKHNrLCBzZWNyZXRLZXkuc3ViYXJyYXkoMCwgMzIpKQogICAgc2tbMF0gJj0gMjQ4CiAgICBza1szMV0gJj0gMTI3CiAgICBza1szMV0gfD0gNjQKCiAgICBzY2FsYXIgPSBzay5zdWJhcnJheSgwLCAzMikKICB9CgogIGFzc2VydChzY2FsYXIuYnl0ZUxlbmd0aCA9PT0gU0NBTEFSTEVOKQogIGFzc2VydChwdWJsaWNLZXkuYnl0ZUxlbmd0aCA9PT0gUEtMRU4pCgogIGNvbnN0IG91dHB1dCA9IGI0YS5hbGxvYyhESExFTikKCiAgLy8gd2UgY2xhbXAgaWYgbmVjZXNzYXJ5IGFib3ZlCiAgc29kaXVtLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfbm9jbGFtcCgKICAgIG91dHB1dCwKICAgIHNjYWxhciwKICAgIHB1YmxpY0tleQogICkKCiAgcmV0dXJuIG91dHB1dAp9CnsKICAibmFtZSI6ICJub2lzZS1jdXJ2ZS1lZCIsCiAgInZlcnNpb24iOiAiMi4xLjAiLAogICJkZXNjcmlwdGlvbiI6ICJFZDI1NTE5IGVsbGlwdGljIGN1cnZlIG9wZXJhdGlvbnMgZm9yIFtgbm9pc2UtaGFuZHNoYWtlYF0oaHR0cHM6Ly9naXRodWIuY29tL2NobS1kaWVkZXJpY2hzL25vaXNlLWhhbmRzaGFrZSkiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogIm5weCBzdGFuZGFyZCAmJiB0YXBlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vY2htLWRpZWRlcmljaHMvbm9pc2UtY3VydmUtZWQuZ2l0IgogIH0sCiAgImtleXdvcmRzIjogW10sCiAgImF1dGhvciI6ICIiLAogICJsaWNlbnNlIjogIklTQyIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9jaG0tZGllZGVyaWNocy9ub2lzZS1jdXJ2ZS1lZC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2NobS1kaWVkZXJpY2hzL25vaXNlLWN1cnZlLWVkI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuMS4wIiwKICAgICJuYW5vYXNzZXJ0IjogIl4yLjAuMCIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgIm5vaXNlLWhhbmRzaGFrZSI6ICJeMy4wLjAiLAogICAgInN0YW5kYXJkIjogIl4xNi4wLjMiLAogICAgInRhcGUiOiAiXjUuMi4yIgogIH0KfQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ2lwaGVyU3RhdGUgewogIGNvbnN0cnVjdG9yIChrZXkpIHsKICAgIHRoaXMua2V5ID0ga2V5IHx8IG51bGwKICAgIHRoaXMubm9uY2UgPSAwCiAgICB0aGlzLkNJUEhFUl9BTEcgPSAnQ2hhQ2hhUG9seScKICB9CgogIGluaXRpYWxpc2VLZXkgKGtleSkgewogICAgdGhpcy5rZXkgPSBrZXkKICAgIHRoaXMubm9uY2UgPSAwCiAgfQoKICBzZXROb25jZSAobm9uY2UpIHsKICAgIHRoaXMubm9uY2UgPSBub25jZQogIH0KCiAgZW5jcnlwdCAocGxhaW50ZXh0LCBhZCkgewogICAgaWYgKCF0aGlzLmhhc0tleSkgcmV0dXJuIHBsYWludGV4dAogICAgaWYgKCFhZCkgYWQgPSBiNGEuYWxsb2MoMCkKCiAgICBjb25zdCBjaXBoZXJ0ZXh0ID0gZW5jcnlwdFdpdGhBRCh0aGlzLmtleSwgdGhpcy5ub25jZSwgYWQsIHBsYWludGV4dCkKICAgIGlmIChjaXBoZXJ0ZXh0Lmxlbmd0aCA+IDY1NTM1KSB0aHJvdyBuZXcgRXJyb3IoYGNpcGhlcnRleHQgbGVuZ3RoIG9mICR7Y2lwaGVydGV4dC5sZW5ndGh9IGV4Y2VlZHMgbWF4aW11bSBOb2lzZSBtZXNzYWdlIGxlbmd0aCBvZiA2NTUzNWApCiAgICB0aGlzLm5vbmNlKysKCiAgICByZXR1cm4gY2lwaGVydGV4dAogIH0KCiAgZGVjcnlwdCAoY2lwaGVydGV4dCwgYWQpIHsKICAgIGlmICghdGhpcy5oYXNLZXkpIHJldHVybiBjaXBoZXJ0ZXh0CiAgICBpZiAoIWFkKSBhZCA9IGI0YS5hbGxvYygwKQogICAgaWYgKGNpcGhlcnRleHQubGVuZ3RoID4gNjU1MzUpIHRocm93IG5ldyBFcnJvcihgY2lwaGVydGV4dCBsZW5ndGggb2YgJHtjaXBoZXJ0ZXh0Lmxlbmd0aH0gZXhjZWVkcyBtYXhpbXVtIE5vaXNlIG1lc3NhZ2UgbGVuZ3RoIG9mIDY1NTM1YCkKCiAgICBjb25zdCBwbGFpbnRleHQgPSBkZWNyeXB0V2l0aEFEKHRoaXMua2V5LCB0aGlzLm5vbmNlLCBhZCwgY2lwaGVydGV4dCkKICAgIHRoaXMubm9uY2UrKwoKICAgIHJldHVybiBwbGFpbnRleHQKICB9CgogIGdldCBoYXNLZXkgKCkgewogICAgcmV0dXJuIHRoaXMua2V5ICE9PSBudWxsCiAgfQoKICBfY2xlYXIgKCkgewogICAgc29kaXVtLnNvZGl1bV9tZW16ZXJvKHRoaXMua2V5KQogICAgdGhpcy5rZXkgPSBudWxsCiAgICB0aGlzLm5vbmNlID0gbnVsbAogIH0KCiAgc3RhdGljIGdldCBNQUNCWVRFUyAoKSB7CiAgICByZXR1cm4gMTYKICB9CgogIHN0YXRpYyBnZXQgTk9OQ0VCWVRFUyAoKSB7CiAgICByZXR1cm4gOAogIH0KCiAgc3RhdGljIGdldCBLRVlCWVRFUyAoKSB7CiAgICByZXR1cm4gMzIKICB9Cn0KCmZ1bmN0aW9uIGVuY3J5cHRXaXRoQUQgKGtleSwgY291bnRlciwgYWRkaXRpb25hbERhdGEsIHBsYWludGV4dCkgewogIC8vIGZvciBvdXIgcHVycG9zZXMsIGFkZGl0aW9uYWxEYXRhIHdpbGwgYWx3YXlzIGJlIGEgcHVia2V5IHNvIHdlIGVuY29kZSBmcm9tIGhleAogIGlmICghYjRhLmlzQnVmZmVyKGFkZGl0aW9uYWxEYXRhKSkgYWRkaXRpb25hbERhdGEgPSBiNGEuZnJvbShhZGRpdGlvbmFsRGF0YSwgJ2hleCcpCiAgaWYgKCFiNGEuaXNCdWZmZXIocGxhaW50ZXh0KSkgcGxhaW50ZXh0ID0gYjRhLmZyb20ocGxhaW50ZXh0LCAnaGV4JykKCiAgY29uc3Qgbm9uY2UgPSBiNGEuYWxsb2Moc29kaXVtLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhub25jZS5idWZmZXIsIG5vbmNlLmJ5dGVPZmZzZXQsIG5vbmNlLmJ5dGVMZW5ndGgpCiAgdmlldy5zZXRVaW50MzIoNCwgY291bnRlciwgdHJ1ZSkKCiAgY29uc3QgY2lwaGVydGV4dCA9IGI0YS5hbGxvYyhwbGFpbnRleHQuYnl0ZUxlbmd0aCArIHNvZGl1bS5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTKQoKICBzb2RpdW0uY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2VuY3J5cHQoY2lwaGVydGV4dCwgcGxhaW50ZXh0LCBhZGRpdGlvbmFsRGF0YSwgbnVsbCwgbm9uY2UsIGtleSkKICByZXR1cm4gY2lwaGVydGV4dAp9CgpmdW5jdGlvbiBkZWNyeXB0V2l0aEFEIChrZXksIGNvdW50ZXIsIGFkZGl0aW9uYWxEYXRhLCBjaXBoZXJ0ZXh0KSB7CiAgLy8gZm9yIG91ciBwdXJwb3NlcywgYWRkaXRpb25hbERhdGEgd2lsbCBhbHdheXMgYmUgYSBwdWJrZXkgc28gd2UgZW5jb2RlIGZyb20gaGV4CiAgaWYgKCFiNGEuaXNCdWZmZXIoYWRkaXRpb25hbERhdGEpKSBhZGRpdGlvbmFsRGF0YSA9IGI0YS5mcm9tKGFkZGl0aW9uYWxEYXRhLCAnaGV4JykKICBpZiAoIWI0YS5pc0J1ZmZlcihjaXBoZXJ0ZXh0KSkgY2lwaGVydGV4dCA9IGI0YS5mcm9tKGNpcGhlcnRleHQsICdoZXgnKQoKICBjb25zdCBub25jZSA9IGI0YS5hbGxvYyhzb2RpdW0uY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX05QVUJCWVRFUykKICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KG5vbmNlLmJ1ZmZlciwgbm9uY2UuYnl0ZU9mZnNldCwgbm9uY2UuYnl0ZUxlbmd0aCkKICB2aWV3LnNldFVpbnQzMig0LCBjb3VudGVyLCB0cnVlKQoKICBjb25zdCBwbGFpbnRleHQgPSBiNGEuYWxsb2MoY2lwaGVydGV4dC5ieXRlTGVuZ3RoIC0gc29kaXVtLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMpCgogIHNvZGl1bS5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfZGVjcnlwdChwbGFpbnRleHQsIG51bGwsIGNpcGhlcnRleHQsIGFkZGl0aW9uYWxEYXRhLCBub25jZSwga2V5KQogIHJldHVybiBwbGFpbnRleHQKfQovKiBlc2xpbnQtZGlzYWJsZSBjYW1lbGNhc2UgKi8KY29uc3QgewogIGNyeXB0b19reF9TRUVEQllURVMsCiAgY3J5cHRvX2t4X2tleXBhaXIsCiAgY3J5cHRvX2t4X3NlZWRfa2V5cGFpciwKICBjcnlwdG9fc2NhbGFybXVsdF9CWVRFUywKICBjcnlwdG9fc2NhbGFybXVsdF9TQ0FMQVJCWVRFUywKICBjcnlwdG9fc2NhbGFybXVsdCwKICBjcnlwdG9fc2NhbGFybXVsdF9iYXNlCn0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKCmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ25hbm9hc3NlcnQnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgREhMRU4gPSBjcnlwdG9fc2NhbGFybXVsdF9CWVRFUwpjb25zdCBQS0xFTiA9IGNyeXB0b19zY2FsYXJtdWx0X0JZVEVTCmNvbnN0IFNLTEVOID0gY3J5cHRvX3NjYWxhcm11bHRfU0NBTEFSQllURVMKY29uc3QgU0VFRExFTiA9IGNyeXB0b19reF9TRUVEQllURVMKY29uc3QgQUxHID0gJzI1NTE5JwoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgREhMRU4sCiAgUEtMRU4sCiAgU0tMRU4sCiAgU0VFRExFTiwKICBBTEcsCiAgZ2VuZXJhdGVLZXlQYWlyLAogIGdlbmVyYXRlU2VlZEtleVBhaXIsCiAgZGgKfQoKZnVuY3Rpb24gZ2VuZXJhdGVLZXlQYWlyIChwcml2S2V5KSB7CiAgY29uc3Qga2V5UGFpciA9IHt9CgogIGtleVBhaXIuc2VjcmV0S2V5ID0gcHJpdktleSB8fCBiNGEuYWxsb2MoU0tMRU4pCiAga2V5UGFpci5wdWJsaWNLZXkgPSBiNGEuYWxsb2MoUEtMRU4pCgogIGlmIChwcml2S2V5KSB7CiAgICBjcnlwdG9fc2NhbGFybXVsdF9iYXNlKGtleVBhaXIucHVibGljS2V5LCBrZXlQYWlyLnNlY3JldEtleSkKICB9IGVsc2UgewogICAgY3J5cHRvX2t4X2tleXBhaXIoa2V5UGFpci5wdWJsaWNLZXksIGtleVBhaXIuc2VjcmV0S2V5KQogIH0KCiAgcmV0dXJuIGtleVBhaXIKfQoKZnVuY3Rpb24gZ2VuZXJhdGVTZWVkS2V5UGFpciAoc2VlZCkgewogIGFzc2VydChzZWVkLmJ5dGVMZW5ndGggPT09IFNLTEVOKQoKICBjb25zdCBrZXlQYWlyID0ge30KICBrZXlQYWlyLnNlY3JldEtleSA9IGI0YS5hbGxvYyhTS0xFTikKICBrZXlQYWlyLnB1YmxpY0tleSA9IGI0YS5hbGxvYyhQS0xFTikKCiAgY3J5cHRvX2t4X3NlZWRfa2V5cGFpcihrZXlQYWlyLnB1YmxpY0tleSwga2V5UGFpci5zZWNyZXRLZXksIHNlZWQpCiAgcmV0dXJuIGtleVBhaXIKfQoKZnVuY3Rpb24gZGggKHB1YmxpY0tleSwgeyBzZWNyZXRLZXkgfSkgewogIGFzc2VydChzZWNyZXRLZXkuYnl0ZUxlbmd0aCA9PT0gU0tMRU4pCiAgYXNzZXJ0KHB1YmxpY0tleS5ieXRlTGVuZ3RoID09PSBQS0xFTikKCiAgY29uc3Qgb3V0cHV0ID0gYjRhLmFsbG9jKERITEVOKQoKICBjcnlwdG9fc2NhbGFybXVsdCgKICAgIG91dHB1dCwKICAgIHNlY3JldEtleSwKICAgIHB1YmxpY0tleQogICkKCiAgcmV0dXJuIG91dHB1dAp9CmNvbnN0IGhtYWNCbGFrZTJiID0gcmVxdWlyZSgnLi9obWFjJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IEhBU0hMRU4gPSA2NAoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgaGtkZiwKICBIQVNITEVOCn0KCi8vIEhNQUMtYmFzZWQgRXh0cmFjdC1hbmQtRXhwYW5kIEtERgovLyBodHRwczovL3d3dy5pZXRmLm9yZy9yZmMvcmZjNTg2OS50eHQKCmZ1bmN0aW9uIGhrZGYgKHNhbHQsIGlucHV0S2V5TWF0ZXJpYWwsIGluZm8gPSAnJywgbGVuZ3RoID0gMiAqIEhBU0hMRU4pIHsKICBjb25zdCBwc2V1ZG9SYW5kb21LZXkgPSBoa2RmRXh0cmFjdChzYWx0LCBpbnB1dEtleU1hdGVyaWFsKQogIHJldHVybiBoa2RmRXhwYW5kKHBzZXVkb1JhbmRvbUtleSwgaW5mbywgbGVuZ3RoKQp9CgpmdW5jdGlvbiBoa2RmRXh0cmFjdCAoc2FsdCwgaW5wdXRLZXlNYXRlcmlhbCkgewogIGNvbnN0IGhtYWMgPSBiNGEuYWxsb2MoSEFTSExFTikKICByZXR1cm4gaG1hY0RpZ2VzdChobWFjLCBzYWx0LCBpbnB1dEtleU1hdGVyaWFsKQp9CgpmdW5jdGlvbiBoa2RmRXhwYW5kIChrZXksIGluZm8sIGxlbmd0aCkgewogIC8vIFB1dCBpbiBkZWRpY2F0ZWQgc2xhYiB0byBhdm9pZCBrZWVwaW5nIHNoYXJlZCBzbGFiIGZyb20gYmVpbmcgZ2MnZWQKICBjb25zdCBidWZmZXIgPSBiNGEuYWxsb2NVbnNhZmVTbG93KGxlbmd0aCkKCiAgY29uc3QgaW5mb0J1ZiA9IGI0YS5mcm9tKGluZm8pCiAgbGV0IHByZXYgPSBpbmZvQnVmCgogIGNvbnN0IHJlc3VsdCA9IFtdCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gSEFTSExFTikgewogICAgY29uc3QgcG9zID0gYjRhLmZyb20oWyhpIC8gSEFTSExFTikgKyAxXSkKCiAgICBjb25zdCBvdXQgPSBidWZmZXIuc3ViYXJyYXkoaSwgaSArIEhBU0hMRU4pCiAgICByZXN1bHQucHVzaChvdXQpCgogICAgcHJldiA9IGhtYWNEaWdlc3Qob3V0LCBrZXksIFtwcmV2LCBpbmZvQnVmLCBwb3NdKQogIH0KCiAgcmV0dXJuIHJlc3VsdAp9CgpmdW5jdGlvbiBobWFjRGlnZXN0IChvdXQsIGtleSwgaW5wdXQpIHsKICBobWFjQmxha2UyYihvdXQsIGlucHV0LCBrZXkpCiAgcmV0dXJuIG91dAp9Ci8qIGVzbGludC1kaXNhYmxlIGNhbWVsY2FzZSAqLwpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCB7IHNvZGl1bV9tZW16ZXJvLCBjcnlwdG9fZ2VuZXJpY2hhc2gsIGNyeXB0b19nZW5lcmljaGFzaF9iYXRjaCB9ID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCgpjb25zdCBIQVNITEVOID0gNjQKY29uc3QgQkxPQ0tMRU4gPSAxMjgKY29uc3Qgc2NyYXRjaCA9IGI0YS5hbGxvYyhCTE9DS0xFTiAqIDMpCmNvbnN0IEhNQUNLZXkgPSBzY3JhdGNoLnN1YmFycmF5KEJMT0NLTEVOICogMCwgQkxPQ0tMRU4gKiAxKQpjb25zdCBPdXRlcktleVBhZCA9IHNjcmF0Y2guc3ViYXJyYXkoQkxPQ0tMRU4gKiAxLCBCTE9DS0xFTiAqIDIpCmNvbnN0IElubmVyS2V5UGFkID0gc2NyYXRjaC5zdWJhcnJheShCTE9DS0xFTiAqIDIsIEJMT0NLTEVOICogMykKCi8vIFBvc3QtZmlsbCBpcyBkb25lIGluIHRoZSBjYXNlcyB3aGVyZSBzb21lb25lIGNhdWdodCBhbiBleGNlcHRpb24gdGhhdAovLyBoYXBwZW5lZCBiZWZvcmUgd2Ugd2VyZSBhYmxlIHRvIGNsZWFyIGRhdGEgYXQgdGhlIGVuZAoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBobWFjIChvdXQsIGJhdGNoLCBrZXkpIHsKICBpZiAoa2V5LmJ5dGVMZW5ndGggPiBCTE9DS0xFTikgewogICAgY3J5cHRvX2dlbmVyaWNoYXNoKEhNQUNLZXkuc3ViYXJyYXkoMCwgSEFTSExFTiksIGtleSkKICAgIHNvZGl1bV9tZW16ZXJvKEhNQUNLZXkuc3ViYXJyYXkoSEFTSExFTikpCiAgfSBlbHNlIHsKICAgIC8vIENvdmVycyBrZXkgPD0gQkxPQ0tMRU4KICAgIEhNQUNLZXkuc2V0KGtleSkKICAgIHNvZGl1bV9tZW16ZXJvKEhNQUNLZXkuc3ViYXJyYXkoa2V5LmJ5dGVMZW5ndGgpKQogIH0KCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBITUFDS2V5LmJ5dGVMZW5ndGg7IGkrKykgewogICAgT3V0ZXJLZXlQYWRbaV0gPSAweDVjIF4gSE1BQ0tleVtpXQogICAgSW5uZXJLZXlQYWRbaV0gPSAweDM2IF4gSE1BQ0tleVtpXQogIH0KICBzb2RpdW1fbWVtemVybyhITUFDS2V5KQoKICBjcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2gob3V0LCBbSW5uZXJLZXlQYWRdLmNvbmNhdChiYXRjaCkpCiAgc29kaXVtX21lbXplcm8oSW5uZXJLZXlQYWQpCiAgY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKG91dCwgW091dGVyS2V5UGFkLCBvdXRdKQogIHNvZGl1bV9tZW16ZXJvKE91dGVyS2V5UGFkKQp9Cgptb2R1bGUuZXhwb3J0cy5CWVRFUyA9IEhBU0hMRU4KbW9kdWxlLmV4cG9ydHMuS0VZQllURVMgPSBCTE9DS0xFTgpjb25zdCBhc3NlcnQgPSByZXF1aXJlKCduYW5vYXNzZXJ0JykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IFN5bW1ldHJpY1N0YXRlID0gcmVxdWlyZSgnLi9zeW1tZXRyaWMtc3RhdGUnKQpjb25zdCB7IEhBU0hMRU4gfSA9IHJlcXVpcmUoJy4vaGtkZicpCgpjb25zdCBQUkVTSEFSRV9JUyA9IFN5bWJvbCgnaW5pdGlhdG9yIHN0YXRpYyBrZXkgcHJlc2hhcmVkJykKY29uc3QgUFJFU0hBUkVfUlMgPSBTeW1ib2woJ3Jlc3BvbmRlciBzdGF0aWMga2V5IHByZXNoYXJlZCcpCgpjb25zdCBUT0tfUFNLID0gU3ltYm9sKCdwc2snKQoKY29uc3QgVE9LX1MgPSBTeW1ib2woJ3MnKQpjb25zdCBUT0tfRSA9IFN5bWJvbCgnZScpCgpjb25zdCBUT0tfRVMgPSBTeW1ib2woJ2VzJykKY29uc3QgVE9LX1NFID0gU3ltYm9sKCdzZScpCmNvbnN0IFRPS19FRSA9IFN5bWJvbCgnZWUnKQpjb25zdCBUT0tfU1MgPSBTeW1ib2woJ3NzJykKCmNvbnN0IEhBTkRTSEFLRVMgPSBPYmplY3QuZnJlZXplKHsKICBOTjogWwogICAgW1RPS19FXSwKICAgIFtUT0tfRSwgVE9LX0VFXQogIF0sCiAgTk5wc2swOiBbCiAgICBbVE9LX1BTSywgVE9LX0VdLAogICAgW1RPS19FLCBUT0tfRUVdCiAgXSwKICBYWDogWwogICAgW1RPS19FXSwKICAgIFtUT0tfRSwgVE9LX0VFLCBUT0tfUywgVE9LX0VTXSwKICAgIFtUT0tfUywgVE9LX1NFXQogIF0sCiAgWFhwc2swOiBbCiAgICBbVE9LX1BTSywgVE9LX0VdLAogICAgW1RPS19FLCBUT0tfRUUsIFRPS19TLCBUT0tfRVNdLAogICAgW1RPS19TLCBUT0tfU0VdCiAgXSwKICBJSzogWwogICAgUFJFU0hBUkVfUlMsCiAgICBbVE9LX0UsIFRPS19FUywgVE9LX1MsIFRPS19TU10sCiAgICBbVE9LX0UsIFRPS19FRSwgVE9LX1NFXQogIF0sCiAgWEs6IFsKICAgIFBSRVNIQVJFX1JTLAogICAgW1RPS19FLCBUT0tfRVNdLAogICAgW1RPS19FLCBUT0tfRUVdLAogICAgW1RPS19TLCBUT0tfU0VdCiAgXQp9KQoKY2xhc3MgV3JpdGVyIHsKICBjb25zdHJ1Y3RvciAoKSB7CiAgICB0aGlzLnNpemUgPSAwCiAgICB0aGlzLmJ1ZmZlcnMgPSBbXQogIH0KCiAgcHVzaCAoYikgewogICAgdGhpcy5zaXplICs9IGIuYnl0ZUxlbmd0aAogICAgdGhpcy5idWZmZXJzLnB1c2goYikKICB9CgogIGVuZCAoKSB7CiAgICBjb25zdCBhbGwgPSBiNGEuYWxsb2ModGhpcy5zaXplKQogICAgbGV0IG9mZnNldCA9IDAKICAgIGZvciAoY29uc3QgYiBvZiB0aGlzLmJ1ZmZlcnMpIHsKICAgICAgYWxsLnNldChiLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSBiLmJ5dGVMZW5ndGgKICAgIH0KICAgIHJldHVybiBhbGwKICB9Cn0KCmNsYXNzIFJlYWRlciB7CiAgY29uc3RydWN0b3IgKGJ1ZikgewogICAgdGhpcy5vZmZzZXQgPSAwCiAgICB0aGlzLmJ1ZmZlciA9IGJ1ZgogIH0KCiAgc2hpZnQgKG4pIHsKICAgIGNvbnN0IHN0YXJ0ID0gdGhpcy5vZmZzZXQKICAgIGNvbnN0IGVuZCA9IHRoaXMub2Zmc2V0ICs9IG4KICAgIGlmIChlbmQgPiB0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ0luc3VmZmljaWVudCBieXRlcycpCiAgICByZXR1cm4gdGhpcy5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIGVuZCkKICB9CgogIGVuZCAoKSB7CiAgICByZXR1cm4gdGhpcy5zaGlmdCh0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RoIC0gdGhpcy5vZmZzZXQpCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIE5vaXNlU3RhdGUgZXh0ZW5kcyBTeW1tZXRyaWNTdGF0ZSB7CiAgY29uc3RydWN0b3IgKHBhdHRlcm4sIGluaXRpYXRvciwgc3RhdGljS2V5cGFpciwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcihvcHRzKQoKICAgIHRoaXMucyA9IHN0YXRpY0tleXBhaXIgfHwgdGhpcy5jdXJ2ZS5nZW5lcmF0ZUtleVBhaXIoKQogICAgdGhpcy5lID0gbnVsbAoKICAgIHRoaXMucHNrID0gbnVsbAogICAgaWYgKG9wdHMgJiYgb3B0cy5wc2spIHRoaXMucHNrID0gb3B0cy5wc2sKCiAgICB0aGlzLnJlID0gbnVsbAogICAgdGhpcy5ycyA9IG51bGwKCiAgICB0aGlzLnBhdHRlcm4gPSBwYXR0ZXJuCiAgICB0aGlzLmhhbmRzaGFrZSA9IEhBTkRTSEFLRVNbdGhpcy5wYXR0ZXJuXS5zbGljZSgpCgogICAgdGhpcy5pc1Bza0hhbmRzaGFrZSA9ICEhdGhpcy5wc2sgJiYgaGFzUHNrVG9rZW4odGhpcy5oYW5kc2hha2UpCgogICAgdGhpcy5wcm90b2NvbCA9IGI0YS5mcm9tKFsKICAgICAgJ05vaXNlJywKICAgICAgdGhpcy5wYXR0ZXJuLAogICAgICB0aGlzLkRIX0FMRywKICAgICAgdGhpcy5DSVBIRVJfQUxHLAogICAgICAnQkxBS0UyYicKICAgIF0uam9pbignXycpKQoKICAgIHRoaXMuaW5pdGlhdG9yID0gaW5pdGlhdG9yCiAgICB0aGlzLmNvbXBsZXRlID0gZmFsc2UKCiAgICB0aGlzLnJ4ID0gbnVsbAogICAgdGhpcy50eCA9IG51bGwKICAgIHRoaXMuaGFzaCA9IG51bGwKICB9CgogIGluaXRpYWxpc2UgKHByb2xvZ3VlLCByZW1vdGVTdGF0aWMpIHsKICAgIGlmICh0aGlzLnByb3RvY29sLmJ5dGVMZW5ndGggPD0gSEFTSExFTikgdGhpcy5kaWdlc3Quc2V0KHRoaXMucHJvdG9jb2wpCiAgICBlbHNlIHRoaXMubWl4SGFzaCh0aGlzLnByb3RvY29sKQoKICAgIHRoaXMuY2hhaW5pbmdLZXkgPSBiNGEuZnJvbSh0aGlzLmRpZ2VzdCkKCiAgICB0aGlzLm1peEhhc2gocHJvbG9ndWUpCgogICAgd2hpbGUgKCFBcnJheS5pc0FycmF5KHRoaXMuaGFuZHNoYWtlWzBdKSkgewogICAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5oYW5kc2hha2Uuc2hpZnQoKQoKICAgICAgLy8gaGFuZHNoYWtlIHN0ZXBzIHNob3VsZCBiZSBhcyBhcnJheXMsIG9ubHkKICAgICAgLy8gcHJlc2hhcmUgdG9rZW5zIGFyZSBwcm92aWRlZCBvdGhlcndpc2UKICAgICAgYXNzZXJ0KG1lc3NhZ2UgPT09IFBSRVNIQVJFX1JTIHx8IG1lc3NhZ2UgPT09IFBSRVNIQVJFX0lTLAogICAgICAgICdVbmV4cGVjdGVkIHBhdHRlcm4nKQoKICAgICAgY29uc3QgdGFrZVJlbW90ZUtleSA9IHRoaXMuaW5pdGlhdG9yCiAgICAgICAgPyBtZXNzYWdlID09PSBQUkVTSEFSRV9SUwogICAgICAgIDogbWVzc2FnZSA9PT0gUFJFU0hBUkVfSVMKCiAgICAgIGlmICh0YWtlUmVtb3RlS2V5KSB0aGlzLnJzID0gcmVtb3RlU3RhdGljCgogICAgICBjb25zdCBrZXkgPSB0YWtlUmVtb3RlS2V5ID8gdGhpcy5ycyA6IHRoaXMucy5wdWJsaWNLZXkKICAgICAgYXNzZXJ0KGtleSAhPSBudWxsLCAnUmVtb3RlIHB1YmtleSByZXF1aXJlZCcpCgogICAgICB0aGlzLm1peEhhc2goa2V5KQogICAgfQogIH0KCiAgZmluYWwgKCkgewogICAgY29uc3QgW2sxLCBrMl0gPSB0aGlzLnNwbGl0KCkKCiAgICB0aGlzLnR4ID0gdGhpcy5pbml0aWF0b3IgPyBrMSA6IGsyCiAgICB0aGlzLnJ4ID0gdGhpcy5pbml0aWF0b3IgPyBrMiA6IGsxCgogICAgdGhpcy5jb21wbGV0ZSA9IHRydWUKICAgIHRoaXMuaGFzaCA9IHRoaXMuZ2V0SGFuZHNoYWtlSGFzaCgpCgogICAgdGhpcy5fY2xlYXIoKQogIH0KCiAgcmVjdiAoYnVmKSB7CiAgICBjb25zdCByID0gbmV3IFJlYWRlcihidWYpCgogICAgZm9yIChjb25zdCBwYXR0ZXJuIG9mIHRoaXMuaGFuZHNoYWtlLnNoaWZ0KCkpIHsKICAgICAgc3dpdGNoIChwYXR0ZXJuKSB7CiAgICAgICAgY2FzZSBUT0tfUFNLIDoKICAgICAgICAgIHRoaXMubWl4S2V5QW5kSGFzaCh0aGlzLnBzaykKICAgICAgICAgIGJyZWFrCgogICAgICAgIGNhc2UgVE9LX0UgOgogICAgICAgICAgdGhpcy5yZSA9IHIuc2hpZnQodGhpcy5jdXJ2ZS5QS0xFTikKICAgICAgICAgIHRoaXMubWl4SGFzaCh0aGlzLnJlKQogICAgICAgICAgaWYgKHRoaXMuaXNQc2tIYW5kc2hha2UpIHRoaXMubWl4S2V5Tm9ybWFsKHRoaXMucmUpCiAgICAgICAgICBicmVhawoKICAgICAgICBjYXNlIFRPS19TIDogewogICAgICAgICAgY29uc3Qga2xlbiA9IHRoaXMuaGFzS2V5ID8gdGhpcy5jdXJ2ZS5QS0xFTiArIDE2IDogdGhpcy5jdXJ2ZS5QS0xFTgogICAgICAgICAgdGhpcy5ycyA9IHRoaXMuZGVjcnlwdEFuZEhhc2goci5zaGlmdChrbGVuKSkKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQoKICAgICAgICBjYXNlIFRPS19FRSA6CiAgICAgICAgY2FzZSBUT0tfRVMgOgogICAgICAgIGNhc2UgVE9LX1NFIDoKICAgICAgICBjYXNlIFRPS19TUyA6IHsKICAgICAgICAgIGNvbnN0IHVzZVN0YXRpYyA9IGtleVBhdHRlcm4ocGF0dGVybiwgdGhpcy5pbml0aWF0b3IpCgogICAgICAgICAgY29uc3QgbG9jYWxLZXkgPSB1c2VTdGF0aWMubG9jYWwgPyB0aGlzLnMgOiB0aGlzLmUKICAgICAgICAgIGNvbnN0IHJlbW90ZUtleSA9IHVzZVN0YXRpYy5yZW1vdGUgPyB0aGlzLnJzIDogdGhpcy5yZQoKICAgICAgICAgIHRoaXMubWl4S2V5KHJlbW90ZUtleSwgbG9jYWxLZXkpCiAgICAgICAgICBicmVhawogICAgICAgIH0KCiAgICAgICAgZGVmYXVsdCA6CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuZXhwZWN0ZWQgbWVzc2FnZScpCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBwYXlsb2FkID0gdGhpcy5kZWNyeXB0QW5kSGFzaChyLmVuZCgpKQoKICAgIGlmICghdGhpcy5oYW5kc2hha2UubGVuZ3RoKSB0aGlzLmZpbmFsKCkKICAgIHJldHVybiBwYXlsb2FkCiAgfQoKICBzZW5kIChwYXlsb2FkID0gYjRhLmFsbG9jKDApKSB7CiAgICBjb25zdCB3ID0gbmV3IFdyaXRlcigpCgogICAgZm9yIChjb25zdCBwYXR0ZXJuIG9mIHRoaXMuaGFuZHNoYWtlLnNoaWZ0KCkpIHsKICAgICAgc3dpdGNoIChwYXR0ZXJuKSB7CiAgICAgICAgY2FzZSBUT0tfUFNLIDoKICAgICAgICAgIHRoaXMubWl4S2V5QW5kSGFzaCh0aGlzLnBzaykKICAgICAgICAgIGJyZWFrCgogICAgICAgIGNhc2UgVE9LX0UgOgogICAgICAgICAgaWYgKHRoaXMuZSA9PT0gbnVsbCkgdGhpcy5lID0gdGhpcy5jdXJ2ZS5nZW5lcmF0ZUtleVBhaXIoKQogICAgICAgICAgdGhpcy5taXhIYXNoKHRoaXMuZS5wdWJsaWNLZXkpCiAgICAgICAgICBpZiAodGhpcy5pc1Bza0hhbmRzaGFrZSkgdGhpcy5taXhLZXlOb3JtYWwodGhpcy5lLnB1YmxpY0tleSkKICAgICAgICAgIHcucHVzaCh0aGlzLmUucHVibGljS2V5KQogICAgICAgICAgYnJlYWsKCiAgICAgICAgY2FzZSBUT0tfUyA6CiAgICAgICAgICB3LnB1c2godGhpcy5lbmNyeXB0QW5kSGFzaCh0aGlzLnMucHVibGljS2V5KSkKICAgICAgICAgIGJyZWFrCgogICAgICAgIGNhc2UgVE9LX0VTIDoKICAgICAgICBjYXNlIFRPS19TRSA6CiAgICAgICAgY2FzZSBUT0tfRUUgOgogICAgICAgIGNhc2UgVE9LX1NTIDogewogICAgICAgICAgY29uc3QgdXNlU3RhdGljID0ga2V5UGF0dGVybihwYXR0ZXJuLCB0aGlzLmluaXRpYXRvcikKCiAgICAgICAgICBjb25zdCBsb2NhbEtleSA9IHVzZVN0YXRpYy5sb2NhbCA/IHRoaXMucyA6IHRoaXMuZQogICAgICAgICAgY29uc3QgcmVtb3RlS2V5ID0gdXNlU3RhdGljLnJlbW90ZSA/IHRoaXMucnMgOiB0aGlzLnJlCgogICAgICAgICAgdGhpcy5taXhLZXkocmVtb3RlS2V5LCBsb2NhbEtleSkKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQoKICAgICAgICBkZWZhdWx0IDoKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3RlZCBtZXNzYWdlJykKICAgICAgfQogICAgfQoKICAgIHcucHVzaCh0aGlzLmVuY3J5cHRBbmRIYXNoKHBheWxvYWQpKQogICAgY29uc3QgcmVzcG9uc2UgPSB3LmVuZCgpCgogICAgaWYgKCF0aGlzLmhhbmRzaGFrZS5sZW5ndGgpIHRoaXMuZmluYWwoKQogICAgcmV0dXJuIHJlc3BvbnNlCiAgfQoKICBfY2xlYXIgKCkgewogICAgc3VwZXIuX2NsZWFyKCkKCiAgICB0aGlzLmUuc2VjcmV0S2V5LmZpbGwoMCkKICAgIHRoaXMuZS5wdWJsaWNLZXkuZmlsbCgwKQoKICAgIHRoaXMucmUuZmlsbCgwKQoKICAgIHRoaXMuZSA9IG51bGwKICAgIHRoaXMucmUgPSBudWxsCiAgfQp9CgpmdW5jdGlvbiBrZXlQYXR0ZXJuIChwYXR0ZXJuLCBpbml0aWF0b3IpIHsKICBjb25zdCByZXQgPSB7CiAgICBsb2NhbDogZmFsc2UsCiAgICByZW1vdGU6IGZhbHNlCiAgfQoKICBzd2l0Y2ggKHBhdHRlcm4pIHsKICAgIGNhc2UgVE9LX0VFOgogICAgICByZXR1cm4gcmV0CgogICAgY2FzZSBUT0tfRVM6CiAgICAgIHJldC5sb2NhbCBePSAhaW5pdGlhdG9yCiAgICAgIHJldC5yZW1vdGUgXj0gaW5pdGlhdG9yCiAgICAgIHJldHVybiByZXQKCiAgICBjYXNlIFRPS19TRToKICAgICAgcmV0LmxvY2FsIF49IGluaXRpYXRvcgogICAgICByZXQucmVtb3RlIF49ICFpbml0aWF0b3IKICAgICAgcmV0dXJuIHJldAoKICAgIGNhc2UgVE9LX1NTOgogICAgICByZXQubG9jYWwgXj0gMQogICAgICByZXQucmVtb3RlIF49IDEKICAgICAgcmV0dXJuIHJldAogIH0KfQoKZnVuY3Rpb24gaGFzUHNrVG9rZW4gKGhhbmRzaGFrZSkgewogIHJldHVybiBoYW5kc2hha2Uuc29tZSh4ID0+IHsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHgpICYmIHguaW5kZXhPZihUT0tfUFNLKSAhPT0gLTEKICB9KQp9CnsKICAibmFtZSI6ICJub2lzZS1oYW5kc2hha2UiLAogICJ2ZXJzaW9uIjogIjQuMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiTm9pc2UgcHJvdG9jb2wgaGFuZHNoYWtlIiwKICAibWFpbiI6ICJub2lzZS5qcyIsCiAgImZpbGVzIjogWwogICAgIiouanMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC8qLmpzIgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9ub2lzZS1oYW5kc2hha2UuZ2l0IgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuMS4wIiwKICAgICJuYW5vYXNzZXJ0IjogIl4yLjAuMCIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMy4yIiwKICAgICJub2lzZS1wcm90b2NvbCI6ICJjaG0tZGllZGVyaWNocy9ub2lzZS1wcm90b2NvbC5naXQjeHgtZXBoZW1lcmFsLWtleSIsCiAgICAic3RhbmRhcmQiOiAiXjE2LjAuMyIKICB9Cn0KY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ25hbm9hc3NlcnQnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBDaXBoZXJTdGF0ZSA9IHJlcXVpcmUoJy4vY2lwaGVyJykKY29uc3QgY3VydmUgPSByZXF1aXJlKCcuL2RoJykKY29uc3QgeyBIQVNITEVOLCBoa2RmIH0gPSByZXF1aXJlKCcuL2hrZGYnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBTeW1tZXRyaWNTdGF0ZSBleHRlbmRzIENpcGhlclN0YXRlIHsKICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5jdXJ2ZSA9IG9wdHMuY3VydmUgfHwgY3VydmUKICAgIHRoaXMuZGlnZXN0ID0gYjRhLmFsbG9jKEhBU0hMRU4pCiAgICB0aGlzLmNoYWluaW5nS2V5ID0gbnVsbAogICAgdGhpcy5vZmZzZXQgPSAwCgogICAgdGhpcy5ESF9BTEcgPSB0aGlzLmN1cnZlLkFMRwogIH0KCiAgbWl4SGFzaCAoZGF0YSkgewogICAgYWNjdW11bGF0ZURpZ2VzdCh0aGlzLmRpZ2VzdCwgZGF0YSkKICB9CgogIG1peEtleUFuZEhhc2ggKGtleSkgewogICAgY29uc3QgW2NrLCB0ZW1wSCwgdGVtcEtdID0gaGtkZih0aGlzLmNoYWluaW5nS2V5LCBrZXksICcnLCAzICogSEFTSExFTikKICAgIHRoaXMuY2hhaW5pbmdLZXkgPSBjawogICAgdGhpcy5taXhIYXNoKHRlbXBIKQogICAgdGhpcy5pbml0aWFsaXNlS2V5KHRlbXBLLnN1YmFycmF5KDAsIDMyKSkKICB9CgogIG1peEtleU5vcm1hbCAoa2V5KSB7CiAgICBjb25zdCBbY2ssIHRlbXBLXSA9IGhrZGYodGhpcy5jaGFpbmluZ0tleSwga2V5KQogICAgdGhpcy5jaGFpbmluZ0tleSA9IGNrCiAgICB0aGlzLmluaXRpYWxpc2VLZXkodGVtcEsuc3ViYXJyYXkoMCwgMzIpKQogIH0KCiAgbWl4S2V5IChyZW1vdGVLZXksIGxvY2FsS2V5KSB7CiAgICBjb25zdCBkaCA9IHRoaXMuY3VydmUuZGgocmVtb3RlS2V5LCBsb2NhbEtleSkKICAgIGNvbnN0IGhrZGZSZXN1bHQgPSBoa2RmKHRoaXMuY2hhaW5pbmdLZXksIGRoKQogICAgdGhpcy5jaGFpbmluZ0tleSA9IGhrZGZSZXN1bHRbMF0KICAgIHRoaXMuaW5pdGlhbGlzZUtleShoa2RmUmVzdWx0WzFdLnN1YmFycmF5KDAsIDMyKSkKICB9CgogIGVuY3J5cHRBbmRIYXNoIChwbGFpbnRleHQpIHsKICAgIGNvbnN0IGNpcGhlcnRleHQgPSB0aGlzLmVuY3J5cHQocGxhaW50ZXh0LCB0aGlzLmRpZ2VzdCkKICAgIGFjY3VtdWxhdGVEaWdlc3QodGhpcy5kaWdlc3QsIGNpcGhlcnRleHQpCiAgICByZXR1cm4gY2lwaGVydGV4dAogIH0KCiAgZGVjcnlwdEFuZEhhc2ggKGNpcGhlcnRleHQpIHsKICAgIGNvbnN0IHBsYWludGV4dCA9IHRoaXMuZGVjcnlwdChjaXBoZXJ0ZXh0LCB0aGlzLmRpZ2VzdCkKICAgIGFjY3VtdWxhdGVEaWdlc3QodGhpcy5kaWdlc3QsIGNpcGhlcnRleHQpCiAgICByZXR1cm4gcGxhaW50ZXh0CiAgfQoKICBnZXRIYW5kc2hha2VIYXNoIChvdXQpIHsKICAgIGlmICghb3V0KSByZXR1cm4gdGhpcy5nZXRIYW5kc2hha2VIYXNoKGI0YS5hbGxvYyhIQVNITEVOKSkKICAgIGFzc2VydChvdXQuYnl0ZUxlbmd0aCA9PT0gSEFTSExFTiwgYG91dHB1dCBtdXN0IGJlICR7SEFTSExFTn0gYnl0ZXNgKQoKICAgIG91dC5zZXQodGhpcy5kaWdlc3QpCiAgICByZXR1cm4gb3V0CiAgfQoKICBzcGxpdCAoKSB7CiAgICBjb25zdCByZXMgPSBoa2RmKHRoaXMuY2hhaW5pbmdLZXksIGI0YS5hbGxvYygwKSkKICAgIHJldHVybiByZXMubWFwKGsgPT4gay5zdWJhcnJheSgwLCAzMikpCiAgfQoKICBfY2xlYXIgKCkgewogICAgc3VwZXIuX2NsZWFyKCkKCiAgICBzb2RpdW0uc29kaXVtX21lbXplcm8odGhpcy5kaWdlc3QpCiAgICBzb2RpdW0uc29kaXVtX21lbXplcm8odGhpcy5jaGFpbmluZ0tleSkKCiAgICB0aGlzLmRpZ2VzdCA9IG51bGwKICAgIHRoaXMuY2hhaW5pbmdLZXkgPSBudWxsCiAgICB0aGlzLm9mZnNldCA9IG51bGwKCiAgICB0aGlzLmN1cnZlID0gbnVsbAogIH0KCiAgc3RhdGljIGdldCBhbGcgKCkgewogICAgcmV0dXJuIENpcGhlclN0YXRlLmFsZyArICdfQkxBS0UyYicKICB9Cn0KCmZ1bmN0aW9uIGFjY3VtdWxhdGVEaWdlc3QgKGRpZ2VzdCwgaW5wdXQpIHsKICBjb25zdCB0b0hhc2ggPSBiNGEuY29uY2F0KFtkaWdlc3QsIGlucHV0XSkKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGRpZ2VzdCwgdG9IYXNoKQp9CnZhciB2YXJpbnQgPSByZXF1aXJlKCd2YXJpbnQnKQp2YXIgc3ZhcmludCA9IHJlcXVpcmUoJ3NpZ25lZC12YXJpbnQnKQp2YXIgYjRhID0gcmVxdWlyZSgnYjRhJykKCmV4cG9ydHMubWFrZSA9IGVuY29kZXIKCmV4cG9ydHMubmFtZSA9IGZ1bmN0aW9uIChlbmMpIHsKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGV4cG9ydHMpCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoZXhwb3J0c1trZXlzW2ldXSA9PT0gZW5jKSByZXR1cm4ga2V5c1tpXQogIH0KICByZXR1cm4gbnVsbAp9CgpleHBvcnRzLnNraXAgPSBmdW5jdGlvbiAodHlwZSwgYnVmZmVyLCBvZmZzZXQpIHsKICBzd2l0Y2ggKHR5cGUpIHsKICAgIGNhc2UgMDoKICAgICAgdmFyaW50LmRlY29kZShidWZmZXIsIG9mZnNldCkKICAgICAgcmV0dXJuIG9mZnNldCArIHZhcmludC5kZWNvZGUuYnl0ZXMKCiAgICBjYXNlIDE6CiAgICAgIHJldHVybiBvZmZzZXQgKyA4CgogICAgY2FzZSAyOgogICAgICB2YXIgbGVuID0gdmFyaW50LmRlY29kZShidWZmZXIsIG9mZnNldCkKICAgICAgcmV0dXJuIG9mZnNldCArIHZhcmludC5kZWNvZGUuYnl0ZXMgKyBsZW4KCiAgICBjYXNlIDM6CiAgICBjYXNlIDQ6CiAgICAgIHRocm93IG5ldyBFcnJvcignR3JvdXBzIGFyZSBub3Qgc3VwcG9ydGVkJykKCiAgICBjYXNlIDU6CiAgICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQoKICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gd2lyZSB0eXBlOiAnICsgdHlwZSkKfQoKZXhwb3J0cy5ieXRlcyA9IGVuY29kZXIoMiwKICBmdW5jdGlvbiBlbmNvZGUgKHZhbCwgYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgIHZhciBsZW4gPSBidWZmZXJMZW5ndGgodmFsKQoKICAgIHZhcmludC5lbmNvZGUobGVuLCBidWZmZXIsIG9mZnNldCkKICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCgogICAgaWYgKGI0YS5pc0J1ZmZlcih2YWwpKSBiNGEuY29weSh2YWwsIGJ1ZmZlciwgb2Zmc2V0KQogICAgZWxzZSBiNGEud3JpdGUoYnVmZmVyLCB2YWwsIG9mZnNldCwgbGVuKQogICAgb2Zmc2V0ICs9IGxlbgoKICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAoKICAgIHZhciBsZW4gPSB2YXJpbnQuZGVjb2RlKGJ1ZmZlciwgb2Zmc2V0KQogICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKCiAgICB2YXIgdmFsID0gYnVmZmVyLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgbGVuKQogICAgb2Zmc2V0ICs9IHZhbC5sZW5ndGgKCiAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgIHJldHVybiB2YWwKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICh2YWwpIHsKICAgIHZhciBsZW4gPSBidWZmZXJMZW5ndGgodmFsKQogICAgcmV0dXJuIHZhcmludC5lbmNvZGluZ0xlbmd0aChsZW4pICsgbGVuCiAgfQopCgpleHBvcnRzLnN0cmluZyA9IGVuY29kZXIoMiwKICBmdW5jdGlvbiBlbmNvZGUgKHZhbCwgYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgIHZhciBsZW4gPSBiNGEuYnl0ZUxlbmd0aCh2YWwpCgogICAgdmFyaW50LmVuY29kZShsZW4sIGJ1ZmZlciwgb2Zmc2V0LCAndXRmLTgnKQogICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKCiAgICBiNGEud3JpdGUoYnVmZmVyLCB2YWwsIG9mZnNldCwgbGVuKQogICAgb2Zmc2V0ICs9IGxlbgoKICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAoKICAgIHZhciBsZW4gPSB2YXJpbnQuZGVjb2RlKGJ1ZmZlciwgb2Zmc2V0KQogICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKCiAgICB2YXIgdmFsID0gYjRhLnRvU3RyaW5nKGJ1ZmZlciwgJ3V0Zi04Jywgb2Zmc2V0LCBvZmZzZXQgKyBsZW4pCiAgICBvZmZzZXQgKz0gbGVuCgogICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICByZXR1cm4gdmFsCiAgfSwKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAodmFsKSB7CiAgICB2YXIgbGVuID0gYjRhLmJ5dGVMZW5ndGgodmFsKQogICAgcmV0dXJuIHZhcmludC5lbmNvZGluZ0xlbmd0aChsZW4pICsgbGVuCiAgfQopCgpleHBvcnRzLmJvb2wgPSBlbmNvZGVyKDAsCiAgZnVuY3Rpb24gZW5jb2RlICh2YWwsIGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICBidWZmZXJbb2Zmc2V0XSA9IHZhbCA/IDEgOiAwCiAgICBlbmNvZGUuYnl0ZXMgPSAxCiAgICByZXR1cm4gYnVmZmVyCiAgfSwKICBmdW5jdGlvbiBkZWNvZGUgKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgYm9vbCA9IGJ1ZmZlcltvZmZzZXRdID4gMAogICAgZGVjb2RlLmJ5dGVzID0gMQogICAgcmV0dXJuIGJvb2wKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICgpIHsKICAgIHJldHVybiAxCiAgfQopCgpleHBvcnRzLmludDMyID0gZW5jb2RlcigwLAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgdmFyaW50LmVuY29kZSh2YWwgPCAwID8gdmFsICsgNDI5NDk2NzI5NiA6IHZhbCwgYnVmZmVyLCBvZmZzZXQpCiAgICBlbmNvZGUuYnl0ZXMgPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICByZXR1cm4gYnVmZmVyCiAgfSwKICBmdW5jdGlvbiBkZWNvZGUgKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgdmFsID0gdmFyaW50LmRlY29kZShidWZmZXIsIG9mZnNldCkKICAgIGRlY29kZS5ieXRlcyA9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgIHJldHVybiB2YWwgPiAyMTQ3NDgzNjQ3ID8gdmFsIC0gNDI5NDk2NzI5NiA6IHZhbAogIH0sCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKHZhbCkgewogICAgcmV0dXJuIHZhcmludC5lbmNvZGluZ0xlbmd0aCh2YWwgPCAwID8gdmFsICsgNDI5NDk2NzI5NiA6IHZhbCkKICB9CikKCmV4cG9ydHMuaW50NjQgPSBlbmNvZGVyKDAsCiAgZnVuY3Rpb24gZW5jb2RlICh2YWwsIGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICBpZiAodmFsIDwgMCkgewogICAgICB2YXIgbGFzdCA9IG9mZnNldCArIDkKICAgICAgdmFyaW50LmVuY29kZSh2YWwgKiAtMSwgYnVmZmVyLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzIC0gMQogICAgICBidWZmZXJbb2Zmc2V0XSA9IGJ1ZmZlcltvZmZzZXRdIHwgMHg4MAogICAgICB3aGlsZSAob2Zmc2V0IDwgbGFzdCAtIDEpIHsKICAgICAgICBvZmZzZXQrKwogICAgICAgIGJ1ZmZlcltvZmZzZXRdID0gMHhmZgogICAgICB9CiAgICAgIGJ1ZmZlcltsYXN0XSA9IDB4MDEKICAgICAgZW5jb2RlLmJ5dGVzID0gMTAKICAgIH0gZWxzZSB7CiAgICAgIHZhcmludC5lbmNvZGUodmFsLCBidWZmZXIsIG9mZnNldCkKICAgICAgZW5jb2RlLmJ5dGVzID0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgfQogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIHZhbCA9IHZhcmludC5kZWNvZGUoYnVmZmVyLCBvZmZzZXQpCiAgICBpZiAodmFsID49IE1hdGgucG93KDIsIDYzKSkgewogICAgICB2YXIgbGltaXQgPSA5CiAgICAgIHdoaWxlIChidWZmZXJbb2Zmc2V0ICsgbGltaXQgLSAxXSA9PT0gMHhmZikgbGltaXQtLQogICAgICBsaW1pdCA9IGxpbWl0IHx8IDkKICAgICAgdmFyIHN1YnNldCA9IGI0YS5hbGxvY1Vuc2FmZShsaW1pdCkKICAgICAgYjRhLmNvcHkoYnVmZmVyLCBzdWJzZXQsIDAsIG9mZnNldCwgb2Zmc2V0ICsgbGltaXQpCiAgICAgIHN1YnNldFtsaW1pdCAtIDFdID0gc3Vic2V0W2xpbWl0IC0gMV0gJiAweDdmCiAgICAgIHZhbCA9IC0xICogdmFyaW50LmRlY29kZShzdWJzZXQsIDApCiAgICAgIGRlY29kZS5ieXRlcyA9IDEwCiAgICB9IGVsc2UgewogICAgICBkZWNvZGUuYnl0ZXMgPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICB9CiAgICByZXR1cm4gdmFsCiAgfSwKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAodmFsKSB7CiAgICByZXR1cm4gdmFsIDwgMCA/IDEwIDogdmFyaW50LmVuY29kaW5nTGVuZ3RoKHZhbCkKICB9CikKCmV4cG9ydHMuc2ludDMyID0KZXhwb3J0cy5zaW50NjQgPSBlbmNvZGVyKDAsCiAgc3ZhcmludC5lbmNvZGUsCiAgc3ZhcmludC5kZWNvZGUsCiAgc3ZhcmludC5lbmNvZGluZ0xlbmd0aAopCgpleHBvcnRzLnVpbnQzMiA9CmV4cG9ydHMudWludDY0ID0KZXhwb3J0cy5lbnVtID0KZXhwb3J0cy52YXJpbnQgPSBlbmNvZGVyKDAsCiAgdmFyaW50LmVuY29kZSwKICB2YXJpbnQuZGVjb2RlLAogIHZhcmludC5lbmNvZGluZ0xlbmd0aAopCgovLyB3ZSBjYW5ub3QgcmVwcmVzZW50IHRoZXNlIGluIGphdmFzY3JpcHQgc28gd2UganVzdCB1c2UgYnVmZmVycwpleHBvcnRzLmZpeGVkNjQgPQpleHBvcnRzLnNmaXhlZDY0ID0gZW5jb2RlcigxLAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgYjRhLmNvcHkodmFsLCBidWZmZXIsIG9mZnNldCkKICAgIGVuY29kZS5ieXRlcyA9IDgKICAgIHJldHVybiBidWZmZXIKICB9LAogIGZ1bmN0aW9uIGRlY29kZSAoYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciB2YWwgPSBidWZmZXIuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyA4KQogICAgZGVjb2RlLmJ5dGVzID0gOAogICAgcmV0dXJuIHZhbAogIH0sCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKCkgewogICAgcmV0dXJuIDgKICB9CikKCmV4cG9ydHMuZG91YmxlID0gZW5jb2RlcigxLAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgYjRhLndyaXRlRG91YmxlTEUoYnVmZmVyLCB2YWwsIG9mZnNldCkKICAgIGVuY29kZS5ieXRlcyA9IDgKICAgIHJldHVybiBidWZmZXIKICB9LAogIGZ1bmN0aW9uIGRlY29kZSAoYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciB2YWwgPSBiNGEucmVhZERvdWJsZUxFKGJ1ZmZlciwgb2Zmc2V0KQogICAgZGVjb2RlLmJ5dGVzID0gOAogICAgcmV0dXJuIHZhbAogIH0sCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKCkgewogICAgcmV0dXJuIDgKICB9CikKCmV4cG9ydHMuZml4ZWQzMiA9IGVuY29kZXIoNSwKICBmdW5jdGlvbiBlbmNvZGUgKHZhbCwgYnVmZmVyLCBvZmZzZXQpIHsKICAgIGI0YS53cml0ZVVJbnQzMkxFKGJ1ZmZlciwgdmFsLCBvZmZzZXQpCiAgICBlbmNvZGUuYnl0ZXMgPSA0CiAgICByZXR1cm4gYnVmZmVyCiAgfSwKICBmdW5jdGlvbiBkZWNvZGUgKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgdmFsID0gYjRhLnJlYWRVSW50MzJMRShidWZmZXIsIG9mZnNldCkKICAgIGRlY29kZS5ieXRlcyA9IDQKICAgIHJldHVybiB2YWwKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICgpIHsKICAgIHJldHVybiA0CiAgfQopCgpleHBvcnRzLnNmaXhlZDMyID0gZW5jb2Rlcig1LAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgYjRhLndyaXRlSW50MzJMRShidWZmZXIsIHZhbCwgb2Zmc2V0KQogICAgZW5jb2RlLmJ5dGVzID0gNAogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIHZhbCA9IGI0YS5yZWFkSW50MzJMRShidWZmZXIsIG9mZnNldCkKICAgIGRlY29kZS5ieXRlcyA9IDQKICAgIHJldHVybiB2YWwKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICgpIHsKICAgIHJldHVybiA0CiAgfQopCgpleHBvcnRzLmZsb2F0ID0gZW5jb2Rlcig1LAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgYjRhLndyaXRlRmxvYXRMRShidWZmZXIsIHZhbCwgb2Zmc2V0KQogICAgZW5jb2RlLmJ5dGVzID0gNAogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIHZhbCA9IGI0YS5yZWFkRmxvYXRMRShidWZmZXIsIG9mZnNldCkKICAgIGRlY29kZS5ieXRlcyA9IDQKICAgIHJldHVybiB2YWwKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICgpIHsKICAgIHJldHVybiA0CiAgfQopCgpmdW5jdGlvbiBlbmNvZGVyICh0eXBlLCBlbmNvZGUsIGRlY29kZSwgZW5jb2RpbmdMZW5ndGgpIHsKICBlbmNvZGUuYnl0ZXMgPSBkZWNvZGUuYnl0ZXMgPSAwCgogIHJldHVybiB7CiAgICB0eXBlOiB0eXBlLAogICAgZW5jb2RlOiBlbmNvZGUsCiAgICBkZWNvZGU6IGRlY29kZSwKICAgIGVuY29kaW5nTGVuZ3RoOiBlbmNvZGluZ0xlbmd0aAogIH0KfQoKZnVuY3Rpb24gYnVmZmVyTGVuZ3RoICh2YWwpIHsKICByZXR1cm4gYjRhLmlzQnVmZmVyKHZhbCkgPyB2YWwubGVuZ3RoIDogYjRhLmJ5dGVMZW5ndGgodmFsKQp9CnsKICAibmFtZSI6ICJwcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncyIsCiAgInZlcnNpb24iOiAiMS4yLjAiLAogICJkZXNjcmlwdGlvbiI6ICJCYXNlIGVuY29kaW5ncyBmb3IgcHJvdG9jb2wtYnVmZmVycyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMCIsCiAgICAic2lnbmVkLXZhcmludCI6ICJeMi4wLjEiLAogICAgInZhcmludCI6ICI1LjAuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE0LjMuNCIsCiAgICAidGFwZSI6ICJeNS4wLjEiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9wcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncy5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MiCn0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IFByb3RvbXV4ID0gcmVxdWlyZSgncHJvdG9tdXgnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBzY2hlbWEgPSByZXF1aXJlKCcuL3NwZWMvaHlwZXJzY2hlbWEnKQoKY29uc3QgW05TX0lOSVRBVE9SLCBOU19SRVNQT05ERVJdID0gY3J5cHRvLm5hbWVzcGFjZSgnd2FrZXVwJywgMikKCmNvbnN0IEhhbmRzaGFrZSA9IHNjaGVtYS5nZXRFbmNvZGluZygnQHdha2V1cC9oYW5kc2hha2UnKQpjb25zdCBBbm5vdW5jZSA9IHNjaGVtYS5nZXRFbmNvZGluZygnQHdha2V1cC9hbm5vdW5jZScpCmNvbnN0IExvb2t1cCA9IHNjaGVtYS5nZXRFbmNvZGluZygnQHdha2V1cC9sb29rdXAnKQpjb25zdCBJbmZvID0gc2NoZW1hLmdldEVuY29kaW5nKCdAd2FrZXVwL2luZm8nKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBXYWtldXBTd2FybSB7CiAgY29uc3RydWN0b3Iob253YWtldXAgPSBub29wLCB7IGdjVGlja1RpbWUgPSAyMDAwIH0gPSB7fSkgewogICAgdGhpcy5nY1RpY2tUaW1lID0gZ2NUaWNrVGltZQoKICAgIHRoaXMudG9waWNzID0gbmV3IE1hcCgpCiAgICB0aGlzLnRvcGljc0dDID0gbmV3IFNldCgpCiAgICB0aGlzLm11eGVycyA9IG5ldyBTZXQoKQogICAgdGhpcy5zdGF0cyA9IHsKICAgICAgc2Vzc2lvbnNPcGVuZWQ6IDAsCiAgICAgIHNlc3Npb25zQ2xvc2VkOiAwLAogICAgICB0b3BpY3NBZGRlZDogMCwKICAgICAgdG9waWNzR2NkOiAwLAogICAgICBwZWVyc0FkZGVkOiAwLAogICAgICBwZWVyc1JlbW92ZWQ6IDAsCiAgICAgIHdpcmVBbm5vdW5jZTogeyByeDogMCwgdHg6IDAgfSwKICAgICAgd2lyZUxvb2t1cDogeyByeDogMCwgdHg6IDAgfSwKICAgICAgd2lyZUluZm86IHsgcng6IDAsIHR4OiAwIH0KICAgIH0KCiAgICB0aGlzLm9ud2FrZXVwID0gb253YWtldXAKCiAgICB0aGlzLl9nY0ludGVydmFsID0gbnVsbAogICAgdGhpcy5fZ2NCb3VuZCA9IHRoaXMuX2djLmJpbmQodGhpcykKICB9CgogIHNlc3Npb24oY2FwYWJpbGl0eSwgaGFuZGxlcnMgPSB7fSkgewogICAgY29uc3QgaWQgPSBoYW5kbGVycy5kaXNjb3ZlcnlLZXkgfHwgY3J5cHRvLmRpc2NvdmVyeUtleShjYXBhYmlsaXR5KQogICAgY29uc3QgYWN0aXZlID0gaGFuZGxlcnMuYWN0aXZlICE9PSBmYWxzZQogICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGlkLCAnaGV4JykKCiAgICBsZXQgdyA9IHRoaXMudG9waWNzLmdldChoZXgpCgogICAgaWYgKHcpIHJldHVybiB3LmFkZFNlc3Npb24oaGFuZGxlcnMpCgogICAgdyA9IG5ldyBXYWtldXBUb3BpYyh0aGlzLCBpZCwgY2FwYWJpbGl0eSwgYWN0aXZlKQoKICAgIHRoaXMudG9waWNzLnNldChoZXgsIHcpCgogICAgZm9yIChjb25zdCBtdXhlciBvZiB0aGlzLm11eGVycykgewogICAgICB3Ll9vbm9wZW4obXV4ZXIsIHRydWUpCiAgICB9CgogICAgcmV0dXJuIHcuYWRkU2Vzc2lvbihoYW5kbGVycykKICB9CgogIGdldFNlc3Npb25zKGNhcGFiaWxpdHksIGhhbmRsZXJzID0ge30pIHsKICAgIGNvbnN0IGlkID0gaGFuZGxlcnMuZGlzY292ZXJ5S2V5IHx8IGNyeXB0by5kaXNjb3ZlcnlLZXkoY2FwYWJpbGl0eSkKICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhpZCwgJ2hleCcpCiAgICBjb25zdCB3ID0gdGhpcy50b3BpY3MuZ2V0KGhleCkKICAgIHJldHVybiB3ID8gdy5zZXNzaW9ucyA6IFtdCiAgfQoKICBoYXNTdHJlYW0oc3RyZWFtLCBjYXBhYmlsaXR5LCBoYW5kbGVycyA9IHt9KSB7CiAgICBpZiAoIWNhcGFiaWxpdHkpIHsKICAgICAgY29uc3Qgbm9pc2VTdHJlYW0gPSBzdHJlYW0ubm9pc2VTdHJlYW0gfHwgc3RyZWFtCiAgICAgIHJldHVybiB0aGlzLm11eGVycy5oYXMoZ2V0TXV4ZXIobm9pc2VTdHJlYW0pKQogICAgfQoKICAgIGNvbnN0IGlkID0gaGFuZGxlcnMuZGlzY292ZXJ5S2V5IHx8IGNyeXB0by5kaXNjb3ZlcnlLZXkoY2FwYWJpbGl0eSkKICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhpZCwgJ2hleCcpCiAgICBjb25zdCB0ID0gdGhpcy50b3BpY3MuZ2V0KGhleCkKCiAgICByZXR1cm4gdCA/IHQucGVlcnNCeVN0cmVhbS5oYXMoc3RyZWFtKSA6IGZhbHNlCiAgfQoKICBhZGRTdHJlYW0oc3RyZWFtKSB7CiAgICBjb25zdCBub2lzZVN0cmVhbSA9IHN0cmVhbS5ub2lzZVN0cmVhbSB8fCBzdHJlYW0KCiAgICBpZiAoIW5vaXNlU3RyZWFtLmNvbm5lY3RlZCkgewogICAgICBub2lzZVN0cmVhbS5vbmNlKCdvcGVuJywgdGhpcy5hZGRTdHJlYW0uYmluZCh0aGlzLCBub2lzZVN0cmVhbSkpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IG11eGVyID0gZ2V0TXV4ZXIobm9pc2VTdHJlYW0pCiAgICBtdXhlci5wYWlyKHsgcHJvdG9jb2w6ICd3YWtldXAnIH0sIChpZCkgPT4gdGhpcy5fb25wYWlyKGlkLCBtdXhlcikpCgogICAgdGhpcy5tdXhlcnMuYWRkKG11eGVyKQogICAgbm9pc2VTdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4gdGhpcy5tdXhlcnMuZGVsZXRlKG11eGVyKSkKCiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy50b3BpY3MudmFsdWVzKCkpIHsKICAgICAgaWYgKCF3LmlzQWN0aXZlKSBjb250aW51ZQogICAgICB3Ll9vbm9wZW4obXV4ZXIsIHRydWUpCiAgICB9CiAgfQoKICBfb25BY3RpdmUodykgewogICAgZm9yIChjb25zdCBtIG9mIHRoaXMubXV4ZXJzKSB7CiAgICAgIHcuX29ub3BlbihtLCBmYWxzZSkKICAgIH0KICB9CgogIF9hZGRHQyh0b3BpYykgewogICAgaWYgKHRvcGljLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLnRvcGljc0dDLmFkZCh0b3BpYykKICAgIGlmICh0aGlzLl9nY0ludGVydmFsID09PSBudWxsKSB7CiAgICAgIHRoaXMuX2djSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLl9nY0JvdW5kLCB0aGlzLmdjVGlja1RpbWUpCiAgICB9CiAgfQoKICBfcmVtb3ZlR0ModG9waWMpIHsKICAgIHRoaXMudG9waWNzR0MuZGVsZXRlKHRvcGljKQogICAgaWYgKHRoaXMudG9waWNzR0Muc2l6ZSA9PT0gMCAmJiB0aGlzLl9nY0ludGVydmFsKSB7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fZ2NJbnRlcnZhbCkKICAgICAgdGhpcy5fZ2NJbnRlcnZhbCA9IG51bGwKICAgIH0KICB9CgogIF9nYygpIHsKICAgIGNvbnN0IGRlc3Ryb3kgPSBbXQogICAgZm9yIChjb25zdCB3IG9mIHRoaXMudG9waWNzR0MpIHsKICAgICAgdy5pZGxlVGlja3MrKwogICAgICBpZiAody5pZGxlVGlja3MgPj0gNSkgZGVzdHJveS5wdXNoKHcpCiAgICB9CiAgICBmb3IgKGNvbnN0IHcgb2YgZGVzdHJveSkgdy50ZWFyZG93bigpCiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuX2djSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwodGhpcy5fZ2NJbnRlcnZhbCkKICAgIHRoaXMuX2djSW50ZXJ2YWwgPSBudWxsCgogICAgZm9yIChjb25zdCB3IG9mIHRoaXMudG9waWNzLnZhbHVlcygpKSB3LnRlYXJkb3duKCkKICB9CgogIGFzeW5jIF9vbnBhaXIoaWQsIHN0cmVhbSkgewogICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGlkLCAnaGV4JykKICAgIGNvbnN0IHcgPSB0aGlzLnRvcGljcy5nZXQoaGV4KQogICAgaWYgKCF3IHx8ICF3LnNlc3Npb25zLmxlbmd0aCkgcmV0dXJuIHRoaXMub253YWtldXAoaWQsIHN0cmVhbSkKICAgIHcuX29ub3BlbihnZXRNdXhlcihzdHJlYW0pLCBmYWxzZSkKICB9CgogIHJlZ2lzdGVyTWV0cmljcyhwcm9tQ2xpZW50KSB7CiAgICBjb25zdCBzZWxmID0gdGhpcwogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3Nlc3Npb25zX29wZW5lZCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHNlc3Npb25zIG9wZW5lZCBieSBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMuc2Vzc2lvbnNPcGVuZWQpCiAgICAgIH0KICAgIH0pCgogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3Nlc3Npb25zX2Nsb3NlZCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHNlc3Npb25zIGNsb3NlZCBieSBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMuc2Vzc2lvbnNDbG9zZWQpCiAgICAgIH0KICAgIH0pCgogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3RvcGljc19hZGRlZCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHRvcGljcyBhZGRlZCB0byBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMudG9waWNzQWRkZWQpCiAgICAgIH0KICAgIH0pCgogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3RvcGljc19nY2QnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiB0b3BpY3MgdGhhdCBnb3QgZ2FyYmFnZSBjb2xsZWN0ZWQgYnkgcHJvdG9tdXggd2FrZXVwJywKICAgICAgY29sbGVjdCgpIHsKICAgICAgICB0aGlzLnNldChzZWxmLnN0YXRzLnRvcGljc0djZCkKICAgICAgfQogICAgfSkKCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfcGVlcnNfYWRkZWQnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiBwZWVycyBhZGRlZCBieSBwcm90b211eCB3YWtldXAsIGFjcm9zcyBhbGwgdG9waWNzJywKICAgICAgY29sbGVjdCgpIHsKICAgICAgICB0aGlzLnNldChzZWxmLnN0YXRzLnBlZXJzQWRkZWQpCiAgICAgIH0KICAgIH0pCgogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3BlZXJzX3JlbW92ZWQnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiBwZWVycyByZW1vdmVkIGJ5IHByb3RvbXV4IHdha2V1cCwgYWNyb3NzIGFsbCB0b3BpY3MnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMucGVlcnNSZW1vdmVkKQogICAgICB9CiAgICB9KQoKICAgIG5ldyBwcm9tQ2xpZW50LkdhdWdlKHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1uZXcKICAgICAgbmFtZTogJ3Byb3RvbXV4X3dha2V1cF93aXJlX2Fubm91bmNlX3J4JywKICAgICAgaGVscDogJ1RoZSBhbW91bnQgb2Ygd2lyZSBhbm5vdW5jZSBtZXNzYWdlcyByZWNlaXZlZCBieSBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMud2lyZUFubm91bmNlLnJ4KQogICAgICB9CiAgICB9KQogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3dpcmVfYW5ub3VuY2VfdHgnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiB3aXJlIGFubm91bmNlIG1lc3NhZ2VzIHRyYW5zbWl0dGVkIGJ5IHByb3RvbXV4IHdha2V1cCcsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy53aXJlQW5ub3VuY2UudHgpCiAgICAgIH0KICAgIH0pCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfd2lyZV9sb29rdXBfcngnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiB3aXJlIGxvb2t1cCBtZXNzYWdlcyByZWNlaXZlZCBieSBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMud2lyZUxvb2t1cC5yeCkKICAgICAgfQogICAgfSkKICAgIG5ldyBwcm9tQ2xpZW50LkdhdWdlKHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1uZXcKICAgICAgbmFtZTogJ3Byb3RvbXV4X3dha2V1cF93aXJlX2xvb2t1cF90eCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHdpcmUgbG9va3VwIG1lc3NhZ2VzIHRyYW5zbWl0dGVkIGJ5IHByb3RvbXV4IHdha2V1cCcsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy53aXJlTG9va3VwLnR4KQogICAgICB9CiAgICB9KQogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3dpcmVfaW5mb19yeCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHdpcmUgaW5mbyBtZXNzYWdlcyByZWNlaXZlZCBieSBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMud2lyZUluZm8ucngpCiAgICAgIH0KICAgIH0pCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfd2lyZV9pbmZvX3R4JywKICAgICAgaGVscDogJ1RoZSBhbW91bnQgb2Ygd2lyZSBpbmZvIG1lc3NhZ2VzIHRyYW5zbWl0dGVkIGJ5IHByb3RvbXV4IHdha2V1cCcsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy53aXJlSW5mby5yeCkKICAgICAgfQogICAgfSkKICB9Cn0KCmNsYXNzIFdha2V1cFBlZXIgewogIGNvbnN0cnVjdG9yKHRvcGljKSB7CiAgICB0aGlzLmluZGV4ID0gMAogICAgdGhpcy51c2VyRGF0YSA9IG51bGwgLy8gZm9yIHRoZSB1c2VyCiAgICB0aGlzLmNsb2NrID0gMCAvLyBmb3IgdGhlIHVzZXIsIHYgdXNlZnVsIHRvIHJlZHVjZSB0cmFmZmljCiAgICB0aGlzLnBlbmRpbmcgPSB0cnVlCiAgICB0aGlzLnJlbW92ZWQgPSBmYWxzZQogICAgdGhpcy50b3BpYyA9IHRvcGljCiAgICB0aGlzLmNoYW5uZWwgPSBudWxsCiAgICB0aGlzLnN0cmVhbSA9IG51bGwKICAgIHRoaXMud2lyZUxvb2t1cCA9IG51bGwKICAgIHRoaXMud2lyZUFubm91bmNlID0gbnVsbAogICAgdGhpcy53aXJlSW5mbyA9IG51bGwKICAgIHRoaXMuYWN0aXZlID0gZmFsc2UKICB9CgogIHVubGluayhsaXN0KSB7CiAgICAvLyBub3RlIHRoYXQgc2luY2Ugd2UgcG9wIGhlcmUgd2UgY2FuIGl0ZXJhdGUgaW4gcmV2ZXJzZSBzYWZlbHkgaW4gY2FzZSBhIHBlZXIgaXMgcmVtb3ZlZCBpbiB0aGUgc2FtZSB0aWNrCiAgICBjb25zdCBoZWFkID0gbGlzdC5wb3AoKQogICAgaWYgKGhlYWQgPT09IHRoaXMpIHJldHVybgogICAgaGVhZC5pbmRleCA9IHRoaXMuaW5kZXgKICAgIGxpc3RbaGVhZC5pbmRleF0gPSBoZWFkCiAgfQp9CgpjbGFzcyBXYWtldXBTZXNzaW9uIHsKICBjb25zdHJ1Y3Rvcih0b3BpYywgaGFuZGxlcnMpIHsKICAgIHRoaXMuaW5kZXggPSAwCiAgICB0aGlzLnRvcGljID0gdG9waWMKICAgIHRoaXMuaGFuZGxlcnMgPSBoYW5kbGVycwogICAgdGhpcy5pc0FjdGl2ZSA9IGhhbmRsZXJzLmFjdGl2ZSAhPT0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICB9CgogIGdldCBwZWVycygpIHsKICAgIHJldHVybiB0aGlzLnRvcGljLnBlZXJzCiAgfQoKICBoYXNTdHJlYW0oc3RyZWFtKSB7CiAgICByZXR1cm4gISF0aGlzLmdldFBlZXIoc3RyZWFtKQogIH0KCiAgYWRkU3RyZWFtKHN0cmVhbSkgewogICAgdGhpcy50b3BpYy5hZGRTdHJlYW0oc3RyZWFtKQogIH0KCiAgZ2V0UGVlcihzdHJlYW0pIHsKICAgIHJldHVybiB0aGlzLnRvcGljLnBlZXJzQnlTdHJlYW0uZ2V0KHN0cmVhbSkgfHwgbnVsbAogIH0KCiAgYnJvYWRjYXN0TG9va3VwKHJlcSkgewogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMudG9waWMucGVuZGluZ1BlZXJzKSB7CiAgICAgIHRoaXMubG9va3VwKHBlZXIsIHJlcSkKICAgIH0KICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnRvcGljLnBlZXJzKSB7CiAgICAgIHRoaXMubG9va3VwKHBlZXIsIHJlcSkKICAgIH0KICB9CgogIGxvb2t1cEJ5U3RyZWFtKHN0cmVhbSwgcmVxKSB7CiAgICBjb25zdCBwZWVyID0gdGhpcy50b3BpYy5wZWVyc0J5U3RyZWFtLmdldChzdHJlYW0pCiAgICBpZiAocGVlcikgdGhpcy5sb29rdXAocGVlciwgcmVxKQogIH0KCiAgbG9va3VwKHBlZXIsIHJlcSkgewogICAgcGVlci50b3BpYy5zdGF0ZS5zdGF0cy53aXJlTG9va3VwLnR4KysKICAgIHBlZXIud2lyZUxvb2t1cC5zZW5kKHJlcSB8fCB7IGhhc2g6IG51bGwgfSkKICB9CgogIGFubm91bmNlQnlTdHJlYW0oc3RyZWFtLCB3YWtldXApIHsKICAgIGNvbnN0IHBlZXIgPSB0aGlzLnRvcGljLnBlZXJzQnlTdHJlYW0uZ2V0KHN0cmVhbSkKICAgIGlmIChwZWVyICYmICFwZWVyLnBlbmRpbmcpIHRoaXMuYW5ub3VuY2UocGVlciwgd2FrZXVwKQogIH0KCiAgYW5ub3VuY2UocGVlciwgd2FrZXVwKSB7CiAgICBwZWVyLnRvcGljLnN0YXRlLnN0YXRzLndpcmVBbm5vdW5jZS50eCsrCiAgICBwZWVyLndpcmVBbm5vdW5jZS5zZW5kKHdha2V1cCkKICB9CgogIGFjdGl2ZSgpIHsKICAgIHRoaXMuaXNBY3RpdmUgPSB0cnVlCiAgICB0aGlzLnRvcGljLl9idW1wQWN0aXZpdHkoKQogIH0KCiAgaW5hY3RpdmUoKSB7CiAgICB0aGlzLmlzQWN0aXZlID0gZmFsc2UKICAgIHRoaXMudG9waWMuX2J1bXBBY3Rpdml0eSgpCiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQogICAgdGhpcy50b3BpYy5yZW1vdmVTZXNzaW9uKHRoaXMpCiAgfQp9CgpjbGFzcyBXYWtldXBUb3BpYyB7CiAgY29uc3RydWN0b3Ioc3RhdGUsIGlkLCBjYXBhYmlsaXR5LCBhY3RpdmUpIHsKICAgIHRoaXMuc3RhdGUgPSBzdGF0ZQogICAgdGhpcy5zZXNzaW9ucyA9IFtdCiAgICB0aGlzLmlkID0gaWQKICAgIHRoaXMuY2FwYWJpbGl0eSA9IGNhcGFiaWxpdHkKICAgIHRoaXMucGVlcnMgPSBbXQogICAgdGhpcy5wZW5kaW5nUGVlcnMgPSBbXQogICAgdGhpcy5wZWVyc0J5U3RyZWFtID0gbmV3IE1hcCgpCiAgICB0aGlzLmFjdGl2ZVBlZXJzID0gMAogICAgdGhpcy5pc0FjdGl2ZSA9IGFjdGl2ZQogICAgdGhpcy5pZGxlVGlja3MgPSAwCiAgICB0aGlzLmdjaW5nID0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKCiAgICB0aGlzLnN0YXRlLnN0YXRzLnRvcGljc0FkZGVkKysKICB9CgogIGFkZFNlc3Npb24oaGFuZGxlcnMpIHsKICAgIHRoaXMuc3RhdGUuc3RhdHMuc2Vzc2lvbnNPcGVuZWQrKwogICAgY29uc3Qgc2Vzc2lvbiA9IG5ldyBXYWtldXBTZXNzaW9uKHRoaXMsIGhhbmRsZXJzKQogICAgc2Vzc2lvbi5pbmRleCA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoCiAgICB0aGlzLnNlc3Npb25zLnB1c2goc2Vzc2lvbikKICAgIHRoaXMuX2J1bXBBY3Rpdml0eSgpCiAgICB0aGlzLl9jaGVja0dDKCkKICAgIHJldHVybiBzZXNzaW9uCiAgfQoKICByZW1vdmVTZXNzaW9uKHNlc3Npb24pIHsKICAgIGlmICh0aGlzLnNlc3Npb25zLmxlbmd0aCA8PSBzZXNzaW9uLmluZGV4KSByZXR1cm4KICAgIGlmICh0aGlzLnNlc3Npb25zW3Nlc3Npb24uaW5kZXhdICE9PSBzZXNzaW9uKSByZXR1cm4KCiAgICB0aGlzLnN0YXRlLnN0YXRzLnNlc3Npb25zQ2xvc2VkKysKCiAgICAvLyBzYW1lIGFzIHdpdGggdGhlIHBlZXIsIHRoaXMgYWxsb3dzIHVzIHRvIGl0ZXJhdGUgd2hpbGUgcmVtb3ZpbmcgaWYgaXRlcmF0aW5nIGJhY2t3YXJkcwogICAgY29uc3QgaGVhZCA9IHRoaXMuc2Vzc2lvbnMucG9wKCkKICAgIGlmIChoZWFkICE9PSBzZXNzaW9uKSB7CiAgICAgIGhlYWQuaW5kZXggPSBzZXNzaW9uLmluZGV4CiAgICAgIHRoaXMuc2Vzc2lvbnNbaGVhZC5pbmRleF0gPSBoZWFkCiAgICB9CgogICAgdGhpcy5fYnVtcEFjdGl2aXR5KCkKICAgIHRoaXMuX2NoZWNrR0MoKQogIH0KCiAgX2J1bXBBY3Rpdml0eSgpIHsKICAgIGxldCBpc0FjdGl2ZSA9IGZhbHNlCgogICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgaWYgKHRoaXMuc2Vzc2lvbnNbaV0uaXNBY3RpdmUpIHsKICAgICAgICBpc0FjdGl2ZSA9IHRydWUKICAgICAgICBicmVhawogICAgICB9CiAgICB9CgogICAgaWYgKGlzQWN0aXZlKSB0aGlzLmFjdGl2ZSgpCiAgICBlbHNlIHRoaXMuaW5hY3RpdmUoKQogIH0KCiAgYWN0aXZlKCkgewogICAgaWYgKHRoaXMuaXNBY3RpdmUpIHJldHVybgogICAgdGhpcy5pZGxlVGlja3MgPSAwCiAgICB0aGlzLmlzQWN0aXZlID0gdHJ1ZQogICAgdGhpcy5fdXBkYXRlQWN0aXZlKHRydWUpCiAgfQoKICBpbmFjdGl2ZSgpIHsKICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgcmV0dXJuCiAgICB0aGlzLmlzQWN0aXZlID0gZmFsc2UKICAgIHRoaXMuX3VwZGF0ZUFjdGl2ZShmYWxzZSkKICB9CgogIF91cGRhdGVBY3RpdmUoYWN0aXZlKSB7CiAgICBjb25zdCBpbmZvID0geyBhY3RpdmUgfQoKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlbmRpbmdQZWVycykgewogICAgICBwZWVyLnRvcGljLnN0YXRlLnN0YXRzLndpcmVJbmZvLnR4KysKICAgICAgcGVlci53aXJlSW5mby5zZW5kKGluZm8pCiAgICB9CiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgewogICAgICBwZWVyLnRvcGljLnN0YXRlLnN0YXRzLndpcmVJbmZvLnR4KysKICAgICAgcGVlci53aXJlSW5mby5zZW5kKGluZm8pCiAgICB9CgogICAgdGhpcy5fY2hlY2tHQygpCgogICAgaWYgKGFjdGl2ZSkgdGhpcy5zdGF0ZS5fb25BY3RpdmUodGhpcykKICB9CgogIHRlYXJkb3duKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQoKICAgIHRoaXMuc3RhdGUuc3RhdHMudG9waWNzR2NkKysKCiAgICBmb3IgKGxldCBpID0gdGhpcy5wZWVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICB0aGlzLnBlZXJzW2ldLmNoYW5uZWwuY2xvc2UoKQogICAgfQoKICAgIGZvciAobGV0IGkgPSB0aGlzLnBlbmRpbmdQZWVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICB0aGlzLnBlbmRpbmdQZWVyc1tpXS5jaGFubmVsLmNsb3NlKCkKICAgIH0KCiAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcodGhpcy5pZCwgJ2hleCcpCgogICAgdGhpcy5nY2luZyA9IGZhbHNlCiAgICB0aGlzLnN0YXRlLnRvcGljcy5kZWxldGUoaGV4KQogICAgdGhpcy5zdGF0ZS5fcmVtb3ZlR0ModGhpcykKCiAgICBmb3IgKGxldCBpID0gdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICB0aGlzLnN0YXRlLnN0YXRzLnNlc3Npb25zQ2xvc2VkKysKICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbaV0KICAgICAgaWYgKHNlc3Npb24uaGFuZGxlcnMub25kZXN0cm95KSBzZXNzaW9uLmhhbmRsZXJzLm9uZGVzdHJveShzZXNzaW9uKQogICAgfQogIH0KCiAgYWRkU3RyZWFtKHN0cmVhbSkgewogICAgdGhpcy5fb25vcGVuKGdldE11eGVyKHN0cmVhbSksIGZhbHNlKQogIH0KCiAgX3Byb3ZlQ2FwYWJpbGl0eVRvKHN0cmVhbSkgewogICAgcmV0dXJuIHRoaXMuX21ha2VDYXBhYmlsaXR5KHN0cmVhbS5pc0luaXRpYXRvciwgc3RyZWFtLmhhbmRzaGFrZUhhc2gpCiAgfQoKICBfbWFrZUNhcGFiaWxpdHkoaXNJbml0aWF0b3IsIGhhbmRzaGFrZUhhc2gpIHsKICAgIHJldHVybiBjcnlwdG8uaGFzaChbaXNJbml0aWF0b3IgPyBOU19JTklUQVRPUiA6IE5TX1JFU1BPTkRFUiwgdGhpcy5jYXBhYmlsaXR5LCBoYW5kc2hha2VIYXNoXSkKICB9CgogIF9hZGRQZWVyKHBlZXIsIG9wZW4pIHsKICAgIGlmICgKICAgICAgIWI0YS5lcXVhbHMoCiAgICAgICAgb3Blbi5jYXBhYmlsaXR5LAogICAgICAgIHRoaXMuX21ha2VDYXBhYmlsaXR5KCFwZWVyLnN0cmVhbS5pc0luaXRpYXRvciwgcGVlci5zdHJlYW0uaGFuZHNoYWtlSGFzaCkKICAgICAgKQogICAgKSB7CiAgICAgIHBlZXIuY2hhbm5lbC5jbG9zZSgpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChwZWVyLnBlbmRpbmcpIHsKICAgICAgcGVlci51bmxpbmsodGhpcy5wZW5kaW5nUGVlcnMpCiAgICB9CgogICAgcGVlci5hY3RpdmUgPSBvcGVuLmFjdGl2ZQogICAgcGVlci5wZW5kaW5nID0gZmFsc2UKICAgIHBlZXIuaW5kZXggPSB0aGlzLnBlZXJzLnB1c2gocGVlcikgLSAxCgogICAgaWYgKHBlZXIuYWN0aXZlKSB7CiAgICAgIHRoaXMuYWN0aXZlUGVlcnMrKwogICAgICB0aGlzLl9jaGVja0dDKCkKICAgIH0KCiAgICBmb3IgKGxldCBpID0gdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5zZXNzaW9uc1tpXQogICAgICBjb25zdCBoYW5kbGVycyA9IHNlc3Npb24uaGFuZGxlcnMKCiAgICAgIGlmIChoYW5kbGVycy5vbnBlZXJhZGQpIGhhbmRsZXJzLm9ucGVlcmFkZChwZWVyLCBzZXNzaW9uKQogICAgICBpZiAocGVlci5hY3RpdmUgJiYgaGFuZGxlcnMub25wZWVyYWN0aXZlKSBoYW5kbGVycy5vbnBlZXJhY3RpdmUocGVlciwgc2Vzc2lvbikKICAgIH0KICB9CgogIF9jaGVja0dDKCkgewogICAgY29uc3Qgc2hvdWxkR0MgPSB0aGlzLmFjdGl2ZVBlZXJzID09PSAwICYmIHRoaXMuc2Vzc2lvbnMubGVuZ3RoID09PSAwCgogICAgaWYgKHNob3VsZEdDKSB7CiAgICAgIGlmICghdGhpcy5nY2luZykgewogICAgICAgIHRoaXMuZ2NpbmcgPSB0cnVlCiAgICAgICAgdGhpcy5zdGF0ZS5fYWRkR0ModGhpcykKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKHRoaXMuZ2NpbmcpIHsKICAgICAgICB0aGlzLmdjaW5nID0gZmFsc2UKICAgICAgICB0aGlzLnN0YXRlLl9yZW1vdmVHQyh0aGlzKQogICAgICB9CiAgICB9CiAgfQoKICBfcmVtb3ZlUGVlcihwZWVyKSB7CiAgICB0aGlzLnN0YXRlLnN0YXRzLnBlZXJzUmVtb3ZlZCsrCiAgICBwZWVyLnJlbW92ZWQgPSB0cnVlCiAgICB0aGlzLnBlZXJzQnlTdHJlYW0uZGVsZXRlKHBlZXIuc3RyZWFtKQoKICAgIGlmIChwZWVyLnBlbmRpbmcpIHsKICAgICAgcGVlci51bmxpbmsodGhpcy5wZW5kaW5nUGVlcnMpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IGFjdGl2ZSA9IHBlZXIuYWN0aXZlCgogICAgaWYgKGFjdGl2ZSkgewogICAgICBwZWVyLmFjdGl2ZSA9IGZhbHNlCiAgICAgIHRoaXMuYWN0aXZlUGVlcnMtLQogICAgICB0aGlzLl9jaGVja0dDKCkKICAgIH0KCiAgICBwZWVyLnVubGluayh0aGlzLnBlZXJzKQoKICAgIGZvciAobGV0IGkgPSB0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zW2ldCiAgICAgIGNvbnN0IGhhbmRsZXJzID0gc2Vzc2lvbi5oYW5kbGVycwoKICAgICAgaWYgKGFjdGl2ZSAmJiBoYW5kbGVycy5vbnBlZXJpbmFjdGl2ZSkgaGFuZGxlcnMub25wZWVyaW5hY3RpdmUocGVlciwgc2Vzc2lvbikKICAgICAgaWYgKGhhbmRsZXJzLm9ucGVlcnJlbW92ZSkgaGFuZGxlcnMub25wZWVycmVtb3ZlKHBlZXIsIHNlc3Npb24pCiAgICB9CiAgfQoKICBfb25hbm5vdW5jZSh3YWtldXAsIHBlZXIpIHsKICAgIGZvciAobGV0IGkgPSB0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zW2ldCiAgICAgIGNvbnN0IGhhbmRsZXJzID0gc2Vzc2lvbi5oYW5kbGVycwoKICAgICAgaWYgKGhhbmRsZXJzLm9uYW5ub3VuY2UpIGhhbmRsZXJzLm9uYW5ub3VuY2Uod2FrZXVwLCBwZWVyLCBzZXNzaW9uKQogICAgfQogIH0KCiAgX29ubG9va3VwKHJlcSwgcGVlcikgewogICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbaV0KICAgICAgY29uc3QgaGFuZGxlcnMgPSBzZXNzaW9uLmhhbmRsZXJzCgogICAgICBpZiAoaGFuZGxlcnMub25sb29rdXApIGhhbmRsZXJzLm9ubG9va3VwKHJlcSwgcGVlciwgc2Vzc2lvbikKICAgIH0KICB9CgogIF9vbmluZm8oaW5mbywgcGVlcikgewogICAgaWYgKGluZm8uYWN0aXZlKSB7CiAgICAgIGlmICghcGVlci5hY3RpdmUpIHsKICAgICAgICBwZWVyLmFjdGl2ZSA9IHRydWUKICAgICAgICB0aGlzLmFjdGl2ZVBlZXJzKysKICAgICAgICB0aGlzLl9jaGVja0dDKCkKCiAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zW2ldCiAgICAgICAgICBjb25zdCBoYW5kbGVycyA9IHNlc3Npb24uaGFuZGxlcnMKCiAgICAgICAgICBpZiAoaGFuZGxlcnMub25wZWVyYWN0aXZlKSBoYW5kbGVycy5vbnBlZXJhY3RpdmUocGVlciwgc2Vzc2lvbikKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChwZWVyLmFjdGl2ZSkgewogICAgICAgIHBlZXIuYWN0aXZlID0gZmFsc2UKICAgICAgICB0aGlzLmFjdGl2ZVBlZXJzLS0KICAgICAgICB0aGlzLl9jaGVja0dDKCkKCiAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zW2ldCiAgICAgICAgICBjb25zdCBoYW5kbGVycyA9IHNlc3Npb24uaGFuZGxlcnMKCiAgICAgICAgICBpZiAoaGFuZGxlcnMub25wZWVyaW5hY3RpdmUpIGhhbmRsZXJzLm9ucGVlcmluYWN0aXZlKHBlZXIsIHNlc3Npb24pCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBfb25vcGVuKG11eGVyLCB1bmlxdWUpIHsKICAgIGlmICghdW5pcXVlICYmIHRoaXMucGVlcnNCeVN0cmVhbS5oYXMobXV4ZXIuc3RyZWFtKSkgcmV0dXJuCgogICAgY29uc3QgcGVlciA9IG5ldyBXYWtldXBQZWVyKHRoaXMpCiAgICBjb25zdCBjaCA9IG11eGVyLmNyZWF0ZUNoYW5uZWwoewogICAgICB1c2VyRGF0YTogcGVlciwKICAgICAgcHJvdG9jb2w6ICd3YWtldXAnLAogICAgICBpZDogdGhpcy5pZCwKICAgICAgaGFuZHNoYWtlOiBIYW5kc2hha2UsCiAgICAgIG1lc3NhZ2VzOiBbCiAgICAgICAgeyBlbmNvZGluZzogTG9va3VwLCBvbm1lc3NhZ2U6IG9ubG9va3VwIH0sCiAgICAgICAgeyBlbmNvZGluZzogQW5ub3VuY2UsIG9ubWVzc2FnZTogb25hbm5vdW5jZSB9LAogICAgICAgIHsgZW5jb2Rpbmc6IEluZm8sIG9ubWVzc2FnZTogb25jaGFubmVsaW5mbyB9CiAgICAgIF0sCiAgICAgIG9ub3Blbjogb25jaGFubmVsb3BlbiwKICAgICAgb25jbG9zZTogb25jaGFubmVsY2xvc2UKICAgIH0pCgogICAgaWYgKCFjaCkgcmV0dXJuCgogICAgdGhpcy5zdGF0ZS5zdGF0cy5wZWVyc0FkZGVkKysKCiAgICBwZWVyLmNoYW5uZWwgPSBjaAogICAgcGVlci5zdHJlYW0gPSBtdXhlci5zdHJlYW0KCiAgICBwZWVyLndpcmVMb29rdXAgPSBjaC5tZXNzYWdlc1swXQogICAgcGVlci53aXJlQW5ub3VuY2UgPSBjaC5tZXNzYWdlc1sxXQogICAgcGVlci53aXJlSW5mbyA9IGNoLm1lc3NhZ2VzWzJdCgogICAgcGVlci5pbmRleCA9IHRoaXMucGVuZGluZ1BlZXJzLnB1c2gocGVlcikgLSAxCiAgICB0aGlzLnBlZXJzQnlTdHJlYW0uc2V0KG11eGVyLnN0cmVhbSwgcGVlcikKCiAgICBjaC5vcGVuKHsKICAgICAgdmVyc2lvbjogMCwKICAgICAgY2FwYWJpbGl0eTogdGhpcy5fcHJvdmVDYXBhYmlsaXR5VG8obXV4ZXIuc3RyZWFtKSwKICAgICAgYWN0aXZlOiB0aGlzLmlzQWN0aXZlCiAgICB9KQogIH0KfQoKZnVuY3Rpb24gb25jaGFubmVsb3BlbihvcGVuLCBjaGFubmVsKSB7CiAgY29uc3QgcGVlciA9IGNoYW5uZWwudXNlckRhdGEKICBwZWVyLnRvcGljLl9hZGRQZWVyKHBlZXIsIG9wZW4pCn0KCmZ1bmN0aW9uIG9uY2hhbm5lbGNsb3NlKGNsb3NlLCBjaGFubmVsKSB7CiAgY29uc3QgcGVlciA9IGNoYW5uZWwudXNlckRhdGEKICBwZWVyLnRvcGljLl9yZW1vdmVQZWVyKHBlZXIpCn0KCmZ1bmN0aW9uIG9ubG9va3VwKHJlcSwgY2hhbm5lbCkgewogIGNvbnN0IHBlZXIgPSBjaGFubmVsLnVzZXJEYXRhCiAgcGVlci50b3BpYy5zdGF0ZS5zdGF0cy53aXJlTG9va3VwLnJ4KysKICBwZWVyLnRvcGljLl9vbmxvb2t1cChyZXEsIHBlZXIpCn0KCmZ1bmN0aW9uIG9uYW5ub3VuY2Uod2FrZXVwLCBjaGFubmVsKSB7CiAgY29uc3QgcGVlciA9IGNoYW5uZWwudXNlckRhdGEKICBwZWVyLnRvcGljLnN0YXRlLnN0YXRzLndpcmVBbm5vdW5jZS5yeCsrCiAgcGVlci50b3BpYy5fb25hbm5vdW5jZSh3YWtldXAsIHBlZXIpCn0KCmZ1bmN0aW9uIG9uY2hhbm5lbGluZm8oaW5mbywgY2hhbm5lbCkgewogIGNvbnN0IHBlZXIgPSBjaGFubmVsLnVzZXJEYXRhCiAgcGVlci50b3BpYy5zdGF0ZS5zdGF0cy53aXJlSW5mby5yeCsrCiAgcGVlci50b3BpYy5fb25pbmZvKGluZm8sIHBlZXIpCn0KCmZ1bmN0aW9uIGdldE11eGVyKHN0cmVhbSkgewogIGlmIChQcm90b211eC5pc1Byb3RvbXV4KHN0cmVhbSkpIHJldHVybiBzdHJlYW0KICBpZiAoc3RyZWFtLm5vaXNlU3RyZWFtLnVzZXJEYXRhKSByZXR1cm4gc3RyZWFtLm5vaXNlU3RyZWFtLnVzZXJEYXRhCiAgY29uc3QgbXV4ID0gUHJvdG9tdXguZnJvbShzdHJlYW0ubm9pc2VTdHJlYW0pCiAgc3RyZWFtLm5vaXNlU3RyZWFtLnVzZXJEYXRhID0gbXV4CiAgcmV0dXJuIG11eAp9CgpmdW5jdGlvbiBub29wKCkge30KewogICJuYW1lIjogInByb3RvbXV4LXdha2V1cCIsCiAgInZlcnNpb24iOiAiMi45LjAiLAogICJkZXNjcmlwdGlvbiI6ICJXYWtldXAgcHJvdG9jb2wgb3ZlciBwcm90b211eCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNyIsCiAgICAiaHlwZXJjb3JlLWNyeXB0byI6ICJeMy41LjAiLAogICAgImh5cGVyc2NoZW1hIjogIl4xLjEwLjQiLAogICAgInByb3RvbXV4IjogIl4zLjEwLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiAiXjYuOC4xIiwKICAgICJicml0dGxlIjogIl4zLjE3LjEiLAogICAgImx1bnRlIjogIl4xLjAuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIsCiAgICAicHJvbS1jbGllbnQiOiAiXjE1LjEuMyIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAic3BlYy9oeXBlcnNjaGVtYS8qLmpzIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAidGVzdCI6ICJwcmV0dGllciAtLWNoZWNrIC4gJiYgbHVudGUgJiYgYnJpdHRsZSB0ZXN0LyouanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9wcm90b211eC13YWtldXAuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2ggSW5jLiIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9wcm90b211eC13YWtldXAvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9wcm90b211eC13YWtldXAiCn0KLy8gVGhpcyBmaWxlIGlzIGF1dG9nZW5lcmF0ZWQgYnkgdGhlIGh5cGVyc2NoZW1hIGNvbXBpbGVyCi8vIFNjaGVtYSBWZXJzaW9uOiAxCi8qIGVzbGludC1kaXNhYmxlIGNhbWVsY2FzZSAqLwovKiBlc2xpbnQtZGlzYWJsZSBxdW90ZXMgKi8KCmNvbnN0IFZFUlNJT04gPSAxCmNvbnN0IHsgYyB9ID0gcmVxdWlyZSgnaHlwZXJzY2hlbWEvcnVudGltZScpCgovLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLXZhcnMKbGV0IHZlcnNpb24gPSBWRVJTSU9OCgovLyBAd2FrZXVwL2luZm8KY29uc3QgZW5jb2RpbmcwID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMSBzbyBhbHdheXMgb25lIGJ5dGUKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSBtLmFjdGl2ZSA/IDEgOiAwCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBhY3RpdmU6IChmbGFncyAmIDEpICE9PSAwCiAgICB9CiAgfQp9CgovLyBAd2FrZXVwL2hhbmRzaGFrZQpjb25zdCBlbmNvZGluZzEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmNhcGFiaWxpdHkpCiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAxIHNvIGFsd2F5cyBvbmUgYnl0ZQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IG0uYWN0aXZlID8gMSA6IDAKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmNhcGFiaWxpdHkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IHIwLAogICAgICBjYXBhYmlsaXR5OiByMSwKICAgICAgYWN0aXZlOiAoZmxhZ3MgJiAxKSAhPT0gMAogICAgfQogIH0KfQoKLy8gQHdha2V1cC93cml0ZXIKY29uc3QgZW5jb2RpbmcyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGtleTogcjAsCiAgICAgIGxlbmd0aDogcjEKICAgIH0KICB9Cn0KCi8vIEB3YWtldXAvYW5ub3VuY2UKY29uc3QgZW5jb2RpbmczID0gYy5hcnJheShlbmNvZGluZzIpCgovLyBAd2FrZXVwL2xvb2t1cApjb25zdCBlbmNvZGluZzQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAxIHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLmhhc2gpIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSBtLmhhc2ggPyAxIDogMAoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLmhhc2gpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGhhc2g6IChmbGFncyAmIDEpICE9PSAwID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBzZXRWZXJzaW9uKHYpIHsKICB2ZXJzaW9uID0gdgp9CgpmdW5jdGlvbiBlbmNvZGUobmFtZSwgdmFsdWUsIHYgPSBWRVJTSU9OKSB7CiAgdmVyc2lvbiA9IHYKICByZXR1cm4gYy5lbmNvZGUoZ2V0RW5jb2RpbmcobmFtZSksIHZhbHVlKQp9CgpmdW5jdGlvbiBkZWNvZGUobmFtZSwgYnVmZmVyLCB2ID0gVkVSU0lPTikgewogIHZlcnNpb24gPSB2CiAgcmV0dXJuIGMuZGVjb2RlKGdldEVuY29kaW5nKG5hbWUpLCBidWZmZXIpCn0KCmZ1bmN0aW9uIGdldEVudW0obmFtZSkgewogIHN3aXRjaCAobmFtZSkgewogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbnVtIG5vdCBmb3VuZCAnICsgbmFtZSkKICB9Cn0KCmZ1bmN0aW9uIGdldEVuY29kaW5nKG5hbWUpIHsKICBzd2l0Y2ggKG5hbWUpIHsKICAgIGNhc2UgJ0B3YWtldXAvaW5mbyc6CiAgICAgIHJldHVybiBlbmNvZGluZzAKICAgIGNhc2UgJ0B3YWtldXAvaGFuZHNoYWtlJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMQogICAgY2FzZSAnQHdha2V1cC93cml0ZXInOgogICAgICByZXR1cm4gZW5jb2RpbmcyCiAgICBjYXNlICdAd2FrZXVwL2Fubm91bmNlJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMwogICAgY2FzZSAnQHdha2V1cC9sb29rdXAnOgogICAgICByZXR1cm4gZW5jb2Rpbmc0CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY29kZXIgbm90IGZvdW5kICcgKyBuYW1lKQogIH0KfQoKZnVuY3Rpb24gZ2V0U3RydWN0KG5hbWUsIHYgPSBWRVJTSU9OKSB7CiAgY29uc3QgZW5jID0gZ2V0RW5jb2RpbmcobmFtZSkKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIHZlcnNpb24gPSB2CiAgICAgIGVuYy5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIHZlcnNpb24gPSB2CiAgICAgIGVuYy5lbmNvZGUoc3RhdGUsIG0pCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIHZlcnNpb24gPSB2CiAgICAgIHJldHVybiBlbmMuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVzb2x2ZVN0cnVjdCA9IGdldFN0cnVjdCAvLyBjb21wYXQKCm1vZHVsZS5leHBvcnRzID0gewogIHJlc29sdmVTdHJ1Y3QsCiAgZ2V0U3RydWN0LAogIGdldEVudW0sCiAgZ2V0RW5jb2RpbmcsCiAgZW5jb2RlLAogIGRlY29kZSwKICBzZXRWZXJzaW9uLAogIHZlcnNpb24KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IHF1ZXVlVGljayA9IHJlcXVpcmUoJ3F1ZXVlLXRpY2snKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IHVuc2xhYiA9IHJlcXVpcmUoJ3Vuc2xhYicpCgpjb25zdCBNQVhfQlVGRkVSRUQgPSAzMjc2OApjb25zdCBNQVhfQkFDS0xPRyA9IEluZmluaXR5IC8vIFRPRE86IGltcGwgIm9wZW4iIGJhY2twcmVzc3VyZQpjb25zdCBNQVhfQkFUQ0ggPSA4ICogMTAyNCAqIDEwMjQKCmNsYXNzIENoYW5uZWwgewogIGNvbnN0cnVjdG9yIChtdXgsIGluZm8sIHVzZXJEYXRhLCBwcm90b2NvbCwgYWxpYXNlcywgaWQsIGhhbmRzaGFrZSwgbWVzc2FnZXMsIG9ub3Blbiwgb25jbG9zZSwgb25kZXN0cm95LCBvbmRyYWluKSB7CiAgICB0aGlzLnVzZXJEYXRhID0gdXNlckRhdGEKICAgIHRoaXMucHJvdG9jb2wgPSBwcm90b2NvbAogICAgdGhpcy5hbGlhc2VzID0gYWxpYXNlcwogICAgdGhpcy5pZCA9IGlkCiAgICB0aGlzLmhhbmRzaGFrZSA9IG51bGwKICAgIHRoaXMubWVzc2FnZXMgPSBbXQoKICAgIHRoaXMub3BlbmVkID0gZmFsc2UKICAgIHRoaXMuY2xvc2VkID0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKCiAgICB0aGlzLm9ub3BlbiA9IG9ub3BlbgogICAgdGhpcy5vbmNsb3NlID0gb25jbG9zZQogICAgdGhpcy5vbmRlc3Ryb3kgPSBvbmRlc3Ryb3kKICAgIHRoaXMub25kcmFpbiA9IG9uZHJhaW4KCiAgICB0aGlzLl9oYW5kc2hha2UgPSBoYW5kc2hha2UKICAgIHRoaXMuX211eCA9IG11eAogICAgdGhpcy5faW5mbyA9IGluZm8KICAgIHRoaXMuX2xvY2FsSWQgPSAwCiAgICB0aGlzLl9yZW1vdGVJZCA9IDAKICAgIHRoaXMuX2FjdGl2ZSA9IDAKICAgIHRoaXMuX2V4dGVuc2lvbnMgPSBudWxsCgogICAgdGhpcy5fZGVjQm91bmQgPSB0aGlzLl9kZWMuYmluZCh0aGlzKQogICAgdGhpcy5fZGVjQW5kRGVzdHJveUJvdW5kID0gdGhpcy5fZGVjQW5kRGVzdHJveS5iaW5kKHRoaXMpCgogICAgdGhpcy5fb3BlbmVkUHJvbWlzZSA9IG51bGwKICAgIHRoaXMuX29wZW5lZFJlc29sdmUgPSBudWxsCgogICAgdGhpcy5fZGVzdHJveWVkUHJvbWlzZSA9IG51bGwKICAgIHRoaXMuX2Rlc3Ryb3llZFJlc29sdmUgPSBudWxsCgogICAgZm9yIChjb25zdCBtIG9mIG1lc3NhZ2VzKSB0aGlzLmFkZE1lc3NhZ2UobSkKICB9CgogIGdldCBkcmFpbmVkICgpIHsKICAgIHJldHVybiB0aGlzLl9tdXguZHJhaW5lZAogIH0KCiAgZnVsbHlPcGVuZWQgKCkgewogICAgaWYgKHRoaXMub3BlbmVkKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRydWUpCiAgICBpZiAodGhpcy5jbG9zZWQpIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpCiAgICBpZiAodGhpcy5fb3BlbmVkUHJvbWlzZSkgcmV0dXJuIHRoaXMuX29wZW5lZFByb21pc2UKCiAgICB0aGlzLl9vcGVuZWRQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsgdGhpcy5fb3BlbmVkUmVzb2x2ZSA9IHJlc29sdmUgfSkKICAgIHJldHVybiB0aGlzLl9vcGVuZWRQcm9taXNlCiAgfQoKICBmdWxseUNsb3NlZCAoKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZFByb21pc2UpIHJldHVybiB0aGlzLl9kZXN0cm95ZWRQcm9taXNlCgogICAgdGhpcy5fZGVzdHJveWVkUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7IHRoaXMuX2Rlc3Ryb3llZFJlc29sdmUgPSByZXNvbHZlIH0pCiAgICByZXR1cm4gdGhpcy5fZGVzdHJveWVkUHJvbWlzZQogIH0KCiAgb3BlbiAoaGFuZHNoYWtlKSB7CiAgICBjb25zdCBpZCA9IHRoaXMuX211eC5fZnJlZS5sZW5ndGggPiAwCiAgICAgID8gdGhpcy5fbXV4Ll9mcmVlLnBvcCgpCiAgICAgIDogdGhpcy5fbXV4Ll9sb2NhbC5wdXNoKG51bGwpIC0gMQoKICAgIHRoaXMuX2luZm8ub3BlbmVkKysKICAgIHRoaXMuX2luZm8ubGFzdENoYW5uZWwgPSB0aGlzCiAgICB0aGlzLl9sb2NhbElkID0gaWQgKyAxCiAgICB0aGlzLl9tdXguX2xvY2FsW2lkXSA9IHRoaXMKCiAgICBpZiAodGhpcy5fcmVtb3RlSWQgPT09IDApIHsKICAgICAgdGhpcy5faW5mby5vdXRnb2luZy5wdXNoKHRoaXMuX2xvY2FsSWQpCiAgICB9CgogICAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlcjogbnVsbCwgc3RhcnQ6IDIsIGVuZDogMiB9CgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdGhpcy5fbG9jYWxJZCkKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgdGhpcy5wcm90b2NvbCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdGhpcy5pZCkKICAgIGlmICh0aGlzLl9oYW5kc2hha2UpIHRoaXMuX2hhbmRzaGFrZS5wcmVlbmNvZGUoc3RhdGUsIGhhbmRzaGFrZSkKCiAgICBzdGF0ZS5idWZmZXIgPSB0aGlzLl9tdXguX2FsbG9jKHN0YXRlLmVuZCkKCiAgICBzdGF0ZS5idWZmZXJbMF0gPSAwCiAgICBzdGF0ZS5idWZmZXJbMV0gPSAxCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB0aGlzLl9sb2NhbElkKQogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCB0aGlzLnByb3RvY29sKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB0aGlzLmlkKQogICAgaWYgKHRoaXMuX2hhbmRzaGFrZSkgdGhpcy5faGFuZHNoYWtlLmVuY29kZShzdGF0ZSwgaGFuZHNoYWtlKQoKICAgIHRoaXMuX211eC5fd3JpdGUwKHN0YXRlLmJ1ZmZlcikKICB9CgogIF9kZWMgKCkgewogICAgaWYgKC0tdGhpcy5fYWN0aXZlID09PSAwICYmIHRoaXMuY2xvc2VkID09PSB0cnVlKSB0aGlzLl9kZXN0cm95KCkKICB9CgogIF9kZWNBbmREZXN0cm95IChlcnIpIHsKICAgIHRoaXMuX2RlYygpCiAgICB0aGlzLl9tdXguX3NhZmVEZXN0cm95KGVycikKICB9CgogIF9mdWxseU9wZW5Tb29uICgpIHsKICAgIHRoaXMuX211eC5fcmVtb3RlW3RoaXMuX3JlbW90ZUlkIC0gMV0uc2Vzc2lvbiA9IHRoaXMKICAgIHF1ZXVlVGljayh0aGlzLl9mdWxseU9wZW4uYmluZCh0aGlzKSkKICB9CgogIF9mdWxseU9wZW4gKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSB0cnVlIHx8IHRoaXMuY2xvc2VkID09PSB0cnVlKSByZXR1cm4KCiAgICBjb25zdCByZW1vdGUgPSB0aGlzLl9tdXguX3JlbW90ZVt0aGlzLl9yZW1vdGVJZCAtIDFdCgogICAgdGhpcy5vcGVuZWQgPSB0cnVlCiAgICB0aGlzLmhhbmRzaGFrZSA9IHRoaXMuX2hhbmRzaGFrZSA/IHRoaXMuX2hhbmRzaGFrZS5kZWNvZGUocmVtb3RlLnN0YXRlKSA6IG51bGwKICAgIHRoaXMuX3RyYWNrKHRoaXMub25vcGVuKHRoaXMuaGFuZHNoYWtlLCB0aGlzKSkKCiAgICByZW1vdGUuc2Vzc2lvbiA9IHRoaXMKICAgIHJlbW90ZS5zdGF0ZSA9IG51bGwKICAgIGlmIChyZW1vdGUucGVuZGluZyAhPT0gbnVsbCkgdGhpcy5fZHJhaW4ocmVtb3RlKQoKICAgIHRoaXMuX3Jlc29sdmVPcGVuKHRydWUpCiAgfQoKICBfcmVzb2x2ZU9wZW4gKG9wZW5lZCkgewogICAgaWYgKHRoaXMuX29wZW5lZFJlc29sdmUgIT09IG51bGwpIHsKICAgICAgdGhpcy5fb3BlbmVkUmVzb2x2ZShvcGVuZWQpCiAgICAgIHRoaXMuX29wZW5lZFJlc29sdmUgPSB0aGlzLl9vcGVuZWRQcm9taXNlID0gbnVsbAogICAgfQogIH0KCiAgX3Jlc29sdmVEZXN0cm95ZWQgKCkgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZFJlc29sdmUgIT09IG51bGwpIHsKICAgICAgdGhpcy5fZGVzdHJveWVkUmVzb2x2ZSgpCiAgICAgIHRoaXMuX2Rlc3Ryb3llZFJlc29sdmUgPSB0aGlzLl9kZXN0cm95ZWRQcm9taXNlID0gbnVsbAogICAgfQogIH0KCiAgX2RyYWluIChyZW1vdGUpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVtb3RlLnBlbmRpbmcubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcCA9IHJlbW90ZS5wZW5kaW5nW2ldCiAgICAgIHRoaXMuX211eC5fYnVmZmVyZWQgLT0gYnl0ZVNpemUocC5zdGF0ZSkKICAgICAgdGhpcy5fcmVjdihwLnR5cGUsIHAuc3RhdGUpCiAgICB9CgogICAgcmVtb3RlLnBlbmRpbmcgPSBudWxsCiAgICB0aGlzLl9tdXguX3Jlc3VtZU1heWJlKCkKICB9CgogIF90cmFjayAocCkgewogICAgaWYgKGlzUHJvbWlzZShwKSA9PT0gdHJ1ZSkgewogICAgICB0aGlzLl9hY3RpdmUrKwogICAgICByZXR1cm4gcC50aGVuKHRoaXMuX2RlY0JvdW5kLCB0aGlzLl9kZWNBbmREZXN0cm95Qm91bmQpCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIF9jbG9zZSAoaXNSZW1vdGUpIHsKICAgIGlmICh0aGlzLmNsb3NlZCA9PT0gdHJ1ZSkgcmV0dXJuCiAgICB0aGlzLmNsb3NlZCA9IHRydWUKCiAgICB0aGlzLl9pbmZvLm9wZW5lZC0tCiAgICBpZiAodGhpcy5faW5mby5sYXN0Q2hhbm5lbCA9PT0gdGhpcykgdGhpcy5faW5mby5sYXN0Q2hhbm5lbCA9IG51bGwKCiAgICBpZiAodGhpcy5fcmVtb3RlSWQgPiAwKSB7CiAgICAgIHRoaXMuX211eC5fcmVtb3RlW3RoaXMuX3JlbW90ZUlkIC0gMV0gPSBudWxsCiAgICAgIHRoaXMuX3JlbW90ZUlkID0gMAogICAgICAvLyBJZiByZW1vdGUgaGFzIGFja2VkLCB3ZSBjYW4gcmV1c2UgdGhlIGxvY2FsIGlkIG5vdwogICAgICAvLyBvdGhlcndpc2UsIHdlIG5lZWQgdG8gd2FpdCBmb3IgdGhlICJhY2siIHRvIGFycml2ZQogICAgICB0aGlzLl9tdXguX2ZyZWUucHVzaCh0aGlzLl9sb2NhbElkIC0gMSkKICAgIH0KCiAgICB0aGlzLl9tdXguX2xvY2FsW3RoaXMuX2xvY2FsSWQgLSAxXSA9IG51bGwKICAgIHRoaXMuX2xvY2FsSWQgPSAwCgogICAgdGhpcy5fbXV4Ll9nYyh0aGlzLl9pbmZvKQogICAgdGhpcy5fdHJhY2sodGhpcy5vbmNsb3NlKGlzUmVtb3RlLCB0aGlzKSkKCiAgICBpZiAodGhpcy5fYWN0aXZlID09PSAwKSB0aGlzLl9kZXN0cm95KCkKCiAgICB0aGlzLl9yZXNvbHZlT3BlbihmYWxzZSkKICB9CgogIF9kZXN0cm95ICgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCA9PT0gdHJ1ZSkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICAgIHRoaXMuX3RyYWNrKHRoaXMub25kZXN0cm95KHRoaXMpKQogICAgdGhpcy5fcmVzb2x2ZURlc3Ryb3llZCgpCiAgfQoKICBfcmVjdiAodHlwZSwgc3RhdGUpIHsKICAgIGlmICh0eXBlIDwgdGhpcy5tZXNzYWdlcy5sZW5ndGgpIHsKICAgICAgY29uc3QgbSA9IHRoaXMubWVzc2FnZXNbdHlwZV0KICAgICAgY29uc3QgcCA9IG0ucmVjdihzdGF0ZSwgdGhpcykKICAgICAgaWYgKG0uYXV0b0JhdGNoID09PSB0cnVlKSByZXR1cm4gcAogICAgfQogICAgcmV0dXJuIG51bGwKICB9CgogIGNvcmsgKCkgewogICAgdGhpcy5fbXV4LmNvcmsoKQogIH0KCiAgdW5jb3JrICgpIHsKICAgIHRoaXMuX211eC51bmNvcmsoKQogIH0KCiAgY2xvc2UgKCkgewogICAgaWYgKHRoaXMuY2xvc2VkID09PSB0cnVlKSByZXR1cm4KCiAgICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyOiBudWxsLCBzdGFydDogMiwgZW5kOiAyIH0KCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB0aGlzLl9sb2NhbElkKQoKICAgIHN0YXRlLmJ1ZmZlciA9IHRoaXMuX211eC5fYWxsb2Moc3RhdGUuZW5kKQoKICAgIHN0YXRlLmJ1ZmZlclswXSA9IDAKICAgIHN0YXRlLmJ1ZmZlclsxXSA9IDMKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHRoaXMuX2xvY2FsSWQpCgogICAgdGhpcy5fY2xvc2UoZmFsc2UpCiAgICB0aGlzLl9tdXguX3dyaXRlMChzdGF0ZS5idWZmZXIpCiAgfQoKICBhZGRNZXNzYWdlIChvcHRzKSB7CiAgICBpZiAoIW9wdHMpIHJldHVybiB0aGlzLl9za2lwTWVzc2FnZSgpCgogICAgY29uc3QgdHlwZSA9IHRoaXMubWVzc2FnZXMubGVuZ3RoCiAgICBjb25zdCBhdXRvQmF0Y2ggPSBvcHRzLmF1dG9CYXRjaCAhPT0gZmFsc2UKICAgIGNvbnN0IGVuY29kaW5nID0gb3B0cy5lbmNvZGluZyB8fCBjLnJhdwogICAgY29uc3Qgb25tZXNzYWdlID0gb3B0cy5vbm1lc3NhZ2UgfHwgbm9vcAoKICAgIGNvbnN0IHMgPSB0aGlzCiAgICBjb25zdCB0eXBlTGVuID0gZW5jb2RpbmdMZW5ndGgoYy51aW50LCB0eXBlKQoKICAgIGNvbnN0IG0gPSB7CiAgICAgIHR5cGUsCiAgICAgIGF1dG9CYXRjaCwKICAgICAgZW5jb2RpbmcsCiAgICAgIG9ubWVzc2FnZSwKICAgICAgcmVjdiAoc3RhdGUsIHNlc3Npb24pIHsKICAgICAgICByZXR1cm4gc2Vzc2lvbi5fdHJhY2sobS5vbm1lc3NhZ2UoZW5jb2RpbmcuZGVjb2RlKHN0YXRlKSwgc2Vzc2lvbikpCiAgICAgIH0sCiAgICAgIHNlbmQgKG0sIHNlc3Npb24gPSBzKSB7CiAgICAgICAgaWYgKHNlc3Npb24uY2xvc2VkID09PSB0cnVlKSByZXR1cm4gZmFsc2UKCiAgICAgICAgY29uc3QgbXV4ID0gc2Vzc2lvbi5fbXV4CiAgICAgICAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlcjogbnVsbCwgc3RhcnQ6IDAsIGVuZDogdHlwZUxlbiB9CgogICAgICAgIGlmIChtdXguX2JhdGNoICE9PSBudWxsKSB7CiAgICAgICAgICBlbmNvZGluZy5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgICBzdGF0ZS5idWZmZXIgPSBtdXguX2FsbG9jKHN0YXRlLmVuZCkKCiAgICAgICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB0eXBlKQogICAgICAgICAgZW5jb2RpbmcuZW5jb2RlKHN0YXRlLCBtKQoKICAgICAgICAgIG11eC5fcHVzaEJhdGNoKHNlc3Npb24uX2xvY2FsSWQsIHN0YXRlLmJ1ZmZlcikKICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgfQoKICAgICAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBzZXNzaW9uLl9sb2NhbElkKQogICAgICAgIGVuY29kaW5nLnByZWVuY29kZShzdGF0ZSwgbSkKCiAgICAgICAgc3RhdGUuYnVmZmVyID0gbXV4Ll9hbGxvYyhzdGF0ZS5lbmQpCgogICAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHNlc3Npb24uX2xvY2FsSWQpCiAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgdHlwZSkKICAgICAgICBlbmNvZGluZy5lbmNvZGUoc3RhdGUsIG0pCgogICAgICAgIG11eC5kcmFpbmVkID0gbXV4LnN0cmVhbS53cml0ZShzdGF0ZS5idWZmZXIpCgogICAgICAgIHJldHVybiBtdXguZHJhaW5lZAogICAgICB9CiAgICB9CgogICAgdGhpcy5tZXNzYWdlcy5wdXNoKG0pCgogICAgcmV0dXJuIG0KICB9CgogIF9za2lwTWVzc2FnZSAoKSB7CiAgICBjb25zdCB0eXBlID0gdGhpcy5tZXNzYWdlcy5sZW5ndGgKICAgIGNvbnN0IG0gPSB7CiAgICAgIHR5cGUsCiAgICAgIGVuY29kaW5nOiBjLnJhdywKICAgICAgb25tZXNzYWdlOiBub29wLAogICAgICByZWN2IChzdGF0ZSwgc2Vzc2lvbikge30sCiAgICAgIHNlbmQgKG0sIHNlc3Npb24pIHt9CiAgICB9CgogICAgdGhpcy5tZXNzYWdlcy5wdXNoKG0pCiAgICByZXR1cm4gbQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBQcm90b211eCB7CiAgY29uc3RydWN0b3IgKHN0cmVhbSwgeyBhbGxvYyB9ID0ge30pIHsKICAgIGlmIChzdHJlYW0udXNlckRhdGEgPT09IG51bGwpIHN0cmVhbS51c2VyRGF0YSA9IHRoaXMKCiAgICB0aGlzLmlzUHJvdG9tdXggPSB0cnVlCiAgICB0aGlzLnN0cmVhbSA9IHN0cmVhbQogICAgdGhpcy5jb3JrZWQgPSAwCiAgICB0aGlzLmRyYWluZWQgPSB0cnVlCgogICAgdGhpcy5fYWxsb2MgPSBhbGxvYyB8fCAodHlwZW9mIHN0cmVhbS5hbGxvYyA9PT0gJ2Z1bmN0aW9uJyA/IHN0cmVhbS5hbGxvYy5iaW5kKHN0cmVhbSkgOiBiNGEuYWxsb2NVbnNhZmUpCiAgICB0aGlzLl9zYWZlRGVzdHJveUJvdW5kID0gdGhpcy5fc2FmZURlc3Ryb3kuYmluZCh0aGlzKQogICAgdGhpcy5fdW5jb3JrQm91bmQgPSB0aGlzLnVuY29yay5iaW5kKHRoaXMpCgogICAgdGhpcy5fcmVtb3RlQmFja2xvZyA9IDAKICAgIHRoaXMuX2J1ZmZlcmVkID0gMAogICAgdGhpcy5fcGF1c2VkID0gZmFsc2UKICAgIHRoaXMuX3JlbW90ZSA9IFtdCiAgICB0aGlzLl9sb2NhbCA9IFtdCiAgICB0aGlzLl9mcmVlID0gW10KICAgIHRoaXMuX2JhdGNoID0gbnVsbAogICAgdGhpcy5fYmF0Y2hTdGF0ZSA9IG51bGwKCiAgICB0aGlzLl9pbmZvcyA9IG5ldyBNYXAoKQogICAgdGhpcy5fbm90aWZ5ID0gbmV3IE1hcCgpCgogICAgdGhpcy5zdHJlYW0ub24oJ2RhdGEnLCB0aGlzLl9vbmRhdGEuYmluZCh0aGlzKSkKICAgIHRoaXMuc3RyZWFtLm9uKCdkcmFpbicsIHRoaXMuX29uZHJhaW4uYmluZCh0aGlzKSkKICAgIHRoaXMuc3RyZWFtLm9uKCdlbmQnLCB0aGlzLl9vbmVuZC5iaW5kKHRoaXMpKQogICAgdGhpcy5zdHJlYW0ub24oJ2Vycm9yJywgbm9vcCkgLy8gd2UgaGFuZGxlIHRoaXMgaW4gImNsb3NlIgogICAgdGhpcy5zdHJlYW0ub24oJ2Nsb3NlJywgdGhpcy5fc2h1dGRvd24uYmluZCh0aGlzKSkKICB9CgogIHN0YXRpYyBmcm9tIChzdHJlYW0sIG9wdHMpIHsKICAgIGlmIChzdHJlYW0udXNlckRhdGEgJiYgc3RyZWFtLnVzZXJEYXRhLmlzUHJvdG9tdXgpIHJldHVybiBzdHJlYW0udXNlckRhdGEKICAgIGlmIChzdHJlYW0uaXNQcm90b211eCkgcmV0dXJuIHN0cmVhbQogICAgcmV0dXJuIG5ldyB0aGlzKHN0cmVhbSwgb3B0cykKICB9CgogIHN0YXRpYyBpc1Byb3RvbXV4IChtdXgpIHsKICAgIHJldHVybiB0eXBlb2YgbXV4ID09PSAnb2JqZWN0JyAmJiBtdXguaXNQcm90b211eCA9PT0gdHJ1ZQogIH0KCiAgKiBbU3ltYm9sLml0ZXJhdG9yXSAoKSB7CiAgICBmb3IgKGNvbnN0IHNlc3Npb24gb2YgdGhpcy5fbG9jYWwpIHsKICAgICAgaWYgKHNlc3Npb24gIT09IG51bGwpIHlpZWxkIHNlc3Npb24KICAgIH0KICB9CgogIGlzSWRsZSAoKSB7CiAgICByZXR1cm4gdGhpcy5fbG9jYWwubGVuZ3RoID09PSB0aGlzLl9mcmVlLmxlbmd0aAogIH0KCiAgY29yayAoKSB7CiAgICBpZiAoKyt0aGlzLmNvcmtlZCA9PT0gMSkgewogICAgICB0aGlzLl9iYXRjaCA9IFtdCiAgICAgIHRoaXMuX2JhdGNoU3RhdGUgPSB7IGJ1ZmZlcjogbnVsbCwgc3RhcnQ6IDAsIGVuZDogMSB9CiAgICB9CiAgfQoKICB1bmNvcmsgKCkgewogICAgaWYgKC0tdGhpcy5jb3JrZWQgPT09IDApIHsKICAgICAgdGhpcy5fc2VuZEJhdGNoKHRoaXMuX2JhdGNoLCB0aGlzLl9iYXRjaFN0YXRlKQogICAgICB0aGlzLl9iYXRjaCA9IG51bGwKICAgICAgdGhpcy5fYmF0Y2hTdGF0ZSA9IG51bGwKICAgIH0KICB9CgogIGdldExhc3RDaGFubmVsICh7IHByb3RvY29sLCBpZCA9IG51bGwgfSkgewogICAgY29uc3Qga2V5ID0gdG9LZXkocHJvdG9jb2wsIGlkKQogICAgY29uc3QgaW5mbyA9IHRoaXMuX2luZm9zLmdldChrZXkpCiAgICBpZiAoaW5mbykgcmV0dXJuIGluZm8ubGFzdENoYW5uZWwKICAgIHJldHVybiBudWxsCiAgfQoKICBwYWlyICh7IHByb3RvY29sLCBpZCA9IG51bGwgfSwgbm90aWZ5KSB7CiAgICB0aGlzLl9ub3RpZnkuc2V0KHRvS2V5KHByb3RvY29sLCBpZCksIG5vdGlmeSkKICB9CgogIHVucGFpciAoeyBwcm90b2NvbCwgaWQgPSBudWxsIH0pIHsKICAgIHRoaXMuX25vdGlmeS5kZWxldGUodG9LZXkocHJvdG9jb2wsIGlkKSkKICB9CgogIG9wZW5lZCAoeyBwcm90b2NvbCwgaWQgPSBudWxsIH0pIHsKICAgIGNvbnN0IGtleSA9IHRvS2V5KHByb3RvY29sLCBpZCkKICAgIGNvbnN0IGluZm8gPSB0aGlzLl9pbmZvcy5nZXQoa2V5KQogICAgcmV0dXJuIGluZm8gPyBpbmZvLm9wZW5lZCA+IDAgOiBmYWxzZQogIH0KCiAgY3JlYXRlQ2hhbm5lbCAoeyB1c2VyRGF0YSA9IG51bGwsIHByb3RvY29sLCBhbGlhc2VzID0gW10sIGlkID0gbnVsbCwgdW5pcXVlID0gdHJ1ZSwgaGFuZHNoYWtlID0gbnVsbCwgbWVzc2FnZXMgPSBbXSwgb25vcGVuID0gbm9vcCwgb25jbG9zZSA9IG5vb3AsIG9uZGVzdHJveSA9IG5vb3AsIG9uZHJhaW4gPSBub29wIH0pIHsKICAgIGlmICh0aGlzLnN0cmVhbS5kZXN0cm95ZWQpIHJldHVybiBudWxsCgogICAgY29uc3QgaW5mbyA9IHRoaXMuX2dldChwcm90b2NvbCwgaWQsIGFsaWFzZXMpCiAgICBpZiAodW5pcXVlICYmIGluZm8ub3BlbmVkID4gMCkgcmV0dXJuIG51bGwKCiAgICBpZiAoaW5mby5pbmNvbWluZy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIG5ldyBDaGFubmVsKHRoaXMsIGluZm8sIHVzZXJEYXRhLCBwcm90b2NvbCwgYWxpYXNlcywgaWQsIGhhbmRzaGFrZSwgbWVzc2FnZXMsIG9ub3Blbiwgb25jbG9zZSwgb25kZXN0cm95LCBvbmRyYWluKQogICAgfQoKICAgIHRoaXMuX3JlbW90ZUJhY2tsb2ctLQoKICAgIGNvbnN0IHJlbW90ZUlkID0gaW5mby5pbmNvbWluZy5zaGlmdCgpCiAgICBjb25zdCByID0gdGhpcy5fcmVtb3RlW3JlbW90ZUlkIC0gMV0KICAgIGlmIChyID09PSBudWxsKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHNlc3Npb24gPSBuZXcgQ2hhbm5lbCh0aGlzLCBpbmZvLCB1c2VyRGF0YSwgcHJvdG9jb2wsIGFsaWFzZXMsIGlkLCBoYW5kc2hha2UsIG1lc3NhZ2VzLCBvbm9wZW4sIG9uY2xvc2UsIG9uZGVzdHJveSwgb25kcmFpbikKCiAgICBzZXNzaW9uLl9yZW1vdGVJZCA9IHJlbW90ZUlkCiAgICBzZXNzaW9uLl9mdWxseU9wZW5Tb29uKCkKCiAgICByZXR1cm4gc2Vzc2lvbgogIH0KCiAgX3B1c2hCYXRjaCAobG9jYWxJZCwgYnVmZmVyKSB7CiAgICBpZiAodGhpcy5fYmF0Y2hTdGF0ZS5lbmQgPj0gTUFYX0JBVENIKSB7CiAgICAgIHRoaXMuX3NlbmRCYXRjaCh0aGlzLl9iYXRjaCwgdGhpcy5fYmF0Y2hTdGF0ZSkKICAgICAgdGhpcy5fYmF0Y2ggPSBbXQogICAgICB0aGlzLl9iYXRjaFN0YXRlID0geyBidWZmZXI6IG51bGwsIHN0YXJ0OiAwLCBlbmQ6IDEgfQogICAgfQoKICAgIGlmICh0aGlzLl9iYXRjaC5sZW5ndGggPT09IDAgfHwgdGhpcy5fYmF0Y2hbdGhpcy5fYmF0Y2gubGVuZ3RoIC0gMV0ubG9jYWxJZCAhPT0gbG9jYWxJZCkgewogICAgICB0aGlzLl9iYXRjaFN0YXRlLmVuZCsrCiAgICAgIGMudWludC5wcmVlbmNvZGUodGhpcy5fYmF0Y2hTdGF0ZSwgbG9jYWxJZCkKICAgIH0KICAgIGMuYnVmZmVyLnByZWVuY29kZSh0aGlzLl9iYXRjaFN0YXRlLCBidWZmZXIpCiAgICB0aGlzLl9iYXRjaC5wdXNoKHsgbG9jYWxJZCwgYnVmZmVyIH0pCiAgfQoKICBfc2VuZEJhdGNoIChiYXRjaCwgc3RhdGUpIHsKICAgIGlmIChiYXRjaC5sZW5ndGggPT09IDApIHJldHVybgoKICAgIGxldCBwcmV2ID0gYmF0Y2hbMF0ubG9jYWxJZAoKICAgIHN0YXRlLmJ1ZmZlciA9IHRoaXMuX2FsbG9jKHN0YXRlLmVuZCkKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDAKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDAKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBwcmV2KQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmF0Y2gubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYiA9IGJhdGNoW2ldCiAgICAgIGlmIChwcmV2ICE9PSBiLmxvY2FsSWQpIHsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAwCiAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgKHByZXYgPSBiLmxvY2FsSWQpKQogICAgICB9CiAgICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgYi5idWZmZXIpCiAgICB9CgogICAgdGhpcy5kcmFpbmVkID0gdGhpcy5zdHJlYW0ud3JpdGUoc3RhdGUuYnVmZmVyKQogIH0KCiAgX2dldCAocHJvdG9jb2wsIGlkLCBhbGlhc2VzID0gW10pIHsKICAgIGNvbnN0IGtleSA9IHRvS2V5KHByb3RvY29sLCBpZCkKCiAgICBsZXQgaW5mbyA9IHRoaXMuX2luZm9zLmdldChrZXkpCiAgICBpZiAoaW5mbykgcmV0dXJuIGluZm8KCiAgICBpbmZvID0geyBrZXksIHByb3RvY29sLCBhbGlhc2VzOiBbXSwgaWQsIHBhaXJpbmc6IDAsIG9wZW5lZDogMCwgaW5jb21pbmc6IFtdLCBvdXRnb2luZzogW10sIGxhc3RDaGFubmVsOiBudWxsIH0KICAgIHRoaXMuX2luZm9zLnNldChrZXksIGluZm8pCgogICAgZm9yIChjb25zdCBhbGlhcyBvZiBhbGlhc2VzKSB7CiAgICAgIGNvbnN0IGtleSA9IHRvS2V5KGFsaWFzLCBpZCkKICAgICAgaW5mby5hbGlhc2VzLnB1c2goa2V5KQoKICAgICAgdGhpcy5faW5mb3Muc2V0KGtleSwgaW5mbykKICAgIH0KCiAgICByZXR1cm4gaW5mbwogIH0KCiAgX2djIChpbmZvKSB7CiAgICBpZiAoaW5mby5vcGVuZWQgPT09IDAgJiYgaW5mby5vdXRnb2luZy5sZW5ndGggPT09IDAgJiYgaW5mby5pbmNvbWluZy5sZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5faW5mb3MuZGVsZXRlKGluZm8ua2V5KQoKICAgICAgZm9yIChjb25zdCBhbGlhcyBvZiBpbmZvLmFsaWFzZXMpIHRoaXMuX2luZm9zLmRlbGV0ZShhbGlhcykKICAgIH0KICB9CgogIF9vbmRhdGEgKGJ1ZmZlcikgewogICAgaWYgKGJ1ZmZlci5ieXRlTGVuZ3RoID09PSAwKSByZXR1cm4gLy8gaWdub3JlIGVtcHR5IGZyYW1lcy4uLgogICAgdHJ5IHsKICAgICAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlciwgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGggfQogICAgICB0aGlzLl9kZWNvZGUoYy51aW50LmRlY29kZShzdGF0ZSksIHN0YXRlKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuX3NhZmVEZXN0cm95KGVycikKICAgIH0KICB9CgogIF9vbmRyYWluICgpIHsKICAgIHRoaXMuZHJhaW5lZCA9IHRydWUKCiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5fbG9jYWwpIHsKICAgICAgaWYgKHMgIT09IG51bGwpIHMuX3RyYWNrKHMub25kcmFpbihzKSkKICAgIH0KICB9CgogIF9vbmVuZCAoKSB7IC8vIFRPRE86IHN1cHBvcnQgaGFsZiBvcGVuIG1vZGUgZm9yIHRoZSB1c2VycyB3aG8gd2FudHMgdGhhdCBoZXJlCiAgICB0aGlzLnN0cmVhbS5lbmQoKQogIH0KCiAgX2RlY29kZSAocmVtb3RlSWQsIHN0YXRlKSB7CiAgICBjb25zdCB0eXBlID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAocmVtb3RlSWQgPT09IDApIHsKICAgICAgcmV0dXJuIHRoaXMuX29uY29udHJvbHNlc3Npb24odHlwZSwgc3RhdGUpCiAgICB9CgogICAgY29uc3QgciA9IHJlbW90ZUlkIDw9IHRoaXMuX3JlbW90ZS5sZW5ndGggPyB0aGlzLl9yZW1vdGVbcmVtb3RlSWQgLSAxXSA6IG51bGwKCiAgICAvLyBpZiB0aGUgY2hhbm5lbCBpcyBjbG9zZWQgaWdub3JlIC0gY291bGQganVzdCBiZSBhIHBpcGVsaW5lIG1lc3NhZ2UuLi4KICAgIGlmIChyID09PSBudWxsKSByZXR1cm4gbnVsbAoKICAgIGlmIChyLnBlbmRpbmcgIT09IG51bGwpIHsKICAgICAgdGhpcy5fYnVmZmVyTWVzc2FnZShyLCB0eXBlLCBzdGF0ZSkKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICByZXR1cm4gci5zZXNzaW9uLl9yZWN2KHR5cGUsIHN0YXRlKQogIH0KCiAgX29uY29udHJvbHNlc3Npb24gKHR5cGUsIHN0YXRlKSB7CiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMuX29uYmF0Y2goc3RhdGUpCiAgICAgICAgYnJlYWsKCiAgICAgIGNhc2UgMToKICAgICAgICAvLyByZXR1cm4gdGhlIHByb21pc2UgYmFjayB1cCBhcyB0aGlzIGhhcyBzaWRlZWZmZWN0cyBzbyB3ZSBjYW4gYmF0Y2ggcmVwbHkKICAgICAgICByZXR1cm4gdGhpcy5fb25vcGVuc2Vzc2lvbihzdGF0ZSkKCiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLl9vbnJlamVjdHNlc3Npb24oc3RhdGUpCiAgICAgICAgYnJlYWsKCiAgICAgIGNhc2UgMzoKICAgICAgICB0aGlzLl9vbmNsb3Nlc2Vzc2lvbihzdGF0ZSkKICAgICAgICBicmVhawogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBfYnVmZmVyTWVzc2FnZSAociwgdHlwZSwgeyBidWZmZXIsIHN0YXJ0LCBlbmQgfSkgewogICAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlciwgc3RhcnQsIGVuZCB9IC8vIGNvcHkKICAgIHIucGVuZGluZy5wdXNoKHsgdHlwZSwgc3RhdGUgfSkKICAgIHRoaXMuX2J1ZmZlcmVkICs9IGJ5dGVTaXplKHN0YXRlKQogICAgdGhpcy5fcGF1c2VNYXliZSgpCiAgfQoKICBfcGF1c2VNYXliZSAoKSB7CiAgICBpZiAodGhpcy5fcGF1c2VkID09PSB0cnVlIHx8IHRoaXMuX2J1ZmZlcmVkIDw9IE1BWF9CVUZGRVJFRCkgcmV0dXJuCiAgICB0aGlzLl9wYXVzZWQgPSB0cnVlCiAgICB0aGlzLnN0cmVhbS5wYXVzZSgpCiAgfQoKICBfcmVzdW1lTWF5YmUgKCkgewogICAgaWYgKHRoaXMuX3BhdXNlZCA9PT0gZmFsc2UgfHwgdGhpcy5fYnVmZmVyZWQgPiBNQVhfQlVGRkVSRUQpIHJldHVybgogICAgdGhpcy5fcGF1c2VkID0gZmFsc2UKICAgIHRoaXMuc3RyZWFtLnJlc3VtZSgpCiAgfQoKICBfb25iYXRjaCAoc3RhdGUpIHsKICAgIGNvbnN0IGVuZCA9IHN0YXRlLmVuZAogICAgbGV0IHJlbW90ZUlkID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBsZXQgd2FpdGluZyA9IG51bGwKCiAgICB3aGlsZSAoc3RhdGUuZW5kID4gc3RhdGUuc3RhcnQpIHsKICAgICAgY29uc3QgbGVuID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgICAgaWYgKGxlbiA9PT0gMCkgewogICAgICAgIHJlbW90ZUlkID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgICAgICBjb250aW51ZQogICAgICB9CiAgICAgIHN0YXRlLmVuZCA9IHN0YXRlLnN0YXJ0ICsgbGVuCiAgICAgIC8vIGlmIGJhdGNoIGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgbWVzc2FnZSwgY29yayBpdCBzbyB3ZSByZXBseSBiYWNrIHdpdGggYSBiYXRjaAogICAgICBpZiAoZW5kICE9PSBzdGF0ZS5lbmQgJiYgd2FpdGluZyA9PT0gbnVsbCkgewogICAgICAgIHdhaXRpbmcgPSBbXQogICAgICAgIHRoaXMuY29yaygpCiAgICAgIH0KICAgICAgY29uc3QgcCA9IHRoaXMuX2RlY29kZShyZW1vdGVJZCwgc3RhdGUpCiAgICAgIGlmICh3YWl0aW5nICE9PSBudWxsICYmIHAgIT09IG51bGwpIHdhaXRpbmcucHVzaChwKQogICAgICBzdGF0ZS5zdGFydCA9IHN0YXRlLmVuZAogICAgICBzdGF0ZS5lbmQgPSBlbmQKICAgIH0KCiAgICBpZiAod2FpdGluZyAhPT0gbnVsbCkgewogICAgICAvLyB0aGUgd2FpdGluZyBwcm9taXNlcyBhcmUgbm90IGFsbG93ZWQgdG8gdGhyb3cgYnV0IHdlIGRlc3Ryb3kgdGhlIHN0cmVhbSBpbiBjYXNlIHdlIGFyZSB3cm9uZwogICAgICBQcm9taXNlLmFsbCh3YWl0aW5nKS50aGVuKHRoaXMuX3VuY29ya0JvdW5kLCB0aGlzLl9zYWZlRGVzdHJveUJvdW5kKQogICAgfQogIH0KCiAgX29ub3BlbnNlc3Npb24gKHN0YXRlKSB7CiAgICBjb25zdCByZW1vdGVJZCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBwcm90b2NvbCA9IGMuc3RyaW5nLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGlkID0gdW5zbGFiKGMuYnVmZmVyLmRlY29kZShzdGF0ZSkpCgogICAgLy8gcmVtb3RlIHRyaWVkIHRvIG9wZW4gdGhlIGNvbnRyb2wgc2Vzc2lvbiAtIGF1dG8gcmVqZWN0IGZvciBub3cKICAgIC8vIGFzIHdlIGNhbiB1c2UgYXMgYW4gZXhwbGljaXQgY29udHJvbCBwcm90b2NvbCBkZWNsYXJhdGlvbiBpZiB3ZSBuZWVkIHRvCiAgICBpZiAocmVtb3RlSWQgPT09IDApIHsKICAgICAgdGhpcy5fcmVqZWN0U2Vzc2lvbigwKQogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGNvbnN0IHJpZCA9IHJlbW90ZUlkIC0gMQogICAgY29uc3QgaW5mbyA9IHRoaXMuX2dldChwcm90b2NvbCwgaWQpCgogICAgLy8gYWxsb3cgdGhlIHJlbW90ZSB0byBncm93IHRoZSBpZHMgYnkgb25lCiAgICBpZiAodGhpcy5fcmVtb3RlLmxlbmd0aCA9PT0gcmlkKSB7CiAgICAgIHRoaXMuX3JlbW90ZS5wdXNoKG51bGwpCiAgICB9CgogICAgaWYgKHJpZCA+PSB0aGlzLl9yZW1vdGUubGVuZ3RoIHx8IHRoaXMuX3JlbW90ZVtyaWRdICE9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBvcGVuIG1lc3NhZ2UnKQogICAgfQoKICAgIGlmIChpbmZvLm91dGdvaW5nLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgbG9jYWxJZCA9IGluZm8ub3V0Z29pbmcuc2hpZnQoKQogICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5fbG9jYWxbbG9jYWxJZCAtIDFdCgogICAgICBpZiAoc2Vzc2lvbiA9PT0gbnVsbCkgeyAvLyB3ZSBhbHJlYWR5IGNsb3NlZCB0aGUgY2hhbm5lbCAtIGlnbm9yZQogICAgICAgIHRoaXMuX2ZyZWUucHVzaChsb2NhbElkIC0gMSkKICAgICAgICByZXR1cm4gbnVsbAogICAgICB9CgogICAgICB0aGlzLl9yZW1vdGVbcmlkXSA9IHsgc3RhdGUsIHBlbmRpbmc6IG51bGwsIHNlc3Npb246IG51bGwgfQoKICAgICAgc2Vzc2lvbi5fcmVtb3RlSWQgPSByZW1vdGVJZAogICAgICBzZXNzaW9uLl9mdWxseU9wZW4oKQogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGNvbnN0IGNvcHlTdGF0ZSA9IHsgYnVmZmVyOiBzdGF0ZS5idWZmZXIsIHN0YXJ0OiBzdGF0ZS5zdGFydCwgZW5kOiBzdGF0ZS5lbmQgfQogICAgdGhpcy5fcmVtb3RlW3JpZF0gPSB7IHN0YXRlOiBjb3B5U3RhdGUsIHBlbmRpbmc6IFtdLCBzZXNzaW9uOiBudWxsIH0KCiAgICBpZiAoKyt0aGlzLl9yZW1vdGVCYWNrbG9nID4gTUFYX0JBQ0tMT0cpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZW1vdGUgZXhjZWVkZWQgYmFja2xvZycpCiAgICB9CgogICAgaW5mby5wYWlyaW5nKysKICAgIGluZm8uaW5jb21pbmcucHVzaChyZW1vdGVJZCkKCiAgICByZXR1cm4gdGhpcy5fcmVxdWVzdFNlc3Npb24ocHJvdG9jb2wsIGlkLCBpbmZvKS5jYXRjaCh0aGlzLl9zYWZlRGVzdHJveUJvdW5kKQogIH0KCiAgX29ucmVqZWN0c2Vzc2lvbiAoc3RhdGUpIHsKICAgIGNvbnN0IGxvY2FsSWQgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIC8vIFRPRE86IGNhbiBiZSBkb25lIHNtYXJ0ZXIuLi4KICAgIGZvciAoY29uc3QgaW5mbyBvZiB0aGlzLl9pbmZvcy52YWx1ZXMoKSkgewogICAgICBjb25zdCBpID0gaW5mby5vdXRnb2luZy5pbmRleE9mKGxvY2FsSWQpCiAgICAgIGlmIChpID09PSAtMSkgY29udGludWUKCiAgICAgIGluZm8ub3V0Z29pbmcuc3BsaWNlKGksIDEpCgogICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5fbG9jYWxbbG9jYWxJZCAtIDFdCgogICAgICB0aGlzLl9mcmVlLnB1c2gobG9jYWxJZCAtIDEpCiAgICAgIGlmIChzZXNzaW9uICE9PSBudWxsKSBzZXNzaW9uLl9jbG9zZSh0cnVlKQoKICAgICAgdGhpcy5fZ2MoaW5mbykKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHJlamVjdCBtZXNzYWdlJykKICB9CgogIF9vbmNsb3Nlc2Vzc2lvbiAoc3RhdGUpIHsKICAgIGNvbnN0IHJlbW90ZUlkID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAocmVtb3RlSWQgPT09IDApIHJldHVybiAvLyBpZ25vcmUKCiAgICBjb25zdCByaWQgPSByZW1vdGVJZCAtIDEKICAgIGNvbnN0IHIgPSByaWQgPCB0aGlzLl9yZW1vdGUubGVuZ3RoID8gdGhpcy5fcmVtb3RlW3JpZF0gOiBudWxsCgogICAgaWYgKHIgPT09IG51bGwpIHJldHVybgoKICAgIGlmIChyLnNlc3Npb24gIT09IG51bGwpIHIuc2Vzc2lvbi5fY2xvc2UodHJ1ZSkKICB9CgogIGFzeW5jIF9yZXF1ZXN0U2Vzc2lvbiAocHJvdG9jb2wsIGlkLCBpbmZvKSB7CiAgICBjb25zdCBub3RpZnkgPSB0aGlzLl9ub3RpZnkuZ2V0KHRvS2V5KHByb3RvY29sLCBpZCkpIHx8IHRoaXMuX25vdGlmeS5nZXQodG9LZXkocHJvdG9jb2wsIG51bGwpKQoKICAgIGlmIChub3RpZnkpIGF3YWl0IG5vdGlmeShpZCkKCiAgICBpZiAoLS1pbmZvLnBhaXJpbmcgPiAwKSByZXR1cm4KCiAgICB3aGlsZSAoaW5mby5pbmNvbWluZy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuX3JlamVjdFNlc3Npb24oaW5mbywgaW5mby5pbmNvbWluZy5zaGlmdCgpKQogICAgfQoKICAgIHRoaXMuX2djKGluZm8pCiAgfQoKICBfcmVqZWN0U2Vzc2lvbiAoaW5mbywgcmVtb3RlSWQpIHsKICAgIGlmIChyZW1vdGVJZCA+IDApIHsKICAgICAgY29uc3QgciA9IHRoaXMuX3JlbW90ZVtyZW1vdGVJZCAtIDFdCgogICAgICBpZiAoci5wZW5kaW5nICE9PSBudWxsKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByLnBlbmRpbmcubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHRoaXMuX2J1ZmZlcmVkIC09IGJ5dGVTaXplKHIucGVuZGluZ1tpXS5zdGF0ZSkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuX3JlbW90ZVtyZW1vdGVJZCAtIDFdID0gbnVsbAogICAgICB0aGlzLl9yZXN1bWVNYXliZSgpCiAgICB9CgogICAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlcjogbnVsbCwgc3RhcnQ6IDIsIGVuZDogMiB9CgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgcmVtb3RlSWQpCgogICAgc3RhdGUuYnVmZmVyID0gdGhpcy5fYWxsb2Moc3RhdGUuZW5kKQoKICAgIHN0YXRlLmJ1ZmZlclswXSA9IDAKICAgIHN0YXRlLmJ1ZmZlclsxXSA9IDIKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHJlbW90ZUlkKQoKICAgIHRoaXMuX3dyaXRlMChzdGF0ZS5idWZmZXIpCiAgfQoKICBfd3JpdGUwIChidWZmZXIpIHsKICAgIGlmICh0aGlzLl9iYXRjaCAhPT0gbnVsbCkgewogICAgICB0aGlzLl9wdXNoQmF0Y2goMCwgYnVmZmVyLnN1YmFycmF5KDEpKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLmRyYWluZWQgPSB0aGlzLnN0cmVhbS53cml0ZShidWZmZXIpCiAgfQoKICBkZXN0cm95IChlcnIpIHsKICAgIHRoaXMuc3RyZWFtLmRlc3Ryb3koZXJyKQogIH0KCiAgX3NhZmVEZXN0cm95IChlcnIpIHsKICAgIHNhZmV0eUNhdGNoKGVycikKICAgIHRoaXMuc3RyZWFtLmRlc3Ryb3koZXJyKQogIH0KCiAgX3NodXRkb3duICgpIHsKICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLl9sb2NhbCkgewogICAgICBpZiAocyAhPT0gbnVsbCkgcy5fY2xvc2UodHJ1ZSkKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIG5vb3AgKCkge30KCmZ1bmN0aW9uIHRvS2V5IChwcm90b2NvbCwgaWQpIHsKICByZXR1cm4gcHJvdG9jb2wgKyAnIyMnICsgKGlkID8gYjRhLnRvU3RyaW5nKGlkLCAnaGV4JykgOiAnJykKfQoKZnVuY3Rpb24gYnl0ZVNpemUgKHN0YXRlKSB7CiAgcmV0dXJuIDUxMiArIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCkKfQoKZnVuY3Rpb24gaXNQcm9taXNlIChwKSB7CiAgcmV0dXJuICEhKHAgJiYgdHlwZW9mIHAudGhlbiA9PT0gJ2Z1bmN0aW9uJykKfQoKZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKGVuYywgdmFsKSB7CiAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlcjogbnVsbCwgc3RhcnQ6IDAsIGVuZDogMCB9CiAgZW5jLnByZWVuY29kZShzdGF0ZSwgdmFsKQogIHJldHVybiBzdGF0ZS5lbmQKfQp7CiAgIm5hbWUiOiAicHJvdG9tdXgiLAogICJ2ZXJzaW9uIjogIjMuMTAuMSIsCiAgImRlc2NyaXB0aW9uIjogIk11bHRpcGxleCBtdWx0aXBsZSBtZXNzYWdlIG9yaWVudGVkIHByb3RvY29scyBvdmVyIGEgc3RyZWFtIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuMy4xIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjUuMSIsCiAgICAicXVldWUtdGljayI6ICJeMS4wLjAiLAogICAgInNhZmV0eS1jYXRjaCI6ICJeMS4wLjEiLAogICAgInVuc2xhYiI6ICJeMS4zLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiAiXjYuMC4wIiwKICAgICJicml0dGxlIjogIl4zLjAuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE2LjAuNCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3Byb3RvbXV4LmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9wcm90b211eC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9wcm90b211eCIKfQp7CiAgIm5hbWUiOiAicXVldWUtdGljayIsCiAgInZlcnNpb24iOiAiMS4wLjEiLAogICJkZXNjcmlwdGlvbiI6ICJOZXh0IHRpY2sgc2hpbSB0aGF0IHByZWZlcnMgcHJvY2Vzcy5uZXh0VGljayBvdmVyIHF1ZXVlTWljcm90YXNrIGZvciBjb21wYXQiLAogICJtYWluIjogIi4vcHJvY2Vzcy1uZXh0LXRpY2suanMiLAogICJicm93c2VyIjogIi4vcXVldWUtbWljcm90YXNrLmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTYuMC4zIiwKICAgICJ0YXBlIjogIl41LjMuMSIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgdGFwZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3F1ZXVlLXRpY2suZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3F1ZXVlLXRpY2svaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcXVldWUtdGljayIKfQptb2R1bGUuZXhwb3J0cyA9ICh0eXBlb2YgcHJvY2VzcyAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIHByb2Nlc3MubmV4dFRpY2sgPT09ICdmdW5jdGlvbicpCiAgPyBwcm9jZXNzLm5leHRUaWNrLmJpbmQocHJvY2VzcykKICA6IHJlcXVpcmUoJy4vcXVldWUtbWljcm90YXNrJykKbW9kdWxlLmV4cG9ydHMgPSB0eXBlb2YgcXVldWVNaWNyb3Rhc2sgPT09ICdmdW5jdGlvbicgPyBxdWV1ZU1pY3JvdGFzayA6IChmbikgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmbikKcmVxdWlyZS5hZGRvbiA9IHJlcXVpcmUoJ3JlcXVpcmUtYWRkb24nKQoKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCcuJywgX19maWxlbmFtZSkKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4vYmluZGluZycpCgpleHBvcnRzLmdldCA9IGZ1bmN0aW9uIGdldChmaWVsZCwgYml0KSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogIGlmIChiaXQgPCAwKSBiaXQgKz0gbgogIGlmIChiaXQgPCAwIHx8IGJpdCA+PSBuKSByZXR1cm4gZmFsc2UKCiAgcmV0dXJuIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9nZXQodG9CdWZmZXIoZmllbGQpLCBiaXQpICE9PSAwCn0KCmV4cG9ydHMuc2V0ID0gZnVuY3Rpb24gc2V0KGZpZWxkLCBiaXQsIHZhbHVlID0gdHJ1ZSkgewogIGNvbnN0IG4gPSBmaWVsZC5ieXRlTGVuZ3RoICogOAoKICBpZiAoYml0IDwgMCkgYml0ICs9IG4KICBpZiAoYml0IDwgMCB8fCBiaXQgPj0gbikgcmV0dXJuIGZhbHNlCgogIHJldHVybiBiaW5kaW5nLnF1aWNrYml0X25hcGlfc2V0KHRvQnVmZmVyKGZpZWxkKSwgYml0LCB2YWx1ZSA/IDEgOiAwKSAhPT0gMAp9CgpleHBvcnRzLmZpbGwgPSBmdW5jdGlvbiBmaWxsKAogIGZpZWxkLAogIHZhbHVlLAogIHN0YXJ0ID0gMCwKICBlbmQgPSBmaWVsZC5ieXRlTGVuZ3RoICogOAopIHsKICBjb25zdCBuID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgaWYgKHN0YXJ0IDwgMCkgc3RhcnQgKz0gbgogIGlmIChlbmQgPCAwKSBlbmQgKz0gbgogIGlmIChzdGFydCA8IDAgfHwgc3RhcnQgPj0gZmllbGQuYnl0ZUxlbmd0aCAqIDggfHwgc3RhcnQgPj0gZW5kKSByZXR1cm4gZmllbGQKCiAgYmluZGluZy5xdWlja2JpdF9uYXBpX2ZpbGwodG9CdWZmZXIoZmllbGQpLCB2YWx1ZSA/IDEgOiAwLCBzdGFydCwgZW5kKQogIHJldHVybiBmaWVsZAp9CgpleHBvcnRzLmNsZWFyID0gZnVuY3Rpb24gY2xlYXIoZmllbGQsIC4uLmNodW5rcykgewogIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9jbGVhcih0b0J1ZmZlcihmaWVsZCksIGNodW5rcy5tYXAodG9CdWZmZXJDaHVuaykpCn0KCmV4cG9ydHMuZmluZEZpcnN0ID0gZnVuY3Rpb24gZmluZEZpcnN0KGZpZWxkLCB2YWx1ZSwgcG9zaXRpb24gPSAwKSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogIGlmIChwb3NpdGlvbiA8IDApIHBvc2l0aW9uICs9IG4KICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiA9IDAKICBpZiAocG9zaXRpb24gPj0gbikgcmV0dXJuIC0xCgogIHJldHVybiBiaW5kaW5nLnF1aWNrYml0X25hcGlfZmluZF9maXJzdCgKICAgIHRvQnVmZmVyKGZpZWxkKSwKICAgIHZhbHVlID8gMSA6IDAsCiAgICBwb3NpdGlvbgogICkKfQoKZXhwb3J0cy5maW5kTGFzdCA9IGZ1bmN0aW9uIGZpbmRMYXN0KAogIGZpZWxkLAogIHZhbHVlLAogIHBvc2l0aW9uID0gZmllbGQuYnl0ZUxlbmd0aCAqIDggLSAxCikgewogIGNvbnN0IG4gPSBmaWVsZC5ieXRlTGVuZ3RoICogOAoKICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiArPSBuCiAgaWYgKHBvc2l0aW9uIDwgMCkgcmV0dXJuIC0xCiAgaWYgKHBvc2l0aW9uID49IG4pIHBvc2l0aW9uID0gbiAtIDEKCiAgcmV0dXJuIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9maW5kX2xhc3QoCiAgICB0b0J1ZmZlcihmaWVsZCksCiAgICB2YWx1ZSA/IDEgOiAwLAogICAgcG9zaXRpb24KICApCn0KCmZ1bmN0aW9uIHRvQnVmZmVyKGZpZWxkKSB7CiAgaWYgKGZpZWxkLkJZVEVTX1BFUl9FTEVNRU5UID09PSAxKSByZXR1cm4gZmllbGQKICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoZmllbGQuYnVmZmVyLCBmaWVsZC5ieXRlT2Zmc2V0LCBmaWVsZC5ieXRlTGVuZ3RoKQp9CgpmdW5jdGlvbiB0b0J1ZmZlckNodW5rKGNodW5rKSB7CiAgcmV0dXJuIHsgZmllbGQ6IHRvQnVmZmVyKGNodW5rLmZpZWxkKSwgb2Zmc2V0OiBjaHVuay5vZmZzZXQgfQp9CgpjbGFzcyBJbmRleCB7CiAgc3RhdGljIGZyb20oZmllbGRPckNodW5rcywgYnl0ZUxlbmd0aCA9IC0xKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShmaWVsZE9yQ2h1bmtzKSkgewogICAgICByZXR1cm4gbmV3IFNwYXJzZUluZGV4KGZpZWxkT3JDaHVua3MsIGJ5dGVMZW5ndGgpCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmV3IERlbnNlSW5kZXgoZmllbGRPckNodW5rcywgYnl0ZUxlbmd0aCkKICAgIH0KICB9CgogIGNvbnN0cnVjdG9yKGJ5dGVMZW5ndGgpIHsKICAgIHRoaXMuX2J5dGVMZW5ndGggPSBieXRlTGVuZ3RoCiAgICB0aGlzLmhhbmRsZSA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShiaW5kaW5nLnNpemVvZl9xdWlja2JpdF9pbmRleF90KQogIH0KCiAgZ2V0IGJ5dGVMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5fYnl0ZUxlbmd0aAogIH0KCiAgc2tpcEZpcnN0KHZhbHVlLCBwb3NpdGlvbiA9IDApIHsKICAgIGNvbnN0IG4gPSB0aGlzLmJ5dGVMZW5ndGggKiA4CgogICAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gKz0gbgogICAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gPSAwCiAgICBpZiAocG9zaXRpb24gPj0gbikgcmV0dXJuIG4gLSAxCgogICAgcmV0dXJuIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9za2lwX2ZpcnN0KAogICAgICB0aGlzLmhhbmRsZSwKICAgICAgdGhpcy5ieXRlTGVuZ3RoLAogICAgICB2YWx1ZSA/IDEgOiAwLAogICAgICBwb3NpdGlvbgogICAgKQogIH0KCiAgc2tpcExhc3QodmFsdWUsIHBvc2l0aW9uID0gdGhpcy5ieXRlTGVuZ3RoICogOCAtIDEpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmJ5dGVMZW5ndGggKiA4CgogICAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gKz0gbgogICAgaWYgKHBvc2l0aW9uIDwgMCkgcmV0dXJuIDAKICAgIGlmIChwb3NpdGlvbiA+PSBuKSBwb3NpdGlvbiA9IG4gLSAxCgogICAgcmV0dXJuIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9za2lwX2xhc3QoCiAgICAgIHRoaXMuaGFuZGxlLAogICAgICB0aGlzLmJ5dGVMZW5ndGgsCiAgICAgIHZhbHVlID8gMSA6IDAsCiAgICAgIHBvc2l0aW9uCiAgICApCiAgfQp9CgpleHBvcnRzLkluZGV4ID0gSW5kZXgKCmNsYXNzIERlbnNlSW5kZXggZXh0ZW5kcyBJbmRleCB7CiAgY29uc3RydWN0b3IoZmllbGQsIGJ5dGVMZW5ndGgpIHsKICAgIHN1cGVyKGJ5dGVMZW5ndGgpCiAgICB0aGlzLmZpZWxkID0gZmllbGQKCiAgICBiaW5kaW5nLnF1aWNrYml0X25hcGlfaW5kZXhfaW5pdCh0aGlzLmhhbmRsZSwgdG9CdWZmZXIodGhpcy5maWVsZCkpCiAgfQoKICBnZXQgYnl0ZUxlbmd0aCgpIHsKICAgIGlmICh0aGlzLl9ieXRlTGVuZ3RoICE9PSAtMSkgcmV0dXJuIHRoaXMuX2J5dGVMZW5ndGgKICAgIHJldHVybiB0aGlzLmZpZWxkLmJ5dGVMZW5ndGgKICB9CgogIHVwZGF0ZShiaXQpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmJ5dGVMZW5ndGggKiA4CgogICAgaWYgKGJpdCA8IDApIGJpdCArPSBuCiAgICBpZiAoYml0IDwgMCB8fCBiaXQgPj0gbikgcmV0dXJuIGZhbHNlCgogICAgcmV0dXJuICgKICAgICAgYmluZGluZy5xdWlja2JpdF9uYXBpX2luZGV4X3VwZGF0ZSgKICAgICAgICB0aGlzLmhhbmRsZSwKICAgICAgICB0b0J1ZmZlcih0aGlzLmZpZWxkKSwKICAgICAgICBiaXQKICAgICAgKSAhPT0gMAogICAgKQogIH0KfQoKZnVuY3Rpb24gc2VsZWN0Q2h1bmsoY2h1bmtzLCBvZmZzZXQpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IGNodW5rcy5sZW5ndGg7IGkrKykgewogICAgY29uc3QgbmV4dCA9IGNodW5rc1tpXQoKICAgIGNvbnN0IHN0YXJ0ID0gbmV4dC5vZmZzZXQKICAgIGNvbnN0IGVuZCA9IG5leHQub2Zmc2V0ICsgbmV4dC5maWVsZC5ieXRlTGVuZ3RoCgogICAgaWYgKG9mZnNldCA+PSBzdGFydCAmJiBvZmZzZXQgKyAxNiA8PSBlbmQpIHsKICAgICAgcmV0dXJuIG5leHQKICAgIH0KICB9CgogIHJldHVybiBudWxsCn0KCmNsYXNzIFNwYXJzZUluZGV4IGV4dGVuZHMgSW5kZXggewogIGNvbnN0cnVjdG9yKGNodW5rcywgYnl0ZUxlbmd0aCkgewogICAgc3VwZXIoYnl0ZUxlbmd0aCkKICAgIHRoaXMuY2h1bmtzID0gY2h1bmtzCgogICAgYmluZGluZy5xdWlja2JpdF9uYXBpX2luZGV4X2luaXRfc3BhcnNlKAogICAgICB0aGlzLmhhbmRsZSwKICAgICAgdGhpcy5jaHVua3MubWFwKHRvQnVmZmVyQ2h1bmspCiAgICApCiAgfQoKICBnZXQgYnl0ZUxlbmd0aCgpIHsKICAgIGlmICh0aGlzLl9ieXRlTGVuZ3RoICE9PSAtMSkgcmV0dXJuIHRoaXMuX2J5dGVMZW5ndGgKICAgIGNvbnN0IGxhc3QgPSB0aGlzLmNodW5rc1t0aGlzLmNodW5rcy5sZW5ndGggLSAxXQogICAgcmV0dXJuIGxhc3QgPyBsYXN0Lm9mZnNldCArIGxhc3QuZmllbGQuYnl0ZUxlbmd0aCA6IDAKICB9CgogIHVwZGF0ZShiaXQpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmJ5dGVMZW5ndGggKiA4CgogICAgaWYgKGJpdCA8IDApIGJpdCArPSBuCiAgICBpZiAoYml0IDwgMCB8fCBiaXQgPj0gbikgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgaiA9IE1hdGguZmxvb3IoYml0IC8gMTI4KQoKICAgIGNvbnN0IG9mZnNldCA9IGogKiAxNgoKICAgIGNvbnN0IGNodW5rID0gc2VsZWN0Q2h1bmsodGhpcy5jaHVua3MsIG9mZnNldCkKCiAgICBpZiAoY2h1bmsgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIHJldHVybiAoCiAgICAgIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9pbmRleF91cGRhdGVfc3BhcnNlKAogICAgICAgIHRoaXMuaGFuZGxlLAogICAgICAgIHRvQnVmZmVyKGNodW5rLmZpZWxkKSwKICAgICAgICBjaHVuay5vZmZzZXQsCiAgICAgICAgYml0CiAgICAgICkgIT09IDAKICAgICkKICB9Cn0KewogICJuYW1lIjogInF1aWNrYml0LW5hdGl2ZSIsCiAgInZlcnNpb24iOiAiMi40LjgiLAogICJkZXNjcmlwdGlvbiI6ICJsaWJxdWlja2JpdCBKYXZhU2NyaXB0IGJpbmRpbmdzIGZvciBOb2RlLmpzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJtYWNyb3MuaCIsCiAgICAiYmluZGluZy5jYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiLAogICAgInByZWJ1aWxkcyIKICBdLAogICJhZGRvbiI6IHRydWUsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJucG0gcnVuIGxpbnQgJiYgbnBtIHJ1biB0ZXN0OmJhcmUgJiYgbnBtIHJ1biB0ZXN0Om5vZGUiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QubWpzIiwKICAgICJ0ZXN0Om5vZGUiOiAibm9kZSB0ZXN0Lm1qcyIsCiAgICAibGludCI6ICJwcmV0dGllciAuIC0tY2hlY2siCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcXVpY2tiaXQtbmF0aXZlLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3F1aWNrYml0LW5hdGl2ZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3F1aWNrYml0LW5hdGl2ZSNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAicmVxdWlyZS1hZGRvbiI6ICJeMS4xLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjciLAogICAgImJhcmUtY29tcGF0LW5hcGkiOiAiXjEuMy4yIiwKICAgICJicml0dGxlIjogIl4zLjEuMCIsCiAgICAiY21ha2UtYmFyZSI6ICJeMS4xLjciLAogICAgImNtYWtlLWZldGNoIjogIl4xLjEuMCIsCiAgICAiY21ha2UtbmFwaSI6ICJeMS4wLjIiLAogICAgInByZXR0aWVyIjogIl4zLjUuMyIsCiAgICAicHJldHRpZXItY29uZmlnLXN0YW5kYXJkIjogIl43LjAuMCIKICB9Cn0KY29uc3Qgc2ltZGxlID0gcmVxdWlyZSgnc2ltZGxlLXVuaXZlcnNhbCcpCgpjb25zdCBJTkRFWF9MRU4gPSAoMTYgLyogcm9vdCAqLyArIDEyOCAqIDE2IC8qIGNoaWxkcmVuICovKSAqIDIKCmNvbnN0IGdldCA9IGV4cG9ydHMuZ2V0ID0gZnVuY3Rpb24gZ2V0IChmaWVsZCwgYml0KSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogIGlmIChiaXQgPCAwKSBiaXQgKz0gbgogIGlmIChiaXQgPCAwIHx8IGJpdCA+PSBuKSByZXR1cm4gZmFsc2UKCiAgY29uc3QgbSA9IGZpZWxkLkJZVEVTX1BFUl9FTEVNRU5UICogOAoKICBjb25zdCBvZmZzZXQgPSBiaXQgJiAobSAtIDEpCiAgY29uc3QgaSA9IChiaXQgLSBvZmZzZXQpIC8gbQoKICByZXR1cm4gKGZpZWxkW2ldICYgKDEgPDwgb2Zmc2V0KSkgIT09IDAKfQoKY29uc3Qgc2V0ID0gZXhwb3J0cy5zZXQgPSBmdW5jdGlvbiBzZXQgKGZpZWxkLCBiaXQsIHZhbHVlID0gdHJ1ZSkgewogIGNvbnN0IG4gPSBmaWVsZC5ieXRlTGVuZ3RoICogOAoKICBpZiAoYml0IDwgMCkgYml0ICs9IG4KICBpZiAoYml0IDwgMCB8fCBiaXQgPj0gbikgcmV0dXJuIGZhbHNlCgogIGNvbnN0IG0gPSBmaWVsZC5CWVRFU19QRVJfRUxFTUVOVCAqIDgKCiAgY29uc3Qgb2Zmc2V0ID0gYml0ICYgKG0gLSAxKQogIGNvbnN0IGkgPSAoYml0IC0gb2Zmc2V0KSAvIG0KICBjb25zdCBtYXNrID0gMSA8PCBvZmZzZXQKCiAgaWYgKHZhbHVlKSB7CiAgICBpZiAoKGZpZWxkW2ldICYgbWFzaykgIT09IDApIHJldHVybiBmYWxzZQogIH0gZWxzZSB7CiAgICBpZiAoKGZpZWxkW2ldICYgbWFzaykgPT09IDApIHJldHVybiBmYWxzZQogIH0KCiAgZmllbGRbaV0gXj0gbWFzawoKICByZXR1cm4gdHJ1ZQp9CgpleHBvcnRzLmZpbGwgPSBmdW5jdGlvbiBmaWxsIChmaWVsZCwgdmFsdWUsIHN0YXJ0ID0gMCwgZW5kID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgpIHsKICBjb25zdCBuID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgaWYgKHN0YXJ0IDwgMCkgc3RhcnQgKz0gbgogIGlmIChlbmQgPCAwKSBlbmQgKz0gbgogIGlmIChzdGFydCA8IDAgfHwgc3RhcnQgPj0gZmllbGQuYnl0ZUxlbmd0aCAqIDggfHwgc3RhcnQgPj0gZW5kKSByZXR1cm4gZmllbGQKCiAgY29uc3QgbSA9IGZpZWxkLkJZVEVTX1BFUl9FTEVNRU5UICogOAoKICBsZXQgaSwgagoKICB7CiAgICBjb25zdCBvZmZzZXQgPSBzdGFydCAmIChtIC0gMSkKICAgIGkgPSAoc3RhcnQgLSBvZmZzZXQpIC8gbQoKICAgIGlmIChvZmZzZXQgIT09IDApIHsKICAgICAgbGV0IHNoaWZ0ID0gbSAtIG9mZnNldAogICAgICBpZiAoZW5kIC0gc3RhcnQgPCBzaGlmdCkgc2hpZnQgPSBlbmQgLSBzdGFydAoKICAgICAgY29uc3QgbWFzayA9ICgoMSA8PCBzaGlmdCkgLSAxKSA8PCBvZmZzZXQKCiAgICAgIGlmICh2YWx1ZSkgZmllbGRbaV0gfD0gbWFzawogICAgICBlbHNlIGZpZWxkW2ldICY9IH5tYXNrCgogICAgICBpKysKICAgIH0KICB9CgogIHsKICAgIGNvbnN0IG9mZnNldCA9IGVuZCAmIChtIC0gMSkKICAgIGogPSAoZW5kIC0gb2Zmc2V0KSAvIG0KCiAgICBpZiAob2Zmc2V0ICE9PSAwICYmIGogPj0gaSkgewogICAgICBjb25zdCBtYXNrID0gKDEgPDwgb2Zmc2V0KSAtIDEKCiAgICAgIGlmICh2YWx1ZSkgZmllbGRbal0gfD0gbWFzawogICAgICBlbHNlIGZpZWxkW2pdICY9IH5tYXNrCiAgICB9CiAgfQoKICBpZiAoaSA8IGopIGZpZWxkLmZpbGwodmFsdWUgPyAoMiAqKiBtKSAtIDEgOiAwLCBpLCBqKQoKICByZXR1cm4gZmllbGQKfQoKZXhwb3J0cy5jbGVhciA9IGZ1bmN0aW9uIGNsZWFyIChmaWVsZCwgLi4uY2h1bmtzKSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGgKCiAgZm9yIChjb25zdCBjaHVuayBvZiBjaHVua3MpIHsKICAgIGlmIChjaHVuay5vZmZzZXQgPj0gbikgY29udGludWUKCiAgICBjb25zdCBtID0gY2h1bmsuZmllbGQuYnl0ZUxlbmd0aAoKICAgIGxldCBpID0gY2h1bmsub2Zmc2V0CiAgICBsZXQgaiA9IDAKCiAgICB3aGlsZSAoKChpICYgMTUpICE9PSAwIHx8IChqICYgMTUpICE9PSAwKSAmJiBpIDwgbiAmJiBqIDwgbSkgewogICAgICBmaWVsZFtpXSA9IGZpZWxkW2ldICYgfmNodW5rLmZpZWxkW2pdCiAgICAgIGkrKwogICAgICBqKysKICAgIH0KCiAgICBpZiAoaSArIDE1IDwgbiAmJiBqICsgMTUgPCBtKSB7CiAgICAgIGNvbnN0IGxlbiA9IE1hdGgubWluKG4gLSAobiAmIDE1KSAtIGksIG0gLSAobSAmIDE1KSAtIGopCgogICAgICBzaW1kbGUuY2xlYXIoZmllbGQuc3ViYXJyYXkoaSwgaSArIGxlbiksIGNodW5rLmZpZWxkLnN1YmFycmF5KGosIGogKyBsZW4pLCBmaWVsZC5zdWJhcnJheShpLCBpICsgbGVuKSkKICAgIH0KCiAgICB3aGlsZSAoaSA8IG4gJiYgaiA8IG0pIHsKICAgICAgZmllbGRbaV0gPSBmaWVsZFtpXSAmIH5jaHVuay5maWVsZFtqXQogICAgICBpKysKICAgICAgaisrCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBiaXRPZmZzZXQgKGJpdCwgb2Zmc2V0KSB7CiAgcmV0dXJuICFiaXQgPyBvZmZzZXQgOiAoSU5ERVhfTEVOICogOCAvIDIpICsgb2Zmc2V0Cn0KCmZ1bmN0aW9uIGJ5dGVPZmZzZXQgKGJpdCwgb2Zmc2V0KSB7CiAgcmV0dXJuICFiaXQgPyBvZmZzZXQgOiAoSU5ERVhfTEVOIC8gMikgKyBvZmZzZXQKfQoKZXhwb3J0cy5maW5kRmlyc3QgPSBmdW5jdGlvbiBmaW5kRmlyc3QgKGZpZWxkLCB2YWx1ZSwgcG9zaXRpb24gPSAwKSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogIGlmIChwb3NpdGlvbiA8IDApIHBvc2l0aW9uICs9IG4KICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiA9IDAKICBpZiAocG9zaXRpb24gPj0gbikgcmV0dXJuIC0xCgogIHZhbHVlID0gISF2YWx1ZQoKICBmb3IgKGxldCBpID0gcG9zaXRpb247IGkgPCBuOyBpKyspIHsKICAgIGlmIChnZXQoZmllbGQsIGkpID09PSB2YWx1ZSkgcmV0dXJuIGkKICB9CgogIHJldHVybiAtMQp9CgpleHBvcnRzLmZpbmRMYXN0ID0gZnVuY3Rpb24gZmluZExhc3QgKGZpZWxkLCB2YWx1ZSwgcG9zaXRpb24gPSBmaWVsZC5ieXRlTGVuZ3RoICogOCAtIDEpIHsKICBjb25zdCBuID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gKz0gbgogIGlmIChwb3NpdGlvbiA8IDApIHJldHVybiAtMQogIGlmIChwb3NpdGlvbiA+PSBuKSBwb3NpdGlvbiA9IG4gLSAxCgogIHZhbHVlID0gISF2YWx1ZQoKICBmb3IgKGxldCBpID0gcG9zaXRpb247IGkgPj0gMDsgaS0tKSB7CiAgICBpZiAoZ2V0KGZpZWxkLCBpKSA9PT0gdmFsdWUpIHJldHVybiBpCiAgfQoKICByZXR1cm4gLTEKfQoKY29uc3QgSW5kZXggPSBleHBvcnRzLkluZGV4ID0gY2xhc3MgSW5kZXggewogIHN0YXRpYyBmcm9tIChmaWVsZE9yQ2h1bmtzLCBieXRlTGVuZ3RoID0gLTEpIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGZpZWxkT3JDaHVua3MpKSB7CiAgICAgIHJldHVybiBuZXcgU3BhcnNlSW5kZXgoZmllbGRPckNodW5rcywgYnl0ZUxlbmd0aCkKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgRGVuc2VJbmRleChmaWVsZE9yQ2h1bmtzLCBieXRlTGVuZ3RoKQogICAgfQogIH0KCiAgY29uc3RydWN0b3IgKGJ5dGVMZW5ndGgpIHsKICAgIHRoaXMuX2J5dGVMZW5ndGggPSBieXRlTGVuZ3RoCiAgICB0aGlzLmhhbmRsZSA9IG5ldyBVaW50MzJBcnJheShJTkRFWF9MRU4gLyA0KQogIH0KCiAgZ2V0IGJ5dGVMZW5ndGggKCkgewogICAgcmV0dXJuIHRoaXMuX2J5dGVMZW5ndGgKICB9CgogIHNraXBGaXJzdCAodmFsdWUsIHBvc2l0aW9uID0gMCkgewogICAgY29uc3QgbiA9IHRoaXMuYnl0ZUxlbmd0aCAqIDgKCiAgICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiArPSBuCiAgICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiA9IDAKICAgIGlmIChwb3NpdGlvbiA+PSBuKSByZXR1cm4gbiAtIDEKCiAgICBsZXQgaSA9IE1hdGguZmxvb3IocG9zaXRpb24gLyAxNjM4NCkKCiAgICBpZiAoaSA+IDEyNykgcmV0dXJuIHBvc2l0aW9uCgogICAgd2hpbGUgKGkgPD0gMTI3ICYmIGdldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHZhbHVlLCBpKSkpIHsKICAgICAgaSsrCiAgICB9CgogICAgaWYgKGkgPT09IDEyOCkgcmV0dXJuIG4gLSAxCgogICAgbGV0IGsgPSBpICogMTYzODQKICAgIGxldCBqID0gMAoKICAgIGlmIChwb3NpdGlvbiA+IGspIGogPSBNYXRoLmZsb29yKChwb3NpdGlvbiAtIGspIC8gMTI4KQoKICAgIHdoaWxlIChqIDw9IDEyNyAmJiBnZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh2YWx1ZSwgaSAqIDEyOCArIGogKyAxMjgpKSkgewogICAgICBqKysKICAgICAgayArPSAxMjgKICAgIH0KCiAgICBpZiAoaiA9PT0gMTI4ICYmIGkgIT09IDEyNykgcmV0dXJuIHRoaXMuc2tpcEZpcnN0KHZhbHVlLCAoaSArIDEpICogMTYzODQpCgogICAgaWYgKGsgPiBwb3NpdGlvbikgcG9zaXRpb24gPSBrCgogICAgcmV0dXJuIHBvc2l0aW9uIDwgbiA/IHBvc2l0aW9uIDogbiAtIDEKICB9CgogIHNraXBMYXN0ICh2YWx1ZSwgcG9zaXRpb24gPSB0aGlzLmJ5dGVMZW5ndGggKiA4IC0gMSkgewogICAgY29uc3QgbiA9IHRoaXMuYnl0ZUxlbmd0aCAqIDgKCiAgICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiArPSBuCiAgICBpZiAocG9zaXRpb24gPCAwKSByZXR1cm4gMAogICAgaWYgKHBvc2l0aW9uID49IG4pIHBvc2l0aW9uID0gbiAtIDEKCiAgICBsZXQgaSA9IE1hdGguZmxvb3IocG9zaXRpb24gLyAxNjM4NCkKCiAgICBpZiAoaSA+IDEyNykgcmV0dXJuIHBvc2l0aW9uCgogICAgd2hpbGUgKGkgPj0gMCAmJiBnZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh2YWx1ZSwgaSkpKSB7CiAgICAgIGktLQogICAgfQoKICAgIGlmIChpID09PSAtMSkgcmV0dXJuIDAKCiAgICBsZXQgayA9ICgoaSArIDEpICogMTYzODQpIC0gMQogICAgbGV0IGogPSAxMjcKCiAgICBpZiAocG9zaXRpb24gPCBrKSBqID0gMTI4IC0gTWF0aC5jZWlsKChrIC0gcG9zaXRpb24pIC8gMTI4KQoKICAgIHdoaWxlIChqID49IDAgJiYgZ2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodmFsdWUsIGkgKiAxMjggKyBqICsgMTI4KSkpIHsKICAgICAgai0tCiAgICAgIGsgLT0gMTI4CiAgICB9CgogICAgaWYgKGogPT09IC0xICYmIGkgIT09IDApIHJldHVybiB0aGlzLnNraXBMYXN0KHZhbHVlLCBpICogMTYzODQgLSAxKQoKICAgIGlmIChrIDwgcG9zaXRpb24pIHBvc2l0aW9uID0gawoKICAgIHJldHVybiBwb3NpdGlvbgogIH0KfQoKY2xhc3MgRGVuc2VJbmRleCBleHRlbmRzIEluZGV4IHsKICBjb25zdHJ1Y3RvciAoZmllbGQsIGJ5dGVMZW5ndGgpIHsKICAgIHN1cGVyKGJ5dGVMZW5ndGgpCiAgICB0aGlzLmZpZWxkID0gZmllbGQKCiAgICBjb25zdCBtID0gZmllbGQuQllURVNfUEVSX0VMRU1FTlQKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEyODsgaSsrKSB7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMTI4OyBqKyspIHsKICAgICAgICBjb25zdCBvZmZzZXQgPSAoaSAqIDEyOCArIGopICogMTYKICAgICAgICBsZXQgYWxseiA9IHRydWUKICAgICAgICBsZXQgYWxsbyA9IGZhbHNlCgogICAgICAgIGlmIChvZmZzZXQgKyAxNiA8PSB0aGlzLmZpZWxkLmJ5dGVMZW5ndGgpIHsKICAgICAgICAgIGNvbnN0IHZlYyA9IHRoaXMuZmllbGQuc3ViYXJyYXkob2Zmc2V0IC8gbSwgKG9mZnNldCArIDE2KSAvIG0pCgogICAgICAgICAgYWxseiA9IHNpbWRsZS5hbGx6KHZlYykKICAgICAgICAgIGFsbG8gPSBzaW1kbGUuYWxsbyh2ZWMpCiAgICAgICAgfQoKICAgICAgICBjb25zdCBrID0gaSAqIDEyOCArIDEyOCArIGoKCiAgICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQoZmFsc2UsIGspLCBhbGx6KQogICAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHRydWUsIGspLCBhbGxvKQogICAgICB9CgogICAgICB7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYnl0ZU9mZnNldChmYWxzZSwgaSAqIDE2ICsgMTYpIC8gNAogICAgICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh0aGlzLmhhbmRsZS5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIDQpKQoKICAgICAgICBzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldChmYWxzZSwgaSksIGFsbG8pCiAgICAgIH0KCiAgICAgIHsKICAgICAgICBjb25zdCBvZmZzZXQgPSBieXRlT2Zmc2V0KHRydWUsIGkgKiAxNiArIDE2KSAvIDQKICAgICAgICBjb25zdCBhbGxvID0gc2ltZGxlLmFsbG8odGhpcy5oYW5kbGUuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyA0KSkKCiAgICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodHJ1ZSwgaSksIGFsbG8pCiAgICAgIH0KICAgIH0KICB9CgogIGdldCBieXRlTGVuZ3RoICgpIHsKICAgIGlmICh0aGlzLl9ieXRlTGVuZ3RoICE9PSAtMSkgcmV0dXJuIHRoaXMuX2J5dGVMZW5ndGgKICAgIHJldHVybiB0aGlzLmZpZWxkLmJ5dGVMZW5ndGgKICB9CgogIHVwZGF0ZSAoYml0KSB7CiAgICBjb25zdCBuID0gdGhpcy5ieXRlTGVuZ3RoICogOAoKICAgIGlmIChiaXQgPCAwKSBiaXQgKz0gbgogICAgaWYgKGJpdCA8IDAgfHwgYml0ID49IG4pIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IG0gPSB0aGlzLmZpZWxkLkJZVEVTX1BFUl9FTEVNRU5UCgogICAgY29uc3QgaSA9IE1hdGguZmxvb3IoYml0IC8gMTYzODQpCiAgICBjb25zdCBqID0gTWF0aC5mbG9vcihiaXQgLyAxMjgpCgogICAgY29uc3Qgb2Zmc2V0ID0gKGogKiAxNikgLyBtCiAgICBjb25zdCB2ZWMgPSB0aGlzLmZpZWxkLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgKDE2IC8gbSkpCgogICAgY29uc3QgYWxseiA9IHNpbWRsZS5hbGx6KHZlYykKICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh2ZWMpCgogICAgbGV0IGNoYW5nZWQgPSBmYWxzZQoKICAgIGlmIChzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldChmYWxzZSwgMTI4ICsgaiksIGFsbHopKSB7CiAgICAgIGNoYW5nZWQgPSB0cnVlCgogICAgICBjb25zdCBvZmZzZXQgPSBieXRlT2Zmc2V0KGZhbHNlLCBpICogMTYgKyAxNikgLyA0CiAgICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh0aGlzLmhhbmRsZS5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIDQpKQoKICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQoZmFsc2UsIGkpLCBhbGxvKQogICAgfQoKICAgIGlmIChzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh0cnVlLCAxMjggKyBqKSwgYWxsbykpIHsKICAgICAgY2hhbmdlZCA9IHRydWUKCiAgICAgIGNvbnN0IG9mZnNldCA9IGJ5dGVPZmZzZXQodHJ1ZSwgaSAqIDE2ICsgMTYpIC8gNAogICAgICBjb25zdCBhbGxvID0gc2ltZGxlLmFsbG8odGhpcy5oYW5kbGUuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyA0KSkKCiAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHRydWUsIGkpLCBhbGxvKQogICAgfQoKICAgIHJldHVybiBjaGFuZ2VkCiAgfQp9CgpmdW5jdGlvbiBzZWxlY3RDaHVuayAoY2h1bmtzLCBvZmZzZXQpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IGNodW5rcy5sZW5ndGg7IGkrKykgewogICAgY29uc3QgbmV4dCA9IGNodW5rc1tpXQoKICAgIGNvbnN0IHN0YXJ0ID0gbmV4dC5vZmZzZXQKICAgIGNvbnN0IGVuZCA9IG5leHQub2Zmc2V0ICsgbmV4dC5maWVsZC5ieXRlTGVuZ3RoCgogICAgaWYgKG9mZnNldCA+PSBzdGFydCAmJiBvZmZzZXQgKyAxNiA8PSBlbmQpIHsKICAgICAgcmV0dXJuIG5leHQKICAgIH0KICB9CgogIHJldHVybiBudWxsCn0KCmNsYXNzIFNwYXJzZUluZGV4IGV4dGVuZHMgSW5kZXggewogIGNvbnN0cnVjdG9yIChjaHVua3MsIGJ5dGVMZW5ndGgpIHsKICAgIHN1cGVyKGJ5dGVMZW5ndGgpCiAgICB0aGlzLmNodW5rcyA9IGNodW5rcwoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTI4OyBpKyspIHsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCAxMjg7IGorKykgewogICAgICAgIGNvbnN0IG9mZnNldCA9IChpICogMTI4ICsgaikgKiAxNgogICAgICAgIGxldCBhbGx6ID0gdHJ1ZQogICAgICAgIGxldCBhbGxvID0gZmFsc2UKCiAgICAgICAgY29uc3QgY2h1bmsgPSBzZWxlY3RDaHVuayh0aGlzLmNodW5rcywgb2Zmc2V0KQoKICAgICAgICBpZiAoY2h1bmsgIT09IG51bGwpIHsKICAgICAgICAgIGNvbnN0IG0gPSBjaHVuay5maWVsZC5CWVRFU19QRVJfRUxFTUVOVAoKICAgICAgICAgIGNvbnN0IHZlYyA9IGNodW5rLmZpZWxkLnN1YmFycmF5KChvZmZzZXQgLSBjaHVuay5vZmZzZXQpIC8gbSwgKG9mZnNldCAtIGNodW5rLm9mZnNldCArIDE2KSAvIG0pCgogICAgICAgICAgYWxseiA9IHNpbWRsZS5hbGx6KHZlYykKICAgICAgICAgIGFsbG8gPSBzaW1kbGUuYWxsbyh2ZWMpCiAgICAgICAgfQoKICAgICAgICBjb25zdCBrID0gaSAqIDEyOCArIDEyOCArIGoKCiAgICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQoZmFsc2UsIGspLCBhbGx6KQogICAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHRydWUsIGspLCBhbGxvKQogICAgICB9CgogICAgICB7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYnl0ZU9mZnNldChmYWxzZSwgaSAqIDE2ICsgMTYpIC8gNAogICAgICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh0aGlzLmhhbmRsZS5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIDQpKQoKICAgICAgICBzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldChmYWxzZSwgaSksIGFsbG8pCiAgICAgIH0KCiAgICAgIHsKICAgICAgICBjb25zdCBvZmZzZXQgPSBieXRlT2Zmc2V0KHRydWUsIGkgKiAxNiArIDE2KSAvIDQKICAgICAgICBjb25zdCBhbGxvID0gc2ltZGxlLmFsbG8odGhpcy5oYW5kbGUuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyA0KSkKCiAgICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodHJ1ZSwgaSksIGFsbG8pCiAgICAgIH0KICAgIH0KICB9CgogIGdldCBieXRlTGVuZ3RoICgpIHsKICAgIGlmICh0aGlzLl9ieXRlTGVuZ3RoICE9PSAtMSkgcmV0dXJuIHRoaXMuX2J5dGVMZW5ndGgKICAgIGNvbnN0IGxhc3QgPSB0aGlzLmNodW5rc1t0aGlzLmNodW5rcy5sZW5ndGggLSAxXQogICAgcmV0dXJuIGxhc3QgPyBsYXN0Lm9mZnNldCArIGxhc3QuZmllbGQuYnl0ZUxlbmd0aCA6IDAKICB9CgogIHVwZGF0ZSAoYml0KSB7CiAgICBjb25zdCBuID0gdGhpcy5ieXRlTGVuZ3RoICogOAoKICAgIGlmIChiaXQgPCAwKSBiaXQgKz0gbgogICAgaWYgKGJpdCA8IDAgfHwgYml0ID49IG4pIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGkgPSBNYXRoLmZsb29yKGJpdCAvIDE2Mzg0KQogICAgY29uc3QgaiA9IE1hdGguZmxvb3IoYml0IC8gMTI4KQoKICAgIGNvbnN0IG9mZnNldCA9IGogKiAxNgoKICAgIGNvbnN0IGNodW5rID0gc2VsZWN0Q2h1bmsodGhpcy5jaHVua3MsIG9mZnNldCkKCiAgICBpZiAoY2h1bmsgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IG0gPSBjaHVuay5maWVsZC5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGNvbnN0IHZlYyA9IGNodW5rLmZpZWxkLnN1YmFycmF5KChvZmZzZXQgLSBjaHVuay5vZmZzZXQpIC8gbSwgKG9mZnNldCAtIGNodW5rLm9mZnNldCArIDE2KSAvIG0pCgogICAgY29uc3QgYWxseiA9IHNpbWRsZS5hbGx6KHZlYykKICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh2ZWMpCgogICAgbGV0IGNoYW5nZWQgPSBmYWxzZQoKICAgIGlmIChzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldChmYWxzZSwgMTI4ICsgaiksIGFsbHopKSB7CiAgICAgIGNoYW5nZWQgPSB0cnVlCgogICAgICBjb25zdCBvZmZzZXQgPSBieXRlT2Zmc2V0KGZhbHNlLCBpICogMTYgKyAxNikgLyA0CiAgICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh0aGlzLmhhbmRsZS5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIDQpKQoKICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQoZmFsc2UsIGkpLCBhbGxvKQogICAgfQoKICAgIGlmIChzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh0cnVlLCAxMjggKyBqKSwgYWxsbykpIHsKICAgICAgY2hhbmdlZCA9IHRydWUKCiAgICAgIGNvbnN0IG9mZnNldCA9IGJ5dGVPZmZzZXQodHJ1ZSwgaSAqIDE2ICsgMTYpIC8gNAogICAgICBjb25zdCBhbGxvID0gc2ltZGxlLmFsbG8odGhpcy5oYW5kbGUuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyA0KSkKCiAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHRydWUsIGkpLCBhbGxvKQogICAgfQoKICAgIHJldHVybiBjaGFuZ2VkCiAgfQp9CmNvbnN0IGZhbGxiYWNrID0gcmVxdWlyZSgnLi9mYWxsYmFjaycpCgp0cnkgewogIGNvbnN0IG5hdGl2ZSA9IHJlcXVpcmUoJ3F1aWNrYml0LW5hdGl2ZScpCgogIC8vIFRoZXNlIGZ1bmN0aW9ucyBhcmUgZmFzdGVyIGluIEphdmFTY3JpcHQKICBleHBvcnRzLmdldCA9IGZhbGxiYWNrLmdldAogIGV4cG9ydHMuc2V0ID0gZmFsbGJhY2suc2V0CiAgZXhwb3J0cy5maWxsID0gZmFsbGJhY2suZmlsbAoKICAvLyBUaGVzZSBmdW5jdGlvbnMgYXJlIGZhc3RlciBpbiBDCiAgZXhwb3J0cy5jbGVhciA9IG5hdGl2ZS5jbGVhcgogIGV4cG9ydHMuZmluZEZpcnN0ID0gbmF0aXZlLmZpbmRGaXJzdAogIGV4cG9ydHMuZmluZExhc3QgPSBuYXRpdmUuZmluZExhc3QKICBleHBvcnRzLkluZGV4ID0gbmF0aXZlLkluZGV4Cn0gY2F0Y2ggewogIG1vZHVsZS5leHBvcnRzID0gZmFsbGJhY2sKfQp7CiAgIm5hbWUiOiAicXVpY2tiaXQtdW5pdmVyc2FsIiwKICAidmVyc2lvbiI6ICIyLjIuMCIsCiAgImRlc2NyaXB0aW9uIjogIlVuaXZlcnNhbCB3cmFwcGVyIGZvciBsaWJxdWlja2JpdCB3aXRoIGEgSmF2YVNjcmlwdCBmYWxsYmFjayIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJmYWxsYmFjay5qcyIsCiAgICAiaW5kZXguanMiCiAgXSwKICAiYnJvd3NlciI6IHsKICAgICIuL2luZGV4LmpzIjogIi4vZmFsbGJhY2suanMiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5tanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcXVpY2tiaXQtdW5pdmVyc2FsLmdpdCIKICB9LAogICJhdXRob3IiOiAiS2FzcGVyIElzYWdlciBEYWxzZ2Fyw7AgPGthc3BlckBmdW5rdGlvbmVsLmNvPiIsCiAgImxpY2Vuc2UiOiAiSVNDIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3F1aWNrYml0LXVuaXZlcnNhbC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3F1aWNrYml0LXVuaXZlcnNhbCNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMCIsCiAgICAic2ltZGxlLXVuaXZlcnNhbCI6ICJeMS4xLjAiCiAgfSwKICAib3B0aW9uYWxEZXBlbmRlbmNpZXMiOiB7CiAgICAicXVpY2tiaXQtbmF0aXZlIjogIl4yLjIuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4xLjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfQp9CmNsYXNzIENhY2hlRW50cnkgewogIGNvbnN0cnVjdG9yIChrZXksIGluZGV4LCBtYXApIHsKICAgIHRoaXMua2V5ID0ga2V5CiAgICB0aGlzLmluZGV4ID0gaW5kZXgKICAgIHRoaXMubWFwID0gbWFwCiAgfQp9CgpjbGFzcyBDYWNoZVZhbHVlIHsKICBjb25zdHJ1Y3RvciAoZW50cnksIHZhbHVlKSB7CiAgICB0aGlzLmVudHJ5ID0gZW50cnkKICAgIHRoaXMudmFsdWUgPSB2YWx1ZQogIH0KfQoKY2xhc3MgUmFjaGUgewogIGNvbnN0cnVjdG9yICh7IG1heFNpemUgPSA2NTUzNiwgcGFyZW50ID0gbnVsbCB9ID0ge30pIHsKICAgIHRoaXMubWF4U2l6ZSA9IHBhcmVudD8ubWF4U2l6ZSB8fCBtYXhTaXplCgogICAgdGhpcy5fYXJyYXkgPSBwYXJlbnQ/Ll9hcnJheSB8fCBbXQogICAgdGhpcy5fbWFwID0gbmV3IE1hcCgpCiAgfQoKICBzdGF0aWMgZnJvbSAoY2FjaGUpIHsKICAgIHJldHVybiBjYWNoZSA/IG5ldyB0aGlzKHsgcGFyZW50OiBjYWNoZSB9KSA6IG5ldyB0aGlzKCkKICB9CgogIGdldCBnbG9iYWxTaXplICgpIHsKICAgIHJldHVybiB0aGlzLl9hcnJheS5sZW5ndGgKICB9CgogIGdldCBzaXplICgpIHsKICAgIHJldHVybiB0aGlzLl9tYXAuc2l6ZQogIH0KCiAgc3ViICgpIHsKICAgIHJldHVybiBuZXcgUmFjaGUoeyBwYXJlbnQ6IHRoaXMgfSkKICB9CgogIHNldCAoa2V5LCB2YWx1ZSkgeyAvLyB+Y29uc3RhbnQgdGltZQogICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLl9tYXAuZ2V0KGtleSkKICAgIGlmIChleGlzdGluZyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGV4aXN0aW5nLnZhbHVlID0gdmFsdWUKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMuX2FycmF5Lmxlbmd0aCA+PSB0aGlzLm1heFNpemUpIHRoaXMuX2djKCkKCiAgICBjb25zdCBlbnRyeSA9IG5ldyBDYWNoZUVudHJ5KGtleSwgdGhpcy5fYXJyYXkubGVuZ3RoLCB0aGlzLl9tYXApCiAgICB0aGlzLl9hcnJheS5wdXNoKGVudHJ5KQogICAgY29uc3QgY2FjaGVWYWx1ZSA9IG5ldyBDYWNoZVZhbHVlKGVudHJ5LCB2YWx1ZSkKICAgIHRoaXMuX21hcC5zZXQoa2V5LCBjYWNoZVZhbHVlKQogIH0KCiAgZGVsZXRlIChrZXkpIHsKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5fbWFwLmdldChrZXkpCiAgICBpZiAoZXhpc3RpbmcgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlCgogICAgdGhpcy5fZGVsZXRlKGV4aXN0aW5nLmVudHJ5LmluZGV4KQogICAgcmV0dXJuIHRydWUKICB9CgogIGdldCAoa2V5KSB7CiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuX21hcC5nZXQoa2V5KQogICAgcmV0dXJuIGV4aXN0aW5nID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBleGlzdGluZy52YWx1ZQogIH0KCiAgKiBbU3ltYm9sLml0ZXJhdG9yXSAoKSB7CiAgICBmb3IgKGNvbnN0IFtrZXksIHsgdmFsdWUgfV0gb2YgdGhpcy5fbWFwKSB7CiAgICAgIHlpZWxkIFtrZXksIHZhbHVlXQogICAgfQogIH0KCiAga2V5cyAoKSB7CiAgICByZXR1cm4gdGhpcy5fbWFwLmtleXMoKQogIH0KCiAgKiB2YWx1ZXMgKCkgewogICAgZm9yIChjb25zdCB7IHZhbHVlIH0gb2YgdGhpcy5fbWFwLnZhbHVlcygpKSB7CiAgICAgIHlpZWxkIHZhbHVlCiAgICB9CiAgfQoKICBjbGVhciAoKSB7CiAgICAvLyBUaGUgZW50cmllcyBpbiBtYXAgbGluZ2VyIG9uIGluIF9hcnJheSwKICAgIC8vIHNvIG9uIHRvcCBvZiBjbGVhcmluZyB0aGUgbWFwLCB3ZSBhbHNvIGtpbGwgdGhlIHJlZiwKICAgIC8vIHNvIHRoYXQgYW55IGdjIHJ1bm5pbmcgbGF0ZXIgb24gdGhlIG9sZCBtYXAgd29uJ3QgaW50ZXJmZXJlCiAgICAvLyAoaW4gY2FzZSBhIG5ldyBlbnRyeSB3YXMgYWRkZWQgd2l0aCB0aGUgc2FtZSBrZXkgYXMgYSBjbGVhcmVkIGVudHJ5KQoKICAgIHRoaXMuX21hcC5jbGVhcigpCiAgICB0aGlzLl9tYXAgPSBuZXcgTWFwKCkKICB9CgogIGRlc3Ryb3kgKCkgewogICAgdGhpcy5fbWFwID0gbnVsbAogICAgdGhpcy5fYXJyYXkgPSBudWxsCiAgfQoKICBfZ2MgKCkgewogICAgdGhpcy5fZGVsZXRlKE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHRoaXMuX2FycmF5Lmxlbmd0aCkpCiAgfQoKICBfZGVsZXRlIChpbmRleCkgeyAvLyB+Y29uc3RhbnQgdGltZQogICAgaWYgKGluZGV4ID49IHRoaXMuX2FycmF5Lmxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZGVsZXRlIHVudXNlZCBpbmRleCAobG9naWMgYnVnPyknKQoKICAgIGNvbnN0IGhlYWQgPSB0aGlzLl9hcnJheS5wb3AoKQogICAgbGV0IHJlbW92ZWQgPSBoZWFkCgogICAgaWYgKGluZGV4IDwgdGhpcy5fYXJyYXkubGVuZ3RoKSB7CiAgICAgIHJlbW92ZWQgPSB0aGlzLl9hcnJheVtpbmRleF0KICAgICAgaGVhZC5pbmRleCA9IGluZGV4CiAgICAgIHRoaXMuX2FycmF5W2luZGV4XSA9IGhlYWQKICAgIH0KCiAgICByZW1vdmVkLm1hcC5kZWxldGUocmVtb3ZlZC5rZXkpCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IFJhY2hlCnsKICAibmFtZSI6ICJyYWNoZSIsCiAgInZlcnNpb24iOiAiMS4wLjAiLAogICJkZXNjcmlwdGlvbiI6ICJSYW5kb20tZXZpY3Rpb24gY2FjaGUiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyAtLWNvdmVyYWdlIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JhY2hlLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JhY2hlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmFjaGUjcmVhZG1lIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjUuMiIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSYW5kb21BcnJheUl0ZXJhdG9yIHsKICBjb25zdHJ1Y3RvciAodmFsdWVzKSB7CiAgICB0aGlzLnZhbHVlcyA9IHZhbHVlcwogICAgdGhpcy5zdGFydCA9IDAKICAgIHRoaXMubGVuZ3RoID0gdGhpcy52YWx1ZXMubGVuZ3RoCiAgfQoKICBuZXh0ICgpIHsKICAgIGlmICh0aGlzLmxlbmd0aCA9PT0gMCkgewogICAgICBpZiAodGhpcy5zdGFydCA9PT0gMCkgcmV0dXJuIHsgZG9uZTogdHJ1ZSwgdmFsdWU6IHVuZGVmaW5lZCB9CiAgICAgIHRoaXMubGVuZ3RoID0gdGhpcy5zdGFydAogICAgICB0aGlzLnN0YXJ0ID0gMAogICAgfQoKICAgIGNvbnN0IGkgPSB0aGlzLnN0YXJ0ICsgKChNYXRoLnJhbmRvbSgpICogdGhpcy5sZW5ndGgpIHwgMCkKICAgIGNvbnN0IGogPSB0aGlzLnN0YXJ0ICsgLS10aGlzLmxlbmd0aAogICAgY29uc3QgdmFsdWUgPSB0aGlzLnZhbHVlc1tpXQoKICAgIHRoaXMudmFsdWVzW2ldID0gdGhpcy52YWx1ZXNbal0KICAgIHRoaXMudmFsdWVzW2pdID0gdmFsdWUKCiAgICByZXR1cm4geyBkb25lOiBmYWxzZSwgdmFsdWUgfQogIH0KCiAgZGVxdWV1ZSAoKSB7CiAgICB0aGlzLnZhbHVlc1t0aGlzLnN0YXJ0ICsgdGhpcy5sZW5ndGhdID0gdGhpcy52YWx1ZXNbdGhpcy52YWx1ZXMubGVuZ3RoIC0gMV0KICAgIHRoaXMudmFsdWVzLnBvcCgpCiAgfQoKICByZXF1ZXVlICgpIHsKICAgIGNvbnN0IGkgPSB0aGlzLnN0YXJ0ICsgdGhpcy5sZW5ndGgKICAgIGNvbnN0IHZhbHVlID0gdGhpcy52YWx1ZXNbaV0KICAgIHRoaXMudmFsdWVzW2ldID0gdGhpcy52YWx1ZXNbdGhpcy5zdGFydF0KICAgIHRoaXMudmFsdWVzW3RoaXMuc3RhcnQrK10gPSB2YWx1ZQogIH0KCiAgcmVzdGFydCAoKSB7CiAgICB0aGlzLnN0YXJ0ID0gMAogICAgdGhpcy5sZW5ndGggPSB0aGlzLnZhbHVlcy5sZW5ndGgKICAgIHJldHVybiB0aGlzCiAgfQoKICBbU3ltYm9sLml0ZXJhdG9yXSAoKSB7CiAgICByZXR1cm4gdGhpcwogIH0KfQp7CiAgIm5hbWUiOiAicmFuZG9tLWFycmF5LWl0ZXJhdG9yIiwKICAidmVyc2lvbiI6ICIxLjAuMCIsCiAgImRlc2NyaXB0aW9uIjogIkFuIGl0ZXJhdG9yIHRvIGl0ZXJhdGUgYW4gYXJyYXkgaW4gcmFuZG9tIG9yZGVyIHdpdGggY29udHJvbHMgdG8gcmVxdWV1ZSBvciBkZXF1ZXVlIGVsZW1lbnRzIGR1cmluZyB0aGUgaXRlcmF0aW9uIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE2LjAuMyIsCiAgICAidGFwZSI6ICJeNS4wLjEiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9yYW5kb20tYXJyYXktaXRlcmF0b3IuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3JhbmRvbS1hcnJheS1pdGVyYXRvci9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9yYW5kb20tYXJyYXktaXRlcmF0b3IiCn0KY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUmVhZHlSZXNvdXJjZSBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IgKCkgewogICAgc3VwZXIoKQoKICAgIHRoaXMub3BlbmluZyA9IG51bGwKICAgIHRoaXMuY2xvc2luZyA9IG51bGwKCiAgICB0aGlzLm9wZW5lZCA9IGZhbHNlCiAgICB0aGlzLmNsb3NlZCA9IGZhbHNlCiAgfQoKICByZWFkeSAoKSB7CiAgICBpZiAodGhpcy5vcGVuaW5nICE9PSBudWxsKSByZXR1cm4gdGhpcy5vcGVuaW5nCiAgICB0aGlzLm9wZW5pbmcgPSBvcGVuKHRoaXMpCiAgICByZXR1cm4gdGhpcy5vcGVuaW5nCiAgfQoKICBjbG9zZSAoKSB7CiAgICBpZiAodGhpcy5jbG9zaW5nICE9PSBudWxsKSByZXR1cm4gdGhpcy5jbG9zaW5nCiAgICB0aGlzLmNsb3NpbmcgPSBjbG9zZSh0aGlzKQogICAgcmV0dXJuIHRoaXMuY2xvc2luZwogIH0KCiAgYXN5bmMgX29wZW4gKCkgewogICAgLy8gYWRkIGltcGwgaGVyZQogIH0KCiAgYXN5bmMgX2Nsb3NlICgpIHsKICAgIC8vIGFkZCBpbXBsIGhlcmUKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIG9wZW4gKHNlbGYpIHsKICAvLyBvcGVuIGFmdGVyIGNsb3NlCiAgaWYgKHNlbGYuY2xvc2luZyAhPT0gbnVsbCkgcmV0dXJuCgogIHRyeSB7CiAgICBhd2FpdCBzZWxmLl9vcGVuKCkKICB9IGNhdGNoIChlcnIpIHsKICAgIHNlbGYuY2xvc2UoKSAvLyBzYWZlIHRvIHJ1biBpbiBiZwogICAgdGhyb3cgZXJyCiAgfQoKICBzZWxmLm9wZW5lZCA9IHRydWUKICBzZWxmLmVtaXQoJ3JlYWR5JykKfQoKYXN5bmMgZnVuY3Rpb24gY2xvc2UgKHNlbGYpIHsKICB0cnkgewogICAgaWYgKHNlbGYub3BlbmVkID09PSBmYWxzZSAmJiBzZWxmLm9wZW5pbmcgIT09IG51bGwpIGF3YWl0IHNlbGYub3BlbmluZwogIH0gY2F0Y2ggewogICAgLy8gaWdub3JlIGVycm9ycyBvbiBjbG9zaW5nCiAgfQogIGlmIChzZWxmLm9wZW5lZCA9PT0gdHJ1ZSB8fCBzZWxmLm9wZW5pbmcgPT09IG51bGwpIGF3YWl0IHNlbGYuX2Nsb3NlKCkKICBzZWxmLmNsb3NlZCA9IHRydWUKICBzZWxmLmVtaXQoJ2Nsb3NlJykKfQp7CiAgIm5hbWUiOiAicmVhZHktcmVzb3VyY2UiLAogICJ2ZXJzaW9uIjogIjEuMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiTW9kZXJuIHNpbmdsZSByZXNvdXJjZSBtYW5hZ2VtZW50IiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImltcG9ydHMiOiB7CiAgICAiZXZlbnRzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWV2ZW50cyIsCiAgICAgICJkZWZhdWx0IjogImV2ZW50cyIKICAgIH0KICB9LAogICJ0eXBlcyI6ICJpbmRleC5kLnRzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImluZGV4LmQudHMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4xLjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVhZHktcmVzb3VyY2UuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVhZHktcmVzb3VyY2UvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yZWFkeS1yZXNvdXJjZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWV2ZW50cyI6ICJeMi4yLjAiCiAgfQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgp2YXIgRU1QVFkgPSBbXQoKbW9kdWxlLmV4cG9ydHMgPSBSZWNvcmRDYWNoZQoKZnVuY3Rpb24gUmVjb3JkU2V0ICgpIHsKICB0aGlzLmxpc3QgPSBbXQogIHRoaXMubWFwID0gbmV3IE1hcCgpCn0KClJlY29yZFNldC5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gKHJlY29yZCwgdmFsdWUpIHsKICB2YXIgayA9IHRvU3RyaW5nKHJlY29yZCkKICB2YXIgciA9IHRoaXMubWFwLmdldChrKQogIGlmIChyKSByZXR1cm4gZmFsc2UKCiAgciA9IHtpbmRleDogdGhpcy5saXN0Lmxlbmd0aCwgcmVjb3JkOiB2YWx1ZSB8fCByZWNvcmR9CiAgdGhpcy5saXN0LnB1c2gocikKICB0aGlzLm1hcC5zZXQoaywgcikKICByZXR1cm4gdHJ1ZQp9CgpSZWNvcmRTZXQucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIChyZWNvcmQpIHsKICB2YXIgayA9IHRvU3RyaW5nKHJlY29yZCkKICB2YXIgciA9IHRoaXMubWFwLmdldChrKQogIGlmICghcikgcmV0dXJuIGZhbHNlCgogIHN3YXAodGhpcy5saXN0LCByLmluZGV4LCB0aGlzLmxpc3QubGVuZ3RoIC0gMSkKICB0aGlzLmxpc3QucG9wKCkKICB0aGlzLm1hcC5kZWxldGUoaykKICByZXR1cm4gdHJ1ZQp9CgpmdW5jdGlvbiBSZWNvcmRTdG9yZSAoKSB7CiAgdGhpcy5yZWNvcmRzID0gbmV3IE1hcCgpCiAgdGhpcy5zaXplID0gMAp9CgpSZWNvcmRTdG9yZS5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gKG5hbWUsIHJlY29yZCwgdmFsdWUpIHsKICB2YXIgciA9IHRoaXMucmVjb3Jkcy5nZXQobmFtZSkKCiAgaWYgKCFyKSB7CiAgICByID0gbmV3IFJlY29yZFNldCgpCiAgICB0aGlzLnJlY29yZHMuc2V0KG5hbWUsIHIpCiAgfQoKICBpZiAoci5hZGQocmVjb3JkLCB2YWx1ZSkpIHsKICAgIHRoaXMuc2l6ZSsrCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgcmV0dXJuIGZhbHNlCn0KClJlY29yZFN0b3JlLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiAobmFtZSwgcmVjb3JkLCB2YWx1ZSkgewogIHZhciByID0gdGhpcy5yZWNvcmRzLmdldChuYW1lKQogIGlmICghcikgcmV0dXJuIGZhbHNlCgogIGlmIChyLnJlbW92ZShyZWNvcmQsIHZhbHVlKSkgewogICAgdGhpcy5zaXplLS0KICAgIGlmICghci5tYXAuc2l6ZSkgdGhpcy5yZWNvcmRzLmRlbGV0ZShuYW1lKQogICAgcmV0dXJuIHRydWUKICB9CgogIHJldHVybiBmYWxzZQp9CgpSZWNvcmRTdG9yZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKG5hbWUpIHsKICB2YXIgciA9IHRoaXMucmVjb3Jkcy5nZXQobmFtZSkKICByZXR1cm4gciA/IHIubGlzdCA6IEVNUFRZCn0KCmZ1bmN0aW9uIFJlY29yZENhY2hlIChvcHRzKSB7CiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFJlY29yZENhY2hlKSkgcmV0dXJuIG5ldyBSZWNvcmRDYWNoZShvcHRzKQogIGlmICghb3B0cykgb3B0cyA9IHt9CgogIHRoaXMubWF4U2l6ZSA9IG9wdHMubWF4U2l6ZSB8fCBJbmZpbml0eQogIHRoaXMubWF4QWdlID0gb3B0cy5tYXhBZ2UgfHwgMAoKICB0aGlzLl9vbnN0YWxlID0gb3B0cy5vblN0YWxlIHx8IG9wdHMub25zdGFsZSB8fCBudWxsCiAgdGhpcy5fZnJlc2ggPSBuZXcgUmVjb3JkU3RvcmUoKQogIHRoaXMuX3N0YWxlID0gbmV3IFJlY29yZFN0b3JlKCkKICB0aGlzLl9pbnRlcnZhbCA9IG51bGwKICB0aGlzLl9nY2VkID0gZmFsc2UKCiAgaWYgKHRoaXMubWF4QWdlICYmIHRoaXMubWF4QWdlIDwgSW5maW5pdHkpIHsKICAgIC8vIDIvMyBnaXZlcyB1cyBhIHNwYW4gb2YgMC42Ni0xLjMzIG1heEFnZSBvciBhdmcgbWF4QWdlCiAgICB2YXIgdGljayA9IE1hdGguY2VpbCgyIC8gMyAqIHRoaXMubWF4QWdlKQogICAgdGhpcy5faW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLl9nY0F1dG8uYmluZCh0aGlzKSwgdGljaykKICAgIGlmICh0aGlzLl9pbnRlcnZhbC51bnJlZikgdGhpcy5faW50ZXJ2YWwudW5yZWYoKQogIH0KfQoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFJlY29yZENhY2hlLnByb3RvdHlwZSwgJ3NpemUnLCB7CiAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZnJlc2guc2l6ZSArIHRoaXMuX3N0YWxlLnNpemUKICB9Cn0pCgpSZWNvcmRDYWNoZS5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gKG5hbWUsIHJlY29yZCwgdmFsdWUpIHsKICB0aGlzLl9zdGFsZS5yZW1vdmUobmFtZSwgcmVjb3JkLCB2YWx1ZSkKICBpZiAodGhpcy5fZnJlc2guYWRkKG5hbWUsIHJlY29yZCwgdmFsdWUpICYmIHRoaXMuX2ZyZXNoLnNpemUgPiB0aGlzLm1heFNpemUpIHsKICAgIHRoaXMuX2djKCkKICB9Cn0KClJlY29yZENhY2hlLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiAobmFtZSwgcmVjb3JkLCB2YWx1ZSkgewogIHRoaXMuX2ZyZXNoLnJlbW92ZShuYW1lLCByZWNvcmQsIHZhbHVlKQogIHRoaXMuX3N0YWxlLnJlbW92ZShuYW1lLCByZWNvcmQsIHZhbHVlKQp9CgpSZWNvcmRDYWNoZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKG5hbWUsIG4pIHsKICB2YXIgYSA9IHRoaXMuX2ZyZXNoLmdldChuYW1lKQogIHZhciBiID0gdGhpcy5fc3RhbGUuZ2V0KG5hbWUpCiAgdmFyIGFMZW4gPSBhLmxlbmd0aAogIHZhciBiTGVuID0gYi5sZW5ndGgKICB2YXIgbGVuID0gYUxlbiArIGJMZW4KCiAgaWYgKG4gPiBsZW4gfHwgIW4pIG4gPSBsZW4KICB2YXIgcmVzdWx0ID0gbmV3IEFycmF5KG4pCgogIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKSB7CiAgICB2YXIgaiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChhTGVuICsgYkxlbikpCiAgICBpZiAoaiA8IGFMZW4pIHsKICAgICAgcmVzdWx0W2ldID0gYVtqXS5yZWNvcmQKICAgICAgc3dhcChhLCBqLCAtLWFMZW4pCiAgICB9IGVsc2UgewogICAgICBqIC09IGFMZW4KICAgICAgcmVzdWx0W2ldID0gYltqXS5yZWNvcmQKICAgICAgc3dhcChiLCBqLCAtLWJMZW4pCiAgICB9CiAgfQoKICByZXR1cm4gcmVzdWx0Cn0KClJlY29yZENhY2hlLnByb3RvdHlwZS5fZ2NBdXRvID0gZnVuY3Rpb24gKCkgewogIGlmICghdGhpcy5fZ2NlZCkgdGhpcy5fZ2MoKQogIHRoaXMuX2djZWQgPSBmYWxzZQp9CgpSZWNvcmRDYWNoZS5wcm90b3R5cGUuX2djID0gZnVuY3Rpb24gKCkgewogIGlmICh0aGlzLl9vbnN0YWxlICYmIHRoaXMuX3N0YWxlLnNpemUgPiAwKSB0aGlzLl9vbnN0YWxlKHRoaXMuX3N0YWxlKQogIHRoaXMuX3N0YWxlID0gdGhpcy5fZnJlc2gKICB0aGlzLl9mcmVzaCA9IG5ldyBSZWNvcmRTdG9yZSgpCiAgdGhpcy5fZ2NlZCA9IHRydWUKfQoKUmVjb3JkQ2FjaGUucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gKCkgewogIHRoaXMuX2djKCkKICB0aGlzLl9nYygpCn0KClJlY29yZENhY2hlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogIHRoaXMuY2xlYXIoKQogIGNsZWFySW50ZXJ2YWwodGhpcy5faW50ZXJ2YWwpCiAgdGhpcy5faW50ZXJ2YWwgPSBudWxsCn0KCmZ1bmN0aW9uIHRvU3RyaW5nIChyZWNvcmQpIHsKICByZXR1cm4gYjRhLmlzQnVmZmVyKHJlY29yZCkgPyBiNGEudG9TdHJpbmcocmVjb3JkLCAnaGV4JykgOiByZWNvcmQKfQoKZnVuY3Rpb24gc3dhcCAobGlzdCwgYSwgYikgewogIHZhciB0bXAgPSBsaXN0W2FdCiAgdG1wLmluZGV4ID0gYgogIGxpc3RbYl0uaW5kZXggPSBhCiAgbGlzdFthXSA9IGxpc3RbYl0KICBsaXN0W2JdID0gdG1wCn0KewogICJuYW1lIjogInJlY29yZC1jYWNoZSIsCiAgInZlcnNpb24iOiAiMS4yLjAiLAogICJkZXNjcmlwdGlvbiI6ICJDYWNoZSBvcHRpbWlzZWQgZm9yIHJlY29yZCBsaWtlIHRoaW5ncyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjMuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjEwLjAuMyIsCiAgICAidGFwZSI6ICJeNC44LjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9yZWNvcmQtY2FjaGUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3JlY29yZC1jYWNoZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9yZWNvcmQtY2FjaGUiCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSZWZDb3VudGVyIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuY291bnQgPSAwCgogICAgdGhpcy5fb25pZGxlID0gbnVsbAogICAgdGhpcy5faWRsZSA9IG51bGwKICB9CgogIGlzSWRsZSgpIHsKICAgIHJldHVybiB0aGlzLmNvdW50ID09PSAwCiAgfQoKICBpZGxlKCkgewogICAgaWYgKHRoaXMuY291bnQgPT09IDApIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQogICAgaWYgKHRoaXMuX2lkbGUgIT09IG51bGwpIHJldHVybiB0aGlzLl9pZGxlCgogICAgdGhpcy5faWRsZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgIHRoaXMuX29uaWRsZSA9IHJlc29sdmUKICAgIH0pCgogICAgcmV0dXJuIHRoaXMuX2lkbGUKICB9CgogIGluYygpIHsKICAgIHRoaXMuY291bnQrKwogIH0KCiAgZGVjKCkgewogICAgaWYgKC0tdGhpcy5jb3VudCA+IDApIHJldHVybgoKICAgIGlmICh0aGlzLl9vbmlkbGUgIT09IG51bGwpIHsKICAgICAgY29uc3QgcmVzb2x2ZSA9IHRoaXMuX29uaWRsZQogICAgICB0aGlzLl9pZGxlID0gbnVsbAogICAgICB0aGlzLl9vbmlkbGUgPSBudWxsCiAgICAgIHJlc29sdmUoKQogICAgfQogIH0KfQp7CiAgIm5hbWUiOiAicmVmY291bnRlciIsCiAgInZlcnNpb24iOiAiMS4wLjAiLAogICJkZXNjcmlwdGlvbiI6ICJTaW1wbGUgcmVmY291bnRlciIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjoge30sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVmY291bnRlci5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMiLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVmY291bnRlci9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JlZmNvdW50ZXIiCn0KbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uLmJpbmQocmVxdWlyZSkKewogICJuYW1lIjogInJlcXVpcmUtYWRkb24iLAogICJ2ZXJzaW9uIjogIjEuMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiSW1wb3J0IG5hdGl2ZSBhZGRvbnMgYWNyb3NzIEphdmFTY3JpcHQgcnVudGltZXMiLAogICJleHBvcnRzIjogewogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLiI6IHsKICAgICAgImJhcmUiOiAiLi9saWIvYmFyZS5qcyIsCiAgICAgICJub2RlIjogIi4vbGliL25vZGUuanMiLAogICAgICAiZGVmYXVsdCI6ICIuL2xpYi9kZWZhdWx0LmpzIgogICAgfQogIH0sCiAgImltcG9ydHMiOiB7CiAgICAiZnMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZnMiLAogICAgICAiZGVmYXVsdCI6ICJmcyIKICAgIH0sCiAgICAicGF0aCI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1wYXRoIiwKICAgICAgImRlZmF1bHQiOiAicGF0aCIKICAgIH0sCiAgICAidXJsIjogewogICAgICAiYmFyZSI6ICJiYXJlLXVybCIsCiAgICAgICJkZWZhdWx0IjogInVybCIKICAgIH0KICB9LAogICJmaWxlcyI6IFsKICAgICJsaWIiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogIm5wbSBydW4gbGludCAmJiBucG0gcnVuIHRlc3Q6YmFyZSAmJiBucG0gcnVuIHRlc3Q6bm9kZSIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC5qcyIsCiAgICAidGVzdDpub2RlIjogIm5vZGUgdGVzdC5qcyIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4iLAogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVxdWlyZS1hZGRvbi5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yZXF1aXJlLWFkZG9uL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVxdWlyZS1hZGRvbiNyZWFkbWUiLAogICJlbmdpbmVzIjogewogICAgImJhcmUiOiAiPj0xLjEwLjAiCiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYWRkb24tcmVzb2x2ZSI6ICJeMS4zLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYnVuZGxlIjogIl4xLjguMSIsCiAgICAiYmFyZS1idW5kbGUtZXZhbHVhdGUiOiAiXjEuMS4wIiwKICAgICJiYXJlLWZzIjogIl40LjAuMCIsCiAgICAiYmFyZS1wYXRoIjogIl4zLjAuMCIsCiAgICAiYmFyZS11cmwiOiAiXjIuMS4wIiwKICAgICJicml0dGxlIjogIl4zLjcuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIKICB9Cn0KbGV0IHRtcFJlc29sdmUgPSBudWxsCmxldCB0bXBSZWplY3QgPSBudWxsCgppZiAoUHJvbWlzZS53aXRoUmVzb2x2ZXJzKSB7CiAgbW9kdWxlLmV4cG9ydHMgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMuYmluZChQcm9taXNlKQp9IGVsc2UgewogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gcmVzb2x2ZVJlamVjdFByb21pc2UgKCkgewogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHNldFRtcCkKICAgIGNvbnN0IHJlc3VsdCA9IHsgcHJvbWlzZSwgcmVzb2x2ZTogdG1wUmVzb2x2ZSwgcmVqZWN0OiB0bXBSZWplY3QgfQogICAgdG1wUmVzb2x2ZSA9IHRtcFJlamVjdCA9IG51bGwKICAgIHJldHVybiByZXN1bHQKICB9Cn0KCmZ1bmN0aW9uIHNldFRtcCAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgdG1wUmVzb2x2ZSA9IHJlc29sdmUKICB0bXBSZWplY3QgPSByZWplY3QKfQp7CiAgIm5hbWUiOiAicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSIsCiAgInZlcnNpb24iOiAiMS4xLjAiLAogICJkZXNjcmlwdGlvbiI6ICJDcmVhdGUgYW4gaW52ZXJ0ZWQgcHJvbWlzZSB3aXRoIG5vIGZ1bmN0aW9uIGFsbG9jcyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xNy4xLjIiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9yZXNvbHZlLXJlamVjdC1wcm9taXNlIgp9CmNvbnN0IHJlc291cmNlcyA9IG5ldyBNYXAoKQoKZXhwb3J0cy5hZGQgPSBmdW5jdGlvbihyZXNvdXJjZSwgdGVhcmRvd24pIHsKICByZXNvdXJjZXMuc2V0KHJlc291cmNlLCB0ZWFyZG93bikKfQoKZXhwb3J0cy5yZW1vdmUgPSBmdW5jdGlvbihyZXNvdXJjZSkgewogIHJlc291cmNlcy5kZWxldGUocmVzb3VyY2UpCn0KCmlmIChnbG9iYWwuQmFyZSkgZ2xvYmFsLkJhcmUub24oJ2V4aXQnLCBydW4pCmVsc2UgZ2xvYmFsLnByb2Nlc3Mub24oJ2V4aXQnLCBydW4pCgpmdW5jdGlvbiBydW4oKSB7CiAgZm9yIChjb25zdCBbcmVzb3VyY2UsIHRlYXJkb3duXSBvZiByZXNvdXJjZXMpIHsKICAgIHRlYXJkb3duKHJlc291cmNlKQogIH0KfQp7CiAgIm5hbWUiOiAicmVzb3VyY2Utb24tZXhpdCIsCiAgInZlcnNpb24iOiAiMS4wLjAiLAogICJkZXNjcmlwdGlvbiI6ICJSZWdpc3RlciBzeW5jIHRlYXJkb3duIGhhbmRsZXJzIGZvciBhIHJlc291cmNlIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7fSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXRlYXJkb3duLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYy4iLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS10ZWFyZG93bi9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtdGVhcmRvd24iCn0KcmVxdWlyZS5hZGRvbiA9IHJlcXVpcmUoJ3JlcXVpcmUtYWRkb24nKQoKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCcuJywgX19maWxlbmFtZSkKY29uc3QgQ29sdW1uRmFtaWx5ID0gcmVxdWlyZSgnLi9saWIvY29sdW1uLWZhbWlseScpCmNvbnN0IEl0ZXJhdG9yID0gcmVxdWlyZSgnLi9saWIvaXRlcmF0b3InKQpjb25zdCBTbmFwc2hvdCA9IHJlcXVpcmUoJy4vbGliL3NuYXBzaG90JykKY29uc3QgU3RhdGUgPSByZXF1aXJlKCcuL2xpYi9zdGF0ZScpCmNvbnN0IHsgQmxvb21GaWx0ZXJQb2xpY3ksIFJpYmJvbkZpbHRlclBvbGljeSB9ID0gcmVxdWlyZSgnLi9saWIvZmlsdGVyLXBvbGljeScpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vbGliL2NvbnN0YW50cycpCgpjbGFzcyBSb2Nrc0RCIHsKICBjb25zdHJ1Y3RvcihwYXRoLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsKICAgICAgY29sdW1uRmFtaWx5LAogICAgICBzdGF0ZSA9IG5ldyBTdGF0ZSh0aGlzLCBwYXRoLCBvcHRzKSwKICAgICAgc25hcHNob3QgPSBudWxsLAogICAgICBrZXlFbmNvZGluZyA9IG51bGwsCiAgICAgIHZhbHVlRW5jb2RpbmcgPSBudWxsCiAgICB9ID0gb3B0cwoKICAgIHRoaXMuX3N0YXRlID0gc3RhdGUKICAgIHRoaXMuX3NuYXBzaG90ID0gc25hcHNob3QKICAgIHRoaXMuX2NvbHVtbkZhbWlseSA9IHN0YXRlLmdldENvbHVtbkZhbWlseShjb2x1bW5GYW1pbHkpCiAgICB0aGlzLl9rZXlFbmNvZGluZyA9IGtleUVuY29kaW5nCiAgICB0aGlzLl92YWx1ZUVuY29kaW5nID0gdmFsdWVFbmNvZGluZwogICAgdGhpcy5faW5kZXggPSAtMQoKICAgIHRoaXMuX3N0YXRlLmFkZFNlc3Npb24odGhpcykKICB9CgogIGdldCBvcGVuZWQoKSB7CiAgICByZXR1cm4gdGhpcy5fc3RhdGUub3BlbmVkCiAgfQoKICBnZXQgY2xvc2VkKCkgewogICAgcmV0dXJuIHRoaXMuaXNSb290KCkgPyB0aGlzLl9zdGF0ZS5jbG9zZWQgOiB0aGlzLl9pbmRleCA9PT0gLTEKICB9CgogIGdldCBwYXRoKCkgewogICAgcmV0dXJuIHRoaXMuX3N0YXRlLnBhdGgKICB9CgogIGdldCBzbmFwc2hvdHRlZCgpIHsKICAgIHJldHVybiB0aGlzLl9zbmFwc2hvdCAhPT0gbnVsbAogIH0KCiAgZ2V0IGRlZmF1bHRDb2x1bW5GYW1pbHkoKSB7CiAgICByZXR1cm4gdGhpcy5fY29sdW1uRmFtaWx5CiAgfQoKICBzZXNzaW9uKHsKICAgIGNvbHVtbkZhbWlseSA9IHRoaXMuX2NvbHVtbkZhbWlseSwKICAgIHNuYXBzaG90ID0gdGhpcy5fc25hcHNob3QgIT09IG51bGwsCiAgICBrZXlFbmNvZGluZyA9IHRoaXMuX2tleUVuY29kaW5nLAogICAgdmFsdWVFbmNvZGluZyA9IHRoaXMuX3ZhbHVlRW5jb2RpbmcKICB9ID0ge30pIHsKICAgIG1heWJlQ2xvc2VkKHRoaXMpCgogICAgcmV0dXJuIG5ldyBSb2Nrc0RCKG51bGwsIHsKICAgICAgc3RhdGU6IHRoaXMuX3N0YXRlLAogICAgICBjb2x1bW5GYW1pbHksCiAgICAgIHNuYXBzaG90OiBzbmFwc2hvdCA/IHRoaXMuX3NuYXBzaG90IHx8IG5ldyBTbmFwc2hvdCh0aGlzLl9zdGF0ZSkgOiBudWxsLAogICAgICBrZXlFbmNvZGluZywKICAgICAgdmFsdWVFbmNvZGluZwogICAgfSkKICB9CgogIGNvbHVtbkZhbWlseShuYW1lLCBvcHRzKSB7CiAgICByZXR1cm4gdGhpcy5zZXNzaW9uKHsgLi4ub3B0cywgY29sdW1uRmFtaWx5OiBuYW1lIH0pCiAgfQoKICBzbmFwc2hvdCgpIHsKICAgIHJldHVybiB0aGlzLnNlc3Npb24oeyBzbmFwc2hvdDogdHJ1ZSB9KQogIH0KCiAgaXNSb290KCkgewogICAgcmV0dXJuIHRoaXMgPT09IHRoaXMuX3N0YXRlLmRiCiAgfQoKICByZWFkeSgpIHsKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5yZWFkeSgpCiAgfQoKICBhc3luYyBjbG9zZSh7IGZvcmNlIH0gPSB7fSkgewogICAgaWYgKCF0aGlzLl9zdGF0ZS5vcGVuZWQpIGF3YWl0IHRoaXMuX3N0YXRlLnJlYWR5KCkKCiAgICBpZiAodGhpcy5faW5kZXggIT09IC0xKSB0aGlzLl9zdGF0ZS5yZW1vdmVTZXNzaW9uKHRoaXMpCgogICAgaWYgKGZvcmNlKSB7CiAgICAgIHdoaWxlICh0aGlzLl9zdGF0ZS5zZXNzaW9ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fc3RhdGUuc2Vzc2lvbnNbdGhpcy5fc3RhdGUuc2Vzc2lvbnMubGVuZ3RoIC0gMV0uY2xvc2UoKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXMuaXNSb290KCkgPyB0aGlzLl9zdGF0ZS5jbG9zZSgpIDogUHJvbWlzZS5yZXNvbHZlKCkKICB9CgogIHN1c3BlbmQoKSB7CiAgICBtYXliZUNsb3NlZCh0aGlzKQoKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5zdXNwZW5kKCkKICB9CgogIHJlc3VtZSgpIHsKICAgIG1heWJlQ2xvc2VkKHRoaXMpCgogICAgcmV0dXJuIHRoaXMuX3N0YXRlLnJlc3VtZSgpCiAgfQoKICBpc0lkbGUoKSB7CiAgICByZXR1cm4gdGhpcy5fc3RhdGUuaGFuZGxlcy5pc0lkbGUoKQogIH0KCiAgaWRsZSgpIHsKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5oYW5kbGVzLmlkbGUoKQogIH0KCiAgaXRlcmF0b3IocmFuZ2UsIG9wdHMpIHsKICAgIG1heWJlQ2xvc2VkKHRoaXMpCgogICAgcmV0dXJuIG5ldyBJdGVyYXRvcih0aGlzLCB7IC4uLnJhbmdlLCAuLi5vcHRzIH0pCiAgfQoKICBhc3luYyAqa2V5cyhyYW5nZSwgb3B0cykgewogICAgZm9yIGF3YWl0IChjb25zdCB7IGtleSB9IG9mIHRoaXMuaXRlcmF0b3IocmFuZ2UsIHsKICAgICAgLi4ub3B0cywKICAgICAgdmFsdWVzOiBmYWxzZQogICAgfSkpIHsKICAgICAgeWllbGQga2V5CiAgICB9CiAgfQoKICBh","c3luYyBwZWVrKHJhbmdlLCBvcHRzKSB7CiAgICBmb3IgYXdhaXQgKGNvbnN0IHZhbHVlIG9mIHRoaXMuaXRlcmF0b3IoeyAuLi5yYW5nZSwgLi4ub3B0cywgbGltaXQ6IDEgfSkpIHsKICAgICAgcmV0dXJuIHZhbHVlCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIHJlYWQob3B0cykgewogICAgbWF5YmVDbG9zZWQodGhpcykKCiAgICByZXR1cm4gdGhpcy5fc3RhdGUuY3JlYXRlUmVhZEJhdGNoKHRoaXMsIG9wdHMpCiAgfQoKICB3cml0ZShvcHRzKSB7CiAgICBtYXliZUNsb3NlZCh0aGlzKQoKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5jcmVhdGVXcml0ZUJhdGNoKHRoaXMsIG9wdHMpCiAgfQoKICBmbHVzaChvcHRzKSB7CiAgICBtYXliZUNsb3NlZCh0aGlzKQoKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5mbHVzaCh0aGlzLCBvcHRzKQogIH0KCiAgYXN5bmMgZ2V0KGtleSwgb3B0cykgewogICAgY29uc3QgYmF0Y2ggPSB0aGlzLnJlYWQoeyAuLi5vcHRzLCBjYXBhY2l0eTogMSwgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKICAgIGNvbnN0IHZhbHVlID0gYmF0Y2guZ2V0KGtleSkKICAgIGJhdGNoLnRyeUZsdXNoKCkKICAgIHJldHVybiB2YWx1ZQogIH0KCiAgYXN5bmMgcHV0KGtleSwgdmFsdWUsIG9wdHMpIHsKICAgIGNvbnN0IGJhdGNoID0gdGhpcy53cml0ZSh7IC4uLm9wdHMsIGNhcGFjaXR5OiAxLCBhdXRvRGVzdHJveTogdHJ1ZSB9KQogICAgYmF0Y2gudHJ5UHV0KGtleSwgdmFsdWUpCiAgICBhd2FpdCBiYXRjaC5mbHVzaCgpCiAgfQoKICBhc3luYyBkZWxldGUoa2V5LCBvcHRzKSB7CiAgICBjb25zdCBiYXRjaCA9IHRoaXMud3JpdGUoeyAuLi5vcHRzLCBjYXBhY2l0eTogMSwgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKICAgIGJhdGNoLnRyeURlbGV0ZShrZXkpCiAgICBhd2FpdCBiYXRjaC5mbHVzaCgpCiAgfQoKICBhc3luYyBkZWxldGVSYW5nZShzdGFydCwgZW5kLCBvcHRzKSB7CiAgICBjb25zdCBiYXRjaCA9IHRoaXMud3JpdGUoeyAuLi5vcHRzLCBjYXBhY2l0eTogMSwgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKICAgIGJhdGNoLnRyeURlbGV0ZVJhbmdlKHN0YXJ0LCBlbmQpCiAgICBhd2FpdCBiYXRjaC5mbHVzaCgpCiAgfQoKICBhc3luYyBjb21wYWN0UmFuZ2Uoc3RhcnQgPSBudWxsLCBlbmQgPSBudWxsLCBvcHRzID0ge30pIHsKICAgIGlmICh0eXBlb2YgZW5kID09PSAnb2JqZWN0JyAmJiBlbmQgIT09IG51bGwpIHsKICAgICAgb3B0cyA9IGVuZAogICAgICBlbmQgPSBudWxsCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdGFydCA9PT0gJ29iamVjdCcgJiYgc3RhcnQgIT09IG51bGwpIHsKICAgICAgb3B0cyA9IHN0YXJ0CiAgICAgIHN0YXJ0ID0gbnVsbAogICAgICBlbmQgPSBudWxsCiAgICB9CgogICAgYXdhaXQgdGhpcy5fc3RhdGUuY29tcGFjdFJhbmdlKHRoaXMsIHN0YXJ0LCBlbmQsIG9wdHMpCiAgfQoKICBhc3luYyBhcHByb3hpbWF0ZVNpemUoc3RhcnQsIGVuZCwgb3B0cyA9IHt9KSB7CiAgICByZXR1cm4gdGhpcy5fc3RhdGUuYXBwcm94aW1hdGVTaXplKHRoaXMsIHN0YXJ0LCBlbmQsIG9wdHMpCiAgfQoKICBfcmVmKCkgewogICAgaWYgKHRoaXMuX3NuYXBzaG90KSB0aGlzLl9zbmFwc2hvdC5yZWYoKQogICAgdGhpcy5fc3RhdGUuaGFuZGxlcy5pbmMoKQogIH0KCiAgX3VucmVmKCkgewogICAgaWYgKHRoaXMuX3NuYXBzaG90KSB0aGlzLl9zbmFwc2hvdC51bnJlZigpCiAgICB0aGlzLl9zdGF0ZS5oYW5kbGVzLmRlYygpCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBSb2Nrc0RCCgpleHBvcnRzLmNvbnN0YW50cyA9IGNvbnN0YW50cwoKZXhwb3J0cy5Db2x1bW5GYW1pbHkgPSBDb2x1bW5GYW1pbHkKZXhwb3J0cy5CbG9vbUZpbHRlclBvbGljeSA9IEJsb29tRmlsdGVyUG9saWN5CmV4cG9ydHMuUmliYm9uRmlsdGVyUG9saWN5ID0gUmliYm9uRmlsdGVyUG9saWN5CgpmdW5jdGlvbiBtYXliZUNsb3NlZChkYikgewogIGlmIChkYi5fc3RhdGUuY2xvc2luZyB8fCBkYi5faW5kZXggPT09IC0xKSB0aHJvdyBuZXcgRXJyb3IoJ1JvY2tzREIgc2Vzc2lvbiBpcyBjbG9zZWQnKQp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQoKY29uc3QgZW1wdHkgPSBCdWZmZXIuYWxsb2MoMCkKY29uc3QgcmVzb2x2ZWQgPSBQcm9taXNlLnJlc29sdmUoKQoKY2xhc3MgUm9ja3NEQkJhdGNoIHsKICBjb25zdHJ1Y3RvcihkYiwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IGNhcGFjaXR5ID0gOCwgYXV0b0Rlc3Ryb3kgPSBmYWxzZSB9ID0gb3B0cwoKICAgIGRiLl9yZWYoKQoKICAgIHRoaXMuX2RiID0gZGIKICAgIHRoaXMuX2Rlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLl9jYXBhY2l0eSA9IGNhcGFjaXR5CiAgICB0aGlzLl9vcGVyYXRpb25zID0gW10KICAgIHRoaXMuX3Byb21pc2VzID0gW10KCiAgICB0aGlzLl9lbnF1ZXVlUHJvbWlzZSA9IHRoaXMuX2VucXVldWVQcm9taXNlLmJpbmQodGhpcykKCiAgICB0aGlzLl9yZXF1ZXN0ID0gbnVsbAogICAgdGhpcy5fcmVzb2x2ZSA9IG51bGwKICAgIHRoaXMuX3JlamVjdCA9IG51bGwKCiAgICB0aGlzLl9oYW5kbGUgPSBudWxsCiAgICB0aGlzLl9idWZmZXIgPSBudWxsCiAgICB0aGlzLl9hdXRvRGVzdHJveSA9IGF1dG9EZXN0cm95CgogICAgaWYgKGRiLl9zdGF0ZS5vcGVuZWQgPT09IHRydWUpIHRoaXMucmVhZHkoKQogIH0KCiAgX3JldXNlKGRiLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgYXV0b0Rlc3Ryb3kgPSBmYWxzZSB9ID0gb3B0cwoKICAgIGRiLl9yZWYoKQoKICAgIHRoaXMuX2RiID0gZGIKICAgIHRoaXMuX2Rlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLl9hdXRvRGVzdHJveSA9IGF1dG9EZXN0cm95CiAgfQoKICBfb25maW5pc2hlZChlcnIpIHsKICAgIGNvbnN0IHJlc29sdmUgPSB0aGlzLl9yZXNvbHZlCiAgICBjb25zdCByZWplY3QgPSB0aGlzLl9yZWplY3QKCiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCgogICAgdGhpcy5fb3BlcmF0aW9ucyA9IFtdCiAgICB0aGlzLl9wcm9taXNlcyA9IFtdCiAgICB0aGlzLl9yZXF1ZXN0ID0gbnVsbAogICAgdGhpcy5fcmVzb2x2ZSA9IG51bGwKICAgIHRoaXMuX3JlamVjdCA9IG51bGwKCiAgICBpZiAodGhpcy5fYXV0b0Rlc3Ryb3kgPT09IHRydWUpIHRoaXMuZGVzdHJveSgpCgogICAgaWYgKHJlamVjdCAhPT0gbnVsbCAmJiBlcnIpIHJlamVjdChlcnIpCiAgICBlbHNlIGlmIChyZXNvbHZlICE9PSBudWxsKSByZXNvbHZlKCkKICB9CgogIF9yZXNpemUoKSB7CiAgICBpZiAodGhpcy5fb3BlcmF0aW9ucy5sZW5ndGggPD0gdGhpcy5fY2FwYWNpdHkpIHJldHVybiBmYWxzZQoKICAgIHdoaWxlICh0aGlzLl9vcGVyYXRpb25zLmxlbmd0aCA+IHRoaXMuX2NhcGFjaXR5KSB7CiAgICAgIHRoaXMuX2NhcGFjaXR5ICo9IDIKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgcmVhZHkoKSB7CiAgICBpZiAodGhpcy5faGFuZGxlICE9PSBudWxsKSByZXR1cm4KCiAgICBpZiAodGhpcy5fZGIuX3N0YXRlLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMuX2RiLl9zdGF0ZS5yZWFkeSgpCgogICAgdGhpcy5faW5pdCgpCiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBpbiBwcm9ncmVzcycpCiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSByZXR1cm4KCiAgICB0aGlzLl9kZXN0cm95ZWQgPSB0cnVlCgogICAgaWYgKHRoaXMuX3Byb21pc2VzLmxlbmd0aCkgdGhpcy5fYWJvcnQoKQoKICAgIHRoaXMuX2RiLl91bnJlZigpCiAgICB0aGlzLl9vbmZyZWUoKQogIH0KCiAgX29uZnJlZSgpIHsKICAgIHRoaXMuX2RiLl9zdGF0ZS5mcmVlQmF0Y2godGhpcywgZmFsc2UpCiAgICB0aGlzLl9kYiA9IG51bGwKICB9CgogIF9hYm9ydCgpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fcHJvbWlzZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcHJvbWlzZSA9IHRoaXMuX3Byb21pc2VzW2ldCiAgICAgIGlmIChwcm9taXNlICE9PSBudWxsKSBwcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ0JhdGNoIGlzIGRlc3Ryb3llZCcpKQogICAgfQoKICAgIHRoaXMuX29uZmluaXNoZWQobmV3IEVycm9yKCdCYXRjaCBpcyBkZXN0cm95ZWQnKSkKICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBpbiBwcm9ncmVzcycpCiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSB0aHJvdyBuZXcgRXJyb3IoJ0JhdGNoIGlzIGRlc3Ryb3llZCcpCgogICAgdGhpcy5fcmVxdWVzdCA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgdGhpcy5fcmVzb2x2ZSA9IHJlc29sdmUKICAgICAgdGhpcy5fcmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIHRoaXMuX2ZsdXNoKCkKCiAgICByZXR1cm4gdGhpcy5fcmVxdWVzdAogIH0KCiAgdHJ5Rmx1c2goKSB7CiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGluIHByb2dyZXNzJykKICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcignQmF0Y2ggaXMgZGVzdHJveWVkJykKCiAgICB0aGlzLl9yZXF1ZXN0ID0gcmVzb2x2ZWQKCiAgICB0aGlzLl9mbHVzaCgpCiAgfQoKICBhc3luYyBfZmx1c2goKSB7CiAgICBpZiAodGhpcy5faGFuZGxlID09PSBudWxsKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICB0aGlzLl9kYi5fc3RhdGUuaW8uaW5jKCkKCiAgICBpZiAodGhpcy5fZGIuX3N0YXRlLnJlc3VtZWQgIT09IG51bGwpIHsKICAgICAgY29uc3QgcmVzdW1lZCA9IGF3YWl0IHRoaXMuX2RiLl9zdGF0ZS5yZXN1bWVkLnByb21pc2UKCiAgICAgIGlmICghcmVzdW1lZCkgewogICAgICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHsKICAgICAgICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl9kZXN0cm95ZWQgPSB0cnVlCiAgICAgICAgICB0aGlzLl9hYm9ydCgpCiAgICAgICAgICB0aGlzLl9kYi5fdW5yZWYoKQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgX2VucXVldWVQcm9taXNlKHJlc29sdmUsIHJlamVjdCkgewogICAgdGhpcy5fcHJvbWlzZXMucHVzaCh7IHJlc29sdmUsIHJlamVjdCB9KQogIH0KCiAgX2VuY29kZUtleShrKSB7CiAgICBpZiAodGhpcy5fZGIuX2tleUVuY29kaW5nKSByZXR1cm4gYy5lbmNvZGUodGhpcy5fZGIuX2tleUVuY29kaW5nLCBrKQogICAgaWYgKHR5cGVvZiBrID09PSAnc3RyaW5nJykgcmV0dXJuIEJ1ZmZlci5mcm9tKGspCiAgICByZXR1cm4gawogIH0KCiAgX2VuY29kZVZhbHVlKHYpIHsKICAgIGlmICh0aGlzLl9kYi5fdmFsdWVFbmNvZGluZykgcmV0dXJuIGMuZW5jb2RlKHRoaXMuX2RiLl92YWx1ZUVuY29kaW5nLCB2KQogICAgaWYgKHYgPT09IG51bGwpIHJldHVybiBlbXB0eQogICAgaWYgKHR5cGVvZiB2ID09PSAnc3RyaW5nJykgcmV0dXJuIEJ1ZmZlci5mcm9tKHYpCiAgICByZXR1cm4gdgogIH0KCiAgX2RlY29kZVZhbHVlKGIpIHsKICAgIGlmICh0aGlzLl9kYi5fdmFsdWVFbmNvZGluZykgcmV0dXJuIGMuZGVjb2RlKHRoaXMuX2RiLl92YWx1ZUVuY29kaW5nLCBiKQogICAgcmV0dXJuIGIKICB9Cn0KCmV4cG9ydHMuUmVhZEJhdGNoID0gY2xhc3MgUm9ja3NEQlJlYWRCYXRjaCBleHRlbmRzIFJvY2tzREJCYXRjaCB7CiAgY29uc3RydWN0b3IoZGIsIG9wdHMgPSB7fSkgewogICAgc3VwZXIoZGIsIG9wdHMpCgogICAgY29uc3QgeyBhc3luY0lPID0gZmFsc2UsIGZpbGxDYWNoZSA9IHRydWUgfSA9IG9wdHMKCiAgICB0aGlzLl9hc3luY0lPID0gYXN5bmNJTwogICAgdGhpcy5fZmlsbENhY2hlID0gZmlsbENhY2hlCiAgfQoKICBfaW5pdCgpIHsKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcucmVhZEluaXQoKQogICAgdGhpcy5fYnVmZmVyID0gYmluZGluZy5yZWFkQnVmZmVyKHRoaXMuX2hhbmRsZSwgdGhpcy5fY2FwYWNpdHkpCiAgfQoKICBfcmVzaXplKCkgewogICAgaWYgKHN1cGVyLl9yZXNpemUoKSAmJiB0aGlzLl9oYW5kbGUgIT09IG51bGwpIHsKICAgICAgdGhpcy5fYnVmZmVyID0gYmluZGluZy5yZWFkQnVmZmVyKHRoaXMuX2hhbmRsZSwgdGhpcy5fY2FwYWNpdHkpCiAgICB9CiAgfQoKICBhc3luYyBfZmx1c2goKSB7CiAgICBhd2FpdCBzdXBlci5fZmx1c2goKQoKICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHJldHVybgoKICAgIHRyeSB7CiAgICAgIGJpbmRpbmcucmVhZCgKICAgICAgICB0aGlzLl9kYi5fc3RhdGUuX2hhbmRsZSwKICAgICAgICB0aGlzLl9oYW5kbGUsCiAgICAgICAgdGhpcy5fb3BlcmF0aW9ucywKICAgICAgICB0aGlzLl9kYi5fc25hcHNob3QgPyB0aGlzLl9kYi5fc25hcHNob3QuX2hhbmRsZSA6IHVuZGVmaW5lZCwKICAgICAgICB0aGlzLl9hc3luY0lPLAogICAgICAgIHRoaXMuX2ZpbGxDYWNoZSwKICAgICAgICB0aGlzLAogICAgICAgIHRoaXMuX29ucmVhZAogICAgICApCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCiAgICAgIHRocm93IGVycgogICAgfQogIH0KCiAgX29ucmVhZChlcnJzLCB2YWx1ZXMpIHsKICAgIGxldCBhcHBsaWVkID0gdHJ1ZQoKICAgIGZvciAobGV0IGkgPSAwLCBuID0gdGhpcy5fcHJvbWlzZXMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIGNvbnN0IGVyciA9IGVycnNbaV0KICAgICAgaWYgKGVycikgYXBwbGllZCA9IGZhbHNlCgogICAgICBjb25zdCBwcm9taXNlID0gdGhpcy5fcHJvbWlzZXNbaV0KICAgICAgaWYgKHByb21pc2UgPT09IG51bGwpIGNvbnRpbnVlCgogICAgICBpZiAoZXJyKSBwcm9taXNlLnJlamVjdChuZXcgRXJyb3IoZXJyKSkKICAgICAgZWxzZSBwcm9taXNlLnJlc29sdmUodmFsdWVzW2ldID8gdGhpcy5fZGVjb2RlVmFsdWUoQnVmZmVyLmZyb20odmFsdWVzW2ldKSkgOiBudWxsKQogICAgfQoKICAgIHRoaXMuX29uZmluaXNoZWQoYXBwbGllZCA/IG51bGwgOiBuZXcgRXJyb3IoJ0JhdGNoIHdhcyBub3QgYXBwbGllZCcpKQogIH0KCiAgZ2V0KGtleSkgewogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBhbHJlYWR5IGluIHByb2dyZXNzJykKCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UodGhpcy5fZW5xdWV1ZVByb21pc2UpCgogICAgdGhpcy5fb3BlcmF0aW9ucy5wdXNoKG5ldyBSb2Nrc0RCR2V0KHRoaXMuX2VuY29kZUtleShrZXkpLCB0aGlzLl9kYi5fY29sdW1uRmFtaWx5KSkKCiAgICB0aGlzLl9yZXNpemUoKQoKICAgIHJldHVybiBwcm9taXNlCiAgfQp9CgpleHBvcnRzLldyaXRlQmF0Y2ggPSBjbGFzcyBSb2Nrc0RCV3JpdGVCYXRjaCBleHRlbmRzIFJvY2tzREJCYXRjaCB7CiAgX2luaXQoKSB7CiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLndyaXRlSW5pdCgpCiAgICB0aGlzLl9idWZmZXIgPSBiaW5kaW5nLndyaXRlQnVmZmVyKHRoaXMuX2hhbmRsZSwgdGhpcy5fY2FwYWNpdHkpCiAgfQoKICBfcmVzaXplKCkgewogICAgaWYgKHN1cGVyLl9yZXNpemUoKSAmJiB0aGlzLl9oYW5kbGUgIT09IG51bGwpIHsKICAgICAgdGhpcy5fYnVmZmVyID0gYmluZGluZy53cml0ZUJ1ZmZlcih0aGlzLl9oYW5kbGUsIHRoaXMuX2NhcGFjaXR5KQogICAgfQogIH0KCiAgX29uZnJlZSgpIHsKICAgIHRoaXMuX2RiLl9zdGF0ZS5mcmVlQmF0Y2godGhpcywgdHJ1ZSkKICB9CgogIGFzeW5jIF9mbHVzaCgpIHsKICAgIGF3YWl0IHN1cGVyLl9mbHVzaCgpCgogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgcmV0dXJuCgogICAgdHJ5IHsKICAgICAgYmluZGluZy53cml0ZSh0aGlzLl9kYi5fc3RhdGUuX2hhbmRsZSwgdGhpcy5faGFuZGxlLCB0aGlzLl9vcGVyYXRpb25zLCB0aGlzLCB0aGlzLl9vbndyaXRlKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIF9vbndyaXRlKGVycikgewogICAgY29uc3QgYXBwbGllZCA9ICFlcnIKCiAgICBmb3IgKGxldCBpID0gMCwgbiA9IHRoaXMuX3Byb21pc2VzLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCBwcm9taXNlID0gdGhpcy5fcHJvbWlzZXNbaV0KICAgICAgaWYgKHByb21pc2UgPT09IG51bGwpIGNvbnRpbnVlCgogICAgICBpZiAoZXJyKSBwcm9taXNlLnJlamVjdChuZXcgRXJyb3IoZXJyKSkKICAgICAgZWxzZSBwcm9taXNlLnJlc29sdmUoKQogICAgfQoKICAgIHRoaXMuX29uZmluaXNoZWQoYXBwbGllZCA/IG51bGwgOiBuZXcgRXJyb3IoJ0JhdGNoIHdhcyBub3QgYXBwbGllZCcpKQogIH0KCiAgcHV0KGtleSwgdmFsdWUpIHsKICAgIGlmICh0aGlzLl9yZXF1ZXN0KSB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWxyZWFkeSBpbiBwcm9ncmVzcycpCgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHRoaXMuX2VucXVldWVQcm9taXNlKQoKICAgIHRoaXMuX29wZXJhdGlvbnMucHVzaCgKICAgICAgbmV3IFJvY2tzREJQdXQodGhpcy5fZW5jb2RlS2V5KGtleSksIHRoaXMuX2VuY29kZVZhbHVlKHZhbHVlKSwgdGhpcy5fZGIuX2NvbHVtbkZhbWlseSkKICAgICkKCiAgICB0aGlzLl9yZXNpemUoKQoKICAgIHJldHVybiBwcm9taXNlCiAgfQoKICB0cnlQdXQoa2V5LCB2YWx1ZSkgewogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBhbHJlYWR5IGluIHByb2dyZXNzJykKCiAgICB0aGlzLl9vcGVyYXRpb25zLnB1c2goCiAgICAgIG5ldyBSb2Nrc0RCUHV0KHRoaXMuX2VuY29kZUtleShrZXkpLCB0aGlzLl9lbmNvZGVWYWx1ZSh2YWx1ZSksIHRoaXMuX2RiLl9jb2x1bW5GYW1pbHkpCiAgICApCgogICAgdGhpcy5fcHJvbWlzZXMucHVzaChudWxsKQoKICAgIHRoaXMuX3Jlc2l6ZSgpCiAgfQoKICBkZWxldGUoa2V5KSB7CiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGFscmVhZHkgaW4gcHJvZ3Jlc3MnKQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSh0aGlzLl9lbnF1ZXVlUHJvbWlzZSkKCiAgICB0aGlzLl9vcGVyYXRpb25zLnB1c2gobmV3IFJvY2tzREJEZWxldGUodGhpcy5fZW5jb2RlS2V5KGtleSksIHRoaXMuX2RiLl9jb2x1bW5GYW1pbHkpKQoKICAgIHRoaXMuX3Jlc2l6ZSgpCgogICAgcmV0dXJuIHByb21pc2UKICB9CgogIHRyeURlbGV0ZShrZXkpIHsKICAgIGlmICh0aGlzLl9yZXF1ZXN0KSB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWxyZWFkeSBpbiBwcm9ncmVzcycpCgogICAgdGhpcy5fb3BlcmF0aW9ucy5wdXNoKG5ldyBSb2Nrc0RCRGVsZXRlKHRoaXMuX2VuY29kZUtleShrZXkpLCB0aGlzLl9kYi5fY29sdW1uRmFtaWx5KSkKCiAgICB0aGlzLl9wcm9taXNlcy5wdXNoKG51bGwpCgogICAgdGhpcy5fcmVzaXplKCkKICB9CgogIGRlbGV0ZVJhbmdlKHN0YXJ0LCBlbmQpIHsKICAgIGlmICh0aGlzLl9yZXF1ZXN0KSB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWxyZWFkeSBpbiBwcm9ncmVzcycpCgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHRoaXMuX2VucXVldWVQcm9taXNlKQoKICAgIHRoaXMuX29wZXJhdGlvbnMucHVzaCgKICAgICAgbmV3IFJvY2tzREJEZWxldGVSYW5nZSh0aGlzLl9lbmNvZGVLZXkoc3RhcnQpLCB0aGlzLl9lbmNvZGVLZXkoZW5kKSwgdGhpcy5fZGIuX2NvbHVtbkZhbWlseSkKICAgICkKCiAgICB0aGlzLl9yZXNpemUoKQoKICAgIHJldHVybiBwcm9taXNlCiAgfQoKICB0cnlEZWxldGVSYW5nZShzdGFydCwgZW5kKSB7CiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGFscmVhZHkgaW4gcHJvZ3Jlc3MnKQoKICAgIHRoaXMuX29wZXJhdGlvbnMucHVzaCgKICAgICAgbmV3IFJvY2tzREJEZWxldGVSYW5nZSh0aGlzLl9lbmNvZGVLZXkoc3RhcnQpLCB0aGlzLl9lbmNvZGVLZXkoZW5kKSwgdGhpcy5fZGIuX2NvbHVtbkZhbWlseSkKICAgICkKCiAgICB0aGlzLl9wcm9taXNlcy5wdXNoKG51bGwpCgogICAgdGhpcy5fcmVzaXplKCkKICB9Cn0KCmNsYXNzIFJvY2tzREJHZXQgewogIGNvbnN0cnVjdG9yKGtleSwgY29sdW1uRmFtaWx5KSB7CiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy5jb2x1bW5GYW1pbHkgPSBjb2x1bW5GYW1pbHkuX2hhbmRsZQogIH0KCiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gYmluZGluZy5HRVQKICB9Cn0KCmNsYXNzIFJvY2tzREJQdXQgewogIGNvbnN0cnVjdG9yKGtleSwgdmFsdWUsIGNvbHVtbkZhbWlseSkgewogICAgdGhpcy5rZXkgPSBrZXkKICAgIHRoaXMudmFsdWUgPSB2YWx1ZQogICAgdGhpcy5jb2x1bW5GYW1pbHkgPSBjb2x1bW5GYW1pbHkuX2hhbmRsZQogIH0KCiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gYmluZGluZy5QVVQKICB9Cn0KCmNsYXNzIFJvY2tzREJEZWxldGUgewogIGNvbnN0cnVjdG9yKGtleSwgY29sdW1uRmFtaWx5KSB7CiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy5jb2x1bW5GYW1pbHkgPSBjb2x1bW5GYW1pbHkuX2hhbmRsZQogIH0KCiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gYmluZGluZy5ERUxFVEUKICB9Cn0KCmNsYXNzIFJvY2tzREJEZWxldGVSYW5nZSB7CiAgY29uc3RydWN0b3Ioc3RhcnQsIGVuZCwgY29sdW1uRmFtaWx5KSB7CiAgICB0aGlzLnN0YXJ0ID0gc3RhcnQKICAgIHRoaXMuZW5kID0gZW5kCiAgICB0aGlzLmNvbHVtbkZhbWlseSA9IGNvbHVtbkZhbWlseS5faGFuZGxlCiAgfQoKICBnZXQgdHlwZSgpIHsKICAgIHJldHVybiBiaW5kaW5nLkRFTEVURV9SQU5HRQogIH0KfQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKY29uc3QgeyBCbG9vbUZpbHRlclBvbGljeSB9ID0gcmVxdWlyZSgnLi9maWx0ZXItcG9saWN5JykKCmNsYXNzIFJvY2tzREJDb2x1bW5GYW1pbHkgewogIGNvbnN0cnVjdG9yKG5hbWUsIG9wdHMgPSB7fSkgewogICAgY29uc3QgewogICAgICAvLyBCbG9iIG9wdGlvbnMKICAgICAgZW5hYmxlQmxvYkZpbGVzID0gZmFsc2UsCiAgICAgIG1pbkJsb2JTaXplID0gMCwKICAgICAgYmxvYkZpbGVTaXplID0gMCwKICAgICAgZW5hYmxlQmxvYkdhcmJhZ2VDb2xsZWN0aW9uID0gdHJ1ZSwKICAgICAgLy8gQmxvY2sgdGFibGUgb3B0aW9ucwogICAgICB0YWJsZUJsb2NrU2l6ZSA9IDgxOTIsCiAgICAgIHRhYmxlQ2FjaGVJbmRleEFuZEZpbHRlckJsb2NrcyA9IHRydWUsCiAgICAgIHRhYmxlRm9ybWF0VmVyc2lvbiA9IDYsCiAgICAgIG9wdGltaXplRmlsdGVyc0Zvck1lbW9yeSA9IGZhbHNlLAogICAgICBibG9ja0NhY2hlID0gdHJ1ZSwKICAgICAgZmlsdGVyUG9saWN5ID0gbmV3IEJsb29tRmlsdGVyUG9saWN5KDEwKSwKICAgICAgdG9wTGV2ZWxJbmRleFBpbm5pbmdUaWVyID0gY29uc3RhbnRzLnBpbm5pbmdUaWVyLkFMTCwKICAgICAgcGFydGl0aW9uUGlubmluZ1RpZXIgPSBjb25zdGFudHMucGlubmluZ1RpZXIuQUxMLAogICAgICB1bnBhcnRpdGlvbmVkUGlubmluZ1RpZXIgPSBjb25zdGFudHMucGlubmluZ1RpZXIuQUxMLAogICAgICBvcHRpbWl6ZUZpbHRlcnNGb3JIaXRzID0gZmFsc2UsCiAgICAgIG51bUxldmVscyA9IDcsCiAgICAgIG1heFdyaXRlQnVmZmVyTnVtYmVyID0gMgogICAgfSA9IG9wdHMKCiAgICB0aGlzLl9uYW1lID0gbmFtZQogICAgdGhpcy5fZmx1c2hpbmcgPSBudWxsCiAgICB0aGlzLl9vcHRpb25zID0gewogICAgICBlbmFibGVCbG9iRmlsZXMsCiAgICAgIG1pbkJsb2JTaXplLAogICAgICBibG9iRmlsZVNpemUsCiAgICAgIGVuYWJsZUJsb2JHYXJiYWdlQ29sbGVjdGlvbiwKICAgICAgdGFibGVCbG9ja1NpemUsCiAgICAgIHRhYmxlQ2FjaGVJbmRleEFuZEZpbHRlckJsb2NrcywKICAgICAgdGFibGVGb3JtYXRWZXJzaW9uLAogICAgICBvcHRpbWl6ZUZpbHRlcnNGb3JNZW1vcnksCiAgICAgIGJsb2NrQ2FjaGUsCiAgICAgIGZpbHRlclBvbGljeSwKICAgICAgdG9wTGV2ZWxJbmRleFBpbm5pbmdUaWVyLAogICAgICBwYXJ0aXRpb25QaW5uaW5nVGllciwKICAgICAgdW5wYXJ0aXRpb25lZFBpbm5pbmdUaWVyLAogICAgICBvcHRpbWl6ZUZpbHRlcnNGb3JIaXRzLAogICAgICBudW1MZXZlbHMsCiAgICAgIG1heFdyaXRlQnVmZmVyTnVtYmVyCiAgICB9CgogICAgY29uc3QgZmlsdGVyUG9saWN5QXJndW1lbnRzID0gWzAsIDAsIDBdCgogICAgaWYgKGZpbHRlclBvbGljeSAhPT0gbnVsbCkgewogICAgICBmaWx0ZXJQb2xpY3lBcmd1bWVudHNbMF0gPSBmaWx0ZXJQb2xpY3kudHlwZQoKICAgICAgc3dpdGNoIChmaWx0ZXJQb2xpY3kudHlwZSkgewogICAgICAgIGNhc2UgMTogLy8gQmxvb20gZmlsdGVyIHBvbGljeQogICAgICAgICAgZmlsdGVyUG9saWN5QXJndW1lbnRzWzFdID0gZmlsdGVyUG9saWN5LmJpdHNQZXJLZXkKICAgICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAyOiAvLyBSaWJib24gZmlsdGVyIHBvbGljeQogICAgICAgICAgZmlsdGVyUG9saWN5QXJndW1lbnRzWzFdID0gZmlsdGVyUG9saWN5LmJsb29tRXF1aXZhbGVudEJpdHNQZXJLZXkKICAgICAgICAgIGZpbHRlclBvbGljeUFyZ3VtZW50c1syXSA9IGZpbHRlclBvbGljeS5ibG9vbUJlZm9yZUxldmVsCgogICAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcuY29sdW1uRmFtaWx5SW5pdCgKICAgICAgbmFtZSwKICAgICAgZW5hYmxlQmxvYkZpbGVzLAogICAgICBtaW5CbG9iU2l6ZSwKICAgICAgYmxvYkZpbGVTaXplLAogICAgICBlbmFibGVCbG9iR2FyYmFnZUNvbGxlY3Rpb24sCiAgICAgIHRhYmxlQmxvY2tTaXplLAogICAgICB0YWJsZUNhY2hlSW5kZXhBbmRGaWx0ZXJCbG9ja3MsCiAgICAgIHRhYmxlRm9ybWF0VmVyc2lvbiwKICAgICAgb3B0aW1pemVGaWx0ZXJzRm9yTWVtb3J5LAogICAgICBibG9ja0NhY2hlID09PSBmYWxzZSwKICAgICAgLi4uZmlsdGVyUG9saWN5QXJndW1lbnRzLAogICAgICB0b3BMZXZlbEluZGV4UGlubmluZ1RpZXIsCiAgICAgIHBhcnRpdGlvblBpbm5pbmdUaWVyLAogICAgICB1bnBhcnRpdGlvbmVkUGlubmluZ1RpZXIsCiAgICAgIG9wdGltaXplRmlsdGVyc0ZvckhpdHMsCiAgICAgIG51bUxldmVscywKICAgICAgbWF4V3JpdGVCdWZmZXJOdW1iZXIKICAgICkKICB9CgogIGNsb25lU2V0dGluZ3MobmFtZSkgewogICAgcmV0dXJuIG5ldyBSb2Nrc0RCQ29sdW1uRmFtaWx5KG5hbWUsIHRoaXMuX29wdGlvbnMpCiAgfQoKICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiB0aGlzLl9uYW1lCiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuX2hhbmRsZSA9PT0gbnVsbCkgcmV0dXJuCgogICAgYmluZGluZy5jb2x1bW5GYW1pbHlEZXN0cm95KHRoaXMuX2hhbmRsZSkKCiAgICB0aGlzLl9oYW5kbGUgPSBudWxsCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IFJvY2tzREJDb2x1bW5GYW1pbHkKbW9kdWxlLmV4cG9ydHMgPSB7CiAgcGlubmluZ1RpZXI6IHsKICAgIE5PTkU6IDAsCiAgICBGTFVTSEVEX0FORF9TSU1JTEFSOiAxLAogICAgQUxMOiAyCiAgfQp9CmV4cG9ydHMuQmxvb21GaWx0ZXJQb2xpY3kgPSBjbGFzcyBSb2Nrc0RCQmxvb21GaWx0ZXJQb2xpY3kgewogIGdldCB0eXBlKCkgewogICAgcmV0dXJuIDEKICB9CgogIGNvbnN0cnVjdG9yKGJpdHNQZXJLZXkpIHsKICAgIHRoaXMuYml0c1BlcktleSA9IGJpdHNQZXJLZXkKICB9Cn0KCmV4cG9ydHMuUmliYm9uRmlsdGVyUG9saWN5ID0gY2xhc3MgUm9ja3NEQlJpYmJvbkZpbHRlclBvbGljeSB7CiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gMgogIH0KCiAgY29uc3RydWN0b3IoYmxvb21FcXVpdmFsZW50Qml0c1BlcktleSwgYmxvb21CZWZvcmVMZXZlbCA9IDApIHsKICAgIHRoaXMuYmxvb21FcXVpdmFsZW50Qml0c1BlcktleSA9IGJsb29tRXF1aXZhbGVudEJpdHNQZXJLZXkKICAgIHRoaXMuYmxvb21CZWZvcmVMZXZlbCA9IGJsb29tQmVmb3JlTGV2ZWwKICB9Cn0KY29uc3QgeyBSZWFkYWJsZSB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQoKY29uc3QgZW1wdHkgPSBCdWZmZXIuYWxsb2MoMCkKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUm9ja3NEQkl0ZXJhdG9yIGV4dGVuZHMgUmVhZGFibGUgewogIGNvbnN0cnVjdG9yKGRiLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsKICAgICAgZ3QgPSBudWxsLAogICAgICBndGUgPSBudWxsLAogICAgICBsdCA9IG51bGwsCiAgICAgIGx0ZSA9IG51bGwsCiAgICAgIHJldmVyc2UgPSBmYWxzZSwKICAgICAgdmFsdWVzID0gdHJ1ZSwKICAgICAgbGltaXQgPSBJbmZpbml0eSwKICAgICAgY2FwYWNpdHkgPSA4CiAgICB9ID0gb3B0cwoKICAgIHN1cGVyKCkKCiAgICBkYi5fcmVmKCkKCiAgICB0aGlzLl9kYiA9IGRiCgogICAgdGhpcy5fZ3QgPSBndCA/IHRoaXMuX2VuY29kZUtleShndCkgOiBlbXB0eQogICAgdGhpcy5fZ3RlID0gZ3RlID8gdGhpcy5fZW5jb2RlS2V5KGd0ZSkgOiBlbXB0eQogICAgdGhpcy5fbHQgPSBsdCA/IHRoaXMuX2VuY29kZUtleShsdCkgOiBlbXB0eQogICAgdGhpcy5fbHRlID0gbHRlID8gdGhpcy5fZW5jb2RlS2V5KGx0ZSkgOiBlbXB0eQoKICAgIHRoaXMuX3JldmVyc2UgPSByZXZlcnNlCiAgICB0aGlzLl92YWx1ZXMgPSB2YWx1ZXMKICAgIHRoaXMuX2xpbWl0ID0gbGltaXQgPCAwID8gSW5maW5pdHkgOiBsaW1pdAogICAgdGhpcy5fY2FwYWNpdHkgPSBjYXBhY2l0eQogICAgdGhpcy5fb3BlbmVkID0gZmFsc2UKCiAgICB0aGlzLl9wZW5kaW5nT3BlbiA9IG51bGwKICAgIHRoaXMuX3BlbmRpbmdSZWFkID0gbnVsbAogICAgdGhpcy5fcGVuZGluZ0Rlc3Ryb3kgPSBudWxsCgogICAgdGhpcy5fYnVmZmVyID0gbnVsbAogICAgdGhpcy5faGFuZGxlID0gbnVsbAoKICAgIGlmICh0aGlzLl9kYi5fc3RhdGUub3BlbmVkID09PSB0cnVlKSB0aGlzLnJlYWR5KCkKICB9CgogIF9vbm9wZW4oZXJyKSB7CiAgICBjb25zdCBjYiA9IHRoaXMuX3BlbmRpbmdPcGVuCiAgICB0aGlzLl9wZW5kaW5nT3BlbiA9IG51bGwKICAgIHRoaXMuX29wZW5lZCA9IHRydWUKICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQogICAgY2IoZXJyKQogIH0KCiAgX29ucmVhZChlcnIsIGtleXMsIHZhbHVlcykgewogICAgY29uc3QgY2IgPSB0aGlzLl9wZW5kaW5nUmVhZAogICAgdGhpcy5fcGVuZGluZ1JlYWQgPSBudWxsCiAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKICAgIGlmIChlcnIpIHJldHVybiBjYihlcnIpCgogICAgY29uc3QgbiA9IGtleXMubGVuZ3RoCgogICAgdGhpcy5fbGltaXQgLT0gbgoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgaSsrKSB7CiAgICAgIHRoaXMucHVzaCh7CiAgICAgICAga2V5OiB0aGlzLl9kZWNvZGVLZXkoQnVmZmVyLmZyb20oa2V5c1tpXSkpLAogICAgICAgIHZhbHVlOiB0aGlzLl92YWx1ZXMgPyB0aGlzLl9kZWNvZGVWYWx1ZShCdWZmZXIuZnJvbSh2YWx1ZXNbaV0pKSA6IG51bGwKICAgICAgfSkKICAgIH0KCiAgICBpZiAobiA8IHRoaXMuX2NhcGFjaXR5KSB0aGlzLnB1c2gobnVsbCkKCiAgICBjYihudWxsKQogIH0KCiAgX29uY2xvc2UoZXJyKSB7CiAgICBjb25zdCBjYiA9IHRoaXMuX3BlbmRpbmdEZXN0cm95CiAgICB0aGlzLl9wZW5kaW5nRGVzdHJveSA9IG51bGwKICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQogICAgdGhpcy5fZGIuX3VucmVmKCkKICAgIGNiKGVycikKICB9CgogIF9yZXNpemUoKSB7CiAgICBpZiAodGhpcy5faGFuZGxlICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX2J1ZmZlciA9IGJpbmRpbmcuaXRlcmF0b3JCdWZmZXIodGhpcy5faGFuZGxlLCB0aGlzLl9jYXBhY2l0eSkKICAgIH0KICB9CgogIGFzeW5jIHJlYWR5KCkgewogICAgaWYgKHRoaXMuX2hhbmRsZSAhPT0gbnVsbCkgcmV0dXJuCgogICAgaWYgKHRoaXMuX2RiLl9zdGF0ZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLl9kYi5fc3RhdGUucmVhZHkoKQoKICAgIHRoaXMuX2luaXQoKQogIH0KCiAgX2luaXQoKSB7CiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLml0ZXJhdG9ySW5pdCgpCiAgICB0aGlzLl9idWZmZXIgPSBiaW5kaW5nLml0ZXJhdG9yQnVmZmVyKHRoaXMuX2hhbmRsZSwgdGhpcy5fY2FwYWNpdHkpCiAgfQoKICBhc3luYyBfb3BlbihjYikgewogICAgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgdGhpcy5fZGIuX3N0YXRlLmlvLmluYygpCgogICAgaWYgKHRoaXMuX2RiLl9zdGF0ZS5yZXN1bWVkICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IHJlc3VtZWQgPSBhd2FpdCB0aGlzLl9kYi5fc3RhdGUucmVzdW1lZC5wcm9taXNlCgogICAgICBpZiAoIXJlc3VtZWQpIHsKICAgICAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKCiAgICAgICAgcmV0dXJuIGNiKG5ldyBFcnJvcignUm9ja3NEQiBzZXNzaW9uIGlzIGNsb3NlZCcpKQogICAgICB9CiAgICB9CgogICAgdGhpcy5fcGVuZGluZ09wZW4gPSBjYgoKICAgIHRyeSB7CiAgICAgIGJpbmRpbmcuaXRlcmF0b3JPcGVuKAogICAgICAgIHRoaXMuX2RiLl9zdGF0ZS5faGFuZGxlLAogICAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgICB0aGlzLl9kYi5fY29sdW1uRmFtaWx5Ll9oYW5kbGUsCiAgICAgICAgdGhpcy5fZ3QsCiAgICAgICAgdGhpcy5fZ3RlLAogICAgICAgIHRoaXMuX2x0LAogICAgICAgIHRoaXMuX2x0ZSwKICAgICAgICB0aGlzLl9yZXZlcnNlLAogICAgICAgICF0aGlzLl92YWx1ZXMsIC8vIEtleXMgb25seQogICAgICAgIHRoaXMuX2RiLl9zbmFwc2hvdCA/IHRoaXMuX2RiLl9zbmFwc2hvdC5faGFuZGxlIDogdW5kZWZpbmVkLAogICAgICAgIHRoaXMsCiAgICAgICAgdGhpcy5fb25vcGVuLAogICAgICAgIHRoaXMuX29uY2xvc2UsCiAgICAgICAgdGhpcy5fb25yZWFkCiAgICAgICkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKCiAgICAgIGNiKGVycikKICAgIH0KICB9CgogIGFzeW5jIF9yZWFkKGNiKSB7CiAgICB0aGlzLl9kYi5fc3RhdGUuaW8uaW5jKCkKCiAgICBpZiAodGhpcy5fZGIuX3N0YXRlLnJlc3VtZWQgIT09IG51bGwpIHsKICAgICAgY29uc3QgcmVzdW1lZCA9IGF3YWl0IHRoaXMuX2RiLl9zdGF0ZS5yZXN1bWVkLnByb21pc2UKCiAgICAgIGlmICghcmVzdW1lZCkgewogICAgICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQoKICAgICAgICByZXR1cm4gY2IobmV3IEVycm9yKCdSb2Nrc0RCIHNlc3Npb24gaXMgY2xvc2VkJykpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9wZW5kaW5nUmVhZCA9IGNiCgogICAgdHJ5IHsKICAgICAgYmluZGluZy5pdGVyYXRvclJlYWQodGhpcy5faGFuZGxlLCBNYXRoLm1pbih0aGlzLl9jYXBhY2l0eSwgdGhpcy5fbGltaXQpKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQoKICAgICAgY2IoZXJyKQogICAgfQogIH0KCiAgYXN5bmMgX2Rlc3Ryb3koY2IpIHsKICAgIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5pbmMoKQoKICAgIGlmICh0aGlzLl9vcGVuZWQgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQogICAgICB0aGlzLl9kYi5fdW5yZWYoKQoKICAgICAgcmV0dXJuIGNiKG51bGwpCiAgICB9CgogICAgdGhpcy5fcGVuZGluZ0Rlc3Ryb3kgPSBjYgoKICAgIHRyeSB7CiAgICAgIGJpbmRpbmcuaXRlcmF0b3JDbG9zZSh0aGlzLl9oYW5kbGUpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCiAgICAgIHRoaXMuX2RiLl91bnJlZigpCgogICAgICBjYihlcnIpCiAgICB9CiAgfQoKICBfZW5jb2RlS2V5KGspIHsKICAgIGlmICh0aGlzLl9kYi5fa2V5RW5jb2RpbmcgIT09IG51bGwpIHJldHVybiBjLmVuY29kZSh0aGlzLl9kYi5fa2V5RW5jb2RpbmcsIGspCiAgICBpZiAodHlwZW9mIGsgPT09ICdzdHJpbmcnKSByZXR1cm4gQnVmZmVyLmZyb20oaykKICAgIHJldHVybiBrCiAgfQoKICBfZGVjb2RlS2V5KGIpIHsKICAgIGlmICh0aGlzLl9kYi5fa2V5RW5jb2RpbmcgIT09IG51bGwpIHJldHVybiBjLmRlY29kZSh0aGlzLl9kYi5fa2V5RW5jb2RpbmcsIGIpCiAgICByZXR1cm4gYgogIH0KCiAgX2RlY29kZVZhbHVlKGIpIHsKICAgIGlmICh0aGlzLl9kYi5fdmFsdWVFbmNvZGluZyAhPT0gbnVsbCkgcmV0dXJuIGMuZGVjb2RlKHRoaXMuX2RiLl92YWx1ZUVuY29kaW5nLCBiKQogICAgcmV0dXJuIGIKICB9Cn0KY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSb2Nrc0RCU25hcHNob3QgewogIGNvbnN0cnVjdG9yKHN0YXRlKSB7CiAgICB0aGlzLl9zdGF0ZSA9IHN0YXRlCgogICAgdGhpcy5faGFuZGxlID0gbnVsbAogICAgdGhpcy5fcmVmcyA9IDAKCiAgICBpZiAoc3RhdGUuZGVmZXJTbmFwc2hvdEluaXQgPT09IGZhbHNlKSB0aGlzLl9pbml0KCkKICB9CgogIF9pbml0KCkgewogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5zbmFwc2hvdENyZWF0ZSh0aGlzLl9zdGF0ZS5faGFuZGxlKQogIH0KCiAgcmVmKCkgewogICAgdGhpcy5fcmVmcysrCiAgfQoKICB1bnJlZigpIHsKICAgIGlmICgtLXRoaXMuX3JlZnMgPiAwKSByZXR1cm4KCiAgICBpZiAodGhpcy5faGFuZGxlID09PSBudWxsKSByZXR1cm4KCiAgICBiaW5kaW5nLnNuYXBzaG90RGVzdHJveSh0aGlzLl9oYW5kbGUpCgogICAgdGhpcy5faGFuZGxlID0gbnVsbAogIH0KfQpjb25zdCBSZWFkeVJlc291cmNlID0gcmVxdWlyZSgncmVhZHktcmVzb3VyY2UnKQpjb25zdCBSZWZDb3VudGVyID0gcmVxdWlyZSgncmVmY291bnRlcicpCmNvbnN0IHJycCA9IHJlcXVpcmUoJ3Jlc29sdmUtcmVqZWN0LXByb21pc2UnKQpjb25zdCBTaWduYWxQcm9taXNlID0gcmVxdWlyZSgnc2lnbmFsLXByb21pc2UnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IHsgUmVhZEJhdGNoLCBXcml0ZUJhdGNoIH0gPSByZXF1aXJlKCcuL2JhdGNoJykKY29uc3QgQ29sdW1uRmFtaWx5ID0gcmVxdWlyZSgnLi9jb2x1bW4tZmFtaWx5JykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQoKY29uc3QgTUFYX0JBVENIX1JFVVNFID0gNjQKY29uc3QgZW1wdHkgPSBCdWZmZXIuYWxsb2MoMCkKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUm9ja3NEQlN0YXRlIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IoZGIsIHBhdGgsIG9wdHMpIHsKICAgIHN1cGVyKCkKCiAgICBjb25zdCB7CiAgICAgIGNvbHVtbkZhbWlseSA9IG5ldyBDb2x1bW5GYW1pbHkoJ2RlZmF1bHQnLCBvcHRzKSwKICAgICAgY29sdW1uRmFtaWxpZXMgPSBbXSwKICAgICAgcmVhZE9ubHkgPSBmYWxzZSwKICAgICAgY3JlYXRlSWZNaXNzaW5nID0gdHJ1ZSwKICAgICAgY3JlYXRlTWlzc2luZ0NvbHVtbkZhbWlsaWVzID0gdHJ1ZSwKICAgICAgbWF4QmFja2dyb3VuZEpvYnMgPSA2LAogICAgICBieXRlc1BlclN5bmMgPSAxMDQ4NTc2LAogICAgICBtYXhPcGVuRmlsZXMgPSAtMSwKICAgICAgdXNlRGlyZWN0UmVhZHMgPSBmYWxzZSwKICAgICAgYXZvaWRVbm5lY2Vzc2FyeUJsb2NraW5nSU8gPSBmYWxzZSwKICAgICAgc2tpcFN0YXRzVXBkYXRlT25PcGVuID0gZmFsc2UsCiAgICAgIHVzZURpcmVjdElPRm9yRmx1c2hBbmRDb21wYWN0aW9uID0gZmFsc2UsCiAgICAgIG1heEZpbGVPcGVuaW5nVGhyZWFkcyA9IDE2LAogICAgICBsb2NrID0gbnVsbAogICAgfSA9IG9wdHMKCiAgICB0aGlzLnBhdGggPSBwYXRoCiAgICB0aGlzLmRiID0gZGIKICAgIHRoaXMuaGFuZGxlcyA9IG5ldyBSZWZDb3VudGVyKCkKICAgIHRoaXMuaW8gPSBuZXcgUmVmQ291bnRlcigpCiAgICB0aGlzLnNlc3Npb25zID0gW10KICAgIHRoaXMuY29sdW1uRmFtaWxpZXMgPSBbY29sdW1uRmFtaWx5XQogICAgdGhpcy5kZWZlclNuYXBzaG90SW5pdCA9IHRydWUKICAgIHRoaXMucmVzdW1lZCA9IG51bGwKCiAgICB0aGlzLl9zdXNwZW5kZWQgPSBmYWxzZQogICAgdGhpcy5fc3VzcGVuZGluZyA9IGZhbHNlCiAgICB0aGlzLl91cGRhdGluZyA9IGZhbHNlCiAgICB0aGlzLl91cGRhdGluZ1NpZ25hbCA9IG5ldyBTaWduYWxQcm9taXNlKCkKICAgIHRoaXMuX2NvbHVtbnNGbHVzaGVkID0gZmFsc2UKICAgIHRoaXMuX2xvY2sgPSBsb2NrCiAgICB0aGlzLl9yZWFkQmF0Y2hlcyA9IFtdCiAgICB0aGlzLl93cml0ZUJhdGNoZXMgPSBbXQoKICAgIGZvciAoY29uc3QgY29sdW1uRmFtaWx5IG9mIGNvbHVtbkZhbWlsaWVzKSB7CiAgICAgIHRoaXMuY29sdW1uRmFtaWxpZXMucHVzaCgKICAgICAgICB0eXBlb2YgY29sdW1uRmFtaWx5ID09PSAnc3RyaW5nJyA/IG5ldyBDb2x1bW5GYW1pbHkoY29sdW1uRmFtaWx5LCBvcHRzKSA6IGNvbHVtbkZhbWlseQogICAgICApCiAgICB9CgogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5pbml0KAogICAgICByZWFkT25seSwKICAgICAgY3JlYXRlSWZNaXNzaW5nLAogICAgICBjcmVhdGVNaXNzaW5nQ29sdW1uRmFtaWxpZXMsCiAgICAgIG1heEJhY2tncm91bmRKb2JzLAogICAgICBieXRlc1BlclN5bmMsCiAgICAgIG1heE9wZW5GaWxlcywKICAgICAgdXNlRGlyZWN0UmVhZHMsCiAgICAgIGF2b2lkVW5uZWNlc3NhcnlCbG9ja2luZ0lPLAogICAgICBza2lwU3RhdHNVcGRhdGVPbk9wZW4sCiAgICAgIHVzZURpcmVjdElPRm9yRmx1c2hBbmRDb21wYWN0aW9uLAogICAgICBtYXhGaWxlT3BlbmluZ1RocmVhZHMKICAgICkKICB9CgogIGNyZWF0ZVJlYWRCYXRjaChkYiwgb3B0cykgewogICAgaWYgKHRoaXMuX3JlYWRCYXRjaGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG5ldyBSZWFkQmF0Y2goZGIsIG9wdHMpCiAgICBjb25zdCBiYXRjaCA9IHRoaXMuX3JlYWRCYXRjaGVzLnBvcCgpCiAgICBiYXRjaC5fcmV1c2UoZGIsIG9wdHMpCiAgICByZXR1cm4gYmF0Y2gKICB9CgogIGNyZWF0ZVdyaXRlQmF0Y2goZGIsIG9wdHMpIHsKICAgIGlmICh0aGlzLl93cml0ZUJhdGNoZXMubGVuZ3RoID09PSAwKSByZXR1cm4gbmV3IFdyaXRlQmF0Y2goZGIsIG9wdHMpCiAgICBjb25zdCBiYXRjaCA9IHRoaXMuX3dyaXRlQmF0Y2hlcy5wb3AoKQogICAgYmF0Y2guX3JldXNlKGRiLCBvcHRzKQogICAgcmV0dXJuIGJhdGNoCiAgfQoKICBmcmVlQmF0Y2goYmF0Y2gsIHdyaXRhYmxlKSB7CiAgICBpZiAoYmF0Y2guX2NhcGFjaXR5ID4gMTYpIHJldHVybgogICAgY29uc3QgcXVldWUgPSB3cml0YWJsZSA/IHRoaXMuX3dyaXRlQmF0Y2hlcyA6IHRoaXMuX3JlYWRCYXRjaGVzCiAgICBpZiAocXVldWUubGVuZ3RoID49IE1BWF9CQVRDSF9SRVVTRSkgcmV0dXJuCiAgICBxdWV1ZS5wdXNoKGJhdGNoKQogIH0KCiAgYWRkU2Vzc2lvbihkYikgewogICAgZGIuX2luZGV4ID0gdGhpcy5zZXNzaW9ucy5wdXNoKGRiKSAtIDEKICAgIGlmIChkYi5fc25hcHNob3QpIGRiLl9zbmFwc2hvdC5yZWYoKQogIH0KCiAgcmVtb3ZlU2Vzc2lvbihkYikgewogICAgY29uc3QgaGVhZCA9IHRoaXMuc2Vzc2lvbnMucG9wKCkKICAgIGlmIChoZWFkICE9PSBkYikgdGhpcy5zZXNzaW9uc1soaGVhZC5faW5kZXggPSBkYi5faW5kZXgpXSA9IGhlYWQKICAgIGRiLl9pbmRleCA9IC0xCiAgICBpZiAoZGIuX3NuYXBzaG90KSBkYi5fc25hcHNob3QudW5yZWYoKQogIH0KCiAgdXBzZXJ0Q29sdW1uRmFtaWx5KGMpIHsKICAgIGlmICh0eXBlb2YgYyA9PT0gJ3N0cmluZycpIHsKICAgICAgbGV0IGNvbCA9IHRoaXMuZ2V0Q29sdW1uRmFtaWx5QnlOYW1lKGMpCiAgICAgIGlmIChjb2wpIHJldHVybiBjb2wKICAgICAgY29sID0gdGhpcy5jb2x1bW5GYW1pbGllc1swXS5jbG9uZVNldHRpbmdzKGMpCiAgICAgIHRoaXMuY29sdW1uRmFtaWxpZXMucHVzaChjb2wpCiAgICAgIHJldHVybiBjb2wKICAgIH0KCiAgICBpZiAodGhpcy5jb2x1bW5GYW1pbGllcy5pbmNsdWRlcyhjKSkgcmV0dXJuIGMKICAgIHRoaXMuY29sdW1uRmFtaWxpZXMucHVzaChjKQogICAgcmV0dXJuIGMKICB9CgogIGdldENvbHVtbkZhbWlseShjKSB7CiAgICBpZiAoIWMpIHJldHVybiB0aGlzLmNvbHVtbkZhbWlsaWVzWzBdCiAgICBpZiAoIXRoaXMuX2NvbHVtbnNGbHVzaGVkKSByZXR1cm4gdGhpcy51cHNlcnRDb2x1bW5GYW1pbHkoYykKCiAgICBpZiAodHlwZW9mIGMgIT09ICdzdHJpbmcnKSByZXR1cm4gYwoKICAgIGNvbnN0IGNvbCA9IHRoaXMuZ2V0Q29sdW1uRmFtaWx5QnlOYW1lKGMpCiAgICBpZiAoY29sID09PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gY29sdW1uIGZhbWlseScpCiAgICByZXR1cm4gY29sCiAgfQoKICBnZXRDb2x1bW5GYW1pbHlCeU5hbWUobmFtZSkgewogICAgZm9yIChjb25zdCBjb2wgb2YgdGhpcy5jb2x1bW5GYW1pbGllcykgewogICAgICBpZiAoY29sLm5hbWUgPT09IG5hbWUpIHJldHVybiBjb2wKICAgIH0KICAgIHJldHVybiBudWxsCiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIGF3YWl0IFByb21pc2UucmVzb2x2ZSgpIC8vIEFsbG93IGNvbHVtbiBmYW1pbGllcyB0byBwb3B1bGF0ZSBpZiBvbi1kZW1hbmQKCiAgICBpZiAodGhpcy5fbG9jaykgYXdhaXQgdGhpcy5fbG9jay5yZWFkeSgpCgogICAgY29uc3QgcmVxID0geyByZXNvbHZlOiBudWxsLCByZWplY3Q6IG51bGwsIGhhbmRsZTogbnVsbCB9CgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICAgIHJlcS5yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgdGhpcy5fY29sdW1uc0ZsdXNoZWQgPSB0cnVlCgogICAgY29uc3QgbG9jayA9IHRoaXMuX2xvY2sgPT09IG51bGwgPyAtMSA6IHRoaXMuX2xvY2sudHJhbnNmZXIoKQoKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLm9wZW4oCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgdGhpcywKICAgICAgdGhpcy5wYXRoLAogICAgICB0aGlzLmNvbHVtbkZhbWlsaWVzLm1hcCgoYykgPT4gYy5faGFuZGxlKSwKICAgICAgbG9jaywKICAgICAgcmVxLAogICAgICBvbm9wZW4KICAgICkKCiAgICBhd2FpdCBwcm9taXNlCgogICAgdGhpcy5kZWZlclNuYXBzaG90SW5pdCA9IGZhbHNlCgogICAgZm9yIChjb25zdCBzZXNzaW9uIG9mIHRoaXMuc2Vzc2lvbnMpIHsKICAgICAgaWYgKHNlc3Npb24uX3NuYXBzaG90KSBzZXNzaW9uLl9zbmFwc2hvdC5faW5pdCgpCiAgICB9CgogICAgZnVuY3Rpb24gb25vcGVuKGVycikgewogICAgICBpZiAoZXJyKSByZXEucmVqZWN0KG5ldyBFcnJvcihlcnIpKQogICAgICBlbHNlIHJlcS5yZXNvbHZlKCkKICAgIH0KICB9CgogIGFzeW5jIF9jbG9zZSgpIHsKICAgIHdoaWxlICh0aGlzLl91cGRhdGluZykgYXdhaXQgdGhpcy5fdXBkYXRpbmdTaWduYWwud2FpdCgpCiAgICBpZiAodGhpcy5yZXN1bWVkKSB0aGlzLnJlc3VtZWQucmVzb2x2ZShmYWxzZSkKCiAgICB3aGlsZSAoIXRoaXMuaW8uaXNJZGxlKCkpIGF3YWl0IHRoaXMuaW8uaWRsZSgpCiAgICB3aGlsZSAoIXRoaXMuaGFuZGxlcy5pc0lkbGUoKSkgYXdhaXQgdGhpcy5oYW5kbGVzLmlkbGUoKQoKICAgIHdoaWxlICh0aGlzLnNlc3Npb25zLmxlbmd0aCA+IDApIHsKICAgICAgYXdhaXQgdGhpcy5zZXNzaW9uc1t0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDFdLmNsb3NlKCkKICAgIH0KCiAgICBmb3IgKGNvbnN0IGNvbHVtbkZhbWlseSBvZiB0aGlzLmNvbHVtbkZhbWlsaWVzKSBjb2x1bW5GYW1pbHkuZGVzdHJveSgpCgogICAgY29uc3QgcmVxID0geyByZXNvbHZlOiBudWxsLCByZWplY3Q6IG51bGwsIGhhbmRsZTogbnVsbCB9CgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICAgIHJlcS5yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcuY2xvc2UodGhpcy5faGFuZGxlLCByZXEsIG9uY2xvc2UpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgcHJvbWlzZQogICAgfSBmaW5hbGx5IHsKICAgICAgaWYgKHRoaXMuX2xvY2spIGF3YWl0IHRoaXMuX2xvY2suY2xvc2UoKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uY2xvc2UoZXJyKSB7CiAgICAgIGlmIChlcnIpIHJlcS5yZWplY3QobmV3IEVycm9yKGVycikpCiAgICAgIGVsc2UgcmVxLnJlc29sdmUoKQogICAgfQogIH0KCiAgYXN5bmMgZmx1c2goZGIsIG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIHRoaXMuaW8uaW5jKCkKCiAgICBpZiAodGhpcy5yZXN1bWVkICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IHJlc3VtZWQgPSBhd2FpdCB0aGlzLnJlc3VtZWQucHJvbWlzZQoKICAgICAgaWYgKCFyZXN1bWVkKSB7CiAgICAgICAgdGhpcy5pby5kZWMoKQoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JvY2tzREIgc2Vzc2lvbiBpcyBjbG9zZWQnKQogICAgICB9CiAgICB9CgogICAgY29uc3QgcmVxID0geyByZXNvbHZlOiBudWxsLCByZWplY3Q6IG51bGwsIGhhbmRsZTogbnVsbCB9CgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICAgIHJlcS5yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgdHJ5IHsKICAgICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcuZmx1c2godGhpcy5faGFuZGxlLCBkYi5fY29sdW1uRmFtaWx5Ll9oYW5kbGUsIHJlcSwgb25mbHVzaCkKCiAgICAgIGF3YWl0IHByb21pc2UKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuaW8uZGVjKCkKICAgIH0KCiAgICBmdW5jdGlvbiBvbmZsdXNoKGVycikgewogICAgICBpZiAoZXJyKSByZXEucmVqZWN0KG5ldyBFcnJvcihlcnIpKQogICAgICBlbHNlIHJlcS5yZXNvbHZlKCkKICAgIH0KICB9CgogIHN1c3BlbmQoKSB7CiAgICB0aGlzLl9zdXNwZW5kaW5nID0gdHJ1ZQogICAgcmV0dXJuIHRoaXMudXBkYXRlKCkKICB9CgogIHJlc3VtZSgpIHsKICAgIHRoaXMuX3N1c3BlbmRpbmcgPSBmYWxzZQogICAgcmV0dXJuIHRoaXMudXBkYXRlKCkKICB9CgogIGFzeW5jIHVwZGF0ZSgpIHsKICAgIHdoaWxlICh0aGlzLl91cGRhdGluZykgYXdhaXQgdGhpcy5fdXBkYXRpbmdTaWduYWwud2FpdCgpCiAgICBpZiAodGhpcy5fc3VzcGVuZGluZyA9PT0gdGhpcy5fc3VzcGVuZGVkIHx8IHRoaXMuY2xvc2luZykgcmV0dXJuCiAgICB0aGlzLl91cGRhdGluZyA9IHRydWUKICAgIHRyeSB7CiAgICAgIGlmICh0aGlzLl9zdXNwZW5kaW5nKSBhd2FpdCB0aGlzLl9zdXNwZW5kKCkKICAgICAgZWxzZSBhd2FpdCB0aGlzLl9yZXN1bWUoKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fdXBkYXRpbmcgPSBmYWxzZQogICAgICB0aGlzLl91cGRhdGluZ1NpZ25hbC5ub3RpZnkoKQogICAgfQogIH0KCiAgYXN5bmMgX3N1c3BlbmQoKSB7CiAgICBpZiAodGhpcy5fc3VzcGVuZGVkID09PSB0cnVlKSByZXR1cm4KCiAgICB3aGlsZSAoIXRoaXMuaW8uaXNJZGxlKCkpIGF3YWl0IHRoaXMuaW8uaWRsZSgpCgogICAgdGhpcy5pby5pbmMoKQogICAgdGhpcy5yZXN1bWVkID0gcnJwKCkKCiAgICBjb25zdCByZXEgPSB7IHJlc29sdmU6IG51bGwsIHJlamVjdDogbnVsbCwgaGFuZGxlOiBudWxsIH0KCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgICAgcmVxLnJlamVjdCA9IHJlamVjdAogICAgfSkKCiAgICB0cnkgewogICAgICByZXEuaGFuZGxlID0gYmluZGluZy5zdXNwZW5kKHRoaXMuX2hhbmRsZSwgcmVxLCBvbnN1c3BlbmQpCgogICAgICBhd2FpdCBwcm9taXNlCgogICAgICB0aGlzLl9zdXNwZW5kZWQgPSB0cnVlCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLmlvLmRlYygpCiAgICB9CgogICAgZnVuY3Rpb24gb25zdXNwZW5kKGVycikgewogICAgICBpZiAoZXJyKSByZXEucmVqZWN0KG5ldyBFcnJvcihlcnIpKQogICAgICBlbHNlIHJlcS5yZXNvbHZlKCkKICAgIH0KICB9CgogIGFzeW5jIF9yZXN1bWUoKSB7CiAgICBpZiAodGhpcy5fc3VzcGVuZGVkID09PSBmYWxzZSkgcmV0dXJuCgogICAgY29uc3QgcmVxID0geyByZXNvbHZlOiBudWxsLCByZWplY3Q6IG51bGwsIGhhbmRsZTogbnVsbCB9CgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICAgIHJlcS5yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcucmVzdW1lKHRoaXMuX2hhbmRsZSwgcmVxLCBvbnJlc3VtZSkKCiAgICBhd2FpdCBwcm9taXNlCgogICAgdGhpcy5fc3VzcGVuZGVkID0gZmFsc2UKCiAgICBjb25zdCByZXN1bWVkID0gdGhpcy5yZXN1bWVkCiAgICB0aGlzLnJlc3VtZWQgPSBudWxsCiAgICByZXN1bWVkLnJlc29sdmUodHJ1ZSkKCiAgICBmdW5jdGlvbiBvbnJlc3VtZShlcnIpIHsKICAgICAgaWYgKGVycikgcmVxLnJlamVjdChuZXcgRXJyb3IoZXJyKSkKICAgICAgZWxzZSByZXEucmVzb2x2ZSgpCiAgICB9CiAgfQoKICBhc3luYyBjb21wYWN0UmFuZ2UoZGIsIHN0YXJ0LCBlbmQsIG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIHRoaXMuaW8uaW5jKCkKCiAgICBjb25zdCB7IGV4Y2x1c2l2ZSA9IGZhbHNlIH0gPSBvcHRzCgogICAgc3RhcnQgPSB0aGlzLl9lbmNvZGVLZXkoc3RhcnQpCiAgICBlbmQgPSB0aGlzLl9lbmNvZGVLZXkoZW5kKQoKICAgIGNvbnN0IHJlcSA9IHsgcmVzb2x2ZTogbnVsbCwgcmVqZWN0OiBudWxsLCBoYW5kbGU6IG51bGwsIHN0YXJ0LCBlbmQgfQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIHRyeSB7CiAgICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLmNvbXBhY3RSYW5nZSgKICAgICAgICB0aGlzLl9oYW5kbGUsCiAgICAgICAgZGIuX2NvbHVtbkZhbWlseS5faGFuZGxlLAogICAgICAgIHN0YXJ0LAogICAgICAgIGVuZCwKICAgICAgICBleGNsdXNpdmUsCiAgICAgICAgcmVxLAogICAgICAgIG9uY29tcGFjdHJhbmdlCiAgICAgICkKCiAgICAgIGF3YWl0IHByb21pc2UKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuaW8uZGVjKCkKICAgIH0KCiAgICBmdW5jdGlvbiBvbmNvbXBhY3RyYW5nZShlcnIpIHsKICAgICAgaWYgKGVycikgcmVxLnJlamVjdChuZXcgRXJyb3IoZXJyKSkKICAgICAgZWxzZSByZXEucmVzb2x2ZSgpCiAgICB9CiAgfQoKICBhc3luYyBhcHByb3hpbWF0ZVNpemUoZGIsIHN0YXJ0LCBlbmQsIG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIHRoaXMuaW8uaW5jKCkKCiAgICBjb25zdCB7IGluY2x1ZGVNZW10YWJsZXMgPSBmYWxzZSwgaW5jbHVkZUZpbGVzID0gdHJ1ZSwgZmlsZXNTaXplRXJyb3JNYXJnaW4gPSAtMSB9ID0gb3B0cwoKICAgIHN0YXJ0ID0gdGhpcy5fZW5jb2RlS2V5KHN0YXJ0KQogICAgZW5kID0gdGhpcy5fZW5jb2RlS2V5KGVuZCkKCiAgICBjb25zdCByZXEgPSB7IHJlc29sdmU6IG51bGwsIHJlamVjdDogbnVsbCwgaGFuZGxlOiBudWxsLCBzdGFydCwgZW5kIH0KCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgICAgcmVxLnJlamVjdCA9IHJlamVjdAogICAgfSkKCiAgICB0cnkgewogICAgICByZXEuaGFuZGxlID0gYmluZGluZy5hcHByb3hpbWF0ZVNpemUoCiAgICAgICAgdGhpcy5faGFuZGxlLAogICAgICAgIGRiLl9jb2x1bW5GYW1pbHkuX2hhbmRsZSwKICAgICAgICBzdGFydCwKICAgICAgICBlbmQsCiAgICAgICAgaW5jbHVkZU1lbXRhYmxlcywKICAgICAgICBpbmNsdWRlRmlsZXMsCiAgICAgICAgZmlsZXNTaXplRXJyb3JNYXJnaW4sCiAgICAgICAgcmVxLAogICAgICAgIG9uYXBwcm94aW1hdGVzaXplCiAgICAgICkKCiAgICAgIHJldHVybiBhd2FpdCBwcm9taXNlCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLmlvLmRlYygpCiAgICB9CgogICAgZnVuY3Rpb24gb25hcHByb3hpbWF0ZXNpemUoZXJyLCByZXN1bHQpIHsKICAgICAgaWYgKGVycikgcmVxLnJlamVjdChuZXcgRXJyb3IoZXJyKSkKICAgICAgZWxzZSByZXEucmVzb2x2ZShyZXN1bHQpCiAgICB9CiAgfQoKICBfZW5jb2RlS2V5KGspIHsKICAgIGlmICh0aGlzLmRiLl9rZXlFbmNvZGluZykgcmV0dXJuIGMuZW5jb2RlKHRoaXMuZGIuX2tleUVuY29kaW5nLCBrKQogICAgaWYgKHR5cGVvZiBrID09PSAnc3RyaW5nJykgcmV0dXJuIEJ1ZmZlci5mcm9tKGspCiAgICBpZiAoayA9PT0gbnVsbCkgcmV0dXJuIGVtcHR5CiAgICByZXR1cm4gawogIH0KfQp7CiAgIm5hbWUiOiAicm9ja3NkYi1uYXRpdmUiLAogICJ2ZXJzaW9uIjogIjMuMTEuNCIsCiAgImRlc2NyaXB0aW9uIjogImxpYnJvY2tzZGIgYmluZGluZ3MgZm9yIEphdmFTY3JpcHQiLAogICJleHBvcnRzIjogewogICAgIi4iOiAiLi9pbmRleC5qcyIsCiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIgogIH0sCiAgImltcG9ydHMiOiB7CiAgICAiZnMiOiAiYmFyZS1mcyIsCiAgICAiZGVmYXVsdCI6ICJmcyIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiYmluZGluZy5jYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiLAogICAgImxpYiIsCiAgICAicHJlYnVpbGRzIiwKICAgICIhcHJlYnVpbGRzL2FuZHJvaWQtKi8qKi8qLm5vZGUiCiAgXSwKICAiYWRkb24iOiB0cnVlLAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuIiwKICAgICJ0ZXN0IjogIm5wbSBydW4gbGludCAmJiBucG0gcnVuIHRlc3Q6YmFyZSAmJiBucG0gcnVuIHRlc3Q6bm9kZSIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC5qcyIsCiAgICAidGVzdDpub2RlIjogIm5vZGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yb2Nrc2RiLW5hdGl2ZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMiLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcm9ja3NkYi1uYXRpdmUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yb2Nrc2RiLW5hdGl2ZSIsCiAgImVuZ2luZXMiOiB7CiAgICAiYmFyZSI6ICI+PTEuMTYuMCIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xNS4wIiwKICAgICJyZWFkeS1yZXNvdXJjZSI6ICJeMS4wLjAiLAogICAgInJlZmNvdW50ZXIiOiAiXjEuMC4wIiwKICAgICJyZXF1aXJlLWFkZG9uIjogIl4xLjAuMiIsCiAgICAicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6ICJeMS4xLjAiLAogICAgInNpZ25hbC1wcm9taXNlIjogIl4xLjAuMyIsCiAgICAic3RyZWFteCI6ICJeMi4xNi4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWNvbXBhdC1uYXBpIjogIl4xLjMuMCIsCiAgICAiYmFyZS1mcyI6ICJeNC41LjAiLAogICAgImJyaXR0bGUiOiAiXjMuNS4wIiwKICAgICJjbWFrZS1iYXJlIjogIl4xLjEuMTQiLAogICAgImNtYWtlLWZldGNoIjogIl4xLjAuMSIsCiAgICAiY21ha2UtbmFwaSI6ICJeMS4wLjYiLAogICAgImZkLWxvY2siOiAiXjIuMC4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0KfQptb2R1bGUuZXhwb3J0cyA9IHNhZmV0eUNhdGNoCgpmdW5jdGlvbiBpc0FjdHVhbGx5VW5jYXVnaHQgKGVycikgewogIGlmICghZXJyKSByZXR1cm4gZmFsc2UKICByZXR1cm4gZXJyIGluc3RhbmNlb2YgVHlwZUVycm9yIHx8CiAgICBlcnIgaW5zdGFuY2VvZiBTeW50YXhFcnJvciB8fAogICAgZXJyIGluc3RhbmNlb2YgUmVmZXJlbmNlRXJyb3IgfHwKICAgIGVyciBpbnN0YW5jZW9mIEV2YWxFcnJvciB8fAogICAgZXJyIGluc3RhbmNlb2YgUmFuZ2VFcnJvciB8fAogICAgZXJyIGluc3RhbmNlb2YgVVJJRXJyb3IgfHwKICAgIGVyci5jb2RlID09PSAnRVJSX0FTU0VSVElPTicKfQoKZnVuY3Rpb24gdGhyb3dFcnJvck5UIChlcnIpIHsKICBxdWV1ZU1pY3JvdGFzaygoKSA9PiB7IHRocm93IGVyciB9KQp9CgpmdW5jdGlvbiBzYWZldHlDYXRjaCAoZXJyKSB7CiAgaWYgKGlzQWN0dWFsbHlVbmNhdWdodChlcnIpKSB7CiAgICB0aHJvd0Vycm9yTlQoZXJyKQogICAgdGhyb3cgZXJyCiAgfQp9CnsKICAibmFtZSI6ICJzYWZldHktY2F0Y2giLAogICJ2ZXJzaW9uIjogIjEuMC4yIiwKICAiZGVzY3JpcHRpb24iOiAiU21hbGwgbW9kdWxlIHRoYXQgbWFrZXMgc3VyZSB5b3VyIGNhdGNoLCBjYXVnaHQgYW4gYWN0dWFsIGVycm9yIGFuZCBub3QgYSBwcm9ncmFtbWluZyBtaXN0YWtlIG9yIGFzc2VydGlvbiIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjoge30sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NhZmV0eS1jYXRjaC5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc2FmZXR5LWNhdGNoL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NhZmV0eS1jYXRjaCIKfQpsZXQgdG1wUmVzb2x2ZSA9IG51bGwKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU2NvcGVMb2NrIHsKICBjb25zdHJ1Y3RvciAoeyBkZWJvdW5jZSA9IGZhbHNlIH0gPSB7fSkgewogICAgdGhpcy5kZWJvdW5jZSA9IGRlYm91bmNlCiAgICB0aGlzLndhaXRpbmcgPSBbXQogICAgdGhpcy5sb2NrZWQgPSBmYWxzZQogICAgdGhpcy5za2lwID0gMAogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogIH0KCiAgZmx1c2ggKCkgewogICAgaWYgKHRoaXMubG9ja2VkID09PSBmYWxzZSAmJiB0aGlzLndhaXRpbmcubGVuZ3RoID09PSAwKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMuZGVzdHJveWVkID09PSBmYWxzZSkKCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2Uoc2V0VG1wUmVzb2x2ZSkKICAgIGNvbnN0IHJlc29sdmUgPSB0bXBSZXNvbHZlCgogICAgdG1wUmVzb2x2ZSA9IG51bGwKICAgIHRoaXMud2FpdGluZy5wdXNoKHsgbG9jazogZmFsc2UsIHJlc29sdmUgfSkKCiAgICByZXR1cm4gcHJvbWlzZQogIH0KCiAgZGVzdHJveSAoKSB7CiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICB9CgogIGxvY2sgKCkgewogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHNldFRtcFJlc29sdmUpCiAgICBjb25zdCByZXNvbHZlID0gdG1wUmVzb2x2ZQoKICAgIHRtcFJlc29sdmUgPSBudWxsCgogICAgaWYgKHRoaXMubG9ja2VkID09PSB0cnVlKSB7CiAgICAgIHRoaXMud2FpdGluZy5wdXNoKHsgbG9jazogdHJ1ZSwgcmVzb2x2ZSB9KQogICAgICByZXR1cm4gcHJvbWlzZQogICAgfQoKICAgIGlmICh0aGlzLmRlc3Ryb3llZCA9PT0gdHJ1ZSkgewogICAgICByZXNvbHZlKGZhbHNlKQogICAgICByZXR1cm4gcHJvbWlzZQogICAgfQoKICAgIHRoaXMubG9ja2VkID0gdHJ1ZQogICAgcmVzb2x2ZSh0cnVlKQoKICAgIHJldHVybiBwcm9taXNlCiAgfQoKICB1bmxvY2sgKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkID09PSB0cnVlKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy53YWl0aW5nLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy53YWl0aW5nW2ldLnJlc29sdmUoZmFsc2UpCiAgICAgIH0KICAgICAgdGhpcy53YWl0aW5nID0gW10KICAgICAgdGhpcy5za2lwID0gMAogICAgICB0aGlzLmxvY2tlZCA9IGZhbHNlCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLnNraXAgIT09IDApIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnNraXA7IGkrKykgewogICAgICAgIGNvbnN0IHsgbG9jaywgcmVzb2x2ZSB9ID0gdGhpcy53YWl0aW5nW2ldCiAgICAgICAgcmVzb2x2ZShsb2NrID09PSBmYWxzZSkKICAgICAgfQoKICAgICAgdGhpcy53YWl0aW5nID0gdGhpcy53YWl0aW5nLnNsaWNlKHRoaXMuc2tpcCkKICAgICAgdGhpcy5za2lwID0gMAogICAgfQoKICAgIHdoaWxlICh0aGlzLndhaXRpbmcubGVuZ3RoID4gMCAmJiB0aGlzLndhaXRpbmdbMF0ubG9jayA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy53YWl0aW5nLnNoaWZ0KCkucmVzb2x2ZSh0cnVlKQogICAgfQoKICAgIGlmICh0aGlzLndhaXRpbmcubGVuZ3RoID09PSAwKSB7CiAgICAgIHRoaXMubG9ja2VkID0gZmFsc2UKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgeyByZXNvbHZlIH0gPSB0aGlzLndhaXRpbmcuc2hpZnQoKQogICAgaWYgKHRoaXMuZGVib3VuY2UgPT09IHRydWUpIHRoaXMuc2tpcCA9IHRoaXMud2FpdGluZy5sZW5ndGgKCiAgICByZXNvbHZlKHRydWUpCiAgfQp9CgpmdW5jdGlvbiBzZXRUbXBSZXNvbHZlIChyZXNvbHZlKSB7CiAgdG1wUmVzb2x2ZSA9IHJlc29sdmUKfQp7CiAgIm5hbWUiOiAic2NvcGUtbG9jayIsCiAgInZlcnNpb24iOiAiMS4yLjQiLAogICJkZXNjcmlwdGlvbiI6ICJTb21lIGNvbmN1cnJlbmN5IHNlbWFudGljcyBhcm91bmQgZW50ZXJpbmcgc2NvcGVzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjcuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMiIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc2NvcGUtbG9jay5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMuIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3Njb3BlLWxvY2svaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zY29wZS1sb2NrIgp9CmNvbnN0IHNldCA9IHJlcXVpcmUoJ3Vub3JkZXJlZC1zZXQnKQoKbW9kdWxlLmV4cG9ydHMgPSBvcHRzID0+IG5ldyBTaHVmZmxlZFByaW9yaXR5UXVldWUob3B0cykKCmNsYXNzIFNodWZmbGVkUHJpb3JpdHlRdWV1ZSB7CiAgY29uc3RydWN0b3IgKG9wdHMpIHsKICAgIHRoaXMucHJpb3JpdGllcyA9IFtdCiAgICB0aGlzLmVxdWFscyA9IChvcHRzICYmIG9wdHMuZXF1YWxzKSB8fCBudWxsCiAgfQoKICBnZXQgbGVuZ3RoICgpIHsKICAgIHJldHVybiB0aGlzLnByaW9yaXRpZXMucmVkdWNlKGFkZCwgMCkKICB9CgogIFtTeW1ib2wuaXRlcmF0b3JdICgpIHsKICAgIHJldHVybiBuZXcgSXRlcmF0b3IodGhpcykKICB9CgogIGhlYWQgKCkgewogICAgZm9yIChsZXQgaSA9IHRoaXMucHJpb3JpdGllcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBxID0gdGhpcy5wcmlvcml0aWVzW2ldCiAgICAgIGlmIChxLmxlbmd0aCkgcmV0dXJuIHNodWZmbGUocSwgMCkKICAgIH0KICAgIHJldHVybiBudWxsCiAgfQoKICB0YWlsICgpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5wcmlvcml0aWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHEgPSB0aGlzLnByaW9yaXRpZXNbaV0KICAgICAgaWYgKHEubGVuZ3RoKSByZXR1cm4gc2h1ZmZsZShxLCAwKQogICAgfQogICAgcmV0dXJuIG51bGwKICB9CgogIHByZXYgKHByZXYpIHsKICAgIGlmICghcHJldikgcmV0dXJuIHRoaXMudGFpbCgpCiAgICByZXR1cm4gbmV4dCh0aGlzLnByaW9yaXRpZXMsIHByZXYsIDEpCiAgfQoKICBuZXh0IChwcmV2KSB7CiAgICBpZiAoIXByZXYpIHJldHVybiB0aGlzLmhlYWQoKQogICAgcmV0dXJuIG5leHQodGhpcy5wcmlvcml0aWVzLCBwcmV2LCAtMSkKICB9CgogIHNoaWZ0ICgpIHsKICAgIHJldHVybiB0aGlzLnJlbW92ZSh0aGlzLmhlYWQoKSkKICB9CgogIHBvcCAoKSB7CiAgICByZXR1cm4gdGhpcy5yZW1vdmUodGhpcy50YWlsKCkpCiAgfQoKICBhZGQgKHZhbCkgewogICAgY29uc3QgcHJpbyA9IHZhbC5wcmlvcml0eSB8fCAwCiAgICB3aGlsZSAocHJpbyA+PSB0aGlzLnByaW9yaXRpZXMubGVuZ3RoKSB0aGlzLnByaW9yaXRpZXMucHVzaChbXSkKICAgIHNldC5hZGQodGhpcy5wcmlvcml0aWVzW3ByaW9dLCB2YWwpCiAgICByZXR1cm4gdmFsCiAgfQoKICByZW1vdmUgKHZhbCkgewogICAgaWYgKCF2YWwpIHJldHVybiBudWxsCgogICAgaWYgKHZhbC5faW5kZXggPT09IHVuZGVmaW5lZCkgewogICAgICB2YWwgPSB0aGlzLmZpbmQodmFsKQogICAgICBpZiAoIXZhbCkgcmV0dXJuIG51bGwKICAgIH0KCiAgICByZXR1cm4gc2V0LnJlbW92ZSh0aGlzLnByaW9yaXRpZXNbdmFsLnByaW9yaXR5IHx8IDBdLCB2YWwpCiAgfQoKICBoYXMgKHZhbCkgewogICAgaWYgKHZhbC5faW5kZXggPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRoaXMuZmluZCh2YWwpCiAgICBjb25zdCBwcmlvcml0eSA9IHZhbC5wcmlvcml0eSB8fCAwCiAgICBpZiAocHJpb3JpdHkgPj0gdGhpcy5wcmlvcml0aWVzLmxlbmd0aCkgcmV0dXJuIGZhbHNlCiAgICByZXR1cm4gc2V0Lmhhcyh0aGlzLnByaW9yaXRpZXNbcHJpb3JpdHldLCB2YWwpCiAgfQoKICBmaW5kICh2YWwpIHsKICAgIGlmICh2YWwuX2luZGV4ICE9PSB1bmRlZmluZWQpIHJldHVybiB2YWwKCiAgICBjb25zdCBwcmlvID0gdmFsLnByaW9yaXR5IHx8IDAKICAgIGNvbnN0IHFzID0gdGhpcy5wcmlvcml0aWVzCiAgICBpZiAocHJpbyA+PSBxcy5sZW5ndGgpIHJldHVybiBudWxsCgogICAgY29uc3QgcSA9IHFzW3ByaW9dCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBxLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0aGlzLmVxdWFscyhxW2ldLCB2YWwpKSByZXR1cm4gcVtpXQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQp9CgpjbGFzcyBJdGVyYXRvciB7CiAgY29uc3RydWN0b3IgKHF1ZXVlKSB7CiAgICB0aGlzLnByZXYgPSBudWxsCiAgICB0aGlzLnF1ZXVlID0gcXVldWUKICB9CgogIG5leHQgKCkgewogICAgY29uc3QgbmV4dCA9IHRoaXMucXVldWUubmV4dCh0aGlzLnByZXYpCiAgICB0aGlzLnByZXYgPSBuZXh0CiAgICByZXR1cm4geyBkb25lOiAhbmV4dCwgdmFsdWU6IG5leHQgfQogIH0KfQoKZnVuY3Rpb24gc2h1ZmZsZSAocSwgaSkgewogIGNvbnN0IHJhbiA9IGkgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAocS5sZW5ndGggLSBpKSkKICBzZXQuc3dhcChxLCBxW3Jhbl0sIHFbaV0pCiAgcmV0dXJuIHFbaV0KfQoKZnVuY3Rpb24gbmV4dCAocXVldWVzLCBwcmV2LCBpbmMpIHsKICBsZXQgaSA9IHByZXYucHJpb3JpdHkgfHwgMAogIGxldCBqID0gKHByZXYuX2luZGV4IHx8IDApICsgMQoKICB3aGlsZSAodHJ1ZSkgewogICAgaWYgKGkgPCAwIHx8IGkgPj0gcXVldWVzLmxlbmd0aCkgcmV0dXJuIG51bGwKICAgIGNvbnN0IHEgPSBxdWV1ZXNbaV0KCiAgICBpZiAoaiA+PSBxLmxlbmd0aCkgewogICAgICBpICs9IGluYwogICAgICBqID0gMAogICAgICBjb250aW51ZQogICAgfQoKICAgIHJldHVybiBzaHVmZmxlKHEsIGopCiAgfQp9CgpmdW5jdGlvbiBhZGQgKGxlbiwgYikgewogIHJldHVybiBsZW4gKyBiLmxlbmd0aAp9CnsKICAibmFtZSI6ICJzaHVmZmxlZC1wcmlvcml0eS1xdWV1ZSIsCiAgInZlcnNpb24iOiAiMi4xLjAiLAogICJkZXNjcmlwdGlvbiI6ICJBIHByaW9yaXR5IHF1ZXVlIHRoYXQgc2h1ZmZsZXMgZWxlbWVudHMgd2l0aCB0aGUgc2FtZSBwcmlvcml0eS4iLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAidW5vcmRlcmVkLXNldCI6ICJeMi4wLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xMi4wLjEiLAogICAgInRhcGUiOiAiXjQuOS4xIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NodWZmbGVkLXByaW9yaXR5LXF1ZXVlLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zaHVmZmxlZC1wcmlvcml0eS1xdWV1ZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zaHVmZmxlZC1wcmlvcml0eS1xdWV1ZSIKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFNpZ25hbCB7CiAgY29uc3RydWN0b3IgKCkgewogICAgdGhpcy5fcmVzb2x2ZSA9IG51bGwKICAgIHRoaXMuX3JlamVjdCA9IG51bGwKICAgIHRoaXMuX3Byb21pc2UgPSBudWxsCiAgICB0aGlzLl9iaW5kID0gYmluZC5iaW5kKHRoaXMpCiAgICB0aGlzLl9vbmVycm9yID0gY2xlYXIuYmluZCh0aGlzKQogICAgdGhpcy5fb25zdWNjZXNzID0gY2xlYXIuYmluZCh0aGlzLCBudWxsKQogICAgdGhpcy5fdGltZXJzID0gbmV3IFNldCgpCiAgfQoKICB3YWl0IChtYXgpIHsKICAgIGlmICghdGhpcy5fcHJvbWlzZSkgewogICAgICB0aGlzLl9wcm9taXNlID0gbmV3IFByb21pc2UodGhpcy5fYmluZCkKICAgICAgdGhpcy5fcHJvbWlzZS50aGVuKHRoaXMuX29uc3VjY2VzcykuY2F0Y2godGhpcy5fb25lcnJvcikKICAgIH0KICAgIGlmIChtYXgpIHJldHVybiB0aGlzLl9zbGVlcChtYXgpCiAgICByZXR1cm4gdGhpcy5fcHJvbWlzZQogIH0KCiAgX3NsZWVwIChtYXgpIHsKICAgIGNvbnN0IHMgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGNvbnN0IGRvbmUgPSAoKSA9PiB7CiAgICAgICAgdGhpcy5fdGltZXJzLmRlbGV0ZShzdGF0ZSkKICAgICAgICByZXNvbHZlKHRydWUpCiAgICAgIH0KICAgICAgY29uc3QgaWQgPSBzZXRUaW1lb3V0KGRvbmUsIG1heCkKICAgICAgY29uc3Qgc3RhdGUgPSB7IGlkLCByZXNvbHZlLCByZWplY3QgfQogICAgICB0aGlzLl90aW1lcnMuYWRkKHN0YXRlKQogICAgfSkKCiAgICByZXR1cm4gcwogIH0KCiAgbm90aWZ5IChlcnIpIHsKICAgIGlmICghdGhpcy5fcHJvbWlzZSkgcmV0dXJuCiAgICBjb25zdCByZXNvbHZlID0gdGhpcy5fcmVzb2x2ZQogICAgY29uc3QgcmVqZWN0ID0gdGhpcy5fcmVqZWN0CiAgICB0aGlzLl9wcm9taXNlID0gbnVsbAogICAgaWYgKGVycikgcmVqZWN0KGVycikKICAgIGVsc2UgcmVzb2x2ZSh0cnVlKQogIH0KfQoKZnVuY3Rpb24gY2xlYXIgKGVycikgewogIGZvciAoY29uc3QgeyBpZCwgcmVzb2x2ZSwgcmVqZWN0IH0gb2YgdGhpcy5fdGltZXJzKSB7CiAgICBjbGVhclRpbWVvdXQoaWQpCiAgICBpZiAoZXJyKSByZWplY3QoZXJyKQogICAgZWxzZSByZXNvbHZlKHRydWUpCiAgfQogIHRoaXMuX3RpbWVycy5jbGVhcigpCn0KCmZ1bmN0aW9uIGJpbmQgKHJlc29sdmUsIHJlamVjdCkgewogIHRoaXMuX3Jlc29sdmUgPSByZXNvbHZlCiAgdGhpcy5fcmVqZWN0ID0gcmVqZWN0Cn0KewogICJuYW1lIjogInNpZ25hbC1wcm9taXNlIiwKICAidmVyc2lvbiI6ICIxLjAuMyIsCiAgImRlc2NyaXB0aW9uIjogIlNpbXBsZSB3YWl0L25vdGlmeSBwcm9taXNlIHdpdGggb3B0aW9uYWwgbWF4IHdhaXQgdGltZSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjoge30sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NpZ25hbC1wcm9taXNlLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zaWduYWwtcHJvbWlzZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zaWduYWwtcHJvbWlzZSIKfQp2YXIgdmFyaW50ID0gcmVxdWlyZSgndmFyaW50JykKZXhwb3J0cy5lbmNvZGUgPSBmdW5jdGlvbiBlbmNvZGUgKHYsIGIsIG8pIHsKICB2ID0gdiA+PSAwID8gdioyIDogdiotMiAtIDEKICB2YXIgciA9IHZhcmludC5lbmNvZGUodiwgYiwgbykKICBlbmNvZGUuYnl0ZXMgPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgcmV0dXJuIHIKfQpleHBvcnRzLmRlY29kZSA9IGZ1bmN0aW9uIGRlY29kZSAoYiwgbykgewogIHZhciB2ID0gdmFyaW50LmRlY29kZShiLCBvKQogIGRlY29kZS5ieXRlcyA9IHZhcmludC5kZWNvZGUuYnl0ZXMKICByZXR1cm4gdiAmIDEgPyAodisxKSAvIC0yIDogdiAvIDIKfQoKZXhwb3J0cy5lbmNvZGluZ0xlbmd0aCA9IGZ1bmN0aW9uICh2KSB7CiAgcmV0dXJuIHZhcmludC5lbmNvZGluZ0xlbmd0aCh2ID49IDAgPyB2KjIgOiB2Ki0yIC0gMSkKfQp7CiAgIm5hbWUiOiAic2lnbmVkLXZhcmludCIsCiAgImRlc2NyaXB0aW9uIjogImVmZmljaWVudGx5IHN0b3JlIHNpZ25lZCBpbnRlZ2VycyBpbiB2YXJpbnQiLAogICJ2ZXJzaW9uIjogIjIuMC4xIiwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2RvbWluaWN0YXJyL3NpZ25lZC12YXJpbnQiLAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0Oi8vZ2l0aHViLmNvbS9kb21pbmljdGFyci9zaWduZWQtdmFyaW50LmdpdCIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAidmFyaW50IjogIn41LjAuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAidGFwZSI6ICJ+Mi4xMi4zIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJub2RlIHRlc3QuanMiCiAgfSwKICAiYXV0aG9yIjogIkRvbWluaWMgVGFyciA8ZG9taW5pYy50YXJyQGdtYWlsLmNvbT4gKGh0dHA6Ly9kb21pbmljdGFyci5jb20pIiwKICAibGljZW5zZSI6ICJNSVQiCn0KcmVxdWlyZS5hZGRvbiA9IHJlcXVpcmUoJ3JlcXVpcmUtYWRkb24nKQoKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCcuJywgX19maWxlbmFtZSkKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4vYmluZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpmdW5jdGlvbiBwcmVkaWNhdGUodTgsIHUxNiwgdTMyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIHByZWRpY2F0ZShidWYpIHsKICAgIGlmIChidWYuYnl0ZUxlbmd0aCAlIDE2ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQnVmZmVyIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYnKQogICAgfQoKICAgIGNvbnN0IG4gPSBidWYuQllURVNfUEVSX0VMRU1FTlQKCiAgICBpZiAobiA9PT0gMSkgcmV0dXJuIHU4KGJ1ZikKICAgIGlmIChuID09PSAyKSByZXR1cm4gdTE2KGJ1ZikKICAgIHJldHVybiB1MzIoYnVmKQogIH0KfQoKZnVuY3Rpb24gdW5hcnkodTgsIHUxNiwgdTMyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIHVuYXJ5KGJ1ZiwgcmVzdWx0ID0gYjRhLmFsbG9jVW5zYWZlKGJ1Zi5ieXRlTGVuZ3RoKSkgewogICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoICUgMTYgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXIgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNicpCiAgICB9CgogICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoICE9PSByZXN1bHQuYnl0ZUxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xlbmd0aCBvZiByZXN1bHQgYnVmZmVyIGlzIGluc3VmZmljaWVudCcpCiAgICB9CgogICAgY29uc3QgbiA9IGJ1Zi5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGlmIChuID09PSAxKSB1OChidWYsIHJlc3VsdCkKICAgIGVsc2UgaWYgKG4gPT09IDIpIHUxNihidWYsIHJlc3VsdCkKICAgIGVsc2UgdTMyKGJ1ZiwgcmVzdWx0KQoKICAgIHJldHVybiByZXN1bHQKICB9Cn0KCmZ1bmN0aW9uIGJpbmFyeSh1OCwgdTE2LCB1MzIpIHsKICByZXR1cm4gZnVuY3Rpb24gYmluYXJ5KGEsIGIsIHJlc3VsdCA9IGI0YS5hbGxvY1Vuc2FmZShhLmJ5dGVMZW5ndGgpKSB7CiAgICBpZiAoYS5ieXRlTGVuZ3RoICUgMTYgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXIgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNicpCiAgICB9CgogICAgaWYgKGEuYnl0ZUxlbmd0aCAhPT0gYi5ieXRlTGVuZ3RoIHx8IGEuYnl0ZUxlbmd0aCAhPT0gcmVzdWx0LmJ5dGVMZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXJzIG11c3QgYmUgdGhlIHNhbWUgbGVuZ3RoJykKICAgIH0KCiAgICBjb25zdCBuID0gYS5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGlmIChuID09PSAxKSB1OChhLCBiLCByZXN1bHQpCiAgICBlbHNlIGlmIChuID09PSAyKSB1MTYoYSwgYiwgcmVzdWx0KQogICAgZWxzZSB1MzIoYSwgYiwgcmVzdWx0KQoKICAgIHJldHVybiByZXN1bHQKICB9Cn0KCmZ1bmN0aW9uIHJlZHVjZSh1OCwgdTE2LCB1MzIpIHsKICByZXR1cm4gZnVuY3Rpb24gcmVkdWNlKGJ1ZikgewogICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoICUgMTYgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXIgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNicpCiAgICB9CgogICAgY29uc3QgbiA9IGJ1Zi5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGlmIChuID09PSAxKSByZXR1cm4gdTgoYnVmKQogICAgaWYgKG4gPT09IDIpIHJldHVybiB1MTYoYnVmKQogICAgcmV0dXJuIHUzMihidWYpCiAgfQp9CgpleHBvcnRzLmFsbG8gPSBwcmVkaWNhdGUoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2FsbG9fdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYWxsb192MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYWxsb192MTI4X3UzMgopCgpleHBvcnRzLmFsbHogPSBwcmVkaWNhdGUoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2FsbHpfdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYWxsel92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYWxsel92MTI4X3UzMgopCgpleHBvcnRzLmFuZCA9IGJpbmFyeSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYW5kX3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2FuZF92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYW5kX3YxMjhfdTMyCikKCmV4cG9ydHMuY2xlYXIgPSBiaW5hcnkoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2NsZWFyX3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2NsZWFyX3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbGVhcl92MTI4X3UzMgopCgpleHBvcnRzLmNsbyA9IHVuYXJ5KAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbG9fdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY2xvX3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbG9fdjEyOF91MzIKKQoKZXhwb3J0cy5jbHogPSB1bmFyeSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY2x6X3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2Nsel92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY2x6X3YxMjhfdTMyCikKCmV4cG9ydHMuY250ID0gdW5hcnkoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2NudF92MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbnRfdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2NudF92MTI4X3UzMgopCgpleHBvcnRzLmN0byA9IHVuYXJ5KAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jdG9fdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY3RvX3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jdG9fdjEyOF91MzIKKQoKZXhwb3J0cy5jdHogPSB1bmFyeSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY3R6X3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2N0el92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY3R6X3YxMjhfdTMyCikKCmV4cG9ydHMubm90ID0gdW5hcnkoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX25vdF92MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9ub3RfdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX25vdF92MTI4X3UzMgopCgpleHBvcnRzLm9yID0gYmluYXJ5KAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9vcl92MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9vcl92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfb3JfdjEyOF91MzIKKQoKZXhwb3J0cy5zdW0gPSByZWR1Y2UoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX3N1bV92MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9zdW1fdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX3N1bV92MTI4X3UzMgopCgpleHBvcnRzLnhvciA9IGJpbmFyeSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfeG9yX3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX3hvcl92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfeG9yX3YxMjhfdTMyCikKewogICJuYW1lIjogInNpbWRsZS1uYXRpdmUiLAogICJ2ZXJzaW9uIjogIjEuMy45IiwKICAiZGVzY3JpcHRpb24iOiAibGlic2ltZGxlIEphdmFTY3JpcHQgYmluZGluZ3MgZm9yIE5vZGUuanMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImJpbmRpbmcuY2MiLAogICAgImJpbmRpbmcuanMiLAogICAgIkNNYWtlTGlzdHMudHh0IiwKICAgICJwcmVidWlsZHMiCiAgXSwKICAiYWRkb24iOiB0cnVlLAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuIiwKICAgICJ0ZXN0IjogIm5wbSBydW4gbGludCAmJiBucG0gcnVuIHRlc3Q6YmFyZSAmJiBucG0gcnVuIHRlc3Q6bm9kZSIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC5tanMiLAogICAgInRlc3Q6bm9kZSI6ICJub2RlIHRlc3QubWpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NpbWRsZS1uYXRpdmUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc2ltZGxlLW5hdGl2ZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NpbWRsZS1uYXRpdmUjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjAiLAogICAgInJlcXVpcmUtYWRkb24iOiAiXjEuMS4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWNvbXBhdC1uYXBpIjogIl4xLjMuMiIsCiAgICAiYnJpdHRsZSI6ICJeMy4xLjAiLAogICAgImNtYWtlLWJhcmUiOiAiXjEuMS43IiwKICAgICJjbWFrZS1mZXRjaCI6ICJeMS4xLjAiLAogICAgImNtYWtlLW5hcGkiOiAiXjEuMC4yIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjEuMC4wIgogIH0KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBzY2FsYXIgPSByZXF1aXJlKCcuL3NjYWxhcicpCgpmdW5jdGlvbiB2aWV3IChidWYsIG4pIHsKICBpZiAobiA9PT0gYnVmLkJZVEVTX1BFUl9FTEVNRU5UKSByZXR1cm4gYnVmCgogIGxldCBUeXBlZEFycmF5CgogIGlmIChuID09PSAxKSBUeXBlZEFycmF5ID0gVWludDhBcnJheQogIGVsc2UgaWYgKG4gPT09IDIpIFR5cGVkQXJyYXkgPSBVaW50MTZBcnJheQogIGVsc2UgVHlwZWRBcnJheSA9IFVpbnQzMkFycmF5CgogIHJldHVybiBuZXcgVHlwZWRBcnJheShidWYuYnVmZmVyLCBidWYuYnl0ZU9mZnNldCwgYnVmLmJ5dGVMZW5ndGggLyBuKQp9CgpmdW5jdGlvbiB1bmFyeSAodTgsIHUxNiA9IHU4LCB1MzIgPSB1MTYpIHsKICByZXR1cm4gZnVuY3Rpb24gdW5hcnkgKGJ1ZiwgcmVzdWx0ID0gYjRhLmFsbG9jVW5zYWZlKGJ1Zi5ieXRlTGVuZ3RoKSkgewogICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoICUgMTYgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXIgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNicpCiAgICB9CgogICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoICE9PSByZXN1bHQuYnl0ZUxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xlbmd0aCBvZiByZXN1bHQgYnVmZmVyIGlzIGluc3VmZmljaWVudCcpCiAgICB9CgogICAgY29uc3QgbiA9IGJ1Zi5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGlmIChuID09PSAxKSB1OChidWYsIHZpZXcocmVzdWx0LCBuKSkKICAgIGVsc2UgaWYgKG4gPT09IDIpIHUxNihidWYsIHZpZXcocmVzdWx0LCBuKSkKICAgIGVsc2UgdTMyKGJ1ZiwgdmlldyhyZXN1bHQsIG4pKQoKICAgIHJldHVybiByZXN1bHQKICB9Cn0KCmZ1bmN0aW9uIGJpbmFyeSAodTgsIHUxNiA9IHU4LCB1MzIgPSB1MTYpIHsKICByZXR1cm4gZnVuY3Rpb24gYmluYXJ5IChhLCBiLCByZXN1bHQgPSBiNGEuYWxsb2NVbnNhZmUoYS5ieXRlTGVuZ3RoKSkgewogICAgaWYgKGEuYnl0ZUxlbmd0aCAlIDE2ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQnVmZmVyIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYnKQogICAgfQoKICAgIGlmIChhLmJ5dGVMZW5ndGggIT09IGIuYnl0ZUxlbmd0aCB8fCBhLmJ5dGVMZW5ndGggIT09IHJlc3VsdC5ieXRlTGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQnVmZmVycyBtdXN0IGJlIHRoZSBzYW1lIGxlbmd0aCcpCiAgICB9CgogICAgY29uc3QgbiA9IGEuQllURVNfUEVSX0VMRU1FTlQKCiAgICBpZiAobiA9PT0gMSkgdTgoYSwgYiwgdmlldyhyZXN1bHQsIG4pKQogICAgZWxzZSBpZiAobiA9PT0gMikgdTE2KGEsIGIsIHZpZXcocmVzdWx0LCBuKSkKICAgIGVsc2UgdTMyKGEsIGIsIHZpZXcocmVzdWx0LCBuKSkKCiAgICByZXR1cm4gcmVzdWx0CiAgfQp9CgpmdW5jdGlvbiByZWR1Y2UgKHU4LCB1MTYgPSB1OCwgdTMyID0gdTE2KSB7CiAgcmV0dXJuIGZ1bmN0aW9uIHJlZHVjZSAoYnVmKSB7CiAgICBpZiAoYnVmLmJ5dGVMZW5ndGggJSAxNiAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0J1ZmZlciBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2JykKICAgIH0KCiAgICBjb25zdCBuID0gYnVmLkJZVEVTX1BFUl9FTEVNRU5UCgogICAgaWYgKG4gPT09IDEpIHJldHVybiB1OChidWYpCiAgICBpZiAobiA9PT0gMikgcmV0dXJuIHUxNihidWYpCiAgICByZXR1cm4gdTMyKGJ1ZikKICB9Cn0KCmV4cG9ydHMuYWxsbyA9IGZ1bmN0aW9uIGFsbG8gKGJ1ZikgewogIGlmIChidWYuYnl0ZUxlbmd0aCAlIDE2ICE9PSAwKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0J1ZmZlciBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2JykKICB9CgogIGNvbnN0IG0gPSAyICoqIChidWYuQllURVNfUEVSX0VMRU1FTlQgKiA4KSAtIDEKCiAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICBpZiAoYnVmW2ldICE9PSBtKSByZXR1cm4gZmFsc2UKICB9CgogIHJldHVybiB0cnVlCn0KCmV4cG9ydHMuYWxseiA9IGZ1bmN0aW9uIGFsbHogKGJ1ZikgewogIGlmIChidWYuYnl0ZUxlbmd0aCAlIDE2ICE9PSAwKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0J1ZmZlciBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2JykKICB9CgogIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgaWYgKGJ1ZltpXSAhPT0gMCkgcmV0dXJuIGZhbHNlCiAgfQoKICByZXR1cm4gdHJ1ZQp9CgpleHBvcnRzLmFuZCA9IGJpbmFyeSgKICAoYSwgYiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IHJlc3VsdC5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gYVtpXSAmIGJbaV0KICAgIH0KICB9CikKCmV4cG9ydHMuY2xlYXIgPSBiaW5hcnkoCiAgKGEsIGIsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSByZXN1bHQubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IGFbaV0gJiB+YltpXQogICAgfQogIH0KKQoKZXhwb3J0cy5jbG8gPSB1bmFyeSgKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSAyNCAtIHNjYWxhci5jbG8oYnVmW2ldKQogICAgfQogIH0sCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gMTYgLSBzY2FsYXIuY2xvKGJ1ZltpXSkKICAgIH0KICB9LAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IHNjYWxhci5jbG8oYnVmW2ldKQogICAgfQogIH0KKQoKZXhwb3J0cy5jbHogPSB1bmFyeSgKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSAyNCAtIHNjYWxhci5jbHooYnVmW2ldKQogICAgfQogIH0sCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gMTYgLSBzY2FsYXIuY2x6KGJ1ZltpXSkKICAgIH0KICB9LAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IHNjYWxhci5jbHooYnVmW2ldKQogICAgfQogIH0KKQoKZXhwb3J0cy5jbnQgPSB1bmFyeSgKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBzY2FsYXIuY250KGJ1ZltpXSkgJiAweGZmCiAgICB9CiAgfSwKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBzY2FsYXIuY250KGJ1ZltpXSkgJiAweGZmZmYKICAgIH0KICB9LAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IHNjYWxhci5jbnQoYnVmW2ldKQogICAgfQogIH0KKQoKZXhwb3J0cy5jdG8gPSB1bmFyeSgKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBNYXRoLm1pbihzY2FsYXIuY3RvKGJ1ZltpXSksIDgpCiAgICB9CiAgfSwKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBNYXRoLm1pbihzY2FsYXIuY3RvKGJ1ZltpXSksIDE2KQogICAgfQogIH0sCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gc2NhbGFyLmN0byhidWZbaV0pCiAgICB9CiAgfQopCgpleHBvcnRzLmN0eiA9IHVuYXJ5KAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IE1hdGgubWluKHNjYWxhci5jdHooYnVmW2ldKSwgOCkKICAgIH0KICB9LAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IE1hdGgubWluKHNjYWxhci5jdHooYnVmW2ldKSwgMTYpCiAgICB9CiAgfSwKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBzY2FsYXIuY3R6KGJ1ZltpXSkKICAgIH0KICB9CikKCmV4cG9ydHMubm90ID0gdW5hcnkoCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gfmJ1ZltpXQogICAgfQogIH0KKQoKZXhwb3J0cy5vciA9IGJpbmFyeSgKICAoYSwgYiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IHJlc3VsdC5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gYVtpXSB8IGJbaV0KICAgIH0KICB9CikKCmV4cG9ydHMuc3VtID0gcmVkdWNlKAogIChidWYpID0+IHsKICAgIGxldCByZXN1bHQgPSAwbgoKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHQgKz0gQmlnSW50KGJ1ZltpXSkKICAgIH0KCiAgICByZXR1cm4gcmVzdWx0CiAgfQopCgpleHBvcnRzLnhvciA9IGJpbmFyeSgKICAoYSwgYiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IHJlc3VsdC5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gYVtpXSBeIGJbaV0KICAgIH0KICB9CikKdHJ5IHsKICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoJ3NpbWRsZS1uYXRpdmUnKQp9IGNhdGNoIHsKICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoJy4vZmFsbGJhY2snKQp9CnsKICAibmFtZSI6ICJzaW1kbGUtdW5pdmVyc2FsIiwKICAidmVyc2lvbiI6ICIxLjEuMiIsCiAgImRlc2NyaXB0aW9uIjogIlVuaXZlcnNhbCB3cmFwcGVyIGZvciBsaWJzaW1kbGUgd2l0aCBhIEphdmFTY3JpcHQgZmFsbGJhY2siLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiZmFsbGJhY2suanMiLAogICAgImluZGV4LmpzIiwKICAgICJzY2FsYXIuanMiCiAgXSwKICAiYnJvd3NlciI6IHsKICAgICIuL2luZGV4LmpzIjogIi4vZmFsbGJhY2suanMiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5tanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc2ltZGxlLXVuaXZlcnNhbC5naXQiCiAgfSwKICAiYXV0aG9yIjogIkthc3BlciBJc2FnZXIgRGFsc2dhcsOwIDxrYXNwZXJAZnVua3Rpb25lbC5jbz4iLAogICJsaWNlbnNlIjogIklTQyIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zaW1kbGUtdW5pdmVyc2FsL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc2ltZGxlLXVuaXZlcnNhbCNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMCIKICB9LAogICJvcHRpb25hbERlcGVuZGVuY2llcyI6IHsKICAgICJzaW1kbGUtbmF0aXZlIjogIl4xLjEuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4xLjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfQp9CmNvbnN0IGNseiA9IGV4cG9ydHMuY2x6ID0gZnVuY3Rpb24gY2x6IChuKSB7CiAgcmV0dXJuIE1hdGguY2x6MzIobikKfQoKZXhwb3J0cy5jbG8gPSBmdW5jdGlvbiBjbG8gKG4pIHsKICByZXR1cm4gY2x6KH5uKQp9Cgpjb25zdCBjdHogPSBleHBvcnRzLmN0eiA9IGZ1bmN0aW9uIGN0eiAobikgewogIHJldHVybiAzMiAtIChuID09PSAwID8gMCA6IChjbHoobiAmIC1uKSArIDEpKQp9CgpleHBvcnRzLmN0byA9IGZ1bmN0aW9uIGN0byAobikgewogIHJldHVybiBjdHoofm4pCn0KCmV4cG9ydHMuY250ID0gZnVuY3Rpb24gY250IChuKSB7CiAgbiA9IG4gLSAoKG4gPj4+IDEpICYgMHg1NTU1NTU1NSkKICBuID0gKG4gJiAweDMzMzMzMzMzKSArICgobiA+Pj4gMikgJiAweDMzMzMzMzMzKQogIG4gPSAobiArIChuID4+PiA0KSkgJiAweDBmMGYwZjBmCiAgbiA9IChuICogMHgwMTAxMDEwMSkgPj4+IDI0CiAgcmV0dXJuIG4KfQpyZXF1aXJlLmFkZG9uID0gcmVxdWlyZSgncmVxdWlyZS1hZGRvbicpCm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZS5hZGRvbignLicsIF9fZmlsZW5hbWUpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuL2JpbmRpbmcnKQpjb25zdCB7IGlzTm9kZSB9ID0gcmVxdWlyZSgnd2hpY2gtcnVudGltZScpCgpjb25zdCBPUFRJT05BTCA9IEJ1ZmZlci5mcm9tKG5ldyBBcnJheUJ1ZmZlcigwKSkKCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IHsgLi4uYmluZGluZyB9CgovLyBtZW1vcnkKCmV4cG9ydHMuc29kaXVtX21lbXplcm8gPSBmdW5jdGlvbiAoYnVmKSB7CiAgYmluZGluZy5zb2RpdW1fbWVtemVybyhidWYpCn0KCmV4cG9ydHMuc29kaXVtX21sb2NrID0gZnVuY3Rpb24gKGJ1ZikgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuc29kaXVtX21sb2NrKGJ1ZikKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ21lbW9yeSBsb2NrIGZhaWxlZCcpCn0KCmV4cG9ydHMuc29kaXVtX211bmxvY2sgPSBmdW5jdGlvbiAoYnVmKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5zb2RpdW1fbXVubG9jayhidWYpCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdtZW1vcnkgdW5sb2NrIGZhaWxlZCcpCn0KCmV4cG9ydHMuc29kaXVtX21hbGxvYyA9IGZ1bmN0aW9uIChzaXplKSB7CiAgaWYgKHNpemUgPCAwKSB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgc2l6ZScpCiAgY29uc3QgYnVmID0gQnVmZmVyLmZyb20oYmluZGluZy5zb2RpdW1fbWFsbG9jKHNpemUpKQogIGJ1Zi5zZWN1cmUgPSB0cnVlCgogIHJldHVybiBidWYKfQoKZXhwb3J0cy5zb2RpdW1fZnJlZSA9IGZ1bmN0aW9uIChidWYpIHsKICBpZiAoIWJ1Zj8uc2VjdXJlKSByZXR1cm4KCiAgYmluZGluZy5zb2RpdW1fZnJlZShidWYuYnVmZmVyKQp9CgpleHBvcnRzLnNvZGl1bV9tcHJvdGVjdF9ub2FjY2VzcyA9IGZ1bmN0aW9uIChidWYpIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLnNvZGl1bV9tcHJvdGVjdF9ub2FjY2VzcyhidWYuYnVmZmVyKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ2ZhaWxlZCB0byBsb2NrIGJ1ZmZlcicpCn0KCmV4cG9ydHMuc29kaXVtX21wcm90ZWN0X3JlYWRvbmx5ID0gZnVuY3Rpb24gKGJ1ZikgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuc29kaXVtX21wcm90ZWN0X3JlYWRvbmx5KGJ1Zi5idWZmZXIpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIHVubG9jayBidWZmZXInKQp9CgpleHBvcnRzLnNvZGl1bV9tcHJvdGVjdF9yZWFkd3JpdGUgPSBmdW5jdGlvbiAoYnVmKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5zb2RpdW1fbXByb3RlY3RfcmVhZHdyaXRlKGJ1Zi5idWZmZXIpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIHVubG9jayBidWZmZXInKQp9CgovLyBjcnlwdG9fcmFuZG9tYnl0ZXMKCmV4cG9ydHMucmFuZG9tYnl0ZXNfYnVmID0gZnVuY3Rpb24gKGJ1ZmZlcikgewogIGJpbmRpbmcucmFuZG9tYnl0ZXNfYnVmKGJ1ZmZlci5idWZmZXIsIGJ1ZmZlci5ieXRlT2Zmc2V0LCBidWZmZXIuYnl0ZUxlbmd0aCkKfQoKZXhwb3J0cy5yYW5kb21ieXRlc19idWZfZGV0ZXJtaW5pc3RpYyA9IGZ1bmN0aW9uIChidWZmZXIsIHNlZWQpIHsKICBiaW5kaW5nLnJhbmRvbWJ5dGVzX2J1Zl9kZXRlcm1pbmlzdGljKAogICAgYnVmZmVyLmJ1ZmZlciwKICAgIGJ1ZmZlci5ieXRlT2Zmc2V0LAogICAgYnVmZmVyLmJ5dGVMZW5ndGgsCgogICAgc2VlZC5idWZmZXIsCiAgICBzZWVkLmJ5dGVPZmZzZXQsCiAgICBzZWVkLmJ5dGVMZW5ndGgKICApCn0KCi8vIHNvZGl1bV9oZWxwZXJzCgpleHBvcnRzLnNvZGl1bV9tZW1jbXAgPSBmdW5jdGlvbiAoYSwgYikgewogIGlmIChhPy5ieXRlTGVuZ3RoICE9PSBiPy5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdidWZmZXJzIG11c3QgYmUgb2Ygc2FtZSBsZW5ndGgiJykKICByZXR1cm4gYmluZGluZy5zb2RpdW1fbWVtY21wKGEsIGIpCn0KCmV4cG9ydHMuc29kaXVtX2FkZCA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgaWYgKGE/LmJ5dGVMZW5ndGggIT09IGI/LmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2J1ZmZlcnMgbXVzdCBiZSBvZiBzYW1lIGxlbmd0aCInKQogIGJpbmRpbmcuc29kaXVtX2FkZChhLCBiKQp9CgpleHBvcnRzLnNvZGl1bV9zdWIgPSBmdW5jdGlvbiAoYSwgYikgewogIGlmIChhPy5ieXRlTGVuZ3RoICE9PSBiPy5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdidWZmZXJzIG11c3QgYmUgb2Ygc2FtZSBsZW5ndGgiJykKICBiaW5kaW5nLnNvZGl1bV9zdWIoYSwgYikKfQoKZXhwb3J0cy5zb2RpdW1fY29tcGFyZSA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgaWYgKGE/LmJ5dGVMZW5ndGggIT09IGI/LmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2J1ZmZlcnMgbXVzdCBiZSBvZiBzYW1lIGxlbmd0aCInKQogIHJldHVybiBiaW5kaW5nLnNvZGl1bV9jb21wYXJlKGEsIGIpCn0KCmV4cG9ydHMuc29kaXVtX2lzX3plcm8gPSBmdW5jdGlvbiAoYnVmZmVyLCBsZW5ndGgpIHsKICBpZiAoIWJ1ZmZlcikgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGJ1ZmZlcicpCiAgbGVuZ3RoID8/PSBidWZmZXIuYnl0ZUxlbmd0aAogIGlmIChsZW5ndGggPiBidWZmZXIuYnl0ZUxlbmd0aCB8fCBsZW5ndGggPCAwKQogICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGxlbmd0aCcpCgogIHJldHVybiBiaW5kaW5nLnNvZGl1bV9pc196ZXJvKGJ1ZmZlciwgbGVuZ3RoKQp9CgpleHBvcnRzLnNvZGl1bV9wYWQgPSBmdW5jdGlvbiAoYnVmZmVyLCB1bnBhZGRlZEJ1ZmxlbiwgYmxvY2tTaXplKSB7CiAgaWYgKHVucGFkZGVkQnVmbGVuID4gYnVmZmVyLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3VucGFkZGVkIGxlbmd0aCBjYW5ub3QgZXhjZWVkIGJ1ZmZlciBsZW5ndGgnKQogIGlmIChibG9ja1NpemUgPiBidWZmZXIuYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYmxvY2sgc2l6ZSBjYW5ub3QgZXhjZWVkIGJ1ZmZlciBsZW5ndGgnKQogIGlmIChibG9ja1NpemUgPCAxKSB0aHJvdyBuZXcgRXJyb3IoJ2Jsb2NrIHNpemVtdXN0IGJlIGF0IGxlYXN0IDEgYnl0ZScpCiAgaWYgKAogICAgYnVmZmVyPy5ieXRlTGVuZ3RoIDwKICAgIHVucGFkZGVkQnVmbGVuICsgKGJsb2NrU2l6ZSAtICh1bnBhZGRlZEJ1ZmxlbiAlIGJsb2NrU2l6ZSkpCiAgKQogICAgdGhyb3cgbmV3IEVycm9yKCdidWYgbm90IGxvbmcgZW5vdWdoJykKCiAgcmV0dXJuIGJpbmRpbmcuc29kaXVtX3BhZChidWZmZXIsIHVucGFkZGVkQnVmbGVuLCBibG9ja1NpemUpCn0KCmV4cG9ydHMuc29kaXVtX3VucGFkID0gZnVuY3Rpb24gKGJ1ZmZlciwgcGFkZGVkQnVmbGVuLCBibG9ja1NpemUpIHsKICBpZiAocGFkZGVkQnVmbGVuID4gYnVmZmVyLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3VucGFkZGVkIGxlbmd0aCBjYW5ub3QgZXhjZWVkIGJ1ZmZlciBsZW5ndGgnKQogIGlmIChibG9ja1NpemUgPiBidWZmZXIuYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYmxvY2sgc2l6ZSBjYW5ub3QgZXhjZWVkIGJ1ZmZlciBsZW5ndGgnKQogIGlmIChibG9ja1NpemUgPCAxKSB0aHJvdyBuZXcgRXJyb3IoJ2Jsb2NrIHNpemUgbXVzdCBiZSBhdCBsZWFzdCAxIGJ5dGUnKQoKICByZXR1cm4gYmluZGluZy5zb2RpdW1fdW5wYWQoYnVmZmVyLCBwYWRkZWRCdWZsZW4sIGJsb2NrU2l6ZSkKfQoKLy8gY3J5cHRvX3NpZ24KCmV4cG9ydHMuY3J5cHRvX3NpZ25fa2V5cGFpciA9IGZ1bmN0aW9uIChwaywgc2spIHsKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2lnbl9rZXlwYWlyKHBrLCBzaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NpZ25fc2VlZF9rZXlwYWlyID0gZnVuY3Rpb24gKHBrLCBzaywgc2VlZCkgewogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zaWduX3NlZWRfa2V5cGFpcihwaywgc2ssIHNlZWQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zaWduID0gZnVuY3Rpb24gKHNtLCBtLCBzaykgewogIGlmIChzbT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9CWVRFUyArIG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignc20gbXVzdCBiZSAibS5ieXRlTGVuZ3RoICsgY3J5cHRvX3NpZ25fQllURVMiIGJ5dGVzJykKICBpZiAoc2s/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2lnbihzbSwgbSwgc2spCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zaWduX29wZW4gPSBmdW5jdGlvbiAobSwgc20sIHBrKSB7CiAgaWYgKHNtPy5ieXRlTGVuZ3RoIDwgYmluZGluZy5jcnlwdG9fc2lnbl9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdzbScpCiAgaWYgKG0/LmJ5dGVMZW5ndGggIT09IHNtLmJ5dGVMZW5ndGggLSBiaW5kaW5nLmNyeXB0b19zaWduX0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgInNtLmJ5dGVMZW5ndGggLSBjcnlwdG9fc2lnbl9CWVRFUyIgYnl0ZXMnKQogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zaWduX29wZW4obSwgc20sIHBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2lnbl9vcGVuID0gZnVuY3Rpb24gKG0sIHNtLCBwaykgewogIGlmIChzbT8uYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY3J5cHRvX3NpZ25fQllURVMpIHRocm93IG5ldyBFcnJvcignc20nKQogIGlmIChtPy5ieXRlTGVuZ3RoICE9PSBzbS5ieXRlTGVuZ3RoIC0gYmluZGluZy5jcnlwdG9fc2lnbl9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJzbS5ieXRlTGVuZ3RoIC0gY3J5cHRvX3NpZ25fQllURVMiIGJ5dGVzJykKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKCiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX3NpZ25fb3BlbihtLCBzbSwgcGspCn0KCmV4cG9ydHMuY3J5cHRvX3NpZ25fZGV0YWNoZWQgPSBmdW5jdGlvbiAoc2lnLCBtLCBzaykgewogIGlmIChzaWc/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fQllURVMpIHRocm93IG5ldyBFcnJvcignc2lnJykKICBpZiAoc2s/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2lnbl9kZXRhY2hlZChzaWcsIG0sIHNrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2lnbl92ZXJpZnlfZGV0YWNoZWQgPSBmdW5jdGlvbiAoc2lnLCBtLCBwaykgewogIHJldHVybiBiaW5kaW5nLmNyeXB0b19zaWduX3ZlcmlmeV9kZXRhY2hlZCgKICAgIHNpZy5idWZmZXIsCiAgICBzaWcuYnl0ZU9mZnNldCwKICAgIHNpZy5ieXRlTGVuZ3RoLAoKICAgIG0uYnVmZmVyLAogICAgbS5ieXRlT2Zmc2V0LAogICAgbS5ieXRlTGVuZ3RoLAoKICAgIHBrLmJ1ZmZlciwKICAgIHBrLmJ5dGVPZmZzZXQsCiAgICBway5ieXRlTGVuZ3RoCiAgKQp9CgpleHBvcnRzLmNyeXB0b19zaWduX2VkMjU1MTlfc2tfdG9fcGsgPSBmdW5jdGlvbiAocGssIHNrKSB7CiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwaycpCiAgaWYgKHNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1NFQ1JFVEtFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NpZ25fZWQyNTUxOV9za190b19wayhwaywgc2spCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zaWduX2VkMjU1MTlfcGtfdG9fY3VydmUyNTUxOSA9IGZ1bmN0aW9uICh4MjU1MTlwaywgZWQyNTUxOXBrKSB7CiAgaWYgKHgyNTUxOXBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19ib3hfUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3gyNTUxOV9waycpCiAgaWYgKGVkMjU1MTlwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignZWQyNTUxOV9waycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NpZ25fZWQyNTUxOV9wa190b19jdXJ2ZTI1NTE5KHgyNTUxOXBrLCBlZDI1NTE5cGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zaWduX2VkMjU1MTlfc2tfdG9fY3VydmUyNTUxOSA9IGZ1bmN0aW9uICh4MjU1MTlzaywgZWQyNTUxOXNrKSB7CiAgaWYgKHgyNTUxOXNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19ib3hfU0VDUkVUS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3gyNTUxOV9zaycpCgogIGNvbnN0IGVkTGVuID0gZWQyNTUxOXNrLmJ5dGVMZW5ndGgKCiAgaWYgKAogICAgZWRMZW4gIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMgJiYKICAgIGVkTGVuICE9PSBiaW5kaW5nLmNyeXB0b19ib3hfU0VDUkVUS0VZQllURVMKICApIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgImVkMjU1MTlfc2sgc2hvdWxkIGVpdGhlciBiZSAnY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMnIGJ5dGVzIG9yICdjcnlwdG9fc2lnbl9TRUNSRVRLRVlCWVRFUyAtIGNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTJyBieXRlcyIKICAgICkKICB9CgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NpZ25fZWQyNTUxOV9za190b19jdXJ2ZTI1NTE5KHgyNTUxOXNrLCBlZDI1NTE5c2spCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgovLyBjcnlwdG9fYm94CgpleHBvcnRzLmNyeXB0b19ib3hfa2V5cGFpciA9IGZ1bmN0aW9uIChwaywgc2spIHsKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2JveF9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQogIGlmIChzaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYm94X1NFQ1JFVEtFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2JveF9rZXlwYWlyKHBrLCBzaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2JveF9zZWVkX2tleXBhaXIgPSBmdW5jdGlvbiAocGssIHNrLCBzZWVkKSB7CiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19ib3hfUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKICBpZiAoc2s/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2JveF9TRUNSRVRLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19ib3hfc2VlZF9rZXlwYWlyKHBrLCBzaywgc2VlZCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2JveF9lYXN5ID0gZnVuY3Rpb24gKGMsIG0sIG4sIHBrLCBzaykgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2JveF9lYXN5KGMsIG0sIG4sIHBrLCBzaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2JveF9kZXRhY2hlZCA9IGZ1bmN0aW9uIChjLCBtYWMsIG0sIG4sIHBrLCBzaykgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2JveF9kZXRhY2hlZChjLCBtYWMsIG0sIG4sIHBrLCBzaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2JveF9zZWFsID0gZnVuY3Rpb24gKGMsIG0sIHBrKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYm94X3NlYWwoYywgbSwgcGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19ib3hfc2VhbF9vcGVuID0gZnVuY3Rpb24gKG0sIGMsIHBrLCBzaykgewogIHJldHVybiBiaW5kaW5nLmNyeXB0b19ib3hfc2VhbF9vcGVuKAogICAgbS5idWZmZXIsCiAgICBtLmJ5dGVPZmZzZXQsCiAgICBtLmJ5dGVMZW5ndGgsCgogICAgYy5idWZmZXIsCiAgICBjLmJ5dGVPZmZzZXQsCiAgICBjLmJ5dGVMZW5ndGgsCgogICAgcGsuYnVmZmVyLAogICAgcGsuYnl0ZU9mZnNldCwKICAgIHBrLmJ5dGVMZW5ndGgsCgogICAgc2suYnVmZmVyLAogICAgc2suYnl0ZU9mZnNldCwKICAgIHNrLmJ5dGVMZW5ndGgKICApCn0KCi8vIGNyeXB0b19zZWNyZXRib3gKCmV4cG9ydHMuY3J5cHRvX3NlY3JldGJveF9lYXN5ID0gZnVuY3Rpb24gKGMsIG0sIG4sIGspIHsKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoICsgYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X01BQ0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAnYyBtdXN0IGJlICJtLmJ5dGVMZW5ndGggKyBjcnlwdG9fc2VjcmV0Ym94X01BQ0JZVEVTIiBieXRlcycKICAgICkKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9lYXN5KGMsIG0sIG4sIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zZWNyZXRib3hfb3Blbl9lYXN5ID0gZnVuY3Rpb24gKG0sIGMsIG4sIGspIHsKICBpZiAobT8uYnl0ZUxlbmd0aCAhPT0gYy5ieXRlTGVuZ3RoIC0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X01BQ0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMgLSBjcnlwdG9fc2VjcmV0Ym94X01BQ0JZVEVTIiBieXRlcycpCiAgaWYgKGM/LmJ5dGVMZW5ndGggPCBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfTUFDQllURVMpIHRocm93IG5ldyBFcnJvcignYycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICByZXR1cm4gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X29wZW5fZWFzeShtLCBjLCBuLCBrKQp9CgpleHBvcnRzLmNyeXB0b19zZWNyZXRib3hfZGV0YWNoZWQgPSBmdW5jdGlvbiAoYywgbWFjLCBtLCBuLCBrKSB7CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYyBtdXN0ICJtLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobWFjPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfTUFDQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21hYycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfZGV0YWNoZWQoYywgbWFjLCBtLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2VjcmV0Ym94X29wZW5fZGV0YWNoZWQgPSBmdW5jdGlvbiAobSwgYywgbWFjLCBuLCBrKSB7CiAgaWYgKG0/LmJ5dGVMZW5ndGggIT09IGMuYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobWFjPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfTUFDQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21hYycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICByZXR1cm4gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X29wZW5fZGV0YWNoZWQobSwgYywgbWFjLCBuLCBrKQp9CgovLyBjcnlwdG9fZ2VuZXJpY2hhc2gKCmV4cG9ydHMuY3J5cHRvX2dlbmVyaWNoYXNoID0gZnVuY3Rpb24gKG91dHB1dCwgaW5wdXQsIGtleSA9IE9QVElPTkFMKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fZ2VuZXJpY2hhc2goCiAgICBvdXRwdXQuYnVmZmVyLAogICAgb3V0cHV0LmJ5dGVPZmZzZXQsCiAgICBvdXRwdXQuYnl0ZUxlbmd0aCwKCiAgICBpbnB1dC5idWZmZXIsCiAgICBpbnB1dC5ieXRlT2Zmc2V0LAogICAgaW5wdXQuYnl0ZUxlbmd0aCwKCiAgICBrZXkuYnVmZmVyLAogICAga2V5LmJ5dGVPZmZzZXQsCiAgICBrZXkuYnl0ZUxlbmd0aAogICkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoID0gZnVuY3Rpb24gKG91dHB1dCwgYmF0Y2gsIGtleSkgewogIGlmIChpc05vZGUgfHwgYmF0Y2gubGVuZ3RoIDwgNCkgewogICAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2goCiAgICAgIG91dHB1dCwKICAgICAgYmF0Y2gsCiAgICAgICEha2V5LAogICAgICBrZXkgfHwgT1BUSU9OQUwKICAgICkKICAgIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQogIH0gZWxzZSB7CiAgICBjb25zdCBzdGF0ZSA9IEJ1ZmZlci5hbGxvYyhiaW5kaW5nLmNyeXB0b19nZW5lcmljaGFzaF9TVEFURUJZVEVTKQoKICAgIGV4cG9ydHMuY3J5cHRvX2dlbmVyaWNoYXNoX2luaXQoc3RhdGUsIGtleSwgb3V0cHV0LmJ5dGVMZW5ndGgpCgogICAgZm9yIChjb25zdCBidWYgb2YgYmF0Y2gpIHsKICAgICAgZXhwb3J0cy5jcnlwdG9fZ2VuZXJpY2hhc2hfdXBkYXRlKHN0YXRlLCBidWYpCiAgICB9CgogICAgZXhwb3J0cy5jcnlwdG9fZ2VuZXJpY2hhc2hfZmluYWwoc3RhdGUsIG91dHB1dCkKICB9Cn0KCmV4cG9ydHMuY3J5cHRvX2dlbmVyaWNoYXNoX2tleWdlbiA9IGZ1bmN0aW9uIChrZXkpIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19nZW5lcmljaGFzaF9rZXlnZW4oCiAgICBrZXkuYnVmZmVyLAogICAga2V5LmJ5dGVPZmZzZXQsCiAgICBrZXkuYnl0ZUxlbmd0aAogICkKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fZ2VuZXJpY2hhc2hfaW5pdCA9IGZ1bmN0aW9uIChzdGF0ZSwga2V5LCBvdXRwdXRMZW5ndGgpIHsKICBrZXkgfHw9IE9QVElPTkFMCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2dlbmVyaWNoYXNoX2luaXQoCiAgICBzdGF0ZS5idWZmZXIsCiAgICBzdGF0ZS5ieXRlT2Zmc2V0LAogICAgc3RhdGUuYnl0ZUxlbmd0aCwKCiAgICBrZXkuYnVmZmVyLAogICAga2V5LmJ5dGVPZmZzZXQsCiAgICBrZXkuYnl0ZUxlbmd0aCwKCiAgICBvdXRwdXRMZW5ndGgKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19nZW5lcmljaGFzaF91cGRhdGUgPSBmdW5jdGlvbiAoc3RhdGUsIGlucHV0KSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fZ2VuZXJpY2hhc2hfdXBkYXRlKAogICAgc3RhdGUuYnVmZmVyLAogICAgc3RhdGUuYnl0ZU9mZnNldCwKICAgIHN0YXRlLmJ5dGVMZW5ndGgsCgogICAgaW5wdXQuYnVmZmVyLAogICAgaW5wdXQuYnl0ZU9mZnNldCwKICAgIGlucHV0LmJ5dGVMZW5ndGgKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19nZW5lcmljaGFzaF9maW5hbCA9IGZ1bmN0aW9uIChzdGF0ZSwgb3V0cHV0KSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fZ2VuZXJpY2hhc2hfZmluYWwoCiAgICBzdGF0ZS5idWZmZXIsCiAgICBzdGF0ZS5ieXRlT2Zmc2V0LAogICAgc3RhdGUuYnl0ZUxlbmd0aCwKCiAgICBvdXRwdXQuYnVmZmVyLAogICAgb3V0cHV0LmJ5dGVPZmZzZXQsCiAgICBvdXRwdXQuYnl0ZUxlbmd0aAogICkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCi8vIHNlY3JldHN0cmVhbQoKZXhwb3J0cy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X2tleWdlbiA9IGZ1bmN0aW9uIChrKSB7CiAgYmluZGluZy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X2tleWdlbigKICAgIGsuYnVmZmVyLAogICAgay5ieXRlT2Zmc2V0LAogICAgay5ieXRlTGVuZ3RoCiAgKQp9CgpleHBvcnRzLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfaW5pdF9wdXNoID0gZnVuY3Rpb24gKAogIHN0YXRlLAogIGhlYWRlciwKICBrCikgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9pbml0X3B1c2goCiAgICBzdGF0ZS5idWZmZXIsCiAgICBzdGF0ZS5ieXRlT2Zmc2V0LAogICAgc3RhdGUuYnl0ZUxlbmd0aCwKCiAgICBoZWFkZXIuYnVmZmVyLAogICAgaGVhZGVyLmJ5dGVPZmZzZXQsCiAgICBoZWFkZXIuYnl0ZUxlbmd0aCwKCiAgICBrLmJ1ZmZlciwKICAgIGsuYnl0ZU9mZnNldCwKICAgIGsuYnl0ZUxlbmd0aAogICkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9pbml0X3B1bGwgPSBmdW5jdGlvbiAoCiAgc3RhdGUsCiAgaGVhZGVyLAogIGsKKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X2luaXRfcHVsbCgKICAgIHN0YXRlLmJ1ZmZlciwKICAgIHN0YXRlLmJ5dGVPZmZzZXQsCiAgICBzdGF0ZS5ieXRlTGVuZ3RoLAoKICAgIGhlYWRlci5idWZmZXIsCiAgICBoZWFkZXIuYnl0ZU9mZnNldCwKICAgIGhlYWRlci5ieXRlTGVuZ3RoLAoKICAgIGsuYnVmZmVyLAogICAgay5ieXRlT2Zmc2V0LAogICAgay5ieXRlTGVuZ3RoCiAgKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3B1c2ggPSBmdW5jdGlvbiAoCiAgc3RhdGUsCiAgYywKICBtLAogIGFkLAogIHRhZwopIHsKICBhZCB8fD0gT1BUSU9OQUwKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3B1c2goCiAgICBzdGF0ZS5idWZmZXIsCiAgICBzdGF0ZS5ieXRlT2Zmc2V0LAogICAgc3RhdGUuYnl0ZUxlbmd0aCwKCiAgICBjLmJ1ZmZlciwKICAgIGMuYnl0ZU9mZnNldCwKICAgIGMuYnl0ZUxlbmd0aCwKCiAgICBtLmJ1ZmZlciwKICAgIG0uYnl0ZU9mZnNldCwKICAgIG0uYnl0ZUxlbmd0aCwKCiAgICBhZC5idWZmZXIsCiAgICBhZC5ieXRlT2Zmc2V0LAogICAgYWQuYnl0ZUxlbmd0aCwKCiAgICB0YWcKICApCgogIGlmIChyZXMgPCAwKSB0aHJvdyBuZXcgRXJyb3IoJ3B1c2ggZmFpbGVkJykKCiAgcmV0dXJuIHJlcwp9CgpleHBvcnRzLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfcHVsbCA9IGZ1bmN0aW9uICgKICBzdGF0ZSwKICBtLAogIHRhZywKICBjLAogIGFkCikgewogIGFkIHx8PSBPUFRJT05BTAoKICBpZiAoYz8uYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9BQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgY2lwaGVyIGxlbmd0aCcpCiAgaWYgKAogICAgbT8uYnl0ZUxlbmd0aCAhPT0KICAgIGMuYnl0ZUxlbmd0aCAtIGJpbmRpbmcuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9BQllURVMKICApCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgbWVzc2FnZSBsZW5ndGgnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfcHVsbCgKICAgIHN0YXRlLmJ1ZmZlciwKICAgIHN0YXRlLmJ5dGVPZmZzZXQsCiAgICBzdGF0ZS5ieXRlTGVuZ3RoLAoKICAgIG0uYnVmZmVyLAogICAgbS5ieXRlT2Zmc2V0LAogICAgbS5ieXRlTGVuZ3RoLAoKICAgIHRhZy5idWZmZXIsCiAgICB0YWcuYnl0ZU9mZnNldCwKICAgIHRhZy5ieXRlTGVuZ3RoLAoKICAgIGMuYnVmZmVyLAogICAgYy5ieXRlT2Zmc2V0LAogICAgYy5ieXRlTGVuZ3RoLAoKICAgIGFkLmJ1ZmZlciwKICAgIGFkLmJ5dGVPZmZzZXQsCiAgICBhZC5ieXRlTGVuZ3RoCiAgKQoKICBpZiAocmVzIDwgMCkgdGhyb3cgbmV3IEVycm9yKCdwdWxsIGZhaWxlZCcpCgogIHJldHVybiByZXMKfQoKZXhwb3J0cy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3Jla2V5ID0gZnVuY3Rpb24gKHN0YXRlKSB7CiAgYmluZGluZy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3Jla2V5KAogICAgc3RhdGUuYnVmZmVyLAogICAgc3RhdGUuYnl0ZU9mZnNldCwKICAgIHN0YXRlLmJ5dGVMZW5ndGgKICApCn0KCi8vIGNyeXB0b19zdHJlYW0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbSA9IGZ1bmN0aW9uIChjLCBuLCBrKSB7CiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9OT05DRUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbShjLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3hvciA9IGZ1bmN0aW9uIChjLCBtLCBuLCBrKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hvcigKICAgIGMuYnVmZmVyLAogICAgYy5ieXRlT2Zmc2V0LAogICAgYy5ieXRlTGVuZ3RoLAoKICAgIG0uYnVmZmVyLAogICAgbS5ieXRlT2Zmc2V0LAogICAgbS5ieXRlTGVuZ3RoLAoKICAgIG4uYnVmZmVyLAogICAgbi5ieXRlT2Zmc2V0LAogICAgbi5ieXRlTGVuZ3RoLAoKICAgIGsuYnVmZmVyLAogICAgay5ieXRlT2Zmc2V0LAogICAgay5ieXRlTGVuZ3RoCiAgKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwID0gZnVuY3Rpb24gKGMsIG4sIGspIHsKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjAoYywgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3IgPSBmdW5jdGlvbiAoYywgbSwgbiwgaykgewogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcihjLCBtLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl9pYyA9IGZ1bmN0aW9uIChjLCBtLCBuLCBpYywgaykgewogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl9pYyhjLCBtLCBuLCBpYywgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmID0gZnVuY3Rpb24gKGMsIG4sIGspIHsKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGYoYywgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvciA9IGZ1bmN0aW9uIChjLCBtLCBuLCBrKSB7CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yKGMsIG0sIG4sIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3JfaWMgPSBmdW5jdGlvbiAoYywgbSwgbiwgaWMsIGspIHsKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMuYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3JfaWMoYywgbSwgbiwgaWMsIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwID0gZnVuY3Rpb24gKGMsIG4sIGspIHsKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjAoYywgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yID0gZnVuY3Rpb24gKGMsIG0sIG4sIGspIHsKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMuYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3IoYywgbSwgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX2ljID0gZnVuY3Rpb24gKGMsIG0sIG4sIGljLCBrKSB7CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX2ljKGMsIG0sIG4sIGljLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3NhbHNhMjAgPSBmdW5jdGlvbiAoYywgbiwgaykgewogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMChjLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yID0gZnVuY3Rpb24gKGMsIG0sIG4sIGspIHsKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMuYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3IoYywgbSwgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl9pYyA9IGZ1bmN0aW9uIChjLCBtLCBuLCBpYywgaykgewogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl9pYyhjLCBtLCBuLCBpYywgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCi8vIGNyeXB0b19hdXRoCgpleHBvcnRzLmNyeXB0b19hdXRoID0gZnVuY3Rpb24gKG91dCwgaW5wdXQsIGspIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hdXRoX0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2F1dGhfS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2F1dGgob3V0LCBpbnB1dCwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2F1dGhfdmVyaWZ5ID0gZnVuY3Rpb24gKGgsIGlucHV0LCBrKSB7CiAgaWYgKGg/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2F1dGhfQllURVMpIHRocm93IG5ldyBFcnJvcignaCcpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2F1dGhfS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignaycpCgogIHJldHVybiBiaW5kaW5nLmNyeXB0b19hdXRoX3ZlcmlmeShoLCBpbnB1dCwgaykKfQoKLy8gY3J5cHRvX29uZXRpbWVhdXRoCgpleHBvcnRzLmNyeXB0b19vbmV0aW1lYXV0aCA9IGZ1bmN0aW9uIChvdXQsIGlucHV0LCBrKSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGgob3V0LCBpbnB1dCwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX29uZXRpbWVhdXRoX2luaXQgPSBmdW5jdGlvbiAoc3RhdGUsIGspIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX1NUQVRFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ2NyeXB0b19vbmV0aW1lYXV0aF9TVEFURUJZVEVTJyBieXRlcyIpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfaW5pdChzdGF0ZSwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX29uZXRpbWVhdXRoX3VwZGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgaW5wdXQpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX1NUQVRFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ2NyeXB0b19vbmV0aW1lYXV0aF9TVEFURUJZVEVTJyBieXRlcyIpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX3VwZGF0ZShzdGF0ZSwgaW5wdXQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19vbmV0aW1lYXV0aF9maW5hbCA9IGZ1bmN0aW9uIChzdGF0ZSwgb3V0KSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF9TVEFURUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fb25ldGltZWF1dGhfU1RBVEVCWVRFUycgYnl0ZXMiKQogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF9maW5hbChzdGF0ZSwgb3V0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fb25ldGltZWF1dGhfdmVyaWZ5ID0gZnVuY3Rpb24gKGgsIGlucHV0LCBrKSB7CiAgaWYgKGg/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2gnKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIHJldHVybiBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF92ZXJpZnkoaCwgaW5wdXQsIGspCn0KCi8vIGNyeXB0b19wd2hhc2gKCmV4cG9ydHMuY3J5cHRvX3B3aGFzaCA9IGZ1bmN0aW9uIChvdXQsIHBhc3N3ZCwgc2FsdCwgb3BzbGltaXQsIG1lbWxpbWl0LCBhbGcpIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoIDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX0JZVEVTX01JTikgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmIChvdXQ/LmJ5dGVMZW5ndGggPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfQllURVNfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKHNhbHQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9TQUxUQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NhbHQnKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChtZW1saW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChhbGcgPCAxIHx8IGFsZyA+IDIpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2FsZyBtdXN0IGJlIGVpdGhlciBBcmdvbjJpIDEuMyBvciBBcmdvbjJpZCAxLjMnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19wd2hhc2gob3V0LCBwYXNzd2QsIHNhbHQsIG9wc2xpbWl0LCBtZW1saW1pdCwgYWxnKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX2FzeW5jID0gZnVuY3Rpb24gKAogIG91dCwKICBwYXNzd2QsCiAgc2FsdCwKICBvcHNsaW1pdCwKICBtZW1saW1pdCwKICBhbGcsCiAgY2FsbGJhY2sgPSB1bmRlZmluZWQKKSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9CWVRFU19NSU4pIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAob3V0Py5ieXRlTGVuZ3RoID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX0JZVEVTX01BWCkgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmIChzYWx0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfU0FMVEJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzYWx0JykKICBpZiAob3BzbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfT1BTTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfT1BTTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAobWVtbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAoYWxnIDwgMSB8fCBhbGcgPiAyKQogICAgdGhyb3cgbmV3IEVycm9yKCdhbGcgbXVzdCBiZSBlaXRoZXIgQXJnb24yaSAxLjMgb3IgQXJnb24yaWQgMS4zJykKCiAgY29uc3QgW2RvbmUsIHByb21pc2VdID0gY2hlY2tTdGF0dXMoY2FsbGJhY2spCgogIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9hc3luYygKICAgIG91dC5idWZmZXIsCiAgICBvdXQuYnl0ZU9mZnNldCwKICAgIG91dC5ieXRlTGVuZ3RoLAoKICAgIHBhc3N3ZC5idWZmZXIsCiAgICBwYXNzd2QuYnl0ZU9mZnNldCwKICAgIHBhc3N3ZC5ieXRlTGVuZ3RoLAoKICAgIHNhbHQuYnVmZmVyLAogICAgc2FsdC5ieXRlT2Zmc2V0LAogICAgc2FsdC5ieXRlTGVuZ3RoLAoKICAgIG9wc2xpbWl0LAogICAgbWVtbGltaXQsCiAgICBhbGcsCgogICAgZG9uZQogICkKCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3N0ciA9IGZ1bmN0aW9uIChvdXQsIHBhc3N3ZCwgb3BzbGltaXQsIG1lbWxpbWl0KSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX1NUUkJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKHR5cGVvZiBvcHNsaW1pdCAhPT0gJ251bWJlcicpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmICh0eXBlb2YgbWVtbGltaXQgIT09ICdudW1iZXInKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fcHdoYXNoX3N0cihvdXQsIHBhc3N3ZCwgb3BzbGltaXQsIG1lbWxpbWl0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3N0cl9hc3luYyA9IGZ1bmN0aW9uICgKICBvdXQsCiAgcGFzc3dkLAogIG9wc2xpbWl0LAogIG1lbWxpbWl0LAogIGNhbGxiYWNrID0gdW5kZWZpbmVkCikgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9TVFJCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmICghcGFzc3dkPy5ieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ3Bhc3N3ZCcpCiAgaWYgKHR5cGVvZiBvcHNsaW1pdCAhPT0gJ251bWJlcicpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmICh0eXBlb2YgbWVtbGltaXQgIT09ICdudW1iZXInKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKCiAgY29uc3QgW2RvbmUsIHByb21pc2VdID0gY2hlY2tTdGF0dXMoY2FsbGJhY2spCgogIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zdHJfYXN5bmMoCiAgICBvdXQuYnVmZmVyLAogICAgb3V0LmJ5dGVPZmZzZXQsCiAgICBvdXQuYnl0ZUxlbmd0aCwKCiAgICBwYXNzd2QuYnVmZmVyLAogICAgcGFzc3dkLmJ5dGVPZmZzZXQsCiAgICBwYXNzd2QuYnl0ZUxlbmd0aCwKCiAgICBvcHNsaW1pdCwKICAgIG1lbWxpbWl0LAoKICAgIGRvbmUKICApCgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zdHJfdmVyaWZ5ID0gZnVuY3Rpb24gKHN0ciwgcGFzc3dkKSB7CiAgaWYgKHN0cj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX1NUUkJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3N0cicpCgogIHJldHVybiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc3RyX3ZlcmlmeShzdHIsIHBhc3N3ZCkKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3N0cl92ZXJpZnlfYXN5bmMgPSBmdW5jdGlvbiAoCiAgc3RyLAogIHBhc3N3ZCwKICBjYWxsYmFjayA9IHVuZGVmaW5lZAopIHsKICBpZiAoc3RyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfU1RSQllURVMpIHRocm93IG5ldyBFcnJvcignc3RyJykKICBpZiAoIXBhc3N3ZD8uYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdwYXNzd2QnKQoKICBjb25zdCBbZG9uZSwgcHJvbWlzZV0gPSBjaGVja1N0YXR1cyhjYWxsYmFjaywgdHJ1ZSkKCiAgYmluZGluZy5jcnlwdG9fcHdoYXNoX3N0cl92ZXJpZnlfYXN5bmMoCiAgICBzdHIuYnVmZmVyLAogICAgc3RyLmJ5dGVPZmZzZXQsCiAgICBzdHIuYnl0ZUxlbmd0aCwKCiAgICBwYXNzd2QuYnVmZmVyLAogICAgcGFzc3dkLmJ5dGVPZmZzZXQsCiAgICBwYXNzd2QuYnl0ZUxlbmd0aCwKCiAgICBkb25lCiAgKQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc3RyX25lZWRzX3JlaGFzaCA9IGZ1bmN0aW9uIChzdHIsIG9wc2xpbWl0LCBtZW1saW1pdCkgewogIGlmIChzdHI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9TVFJCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdzdHInKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChtZW1saW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQoKICByZXR1cm4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3N0cl9uZWVkc19yZWhhc2goc3RyLCBvcHNsaW1pdCwgbWVtbGltaXQpCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1NiA9IGZ1bmN0aW9uICgKICBvdXQsCiAgcGFzc3dkLAogIHNhbHQsCiAgb3BzbGltaXQsCiAgbWVtbGltaXQKKSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9CWVRFU19NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKG91dD8uYnl0ZUxlbmd0aCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9CWVRFU19NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKHNhbHQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9TQUxUQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NhbHQnKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9PUFNMSU1JVF9NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfT1BTTElNSVRfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG1lbWxpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X01FTUxJTUlUX01JTikKICAgIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9NRU1MSU1JVF9NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2KAogICAgb3V0LAogICAgcGFzc3dkLAogICAgc2FsdCwKICAgIG9wc2xpbWl0LAogICAgbWVtbGltaXQKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfYXN5bmMgPSBmdW5jdGlvbiAoCiAgb3V0LAogIHBhc3N3ZCwKICBzYWx0LAogIG9wc2xpbWl0LAogIG1lbWxpbWl0LAogIGNhbGxiYWNrID0gdW5kZWZpbmVkCikgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfQllURVNfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmIChvdXQ/LmJ5dGVMZW5ndGggPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfQllURVNfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmICghcGFzc3dkPy5ieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ3Bhc3N3ZCcpCiAgaWYgKHNhbHQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9TQUxUQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NhbHQnKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9PUFNMSU1JVF9NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfT1BTTElNSVRfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG1lbWxpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X01FTUxJTUlUX01JTikKICAgIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9NRU1MSU1JVF9NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKCiAgY29uc3QgW2RvbmUsIHByb21pc2VdID0gY2hlY2tTdGF0dXMoY2FsbGJhY2spCgogIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9hc3luYygKICAgIG91dC5idWZmZXIsCiAgICBvdXQuYnl0ZU9mZnNldCwKICAgIG91dC5ieXRlTGVuZ3RoLAoKICAgIHBhc3N3ZC5idWZmZXIsCiAgICBwYXNzd2QuYnl0ZU9mZnNldCwKICAgIHBhc3N3ZC5ieXRlTGVuZ3RoLAoKICAgIHNhbHQuYnVmZmVyLAogICAgc2FsdC5ieXRlT2Zmc2V0LAogICAgc2FsdC5ieXRlTGVuZ3RoLAoKICAgIG9wc2xpbWl0LAogICAgbWVtbGltaXQsCgogICAgZG9uZQogICkKCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X3N0cl9hc3luYyA9IGZ1bmN0aW9uICgKICBvdXQsCiAgcGFzc3dkLAogIG9wc2xpbWl0LAogIG1lbWxpbWl0LAogIGNhbGxiYWNrID0gdW5kZWZpbmVkCikgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9TVFJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoIXBhc3N3ZD8uYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdwYXNzd2QnKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9PUFNMSU1JVF9NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfT1BTTElNSVRfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG1lbWxpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X01FTUxJTUlUX01JTikKICAgIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9NRU1MSU1JVF9NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKCiAgY29uc3QgW2RvbmUsIHByb21pc2VdID0gY2hlY2tTdGF0dXMoY2FsbGJhY2spCgogIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHJfYXN5bmMoCiAgICBvdXQuYnVmZmVyLAogICAgb3V0LmJ5dGVPZmZzZXQsCiAgICBvdXQuYnl0ZUxlbmd0aCwKCiAgICBwYXNzd2QuYnVmZmVyLAogICAgcGFzc3dkLmJ5dGVPZmZzZXQsCiAgICBwYXNzd2QuYnl0ZUxlbmd0aCwKCiAgICBvcHNsaW1pdCwKICAgIG1lbWxpbWl0LAoKICAgIGRvbmUKICApCgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHIgPSBmdW5jdGlvbiAoCiAgb3V0LAogIHBhc3N3ZCwKICBvcHNsaW1pdCwKICBtZW1saW1pdAopIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfU1RSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKCFwYXNzd2Q/LmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcigncGFzc3dkJykKICBpZiAob3BzbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfT1BTTElNSVRfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG9wc2xpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X09QU0xJTUlUX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChtZW1saW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9NRU1MSU1JVF9NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfTUVNTElNSVRfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHIoCiAgICBvdXQsCiAgICBwYXNzd2QsCiAgICBvcHNsaW1pdCwKICAgIG1lbWxpbWl0CiAgKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X3N0cl92ZXJpZnlfYXN5bmMgPSBmdW5jdGlvbiAoCiAgc3RyLAogIHBhc3N3ZCwKICBjYWxsYmFjayA9IHVuZGVmaW5lZAopIHsKICBpZiAoc3RyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfU1RSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3N0cicpCiAgaWYgKCFwYXNzd2Q/LmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcigncGFzc3dkJykKCiAgY29uc3QgW2RvbmUsIHByb21pc2VdID0gY2hlY2tTdGF0dXMoY2FsbGJhY2ssIHRydWUpCgogIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHJfdmVyaWZ5X2FzeW5jKAogICAgc3RyLmJ1ZmZlciwKICAgIHN0ci5ieXRlT2Zmc2V0LAogICAgc3RyLmJ5dGVMZW5ndGgsCgogICAgcGFzc3dkLmJ1ZmZlciwKICAgIHBhc3N3ZC5ieXRlT2Zmc2V0LAogICAgcGFzc3dkLmJ5dGVMZW5ndGgsCgogICAgZG9uZQogICkKCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X3N0cl92ZXJpZnkgPSBmdW5jdGlvbiAoc3RyLCBwYXNzd2QpIHsKICBpZiAoc3RyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfU1RSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3N0cicpCiAgaWYgKCFwYXNzd2Q/LmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcigncGFzc3dkJykKCiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHJfdmVyaWZ5KHN0ciwgcGFzc3dkKQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfc3RyX25lZWRzX3JlaGFzaCA9IGZ1bmN0aW9uICgKICBzdHIsCiAgb3BzbGltaXQsCiAgbWVtbGltaXQKKSB7CiAgaWYgKHN0cj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X1NUUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzdHInKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChtZW1saW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQoKICByZXR1cm4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X3N0cl9uZWVkc19yZWhhc2goCiAgICBzdHIsCiAgICBvcHNsaW1pdCwKICAgIG1lbWxpbWl0CiAgKQp9CgovLyBjcnlwdG9fa3gKCmV4cG9ydHMuY3J5cHRvX2t4X2tleXBhaXIgPSBmdW5jdGlvbiAocGssIHNrKSB7CiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9QVUJMSUNLRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdwaycpCiAgaWYgKHNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9TRUNSRVRLRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdzaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2t4X2tleXBhaXIocGssIHNrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fa3hfc2VlZF9rZXlwYWlyID0gZnVuY3Rpb24gKHBrLCBzaywgc2VlZCkgewogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfUFVCTElDS0VZQllURVMpIHRocm93IG5ldyBFcnJvcigncGsnKQogIGlmIChzaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfU0VDUkVUS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignc2snKQogIGlmIChzZWVkPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9TRUVEQllURVMpIHRocm93IG5ldyBFcnJvcignc2VlZCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2t4X3NlZWRfa2V5cGFpcihwaywgc2ssIHNlZWQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19reF9jbGllbnRfc2Vzc2lvbl9rZXlzID0gZnVuY3Rpb24gKAogIHJ4LAogIHR4LAogIGNsaWVudFBrLAogIGNsaWVudFNrLAogIHNlcnZlclBrCikgewogIC8vIG1hdGNoIGBzdGQ6Om9wdGlvbmFsYCBieSBjb2VyY2luZyBudWxsIHRvIHVuZGVmaW5lZAogIHJ4ID8/PSB1bmRlZmluZWQKICB0eCA/Pz0gdW5kZWZpbmVkCgogIGlmICghcnggJiYgIXR4KSB0aHJvdyBuZXcgRXJyb3IoJ2F0IGxlYXN0IG9uZSBzZXNzaW9uIGtleSBtdXN0IGJlIHNwZWNpZmllZCcpCgogIGlmIChyeCkgewogICAgaWYgKHJ4Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9TRVNTSU9OS0VZQllURVMpCiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAncmVjZWl2aW5nIGtleSBidWZmZXIgbXVzdCBiZSAiY3J5cHRvX2t4X1NFU1NJT05LRVlCWVRFUyIgYnl0ZXMgb3IgbnVsbCcKICAgICAgKQogIH0gZWxzZSB7CiAgICBpZiAodHg/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1NFU1NJT05LRVlCWVRFUykKICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICd0cmFuc21pdHRpbmcga2V5IGJ1ZmZlciBtdXN0IGJlICJjcnlwdG9fa3hfU0VTU0lPTktFWUJZVEVTIiBieXRlcyBvciBudWxsJwogICAgICApCiAgfQoKICBpZiAoY2xpZW50UGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdjbGllbnRfcGsnKQogIGlmIChjbGllbnRTaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfU0VDUkVUS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NsaWVudF9zaycpCiAgaWYgKHNlcnZlclBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2VydmVyX3BrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fa3hfY2xpZW50X3Nlc3Npb25fa2V5cygKICAgIHJ4LAogICAgdHgsCiAgICBjbGllbnRQaywKICAgIGNsaWVudFNrLAogICAgc2VydmVyUGsKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19reF9zZXJ2ZXJfc2Vzc2lvbl9rZXlzID0gZnVuY3Rpb24gKAogIHJ4LAogIHR4LAogIHNlcnZlclBrLAogIHNlcnZlclNrLAogIGNsaWVudFBrCikgewogIHJ4ID8/PSB1bmRlZmluZWQKICB0eCA/Pz0gdW5kZWZpbmVkCgogIGlmICghcnggJiYgIXR4KSB0aHJvdyBuZXcgRXJyb3IoJ2F0IGxlYXN0IG9uZSBzZXNzaW9uIGtleSBtdXN0IGJlIHNwZWNpZmllZCcpCgogIGlmIChyeCkgewogICAgaWYgKHJ4Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9TRVNTSU9OS0VZQllURVMpCiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAncmVjZWl2aW5nIGtleSBidWZmZXIgbXVzdCBiZSAiY3J5cHRvX2t4X1NFU1NJT05LRVlCWVRFUyIgYnl0ZXMgb3IgbnVsbCcKICAgICAgKQogIH0gZWxzZSB7CiAgICBpZiAodHg/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1NFU1NJT05LRVlCWVRFUykKICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICd0cmFuc21pdHRpbmcga2V5IGJ1ZmZlciBtdXN0IGJlICJjcnlwdG9fa3hfU0VTU0lPTktFWUJZVEVTIiBieXRlcyBvciBudWxsJwogICAgICApCiAgfQoKICBpZiAoc2VydmVyUGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzZXJ2ZXJfcGsnKQogIGlmIChzZXJ2ZXJTaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfU0VDUkVUS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NlcnZlcl9zaycpCiAgaWYgKGNsaWVudFBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignY2xpZW50X3BrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fa3hfc2VydmVyX3Nlc3Npb25fa2V5cygKICAgIHJ4LAogICAgdHgsCiAgICBzZXJ2ZXJQaywKICAgIHNlcnZlclNrLAogICAgY2xpZW50UGsKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgovLyBjcnlwdG9fc2NhbGFybXVsdAoKZXhwb3J0cy5jcnlwdG9fc2NhbGFybXVsdF9iYXNlID0gZnVuY3Rpb24gKHEsIG4pIHsKICBpZiAocT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdxJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfYmFzZShxLCBuKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2NhbGFybXVsdCA9IGZ1bmN0aW9uIChxLCBuLCBwKSB7CiAgaWYgKHE/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfQllURVMpIHRocm93IG5ldyBFcnJvcigncScpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChwPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3AnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0KHEsIG4sIHApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfYmFzZSA9IGZ1bmN0aW9uIChxLCBuKSB7CiAgaWYgKHE/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncScpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9iYXNlKHEsIG4pCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTkgPSBmdW5jdGlvbiAocSwgbiwgcCkgewogIGlmIChxPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3EnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChwPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3AnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTkocSwgbiwgcCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9pc192YWxpZF9wb2ludCA9IGZ1bmN0aW9uIChwKSB7CiAgaWYgKHA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdwJykKCiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9pc192YWxpZF9wb2ludChwKQp9CgpleHBvcnRzLmNyeXB0b19jb3JlX2VkMjU1MTlfZnJvbV91bmlmb3JtID0gZnVuY3Rpb24gKHAsIHIpIHsKICBpZiAocD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3AnKQogIGlmIChyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfVU5JRk9STUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdyJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X2Zyb21fdW5pZm9ybShwLCByKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X2Jhc2Vfbm9jbGFtcCA9IGZ1bmN0aW9uIChxLCBuKSB7CiAgaWYgKHE/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncScpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9iYXNlX25vY2xhbXAocSwgbikKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9ub2NsYW1wID0gZnVuY3Rpb24gKHEsIG4sIHApIHsKICBpZiAocT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdxJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAocD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X25vY2xhbXAocSwgbiwgcCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCi8vIGNyeXB0b19jb3JlCgpleHBvcnRzLmNyeXB0b19jb3JlX2VkMjU1MTlfYWRkID0gZnVuY3Rpb24gKHIsIHAsIHEpIHsKICBpZiAocj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3InKQogIGlmIChwPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfQllURVMpIHRocm93IG5ldyBFcnJvcigncCcpCiAgaWYgKHE/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdxJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X2FkZChyLCBwLCBxKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X3N1YiA9IGZ1bmN0aW9uIChyLCBwLCBxKSB7CiAgaWYgKHI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdyJykKICBpZiAocD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3AnKQogIGlmIChxPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfQllURVMpIHRocm93IG5ldyBFcnJvcigncScpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9zdWIociwgcCwgcSkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfcmFuZG9tID0gZnVuY3Rpb24gKHIpIHsKICBpZiAocj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdyJykKCiAgYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9yYW5kb20ocikKfQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9yZWR1Y2UgPSBmdW5jdGlvbiAociwgcykgewogIGlmIChyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3InKQogIGlmIChzPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfTk9OUkVEVUNFRFNDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzJykKCiAgYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9yZWR1Y2UociwgcykKfQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9pbnZlcnQgPSBmdW5jdGlvbiAocmVjaXAsIHMpIHsKICBpZiAocmVjaXA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncmVjaXAnKQogIGlmIChzPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3MnKQoKICBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX2ludmVydChyZWNpcCwgcykKfQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9uZWdhdGUgPSBmdW5jdGlvbiAobmVnLCBzKSB7CiAgaWYgKG5lZz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduZWcnKQogIGlmIChzPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3MnKQoKICBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX25lZ2F0ZShuZWcsIHMpCn0KCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfY29tcGxlbWVudCA9IGZ1bmN0aW9uIChjb21wLCBzKSB7CiAgaWYgKGNvbXA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignY29tcCcpCiAgaWYgKHM/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncycpCgogIGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfY29tcGxlbWVudChjb21wLCBzKQp9CgpleHBvcnRzLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX2FkZCA9IGZ1bmN0aW9uICh6LCB4LCB5KSB7CiAgaWYgKHo/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigneicpCiAgaWYgKHg/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigneCcpCiAgaWYgKHk/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigneScpCgogIGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfYWRkKHosIHgsIHkpCn0KCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfc3ViID0gZnVuY3Rpb24gKHosIHgsIHkpIHsKICBpZiAoej8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd6JykKICBpZiAoeD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd4JykKICBpZiAoeT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd5JykKCiAgYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9zdWIoeiwgeCwgeSkKfQoKLy8gY3J5cHRvX3Nob3J0aGFzaAoKZXhwb3J0cy5jcnlwdG9fc2hvcnRoYXNoID0gZnVuY3Rpb24gKG91dCwgaW5wdXQsIGspIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaG9ydGhhc2hfQllURVMpIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2hvcnRoYXNoX0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zaG9ydGhhc2gob3V0LCBpbnB1dCwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCi8vIGNyeXB0b19rZGYKCmV4cG9ydHMuY3J5cHRvX2tkZl9rZXlnZW4gPSBmdW5jdGlvbiAoa2V5KSB7CiAgaWYgKGtleT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa2RmX0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2tleScpCgogIGJpbmRpbmcuY3J5cHRvX2tkZl9rZXlnZW4oa2V5KQp9CgpleHBvcnRzLmNyeXB0b19rZGZfZGVyaXZlX2Zyb21fa2V5ID0gZnVuY3Rpb24gKHN1YmtleSwgc3Via2V5SWQsIGN0eCwga2V5KSB7CiAgaWYgKHN1YmtleT8uYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY3J5cHRvX2tkZl9CWVRFU19NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3N1YmtleScpCiAgaWYgKHN1YmtleT8uYnl0ZUxlbmd0aCA+IGJpbmRpbmcuY3J5cHRvX2tkZl9CWVRFU19NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3N1YmtleScpCiAgaWYgKGN0eD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa2RmX0NPTlRFWFRCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignY3R4JykKICBpZiAoa2V5Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19rZGZfS0VZQllURVMpIHRocm93IG5ldyBFcnJvcigna2V5JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fa2RmX2Rlcml2ZV9mcm9tX2tleShzdWJrZXksIHN1YmtleUlkLCBjdHgsIGtleSkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCi8vIGNyeXB0b19oYXNoCgpleHBvcnRzLmNyeXB0b19oYXNoID0gZnVuY3Rpb24gKG91dCwgaW5wdXQpIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2hhc2gob3V0LCBpbnB1dCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2hhc2hfc2hhMjU2ID0gZnVuY3Rpb24gKG91dCwgaW5wdXQpIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTI1Nl9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignb3V0JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9faGFzaF9zaGEyNTYob3V0LCBpbnB1dCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2hhc2hfc2hhMjU2X2luaXQgPSBmdW5jdGlvbiAoc3RhdGUpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhMjU2X1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnY3J5cHRvX2hhc2hfc2hhMjU2X1NUQVRFQllURVMnIGJ5dGVzIikKICB9CgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhMjU2X2luaXQoc3RhdGUpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19oYXNoX3NoYTI1Nl91cGRhdGUgPSBmdW5jdGlvbiAoc3RhdGUsIGlucHV0KSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTI1Nl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ2NyeXB0b19oYXNoX3NoYTI1Nl9TVEFURUJZVEVTJyBieXRlcyIpCiAgfQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTI1Nl91cGRhdGUoc3RhdGUsIGlucHV0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9faGFzaF9zaGEyNTZfZmluYWwgPSBmdW5jdGlvbiAoc3RhdGUsIG91dCkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9faGFzaF9zaGEyNTZfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdjcnlwdG9faGFzaF9zaGEyNTZfU1RBVEVCWVRFUycgYnl0ZXMiKQogIH0KICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTI1Nl9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc3RhdGUnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTI1Nl9maW5hbChzdGF0ZSwgb3V0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9faGFzaF9zaGE1MTIgPSBmdW5jdGlvbiAob3V0LCBpbnB1dCkgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhNTEyX0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTUxMihvdXQsIGlucHV0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9faGFzaF9zaGE1MTJfaW5pdCA9IGZ1bmN0aW9uIChzdGF0ZSkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9faGFzaF9zaGE1MTJfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdjcnlwdG9faGFzaF9zaGE1MTJfU1RBVEVCWVRFUycgYnl0ZXMiKQogIH0KCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9faGFzaF9zaGE1MTJfaW5pdChzdGF0ZSkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2hhc2hfc2hhNTEyX3VwZGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgaW5wdXQpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhNTEyX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnY3J5cHRvX2hhc2hfc2hhNTEyX1NUQVRFQllURVMnIGJ5dGVzIikKICB9CgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhNTEyX3VwZGF0ZShzdGF0ZSwgaW5wdXQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19oYXNoX3NoYTUxMl9maW5hbCA9IGZ1bmN0aW9uIChzdGF0ZSwgb3V0KSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTUxMl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ2NyeXB0b19oYXNoX3NoYTUxMl9TVEFURUJZVEVTJyBieXRlcyIpCiAgfQogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhNTEyX0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTUxMl9maW5hbChzdGF0ZSwgb3V0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKLy8gY3J5cHRvX2FlYWQKCmV4cG9ydHMuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9rZXlnZW4gPSBmdW5jdGlvbiAoaykgewogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfa2V5Z2VuKGspCn0KCmV4cG9ydHMuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0ID0gZnVuY3Rpb24gKAogIGMsCiAgbSwKICBhZCwKICBuc2VjID0gbnVsbCwKICBucHViLAogIGsKKSB7CiAgYWQgPz89IHVuZGVmaW5lZAogIGlmIChuc2VjICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ25zZWMgbXVzdCBhbHdheXMgYmUgc2V0IHRvIG51bGwnKQogIGlmICgKICAgIGM/LmJ5dGVMZW5ndGggIT09CiAgICBtLmJ5dGVMZW5ndGggKyBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTCiAgKQogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAnYyBtdXN0ICJtLmJ5dGVMZW5ndGggKyBjcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUyIgYnl0ZXMnCiAgICApCiAgaWYgKGM/LmJ5dGVMZW5ndGggPiAweGZmZmZmZmZmKQogICAgdGhyb3cgbmV3IEVycm9yKCdjLmJ5dGVMZW5ndGggbXVzdCBiZSBhIDMyYml0IGludGVnZXInKQogIGlmIChucHViPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfTlBVQkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCducHViJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX2VuY3J5cHQoCiAgICBjLAogICAgbSwKICAgIGFkLAogICAgbnB1YiwKICAgIGsKICApCiAgaWYgKHJlcyA8IDApIHRocm93IG5ldyBFcnJvcignY291bGQgbm90IGVuY3J5cHQgZGF0YScpCgogIHJldHVybiByZXMKfQoKZXhwb3J0cy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHQgPSBmdW5jdGlvbiAoCiAgbSwKICBuc2VjID0gbnVsbCwKICBjLAogIGFkLAogIG5wdWIsCiAgawopIHsKICBhZCA/Pz0gdW5kZWZpbmVkCiAgaWYgKG5zZWMgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignbnNlYyBtdXN0IGFsd2F5cyBiZSBzZXQgdG8gbnVsbCcpCiAgaWYgKAogICAgbT8uYnl0ZUxlbmd0aCAhPT0KICAgIGMuYnl0ZUxlbmd0aCAtIGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMKICApCiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICdtIG11c3QgImMuYnl0ZUxlbmd0aCAtIGNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTIiBieXRlcycKICAgICkKICBpZiAobT8uYnl0ZUxlbmd0aCA+IDB4ZmZmZmZmZmYpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20uYnl0ZUxlbmd0aCBtdXN0IGJlIGEgMzJiaXQgaW50ZWdlcicpCiAgaWYgKG5wdWI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ25wdWInKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfZGVjcnlwdCgKICAgIG0sCiAgICBjLAogICAgYWQsCiAgICBucHViLAogICAgawogICkKICBpZiAocmVzIDwgMCkgdGhyb3cgbmV3IEVycm9yKCdjb3VsZCBub3QgdmVyaWZ5IGRhdGEnKQoKICByZXR1cm4gcmVzCn0KCmV4cG9ydHMuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0X2RldGFjaGVkID0gZnVuY3Rpb24gKAogIGMsCiAgbWFjLAogIG0sCiAgYWQsCiAgbnNlYyA9IG51bGwsCiAgbnB1YiwKICBrCikgewogIGFkID8/PSB1bmRlZmluZWQKICBpZiAobnNlYyAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCduc2VjIG11c3QgYWx3YXlzIGJlIHNldCB0byBudWxsJykKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdjIG11c3QgYmUgIm0uYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChtYWM/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21hYycpCiAgaWYgKG5wdWI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ25wdWInKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfZW5jcnlwdF9kZXRhY2hlZCgKICAgIGMsCiAgICBtYWMsCiAgICBtLAogICAgYWQsCiAgICBucHViLAogICAgawogICkKICBpZiAocmVzIDwgMCkgdGhyb3cgbmV3IEVycm9yKCdjb3VsZCBub3QgZW5jcnlwdCBkYXRhJykKCiAgcmV0dXJuIHJlcwp9CgpleHBvcnRzLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfZGVjcnlwdF9kZXRhY2hlZCA9IGZ1bmN0aW9uICgKICBtLAogIG5zZWMgPSBudWxsLAogIGMsCiAgbWFjLAogIGFkLAogIG5wdWIsCiAgawopIHsKICBhZCA/Pz0gdW5kZWZpbmVkCiAgaWYgKG5zZWMgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignbnNlYyBtdXN0IGFsd2F5cyBiZSBzZXQgdG8gbnVsbCcpCiAgaWYgKG0/LmJ5dGVMZW5ndGggIT09IGMuYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobWFjPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdtYWMnKQogIGlmIChucHViPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfTlBVQkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCducHViJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHRfZGV0YWNoZWQoCiAgICBtLAogICAgYywKICAgIG1hYywKICAgIGFkLAogICAgbnB1YiwKICAgIGsKICApCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdjb3VsZCBub3QgdmVyaWZ5IGRhdGEnKQp9CgpleHBvcnRzLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9rZXlnZW4gPSBmdW5jdGlvbiAoaykgewogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2tleWdlbihrKQp9CgpleHBvcnRzLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0ID0gZnVuY3Rpb24gKAogIGMsCiAgbSwKICBhZCwKICBuc2VjID0gbnVsbCwKICBucHViLAogIGsKKSB7CiAgYWQgPz89IHVuZGVmaW5lZAogIGlmIChuc2VjICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ25zZWMgbXVzdCBhbHdheXMgYmUgc2V0IHRvIG51bGwnKQogIGlmICgKICAgIGM/LmJ5dGVMZW5ndGggIT09CiAgICBtLmJ5dGVMZW5ndGggKyBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMKICApCiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICdjIG11c3QgIm0uYnl0ZUxlbmd0aCArIGNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMiIGJ5dGVzJwogICAgKQogIGlmIChjPy5ieXRlTGVuZ3RoID4gMHhmZmZmZmZmZikKICAgIHRocm93IG5ldyBFcnJvcignYy5ieXRlTGVuZ3RoIG11c3QgYmUgYSAzMmJpdCBpbnRlZ2VyJykKICBpZiAobnB1Yj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfTlBVQkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCducHViJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0KAogICAgYywKICAgIG0sCiAgICBhZCwKICAgIG5wdWIsCiAgICBrCiAgKQogIGlmIChyZXMgPCAwKSB0aHJvdyBuZXcgRXJyb3IoJ2NvdWxkIG5vdCBlbmNyeXB0IGRhdGEnKQoKICByZXR1cm4gcmVzCn0KCmV4cG9ydHMuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHQgPSBmdW5jdGlvbiAoCiAgbSwKICBuc2VjID0gbnVsbCwKICBjLAogIGFkLAogIG5wdWIsCiAgawopIHsKICBhZCA/Pz0gdW5kZWZpbmVkCiAgaWYgKG5zZWMgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignbnNlYyBtdXN0IGFsd2F5cyBiZSBzZXQgdG8gbnVsbCcpCiAgaWYgKAogICAgbT8uYnl0ZUxlbmd0aCAhPT0KICAgIGMuYnl0ZUxlbmd0aCAtIGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUwogICkKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgJ20gbXVzdCAiYy5ieXRlTGVuZ3RoIC0gY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUyIgYnl0ZXMnCiAgICApCiAgaWYgKG0/LmJ5dGVMZW5ndGggPiAweGZmZmZmZmZmKQogICAgdGhyb3cgbmV3IEVycm9yKCdtLmJ5dGVMZW5ndGggbXVzdCBiZSBhIDMyYml0IGludGVnZXInKQogIGlmIChucHViPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ25wdWInKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHQoCiAgICBtLAogICAgYywKICAgIGFkLAogICAgbnB1YiwKICAgIGsKICApCiAgaWYgKHJlcyA8IDApIHRocm93IG5ldyBFcnJvcignY291bGQgbm90IHZlcmlmeSBkYXRhJykKCiAgcmV0dXJuIHJlcwp9CgpleHBvcnRzLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0X2RldGFjaGVkID0gZnVuY3Rpb24gKAogIGMsCiAgbWFjLAogIG0sCiAgYWQsCiAgbnNlYyA9IG51bGwsCiAgbnB1YiwKICBrCikgewogIGFkID8/PSB1bmRlZmluZWQKICBpZiAobnNlYyAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCduc2VjIG11c3QgYWx3YXlzIGJlIHNldCB0byBudWxsJykKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdjIG11c3QgYmUgIm0uYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChtYWM/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbWFjJykKICBpZiAobnB1Yj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfTlBVQkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCducHViJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0X2RldGFjaGVkKAogICAgYywKICAgIG1hYywKICAgIG0sCiAgICBhZCwKICAgIG5wdWIsCiAgICBrCiAgKQogIGlmIChyZXMgPCAwKSB0aHJvdyBuZXcgRXJyb3IoJ2NvdWxkIG5vdCBlbmNyeXB0IGRhdGEnKQoKICByZXR1cm4gcmVzCn0KCmV4cG9ydHMuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHRfZGV0YWNoZWQgPSBmdW5jdGlvbiAoCiAgbSwKICBuc2VjID0gbnVsbCwKICBjLAogIG1hYywKICBhZCwKICBucHViLAogIGsKKSB7CiAgYWQgPz89IHVuZGVmaW5lZAogIGlmIChuc2VjICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ25zZWMgbXVzdCBhbHdheXMgYmUgc2V0IHRvIG51bGwnKQogIGlmIChtPy5ieXRlTGVuZ3RoICE9PSBjLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG1hYz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdtYWMnKQogIGlmIChucHViPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ25wdWInKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHRfZGV0YWNoZWQoCiAgICBtLAogICAgYywKICAgIG1hYywKICAgIGFkLAogICAgbnB1YiwKICAgIGsKICApCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdjb3VsZCBub3QgdmVyaWZ5IGRhdGEnKQp9CgovLyBjcnlwdG9fc3RyZWFtCgpleHBvcnRzLmNyeXB0b19zdHJlYW1feG9yX3dyYXBfaW5pdCA9IGZ1bmN0aW9uIChzdGF0ZSwgbiwgaykgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5zbl9jcnlwdG9fc3RyZWFtX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ3NuX2NyeXB0b19zdHJlYW1feG9yX1NUQVRFQllURVMnIGJ5dGVzIikKICB9CiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9OT05DRUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignaycpCgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94b3Jfd3JhcF9pbml0KHN0YXRlLCBuLCBrKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1feG9yX3dyYXBfdXBkYXRlID0gZnVuY3Rpb24gKHN0YXRlLCBjLCBtKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLnNuX2NyeXB0b19zdHJlYW1feG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnc25fY3J5cHRvX3N0cmVhbV94b3JfU1RBVEVCWVRFUycgYnl0ZXMiKQogIH0KICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdjIG11c3QgYmUgIm0uYnl0ZUxlbmd0aCIgYnl0ZXMnKQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1feG9yX3dyYXBfdXBkYXRlKHN0YXRlLCBjLCBtKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1feG9yX3dyYXBfZmluYWwgPSBmdW5jdGlvbiAoc3RhdGUpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuc25fY3J5cHRvX3N0cmVhbV94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdzbl9jcnlwdG9fc3RyZWFtX3hvcl9TVEFURUJZVEVTJyBieXRlcyIpCiAgfQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1feG9yX3dyYXBfZmluYWwoc3RhdGUpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3Jfd3JhcF9pbml0ID0gZnVuY3Rpb24gKHN0YXRlLCBuLCBrKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX3dyYXBfaW5pdChzdGF0ZSwgbiwgaykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl93cmFwX3VwZGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgYywgbSkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYyBtdXN0IGJlICJtLmJ5dGVMZW5ndGgiIGJ5dGVzJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl93cmFwX3VwZGF0ZShzdGF0ZSwgYywgbSkKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl93cmFwX2ZpbmFsID0gZnVuY3Rpb24gKHN0YXRlKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl93cmFwX2ZpbmFsKHN0YXRlKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3Jfd3JhcF9pbml0ID0gZnVuY3Rpb24gKHN0YXRlLCBuLCBrKSB7CiAgaWYgKAogICAgc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl9TVEFURUJZVEVTCiAgKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX3dyYXBfaW5pdChzdGF0ZSwgbiwgaykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX3dyYXBfdXBkYXRlID0gZnVuY3Rpb24gKHN0YXRlLCBjLCBtKSB7CiAgaWYgKAogICAgc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl9TVEFURUJZVEVTCiAgKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdjIG11c3QgYmUgIm0uYnl0ZUxlbmd0aCIgYnl0ZXMnKQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3Jfd3JhcF91cGRhdGUoc3RhdGUsIGMsIG0pCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl93cmFwX2ZpbmFsID0gZnVuY3Rpb24gKHN0YXRlKSB7CiAgaWYgKAogICAgc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl9TVEFURUJZVEVTCiAgKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX3dyYXBfZmluYWwoc3RhdGUpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX3dyYXBfaW5pdCA9IGZ1bmN0aW9uIChzdGF0ZSwgbiwgaykgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAic3RhdGUgbXVzdCBiZSAnY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX3dyYXBfaW5pdChzdGF0ZSwgbiwgaykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3Jfd3JhcF91cGRhdGUgPSBmdW5jdGlvbiAoc3RhdGUsIGMsIG0pIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYyBtdXN0IGJlICJtLmJ5dGVMZW5ndGgiIGJ5dGVzJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3Jfd3JhcF91cGRhdGUoc3RhdGUsIGMsIG0pCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX3dyYXBfZmluYWwgPSBmdW5jdGlvbiAoc3RhdGUpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX3dyYXBfZmluYWwoc3RhdGUpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl93cmFwX2luaXQgPSBmdW5jdGlvbiAoc3RhdGUsIG4sIGspIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX3dyYXBfaW5pdChzdGF0ZSwgbiwgaykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX3dyYXBfdXBkYXRlID0gZnVuY3Rpb24gKHN0YXRlLCBjLCBtKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAic3RhdGUgbXVzdCBiZSAnY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYyBtdXN0IGJlICJtLmJ5dGVMZW5ndGgiIGJ5dGVzJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX3dyYXBfdXBkYXRlKHN0YXRlLCBjLCBtKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3Jfd3JhcF9maW5hbCA9IGZ1bmN0aW9uIChzdGF0ZSkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3JfU1RBVEVCWVRFUycgYnl0ZXMiCiAgICApCiAgfQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3Jfd3JhcF9maW5hbChzdGF0ZSkKfQoKLy8gZXhwZXJpbWVudGFsCgpleHBvcnRzLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X2Jhc2UgPSBmdW5jdGlvbiAobiwgcCwgbnMpIHsKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKHA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3AnKQoKICBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X2Jhc2UobiwgcCwgbnMpCn0KCmV4cG9ydHMuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfc2lnbl9kZXRhY2hlZCA9IGZ1bmN0aW9uIChzaWcsIG0sIHNjYWxhciwgcGspIHsKICBpZiAoc2lnPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3NpZycpCiAgaWYgKHNjYWxhcj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2NhbGFyJykKICBpZiAocGsgJiYgcGsuYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3NpZ25fZGV0YWNoZWQoc2lnLCBtLCBzY2FsYXIsIHBrKQogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIGNvbXB1dGUgc2lnbmF0dXJlJykKfQoKZXhwb3J0cy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9za190b19zY2FsYXIgPSBmdW5jdGlvbiAobiwgc2spIHsKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKHNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1NFQ1JFVEtFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzaycpCgogIGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfc2tfdG9fc2NhbGFyKG4sIHNrKQp9CgpleHBvcnRzLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3NjYWxhciA9IGZ1bmN0aW9uIChzY2FsYXJPdXQsIHNjYWxhciwgbnMpIHsKICBpZiAoc2NhbGFyT3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzY2FsYXJfb3V0JykKICBpZiAoc2NhbGFyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzY2FsYXInKQoKICBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3NjYWxhcihzY2FsYXJPdXQsIHNjYWxhciwgbnMpCn0KCmV4cG9ydHMuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfcGsgPSBmdW5jdGlvbiAodHBrLCBwaywgbnMpIHsKICBpZiAodHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd0cGsnKQogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3BrKHRwaywgcGssIG5zKQogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIHR3ZWFrIHB1YmxpYyBrZXknKQp9CgpleHBvcnRzLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X2tleXBhaXIgPSBmdW5jdGlvbiAoCiAgcGssCiAgc2NhbGFyT3V0LAogIHNjYWxhckluLAogIG5zCikgewogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQogIGlmIChzY2FsYXJPdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NjYWxhcl9vdXQnKQogIGlmIChzY2FsYXJJbj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2NhbGFyX2luJykKCiAgYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9rZXlwYWlyKHBrLCBzY2FsYXJPdXQsIHNjYWxhckluLCBucykKfQoKZXhwb3J0cy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9zY2FsYXJfYWRkID0gZnVuY3Rpb24gKHNjYWxhck91dCwgc2NhbGFyLCBuKSB7CiAgaWYgKHNjYWxhck91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2NhbGFyX291dCcpCiAgaWYgKHNjYWxhcj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2NhbGFyJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCgogIGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfc2NhbGFyX2FkZChzY2FsYXJPdXQsIHNjYWxhciwgbikKfQoKZXhwb3J0cy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9wa19hZGQgPSBmdW5jdGlvbiAodHBrLCBwaywgcCkgewogIGlmICh0cGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3RwaycpCiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwaycpCiAgaWYgKHA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpIHRocm93IG5ldyBFcnJvcigncCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfcGtfYWRkKHRwaywgcGssIHApCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdmYWlsZWQgdG8gYWRkIHR3ZWFrIHRvIHB1YmxpYyBrZXknKQp9CgpleHBvcnRzLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X2tleXBhaXJfYWRkID0gZnVuY3Rpb24gKAogIHBrLAogIHNjYWxhck91dCwKICBzY2FsYXJJbiwKICB0d2VhawopIHsKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKICBpZiAoc2NhbGFyT3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzY2FsYXJfb3V0JykKICBpZiAoc2NhbGFySW4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NjYWxhcl9pbicpCiAgaWYgKHR3ZWFrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd0d2VhaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfa2V5cGFpcl9hZGQoCiAgICBwaywKICAgIHNjYWxhck91dCwKICAgIHNjYWxhckluLAogICAgdHdlYWsKICApCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdmYWlsZWQgdG8gYWRkIHR3ZWFrIHRvIGtleXBhaXInKQp9CgpleHBvcnRzLmV4dGVuc2lvbl9wYmtkZjJfc2hhNTEyX2FzeW5jID0gZnVuY3Rpb24gKAogIG91dCwKICBwYXNzd2QsCiAgc2FsdCwKICBpdGVyLAogIG91dGxlbiwKICBjYWxsYmFjayA9IHVuZGVmaW5lZAopIHsKICBpZiAoaXRlciA8IGJpbmRpbmcuZXh0ZW5zaW9uX3Bia2RmMl9zaGE1MTJfSVRFUkFUSU9OU19NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2l0ZXJhdGlvbnMnKQogIGlmIChvdXRsZW4gPiBiaW5kaW5nLmV4dGVuc2lvbl9wYmtkZjJfc2hhNTEyX0JZVEVTX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignb3V0bGVuJykKICBpZiAob3V0Py5ieXRlTGVuZ3RoIDwgb3V0bGVuKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKCFvdXQ/LmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoIXBhc3N3ZD8uYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdwYXNzd2QnKQogIGlmICghc2FsdD8uYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdzYWx0JykKCiAgY29uc3QgW2RvbmUsIHByb21pc2VdID0gY2hlY2tTdGF0dXMoY2FsbGJhY2spCgogIGJpbmRpbmcuZXh0ZW5zaW9uX3Bia2RmMl9zaGE1MTJfYXN5bmMoCiAgICBvdXQuYnVmZmVyLAogICAgb3V0LmJ5dGVPZmZzZXQsCiAgICBvdXQuYnl0ZUxlbmd0aCwKCiAgICBwYXNzd2QuYnVmZmVyLAogICAgcGFzc3dkLmJ5dGVPZmZzZXQsCiAgICBwYXNzd2QuYnl0ZUxlbmd0aCwKCiAgICBzYWx0LmJ1ZmZlciwKICAgIHNhbHQuYnl0ZU9mZnNldCwKICAgIHNhbHQuYnl0ZUxlbmd0aCwKCiAgICBpdGVyLAogICAgb3V0bGVuLAoKICAgIGRvbmUKICApCgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMuZXh0ZW5zaW9uX3Bia2RmMl9zaGE1MTIgPSBmdW5jdGlvbiAob3V0LCBwYXNzd2QsIHNhbHQsIGl0ZXIsIG91dGxlbikgewogIGlmIChpdGVyIDwgYmluZGluZy5leHRlbnNpb25fcGJrZGYyX3NoYTUxMl9JVEVSQVRJT05TX01JTikKICAgIHRocm93IG5ldyBFcnJvcignaXRlcmF0aW9ucycpCiAgaWYgKG91dGxlbiA+IGJpbmRpbmcuZXh0ZW5zaW9uX3Bia2RmMl9zaGE1MTJfQllURVNfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXRsZW4nKQogIGlmIChvdXQ/LmJ5dGVMZW5ndGggPCBvdXRsZW4pIHRocm93IG5ldyBFcnJvcignb3V0JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5leHRlbnNpb25fcGJrZGYyX3NoYTUxMihvdXQsIHBhc3N3ZCwgc2FsdCwgaXRlciwgb3V0bGVuKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ2ZhaWxlZCB0byBhZGQgdHdlYWsgdG8gcHVibGljIGtleScpCn0KCmZ1bmN0aW9uIGNoZWNrU3RhdHVzKGNhbGxiYWNrLCBib29sZWFuUmVzdWx0ID0gZmFsc2UpIHsKICBsZXQgZG9uZSwgcHJvbWlzZQoKICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICBkb25lID0gZnVuY3Rpb24gKHN0YXR1cykgewogICAgICBpZiAoYm9vbGVhblJlc3VsdCkgY2FsbGJhY2sobnVsbCwgc3RhdHVzID09PSAwKQogICAgICBlbHNlIGlmIChzdGF0dXMgPT09IDApIGNhbGxiYWNrKG51bGwpCiAgICAgIGVsc2UgY2FsbGJhY2sobmV3IEVycm9yKCdzdGF0dXM6ICcgKyBzdGF0dXMpKQogICAgfQogIH0gZWxzZSB7CiAgICBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBkb25lID0gZnVuY3Rpb24gKHN0YXR1cykgewogICAgICAgIGlmIChib29sZWFuUmVzdWx0KSByZXNvbHZlKHN0YXR1cyA9PT0gMCkKICAgICAgICBlbHNlIGlmIChzdGF0dXMgPT09IDApIHJlc29sdmUoKQogICAgICAgIGVsc2UgcmVqZWN0KG5ldyBFcnJvcignc3RhdHVzOiAnICsgc3RhdHVzKSkKICAgICAgfQogICAgfSkKICB9CgogIHJldHVybiBbZG9uZSwgcHJvbWlzZV0KfQp7CiAgIm5hbWUiOiAic29kaXVtLW5hdGl2ZSIsCiAgInZlcnNpb24iOiAiNS4wLjEwIiwKICAiZGVzY3JpcHRpb24iOiAiTG93IGxldmVsIGJpbmRpbmdzIGZvciBsaWJzb2RpdW0iLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImJpbmRpbmcuY2MiLAogICAgImJpbmRpbmcuanMiLAogICAgImV4dGVuc2lvbnMiLAogICAgInByZWJ1aWxkcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiCiAgXSwKICAiYWRkb24iOiB0cnVlLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAicmVxdWlyZS1hZGRvbiI6ICJeMS4xLjAiLAogICAgIndoaWNoLXJ1bnRpbWUiOiAiXjEuMi4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWNvbXBhdC1uYXBpIjogIl4xLjMuNSIsCiAgICAiYnJpdHRsZSI6ICJeMy4xNi4yIiwKICAgICJjbWFrZS1iYXJlIjogIl4xLjYuMSIsCiAgICAiY21ha2UtZmV0Y2giOiAiXjEuNC4zIiwKICAgICJjbWFrZS1uYXBpIjogIl4xLjIuMSIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4xLjAuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIG5wbSBydW4gdGVzdDpub2RlICYmIG5wbSBydW4gdGVzdDpiYXJlIiwKICAgICJ0ZXN0Om5vZGUiOiAibm9kZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC9hbGwuanMiCiAgfSwKICAic3RhbmRhcmQiOiB7CiAgICAiaWdub3JlIjogWwogICAgICAiL3Rlc3QvZml4dHVyZXMvKi5qcyIKICAgIF0KICB9LAogICJlbmdpbmVzIjogewogICAgImJhcmUiOiAiPj0xLjE2LjAiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc29kaXVtLW5hdGl2ZS5naXQiCiAgfSwKICAiY29udHJpYnV0b3JzIjogWwogICAgIkVtaWwgQmF5IDxnaXRodWJAdGl4ei5kaz4gKGh0dHA6Ly9iYXllcy5kaykiLAogICAgIk1hdGhpYXMgQnV1cyA8bWF0aGlhc2J1dXNAZ21haWwuY29tPiAoaHR0cHM6Ly9tYWZpbnRvLnNoKSIsCiAgICAiQ2hyaXN0b3BoZSBEaWVkZXJpY2hzIDxjaG0tZGllZGVyaWNoc0BoeXBlcmRpdmlzaW9uLmRrPiIKICBdLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zb2RpdW0tbmF0aXZlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc29kaXVtLW5hdGl2ZSIKfQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IEFCWVRFUyA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X0FCWVRFUwpjb25zdCBUQUdfTUVTU0FHRSA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X1RBR19NRVNTQUdFCmNvbnN0IFRBR19GSU5BTCA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X1RBR19GSU5BTApjb25zdCBTVEFURUJZVEVTID0gc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfU1RBVEVCWVRFUwpjb25zdCBIRUFERVJCWVRFUyA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X0hFQURFUkJZVEVTCmNvbnN0IEtFWUJZVEVTID0gc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfS0VZQllURVMKY29uc3QgVEFHX0ZJTkFMX0JZVEUgPSBiNGEuaXNCdWZmZXIoVEFHX0ZJTkFMKSA/IFRBR19GSU5BTFswXSA6IFRBR19GSU5BTAoKY29uc3QgRU1QVFkgPSBiNGEuYWxsb2MoMCkKY29uc3QgVEFHID0gYjRhLmFsbG9jKDEpCgpjbGFzcyBQdXNoIHsKICBjb25zdHJ1Y3RvciAoa2V5LCBzdGF0ZSA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coU1RBVEVCWVRFUyksIGhlYWRlciA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coSEVBREVSQllURVMpKSB7CiAgICBpZiAoIVRBR19GSU5BTCkgdGhyb3cgbmV3IEVycm9yKCdKYXZhU2NyaXB0IHNvZGl1bSB2ZXJzaW9uIG5lZWRzIHRvIHN1cHBvcnQgY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5JykKCiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy5zdGF0ZSA9IHN0YXRlCiAgICB0aGlzLmhlYWRlciA9IGhlYWRlcgoKICAgIHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X2luaXRfcHVzaCh0aGlzLnN0YXRlLCB0aGlzLmhlYWRlciwgdGhpcy5rZXkpCiAgfQoKICBuZXh0IChtZXNzYWdlLCBjaXBoZXIgPSBiNGEuYWxsb2NVbnNhZmUobWVzc2FnZS5ieXRlTGVuZ3RoICsgQUJZVEVTKSkgewogICAgc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfcHVzaCh0aGlzLnN0YXRlLCBjaXBoZXIsIG1lc3NhZ2UsIG51bGwsIFRBR19NRVNTQUdFKQogICAgcmV0dXJuIGNpcGhlcgogIH0KCiAgZmluYWwgKG1lc3NhZ2UgPSBFTVBUWSwgY2lwaGVyID0gYjRhLmFsbG9jVW5zYWZlKEFCWVRFUykpIHsKICAgIHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3B1c2godGhpcy5zdGF0ZSwgY2lwaGVyLCBtZXNzYWdlLCBudWxsLCBUQUdfRklOQUwpCiAgICByZXR1cm4gY2lwaGVyCiAgfQp9CgpjbGFzcyBQdWxsIHsKICBjb25zdHJ1Y3RvciAoa2V5LCBzdGF0ZSA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coU1RBVEVCWVRFUykpIHsKICAgIGlmICghVEFHX0ZJTkFMKSB0aHJvdyBuZXcgRXJyb3IoJ0phdmFTY3JpcHQgc29kaXVtIHZlcnNpb24gbmVlZHMgdG8gc3VwcG9ydCBjcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHknKQoKICAgIHRoaXMua2V5ID0ga2V5CiAgICB0aGlzLnN0YXRlID0gc3RhdGUKICAgIHRoaXMuZmluYWwgPSBmYWxzZQogIH0KCiAgaW5pdCAoaGVhZGVyKSB7CiAgICBzb2RpdW0uY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9pbml0X3B1bGwodGhpcy5zdGF0ZSwgaGVhZGVyLCB0aGlzLmtleSkKICB9CgogIG5leHQgKGNpcGhlciwgbWVzc2FnZSA9IGI0YS5hbGxvY1Vuc2FmZShjaXBoZXIuYnl0ZUxlbmd0aCAtIEFCWVRFUykpIHsKICAgIHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3B1bGwodGhpcy5zdGF0ZSwgbWVzc2FnZSwgVEFHLCBjaXBoZXIsIG51bGwpCiAgICB0aGlzLmZpbmFsID0gVEFHWzBdID09PSBUQUdfRklOQUxfQllURQogICAgcmV0dXJuIG1lc3NhZ2UKICB9Cn0KCmZ1bmN0aW9uIGtleWdlbiAoYnVmID0gYjRhLmFsbG9jKEtFWUJZVEVTKSkgewogIHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X2tleWdlbihidWYpCiAgcmV0dXJuIGJ1Zgp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBrZXlnZW4sCiAgS0VZQllURVMsCiAgQUJZVEVTLAogIFNUQVRFQllURVMsCiAgSEVBREVSQllURVMsCiAgUHVzaCwKICBQdWxsCn0KewogICJuYW1lIjogInNvZGl1bS1zZWNyZXRzdHJlYW0iLAogICJ2ZXJzaW9uIjogIjEuMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiV3JhcHMgbGlic29kaXVtcyBzZWNyZXRzdHJlYW0gaW4gYSBoaWdoZXIgbGV2ZWwgYWJzdHJhY3Rpb24iLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS4xLjEiLAogICAgInNvZGl1bS11bml2ZXJzYWwiOiAiXjUuMC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zb2RpdW0tc2VjcmV0c3RyZWFtLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zb2RpdW0tc2VjcmV0c3RyZWFtL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NvZGl1bS1zZWNyZXRzdHJlYW0iCn0KbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCdzb2RpdW0tbmF0aXZlJykKewogICJuYW1lIjogInNvZGl1bS11bml2ZXJzYWwiLAogICJ2ZXJzaW9uIjogIjUuMC4xIiwKICAiZGVzY3JpcHRpb24iOiAiVW5pdmVyc2FsIHdyYXBwZXIgZm9yIHNvZGl1bS1qYXZhc2NyaXB0IGFuZCBzb2RpdW0tbmF0aXZlIHdvcmtpbmcgaW4gTm9kZS5qcyBhbmQgdGhlIEJyb3dzZXIiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgInNvZGl1bS1uYXRpdmUiOiAiXjUuMC4xIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXMiOiB7CiAgICAic29kaXVtLWphdmFzY3JpcHQiOiAifjAuOC4wIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXNNZXRhIjogewogICAgInNvZGl1bS1qYXZhc2NyaXB0IjogewogICAgICAib3B0aW9uYWwiOiB0cnVlCiAgICB9CiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJwcmVwdWJsaXNoIjogIi4vYnVpbGQtc2NyaXB0cy9nZW5lcmF0ZS5qcyIKICB9LAogICJicm93c2VyIjogewogICAgInNvZGl1bS1uYXRpdmUiOiAic29kaXVtLWphdmFzY3JpcHQiCiAgfSwKICAiYnJvd3NlcmlmeSI6IHsKICAgICJ0cmFuc2Zvcm0iOiBbCiAgICAgICIuL2J1aWxkLXNjcmlwdHMvdHJhbnNmb3JtLmpzIgogICAgXQogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NvZGl1bS11bml2ZXJzYWwuZ2l0IgogIH0sCiAgImtleXdvcmRzIjogWwogICAgImxpYnNvZGl1bSIsCiAgICAic29kaXVtIiwKICAgICJzb2RpdW0tbmF0aXZlIiwKICAgICJzb2RpdW0tamF2YXNjcmlwdCIsCiAgICAiYnJvd3NlcmlmeSIKICBdLAogICJjb250cmlidXRvcnMiOiBbCiAgICAiRW1pbCBCYXkgPGdpdGh1YkB0aXh6LmRrPiAoaHR0cDovL2JheWVzLmRrKSIsCiAgICAiTWF0aGlhcyBCdXVzIDxtYXRoaWFzYnV1c0BnbWFpbC5jb20+IChodHRwczovL21hZmludG8uc2gpIiwKICAgICJDaHJpc3RvcGhlIERpZWRlcmljaHMgPGNobS1kaWVkZXJpY2hzQGh5cGVyZGl2aXNpb24uZGs+IgogIF0sCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NvZGl1bS11bml2ZXJzYWwvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zb2RpdW0tdW5pdmVyc2FsI3JlYWRtZSIKfQpjb25zdCB7IEV2ZW50RW1pdHRlciB9ID0gcmVxdWlyZSgnZXZlbnRzLXVuaXZlcnNhbCcpCmNvbnN0IFNUUkVBTV9ERVNUUk9ZRUQgPSBuZXcgRXJyb3IoJ1N0cmVhbSB3YXMgZGVzdHJveWVkJykKY29uc3QgUFJFTUFUVVJFX0NMT1NFID0gbmV3IEVycm9yKCdQcmVtYXR1cmUgY2xvc2UnKQoKY29uc3QgRklGTyA9IHJlcXVpcmUoJ2Zhc3QtZmlmbycpCmNvbnN0IFRleHREZWNvZGVyID0gcmVxdWlyZSgndGV4dC1kZWNvZGVyJykKCi8vIGlmIHdlIGRvIGEgZnV0dXJlIG1ham9yLCBleHBlY3QgcXVldWUgbWljcm90YXNrIHRvIGJlIHRoZXJlIGFsd2F5cywgZm9yIG5vdyBhIGJpdCBkZWZlbnNpdmUKY29uc3QgcW10ID0gdHlwZW9mIHF1ZXVlTWljcm90YXNrID09PSAndW5kZWZpbmVkJyA/IGZuID0+IGdsb2JhbC5wcm9jZXNzLm5leHRUaWNrKGZuKSA6IHF1ZXVlTWljcm90YXNrCgovKiBlc2xpbnQtZGlzYWJsZSBuby1tdWx0aS1zcGFjZXMgKi8KCi8vIDI5IGJpdHMgdXNlZCB0b3RhbCAoNCBmcm9tIHNoYXJlZCwgMTQgZnJvbSByZWFkLCBhbmQgMTEgZnJvbSB3cml0ZSkKY29uc3QgTUFYID0gKCgxIDw8IDI5KSAtIDEpCgovLyBTaGFyZWQgc3RhdGUKY29uc3QgT1BFTklORyAgICAgICA9IDBiMDAwMQpjb25zdCBQUkVERVNUUk9ZSU5HID0gMGIwMDEwCmNvbnN0IERFU1RST1lJTkcgICAgPSAwYjAxMDAKY29uc3QgREVTVFJPWUVEICAgICA9IDBiMTAwMAoKY29uc3QgTk9UX09QRU5JTkcgPSBNQVggXiBPUEVOSU5HCmNvbnN0IE5PVF9QUkVERVNUUk9ZSU5HID0gTUFYIF4gUFJFREVTVFJPWUlORwoKLy8gUmVhZCBzdGF0ZSAoNCBiaXQgb2Zmc2V0IGZyb20gc2hhcmVkIHN0YXRlKQpjb25zdCBSRUFEX0FDVElWRSAgICAgICAgICAgPSAwYjAwMDAwMDAwMDAwMDAxIDw8IDQKY29uc3QgUkVBRF9VUERBVElORyAgICAgICAgID0gMGIwMDAwMDAwMDAwMDAxMCA8PCA0CmNvbnN0IFJFQURfUFJJTUFSWSAgICAgICAgICA9IDBiMDAwMDAwMDAwMDAxMDAgPDwgNApjb25zdCBSRUFEX1FVRVVFRCAgICAgICAgICAgPSAwYjAwMDAwMDAwMDAxMDAwIDw8IDQKY29uc3QgUkVBRF9SRVNVTUVEICAgICAgICAgID0gMGIwMDAwMDAwMDAxMDAwMCA8PCA0CmNvbnN0IFJFQURfUElQRV9EUkFJTkVEICAgICA9IDBiMDAwMDAwMDAxMDAwMDAgPDwgNApjb25zdCBSRUFEX0VORElORyAgICAgICAgICAgPSAwYjAwMDAwMDAxMDAwMDAwIDw8IDQKY29uc3QgUkVBRF9FTUlUX0RBVEEgICAgICAgID0gMGIwMDAwMDAxMDAwMDAwMCA8PCA0CmNvbnN0IFJFQURfRU1JVF9SRUFEQUJMRSAgICA9IDBiMDAwMDAxMDAwMDAwMDAgPDwgNApjb25zdCBSRUFEX0VNSVRURURfUkVBREFCTEUgPSAwYjAwMDAxMDAwMDAwMDAwIDw8IDQKY29uc3QgUkVBRF9ET05FICAgICAgICAgICAgID0gMGIwMDAxMDAwMDAwMDAwMCA8PCA0CmNvbnN0IFJFQURfTkVYVF9USUNLICAgICAgICA9IDBiMDAxMDAwMDAwMDAwMDAgPDwgNApjb25zdCBSRUFEX05FRURTX1BVU0ggICAgICAgPSAwYjAxMDAwMDAwMDAwMDAwIDw8IDQKY29uc3QgUkVBRF9SRUFEX0FIRUFEICAgICAgID0gMGIxMDAwMDAwMDAwMDAwMCA8PCA0CgovLyBDb21iaW5lZCByZWFkIHN0YXRlCmNvbnN0IFJFQURfRkxPV0lORyA9IFJFQURfUkVTVU1FRCB8IFJFQURfUElQRV9EUkFJTkVECmNvbnN0IFJFQURfQUNUSVZFX0FORF9ORUVEU19QVVNIID0gUkVBRF9BQ1RJVkUgfCBSRUFEX05FRURTX1BVU0gKY29uc3QgUkVBRF9QUklNQVJZX0FORF9BQ1RJVkUgPSBSRUFEX1BSSU1BUlkgfCBSRUFEX0FDVElWRQpjb25zdCBSRUFEX0VNSVRfUkVBREFCTEVfQU5EX1FVRVVFRCA9IFJFQURfRU1JVF9SRUFEQUJMRSB8IFJFQURfUVVFVUVECmNvbnN0IFJFQURfUkVTVU1FRF9SRUFEX0FIRUFEID0gUkVBRF9SRVNVTUVEIHwgUkVBRF9SRUFEX0FIRUFECgpjb25zdCBSRUFEX05PVF9BQ1RJVkUgICAgICAgICAgICAgPSBNQVggXiBSRUFEX0FDVElWRQpjb25zdCBSRUFEX05PTl9QUklNQVJZICAgICAgICAgICAgPSBNQVggXiBSRUFEX1BSSU1BUlkKY29uc3QgUkVBRF9OT05fUFJJTUFSWV9BTkRfUFVTSEVEID0gTUFYIF4gKFJFQURfUFJJTUFSWSB8IFJFQURfTkVFRFNfUFVTSCkKY29uc3QgUkVBRF9QVVNIRUQgICAgICAgICAgICAgICAgID0gTUFYIF4gUkVBRF9ORUVEU19QVVNICmNvbnN0IFJFQURfUEFVU0VEICAgICAgICAgICAgICAgICA9IE1BWCBeIFJFQURfUkVTVU1FRApjb25zdCBSRUFEX05PVF9RVUVVRUQgICAgICAgICAgICAgPSBNQVggXiAoUkVBRF9RVUVVRUQgfCBSRUFEX0VNSVRURURfUkVBREFCTEUpCmNvbnN0IFJFQURfTk9UX0VORElORyAgICAgICAgICAgICA9IE1BWCBeIFJFQURfRU5ESU5HCmNvbnN0IFJFQURfUElQRV9OT1RfRFJBSU5FRCAgICAgICA9IE1BWCBeIFJFQURfRkxPV0lORwpjb25zdCBSRUFEX05PVF9ORVhUX1RJQ0sgICAgICAgICAgPSBNQVggXiBSRUFEX05FWFRfVElDSwpjb25zdCBSRUFEX05PVF9VUERBVElORyAgICAgICAgICAgPSBNQVggXiBSRUFEX1VQREFUSU5HCmNvbnN0IFJFQURfTk9fUkVBRF9BSEVBRCAgICAgICAgICA9IE1BWCBeIFJFQURfUkVBRF9BSEVBRApjb25zdCBSRUFEX1BBVVNFRF9OT19SRUFEX0FIRUFEICAgPSBNQVggXiBSRUFEX1JFU1VNRURfUkVBRF9BSEVBRAoKLy8gV3JpdGUgc3RhdGUgKDE4IGJpdCBvZmZzZXQsIDQgYml0IG9mZnNldCBmcm9tIHNoYXJlZCBzdGF0ZSBhbmQgMTQgZnJvbSByZWFkIHN0YXRlKQpjb25zdCBXUklURV9BQ1RJVkUgICAgID0gMGIwMDAwMDAwMDAwMSA8PCAxOApjb25zdCBXUklURV9VUERBVElORyAgID0gMGIwMDAwMDAwMDAxMCA8PCAxOApjb25zdCBXUklURV9QUklNQVJZICAgID0gMGIwMDAwMDAwMDEwMCA8PCAxOApjb25zdCBXUklURV9RVUVVRUQgICAgID0gMGIwMDAwMDAwMTAwMCA8PCAxOApjb25zdCBXUklURV9VTkRSQUlORUQgID0gMGIwMDAwMDAxMDAwMCA8PCAxOApjb25zdCBXUklURV9ET05FICAgICAgID0gMGIwMDAwMDEwMDAwMCA8PCAxOApjb25zdCBXUklURV9FTUlUX0RSQUlOID0gMGIwMDAwMTAwMDAwMCA8PCAxOApjb25zdCBXUklURV9ORVhUX1RJQ0sgID0gMGIwMDAxMDAwMDAwMCA8PCAxOApjb25zdCBXUklURV9XUklUSU5HICAgID0gMGIwMDEwMDAwMDAwMCA8PCAxOApjb25zdCBXUklURV9GSU5JU0hJTkcgID0gMGIwMTAwMDAwMDAwMCA8PCAxOApjb25zdCBXUklURV9DT1JLRUQgICAgID0gMGIxMDAwMDAwMDAwMCA8PCAxOAoKY29uc3QgV1JJVEVfTk9UX0FDVElWRSAgICA9IE1BWCBeIChXUklURV9BQ1RJVkUgfCBXUklURV9XUklUSU5HKQpjb25zdCBXUklURV9OT05fUFJJTUFSWSAgID0gTUFYIF4gV1JJVEVfUFJJTUFSWQpjb25zdCBXUklURV9OT1RfRklOSVNISU5HID0gTUFYIF4gKFdSSVRFX0FDVElWRSB8IFdSSVRFX0ZJTklTSElORykKY29uc3QgV1JJVEVfRFJBSU5FRCAgICAgICA9IE1BWCBeIFdSSVRFX1VORFJBSU5FRApjb25zdCBXUklURV9OT1RfUVVFVUVEICAgID0gTUFYIF4gV1JJVEVfUVVFVUVECmNvbnN0IFdSSVRFX05PVF9ORVhUX1RJQ0sgPSBNQVggXiBXUklURV9ORVhUX1RJQ0sKY29uc3QgV1JJVEVfTk9UX1VQREFUSU5HICA9IE1BWCBeIFdSSVRFX1VQREFUSU5HCmNvbnN0IFdSSVRFX05PVF9DT1JLRUQgICAgPSBNQVggXiBXUklURV9DT1JLRUQKCi8vIENvbWJpbmVkIHNoYXJlZCBzdGF0ZQpjb25zdCBBQ1RJVkUgPSBSRUFEX0FDVElWRSB8IFdSSVRFX0FDVElWRQpjb25zdCBOT1RfQUNUSVZFID0gTUFYIF4gQUNUSVZFCmNvbnN0IERPTkUgPSBSRUFEX0RPTkUgfCBXUklURV9ET05FCmNvbnN0IERFU1RST1lfU1RBVFVTID0gREVTVFJPWUlORyB8IERFU1RST1lFRCB8IFBSRURFU1RST1lJTkcKY29uc3QgT1BFTl9TVEFUVVMgPSBERVNUUk9ZX1NUQVRVUyB8IE9QRU5JTkcKY29uc3QgQVVUT19ERVNUUk9ZID0gREVTVFJPWV9TVEFUVVMgfCBET05FCmNvbnN0IE5PTl9QUklNQVJZID0gV1JJVEVfTk9OX1BSSU1BUlkgJiBSRUFEX05PTl9QUklNQVJZCmNvbnN0IEFDVElWRV9PUl9USUNLSU5HID0gV1JJVEVfTkVYVF9USUNLIHwgUkVBRF9ORVhUX1RJQ0sKY29uc3QgVElDS0lORyA9IEFDVElWRV9PUl9USUNLSU5HICYgTk9UX0FDVElWRQpjb25zdCBJU19PUEVOSU5HID0gT1BFTl9TVEFUVVMgfCBUSUNLSU5HCgovLyBDb21iaW5lZCBzaGFyZWQgc3RhdGUgYW5kIHJlYWQgc3RhdGUKY29uc3QgUkVBRF9QUklNQVJZX1NUQVRVUyA9IE9QRU5fU1RBVFVTIHwgUkVBRF9FTkRJTkcgfCBSRUFEX0RPTkUKY29uc3QgUkVBRF9TVEFUVVMgPSBPUEVOX1NUQVRVUyB8IFJFQURfRE9ORSB8IFJFQURfUVVFVUVECmNvbnN0IFJFQURfRU5ESU5HX1NUQVRVUyA9IE9QRU5fU1RBVFVTIHwgUkVBRF9FTkRJTkcgfCBSRUFEX1FVRVVFRApjb25zdCBSRUFEX1JFQURBQkxFX1NUQVRVUyA9IE9QRU5fU1RBVFVTIHwgUkVBRF9FTUlUX1JFQURBQkxFIHwgUkVBRF9RVUVVRUQgfCBSRUFEX0VNSVRURURfUkVBREFCTEUKY29uc3QgU0hPVUxEX05PVF9SRUFEID0gT1BFTl9TVEFUVVMgfCBSRUFEX0FDVElWRSB8IFJFQURfRU5ESU5HIHwgUkVBRF9ET05FIHwgUkVBRF9ORUVEU19QVVNIIHwgUkVBRF9SRUFEX0FIRUFECmNvbnN0IFJFQURfQkFDS1BSRVNTVVJFX1NUQVRVUyA9IERFU1RST1lfU1RBVFVTIHwgUkVBRF9FTkRJTkcgfCBSRUFEX0RPTkUKY29uc3QgUkVBRF9VUERBVEVfU1lOQ19TVEFUVVMgPSBSRUFEX1VQREFUSU5HIHwgT1BFTl9TVEFUVVMgfCBSRUFEX05FWFRfVElDSyB8IFJFQURfUFJJTUFSWQpjb25zdCBSRUFEX05FWFRfVElDS19PUl9PUEVOSU5HID0gUkVBRF9ORVhUX1RJQ0sgfCBPUEVOSU5HCgovLyBDb21iaW5lZCB3cml0ZSBzdGF0ZQpjb25zdCBXUklURV9QUklNQVJZX1NUQVRVUyA9IE9QRU5fU1RBVFVTIHwgV1JJVEVfRklOSVNISU5HIHwgV1JJVEVfRE9ORQpjb25zdCBXUklURV9RVUVVRURfQU5EX1VORFJBSU5FRCA9IFdSSVRFX1FVRVVFRCB8IFdSSVRFX1VORFJBSU5FRApjb25zdCBXUklURV9RVUVVRURfQU5EX0FDVElWRSA9IFdSSVRFX1FVRVVFRCB8IFdSSVRFX0FDVElWRQpjb25zdCBXUklURV9EUkFJTl9TVEFUVVMgPSBXUklURV9RVUVVRUQgfCBXUklURV9VTkRSQUlORUQgfCBPUEVOX1NUQVRVUyB8IFdSSVRFX0FDVElWRQpjb25zdCBXUklURV9TVEFUVVMgPSBPUEVOX1NUQVRVUyB8IFdSSVRFX0FDVElWRSB8IFdSSVRFX1FVRVVFRCB8IFdSSVRFX0NPUktFRApjb25zdCBXUklURV9QUklNQVJZX0FORF9BQ1RJVkUgPSBXUklURV9QUklNQVJZIHwgV1JJVEVfQUNUSVZFCmNvbnN0IFdSSVRFX0FDVElWRV9BTkRfV1JJVElORyA9IFdSSVRFX0FDVElWRSB8IFdSSVRFX1dSSVRJTkcKY29uc3QgV1JJVEVfRklOSVNISU5HX1NUQVRVUyA9IE9QRU5fU1RBVFVTIHwgV1JJVEVfRklOSVNISU5HIHwgV1JJVEVfUVVFVUVEX0FORF9BQ1RJVkUgfCBXUklURV9ET05FCmNvbnN0IFdSSVRFX0JBQ0tQUkVTU1VSRV9TVEFUVVMgPSBXUklURV9VTkRSQUlORUQgfCBERVNUUk9ZX1NUQVRVUyB8IFdSSVRFX0ZJTklTSElORyB8IFdSSVRFX0RPTkUKY29uc3QgV1JJVEVfVVBEQVRFX1NZTkNfU1RBVFVTID0gV1JJVEVfVVBEQVRJTkcgfCBPUEVOX1NUQVRVUyB8IFdSSVRFX05FWFRfVElDSyB8IFdSSVRFX1BSSU1BUlkKY29uc3QgV1JJVEVfRFJPUF9EQVRBID0gV1JJVEVfRklOSVNISU5HIHwgV1JJVEVfRE9ORSB8IERFU1RST1lfU1RBVFVTCgpjb25zdCBhc3luY0l0ZXJhdG9yID0gU3ltYm9sLmFzeW5jSXRlcmF0b3IgfHwgU3ltYm9sKCdhc3luY0l0ZXJhdG9yJykKCmNsYXNzIFdyaXRhYmxlU3RhdGUgewogIGNvbnN0cnVjdG9yIChzdHJlYW0sIHsgaGlnaFdhdGVyTWFyayA9IDE2Mzg0LCBtYXAgPSBudWxsLCBtYXBXcml0YWJsZSwgYnl0ZUxlbmd0aCwgYnl0ZUxlbmd0aFdyaXRhYmxlIH0gPSB7fSkgewogICAgdGhpcy5zdHJlYW0gPSBzdHJlYW0KICAgIHRoaXMucXVldWUgPSBuZXcgRklGTygpCiAgICB0aGlzLmhpZ2hXYXRlck1hcmsgPSBoaWdoV2F0ZXJNYXJrCiAgICB0aGlzLmJ1ZmZlcmVkID0gMAogICAgdGhpcy5lcnJvciA9IG51bGwKICAgIHRoaXMucGlwZWxpbmUgPSBudWxsCiAgICB0aGlzLmRyYWlucyA9IG51bGwgLy8gaWYgd2UgYWRkIG1vcmUgc2VsZG9tbHkgdXNlZCBoZWxwZXJzIHdlIG1pZ2h0IHRoZW0gaW50byBhIHN1Ym9iamVjdCBzbyBpdHMgYSBzaW5nbGUgcHRyCiAgICB0aGlzLmJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoV3JpdGFibGUgfHwgYnl0ZUxlbmd0aCB8fCBkZWZhdWx0Qnl0ZUxlbmd0aAogICAgdGhpcy5tYXAgPSBtYXBXcml0YWJsZSB8fCBtYXAKICAgIHRoaXMuYWZ0ZXJXcml0ZSA9IGFmdGVyV3JpdGUuYmluZCh0aGlzKQogICAgdGhpcy5hZnRlclVwZGF0ZU5leHRUaWNrID0gdXBkYXRlV3JpdGVOVC5iaW5kKHRoaXMpCiAgfQoKICBnZXQgZW5kZWQgKCkgewogICAgcmV0dXJuICh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9ET05FKSAhPT0gMAogIH0KCiAgcHVzaCAoZGF0YSkgewogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9EUk9QX0RBVEEpICE9PSAwKSByZXR1cm4gZmFsc2UKICAgIGlmICh0aGlzLm1hcCAhPT0gbnVsbCkgZGF0YSA9IHRoaXMubWFwKGRhdGEpCgogICAgdGhpcy5idWZmZXJlZCArPSB0aGlzLmJ5dGVMZW5ndGgoZGF0YSkKICAgIHRoaXMucXVldWUucHVzaChkYXRhKQoKICAgIGlmICh0aGlzLmJ1ZmZlcmVkIDwgdGhpcy5oaWdoV2F0ZXJNYXJrKSB7CiAgICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9RVUVVRUQKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gV1JJVEVfUVVFVUVEX0FORF9VTkRSQUlORUQKICAgIHJldHVybiBmYWxzZQogIH0KCiAgc2hpZnQgKCkgewogICAgY29uc3QgZGF0YSA9IHRoaXMucXVldWUuc2hpZnQoKQoKICAgIHRoaXMuYnVmZmVyZWQgLT0gdGhpcy5ieXRlTGVuZ3RoKGRhdGEpCiAgICBpZiAodGhpcy5idWZmZXJlZCA9PT0gMCkgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICY9IFdSSVRFX05PVF9RVUVVRUQKCiAgICByZXR1cm4gZGF0YQogIH0KCiAgZW5kIChkYXRhKSB7CiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdmdW5jdGlvbicpIHRoaXMuc3RyZWFtLm9uY2UoJ2ZpbmlzaCcsIGRhdGEpCiAgICBlbHNlIGlmIChkYXRhICE9PSB1bmRlZmluZWQgJiYgZGF0YSAhPT0gbnVsbCkgdGhpcy5wdXNoKGRhdGEpCiAgICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgPSAodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlIHwgV1JJVEVfRklOSVNISU5HKSAmIFdSSVRFX05PTl9QUklNQVJZCiAgfQoKICBhdXRvQmF0Y2ggKGRhdGEsIGNiKSB7CiAgICBjb25zdCBidWZmZXIgPSBbXQogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgICBidWZmZXIucHVzaChkYXRhKQogICAgd2hpbGUgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfU1RBVFVTKSA9PT0gV1JJVEVfUVVFVUVEX0FORF9BQ1RJVkUpIHsKICAgICAgYnVmZmVyLnB1c2goc3RyZWFtLl93cml0YWJsZVN0YXRlLnNoaWZ0KCkpCiAgICB9CgogICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgT1BFTl9TVEFUVVMpICE9PSAwKSByZXR1cm4gY2IobnVsbCkKICAgIHN0cmVhbS5fd3JpdGV2KGJ1ZmZlciwgY2IpCiAgfQoKICB1cGRhdGUgKCkgewogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IFdSSVRFX1VQREFUSU5HCgogICAgZG8gewogICAgICB3aGlsZSAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9TVEFUVVMpID09PSBXUklURV9RVUVVRUQpIHsKICAgICAgICBjb25zdCBkYXRhID0gdGhpcy5zaGlmdCgpCiAgICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9BQ1RJVkVfQU5EX1dSSVRJTkcKICAgICAgICBzdHJlYW0uX3dyaXRlKGRhdGEsIHRoaXMuYWZ0ZXJXcml0ZSkKICAgICAgfQoKICAgICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfUFJJTUFSWV9BTkRfQUNUSVZFKSA9PT0gMCkgdGhpcy51cGRhdGVOb25QcmltYXJ5KCkKICAgIH0gd2hpbGUgKHRoaXMuY29udGludWVVcGRhdGUoKSA9PT0gdHJ1ZSkKCiAgICBzdHJlYW0uX2R1cGxleFN0YXRlICY9IFdSSVRFX05PVF9VUERBVElORwogIH0KCiAgdXBkYXRlTm9uUHJpbWFyeSAoKSB7CiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQoKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX0ZJTklTSElOR19TVEFUVVMpID09PSBXUklURV9GSU5JU0hJTkcpIHsKICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSA9IHN0cmVhbS5fZHVwbGV4U3RhdGUgfCBXUklURV9BQ1RJVkUKICAgICAgc3RyZWFtLl9maW5hbChhZnRlckZpbmFsLmJpbmQodGhpcykpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIERFU1RST1lfU1RBVFVTKSA9PT0gREVTVFJPWUlORykgewogICAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBBQ1RJVkVfT1JfVElDS0lORykgPT09IDApIHsKICAgICAgICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IEFDVElWRQogICAgICAgIHN0cmVhbS5fZGVzdHJveShhZnRlckRlc3Ryb3kuYmluZCh0aGlzKSkKICAgICAgfQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBJU19PUEVOSU5HKSA9PT0gT1BFTklORykgewogICAgICBzdHJlYW0uX2R1cGxleFN0YXRlID0gKHN0cmVhbS5fZHVwbGV4U3RhdGUgfCBBQ1RJVkUpICYgTk9UX09QRU5JTkcKICAgICAgc3RyZWFtLl9vcGVuKGFmdGVyT3Blbi5iaW5kKHRoaXMpKQogICAgfQogIH0KCiAgY29udGludWVVcGRhdGUgKCkgewogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9ORVhUX1RJQ0spID09PSAwKSByZXR1cm4gZmFsc2UKICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBXUklURV9OT1RfTkVYVF9USUNLCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgdXBkYXRlQ2FsbGJhY2sgKCkgewogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9VUERBVEVfU1lOQ19TVEFUVVMpID09PSBXUklURV9QUklNQVJZKSB0aGlzLnVwZGF0ZSgpCiAgICBlbHNlIHRoaXMudXBkYXRlTmV4dFRpY2soKQogIH0KCiAgdXBkYXRlTmV4dFRpY2sgKCkgewogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9ORVhUX1RJQ0spICE9PSAwKSByZXR1cm4KICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9ORVhUX1RJQ0sKICAgIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfVVBEQVRJTkcpID09PSAwKSBxbXQodGhpcy5hZnRlclVwZGF0ZU5leHRUaWNrKQogIH0KfQoKY2xhc3MgUmVhZGFibGVTdGF0ZSB7CiAgY29uc3RydWN0b3IgKHN0cmVhbSwgeyBoaWdoV2F0ZXJNYXJrID0gMTYzODQsIG1hcCA9IG51bGwsIG1hcFJlYWRhYmxlLCBieXRlTGVuZ3RoLCBieXRlTGVuZ3RoUmVhZGFibGUgfSA9IHt9KSB7CiAgICB0aGlzLnN0cmVhbSA9IHN0cmVhbQogICAgdGhpcy5xdWV1ZSA9IG5ldyBGSUZPKCkKICAgIHRoaXMuaGlnaFdhdGVyTWFyayA9IGhpZ2hXYXRlck1hcmsgPT09IDAgPyAxIDogaGlnaFdhdGVyTWFyawogICAgdGhpcy5idWZmZXJlZCA9IDAKICAgIHRoaXMucmVhZEFoZWFkID0gaGlnaFdhdGVyTWFyayA+IDAKICAgIHRoaXMuZXJyb3IgPSBudWxsCiAgICB0aGlzLnBpcGVsaW5lID0gbnVsbAogICAgdGhpcy5ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aFJlYWRhYmxlIHx8IGJ5dGVMZW5ndGggfHwgZGVmYXVsdEJ5dGVMZW5ndGgKICAgIHRoaXMubWFwID0gbWFwUmVhZGFibGUgfHwgbWFwCiAgICB0aGlzLnBpcGVUbyA9IG51bGwKICAgIHRoaXMuYWZ0ZXJSZWFkID0gYWZ0ZXJSZWFkLmJpbmQodGhpcykKICAgIHRoaXMuYWZ0ZXJVcGRhdGVOZXh0VGljayA9IHVwZGF0ZVJlYWROVC5iaW5kKHRoaXMpCiAgfQoKICBnZXQgZW5kZWQgKCkgewogICAgcmV0dXJuICh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX0RPTkUpICE9PSAwCiAgfQoKICBwaXBlIChwaXBlVG8sIGNiKSB7CiAgICBpZiAodGhpcy5waXBlVG8gIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignQ2FuIG9ubHkgcGlwZSB0byBvbmUgZGVzdGluYXRpb24nKQogICAgaWYgKHR5cGVvZiBjYiAhPT0gJ2Z1bmN0aW9uJykgY2IgPSBudWxsCgogICAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlIHw9IFJFQURfUElQRV9EUkFJTkVECiAgICB0aGlzLnBpcGVUbyA9IHBpcGVUbwogICAgdGhpcy5waXBlbGluZSA9IG5ldyBQaXBlbGluZSh0aGlzLnN0cmVhbSwgcGlwZVRvLCBjYikKCiAgICBpZiAoY2IpIHRoaXMuc3RyZWFtLm9uKCdlcnJvcicsIG5vb3ApIC8vIFdlIGFscmVhZHkgZXJyb3IgaGFuZGxlIHRoaXMgc28gc3VwcmVzcyBjcmFzaGVzCgogICAgaWYgKGlzU3RyZWFteChwaXBlVG8pKSB7CiAgICAgIHBpcGVUby5fd3JpdGFibGVTdGF0ZS5waXBlbGluZSA9IHRoaXMucGlwZWxpbmUKICAgICAgaWYgKGNiKSBwaXBlVG8ub24oJ2Vycm9yJywgbm9vcCkgLy8gV2UgYWxyZWFkeSBlcnJvciBoYW5kbGUgdGhpcyBzbyBzdXByZXNzIGNyYXNoZXMKICAgICAgcGlwZVRvLm9uKCdmaW5pc2gnLCB0aGlzLnBpcGVsaW5lLmZpbmlzaGVkLmJpbmQodGhpcy5waXBlbGluZSkpIC8vIFRPRE86IGp1c3QgY2FsbCBmaW5pc2hlZCBmcm9tIHBpcGVUbyBpdHNlbGYKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IG9uZXJyb3IgPSB0aGlzLnBpcGVsaW5lLmRvbmUuYmluZCh0aGlzLnBpcGVsaW5lLCBwaXBlVG8pCiAgICAgIGNvbnN0IG9uY2xvc2UgPSB0aGlzLnBpcGVsaW5lLmRvbmUuYmluZCh0aGlzLnBpcGVsaW5lLCBwaXBlVG8sIG51bGwpIC8vIG9uY2xvc2UgaGFzIGEgd2VpcmQgYm9vbCBhcmcKICAgICAgcGlwZVRvLm9uKCdlcnJvcicsIG9uZXJyb3IpCiAgICAgIHBpcGVUby5vbignY2xvc2UnLCBvbmNsb3NlKQogICAgICBwaXBlVG8ub24oJ2ZpbmlzaCcsIHRoaXMucGlwZWxpbmUuZmluaXNoZWQuYmluZCh0aGlzLnBpcGVsaW5lKSkKICAgIH0KCiAgICBwaXBlVG8ub24oJ2RyYWluJywgYWZ0ZXJEcmFpbi5iaW5kKHRoaXMpKQogICAgdGhpcy5zdHJlYW0uZW1pdCgncGlwaW5nJywgcGlwZVRvKQogICAgcGlwZVRvLmVtaXQoJ3BpcGUnLCB0aGlzLnN0cmVhbSkKICB9CgogIHB1c2ggKGRhdGEpIHsKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCgogICAgaWYgKGRhdGEgPT09IG51bGwpIHsKICAgICAgdGhpcy5oaWdoV2F0ZXJNYXJrID0gMAogICAgICBzdHJlYW0uX2R1cGxleFN0YXRlID0gKHN0cmVhbS5fZHVwbGV4U3RhdGUgfCBSRUFEX0VORElORykgJiBSRUFEX05PTl9QUklNQVJZX0FORF9QVVNIRUQKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgaWYgKHRoaXMubWFwICE9PSBudWxsKSB7CiAgICAgIGRhdGEgPSB0aGlzLm1hcChkYXRhKQogICAgICBpZiAoZGF0YSA9PT0gbnVsbCkgewogICAgICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gUkVBRF9QVVNIRUQKICAgICAgICByZXR1cm4gdGhpcy5idWZmZXJlZCA8IHRoaXMuaGlnaFdhdGVyTWFyawogICAgICB9CiAgICB9CgogICAgdGhpcy5idWZmZXJlZCArPSB0aGlzLmJ5dGVMZW5ndGgoZGF0YSkKICAgIHRoaXMucXVldWUucHVzaChkYXRhKQoKICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgPSAoc3RyZWFtLl9kdXBsZXhTdGF0ZSB8IFJFQURfUVVFVUVEKSAmIFJFQURfUFVTSEVECgogICAgcmV0dXJuIHRoaXMuYnVmZmVyZWQgPCB0aGlzLmhpZ2hXYXRlck1hcmsKICB9CgogIHNoaWZ0ICgpIHsKICAgIGNvbnN0IGRhdGEgPSB0aGlzLnF1ZXVlLnNoaWZ0KCkKCiAgICB0aGlzLmJ1ZmZlcmVkIC09IHRoaXMuYnl0ZUxlbmd0aChkYXRhKQogICAgaWYgKHRoaXMuYnVmZmVyZWQgPT09IDApIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBSRUFEX05PVF9RVUVVRUQKICAgIHJldHVybiBkYXRhCiAgfQoKICB1bnNoaWZ0IChkYXRhKSB7CiAgICBjb25zdCBwZW5kaW5nID0gW3RoaXMubWFwICE9PSBudWxsID8gdGhpcy5tYXAoZGF0YSkgOiBkYXRhXQogICAgd2hpbGUgKHRoaXMuYnVmZmVyZWQgPiAwKSBwZW5kaW5nLnB1c2godGhpcy5zaGlmdCgpKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGVuZGluZy5sZW5ndGggLSAxOyBpKyspIHsKICAgICAgY29uc3QgZGF0YSA9IHBlbmRpbmdbaV0KICAgICAgdGhpcy5idWZmZXJlZCArPSB0aGlzLmJ5dGVMZW5ndGgoZGF0YSkKICAgICAgdGhpcy5xdWV1ZS5wdXNoKGRhdGEpCiAgICB9CgogICAgdGhpcy5wdXNoKHBlbmRpbmdbcGVuZGluZy5sZW5ndGggLSAxXSkKICB9CgogIHJlYWQgKCkgewogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1NUQVRVUykgPT09IFJFQURfUVVFVUVEKSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLnNoaWZ0KCkKICAgICAgaWYgKHRoaXMucGlwZVRvICE9PSBudWxsICYmIHRoaXMucGlwZVRvLndyaXRlKGRhdGEpID09PSBmYWxzZSkgc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBSRUFEX1BJUEVfTk9UX0RSQUlORUQKICAgICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9FTUlUX0RBVEEpICE9PSAwKSBzdHJlYW0uZW1pdCgnZGF0YScsIGRhdGEpCiAgICAgIHJldHVybiBkYXRhCiAgICB9CgogICAgaWYgKHRoaXMucmVhZEFoZWFkID09PSBmYWxzZSkgewogICAgICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IFJFQURfUkVBRF9BSEVBRAogICAgICB0aGlzLnVwZGF0ZU5leHRUaWNrKCkKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgZHJhaW4gKCkgewogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgICB3aGlsZSAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1NUQVRVUykgPT09IFJFQURfUVVFVUVEICYmIChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9GTE9XSU5HKSAhPT0gMCkgewogICAgICBjb25zdCBkYXRhID0gdGhpcy5zaGlmdCgpCiAgICAgIGlmICh0aGlzLnBpcGVUbyAhPT0gbnVsbCAmJiB0aGlzLnBpcGVUby53cml0ZShkYXRhKSA9PT0gZmFsc2UpIHN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gUkVBRF9QSVBFX05PVF9EUkFJTkVECiAgICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfRU1JVF9EQVRBKSAhPT0gMCkgc3RyZWFtLmVtaXQoJ2RhdGEnLCBkYXRhKQogICAgfQogIH0KCiAgdXBkYXRlICgpIHsKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCgogICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX1VQREFUSU5HCgogICAgZG8gewogICAgICB0aGlzLmRyYWluKCkKCiAgICAgIHdoaWxlICh0aGlzLmJ1ZmZlcmVkIDwgdGhpcy5oaWdoV2F0ZXJNYXJrICYmIChzdHJlYW0uX2R1cGxleFN0YXRlICYgU0hPVUxEX05PVF9SRUFEKSA9PT0gUkVBRF9SRUFEX0FIRUFEKSB7CiAgICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX0FDVElWRV9BTkRfTkVFRFNfUFVTSAogICAgICAgIHN0cmVhbS5fcmVhZCh0aGlzLmFmdGVyUmVhZCkKICAgICAgICB0aGlzLmRyYWluKCkKICAgICAgfQoKICAgICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9SRUFEQUJMRV9TVEFUVVMpID09PSBSRUFEX0VNSVRfUkVBREFCTEVfQU5EX1FVRVVFRCkgewogICAgICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gUkVBRF9FTUlUVEVEX1JFQURBQkxFCiAgICAgICAgc3RyZWFtLmVtaXQoJ3JlYWRhYmxlJykKICAgICAgfQoKICAgICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9QUklNQVJZX0FORF9BQ1RJVkUpID09PSAwKSB0aGlzLnVwZGF0ZU5vblByaW1hcnkoKQogICAgfSB3aGlsZSAodGhpcy5jb250aW51ZVVwZGF0ZSgpID09PSB0cnVlKQoKICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gUkVBRF9OT1RfVVBEQVRJTkcKICB9CgogIHVwZGF0ZU5vblByaW1hcnkgKCkgewogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX0VORElOR19TVEFUVVMpID09PSBSRUFEX0VORElORykgewogICAgICBzdHJlYW0uX2R1cGxleFN0YXRlID0gKHN0cmVhbS5fZHVwbGV4U3RhdGUgfCBSRUFEX0RPTkUpICYgUkVBRF9OT1RfRU5ESU5HCiAgICAgIHN0cmVhbS5lbWl0KCdlbmQnKQogICAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBBVVRPX0RFU1RST1kpID09PSBET05FKSBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IERFU1RST1lJTkcKICAgICAgaWYgKHRoaXMucGlwZVRvICE9PSBudWxsKSB0aGlzLnBpcGVUby5lbmQoKQogICAgfQoKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIERFU1RST1lfU1RBVFVTKSA9PT0gREVTVFJPWUlORykgewogICAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBBQ1RJVkVfT1JfVElDS0lORykgPT09IDApIHsKICAgICAgICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IEFDVElWRQogICAgICAgIHN0cmVhbS5fZGVzdHJveShhZnRlckRlc3Ryb3kuYmluZCh0aGlzKSkKICAgICAgfQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBJU19PUEVOSU5HKSA9PT0gT1BFTklORykgewogICAgICBzdHJlYW0uX2R1cGxleFN0YXRlID0gKHN0cmVhbS5fZHVwbGV4U3RhdGUgfCBBQ1RJVkUpICYgTk9UX09QRU5JTkcKICAgICAgc3RyZWFtLl9vcGVuKGFmdGVyT3Blbi5iaW5kKHRoaXMpKQogICAgfQogIH0KCiAgY29udGludWVVcGRhdGUgKCkgewogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX05FWFRfVElDSykgPT09IDApIHJldHVybiBmYWxzZQogICAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICY9IFJFQURfTk9UX05FWFRfVElDSwogICAgcmV0dXJuIHRydWUKICB9CgogIHVwZGF0ZUNhbGxiYWNrICgpIHsKICAgIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9VUERBVEVfU1lOQ19TVEFUVVMpID09PSBSRUFEX1BSSU1BUlkpIHRoaXMudXBkYXRlKCkKICAgIGVsc2UgdGhpcy51cGRhdGVOZXh0VGljaygpCiAgfQoKICB1cGRhdGVOZXh0VGlja0lmT3BlbiAoKSB7CiAgICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfTkVYVF9USUNLX09SX09QRU5JTkcpICE9PSAwKSByZXR1cm4KICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX05FWFRfVElDSwogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1VQREFUSU5HKSA9PT0gMCkgcW10KHRoaXMuYWZ0ZXJVcGRhdGVOZXh0VGljaykKICB9CgogIHVwZGF0ZU5leHRUaWNrICgpIHsKICAgIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9ORVhUX1RJQ0spICE9PSAwKSByZXR1cm4KICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX05FWFRfVElDSwogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1VQREFUSU5HKSA9PT0gMCkgcW10KHRoaXMuYWZ0ZXJVcGRhdGVOZXh0VGljaykKICB9Cn0KCmNsYXNzIFRyYW5zZm9ybVN0YXRlIHsKICBjb25zdHJ1Y3RvciAoc3RyZWFtKSB7CiAgICB0aGlzLmRhdGEgPSBudWxsCiAgICB0aGlzLmFmdGVyVHJhbnNmb3JtID0gYWZ0ZXJUcmFuc2Zvcm0uYmluZChzdHJlYW0pCiAgICB0aGlzLmFmdGVyRmluYWwgPSBudWxsCiAgfQp9CgpjbGFzcyBQaXBlbGluZSB7CiAgY29uc3RydWN0b3IgKHNyYywgZHN0LCBjYikgewogICAgdGhpcy5mcm9tID0gc3JjCiAgICB0aGlzLnRvID0gZHN0CiAgICB0aGlzLmFmdGVyUGlwZSA9IGNiCiAgICB0aGlzLmVycm9yID0gbnVsbAogICAgdGhpcy5waXBlVG9GaW5pc2hlZCA9IGZhbHNlCiAgfQoKICBmaW5pc2hlZCAoKSB7CiAgICB0aGlzLnBpcGVUb0ZpbmlzaGVkID0gdHJ1ZQogIH0KCiAgZG9uZSAoc3RyZWFtLCBlcnIpIHsKICAgIGlmIChlcnIpIHRoaXMuZXJyb3IgPSBlcnIKCiAgICBpZiAoc3RyZWFtID09PSB0aGlzLnRvKSB7CiAgICAgIHRoaXMudG8gPSBudWxsCgogICAgICBpZiAodGhpcy5mcm9tICE9PSBudWxsKSB7CiAgICAgICAgaWYgKCh0aGlzLmZyb20uX2R1cGxleFN0YXRlICYgUkVBRF9ET05FKSA9PT0gMCB8fCAhdGhpcy5waXBlVG9GaW5pc2hlZCkgewogICAgICAgICAgdGhpcy5mcm9tLmRlc3Ryb3kodGhpcy5lcnJvciB8fCBuZXcgRXJyb3IoJ1dyaXRhYmxlIHN0cmVhbSBjbG9zZWQgcHJlbWF0dXJlbHknKSkKICAgICAgICB9CiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0KCiAgICBpZiAoc3RyZWFtID09PSB0aGlzLmZyb20pIHsKICAgICAgdGhpcy5mcm9tID0gbnVsbAoKICAgICAgaWYgKHRoaXMudG8gIT09IG51bGwpIHsKICAgICAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX0RPTkUpID09PSAwKSB7CiAgICAgICAgICB0aGlzLnRvLmRlc3Ryb3kodGhpcy5lcnJvciB8fCBuZXcgRXJyb3IoJ1JlYWRhYmxlIHN0cmVhbSBjbG9zZWQgYmVmb3JlIGVuZGluZycpKQogICAgICAgIH0KICAgICAgICByZXR1cm4KICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLmFmdGVyUGlwZSAhPT0gbnVsbCkgdGhpcy5hZnRlclBpcGUodGhpcy5lcnJvcikKICAgIHRoaXMudG8gPSB0aGlzLmZyb20gPSB0aGlzLmFmdGVyUGlwZSA9IG51bGwKICB9Cn0KCmZ1bmN0aW9uIGFmdGVyRHJhaW4gKCkgewogIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX1BJUEVfRFJBSU5FRAogIHRoaXMudXBkYXRlQ2FsbGJhY2soKQp9CgpmdW5jdGlvbiBhZnRlckZpbmFsIChlcnIpIHsKICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQogIGlmIChlcnIpIHN0cmVhbS5kZXN0cm95KGVycikKICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBERVNUUk9ZX1NUQVRVUykgPT09IDApIHsKICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gV1JJVEVfRE9ORQogICAgc3RyZWFtLmVtaXQoJ2ZpbmlzaCcpCiAgfQogIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIEFVVE9fREVTVFJPWSkgPT09IERPTkUpIHsKICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gREVTVFJPWUlORwogIH0KCiAgc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBXUklURV9OT1RfRklOSVNISU5HCgogIC8vIG5vIG5lZWQgdG8gd2FpdCB0aGUgZXh0cmEgdGljayBoZXJlLCBzbyB3ZSBzaG9ydCBjaXJjdWl0IHRoYXQKICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9VUERBVElORykgPT09IDApIHRoaXMudXBkYXRlKCkKICBlbHNlIHRoaXMudXBkYXRlTmV4dFRpY2soKQp9CgpmdW5jdGlvbiBhZnRlckRlc3Ryb3kgKGVycikgewogIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCgogIGlmICghZXJyICYmIHRoaXMuZXJyb3IgIT09IFNUUkVBTV9ERVNUUk9ZRUQpIGVyciA9IHRoaXMuZXJyb3IKICBpZiAoZXJyKSBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcnIpCiAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBERVNUUk9ZRUQKICBzdHJlYW0uZW1pdCgnY2xvc2UnKQoKICBjb25zdCBycyA9IHN0cmVhbS5fcmVhZGFibGVTdGF0ZQogIGNvbnN0IHdzID0gc3RyZWFtLl93cml0YWJsZVN0YXRlCgogIGlmIChycyAhPT0gbnVsbCAmJiBycy5waXBlbGluZSAhPT0gbnVsbCkgcnMucGlwZWxpbmUuZG9uZShzdHJlYW0sIGVycikKCiAgaWYgKHdzICE9PSBudWxsKSB7CiAgICB3aGlsZSAod3MuZHJhaW5zICE9PSBudWxsICYmIHdzLmRyYWlucy5sZW5ndGggPiAwKSB3cy5kcmFpbnMuc2hpZnQoKS5yZXNvbHZlKGZhbHNlKQogICAgaWYgKHdzLnBpcGVsaW5lICE9PSBudWxsKSB3cy5waXBlbGluZS5kb25lKHN0cmVhbSwgZXJyKQogIH0KfQoKZnVuY3Rpb24gYWZ0ZXJXcml0ZSAoZXJyKSB7CiAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgaWYgKGVycikgc3RyZWFtLmRlc3Ryb3koZXJyKQogIHN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gV1JJVEVfTk9UX0FDVElWRQoKICBpZiAodGhpcy5kcmFpbnMgIT09IG51bGwpIHRpY2tEcmFpbnModGhpcy5kcmFpbnMpCgogIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX0RSQUlOX1NUQVRVUykgPT09IFdSSVRFX1VORFJBSU5FRCkgewogICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBXUklURV9EUkFJTkVECiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9FTUlUX0RSQUlOKSA9PT0gV1JJVEVfRU1JVF9EUkFJTikgewogICAgICBzdHJlYW0uZW1pdCgnZHJhaW4nKQogICAgfQogIH0KCiAgdGhpcy51cGRhdGVDYWxsYmFjaygpCn0KCmZ1bmN0aW9uIGFmdGVyUmVhZCAoZXJyKSB7CiAgaWYgKGVycikgdGhpcy5zdHJlYW0uZGVzdHJveShlcnIpCiAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICY9IFJFQURfTk9UX0FDVElWRQogIGlmICh0aGlzLnJlYWRBaGVhZCA9PT0gZmFsc2UgJiYgKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfUkVTVU1FRCkgPT09IDApIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBSRUFEX05PX1JFQURfQUhFQUQKICB0aGlzLnVwZGF0ZUNhbGxiYWNrKCkKfQoKZnVuY3Rpb24gdXBkYXRlUmVhZE5UICgpIHsKICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfVVBEQVRJTkcpID09PSAwKSB7CiAgICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gUkVBRF9OT1RfTkVYVF9USUNLCiAgICB0aGlzLnVwZGF0ZSgpCiAgfQp9CgpmdW5jdGlvbiB1cGRhdGVXcml0ZU5UICgpIHsKICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX1VQREFUSU5HKSA9PT0gMCkgewogICAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICY9IFdSSVRFX05PVF9ORVhUX1RJQ0sKICAgIHRoaXMudXBkYXRlKCkKICB9Cn0KCmZ1bmN0aW9uIHRpY2tEcmFpbnMgKGRyYWlucykgewogIGZvciAobGV0IGkgPSAwOyBpIDwgZHJhaW5zLmxlbmd0aDsgaSsrKSB7CiAgICAvLyBkcmFpbnMud3JpdGVzIGFyZSBtb25vdG9uaWMsIHNvIGlmIG9uZSBpcyAwIGl0cyBhbHdheXMgdGhlIGZpcnN0IG9uZQogICAgaWYgKC0tZHJhaW5zW2ldLndyaXRlcyA9PT0gMCkgewogICAgICBkcmFpbnMuc2hpZnQoKS5yZXNvbHZlKHRydWUpCiAgICAgIGktLQogICAgfQogIH0KfQoKZnVuY3Rpb24gYWZ0ZXJPcGVuIChlcnIpIHsKICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQoKICBpZiAoZXJyKSBzdHJlYW0uZGVzdHJveShlcnIpCgogIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIERFU1RST1lJTkcpID09PSAwKSB7CiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1BSSU1BUllfU1RBVFVTKSA9PT0gMCkgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX1BSSU1BUlkKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX1BSSU1BUllfU1RBVFVTKSA9PT0gMCkgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9QUklNQVJZCiAgICBzdHJlYW0uZW1pdCgnb3BlbicpCiAgfQoKICBzdHJlYW0uX2R1cGxleFN0YXRlICY9IE5PVF9BQ1RJVkUKCiAgaWYgKHN0cmVhbS5fd3JpdGFibGVTdGF0ZSAhPT0gbnVsbCkgewogICAgc3RyZWFtLl93cml0YWJsZVN0YXRlLnVwZGF0ZUNhbGxiYWNrKCkKICB9CgogIGlmIChzdHJlYW0uX3JlYWRhYmxlU3RhdGUgIT09IG51bGwpIHsKICAgIHN0cmVhbS5fcmVhZGFibGVTdGF0ZS51cGRhdGVDYWxsYmFjaygpCiAgfQp9CgpmdW5jdGlvbiBhZnRlclRyYW5zZm9ybSAoZXJyLCBkYXRhKSB7CiAgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCAmJiBkYXRhICE9PSBudWxsKSB0aGlzLnB1c2goZGF0YSkKICB0aGlzLl93cml0YWJsZVN0YXRlLmFmdGVyV3JpdGUoZXJyKQp9CgpmdW5jdGlvbiBuZXdMaXN0ZW5lciAobmFtZSkgewogIGlmICh0aGlzLl9yZWFkYWJsZVN0YXRlICE9PSBudWxsKSB7CiAgICBpZiAobmFtZSA9PT0gJ2RhdGEnKSB7CiAgICAgIHRoaXMuX2R1cGxleFN0YXRlIHw9IChSRUFEX0VNSVRfREFUQSB8IFJFQURfUkVTVU1FRF9SRUFEX0FIRUFEKQogICAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIH0KICAgIGlmIChuYW1lID09PSAncmVhZGFibGUnKSB7CiAgICAgIHRoaXMuX2R1cGxleFN0YXRlIHw9IFJFQURfRU1JVF9SRUFEQUJMRQogICAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIH0KICB9CgogIGlmICh0aGlzLl93cml0YWJsZVN0YXRlICE9PSBudWxsKSB7CiAgICBpZiAobmFtZSA9PT0gJ2RyYWluJykgewogICAgICB0aGlzLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9FTUlUX0RSQUlOCiAgICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgfQogIH0KfQoKY2xhc3MgU3RyZWFtIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvciAob3B0cykgewogICAgc3VwZXIoKQoKICAgIHRoaXMuX2R1cGxleFN0YXRlID0gMAogICAgdGhpcy5fcmVhZGFibGVTdGF0ZSA9IG51bGwKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUgPSBudWxsCgogICAgaWYgKG9wdHMpIHsKICAgICAgaWYgKG9wdHMub3BlbikgdGhpcy5fb3BlbiA9IG9wdHMub3BlbgogICAgICBpZiAob3B0cy5kZXN0cm95KSB0aGlzLl9kZXN0cm95ID0gb3B0cy5kZXN0cm95CiAgICAgIGlmIChvcHRzLnByZWRlc3Ryb3kpIHRoaXMuX3ByZWRlc3Ryb3kgPSBvcHRzLnByZWRlc3Ryb3kKICAgICAgaWYgKG9wdHMuc2lnbmFsKSB7CiAgICAgICAgb3B0cy5zaWduYWwuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBhYm9ydC5iaW5kKHRoaXMpKQogICAgICB9CiAgICB9CgogICAgdGhpcy5vbignbmV3TGlzdGVuZXInLCBuZXdMaXN0ZW5lcikKICB9CgogIF9vcGVuIChjYikgewogICAgY2IobnVsbCkKICB9CgogIF9kZXN0cm95IChjYikgewogICAgY2IobnVsbCkKICB9CgogIF9wcmVkZXN0cm95ICgpIHsKICAgIC8vIGRvZXMgbm90aGluZwogIH0KCiAgZ2V0IHJlYWRhYmxlICgpIHsKICAgIHJldHVybiB0aGlzLl9yZWFkYWJsZVN0YXRlICE9PSBudWxsID8gdHJ1ZSA6IHVuZGVmaW5lZAogIH0KCiAgZ2V0IHdyaXRhYmxlICgpIHsKICAgIHJldHVybiB0aGlzLl93cml0YWJsZVN0YXRlICE9PSBudWxsID8gdHJ1ZSA6IHVuZGVmaW5lZAogIH0KCiAgZ2V0IGRlc3Ryb3llZCAoKSB7CiAgICByZXR1cm4gKHRoaXMuX2R1cGxleFN0YXRlICYgREVTVFJPWUVEKSAhPT0gMAogIH0KCiAgZ2V0IGRlc3Ryb3lpbmcgKCkgewogICAgcmV0dXJuICh0aGlzLl9kdXBsZXhTdGF0ZSAmIERFU1RST1lfU1RBVFVTKSAhPT0gMAogIH0KCiAgZGVzdHJveSAoZXJyKSB7CiAgICBpZiAoKHRoaXMuX2R1cGxleFN0YXRlICYgREVTVFJPWV9TVEFUVVMpID09PSAwKSB7CiAgICAgIGlmICghZXJyKSBlcnIgPSBTVFJFQU1fREVTVFJPWUVECiAgICAgIHRoaXMuX2R1cGxleFN0YXRlID0gKHRoaXMuX2R1cGxleFN0YXRlIHwgREVTVFJPWUlORykgJiBOT05fUFJJTUFSWQoKICAgICAgaWYgKHRoaXMuX3JlYWRhYmxlU3RhdGUgIT09IG51bGwpIHsKICAgICAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLmhpZ2hXYXRlck1hcmsgPSAwCiAgICAgICAgdGhpcy5fcmVhZGFibGVTdGF0ZS5lcnJvciA9IGVycgogICAgICB9CiAgICAgIGlmICh0aGlzLl93cml0YWJsZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy5fd3JpdGFibGVTdGF0ZS5oaWdoV2F0ZXJNYXJrID0gMAogICAgICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUuZXJyb3IgPSBlcnIKICAgICAgfQoKICAgICAgdGhpcy5fZHVwbGV4U3RhdGUgfD0gUFJFREVTVFJPWUlORwogICAgICB0aGlzLl9wcmVkZXN0cm95KCkKICAgICAgdGhpcy5fZHVwbGV4U3RhdGUgJj0gTk9UX1BSRURFU1RST1lJTkcKCiAgICAgIGlmICh0aGlzLl9yZWFkYWJsZVN0YXRlICE9PSBudWxsKSB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgICAgaWYgKHRoaXMuX3dyaXRhYmxlU3RhdGUgIT09IG51bGwpIHRoaXMuX3dyaXRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgfQogIH0KfQoKY2xhc3MgUmVhZGFibGUgZXh0ZW5kcyBTdHJlYW0gewogIGNvbnN0cnVjdG9yIChvcHRzKSB7CiAgICBzdXBlcihvcHRzKQoKICAgIHRoaXMuX2R1cGxleFN0YXRlIHw9IE9QRU5JTkcgfCBXUklURV9ET05FIHwgUkVBRF9SRUFEX0FIRUFECiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlID0gbmV3IFJlYWRhYmxlU3RhdGUodGhpcywgb3B0cykKCiAgICBpZiAob3B0cykgewogICAgICBpZiAodGhpcy5fcmVhZGFibGVTdGF0ZS5yZWFkQWhlYWQgPT09IGZhbHNlKSB0aGlzLl9kdXBsZXhTdGF0ZSAmPSBSRUFEX05PX1JFQURfQUhFQUQKICAgICAgaWYgKG9wdHMucmVhZCkgdGhpcy5fcmVhZCA9IG9wdHMucmVhZAogICAgICBpZiAob3B0cy5lYWdlck9wZW4pIHRoaXMuX3JlYWRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgICBpZiAob3B0cy5lbmNvZGluZykgdGhpcy5zZXRFbmNvZGluZyhvcHRzLmVuY29kaW5nKQogICAgfQogIH0KCiAgc2V0RW5jb2RpbmcgKGVuY29kaW5nKSB7CiAgICBjb25zdCBkZWMgPSBuZXcgVGV4dERlY29kZXIoZW5jb2RpbmcpCiAgICBjb25zdCBtYXAgPSB0aGlzLl9yZWFkYWJsZVN0YXRlLm1hcCB8fCBlY2hvCiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLm1hcCA9IG1hcE9yU2tpcAogICAgcmV0dXJuIHRoaXMKCiAgICBmdW5jdGlvbiBtYXBPclNraXAgKGRhdGEpIHsKICAgICAgY29uc3QgbmV4dCA9IGRlYy5wdXNoKGRhdGEpCiAgICAgIHJldHVybiBuZXh0ID09PSAnJyAmJiAoZGF0YS5ieXRlTGVuZ3RoICE9PSAwIHx8IGRlYy5yZW1haW5pbmcgPiAwKSA/IG51bGwgOiBtYXAobmV4dCkKICAgIH0KICB9CgogIF9yZWFkIChjYikgewogICAgY2IobnVsbCkKICB9CgogIHBpcGUgKGRlc3QsIGNiKSB7CiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUucGlwZShkZXN0LCBjYikKICAgIHJldHVybiBkZXN0CiAgfQoKICByZWFkICgpIHsKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgcmV0dXJuIHRoaXMuX3JlYWRhYmxlU3RhdGUucmVhZCgpCiAgfQoKICBwdXNoIChkYXRhKSB7CiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrSWZPcGVuKCkKICAgIHJldHVybiB0aGlzLl9yZWFkYWJsZVN0YXRlLnB1c2goZGF0YSkKICB9CgogIHVuc2hpZnQgKGRhdGEpIHsKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2tJZk9wZW4oKQogICAgcmV0dXJuIHRoaXMuX3JlYWRhYmxlU3RhdGUudW5zaGlmdChkYXRhKQogIH0KCiAgcmVzdW1lICgpIHsKICAgIHRoaXMuX2R1cGxleFN0YXRlIHw9IFJFQURfUkVTVU1FRF9SRUFEX0FIRUFECiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIHJldHVybiB0aGlzCiAgfQoKICBwYXVzZSAoKSB7CiAgICB0aGlzLl9kdXBsZXhTdGF0ZSAmPSAodGhpcy5fcmVhZGFibGVTdGF0ZS5yZWFkQWhlYWQgPT09IGZhbHNlID8gUkVBRF9QQVVTRURfTk9fUkVBRF9BSEVBRCA6IFJFQURfUEFVU0VEKQogICAgcmV0dXJuIHRoaXMKICB9CgogIHN0YXRpYyBfZnJvbUFzeW5jSXRlcmF0b3IgKGl0ZSwgb3B0cykgewogICAgbGV0IGRlc3Ryb3kKCiAgICBjb25zdCBycyA9IG5ldyBSZWFkYWJsZSh7CiAgICAgIC4uLm9wdHMsCiAgICAgIHJlYWQgKGNiKSB7CiAgICAgICAgaXRlLm5leHQoKS50aGVuKHB1c2gpLnRoZW4oY2IuYmluZChudWxsLCBudWxsKSkuY2F0Y2goY2IpCiAgICAgIH0sCiAgICAgIHByZWRlc3Ryb3kgKCkgewogICAgICAgIGRlc3Ryb3kgPSBpdGUucmV0dXJuKCkKICAgICAgfSwKICAgICAgZGVzdHJveSAoY2IpIHsKICAgICAgICBpZiAoIWRlc3Ryb3kpIHJldHVybiBjYihudWxsKQogICAgICAgIGRlc3Ryb3kudGhlbihjYi5iaW5kKG51bGwsIG51bGwpKS5jYXRjaChjYikKICAgICAgfQogICAgfSkKCiAgICByZXR1cm4gcnMKCiAgICBmdW5jdGlvbiBwdXNoIChkYXRhKSB7CiAgICAgIGlmIChkYXRhLmRvbmUpIHJzLnB1c2gobnVsbCkKICAgICAgZWxzZSBycy5wdXNoKGRhdGEudmFsdWUpCiAgICB9CiAgfQoKICBzdGF0aWMgZnJvbSAoZGF0YSwgb3B0cykgewogICAgaWYgKGlzUmVhZFN0cmVhbXgoZGF0YSkpIHJldHVybiBkYXRhCiAgICBpZiAoZGF0YVthc3luY0l0ZXJhdG9yXSkgcmV0dXJuIHRoaXMuX2Zyb21Bc3luY0l0ZXJhdG9yKGRhdGFbYXN5bmNJdGVyYXRvcl0oKSwgb3B0cykKICAgIGlmICghQXJyYXkuaXNBcnJheShkYXRhKSkgZGF0YSA9IGRhdGEgPT09IHVuZGVmaW5lZCA/IFtdIDogW2RhdGFdCgogICAgbGV0IGkgPSAwCiAgICByZXR1cm4gbmV3IFJlYWRhYmxlKHsKICAgICAgLi4ub3B0cywKICAgICAgcmVhZCAoY2IpIHsKICAgICAgICB0aGlzLnB1c2goaSA9PT0gZGF0YS5sZW5ndGggPyBudWxsIDogZGF0YVtpKytdKQogICAgICAgIGNiKG51bGwpCiAgICAgIH0KICAgIH0pCiAgfQoKICBzdGF0aWMgaXNCYWNrcHJlc3N1cmVkIChycykgewogICAgcmV0dXJuIChycy5fZHVwbGV4U3RhdGUgJiBSRUFEX0JBQ0tQUkVTU1VSRV9TVEFUVVMpICE9PSAwIHx8IHJzLl9yZWFkYWJsZVN0YXRlLmJ1ZmZlcmVkID49IHJzLl9yZWFkYWJsZVN0YXRlLmhpZ2hXYXRlck1hcmsKICB9CgogIHN0YXRpYyBpc1BhdXNlZCAocnMpIHsKICAgIHJldHVybiAocnMuX2R1cGxleFN0YXRlICYgUkVBRF9SRVNVTUVEKSA9PT0gMAogIH0KCiAgW2FzeW5jSXRlcmF0b3JdICgpIHsKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMKCiAgICBsZXQgZXJyb3IgPSBudWxsCiAgICBsZXQgcHJvbWlzZVJlc29sdmUgPSBudWxsCiAgICBsZXQgcHJvbWlzZVJlamVjdCA9IG51bGwKCiAgICB0aGlzLm9uKCdlcnJvcicsIChlcnIpID0+IHsgZXJyb3IgPSBlcnIgfSkKICAgIHRoaXMub24oJ3JlYWRhYmxlJywgb25yZWFkYWJsZSkKICAgIHRoaXMub24oJ2Nsb3NlJywgb25jbG9zZSkKCiAgICByZXR1cm4gewogICAgICBbYXN5bmNJdGVyYXRvcl0gKCkgewogICAgICAgIHJldHVybiB0aGlzCiAgICAgIH0sCiAgICAgIG5leHQgKCkgewogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBwcm9taXNlUmVzb2x2ZSA9IHJlc29sdmUKICAgICAgICAgIHByb21pc2VSZWplY3QgPSByZWplY3QKICAgICAgICAgIGNvbnN0IGRhdGEgPSBzdHJlYW0ucmVhZCgpCiAgICAgICAgICBpZiAoZGF0YSAhPT0gbnVsbCkgb25kYXRhKGRhdGEpCiAgICAgICAgICBlbHNlIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIERFU1RST1lFRCkgIT09IDApIG9uZGF0YShudWxsKQogICAgICAgIH0pCiAgICAgIH0sCiAgICAgIHJldHVybiAoKSB7CiAgICAgICAgcmV0dXJuIGRlc3Ryb3kobnVsbCkKICAgICAgfSwKICAgICAgdGhyb3cgKGVycikgewogICAgICAgIHJldHVybiBkZXN0cm95KGVycikKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG9ucmVhZGFibGUgKCkgewogICAgICBpZiAocHJvbWlzZVJlc29sdmUgIT09IG51bGwpIG9uZGF0YShzdHJlYW0ucmVhZCgpKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uY2xvc2UgKCkgewogICAgICBpZiAocHJvbWlzZVJlc29sdmUgIT09IG51bGwpIG9uZGF0YShudWxsKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uZGF0YSAoZGF0YSkgewogICAgICBpZiAocHJvbWlzZVJlamVjdCA9PT0gbnVsbCkgcmV0dXJuCiAgICAgIGlmIChlcnJvcikgcHJvbWlzZVJlamVjdChlcnJvcikKICAgICAgZWxzZSBpZiAoZGF0YSA9PT0gbnVsbCAmJiAoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfRE9ORSkgPT09IDApIHByb21pc2VSZWplY3QoU1RSRUFNX0RFU1RST1lFRCkKICAgICAgZWxzZSBwcm9taXNlUmVzb2x2ZSh7IHZhbHVlOiBkYXRhLCBkb25lOiBkYXRhID09PSBudWxsIH0pCiAgICAgIHByb21pc2VSZWplY3QgPSBwcm9taXNlUmVzb2x2ZSA9IG51bGwKICAgIH0KCiAgICBmdW5jdGlvbiBkZXN0cm95IChlcnIpIHsKICAgICAgc3RyZWFtLmRlc3Ryb3koZXJyKQogICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgIGlmIChzdHJlYW0uX2R1cGxleFN0YXRlICYgREVTVFJPWUVEKSByZXR1cm4gcmVzb2x2ZSh7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfSkKICAgICAgICBzdHJlYW0ub25jZSgnY2xvc2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoZXJyKSByZWplY3QoZXJyKQogICAgICAgICAgZWxzZSByZXNvbHZlKHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9KQogICAgICAgIH0pCiAgICAgIH0pCiAgICB9CiAgfQp9CgpjbGFzcyBXcml0YWJsZSBleHRlbmRzIFN0cmVhbSB7CiAgY29uc3RydWN0b3IgKG9wdHMpIHsKICAgIHN1cGVyKG9wdHMpCgogICAgdGhpcy5fZHVwbGV4U3RhdGUgfD0gT1BFTklORyB8IFJFQURfRE9ORQogICAgdGhpcy5fd3JpdGFibGVTdGF0ZSA9IG5ldyBXcml0YWJsZVN0YXRlKHRoaXMsIG9wdHMpCgogICAgaWYgKG9wdHMpIHsKICAgICAgaWYgKG9wdHMud3JpdGV2KSB0aGlzLl93cml0ZXYgPSBvcHRzLndyaXRldgogICAgICBpZiAob3B0cy53cml0ZSkgdGhpcy5fd3JpdGUgPSBvcHRzLndyaXRlCiAgICAgIGlmIChvcHRzLmZpbmFsKSB0aGlzLl9maW5hbCA9IG9wdHMuZmluYWwKICAgICAgaWYgKG9wdHMuZWFnZXJPcGVuKSB0aGlzLl93cml0YWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIH0KICB9CgogIGNvcmsgKCkgewogICAgdGhpcy5fZHVwbGV4U3RhdGUgfD0gV1JJVEVfQ09SS0VECiAgfQoKICB1bmNvcmsgKCkgewogICAgdGhpcy5fZHVwbGV4U3RhdGUgJj0gV1JJVEVfTk9UX0NPUktFRAogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgfQoKICBfd3JpdGV2IChiYXRjaCwgY2IpIHsKICAgIGNiKG51bGwpCiAgfQoKICBfd3JpdGUgKGRhdGEsIGNiKSB7CiAgICB0aGlzLl93cml0YWJsZVN0YXRlLmF1dG9CYXRjaChkYXRhLCBjYikKICB9CgogIF9maW5hbCAoY2IpIHsKICAgIGNiKG51bGwpCiAgfQoKICBzdGF0aWMgaXNCYWNrcHJlc3N1cmVkICh3cykgewogICAgcmV0dXJuICh3cy5fZHVwbGV4U3RhdGUgJiBXUklURV9CQUNLUFJFU1NVUkVfU1RBVFVTKSAhPT0gMAogIH0KCiAgc3RhdGljIGRyYWluZWQgKHdzKSB7CiAgICBpZiAod3MuZGVzdHJveWVkKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKQogICAgY29uc3Qgc3RhdGUgPSB3cy5fd3JpdGFibGVTdGF0ZQogICAgY29uc3QgcGVuZGluZyA9IChpc1dyaXRldih3cykgPyBNYXRoLm1pbigxLCBzdGF0ZS5xdWV1ZS5sZW5ndGgpIDogc3RhdGUucXVldWUubGVuZ3RoKQogICAgY29uc3Qgd3JpdGVzID0gcGVuZGluZyArICgod3MuX2R1cGxleFN0YXRlICYgV1JJVEVfV1JJVElORykgPyAxIDogMCkKICAgIGlmICh3cml0ZXMgPT09IDApIHJldHVybiBQcm9taXNlLnJlc29sdmUodHJ1ZSkKICAgIGlmIChzdGF0ZS5kcmFpbnMgPT09IG51bGwpIHN0YXRlLmRyYWlucyA9IFtdCiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgc3RhdGUuZHJhaW5zLnB1c2goeyB3cml0ZXMsIHJlc29sdmUgfSkKICAgIH0pCiAgfQoKICB3cml0ZSAoZGF0YSkgewogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICByZXR1cm4gdGhpcy5fd3JpdGFibGVTdGF0ZS5wdXNoKGRhdGEpCiAgfQoKICBlbmQgKGRhdGEpIHsKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS5lbmQoZGF0YSkKICAgIHJldHVybiB0aGlzCiAgfQp9CgpjbGFzcyBEdXBsZXggZXh0ZW5kcyBSZWFkYWJsZSB7IC8vIGFuZCBXcml0YWJsZQogIGNvbnN0cnVjdG9yIChvcHRzKSB7CiAgICBzdXBlcihvcHRzKQoKICAgIHRoaXMuX2R1cGxleFN0YXRlID0gT1BFTklORyB8ICh0aGlzLl9kdXBsZXhTdGF0ZSAmIFJFQURfUkVBRF9BSEVBRCkKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUgPSBuZXcgV3JpdGFibGVTdGF0ZSh0aGlzLCBvcHRzKQoKICAgIGlmIChvcHRzKSB7CiAgICAgIGlmIChvcHRzLndyaXRldikgdGhpcy5fd3JpdGV2ID0gb3B0cy53cml0ZXYKICAgICAgaWYgKG9wdHMud3JpdGUpIHRoaXMuX3dyaXRlID0gb3B0cy53cml0ZQogICAgICBpZiAob3B0cy5maW5hbCkgdGhpcy5fZmluYWwgPSBvcHRzLmZpbmFsCiAgICB9CiAgfQoKICBjb3JrICgpIHsKICAgIHRoaXMuX2R1cGxleFN0YXRlIHw9IFdSSVRFX0NPUktFRAogIH0KCiAgdW5jb3JrICgpIHsKICAgIHRoaXMuX2R1cGxleFN0YXRlICY9IFdSSVRFX05PVF9DT1JLRUQKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogIH0KCiAgX3dyaXRldiAoYmF0Y2gsIGNiKSB7CiAgICBjYihudWxsKQogIH0KCiAgX3dyaXRlIChkYXRhLCBjYikgewogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS5hdXRvQmF0Y2goZGF0YSwgY2IpCiAgfQoKICBfZmluYWwgKGNiKSB7CiAgICBjYihudWxsKQogIH0KCiAgd3JpdGUgKGRhdGEpIHsKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgcmV0dXJuIHRoaXMuX3dyaXRhYmxlU3RhdGUucHVzaChkYXRhKQogIH0KCiAgZW5kIChkYXRhKSB7CiAgICB0aGlzLl93cml0YWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUuZW5kKGRhdGEpCiAgICByZXR1cm4gdGhpcwogIH0KfQoKY2xhc3MgVHJhbnNmb3JtIGV4dGVuZHMgRHVwbGV4IHsKICBjb25zdHJ1Y3RvciAob3B0cykgewogICAgc3VwZXIob3B0cykKICAgIHRoaXMuX3RyYW5zZm9ybVN0YXRlID0gbmV3IFRyYW5zZm9ybVN0YXRlKHRoaXMpCgogICAgaWYgKG9wdHMpIHsKICAgICAgaWYgKG9wdHMudHJhbnNmb3JtKSB0aGlzLl90cmFuc2Zvcm0gPSBvcHRzLnRyYW5zZm9ybQogICAgICBpZiAob3B0cy5mbHVzaCkgdGhpcy5fZmx1c2ggPSBvcHRzLmZsdXNoCiAgICB9CiAgfQoKICBfd3JpdGUgKGRhdGEsIGNiKSB7CiAgICBpZiAodGhpcy5fcmVhZGFibGVTdGF0ZS5idWZmZXJlZCA+PSB0aGlzLl9yZWFkYWJsZVN0YXRlLmhpZ2hXYXRlck1hcmspIHsKICAgICAgdGhpcy5fdHJhbnNmb3JtU3RhdGUuZGF0YSA9IGRhdGEKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3RyYW5zZm9ybShkYXRhLCB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5hZnRlclRyYW5zZm9ybSkKICAgIH0KICB9CgogIF9yZWFkIChjYikgewogICAgaWYgKHRoaXMuX3RyYW5zZm9ybVN0YXRlLmRhdGEgIT09IG51bGwpIHsKICAgICAgY29uc3QgZGF0YSA9IHRoaXMuX3RyYW5zZm9ybVN0YXRlLmRhdGEKICAgICAgdGhpcy5fdHJhbnNmb3JtU3RhdGUuZGF0YSA9IG51bGwKICAgICAgY2IobnVsbCkKICAgICAgdGhpcy5fdHJhbnNmb3JtKGRhdGEsIHRoaXMuX3RyYW5zZm9ybVN0YXRlLmFmdGVyVHJhbnNmb3JtKQogICAgfSBlbHNlIHsKICAgICAgY2IobnVsbCkKICAgIH0KICB9CgogIGRlc3Ryb3kgKGVycikgewogICAgc3VwZXIuZGVzdHJveShlcnIpCiAgICBpZiAodGhpcy5fdHJhbnNmb3JtU3RhdGUuZGF0YSAhPT0gbnVsbCkgewogICAgICB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5kYXRhID0gbnVsbAogICAgICB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5hZnRlclRyYW5zZm9ybSgpCiAgICB9CiAgfQoKICBfdHJhbnNmb3JtIChkYXRhLCBjYikgewogICAgY2IobnVsbCwgZGF0YSkKICB9CgogIF9mbHVzaCAoY2IpIHsKICAgIGNiKG51bGwpCiAgfQoKICBfZmluYWwgKGNiKSB7CiAgICB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5hZnRlckZpbmFsID0gY2IKICAgIHRoaXMuX2ZsdXNoKHRyYW5zZm9ybUFmdGVyRmx1c2guYmluZCh0aGlzKSkKICB9Cn0KCmNsYXNzIFBhc3NUaHJvdWdoIGV4dGVuZHMgVHJhbnNmb3JtIHt9CgpmdW5jdGlvbiB0cmFuc2Zvcm1BZnRlckZsdXNoIChlcnIsIGRhdGEpIHsKICBjb25zdCBjYiA9IHRoaXMuX3RyYW5zZm9ybVN0YXRlLmFmdGVyRmluYWwKICBpZiAoZXJyKSByZXR1cm4gY2IoZXJyKQogIGlmIChkYXRhICE9PSBudWxsICYmIGRhdGEgIT09IHVuZGVmaW5lZCkgdGhpcy5wdXNoKGRhdGEpCiAgdGhpcy5wdXNoKG51bGwpCiAgY2IobnVsbCkKfQoKZnVuY3Rpb24gcGlwZWxpbmVQcm9taXNlICguLi5zdHJlYW1zKSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIHJldHVybiBwaXBlbGluZSguLi5zdHJlYW1zLCAoZXJyKSA9PiB7CiAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3QoZXJyKQogICAgICByZXNvbHZlKCkKICAgIH0pCiAgfSkKfQoKZnVuY3Rpb24gcGlwZWxpbmUgKHN0cmVhbSwgLi4uc3RyZWFtcykgewogIGNvbnN0IGFsbCA9IEFycmF5LmlzQXJyYXkoc3RyZWFtKSA/IFsuLi5zdHJlYW0sIC4uLnN0cmVhbXNdIDogW3N0cmVhbSwgLi4uc3RyZWFtc10KICBjb25zdCBkb25lID0gKGFsbC5sZW5ndGggJiYgdHlwZW9mIGFsbFthbGwubGVuZ3RoIC0gMV0gPT09ICdmdW5jdGlvbicpID8gYWxsLnBvcCgpIDogbnVsbAoKICBpZiAoYWxsLmxlbmd0aCA8IDIpIHRocm93IG5ldyBFcnJvcignUGlwZWxpbmUgcmVxdWlyZXMgYXQgbGVhc3QgMiBzdHJlYW1zJykKCiAgbGV0IHNyYyA9IGFsbFswXQogIGxldCBkZXN0ID0gbnVsbAogIGxldCBlcnJvciA9IG51bGwKCiAgZm9yIChsZXQgaSA9IDE7IGkgPCBhbGwubGVuZ3RoOyBpKyspIHsKICAgIGRlc3QgPSBhbGxbaV0KCiAgICBpZiAoaXNTdHJlYW14KHNyYykpIHsKICAgICAgc3JjLnBpcGUoZGVzdCwgb25lcnJvcikKICAgIH0gZWxzZSB7CiAgICAgIGVycm9ySGFuZGxlKHNyYywgdHJ1ZSwgaSA+IDEsIG9uZXJyb3IpCiAgICAgIHNyYy5waXBlKGRlc3QpCiAgICB9CgogICAgc3JjID0gZGVzdAogIH0KCiAgaWYgKGRvbmUpIHsKICAgIGxldCBmaW4gPSBmYWxzZQoKICAgIGNvbnN0IGF1dG9EZXN0cm95ID0gaXNTdHJlYW14KGRlc3QpIHx8ICEhKGRlc3QuX3dyaXRhYmxlU3RhdGUgJiYgZGVzdC5fd3JpdGFibGVTdGF0ZS5hdXRvRGVzdHJveSkKCiAgICBkZXN0Lm9uKCdlcnJvcicsIChlcnIpID0+IHsKICAgICAgaWYgKGVycm9yID09PSBudWxsKSBlcnJvciA9IGVycgogICAgfSkKCiAgICBkZXN0Lm9uKCdmaW5pc2gnLCAoKSA9PiB7CiAgICAgIGZpbiA9IHRydWUKICAgICAgaWYgKCFhdXRvRGVzdHJveSkgZG9uZShlcnJvcikKICAgIH0pCgogICAgaWYgKGF1dG9EZXN0cm95KSB7CiAgICAgIGRlc3Qub24oJ2Nsb3NlJywgKCkgPT4gZG9uZShlcnJvciB8fCAoZmluID8gbnVsbCA6IFBSRU1BVFVSRV9DTE9TRSkpKQogICAgfQogIH0KCiAgcmV0dXJuIGRlc3QKCiAgZnVuY3Rpb24gZXJyb3JIYW5kbGUgKHMsIHJkLCB3ciwgb25lcnJvcikgewogICAgcy5vbignZXJyb3InLCBvbmVycm9yKQogICAgcy5vbignY2xvc2UnLCBvbmNsb3NlKQoKICAgIGZ1bmN0aW9uIG9uY2xvc2UgKCkgewogICAgICBpZiAocmQgJiYgcy5fcmVhZGFibGVTdGF0ZSAmJiAhcy5fcmVhZGFibGVTdGF0ZS5lbmRlZCkgcmV0dXJuIG9uZXJyb3IoUFJFTUFUVVJFX0NMT1NFKQogICAgICBpZiAod3IgJiYgcy5fd3JpdGFibGVTdGF0ZSAmJiAhcy5fd3JpdGFibGVTdGF0ZS5lbmRlZCkgcmV0dXJuIG9uZXJyb3IoUFJFTUFUVVJFX0NMT1NFKQogICAgfQogIH0KCiAgZnVuY3Rpb24gb25lcnJvciAoZXJyKSB7CiAgICBpZiAoIWVyciB8fCBlcnJvcikgcmV0dXJuCiAgICBlcnJvciA9IGVycgoKICAgIGZvciAoY29uc3QgcyBvZiBhbGwpIHsKICAgICAgcy5kZXN0cm95KGVycikKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGVjaG8gKHMpIHsKICByZXR1cm4gcwp9CgpmdW5jdGlvbiBpc1N0cmVhbSAoc3RyZWFtKSB7CiAgcmV0dXJuICEhc3RyZWFtLl9yZWFkYWJsZVN0YXRlIHx8ICEhc3RyZWFtLl93cml0YWJsZVN0YXRlCn0KCmZ1bmN0aW9uIGlzU3RyZWFteCAoc3RyZWFtKSB7CiAgcmV0dXJuIHR5cGVvZiBzdHJlYW0uX2R1cGxleFN0YXRlID09PSAnbnVtYmVyJyAmJiBpc1N0cmVhbShzdHJlYW0pCn0KCmZ1bmN0aW9uIGlzRW5kZWQgKHN0cmVhbSkgewogIHJldHVybiAhIXN0cmVhbS5fcmVhZGFibGVTdGF0ZSAmJiBzdHJlYW0uX3JlYWRhYmxlU3RhdGUuZW5kZWQKfQoKZnVuY3Rpb24gaXNGaW5pc2hlZCAoc3RyZWFtKSB7CiAgcmV0dXJuICEhc3RyZWFtLl93cml0YWJsZVN0YXRlICYmIHN0cmVhbS5fd3JpdGFibGVTdGF0ZS5lbmRlZAp9CgpmdW5jdGlvbiBnZXRTdHJlYW1FcnJvciAoc3RyZWFtLCBvcHRzID0ge30pIHsKICBjb25zdCBlcnIgPSAoc3RyZWFtLl9yZWFkYWJsZVN0YXRlICYmIHN0cmVhbS5fcmVhZGFibGVTdGF0ZS5lcnJvcikgfHwgKHN0cmVhbS5fd3JpdGFibGVTdGF0ZSAmJiBzdHJlYW0uX3dyaXRhYmxlU3RhdGUuZXJyb3IpCgogIC8vIGF2b2lkIGltcGxpY2l0IGVycm9ycyBieSBkZWZhdWx0CiAgcmV0dXJuICghb3B0cy5hbGwgJiYgZXJyID09PSBTVFJFQU1fREVTVFJPWUVEKSA/IG51bGwgOiBlcnIKfQoKZnVuY3Rpb24gaXNSZWFkU3RyZWFteCAoc3RyZWFtKSB7CiAgcmV0dXJuIGlzU3RyZWFteChzdHJlYW0pICYmIHN0cmVhbS5yZWFkYWJsZQp9CgpmdW5jdGlvbiBpc0Rpc3R1cmJlZCAoc3RyZWFtKSB7CiAgcmV0dXJuIChzdHJlYW0uX2R1cGxleFN0YXRlICYgT1BFTklORykgIT09IE9QRU5JTkcgfHwgKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBBQ1RJVkVfT1JfVElDS0lORykgIT09IDAKfQoKZnVuY3Rpb24gaXNUeXBlZEFycmF5IChkYXRhKSB7CiAgcmV0dXJuIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JyAmJiBkYXRhICE9PSBudWxsICYmIHR5cGVvZiBkYXRhLmJ5dGVMZW5ndGggPT09ICdudW1iZXInCn0KCmZ1bmN0aW9uIGRlZmF1bHRCeXRlTGVuZ3RoIChkYXRhKSB7CiAgcmV0dXJuIGlzVHlwZWRBcnJheShkYXRhKSA/IGRhdGEuYnl0ZUxlbmd0aCA6IDEwMjQKfQoKZnVuY3Rpb24gbm9vcCAoKSB7fQoKZnVuY3Rpb24gYWJvcnQgKCkgewogIHRoaXMuZGVzdHJveShuZXcgRXJyb3IoJ1N0cmVhbSBhYm9ydGVkLicpKQp9CgpmdW5jdGlvbiBpc1dyaXRldiAocykgewogIHJldHVybiBzLl93cml0ZXYgIT09IFdyaXRhYmxlLnByb3RvdHlwZS5fd3JpdGV2ICYmIHMuX3dyaXRldiAhPT0gRHVwbGV4LnByb3RvdHlwZS5fd3JpdGV2Cn0KCm1vZHVsZS5leHBvcnRzID0gewogIHBpcGVsaW5lLAogIHBpcGVsaW5lUHJvbWlzZSwKICBpc1N0cmVhbSwKICBpc1N0cmVhbXgsCiAgaXNFbmRlZCwKICBpc0ZpbmlzaGVkLAogIGlzRGlzdHVyYmVkLAogIGdldFN0cmVhbUVycm9yLAogIFN0cmVhbSwKICBXcml0YWJsZSwKICBSZWFkYWJsZSwKICBEdXBsZXgsCiAgVHJhbnNmb3JtLAogIC8vIEV4cG9ydCBQYXNzVGhyb3VnaCBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIE5vZGUuanMgY29yZSdzIHN0cmVhbSBtb2R1bGUKICBQYXNzVGhyb3VnaAp9CnsKICAibmFtZSI6ICJzdHJlYW14IiwKICAidmVyc2lvbiI6ICIyLjIzLjAiLAogICJkZXNjcmlwdGlvbiI6ICJBbiBpdGVyYXRpb24gb2YgdGhlIE5vZGUuanMgY29yZSBzdHJlYW1zIHdpdGggYSBzZXJpZXMgb2YgaW1wcm92ZW1lbnRzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJldmVudHMtdW5pdmVyc2FsIjogIl4xLjAuMCIsCiAgICAiZmFzdC1maWZvIjogIl4xLjMuMiIsCiAgICAidGV4dC1kZWNvZGVyIjogIl4xLjEuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNiIsCiAgICAiYnJpdHRsZSI6ICJeMy4xLjEiLAogICAgImVuZC1vZi1zdHJlYW0iOiAiXjEuNC40IiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBub2RlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmJhcmUiOiAic3RhbmRhcmQgJiYgYmFyZSB0ZXN0L2FsbC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zdHJlYW14LmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zdHJlYW14L2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3N0cmVhbXgiCn0KY29uc3QgY29kZWNzID0gcmVxdWlyZSgnY29kZWNzJykKY29uc3QgYiA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBTRVAgPSBiLmFsbG9jKDEpCmNvbnN0IFNFUF9CVU1QRUQgPSBiLmZyb20oWzB4MV0pCmNvbnN0IEVNUFRZID0gYi5hbGxvYygwKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBTdWJFbmNvZGVyIHsKICBjb25zdHJ1Y3RvciAocHJlZml4LCBlbmNvZGluZywgcGFyZW50ID0gbnVsbCkgewogICAgdGhpcy51c2VyRW5jb2RpbmcgPSBjb2RlY3MoZW5jb2RpbmcpCiAgICB0aGlzLnByZWZpeCA9IHByZWZpeCAhPSBudWxsID8gY3JlYXRlUHJlZml4KHByZWZpeCwgcGFyZW50KSA6IG51bGwKICAgIHRoaXMubHQgPSB0aGlzLnByZWZpeCAmJiBiLmNvbmNhdChbdGhpcy5wcmVmaXguc3ViYXJyYXkoMCwgdGhpcy5wcmVmaXguYnl0ZUxlbmd0aCAtIDEpLCBTRVBfQlVNUEVEXSkKICB9CgogIF9lbmNvZGVSYW5nZVVzZXIgKHIpIHsKICAgIGlmICh0aGlzLnVzZXJFbmNvZGluZy5lbmNvZGVSYW5nZSkgcmV0dXJuIHRoaXMudXNlckVuY29kaW5nLmVuY29kZVJhbmdlKHIpCgogICAgY29uc3QgcmVzID0ge30KICAgIGlmIChyLmd0ICE9IG51bGwpIHJlcy5ndCA9IHRoaXMudXNlckVuY29kaW5nLmVuY29kZShyLmd0KQogICAgaWYgKHIuZ3RlICE9IG51bGwpIHJlcy5ndGUgPSB0aGlzLnVzZXJFbmNvZGluZy5lbmNvZGUoci5ndGUpCiAgICBpZiAoci5sdGUgIT0gbnVsbCkgcmVzLmx0ZSA9IHRoaXMudXNlckVuY29kaW5nLmVuY29kZShyLmx0ZSkKICAgIGlmIChyLmx0ICE9IG51bGwpIHJlcy5sdCA9IHRoaXMudXNlckVuY29kaW5nLmVuY29kZShyLmx0KQoKICAgIHJldHVybiByZXMKICB9CgogIF9hZGRQcmVmaXggKGtleSkgewogICAgcmV0dXJuIHRoaXMucHJlZml4ID8gYi5jb25jYXQoW3RoaXMucHJlZml4LCBrZXldKSA6IGtleQogIH0KCiAgZW5jb2RlIChrZXkpIHsKICAgIHJldHVybiB0aGlzLl9hZGRQcmVmaXgodGhpcy51c2VyRW5jb2RpbmcuZW5jb2RlKGtleSkpCiAgfQoKICBlbmNvZGVSYW5nZSAocmFuZ2UpIHsKICAgIGNvbnN0IHIgPSB0aGlzLl9lbmNvZGVSYW5nZVVzZXIocmFuZ2UpCgogICAgaWYgKHIuZ3QpIHIuZ3QgPSB0aGlzLl9hZGRQcmVmaXgoci5ndCkKICAgIGVsc2UgaWYgKHIuZ3RlKSByLmd0ZSA9IHRoaXMuX2FkZFByZWZpeChyLmd0ZSkKICAgIGVsc2UgaWYgKHRoaXMucHJlZml4KSByLmd0ZSA9IHRoaXMucHJlZml4CgogICAgaWYgKHIubHQpIHIubHQgPSB0aGlzLl9hZGRQcmVmaXgoci5sdCkKICAgIGVsc2UgaWYgKHIubHRlKSByLmx0ZSA9IHRoaXMuX2FkZFByZWZpeChyLmx0ZSkKICAgIGVsc2UgaWYgKHRoaXMucHJlZml4KSByLmx0ID0gdGhpcy5sdAoKICAgIHJldHVybiByCiAgfQoKICBkZWNvZGUgKGtleSkgewogICAgcmV0dXJuIHRoaXMudXNlckVuY29kaW5nLmRlY29kZSh0aGlzLnByZWZpeCA/IGtleS5zdWJhcnJheSh0aGlzLnByZWZpeC5ieXRlTGVuZ3RoKSA6IGtleSkKICB9CgogIHN1YiAocHJlZml4LCBlbmNvZGluZykgewogICAgcmV0dXJuIG5ldyBTdWJFbmNvZGVyKHByZWZpeCB8fCBFTVBUWSwgY29tcGF0KGVuY29kaW5nKSwgdGhpcy5wcmVmaXgpCiAgfQp9CgpmdW5jdGlvbiBjcmVhdGVQcmVmaXggKHByZWZpeCwgcGFyZW50KSB7CiAgcHJlZml4ID0gdHlwZW9mIHByZWZpeCA9PT0gJ3N0cmluZycgPyBiLmZyb20ocHJlZml4KSA6IHByZWZpeAoKICBpZiAocHJlZml4ICYmIHBhcmVudCkgcmV0dXJuIGIuY29uY2F0KFtwYXJlbnQsIHByZWZpeCwgU0VQXSkKICBpZiAocHJlZml4KSByZXR1cm4gYi5jb25jYXQoW3ByZWZpeCwgU0VQXSkKICBpZiAocGFyZW50KSByZXR1cm4gYi5jb25jYXQoW3BhcmVudCwgU0VQXSkKICByZXR1cm4gU0VQCn0KCmZ1bmN0aW9uIGNvbXBhdCAoZW5jKSB7CiAgaWYgKGVuYyAmJiBlbmMua2V5RW5jb2RpbmcpIHJldHVybiBlbmMua2V5RW5jb2RpbmcKICByZXR1cm4gZW5jCn0KewogICJuYW1lIjogInN1Yi1lbmNvZGVyIiwKICAidmVyc2lvbiI6ICIyLjEuMyIsCiAgImRlc2NyaXB0aW9uIjogIkdlbmVyYXRlIHN1YiBlbmNvZGluZ3MgZm9yIGtleS92YWx1ZSBzdG9yZXMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC8qLmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3N1Yi1lbmNvZGVyLmdpdCIKICB9LAogICJrZXl3b3JkcyI6IFsKICAgICJrdi1zdG9yZSIsCiAgICAiZW5jb2RpbmciLAogICAgImh5cGVyYmVlIgogIF0sCiAgImF1dGhvciI6ICJBbmRyZXcgT3NoZXJvZmYgPGFuZHJld29zaEBnbWFpbC5jb20+IiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3N1Yi1lbmNvZGVyL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc3ViLWVuY29kZXIjcmVhZG1lIiwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMS4xIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjEyLjAiLAogICAgImh5cGVyYmVlIjogIl4yLjExLjAiLAogICAgImh5cGVyY29yZSI6ICJeMTAuMy4yIiwKICAgICJpbmRleC1lbmNvZGVyIjogIl4zLjAuMCIsCiAgICAicmFuZG9tLWFjY2Vzcy1tZW1vcnkiOiAiXjYuMC4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi4wIiwKICAgICJjb2RlY3MiOiAiXjMuMS4wIgogIH0KfQpjb25zdCBQYXNzVGhyb3VnaERlY29kZXIgPSByZXF1aXJlKCcuL2xpYi9wYXNzLXRocm91Z2gtZGVjb2RlcicpCmNvbnN0IFVURjhEZWNvZGVyID0gcmVxdWlyZSgnLi9saWIvdXRmOC1kZWNvZGVyJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVGV4dERlY29kZXIgewogIGNvbnN0cnVjdG9yIChlbmNvZGluZyA9ICd1dGY4JykgewogICAgdGhpcy5lbmNvZGluZyA9IG5vcm1hbGl6ZUVuY29kaW5nKGVuY29kaW5nKQoKICAgIHN3aXRjaCAodGhpcy5lbmNvZGluZykgewogICAgICBjYXNlICd1dGY4JzoKICAgICAgICB0aGlzLmRlY29kZXIgPSBuZXcgVVRGOERlY29kZXIoKQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgZW5jb2Rpbmc6ICcgKyB0aGlzLmVuY29kaW5nKQogICAgICBkZWZhdWx0OgogICAgICAgIHRoaXMuZGVjb2RlciA9IG5ldyBQYXNzVGhyb3VnaERlY29kZXIodGhpcy5lbmNvZGluZykKICAgIH0KICB9CgogIGdldCByZW1haW5pbmcgKCkgewogICAgcmV0dXJuIHRoaXMuZGVjb2Rlci5yZW1haW5pbmcKICB9CgogIHB1c2ggKGRhdGEpIHsKICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHJldHVybiBkYXRhCiAgICByZXR1cm4gdGhpcy5kZWNvZGVyLmRlY29kZShkYXRhKQogIH0KCiAgLy8gRm9yIE5vZGUuanMgY29tcGF0aWJpbGl0eQogIHdyaXRlIChkYXRhKSB7CiAgICByZXR1cm4gdGhpcy5wdXNoKGRhdGEpCiAgfQoKICBlbmQgKGRhdGEpIHsKICAgIGxldCByZXN1bHQgPSAnJwogICAgaWYgKGRhdGEpIHJlc3VsdCA9IHRoaXMucHVzaChkYXRhKQogICAgcmVzdWx0ICs9IHRoaXMuZGVjb2Rlci5mbHVzaCgpCiAgICByZXR1cm4gcmVzdWx0CiAgfQp9CgpmdW5jdGlvbiBub3JtYWxpemVFbmNvZGluZyAoZW5jb2RpbmcpIHsKICBlbmNvZGluZyA9IGVuY29kaW5nLnRvTG93ZXJDYXNlKCkKCiAgc3dpdGNoIChlbmNvZGluZykgewogICAgY2FzZSAndXRmOCc6CiAgICBjYXNlICd1dGYtOCc6CiAgICAgIHJldHVybiAndXRmOCcKICAgIGNhc2UgJ3VjczInOgogICAgY2FzZSAndWNzLTInOgogICAgY2FzZSAndXRmMTZsZSc6CiAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgIHJldHVybiAndXRmMTZsZScKICAgIGNhc2UgJ2xhdGluMSc6CiAgICBjYXNlICdiaW5hcnknOgogICAgICByZXR1cm4gJ2xhdGluMScKICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICBjYXNlICdhc2NpaSc6CiAgICBjYXNlICdoZXgnOgogICAgICByZXR1cm4gZW5jb2RpbmcKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBlbmNvZGluZzogJyArIGVuY29kaW5nKQogIH0KfTsKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUGFzc1Rocm91Z2hEZWNvZGVyIHsKICBjb25zdHJ1Y3RvciAoZW5jb2RpbmcpIHsKICAgIHRoaXMuZW5jb2RpbmcgPSBlbmNvZGluZwogIH0KCiAgZ2V0IHJlbWFpbmluZyAoKSB7CiAgICByZXR1cm4gMAogIH0KCiAgZGVjb2RlICh0YWlsKSB7CiAgICByZXR1cm4gYjRhLnRvU3RyaW5nKHRhaWwsIHRoaXMuZW5jb2RpbmcpCiAgfQoKICBmbHVzaCAoKSB7CiAgICByZXR1cm4gJycKICB9Cn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCi8qKgogKiBodHRwczovL2VuY29kaW5nLnNwZWMud2hhdHdnLm9yZy8jdXRmLTgtZGVjb2RlcgogKi8KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBVVEY4RGVjb2RlciB7CiAgY29uc3RydWN0b3IgKCkgewogICAgdGhpcy5jb2RlUG9pbnQgPSAwCiAgICB0aGlzLmJ5dGVzU2VlbiA9IDAKICAgIHRoaXMuYnl0ZXNOZWVkZWQgPSAwCiAgICB0aGlzLmxvd2VyQm91bmRhcnkgPSAweDgwCiAgICB0aGlzLnVwcGVyQm91bmRhcnkgPSAweGJmCiAgfQoKICBnZXQgcmVtYWluaW5nICgpIHsKICAgIHJldHVybiB0aGlzLmJ5dGVzU2VlbgogIH0KCiAgZGVjb2RlIChkYXRhKSB7CiAgICAvLyBJZiB3ZSBoYXZlIGEgZmFzdCBwYXRoLCBqdXN0IHNuaWZmIGlmIHRoZSBsYXN0IHBhcnQgaXMgYSBib3VuZGFyeQogICAgaWYgKHRoaXMuYnl0ZXNOZWVkZWQgPT09IDApIHsKICAgICAgbGV0IGlzQm91bmRhcnkgPSB0cnVlCgogICAgICBmb3IgKGxldCBpID0gTWF0aC5tYXgoMCwgZGF0YS5ieXRlTGVuZ3RoIC0gNCksIG4gPSBkYXRhLmJ5dGVMZW5ndGg7IGkgPCBuICYmIGlzQm91bmRhcnk7IGkrKykgewogICAgICAgIGlzQm91bmRhcnkgPSBkYXRhW2ldIDw9IDB4N2YKICAgICAgfQoKICAgICAgaWYgKGlzQm91bmRhcnkpIHJldHVybiBiNGEudG9TdHJpbmcoZGF0YSwgJ3V0ZjgnKQogICAgfQoKICAgIGxldCByZXN1bHQgPSAnJwoKICAgIGZvciAobGV0IGkgPSAwLCBuID0gZGF0YS5ieXRlTGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIGNvbnN0IGJ5dGUgPSBkYXRhW2ldCgogICAgICBpZiAodGhpcy5ieXRlc05lZWRlZCA9PT0gMCkgewogICAgICAgIGlmIChieXRlIDw9IDB4N2YpIHsKICAgICAgICAgIHJlc3VsdCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ5dGUpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuYnl0ZXNTZWVuID0gMQoKICAgICAgICAgIGlmIChieXRlID49IDB4YzIgJiYgYnl0ZSA8PSAweGRmKSB7CiAgICAgICAgICAgIHRoaXMuYnl0ZXNOZWVkZWQgPSAyCiAgICAgICAgICAgIHRoaXMuY29kZVBvaW50ID0gYnl0ZSAmIDB4MWYKICAgICAgICAgIH0gZWxzZSBpZiAoYnl0ZSA+PSAweGUwICYmIGJ5dGUgPD0gMHhlZikgewogICAgICAgICAgICBpZiAoYnl0ZSA9PT0gMHhlMCkgdGhpcy5sb3dlckJvdW5kYXJ5ID0gMHhhMAogICAgICAgICAgICBlbHNlIGlmIChieXRlID09PSAweGVkKSB0aGlzLnVwcGVyQm91bmRhcnkgPSAweDlmCiAgICAgICAgICAgIHRoaXMuYnl0ZXNOZWVkZWQgPSAzCiAgICAgICAgICAgIHRoaXMuY29kZVBvaW50ID0gYnl0ZSAmIDB4ZgogICAgICAgICAgfSBlbHNlIGlmIChieXRlID49IDB4ZjAgJiYgYnl0ZSA8PSAweGY0KSB7CiAgICAgICAgICAgIGlmIChieXRlID09PSAweGYwKSB0aGlzLmxvd2VyQm91bmRhcnkgPSAweDkwCiAgICAgICAgICAgIGlmIChieXRlID09PSAweGY0KSB0aGlzLnVwcGVyQm91bmRhcnkgPSAweDhmCiAgICAgICAgICAgIHRoaXMuYnl0ZXNOZWVkZWQgPSA0CiAgICAgICAgICAgIHRoaXMuY29kZVBvaW50ID0gYnl0ZSAmIDB4NwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdWx0ICs9ICdcdWZmZmQnCiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBpZiAoYnl0ZSA8IHRoaXMubG93ZXJCb3VuZGFyeSB8fCBieXRlID4gdGhpcy51cHBlckJvdW5kYXJ5KSB7CiAgICAgICAgdGhpcy5jb2RlUG9pbnQgPSAwCiAgICAgICAgdGhpcy5ieXRlc05lZWRlZCA9IDAKICAgICAgICB0aGlzLmJ5dGVzU2VlbiA9IDAKICAgICAgICB0aGlzLmxvd2VyQm91bmRhcnkgPSAweDgwCiAgICAgICAgdGhpcy51cHBlckJvdW5kYXJ5ID0gMHhiZgoKICAgICAgICByZXN1bHQgKz0gJ1x1ZmZmZCcKCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgdGhpcy5sb3dlckJvdW5kYXJ5ID0gMHg4MAogICAgICB0aGlzLnVwcGVyQm91bmRhcnkgPSAweGJmCgogICAgICB0aGlzLmNvZGVQb2ludCA9ICh0aGlzLmNvZGVQb2ludCA8PCA2KSB8IChieXRlICYgMHgzZikKICAgICAgdGhpcy5ieXRlc1NlZW4rKwoKICAgICAgaWYgKHRoaXMuYnl0ZXNTZWVuICE9PSB0aGlzLmJ5dGVzTmVlZGVkKSBjb250aW51ZQoKICAgICAgcmVzdWx0ICs9IFN0cmluZy5mcm9tQ29kZVBvaW50KHRoaXMuY29kZVBvaW50KQoKICAgICAgdGhpcy5jb2RlUG9pbnQgPSAwCiAgICAgIHRoaXMuYnl0ZXNOZWVkZWQgPSAwCiAgICAgIHRoaXMuYnl0ZXNTZWVuID0gMAogICAgfQoKICAgIHJldHVybiByZXN1bHQKICB9CgogIGZsdXNoICgpIHsKICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuYnl0ZXNOZWVkZWQgPiAwID8gJ1x1ZmZmZCcgOiAnJwoKICAgIHRoaXMuY29kZVBvaW50ID0gMAogICAgdGhpcy5ieXRlc05lZWRlZCA9IDAKICAgIHRoaXMuYnl0ZXNTZWVuID0gMAogICAgdGhpcy5sb3dlckJvdW5kYXJ5ID0gMHg4MAogICAgdGhpcy51cHBlckJvdW5kYXJ5ID0gMHhiZgoKICAgIHJldHVybiByZXN1bHQKICB9Cn0KewogICJuYW1lIjogInRleHQtZGVjb2RlciIsCiAgInZlcnNpb24iOiAiMS4yLjMiLAogICJkZXNjcmlwdGlvbiI6ICJTdHJlYW1pbmcgdGV4dCBkZWNvZGVyIHRoYXQgcHJlc2VydmVzIG11bHRpYnl0ZSBVbmljb2RlIGNoYXJhY3RlcnMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYiIKICBdLAogICJicm93c2VyIjogewogICAgIi4vbGliL3Bhc3MtdGhyb3VnaC1kZWNvZGVyLmpzIjogIi4vbGliL2Jyb3dzZXItZGVjb2Rlci5qcyIsCiAgICAiLi9saWIvdXRmOC1kZWNvZGVyLmpzIjogIi4vbGliL2Jyb3dzZXItZGVjb2Rlci5qcyIKICB9LAogICJyZWFjdC1uYXRpdmUiOiB7CiAgICAiLi9saWIvcGFzcy10aHJvdWdoLWRlY29kZXIuanMiOiAiLi9saWIvcGFzcy10aHJvdWdoLWRlY29kZXIuanMiLAogICAgIi4vbGliL3V0ZjgtZGVjb2Rlci5qcyI6ICIuL2xpYi91dGY4LWRlY29kZXIuanMiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by90ZXh0LWRlY29kZXIuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vdGV4dC1kZWNvZGVyL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vdGV4dC1kZWNvZGVyI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi40IgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjMuMiIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBUaW1lT3JkZXJlZFNldCB7CiAgY29uc3RydWN0b3IgKCkgewogICAgdGhpcy5vbGRlc3QgPSBudWxsCiAgICB0aGlzLmxhdGVzdCA9IG51bGwKICAgIHRoaXMubGVuZ3RoID0gMAogIH0KCiAgaGFzIChub2RlKSB7CiAgICByZXR1cm4gISEobm9kZS5uZXh0IHx8IG5vZGUucHJldikgfHwgbm9kZSA9PT0gdGhpcy5vbGRlc3QKICB9CgogIGFkZCAobm9kZSkgewogICAgaWYgKHRoaXMuaGFzKG5vZGUpKSB0aGlzLnJlbW92ZShub2RlKQoKICAgIGlmICghdGhpcy5sYXRlc3QgJiYgIXRoaXMub2xkZXN0KSB7CiAgICAgIHRoaXMubGF0ZXN0ID0gdGhpcy5vbGRlc3QgPSBub2RlCiAgICAgIG5vZGUucHJldiA9IG5vZGUubmV4dCA9IG51bGwKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMubGF0ZXN0Lm5leHQgPSBub2RlCiAgICAgIG5vZGUucHJldiA9IHRoaXMubGF0ZXN0CiAgICAgIG5vZGUubmV4dCA9IG51bGwKICAgICAgdGhpcy5sYXRlc3QgPSBub2RlCiAgICB9CgogICAgdGhpcy5sZW5ndGgrKwoKICAgIHJldHVybiBub2RlCiAgfQoKICByZW1vdmUgKG5vZGUpIHsKICAgIGlmICghdGhpcy5oYXMobm9kZSkpIHJldHVybiBub2RlCgogICAgaWYgKHRoaXMub2xkZXN0ICE9PSBub2RlICYmIHRoaXMubGF0ZXN0ICE9PSBub2RlKSB7CiAgICAgIG5vZGUucHJldi5uZXh0ID0gbm9kZS5uZXh0CiAgICAgIG5vZGUubmV4dC5wcmV2ID0gbm9kZS5wcmV2CiAgICB9IGVsc2UgewogICAgICBpZiAodGhpcy5vbGRlc3QgPT09IG5vZGUpIHsKICAgICAgICB0aGlzLm9sZGVzdCA9IG5vZGUubmV4dAogICAgICAgIGlmICh0aGlzLm9sZGVzdCkgdGhpcy5vbGRlc3QucHJldiA9IG51bGwKICAgICAgfQogICAgICBpZiAodGhpcy5sYXRlc3QgPT09IG5vZGUpIHsKICAgICAgICB0aGlzLmxhdGVzdCA9IG5vZGUucHJldgogICAgICAgIGlmICh0aGlzLmxhdGVzdCkgdGhpcy5sYXRlc3QubmV4dCA9IG51bGwKICAgICAgfQogICAgfQoKICAgIG5vZGUubmV4dCA9IG5vZGUucHJldiA9IG51bGwKICAgIHRoaXMubGVuZ3RoLS0KCiAgICByZXR1cm4gbm9kZQogIH0KCiAgdG9BcnJheSAoeyBsaW1pdCA9IEluZmluaXR5LCByZXZlcnNlID0gZmFsc2UgfSA9IHt9KSB7CiAgICBjb25zdCBsaXN0ID0gW10KCiAgICBpZiAocmV2ZXJzZSkgewogICAgICBsZXQgbm9kZSA9IHRoaXMubGF0ZXN0CiAgICAgIHdoaWxlIChub2RlICYmIGxpbWl0LS0pIHsKICAgICAgICBsaXN0LnB1c2gobm9kZSkKICAgICAgICBub2RlID0gbm9kZS5wcmV2CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGxldCBub2RlID0gdGhpcy5vbGRlc3QKICAgICAgd2hpbGUgKG5vZGUgJiYgbGltaXQtLSkgewogICAgICAgIGxpc3QucHVzaChub2RlKQogICAgICAgIG5vZGUgPSBub2RlLm5leHQKICAgICAgfQogICAgfQoKICAgIHJldHVybiBsaXN0CiAgfQp9CnsKICAibmFtZSI6ICJ0aW1lLW9yZGVyZWQtc2V0IiwKICAidmVyc2lvbiI6ICIyLjAuMSIsCiAgImRlc2NyaXB0aW9uIjogIkVmZmljaWVudGx5IG1haW50YWluIGEgc2V0IG9mIG5vZGVzIG9yZGVyZWQgYnkgdGhlIHRpbWUgdGhleSB3ZXJlIGFkZGVkIHRvIHRoZSBzZXQiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMC4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4yIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvdGltZS1vcmRlcmVkLXNldC5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvdGltZS1vcmRlcmVkLXNldC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC90aW1lLW9yZGVyZWQtc2V0Igp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVGltZXJCcm93c2VyIHsKICBjb25zdHJ1Y3RvciAobXMsIGZuLCBjdHggPSBudWxsLCBpbnRlcnZhbCA9IGZhbHNlKSB7CiAgICB0aGlzLm1zID0gbXMKICAgIHRoaXMub250aW1lb3V0ID0gZm4KICAgIHRoaXMuY29udGV4dCA9IGN0eCB8fCBudWxsCiAgICB0aGlzLmludGVydmFsID0gaW50ZXJ2YWwKICAgIHRoaXMuZG9uZSA9IGZhbHNlCgogICAgdGhpcy5fdGltZXIgPSBpbnRlcnZhbAogICAgICA/IHNldEludGVydmFsKGNhbGxJbnRlcnZhbCwgbXMsIHRoaXMpCiAgICAgIDogc2V0VGltZW91dChjYWxsVGltZW91dCwgbXMsIHRoaXMpCiAgfQoKICB1bnJlZiAoKSB7fQoKICByZWYgKCkge30KCiAgcmVmcmVzaCAoKSB7CiAgICBpZiAodGhpcy5kb25lKSByZXR1cm4KCiAgICBpZiAodGhpcy5pbnRlcnZhbCkgewogICAgICBjbGVhckludGVydmFsKHRoaXMuX3RpbWVyKQogICAgICB0aGlzLl90aW1lciA9IHNldEludGVydmFsKGNhbGxJbnRlcnZhbCwgdGhpcy5tcywgdGhpcykKICAgIH0gZWxzZSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lcikKICAgICAgdGhpcy5fdGltZXIgPSBzZXRUaW1lb3V0KGNhbGxUaW1lb3V0LCB0aGlzLm1zLCB0aGlzKQogICAgfQogIH0KCiAgZGVzdHJveSAoKSB7CiAgICB0aGlzLmRvbmUgPSB0cnVlCiAgICB0aGlzLm9udGltZW91dCA9IG51bGwKCiAgICBpZiAodGhpcy5pbnRlcnZhbCkgY2xlYXJJbnRlcnZhbCh0aGlzLl90aW1lcikKICAgIGVsc2UgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVyKQogIH0KCiAgc3RhdGljIG9uY2UgKG1zLCBmbiwgY3R4KSB7CiAgICByZXR1cm4gbmV3IHRoaXMobXMsIGZuLCBjdHgsIGZhbHNlKQogIH0KCiAgc3RhdGljIG9uIChtcywgZm4sIGN0eCkgewogICAgcmV0dXJuIG5ldyB0aGlzKG1zLCBmbiwgY3R4LCB0cnVlKQogIH0KfQoKZnVuY3Rpb24gY2FsbFRpbWVvdXQgKHNlbGYpIHsKICBzZWxmLmRvbmUgPSB0cnVlCiAgc2VsZi5vbnRpbWVvdXQuY2FsbChzZWxmLmNvbnRleHQpCn0KCmZ1bmN0aW9uIGNhbGxJbnRlcnZhbCAoc2VsZikgewogIHNlbGYub250aW1lb3V0LmNhbGwoc2VsZi5jb250ZXh0KQp9Cm1vZHVsZS5leHBvcnRzID0gaXNOb2RlKCkKICA/IHJlcXVpcmUoJy4vbm9kZScpCiAgOiByZXF1aXJlKCcuL2Jyb3dzZXInKQoKZnVuY3Rpb24gaXNOb2RlICgpIHsKICBjb25zdCB0byA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge30sIDEwMDApCiAgY2xlYXJUaW1lb3V0KHRvKQogIHJldHVybiAhIXRvLnJlZnJlc2gKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFRpbWVyIHsKICBjb25zdHJ1Y3RvciAobXMsIGZuLCBjdHggPSBudWxsLCBpbnRlcnZhbCA9IGZhbHNlKSB7CiAgICB0aGlzLm1zID0gbXMKICAgIHRoaXMub250aW1lb3V0ID0gZm4KICAgIHRoaXMuY29udGV4dCA9IGN0eAogICAgdGhpcy5pbnRlcnZhbCA9IGludGVydmFsCiAgICB0aGlzLmRvbmUgPSBmYWxzZQoKICAgIHRoaXMuX3RpbWVyID0gaW50ZXJ2YWwKICAgICAgPyBzZXRJbnRlcnZhbChjYWxsSW50ZXJ2YWwsIG1zLCB0aGlzKQogICAgICA6IHNldFRpbWVvdXQoY2FsbFRpbWVvdXQsIG1zLCB0aGlzKQogIH0KCiAgdW5yZWYgKCkgewogICAgdGhpcy5fdGltZXIudW5yZWYoKQogIH0KCiAgcmVmICgpIHsKICAgIHRoaXMuX3RpbWVyLnJlZigpCiAgfQoKICByZWZyZXNoICgpIHsKICAgIGlmICh0aGlzLmRvbmUgIT09IHRydWUpIHRoaXMuX3RpbWVyLnJlZnJlc2goKQogIH0KCiAgZGVzdHJveSAoKSB7CiAgICB0aGlzLmRvbmUgPSB0cnVlCiAgICB0aGlzLm9udGltZW91dCA9IG51bGwKICAgIGlmICh0aGlzLmludGVydmFsKSBjbGVhckludGVydmFsKHRoaXMuX3RpbWVyKQogICAgZWxzZSBjbGVhclRpbWVvdXQodGhpcy5fdGltZXIpCiAgfQoKICBzdGF0aWMgb25jZSAobXMsIGZuLCBjdHgpIHsKICAgIHJldHVybiBuZXcgdGhpcyhtcywgZm4sIGN0eCwgZmFsc2UpCiAgfQoKICBzdGF0aWMgb24gKG1zLCBmbiwgY3R4KSB7CiAgICByZXR1cm4gbmV3IHRoaXMobXMsIGZuLCBjdHgsIHRydWUpCiAgfQp9CgpmdW5jdGlvbiBjYWxsVGltZW91dCAoc2VsZikgewogIHNlbGYuZG9uZSA9IHRydWUKICBzZWxmLm9udGltZW91dC5jYWxsKHNlbGYuY29udGV4dCkKfQoKZnVuY3Rpb24gY2FsbEludGVydmFsIChzZWxmKSB7CiAgc2VsZi5vbnRpbWVvdXQuY2FsbChzZWxmLmNvbnRleHQpCn0KewogICJuYW1lIjogInRpbWVvdXQtcmVmcmVzaCIsCiAgInZlcnNpb24iOiAiMi4wLjEiLAogICJkZXNjcmlwdGlvbiI6ICJFZmZpY2llbnRseSByZWZyZXNoIGEgdGltZXIiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTYuMC40IiwKICAgICJ0YXBlIjogIl41LjUuMiIKICB9LAogICJicm93c2VyIjogIi4vYnJvd3Nlci5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiB0YXBlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvdGltZW91dC1yZWZyZXNoLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC90aW1lb3V0LXJlZnJlc2gvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvdGltZW91dC1yZWZyZXNoIgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEJ1ZmZlck1hcCB7CiAgY29uc3RydWN0b3IgKG90aGVyKSB7CiAgICB0aGlzLm0gPSBvdGhlciA/IG5ldyBNYXAoWy4uLm90aGVyLm1dKSA6IG5ldyBNYXAoKQogIH0KCiAgZ2V0IHNpemUgKCkgewogICAgcmV0dXJuIHRoaXMubS5zaXplCiAgfQoKICBnZXQgKGtleSkgewogICAgaWYgKGI0YS5pc0J1ZmZlcihrZXkpKSBrZXkgPSBiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykKICAgIHJldHVybiB0aGlzLm0uZ2V0KGtleSkKICB9CgogIHNldCAoa2V5LCB2YWx1ZSkgewogICAgaWYgKGI0YS5pc0J1ZmZlcihrZXkpKSBrZXkgPSBiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykKICAgIHJldHVybiB0aGlzLm0uc2V0KGtleSwgdmFsdWUpCiAgfQoKICBkZWxldGUgKGtleSkgewogICAgaWYgKGI0YS5pc0J1ZmZlcihrZXkpKSBrZXkgPSBiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykKICAgIHJldHVybiB0aGlzLm0uZGVsZXRlKGtleSkKICB9CgogIGhhcyAoa2V5KSB7CiAgICBpZiAoYjRhLmlzQnVmZmVyKGtleSkpIGtleSA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQogICAgcmV0dXJuIHRoaXMubS5oYXMoa2V5KQogIH0KCiAgKiBbU3ltYm9sLml0ZXJhdG9yXSAoKSB7CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiB0aGlzLm0pIHsKICAgICAgeWllbGQgW2I0YS5mcm9tKGtleSwgJ2hleCcpLCB2YWx1ZV0KICAgIH0KICB9CgogICoga2V5cyAoKSB7CiAgICBmb3IgKGNvbnN0IGtleSBvZiB0aGlzLm0ua2V5cygpKSB7CiAgICAgIHlpZWxkIGI0YS5mcm9tKGtleSwgJ2hleCcpCiAgICB9CiAgfQoKICB2YWx1ZXMgKCkgewogICAgcmV0dXJuIHRoaXMubS52YWx1ZXMoKQogIH0KCiAgY2xlYXIgKCkgewogICAgcmV0dXJuIHRoaXMubS5jbGVhcigpCiAgfQp9CnsKICAibmFtZSI6ICJ0aW55LWJ1ZmZlci1tYXAiLAogICJ2ZXJzaW9uIjogIjEuMS4xIiwKICAiZGVzY3JpcHRpb24iOiAiQSB2ZXJ5IHNpbXBsZSBtYXAgZm9yIEJ1ZmZlcnMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogImJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9hbmRyZXdvc2gvdGlueS1idWZmZXItbWFwLmdpdCIKICB9LAogICJrZXl3b3JkcyI6IFsKICAgICJidWZmZXIiLAogICAgIm1hcCIKICBdLAogICJhdXRob3IiOiAiQW5kcmV3IE9zaGVyb2ZmIDxhbmRyZXdvc2hAZ21haWwuY29tPiIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2FuZHJld29zaC90aW55LWJ1ZmZlci1tYXAvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9hbmRyZXdvc2gvdGlueS1idWZmZXItbWFwI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjAuNCIKICB9Cn0KcmVxdWlyZS5hZGRvbiA9IHJlcXVpcmUoJ3JlcXVpcmUtYWRkb24nKQoKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCcuJywgX19maWxlbmFtZSkKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKY29uc3QgdjRTZWcgPSAnKD86WzAtOV18WzEtOV1bMC05XXwxWzAtOV1bMC05XXwyWzAtNF1bMC05XXwyNVswLTVdKScKY29uc3QgdjRTdHIgPSBgKCR7djRTZWd9Wy5dKXszfSR7djRTZWd9YApjb25zdCBJUHY0UGF0dGVybiA9IG5ldyBSZWdFeHAoYF4ke3Y0U3RyfSRgKQoKY29uc3QgdjZTZWcgPSAnKD86WzAtOWEtZkEtRl17MSw0fSknCmNvbnN0IElQdjZQYXR0ZXJuID0gbmV3IFJlZ0V4cCgKICAnXignICsKICAgIGAoPzoke3Y2U2VnfTopezd9KD86JHt2NlNlZ318Oil8YCArCiAgICBgKD86JHt2NlNlZ306KXs2fSg/OiR7djRTdHJ9fDoke3Y2U2VnfXw6KXxgICsKICAgIGAoPzoke3Y2U2VnfTopezV9KD86OiR7djRTdHJ9fCg6JHt2NlNlZ30pezEsMn18Oil8YCArCiAgICBgKD86JHt2NlNlZ306KXs0fSg/Oig6JHt2NlNlZ30pezAsMX06JHt2NFN0cn18KDoke3Y2U2VnfSl7MSwzfXw6KXxgICsKICAgIGAoPzoke3Y2U2VnfTopezN9KD86KDoke3Y2U2VnfSl7MCwyfToke3Y0U3RyfXwoOiR7djZTZWd9KXsxLDR9fDopfGAgKwogICAgYCg/OiR7djZTZWd9Oil7Mn0oPzooOiR7djZTZWd9KXswLDN9OiR7djRTdHJ9fCg6JHt2NlNlZ30pezEsNX18Oil8YCArCiAgICBgKD86JHt2NlNlZ306KXsxfSg/Oig6JHt2NlNlZ30pezAsNH06JHt2NFN0cn18KDoke3Y2U2VnfSl7MSw2fXw6KXxgICsKICAgIGAoPzo6KCg/Ojoke3Y2U2VnfSl7MCw1fToke3Y0U3RyfXwoPzo6JHt2NlNlZ30pezEsN318OikpYCArCiAgICAnKSglWzAtOWEtekEtWi0uOl17MSx9KT8kJwopCgpjb25zdCBpc0lQdjQgPSAoZXhwb3J0cy5pc0lQdjQgPSBmdW5jdGlvbiBpc0lQdjQoaG9zdCkgewogIHJldHVybiBJUHY0UGF0dGVybi50ZXN0KGhvc3QpCn0pCgpjb25zdCBpc0lQdjYgPSAoZXhwb3J0cy5pc0lQdjYgPSBmdW5jdGlvbiBpc0lQdjYoaG9zdCkgewogIHJldHVybiBJUHY2UGF0dGVybi50ZXN0KGhvc3QpCn0pCgpleHBvcnRzLmlzSVAgPSBmdW5jdGlvbiBpc0lQKGhvc3QpIHsKICBpZiAoaXNJUHY0KGhvc3QpKSByZXR1cm4gNAogIGlmIChpc0lQdjYoaG9zdCkpIHJldHVybiA2CiAgcmV0dXJuIDAKfQpjb25zdCBldmVudHMgPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIE5ldHdvcmtJbnRlcmZhY2VzIGV4dGVuZHMgZXZlbnRzLkV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IodWR4KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5faGFuZGxlID0gYjRhLmFsbG9jKGJpbmRpbmcuc2l6ZW9mX3VkeF9uYXBpX2ludGVyZmFjZV9ldmVudF90KQogICAgdGhpcy5fd2F0Y2hpbmcgPSBmYWxzZQogICAgdGhpcy5fZGVzdHJveWluZyA9IG51bGwKCiAgICBiaW5kaW5nLnVkeF9uYXBpX2ludGVyZmFjZV9ldmVudF9pbml0KAogICAgICB1ZHguX2hhbmRsZSwKICAgICAgdGhpcy5faGFuZGxlLAogICAgICB0aGlzLAogICAgICB0aGlzLl9vbmV2ZW50LAogICAgICB0aGlzLl9vbmNsb3NlCiAgICApCgogICAgdGhpcy5pbnRlcmZhY2VzID0gYmluZGluZy51ZHhfbmFwaV9pbnRlcmZhY2VfZXZlbnRfZ2V0X2FkZHJzKHRoaXMuX2hhbmRsZSkKICB9CgogIF9vbmNsb3NlKCkgewogICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgfQoKICBfb25ldmVudCgpIHsKICAgIHRoaXMuaW50ZXJmYWNlcyA9IGJpbmRpbmcudWR4X25hcGlfaW50ZXJmYWNlX2V2ZW50X2dldF9hZGRycyh0aGlzLl9oYW5kbGUpCgogICAgdGhpcy5lbWl0KCdjaGFuZ2UnLCB0aGlzLmludGVyZmFjZXMpCiAgfQoKICB3YXRjaCgpIHsKICAgIGlmICh0aGlzLl93YXRjaGluZykgcmV0dXJuIHRoaXMKICAgIHRoaXMuX3dhdGNoaW5nID0gdHJ1ZQoKICAgIGJpbmRpbmcudWR4X25hcGlfaW50ZXJmYWNlX2V2ZW50X3N0YXJ0KHRoaXMuX2hhbmRsZSkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgdW53YXRjaCgpIHsKICAgIGlmICghdGhpcy5fd2F0Y2hpbmcpIHJldHVybiB0aGlzCiAgICB0aGlzLl93YXRjaGluZyA9IGZhbHNlCgogICAgYmluZGluZy51ZHhfbmFwaV9pbnRlcmZhY2VfZXZlbnRfc3RvcCh0aGlzLl9oYW5kbGUpCgogICAgcmV0dXJuIHRoaXMKICB9CgogIGFzeW5jIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5fZGVzdHJveWluZykgcmV0dXJuIHRoaXMuX2Rlc3Ryb3lpbmcKICAgIHRoaXMuX2Rlc3Ryb3lpbmcgPSBldmVudHMub25jZSh0aGlzLCAnY2xvc2UnKQoKICAgIGJpbmRpbmcudWR4X25hcGlfaW50ZXJmYWNlX2V2ZW50X2Nsb3NlKHRoaXMuX2hhbmRsZSkKCiAgICByZXR1cm4gdGhpcy5fZGVzdHJveWluZwogIH0KCiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy5pbnRlcmZhY2VzW1N5bWJvbC5pdGVyYXRvcl0oKQogIH0KfQpjb25zdCBldmVudHMgPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGlwID0gcmVxdWlyZSgnLi9pcCcpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFVEWFNvY2tldCBleHRlbmRzIGV2ZW50cy5FdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKHVkeCwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy51ZHggPSB1ZHgKCiAgICB0aGlzLl9oYW5kbGUgPSBiNGEuYWxsb2MoYmluZGluZy5zaXplb2ZfdWR4X25hcGlfc29ja2V0X3QpCiAgICB0aGlzLl9pbml0ZWQgPSBmYWxzZQogICAgdGhpcy5faG9zdCA9IG51bGwKICAgIHRoaXMuX2ZhbWlseSA9IDAKICAgIHRoaXMuX2lwdjZPbmx5ID0gb3B0cy5pcHY2T25seSA9PT0gdHJ1ZQogICAgdGhpcy5fcmV1c2VBZGRyZXNzID0gb3B0cy5yZXVzZUFkZHJlc3MgPT09IHRydWUKICAgIHRoaXMuX3BvcnQgPSAwCiAgICB0aGlzLl9yZXFzID0gW10KICAgIHRoaXMuX2ZyZWUgPSBbXQogICAgdGhpcy5fY2xvc2luZyA9IG51bGwKICAgIHRoaXMuX2Nsb3NlZCA9IGZhbHNlCgogICAgdGhpcy5fdmlldzY0ID0gbmV3IEJpZ1VpbnQ2NEFycmF5KAogICAgICB0aGlzLl9oYW5kbGUuYnVmZmVyLAogICAgICB0aGlzLl9oYW5kbGUuYnl0ZU9mZnNldCwKICAgICAgdGhpcy5faGFuZGxlLmJ5dGVMZW5ndGggPj4gMwogICAgKQoKICAgIHRoaXMuc3RyZWFtcyA9IG5ldyBTZXQoKQoKICAgIHRoaXMudXNlckRhdGEgPSBudWxsCiAgfQoKICBnZXQgYm91bmQoKSB7CiAgICByZXR1cm4gdGhpcy5fcG9ydCAhPT0gMAogIH0KCiAgZ2V0IGNsb3NpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5fY2xvc2luZyAhPT0gbnVsbAogIH0KCiAgZ2V0IGlkbGUoKSB7CiAgICByZXR1cm4gdGhpcy5zdHJlYW1zLnNpemUgPT09IDAKICB9CgogIGdldCBidXN5KCkgewogICAgcmV0dXJuIHRoaXMuc3RyZWFtcy5zaXplID4gMAogIH0KCiAgZ2V0IGJ5dGVzVHJhbnNtaXR0ZWQoKSB7CiAgICBpZiAodGhpcy5faW5pdGVkICE9PSB0cnVlKSByZXR1cm4gMAogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfc29ja2V0X3RfYnl0ZXNfdHggPj4gM10pCiAgfQoKICBnZXQgcGFja2V0c1RyYW5zbWl0dGVkKCkgewogICAgaWYgKHRoaXMuX2luaXRlZCAhPT0gdHJ1ZSkgcmV0dXJuIDAKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3NvY2tldF90X3BhY2tldHNfdHggPj4gM10pCiAgfQoKICBnZXQgYnl0ZXNSZWNlaXZlZCgpIHsKICAgIGlmICh0aGlzLl9pbml0ZWQgIT09IHRydWUpIHJldHVybiAwCiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF9zb2NrZXRfdF9ieXRlc19yeCA+PiAzXSkKICB9CgogIGdldCBwYWNrZXRzUmVjZWl2ZWQoKSB7CiAgICBpZiAodGhpcy5faW5pdGVkICE9PSB0cnVlKSByZXR1cm4gMAogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfc29ja2V0X3RfcGFja2V0c19yeCA+PiAzXSkKICB9CgogIGdldCBwYWNrZXRzRHJvcHBlZEJ5S2VybmVsKCkgewogICAgaWYgKHRoaXMuX2luaXRlZCAhPT0gdHJ1ZSkgcmV0dXJuIDAKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3NvY2tldF90X3BhY2tldHNfZHJvcHBlZF9ieV9rZXJuZWwgPj4gM10pCiAgfQoKICB0b0pTT04oKSB7CiAgICByZXR1cm4gewogICAgICBib3VuZDogdGhpcy5ib3VuZCwKICAgICAgY2xvc2luZzogdGhpcy5jbG9zaW5nLAogICAgICBzdHJlYW1zOiB0aGlzLnN0cmVhbXMuc2l6ZSwKICAgICAgYWRkcmVzczogdGhpcy5hZGRyZXNzKCksCiAgICAgIGlwdjZPbmx5OiB0aGlzLl9pcHY2T25seSwKICAgICAgcmV1c2VBZGRyZXNzOiB0aGlzLl9yZXVzZUFkZHJlc3MsCiAgICAgIGlkbGU6IHRoaXMuaWRsZSwKICAgICAgYnVzeTogdGhpcy5idXN5CiAgICB9CiAgfQoKICBfaW5pdCgpIHsKICAgIGlmICh0aGlzLl9pbml0ZWQpIHJldHVybgoKICAgIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X2luaXQoCiAgICAgIHRoaXMudWR4Ll9oYW5kbGUsCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgdGhpcywKICAgICAgdGhpcy5fb25zZW5kLAogICAgICB0aGlzLl9vbm1lc3NhZ2UsCiAgICAgIHRoaXMuX29uY2xvc2UsCiAgICAgIHRoaXMuX3JlYWxsb2NNZXNzYWdlCiAgICApCgogICAgdGhpcy5faW5pdGVkID0gdHJ1ZQogIH0KCiAgX29uc2VuZChpZCwgZXJyKSB7CiAgICBjb25zdCByZXEgPSB0aGlzLl9yZXFzW2lkXQoKICAgIGNvbnN0IG9uZmx1c2ggPSByZXEub25mbHVzaAoKICAgIHJlcS5idWZmZXIgPSBudWxsCiAgICByZXEub25mbHVzaCA9IG51bGwKCiAgICB0aGlzLl9mcmVlLnB1c2goaWQpCgogICAgb25mbHVzaChlcnIgPj0gMCkKCiAgICAvLyBnYyB0aGUgZnJlZSBsaXN0CiAgICBpZiAodGhpcy5fZnJlZS5sZW5ndGggPj0gMTYgJiYgdGhpcy5fZnJlZS5sZW5ndGggPT09IHRoaXMuX3JlcXMubGVuZ3RoKSB7CiAgICAgIHRoaXMuX2ZyZWUgPSBbXQogICAgICB0aGlzLl9yZXFzID0gW10KICAgIH0KICB9CgogIF9vbm1lc3NhZ2UobGVuLCBwb3J0LCBob3N0LCBmYW1pbHkpIHsKICAgIHRoaXMuZW1pdCgnbWVzc2FnZScsIHRoaXMudWR4Ll9jb25zdW1lTWVzc2FnZShsZW4pLCB7IGhvc3QsIGZhbWlseSwgcG9ydCB9KQogICAgcmV0dXJuIHRoaXMudWR4Ll9idWZmZXIKICB9CgogIF9vbmNsb3NlKCkgewogICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgfQoKICBfcmVhbGxvY01lc3NhZ2UoKSB7CiAgICByZXR1cm4gdGhpcy51ZHguX3JlYWxsb2NNZXNzYWdlKCkKICB9CgogIF9vbmlkbGUoKSB7CiAgICB0aGlzLmVtaXQoJ2lkbGUnKQogIH0KCiAgX29uYnVzeSgpIHsKICAgIHRoaXMuZW1pdCgnYnVzeScpCiAgfQoKICBfYWRkU3RyZWFtKHN0cmVhbSkgewogICAgaWYgKHRoaXMuc3RyZWFtcy5oYXMoc3RyZWFtKSkgcmV0dXJuIGZhbHNlCiAgICB0aGlzLnN0cmVhbXMuYWRkKHN0cmVhbSkKICAgIGlmICh0aGlzLnN0cmVhbXMuc2l6ZSA9PT0gMSkgdGhpcy5fb25idXN5KCkKICAgIHJldHVybiB0cnVlCiAgfQoKICBfcmVtb3ZlU3RyZWFtKHN0cmVhbSkgewogICAgaWYgKCF0aGlzLnN0cmVhbXMuaGFzKHN0cmVhbSkpIHJldHVybiBmYWxzZQogICAgdGhpcy5zdHJlYW1zLmRlbGV0ZShzdHJlYW0pCiAgICBjb25zdCBjbG9zZWQgPSB0aGlzLl9jbG9zZU1heWJlKCkKICAgIGlmICh0aGlzLmlkbGUgJiYgIWNsb3NlZCkgdGhpcy5fb25pZGxlKCkKICAgIHJldHVybiB0cnVlCiAgfQoKICBhZGRyZXNzKCkgewogICAgaWYgKCF0aGlzLmJvdW5kKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHsgaG9zdDogdGhpcy5faG9zdCwgZmFtaWx5OiB0aGlzLl9mYW1pbHksIHBvcnQ6IHRoaXMuX3BvcnQgfQogIH0KCiAgYmluZChwb3J0LCBob3N0KSB7CiAgICBpZiAodGhpcy5ib3VuZCkgdGhyb3cgbmV3IEVycm9yKCdBbHJlYWR5IGJvdW5kJykKICAgIGlmICh0aGlzLmNsb3NpbmcpIHRocm93IG5ldyBFcnJvcignU29ja2V0IGlzIGNsb3NlZCcpCgogICAgaWYgKCFwb3J0KSBwb3J0ID0gMAoKICAgIGxldCBmbGFncyA9IDAKICAgIGlmICh0aGlzLl9pcHY2T25seSkgZmxhZ3MgfD0gYmluZGluZy5VVl9VRFBfSVBWNk9OTFkKICAgIGlmICh0aGlzLl9yZXVzZUFkZHJlc3MpIGZsYWdzIHw9IGJpbmRpbmcuVVZfVURQX1JFVVNFQUREUgoKICAgIGxldCBmYW1pbHkKCiAgICBpZiAoaG9zdCkgewogICAgICBmYW1pbHkgPSBpcC5pc0lQKGhvc3QpCiAgICAgIGlmICghZmFtaWx5KSB0aHJvdyBuZXcgRXJyb3IoYCR7aG9zdH0gaXMgbm90IGEgdmFsaWQgSVAgYWRkcmVzc2ApCgogICAgICBpZiAoIXRoaXMuX2luaXRlZCkgdGhpcy5faW5pdCgpCgogICAgICB0aGlzLl9wb3J0ID0gYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfYmluZCh0aGlzLl9oYW5kbGUsIHBvcnQsIGhvc3QsIGZhbWlseSwgZmxhZ3MpCiAgICB9IGVsc2UgewogICAgICBpZiAoIXRoaXMuX2luaXRlZCkgdGhpcy5faW5pdCgpCgogICAgICB0cnkgewogICAgICAgIGhvc3QgPSAnOjonCiAgICAgICAgZmFtaWx5ID0gNgogICAgICAgIHRoaXMuX3BvcnQgPSBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9iaW5kKHRoaXMuX2hhbmRsZSwgcG9ydCwgaG9zdCwgZmFtaWx5LCBmbGFncykKICAgICAgfSBjYXRjaCB7CiAgICAgICAgaG9zdCA9ICcwLjAuMC4wJwogICAgICAgIGZhbWlseSA9IDQKICAgICAgICB0aGlzLl9wb3J0ID0gYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfYmluZCh0aGlzLl9oYW5kbGUsIHBvcnQsIGhvc3QsIGZhbWlseSwgZmxhZ3MpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9ob3N0ID0gaG9zdAogICAgdGhpcy5fZmFtaWx5ID0gZmFtaWx5CgogICAgdGhpcy5lbWl0KCdsaXN0ZW5pbmcnKQogIH0KCiAgYXN5bmMgY2xvc2UoKSB7CiAgICBpZiAodGhpcy5fY2xvc2luZykgcmV0dXJuIHRoaXMuX2Nsb3NpbmcKICAgIHRoaXMuX2Nsb3NpbmcgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gdGhpcy5vbmNlKCdjbG9zZScsIHJlc29sdmUpKQogICAgdGhpcy5fY2xvc2VNYXliZSgpCiAgICByZXR1cm4gdGhpcy5fY2xvc2luZwogIH0KCiAgX2Nsb3NlTWF5YmUoKSB7CiAgICBpZiAodGhpcy5fY2xvc2VkIHx8IHRoaXMuX2Nsb3NpbmcgPT09IG51bGwpIHJldHVybiB0aGlzLl9jbG9zZWQKCiAgICBpZiAoIXRoaXMuX2luaXRlZCkgewogICAgICB0aGlzLl9jbG9zZWQgPSB0cnVlCiAgICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGlmICh0aGlzLmlkbGUpIHsKICAgICAgYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfY2xvc2UodGhpcy5faGFuZGxlKQogICAgICB0aGlzLl9jbG9zZWQgPSB0cnVlCiAgICB9CgogICAgcmV0dXJuIHRoaXMuX2Nsb3NlZAogIH0KCiAgc2V0VFRMKHR0bCkgewogICAgaWYgKCF0aGlzLl9pbml0ZWQpIHRocm93IG5ldyBFcnJvcignU29ja2V0IG5vdCBhY3RpdmUnKQogICAgYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfc2V0X3R0bCh0aGlzLl9oYW5kbGUsIHR0bCkKICB9CgogIGdldFJlY3ZCdWZmZXJTaXplKCkgewogICAgaWYgKCF0aGlzLl9pbml0ZWQpIHRocm93IG5ldyBFcnJvcignU29ja2V0IG5vdCBhY3RpdmUnKQogICAgcmV0dXJuIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X2dldF9yZWN2X2J1ZmZlcl9zaXplKHRoaXMuX2hhbmRsZSkKICB9CgogIHNldFJlY3ZCdWZmZXJTaXplKHNpemUpIHsKICAgIGlmICghdGhpcy5faW5pdGVkKSB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCBub3QgYWN0aXZlJykKICAgIHJldHVybiBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9zZXRfcmVjdl9idWZmZXJfc2l6ZSh0aGlzLl9oYW5kbGUsIHNpemUpCiAgfQoKICBnZXRTZW5kQnVmZmVyU2l6ZSgpIHsKICAgIGlmICghdGhpcy5faW5pdGVkKSB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCBub3QgYWN0aXZlJykKICAgIHJldHVybiBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9nZXRfc2VuZF9idWZmZXJfc2l6ZSh0aGlzLl9oYW5kbGUpCiAgfQoKICBzZXRTZW5kQnVmZmVyU2l6ZShzaXplKSB7CiAgICBpZiAoIXRoaXMuX2luaXRlZCkgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgbm90IGFjdGl2ZScpCiAgICByZXR1cm4gYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfc2V0X3NlbmRfYnVmZmVyX3NpemUodGhpcy5faGFuZGxlLCBzaXplKQogIH0KCiAgYWRkTWVtYmVyc2hpcChncm91cCwgaWZhY2VBZGRyZXNzKSB7CiAgICBpZiAoIXRoaXMuX2luaXRlZCkgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgbm90IGFjdGl2ZScpCiAgICByZXR1cm4gYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfc2V0X21lbWJlcnNoaXAodGhpcy5faGFuZGxlLCBncm91cCwgaWZhY2VBZGRyZXNzIHx8ICcnLCB0cnVlKQogIH0KCiAgZHJvcE1lbWJlcnNoaXAoZ3JvdXAsIGlmYWNlQWRkcmVzcykgewogICAgaWYgKCF0aGlzLl9pbml0ZWQpIHRocm93IG5ldyBFcnJvcignU29ja2V0IG5vdCBhY3RpdmUnKQogICAgcmV0dXJuIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X3NldF9tZW1iZXJzaGlwKHRoaXMuX2hhbmRsZSwgZ3JvdXAsIGlmYWNlQWRkcmVzcyB8fCAnJywgZmFsc2UpCiAgfQoKICBhc3luYyBzZW5kKGJ1ZmZlciwgcG9ydCwgaG9zdCwgdHRsKSB7CiAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4gZmFsc2UKCiAgICBpZiAoIWhvc3QpIGhvc3QgPSAnMTI3LjAuMC4xJwoKICAgIGNvbnN0IGZhbWlseSA9IGlwLmlzSVAoaG9zdCkKICAgIGlmICghZmFtaWx5KSB0aHJvdyBuZXcgRXJyb3IoYCR7aG9zdH0gaXMgbm90IGEgdmFsaWQgSVAgYWRkcmVzc2ApCgogICAgaWYgKCF0aGlzLmJvdW5kKSB0aGlzLmJpbmQoMCkKCiAgICBjb25zdCBpZCA9IHRoaXMuX2FsbG9jU2VuZCgpCiAgICBjb25zdCByZXEgPSB0aGlzLl9yZXFzW2lkXQoKICAgIHJlcS5idWZmZXIgPSBidWZmZXIKCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgcmVxLm9uZmx1c2ggPSByZXNvbHZlCiAgICB9KQoKICAgIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X3NlbmRfdHRsKAogICAgICB0aGlzLl9oYW5kbGUsCiAgICAgIHJlcS5oYW5kbGUsCiAgICAgIGlkLAogICAgICBidWZmZXIsCiAgICAgIHBvcnQsCiAgICAgIGhvc3QsCiAgICAgIGZhbWlseSwKICAgICAgdHRsIHx8IDAKICAgICkKCiAgICByZXR1cm4gcHJvbWlzZQogIH0KCiAgdHJ5U2VuZChidWZmZXIsIHBvcnQsIGhvc3QsIHR0bCkgewogICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuCgogICAgaWYgKCFob3N0KSBob3N0ID0gJzEyNy4wLjAuMScKCiAgICBjb25zdCBmYW1pbHkgPSBpcC5pc0lQKGhvc3QpCiAgICBpZiAoIWZhbWlseSkgdGhyb3cgbmV3IEVycm9yKGAke2hvc3R9IGlzIG5vdCBhIHZhbGlkIElQIGFkZHJlc3NgKQoKICAgIGlmICghdGhpcy5ib3VuZCkgdGhpcy5iaW5kKDApCgogICAgY29uc3QgaWQgPSB0aGlzLl9hbGxvY1NlbmQoKQogICAgY29uc3QgcmVxID0gdGhpcy5fcmVxc1tpZF0KCiAgICByZXEuYnVmZmVyID0gYnVmZmVyCiAgICByZXEub25mbHVzaCA9IG5vb3AKCiAgICBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9zZW5kX3R0bCgKICAgICAgdGhpcy5faGFuZGxlLAogICAgICByZXEuaGFuZGxlLAogICAgICBpZCwKICAgICAgYnVmZmVyLAogICAgICBwb3J0LAogICAgICBob3N0LAogICAgICBmYW1pbHksCiAgICAgIHR0bCB8fCAwCiAgICApCiAgfQoKICBfYWxsb2NTZW5kKCkgewogICAgaWYgKHRoaXMuX2ZyZWUubGVuZ3RoID4gMCkgcmV0dXJuIHRoaXMuX2ZyZWUucG9wKCkKICAgIGNvbnN0IGhhbmRsZSA9IGI0YS5hbGxvY1Vuc2FmZShiaW5kaW5nLnNpemVvZl91ZHhfc29ja2V0X3NlbmRfdCkKICAgIHJldHVybiB0aGlzLl9yZXFzLnB1c2goeyBoYW5kbGUsIGJ1ZmZlcjogbnVsbCwgb25mbHVzaDogbnVsbCB9KSAtIDEKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCBzdHJlYW14ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKY29uc3QgaXAgPSByZXF1aXJlKCcuL2lwJykKCmNvbnN0IE1BWF9QQUNLRVQgPSAyMDQ4CmNvbnN0IEJVRkZFUl9TSVpFID0gNjU1MzYgKyBNQVhfUEFDS0VUCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFVEWFN0cmVhbSBleHRlbmRzIHN0cmVhbXguRHVwbGV4IHsKICBjb25zdHJ1Y3Rvcih1ZHgsIGlkLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKHsgbWFwV3JpdGFibGU6IHRvQnVmZmVyLCBlYWdlck9wZW46IHRydWUgfSkKCiAgICB0aGlzLnVkeCA9IHVkeAogICAgdGhpcy5zb2NrZXQgPSBudWxsCgogICAgdGhpcy5faGFuZGxlID0gYjRhLmFsbG9jKGJpbmRpbmcuc2l6ZW9mX3VkeF9uYXBpX3N0cmVhbV90KQogICAgdGhpcy5fdmlldyA9IG5ldyBVaW50MzJBcnJheSgKICAgICAgdGhpcy5faGFuZGxlLmJ1ZmZlciwKICAgICAgdGhpcy5faGFuZGxlLmJ5dGVPZmZzZXQsCiAgICAgIHRoaXMuX2hhbmRsZS5ieXRlTGVuZ3RoID4+IDIKICAgICkKICAgIHRoaXMuX3ZpZXcxNiA9IG5ldyBVaW50MTZBcnJheSgKICAgICAgdGhpcy5faGFuZGxlLmJ1ZmZlciwKICAgICAgdGhpcy5faGFuZGxlLmJ5dGVPZmZzZXQsCiAgICAgIHRoaXMuX2hhbmRsZS5ieXRlTGVuZ3RoID4+IDEKICAgICkKICAgIHRoaXMuX3ZpZXc2NCA9IG5ldyBCaWdVaW50NjRBcnJheSgKICAgICAgdGhpcy5faGFuZGxlLmJ1ZmZlciwKICAgICAgdGhpcy5faGFuZGxlLmJ5dGVPZmZzZXQsCiAgICAgIHRoaXMuX2hhbmRsZS5ieXRlTGVuZ3RoID4+IDMKICAgICkKCiAgICB0aGlzLl93cmVxcyA9IFtdCiAgICB0aGlzLl93ZnJlZSA9IFtdCgogICAgdGhpcy5fc3JlcXMgPSBbXQogICAgdGhpcy5fc2ZyZWUgPSBbXQogICAgdGhpcy5fY2xvc2VkID0gZmFsc2UKCiAgICB0aGlzLl9mbHVzaGluZyA9IDAKICAgIHRoaXMuX2ZsdXNoZXMgPSBbXQoKICAgIHRoaXMuX2J1ZmZlciA9IG51bGwKICAgIHRoaXMuX3JlYWxsb2NEYXRhKCkKCiAgICB0aGlzLl9vbndyaXRlID0gbnVsbAogICAgdGhpcy5fb25kZXN0cm95ID0gbnVsbAogICAgdGhpcy5fZmlyZXdhbGwgPSBvcHRzLmZpcmV3YWxsIHx8IGZpcmV3YWxsQWxsCgogICAgdGhpcy5fcmVtb3RlQ2hhbmdpbmcgPSBudWxsCiAgICB0aGlzLl9wcmV2aW91c1NvY2tldCA9IG51bGwKCiAgICB0aGlzLmlkID0gaWQKICAgIHRoaXMucmVtb3RlSWQgPSAwCiAgICB0aGlzLnJlbW90ZUhvc3QgPSBudWxsCiAgICB0aGlzLnJlbW90ZUZhbWlseSA9IDAKICAgIHRoaXMucmVtb3RlUG9ydCA9IDAKCiAgICB0aGlzLnVzZXJEYXRhID0gbnVsbAoKICAgIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX2luaXQoCiAgICAgIHRoaXMudWR4Ll9oYW5kbGUsCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgaWQsCiAgICAgIG9wdHMuZnJhbWVkID8gMSA6IDAsCiAgICAgIHRoaXMsCiAgICAgIHRoaXMuX29uZGF0YSwKICAgICAgdGhpcy5fb25lbmQsCiAgICAgIHRoaXMuX29uZHJhaW4sCiAgICAgIHRoaXMuX29uYWNrLAogICAgICB0aGlzLl9vbnNlbmQsCiAgICAgIHRoaXMuX29ubWVzc2FnZSwKICAgICAgdGhpcy5fb25jbG9zZSwKICAgICAgdGhpcy5fb25maXJld2FsbCwKICAgICAgdGhpcy5fb25yZW1vdGVjaGFuZ2VkLAogICAgICB0aGlzLl9yZWFsbG9jRGF0YSwKICAgICAgdGhpcy5fcmVhbGxvY01lc3NhZ2UKICAgICkKCiAgICBpZiAob3B0cy5zZXEpIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX3NldF9zZXEodGhpcy5faGFuZGxlLCBvcHRzLnNlcSkKCiAgICBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV9yZWN2X3N0YXJ0KHRoaXMuX2hhbmRsZSwgdGhpcy5fYnVmZmVyKQogIH0KCiAgZ2V0IGNvbm5lY3RlZCgpIHsKICAgIHJldHVybiB0aGlzLnNvY2tldCAhPT0gbnVsbAogIH0KCiAgZ2V0IG10dSgpIHsKICAgIHJldHVybiB0aGlzLl92aWV3MTZbYmluZGluZy5vZmZzZXRvZl91ZHhfc3RyZWFtX3RfbXR1ID4+IDFdCiAgfQoKICBnZXQgcnR0KCkgewogICAgcmV0dXJuIHRoaXMuX3ZpZXdbYmluZGluZy5vZmZzZXRvZl91ZHhfc3RyZWFtX3Rfc3J0dCA+PiAyXQogIH0KCiAgZ2V0IGN3bmQoKSB7CiAgICByZXR1cm4gdGhpcy5fdmlld1tiaW5kaW5nLm9mZnNldG9mX3VkeF9zdHJlYW1fdF9jd25kID4+IDJdCiAgfQoKICBnZXQgcnRvQ291bnQoKSB7CiAgICByZXR1cm4gdGhpcy5fdmlldzE2W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X3J0b19jb3VudCA+PiAxXQogIH0KCiAgZ2V0IHJldHJhbnNtaXRzKCkgewogICAgcmV0dXJuIHRoaXMuX3ZpZXcxNltiaW5kaW5nLm9mZnNldG9mX3VkeF9zdHJlYW1fdF9yZXRyYW5zbWl0X2NvdW50ID4+IDFdCiAgfQoKICBnZXQgZmFzdFJlY292ZXJpZXMoKSB7CiAgICByZXR1cm4gdGhpcy5fdmlldzE2W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X2Zhc3RfcmVjb3ZlcnlfY291bnQgPj4gMV0KICB9CgogIGdldCBpbmZsaWdodCgpIHsKICAgIHJldHVybiB0aGlzLl92aWV3W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X2luZmxpZ2h0ID4+IDJdCiAgfQoKICBnZXQgYnl0ZXNUcmFuc21pdHRlZCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X2J5dGVzX3R4ID4+IDNdKQogIH0KCiAgZ2V0IHBhY2tldHNUcmFuc21pdHRlZCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X3BhY2tldHNfdHggPj4gM10pCiAgfQoKICBnZXQgYnl0ZXNSZWNlaXZlZCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X2J5dGVzX3J4ID4+IDNdKQogIH0KCiAgZ2V0IHBhY2tldHNSZWNlaXZlZCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X3BhY2tldHNfcnggPj4gM10pCiAgfQoKICBnZXQgbG9jYWxIb3N0KCkgewogICAgcmV0dXJuIHRoaXMuc29ja2V0ID8gdGhpcy5zb2NrZXQuYWRkcmVzcygpLmhvc3QgOiBudWxsCiAgfQoKICBnZXQgbG9jYWxGYW1pbHkoKSB7CiAgICByZXR1cm4gdGhpcy5zb2NrZXQgPyB0aGlzLnNvY2tldC5hZGRyZXNzKCkuZmFtaWx5IDogMAogIH0KCiAgZ2V0IGxvY2FsUG9ydCgpIHsKICAgIHJldHVybiB0aGlzLnNvY2tldCA/IHRoaXMuc29ja2V0LmFkZHJlc3MoKS5wb3J0IDogMAogIH0KCiAgc2V0SW50ZXJhY3RpdmUoYm9vbCkgewogICAgaWYgKCF0aGlzLl9jbG9zZWQpIHJldHVybgogICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fc2V0X21vZGUodGhpcy5faGFuZGxlLCBib29sID8gMCA6IDEpCiAgfQoKICBjb25uZWN0KHNvY2tldCwgcmVtb3RlSWQsIHBvcnQsIGhvc3QsIG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMuX2Nsb3NlZCkgcmV0dXJuCgogICAgaWYgKHRoaXMuY29ubmVjdGVkKSB0aHJvdyBuZXcgRXJyb3IoJ0FscmVhZHkgY29ubmVjdGVkJykKICAgIGlmIChzb2NrZXQuY2xvc2luZykgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgaXMgY2xvc2VkJykKCiAgICBpZiAodHlwZW9mIGhvc3QgPT09ICdvYmplY3QnKSB7CiAgICAgIG9wdHMgPSBob3N0CiAgICAgIGhvc3QgPSBudWxsCiAgICB9CgogICAgaWYgKCFob3N0KSBob3N0ID0gJzEyNy4wLjAuMScKCiAgICBjb25zdCBmYW1pbHkgPSBpcC5pc0lQKGhvc3QpCiAgICBpZiAoIWZhbWlseSkgdGhyb3cgbmV3IEVycm9yKGAke2hvc3R9IGlzIG5vdCBhIHZhbGlkIElQIGFkZHJlc3NgKQogICAgaWYgKCEocG9ydCA+IDAgJiYgcG9ydCA8IDY1NTM2KSkgdGhyb3cgbmV3IEVycm9yKGAke3BvcnR9IGlzIG5vdCBhIHZhbGlkIHBvcnRgKQoKICAgIGlmICghc29ja2V0LmJvdW5kKSBzb2NrZXQuYmluZCgwKQoKICAgIHRoaXMucmVtb3RlSWQgPSByZW1vdGVJZAogICAgdGhpcy5yZW1vdGVQb3J0ID0gcG9ydAogICAgdGhpcy5yZW1vdGVIb3N0ID0gaG9zdAogICAgdGhpcy5yZW1vdGVGYW1pbHkgPSBmYW1pbHkKICAgIHRoaXMuc29ja2V0ID0gc29ja2V0CgogICAgaWYgKG9wdHMuYWNrKSBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV9zZXRfYWNrKHRoaXMuX2hhbmRsZSwgb3B0cy5hY2spCgogICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fY29ubmVjdCh0aGlzLl9oYW5kbGUsIHNvY2tldC5faGFuZGxlLCByZW1vdGVJZCwgcG9ydCwgaG9zdCwgZmFtaWx5KQoKICAgIHRoaXMuc29ja2V0Ll9hZGRTdHJlYW0odGhpcykKCiAgICB0aGlzLmVtaXQoJ2Nvbm5lY3QnKQogIH0KCiAgY2hhbmdlUmVtb3RlKHNvY2tldCwgcmVtb3RlSWQsIHBvcnQsIGhvc3QpIHsKICAgIGlmICh0aGlzLl9yZW1vdGVDaGFuZ2luZykgdGhyb3cgbmV3IEVycm9yKCdSZW1vdGUgYWxyZWFkeSBjaGFuZ2luZycpCgogICAgaWYgKCF0aGlzLmNvbm5lY3RlZCkgdGhyb3cgbmV3IEVycm9yKCdOb3QgeWV0IGNvbm5lY3RlZCcpCiAgICBpZiAoc29ja2V0LmNsb3NpbmcpIHRocm93IG5ldyBFcnJvcignU29ja2V0IGlzIGNsb3NlZCcpCgogICAgaWYgKHRoaXMuc29ja2V0LnVkeCAhPT0gc29ja2V0LnVkeCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBjaGFuZ2UgdG8gYSBzb2NrZXQgb24gYW5vdGhlciBVRFggaW5zdGFuY2UnKQogICAgfQoKICAgIGlmICghaG9zdCkgaG9zdCA9ICcxMjcuMC4wLjEnCgogICAgY29uc3QgZmFtaWx5ID0gaXAuaXNJUChob3N0KQogICAgaWYgKCFmYW1pbHkpIHRocm93IG5ldyBFcnJvcihgJHtob3N0fSBpcyBub3QgYSB2YWxpZCBJUCBhZGRyZXNzYCkKICAgIGlmICghKHBvcnQgPiAwICYmIHBvcnQgPCA2NTUzNikpIHRocm93IG5ldyBFcnJvcihgJHtwb3J0fSBpcyBub3QgYSB2YWxpZCBwb3J0YCkKCiAgICBpZiAodGhpcy5zb2NrZXQgIT09IHNvY2tldCkgdGhpcy5fcHJldmlvdXNTb2NrZXQgPSB0aGlzLnNvY2tldAoKICAgIHRoaXMucmVtb3RlSWQgPSByZW1vdGVJZAogICAgdGhpcy5yZW1vdGVQb3J0ID0gcG9ydAogICAgdGhpcy5yZW1vdGVIb3N0ID0gaG9zdAogICAgdGhpcy5yZW1vdGVGYW1pbHkgPSBmYW1pbHkKICAgIHRoaXMuc29ja2V0ID0gc29ja2V0CgogICAgdGhpcy5fcmVtb3RlQ2hhbmdpbmcgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGNvbnN0IG9uY2hhbmdlZCA9ICgpID0+IHsKICAgICAgICB0aGlzLm9mZignY2xvc2UnLCBvbmNsb3NlKQogICAgICAgIHJlc29sdmUoKQogICAgICB9CgogICAgICBjb25zdCBvbmNsb3NlID0gKCkgPT4gewogICAgICAgIHRoaXMub2ZmKCdyZW1vdGUtY2hhbmdlZCcsIG9uY2hhbmdlZCkKICAgICAgICByZWplY3QobmV3IEVycm9yKCdTdHJlYW0gaXMgY2xvc2VkJykpCiAgICAgIH0KCiAgICAgIHRoaXMub25jZSgncmVtb3RlLWNoYW5nZWQnLCBvbmNoYW5nZWQpLm9uY2UoJ2Nsb3NlJywgb25jbG9zZSkKICAgIH0pCgogICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fY2hhbmdlX3JlbW90ZSgKICAgICAgdGhpcy5faGFuZGxlLAogICAgICBzb2NrZXQuX2hhbmRsZSwKICAgICAgcmVtb3RlSWQsCiAgICAgIHBvcnQsCiAgICAgIGhvc3QsCiAgICAgIGZhbWlseQogICAgKQoKICAgIHRoaXMuc29ja2V0Ll9hZGRTdHJlYW0odGhpcykKCiAgICByZXR1cm4gdGhpcy5fcmVtb3RlQ2hhbmdpbmcKICB9CgogIHJlbGF5VG8oZGVzdGluYXRpb24pIHsKICAgIGlmICh0aGlzLl9jbG9zZWQpIHJldHVybgoKICAgIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX3JlbGF5X3RvKHRoaXMuX2hhbmRsZSwgZGVzdGluYXRpb24uX2hhbmRsZSkKICB9CgogIGFzeW5jIHNlbmQoYnVmZmVyKSB7CiAgICBpZiAoIXRoaXMuY29ubmVjdGVkIHx8IHRoaXMuX2Nsb3NlZCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgaWQgPSB0aGlzLl9hbGxvY1NlbmQoKQogICAgY29uc3QgcmVxID0gdGhpcy5fc3JlcXNbaWRdCgogICAgcmVxLmJ1ZmZlciA9IGJ1ZmZlcgoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICByZXEub25mbHVzaCA9IHJlc29sdmUKICAgIH0pCgogICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fc2VuZCh0aGlzLl9oYW5kbGUsIHJlcS5oYW5kbGUsIGlkLCBidWZmZXIpCgogICAgcmV0dXJuIHByb21pc2UKICB9CgogIHRyeVNlbmQoYnVmZmVyKSB7CiAgICBpZiAoIXRoaXMuY29ubmVjdGVkIHx8IHRoaXMuX2Nsb3NlZCkgcmV0dXJuCgogICAgY29uc3QgaWQgPSB0aGlzLl9hbGxvY1NlbmQoKQogICAgY29uc3QgcmVxID0gdGhpcy5fc3JlcXNbaWRdCgogICAgcmVxLmJ1ZmZlciA9IGJ1ZmZlcgogICAgcmVxLm9uZmx1c2ggPSBub29wCgogICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fc2VuZCh0aGlzLl9oYW5kbGUsIHJlcS5oYW5kbGUsIGlkLCBidWZmZXIpCiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGlmICgoYXdhaXQgc3RyZWFteC5Xcml0YWJsZS5kcmFpbmVkKHRoaXMpKSA9PT0gZmFsc2UpIHJldHVybiBmYWxzZQogICAgaWYgKHRoaXMuZGVzdHJveWluZykgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgbWlzc2luZyA9IHRoaXMuX3dyZXFzLmxlbmd0aCAtIHRoaXMuX3dmcmVlLmxlbmd0aAogICAgaWYgKG1pc3NpbmcgPT09IDApIHJldHVybiB0cnVlCgogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgIHRoaXMuX2ZsdXNoZXMucHVzaCh7IGZsdXNoOiB0aGlzLl9mbHVzaGluZysrLCBtaXNzaW5nLCByZXNvbHZlIH0pCiAgICB9KQogIH0KCiAgdG9KU09OKCkgewogICAgcmV0dXJuIHsKICAgICAgaWQ6IHRoaXMuaWQsCiAgICAgIGNvbm5lY3RlZDogdGhpcy5jb25uZWN0ZWQsCiAgICAgIGRlc3Ryb3lpbmc6IHRoaXMuZGVzdHJveWluZywKICAgICAgZGVzdHJveWVkOiB0aGlzLmRlc3Ryb3llZCwKICAgICAgcmVtb3RlSWQ6IHRoaXMucmVtb3RlSWQsCiAgICAgIHJlbW90ZUhvc3Q6IHRoaXMucmVtb3RlSG9zdCwKICAgICAgcmVtb3RlRmFtaWx5OiB0aGlzLnJlbW90ZUZhbWlseSwKICAgICAgcmVtb3RlUG9ydDogdGhpcy5yZW1vdGVQb3J0LAogICAgICBtdHU6IHRoaXMubXR1LAogICAgICBydHQ6IHRoaXMucnR0LAogICAgICBjd25kOiB0aGlzLmN3bmQsCiAgICAgIGluZmxpZ2h0OiB0aGlzLmluZmxpZ2h0LAogICAgICBzb2NrZXQ6IHRoaXMuc29ja2V0ID8gdGhpcy5zb2NrZXQudG9KU09OKCkgOiBudWxsCiAgICB9CiAgfQoKICBfcmVhZChjYikgewogICAgY2IobnVsbCkKICB9CgogIF93cml0ZUNvbnRpbnVlKGVycikgewogICAgaWYgKHRoaXMuX29ud3JpdGUgPT09IG51bGwpIHJldHVybgogICAgY29uc3QgY2IgPSB0aGlzLl9vbndyaXRlCiAgICB0aGlzLl9vbndyaXRlID0gbnVsbAogICAgY2IoZXJyKQogIH0KCiAgX2Rlc3Ryb3lDb250aW51ZShlcnIpIHsKICAgIGlmICh0aGlzLl9vbmRlc3Ryb3kgPT09IG51bGwpIHJldHVybgogICAgY29uc3QgY2IgPSB0aGlzLl9vbmRlc3Ryb3kKICAgIHRoaXMuX29uZGVzdHJveSA9IG51bGwKICAgIGNiKGVycikKICB9CgogIF93cml0ZXYoYnVmZmVycywgY2IpIHsKICAgIGlmICghdGhpcy5jb25uZWN0ZWQpCiAgICAgIHRocm93IGN1c3RvbUVycm9yKCdXcml0aW5nIHdoaWxlIG5vdCBjb25uZWN0ZWQgbm90IGN1cnJlbnRseSBzdXBwb3J0ZWQnLCAnRVJSX0FTU0VSVElPTicpCgogICAgbGV0IGRyYWluZWQgPSB0cnVlCgogICAgaWYgKGJ1ZmZlcnMubGVuZ3RoID09PSAxKSB7CiAgICAgIGNvbnN0IGlkID0gdGhpcy5fYWxsb2NXcml0ZSgxKQogICAgICBjb25zdCByZXEgPSB0aGlzLl93cmVxc1tpZF0KCiAgICAgIHJlcS5mbHVzaCA9IHRoaXMuX2ZsdXNoaW5nCiAgICAgIHJlcS5idWZmZXIgPSBidWZmZXJzWzBdCgogICAgICBkcmFpbmVkID0gYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fd3JpdGUodGhpcy5faGFuZGxlLCByZXEuaGFuZGxlLCBpZCwgcmVxLmJ1ZmZlcikgIT09IDAKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGlkID0gdGhpcy5fYWxsb2NXcml0ZShuZXh0QmF0Y2hTaXplKGJ1ZmZlcnMubGVuZ3RoKSkKICAgICAgY29uc3QgcmVxID0gdGhpcy5fd3JlcXNbaWRdCgogICAgICByZXEuZmx1c2ggPSB0aGlzLl9mbHVzaGluZwogICAgICByZXEuYnVmZmVycyA9IGJ1ZmZlcnMKCiAgICAgIGRyYWluZWQgPSBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV93cml0ZXYodGhpcy5faGFuZGxlLCByZXEuaGFuZGxlLCBpZCwgcmVxLmJ1ZmZlcnMpICE9PSAwCiAgICB9CgogICAgaWYgKGRyYWluZWQpIGNiKG51bGwpCiAgICBlbHNlIHRoaXMuX29ud3JpdGUgPSBjYgogIH0KCiAgX2ZpbmFsKGNiKSB7CiAgICBjb25zdCBpZCA9IHRoaXMuX2FsbG9jV3JpdGUoMSkKICAgIGNvbnN0IHJlcSA9IHRoaXMuX3dyZXFzW2lkXQoKICAgIHJlcS5mbHVzaCA9IHRoaXMuX2ZsdXNoZXMKICAgIHJlcS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoMCkKCiAgICBjb25zdCBkcmFpbmVkID0KICAgICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fd3JpdGVfZW5kKHRoaXMuX2hhbmRsZSwgcmVxLmhhbmRsZSwgaWQsIHJlcS5idWZmZXIpICE9PSAwCgogICAgaWYgKGRyYWluZWQpIGNiKG51bGwpCiAgICBlbHNlIHRoaXMuX29ud3JpdGUgPSBjYgogIH0KCiAgX3ByZWRlc3Ryb3koKSB7CiAgICBpZiAoIXRoaXMuX2Nsb3NlZCkgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fZGVzdHJveSh0aGlzLl9oYW5kbGUpCiAgICB0aGlzLl9jbG9zZWQgPSB0cnVlCiAgICB0aGlzLl93cml0ZUNvbnRpbnVlKG51bGwpCiAgfQoKICBfZGVzdHJveShjYikgewogICAgaWYgKHRoaXMuY29ubmVjdGVkKSB0aGlzLl9vbmRlc3Ryb3kgPSBjYgogICAgZWxzZSBjYihudWxsKQogIH0KCiAgX29uZGF0YShyZWFkKSB7CiAgICB0aGlzLnB1c2godGhpcy5fY29uc3VtZURhdGEocmVhZCkpCiAgICByZXR1cm4gdGhpcy5fYnVmZmVyCiAgfQoKICBfb25lbmQocmVhZCkgewogICAgaWYgKHJlYWQgPiAwKSB0aGlzLnB1c2godGhpcy5fY29uc3VtZURhdGEocmVhZCkpCiAgICB0aGlzLnB1c2gobnVsbCkKICB9CgogIF9vbmRyYWluKCkgewogICAgdGhpcy5fd3JpdGVDb250aW51ZShudWxsKQogIH0KCiAgX2ZsdXNoQWNrKGZsdXNoKSB7CiAgICBmb3IgKGxldCBpID0gdGhpcy5fZmx1c2hlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBmID0gdGhpcy5fZmx1c2hlc1tpXQogICAgICBpZiAoZi5mbHVzaCA8IGZsdXNoKSBicmVhawogICAgICBmLm1pc3NpbmctLQogICAgfQoKICAgIHdoaWxlICh0aGlzLl9mbHVzaGVzLmxlbmd0aCA+IDAgJiYgdGhpcy5fZmx1c2hlc1swXS5taXNzaW5nID09PSAwKSB7CiAgICAgIHRoaXMuX2ZsdXNoZXMuc2hpZnQoKS5yZXNvbHZlKHRydWUpCiAgICB9CiAgfQoKICBfb25hY2soaWQpIHsKICAgIGNvbnN0IHJlcSA9IHRoaXMuX3dyZXFzW2lkXQoKICAgIHJlcS5idWZmZXJzID0gcmVxLmJ1ZmZlciA9IG51bGwKICAgIHRoaXMuX3dmcmVlLnB1c2goaWQpCgogICAgaWYgKHRoaXMuX2ZsdXNoZXMubGVuZ3RoID4gMCkgdGhpcy5fZmx1c2hBY2socmVxLmZsdXNoKQoKICAgIC8vIGdjIHRoZSBmcmVlIGxpc3QKICAgIGlmICh0aGlzLl93ZnJlZS5sZW5ndGggPj0gNjQgJiYgdGhpcy5fd2ZyZWUubGVuZ3RoID09PSB0aGlzLl93cmVxcy5sZW5ndGgpIHsKICAgICAgdGhpcy5fd2ZyZWUgPSBbXQogICAgICB0aGlzLl93cmVxcyA9IFtdCiAgICB9CiAgfQoKICBfb25zZW5kKGlkLCBlcnIpIHsKICAgIGNvbnN0IHJlcSA9IHRoaXMuX3NyZXFzW2lkXQoKICAgIGNvbnN0IG9uZmx1c2ggPSByZXEub25mbHVzaAoKICAgIHJlcS5idWZmZXIgPSBudWxsCiAgICByZXEub25mbHVzaCA9IG51bGwKCiAgICB0aGlzLl9zZnJlZS5wdXNoKGlkKQoKICAgIG9uZmx1c2goZXJyID49IDApCgogICAgLy8gZ2MgdGhlIGZyZWUgbGlzdAogICAgaWYgKHRoaXMuX3NmcmVlLmxlbmd0aCA+PSAxNiAmJiB0aGlzLl9zZnJlZS5sZW5ndGggPT09IHRoaXMuX3NyZXFzLmxlbmd0aCkgewogICAgICB0aGlzLl9zZnJlZSA9IFtdCiAgICAgIHRoaXMuX3NyZXFzID0gW10KICAgIH0KICB9CgogIF9vbm1lc3NhZ2UobGVuKSB7CiAgICB0aGlzLmVtaXQoJ21lc3NhZ2UnLCB0aGlzLnVkeC5fY29uc3VtZU1lc3NhZ2UobGVuKSkKICAgIHJldHVybiB0aGlzLnVkeC5fYnVmZmVyCiAgfQoKICBfb25jbG9zZShlcnIpIHsKICAgIHRoaXMuX2Nsb3NlZCA9IHRydWUKCiAgICBpZiAodGhpcy5zb2NrZXQpIHsKICAgICAgdGhpcy5zb2NrZXQuX3JlbW92ZVN0cmVhbSh0aGlzKQogICAgICB0aGlzLnNvY2tldCA9IG51bGwKICAgIH0KCiAgICBpZiAodGhpcy5fcHJldmlvdXNTb2NrZXQpIHsKICAgICAgdGhpcy5fcHJldmlvdXNTb2NrZXQuX3JlbW92ZVN0cmVhbSh0aGlzKQogICAgICB0aGlzLl9wcmV2aW91c1NvY2tldCA9IG51bGwKICAgIH0KCiAgICAvLyBubyBlcnJvciwgd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZwogICAgaWYgKCFlcnIpIHJldHVybiB0aGlzLl9kZXN0cm95Q29udGludWUobnVsbCkKCiAgICBpZiAodGhpcy5fb25kZXN0cm95ID09PSBudWxsKSB0aGlzLmRlc3Ryb3koZXJyKQogICAgZWxzZSB0aGlzLl9kZXN0cm95Q29udGludWUoZXJyKQogIH0KCiAgX29uZmlyZXdhbGwoc29ja2V0LCBwb3J0LCBob3N0LCBmYW1pbHkpIHsKICAgIHJldHVybiB0aGlzLl9maXJld2FsbChzb2NrZXQsIHBvcnQsIGhvc3QsIGZhbWlseSkgPyAxIDogMAogIH0KCiAgX29ucmVtb3RlY2hhbmdlZCgpIHsKICAgIGlmICh0aGlzLl9wcmV2aW91c1NvY2tldCkgewogICAgICB0aGlzLl9wcmV2aW91c1NvY2tldC5fcmVtb3ZlU3RyZWFtKHRoaXMpCiAgICAgIHRoaXMuX3ByZXZpb3VzU29ja2V0ID0gbnVsbAogICAgfQoKICAgIHRoaXMuX3JlbW90ZUNoYW5naW5nID0gbnVsbAogICAgdGhpcy5lbWl0KCdyZW1vdGUtY2hhbmdlZCcpCiAgfQoKICBfY29uc3VtZURhdGEobGVuKSB7CiAgICBjb25zdCBuZXh0ID0gdGhpcy5fYnVmZmVyLnN1YmFycmF5KDAsIGxlbikKICAgIHRoaXMuX2J1ZmZlciA9IHRoaXMuX2J1ZmZlci5zdWJhcnJheShsZW4pCiAgICBpZiAodGhpcy5fYnVmZmVyLmJ5dGVMZW5ndGggPCBNQVhfUEFDS0VUKSB0aGlzLl9yZWFsbG9jRGF0YSgpCiAgICByZXR1cm4gbmV4dAogIH0KCiAgX3JlYWxsb2NEYXRhKCkgewogICAgdGhpcy5fYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKEJVRkZFUl9TSVpFKQogICAgcmV0dXJuIHRoaXMuX2J1ZmZlcgogIH0KCiAgX3JlYWxsb2NNZXNzYWdlKCkgewogICAgcmV0dXJuIHRoaXMudWR4Ll9yZWFsbG9jTWVzc2FnZSgpCiAgfQoKICBfYWxsb2NXcml0ZShzaXplKSB7CiAgICBpZiAodGhpcy5fd2ZyZWUubGVuZ3RoID09PSAwKSB7CiAgICAgIGNvbnN0IGhhbmRsZSA9IGI0YS5hbGxvY1Vuc2FmZShiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV93cml0ZV9zaXplb2Yoc2l6ZSkpCiAgICAgIHJldHVybiAoCiAgICAgICAgdGhpcy5fd3JlcXMucHVzaCh7CiAgICAgICAgICBoYW5kbGUsCiAgICAgICAgICBzaXplLAogICAgICAgICAgYnVmZmVyczogbnVsbCwKICAgICAgICAgIGJ1ZmZlcjogbnVsbCwKICAgICAgICAgIGZsdXNoOiAwCiAgICAgICAgfSkgLSAxCiAgICAgICkKICAgIH0KCiAgICBjb25zdCBmcmVlID0gdGhpcy5fd2ZyZWUucG9wKCkKICAgIGlmIChzaXplID09PSAxKSByZXR1cm4gZnJlZQoKICAgIGNvbnN0IG5leHQgPSB0aGlzLl93cmVxc1tmcmVlXQogICAgaWYgKG5leHQuc2l6ZSA8IHNpemUpIHsKICAgICAgbmV4dC5oYW5kbGUgPSBiNGEuYWxsb2NVbnNhZmUoYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fd3JpdGVfc2l6ZW9mKHNpemUpKQogICAgICBuZXh0LnNpemUgPSBzaXplCiAgICB9CgogICAgcmV0dXJuIGZyZWUKICB9CgogIF9hbGxvY1NlbmQoKSB7CiAgICBpZiAodGhpcy5fc2ZyZWUubGVuZ3RoID4gMCkgcmV0dXJuIHRoaXMuX3NmcmVlLnBvcCgpCiAgICBjb25zdCBoYW5kbGUgPSBiNGEuYWxsb2NVbnNhZmUoYmluZGluZy5zaXplb2ZfdWR4X3N0cmVhbV9zZW5kX3QpCiAgICByZXR1cm4gdGhpcy5fc3JlcXMucHVzaCh7IGhhbmRsZSwgYnVmZmVyOiBudWxsLCByZXNvbHZlOiBudWxsLCByZWplY3Q6IG51bGwgfSkgLSAxCiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIHRvQnVmZmVyKGRhdGEpIHsKICByZXR1cm4gdHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnID8gYjRhLmZyb20oZGF0YSkgOiBkYXRhCn0KCmZ1bmN0aW9uIGZpcmV3YWxsQWxsKHNvY2tldCwgcG9ydCwgaG9zdCkgewogIHJldHVybiB0cnVlCn0KCmZ1bmN0aW9uIGN1c3RvbUVycm9yKG1lc3NhZ2UsIGNvZGUpIHsKICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcihtZXNzYWdlKQogIGVycm9yLmNvZGUgPSBjb2RlCiAgcmV0dXJuIGVycm9yCn0KCmZ1bmN0aW9uIG5leHRCYXRjaFNpemUobikgewogIC8vIHRyeSB0byBjb2VyY2UgdGhlIHRoZSB3cml0ZXZzIGludG8gc2FtZWlzaCBzaXplCiAgaWYgKG4gPT09IDEpIHJldHVybiAxCiAgLy8gZ3JvdXAgYWxsIDwgOCB0byB0aGUgc2FtZSBzaXplLCBsb3cgbWVtIG92ZXJoZWFkIGJ1dCBzYXZlIHNvbWUgc21hbGwgYWxsb2NzCiAgaWYgKG4gPCA4KSByZXR1cm4gOAogIGlmIChuIDwgMTYpIHJldHVybiAxNgogIGlmIChuIDwgMzIpIHJldHVybiAzMgogIGlmIChuIDwgNjQpIHJldHVybiA2NAogIHJldHVybiBuCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQpjb25zdCBpcCA9IHJlcXVpcmUoJy4vaXAnKQpjb25zdCBTb2NrZXQgPSByZXF1aXJlKCcuL3NvY2tldCcpCmNvbnN0IFN0cmVhbSA9IHJlcXVpcmUoJy4vc3RyZWFtJykKY29uc3QgTmV0d29ya0ludGVyZmFjZXMgPSByZXF1aXJlKCcuL25ldHdvcmstaW50ZXJmYWNlcycpCgpjb25zdCBNQVhfTUVTU0FHRSA9IDQwOTYKY29uc3QgQlVGRkVSX1NJWkUgPSA2NTUzNiArIE1BWF9NRVNTQUdFCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFVEWCB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLl9oYW5kbGUgPSBiNGEuYWxsb2MoYmluZGluZy5zaXplb2ZfdWR4X25hcGlfdCkKICAgIHRoaXMuX3dhdGNoZXJzID0gbmV3IFNldCgpCiAgICB0aGlzLl92aWV3NjQgPSBuZXcgQmlnVWludDY0QXJyYXkoCiAgICAgIHRoaXMuX2hhbmRsZS5idWZmZXIsCiAgICAgIHRoaXMuX2hhbmRsZS5ieXRlT2Zmc2V0LAogICAgICB0aGlzLl9oYW5kbGUuYnl0ZUxlbmd0aCA+PiAzCiAgICApCgogICAgdGhpcy5fYnVmZmVyID0gbnVsbAogICAgdGhpcy5fcmVhbGxvY01lc3NhZ2UoKQoKICAgIGJpbmRpbmcudWR4X25hcGlfaW5pdCh0aGlzLl9oYW5kbGUsIHRoaXMuX2J1ZmZlcikKICB9CgogIHN0YXRpYyBpc0lQdjQoaG9zdCkgewogICAgcmV0dXJuIGlwLmlzSVB2NChob3N0KQogIH0KCiAgc3RhdGljIGlzSVB2Nihob3N0KSB7CiAgICByZXR1cm4gaXAuaXNJUHY2KGhvc3QpCiAgfQoKICBzdGF0aWMgaXNJUChob3N0KSB7CiAgICByZXR1cm4gaXAuaXNJUChob3N0KQogIH0KCiAgZ2V0IGJ5dGVzVHJhbnNtaXR0ZWQoKSB7CiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF90X2J5dGVzX3R4ID4+IDNdKQogIH0KCiAgZ2V0IHBhY2tldHNUcmFuc21pdHRlZCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3RfcGFja2V0c190eCA+PiAzXSkKICB9CgogIGdldCBieXRlc1JlY2VpdmVkKCkgewogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfdF9ieXRlc19yeCA+PiAzXSkKICB9CgogIGdldCBwYWNrZXRzUmVjZWl2ZWQoKSB7CiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF90X3BhY2tldHNfcnggPj4gM10pCiAgfQoKICBnZXQgcGFja2V0c0Ryb3BwZWRCeUtlcm5lbCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3RfcGFja2V0c19kcm9wcGVkX2J5X2tlcm5lbCA+PiAzXSkKICB9CgogIF9jb25zdW1lTWVzc2FnZShsZW4pIHsKICAgIGNvbnN0IG5leHQgPSB0aGlzLl9idWZmZXIuc3ViYXJyYXkoMCwgbGVuKQogICAgdGhpcy5fYnVmZmVyID0gdGhpcy5fYnVmZmVyLnN1YmFycmF5KGxlbikKICAgIGlmICh0aGlzLl9idWZmZXIuYnl0ZUxlbmd0aCA8IE1BWF9NRVNTQUdFKSB0aGlzLl9yZWFsbG9jTWVzc2FnZSgpCiAgICByZXR1cm4gbmV4dAogIH0KCiAgX3JlYWxsb2NNZXNzYWdlKCkgewogICAgLy8gVE9ETzogbW92ZSByZWFsbG9jYXRpb24gdG8gbmF0aXZlCiAgICB0aGlzLl9idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoQlVGRkVSX1NJWkUpCiAgICByZXR1cm4gdGhpcy5fYnVmZmVyCiAgfQoKICBjcmVhdGVTb2NrZXQob3B0cykgewogICAgcmV0dXJuIG5ldyBTb2NrZXQodGhpcywgb3B0cykKICB9CgogIGNyZWF0ZVN0cmVhbShpZCwgb3B0cykgewogICAgcmV0dXJuIG5ldyBTdHJlYW0odGhpcywgaWQsIG9wdHMpCiAgfQoKICBuZXR3b3JrSW50ZXJmYWNlcygpIHsKICAgIGxldCBbd2F0Y2hlciA9IG51bGxdID0gdGhpcy5fd2F0Y2hlcnMKICAgIGlmICh3YXRjaGVyKSByZXR1cm4gd2F0Y2hlci5pbnRlcmZhY2VzCgogICAgd2F0Y2hlciA9IG5ldyBOZXR3b3JrSW50ZXJmYWNlcyh0aGlzKQogICAgd2F0Y2hlci5kZXN0cm95KCkKCiAgICByZXR1cm4gd2F0Y2hlci5pbnRlcmZhY2VzCiAgfQoKICB3YXRjaE5ldHdvcmtJbnRlcmZhY2VzKG9uY2hhbmdlKSB7CiAgICBjb25zdCB3YXRjaGVyID0gbmV3IE5ldHdvcmtJbnRlcmZhY2VzKHRoaXMpCgogICAgdGhpcy5fd2F0Y2hlcnMuYWRkKHdhdGNoZXIpCiAgICB3YXRjaGVyLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgdGhpcy5fd2F0Y2hlcnMuZGVsZXRlKHdhdGNoZXIpCiAgICB9KQoKICAgIGlmIChvbmNoYW5nZSkgd2F0Y2hlci5vbignY2hhbmdlJywgb25jaGFuZ2UpCgogICAgcmV0dXJuIHdhdGNoZXIud2F0Y2goKQogIH0KCiAgYXN5bmMgbG9va3VwKGhvc3QsIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyBmYW1pbHkgPSAwIH0gPSBvcHRzCgogICAgY29uc3QgcmVxID0gYjRhLmFsbG9jKGJpbmRpbmcuc2l6ZW9mX3VkeF9uYXBpX2xvb2t1cF90KQogICAgY29uc3QgY3R4ID0gewogICAgICByZXEsCiAgICAgIHJlc29sdmU6IG51bGwsCiAgICAgIHJlamVjdDogbnVsbAogICAgfQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGN0eC5yZXNvbHZlID0gcmVzb2x2ZQogICAgICBjdHgucmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIGJpbmRpbmcudWR4X25hcGlfbG9va3VwKHRoaXMuX2hhbmRsZSwgcmVxLCBob3N0LCBmYW1pbHksIGN0eCwgb25sb29rdXApCgogICAgcmV0dXJuIHByb21pc2UKICB9Cn0KCmZ1bmN0aW9uIG9ubG9va3VwKGVyciwgaG9zdCwgZmFtaWx5KSB7CiAgaWYgKGVycikgdGhpcy5yZWplY3QoZXJyKQogIGVsc2UgdGhpcy5yZXNvbHZlKHsgaG9zdCwgZmFtaWx5IH0pCn0KewogICJuYW1lIjogInVkeC1uYXRpdmUiLAogICJ2ZXJzaW9uIjogIjEuMTkuMiIsCiAgImRlc2NyaXB0aW9uIjogInVkeCBpcyByZWxpYWJsZSwgbXVsdGlwbGV4ZWQsIGFuZCBjb25nZXN0aW9uLWNvbnRyb2xsZWQgc3RyZWFtcyBvdmVyIHVkcCIsCiAgIm1haW4iOiAibGliL3VkeC5qcyIsCiAgImZpbGVzIjogWwogICAgImxpYiIsCiAgICAicHJlYnVpbGRzIiwKICAgICJiaW5kaW5nLmNjIiwKICAgICJiaW5kaW5nLmpzIiwKICAgICJDTWFrZUxpc3RzLnR4dCIKICBdLAogICJpbXBvcnRzIjogewogICAgImV2ZW50cyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1ldmVudHMiLAogICAgICAiZGVmYXVsdCI6ICJldmVudHMiCiAgICB9CiAgfSwKICAiYWRkb24iOiB0cnVlLAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuIiwKICAgICJ0ZXN0IjogIm5wbSBydW4gbGludCAmJiBucG0gcnVuIHRlc3Q6YmFyZSAmJiBucG0gcnVuIHRlc3Q6bm9kZSIsCiAgICAidGVzdDpub2RlIjogIm5vZGUgdGVzdC9hbGwuanMiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmFsbCI6ICJicml0dGxlIHRlc3QvKi5qcyB0ZXN0L3Nsb3cvKi5qcyIsCiAgICAidGVzdDpnZW5lcmF0ZSI6ICJicml0dGxlIC1yIHRlc3QvYWxsLmpzIHRlc3QvKi5qcyIsCiAgICAiYmVuY2giOiAiYnJpdHRsZSB0ZXN0L2JlbmNoLyouanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vdWR4LW5hdGl2ZS5naXQiCiAgfSwKICAia2V5d29yZHMiOiBbCiAgICAidGNwIiwKICAgICJ1ZHAiLAogICAgInN0cmVhbSIsCiAgICAicmVsaWFibGUiCiAgXSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMuIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3VkeC1uYXRpdmUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by91ZHgtbmF0aXZlI3JlYWRtZSIsCiAgImVuZ2luZXMiOiB7CiAgICAiYmFyZSI6ICI+PTEuMTcuNCIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjUuMCIsCiAgICAiYmFyZS1ldmVudHMiOiAiXjIuMi4wIiwKICAgICJyZXF1aXJlLWFkZG9uIjogIl4xLjEuMCIsCiAgICAic3RyZWFteCI6ICJeMi4yMi4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWNvbXBhdC1uYXBpIjogIl4xLjMuMCIsCiAgICAiYnJpdHRsZSI6ICJeMy4xLjAiLAogICAgImNtYWtlLWJhcmUiOiAiXjEuMS4xMCIsCiAgICAiY21ha2UtZmV0Y2giOiAiXjEuMC4xIiwKICAgICJjbWFrZS1uYXBpIjogIl4xLjAuNSIsCiAgICAiaXMtY2kiOiAiXjMuMC4xIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIiwKICAgICJ0aW55LWJ5dGUtc2l6ZSI6ICJeMS4xLjAiCiAgfQp9CmV4cG9ydHMuYWRkID0gYWRkCmV4cG9ydHMuaGFzID0gaGFzCmV4cG9ydHMucmVtb3ZlID0gcmVtb3ZlCmV4cG9ydHMuc3dhcCA9IHN3YXAKCmZ1bmN0aW9uIGFkZCAobGlzdCwgaXRlbSkgewogIGlmIChoYXMobGlzdCwgaXRlbSkpIHJldHVybiBpdGVtCiAgaXRlbS5faW5kZXggPSBsaXN0Lmxlbmd0aAogIGxpc3QucHVzaChpdGVtKQogIHJldHVybiBpdGVtCn0KCmZ1bmN0aW9uIGhhcyAobGlzdCwgaXRlbSkgewogIHJldHVybiBpdGVtLl9pbmRleCA8IGxpc3QubGVuZ3RoICYmIGxpc3RbaXRlbS5faW5kZXhdID09PSBpdGVtCn0KCmZ1bmN0aW9uIHJlbW92ZSAobGlzdCwgaXRlbSkgewogIGlmICghaGFzKGxpc3QsIGl0ZW0pKSByZXR1cm4gbnVsbAoKICB2YXIgbGFzdCA9IGxpc3QucG9wKCkKICBpZiAobGFzdCAhPT0gaXRlbSkgewogICAgbGlzdFtpdGVtLl9pbmRleF0gPSBsYXN0CiAgICBsYXN0Ll9pbmRleCA9IGl0ZW0uX2luZGV4CiAgfQoKICByZXR1cm4gaXRlbQp9CgpmdW5jdGlvbiBzd2FwIChsaXN0LCBhLCBiKSB7CiAgaWYgKCFoYXMobGlzdCwgYSkgfHwgIWhhcyhsaXN0LCBiKSkgcmV0dXJuCiAgdmFyIHRtcCA9IGEuX2luZGV4CiAgYS5faW5kZXggPSBiLl9pbmRleAogIGxpc3RbYS5faW5kZXhdID0gYQogIGIuX2luZGV4ID0gdG1wCiAgbGlzdFtiLl9pbmRleF0gPSBiCn0KewogICJuYW1lIjogInVub3JkZXJlZC1zZXQiLAogICJ2ZXJzaW9uIjogIjIuMC4xIiwKICAiZGVzY3JpcHRpb24iOiAiQSBjb3VwbGUgb2YgZnVuY3Rpb25zIHRoYXQgbWFrZSBpdCBlYXN5IHRvIG1haW50YWluIGFuIHVub3JkZXJlZCBzZXQgYXMgYW4gYXJyYXkgaW4gYW4gZWZmaWNpZW50IHdheSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl42LjAuNCIsCiAgICAidGFwZSI6ICJeNC40LjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC91bm9yZGVyZWQtc2V0LmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC91bm9yZGVyZWQtc2V0L2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3Vub3JkZXJlZC1zZXQiCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCnVuc2xhYi5hbGwgPSBhbGwKdW5zbGFiLmlzID0gaXMKCm1vZHVsZS5leHBvcnRzID0gdW5zbGFiCgpmdW5jdGlvbiB1bnNsYWIgKGJ1ZikgewogIGlmIChidWYgPT09IG51bGwgfHwgYnVmLmJ1ZmZlci5ieXRlTGVuZ3RoID09PSBidWYuYnl0ZUxlbmd0aCkgcmV0dXJuIGJ1ZgogIGNvbnN0IGNvcHkgPSBiNGEuYWxsb2NVbnNhZmVTbG93KGJ1Zi5ieXRlTGVuZ3RoKQogIGNvcHkuc2V0KGJ1ZiwgMCkKICByZXR1cm4gY29weQp9CgpmdW5jdGlvbiBpcyAoYnVmKSB7CiAgcmV0dXJuIGJ1Zi5idWZmZXIuYnl0ZUxlbmd0aCAhPT0gYnVmLmJ5dGVMZW5ndGgKfQoKZnVuY3Rpb24gYWxsIChsaXN0KSB7CiAgbGV0IHNpemUgPSAwCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBidWYgPSBsaXN0W2ldCiAgICBzaXplICs9IGJ1ZiA9PT0gbnVsbCB8fCBidWYuYnVmZmVyLmJ5dGVMZW5ndGggPT09IGJ1Zi5ieXRlTGVuZ3RoID8gMCA6IGJ1Zi5ieXRlTGVuZ3RoCiAgfQoKICBjb25zdCBjb3B5ID0gYjRhLmFsbG9jVW5zYWZlU2xvdyhzaXplKQogIGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheShsaXN0Lmxlbmd0aCkKCiAgbGV0IG9mZnNldCA9IDAKICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgIGxldCBidWYgPSBsaXN0W2ldCgogICAgaWYgKGJ1ZiAhPT0gbnVsbCAmJiBidWYuYnVmZmVyLmJ5dGVMZW5ndGggIT09IGJ1Zi5ieXRlTGVuZ3RoKSB7CiAgICAgIGNvcHkuc2V0KGJ1Ziwgb2Zmc2V0KQogICAgICBidWYgPSBjb3B5LnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICs9IGJ1Zi5ieXRlTGVuZ3RoKQogICAgfQoKICAgIHJlc3VsdFtpXSA9IGJ1ZgogIH0KCiAgcmV0dXJuIHJlc3VsdAp9CnsKICAibmFtZSI6ICJ1bnNsYWIiLAogICJ2ZXJzaW9uIjogIjEuMy4wIiwKICAiZGVzY3JpcHRpb24iOiAiVW5zbGFiIHNvbWUgc2xhYidlZCBidWZmZXJzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi42IgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjUuMiIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vdW5zbGFiLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3Vuc2xhYi9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3Vuc2xhYiIKfQptb2R1bGUuZXhwb3J0cyA9IHJlYWQKCnZhciBNU0IgPSAweDgwCiAgLCBSRVNUID0gMHg3RgoKZnVuY3Rpb24gcmVhZChidWYsIG9mZnNldCkgewogIHZhciByZXMgICAgPSAwCiAgICAsIG9mZnNldCA9IG9mZnNldCB8fCAwCiAgICAsIHNoaWZ0ICA9IDAKICAgICwgY291bnRlciA9IG9mZnNldAogICAgLCBiCiAgICAsIGwgPSBidWYubGVuZ3RoCgogIGRvIHsKICAgIGlmIChjb3VudGVyID49IGwpIHsKICAgICAgcmVhZC5ieXRlcyA9IDAKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0NvdWxkIG5vdCBkZWNvZGUgdmFyaW50JykKICAgIH0KICAgIGIgPSBidWZbY291bnRlcisrXQogICAgcmVzICs9IHNoaWZ0IDwgMjgKICAgICAgPyAoYiAmIFJFU1QpIDw8IHNoaWZ0CiAgICAgIDogKGIgJiBSRVNUKSAqIE1hdGgucG93KDIsIHNoaWZ0KQogICAgc2hpZnQgKz0gNwogIH0gd2hpbGUgKGIgPj0gTVNCKQoKICByZWFkLmJ5dGVzID0gY291bnRlciAtIG9mZnNldAoKICByZXR1cm4gcmVzCn0KbW9kdWxlLmV4cG9ydHMgPSBlbmNvZGUKCnZhciBNU0IgPSAweDgwCiAgLCBSRVNUID0gMHg3RgogICwgTVNCQUxMID0gflJFU1QKICAsIElOVCA9IE1hdGgucG93KDIsIDMxKQoKZnVuY3Rpb24gZW5jb2RlKG51bSwgb3V0LCBvZmZzZXQpIHsKICBvdXQgPSBvdXQgfHwgW10KICBvZmZzZXQgPSBvZmZzZXQgfHwgMAogIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKCiAgd2hpbGUobnVtID49IElOVCkgewogICAgb3V0W29mZnNldCsrXSA9IChudW0gJiAweEZGKSB8IE1TQgogICAgbnVtIC89IDEyOAogIH0KICB3aGlsZShudW0gJiBNU0JBTEwpIHsKICAgIG91dFtvZmZzZXQrK10gPSAobnVtICYgMHhGRikgfCBNU0IKICAgIG51bSA+Pj49IDcKICB9CiAgb3V0W29mZnNldF0gPSBudW0gfCAwCiAgCiAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0ICsgMQogIAogIHJldHVybiBvdXQKfQptb2R1bGUuZXhwb3J0cyA9IHsKICAgIGVuY29kZTogcmVxdWlyZSgnLi9lbmNvZGUuanMnKQogICwgZGVjb2RlOiByZXF1aXJlKCcuL2RlY29kZS5qcycpCiAgLCBlbmNvZGluZ0xlbmd0aDogcmVxdWlyZSgnLi9sZW5ndGguanMnKQp9Cgp2YXIgTjEgPSBNYXRoLnBvdygyLCAgNykKdmFyIE4yID0gTWF0aC5wb3coMiwgMTQpCnZhciBOMyA9IE1hdGgucG93KDIsIDIxKQp2YXIgTjQgPSBNYXRoLnBvdygyLCAyOCkKdmFyIE41ID0gTWF0aC5wb3coMiwgMzUpCnZhciBONiA9IE1hdGgucG93KDIsIDQyKQp2YXIgTjcgPSBNYXRoLnBvdygyLCA0OSkKdmFyIE44ID0gTWF0aC5wb3coMiwgNTYpCnZhciBOOSA9IE1hdGgucG93KDIsIDYzKQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4gKAogICAgdmFsdWUgPCBOMSA/IDEKICA6IHZhbHVlIDwgTjIgPyAyCiAgOiB2YWx1ZSA8IE4zID8gMwogIDogdmFsdWUgPCBONCA/IDQKICA6IHZhbHVlIDwgTjUgPyA1CiAgOiB2YWx1ZSA8IE42ID8gNgogIDogdmFsdWUgPCBONyA/IDcKICA6IHZhbHVlIDwgTjggPyA4CiAgOiB2YWx1ZSA8IE45ID8gOQogIDogICAgICAgICAgICAgIDEwCiAgKQp9CnsKICAibmFtZSI6ICJ2YXJpbnQiLAogICJ2ZXJzaW9uIjogIjUuMC4wIiwKICAiZGVzY3JpcHRpb24iOiAicHJvdG9idWYtc3R5bGUgdmFyaW50IGJ5dGVzIC0gdXNlIG1zYiB0byBjcmVhdGUgaW50ZWdlciB2YWx1ZXMgb2YgdmFyeWluZyBzaXplcyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAibm9kZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQ6Ly9naXRodWIuY29tL2NocmlzZGlja2luc29uL3ZhcmludC5naXQiCiAgfSwKICAia2V5d29yZHMiOiBbCiAgICAidmFyaW50IiwKICAgICJwcm90b2J1ZiIsCiAgICAiZW5jb2RlIiwKICAgICJkZWNvZGUiCiAgXSwKICAiYXV0aG9yIjogIkNocmlzIERpY2tpbnNvbiA8Y2hyaXNAbmV2ZXJzYXcudXM+IiwKICAibGljZW5zZSI6ICJNSVQiLAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAidGFwZSI6ICJ+Mi4xMi4zIgogIH0KfQpjb25zdCB7IHJ1bnRpbWUsIHBsYXRmb3JtLCBhcmNoIH0gPSB0eXBlb2YgQmFyZSAhPT0gJ3VuZGVmaW5lZCcKICA/IHsgcnVudGltZTogJ2JhcmUnLCBwbGF0Zm9ybTogZ2xvYmFsLkJhcmUucGxhdGZvcm0sIGFyY2g6IGdsb2JhbC5CYXJlLmFyY2ggfQogIDogdHlwZW9mIHByb2Nlc3MgIT09ICd1bmRlZmluZWQnCiAgICA/IHsgcnVudGltZTogJ25vZGUnLCBwbGF0Zm9ybTogZ2xvYmFsLnByb2Nlc3MucGxhdGZvcm0sIGFyY2g6IGdsb2JhbC5wcm9jZXNzLmFyY2ggfQogICAgOiB0eXBlb2YgV2luZG93ICE9PSAndW5kZWZpbmVkJwogICAgICA/IHsgcnVudGltZTogJ2Jyb3dzZXInLCBwbGF0Zm9ybTogJ3Vua25vd24nLCBhcmNoOiAndW5rbm93bicgfQogICAgICA6IHsgcnVudGltZTogJ3Vua25vd24nLCBwbGF0Zm9ybTogJ3Vua25vd24nLCBhcmNoOiAndW5rbm93bicgfQoKZXhwb3J0cy5ydW50aW1lID0gcnVudGltZQpleHBvcnRzLnBsYXRmb3JtID0gcGxhdGZvcm0KZXhwb3J0cy5hcmNoID0gYXJjaApleHBvcnRzLmlzQmFyZSA9IHJ1bnRpbWUgPT09ICdiYXJlJwpleHBvcnRzLmlzQmFyZUtpdCA9IGV4cG9ydHMuaXNCYXJlICYmIHR5cGVvZiBCYXJlS2l0ICE9PSAndW5kZWZpbmVkJwpleHBvcnRzLmlzUGVhciA9IHR5cGVvZiBQZWFyICE9PSAndW5kZWZpbmVkJwpleHBvcnRzLmlzTm9kZSA9IHJ1bnRpbWUgPT09ICdub2RlJwpleHBvcnRzLmlzQnJvd3NlciA9IHJ1bnRpbWUgPT09ICdicm93c2VyJwpleHBvcnRzLmlzV2luZG93cyA9IHBsYXRmb3JtID09PSAnd2luMzInCmV4cG9ydHMuaXNMaW51eCA9IHBsYXRmb3JtID09PSAnbGludXgnCmV4cG9ydHMuaXNNYWMgPSBwbGF0Zm9ybSA9PT0gJ2RhcndpbicKZXhwb3J0cy5pc0lPUyA9IHBsYXRmb3JtID09PSAnaW9zJyB8fCBwbGF0Zm9ybSA9PT0gJ2lvcy1zaW11bGF0b3InCmV4cG9ydHMuaXNBbmRyb2lkID0gcGxhdGZvcm0gPT09ICdhbmRyb2lkJwpleHBvcnRzLmlzRWxlY3Ryb24gPSB0eXBlb2YgcHJvY2VzcyAhPT0gJ3VuZGVmaW5lZCcgJiYgISFnbG9iYWwucHJvY2Vzcy52ZXJzaW9ucz8uZWxlY3Ryb24KZXhwb3J0cy5pc0VsZWN0cm9uUmVuZGVyZXIgPSBleHBvcnRzLmlzRWxlY3Ryb24gJiYgZ2xvYmFsLnByb2Nlc3MudHlwZSA9PT0gJ3JlbmRlcmVyJwpleHBvcnRzLmlzRWxlY3Ryb25Xb3JrZXIgPSBleHBvcnRzLmlzRWxlY3Ryb24gJiYgZ2xvYmFsLnByb2Nlc3MudHlwZSA9PT0gJ3dvcmtlcicKewogICJuYW1lIjogIndoaWNoLXJ1bnRpbWUiLAogICJ2ZXJzaW9uIjogIjEuMy4yIiwKICAiZGVzY3JpcHRpb24iOiAiRGV0ZWN0IGlmIHlvdSBhcmUgaW4gQmFyZSBvciBOb2RlIGFuZCB3aGljaCBvcyBldGMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3doaWNoLXJ1bnRpbWUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2ggSW5jLiIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by93aGljaC1ydW50aW1lL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vd2hpY2gtcnVudGltZSIKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIE1heENhY2hlIHsKICBjb25zdHJ1Y3RvciAoeyBtYXhTaXplLCBtYXhBZ2UsIGNyZWF0ZU1hcCwgb25nYyB9KSB7CiAgICB0aGlzLm1heFNpemUgPSBtYXhTaXplCiAgICB0aGlzLm1heEFnZSA9IG1heEFnZQogICAgdGhpcy5vbmdjID0gb25nYyB8fCBudWxsCgogICAgdGhpcy5fY3JlYXRlTWFwID0gY3JlYXRlTWFwIHx8IGRlZmF1bHRDcmVhdGVNYXAKICAgIHRoaXMuX2xhdGVzdCA9IHRoaXMuX2NyZWF0ZU1hcCgpCiAgICB0aGlzLl9vbGRlc3QgPSB0aGlzLl9jcmVhdGVNYXAoKQogICAgdGhpcy5fcmV0YWluZWQgPSB0aGlzLl9jcmVhdGVNYXAoKQogICAgdGhpcy5fZ2NlZCA9IGZhbHNlCiAgICB0aGlzLl9pbnRlcnZhbCA9IG51bGwKCiAgICBpZiAodGhpcy5tYXhBZ2UgPiAwICYmIHRoaXMubWF4QWdlIDwgSW5maW5pdHkpIHsKICAgICAgY29uc3QgdGljayA9IE1hdGguY2VpbCgyIC8gMyAqIHRoaXMubWF4QWdlKQogICAgICB0aGlzLl9pbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuX2djQXV0by5iaW5kKHRoaXMpLCB0aWNrKQogICAgICBpZiAodGhpcy5faW50ZXJ2YWwudW5yZWYpIHRoaXMuX2ludGVydmFsLnVucmVmKCkKICAgIH0KICB9CgogICogW1N5bWJvbC5pdGVyYXRvcl0gKCkgewogICAgZm9yIChjb25zdCBpdCBvZiBbdGhpcy5fbGF0ZXN0LCB0aGlzLl9vbGRlc3QsIHRoaXMuX3JldGFpbmVkXSkgewogICAgICB5aWVsZCAqIGl0CiAgICB9CiAgfQoKICAqIGtleXMgKCkgewogICAgZm9yIChjb25zdCBpdCBvZiBbdGhpcy5fbGF0ZXN0LCB0aGlzLl9vbGRlc3QsIHRoaXMuX3JldGFpbmVkXSkgewogICAgICB5aWVsZCAqIGl0LmtleXMoKQogICAgfQogIH0KCiAgKiB2YWx1ZXMgKCkgewogICAgZm9yIChjb25zdCBpdCBvZiBbdGhpcy5fbGF0ZXN0LCB0aGlzLl9vbGRlc3QsIHRoaXMuX3JldGFpbmVkXSkgewogICAgICB5aWVsZCAqIGl0LnZhbHVlcygpCiAgICB9CiAgfQoKICBkZXN0cm95ICgpIHsKICAgIHRoaXMuY2xlYXIoKQogICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9pbnRlcnZhbCkKICAgIHRoaXMuX2ludGVydmFsID0gbnVsbAogIH0KCiAgY2xlYXIgKCkgewogICAgdGhpcy5fZ2NlZCA9IHRydWUKICAgIHRoaXMuX2xhdGVzdC5jbGVhcigpCiAgICB0aGlzLl9vbGRlc3QuY2xlYXIoKQogICAgdGhpcy5fcmV0YWluZWQuY2xlYXIoKQogIH0KCiAgc2V0IChrLCB2KSB7CiAgICBpZiAodGhpcy5fcmV0YWluZWQuaGFzKGspKSByZXR1cm4gdGhpcwogICAgdGhpcy5fbGF0ZXN0LnNldChrLCB2KQogICAgdGhpcy5fb2xkZXN0LmRlbGV0ZShrKSB8fCB0aGlzLl9yZXRhaW5lZC5kZWxldGUoaykKICAgIGlmICh0aGlzLl9sYXRlc3Quc2l6ZSA+PSB0aGlzLm1heFNpemUpIHRoaXMuX2djKCkKICAgIHJldHVybiB0aGlzCiAgfQoKICByZXRhaW4gKGssIHYpIHsKICAgIHRoaXMuX3JldGFpbmVkLnNldChrLCB2KQogICAgdGhpcy5fbGF0ZXN0LmRlbGV0ZShrKSB8fCB0aGlzLl9vbGRlc3QuZGVsZXRlKGspCiAgICByZXR1cm4gdGhpcwogIH0KCiAgZGVsZXRlIChrKSB7CiAgICByZXR1cm4gdGhpcy5fbGF0ZXN0LmRlbGV0ZShrKSB8fCB0aGlzLl9vbGRlc3QuZGVsZXRlKGspIHx8IHRoaXMuX3JldGFpbmVkLmRlbGV0ZShrKQogIH0KCiAgaGFzIChrKSB7CiAgICByZXR1cm4gdGhpcy5fbGF0ZXN0LmhhcyhrKSB8fCB0aGlzLl9vbGRlc3QuaGFzKGspIHx8IHRoaXMuX3JldGFpbmVkLmhhcyhrKQogIH0KCiAgZ2V0IChrKSB7CiAgICBpZiAodGhpcy5fbGF0ZXN0LmhhcyhrKSkgewogICAgICByZXR1cm4gdGhpcy5fbGF0ZXN0LmdldChrKQogICAgfQoKICAgIGlmICh0aGlzLl9vbGRlc3QuaGFzKGspKSB7CiAgICAgIGNvbnN0IHYgPSB0aGlzLl9vbGRlc3QuZ2V0KGspCiAgICAgIHRoaXMuX2xhdGVzdC5zZXQoaywgdikKICAgICAgdGhpcy5fb2xkZXN0LmRlbGV0ZShrKQogICAgICByZXR1cm4gdgogICAgfQoKICAgIGlmICh0aGlzLl9yZXRhaW5lZC5oYXMoaykpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JldGFpbmVkLmdldChrKQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBfZ2NBdXRvICgpIHsKICAgIGlmICghdGhpcy5fZ2NlZCkgdGhpcy5fZ2MoKQogICAgdGhpcy5fZ2NlZCA9IGZhbHNlCiAgfQoKICBfZ2MgKCkgewogICAgdGhpcy5fZ2NlZCA9IHRydWUKICAgIGlmICh0aGlzLm9uZ2MgIT09IG51bGwgJiYgdGhpcy5fb2xkZXN0LnNpemUgPiAwKSB0aGlzLm9uZ2ModGhpcy5fb2xkZXN0KQogICAgdGhpcy5fb2xkZXN0ID0gdGhpcy5fbGF0ZXN0CiAgICB0aGlzLl9sYXRlc3QgPSB0aGlzLl9jcmVhdGVNYXAoKQogIH0KfQoKZnVuY3Rpb24gZGVmYXVsdENyZWF0ZU1hcCAoKSB7CiAgcmV0dXJuIG5ldyBNYXAoKQp9CnsKICAibmFtZSI6ICJ4YWNoZSIsCiAgInZlcnNpb24iOiAiMS4yLjEiLAogICJkZXNjcmlwdGlvbiI6ICJZZXQgYW5vdGhlciBhdXRvIGV4cGlyaW5nLCBtYXggc2l6YWJsZSBjYWNoZSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4zLjIiLAogICAgInN0YW5kYXJkIjogIl4xNy4xLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC94YWNoZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gveGFjaGUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gveGFjaGUiCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IEFMUEhBQkVUID0gJ3libmRyZmc4ZWprbWNwcXhvdDF1d2lzemEzNDVoNzY5Jwpjb25zdCBNSU4gPSAweDMxIC8vIDEKY29uc3QgTUFYID0gMHg3YSAvLyB6CmNvbnN0IFJFVkVSU0UgPSBuZXcgSW50OEFycmF5KDEgKyBNQVggLSBNSU4pCgpSRVZFUlNFLmZpbGwoLTEpCgpmb3IgKGxldCBpID0gMDsgaSA8IEFMUEhBQkVULmxlbmd0aDsgaSsrKSB7CiAgY29uc3QgdiA9IEFMUEhBQkVULmNoYXJDb2RlQXQoaSkgLSBNSU4KICBSRVZFUlNFW3ZdID0gaQp9CgpleHBvcnRzLmVuY29kZSA9IGVuY29kZQpleHBvcnRzLmRlY29kZSA9IGRlY29kZQpleHBvcnRzLkFMUEhBQkVUID0gQUxQSEFCRVQKCmZ1bmN0aW9uIGRlY29kZSAocywgb3V0KSB7CiAgbGV0IHBiID0gMAogIGxldCBwcyA9IDAKCiAgY29uc3QgciA9IHMubGVuZ3RoICYgNwogIGNvbnN0IHEgPSAocy5sZW5ndGggLSByKSAvIDgKCiAgaWYgKCFvdXQpIG91dCA9IGI0YS5hbGxvY1Vuc2FmZShNYXRoLmNlaWwocy5sZW5ndGggKiA1IC8gOCkpCgogIC8vIDAgNSAyIDcgNCAxIDYgMyAoKzUgbW9kIDgpCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBxOyBpKyspIHsKICAgIGNvbnN0IGEgPSBxdWludGV0KHMsIHBzKyspCiAgICBjb25zdCBiID0gcXVpbnRldChzLCBwcysrKQogICAgY29uc3QgYyA9IHF1aW50ZXQocywgcHMrKykKICAgIGNvbnN0IGQgPSBxdWludGV0KHMsIHBzKyspCiAgICBjb25zdCBlID0gcXVpbnRldChzLCBwcysrKQogICAgY29uc3QgZiA9IHF1aW50ZXQocywgcHMrKykKICAgIGNvbnN0IGcgPSBxdWludGV0KHMsIHBzKyspCiAgICBjb25zdCBoID0gcXVpbnRldChzLCBwcysrKQoKICAgIG91dFtwYisrXSA9IChhIDw8IDMpIHwgKGIgPj4+IDIpCiAgICBvdXRbcGIrK10gPSAoKGIgJiAwYjExKSA8PCA2KSB8IChjIDw8IDEpIHwgKGQgPj4+IDQpCiAgICBvdXRbcGIrK10gPSAoKGQgJiAwYjExMTEpIDw8IDQpIHwgKGUgPj4+IDEpCiAgICBvdXRbcGIrK10gPSAoKGUgJiAwYjEpIDw8IDcpIHwgKGYgPDwgMikgfCAoZyA+Pj4gMykKICAgIG91dFtwYisrXSA9ICgoZyAmIDBiMTExKSA8PCA1KSB8IGgKICB9CgogIGlmIChyID09PSAwKSByZXR1cm4gb3V0LnN1YmFycmF5KDAsIHBiKQoKICBjb25zdCBhID0gcXVpbnRldChzLCBwcysrKQogIGNvbnN0IGIgPSBxdWludGV0KHMsIHBzKyspCgogIG91dFtwYisrXSA9IChhIDw8IDMpIHwgKGIgPj4+IDIpCgogIGlmIChyIDw9IDIpIHJldHVybiBvdXQuc3ViYXJyYXkoMCwgcGIpCgogIGNvbnN0IGMgPSBxdWludGV0KHMsIHBzKyspCiAgY29uc3QgZCA9IHF1aW50ZXQocywgcHMrKykKCiAgb3V0W3BiKytdID0gKChiICYgMGIxMSkgPDwgNikgfCAoYyA8PCAxKSB8IChkID4+PiA0KQoKICBpZiAociA8PSA0KSByZXR1cm4gb3V0LnN1YmFycmF5KDAsIHBiKQoKICBjb25zdCBlID0gcXVpbnRldChzLCBwcysrKQoKICBvdXRbcGIrK10gPSAoKGQgJiAwYjExMTEpIDw8IDQpIHwgKGUgPj4+IDEpCgogIGlmIChyIDw9IDUpIHJldHVybiBvdXQuc3ViYXJyYXkoMCwgcGIpCgogIGNvbnN0IGYgPSBxdWludGV0KHMsIHBzKyspCiAgY29uc3QgZyA9IHF1aW50ZXQocywgcHMrKykKCiAgb3V0W3BiKytdID0gKChlICYgMGIxKSA8PCA3KSB8IChmIDw8IDIpIHwgKGcgPj4+IDMpCgogIGlmIChyIDw9IDcpIHJldHVybiBvdXQuc3ViYXJyYXkoMCwgcGIpCgogIGNvbnN0IGggPSBxdWludGV0KHMsIHBzKyspCgogIG91dFtwYisrXSA9ICgoZyAmIDBiMTExKSA8PCA1KSB8IGgKCiAgcmV0dXJuIG91dC5zdWJhcnJheSgwLCBwYikKfQoKZnVuY3Rpb24gZW5jb2RlIChidWYpIHsKICBpZiAodHlwZW9mIGJ1ZiA9PT0gJ3N0cmluZycpIGJ1ZiA9IGI0YS5mcm9tKGJ1ZikKCiAgY29uc3QgbWF4ID0gYnVmLmJ5dGVMZW5ndGggKiA4CgogIGxldCBzID0gJycKCiAgZm9yIChsZXQgcCA9IDA7IHAgPCBtYXg7IHAgKz0gNSkgewogICAgY29uc3QgaSA9IHAgPj4+IDMKICAgIGNvbnN0IGogPSBwICYgNwoKICAgIGlmIChqIDw9IDMpIHsKICAgICAgcyArPSBBTFBIQUJFVFsoYnVmW2ldID4+PiAoMyAtIGopKSAmIDBiMTExMTFdCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgY29uc3Qgb2YgPSBqIC0gMwogICAgY29uc3QgaCA9IChidWZbaV0gPDwgb2YpICYgMGIxMTExMQogICAgY29uc3QgbCA9IChpID49IGJ1Zi5ieXRlTGVuZ3RoID8gMCA6IGJ1ZltpICsgMV0pID4+PiAoOCAtIG9mKQoKICAgIHMgKz0gQUxQSEFCRVRbaCB8IGxdCiAgfQoKICByZXR1cm4gcwp9CgpmdW5jdGlvbiBxdWludGV0IChzLCBpKSB7CiAgaWYgKGkgPiBzLmxlbmd0aCkgewogICAgcmV0dXJuIDAKICB9CgogIGNvbnN0IHYgPSBzLmNoYXJDb2RlQXQoaSkKCiAgaWYgKHYgPCBNSU4gfHwgdiA+IE1BWCkgewogICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgY2hhcmFjdGVyIGluIGJhc2UzMiBpbnB1dDogIicgKyBzW2ldICsgJyIgYXQgcG9zaXRpb24gJyArIGkpCiAgfQoKICBjb25zdCBiaXRzID0gUkVWRVJTRVt2IC0gTUlOXQoKICBpZiAoYml0cyA9PT0gLTEpIHsKICAgIHRocm93IEVycm9yKCdJbnZhbGlkIGNoYXJhY3RlciBpbiBiYXNlMzIgaW5wdXQ6ICInICsgc1tpXSArICciIGF0IHBvc2l0aW9uICcgKyBpKQogIH0KCiAgcmV0dXJuIGJpdHMKfQp7CiAgIm5hbWUiOiAiejMyIiwKICAidmVyc2lvbiI6ICIxLjEuMCIsCiAgImRlc2NyaXB0aW9uIjogIkVuY29kZSAmIGRlY29kZSB6LWJhc2UzMiIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjUuMyIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFzZS14IjogIl40LjAuMCIsCiAgICAiYmFzZTMyIjogIjAuMC43IiwKICAgICJicml0dGxlIjogIl4zLjEuMyIsCiAgICAibmFub2JlbmNoIjogIl4zLjAuMCIsCiAgICAicmZjNDY0OCI6ICJeMS41LjIiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvejMyLmdpdCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIiwKICAgICJiZW5jaCI6ICJub2RlIGJlbmNobWFyay5qcyIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC96MzIvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvejMyIgp9CnsKICAicHJpdmF0ZSI6IHRydWUsCiAgIm5hbWUiOiAibGlzdGFtIiwKICAiZGVzY3JpcHRpb24iOiAiQSBtaW5pbWFsaXN0aWMgcDJwIGxpc3QgYXBwIiwKICAibWFpbiI6ICJleHBvLXJvdXRlci9lbnRyeSIsCiAgInNjcmlwdHMiOiB7CiAgICAic3RhcnQiOiAiZXhwbyBzdGFydCIsCiAgICAiYW5kcm9pZCI6ICJucG0gcnVuIGJ1bmRsZTpiYWNrZW5kOmFuZHJvaWQgJiYgZXhwbyBydW46YW5kcm9pZCIsCiAgICAiYW5kcm9pZDpyZWxlYXNlIjogImNkIGFuZHJvaWQgJiYgLi9ncmFkbGV3IGJ1bmRsZVJlbGVhc2UiLAogICAgImlvcyI6ICJucG0gcnVuIGJ1bmRsZTpiYWNrZW5kOmlvcyAmJiBleHBvIHJ1bjppb3MgLS1kZXZpY2UiLAogICAgImJ1bmRsZTpiYWNrZW5kOmlvcyI6ICJucHggYmFyZS1wYWNrIC0tdGFyZ2V0IGlvcyAtLWxpbmtlZCBiYWNrZW5kL2JhY2tlbmQubWpzIC0tZW5jb2RpbmcgYmFzZTY0IC0tb3V0IGFwcC9hcHAuaW9zLmJ1bmRsZSAmJiBub2RlIHNjcmlwdHMvd3JhcC1iYXJlLWJ1bmRsZS5tanMgYXBwL2FwcC5pb3MuYnVuZGxlIGFwcC9hcHAuaW9zLmJ1bmRsZS5tanMiLAogICAgImJ1bmRsZTpiYWNrZW5kOmFuZHJvaWQiOiAibnB4IGJhcmUtcGFjayAtLXRhcmdldCBhbmRyb2lkIC0tbGlua2VkIGJhY2tlbmQvYmFja2VuZC5tanMgLS1lbmNvZGluZyBiYXNlNjQgLS1vdXQgYXBwL2Fzc2V0cy9iYWNrZW5kLmFuZHJvaWQuYnVuZGxlICYmIG5vZGUgc2NyaXB0cy93cmFwLWJhcmUtYnVuZGxlLm1qcyBhcHAvYXNzZXRzL2JhY2tlbmQuYW5kcm9pZC5idW5kbGUgYXBwL2Fzc2V0cy9iYWNrZW5kLmFuZHJvaWQuYnVuZGxlLm1qcyIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiQGlucXVpcmVyL3Byb21wdHMiOiAiXjcuOC4xIiwKICAgICJAcmVhY3QtbmF0aXZlLWNsaXBib2FyZC9jbGlwYm9hcmQiOiAiMS4xNi4zIiwKICAgICJhdXRvYmFzZSI6ICJeNy4yMC4wIiwKICAgICJhdXRvcGFzcyI6ICJeMi4yLjEiLAogICAgImI0YSI6ICJeMS43LjEiLAogICAgImJhcmUtY3J5cHRvIjogIl4xLjEyLjAiLAogICAgImJhcmUtZnMiOiAiXjQuNC40IiwKICAgICJiYXJlLXJwYyI6ICJeMC4yLjEyIiwKICAgICJiYXNlNjQtanMiOiAiXjEuNS4xIiwKICAgICJibGluZC1wZWVyaW5nIjogIl4xLjEzLjAiLAogICAgImNvcmVzdG9yZSI6ICJeNy41LjAiLAogICAgImV4cG8iOiAifjU0LjAuMzEiLAogICAgImV4cG8tYnVpbGQtcHJvcGVydGllcyI6ICIxLjAuMTAiLAogICAgImV4cG8tY29uc3RhbnRzIjogIn4xOC4wLjEzIiwKICAgICJleHBvLWZpbGUtc3lzdGVtIjogIn4xOS4wLjIxIiwKICAgICJleHBvLWxpbmtpbmciOiAiOC4wLjExIiwKICAgICJleHBvLXJvdXRlciI6ICI2LjAuMjEiLAogICAgImV4cG8tc3lzdGVtLXVpIjogIjYuMC45IiwKICAgICJoeXBlcmNvcmUtY3J5cHRvIjogIl4zLjYuMSIsCiAgICAiaHlwZXJkYiI6ICJeNC4xOS4wIiwKICAgICJoeXBlcmRpc3BhdGNoIjogIl4xLjQuNCIsCiAgICAiaHlwZXJzY2hlbWEiOiAiXjEuMTcuMCIsCiAgICAiaHlwZXJzd2FybSI6ICJeNC4xMi4xIiwKICAgICJsdWNpZGUtcmVhY3QtbmF0aXZlIjogIl4wLjU1My4wIiwKICAgICJtYWtlLWRpciI6ICJeNS4xLjAiLAogICAgInByb3RvbXV4LXdha2V1cCI6ICJeMi42LjEiLAogICAgInJlYWN0IjogIjE5LjEuMCIsCiAgICAicmVhY3QtZG9tIjogIjE5LjEuMCIsCiAgICAicmVhY3QtbmF0aXZlIjogIjAuODEuNSIsCiAgICAicmVhY3QtbmF0aXZlLWI0YSI6ICIwLjAuNCIsCiAgICAicmVhY3QtbmF0aXZlLWJhcmUta2l0IjogIjAuMTEuNSIsCiAgICAicmVhY3QtbmF0aXZlLXJlYW5pbWF0ZWQiOiAifjQuMS4xIiwKICAgICJyZWFjdC1uYXRpdmUtc2FmZS1hcmVhLWNvbnRleHQiOiAiNS42LjIiLAogICAgInJlYWN0LW5hdGl2ZS13b3JrbGV0cyI6ICIwLjUuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiQHJlYWN0LW5hdGl2ZS1jb21tdW5pdHkvY2xpIjogImxhdGVzdCIsCiAgICAiQHR5cGVzL2I0YSI6ICIxLjYuNSIsCiAgICAiQHR5cGVzL3JlYWN0IjogIjE5LjIuNyIsCiAgICAiYmFiZWwtcGx1Z2luLW1vZHVsZS1yZXNvbHZlciI6ICJeNS4wLjIiLAogICAgImJhcmUtcGFjayI6ICIxLjUuMSIsCiAgICAicHJldHRpZXIiOiAiMy43LjQiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiMi4wLjAiLAogICAgInR5cGVzY3JpcHQiOiAiNS45LjMiCiAgfQp9CmV4cG9ydCBjb25zdCBSUENfUkVTRVQgPSAwCmV4cG9ydCBjb25zdCBSUENfTUVTU0FHRSA9IDEKZXhwb3J0IGNvbnN0IFJQQ19BREQgPSAyCmV4cG9ydCBjb25zdCBSUENfVVBEQVRFID0gMwpleHBvcnQgY29uc3QgUlBDX0RFTEVURSA9IDQKZXhwb3J0IGNvbnN0IFJQQ19HRVRfS0VZID0gNQpleHBvcnQgY29uc3QgU1lOQ19MSVNUID0gNgpleHBvcnQgY29uc3QgUlBDX0pPSU5fS0VZID0gNwpleHBvcnQgY29uc3QgUlBDX0FERF9GUk9NX0JBQ0tFTkQgPSA4CmV4cG9ydCBjb25zdCBSUENfVVBEQVRFX0ZST01fQkFDS0VORCA9IDkKZXhwb3J0IGNvbnN0IFJQQ19ERUxFVEVfRlJPTV9CQUNLRU5EID0gMTAKZXhwb3J0IGNvbnN0IFJQQ19SRVFVRVNUX1NZTkMgPSAxMQo="];
export default chunks.join('');
