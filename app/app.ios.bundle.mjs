// Auto-generated. Do not edit.
const chunks = ["MTAwMTM0CnsidmVyc2lvbiI6MCwiaWQiOiIxYzYzMzRjNjdkOTE5ZTRmYzU0MDgwZWM3N2RmODFhN2NkZGZiZDllMmQwOGM2NWMzY2JlOWI4ODQzNGJjZmMyIiwibWFpbiI6Ii9iYWNrZW5kL2JhY2tlbmQubWpzIiwiaW1wb3J0cyI6e30sInJlc29sdXRpb25zIjp7Ii9iYWNrZW5kL2JhY2tlbmQubWpzIjp7IiNwYWNrYWdlIjoiL3BhY2thZ2UuanNvbiIsIi4uL3JwYy1jb21tYW5kcy5tanMiOiIvcnBjLWNvbW1hbmRzLm1qcyIsIi4vbGliL2l0ZW0ubWpzIjoiL2JhY2tlbmQvbGliL2l0ZW0ubWpzIiwiLi9saWIva2V5Lm1qcyI6Ii9iYWNrZW5kL2xpYi9rZXkubWpzIiwiLi9saWIvbmV0d29yay5tanMiOiIvYmFja2VuZC9saWIvbmV0d29yay5tanMiLCIuL2xpYi9zdGF0ZS5tanMiOiIvYmFja2VuZC9saWIvc3RhdGUubWpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJiYXJlLXBhdGgiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9pbmRleC5qcyIsImJhcmUtcnBjIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9pbmRleC5qcyIsImJhcmUtdXJsIjoiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9pbmRleC5qcyJ9LCIvYmFja2VuZC9saWIvaXRlbS5tanMiOnsiI3BhY2thZ2UiOiIvcGFja2FnZS5qc29uIiwiLi4vLi4vcnBjLWNvbW1hbmRzLm1qcyI6Ii9ycGMtY29tbWFuZHMubWpzIiwiLi9zdGF0ZS5tanMiOiIvYmFja2VuZC9saWIvc3RhdGUubWpzIiwiLi91dGlsLm1qcyI6Ii9iYWNrZW5kL2xpYi91dGlsLm1qcyJ9LCIvYmFja2VuZC9saWIva2V5Lm1qcyI6eyIjcGFja2FnZSI6Ii9wYWNrYWdlLmpzb24iLCJiYXJlLWZzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2luZGV4LmpzIn0sIi9iYWNrZW5kL2xpYi9uZXR3b3JrLm1qcyI6eyIjcGFja2FnZSI6Ii9wYWNrYWdlLmpzb24iLCIuLi8uLi9ycGMtY29tbWFuZHMubWpzIjoiL3JwYy1jb21tYW5kcy5tanMiLCIuLi9iYWNrZW5kLm1qcyI6Ii9iYWNrZW5kL2JhY2tlbmQubWpzIiwiLi9zdGF0ZS5tanMiOiIvYmFja2VuZC9saWIvc3RhdGUubWpzIiwiLi91dGlsLm1qcyI6Ii9iYWNrZW5kL2xpYi91dGlsLm1qcyIsImF1dG9iYXNlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9pbmRleC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29yZXN0b3JlIjoiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwiaHlwZXJzd2FybSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9pbmRleC5qcyJ9LCIvYmFja2VuZC9saWIvc3RhdGUubWpzIjp7IiNwYWNrYWdlIjoiL3BhY2thZ2UuanNvbiJ9LCIvYmFja2VuZC9saWIvdXRpbC5tanMiOnsiI3BhY2thZ2UiOiIvcGFja2FnZS5qc29uIiwiYmFyZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9wYWNrYWdlLmpzb24iLCIuL2xpYi9icmlkZ2UiOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vbGliL2JyaWRnZS5qcyIsIi4vbGliL2hhbmRzaGFrZSI6Ii9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9saWIvaGFuZHNoYWtlLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwic29kaXVtLXNlY3JldHN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXNlY3JldHN0cmVhbS9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIiwidGltZW91dC1yZWZyZXNoIjoiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vbGliL2JyaWRnZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9wYWNrYWdlLmpzb24iLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9saWIvaGFuZHNoYWtlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwibm9pc2UtY3VydmUtZWQiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWN1cnZlLWVkL2luZGV4LmpzIiwibm9pc2UtaGFuZHNoYWtlIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2Uvbm9pc2UuanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2VuY29kaW5nL2xlZ2FjeS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImluZGV4LWVuY29kZXIiOiIvbm9kZV9tb2R1bGVzL2luZGV4LWVuY29kZXIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9lbmNvZGluZy9zcGVjL2F1dG9iYXNlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuLi8uLi9sZWdhY3kuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2VuY29kaW5nL2xlZ2FjeS5qcyIsImh5cGVyc2NoZW1hL3J1bnRpbWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc2NoZW1hL3J1bnRpbWUuY2pzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vbGliL2FjdGl2ZS13cml0ZXJzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYWN0aXZlLXdyaXRlcnMuanMiLCIuL2xpYi9hcHBlbmQtYmF0Y2guanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9hcHBlbmQtYmF0Y2guanMiLCIuL2xpYi9hcHBseS1jYWxscy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FwcGx5LWNhbGxzLmpzIiwiLi9saWIvYXBwbHktc3RhdGUuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9hcHBseS1zdGF0ZS5qcyIsIi4vbGliL2Jvb3QuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9ib290LmpzIiwiLi9saWIvY2Fwcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2NhcHMuanMiLCIuL2xpYi9lbmNyeXB0aW9uLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvZW5jcnlwdGlvbi5qcyIsIi4vbGliL2Zhc3QtZm9yd2FyZC5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Zhc3QtZm9yd2FyZC5qcyIsIi4vbGliL2xpbmVhcml6ZXIuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9saW5lYXJpemVyLmpzIiwiLi9saWIvbG9jYWwtc3RhdGUuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9sb2NhbC1zdGF0ZS5qcyIsIi4vbGliL21lc3NhZ2VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiLCIuL2xpYi9zdG9yZS5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N0b3JlLmpzIiwiLi9saWIvc3lzdGVtLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvc3lzdGVtLmpzIiwiLi9saWIvdGltZXIuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi90aW1lci5qcyIsIi4vbGliL3VwZGF0ZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi91cGRhdGVzLmpzIiwiLi9saWIvdmFsdWVzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdmFsdWVzLmpzIiwiLi9saWIvd2FrZXVwLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvd2FrZXVwLmpzIiwiLi9saWIvd3JpdGVyLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvd3JpdGVyLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiY29yZS1jb3VwbGVyIjoiL25vZGVfbW9kdWxlcy9jb3JlLWNvdXBsZXIvaW5kZXguanMiLCJkZWJvdW5jZWlmeSI6Ii9ub2RlX21vZHVsZXMvZGVib3VuY2VpZnkvaW5kZXguanMiLCJoeXBlcmNvcmUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9pbmRleC5qcyIsImh5cGVyY29yZS1pZC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWlkLWVuY29kaW5nL2luZGV4LmpzIiwibmFub2Fzc2VydCI6Ii9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyIsInByb3RvbXV4LXdha2V1cCI6Ii9ub2RlX21vZHVsZXMvcHJvdG9tdXgtd2FrZXVwL2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIiwic2NvcGUtbG9jayI6Ii9ub2RlX21vZHVsZXMvc2NvcGUtbG9jay9pbmRleC5qcyIsInNpZ25hbC1wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9hY3RpdmUtd3JpdGVycy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwZW5kLWJhdGNoLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCJzaWduYWwtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvc2lnbmFsLXByb21pc2UvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwbHktY2FsbHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9hcHBseS1zdGF0ZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9hcHBseS1jYWxscy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FwcGx5LWNhbGxzLmpzIiwiLi9jYXBzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY2Fwcy5qcyIsIi4vZW5jcnlwdGlvbi5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2VuY3J5cHRpb24uanMiLCIuL2ZvcmsuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9mb3JrLmpzIiwiLi9sb2NhbC1zdGF0ZS5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2xvY2FsLXN0YXRlLmpzIiwiLi9tZXNzYWdlcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL21lc3NhZ2VzLmpzIiwiLi9zeXN0ZW0uanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9zeXN0ZW0uanMiLCIuL3VwZGF0ZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi91cGRhdGVzLmpzIiwiLi92YWx1ZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi92YWx1ZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwiaHlwZXJjb3JlL2xpYi9tdWx0aXNpZy5qcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tdWx0aXNpZy5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9ib290LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL21lc3NhZ2VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2NhcHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY2xvY2suanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsInRpbnktYnVmZmVyLW1hcCI6Ii9ub2RlX21vZHVsZXMvdGlueS1idWZmZXItbWFwL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2NvbnNlbnN1cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9jbG9jay5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Nsb2NrLmpzIiwidGlueS1idWZmZXItbWFwIjoiL25vZGVfbW9kdWxlcy90aW55LWJ1ZmZlci1tYXAvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvZW5jcnlwdGlvbi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9jYXBzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY2Fwcy5qcyIsIi4vbWVzc2FnZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9tZXNzYWdlcy5qcyIsIi4vc3lzdGVtLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvc3lzdGVtLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsImh5cGVyY29yZS9saWIvZGVmYXVsdC1lbmNyeXB0aW9uLmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2RlZmF1bHQtZW5jcnlwdGlvbi5qcyIsInJlYWR5LXJlc291cmNlIjoiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9pbmRleC5qcyIsInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Zhc3QtZm9yd2FyZC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9lbmNyeXB0aW9uLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvZW5jcnlwdGlvbi5qcyIsIi4vc3lzdGVtLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvc3lzdGVtLmpzIiwicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2ZvcmsuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vZW5jcnlwdGlvbi5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2VuY3J5cHRpb24uanMiLCIuL21lc3NhZ2VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiLCIuL3N5c3RlbS5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N5c3RlbS5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbGluZWFyaXplci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9jbG9jay5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Nsb2NrLmpzIiwiLi9jb25zZW5zdXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jb25zZW5zdXMuanMiLCIuL3RvcG9saXN0LmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdG9wb2xpc3QuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbG9jYWwtc3RhdGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vbWVzc2FnZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9tZXNzYWdlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi4vZW5jb2Rpbmcvc3BlYy9hdXRvYmFzZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvZW5jb2Rpbmcvc3BlYy9hdXRvYmFzZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9ub2RlLWJ1ZmZlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N0b3JlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL21lc3NhZ2VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJoeXBlcmNvcmUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvc3lzdGVtLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL2NhcHMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jYXBzLmpzIiwiLi9tZXNzYWdlcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL21lc3NhZ2VzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiaHlwZXJiZWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsInJlYWR5LXJlc291cmNlIjoiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9pbmRleC5qcyIsInN1Yi1lbmNvZGVyIjoiL25vZGVfbW9kdWxlcy9zdWItZW5jb2Rlci9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi90aW1lci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdG9wb2xpc3QuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwibmFub2Fzc2VydCI6Ii9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi91cGRhdGVzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdmFsdWVzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL2NhcHMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jYXBzLmpzIiwiLi9lbmNyeXB0aW9uLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvZW5jcnlwdGlvbi5qcyIsIi4vbWVzc2FnZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvd2FrZXVwLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi93cml0ZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vbGluZWFyaXplci5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2xpbmVhcml6ZXIuanMiLCIuL25vZGUtYnVmZmVyLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbm9kZS1idWZmZXIuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJuYW5vYXNzZXJ0IjoiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwic2lnbmFsLXByb21pc2UiOiIvbm9kZV9tb2R1bGVzL3NpZ25hbC1wcm9taXNlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2I0YS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9iNGEvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOmJhcmUtY3J5cHRvLjEuMTIuMC5mcmFtZXdvcmsvYmFyZS1jcnlwdG8uMS4xMi4wIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4vbGliL2NpcGhlciI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NpcGhlci5qcyIsIi4vbGliL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NvbnN0YW50cy5qcyIsIi4vbGliL2hhc2giOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9oYXNoLmpzIiwiLi9saWIvaG1hYyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2htYWMuanMiLCIuL2xpYi9rZXkiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9rZXkuanMiLCIuL2xpYi9wYmtkZjIiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9wYmtkZjIuanMiLCIuL2xpYi9yYW5kb20iOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9yYW5kb20uanMiLCIuL2xpYi9zaWduYXR1cmUiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9zaWduYXR1cmUuanMiLCIuL3dlYiI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vd2ViLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NpcGhlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvY29uc3RhbnRzLmpzIiwiYmFyZS1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NvbnN0YW50cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvZXJyb3JzLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2Vycm9ycy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2hhc2guanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2JpbmRpbmcuanMiLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NvbnN0YW50cy5qcyIsImJhcmUtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9obWFjLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jb25zdGFudHMuanMiLCJiYXJlLXN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1zdHJlYW0vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIva2V5LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jb25zdGFudHMuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvcGJrZGYyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jb25zdGFudHMuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvcmFuZG9tLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3NpZ25hdHVyZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvY29uc3RhbnRzLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vZWQyNTUxOS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vLi4vLi4iOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2luZGV4LmpzIiwiLi4vLi4vLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyIsIi4uLy4uL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2Vycm9ycy5qcyIsIi4uLy4uL2tleSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2tleS5qcyIsIi4uL2NyeXB0by1rZXkiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvY3J5cHRvLWtleS5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL2htYWMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4uLy4uLy4uIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9pbmRleC5qcyIsIi4uLy4uL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2Vycm9ycy5qcyIsIi4uL2NyeXB0by1rZXkiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvY3J5cHRvLWtleS5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL3Bia2RmMi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vLi4vLi4iOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2luZGV4LmpzIiwiLi4vLi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvZXJyb3JzLmpzIiwiLi4vY3J5cHRvLWtleSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9jcnlwdG8ta2V5LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vc2hhLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi8uLi8uLiI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2NyeXB0by1rZXkuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vd2ViLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9pbmRleC5qcyIsIi4vbGliL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2Vycm9ycy5qcyIsIi4vbGliL3dlYi9hbGdvcml0aG0vZWQyNTUxOSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vZWQyNTUxOS5qcyIsIi4vbGliL3dlYi9hbGdvcml0aG0vaG1hYyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vaG1hYy5qcyIsIi4vbGliL3dlYi9hbGdvcml0aG0vcGJrZGYyIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2FsZ29yaXRobS9wYmtkZjIuanMiLCIuL2xpYi93ZWIvYWxnb3JpdGhtL3NoYSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vc2hhLmpzIiwiLi9saWIvd2ViL2NyeXB0by1rZXkiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvY3J5cHRvLWtleS5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9wYWNrYWdlLmpzb24iLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2xpYi9lcnJvcnMuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9saWIvZXJyb3JzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvYmluZGluZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOmJhcmUtZnMuNC41LjIuZnJhbWV3b3JrL2JhcmUtZnMuNC41LjIifSwiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL3BhY2thZ2UuanNvbiIsIi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9iaW5kaW5nLmpzIiwiLi9saWIvY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2xpYi9jb25zdGFudHMuanMiLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvbGliL2Vycm9ycy5qcyIsIi4vcHJvbWlzZXMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvcHJvbWlzZXMuanMiLCJiYXJlLWV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMiLCJiYXJlLXBhdGgiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9pbmRleC5qcyIsImJhcmUtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9pbmRleC5qcyIsImJhcmUtdXJsIjoiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9pbmRleC5qcyIsImZhc3QtZmlmbyI6Ii9ub2RlX21vZHVsZXMvZmFzdC1maWZvL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9saWIvY29uc3RhbnRzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvYmluZGluZy5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvbGliL2Vycm9ycy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9wYWNrYWdlLmpzb24iLCJiYXJlLW9zIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvcHJvbWlzZXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvcGFja2FnZS5qc29uIiwiLiI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9pbmRleC5qcyIsImJhcmUtZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvYmluZGluZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOmJhcmUtb3MuMy42LjIuZnJhbWV3b3JrL2JhcmUtb3MuMy42LjIifSwiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL3BhY2thZ2UuanNvbiIsIi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9iaW5kaW5nLmpzIiwiLi9saWIvY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2xpYi9jb25zdGFudHMuanMiLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvbGliL2Vycm9ycy5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvbGliL2NvbnN0YW50cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2JpbmRpbmcuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2xpYi9lcnJvcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1vcy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL3BhY2thZ2UuanNvbiIsIi4vbGliL3Bvc2l4IjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3Bvc2l4LmpzIiwiLi9saWIvd2luMzIiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvd2luMzIuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL2NvbnN0YW50cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvcG9zaXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9jb25zdGFudHMuanMiLCIuL3NoYXJlZCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9zaGFyZWQuanMiLCIuL3dpbjMyIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3dpbjMyLmpzIiwiYmFyZS1vcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvc2hhcmVkLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvY29uc3RhbnRzLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi93aW4zMi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL2NvbnN0YW50cy5qcyIsIi4vcG9zaXgiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvcG9zaXguanMiLCIuL3NoYXJlZCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9zaGFyZWQuanMiLCJiYXJlLW9zIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiIsIi4vbGliL2NvbW1hbmQtcm91dGVyIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvY29tbWFuZC1yb3V0ZXIuanMiLCIuL2xpYi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9jb25zdGFudHMuanMiLCIuL2xpYi9pbmNvbWluZy1yZXF1ZXN0IjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvaW5jb21pbmctcmVxdWVzdC5qcyIsIi4vbGliL2luY29taW5nLXN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2luY29taW5nLXN0cmVhbS5qcyIsIi4vbGliL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvbWVzc2FnZXMuanMiLCIuL2xpYi9vdXRnb2luZy1yZXF1ZXN0IjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvb3V0Z29pbmctcmVxdWVzdC5qcyIsIi4vbGliL291dGdvaW5nLXN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL291dGdvaW5nLXN0cmVhbS5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2NvbW1hbmQtcm91dGVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24iLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2NvbnN0YW50cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2Vycm9ycy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2luY29taW5nLXJlcXVlc3QuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvZXJyb3JzLmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9pbmNvbWluZy1zdHJlYW0uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvY29uc3RhbnRzLmpzIiwiYmFyZS1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL21lc3NhZ2VzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2NvbnN0YW50cy5qcyIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvZXJyb3JzLmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9vdXRnb2luZy1yZXF1ZXN0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24iLCIuL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2Vycm9ycy5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvb3V0Z29pbmctc3RyZWFtLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2NvbnN0YW50cy5qcyIsImJhcmUtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmFyZS1zdHJlYW0vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL3BhY2thZ2UuanNvbiIsInN0cmVhbXgiOiIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2JpbmRpbmcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL3BhY2thZ2UuanNvbiIsIi4iOiJsaW5rZWQ6YmFyZS11cmwuMi4zLjIuZnJhbWV3b3JrL2JhcmUtdXJsLjIuMy4yIn0sIi9ub2RlX21vZHVsZXMvYmFyZS11cmwvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL3BhY2thZ2UuanNvbiIsIi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS11cmwvYmluZGluZy5qcyIsIi4vbGliL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS11cmwvbGliL2Vycm9ycy5qcyIsIi4vbGliL3VybC1zZWFyY2gtcGFyYW1zIjoiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9saWIvdXJsLXNlYXJjaC1wYXJhbXMuanMiLCJiYXJlLXBhdGgiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2xpYi9lcnJvcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2xpYi91cmwtc2VhcmNoLXBhcmFtcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS11cmwvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYmFyZS11cmwvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iaWctc3BhcnNlLWFycmF5L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iaWctc3BhcnNlLWFycmF5L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JpZy1zcGFyc2UtYXJyYXkvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iaXRzLXRvLWJ5dGVzL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iaXRzLXRvLWJ5dGVzL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYml0cy10by1ieXRlcy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ibGluZC1yZWxheS9wYWNrYWdlLmpzb24iLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L2xpYi9lcnJvcnMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImJpdHMtdG8tYnl0ZXMiOiIvbm9kZV9tb2R1bGVzL2JpdHMtdG8tYnl0ZXMvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZCI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZC9pbmRleC5qcyIsImV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMiLCJwcm90b211eCI6Ii9ub2RlX21vZHVsZXMvcHJvdG9tdXgvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L2xpYi9lcnJvcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYm9nb24vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JvZ29uL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmctbmV0IjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLW5ldC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JvZ29uL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvY29kZWNzL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9jb2RlY3MvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9jb2RlY3MvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkL3BhY2thZ2UuanNvbiIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1uZXQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctbmV0L3BhY2thZ2UuanNvbiIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLW5ldC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvZW5kaWFuLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvcGFja2FnZS5qc29uIiwiLi9lbmRpYW4iOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvZW5kaWFuLmpzIiwiLi9sZXhpbnQiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvbGV4aW50LmpzIiwiLi9yYXciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvcmF3LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2xleGludC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9yYXcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvcGFja2FnZS5qc29uIiwiLi9lbmRpYW4iOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvZW5kaWFuLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9jb3JlLWNvdXBsZXIvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvcmUtY291cGxlci9wYWNrYWdlLmpzb24iLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2NvcmUtY291cGxlci9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvY29yZXN0b3JlL3BhY2thZ2UuanNvbiIsIi4vbGliL2F1ZGl0LmpzIjoiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvbGliL2F1ZGl0LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJoeXBlcmNvcmUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJoeXBlcmNvcmUtZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL2luZGV4LmpzIiwiaHlwZXJjb3JlLWlkLWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIiwid2hpY2gtcnVudGltZSI6Ii9ub2RlX21vZHVsZXMvd2hpY2gtcnVudGltZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9saWIvYXVkaXQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9kZWJvdW5jZWlmeS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZGVib3VuY2VpZnkvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvZGVib3VuY2VpZnkvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9kZXZpY2UtZmlsZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZGV2aWNlLWZpbGUvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJmZC1sb2NrIjoiL25vZGVfbW9kdWxlcy9mZC1sb2NrL2luZGV4LmpzIiwiZnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvaW5kZXguanMiLCJmcy1uYXRpdmUtZXh0ZW5zaW9ucyI6Ii9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvaW5kZXguanMiLCJwYXRoIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9kZXZpY2UtZmlsZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvcGFja2FnZS5qc29uIiwiLi9saWIvY29tbWFuZHMiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2NvbW1hbmRzLmpzIiwiLi9saWIvZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9lcnJvcnMuanMiLCIuL2xpYi9pbyI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvaW8uanMiLCIuL2xpYi9wZWVyIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9wZWVyLmpzIiwiLi9saWIvcXVlcnkiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL3F1ZXJ5LmpzIiwiLi9saWIvc2Vzc2lvbiI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvc2Vzc2lvbi5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMiLCJrYWRlbWxpYS1yb3V0aW5nLXRhYmxlIjoiL25vZGVfbW9kdWxlcy9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlL2luZGV4LmpzIiwibmF0LXNhbXBsZXIiOiIvbm9kZV9tb2R1bGVzL25hdC1zYW1wbGVyL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyIsInRpbWUtb3JkZXJlZC1zZXQiOiIvbm9kZV9tb2R1bGVzL3RpbWUtb3JkZXJlZC1zZXQvaW5kZXguanMiLCJ1ZHgtbmF0aXZlIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi91ZHguanMifSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9jb21tYW5kcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9lcnJvcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvaW8uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvcGFja2FnZS5qc29uIiwiLi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2Vycm9ycy5qcyIsIi4vcGVlciI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvcGVlci5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImZhc3QtZmlmbyI6Ii9ub2RlX21vZHVsZXMvZmFzdC1maWZvL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL3BlZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZy1uZXQiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctbmV0L2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL3F1ZXJ5LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL3BhY2thZ2UuanNvbiIsIi4vY29tbWFuZHMiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2NvbW1hbmRzLmpzIiwiLi9wZWVyIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9wZWVyLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvc2Vzc2lvbi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvZXZlbnRzLXVuaXZlcnNhbC9iYXJlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ldmVudHMtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiIsImJhcmUtZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2V2ZW50cy11bml2ZXJzYWwvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vZml4ZWQtc2l6ZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZmFzdC1maWZvL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZmFzdC1maWZvL3BhY2thZ2UuanNvbiIsIi4vZml4ZWQtc2l6ZSI6Ii9ub2RlX21vZHVsZXMvZmFzdC1maWZvL2ZpeGVkLXNpemUuanMifSwiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9mZC1sb2NrL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9mZC1sb2NrL3BhY2thZ2UuanNvbiIsImZzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2luZGV4LmpzIiwiZnMtbmF0aXZlLWV4dGVuc2lvbnMiOiIvbm9kZV9tb2R1bGVzL2ZzLW5hdGl2ZS1leHRlbnNpb25zL2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwicmVzb3VyY2Utb24tZXhpdCI6Ii9ub2RlX21vZHVsZXMvcmVzb3VyY2Utb24tZXhpdC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2ZkLWxvY2svcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOmZzLW5hdGl2ZS1leHRlbnNpb25zLjEuNC41LmZyYW1ld29yay9mcy1uYXRpdmUtZXh0ZW5zaW9ucy4xLjQuNSIsInJlcXVpcmUtYWRkb24iOiIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vbGliL2JhcmUuanMifSwiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvcGFja2FnZS5qc29uIiwiLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9iaW5kaW5nLmpzIiwid2hpY2gtcnVudGltZSI6Ii9ub2RlX21vZHVsZXMvd2hpY2gtcnVudGltZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2ZzLW5hdGl2ZS1leHRlbnNpb25zL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL3BhY2thZ2UuanNvbiIsIi4vaXRlcmF0b3JzL2RpZmYiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9kaWZmLmpzIiwiLi9pdGVyYXRvcnMvaGlzdG9yeSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL2hpc3RvcnkuanMiLCIuL2l0ZXJhdG9ycy9sb2NhbCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL2xvY2FsLmpzIiwiLi9pdGVyYXRvcnMvcmFuZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9yYW5nZS5qcyIsIi4vbGliL2V4dGVuc2lvbiI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvbGliL2V4dGVuc2lvbi5qcyIsIi4vbGliL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9saWIvbWVzc2FnZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvZGVjcyI6Ii9ub2RlX21vZHVsZXMvY29kZWNzL2luZGV4LmpzIiwiZGVib3VuY2VpZnkiOiIvbm9kZV9tb2R1bGVzL2RlYm91bmNlaWZ5L2luZGV4LmpzIiwiaHlwZXJjb3JlLWVycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9pbmRleC5qcyIsIm11dGV4aWZ5L3Byb21pc2UiOiIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L3Byb21pc2UuanMiLCJyYWNoZSI6Ii9ub2RlX21vZHVsZXMvcmFjaGUvaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJyZXNvbHZlLXJlamVjdC1wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9yZXNvbHZlLXJlamVjdC1wcm9taXNlL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIiwidW5zbGFiIjoiL25vZGVfbW9kdWxlcy91bnNsYWIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvZGlmZi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvaGlzdG9yeS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL2xvY2FsLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvcmFuZ2UuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvbGliL2V4dGVuc2lvbi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvcGFja2FnZS5qc29uIiwiLi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvbGliL21lc3NhZ2VzLmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvbGliL21lc3NhZ2VzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInByb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzIjoiL25vZGVfbW9kdWxlcy9wcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvcGFja2FnZS5qc29uIiwiaHlwZXJjb3JlLWlkLWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWlkLWVuY29kaW5nL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJ6MzIiOiIvbm9kZV9tb2R1bGVzL3ozMi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1pZC1lbmNvZGluZy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCIuL2xpYi9rZXlzLmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIva2V5cy5qcyIsIi4vbGliL3N0cmVhbXMuanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9zdHJlYW1zLmpzIiwiLi9saWIvdHguanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi90eC5qcyIsIi4vbGliL3ZpZXcuanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi92aWV3LmpzIiwiLi9taWdyYXRpb25zLzAiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL21pZ3JhdGlvbnMvMC9pbmRleC5qcyIsImRldmljZS1maWxlIjoiL25vZGVfbW9kdWxlcy9kZXZpY2UtZmlsZS9pbmRleC5qcyIsImZzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2luZGV4LmpzIiwicGF0aCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2luZGV4LmpzIiwicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pbmRleC5qcyIsInJvY2tzZGItbmF0aXZlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9pbmRleC5qcyIsInNjb3BlLWxvY2siOiIvbm9kZV9tb2R1bGVzL3Njb3BlLWxvY2svaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvYmxvY2stZGVwZW5kZW5jeS1zdHJlYW0uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiIsIi4va2V5cyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL2tleXMuanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL2Nsb3NlLWVycm9yLXN0cmVhbS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvcGFja2FnZS5qc29uIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9rZXlzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJpbmRleC1lbmNvZGVyIjoiL25vZGVfbW9kdWxlcy9pbmRleC1lbmNvZGVyL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3N0cmVhbXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiIsIi4uL3NwZWMvaHlwZXJzY2hlbWEiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3NwZWMvaHlwZXJzY2hlbWEvaW5kZXguanMiLCIuL2Jsb2NrLWRlcGVuZGVuY3ktc3RyZWFtLmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvYmxvY2stZGVwZW5kZW5jeS1zdHJlYW0uanMiLCIuL2tleXMuanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9rZXlzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvdHguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiIsIi4uL3NwZWMvaHlwZXJzY2hlbWEiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3NwZWMvaHlwZXJzY2hlbWEvaW5kZXguanMiLCIuL2tleXMuanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9rZXlzLmpzIiwiLi92aWV3LmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvdmlldy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZmxhdC10cmVlIjoiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvdmlldy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvcGFja2FnZS5qc29uIiwiLi9jbG9zZS1lcnJvci1zdHJlYW0uanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9jbG9zZS1lcnJvci1zdHJlYW0uanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInN0cmVhbXgiOiIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9taWdyYXRpb25zLzAvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiIsIi4uLy4uL2xpYi90eC5qcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3R4LmpzIiwiLi4vLi4vbGliL3ZpZXcuanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi92aWV3LmpzIiwiLi9tZXNzYWdlcy5qcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbWlncmF0aW9ucy8wL21lc3NhZ2VzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiZmxhdC10cmVlIjoiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMiLCJmcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJwYXRoIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbWlncmF0aW9ucy8wL21lc3NhZ2VzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3NwZWMvaHlwZXJzY2hlbWEvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiIsImh5cGVyc2NoZW1hL3J1bnRpbWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc2NoZW1hL3J1bnRpbWUuY2pzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiLi9saWIvY2FwcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jYXBzLmpzIiwiLi9saWIvY29yZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb3JlLmpzIiwiLi9saWIvZGVmYXVsdC1lbmNyeXB0aW9uIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2RlZmF1bHQtZW5jcnlwdGlvbi5qcyIsIi4vbGliL2Rvd25sb2FkIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2Rvd25sb2FkLmpzIiwiLi9saWIvaW5mbyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9pbmZvLmpzIiwiLi9saWIvaW5zcGVjdCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9pbnNwZWN0LmpzIiwiLi9saWIvbWVya2xlLXRyZWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVya2xlLXRyZWUuanMiLCIuL2xpYi9yZXBsaWNhdG9yIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3JlcGxpY2F0b3IuanMiLCIuL2xpYi9zdHJlYW1zIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3N0cmVhbXMuanMiLCIuL2xpYi92ZXJpZmllciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi92ZXJpZmllci5qcyIsIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vaW5kZXguanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1pZC1lbmNvZGluZy9pbmRleC5qcyIsImh5cGVyY29yZS1zdG9yYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9pbmRleC5qcyIsImlzLW9wdGlvbnMiOiIvbm9kZV9tb2R1bGVzL2lzLW9wdGlvbnMvaW5kZXguanMiLCJwcm90b211eCI6Ii9ub2RlX21vZHVsZXMvcHJvdG9tdXgvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9hdWRpdC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vbWVya2xlLXRyZWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVya2xlLXRyZWUuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvYml0LWludGVybHVkZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vY29tcGF0IjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NvbXBhdC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9iaXRmaWVsZC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vY29tcGF0IjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NvbXBhdC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiYmlnLXNwYXJzZS1hcnJheSI6Ii9ub2RlX21vZHVsZXMvYmlnLXNwYXJzZS1hcnJheS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY2Fwcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb21wYXQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCJxdWlja2JpdC11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9pbmRleC5qcyIsInF1aWNrYml0LXVuaXZlcnNhbC9mYWxsYmFjayI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL2ZhbGxiYWNrLmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb3B5LXByb2xvZ3VlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiLi9iaXRmaWVsZCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9iaXRmaWVsZC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZmxhdC10cmVlIjoiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwicXVpY2tiaXQtdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NvcmUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2F1ZGl0IjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2F1ZGl0LmpzIiwiLi9iaXQtaW50ZXJsdWRlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2JpdC1pbnRlcmx1ZGUuanMiLCIuL2JpdGZpZWxkIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2JpdGZpZWxkLmpzIiwiLi9jb3B5LXByb2xvZ3VlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NvcHktcHJvbG9ndWUuanMiLCIuL21lcmtsZS10cmVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lcmtsZS10cmVlLmpzIiwiLi9tdXRleCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tdXRleC5qcyIsIi4vcmVtb3RlLWJpdGZpZWxkIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3JlbW90ZS1iaXRmaWVsZC5qcyIsIi4vcmVwbGljYXRvciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZXBsaWNhdG9yLmpzIiwiLi9zZXNzaW9uLXN0YXRlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3Nlc3Npb24tc3RhdGUuanMiLCIuL3ZlcmlmaWVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3ZlcmlmaWVyLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwiaHlwZXJjb3JlLWVycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIiwiejMyIjoiL25vZGVfbW9kdWxlcy96MzIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2RlZmF1bHQtZW5jcnlwdGlvbi5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vY2FwcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jYXBzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvZG93bmxvYWQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2hvdHN3YXAtcXVldWUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2luZm8uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2luc3BlY3QuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVya2xlLXRyZWUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2NhcHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY2Fwcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZmxhdC10cmVlIjoiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwiaHlwZXJjb3JlLWVycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXNzYWdlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vY2FwcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jYXBzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiaHlwZXJjb3JlLWVycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tdWx0aXNpZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vbWVya2xlLXRyZWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVya2xlLXRyZWUuanMiLCIuL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lc3NhZ2VzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiZmxhdC10cmVlIjoiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL211dGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZWNlaXZlci1xdWV1ZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsImZhc3QtZmlmbyI6Ii9ub2RlX21vZHVsZXMvZmFzdC1maWZvL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZW1vdGUtYml0ZmllbGQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2NvbXBhdCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb21wYXQuanMiLCJiaWctc3BhcnNlLWFycmF5IjoiL25vZGVfbW9kdWxlcy9iaWctc3BhcnNlLWFycmF5L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZXBsaWNhdG9yLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiLi9jYXBzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NhcHMuanMiLCIuL2hvdHN3YXAtcXVldWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvaG90c3dhcC1xdWV1ZS5qcyIsIi4vbWVya2xlLXRyZWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVya2xlLXRyZWUuanMiLCIuL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lc3NhZ2VzLmpzIiwiLi9tdXRleCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tdXRleC5qcyIsIi4vcmVjZWl2ZXItcXVldWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVjZWl2ZXItcXVldWUuanMiLCIuL3JlbW90ZS1iaXRmaWVsZCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZW1vdGUtYml0ZmllbGQuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIiwiaHlwZXJjb3JlLWVycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9pbmRleC5qcyIsInJhbmRvbS1hcnJheS1pdGVyYXRvciI6Ii9ub2RlX21vZHVsZXMvcmFuZG9tLWFycmF5LWl0ZXJhdG9yL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3Nlc3Npb24tc3RhdGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2JpdGZpZWxkIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2JpdGZpZWxkLmpzIiwiLi9tZXJrbGUtdHJlZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXJrbGUtdHJlZS5qcyIsIi4vbXV0ZXgiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXV0ZXguanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJuYW5vYXNzZXJ0IjoiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L2luZGV4LmpzIiwicXVpY2tiaXQtdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3N0cmVhbXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi92ZXJpZmllci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vY2FwcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jYXBzLmpzIiwiLi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXNzYWdlcy5qcyIsIi4vbXVsdGlzaWciOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXVsdGlzaWcuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJmbGF0LXRyZWUiOiIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJoeXBlcmNvcmUtZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL2luZGV4LmpzIiwidW5zbGFiIjoiL25vZGVfbW9kdWxlcy91bnNsYWIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiLi9saWIvY29ubmVjdCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Nvbm5lY3QuanMiLCIuL2xpYi9jb25uZWN0aW9uLXBvb2wiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25uZWN0aW9uLXBvb2wuanMiLCIuL2xpYi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiLCIuL2xpYi9jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jcnlwdG8uanMiLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lcnJvcnMuanMiLCIuL2xpYi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL21lc3NhZ2VzLmpzIiwiLi9saWIvcGVyc2lzdGVudCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3BlcnNpc3RlbnQuanMiLCIuL2xpYi9yYXctc3RyZWFtLXNldCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3Jhdy1zdHJlYW0tc2V0LmpzIiwiLi9saWIvcm91dGVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvcm91dGVyLmpzIiwiLi9saWIvc2VydmVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VydmVyLmpzIiwiLi9saWIvc29ja2V0LXBvb2wiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zb2NrZXQtcG9vbC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImRodC1ycGMiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvaW5kZXguanMiLCJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1pZC1lbmNvZGluZy9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyIsInhhY2hlIjoiL25vZGVfbW9kdWxlcy94YWNoZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9hbm5vdW5jZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIiwiLi9lbmNvZGUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lbmNvZGUuanMiLCIuL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbWVzc2FnZXMuanMiLCIuL3BlcnNpc3RlbnQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9wZXJzaXN0ZW50LmpzIiwiLi9zbGVlcGVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2xlZXBlci5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyIsInNpZ25hbC1wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25uZWN0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2NvbnN0YW50cy5qcyIsIi4vY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY3J5cHRvLmpzIiwiLi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lcnJvcnMuanMiLCIuL2hvbGVwdW5jaGVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvaG9sZXB1bmNoZXIuanMiLCIuL25vaXNlLXdyYXAiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9ub2lzZS13cmFwLmpzIiwiLi9zZWN1cmUtcGF5bG9hZCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NlY3VyZS1wYXlsb2FkLmpzIiwiLi9zZW1hcGhvcmUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zZW1hcGhvcmUuanMiLCIuL3NsZWVwZXIiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zbGVlcGVyLmpzIiwiQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9pbmRleC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiYmxpbmQtcmVsYXkiOiIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L2luZGV4LmpzIiwiYm9nb24iOiIvbm9kZV9tb2R1bGVzL2JvZ29uL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25uZWN0aW9uLXBvb2wuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZXJyb3JzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2NvbnN0YW50cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jcnlwdG8uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lbmNvZGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lcnJvcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9ob2xlcHVuY2hlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiLCIuL25hdCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL25hdC5qcyIsIi4vc2xlZXBlciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NsZWVwZXIuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9tZXNzYWdlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmctbmV0IjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLW5ldC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9uYXQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4uL2xpYi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbm9pc2Utd3JhcC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiLCIuL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Vycm9ycy5qcyIsIi4vbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9tZXNzYWdlcy5qcyIsIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vaW5kZXguanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJub2lzZS1jdXJ2ZS1lZCI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtY3VydmUtZWQvaW5kZXguanMiLCJub2lzZS1oYW5kc2hha2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9ub2lzZS5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvcGVyc2lzdGVudC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiLCIuL2VuY29kZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2VuY29kZS5qcyIsIi4vbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsInJlY29yZC1jYWNoZSI6Ii9ub2RlX21vZHVsZXMvcmVjb3JkLWNhY2hlL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIiwieGFjaGUiOiIvbm9kZV9tb2R1bGVzL3hhY2hlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3Jhdy1zdHJlYW0tc2V0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvcm91dGVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2NvbnN0YW50cy5qcyIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZXJyb3JzLmpzIiwiLi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL21lc3NhZ2VzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiLCJ4YWNoZSI6Ii9ub2RlX21vZHVsZXMveGFjaGUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VjdXJlLXBheWxvYWQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zZW1hcGhvcmUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zZXJ2ZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vYW5ub3VuY2VyIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvYW5ub3VuY2VyLmpzIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiLCIuL2NyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2NyeXB0by5qcyIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZXJyb3JzLmpzIiwiLi9ob2xlcHVuY2hlciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2hvbGVwdW5jaGVyLmpzIiwiLi9ub2lzZS13cmFwIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbm9pc2Utd3JhcC5qcyIsIi4vc2VjdXJlLXBheWxvYWQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zZWN1cmUtcGF5bG9hZC5qcyIsIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vaW5kZXguanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImJsaW5kLXJlbGF5IjoiL25vZGVfbW9kdWxlcy9ibGluZC1yZWxheS9pbmRleC5qcyIsImJvZ29uIjoiL25vZGVfbW9kdWxlcy9ib2dvbi9pbmRleC5qcyIsImV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zbGVlcGVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc29ja2V0LXBvb2wuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9oeXBlcnNjaGVtYS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc2NoZW1hL3J1bnRpbWUuY2pzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcnNjaGVtYS9wYWNrYWdlLmpzb24iLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9wYWNrYWdlLmpzb24iLCIuL2xpYi9jb25uZWN0aW9uLXNldCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvY29ubmVjdGlvbi1zZXQuanMiLCIuL2xpYi9wZWVyLWRpc2NvdmVyeSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvcGVlci1kaXNjb3ZlcnkuanMiLCIuL2xpYi9wZWVyLWluZm8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL3BlZXItaW5mby5qcyIsIi4vbGliL3JldHJ5LXRpbWVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9yZXRyeS10aW1lci5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyIsImh5cGVyZGh0IjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9pbmRleC5qcyIsInNodWZmbGVkLXByaW9yaXR5LXF1ZXVlIjoiL25vZGVfbW9kdWxlcy9zaHVmZmxlZC1wcmlvcml0eS1xdWV1ZS9pbmRleC5qcyIsInN0cmVhbXgiOiIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL2J1bGstdGltZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvY29ubmVjdGlvbi1zZXQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9wZWVyLWRpc2NvdmVyeS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvcGVlci1pbmZvLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvcmV0cnktdGltZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vcGFja2FnZS5qc29uIiwiLi9idWxrLXRpbWVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9idWxrLXRpbWVyLmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2luZGV4LWVuY29kZXIvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2luZGV4LWVuY29kZXIvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9pbmRleC1lbmNvZGVyL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvaXMtb3B0aW9ucy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaXMtb3B0aW9ucy9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2lzLW9wdGlvbnMvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlL3BhY2thZ2UuanNvbiIsImV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvbXV0ZXhpZnkvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L3BhY2thZ2UuanNvbiIsInF1ZXVlLXRpY2siOiIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcHJvY2Vzcy1uZXh0LXRpY2suanMifSwiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L3Byb21pc2UuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L3BhY2thZ2UuanNvbiIsIi4iOiIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvbmF0LXNhbXBsZXIvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25hdC1zYW1wbGVyL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL25hdC1zYW1wbGVyL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvbm9pc2UtY3VydmUtZWQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWN1cnZlLWVkL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwibmFub2Fzc2VydCI6Ii9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ub2lzZS1jdXJ2ZS1lZC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9jaXBoZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvZGguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2hrZGYuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iLCIuL2htYWMiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9obWFjLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvaG1hYy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9ub2lzZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL3BhY2thZ2UuanNvbiIsIi4vaGtkZiI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2hrZGYuanMiLCIuL3N5bW1ldHJpYy1zdGF0ZSI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL3N5bW1ldHJpYy1zdGF0ZS5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwibmFub2Fzc2VydCI6Ii9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9zeW1tZXRyaWMtc3RhdGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iLCIuL2NpcGhlciI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2NpcGhlci5qcyIsIi4vZGgiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9kaC5qcyIsIi4vaGtkZiI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2hrZGYuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3Byb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwic2lnbmVkLXZhcmludCI6Ii9ub2RlX21vZHVsZXMvc2lnbmVkLXZhcmludC9pbmRleC5qcyIsInZhcmludCI6Ii9ub2RlX21vZHVsZXMvdmFyaW50L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9wcm90b211eC13YWtldXAvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9wYWNrYWdlLmpzb24iLCIuL3NwZWMvaHlwZXJzY2hlbWEiOiIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9zcGVjL2h5cGVyc2NoZW1hL2luZGV4LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwicHJvdG9tdXgiOiIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvcHJvdG9tdXgtd2FrZXVwL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcHJvdG9tdXgtd2FrZXVwL3NwZWMvaHlwZXJzY2hlbWEvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9wYWNrYWdlLmpzb24iLCJoeXBlcnNjaGVtYS9ydW50aW1lIjoiL25vZGVfbW9kdWxlcy9oeXBlcnNjaGVtYS9ydW50aW1lLmNqcyJ9LCIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9wcm90b211eC9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJxdWV1ZS10aWNrIjoiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3Byb2Nlc3MtbmV4dC10aWNrLmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcXVldWUtdGljay9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcHJvY2Vzcy1uZXh0LXRpY2suanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcGFja2FnZS5qc29uIiwiLi9xdWV1ZS1taWNyb3Rhc2siOiIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcXVldWUtbWljcm90YXNrLmpzIn0sIi9ub2RlX21vZHVsZXMvcXVldWUtdGljay9xdWV1ZS1taWNyb3Rhc2suanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtbmF0aXZlL2JpbmRpbmcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOnF1aWNrYml0LW5hdGl2ZS4yLjQuOC5mcmFtZXdvcmsvcXVpY2tiaXQtbmF0aXZlLjIuNC44IiwicmVxdWlyZS1hZGRvbiI6Ii9ub2RlX21vZHVsZXMvcmVxdWlyZS1hZGRvbi9saWIvYmFyZS5qcyJ9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LW5hdGl2ZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtbmF0aXZlL2JpbmRpbmcuanMifSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC1uYXRpdmUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvZmFsbGJhY2suanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iLCJzaW1kbGUtdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zaW1kbGUtdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvcGFja2FnZS5qc29uIiwiLi9mYWxsYmFjayI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL2ZhbGxiYWNrLmpzIiwicXVpY2tiaXQtbmF0aXZlIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC1uYXRpdmUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yYWNoZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcmFjaGUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvcmFjaGUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yYW5kb20tYXJyYXktaXRlcmF0b3IvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3JhbmRvbS1hcnJheS1pdGVyYXRvci9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9yYW5kb20tYXJyYXktaXRlcmF0b3IvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvcGFja2FnZS5qc29uIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcmVjb3JkLWNhY2hlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yZWNvcmQtY2FjaGUvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9yZWNvcmQtY2FjaGUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yZWZjb3VudGVyL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yZWZjb3VudGVyL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3JlZmNvdW50ZXIvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL2xpYi9iYXJlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yZXNvbHZlLXJlamVjdC1wcm9taXNlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yZXNvbHZlLXJlamVjdC1wcm9taXNlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yZXNvdXJjZS1vbi1leGl0L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yZXNvdXJjZS1vbi1leGl0L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3Jlc291cmNlLW9uLWV4aXQvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOnJvY2tzZGItbmF0aXZlLjMuMTEuNC5mcmFtZXdvcmsvcm9ja3NkYi1uYXRpdmUuMy4xMS40IiwicmVxdWlyZS1hZGRvbiI6Ii9ub2RlX21vZHVsZXMvcmVxdWlyZS1hZGRvbi9saWIvYmFyZS5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuL2xpYi9jb2x1bW4tZmFtaWx5IjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvY29sdW1uLWZhbWlseS5qcyIsIi4vbGliL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2NvbnN0YW50cy5qcyIsIi4vbGliL2ZpbHRlci1wb2xpY3kiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9maWx0ZXItcG9saWN5LmpzIiwiLi9saWIvaXRlcmF0b3IiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9pdGVyYXRvci5qcyIsIi4vbGliL3NuYXBzaG90IjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvc25hcHNob3QuanMiLCIuL2xpYi9zdGF0ZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL3N0YXRlLmpzIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2JhdGNoLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9jb2x1bW4tZmFtaWx5LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9jb25zdGFudHMuanMiLCIuL2ZpbHRlci1wb2xpY3kiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9maWx0ZXItcG9saWN5LmpzIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2NvbnN0YW50cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2ZpbHRlci1wb2xpY3kuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9pdGVyYXRvci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvYmluZGluZy5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL3NuYXBzaG90LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL3N0YXRlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIiwiLi9iYXRjaCI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2JhdGNoLmpzIiwiLi9jb2x1bW4tZmFtaWx5IjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvY29sdW1uLWZhbWlseS5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJyZWZjb3VudGVyIjoiL25vZGVfbW9kdWxlcy9yZWZjb3VudGVyL2luZGV4LmpzIiwicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pbmRleC5qcyIsInNpZ25hbC1wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2NvcGUtbG9jay9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc2NvcGUtbG9jay9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9zY29wZS1sb2NrL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2h1ZmZsZWQtcHJpb3JpdHktcXVldWUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NodWZmbGVkLXByaW9yaXR5LXF1ZXVlL3BhY2thZ2UuanNvbiIsInVub3JkZXJlZC1zZXQiOiIvbm9kZV9tb2R1bGVzL3Vub3JkZXJlZC1zZXQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zaHVmZmxlZC1wcmlvcml0eS1xdWV1ZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NpZ25hbC1wcm9taXNlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NpZ25lZC12YXJpbnQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NpZ25lZC12YXJpbnQvcGFja2FnZS5qc29uIiwidmFyaW50IjoiL25vZGVfbW9kdWxlcy92YXJpbnQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zaWduZWQtdmFyaW50L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2ltZGxlLW5hdGl2ZS9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4iOiJsaW5rZWQ6c2ltZGxlLW5hdGl2ZS4xLjMuOS5mcmFtZXdvcmsvc2ltZGxlLW5hdGl2ZS4xLjMuOSIsInJlcXVpcmUtYWRkb24iOiIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vbGliL2JhcmUuanMifSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLW5hdGl2ZS9iaW5kaW5nLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9mYWxsYmFjay5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iLCIuL3NjYWxhciI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9zY2FsYXIuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvcGFja2FnZS5qc29uIiwiLi9mYWxsYmFjayI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9mYWxsYmFjay5qcyIsInNpbWRsZS1uYXRpdmUiOiIvbm9kZV9tb2R1bGVzL3NpbWRsZS1uYXRpdmUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9zY2FsYXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4iOiJsaW5rZWQ6c29kaXVtLW5hdGl2ZS41LjAuMTAuZnJhbWV3b3JrL3NvZGl1bS1uYXRpdmUuNS4wLjEwIiwicmVxdWlyZS1hZGRvbiI6Ii9ub2RlX21vZHVsZXMvcmVxdWlyZS1hZGRvbi9saWIvYmFyZS5qcyJ9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS1uYXRpdmUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS1uYXRpdmUvcGFja2FnZS5qc29uIiwiLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tbmF0aXZlL2JpbmRpbmcuanMiLCJ3aGljaC1ydW50aW1lIjoiL25vZGVfbW9kdWxlcy93aGljaC1ydW50aW1lL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS1zZWNyZXRzdHJlYW0vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS1zZWNyZXRzdHJlYW0vcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvc29kaXVtLXNlY3JldHN0cmVhbS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvcGFja2FnZS5qc29uIiwic29kaXVtLW5hdGl2ZSI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L3BhY2thZ2UuanNvbiIsImV2ZW50cy11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL2V2ZW50cy11bml2ZXJzYWwvYmFyZS5qcyIsImZhc3QtZmlmbyI6Ii9ub2RlX21vZHVsZXMvZmFzdC1maWZvL2luZGV4LmpzIiwidGV4dC1kZWNvZGVyIjoiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zdHJlYW14L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc3ViLWVuY29kZXIvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3N1Yi1lbmNvZGVyL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29kZWNzIjoiL25vZGVfbW9kdWxlcy9jb2RlY3MvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zdWItZW5jb2Rlci9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL3BhY2thZ2UuanNvbiIsIi4vbGliL3Bhc3MtdGhyb3VnaC1kZWNvZGVyIjoiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvbGliL3Bhc3MtdGhyb3VnaC1kZWNvZGVyLmpzIiwiLi9saWIvdXRmOC1kZWNvZGVyIjoiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvbGliL3V0ZjgtZGVjb2Rlci5qcyJ9LCIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9saWIvcGFzcy10aHJvdWdoLWRlY29kZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9saWIvdXRmOC1kZWNvZGVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy90aW1lLW9yZGVyZWQtc2V0L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy90aW1lLW9yZGVyZWQtc2V0L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3RpbWUtb3JkZXJlZC1zZXQvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvYnJvd3Nlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL3BhY2thZ2UuanNvbiIsIi4vYnJvd3NlciI6Ii9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL2Jyb3dzZXIuanMiLCIuL25vZGUiOiIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9ub2RlLmpzIn0sIi9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL25vZGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy90aW55LWJ1ZmZlci1tYXAvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3RpbnktYnVmZmVyLW1hcC9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3RpbnktYnVmZmVyLW1hcC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvYmluZGluZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuIjoibGlua2VkOnVkeC1uYXRpdmUuMS4xOS4yLmZyYW1ld29yay91ZHgtbmF0aXZlLjEuMTkuMiIsInJlcXVpcmUtYWRkb24iOiIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vbGliL2JhcmUuanMifSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9pcC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9uZXR3b3JrLWludGVyZmFjZXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9iaW5kaW5nLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvc29ja2V0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvYmluZGluZy5qcyIsIi4vaXAiOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL2lwLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvc3RyZWFtLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvYmluZGluZy5qcyIsIi4vaXAiOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL2lwLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvdWR4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvYmluZGluZy5qcyIsIi4vaXAiOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL2lwLmpzIiwiLi9uZXR3b3JrLWludGVyZmFjZXMiOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL25ldHdvcmstaW50ZXJmYWNlcy5qcyIsIi4vc29ja2V0IjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9zb2NrZXQuanMiLCIuL3N0cmVhbSI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvc3RyZWFtLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvdW5vcmRlcmVkLXNldC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdW5vcmRlcmVkLXNldC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy91bm9yZGVyZWQtc2V0L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy91bnNsYWIvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy91bnNsYWIvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy92YXJpbnQvZGVjb2RlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy92YXJpbnQvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvdmFyaW50L2VuY29kZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdmFyaW50L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3ZhcmludC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdmFyaW50L3BhY2thZ2UuanNvbiIsIi4vZGVjb2RlLmpzIjoiL25vZGVfbW9kdWxlcy92YXJpbnQvZGVjb2RlLmpzIiwiLi9lbmNvZGUuanMiOiIvbm9kZV9tb2R1bGVzL3ZhcmludC9lbmNvZGUuanMiLCIuL2xlbmd0aC5qcyI6Ii9ub2RlX21vZHVsZXMvdmFyaW50L2xlbmd0aC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3ZhcmludC9sZW5ndGguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3ZhcmludC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy92YXJpbnQvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy93aGljaC1ydW50aW1lL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy93aGljaC1ydW50aW1lL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3doaWNoLXJ1bnRpbWUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy94YWNoZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMveGFjaGUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMveGFjaGUvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy96MzIvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3ozMi9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3ozMi9wYWNrYWdlLmpzb24iOnt9LCIvcGFja2FnZS5qc29uIjp7fSwiL3JwYy1jb21tYW5kcy5tanMiOnsiI3BhY2thZ2UiOiIvcGFja2FnZS5qc29uIn19LCJhZGRvbnMiOlsibGlua2VkOmJhcmUtY3J5cHRvLjEuMTIuMC5mcmFtZXdvcmsvYmFyZS1jcnlwdG8uMS4xMi4wIiwibGlua2VkOmJhcmUtZnMuNC41LjIuZnJhbWV3b3JrL2JhcmUtZnMuNC41LjIiLCJsaW5rZWQ6YmFyZS1vcy4zLjYuMi5mcmFtZXdvcmsvYmFyZS1vcy4zLjYuMiIsImxpbmtlZDpiYXJlLXVybC4yLjMuMi5mcmFtZXdvcmsvYmFyZS11cmwuMi4zLjIiLCJsaW5rZWQ6ZnMtbmF0aXZlLWV4dGVuc2lvbnMuMS40LjUuZnJhbWV3b3JrL2ZzLW5hdGl2ZS1leHRlbnNpb25zLjEuNC41IiwibGlua2VkOnF1aWNrYml0LW5hdGl2ZS4yLjQuOC5mcmFtZXdvcmsvcXVpY2tiaXQtbmF0aXZlLjIuNC44IiwibGlua2VkOnJvY2tzZGItbmF0aXZlLjMuMTEuNC5mcmFtZXdvcmsvcm9ja3NkYi1uYXRpdmUuMy4xMS40IiwibGlua2VkOnNpbWRsZS1uYXRpdmUuMS4zLjkuZnJhbWV3b3JrL3NpbWRsZS1uYXRpdmUuMS4zLjkiLCJsaW5rZWQ6c29kaXVtLW5hdGl2ZS41LjAuMTAuZnJhbWV3b3JrL3NvZGl1bS1uYXRpdmUuNS4wLjEwIiwibGlua2VkOnVkeC1uYXRpdmUuMS4xOS4yLmZyYW1ld29yay91ZHgtbmF0aXZlLjEuMTkuMiJdLCJhc3NldHMiOltdLCJmaWxlcyI6eyIvYmFja2VuZC9iYWNrZW5kLm1qcyI6eyJvZmZzZXQiOjAsImxlbmd0aCI6NzkyMywibW9kZSI6NDIwfSwiL2JhY2tlbmQvbGliL2l0ZW0ubWpzIjp7Im9mZnNldCI6NzkyMywibGVuZ3RoIjo2MjkzLCJtb2RlIjo0MjB9LCIvYmFja2VuZC9saWIva2V5Lm1qcyI6eyJvZmZzZXQiOjE0MjE2LCJsZW5ndGgiOjE3NjcsIm1vZGUiOjQyMH0sIi9iYWNrZW5kL2xpYi9uZXR3b3JrLm1qcyI6eyJvZmZzZXQiOjE1OTgzLCJsZW5ndGgiOjEwNTAzLCJtb2RlIjo0MjB9LCIvYmFja2VuZC9saWIvc3RhdGUubWpzIjp7Im9mZnNldCI6MjY0ODYsImxlbmd0aCI6MjAwMSwibW9kZSI6NDIwfSwiL2JhY2tlbmQvbGliL3V0aWwubWpzIjp7Im9mZnNldCI6Mjg0ODcsImxlbmd0aCI6MTY0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vaW5kZXguanMiOnsib2Zmc2V0IjoyODY1MSwibGVuZ3RoIjoxNjcyMiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL2xpYi9icmlkZ2UuanMiOnsib2Zmc2V0Ijo0NTM3MywibGVuZ3RoIjoxMjczLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vbGliL2hhbmRzaGFrZS5qcyI6eyJvZmZzZXQiOjQ2NjQ2LCJsZW5ndGgiOjE5NTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo0ODU5NiwibGVuZ3RoIjoxMTMyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2VuY29kaW5nL2xlZ2FjeS5qcyI6eyJvZmZzZXQiOjQ5NzI4LCJsZW5ndGgiOjg4NDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvZW5jb2Rpbmcvc3BlYy9hdXRvYmFzZS9pbmRleC5qcyI6eyJvZmZzZXQiOjU4NTc2LCJsZW5ndGgiOjE4OTE4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2luZGV4LmpzIjp7Im9mZnNldCI6Nzc0OTQsImxlbmd0aCI6NTgxNDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FjdGl2ZS13cml0ZXJzLmpzIjp7Im9mZnNldCI6MTM1NjQyLCJsZW5ndGgiOjczNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwZW5kLWJhdGNoLmpzIjp7Im9mZnNldCI6MTM2Mzc4LCJsZW5ndGgiOjE0MjYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FwcGx5LWNhbGxzLmpzIjp7Im9mZnNldCI6MTM3ODA0LCJsZW5ndGgiOjIyNzUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FwcGx5LXN0YXRlLmpzIjp7Im9mZnNldCI6MTQwMDc5LCJsZW5ndGgiOjQ1MjM2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9ib290LmpzIjp7Im9mZnNldCI6MTg1MzE1LCJsZW5ndGgiOjM0NjEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2NhcHMuanMiOnsib2Zmc2V0IjoxODg3NzYsImxlbmd0aCI6NTA1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jbG9jay5qcyI6eyJvZmZzZXQiOjE4OTI4MSwibGVuZ3RoIjo3NDksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2NvbnNlbnN1cy5qcyI6eyJvZmZzZXQiOjE5MDAzMCwibGVuZ3RoIjoxMTc1NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvZW5jcnlwdGlvbi5qcyI6eyJvZmZzZXQiOjIwMTc4NCwibGVuZ3RoIjo5NDQ0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9mYXN0LWZvcndhcmQuanMiOnsib2Zmc2V0IjoyMTEyMjgsImxlbmd0aCI6NTcxNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvZm9yay5qcyI6eyJvZmZzZXQiOjIxNjk0MiwibGVuZ3RoIjo0MjMwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9saW5lYXJpemVyLmpzIjp7Im9mZnNldCI6MjIxMTcyLCJsZW5ndGgiOjk2OTYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2xvY2FsLXN0YXRlLmpzIjp7Im9mZnNldCI6MjMwODY4LCJsZW5ndGgiOjIwMTMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL21lc3NhZ2VzLmpzIjp7Im9mZnNldCI6MjMyODgxLCJsZW5ndGgiOjgyNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbm9kZS1idWZmZXIuanMiOnsib2Zmc2V0IjoyMzM3MDgsImxlbmd0aCI6MTU2MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvc3RvcmUuanMiOnsib2Zmc2V0IjoyMzUyNzEsImxlbmd0aCI6MTQxMDcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N5c3RlbS5qcyI6eyJvZmZzZXQiOjI0OTM3OCwibGVuZ3RoIjoyMDE3NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdGltZXIuanMiOnsib2Zmc2V0IjoyNjk1NTQsImxlbmd0aCI6MjkzNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdG9wb2xpc3QuanMiOnsib2Zmc2V0IjoyNzI0OTEsImxlbmd0aCI6NTEwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdXBkYXRlcy5qcyI6eyJvZmZzZXQiOjI3NzU5OSwibGVuZ3RoIjoxMTQ4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi92YWx1ZXMuanMiOnsib2Zmc2V0IjoyNzg3NDcsImxlbmd0aCI6MTUzOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvd2FrZXVwLmpzIjp7Im9mZnNldCI6MjgwMjg2LCJsZW5ndGgiOjQwMzQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3dyaXRlci5qcyI6eyJvZmZzZXQiOjI4NDMyMCwibGVuZ3RoIjo4OTAxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjI5MzIyMSwibGVuZ3RoIjoyMjQ5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyI6eyJvZmZzZXQiOjI5NTQ3MCwibGVuZ3RoIjo0MDU0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2I0YS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoyOTk1MjQsImxlbmd0aCI6MTE0MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIjp7Im9mZnNldCI6MzAwNjY0LCJsZW5ndGgiOjMzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2luZGV4LmpzIjp7Im9mZnNldCI6MzAwNjk3LCJsZW5ndGgiOjE2MTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NpcGhlci5qcyI6eyJvZmZzZXQiOjMwMjMwOCwibGVuZ3RoIjo3MzY2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jb25zdGFudHMuanMiOnsib2Zmc2V0IjozMDk2NzQsImxlbmd0aCI6MjMxMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvZXJyb3JzLmpzIjp7Im9mZnNldCI6MzExOTg3LCJsZW5ndGgiOjk1NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvaGFzaC5qcyI6eyJvZmZzZXQiOjMxMjk0NCwibGVuZ3RoIjo4MjksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2htYWMuanMiOnsib2Zmc2V0IjozMTM3NzMsImxlbmd0aCI6MTAxNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIva2V5LmpzIjp7Im9mZnNldCI6MzE0Nzg4LCJsZW5ndGgiOjEwNjcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3Bia2RmMi5qcyI6eyJvZmZzZXQiOjMxNTg1NSwibGVuZ3RoIjo3MTMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3JhbmRvbS5qcyI6eyJvZmZzZXQiOjMxNjU2OCwibGVuZ3RoIjoxNzA3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9zaWduYXR1cmUuanMiOnsib2Zmc2V0IjozMTgyNzUsImxlbmd0aCI6MTAxMCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2FsZ29yaXRobS9lZDI1NTE5LmpzIjp7Im9mZnNldCI6MzE5Mjg1LCJsZW5ndGgiOjY5MTgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vaG1hYy5qcyI6eyJvZmZzZXQiOjMyNjIwMywibGVuZ3RoIjo0OTI1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL3Bia2RmMi5qcyI6eyJvZmZzZXQiOjMzMTEyOCwibGVuZ3RoIjoxNDY3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL3NoYS5qcyI6eyJvZmZzZXQiOjMzMjU5NSwibGVuZ3RoIjoyOTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9jcnlwdG8ta2V5LmpzIjp7Im9mZnNldCI6MzMyODk0LCJsZW5ndGgiOjk3MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjozMzM4NjQsImxlbmd0aCI6MTQ3NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by93ZWIuanMiOnsib2Zmc2V0IjozMzUzMzksImxlbmd0aCI6NzM5MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyI6eyJvZmZzZXQiOjM0MjczMiwibGVuZ3RoIjo4MDMzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2xpYi9lcnJvcnMuanMiOnsib2Zmc2V0IjozNTA3NjUsImxlbmd0aCI6NjcxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjM1MTQzNiwibGVuZ3RoIjoxMzk5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvYmluZGluZy5qcyI6eyJvZmZzZXQiOjM1MjgzNSwibGVuZ3RoIjozMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2luZGV4LmpzIjp7Im9mZnNldCI6MzUyODY4LCJsZW5ndGgiOjQ4MjY3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvbGliL2NvbnN0YW50cy5qcyI6eyJvZmZzZXQiOjQwMTEzNSwibGVuZ3RoIjoxNDk0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvbGliL2Vycm9ycy5qcyI6eyJvZmZzZXQiOjQwMjYyOSwibGVuZ3RoIjoxMTYzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NDAzNzkyLCJsZW5ndGgiOjE1NDYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9wcm9taXNlcy5qcyI6eyJvZmZzZXQiOjQwNTMzOCwibGVuZ3RoIjoxODY2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvYmluZGluZy5qcyI6eyJvZmZzZXQiOjQwNzIwNCwibGVuZ3RoIjozMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2luZGV4LmpzIjp7Im9mZnNldCI6NDA3MjM3LCJsZW5ndGgiOjI0MzMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1vcy9saWIvY29uc3RhbnRzLmpzIjp7Im9mZnNldCI6NDA5NjcwLCJsZW5ndGgiOjExMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2xpYi9lcnJvcnMuanMiOnsib2Zmc2V0Ijo0MDk3ODMsImxlbmd0aCI6NDc5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NDEwMjYyLCJsZW5ndGgiOjEwMjMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2luZGV4LmpzIjp7Im9mZnNldCI6NDExMjg1LCJsZW5ndGgiOjMwNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL2NvbnN0YW50cy5qcyI6eyJvZmZzZXQiOjQxMTU5MSwibGVuZ3RoIjoyNDcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9wb3NpeC5qcyI6eyJvZmZzZXQiOjQxMTgzOCwibGVuZ3RoIjo1OTkxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvc2hhcmVkLmpzIjp7Im9mZnNldCI6NDE3ODI5LCJsZW5ndGgiOjE4ODgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi93aW4zMi5qcyI6eyJvZmZzZXQiOjQxOTcxNywibGVuZ3RoIjoxMzQyNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NDMzMTQ0LCJsZW5ndGgiOjc5NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9pbmRleC5qcyI6eyJvZmZzZXQiOjQzMzk0MCwibGVuZ3RoIjoxMDE5OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvY29tbWFuZC1yb3V0ZXIuanMiOnsib2Zmc2V0Ijo0NDQxMzksImxlbmd0aCI6MTA3MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvY29uc3RhbnRzLmpzIjp7Im9mZnNldCI6NDQ1MjEyLCJsZW5ndGgiOjI3MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvZXJyb3JzLmpzIjp7Im9mZnNldCI6NDQ1NDgyLCJsZW5ndGgiOjU5NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvaW5jb21pbmctcmVxdWVzdC5qcyI6eyJvZmZzZXQiOjQ0NjA3OSwibGVuZ3RoIjoxMjQxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9pbmNvbWluZy1zdHJlYW0uanMiOnsib2Zmc2V0Ijo0NDczMjAsImxlbmd0aCI6MTI2MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvbWVzc2FnZXMuanMiOnsib2Zmc2V0Ijo0NDg1ODMsImxlbmd0aCI6MzkzNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvb3V0Z29pbmctcmVxdWVzdC5qcyI6eyJvZmZzZXQiOjQ1MjUxNywibGVuZ3RoIjoxNjcwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9vdXRnb2luZy1zdHJlYW0uanMiOnsib2Zmc2V0Ijo0NTQxODcsImxlbmd0aCI6MjM3NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo0NTY1NjEsImxlbmd0aCI6MTIwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9pbmRleC5qcyI6eyJvZmZzZXQiOjQ1Nzc2OSwibGVuZ3RoIjo3NjU4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjQ2NTQyNywibGVuZ3RoIjoxMzA3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2JpbmRpbmcuanMiOnsib2Zmc2V0Ijo0NjY3MzQsImxlbmd0aCI6MzMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS11cmwvaW5kZXguanMiOnsib2Zmc2V0Ijo0NjY3NjcsImxlbmd0aCI6OTI2MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9saWIvZXJyb3JzLmpzIjp7Im9mZnNldCI6NDc2MDI4LCJsZW5ndGgiOjc3OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9saWIvdXJsLXNlYXJjaC1wYXJhbXMuanMiOnsib2Zmc2V0Ijo0NzY4MDYsImxlbmd0aCI6Mzg2NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo0ODA2NzMsImxlbmd0aCI6MTEwNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iaWctc3BhcnNlLWFycmF5L2luZGV4LmpzIjp7Im9mZnNldCI6NDgxNzc4LCJsZW5ndGgiOjI0NzEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmlnLXNwYXJzZS1hcnJheS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo0ODQyNDksImxlbmd0aCI6NjM2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JpdHMtdG8tYnl0ZXMvaW5kZXguanMiOnsib2Zmc2V0Ijo0ODQ4ODUsImxlbmd0aCI6MzA4MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iaXRzLXRvLWJ5dGVzL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjQ4Nzk2OCwibGVuZ3RoIjo3MDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmxpbmQtcmVsYXkvaW5kZXguanMiOnsib2Zmc2V0Ijo0ODg2NzYsImxlbmd0aCI6MTA4NTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmxpbmQtcmVsYXkvbGliL2Vycm9ycy5qcyI6eyJvZmZzZXQiOjQ5OTUyNywibGVuZ3RoIjoxMDQzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjUwMDU3MCwibGVuZ3RoIjoxMDQ2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JvZ29uL2luZGV4LmpzIjp7Im9mZnNldCI6NTAxNjE2LCJsZW5ndGgiOjM5NjEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYm9nb24vcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTA1NTc3LCJsZW5ndGgiOjY1NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb2RlY3MvaW5kZXguanMiOnsib2Zmc2V0Ijo1MDYyMzQsImxlbmd0aCI6MjQxNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb2RlY3MvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTA4NjUwLCJsZW5ndGgiOjY1NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkL2luZGV4LmpzIjp7Im9mZnNldCI6NTA5MzA1LCJsZW5ndGgiOjE5NjMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo1MTEyNjgsImxlbmd0aCI6ODI3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctbmV0L2luZGV4LmpzIjp7Im9mZnNldCI6NTEyMDk1LCJsZW5ndGgiOjQxMDksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1uZXQvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTE2MjA0LCJsZW5ndGgiOjczNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2VuZGlhbi5qcyI6eyJvZmZzZXQiOjUxNjkzOCwibGVuZ3RoIjoxMDUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyI6eyJvZmZzZXQiOjUxNzA0MywibGVuZ3RoIjoyMzYzNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2xleGludC5qcyI6eyJvZmZzZXQiOjU0MDY3NywibGVuZ3RoIjoyODUxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTQzNTI4LCJsZW5ndGgiOjgwMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL3Jhdy5qcyI6eyJvZmZzZXQiOjU0NDMyOSwibGVuZ3RoIjo0MDkzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvcmUtY291cGxlci9pbmRleC5qcyI6eyJvZmZzZXQiOjU0ODQyMiwibGVuZ3RoIjoyMjQzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvcmUtY291cGxlci9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo1NTA2NjUsImxlbmd0aCI6NTk5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9pbmRleC5qcyI6eyJvZmZzZXQiOjU1MTI2NCwibGVuZ3RoIjoxNzg2MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvbGliL2F1ZGl0LmpzIjp7Im9mZnNldCI6NTY5MTI2LCJsZW5ndGgiOjQ3NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTY5NjAxLCJsZW5ndGgiOjEwODUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGVib3VuY2VpZnkvaW5kZXguanMiOnsib2Zmc2V0Ijo1NzA2ODYsImxlbmd0aCI6NTg1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RlYm91bmNlaWZ5L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjU3MTI3MSwibGVuZ3RoIjo1NjcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGV2aWNlLWZpbGUvaW5kZXguanMiOnsib2Zmc2V0Ijo1NzE4MzgsImxlbmd0aCI6NTkwMCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kZXZpY2UtZmlsZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo1Nzc3MzgsImxlbmd0aCI6MTA2MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2luZGV4LmpzIjp7Im9mZnNldCI6NTc4ODAxLCJsZW5ndGgiOjI1NDAzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2NvbW1hbmRzLmpzIjp7Im9mZnNldCI6NjA0MjA0LCJsZW5ndGgiOjgyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2Vycm9ycy5qcyI6eyJvZmZzZXQiOjYwNDI4NiwibGVuZ3RoIjo3MTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvaW8uanMiOnsib2Zmc2V0Ijo2MDUwMDUsImxlbmd0aCI6MTU5MjYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvcGVlci5qcyI6eyJvZmZzZXQiOjYyMDkzMSwibGVuZ3RoIjo2MzEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvcXVlcnkuanMiOnsib2Zmc2V0Ijo2MjE1NjIsImxlbmd0aCI6OTkxMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9zZXNzaW9uLmpzIjp7Im9mZnNldCI6NjMxNDc1LCJsZW5ndGgiOjExMDMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo2MzI1NzgsImxlbmd0aCI6MTM1NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ldmVudHMtdW5pdmVyc2FsL2JhcmUuanMiOnsib2Zmc2V0Ijo2MzM5MzQsImxlbmd0aCI6NDAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZXZlbnRzLXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo2MzM5NzQsImxlbmd0aCI6OTA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9maXhlZC1zaXplLmpzIjp7Im9mZnNldCI6NjM0ODgyLCJsZW5ndGgiOjg3NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vaW5kZXguanMiOnsib2Zmc2V0Ijo2MzU3NTcsImxlbmd0aCI6OTcyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo2MzY3MjksImxlbmd0aCI6NjgyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2ZkLWxvY2svaW5kZXguanMiOnsib2Zmc2V0Ijo2Mzc0MTEsImxlbmd0aCI6MTY2MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9mZC1sb2NrL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjYzOTA3MiwibGVuZ3RoIjoxMDk5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9pbmRleC5qcyI6eyJvZmZzZXQiOjY0MDE3MSwibGVuZ3RoIjo4MTY0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo2NDgzMzUsImxlbmd0aCI6NjMxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2ZzLW5hdGl2ZS1leHRlbnNpb25zL2JpbmRpbmcuanMiOnsib2Zmc2V0Ijo2NDg5NjYsImxlbmd0aCI6OTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvaW5kZXguanMiOnsib2Zmc2V0Ijo2NDkwNTYsImxlbmd0aCI6NTcxOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo2NTQ3NzQsImxlbmd0aCI6MTY5OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pbmRleC5qcyI6eyJvZmZzZXQiOjY1NjQ3MywibGVuZ3RoIjo0NjEyMCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvZGlmZi5qcyI6eyJvZmZzZXQiOjcwMjU5MywibGVuZ3RoIjo1MzY4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9oaXN0b3J5LmpzIjp7Im9mZnNldCI6NzA3OTYxLCJsZW5ndGgiOjE2NDIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL2xvY2FsLmpzIjp7Im9mZnNldCI6NzA5NjAzLCJsZW5ndGgiOjExODAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL3JhbmdlLmpzIjp7Im9mZnNldCI6NzEwNzgzLCJsZW5ndGgiOjQ3MzQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvbGliL2V4dGVuc2lvbi5qcyI6eyJvZmZzZXQiOjcxNTUxNywibGVuZ3RoIjozNDQ1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2xpYi9tZXNzYWdlcy5qcyI6eyJvZmZzZXQiOjcxODk2MiwibGVuZ3RoIjoyODE2MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo3NDcxMjQsImxlbmd0aCI6MTIxNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIjp7Im9mZnNldCI6NzQ4MzQwLCJsZW5ndGgiOjUwNDAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo3NTMzODAsImxlbmd0aCI6NzcxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiOnsib2Zmc2V0Ijo3NTQxNTEsImxlbmd0aCI6NDg5NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjc1OTA0NywibGVuZ3RoIjo2ODgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWlkLWVuY29kaW5nL2luZGV4LmpzIjp7Im9mZnNldCI6NzU5NzM1LCJsZW5ndGgiOjkyMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NzYwNjU4LCJsZW5ndGgiOjc5OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9pbmRleC5qcyI6eyJvZmZzZXQiOjc2MTQ1NywibGVuZ3RoIjoyNzU1MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvYmxvY2stZGVwZW5kZW5jeS1zdHJlYW0uanMiOnsib2Zmc2V0Ijo3ODkwMDgsImxlbmd0aCI6MjU1NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvY2xvc2UtZXJyb3Itc3RyZWFtLmpzIjp7Im9mZnNldCI6NzkxNTY1LCJsZW5ndGgiOjI3NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIva2V5cy5qcyI6eyJvZmZzZXQiOjc5MTg0MSwibGVuZ3RoIjo3NDU0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9zdHJlYW1zLmpzIjp7Im9mZnNldCI6Nzk5Mjk1LCJsZW5ndGgiOjQ4MjAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3R4LmpzIjp7Im9mZnNldCI6ODA0MTE1LCJsZW5ndGgiOjg0MTYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3ZpZXcuanMiOnsib2Zmc2V0Ijo4MTI1MzEsImxlbmd0aCI6ODM3OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9taWdyYXRpb25zLzAvaW5kZXguanMiOnsib2Zmc2V0Ijo4MjA5MDksImxlbmd0aCI6MjAxMjUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbWlncmF0aW9ucy8wL21lc3NhZ2VzLmpzIjp7Im9mZnNldCI6ODQxMDM0LCJsZW5ndGgiOjI2MjEwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjg2NzI0NCwibGVuZ3RoIjoxMjQ4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3NwZWMvaHlwZXJzY2hlbWEvaW5kZXguanMiOnsib2Zmc2V0Ijo4Njg0OTIsImxlbmd0aCI6MTMxMDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2luZGV4LmpzIjp7Im9mZnNldCI6ODgxNjAwLCJsZW5ndGgiOjMzODU1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvYXVkaXQuanMiOnsib2Zmc2V0Ijo5MTU0NTUsImxlbmd0aCI6MzgzNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2JpdC1pbnRlcmx1ZGUuanMiOnsib2Zmc2V0Ijo5MTkyODksImxlbmd0aCI6NDI1NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2JpdGZpZWxkLmpzIjp7Im9mZnNldCI6OTIzNTQ2LCJsZW5ndGgiOjExODU0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY2Fwcy5qcyI6eyJvZmZzZXQiOjkzNTQwMCwibGVuZ3RoIjoxNTM3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY29tcGF0LmpzIjp7Im9mZnNldCI6OTM2OTM3LCJsZW5ndGgiOjQ3NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NvcHktcHJvbG9ndWUuanMiOnsib2Zmc2V0Ijo5Mzc0MTQsImxlbmd0aCI6NTk5OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NvcmUuanMiOnsib2Zmc2V0Ijo5NDM0MTMsImxlbmd0aCI6MjQ0MTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9kZWZhdWx0LWVuY3J5cHRpb24uanMiOnsib2Zmc2V0Ijo5Njc4MzIsImxlbmd0aCI6MzQ1MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2Rvd25sb2FkLmpzIjp7Im9mZnNldCI6OTcxMjg1LCJsZW5ndGgiOjEyNzgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9ob3Rzd2FwLXF1ZXVlLmpzIjp7Im9mZnNldCI6OTcyNTYzLCJsZW5ndGgiOjE0OTgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9pbmZvLmpzIjp7Im9mZnNldCI6OTc0MDYxLCJsZW5ndGgiOjE1MTcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9pbnNwZWN0LmpzIjp7Im9mZnNldCI6OTc1NTc4LCJsZW5ndGgiOjE5ODMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXJrbGUtdHJlZS5qcyI6eyJvZmZzZXQiOjk3NzU2MSwibGVuZ3RoIjozMzkxMCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lc3NhZ2VzLmpzIjp7Im9mZnNldCI6MTAxMTQ3MSwibGVuZ3RoIjoyNzYzMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL211bHRpc2lnLmpzIjp7Im9mZnNldCI6MTAzOTEwNCwibGVuZ3RoIjoyODUxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXV0ZXguanMiOnsib2Zmc2V0IjoxMDQxOTU1LCJsZW5ndGgiOjEwMjgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZWNlaXZlci1xdWV1ZS5qcyI6eyJvZmZzZXQiOjEwNDI5ODMsImxlbmd0aCI6MTQxMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3JlbW90ZS1iaXRmaWVsZC5qcyI6eyJvZmZzZXQiOjEwNDQzOTYsImxlbmd0aCI6ODA3OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3JlcGxpY2F0b3IuanMiOnsib2Zmc2V0IjoxMDUyNDc1LCJsZW5ndGgiOjgwNzgxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvc2Vzc2lvbi1zdGF0ZS5qcyI6eyJvZmZzZXQiOjExMzMyNTYsImxlbmd0aCI6MzIyMjUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9zdHJlYW1zLmpzIjp7Im9mZnNldCI6MTE2NTQ4MSwibGVuZ3RoIjozMDM0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvdmVyaWZpZXIuanMiOnsib2Zmc2V0IjoxMTY4NTE1LCJsZW5ndGgiOjk2NzgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjExNzgxOTMsImxlbmd0aCI6MjE5NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9pbmRleC5qcyI6eyJvZmZzZXQiOjExODAzOTAsImxlbmd0aCI6MTYwOTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Fubm91bmNlci5qcyI6eyJvZmZzZXQiOjExOTY0ODksImxlbmd0aCI6NzUzMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29ubmVjdC5qcyI6eyJvZmZzZXQiOjEyMDQwMjIsImxlbmd0aCI6MjM2NjgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Nvbm5lY3Rpb24tcG9vbC5qcyI6eyJvZmZzZXQiOjEyMjc2OTAsImxlbmd0aCI6MzA1MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIjp7Im9mZnNldCI6MTIzMDc0MCwibGVuZ3RoIjoxMjExLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jcnlwdG8uanMiOnsib2Zmc2V0IjoxMjMxOTUxLCJsZW5ndGgiOjYzMiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZW5jb2RlLmpzIjp7Im9mZnNldCI6MTIzMjU4MywibGVuZ3RoIjo0NDYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Vycm9ycy5qcyI6eyJvZmZzZXQiOjEyMzMwMjksImxlbmd0aCI6MzcxMiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvaG9sZXB1bmNoZXIuanMiOnsib2Zmc2V0IjoxMjM2NzQxLCJsZW5ndGgiOjEwMDAzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9tZXNzYWdlcy5qcyI6eyJvZmZzZXQiOjEyNDY3NDQsImxlbmd0aCI6MTEyNjYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL25hdC5qcyI6eyJvZmZzZXQiOjEyNTgwMTAsImxlbmd0aCI6NDcxNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbm9pc2Utd3JhcC5qcyI6eyJvZmZzZXQiOjEyNjI3MjQsImxlbmd0aCI6MTY2OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvcGVyc2lzdGVudC5qcyI6eyJvZmZzZXQiOjEyNjQzOTMsImxlbmd0aCI6ODA4NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvcmF3LXN0cmVhbS1zZXQuanMiOnsib2Zmc2V0IjoxMjcyNDc5LCJsZW5ndGgiOjE1MTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3JvdXRlci5qcyI6eyJvZmZzZXQiOjEyNzM5OTAsImxlbmd0aCI6Njk3OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VjdXJlLXBheWxvYWQuanMiOnsib2Zmc2V0IjoxMjgwOTY4LCJsZW5ndGgiOjE0OTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NlbWFwaG9yZS5qcyI6eyJvZmZzZXQiOjEyODI0NTksImxlbmd0aCI6MTU3NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VydmVyLmpzIjp7Im9mZnNldCI6MTI4NDAzNiwibGVuZ3RoIjoyMTE1NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2xlZXBlci5qcyI6eyJvZmZzZXQiOjEzMDUxOTIsImxlbmd0aCI6NjkwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zb2NrZXQtcG9vbC5qcyI6eyJvZmZzZXQiOjEzMDU4ODIsImxlbmd0aCI6NDM0MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxMzEwMjI1LCJsZW5ndGgiOjIwMTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJzY2hlbWEvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTMxMjIzNiwibGVuZ3RoIjoxNTU2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc2NoZW1hL3J1bnRpbWUuY2pzIjp7Im9mZnNldCI6MTMxMzc5MiwibGVuZ3RoIjo1NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2luZGV4LmpzIjp7Im9mZnNldCI6MTMxMzg0NiwibGVuZ3RoIjoxODQyOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9idWxrLXRpbWVyLmpzIjp7Im9mZnNldCI6MTMzMjI3NSwibGVuZ3RoIjo3MjgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvY29ubmVjdGlvbi1zZXQuanMiOnsib2Zmc2V0IjoxMzMzMDAzLCJsZW5ndGgiOjgyMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9wZWVyLWRpc2NvdmVyeS5qcyI6eyJvZmZzZXQiOjEzMzM4MjYsImxlbmd0aCI6OTI4NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9wZWVyLWluZm8uanMiOnsib2Zmc2V0IjoxMzQzMTEyLCJsZW5ndGgiOjI2ODgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvcmV0cnktdGltZXIuanMiOnsib2Zmc2V0IjoxMzQ1ODAwLCJsZW5ndGgiOjE4ODksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxMzQ3Njg5LCJsZW5ndGgiOjEyMjgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaW5kZXgtZW5jb2Rlci9pbmRleC5qcyI6eyJvZmZzZXQiOjEzNDg5MTcsImxlbmd0aCI6Njc2MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9pbmRleC1lbmNvZGVyL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjEzNTU2NzksImxlbmd0aCI6NzI5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2lzLW9wdGlvbnMvaW5kZXguanMiOnsib2Zmc2V0IjoxMzU2NDA4LCJsZW5ndGgiOjE0MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9pcy1vcHRpb25zL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjEzNTY1NDgsImxlbmd0aCI6NjA1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2thZGVtbGlhLXJvdXRpbmctdGFibGUvaW5kZXguanMiOnsib2Zmc2V0IjoxMzU3MTUzLCJsZW5ndGgiOjQxNDUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMva2FkZW1saWEtcm91dGluZy10YWJsZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxMzYxMjk4LCJsZW5ndGgiOjk2NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9pbmRleC5qcyI6eyJvZmZzZXQiOjEzNjIyNjUsImxlbmd0aCI6NTM2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjEzNjI4MDEsImxlbmd0aCI6Njc5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L3Byb21pc2UuanMiOnsib2Zmc2V0IjoxMzYzNDgwLCJsZW5ndGgiOjMyNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L2luZGV4LmpzIjp7Im9mZnNldCI6MTM2MzgwNCwibGVuZ3RoIjo0MzgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxMzY0MjQyLCJsZW5ndGgiOjY0NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9uYXQtc2FtcGxlci9pbmRleC5qcyI6eyJvZmZzZXQiOjEzNjQ4ODksImxlbmd0aCI6MTU1MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9uYXQtc2FtcGxlci9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxMzY2NDM5LCJsZW5ndGgiOjYwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1jdXJ2ZS1lZC9pbmRleC5qcyI6eyJvZmZzZXQiOjEzNjcwNDcsImxlbmd0aCI6MTY0MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1jdXJ2ZS1lZC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxMzY4Njg5LCJsZW5ndGgiOjgwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvY2lwaGVyLmpzIjp7Im9mZnNldCI6MTM2OTQ5NywibGVuZ3RoIjoyODE3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9kaC5qcyI6eyJvZmZzZXQiOjEzNzIzMTQsImxlbmd0aCI6MTQzOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvaGtkZi5qcyI6eyJvZmZzZXQiOjEzNzM3NTMsImxlbmd0aCI6MTA5MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvaG1hYy5qcyI6eyJvZmZzZXQiOjEzNzQ4NDUsImxlbmd0aCI6MTI3MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2Uvbm9pc2UuanMiOnsib2Zmc2V0IjoxMzc2MTE4LCJsZW5ndGgiOjY0MzcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjEzODI1NTUsImxlbmd0aCI6NjM4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9zeW1tZXRyaWMtc3RhdGUuanMiOnsib2Zmc2V0IjoxMzgzMTkzLCJsZW5ndGgiOjIyMDYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MvaW5kZXguanMiOnsib2Zmc2V0IjoxMzg1Mzk5LCJsZW5ndGgiOjY0ODksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTM5MTg4OCwibGVuZ3RoIjo3MTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcHJvdG9tdXgtd2FrZXVwL2luZGV4LmpzIjp7Im9mZnNldCI6MTM5MjYwNywibGVuZ3RoIjoxNjgyNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9wcm90b211eC13YWtldXAvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQwOTQzMSwibGVuZ3RoIjo5NzIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcHJvdG9tdXgtd2FrZXVwL3NwZWMvaHlwZXJzY2hlbWEvaW5kZXguanMiOnsib2Zmc2V0IjoxNDEwNDAzLCJsZW5ndGgiOjMzMzUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcHJvdG9tdXgvaW5kZXguanMiOnsib2Zmc2V0IjoxNDEzNzM4LCJsZW5ndGgiOjE4OTk2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0MzI3MzQsImxlbmd0aCI6ODE2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQzMzU1MCwibGVuZ3RoIjo2NjksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcXVldWUtdGljay9wcm9jZXNzLW5leHQtdGljay5qcyI6eyJvZmZzZXQiOjE0MzQyMTksImxlbmd0aCI6MTYwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcXVldWUtbWljcm90YXNrLmpzIjp7Im9mZnNldCI6MTQzNDM3OSwibGVuZ3RoIjoxMDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtbmF0aXZlL2JpbmRpbmcuanMiOnsib2Zmc2V0IjoxNDM0NDg3LCJsZW5ndGgiOjkwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LW5hdGl2ZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE0MzQ1NzcsImxlbmd0aCI6NDY4MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC1uYXRpdmUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQzOTI2MCwibGVuZ3RoIjoxMTA0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9mYWxsYmFjay5qcyI6eyJvZmZzZXQiOjE0NDAzNjQsImxlbmd0aCI6MTAyMDQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL2luZGV4LmpzIjp7Im9mZnNldCI6MTQ1MDU2OCwibGVuZ3RoIjo0NDIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0NTEwMTAsImxlbmd0aCI6OTA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JhY2hlL2luZGV4LmpzIjp7Im9mZnNldCI6MTQ1MTkxOCwibGVuZ3RoIjoyNDYzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JhY2hlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0NTQzODEsImxlbmd0aCI6NjAyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JhbmRvbS1hcnJheS1pdGVyYXRvci9pbmRleC5qcyI6eyJvZmZzZXQiOjE0NTQ5ODMsImxlbmd0aCI6MTAwMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yYW5kb20tYXJyYXktaXRlcmF0b3IvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQ1NTk4NCwibGVuZ3RoIjo3MDAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiOnsib2Zmc2V0IjoxNDU2Njg0LCJsZW5ndGgiOjEwOTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQ1Nzc3NSwibGVuZ3RoIjo4MTIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVjb3JkLWNhY2hlL2luZGV4LmpzIjp7Im9mZnNldCI6MTQ1ODU4NywibGVuZ3RoIjozNjY4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JlY29yZC1jYWNoZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDYyMjU1LCJsZW5ndGgiOjYxMiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZWZjb3VudGVyL2luZGV4LmpzIjp7Im9mZnNldCI6MTQ2Mjg2NywibGVuZ3RoIjo2MTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVmY291bnRlci9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDYzNDc4LCJsZW5ndGgiOjQ1MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL2xpYi9iYXJlLmpzIjp7Im9mZnNldCI6MTQ2MzkyOSwibGVuZ3RoIjo0NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0NjM5NzQsImxlbmd0aCI6MTQ0OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZXNvbHZlLXJlamVjdC1wcm9taXNlL2luZGV4LmpzIjp7Im9mZnNldCI6MTQ2NTQyMywibGVuZ3RoIjo0NDMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDY1ODY2LCJsZW5ndGgiOjU4MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZXNvdXJjZS1vbi1leGl0L2luZGV4LmpzIjp7Im9mZnNldCI6MTQ2NjQ0NywibGVuZ3RoIjozNjEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVzb3VyY2Utb24tZXhpdC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDY2ODA4LCJsZW5ndGgiOjQ5NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIjp7Im9mZnNldCI6MTQ2NzMwNCwibGVuZ3RoIjo5MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE0NjczOTQsImxlbmd0aCI6NDcwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvYmF0Y2guanMiOnsib2Zmc2V0IjoxNDcyMTAyLCJsZW5ndGgiOjg4MTIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2NvbHVtbi1mYW1pbHkuanMiOnsib2Zmc2V0IjoxNDgwOTE0LCJsZW5ndGgiOjI2NzQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2NvbnN0YW50cy5qcyI6eyJvZmZzZXQiOjE0ODM1ODgsImxlbmd0aCI6OTQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2ZpbHRlci1wb2xpY3kuanMiOnsib2Zmc2V0IjoxNDgzNjgyLCJsZW5ndGgiOjQzNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvaXRlcmF0b3IuanMiOnsib2Zmc2V0IjoxNDg0MTE5LCJsZW5ndGgiOjQzMTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL3NuYXBzaG90LmpzIjp7Im9mZnNldCI6MTQ4ODQzMCwibGVuZ3RoIjo1MDMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL3N0YXRlLmpzIjp7Im9mZnNldCI6MTQ4ODkzMywibGVuZ3RoIjo5NzYyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0OTg2OTUsImxlbmd0aCI6MTUzOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiOnsib2Zmc2V0IjoxNTAwMjM0LCJsZW5ndGgiOjUwNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTUwMDc0MCwibGVuZ3RoIjo1NDcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2NvcGUtbG9jay9pbmRleC5qcyI6eyJvZmZzZXQiOjE1MDEyODcsImxlbmd0aCI6MTgyMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zY29wZS1sb2NrL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MDMxMDgsImxlbmd0aCI6NjExLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NodWZmbGVkLXByaW9yaXR5LXF1ZXVlL2luZGV4LmpzIjp7Im9mZnNldCI6MTUwMzcxOSwibGVuZ3RoIjoyNjA3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NodWZmbGVkLXByaW9yaXR5LXF1ZXVlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MDYzMjYsImxlbmd0aCI6NjkxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpZ25hbC1wcm9taXNlL2luZGV4LmpzIjp7Im9mZnNldCI6MTUwNzAxNywibGVuZ3RoIjoxMjUyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpZ25hbC1wcm9taXNlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MDgyNjksImxlbmd0aCI6NTAzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpZ25lZC12YXJpbnQvaW5kZXguanMiOnsib2Zmc2V0IjoxNTA4NzcyLCJsZW5ndGgiOjQzNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaWduZWQtdmFyaW50L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MDkyMDcsImxlbmd0aCI6NTIzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS1uYXRpdmUvYmluZGluZy5qcyI6eyJvZmZzZXQiOjE1MDk3MzAsImxlbmd0aCI6OTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2ltZGxlLW5hdGl2ZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE1MDk4MjAsImxlbmd0aCI6MzQ3NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MTMyOTQsImxlbmd0aCI6MTExNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtdW5pdmVyc2FsL2ZhbGxiYWNrLmpzIjp7Im9mZnNldCI6MTUxNDQwOSwibGVuZ3RoIjo1MTM3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvaW5kZXguanMiOnsib2Zmc2V0IjoxNTE5NTQ2LCJsZW5ndGgiOjEwMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MTk2NDksImxlbmd0aCI6ODc5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvc2NhbGFyLmpzIjp7Im9mZnNldCI6MTUyMDUyOCwibGVuZ3RoIjo0NjksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9iaW5kaW5nLmpzIjp7Im9mZnNldCI6MTUyMDk5NywibGVuZ3RoIjo4OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tbmF0aXZlL2luZGV4LmpzIjp7Im9mZnNldCI6MTUyMTA4NiwibGVuZ3RoIjo2NjMyOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tbmF0aXZlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1ODc0MTQsImxlbmd0aCI6MTM1NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tc2VjcmV0c3RyZWFtL2luZGV4LmpzIjp7Im9mZnNldCI6MTU4ODc3MCwibGVuZ3RoIjoyMjU3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS1zZWNyZXRzdHJlYW0vcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTU5MTAyNywibGVuZ3RoIjo2NTcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyI6eyJvZmZzZXQiOjE1OTE2ODQsImxlbmd0aCI6NDIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTkxNzI2LCJsZW5ndGgiOjEyMTcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyI6eyJvZmZzZXQiOjE1OTI5NDMsImxlbmd0aCI6MzMzNTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc3RyZWFteC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjI2MjkzLCJsZW5ndGgiOjgzNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zdWItZW5jb2Rlci9pbmRleC5qcyI6eyJvZmZzZXQiOjE2MjcxMjksImxlbmd0aCI6MTk2OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zdWItZW5jb2Rlci9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjI5MDk3LCJsZW5ndGgiOjkwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvaW5kZXguanMiOnsib2Zmc2V0IjoxNjMwMDA1LCJsZW5ndGgiOjEzNzgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL2xpYi9wYXNzLXRocm91Z2gtZGVjb2Rlci5qcyI6eyJvZmZzZXQiOjE2MzEzODMsImxlbmd0aCI6MjczLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9saWIvdXRmOC1kZWNvZGVyLmpzIjp7Im9mZnNldCI6MTYzMTY1NiwibGVuZ3RoIjoyNTI5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjM0MTg1LCJsZW5ndGgiOjk4NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90aW1lLW9yZGVyZWQtc2V0L2luZGV4LmpzIjp7Im9mZnNldCI6MTYzNTE3MiwibGVuZ3RoIjoxNDQ0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RpbWUtb3JkZXJlZC1zZXQvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTYzNjYxNiwibGVuZ3RoIjo2NjYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL2Jyb3dzZXIuanMiOnsib2Zmc2V0IjoxNjM3MjgyLCJsZW5ndGgiOjEwOTgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL2luZGV4LmpzIjp7Im9mZnNldCI6MTYzODM4MCwibGVuZ3RoIjoxODQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL25vZGUuanMiOnsib2Zmc2V0IjoxNjM4NTY0LCJsZW5ndGgiOjkyOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTYzOTQ5MiwibGVuZ3RoIjo2MTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGlueS1idWZmZXItbWFwL2luZGV4LmpzIjp7Im9mZnNldCI6MTY0MDExMSwibGVuZ3RoIjo5MzYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGlueS1idWZmZXItbWFwL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2NDEwNDcsImxlbmd0aCI6NjUwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvYmluZGluZy5qcyI6eyJvZmZzZXQiOjE2NDE2OTcsImxlbmd0aCI6OTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvaXAuanMiOnsib2Zmc2V0IjoxNjQxNzg3LCJsZW5ndGgiOjIyMDQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvbmV0d29yay1pbnRlcmZhY2VzLmpzIjp7Im9mZnNldCI6MTY0Mzk5MSwibGVuZ3RoIjoxMzQxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL3NvY2tldC5qcyI6eyJvZmZzZXQiOjE2NDUzMzIsImxlbmd0aCI6NzU1NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9zdHJlYW0uanMiOnsib2Zmc2V0IjoxNjUyODg5LCJsZW5ndGgiOjEyNzA2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL3VkeC5qcyI6eyJvZmZzZXQiOjE2NjU1OTUsImxlbmd0aCI6Mjg2OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2Njg0NjMsImxlbmd0aCI6MTYxNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91bm9yZGVyZWQtc2V0L2luZGV4LmpzIjp7Im9mZnNldCI6MTY3MDA3OCwibGVuZ3RoIjo2NzcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdW5vcmRlcmVkLXNldC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjcwNzU1LCJsZW5ndGgiOjY1NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91bnNsYWIvaW5kZXguanMiOnsib2Zmc2V0IjoxNjcxNDA5LCJsZW5ndGgiOjkxMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91bnNsYWIvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTY3MjMyMiwibGVuZ3RoIjo2MTMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdmFyaW50L2RlY29kZS5qcyI6eyJvZmZzZXQiOjE2NzI5MzUsImxlbmd0aCI6NTA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3ZhcmludC9lbmNvZGUuanMiOnsib2Zmc2V0IjoxNjczNDQzLCJsZW5ndGgiOjQ1MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy92YXJpbnQvaW5kZXguanMiOnsib2Zmc2V0IjoxNjczODk1LCJsZW5ndGgiOjEzNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy92YXJpbnQvbGVuZ3RoLmpzIjp7Im9mZnNldCI6MTY3NDAyOSwibGVuZ3RoIjo0NzEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdmFyaW50L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2NzQ1MDAsImxlbmd0aCI6NTExLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3doaWNoLXJ1bnRpbWUvaW5kZXguanMiOnsib2Zmc2V0IjoxNjc1MDExLCJsZW5ndGgiOjEyMzEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvd2hpY2gtcnVudGltZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjc2MjQyLCJsZW5ndGgiOjYwMiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy94YWNoZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE2NzY4NDQsImxlbmd0aCI6MjM3OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy94YWNoZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjc5MjIyLCJsZW5ndGgiOjU4NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy96MzIvaW5kZXguanMiOnsib2Zmc2V0IjoxNjc5ODA2LCJsZW5ndGgiOjI2NTQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvejMyL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2ODI0NjAsImxlbmd0aCI6NzAxLCJtb2RlIjo0MjB9LCIvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTY4MzE2MSwibGVuZ3RoIjoyMjI5LCJtb2RlIjo0MjB9LCIvcnBjLWNvbW1hbmRzLm1qcyI6eyJvZmZzZXQiOjE2ODUzOTAsImxlbmd0aCI6Mzc5LCJtb2RlIjo0MjB9fX0KaW1wb3J0IFJQQyBmcm9tICdiYXJlLXJwYycKaW1wb3J0IFVSTCBmcm9tICdiYXJlLXVybCcKaW1wb3J0IHsgam9pbiB9IGZyb20gJ2JhcmUtcGF0aCcKaW1wb3J0IHsKICAgIFJQQ19VUERBVEUsCiAgICBSUENfQURELAogICAgUlBDX0RFTEVURSwKICAgIFJQQ19HRVRfS0VZLAogICAgUlBDX0pPSU5fS0VZLAogICAgUlBDX0FERF9GUk9NX0JBQ0tFTkQsCiAgICBSUENfVVBEQVRFX0ZST01fQkFDS0VORCwKICAgIFJQQ19ERUxFVEVfRlJPTV9CQUNLRU5ELAogICAgU1lOQ19MSVNULAogICAgUlBDX1JFUVVFU1RfU1lOQwp9IGZyb20gJy4uL3JwYy1jb21tYW5kcy5tanMnCmltcG9ydCBiNGEgZnJvbSAnYjRhJwppbXBvcnQge3N5bmNMaXN0VG9Gcm9udGVuZCwgdmFsaWRhdGVJdGVtLCBhZGRJdGVtLCB1cGRhdGVJdGVtLCBkZWxldGVJdGVtfSBmcm9tICcuL2xpYi9pdGVtLm1qcycKY29uc3QgeyBJUEMgfSA9IEJhcmVLaXQKaW1wb3J0IHtsb2FkQXV0b2Jhc2VLZXl9IGZyb20gIi4vbGliL2tleS5tanMiOwppbXBvcnQge2luaXRBdXRvYmFzZSwgam9pbk5ld0Jhc2V9IGZyb20gIi4vbGliL25ldHdvcmsubWpzIjsKaW1wb3J0IHsKICAgIGF1dG9iYXNlLAogICAgc3RvcmUsCiAgICBzd2FybSwKICAgIGNoYXRTd2FybSwKICAgIGRpc2NvdmVyeSwKICAgIHJwYywKICAgIGN1cnJlbnRMaXN0LAogICAgYmFzZUtleSwKICAgIHNldFJwYywKICAgIHNldEN1cnJlbnRMaXN0LCBzZXRCYXNlS2V5Cn0gZnJvbSAiLi9saWIvc3RhdGUubWpzIjsKCgoKCmNvbnN0IGFyZ3YwID0gdHlwZW9mIEJhcmU/LmFyZ3Y/LlswXSA9PT0gJ3N0cmluZycgPyBCYXJlLmFyZ3ZbMF0gOiAnJzsKbGV0IGJhc2VEaXIgPSAnJzsKaWYgKGFyZ3YwKSB7CiAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBiYXNlRGlyID0gYXJndjAuc3RhcnRzV2l0aCgnZmlsZTovLycpID8gVVJMLmZpbGVVUkxUb1BhdGgoYXJndjApIDogYXJndjA7CiAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgYmFzZURpciA9ICcnOwogICAgICAgICAgfQogICAgfQpleHBvcnQgY29uc3Qgc3RvcmFnZVBhdGggPSBiYXNlRGlyID8gam9pbihiYXNlRGlyLCAnbGlzdGEnKSA6ICcuL2RhdGEnOwpleHBvcnQgY29uc3QgcGVlcktleXNTdHJpbmcgPSBCYXJlLmFyZ3ZbMV0gfHwgJycgLy8gQ29tbWEtc2VwYXJhdGVkIHBlZXIga2V5cwpjb25zdCBiYXNlS2V5SGV4ID0gQmFyZS5hcmd2WzJdIHx8ICcnIC8vIE9wdGlvbmFsIEF1dG9iYXNlIGtleSAodG8gam9pbiBhbiBleGlzdGluZyBiYXNlKQpjb25zdCBrZXlGaWxlUGF0aCA9IGJhc2VEaXIgPyBqb2luKGJhc2VEaXIsICdsaXN0YS1hdXRvYmFzZS1rZXkudHh0JykgOiAnLi9hdXRvYmFzZS1rZXkudHh0JzsKY29uc3QgbG9jYWxXcml0ZXJLZXlGaWxlUGF0aCA9IGJhc2VEaXIgPyBqb2luKGJhc2VEaXIsICdsaXN0YS1sb2NhbC13cml0ZXIta2V5LnR4dCcpIDogJy4vbG9jYWwtd3JpdGVyLWtleS50eHQnOwoKCi8vIE9wdGlvbmFsIEF1dG9iYXNlIGtleSBmcm9tIGFyZ3YgKGluaXRpYWwgYmFzZSkgb3IgbG9hZGVkIGZyb20gZmlsZQppZiAoYmFzZUtleUhleCkgewogICAgdHJ5IHsKICAgICAgICBzZXRCYXNlS2V5KEJ1ZmZlci5mcm9tKGJhc2VLZXlIZXgudHJpbSgpLCAnaGV4JykpCiAgICAgICAgY29uc29sZS5lcnJvcignVXNpbmcgZXhpc3RpbmcgQXV0b2Jhc2Uga2V5IGZyb20gYXJndlsyXTonLCBiYXNlS2V5SGV4LnRyaW0oKSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ludmFsaWQgYmFzZSBrZXkgaGV4LCBjcmVhdGluZyBuZXcgYmFzZSBpbnN0ZWFkOicsIGVyci5tZXNzYWdlKQogICAgICAgIHNldEJhc2VLZXkobnVsbCkKICAgIH0KfQoKLy8gSWYgbm8ga2V5IGZyb20gYXJndiwgdHJ5IGxvYWRpbmcgZnJvbSBmaWxlIChmb3IgcmVzdGFydCBwZXJzaXN0ZW5jZSkKaWYgKCFiYXNlS2V5KSB7CiAgICBzZXRCYXNlS2V5KGxvYWRBdXRvYmFzZUtleShrZXlGaWxlUGF0aCkpCn0KCi8vIENyZWF0ZSBSUEMgc2VydmVyCmxldCBycGNHZW5lcmF0ZWQgPSBuZXcgUlBDKElQQywgYXN5bmMgKHJlcSwgZXJyb3IpID0+IHsKICAgIGNvbnNvbGUuZXJyb3IoJ2dvdCBhIHJlcXVlc3QgZnJvbSByZWFjdCcsIHJlcSkKICAgIGlmIChlcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ2dvdCBhbiBlcnJvciBmcm9tIHJlYWN0JywgZXJyb3IpCiAgICB9CiAgICB0cnkgewogICAgICAgIHN3aXRjaCAocmVxLmNvbW1hbmQpIHsKICAgICAgICAgICAgY2FzZSBSUENfQUREOiB7CiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0ID0gSlNPTi5wYXJzZShiNGEudG9TdHJpbmcocmVxLmRhdGEpKQogICAgICAgICAgICAgICAgYXdhaXQgYWRkSXRlbSh0ZXh0KQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJQQ19VUERBVEU6IHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKHJlcS5kYXRhLnRvU3RyaW5nKCkpCiAgICAgICAgICAgICAgICBhd2FpdCB1cGRhdGVJdGVtKGRhdGEuaXRlbSkKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSUENfREVMRVRFOiB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShyZXEuZGF0YS50b1N0cmluZygpKQogICAgICAgICAgICAgICAgYXdhaXQgZGVsZXRlSXRlbShkYXRhLml0ZW0pCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUlBDX0dFVF9LRVk6IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ2NvbW1hbmQgUlBDX0dFVF9LRVknKQogICAgICAgICAgICAgICAgaWYgKCFhdXRvYmFzZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1JQQ19HRVRfS0VZIHJlcXVlc3RlZCBiZWZvcmUgQXV0b2Jhc2UgaXMgcmVhZHknKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCBrZXlSZXEgPSBycGMucmVxdWVzdChSUENfR0VUX0tFWSkKICAgICAgICAgICAgICAgIGtleVJlcS5zZW5kKGF1dG9iYXNlLmxvY2FsLmtleS50b1N0cmluZygnaGV4JykpCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUlBDX0pPSU5fS0VZOiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdjb21tYW5kIFJQQ19KT0lOX0tFWScpCiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShyZXEuZGF0YS50b1N0cmluZygpKQogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignSm9pbmluZyBuZXcgYmFzZSBrZXkgZnJvbSBSUEM6JywgZGF0YS5rZXkpCiAgICAgICAgICAgICAgICBhd2FpdCBqb2luTmV3QmFzZShkYXRhLmtleSkKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSUENfUkVRVUVTVF9TWU5DOiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdjb21tYW5kIFJQQ19SRVFVRVNUX1NZTkMgLSBmcm9udGVuZCByZXF1ZXN0aW5nIGN1cnJlbnQgbGlzdCcpCiAgICAgICAgICAgICAgICBzeW5jTGlzdFRvRnJvbnRlbmQoKQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGhhbmRsaW5nIFJQQyByZXF1ZXN0OicsIGVycikKICAgIH0KfSkKc2V0UnBjKHJwY0dlbmVyYXRlZCkKCi8vIEluaXRpYWxpemUgQXV0b2Jhc2UgZm9yIHRoZSBpbml0aWFsIGJhc2VLZXkgKGZyb20gYXJndiBvciBuZXcpCmF3YWl0IGluaXRBdXRvYmFzZShiYXNlS2V5KS50aGVuKCgpID0+IHsKICAgIGNvbnNvbGUuZXJyb3IoJ0JhY2tlbmQgcmVhZHknKQp9KS5jYXRjaCgoZXJyKSA9PiB7CiAgICBjb25zb2xlLmVycm9yKCdpbml0QXV0b2Jhc2UgZmFpbGVkIGF0IHN0YXJ0dXA6JywgZXJyKQp9KQoKLy8gQmFja2VuZCByZWFkeQpjb25zb2xlLmVycm9yKCdCYWNrZW5kIHJlYWR5JykKCi8vIENsZWFudXAgb24gdGVhcmRvd24KQmFyZS5vbigndGVhcmRvd24nLCBhc3luYyAoKSA9PiB7CiAgICBjb25zb2xlLmVycm9yKCdCYWNrZW5kIHNodXR0aW5nIGRvd24uLi4nKQogICAgdHJ5IHsKICAgICAgICBhd2FpdCBzd2FybS5kZXN0cm95KCkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBkZXN0cm95aW5nIHJlcGxpY2F0aW9uIHN3YXJtOicsIGUpCiAgICB9CiAgICBpZiAoY2hhdFN3YXJtKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgY2hhdFN3YXJtLmRlc3Ryb3koKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZGVzdHJveWluZyBjaGF0IHN3YXJtOicsIGUpCiAgICAgICAgfQogICAgfQogICAgaWYgKGRpc2NvdmVyeSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IGRpc2NvdmVyeS5kZXN0cm95KCkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGRlc3Ryb3lpbmcgZGlzY292ZXJ5OicsIGUpCiAgICAgICAgfQogICAgfQogICAgdHJ5IHsKICAgICAgICBhd2FpdCBzdG9yZS5jbG9zZSgpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgY2xvc2luZyBzdG9yZTonLCBlKQogICAgfQogICAgY29uc29sZS5lcnJvcignQmFja2VuZCBzaHV0ZG93biBjb21wbGV0ZScpCn0pCgpleHBvcnQgZnVuY3Rpb24gb3BlbiAoc3RvcmUpIHsKICAgIGNvbnN0IHZpZXcgPSBzdG9yZS5nZXQoewogICAgICAgIG5hbWU6ICd0ZXN0JywKICAgICAgICB2YWx1ZUVuY29kaW5nOiAnanNvbicKICAgIH0pCiAgICBjb25zb2xlLmVycm9yKCdvcGVuaW5nIHN0b3JlLi4uJywgdmlldykKICAgIHJldHVybiB2aWV3Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhcHBseSAobm9kZXMsIHZpZXcsIGhvc3QpIHsKICAgIGNvbnNvbGUuZXJyb3IoJ2FwcGx5IHN0YXJ0ZWQnKQogICAgZm9yIChjb25zdCB7IHZhbHVlIH0gb2Ygbm9kZXMpIHsKICAgICAgICBpZiAoIXZhbHVlKSBjb250aW51ZQoKICAgICAgICAvLyBIYW5kbGUgd3JpdGVyIG1lbWJlcnNoaXAgdXBkYXRlcyBjb21pbmcgZnJvbSBoYW5kc2hha2UKICAgICAgICBpZiAodmFsdWUudHlwZSA9PT0gJ2FkZC13cml0ZXInICYmIHR5cGVvZiB2YWx1ZS5rZXkgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb25zdCB3cml0ZXJLZXkgPSBCdWZmZXIuZnJvbSh2YWx1ZS5rZXksICdoZXgnKQogICAgICAgICAgICAgICAgYXdhaXQgaG9zdC5hZGRXcml0ZXIod3JpdGVyS2V5LCB7IGluZGV4ZXI6IGZhbHNlIH0pCiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdBZGRlZCB3cml0ZXIgZnJvbSBhZGQtd3JpdGVyIG9wOicsIHZhbHVlLmtleSkKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gYWRkIHdyaXRlciBmcm9tIGFkZC13cml0ZXIgb3A6JywgZXJyKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQoKICAgICAgICBpZiAodmFsdWUudHlwZSA9PT0gJ2FkZCcpIHsKICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZUl0ZW0odmFsdWUudmFsdWUpKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdJbnZhbGlkIGl0ZW0gc2NoZW1hIGluIGFkZCBvcGVyYXRpb246JywgdmFsdWUudmFsdWUpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0FwcGx5aW5nIGFkZCBvcGVyYXRpb24gZm9yIGl0ZW06JywgdmFsdWUudmFsdWUpCiAgICAgICAgICAgIC8vIFVwZGF0ZSBpbi1tZW1vcnkgbGlzdAogICAgICAgICAgICBzZXRDdXJyZW50TGlzdChbdmFsdWUudmFsdWUsIC4uLmN1cnJlbnRMaXN0LmZpbHRlcihpID0+IGkudGV4dCAhPT0gdmFsdWUudmFsdWUudGV4dCldKQogICAgICAgICAgICBjb25zdCBhZGRSZXEgPSBycGMucmVxdWVzdChSUENfQUREX0ZST01fQkFDS0VORCkKICAgICAgICAgICAgYWRkUmVxLnNlbmQoSlNPTi5zdHJpbmdpZnkodmFsdWUudmFsdWUpKQogICAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbHVlLnR5cGUgPT09ICdkZWxldGUnKSB7CiAgICAgICAgICAgIGlmICghdmFsaWRhdGVJdGVtKHZhbHVlLnZhbHVlKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignSW52YWxpZCBpdGVtIHNjaGVtYSBpbiBkZWxldGUgb3BlcmF0aW9uOicsIHZhbHVlLnZhbHVlKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdBcHBseWluZyBkZWxldGUgb3BlcmF0aW9uIGZvciBpdGVtOicsIHZhbHVlLnZhbHVlKQogICAgICAgICAgICAvLyBVcGRhdGUgaW4tbWVtb3J5IGxpc3QKICAgICAgICAgICAgc2V0Q3VycmVudExpc3QoY3VycmVudExpc3QuZmlsdGVyKGkgPT4gaS50ZXh0ICE9PSB2YWx1ZS52YWx1ZS50ZXh0KSkKICAgICAgICAgICAgY29uc3QgZGVsZXRlUmVxID0gcnBjLnJlcXVlc3QoUlBDX0RFTEVURV9GUk9NX0JBQ0tFTkQpCiAgICAgICAgICAgIGRlbGV0ZVJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHZhbHVlLnZhbHVlKSkKICAgICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIGlmICh2YWx1ZS50eXBlID09PSAndXBkYXRlJykgewogICAgICAgICAgICBpZiAoIXZhbGlkYXRlSXRlbSh2YWx1ZS52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ludmFsaWQgaXRlbSBzY2hlbWEgaW4gdXBkYXRlIG9wZXJhdGlvbjonLCB2YWx1ZS52YWx1ZSkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc29sZS5lcnJvcignQXBwbHlpbmcgdXBkYXRlIG9wZXJhdGlvbiBmb3IgaXRlbTonLCB2YWx1ZS52YWx1ZSkKICAgICAgICAgICAgLy8gVXBkYXRlIGluLW1lbW9yeSBsaXN0CiAgICAgICAgICAgIHNldEN1cnJlbnRMaXN0KGN1cnJlbnRMaXN0Lm1hcChpID0+CiAgICAgICAgICAgICAgICBpLnRleHQgPT09IHZhbHVlLnZhbHVlLnRleHQgPyB2YWx1ZS52YWx1ZSA6IGkKICAgICAgICAgICAgKSkKICAgICAgICAgICAgY29uc3QgdXBkYXRlUmVxID0gcnBjLnJlcXVlc3QoUlBDX1VQREFURV9GUk9NX0JBQ0tFTkQpCiAgICAgICAgICAgIHVwZGF0ZVJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHZhbHVlLnZhbHVlKSkKICAgICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIGlmICh2YWx1ZS50eXBlID09PSAnbGlzdCcpIHsKICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHZhbHVlLnZhbHVlKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignSW52YWxpZCBsaXN0IG9wZXJhdGlvbiBwYXlsb2FkLCBleHBlY3RlZCBhcnJheTonLCB2YWx1ZS52YWx1ZSkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc29sZS5lcnJvcignQXBwbHlpbmcgbGlzdCBvcGVyYXRpb24gZm9yIGl0ZW1zOicsIHZhbHVlLnZhbHVlKQogICAgICAgICAgICBjb25zdCB1cGRhdGVSZXEgPSBycGMucmVxdWVzdChTWU5DX0xJU1QpCiAgICAgICAgICAgIHVwZGF0ZVJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHZhbHVlLnZhbHVlKSkKICAgICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIC8vIEFsbCBvdGhlciB2YWx1ZXMgYXJlIGFwcGVuZGVkIHRvIHRoZSB2aWV3IChmb3IgZnV0dXJlIHVzZSkKICAgICAgICBhd2FpdCB2aWV3LmFwcGVuZCh2YWx1ZSkKICAgIH0KfQoKCi8vIEFkZCBpdGVtIG9wZXJhdGlvbiAoYmFja2VuZCBjcmVhdGVzIHRoZSBjYW5vbmljYWwgaXRlbSkKaW1wb3J0IHtSUENfTUVTU0FHRX0gZnJvbSAiLi4vLi4vcnBjLWNvbW1hbmRzLm1qcyI7CmltcG9ydCB7Z2VuZXJhdGVJZH0gZnJvbSAiLi91dGlsLm1qcyI7CmltcG9ydCB7IGF1dG9iYXNlLCBzdG9yZSwgcnBjIH0gZnJvbSAnLi9zdGF0ZS5tanMnCmltcG9ydCB7U1lOQ19MSVNUfSBmcm9tICIuLi8uLi9ycGMtY29tbWFuZHMubWpzIjsKCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhZGRJdGVtICh0ZXh0LCBsaXN0SWQpIHsKICAgIGlmICghYXV0b2Jhc2UpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdhZGRJdGVtIGNhbGxlZCBiZWZvcmUgQXV0b2Jhc2UgaXMgaW5pdGlhbGl6ZWQnKQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmICghYXV0b2Jhc2Uud3JpdGFibGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdhZGRJdGVtIGNhbGxlZCBidXQgYXV0b2Jhc2UgaXMgbm90IHdyaXRhYmxlIHlldCAtIHdhaXRpbmcgdG8gYmUgYWRkZWQgYXMgd3JpdGVyJykKICAgICAgICAvLyBOb3RpZnkgZnJvbnRlbmQgYWJvdXQgbm90IGJlaW5nIHdyaXRhYmxlCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgcmVxID0gcnBjLnJlcXVlc3QoUlBDX01FU1NBR0UpCiAgICAgICAgICAgIHJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHsgdHlwZTogJ25vdC13cml0YWJsZScsIG1lc3NhZ2U6ICdXYWl0aW5nIHRvIGJlIGFkZGVkIGFzIGEgd3JpdGVyIGJ5IHRoZSBob3N0Li4uJyB9KSkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBzZW5kIG5vdC13cml0YWJsZSBtZXNzYWdlOicsIGUpCiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnNvbGUuZXJyb3IoJ2NvbW1hbmQgUlBDX0FERCBhZGRJdGVtIHRleHQnLCB0ZXh0KQoKICAgIGNvbnN0IGl0ZW0gPSB7CiAgICAgICAgaWQ6IGdlbmVyYXRlSWQoKSwgICAgICAgICAgICAgICAgICAgIC8vIGV4dHJhIG1ldGFkYXRhLCBmcm9udGVuZCBjYW4gaWdub3JlCiAgICAgICAgdGV4dCwKICAgICAgICBpc0RvbmU6IGZhbHNlLAogICAgICAgIGxpc3RJZDogbGlzdElkIHx8IG51bGwsCiAgICAgICAgdGltZU9mQ29tcGxldGlvbjogMCwKICAgICAgICB1cGRhdGVkQXQ6IERhdGUubm93KCksCiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgfQoKICAgIGNvbnN0IG9wID0gewogICAgICAgIHR5cGU6ICdhZGQnLAogICAgICAgIHZhbHVlOiBpdGVtCiAgICB9CgogICAgLy8gR2V0IGxlbmd0aCBiZWZvcmUgYXBwZW5kIHRvIHZlcmlmeSBpdCBpbmNyZWFzZXMKICAgIGNvbnN0IGxlbmd0aEJlZm9yZSA9IGF1dG9iYXNlLmxvY2FsLmxlbmd0aAoKICAgIGF3YWl0IGF1dG9iYXNlLmFwcGVuZChvcCkKCiAgICAvLyBGbHVzaCB0byBkaXNrIGFuZCB2ZXJpZnkgcGVyc2lzdGVuY2UKICAgIGNvbnN0IHBlcnNpc3RlZCA9IGF3YWl0IHBlcnNpc3RBbmRWZXJpZnkobGVuZ3RoQmVmb3JlICsgMSwgJ0FERCcpCiAgICBpZiAoIXBlcnNpc3RlZCkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1dBUk5JTkc6IEFkZCBvcGVyYXRpb24gbWF5IG5vdCBoYXZlIGJlZW4gcGVyc2lzdGVkIHRvIGRpc2shJykKICAgIH0KCiAgICBjb25zb2xlLmVycm9yKCdBZGRlZCBpdGVtOicsIHRleHQsICctIHBlcnNpc3RlZDonLCBwZXJzaXN0ZWQpCiAgICByZXR1cm4gcGVyc2lzdGVkCn0KCi8vIFVwZGF0ZSBpdGVtIG9wZXJhdGlvbjogQVVUT05PTU9VUywgTk8gQkFDS0VORCBNRU1PUlkKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUl0ZW0gKGl0ZW0pIHsKICAgIGlmICghYXV0b2Jhc2UpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCd1cGRhdGVJdGVtIGNhbGxlZCBiZWZvcmUgQXV0b2Jhc2UgaXMgaW5pdGlhbGl6ZWQnKQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmICghYXV0b2Jhc2Uud3JpdGFibGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCd1cGRhdGVJdGVtIGNhbGxlZCBidXQgYXV0b2Jhc2UgaXMgbm90IHdyaXRhYmxlIHlldCcpCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgcmVxID0gcnBjLnJlcXVlc3QoUlBDX01FU1NBR0UpCiAgICAgICAgICAgIHJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHsgdHlwZTogJ25vdC13cml0YWJsZScsIG1lc3NhZ2U6ICdXYWl0aW5nIHRvIGJlIGFkZGVkIGFzIGEgd3JpdGVyIGJ5IHRoZSBob3N0Li4uJyB9KSkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBzZW5kIG5vdC13cml0YWJsZSBtZXNzYWdlOicsIGUpCiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnNvbGUuZXJyb3IoJ2NvbW1hbmQgUlBDX1VQREFURSB1cGRhdGVJdGVtIGl0ZW0nLCBpdGVtKQoKICAgIGNvbnN0IG9wID0gewogICAgICAgIHR5cGU6ICd1cGRhdGUnLAogICAgICAgIHZhbHVlOiBpdGVtCiAgICB9CgogICAgLy8gR2V0IGxlbmd0aCBiZWZvcmUgYXBwZW5kIHRvIHZlcmlmeSBpdCBpbmNyZWFzZXMKICAgIGNvbnN0IGxlbmd0aEJlZm9yZSA9IGF1dG9iYXNlLmxvY2FsLmxlbmd0aAoKICAgIGF3YWl0IGF1dG9iYXNlLmFwcGVuZChvcCkKCiAgICAvLyBGbHVzaCB0byBkaXNrIGFuZCB2ZXJpZnkgcGVyc2lzdGVuY2UKICAgIGNvbnN0IHBlcnNpc3RlZCA9IGF3YWl0IHBlcnNpc3RBbmRWZXJpZnkobGVuZ3RoQmVmb3JlICsgMSwgJ1VQREFURScpCiAgICBpZiAoIXBlcnNpc3RlZCkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1dBUk5JTkc6IFVwZGF0ZSBvcGVyYXRpb24gbWF5IG5vdCBoYXZlIGJlZW4gcGVyc2lzdGVkIHRvIGRpc2shJykKICAgIH0KCiAgICBjb25zb2xlLmVycm9yKCdVcGRhdGVkIGl0ZW06JywgaXRlbS50ZXh0LCAnLSBwZXJzaXN0ZWQ6JywgcGVyc2lzdGVkKQogICAgcmV0dXJuIHBlcnNpc3RlZAp9CgovLyBEZWxldGUgaXRlbSBvcGVyYXRpb246IEFVVE9OT01PVVMsIE5PIEJBQ0tFTkQgTUVNT1JZCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWxldGVJdGVtIChpdGVtKSB7CiAgICBpZiAoIWF1dG9iYXNlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignZGVsZXRlSXRlbSBjYWxsZWQgYmVmb3JlIEF1dG9iYXNlIGlzIGluaXRpYWxpemVkJykKICAgICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBpZiAoIWF1dG9iYXNlLndyaXRhYmxlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignZGVsZXRlSXRlbSBjYWxsZWQgYnV0IGF1dG9iYXNlIGlzIG5vdCB3cml0YWJsZSB5ZXQnKQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHJwYy5yZXF1ZXN0KFJQQ19NRVNTQUdFKQogICAgICAgICAgICByZXEuc2VuZChKU09OLnN0cmluZ2lmeSh7IHR5cGU6ICdub3Qtd3JpdGFibGUnLCBtZXNzYWdlOiAnV2FpdGluZyB0byBiZSBhZGRlZCBhcyBhIHdyaXRlciBieSB0aGUgaG9zdC4uLicgfSkpCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gc2VuZCBub3Qtd3JpdGFibGUgbWVzc2FnZTonLCBlKQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBjb25zb2xlLmVycm9yKCdjb21tYW5kIFJQQ19ERUxFVEUgZGVsZXRlSXRlbSBpdGVtJywgaXRlbSkKCiAgICBjb25zdCBvcCA9IHsKICAgICAgICB0eXBlOiAnZGVsZXRlJywKICAgICAgICB2YWx1ZTogaXRlbQogICAgfQoKICAgIC8vIEdldCBsZW5ndGggYmVmb3JlIGFwcGVuZCB0byB2ZXJpZnkgaXQgaW5jcmVhc2VzCiAgICBjb25zdCBsZW5ndGhCZWZvcmUgPSBhdXRvYmFzZS5sb2NhbC5sZW5ndGgKCiAgICBhd2FpdCBhdXRvYmFzZS5hcHBlbmQob3ApCgogICAgLy8gRmx1c2ggdG8gZGlzayBhbmQgdmVyaWZ5IHBlcnNpc3RlbmNlCiAgICBjb25zdCBwZXJzaXN0ZWQgPSBhd2FpdCBwZXJzaXN0QW5kVmVyaWZ5KGxlbmd0aEJlZm9yZSArIDEsICdERUxFVEUnKQogICAgaWYgKCFwZXJzaXN0ZWQpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdXQVJOSU5HOiBEZWxldGUgb3BlcmF0aW9uIG1heSBub3QgaGF2ZSBiZWVuIHBlcnNpc3RlZCB0byBkaXNrIScpCiAgICB9CgogICAgY29uc29sZS5lcnJvcignRGVsZXRlZCBpdGVtOicsIGl0ZW0udGV4dCwgJy0gcGVyc2lzdGVkOicsIHBlcnNpc3RlZCkKICAgIHJldHVybiBwZXJzaXN0ZWQKfQoKLy8gU2ltcGxlIGlubGluZSBzY2hlbWEgdmFsaWRhdGlvbiBtYXRjaGluZyB0aGUgbW9iaWxlIExpc3RFbnRyeQpleHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVJdGVtIChpdGVtKSB7CiAgICBpZiAodHlwZW9mIGl0ZW0gIT09ICdvYmplY3QnIHx8IGl0ZW0gPT09IG51bGwpIHJldHVybiBmYWxzZQogICAgaWYgKHR5cGVvZiBpdGVtLnRleHQgIT09ICdzdHJpbmcnKSByZXR1cm4gZmFsc2UKICAgIGlmICh0eXBlb2YgaXRlbS5pc0RvbmUgIT09ICdib29sZWFuJykgcmV0dXJuIGZhbHNlCiAgICBpZiAodHlwZW9mIGl0ZW0udGltZU9mQ29tcGxldGlvbiAhPT0gJ251bWJlcicpIHJldHVybiBmYWxzZQogICAgcmV0dXJuIHRydWUKfQoKLy8gU2VuZCBjdXJyZW50IGxpc3QgdG8gZnJvbnRlbmQKZXhwb3J0IGZ1bmN0aW9uIHN5bmNMaXN0VG9Gcm9udGVuZCAoY3VycmVudExpc3QpIHsKICAgIGlmICghcnBjIHx8ICFjdXJyZW50TGlzdCkgcmV0dXJuCiAgICB0cnkgewogICAgICAgIGNvbnN0IHJlcSA9IHJwYy5yZXF1ZXN0KFNZTkNfTElTVCkKICAgICAgICByZXEuc2VuZChKU09OLnN0cmluZ2lmeShjdXJyZW50TGlzdCkpCiAgICAgICAgY29uc29sZS5lcnJvcignU3luY2VkIGxpc3QgdG8gZnJvbnRlbmQ6JywgY3VycmVudExpc3QubGVuZ3RoLCAnaXRlbXMnKQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBzeW5jIGxpc3QgdG8gZnJvbnRlbmQ6JywgZSkKICAgIH0KfQoKLy8gUGVyc2lzdCBhbmQgdmVyaWZ5IHRoYXQgYW4gb3BlcmF0aW9uIHdhcyB3cml0dGVuIHRvIGRpc2sKLy8gUmV0dXJucyB0cnVlIGlmIGZsdXNoIHN1Y2NlZWRlZCBhbmQgbGVuZ3RoIGlzIGNvcnJlY3QsIGZhbHNlIG90aGVyd2lzZQphc3luYyBmdW5jdGlvbiBwZXJzaXN0QW5kVmVyaWZ5IChleHBlY3RlZExlbmd0aCwgb3BlcmF0aW9uVHlwZSkgewogICAgaWYgKCFhdXRvYmFzZSB8fCAhYXV0b2Jhc2UubG9jYWwgfHwgIXN0b3JlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgcGVyc2lzdEFuZFZlcmlmeSAoJHtvcGVyYXRpb25UeXBlfSk6IGF1dG9iYXNlLCBsb2NhbCBjb3JlLCBvciBzdG9yZSBub3QgYXZhaWxhYmxlYCkKICAgICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICB0cnkgewogICAgICAgIC8vIEZvcmNlIHdyaXRlIHRvIGRpc2sgdmlhIENvcmVzdG9yZSAtIHRoaXMgZmx1c2hlcyBhbGwgY29yZXMgdG8gc3RvcmFnZQogICAgICAgIC8vIENvcmVzdG9yZS5mbHVzaCgpIGVuc3VyZXMgYWxsIHBlbmRpbmcgd3JpdGVzIGFyZSBwZXJzaXN0ZWQKICAgICAgICBpZiAodHlwZW9mIHN0b3JlLmZsdXNoID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGF3YWl0IHN0b3JlLmZsdXNoKCkKICAgICAgICB9CgogICAgICAgIGNvbnN0IGFjdHVhbExlbmd0aCA9IGF1dG9iYXNlLmxvY2FsLmxlbmd0aAogICAgICAgIGNvbnN0IGtleUhleCA9IGF1dG9iYXNlLmxvY2FsLmtleS50b1N0cmluZygnaGV4Jykuc2xpY2UoMCwgMTYpCgogICAgICAgIGlmIChhY3R1YWxMZW5ndGggPj0gZXhwZWN0ZWRMZW5ndGgpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgcGVyc2lzdEFuZFZlcmlmeSAoJHtvcGVyYXRpb25UeXBlfSk6IFNVQ0NFU1MgLSBmbHVzaGVkIHRvIGRpc2ssIGNvcmUgJHtrZXlIZXh9Li4uIGxlbmd0aD0ke2FjdHVhbExlbmd0aH1gKQogICAgICAgICAgICByZXR1cm4gdHJ1ZQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYHBlcnNpc3RBbmRWZXJpZnkgKCR7b3BlcmF0aW9uVHlwZX0pOiBMRU5HVEggTUlTTUFUQ0ggLSBjb3JlICR7a2V5SGV4fS4uLiBsZW5ndGg9JHthY3R1YWxMZW5ndGh9LCBleHBlY3RlZCA+PSAke2V4cGVjdGVkTGVuZ3RofWApCiAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBwZXJzaXN0QW5kVmVyaWZ5ICgke29wZXJhdGlvblR5cGV9KTogRkxVU0ggRkFJTEVEIC1gLCBlLm1lc3NhZ2UpCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9Cn0KCgppbXBvcnQgZnMgZnJvbSAnYmFyZS1mcycKCgpleHBvcnQgZnVuY3Rpb24gc2F2ZUF1dG9iYXNlS2V5KGtleSwga2V5RmlsZVBhdGgpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3Qga2V5SGV4ID0ga2V5LnRvU3RyaW5nKCdoZXgnKQogICAgICAgIGZzLndyaXRlRmlsZVN5bmMoa2V5RmlsZVBhdGgsIGtleUhleCkKICAgICAgICBjb25zb2xlLmVycm9yKCdTYXZlZCBhdXRvYmFzZSBrZXkgdG8gZmlsZTonLCBrZXlIZXgpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHNhdmUgYXV0b2Jhc2Uga2V5OicsIGUpCiAgICB9Cn0KCi8vIExvYWQgYXV0b2Jhc2Uga2V5IGZyb20gZmlsZSBpZiBpdCBleGlzdHMKZXhwb3J0IGZ1bmN0aW9uIGxvYWRBdXRvYmFzZUtleShrZXlGaWxlUGF0aCkgewogICAgdHJ5IHsKICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhrZXlGaWxlUGF0aCkpIHsKICAgICAgICAgICAgY29uc3Qga2V5SGV4ID0gZnMucmVhZEZpbGVTeW5jKGtleUZpbGVQYXRoLCAndXRmOCcpLnRyaW0oKQogICAgICAgICAgICBpZiAoa2V5SGV4ICYmIGtleUhleC5sZW5ndGggPT09IDY0KSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdMb2FkZWQgYXV0b2Jhc2Uga2V5IGZyb20gZmlsZTonLCBrZXlIZXgpCiAgICAgICAgICAgICAgICByZXR1cm4gQnVmZmVyLmZyb20oa2V5SGV4LCAnaGV4JykKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9hZCBhdXRvYmFzZSBrZXk6JywgZSkKICAgIH0KICAgIHJldHVybiBudWxsCn0KCi8vIFNhdmUgbG9jYWwgd3JpdGVyIGtleSB0byBmaWxlIGZvciBwZXJzaXN0ZW5jZQpleHBvcnQgZnVuY3Rpb24gc2F2ZUxvY2FsV3JpdGVyS2V5KGtleSwgbG9jYWxXcml0ZXJLZXlGaWxlUGF0aCkgewogICAgdHJ5IHsKICAgICAgICBjb25zdCBrZXlIZXggPSBrZXkudG9TdHJpbmcoJ2hleCcpCiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhsb2NhbFdyaXRlcktleUZpbGVQYXRoLCBrZXlIZXgpCiAgICAgICAgY29uc29sZS5lcnJvcignU2F2ZWQgbG9jYWwgd3JpdGVyIGtleSB0byBmaWxlOicsIGtleUhleCkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gc2F2ZSBsb2NhbCB3cml0ZXIga2V5OicsIGUpCiAgICB9Cn0KCi8vIExvYWQgbG9jYWwgd3JpdGVyIGtleSBmcm9tIGZpbGUgaWYgaXQgZXhpc3RzCmV4cG9ydCBmdW5jdGlvbiBsb2FkTG9jYWxXcml0ZXJLZXkobG9jYWxXcml0ZXJLZXlGaWxlUGF0aCkgewogICAgdHJ5IHsKICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhsb2NhbFdyaXRlcktleUZpbGVQYXRoKSkgewogICAgICAgICAgICBjb25zdCBrZXlIZXggPSBmcy5yZWFkRmlsZVN5bmMobG9jYWxXcml0ZXJLZXlGaWxlUGF0aCwgJ3V0ZjgnKS50cmltKCkKICAgICAgICAgICAgaWYgKGtleUhleCAmJiBrZXlIZXgubGVuZ3RoID09PSA2NCkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignTG9hZGVkIGxvY2FsIHdyaXRlciBrZXkgZnJvbSBmaWxlOicsIGtleUhleCkKICAgICAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShrZXlIZXgsICdoZXgnKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIGxvY2FsIHdyaXRlciBrZXk6JywgZSkKICAgIH0KICAgIHJldHVybiBudWxsCn1pbXBvcnQgSHlwZXJzd2FybSBmcm9tICJoeXBlcnN3YXJtIjsKaW1wb3J0IHthcHBseSwgb3Blbiwgc3RvcmFnZVBhdGgsIHBlZXJLZXlzU3RyaW5nfSBmcm9tICIuLi9iYWNrZW5kLm1qcyI7CmltcG9ydCB7UlBDX01FU1NBR0UsIFJQQ19HRVRfS0VZfSBmcm9tICIuLi8uLi9ycGMtY29tbWFuZHMubWpzIjsKaW1wb3J0IENvcmVzdG9yZSBmcm9tICJjb3Jlc3RvcmUiOwppbXBvcnQgQXV0b2Jhc2UgZnJvbSAiYXV0b2Jhc2UiOwppbXBvcnQgYjRhIGZyb20gImI0YSI7CmltcG9ydCB7IHJhbmRvbUJ5dGVzIH0gZnJvbSAiaHlwZXJjb3JlLWNyeXB0byI7CmltcG9ydCB7CiAgICBhdXRvYmFzZSwKICAgIHJwYywKICAgIGFkZGVkU3RhdGljUGVlcnMsCiAgICBjaGF0U3dhcm0sCiAgICBzd2FybSwKICAgIGJhc2VLZXksCiAgICBzdG9yZSwKICAgIGRpc2NvdmVyeSwKICAgIGtub3duV3JpdGVycywKICAgIHBlZXJDb3VudCwKICAgIHNldEF1dG9iYXNlLAogICAgc2V0QWRkZWRTdGF0aWNQZWVycywKICAgIHNldENoYXRTd2FybSwKICAgIHNldFN3YXJtLAogICAgc2V0RGlzY292ZXJ5LAogICAgc2V0UGVlckNvdW50LAogICAgREVGQVVMVF9MSVNULAogICAgc2V0U3RvcmUsCiAgICBzZXRCYXNlS2V5Cn0gZnJvbSAiLi9zdGF0ZS5tanMiCmltcG9ydCB7IGdlbmVyYXRlSWQgfSBmcm9tICIuL3V0aWwubWpzIgoKZXhwb3J0IGZ1bmN0aW9uIHNlbmRIYW5kc2hha2VNZXNzYWdlIChjb25uLCBtc2cpIHsKICAgIGNvbnN0IGxpbmUgPSBKU09OLnN0cmluZ2lmeShtc2cpICsgJ1xuJwogICAgY29ubi53cml0ZShsaW5lKQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlSGFuZHNoYWtlTWVzc2FnZSAobXNnKSB7CiAgICBpZiAoIWF1dG9iYXNlKSByZXR1cm4KICAgIGlmICghbXNnIHx8IG1zZy50eXBlICE9PSAnd3JpdGVyLWtleScpIHJldHVybgoKICAgIGNvbnN0IHJlbW90ZUtleUhleCA9IG1zZy5rZXkKICAgIGlmICghcmVtb3RlS2V5SGV4IHx8IHR5cGVvZiByZW1vdGVLZXlIZXggIT09ICdzdHJpbmcnKSByZXR1cm4KCiAgICBpZiAoa25vd25Xcml0ZXJzLmhhcyhyZW1vdGVLZXlIZXgpKSByZXR1cm4KICAgIGtub3duV3JpdGVycy5hZGQocmVtb3RlS2V5SGV4KQoKICAgIC8vIE9ubHkgYSB3cml0ZXIgY2FuIGFkZCBvdGhlciB3cml0ZXJzLgogICAgaWYgKCFhdXRvYmFzZS53cml0YWJsZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ05vdCB3cml0YWJsZSBoZXJlLCBjYW5ub3QgYWRkIHJlbW90ZSB3cml0ZXIgeWV0JykKICAgICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zb2xlLmVycm9yKCdBZGRpbmcgcmVtb3RlIHdyaXRlciB2aWEgYXV0b2Jhc2U6JywgcmVtb3RlS2V5SGV4KQoKICAgIGF3YWl0IGF1dG9iYXNlLmFwcGVuZCh7CiAgICAgICAgdHlwZTogJ2FkZC13cml0ZXInLAogICAgICAgIGtleTogcmVtb3RlS2V5SGV4CiAgICB9KQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gc2V0dXBIYW5kc2hha2VDaGFubmVsIChjb25uKSB7CiAgICBpZiAoIWF1dG9iYXNlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignc2V0dXBIYW5kc2hha2VDaGFubmVsIGNhbGxlZCBiZWZvcmUgQXV0b2Jhc2UgaXMgaW5pdGlhbGl6ZWQnKQogICAgICAgIHJldHVybgogICAgfQoKICAgIC8vIFNlbmQgb3VyIHdyaXRlciBrZXkgaW1tZWRpYXRlbHkKICAgIGF3YWl0IGF1dG9iYXNlLnJlYWR5KCkKICAgIGNvbnN0IG15V3JpdGVyS2V5SGV4ID0gYXV0b2Jhc2UubG9jYWwua2V5LnRvU3RyaW5nKCdoZXgnKQogICAgc2VuZEhhbmRzaGFrZU1lc3NhZ2UoY29ubiwgewogICAgICAgIHR5cGU6ICd3cml0ZXIta2V5JywKICAgICAgICBrZXk6IG15V3JpdGVyS2V5SGV4CiAgICB9KQoKICAgIGxldCBidWZmZXIgPSAnJwogICAgY29ubi5vbignZGF0YScsIChjaHVuaykgPT4gewogICAgICAgIGJ1ZmZlciArPSBjaHVuay50b1N0cmluZygpCiAgICAgICAgbGV0IGlkeAogICAgICAgIHdoaWxlICgoaWR4ID0gYnVmZmVyLmluZGV4T2YoJ1xuJykpICE9PSAtMSkgewogICAgICAgICAgICBjb25zdCBsaW5lID0gYnVmZmVyLnNsaWNlKDAsIGlkeCkKICAgICAgICAgICAgYnVmZmVyID0gYnVmZmVyLnNsaWNlKGlkeCArIDEpCiAgICAgICAgICAgIGlmICghbGluZS50cmltKCkpIGNvbnRpbnVlCgogICAgICAgICAgICAvLyBGYXN0LXBhdGg6IGh5cGVyY29yZSBwcm90b2NvbCBmcmFtZXMgYW5kIG90aGVyIGJpbmFyeSBnYXJiYWdlCiAgICAgICAgICAgIC8vIGFyZSBub3QgZ29pbmcgdG8gc3RhcnQgd2l0aCAneycsIHNvIGp1c3QgaWdub3JlIHRoZW0uCiAgICAgICAgICAgIGlmIChsaW5lWzBdICE9PSAneycpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBtc2cKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG1zZyA9IEpTT04ucGFyc2UobGluZSkKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdpbnZhbGlkIEpTT04gZnJvbSBwZWVyIChoYW5kc2hha2UsIGlnbm9yZWQpOicsIGxpbmUpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB9CgogICAgICAgICAgICBoYW5kbGVIYW5kc2hha2VNZXNzYWdlKG1zZykKICAgICAgICB9CiAgICB9KQp9CgpleHBvcnQgZnVuY3Rpb24gc2V0dXBDaGF0U3dhcm0gKGNoYXRUb3BpYykgewogICAgaWYgKCFhdXRvYmFzZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ3NldHVwQ2hhdFN3YXJtIGNhbGxlZCBiZWZvcmUgQXV0b2Jhc2UgaXMgaW5pdGlhbGl6ZWQnKQogICAgICAgIHJldHVybgogICAgfQogICAgc2V0Q2hhdFN3YXJtKG5ldyBIeXBlcnN3YXJtKCkpCiAgICBjb25zb2xlLmVycm9yKCdzZXR0aW5nIHVwIGNoYXQgc3dhcm0gd2l0aCB0b3BpYzonLCBjaGF0VG9waWMudG9TdHJpbmcoJ2hleCcpKQogICAgY2hhdFN3YXJtLm9uKCdjb25uZWN0aW9uJywgKGNvbm4sIGluZm8pID0+IHsKICAgICAgICBjb25zb2xlLmVycm9yKCdIYW5kc2hha2UgY29ubmVjdGlvbiAoY2hhdCBzd2FybSkgd2l0aCBwZWVyJywgaW5mbz8ucGVlciwgaW5mbz8ucHVibGljS2V5Py50b1N0cmluZygnaGV4JyksIGluZm8/LnRvcGljcywgaW5mbz8ucHJpb3JpdGl6ZWQpCiAgICAgICAgY29ubi5vbignZXJyb3InLCAoZXJyKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0NoYXQgc3dhcm0gY29ubmVjdGlvbiBlcnJvcjonLCBlcnIpCiAgICAgICAgfSkKICAgICAgICBzZXR1cEhhbmRzaGFrZUNoYW5uZWwoY29ubikKICAgIH0pCgogICAgY2hhdFN3YXJtLm9uKCdlcnJvcicsIChlcnIpID0+IHsKICAgICAgICBjb25zb2xlLmVycm9yKCdDaGF0IHN3YXJtIGVycm9yOicsIGVycikKICAgIH0pCgogICAgY2hhdFN3YXJtLmpvaW4oY2hhdFRvcGljLCB7IHNlcnZlcjogdHJ1ZSwgY2xpZW50OiB0cnVlIH0pCiAgICBjb25zb2xlLmVycm9yKCdIYW5kc2hha2UgY2hhdCBzd2FybSBqb2luZWQgb24gdG9waWM6JywgY2hhdFRvcGljLnRvU3RyaW5nKCdoZXgnKSkKfQoKCmFzeW5jIGZ1bmN0aW9uIHRlYXJEb3duQXV0b2Jhc2VTd2FybVN0b3JlKCkgewogICAgLy8gMS4gQ2xlYW4gdXAgcHJldmlvdXMgQXV0b2Jhc2UgaW5zdGFuY2UgKGlmIGFueSkKICAgIGlmIChhdXRvYmFzZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF1dG9iYXNlLnJlbW92ZUFsbExpc3RlbmVycygnYXBwZW5kJykKICAgICAgICAgICAgaWYgKHR5cGVvZiBhdXRvYmFzZS5jbG9zZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignQ2xvc2luZyBwcmV2aW91cyBBdXRvYmFzZSBpbnN0YW5jZS4uLicpCiAgICAgICAgICAgICAgICBhd2FpdCBhdXRvYmFzZS5jbG9zZSgpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdQcmV2aW91cyBBdXRvYmFzZSBoYXMgbm8gY2xvc2UoKSBtZXRob2QsIHNraXBwaW5nIGNsb3NlJykKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3Igd2hpbGUgY2xvc2luZyBwcmV2aW91cyBBdXRvYmFzZTonLCBlKQogICAgICAgIH0KICAgICAgICBzZXRBdXRvYmFzZShudWxsKQogICAgfQoKICAgIC8vIDIuIFRlYXIgZG93biBuZXR3b3JraW5nIGJvdW5kIHRvIG9sZCBzdG9yZQogICAgaWYgKGRpc2NvdmVyeSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IGRpc2NvdmVyeS5kZXN0cm95KCkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSkKICAgICAgICB9CiAgICAgICAgc2V0RGlzY292ZXJ5KG51bGwpCiAgICB9CiAgICBpZiAoY2hhdFN3YXJtKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgY2hhdFN3YXJtLmRlc3Ryb3koKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKQogICAgICAgIH0KICAgICAgICBzZXRDaGF0U3dhcm0obnVsbCkKICAgIH0KCiAgICAvLyAzLiBDbG9zZSBvbGQgc3RvcmUKICAgIGlmIChzdG9yZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IHN0b3JlLmNsb3NlKCkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGNsb3NpbmcgQ29yZXN0b3JlOicsIGUpCiAgICAgICAgfQogICAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gaW5pdEF1dG9iYXNlIChuZXdCYXNlS2V5KSB7CiAgICBhd2FpdCB0ZWFyRG93bkF1dG9iYXNlU3dhcm1TdG9yZSgpOwoKICAgIC8vIFVzZSBwZXItYmFzZSBzdG9yYWdlIHBhdGggdG8gYXZvaWQgY29uZmxpY3RzIHdoZW4gam9pbmluZyBkaWZmZXJlbnQgYmFzZXMKICAgIGNvbnN0IGtleVByZWZpeCA9IG5ld0Jhc2VLZXkgPyBuZXdCYXNlS2V5LnRvU3RyaW5nKCdoZXgnKS5zbGljZSgwLCA4KSA6ICdsb2NhbCcKICAgIGNvbnN0IGJhc2VTdG9yYWdlUGF0aCA9IGAke3N0b3JhZ2VQYXRofS0ke2tleVByZWZpeH1gCgogICAgc2V0U3RvcmUobmV3IENvcmVzdG9yZShiYXNlU3RvcmFnZVBhdGgpKQogICAgYXdhaXQgc3RvcmUucmVhZHkoKQogICAgc2V0QmFzZUtleShuZXdCYXNlS2V5IHx8IG51bGwpCiAgICBjb25zb2xlLmVycm9yKAogICAgICAgICdpbml0aWFsaXppbmcgYSBuZXcgYXV0b2Jhc2Ugd2l0aCBrZXk6JywKICAgICAgICBiYXNlS2V5ID8gYmFzZUtleS50b1N0cmluZygnaGV4JykgOiAnKG5ldyBiYXNlKScKICAgICkKICAgIGNvbnN0IGF1dG9iYXNlT3B0cyA9IHsgYXBwbHksIG9wZW4sIHZhbHVlRW5jb2Rpbmc6ICdqc29uJyB9CiAgICBzZXRBdXRvYmFzZShuZXcgQXV0b2Jhc2Uoc3RvcmUsIGJhc2VLZXksIGF1dG9iYXNlT3B0cykpCiAgICBjb25zb2xlLmVycm9yKCdDYWxsaW5nIGF1dG9iYXNlLnJlYWR5KCkuLi4nKQogICAgYXdhaXQgYXV0b2Jhc2UucmVhZHkoKQogICAgY29uc29sZS5lcnJvcigKICAgICAgICAnYXV0b2Jhc2UucmVhZHkoKSByZXNvbHZlZC4gQXV0b2Jhc2UgcmVhZHksIHdyaXRhYmxlPycsCiAgICAgICAgYXV0b2Jhc2Uud3JpdGFibGUsCiAgICAgICAgJyBrZXk6JywKICAgICAgICBhdXRvYmFzZS5rZXk/LnRvU3RyaW5nKCdoZXgnKSwKICAgICAgICAnIGxvY2FsIHdyaXRlciBrZXk6JywKICAgICAgICBhdXRvYmFzZS5sb2NhbD8ua2V5Py50b1N0cmluZygnaGV4JykKICAgICkKICAgIGlmIChhdXRvYmFzZSkgewogICAgICAgIGNvbnN0IHJlcSA9IHJwYy5yZXF1ZXN0KFJQQ19HRVRfS0VZKQogICAgICAgIHJlcS5zZW5kKGF1dG9iYXNlLmtleT8udG9TdHJpbmcoJ2hleCcpKQogICAgfQogICAgYXV0b2Jhc2Uub24oJ2FwcGVuZCcsIGFzeW5jICgpID0+IHsKICAgICAgICBjb25zb2xlLmVycm9yKCdOZXcgZGF0YSBhcHBlbmRlZCwgdXBkYXRpbmcgdmlldy4uLicpCiAgICB9KQogICAgLy8gU2VlZCBERUZBVUxUX0xJU1QgaWYgYXV0b2Jhc2UgaXMgZW1wdHkgKGFwcGx5KCkgd2lsbCB1cGRhdGUgdGhlIFVJKQogICAgYXdhaXQgZW5zdXJlRGVmYXVsdExpc3RJZkVtcHR5KCkKICAgIC8vIEFkZCBzdGF0aWMgcGVlcnMgb25seSBvbmNlCiAgICBpZiAoIWFkZGVkU3RhdGljUGVlcnMgJiYgcGVlcktleXNTdHJpbmcpIHsKICAgICAgICBjb25zdCBwZWVyS2V5cyA9IHBlZXJLZXlzU3RyaW5nLnNwbGl0KCcsJykuZmlsdGVyKGsgPT4gay50cmltKCkpCiAgICAgICAgZm9yIChjb25zdCBrZXlIZXggb2YgcGVlcktleXMpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHBlZXJLZXkgPSBCdWZmZXIuZnJvbShrZXlIZXgudHJpbSgpLCAnaGV4JykKICAgICAgICAgICAgICAgIGNvbnN0IHBlZXJDb3JlID0gc3RvcmUuZ2V0KHsga2V5OiBwZWVyS2V5IH0pCiAgICAgICAgICAgICAgICBhd2FpdCBwZWVyQ29yZS5yZWFkeSgpCiAgICAgICAgICAgICAgICBhd2FpdCBhdXRvYmFzZS5hZGRJbnB1dChwZWVyQ29yZSkKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0FkZGVkIHBlZXIgd3JpdGVyIGZyb20gYXJndlsxXTonLCBrZXlIZXgudHJpbSgpKQogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBhZGQgcGVlciBmcm9tIGFyZ3ZbMV06Jywga2V5SGV4LCBlcnIubWVzc2FnZSkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRBZGRlZFN0YXRpY1BlZXJzKHRydWUpCiAgICB9CiAgICAvLyBSZXNldCBwZWVyIGNvdW50IG9uIG5ldyBiYXNlCiAgICBzZXRQZWVyQ291bnQoMCkKICAgIGJyb2FkY2FzdFBlZXJDb3VudCgpCiAgICAvLyAtLS0gVXBkYXRlIHJlcGxpY2F0aW9uIHN3YXJtIHRvcGljIGZvciB0aGlzIGJhc2UgLS0tCiAgICBjb25zdCBmaXJzdExvY2FsQXV0b2Jhc2VLZXkgPSByYW5kb21CeXRlcygzMikKICAgIGNvbnN0IHRvcGljID0gYXV0b2Jhc2Uua2V5IHx8IGZpcnN0TG9jYWxBdXRvYmFzZUtleQogICAgY29uc29sZS5lcnJvcignRGlzY292ZXJ5IHRvcGljIChyZXBsaWNhdGlvbiBzd2FybSk6JywgdG9waWMudG9TdHJpbmcoJ2hleCcpKQogICAgLy8gU3dpdGNoIGRpc2NvdmVyeSB0byBuZXcgdG9waWMKICAgIGlmIChkaXNjb3ZlcnkpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCBkaXNjb3ZlcnkuZGVzdHJveSgpCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBkZXN0cm95aW5nIHByZXZpb3VzIGRpc2NvdmVyeTonLCBlKQogICAgICAgIH0KICAgIH0KICAgIHNldFN3YXJtKG5ldyBIeXBlcnN3YXJtKCkpCiAgICBzd2FybS5vbignZXJyb3InLCAoZXJyKSA9PiB7CiAgICAgICAgY29uc29sZS5lcnJvcignUmVwbGljYXRpb24gc3dhcm0gZXJyb3I6JywgZXJyKQogICAgfSkKICAgIHN3YXJtLm9uKCdjb25uZWN0aW9uJywgKGNvbm4pID0+IHsKICAgICAgICBjb25zb2xlLmVycm9yKCdOZXcgcGVlciBjb25uZWN0ZWQgKHJlcGxpY2F0aW9uIHN3YXJtKScsIGI0YS5mcm9tKGNvbm4ucHVibGljS2V5KSwgY29ubi5wdWJsaWNLZXkpCiAgICAgICAgY29ubi5vbignZXJyb3InLCAoZXJyKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1JlcGxpY2F0aW9uIGNvbm5lY3Rpb24gZXJyb3I6JywgZXJyKQogICAgICAgIH0pCiAgICAgICAgc2V0UGVlckNvdW50KHBlZXJDb3VudCsxKQogICAgICAgIGJyb2FkY2FzdFBlZXJDb3VudCgpCiAgICAgICAgY29ubi5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgICAgICAgIHNldFBlZXJDb3VudChNYXRoLm1heCgwLCBwZWVyQ291bnQgLSAxKSkKICAgICAgICAgICAgYnJvYWRjYXN0UGVlckNvdW50KCkKICAgICAgICB9KQogICAgICAgIGlmIChhdXRvYmFzZSkgewogICAgICAgICAgICBhdXRvYmFzZS5yZXBsaWNhdGUoY29ubikKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdObyBBdXRvYmFzZSB5ZXQgdG8gcmVwbGljYXRlIHdpdGgnKQogICAgICAgIH0KICAgIH0pCiAgICBzZXREaXNjb3Zlcnkoc3dhcm0uam9pbih0b3BpYywgeyBzZXJ2ZXI6IHRydWUsIGNsaWVudDogdHJ1ZSB9KSkKICAgIGF3YWl0IGRpc2NvdmVyeS5mbHVzaGVkKCkKICAgIGNvbnNvbGUuZXJyb3IoJ0pvaW5lZCByZXBsaWNhdGlvbiBzd2FybSBmb3IgY3VycmVudCBiYXNlJykKICAgIC8vIFJlc3RhcnQgY2hhdCBzd2FybSB3aXRoIG5ldyB0b3BpYwogICAgaWYgKGNoYXRTd2FybSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IGNoYXRTd2FybS5kZXN0cm95KCkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGRlc3Ryb3lpbmcgcHJldmlvdXMgY2hhdCBzd2FybTonLCBlKQogICAgICAgIH0KICAgICAgICBzZXRDaGF0U3dhcm0obnVsbCkKICAgIH0KICAgIHNldHVwQ2hhdFN3YXJtKGJhc2VLZXkgIT0gbnVsbCA/IGJhc2VLZXkgOiBhdXRvYmFzZS5rZXkpCn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBqb2luTmV3QmFzZSAoYmFzZUtleUhleFN0cikgewogICAgaWYgKCFiYXNlS2V5SGV4U3RyIHx8IHR5cGVvZiBiYXNlS2V5SGV4U3RyICE9PSAnc3RyaW5nJykgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ2pvaW5OZXdCYXNlOiBpbnZhbGlkIGJhc2VLZXknLCBiYXNlS2V5SGV4U3RyKQogICAgICAgIHJldHVybgogICAgfQoKICAgIHRyeSB7CiAgICAgICAgY29uc3QgbmV3S2V5ID0gQnVmZmVyLmZyb20oYmFzZUtleUhleFN0ci50cmltKCksICdoZXgnKQogICAgICAgIGlmIChuZXdLZXkubGVuZ3RoICE9PSAzMikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdqb2luTmV3QmFzZTogYmFzZUtleSBtdXN0IGJlIDMyIGJ5dGVzLCBnb3QnLCBuZXdLZXkubGVuZ3RoKQogICAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgY29uc29sZS5lcnJvcignSm9pbmluZyBuZXcgQXV0b2Jhc2Uga2V5IGF0IHJ1bnRpbWU6JywgYmFzZUtleUhleFN0ci50cmltKCkpCiAgICAgICAgYXdhaXQgaW5pdEF1dG9iYXNlKG5ld0tleSkudGhlbigoKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0JhY2tlbmQgcmVhZHknKQogICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignaW5pdEF1dG9iYXNlIGZhaWxlZCBhdCBzdGFydHVwOicsIGVycikKICAgICAgICB9KQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ2pvaW5OZXdCYXNlIGZhaWxlZDonLCBlKQogICAgfQp9CgpmdW5jdGlvbiBicm9hZGNhc3RQZWVyQ291bnQgKCkgewogICAgaWYgKCFycGMpIHJldHVybgogICAgdHJ5IHsKICAgICAgICBjb25zdCByZXEgPSBycGMucmVxdWVzdChSUENfTUVTU0FHRSkKICAgICAgICByZXEuc2VuZChKU09OLnN0cmluZ2lmeSh7IHR5cGU6ICdwZWVyLWNvdW50JywgY291bnQ6IHBlZXJDb3VudCB9KSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gYnJvYWRjYXN0IHBlZXIgY291bnQnLCBlKQogICAgfQp9Cgphc3luYyBmdW5jdGlvbiBlbnN1cmVEZWZhdWx0TGlzdElmRW1wdHkgKCkgewogICAgLy8gTWFrZSBzdXJlIGluZGV4aW5nIGhhcyBydW4gYXQgbGVhc3Qgb25jZQogICAgYXdhaXQgYXV0b2Jhc2UudXBkYXRlKCkKCiAgICBjb25zdCB2aWV3TGVuID0gYXV0b2Jhc2Uudmlldz8ubGVuZ3RoID8/IDAKICAgIGNvbnN0IGxvY2FsTGVuID0gYXV0b2Jhc2UubG9jYWw/Lmxlbmd0aCA/PyAwCgogICAgLy8gRW1wdHkgPSBub3RoaW5nIGluIHRoZSBhcHBsaWVkIG91dHB1dAogICAgY29uc3QgaXNFbXB0eSA9IHZpZXdMZW4gPT09IDAKCiAgICAvLyBPbmx5IHRoZSBob3N0L293bmVyIHNob3VsZCBzZWVkIGRlZmF1bHRzCiAgICBpZiAoIWlzRW1wdHkpIHJldHVybgogICAgaWYgKCFhdXRvYmFzZS53cml0YWJsZSkgcmV0dXJuCgogICAgY29uc29sZS5lcnJvcignQXV0b2Jhc2UgdmlldyBpcyBlbXB0eSwgc2VlZGluZyBERUZBVUxUX0xJU1QuLi4nKQoKICAgIGZvciAoY29uc3QgaXRlbSBvZiBERUZBVUxUX0xJU1QpIHsKICAgICAgICBhd2FpdCBhdXRvYmFzZS5hcHBlbmQoewogICAgICAgICAgICB0eXBlOiAnYWRkJywKICAgICAgICAgICAgdmFsdWU6IHsKICAgICAgICAgICAgICAgIGlkOiBnZW5lcmF0ZUlkKCksCiAgICAgICAgICAgICAgICB0ZXh0OiBpdGVtLnRleHQsCiAgICAgICAgICAgICAgICBpc0RvbmU6IGl0ZW0uaXNEb25lLAogICAgICAgICAgICAgICAgbGlzdElkOiBudWxsLAogICAgICAgICAgICAgICAgdGltZU9mQ29tcGxldGlvbjogaXRlbS50aW1lT2ZDb21wbGV0aW9uLAogICAgICAgICAgICAgICAgdXBkYXRlZEF0OiBEYXRlLm5vdygpLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICB9CiAgICAgICAgfSkKICAgIH0KCiAgICAvLyBBcHBseSB3aGF0IHdlIGp1c3QgYXBwZW5kZWQKICAgIGF3YWl0IGF1dG9iYXNlLnVwZGF0ZSgpCn0vLyBTaGFyZWQgbXV0YWJsZSBzdGF0ZSBleHBvcnRzCi8vIEFsbCBtb2R1bGVzIGltcG9ydCBmcm9tIGhlcmUgYW5kIHVzZSBzZXR0ZXJzIHRvIG1vZGlmeSBzdGF0ZQoKLy8gQ29yZSBQMlAgaW5zdGFuY2VzCmV4cG9ydCBsZXQgYXV0b2Jhc2UgPSBudWxsCmV4cG9ydCBsZXQgc3RvcmUgPSBudWxsCmV4cG9ydCBsZXQgc3dhcm0gPSBudWxsCmV4cG9ydCBsZXQgY2hhdFN3YXJtID0gbnVsbApleHBvcnQgbGV0IGRpc2NvdmVyeSA9IG51bGwKCi8vIFJQQyBpbnN0YW5jZQpleHBvcnQgbGV0IHJwYyA9IG51bGwKCi8vIEtleXMgYW5kIHRvcGljcwpleHBvcnQgbGV0IGJhc2VLZXkgPSBudWxsCmV4cG9ydCBsZXQgY3VycmVudFRvcGljID0gbnVsbApleHBvcnQgbGV0IGNoYXRUb3BpYyA9IG51bGwKCi8vIEluLW1lbW9yeSBkYXRhCmV4cG9ydCBsZXQgY3VycmVudExpc3QgPSBbXQpleHBvcnQgbGV0IHBlZXJDb3VudCA9IDAKCi8vIFdyaXRlciB0cmFja2luZwpleHBvcnQgY29uc3Qga25vd25Xcml0ZXJzID0gbmV3IFNldCgpCmV4cG9ydCBsZXQgYWRkZWRTdGF0aWNQZWVycyA9IGZhbHNlCgovLyBTdGF0ZSBmbGFncwpleHBvcnQgbGV0IGlzUmVzZXR0aW5nU3RhdGUgPSBmYWxzZQoKLy8gVHJhbnNpZW50IGVycm9yIHRyYWNraW5nCmV4cG9ydCBsZXQgdHJhbnNpZW50RXJyb3JDb3VudCA9IDAKZXhwb3J0IGxldCBsYXN0VHJhbnNpZW50RXJyb3JUaW1lID0gMApleHBvcnQgY29uc3QgTUFYX1RSQU5TSUVOVF9FUlJPUlMgPSAxMApleHBvcnQgY29uc3QgREVGQVVMVF9MSVNUID0gWwogICAgeyB0ZXh0OiAnVGFwIHRvIG1hcmsgYXMgZG9uZScsIGlzRG9uZTogZmFsc2UsIHRpbWVPZkNvbXBsZXRpb246IDAgfSwKICAgIHsgdGV4dDogJ0RvdWJsZSB0YXAgdG8gYWRkIG5ldycsIGlzRG9uZTogZmFsc2UsIHRpbWVPZkNvbXBsZXRpb246IDAgfSwKICAgIHsgdGV4dDogJ1NsaWRlIHJpZ2h0IHNsb3dseSB0byBkZWxldGUnLCBpc0RvbmU6IGZhbHNlLCB0aW1lT2ZDb21wbGV0aW9uOiAwIH0sCl0KCgovLyBTZXR0ZXJzIGZvciBtdXRhYmxlIHN0YXRlCmV4cG9ydCBmdW5jdGlvbiBzZXRBdXRvYmFzZSh2YWwpIHsgYXV0b2Jhc2UgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0U3RvcmUodmFsKSB7IHN0b3JlID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldFN3YXJtKHZhbCkgeyBzd2FybSA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRDaGF0U3dhcm0odmFsKSB7IGNoYXRTd2FybSA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXREaXNjb3ZlcnkodmFsKSB7IGRpc2NvdmVyeSA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRScGModmFsKSB7IHJwYyA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRCYXNlS2V5KHZhbCkgeyBiYXNlS2V5ID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldEN1cnJlbnRUb3BpYyh2YWwpIHsgY3VycmVudFRvcGljID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldENoYXRUb3BpYyh2YWwpIHsgY2hhdFRvcGljID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldEN1cnJlbnRMaXN0KHZhbCkgeyBjdXJyZW50TGlzdCA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRQZWVyQ291bnQodmFsKSB7IHBlZXJDb3VudCA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRBZGRlZFN0YXRpY1BlZXJzKHZhbCkgeyBhZGRlZFN0YXRpY1BlZXJzID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldElzUmVzZXR0aW5nU3RhdGUodmFsKSB7IGlzUmVzZXR0aW5nU3RhdGUgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0VHJhbnNpZW50RXJyb3JDb3VudCh2YWwpIHsgdHJhbnNpZW50RXJyb3JDb3VudCA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRMYXN0VHJhbnNpZW50RXJyb3JUaW1lKHZhbCkgeyBsYXN0VHJhbnNpZW50RXJyb3JUaW1lID0gdmFsIH0KCi8vIEhlbHBlciB0byBjbGVhciBrbm93biB3cml0ZXJzCmV4cG9ydCBmdW5jdGlvbiBjbGVhcktub3duV3JpdGVycygpIHsga25vd25Xcml0ZXJzLmNsZWFyKCkgfQovLyBHZW5lcmF0ZSB1bmlxdWUgSUQgKHVzZWQgb25seSBmb3IgYWRkSXRlbSkKaW1wb3J0IHtyYW5kb21CeXRlc30gZnJvbSAiYmFyZS1jcnlwdG8iOwoKZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlSWQgKCkgewogICAgcmV0dXJuIHJhbmRvbUJ5dGVzKDE2KS50b1N0cmluZygnaGV4JykKfWNvbnN0IHsgUHVsbCwgUHVzaCwgSEVBREVSQllURVMsIEtFWUJZVEVTLCBBQllURVMgfSA9IHJlcXVpcmUoJ3NvZGl1bS1zZWNyZXRzdHJlYW0nKQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IHsgRHVwbGV4LCBXcml0YWJsZSwgZ2V0U3RyZWFtRXJyb3IgfSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBUaW1lb3V0ID0gcmVxdWlyZSgndGltZW91dC1yZWZyZXNoJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKY29uc3QgQnJpZGdlID0gcmVxdWlyZSgnLi9saWIvYnJpZGdlJykKY29uc3QgSGFuZHNoYWtlID0gcmVxdWlyZSgnLi9saWIvaGFuZHNoYWtlJykKCmNvbnN0IElESEVBREVSQllURVMgPSBIRUFERVJCWVRFUyArIDMyCmNvbnN0IFtOU19JTklUSUFUT1IsIE5TX1JFU1BPTkRFUiwgTlNfU0VORF0gPSBjcnlwdG8ubmFtZXNwYWNlKCdoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0nLCAzKQpjb25zdCBNQVhfQVRPTUlDX1dSSVRFID0gMjU2ICogMjU2ICogMjU2IC0gMQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBOb2lzZVNlY3JldFN0cmVhbSBleHRlbmRzIER1cGxleCB7CiAgY29uc3RydWN0b3IoaXNJbml0aWF0b3IsIHJhd1N0cmVhbSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcih7IG1hcFdyaXRhYmxlOiB0b0J1ZmZlciB9KQoKICAgIGlmICh0eXBlb2YgaXNJbml0aWF0b3IgIT09ICdib29sZWFuJykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2lzSW5pdGlhdG9yIHNob3VsZCBiZSBhIGJvb2xlYW4nKQogICAgfQoKICAgIHRoaXMubm9pc2VTdHJlYW0gPSB0aGlzCiAgICB0aGlzLmlzSW5pdGlhdG9yID0gaXNJbml0aWF0b3IKICAgIHRoaXMucmF3U3RyZWFtID0gbnVsbAoKICAgIHRoaXMucHVibGljS2V5ID0gb3B0cy5wdWJsaWNLZXkgfHwgbnVsbAogICAgdGhpcy5yZW1vdGVQdWJsaWNLZXkgPSBvcHRzLnJlbW90ZVB1YmxpY0tleSB8fCBudWxsCiAgICB0aGlzLmhhbmRzaGFrZUhhc2ggPSBudWxsCiAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlCiAgICB0aGlzLmtlZXBBbGl2ZSA9IG9wdHMua2VlcEFsaXZlIHx8IDAKICAgIHRoaXMudGltZW91dCA9IDAKICAgIHRoaXMuZW5hYmxlU2VuZCA9IG9wdHMuZW5hYmxlU2VuZCAhPT0gZmFsc2UKCiAgICAvLyBwb2ludGVyIGZvciB1cHN0cmVhbSB0byBzZXQgZGF0YSBoZXJlIGlmIHRoZXkgd2FudAogICAgdGhpcy51c2VyRGF0YSA9IG51bGwKCiAgICBsZXQgb3BlbmVkRG9uZSA9IG51bGwKICAgIHRoaXMub3BlbmVkID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgb3BlbmVkRG9uZSA9IHJlc29sdmUKICAgIH0pCgogICAgdGhpcy5yYXdCeXRlc1dyaXR0ZW4gPSAwCiAgICB0aGlzLnJhd0J5dGVzUmVhZCA9IDAKCiAgICAvLyBtZXRhZGF0YSB1c2VkIGJ5ICdoeXBlcmRodCcKICAgIHRoaXMucmVsYXkgPSBudWxsCiAgICB0aGlzLnB1bmNoZXIgPSBudWxsCgogICAgLy8gdW53cmFwcGVkIHJhdyBzdHJlYW0KICAgIHRoaXMuX3Jhd1N0cmVhbSA9IG51bGwKCiAgICAvLyBoYW5kc2hha2Ugc3RhdGUKICAgIHRoaXMuX2hhbmRzaGFrZSA9IG51bGwKICAgIHRoaXMuX2hhbmRzaGFrZVBhdHRlcm4gPSBvcHRzLnBhdHRlcm4gfHwgbnVsbAogICAgdGhpcy5faGFuZHNoYWtlRG9uZSA9IG51bGwKCiAgICAvLyBtZXNzYWdlIHBhcnNpbmcgc3RhdGUKICAgIHRoaXMuX3N0YXRlID0gMAogICAgdGhpcy5fbGVuID0gMAogICAgdGhpcy5fdG1wID0gMQogICAgdGhpcy5fbWVzc2FnZSA9IG51bGwKCiAgICB0aGlzLl9vcGVuZWREb25lID0gb3BlbmVkRG9uZQogICAgdGhpcy5fc3RhcnREb25lID0gbnVsbAogICAgdGhpcy5fZHJhaW5Eb25lID0gbnVsbAogICAgdGhpcy5fb3V0Z29pbmdQbGFpbiA9IG51bGwKICAgIHRoaXMuX291dGdvaW5nV3JhcHBlZCA9IG51bGwKICAgIHRoaXMuX3V0cCA9IG51bGwKICAgIHRoaXMuX3NldHVwID0gdHJ1ZQogICAgdGhpcy5fZW5kZWQgPSAyCiAgICB0aGlzLl9lbmNyeXB0ID0gbnVsbAogICAgdGhpcy5fZGVjcnlwdCA9IG51bGwKICAgIHRoaXMuX3RpbWVvdXRUaW1lciA9IG51bGwKICAgIHRoaXMuX2tlZXBBbGl2ZVRpbWVyID0gbnVsbAogICAgdGhpcy5fc2VuZFN0YXRlID0gbnVsbAoKICAgIGlmIChvcHRzLmF1dG9TdGFydCAhPT0gZmFsc2UpIHRoaXMuc3RhcnQocmF3U3RyZWFtLCBvcHRzKQoKICAgIC8vIHdpZ2dsZSBpdCB0byB0cmlnZ2VyIG9wZW4gaW1tZWRpYXRlbHkgKFRPRE8gYWRkIHN0cmVhbXggb3B0aW9uIGZvciB0aGlzKQogICAgdGhpcy5yZXN1bWUoKQogICAgdGhpcy5wYXVzZSgpCiAgfQoKICBzdGF0aWMga2V5UGFpcihzZWVkKSB7CiAgICByZXR1cm4gSGFuZHNoYWtlLmtleVBhaXIoc2VlZCkKICB9CgogIHN0YXRpYyBpZChoYW5kc2hha2VIYXNoLCBpc0luaXRpYXRvciwgaWQpIHsKICAgIHJldHVybiBzdHJlYW1JZChoYW5kc2hha2VIYXNoLCBpc0luaXRpYXRvciwgaWQpCiAgfQoKICBzZXRUaW1lb3V0KG1zKSB7CiAgICBpZiAoIW1zKSBtcyA9IDAKCiAgICB0aGlzLl9jbGVhclRpbWVvdXQoKQogICAgdGhpcy50aW1lb3V0ID0gbXMKCiAgICBpZiAoIW1zIHx8IHRoaXMucmF3U3RyZWFtID09PSBudWxsKSByZXR1cm4KCiAgICB0aGlzLl90aW1lb3V0VGltZXIgPSBUaW1lb3V0Lm9uY2UobXMsIGRlc3Ryb3lUaW1lb3V0LCB0aGlzKQogICAgdGhpcy5fdGltZW91dFRpbWVyLnVucmVmKCkKICB9CgogIHNldEtlZXBBbGl2ZShtcykgewogICAgaWYgKCFtcykgbXMgPSAwCgogICAgdGhpcy5fY2xlYXJLZWVwQWxpdmUoKQoKICAgIHRoaXMua2VlcEFsaXZlID0gbXMKCiAgICBpZiAoIW1zIHx8IHRoaXMucmF3U3RyZWFtID09PSBudWxsKSByZXR1cm4KCiAgICB0aGlzLl9rZWVwQWxpdmVUaW1lciA9IFRpbWVvdXQub24obXMsIHNlbmRLZWVwQWxpdmUsIHRoaXMpCiAgICB0aGlzLl9rZWVwQWxpdmVUaW1lci51bnJlZigpCiAgfQoKICBzZW5kS2VlcEFsaXZlKCkgewogICAgY29uc3QgZW1wdHkgPSB0aGlzLmFsbG9jKDApCiAgICB0aGlzLndyaXRlKGVtcHR5KQogIH0KCiAgc3RhcnQocmF3U3RyZWFtLCBvcHRzID0ge30pIHsKICAgIGlmIChyYXdTdHJlYW0pIHsKICAgICAgdGhpcy5yYXdTdHJlYW0gPSByYXdTdHJlYW0KICAgICAgdGhpcy5fcmF3U3RyZWFtID0gcmF3U3RyZWFtCiAgICAgIGlmICh0eXBlb2YgdGhpcy5yYXdTdHJlYW0uc2V0Q29udGVudFNpemUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aGlzLl91dHAgPSByYXdTdHJlYW0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5yYXdTdHJlYW0gPSBuZXcgQnJpZGdlKHRoaXMpCiAgICAgIHRoaXMuX3Jhd1N0cmVhbSA9IHRoaXMucmF3U3RyZWFtLnJldmVyc2UKICAgIH0KCiAgICB0aGlzLnJhd1N0cmVhbS5vbignZXJyb3InLCB0aGlzLl9vbnJhd2Vycm9yLmJpbmQodGhpcykpCiAgICB0aGlzLnJhd1N0cmVhbS5vbignY2xvc2UnLCB0aGlzLl9vbnJhd2Nsb3NlLmJpbmQodGhpcykpCgogICAgdGhpcy5fc3RhcnRIYW5kc2hha2Uob3B0cy5oYW5kc2hha2UsIG9wdHMua2V5UGFpciB8fCBudWxsKQogICAgdGhpcy5fY29udGludWVPcGVuKG51bGwpCgogICAgaWYgKHRoaXMuZGVzdHJveWluZykgcmV0dXJuCgogICAgaWYgKG9wdHMuZGF0YSkgdGhpcy5fb25yYXdkYXRhKG9wdHMuZGF0YSkKICAgIGlmIChvcHRzLmVuZGVkKSB0aGlzLl9vbnJhd2VuZCgpCgogICAgaWYgKHRoaXMua2VlcEFsaXZlID4gMCAmJiB0aGlzLl9rZWVwQWxpdmVUaW1lciA9PT0gbnVsbCkgewogICAgICB0aGlzLnNldEtlZXBBbGl2ZSh0aGlzLmtlZXBBbGl2ZSkKICAgIH0KCiAgICBpZiAodGhpcy50aW1lb3V0ID4gMCAmJiB0aGlzLl90aW1lb3V0VGltZXIgPT09IG51bGwpIHsKICAgICAgdGhpcy5zZXRUaW1lb3V0KHRoaXMudGltZW91dCkKICAgIH0KICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgaWYgKChhd2FpdCB0aGlzLm9wZW5lZCkgPT09IGZhbHNlKSByZXR1cm4gZmFsc2UKICAgIGlmICgoYXdhaXQgV3JpdGFibGUuZHJhaW5lZCh0aGlzKSkgPT09IGZhbHNlKSByZXR1cm4gZmFsc2UKICAgIGlmICh0aGlzLmRlc3Ryb3lpbmcpIHJldHVybiBmYWxzZQoKICAgIGlmICh0aGlzLnJhd1N0cmVhbSAhPT0gbnVsbCAmJiB0aGlzLnJhd1N0cmVhbS5mbHVzaCkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5yYXdTdHJlYW0uZmx1c2goKQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfY29udGludWVPcGVuKGVycikgewogICAgaWYgKGVycikgdGhpcy5kZXN0cm95KGVycikKICAgIGlmICh0aGlzLl9zdGFydERvbmUgPT09IG51bGwpIHJldHVybgogICAgY29uc3QgZG9uZSA9IHRoaXMuX3N0YXJ0RG9uZQogICAgdGhpcy5fc3RhcnREb25lID0gbnVsbAogICAgdGhpcy5fb3Blbihkb25lKQogIH0KCiAgX29ua2V5cGFpcnByb21pc2UocCkgewogICAgY29uc3Qgc2VsZiA9IHRoaXMKICAgIGNvbnN0IGNvbnQgPSB0aGlzLl9jb250aW51ZU9wZW4uYmluZCh0aGlzKQoKICAgIHAudGhlbihvbmtleXBhaXIsIGNvbnQpCgogICAgZnVuY3Rpb24gb25rZXlwYWlyKGtwKSB7CiAgICAgIHNlbGYuX29ua2V5cGFpcihrcCkKICAgICAgY29udChudWxsKQogICAgfQogIH0KCiAgX29ua2V5cGFpcihrZXlQYWlyKSB7CiAgICBjb25zdCBwYXR0ZXJuID0gdGhpcy5faGFuZHNoYWtlUGF0dGVybiB8fCAnWFgnCiAgICBjb25zdCByZW1vdGVQdWJsaWNLZXkgPSB0aGlzLnJlbW90ZVB1YmxpY0tleQoKICAgIHRoaXMuX2hhbmRzaGFrZSA9IG5ldyBIYW5kc2hha2UodGhpcy5pc0luaXRpYXRvciwga2V5UGFpciwgcmVtb3RlUHVibGljS2V5LCBwYXR0ZXJuKQogICAgdGhpcy5wdWJsaWNLZXkgPSB0aGlzLl9oYW5kc2hha2Uua2V5UGFpci5wdWJsaWNLZXkKICB9CgogIF9zdGFydEhhbmRzaGFrZShoYW5kc2hha2UsIGtleVBhaXIpIHsKICAgIGlmIChoYW5kc2hha2UpIHsKICAgICAgY29uc3QgeyB0eCwgcngsIGhhc2gsIHB1YmxpY0tleSwgcmVtb3RlUHVibGljS2V5IH0gPSBoYW5kc2hha2UKICAgICAgdGhpcy5fc2V0dXBTZWNyZXRTdHJlYW0odHgsIHJ4LCBoYXNoLCBwdWJsaWNLZXksIHJlbW90ZVB1YmxpY0tleSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKCFrZXlQYWlyKSBrZXlQYWlyID0gSGFuZHNoYWtlLmtleVBhaXIoKQoKICAgIGlmICh0eXBlb2Yga2V5UGFpci50aGVuID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRoaXMuX29ua2V5cGFpcnByb21pc2Uoa2V5UGFpcikKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX29ua2V5cGFpcihrZXlQYWlyKQogICAgfQogIH0KCiAgX29ucmF3ZXJyb3IoZXJyKSB7CiAgICB0aGlzLmRlc3Ryb3koZXJyKQogIH0KCiAgX29ucmF3Y2xvc2UoKSB7CiAgICBpZiAodGhpcy5fZW5kZWQgIT09IDApIHRoaXMuZGVzdHJveSgpCiAgfQoKICBfb25yYXdkYXRhKGRhdGEpIHsKICAgIGxldCBvZmZzZXQgPSAwCgogICAgaWYgKHRoaXMuX3RpbWVvdXRUaW1lciAhPT0gbnVsbCkgewogICAgICB0aGlzLl90aW1lb3V0VGltZXIucmVmcmVzaCgpCiAgICB9CgogICAgZG8gewogICAgICBzd2l0Y2ggKHRoaXMuX3N0YXRlKSB7CiAgICAgICAgY2FzZSAwOiB7CiAgICAgICAgICB3aGlsZSAodGhpcy5fdG1wICE9PSAweDEwMDAwMDAgJiYgb2Zmc2V0IDwgZGF0YS5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgIGNvbnN0IHYgPSBkYXRhW29mZnNldCsrXQogICAgICAgICAgICB0aGlzLl9sZW4gKz0gdGhpcy5fdG1wICogdgogICAgICAgICAgICB0aGlzLl90bXAgKj0gMjU2CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHRoaXMuX3RtcCA9PT0gMHgxMDAwMDAwKSB7CiAgICAgICAgICAgIHRoaXMuX3RtcCA9IDAKICAgICAgICAgICAgdGhpcy5fc3RhdGUgPSAxCiAgICAgICAgICAgIGNvbnN0IHVucHJvY2Vzc2VkID0gZGF0YS5ieXRlTGVuZ3RoIC0gb2Zmc2V0CiAgICAgICAgICAgIGlmICh1bnByb2Nlc3NlZCA8IHRoaXMuX2xlbiAmJiB0aGlzLl91dHAgIT09IG51bGwpCiAgICAgICAgICAgICAgdGhpcy5fdXRwLnNldENvbnRlbnRTaXplKHRoaXMuX2xlbiAtIHVucHJvY2Vzc2VkKQogICAgICAgICAgfQoKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQoKICAgICAgICBjYXNlIDE6IHsKICAgICAgICAgIGNvbnN0IG1pc3NpbmcgPSB0aGlzLl9sZW4gLSB0aGlzLl90bXAKICAgICAgICAgIGNvbnN0IGVuZCA9IG1pc3NpbmcgKyBvZmZzZXQKCiAgICAgICAgICBpZiAodGhpcy5fbWVzc2FnZSA9PT0gbnVsbCAmJiBlbmQgPD0gZGF0YS5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgIHRoaXMuX21lc3NhZ2UgPSBkYXRhLnN1YmFycmF5KG9mZnNldCwgZW5kKQogICAgICAgICAgICBvZmZzZXQgKz0gbWlzc2luZwogICAgICAgICAgICB0aGlzLl9pbmNvbWluZygpCiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICB9CgogICAgICAgICAgY29uc3QgdW5wcm9jZXNzZWQgPSBkYXRhLmJ5dGVMZW5ndGggLSBvZmZzZXQKCiAgICAgICAgICBpZiAodGhpcy5fbWVzc2FnZSA9PT0gbnVsbCkgewogICAgICAgICAgICB0aGlzLl9tZXNzYWdlID0gYjRhLmFsbG9jVW5zYWZlKHRoaXMuX2xlbikKICAgICAgICAgIH0KCiAgICAgICAgICBiNGEuY29weShkYXRhLCB0aGlzLl9tZXNzYWdlLCB0aGlzLl90bXAsIG9mZnNldCkKICAgICAgICAgIHRoaXMuX3RtcCArPSB1bnByb2Nlc3NlZAoKICAgICAgICAgIGlmIChlbmQgPD0gZGF0YS5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgIG9mZnNldCArPSBtaXNzaW5nCiAgICAgICAgICAgIHRoaXMuX2luY29taW5nKCkKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9mZnNldCArPSB1bnByb2Nlc3NlZAogICAgICAgICAgfQoKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CiAgICB9IHdoaWxlIChvZmZzZXQgPCBkYXRhLmJ5dGVMZW5ndGggJiYgIXRoaXMuZGVzdHJveWluZykKICB9CgogIF9vbnJhd2VuZCgpIHsKICAgIHRoaXMuX2VuZGVkLS0KICAgIHRoaXMucHVzaChudWxsKQogIH0KCiAgX29ucmF3ZHJhaW4oKSB7CiAgICBjb25zdCBkcmFpbiA9IHRoaXMuX2RyYWluRG9uZQogICAgaWYgKGRyYWluID09PSBudWxsKSByZXR1cm4KICAgIHRoaXMuX2RyYWluRG9uZSA9IG51bGwKICAgIGRyYWluKCkKICB9CgogIF9yZWFkKGNiKSB7CiAgICB0aGlzLnJhd1N0cmVhbS5yZXN1bWUoKQogICAgY2IobnVsbCkKICB9CgogIF9pbmNvbWluZygpIHsKICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLl9tZXNzYWdlCgogICAgdGhpcy5fc3RhdGUgPSAwCiAgICB0aGlzLl9sZW4gPSAwCiAgICB0aGlzLl90bXAgPSAxCiAgICB0aGlzLl9tZXNzYWdlID0gbnVsbAoKICAgIGlmICh0aGlzLl9zZXR1cCA9PT0gdHJ1ZSkgewogICAgICBpZiAodGhpcy5faGFuZHNoYWtlKSB7CiAgICAgICAgdGhpcy5fb25oYW5kc2hha2VydCh0aGlzLl9oYW5kc2hha2UucmVjdihtZXNzYWdlKSkKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAobWVzc2FnZS5ieXRlTGVuZ3RoICE9PSBJREhFQURFUkJZVEVTKSB7CiAgICAgICAgICB0aGlzLmRlc3Ryb3kobmV3IEVycm9yKCdJbnZhbGlkIGhlYWRlciBtZXNzYWdlIHJlY2VpdmVkJykpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIGNvbnN0IHJlbW90ZUlkID0gbWVzc2FnZS5zdWJhcnJheSgwLCAzMikKICAgICAgICBjb25zdCBleHBlY3RlZElkID0gc3RyZWFtSWQodGhpcy5oYW5kc2hha2VIYXNoLCAhdGhpcy5pc0luaXRpYXRvcikKICAgICAgICBjb25zdCBoZWFkZXIgPSBtZXNzYWdlLnN1YmFycmF5KDMyKQoKICAgICAgICBpZiAoIWI0YS5lcXVhbHMoZXhwZWN0ZWRJZCwgcmVtb3RlSWQpKSB7CiAgICAgICAgICB0aGlzLmRlc3Ryb3kobmV3IEVycm9yKCdJbnZhbGlkIGhlYWRlciByZWNlaXZlZCcpKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQoKICAgICAgICB0aGlzLl9kZWNyeXB0LmluaXQoaGVhZGVyKQogICAgICAgIHRoaXMuX3NldHVwID0gZmFsc2UgLy8gc2V0dXAgaXMgbm93IGRvbmUKICAgICAgfQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAobWVzc2FnZS5ieXRlTGVuZ3RoIDwgQUJZVEVTKSB7CiAgICAgIHRoaXMuZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgbWVzc2FnZSByZWNlaXZlZCcpKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLnJhd0J5dGVzUmVhZCArPSBtZXNzYWdlLmJ5dGVMZW5ndGgKCiAgICBjb25zdCBwbGFpbiA9IG1lc3NhZ2Uuc3ViYXJyYXkoMSwgbWVzc2FnZS5ieXRlTGVuZ3RoIC0gQUJZVEVTICsgMSkKCiAgICB0cnkgewogICAgICB0aGlzLl9kZWNyeXB0Lm5leHQobWVzc2FnZSwgcGxhaW4pCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5kZXN0cm95KGVycikKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gSWYga2VlcCBhbGl2ZSBpcyBzZWxlY3RpdmUsIGVhdCB0aGUgZW1wdHkgYnVmZmVycyAoaWUgYXNzdW1lIHRoZSBvdGhlciBzaWRlIGhhcyBpdCBlbmFibGVkIGFsc28pCiAgICBpZiAocGxhaW4uYnl0ZUxlbmd0aCA9PT0gMCAmJiB0aGlzLmtlZXBBbGl2ZSAhPT0gMCkgcmV0dXJuCgogICAgaWYgKHRoaXMucHVzaChwbGFpbikgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMucmF3U3RyZWFtLnBhdXNlKCkKICAgIH0KICB9CgogIF9vbmhhbmRzaGFrZXJ0KGgpIHsKICAgIGlmICh0aGlzLl9oYW5kc2hha2VEb25lID09PSBudWxsKSByZXR1cm4KCiAgICBpZiAoaCAhPT0gbnVsbCkgewogICAgICBpZiAoaC5kYXRhKSB0aGlzLl9yYXdTdHJlYW0ud3JpdGUoaC5kYXRhKQogICAgICBpZiAoIWgudHgpIHJldHVybgogICAgfQoKICAgIGNvbnN0IGRvbmUgPSB0aGlzLl9oYW5kc2hha2VEb25lCiAgICBjb25zdCBwdWJsaWNLZXkgPSB0aGlzLl9oYW5kc2hha2Uua2V5UGFpci5wdWJsaWNLZXkKCiAgICB0aGlzLl9oYW5kc2hha2VEb25lID0gbnVsbAogICAgdGhpcy5faGFuZHNoYWtlID0gbnVsbAoKICAgIGlmIChoID09PSBudWxsKSByZXR1cm4gZG9uZShuZXcgRXJyb3IoJ05vaXNlIGhhbmRzaGFrZSBmYWlsZWQnKSkKCiAgICB0aGlzLl9zZXR1cFNlY3JldFN0cmVhbShoLnR4LCBoLnJ4LCBoLmhhc2gsIHB1YmxpY0tleSwgaC5yZW1vdGVQdWJsaWNLZXkpCiAgICB0aGlzLl9yZXNvbHZlT3BlbmVkKHRydWUpCiAgICBkb25lKG51bGwpCiAgfQoKICBfc2V0dXBTZWNyZXRTdHJlYW0odHgsIHJ4LCBoYW5kc2hha2VIYXNoLCBwdWJsaWNLZXksIHJlbW90ZVB1YmxpY0tleSkgewogICAgY29uc3QgYnVmID0gYjRhLmFsbG9jVW5zYWZlU2xvdygzICsgSURIRUFERVJCWVRFUykKICAgIHdyaXRlVWludDI0bGUoSURIRUFERVJCWVRFUywgYnVmKQoKICAgIHRoaXMuX2VuY3J5cHQgPSBuZXcgUHVzaCh1bnNsYWIodHguc3ViYXJyYXkoMCwgS0VZQllURVMpKSwgdW5kZWZpbmVkLCBidWYuc3ViYXJyYXkoMyArIDMyKSkKICAgIHRoaXMuX2RlY3J5cHQgPSBuZXcgUHVsbCh1bnNsYWIocnguc3ViYXJyYXkoMCwgS0VZQllURVMpKSkKCiAgICB0aGlzLnB1YmxpY0tleSA9IHB1YmxpY0tleQogICAgdGhpcy5yZW1vdGVQdWJsaWNLZXkgPSByZW1vdGVQdWJsaWNLZXkKICAgIHRoaXMuaGFuZHNoYWtlSGFzaCA9IGhhbmRzaGFrZUhhc2gKCiAgICBjb25zdCBpZCA9IGJ1Zi5zdWJhcnJheSgzLCAzICsgMzIpCiAgICBzdHJlYW1JZChoYW5kc2hha2VIYXNoLCB0aGlzLmlzSW5pdGlhdG9yLCBpZCkKCiAgICAvLyBpbml0aWFsaXplIHNlY3JldGJveCBzdGF0ZSBmb3IgdW5vcmRlcmVkIG1lc3NhZ2VzCiAgICB0aGlzLl9zZXR1cFNlY3JldFNlbmQoaGFuZHNoYWtlSGFzaCkKCiAgICB0aGlzLmVtaXQoJ2hhbmRzaGFrZScpCiAgICAvLyBpZiByYXdTdHJlYW0gaXMgYSBicmlkZ2UsIGFsc28gZW1pdCBpdCB0aGVyZQogICAgaWYgKHRoaXMucmF3U3RyZWFtICE9PSB0aGlzLl9yYXdTdHJlYW0pIHRoaXMucmF3U3RyZWFtLmVtaXQoJ2hhbmRzaGFrZScpCgogICAgaWYgKHRoaXMuZGVzdHJveWluZykgcmV0dXJuCgogICAgdGhpcy5fcmF3U3RyZWFtLndyaXRlKGJ1ZikKICB9CgogIF9zZXR1cFNlY3JldFNlbmQoaGFuZHNoYWtlSGFzaCkgewogICAgdGhpcy5fc2VuZFN0YXRlID0gYjRhLmFsbG9jVW5zYWZlU2xvdygzMiArIDMyICsgOCArIDgpCiAgICBjb25zdCBlbmNyeXB0ID0gdGhpcy5fc2VuZFN0YXRlLnN1YmFycmF5KDAsIDMyKSAvLyBzZWNyZXRzCiAgICBjb25zdCBkZWNyeXB0ID0gdGhpcy5fc2VuZFN0YXRlLnN1YmFycmF5KDMyLCA2NCkKICAgIGNvbnN0IGNvdW50ZXIgPSB0aGlzLl9zZW5kU3RhdGUuc3ViYXJyYXkoNjQsIDcyKSAvLyBub25jZQogICAgY29uc3QgaW5pdGlhbCA9IHRoaXMuX3NlbmRTdGF0ZS5zdWJhcnJheSg3MikKCiAgICBjb25zdCBpbnB1dHMgPSB0aGlzLmlzSW5pdGlhdG9yCiAgICAgID8gWwogICAgICAgICAgW05TX0lOSVRJQVRPUiwgTlNfU0VORF0sCiAgICAgICAgICBbTlNfUkVTUE9OREVSLCBOU19TRU5EXQogICAgICAgIF0KICAgICAgOiBbCiAgICAgICAgICBbTlNfUkVTUE9OREVSLCBOU19TRU5EXSwKICAgICAgICAgIFtOU19JTklUSUFUT1IsIE5TX1NFTkRdCiAgICAgICAgXQoKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2goZW5jcnlwdCwgaW5wdXRzWzBdLCBoYW5kc2hha2VIYXNoKQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChkZWNyeXB0LCBpbnB1dHNbMV0sIGhhbmRzaGFrZUhhc2gpCgogICAgc29kaXVtLnJhbmRvbWJ5dGVzX2J1Zihpbml0aWFsKQogICAgY291bnRlci5zZXQoaW5pdGlhbCkKICB9CgogIF9vcGVuKGNiKSB7CiAgICAvLyBubyBhdXRvc3RhcnQgb3Igbm8gaGFuZHNoYWtlIHlldAogICAgaWYgKHRoaXMuX3Jhd1N0cmVhbSA9PT0gbnVsbCB8fCAodGhpcy5faGFuZHNoYWtlID09PSBudWxsICYmIHRoaXMuX2VuY3J5cHQgPT09IG51bGwpKSB7CiAgICAgIHRoaXMuX3N0YXJ0RG9uZSA9IGNiCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuX3Jhd1N0cmVhbS5vbignZGF0YScsIHRoaXMuX29ucmF3ZGF0YS5iaW5kKHRoaXMpKQogICAgdGhpcy5fcmF3U3RyZWFtLm9uKCdlbmQnLCB0aGlzLl9vbnJhd2VuZC5iaW5kKHRoaXMpKQogICAgdGhpcy5fcmF3U3RyZWFtLm9uKCdkcmFpbicsIHRoaXMuX29ucmF3ZHJhaW4uYmluZCh0aGlzKSkKCiAgICBpZiAodGhpcy5lbmFibGVTZW5kKSB0aGlzLl9yYXdTdHJlYW0ub24oJ21lc3NhZ2UnLCB0aGlzLl9vbm1lc3NhZ2UuYmluZCh0aGlzKSkKCiAgICBpZiAodGhpcy5fZW5jcnlwdCAhPT0gbnVsbCkgewogICAgICB0aGlzLl9yZXNvbHZlT3BlbmVkKHRydWUpCiAgICAgIHJldHVybiBjYihudWxsKQogICAgfQoKICAgIHRoaXMuX2hhbmRzaGFrZURvbmUgPSBjYgoKICAgIGlmICh0aGlzLmlzSW5pdGlhdG9yKSB0aGlzLl9vbmhhbmRzaGFrZXJ0KHRoaXMuX2hhbmRzaGFrZS5zZW5kKCkpCiAgfQoKICBfcHJlZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLnJhd1N0cmVhbSkgewogICAgICBjb25zdCBlcnJvciA9IGdldFN0cmVhbUVycm9yKHRoaXMpCiAgICAgIHRoaXMucmF3U3RyZWFtLmRlc3Ryb3koZXJyb3IpCiAgICB9CgogICAgaWYgKHRoaXMuX3N0YXJ0RG9uZSAhPT0gbnVsbCkgewogICAgICBjb25zdCBkb25lID0gdGhpcy5fc3RhcnREb25lCiAgICAgIHRoaXMuX3N0YXJ0RG9uZSA9IG51bGwKICAgICAgZG9uZShuZXcgRXJyb3IoJ1N0cmVhbSBkZXN0cm95ZWQnKSkKICAgIH0KCiAgICBpZiAodGhpcy5faGFuZHNoYWtlRG9uZSAhPT0gbnVsbCkgewogICAgICBjb25zdCBkb25lID0gdGhpcy5faGFuZHNoYWtlRG9uZQogICAgICB0aGlzLl9oYW5kc2hha2VEb25lID0gbnVsbAogICAgICBkb25lKG5ldyBFcnJvcignU3RyZWFtIGRlc3Ryb3llZCcpKQogICAgfQoKICAgIGlmICh0aGlzLl9kcmFpbkRvbmUgIT09IG51bGwpIHsKICAgICAgY29uc3QgZG9uZSA9IHRoaXMuX2RyYWluRG9uZQogICAgICB0aGlzLl9kcmFpbkRvbmUgPSBudWxsCiAgICAgIGRvbmUobmV3IEVycm9yKCdTdHJlYW0gZGVzdHJveWVkJykpCiAgICB9CiAgfQoKICBfd3JpdGUoZGF0YSwgY2IpIHsKICAgIGxldCB3cmFwcGVkID0gdGhpcy5fb3V0Z29pbmdXcmFwcGVkCgogICAgaWYgKGRhdGEgIT09IHRoaXMuX291dGdvaW5nUGxhaW4pIHsKICAgICAgd3JhcHBlZCA9IGI0YS5hbGxvY1Vuc2FmZShkYXRhLmJ5dGVMZW5ndGggKyAzICsgQUJZVEVTKQogICAgICB3cmFwcGVkLnNldChkYXRhLCA0KQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fb3V0Z29pbmdXcmFwcGVkID0gdGhpcy5fb3V0Z29pbmdQbGFpbiA9IG51bGwKICAgIH0KCiAgICBpZiAod3JhcHBlZC5ieXRlTGVuZ3RoIC0gMyA+IE1BWF9BVE9NSUNfV1JJVEUpIHsKICAgICAgcmV0dXJuIGNiKAogICAgICAgIG5ldyBFcnJvcigKICAgICAgICAgICdNZXNzYWdlIGlzIHRvbyBsYXJnZSBmb3IgYW4gYXRvbWljIHdyaXRlLiBNYXggc2l6ZSBpcyAnICsgTUFYX0FUT01JQ19XUklURSArICcgYnl0ZXMuJwogICAgICAgICkKICAgICAgKQogICAgfQogICAgdGhpcy5yYXdCeXRlc1dyaXR0ZW4gKz0gd3JhcHBlZC5ieXRlTGVuZ3RoCgogICAgd3JpdGVVaW50MjRsZSh3cmFwcGVkLmJ5dGVMZW5ndGggLSAzLCB3cmFwcGVkKQogICAgLy8gb2Zmc2V0IDQgc28gd2UgY2FuIGRvIGl0IGluLXBsYWNlCiAgICB0aGlzLl9lbmNyeXB0Lm5leHQod3JhcHBlZC5zdWJhcnJheSg0LCA0ICsgZGF0YS5ieXRlTGVuZ3RoKSwgd3JhcHBlZC5zdWJhcnJheSgzKSkKCiAgICBpZiAodGhpcy5fa2VlcEFsaXZlVGltZXIgIT09IG51bGwpIHRoaXMuX2tlZXBBbGl2ZVRpbWVyLnJlZnJlc2goKQoKICAgIGlmICh0aGlzLl9yYXdTdHJlYW0ud3JpdGUod3JhcHBlZCkgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMuX2RyYWluRG9uZSA9IGNiCiAgICB9IGVsc2UgewogICAgICBjYihudWxsKQogICAgfQogIH0KCiAgX2ZpbmFsKGNiKSB7CiAgICB0aGlzLl9jbGVhcktlZXBBbGl2ZSgpCiAgICB0aGlzLl9lbmRlZC0tCiAgICB0aGlzLl9yYXdTdHJlYW0uZW5kKCkKICAgIGNiKG51bGwpCiAgfQoKICBfcmVzb2x2ZU9wZW5lZCh2YWwpIHsKICAgIGlmICh0aGlzLl9vcGVuZWREb25lID09PSBudWxsKSByZXR1cm4KICAgIGNvbnN0IG9wZW5lZCA9IHRoaXMuX29wZW5lZERvbmUKICAgIHRoaXMuX29wZW5lZERvbmUgPSBudWxsCiAgICBvcGVuZWQodmFsKQogICAgaWYgKCF2YWwpIHJldHVybgogICAgdGhpcy5jb25uZWN0ZWQgPSB0cnVlCiAgICB0aGlzLmVtaXQoJ2Nvbm5lY3QnKQogIH0KCiAgX2NsZWFyVGltZW91dCgpIHsKICAgIGlmICh0aGlzLl90aW1lb3V0VGltZXIgPT09IG51bGwpIHJldHVybgogICAgdGhpcy5fdGltZW91dFRpbWVyLmRlc3Ryb3koKQogICAgdGhpcy5fdGltZW91dFRpbWVyID0gbnVsbAogICAgdGhpcy50aW1lb3V0ID0gMAogIH0KCiAgX2NsZWFyS2VlcEFsaXZlKCkgewogICAgaWYgKHRoaXMuX2tlZXBBbGl2ZVRpbWVyID09PSBudWxsKSByZXR1cm4KICAgIHRoaXMuX2tlZXBBbGl2ZVRpbWVyLmRlc3Ryb3koKQogICAgdGhpcy5fa2VlcEFsaXZlVGltZXIgPSBudWxsCiAgICB0aGlzLmtlZXBBbGl2ZSA9IDAKICB9CgogIF9kZXN0cm95KGNiKSB7CiAgICB0aGlzLl9jbGVhcktlZXBBbGl2ZSgpCiAgICB0aGlzLl9jbGVhclRpbWVvdXQoKQogICAgdGhpcy5fcmVzb2x2ZU9wZW5lZChmYWxzZSkKICAgIGNiKG51bGwpCiAgfQoKICBfYm94TWVzc2FnZShidWZmZXIpIHsKICAgIGNvbnN0IE1CID0gc29kaXVtLmNyeXB0b19zZWNyZXRib3hfTUFDQllURVMgLy8gMTYKICAgIGNvbnN0IE5CID0gc29kaXVtLmNyeXB0b19zZWNyZXRib3hfTk9OQ0VCWVRFUyAvLyAyNAoKICAgIGNvbnN0IGNvdW50ZXIgPSB0aGlzLl9zZW5kU3RhdGUuc3ViYXJyYXkoNjQsIDcyKQogICAgc29kaXVtLnNvZGl1bV9pbmNyZW1lbnQoY291bnRlcikKICAgIGlmIChiNGEuZXF1YWxzKGNvdW50ZXIsIHRoaXMuX3NlbmRTdGF0ZS5zdWJhcnJheSg3MikpKSB7CiAgICAgIHRoaXMuZGVzdHJveShuZXcgRXJyb3IoJ3VkcCBzZW5kIG5vbmNlIGV4Y2hhdXN0ZWQnKSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3Qgc2VjcmV0ID0gdGhpcy5fc2VuZFN0YXRlLnN1YmFycmF5KDAsIDMyKQogICAgY29uc3QgZW52ZWxvcGUgPSBiNGEuYWxsb2NVbnNhZmUoOCArIE1CICsgYnVmZmVyLmJ5dGVMZW5ndGgpCiAgICBjb25zdCBub25jZSA9IGVudmVsb3BlLnN1YmFycmF5KDAsIE5CKQogICAgY29uc3QgY2lwaGVydGV4dCA9IGVudmVsb3BlLnN1YmFycmF5KDgpCgogICAgYjRhLmZpbGwobm9uY2UsIDApIC8vIHBhZCBzdWZmaXgKICAgIG5vbmNlLnNldChjb3VudGVyKQoKICAgIHNvZGl1bS5jcnlwdG9fc2VjcmV0Ym94X2Vhc3koY2lwaGVydGV4dCwgYnVmZmVyLCBub25jZSwgc2VjcmV0KQogICAgcmV0dXJuIGVudmVsb3BlCiAgfQoKICBzZW5kKGJ1ZmZlcikgewogICAgaWYgKCF0aGlzLl9zZW5kU3RhdGUpIHJldHVybgogICAgaWYgKCF0aGlzLnJhd1N0cmVhbT8uc2VuZCkgcmV0dXJuIC8vIHVkeC1zdHJlYW0gZXhwZWN0ZWQKCiAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5fYm94TWVzc2FnZShidWZmZXIpCiAgICByZXR1cm4gdGhpcy5yYXdTdHJlYW0uc2VuZChtZXNzYWdlKQogIH0KCiAgdHJ5U2VuZChidWZmZXIpIHsKICAgIGlmICghdGhpcy5fc2VuZFN0YXRlKSByZXR1cm4KICAgIGlmICghdGhpcy5yYXdTdHJlYW0/LnRyeVNlbmQpIHJldHVybiAvLyB1ZHgtc3RyZWFtIGV4cGVjdGVkCgogICAgY29uc3QgbWVzc2FnZSA9IHRoaXMuX2JveE1lc3NhZ2UoYnVmZmVyKQogICAgdGhpcy5yYXdTdHJlYW0udHJ5U2VuZChtZXNzYWdlKQogIH0KCiAgX29ubWVzc2FnZShidWZmZXIpIHsKICAgIGlmICghdGhpcy5fc2VuZFN0YXRlKSByZXR1cm4gLy8gbWVzc2FnZXMgYmVmb3JlIGhhbmRzaGFrZSBhcmUgZHJvcHBlZAoKICAgIGNvbnN0IE1CID0gc29kaXVtLmNyeXB0b19zZWNyZXRib3hfTUFDQllURVMgLy8gMTYKICAgIGNvbnN0IE5CID0gc29kaXVtLmNyeXB0b19zZWNyZXRib3hfTk9OQ0VCWVRFUyAvLyAyNAoKICAgIGlmIChidWZmZXIuYnl0ZUxlbmd0aCA8IE5CKSByZXR1cm4gLy8gSW52YWxpZCBtZXNzYWdlCgogICAgY29uc3Qgbm9uY2UgPSBiNGEuYWxsb2NVbnNhZmUoTkIpCiAgICBiNGEuZmlsbChub25jZSwgMCkKICAgIG5vbmNlLnNldChidWZmZXIuc3ViYXJyYXkoMCwgOCkpCgogICAgY29uc3Qgc2VjcmV0ID0gdGhpcy5fc2VuZFN0YXRlLnN1YmFycmF5KDMyLCA2NCkKICAgIGNvbnN0IGNpcGhlcnRleHQgPSBidWZmZXIuc3ViYXJyYXkoOCkKICAgIGNvbnN0IHBsYWluID0gYnVmZmVyLnN1YmFycmF5KDgsIGJ1ZmZlci5ieXRlTGVuZ3RoIC0gTUIpCgogICAgaWYgKGNpcGhlcnRleHQuYnl0ZUxlbmd0aCA8IE1CKSByZXR1cm4gLy8gaW52YWxpZCBtZXNzYWdlCgogICAgY29uc3Qgc3VjY2VzcyA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0Ym94X29wZW5fZWFzeShwbGFpbiwgY2lwaGVydGV4dCwgbm9uY2UsIHNlY3JldCkKCiAgICBpZiAoc3VjY2VzcykgdGhpcy5lbWl0KCdtZXNzYWdlJywgcGxhaW4pCiAgfQoKICBhbGxvYyhsZW4pIHsKICAgIGNvbnN0IGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShsZW4gKyAzICsgQUJZVEVTKQogICAgdGhpcy5fb3V0Z29pbmdXcmFwcGVkID0gYnVmCiAgICB0aGlzLl9vdXRnb2luZ1BsYWluID0gYnVmLnN1YmFycmF5KDQsIGJ1Zi5ieXRlTGVuZ3RoIC0gQUJZVEVTICsgMSkKICAgIHJldHVybiB0aGlzLl9vdXRnb2luZ1BsYWluCiAgfQoKICB0b0pTT04oKSB7CiAgICByZXR1cm4gewogICAgICBpc0luaXRpYXRvcjogdGhpcy5pc0luaXRpYXRvciwKICAgICAgcHVibGljS2V5OiB0aGlzLnB1YmxpY0tleSAmJiBiNGEudG9TdHJpbmcodGhpcy5wdWJsaWNLZXksICdoZXgnKSwKICAgICAgcmVtb3RlUHVibGljS2V5OiB0aGlzLnJlbW90ZVB1YmxpY0tleSAmJiBiNGEudG9TdHJpbmcodGhpcy5yZW1vdGVQdWJsaWNLZXksICdoZXgnKSwKICAgICAgY29ubmVjdGVkOiB0aGlzLmNvbm5lY3RlZCwKICAgICAgZGVzdHJveWluZzogdGhpcy5kZXN0cm95aW5nLAogICAgICBkZXN0cm95ZWQ6IHRoaXMuZGVzdHJveWVkLAogICAgICByYXdTdHJlYW06IHRoaXMucmF3U3RyZWFtICYmIHRoaXMucmF3U3RyZWFtLnRvSlNPTiA/IHRoaXMucmF3U3RyZWFtLnRvSlNPTigpIDogbnVsbAogICAgfQogIH0KfQoKZnVuY3Rpb24gd3JpdGVVaW50MjRsZShuLCBidWYpIHsKICBidWZbMF0gPSBuICYgMjU1CiAgYnVmWzFdID0gKG4gPj4+IDgpICYgMjU1CiAgYnVmWzJdID0gKG4gPj4+IDE2KSAmIDI1NQp9CgpmdW5jdGlvbiBzdHJlYW1JZChoYW5kc2hha2VIYXNoLCBpc0luaXRpYXRvciwgb3V0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKSkgewogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2gob3V0LCBpc0luaXRpYXRvciA/IE5TX0lOSVRJQVRPUiA6IE5TX1JFU1BPTkRFUiwgaGFuZHNoYWtlSGFzaCkKICByZXR1cm4gb3V0Cn0KCmZ1bmN0aW9uIHRvQnVmZmVyKGRhdGEpIHsKICByZXR1cm4gdHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnID8gYjRhLmZyb20oZGF0YSkgOiBkYXRhCn0KCmZ1bmN0aW9uIGRlc3Ryb3lUaW1lb3V0KCkgewogIHRoaXMuZGVzdHJveShuZXcgRXJyb3IoJ1N0cmVhbSB0aW1lZCBvdXQnKSkKfQoKZnVuY3Rpb24gc2VuZEtlZXBBbGl2ZSgpIHsKICBjb25zdCBlbXB0eSA9IHRoaXMuYWxsb2MoMCkKICB0aGlzLndyaXRlKGVtcHR5KQp9CmNvbnN0IHsgRHVwbGV4LCBXcml0YWJsZSB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCgpjbGFzcyBSZXZlcnNlUGFzc1Rocm91Z2ggZXh0ZW5kcyBEdXBsZXggewogIGNvbnN0cnVjdG9yKHMpIHsKICAgIHN1cGVyKCkKICAgIHRoaXMuX3N0cmVhbSA9IHMKICAgIHRoaXMuX29uZHJhaW4gPSBudWxsCiAgfQoKICBfd3JpdGUoZGF0YSwgY2IpIHsKICAgIGlmICh0aGlzLl9zdHJlYW0ucHVzaChkYXRhKSA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5fc3RyZWFtLl9vbmRyYWluID0gY2IKICAgIH0gZWxzZSB7CiAgICAgIGNiKG51bGwpCiAgICB9CiAgfQoKICBfZmluYWwoY2IpIHsKICAgIHRoaXMuX3N0cmVhbS5wdXNoKG51bGwpCiAgICBjYihudWxsKQogIH0KCiAgX3JlYWQoY2IpIHsKICAgIGNvbnN0IG9uZHJhaW4gPSB0aGlzLl9vbmRyYWluCiAgICB0aGlzLl9vbmRyYWluID0gbnVsbAogICAgaWYgKG9uZHJhaW4pIG9uZHJhaW4oKQogICAgY2IobnVsbCkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQnJpZGdlIGV4dGVuZHMgRHVwbGV4IHsKICBjb25zdHJ1Y3Rvcihub2lzZVN0cmVhbSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMubm9pc2VTdHJlYW0gPSBub2lzZVN0cmVhbQoKICAgIHRoaXMuX29uZHJhaW4gPSBudWxsCiAgICB0aGlzLnJldmVyc2UgPSBuZXcgUmV2ZXJzZVBhc3NUaHJvdWdoKHRoaXMpCiAgfQoKICBnZXQgcHVibGljS2V5KCkgewogICAgcmV0dXJuIHRoaXMubm9pc2VTdHJlYW0ucHVibGljS2V5CiAgfQoKICBnZXQgcmVtb3RlUHVibGljS2V5KCkgewogICAgcmV0dXJuIHRoaXMubm9pc2VTdHJlYW0ucmVtb3RlUHVibGljS2V5CiAgfQoKICBnZXQgaGFuZHNoYWtlSGFzaCgpIHsKICAgIHJldHVybiB0aGlzLm5vaXNlU3RyZWFtLmhhbmRzaGFrZUhhc2gKICB9CgogIGZsdXNoKCkgewogICAgcmV0dXJuIFdyaXRhYmxlLmRyYWluZWQodGhpcykKICB9CgogIF9yZWFkKGNiKSB7CiAgICBjb25zdCBvbmRyYWluID0gdGhpcy5fb25kcmFpbgogICAgdGhpcy5fb25kcmFpbiA9IG51bGwKICAgIGlmIChvbmRyYWluKSBvbmRyYWluKCkKICAgIGNiKG51bGwpCiAgfQoKICBfd3JpdGUoZGF0YSwgY2IpIHsKICAgIGlmICh0aGlzLnJldmVyc2UucHVzaChkYXRhKSA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5yZXZlcnNlLl9vbmRyYWluID0gY2IKICAgIH0gZWxzZSB7CiAgICAgIGNiKG51bGwpCiAgICB9CiAgfQoKICBfZmluYWwoY2IpIHsKICAgIHRoaXMucmV2ZXJzZS5wdXNoKG51bGwpCiAgICBjYihudWxsKQogIH0KfQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgY3VydmUgPSByZXF1aXJlKCdub2lzZS1jdXJ2ZS1lZCcpCmNvbnN0IE5vaXNlID0gcmVxdWlyZSgnbm9pc2UtaGFuZHNoYWtlJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IEVNUFRZID0gYjRhLmFsbG9jKDApCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEhhbmRzaGFrZSB7CiAgY29uc3RydWN0b3IoaXNJbml0aWF0b3IsIGtleVBhaXIsIHJlbW90ZVB1YmxpY0tleSwgcGF0dGVybikgewogICAgdGhpcy5pc0luaXRpYXRvciA9IGlzSW5pdGlhdG9yCiAgICB0aGlzLmtleVBhaXIgPSBrZXlQYWlyCiAgICB0aGlzLm5vaXNlID0gbmV3IE5vaXNlKHBhdHRlcm4sIGlzSW5pdGlhdG9yLCBrZXlQYWlyLCB7IGN1cnZlIH0pCiAgICB0aGlzLm5vaXNlLmluaXRpYWxpc2UoRU1QVFksIHJlbW90ZVB1YmxpY0tleSkKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICB9CgogIHN0YXRpYyBrZXlQYWlyKHNlZWQpIHsKICAgIGNvbnN0IHB1YmxpY0tleSA9IGI0YS5hbGxvYygzMikKICAgIGNvbnN0IHNlY3JldEtleSA9IGI0YS5hbGxvYyg2NCkKICAgIGlmIChzZWVkKSBzb2RpdW0uY3J5cHRvX3NpZ25fc2VlZF9rZXlwYWlyKHB1YmxpY0tleSwgc2VjcmV0S2V5LCBzZWVkKQogICAgZWxzZSBzb2RpdW0uY3J5cHRvX3NpZ25fa2V5cGFpcihwdWJsaWNLZXksIHNlY3JldEtleSkKICAgIHJldHVybiB7IHB1YmxpY0tleSwgc2VjcmV0S2V5IH0KICB9CgogIHJlY3YoZGF0YSkgewogICAgdHJ5IHsKICAgICAgdGhpcy5ub2lzZS5yZWN2KGRhdGEpCiAgICAgIGlmICh0aGlzLm5vaXNlLmNvbXBsZXRlKSByZXR1cm4gdGhpcy5fcmV0dXJuKG51bGwpCiAgICAgIHJldHVybiB0aGlzLnNlbmQoKQogICAgfSBjYXRjaCB7CiAgICAgIHRoaXMuZGVzdHJveSgpCiAgICAgIHJldHVybiBudWxsCiAgICB9CiAgfQoKICAvLyBub3RlIHRoYXQgdGhlIGRhdGEgcmV0dXJuZWQgaGVyZSBpcyBmcmFtZWQgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyBhbiBleHRyYSBjb3B5CiAgLy8gd2hlbiBzZW5kaW5nIGl0Li4uCiAgc2VuZCgpIHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLm5vaXNlLnNlbmQoKQogICAgICBjb25zdCB3cmFwID0gYjRhLmFsbG9jVW5zYWZlKGRhdGEuYnl0ZUxlbmd0aCArIDMpCgogICAgICB3cml0ZVVpbnQyNGxlKGRhdGEuYnl0ZUxlbmd0aCwgd3JhcCkKICAgICAgd3JhcC5zZXQoZGF0YSwgMykKCiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm4od3JhcCkKICAgIH0gY2F0Y2ggewogICAgICB0aGlzLmRlc3Ryb3koKQogICAgICByZXR1cm4gbnVsbAogICAgfQogIH0KCiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICB9CgogIF9yZXR1cm4oZGF0YSkgewogICAgY29uc3QgdHggPSB0aGlzLm5vaXNlLmNvbXBsZXRlID8gYjRhLnRvQnVmZmVyKHRoaXMubm9pc2UudHgpIDogbnVsbAogICAgY29uc3QgcnggPSB0aGlzLm5vaXNlLmNvbXBsZXRlID8gYjRhLnRvQnVmZmVyKHRoaXMubm9pc2UucngpIDogbnVsbAogICAgY29uc3QgaGFzaCA9IHRoaXMubm9pc2UuY29tcGxldGUgPyBiNGEudG9CdWZmZXIodGhpcy5ub2lzZS5oYXNoKSA6IG51bGwKICAgIGNvbnN0IHJlbW90ZVB1YmxpY0tleSA9IHRoaXMubm9pc2UuY29tcGxldGUgPyBiNGEudG9CdWZmZXIodGhpcy5ub2lzZS5ycykgOiBudWxsCgogICAgcmV0dXJuIHsKICAgICAgZGF0YSwKICAgICAgcmVtb3RlUHVibGljS2V5LAogICAgICBoYXNoLAogICAgICB0eCwKICAgICAgcngKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHdyaXRlVWludDI0bGUobiwgYnVmKSB7CiAgYnVmWzBdID0gbiAmIDI1NQogIGJ1ZlsxXSA9IChuID4+PiA4KSAmIDI1NQogIGJ1ZlsyXSA9IChuID4+PiAxNikgJiAyNTUKfQp7CiAgIm5hbWUiOiAiQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbSIsCiAgInZlcnNpb24iOiAiNi45LjEiLAogICJkZXNjcmlwdGlvbiI6ICJTZWNyZXQgc3RyZWFtIGJhY2tlZCBieSBOb2lzZSBhbmQgbGlic29kaXVtJ3Mgc2VjcmV0c3RyZWFtIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJsaWIvKiouanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS4xLjAiLAogICAgImh5cGVyY29yZS1jcnlwdG8iOiAiXjMuMy4xIiwKICAgICJub2lzZS1jdXJ2ZS1lZCI6ICJeMi4wLjEiLAogICAgIm5vaXNlLWhhbmRzaGFrZSI6ICJeNC4wLjAiLAogICAgInNvZGl1bS1zZWNyZXRzdHJlYW0iOiAiXjEuMS4wIiwKICAgICJzb2RpdW0tdW5pdmVyc2FsIjogIl41LjAuMCIsCiAgICAic3RyZWFteCI6ICJeMi4xNC4wIiwKICAgICJ0aW1lb3V0LXJlZnJlc2giOiAiXjIuMC4wIiwKICAgICJ1bnNsYWIiOiAiXjEuMy4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjMuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIsCiAgICAidWR4LW5hdGl2ZSI6ICJeMS4xMy4yIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4iLAogICAgInRlc3QiOiAiYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJzd2FybS1zZWNyZXQtc3RyZWFtLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcnN3YXJtLXNlY3JldC1zdHJlYW0vaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcnN3YXJtLXNlY3JldC1zdHJlYW0iCn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBJbmRleEVuY29kZXIgPSByZXF1aXJlKCdpbmRleC1lbmNvZGVyJykKCmNvbnN0IENoZWNrb3V0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAga2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgQ2xvY2sgPSBjLmFycmF5KENoZWNrb3V0KQoKY29uc3QgSW5kZXhDaGVja3BvaW50ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDY0LnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc2lnbmF0dXJlOiBjLmZpeGVkNjQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgS2V5VjAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmtleSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGtleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogLTEKICAgIH0KICB9Cn0KCmNvbnN0IEtleXNWMCA9IGMuYXJyYXkoS2V5VjApCgpjb25zdCBXYWtldXBWMCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIDApIC8vIHZlcnNpb24KICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udHlwZSkKCiAgICBpZiAobS50eXBlID09PSAxKSB7CiAgICAgIEtleXNWMC5wcmVlbmNvZGUoc3RhdGUsIG0ud3JpdGVycykKICAgIH0KICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkgLy8gdmVyc2lvbgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS50eXBlKQoKICAgIGlmIChtLnR5cGUgPT09IDEpIHsKICAgICAgS2V5c1YwLmVuY29kZShzdGF0ZSwgbS53cml0ZXJzKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB2ID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGlmICh2ICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb246ICcgKyB2KQoKICAgIGNvbnN0IHR5cGUgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgbSA9IHsgdmVyc2lvbjogMCwgdHlwZSwgd3JpdGVyczogbnVsbCB9CgogICAgaWYgKG0udHlwZSA9PT0gMSkgewogICAgICBtLndyaXRlcnMgPSBLZXlzVjAuZGVjb2RlKHN0YXRlKQogICAgfQoKICAgIHJldHVybiBtCiAgfQp9Cgpjb25zdCBXYWtldXAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBpZiAobS52ZXJzaW9uID09PSAwKSByZXR1cm4gV2FrZXVwVjAucHJlZW5jb2RlKHN0YXRlLCBtKQoKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIDEpIC8vIHZlcnNpb24KICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udHlwZSkKCiAgICBpZiAobS50eXBlID09PSAxKSB7CiAgICAgIENsb2NrLnByZWVuY29kZShzdGF0ZSwgbS53cml0ZXJzKQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBpZiAobS52ZXJzaW9uID09PSAwKSByZXR1cm4gV2FrZXVwVjAuZW5jb2RlKHN0YXRlLCBtKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpIC8vIHZlcnNpb24KICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udHlwZSkKCiAgICBpZiAobS50eXBlID09PSAxKSB7CiAgICAgIENsb2NrLmVuY29kZShzdGF0ZSwgbS53cml0ZXJzKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgICBjb25zdCB2ID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAodiA+IDEpIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbjogJyArIHYpCgogICAgaWYgKHYgPT09IDApIHsKICAgICAgc3RhdGUuc3RhcnQgPSBzdGFydAogICAgICByZXR1cm4gV2FrZXVwVjAuZGVjb2RlKHN0YXRlKQogICAgfQoKICAgIGNvbnN0IHR5cGUgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgbSA9IHsgdmVyc2lvbjogMSwgdHlwZSwgd3JpdGVyczogbnVsbCB9CgogICAgaWYgKG0udHlwZSA9PT0gMSkgewogICAgICBtLndyaXRlcnMgPSBDbG9jay5kZWNvZGUoc3RhdGUpCiAgICB9CgogICAgcmV0dXJuIG0KICB9Cn0KCmNvbnN0IEJvb3RSZWNvcmRWMCA9IHsKICBwcmVlbmNvZGUoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ3ZlcnNpb24gMCByZWNvcmRzIGNhbm5vdCBiZSBlbmNvZGVkJykKICB9LAogIGVuY29kZSgpIHsKICAgIHRocm93IG5ldyBFcnJvcigndmVyc2lvbiAwIHJlY29yZHMgY2Fubm90IGJlIGVuY29kZWQnKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBpbmRleGVkID0gQ2hlY2tvdXQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgaGVhZHMgPSBDbG9jay5kZWNvZGUoc3RhdGUpCgogICAgLy8gb25lIGNhdXNlIGluaXRpYWwgcmVjb3ZlciBpcyBub3QgZmYgcmVjb3ZlcnkKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IDAsCiAgICAgIGtleTogaW5kZXhlZC5rZXksCiAgICAgIHN5c3RlbUxlbmd0aDogaW5kZXhlZC5sZW5ndGgsCiAgICAgIGluZGV4ZXJzVXBkYXRlZDogZmFsc2UsCiAgICAgIGZhc3RGb3J3YXJkaW5nOiBmYWxzZSwKICAgICAgcmVjb3ZlcmllczogMSwKICAgICAgbWlncmF0aW5nOiBmYWxzZSwKICAgICAgaGVhZHMKICAgIH0KICB9Cn0KCmNvbnN0IENoZWNrcG9pbnRlciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGlkeCkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgaWR4LmNoZWNrcG9pbnRlcikKICAgIGlmIChpZHguY2hlY2twb2ludCAhPT0gbnVsbCkgSW5kZXhDaGVja3BvaW50LnByZWVuY29kZShzdGF0ZSwgaWR4LmNoZWNrcG9pbnQpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGlkeCkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgaWR4LmNoZWNrcG9pbnRlcikKICAgIGlmIChpZHguY2hlY2twb2ludCAhPT0gbnVsbCkgSW5kZXhDaGVja3BvaW50LmVuY29kZShzdGF0ZSwgaWR4LmNoZWNrcG9pbnQpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGNoZWNrcG9pbnRlciA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBjaGVja3BvaW50ID0gY2hlY2twb2ludGVyID8gbnVsbCA6IEluZGV4Q2hlY2twb2ludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgY2hlY2twb2ludGVyLAogICAgICBjaGVja3BvaW50CiAgICB9CiAgfQp9Cgpjb25zdCBDaGVja3BvaW50ZXJBcnJheSA9IGMuYXJyYXkoQ2hlY2twb2ludGVyKQoKY29uc3QgSW5kZXhlciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzaWduYXR1cmU6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBuYW1lc3BhY2U6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBwdWJsaWNLZXk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBJbmRleGVycyA9IGMuYXJyYXkoSW5kZXhlcikKCmNvbnN0IERpZ2VzdFYwID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5wb2ludGVyKQogICAgaWYgKG0ucG9pbnRlciA9PT0gMCkgewogICAgICBJbmRleGVycy5wcmVlbmNvZGUoc3RhdGUsIG0uaW5kZXhlcnMpCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucG9pbnRlcikKICAgIGlmIChtLnBvaW50ZXIgPT09IDApIHsKICAgICAgSW5kZXhlcnMuZW5jb2RlKHN0YXRlLCBtLmluZGV4ZXJzKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBwb2ludGVyID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIHBvaW50ZXIsCiAgICAgIGluZGV4ZXJzOiBwb2ludGVyID09PSAwID8gSW5kZXhlcnMuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IERpZ2VzdCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucG9pbnRlcikKICAgIGlmIChtLnBvaW50ZXIgPT09IDApIHsKICAgICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucG9pbnRlcikKICAgIGlmIChtLnBvaW50ZXIgPT09IDApIHsKICAgICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHBvaW50ZXIgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgcG9pbnRlciwKICAgICAga2V5OiBwb2ludGVyID09PSAwID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBOb2RlID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgQ2xvY2sucHJlZW5jb2RlKHN0YXRlLCBtLmhlYWRzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5iYXRjaCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgQ2xvY2suZW5jb2RlKHN0YXRlLCBtLmhlYWRzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5iYXRjaCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICB9LAogIGRlY29kZShzdGF0ZSwgbSkgewogICAgcmV0dXJuIHsKICAgICAgaGVhZHM6IENsb2NrLmRlY29kZShzdGF0ZSksCiAgICAgIGJhdGNoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgdmFsdWU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IEFkZGl0aW9uYWwgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnBvaW50ZXIpCiAgICBpZiAobS5wb2ludGVyID09PSAwKSB7CiAgICAgIEFkZGl0aW9uYWxEYXRhLnByZWVuY29kZShzdGF0ZSwgbS5kYXRhKQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnBvaW50ZXIpCiAgICBpZiAobS5wb2ludGVyID09PSAwKSB7CiAgICAgIEFkZGl0aW9uYWxEYXRhLmVuY29kZShzdGF0ZSwgbS5kYXRhKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBwb2ludGVyID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIHBvaW50ZXIsCiAgICAgIGRhdGE6IHBvaW50ZXIgPT09IDAgPyBBZGRpdGlvbmFsRGF0YS5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKY29uc3QgQWRkaXRpb25hbERhdGEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCAwKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAwKSAvLyBlbXB0eSBmb3Igbm93LCBmb3IgdGhlIGZ1dHVyZQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBlbmNyeXB0aW9uSWQ6IGZsYWdzICYgMSA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbCwgLy8gdG8gaGVscCB2YWxpZGF0ZSB0aGUgZW5jcnlwdGlvbiBrZXkgdXNlZAogICAgICBhYmk6IGZsYWdzICYgMiA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgfQogIH0KfQoKY29uc3QgT3Bsb2dNZXNzYWdlVjEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY29kaW5nIG5vdCBzdXBwb3J0ZWQnKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY29kaW5nIG5vdCBzdXBwb3J0ZWQnKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBtYXhTdXBwb3J0ZWRWZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgY29uc3QgaXNDaGVja3BvaW50ZXIgPSAoZmxhZ3MgJiAxKSAhPT0gMAoKICAgIGNvbnN0IGNoayA9IGlzQ2hlY2twb2ludGVyID8gQ2hlY2twb2ludGVyQXJyYXkuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIGNvbnN0IGRpZ2VzdCA9IGlzQ2hlY2twb2ludGVyID8gRGlnZXN0LmRlY29kZShzdGF0ZSkgOiBudWxsCgogICAgY29uc3Qgbm9kZSA9IE5vZGUuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IDEsCiAgICAgIG1heFN1cHBvcnRlZFZlcnNpb24sCiAgICAgIGRpZ2VzdCwKICAgICAgY2hlY2twb2ludDogY2hrID8geyBzeXN0ZW06IGNoa1swXSwgZW5jcnlwdGlvbjogbnVsbCwgdXNlcjogY2hrLnNsaWNlKDEpIH0gOiBudWxsLAogICAgICBvcHRpbWlzdGljOiAoZmxhZ3MgJiAyKSAhPT0gMCwKICAgICAgbm9kZQogICAgfQogIH0KfQoKY29uc3QgT3Bsb2dNZXNzYWdlVjAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY29kaW5nIG5vdCBzdXBwb3J0ZWQnKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY29kaW5nIG5vdCBzdXBwb3J0ZWQnKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgY29uc3QgaXNDaGVja3BvaW50ZXIgPSAoZmxhZ3MgJiAxKSAhPT0gMAoKICAgIGlmIChpc0NoZWNrcG9pbnRlcikgRGlnZXN0VjAuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgY2hrID0gaXNDaGVja3BvaW50ZXIgPyBDaGVja3BvaW50ZXJBcnJheS5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgY29uc3Qgbm9kZSA9IE5vZGUuZGVjb2RlKHN0YXRlKQogICAgQWRkaXRpb25hbC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBtYXhTdXBwb3J0ZWRWZXJzaW9uID0gc3RhdGUuc3RhcnQgPCBzdGF0ZS5lbmQgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiAwLAogICAgICBtYXhTdXBwb3J0ZWRWZXJzaW9uLAogICAgICBkaWdlc3Q6IG51bGwsCiAgICAgIGNoZWNrcG9pbnQ6IGNoayA/IHsgc3lzdGVtOiBjaGtbMF0sIGVuY3J5cHRpb246IG51bGwsIHVzZXI6IGNoay5zbGljZSgxKSB9IDogbnVsbCwKICAgICAgb3B0aW1pc3RpYzogbnVsbCwKICAgICAgbm9kZQogICAgfQogIH0KfQoKLy8gcHJlZml4IDAgaXMgcmVzZXJ2ZWQgZm9yIGZ1dHVyZSBtYW5pZmVzdApjb25zdCBMSU5FQVJJWkVSX1BSRUZJWCA9IDEKCmNvbnN0IExpbmVhcml6ZXJLZXkgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBzZXEpIHsKICAgIEluZGV4RW5jb2Rlci5VSU5ULnByZWVuY29kZShzdGF0ZSwgTElORUFSSVpFUl9QUkVGSVgpCiAgICBJbmRleEVuY29kZXIuVUlOVC5wcmVlbmNvZGUoc3RhdGUsIHNlcSkKICB9LAogIGVuY29kZShzdGF0ZSwgc2VxKSB7CiAgICBJbmRleEVuY29kZXIuVUlOVC5lbmNvZGUoc3RhdGUsIExJTkVBUklaRVJfUFJFRklYKQogICAgSW5kZXhFbmNvZGVyLlVJTlQuZW5jb2RlKHN0YXRlLCBzZXEpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIEluZGV4RW5jb2Rlci5VSU5ULmRlY29kZShzdGF0ZSkKICAgIHJldHVybiBJbmRleEVuY29kZXIuVUlOVC5kZWNvZGUoc3RhdGUpCiAgfQp9CgpmdW5jdGlvbiBpbmZvTGVnYWN5TWFwKGluZm8pIHsKICByZXR1cm4gewogICAgdmVyc2lvbjogaW5mby52ZXJzaW9uLAogICAgbWVtYmVyczogaW5mby5tZW1iZXJzLAogICAgcGVuZGluZ0luZGV4ZXJzOiBpbmZvLnBlbmRpbmdJbmRleGVycywKICAgIGluZGV4ZXJzOiBpbmZvLmluZGV4ZXJzLAogICAgaGVhZHM6IGluZm8uaGVhZHMsCiAgICB2aWV3czogaW5mby52aWV3cywKICAgIGVuY3J5cHRpb25MZW5ndGg6IDAsCiAgICBlbnRyb3B5OiBudWxsCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBXYWtldXAsCiAgQm9vdFJlY29yZFYwLAogIE9wbG9nTWVzc2FnZVYwLAogIE9wbG9nTWVzc2FnZVYxLAogIExpbmVhcml6ZXJLZXksCiAgaW5mb0xlZ2FjeU1hcAp9Ci8vIFRoaXMgZmlsZSBpcyBhdXRvZ2VuZXJhdGVkIGJ5IHRoZSBoeXBlcnNjaGVtYSBjb21waWxlcgovLyBTY2hlbWEgVmVyc2lvbjogMQovKiBlc2xpbnQtZGlzYWJsZSBjYW1lbGNhc2UgKi8KLyogZXNsaW50LWRpc2FibGUgcXVvdGVzICovCgpjb25zdCB7IGMgfSA9IHJlcXVpcmUoJ2h5cGVyc2NoZW1hL3J1bnRpbWUnKQpjb25zdCBleHRlcm5hbDAgPSByZXF1aXJlKCcuLi8uLi9sZWdhY3kuanMnKQoKY29uc3QgVkVSU0lPTiA9IDEKCi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtdmFycwpsZXQgdmVyc2lvbiA9IFZFUlNJT04KCi8vIEBhdXRvYmFzZS9jaGVja291dApjb25zdCBlbmNvZGluZzAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAga2V5OiByMCwKICAgICAgbGVuZ3RoOiByMQogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL2Nsb2NrCmNvbnN0IGVuY29kaW5nMSA9IGMuYXJyYXkoZW5jb2RpbmcwKQoKLy8gQGF1dG9iYXNlL2luZGV4LWNoZWNrcG9pbnQKY29uc3QgZW5jb2RpbmcyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDY0LnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLmZpeGVkNjQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHNpZ25hdHVyZTogcjAsCiAgICAgIGxlbmd0aDogcjEKICAgIH0KICB9Cn0KCmNvbnN0IGVuY29kaW5nMyA9IGV4dGVybmFsMC5XYWtldXAKCmNvbnN0IGVuY29kaW5nNCA9IGV4dGVybmFsMC5Cb290UmVjb3JkVjAKCi8vIEBhdXRvYmFzZS9ib290LXJlY29yZC1yYXcKY29uc3QgZW5jb2Rpbmc1ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN5c3RlbUxlbmd0aCkKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDQgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0ucmVjb3ZlcmllcykgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZWNvdmVyaWVzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLmluZGV4ZXJzVXBkYXRlZCA/IDEgOiAwKSB8IChtLmZhc3RGb3J3YXJkaW5nID8gMiA6IDApIHwgKG0ucmVjb3ZlcmllcyA/IDQgOiAwKQoKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zeXN0ZW1MZW5ndGgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5yZWNvdmVyaWVzKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlY292ZXJpZXMpCiAgfSwKICBkZWNvZGUoc3RhdGUsIHZlcnNpb24pIHsKICAgIGlmICh2ZXJzaW9uID09PSB1bmRlZmluZWQpIHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjAgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb24sCiAgICAgIGtleTogcjAsCiAgICAgIHN5c3RlbUxlbmd0aDogcjEsCiAgICAgIGluZGV4ZXJzVXBkYXRlZDogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIGZhc3RGb3J3YXJkaW5nOiAoZmxhZ3MgJiAyKSAhPT0gMCwKICAgICAgcmVjb3ZlcmllczogKGZsYWdzICYgNCkgIT09IDAgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9ib290LXJlY29yZApjb25zdCBlbmNvZGluZzYgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBzd2l0Y2ggKG0udmVyc2lvbikgewogICAgICBjYXNlIDA6CiAgICAgICAgZW5jb2Rpbmc0LnByZWVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBjYXNlIDE6CiAgICAgIGNhc2UgMjoKICAgICAgY2FzZSAzOgogICAgICAgIGVuY29kaW5nNS5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb24nKQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBzd2l0Y2ggKG0udmVyc2lvbikgewogICAgICBjYXNlIDA6CiAgICAgICAgZW5jb2Rpbmc0LmVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBjYXNlIDE6CiAgICAgIGNhc2UgMjoKICAgICAgY2FzZSAzOgogICAgICAgIGVuY29kaW5nNS5lbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb24nKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHN3aXRjaCAodmVyc2lvbikgewogICAgICBjYXNlIDA6IHsKICAgICAgICBjb25zdCBkZWNvZGVkID0gZW5jb2Rpbmc0LmRlY29kZShzdGF0ZSwgdmVyc2lvbikKICAgICAgICByZXR1cm4gZGVjb2RlZAogICAgICB9CiAgICAgIGNhc2UgMToKICAgICAgY2FzZSAyOgogICAgICBjYXNlIDM6IHsKICAgICAgICBjb25zdCBkZWNvZGVkID0gZW5jb2Rpbmc1LmRlY29kZShzdGF0ZSwgdmVyc2lvbikKICAgICAgICByZXR1cm4gZGVjb2RlZAogICAgICB9CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uJykKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9jaGVja3BvaW50ZXIKY29uc3QgZW5jb2Rpbmc3ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMiBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5jaGVja3BvaW50ZXIpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uY2hlY2twb2ludGVyKQogICAgaWYgKG0uY2hlY2twb2ludCkgZW5jb2RpbmcyLnByZWVuY29kZShzdGF0ZSwgbS5jaGVja3BvaW50KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLmNoZWNrcG9pbnRlciA/IDEgOiAwKSB8IChtLmNoZWNrcG9pbnQgPyAyIDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5jaGVja3BvaW50ZXIpIGMudWludC5lbmNvZGUoc3RhdGUsIG0uY2hlY2twb2ludGVyKQogICAgaWYgKG0uY2hlY2twb2ludCkgZW5jb2RpbmcyLmVuY29kZShzdGF0ZSwgbS5jaGVja3BvaW50KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgY2hlY2twb2ludGVyOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMCwKICAgICAgY2hlY2twb2ludDogKGZsYWdzICYgMikgIT09IDAgPyBlbmNvZGluZzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9jaGVja3BvaW50LnVzZXIKY29uc3QgZW5jb2Rpbmc4XzIgPSBjLmFycmF5KGVuY29kaW5nNykKCi8vIEBhdXRvYmFzZS9jaGVja3BvaW50CmNvbnN0IGVuY29kaW5nOCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDQgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0uc3lzdGVtKSBlbmNvZGluZzcucHJlZW5jb2RlKHN0YXRlLCBtLnN5c3RlbSkKICAgIGlmIChtLmVuY3J5cHRpb24pIGVuY29kaW5nNy5wcmVlbmNvZGUoc3RhdGUsIG0uZW5jcnlwdGlvbikKICAgIGlmIChtLnVzZXIpIGVuY29kaW5nOF8yLnByZWVuY29kZShzdGF0ZSwgbS51c2VyKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLnN5c3RlbSA/IDEgOiAwKSB8IChtLmVuY3J5cHRpb24gPyAyIDogMCkgfCAobS51c2VyID8gNCA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0uc3lzdGVtKSBlbmNvZGluZzcuZW5jb2RlKHN0YXRlLCBtLnN5c3RlbSkKICAgIGlmIChtLmVuY3J5cHRpb24pIGVuY29kaW5nNy5lbmNvZGUoc3RhdGUsIG0uZW5jcnlwdGlvbikKICAgIGlmIChtLnVzZXIpIGVuY29kaW5nOF8yLmVuY29kZShzdGF0ZSwgbS51c2VyKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgc3lzdGVtOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGVuY29kaW5nNy5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgZW5jcnlwdGlvbjogKGZsYWdzICYgMikgIT09IDAgPyBlbmNvZGluZzcuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHVzZXI6IChmbGFncyAmIDQpICE9PSAwID8gZW5jb2Rpbmc4XzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9kaWdlc3QKY29uc3QgZW5jb2Rpbmc5ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMiBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5wb2ludGVyKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnBvaW50ZXIpCiAgICBpZiAobS5rZXkpIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ua2V5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLnBvaW50ZXIgPyAxIDogMCkgfCAobS5rZXkgPyAyIDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5wb2ludGVyKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnBvaW50ZXIpCiAgICBpZiAobS5rZXkpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ua2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgcG9pbnRlcjogKGZsYWdzICYgMSkgIT09IDAgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAsCiAgICAgIGtleTogKGZsYWdzICYgMikgIT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9ub2RlCmNvbnN0IGVuY29kaW5nMTAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBlbmNvZGluZzEucHJlZW5jb2RlKHN0YXRlLCBtLmhlYWRzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5iYXRjaCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgZW5jb2RpbmcxLmVuY29kZShzdGF0ZSwgbS5oZWFkcykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uYmF0Y2gpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0udmFsdWUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gZW5jb2RpbmcxLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIyID0gYy5idWZmZXIuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGhlYWRzOiByMCwKICAgICAgYmF0Y2g6IHIxLAogICAgICB2YWx1ZTogcjIKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS90cmFjZS5zeXN0ZW0KY29uc3QgZW5jb2RpbmcxMV8wID0gYy5hcnJheShjLnVpbnQpCi8vIEBhdXRvYmFzZS90cmFjZS5lbmNyeXB0aW9uCmNvbnN0IGVuY29kaW5nMTFfMSA9IGVuY29kaW5nMTFfMAoKLy8gQGF1dG9iYXNlL3RyYWNlCmNvbnN0IGVuY29kaW5nMTEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBlbmNvZGluZzExXzAucHJlZW5jb2RlKHN0YXRlLCBtLnN5c3RlbSkKICAgIGVuY29kaW5nMTFfMS5wcmVlbmNvZGUoc3RhdGUsIG0uZW5jcnlwdGlvbikKICAgIGVuY29kaW5nMTFfMi5wcmVlbmNvZGUoc3RhdGUsIG0udXNlcikKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgZW5jb2RpbmcxMV8wLmVuY29kZShzdGF0ZSwgbS5zeXN0ZW0pCiAgICBlbmNvZGluZzExXzEuZW5jb2RlKHN0YXRlLCBtLmVuY3J5cHRpb24pCiAgICBlbmNvZGluZzExXzIuZW5jb2RlKHN0YXRlLCBtLnVzZXIpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gZW5jb2RpbmcxMV8wLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gZW5jb2RpbmcxMV8xLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIyID0gZW5jb2RpbmcxMV8yLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBzeXN0ZW06IHIwLAogICAgICBlbmNyeXB0aW9uOiByMSwKICAgICAgdXNlcjogcjIKICAgIH0KICB9Cn0KCmNvbnN0IGVuY29kaW5nMTIgPSBleHRlcm5hbDAuT3Bsb2dNZXNzYWdlVjAKCmNvbnN0IGVuY29kaW5nMTMgPSBleHRlcm5hbDAuT3Bsb2dNZXNzYWdlVjEKCi8vIEBhdXRvYmFzZS9vcGxvZy1tZXNzYWdlLXYyLmNoZWNrcG9pbnQKY29uc3QgZW5jb2RpbmcxNF8xID0gYy5mcmFtZShlbmNvZGluZzgpCi8vIEBhdXRvYmFzZS9vcGxvZy1tZXNzYWdlLXYyLmRpZ2VzdApjb25zdCBlbmNvZGluZzE0XzIgPSBjLmZyYW1lKGVuY29kaW5nOSkKLy8gQGF1dG9iYXNlL29wbG9nLW1lc3NhZ2UtdjIudHJhY2UKY29uc3QgZW5jb2RpbmcxNF80ID0gYy5mcmFtZShlbmNvZGluZzExKQoKLy8gQGF1dG9iYXNlL29wbG9nLW1lc3NhZ2UtdjIKY29uc3QgZW5jb2RpbmcxNCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGVuY29kaW5nMTAucHJlZW5jb2RlKHN0YXRlLCBtLm5vZGUpCiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyA4IHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLmNoZWNrcG9pbnQpIGVuY29kaW5nMTRfMS5wcmVlbmNvZGUoc3RhdGUsIG0uY2hlY2twb2ludCkKICAgIGlmIChtLmRpZ2VzdCkgZW5jb2RpbmcxNF8yLnByZWVuY29kZShzdGF0ZSwgbS5kaWdlc3QpCiAgICBpZiAobS50cmFjZSkgZW5jb2RpbmcxNF80LnByZWVuY29kZShzdGF0ZSwgbS50cmFjZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPQogICAgICAobS5jaGVja3BvaW50ID8gMSA6IDApIHwgKG0uZGlnZXN0ID8gMiA6IDApIHwgKG0ub3B0aW1pc3RpYyA/IDQgOiAwKSB8IChtLnRyYWNlID8gOCA6IDApCgogICAgZW5jb2RpbmcxMC5lbmNvZGUoc3RhdGUsIG0ubm9kZSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLmNoZWNrcG9pbnQpIGVuY29kaW5nMTRfMS5lbmNvZGUoc3RhdGUsIG0uY2hlY2twb2ludCkKICAgIGlmIChtLmRpZ2VzdCkgZW5jb2RpbmcxNF8yLmVuY29kZShzdGF0ZSwgbS5kaWdlc3QpCiAgICBpZiAobS50cmFjZSkgZW5jb2RpbmcxNF80LmVuY29kZShzdGF0ZSwgbS50cmFjZSkKICB9LAogIGRlY29kZShzdGF0ZSwgdmVyc2lvbikgewogICAgaWYgKHZlcnNpb24gPT09IHVuZGVmaW5lZCkgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMCA9IGVuY29kaW5nMTAuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb24sCiAgICAgIG5vZGU6IHIwLAogICAgICBjaGVja3BvaW50OiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGVuY29kaW5nMTRfMS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgZGlnZXN0OiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGVuY29kaW5nMTRfMi5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgb3B0aW1pc3RpYzogKGZsYWdzICYgNCkgIT09IDAsCiAgICAgIHRyYWNlOiAoZmxhZ3MgJiA4KSAhPT0gMCA/IGVuY29kaW5nMTRfNC5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL29wbG9nLW1lc3NhZ2UKY29uc3QgZW5jb2RpbmcxNSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIHN3aXRjaCAobS52ZXJzaW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICBlbmNvZGluZzEyLnByZWVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBjYXNlIDE6CiAgICAgICAgZW5jb2RpbmcxMy5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAyOgogICAgICAgIGVuY29kaW5nMTQucHJlZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uJykKICAgIH0KICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgc3dpdGNoIChtLnZlcnNpb24pIHsKICAgICAgY2FzZSAwOgogICAgICAgIGVuY29kaW5nMTIuZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgMToKICAgICAgICBlbmNvZGluZzEzLmVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBjYXNlIDI6CiAgICAgICAgZW5jb2RpbmcxNC5lbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb24nKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHN3aXRjaCAodmVyc2lvbikgewogICAgICBjYXNlIDA6IHsKICAgICAgICBjb25zdCBkZWNvZGVkID0gZW5jb2RpbmcxMi5kZWNvZGUoc3RhdGUsIHZlcnNpb24pCiAgICAgICAgcmV0dXJuIGRlY29kZWQKICAgICAgfQogICAgICBjYXNlIDE6IHsKICAgICAgICBjb25zdCBkZWNvZGVkID0gZW5jb2RpbmcxMy5kZWNvZGUoc3RhdGUsIHZlcnNpb24pCiAgICAgICAgcmV0dXJuIGRlY29kZWQKICAgICAgfQogICAgICBjYXNlIDI6IHsKICAgICAgICBjb25zdCBkZWNvZGVkID0gZW5jb2RpbmcxNC5kZWNvZGUoc3RhdGUsIHZlcnNpb24pCiAgICAgICAgcmV0dXJuIGRlY29kZWQKICAgICAgfQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbicpCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvaW5mby12MS5wZW5kaW5nSW5kZXhlcnMKY29uc3QgZW5jb2RpbmcxNl8xID0gYy5hcnJheShjLmZpeGVkMzIpCgovLyBAYXV0b2Jhc2UvaW5mby12MQpjb25zdCBlbmNvZGluZzE2ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5tZW1iZXJzKQogICAgZW5jb2RpbmcxNl8xLnByZWVuY29kZShzdGF0ZSwgbS5wZW5kaW5nSW5kZXhlcnMpCiAgICBlbmNvZGluZzEucHJlZW5jb2RlKHN0YXRlLCBtLmluZGV4ZXJzKQogICAgZW5jb2RpbmcxLnByZWVuY29kZShzdGF0ZSwgbS5oZWFkcykKICAgIGVuY29kaW5nMS5wcmVlbmNvZGUoc3RhdGUsIG0udmlld3MpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubWVtYmVycykKICAgIGVuY29kaW5nMTZfMS5lbmNvZGUoc3RhdGUsIG0ucGVuZGluZ0luZGV4ZXJzKQogICAgZW5jb2RpbmcxLmVuY29kZShzdGF0ZSwgbS5pbmRleGVycykKICAgIGVuY29kaW5nMS5lbmNvZGUoc3RhdGUsIG0uaGVhZHMpCiAgICBlbmNvZGluZzEuZW5jb2RlKHN0YXRlLCBtLnZpZXdzKQogIH0sCiAgZGVjb2RlKHN0YXRlLCB2ZXJzaW9uKSB7CiAgICBpZiAodmVyc2lvbiA9PT0gdW5kZWZpbmVkKSB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gZW5jb2RpbmcxNl8xLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIyID0gZW5jb2RpbmcxLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIzID0gZW5jb2RpbmcxLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHI0ID0gZW5jb2RpbmcxLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICBtZW1iZXJzOiByMCwKICAgICAgcGVuZGluZ0luZGV4ZXJzOiByMSwKICAgICAgaW5kZXhlcnM6IHIyLAogICAgICBoZWFkczogcjMsCiAgICAgIHZpZXdzOiByNAogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL2luZm8tdjIucGVuZGluZ0luZGV4ZXJzCmNvbnN0IGVuY29kaW5nMTdfMSA9IGVuY29kaW5nMTZfMQoKLy8gQGF1dG9iYXNlL2luZm8tdjIKY29uc3QgZW5jb2RpbmcxNyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubWVtYmVycykKICAgIGVuY29kaW5nMTdfMS5wcmVlbmNvZGUoc3RhdGUsIG0ucGVuZGluZ0luZGV4ZXJzKQogICAgZW5jb2RpbmcxLnByZWVuY29kZShzdGF0ZSwgbS5pbmRleGVycykKICAgIGVuY29kaW5nMS5wcmVlbmNvZGUoc3RhdGUsIG0uaGVhZHMpCiAgICBlbmNvZGluZzEucHJlZW5jb2RlKHN0YXRlLCBtLnZpZXdzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5lbmNyeXB0aW9uTGVuZ3RoKQogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMSBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5lbnRyb3B5KSBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmVudHJvcHkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gbS5lbnRyb3B5ID8gMSA6IDAKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLm1lbWJlcnMpCiAgICBlbmNvZGluZzE3XzEuZW5jb2RlKHN0YXRlLCBtLnBlbmRpbmdJbmRleGVycykKICAgIGVuY29kaW5nMS5lbmNvZGUoc3RhdGUsIG0uaW5kZXhlcnMpCiAgICBlbmNvZGluZzEuZW5jb2RlKHN0YXRlLCBtLmhlYWRzKQogICAgZW5jb2RpbmcxLmVuY29kZShzdGF0ZSwgbS52aWV3cykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZW5jcnlwdGlvbkxlbmd0aCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLmVudHJvcHkpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0uZW50cm9weSkKICB9LAogIGRlY29kZShzdGF0ZSwgdmVyc2lvbikgewogICAgaWYgKHZlcnNpb24gPT09IHVuZGVmaW5lZCkgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGVuY29kaW5nMTdfMS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMiA9IGVuY29kaW5nMS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMyA9IGVuY29kaW5nMS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByNCA9IGVuY29kaW5nMS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByNSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbiwKICAgICAgbWVtYmVyczogcjAsCiAgICAgIHBlbmRpbmdJbmRleGVyczogcjEsCiAgICAgIGluZGV4ZXJzOiByMiwKICAgICAgaGVhZHM6IHIzLAogICAgICB2aWV3czogcjQsCiAgICAgIGVuY3J5cHRpb25MZW5ndGg6IHI1LAogICAgICBlbnRyb3B5OiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL2luZm8KY29uc3QgZW5jb2RpbmcxOCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIHN3aXRjaCAobS52ZXJzaW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgY2FzZSAxOgogICAgICAgIGVuY29kaW5nMTYucHJlZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgMjoKICAgICAgICBlbmNvZGluZzE3LnByZWVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbicpCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIHN3aXRjaCAobS52ZXJzaW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgY2FzZSAxOgogICAgICAgIGVuY29kaW5nMTYuZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgMjoKICAgICAgICBlbmNvZGluZzE3LmVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbicpCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgc3dpdGNoICh2ZXJzaW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgY2FzZSAxOiB7CiAgICAgICAgY29uc3QgZGVjb2RlZCA9IGVuY29kaW5nMTYuZGVjb2RlKHN0YXRlLCB2ZXJzaW9uKQogICAgICAgIGNvbnN0IG1hcCA9IGV4dGVybmFsMC5pbmZvTGVnYWN5TWFwCiAgICAgICAgcmV0dXJuIG1hcChkZWNvZGVkKQogICAgICB9CiAgICAgIGNhc2UgMjogewogICAgICAgIGNvbnN0IGRlY29kZWQgPSBlbmNvZGluZzE3LmRlY29kZShzdGF0ZSwgdmVyc2lvbikKICAgICAgICByZXR1cm4gZGVjb2RlZAogICAgICB9CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uJykKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9tZW1iZXIKY29uc3QgZW5jb2RpbmcxOSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDIgc28gYWx3YXlzIG9uZSBieXRlCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSAobS5pc0luZGV4ZXIgPyAxIDogMCkgfCAobS5pc1JlbW92ZWQgPyAyIDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgaXNJbmRleGVyOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgaXNSZW1vdmVkOiAoZmxhZ3MgJiAyKSAhPT0gMCwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgZW5jb2RpbmcyMCA9IGV4dGVybmFsMC5MaW5lYXJpemVyS2V5CgovLyBAYXV0b2Jhc2UvbGluZWFyaXplci11cGRhdGUKY29uc3QgZW5jb2RpbmcyMSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmJhdGNoKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zeXN0ZW1MZW5ndGgpCiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAxIHNvIGFsd2F5cyBvbmUgYnl0ZQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IG0uaW5kZXhlcnMgPyAxIDogMAoKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmJhdGNoKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zeXN0ZW1MZW5ndGgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjIgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjMgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGtleTogcjAsCiAgICAgIGxlbmd0aDogcjEsCiAgICAgIGJhdGNoOiByMiwKICAgICAgc3lzdGVtTGVuZ3RoOiByMywKICAgICAgaW5kZXhlcnM6IChmbGFncyAmIDEpICE9PSAwCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvZW5jcnlwdGlvbi1kZXNjcmlwdG9yCmNvbnN0IGVuY29kaW5nMjIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnR5cGUpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0ucGF5bG9hZCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS50eXBlKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnBheWxvYWQpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy5idWZmZXIuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHR5cGU6IHIwLAogICAgICBwYXlsb2FkOiByMQogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL21hbmlmZXN0LWRhdGEKY29uc3QgZW5jb2RpbmcyMyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDIgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0ubGVnYWN5QmxvY2tzKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlZ2FjeUJsb2NrcykKICAgIGlmIChtLm5hbWVzcGFjZSkgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gKG0ubGVnYWN5QmxvY2tzID8gMSA6IDApIHwgKG0ubmFtZXNwYWNlID8gMiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0ubGVnYWN5QmxvY2tzKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlZ2FjeUJsb2NrcykKICAgIGlmIChtLm5hbWVzcGFjZSkgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiByMCwKICAgICAgbGVnYWN5QmxvY2tzOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMCwKICAgICAgbmFtZXNwYWNlOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL3VzZXItdmlldy10cmFjZS5ibG9ja3MKY29uc3QgZW5jb2RpbmcyNF8xID0gZW5jb2RpbmcxMV8wCgovLyBAYXV0b2Jhc2UvdXNlci12aWV3LXRyYWNlCmNvbnN0IGVuY29kaW5nMjQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnZpZXcpCiAgICBlbmNvZGluZzI0XzEucHJlZW5jb2RlKHN0YXRlLCBtLmJsb2NrcykKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52aWV3KQogICAgZW5jb2RpbmcyNF8xLmVuY29kZShzdGF0ZSwgbS5ibG9ja3MpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gZW5jb2RpbmcyNF8xLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2aWV3OiByMCwKICAgICAgYmxvY2tzOiByMQogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL3RyYWNlLnVzZXIsIGRlZmVycmVkIGR1ZSB0byByZWN1c2l2ZSB1c2UKY29uc3QgZW5jb2RpbmcxMV8yID0gYy5hcnJheShlbmNvZGluZzI0KQoKZnVuY3Rpb24gc2V0VmVyc2lvbih2KSB7CiAgdmVyc2lvbiA9IHYKfQoKZnVuY3Rpb24gZW5jb2RlKG5hbWUsIHZhbHVlLCB2ID0gVkVSU0lPTikgewogIHZlcnNpb24gPSB2CiAgcmV0dXJuIGMuZW5jb2RlKGdldEVuY29kaW5nKG5hbWUpLCB2YWx1ZSkKfQoKZnVuY3Rpb24gZGVjb2RlKG5hbWUsIGJ1ZmZlciwgdiA9IFZFUlNJT04pIHsKICB2ZXJzaW9uID0gdgogIHJldHVybiBjLmRlY29kZShnZXRFbmNvZGluZyhuYW1lKSwgYnVmZmVyKQp9CgpmdW5jdGlvbiBnZXRFbnVtKG5hbWUpIHsKICBzd2l0Y2ggKG5hbWUpIHsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcignRW51bSBub3QgZm91bmQgJyArIG5hbWUpCiAgfQp9CgpmdW5jdGlvbiBnZXRFbmNvZGluZyhuYW1lKSB7CiAgc3dpdGNoIChuYW1lKSB7CiAgICBjYXNlICdAYXV0b2Jhc2UvY2hlY2tvdXQnOgogICAgICByZXR1cm4gZW5jb2RpbmcwCiAgICBjYXNlICdAYXV0b2Jhc2UvY2xvY2snOgogICAgICByZXR1cm4gZW5jb2RpbmcxCiAgICBjYXNlICdAYXV0b2Jhc2UvaW5kZXgtY2hlY2twb2ludCc6CiAgICAgIHJldHVybiBlbmNvZGluZzIKICAgIGNhc2UgJ0BhdXRvYmFzZS93YWtldXAnOgogICAgICByZXR1cm4gZW5jb2RpbmczCiAgICBjYXNlICdAYXV0b2Jhc2UvYm9vdC1yZWNvcmQtdjAnOgogICAgICByZXR1cm4gZW5jb2Rpbmc0CiAgICBjYXNlICdAYXV0b2Jhc2UvYm9vdC1yZWNvcmQtcmF3JzoKICAgICAgcmV0dXJuIGVuY29kaW5nNQogICAgY2FzZSAnQGF1dG9iYXNlL2Jvb3QtcmVjb3JkJzoKICAgICAgcmV0dXJuIGVuY29kaW5nNgogICAgY2FzZSAnQGF1dG9iYXNlL2NoZWNrcG9pbnRlcic6CiAgICAgIHJldHVybiBlbmNvZGluZzcKICAgIGNhc2UgJ0BhdXRvYmFzZS9jaGVja3BvaW50JzoKICAgICAgcmV0dXJuIGVuY29kaW5nOAogICAgY2FzZSAnQGF1dG9iYXNlL2RpZ2VzdCc6CiAgICAgIHJldHVybiBlbmNvZGluZzkKICAgIGNhc2UgJ0BhdXRvYmFzZS9ub2RlJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTAKICAgIGNhc2UgJ0BhdXRvYmFzZS90cmFjZSc6CiAgICAgIHJldHVybiBlbmNvZGluZzExCiAgICBjYXNlICdAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZS12MCc6CiAgICAgIHJldHVybiBlbmNvZGluZzEyCiAgICBjYXNlICdAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZS12MSc6CiAgICAgIHJldHVybiBlbmNvZGluZzEzCiAgICBjYXNlICdAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZS12Mic6CiAgICAgIHJldHVybiBlbmNvZGluZzE0CiAgICBjYXNlICdAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZSc6CiAgICAgIHJldHVybiBlbmNvZGluZzE1CiAgICBjYXNlICdAYXV0b2Jhc2UvaW5mby12MSc6CiAgICAgIHJldHVybiBlbmNvZGluZzE2CiAgICBjYXNlICdAYXV0b2Jhc2UvaW5mby12Mic6CiAgICAgIHJldHVybiBlbmNvZGluZzE3CiAgICBjYXNlICdAYXV0b2Jhc2UvaW5mbyc6CiAgICAgIHJldHVybiBlbmNvZGluZzE4CiAgICBjYXNlICdAYXV0b2Jhc2UvbWVtYmVyJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTkKICAgIGNhc2UgJ0BhdXRvYmFzZS9saW5lYXJpemVyLWtleSc6CiAgICAgIHJldHVybiBlbmNvZGluZzIwCiAgICBjYXNlICdAYXV0b2Jhc2UvbGluZWFyaXplci11cGRhdGUnOgogICAgICByZXR1cm4gZW5jb2RpbmcyMQogICAgY2FzZSAnQGF1dG9iYXNlL2VuY3J5cHRpb24tZGVzY3JpcHRvcic6CiAgICAgIHJldHVybiBlbmNvZGluZzIyCiAgICBjYXNlICdAYXV0b2Jhc2UvbWFuaWZlc3QtZGF0YSc6CiAgICAgIHJldHVybiBlbmNvZGluZzIzCiAgICBjYXNlICdAYXV0b2Jhc2UvdXNlci12aWV3LXRyYWNlJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMjQKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcignRW5jb2RlciBub3QgZm91bmQgJyArIG5hbWUpCiAgfQp9CgpmdW5jdGlvbiBnZXRTdHJ1Y3QobmFtZSwgdiA9IFZFUlNJT04pIHsKICBjb25zdCBlbmMgPSBnZXRFbmNvZGluZyhuYW1lKQogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgZW5jLnByZWVuY29kZShzdGF0ZSwgbSkKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgZW5jLmVuY29kZShzdGF0ZSwgbSkKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgcmV0dXJuIGVuYy5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZXNvbHZlU3RydWN0ID0gZ2V0U3RydWN0IC8vIGNvbXBhdAoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgcmVzb2x2ZVN0cnVjdCwKICBnZXRTdHJ1Y3QsCiAgZ2V0RW51bSwKICBnZXRFbmNvZGluZywKICBlbmNvZGUsCiAgZGVjb2RlLAogIHNldFZlcnNpb24sCiAgdmVyc2lvbgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCmNvbnN0IGRlYm91bmNlaWZ5ID0gcmVxdWlyZSgnZGVib3VuY2VpZnknKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgaHlwZXJjb3JlSWQgPSByZXF1aXJlKCdoeXBlcmNvcmUtaWQtZW5jb2RpbmcnKQpjb25zdCBhc3NlcnQgPSByZXF1aXJlKCduYW5vYXNzZXJ0JykKY29uc3QgU2lnbmFsUHJvbWlzZSA9IHJlcXVpcmUoJ3NpZ25hbC1wcm9taXNlJykKY29uc3QgQ29yZUNvdXBsZXIgPSByZXF1aXJlKCdjb3JlLWNvdXBsZXInKQpjb25zdCBQcm90b211eFdha2V1cCA9IHJlcXVpcmUoJ3Byb3RvbXV4LXdha2V1cCcpCmNvbnN0IHJycCA9IHJlcXVpcmUoJ3Jlc29sdmUtcmVqZWN0LXByb21pc2UnKQpjb25zdCBIeXBlcmNvcmUgPSByZXF1aXJlKCdoeXBlcmNvcmUnKQpjb25zdCBTY29wZUxvY2sgPSByZXF1aXJlKCdzY29wZS1sb2NrJykKCmNvbnN0IExvY2FsU3RhdGUgPSByZXF1aXJlKCcuL2xpYi9sb2NhbC1zdGF0ZS5qcycpCmNvbnN0IExpbmVhcml6ZXIgPSByZXF1aXJlKCcuL2xpYi9saW5lYXJpemVyLmpzJykKY29uc3QgU3lzdGVtVmlldyA9IHJlcXVpcmUoJy4vbGliL3N5c3RlbS5qcycpCmNvbnN0IHsgRW5jcnlwdGlvblZpZXcgfSA9IHJlcXVpcmUoJy4vbGliL2VuY3J5cHRpb24uanMnKQpjb25zdCBVcGRhdGVDaGFuZ2VzID0gcmVxdWlyZSgnLi9saWIvdXBkYXRlcy5qcycpCmNvbnN0IG1lc3NhZ2VzID0gcmVxdWlyZSgnLi9saWIvbWVzc2FnZXMuanMnKQpjb25zdCBUaW1lciA9IHJlcXVpcmUoJy4vbGliL3RpbWVyLmpzJykKY29uc3QgV3JpdGVyID0gcmVxdWlyZSgnLi9saWIvd3JpdGVyLmpzJykKY29uc3QgeyBlbmNvZGVWYWx1ZSwgZGVjb2RlVmFsdWUgfSA9IHJlcXVpcmUoJy4vbGliL3ZhbHVlcy5qcycpCmNvbnN0IEFjdGl2ZVdyaXRlcnMgPSByZXF1aXJlKCcuL2xpYi9hY3RpdmUtd3JpdGVycy5qcycpCmNvbnN0IEF1dG9XYWtldXAgPSByZXF1aXJlKCcuL2xpYi93YWtldXAuanMnKQoKY29uc3QgRmFzdEZvcndhcmQgPSByZXF1aXJlKCcuL2xpYi9mYXN0LWZvcndhcmQuanMnKQpjb25zdCBBdXRvU3RvcmUgPSByZXF1aXJlKCcuL2xpYi9zdG9yZS5qcycpCmNvbnN0IEFwcGx5U3RhdGUgPSByZXF1aXJlKCcuL2xpYi9hcHBseS1zdGF0ZS5qcycpCmNvbnN0IEFwcGVuZEJhdGNoID0gcmVxdWlyZSgnLi9saWIvYXBwZW5kLWJhdGNoLmpzJykKY29uc3QgeyBQdWJsaWNBcHBseUNhbGxzIH0gPSByZXF1aXJlKCcuL2xpYi9hcHBseS1jYWxscy5qcycpCmNvbnN0IGJvb3QgPSByZXF1aXJlKCcuL2xpYi9ib290LmpzJykKY29uc3QgeyBNQVhfQVVUT0JBU0VfVkVSU0lPTiwgQk9PVF9SRUNPUkRfVkVSU0lPTiB9ID0gcmVxdWlyZSgnLi9saWIvY2Fwcy5qcycpCgpjb25zdCBpbnNwZWN0ID0gU3ltYm9sLmZvcignbm9kZWpzLnV0aWwuaW5zcGVjdC5jdXN0b20nKQpjb25zdCBJTlRFUlJVUFQgPSBuZXcgRXJyb3IoJ0FwcGx5IGludGVycnVwdGVkJykKY29uc3QgQklOQVJZX0VOQ09ESU5HID0gYy5mcm9tKCdiaW5hcnknKQoKY29uc3QgUkVDT1ZFUklFUyA9IDMKCi8vIGRlZmF1bHQgaXMgdG8gYXV0b21hdGljYWxseSBhY2sKY29uc3QgREVGQVVMVF9BQ0tfSU5URVJWQUwgPSAxMF8wMDAKY29uc3QgREVGQVVMVF9BQ0tfVEhSRVNIT0xEID0gNAoKY29uc3QgUkVNT1RFX0FERF9CQVRDSCA9IDY0CmNvbnN0IFJFTU9URV9BRERfQkFUQ0hfU0FOSVRZID0gNDA5Ngpjb25zdCBNSU5fRkZfV0FJVCA9IDMwMF8wMDAgLy8gd2FpdCBhdCBsZWFzdCA1bWluIGJlZm9yZSBhdHRlbXB0aW5nIHRvIGZmIGFnYWluIGFmdGVyIGZhaWx1cmUKCmNsYXNzIFdha2V1cEhhbmRsZXIgewogIGNvbnN0cnVjdG9yKGJhc2UsIGRpc2NvdmVyeUtleSkgewogICAgdGhpcy5hY3RpdmUgPSB0cnVlCiAgICB0aGlzLmRpc2NvdmVyeUtleSA9IGRpc2NvdmVyeUtleQogICAgdGhpcy5iYXNlID0gYmFzZQogIH0KCiAgb25wZWVyYWN0aXZlKHBlZXIsIHNlc3Npb24pIHsKICAgIHRoaXMuYmFzZS5fYnVtcFdha2V1cFBlZXIocGVlcikKICB9CgogIG9ubG9va3VwKHJlcSwgcGVlciwgc2Vzc2lvbikgewogICAgY29uc3Qgd2FrZXVwID0gdGhpcy5iYXNlLl9nZXRXYWtldXAoKQogICAgaWYgKHdha2V1cC5sZW5ndGggPT09IDApIHJldHVybgogICAgc2Vzc2lvbi5hbm5vdW5jZShwZWVyLCB3YWtldXApCiAgfQoKICBvbmFubm91bmNlKHdha2V1cCwgcGVlciwgc2Vzc2lvbikgewogICAgaWYgKHRoaXMuYmFzZS5pc0Zhc3RGb3J3YXJkaW5nKCkpIHsKICAgICAgdGhpcy5iYXNlLl9uZWVkc1dha2V1cFJlcXVlc3QgPSB0cnVlCiAgICAgIHJldHVybgogICAgfQogICAgdGhpcy5iYXNlLmhpbnRXYWtldXAod2FrZXVwKQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBBdXRvYmFzZSBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yKHN0b3JlLCBib290c3RyYXAsIGhhbmRsZXJzID0ge30pIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGJvb3RzdHJhcCkpIGJvb3RzdHJhcCA9IGJvb3RzdHJhcFswXSAvLyBUT0RPOiBqdXN0IGEgcXVpY2sgY29tcGF0LCBsZXRzIHJlbW92ZSBzb29uCgogICAgaWYgKGJvb3RzdHJhcCAmJiB0eXBlb2YgYm9vdHN0cmFwICE9PSAnc3RyaW5nJyAmJiAhYjRhLmlzQnVmZmVyKGJvb3RzdHJhcCkpIHsKICAgICAgaGFuZGxlcnMgPSBib290c3RyYXAKICAgICAgYm9vdHN0cmFwID0gbnVsbAogICAgfQoKICAgIHN1cGVyKCkKCiAgICBjb25zdCBrZXkgPSBib290c3RyYXAgPyB0b0tleShib290c3RyYXApIDogbnVsbAoKICAgIHRoaXMuaWQgPSBudWxsCiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy5kaXNjb3ZlcnlLZXkgPSBudWxsCiAgICB0aGlzLmJhY2tvZmYgPSBoYW5kbGVycy5iYWNrb2ZmIHx8IG51bGwKCiAgICB0aGlzLmtleVBhaXIgPSBudWxsCiAgICB0aGlzLnZhbHVlRW5jb2RpbmcgPSBjLmZyb20oaGFuZGxlcnMudmFsdWVFbmNvZGluZyB8fCAnYmluYXJ5JykKICAgIHRoaXMuc3RvcmUgPSBzdG9yZQogICAgdGhpcy5nbG9iYWxDYWNoZSA9IHN0b3JlLmdsb2JhbENhY2hlIHx8IG51bGwKICAgIHRoaXMubWlncmF0ZWQgPSBmYWxzZQoKICAgIHRoaXMuZW5jcnlwdGVkID0gaGFuZGxlcnMuZW5jcnlwdGVkIHx8ICEhaGFuZGxlcnMuZW5jcnlwdGlvbktleQogICAgdGhpcy5lbmNyeXB0ID0gISFoYW5kbGVycy5lbmNyeXB0CiAgICB0aGlzLmVuY3J5cHRpb25LZXkgPSBudWxsCiAgICB0aGlzLmVuY3J5cHRpb24gPSBudWxsCgogICAgdGhpcy5hY3RpdmVCYXRjaCA9IG51bGwgLy8gbWFpbnRhaW5lZCBieSB0aGUgYXBwZW5kLWJhdGNoCgogICAgdGhpcy5sb2NhbCA9IG51bGwKICAgIHRoaXMubG9jYWxXcml0ZXIgPSBudWxsCiAgICB0aGlzLmlzSW5kZXhlciA9IGZhbHNlCgogICAgdGhpcy5hY3RpdmVXcml0ZXJzID0gbmV3IEFjdGl2ZVdyaXRlcnMoKQogICAgdGhpcy5saW5lYXJpemVyID0gbnVsbAogICAgdGhpcy51cGRhdGluZyA9IGZhbHNlCgogICAgdGhpcy5udWtlVGlwID0gISFoYW5kbGVycy5udWtlVGlwCgogICAgdGhpcy53YWtldXBPd25lciA9ICFoYW5kbGVycy53YWtldXAKICAgIHRoaXMud2FrZXVwQ2FwYWJpbGl0eSA9IG51bGwKICAgIHRoaXMud2FrZXVwUHJvdG9jb2wgPSBoYW5kbGVycy53YWtldXAgfHwgbmV3IFByb3RvbXV4V2FrZXVwKCkKICAgIHRoaXMud2FrZXVwU2Vzc2lvbiA9IG51bGwKCiAgICB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwID0gbnVsbAoKICAgIHRoaXMuZmFzdEZvcndhcmRFbmFibGVkID0gaGFuZGxlcnMuZmFzdEZvcndhcmQgIT09IGZhbHNlCiAgICB0aGlzLmZhc3RGb3J3YXJkaW5nID0gbnVsbAogICAgdGhpcy5mYXN0Rm9yd2FyZFRvID0gbnVsbAogICAgdGhpcy5mYXN0Rm9yd2FyZEZhaWxlZEF0ID0gMAogICAgdGhpcy5mYXN0Rm9yd2FyZE1pbmltdW0gPSBGYXN0Rm9yd2FyZC5NSU5JTVVNCgogICAgdGhpcy5iaWdCYXRjaGVzID0gISFoYW5kbGVycy5iaWdCYXRjaGVzCgogICAgdGhpcy5fYm9vdHN0cmFwV3JpdGVycyA9IFtdIC8vIG1pZ2h0IGNvbnRhaW4gZHVwcywgYnV0IHRoYXRzIG9rCiAgICB0aGlzLl9ib290c3RyYXBXcml0ZXJzQ2hhbmdlZCA9IGZhbHNlCgogICAgdGhpcy5fZmx1c2hTaWduYWwgPSBuZXcgU2lnbmFsUHJvbWlzZSgpCiAgICB0aGlzLl9mbHVzaGluZyA9IDAKCiAgICB0aGlzLl9jaGVja1dyaXRlcnMgPSBbXQogICAgdGhpcy5fb3B0aW1pc3RpYyA9IC0xCiAgICB0aGlzLl9hcHBlbmRlZCA9IDAKICAgIHRoaXMuX2FwcGVuZGluZyA9IG51bGwKICAgIHRoaXMuX3dha2V1cCA9IG5ldyBBdXRvV2FrZXVwKHRoaXMpCiAgICB0aGlzLl93YWtldXBIaW50cyA9IG5ldyBNYXAoKQogICAgdGhpcy5fd2FrZXVwUGVlckJvdW5kID0gdGhpcy5fd2FrZXVwUGVlci5iaW5kKHRoaXMpCiAgICB0aGlzLl9jb3VwbGVyID0gbnVsbAoKICAgIHRoaXMuX3VwZGF0ZUxvY2FsQ29yZSA9IG51bGwKICAgIHRoaXMuX2xvY2sgPSBuZXcgU2NvcGVMb2NrKCkKCiAgICB0aGlzLl9uZWVkc1dha2V1cFJlcXVlc3QgPSBmYWxzZQogICAgdGhpcy5fbmVlZHNXYWtldXAgPSB0cnVlCiAgICB0aGlzLl9uZWVkc1dha2V1cEhlYWRzID0gdHJ1ZQoKICAgIHRoaXMuX3VwZGF0ZXMgPSBbXQogICAgdGhpcy5faGFuZGxlcnMgPSBoYW5kbGVycyB8fCB7fQogICAgdGhpcy5fd2FybiA9IGVtaXRXYXJuaW5nLmJpbmQodGhpcykKICAgIHRoaXMuX2xhc3RFcnJvciA9IG51bGwKCiAgICB0aGlzLl9kcmFpbmluZyA9IGZhbHNlCiAgICB0aGlzLl93cml0YWJsZSA9IG51bGwKICAgIHRoaXMuX2FkdmFuY2luZyA9IG51bGwKICAgIHRoaXMuX2ludGVycnVwdGluZyA9IGZhbHNlCiAgICB0aGlzLl9jYXVnaHR1cCA9IGZhbHNlCgogICAgdGhpcy5wYXVzZWQgPSBmYWxzZQoKICAgIHRoaXMuX2J1bXAgPSBkZWJvdW5jZWlmeSgoKSA9PiB7CiAgICAgIHRoaXMuX2FkdmFuY2luZyA9IHRoaXMuX2FkdmFuY2UoKQogICAgICByZXR1cm4gdGhpcy5fYWR2YW5jaW5nCiAgICB9KQoKICAgIHRoaXMuX29ucmVtb3Rld3JpdGVyY2hhbmdlQm91bmQgPSB0aGlzLl9vbnJlbW90ZXdyaXRlcmNoYW5nZS5iaW5kKHRoaXMpCiAgICB0aGlzLl9vbmxvY2Fsd3JpdGVyY2hhbmdlQm91bmQgPSB0aGlzLl9vbmxvY2Fsd3JpdGVyY2hhbmdlLmJpbmQodGhpcykKCiAgICB0aGlzLl9wcmVvcGVuID0gbnVsbAoKICAgIHRoaXMuX2hhc09wZW4gPSAhIXRoaXMuX2hhbmRsZXJzLm9wZW4KICAgIHRoaXMuX2hhc0FwcGx5ID0gISF0aGlzLl9oYW5kbGVycy5hcHBseQogICAgdGhpcy5faGFzT3B0aW1pc3RpY0FwcGx5ID0gISF0aGlzLl9oYW5kbGVycy5vcHRpbWlzdGljCiAgICB0aGlzLl9oYXNVcGRhdGUgPSAhIXRoaXMuX2hhbmRsZXJzLnVwZGF0ZQogICAgdGhpcy5faGFzQ2xvc2UgPSAhIXRoaXMuX2hhbmRsZXJzLmNsb3NlCgogICAgdGhpcy5fdmlld1N0b3JlID0gbmV3IEF1dG9TdG9yZSh0aGlzKQogICAgdGhpcy5fYXBwbHlTdGF0ZSA9IG51bGwKCiAgICB0aGlzLnZpZXcgPSBudWxsCiAgICB0aGlzLmNvcmUgPSBudWxsCiAgICB0aGlzLnZlcnNpb24gPSAtMQogICAgdGhpcy5pbnRlcnJ1cHRlZCA9IG51bGwKICAgIHRoaXMucmVjb3ZlcmllcyA9IFJFQ09WRVJJRVMKCiAgICBjb25zdCB7IGFja0ludGVydmFsID0gREVGQVVMVF9BQ0tfSU5URVJWQUwsIGFja1RocmVzaG9sZCA9IERFRkFVTFRfQUNLX1RIUkVTSE9MRCB9ID0gaGFuZGxlcnMKCiAgICB0aGlzLl9hY2tJbnRlcnZhbCA9IGFja0ludGVydmFsCiAgICB0aGlzLl9hY2tUaHJlc2hvbGQgPSBhY2tUaHJlc2hvbGQKICAgIHRoaXMuX2Fja1RpY2tUaHJlc2hvbGQgPSBhY2tUaHJlc2hvbGQKICAgIHRoaXMuX2Fja1RpY2sgPSAwCgogICAgdGhpcy5fYWNrVGltZXIgPSBudWxsCiAgICB0aGlzLl9hY2tpbmcgPSBmYWxzZQoKICAgIHRoaXMuX3dhaXRpbmcgPSBuZXcgU2lnbmFsUHJvbWlzZSgpCgogICAgdGhpcy52aWV3ID0gdGhpcy5faGFzT3BlbgogICAgICA/IHRoaXMuX2hhbmRsZXJzLm9wZW4odGhpcy5fdmlld1N0b3JlLCBuZXcgUHVibGljQXBwbHlDYWxscyh0aGlzKSkKICAgICAgOiBudWxsCiAgICB0aGlzLmNvcmUgPSB0aGlzLl92aWV3U3RvcmUuZ2V0KHsgbmFtZTogJ19zeXN0ZW0nIH0pCgogICAgaWYgKHRoaXMuZmFzdEZvcndhcmRFbmFibGVkICYmIGlzT2JqZWN0KGhhbmRsZXJzLmZhc3RGb3J3YXJkKSkgewogICAgICB0aGlzLl9ydW5GYXN0Rm9yd2FyZCgKICAgICAgICBuZXcgRmFzdEZvcndhcmQodGhpcywgaGFuZGxlcnMuZmFzdEZvcndhcmQua2V5LCB7IHZlcmlmaWVkOiBmYWxzZSB9KQogICAgICApLmNhdGNoKG5vb3ApCiAgICB9CgogICAgdGhpcy5yZWFkeSgpLmNhdGNoKHNhZmV0eUNhdGNoKQogIH0KCiAgW2luc3BlY3RdKGRlcHRoLCBvcHRzKSB7CiAgICBsZXQgaW5kZW50ID0gJycKICAgIGlmICh0eXBlb2Ygb3B0cy5pbmRlbnRhdGlvbkx2bCA9PT0gJ251bWJlcicpIHsKICAgICAgd2hpbGUgKGluZGVudC5sZW5ndGggPCBvcHRzLmluZGVudGF0aW9uTHZsKSBpbmRlbnQgKz0gJyAnCiAgICB9CgogICAgcmV0dXJuIGluZGVudCArICdBdXRvYmFzZSB7IC4uLiB9JwogIH0KCiAgLy8ganVzdCBjb21wYXQsIHVzZSAua2V5CiAgZ2V0IGJvb3RzdHJhcCgpIHsKICAgIHJldHVybiB0aGlzLmtleQogIH0KCiAgLy8gVE9ETzogY29tcGF0LCB3aWxsIGJlIHJlbW92ZWQKICBnZXQgYm9vdHN0cmFwcygpIHsKICAgIHJldHVybiBbdGhpcy5ib290c3RyYXBdCiAgfQoKICBnZXQgYXBwZW5kaW5nKCkgewogICAgcmV0dXJuIHRoaXMuX2FwcGVuZGluZyAhPT0gbnVsbCAmJiB0aGlzLl9hcHBlbmRpbmcubGVuZ3RoID4gMAogIH0KCiAgZ2V0IHdyaXRhYmxlKCkgewogICAgcmV0dXJuIHRoaXMubG9jYWxXcml0ZXIgIT09IG51bGwgJiYgIXRoaXMubG9jYWxXcml0ZXIuaXNSZW1vdmVkCiAgfQoKICBnZXQgYWNrYWJsZSgpIHsKICAgIHJldHVybiB0aGlzLmxvY2FsV3JpdGVyICE9PSBudWxsICYmIHRoaXMubG9jYWxXcml0ZXIuaXNBY3RpdmVJbmRleGVyCiAgfQoKICBnZXQgc2lnbmVkTGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5zaWduZWRMZW5ndGgKICB9CgogIGdldCBpbmRleGVkTGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuX2FwcGx5U3RhdGUgPyB0aGlzLl9hcHBseVN0YXRlLmluZGV4ZWRMZW5ndGggOiAwCiAgfQoKICBnZXQgbGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5sZW5ndGgKICB9CgogIGdldCBmbHVzaGluZygpIHsKICAgIHJldHVybiB0aGlzLl9mbHVzaGluZyA+IDAKICB9CgogIGhhc2goKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLnRyZWVIYXNoKCkKICB9CgogIC8vIGRlcHJlY2F0ZWQsIHVzZSAuY29yZS5rZXkKICBnZXRTeXN0ZW1LZXkoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLmtleQogIH0KCiAgZ2V0IHN5c3RlbSgpIHsKICAgIHJldHVybiB0aGlzLl9hcHBseVN0YXRlICYmIHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtCiAgfQoKICAvLyBkZXByZWNhdGVkCiAgYXN5bmMgZ2V0SW5kZXhlZEluZm8oKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIHJldHVybiAoCiAgICAgIHRoaXMuX2FwcGx5U3RhdGUgJiYgdGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uZ2V0SW5kZXhlZEluZm8odGhpcy5fYXBwbHlTdGF0ZS5pbmRleGVkTGVuZ3RoKQogICAgKQogIH0KCiAgX2lzQWN0aXZlSW5kZXhlcigpIHsKICAgIHJldHVybiB0aGlzLmxvY2FsV3JpdGVyID8gdGhpcy5sb2NhbFdyaXRlci5pc0FjdGl2ZUluZGV4ZXIgOiBmYWxzZQogIH0KCiAgcmVwbGljYXRlKGlzSW5pdGlhdG9yLCBvcHRzKSB7CiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0b3JlLnJlcGxpY2F0ZShpc0luaXRpYXRvciwgb3B0cykKICAgIHRoaXMud2FrZXVwUHJvdG9jb2wuYWRkU3RyZWFtKHN0cmVhbSkKICAgIHJldHVybiBzdHJlYW0KICB9CgogIGhlYWRzKCkgewogICAgaWYgKCF0aGlzLl9hcHBseVN0YXRlIHx8ICF0aGlzLl9hcHBseVN0YXRlLm9wZW5lZCkgcmV0dXJuIFtdCiAgICBjb25zdCBub2RlcyA9IG5ldyBBcnJheSh0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5oZWFkcy5sZW5ndGgpCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmhlYWRzLmxlbmd0aDsgaSsrKQogICAgICBub2Rlc1tpXSA9IHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmhlYWRzW2ldCiAgICByZXR1cm4gbm9kZXMuc29ydChjb21wYXJlTm9kZXMpCiAgfQoKICBhc3luYyBleHBvcnQoKSB7CiAgICBjb25zdCBleHBvcnRpbmcgPSBbdGhpcy5zdG9yZS5zdG9yYWdlLmV4cG9ydCh0aGlzLmxvY2FsLmRpc2NvdmVyeUtleSksIHRoaXMuX3ZpZXdTdG9yZS5leHBvcnQoKV0KCiAgICBjb25zdCBbbG9jYWwsIHZpZXdzXSA9IGF3YWl0IFByb21pc2UuYWxsKGV4cG9ydGluZykKCiAgICByZXR1cm4gewogICAgICBsb2NhbCwKICAgICAgdmlld3MKICAgIH0KICB9CgogIGhpbnRXYWtldXAoaGludHMpIHsKICAgIGlmICghQXJyYXkuaXNBcnJheShoaW50cykpIGhpbnRzID0gW2hpbnRzXQogICAgZm9yIChjb25zdCB7IGtleSwgbGVuZ3RoIH0gb2YgaGludHMpIHsKICAgICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpCiAgICAgIGNvbnN0IHByZXYgPSB0aGlzLl93YWtldXBIaW50cy5nZXQoaGV4KQogICAgICBpZiAoIXByZXYgfHwgbGVuZ3RoID09PSAtMSB8fCBwcmV2IDwgbGVuZ3RoKSB0aGlzLl93YWtldXBIaW50cy5zZXQoaGV4LCBsZW5ndGgpCiAgICB9CiAgICB0aGlzLl9xdWV1ZUJ1bXAoKQogIH0KCiAgc2V0QmlnQmF0Y2hlcyhib29sID0gdHJ1ZSkgewogICAgdGhpcy5iaWdCYXRjaGVzID0gYm9vbAogIH0KCiAgX3F1ZXVlQnVtcCgpIHsKICAgIHRoaXMuX2J1bXAoKS5jYXRjaChzYWZldHlDYXRjaCkKICB9CgogIGFzeW5jIF9ydW5QcmVPcGVuKCkgewogICAgaWYgKHRoaXMuX2hhbmRsZXJzLndhaXQpIGF3YWl0IHRoaXMuX2hhbmRsZXJzLndhaXQoKQoKICAgIGF3YWl0IHRoaXMuc3RvcmUucmVhZHkoKQoKICAgIHRoaXMua2V5UGFpciA9IChhd2FpdCB0aGlzLl9oYW5kbGVycy5rZXlQYWlyKSB8fCBudWxsCgogICAgaWYgKHRoaXMuX2hhbmRsZXJzLmVuY3J5cHRpb25LZXkgIT09IG51bGwpIHsKICAgICAgdGhpcy5lbmNyeXB0aW9uS2V5ID0gYXdhaXQgdGhpcy5faGFuZGxlcnMuZW5jcnlwdGlvbktleQogICAgfQoKICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGJvb3QodGhpcy5zdG9yZSwgdGhpcy5rZXksIHsKICAgICAgZW5jcnlwdGlvbktleTogdGhpcy5lbmNyeXB0aW9uS2V5LAogICAgICBlbmNyeXB0OiB0aGlzLmVuY3J5cHQsCiAgICAgIGtleVBhaXI6IHRoaXMua2V5UGFpcgogICAgfSkKCiAgICB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwID0gcmVzdWx0LmJvb3RzdHJhcAogICAgdGhpcy5sb2NhbCA9IHJlc3VsdC5sb2NhbAoKICAgIHRoaXMua2V5ID0gcmVzdWx0LmJvb3RzdHJhcC5rZXkKICAgIHRoaXMuZGlzY292ZXJ5S2V5ID0gcmVzdWx0LmJvb3RzdHJhcC5kaXNjb3ZlcnlLZXkKICAgIHRoaXMuaWQgPSByZXN1bHQuYm9vdHN0cmFwLmlkCgogICAgdGhpcy5lbmNyeXB0aW9uS2V5ID0gcmVzdWx0LmVuY3J5cHRpb25LZXkKCiAgICBpZiAodGhpcy5lbmNyeXB0ZWQpIHsKICAgICAgYXNzZXJ0KHRoaXMuZW5jcnlwdGlvbktleSAhPT0gbnVsbCwgJ0VuY3J5cHRpb24ga2V5IGlzIGV4cGVjdGVkJykKICAgIH0KCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uS2V5KSB7CiAgICAgIHRoaXMuZW5jcnlwdGlvbiA9IG5ldyBFbmNyeXB0aW9uVmlldyh0aGlzLCBudWxsKQoKICAgICAgdGhpcy5sb2NhbC5zZXRFbmNyeXB0aW9uKHRoaXMuZ2V0V3JpdGVyRW5jcnlwdGlvbigpKQogICAgICB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwLnNldEVuY3J5cHRpb24odGhpcy5nZXRXcml0ZXJFbmNyeXB0aW9uKCkpCiAgICB9CgogICAgaWYgKHRoaXMubnVrZVRpcCkgYXdhaXQgdGhpcy5fbnVrZVRpcCgpCgogICAgdGhpcy5sb2NhbC5vbignYXBwZW5kJywgdGhpcy5fb25sb2NhbHdyaXRlcmNoYW5nZUJvdW5kKQoKICAgIHRoaXMud2FrZXVwQ2FwYWJpbGl0eSA9IChhd2FpdCB0aGlzLl9oYW5kbGVycy53YWtldXBDYXBhYmlsaXR5KSB8fCB7CiAgICAgIGtleTogdGhpcy5rZXksCiAgICAgIGRpc2NvdmVyeUtleTogdGhpcy5kaXNjb3ZlcnlLZXkKICAgIH0KICAgIHRoaXMuc2V0V2FrZXVwKHRoaXMud2FrZXVwQ2FwYWJpbGl0eS5rZXksIHRoaXMud2FrZXVwQ2FwYWJpbGl0eS5kaXNjb3ZlcnlLZXkpCiAgfQoKICBhc3luYyBfbnVrZVRpcEJhdGNoKGtleSwgbGVuZ3RoKSB7CiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoeyBrZXksIGFjdGl2ZTogZmFsc2UgfSkKICAgIGF3YWl0IGNvcmUucmVhZHkoKQoKICAgIGNvbnN0IGJhdGNoID0gY29yZS5zZXNzaW9uKHsgbmFtZTogJ2JhdGNoJyB9KQogICAgYXdhaXQgYmF0Y2gucmVhZHkoKQogICAgaWYgKGJhdGNoLmxlbmd0aCA+IGxlbmd0aCkgYXdhaXQgYmF0Y2gudHJ1bmNhdGUobGVuZ3RoKQogICAgYXdhaXQgYmF0Y2guY2xvc2UoKQoKICAgIGF3YWl0IGNvcmUuY2xvc2UoKQogIH0KCiAgLy8gVE9ETzogbm90IGF0b21pYyBhdG0sIHNvIG1vcmUgb2YgYSAodmVyeSB1c2VmdWwpIGRlYnVnIGhlbHBlcgogIGFzeW5jIF9udWtlVGlwKCkgewogICAgY29uc3QgcG9pbnRlciA9IGF3YWl0IHRoaXMubG9jYWwuZ2V0VXNlckRhdGEoJ2F1dG9iYXNlL2Jvb3QnKQogICAgaWYgKCFwb2ludGVyKSByZXR1cm4KCiAgICBjb25zdCBib290ID0gYy5kZWNvZGUobWVzc2FnZXMuQm9vdFJlY29yZCwgcG9pbnRlcikKCiAgICBhd2FpdCBMb2NhbFN0YXRlLmNsZWFyKHRoaXMubG9jYWwpCgogICAgYXdhaXQgdGhpcy5fbnVrZVRpcEJhdGNoKGJvb3Qua2V5LCBib290LnN5c3RlbUxlbmd0aCkKCiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoeyBrZXk6IGJvb3Qua2V5LCBhY3RpdmU6IGZhbHNlLCBlbmNyeXB0aW9uOiBudWxsIH0pCiAgICBjb25zdCBlbmNDb3JlID0gYXdhaXQgRW5jcnlwdGlvblZpZXcuc2V0U3lzdGVtRW5jcnlwdGlvbih0aGlzLCBjb3JlKQoKICAgIGNvbnN0IGJhdGNoID0gY29yZS5zZXNzaW9uKHsgbmFtZTogJ2JhdGNoJyB9KQogICAgYXdhaXQgYmF0Y2gucmVhZHkoKQoKICAgIGNvbnN0IGluZm8gPSBhd2FpdCBTeXN0ZW1WaWV3LmdldEluZGV4ZWRJbmZvKGJhdGNoLCBib290LnN5c3RlbUxlbmd0aCkKICAgIGF3YWl0IGJhdGNoLmNsb3NlKCkKCiAgICBmb3IgKGNvbnN0IHZpZXcgb2YgaW5mby52aWV3cykgewogICAgICAvLyBlbnN1cmUgYW55IHZpZXdzIHJlZidlZCBieSBzeXN0ZW0gYXJlIGNvbnNpc3RlbnQgYXMgd2VsbAogICAgICBhd2FpdCB0aGlzLl9udWtlVGlwQmF0Y2godmlldy5rZXksIHZpZXcubGVuZ3RoKQogICAgfQoKICAgIGlmIChib290LmhlYWRzKSB0aGlzLmhpbnRXYWtldXAoYm9vdC5oZWFkcykKICAgIGlmICh0aGlzLmxvY2FsLmxlbmd0aCkgdGhpcy5oaW50V2FrZXVwKFt7IGtleTogdGhpcy5sb2NhbC5rZXksIGxlbmd0aDogdGhpcy5sb2NhbC5sZW5ndGggfV0pCgogICAgYXdhaXQgY29yZS5jbG9zZSgpCiAgICBpZiAoZW5jQ29yZSkgYXdhaXQgZW5jQ29yZS5jbG9zZSgpCiAgfQoKICBfYnVtcFdha2V1cFBlZXIocGVlcikgewogICAgaWYgKHRoaXMuX2NvdXBsZXIpIHRoaXMuX2NvdXBsZXIudXBkYXRlKHBlZXIuc3RyZWFtKQogIH0KCiAgYXN5bmMgX3JvdGF0ZUxvY2FsV3JpdGVyKG5ld0xvY2FsKSB7CiAgICBhc3NlcnQoIXRoaXMuYXBwZW5kaW5nLCAnQ2Fubm90IHJvdGF0ZSBhIG5ld0xvY2FsIHdyaXRlciBpZiBhbiBhcHBlbmQgaXMgaW4gcHJvZ3Jlc3MnKQoKICAgIGNvbnN0IG9sZExvY2FsID0gdGhpcy5sb2NhbAoKICAgIGlmICh0aGlzLl9hcHBseVN0YXRlKSBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmNsb3NlKCkKCiAgICB0aGlzLmxvY2FsID0gbmV3TG9jYWwKICAgIHRoaXMubG9jYWwub24oJ2FwcGVuZCcsIHRoaXMuX29ubG9jYWx3cml0ZXJjaGFuZ2VCb3VuZCkKCiAgICB0aGlzLmxvY2FsV3JpdGVyID0gbnVsbAogICAgdGhpcy5fdXBkYXRlTG9jYWxDb3JlID0gbnVsbAoKICAgIGNvbnN0IHN0b3JlID0gdGhpcy5fdmlld1N0b3JlLmF0b21pemUoKQoKICAgIGNvbnN0IGxvY2FsID0gc3RvcmUuZ2V0TG9jYWwoKQogICAgYXdhaXQgbG9jYWwucmVhZHkoKQoKICAgIGF3YWl0IExvY2FsU3RhdGUubW92ZVRvKG9sZExvY2FsLCBsb2NhbCkKCiAgICBhd2FpdCBsb2NhbC5zZXRVc2VyRGF0YSgncmVmZXJyZXInLCB0aGlzLmtleSkKICAgIGlmICh0aGlzLmVuY3J5cHRpb25LZXkpIGF3YWl0IGxvY2FsLnNldFVzZXJEYXRhKCdhdXRvYmFzZS9lbmNyeXB0aW9uJywgdGhpcy5lbmNyeXB0aW9uS2V5KQoKICAgIGF3YWl0IHN0b3JlLmZsdXNoKCkKICAgIGF3YWl0IHN0b3JlLmNsb3NlKCkKCiAgICBhd2FpdCB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwLnNldFVzZXJEYXRhKCdhdXRvYmFzZS9sb2NhbCcsIGxvY2FsLmtleSkKCiAgICBhd2FpdCB0aGlzLl9jbGVhcldyaXRlcnMoKQogICAgYXdhaXQgb2xkTG9jYWwuY2xvc2UoKQoKICAgIC8vIGRvbmUsIHNvZnQgcmVib290CgogICAgYXdhaXQgdGhpcy5fdmlld1N0b3JlLnVwZGF0ZUxvY2FsKCkKCiAgICBhd2FpdCB0aGlzLl9jbGVhcldyaXRlcnMoKQoKICAgIHRoaXMuX2FwcGx5U3RhdGUgPSBuZXcgQXBwbHlTdGF0ZSh0aGlzKQogICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5yZWFkeSgpCiAgICBhd2FpdCB0aGlzLl9tYWtlTGluZWFyaXplckZyb21WaWV3U3RhdGUoKQoKICAgIHRoaXMuX2NhdWdodHVwID0gZmFsc2UKCiAgICB0aGlzLl9yZWJvb3RlZCgpCgogICAgdGhpcy5lbWl0KCdyb3RhdGUtbG9jYWwtd3JpdGVyJykKICB9CgogIGFzeW5jIHNldExvY2FsKGtleSwgeyBrZXlQYWlyIH0gPSB7fSkgewogICAgaWYgKCF0aGlzLm9wZW5lZCkgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgY29uc3QgbWFuaWZlc3QgPSBrZXlQYWlyCiAgICAgID8geyB2ZXJzaW9uOiB0aGlzLnN0b3JlLm1hbmlmZXN0VmVyc2lvbiwgc2lnbmVyczogW3sgcHVibGljS2V5OiBrZXlQYWlyLnB1YmxpY0tleSB9XSB9CiAgICAgIDogbnVsbAogICAgaWYgKCFrZXkpIGtleSA9IEh5cGVyY29yZS5rZXkobWFuaWZlc3QpCiAgICAvLyBJZiB0aGUga2V5cyBhcmUgdGhlIHNhbWUsIG5vIG5lZWQgdG8gcm90YXRlCiAgICBpZiAoYjRhLmVxdWFscyhrZXksIHRoaXMubG9jYWwua2V5KSkgcmV0dXJuCgogICAgY29uc3QgZW5jcnlwdGlvbiA9IHRoaXMuZW5jcnlwdGlvbktleSA/IHRoaXMuZ2V0V3JpdGVyRW5jcnlwdGlvbigpIDogbnVsbAoKICAgIGNvbnN0IGxvY2FsID0gdGhpcy5zdG9yZS5nZXQoewogICAgICBrZXksCiAgICAgIG1hbmlmZXN0LAogICAgICBhY3RpdmU6IGZhbHNlLAogICAgICBleGNsdXNpdmU6IHRydWUsCiAgICAgIGVuY3J5cHRpb24sCiAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZQogICAgfSkKICAgIGF3YWl0IGxvY2FsLnJlYWR5KCkKCiAgICB0aGlzLl91cGRhdGVMb2NhbENvcmUgPSBsb2NhbAoKICAgIGxldCBydW5zID0gMAogICAgd2hpbGUgKCF0aGlzLl9pbnRlcnJ1cHRpbmcgJiYgdGhpcy5hcHBlbmRpbmcgJiYgcnVucysrIDwgMTYpIGF3YWl0IHRoaXMudXBkYXRlKCkKICAgIGF3YWl0IHRoaXMuX2J1bXAoKQogIH0KCiAgc2V0V2FrZXVwKGNhcCwgZGlzY292ZXJ5S2V5KSB7CiAgICBpZiAodGhpcy53YWtldXBTZXNzaW9uKSB0aGlzLndha2V1cFNlc3Npb24uZGVzdHJveSgpCiAgICBpZiAoIWRpc2NvdmVyeUtleSAmJiBiNGEuZXF1YWxzKGNhcCwgdGhpcy5rZXkpKSBkaXNjb3ZlcnlLZXkgPSB0aGlzLmRpc2NvdmVyeUtleQogICAgdGhpcy53YWtldXBTZXNzaW9uID0gdGhpcy53YWtldXBQcm90b2NvbC5zZXNzaW9uKAogICAgICBjYXAsCiAgICAgIG5ldyBXYWtldXBIYW5kbGVyKHRoaXMsIGRpc2NvdmVyeUtleSB8fCBudWxsKQogICAgKQoKICAgIC8vIGluY2FzZSB0aGlzIHNlc3Npb24gaGFzIGFjdGl2ZSBwZWVycyBhbHJlYWR5LCBidW1wIHRoZSBjb3VwbGVyCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy53YWtldXBTZXNzaW9uLnBlZXJzKSB7CiAgICAgIGlmIChwZWVyLmFjdGl2ZSkgdGhpcy5fYnVtcFdha2V1cFBlZXIocGVlcikKICAgIH0KICB9CgogIGFzeW5jIF9nZXRNaWdyYXRpb25Qb2ludGVyKGtleSwgbGVuZ3RoKSB7CiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoeyBrZXksIGFjdGl2ZTogZmFsc2UsIGVuY3J5cHRpb246IG51bGwgfSkKICAgIGNvbnN0IGVuY0NvcmUgPSBhd2FpdCBFbmNyeXB0aW9uVmlldy5zZXRTeXN0ZW1FbmNyeXB0aW9uKHRoaXMsIGNvcmUpCgogICAgY29uc3QgbWluID0gY29yZS5tYW5pZmVzdCAmJiBjb3JlLm1hbmlmZXN0LnByb2xvZ3VlID8gY29yZS5tYW5pZmVzdC5wcm9sb2d1ZS5sZW5ndGggOiAwCgogICAgZm9yIChsZXQgaSA9IGxlbmd0aCAtIDE7IGkgPj0gbWluOyBpLS0pIHsKICAgICAgaWYgKCEoYXdhaXQgY29yZS5oYXMoaSkpKSBjb250aW51ZQoKICAgICAgY29uc3Qgc3lzID0gbmV3IFN5c3RlbVZpZXcoY29yZSwgeyBjaGVja291dDogaSArIDEgfSkKICAgICAgYXdhaXQgc3lzLnJlYWR5KCkKCiAgICAgIGxldCBnb29kID0gdHJ1ZQoKICAgICAgZm9yIChjb25zdCB2IG9mIHN5cy52aWV3cykgewogICAgICAgIGNvbnN0IHZjID0gdGhpcy5zdG9yZS5nZXQoeyBrZXk6IHYua2V5LCBhY3RpdmU6IGZhbHNlIH0pCiAgICAgICAgYXdhaXQgdmMucmVhZHkoKQogICAgICAgIGlmICh2Yy5sZW5ndGggPCB2Lmxlbmd0aCkgZ29vZCA9IGZhbHNlCiAgICAgICAgYXdhaXQgdmMuY2xvc2UoKQogICAgICB9CgogICAgICBhd2FpdCBzeXMuY2xvc2UoKQogICAgICBpZiAoIWdvb2QpIGNvbnRpbnVlCgogICAgICByZXR1cm4gaSArIDEKICAgIH0KCiAgICBhd2FpdCBjb3JlLmNsb3NlKCkKICAgIGlmIChlbmNDb3JlKSBhd2FpdCBlbmNDb3JlLmNsb3NlKCkKCiAgICByZXR1cm4gbWluCiAgfQoKICAvLyBtaWdyYXRpbmcgZnJvbSA2IC0+IGxhdGVzdAogIGFzeW5jIF9taWdyYXRlNihrZXksIGxlbmd0aCkgewogICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsga2V5LCBhY3RpdmU6IGZhbHNlIH0pCiAgICBhd2FpdCBjb3JlLnJlYWR5KCkKICAgIGNvbnN0IGJhdGNoID0gY29yZS5zZXNzaW9uKHsgbmFtZTogJ2JhdGNoJywgb3ZlcndyaXRlOiB0cnVlLCBjaGVja291dDogbGVuZ3RoIH0pCiAgICBhd2FpdCBiYXRjaC5yZWFkeSgpCiAgICBhd2FpdCBiYXRjaC5jbG9zZSgpCiAgICBhd2FpdCBjb3JlLmNsb3NlKCkKICB9CgogIC8vIGNhbGxlZCBieSB2aWV3LXN0b3JlIGZvciBib290c3RyYXBwaW5nCiAgYXN5bmMgX2dldFN5c3RlbUluZm8oKSB7CiAgICBjb25zdCBib290ID0gYXdhaXQgdGhpcy5fZ2V0Qm9vdFJlY29yZCgpCiAgICBpZiAoIWJvb3Qua2V5KSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IG1pZ3JhdGVkID0gISFib290LmhlYWRzCiAgICBjb25zdCBpbmRleGVkTGVuZ3RoID0gYm9vdC5zeXN0ZW1MZW5ndGgKCiAgICBpZiAobWlncmF0ZWQpIHsKICAgICAgLy8gZW5zdXJlIHN5c3RlbSBiYXRjaCBpcyBjb25zaXN0ZW50IG9uIGluaXRpYWwgbWlncmF0aW9uCiAgICAgIGF3YWl0IHRoaXMuX21pZ3JhdGU2KGJvb3Qua2V5LCBpbmRleGVkTGVuZ3RoKQogICAgfQoKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7IGtleTogYm9vdC5rZXksIGVuY3J5cHRpb246IG51bGwsIGFjdGl2ZTogZmFsc2UgfSkKICAgIGF3YWl0IGNvcmUucmVhZHkoKQoKICAgIGNvbnN0IGJhdGNoID0gY29yZS5zZXNzaW9uKHsgbmFtZTogJ2JhdGNoJyB9KQogICAgY29uc3QgZW5jQ29yZSA9IGF3YWl0IEVuY3J5cHRpb25WaWV3LnNldFN5c3RlbUVuY3J5cHRpb24odGhpcywgYmF0Y2gpCgogICAgY29uc3QgaW5mbyA9IGF3YWl0IFN5c3RlbVZpZXcuZ2V0SW5kZXhlZEluZm8oYmF0Y2gsIGluZGV4ZWRMZW5ndGgpCgogICAgaWYgKGVuY0NvcmUpIGF3YWl0IGVuY0NvcmUuY2xvc2UoKQogICAgYXdhaXQgYmF0Y2guY2xvc2UoKQogICAgYXdhaXQgY29yZS5jbG9zZSgpCgogICAgaWYgKGluZm8udmVyc2lvbiA+IE1BWF9BVVRPQkFTRV9WRVJTSU9OKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQXV0b2Jhc2UgdXBncmFkZSByZXF1aXJlZC4nKQogICAgfQoKICAgIC8vIGp1c3QgY29tcGF0CiAgICBpZiAobWlncmF0ZWQpIHsKICAgICAgdGhpcy5taWdyYXRlZCA9IHRydWUKCiAgICAgIGZvciAoY29uc3QgdmlldyBvZiBpbmZvLnZpZXdzKSB7CiAgICAgICAgLy8gZW5zdXJlIGFueSB2aWV3cyByZWYnZWQgYnkgc3lzdGVtIGFyZSBjb25zaXN0ZW50IGFzIHdlbGwKICAgICAgICBhd2FpdCB0aGlzLl9taWdyYXRlNih2aWV3LmtleSwgdmlldy5sZW5ndGgpCiAgICAgIH0KCiAgICAgIGlmIChib290LmhlYWRzKSB0aGlzLmhpbnRXYWtldXAoYm9vdC5oZWFkcykKICAgICAgaWYgKHRoaXMubG9jYWwubGVuZ3RoKSB0aGlzLmhpbnRXYWtldXAoW3sga2V5OiB0aGlzLmxvY2FsLmtleSwgbGVuZ3RoOiB0aGlzLmxvY2FsLmxlbmd0aCB9XSkKICAgIH0KCiAgICByZXR1cm4gewogICAgICBrZXk6IGJvb3Qua2V5LAogICAgICBpbmRleGVyczogaW5mby5pbmRleGVycywKICAgICAgdmlld3M6IGluZm8udmlld3MsCiAgICAgIGVudHJvcHk6IGluZm8uZW50cm9weQogICAgfQogIH0KCiAgLy8gY2FsbGVkIGJ5IHRoZSBhcHBseSBzdGF0ZSBmb3IgYm9vdHN0cmFwcGluZwogIGFzeW5jIF9nZXRCb290UmVjb3JkKCkgewogICAgYXdhaXQgdGhpcy5fcHJlb3BlbgoKICAgIGNvbnN0IHBvaW50ZXIgPSBhd2FpdCB0aGlzLmxvY2FsLmdldFVzZXJEYXRhKCdhdXRvYmFzZS9ib290JykKCiAgICBjb25zdCBib290ID0gcG9pbnRlcgogICAgICA/IGMuZGVjb2RlKG1lc3NhZ2VzLkJvb3RSZWNvcmQsIHBvaW50ZXIpCiAgICAgIDogewogICAgICAgICAgdmVyc2lvbjogQk9PVF9SRUNPUkRfVkVSU0lPTiwKICAgICAgICAgIGtleTogbnVsbCwKICAgICAgICAgIHN5c3RlbUxlbmd0aDogMCwKICAgICAgICAgIGluZGV4ZXJzVXBkYXRlZDogZmFsc2UsCiAgICAgICAgICBmYXN0Rm9yd2FyZGluZzogZmFsc2UsCiAgICAgICAgICByZWNvdmVyaWVzOiBSRUNPVkVSSUVTLAogICAgICAgICAgaGVhZHM6IG51bGwKICAgICAgICB9CgogICAgaWYgKGJvb3QuaGVhZHMpIHsKICAgICAgY29uc3QgbGVuID0gYXdhaXQgdGhpcy5fZ2V0TWlncmF0aW9uUG9pbnRlcihib290LmtleSwgYm9vdC5zeXN0ZW1MZW5ndGgpCiAgICAgIGlmIChsZW4gIT09IGJvb3Quc3lzdGVtTGVuZ3RoKQogICAgICAgIHRoaXMuX3dhcm4oCiAgICAgICAgICBuZXcgRXJyb3IoCiAgICAgICAgICAgICdJbnZhbGlkIHBvaW50ZXIgaW4gbWlncmF0aW9uLCBjb3JyZWN0aW5nICgnICsgbGVuICsgJyB2cyAnICsgYm9vdC5zeXN0ZW1MZW5ndGggKyAnKScKICAgICAgICAgICkKICAgICAgICApCiAgICAgIGJvb3Quc3lzdGVtTGVuZ3RoID0gbGVuCiAgICB9CgogICAgcmV0dXJuIGJvb3QKICB9CgogIHN0YXRpYyBhc3luYyBnZXRCb290UmVjb3JkKHN0b3JlLCBrZXkpIHsKICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGJvb3Qoc3RvcmUsIGtleSwgeyBleGNsdXNpdmU6IGZhbHNlIH0pCiAgICBhd2FpdCByZXN1bHQuYm9vdHN0cmFwLmNsb3NlKCkKICAgIGF3YWl0IHJlc3VsdC5sb2NhbC5jbG9zZSgpCiAgICByZXR1cm4gcmVzdWx0LmJvb3QKICB9CgogIF9pbnRlcnJ1cHQocmVhc29uKSB7CiAgICBhc3NlcnQoISF0aGlzLl9hcHBseVN0YXRlLmFwcGx5aW5nLCAnSW50ZXJydXB0IGlzIG9ubHkgYWxsb3dlZCBpbiBhcHBseScpCiAgICB0aGlzLl9pbnRlcnJ1cHRpbmcgPSB0cnVlCiAgICBpZiAocmVhc29uKSB0aGlzLmludGVycnVwdGVkID0gcmVhc29uCiAgICB0aHJvdyBJTlRFUlJVUFQKICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgaWYgKHRoaXMuX2ZsdXNoaW5nID09PSAwKSByZXR1cm4KICAgIHJldHVybiB0aGlzLl9mbHVzaFNpZ25hbC53YWl0KCkKICB9CgogIGFzeW5jIGFkdmFuY2UoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGF3YWl0IHRoaXMuX2FkdmFuY2luZwogIH0KCiAgcmVjb3VwbGUoKSB7CiAgICBpZiAodGhpcy5fY291cGxlcikgdGhpcy5fY291cGxlci5kZXN0cm95KCkKICAgIGNvbnN0IGNvcmUgPSB0aGlzLl92aWV3U3RvcmUuZ2V0U3lzdGVtQ29yZSgpCiAgICB0aGlzLl9jb3VwbGVyID0gbmV3IENvcmVDb3VwbGVyKGNvcmUsIHRoaXMuX3dha2V1cFBlZXJCb3VuZCkKICB9CgogIF91cGRhdGVCb290c3RyYXBXcml0ZXJzKCkgewogICAgY29uc3Qgd3JpdGVycyA9IHRoaXMubGluZWFyaXplci5nZXRCb290c3RyYXBXcml0ZXJzKCkKCiAgICAvLyBmaXJzdCBjbGVhciBhbGwsIGJ1dCB3aXRob3V0IGFwcGx5aW5nIGl0IGZvciBjaHVybiByZWFzb25zCiAgICBmb3IgKGNvbnN0IHdyaXRlciBvZiB0aGlzLl9ib290c3RyYXBXcml0ZXJzKSB7CiAgICAgIHdyaXRlci5pc0Jvb3RzdHJhcCA9IGZhbHNlCiAgICAgIHdyaXRlci5pc0NvdXBsZWQgPSBmYWxzZQogICAgfQoKICAgIC8vIGFsbCBwYXNzZWQgYXJlIGJvb3RzdHJhcHMKICAgIGZvciAoY29uc3Qgd3JpdGVyIG9mIHdyaXRlcnMpIHsKICAgICAgd3JpdGVyLmlzQ291cGxlZCA9IHRydWUKICAgICAgd3JpdGVyLnNldEJvb3RzdHJhcCh0cnVlKQogICAgfQoKICAgIC8vIHJlc2V0IGFjdGl2aXR5IG9uIG9sZCBvbmVzLCBhbGwgc2hvdWxkIGJlIGluIHN5bmMgbm93CiAgICBmb3IgKGNvbnN0IHdyaXRlciBvZiB0aGlzLl9ib290c3RyYXBXcml0ZXJzKSB7CiAgICAgIGlmICh3cml0ZXIuaXNCb290c3RyYXAgPT09IGZhbHNlKSB3cml0ZXIuc2V0Qm9vdHN0cmFwKGZhbHNlKQogICAgfQoKICAgIHRoaXMuX2Jvb3RzdHJhcFdyaXRlcnMgPSB3cml0ZXJzCiAgICB0aGlzLl9ib290c3RyYXBXcml0ZXJzQ2hhbmdlZCA9IGZhbHNlCiAgfQoKICBhc3luYyBfb3BlbkxpbmVhcml6ZXIoKSB7CiAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uYm9vdHN0cmFwcGluZykgewogICAgICBhd2FpdCB0aGlzLl9tYWtlTGluZWFyaXplcihudWxsKQogICAgICB0aGlzLl9ib290c3RyYXBMaW5lYXJpemVyKCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgYXdhaXQgdGhpcy5fbWFrZUxpbmVhcml6ZXJGcm9tVmlld1N0YXRlKCkKICB9CgogIGFzeW5jIF9jYXRjaHVwQXBwbHlTdGF0ZSgpIHsKICAgIGlmIChhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnNob3VsZE1pZ3JhdGUoKSkgewogICAgICBhd2FpdCB0aGlzLl9taWdyYXRlKCkKICAgIH0gZWxzZSBpZiAoIShhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmNhdGNodXAodGhpcy5saW5lYXJpemVyKSkpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgdGhpcy5fY2F1Z2h0dXAgPSB0cnVlCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgX29wZW4oKSB7CiAgICB0aGlzLl9wcmVvcGVuID0gdGhpcy5fcnVuUHJlT3BlbigpCiAgICBhd2FpdCB0aGlzLl9wcmVvcGVuCgogICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuCgogICAgdGhpcy5fYXBwbHlTdGF0ZSA9IG5ldyBBcHBseVN0YXRlKHRoaXMpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5yZWFkeSgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuCgogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuY2xvc2UoKQogICAgICB9IGNhdGNoIHt9CgogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCiAgICAgIH0gY2F0Y2gge30KCiAgICAgIHRoaXMuX2FwcGx5U3RhdGUgPSBudWxsCiAgICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybgoKICAgICAgdGhyb3cgZXJyCiAgICB9CgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fb3BlbkxpbmVhcml6ZXIoKQogICAgICBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQogICAgICBhd2FpdCB0aGlzLl93YWtldXAucmVhZHkoKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybgogICAgICB0aHJvdyBlcnIKICAgIH0KCiAgICBpZiAodGhpcy5jb3JlLmxlbmd0aCAtIHRoaXMuX2FwcGx5U3RhdGUuaW5kZXhlZExlbmd0aCA+IHRoaXMuX2Fja1RpY2tUaHJlc2hvbGQpIHsKICAgICAgdGhpcy5fYWNrVGljayA9IHRoaXMuX2Fja1RpY2tUaHJlc2hvbGQKICAgIH0KICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyICYmIHRoaXMuX2Fja0ludGVydmFsKSB7CiAgICAgIHRoaXMuX3N0YXJ0QWNrVGltZXIoKQogICAgfQoKICAgIHRoaXMuX3VwZGF0ZUJvb3RzdHJhcFdyaXRlcnMoKQoKICAgIHRoaXMucmVjb3VwbGUoKQogICAgdGhpcy5fcXVldWVGYXN0Rm9yd2FyZCgpCgogICAgLy8gcXVldWUgYSBmdWxsIGJ1bXAgdGhhdCBoYW5kbGVzIHdha2V1cCBldGMgKG5vdCBsZWdhbCB0byB3YWl0IGZvciB0aGF0IGhlcmUpCiAgICB0aGlzLl9xdWV1ZUJ1bXAoKQogIH0KCiAgYXN5bmMgX2Nsb3NlKCkgewogICAgYXdhaXQgdGhpcy5mbHVzaCgpIC8vIGZsdXNoIGFsbCBwZW5kaW5nIG5vbiBuZXR3b3JrIGlvCiAgICB0aGlzLl9pbnRlcnJ1cHRpbmcgPSB0cnVlCiAgICBhd2FpdCBQcm9taXNlLnJlc29sdmUoKSAvLyBkZWZlciBvbmUgdGljawoKICAgIGlmICh0aGlzLndha2V1cFNlc3Npb24pIHRoaXMud2FrZXVwU2Vzc2lvbi5kZXN0cm95KCkKICAgIGlmICh0aGlzLndha2V1cE93bmVyKSB0aGlzLndha2V1cFByb3RvY29sLmRlc3Ryb3koKQoKICAgIGlmICh0aGlzLmZhc3RGb3J3YXJkaW5nKSBhd2FpdCB0aGlzLmZhc3RGb3J3YXJkaW5nLmNsb3NlKCkKCiAgICBpZiAodGhpcy5fY291cGxlcikgdGhpcy5fY291cGxlci5kZXN0cm95KCkKICAgIHRoaXMuX2NvdXBsZXIgPSBudWxsCiAgICB0aGlzLl93YWl0aW5nLm5vdGlmeShudWxsKQoKICAgIGF3YWl0IHRoaXMuYWN0aXZlV3JpdGVycy5jbGVhcigpCgogICAgY29uc3QgY2xvc2luZyA9IHRoaXMuX2FkdmFuY2luZyA/IHRoaXMuX2FkdmFuY2luZy5jYXRjaChzYWZldHlDYXRjaCkgOiBudWxsCgogICAgYXdhaXQgdGhpcy5fY2xlYXJXcml0ZXJzKCkKICAgIGlmICh0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwKSBhd2FpdCB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwLmNsb3NlKCkKICAgIGF3YWl0IHRoaXMubG9jYWwuY2xvc2UoKQoKICAgIGlmICh0aGlzLl9hY2tUaW1lcikgewogICAgICB0aGlzLl9hY2tUaW1lci5zdG9wKCkKICAgICAgYXdhaXQgdGhpcy5fYWNrVGltZXIuZmx1c2goKQogICAgfQoKICAgIGF3YWl0IHRoaXMuX3dha2V1cC5jbG9zZSgpCgogICAgaWYgKHRoaXMuX2hhc0Nsb3NlKSBhd2FpdCB0aGlzLl9oYW5kbGVycy5jbG9zZSh0aGlzLnZpZXcpCiAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZSkgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5jbG9zZSgpCgogICAgYXdhaXQgdGhpcy5fdmlld1N0b3JlLmNsb3NlKCkKICAgIGF3YWl0IHRoaXMuY29yZS5jbG9zZSgpCiAgICBhd2FpdCB0aGlzLnN0b3JlLmNsb3NlKCkKCiAgICBpZiAodGhpcy5fd3JpdGFibGUpIHRoaXMuX3dyaXRhYmxlLnJlc29sdmUoZmFsc2UpCgogICAgYXdhaXQgY2xvc2luZwogIH0KCiAgZ2V0TGFzdEVycm9yKCkgewogICAgcmV0dXJuIHRoaXMuX2xhc3RFcnJvcgogIH0KCiAgX29uRXJyb3IoZXJyKSB7CiAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4KCiAgICB0aGlzLl9sYXN0RXJyb3IgPSBlcnIKCiAgICBpZiAoZXJyID09PSBJTlRFUlJVUFQpIHsKICAgICAgdGhpcy5lbWl0KCdpbnRlcnJ1cHQnLCB0aGlzLmludGVycnVwdGVkKQogICAgICB0aGlzLmVtaXQoJ3VwZGF0ZScpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuY2xvc2UoKS5jYXRjaChzYWZldHlDYXRjaCkKCiAgICAvLyBpZiBubyBvbmUgaXMgbGlzdGVuaW5nIHdlIHNob3VsZCBjcmFzaCEgd2UgY2Fubm90IHJlbHkgb24gdGhlIEVFIGhlcmUKICAgIC8vIGFzIHRoaXMgaXMgd3JhcHBlZCBpbiBhIHByb21pc2Ugc28gaW5zdGVhZCBvZiBuZXh0VGljayB0aHJvdyBpdAogICAgaWYgKFJlYWR5UmVzb3VyY2UubGlzdGVuZXJDb3VudCh0aGlzLCAnZXJyb3InKSA9PT0gMCkgewogICAgICBjcmFzaFNvb24oZXJyKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyKQogIH0KCiAgYXN5bmMgX2Nsb3NlV3JpdGVyKHcpIHsKICAgIHRoaXMuYWN0aXZlV3JpdGVycy5kZWxldGUodykKICAgIGF3YWl0IHcuY2xvc2UoKQogIH0KCiAgYXN5bmMgX2djV3JpdGVycygpIHsKICAgIC8vIGp1c3QgcmV0dXJuIGVhcmx5LCB3aHkgbm90CiAgICBpZiAodGhpcy5fY2hlY2tXcml0ZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuCgogICAgd2hpbGUgKHRoaXMuX2NoZWNrV3JpdGVycy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHcgPSB0aGlzLl9jaGVja1dyaXRlcnMucG9wKCkKCiAgICAgIC8vIGRvZXNudCBodXJ0CiAgICAgIHcudXBkYXRlQWN0aXZpdHkoKQoKICAgICAgaWYgKCF3LmZsdXNoZWQoKSkgY29udGludWUKCiAgICAgIGNvbnN0IHVucXVldWVkID0gdGhpcy5fd2FrZXVwLnVucXVldWUody5jb3JlLmtleSwgdy5jb3JlLmxlbmd0aCkKCiAgICAgIGlmICghdW5xdWV1ZWQgfHwgdy5pc0FjdGl2ZUluZGV4ZXIpIGNvbnRpbnVlCiAgICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyID09PSB3KSBjb250aW51ZQoKICAgICAgYXdhaXQgdGhpcy5fY2xvc2VXcml0ZXIodykKICAgIH0KCiAgICBhd2FpdCB0aGlzLl93YWtldXAuZmx1c2goKQogIH0KCiAgX3N0YXJ0QWNrVGltZXIoKSB7CiAgICBpZiAodGhpcy5fYWNrVGltZXIpIHJldHVybgogICAgdGhpcy5fYWNrVGltZXIgPSBuZXcgVGltZXIodGhpcy5fYmFja2dyb3VuZEFjay5iaW5kKHRoaXMpLCB0aGlzLl9hY2tJbnRlcnZhbCkKICAgIHRoaXMuX2J1bXBBY2tUaW1lcigpCiAgfQoKICBfYnVtcEFja1RpbWVyKCkgewogICAgaWYgKCF0aGlzLl9hY2tUaW1lcikgcmV0dXJuCiAgICB0aGlzLl9hY2tUaW1lci5idW1wKCkKICB9CgogIGFzeW5jIHVwZGF0ZSgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2J1bXAoKQogICAgICBpZiAodGhpcy5fYWNraW5nKSBhd2FpdCB0aGlzLl9idW1wKCkgLy8gaWYgYWNraW5nIGp1c3QgcmVidW1wIGluY2FzZSBpdCB3YXMgdHJpZ2dlcmVkIGZyb20gYWJvdmUuLi4KICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAodGhpcy5faW50ZXJydXB0aW5nKSByZXR1cm4KICAgICAgdGhyb3cgZXJyCiAgICB9CiAgfQoKICAvLyBydW5zIGluIGJnLCBub3QgYWxsb3dlZCB0byB0aHJvdwogIC8vIFRPRE86IHJlZmFjdG9yIHNvIHRoaXMgb25seSBtb3ZlcyB0aGUgd3JpdGVyIGFmZmVjdGVkIHRvIGEgdXBkYXRlZCBzZXQKICBhc3luYyBfb25yZW1vdGV3cml0ZXJjaGFuZ2UoKSB7CiAgICB0aGlzLl9idW1wQWNrVGltZXIoKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2J1bXAoKQogICAgfSBjYXRjaCB7fQogIH0KCiAgX29ubG9jYWx3cml0ZXJjaGFuZ2UoKSB7CiAgICBpZiAoIXRoaXMubG9jYWxXcml0ZXIgfHwgdGhpcy5sb2NhbFdyaXRlci5pc1JlbW92ZWQpIHRoaXMuX3F1ZXVlQnVtcCgpCiAgfQoKICBfb253YWtldXAoKSB7CiAgICB0aGlzLl9uZWVkc1dha2V1cCA9IHRydWUKICAgIHRoaXMuX3F1ZXVlQnVtcCgpCiAgfQoKICBpc0Zhc3RGb3J3YXJkaW5nKCkgewogICAgaWYgKHRoaXMuZmFzdEZvcndhcmRUbyAhPT0gbnVsbCkgcmV0dXJuIHRydWUKICAgIHJldHVybiB0aGlzLmZhc3RGb3J3YXJkRW5hYmxlZCAmJiB0aGlzLmZhc3RGb3J3YXJkaW5nICE9PSBudWxsCiAgfQoKICBfYmFja2dyb3VuZEFjaygpIHsKICAgIHJldHVybiB0aGlzLmFjayh0cnVlKQogIH0KCiAgYXN5bmMgYWNrKGJnID0gZmFsc2UpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKHRoaXMubG9jYWxXcml0ZXIgPT09IG51bGwgfHwgdGhpcy5fYWNraW5nIHx8IHRoaXMuX2ludGVycnVwdGluZyB8fCB0aGlzLl9hcHBlbmRpbmcgIT09IG51bGwpCiAgICAgIHJldHVybgoKICAgIGlmICh0aGlzLl9hcHBseVN0YXRlID09PSBudWxsKSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgdGhpcy5fYnVtcCgpCiAgICAgIH0gY2F0Y2gge30KICAgICAgaWYgKHRoaXMuX2FwcGx5U3RhdGUgPT09IG51bGwgfHwgdGhpcy5faW50ZXJydXB0aW5nKSByZXR1cm4KICAgIH0KCiAgICBjb25zdCBhcHBseVN0YXRlID0gdGhpcy5fYXBwbHlTdGF0ZQogICAgaWYgKGFwcGx5U3RhdGUub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgYXBwbHlTdGF0ZS5yZWFkeSgpCgogICAgY29uc3QgaXNQZW5kaW5nSW5kZXhlciA9IGFwcGx5U3RhdGUuaXNMb2NhbFBlbmRpbmdJbmRleGVyKCkKCiAgICAvLyBpZiBubyBvbmUgaXMgd2FpdGluZyBmb3Igb3VyIGluZGV4IG1hbmlmZXN0LCB3YWl0IGZvciBGRiBiZWZvcmUgcHVzaGluZyBhbiBhY2sKICAgIGlmICgoIWlzUGVuZGluZ0luZGV4ZXIgJiYgdGhpcy5pc0Zhc3RGb3J3YXJkaW5nKCkpIHx8IHRoaXMuX2ludGVycnVwdGluZykgcmV0dXJuCgogICAgY29uc3QgaXNJbmRleGVyID0gYXBwbHlTdGF0ZS5pc0xvY2FsSW5kZXhlcigpIHx8IGlzUGVuZGluZ0luZGV4ZXIKICAgIGlmICghaXNJbmRleGVyKSByZXR1cm4KCiAgICB0aGlzLl9hY2tpbmcgPSB0cnVlCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fYnVtcCgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKCF0aGlzLl9pbnRlcnJ1cHRpbmcpIHRocm93IGVycgogICAgfQoKICAgIGlmICh0aGlzLl9pbnRlcnJ1cHRpbmcgfHwgIXRoaXMubG9jYWxXcml0ZXIgfHwgdGhpcy5sb2NhbFdyaXRlci5jbG9zZWQpIHsKICAgICAgdGhpcy5fYWNraW5nID0gZmFsc2UKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gYXZvaWQgbHVtcGluZyBhY2tzIHRvZ2V0aGVyIGR1ZSB0byB0aGUgYnVtcCB3YWl0IGhlcmUKICAgIGlmICh0aGlzLl9hY2tUaW1lciAmJiBiZykgYXdhaXQgdGhpcy5fYWNrVGltZXIuYXNhcFN0YW5kYWxvbmUoKQogICAgaWYgKHRoaXMuX2ludGVycnVwdGluZyB8fCBhcHBseVN0YXRlLmNsb3NpbmcpIHsKICAgICAgdGhpcy5fYWNraW5nID0gZmFsc2UKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgYWx3YXlzV3JpdGUgPSBpc1BlbmRpbmdJbmRleGVyIHx8IChhd2FpdCBhcHBseVN0YXRlLnNob3VsZFdyaXRlKCkpCiAgICBpZiAodGhpcy5faW50ZXJydXB0aW5nIHx8IGFwcGx5U3RhdGUuY2xvc2luZykgewogICAgICB0aGlzLl9hY2tpbmcgPSBmYWxzZQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBoYXNQZW5kaW5nSW5kZXhlcnMgPSBhcHBseVN0YXRlLnN5c3RlbS5pbmRleGVycy5sZW5ndGggPiB0aGlzLmxpbmVhcml6ZXIuaW5kZXhlcnMubGVuZ3RoCgogICAgaWYgKGFsd2F5c1dyaXRlIHx8IHRoaXMubGluZWFyaXplci5zaG91bGRBY2sodGhpcy5sb2NhbFdyaXRlciwgaGFzUGVuZGluZ0luZGV4ZXJzKSkgewogICAgICB0cnkgewogICAgICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyICYmICF0aGlzLmxvY2FsV3JpdGVyLmNsb3NlZCkgYXdhaXQgdGhpcy5hcHBlbmQobnVsbCkKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKCF0aGlzLl9pbnRlcnJ1cHRpbmcpIHRocm93IGVycgogICAgICB9CiAgICB9CgogICAgaWYgKCF0aGlzLl9pbnRlcnJ1cHRpbmcpIHsKICAgICAgdGhpcy5fdXBkYXRlQWNrVGhyZXNob2xkKCkKICAgICAgdGhpcy5fYnVtcEFja1RpbWVyKCkKICAgIH0KCiAgICB0aGlzLl9hY2tpbmcgPSBmYWxzZQogIH0KCiAgdmlld3MoKSB7CiAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZSkgcmV0dXJuIHRoaXMuX2FwcGx5U3RhdGUuc3RvcmUubGlzdFZpZXdzKCkKICAgIHJldHVybiB0aGlzLl92aWV3U3RvcmUubGlzdFZpZXdzKCkKICB9CgogIGJhdGNoKCkgewogICAgcmV0dXJuIG5ldyBBcHBlbmRCYXRjaCh0aGlzKQogIH0KCiAgYXN5bmMgYXBwZW5kKHZhbHVlLCBvcHRzKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmICh0aGlzLl9hZHZhbmNpbmcgIT09IG51bGwpIGF3YWl0IHRoaXMuX2FkdmFuY2luZwogICAgd2hpbGUgKHRoaXMuYWN0aXZlQmF0Y2gpIGF3YWl0IHRoaXMuYWN0aXZlQmF0Y2guZmx1c2hlZCgpCiAgICByZXR1cm4gdGhpcy5fYXBwZW5kQmF0Y2godmFsdWUsIG9wdHMpCiAgfQoKICBhc3luYyBfYXBwZW5kQmF0Y2godmFsdWUsIG9wdHMpIHsKICAgIGlmICh0aGlzLl9pbnRlcnJ1cHRpbmcpIHRocm93IG5ldyBFcnJvcignQXV0b2Jhc2UgaXMgY2xvc2luZycpCiAgICBpZiAodmFsdWUgJiYgdGhpcy52YWx1ZUVuY29kaW5nICE9PSBCSU5BUllfRU5DT0RJTkcpCiAgICAgIHZhbHVlID0gbm9ybWFsaXplKHRoaXMudmFsdWVFbmNvZGluZywgdmFsdWUpCgogICAgY29uc3Qgb3B0aW1pc3RpYyA9ICEhb3B0cyAmJiAhIW9wdHMub3B0aW1pc3RpYyAmJiAhIXZhbHVlCgogICAgLy8gd2Ugd2FubmEgYWxsb3cgYWNrcyBzbyBpbnRlcmRleGVycyBjYW4gZmx1c2gKICAgIGlmICgKICAgICAgIW9wdGltaXN0aWMgJiYKICAgICAgKHRoaXMubG9jYWxXcml0ZXIgPT09IG51bGwgfHwgKHRoaXMubG9jYWxXcml0ZXIuaXNSZW1vdmVkICYmIHZhbHVlICE9PSBudWxsKSkKICAgICkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCB3cml0YWJsZScpCiAgICB9CgogICAgaWYgKHRoaXMuX2FwcGVuZGluZyA9PT0gbnVsbCkgdGhpcy5fYXBwZW5kaW5nID0gW10KCiAgICBsZXQgbGVuID0gMAogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgIGZvciAoY29uc3QgdiBvZiB2YWx1ZSkgbGVuID0gdGhpcy5fYXBwZW5kKHYpCiAgICB9IGVsc2UgewogICAgICBsZW4gPSB0aGlzLl9hcHBlbmQodmFsdWUpCiAgICB9CgogICAgY29uc3QgbG9jYWxMZW5ndGggPSB0aGlzLmxvY2FsLmxlbmd0aAoKICAgIGlmIChvcHRpbWlzdGljKSB0aGlzLl9vcHRpbWlzdGljID0gdGhpcy5fYXBwZW5kaW5nLmxlbmd0aCAtIDEKICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2FwcGVuZGVkICsgdGhpcy5fYXBwZW5kaW5nLmxlbmd0aAoKICAgIC8vIGF3YWl0IGluIGNhc2UgYXBwZW5kIGlzIGluIGN1cnJlbnQgdGljawogICAgaWYgKHRoaXMuX2FkdmFuY2luZykgYXdhaXQgdGhpcy5fYWR2YW5jaW5nCgogICAgbGV0IHJ1bnMgPSAwCgogICAgLy8gYnVtcCB1bnRpbCB3ZSd2ZSBmbHVzaGVkIHRoZSBub2RlcwogICAgd2hpbGUgKHRoaXMuX2FwcGVuZGVkIDwgdGFyZ2V0ICYmICF0aGlzLl9pbnRlcnJ1cHRpbmcpIHsKICAgICAgYXdhaXQgdGhpcy5fYnVtcCgpCiAgICAgIC8vIHNhZmV0eQogICAgICBpZiAocnVucysrID49IDE2ICYmIHRoaXMubG9jYWxXcml0ZXIgJiYgdGhpcy5sb2NhbFdyaXRlci5pZGxlKCkpIGJyZWFrCiAgICB9CgogICAgaWYgKHRoaXMuX2FkdmFuY2luZykgYXdhaXQgdGhpcy5fYWR2YW5jaW5nCiAgICBpZiAodGhpcy5faW50ZXJydXB0aW5nKSB0aHJvdyBuZXcgRXJyb3IoJ0F1dG9iYXNlIGlzIGNsb3NpbmcnKQoKICAgIHJldHVybiBsb2NhbExlbmd0aCArIGxlbgogIH0KCiAgX2FwcGVuZCh2YWx1ZSkgewogICAgLy8gaWYgcHJldiB2YWx1ZSBpcyBhbiBhY2sgdGhhdCBoYXNudCBiZWVuIGZsdXNoZWQsIHNraXAgaXQKICAgIGlmICh0aGlzLl9hcHBlbmRpbmcubGVuZ3RoID4gMCkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwpIHJldHVybiB0aGlzLl9hcHBlbmRpbmcubGVuZ3RoCiAgICAgIGlmICh0aGlzLl9hcHBlbmRpbmdbdGhpcy5fYXBwZW5kaW5nLmxlbmd0aCAtIDFdID09PSBudWxsKSB7CiAgICAgICAgdGhpcy5fYXBwZW5kaW5nLnBvcCgpCiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzLl9hcHBlbmRpbmcucHVzaCh2YWx1ZSkKICB9CgogIHN0YXRpYyBkZWNvZGVWYWx1ZSh2YWx1ZSwgb3B0cykgewogICAgcmV0dXJuIGRlY29kZVZhbHVlKHZhbHVlLCBvcHRzKQogIH0KCiAgc3RhdGljIGVuY29kZVZhbHVlKHZhbHVlLCBvcHRzKSB7CiAgICByZXR1cm4gZW5jb2RlVmFsdWUodmFsdWUsIG9wdHMpCiAgfQoKICBzdGF0aWMgYXN5bmMgZ2V0TG9jYWxLZXkoc3RvcmUsIG9wdHMgPSB7fSkgewogICAgY29uc3QgY29yZSA9IG9wdHMua2V5UGFpcgogICAgICA/IHN0b3JlLmdldCh7IC4uLm9wdHMsIGFjdGl2ZTogZmFsc2UgfSkKICAgICAgOiBzdG9yZS5nZXQoeyAuLi5vcHRzLCBuYW1lOiAnbG9jYWwnLCBhY3RpdmU6IGZhbHNlIH0pCiAgICBhd2FpdCBjb3JlLnJlYWR5KCkKICAgIGNvbnN0IGtleSA9IGNvcmUua2V5CiAgICBhd2FpdCBjb3JlLmNsb3NlKCkKICAgIHJldHVybiBrZXkKICB9CgogIHN0YXRpYyBnZXRMb2NhbENvcmUoc3RvcmUsIGhhbmRsZXJzLCBlbmNyeXB0aW9uS2V5KSB7CiAgICBjb25zdCBlbmNyeXB0aW9uID0gIWVuY3J5cHRpb25LZXkgPyBudWxsIDogeyBrZXk6IGVuY3J5cHRpb25LZXkgfQogICAgY29uc3Qgb3B0cyA9IHsKICAgICAgLi4uaGFuZGxlcnMsCiAgICAgIGNvbXBhdDogZmFsc2UsCiAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgIGV4Y2x1c2l2ZTogdHJ1ZSwKICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlLAogICAgICBlbmNyeXB0aW9uCiAgICB9CiAgICByZXR1cm4gb3B0cy5rZXlQYWlyID8gc3RvcmUuZ2V0KG9wdHMpIDogc3RvcmUuZ2V0KHsgLi4ub3B0cywgbmFtZTogJ2xvY2FsJyB9KQogIH0KCiAgc3RhdGljIGFzeW5jIGdldFVzZXJEYXRhKGNvcmUpIHsKICAgIGNvbnN0IHZpZXcgPSBhd2FpdCBjb3JlLmdldFVzZXJEYXRhKCdhdXRvYmFzZS92aWV3JykKCiAgICByZXR1cm4gewogICAgICByZWZlcnJlcjogYXdhaXQgY29yZS5nZXRVc2VyRGF0YSgncmVmZXJyZXInKSwKICAgICAgdmlldzogdmlldyA/IGI0YS50b1N0cmluZyh2aWV3KSA6IG51bGwKICAgIH0KICB9CgogIHN0YXRpYyBhc3luYyBpc0F1dG9iYXNlKGNvcmUsIG9wdHMgPSB7fSkgewogICAgY29uc3QgYmxvY2sgPSBhd2FpdCBjb3JlLmdldCgwLCBvcHRzKQogICAgaWYgKCFibG9jaykgdGhyb3cgbmV3IEVycm9yKCdDb3JlIGlzIGVtcHR5LicpCiAgICBpZiAoIWI0YS5pc0J1ZmZlcihibG9jaykpIHJldHVybiBpc0F1dG9iYXNlTWVzc2FnZShibG9jaykKCiAgICB0cnkgewogICAgICBjb25zdCBtID0gYy5kZWNvZGUobWVzc2FnZXMuT3Bsb2dNZXNzYWdlLCBibG9jaykKICAgICAgcmV0dXJuIGlzQXV0b2Jhc2VNZXNzYWdlKG0pCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQoKICAvLyBubyBndWFyYW50ZWVzIHdoZXJlIHRoZSB1c2VyIGRhdGEgaXMgc3RvcmVkLCBqdXN0IHRoYXQgaXRzIGFzc29jaWF0ZWQgd2l0aCB0aGUgYmFzZQogIGFzeW5jIHNldFVzZXJEYXRhKGtleSwgdmFsKSB7CiAgICBhd2FpdCB0aGlzLl9wcmVvcGVuCiAgICBjb25zdCBjb3JlID0gdGhpcy5fcHJpbWFyeUJvb3RzdHJhcCA9PT0gbnVsbCA/IHRoaXMubG9jYWwgOiB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwCgogICAgYXdhaXQgY29yZS5zZXRVc2VyRGF0YShrZXksIHZhbCkKICB9CgogIGFzeW5jIGdldFVzZXJEYXRhKGtleSkgewogICAgYXdhaXQgdGhpcy5fcHJlb3BlbgogICAgY29uc3QgY29yZSA9IHRoaXMuX3ByaW1hcnlCb290c3RyYXAgPT09IG51bGwgPyB0aGlzLmxvY2FsIDogdGhpcy5fcHJpbWFyeUJvb3RzdHJhcAoKICAgIHJldHVybiBhd2FpdCBjb3JlLmdldFVzZXJEYXRhKGtleSkKICB9CgogIF9uZWVkc0xvY2FsV3JpdGVyKCkgewogICAgcmV0dXJuIHRoaXMubG9jYWxXcml0ZXIgPT09IG51bGwgfHwgdGhpcy5sb2NhbFdyaXRlci5jbG9zZWQKICB9CgogIC8vIG5vIGd1YXJhbnRlZXMgYWJvdXQgd3JpdGVyLmlzQWN0aXZlSW5kZXhlciBwcm9wZXJ0eSBoZXJlCiAgYXN5bmMgX2dldFdyaXRlckJ5S2V5KGtleSwgbGVuLCBzZWVuLCBhbGxvd0dDLCBpc0FkZGVkLCBzeXN0ZW0pIHsKICAgIGFzc2VydCh0aGlzLl9kcmFpbmluZyA9PT0gdHJ1ZSB8fCAodGhpcy5vcGVuaW5nICYmICF0aGlzLm9wZW5lZCkgfHwgdGhpcy5fb3B0aW1pc3RpYyA+IC0xKQoKICAgIGF3YWl0IHRoaXMuX2xvY2subG9jaygpCgogICAgaWYgKHRoaXMuX2ludGVycnVwdGluZykgewogICAgICB0aGlzLl9sb2NrLnVubG9jaygpCiAgICAgIHRocm93IG5ldyBFcnJvcignQXV0b2Jhc2UgaXMgY2xvc2luZycpCiAgICB9CgogICAgdHJ5IHsKICAgICAgbGV0IHcgPSB0aGlzLmFjdGl2ZVdyaXRlcnMuZ2V0KGtleSkKCiAgICAgIGNvbnN0IGFscmVhZHlBY3RpdmUgPSAhIXcKICAgICAgY29uc3Qgc3lzID0gc3lzdGVtIHx8IHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtCiAgICAgIGNvbnN0IHdyaXRlckluZm8gPSBhd2FpdCBzeXMuZ2V0KGtleSkKCiAgICAgIGlmIChsZW4gPT09IC0xKSB7CiAgICAgICAgaWYgKCFhbGxvd0dDICYmIHdyaXRlckluZm8gPT09IG51bGwpIHsKICAgICAgICAgIGlmICh3KSB3LmlzUmVtb3ZlZCA9ICFpc0FkZGVkCiAgICAgICAgICByZXR1cm4gbnVsbAogICAgICAgIH0KCiAgICAgICAgbGVuID0gd3JpdGVySW5mbyA9PT0gbnVsbCA/IDAgOiB3cml0ZXJJbmZvLmxlbmd0aAogICAgICB9CgogICAgICBjb25zdCBpc0FjdGl2ZSA9IHdyaXRlckluZm8gIT09IG51bGwgJiYgKGlzQWRkZWQgfHwgIXdyaXRlckluZm8uaXNSZW1vdmVkKQogICAgICBjb25zdCBpc1JlbW92ZWQgPSAhaXNBY3RpdmUKCiAgICAgIGlmICh3KSB7CiAgICAgICAgdy5pc1JlbW92ZWQgPSBpc1JlbW92ZWQKICAgICAgfSBlbHNlIHsKICAgICAgICB3ID0gdGhpcy5fbWFrZVdyaXRlcihrZXksIGxlbiwgaXNBY3RpdmUsIGlzUmVtb3ZlZCkKICAgICAgICBpZiAoIXcpIHJldHVybiBudWxsCiAgICAgIH0KCiAgICAgIGlmIChpc1JlbW92ZWQgJiYgc3lzLmJvb3RzdHJhcHBpbmcgJiYgYjRhLmVxdWFscyh3LmNvcmUua2V5LCB0aGlzLmtleSkpIHsKICAgICAgICB3LmlzUmVtb3ZlZCA9IGZhbHNlCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9pc0xvY2FsQ29yZSh3LmNvcmUpICYmIHRoaXMuX25lZWRzTG9jYWxXcml0ZXIoKSkgewogICAgICAgIHRoaXMuX3NldExvY2FsV3JpdGVyKHcpCiAgICAgIH0KCiAgICAgIHcuc2VlbihzZWVuKQoKICAgICAgaWYgKGFscmVhZHlBY3RpdmUpIHJldHVybiB3CgogICAgICBhd2FpdCB3LnJlYWR5KCkKCiAgICAgIGlmICh0aGlzLl9pc0xvY2FsQ29yZSh3LmNvcmUpICYmIHRoaXMuX25lZWRzTG9jYWxXcml0ZXIoKSkgewogICAgICAgIHRoaXMuX3NldExvY2FsV3JpdGVyKHcpCiAgICAgIH0KCiAgICAgIGlmIChhbGxvd0dDICYmIHcuZmx1c2hlZCgpKSB7CiAgICAgICAgdGhpcy5fd2FrZXVwLnVucXVldWUoa2V5LCBsZW4pCiAgICAgICAgaWYgKHcgIT09IHRoaXMubG9jYWxXcml0ZXIpIHsKICAgICAgICAgIGF3YWl0IHcuY2xvc2UoKQogICAgICAgICAgcmV0dXJuIHcKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuYWN0aXZlV3JpdGVycy5hZGQodykKICAgICAgdGhpcy5fY2hlY2tXcml0ZXJzLnB1c2godykKCiAgICAgIGFzc2VydCh3Lm9wZW5lZCkKICAgICAgYXNzZXJ0KCF3LmNsb3NlZCkKCiAgICAgIHcudXBkYXRlQWN0aXZpdHkoKQogICAgICByZXR1cm4gdwogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fbG9jay51bmxvY2soKQogICAgfQogIH0KCiAgX3VwZGF0ZUFsbCgpIHsKICAgIGNvbnN0IHAgPSBbXQogICAgZm9yIChjb25zdCB3IG9mIHRoaXMuYWN0aXZlV3JpdGVycykgcC5wdXNoKHcudXBkYXRlKG51bGwpLmNhdGNoKHNhZmV0eUNhdGNoKSkKICAgIHJldHVybiBQcm9taXNlLmFsbChwKQogIH0KCiAgZ2V0V3JpdGVyRW5jcnlwdGlvbigpIHsKICAgIGlmICghdGhpcy5lbmNyeXB0aW9uS2V5KSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHRoaXMuZW5jcnlwdGlvbi5nZXRXcml0ZXJFbmNyeXB0aW9uKCkKICB9CgogIF9tYWtlV3JpdGVyQ29yZShrZXkpIHsKICAgIGlmICh0aGlzLmNsb3NpbmcpIHRocm93IG5ldyBFcnJvcignQXV0b2Jhc2UgaXMgY2xvc2luZycpCiAgICBpZiAodGhpcy5faW50ZXJydXB0aW5nKSB0aHJvdyBJTlRFUlJVUFQoKQoKICAgIGNvbnN0IGxvY2FsID0gYjRhLmVxdWFscyhrZXksIHRoaXMubG9jYWwua2V5KQogICAgY29uc3QgZW5jcnlwdGlvbiA9IHRoaXMuZ2V0V3JpdGVyRW5jcnlwdGlvbigpCgogICAgY29uc3QgY29yZSA9IGxvY2FsCiAgICAgID8gdGhpcy5sb2NhbC5zZXNzaW9uKHsgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlLCBlbmNyeXB0aW9uLCBhY3RpdmU6IGZhbHNlIH0pCiAgICAgIDogdGhpcy5zdG9yZS5nZXQoewogICAgICAgICAga2V5LAogICAgICAgICAgY29tcGF0OiBmYWxzZSwKICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZSwKICAgICAgICAgIGVuY3J5cHRpb24sCiAgICAgICAgICBhY3RpdmU6IGZhbHNlCiAgICAgICAgfSkKCiAgICByZXR1cm4gY29yZQogIH0KCiAgX21ha2VXcml0ZXIoa2V5LCBsZW5ndGgsIGlzQWN0aXZlLCBpc1JlbW92ZWQpIHsKICAgIGNvbnN0IGNvcmUgPSB0aGlzLl9tYWtlV3JpdGVyQ29yZShrZXkpCiAgICBjb25zdCB3ID0gbmV3IFdyaXRlcih0aGlzLCBjb3JlLCBsZW5ndGgsIGlzUmVtb3ZlZCkKCiAgICBpZiAodGhpcy5faXNMb2NhbENvcmUoY29yZSkpIHsKICAgICAgaWYgKGlzQWN0aXZlKSB0aGlzLl9zZXRMb2NhbFdyaXRlcih3KSAvLyBvbmx5IHNldCBhY3RpdmUgd3JpdGVyCiAgICAgIHJldHVybiB3CiAgICB9CgogICAgY29yZS5vbignYXBwZW5kJywgdGhpcy5fb25yZW1vdGV3cml0ZXJjaGFuZ2VCb3VuZCkKICAgIGNvcmUub24oJ2Rvd25sb2FkJywgdGhpcy5fb25yZW1vdGV3cml0ZXJjaGFuZ2VCb3VuZCkKICAgIGNvcmUub24oJ21hbmlmZXN0JywgdGhpcy5fb25yZW1vdGV3cml0ZXJjaGFuZ2VCb3VuZCkKCiAgICByZXR1cm4gdwogIH0KCiAgX3VwZGF0ZUxpbmVhcml6ZXIoaW5kZXhlcnMsIGhlYWRzKSB7CiAgICAvLyBvbmx5IGN1cnJlbnQgYWN0aXZlIGluZGV4ZXJzIGFyZSByZXNldCB0byB0cnVlIGJlbG93CiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5hY3RpdmVXcml0ZXJzKSB3LmlzQWN0aXZlSW5kZXhlciA9IGZhbHNlCiAgICBpZiAodGhpcy5sb2NhbFdyaXRlcikgdGhpcy5sb2NhbFdyaXRlci5pc0FjdGl2ZUluZGV4ZXIgPSBmYWxzZQoKICAgIGZvciAoY29uc3Qgd3JpdGVyIG9mIGluZGV4ZXJzKSB3cml0ZXIuaXNBY3RpdmVJbmRleGVyID0gdHJ1ZQoKICAgIGlmICh0aGlzLl9pc0FjdGl2ZUluZGV4ZXIoKSAmJiAhdGhpcy5pc0luZGV4ZXIpIHsKICAgICAgdGhpcy5fc2V0TG9jYWxJbmRleGVyKCkKICAgIH0gZWxzZSBpZiAoIXRoaXMuX2lzQWN0aXZlSW5kZXhlcigpICYmIHRoaXMuaXNJbmRleGVyKSB7CiAgICAgIHRoaXMuX2NsZWFyTG9jYWxJbmRleGVyKCkKICAgIH0KCiAgICB0aGlzLmxpbmVhcml6ZXIgPSBuZXcgTGluZWFyaXplcihpbmRleGVycywgeyBoZWFkcywgd3JpdGVyczogdGhpcy5hY3RpdmVXcml0ZXJzIH0pCgogICAgdGhpcy5fdXBkYXRlQWNrVGhyZXNob2xkKCkKICB9CgogIGFzeW5jIF91cGRhdGVMb2NhbFdyaXRlcihzeXMpIHsKICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyICE9PSBudWxsICYmICF0aGlzLmxvY2FsV3JpdGVyLmNsb3NlZCkgcmV0dXJuCiAgICBhd2FpdCB0aGlzLl9nZXRXcml0ZXJCeUtleSh0aGlzLmxvY2FsLmtleSwgLTEsIDAsIHRydWUsIGZhbHNlLCBzeXMpCiAgfQoKICBhc3luYyBfYm9vdHN0cmFwTGluZWFyaXplcigpIHsKICAgIGNvbnN0IGJvb3RzdHJhcCA9IHRoaXMuX21ha2VXcml0ZXIodGhpcy5rZXksIDAsIHRydWUsIGZhbHNlKQoKICAgIHRoaXMuYWN0aXZlV3JpdGVycy5hZGQoYm9vdHN0cmFwKQogICAgdGhpcy5fY2hlY2tXcml0ZXJzLnB1c2goYm9vdHN0cmFwKQogICAgYXdhaXQgYm9vdHN0cmFwLnJlYWR5KCkKICAgIHRoaXMuX2Vuc3VyZVdha2V1cChib290c3RyYXApCgogICAgdGhpcy5fdXBkYXRlTGluZWFyaXplcihbYm9vdHN0cmFwXSwgW10pCiAgfQoKICBhc3luYyBfbWFrZUxpbmVhcml6ZXIoc3lzKSB7CiAgICBpZiAoc3lzID09PSBudWxsKSB7CiAgICAgIHJldHVybiB0aGlzLl9ib290c3RyYXBMaW5lYXJpemVyKCkKICAgIH0KCiAgICBpZiAodGhpcy5vcGVuZWQgfHwgKGF3YWl0IHN5cy5oYXNMb2NhbCh0aGlzLmxvY2FsLmtleSkpKSB7CiAgICAgIGF3YWl0IHRoaXMuX3VwZGF0ZUxvY2FsV3JpdGVyKHN5cykKICAgIH0KCiAgICBjb25zdCBpbmRleGVycyA9IFtdCgogICAgZm9yIChjb25zdCBoZWFkIG9mIHN5cy5pbmRleGVycykgewogICAgICBjb25zdCB3cml0ZXIgPSBhd2FpdCB0aGlzLl9nZXRXcml0ZXJCeUtleShoZWFkLmtleSwgaGVhZC5sZW5ndGgsIDAsIGZhbHNlLCBmYWxzZSwgc3lzKQogICAgICBpbmRleGVycy5wdXNoKHdyaXRlcikKICAgIH0KCiAgICBpZiAoIXRoaXMuX2lzQWN0aXZlSW5kZXhlcigpKSB7CiAgICAgIGZvciAoY29uc3Qga2V5IG9mIHN5cy5wZW5kaW5nSW5kZXhlcnMpIHsKICAgICAgICBpZiAoYjRhLmVxdWFscyhrZXksIHRoaXMubG9jYWwua2V5KSkgewogICAgICAgICAgdGhpcy5fc2V0TG9jYWxJbmRleGVyKCkKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdGhpcy5fdXBkYXRlTGluZWFyaXplcihpbmRleGVycywgc3lzLmhlYWRzKQoKICAgIGZvciAoY29uc3QgeyBrZXksIGxlbmd0aCB9IG9mIHN5cy5oZWFkcykgewogICAgICBhd2FpdCB0aGlzLl9nZXRXcml0ZXJCeUtleShrZXksIGxlbmd0aCwgMCwgZmFsc2UsIGZhbHNlLCBzeXMpCiAgICB9CiAgfQoKICBhc3luYyBfY2xlYXJXcml0ZXJzKCkgewogICAgYXdhaXQgdGhpcy5hY3RpdmVXcml0ZXJzLmNsZWFyKCkKICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyICE9PSBudWxsKSBhd2FpdCB0aGlzLmxvY2FsV3JpdGVyLmNsb3NlKCkKICAgIHRoaXMuX2NoZWNrV3JpdGVycyA9IFtdCiAgfQoKICBhc3luYyBfbWFrZUxpbmVhcml6ZXJGcm9tVmlld1N0YXRlKCkgewogICAgY29uc3Qgc3lzID0gYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5nZXRJbmRleGVkU3lzdGVtKCkKICAgIGF3YWl0IHRoaXMuX21ha2VMaW5lYXJpemVyKHN5cykKICAgIGF3YWl0IHN5cy5jbG9zZSgpCiAgfQoKICBhc3luYyBfcnVuRm9yY2VGYXN0Rm9yd2FyZCgpIHsKICAgIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCiAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4KICAgIGNvbnN0IHJlYyA9IHRoaXMuX2FwcGx5U3RhdGUgPyBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnJlY292ZXJBdCgpIDogbnVsbAogICAgYXdhaXQgdGhpcy5fcnVuRmFzdEZvcndhcmQoCiAgICAgIG5ldyBGYXN0Rm9yd2FyZCh0aGlzLCB0aGlzLmNvcmUua2V5LCB7IGZvcmNlOiB0cnVlLCBsZW5ndGg6IHJlYyA/IHJlYy5sZW5ndGggOiAwIH0pCiAgICApCiAgfQoKICAvLyBnZW5lcmFsIHJlcGFpciBtZXRob2QgZm9yIHRyeWluZyB0byByZWNvdmVyCiAgYXN5bmMgcmVwYWlyKCkgewogICAgYXdhaXQgdGhpcy5mb3JjZUZhc3RGb3J3YXJkKCkKICB9CgogIGFzeW5jIGZvcmNlRmFzdEZvcndhcmQoKSB7CiAgICBpZiAodGhpcy5pc0Zhc3RGb3J3YXJkaW5nKCkpIHJldHVybgogICAgYXdhaXQgdGhpcy5fcnVuRm9yY2VGYXN0Rm9yd2FyZCgpCiAgICBhd2FpdCB0aGlzLnVwZGF0ZSgpCiAgfQoKICBhc3luYyBfYXBwbHlGYXN0Rm9yd2FyZCgpIHsKICAgIGlmICgKICAgICAgIXRoaXMuZmFzdEZvcndhcmRUby5mb3JjZSAmJgogICAgICB0aGlzLmZhc3RGb3J3YXJkVG8ubGVuZ3RoIDwgdGhpcy5jb3JlLmxlbmd0aCArIHRoaXMuZmFzdEZvcndhcmRUby5taW5pbXVtCiAgICApIHsKICAgICAgdGhpcy5mYXN0Rm9yd2FyZFRvID0gbnVsbAogICAgICB0aGlzLl91cGRhdGVBY3Rpdml0eSgpCiAgICAgIC8vIHN0aWxsIG5vdCB3b3J0aCBpdAogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBjaGFuZ2VzID0gdGhpcy5faGFzVXBkYXRlID8gbmV3IFVwZGF0ZUNoYW5nZXModGhpcykgOiBudWxsCiAgICBpZiAoY2hhbmdlcykgY2hhbmdlcy50cmFjayh0aGlzLl9hcHBseVN0YXRlKQoKICAgIC8vIGNsb3NlIGV4aXN0aW5nIHN0YXRlCiAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZSkgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5jbG9zZSgpCgogICAgY29uc3QgeyBrZXksIGxlbmd0aCwgdmlld3MsIGluZGV4ZXJzLCBtYW5pZmVzdFZlcnNpb24sIGVudHJvcHkgfSA9IHRoaXMuZmFzdEZvcndhcmRUbwoKICAgIGNvbnN0IGZyb20gPSB0aGlzLmNvcmUuc2lnbmVkTGVuZ3RoCiAgICBjb25zdCBmZmVkID0gbmV3IFNldCgpCgogICAgdGhpcy5fZmx1c2hpbmcrKwogICAgdHJ5IHsKICAgICAgY29uc3Qgc3RvcmUgPSB0aGlzLl92aWV3U3RvcmUuYXRvbWl6ZSgpCgogICAgICBjb25zdCBtaWdyYXRlZCA9ICFiNGEuZXF1YWxzKGtleSwgdGhpcy5jb3JlLmtleSkKCiAgICAgIGNvbnN0IHN5c3RlbVJlZiA9IGF3YWl0IHRoaXMuX3ZpZXdTdG9yZS5maW5kVmlld0J5S2V5KGtleSwgaW5kZXhlcnMsIG1hbmlmZXN0VmVyc2lvbiwgZW50cm9weSkKICAgICAgZmZlZC5hZGQoc3lzdGVtUmVmKQoKICAgICAgaWYgKG1pZ3JhdGVkKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fYXBwbHlGYXN0Rm9yd2FyZE1pZ3JhdGlvbihzeXN0ZW1SZWYsIHsga2V5LCBsZW5ndGggfSkKICAgICAgfSBlbHNlIHsKICAgICAgICBhd2FpdCBzeXN0ZW1SZWYuY2F0Y2h1cChzdG9yZS5hdG9tLCBsZW5ndGgpCiAgICAgIH0KCiAgICAgIGZvciAoY29uc3QgdiBvZiB2aWV3cykgewogICAgICAgIGNvbnN0IHJlZiA9IGF3YWl0IHRoaXMuX3ZpZXdTdG9yZS5maW5kVmlld0J5S2V5KHYua2V5LCBpbmRleGVycywgbWFuaWZlc3RWZXJzaW9uLCBlbnRyb3B5KQogICAgICAgIGlmICghcmVmKSBjb250aW51ZSAvLyB1bmtub3duLCB2aWV3IGlnbm9yZWQKICAgICAgICBmZmVkLmFkZChyZWYpCgogICAgICAgIGlmIChtaWdyYXRlZCkgewogICAgICAgICAgYXdhaXQgdGhpcy5fYXBwbHlGYXN0Rm9yd2FyZE1pZ3JhdGlvbihyZWYsIHYpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGF3YWl0IHJlZi5jYXRjaHVwKHN0b3JlLmF0b20sIHYubGVuZ3RoKQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGZmZWQuc2l6ZSAhPT0gc3RvcmUuZ2V0Vmlld0NvdW50KCkpIHsKICAgICAgICBmb3IgKGNvbnN0IHJlZiBvZiBzdG9yZS5nZXRWaWV3cygpKSB7CiAgICAgICAgICBpZiAoZmZlZC5oYXMocmVmKSkgY29udGludWUKICAgICAgICAgIGF3YWl0IHJlZi5jYXRjaHVwKHN0b3JlLmF0b20sIDApIC8vIGl0cyBnb25lCiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBtaWdyYXRlIHplcm8gbGVuZ3RoIGNvcmVzCiAgICAgIGlmIChtaWdyYXRlZCkgewogICAgICAgIGNvbnN0IG1hbmlmZXN0cyA9IGF3YWl0IHRoaXMuX3ZpZXdTdG9yZS5nZXRJbmRleGVyTWFuaWZlc3RzKGluZGV4ZXJzKQoKICAgICAgICBmb3IgKGNvbnN0IFtuYW1lLCByZWZdIG9mIHRoaXMuX3ZpZXdTdG9yZS5ieU5hbWUpIHsKICAgICAgICAgIGlmIChmZmVkLmhhcyhyZWYpKSBjb250aW51ZQogICAgICAgICAgYXdhaXQgdGhpcy5fbWlncmF0ZVZpZXcobWFuaWZlc3RzLCBudWxsLCBuYW1lLCAwLCBtYW5pZmVzdFZlcnNpb24sIGVudHJvcHksIFtdLCBudWxsKQogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgdmFsdWUgPSBjLmVuY29kZShtZXNzYWdlcy5Cb290UmVjb3JkLCB7CiAgICAgICAgdmVyc2lvbjogQk9PVF9SRUNPUkRfVkVSU0lPTiwKICAgICAgICBrZXksCiAgICAgICAgc3lzdGVtTGVuZ3RoOiBsZW5ndGgsCiAgICAgICAgaW5kZXhlcnNVcGRhdGVkOiBmYWxzZSwKICAgICAgICBmYXN0Rm9yd2FyZGluZzogdHJ1ZSwKICAgICAgICByZWNvdmVyaWVzOiBSRUNPVkVSSUVTCiAgICAgIH0pCgogICAgICBjb25zdCBsb2NhbCA9IHN0b3JlLmdldExvY2FsKCkKICAgICAgYXdhaXQgbG9jYWwucmVhZHkoKQogICAgICBhd2FpdCBsb2NhbC5zZXRVc2VyRGF0YSgnYXV0b2Jhc2UvYm9vdCcsIHZhbHVlKQoKICAgICAgYXdhaXQgTG9jYWxTdGF0ZS5jbGVhcihsb2NhbCkKCiAgICAgIGlmIChjaGFuZ2VzKSBjaGFuZ2VzLmZpbmFsaXNlKCkKCiAgICAgIGF3YWl0IHN0b3JlLmZsdXNoKCkKICAgICAgYXdhaXQgc3RvcmUuY2xvc2UoKQogICAgfSBmaW5hbGx5IHsKICAgICAgaWYgKC0tdGhpcy5fZmx1c2hpbmcgPT09IDApIHRoaXMuX2ZsdXNoU2lnbmFsLm5vdGlmeSgpCiAgICB9CgogICAgY29uc3QgdG8gPSB0aGlzLmNvcmUuc2lnbmVkTGVuZ3RoCgogICAgZm9yIChjb25zdCByZWYgb2YgZmZlZCkgYXdhaXQgcmVmLnJlbGVhc2UoKQoKICAgIHRoaXMucmVjb3ZlcmllcyA9IFJFQ09WRVJJRVMKICAgIHRoaXMuZmFzdEZvcndhcmRUbyA9IG51bGwKICAgIHRoaXMuX3F1ZXVlRmFzdEZvcndhcmQoKQoKICAgIGF3YWl0IHRoaXMuX2NsZWFyV3JpdGVycygpCgogICAgdGhpcy5fYXBwbHlTdGF0ZSA9IG5ldyBBcHBseVN0YXRlKHRoaXMpCiAgICBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnJlYWR5KCkKCiAgICBpZiAoY2hhbmdlcykgYXdhaXQgdGhpcy5faGFuZGxlcnMudXBkYXRlKHRoaXMuX2FwcGx5U3RhdGUudmlldywgY2hhbmdlcykKCiAgICBpZiAoYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5zaG91bGRNaWdyYXRlKCkpIHsKICAgICAgYXdhaXQgdGhpcy5fbWlncmF0ZSgpCiAgICB9IGVsc2UgewogICAgICBhd2FpdCB0aGlzLl9tYWtlTGluZWFyaXplckZyb21WaWV3U3RhdGUoKQogICAgICBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmNhdGNodXAodGhpcy5saW5lYXJpemVyKQogICAgfQoKICAgIGlmICghdGhpcy5sb2NhbFdyaXRlciB8fCB0aGlzLmxvY2FsV3JpdGVyLmNsb3NlZCkgewogICAgICBhd2FpdCB0aGlzLl91cGRhdGVMb2NhbFdyaXRlcih0aGlzLl9hcHBseVN0YXRlLnN5c3RlbSkKICAgIH0KCiAgICB0aGlzLl9jYXVnaHR1cCA9IHRydWUKCiAgICB0aGlzLl9yZWJvb3RlZCgpCiAgICB0aGlzLmVtaXQoJ2Zhc3QtZm9yd2FyZCcsIHRvLCBmcm9tKQogIH0KCiAgLy8gVE9ETzogbm90IGF0b21pYyBpbiByZWdhcmRzIHRvIHRoZSBmZiwgZml4IHRoYXQKICBhc3luYyBfYXBwbHlGYXN0Rm9yd2FyZE1pZ3JhdGlvbihyZWYsIHYpIHsKICAgIGNvbnN0IG5leHQgPSB0aGlzLnN0b3JlLmdldCh2LmtleSkKICAgIGF3YWl0IG5leHQucmVhZHkoKQoKICAgIGNvbnN0IHByb2xvZ3VlID0gbmV4dC5tYW5pZmVzdCAmJiBuZXh0Lm1hbmlmZXN0LnByb2xvZ3VlCgogICAgaWYgKHByb2xvZ3VlICYmIHByb2xvZ3VlLmxlbmd0aCA+IDAgJiYgcmVmLmNvcmUubGVuZ3RoID49IHByb2xvZ3VlLmxlbmd0aCkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IG5leHQuY29yZS5jb3B5UHJvbG9ndWUocmVmLmNvcmUuc3RhdGUpCiAgICAgIH0gY2F0Y2ggewogICAgICAgIC8vIHdlIG1pZ2h0IGJlIG1pc3Npbmcgc29tZSBub2RlcyBmb3IgdGhpcywganVzdCBpZ25vcmUsIG9ubHkgYW4gb3B0aW1pc2F0aW9uCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBiYXRjaCA9IG5leHQuc2Vzc2lvbih7IG5hbWU6ICdiYXRjaCcsIG92ZXJ3cml0ZTogdHJ1ZSwgY2hlY2tvdXQ6IHYubGVuZ3RoIH0pCiAgICBhd2FpdCBiYXRjaC5yZWFkeSgpCgogICAgLy8gcmVtYWtlIHRoZSBiYXRjaCwgcmVzZXQgZnJvbSBvdXIgcHJvbG9ndWUgaW4gY2FzZSBpdCByZXBsaWNhdGVkIGluYmV0d2VlbgogICAgLy8gVE9ETzogd2Ugc2hvdWxkIHJlYWxseSBoYXZlIGFuIEhDIGZ1bmN0aW9uIGZvciB0aGlzCgogICAgYXdhaXQgcmVmLmJhdGNoLnN0YXRlLm1vdmVUbyhiYXRjaCwgYmF0Y2gubGVuZ3RoKQogICAgYXdhaXQgYmF0Y2guY2xvc2UoKQoKICAgIHJlZi5taWdyYXRlZCh0aGlzLCBuZXh0KQogIH0KCiAgYXN5bmMgX21pZ3JhdGVWaWV3KAogICAgaW5kZXhlck1hbmlmZXN0cywKICAgIHNvdXJjZSwKICAgIG5hbWUsCiAgICBpbmRleGVkTGVuZ3RoLAogICAgbWFuaWZlc3RWZXJzaW9uLAogICAgZW50cm9weSwKICAgIGxpbmtlZCwKICAgIG1hbmlmZXN0RGF0YQogICkgewogICAgY29uc3QgcmVmID0gdGhpcy5fdmlld1N0b3JlLmJ5TmFtZS5nZXQobmFtZSkKCiAgICBjb25zdCBwcm9sb2d1ZSA9CiAgICAgIGluZGV4ZWRMZW5ndGggPT09IDAKICAgICAgICA/IG51bGwKICAgICAgICA6IHsgbGVuZ3RoOiBpbmRleGVkTGVuZ3RoLCBoYXNoOiBhd2FpdCBzb3VyY2UudHJlZUhhc2goaW5kZXhlZExlbmd0aCkgfQoKICAgIGlmIChtYW5pZmVzdERhdGEgPT09IG51bGwgJiYgcmVmLmNvcmUubWFuaWZlc3QudXNlckRhdGEgIT09IG51bGwpIHsKICAgICAgbWFuaWZlc3REYXRhID0gcmVmLmNvcmUubWFuaWZlc3QudXNlckRhdGEKICAgIH0KCiAgICBjb25zdCBuZXh0ID0gdGhpcy5fdmlld1N0b3JlLmdldFZpZXdDb3JlKAogICAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgICBuYW1lLAogICAgICBwcm9sb2d1ZSwKICAgICAgbWFuaWZlc3RWZXJzaW9uLAogICAgICBlbnRyb3B5LAogICAgICBsaW5rZWQsCiAgICAgIG1hbmlmZXN0RGF0YQogICAgKQogICAgYXdhaXQgbmV4dC5yZWFkeSgpCgogICAgaWYgKGluZGV4ZWRMZW5ndGggPiAwKSB7CiAgICAgIGF3YWl0IG5leHQuY29yZS5jb3B5UHJvbG9ndWUoc291cmNlLnN0YXRlKQogICAgfQoKICAgIC8vIHJlbWFrZSB0aGUgYmF0Y2gsIHJlc2V0IGZyb20gb3VyIHByb2xvZ3VlIGluIGNhc2UgaXQgcmVwbGljYXRlZCBpbmJldHdlZW4KICAgIC8vIFRPRE86IHdlIHNob3VsZCByZWFsbHkgaGF2ZSBhbiBIQyBmdW5jdGlvbiBmb3IgdGhpcwogICAgY29uc3QgYmF0Y2ggPSBuZXh0LnNlc3Npb24oeyBuYW1lOiAnYmF0Y2gnLCBvdmVyd3JpdGU6IHRydWUsIGNoZWNrb3V0OiBpbmRleGVkTGVuZ3RoIH0pCiAgICBhd2FpdCBiYXRjaC5yZWFkeSgpCgogICAgaWYgKHNvdXJjZSAhPT0gbnVsbCkgewogICAgICB3aGlsZSAoYmF0Y2gubGVuZ3RoIDwgc291cmNlLmxlbmd0aCkgewogICAgICAgIGF3YWl0IGJhdGNoLmFwcGVuZChhd2FpdCBzb3VyY2UuZ2V0KGJhdGNoLmxlbmd0aCkpCiAgICAgIH0KICAgIH0KCiAgICBhd2FpdCByZWYuYmF0Y2guc3RhdGUubW92ZVRvKGJhdGNoLCBiYXRjaC5sZW5ndGgpCiAgICBhd2FpdCBiYXRjaC5jbG9zZSgpCgogICAgcmVmLm1pZ3JhdGVkKHRoaXMsIG5leHQpCgogICAgcmV0dXJuIHJlZgogIH0KCiAgYXN5bmMgX3ByZW1pZ3JhdGUoKSB7CiAgICB0aGlzLl9mbHVzaGluZysrCiAgICB0cnkgewogICAgICBjb25zdCBsZW5ndGggPSB0aGlzLl9hcHBseVN0YXRlLmluZGV4ZWRMZW5ndGgKICAgICAgY29uc3Qgc3lzdGVtID0gdGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0KCiAgICAgIGNvbnN0IGluZm8gPSBhd2FpdCBzeXN0ZW0uZ2V0SW5kZXhlZEluZm8obGVuZ3RoKQogICAgICBjb25zdCBpbmRleGVyTWFuaWZlc3RzID0gYXdhaXQgdGhpcy5fdmlld1N0b3JlLmdldEluZGV4ZXJNYW5pZmVzdHMoaW5mby5pbmRleGVycykKCiAgICAgIGNvbnN0IHsgdmlld3MsIHN5c3RlbVZpZXcsIGVuY3J5cHRpb25WaWV3IH0gPSB0aGlzLl9hcHBseVN0YXRlCgogICAgICBjb25zdCBtYW5pZmVzdFZlcnNpb24gPSB0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5jb3JlLm1hbmlmZXN0LnZlcnNpb24KCiAgICAgIGZvciAoY29uc3QgdmlldyBvZiB2aWV3cykgewogICAgICAgIGNvbnN0IHYgPSB0aGlzLl9hcHBseVN0YXRlLmdldFZpZXdGcm9tU3lzdGVtKHZpZXcsIGluZm8pCiAgICAgICAgY29uc3QgaW5kZXhlZExlbmd0aCA9IHYgPyB2Lmxlbmd0aCA6IDAKCiAgICAgICAgY29uc3QgcmVmID0gdGhpcy5fdmlld1N0b3JlLmdldFZpZXdCeU5hbWUodmlldy5uYW1lKQogICAgICAgIGNvbnN0IHNvdXJjZSA9IHJlZi5nZXRDb3JlKCkKICAgICAgICBhd2FpdCBzb3VyY2UucmVhZHkoKQoKICAgICAgICBhd2FpdCB0aGlzLl9taWdyYXRlVmlldygKICAgICAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgICAgICBzb3VyY2UsCiAgICAgICAgICB2aWV3Lm5hbWUsCiAgICAgICAgICBpbmRleGVkTGVuZ3RoLAogICAgICAgICAgbWFuaWZlc3RWZXJzaW9uLAogICAgICAgICAgaW5mby5lbnRyb3B5LAogICAgICAgICAgbnVsbCwKICAgICAgICAgIG51bGwKICAgICAgICApCiAgICAgIH0KCiAgICAgIGNvbnN0IHNvdXJjZSA9IGVuY3J5cHRpb25WaWV3LnJlZi5nZXRDb3JlKCkKICAgICAgYXdhaXQgc291cmNlLnJlYWR5KCkKCiAgICAgIGNvbnN0IGVuYyA9IGF3YWl0IHRoaXMuX21pZ3JhdGVWaWV3KAogICAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgICAgc291cmNlLAogICAgICAgICdfZW5jcnlwdGlvbicsCiAgICAgICAgaW5mby5lbmNyeXB0aW9uTGVuZ3RoLAogICAgICAgIG1hbmlmZXN0VmVyc2lvbiwKICAgICAgICBpbmZvLmVudHJvcHksCiAgICAgICAgbnVsbCwKICAgICAgICBudWxsCiAgICAgICkKCiAgICAgIGNvbnN0IGxpbmtlZCA9IFtlbmMuY29yZS5rZXldCgogICAgICBjb25zdCBzeXNDb3JlID0gc3lzdGVtVmlldy5yZWYuZ2V0Q29yZSgpCiAgICAgIGNvbnN0IHJlZiA9IGF3YWl0IHRoaXMuX21pZ3JhdGVWaWV3KAogICAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgICAgc3lzQ29yZSwKICAgICAgICAnX3N5c3RlbScsCiAgICAgICAgbGVuZ3RoLAogICAgICAgIG1hbmlmZXN0VmVyc2lvbiwKICAgICAgICBpbmZvLmVudHJvcHksCiAgICAgICAgbGlua2VkLAogICAgICAgIG51bGwsCiAgICAgICAgbnVsbAogICAgICApCgogICAgICByZXR1cm4gcmVmLmNvcmUua2V5CiAgICB9IGZpbmFsbHkgewogICAgICBpZiAoLS10aGlzLl9mbHVzaGluZyA9PT0gMCkgdGhpcy5fZmx1c2hTaWduYWwubm90aWZ5KCkKICAgIH0KICB9CgogIGFzeW5jIF9taWdyYXRlKCkgewogICAgcmV0dXJuIHRoaXMuX3JlYm9vdChhd2FpdCB0aGlzLl9wcmVtaWdyYXRlKCkpCiAgfQoKICBhc3luYyBfcmVib290KGtleSkgewogICAgYXdhaXQgdGhpcy5fY2xlYXJXcml0ZXJzKCkKICAgIGF3YWl0IHRoaXMuX21ha2VMaW5lYXJpemVyRnJvbVZpZXdTdGF0ZSgpCgogICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5maW5hbGl6ZShrZXkpCgogICAgdGhpcy5fYXBwbHlTdGF0ZSA9IG5ldyBBcHBseVN0YXRlKHRoaXMpCgogICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5yZWFkeSgpCiAgICBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmNhdGNodXAodGhpcy5saW5lYXJpemVyKQoKICAgIC8vIGVuZCBzb2Z0IHNodXRkb3duCgogICAgdGhpcy5fcXVldWVGYXN0Rm9yd2FyZCgpCgogICAgdGhpcy5fcmVib290ZWQoKQogIH0KCiAgX3JlYm9vdGVkKCkgewogICAgdGhpcy5yZWNvdXBsZSgpCiAgICB0aGlzLl91cGRhdGVBY3Rpdml0eSgpCgogICAgdGhpcy5lbWl0KCdyZWJvb3QnKQoKICAgIC8vIGVuc3VyZSB3ZSByZS1ldmFsdXRlIG91ciBzdGF0ZQogICAgdGhpcy5fYm9vdHN0cmFwV3JpdGVyc0NoYW5nZWQgPSB0cnVlCiAgICB0aGlzLl9uZWVkc1dha2V1cCA9IHRydWUKCiAgICB0aGlzLnVwZGF0aW5nID0gdHJ1ZQogICAgdGhpcy5fcXVldWVCdW1wKCkKICB9CgogIF9zZXRMb2NhbFdyaXRlcih3KSB7CiAgICB0aGlzLmxvY2FsV3JpdGVyID0gdwogICAgaWYgKHRoaXMuX2Fja0ludGVydmFsKSB0aGlzLl9zdGFydEFja1RpbWVyKCkKICB9CgogIF91bnNldExvY2FsV3JpdGVyKCkgewogICAgaWYgKCF0aGlzLmxvY2FsV3JpdGVyKSByZXR1cm4KCiAgICB0aGlzLl9jbG9zZVdyaXRlcih0aGlzLmxvY2FsV3JpdGVyKQogICAgaWYgKHRoaXMubG9jYWxXcml0ZXIuaXNBY3RpdmVJbmRleGVyKSB0aGlzLl9jbGVhckxvY2FsSW5kZXhlcigpCgogICAgdGhpcy5sb2NhbFdyaXRlciA9IG51bGwKICB9CgogIF9zZXRMb2NhbEluZGV4ZXIoKSB7CiAgICBhc3NlcnQodGhpcy5sb2NhbFdyaXRlciAhPT0gbnVsbCkKCiAgICB0aGlzLmlzSW5kZXhlciA9IHRydWUKICAgIHRoaXMuZW1pdCgnaXMtaW5kZXhlcicpCiAgfQoKICBfY2xlYXJMb2NhbEluZGV4ZXIoKSB7CiAgICBhc3NlcnQodGhpcy5sb2NhbFdyaXRlciAhPT0gbnVsbCkKCiAgICBpZiAodGhpcy5fYWNrVGltZXIpIHRoaXMuX2Fja1RpbWVyLnN0b3AoKQoKICAgIHRoaXMuaXNJbmRleGVyID0gZmFsc2UKICAgIHRoaXMuX2Fja1RpbWVyID0gbnVsbAoKICAgIHRoaXMuZW1pdCgnaXMtbm9uLWluZGV4ZXInKQogIH0KCiAgX2lzTG9jYWxDb3JlKGNvcmUpIHsKICAgIHJldHVybiBjb3JlLndyaXRhYmxlICYmIGNvcmUuaWQgPT09IHRoaXMubG9jYWwuaWQKICB9CgogIF9hZGRMb2NhbEhlYWRzKCkgewogICAgLy8gbm90IHdyaXRhYmxlIGF0bSwgd2lsbCBwcm9wIGJlIHdyaXRhYmxlIGluIGEgc3Vic2VxdWVudCBidW1wIHRobwogICAgaWYgKCF0aGlzLmxvY2FsV3JpdGVyIHx8IHRoaXMubG9jYWxXcml0ZXIuY2xvc2VkKSByZXR1cm4gbnVsbAogICAgLy8gc2FmZXR5LCBsb2NhbHdyaXRlciBpcyBzdGlsbCBwcm9jZXNzaW5nLCBzaG91bGQgcHJvcCBiZSBhbiBhc3NlcnRpb24KICAgIGlmICghdGhpcy5sb2NhbFdyaXRlci5pZGxlKCkpIHJldHVybiBudWxsCgogICAgY29uc3QgbGVuZ3RoID0gdGhpcy5fb3B0aW1pc3RpYyA9PT0gLTEgPyB0aGlzLl9hcHBlbmRpbmcubGVuZ3RoIDogdGhpcy5fb3B0aW1pc3RpYyB8fCAxCgogICAgY29uc3Qgbm9kZXMgPSBuZXcgQXJyYXkobGVuZ3RoKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBjb25zdCBoZWFkcyA9IHRoaXMubGluZWFyaXplci5nZXRIZWFkcygpCiAgICAgIGNvbnN0IGRlcHMgPSBuZXcgU2V0KHRoaXMubGluZWFyaXplci5oZWFkcykKICAgICAgY29uc3QgYmF0Y2ggPSBsZW5ndGggLSBpCiAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5fYXBwZW5kaW5nW2ldCgogICAgICBjb25zdCBub2RlID0gdGhpcy5sb2NhbFdyaXRlci5hcHBlbmQodmFsdWUsIGhlYWRzLCBiYXRjaCwgZGVwcywgdGhpcy5fb3B0aW1pc3RpYyA9PT0gMCkKCiAgICAgIHRoaXMubGluZWFyaXplci5hZGRIZWFkKG5vZGUpCiAgICAgIG5vZGVzW2ldID0gbm9kZQogICAgfQoKICAgIHJldHVybiBub2RlcwogIH0KCiAgX2ZsdXNoTG9jYWxIZWFkcyhsZW5ndGgpIHsKICAgIHRoaXMuX2FwcGVuZGluZyA9IGxlbmd0aCA9PT0gdGhpcy5fYXBwZW5kaW5nLmxlbmd0aCA/IG51bGwgOiB0aGlzLl9hcHBlbmRpbmcuc2xpY2UobGVuZ3RoKQogICAgdGhpcy5fYXBwZW5kZWQgKz0gbGVuZ3RoCgogICAgaWYgKHRoaXMuX29wdGltaXN0aWMgPiAtMSAmJiB0aGlzLl9vcHRpbWlzdGljIDwgbGVuZ3RoKSB0aGlzLl9vcHRpbWlzdGljID0gLTEKICB9CgogIGFzeW5jIF9hZGRSZW1vdGVIZWFkcygpIHsKICAgIGxldCBhZGRlZCA9IDAKCiAgICB3aGlsZSAoCiAgICAgIGFkZGVkIDwgUkVNT1RFX0FERF9CQVRDSCB8fAogICAgICAodGhpcy5iaWdCYXRjaGVzICYmICF0aGlzLl9pbmRleGVyc0lkbGUoKSAmJiBhZGRlZCA8IFJFTU9URV9BRERfQkFUQ0hfU0FOSVRZKQogICAgKSB7CiAgICAgIGF3YWl0IHRoaXMuX3VwZGF0ZUFsbCgpCgogICAgICBsZXQgYWR2YW5jZWQgPSAwCgogICAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5hY3RpdmVXcml0ZXJzKSB7CiAgICAgICAgbGV0IG5vZGUgPSB3LmFkdmFuY2UoKQogICAgICAgIGlmIChub2RlID09PSBudWxsKSBjb250aW51ZQoKICAgICAgICBhZHZhbmNlZCArPSBub2RlLmJhdGNoCgogICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICB0aGlzLmxpbmVhcml6ZXIuYWRkSGVhZChub2RlKQogICAgICAgICAgaWYgKG5vZGUuYmF0Y2ggPT09IDEpIGJyZWFrCiAgICAgICAgICBub2RlID0gdy5hZHZhbmNlKCkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChhZHZhbmNlZCA9PT0gMCkgewogICAgICAgIGlmICh0aGlzLmJpZ0JhdGNoZXMgJiYgIXRoaXMuX2luZGV4ZXJzSWRsZSgpICYmIChhd2FpdCB0aGlzLl93YWl0Rm9ySW5kZXhlcnMoKSkpIGNvbnRpbnVlCiAgICAgICAgYnJlYWsKICAgICAgfQoKICAgICAgYWRkZWQgKz0gYWR2YW5jZWQKICAgIH0KCiAgICByZXR1cm4gYWRkZWQKICB9CgogIGFzeW5jIF93YWl0Rm9ySW5kZXhlcnMoKSB7CiAgICBjb25zdCBwcm9taXNlcyA9IFtdCgogICAgZm9yIChjb25zdCB3IG9mIHRoaXMubGluZWFyaXplci5pbmRleGVycykgewogICAgICBpZiAody5pZGxlKCkpIGNvbnRpbnVlCiAgICAgIGlmIChhd2FpdCB3LmNvcmUuaGFzKHcubGVuZ3RoKSkgY29udGludWUKICAgICAgcHJvbWlzZXMucHVzaCh3LmNvcmUuZ2V0KHcubGVuZ3RoLCB7IHRpbWVvdXQ6IDMwMDAgfSkpCiAgICB9CgogICAgZm9yIChjb25zdCByZXN1bHQgb2YgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHByb21pc2VzKSkgewogICAgICBpZiAocmVzdWx0LnN0YXR1cyAhPT0gJ3JlamVjdGVkJykgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF9pbmRleGVyc0lkbGUoKSB7CiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5saW5lYXJpemVyLmluZGV4ZXJzKSB7CiAgICAgIGlmICghdy5pZGxlKCkpIHJldHVybiBmYWxzZQogICAgfQogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIF9kcmFpbigpIHsKICAgIGNvbnN0IHdyaXRhYmxlID0gdGhpcy53cml0YWJsZQoKICAgIHdoaWxlICghdGhpcy5faW50ZXJydXB0aW5nICYmICF0aGlzLnBhdXNlZCkgewogICAgICBpZiAodGhpcy5mYXN0Rm9yd2FyZFRvICE9PSBudWxsKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fYXBwbHlGYXN0Rm9yd2FyZCgpCiAgICAgICAgY29udGludWUgLy8gcmV2YWx1YXRlIGNvbmRpdGlvbnMuLi4KICAgICAgfQoKICAgICAgLy8gd2UgZGVmZXIgdGhpcyB0byBwb3N0IHJlYWR5IHNvIGl0cyBub3QgYmxvY2tpbmcgcmVhZGluZyB0aGUgdmlld3MKICAgICAgaWYgKHRoaXMuX2NhdWdodHVwID09PSBmYWxzZSkgewogICAgICAgIC8vIGlmIHRoZSBjYXRjaHVwIGZhaWxzLCBqdXN0IGZvcmNlIGZmIGl0IHRvIHJlY292ZXIsIGxlc3MgdXNlciBwYWluCiAgICAgICAgaWYgKCEoYXdhaXQgdGhpcy5fY2F0Y2h1cEFwcGx5U3RhdGUoKSkpIHsKICAgICAgICAgIGF3YWl0IHRoaXMuX3J1bkZvcmNlRmFzdEZvcndhcmQoKQogICAgICAgIH0KICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBjb25zdCByZW1vdGVBZGRlZCA9IGF3YWl0IHRoaXMuX2FkZFJlbW90ZUhlYWRzKCkKICAgICAgY29uc3QgbG9jYWxOb2RlcyA9IHRoaXMuX2FwcGVuZGluZyAhPT0gbnVsbCA/IHRoaXMuX2FkZExvY2FsSGVhZHMoKSA6IG51bGwKCiAgICAgIGlmICh0aGlzLl9pbnRlcnJ1cHRpbmcpIHJldHVybgoKICAgICAgaWYgKHJlbW90ZUFkZGVkID4gMCB8fCBsb2NhbE5vZGVzICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy51cGRhdGluZyA9IHRydWUKICAgICAgfQoKICAgICAgY29uc3QgdSA9IHRoaXMubGluZWFyaXplci51cGRhdGUoKQogICAgICBjb25zdCB1cGRhdGUgPSB1CiAgICAgICAgPyBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnVwZGF0ZSh1LCBsb2NhbE5vZGVzKQogICAgICAgIDogeyByZWJvb3Q6IGZhbHNlLCBtaWdyYXRlZDogZmFsc2UgfQoKICAgICAgaWYgKGxvY2FsTm9kZXMpIHRoaXMuX2ZsdXNoTG9jYWxIZWFkcyhsb2NhbE5vZGVzLmxlbmd0aCkKCiAgICAgIGlmICghdXBkYXRlLnJlYm9vdCkgewogICAgICAgIGlmICh0aGlzLl9hcHBseVN0YXRlLnNob3VsZEZsdXNoKCkpIHsKICAgICAgICAgIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuZmx1c2goKQogICAgICAgICAgdGhpcy51cGRhdGluZyA9IHRydWUKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9jaGVja1dyaXRlcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgYXdhaXQgdGhpcy5fZ2NXcml0ZXJzKCkKICAgICAgICAgIGNvbnRpbnVlIC8vIHJlcnVuIHRoZSB1cGRhdGUgbG9vcCBhcyBhIHdyaXRlciBtaWdodCBoYXZlIGJlZW4gYWRkZWQKICAgICAgICB9CiAgICAgICAgaWYgKHJlbW90ZUFkZGVkID49IFJFTU9URV9BRERfQkFUQ0gpIGNvbnRpbnVlCiAgICAgICAgYnJlYWsKICAgICAgfQoKICAgICAgYXdhaXQgdGhpcy5fZ2NXcml0ZXJzKCkKICAgICAgYXdhaXQgdGhpcy5fcmVib290KHRoaXMuX2FwcGx5U3RhdGUua2V5KQogICAgfQoKICAgIC8vIGVtaXQgc3RhdGUgY2hhbmdlcyBwb3N0IGRyYWluCiAgICBpZiAod3JpdGFibGUgIT09IHRoaXMud3JpdGFibGUpIHsKICAgICAgaWYgKHRoaXMud3JpdGFibGUgJiYgdGhpcy5fd3JpdGFibGUpIHRoaXMuX3dyaXRhYmxlLnJlc29sdmUodHJ1ZSkKICAgICAgdGhpcy5lbWl0KHdyaXRhYmxlID8gJ3Vud3JpdGFibGUnIDogJ3dyaXRhYmxlJykKICAgIH0KICB9CgogIF93YWtldXBQZWVyKHN0cmVhbSkgewogICAgaWYgKCF0aGlzLndha2V1cFNlc3Npb24pIHJldHVybgogICAgY29uc3Qgd2FrZXVwID0gdGhpcy5fZ2V0V2FrZXVwKCkKICAgIGlmICh3YWtldXAubGVuZ3RoID09PSAwKSByZXR1cm4KICAgIHRoaXMud2FrZXVwU2Vzc2lvbi5hbm5vdW5jZUJ5U3RyZWFtKHN0cmVhbSwgd2FrZXVwKQogIH0KCiAgX2dldFdha2V1cCgpIHsKICAgIGNvbnN0IHdyaXRlcnMgPSBbXQoKICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLmFjdGl2ZVdyaXRlcnMpIHsKICAgICAgaWYgKHcuaXNBY3RpdmVJbmRleGVyIHx8IHcuZmx1c2hlZCgpKSBjb250aW51ZQogICAgICB3cml0ZXJzLnB1c2goeyBrZXk6IHcuY29yZS5rZXksIGxlbmd0aDogdy5sZW5ndGggfSkKICAgIH0KCiAgICByZXR1cm4gd3JpdGVycwogIH0KCiAgYXN5bmMgX3dha2V1cFdyaXRlcihrZXksIGxlbmd0aCkgewogICAgdGhpcy5fZW5zdXJlV2FrZXVwKGF3YWl0IHRoaXMuX2dldFdyaXRlckJ5S2V5KGtleSwgLTEsIGxlbmd0aCwgdHJ1ZSwgZmFsc2UsIG51bGwpKQogIH0KCiAgLy8gZW5zdXJlIHdha2V1cCBvbiBhbiBleGlzdGluZyB3cml0ZXIgKHRoZSB3cml0ZXIgY2FsbHMgdGhpcyBpbiBhZGRpdGlvbiB0byBhYm92ZSkKICBfZW5zdXJlV2FrZXVwKHcpIHsKICAgIGlmICh3ID09PSBudWxsIHx8IHcuaXNCb290c3RyYXAgPT09IHRydWUpIHJldHVybgogICAgdy5zZXRCb290c3RyYXAodHJ1ZSkgLy8gZXZlbiBpZiB0dXJuIGZhbHNlIGF0IGVuZCBvZiBkcmFpbiwgaHlwZXJjb3JlIG1ha2VzIHRoZW0gbGluZ2VyIGEgYml0IHNvIG5vIGNodXJuCiAgICB0aGlzLl9ib290c3RyYXBXcml0ZXJzLnB1c2godykKICAgIHRoaXMuX2Jvb3RzdHJhcFdyaXRlcnNDaGFuZ2VkID0gdHJ1ZQogIH0KCiAgYXN5bmMgX2RyYWluV2FrZXVwKCkgewogICAgY29uc3QgcHJvbWlzZXMgPSBbXQoKICAgIC8vIHdhcm11cCBhbGwgdGhlIGJlbG93IGdldHMKICAgIGlmICh0aGlzLl9uZWVkc1dha2V1cCkgewogICAgICBmb3IgKGNvbnN0IHsga2V5LCBsZW5ndGggfSBvZiB0aGlzLl93YWtldXApIHsKICAgICAgICBjb25zdCB3ID0gdGhpcy5hY3RpdmVXcml0ZXJzLmdldChrZXkpCiAgICAgICAgaWYgKHcpIHsKICAgICAgICAgIGlmICh3Lmxlbmd0aCA8IGxlbmd0aCkgdy5zZWVuKGxlbmd0aCkKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogICAgICAgIHByb21pc2VzLnB1c2godGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uZ2V0KGtleSkpCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9uZWVkc1dha2V1cEhlYWRzKSB7CiAgICAgICAgZm9yIChjb25zdCB7IGtleSB9IG9mIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmhlYWRzKSB7CiAgICAgICAgICBpZiAodGhpcy5hY3RpdmVXcml0ZXJzLmhhcyhrZXkpKSBjb250aW51ZQogICAgICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5nZXQoa2V5KSkKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3QgW2hleCwgbGVuZ3RoXSBvZiB0aGlzLl93YWtldXBIaW50cykgewogICAgICBjb25zdCBrZXkgPSBiNGEuZnJvbShoZXgsICdoZXgnKQogICAgICBpZiAobGVuZ3RoICE9PSAtMSkgewogICAgICAgIGNvbnN0IHcgPSB0aGlzLmFjdGl2ZVdyaXRlcnMuZ2V0KGtleSkKICAgICAgICBpZiAodykgewogICAgICAgICAgaWYgKHcubGVuZ3RoIDwgbGVuZ3RoKSB3LnNlZW4obGVuZ3RoKQogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgIH0KICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5nZXQoa2V5KSkKICAgIH0KCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQocHJvbWlzZXMpCgogICAgaWYgKHRoaXMuX25lZWRzV2FrZXVwID09PSB0cnVlKSB7CiAgICAgIHRoaXMuX25lZWRzV2FrZXVwID0gZmFsc2UKCiAgICAgIGZvciAoY29uc3QgeyBrZXksIGxlbmd0aCB9IG9mIHRoaXMuX3dha2V1cCkgewogICAgICAgIGlmICh0aGlzLmFjdGl2ZVdyaXRlcnMuaGFzKGtleSkpIGNvbnRpbnVlCiAgICAgICAgYXdhaXQgdGhpcy5fd2FrZXVwV3JpdGVyKGtleSwgbGVuZ3RoKQogICAgICB9CgogICAgICBpZiAodGhpcy5fbmVlZHNXYWtldXBIZWFkcyA9PT0gdHJ1ZSkgewogICAgICAgIHRoaXMuX25lZWRzV2FrZXVwSGVhZHMgPSBmYWxzZQoKICAgICAgICBmb3IgKGNvbnN0IHsga2V5IH0gb2YgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uaGVhZHMpIHsKICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVdyaXRlcnMuaGFzKGtleSkpIGNvbnRpbnVlCiAgICAgICAgICBhd2FpdCB0aGlzLl93YWtldXBXcml0ZXIoa2V5LCAwKQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZvciAoY29uc3QgW2hleCwgbGVuZ3RoXSBvZiB0aGlzLl93YWtldXBIaW50cykgewogICAgICBjb25zdCBrZXkgPSBiNGEuZnJvbShoZXgsICdoZXgnKQogICAgICBpZiAodGhpcy5hY3RpdmVXcml0ZXJzLmhhcyhrZXkpKSBjb250aW51ZQogICAgICBpZiAobGVuZ3RoICE9PSAtMSkgewogICAgICAgIGNvbnN0IGluZm8gPSBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5nZXQoa2V5KQogICAgICAgIGlmIChpbmZvICYmIGxlbmd0aCA8PSBpbmZvLmxlbmd0aCkgY29udGludWUgLy8gc3RhbGUgaGludAogICAgICB9CiAgICAgIGF3YWl0IHRoaXMuX3dha2V1cFdyaXRlcihrZXksIGxlbmd0aCA9PT0gLTEgPyAwIDogbGVuZ3RoKQogICAgfQoKICAgIHRoaXMuX3dha2V1cEhpbnRzLmNsZWFyKCkKICB9CgogIHBhdXNlKCkgewogICAgdGhpcy5wYXVzZWQgPSB0cnVlCiAgfQoKICByZXN1bWUoKSB7CiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlCiAgICB0aGlzLl9xdWV1ZUJ1bXAoKQogIH0KCiAgd2FpdEZvcldyaXRhYmxlKCkgewogICAgaWYgKHRoaXMud3JpdGFibGUpIHJldHVybiBQcm9taXNlLnJlc29sdmUodHJ1ZSkKICAgIGlmICghdGhpcy5fd3JpdGFibGUpIHRoaXMuX3dyaXRhYmxlID0gcnJwKCkKICAgIHJldHVybiB0aGlzLl93cml0YWJsZS5wcm9taXNlCiAgfQoKICBhc3luYyBfZHJhaW5XaXRoSW50ZXJ1cHQoKSB7CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuX2RyYWluKCkKICAgICAgICByZXR1cm4KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKHRoaXMuY2xvc2luZyB8fCAhdGhpcy5mYXN0Rm9yd2FyZFRvKSB0aHJvdyBlcnIKICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIHRoaXMuZmFzdEZvcndhcmRGYWlsZWRBdCA8IE1JTl9GRl9XQUlUKSB0aHJvdyBlcnIKICAgICAgICB0aGlzLmZhc3RGb3J3YXJkRmFpbGVkQXQgPSBEYXRlLm5vdygpCiAgICAgICAgLy8gaWYgYW4gRkYgaXMgZW5hYmxlZCByZXRyeQogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBfYWR2YW5jZSgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKHRoaXMucGF1c2VkIHx8IHRoaXMuX2ludGVycnVwdGluZykgcmV0dXJuCgogICAgdGhpcy5fZHJhaW5pbmcgPSB0cnVlCgogICAgaWYgKHRoaXMuX3VwZGF0ZUxvY2FsQ29yZSAhPT0gbnVsbCkgewogICAgICBhd2FpdCB0aGlzLl9yb3RhdGVMb2NhbFdyaXRlcih0aGlzLl91cGRhdGVMb2NhbENvcmUpCiAgICB9CgogICAgY29uc3QgbG9jYWwgPSB0aGlzLmxvY2FsLmxlbmd0aAoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2RyYWluV2l0aEludGVydXB0KCkKCiAgICAgIC8vIG11c3QgcnVuIHBvc3QgZHJhaW4gc28gdGhlIGxpbmVhcml6ZXIgaXMgY2F1Z2h0IHVwCiAgICAgIGlmICh0aGlzLl9jYXVnaHR1cCAmJiAodGhpcy5fbmVlZHNXYWtldXAgPT09IHRydWUgfHwgdGhpcy5fd2FrZXVwSGludHMuc2l6ZSA+IDApKQogICAgICAgIGF3YWl0IHRoaXMuX2RyYWluV2FrZXVwKCkKCiAgICAgIC8vIGNoZWNrIGlmIHdlIHNob3VsZCB1cGRhdGUgbG9jYWwgd3JpdGVyCiAgICAgIGlmICghdGhpcy5sb2NhbFdyaXRlciB8fCB0aGlzLmxvY2FsV3JpdGVyLmNsb3NlZCkgewogICAgICAgIGF3YWl0IHRoaXMuX3VwZGF0ZUxvY2FsV3JpdGVyKHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtKQogICAgICB9CgogICAgICB0aGlzLl9kcmFpbmluZyA9IGZhbHNlCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5fb25FcnJvcihlcnIpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLl9pbnRlcnJ1cHRpbmcpIHJldHVybgoKICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyICYmICF0aGlzLmxvY2FsV3JpdGVyLmNsb3NlZCkgewogICAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZS5pc0xvY2FsUGVuZGluZ0luZGV4ZXIoKSkgdGhpcy5hY2soKS5jYXRjaChub29wKQogICAgICBlbHNlIGlmICh0aGlzLl90cmlnZ2VyQWNrQXNhcCgpKSB0aGlzLl9hY2tUaW1lci5hc2FwKCkKICAgIH0KCiAgICAvLyBrZWVwIGJvb3RzdHJhcHMgaW4gc3luYyB3aXRoIGxpbmVhcml6ZXIKICAgIGlmICh0aGlzLnVwZGF0aW5nID09PSB0cnVlIHx8IHRoaXMuX2Jvb3RzdHJhcFdyaXRlcnNDaGFuZ2VkID09PSB0cnVlKSB7CiAgICAgIHRoaXMuX3VwZGF0ZUJvb3RzdHJhcFdyaXRlcnMoKQogICAgfQoKICAgIGlmICh0aGlzLnVwZGF0aW5nID09PSB0cnVlKSB7CiAgICAgIHRoaXMudXBkYXRpbmcgPSBmYWxzZQoKICAgICAgaWYgKGxvY2FsICE9PSB0aGlzLmxvY2FsLmxlbmd0aCkgdGhpcy5fcmVzZXRBY2tUaWNrKCkKICAgICAgZWxzZSB0aGlzLl9hY2tUaWNrKysKCiAgICAgIGlmICghdGhpcy5faW50ZXJydXB0aW5nKSB0aGlzLmVtaXQoJ3VwZGF0ZScpCiAgICAgIHRoaXMuX3dhaXRpbmcubm90aWZ5KG51bGwpCiAgICB9CgogICAgaWYgKCF0aGlzLl9pbnRlcnJ1cHRpbmcpIGF3YWl0IHRoaXMuX2djV3JpdGVycygpCiAgfQoKICBfdHJpZ2dlckFja0FzYXAoKSB7CiAgICBpZiAoIXRoaXMuX2Fja1RpbWVyKSByZXR1cm4gZmFsc2UKCiAgICAvLyBmbHVzaCBpZiB0aHJlc2hvbGQgaXMgcmVhY2hlZCBhbmQgd2UgYXJlIG5vdCBhbHJlYWR5IGFja2luZwogICAgaWYgKHRoaXMuX2Fja1RpY2tUaHJlc2hvbGQgJiYgIXRoaXMuX2Fja2luZyAmJiB0aGlzLl9hY2tUaWNrID49IHRoaXMuX2Fja1RpY2tUaHJlc2hvbGQpIHsKICAgICAgaWYgKHRoaXMuX2Fja1RpbWVyKSB7CiAgICAgICAgZm9yIChjb25zdCB3IG9mIHRoaXMubGluZWFyaXplci5pbmRleGVycykgewogICAgICAgICAgaWYgKHcuY29yZS5sZW5ndGggPiB3Lmxlbmd0aCkgcmV0dXJuIGZhbHNlIC8vIHdhaXQgZm9yIHRoZSBub3JtYWwgYWNrIGN5Y2xlIGluIHRoaXMgY2FzZQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF9xdWV1ZUZhc3RGb3J3YXJkKCkgewogICAgaWYgKCF0aGlzLmNvcmUub3BlbmVkKSByZXR1cm4KICAgIC8vIHNob3VsZCBoYXZlIGEgYmV0dGVyIHdheSB0byBnZXQgdGhpcwogICAgY29uc3QgbGF0ZXN0U2lnbmVkTGVuZ3RoID0gdGhpcy5jb3JlLmNvcmUuc3RhdGUubGVuZ3RoCgogICAgaWYgKCF0aGlzLmZhc3RGb3J3YXJkRW5hYmxlZCB8fCB0aGlzLmZhc3RGb3J3YXJkaW5nICE9PSBudWxsIHx8IHRoaXMuX2ludGVycnVwdGluZykgcmV0dXJuCgogICAgaWYgKGxhdGVzdFNpZ25lZExlbmd0aCAtIHRoaXMuY29yZS5sZW5ndGggPCB0aGlzLmZhc3RGb3J3YXJkTWluaW11bSkgcmV0dXJuCiAgICBpZiAodGhpcy5mYXN0Rm9yd2FyZFRvICE9PSBudWxsKSByZXR1cm4KICAgIGlmIChEYXRlLm5vdygpIC0gdGhpcy5mYXN0Rm9yd2FyZEZhaWxlZEF0IDwgTUlOX0ZGX1dBSVQpIHJldHVybgoKICAgIHRoaXMuX3J1bkZhc3RGb3J3YXJkKAogICAgICBuZXcgRmFzdEZvcndhcmQodGhpcywgdGhpcy5jb3JlLmtleSwgeyBtaW5pbXVtOiB0aGlzLmZhc3RGb3J3YXJkTWluaW11bSB9KQogICAgKS5jYXRjaChub29wKQogIH0KCiAgX3F1ZXVlU3RhdGljRmFzdEZvcndhcmQoa2V5KSB7CiAgICBpZiAoIXRoaXMuZmFzdEZvcndhcmRFbmFibGVkIHx8IHRoaXMuZmFzdEZvcndhcmRpbmcgIT09IG51bGwgfHwgdGhpcy5faW50ZXJydXB0aW5nKSByZXR1cm4KICAgIGlmICh0aGlzLmZhc3RGb3J3YXJkVG8gIT09IG51bGwpIHJldHVybgogICAgaWYgKERhdGUubm93KCkgLSB0aGlzLmZhc3RGb3J3YXJkRmFpbGVkQXQgPCBNSU5fRkZfV0FJVCkgcmV0dXJuCgogICAgdGhpcy5fcnVuRmFzdEZvcndhcmQobmV3IEZhc3RGb3J3YXJkKHRoaXMsIGtleSwgeyB2ZXJpZmllZDogZmFsc2UgfSkpLmNhdGNoKG5vb3ApCiAgfQoKICBfdXBkYXRlQWN0aXZpdHkoKSB7CiAgICB0aGlzLmFjdGl2ZVdyaXRlcnMudXBkYXRlQWN0aXZpdHkoKQogICAgaWYgKHRoaXMuX2FwcGx5U3RhdGUpIHsKICAgICAgaWYgKHRoaXMuaXNGYXN0Rm9yd2FyZGluZygpKSB0aGlzLl9hcHBseVN0YXRlLnBhdXNlKCkKICAgICAgZWxzZSB0aGlzLl9hcHBseVN0YXRlLnJlc3VtZSgpCiAgICB9CgogICAgLy8gaW4gY2FzZSB3ZSBpZ25vcmVkIHdha2V1cHMgY2FzZSB3ZSB3ZXJlIGZhc3QgZm9yd2FyZGluZywgcmVxdWVzdCB0aGVtIG5vdyBpZiBub3QKICAgIGlmICh0aGlzLl9uZWVkc1dha2V1cFJlcXVlc3QgJiYgIXRoaXMuaXNGYXN0Rm9yd2FyZGluZygpICYmIHRoaXMud2FrZXVwU2Vzc2lvbikgewogICAgICB0aGlzLl9uZWVkc1dha2V1cFJlcXVlc3QgPSBmYWxzZQoKICAgICAgdGhpcy53YWtldXBTZXNzaW9uLmJyb2FkY2FzdExvb2t1cCh7fSkKICAgIH0KICB9CgogIF9wcmVmZXJGYXN0Rm9yd2FyZCgpIHsKICAgIHRoaXMuZmFzdEZvcndhcmRNaW5pbXVtID0gMQogICAgdGhpcy5fcXVldWVGYXN0Rm9yd2FyZCgpCiAgfQoKICBfcG9zdEFwcGx5KCkgewogICAgdGhpcy5mYXN0Rm9yd2FyZE1pbmltdW0gPSBGYXN0Rm9yd2FyZC5NSU5JTVVNCiAgfQoKICBhc3luYyBfcnVuRmFzdEZvcndhcmQoZmYpIHsKICAgIHRoaXMuZmFzdEZvcndhcmRpbmcgPSBmZgoKICAgIHRoaXMuX3VwZGF0ZUFjdGl2aXR5KCkKCiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmZi51cGdyYWRlKCkKICAgIGF3YWl0IGZmLmNsb3NlKCkKCiAgICBpZiAodGhpcy5mYXN0Rm9yd2FyZGluZyA9PT0gZmYpIHRoaXMuZmFzdEZvcndhcmRpbmcgPSBudWxsCgogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgaWYgKGZmLmZhaWxlZCkgdGhpcy5mYXN0Rm9yd2FyZEZhaWxlZEF0ID0gRGF0ZS5ub3coKQogICAgICBlbHNlIHRoaXMuX3F1ZXVlRmFzdEZvcndhcmQoKQogICAgICB0aGlzLl91cGRhdGVBY3Rpdml0eSgpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuZmFzdEZvcndhcmRGYWlsZWRBdCA9IDAKICAgIHRoaXMuZmFzdEZvcndhcmRUbyA9IHJlc3VsdAoKICAgIGlmICh0aGlzLl9hcHBseVN0YXRlICYmIHRoaXMuX2FwcGx5U3RhdGUuYXBwbHlpbmcgJiYgdGhpcy5mYXN0Rm9yd2FyZE1pbmltdW0gPT09IDEpIHsKICAgICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5jbG9zZSgpCiAgICB9CgogICAgdGhpcy5fYnVtcEFja1RpbWVyKCkKICAgIHRoaXMuX3F1ZXVlQnVtcCgpCiAgfQoKICAvLyB0cmlnZ2VyZWQgZnJvbSBhcHBseQogIGFzeW5jIF9hZGRXcml0ZXIoa2V5LCBzeXMpIHsKICAgIC8vIGp1c3QgY29tcGF0IGZvciBvbGQgdmVyc2lvbgogICAgYXNzZXJ0KCEhdGhpcy5fYXBwbHlTdGF0ZS5hcHBseWluZywgJ1N5c3RlbSBjaGFuZ2VzIGFyZSBvbmx5IGFsbG93ZWQgaW4gYXBwbHknKQoKICAgIGNvbnN0IHdyaXRlciA9CiAgICAgIChhd2FpdCB0aGlzLl9nZXRXcml0ZXJCeUtleShrZXksIC0xLCAwLCBmYWxzZSwgdHJ1ZSwgc3lzKSkgfHwKICAgICAgdGhpcy5fbWFrZVdyaXRlcihrZXksIDAsIHRydWUsIGZhbHNlKQogICAgYXdhaXQgd3JpdGVyLnJlYWR5KCkKCiAgICBpZiAoIXRoaXMuYWN0aXZlV3JpdGVycy5oYXMoa2V5KSkgewogICAgICB0aGlzLmFjdGl2ZVdyaXRlcnMuYWRkKHdyaXRlcikKICAgICAgdGhpcy5fY2hlY2tXcml0ZXJzLnB1c2god3JpdGVyKQogICAgICB0aGlzLl9lbnN1cmVXYWtldXAod3JpdGVyKQogICAgfQoKICAgIC8vIGZldGNoIGFueSBub2RlcyBuZWVkZWQgZm9yIGRlcGVuZGVudHMKICAgIHRoaXMuX3F1ZXVlQnVtcCgpCiAgfQoKICAvLyB0cmlnZ2VyZWQgZnJvbSBhcHBseQogIF9yZW1vdmVXcml0ZXIoa2V5KSB7CiAgICAvLyBqdXN0IGNvbXBhdCBmb3Igb2xkIHZlcnNpb24KICAgIGNvbnN0IHcgPSB0aGlzLmFjdGl2ZVdyaXRlcnMuZ2V0KGtleSkKICAgIGlmICh3KSB3LmlzUmVtb3ZlZCA9IHRydWUKCiAgICB0aGlzLl9xdWV1ZUJ1bXAoKQogIH0KCiAgcmVtb3ZlYWJsZShrZXkpIHsKICAgIHJldHVybiB0aGlzLl9hcHBseVN0YXRlID8gdGhpcy5fYXBwbHlTdGF0ZS5yZW1vdmVhYmxlKGtleSkgOiBmYWxzZQogIH0KCiAgX3VwZGF0ZUFja1RocmVzaG9sZCgpIHsKICAgIGlmICh0aGlzLl9hY2tUaHJlc2hvbGQgPT09IDApIHJldHVybgogICAgaWYgKHRoaXMuX2Fja1RpbWVyKSB0aGlzLl9hY2tUaW1lci5iYXUoKQogICAgdGhpcy5fYWNrVGljayA9IDAKICAgIHRoaXMuX2Fja1RpY2tUaHJlc2hvbGQgPSByYW5kb20yb3ZlcjEodGhpcy5saW5lYXJpemVyLmluZGV4ZXJzLmxlbmd0aCAqIHRoaXMuX2Fja1RocmVzaG9sZCkKICB9CgogIF9yZXNldEFja1RpY2soKSB7CiAgICB0aGlzLl9hY2tUaWNrID0gMAogICAgaWYgKHRoaXMuX2Fja1RpbWVyKSB0aGlzLl9hY2tUaW1lci5iYXUoKQogIH0KCiAgX3NoaWZ0V3JpdGVyKHcpIHsKICAgIHcuc2hpZnQoKQogICAgaWYgKHcuZmx1c2hlZCgpKSB0aGlzLl9jaGVja1dyaXRlcnMucHVzaCh3KQogIH0KfQoKZnVuY3Rpb24gdG9LZXkoaykgewogIHJldHVybiBiNGEuaXNCdWZmZXIoaykgPyBrIDogaHlwZXJjb3JlSWQuZGVjb2RlKGspCn0KCmZ1bmN0aW9uIGlzQXV0b2Jhc2VNZXNzYWdlKG1zZykgewogIHJldHVybiBtc2cuY2hlY2twb2ludCA/IG1zZy5jaGVja3BvaW50Lmxlbmd0aCA+IDAgOiBtc2cuY2hlY2twb2ludCA9PT0gbnVsbAp9CgpmdW5jdGlvbiBjb21wYXJlTm9kZXMoYSwgYikgewogIHJldHVybiBiNGEuY29tcGFyZShhLmtleSwgYi5rZXkpCn0KCmZ1bmN0aW9uIHJhbmRvbTJvdmVyMShuKSB7CiAgcmV0dXJuIE1hdGguZmxvb3IobiArIE1hdGgucmFuZG9tKCkgKiBuKQp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIGNyYXNoU29vbihlcnIpIHsKICBxdWV1ZU1pY3JvdGFzaygoKSA9PiB7CiAgICB0aHJvdyBlcnIKICB9KQogIHRocm93IGVycgp9CgpmdW5jdGlvbiBpc09iamVjdChvYmopIHsKICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgJiYgb2JqICE9PSBudWxsCn0KCmZ1bmN0aW9uIGVtaXRXYXJuaW5nKGVycikgewogIHNhZmV0eUNhdGNoKGVycikKICB0aGlzLmVtaXQoJ3dhcm5pbmcnLCBlcnIpCn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZSh2YWx1ZUVuY29kaW5nLCB2YWx1ZSkgewogIGNvbnN0IHN0YXRlID0geyBidWZmZXI6IG51bGwsIHN0YXJ0OiAwLCBlbmQ6IDAgfQogIHZhbHVlRW5jb2RpbmcucHJlZW5jb2RlKHN0YXRlLCB2YWx1ZSkKICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQogIHZhbHVlRW5jb2RpbmcuZW5jb2RlKHN0YXRlLCB2YWx1ZSkKICBzdGF0ZS5zdGFydCA9IDAKICByZXR1cm4gdmFsdWVFbmNvZGluZy5kZWNvZGUoc3RhdGUpCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQWN0aXZlV3JpdGVycyB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLm1hcCA9IG5ldyBNYXAoKQogIH0KCiAgZ2V0IHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5tYXAuc2l6ZQogIH0KCiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy5tYXAudmFsdWVzKCkKICB9CgogIGdldChrZXkpIHsKICAgIHJldHVybiB0aGlzLm1hcC5nZXQoYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpKSB8fCBudWxsCiAgfQoKICBoYXMoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5nZXQoa2V5KSAhPT0gbnVsbAogIH0KCiAgYWRkKHdyaXRlcikgewogICAgdGhpcy5tYXAuc2V0KGI0YS50b1N0cmluZyh3cml0ZXIuY29yZS5rZXksICdoZXgnKSwgd3JpdGVyKQogIH0KCiAgZGVsZXRlKHdyaXRlcikgewogICAgdGhpcy5tYXAuZGVsZXRlKGI0YS50b1N0cmluZyh3cml0ZXIuY29yZS5rZXksICdoZXgnKSkKICB9CgogIHVwZGF0ZUFjdGl2aXR5KCkgewogICAgZm9yIChjb25zdCB3IG9mIHRoaXMubWFwLnZhbHVlcygpKSB3LnVwZGF0ZUFjdGl2aXR5KCkKICB9CgogIGNsZWFyKCkgewogICAgY29uc3QgcCA9IFtdCiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5tYXAudmFsdWVzKCkpIHAucHVzaCh3LmNsb3NlKCkpCiAgICB0aGlzLm1hcC5jbGVhcigpCgogICAgcmV0dXJuIFByb21pc2UuYWxsKHApCiAgfQp9CmNvbnN0IFNpZ25hbFByb21pc2UgPSByZXF1aXJlKCdzaWduYWwtcHJvbWlzZScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEFwcGVuZEJhdGNoIHsKICBjb25zdHJ1Y3RvcihiYXNlKSB7CiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgICB0aGlzLmJsb2NrcyA9IFtdCiAgICB0aGlzLmNsb3NlZCA9IGZhbHNlCiAgICB0aGlzLmZsdXNoaW5nID0gZmFsc2UKICAgIHRoaXMuX2ZsdXNoZWQgPSBudWxsCiAgfQoKICBhc3luYyBfYWNxdWlyZSgpIHsKICAgIHdoaWxlICh0aGlzLmJhc2UuYWN0aXZlQmF0Y2ggIT09IG51bGwgJiYgdGhpcy5iYXNlLmFjdGl2ZUJhdGNoICE9PSB0aGlzKQogICAgICBhd2FpdCB0aGlzLmJhc2UuYWN0aXZlQmF0Y2guZmx1c2hlZCgpCiAgICB0aGlzLmJhc2UuYWN0aXZlQmF0Y2ggPSB0aGlzCiAgfQoKICBhc3luYyBhcHBlbmQodmFsdWUpIHsKICAgIGlmICh0aGlzLmJhc2Uub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5iYXNlLnJlYWR5KCkKICAgIGlmICh0aGlzLmJhc2UuX2FkdmFuY2luZyAhPT0gbnVsbCkgYXdhaXQgdGhpcy5iYXNlLl9hZHZhbmNpbmcKCiAgICBpZiAodGhpcy5jbG9zZWQpIHRocm93IG5ldyBFcnJvcignQmF0Y2ggaXMgY2xvc2VkJykKICAgIGlmICh0aGlzLmJhc2UuYWN0aXZlQmF0Y2ggIT09IHRoaXMpIGF3YWl0IHRoaXMuX2FjcXVpcmUoKQogICAgaWYgKHRoaXMuY2xvc2VkKSB0aHJvdyBuZXcgRXJyb3IoJ0JhdGNoIGlzIGNsb3NlZCcpCgogICAgdGhpcy5ibG9ja3MucHVzaCh2YWx1ZSkKICAgIHJldHVybiB0aGlzLmJhc2UubG9jYWwubGVuZ3RoICsgdGhpcy5ibG9ja3MubGVuZ3RoCiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGlmICh0aGlzLmNsb3NlZCkgdGhyb3cgbmV3IEVycm9yKCdCYXRjaCBpcyBjbG9zZWQnKQogICAgaWYgKHRoaXMuZmx1c2hpbmcpIHJldHVybiB0aGlzLmZsdXNoZWQoKQogICAgdGhpcy5mbHVzaGluZyA9IHRydWUKICAgIGlmICh0aGlzLmJsb2Nrcy5sZW5ndGgpIGF3YWl0IHRoaXMuYmFzZS5fYXBwZW5kQmF0Y2godGhpcy5ibG9ja3MpCiAgICByZXR1cm4gdGhpcy5jbG9zZSgpCiAgfQoKICBmbHVzaGVkKCkgewogICAgaWYgKHRoaXMuY2xvc2VkKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKICAgIGlmICh0aGlzLl9mbHVzaGVkKSByZXR1cm4gdGhpcy5fZmx1c2hlZC53YWl0KCkKICAgIHRoaXMuX2ZsdXNoZWQgPSBuZXcgU2lnbmFsUHJvbWlzZSgpCiAgICByZXR1cm4gdGhpcy5fZmx1c2hlZC53YWl0KCkKICB9CgogIGNsb3NlKCkgewogICAgaWYgKHRoaXMuYmFzZS5hY3RpdmVCYXRjaCAhPT0gdGhpcykgcmV0dXJuCiAgICB0aGlzLmJhc2UuYWN0aXZlQmF0Y2ggPSBudWxsCiAgICB0aGlzLmNsb3NlZCA9IHRydWUKICAgIGlmICh0aGlzLl9mbHVzaGVkKSB0aGlzLl9mbHVzaGVkLm5vdGlmeShudWxsKQogIH0KfQpjbGFzcyBQdWJsaWNBcHBseUNhbGxzIHsKICBjb25zdHJ1Y3RvcihiYXNlKSB7CiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgICB0aGlzLmludGVybmFsID0gZmFsc2UKICB9CgogIGdldCBkaXNjb3ZlcnlLZXkoKSB7CiAgICByZXR1cm4gdGhpcy5iYXNlLmRpc2NvdmVyeUtleQogIH0KCiAgZ2V0IGtleSgpIHsKICAgIHJldHVybiB0aGlzLmJhc2Uua2V5CiAgfQoKICBnZXQgaWQoKSB7CiAgICByZXR1cm4gdGhpcy5iYXNlLmlkCiAgfQoKICBhc3luYyBhZGRXcml0ZXIoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhbGxvd2VkIG9uIHRoZSBwdWJsaWMgdmlldycpCiAgfQoKICBhc3luYyBhY2tXcml0ZXIoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhbGxvd2VkIG9uIHRoZSBwdWJsaWMgdmlldycpCiAgfQoKICBhc3luYyByZW1vdmVXcml0ZXIoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhbGxvd2VkIG9uIHRoZSBwdWJsaWMgdmlldycpCiAgfQoKICBwcmVmZXJGYXN0Rm9yd2FyZCgpIHsKICAgIHRocm93IG5ldyBFcnJvcignTm90IGFsbG93ZWQgb24gdGhlIHB1YmxpYyB2aWV3JykKICB9CgogIGludGVycnVwdCgpIHsKICAgIHRocm93IG5ldyBFcnJvcignTm90IGFsbG93ZWQgb24gdGhlIHB1YmxpYyB2aWV3JykKICB9CgogIHJlbW92ZWFibGUoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhbGxvd2VkIG9uIHRoZSBwdWJsaWMgdmlldycpCiAgfQoKICBmb3JrKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgYWxsb3dlZCBvbiB0aGUgcHVibGljIHZpZXcnKQogIH0KCiAgYW5jaG9yKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgYWxsb3dlZCBvbiB0aGUgcHVibGljIHZpZXcnKQogIH0KfQoKY2xhc3MgUHJpdmF0ZUFwcGx5Q2FsbHMgZXh0ZW5kcyBQdWJsaWNBcHBseUNhbGxzIHsKICBjb25zdHJ1Y3RvcihzdGF0ZSkgewogICAgc3VwZXIoc3RhdGUuYmFzZSkKICAgIHRoaXMuc3RhdGUgPSBzdGF0ZQogICAgdGhpcy5pbnRlcm5hbCA9IHRydWUKICB9CgogIGdldCBzeXN0ZW0oKSB7CiAgICByZXR1cm4gdGhpcy5zdGF0ZS5zeXN0ZW0KICB9CgogIGFzeW5jIGFkZFdyaXRlcihrZXksIHsgaW5kZXhlciA9IHRydWUsIGlzSW5kZXhlciA9IGluZGV4ZXIgfSA9IHt9KSB7CiAgICAvLyBqdXN0IGNvbXBhdCBmb3Igb2xkIHZlcnNpb24KICAgIGF3YWl0IHRoaXMuc3RhdGUuc3lzdGVtLmFkZChrZXksIHsgaXNJbmRleGVyIH0pCiAgICBhd2FpdCB0aGlzLmJhc2UuX2FkZFdyaXRlcihrZXksIHRoaXMuc3RhdGUuc3lzdGVtKQogIH0KCiAgYXN5bmMgYWNrV3JpdGVyKGtleSkgewogICAgYXdhaXQgdGhpcy5zdGF0ZS5zeXN0ZW0uYWNrKGtleSkKICB9CgogIGFzeW5jIHJlbW92ZVdyaXRlcihrZXkpIHsKICAgIC8vIGp1c3QgY29tcGF0IGZvciBvbGQgdmVyc2lvbgogICAgaWYgKCF0aGlzLnN0YXRlLnJlbW92ZWFibGUoa2V5KSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhbGxvd2VkIHRvIHJlbW92ZSB0aGUgbGFzdCBpbmRleGVyJykKICAgIH0KCiAgICBhd2FpdCB0aGlzLnN0YXRlLnN5c3RlbS5yZW1vdmUoa2V5KQogICAgdGhpcy5iYXNlLl9yZW1vdmVXcml0ZXIoa2V5KQogIH0KCiAgcHJlZmVyRmFzdEZvcndhcmQoKSB7CiAgICB0aGlzLmJhc2UuX3ByZWZlckZhc3RGb3J3YXJkKCkKICB9CgogIGludGVycnVwdChyZWFzb24pIHsKICAgIHRoaXMuYmFzZS5faW50ZXJydXB0KHJlYXNvbikKICB9CgogIHJlbW92ZWFibGUoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5zdGF0ZS5yZW1vdmVhYmxlKGtleSkKICB9CgogIGFzeW5jIGZvcmsoaW5kZXhlcktleXMsIHN5c3RlbSkgewogICAgaWYgKCEoYXdhaXQgdGhpcy5zdGF0ZS52YWxpZGF0ZUZvcmsoaW5kZXhlcktleXMsIHN5c3RlbSkpKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBpbmRleGVycyA9IGluZGV4ZXJLZXlzLm1hcCh0b0luZGV4ZXIpCgogICAgdGhpcy5zdGF0ZS5wZW5kaW5nRm9yayA9IHsgaW5kZXhlcnMsIGxlbmd0aDogc3lzdGVtLmxlbmd0aCB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIGNyZWF0ZUFuY2hvcigpIHsKICAgIHJldHVybiBhd2FpdCB0aGlzLnN0YXRlLmNyZWF0ZUFuY2hvcigpCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsgUHVibGljQXBwbHlDYWxscywgUHJpdmF0ZUFwcGx5Q2FsbHMgfQoKZnVuY3Rpb24gdG9JbmRleGVyKGtleSkgewogIHJldHVybiB7IGtleSwgbGVuZ3RoOiAwIH0gLy8gbGVuZ3RoIGlzIG5vdCB1c2VkLCBqdXN0IGZvciBhcGkgY29tcGF0Cn0KY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnbmFub2Fzc2VydCcpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKCmNvbnN0IHsgcGFydGlhbFNpZ25hdHVyZSB9ID0gcmVxdWlyZSgnaHlwZXJjb3JlL2xpYi9tdWx0aXNpZy5qcycpCgpjb25zdCBTeXN0ZW1WaWV3ID0gcmVxdWlyZSgnLi9zeXN0ZW0uanMnKQpjb25zdCB7IEF1dG9iYXNlRW5jcnlwdGlvbiB9ID0gcmVxdWlyZSgnLi9lbmNyeXB0aW9uLmpzJykKY29uc3QgVXBkYXRlQ2hhbmdlcyA9IHJlcXVpcmUoJy4vdXBkYXRlcy5qcycpCmNvbnN0IG1lc3NhZ2VzID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCmNvbnN0IHsgUHJpdmF0ZUFwcGx5Q2FsbHMgfSA9IHJlcXVpcmUoJy4vYXBwbHktY2FsbHMuanMnKQpjb25zdCB7IGVuY29kZVZhbHVlIH0gPSByZXF1aXJlKCcuL3ZhbHVlcy5qcycpCmNvbnN0IEZvcmsgPSByZXF1aXJlKCcuL2ZvcmsuanMnKQpjb25zdCBMb2NhbFN0YXRlID0gcmVxdWlyZSgnLi9sb2NhbC1zdGF0ZS5qcycpCmNvbnN0IHsgT1BMT0dfVkVSU0lPTiwgQk9PVF9SRUNPUkRfVkVSU0lPTiB9ID0gcmVxdWlyZSgnLi9jYXBzLmpzJykKCi8vIHRvZG86IGV4cG9zZSB0aGlzIGFzIGFuIG9wdGlvbgpjb25zdCBTSE9VTERfU0lHTl9USFJFU0hPTEQgPSAwCgpjbGFzcyBDaGVja3BvaW50Q29yZSB7CiAgY29uc3RydWN0b3IodmlldywgY29yZSwgc2lnbmVyLCBwYXVzZWQpIHsKICAgIHRoaXMudmlldyA9IHZpZXcKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMuc2lnbmVyID0gc2lnbmVyCiAgICB0aGlzLmxlbmd0aCA9IDAKICAgIHRoaXMuZGlnZXN0ID0gbnVsbAogICAgdGhpcy5zaWduYXR1cmVzID0geyBzeXN0ZW06IG51bGwsIGVuY3J5cHRpb246IG51bGwsIHVzZXI6IFtdIH0KICAgIHRoaXMuY2xvc2VkID0gZmFsc2UKICAgIHRoaXMucGF1c2VkID0gcGF1c2VkCiAgfQoKICBwYXVzZSgpIHsKICAgIHRoaXMucGF1c2VkID0gdHJ1ZQogIH0KCiAgcmVzdW1lKCkgewogICAgaWYgKCF0aGlzLnBhdXNlZCkgcmV0dXJuCiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlCiAgICB0aGlzLnVwZGF0ZUJhY2tncm91bmQoKQogIH0KCiAgYXN5bmMgdXBkYXRlKCkgewogICAgaWYgKGF3YWl0IHRoaXMudXBkYXRlQ2hlY2twb2ludHMoKSkgYXdhaXQgdGhpcy52aWV3Lm1heWJlU2lnbmVkKCkKICB9CgogIGFzeW5jIHVwZGF0ZUNoZWNrcG9pbnRzKCkgewogICAgaWYgKHRoaXMuY29yZS5sZW5ndGggPD0gdGhpcy5sZW5ndGggfHwgdGhpcy5jbG9zZWQgfHwgdGhpcy5wYXVzZWQpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuY29yZS5sZW5ndGgKICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgdGhpcy5jb3JlLmdldChsZW5ndGggLSAxKQoKICAgIGlmIChsZW5ndGggPD0gdGhpcy5sZW5ndGggfHwgdGhpcy5jbG9zZWQgfHwgIXZhbHVlLmRpZ2VzdCB8fCB0aGlzLnBhdXNlZCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgW2RpZ2VzdCwgY2hlY2twb2ludHNdID0gYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgICB0aGlzLl9pbmZsYXRlRGlnZXN0KGxlbmd0aCwgdmFsdWUuZGlnZXN0KSwKICAgICAgdGhpcy5faW5mbGF0ZUFsbENoZWNrcG9pbnRzKGxlbmd0aCwgdmFsdWUuY2hlY2twb2ludCkKICAgIF0pCgogICAgaWYgKGxlbmd0aCA8PSB0aGlzLmxlbmd0aCB8fCB0aGlzLmNsb3NlZCB8fCAhZGlnZXN0IHx8ICFjaGVja3BvaW50cyB8fCB0aGlzLnBhdXNlZCkgcmV0dXJuIGZhbHNlCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoZWNrcG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChjaGVja3BvaW50c1tpXSA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgdGhpcy5sZW5ndGggPSBsZW5ndGgKICAgIHRoaXMuZGlnZXN0ID0gZGlnZXN0CiAgICB0aGlzLnNpZ25hdHVyZXMgPSBjaGVja3BvaW50cwoKICAgIHJldHVybiB0cnVlCiAgfQoKICB1cGRhdGVCYWNrZ3JvdW5kKCkgewogICAgcmV0dXJuIHRoaXMudXBkYXRlKCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgfQoKICB1cGRhdGVJbnRlcm5hbFNpZ25hdHVyZXMobGVuZ3RoLCBzaWduYXR1cmVzKSB7CiAgICB0aGlzLnNpZ25hdHVyZXMuc3lzdGVtID0gdXBkYXRlU2lnbmF0dXJlKGxlbmd0aCwgc2lnbmF0dXJlcy5zeXN0ZW0sIHRoaXMuc2lnbmF0dXJlcy5zeXN0ZW0pCiAgICB0aGlzLnNpZ25hdHVyZXMuZW5jcnlwdGlvbiA9IHVwZGF0ZVNpZ25hdHVyZSgKICAgICAgbGVuZ3RoLAogICAgICBzaWduYXR1cmVzLmVuY3J5cHRpb24sCiAgICAgIHRoaXMuc2lnbmF0dXJlcy5lbmNyeXB0aW9uCiAgICApCiAgfQoKICB1cGRhdGVVc2VyU2lnbmF0dXJlcyhsZW5ndGgsIHNpZ25hdHVyZXMpIHsKICAgIHRoaXMuc2lnbmF0dXJlcy51c2VyID0gdXBkYXRlU2lnbmF0dXJlcyhsZW5ndGgsIHNpZ25hdHVyZXMsIHRoaXMuc2lnbmF0dXJlcy51c2VyKQogIH0KCiAgbWFrZUNoZWNrcG9pbnRzKGxlbmd0aCkgewogICAgcmV0dXJuIHsKICAgICAgc3lzdGVtOiBtYWtlQ2hlY2twb2ludChsZW5ndGgsIHRoaXMuc2lnbmF0dXJlcy5zeXN0ZW0pLAogICAgICBlbmNyeXB0aW9uOiBtYWtlQ2hlY2twb2ludChsZW5ndGgsIHRoaXMuc2lnbmF0dXJlcy5lbmNyeXB0aW9uKSwKICAgICAgdXNlcjogbWFrZUNoZWNrcG9pbnRzKGxlbmd0aCwgdGhpcy5zaWduYXR1cmVzLnVzZXIpCiAgICB9CiAgfQoKICBtYWtlRGlnZXN0KGxlbmd0aCwga2V5KSB7CiAgICBpZiAodGhpcy5kaWdlc3QgJiYgKHRoaXMuZGlnZXN0LmtleSA9PT0ga2V5IHx8IGI0YS5lcXVhbHModGhpcy5kaWdlc3Qua2V5LCBrZXkpKSkgewogICAgICByZXR1cm4geyBrZXk6IG51bGwsIHBvaW50ZXI6IGxlbmd0aCAtIHRoaXMuZGlnZXN0LmF0IH0KICAgIH0KICAgIHRoaXMuZGlnZXN0ID0geyBrZXksIGF0OiBsZW5ndGggfQogICAgcmV0dXJuIHsga2V5LCBwb2ludGVyOiAwIH0KICB9CgogIGFzeW5jIHJlYWR5KCkgewogICAgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKICAgIHRoaXMuY29yZS5vbignYXBwZW5kJywgdGhpcy51cGRhdGVCYWNrZ3JvdW5kLmJpbmQodGhpcykpCiAgICBpZiAodGhpcy5jb3JlLndyaXRhYmxlKSBhd2FpdCB0aGlzLnVwZGF0ZUNoZWNrcG9pbnRzKCkKICAgIHRoaXMudXBkYXRlQmFja2dyb3VuZCgpCiAgfQoKICBzaWduZWRMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5zaWduYXR1cmVzLnN5c3RlbSA/IHRoaXMuc2lnbmF0dXJlcy5zeXN0ZW0ubGVuZ3RoIDogMAogIH0KCiAgY2xvc2UoKSB7CiAgICB0aGlzLmNsb3NlZCA9IHRydWUKICAgIHJldHVybiB0aGlzLmNvcmUuY2xvc2UoKQogIH0KCiAgYXN5bmMgX2luZmxhdGVEaWdlc3QobGVuZ3RoLCBkaWcpIHsKICAgIGlmICghZGlnKSByZXR1cm4gbnVsbAoKICAgIGlmIChkaWcucG9pbnRlciA9PT0gMCkgewogICAgICByZXR1cm4geyBrZXk6IGRpZy5rZXksIGF0OiBsZW5ndGggfQogICAgfQoKICAgIGNvbnN0IGxlbiA9IGxlbmd0aCAtIGRpZy5wb2ludGVyCgogICAgaWYgKHRoaXMuZGlnZXN0ICYmIGxlbiA9PT0gdGhpcy5kaWdlc3QuYXQpIHJldHVybiB0aGlzLmRpZ2VzdAogICAgaWYgKGxlbiA8PSAwKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHsgZGlnZXN0IH0gPSBhd2FpdCB0aGlzLmNvcmUuZ2V0KGxlbiAtIDEpCiAgICBpZiAoIWRpZ2VzdCB8fCAhZGlnZXN0LmtleSkgcmV0dXJuIG51bGwKCiAgICByZXR1cm4geyBrZXk6IGRpZ2VzdC5rZXksIGF0OiBsZW4gfQogIH0KCiAgX3NhbWVTaWduYXR1cmVzKGIsIGEpIHsKICAgIHJldHVybiAoCiAgICAgIHNhbWVTaWduYXR1cmUoYS5zeXN0ZW0sIGIuc3lzdGVtKSAmJgogICAgICBzYW1lU2lnbmF0dXJlKGEuZW5jcnlwdGlvbiwgYi5lbmNyeXB0aW9uKSAmJgogICAgICBzYW1lU2lnbmF0dXJlcyhhLnVzZXIsIGIudXNlcikKICAgICkKICB9CgogIGFzeW5jIF9pbmZsYXRlQWxsQ2hlY2twb2ludHMobGVuZ3RoLCBjaGVja3BvaW50cykgewogICAgaWYgKCFjaGVja3BvaW50cykgcmV0dXJuIHsgc3lzdGVtOiBudWxsLCBlbmNyeXB0aW9uOiBudWxsLCB1c2VyOiBbXSB9CiAgICBpZiAodGhpcy5fc2FtZVNpZ25hdHVyZXMoY2hlY2twb2ludHMsIHRoaXMuc2lnbmF0dXJlcykpIHJldHVybiB0aGlzLnNpZ25hdHVyZXMKCiAgICBjb25zdCBzeXN0ZW0gPSB0aGlzLl9pbmZsYXRlU3lzdGVtQ2hlY2twb2ludChjaGVja3BvaW50cy5zeXN0ZW0sIGxlbmd0aCkKICAgIGNvbnN0IGVuY3J5cHRpb24gPSB0aGlzLl9pbmZsYXRlRW5jcnlwdGlvbkNoZWNrcG9pbnQoY2hlY2twb2ludHMuZW5jcnlwdGlvbiwgbGVuZ3RoKQoKICAgIGNvbnN0IHVzZXIgPSBjaGVja3BvaW50cy51c2VyID8gbmV3IEFycmF5KGNoZWNrcG9pbnRzLnVzZXIubGVuZ3RoKSA6IFtdCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB1c2VyLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGNoayA9IGNoZWNrcG9pbnRzLnVzZXJbaV0KICAgICAgdXNlcltpXSA9IHRoaXMuX2luZmxhdGVVc2VyQ2hlY2twb2ludChjaGssIGksIGxlbmd0aCkKICAgIH0KCiAgICBjb25zdCBbc3lzdGVtQ2hlY2twb2ludCwgZW5jcnlwdGlvbkNoZWNrcG9pbnQsIHVzZXJDaGVja3BvaW50c10gPSBhd2FpdCBQcm9taXNlLmFsbChbCiAgICAgIHN5c3RlbSwKICAgICAgZW5jcnlwdGlvbiwKICAgICAgUHJvbWlzZS5hbGwodXNlcikKICAgIF0pCgogICAgcmV0dXJuIHsKICAgICAgc3lzdGVtOiBzeXN0ZW1DaGVja3BvaW50LAogICAgICBlbmNyeXB0aW9uOiBlbmNyeXB0aW9uQ2hlY2twb2ludCwKICAgICAgdXNlcjogdXNlckNoZWNrcG9pbnRzCiAgICB9CiAgfQoKICBhc3luYyBfaW5mbGF0ZVN5c3RlbUNoZWNrcG9pbnQoY2hrLCBjb3JlTGVuZ3RoKSB7CiAgICBpZiAoY2hrLmNoZWNrcG9pbnQpIHsKICAgICAgY29uc3QgeyBzaWduYXR1cmUsIGxlbmd0aCB9ID0gY2hrLmNoZWNrcG9pbnQKICAgICAgcmV0dXJuIHsgc2lnbmF0dXJlLCBsZW5ndGgsIGF0OiBjb3JlTGVuZ3RoIH0KICAgIH0KCiAgICBjb25zdCBsZW4gPSBjb3JlTGVuZ3RoIC0gY2hrLmNoZWNrcG9pbnRlcgogICAgaWYgKHRoaXMuc2lnbmF0dXJlcy5zeXN0ZW0gJiYgdGhpcy5zaWduYXR1cmVzLnN5c3RlbS5hdCA9PT0gbGVuKSB7CiAgICAgIHJldHVybiB0aGlzLnNpZ25hdHVyZXMuc3lzdGVtCiAgICB9CgogICAgaWYgKGxlbiA8PSAwKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHsgY2hlY2twb2ludCB9ID0gYXdhaXQgdGhpcy5jb3JlLmdldChsZW4gLSAxKQogICAgaWYgKCFjaGVja3BvaW50IHx8ICFjaGVja3BvaW50LnN5c3RlbSB8fCAhY2hlY2twb2ludC5zeXN0ZW0uY2hlY2twb2ludCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCB7IHNpZ25hdHVyZSwgbGVuZ3RoIH0gPSBjaGVja3BvaW50LnN5c3RlbS5jaGVja3BvaW50CiAgICByZXR1cm4geyBzaWduYXR1cmUsIGxlbmd0aCwgYXQ6IGxlbiB9CiAgfQoKICBhc3luYyBfaW5mbGF0ZUVuY3J5cHRpb25DaGVja3BvaW50KGNoaywgY29yZUxlbmd0aCkgewogICAgaWYgKCFjaGspIHJldHVybiB7IGxlbmd0aDogMCwgc2lnbmF0dXJlOiBudWxsLCBhdDogMCB9CgogICAgaWYgKGNoay5jaGVja3BvaW50KSB7CiAgICAgIGNvbnN0IHsgc2lnbmF0dXJlLCBsZW5ndGggfSA9IGNoay5jaGVja3BvaW50CiAgICAgIHJldHVybiB7IHNpZ25hdHVyZSwgbGVuZ3RoLCBhdDogY29yZUxlbmd0aCB9CiAgICB9CgogICAgY29uc3QgbGVuID0gY29yZUxlbmd0aCAtIGNoay5jaGVja3BvaW50ZXIKICAgIGlmICh0aGlzLnNpZ25hdHVyZXMuZW5jcnlwdGlvbiAmJiB0aGlzLnNpZ25hdHVyZXMuZW5jcnlwdGlvbi5hdCA9PT0gbGVuKSB7CiAgICAgIHJldHVybiB0aGlzLnNpZ25hdHVyZXMuZW5jcnlwdGlvbgogICAgfQoKICAgIGlmIChsZW4gPD0gMCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCB7IGNoZWNrcG9pbnQgfSA9IGF3YWl0IHRoaXMuY29yZS5nZXQobGVuIC0gMSkKICAgIGlmICghY2hlY2twb2ludCB8fCAhY2hlY2twb2ludC5lbmNyeXB0aW9uIHx8ICFjaGVja3BvaW50LmVuY3J5cHRpb24uY2hlY2twb2ludCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCB7IHNpZ25hdHVyZSwgbGVuZ3RoIH0gPSBjaGVja3BvaW50LmVuY3J5cHRpb24uY2hlY2twb2ludAogICAgcmV0dXJuIHsgc2lnbmF0dXJlLCBsZW5ndGgsIGF0OiBsZW4gfQogIH0KCiAgYXN5bmMgX2luZmxhdGVVc2VyQ2hlY2twb2ludChjaGssIGksIGNvcmVMZW5ndGgpIHsKICAgIGlmIChjaGsuY2hlY2twb2ludCkgewogICAgICBjb25zdCB7IHNpZ25hdHVyZSwgbGVuZ3RoIH0gPSBjaGsuY2hlY2twb2ludAogICAgICByZXR1cm4geyBzaWduYXR1cmUsIGxlbmd0aCwgYXQ6IGNvcmVMZW5ndGggfQogICAgfQoKICAgIGNvbnN0IGxlbiA9IGNvcmVMZW5ndGggLSBjaGsuY2hlY2twb2ludGVyCiAgICBpZiAoaSA8IHRoaXMuc2lnbmF0dXJlcy51c2VyLmxlbmd0aCAmJiB0aGlzLnNpZ25hdHVyZXMudXNlcltpXS5hdCA9PT0gbGVuKSB7CiAgICAgIHJldHVybiB0aGlzLnNpZ25hdHVyZXMudXNlcltpXQogICAgfQoKICAgIGlmIChsZW4gPD0gMCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCB7IGNoZWNrcG9pbnQgfSA9IGF3YWl0IHRoaXMuY29yZS5nZXQobGVuIC0gMSkKICAgIGlmICghY2hlY2twb2ludCB8fCBpID49IGNoZWNrcG9pbnQudXNlci5sZW5ndGggfHwgIWNoZWNrcG9pbnQudXNlcltpXS5jaGVja3BvaW50KSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHsgc2lnbmF0dXJlLCBsZW5ndGggfSA9IGNoZWNrcG9pbnQudXNlcltpXS5jaGVja3BvaW50CiAgICByZXR1cm4geyBzaWduYXR1cmUsIGxlbmd0aCwgYXQ6IGxlbiB9CiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEFwcGx5U3RhdGUgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvcihiYXNlKSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5iYXNlID0gYmFzZQogICAgdGhpcy5lbmNyeXB0aW9uID0gdGhpcy5iYXNlLmVuY3J5cHRpb24KICAgIHRoaXMudmFsdWVFbmNvZGluZyA9IGJhc2UudmFsdWVFbmNvZGluZwogICAgdGhpcy5zdG9yZSA9IGJhc2UuX3ZpZXdTdG9yZS5hdG9taXplKCkKICAgIHRoaXMua2V5ID0gbnVsbAogICAgdGhpcy5zeXN0ZW0gPSBudWxsCiAgICB0aGlzLnZpZXcgPSBudWxsCiAgICB0aGlzLnZpZXdzID0gW10KICAgIHRoaXMuc3lzdGVtVmlldyA9IG51bGwKICAgIHRoaXMuZW5jcnlwdGlvblZpZXcgPSBudWxsCiAgICB0aGlzLmhvc3RjYWxscyA9IG51bGwKICAgIHRoaXMuY2hhbmdlcyA9IGJhc2UuX2hhc1VwZGF0ZSA/IG5ldyBVcGRhdGVDaGFuZ2VzKGJhc2UpIDogbnVsbAoKICAgIHRoaXMudXBkYXRlcyA9IFtdCgogICAgdGhpcy5sb2NhbCA9IG51bGwKICAgIHRoaXMubG9jYWxTdGF0ZSA9IG51bGwKCiAgICB0aGlzLmZhc3RGb3J3YXJkaW5nID0gZmFsc2UKICAgIHRoaXMuaW5kZXhlcnNVcGRhdGVkID0gZmFsc2UKICAgIHRoaXMucXVvcnVtID0gMAogICAgdGhpcy5uZWVkc0luZGV4ZWRMZW5ndGhVcGRhdGUgPSBmYWxzZQogICAgdGhpcy5pbnRlcnJ1cHRlZCA9IGZhbHNlCiAgICB0aGlzLmFwcGx5aW5nID0gbnVsbAogICAgdGhpcy5hcHBseUJhdGNoID0gbnVsbAoKICAgIHRoaXMubG9jYWxDaGVja3BvaW50ID0gbnVsbAogICAgdGhpcy5sb2NhbEluZGV4ZXIgPSBmYWxzZQoKICAgIHRoaXMuc3lzdGVtVXBncmFkZSA9IG51bGwKCiAgICB0aGlzLmNoZWNrcG9pbnRzID0gW10KICAgIHRoaXMucGVuZGluZ1ZpZXdzID0gbnVsbAogICAgdGhpcy5wZW5kaW5nRm9yayA9IG51bGwKICAgIHRoaXMuZGlydHkgPSBmYWxzZQogIH0KCiAgc2hvdWxkRmx1c2goKSB7CiAgICByZXR1cm4gdGhpcy5kaXJ0eQogIH0KCiAgYXN5bmMgc2hvdWxkV3JpdGUoKSB7CiAgICBpZiAoIXRoaXMubG9jYWxJbmRleGVyIHx8ICF0aGlzLmxvY2FsQ2hlY2twb2ludCB8fCAhdGhpcy5sb2NhbENoZWNrcG9pbnQuY29yZS5vcGVuZWQpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc3QgaW5mbyA9IGF3YWl0IHRoaXMuc3lzdGVtLmdldEluZGV4ZWRJbmZvKHRoaXMuaW5kZXhlZExlbmd0aCkKICAgIGlmICghaW5mby52aWV3cy5sZW5ndGgpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IHsgZW5jcnlwdGlvbiwgdXNlciB9ID0gdGhpcy5sb2NhbENoZWNrcG9pbnQuc2lnbmF0dXJlcwoKICAgIC8vIHRvZG86IGRvZXMgdGhpcyBjb25kaXRpb24gaG9sZCBmb3Igc29mdC1mb3JrPwogICAgaWYgKGluZm8udmlld3MubGVuZ3RoID4gdXNlci5sZW5ndGgpIHJldHVybiB0cnVlCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmZvLnZpZXdzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh1c2VyW2ldLmxlbmd0aCArIFNIT1VMRF9TSUdOX1RIUkVTSE9MRCA8IGluZm8udmlld3NbaV0ubGVuZ3RoKSByZXR1cm4gdHJ1ZQogICAgfQoKICAgIC8vIGFsd2F5cyBmbHVzaCBlbmNyeXB0aW9uIHNpZ25hdHVyZQogICAgaWYgKGluZm8uZW5jcnlwdGlvbkxlbmd0aCAhPT0gMCkgewogICAgICBpZiAoIWVuY3J5cHRpb24gfHwgZW5jcnlwdGlvbi5sZW5ndGggPCBpbmZvLmVuY3J5cHRpb25MZW5ndGgpIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBnZXQgaW5kZXhlZExlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLnN5c3RlbVZpZXcgPyB0aGlzLnN5c3RlbVZpZXcuaW5kZXhlZExlbmd0aCA6IDAKICB9CgogIGdldCBzeXN0ZW1SZWYoKSB7CiAgICByZXR1cm4gdGhpcy5zeXN0ZW1WaWV3ID8gdGhpcy5zeXN0ZW1WaWV3LnJlZiA6IG51bGwKICB9CgogIGFzeW5jIHZhbGlkYXRlRm9yayhpbmRleGVyS2V5cywgc3lzdGVtKSB7CiAgICBpZiAoIWI0YS5lcXVhbHMoc3lzdGVtLmtleSwgdGhpcy5zeXN0ZW0uY29yZS5rZXkpKSByZXR1cm4gZmFsc2UKICAgIGlmICh0aGlzLnBlbmRpbmdJbmRleGVkTGVuZ3RoKCkgPCBzeXN0ZW0ubGVuZ3RoKSByZXR1cm4gZmFsc2UKICAgIGZvciAoY29uc3Qga2V5IG9mIGluZGV4ZXJLZXlzKSB7CiAgICAgIGNvbnN0IGluZm8gPSBhd2FpdCB0aGlzLnN5c3RlbS5nZXQoa2V5KQoKICAgICAgLy8gd3JpdGVyIHNob3VsZCBiZSBhY3RpdmUgYW5kIHdlIG5lZWQgbWFuaWZlc3QKICAgICAgaWYgKCFpbmZvIHx8ICFpbmZvLmxlbmd0aCB8fCBpbmZvLmlzUmVtb3ZlZCkgcmV0dXJuIGZhbHNlCiAgICB9CiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgc2hvdWxkTWlncmF0ZSgpIHsKICAgIGlmICghdGhpcy5mYXN0Rm9yd2FyZGluZyAmJiAhdGhpcy5pbmRleGVyc1VwZGF0ZWQpIHJldHVybiBmYWxzZQogICAgaWYgKHRoaXMuc3lzdGVtLmluZGV4ZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGZhbHNlIC8vIGdlbmVzaXMKCiAgICAvLyBzYW5pdHksIHByZWZlciBtaWdyYXRpb24KICAgIGlmICghdGhpcy5zeXN0ZW0uY29yZS5tYW5pZmVzdCB8fCAhdGhpcy5zeXN0ZW0uY29yZS5tYW5pZmVzdC5zaWduZXJzKSByZXR1cm4gdHJ1ZQoKICAgIC8vIGVhc3kgbW9kZQogICAgaWYgKHRoaXMuc3lzdGVtLmluZGV4ZXJzLmxlbmd0aCAhPT0gdGhpcy5zeXN0ZW0uY29yZS5tYW5pZmVzdC5zaWduZXJzLmxlbmd0aCkgewogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGNvbnN0IG1hbmlmZXN0cyA9IGF3YWl0IHRoaXMuc3RvcmUuZ2V0SW5kZXhlck1hbmlmZXN0cyh0aGlzLnN5c3RlbS5pbmRleGVycykKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc3lzdGVtLmNvcmUubWFuaWZlc3Quc2lnbmVycy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB7IHB1YmxpY0tleSB9ID0gdGhpcy5zeXN0ZW0uY29yZS5tYW5pZmVzdC5zaWduZXJzW2ldCiAgICAgIGlmICghYjRhLmVxdWFscyhwdWJsaWNLZXksIG1hbmlmZXN0c1tpXS5zaWduZXJzWzBdLnB1YmxpY0tleSkpIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBpc0xvY2FsUGVuZGluZ0luZGV4ZXIoKSB7CiAgICBpZiAodGhpcy5zeXN0ZW0ucGVuZGluZ0luZGV4ZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGZhbHNlCiAgICBjb25zdCBrZXkgPSB0aGlzLmJhc2UubG9jYWwua2V5CiAgICBmb3IgKGNvbnN0IGsgb2YgdGhpcy5zeXN0ZW0ucGVuZGluZ0luZGV4ZXJzKSB7CiAgICAgIGlmIChiNGEuZXF1YWxzKGssIGtleSkpIHJldHVybiAhYjRhLmVxdWFscyh0aGlzLmJhc2Uua2V5LCBrZXkpICYmIHRoaXMuYmFzZS5sb2NhbC5sZW5ndGggPT09IDAKICAgIH0KICAgIHJldHVybiBmYWxzZQogIH0KCiAgcmVtb3ZlYWJsZShrZXkpIHsKICAgIGlmICh0aGlzLnN5c3RlbS5pbmRleGVycy5sZW5ndGggIT09IDEpIHJldHVybiB0cnVlCiAgICByZXR1cm4gIWI0YS5lcXVhbHModGhpcy5zeXN0ZW0uaW5kZXhlcnNbMF0ua2V5LCBrZXkpCiAgfQoKICBpc0xvY2FsSW5kZXhlcigpIHsKICAgIHJldHVybiAhIXRoaXMubG9jYWxDaGVja3BvaW50CiAgfQoKICBfY3JlYXRlQ2hlY2twb2ludENvcmUoa2V5LCBhY3RpdmUsIHNpZ25lciwgcGF1c2VkKSB7CiAgICBjb25zdCBlbmNyeXB0aW9uID0gdGhpcy5iYXNlLmdldFdyaXRlckVuY3J5cHRpb24oa2V5KQoKICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLmJhc2Uuc3RvcmUuZ2V0KHsKICAgICAga2V5LAogICAgICB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UsCiAgICAgIGVuY3J5cHRpb24sCiAgICAgIGFjdGl2ZQogICAgfSkKCiAgICByZXR1cm4gbmV3IENoZWNrcG9pbnRDb3JlKHRoaXMsIHNlc3Npb24sIHNpZ25lciwgcGF1c2VkKQogIH0KCiAgYXN5bmMgX29wZW5JbnRlcm5hbFZpZXcobmFtZSwgaW5kZXhlZExlbmd0aCkgewogICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsgbmFtZSB9KQogICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICBhd2FpdCBjb3JlLnNldFVzZXJEYXRhKCdyZWZlcnJlcicsIHRoaXMuYmFzZS5rZXkpCiAgICBhd2FpdCBjb3JlLnNldFVzZXJEYXRhKCdhdXRvYmFzZS92aWV3JywgYjRhLmZyb20obmFtZSkpCgogICAgY29uc3QgcmVmID0gdGhpcy5zdG9yZS5nZXRWaWV3QnlOYW1lKG5hbWUpCgogICAgcmV0dXJuIHsgcmVmLCBjb3JlLCBpbmRleGVkTGVuZ3RoIH0KICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fYm9vdCgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgYXdhaXQgdGhpcy5fZnJlZSgpCiAgICAgIHRocm93IGVycgogICAgfQogIH0KCiAgYXN5bmMgX2Jvb3QoKSB7CiAgICBjb25zdCBib290ID0gYXdhaXQgdGhpcy5iYXNlLl9nZXRCb290UmVjb3JkKCkKCiAgICB0aGlzLnN5c3RlbVZpZXcgPSBhd2FpdCB0aGlzLl9vcGVuSW50ZXJuYWxWaWV3KCdfc3lzdGVtJywgYm9vdC5zeXN0ZW1MZW5ndGgpCiAgICB0aGlzLmVuY3J5cHRpb25WaWV3ID0gYXdhaXQgdGhpcy5fb3BlbkludGVybmFsVmlldygnX2VuY3J5cHRpb24nLCAtMSkKCiAgICBjb25zdCBzeXNDb3JlID0gdGhpcy5zeXN0ZW1WaWV3LmNvcmUKICAgIGlmIChzeXNDb3JlLm1hbmlmZXN0LnZlcnNpb24gPj0gMikgewogICAgICBpZiAodGhpcy5lbmNyeXB0aW9uICE9PSBudWxsKSBhd2FpdCB0aGlzLmVuY3J5cHRpb24ucmVsb2FkKHRoaXMuZW5jcnlwdGlvblZpZXcuY29yZSkKICAgIH0KCiAgICBjb25zdCBzeXN0ZW0gPSBuZXcgU3lzdGVtVmlldyhzeXNDb3JlKQogICAgYXdhaXQgc3lzdGVtLnJlYWR5KCkKCiAgICAvLyByZXNldCBzbyB3ZSBkb250IHRyYWNrIF9zeXN0ZW0gb3IgX2VuY3J5cHRpb24KICAgIHRoaXMuc3RvcmUub3BlbmVkID0gW10KCiAgICB0aGlzLmhvc3RjYWxscyA9IG5ldyBQcml2YXRlQXBwbHlDYWxscyh0aGlzKQogICAgY29uc3QgdmlldyA9IHRoaXMuYmFzZS5faGFzT3BlbiA/IHRoaXMuYmFzZS5faGFuZGxlcnMub3Blbih0aGlzLnN0b3JlLCB0aGlzLmhvc3RjYWxscykgOiBudWxsCgogICAgdGhpcy52aWV3ID0gdmlldwogICAgdGhpcy5zeXN0ZW0gPSBzeXN0ZW0KCiAgICAvLyBlbnN1cmUgYWxsIGFyZSByZWFkeQogICAgZm9yIChjb25zdCB2IG9mIHRoaXMuc3RvcmUub3BlbmVkKSBhd2FpdCB2LmF0b21pY0JhdGNoLnJlYWR5KCkKCiAgICB0aGlzLmtleSA9IHN5c3RlbS5jb3JlLmtleQoKICAgIHRoaXMuZmFzdEZvcndhcmRpbmcgPSBib290LmZhc3RGb3J3YXJkaW5nCiAgICB0aGlzLmluZGV4ZXJzVXBkYXRlZCA9IGJvb3QuaW5kZXhlcnNVcGRhdGVkCiAgICB0aGlzLnF1b3J1bSA9IHN5c0NvcmUubWFuaWZlc3QgPyBzeXNDb3JlLm1hbmlmZXN0LnF1b3J1bSA6IDAKCiAgICBjb25zdCBhZGRlZCA9IG5ldyBTZXQoKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3lzdGVtLnZpZXdzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHsga2V5LCBsZW5ndGggfSA9IHN5c3RlbS52aWV3c1tpXQogICAgICBjb25zdCB2ID0gYXdhaXQgdGhpcy5zdG9yZS5maW5kVmlld0J5S2V5KAogICAgICAgIGtleSwKICAgICAgICBzeXN0ZW0uaW5kZXhlcnMsCiAgICAgICAgc3lzQ29yZS5tYW5pZmVzdC52ZXJzaW9uLAogICAgICAgIHN5c3RlbS5lbnRyb3B5CiAgICAgICkKCiAgICAgIGlmICh2ID09PSBudWxsKSB7CiAgICAgICAgdGhpcy52aWV3cy5wdXNoKHsgbmFtZTogbnVsbCwga2V5LCBsZW5ndGgsIGNvcmU6IG51bGwsIHJlZjogbnVsbCwgbWFwcGVkSW5kZXg6IGkgfSkKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBhd2FpdCB2LmF0b21pY0JhdGNoLnJlYWR5KCkKICAgICAgYXdhaXQgdi5jb3JlLnNldFVzZXJEYXRhKCdyZWZlcnJlcicsIHRoaXMuYmFzZS5rZXkpCiAgICAgIGF3YWl0IHYuY29yZS5zZXRVc2VyRGF0YSgnYXV0b2Jhc2UvdmlldycsIGI0YS5mcm9tKHYubmFtZSkpCgogICAgICB0aGlzLnZpZXdzLnB1c2goeyBuYW1lOiB2Lm5hbWUsIGtleSwgbGVuZ3RoLCBjb3JlOiB2LmF0b21pY0JhdGNoLCByZWY6IHYsIG1hcHBlZEluZGV4OiBpIH0pCgogICAgICBhZGRlZC5hZGQodikKICAgIH0KCiAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy5zdG9yZS5vcGVuZWQpIHsKICAgICAgaWYgKGFkZGVkLmhhcyh2KSkgY29udGludWUKICAgICAgY29uc3QgY29yZSA9IHYuYXRvbWljQmF0Y2gKCiAgICAgIHRoaXMudmlld3MucHVzaCh7CiAgICAgICAgbmFtZTogdi5uYW1lLAogICAgICAgIGtleTogY29yZS5rZXksCiAgICAgICAgbGVuZ3RoOiBjb3JlLmxlbmd0aCwKICAgICAgICBjb3JlLAogICAgICAgIHJlZjogdiwKICAgICAgICBtYXBwZWRJbmRleDogLTEKICAgICAgfSkKICAgIH0KCiAgICB0aGlzLmxvY2FsID0gdGhpcy5zdG9yZS5nZXRMb2NhbCgpCiAgICBhd2FpdCB0aGlzLmxvY2FsLnJlYWR5KCkKCiAgICB0aGlzLmxvY2FsU3RhdGUgPSBuZXcgTG9jYWxTdGF0ZSh0aGlzLmxvY2FsKQoKICAgIGxldCBpc0xvY2FsSW5kZXhlciA9IGZhbHNlCgogICAgY29uc3QgcGF1c2VkID0gdGhpcy5iYXNlLmlzRmFzdEZvcndhcmRpbmcoKQogICAgY29uc3QgaW5mID0gYXdhaXQgdGhpcy5zeXN0ZW0uZ2V0SW5kZXhlZEluZm8oKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5mLmluZGV4ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGlkeCA9IGluZi5pbmRleGVyc1tpXQogICAgICBjb25zdCBjaGsgPSB0aGlzLl9jcmVhdGVDaGVja3BvaW50Q29yZShpZHgua2V5LCB0cnVlLCBpLCBwYXVzZWQpCiAgICAgIGF3YWl0IGNoay5yZWFkeSgpCiAgICAgIHRoaXMuY2hlY2twb2ludHMucHVzaChjaGspCiAgICAgIGlmIChiNGEuZXF1YWxzKGlkeC5rZXksIHRoaXMuYmFzZS5sb2NhbC5rZXkpKSBpc0xvY2FsSW5kZXhlciA9IHRydWUKICAgIH0KCiAgICBjb25zdCBzaG91bGRTaWduID0gdGhpcy5xdW9ydW0gPiAwICYmIGlzTG9jYWxJbmRleGVyCgogICAgaWYgKHNob3VsZFNpZ24pIHsKICAgICAgdGhpcy5sb2NhbEluZGV4ZXIgPSB0cnVlCiAgICAgIGF3YWl0IHRoaXMuX3N0YXJ0TG9jYWxDaGVja3BvaW50KCkKICAgIH0KCiAgICBhd2FpdCB0aGlzLl9yZWZyZXNoV3JpdGVycygpCgogICAgLy8gZGVmZXJyZWQKICAgIHRoaXMubWF5YmVTaWduZWQoKS5jYXRjaChub29wKQogIH0KCiAgYXN5bmMgX3N0YXJ0TG9jYWxDaGVja3BvaW50KCkgewogICAgZm9yIChjb25zdCBjaGsgb2YgdGhpcy5jaGVja3BvaW50cykgewogICAgICBpZiAoY2hrLmNvcmUuaWQgPT09IHRoaXMuYmFzZS5sb2NhbC5pZCkgewogICAgICAgIHRoaXMubG9jYWxDaGVja3BvaW50ID0gY2hrCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmxvY2FsQ2hlY2twb2ludCA9IHRoaXMuX2NyZWF0ZUNoZWNrcG9pbnRDb3JlKHRoaXMuYmFzZS5sb2NhbC5rZXksIGZhbHNlLCAwLCBmYWxzZSkKICAgIGF3YWl0IHRoaXMubG9jYWxDaGVja3BvaW50LnJlYWR5KCkKICB9CgogIGludGVycnVwdCgpIHsKICAgIHRoaXMuaW50ZXJydXB0ZWQgPSB0cnVlCiAgICB0aGlzLnBhdXNlKCkKICB9CgogIHBhdXNlKCkgewogICAgZm9yIChjb25zdCBjaGsgb2YgdGhpcy5jaGVja3BvaW50cykgewogICAgICBpZiAoY2hrICE9PSB0aGlzLmxvY2FsQ2hlY2twb2ludCkgY2hrLnBhdXNlKCkKICAgIH0KICB9CgogIHJlc3VtZSgpIHsKICAgIGZvciAoY29uc3QgY2hrIG9mIHRoaXMuY2hlY2twb2ludHMpIHsKICAgICAgaWYgKGNoayAhPT0gdGhpcy5sb2NhbENoZWNrcG9pbnQpIGNoay5yZXN1bWUoKQogICAgfQogIH0KCiAgX2NoZWNrU3lzdGVtVXBncmFkZSgpIHsKICAgIGlmICh0aGlzLnN5c3RlbVVwZ3JhZGUpIHJldHVybgoKICAgIGNvbnN0IHRhbGx5ID0gbmV3IE1hcCgpCgogICAgZm9yIChjb25zdCBjaGsgb2YgdGhpcy5jaGVja3BvaW50cykgewogICAgICBpZiAoY2hrLnNpZ25lZExlbmd0aCgpIDw9IHRoaXMuc3lzdGVtLmNvcmUuc2lnbmVkTGVuZ3RoKSBjb250aW51ZQogICAgICBpZiAoIWNoay5kaWdlc3QpIGNvbnRpbnVlCgogICAgICBjb25zdCBpZCA9IGI0YS50b1N0cmluZyhjaGsuZGlnZXN0LmtleSwgJ2hleCcpCiAgICAgIGNvbnN0IGNudCA9ICh0YWxseS5nZXQoaWQpIHx8IDApICsgMQoKICAgICAgaWYgKGNudCA+PSB0aGlzLnF1b3J1bSkgewogICAgICAgIHRoaXMuc3lzdGVtVXBncmFkZSA9IGNoay5kaWdlc3Qua2V5CiAgICAgICAgdGhpcy5iYXNlLl9xdWV1ZVN0YXRpY0Zhc3RGb3J3YXJkKHRoaXMuc3lzdGVtVXBncmFkZSkKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgdGFsbHkuc2V0KGlkLCBjbnQpCiAgICB9CiAgfQoKICBtYXBJbmRleFRvVmlldyhpbmRleCkgewogICAgZm9yIChjb25zdCB7IG1hcHBlZEluZGV4LCByZWYgfSBvZiB0aGlzLnZpZXdzKSB7CiAgICAgIGlmIChtYXBwZWRJbmRleCA9PT0gaW5kZXgpIHJldHVybiByZWYKICAgIH0KICB9CgogIGFzeW5jIG1heWJlU2lnbmVkKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAodGhpcy5pbnRlcnJ1cHRlZCkgcmV0dXJuCgogICAgY29uc3QgdGhyZXMgPSB0aGlzLmNoZWNrcG9pbnRzLmxlbmd0aCAtIHRoaXMucXVvcnVtCiAgICBpZiAodGhyZXMgPCAwIHx8IHRoaXMuY2hlY2twb2ludHMubGVuZ3RoIDw9IHRocmVzKSByZXR1cm4KCiAgICB0aGlzLmNoZWNrcG9pbnRzLnNvcnQoY21wQ2hlY2twb2ludHMpCgogICAgY29uc3Qgc2lnbmFibGVMZW5ndGggPSB0aGlzLmNoZWNrcG9pbnRzW3RocmVzXS5zaWduZWRMZW5ndGgoKQogICAgaWYgKHNpZ25hYmxlTGVuZ3RoIDw9IHRoaXMuc3lzdGVtLmNvcmUuc2lnbmVkTGVuZ3RoKSByZXR1cm4KCiAgICBjb25zdCBleHBlY3RlZCA9IHRoaXMuc3lzdGVtLmNvcmUua2V5CgogICAgaWYgKHNpZ25hYmxlTGVuZ3RoID4gdGhpcy5pbmRleGVkTGVuZ3RoKSB7CiAgICAgIGlmICghYjRhLmVxdWFscyhleHBlY3RlZCwgdGhpcy5jaGVja3BvaW50c1t0aHJlc10uZGlnZXN0LmtleSkpIHRoaXMuX2NoZWNrU3lzdGVtVXBncmFkZSgpCiAgICAgIHRoaXMubmVlZHNJbmRleGVkTGVuZ3RoVXBkYXRlID0gdHJ1ZQogICAgICByZXR1cm4KICAgIH0KCiAgICBmb3IgKGxldCBpID0gdGhyZXM7IGkgPCB0aGlzLmNoZWNrcG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGNoayA9IHRoaXMuY2hlY2twb2ludHNbaV0KICAgICAgLy8gd2UgbXVzdCBhZ3JlZSBvbiB3aGF0IHRoZSBzeXN0ZW0gaXMgb2J2cwogICAgICBpZiAoIWI0YS5lcXVhbHMoZXhwZWN0ZWQsIGNoay5kaWdlc3Qua2V5KSkgewogICAgICAgIHRoaXMuX2NoZWNrU3lzdGVtVXBncmFkZSgpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgLy8gaWYgd2UgZG9udCBoYXZlIHRoZSBpbmRleGVkIHN0YXRlIG91cnNlbGYsIHRoZW4gbm8gd2F5IGZvciB1cyB0byB2ZXJpZnkgLyBwYXRjaAogICAgICBpZiAoIWNoay5zaWduYXR1cmVzLnN5c3RlbSB8fCBjaGsuc2lnbmF0dXJlcy5zeXN0ZW0ubGVuZ3RoID4gdGhpcy5pbmRleGVkTGVuZ3RoKSB7CiAgICAgICAgdGhpcy5uZWVkc0luZGV4ZWRMZW5ndGhVcGRhdGUgPSB0cnVlCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLm5lZWRzSW5kZXhlZExlbmd0aFVwZGF0ZSA9IGZhbHNlCgogICAgY29uc3QgY2hrID0gW10KICAgIGZvciAobGV0IGkgPSB0aHJlczsgaSA8IHRoaXMuY2hlY2twb2ludHMubGVuZ3RoOyBpKyspIHsKICAgICAgY2hrLnB1c2goeyBzaWduZXI6IHRoaXMuY2hlY2twb2ludHNbaV0uc2lnbmVyLCBzaWduYXR1cmVzOiB0aGlzLmNoZWNrcG9pbnRzW2ldLnNpZ25hdHVyZXMgfSkKICAgIH0KCiAgICBjb25zdCB7IHN5c3RlbSB9ID0gdGhpcy5jaGVja3BvaW50c1t0aHJlc10uc2lnbmF0dXJlcwoKICAgIGF3YWl0IHRoaXMuX2Fzc2VtYmxlTXVsdGlzaWcoc3lzdGVtLmxlbmd0aCwgY2hrKQogIH0KCiAgYXN5bmMgX2Fzc2VtYmxlTXVsdGlzaWcoc2lnbmFibGVMZW5ndGgsIGNoZWNrcG9pbnRzKSB7CiAgICBjb25zdCB2aWV3cyA9IG5ldyBBcnJheSh0aGlzLnZpZXdzLmxlbmd0aCArIDIpIC8vICsyIGlzIHN5c3RlbSArIGVuY3J5cHRpb24KCiAgICBjb25zdCBzeXMgPSBhd2FpdCB0aGlzLnN5c3RlbS5nZXRJbmRleGVkSW5mbyhzaWduYWJsZUxlbmd0aCkKCiAgICBpZiAodGhpcy5pbnRlcnJ1cHRlZCkgcmV0dXJuCgogICAgaWYgKHRoaXMucGVuZGluZ1ZpZXdzICYmIHRoaXMucGVuZGluZ1ZpZXdzWzBdLmxlbmd0aCA+PSBzaWduYWJsZUxlbmd0aCkgewogICAgICByZXR1cm4KICAgIH0KCiAgICB2aWV3c1swXSA9IGNyZWF0ZUNoZWNrcG9pbnRTaWduYXR1cmUoc2lnbmFibGVMZW5ndGgsIHRoaXMuc3lzdGVtVmlldywgY2hlY2twb2ludHMubGVuZ3RoKQoKICAgIGlmIChzeXMuZW5jcnlwdGlvbkxlbmd0aCkgewogICAgICB2aWV3c1sxXSA9IGNyZWF0ZUNoZWNrcG9pbnRTaWduYXR1cmUoCiAgICAgICAgc3lzLmVuY3J5cHRpb25MZW5ndGgsCiAgICAgICAgdGhpcy5lbmNyeXB0aW9uVmlldywKICAgICAgICBjaGVja3BvaW50cy5sZW5ndGgKICAgICAgKQogICAgfQoKICAgIGNvbnN0IG9mZnNldCA9IDIgLy8gc3lzdGVtICsgZW5jcnlwdGlvbgoKICAgIGZvciAobGV0IGkgPSBvZmZzZXQ7IGkgPCB2aWV3cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB2aWV3ID0gdGhpcy52aWV3c1tpIC0gb2Zmc2V0XQogICAgICBjb25zdCBjb3JlID0gdmlldy5jb3JlCgogICAgICBjb25zdCB2ID0gdGhpcy5nZXRWaWV3RnJvbVN5c3RlbSh2aWV3LCBzeXMpCiAgICAgIGNvbnN0IGxlbmd0aCA9IHYgPyB2Lmxlbmd0aCA6IDAKCiAgICAgIGlmICghY29yZSB8fCBsZW5ndGggPD0gY29yZS5zaWduZWRMZW5ndGgpIGNvbnRpbnVlCgogICAgICBjb25zdCB2aWV3SW5kZXggPSB2aWV3Lm1hcHBlZEluZGV4ICsgb2Zmc2V0CiAgICAgIHZpZXdzW3ZpZXdJbmRleF0gPSBjcmVhdGVDaGVja3BvaW50U2lnbmF0dXJlKGxlbmd0aCwgdmlldywgY2hlY2twb2ludHMubGVuZ3RoKQogICAgfQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hlY2twb2ludHMubGVuZ3RoOyBpKyspIHsKICAgICAgYWRkQ2hlY2twb2ludFNpZ25hdHVyZXModmlld3MsIGNoZWNrcG9pbnRzLCBpKQogICAgfQoKICAgIGNvbnN0IHByb21pc2VzID0gW10KICAgIGZvciAoY29uc3QgdmlldyBvZiB2aWV3cykgewogICAgICBpZiAoIXZpZXcpIGNvbnRpbnVlCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZpZXcuc2lnbmF0dXJlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHByb21pc2VzLnB1c2goc2V0UGFydGlhbFNpZ25hdHVyZSh2aWV3LCBpKSkKICAgICAgfQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKQoKICAgIC8vIGNoZWNrIHRoYXQgdGhlIHN0YXRlIHN0aWxsIGxvb2tzIGdvb2QsIGNvdXBsZSByZXBsaWNhdGUgaW5iZXR3ZWVuLi4uCiAgICBmb3IgKGNvbnN0IHYgb2Ygdmlld3MpIHsKICAgICAgaWYgKCF2KSBjb250aW51ZQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2LnNpZ25hdHVyZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoIXYucGFydGlhbHNbaV0pIHJldHVybgogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMuaW50ZXJydXB0ZWQpIHJldHVybgoKICAgIGlmICh0aGlzLnBlbmRpbmdWaWV3cyAmJiB0aGlzLnBlbmRpbmdWaWV3c1swXS5sZW5ndGggPj0gc2lnbmFibGVMZW5ndGgpIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICAvLyBza2lwcGVkIHN5c3RlbSBmb3Igd2hhdGV2ZXIgcmVhc29uLi4uCiAgICBpZiAoIXZpZXdzWzBdKSByZXR1cm4KCiAgICB0aGlzLnBlbmRpbmdWaWV3cyA9IHZpZXdzCiAgICB0aGlzLmRpcnR5ID0gdHJ1ZQoKICAgIC8vIFRPRE86IG9ubHkgbmVlZGVkIGlmIG5vdCB1cGRhdGluZywgd29udCBjcmFzaCBzbyBrZWVwaW5nIGZvciBub3csIGp1c3QgbGVzcyBlZmZpY2llbnQKICAgIHRoaXMuYmFzZS5fcXVldWVCdW1wKCkKICB9CgogIF9jbG9zZSgpIHsKICAgIGlmICh0aGlzLmludGVycnVwdGVkKSByZXR1cm4KICAgIHJldHVybiB0aGlzLl9mcmVlKCkKICB9CgogIGFzeW5jIF9mcmVlKCkgewogICAgdGhpcy5pbnRlcnJ1cHRlZCA9IHRydWUKICAgIGlmICh0aGlzLmFwcGx5aW5nKSB0aGlzLl9wb3N0QXBwbHkoKQogICAgZm9yIChjb25zdCBjaGsgb2YgdGhpcy5jaGVja3BvaW50cykgYXdhaXQgY2hrLmNsb3NlKCkKICAgIGlmICh0aGlzLmxvY2FsQ2hlY2twb2ludCkgYXdhaXQgdGhpcy5sb2NhbENoZWNrcG9pbnQuY2xvc2UoKQogICAgaWYgKHRoaXMudmlldyAmJiB0aGlzLmJhc2UuX2hhc0Nsb3NlKSBhd2FpdCB0aGlzLmJhc2UuX2hhbmRsZXJzLmNsb3NlKHRoaXMudmlldykKICAgIGlmICh0aGlzLnN5c3RlbSkgYXdhaXQgdGhpcy5zeXN0ZW0uY2xvc2UoKQoKICAgIGNvbnN0IHByb21pc2VzID0gW10KICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLnZpZXdzKSB7CiAgICAgIGlmICh2LnJlZikgcHJvbWlzZXMucHVzaCh2LnJlZi5yZWxlYXNlKCkpCiAgICB9CgogICAgaWYgKHRoaXMuc3lzdGVtVmlldykgcHJvbWlzZXMucHVzaCh0aGlzLnN5c3RlbVZpZXcucmVmLnJlbGVhc2UoKSkKICAgIGlmICh0aGlzLmVuY3J5cHRpb25WaWV3KSBwcm9taXNlcy5wdXNoKHRoaXMuZW5jcnlwdGlvblZpZXcucmVmLnJlbGVhc2UoKSkKCiAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcykKICAgIGF3YWl0IHRoaXMuc3RvcmUuY2xvc2UoKQogIH0KCiAgX3B1c2hVcGRhdGUodSkgewogICAgdS52ZXJzaW9uID0gMQogICAgdS5zZXEgPSB0aGlzLnVwZGF0ZXMubGVuZ3RoID09PSAwID8gMCA6IHRoaXMudXBkYXRlc1t0aGlzLnVwZGF0ZXMubGVuZ3RoIC0gMV0uc2VxICsgMQogICAgdS5zeXN0ZW1MZW5ndGggPSB0aGlzLnN5c3RlbVZpZXcuY29yZS5sZW5ndGgKICAgIHRoaXMudXBkYXRlcy5wdXNoKHUpCiAgICB0aGlzLmxvY2FsU3RhdGUuaW5zZXJ0VXBkYXRlKHUpCiAgfQoKICBhc3luYyBjYXRjaHVwKGxpbmVhcml6ZXIpIHsKICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKCF0aGlzLnN5c3RlbS5oZWFkcy5sZW5ndGgpIHJldHVybiB0cnVlCgogICAgY29uc3Qgd3JpdGVycyA9IG5ldyBNYXAoKQoKICAgIC8vIGxvYWQgbGluZWFyaXplci4uLgogICAgY29uc3QgdXBkYXRlcyA9IGF3YWl0IHRoaXMubG9jYWxTdGF0ZS5saXN0VXBkYXRlcygpCiAgICBjb25zdCBzeXMgPSBhd2FpdCB0aGlzLnN5c3RlbS5jaGVja291dCh0aGlzLmluZGV4ZWRMZW5ndGgpCgogICAgZm9yIChjb25zdCBub2RlIG9mIHVwZGF0ZXMpIHsKICAgICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKG5vZGUua2V5LCAnaGV4JykKCiAgICAgIGxldCB3ID0gd3JpdGVycy5nZXQoaGV4KQoKICAgICAgaWYgKHcgPT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIFRPRE86IHdlIGFjdHVhbGx5IGhhdmUgYWxsIHRoZSB3cml0ZXIgaW5mbyBhbHJlYWR5IGJ1dCBvdXIgY3VycmVudCBtZXRob2RzIG1ha2UgaXQgaGFyZCB0byByZXVzZSB0aGF0CiAgICAgICAgdyA9IGF3YWl0IHRoaXMuYmFzZS5fZ2V0V3JpdGVyQnlLZXkobm9kZS5rZXksIC0xLCAwLCB0cnVlLCBmYWxzZSwgc3lzKQogICAgICAgIHdyaXRlcnMuc2V0KGhleCwgdykKICAgICAgfQoKICAgICAgaWYgKHcubGVuZ3RoID49IG5vZGUubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5iYXNlLl93YXJuKG5ldyBFcnJvcignVXBkYXRlIGV4cGVjdHMgd3JpdGVyIHRvIGJlIGNvbnN1bWVkIGhlcmUnKSkKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQoKICAgICAgd2hpbGUgKHcubGVuZ3RoIDwgbm9kZS5sZW5ndGgpIHsKICAgICAgICBhd2FpdCB3LnVwZGF0ZShzeXMpCgogICAgICAgIGNvbnN0IG5leHQgPSB3LmFkdmFuY2UoKQogICAgICAgIGlmICghbmV4dCkgewogICAgICAgICAgdGhpcy5iYXNlLl93YXJuKG5ldyBFcnJvcignTm9kZSBtdXN0IGV4aXN0IGZvciBjYXRjaHVwJykpCiAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CgogICAgICAgIGxpbmVhcml6ZXIuYWRkSGVhZChuZXh0KQogICAgICB9CiAgICB9CgogICAgYXdhaXQgc3lzLmNsb3NlKCkKCiAgICB0aGlzLnVwZGF0ZXMgPSB1cGRhdGVzCgogICAgaWYgKHRoaXMuaW5kZXhlcnNVcGRhdGVkKSB7CiAgICAgIHRoaXMuaW5kZXhlcnNVcGRhdGVkID0gZmFsc2UKICAgICAgLy8gaWYgd2UgdXBkYXRlZCB0aGUgaW5kZXhlcnMsIGludmFsaWRhdGUgYWxsIHRoZSBpbnRlcm5hbCBzdGF0ZSBhbmQgcmVhcHBseSBpdAogICAgICBhd2FpdCB0aGlzLnRydW5jYXRlKHRoaXMuaW5kZXhlZExlbmd0aCkKICAgICAgYXdhaXQgdGhpcy5fcm9sbGJhY2tWaWV3cygpCgogICAgICBpZiAodGhpcy50eCA9PT0gbnVsbCkgdGhpcy50eCA9IHRoaXMubG9jYWwuc3RhdGUuc3RvcmFnZS53cml0ZSgpCgogICAgICB3aGlsZSAoCiAgICAgICAgdGhpcy51cGRhdGVzLmxlbmd0aCA+IDAgJiYKICAgICAgICB0aGlzLnVwZGF0ZXNbdGhpcy51cGRhdGVzLmxlbmd0aCAtIDFdLnN5c3RlbUxlbmd0aCA+PSB0aGlzLmluZGV4ZWRMZW5ndGgKICAgICAgKSB7CiAgICAgICAgY29uc3QgdSA9IHRoaXMudXBkYXRlcy5wb3AoKQogICAgICAgIHRoaXMubG9jYWxTdGF0ZS5kZWxldGVVcGRhdGUodSkKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gb3RoZXJ3aXNlIHdlIGtub3cgdGhlIGludGVybmFsIHN0YXRlIGlzIGNvcnJlY3QsIHNvIHdlIGNhcnJ5IG9uCiAgICAgIGxpbmVhcml6ZXIudXBkYXRlKCkKICAgIH0KCiAgICAvLyBtdXN0IHJlZnJlc2ggdGhlIHdyaXRlcnMgaGVyZSBzbyBpc1JlbW92ZWQgaXMgdXAgdG8gZGF0ZQogICAgYXdhaXQgdGhpcy5fcmVmcmVzaFdyaXRlcnMoKQogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIGdldEluZGV4ZWRTeXN0ZW0oKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICBjb25zdCBpbmRleGVkTGVuZ3RoID0gdGhpcy5wZW5kaW5nRm9yayA/IHRoaXMucGVuZGluZ0ZvcmsubGVuZ3RoIDogdGhpcy5pbmRleGVkTGVuZ3RoCgogICAgY29uc3Qgc3lzID0gYXdhaXQgdGhpcy5zeXN0ZW0uY2hlY2tvdXQoaW5kZXhlZExlbmd0aCkKICAgIGF3YWl0IHN5cy5yZWFkeSgpCiAgICByZXR1cm4gc3lzCiAgfQoKICBnZXRWaWV3RnJvbVN5c3RlbSh2aWV3LCBzeXMgPSB0aGlzLnN5c3RlbSkgewogICAgaWYgKHZpZXcubWFwcGVkSW5kZXggPT09IC0xIHx8IHZpZXcubWFwcGVkSW5kZXggPj0gc3lzLnZpZXdzLmxlbmd0aCkgcmV0dXJuIG51bGwKICAgIHJldHVybiBzeXMudmlld3Nbdmlldy5tYXBwZWRJbmRleF0KICB9CgogIGFzeW5jIHJlY292ZXJBdCgpIHsKICAgIGlmICghdGhpcy5zeXN0ZW1SZWYpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIGF3YWl0IHRoaXMuc3lzdGVtUmVmLmNvcmUucmVhZHkoKQoKICAgIGNvbnN0IGx0ID0gdGhpcy5zeXN0ZW1SZWYuY29yZS5jb3JlLnN0YXRlLmxlbmd0aAoKICAgIGZvciBhd2FpdCAoY29uc3QgeyBsZW5ndGgsIGluZm8gfSBvZiBTeXN0ZW1WaWV3LmZsdXNoZXModGhpcy5zeXN0ZW1SZWYuY29yZS5zZXNzaW9uKCksIHsKICAgICAgcmV2ZXJzZTogdHJ1ZSwKICAgICAgbHQKICAgIH0pKSB7CiAgICAgIGxldCBjb25zaXN0ZW50ID0gdHJ1ZQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmZvLnZpZXdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGkgPj0gdGhpcy52aWV3cy5sZW5ndGgpIGNvbnRpbnVlCiAgICAgICAgaWYgKCFiNGEuZXF1YWxzKGluZm8udmlld3NbaV0ua2V5LCB0aGlzLnZpZXdzW2ldLmtleSkpIGNvbnRpbnVlCgogICAgICAgIGlmIChpbmZvLnZpZXdzW2ldLmxlbmd0aCA+IHRoaXMudmlld3NbaV0uY29yZS5jb3JlLnN0YXRlLmxlbmd0aCkgewogICAgICAgICAgY29uc2lzdGVudCA9IGZhbHNlCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGNvbnNpc3RlbnQpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgZm9yY2U6IHRydWUsCiAgICAgICAgICBrZXk6IHRoaXMuc3lzdGVtLmNvcmUua2V5LAogICAgICAgICAgaW5kZXhlcnM6IGluZm8uaW5kZXhlcnMsCiAgICAgICAgICB2aWV3czogaW5mby52aWV3cwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBib290c3RyYXAoKSB7CiAgICByZXR1cm4gdGhpcy5zeXN0ZW0uYWRkKHRoaXMuYmFzZS5rZXksIHsgaXNJbmRleGVyOiB0cnVlLCBpc1BlbmRpbmc6IGZhbHNlIH0pCiAgfQoKICBhc3luYyB1bmRvKHBvcHBlZCkgewogICAgaWYgKCFwb3BwZWQpIHJldHVybgoKICAgIGxldCBpbmRleGVyc1VwZGF0ZWQgPSBmYWxzZQogICAgd2hpbGUgKHBvcHBlZCA+IDApIHsKICAgICAgY29uc3QgdSA9IHRoaXMudXBkYXRlcy5wb3AoKQogICAgICB0aGlzLmxvY2FsU3RhdGUuZGVsZXRlVXBkYXRlKHUpCiAgICAgIHBvcHBlZCAtPSB1LmJhdGNoCiAgICAgIGlmICh1LmluZGV4ZXJzKSBpbmRleGVyc1VwZGF0ZWQgPSB0cnVlCiAgICB9CgogICAgY29uc3QgdSA9IHRoaXMudXBkYXRlcy5sZW5ndGggPT09IDAgPyBudWxsIDogdGhpcy51cGRhdGVzW3RoaXMudXBkYXRlcy5sZW5ndGggLSAxXQogICAgY29uc3Qgc3lzdGVtTGVuZ3RoID0gdSA/IHUuc3lzdGVtTGVuZ3RoIDogdGhpcy5pbmRleGVkTGVuZ3RoCgogICAgYXdhaXQgdGhpcy50cnVuY2F0ZShzeXN0ZW1MZW5ndGgpCiAgICBpZiAoaW5kZXhlcnNVcGRhdGVkKSBhd2FpdCB0aGlzLl9yb2xsYmFja1ZpZXdzKCkKICB9CgogIGFzeW5jIHRydW5jYXRlKHN5c3RlbUxlbmd0aCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAoc3lzdGVtTGVuZ3RoID09PSB0aGlzLnN5c3RlbS5jb3JlLmxlbmd0aCkgcmV0dXJuCgogICAgYXdhaXQgdGhpcy5zeXN0ZW0uY29yZS50cnVuY2F0ZShzeXN0ZW1MZW5ndGgpCgogICAgY29uc3QgbWlncmF0ZWQgPSBhd2FpdCB0aGlzLnN5c3RlbS51cGRhdGUoKQoKICAgIGlmICh0aGlzLmVuY3J5cHRpb25WaWV3LmNvcmUubGVuZ3RoICE9PSB0aGlzLnN5c3RlbS5lbmNyeXB0aW9uTGVuZ3RoKSB7CiAgICAgIGF3YWl0IHRoaXMuZW5jcnlwdGlvblZpZXcuY29yZS50cnVuY2F0ZSh0aGlzLnN5c3RlbS5lbmNyeXB0aW9uTGVuZ3RoKQogICAgfQoKICAgIGZvciAoY29uc3QgdmlldyBvZiB0aGlzLnZpZXdzKSB7CiAgICAgIGlmICghdmlldy5jb3JlKSBjb250aW51ZQoKICAgICAgY29uc3QgdiA9IHRoaXMuZ2V0Vmlld0Zyb21TeXN0ZW0odmlldykKCiAgICAgIGlmICh2ICYmIHZpZXcuY29yZS5sZW5ndGggPT09IHYubGVuZ3RoKSBjb250aW51ZQogICAgICBpZiAodiA9PT0gbnVsbCkgdmlldy5tYXBwZWRJbmRleCA9IC0xIC8vIHVubWFwCgogICAgICBhd2FpdCB2aWV3LmNvcmUudHJ1bmNhdGUodiA/IHYubGVuZ3RoIDogMCkKICAgIH0KCiAgICBpZiAoIW1pZ3JhdGVkKSByZXR1cm4KCiAgICBhd2FpdCB0aGlzLl9yZWZyZXNoV3JpdGVycygpCiAgICBhd2FpdCB0aGlzLl9yb2xsYmFja1ZpZXdzKCkKICB9CgogIGFzeW5jIF9yZWZyZXNoV3JpdGVycygpIHsKICAgIC8vIFRPRE86IGFkZCB0aGUgc2VxIGF0IHdoaWNoIHdlIHVwZGF0ZWQgdGhlIHN0YXRlIHRvIHRoZSB3cml0ZXIgaW5zdGFuY2UuCiAgICAvLyB0aGVuIHdlIGtub3cgaWYgaXQgd2FzIHRydW5jYXRlZCBvdXQgd2l0aG91dCB0aGUgbG9va3VwLCBtZWFuaW5nIGZhc3RlciB0cnVuY2F0aW9ucwogICAgZm9yIChjb25zdCB3IG9mIHRoaXMuYmFzZS5hY3RpdmVXcml0ZXJzKSB7CiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLnN5c3RlbS5nZXQody5jb3JlLmtleSkKICAgICAgY29uc3QgYm9vdHN0cmFwcGVyID0gdGhpcy5zeXN0ZW0uY29yZS5sZW5ndGggPT09IDAgJiYgYjRhLmVxdWFscyh3LmNvcmUua2V5LCB0aGlzLmJhc2Uua2V5KQogICAgICBjb25zdCBpc1JlbW92ZWQgPSBkYXRhID8gZGF0YS5pc1JlbW92ZWQgOiAhYm9vdHN0cmFwcGVyCiAgICAgIHcuaXNSZW1vdmVkID0gaXNSZW1vdmVkCiAgICB9CiAgfQoKICBhc3luYyBfdXBkYXRlU3lzdGVtKCkgewogICAgaWYgKCEoYXdhaXQgdGhpcy5zeXN0ZW0udXBkYXRlKCkpKSByZXR1cm4KICAgIGF3YWl0IHRoaXMuX3JlZnJlc2hXcml0ZXJzKCkKICAgIGF3YWl0IHRoaXMuX3JvbGxiYWNrVmlld3MoKQogIH0KCiAgYXN5bmMgX3NpZ25WaWV3Q29yZShjb3JlLCBsZW5ndGgpIHsKICAgIGNvbnN0IHMgPSBhd2FpdCBjb3JlLnNpZ25hYmxlKGxlbmd0aCwgMCkKICAgIGNvbnN0IHNpZ25hdHVyZSA9IGNyeXB0by5zaWduKHMsIHRoaXMuYmFzZS5sb2NhbC5rZXlQYWlyLnNlY3JldEtleSkKICAgIHJldHVybiB7IHNpZ25hdHVyZSwgbGVuZ3RoIH0KICB9CgogIGFzeW5jIF9zaWduSW50ZXJuYWxWaWV3Q29yZXMoc3lzKSB7CiAgICByZXR1cm4gewogICAgICBzeXN0ZW06IGF3YWl0IHRoaXMuX3NpZ25WaWV3Q29yZSh0aGlzLnN5c3RlbVZpZXcuY29yZSwgdGhpcy5zeXN0ZW1WaWV3LmluZGV4ZWRMZW5ndGgpLAogICAgICBlbmNyeXB0aW9uOiBhd2FpdCB0aGlzLl9zaWduVmlld0NvcmUodGhpcy5lbmNyeXB0aW9uVmlldy5jb3JlLCBzeXMuZW5jcnlwdGlvbkxlbmd0aCkKICAgIH0KICB9CgogIGFzeW5jIF9zaWduVXNlclZpZXdDb3JlcyhzeXMpIHsKICAgIGNvbnN0IHByb21pc2VzID0gbmV3IEFycmF5KHN5cy52aWV3cy5sZW5ndGgpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnZpZXdzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHZpZXcgPSB0aGlzLnZpZXdzW2ldCgogICAgICBjb25zdCB2ID0gdGhpcy5nZXRWaWV3RnJvbVN5c3RlbSh2aWV3LCBzeXMpCiAgICAgIGNvbnN0IGluZGV4ZWRMZW5ndGggPSB2ID8gdi5sZW5ndGggOiAwCgogICAgICBpZiAoIWluZGV4ZWRMZW5ndGgpIGNvbnRpbnVlCgogICAgICBjb25zdCB2aWV3SW5kZXggPSB2aWV3Lm1hcHBlZEluZGV4CiAgICAgIHByb21pc2VzW3ZpZXdJbmRleF0gPSB0aGlzLl9zaWduVmlld0NvcmUodmlldy5yZWYuYXRvbWljQmF0Y2gsIGluZGV4ZWRMZW5ndGgpCiAgICB9CgogICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKQogIH0KCiAgYXN5bmMgZmluYWxpemUoa2V5KSB7CiAgICB0aGlzLmxvY2FsU3RhdGUuc2V0Qm9vdFJlY29yZCh7CiAgICAgIHZlcnNpb246IEJPT1RfUkVDT1JEX1ZFUlNJT04sCiAgICAgIGtleSwKICAgICAgc3lzdGVtTGVuZ3RoOiB0aGlzLnN5c3RlbVZpZXcuaW5kZXhlZExlbmd0aCwKICAgICAgaW5kZXhlcnNVcGRhdGVkOiB0cnVlLAogICAgICBmYXN0Rm9yd2FyZGluZzogZmFsc2UsCiAgICAgIHJlY292ZXJpZXM6IHRoaXMuYmFzZS5yZWNvdmVyaWVzCiAgICB9KQoKICAgIGF3YWl0IHRoaXMubG9jYWxTdGF0ZS5mbHVzaCgpCgogICAgYXdhaXQgdGhpcy5zdG9yZS5mbHVzaCgpCiAgICBhd2FpdCB0aGlzLmNsb3NlKCkKICB9CgogIGFzeW5jIF9mbHVzaChsb2NhbE5vZGVzKSB7CiAgICBpZiAobG9jYWxOb2RlcykgYXdhaXQgdGhpcy5fYXBwZW5kTG9jYWxOb2Rlcyhsb2NhbE5vZGVzKQoKICAgIHRoaXMubG9jYWxTdGF0ZS5zZXRCb290UmVjb3JkKHsKICAgICAgdmVyc2lvbjogQk9PVF9SRUNPUkRfVkVSU0lPTiwKICAgICAga2V5OiB0aGlzLmtleSwKICAgICAgc3lzdGVtTGVuZ3RoOiB0aGlzLnN5c3RlbVZpZXcuaW5kZXhlZExlbmd0aCwKICAgICAgaW5kZXhlcnNVcGRhdGVkOiBmYWxzZSwKICAgICAgZmFzdEZvcndhcmRpbmc6IGZhbHNlLAogICAgICByZWNvdmVyaWVzOiB0aGlzLmJhc2UucmVjb3ZlcmllcwogICAgfSkKCiAgICBhd2FpdCB0aGlzLmxvY2FsU3RhdGUuZmx1c2goKQoKICAgIGlmICh0aGlzLmxvY2FsQ2hlY2twb2ludCkgewogICAgICAvLyB3ZSBoYXZlIHRvIGZsdXNoIGhlcmUgc28gdGhlIGNoa3BvaW50IGNhbiB1cGRhdGUKICAgICAgLy8gY291bGQgcnVuIHRoZSBjaGVja3BvaW50IG9uIHRoZSBiYXRjaCBidXQgYWxzbyBubyBiaWcgZGVhZAogICAgICAvLyBhcyB0aGUgInNob3VsZCB3ZSBzaWduIiBjaGVjayBpcyByZXJ1biBvbiBib290Li4uCiAgICAgIGF3YWl0IHRoaXMuc3RvcmUuZmx1c2goKQogICAgICBhd2FpdCB0aGlzLmxvY2FsQ2hlY2twb2ludC51cGRhdGUoKQogICAgfQoKICAgIGlmICh0aGlzLnBlbmRpbmdWaWV3cykgewogICAgICBjb25zdCB2aWV3cyA9IHRoaXMucGVuZGluZ1ZpZXdzCiAgICAgIHRoaXMucGVuZGluZ1ZpZXdzID0gbnVsbAoKICAgICAgZm9yIChsZXQgaSA9IHZpZXdzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgY29uc3QgdiA9IHZpZXdzW2ldCiAgICAgICAgaWYgKCF2IHx8IHYubGVuZ3RoIDw9IHYuY29yZS5zaWduZWRMZW5ndGgpIGNvbnRpbnVlCiAgICAgICAgY29uc3Qgc2lnbmF0dXJlID0gdi5jb3JlLmNvcmUudmVyaWZpZXIuYXNzZW1ibGUodi5wYXJ0aWFscykKICAgICAgICB0cnkgewogICAgICAgICAgYXdhaXQgdi5yZWYuY29tbWl0KHRoaXMuc3RvcmUuYXRvbSwgdi5sZW5ndGgsIHNpZ25hdHVyZSkKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIC8vIFRPRE86IHdlIHNob3VsZCBwcmV2YWxpZGF0ZSBhbGwgc2lnbmF0dXJlcyBpbnN0ZWFkIG9mIGR1cmluZyBjb21taXQgc28gaXQgY2FuIGJlIGFsbCBvciBub3RoaW5nLCBqdXN0IHNsaWdobHkKICAgICAgICAgIC8vIGZyaWVuZGxpZXIgdXguIG1pc3NpbmcgaGMgYXBpIGZvciB0aGF0CiAgICAgICAgICBpZiAoIXRoaXMuYmFzZS5jbG9zaW5nKSB0aGlzLmJhc2UuX3dhcm4oZXJyKQogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBhd2FpdCB0aGlzLnN0b3JlLmZsdXNoKCkKCiAgICB0aGlzLmZhc3RGb3J3YXJkaW5nID0gZmFsc2UKICAgIGlmICh0aGlzLnBlbmRpbmdWaWV3cyA9PT0gbnVsbCkgdGhpcy5kaXJ0eSA9IGZhbHNlCiAgfQoKICBfaW5kZXhVcGRhdGVzKGluZGV4ZWQpIHsKICAgIGxldCBzaGlmdCA9IDAKICAgIHdoaWxlIChpbmRleGVkID4gMCkgaW5kZXhlZCAtPSB0aGlzLnVwZGF0ZXNbc2hpZnQrK10uYmF0Y2gKCiAgICBjb25zdCBsYXN0ID0gdGhpcy51cGRhdGVzW3NoaWZ0IC0gMV0KCiAgICB0aGlzLnN5c3RlbVZpZXcuaW5kZXhlZExlbmd0aCA9IGxhc3Quc3lzdGVtTGVuZ3RoCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaGlmdDsgaSsrKSB0aGlzLmxvY2FsU3RhdGUuZGVsZXRlVXBkYXRlKHRoaXMudXBkYXRlc1tpXSkKICAgIHRoaXMudXBkYXRlcy5zcGxpY2UoMCwgc2hpZnQpCgogICAgaWYgKCF0aGlzLm5lZWRzSW5kZXhlZExlbmd0aFVwZGF0ZSkgcmV0dXJuCiAgICB0aGlzLm1heWJlU2lnbmVkKCkuY2F0Y2gobm9vcCkKICB9CgogIHBlbmRpbmdJbmRleGVkTGVuZ3RoKCkgewogICAgbGV0IGluZGV4ZWQgPSB0aGlzLmFwcGx5aW5nLmluZGV4ZWQubGVuZ3RoCiAgICBpZiAoIXRoaXMuYXBwbHlpbmcgfHwgIXRoaXMudXBkYXRlcy5sZW5ndGggfHwgIWluZGV4ZWQpIHJldHVybiB0aGlzLmluZGV4ZWRMZW5ndGgKCiAgICBsZXQgcG9zID0gMAogICAgd2hpbGUgKGluZGV4ZWQgPiAwICYmIHBvcyA8IHRoaXMudXBkYXRlcy5sZW5ndGgpIHsKICAgICAgaW5kZXhlZCAtPSB0aGlzLnVwZGF0ZXNbcG9zKytdLmJhdGNoCiAgICB9CgogICAgY29uc3QgbGFzdCA9IHRoaXMudXBkYXRlc1twb3MgLSAxXQogICAgcmV0dXJuIGxhc3Quc3lzdGVtTGVuZ3RoCiAgfQoKICBhc3luYyBfYXNzZXJ0Tm9kZShub2RlLCBiYXRjaCkgewogICAgLy8gaGVscGZ1bCBkYWcgaGVscGVyLCBzbyBrZXB0IGhlcmUKCiAgICBjb25zdCB2ID0gKGF3YWl0IHRoaXMuc3lzdGVtLmdldChub2RlLndyaXRlci5jb3JlLmtleSkpIHx8IHsgbGVuZ3RoOiAwLCBpc1JlbW92ZWQ6IGZhbHNlIH0KICAgIGNvbnN0IGV4cGVjdGVkID0gdi5sZW5ndGggKyBiYXRjaAogICAgaWYgKG5vZGUubGVuZ3RoID09PSBleHBlY3RlZCkgcmV0dXJuCgogICAgY29uc29sZS50cmFjZSgKICAgICAgJ0lOVkFMSURfSU5TRVJUSU9OJywKICAgICAgJ2xlbmd0aD0nLAogICAgICBub2RlLmxlbmd0aCwKICAgICAgJ2tleT0nLAogICAgICBub2RlLndyaXRlci5jb3JlLmtleSwKICAgICAgJ2xvY2FsPScsCiAgICAgIG5vZGUud3JpdGVyLmNvcmUud3JpdGFibGUsCiAgICAgICdiYXRjaD0nLAogICAgICBiYXRjaCwKICAgICAgJ2RhZz0nLAogICAgICB2CiAgICApCgogICAgcHJvY2Vzcy5leGl0KDEpCiAgfQoKICBfcG9zdEFwcGx5KCkgewogICAgdGhpcy5hcHBseUJhdGNoID0gdGhpcy5hcHBseWluZyA9IG51bGwKICAgIHRoaXMuYmFzZS5fcG9zdEFwcGx5KCkKICB9CgogIGFzeW5jIF9vcHRpbWlzdGljQXBwbHkodSwgbm9kZSwgaW5kZXhlZCkgewogICAgY29uc3QgY2hlY2twb2ludCA9IHRoaXMuc3lzdGVtLmNoZWNrcG9pbnQoKQoKICAgIHRoaXMuc3lzdGVtLmFkZEhlYWQobm9kZSkKCiAgICBjb25zdCBhcHBseUJhdGNoID0gW10KICAgIGNvbnN0IGtleSA9IG5vZGUud3JpdGVyLmNvcmUua2V5CgogICAgYXBwbHlCYXRjaC5wdXNoKHsKICAgICAgaW5kZXhlZCwKICAgICAgb3B0aW1pc3RpYzogdHJ1ZSwKICAgICAgZnJvbTogbm9kZS53cml0ZXIuY29yZSwKICAgICAgbGVuZ3RoOiBub2RlLmxlbmd0aCwKICAgICAgdmFsdWU6IG5vZGUudmFsdWUsCiAgICAgIGhlYWRzOiBub2RlLmFjdHVhbEhlYWRzCiAgICB9KQoKICAgIGNvbnN0IHByZSA9IGF3YWl0IHRoaXMuc3lzdGVtLmdldChrZXkpCiAgICBjb25zdCBwcmVMZW5ndGggPSBwcmUgPyBwcmUubGVuZ3RoIDogMAoKICAgIGxldCBmYWlsZWQgPSBmYWxzZQoKICAgIHRoaXMuYXBwbHlpbmcgPSB1CiAgICB0aGlzLmFwcGx5QmF0Y2ggPSBhcHBseUJhdGNoCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLmJhc2UuX2hhbmRsZXJzLmFwcGx5KGFwcGx5QmF0Y2gsIHRoaXMudmlldywgdGhpcy5ob3N0Y2FsbHMpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKHRoaXMuYmFzZS5jbG9zaW5nKSB0aHJvdyBlcnIKICAgICAgZmFpbGVkID0gdHJ1ZQogICAgfQogICAgdGhpcy5fcG9zdEFwcGx5KCkKCiAgICBpZiAoIWZhaWxlZCkgewogICAgICBjb25zdCBwb3N0ID0gYXdhaXQgdGhpcy5zeXN0ZW0uZ2V0KGtleSkKICAgICAgLy8gY2hlY2sgaWYgYWNrZWQgYnkgYWRkV3JpdGVyL3JlbW92ZVdyaXRlci9hY2tXcml0ZXIKICAgICAgaWYgKCFwb3N0IHx8IHByZUxlbmd0aCA9PT0gcG9zdC5sZW5ndGgpIGZhaWxlZCA9IHRydWUKICAgIH0KCiAgICBpZiAoIWZhaWxlZCkgewogICAgICAvLyB0ZWNobmljYWxseSB3ZSBvbmx5IG5lZWQgdG8gdG8gdGhpcyBpcyB0aGUgd3JpdGVyIHdhcyByZW1vdmVkLCBidXQgaGV5LCB0cmlja3kgbG9naWMKICAgICAgYXdhaXQgdGhpcy5fcmVmcmVzaFdyaXRlcnMoKQogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIC8vIGl0IGZhaWxlZCEgcm9sbGJhY2suLi4KCiAgICB0aGlzLnN5c3RlbS5hcHBseUNoZWNrcG9pbnQoY2hlY2twb2ludCkKCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uVmlldy5jb3JlLmxlbmd0aCAhPT0gdGhpcy5zeXN0ZW0uZW5jcnlwdGlvbkxlbmd0aCkgewogICAgICBhd2FpdCB0aGlzLmVuY3J5cHRpb25WaWV3LmNvcmUudHJ1bmNhdGUodGhpcy5zeXN0ZW0uZW5jcnlwdGlvbkxlbmd0aCkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHZpZXcgb2YgdGhpcy52aWV3cykgewogICAgICBjb25zdCB2aWV3TGVuZ3RoID0gdmlldy5jb3JlID8gdmlldy5jb3JlLmxlbmd0aCA6IHZpZXcubGVuZ3RoCiAgICAgIGNvbnN0IHZpZXdMb29rdXAgPSB0aGlzLmdldFZpZXdGcm9tU3lzdGVtKHZpZXcpCiAgICAgIGNvbnN0IHZpZXdTeXN0ZW1MZW5ndGggPSB2aWV3TG9va3VwID8gdmlld0xvb2t1cC5sZW5ndGggOiAwCiAgICAgIGlmICh2aWV3U3lzdGVtTGVuZ3RoID09PSB2aWV3TGVuZ3RoKSBjb250aW51ZQogICAgICBhd2FpdCB2aWV3LmNvcmUudHJ1bmNhdGUodmlld1N5c3RlbUxlbmd0aCkKICAgIH0KCiAgICBhd2FpdCB0aGlzLl9yZWZyZXNoV3JpdGVycygpCgogICAgYXdhaXQgdGhpcy5fcm9sbGJhY2tWaWV3cygpCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF9zdGFydFRyYWNlKG5vZGUpIHsKICAgIHRoaXMuc3lzdGVtUmVmLnRyYWNlci5zdGFydCgpCiAgICB0aGlzLmVuY3J5cHRpb25WaWV3LnJlZi50cmFjZXIuc3RhcnQoKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnZpZXdzLmxlbmd0aDsgaSsrKSB0aGlzLnZpZXdzW2ldLnJlZi50cmFjZXIuc3RhcnQoKQogIH0KCiAgX2VuZFRyYWNlKG5vZGUpIHsKICAgIGNvbnN0IHRyYWNlID0gewogICAgICBzeXN0ZW06IHRoaXMuc3lzdGVtUmVmLnRyYWNlci5lbmQoKSwKICAgICAgZW5jcnlwdGlvbjogdGhpcy5lbmNyeXB0aW9uVmlldy5yZWYudHJhY2VyLmVuZCgpLAogICAgICB1c2VyOiBbXQogICAgfQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy52aWV3cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBibG9ja3MgPSB0aGlzLnZpZXdzW2ldLnJlZi50cmFjZXIuZW5kKCkKICAgICAgaWYgKGJsb2Nrcy5sZW5ndGgpIHRyYWNlLnVzZXIucHVzaCh7IHZpZXc6IGksIGJsb2NrcyB9KQogICAgfQoKICAgIGlmICh0cmFjZS5zeXN0ZW0ubGVuZ3RoIHx8IHRyYWNlLmVuY3J5cHRpb24ubGVuZ3RoIHx8IHRyYWNlLnVzZXIubGVuZ3RoKSBub2RlLnRyYWNlID0gdHJhY2UKICB9CgogIGFzeW5jIHVwZGF0ZSh1LCBsb2NhbE5vZGVzKSB7CiAgICBpZiAodGhpcy5jaGFuZ2VzICE9PSBudWxsKSB0aGlzLmNoYW5nZXMudHJhY2sodGhpcykKCiAgICBsZXQgYmF0Y2ggPSAwCiAgICBsZXQgYXBwbHlCYXRjaCA9IFtdCiAgICBsZXQgaW5kZXhlcnNVcGRhdGVkID0gMAoKICAgIGxldCBqID0gMAogICAgbGV0IGkgPSAwCiAgICBsZXQgZm9ya2VkQXQgPSAtMQoKICAgIHdoaWxlIChpIDwgTWF0aC5taW4odS5pbmRleGVkLmxlbmd0aCwgdS5zaGFyZWQpKSB7CiAgICAgIGNvbnN0IG5vZGUgPSB1LmluZGV4ZWRbaSsrXQoKICAgICAgaWYgKG5vZGUuYmF0Y2ggPiAxKSBjb250aW51ZQogICAgICB0aGlzLmJhc2UuX3NoaWZ0V3JpdGVyKG5vZGUud3JpdGVyKQoKICAgICAgY29uc3QgdXBkYXRlID0gdGhpcy51cGRhdGVzW2orK10KCiAgICAgIGlmICh1cGRhdGUuaW5kZXhlcnMpIHsKICAgICAgICBpbmRleGVyc1VwZGF0ZWQgPSBpCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIGlmICh1LnVuZG8pIGF3YWl0IHRoaXMudW5kbyh1LnVuZG8pCgogICAgaWYgKHRoaXMuc3lzdGVtLmJvb3RzdHJhcHBpbmcpIGF3YWl0IHRoaXMuYm9vdHN0cmFwKCkKCiAgICBhd2FpdCB0aGlzLl91cGRhdGVTeXN0ZW0oKQoKICAgIC8vIE9yZ2FuaXplIGJ5IHZpZXcKICAgIGNvbnN0IHdhcm11cFN5c3RlbVZpZXcgPSBbXQogICAgY29uc3Qgd2FybXVwRW5jcnlwdGlvblZpZXcgPSBbXQogICAgY29uc3Qgd2FybXVwVXNlclZpZXcgPSBuZXcgQXJyYXkodGhpcy52aWV3cy5sZW5ndGgpCgogICAgZm9yIChsZXQgayA9IHUuc2hhcmVkOyBrIDwgdS5sZW5ndGg7IGsrKykgewogICAgICBjb25zdCBpbmRleGVkID0gayA8IHUuaW5kZXhlZC5sZW5ndGgKICAgICAgY29uc3Qgbm9kZSA9IGluZGV4ZWQgPyB1LmluZGV4ZWRba10gOiB1LnRpcFtrIC0gdS5pbmRleGVkLmxlbmd0aF0KICAgICAgaWYgKCFub2RlLnRyYWNlKSBjb250aW51ZQoKICAgICAgaWYgKG5vZGUudHJhY2Uuc3lzdGVtLmxlbmd0aCkgd2FybXVwU3lzdGVtVmlldy5wdXNoKC4uLm5vZGUudHJhY2Uuc3lzdGVtKQogICAgICBpZiAobm9kZS50cmFjZS5lbmNyeXB0aW9uLmxlbmd0aCkgd2FybXVwRW5jcnlwdGlvblZpZXcucHVzaCguLi5ub2RlLnRyYWNlLmVuY3J5cHRpb24pCgogICAgICBmb3IgKGNvbnN0IHRyYWNlIG9mIG5vZGUudHJhY2UudXNlcikgewogICAgICAgIC8vIEFzc2VydCAoYXMgd2FybmluZykgdGhhdCB0cmFjZSB2aWV3IHNob3VsZCBvbmx5IGJlIGN1cnJlbnRseSBpbmRleGVkIHZpZXdzCiAgICAgICAgaWYgKHRyYWNlLnZpZXcgPj0gdGhpcy52aWV3cy5sZW5ndGgpIHsKICAgICAgICAgIGNvbnNvbGUud2FybigKICAgICAgICAgICAgJ09wbG9nIGJsb2NrIHRyYWNlIGNvbnRhaW5zIE9PQiB2aWV3IGluZGV4JywKICAgICAgICAgICAgJ3RyYWNlIHZpZXcnLAogICAgICAgICAgICB0cmFjZS52aWV3LAogICAgICAgICAgICAndmlld3MubGVuZ3RoJywKICAgICAgICAgICAgdGhpcy52aWV3cy5sZW5ndGgKICAgICAgICAgICkKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQoKICAgICAgICB3YXJtdXBVc2VyVmlld1t0cmFjZS52aWV3XSA9IHdhcm11cFVzZXJWaWV3W3RyYWNlLnZpZXddIHx8IFtdCiAgICAgICAgd2FybXVwVXNlclZpZXdbdHJhY2Uudmlld10ucHVzaCguLi50cmFjZS5ibG9ja3MpCiAgICAgIH0KICAgIH0KCiAgICAvLyBSZXF1ZXN0IHBlciB2aWV3CiAgICBpZiAod2FybXVwU3lzdGVtVmlldy5sZW5ndGgpIHRoaXMuc3lzdGVtVmlldy5jb3JlLmRvd25sb2FkKHsgYmxvY2tzOiB3YXJtdXBTeXN0ZW1WaWV3IH0pCiAgICBpZiAod2FybXVwRW5jcnlwdGlvblZpZXcubGVuZ3RoKQogICAgICB0aGlzLmVuY3J5cHRpb25WaWV3LmNvcmUuZG93bmxvYWQoeyBibG9ja3M6IHdhcm11cEVuY3J5cHRpb25WaWV3IH0pCiAgICBmb3IgKGxldCBrID0gMDsgayA8IHdhcm11cFVzZXJWaWV3Lmxlbmd0aDsgaysrKSB7CiAgICAgIGNvbnN0IGJsb2NrcyA9IHdhcm11cFVzZXJWaWV3W2tdCiAgICAgIGlmICghYmxvY2tzKSBjb250aW51ZQoKICAgICAgY29uc3QgdmlldyA9IHRoaXMudmlld3Nba10KICAgICAgdmlldy5jb3JlLmRvd25sb2FkKHsgYmxvY2tzIH0pCiAgICB9CgogICAgZm9yIChpID0gdS5zaGFyZWQ7IGkgPCB1Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0aGlzLmJhc2UuYmFja29mZiAhPT0gbnVsbCAmJiB0aGlzLmJhc2UuYmFja29mZi5iYWNrb2ZmKCkpIGF3YWl0IHRoaXMuYmFzZS5iYWNrb2ZmLndhaXQoKQoKICAgICAgY29uc3QgaW5kZXhlZCA9IGkgPCB1LmluZGV4ZWQubGVuZ3RoCiAgICAgIGNvbnN0IG5vZGUgPSBpbmRleGVkID8gdS5pbmRleGVkW2ldIDogdS50aXBbaSAtIHUuaW5kZXhlZC5sZW5ndGhdCgogICAgICBiYXRjaCsrCgogICAgICBpZiAobm9kZS53cml0ZXIuY29yZS53cml0YWJsZSkgdGhpcy5fc3RhcnRUcmFjZShub2RlKQoKICAgICAgY29uc3Qgb3B0aW1pc3QgPQogICAgICAgIG5vZGUud3JpdGVyLmlzUmVtb3ZlZCAmJgogICAgICAgIG5vZGUub3B0aW1pc3RpYyAmJgogICAgICAgIGJhdGNoID09PSAxICYmCiAgICAgICAgdGhpcy5iYXNlLl9oYXNPcHRpbWlzdGljQXBwbHkgPT09IHRydWUgJiYKICAgICAgICAoYXdhaXQgdGhpcy5fb3B0aW1pc3RpY0FwcGx5KHUsIG5vZGUsIGluZGV4ZWQpKQoKICAgICAgaWYgKCFvcHRpbWlzdCkgewogICAgICAgIGlmIChub2RlLndyaXRlci5pc1JlbW92ZWQgJiYgIW5vZGUud3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgewogICAgICAgICAgaWYgKG5vZGUuYmF0Y2ggPiAxKSBjb250aW51ZQogICAgICAgICAgLy8gaW4gY2FzZSBzb21lb25lIGlzIGxpbmtpbmcgdGhpcyBub2RlIGFuZCB0aGV5IGFyZSBub3QgcmVtb3ZlZAogICAgICAgICAgY29uc3QgdSA9IHsKICAgICAgICAgICAgc2VxOiAwLAogICAgICAgICAgICBrZXk6IG5vZGUud3JpdGVyLmNvcmUua2V5LAogICAgICAgICAgICBsZW5ndGg6IG5vZGUubGVuZ3RoLAogICAgICAgICAgICBiYXRjaCwKICAgICAgICAgICAgc3lzdGVtTGVuZ3RoOiAwLAogICAgICAgICAgICBpbmRleGVyczogZmFsc2UKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX3B1c2hVcGRhdGUodSkKICAgICAgICAgIGJhdGNoID0gMAogICAgICAgICAgYXNzZXJ0KGFwcGx5QmF0Y2gubGVuZ3RoID09PSAwLCAnQXBwbHkgYmF0Y2ggc2hvdWxkIG5vdCBoYXZlIGJlZW4gbW9kaWZpZWQnKQogICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIC8vIGluIHByb2Qgd2UgcHJvcCBuZWVkIHRvIGRpc2FibGUgdGhpcyBhc3NlcnRpb24gYXMgaXRzIHByZXR0eSBleHBlbnNpdmUsCiAgICAgICAgLy8gYnV0IGl0IGNhdGNoZXMgYSBsb3Qgb2YgYnVncywgc28gaGVyZSBmb3IgZGVidWdzCiAgICAgICAgLy8gYXdhaXQgdGhpcy5fYXNzZXJ0Tm9kZShub2RlLCBiYXRjaCkKCiAgICAgICAgY29uc3QgZGVwcyA9IG5vZGUuY2F1c2FsRGVwZW5kZW5jaWVzKCkKCiAgICAgICAgLy8gb2xkZXN0IC0+IG5ld2VzdAogICAgICAgIGZvciAobGV0IGkgPSBkZXBzLmxlbmd0aCAtIDE7IGkgPj0gMTsgaS0tKSB7CiAgICAgICAgICBjb25zdCBkID0gZGVwc1tpXQogICAgICAgICAgaWYgKGF3YWl0IHRoaXMuc3lzdGVtLmxpbmthYmxlKGQud3JpdGVyLmNvcmUua2V5LCBkLmxlbmd0aCkpIHsKICAgICAgICAgICAgdGhpcy5zeXN0ZW0uYWRkSGVhZChkZXBzW2ldKQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5zeXN0ZW0uYWRkSGVhZChkZXBzWzBdKQoKICAgICAgICBpZiAobm9kZS52YWx1ZSAhPT0gbnVsbCAmJiAhbm9kZS53cml0ZXIuaXNSZW1vdmVkKSB7CiAgICAgICAgICBhcHBseUJhdGNoLnB1c2goewogICAgICAgICAgICBpbmRleGVkLAogICAgICAgICAgICBvcHRpbWlzdGljOiBmYWxzZSwKICAgICAgICAgICAgZnJvbTogbm9kZS53cml0ZXIuY29yZSwKICAgICAgICAgICAgbGVuZ3RoOiBub2RlLmxlbmd0aCwKICAgICAgICAgICAgdmFsdWU6IG5vZGUudmFsdWUsCiAgICAgICAgICAgIGhlYWRzOiBub2RlLmFjdHVhbEhlYWRzCiAgICAgICAgICB9KQogICAgICAgIH0KCiAgICAgICAgaWYgKG5vZGUuYmF0Y2ggPiAxKSBjb250aW51ZQoKICAgICAgICBpZiAoYXBwbHlCYXRjaC5sZW5ndGggJiYgdGhpcy5iYXNlLl9oYXNBcHBseSA9PT0gdHJ1ZSkgewogICAgICAgICAgdGhpcy5hcHBseWluZyA9IHUKICAgICAgICAgIHRoaXMuYXBwbHlCYXRjaCA9IGFwcGx5QmF0Y2gKICAgICAgICAgIGF3YWl0IHRoaXMuYmFzZS5faGFuZGxlcnMuYXBwbHkoYXBwbHlCYXRjaCwgdGhpcy52aWV3LCB0aGlzLmhvc3RjYWxscykKICAgICAgICAgIGlmIChmb3JrZWRBdCA9PT0gLTEgJiYgdGhpcy5wZW5kaW5nRm9yaykgZm9ya2VkQXQgPSBpCiAgICAgICAgICB0aGlzLl9wb3N0QXBwbHkoKQogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgdXBkYXRlID0gewogICAgICAgIHNlcTogMCwKICAgICAgICBrZXk6IG5vZGUud3JpdGVyLmNvcmUua2V5LAogICAgICAgIGxlbmd0aDogbm9kZS5sZW5ndGgsCiAgICAgICAgYmF0Y2gsCiAgICAgICAgc3lzdGVtTGVuZ3RoOiAwLAogICAgICAgIGluZGV4ZXJzOiBmYWxzZQogICAgICB9CgogICAgICB1cGRhdGUuaW5kZXhlcnMgPSAhIXRoaXMuc3lzdGVtLmluZGV4ZXJVcGRhdGUKCiAgICAgIGlmICh0aGlzLnN5c3RlbS5pbmRleGVyVXBkYXRlKSBhd2FpdCB0aGlzLl9nZW5lcmF0ZU5leHRWaWV3cygpCgogICAgICBhd2FpdCB0aGlzLnN5c3RlbS5mbHVzaCh0aGlzLnZpZXdzKQogICAgICBhd2FpdCB0aGlzLnN5c3RlbS51cGRhdGUoKQoKICAgICAgaWYgKG5vZGUud3JpdGVyLmNvcmUud3JpdGFibGUpIHRoaXMuX2VuZFRyYWNlKG5vZGUpCgogICAgICBiYXRjaCA9IDAKICAgICAgYXBwbHlCYXRjaCA9IFtdCgogICAgICB0aGlzLl9wdXNoVXBkYXRlKHVwZGF0ZSkKCiAgICAgIGlmICghaW5kZXhlZCB8fCBpbmRleGVyc1VwZGF0ZWQpIGNvbnRpbnVlCgogICAgICB0aGlzLmJhc2UuX3NoaWZ0V3JpdGVyKG5vZGUud3JpdGVyKQoKICAgICAgaWYgKHVwZGF0ZS5pbmRleGVycykgewogICAgICAgIGluZGV4ZXJzVXBkYXRlZCA9IGkgKyAxCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5wZW5kaW5nRm9yaykgewogICAgICBjb25zdCBwZW5kaW5nID0gdGhpcy5wZW5kaW5nRm9yawogICAgICBpZiAocGVuZGluZy5sZW5ndGggPiB0aGlzLmluZGV4ZWRMZW5ndGgpIHRoaXMuX2luZGV4VXBkYXRlcyh1LmluZGV4ZWQubGVuZ3RoKQoKICAgICAgY29uc3QgZm9yayA9IG5ldyBGb3JrKHRoaXMuYmFzZSwgdGhpcy5zdG9yZSwgdGhpcywgcGVuZGluZykKICAgICAgY29uc3QgZm9ya2VkID0gYXdhaXQgZm9yay51cGdyYWRlKCkKCiAgICAgIGlmICghZm9ya2VkKSB0aHJvdyBuZXcgRXJyb3IoJ0ZvcmsgZmFpbGVkJykKCiAgICAgIGF3YWl0IHRoaXMuX2ZsdXNoKGxvY2FsTm9kZXMpCgogICAgICByZXR1cm4gewogICAgICAgIHJlYm9vdDogdHJ1ZSwKICAgICAgICBtaWdyYXRlZDogZmFsc2UKICAgICAgfQogICAgfQoKICAgIGlmICh1LmluZGV4ZWQubGVuZ3RoKSB7CiAgICAgIHRoaXMuX2luZGV4VXBkYXRlcyhpbmRleGVyc1VwZGF0ZWQgfHwgdS5pbmRleGVkLmxlbmd0aCkKICAgIH0KCiAgICBjb25zdCBtaWdyYXRlZCA9IGluZGV4ZXJzVXBkYXRlZCAhPT0gMAogICAgaWYgKG1pZ3JhdGVkKSB0aGlzLmtleSA9IGF3YWl0IHRoaXMuYmFzZS5fcHJlbWlncmF0ZSgpCgogICAgaWYgKHRoaXMuY2hhbmdlcyAhPT0gbnVsbCkgewogICAgICB0aGlzLmNoYW5nZXMuZmluYWxpc2UoKQogICAgICBhd2FpdCB0aGlzLmJhc2UuX2hhbmRsZXJzLnVwZGF0ZSh0aGlzLnZpZXcsIHRoaXMuY2hhbmdlcykKICAgIH0KCiAgICBhd2FpdCB0aGlzLl9mbHVzaChsb2NhbE5vZGVzKQoKICAgIHJldHVybiB7CiAgICAgIHJlYm9vdDogbWlncmF0ZWQsCiAgICAgIG1pZ3JhdGVkCiAgICB9CiAgfQoKICBmbHVzaCgpIHsKICAgIHJldHVybiB0aGlzLl9mbHVzaChudWxsKQogIH0KCiAgYXN5bmMgX2FwcGVuZExvY2FsTm9kZXMobG9jYWxOb2RlcykgewogICAgaWYgKGxvY2FsTm9kZXMubGVuZ3RoID09PSAwKSByZXR1cm4gLy8ganVzdCBpbiBjYXNlCgogICAgY29uc3QgYmxvY2tzID0gbmV3IEFycmF5KGxvY2FsTm9kZXMubGVuZ3RoKQogICAgY29uc3QgbG9jYWwgPSB0aGlzLmxvY2FsCgogICAgaWYgKCFsb2NhbC5vcGVuZWQpIGF3YWl0IGxvY2FsLnJlYWR5KCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJsb2Nrcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB7IHZhbHVlLCBoZWFkcywgYmF0Y2gsIG9wdGltaXN0aWMsIHRyYWNlIH0gPSBsb2NhbE5vZGVzW2ldCgogICAgICBibG9ja3NbaV0gPSB7CiAgICAgICAgdmVyc2lvbjogT1BMT0dfVkVSU0lPTiwKICAgICAgICBtYXhTdXBwb3J0ZWRWZXJzaW9uOiB0aGlzLmJhc2UubWF4U3VwcG9ydGVkVmVyc2lvbiwKICAgICAgICBjaGVja3BvaW50OiBudWxsLAogICAgICAgIGRpZ2VzdDogbnVsbCwKICAgICAgICBvcHRpbWlzdGljLAogICAgICAgIG5vZGU6IHsKICAgICAgICAgIGhlYWRzLAogICAgICAgICAgYmF0Y2gsCiAgICAgICAgICB2YWx1ZTogdmFsdWUgPT09IG51bGwgPyBudWxsIDogYy5lbmNvZGUodGhpcy5iYXNlLnZhbHVlRW5jb2RpbmcsIHZhbHVlKQogICAgICAgIH0sCiAgICAgICAgdHJhY2UKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLmxvY2FsSW5kZXhlcikgewogICAgICBjb25zdCBzaWduZWRMZW5ndGggPSB0aGlzLmxvY2FsQ2hlY2twb2ludC5zaWduZWRMZW5ndGgoKQogICAgICBjb25zdCBsb2NhbCA9IHRoaXMubG9jYWwKCiAgICAgIGxldCBzaWduZWRBdCA9IDAKICAgICAgbGV0IGludGVybmFsU2lnbmF0dXJlcyA9IG51bGwKICAgICAgbGV0IHNpZ25hdHVyZXMgPSBudWxsCgogICAgICBpZiAodGhpcy5pbmRleGVkTGVuZ3RoID4gc2lnbmVkTGVuZ3RoKSB7CiAgICAgICAgY29uc3Qgc3lzID0gYXdhaXQgdGhpcy5zeXN0ZW0uZ2V0SW5kZXhlZEluZm8odGhpcy5pbmRleGVkTGVuZ3RoKQogICAgICAgIGludGVybmFsU2lnbmF0dXJlcyA9IGF3YWl0IHRoaXMuX3NpZ25JbnRlcm5hbFZpZXdDb3JlcyhzeXMpCiAgICAgICAgc2lnbmF0dXJlcyA9IGF3YWl0IHRoaXMuX3NpZ25Vc2VyVmlld0NvcmVzKHN5cykKICAgICAgICBzaWduZWRBdCA9IGxvY2FsLmxlbmd0aCArIGJsb2Nrcy5sZW5ndGgKICAgICAgfQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBibG9ja3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBsZW5ndGggPSBsb2NhbC5sZW5ndGggKyBpICsgMQogICAgICAgIGlmIChsZW5ndGggPT09IHNpZ25lZEF0KSB7CiAgICAgICAgICB0aGlzLmxvY2FsQ2hlY2twb2ludC51cGRhdGVJbnRlcm5hbFNpZ25hdHVyZXMobGVuZ3RoLCBpbnRlcm5hbFNpZ25hdHVyZXMpCiAgICAgICAgICB0aGlzLmxvY2FsQ2hlY2twb2ludC51cGRhdGVVc2VyU2lnbmF0dXJlcyhsZW5ndGgsIHNpZ25hdHVyZXMpCiAgICAgICAgfQoKICAgICAgICBjb25zdCBibGsgPSBibG9ja3NbaV0KCiAgICAgICAgYmxrLmNoZWNrcG9pbnQgPSB0aGlzLmxvY2FsQ2hlY2twb2ludC5tYWtlQ2hlY2twb2ludHMobGVuZ3RoKQogICAgICAgIGJsay5kaWdlc3QgPSB0aGlzLmxvY2FsQ2hlY2twb2ludC5tYWtlRGlnZXN0KGxlbmd0aCwgdGhpcy5rZXkpCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmICghdGhpcy5sb2NhbENoZWNrcG9pbnQpIGF3YWl0IHRoaXMuX3N0YXJ0TG9jYWxDaGVja3BvaW50KCkKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gbG9jYWwubGVuZ3RoICsgaSArIDEKICAgICAgICBibG9ja3NbaV0uZGlnZXN0ID0gdGhpcy5sb2NhbENoZWNrcG9pbnQubWFrZURpZ2VzdChsZW5ndGgsIHRoaXMua2V5KQogICAgICB9CiAgICB9CgogICAgYXdhaXQgbG9jYWwuYXBwZW5kKGJsb2NrcykKICB9CgogIGFzeW5jIF9yb2xsYmFja1ZpZXdzKCkgewogICAgLy8gZW5jcnlwdGlvbiB2aWV3IGtleSBpcyBub3QgaW4gc3lzdGVtIHNvIG5vIG5lZWQgdG8gaGFuZGxlIGhlcmUKICAgIGZvciAoY29uc3QgdmlldyBvZiB0aGlzLnZpZXdzKSB7CiAgICAgIGNvbnN0IHYgPSB0aGlzLmdldFZpZXdGcm9tU3lzdGVtKHZpZXcpCgogICAgICBpZiAodikgewogICAgICAgIHZpZXcua2V5ID0gdi5rZXkKICAgICAgfSBlbHNlIHsKICAgICAgICBhd2FpdCB0aGlzLl9yZXNldFZpZXcodmlldykKICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgY3JlYXRlQW5jaG9yKCkgewogICAgY29uc3Qgbm9kZSA9IHRoaXMuYXBwbHlCYXRjaFt0aGlzLmFwcGx5QmF0Y2gubGVuZ3RoIC0gMV0KICAgIGNvbnN0IGtleSA9IG5vZGUuZnJvbS5rZXkKICAgIGNvbnN0IGxlbmd0aCA9IG5vZGUubGVuZ3RoCgogICAgY29uc3QgaW5mbyA9IGF3YWl0IHRoaXMuc3lzdGVtLmdldChrZXksIHsgdW5mbHVzaGVkOiB0cnVlIH0pCgogICAgaWYgKCFpbmZvIHx8IGluZm8ubGVuZ3RoIDwgbGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ0FuY2hvciBub2RlIGlzIG5vdCBpbiBzeXN0ZW0nKQoKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiA0MCwgYnVmZmVyOiBiNGEuYWxsb2MoNDApIH0KICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIGtleSkKICAgIGMudWludDY0LmVuY29kZShzdGF0ZSwgbGVuZ3RoKQoKICAgIGNvbnN0IG5hbWVzcGFjZSA9IGNyeXB0by5oYXNoKHN0YXRlLmJ1ZmZlcikKICAgIGNvbnN0IG1hbmlmZXN0RGF0YSA9IGMuZW5jb2RlKG1lc3NhZ2VzLk1hbmlmZXN0RGF0YSwgeyB2ZXJzaW9uOiAwLCBsZWdhY3lCbG9ja3M6IDAsIG5hbWVzcGFjZSB9KQoKICAgIGNvbnN0IHBhZGRpbmcgPSB0aGlzLmVuY3J5cHRpb24gPyBBdXRvYmFzZUVuY3J5cHRpb24uUEFERElORyA6IDAKICAgIGNvbnN0IGJsb2NrID0gZW5jb2RlVmFsdWUobnVsbCwgeyBoZWFkczogW3sga2V5LCBsZW5ndGggfV0sIHBhZGRpbmcgfSkKICAgIGlmICh0aGlzLmVuY3J5cHRpb24pIGF3YWl0IHRoaXMuZW5jcnlwdGlvbi5lbmNyeXB0QW5jaG9yKGJsb2NrLCBuYW1lc3BhY2UpCgogICAgY29uc3Qgcm9vdCA9IHsgaW5kZXg6IDAsIHNpemU6IGJsb2NrLmJ5dGVMZW5ndGgsIGhhc2g6IGNyeXB0by5kYXRhKGJsb2NrKSB9CiAgICBjb25zdCBoYXNoID0gY3J5cHRvLnRyZWUoW3Jvb3RdKQogICAgY29uc3QgcHJvbG9ndWUgPSB7IGhhc2gsIGxlbmd0aDogMSB9CgogICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuY3JlYXRlQW5jaG9yQ29yZShwcm9sb2d1ZSwgbWFuaWZlc3REYXRhKQogICAgYXdhaXQgY29yZS5yZWFkeSgpCgogICAgaWYgKGNvcmUubGVuZ3RoID09PSAwKSBhd2FpdCBjb3JlLmFwcGVuZChibG9jaywgeyB3cml0YWJsZTogdHJ1ZSwgbWF4TGVuZ3RoOiAxIH0pCgogICAgYXdhaXQgdGhpcy5zeXN0ZW0uYWRkKGNvcmUua2V5LCB7IGlzSW5kZXhlcjogZmFsc2UsIGxlbmd0aDogMCB9KQogICAgYXdhaXQgdGhpcy5iYXNlLl9hZGRXcml0ZXIoY29yZS5rZXksIHRoaXMuc3lzdGVtKQoKICAgIGNvbnN0IGFuY2hvciA9IHsga2V5OiBjb3JlLmtleSwgbGVuZ3RoOiBjb3JlLmxlbmd0aCB9CgogICAgYXdhaXQgY29yZS5jbG9zZSgpCiAgICBhd2FpdCB0aGlzLmJhc2UuaGludFdha2V1cChhbmNob3IpCgogICAgcmV0dXJuIGFuY2hvcgogIH0KCiAgYXN5bmMgX3Jlc2V0Vmlldyh2aWV3KSB7CiAgICBjb25zdCBtYW5pZmVzdHMgPSBhd2FpdCB0aGlzLnN0b3JlLmdldEluZGV4ZXJNYW5pZmVzdHModGhpcy5zeXN0ZW0uaW5kZXhlcnMpCgogICAgY29uc3QgbWFuaWZlc3REYXRhID0gdmlldy5jb3JlID8gdmlldy5jb3JlLm1hbmlmZXN0LnVzZXJEYXRhIDogbnVsbAogICAgdmlldy5rZXkgPSBhd2FpdCB0aGlzLnN0b3JlLmNyZWF0ZVZpZXcoCiAgICAgIG1hbmlmZXN0cywKICAgICAgdmlldy5uYW1lLAogICAgICBudWxsLAogICAgICB0aGlzLnN5c3RlbS5jb3JlLm1hbmlmZXN0LnZlcnNpb24sCiAgICAgIHRoaXMuc3lzdGVtLmVudHJvcHksCiAgICAgIG51bGwsCiAgICAgIG1hbmlmZXN0RGF0YQogICAgKSAvLyB3aWxsIG5ldmVyIGJlIHN5c3RlbSBzbyBubyBsaW5rZWQKICAgIHZpZXcubGVuZ3RoID0gMAogIH0KCiAgYXN5bmMgX2dlbmVyYXRlTmV4dFZpZXdzKCkgewogICAgY29uc3Qgc3lzID0gdGhpcy5zeXN0ZW0KCiAgICAvLyBub3RlLCB0aGlzIGlzIHZlcnkgc3RhdGUgZGVwZW5kZW50IHNvIGNhbiBPTkxZIGJlIGNhbGxlZCBhdCB0aGUgZXhhY3QgdGltZSBhbiBpbmRleGVyIHVwZ3JhZGUgb2NjdXJzCiAgICBjb25zdCBtYW5pZmVzdHMgPSBhd2FpdCB0aGlzLnN0b3JlLmdldEluZGV4ZXJNYW5pZmVzdHMoc3lzLmluZGV4ZXJzKQogICAgY29uc3QgZW50cm9weSA9IHN5cy52ZXJzaW9uIDwgMiA/IG51bGwgOiBzeXMuZ2V0RW50cm9weShzeXMuaW5kZXhlcnMsIHN5cy5mbHVzaExlbmd0aCgpKQoKICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLnZpZXdzKSB7CiAgICAgIGNvbnN0IG1hbmlmZXN0RGF0YSA9IHYuY29yZSA/IHYuY29yZS5tYW5pZmVzdC51c2VyRGF0YSA6IG51bGwKCiAgICAgIGNvbnN0IHByb2xvZ3VlID0gYXdhaXQgZ2V0UHJvbG9ndWUodikKICAgICAgY29uc3Qga2V5ID0gYXdhaXQgdGhpcy5zdG9yZS5jcmVhdGVWaWV3KAogICAgICAgIG1hbmlmZXN0cywKICAgICAgICB2Lm5hbWUsCiAgICAgICAgcHJvbG9ndWUsCiAgICAgICAgc3lzLmNvcmUubWFuaWZlc3QudmVyc2lvbiwKICAgICAgICBlbnRyb3B5LAogICAgICAgIG51bGwsCiAgICAgICAgbWFuaWZlc3REYXRhCiAgICAgICkKCiAgICAgIHYua2V5ID0ga2V5CiAgICB9CiAgfQp9Cgphc3luYyBmdW5jdGlvbiBnZXRQcm9sb2d1ZSh2aWV3KSB7CiAgY29uc3QgbGVuZ3RoID0gdmlldy5jb3JlID8gdmlldy5jb3JlLmxlbmd0aCA6IHZpZXcubGVuZ3RoCiAgaWYgKCFsZW5ndGgpIHJldHVybiBudWxsCgogIGNvbnN0IGhhc2ggPSBhd2FpdCB2aWV3LmNvcmUudHJlZUhhc2gobGVuZ3RoKQoKICByZXR1cm4gewogICAgaGFzaCwKICAgIGxlbmd0aAogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CgpmdW5jdGlvbiBjbXBDaGVja3BvaW50cyhhLCBiKSB7CiAgcmV0dXJuIGEuc2lnbmVkTGVuZ3RoKCkgLSBiLnNpZ25lZExlbmd0aCgpCn0KCmZ1bmN0aW9uIHNhbWVTaWduYXR1cmUoYSwgYikgewogIGlmICghYSB8fCAhYikgcmV0dXJuIGEgPT09IGIKICByZXR1cm4gYS5sZW5ndGggPT09IGIubGVuZ3RoCn0KCmZ1bmN0aW9uIHNhbWVTaWduYXR1cmVzKGEsIGIpIHsKICBpZiAoIWEgfHwgIWIpIHJldHVybiBhID09PSBiCiAgaWYgKGEubGVuZ3RoICE9PSBiLmxlbmd0aCkgcmV0dXJuIGZhbHNlCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoYVtpXS5sZW5ndGggIT09IGJbaV0ubGVuZ3RoKSByZXR1cm4gZmFsc2UKICB9CiAgcmV0dXJuIHRydWUKfQoKZnVuY3Rpb24gY3JlYXRlQ2hlY2twb2ludFNpZ25hdHVyZShsZW5ndGgsIHZpZXcsIGNoZWNrcG9pbnRzKSB7CiAgcmV0dXJuIHsKICAgIGxlbmd0aCwKICAgIGNvcmU6IHZpZXcuY29yZSwKICAgIHJlZjogdmlldy5yZWYsCiAgICBzaWduYXR1cmVzOiBuZXcgQXJyYXkoY2hlY2twb2ludHMpLAogICAgcGFydGlhbHM6IG5ldyBBcnJheShjaGVja3BvaW50cykKICB9Cn0KCmZ1bmN0aW9uIGFkZENoZWNrcG9pbnRTaWduYXR1cmVzKHBlbmRpbmcsIGNoZWNrcG9pbnRzLCBpbmRleCkgewogIGNvbnN0IHsgc2lnbmVyLCBzaWduYXR1cmVzIH0gPSBjaGVja3BvaW50c1tpbmRleF0KCiAgcGVuZGluZ1swXS5zaWduYXR1cmVzW2luZGV4XSA9IHsKICAgIHNpZ25hdHVyZTogc2lnbmF0dXJlcy5zeXN0ZW0uc2lnbmF0dXJlLAogICAgbGVuZ3RoOiBzaWduYXR1cmVzLnN5c3RlbS5sZW5ndGgsCiAgICBzaWduZXIKICB9CgogIGlmIChwZW5kaW5nWzFdKSB7CiAgICBwZW5kaW5nWzFdLnNpZ25hdHVyZXNbaW5kZXhdID0gewogICAgICBzaWduYXR1cmU6IHNpZ25hdHVyZXMuZW5jcnlwdGlvbi5zaWduYXR1cmUsCiAgICAgIGxlbmd0aDogc2lnbmF0dXJlcy5lbmNyeXB0aW9uLmxlbmd0aCwKICAgICAgc2lnbmVyCiAgICB9CiAgfQoKICBmb3IgKGxldCBpID0gMjsgaSA8IHBlbmRpbmcubGVuZ3RoOyBpKyspIHsKICAgIGlmICghcGVuZGluZ1tpXSkgY29udGludWUKCiAgICBjb25zdCB7IGxlbmd0aCwgc2lnbmF0dXJlIH0gPSBzaWduYXR1cmVzLnVzZXJbaSAtIDJdCgogICAgcGVuZGluZ1tpXS5zaWduYXR1cmVzW2luZGV4XSA9IHsKICAgICAgc2lnbmF0dXJlLAogICAgICBsZW5ndGgsCiAgICAgIHNpZ25lcgogICAgfQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gc2V0UGFydGlhbFNpZ25hdHVyZSh2aWV3LCBpbmRleCkgewogIGNvbnN0IHNpZyA9IHZpZXcuc2lnbmF0dXJlc1tpbmRleF0KICBpZiAoc2lnLmxlbmd0aCA8IHZpZXcubGVuZ3RoICYmIHNpZy5sZW5ndGggPiAwKSBhd2FpdCB2aWV3LmNvcmUuZ2V0KHNpZy5sZW5ndGggLSAxKQoKICB2aWV3LnBhcnRpYWxzW2luZGV4XSA9IGF3YWl0IHBhcnRpYWxTaWduYXR1cmUoCiAgICB2aWV3LmNvcmUsCiAgICBzaWcuc2lnbmVyLAogICAgdmlldy5sZW5ndGgsCiAgICBzaWcubGVuZ3RoLAogICAgc2lnLnNpZ25hdHVyZQogICkKfQoKZnVuY3Rpb24gdXBkYXRlU2lnbmF0dXJlKGxlbmd0aCwgc2lnLCBleGlzdGluZykgewogIHJldHVybiBzaWcgPyB7IHNpZ25hdHVyZTogc2lnLnNpZ25hdHVyZSwgbGVuZ3RoOiBzaWcubGVuZ3RoLCBhdDogbGVuZ3RoIH0gOiBleGlzdGluZwp9CgpmdW5jdGlvbiB1cGRhdGVTaWduYXR1cmVzKGxlbmd0aCwgc2lnbmF0dXJlcywgZXhpc3RpbmcpIHsKICBjb25zdCB1cGRhdGVkID0gbmV3IEFycmF5KHNpZ25hdHVyZXMubGVuZ3RoKQoKICBmb3IgKGxldCBpID0gMDsgaSA8IHVwZGF0ZWQubGVuZ3RoOyBpKyspIHsKICAgIHVwZGF0ZWRbaV0gPSB1cGRhdGVTaWduYXR1cmUobGVuZ3RoLCBzaWduYXR1cmVzW2ldLCBpIDwgZXhpc3RpbmcubGVuZ3RoID8gZXhpc3RpbmdbaV0gOiBudWxsKQogIH0KCiAgcmV0dXJuIHVwZGF0ZWQKfQoKZnVuY3Rpb24gbWFrZUNoZWNrcG9pbnQobGVuZ3RoLCBjaGspIHsKICBpZiAoIWNoaykgcmV0dXJuIG51bGwKCiAgY29uc3QgY2hlY2twb2ludGVyID0gbGVuZ3RoIC0gY2hrLmF0CgogIHJldHVybiB7CiAgICBjaGVja3BvaW50ZXIsCiAgICBjaGVja3BvaW50OiBjaGVja3BvaW50ZXIgPT09IDAgPyB7IHNpZ25hdHVyZTogY2hrLnNpZ25hdHVyZSwgbGVuZ3RoOiBjaGsubGVuZ3RoIH0gOiBudWxsCiAgfQp9CgpmdW5jdGlvbiBtYWtlQ2hlY2twb2ludHMobGVuZ3RoLCBzaWduYXR1cmVzKSB7CiAgaWYgKCFzaWduYXR1cmVzLmxlbmd0aCkgcmV0dXJuIG51bGwKCiAgY29uc3QgY2hlY2twb2ludHMgPSBuZXcgQXJyYXkoc2lnbmF0dXJlcy5sZW5ndGgpCgogIGZvciAobGV0IGkgPSAwOyBpIDwgc2lnbmF0dXJlcy5sZW5ndGg7IGkrKykgewogICAgY2hlY2twb2ludHNbaV0gPSBtYWtlQ2hlY2twb2ludChsZW5ndGgsIHNpZ25hdHVyZXNbaV0pCiAgfQoKICByZXR1cm4gY2hlY2twb2ludHMKfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IG1lc3NhZ2VzID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCgptb2R1bGUuZXhwb3J0cyA9IGFzeW5jIGZ1bmN0aW9uIGJvb3QoCiAgY29yZXN0b3JlLAogIGtleSwKICB7IGVuY3J5cHQsIGVuY3J5cHRpb25LZXksIGtleVBhaXIsIGV4Y2x1c2l2ZSA9IHRydWUgfSA9IHt9CikgewogIGNvbnN0IHJlc3VsdCA9IHsKICAgIGtleTogbnVsbCwKICAgIGxvY2FsOiBudWxsLAogICAgYm9vdHN0cmFwOiBudWxsLAogICAgZW5jcnlwdGlvbktleTogbnVsbCwKICAgIGJvb3Q6IG51bGwKICB9CgogIGNvbnN0IG1hbmlmZXN0ID0ga2V5UGFpcgogICAgPyB7IHZlcnNpb246IGNvcmVzdG9yZS5tYW5pZmVzdFZlcnNpb24sIHNpZ25lcnM6IFt7IHB1YmxpY0tleToga2V5UGFpci5wdWJsaWNLZXkgfV0gfQogICAgOiBudWxsCgogIGlmIChrZXkpIHsKICAgIHJlc3VsdC5rZXkgPSBrZXkKCiAgICBjb25zdCBib290c3RyYXAgPSBjb3Jlc3RvcmUuZ2V0KHsga2V5LCBhY3RpdmU6IGZhbHNlLCB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UgfSkKICAgIGF3YWl0IGJvb3RzdHJhcC5yZWFkeSgpCgogICAgY29uc3QgbG9jYWxLZXkgPSBhd2FpdCBib290c3RyYXAuZ2V0VXNlckRhdGEoJ2F1dG9iYXNlL2xvY2FsJykKCiAgICBpZiAoa2V5UGFpcikgewogICAgICByZXN1bHQubG9jYWwgPSBjb3Jlc3RvcmUuZ2V0KHsKICAgICAgICBrZXlQYWlyLAogICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgZXhjbHVzaXZlLAogICAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZSwKICAgICAgICBtYW5pZmVzdAogICAgICB9KQogICAgfSBlbHNlIHsKICAgICAgaWYgKGJvb3RzdHJhcC53cml0YWJsZSAmJiAhbG9jYWxLZXkpIHsKICAgICAgICByZXN1bHQubG9jYWwgPSBib290c3RyYXAuc2Vzc2lvbih7CiAgICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgICAgZXhjbHVzaXZlLAogICAgICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlCiAgICAgICAgfSkKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBsb2NhbCA9IGxvY2FsS2V5CiAgICAgICAgICA/IGNvcmVzdG9yZS5nZXQoewogICAgICAgICAgICAgIGtleTogbG9jYWxLZXksCiAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICBleGNsdXNpdmUsCiAgICAgICAgICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlCiAgICAgICAgICAgIH0pCiAgICAgICAgICA6IGNvcmVzdG9yZS5nZXQoewogICAgICAgICAgICAgIG5hbWU6ICdsb2NhbCcsCiAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICBleGNsdXNpdmUsCiAgICAgICAgICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlCiAgICAgICAgICAgIH0pCgogICAgICAgIGF3YWl0IGxvY2FsLnJlYWR5KCkKICAgICAgICByZXN1bHQubG9jYWwgPSBsb2NhbAogICAgICB9CiAgICB9CgogICAgcmVzdWx0LmJvb3RzdHJhcCA9IGJvb3RzdHJhcAogIH0gZWxzZSB7CiAgICByZXN1bHQubG9jYWwgPSBrZXlQYWlyCiAgICAgID8gY29yZXN0b3JlLmdldCh7CiAgICAgICAgICBrZXlQYWlyLAogICAgICAgICAgbWFuaWZlc3QsCiAgICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgICAgZXhjbHVzaXZlLAogICAgICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlCiAgICAgICAgfSkKICAgICAgOiBjb3Jlc3RvcmUuZ2V0KHsKICAgICAgICAgIG5hbWU6ICdsb2NhbCcsCiAgICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgICAgZXhjbHVzaXZlLAogICAgICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlCiAgICAgICAgfSkKICAgIGF3YWl0IHJlc3VsdC5sb2NhbC5yZWFkeSgpCgogICAgY29uc3Qga2V5ID0gYXdhaXQgcmVzdWx0LmxvY2FsLmdldFVzZXJEYXRhKCdyZWZlcnJlcicpCiAgICBpZiAoa2V5KSB7CiAgICAgIHJlc3VsdC5rZXkgPSBrZXkKICAgICAgcmVzdWx0LmJvb3RzdHJhcCA9IGNvcmVzdG9yZS5nZXQoeyBrZXksIGFjdGl2ZTogZmFsc2UsIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZSB9KQogICAgICBhd2FpdCByZXN1bHQuYm9vdHN0cmFwLnJlYWR5KCkKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdC5rZXkgPSByZXN1bHQubG9jYWwua2V5CiAgICAgIHJlc3VsdC5ib290c3RyYXAgPSByZXN1bHQubG9jYWwuc2Vzc2lvbih7CiAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UKICAgICAgfSkKICAgICAgYXdhaXQgcmVzdWx0LmJvb3RzdHJhcC5zZXRVc2VyRGF0YSgnYXV0b2Jhc2UvbG9jYWwnLCByZXN1bHQubG9jYWwua2V5KQogICAgfQogIH0KCiAgaWYgKGtleSB8fCBrZXlQYWlyKSB7CiAgICBhd2FpdCByZXN1bHQuYm9vdHN0cmFwLnNldFVzZXJEYXRhKCdyZWZlcnJlcicsIHJlc3VsdC5rZXkpCiAgICBhd2FpdCByZXN1bHQuYm9vdHN0cmFwLnNldFVzZXJEYXRhKCdhdXRvYmFzZS9sb2NhbCcsIHJlc3VsdC5sb2NhbC5rZXkpCiAgICBhd2FpdCByZXN1bHQubG9jYWwuc2V0VXNlckRhdGEoJ3JlZmVycmVyJywgcmVzdWx0LmtleSkKICB9CgogIGNvbnN0IFtlbmNyeXB0aW9uS2V5QnVmZmVyLCBwb2ludGVyXSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgIHJlc3VsdC5sb2NhbC5nZXRVc2VyRGF0YSgnYXV0b2Jhc2UvZW5jcnlwdGlvbicpLAogICAgcmVzdWx0LmxvY2FsLmdldFVzZXJEYXRhKCdhdXRvYmFzZS9ib290JykKICBdKQoKICBpZiAocG9pbnRlcikgewogICAgcmVzdWx0LmJvb3QgPSBjLmRlY29kZShtZXNzYWdlcy5Cb290UmVjb3JkLCBwb2ludGVyKQogIH0KCiAgaWYgKGVuY3J5cHRpb25LZXlCdWZmZXIpIHsKICAgIHJlc3VsdC5lbmNyeXB0aW9uS2V5ID0gZW5jcnlwdGlvbktleUJ1ZmZlcgogIH0KCiAgaWYgKCFyZXN1bHQuZW5jcnlwdGlvbktleSAmJiAoZW5jcnlwdGlvbktleSB8fCBlbmNyeXB0KSkgewogICAgaWYgKCFlbmNyeXB0aW9uS2V5KQogICAgICBlbmNyeXB0aW9uS2V5ID0gKGF3YWl0IGNvcmVzdG9yZS5jcmVhdGVLZXlQYWlyKCdhdXRvYmFzZS9lbmNyeXB0aW9uJykpLnNlY3JldEtleS5zdWJhcnJheSgKICAgICAgICAwLAogICAgICAgIDMyCiAgICAgICkKICAgIGF3YWl0IHJlc3VsdC5ib290c3RyYXAuc2V0VXNlckRhdGEoJ2F1dG9iYXNlL2VuY3J5cHRpb24nLCBlbmNyeXB0aW9uS2V5KSAvLyBsZWdhY3kgc3VwcG9ydAogICAgYXdhaXQgcmVzdWx0LmxvY2FsLnNldFVzZXJEYXRhKCdhdXRvYmFzZS9lbmNyeXB0aW9uJywgZW5jcnlwdGlvbktleSkKICAgIHJlc3VsdC5lbmNyeXB0aW9uS2V5ID0gZW5jcnlwdGlvbktleQogIH0KCiAgcmV0dXJuIHJlc3VsdAp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQoKY29uc3QgT1BMT0dfVkVSU0lPTiA9IDIKY29uc3QgREVGQVVMVF9BVVRPQkFTRV9WRVJTSU9OID0gMSAvLyBkZWZhdWx0CmNvbnN0IE1BWF9BVVRPQkFTRV9WRVJTSU9OID0gMiAvLyBvcHRpb25hbCBmb3JrIHN1cHBvcnQKY29uc3QgQk9PVF9SRUNPUkRfVkVSU0lPTiA9IDMKCmNvbnN0IFtOU19TSUdORVJfTkFNRVNQQUNFLCBOU19WSUVXX0JMT0NLX0tFWSwgTlNfSEFTSF9LRVksIE5TX0VOQ1JZUFRJT05dID0gY3J5cHRvLm5hbWVzcGFjZSgKICAnYXV0b2Jhc2UnLAogIDQKKQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgT1BMT0dfVkVSU0lPTiwKICBERUZBVUxUX0FVVE9CQVNFX1ZFUlNJT04sCiAgTUFYX0FVVE9CQVNFX1ZFUlNJT04sCiAgQk9PVF9SRUNPUkRfVkVSU0lPTiwKICBOU19TSUdORVJfTkFNRVNQQUNFLAogIE5TX1ZJRVdfQkxPQ0tfS0VZLAogIE5TX0hBU0hfS0VZLAogIE5TX0VOQ1JZUFRJT04KfQpjb25zdCBCdWZmZXJNYXAgPSByZXF1aXJlKCd0aW55LWJ1ZmZlci1tYXAnKQoKLy8gVGhpcyBpcyBiYXNpY2FsbHkganVzdCBhIE1hcCBhdG0sIGJ1dCBsZWF2aW5nIGl0IGFzIGFuIGFic3RyYWN0aW9uIGZvciBub3cKLy8gaW4gY2FzZSB3ZSB3YW5uYSBvcHRpbWl6ZSBpdCBmb3Igb3VyIGV4YWN0IHVzZWNhc2UKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ2xvY2sgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5zZWVuID0gbmV3IEJ1ZmZlck1hcCgpCiAgfQoKICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLnNlZW4uc2l6ZQogIH0KCiAgaGFzKGtleSkgewogICAgcmV0dXJuIHRoaXMuc2Vlbi5oYXMoa2V5KQogIH0KCiAgaW5jbHVkZXMoa2V5LCBsZW5ndGgpIHsKICAgIHJldHVybiB0aGlzLnNlZW4uaGFzKGtleSkgJiYgdGhpcy5zZWVuLmdldChrZXkpID49IGxlbmd0aAogIH0KCiAgZ2V0KGtleSkgewogICAgcmV0dXJuIHRoaXMuc2Vlbi5nZXQoa2V5KSB8fCAwCiAgfQoKICBzZXQoa2V5LCBsZW4pIHsKICAgIHRoaXMuc2Vlbi5zZXQoa2V5LCBsZW4pCiAgICByZXR1cm4gbGVuCiAgfQoKICBhZGQoY2xvY2spIHsKICAgIGZvciAoY29uc3QgW2tleSwgbF0gb2YgY2xvY2spIHsKICAgICAgaWYgKHRoaXMuZ2V0KGtleSkgPCBsKSB0aGlzLnNldChrZXksIGwpCiAgICB9CiAgfQoKICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLnNlZW5bU3ltYm9sLml0ZXJhdG9yXSgpCiAgfQp9CmNvbnN0IEJ1ZmZlck1hcCA9IHJlcXVpcmUoJ3RpbnktYnVmZmVyLW1hcCcpCgpjb25zdCBDbG9jayA9IHJlcXVpcmUoJy4vY2xvY2suanMnKQoKY29uc3QgVU5TRUVOID0gMApjb25zdCBORVdFUiA9IDEKY29uc3QgQUNLRUQgPSAyCgovLyBDb25zZW5zdXMgbWFjaGluZSBmb3IgQXV0b2Jhc2UuIFNvcnQgREFHIG5vZGVzIHVzaW5nCi8vIHZlY3RvciBjbG9ja3MgdG8gZGV0ZXJtaW5lIGEgZ2xvYmFsbHkgY29uc2lzdGVudCB2aWV3Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENvbnNlbnN1cyB7CiAgY29uc3RydWN0b3IoaW5kZXhlcnMpIHsKICAgIHRoaXMubWVyZ2VzID0gbmV3IFNldCgpCiAgICB0aGlzLm1ham9yaXR5ID0gKGluZGV4ZXJzLmxlbmd0aCA+Pj4gMSkgKyAxCiAgICB0aGlzLmluZGV4ZXJzID0gaW5kZXhlcnMKICAgIHRoaXMucmVtb3ZlZCA9IG5ldyBDbG9jaygpCiAgICB0aGlzLnVwZGF0ZWQgPSBmYWxzZQoKICAgIHRoaXMud3JpdGVycyA9IG5ldyBCdWZmZXJNYXAoKQogICAgZm9yIChjb25zdCBpZHggb2YgdGhpcy5pbmRleGVycykgewogICAgICB0aGlzLndyaXRlcnMuc2V0KGlkeC5jb3JlLmtleSwgaWR4KQogICAgfQogIH0KCiAgYWRkSGVhZChub2RlKSB7CiAgICBpZiAoIW5vZGUud3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgcmV0dXJuCiAgICBpZiAodGhpcy5faXNNZXJnZShub2RlKSkgdGhpcy5tZXJnZXMuYWRkKG5vZGUpCiAgICB0aGlzLnVwZGF0ZWQgPSB0cnVlCiAgICByZXR1cm4gbm9kZQogIH0KCiAgLyogSW5kZXhlciBPbmx5IERBRyBtZXRob2RzICovCgogIF90YWlscyhub2RlLCB0YWlscykgewogICAgY29uc3QgdGFpbFNldCA9IG5ldyBTZXQoKQogICAgZm9yIChjb25zdCB0IG9mIHRhaWxzKSB7CiAgICAgIGlmIChub2RlLmNsb2NrLmluY2x1ZGVzKHQud3JpdGVyLmNvcmUua2V5LCB0Lmxlbmd0aCkpIHRhaWxTZXQuYWRkKHQpCiAgICB9CgogICAgcmV0dXJuIHRhaWxTZXQKICB9CgogIF90YWlsc0FuZE1lcmdlcyhub2RlLCB0YWlscykgewogICAgY29uc3QgYWxsID0gdGhpcy5fdGFpbHMobm9kZSwgdGFpbHMpCiAgICBmb3IgKGNvbnN0IG0gb2YgdGhpcy5tZXJnZXMpIHsKICAgICAgaWYgKG0gIT09IG5vZGUgJiYgbm9kZS5jbG9jay5pbmNsdWRlcyhtLndyaXRlci5jb3JlLmtleSwgbS5sZW5ndGgpKSB7CiAgICAgICAgYWxsLmFkZChtKQogICAgICB9CiAgICB9CiAgICByZXR1cm4gYWxsCiAgfQoKICBfaXNNZXJnZShub2RlKSB7CiAgICBpZiAoIW5vZGUud3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgZGVwcyA9IFtdCgogICAgZm9yIChjb25zdCBpZHggb2YgdGhpcy5pbmRleGVycykgewogICAgICBsZXQgc2VxID0gbm9kZS5jbG9jay5nZXQoaWR4LmNvcmUua2V5KSAtIDEKCiAgICAgIGlmIChpZHggPT09IG5vZGUud3JpdGVyKSBzZXEtLQoKICAgICAgY29uc3QgaGVhZCA9IGlkeC5nZXQoc2VxKQogICAgICBpZiAoIWhlYWQgfHwgdGhpcy5yZW1vdmVkLmluY2x1ZGVzKGhlYWQud3JpdGVyLmNvcmUua2V5LCBoZWFkLmxlbmd0aCkpIGNvbnRpbnVlCgogICAgICBsZXQgaXNEZXAgPSB0cnVlCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGVwcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGQgPSBkZXBzW2ldCiAgICAgICAgaWYgKGQgPT09IGhlYWQpIGNvbnRpbnVlCgogICAgICAgIGlmIChkLmNsb2NrLmluY2x1ZGVzKGhlYWQud3JpdGVyLmNvcmUua2V5LCBoZWFkLmxlbmd0aCkpIHsKICAgICAgICAgIGlzRGVwID0gZmFsc2UKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQoKICAgICAgICBpZiAoaGVhZC5jbG9jay5pbmNsdWRlcyhkLndyaXRlci5jb3JlLmtleSwgZC5sZW5ndGgpKSB7CiAgICAgICAgICBjb25zdCBwb3BwZWQgPSBkZXBzLnBvcCgpCiAgICAgICAgICBpZiAoZCA9PT0gcG9wcGVkKSBjb250aW51ZQogICAgICAgICAgZGVwc1tpLS1dID0gcG9wcGVkCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNEZXApIGRlcHMucHVzaChoZWFkKQogICAgfQoKICAgIHJldHVybiBkZXBzLmxlbmd0aCA+IDEKICB9CgogIF9pbmRleGVyVGFpbHMoKSB7CiAgICBjb25zdCB0YWlscyA9IG5ldyBTZXQoKQogICAgZm9yIChjb25zdCBpZHggb2YgdGhpcy5pbmRleGVycykgewogICAgICBjb25zdCBsZW5ndGggPSB0aGlzLnJlbW92ZWQuaGFzKGlkeC5jb3JlLmtleSkgPyB0aGlzLnJlbW92ZWQuZ2V0KGlkeC5jb3JlLmtleSkgOiBpZHguaW5kZXhlZAoKICAgICAgY29uc3QgaGVhZCA9IGlkeC5nZXQobGVuZ3RoKQogICAgICBpZiAoIWhlYWQgfHwgdGhpcy5yZW1vdmVkLmluY2x1ZGVzKGhlYWQud3JpdGVyLmNvcmUua2V5LCBoZWFkLmxlbmd0aCkpIGNvbnRpbnVlCgogICAgICBsZXQgaXNUYWlsID0gdHJ1ZQogICAgICBmb3IgKGNvbnN0IHQgb2YgdGFpbHMpIHsKICAgICAgICBpZiAoaGVhZC5jbG9jay5pbmNsdWRlcyh0LndyaXRlci5jb3JlLmtleSwgdC5sZW5ndGgpKSB7CiAgICAgICAgICBpc1RhaWwgPSBmYWxzZQogICAgICAgICAgYnJlYWsKICAgICAgICB9CgogICAgICAgIGlmICh0LmNsb2NrLmluY2x1ZGVzKGhlYWQud3JpdGVyLmNvcmUua2V5LCBoZWFkLmxlbmd0aCkpIHsKICAgICAgICAgIHRhaWxzLmRlbGV0ZSh0KQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGlzVGFpbCkgdGFpbHMuYWRkKGhlYWQpCiAgICB9CgogICAgcmV0dXJuIHRhaWxzCiAgfQoKICAvLyBwYXJlbnQgaXMgbmV3ZXIgaWYgZm9yIGFueSBub2RlIGluIHBhcmVudCdzIHZpZXcsCiAgLy8gZWl0aGVyIG5vZGUgY2FuIHNlZSBvYmplY3Qgb3Igb2JqZWN0IGNhbiBzZWUgbm9kZQogIF9zdHJpY3RseU5ld2VyKG9iamVjdCwgcGFyZW50KSB7CiAgICBpZiAoIXBhcmVudC5jbG9jay5pbmNsdWRlcyhvYmplY3Qud3JpdGVyLmNvcmUua2V5LCBvYmplY3QubGVuZ3RoKSkgcmV0dXJuIGZhbHNlCgogICAgZm9yIChjb25zdCBba2V5LCBsYXRlc3RdIG9mIHBhcmVudC5jbG9jaykgewogICAgICBjb25zdCBvbGRlc3QgPSB0aGlzLnJlbW92ZWQuZ2V0KGtleSkKICAgICAgaWYgKGxhdGVzdCA8PSBvbGRlc3QpIGNvbnRpbnVlIC8vIGNoZWNrIHF1aWNrbHkgaWYgd2UgcmVtb3ZlZCBpdAoKICAgICAgLy8gZ2V0IHRoZSBORVhUIG5vZGUgZnJvbSB0aGUgd3JpdGVyIGZyb20gdGhlIG9iamVjdHMgcG92LCBhZGp1c3QgaWYgaXRzIHJlbW92ZWQKICAgICAgbGV0IGxlbmd0aCA9IG9iamVjdC5jbG9jay5nZXQoa2V5KQogICAgICBpZiAobGVuZ3RoIDw9IG9sZGVzdCkgbGVuZ3RoID0gb2xkZXN0CgogICAgICAvLyBzYW5pdHkgY2hlY2ssIGxpa2VseSBub3QgbmVlZGVkIGFzIHNvbWVvbmUgaGFzIGNoZWNrZWQgdGhpcyBiZWZvcmUsIGJ1dCBpdCdzIGZyZWUKICAgICAgaWYgKGxhdGVzdCA8IGxlbmd0aCkgcmV0dXJuIGZhbHNlCgogICAgICAvLyBpZiB0aGUgc2FtZSwgdGhleSBoYXZlIGJvdGggc2VlbiBpdCwgY29udGludWUKICAgICAgaWYgKGxhdGVzdCA9PT0gbGVuZ3RoKSBjb250aW51ZQoKICAgICAgY29uc3Qgd3JpdGVyID0gdGhpcy53cml0ZXJzLmdldChrZXkpCgogICAgICAvLyBtaWdodCBub3QgYmUgaW4gdGhlIHJlbW92ZWQgc2V0IGJ1dCB0aGUgd3JpdGVyIGNhbiB0ZWxsIHVzIGlmIGl0IHdhcyBpbmRleGVkLi4uCiAgICAgIGNvbnN0IG5leHQgPSB3cml0ZXIgJiYgd3JpdGVyLmdldChsZW5ndGggPj0gd3JpdGVyLmluZGV4ZWQgPyBsZW5ndGggOiB3cml0ZXIuaW5kZXhlZCkKCiAgICAgIC8vIG5vIG5leHQsIGl0cyBiZWVuIGluZGV4ZWQsIGJvdGggc2VlbiBpdAogICAgICBpZiAoIW5leHQpIGNvbnRpbnVlCgogICAgICAvLyBpZiB0aGUgTkVYVCBub2RlIGhhcyBzZWVuIHRoZSBvYmplY3QgaXRzIGZpbmUgLSBuZXdlcgogICAgICBpZiAobmV4dC5jbG9jay5pbmNsdWRlcyhvYmplY3Qud3JpdGVyLmNvcmUua2V5LCBvYmplY3QubGVuZ3RoKSkgY29udGludWUKCiAgICAgIC8vIG90aGVyd2lzZSB0aGUgcGFyZW50IG11c3QgYWxzbyBOT1QgaGF2ZSBzZWVuIHRoZSBuZXh0IG5vZGUKICAgICAgaWYgKGxhdGVzdCA8IG5leHQubGVuZ3RoKSBjb250aW51ZQoKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIF9hY2tzKHRhcmdldCkgewogICAgY29uc3QgYWNrcyA9IHRhcmdldC53cml0ZXIuaXNBY3RpdmVJbmRleGVyID8gW3RhcmdldF0gOiBbXSAvLyBUT0RPOiBjYW4gYmUgY2FjaGVkIG9uIHRoZSB0YXJnZXQgbm9kZSBpbiBmdXR1cmUgKGllIGlmIHdlIGFkZCBvbmUgd2UgZG9udCBoYXZlIHRvIGNoZWNrIGl0IGFnYWluKQoKICAgIGZvciAoY29uc3QgaWR4IG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgaWYgKGlkeCA9PT0gdGFyZ2V0LndyaXRlcikgY29udGludWUKCiAgICAgIGxldCBuZXh0ID0gdGFyZ2V0LmNsb2NrLmdldChpZHguY29yZS5rZXkpCiAgICAgIGlmIChuZXh0IDwgaWR4Lm5vZGVzLm9mZnNldCkgbmV4dCA9IGlkeC5ub2Rlcy5vZmZzZXQKCiAgICAgIGNvbnN0IG5leHRJbmRleE5vZGUgPSBpZHguZ2V0KG5leHQgPj0gaWR4LmluZGV4ZWQgPyBuZXh0IDogaWR4LmluZGV4ZWQpCgogICAgICAvLyBubyBub2RlIC0gbm8gYWNrCiAgICAgIGlmICghbmV4dEluZGV4Tm9kZSkgY29udGludWUKCiAgICAgIC8vIGlmIHRoZSBuZXh0IGluZGV4IG5vZGUgZG9lcyBub3Qgc2VlIHRoZSB0YXJnZXQsIG5vIGFjawogICAgICBpZiAoIW5leHRJbmRleE5vZGUuY2xvY2suaW5jbHVkZXModGFyZ2V0LndyaXRlci5jb3JlLmtleSwgdGFyZ2V0Lmxlbmd0aCkpIGNvbnRpbnVlCgogICAgICAvLyBpZiB0aGUgbmV4dCBpbmRleCBub2RlIGlzIG5vdCBzdHJpY3RseSBuZXdlciwgc2tpcCB0byBhdm9pZCBhbWJpZy4uLgogICAgICBpZiAoIXRoaXMuX3N0cmljdGx5TmV3ZXIodGFyZ2V0LCBuZXh0SW5kZXhOb2RlKSkgY29udGludWUKCiAgICAgIGFja3MucHVzaChuZXh0SW5kZXhOb2RlKQogICAgfQoKICAgIHJldHVybiBhY2tzCiAgfQoKICBhY2tzRnJvbU5vZGUodGFyZ2V0LCB2aWV3KSB7CiAgICBjb25zdCBhY2tzID0gbmV3IFNldCgpCgogICAgaWYgKCF2aWV3IHx8ICF2aWV3LmNsb2NrLmluY2x1ZGVzKHRhcmdldC53cml0ZXIuY29yZS5rZXksIHRhcmdldC5sZW5ndGgpKSByZXR1cm4gYWNrcwoKICAgIGFja3MuYWRkKHZpZXcud3JpdGVyKQoKICAgIGZvciAoY29uc3QgaWR4IG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgaWYgKGlkeCA9PT0gdmlldy53cml0ZXIpIGNvbnRpbnVlCgogICAgICBjb25zdCBsZW5ndGggPSB2aWV3LmNsb2NrLmdldChpZHguY29yZS5rZXkpCiAgICAgIGlmICghbGVuZ3RoKSBjb250aW51ZQoKICAgICAgaWYgKHRhcmdldC5jbG9jay5pbmNsdWRlcyhpZHguY29yZS5rZXksIGxlbmd0aCkpIGNvbnRpbnVlCgogICAgICBjb25zdCBoZWFkID0gaWR4LmdldChsZW5ndGggLSAxKQogICAgICBpZiAoIWhlYWQpIGNvbnRpbnVlCgogICAgICBpZiAoaGVhZC5jbG9jay5pbmNsdWRlcyh0YXJnZXQud3JpdGVyLmNvcmUua2V5LCB0YXJnZXQubGVuZ3RoKSkgewogICAgICAgIGFja3MuYWRkKGlkeCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBhY2tzCiAgfQoKICBfYWNrZWRBdChhY2tzLCBwYXJlbnQpIHsKICAgIGxldCBzZWVuID0gMAogICAgbGV0IG1pc3NpbmcgPSBhY2tzLmxlbmd0aAoKICAgIGZvciAoY29uc3Qgbm9kZSBvZiBhY2tzKSB7CiAgICAgIG1pc3NpbmctLQoKICAgICAgaWYgKCFwYXJlbnQuY2xvY2suaW5jbHVkZXMobm9kZS53cml0ZXIuY29yZS5rZXksIG5vZGUubGVuZ3RoKSkgewogICAgICAgIGlmIChzZWVuICsgbWlzc2luZyA8IHRoaXMubWFqb3JpdHkpIHJldHVybiBmYWxzZQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGlmICgrK3NlZW4gPj0gdGhpcy5tYWpvcml0eSkgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIGNvbmZpcm1zKGluZGV4ZXIsIHRhcmdldCwgYWNrcywgbGVuZ3RoKSB7CiAgICBpZiAoIWxlbmd0aCB8fCB0aGlzLnJlbW92ZWQuZ2V0KGluZGV4ZXIuY29yZS5rZXkpID49IGxlbmd0aCkgcmV0dXJuIFVOU0VFTgogICAgLy8gZGVmIGZlZWxzIGxpa2UgdGhlcmUgaXMgYSBzbWFydGVyIHdheSBvZiBkb2luZyB0aGlzIHBhcnQKICAgIC8vIGllIHdlIGp1c3Qgd2FubmEgZmluZCBhIG5vZGUgZnJvbSB0aGUgaW5kZXhlciB0aGF0IGlzIHN0cmljdGx5IG5ld2VyIHRoYW4gdGFyZ2V0CiAgICAvLyBhbmQgc2VlbnMgYSBtYWogb2YgdGhlIGFja3MgLSB0aGF0cyBpdAoKICAgIGxldCBqdW1wID0gdHJ1ZQogICAgbGV0IG5ld2VyID0gdHJ1ZQoKICAgIGZvciAobGV0IGkgPSBsZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBoZWFkID0gaW5kZXhlci5nZXQoaSkKICAgICAgaWYgKGhlYWQgPT09IG51bGwpIHJldHVybiBVTlNFRU4KCiAgICAgIGxldCBzZWVuID0gMAoKICAgICAgZm9yIChjb25zdCBub2RlIG9mIGFja3MpIHsKICAgICAgICAvLyBpZiAobm9kZS53cml0ZXIgPT09IGluZGV4ZXIpIGNvbnRpbnVlCiAgICAgICAgaWYgKCFoZWFkLmNsb2NrLmluY2x1ZGVzKG5vZGUud3JpdGVyLmNvcmUua2V5LCBub2RlLmxlbmd0aCkpIGNvbnRpbnVlCiAgICAgICAgaWYgKCsrc2VlbiA+PSB0aGlzLm1ham9yaXR5KSBicmVhawogICAgICB9CgogICAgICBpZiAoIW5ld2VyICYmIHNlZW4gPCB0aGlzLm1ham9yaXR5KSB7CiAgICAgICAgYnJlYWsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLl9zdHJpY3RseU5ld2VyKHRhcmdldCwgaGVhZCkpIHsKICAgICAgICAvLyBhbGwgc3RyaWN0bHkgbmV3ZXIgbm9kZXMgYXJlIGNsdXN0ZXJlZCB0b2dldGhlciBzbyBiaXNlY3QgdW50aWwgd2UgZmluZCB0aGUgY2x1c3RlcgogICAgICAgIGlmIChqdW1wKSB7CiAgICAgICAgICBqdW1wID0gZmFsc2UKCiAgICAgICAgICBsZXQgdCA9IGxlbmd0aCAtIDEKICAgICAgICAgIGxldCBiID0gMAoKICAgICAgICAgIHdoaWxlICh0ID4gYikgewogICAgICAgICAgICBjb25zdCBtaWQgPSAodCArIGIpID4+PiAxCiAgICAgICAgICAgIGNvbnN0IG5vZGUgPSBpbmRleGVyLmdldChtaWQpCgogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgbm9kZSA9PT0gbnVsbCB8fAogICAgICAgICAgICAgICFub2RlLmNsb2NrLmluY2x1ZGVzKHRhcmdldC53cml0ZXIuY29yZS5rZXksIHRhcmdldC5sZW5ndGgpIHx8CiAgICAgICAgICAgICAgdGhpcy5fc3RyaWN0bHlOZXdlcih0YXJnZXQsIG5vZGUpCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIGIgPSBtaWQgKyAxCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdCA9IG1pZCAtIDEKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vICsgMiBpbiBjYXNlIHdlIGFyZSBvZmYgYnkgb25lIGFuZCB0aGUgaS0tLiBpdHMgZmluZSwganVzdCBhbiBvcHRpbWlzYXRpb24KICAgICAgICAgIGlmIChiICsgMSA8IGkpIGkgPSBiICsgMgogICAgICAgIH0KCiAgICAgICAgbmV3ZXIgPSBmYWxzZQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0gZWxzZSBpZiAoc2VlbiA8IHRoaXMubWFqb3JpdHkpIHsKICAgICAgICByZXR1cm4gTkVXRVIKICAgICAgfQoKICAgICAgcmV0dXJuIEFDS0VECiAgICB9CgogICAgcmV0dXJuIFVOU0VFTgogIH0KCiAgX2lzQ29uZmlybWVkKHRhcmdldCwgcGFyZW50ID0gbnVsbCkgewogICAgY29uc3QgYWNrcyA9IHRoaXMuX2Fja3ModGFyZ2V0KQogICAgY29uc3QgY29uZnMgPSBuZXcgU2V0KCkKCiAgICBpZiAoYWNrcy5sZW5ndGggPCB0aGlzLm1ham9yaXR5KSByZXR1cm4gZmFsc2UKICAgIGxldCBhbGxOZXdlciA9IHRydWUKCiAgICBmb3IgKGNvbnN0IGluZGV4ZXIgb2YgdGhpcy5pbmRleGVycykgewogICAgICBjb25zdCBsZW5ndGggPSBwYXJlbnQKICAgICAgICA/IHBhcmVudC53cml0ZXIgPT09IGluZGV4ZXIKICAgICAgICAgID8gcGFyZW50Lmxlbmd0aCAtIDEKICAgICAgICAgIDogcGFyZW50LmNsb2NrLmdldChpbmRleGVyLmNvcmUua2V5KQogICAgICAgIDogaW5kZXhlci5sZW5ndGgKCiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuY29uZmlybXMoaW5kZXhlciwgdGFyZ2V0LCBhY2tzLCBsZW5ndGgpCgogICAgICBpZiAocmVzdWx0ID09PSBBQ0tFRCkgewogICAgICAgIGNvbmZzLmFkZChpbmRleGVyKQogICAgICAgIGlmIChjb25mcy5zaXplID49IHRoaXMubWFqb3JpdHkpIHsKICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAocmVzdWx0ID09PSBVTlNFRU4pIGFsbE5ld2VyID0gZmFsc2UKICAgIH0KCiAgICBpZiAocGFyZW50KSByZXR1cm4gdGhpcy5faXNDb25maXJtYWJsZUF0KHRhcmdldCwgcGFyZW50LCBhY2tzLCBjb25mcykKCiAgICByZXR1cm4gYWxsTmV3ZXIKICB9CgogIF9pc0NvbmZpcm1hYmxlQXQodGFyZ2V0LCBwYXJlbnQsIGFja3MsIGNvbmZzKSB7CiAgICBpZiAoIXRoaXMuX2Fja2VkQXQoYWNrcywgcGFyZW50KSkgcmV0dXJuIGZhbHNlCgogICAgbGV0IHBvdGVudGlhbCA9IGNvbmZzLnNpemUKCiAgICBmb3IgKGNvbnN0IGluZGV4ZXIgb2YgdGhpcy5pbmRleGVycykgewogICAgICBpZiAoY29uZnMuaGFzKGluZGV4ZXIpKSBjb250aW51ZQoKICAgICAgY29uc3QgbGVuZ3RoID0gcGFyZW50LmNsb2NrLmdldChpbmRleGVyLmNvcmUua2V5KQogICAgICBjb25zdCBpc1NlZW4gPSB0YXJnZXQuY2xvY2suaW5jbHVkZXMoaW5kZXhlci5jb3JlLmtleSwgbGVuZ3RoKQoKICAgICAgLy8gaWYgdGhlIHRhcmdldCBoYXMgc2VlbiB0aGUgbGF0ZXN0IG5vZGUsIGl0IGNhbiBmcmVlbHkgYmUgdXNlZCB0byBjb25maXJtIHRoZSB0YXJnZXQgbGF0ZXIKICAgICAgLy8gb3RoZXJ3aXNlLCBjaGVjayBpZiBhIG5ld2VyIG5vZGUgaXMgc3RyaWN0bHkgbmV3ZXIuLi4KICAgICAgaWYgKCFpc1NlZW4pIHsKICAgICAgICBjb25zdCBoZWFkID0gaW5kZXhlci5nZXQobGVuZ3RoIC0gMSkKCiAgICAgICAgLy8gdGhlIG5leHQgaW5kZXhlciBoZWFkIEhBUyB0byBiZSBzdHJpY3RseSBuZXdlciAtIG1lYW5pbmcgdGhlIGN1cnJlbnQgb25lIGhhcyB0byBiZSBhbHNvLgogICAgICAgIGlmICgKICAgICAgICAgIGhlYWQgJiYKICAgICAgICAgICF0aGlzLnJlbW92ZWQuaW5jbHVkZXMoaGVhZC53cml0ZXIuY29yZS5rZXksIGhlYWQubGVuZ3RoKSAmJgogICAgICAgICAgIXRoaXMuX3N0cmljdGx5TmV3ZXIodGFyZ2V0LCBoZWFkKQogICAgICAgICkgewogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICgrK3BvdGVudGlhbCA+PSB0aGlzLm1ham9yaXR5KSByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgLy8gdGhpcyBjYW4gZ2V0IGNhbGxlZCBtdWx0aXBsZSB0aW1lcyBmb3Igc2FtZSBub2RlCiAgcmVtb3ZlKG5vZGUpIHsKICAgIHRoaXMubWVyZ2VzLmRlbGV0ZShub2RlKQogICAgdGhpcy5yZW1vdmVkLnNldChub2RlLndyaXRlci5jb3JlLmtleSwgbm9kZS5sZW5ndGgpCiAgICByZXR1cm4gbm9kZQogIH0KCiAgc2hpZnQoKSB7CiAgICBpZiAoIXRoaXMudXBkYXRlZCkgcmV0dXJuIFtdCgogICAgY29uc3QgdGFpbHMgPSB0aGlzLl9pbmRleGVyVGFpbHMoKQoKICAgIGZvciAoY29uc3QgdGFpbCBvZiB0YWlscykgewogICAgICBpZiAodGhpcy5faXNDb25maXJtZWQodGFpbCkpIHsKICAgICAgICByZXR1cm4gW3RoaXMucmVtb3ZlKHRhaWwpXQogICAgICB9CiAgICB9CgogICAgZm9yIChjb25zdCBtZXJnZSBvZiB0aGlzLm1lcmdlcykgewogICAgICBpZiAodGhpcy5faXNDb25maXJtZWQobWVyZ2UpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3lpZWxkTmV4dChtZXJnZSwgdGFpbHMpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnVwZGF0ZWQgPSBmYWxzZQogICAgcmV0dXJuIFtdCiAgfQoKICAvLyB5aWVsZHMgbmV4dCBpbmRleGVyIG5vZGUKICBfeWllbGROZXh0KG5vZGUsIHRhaWxzKSB7CiAgICAvLyBvbmx5IHN0b3Agd2hlbiB3ZSBmaW5kIGEgdGFpbAogICAgd2hpbGUgKCF0YWlscy5oYXMobm9kZSkpIHsKICAgICAgbGV0IG5leHQgPSBudWxsCgogICAgICAvLyBmb3IgbWVyZ2VzIGNoZWNrIGlmIG9uZSBmb3JrIGlzIGNvbmZpcm1lZAogICAgICBmb3IgKGNvbnN0IHQgb2YgdGhpcy5fdGFpbHNBbmRNZXJnZXMobm9kZSwgdGFpbHMpKSB7CiAgICAgICAgaWYgKHRoaXMuX2lzQ29uZmlybWVkKHQsIG5vZGUpKSB7CiAgICAgICAgICBuZXh0ID0gdAogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgbm9kZSA9IG5leHQKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICAvLyBvdGhlcndpc2UgeWllbGQgYWxsIHRhaWxzCiAgICAgIGNvbnN0IHRhaWxTZXQgPSBbXQogICAgICBmb3IgKGNvbnN0IHQgb2YgdGhpcy5fdGFpbHMobm9kZSwgdGFpbHMpKSB7CiAgICAgICAgdGFpbFNldC5wdXNoKHRoaXMucmVtb3ZlKHQpKQogICAgICB9CgogICAgICByZXR1cm4gdGFpbFNldAogICAgfQoKICAgIHJldHVybiBbdGhpcy5yZW1vdmUobm9kZSldCiAgfQoKICBzaG91bGRBY2sod3JpdGVyKSB7CiAgICBmb3IgKGNvbnN0IHQgb2YgdGhpcy5faW5kZXhlclRhaWxzKCkpIHsKICAgICAgaWYgKHQud3JpdGVyID09PSB3cml0ZXIpIGNvbnRpbnVlCiAgICAgIGlmICh0aGlzLl9zaG91bGRBY2tOb2RlKHQsIHdyaXRlcikpIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBfc2hvdWxkQWNrTm9kZSh0YXJnZXQsIHdyaXRlcikgewogICAgY29uc3QgaGVhZCA9IHdyaXRlci5oZWFkKCkKICAgIGNvbnN0IG5leHQgPSB0YXJnZXQuY2xvY2suZ2V0KHdyaXRlci5jb3JlLmtleSkKICAgIGNvbnN0IG5leHRJbmRleE5vZGUgPSB3cml0ZXIuZ2V0KG5leHQgPj0gd3JpdGVyLmluZGV4ZWQgPyBuZXh0IDogd3JpdGVyLmluZGV4ZWQpCgogICAgLy8gaWYgd2UgaGF2ZSBubyBuZXh0IG5vZGUgYW5kIHdlIGRpZG4ndCB3cml0ZSB0YXJnZXQgdGhlbiBhY2sKICAgIGlmICghbmV4dEluZGV4Tm9kZSAmJiB3cml0ZXIgIT09IHRhcmdldC53cml0ZXIpIHJldHVybiB0cnVlCgogICAgLy8gc2hvcnRjdXRzIGlmIHdlIGhhdmUgbmV4dCBub2RlCiAgICBpZiAobmV4dEluZGV4Tm9kZSkgewogICAgICAvLyBpZiB0aGUgbmV4dCBub2RlIGRvZXMgbm90IHNlZSB0aGUgdGFyZ2V0LCBzaG91bGQgYWNrCiAgICAgIGlmICghbmV4dEluZGV4Tm9kZS5jbG9jay5pbmNsdWRlcyh0YXJnZXQud3JpdGVyLmNvcmUua2V5LCB0YXJnZXQubGVuZ3RoKSkgewogICAgICAgIHJldHVybiAhaGVhZC5jbG9jay5pbmNsdWRlcyh0YXJnZXQud3JpdGVyLmNvcmUua2V5LCB0YXJnZXQubGVuZ3RoKQogICAgICB9CgogICAgICAvLyBpZiB0aGUgbmV4dCBub2RlIGlzIG5vdCBzdHJpY3RseSBuZXdlciwgbm8gcG9pbnQgYWNraW5nCiAgICAgIGlmICghdGhpcy5fc3RyaWN0bHlOZXdlcih0YXJnZXQsIG5leHRJbmRleE5vZGUpKSByZXR1cm4gZmFsc2UKICAgIH0KCiAgICAvLyBub3cgY2hlY2sgaWYgd2UgY2FuIGRvdWJsZSBjb25maXJtCiAgICBjb25zdCBhY2tzID0gdGhpcy5fYWNrcyh0YXJnZXQpCgogICAgLy8gbmVlZCBlbm91Z2ggdG8gZG91YmxlIGNvbmZpcm0KICAgIGlmIChhY2tzLmxlbmd0aCA+PSB0aGlzLm1ham9yaXR5KSB7CiAgICAgIHJldHVybiB0aGlzLmNvbmZpcm1zKHdyaXRlciwgdGFyZ2V0LCBhY2tzLCB3cml0ZXIubGVuZ3RoKSA9PT0gVU5TRUVOCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQp9CmNvbnN0IEh5cGVyY29yZUVuY3J5cHRpb24gPSByZXF1aXJlKCdoeXBlcmNvcmUvbGliL2RlZmF1bHQtZW5jcnlwdGlvbi5qcycpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBycnAgPSByZXF1aXJlKCdyZXNvbHZlLXJlamVjdC1wcm9taXNlJykKY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKCmNvbnN0IFN5c3RlbVZpZXcgPSByZXF1aXJlKCcuL3N5c3RlbS5qcycpCmNvbnN0IHsgRW5jcnlwdGlvbkRlc2NyaXB0b3IsIE1hbmlmZXN0RGF0YSB9ID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCmNvbnN0IHsgTlNfVklFV19CTE9DS19LRVksIE5TX0hBU0hfS0VZLCBOU19FTkNSWVBUSU9OIH0gPSByZXF1aXJlKCcuL2NhcHMuanMnKQoKY29uc3Qgbm9uY2UgPSBiNGEuYWxsb2Moc29kaXVtLmNyeXB0b19zdHJlYW1fTk9OQ0VCWVRFUykKY29uc3QgaGFzaCA9IG5vbmNlLnN1YmFycmF5KDAsIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfQllURVNfTUlOKQoKY2xhc3MgQXV0b2Jhc2VFbmNyeXB0aW9uIHsKICBzdGF0aWMgUEFERElORyA9IDgKCiAgY29uc3RydWN0b3IoZW5jcnlwdGlvbikgewogICAgdGhpcy5lbmNyeXB0aW9uID0gZW5jcnlwdGlvbgoKICAgIHRoaXMuY29tcGF0ID0gbnVsbAogICAgdGhpcy5rZXlzID0gbnVsbAogICAgdGhpcy5rZXlzQnlJZCA9IG5ldyBNYXAoKQogIH0KCiAgZ2V0IGlkKCkgewogICAgcmV0dXJuIHRoaXMua2V5cyA/IHRoaXMua2V5cy5pZCA6IDAKICB9CgogIHBhZGRpbmcoKSB7CiAgICByZXR1cm4gQXV0b2Jhc2VFbmNyeXB0aW9uLlBBRERJTkcKICB9CgogIGlzQ29tcGF0KCkgewogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBsb2FkKGtleXMpIHsKICAgIGlmICh0aGlzLmtleXMgPT09IG51bGwpIHRoaXMua2V5cyA9IGtleXMKICB9CgogIGFzeW5jIHVwZGF0ZShjdHgpIHsKICAgIGlmICh0aGlzLmlkICE9PSAwICYmIHRoaXMuaWQgPT09IHRoaXMuZW5jcnlwdGlvbi5pZCkgcmV0dXJuCiAgICBjb25zdCBrZXlzID0gYXdhaXQgdGhpcy5nZXQodGhpcy5lbmNyeXB0aW9uLmlkLCBjdHgpCiAgICBpZiAoa2V5cykgdGhpcy5rZXlzID0ga2V5cwogIH0KCiAgYXN5bmMgZ2V0KGlkLCBjdHgpIHsKICAgIGlmICh0aGlzLmtleXNCeUlkLmhhcyhpZCkpIHJldHVybiB0aGlzLmtleXNCeUlkLmdldChpZCkKCiAgICBjb25zdCBrZXlzID0gYXdhaXQgdGhpcy5nZXRLZXlzKGlkLCBjdHgpCiAgICB0aGlzLmtleXNCeUlkLnNldChpZCwga2V5cykKCiAgICByZXR1cm4ga2V5cwogIH0KCiAgYXN5bmMgZ2V0S2V5cyhpZCwgY3R4KSB7CiAgICBjb25zdCBlbnRyb3B5ID0gYXdhaXQgdGhpcy5lbmNyeXB0aW9uLmdldChpZCkKICAgIGlmICghZW50cm9weSkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBibG9jayA9IHRoaXMuYmxvY2tLZXkoZW50cm9weSwgY3R4KQogICAgY29uc3QgaGFzaCA9IGNyeXB0by5oYXNoKFtOU19IQVNIX0tFWSwgYmxvY2tdKQoKICAgIHJldHVybiB7CiAgICAgIGlkLAogICAgICBibG9jaywKICAgICAgaGFzaAogICAgfQogIH0KCiAgYmxvY2tLZXkoZW50cm9weSwgY3R4KSB7CiAgICByZXR1cm4gdGhpcy5lbmNyeXB0aW9uLmJsb2NrS2V5KGVudHJvcHksIGN0eCkKICB9CgogIGFzeW5jIF9lbnN1cmVDb21wYXQoY3R4KSB7CiAgICBpZiAoIXRoaXMuY29tcGF0KSB0aGlzLmNvbXBhdCA9IHRoaXMuY29tcGF0S2V5cyhjdHgpCiAgfQoKICBjb21wYXRLZXlzKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdDb21wYXRhYmlsaXR5IG1ldGhvZCBpcyBub3Qgc3BlY2lmaWVkJykKICB9CgogIGFzeW5jIGVuY3J5cHQoaW5kZXgsIGJsb2NrLCBmb3JrLCBjdHgpIHsKICAgIGlmICh0aGlzLmlzQ29tcGF0KGN0eCwgaW5kZXgpKSB7CiAgICAgIHRoaXMuX2Vuc3VyZUNvbXBhdChjdHgpCiAgICAgIHJldHVybiBIeXBlcmNvcmVFbmNyeXB0aW9uLmVuY3J5cHQoCiAgICAgICAgaW5kZXgsCiAgICAgICAgYmxvY2ssCiAgICAgICAgZm9yaywKICAgICAgICB0aGlzLmNvbXBhdC5ibG9jaywKICAgICAgICB0aGlzLmNvbXBhdC5ibGluZGluZwogICAgICApCiAgICB9CgogICAgYXdhaXQgdGhpcy51cGRhdGUoY3R4KQoKICAgIGVuY3J5cHRCbG9jayhpbmRleCwgYmxvY2ssIHRoaXMua2V5cy5pZCwgdGhpcy5rZXlzLmJsb2NrLCB0aGlzLmtleXMuaGFzaCkKICB9CgogIGFzeW5jIGRlY3J5cHQoaW5kZXgsIGJsb2NrLCBjdHgpIHsKICAgIGlmICh0aGlzLmlzQ29tcGF0KGN0eCwgaW5kZXgpKSB7CiAgICAgIHRoaXMuX2Vuc3VyZUNvbXBhdChjdHgpCiAgICAgIHJldHVybiBIeXBlcmNvcmVFbmNyeXB0aW9uLmRlY3J5cHQoaW5kZXgsIGJsb2NrLCB0aGlzLmNvbXBhdC5ibG9jaykKICAgIH0KCiAgICBjb25zdCBwYWRkaW5nID0gYmxvY2suc3ViYXJyYXkoMCwgQXV0b2Jhc2VFbmNyeXB0aW9uLlBBRERJTkcpCiAgICBibG9jayA9IGJsb2NrLnN1YmFycmF5KEF1dG9iYXNlRW5jcnlwdGlvbi5QQURESU5HKQoKICAgIGNvbnN0IHR5cGUgPSBwYWRkaW5nWzBdCiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHJldHVybiBibG9jayAvLyB1bmVuY3J5cHRlZAoKICAgICAgY2FzZSAxOgogICAgICAgIGJyZWFrCgogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5yZWNvZ25pc2VkIGVuY3J5cHRpb24gdHlwZScpCiAgICB9CgogICAgY29uc3QgaWQgPSBjLnVpbnQzMi5kZWNvZGUoeyBzdGFydDogNCwgZW5kOiA4LCBidWZmZXI6IHBhZGRpbmcgfSkKCiAgICBjb25zdCBrZXlzID0gYXdhaXQgdGhpcy5nZXQoaWQsIGN0eCkKCiAgICBjLnVpbnQ2NC5lbmNvZGUoeyBzdGFydDogMCwgZW5kOiA4LCBidWZmZXI6IG5vbmNlIH0sIGluZGV4KQogICAgbm9uY2Uuc2V0KHBhZGRpbmcsIDgsIDE2KQoKICAgIC8vIERlY3J5cHQgdGhlIGJsb2NrIHVzaW5nIHRoZSBmdWxsIG5vbmNlCiAgICBkZWNyeXB0KGJsb2NrLCBub25jZSwga2V5cy5ibG9jaykKICB9Cn0KCmNsYXNzIFZpZXdFbmNyeXB0aW9uIGV4dGVuZHMgQXV0b2Jhc2VFbmNyeXB0aW9uIHsKICBjb25zdHJ1Y3RvcihlbmNyeXB0aW9uLCBuYW1lKSB7CiAgICBzdXBlcihlbmNyeXB0aW9uKQogICAgdGhpcy5uYW1lID0gbmFtZQogIH0KCiAgaXNDb21wYXQoY3R4LCBpbmRleCkgewogICAgaWYgKGN0eC5tYW5pZmVzdC52ZXJzaW9uIDw9IDEpIHJldHVybiB0cnVlCiAgICBpZiAoIWN0eC5tYW5pZmVzdC51c2VyRGF0YSkgcmV0dXJuIGZhbHNlCiAgICBjb25zdCB7IGxlZ2FjeUJsb2NrcyB9ID0gYy5kZWNvZGUoTWFuaWZlc3REYXRhLCBjdHgubWFuaWZlc3QudXNlckRhdGEpCiAgICByZXR1cm4gaW5kZXggPCBsZWdhY3lCbG9ja3MKICB9CgogIGNvbXBhdEtleXMoKSB7CiAgICBjb25zdCB7IGJvb3RzdHJhcCwgZW5jcnlwdGlvbktleSB9ID0gdGhpcy5lbmNyeXB0aW9uLmJhc2UKICAgIGNvbnN0IGJsb2NrID0gZ2V0Q29tcGF0QmxvY2tLZXkoYm9vdHN0cmFwLCBlbmNyeXB0aW9uS2V5LCB0aGlzLm5hbWUpCiAgICByZXR1cm4gewogICAgICBibG9jaywKICAgICAgYmxpbmRpbmc6IGNyeXB0by5oYXNoKGJsb2NrKQogICAgfQogIH0KCiAgYmxvY2tLZXkoZW50cm9weSkgewogICAgcmV0dXJuIGdldENvbXBhdEJsb2NrS2V5KHRoaXMuZW5jcnlwdGlvbi5iYXNlLmJvb3RzdHJhcCwgZW50cm9weSwgdGhpcy5uYW1lKQogIH0KfQoKY2xhc3MgV3JpdGVyRW5jcnlwdGlvbiBleHRlbmRzIEF1dG9iYXNlRW5jcnlwdGlvbiB7CiAgaXNDb21wYXQoY3R4KSB7CiAgICByZXR1cm4gY3R4Lm1hbmlmZXN0LnZlcnNpb24gPD0gMQogIH0KCiAgY29tcGF0S2V5cyhjdHgpIHsKICAgIHJldHVybiBIeXBlcmNvcmVFbmNyeXB0aW9uLmRlcml2ZUtleXModGhpcy5lbmNyeXB0aW9uLmJhc2UuZW5jcnlwdGlvbktleSwgY3R4LmtleSkKICB9CgogIGJsb2NrS2V5KGVudHJvcHksIGN0eCkgewogICAgaWYgKGN0eC5tYW5pZmVzdC51c2VyRGF0YSkgewogICAgICBjb25zdCB1c2VyRGF0YSA9IGMuZGVjb2RlKE1hbmlmZXN0RGF0YSwgY3R4Lm1hbmlmZXN0LnVzZXJEYXRhKQogICAgICBpZiAodXNlckRhdGEubmFtZXNwYWNlICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZW5jcnlwdGlvbi5ibG9ja0tleShlbnRyb3B5LCB7IGtleTogdXNlckRhdGEubmFtZXNwYWNlIH0pCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGhpcy5lbmNyeXB0aW9uLmJsb2NrS2V5KGVudHJvcHksIGN0eCkKICB9Cn0KCmNsYXNzIEVuY3J5cHRpb25WaWV3IGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IoYmFzZSwgY29yZSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuYmFzZSA9IGJhc2UKICAgIHRoaXMuY29yZSA9IGNvcmUgfHwgbnVsbAoKICAgIHRoaXMuc2Vzc2lvbnMgPSBuZXcgTWFwKCkKCiAgICB0aGlzLl9pbml0aWFsaXNpbmcgPSBudWxsCiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIGF3YWl0IHRoaXMuaW5pdGlhbGlzZWQoKQogICAgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKICB9CgogIGluaXRpYWxpc2VkKCkgewogICAgaWYgKHRoaXMuY29yZSAhPT0gbnVsbCkgcmV0dXJuIHRoaXMuY29yZS5yZWFkeSgpCiAgICBpZiAodGhpcy5faW5pdGlhbGlzaW5nKSByZXR1cm4gdGhpcy5faW5pdGlhbGlzaW5nCgogICAgdGhpcy5faW5pdGlhbGlzaW5nID0gcnJwKCkKCiAgICByZXR1cm4gdGhpcy5faW5pdGlhbGlzaW5nLnByb21pc2UKICB9CgogIF9jbG9zZSgpIHsKICAgIGlmICh0aGlzLl9pbml0aWFsaXNpbmcpIHsKICAgICAgdGhpcy5faW5pdGlhbGlzaW5nLnJlamVjdChuZXcgRXJyb3IoJ0VuY3J5cHRpb24gY2xvc2VkJykpCiAgICAgIHRoaXMuX2luaXRpYWxpc2luZyA9IG51bGwKICAgIH0KCiAgICBpZiAodGhpcy5jb3JlKSByZXR1cm4gdGhpcy5jb3JlLmNsb3NlKCkKICB9CgogIGdldCBib290c3RyYXBwZWQoKSB7CiAgICByZXR1cm4gISEodGhpcy5jb3JlICYmIHRoaXMuY29yZS5sZW5ndGggPiAwKQogIH0KCiAgZ2V0IGlkKCkgewogICAgcmV0dXJuIHRoaXMuY29yZSA/IHRoaXMuY29yZS5sZW5ndGggOiAwCiAgfQoKICBfY3JlYXRlUGF5bG9hZChrZXkpIHsKICAgIHJldHVybiBrZXkKICB9CgogIGFzeW5jIHJlbG9hZChjb3JlKSB7CiAgICBpZiAodGhpcy5jb3JlKSBhd2FpdCB0aGlzLmNvcmUuY2xvc2UoKQoKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCgogICAgaWYgKHRoaXMuX2luaXRpYWxpc2luZykgewogICAgICB0aGlzLl9pbml0aWFsaXNpbmcucmVzb2x2ZSgpCiAgICAgIHRoaXMuX2luaXRpYWxpc2luZyA9IG51bGwKICAgIH0KICB9CgogIHVucGFjayh0eXBlLCBwYXlsb2FkKSB7CiAgICBpZiAodHlwZSA+IDApIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbicpCiAgICByZXR1cm4gcGF5bG9hZAogIH0KCiAgYXN5bmMgdXBkYXRlKGtleSkgewogICAgY29uc3QgcGF5bG9hZCA9IGF3YWl0IHRoaXMuX2NyZWF0ZVBheWxvYWQoa2V5KQogICAgY29uc3QgZGVzYyA9IHsgdHlwZTogMCwgcGF5bG9hZCB9CgogICAgYXdhaXQgdGhpcy5jb3JlLmFwcGVuZChjLmVuY29kZShFbmNyeXB0aW9uRGVzY3JpcHRvciwgZGVzYykpCiAgfQoKICBhc3luYyBfcHJlbG9hZCgpIHsKICAgIGF3YWl0IHRoaXMucmVhZHkoKQogICAgcmV0dXJuIHRoaXMuaWQoKQogIH0KCiAgZ2V0Vmlld0VuY3J5cHRpb24obmFtZSkgewogICAgaWYgKHRoaXMuc2Vzc2lvbnMuaGFzKG5hbWUpKSByZXR1cm4gdGhpcy5zZXNzaW9ucy5nZXQobmFtZSkKCiAgICBjb25zdCBlbmNyeXB0aW9uID0gbmV3IFZpZXdFbmNyeXB0aW9uKHRoaXMsIG5hbWUpCiAgICB0aGlzLnNlc3Npb25zLnNldChuYW1lLCBlbmNyeXB0aW9uKQoKICAgIHJldHVybiBlbmNyeXB0aW9uCiAgfQoKICBnZXRXcml0ZXJFbmNyeXB0aW9uKCkgewogICAgcmV0dXJuIG5ldyBXcml0ZXJFbmNyeXB0aW9uKHRoaXMpCiAgfQoKICBhc3luYyBlbmNyeXB0QW5jaG9yKGJsb2NrLCBuYW1lc3BhY2UpIHsKICAgIGNvbnN0IGVudHJvcHkgPSBhd2FpdCB0aGlzLmdldCh0aGlzLmlkKQogICAgaWYgKCFlbnRyb3B5KSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IGJsb2NrS2V5ID0gdGhpcy5ibG9ja0tleShlbnRyb3B5LCB7IGtleTogbmFtZXNwYWNlIH0pCiAgICBjb25zdCBoYXNoS2V5ID0gY3J5cHRvLmhhc2goW05TX0hBU0hfS0VZLCBibG9ja10pCgogICAgZW5jcnlwdEJsb2NrKDAsIGJsb2NrLCB0aGlzLmlkLCBibG9ja0tleSwgaGFzaEtleSkKICB9CgogIGJsb2NrS2V5KGVudHJvcHksIGN0eCkgewogICAgcmV0dXJuIGdldEJsb2NrS2V5KHRoaXMuYmFzZS5ib290c3RyYXAsIHRoaXMuYmFzZS5lbmNyeXB0aW9uS2V5LCBlbnRyb3B5LCBjdHgua2V5KQogIH0KCiAgYXN5bmMgZ2V0KGVuY3J5cHRpb25JZCkgewogICAgaWYgKGVuY3J5cHRpb25JZCA9PT0gMCkgcmV0dXJuIFN5c3RlbVZpZXcuR0VORVNJU19FTlRST1BZCgogICAgaWYgKCF0aGlzLmNvcmUpIGF3YWl0IHRoaXMuaW5pdGlhbGlzZWQoKQoKICAgIGNvbnN0IGluZGV4ID0gZW5jcnlwdGlvbklkIC0gMQogICAgY29uc3QgZGVzYyA9IGF3YWl0IHRoaXMuY29yZS5nZXQoaW5kZXgpCiAgICBjb25zdCB7IHR5cGUsIHBheWxvYWQgfSA9IGMuZGVjb2RlKEVuY3J5cHRpb25EZXNjcmlwdG9yLCBkZXNjKQoKICAgIGNvbnN0IGtleSA9IHRoaXMudW5wYWNrKHR5cGUsIHBheWxvYWQpCiAgICByZXR1cm4ga2V5CiAgfQoKICBnZXRTeXN0ZW1FbmNyeXB0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Vmlld0VuY3J5cHRpb24oJ19zeXN0ZW0nKQogIH0KCiAgc3RhdGljIG5hbWVzcGFjZShlbnRyb3B5KSB7CiAgICByZXR1cm4gY3J5cHRvLmhhc2goW05TX0VOQ1JZUFRJT04sIGVudHJvcHldKQogIH0KCiAgc3RhdGljIGdldEJsb2NrS2V5KGJvb3RzdHJhcCwgZW5jcnlwdGlvbktleSwgZW50cm9weSwgaHlwZXJjb3JlS2V5KSB7CiAgICByZXR1cm4gZ2V0QmxvY2tLZXkoYm9vdHN0cmFwLCBlbmNyeXB0aW9uS2V5LCBlbnRyb3B5LCBoeXBlcmNvcmVLZXkpCiAgfQoKICBzdGF0aWMgZ2V0U3lzdGVtRW5jcnlwdGlvbihiYXNlLCBjb3JlKSB7CiAgICBjb25zdCB2aWV3ID0gbmV3IEVuY3J5cHRpb25WaWV3KGJhc2UsIGNvcmUpCiAgICByZXR1cm4gdmlldy5nZXRTeXN0ZW1FbmNyeXB0aW9uKCkKICB9CgogIHN0YXRpYyBhc3luYyBzZXRTeXN0ZW1FbmNyeXB0aW9uKGJhc2UsIGNvcmUsIG9wdHMpIHsKICAgIGlmIChiYXNlLmVuY3J5cHRpb25LZXkgPT09IG51bGwpIHJldHVybiBudWxsCgogICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICBpZiAoY29yZS5tYW5pZmVzdC52ZXJzaW9uID09PSAxKSB7CiAgICAgIGNvbnN0IGtleSA9IGdldENvbXBhdEJsb2NrS2V5KGJhc2UuYm9vdHN0cmFwLCBiYXNlLmVuY3J5cHRpb25LZXksICdfc3lzdGVtJykKICAgICAgcmV0dXJuIGNvcmUuc2V0RW5jcnlwdGlvbktleShrZXksIHsgYmxvY2s6IHRydWUgfSkKICAgIH0KCiAgICBpZiAoIWNvcmUubWFuaWZlc3QubGlua2VkLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ1N5c3RlbSBtYW5pZmVzdCBkb2VzIG5vdCBsaW5rIGVuY3J5cHRpb24gdmlldycpCiAgICB9CgogICAgY29uc3QgZW5jID0gYmFzZS5zdG9yZS5nZXQoeyBrZXk6IGNvcmUubWFuaWZlc3QubGlua2VkWzBdLCBhY3RpdmU6IGZhbHNlIH0pCiAgICBjb25zdCBlbmNyeXB0aW9uID0gRW5jcnlwdGlvblZpZXcuZ2V0U3lzdGVtRW5jcnlwdGlvbihiYXNlLCBlbmMpCgogICAgYXdhaXQgY29yZS5zZXRFbmNyeXB0aW9uKGVuY3J5cHRpb24sIG9wdHMpCgogICAgcmV0dXJuIGVuYwogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgQXV0b2Jhc2VFbmNyeXB0aW9uLAogIEVuY3J5cHRpb25WaWV3Cn0KCmZ1bmN0aW9uIGVuY3J5cHQoYmxvY2ssIG5vbmNlLCBrZXkpIHsKICBzb2RpdW0uY3J5cHRvX3N0cmVhbV94b3IoYmxvY2ssIGJsb2NrLCBub25jZSwga2V5KQp9CgpmdW5jdGlvbiBkZWNyeXB0KGJsb2NrLCBub25jZSwga2V5KSB7CiAgcmV0dXJuIGVuY3J5cHQoYmxvY2ssIG5vbmNlLCBrZXkpIC8vIHN5bW1ldHJpYwp9CgpmdW5jdGlvbiBnZXRCbG9ja0tleShib290c3RyYXAsIGVuY3J5cHRpb25LZXksIGVudHJvcHksIGh5cGVyY29yZUtleSkgewogIHJldHVybiAoCiAgICBlbmNyeXB0aW9uS2V5ICYmCiAgICBjcnlwdG8uaGFzaChbTlNfVklFV19CTE9DS19LRVksIGJvb3RzdHJhcCwgZW5jcnlwdGlvbktleSwgZW50cm9weSwgaHlwZXJjb3JlS2V5XSkKICApCn0KCmZ1bmN0aW9uIGdldENvbXBhdEJsb2NrS2V5KGJvb3RzdHJhcCwgZW5jcnlwdGlvbktleSwgbmFtZSkgewogIGlmICh0eXBlb2YgbmFtZSA9PT0gJ3N0cmluZycpIHJldHVybiBnZXRDb21wYXRCbG9ja0tleShib290c3RyYXAsIGVuY3J5cHRpb25LZXksIGI0YS5mcm9tKG5hbWUpKQogIHJldHVybiBlbmNyeXB0aW9uS2V5ICYmIGNyeXB0by5oYXNoKFtOU19WSUVXX0JMT0NLX0tFWSwgYm9vdHN0cmFwLCBlbmNyeXB0aW9uS2V5LCBuYW1lXSkKfQoKZnVuY3Rpb24gYmxvY2toYXNoKGJsb2NrLCBwYWRkaW5nLCBoYXNoS2V5KSB7CiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChoYXNoLCBibG9jaywgaGFzaEtleSkKICBwYWRkaW5nLnNldChoYXNoLnN1YmFycmF5KDAsIDgpKSAvLyBjb3B5IGZpcnN0IDggYnl0ZXMgb2YgaGFzaAogIGhhc2guZmlsbCgwKSAvLyBjbGVhciBub25jZSBidWZmZXIKfQoKZnVuY3Rpb24gZW5jcnlwdEJsb2NrKGluZGV4LCBibG9jaywgaWQsIGJsb2NrS2V5LCBoYXNoS2V5KSB7CiAgY29uc3QgcGFkZGluZyA9IGJsb2NrLnN1YmFycmF5KDAsIEF1dG9iYXNlRW5jcnlwdGlvbi5QQURESU5HKQogIGJsb2NrID0gYmxvY2suc3ViYXJyYXkoQXV0b2Jhc2VFbmNyeXB0aW9uLlBBRERJTkcpCgogIGJsb2NraGFzaChibG9jaywgcGFkZGluZywgaGFzaEtleSkKICBjLnVpbnQzMi5lbmNvZGUoeyBzdGFydDogNCwgZW5kOiA4LCBidWZmZXI6IHBhZGRpbmcgfSwgaWQpCgogIGMudWludDY0LmVuY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IDgsIGJ1ZmZlcjogbm9uY2UgfSwgaW5kZXgpCgogIHBhZGRpbmdbMF0gPSAxIC8vIHZlcnNpb24gaW4gcGxhaW50ZXh0CgogIG5vbmNlLnNldChwYWRkaW5nLCA4LCAxNikKCiAgLy8gVGhlIGNvbWJpbmF0aW9uIG9mIGluZGV4LCBrZXkgaWQsIGZvcmsgaWQgYW5kIGJsb2NrIGhhc2ggaXMgdmVyeSBsaWtlbHkKICAvLyB0byBiZSB1bmlxdWUgZm9yIGEgZ2l2ZW4gSHlwZXJjb3JlIGFuZCB0aGVyZWZvcmUgb3VyIG5vbmNlIGlzIHN1aXRhYmxlCiAgZW5jcnlwdChibG9jaywgbm9uY2UsIGJsb2NrS2V5KQp9CmNvbnN0IHJycCA9IHJlcXVpcmUoJ3Jlc29sdmUtcmVqZWN0LXByb21pc2UnKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCgpjb25zdCBTeXN0ZW1WaWV3ID0gcmVxdWlyZSgnLi9zeXN0ZW0uanMnKQpjb25zdCB7IEVuY3J5cHRpb25WaWV3IH0gPSByZXF1aXJlKCcuL2VuY3J5cHRpb24uanMnKQoKY29uc3QgREVGQVVMVF9PUF9USU1FT1VUID0gNV8wMDAKY29uc3QgREVGQVVMVF9NSU5fRkYgPSAxNgoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBGYXN0Rm9yd2FyZCB7CiAgY29uc3RydWN0b3IoCiAgICBiYXNlLAogICAga2V5LAogICAgewogICAgICB0aW1lb3V0ID0gREVGQVVMVF9PUF9USU1FT1VULAogICAgICB2ZXJpZmllZCA9IHRydWUsCiAgICAgIG1pbmltdW0gPSBERUZBVUxUX01JTl9GRiwKICAgICAgZm9yY2UgPSBmYWxzZSwKICAgICAgbGVuZ3RoID0gMAogICAgfSA9IHt9CiAgKSB7CiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy50aW1lb3V0ID0gdGltZW91dAogICAgdGhpcy5mb3JjZSA9IGZvcmNlCiAgICB0aGlzLmNvcmUgPSBiYXNlLnN0b3JlLmdldCh7IGtleSwgYWN0aXZlOiB0cnVlLCBlbmNyeXB0aW9uOiBudWxsIH0pCiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aAogICAgdGhpcy52aWV3cyA9IFtdCiAgICB0aGlzLmVuY3J5cHRpb24gPSBudWxsCiAgICB0aGlzLmVudHJvcHkgPSBudWxsCiAgICB0aGlzLmluZGV4ZXJzID0gW10KICAgIHRoaXMubWluaW11bSA9IG1pbmltdW0KICAgIHRoaXMudmVyaWZpZWQgPSB2ZXJpZmllZAogICAgdGhpcy53YWl0aW5nID0gbmV3IFNldCgpCiAgICB0aGlzLmNvcmVzID0gW3RoaXMuY29yZV0KICAgIHRoaXMuc3lzdGVtID0gbnVsbAogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy51cGdyYWRpbmcgPSBudWxsCiAgICB0aGlzLmZhaWxlZCA9IGZhbHNlCiAgfQoKICBzdGF0aWMgTUlOSU1VTSA9IERFRkFVTFRfTUlOX0ZGCgogIGFzeW5jIHVwZ3JhZGUoKSB7CiAgICB0cnkgewogICAgICBpZiAoIXRoaXMudXBncmFkaW5nKSB0aGlzLnVwZ3JhZGluZyA9IHRoaXMuX3VwZ3JhZGUoKQoKICAgICAgaWYgKCEoYXdhaXQgdGhpcy51cGdyYWRpbmcpKSByZXR1cm4gbnVsbAoKICAgICAgcmV0dXJuIHsKICAgICAgICBsZW5ndGg6IHRoaXMubGVuZ3RoLAogICAgICAgIGZvcmNlOiB0aGlzLmZvcmNlLAogICAgICAgIGtleTogdGhpcy5rZXksCiAgICAgICAgaW5kZXhlcnM6IHRoaXMuaW5kZXhlcnMsCiAgICAgICAgdmlld3M6IHRoaXMudmlld3MsCiAgICAgICAgZW50cm9weTogdGhpcy5lbnRyb3B5LAogICAgICAgIG1hbmlmZXN0VmVyc2lvbjogdGhpcy5jb3JlLm1hbmlmZXN0LnZlcnNpb24sCiAgICAgICAgbWluaW11bTogdGhpcy5taW5pbXVtCiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgIHRoaXMuZmFpbGVkID0gdHJ1ZQogICAgICByZXR1cm4gbnVsbAogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgdGhpcy5jbG9zZSgpCiAgICB9CiAgfQoKICBfd2FpdEZvckFwcGVuZChjb3JlKSB7CiAgICBpZiAoY29yZS5sZW5ndGggPiAwKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKCiAgICBjb25zdCBwcm9taXNlID0gcnJwKCkKICAgIGNvbnN0IHRpbWVvdXQgPSBzZXRUaW1lb3V0KHRoaXMuY2xvc2UuYmluZCh0aGlzKSwgdGhpcy50aW1lb3V0KQogICAgY29uc3Qgd2FpdCA9IHsgcHJvbWlzZSwgdGltZW91dCB9CgogICAgdGhpcy53YWl0aW5nLmFkZCh3YWl0KQoKICAgIGNvcmUub25jZSgnYXBwZW5kJywgKCkgPT4gewogICAgICB0aGlzLndhaXRpbmcuZGVsZXRlKHdhaXQpCiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KQogICAgICBwcm9taXNlLnJlc29sdmUoKQogICAgfSkKCiAgICByZXR1cm4gcHJvbWlzZS5wcm9taXNlCiAgfQoKICBfbWluTGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuYmFzZS5jb3JlLmxlbmd0aCArIHRoaXMubWluaW11bQogIH0KCiAgYXN5bmMgX3VwZ3JhZGUoKSB7CiAgICBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQoKICAgIGlmICghdGhpcy52ZXJpZmllZCkgYXdhaXQgdGhpcy5fd2FpdEZvckFwcGVuZCh0aGlzLmNvcmUpCiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybiBmYWxzZQoKICAgIGlmICh0aGlzLmNvcmUubWFuaWZlc3QubGlua2VkKSB7CiAgICAgIGNvbnN0IGFwcGVuZHMgPSBbXQoKICAgICAgZm9yIChjb25zdCBrZXkgb2YgdGhpcy5jb3JlLm1hbmlmZXN0LmxpbmtlZCkgewogICAgICAgIGNvbnN0IGNvcmUgPSB0aGlzLmJhc2Uuc3RvcmUuZ2V0KHsga2V5LCBhY3RpdmU6IHRydWUgfSkKICAgICAgICB0aGlzLmNvcmVzLnB1c2goY29yZSkKCiAgICAgICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICAgICAgYXBwZW5kcy5wdXNoKHRoaXMuX3dhaXRGb3JBcHBlbmQoY29yZSkpCiAgICAgIH0KCiAgICAgIGF3YWl0IFByb21pc2UuYWxsKGFwcGVuZHMpCiAgICB9CgogICAgaWYgKHRoaXMubGVuZ3RoID09PSAwKSB0aGlzLmxlbmd0aCA9IHRoaXMuY29yZS5sZW5ndGgKCiAgICAvLyBub3RlIHdlIHVzZSB0aGUgcGVyc2lzdGVkIGxlbmd0aCBoZXJlLCBhcyB3ZSBtaWdodCBhcyB3ZWxsIGNvbnRpbnVlIHRoYXQgd29yayBhcyB0aGF0cyB+IHRoZSBzYW1lIGxlbmd0aAogICAgaWYgKCF0aGlzLmZvcmNlICYmIHRoaXMubGVuZ3RoIDwgdGhpcy5fbWluTGVuZ3RoKCkpIHJldHVybiBmYWxzZQogICAgaWYgKHRoaXMubGVuZ3RoID09PSAwKSByZXR1cm4gZmFsc2UKCiAgICBhd2FpdCB0aGlzLmNvcmUuZ2V0KHRoaXMubGVuZ3RoIC0gMSwgeyB0aW1lb3V0OiB0aGlzLnRpbWVvdXQgfSkKICAgIGF3YWl0IHRoaXMuYmFzZS5yZWFkeSgpCgogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4gZmFsc2UKCiAgICBpZiAodGhpcy5iYXNlLmVuY3J5cHRpb25LZXkgJiYgIShhd2FpdCB0aGlzLl9lbnN1cmVFbmNyeXB0aW9uKCkpKSByZXR1cm4gZmFsc2UKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuIGZhbHNlCgogICAgdGhpcy5zeXN0ZW0gPSBuZXcgU3lzdGVtVmlldyh0aGlzLmNvcmUsIHsgY2hlY2tvdXQ6IHRoaXMubGVuZ3RoIH0pCiAgICBhd2FpdCB0aGlzLnN5c3RlbS5yZWFkeSgpCiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybiBmYWxzZQoKICAgIHRoaXMuZW50cm9weSA9IHRoaXMuc3lzdGVtLmVudHJvcHkKCiAgICBpZiAodGhpcy5jb3JlLm1hbmlmZXN0LnZlcnNpb24gPj0gMikgewogICAgICBjb25zdCBsaW5rZWQgPSB0aGlzLmNvcmUubWFuaWZlc3QubGlua2VkCgogICAgICBpZiAodGhpcy5zeXN0ZW0uZW5jcnlwdGlvbkxlbmd0aCA9PT0gMCB8fCBsaW5rZWQgPT09IG51bGwgfHwgIWxpbmtlZC5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQoKICAgICAgLy8gdGVjaG5pY2FsbHkgZGl2ZXJnZXMgZnJvbSBzeXN0ZW0udmlld3MgdG8gaW5jbHVkZSBlbmNyeXB0aW9uIGhlcmUsIGJ1dCBtYWtlcyBzZW5zZQogICAgICB0aGlzLnZpZXdzLnB1c2goewogICAgICAgIGtleTogbGlua2VkWzBdLAogICAgICAgIGxlbmd0aDogdGhpcy5zeXN0ZW0uZW5jcnlwdGlvbkxlbmd0aAogICAgICB9KQogICAgfQoKICAgIGNvbnN0IHByb21pc2VzID0gW10KCiAgICAvLyBlbnN1cmUgbG9jYWwga2V5IGlzIGxvY2FsbHkgYXZhaWxhYmxlIGFsd2F5cwogICAgcHJvbWlzZXMucHVzaCh0aGlzLnN5c3RlbS5nZXQodGhpcy5iYXNlLmxvY2FsLmtleSwgeyB0aW1lb3V0OiB0aGlzLnRpbWVvdXQgfSkpCgogICAgaWYgKHRoaXMuZW5jcnlwdGlvbiAmJiB0aGlzLmVuY3J5cHRpb24uY29yZSkgewogICAgICBwcm9taXNlcy5wdXNoKAogICAgICAgIHRoaXMuZW5jcnlwdGlvbi5jb3JlLmdldCh0aGlzLnN5c3RlbS5lbmNyeXB0aW9uTGVuZ3RoIC0gMSwgeyB0aW1lb3V0OiB0aGlzLnRpbWVvdXQgfSkKICAgICAgKQogICAgfQoKICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLnN5c3RlbS52aWV3cykgewogICAgICB0aGlzLnZpZXdzLnB1c2godikKICAgICAgY29uc3QgY29yZSA9IHRoaXMuYmFzZS5zdG9yZS5nZXQoeyBrZXk6IHYua2V5LCBhY3RpdmU6IHRydWUgfSkKICAgICAgdGhpcy5jb3Jlcy5wdXNoKGNvcmUpCiAgICAgIGlmICghdi5sZW5ndGgpIGNvbnRpbnVlIC8vIGVuY3J5cHRpb24gdmlldyBjYW4gYmUgMCBsZW5ndGgKICAgICAgcHJvbWlzZXMucHVzaChjb3JlLmdldCh2Lmxlbmd0aCAtIDEsIHsgdGltZW91dDogdGhpcy50aW1lb3V0IH0pKQogICAgfQoKICAgIGZvciAoY29uc3QgaWR4IG9mIHRoaXMuc3lzdGVtLmluZGV4ZXJzKSB7CiAgICAgIHRoaXMuaW5kZXhlcnMucHVzaChpZHgpCiAgICAgIGlmIChpZHgubGVuZ3RoID09PSAwKSBjb250aW51ZSAvLyBuZWVkIHRvIG1ha2Ugc3VyZSB3ZSBoYXZlIG1hbmlmZXN0Li4uCiAgICAgIGNvbnN0IGNvcmUgPSB0aGlzLmJhc2Uuc3RvcmUuZ2V0KHsga2V5OiBpZHgua2V5LCBhY3RpdmU6IHRydWUgfSkKICAgICAgdGhpcy5jb3Jlcy5wdXNoKGNvcmUpCiAgICAgIHByb21pc2VzLnB1c2goY29yZS5nZXQoaWR4Lmxlbmd0aCAtIDEsIHsgdGltZW91dDogdGhpcy50aW1lb3V0IH0pKQogICAgICBwcm9taXNlcy5wdXNoKHRoaXMuc3lzdGVtLmdldChpZHgua2V5LCB7IHRpbWVvdXQ6IHRoaXMudGltZW91dCB9KSkKICAgIH0KCiAgICBmb3IgKGNvbnN0IGhlYWQgb2YgdGhpcy5zeXN0ZW0uaGVhZHMpIHsKICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLnN5c3RlbS5nZXQoaGVhZC5rZXksIHsgdGltZW91dDogdGhpcy50aW1lb3V0IH0pKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKQogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4gZmFsc2UKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgX2Vuc3VyZUVuY3J5cHRpb24oKSB7CiAgICAvLyBvbmx5IG5lZWQgZW5jcnlwdGlvbiBpZiB3ZSBtaWdyYXRlZAogICAgaWYgKHRoaXMuY29yZS5lbmNyeXB0aW9uICE9PSBudWxsKSByZXR1cm4gdHJ1ZQoKICAgIGNvbnN0IGVuY0NvcmUgPSB0aGlzLmNvcmUubWFuaWZlc3QudmVyc2lvbiA8PSAxID8gbnVsbCA6IHRoaXMuY29yZXNbMV0KCiAgICAvLyBleHBlY3RzIGludGVybmFsIHZpZXdzIHRvIGJlIGxvYWRlZCBpbiBvcmRlcgogICAgdGhpcy5lbmNyeXB0aW9uID0gbmV3IEVuY3J5cHRpb25WaWV3KHRoaXMuYmFzZSwgZW5jQ29yZSkKICAgIGNvbnN0IGVuY3J5cHRpb24gPSB0aGlzLmVuY3J5cHRpb24uZ2V0Vmlld0VuY3J5cHRpb24oJ19zeXN0ZW0nKQoKICAgIGF3YWl0IHRoaXMuY29yZS5zZXRFbmNyeXB0aW9uKGVuY3J5cHRpb24pCgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIGNsb3NlKCkgewogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCiAgICBmb3IgKGNvbnN0IHsgcHJvbWlzZSwgdGltZW91dCB9IG9mIHRoaXMud2FpdGluZykgewogICAgICBjbGVhclRpbWVvdXQodGltZW91dCkKICAgICAgcHJvbWlzZS5yZXNvbHZlKCkgLy8gc2lsZW50bHkgYmFpbAogICAgfQogICAgaWYgKHRoaXMuc3lzdGVtKSBhd2FpdCB0aGlzLnN5c3RlbS5jbG9zZSgpCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uKSBhd2FpdCB0aGlzLmVuY3J5cHRpb24uY2xvc2UoKQogICAgZm9yIChjb25zdCBjb3JlIG9mIHRoaXMuY29yZXMpIGF3YWl0IGNvcmUuY2xvc2UoKQogICAgYXdhaXQgdGhpcy5jb3JlLmNsb3NlKCkKICB9Cn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQoKY29uc3QgU3lzdGVtVmlldyA9IHJlcXVpcmUoJy4vc3lzdGVtLmpzJykKY29uc3QgeyBFbmNyeXB0aW9uVmlldyB9ID0gcmVxdWlyZSgnLi9lbmNyeXB0aW9uLmpzJykKY29uc3QgeyBNYW5pZmVzdERhdGEgfSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMuanMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBGb3JrIHsKICBjb25zdHJ1Y3RvcihiYXNlLCBzdG9yZSwgc3RhdGUsIGZvcmspIHsKICAgIHRoaXMuYmFzZSA9IGJhc2UKICAgIHRoaXMuc3RvcmUgPSBzdG9yZQogICAgdGhpcy5zdGF0ZSA9IHN0YXRlCiAgICB0aGlzLmluZGV4ZXJzID0gZm9yay5pbmRleGVycwogICAgdGhpcy5sZW5ndGggPSBmb3JrLmxlbmd0aAogICAgdGhpcy5zeXN0ZW0gPSBudWxsCiAgICB0aGlzLmVuY3J5cHRpb24gPSBudWxsCiAgICB0aGlzLm1hbmlmZXN0cyA9IG51bGwKICAgIHRoaXMuY29yZXMgPSBbXQogIH0KCiAgYXN5bmMgdXBncmFkZSgpIHsKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX3VwZ3JhZGUoKQogICAgICByZXR1cm4gdHJ1ZQogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgdGhpcy5jbG9zZSgpCiAgICB9CiAgfQoKICBhc3luYyBfdXBncmFkZSgpIHsKICAgIHRoaXMubWFuaWZlc3RzID0gYXdhaXQgdGhpcy5zdG9yZS5nZXRJbmRleGVyTWFuaWZlc3RzKHRoaXMuaW5kZXhlcnMpCgogICAgdGhpcy5zeXN0ZW0gPSBuZXcgU3lzdGVtVmlldyhhd2FpdCB0aGlzLl9nZXQoJ19zeXN0ZW0nLCB0aGlzLmxlbmd0aCkpCiAgICB0aGlzLmVuY3J5cHRpb24gPSBuZXcgRW5jcnlwdGlvblZpZXcodGhpcywgYXdhaXQgdGhpcy5fZ2V0KCdfZW5jcnlwdGlvbicsIC0xKSkKCiAgICBhd2FpdCB0aGlzLnN5c3RlbS5yZWFkeSgpCiAgICBhd2FpdCB0aGlzLmVuY3J5cHRpb24ucmVhZHkoKQoKICAgIHRoaXMuZW50cm9weSA9IHRoaXMuc3lzdGVtLmdldEVudHJvcHkodGhpcy5pbmRleGVycywgdGhpcy5sZW5ndGgpCiAgICB0aGlzLm1hbmlmZXN0VmVyc2lvbiA9IE1hdGgubWF4KHRoaXMuc3lzdGVtLmNvcmUubWFuaWZlc3QudmVyc2lvbiwgMikgLy8gPj0gMiB0byBzaWduYWwgbmV3IGVuY3J5cHRpb24KCiAgICBjb25zdCB2aWV3cyA9IFtdCiAgICBmb3IgKGNvbnN0IHZpZXcgb2YgdGhpcy5zdGF0ZS52aWV3cykgewogICAgICBjb25zdCB2ID0gdGhpcy5nZXRWaWV3RnJvbVN5c3RlbSh2aWV3LCB0aGlzLnN5c3RlbSkKICAgICAgY29uc3QgaW5kZXhlZExlbmd0aCA9IHYgPyB2Lmxlbmd0aCA6IDAKCiAgICAgIGNvbnN0IHNlc3Npb24gPSBhd2FpdCB0aGlzLl9nZXQodmlldy5uYW1lLCBpbmRleGVkTGVuZ3RoKQogICAgICBhd2FpdCBzZXNzaW9uLnJlYWR5KCkKCiAgICAgIGNvbnN0IG5leHQgPSBhd2FpdCB0aGlzLmNyZWF0ZVZpZXcodmlldy5uYW1lLCBzZXNzaW9uLCBudWxsKQogICAgICBhd2FpdCBuZXh0LnJlYWR5KCkKCiAgICAgIGF3YWl0IHRoaXMuX21pZ3JhdGUodmlldy5yZWYsIG5leHQsIHZpZXcuY29yZSwgaW5kZXhlZExlbmd0aCkKCiAgICAgIC8vIHVwZGF0ZSBrZXkKICAgICAgdmlld3MucHVzaCh7IGtleTogbmV4dC5rZXksIGxlbmd0aDogaW5kZXhlZExlbmd0aCB9KQogICAgfQoKICAgIC8vIGludGVybmFsIHZpZXdzIGFyZSBleHBsaWNpdGx5IG1pZ3JhdGVkCgogICAgY29uc3QgZW50cm9weSA9IEVuY3J5cHRpb25WaWV3Lm5hbWVzcGFjZSh0aGlzLmVudHJvcHkpCiAgICBhd2FpdCB0aGlzLmVuY3J5cHRpb24udXBkYXRlKGVudHJvcHkpCgogICAgY29uc3Qgc3lzdGVtID0gdGhpcy5zdG9yZS5nZXRWaWV3QnlOYW1lKCdfc3lzdGVtJykKICAgIGNvbnN0IGVuY3J5cHRpb24gPSB0aGlzLnN0b3JlLmdldFZpZXdCeU5hbWUoJ19lbmNyeXB0aW9uJykKCiAgICBjb25zdCBlbmMgPSBhd2FpdCB0aGlzLmNyZWF0ZVZpZXcoJ19lbmNyeXB0aW9uJywgdGhpcy5lbmNyeXB0aW9uLmNvcmUsIG51bGwpCiAgICBhd2FpdCBlbmMucmVhZHkoKQoKICAgIGF3YWl0IHRoaXMuX21pZ3JhdGUoZW5jcnlwdGlvbiwgZW5jLCB0aGlzLmVuY3J5cHRpb24uY29yZSwgdGhpcy5lbmNyeXB0aW9uLmNvcmUubGVuZ3RoKQoKICAgIGF3YWl0IHRoaXMuc3lzdGVtLmZvcmsodGhpcy5pbmRleGVycywgdGhpcy5tYW5pZmVzdHMsIHRoaXMuZW5jcnlwdGlvbi5jb3JlLmxlbmd0aCwgdmlld3MpCgogICAgY29uc3Qgc3lzID0gYXdhaXQgdGhpcy5jcmVhdGVWaWV3KCdfc3lzdGVtJywgdGhpcy5zeXN0ZW0uY29yZSwgW2VuYy5rZXldKQogICAgYXdhaXQgc3lzLnJlYWR5KCkKCiAgICBhd2FpdCB0aGlzLl9taWdyYXRlKHN5c3RlbSwgc3lzLCB0aGlzLnN5c3RlbS5jb3JlLCB0aGlzLnN5c3RlbS5jb3JlLmxlbmd0aCkKICB9CgogIGFzeW5jIGNyZWF0ZVZpZXcobmFtZSwgY29yZSwgbGlua2VkKSB7CiAgICBjb25zdCBwcm9sb2d1ZSA9IGF3YWl0IGdldFByb2xvZ3VlKGNvcmUpCiAgICBjb25zdCBtYW5pZmVzdERhdGEgPSB0aGlzLl9tYW5pZmVzdERhdGEoY29yZSkKCiAgICByZXR1cm4gdGhpcy5zdG9yZS5nZXRWaWV3Q29yZSgKICAgICAgdGhpcy5tYW5pZmVzdHMsCiAgICAgIG5hbWUsCiAgICAgIHByb2xvZ3VlLAogICAgICB0aGlzLm1hbmlmZXN0VmVyc2lvbiwKICAgICAgdGhpcy5lbnRyb3B5LAogICAgICBsaW5rZWQsCiAgICAgIG1hbmlmZXN0RGF0YQogICAgKQogIH0KCiAgYXN5bmMgX2dldChuYW1lLCBsZW5ndGgpIHsKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7IG5hbWUgfSkKICAgIHRoaXMuY29yZXMucHVzaChjb3JlKQoKICAgIGlmIChsZW5ndGggIT09IC0xKSBhd2FpdCBjb3JlLnRydW5jYXRlKGxlbmd0aCkKCiAgICByZXR1cm4gY29yZQogIH0KCiAgZ2V0Vmlld0Zyb21TeXN0ZW0odmlldykgewogICAgaWYgKHZpZXcubWFwcGVkSW5kZXggPT09IC0xIHx8IHZpZXcubWFwcGVkSW5kZXggPj0gdGhpcy5zeXN0ZW0udmlld3MubGVuZ3RoKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHRoaXMuc3lzdGVtLnZpZXdzW3ZpZXcubWFwcGVkSW5kZXhdCiAgfQoKICBfbWFuaWZlc3REYXRhKHNlc3Npb24pIHsKICAgIGlmIChzZXNzaW9uLm1hbmlmZXN0LnZlcnNpb24gPiAxKSByZXR1cm4gc2Vzc2lvbi5tYW5pZmVzdC51c2VyRGF0YQogICAgcmV0dXJuIGMuZW5jb2RlKE1hbmlmZXN0RGF0YSwgeyB2ZXJzaW9uOiAwLCBsZWdhY3lCbG9ja3M6IHNlc3Npb24ubGVuZ3RoIH0pCiAgfQoKICBhc3luYyBfbWlncmF0ZShyZWYsIG5leHQsIHNvdXJjZSwgbGVuZ3RoKSB7CiAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICBhd2FpdCBuZXh0LmNvcmUuY29weVByb2xvZ3VlKHNvdXJjZS5zdGF0ZSkKICAgIH0KCiAgICAvLyByZW1ha2UgdGhlIGJhdGNoLCByZXNldCBmcm9tIG91ciBwcm9sb2d1ZSBpbiBjYXNlIGl0IHJlcGxpY2F0ZWQgaW5iZXR3ZWVuCiAgICAvLyBUT0RPOiB3ZSBzaG91bGQgcmVhbGx5IGhhdmUgYW4gSEMgZnVuY3Rpb24gZm9yIHRoaXMKICAgIGNvbnN0IGJhdGNoID0gbmV4dC5zZXNzaW9uKHsgbmFtZTogJ2JhdGNoJywgb3ZlcndyaXRlOiB0cnVlLCBjaGVja291dDogbGVuZ3RoIH0pCiAgICBhd2FpdCBiYXRjaC5yZWFkeSgpCgogICAgaWYgKHNvdXJjZSAhPT0gbnVsbCkgewogICAgICB3aGlsZSAoYmF0Y2gubGVuZ3RoIDwgc291cmNlLmxlbmd0aCkgewogICAgICAgIGF3YWl0IGJhdGNoLmFwcGVuZChhd2FpdCBzb3VyY2UuZ2V0KGJhdGNoLmxlbmd0aCkpCiAgICAgIH0KICAgIH0KCiAgICBhd2FpdCByZWYuYmF0Y2guc3RhdGUubW92ZVRvKGJhdGNoLCBiYXRjaC5sZW5ndGgpCiAgICBhd2FpdCBiYXRjaC5jbG9zZSgpCgogICAgcmVmLm1pZ3JhdGVkKHRoaXMuYmFzZSwgbmV4dCkKICB9CgogIGFzeW5jIGNsb3NlKCkgewogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCiAgICBpZiAodGhpcy5zeXN0ZW0pIGF3YWl0IHRoaXMuc3lzdGVtLmNsb3NlKCkKICAgIGlmICh0aGlzLmVuY3J5cHRpb24pIGF3YWl0IHRoaXMuZW5jcnlwdGlvbi5jbG9zZSgpCiAgICBmb3IgKGNvbnN0IGNvcmUgb2YgdGhpcy5jb3JlcykgYXdhaXQgY29yZS5jbG9zZSgpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBnZXRQcm9sb2d1ZShjb3JlKSB7CiAgaWYgKCFjb3JlLmxlbmd0aCkgcmV0dXJuIG51bGwKCiAgcmV0dXJuIHsKICAgIGhhc2g6IGF3YWl0IGNvcmUudHJlZUhhc2goKSwKICAgIGxlbmd0aDogY29yZS5sZW5ndGgKICB9Cn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnbmFub2Fzc2VydCcpCgpjb25zdCBDbG9jayA9IHJlcXVpcmUoJy4vY2xvY2suanMnKQpjb25zdCBDb25zZW5zdXMgPSByZXF1aXJlKCcuL2NvbnNlbnN1cy5qcycpCmNvbnN0IFRvcG9saXN0ID0gcmVxdWlyZSgnLi90b3BvbGlzdC5qcycpCgpjbGFzcyBOb2RlIHsKICBjb25zdHJ1Y3Rvcih3cml0ZXIsIGxlbmd0aCwgdmFsdWUsIGhlYWRzLCBiYXRjaCwgZGVwZW5kZW5jaWVzLCBvcHRpbWlzdGljLCB0cmFjZSkgewogICAgdGhpcy53cml0ZXIgPSB3cml0ZXIKICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLnZhbHVlID0gdmFsdWUKICAgIHRoaXMuaGVhZHMgPSBoZWFkcwogICAgdGhpcy5hY3R1YWxIZWFkcyA9IGhlYWRzLnNsaWNlKDApIC8vIFRPRE86IHdlIHNob3VsZCByZW1vdmUgdGhpcyBhbmQganVzdCBub3QgbXV0YXRlIGhlYWRzLi4uCgogICAgdGhpcy5kZXBlbmRlbnRzID0gbmV3IFNldCgpCiAgICB0aGlzLmRlcGVuZGVuY2llcyA9IGRlcGVuZGVuY2llcwogICAgdGhpcy5pbmRleCA9IDAgLy8gdXNlZCBieSB0b3BvbGlzdAoKICAgIHRoaXMub3B0aW1pc3RpYyA9IG9wdGltaXN0aWMgJiYgYmF0Y2ggPT09IDEgJiYgISF2YWx1ZQoKICAgIHRoaXMuYmF0Y2ggPSBiYXRjaAogICAgdGhpcy5kcm9wcGVkID0gMAogICAgdGhpcy50cmFjZSA9IHRyYWNlCgogICAgdGhpcy5jbG9jayA9IG5ldyBDbG9jaygpCgogICAgdGhpcy55aWVsZGVkID0gZmFsc2UKICAgIHRoaXMueWllbGRpbmcgPSBmYWxzZQogIH0KCiAgaXNUYWlsKCkgewogICAgcmV0dXJuIHRoaXMuZGVwZW5kZW5jaWVzLnNpemUgPT09IHRoaXMuZHJvcHBlZAogIH0KCiAgY2F1c2FsRGVwZW5kZW5jaWVzKGlkeCkgewogICAgY29uc3Qgb3JkZXIgPSBbdGhpc10KICAgIGNvbnN0IHN0YWNrID0gW3RoaXNdCgogICAgbGV0IHZpc2l0ZWQgPSBudWxsCgogICAgd2hpbGUgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3Qgbm9kZSA9IHN0YWNrLnBvcCgpCiAgICAgIGZvciAoY29uc3QgZGVwIG9mIG5vZGUuZGVwZW5kZW5jaWVzKSB7CiAgICAgICAgaWYgKCFkZXAud3JpdGVyLmlzUmVtb3ZlZCB8fCBkZXAud3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgY29udGludWUKCiAgICAgICAgLy8gVE9ETzogcmVwbGFjZSB3aXRoICJjb2xvcmluZyIgYnV0IG9rIGZvciBub3csIHRpbnkgc2V0CiAgICAgICAgaWYgKHZpc2l0ZWQgPT09IG51bGwpIHZpc2l0ZWQgPSBuZXcgU2V0KCkKICAgICAgICBpZiAodmlzaXRlZC5oYXMoZGVwKSkgY29udGludWUKICAgICAgICB2aXNpdGVkLmFkZChkZXApCgogICAgICAgIHN0YWNrLnB1c2goZGVwKQogICAgICAgIG9yZGVyLnB1c2goZGVwKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG9yZGVyCiAgfQoKICBjbGVhcigpIHsKICAgIHRoaXMuY2xvY2sgPSBudWxsCiAgICB0aGlzLmRlcGVuZGVudHMgPSBudWxsCiAgICByZXR1cm4gdGhpcwogIH0KCiAgcmVzZXQoKSB7CiAgICB0aGlzLnlpZWxkZWQgPSBmYWxzZQogICAgdGhpcy55aWVsZGluZyA9IGZhbHNlCiAgICBmb3IgKGNvbnN0IGRlcCBvZiB0aGlzLmRlcGVuZGVudHMpIGRlcC5kZXBlbmRlbmNpZXMuYWRkKHRoaXMpCiAgICB0aGlzLmRlcGVuZGVudHMuY2xlYXIoKQogIH0KCiAgYWN0aXZlKCkgewogICAgZm9yIChjb25zdCBkZXAgb2YgdGhpcy5kZXBlbmRlbmNpZXMpIHsKICAgICAgaWYgKGRlcC55aWVsZGVkKSB7CiAgICAgICAgdGhpcy5kZXBlbmRlbmNpZXMuZGVsZXRlKGRlcCkgLy8gbm9kZXMgbWlnaHQgYmUgeWllbGRlZCBkdXJpbmcgYnVmZmVyaW5nCiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVwLmRlcGVuZGVudHMuYWRkKHRoaXMpCiAgICAgICAgdGhpcy5jbG9jay5hZGQoZGVwLmNsb2NrKQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMud3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgdGhpcy5jbG9jay5zZXQodGhpcy53cml0ZXIuY29yZS5rZXksIHRoaXMubGVuZ3RoKQogIH0KCiAgdGllQnJlYWsobm9kZSkgewogICAgcmV0dXJuIHRpZUJyZWFrKHRoaXMsIG5vZGUpCiAgfQoKICBoYXNEZXBlbmRlbmN5KGRlcCkgewogICAgZm9yIChjb25zdCBoIG9mIHRoaXMuYWN0dWFsSGVhZHMpIHsKICAgICAgaWYgKHNhbWVOb2RlKGgsIGRlcCkpIHJldHVybiB0cnVlCiAgICB9CiAgICByZXR1cm4gZmFsc2UKICB9CgogIGdldCByZWYoKSB7CiAgICByZXR1cm4gdGhpcy53cml0ZXIuY29yZS5rZXkudG9TdHJpbmcoJ2hleCcpLnNsaWNlKDAsIDIpICsgJzonICsgdGhpcy5sZW5ndGgKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgTGluZWFyaXplciB7CiAgY29uc3RydWN0b3IoaW5kZXhlcnMsIHsgaGVhZHMgPSBbXSwgd3JpdGVycyA9IG5ldyBNYXAoKSB9ID0ge30pIHsKICAgIHRoaXMuaGVhZHMgPSBuZXcgU2V0KCkKICAgIHRoaXMudGFpbHMgPSBuZXcgU2V0KCkKICAgIHRoaXMudGlwID0gbmV3IFRvcG9saXN0KCkKICAgIHRoaXMuc2l6ZSA9IDAgLy8gdXNlZnVsIGZvciBkZWJ1Z2dpbmcKICAgIHRoaXMudXBkYXRlZCA9IGZhbHNlCiAgICB0aGlzLmluZGV4ZXJzVXBkYXRlZCA9IGZhbHNlCiAgICB0aGlzLndyaXRlcnMgPSB3cml0ZXJzCgogICAgdGhpcy5jb25zZW5zdXMgPSBuZXcgQ29uc2Vuc3VzKGluZGV4ZXJzKQogICAgdGhpcy5faW5pdGlhbEhlYWRzID0gaGVhZHMuc2xpY2UoMCkKICAgIHRoaXMuX3N0cmljdGx5QWRkZWQgPSBudWxsCgogICAgZm9yIChjb25zdCB7IGtleSwgbGVuZ3RoIH0gb2YgaGVhZHMpIHsKICAgICAgdGhpcy5jb25zZW5zdXMucmVtb3ZlZC5zZXQoa2V5LCBsZW5ndGgpCiAgICB9CiAgfQoKICBnZXQgaW5kZXhlcnMoKSB7CiAgICByZXR1cm4gdGhpcy5jb25zZW5zdXMuaW5kZXhlcnMKICB9CgogIHN0YXRpYyBjcmVhdGVOb2RlKHdyaXRlciwgbGVuZ3RoLCB2YWx1ZSwgaGVhZHMsIGJhdGNoLCBkZXBlbmRlbmNpZXMsIG9wdGltaXN0aWMsIHRyYWNlKSB7CiAgICByZXR1cm4gbmV3IE5vZGUod3JpdGVyLCBsZW5ndGgsIHZhbHVlLCBoZWFkcywgYmF0Y2gsIGRlcGVuZGVuY2llcywgb3B0aW1pc3RpYywgdHJhY2UpCiAgfQoKICAvLyByZXR1cm5zIHRoZSBnbG9iYWwgbGlua3Mgb2YgdGhlIGRhZywgdXNlIHRoaXMgdG8gbGluayBhZ2FpbnN0IHRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBkYWcKICAvLyBUT0RPOiByZW5hbWUgdG8gaGVhZHMoKSBhbmQgbW92ZSB0aGUgc2V0cyB0byBfIHByb3BzCiAgZ2V0SGVhZHMoKSB7CiAgICBjb25zdCBoZWFkcyA9IHRoaXMuX2luaXRpYWxIZWFkcy5zbGljZSgwKQogICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMuaGVhZHMpIGhlYWRzLnB1c2goeyBrZXk6IG5vZGUud3JpdGVyLmNvcmUua2V5LCBsZW5ndGg6IG5vZGUubGVuZ3RoIH0pCiAgICByZXR1cm4gaGVhZHMKICB9CgogIC8vIFRPRE86IG1pZ2h0IGNvbnRhaW4gZHVwcyBhdG0sIG5iZCBmb3IgaG93IHdlIHVzZSBpdCwgcmV0dXJucyBhbiBhcnJheSBvZiB3cml0ZXJzIHlvdSBjYW4gInB1bGwiCiAgLy8gdG8gZ2V0IHRoZSBmdWxsIGRhZyB2aWV3IGF0IGFueSB0aW1lCiAgZ2V0Qm9vdHN0cmFwV3JpdGVycygpIHsKICAgIGNvbnN0IHdyaXRlcnMgPSBbXQoKICAgIGZvciAoY29uc3QgaGVhZCBvZiB0aGlzLmhlYWRzKSB3cml0ZXJzLnB1c2goaGVhZC53cml0ZXIpCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY29uc2Vuc3VzLmluZGV4ZXJzLmxlbmd0aDsgaSsrKQogICAgICB3cml0ZXJzLnB1c2godGhpcy5jb25zZW5zdXMuaW5kZXhlcnNbaV0pCgogICAgcmV0dXJuIHdyaXRlcnMKICB9CgogIGFkZEhlYWQobm9kZSkgewogICAgbm9kZS5hY3RpdmUoKQoKICAgIC8vIDk5Ljk5JSBvZiB0aGUgdGltZSBfaW5pdGlhbEhlYWRzIGlzIGVtcHR5Li4uCiAgICBpZiAodGhpcy5faW5pdGlhbEhlYWRzLmxlbmd0aCA+IDApIHRoaXMuX3VwZGF0ZUluaXRpYWxIZWFkcyhub2RlKQoKICAgIGlmIChub2RlLmlzVGFpbCgpKSB7CiAgICAgIHRoaXMudGFpbHMuYWRkKG5vZGUpCiAgICB9CgogICAgZm9yIChjb25zdCBoZWFkIG9mIHRoaXMuaGVhZHMpIHsKICAgICAgaWYgKG5vZGUuaGFzRGVwZW5kZW5jeShoZWFkKSkgewogICAgICAgIHRoaXMuaGVhZHMuZGVsZXRlKGhlYWQpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnRpcC5hZGQobm9kZSkKICAgIGlmIChub2RlLndyaXRlci5pc0FjdGl2ZUluZGV4ZXIpIHRoaXMuY29uc2Vuc3VzLmFkZEhlYWQobm9kZSkKCiAgICB0aGlzLnNpemUrKwogICAgdGhpcy5oZWFkcy5hZGQobm9kZSkKCiAgICB0aGlzLnVwZGF0ZWQgPSB0cnVlCgogICAgcmV0dXJuIG5vZGUKICB9CgogIHVwZGF0ZSgpIHsKICAgIGlmICghdGhpcy51cGRhdGVkKSByZXR1cm4gbnVsbAogICAgdGhpcy51cGRhdGVkID0gZmFsc2UKCiAgICAvLyBnZXQgdGhlIGluZGV4ZWQgbm9kZXMKICAgIGNvbnN0IGluZGV4ZWQgPSBbXQogICAgd2hpbGUgKHRydWUpIHsKICAgICAgY29uc3Qgbm9kZXMgPSB0aGlzLmNvbnNlbnN1cy5zaGlmdCgpCiAgICAgIGlmICghbm9kZXMubGVuZ3RoKSBicmVhawoKICAgICAgdGhpcy5feWllbGQobm9kZXMsIGluZGV4ZWQpCiAgICB9CgogICAgcmV0dXJuIHRoaXMudGlwLmZsdXNoKGluZGV4ZWQpCiAgfQoKICBfdXBkYXRlSW5pdGlhbEhlYWRzKG5vZGUpIHsKICAgIGZvciAoY29uc3QgaGVhZCBvZiBub2RlLmFjdHVhbEhlYWRzKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5faW5pdGlhbEhlYWRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgeyBrZXksIGxlbmd0aCB9ID0gdGhpcy5faW5pdGlhbEhlYWRzW2ldCiAgICAgICAgaWYgKGxlbmd0aCAhPT0gaGVhZC5sZW5ndGggfHwgIWI0YS5lcXVhbHMoa2V5LCBoZWFkLmtleSkpIGNvbnRpbnVlCiAgICAgICAgdGhpcy5faW5pdGlhbEhlYWRzLnNwbGljZShpLS0sIDEpCiAgICAgIH0KICAgIH0KICB9CgogIC8qIEFjayBtZXRob2RzICovCgogIHNob3VsZEFjayh3cml0ZXIsIHBlbmRpbmcgPSBmYWxzZSkgewogICAgaWYgKCF3cml0ZXIgfHwgIXdyaXRlci5pc0FjdGl2ZUluZGV4ZXIpIHJldHVybiBmYWxzZQoKICAgIC8vIGFsbCBpbmRleGVycyBoYXZlIHRvIGZsdXNoZWQgdG8gdGhlIGRhZyBiZWZvcmUgd2UgYWNrIGFzIGEgcXVpY2sgImRlYm91bmNlIgogICAgZm9yIChjb25zdCB3IG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgaWYgKHcubGVuZ3RoICE9PSB3LmF2YWlsYWJsZSkgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgbGV0IGlzSGVhZCA9IGZhbHNlCgogICAgLy8gaWYgQU5ZIGhlYWQgaXMgbm90IGFuIGluZGV4ZXIgYWNrCiAgICBmb3IgKGNvbnN0IGhlYWQgb2YgdGhpcy5oZWFkcykgewogICAgICBpZiAoIWhlYWQud3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgcmV0dXJuIHRydWUKICAgICAgaWYgKGhlYWQud3JpdGVyID09PSB3cml0ZXIpIGlzSGVhZCA9IHRydWUKICAgIH0KCiAgICBpZiAodGhpcy5oZWFkcy5zaXplID09PSAxICYmIGlzSGVhZCkgewogICAgICByZXR1cm4gZmFsc2UgLy8gbmV2ZXIgc2VsZi1hY2shCiAgICB9CgogICAgY29uc3QgdmlzaXRlZCA9IG5ldyBTZXQoKQoKICAgIC8vIGNoZWNrIGlmIHRoZXJlIGlzIG5vbi1udWxsIHZhbHVlCiAgICBsZXQgdmFsdWVDaGVjayA9IGZhbHNlCgogICAgZm9yIChjb25zdCB0YWlsIG9mIHRoaXMudGFpbHMpIHsKICAgICAgaWYgKHBlbmRpbmcgfHwgdGhpcy5fbm9uTnVsbCh0YWlsLCB2aXNpdGVkKSkgewogICAgICAgIHZhbHVlQ2hlY2sgPSB0cnVlCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIGlmICghdmFsdWVDaGVjaykgcmV0dXJuIGZhbHNlCgogICAgaWYgKHRoaXMuY29uc2Vuc3VzLnNob3VsZEFjayh3cml0ZXIpKSByZXR1cm4gdHJ1ZQoKICAgIHJldHVybiB0aGlzLl9zaG91bGRBY2tIZWFkcyh3cml0ZXIsIHBlbmRpbmcpCiAgfQoKICAvLyBjaGVjayBpZiB0aGVyZSBpcyBhbnkgdmFsdWUgYWJvdmUgdGhpcyBub2RlCiAgX25vbk51bGwodGFyZ2V0LCB2aXNpdGVkKSB7CiAgICBjb25zdCBzdGFjayA9IFt0YXJnZXRdCgogICAgd2hpbGUgKHN0YWNrLmxlbmd0aCkgewogICAgICBjb25zdCBub2RlID0gc3RhY2sucG9wKCkKCiAgICAgIGlmICh2aXNpdGVkLmhhcyhub2RlKSkgY29udGludWUKICAgICAgaWYgKG5vZGUudmFsdWUgIT09IG51bGwpIHJldHVybiB0cnVlCgogICAgICB2aXNpdGVkLmFkZChub2RlKQoKICAgICAgZm9yIChjb25zdCBkZXAgb2Ygbm9kZS5kZXBlbmRlbnRzKSB7CiAgICAgICAgc3RhY2sucHVzaChkZXApCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIC8vIGFjayBpZiBhbnkgaGVhZCBpcyBjbG9zZXIgdG8gY29uZmlybWluZyBhIHZhbHVlCiAgX3Nob3VsZEFja0hlYWRzKHdyaXRlciwgcGVuZGluZykgewogICAgY29uc3QgcHJldiA9IHdyaXRlci5oZWFkKCkKCiAgICBmb3IgKGNvbnN0IGhlYWQgb2YgdGhpcy5oZWFkcykgewogICAgICAvLyBvbmx5IGNoZWNrIG90aGVyIHdyaXRlcnMgaGVhZHMKICAgICAgaWYgKGhlYWQud3JpdGVyID09PSB3cml0ZXIpIGNvbnRpbnVlCgogICAgICBjb25zdCBzdGFjayA9IFtoZWFkXQogICAgICBjb25zdCB2aXNpdGVkID0gbmV3IFNldCgpCgogICAgICB3aGlsZSAoc3RhY2subGVuZ3RoKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IHN0YWNrLnBvcCgpCgogICAgICAgIGlmICh2aXNpdGVkLmhhcyhub2RlKSkgY29udGludWUKICAgICAgICB2aXNpdGVkLmFkZChub2RlKQoKICAgICAgICBpZiAocGVuZGluZyB8fCBub2RlLnZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICBjb25zdCBhY2tzID0gdGhpcy5jb25zZW5zdXMuYWNrc0Zyb21Ob2RlKG5vZGUsIGhlYWQpCiAgICAgICAgICBjb25zdCBwcmV2QWNrcyA9IHRoaXMuY29uc2Vuc3VzLmFja3NGcm9tTm9kZShub2RlLCBwcmV2KQoKICAgICAgICAgIC8vIGhlYWQgc2VlcyBtb3JlIGFja3MKICAgICAgICAgIGlmIChhY2tzLnNpemUgPiBwcmV2QWNrcy5zaXplKSByZXR1cm4gdHJ1ZQoKICAgICAgICAgIGZvciAoY29uc3QgaWR4IG9mIGFja3MpIHsKICAgICAgICAgICAgLy8gaGVhZCBzZWVzIGFja3MgdGhhdCB3cml0ZXIgZG9lcyBub3QKICAgICAgICAgICAgaWYgKCFwcmV2QWNrcy5oYXMoaWR4KSkgcmV0dXJuIHRydWUKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBib3RoIHNlZW4sIG5vIHBvaW50IGdvaW5nIGFueSBmdXJ0aGVyIGRvd24KICAgICAgICAgIGlmIChwcmV2QWNrcy5zaXplICYmIGFja3Muc2l6ZSkgY29udGludWUKICAgICAgICB9CgogICAgICAgIHN0YWNrLnB1c2goLi4ubm9kZS5kZXBlbmRlbmNpZXMpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIC8qIEZ1bGwgREFHIG1ldGhvZHMgKi8KCiAgX3lpZWxkKG5vZGVzLCBpbmRleGVkID0gW10pIHsKICAgIGNvbnN0IG9mZnNldCA9IGluZGV4ZWQubGVuZ3RoCiAgICBjb25zdCB0YWlscyA9IFtdCgogICAgLy8gZGV0ZXJtaW5lIHdoaWNoIG5vZGVzIGFyZSB5aWVsZGVkCiAgICB3aGlsZSAobm9kZXMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IG5vZGUgPSBub2Rlcy5wb3AoKQoKICAgICAgaWYgKG5vZGUueWllbGRpbmcpIGNvbnRpbnVlCiAgICAgIG5vZGUueWllbGRpbmcgPSB0cnVlCgogICAgICBpZiAobm9kZS5pc1RhaWwoKSkgdGFpbHMucHVzaChub2RlKQoKICAgICAgbm9kZXMucHVzaCguLi5ub2RlLmRlcGVuZGVuY2llcykKICAgIH0KCiAgICB3aGlsZSAodGFpbHMubGVuZ3RoKSB7CiAgICAgIGxldCB0YWlsID0gdGFpbHMucG9wKCkKCiAgICAgIGZvciAodGFpbCBvZiB0aGlzLl9yZW1vdmVCYXRjaCh0YWlsKSkgewogICAgICAgIFRvcG9saXN0LmFkZCh0YWlsLCBpbmRleGVkLCBvZmZzZXQpCiAgICAgIH0KCiAgICAgIGZvciAoY29uc3QgZGVwIG9mIHRhaWwuZGVwZW5kZW50cykgewogICAgICAgIGlmIChkZXAuaXNUYWlsKCkgJiYgZGVwLnlpZWxkaW5nKSB0YWlscy5wdXNoKGRlcCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBpbmRleGVkCiAgfQoKICBfaXNGdXR1cmVUYWlsKG5vZGUpIHsKICAgIGxldCBkcm9wcGVkID0gbm9kZS5kcm9wcGVkCgogICAgLy8gYSB0YWlsIGhhcyBubyB1bnlpZWxkZWQgZGVwZW5kZW5jaWVzCiAgICBmb3IgKGNvbnN0IGRlcCBvZiBub2RlLmRlcGVuZGVuY2llcykgewogICAgICBpZiAoZGVwLnlpZWxkZWQpIGNvbnRpbnVlCiAgICAgIGlmIChkcm9wcGVkID09PSAwKSByZXR1cm4gZmFsc2UKICAgICAgZHJvcHBlZC0tCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIF9yZW1vdmVOb2RlKG5vZGUpIHsKICAgIHRoaXMudGFpbHMuZGVsZXRlKG5vZGUpCiAgICB0aGlzLmhlYWRzLmRlbGV0ZShub2RlKQogICAgdGhpcy5jb25zZW5zdXMucmVtb3ZlKG5vZGUpCgogICAgLy8gdXBkYXRlIHRoZSB0YWlsc2V0CiAgICBmb3IgKGNvbnN0IGQgb2Ygbm9kZS5kZXBlbmRlbnRzKSB7CiAgICAgIGlmIChkLnlpZWxkaW5nICYmIGQuZGVwZW5kZW5jaWVzLmhhcyhub2RlKSkKICAgICAgICBkLmRyb3BwZWQrKyAvLyBrZWVwIGxpbmtzIGZvciB0aGUgaW5kZXhlZCBiYXRjaAogICAgICBlbHNlIGQuZGVwZW5kZW5jaWVzLmRlbGV0ZShub2RlKQogICAgICBpZiAodGhpcy5faXNGdXR1cmVUYWlsKGQpKSB0aGlzLnRhaWxzLmFkZChkKQogICAgfQoKICAgIG5vZGUueWllbGRlZCA9IHRydWUKICAgIHRoaXMuc2l6ZS0tCgogICAgaWYgKHRoaXMuaGVhZHMuc2l6ZSA9PT0gMCkgewogICAgICAvLyBpbiBjYXNlIG9mIGEgc2luZ2xlIHdyaXRlciB0aGUgZGFnIG1pZ2h0IGRyYWluIGltbWVkaWF0ZWx5Li4uCiAgICAgIHRoaXMuX2luaXRpYWxIZWFkcy5wdXNoKHsga2V5OiBub2RlLndyaXRlci5jb3JlLmtleSwgbGVuZ3RoOiBub2RlLmxlbmd0aCB9KQogICAgfQoKICAgIHJldHVybiBub2RlCiAgfQoKICBfcmVtb3ZlQmF0Y2gobm9kZSkgewogICAgY29uc3QgYmF0Y2ggPSBbdGhpcy5fcmVtb3ZlTm9kZShub2RlKV0KCiAgICB3aGlsZSAobm9kZS5iYXRjaCAhPT0gMSkgewogICAgICAvLyBpdHMgYSBiYXRjaCEKICAgICAgaWYgKG5vZGUuZGVwZW5kZW50cy5zaXplID09PSAwKSB7CiAgICAgICAgLy8gYmFkIGJhdGNoIG5vZGUsIGF1dG8gY29ycmVjdAogICAgICAgIGNvbnN0IG5leHQgPSBub2RlLndyaXRlci5nZXQobm9kZS5sZW5ndGgpCiAgICAgICAgaWYgKG5leHQgJiYgbmV4dC5iYXRjaCA9PT0gbm9kZS5iYXRjaCAtIDEpIG5vZGUuZGVwZW5kZW50cy5hZGQobmV4dCkKICAgICAgfQoKICAgICAgYXNzZXJ0KG5vZGUuZGVwZW5kZW50cy5zaXplID09PSAxLCAnQmF0Y2ggaXMgbGlua2VkIHBhcnRpYWxseSwgd2hpY2ggaXMgbm90IGFsbG93ZWQnKQoKICAgICAgbm9kZSA9IGdldEZpcnN0KG5vZGUuZGVwZW5kZW50cykKICAgICAgYmF0Y2gucHVzaCh0aGlzLl9yZW1vdmVOb2RlKG5vZGUpKQogICAgfQoKICAgIHJldHVybiBiYXRjaAogIH0KfQoKZnVuY3Rpb24gdGllQnJlYWsoYSwgYikgewogIHJldHVybiBUb3BvbGlzdC5jb21wYXJlKGEsIGIpIDwgMCAvLyBsb3dlc3Qga2V5IHdpcwp9CgpmdW5jdGlvbiBnZXRGaXJzdChzZXQpIHsKICByZXR1cm4gc2V0W1N5bWJvbC5pdGVyYXRvcl0oKS5uZXh0KCkudmFsdWUKfQoKZnVuY3Rpb24gc2FtZU5vZGUoYSwgYikgewogIHJldHVybiBiNGEuZXF1YWxzKGEua2V5LCBiLndyaXRlci5jb3JlLmtleSkgJiYgYS5sZW5ndGggPT09IGIubGVuZ3RoCn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgbWVzc2FnZXMgPSByZXF1aXJlKCcuL21lc3NhZ2VzLmpzJykKCmNvbnN0IEdURSA9IGI0YS5mcm9tKFttZXNzYWdlcy5MSU5FQVJJWkVSX1BSRUZJWF0pCmNvbnN0IExUID0gYjRhLmZyb20oW21lc3NhZ2VzLkxJTkVBUklaRVJfUFJFRklYICsgMV0pCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIExvY2FsU3RhdGUgewogIGNvbnN0cnVjdG9yKGNvcmUpIHsKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMudHggPSBudWxsCiAgfQoKICBzdGF0aWMgY2xlYXIoY29yZSkgewogICAgY29uc3QgdHggPSBjb3JlLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQogICAgdHguZGVsZXRlTG9jYWxSYW5nZShHVEUsIExUKQogICAgcmV0dXJuIHR4LmZsdXNoKCkKICB9CgogIHN0YXRpYyBhc3luYyBtb3ZlVG8oc3JjLCBkc3QpIHsKICAgIGNvbnN0IGJvb3QgPSBhd2FpdCBzcmMuZ2V0VXNlckRhdGEoJ2F1dG9iYXNlL2Jvb3QnKQogICAgY29uc3QgdHggPSBkc3Quc3RhdGUuc3RvcmFnZS53cml0ZSgpCgogICAgdHguZGVsZXRlTG9jYWxSYW5nZShHVEUsIExUKQoKICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiBzcmMuc3RhdGUuc3RvcmFnZS5jcmVhdGVMb2NhbFN0cmVhbSh7IGd0ZTogR1RFLCBsdDogTFQgfSkpIHsKICAgICAgdHgucHV0TG9jYWwoZGF0YS5rZXksIGRhdGEudmFsdWUpCiAgICB9CgogICAgdHgucHV0VXNlckRhdGEoJ2F1dG9iYXNlL2Jvb3QnLCBib290KQoKICAgIGF3YWl0IHR4LmZsdXNoKCkKICB9CgogIHNldEJvb3RSZWNvcmQoYm9vdCkgewogICAgaWYgKHRoaXMudHggPT09IG51bGwpIHRoaXMudHggPSB0aGlzLmNvcmUuc3RhdGUuc3RvcmFnZS53cml0ZSgpCgogICAgdGhpcy50eC5wdXRVc2VyRGF0YSgnYXV0b2Jhc2UvYm9vdCcsIGMuZW5jb2RlKG1lc3NhZ2VzLkJvb3RSZWNvcmQsIGJvb3QpKQogIH0KCiAgYXN5bmMgbGlzdFVwZGF0ZXMoKSB7CiAgICBjb25zdCB1cGRhdGVzID0gW10KCiAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgdGhpcy5jb3JlLnN0YXRlLnN0b3JhZ2UuY3JlYXRlTG9jYWxTdHJlYW0oeyBndGU6IEdURSwgbHQ6IExUIH0pKSB7CiAgICAgIGNvbnN0IHVwZGF0ZSA9IGMuZGVjb2RlKG1lc3NhZ2VzLkxpbmVhcml6ZXJVcGRhdGUsIGRhdGEudmFsdWUpCiAgICAgIGNvbnN0IHNlcSA9IGMuZGVjb2RlKG1lc3NhZ2VzLkxpbmVhcml6ZXJLZXksIGRhdGEua2V5KQogICAgICB1cGRhdGUuc2VxID0gc2VxCiAgICAgIHVwZGF0ZXMucHVzaCh1cGRhdGUpCiAgICB9CgogICAgcmV0dXJuIHVwZGF0ZXMKICB9CgogIGNsZWFyVXBkYXRlcygpIHsKICAgIGlmICh0aGlzLnR4ID09PSBudWxsKSB0aGlzLnR4ID0gdGhpcy5jb3JlLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQoKICAgIHRoaXMudHguZGVsZXRlTG9jYWxSYW5nZShHVEUsIExUKQogIH0KCiAgZGVsZXRlVXBkYXRlKHVwZGF0ZSkgewogICAgaWYgKHRoaXMudHggPT09IG51bGwpIHRoaXMudHggPSB0aGlzLmNvcmUuc3RhdGUuc3RvcmFnZS53cml0ZSgpCgogICAgdGhpcy50eC5kZWxldGVMb2NhbChjLmVuY29kZShtZXNzYWdlcy5MaW5lYXJpemVyS2V5LCB1cGRhdGUuc2VxKSkKICB9CgogIGluc2VydFVwZGF0ZSh1cGRhdGUpIHsKICAgIGlmICh0aGlzLnR4ID09PSBudWxsKSB0aGlzLnR4ID0gdGhpcy5jb3JlLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQoKICAgIHRoaXMudHgucHV0TG9jYWwoCiAgICAgIGMuZW5jb2RlKG1lc3NhZ2VzLkxpbmVhcml6ZXJLZXksIHVwZGF0ZS5zZXEpLAogICAgICBjLmVuY29kZShtZXNzYWdlcy5MaW5lYXJpemVyVXBkYXRlLCB1cGRhdGUpCiAgICApCiAgfQoKICBmbHVzaCgpIHsKICAgIGlmICghdGhpcy50eCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCgogICAgY29uc3QgZmx1c2hpbmcgPSB0aGlzLnR4LmZsdXNoKCkKICAgIHRoaXMudHggPSBudWxsCiAgICByZXR1cm4gZmx1c2hpbmcKICB9Cn0KY29uc3Qgc2NoZW1hID0gcmVxdWlyZSgnLi4vZW5jb2Rpbmcvc3BlYy9hdXRvYmFzZScpCgptb2R1bGUuZXhwb3J0cyA9IHsKICBXYWtldXA6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2Uvd2FrZXVwJyksCiAgQ2xvY2s6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvY2xvY2snKSwKICBDaGVja291dDogc2NoZW1hLnJlc29sdmVTdHJ1Y3QoJ0BhdXRvYmFzZS9jaGVja291dCcpLAogIEJvb3RSZWNvcmQ6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvYm9vdC1yZWNvcmQnKSwKICBPcGxvZ01lc3NhZ2U6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZScpLAogIENoZWNrcG9pbnQ6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvY2hlY2twb2ludCcpLAogIEluZm86IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvaW5mbycpLAogIE1lbWJlcjogc2NoZW1hLnJlc29sdmVTdHJ1Y3QoJ0BhdXRvYmFzZS9tZW1iZXInKSwKICBNYW5pZmVzdERhdGE6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvbWFuaWZlc3QtZGF0YScpLAogIExJTkVBUklaRVJfUFJFRklYOiAxLAogIExpbmVhcml6ZXJLZXk6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvbGluZWFyaXplci1rZXknKSwKICBMaW5lYXJpemVyVXBkYXRlOiBzY2hlbWEucmVzb2x2ZVN0cnVjdCgnQGF1dG9iYXNlL2xpbmVhcml6ZXItdXBkYXRlJyksCiAgRW5jcnlwdGlvbkRlc2NyaXB0b3I6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvZW5jcnlwdGlvbi1kZXNjcmlwdG9yJykKfQpjb25zdCBERUZBVUxUX1NJWkUgPSAzMgoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBOb2RlQnVmZmVyIHsKICBjb25zdHJ1Y3RvcihvZmZzZXQsIGh3bSkgewogICAgdGhpcy5od20gPSBod20gfHwgREVGQVVMVF9TSVpFCiAgICB0aGlzLmRlZmF1bHRId20gPSB0aGlzLmh3bQogICAgdGhpcy5tYXNrID0gdGhpcy5od20gLSAxCiAgICB0aGlzLnRvcCA9IDAKICAgIHRoaXMuYnRtID0gMAogICAgdGhpcy5idWZmZXIgPSBuZXcgQXJyYXkodGhpcy5od20pCiAgICB0aGlzLm9mZnNldCA9IG9mZnNldCB8fCAwCiAgICB0aGlzLmxlbmd0aCA9IHRoaXMub2Zmc2V0CiAgfQoKICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLmxlbmd0aCAtIHRoaXMub2Zmc2V0CiAgfQoKICBpc0VtcHR5KCkgewogICAgcmV0dXJuIHRoaXMubGVuZ3RoID09PSB0aGlzLm9mZnNldAogIH0KCiAgaXNGdWxsKCkgewogICAgcmV0dXJuIHRoaXMuc2l6ZSA9PT0gdGhpcy5idWZmZXIubGVuZ3RoCiAgfQoKICBncm93KCkgewogICAgdGhpcy5od20gPDw9IDEKCiAgICBjb25zdCBzaXplID0gdGhpcy5zaXplCiAgICBjb25zdCBidWZmZXIgPSBuZXcgQXJyYXkodGhpcy5od20pCiAgICBjb25zdCBtYXNrID0gdGhpcy5od20gLSAxCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHsKICAgICAgYnVmZmVyW2ldID0gdGhpcy5idWZmZXJbKHRoaXMuYnRtICsgaSkgJiB0aGlzLm1hc2tdCiAgICB9CgogICAgdGhpcy5tYXNrID0gbWFzawogICAgdGhpcy50b3AgPSBzaXplCiAgICB0aGlzLmJ0bSA9IDAKICAgIHRoaXMuYnVmZmVyID0gYnVmZmVyCiAgfQoKICBwdXNoKGRhdGEpIHsKICAgIGlmICh0aGlzLmlzRnVsbCgpKSB0aGlzLmdyb3coKQoKICAgIHRoaXMuYnVmZmVyW3RoaXMudG9wXSA9IGRhdGEKICAgIHRoaXMudG9wID0gKHRoaXMudG9wICsgMSkgJiB0aGlzLm1hc2sKCiAgICByZXR1cm4gdGhpcy5sZW5ndGgrKwogIH0KCiAgc2hpZnQoKSB7CiAgICBpZiAodGhpcy5pc0VtcHR5KCkpIHJldHVybiBudWxsCgogICAgY29uc3QgbGFzdCA9IHRoaXMuYnVmZmVyW3RoaXMuYnRtXQoKICAgIHRoaXMuYnVmZmVyW3RoaXMuYnRtXSA9IHVuZGVmaW5lZAogICAgdGhpcy5idG0gPSAodGhpcy5idG0gKyAxKSAmIHRoaXMubWFzawogICAgdGhpcy5vZmZzZXQrKwoKICAgIC8vIHJlc2V0IG9uIGVtcHR5CiAgICBpZiAodGhpcy5pc0VtcHR5KCkgJiYgdGhpcy5od20gIT09IHRoaXMuZGVmYXVsdEh3bSkgewogICAgICB0aGlzLmJ1ZmZlciA9IG5ldyBBcnJheSh0aGlzLmRlZmF1bHRId20pCiAgICAgIHRoaXMuaHdtID0gdGhpcy5idWZmZXIubGVuZ3RoCiAgICAgIHRoaXMubWFzayA9IHRoaXMuaHdtIC0gMQogICAgICB0aGlzLnRvcCA9IHRoaXMuYnRtID0gMAogICAgfQoKICAgIHJldHVybiBsYXN0CiAgfQoKICBnZXQoc2VxKSB7CiAgICBpZiAoc2VxIDwgdGhpcy5vZmZzZXQgfHwgc2VxID49IHRoaXMubGVuZ3RoKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHRoaXMuYnVmZmVyWyh0aGlzLmJ0bSArIChzZXEgLSB0aGlzLm9mZnNldCkpICYgdGhpcy5tYXNrXQogIH0KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBIeXBlcmNvcmUgPSByZXF1aXJlKCdoeXBlcmNvcmUnKQoKY29uc3QgbWVzc2FnZXMgPSByZXF1aXJlKCcuL21lc3NhZ2VzLmpzJykKCmNvbnN0IERFRkFVTFRfTUFOSUZFU1RfVkVSU0lPTiA9IDEKY29uc3QgSU5ERVhfVkVSU0lPTiA9IDEKY29uc3QgTUFYX1RSQUNFX1BFUl9WSUVXID0gMjU2Cgpjb25zdCBFTVBUWSA9IGI0YS5hbGxvYygwKQoKY29uc3QgW05TX1NJR05FUl9OQU1FU1BBQ0VdID0gY3J5cHRvLm5hbWVzcGFjZSgnYXV0b2Jhc2UnLCAxKQoKY2xhc3MgVmlld0NvcmUgewogIGNvbnN0cnVjdG9yKG5hbWUsIGNvcmUsIGJhc2UpIHsKICAgIHRoaXMubmFtZSA9IG5hbWUKICAgIHRoaXMuY29yZSA9IG51bGwKICAgIHRoaXMuYmF0Y2ggPSBudWxsCiAgICB0aGlzLmF0b21pY0JhdGNoID0gbnVsbAogICAgdGhpcy50cmFjZXIgPSBuZXcgVHJhY2VyKCkKCiAgICB0aGlzLm1pZ3JhdGVkKGJhc2UsIGNvcmUpCiAgfQoKICBnZXRDb3JlKCkgewogICAgcmV0dXJuIHRoaXMuYXRvbWljQmF0Y2ggfHwgdGhpcy5iYXRjaCB8fCB0aGlzLmNvcmUKICB9CgogIG1pZ3JhdGVkKGJhc2UsIGNvcmUpIHsKICAgIC8vIFRPRE86IGNsb3NlIG9sZCBjb3JlIGlmIHByZXNlbnQsIGZvciBub3cgd2UganVzdCBjbG9zZSB3aGVuIHRoZSBhdXRvYmFzZSBpcyBjbG9zZWQgaW5kaXJlY3RseQogICAgLy8gYXRtIGl0cyB1bnNhZmUgdG8gZG8gYXMgbW92ZVRvIGhhcyBhIGJ1ZyBkdWUgdG8gYSBtaXNzaW5nIHJlYWQgbG9jayBpbiBoYwogICAgdGhpcy5jb3JlID0gY29yZQoKICAgIGlmICh0aGlzLm5hbWUgPT09ICdfc3lzdGVtJykgewogICAgICBjb25zdCBmZiA9IGJhc2UuX3F1ZXVlRmFzdEZvcndhcmQuYmluZChiYXNlKQogICAgICB0aGlzLmNvcmUub24oJ2FwcGVuZCcsIGZmKQogICAgICB0aGlzLmNvcmUucmVhZHkoKS50aGVuKGZmLCBmZikKICAgIH0KICB9CgogIGFzeW5jIG1hdGNoZXNLZXkoa2V5KSB7CiAgICBpZiAoIXRoaXMuY29yZS5vcGVuZWQpIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCiAgICByZXR1cm4gYjRhLmVxdWFscyh0aGlzLmNvcmUua2V5LCBrZXkpCiAgfQoKICBhc3luYyBtYXRjaGVzTmFtZXNwYWNlKHRhcmdldCkgewogICAgaWYgKCF0aGlzLmNvcmUub3BlbmVkKSBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQoKICAgIGlmICh0aGlzLmNvcmUubWFuaWZlc3QgJiYgdGhpcy5jb3JlLm1hbmlmZXN0LnNpZ25lcnMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBucyA9IHRoaXMuY29yZS5tYW5pZmVzdC5zaWduZXJzWzBdLm5hbWVzcGFjZQogICAgICBpZiAoYjRhLmVxdWFscyhucywgdGFyZ2V0KSkgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIGFzeW5jIGNvbW1pdChhdG9tLCBsZW5ndGgsIHNpZ25hdHVyZSkgewogICAgLy8gVE9ETzogaXMgdGhpcyBob3cgaXRzIHN1cHBvc2VkIGJlIGRvbmUgYXRvbWljIHdpc2U/CiAgICBhd2FpdCB0aGlzLmNvcmUuY29tbWl0KHRoaXMuX2dldEF0b21pY0JhdGNoKGF0b20pLCB7IGxlbmd0aCwgc2lnbmF0dXJlIH0pCiAgfQoKICBhc3luYyByZWxlYXNlKCkgewogICAgaWYgKCF0aGlzLmF0b21pY0JhdGNoKSByZXR1cm4KICAgIGF3YWl0IHRoaXMuYXRvbWljQmF0Y2gucmVhZHkoKQogICAgY29uc3Qgc2Vzc2lvbnMgPSB0aGlzLmF0b21pY0JhdGNoLnN0YXRlLnNlc3Npb25zCiAgICBmb3IgKGxldCBpID0gc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgaWYgKCFzZXNzaW9uc1tpXSkgYnJlYWsgLy8gY2xvc2VkIGJlZm9yZSB1cwogICAgICBhd2FpdCBzZXNzaW9uc1tpXS5jbG9zZSgpCiAgICB9CiAgICBhd2FpdCB0aGlzLmF0b21pY0JhdGNoLmNsb3NlKCkKICAgIHRoaXMuYXRvbWljQmF0Y2ggPSBudWxsCiAgfQoKICBfZ2V0QXRvbWljQmF0Y2goYXRvbSkgewogICAgaWYgKHRoaXMuYXRvbWljQmF0Y2ggPT09IG51bGwpIHsKICAgICAgdGhpcy5hdG9taWNCYXRjaCA9IHRoaXMuYmF0Y2guc2Vzc2lvbih7IGF0b20sIHdyaXRhYmxlOiB0cnVlIH0pCiAgICB9CgogICAgcmV0dXJuIHRoaXMuYXRvbWljQmF0Y2gKICB9CgogIGFzeW5jIGNhdGNodXAoYXRvbSwgbGVuZ3RoKSB7CiAgICBhd2FpdCB0aGlzLnJlbGVhc2UoKQogICAgY29uc3QgYmF0Y2ggPSB0aGlzLl9nZXRBdG9taWNCYXRjaChhdG9tKQogICAgYXdhaXQgYmF0Y2gucmVhZHkoKQogICAgYXdhaXQgYmF0Y2guc3RhdGUuY2F0Y2h1cChsZW5ndGgpCiAgfQoKICBjcmVhdGVTZXNzaW9uKGF0b20sIHZhbHVlRW5jb2RpbmcpIHsKICAgIGlmICh0aGlzLmJhdGNoID09PSBudWxsKSB7CiAgICAgIHRoaXMuYmF0Y2ggPSB0aGlzLmNvcmUuc2Vzc2lvbih7IG5hbWU6ICdiYXRjaCcsIHdyaXRhYmxlOiB0cnVlIH0pCiAgICB9CgogICAgY29uc3QgcyA9IGF0b20KICAgICAgPyB0aGlzLl9nZXRBdG9taWNCYXRjaChhdG9tKS5zZXNzaW9uKHsKICAgICAgICAgIHZhbHVlRW5jb2RpbmcsCiAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgIG9uc2VxOiB0aGlzLnRyYWNlci5vbnNlcS5iaW5kKHRoaXMudHJhY2VyKQogICAgICAgIH0pCiAgICAgIDogdGhpcy5iYXRjaC5zZXNzaW9uKHsgdmFsdWVFbmNvZGluZywgd3JpdGFibGU6IGZhbHNlIH0pCgogICAgcmV0dXJuIHMKICB9Cn0KCmNsYXNzIFRyYWNlciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZQogICAgdGhpcy5zZWVuID0gbmV3IFNldCgpCiAgfQoKICBzdGFydCgpIHsKICAgIHRoaXMuZW5hYmxlZCA9IHRydWUKICAgIHRoaXMuc2Vlbi5jbGVhcigpCiAgfQoKICBlbmQoKSB7CiAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZQogICAgcmV0dXJuIFsuLi50aGlzLnNlZW4udmFsdWVzKCldCiAgfQoKICBvbnNlcShzZXEsIGNvcmUpIHsKICAgIGlmICghdGhpcy5lbmFibGVkKSByZXR1cm4KICAgIGlmICh0aGlzLnNlZW4uc2l6ZSA+PSBNQVhfVFJBQ0VfUEVSX1ZJRVcpIHJldHVybgogICAgaWYgKHNlcSA+PSBjb3JlLnNpZ25lZExlbmd0aCkgcmV0dXJuCgogICAgdGhpcy5zZWVuLmFkZChzZXEpCiAgfQp9CgpjbGFzcyBBdXRvU3RvcmUgewogIGNvbnN0cnVjdG9yKGJhc2UsIGJ5TmFtZSkgewogICAgdGhpcy5iYXNlID0gYmFzZQogICAgdGhpcy5zdG9yZSA9IGJhc2Uuc3RvcmUKICAgIHRoaXMuYnlOYW1lID0gYnlOYW1lIHx8IG5ldyBNYXAoKQogICAgdGhpcy5vcGVuZWQgPSBbXQogICAgdGhpcy5hdG9tID0gbnVsbAogICAgdGhpcy5sb2NhbCA9IG51bGwKICB9CgogIGFzeW5jIGNsb3NlKCkgewogICAgaWYgKHRoaXMubG9jYWwpIGF3YWl0IHRoaXMubG9jYWwuY2xvc2UoKQogICAgZm9yIChjb25zdCB2IG9mIHRoaXMuYnlOYW1lLnZhbHVlcygpKSB7CiAgICAgIGF3YWl0IHYucmVsZWFzZSgpCiAgICB9CiAgICBpZiAodGhpcy5hdG9tKSByZXR1cm4KICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLmJ5TmFtZS52YWx1ZXMoKSkgewogICAgICBpZiAodi5jb3JlKSBhd2FpdCB2LmNvcmUuY2xvc2UoKQogICAgICBpZiAodi5iYXRjaCkgYXdhaXQgdi5iYXRjaC5jbG9zZSgpCiAgICB9CiAgfQoKICBhc3luYyBleHBvcnQoKSB7CiAgICBjb25zdCB2aWV3cyA9IFtdCgogICAgZm9yIChjb25zdCBbbmFtZSwgdmFsdWVdIG9mIHRoaXMuYnlOYW1lKSB7CiAgICAgIGNvbnN0IGNvcmUgPSBhd2FpdCB0aGlzLnN0b3JlLnN0b3JhZ2UuZXhwb3J0KHZhbHVlLmNvcmUuZGlzY292ZXJ5S2V5LCB7IGJhdGNoZXM6IHRydWUgfSkKICAgICAgdmlld3MucHVzaCh7IG5hbWUsIGNvcmUgfSkKICAgIH0KCiAgICByZXR1cm4gdmlld3MKICB9CgogIGF0b21pemUoKSB7CiAgICBjb25zdCBzdG9yZSA9IG5ldyBBdXRvU3RvcmUodGhpcy5iYXNlLCB0aGlzLmJ5TmFtZSkKICAgIHN0b3JlLmF0b20gPSB0aGlzLnN0b3JlLnN0b3JhZ2UuY3JlYXRlQXRvbSgpCiAgICByZXR1cm4gc3RvcmUKICB9CgogIGFzeW5jIHVwZGF0ZUxvY2FsKCkgewogICAgaWYgKCF0aGlzLmxvY2FsKSByZXR1cm4KICAgIGF3YWl0IHRoaXMubG9jYWwuY2xvc2UoKQogICAgdGhpcy5sb2NhbCA9IG51bGwKICB9CgogIGZsdXNoKCkgewogICAgcmV0dXJuIHRoaXMuYXRvbSA/IHRoaXMuYXRvbS5mbHVzaCgpIDogUHJvbWlzZS5yZXNvbHZlKCkKICB9CgogIGdldChvcHRzLCBtb3JlT3B0cykgewogICAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgbmFtZTogb3B0cyB9CiAgICBpZiAobW9yZU9wdHMpIG9wdHMgPSB7IC4uLm9wdHMsIC4uLm1vcmVPcHRzIH0KCiAgICBjb25zdCB7IG5hbWUsIHZhbHVlRW5jb2RpbmcgPSBudWxsIH0gPSBvcHRzCgogICAgaWYgKCFuYW1lKSB0aHJvdyBuZXcgRXJyb3IoJ25hbWUgaXMgcmVxdWlyZWQnKQogICAgcmV0dXJuIHRoaXMuZ2V0Vmlld0J5TmFtZShuYW1lKS5jcmVhdGVTZXNzaW9uKHRoaXMuYXRvbSwgdmFsdWVFbmNvZGluZykKICB9CgogIGdldFZpZXdCeU5hbWUobmFtZSkgewogICAgbGV0IHZpZXcgPSB0aGlzLmJ5TmFtZS5nZXQobmFtZSkKCiAgICBpZiAoIXZpZXcpIHsKICAgICAgY29uc3QgcHJlbG9hZCA9IHRoaXMuX3ByZWxvYWQobmFtZSkKICAgICAgY29uc3QgY29yZSA9IHRoaXMuYmFzZS5zdG9yZS5nZXQoeyBwcmVsb2FkIH0pCiAgICAgIHZpZXcgPSBuZXcgVmlld0NvcmUobmFtZSwgY29yZSwgdGhpcy5iYXNlKQogICAgICB0aGlzLmJ5TmFtZS5zZXQobmFtZSwgdmlldykKICAgIH0KCiAgICBpZiAodGhpcy5vcGVuZWQuaW5kZXhPZih2aWV3KSA9PT0gLTEpIHsKICAgICAgdGhpcy5vcGVuZWQucHVzaCh2aWV3KQogICAgfQoKICAgIHJldHVybiB2aWV3CiAgfQoKICBnZXRMb2NhbCgpIHsKICAgIGlmICh0aGlzLmxvY2FsICE9PSBudWxsKSByZXR1cm4gdGhpcy5sb2NhbAoKICAgIHRoaXMubG9jYWwgPSB0aGlzLmJhc2UubG9jYWwuc2Vzc2lvbih7CiAgICAgIGF0b206IHRoaXMuYXRvbSwKICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlLAogICAgICBlbmNyeXB0aW9uOiB0aGlzLmJhc2UuZ2V0V3JpdGVyRW5jcnlwdGlvbih0aGlzLmJhc2UubG9jYWwua2V5KSwKICAgICAgYWN0aXZlOiBmYWxzZQogICAgfSkKCiAgICByZXR1cm4gdGhpcy5sb2NhbAogIH0KCiAgZ2V0Vmlld3MoKSB7CiAgICByZXR1cm4gWy4uLnRoaXMuYnlOYW1lLnZhbHVlcygpXQogIH0KCiAgZ2V0Vmlld0NvdW50KCkgewogICAgcmV0dXJuIHRoaXMuYnlOYW1lLnNpemUKICB9CgogIGdldFN5c3RlbVZpZXcoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRWaWV3QnlOYW1lKCdfc3lzdGVtJykKICB9CgogIGdldFN5c3RlbUNvcmUoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRTeXN0ZW1WaWV3KCkuY29yZQogIH0KCiAgZ2V0RW5jcnlwdGlvbihuYW1lKSB7CiAgICBpZiAoIXRoaXMuYmFzZS5lbmNyeXB0aW9uS2V5KSByZXR1cm4gbnVsbAogICAgaWYgKG5hbWUgPT09ICdfZW5jcnlwdGlvbicpIHJldHVybiBudWxsCgogICAgcmV0dXJuIHRoaXMuYmFzZS5lbmNyeXB0aW9uLmdldFZpZXdFbmNyeXB0aW9uKG5hbWUpCiAgfQoKICBhc3luYyBnZXRJbmRleGVyTWFuaWZlc3RzKGVudHJpZXMpIHsKICAgIGNvbnN0IG1hbmlmZXN0cyA9IFtdCiAgICBmb3IgKGNvbnN0IHsga2V5IH0gb2YgZW50cmllcykgewogICAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoeyBrZXksIGFjdGl2ZTogZmFsc2UgfSkKICAgICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICAgIGlmICghY29yZS5tYW5pZmVzdCkgY29udGludWUgLy8gZGFuZ2VyIGJ1dCBvbmx5IGZvciBib290c3RyYXBwaW5nLi4uCiAgICAgIG1hbmlmZXN0cy5wdXNoKGNvcmUubWFuaWZlc3QpCiAgICAgIGF3YWl0IGNvcmUuY2xvc2UoKQogICAgfQogICAgcmV0dXJuIG1hbmlmZXN0cwogIH0KCiAgZ2V0Vmlld0NvcmUoaW5kZXhlck1hbmlmZXN0cywgbmFtZSwgcHJvbG9ndWUsIG1hbmlmZXN0VmVyc2lvbiwgZW50cm9weSwgbGlua2VkLCBtYW5pZmVzdERhdGEpIHsKICAgIGNvbnN0IG1hbmlmZXN0ID0gdGhpcy5fY3JlYXRlTWFuaWZlc3QoCiAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgIG5hbWUsCiAgICAgIHByb2xvZ3VlLAogICAgICBtYW5pZmVzdFZlcnNpb24sCiAgICAgIGVudHJvcHksCiAgICAgIGxpbmtlZCwKICAgICAgbWFuaWZlc3REYXRhCiAgICApCgogICAgcmV0dXJuIHRoaXMuYmFzZS5zdG9yZS5nZXQoewogICAgICBtYW5pZmVzdCwKICAgICAgZXhjbHVzaXZlOiBmYWxzZSwKICAgICAgZW5jcnlwdGlvbjogdGhpcy5nZXRFbmNyeXB0aW9uKG5hbWUpCiAgICB9KQogIH0KCiAgbGlzdFZpZXdzKCkgewogICAgY29uc3Qgdmlld3MgPSBbXQogICAgZm9yIChjb25zdCBbbmFtZSwgcmVmXSBvZiB0aGlzLmJ5TmFtZSkgewogICAgICBjb25zdCBjb3JlID0gcmVmLmJhdGNoIHx8IHJlZi5jb3JlCiAgICAgIHZpZXdzLnB1c2goeyBuYW1lLCBrZXk6IGNvcmUua2V5LCBsZW5ndGg6IGNvcmUubGVuZ3RoLCBzaWduZWRMZW5ndGg6IGNvcmUuc2lnbmVkTGVuZ3RoIH0pCiAgICB9CiAgICByZXR1cm4gdmlld3MKICB9CgogIGNyZWF0ZUFuY2hvckNvcmUocHJvbG9ndWUsIG1hbmlmZXN0RGF0YSkgewogICAgY29uc3QgbWFuaWZlc3QgPSB7CiAgICAgIHZlcnNpb246IDIsCiAgICAgIGhhc2g6ICdibGFrZTJiJywKICAgICAgcHJvbG9ndWUsCiAgICAgIGFsbG93UGF0Y2g6IGZhbHNlLAogICAgICBxdW9ydW06IDAsCiAgICAgIHNpZ25lcnM6IFtdLAogICAgICB1c2VyRGF0YTogbWFuaWZlc3REYXRhLAogICAgICBsaW5rZWQ6IG51bGwKICAgIH0KCiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoewogICAgICBtYW5pZmVzdCwKICAgICAgYWN0aXZlOiBmYWxzZQogICAgfSkKCiAgICByZXR1cm4gY29yZQogIH0KCiAgYXN5bmMgY3JlYXRlVmlldygKICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICBuYW1lLAogICAgcHJvbG9ndWUsCiAgICBtYW5pZmVzdFZlcnNpb24sCiAgICBlbnRyb3B5LAogICAgbGlua2VkLAogICAgbWFuaWZlc3REYXRhCiAgKSB7CiAgICBjb25zdCBtYW5pZmVzdCA9IHRoaXMuX2NyZWF0ZU1hbmlmZXN0KAogICAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgICBuYW1lLAogICAgICBwcm9sb2d1ZSwKICAgICAgbWFuaWZlc3RWZXJzaW9uLAogICAgICBlbnRyb3B5LAogICAgICBsaW5rZWQsCiAgICAgIG1hbmlmZXN0RGF0YQogICAgKQoKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7CiAgICAgIGtleTogSHlwZXJjb3JlLmtleShtYW5pZmVzdCksCiAgICAgIG1hbmlmZXN0LAogICAgICBhY3RpdmU6IGZhbHNlCiAgICB9KQoKICAgIGF3YWl0IGNvcmUucmVhZHkoKQogICAgY29uc3Qga2V5ID0gY29yZS5rZXkKCiAgICBhd2FpdCBjb3JlLmNsb3NlKCkKICAgIHJldHVybiBrZXkKICB9CgogIGFzeW5jIF9wcmVsb2FkKG5hbWUpIHsKICAgIGF3YWl0IFByb21pc2UucmVzb2x2ZSgpCgogICAgaWYgKCF0aGlzLmJhc2Uub3BlbmluZykgdGhyb3cgbmV3IEVycm9yKCdBdXRvYmFzZSBmYWlsZWQgdG8gb3BlbicpCiAgICBhd2FpdCB0aGlzLmJhc2UuX3ByZW9wZW4KCiAgICBjb25zdCBib290ID0gKGF3YWl0IHRoaXMuYmFzZS5fZ2V0U3lzdGVtSW5mbygpKSB8fCB7CiAgICAgIGtleTogdGhpcy5nZXRCb290c3RyYXBTeXN0ZW1LZXkoKSwKICAgICAgaW5kZXhlcnM6IFtdLAogICAgICB2aWV3czogW10sCiAgICAgIGVudHJvcHk6IG51bGwKICAgIH0KICAgIGNvbnN0IGluZGV4ZXJNYW5pZmVzdHMgPSBhd2FpdCB0aGlzLmdldEluZGV4ZXJNYW5pZmVzdHMoYm9vdC5pbmRleGVycykKCiAgICAvLyBubyBzeXN0ZW0sIGV2ZXJ5dGhpbmcgaXMgZnJlc2gKICAgIGlmIChib290LmluZGV4ZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gdGhpcy5fZnJlc2hDb3JlUHJlbG9hZChpbmRleGVyTWFuaWZlc3RzLCBuYW1lLCBib290LmVudHJvcHkpCiAgICB9CgogICAgLy8gYXNraW5nIGZvciB0aGUgc3lzdGVtLCBqdXN0IHJldHVybiBpdCwgZWFzeQogICAgaWYgKG5hbWUgPT09ICdfc3lzdGVtJykgewogICAgICByZXR1cm4gewogICAgICAgIGtleTogYm9vdC5rZXksCiAgICAgICAgZXhjbHVzaXZlOiBmYWxzZSwKICAgICAgICBlbmNyeXB0aW9uOiB0aGlzLmdldEVuY3J5cHRpb24obmFtZSkKICAgICAgfQogICAgfQoKICAgIGlmIChuYW1lID09PSAnX2VuY3J5cHRpb24nKSB7CiAgICAgIGNvbnN0IGNvcmUgPSB0aGlzLmdldFN5c3RlbUNvcmUoKQogICAgICBhd2FpdCBjb3JlLnJlYWR5KCkKCiAgICAgIGlmICghY29yZS5tYW5pZmVzdC5saW5rZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZnJlc2hDb3JlUHJlbG9hZChpbmRleGVyTWFuaWZlc3RzLCBuYW1lLCBib290LmVudHJvcHkpCiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAga2V5OiBjb3JlLm1hbmlmZXN0LmxpbmtlZFswXSwKICAgICAgICBleGNsdXNpdmU6IGZhbHNlLAogICAgICAgIGVuY3J5cHRpb246IG51bGwKICAgICAgfQogICAgfQoKICAgIC8vIGluZmVyIHdoaWNoIHZpZXcKICAgIGNvbnN0IHYgPSBhd2FpdCB0aGlzLmZpbmRWaWV3QnlOYW1lKGluZGV4ZXJNYW5pZmVzdHMsIGJvb3Qudmlld3MsIG5hbWUsIGJvb3QuZW50cm9weSkKCiAgICAvLyBuZXcgdmlldywgZnJlc2gKICAgIGlmICh2ID09PSBudWxsKSB7CiAgICAgIHJldHVybiB0aGlzLl9mcmVzaENvcmVQcmVsb2FkKGluZGV4ZXJNYW5pZmVzdHMsIG5hbWUsIGJvb3QuZW50cm9weSkKICAgIH0KCiAgICByZXR1cm4gewogICAgICBrZXk6IHYua2V5LAogICAgICBleGNsdXNpdmU6IGZhbHNlLAogICAgICBlbmNyeXB0aW9uOiB0aGlzLmdldEVuY3J5cHRpb24obmFtZSkKICAgIH0KICB9CgogIF9mcmVzaENvcmVQcmVsb2FkKGluZGV4ZXJNYW5pZmVzdHMsIG5hbWUsIGVudHJvcHkpIHsKICAgIGlmIChuYW1lID09PSAnX3N5c3RlbScpIHJldHVybiB0aGlzLl9mcmVzaFN5c3RlbVByZWxvYWQoaW5kZXhlck1hbmlmZXN0cywgZW50cm9weSkKCiAgICByZXR1cm4gewogICAgICBtYW5pZmVzdDogdGhpcy5fY3JlYXRlTWFuaWZlc3QoCiAgICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgICBuYW1lLAogICAgICAgIG51bGwsCiAgICAgICAgREVGQVVMVF9NQU5JRkVTVF9WRVJTSU9OLAogICAgICAgIGVudHJvcHksCiAgICAgICAgW10sCiAgICAgICAgbnVsbAogICAgICApLAogICAgICBleGNsdXNpdmU6IHRydWUsCiAgICAgIGVuY3J5cHRpb246IHRoaXMuZ2V0RW5jcnlwdGlvbihuYW1lKQogICAgfQogIH0KCiAgX2ZyZXNoU3lzdGVtUHJlbG9hZChpbmRleGVyTWFuaWZlc3RzLCBlbnRyb3B5KSB7CiAgICByZXR1cm4gewogICAgICBtYW5pZmVzdDogdGhpcy5fY3JlYXRlU3lzdGVtTWFuaWZlc3QoCiAgICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgICBudWxsLAogICAgICAgIERFRkFVTFRfTUFOSUZFU1RfVkVSU0lPTiwKICAgICAgICBlbnRyb3B5LAogICAgICAgIG51bGwKICAgICAgKSwKICAgICAgZXhjbHVzaXZlOiB0cnVlLAogICAgICBlbmNyeXB0aW9uOiB0aGlzLmdldEVuY3J5cHRpb24oJ19zeXN0ZW0nKQogICAgfQogIH0KCiAgX2Rlcml2ZVN0YXRpY0hhc2gobmFtZSkgewogICAgLy8ga2V5IGRvZXNudCBtYXR0ZXIuLi4KICAgIHJldHVybiBjcnlwdG8uaGFzaChbdGhpcy5iYXNlLmtleSwgYjRhLmZyb20obmFtZSldKQogIH0KCiAgX2Rlcml2ZU5hbWVzcGFjZShuYW1lLCBlbnRyb3B5KSB7CiAgICBjb25zdCBlbmNyeXB0aW9uSWQgPSBjcnlwdG8uaGFzaCh0aGlzLmJhc2UuZW5jcnlwdGlvbktleSB8fCBFTVBUWSkKICAgIGNvbnN0IHZlcnNpb24gPSBjLmVuY29kZShjLnVpbnQsIElOREVYX1ZFUlNJT04pCiAgICBjb25zdCBib290c3RyYXAgPSB0aGlzLmJhc2Uua2V5CgogICAgcmV0dXJuIGNyeXB0by5oYXNoKFsKICAgICAgTlNfU0lHTkVSX05BTUVTUEFDRSwKICAgICAgdmVyc2lvbiwKICAgICAgYm9vdHN0cmFwLAogICAgICBlbmNyeXB0aW9uSWQsCiAgICAgIGVudHJvcHksCiAgICAgIGI0YS5mcm9tKG5hbWUpCiAgICBdKQogIH0KCiAgYXN5bmMgX2dldENvcmVNYW5pZmVzdChrZXkpIHsKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7IGtleSwgYWN0aXZlOiBmYWxzZSB9KQogICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICBjb25zdCBtYW5pZmVzdCA9IGNvcmUubWFuaWZlc3QKICAgIGF3YWl0IGNvcmUuY2xvc2UoKQogICAgcmV0dXJuIG1hbmlmZXN0CiAgfQoKICBnZXRCb290c3RyYXBTeXN0ZW1LZXkoKSB7CiAgICByZXR1cm4gSHlwZXJjb3JlLmtleSh0aGlzLl9jcmVhdGVTeXN0ZW1NYW5pZmVzdChbXSwgbnVsbCwgREVGQVVMVF9NQU5JRkVTVF9WRVJTSU9OLCBudWxsKSkKICB9CgogIGFzeW5jIGZpbmRWaWV3QnlLZXkoa2V5LCBpbmRleGVycywgbWFuaWZlc3RWZXJzaW9uLCBlbnRyb3B5KSB7CiAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy5ieU5hbWUudmFsdWVzKCkpIHsKICAgICAgaWYgKGF3YWl0IHYubWF0Y2hlc0tleShrZXkpKSByZXR1cm4gdgogICAgfQoKICAgIGNvbnN0IG1hbmlmZXN0ID0gYXdhaXQgdGhpcy5fZ2V0Q29yZU1hbmlmZXN0KGtleSkKICAgIGNvbnN0IHRhcmdldCA9IG1hbmlmZXN0ICYmIG1hbmlmZXN0LnNpZ25lcnMubGVuZ3RoID8gbWFuaWZlc3Quc2lnbmVyc1swXS5uYW1lc3BhY2UgOiBudWxsCgogICAgaWYgKHRhcmdldCkgewogICAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy5ieU5hbWUudmFsdWVzKCkpIHsKICAgICAgICBpZiAoYXdhaXQgdi5tYXRjaGVzTmFtZXNwYWNlKHRhcmdldCkpIHJldHVybiB2CiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBpbmRleGVyTWFuaWZlc3RzID0gYXdhaXQgdGhpcy5nZXRJbmRleGVyTWFuaWZlc3RzKGluZGV4ZXJzKQoKICAgIGlmIChlbnRyb3B5ID09PSBudWxsKSB7CiAgICAgIGVudHJvcHkgPSBpbmRleGVyTWFuaWZlc3RzWzBdLnNpZ25lcnNbMF0ubmFtZXNwYWNlCiAgICB9CgogICAgaWYgKHRhcmdldCkgewogICAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy5ieU5hbWUudmFsdWVzKCkpIHsKICAgICAgICBjb25zdCBuYW1lc3BhY2UgPSB0aGlzLl9kZXJpdmVOYW1lc3BhY2Uodi5uYW1lLCBlbnRyb3B5KQogICAgICAgIGlmIChiNGEuZXF1YWxzKG5hbWVzcGFjZSwgdGFyZ2V0KSkgcmV0dXJuIHYKICAgICAgfQogICAgfQoKICAgIC8vIHByb2IgdGhlIGVtcHR5IHByb2xvZ3VlLCB3ZSBkb250IGhhdmUgbWFuaWZlc3QgZm9yIHRob3NlIGluIEZGIGlmIGxlbj0wCiAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy5ieU5hbWUudmFsdWVzKCkpIHsKICAgICAgY29uc3QgbWFuaWZlc3REYXRhID0gdi5jb3JlID8gdi5jb3JlLm1hbmlmZXN0LnVzZXJEYXRhIDogbnVsbAogICAgICBjb25zdCBtYW5pZmVzdCA9IHRoaXMuX2NyZWF0ZU1hbmlmZXN0KAogICAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgICAgdi5uYW1lLAogICAgICAgIG51bGwsCiAgICAgICAgbWFuaWZlc3RWZXJzaW9uLAogICAgICAgIGVudHJvcHksCiAgICAgICAgW10sCiAgICAgICAgbWFuaWZlc3REYXRhCiAgICAgICkKICAgICAgY29uc3QgbWFuaWZlc3RLZXkgPSBIeXBlcmNvcmUua2V5KG1hbmlmZXN0KQoKICAgICAgaWYgKCFiNGEuZXF1YWxzKG1hbmlmZXN0S2V5LCBrZXkpKSBjb250aW51ZQoKICAgICAgLy8gd2UgZGlkbnQgaGF2ZSB0aGUgY29yZSEgdGhpcyBpcyBiZWNhdXNlIGl0IGlzIGVtcHR5LCBlbnN1cmUgaXRzIG9uIGRpc2sKICAgICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsga2V5OiBtYW5pZmVzdEtleSwgbWFuaWZlc3QsIGFjdGl2ZTogZmFsc2UgfSkKICAgICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICAgIGF3YWl0IGNvcmUuY2xvc2UoKQoKICAgICAgcmV0dXJuIHYKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgYXN5bmMgZmluZFZpZXdCeU5hbWUoaW5kZXhlck1hbmlmZXN0cywgdmlld3MsIG5hbWUsIGVudHJvcHkpIHsKICAgIGlmIChpbmRleGVyTWFuaWZlc3RzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGwKCiAgICBpZiAoZW50cm9weSA9PT0gbnVsbCkgZW50cm9weSA9IGluZGV4ZXJNYW5pZmVzdHNbMF0uc2lnbmVyc1swXS5uYW1lc3BhY2UKICAgIGNvbnN0IG5hbWVzcGFjZSA9IHRoaXMuX2Rlcml2ZU5hbWVzcGFjZShuYW1lLCBlbnRyb3B5KQoKICAgIGZvciAoY29uc3QgdiBvZiB2aWV3cykgewogICAgICBjb25zdCBtYW5pZmVzdCA9IGF3YWl0IHRoaXMuX2dldENvcmVNYW5pZmVzdCh2LmtleSkKICAgICAgaWYgKG1hbmlmZXN0LnNpZ25lcnMubGVuZ3RoID09PSAwKSBjb250aW51ZQoKICAgICAgY29uc3Qgc2lnbmVyID0gbWFuaWZlc3Quc2lnbmVyc1swXQoKICAgICAgaWYgKGI0YS5lcXVhbHMoc2lnbmVyLm5hbWVzcGFjZSwgbmFtZXNwYWNlKSkgcmV0dXJuIHYKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgX2NyZWF0ZU1hbmlmZXN0KGluZGV4ZXJNYW5pZmVzdHMsIG5hbWUsIHByb2xvZ3VlLCB2ZXJzaW9uLCBlbnRyb3B5LCBsaW5rZWQsIG1hbmlmZXN0RGF0YSkgewogICAgaWYgKCFpbmRleGVyTWFuaWZlc3RzLmxlbmd0aCkgewogICAgICBwcm9sb2d1ZSA9IHsKICAgICAgICBoYXNoOiB0aGlzLl9kZXJpdmVTdGF0aWNIYXNoKG5hbWUpLAogICAgICAgIGxlbmd0aDogMAogICAgICB9CiAgICB9IGVsc2UgaWYgKHByb2xvZ3VlICYmIHByb2xvZ3VlLmxlbmd0aCA9PT0gMCkgewogICAgICAvLyBqdXN0IGluIGNhc2UKICAgICAgcHJvbG9ndWUgPSBudWxsCiAgICB9CgogICAgY29uc3Qgc2lnbmVycyA9IFtdCgogICAgaWYgKGluZGV4ZXJNYW5pZmVzdHMubGVuZ3RoICYmIGVudHJvcHkgPT09IG51bGwpIHsKICAgICAgZW50cm9weSA9IGluZGV4ZXJNYW5pZmVzdHNbMF0uc2lnbmVyc1swXS5uYW1lc3BhY2UKICAgIH0KCiAgICBmb3IgKGNvbnN0IG1hbmlmZXN0IG9mIGluZGV4ZXJNYW5pZmVzdHMpIHsKICAgICAgY29uc3Qgc2lnbmVyID0gbWFuaWZlc3Quc2lnbmVyc1swXQoKICAgICAgc2lnbmVycy5wdXNoKHsKICAgICAgICBuYW1lc3BhY2U6IHRoaXMuX2Rlcml2ZU5hbWVzcGFjZShuYW1lLCBlbnRyb3B5KSwKICAgICAgICBzaWduYXR1cmU6ICdlZDI1NTE5JywKICAgICAgICBwdWJsaWNLZXk6IHNpZ25lci5wdWJsaWNLZXkKICAgICAgfSkKICAgIH0KCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICBoYXNoOiAnYmxha2UyYicsCiAgICAgIHByb2xvZ3VlLAogICAgICBhbGxvd1BhdGNoOiB0cnVlLAogICAgICBxdW9ydW06IE1hdGgubWluKHNpZ25lcnMubGVuZ3RoLCAoc2lnbmVycy5sZW5ndGggPj4gMSkgKyAxKSwKICAgICAgc2lnbmVycywKICAgICAgdXNlckRhdGE6IG1hbmlmZXN0RGF0YSwKICAgICAgbGlua2VkOiB2ZXJzaW9uID4gMSA/IGxpbmtlZCA6IG51bGwKICAgIH0KICB9CgogIF9jcmVhdGVTeXN0ZW1NYW5pZmVzdChpbmRleGVyTWFuaWZlc3RzLCBwcm9sb2d1ZSwgdmVyc2lvbiwgZW50cm9weSwgbWFuaWZlc3REYXRhKSB7CiAgICBpZiAocHJvbG9ndWUgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignQ2FuIG9ubHkgZGVyaXZlIGZyZXNoIHN5c3RlbSBjb3JlJykKCiAgICBjb25zdCBsaW5rZWQgPSBbXQoKICAgIGlmICh2ZXJzaW9uID4gREVGQVVMVF9NQU5JRkVTVF9WRVJTSU9OKSB7CiAgICAgIGNvbnN0IGVuY01hbmlmZXN0ID0gdGhpcy5fY3JlYXRlTWFuaWZlc3QoCiAgICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgICAnX2VuY3J5cHRpb24nLAogICAgICAgIG51bGwsCiAgICAgICAgdmVyc2lvbiwKICAgICAgICBlbnRyb3B5LAogICAgICAgIFtdLAogICAgICAgIG1hbmlmZXN0RGF0YQogICAgICApCiAgICAgIGxpbmtlZC5wdXNoKEh5cGVyY29yZS5rZXkoZW5jTWFuaWZlc3QpKQogICAgfQoKICAgIHJldHVybiB0aGlzLl9jcmVhdGVNYW5pZmVzdCgKICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgJ19zeXN0ZW0nLAogICAgICBudWxsLAogICAgICB2ZXJzaW9uLAogICAgICBlbnRyb3B5LAogICAgICBsaW5rZWQsCiAgICAgIG1hbmlmZXN0RGF0YQogICAgKQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBBdXRvU3RvcmUKY29uc3QgSHlwZXJiZWUgPSByZXF1aXJlKCdoeXBlcmJlZScpCmNvbnN0IFN1YkVuY29kZXIgPSByZXF1aXJlKCdzdWItZW5jb2RlcicpCmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCgpjb25zdCB7IEluZm8sIE1lbWJlciB9ID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCmNvbnN0IHsgREVGQVVMVF9BVVRPQkFTRV9WRVJTSU9OIH0gPSByZXF1aXJlKCcuL2NhcHMuanMnKQoKY29uc3Qgc3VicyA9IG5ldyBTdWJFbmNvZGVyKCkKCmNvbnN0IERJR0VTVCA9IHN1YnMuc3ViKGI0YS5mcm9tKFswXSkpCmNvbnN0IE1FTUJFUlMgPSBzdWJzLnN1YihiNGEuZnJvbShbMV0pKQoKY29uc3QgSU5GT19LRVkgPSBESUdFU1QuZW5jb2RlKCdpbmZvJykKCmNvbnN0IFtHRU5FU0lTX0VOVFJPUFksIE5TX0VOVFJPUFldID0gY3J5cHRvLm5hbWVzcGFjZSgnYXV0b2Jhc2UvZW50cm9weScsIDIpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFN5c3RlbVZpZXcgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3Rvcihjb3JlLCB7IGNoZWNrb3V0ID0gMCwgZW1wdHkgPSBmYWxzZSB9ID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmNvcmUgPSBjb3JlCgogICAgLy8gc2Vzc2lvbnMgaXMgYSB3b3JrYXJvdW5kIGZvciBiYXRjaGVzIG5vdCBoYXZpbmcgc2Vzc2lvbnMgYXRtLi4uCiAgICB0aGlzLmRiID0gbmV3IEh5cGVyYmVlKGNvcmUsIHsKICAgICAga2V5RW5jb2Rpbmc6ICdiaW5hcnknLAogICAgICBleHRlbnNpb246IGZhbHNlLAogICAgICBjaGVja291dCwKICAgICAgc2Vzc2lvbnM6IHR5cGVvZiBjb3JlLnNlc3Npb24gPT09ICdmdW5jdGlvbicKICAgIH0pCgogICAgdGhpcy52ZXJzaW9uID0gREVGQVVMVF9BVVRPQkFTRV9WRVJTSU9OCiAgICB0aGlzLm1lbWJlcnMgPSAwCiAgICB0aGlzLnBlbmRpbmdJbmRleGVycyA9IFtdCiAgICB0aGlzLmluZGV4ZXJzID0gW10KICAgIHRoaXMuaGVhZHMgPSBbXQogICAgdGhpcy52aWV3cyA9IFtdCiAgICB0aGlzLmVuY3J5cHRpb25MZW5ndGggPSAwCiAgICB0aGlzLmVudHJvcHkgPSBudWxsCgogICAgdGhpcy5pbmRleGVyVXBkYXRlID0gZmFsc2UKCiAgICB0aGlzLl9lbXB0eSA9IGVtcHR5CiAgICB0aGlzLl9mb3JrID0gMAogICAgdGhpcy5fbGVuZ3RoID0gMAogICAgdGhpcy5fY2hhbmdlcyA9IFtdCiAgICB0aGlzLl9pbmRleGVyTWFwID0gbmV3IE1hcCgpCiAgICB0aGlzLl9jbG9ja1VwZGF0ZXMgPSBuZXcgTWFwKCkKICB9CgogIHN0YXRpYyBHRU5FU0lTX0VOVFJPUFkgPSBHRU5FU0lTX0VOVFJPUFkKCiAgc3RhdGljIGFzeW5jIGdldEluZGV4ZWRJbmZvKGNvcmUsIGxlbmd0aCkgewogICAgY29uc3Qgc3lzID0gbmV3IHRoaXMoY29yZS5zZXNzaW9uKCkpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHN5cy5nZXRJbmRleGVkSW5mbyhsZW5ndGgpCiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCBzeXMuY2xvc2UoKQogICAgfQogIH0KCiAgc3RhdGljIGFzeW5jICpmbHVzaGVzKGNvcmUsIHsgcmV2ZXJzZSwgbHQgPSBjb3JlLmxlbmd0aCwgZ3RlID0gMCwgd2FpdCA9IHRydWUgfSA9IHt9KSB7CiAgICBpZiAobHQgPD0gMCkgcmV0dXJuCgogICAgLy8gZW5zdXJlIGJsb2NrCiAgICBhd2FpdCBjb3JlLmdldChsdCAtIDEpCiAgICBjb25zdCBzeXMgPSBuZXcgU3lzdGVtVmlldyhjb3JlKQoKICAgIHRyeSB7CiAgICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiBzeXMuZGIuY3JlYXRlSGlzdG9yeVN0cmVhbSh7IGx0LCBndGUsIHdhaXQsIHJldmVyc2U6IHRydWUgfSkpIHsKICAgICAgICBpZiAoIWI0YS5lcXVhbHMoZGF0YS5rZXksIElORk9fS0VZKSkgY29udGludWUKICAgICAgICBjb25zdCBpbmZvID0gYy5kZWNvZGUoSW5mbywgZGF0YS52YWx1ZSkKICAgICAgICB5aWVsZCB7IGxlbmd0aDogZGF0YS5zZXEgKyAxLCBpbmZvIH0KICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgc3lzLmNsb3NlKCkKICAgIH0KICB9CgogIGdldCBib290c3RyYXBwaW5nKCkgewogICAgcmV0dXJuIHRoaXMubWVtYmVycyA9PT0gMAogIH0KCiAgYXN5bmMgY2hlY2tvdXQobGVuZ3RoKSB7CiAgICBjb25zdCBjaGVja291dCA9IG5ldyBTeXN0ZW1WaWV3KHRoaXMuY29yZS5zZXNzaW9uKCksIHsKICAgICAgY2hlY2tvdXQ6IGxlbmd0aCwKICAgICAgZW1wdHk6IGxlbmd0aCA9PT0gMAogICAgfSkKCiAgICBhd2FpdCBjaGVja291dC5yZWFkeSgpCgogICAgcmV0dXJuIGNoZWNrb3V0CiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIC8vIHRoaXMgc2hvdWxkIE5FVkVSIGZhaWwsIGlmIHNvIHdlIGhhdmUgYSBidWcgZWxzZXdoZXJlIChzaG91bGQgYWx3YXlzIGJlIGNvbnNpc3RlbnQpCiAgICBjb25zdCBpbmZvID0gdGhpcy5fZW1wdHkKICAgICAgPyBudWxsCiAgICAgIDogYXdhaXQgdGhpcy5kYi5nZXQoJ2luZm8nLCB7CiAgICAgICAgICB2YWx1ZUVuY29kaW5nOiBJbmZvLAogICAgICAgICAga2V5RW5jb2Rpbmc6IERJR0VTVCwKICAgICAgICAgIHVwZGF0ZTogZmFsc2UsCiAgICAgICAgICB3YWl0OiBmYWxzZQogICAgICAgIH0pCiAgICBhd2FpdCB0aGlzLl9yZXNldChpbmZvKQogIH0KCiAgYXN5bmMgX2Nsb3NlKCkgewogICAgYXdhaXQgdGhpcy5kYi5jbG9zZSgpCiAgfQoKICBhc3luYyBnZXRJbmRleGVkSW5mbyhsZW5ndGggPSB0aGlzLmNvcmUuc2lnbmVkTGVuZ3RoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICBpZiAobGVuZ3RoID09PSB0aGlzLmNvcmUubGVuZ3RoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmVyc2lvbjogdGhpcy52ZXJzaW9uLAogICAgICAgIG1lbWJlcnM6IHRoaXMubWVtYmVycywKICAgICAgICBwZW5kaW5nSW5kZXhlcnM6IHRoaXMucGVuZGluZ0luZGV4ZXJzLAogICAgICAgIGluZGV4ZXJzOiB0aGlzLmluZGV4ZXJzLAogICAgICAgIGhlYWRzOiB0aGlzLmhlYWRzLAogICAgICAgIHZpZXdzOiB0aGlzLnZpZXdzLAogICAgICAgIGVuY3J5cHRpb25MZW5ndGg6IHRoaXMuZW5jcnlwdGlvbkxlbmd0aCwKICAgICAgICBlbnRyb3B5OiB0aGlzLmVudHJvcHkKICAgICAgfQogICAgfQoKICAgIGNvbnN0IG5vZGUgPSBsZW5ndGggPT09IDAgPyBudWxsIDogYXdhaXQgdGhpcy5kYi5nZXRCeVNlcShsZW5ndGggLSAxKQogICAgaWYgKG5vZGUgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uOiBERUZBVUxUX0FVVE9CQVNFX1ZFUlNJT04sCiAgICAgICAgbWVtYmVyczogMCwKICAgICAgICBwZW5kaW5nSW5kZXhlcnM6IFtdLAogICAgICAgIGluZGV4ZXJzOiBbXSwKICAgICAgICBoZWFkczogW10sCiAgICAgICAgdmlld3M6IFtdLAogICAgICAgIGVuY3J5cHRpb25MZW5ndGg6IDAsCiAgICAgICAgZW50cm9weTogbnVsbAogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGMuZGVjb2RlKEluZm8sIG5vZGUudmFsdWUpCiAgfQoKICBzdGF0aWMgc2FtZUluZGV4ZXJzKGEsIGIpIHsKICAgIGlmIChhLmxlbmd0aCAhPT0gYi5sZW5ndGgpIHJldHVybiBmYWxzZQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkrKykgewogICAgICBpZiAoIWI0YS5lcXVhbHMoYVtpXS5rZXksIGJbaV0uY29yZS5rZXkpKSByZXR1cm4gZmFsc2UKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgc2FtZUluZGV4ZXJzKGluZGV4ZXJzKSB7CiAgICByZXR1cm4gU3lzdGVtVmlldy5zYW1lSW5kZXhlcnModGhpcy5pbmRleGVycywgaW5kZXhlcnMpCiAgfQoKICBhc3luYyBoaXN0b3J5KHNpbmNlKSB7CiAgICBjb25zdCBjaGVja291dCA9IHRoaXMuZGIuY2hlY2tvdXQoc2luY2UpCiAgICBjb25zdCBzZWVuID0gbmV3IE1hcCgpCgogICAgY29uc3Qgbm9kZXMgPSBbXQogICAgY29uc3QgdXBkYXRlcyA9IFtdCgogICAgY29uc3QgY2hlY2tvdXROb2RlID0gc2luY2UgPT09IDAgPyBudWxsIDogYXdhaXQgdGhpcy5kYi5nZXRCeVNlcShzaW5jZSAtIDEpCgogICAgbGV0IHByZXZJbmZvID0gY2hlY2tvdXROb2RlID09PSBudWxsID8gbnVsbCA6IGMuZGVjb2RlKEluZm8sIGNoZWNrb3V0Tm9kZS52YWx1ZSkKICAgIGxldCB1cGRhdGVCYXRjaCA9IDAKCiAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgdGhpcy5kYi5jcmVhdGVIaXN0b3J5U3RyZWFtKHsgZ3RlOiBzaW5jZSB9KSkgewogICAgICBpZiAoYjRhLmVxdWFscyhkYXRhLmtleSwgSU5GT19LRVkpKSB7CiAgICAgICAgY29uc3QgaW5mbyA9IGMuZGVjb2RlKEluZm8sIGRhdGEudmFsdWUpCgogICAgICAgIHVwZGF0ZXMucHVzaCh7CiAgICAgICAgICBiYXRjaDogdXBkYXRlQmF0Y2gsCiAgICAgICAgICBpbmRleGVyczogcHJldkluZm8gPT09IG51bGwgfHwgIXNhbWVJbmRleGVycyhpbmZvLCBwcmV2SW5mbyksCiAgICAgICAgICBzeXN0ZW1MZW5ndGg6IGRhdGEuc2VxICsgMQogICAgICAgIH0pCgogICAgICAgIHByZXZJbmZvID0gaW5mbwogICAgICAgIHVwZGF0ZUJhdGNoID0gMAogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGNvbnN0IGtleSA9IGRhdGEua2V5LnN1YmFycmF5KDIpCiAgICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQogICAgICBjb25zdCBsZW4gPSBjLmRlY29kZShNZW1iZXIsIGRhdGEudmFsdWUpLmxlbmd0aAoKICAgICAgaWYgKCFzZWVuLmhhcyhoZXgpKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IGNoZWNrb3V0LmdldChkYXRhLmtleSkKICAgICAgICBpZiAobm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgc2Vlbi5zZXQoaGV4LCAwKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCB7IGxlbmd0aCB9ID0gYy5kZWNvZGUoTWVtYmVyLCBub2RlLnZhbHVlKQogICAgICAgICAgc2Vlbi5zZXQoaGV4LCBsZW5ndGgpCiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCBwcmV2ID0gc2Vlbi5nZXQoaGV4KQogICAgICBjb25zdCBiYXRjaCA9IGxlbiAtIHByZXYKICAgICAgc2Vlbi5zZXQoaGV4LCBsZW4pCgogICAgICBpZiAoYmF0Y2ggPT09IDApIGNvbnRpbnVlCgogICAgICB1cGRhdGVCYXRjaCArPSBiYXRjaAoKICAgICAgaWYgKG5vZGVzLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCB0b3AgPSBub2Rlc1tub2Rlcy5sZW5ndGggLSAxXQogICAgICAgIGlmIChiNGEuZXF1YWxzKHRvcC5rZXksIGtleSkpIHsKICAgICAgICAgIHRvcC5sZW5ndGggPSBsZW4KICAgICAgICAgIHRvcC5iYXRjaCArPSBiYXRjaAogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIG5vZGVzLnB1c2goewogICAgICAgIGtleSwKICAgICAgICBsZW5ndGg6IGxlbiwKICAgICAgICBiYXRjaAogICAgICB9KQogICAgfQoKICAgIGF3YWl0IGNoZWNrb3V0LmNsb3NlKCkKCiAgICByZXR1cm4geyB1cGRhdGVzLCBub2RlcyB9CiAgfQoKICBhc3luYyB1cGRhdGUoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICBpZiAodGhpcy5fZm9yayA9PT0gdGhpcy5jb3JlLmZvcmsgJiYgdGhpcy5fbGVuZ3RoID09PSB0aGlzLmNvcmUubGVuZ3RoKSByZXR1cm4gZmFsc2UKCiAgICBhd2FpdCB0aGlzLl9yZXNldCgKICAgICAgdGhpcy5fZW1wdHkgPyBudWxsIDogYXdhaXQgdGhpcy5kYi5nZXQoJ2luZm8nLCB7IHZhbHVlRW5jb2Rpbmc6IEluZm8sIGtleUVuY29kaW5nOiBESUdFU1QgfSkKICAgICkKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBfcmVzZXQoaW5mbykgewogICAgdGhpcy52ZXJzaW9uID0gaW5mbyA9PT0gbnVsbCA/IERFRkFVTFRfQVVUT0JBU0VfVkVSU0lPTiA6IGluZm8udmFsdWUudmVyc2lvbgogICAgdGhpcy5tZW1iZXJzID0gaW5mbyA9PT0gbnVsbCA/IDAgOiBpbmZvLnZhbHVlLm1lbWJlcnMKICAgIHRoaXMucGVuZGluZ0luZGV4ZXJzID0gaW5mbyA9PT0gbnVsbCA/IFtdIDogaW5mby52YWx1ZS5wZW5kaW5nSW5kZXhlcnMKICAgIHRoaXMuaW5kZXhlcnMgPSBpbmZvID09PSBudWxsID8gW10gOiBpbmZvLnZhbHVlLmluZGV4ZXJzCiAgICB0aGlzLmhlYWRzID0gaW5mbyA9PT0gbnVsbCA/IFtdIDogaW5mby52YWx1ZS5oZWFkcwogICAgdGhpcy52aWV3cyA9IGluZm8gPT09IG51bGwgPyBbXSA6IGluZm8udmFsdWUudmlld3MKICAgIHRoaXMuZW5jcnlwdGlvbkxlbmd0aCA9IGluZm8gPT09IG51bGwgPyAwIDogaW5mby52YWx1ZS5lbmNyeXB0aW9uTGVuZ3RoCiAgICB0aGlzLmVudHJvcHkgPSBpbmZvID09PSBudWxsID8gbnVsbCA6IGluZm8udmFsdWUuZW50cm9weQoKICAgIHRoaXMuaW5kZXhlclVwZGF0ZSA9IGZhbHNlCiAgICB0aGlzLl9pbmRleGVyTWFwLmNsZWFyKCkKICAgIHRoaXMuX2Nsb2NrVXBkYXRlcy5jbGVhcigpCiAgICB0aGlzLl9sZW5ndGggPSB0aGlzLmNvcmUubGVuZ3RoCiAgICB0aGlzLl9mb3JrID0gdGhpcy5jb3JlLmZvcmsKICAgIHRoaXMuX2NoYW5nZXMgPSBbXQoKICAgIGZvciAoY29uc3QgaWR4IG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgdGhpcy5faW5kZXhlck1hcC5zZXQoYjRhLnRvU3RyaW5nKGlkeC5rZXksICdoZXgnKSwgaWR4KQogICAgfQogIH0KCiAgLy8gaGVscGVyIHVzZWQgYnkgYXBwbHktc3RhdGUKICBmbHVzaExlbmd0aCgpIHsKICAgIGNvbnN0IGhlYWRlciA9IHRoaXMuY29yZS5sZW5ndGggPyAwIDogMSAvLyBhY2NvdW50IGZvciBoZWFkZXIKCiAgICBsZXQgdXBkYXRlcyA9IHRoaXMuX2NoYW5nZXMubGVuZ3RoICsgdGhpcy5fY2xvY2tVcGRhdGVzLnNpemUKICAgIGZvciAoY29uc3QgeyBrZXkgfSBvZiB0aGlzLl9jaGFuZ2VzKSB7CiAgICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQogICAgICBpZiAodGhpcy5fY2xvY2tVcGRhdGVzLmhhcyhoZXgpKSB1cGRhdGVzLS0gLy8gc2hhcmVkIGFyZSBza2lwcGVkCiAgICB9CgogICAgcmV0dXJuIGhlYWRlciArIHRoaXMuY29yZS5sZW5ndGggKyB1cGRhdGVzICsgMQogIH0KCiAgYXN5bmMgZmx1c2godmlld3MpIHsKICAgIGNvbnN0IGJhdGNoID0gdGhpcy5kYi5iYXRjaCh7IHVwZGF0ZTogZmFsc2UgfSkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX2NoYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYyA9IHRoaXMuX2NoYW5nZXNbaV0KICAgICAgaWYgKHRoaXMuX2Nsb2NrVXBkYXRlcy5oYXMoYjRhLnRvU3RyaW5nKGMua2V5LCAnaGV4JykpKSBjb250aW51ZQogICAgICBhd2FpdCBiYXRjaC5wdXQoYy5rZXksIGMudmFsdWUsIHsgdmFsdWVFbmNvZGluZzogTWVtYmVyLCBrZXlFbmNvZGluZzogTUVNQkVSUyB9KQogICAgfQoKICAgIGZvciAoY29uc3QgW2hleCwgbGVuZ3RoXSBvZiB0aGlzLl9jbG9ja1VwZGF0ZXMpIHsKICAgICAgY29uc3QgaXNJbmRleGVyID0gdGhpcy5faW5kZXhlck1hcC5nZXQoaGV4KSAhPT0gdW5kZWZpbmVkCiAgICAgIGNvbnN0IGtleSA9IGI0YS5mcm9tKGhleCwgJ2hleCcpCgogICAgICBjb25zdCBpbmZvID0gYXdhaXQgdGhpcy5fZ2V0KGtleSwgMCkKCiAgICAgIGNvbnN0IHZhbHVlID0geyBpc0luZGV4ZXIsIGlzUmVtb3ZlZDogaW5mbyA/IGluZm8uaXNSZW1vdmVkIDogdHJ1ZSwgbGVuZ3RoIH0KICAgICAgYXdhaXQgYmF0Y2gucHV0KGtleSwgdmFsdWUsIHsgdmFsdWVFbmNvZGluZzogTWVtYmVyLCBrZXlFbmNvZGluZzogTUVNQkVSUyB9KQogICAgfQoKICAgIGlmICh0aGlzLmluZGV4ZXJVcGRhdGUpIHsKICAgICAgdGhpcy5fcmVmcmVzaEVudHJvcHkodGhpcy5jb3JlLmxlbmd0aCArIGJhdGNoLmxlbmd0aCArIDEpCiAgICB9CgogICAgdGhpcy5fY2xvY2tVcGRhdGVzLmNsZWFyKCkKCiAgICBsZXQgbWF4SW5kZXggPSAtMQogICAgZm9yIChjb25zdCB2aWV3IG9mIHZpZXdzKSB7CiAgICAgIGlmICh2aWV3Lm1hcHBlZEluZGV4ID4gbWF4SW5kZXgpIG1heEluZGV4ID0gdmlldy5tYXBwZWRJbmRleAogICAgfQoKICAgIHdoaWxlICh0aGlzLnZpZXdzLmxlbmd0aCA+IG1heEluZGV4ICsgMSkgdGhpcy52aWV3cy5wb3AoKQoKICAgIGZvciAoY29uc3QgdmlldyBvZiB2aWV3cykgewogICAgICBjb25zdCBsZW5ndGggPSB2aWV3LmNvcmUgPyB2aWV3LmNvcmUubGVuZ3RoIDogdmlldy5sZW5ndGgKICAgICAgaWYgKCFsZW5ndGgpIGNvbnRpbnVlCgogICAgICBjb25zdCB2ID0geyBrZXk6IHZpZXcua2V5LCBsZW5ndGggfQoKICAgICAgaWYgKHZpZXcubWFwcGVkSW5kZXggIT09IC0xKSB7CiAgICAgICAgdGhpcy52aWV3c1t2aWV3Lm1hcHBlZEluZGV4XSA9IHYKICAgICAgfSBlbHNlIHsKICAgICAgICB2aWV3Lm1hcHBlZEluZGV4ID0gdGhpcy52aWV3cy5wdXNoKHYpIC0gMQogICAgICB9CiAgICB9CgogICAgY29uc3QgaW5mbyA9IHsKICAgICAgdmVyc2lvbjogdGhpcy52ZXJzaW9uLAogICAgICBtZW1iZXJzOiB0aGlzLm1lbWJlcnMsCiAgICAgIHBlbmRpbmdJbmRleGVyczogdGhpcy5wZW5kaW5nSW5kZXhlcnMsCiAgICAgIGluZGV4ZXJzOiB0aGlzLmluZGV4ZXJzLAogICAgICBoZWFkczogdGhpcy5oZWFkcywKICAgICAgdmlld3M6IHRoaXMudmlld3MsCiAgICAgIGVuY3J5cHRpb25MZW5ndGg6IHRoaXMuZW5jcnlwdGlvbkxlbmd0aCwKICAgICAgZW50cm9weTogdGhpcy5lbnRyb3B5CiAgICB9CgogICAgYXdhaXQgYmF0Y2gucHV0KCdpbmZvJywgaW5mbywgeyB2YWx1ZUVuY29kaW5nOiBJbmZvLCBrZXlFbmNvZGluZzogRElHRVNUIH0pCiAgICBhd2FpdCBiYXRjaC5mbHVzaCgpCgogICAgdGhpcy5fbGVuZ3RoID0gdGhpcy5jb3JlLmxlbmd0aCAvLyBzaG91bGQgYmUgb2sKICAgIHRoaXMuX2NoYW5nZXMgPSBbXQoKICAgIGlmICh0aGlzLmluZGV4ZXJVcGRhdGUpIHRoaXMuaW5kZXhlclVwZGF0ZSA9IGZhbHNlCiAgfQoKICBnZXRFbnRyb3B5KGluZGV4ZXJzLCBsZW5ndGgpIHsKICAgIHJldHVybiBnZW5lcmF0ZUVudHJvcHkoaW5kZXhlcnMsIGxlbmd0aCwgdGhpcy5lbnRyb3B5KQogIH0KCiAgX3JlZnJlc2hFbnRyb3B5KGxlbmd0aCkgewogICAgaWYgKHRoaXMudmVyc2lvbiA8IDIpIHJldHVybgogICAgdGhpcy5lbnRyb3B5ID0gdGhpcy5nZXRFbnRyb3B5KHRoaXMuaW5kZXhlcnMsIGxlbmd0aCkKICB9CgogIGNoZWNrcG9pbnQoKSB7CiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiB0aGlzLnZlcnNpb24sCiAgICAgIG1lbWJlcnM6IHRoaXMubWVtYmVycywKICAgICAgcGVuZGluZ0luZGV4ZXJzOiB0aGlzLnBlbmRpbmdJbmRleGVycy5zbGljZSgwKSwKICAgICAgaW5kZXhlcnM6IGNsb25lTm9kZXModGhpcy5pbmRleGVycyksCiAgICAgIGhlYWRzOiBjbG9uZU5vZGVzKHRoaXMuaGVhZHMpLAogICAgICB2aWV3czogY2xvbmVOb2Rlcyh0aGlzLnZpZXdzKSwKICAgICAgaW5kZXhlclVwZGF0ZTogdGhpcy5pbmRleGVyVXBkYXRlLAogICAgICBlbmNyeXB0aW9uTGVuZ3RoOiB0aGlzLmVuY3J5cHRpb25MZW5ndGgsCiAgICAgIGVudHJvcHk6IHRoaXMuZW50cm9weSA/IGI0YS5mcm9tKHRoaXMuZW50cm9weSkgOiBudWxsLAogICAgICBjaGFuZ2VzOiB0aGlzLl9jaGFuZ2VzLnNsaWNlKDApLAogICAgICBjbG9ja1VwZGF0ZXM6IG5ldyBNYXAoWy4uLnRoaXMuX2Nsb2NrVXBkYXRlc10pCiAgICB9CiAgfQoKICBhcHBseUNoZWNrcG9pbnQoY2hlY2twb2ludCkgewogICAgdGhpcy52ZXJzaW9uID0gY2hlY2twb2ludC52ZXJzaW9uCiAgICB0aGlzLm1lbWJlcnMgPSBjaGVja3BvaW50Lm1lbWJlcnMKICAgIHRoaXMucGVuZGluZ0luZGV4ZXJzID0gY2hlY2twb2ludC5wZW5kaW5nSW5kZXhlcnMKICAgIHRoaXMuaW5kZXhlcnMgPSBjaGVja3BvaW50LmluZGV4ZXJzCiAgICB0aGlzLmhlYWRzID0gY2hlY2twb2ludC5oZWFkcwogICAgdGhpcy52aWV3cyA9IGNoZWNrcG9pbnQudmlld3MKICAgIHRoaXMuaW5kZXhlclVwZGF0ZSA9IGNoZWNrcG9pbnQuaW5kZXhlclVwZGF0ZQogICAgdGhpcy5lbmNyeXB0aW9uTGVuZ3RoID0gY2hlY2twb2ludC5lbmNyeXB0aW9uTGVuZ3RoCiAgICB0aGlzLmVudHJvcHkgPSBjaGVja3BvaW50LmVudHJvcHkKCiAgICB0aGlzLl9jaGFuZ2VzID0gY2hlY2twb2ludC5jaGFuZ2VzCiAgICB0aGlzLl9jbG9ja1VwZGF0ZXMgPSBjaGVja3BvaW50LmNsb2NrVXBkYXRlcwoKICAgIHRoaXMuX2luZGV4ZXJNYXAgPSBuZXcgTWFwKCkKICAgIGZvciAoY29uc3QgaWR4IG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgdGhpcy5faW5kZXhlck1hcC5zZXQoYjRhLnRvU3RyaW5nKGlkeC5rZXksICdoZXgnKSwgaWR4KQogICAgfQogIH0KCiAgYWRkSGVhZChub2RlKSB7CiAgICBjb25zdCBoID0geyBrZXk6IG5vZGUud3JpdGVyLmNvcmUua2V5LCBsZW5ndGg6IG5vZGUubGVuZ3RoIH0KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuaGVhZHMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgaGVhZCA9IHRoaXMuaGVhZHNbaV0KCiAgICAgIGlmICghaGFzRGVwZW5kZW5jeShub2RlLCBoZWFkKSkgewogICAgICAgIGlmICghYjRhLmVxdWFscyhub2RlLndyaXRlci5jb3JlLmtleSwgaGVhZC5rZXkpKSBjb250aW51ZQoKICAgICAgICAvLyB0b2RvOiByZW1vdmUgaW4gbmV4dCBtYWpvciBiZWNhdXNlIGJ1ZyB3YXMgZml4ZWQgaGVyZToKICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYXV0b2Jhc2UtbmV4dC9wdWxsLzIzNwoKICAgICAgICAvLyBmaWx0ZXIgb3V0IGFueSBiYWQgaGVhZHMgaW50cm9kdWNlZCBieSBhIGJ1ZyB0bwogICAgICAgIC8vIHByZXZlbnQgaW5jb25zaXN0ZW5jaWVzIGJlaW5nIHdyaXR0ZW4gdG8gdGhlIG9wbG9nCiAgICAgICAgaWYgKGhlYWQubGVuZ3RoID4gaC5sZW5ndGgpIHJldHVybiBmYWxzZQogICAgICB9CgogICAgICBjb25zdCBwb3BwZWQgPSB0aGlzLmhlYWRzLnBvcCgpCiAgICAgIGlmIChwb3BwZWQgIT09IGhlYWQpIHRoaXMuaGVhZHNbaS0tXSA9IHBvcHBlZAogICAgfQoKICAgIHRoaXMuaGVhZHMucHVzaChoKQoKICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhoLmtleSwgJ2hleCcpCgogICAgdGhpcy5fY2xvY2tVcGRhdGVzLnNldChoZXgsIGgubGVuZ3RoKQoKICAgIGlmICh0aGlzLnBlbmRpbmdJbmRleGVycy5sZW5ndGggPiAwKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5wZW5kaW5nSW5kZXhlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoIWI0YS5lcXVhbHModGhpcy5wZW5kaW5nSW5kZXhlcnNbaV0sIGgua2V5KSkgY29udGludWUKICAgICAgICB0aGlzLl91cGRhdGVJbmRleGVyKGgua2V5LCBoLmxlbmd0aCwgdHJ1ZSwgaSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CgogICAgY29uc3QgaWR4ID0gdGhpcy5faW5kZXhlck1hcC5nZXQoaGV4KQogICAgaWYgKGlkeCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGlkeC5sZW5ndGggPSBoLmxlbmd0aAogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX3VwZGF0ZUluZGV4ZXIoa2V5LCBsZW5ndGgsIGlzSW5kZXhlciwgaSkgewogICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpCgogICAgaWYgKCFpc0luZGV4ZXIpIHsKICAgICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLl9pbmRleGVyTWFwLmdldChoZXgpCiAgICAgIGlmIChleGlzdGluZykgewogICAgICAgIHRoaXMuaW5kZXhlclVwZGF0ZSA9IHRydWUKICAgICAgICB0aGlzLmluZGV4ZXJzLnNwbGljZSh0aGlzLmluZGV4ZXJzLmluZGV4T2YoZXhpc3RpbmcpLCAxKQogICAgICAgIHRoaXMuX2luZGV4ZXJNYXAuZGVsZXRlKGhleCkKICAgICAgfQogICAgICByZXR1cm4KICAgIH0KCiAgICBmb3IgKDsgaSA8IHRoaXMucGVuZGluZ0luZGV4ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChiNGEuZXF1YWxzKHRoaXMucGVuZGluZ0luZGV4ZXJzW2ldLCBrZXkpKSB7CiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgaWYgKGkgPj0gdGhpcy5wZW5kaW5nSW5kZXhlcnMubGVuZ3RoKSB0aGlzLnBlbmRpbmdJbmRleGVycy5wdXNoKGtleSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKGkgPCB0aGlzLnBlbmRpbmdJbmRleGVycy5sZW5ndGgpIHsKICAgICAgY29uc3QgdG9wID0gdGhpcy5wZW5kaW5nSW5kZXhlcnMucG9wKCkKICAgICAgaWYgKGkgPCB0aGlzLnBlbmRpbmdJbmRleGVycy5sZW5ndGgpIHRoaXMucGVuZGluZ0luZGV4ZXJzW2ldID0gdG9wCiAgICB9CgogICAgY29uc3QgaWR4ID0gdGhpcy5faW5kZXhlck1hcC5nZXQoaGV4KQoKICAgIGlmIChpZHggPT09IHVuZGVmaW5lZCkgewogICAgICBjb25zdCBuZXdJZHggPSB7IGtleSwgbGVuZ3RoIH0KICAgICAgdGhpcy5faW5kZXhlck1hcC5zZXQoaGV4LCBuZXdJZHgpCiAgICAgIHRoaXMuaW5kZXhlcnMucHVzaChuZXdJZHgpCgogICAgICAvLyBib290c3RyYXAgaXMgInNpbGVudGx5IiBhZGRlZCBzbyB0aGF0IGluaXRpYWwgdmlld3MgaGF2ZSBubyBwcm9sb2d1ZQogICAgICBpZiAoIXRoaXMuYm9vdHN0cmFwcGluZykgdGhpcy5pbmRleGVyVXBkYXRlID0gdHJ1ZQogICAgfSBlbHNlIHsKICAgICAgaWR4Lmxlbmd0aCA9IGxlbmd0aAogICAgfQogIH0KCiAgX3NlZW5MZW5ndGgoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5fY2xvY2tVcGRhdGVzLmdldChiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykpIHx8IDAKICB9CgogIGFzeW5jIGFjayhrZXkpIHsKICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgdGhpcy5fZ2V0KGtleSwgMCkKICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuX3NlZW5MZW5ndGgoa2V5KQogICAgaWYgKHZhbHVlICYmIHZhbHVlLmxlbmd0aCA9PT0gbGVuZ3RoKSByZXR1cm4KCiAgICBjb25zdCBpc0luZGV4ZXIgPSB2YWx1ZSA/IHZhbHVlLmlzSW5kZXhlciA6IGZhbHNlCiAgICBjb25zdCBpc1JlbW92ZWQgPSB2YWx1ZSA/IHZhbHVlLmlzUmVtb3ZlZCA6IHRydWUKCiAgICB0aGlzLl9jaGFuZ2VzLnB1c2goeyBrZXksIHZhbHVlOiB7IGlzSW5kZXhlciwgaXNSZW1vdmVkLCBsZW5ndGggfSB9KQogIH0KCiAgYXN5bmMgYWRkKGtleSwgeyBpc0luZGV4ZXIgPSBmYWxzZSwgbGVuZ3RoID0gdGhpcy5fc2Vlbkxlbmd0aChrZXkpIH0gPSB7fSkgewogICAgbGV0IHZhbHVlID0gbnVsbAogICAgbGV0IGZvdW5kID0gZmFsc2UKICAgIGxldCBjaGFuZ2VkID0gdHJ1ZQoKICAgIGZvciAobGV0IGkgPSB0aGlzLl9jaGFuZ2VzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IGMgPSB0aGlzLl9jaGFuZ2VzW2ldCiAgICAgIGlmIChiNGEuZXF1YWxzKGtleSwgYy5rZXkpKSB7CiAgICAgICAgdmFsdWUgPSBjLnZhbHVlCiAgICAgICAgZm91bmQgPSB0cnVlCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIGlmICghZm91bmQpIHsKICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IHRoaXMuZGIuZ2V0KGtleSwgeyB2YWx1ZUVuY29kaW5nOiBNZW1iZXIsIGtleUVuY29kaW5nOiBNRU1CRVJTIH0pCgogICAgICBpZiAobm9kZSkgewogICAgICAgIHZhbHVlID0gbm9kZS52YWx1ZQogICAgICAgIGZvdW5kID0gdHJ1ZQogICAgICB9CiAgICB9CgogICAgbGV0IHdhc1RyYWNrZWQgPSBmYWxzZQogICAgbGV0IHdhc0luZGV4ZXIgPSBmYWxzZQoKICAgIGlmIChmb3VuZCkgewogICAgICBpZiAoIXZhbHVlLmlzUmVtb3ZlZCkgd2FzVHJhY2tlZCA9IHRydWUKICAgICAgaWYgKHZhbHVlLmlzSW5kZXhlcikgd2FzSW5kZXhlciA9IHRydWUKICAgICAgaWYgKGxlbmd0aCA8IHZhbHVlLmxlbmd0aCkgbGVuZ3RoID0gdmFsdWUubGVuZ3RoCiAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IGxlbmd0aCAmJiB2YWx1ZS5pc0luZGV4ZXIgPT09IGlzSW5kZXhlciAmJiB2YWx1ZS5pc1JlbW92ZWQgPT09IGZhbHNlKQogICAgICAgIGNoYW5nZWQgPSBmYWxzZQogICAgfQoKICAgIGlmIChjaGFuZ2VkKSB7CiAgICAgIHRoaXMuX2NoYW5nZXMucHVzaCh7IGtleSwgdmFsdWU6IHsgaXNJbmRleGVyLCBpc1JlbW92ZWQ6IGZhbHNlLCBsZW5ndGggfSB9KQogICAgfQoKICAgIGlmICghd2FzVHJhY2tlZCkgdGhpcy5tZW1iZXJzKysKICAgIGlmICh3YXNJbmRleGVyIHx8IGlzSW5kZXhlcikgdGhpcy5fdXBkYXRlSW5kZXhlcihrZXksIGxlbmd0aCwgaXNJbmRleGVyLCAwKQogIH0KCiAgYXN5bmMgcmVtb3ZlKGtleSkgewogICAgbGV0IGlzSW5kZXhlciA9IGZhbHNlCgogICAgZm9yIChjb25zdCBpZHggb2YgdGhpcy5pbmRleGVycykgewogICAgICBpc0luZGV4ZXIgPSBiNGEuZXF1YWxzKGlkeC5rZXksIGtleSkKICAgICAgaWYgKGlzSW5kZXhlcikgYnJlYWsKICAgIH0KCiAgICBpZiAoaXNJbmRleGVyKSB0aGlzLl91cGRhdGVJbmRleGVyKGtleSwgbnVsbCwgZmFsc2UsIDApCgogICAgbGV0IHZhbHVlID0gbnVsbAogICAgbGV0IGZvdW5kID0gZmFsc2UKCiAgICBmb3IgKGxldCBpID0gdGhpcy5fY2hhbmdlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBjID0gdGhpcy5fY2hhbmdlc1tpXQogICAgICBpZiAoYjRhLmVxdWFscyhrZXksIGMua2V5KSkgewogICAgICAgIHZhbHVlID0gYy52YWx1ZQogICAgICAgIGZvdW5kID0gdHJ1ZQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KCiAgICBpZiAoIWZvdW5kKSB7CiAgICAgIGNvbnN0IG5vZGUgPSBhd2FpdCB0aGlzLmRiLmdldChrZXksIHsgdmFsdWVFbmNvZGluZzogTWVtYmVyLCBrZXlFbmNvZGluZzogTUVNQkVSUyB9KQogICAgICBpZiAobm9kZSkgewogICAgICAgIHZhbHVlID0gbm9kZS52YWx1ZQogICAgICAgIGZvdW5kID0gdHJ1ZQogICAgICB9CiAgICB9CgogICAgY29uc3QgY2hhbmdlZCA9ICFmb3VuZCB8fCAhdmFsdWUuaXNSZW1vdmVkCiAgICBjb25zdCB3YXNUcmFja2VkID0gZm91bmQgJiYgIXZhbHVlLmlzUmVtb3ZlZAogICAgY29uc3QgbGVuZ3RoID0gZm91bmQgPyB2YWx1ZS5sZW5ndGggOiAwCgogICAgaWYgKGNoYW5nZWQpIHsKICAgICAgdGhpcy5fY2hhbmdlcy5wdXNoKHsga2V5LCB2YWx1ZTogeyBpc0luZGV4ZXI6IGZhbHNlLCBpc1JlbW92ZWQ6IHRydWUsIGxlbmd0aCB9IH0pCiAgICB9CgogICAgaWYgKHdhc1RyYWNrZWQpIHRoaXMubWVtYmVycy0tCgogICAgcmV0dXJuIGlzSW5kZXhlcgogIH0KCiAgYXN5bmMgbGlua2FibGUoa2V5LCBsZW5ndGgpIHsKICAgIGNvbnN0IGxlbiA9IHRoaXMuX3NlZW5MZW5ndGgoa2V5KQogICAgaWYgKGxlbiA+IDApIHJldHVybiBsZW5ndGggPiBsZW4KCiAgICBjb25zdCBpbmZvID0gYXdhaXQgdGhpcy5fZ2V0KGtleSwgMCkKICAgIGNvbnN0IHByZXZMZW5ndGggPSBpbmZvID8gaW5mby5sZW5ndGggOiAwCgogICAgcmV0dXJuIGxlbmd0aCA+IHByZXZMZW5ndGgKICB9CgogIGFzeW5jIGhhcyhrZXksIG9wdHMpIHsKICAgIC8vIGNvdWxkIGJlIG9wdGltaXNlZC4uLgogICAgcmV0dXJuIChhd2FpdCB0aGlzLmdldChrZXksIG9wdHMpKSAhPT0gbnVsbAogIH0KCiAgYXN5bmMgX2dldChrZXksIHRpbWVvdXQpIHsKICAgIGxldCB2YWx1ZSA9IG51bGwKICAgIGxldCBmb3VuZCA9IGZhbHNlCgogICAgZm9yIChsZXQgaSA9IHRoaXMuX2NoYW5nZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgYyA9IHRoaXMuX2NoYW5nZXNbaV0KICAgICAgaWYgKGI0YS5lcXVhbHMoa2V5LCBjLmtleSkpIHsKICAgICAgICB2YWx1ZSA9IGMudmFsdWUKICAgICAgICBmb3VuZCA9IHRydWUKICAgICAgICBicmVhawogICAgICB9CiAgICB9CgogICAgaWYgKCFmb3VuZCkgewogICAgICBjb25zdCBub2RlID0gYXdhaXQgdGhpcy5kYi5nZXQoa2V5LCB7IHRpbWVvdXQsIHZhbHVlRW5jb2Rpbmc6IE1lbWJlciwga2V5RW5jb2Rpbmc6IE1FTUJFUlMgfSkKICAgICAgaWYgKG5vZGUpIHsKICAgICAgICB2YWx1ZSA9IG5vZGUudmFsdWUKICAgICAgICBmb3VuZCA9IHRydWUKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmb3VuZCA/IHZhbHVlIDogbnVsbAogIH0KCiAgYXN5bmMgZ2V0KGtleSwgb3B0cyA9IHt9KSB7CiAgICBpZiAodGhpcy5fZW1wdHkpIHJldHVybiBudWxsCgogICAgbGV0IHZhbHVlID0gYXdhaXQgdGhpcy5fZ2V0KGtleSwgb3B0cy50aW1lb3V0IHx8IDApCgogICAgaWYgKG9wdHMudW5mbHVzaGVkKSB7CiAgICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQoKICAgICAgZm9yIChsZXQgaSA9IHRoaXMuX2NoYW5nZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBjb25zdCBjID0gdGhpcy5fY2hhbmdlc1tpXQogICAgICAgIGlmIChiNGEuZXF1YWxzKGMua2V5LCBrZXkpKSB2YWx1ZSA9IGMudmFsdWUKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX2Nsb2NrVXBkYXRlcy5oYXMoaGV4KSkgdmFsdWUubGVuZ3RoID0gdGhpcy5fY2xvY2tVcGRhdGVzLmdldChoZXgpCiAgICB9CgogICAgcmV0dXJuIG9wdHMub25seUFjdGl2ZSAhPT0gZmFsc2UgfHwgIXZhbHVlLmlzUmVtb3ZlZCA/IHZhbHVlIDogbnVsbAogIH0KCiAgYXN5bmMgaGFzTG9jYWwoa2V5KSB7CiAgICBpZiAodGhpcy5fZW1wdHkpIHJldHVybiBmYWxzZQogICAgdHJ5IHsKICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IHRoaXMuZGIuZ2V0KGtleSwgewogICAgICAgIHZhbHVlRW5jb2Rpbmc6IE1lbWJlciwKICAgICAgICBrZXlFbmNvZGluZzogTUVNQkVSUywKICAgICAgICB1cGRhdGU6IGZhbHNlLAogICAgICAgIHdhaXQ6IGZhbHNlCiAgICAgIH0pCiAgICAgIHJldHVybiBub2RlICE9PSBudWxsCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQoKICBhc3luYyBnZXRMb2NhbExlbmd0aChrZXkpIHsKICAgIGlmICh0aGlzLl9lbXB0eSkgcmV0dXJuIDAKICAgIHRyeSB7CiAgICAgIGNvbnN0IG5vZGUgPSBhd2FpdCB0aGlzLmRiLmdldChrZXksIHsKICAgICAgICB2YWx1ZUVuY29kaW5nOiBNZW1iZXIsCiAgICAgICAga2V5RW5jb2Rpbmc6IE1FTUJFUlMsCiAgICAgICAgdXBkYXRlOiBmYWxzZSwKICAgICAgICB3YWl0OiBmYWxzZQogICAgICB9KQogICAgICByZXR1cm4gbm9kZSA9PT0gbnVsbCA/IDAgOiBub2RlLnZhbHVlLmxlbmd0aAogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiAwCiAgICB9CiAgfQoKICBsaXN0KCkgewogICAgLy8gbm90ZSwgTk9UIHNhZmUgdG8gdXNlIGR1cmluZyBhcHBseSBhdG0KICAgIHJldHVybiB0aGlzLmRiLmNyZWF0ZVJlYWRTdHJlYW0oewogICAgICB2YWx1ZUVuY29kaW5nOiBNZW1iZXIsCiAgICAgIGtleUVuY29kaW5nOiBNRU1CRVJTCiAgICB9KQogIH0KCiAgYXN5bmMgaXNJbmRleGVkKGtleSwgbGVuZ3RoKSB7CiAgICBjb25zdCBjbyA9IHRoaXMuZGIuY2hlY2tvdXQodGhpcy5jb3JlLmluZGV4ZWRMZW5ndGgpCiAgICB0cnkgewogICAgICBjb25zdCBub2RlID0gYXdhaXQgY28uZ2V0KGtleSwgeyB2YWx1ZUVuY29kaW5nOiBNZW1iZXIsIGtleUVuY29kaW5nOiBNRU1CRVJTIH0pCiAgICAgIHJldHVybiBub2RlICE9PSBudWxsICYmIG5vZGUudmFsdWUubGVuZ3RoID49IGxlbmd0aAogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgY28uY2xvc2UoKQogICAgfQogIH0KCiAgYXN5bmMgZm9yayhpbmRleGVycywgbWFuaWZlc3RzLCBlbmNyeXB0aW9uTGVuZ3RoLCB2aWV3cykgewogICAgdGhpcy5pbmRleGVycyA9IFtdCiAgICB0aGlzLnBlbmRpbmdJbmRleGVycyA9IFtdCiAgICB0aGlzLnZpZXdzID0gdmlld3MKCiAgICBpZiAodGhpcy52ZXJzaW9uIDwgMikgdGhpcy52ZXJzaW9uID0gMiAvLyBidW1wIHRvIGVuYWJsZSBlbnRyb3B5CgogICAgZm9yIChjb25zdCB7IGtleSB9IG9mIGluZGV4ZXJzKSB7CiAgICAgIC8vIHRvZG86IHByb2JhYmx5IG5lZWQgdG8gY2hlY2sgaXNSZW1vdmVkIGV0YwogICAgICBjb25zdCB7IGxlbmd0aCB9ID0gYXdhaXQgdGhpcy5nZXQoa2V5KQogICAgICB0aGlzLmluZGV4ZXJzLnB1c2goeyBrZXksIGxlbmd0aCB9KQogICAgfQoKICAgIHRoaXMuX3JlZnJlc2hFbnRyb3B5KHRoaXMuY29yZS5sZW5ndGgpCgogICAgY29uc3QgYmxvY2tzID0gW10KCiAgICAvLyB0cnVuY2F0ZSBuZWVkcyB0byByZXNwZWN0IGh5cGVyY29yZSBiYXRjaAogICAgbGV0IHRydW5jYXRlID0gdGhpcy5jb3JlLmxlbmd0aCAtIDEKICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiB0aGlzLmRiLmNyZWF0ZUhpc3RvcnlTdHJlYW0oeyBsdDogdHJ1bmNhdGUsIHJldmVyc2U6IHRydWUgfSkpIHsKICAgICAgaWYgKGI0YS5lcXVhbHMoZGF0YS5rZXksIElORk9fS0VZKSkgewogICAgICAgIHRydW5jYXRlID0gZGF0YS5zZXEgKyAxCiAgICAgICAgYnJlYWsKICAgICAgfQoKICAgICAgYmxvY2tzLnB1c2goZGF0YSkKICAgIH0KCiAgICBhd2FpdCB0aGlzLmNvcmUudHJ1bmNhdGUodHJ1bmNhdGUsIHRoaXMuY29yZS5mb3JrKQoKICAgIGNvbnN0IGJhdGNoID0gdGhpcy5kYi5iYXRjaCh7IHVwZGF0ZTogZmFsc2UgfSkKICAgIGF3YWl0IGJhdGNoLnJlYWR5KCkKCiAgICBmb3IgKGNvbnN0IHsga2V5LCB2YWx1ZSB9IG9mIGJsb2NrcykgewogICAgICBhd2FpdCBiYXRjaC5wdXQoa2V5LCB2YWx1ZSkKICAgIH0KCiAgICBjb25zdCBpbmZvID0gewogICAgICB2ZXJzaW9uOiB0aGlzLnZlcnNpb24sCiAgICAgIG1lbWJlcnM6IHRoaXMubWVtYmVycywKICAgICAgcGVuZGluZ0luZGV4ZXJzOiB0aGlzLnBlbmRpbmdJbmRleGVycywKICAgICAgaW5kZXhlcnM6IHRoaXMuaW5kZXhlcnMsCiAgICAgIGhlYWRzOiB0aGlzLmhlYWRzLAogICAgICB2aWV3czogdGhpcy52aWV3cywKICAgICAgZW5jcnlwdGlvbkxlbmd0aCwKICAgICAgZW50cm9weTogdGhpcy5lbnRyb3B5CiAgICB9CgogICAgYXdhaXQgYmF0Y2gucHV0KCdpbmZvJywgaW5mbywgeyB2YWx1ZUVuY29kaW5nOiBJbmZvLCBrZXlFbmNvZGluZzogRElHRVNUIH0pCiAgICBhd2FpdCBiYXRjaC5mbHVzaCgpCgogICAgYXdhaXQgdGhpcy5fcmVzZXQoYXdhaXQgdGhpcy5kYi5nZXQoJ2luZm8nLCB7IHZhbHVlRW5jb2Rpbmc6IEluZm8sIGtleUVuY29kaW5nOiBESUdFU1QgfSkpCgogICAgcmV0dXJuIHRydW5jYXRlCiAgfQp9CgpmdW5jdGlvbiBoYXNEZXBlbmRlbmN5KG5vZGUsIGRlcCkgewogIGZvciAoY29uc3QgaCBvZiBub2RlLmFjdHVhbEhlYWRzKSB7CiAgICBpZiAoc2FtZU5vZGUoaCwgZGVwKSkgcmV0dXJuIHRydWUKICB9CiAgcmV0dXJuIGZhbHNlCn0KCmZ1bmN0aW9uIHNhbWVOb2RlKGEsIGIpIHsKICByZXR1cm4gYjRhLmVxdWFscyhhLmtleSwgYi5rZXkpICYmIGEubGVuZ3RoID09PSBiLmxlbmd0aAp9CgpmdW5jdGlvbiBzYW1lSW5kZXhlcnMoYSwgYikgewogIGlmIChhLnZpZXdzLmxlbmd0aCA+IDAgJiYgYi52aWV3cy5sZW5ndGggPiAwKSByZXR1cm4gYjRhLmVxdWFscyhhLnZpZXdzWzBdLmtleSwgYi52aWV3c1swXS5rZXkpCiAgaWYgKGEuaW5kZXhlcnMubGVuZ3RoICE9PSBiLmluZGV4ZXJzLmxlbmd0aCkgcmV0dXJuIGZhbHNlCgogIGZvciAobGV0IGkgPSAwOyBpIDwgYS5pbmRleGVycy5sZW5ndGg7IGkrKykgewogICAgaWYgKCFiNGEuZXF1YWxzKGEuaW5kZXhlcnNbaV0ua2V5LCBiLmluZGV4ZXJzW2ldLmtleSkpIHJldHVybiBmYWxzZQogIH0KCiAgcmV0dXJuIHRydWUKfQoKZnVuY3Rpb24gY2xvbmVOb2RlcyhhcnIpIHsKICBjb25zdCBjID0gW10KICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgYy5wdXNoKHsga2V5OiBhcnJbaV0ua2V5LCBsZW5ndGg6IGFycltpXS5sZW5ndGggfSkKICB9CiAgcmV0dXJuIGMKfQoKZnVuY3Rpb24gZ2VuZXJhdGVFbnRyb3B5KGluZGV4ZXJzLCBsZW5ndGgsIGVudHJvcHkpIHsKICBjb25zdCBidWZmZXIgPSBiNGEuYWxsb2MoOCArIDMyICsgaW5kZXhlcnMubGVuZ3RoICogMzIpCiAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoLCBidWZmZXIgfQoKICBjLnVpbnQ2NC5lbmNvZGUoc3RhdGUsIGxlbmd0aCkKICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBlbnRyb3B5IHx8IEdFTkVTSVNfRU5UUk9QWSkKICBmb3IgKGNvbnN0IHsga2V5IH0gb2YgaW5kZXhlcnMpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIGtleSkKCiAgcmV0dXJuIGNyeXB0by5oYXNoKFtOU19FTlRST1BZLCBidWZmZXJdKQp9CmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKCmNvbnN0IE1BWF9XQUlUID0gMiAqIDYwICogMTAwMApjb25zdCBERUZBVUxUX0lOVEVSVkFMID0gMTAgKiAxMDAwCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFRpbWVyIHsKICBjb25zdHJ1Y3RvcihoYW5kbGVyLCBpbnRlcnZhbCwgb3B0cyA9IHt9KSB7CiAgICB0aGlzLmhhbmRsZXIgPSBoYW5kbGVyIHx8IG5vb3AKICAgIHRoaXMuaW50ZXJ2YWwgPSBpbnRlcnZhbCB8fCBERUZBVUxUX0lOVEVSVkFMCiAgICB0aGlzLmxpbWl0ID0gb3B0cy5saW1pdCB8fCBNQVhfV0FJVAoKICAgIHRoaXMuX2V4ZWN1dGluZyA9IG51bGwKCiAgICB0aGlzLl9saW1pdCA9IHJhbmRvbTJvdmVyMSh0aGlzLmxpbWl0KQogICAgdGhpcy5fdGltZXIgPSBudWxsCiAgICB0aGlzLl9yZXNvbHZlID0gbnVsbAogICAgdGhpcy5fc3RhcnQgPSAwCiAgICB0aGlzLl9zdG9wcGVkID0gZmFsc2UKICAgIHRoaXMuX2FzYXAgPSBmYWxzZQogICAgdGhpcy5fc3RhbmRhbG9uZSA9IG5ldyBTZXQoKQoKICAgIHRoaXMuX3VucmVmID0gb3B0cy51bnJlZiAhPT0gZmFsc2UKICAgIHRoaXMuX3RpbWVyQ2FsbGJhY2sgPSB0aGlzLl9leGVjdXRlQmFja2dyb3VuZC5iaW5kKHRoaXMpCiAgfQoKICBfZXhlY3V0ZUJhY2tncm91bmQoKSB7CiAgICB0aGlzLl9leGVjdXRpbmcgPSB0aGlzLl9leGVjdXRlKCkKICAgIHRoaXMuX2V4ZWN1dGluZy5jYXRjaChzYWZldHlDYXRjaCkgLy8gbWFrZSBzdXJlIGl0IGRvZXNudCBjcmFzaCBpbiB0aGUgYmcKICB9CgogIGFzeW5jIF9leGVjdXRlKCkgewogICAgdGhpcy5fYXNhcCA9IGZhbHNlCiAgICBhd2FpdCB0aGlzLmhhbmRsZXIoKQogICAgdGhpcy5fc3RhcnQgPSAwCiAgICB0aGlzLl9leGVjdXRpbmcgPSBudWxsCiAgICB0aGlzLmJ1bXAoKQogIH0KCiAgYnVtcCgpIHsKICAgIGlmICh0aGlzLl9zdG9wcGVkIHx8IHRoaXMuX2V4ZWN1dGluZyB8fCB0aGlzLl9hc2FwKSByZXR1cm4KCiAgICBpZiAoIXRoaXMuX3N0YXJ0KSB0aGlzLl9zdGFydCA9IERhdGUubm93KCkKICAgIGVsc2UgaWYgKERhdGUubm93KCkgLSB0aGlzLl9zdGFydCA+IHRoaXMuX2xpbWl0KSByZXR1cm4KCiAgICBjb25zdCBpbnRlcnZhbCA9IHJhbmRvbTJvdmVyMSh0aGlzLmludGVydmFsKQoKICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lcikKICAgIHRoaXMuX3RpbWVyID0gc2V0VGltZW91dCh0aGlzLl90aW1lckNhbGxiYWNrLCBpbnRlcnZhbCkKICAgIGlmICh0aGlzLl91bnJlZiAmJiB0aGlzLl90aW1lci51bnJlZikgdGhpcy5fdGltZXIudW5yZWYoKQogIH0KCiAgYXN5bmMgdHJpZ2dlcigpIHsKICAgIGlmICh0aGlzLl9zdG9wcGVkKSByZXR1cm4KICAgIGlmICh0aGlzLl9leGVjdXRpbmcpIGF3YWl0IHRoaXMuX2V4ZWN1dGluZwogICAgaWYgKHRoaXMuX3N0b3BwZWQpIHJldHVybgoKICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lcikKICAgIHRoaXMuX3RpbWVyID0gbnVsbAoKICAgIHRoaXMuX2V4ZWN1dGVCYWNrZ3JvdW5kKCkKICAgIGF3YWl0IHRoaXMuX2V4ZWN1dGluZwogIH0KCiAgYXN5bmMgZmx1c2goKSB7CiAgICBpZiAodGhpcy5fZXhlY3V0aW5nKSBhd2FpdCB0aGlzLl9leGVjdXRpbmcKICB9CgogIC8vIGJ1c2luZXNzLWFzLXVzdWFsCiAgYmF1KCkgewogICAgaWYgKCF0aGlzLl9hc2FwKSByZXR1cm4KICAgIHRoaXMuX2FzYXAgPSBmYWxzZQogICAgdGhpcy5idW1wKCkKICB9CgogIGFzYXAoKSB7CiAgICBpZiAodGhpcy5fYXNhcCkgcmV0dXJuCiAgICB0aGlzLl9hc2FwID0gdHJ1ZQoKICAgIGNvbnN0IGludGVydmFsID0gTWF0aC5mbG9vcigoTWF0aC5yYW5kb20oKSAqIHRoaXMuaW50ZXJ2YWwpIC8gMykKICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lcikKICAgIHRoaXMuX3RpbWVyID0gc2V0VGltZW91dCh0aGlzLl90aW1lckNhbGxiYWNrLCBpbnRlcnZhbCkKICAgIGlmICh0aGlzLl91bnJlZiAmJiB0aGlzLl90aW1lci51bnJlZikgdGhpcy5fdGltZXIudW5yZWYoKQogIH0KCiAgc3RvcCgpIHsKICAgIGlmICh0aGlzLl90aW1lcikgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVyKQogICAgdGhpcy5fdGltZXIgPSBudWxsCiAgICB0aGlzLl9zdGFydCA9IDAKICAgIHRoaXMuX2FzYXAgPSBmYWxzZQogICAgdGhpcy5fc3RvcHBlZCA9IHRydWUKCiAgICBmb3IgKGNvbnN0IHsgdGltZXIsIHJlc29sdmUgfSBvZiB0aGlzLl9zdGFuZGFsb25lKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aW1lcikKICAgICAgcmVzb2x2ZSgpCiAgICB9CgogICAgdGhpcy5fc3RhbmRhbG9uZS5jbGVhcigpCiAgfQoKICBhc2FwU3RhbmRhbG9uZSgpIHsKICAgIGNvbnN0IGludGVydmFsID0gTWF0aC5mbG9vcigoTWF0aC5yYW5kb20oKSAqIHRoaXMuaW50ZXJ2YWwpIC8gMykKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICBjb25zdCByZWYgPSB7IHRpbWVyOiBudWxsLCByZXNvbHZlIH0KICAgICAgcmVmLnRpbWVyID0gc2V0VGltZW91dChyZXNvbHZlU3RhbmRhbG9uZSwgaW50ZXJ2YWwsIHJlZiwgdGhpcy5fc3RhbmRhbG9uZSkKICAgICAgaWYgKHJlZi50aW1lci51bnJlZikgcmVmLnRpbWVyLnVucmVmKCkKICAgICAgdGhpcy5fc3RhbmRhbG9uZS5hZGQocmVmKQogICAgfSkKICB9CgogIHVucmVmKCkgewogICAgaWYgKHRoaXMuX3RpbWVyICYmIHRoaXMuX3RpbWVyLnVucmVmKSB0aGlzLl90aW1lci51bnJlZigpCiAgfQp9CgpmdW5jdGlvbiByZXNvbHZlU3RhbmRhbG9uZShyZWYsIHNldCkgewogIHNldC5kZWxldGUocmVmKQogIHJlZi5yZXNvbHZlKCkKfQoKLy8gcmFuZG9tIHZhbHVlIHggYmV0d2VlbiBuIDw9IHggPCAybgpmdW5jdGlvbiByYW5kb20yb3ZlcjEobikgewogIHJldHVybiBNYXRoLmZsb29yKG4gKyBNYXRoLnJhbmRvbSgpICogbikKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ25hbm9hc3NlcnQnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBUb3BvTGlzdCB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLnRpcCA9IFtdCiAgICB0aGlzLnVuZG8gPSAwCiAgICB0aGlzLnNoYXJlZCA9IDAKICB9CgogIHN0YXRpYyBjb21wYXJlKGEsIGIpIHsKICAgIHJldHVybiBjbXAoYSwgYikKICB9CgogIHN0YXRpYyBhZGQobm9kZSwgaW5kZXhlZCwgb2Zmc2V0KSB7CiAgICBhZGRTb3J0ZWQobm9kZSwgaW5kZXhlZCwgb2Zmc2V0KQogIH0KCiAgbWFyaygpIHsKICAgIHRoaXMuc2hhcmVkID0gdGhpcy50aXAubGVuZ3RoCiAgICB0aGlzLnVuZG8gPSAwCiAgfQoKICAvLyB0b2RvOiBidW1wIHRvIG5ldyBhcGkgdGhhdCBqdXN0IHRyYWNrcyB1bmRvCiAgZmx1c2goaW5kZXhlZCA9IFtdKSB7CiAgICBpZiAoaW5kZXhlZC5sZW5ndGgpIHRoaXMuX2FwcGx5SW5kZXhlZChpbmRleGVkKQoKICAgIGNvbnN0IHUgPSB7CiAgICAgIHNoYXJlZDogdGhpcy5zaGFyZWQsCiAgICAgIHVuZG86IHRoaXMudW5kbywKICAgICAgbGVuZ3RoOiBpbmRleGVkLmxlbmd0aCArIHRoaXMudGlwLmxlbmd0aCwKICAgICAgaW5kZXhlZCwKICAgICAgdGlwOiB0aGlzLnRpcAogICAgfQoKICAgIHRoaXMubWFyaygpCgogICAgcmV0dXJuIHUKICB9CgogIHByaW50KCkgewogICAgcmV0dXJuIHRoaXMudGlwLm1hcCgobikgPT4gbi53cml0ZXIuY29yZS5rZXkudG9TdHJpbmcoKSArIG4ubGVuZ3RoKQogIH0KCiAgX2FwcGx5SW5kZXhlZChub2RlcykgewogICAgYXNzZXJ0KG5vZGVzLmxlbmd0aCA8PSB0aGlzLnRpcC5sZW5ndGgsICdJbmRleGVkIGJhdGNoIGNhbm5vdCBleGNlZWQgdGlwJykKCiAgICBsZXQgc2hhcmVkID0gMAoKICAgIGZvciAoOyBzaGFyZWQgPCBub2Rlcy5sZW5ndGg7IHNoYXJlZCsrKSB7CiAgICAgIGlmICh0aGlzLnRpcFtzaGFyZWRdICE9PSBub2Rlc1tzaGFyZWRdKSBicmVhawogICAgfQoKICAgIC8vIHJlb3JkZXJpbmcKICAgIGlmIChzaGFyZWQgPCBub2Rlcy5sZW5ndGgpIHRoaXMuX3RyYWNrKHNoYXJlZCkKCiAgICBjb25zdCB0aXAgPSBbXQoKICAgIGZvciAobGV0IGkgPSBzaGFyZWQ7IGkgPCB0aGlzLnRpcC5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBub2RlID0gdGhpcy50aXBbaV0KICAgICAgaWYgKG5vZGUueWllbGRlZCkgY29udGludWUKICAgICAgY29uc3QgcyA9IGFkZFNvcnRlZChub2RlLCB0aXAsIDApCiAgICAgIGlmIChzID09PSB0aXAubGVuZ3RoIC0gMSkgY29udGludWUKICAgICAgdGhpcy5fdHJhY2soc2hhcmVkICsgcykKICAgIH0KCiAgICB0aGlzLnRpcCA9IHRpcAogIH0KCiAgYWRkKG5vZGUpIHsKICAgIGNvbnN0IHNoYXJlZCA9IGFkZFNvcnRlZChub2RlLCB0aGlzLnRpcCwgMCkKICAgIHRoaXMuX3RyYWNrKHNoYXJlZCkKICB9CgogIF90cmFjayhzaGFyZWQpIHsKICAgIGlmIChzaGFyZWQgPCB0aGlzLnNoYXJlZCkgewogICAgICB0aGlzLnVuZG8gKz0gdGhpcy5zaGFyZWQgLSBzaGFyZWQKICAgICAgdGhpcy5zaGFyZWQgPSBzaGFyZWQKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGhhc09wdGltaXN0aWNEZXBzKG5vZGUpIHsKICBmb3IgKGNvbnN0IGQgb2Ygbm9kZS5kZXBlbmRlbmNpZXMpIHsKICAgIGlmIChkLm9wdGltaXN0aWMpIHJldHVybiB0cnVlCiAgfQogIHJldHVybiBmYWxzZQp9CgovLyB0aGlzIGNhbiBiZSBvcHRpbWlzZWQgdG8gb25seSByZXR1cm4gb3B0aW1pc3RpYyBub2RlcyB0aGF0IHdlIHdpbGwgInRvdWNoIiB3aGVuIG1vdmluZyBkb3duIHRoZSBub2RlCmZ1bmN0aW9uIGdldE9wdGltaXN0aWNEZXBzKG5vZGUsIGxpc3QpIHsKICBjb25zdCBkZXBzID0gbmV3IFNldCgpCiAgY29uc3Qgc3RhY2sgPSBbbm9kZV0KCiAgd2hpbGUgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgIGNvbnN0IG5leHQgPSBzdGFjay5wb3AoKQogICAgaWYgKGRlcHMuaGFzKG5leHQpKSBjb250aW51ZQogICAgaWYgKG5leHQub3B0aW1pc3RpYyAmJiBuZXh0ICE9PSBub2RlKSBkZXBzLmFkZChuZXh0KQogICAgZm9yIChjb25zdCBkIG9mIG5leHQuZGVwZW5kZW5jaWVzKSB7CiAgICAgIGlmIChkLm9wdGltaXN0aWMpIHN0YWNrLnB1c2goZCkKICAgIH0KICB9CgogIGNvbnN0IHJlc3VsdCA9IFtdCgogIGZvciAobGV0IGkgPSBsaXN0Lmxlbmd0aCAtIDE7IGRlcHMuc2l6ZSAhPT0gcmVzdWx0Lmxlbmd0aCAmJiBpID49IDA7IGktLSkgewogICAgY29uc3QgbiA9IGxpc3RbaV0KICAgIGlmIChkZXBzLmhhcyhuKSkgcmVzdWx0LnB1c2gobikKICB9CgogIHJldHVybiByZXN1bHQucmV2ZXJzZSgpCn0KCmZ1bmN0aW9uIGFkZFNvcnRlZE9wdGltaXN0aWMobm9kZSwgbGlzdCwgb2Zmc2V0KSB7CiAgY29uc3Qgb3B0ID0gZ2V0T3B0aW1pc3RpY0RlcHMobm9kZSwgbGlzdCkKICBjb25zdCBwb3MgPSBuZXcgVWludDMyQXJyYXkob3B0Lmxlbmd0aCkKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcHQubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IG4gPSBvcHRbaV0KICAgIHBvc1tpXSA9IG4uaW5kZXgKICAgIG1vdmVEb3duKG4sIGxpc3QsIG9mZnNldCkKICB9CgogIG1vdmVEb3duQW5kVXAobm9kZSwgbGlzdCwgb2Zmc2V0KQoKICBmb3IgKGxldCBpID0gb3B0Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICBtb3ZlT3B0aW1pc3RpY1VwKG9wdFtpXSwgbGlzdCwgb2Zmc2V0KQogIH0KCiAgbGV0IHNoYXJlZCA9IG5vZGUuaW5kZXgKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcHQubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IGlkeCA9IHBvc1tpXQogICAgY29uc3QgbiA9IG9wdFtpXQoKICAgIGlmIChpZHggPT09IG4uaW5kZXgpIGNvbnRpbnVlCgogICAgaWYgKGlkeCA8IHNoYXJlZCkgc2hhcmVkID0gaWR4CiAgICBpZiAobi5pbmRleCA8IHNoYXJlZCkgc2hhcmVkID0gbi5pbmRleAogIH0KCiAgcmV0dXJuIHNoYXJlZAp9CgpmdW5jdGlvbiBhZGRTb3J0ZWQobm9kZSwgbGlzdCwgb2Zmc2V0KSB7CiAgbGlzdC5wdXNoKG5vZGUpCiAgbm9kZS5pbmRleCA9IGxpc3QubGVuZ3RoIC0gMQoKICAvLyAic2xvdyIgcGF0aCwgMSUgb2Ygbm9kZXMKICBpZiAoaGFzT3B0aW1pc3RpY0RlcHMobm9kZSkpIHJldHVybiBhZGRTb3J0ZWRPcHRpbWlzdGljKG5vZGUsIGxpc3QsIG9mZnNldCkKCiAgbW92ZURvd25BbmRVcChub2RlLCBsaXN0LCBvZmZzZXQpCiAgcmV0dXJuIG5vZGUuaW5kZXgKfQoKZnVuY3Rpb24gbW92ZURvd24obm9kZSwgbGlzdCwgb2Zmc2V0KSB7CiAgd2hpbGUgKG5vZGUuaW5kZXggPiBvZmZzZXQpIHsKICAgIGNvbnN0IHByZXYgPSBsaXN0W25vZGUuaW5kZXggLSAxXQogICAgaWYgKGxpbmtzKG5vZGUsIHByZXYpKSBicmVhawogICAgbGlzdFsocHJldi5pbmRleCA9IG5vZGUuaW5kZXgpXSA9IHByZXYKICAgIGxpc3RbLS1ub2RlLmluZGV4XSA9IG5vZGUKICB9Cn0KCmZ1bmN0aW9uIG1vdmVPcHRpbWlzdGljVXAobm9kZSwgbGlzdCwgb2Zmc2V0KSB7CiAgLy8gaWYgb3B0aW1pc3RpYyBtb3ZlIGFsbCB0aGUgd2F5IHVwCiAgd2hpbGUgKG5vZGUuaW5kZXggPCBsaXN0Lmxlbmd0aCAtIDEpIHsKICAgIGNvbnN0IG5leHQgPSBsaXN0W25vZGUuaW5kZXggKyAxXQogICAgaWYgKGxpbmtzKG5leHQsIG5vZGUpKSBicmVhawogICAgbGlzdFsobmV4dC5pbmRleCA9IG5vZGUuaW5kZXgpXSA9IG5leHQKICAgIGxpc3RbKytub2RlLmluZGV4XSA9IG5vZGUKICB9CgogIC8vIHN0YWJsZSBzb3J0IGluIGNhc2UgbXVsdGlwbGUgY2hpbGRyZW4KICB3aGlsZSAobm9kZS5pbmRleCA+IG9mZnNldCkgewogICAgY29uc3QgcHJldiA9IGxpc3Rbbm9kZS5pbmRleCAtIDFdCiAgICBpZiAoIXByZXYub3B0aW1pc3RpYykgYnJlYWsKICAgIGNvbnN0IGMgPSBjbXAocHJldiwgbm9kZSkKICAgIGlmIChjIDw9IDApIGJyZWFrCiAgICBsaXN0WyhwcmV2LmluZGV4ID0gbm9kZS5pbmRleCldID0gcHJldgogICAgbGlzdFstLW5vZGUuaW5kZXhdID0gbm9kZQogIH0KfQoKZnVuY3Rpb24gbW92ZU5vbk9wdGltaXN0aWNVcChub2RlLCBsaXN0LCBvZmZzZXQpIHsKICAvLyBzdGFibGUgc29ydCBhZ2FpbnN0IG5leHQgbm9uIG9wdGltaXN0aWMgbm9kZQogIHdoaWxlIChub2RlLmluZGV4IDwgbGlzdC5sZW5ndGggLSAxKSB7CiAgICBjb25zdCBuZXh0ID0gbGlzdFtub2RlLmluZGV4ICsgMV0KICAgIGNvbnN0IGMgPSBjbXBOb25PcHRpbWlzdGljKG5vZGUsIG5leHQsIGxpc3QpCiAgICBpZiAoYyA8PSAwKSBicmVhawogICAgbGlzdFsobmV4dC5pbmRleCA9IG5vZGUuaW5kZXgpXSA9IG5leHQKICAgIGxpc3RbKytub2RlLmluZGV4XSA9IG5vZGUKICB9Cn0KCmZ1bmN0aW9uIG1vdmVEb3duQW5kVXAobm9kZSwgbGlzdCwgb2Zmc2V0KSB7CiAgbW92ZURvd24obm9kZSwgbGlzdCwgb2Zmc2V0KQoKICBpZiAobm9kZS5vcHRpbWlzdGljKSBtb3ZlT3B0aW1pc3RpY1VwKG5vZGUsIGxpc3QsIG9mZnNldCkKICBlbHNlIG1vdmVOb25PcHRpbWlzdGljVXAobm9kZSwgbGlzdCwgb2Zmc2V0KQp9CgpmdW5jdGlvbiBsaW5rcyhhLCBiKSB7CiAgaWYgKGIuZGVwZW5kZW50cy5oYXMoYSkpIHJldHVybiB0cnVlCiAgcmV0dXJuIGEubGVuZ3RoID4gMCAmJiBiLmxlbmd0aCA9PT0gYS5sZW5ndGggLSAxICYmIGEud3JpdGVyID09PSBiLndyaXRlcgp9CgpmdW5jdGlvbiBjbXBOb25PcHRpbWlzdGljKGEsIGIsIGxpc3QpIHsKICBpZiAoIWIub3B0aW1pc3RpYykgcmV0dXJuIGNtcChhLCBiKQoKICBmb3IgKGxldCBpID0gYi5pbmRleCArIDE7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBub2RlID0gbGlzdFtpXQogICAgaWYgKCFub2RlLm9wdGltaXN0aWMpIHJldHVybiBjbXAoYSwgbm9kZSkKICB9CgogIHJldHVybiAtMQp9CgpmdW5jdGlvbiBjbXAoYSwgYikgewogIHJldHVybiBsaW5rcyhiLCBhKSA/IC0xIDogY21wVW5saW5rZWQoYSwgYikKfQoKZnVuY3Rpb24gY21wVW5saW5rZWQoYSwgYikgewogIGNvbnN0IGMgPSBiNGEuY29tcGFyZShhLndyaXRlci5jb3JlLmtleSwgYi53cml0ZXIuY29yZS5rZXkpCiAgcmV0dXJuIGMgPT09IDAgPyAoYS5sZW5ndGggPCBiLmxlbmd0aCA/IC0xIDogMSkgOiBjCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBVcGRhdGVDaGFuZ2VzIHsKICBjb25zdHJ1Y3RvcihiYXNlKSB7CiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgICB0aGlzLmJ5TmFtZSA9IG5ldyBNYXAoKQogICAgdGhpcy50cmFja2luZyA9IG51bGwKICB9CgogIGdldCBkaXNjb3ZlcnlLZXkoKSB7CiAgICByZXR1cm4gdGhpcy5iYXNlLmRpc2NvdmVyeUtleQogIH0KCiAgZ2V0IGtleSgpIHsKICAgIHJldHVybiB0aGlzLmJhc2Uua2V5CiAgfQoKICBnZXQgaWQoKSB7CiAgICByZXR1cm4gdGhpcy5iYXNlLmlkCiAgfQoKICBnZXQgc3lzdGVtKCkgewogICAgcmV0dXJuIHRoaXMuYmFzZS5zeXN0ZW0KICB9CgogIHRyYWNrKHN0YXRlKSB7CiAgICB0aGlzLnRyYWNraW5nID0gW10KICAgIHRoaXMuYnlOYW1lLmNsZWFyKCkKCiAgICBpZiAoIXN0YXRlKSByZXR1cm4KCiAgICBmb3IgKGNvbnN0IHYgb2Ygc3RhdGUudmlld3MpIHsKICAgICAgaWYgKHYucmVmKSB0aGlzLl9hZGQodi5yZWYpCiAgICB9CgogICAgdGhpcy5fYWRkKHN0YXRlLnN5c3RlbVZpZXcucmVmKQogICAgdGhpcy5fYWRkKHN0YXRlLmVuY3J5cHRpb25WaWV3LnJlZikKICB9CgogIF9hZGQocmVmKSB7CiAgICB0aGlzLnRyYWNraW5nLnB1c2goeyByZWYsIGZyb206IHJlZi5hdG9taWNCYXRjaCA/IHJlZi5hdG9taWNCYXRjaC5sZW5ndGggOiAwIH0pCiAgfQoKICBmaW5hbGlzZSgpIHsKICAgIGlmICh0aGlzLnRyYWNraW5nID09PSBudWxsKSByZXR1cm4KCiAgICBmb3IgKGNvbnN0IHsgcmVmLCBmcm9tIH0gb2YgdGhpcy50cmFja2luZykgewogICAgICBjb25zdCBjb3JlID0gcmVmLmF0b21pY0JhdGNoIHx8IHJlZi5iYXRjaAogICAgICBjb25zdCB0cnVuYyA9IHJlZi5hdG9taWNCYXRjaCA/IHJlZi5hdG9taWNCYXRjaC5zdGF0ZS5sYXN0VHJ1bmNhdGlvbiA6IG51bGwKCiAgICAgIHRoaXMuYnlOYW1lLnNldChyZWYubmFtZSwgewogICAgICAgIGZyb20sCiAgICAgICAgdG86IGNvcmUgPyBjb3JlLmxlbmd0aCA6IGZyb20sCiAgICAgICAgc2hhcmVkOiB0cnVuYyA/IHRydW5jLnRvIDogZnJvbQogICAgICB9KQogICAgfQoKICAgIHRoaXMudHJhY2tpbmcgPSBudWxsCiAgfQoKICBnZXQobmFtZSkgewogICAgcmV0dXJuIHRoaXMuYnlOYW1lLmdldChuYW1lKQogIH0KfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgeyBPUExPR19WRVJTSU9OIH0gPSByZXF1aXJlKCcuL2NhcHMuanMnKQpjb25zdCB7IE9wbG9nTWVzc2FnZSB9ID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCmNvbnN0IHsgRW5jcnlwdGlvblZpZXcgfSA9IHJlcXVpcmUoJy4vZW5jcnlwdGlvbi5qcycpCgptb2R1bGUuZXhwb3J0cyA9IHsKICBlbmNvZGVWYWx1ZSwKICBkZWNvZGVWYWx1ZQp9CgpmdW5jdGlvbiBlbmNvZGVWYWx1ZSh2YWx1ZSwgb3B0cyA9IHt9KSB7CiAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDAsIGJ1ZmZlcjogbnVsbCB9CgogIGNvbnN0IG1lc3NhZ2UgPSB7CiAgICB2ZXJzaW9uOiBvcHRzLnZlcnNpb24gfHwgT1BMT0dfVkVSU0lPTiwKICAgIGRpZ2VzdDogbnVsbCwKICAgIGNoZWNrcG9pbnQ6IG51bGwsCiAgICBvcHRpbWlzdGljOiAhIW9wdHMub3B0aW1pc3RpYywKICAgIG5vZGU6IHsKICAgICAgaGVhZHM6IG9wdHMuaGVhZHMgfHwgW10sCiAgICAgIGJhdGNoOiAxLAogICAgICB2YWx1ZQogICAgfQogIH0KCiAgT3Bsb2dNZXNzYWdlLnByZWVuY29kZShzdGF0ZSwgbWVzc2FnZSkKCiAgaWYgKG9wdHMucGFkZGluZykgewogICAgc3RhdGUuc3RhcnQgPSBvcHRzLnBhZGRpbmcKICAgIHN0YXRlLmVuZCArPSBvcHRzLnBhZGRpbmcKICB9CgogIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvYyhzdGF0ZS5lbmQpCgogIE9wbG9nTWVzc2FnZS5lbmNvZGUoc3RhdGUsIG1lc3NhZ2UpCgogIGlmICghb3B0cy5lbmNyeXB0ZWQpIHJldHVybiBzdGF0ZS5idWZmZXIKCiAgaWYgKCFvcHRzLm9wdGltaXN0aWMpIHsKICAgIHRocm93IG5ldyBFcnJvcignRW5jb2RpbmcgYW4gZW5jcnlwdGVkIHZhbHVlIGlzIG5vdCBzdXBwb3J0ZWQnKQogIH0KCiAgY29uc3QgcGFkZGluZyA9IGI0YS5hbGxvYygxNikgLy8gbWluIGhhc2ggbGVuZ3RoIGlzIDE2CiAgY3J5cHRvLmhhc2goc3RhdGUuYnVmZmVyLCBwYWRkaW5nKQogIHBhZGRpbmdbMF0gPSAwCgogIHJldHVybiBiNGEuY29uY2F0KFtwYWRkaW5nLnN1YmFycmF5KDAsIDgpLCBzdGF0ZS5idWZmZXJdKQp9Cgphc3luYyBmdW5jdGlvbiBkZWNvZGVWYWx1ZSh2YWx1ZSwgeyBhdXRvYmFzZSwgZW5jcnlwdGlvbktleSwga2V5LCBtYW5pZmVzdCwgaW5kZXggPSAwIH0gPSB7fSkgewogIGlmIChlbmNyeXB0aW9uS2V5KSB7CiAgICBjb25zdCBlID0gbmV3IEVuY3J5cHRpb25WaWV3KHsgZW5jcnlwdGlvbktleSwgYm9vdHN0cmFwOiBhdXRvYmFzZSB9KQogICAgY29uc3QgdyA9IGUuZ2V0V3JpdGVyRW5jcnlwdGlvbigpCgogICAgYXdhaXQgdy5kZWNyeXB0KGluZGV4LCB2YWx1ZSwgeyBrZXksIG1hbmlmZXN0IH0pCiAgICB2YWx1ZSA9IHZhbHVlLnN1YmFycmF5KDgpCiAgfQoKICBjb25zdCBvcCA9IGMuZGVjb2RlKE9wbG9nTWVzc2FnZSwgdmFsdWUpCiAgcmV0dXJuIG9wLm5vZGUudmFsdWUKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKCmNvbnN0IFdha2V1cEVudHJ5ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAga2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBBdXRvV2FrZXVwIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IoYmFzZSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuYmFzZSA9IGJhc2UKICAgIHRoaXMuZmx1c2hpbmcgPSBudWxsCgogICAgdGhpcy5fcm9vdFN0b3JlID0gdGhpcy5iYXNlLnN0b3JlCiAgICB0aGlzLl9hZGRCb3VuZCA9IHRoaXMuYWRkLmJpbmQodGhpcykKICAgIHRoaXMuX3ByZXVwZGF0ZUJvdW5kID0gdGhpcy5fcHJldXBkYXRlLmJpbmQodGhpcykKICAgIHRoaXMuX25lZWRzRmx1c2ggPSBmYWxzZQogICAgdGhpcy5fbWFwID0gbmV3IE1hcCgpCiAgfQoKICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLl9tYXAudmFsdWVzKCkKICB9CgogIGFzeW5jIF9wcmV1cGRhdGUoYmF0Y2gsIGtleSkgewogICAgdGhpcy5xdWV1ZShrZXksIGJhdGNoLmxlbmd0aCkKICAgIGF3YWl0IHRoaXMuZmx1c2goKQogICAgdGhpcy5iYXNlLl9vbndha2V1cCgpCiAgfQoKICBhc3luYyBfc2F2ZSgpIHsKICAgIGNvbnN0IHNsYWIgPSBiNGEuYWxsb2NVbnNhZmUoOCArIHRoaXMuX21hcC5zaXplICogNDApIC8vIDMyICsgOAogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDAsIGJ1ZmZlcjogc2xhYiB9CgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdGhpcy5fbWFwLnNpemUpCiAgICBmb3IgKGNvbnN0IG0gb2YgdGhpcy5fbWFwLnZhbHVlcygpKSBXYWtldXBFbnRyeS5lbmNvZGUoc3RhdGUsIG0pCgogICAgYXdhaXQgdGhpcy5iYXNlLmxvY2FsLnNldFVzZXJEYXRhKCdhdXRvYmFzZS93YWtldXAnLCBzbGFiLnN1YmFycmF5KDAsIHN0YXRlLnN0YXJ0KSkKICB9CgogIGFzeW5jIF9sb2FkKCkgewogICAgY29uc3QgYnVmZmVyID0gYXdhaXQgdGhpcy5iYXNlLmxvY2FsLmdldFVzZXJEYXRhKCdhdXRvYmFzZS93YWtldXAnKQogICAgaWYgKCFidWZmZXIpIHJldHVybgoKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCwgYnVmZmVyIH0KCiAgICBsZXQgbGVuID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHdoaWxlIChsZW4tLSA+IDApIHsKICAgICAgY29uc3QgbSA9IFdha2V1cEVudHJ5LmRlY29kZShzdGF0ZSkKICAgICAgdGhpcy5fbWFwLnNldChiNGEudG9TdHJpbmcobS5rZXksICdoZXgnKSwgbSkKICAgIH0KICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgYXdhaXQgdGhpcy5fbG9hZCgpCgogICAgdGhpcy5fcm9vdFN0b3JlLndhdGNoKHRoaXMuX2FkZEJvdW5kKQoKICAgIGZvciAoY29uc3QgY29yZSBvZiB0aGlzLl9yb290U3RvcmUuY29yZXMpIHsKICAgICAgaWYgKGNvcmUub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgY29yZS5yZWFkeSgpLmNhdGNoKG5vb3ApCiAgICAgIGlmICghY29yZS5jbG9zaW5nKSB0aGlzLmFkZChjb3JlKQogICAgfQogIH0KCiAgYXN5bmMgX2Nsb3NlKCkgewogICAgdGhpcy5fcm9vdFN0b3JlLnVud2F0Y2godGhpcy5fYWRkQm91bmQpCgogICAgZm9yIChjb25zdCBjb3JlIG9mIHRoaXMuX3Jvb3RTdG9yZS5jb3JlcykgewogICAgICBpZiAoY29yZS5vcGVuZWQgJiYgIWNvcmUuY2xvc2luZykgdGhpcy5yZW1vdmUoY29yZSkKICAgIH0KCiAgICB0aGlzLl9tYXAuY2xlYXIoKQoKICAgIHdoaWxlICh0aGlzLmZsdXNoaW5nKSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgdGhpcy5mbHVzaGluZwogICAgICB9IGNhdGNoIHt9CiAgICB9CiAgfQoKICBxdWV1ZShrZXksIGxlbmd0aCkgewogICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpCiAgICBjb25zdCBtID0gdGhpcy5fbWFwLmdldChoZXgpCgogICAgaWYgKG0gJiYgbS5sZW5ndGggPiBsZW5ndGgpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgdGhpcy5fbmVlZHNGbHVzaCA9IHRydWUKICAgIHRoaXMuX21hcC5zZXQoaGV4LCB7IGtleSwgbGVuZ3RoIH0pCgogICAgcmV0dXJuIHRydWUKICB9CgogIHVucXVldWUoa2V5LCBsZW5ndGgpIHsKICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQogICAgY29uc3QgbSA9IHRoaXMuX21hcC5nZXQoaGV4KQoKICAgIGlmICghbSkgcmV0dXJuIHRydWUKICAgIGlmIChtLmxlbmd0aCA+IGxlbmd0aCkgcmV0dXJuIGZhbHNlCgogICAgdGhpcy5fbmVlZHNGbHVzaCA9IHRydWUKICAgIHRoaXMuX21hcC5kZWxldGUoaGV4KQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGlmICh0aGlzLmNsb3NpbmcpIHRocm93IG5ldyBFcnJvcignQ2xvc2luZycpCgogICAgLy8gd2FpdCBmb3Igc29tZW9uZQogICAgaWYgKHRoaXMuZmx1c2hpbmcpIGF3YWl0IHRoaXMuZmx1c2hpbmcKCiAgICAvLyBpZiBhbm90aGVyIHN0aWxsIGFjdGl2ZSB0aGV5IGZsdXNoZWQgdXMKICAgIGlmICh0aGlzLmZsdXNoaW5nKSByZXR1cm4gdGhpcy5mbHVzaGluZwoKICAgIGlmICh0aGlzLl9uZWVkc0ZsdXNoID09PSBmYWxzZSkgcmV0dXJuCiAgICB0aGlzLl9uZWVkc0ZsdXNoID0gZmFsc2UKCiAgICB0cnkgewogICAgICB0aGlzLmZsdXNoaW5nID0gdGhpcy5fc2F2ZSgpCiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmZsdXNoaW5nCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLmZsdXNoaW5nID0gbnVsbAogICAgfQogIH0KCiAgYWRkKGNvcmUpIHsKICAgIHJldHVybiB0aGlzLl9hZGQoY29yZSkuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgfQoKICByZW1vdmUoY29yZSkgewogICAgcmV0dXJuIHRoaXMuX3JlbW92ZShjb3JlKQogIH0KCiAgYXN5bmMgX2FkZChjb3JlKSB7CiAgICBpZiAoY29yZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCBjb3JlLnJlYWR5KCkKICAgIGlmIChjb3JlLmNsb3NpbmcpIHJldHVybiBmYWxzZQoKICAgIC8vIGxvY2FsIHdyaXRlciwgbm8gbmVlZAogICAgaWYgKGNvcmUgPT09IHRoaXMuYmFzZS5sb2NhbC5jb3JlKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCByeCA9IGNvcmUuc3RvcmFnZS5yZWFkKCkKCiAgICBjb25zdCByZWZlcnJlclByb21pc2UgPSByeC5nZXRVc2VyRGF0YSgncmVmZXJyZXInKQogICAgY29uc3Qgdmlld1Byb21pc2UgPSByeC5nZXRVc2VyRGF0YSgnYXV0b2Jhc2UvdmlldycpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IFtyZWZlcnJlciwgdmlld10gPSBhd2FpdCBQcm9taXNlLmFsbChbcmVmZXJyZXJQcm9taXNlLCB2aWV3UHJvbWlzZV0pCiAgICBpZiAodmlldykgcmV0dXJuIGZhbHNlCgogICAgaWYgKHJlZmVycmVyID09PSBudWxsIHx8ICFiNGEuZXF1YWxzKHJlZmVycmVyLCB0aGlzLmJhc2Uua2V5KSkgcmV0dXJuIGZhbHNlCgogICAgY29yZS5wcmV1cGRhdGUgPSB0aGlzLl9wcmV1cGRhdGVCb3VuZAoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfcmVtb3ZlKGNvcmUpIHsKICAgIGlmIChjb3JlLnByZXVwZGF0ZSAhPT0gdGhpcy5fcHJldXBkYXRlQm91bmQpIHJldHVybiBmYWxzZQogICAgY29yZS5wcmV1cGRhdGUgPSBudWxsCiAgICByZXR1cm4gdHJ1ZQogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnbmFub2Fzc2VydCcpCmNvbnN0IFNpZ25hbFByb21pc2UgPSByZXF1aXJlKCdzaWduYWwtcHJvbWlzZScpCgpjb25zdCBMaW5lYXJpemVyID0gcmVxdWlyZSgnLi9saW5lYXJpemVyLmpzJykKY29uc3QgTm9kZUJ1ZmZlciA9IHJlcXVpcmUoJy4vbm9kZS1idWZmZXIuanMnKQoKY29uc3QgTUFYX1BSRUxPQUQgPSA0CmNvbnN0IE1BWF9QUkVGRVRDSCA9IDI1NgoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBXcml0ZXIgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvcihiYXNlLCBjb3JlLCBsZW5ndGgsIGlzUmVtb3ZlZCkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuYmFzZSA9IGJhc2UKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMuaXNSZW1vdmVkID0gaXNSZW1vdmVkCiAgICB0aGlzLnVwZGF0ZWQgPSBmYWxzZQogICAgdGhpcy5yYW5nZSA9IG51bGwKICAgIHRoaXMubm9kZXMgPSBuZXcgTm9kZUJ1ZmZlcihsZW5ndGgpCiAgICB0aGlzLm5vZGUgPSBudWxsCiAgICB0aGlzLmlzQWN0aXZlID0gZmFsc2UKICAgIHRoaXMuaXNDdXJyZW50bHlDb3VwbGVkID0gZmFsc2UKICAgIHRoaXMuaXNDb3VwbGVkID0gZmFsc2UgLy8gbWFpbnRhaW5lZCBieSB1cGRhdGVCb290c3RyYXBXcml0ZXJzCiAgICB0aGlzLmlzQm9vdHN0cmFwID0gZmFsc2UgLy8gbWFpbnRhaW5lZCBieSB1cGRhdGVCb290c3RyYXBXcml0ZXJzCiAgICB0aGlzLmlzQWN0aXZlSW5kZXhlciA9IGZhbHNlCiAgICB0aGlzLmF2YWlsYWJsZSA9IGxlbmd0aAogICAgdGhpcy5sZW5ndGggPSBsZW5ndGgKICAgIHRoaXMuc2Vlbkxlbmd0aCA9IDAKICAgIHRoaXMucmVjb3ZlciA9IGZhbHNlCiAgICB0aGlzLmZyb3plbiA9IGZhbHNlCgogICAgdGhpcy5zeW5jU2lnbmFsID0gbnVsbAogIH0KCiAgX3BhdXNlKCkgewogICAgaWYgKCF0aGlzLnJhbmdlKSByZXR1cm4KICAgIHRoaXMucmFuZ2UuZGVzdHJveSgpCiAgICB0aGlzLnJhbmdlID0gbnVsbAogIH0KCiAgX3Jlc3VtZSgpIHsKICAgIGlmICh0aGlzLnJhbmdlKSB7CiAgICAgIC8vIGlmIHdlIGRpZG50IGZpbGwgdXAgdGhlIHByZWxvYWQgYnVmZmVyIHlldCwgZG8gbm90IGNvbW1pdCB0byBtb3JlIHdvcmsKICAgICAgaWYgKHRoaXMucmFuZ2UucmFuZ2UuZW5kID09PSB0aGlzLm5vZGVzLmxlbmd0aCArIE1BWF9QUkVGRVRDSCkgcmV0dXJuCiAgICAgIHRoaXMucmFuZ2UuZGVzdHJveSgpCiAgICB9CiAgICB0aGlzLnJhbmdlID0gdGhpcy5jb3JlLmRvd25sb2FkKHsKICAgICAgc3RhcnQ6IHRoaXMubm9kZXMubGVuZ3RoLAogICAgICBlbmQ6IHRoaXMubm9kZXMubGVuZ3RoICsgTUFYX1BSRUZFVENILAogICAgICBsaW5lYXI6IHRydWUKICAgIH0pCiAgfQoKICBfdXBkYXRlQ291cGxpbmcoKSB7CiAgICBpZiAoIXRoaXMuYmFzZS5fY291cGxlciB8fCB0aGlzLmlzQ291cGxlZCA9PT0gdGhpcy5pc0N1cnJlbnRseUNvdXBsZWQpIHJldHVybgoKICAgIGlmICh0aGlzLmlzQ3VycmVudGx5Q291cGxlZCkgdGhpcy5iYXNlLl9jb3VwbGVyLnJlbW92ZSh0aGlzLmNvcmUpCiAgICBlbHNlIHRoaXMuYmFzZS5fY291cGxlci5hZGQodGhpcy5jb3JlKQoKICAgIHRoaXMuaXNDdXJyZW50bHlDb3VwbGVkID0gdGhpcy5pc0NvdXBsZWQKICB9CgogIF9yZW1vdmVDb3VwbGUoKSB7CiAgICBpZiAodGhpcy5iYXNlLl9jb3VwbGVyICYmICF0aGlzLmlzQ291cGxlZCAmJiB0aGlzLmlzQ3VycmVudGx5Q291cGxlZCkgewogICAgICB0aGlzLmlzQ3VycmVudGx5Q291cGxlZCA9IGZhbHNlCiAgICAgIHRoaXMuYmFzZS5fY291cGxlci5yZW1vdmUodGhpcy5jb3JlKQogICAgfQogIH0KCiAgdXBkYXRlQWN0aXZpdHkoKSB7CiAgICBpZiAoIXRoaXMuY29yZS5vcGVuZWQpIHJldHVybgoKICAgIGlmICh0aGlzLnNlZW5MZW5ndGggPiB0aGlzLmNvcmUubGVuZ3RoIHx8IHRoaXMubGVuZ3RoIDwgdGhpcy5jb3JlLmxlbmd0aCB8fCB0aGlzLmlzQm9vdHN0cmFwKSB7CiAgICAgIC8vIGlmIHdlIGhhdmUgc2VlbiBhIGxhdGVyIGNvcmUsIG9yIGlmIHdlIGFyZSBiZWhpbmQsIG9yIGlmIGJvb3RzdHJhcAogICAgICB0aGlzLmlzQWN0aXZlID0gdHJ1ZQogICAgICB0aGlzLmNvcmUuc2V0QWN0aXZlKHRydWUpCiAgICB9IGVsc2UgaWYgKHRoaXMubGVuZ3RoID09PSB0aGlzLmNvcmUubGVuZ3RoKSB7CiAgICAgIC8vIHRoaW5ncyBsb29rIHN0ZWFkeQogICAgICB0aGlzLmlzQWN0aXZlID0gZmFsc2UKICAgICAgdGhpcy5jb3JlLnNldEFjdGl2ZShmYWxzZSkKICAgIH0KCiAgICB0aGlzLl91cGRhdGVDb3VwbGluZygpCgogICAgaWYgKHRoaXMuY29yZS53cml0YWJsZSkgcmV0dXJuCgogICAgaWYgKHRoaXMuYmFzZS5pc0Zhc3RGb3J3YXJkaW5nKCkgfHwgIXRoaXMuaXNBY3RpdmUpIHsKICAgICAgdGhpcy5fcGF1c2UoKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fcmVzdW1lKCkKICAgIH0KICB9CgogIHNldEJvb3RzdHJhcChib29sKSB7CiAgICB0aGlzLmlzQm9vdHN0cmFwID0gYm9vbAogICAgdGhpcy51cGRhdGVBY3Rpdml0eSgpCiAgfQoKICBzZWVuKGxlbmd0aCkgewogICAgaWYgKGxlbmd0aCA+IHRoaXMuc2Vlbkxlbmd0aCkgdGhpcy5zZWVuTGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLnVwZGF0ZUFjdGl2aXR5KCkKICB9CgogIHdhaXRGb3JTeW5jZWQoKSB7CiAgICBpZiAodGhpcy5jb3JlLmxlbmd0aCA9PT0gdGhpcy5sZW5ndGgpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQogICAgaWYgKHRoaXMuc3luY1NpZ25hbCA9PT0gbnVsbCkgdGhpcy5zeW5jU2lnbmFsID0gbmV3IFNpZ25hbFByb21pc2UoKQogICAgcmV0dXJuIHRoaXMuc3luY1NpZ25hbC53YWl0KCkKICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKICAgIGF3YWl0IHRoaXMuY29yZS5zZXRVc2VyRGF0YSgncmVmZXJyZXInLCB0aGlzLmJhc2Uua2V5KQoKICAgIC8vIGJhc2UgbWlnaHQgYmUgY2xvc2luZyBoZXJlCiAgICBpZiAodGhpcy5iYXNlLmNsb3NpbmcpIHJldHVybgoKICAgIC8vIHJlbW92ZSBsYXRlcgogICAgdGhpcy5yZWNvdmVyID0gYXV0b1JlY292ZXIodGhpcy5jb3JlKQoKICAgIC8vIGFkZCBpdCBhZ2FpbiBpbmNhc2UgaXQgd2Fzbid0IHJlYWRpZWQgYmVmb3JlLCBvbmx5IG5lZWRlZCBpZiB0aGlzIGlzIHRoZSBmaXJzdCB0aW1lIHdlIHNldCB0aGUgcmVmZXJyZXIuLi4KICAgIGF3YWl0IHRoaXMuYmFzZS5fd2FrZXVwLmFkZCh0aGlzLmNvcmUuY29yZSkKCiAgICB0aGlzLnVwZGF0ZUFjdGl2aXR5KCkKCiAgICBpZiAodGhpcy5jb3JlLmxlbmd0aCA+IHRoaXMubGVuZ3RoKSB0aGlzLmJhc2UuX3F1ZXVlQnVtcCgpCgogICAgdGhpcy5iYXNlLmVtaXQoJ3dyaXRlcicsIHRoaXMpCiAgfQoKICBfY2xvc2UoKSB7CiAgICBpZiAodGhpcy5zeW5jU2lnbmFsICE9PSBudWxsKSB0aGlzLnN5bmNTaWduYWwubm90aWZ5KCkKICAgIHJldHVybiB0aGlzLmNvcmUuY2xvc2UoKQogIH0KCiAgZ2V0IGluZGV4ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5ub2Rlcy5vZmZzZXQKICB9CgogIGlkbGUoKSB7CiAgICByZXR1cm4gdGhpcy5sZW5ndGggPT09IHRoaXMuYXZhaWxhYmxlICYmIHRoaXMubGVuZ3RoID09PSB0aGlzLmNvcmUubGVuZ3RoICYmIHRoaXMuY29yZS5vcGVuZWQKICB9CgogIGZsdXNoZWQoKSB7CiAgICAvLyBUT0RPOiBwcm9wIGEgY2xlYW5lciB3YXkgdG8gZXhwcmVzcyB0aGlzLi4uCiAgICByZXR1cm4gKAogICAgICB0aGlzLnNlZW5MZW5ndGggPD0gdGhpcy5sZW5ndGggJiYKICAgICAgdGhpcy5sZW5ndGggPT09IHRoaXMuYXZhaWxhYmxlICYmCiAgICAgIHRoaXMubGVuZ3RoID09PSB0aGlzLmNvcmUubGVuZ3RoICYmCiAgICAgIHRoaXMuc2hpZnRhYmxlKCkgPT09IGZhbHNlICYmCiAgICAgICF0aGlzLmNvcmUuY29yZS51cGdyYWRpbmcgJiYKICAgICAgdGhpcy5jb3JlLm9wZW5lZAogICAgKQogIH0KCiAgY29tcGFyZSh3cml0ZXIpIHsKICAgIHJldHVybiBiNGEuY29tcGFyZSh0aGlzLmNvcmUua2V5LCB3cml0ZXIuY29yZS5rZXkpCiAgfQoKICBoZWFkKCkgewogICAgcmV0dXJuIHRoaXMubm9kZXMuZ2V0KHRoaXMubGVuZ3RoIC0gMSkKICB9CgogIGFkdmFuY2UoKSB7CiAgICBpZiAodGhpcy5zeW5jU2lnbmFsICE9PSBudWxsICYmIHRoaXMubGVuZ3RoICsgMSA9PT0gdGhpcy5jb3JlLmxlbmd0aCkgdGhpcy5zeW5jU2lnbmFsLm5vdGlmeSgpCiAgICByZXR1cm4gdGhpcy5sZW5ndGggPCB0aGlzLmF2YWlsYWJsZSA/IHRoaXMubm9kZXMuZ2V0KHRoaXMubGVuZ3RoKyspIDogbnVsbAogIH0KCiAgc2hpZnRhYmxlKCkgewogICAgcmV0dXJuIHRoaXMubGVuZ3RoID4gdGhpcy5ub2Rlcy5vZmZzZXQKICB9CgogIHNoaWZ0KCkgewogICAgaWYgKHRoaXMuc2hpZnRhYmxlKCkgPT09IGZhbHNlKSByZXR1cm4gZmFsc2UKCiAgICBsZXQgbm9kZSA9IHRoaXMuX3NoaWZ0QW5kQ2xlYXIoKQogICAgd2hpbGUgKG5vZGUuYmF0Y2ggPiAxKSBub2RlID0gdGhpcy5fc2hpZnRBbmRDbGVhcigpCgogICAgcmV0dXJuIHRydWUKICB9CgogIGdldChzZXEpIHsKICAgIHJldHVybiBzZXEgPCB0aGlzLmxlbmd0aCA/IHRoaXMubm9kZXMuZ2V0KHNlcSkgOiBudWxsCiAgfQoKICBhcHBlbmQodmFsdWUsIGhlYWRzLCBiYXRjaCwgZGVwZW5kZW5jaWVzLCBvcHRpbWlzdGljKSB7CiAgICBjb25zdCBub2RlID0gTGluZWFyaXplci5jcmVhdGVOb2RlKAogICAgICB0aGlzLAogICAgICB0aGlzLm5vZGVzLmxlbmd0aCArIDEsCiAgICAgIHZhbHVlLAogICAgICBoZWFkcywKICAgICAgYmF0Y2gsCiAgICAgIGRlcGVuZGVuY2llcywKICAgICAgb3B0aW1pc3RpYwogICAgKQoKICAgIG5vZGUuYWN0dWFsSGVhZHMgPSBub2RlLmhlYWRzLnNsaWNlKDApCgogICAgdGhpcy5ub2Rlcy5wdXNoKG5vZGUpCiAgICB0aGlzLmF2YWlsYWJsZSsrCiAgICB0aGlzLmxlbmd0aCsrCgogICAgcmV0dXJuIG5vZGUKICB9CgogIGFzeW5jIHVwZGF0ZShib290KSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmICh0aGlzLmZyb3plbikgcmV0dXJuIGZhbHNlCgogICAgLy8gaWYgdGhpcyBpcyBhIGJvb3Qgbm9kZSwgRE8gTk9ULCBwcmVsb2FkIGFzIHRoYXQgd2lsbCBtYWtlIGl0IGxvYWQKICAgIC8vIGFuZCByZWplY3Qgbm9kZXMgYmFzZWQgb24gdGhlIHRtcCBzdGF0ZSBvZiB0aGUgc3lzdGVtLgogICAgLy8gcHJvcCBuZWVkcyBhIGJldHRlciBzb2x1dGlvbiBidXQgdGhpcyB3b3JrcyBmb3Igbm93CiAgICBjb25zdCBwcmVsb2FkID0gYm9vdCA/IDEgOiBNQVhfUFJFTE9BRAoKICAgIHdoaWxlICh0aGlzLmF2YWlsYWJsZSAtIHRoaXMubGVuZ3RoIDwgcHJlbG9hZCkgewogICAgICAvLyBxdWljayBzYW5pdHkgY2hlY2sKICAgICAgaWYgKHRoaXMubm9kZXMubGVuZ3RoID09PSB0aGlzLmNvcmUubGVuZ3RoIHx8IHRoaXMuY29yZS5sZW5ndGggPT09IDApIGJyZWFrCgogICAgICAvLyBsb2FkIG5leHQgbm9kZQogICAgICBpZiAodGhpcy5ub2RlID09PSBudWxsICYmICEoYXdhaXQgdGhpcy5fbG9hZE5leHROb2RlKCkpKSBicmVhawogICAgICBpZiAoIShhd2FpdCB0aGlzLl9lbnN1cmVOb2RlRGVwZW5kZW5jaWVzKGJvb3QpKSkgYnJlYWsKCiAgICAgIGlmICh0aGlzLnJlY292ZXIpIHRoaXMubm9kZS52YWx1ZSA9IG51bGwKCiAgICAgIHRoaXMubm9kZXMucHVzaCh0aGlzLm5vZGUpCiAgICAgIGlmICh0aGlzLm5vZGUuYmF0Y2ggPT09IDEpIHRoaXMuYXZhaWxhYmxlID0gdGhpcy5ub2Rlcy5sZW5ndGgKICAgICAgdGhpcy5ub2RlID0gbnVsbAogICAgfQoKICAgIHRoaXMudXBkYXRlQWN0aXZpdHkoKQoKICAgIHJldHVybiB0aGlzLmxlbmd0aCA8IHRoaXMuYXZhaWxhYmxlCiAgfQoKICBfc2hpZnRBbmRDbGVhcigpIHsKICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGVzLnNoaWZ0KCkKICAgIG5vZGUuY2xlYXIoKQogICAgcmV0dXJuIG5vZGUKICB9CgogIGFzeW5jIF9sb2FkTmV4dE5vZGUoKSB7CiAgICBjb25zdCBzZXEgPSB0aGlzLm5vZGVzLmxlbmd0aAoKICAgIGlmICghKGF3YWl0IHRoaXMuY29yZS5oYXMoc2VxKSkpIHJldHVybiBmYWxzZQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHsgbm9kZSwgb3B0aW1pc3RpYywgdHJhY2UgfSA9IGF3YWl0IHRoaXMuY29yZS5nZXQoc2VxLCB7IHdhaXQ6IGZhbHNlIH0pCgogICAgICBjb25zdCB2YWx1ZSA9IG5vZGUudmFsdWUgPT0gbnVsbCA/IG51bGwgOiBjLmRlY29kZSh0aGlzLmJhc2UudmFsdWVFbmNvZGluZywgbm9kZS52YWx1ZSkKICAgICAgdGhpcy5ub2RlID0gTGluZWFyaXplci5jcmVhdGVOb2RlKAogICAgICAgIHRoaXMsCiAgICAgICAgc2VxICsgMSwKICAgICAgICB2YWx1ZSwKICAgICAgICBub2RlLmhlYWRzLAogICAgICAgIG5vZGUuYmF0Y2gsCiAgICAgICAgbmV3IFNldCgpLAogICAgICAgIG9wdGltaXN0aWMsCiAgICAgICAgdHJhY2UKICAgICAgKQogICAgICByZXR1cm4gdHJ1ZQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuZnJvemVuID0gdHJ1ZQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIGFzeW5jIF9lbnN1cmVOb2RlRGVwZW5kZW5jaWVzKGJvb3QpIHsKICAgIHdoaWxlICh0aGlzLm5vZGUuZGVwZW5kZW5jaWVzLnNpemUgPCB0aGlzLm5vZGUuaGVhZHMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IHJhd0hlYWQgPSB0aGlzLm5vZGUuaGVhZHNbdGhpcy5ub2RlLmRlcGVuZGVuY2llcy5zaXplXQoKICAgICAgY29uc3QgaGVhZFdyaXRlciA9IGF3YWl0IHRoaXMuYmFzZS5fZ2V0V3JpdGVyQnlLZXkoCiAgICAgICAgcmF3SGVhZC5rZXksCiAgICAgICAgLTEsCiAgICAgICAgcmF3SGVhZC5sZW5ndGgsCiAgICAgICAgdHJ1ZSwKICAgICAgICBmYWxzZSwKICAgICAgICBib290CiAgICAgICkKCiAgICAgIGlmIChoZWFkV3JpdGVyICE9PSB0aGlzICYmIChoZWFkV3JpdGVyID09PSBudWxsIHx8IGhlYWRXcml0ZXIubGVuZ3RoIDwgcmF3SGVhZC5sZW5ndGgpKSB7CiAgICAgICAgaWYgKCFib290KSB0aGlzLmJhc2UuX2Vuc3VyZVdha2V1cChoZWFkV3JpdGVyKQogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9CgogICAgICBsZXQgaGVhZE5vZGUgPSBoZWFkV3JpdGVyLm5vZGVzLmdldChyYXdIZWFkLmxlbmd0aCAtIDEpCgogICAgICAvLyBjb3VsZCBiZSBhIHN0dWIgbm9kZQogICAgICBpZiAoIWhlYWROb2RlKSB7CiAgICAgICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMuYmFzZS5saW5lYXJpemVyLmhlYWRzKSB7CiAgICAgICAgICBpZiAoIWNvbXBhcmVIZWFkKG5vZGUsIHJhd0hlYWQpKSBjb250aW51ZQogICAgICAgICAgaGVhZE5vZGUgPSBub2RlCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gVE9ETzogZ2VuZXJhbGlzZSBEQUcgdmFsaWRhdGlvbiBhbmQgZnJlZXplIHRoZSB3cml0ZXIKICAgICAgYXNzZXJ0KCF0aGlzLm5vZGUuZGVwZW5kZW5jaWVzLmhhcyhoZWFkTm9kZSksICdDb3JydXB0ZWQgREFHJykKCiAgICAgIC8vIFRPRE86IGJldHRlciB3YXkgdG8gc29sdmUgdGhlIHN0dWIgY2hlY2sgaXMgdG8gbmV2ZXIgbXV0YXRlIGhlYWRzIGJlbG93CiAgICAgIGlmIChoZWFkTm9kZSA9PT0gbnVsbCkgewogICAgICAgIC8vIGFscmVhZHkgeWllbGRlZAogICAgICAgIHRoaXMubm9kZS5oZWFkcy5zcGxpY2UodGhpcy5ub2RlLmRlcGVuZGVuY2llcy5zaXplLCAxKQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIHRoaXMubm9kZS5kZXBlbmRlbmNpZXMuYWRkKGhlYWROb2RlKQogICAgfQoKICAgIC8vIGFsd2F5cyBsaW5rIHByZXZpb3VzIG5vZGUgaWYgaXQncyBub3QgaW5kZXhlZAogICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy5ub2RlLmxlbmd0aCAtIDEKICAgIGlmIChvZmZzZXQgPiB0aGlzLmluZGV4ZWQpIHsKICAgICAgdGhpcy5ub2RlLmRlcGVuZGVuY2llcy5hZGQodGhpcy5ub2Rlcy5nZXQob2Zmc2V0IC0gMSkpCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9Cn0KCmZ1bmN0aW9uIGNvbXBhcmVIZWFkKG5vZGUsIGhlYWQpIHsKICBpZiAobm9kZS5sZW5ndGggIT09IGhlYWQubGVuZ3RoKSByZXR1cm4gZmFsc2UKICByZXR1cm4gYjRhLmVxdWFscyhub2RlLndyaXRlci5jb3JlLmtleSwgaGVhZC5rZXkpCn0KCi8vIHRoaXMgaXMgYSBsaXN0IG9mIHBlZXJzIHdlIGJ1Z2dlZCBpbiB0aGUgYnRjIGFuZCBwbGFuYiByb29tLgovLyBhZGRpbmcgdGhlbSBoZXJlIHNvIG1pZ3JhdGlvbiBjYW4gcnVuLCBjYW4gYmUgcmVtb3ZlZCBpbiBhIG1vbnRoIG9yIHNvIGZyb20gdGltZSBvZiBjb21taXQKLy8gbm90ZSwgbm8gc2VjdXJpdHkgaW1wbGljYXRpb25zIG9mIHRoaXMsIHdlIGp1c3QgbnVsbCB0aGVtIG91dC4KCmZ1bmN0aW9uIGF1dG9SZWNvdmVyKGNvcmUpIHsKICBhc3NlcnQoY29yZS5vcGVuZWQpCgogIHN3aXRjaCAoY29yZS5pZCkgewogICAgY2FzZSAnZ2hycGV4YWJvdXRkbTQ2b21icWhvN21yb3hrbmFzc25udHJ4eDNjdWJmdXg0cWk2dzZoeSc6CiAgICBjYXNlICdxb2FhbmFvNzFzNGhlMXJjZDE5N2QzMzZxZXB5a2s0NDY3Z2VvMXVxOGN3bnptcGI3ODZvJzoKICAgIGNhc2UgJ2ZvbWhkeGduNGo0dHpqcXk2eTdpc2toZmZpbXpva3Q3a3JhZGR5ZDhvcmNodDNyOHE2MW8nOgogICAgY2FzZSAnZDhmNXRheHhyaXQ1MWFwZnRvaTM4ZTViODZoYjk4Y2dmZDdkZnAzdW8xdW9oOTVxdDQ5byc6CiAgICBjYXNlICdvYmp5Zjc1dWdnc3FwamN1dDY5eGRnajQ2a3M4cjcxampycTdveGRmc3o5NXNzdGNoa25vJzoKICAgICAgcmV0dXJuIHRydWUKICB9CgogIHJldHVybiBmYWxzZQp9CnsKICAibmFtZSI6ICJhdXRvYmFzZSIsCiAgInZlcnNpb24iOiAiNy4yNC4wIiwKICAiZGVzY3JpcHRpb24iOiAiQSBtdWx0aXdyaXRlciBkYXRhIHN0cnVjdHVyZSBmb3IgSHlwZXJjb3JlIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC4gLS13cml0ZSIsCiAgICAidGVzdCI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYnJpdHRsZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDplbmNyeXB0ZWQiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJyaXR0bGUgdGVzdC9hbGwuanMgLS1lbmNyeXB0LWFsbCIsCiAgICAidGVzdDpmaXh0dXJlcyI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYnJpdHRsZSB0ZXN0L2ZpeHR1cmVzL3Rlc3RzLyouanMiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QvYWxsLmpzIiwKICAgICJmdXp6OmdlbmVyYXRlZCI6ICJicml0dGxlIHRlc3QvcmVmZXJlbmNlL2Z1enovZ2VuZXJhdGVkLyouanMiLAogICAgImZ1eno6bWFpbiI6ICJub2RlIHRlc3QvZnV6ei9pbmRleC5qcyIsCiAgICAiZnV6eiI6ICJub2RlIHRlc3QvcmVmZXJlbmNlL2Z1enovZnV6ei5qcyIsCiAgICAiZ2VuZXJhdGUtZml4dHVyZXMiOiAibm9kZSB0ZXN0L2ZpeHR1cmVzL2dlbmVyYXRlL2FsbC5qcyIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibGliLyoqIiwKICAgICJlbmNvZGluZy8qKiIKICBdLAogICJpbXBvcnRzIjogewogICAgImV2ZW50cyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1ldmVudHMiLAogICAgICAiZGVmYXVsdCI6ICJldmVudHMiCiAgICB9CiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYXV0b2Jhc2UuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYXV0b2Jhc2UvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9hdXRvYmFzZSNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMSIsCiAgICAiYmFyZS1ldmVudHMiOiAiXjIuMi4wIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjE2LjAiLAogICAgImNvcmUtY291cGxlciI6ICJeMi4wLjAiLAogICAgImRlYm91bmNlaWZ5IjogIl4xLjAuMCIsCiAgICAiaHlwZXJiZWUiOiAiXjIuMjIuMCIsCiAgICAiaHlwZXJjb3JlIjogIl4xMS40LjAiLAogICAgImh5cGVyY29yZS1jcnlwdG8iOiAiXjMuNC4wIiwKICAgICJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiAiXjEuMi4wIiwKICAgICJoeXBlcnNjaGVtYSI6ICJeMS4xMi4xIiwKICAgICJpbmRleC1lbmNvZGVyIjogIl4zLjMuMiIsCiAgICAibmFub2Fzc2VydCI6ICJeMi4wLjAiLAogICAgInByb3RvbXV4LXdha2V1cCI6ICJeMi4wLjAiLAogICAgInJlYWR5LXJlc291cmNlIjogIl4xLjAuMCIsCiAgICAicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6ICJeMS4xLjAiLAogICAgInNhZmV0eS1jYXRjaCI6ICJeMS4wLjIiLAogICAgInNjb3BlLWxvY2siOiAiXjEuMi40IiwKICAgICJzaWduYWwtcHJvbWlzZSI6ICJeMS4wLjMiLAogICAgInNvZGl1bS11bml2ZXJzYWwiOiAiXjUuMC4xIiwKICAgICJzdWItZW5jb2RlciI6ICJeMi4xLjEiLAogICAgInRpbnktYnVmZmVyLW1hcCI6ICJeMS4xLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImF1dG9iYXNlLXRlc3QtaGVscGVycyI6ICJeMy4wLjAiLAogICAgImJyaXR0bGUiOiAiXjMuMS4xIiwKICAgICJjb3Jlc3RvcmUiOiAiXjcuMC4xNSIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIsCiAgICAicmFjaGUiOiAiXjEuMC4wIiwKICAgICJzYW1lLWRhdGEiOiAiXjEuMC4wIiwKICAgICJ0YXNrLWJhY2tvZmYiOiAiXjEuMC4wIiwKICAgICJ0ZXN0LXRtcCI6ICJeMS4yLjAiLAogICAgInVuY2F1Z2h0cyI6ICJeMS4xLjAiCiAgfSwKICAic3RhbmRhcmQiOiB7CiAgICAiaWdub3JlIjogWwogICAgICAiKiovdGVzdC9mdXp6L2dlbmVyYXRlZC8qKiIsCiAgICAgICIqKi90ZXN0L3JlZmVyZW5jZS8qKiIsCiAgICAgICJleGFtcGxlLm1qcyIKICAgIF0KICB9Cn0KZnVuY3Rpb24gaXNCdWZmZXIodmFsdWUpIHsKICByZXR1cm4gQnVmZmVyLmlzQnVmZmVyKHZhbHVlKSB8fCB2YWx1ZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkKfQoKZnVuY3Rpb24gaXNFbmNvZGluZyhlbmNvZGluZykgewogIHJldHVybiBCdWZmZXIuaXNFbmNvZGluZyhlbmNvZGluZykKfQoKZnVuY3Rpb24gYWxsb2Moc2l6ZSwgZmlsbCwgZW5jb2RpbmcpIHsKICByZXR1cm4gQnVmZmVyLmFsbG9jKHNpemUsIGZpbGwsIGVuY29kaW5nKQp9CgpmdW5jdGlvbiBhbGxvY1Vuc2FmZShzaXplKSB7CiAgcmV0dXJuIEJ1ZmZlci5hbGxvY1Vuc2FmZShzaXplKQp9CgpmdW5jdGlvbiBhbGxvY1Vuc2FmZVNsb3coc2l6ZSkgewogIHJldHVybiBCdWZmZXIuYWxsb2NVbnNhZmVTbG93KHNpemUpCn0KCmZ1bmN0aW9uIGJ5dGVMZW5ndGgoc3RyaW5nLCBlbmNvZGluZykgewogIHJldHVybiBCdWZmZXIuYnl0ZUxlbmd0aChzdHJpbmcsIGVuY29kaW5nKQp9CgpmdW5jdGlvbiBjb21wYXJlKGEsIGIpIHsKICByZXR1cm4gQnVmZmVyLmNvbXBhcmUoYSwgYikKfQoKZnVuY3Rpb24gY29uY2F0KGJ1ZmZlcnMsIHRvdGFsTGVuZ3RoKSB7CiAgcmV0dXJuIEJ1ZmZlci5jb25jYXQoYnVmZmVycywgdG90YWxMZW5ndGgpCn0KCmZ1bmN0aW9uIGNvcHkoc291cmNlLCB0YXJnZXQsIHRhcmdldFN0YXJ0LCBzdGFydCwgZW5kKSB7CiAgcmV0dXJuIHRvQnVmZmVyKHNvdXJjZSkuY29weSh0YXJnZXQsIHRhcmdldFN0YXJ0LCBzdGFydCwgZW5kKQp9CgpmdW5jdGlvbiBlcXVhbHMoYSwgYikgewogIHJldHVybiB0b0J1ZmZlcihhKS5lcXVhbHMoYikKfQoKZnVuY3Rpb24gZmlsbChidWZmZXIsIHZhbHVlLCBvZmZzZXQsIGVuZCwgZW5jb2RpbmcpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5maWxsKHZhbHVlLCBvZmZzZXQsIGVuZCwgZW5jb2RpbmcpCn0KCmZ1bmN0aW9uIGZyb20odmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewogIHJldHVybiBCdWZmZXIuZnJvbSh2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQp9CgpmdW5jdGlvbiBpbmNsdWRlcyhidWZmZXIsIHZhbHVlLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLmluY2x1ZGVzKHZhbHVlLCBieXRlT2Zmc2V0LCBlbmNvZGluZykKfQoKZnVuY3Rpb24gaW5kZXhPZihidWZmZXIsIHZhbHVlLCBieWZlT2Zmc2V0LCBlbmNvZGluZykgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLmluZGV4T2YodmFsdWUsIGJ5ZmVPZmZzZXQsIGVuY29kaW5nKQp9CgpmdW5jdGlvbiBsYXN0SW5kZXhPZihidWZmZXIsIHZhbHVlLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLmxhc3RJbmRleE9mKHZhbHVlLCBieXRlT2Zmc2V0LCBlbmNvZGluZykKfQoKZnVuY3Rpb24gc3dhcDE2KGJ1ZmZlcikgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnN3YXAxNigpCn0KCmZ1bmN0aW9uIHN3YXAzMihidWZmZXIpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5zd2FwMzIoKQp9CgpmdW5jdGlvbiBzd2FwNjQoYnVmZmVyKSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikuc3dhcDY0KCkKfQoKZnVuY3Rpb24gdG9CdWZmZXIoYnVmZmVyKSB7CiAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihidWZmZXIpKSByZXR1cm4gYnVmZmVyCiAgcmV0dXJuIEJ1ZmZlci5mcm9tKGJ1ZmZlci5idWZmZXIsIGJ1ZmZlci5ieXRlT2Zmc2V0LCBidWZmZXIuYnl0ZUxlbmd0aCkKfQoKZnVuY3Rpb24gdG9TdHJpbmcoYnVmZmVyLCBlbmNvZGluZywgc3RhcnQsIGVuZCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnRvU3RyaW5nKGVuY29kaW5nLCBzdGFydCwgZW5kKQp9CgpmdW5jdGlvbiB3cml0ZShidWZmZXIsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgsIGVuY29kaW5nKSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikud3JpdGUoc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCwgZW5jb2RpbmcpCn0KCmZ1bmN0aW9uIHJlYWREb3VibGVCRShidWZmZXIsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnJlYWREb3VibGVCRShvZmZzZXQpCn0KCmZ1bmN0aW9uIHJlYWREb3VibGVMRShidWZmZXIsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnJlYWREb3VibGVMRShvZmZzZXQpCn0KCmZ1bmN0aW9uIHJlYWRGbG9hdEJFKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikucmVhZEZsb2F0QkUob2Zmc2V0KQp9CgpmdW5jdGlvbiByZWFkRmxvYXRMRShidWZmZXIsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnJlYWRGbG9hdExFKG9mZnNldCkKfQoKZnVuY3Rpb24gcmVhZEludDMyQkUoYnVmZmVyLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5yZWFkSW50MzJCRShvZmZzZXQpCn0KCmZ1bmN0aW9uIHJlYWRJbnQzMkxFKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikucmVhZEludDMyTEUob2Zmc2V0KQp9CgpmdW5jdGlvbiByZWFkVUludDMyQkUoYnVmZmVyLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5yZWFkVUludDMyQkUob2Zmc2V0KQp9CgpmdW5jdGlvbiByZWFkVUludDMyTEUoYnVmZmVyLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5yZWFkVUludDMyTEUob2Zmc2V0KQp9CgpmdW5jdGlvbiB3cml0ZURvdWJsZUJFKGJ1ZmZlciwgdmFsdWUsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLndyaXRlRG91YmxlQkUodmFsdWUsIG9mZnNldCkKfQoKZnVuY3Rpb24gd3JpdGVEb3VibGVMRShidWZmZXIsIHZhbHVlLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS53cml0ZURvdWJsZUxFKHZhbHVlLCBvZmZzZXQpCn0KCmZ1bmN0aW9uIHdyaXRlRmxvYXRCRShidWZmZXIsIHZhbHVlLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS53cml0ZUZsb2F0QkUodmFsdWUsIG9mZnNldCkKfQoKZnVuY3Rpb24gd3JpdGVGbG9hdExFKGJ1ZmZlciwgdmFsdWUsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLndyaXRlRmxvYXRMRSh2YWx1ZSwgb2Zmc2V0KQp9CgpmdW5jdGlvbiB3cml0ZUludDMyQkUoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikud3JpdGVJbnQzMkJFKHZhbHVlLCBvZmZzZXQpCn0KCmZ1bmN0aW9uIHdyaXRlSW50MzJMRShidWZmZXIsIHZhbHVlLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS53cml0ZUludDMyTEUodmFsdWUsIG9mZnNldCkKfQoKZnVuY3Rpb24gd3JpdGVVSW50MzJCRShidWZmZXIsIHZhbHVlLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS53cml0ZVVJbnQzMkJFKHZhbHVlLCBvZmZzZXQpCn0KCmZ1bmN0aW9uIHdyaXRlVUludDMyTEUoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikud3JpdGVVSW50MzJMRSh2YWx1ZSwgb2Zmc2V0KQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBpc0J1ZmZlciwKICBpc0VuY29kaW5nLAogIGFsbG9jLAogIGFsbG9jVW5zYWZlLAogIGFsbG9jVW5zYWZlU2xvdywKICBieXRlTGVuZ3RoLAogIGNvbXBhcmUsCiAgY29uY2F0LAogIGNvcHksCiAgZXF1YWxzLAogIGZpbGwsCiAgZnJvbSwKICBpbmNsdWRlcywKICBpbmRleE9mLAogIGxhc3RJbmRleE9mLAogIHN3YXAxNiwKICBzd2FwMzIsCiAgc3dhcDY0LAogIHRvQnVmZmVyLAogIHRvU3RyaW5nLAogIHdyaXRlLAogIHJlYWREb3VibGVCRSwKICByZWFkRG91YmxlTEUsCiAgcmVhZEZsb2F0QkUsCiAgcmVhZEZsb2F0TEUsCiAgcmVhZEludDMyQkUsCiAgcmVhZEludDMyTEUsCiAgcmVhZFVJbnQzMkJFLAogIHJlYWRVSW50MzJMRSwKICB3cml0ZURvdWJsZUJFLAogIHdyaXRlRG91YmxlTEUsCiAgd3JpdGVGbG9hdEJFLAogIHdyaXRlRmxvYXRMRSwKICB3cml0ZUludDMyQkUsCiAgd3JpdGVJbnQzMkxFLAogIHdyaXRlVUludDMyQkUsCiAgd3JpdGVVSW50MzJMRQp9CnsKICAibmFtZSI6ICJiNGEiLAogICJ2ZXJzaW9uIjogIjEuNy4zIiwKICAiZGVzY3JpcHRpb24iOiAiQnJpZGdpbmcgdGhlIGdhcCBiZXR3ZWVuIGJ1ZmZlcnMgYW5kIHR5cGVkIGFycmF5cyIsCiAgImV4cG9ydHMiOiB7CiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuIjogewogICAgICAicmVhY3QtbmF0aXZlIjogIi4vcmVhY3QtbmF0aXZlLmpzIiwKICAgICAgImJyb3dzZXIiOiAiLi9icm93c2VyLmpzIiwKICAgICAgImRlZmF1bHQiOiAiLi9pbmRleC5qcyIKICAgIH0KICB9LAogICJmaWxlcyI6IFsKICAgICJicm93c2VyLmpzIiwKICAgICJpbmRleC5qcyIsCiAgICAicmVhY3QtbmF0aXZlLmpzIiwKICAgICJsaWIiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogIm5wbSBydW4gbGludCAmJiBucG0gcnVuIHRlc3Q6YmFyZSAmJiBucG0gcnVuIHRlc3Q6bm9kZSIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC5tanMiLAogICAgInRlc3Q6bm9kZSI6ICJub2RlIHRlc3QubWpzIiwKICAgICJsaW50IjogInByZXR0aWVyIC4gLS1jaGVjayIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iNGEuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYjRhL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYjRhI3JlYWRtZSIsCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjUuMiIsCiAgICAibmFub2JlbmNoIjogIl4zLjAuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4xLjAuMCIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzIjogewogICAgInJlYWN0LW5hdGl2ZS1iNGEiOiAiKiIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzTWV0YSI6IHsKICAgICJyZWFjdC1uYXRpdmUtYjRhIjogewogICAgICAib3B0aW9uYWwiOiB0cnVlCiAgICB9CiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZS5hZGRvbigpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vbGliL2NvbnN0YW50cycpCmNvbnN0IEhhc2ggPSByZXF1aXJlKCcuL2xpYi9oYXNoJykKY29uc3QgSG1hYyA9IHJlcXVpcmUoJy4vbGliL2htYWMnKQpjb25zdCB7IENpcGhlcml2LCBEZWNpcGhlcml2IH0gPSByZXF1aXJlKCcuL2xpYi9jaXBoZXInKQpjb25zdCB7IHJhbmRvbUJ5dGVzLCByYW5kb21GaWxsLCByYW5kb21VVUlEIH0gPSByZXF1aXJlKCcuL2xpYi9yYW5kb20nKQpjb25zdCBwYmtkZjIgPSByZXF1aXJlKCcuL2xpYi9wYmtkZjInKQpjb25zdCB7IGdlbmVyYXRlS2V5UGFpciB9ID0gcmVxdWlyZSgnLi9saWIva2V5JykKY29uc3QgeyBzaWduLCB2ZXJpZnkgfSA9IHJlcXVpcmUoJy4vbGliL3NpZ25hdHVyZScpCgpleHBvcnRzLmNvbnN0YW50cyA9IGNvbnN0YW50cwoKZXhwb3J0cy5IYXNoID0gSGFzaAoKZXhwb3J0cy5jcmVhdGVIYXNoID0gZnVuY3Rpb24gY3JlYXRlSGFzaChhbGdvcml0aG0sIG9wdHMpIHsKICByZXR1cm4gbmV3IEhhc2goYWxnb3JpdGhtLCBvcHRzKQp9CgpleHBvcnRzLkhtYWMgPSBIbWFjCgpleHBvcnRzLmNyZWF0ZUhtYWMgPSBmdW5jdGlvbiBjcmVhdGVIbWFjKGFsZ29yaXRobSwga2V5LCBvcHRzKSB7CiAgcmV0dXJuIG5ldyBIbWFjKGFsZ29yaXRobSwga2V5LCBvcHRzKQp9CgpleHBvcnRzLkNpcGhlcml2ID0gQ2lwaGVyaXYKCmV4cG9ydHMuY3JlYXRlQ2lwaGVyaXYgPSBmdW5jdGlvbiBjcmVhdGVDaXBoZXJpdihhbGdvcml0aG0sIGtleSwgaXYsIG9wdHMpIHsKICByZXR1cm4gbmV3IENpcGhlcml2KGFsZ29yaXRobSwga2V5LCBpdiwgb3B0cykKfQoKZXhwb3J0cy5EZWNpcGhlcml2ID0gRGVjaXBoZXJpdgoKZXhwb3J0cy5jcmVhdGVEZWNpcGhlcml2ID0gZnVuY3Rpb24gY3JlYXRlRGVjaXBoZXJpdihhbGdvcml0aG0sIGtleSwgaXYsIG9wdHMpIHsKICByZXR1cm4gbmV3IERlY2lwaGVyaXYoYWxnb3JpdGhtLCBrZXksIGl2LCBvcHRzKQp9CgpleHBvcnRzLnJhbmRvbUJ5dGVzID0gcmFuZG9tQnl0ZXMKCmV4cG9ydHMucmFuZG9tRmlsbCA9IHJhbmRvbUZpbGwKCi8vIEZvciBOb2RlLmpzIGNvbXBhdGliaWxpdHkKZXhwb3J0cy5yYW5kb21GaWxsU3luYyA9IGZ1bmN0aW9uIHJhbmRvbUZpbGxTeW5jKGJ1ZmZlciwgb2Zmc2V0LCBzaXplKSB7CiAgcmV0dXJuIGV4cG9ydHMucmFuZG9tRmlsbChidWZmZXIsIG9mZnNldCwgc2l6ZSkKfQoKZXhwb3J0cy5yYW5kb21VVUlEID0gcmFuZG9tVVVJRAoKZXhwb3J0cy5wYmtkZjIgPSBwYmtkZjIKCi8vIEZvciBOb2RlLmpzIGNvbXBhdGliaWxpdHkKZXhwb3J0cy5wYmtkZjJTeW5jID0gZnVuY3Rpb24gcGJrZGYyU3luYyhwYXNzd29yZCwgc2FsdCwgaXRlcmF0aW9ucywga2V5bGVuLCBkaWdlc3QpIHsKICByZXR1cm4gZXhwb3J0cy5wYmtkZjIocGFzc3dvcmQsIHNhbHQsIGl0ZXJhdGlvbnMsIGtleWxlbiwgZGlnZXN0KQp9CgpleHBvcnRzLmdlbmVyYXRlS2V5UGFpciA9IGdlbmVyYXRlS2V5UGFpcgoKZXhwb3J0cy5zaWduID0gc2lnbgoKZXhwb3J0cy52ZXJpZnkgPSB2ZXJpZnkKCi8vIEZvciBOb2RlLmpzIGNvbXBhdGliaWxpdHkKZXhwb3J0cy53ZWJjcnlwdG8gPSByZXF1aXJlKCcuL3dlYicpCmNvbnN0IHsgVHJhbnNmb3JtIH0gPSByZXF1aXJlKCdiYXJlLXN0cmVhbScpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKY29uc3QgewogIGNpcGhlcjogewogICAgQUVTMTI4RUNCLAogICAgQUVTMTI4Q0JDLAogICAgQUVTMTI4Q1RSLAogICAgQUVTMTI4T0ZCLAogICAgQUVTMjU2RUNCLAogICAgQUVTMjU2Q0JDLAogICAgQUVTMjU2Q1RSLAogICAgQUVTMjU2T0ZCLAogICAgQUVTMTI4R0NNLAogICAgQUVTMjU2R0NNLAogICAgQ0hBQ0hBMjBQT0xZMTMwNSwKICAgIFhDSEFDSEEyMFBPTFkxMzA1CiAgfQp9ID0gY29uc3RhbnRzCgpjbGFzcyBDcnlwdG9DaXBoZXIgewogIGNvbnN0cnVjdG9yKGFsZ29yaXRobSwga2V5LCBpdiwgZW5jcnlwdCwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IGVuY29kaW5nID0gJ3V0ZjgnIH0gPSBvcHRzCgogICAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnKSBrZXkgPSBCdWZmZXIuZnJvbShrZXksIGVuY29kaW5nKQogICAgaWYgKHR5cGVvZiBpdiA9PT0gJ3N0cmluZycpIGl2ID0gQnVmZmVyLmZyb20oaXYsIGVuY29kaW5nKQoKICAgIGlmIChrZXkuYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jaXBoZXJLZXlMZW5ndGgoYWxnb3JpdGhtKSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW52YWxpZCBrZXkgbGVuZ3RoJykKICAgIH0KCiAgICBpZiAoaXYuYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY2lwaGVySVZMZW5ndGgoYWxnb3JpdGhtKSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW52YWxpZCBpdiBsZW5ndGgnKQogICAgfQoKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcuY2lwaGVySW5pdCgKICAgICAgYWxnb3JpdGhtLAogICAgICBrZXkuYnVmZmVyLAogICAgICBrZXkuYnl0ZU9mZnNldCwKICAgICAga2V5LmJ5dGVMZW5ndGgsCiAgICAgIGl2LmJ1ZmZlciwKICAgICAgaXYuYnl0ZU9mZnNldCwKICAgICAgaXYuYnl0ZUxlbmd0aCwKICAgICAgZW5jcnlwdAogICAgKQogIH0KCiAgdXBkYXRlKGRhdGEsIGlucHV0RW5jb2RpbmcgPSAndXRmOCcsIG91dHB1dEVuY29kaW5nKSB7CiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSBkYXRhID0gQnVmZmVyLmZyb20oZGF0YSwgaW5wdXRFbmNvZGluZykKCiAgICBjb25zdCBvdXQgPSBuZXcgQXJyYXlCdWZmZXIoYmluZGluZy5jaXBoZXJCbG9ja1NpemUodGhpcy5faGFuZGxlKSkKCiAgICBjb25zdCB3cml0dGVuID0gYmluZGluZy5jaXBoZXJVcGRhdGUoCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgZGF0YS5idWZmZXIsCiAgICAgIGRhdGEuYnl0ZU9mZnNldCwKICAgICAgZGF0YS5ieXRlTGVuZ3RoLAogICAgICBvdXQKICAgICkKCiAgICBjb25zdCByZXN1bHQgPSBCdWZmZXIuZnJvbShvdXQsIDAsIHdyaXR0ZW4pCgogICAgcmV0dXJuIG91dHB1dEVuY29kaW5nID8gcmVzdWx0LnRvU3RyaW5nKG91dHB1dEVuY29kaW5nKSA6IHJlc3VsdAogIH0KCiAgZmluYWwob3V0cHV0RW5jb2RpbmcpIHsKICAgIGNvbnN0IG91dCA9IG5ldyBBcnJheUJ1ZmZlcihiaW5kaW5nLmNpcGhlckJsb2NrU2l6ZSh0aGlzLl9oYW5kbGUpKQoKICAgIGNvbnN0IHdyaXR0ZW4gPSBiaW5kaW5nLmNpcGhlckZpbmFsKHRoaXMuX2hhbmRsZSwgb3V0KQoKICAgIGNvbnN0IHJlc3VsdCA9IEJ1ZmZlci5mcm9tKG91dCwgMCwgd3JpdHRlbikKCiAgICByZXR1cm4gb3V0cHV0RW5jb2RpbmcgPyByZXN1bHQudG9TdHJpbmcob3V0cHV0RW5jb2RpbmcpIDogcmVzdWx0CiAgfQoKICBzZXRBdXRvUGFkZGluZyhwYWQpIHsKICAgIGJpbmRpbmcuY2lwaGVyU2V0UGFkZGluZyhwYWQpCiAgfQp9CgpjbGFzcyBDcnlwdG9BdXRoZW50aWNhdGVkQ2lwaGVyIHsKICBjb25zdHJ1Y3RvcihhbGdvcml0aG0sIGtleSwgbm9uY2UsIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyBlbmNvZGluZyA9ICd1dGY4JywgYXV0aFRhZ0xlbmd0aCA9IDE2IH0gPSBvcHRzCgogICAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnKSBrZXkgPSBCdWZmZXIuZnJvbShrZXksIGVuY29kaW5nKQogICAgaWYgKHR5cGVvZiBub25jZSA9PT0gJ3N0cmluZycpIG5vbmNlID0gQnVmZmVyLmZyb20obm9uY2UsIGVuY29kaW5nKQoKICAgIGlmIChrZXkuYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5hZWFkS2V5TGVuZ3RoKGFsZ29yaXRobSkpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0ludmFsaWQga2V5IGxlbmd0aCcpCiAgICB9CgogICAgaWYgKG5vbmNlLmJ5dGVMZW5ndGggPCBiaW5kaW5nLmFlYWROb25jZUxlbmd0aChhbGdvcml0aG0pKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbnZhbGlkIG5vbmNlIGxlbmd0aCcpCiAgICB9CgogICAgdGhpcy5fYnVmZmVyID0gW10KICAgIHRoaXMuX25vbmNlID0gbm9uY2UKICAgIHRoaXMuX2F1dGhUYWcgPSBudWxsCiAgICB0aGlzLl9hdXRoVGFnTGVuZ3RoID0gYXV0aFRhZ0xlbmd0aAogICAgdGhpcy5fYWRkaXRpb25hbERhdGEgPSBudWxsCgogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5hZWFkSW5pdCgKICAgICAgYWxnb3JpdGhtLAogICAgICBrZXkuYnVmZmVyLAogICAgICBrZXkuYnl0ZU9mZnNldCwKICAgICAga2V5LmJ5dGVMZW5ndGgsCiAgICAgIGF1dGhUYWdMZW5ndGgKICAgICkKICB9CgogIHVwZGF0ZShkYXRhLCBpbnB1dEVuY29kaW5nID0gJ3V0ZjgnLCBvdXRwdXRFbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEsIGlucHV0RW5jb2RpbmcpCgogICAgdGhpcy5fYnVmZmVyLnB1c2goZGF0YSkKCiAgICByZXR1cm4gb3V0cHV0RW5jb2RpbmcgPyAnJyA6IEJ1ZmZlci5hbGxvYygwKQogIH0KCiAgc2V0QUFEKGJ1ZmZlciwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IGVuY29kaW5nID0gJ3V0ZjgnIH0gPSBvcHRzCgogICAgaWYgKHR5cGVvZiBidWZmZXIgPT09ICdzdHJpbmcnKSBidWZmZXIgPSBCdWZmZXIuZnJvbShidWZmZXIsIGVuY29kaW5nKQoKICAgIHRoaXMuX2FkZGl0aW9uYWxEYXRhID0gYnVmZmVyCiAgfQoKICBnZXRBdXRoVGFnKCkgewogICAgcmV0dXJuIHRoaXMuX2F1dGhUYWcKICB9CgogIHNldEF1dGhUYWcoYXV0aFRhZywgZW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgYXV0aFRhZyA9PT0gJ3N0cmluZycpIGF1dGhUYWcgPSBCdWZmZXIuZnJvbShhdXRoVGFnLCBlbmNvZGluZykKCiAgICB0aGlzLl9hdXRoVGFnID0gYXV0aFRhZwogIH0KfQoKY2xhc3MgQ3J5cHRvQXV0aGVudGljYXRlZFNlYWwgZXh0ZW5kcyBDcnlwdG9BdXRoZW50aWNhdGVkQ2lwaGVyIHsKICBmaW5hbChvdXRwdXRFbmNvZGluZykgewogICAgY29uc3QgZGF0YSA9IHRoaXMuX2J1ZmZlci5sZW5ndGggPT09IDEgPyB0aGlzLl9idWZmZXJbMF0gOiBCdWZmZXIuY29uY2F0KHRoaXMuX2J1ZmZlcikKCiAgICBjb25zdCBub25jZSA9IHRoaXMuX25vbmNlCiAgICBjb25zdCBhZCA9IHRoaXMuX2FkZGl0aW9uYWxEYXRhIHx8IEJ1ZmZlci5hbGxvYygwKQoKICAgIGNvbnN0IG91dCA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhLmJ5dGVMZW5ndGggKyBiaW5kaW5nLmFlYWRNYXhPdmVyaGVhZCh0aGlzLl9oYW5kbGUpKQoKICAgIGJpbmRpbmcuYWVhZFNlYWwoCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgZGF0YS5idWZmZXIsCiAgICAgIGRhdGEuYnl0ZU9mZnNldCwKICAgICAgZGF0YS5ieXRlTGVuZ3RoLAogICAgICBub25jZS5idWZmZXIsCiAgICAgIG5vbmNlLmJ5dGVPZmZzZXQsCiAgICAgIG5vbmNlLmJ5dGVMZW5ndGgsCiAgICAgIGFkLmJ1ZmZlciwKICAgICAgYWQuYnl0ZU9mZnNldCwKICAgICAgYWQuYnl0ZUxlbmd0aCwKICAgICAgb3V0CiAgICApCgogICAgY29uc3Qgd3JpdHRlbiA9IG91dC5ieXRlTGVuZ3RoIC0gdGhpcy5fYXV0aFRhZ0xlbmd0aAoKICAgIHRoaXMuX2F1dGhUYWcgPSBCdWZmZXIuZnJvbShvdXQsIHdyaXR0ZW4pCgogICAgY29uc3QgcmVzdWx0ID0gQnVmZmVyLmZyb20ob3V0LCAwLCB3cml0dGVuKQoKICAgIHJldHVybiBvdXRwdXRFbmNvZGluZyA/IHJlc3VsdC50b1N0cmluZyhvdXRwdXRFbmNvZGluZykgOiByZXN1bHQKICB9Cn0KCmNsYXNzIENyeXB0b0F1dGhlbnRpY2F0ZWRPcGVuIGV4dGVuZHMgQ3J5cHRvQXV0aGVudGljYXRlZENpcGhlciB7CiAgZmluYWwob3V0cHV0RW5jb2RpbmcpIHsKICAgIHRoaXMuX2J1ZmZlci5wdXNoKHRoaXMuX2F1dGhUYWcpCgogICAgY29uc3QgZGF0YSA9IEJ1ZmZlci5jb25jYXQodGhpcy5fYnVmZmVyKQoKICAgIGNvbnN0IG5vbmNlID0gdGhpcy5fbm9uY2UKICAgIGNvbnN0IGFkID0gdGhpcy5fYWRkaXRpb25hbERhdGEgfHwgQnVmZmVyLmFsbG9jKDApCgogICAgY29uc3Qgb3V0ID0gbmV3IEFycmF5QnVmZmVyKGRhdGEuYnl0ZUxlbmd0aCkKCiAgICBiaW5kaW5nLmFlYWRPcGVuKAogICAgICB0aGlzLl9oYW5kbGUsCiAgICAgIGRhdGEuYnVmZmVyLAogICAgICBkYXRhLmJ5dGVPZmZzZXQsCiAgICAgIGRhdGEuYnl0ZUxlbmd0aCwKICAgICAgbm9uY2UuYnVmZmVyLAogICAgICBub25jZS5ieXRlT2Zmc2V0LAogICAgICBub25jZS5ieXRlTGVuZ3RoLAogICAgICBhZC5idWZmZXIsCiAgICAgIGFkLmJ5dGVPZmZzZXQsCiAgICAgIGFkLmJ5dGVMZW5ndGgsCiAgICAgIG91dAogICAgKQoKICAgIGNvbnN0IHdyaXR0ZW4gPSBvdXQuYnl0ZUxlbmd0aCAtIHRoaXMuX2F1dGhUYWdMZW5ndGgKCiAgICBjb25zdCByZXN1bHQgPSBCdWZmZXIuZnJvbShvdXQsIDAsIHdyaXR0ZW4pCgogICAgcmV0dXJuIG91dHB1dEVuY29kaW5nID8gcmVzdWx0LnRvU3RyaW5nKG91dHB1dEVuY29kaW5nKSA6IHJlc3VsdAogIH0KfQoKZXhwb3J0cy5DaXBoZXJpdiA9IGNsYXNzIENyeXB0b0NpcGhlcml2IGV4dGVuZHMgVHJhbnNmb3JtIHsKICBjb25zdHJ1Y3RvcihhbGdvcml0aG0sIGtleSwgaXYsIG9wdHMgPSB7fSkgewogICAgc3VwZXIob3B0cykKCiAgICBhbGdvcml0aG0gPSBjb25zdGFudHMudG9DaXBoZXIoYWxnb3JpdGhtKQoKICAgIHN3aXRjaCAoYWxnb3JpdGhtKSB7CiAgICAgIGNhc2UgQUVTMTI4RUNCOgogICAgICBjYXNlIEFFUzEyOENCQzoKICAgICAgY2FzZSBBRVMxMjhDVFI6CiAgICAgIGNhc2UgQUVTMTI4T0ZCOgogICAgICBjYXNlIEFFUzI1NkVDQjoKICAgICAgY2FzZSBBRVMyNTZDQkM6CiAgICAgIGNhc2UgQUVTMjU2Q1RSOgogICAgICBjYXNlIEFFUzI1Nk9GQjoKICAgICAgICB0aGlzLl9jaXBoZXIgPSBuZXcgQ3J5cHRvQ2lwaGVyKGFsZ29yaXRobSwga2V5LCBpdiwgdHJ1ZSwgb3B0cykKICAgICAgICBicmVhawoKICAgICAgY2FzZSBBRVMxMjhHQ006CiAgICAgIGNhc2UgQUVTMjU2R0NNOgogICAgICBjYXNlIENIQUNIQTIwUE9MWTEzMDU6CiAgICAgIGNhc2UgWENIQUNIQTIwUE9MWTEzMDU6CiAgICAgICAgdGhpcy5fY2lwaGVyID0gbmV3IENyeXB0b0F1dGhlbnRpY2F0ZWRTZWFsKGFsZ29yaXRobSwga2V5LCBpdiwgb3B0cykKICAgICAgICBicmVhawogICAgfQogIH0KCiAgdXBkYXRlKGRhdGEsIGlucHV0RW5jb2RpbmcsIG91dHB1dEVuY29kaW5nKSB7CiAgICByZXR1cm4gdGhpcy5fY2lwaGVyLnVwZGF0ZShkYXRhLCBpbnB1dEVuY29kaW5nLCBvdXRwdXRFbmNvZGluZykKICB9CgogIGZpbmFsKG91dHB1dEVuY29kaW5nKSB7CiAgICByZXR1cm4gdGhpcy5fY2lwaGVyLmZpbmFsKG91dHB1dEVuY29kaW5nKQogIH0KCiAgc2V0QXV0b1BhZGRpbmcocGFkKSB7CiAgICB0aGlzLl9jaXBoZXIuc2V0QXV0b1BhZGRpbmcocGFkKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBzZXRBQUQoYnVmZmVyLCBvcHRzKSB7CiAgICB0aGlzLl9jaXBoZXIuc2V0QUFEKGJ1ZmZlciwgb3B0cykKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgZ2V0QXV0aFRhZygpIHsKICAgIHJldHVybiB0aGlzLl9jaXBoZXIuZ2V0QXV0aFRhZygpCiAgfQoKICBfdHJhbnNmb3JtKGRhdGEsIGVuY29kaW5nLCBjYikgewogICAgdGhpcy51cGRhdGUoZGF0YSkKCiAgICBjYihudWxsKQogIH0KCiAgX2ZsdXNoKGNiKSB7CiAgICB0aGlzLnB1c2godGhpcy5kaWdlc3QoKSkKCiAgICBjYihudWxsKQogIH0KfQoKZXhwb3J0cy5EZWNpcGhlcml2ID0gY2xhc3MgQ3J5cHRvRGVpcGhlcml2IGV4dGVuZHMgVHJhbnNmb3JtIHsKICBjb25zdHJ1Y3RvcihhbGdvcml0aG0sIGtleSwgaXYsIG9wdHMgPSB7fSkgewogICAgc3VwZXIob3B0cykKCiAgICBhbGdvcml0aG0gPSBjb25zdGFudHMudG9DaXBoZXIoYWxnb3JpdGhtKQoKICAgIHN3aXRjaCAoYWxnb3JpdGhtKSB7CiAgICAgIGNhc2UgQUVTMTI4RUNCOgogICAgICBjYXNlIEFFUzEyOENCQzoKICAgICAgY2FzZSBBRVMxMjhDVFI6CiAgICAgIGNhc2UgQUVTMTI4T0ZCOgogICAgICBjYXNlIEFFUzI1NkVDQjoKICAgICAgY2FzZSBBRVMyNTZDQkM6CiAgICAgIGNhc2UgQUVTMjU2Q1RSOgogICAgICBjYXNlIEFFUzI1Nk9GQjoKICAgICAgICB0aGlzLl9jaXBoZXIgPSBuZXcgQ3J5cHRvQ2lwaGVyKGFsZ29yaXRobSwga2V5LCBpdiwgZmFsc2UsIG9wdHMpCiAgICAgICAgYnJlYWsKCiAgICAgIGNhc2UgQUVTMTI4R0NNOgogICAgICBjYXNlIEFFUzI1NkdDTToKICAgICAgY2FzZSBDSEFDSEEyMFBPTFkxMzA1OgogICAgICBjYXNlIFhDSEFDSEEyMFBPTFkxMzA1OgogICAgICAgIHRoaXMuX2NpcGhlciA9IG5ldyBDcnlwdG9BdXRoZW50aWNhdGVkT3BlbihhbGdvcml0aG0sIGtleSwgaXYsIG9wdHMpCiAgICAgICAgYnJlYWsKICAgIH0KICB9CgogIHVwZGF0ZShkYXRhLCBpbnB1dEVuY29kaW5nLCBvdXRwdXRFbmNvZGluZykgewogICAgcmV0dXJuIHRoaXMuX2NpcGhlci51cGRhdGUoZGF0YSwgaW5wdXRFbmNvZGluZywgb3V0cHV0RW5jb2RpbmcpCiAgfQoKICBmaW5hbChvdXRwdXRFbmNvZGluZykgewogICAgcmV0dXJuIHRoaXMuX2NpcGhlci5maW5hbChvdXRwdXRFbmNvZGluZykKICB9CgogIHNldEF1dG9QYWRkaW5nKHBhZCkgewogICAgdGhpcy5fY2lwaGVyLnNldEF1dG9QYWRkaW5nKHBhZCkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgc2V0QUFEKGJ1ZmZlciwgb3B0cykgewogICAgdGhpcy5fY2lwaGVyLnNldEFBRChidWZmZXIsIG9wdHMpCgogICAgcmV0dXJuIHRoaXMKICB9CgogIHNldEF1dGhUYWcoYXV0aFRhZywgZW5jb2RpbmcpIHsKICAgIHRoaXMuX2NpcGhlci5zZXRBdXRoVGFnKGF1dGhUYWcsIGVuY29kaW5nKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBfdHJhbnNmb3JtKGRhdGEsIGVuY29kaW5nLCBjYikgewogICAgdGhpcy51cGRhdGUoZGF0YSkKCiAgICBjYihudWxsKQogIH0KCiAgX2ZsdXNoKGNiKSB7CiAgICB0aGlzLnB1c2godGhpcy5kaWdlc3QoKSkKCiAgICBjYihudWxsKQogIH0KfQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4vZXJyb3JzJykKCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IHsKICBoYXNoOiB7CiAgICBNRDU6IGJpbmRpbmcuTUQ1LAogICAgU0hBMTogYmluZGluZy5TSEExLAogICAgU0hBMjU2OiBiaW5kaW5nLlNIQTI1NiwKICAgIFNIQTUxMjogYmluZGluZy5TSEE1MTIsCiAgICBCTEFLRTJCMjU2OiBiaW5kaW5nLkJMQUtFMkIyNTYKICB9LAogIHNpZ25hdHVyZTogewogICAgRUQyNTUxOTogYmluZGluZy5FRDI1NTE5CiAgfSwKICBjaXBoZXI6IHsKICAgIEFFUzEyOEVDQjogYmluZGluZy5BRVMxMjhFQ0IsCiAgICBBRVMxMjhDQkM6IGJpbmRpbmcuQUVTMTI4Q0JDLAogICAgQUVTMTI4Q1RSOiBiaW5kaW5nLkFFUzEyOENUUiwKICAgIEFFUzEyOE9GQjogYmluZGluZy5BRVMxMjhPRkIsCiAgICBBRVMyNTZFQ0I6IGJpbmRpbmcuQUVTMjU2RUNCLAogICAgQUVTMjU2Q0JDOiBiaW5kaW5nLkFFUzI1NkNCQywKICAgIEFFUzI1NkNUUjogYmluZGluZy5BRVMyNTZDVFIsCiAgICBBRVMyNTZPRkI6IGJpbmRpbmcuQUVTMjU2T0ZCLAogICAgQUVTMTI4R0NNOiBiaW5kaW5nLkFFUzEyOEdDTSwKICAgIEFFUzI1NkdDTTogYmluZGluZy5BRVMyNTZHQ00sCiAgICBDSEFDSEEyMFBPTFkxMzA1OiBiaW5kaW5nLkNIQUNIQTIwUE9MWTEzMDUsCiAgICBYQ0hBQ0hBMjBQT0xZMTMwNTogYmluZGluZy5YQ0hBQ0hBMjBQT0xZMTMwNQogIH0sCiAga2V5VHlwZTogewogICAgRUQyNTUxOTogYmluZGluZy5FRDI1NTE5CiAgfQp9CgpleHBvcnRzLnRvSGFzaCA9IGZ1bmN0aW9uIHRvSGFzaChoYXNoKSB7CiAgaWYgKHR5cGVvZiBoYXNoID09PSAnbnVtYmVyJykgcmV0dXJuIGhhc2gKCiAgaWYgKHR5cGVvZiBoYXNoID09PSAnc3RyaW5nJykgewogICAgaGFzaCA9IGhhc2gucmVwbGFjZSgvLS9nLCAnJykKCiAgICBpZiAoaGFzaCBpbiBleHBvcnRzLmhhc2ggPT09IGZhbHNlKSB7CiAgICAgIGhhc2ggPSBoYXNoLnRvVXBwZXJDYXNlKCkKCiAgICAgIGlmIChoYXNoIGluIGV4cG9ydHMuaGFzaCA9PT0gZmFsc2UpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuVU5LTk9XTl9IQVNIKGBVbmtub3duIGhhc2ggJyR7aGFzaH0nYCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBleHBvcnRzLmhhc2hbaGFzaF0KICB9CgogIHRocm93IG5ldyBUeXBlRXJyb3IoYEhhc2ggbXVzdCBiZSBhIG51bWJlciBvciBzdHJpbmcuIFJlY2VpdmVkICR7dHlwZW9mIGhhc2h9ICgke2hhc2h9KWApCn0KCmV4cG9ydHMudG9DaXBoZXIgPSBmdW5jdGlvbiB0b0NpcGVyKGNpcGhlcikgewogIGlmICh0eXBlb2YgY2lwaGVyID09PSAnbnVtYmVyJykgcmV0dXJuIGNpcGhlcgoKICBpZiAodHlwZW9mIGNpcGhlciA9PT0gJ3N0cmluZycpIHsKICAgIGNpcGhlciA9IGNpcGhlci5yZXBsYWNlKC8tL2csICcnKQoKICAgIGlmIChjaXBoZXIgaW4gZXhwb3J0cy5jaXBoZXIgPT09IGZhbHNlKSB7CiAgICAgIGNpcGhlciA9IGNpcGhlci50b1VwcGVyQ2FzZSgpCgogICAgICBpZiAoY2lwaGVyIGluIGV4cG9ydHMuY2lwaGVyID09PSBmYWxzZSkgewogICAgICAgIHRocm93IGVycm9ycy5VTktOT1dOX0NJUEhFUihgVW5rbm93biBjaXBoZXIgJyR7Y2lwaGVyfSdgKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGV4cG9ydHMuY2lwaGVyW2NpcGhlcl0KICB9CgogIHRocm93IG5ldyBUeXBlRXJyb3IoYENpcGhlciBtdXN0IGJlIGEgbnVtYmVyIG9yIHN0cmluZy4gUmVjZWl2ZWQgJHt0eXBlb2YgY2lwaGVyfSAoJHtjaXBoZXJ9KWApCn0KCmV4cG9ydHMudG9LZXlUeXBlID0gZnVuY3Rpb24gdG9LZXlUeXBlKHR5cGUpIHsKICBpZiAodHlwZW9mIHR5cGUgPT09ICdudW1iZXInKSByZXR1cm4gdHlwZQoKICBpZiAodHlwZW9mIHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICB0eXBlID0gdHlwZS5yZXBsYWNlKC8tL2csICcnKQoKICAgIGlmICh0eXBlIGluIGV4cG9ydHMua2V5VHlwZSA9PT0gZmFsc2UpIHsKICAgICAgdHlwZSA9IHR5cGUudG9VcHBlckNhc2UoKQoKICAgICAgaWYgKHR5cGUgaW4gZXhwb3J0cy5rZXlUeXBlID09PSBmYWxzZSkgewogICAgICAgIHRocm93IGVycm9ycy5VTktOT1dOX0tFWV9UWVBFKGBVbmtub3duIGtleSB0eXBlICcke3R5cGV9J2ApCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZXhwb3J0cy5rZXlUeXBlW3R5cGVdCiAgfQoKICB0aHJvdyBuZXcgVHlwZUVycm9yKGBLZXkgdHlwZSBtdXN0IGJlIGEgbnVtYmVyIG9yIHN0cmluZy4gUmVjZWl2ZWQgJHt0eXBlb2YgdHlwZX0gKCR7dHlwZX0pYCkKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENyeXB0b0Vycm9yIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yKG1zZywgZm4gPSBDcnlwdG9FcnJvciwgY29kZSA9IGZuLm5hbWUpIHsKICAgIHN1cGVyKGAke2NvZGV9OiAke21zZ31gKQogICAgdGhpcy5jb2RlID0gY29kZQoKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBmbikKICAgIH0KICB9CgogIGdldCBuYW1lKCkgewogICAgcmV0dXJuICdDcnlwdG9FcnJvcicKICB9CgogIHN0YXRpYyBVTktOT1dOX0hBU0gobXNnKSB7CiAgICByZXR1cm4gbmV3IENyeXB0b0Vycm9yKG1zZywgQ3J5cHRvRXJyb3IuVU5LTk9XTl9IQVNIKQogIH0KCiAgc3RhdGljIFVOS05PV05fQ0lQSEVSKG1zZykgewogICAgcmV0dXJuIG5ldyBDcnlwdG9FcnJvcihtc2csIENyeXB0b0Vycm9yLlVOS05PV05fQ0lQSEVSKQogIH0KCiAgc3RhdGljIFVOS05PV05fS0VZX1RZUEUobXNnKSB7CiAgICByZXR1cm4gbmV3IENyeXB0b0Vycm9yKG1zZywgQ3J5cHRvRXJyb3IuVU5LTk9XTl9LRVlfVFlQRSkKICB9CgogIHN0YXRpYyBJTlZBTElEX0FDQ0VTUyhtc2cpIHsKICAgIHJldHVybiBuZXcgQ3J5cHRvRXJyb3IobXNnLCBDcnlwdG9FcnJvci5JTlZBTElEX0FDQ0VTUykKICB9CgogIHN0YXRpYyBJTlZBTElEX0RBVEEobXNnKSB7CiAgICByZXR1cm4gbmV3IENyeXB0b0Vycm9yKG1zZywgQ3J5cHRvRXJyb3IuSU5WQUxJRF9EQVRBKQogIH0KCiAgc3RhdGljIE9QRVJBVElPTl9FUlJPUihtc2cpIHsKICAgIHJldHVybiBuZXcgQ3J5cHRvRXJyb3IobXNnLCBDcnlwdG9FcnJvci5PUEVSQVRJT05fRVJST1IpCiAgfQoKICBzdGF0aWMgTk9UX1NVUFBPUlRFRChtc2cpIHsKICAgIHJldHVybiBuZXcgQ3J5cHRvRXJyb3IobXNnLCBDcnlwdG9FcnJvci5OT1RfU1VQUE9SVEVEKQogIH0KfQpjb25zdCB7IFRyYW5zZm9ybSB9ID0gcmVxdWlyZSgnYmFyZS1zdHJlYW0nKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ3J5cHRvSGFzaCBleHRlbmRzIFRyYW5zZm9ybSB7CiAgY29uc3RydWN0b3IoYWxnb3JpdGhtLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKG9wdHMpCgogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5oYXNoSW5pdChjb25zdGFudHMudG9IYXNoKGFsZ29yaXRobSkpCiAgfQoKICB1cGRhdGUoZGF0YSwgZW5jb2RpbmcgPSAndXRmOCcpIHsKICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIGRhdGEgPSBCdWZmZXIuZnJvbShkYXRhLCBlbmNvZGluZykKCiAgICBiaW5kaW5nLmhhc2hVcGRhdGUodGhpcy5faGFuZGxlLCBkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0LCBkYXRhLmJ5dGVMZW5ndGgpCgogICAgcmV0dXJuIHRoaXMKICB9CgogIGRpZ2VzdChlbmNvZGluZykgewogICAgY29uc3QgZGlnZXN0ID0gQnVmZmVyLmZyb20oYmluZGluZy5oYXNoRmluYWwodGhpcy5faGFuZGxlKSkKCiAgICByZXR1cm4gZW5jb2RpbmcgJiYgZW5jb2RpbmcgIT09ICdidWZmZXInID8gZGlnZXN0LnRvU3RyaW5nKGVuY29kaW5nKSA6IGRpZ2VzdAogIH0KCiAgX3RyYW5zZm9ybShkYXRhLCBlbmNvZGluZywgY2IpIHsKICAgIHRoaXMudXBkYXRlKGRhdGEpCgogICAgY2IobnVsbCkKICB9CgogIF9mbHVzaChjYikgewogICAgdGhpcy5wdXNoKHRoaXMuZGlnZXN0KCkpCgogICAgY2IobnVsbCkKICB9Cn0KY29uc3QgeyBUcmFuc2Zvcm0gfSA9IHJlcXVpcmUoJ2JhcmUtc3RyZWFtJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQpjb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENyeXB0b0htYWMgZXh0ZW5kcyBUcmFuc2Zvcm0gewogIGNvbnN0cnVjdG9yKGFsZ29yaXRobSwga2V5LCBvcHRzID0ge30pIHsKICAgIHN1cGVyKG9wdHMpCgogICAgY29uc3QgeyBlbmNvZGluZyA9ICd1dGY4JyB9ID0gb3B0cwoKICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJykga2V5ID0gQnVmZmVyLmZyb20oa2V5LCBlbmNvZGluZykKCiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLmhtYWNJbml0KAogICAgICBjb25zdGFudHMudG9IYXNoKGFsZ29yaXRobSksCiAgICAgIGtleS5idWZmZXIsCiAgICAgIGtleS5ieXRlT2Zmc2V0LAogICAgICBrZXkuYnl0ZUxlbmd0aAogICAgKQogIH0KCiAgdXBkYXRlKGRhdGEsIGVuY29kaW5nID0gJ3V0ZjgnKSB7CiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSBkYXRhID0gQnVmZmVyLmZyb20oZGF0YSwgZW5jb2RpbmcpCgogICAgYmluZGluZy5obWFjVXBkYXRlKHRoaXMuX2hhbmRsZSwgZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCwgZGF0YS5ieXRlTGVuZ3RoKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBkaWdlc3QoZW5jb2RpbmcpIHsKICAgIGNvbnN0IGRpZ2VzdCA9IEJ1ZmZlci5mcm9tKGJpbmRpbmcuaG1hY0ZpbmFsKHRoaXMuX2hhbmRsZSkpCgogICAgcmV0dXJuIGVuY29kaW5nICYmIGVuY29kaW5nICE9PSAnYnVmZmVyJyA/IGRpZ2VzdC50b1N0cmluZyhlbmNvZGluZykgOiBkaWdlc3QKICB9CgogIF90cmFuc2Zvcm0oZGF0YSwgZW5jb2RpbmcsIGNiKSB7CiAgICB0aGlzLnVwZGF0ZShkYXRhKQoKICAgIGNiKG51bGwpCiAgfQoKICBfZmx1c2goY2IpIHsKICAgIHRoaXMucHVzaCh0aGlzLmRpZ2VzdCgpKQoKICAgIGNiKG51bGwpCiAgfQp9CmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKY29uc3QgewogIGtleVR5cGU6IHsgRUQyNTUxOSB9Cn0gPSBjb25zdGFudHMKCmNsYXNzIENyeXB0b0tleSB7CiAgY29uc3RydWN0b3Ioa2V5VHlwZSkgewogICAgdGhpcy5fa2V5VHlwZSA9IGtleVR5cGUKICB9Cn0KCmV4cG9ydHMuS2V5ID0gQ3J5cHRvS2V5CgpjbGFzcyBDcnlwdG9FZDI1NTE5S2V5IGV4dGVuZHMgQ3J5cHRvS2V5IHsKICBjb25zdHJ1Y3RvcihrZXkpIHsKICAgIHN1cGVyKEVEMjU1MTkpCgogICAgdGhpcy5fa2V5ID0ga2V5CiAgfQoKICBnZXQgYXN5bW1ldHJpY0tleVR5cGUoKSB7CiAgICByZXR1cm4gJ2VkMjU1MTknCiAgfQp9CgpjbGFzcyBDcnlwdG9FZDI1NTE5UHVibGljS2V5IGV4dGVuZHMgQ3J5cHRvRWQyNTUxOUtleSB7CiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gJ3B1YmxpYycKICB9Cn0KCmV4cG9ydHMuRWQyNTUxOVB1YmxpY0tleSA9IENyeXB0b0VkMjU1MTlQdWJsaWNLZXkKCmNsYXNzIENyeXB0b0VkMjU1MTlQcml2YXRlS2V5IGV4dGVuZHMgQ3J5cHRvRWQyNTUxOUtleSB7CiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gJ3ByaXZhdGUnCiAgfQp9CgpleHBvcnRzLkVkMjU1MTlQcml2YXRlS2V5ID0gQ3J5cHRvRWQyNTUxOVByaXZhdGVLZXkKCmV4cG9ydHMuZ2VuZXJhdGVLZXlQYWlyID0gZnVuY3Rpb24gZ2VuZXJhdGVLZXlQYWlyKHR5cGUsIG9wdHMgPSB7fSkgewogIHR5cGUgPSBjb25zdGFudHMudG9LZXlUeXBlKHR5cGUpCgogIHN3aXRjaCAodHlwZSkgewogICAgY2FzZSBFRDI1NTE5OiB7CiAgICAgIGNvbnN0IHsgcHVibGljS2V5LCBwcml2YXRlS2V5IH0gPSBiaW5kaW5nLmVkMjU1MTlHZW5lcmF0ZUtleXBhaXIoKQoKICAgICAgcmV0dXJuIHsKICAgICAgICBwdWJsaWNLZXk6IG5ldyBDcnlwdG9FZDI1NTE5UHVibGljS2V5KHB1YmxpY0tleSksCiAgICAgICAgcHJpdmF0ZUtleTogbmV3IENyeXB0b0VkMjU1MTlQcml2YXRlS2V5KHByaXZhdGVLZXkpCiAgICAgIH0KICAgIH0KICB9Cn0KY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQpjb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIHBia2RmMihwYXNzd29yZCwgc2FsdCwgaXRlcmF0aW9ucywga2V5bGVuLCBkaWdlc3QsIGNiKSB7CiAgaWYgKGl0ZXJhdGlvbnMgPD0gMCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ2l0ZXJhdGlvbnMgaXMgb3V0IG9mIHJhbmdlJykKICB9CgogIGlmICh0eXBlb2YgcGFzc3dvcmQgPT09ICdzdHJpbmcnKSBwYXNzd29yZCA9IEJ1ZmZlci5mcm9tKHBhc3N3b3JkKQogIGlmICh0eXBlb2Ygc2FsdCA9PT0gJ3N0cmluZycpIHNhbHQgPSBCdWZmZXIuZnJvbShzYWx0KQoKICBjb25zdCBidWZmZXIgPSBCdWZmZXIuZnJvbSgKICAgIGJpbmRpbmcucGJrZGYyKAogICAgICBwYXNzd29yZC5idWZmZXIsCiAgICAgIHBhc3N3b3JkLmJ5dGVPZmZzZXQsCiAgICAgIHBhc3N3b3JkLmJ5dGVMZW5ndGgsCiAgICAgIHNhbHQuYnVmZmVyLAogICAgICBzYWx0LmJ5dGVPZmZzZXQsCiAgICAgIHNhbHQuYnl0ZUxlbmd0aCwKICAgICAgaXRlcmF0aW9ucywKICAgICAgY29uc3RhbnRzLnRvSGFzaChkaWdlc3QpLAogICAgICBrZXlsZW4KICAgICkKICApCgogIGlmIChjYikgcXVldWVNaWNyb3Rhc2soKCkgPT4gY2IobnVsbCwgYnVmZmVyKSkKICBlbHNlIHJldHVybiBidWZmZXIKfQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCgpleHBvcnRzLnJhbmRvbUJ5dGVzID0gZnVuY3Rpb24gcmFuZG9tQnl0ZXMoc2l6ZSwgY2IpIHsKICBjb25zdCBidWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUoc2l6ZSkKICBleHBvcnRzLnJhbmRvbUZpbGwoYnVmZmVyKQogIGlmIChjYikgcXVldWVNaWNyb3Rhc2soKCkgPT4gY2IobnVsbCwgYnVmZmVyKSkKICBlbHNlIHJldHVybiBidWZmZXIKfQoKZXhwb3J0cy5yYW5kb21GaWxsID0gZnVuY3Rpb24gcmFuZG9tRmlsbChidWZmZXIsIG9mZnNldCwgc2l6ZSwgY2IpIHsKICBpZiAodHlwZW9mIG9mZnNldCA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvZmZzZXQKICAgIG9mZnNldCA9IHVuZGVmaW5lZAogIH0gZWxzZSBpZiAodHlwZW9mIHNpemUgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gc2l6ZQogICAgc2l6ZSA9IHVuZGVmaW5lZAogIH0KCiAgY29uc3QgZWxlbWVudFNpemUgPSBidWZmZXIuQllURVNfUEVSX0VMRU1FTlQgfHwgMQoKICBpZiAob2Zmc2V0ID09PSB1bmRlZmluZWQpIG9mZnNldCA9IDAKICBlbHNlIG9mZnNldCAqPSBlbGVtZW50U2l6ZQoKICBpZiAoc2l6ZSA9PT0gdW5kZWZpbmVkKSBzaXplID0gYnVmZmVyLmJ5dGVMZW5ndGggLSBvZmZzZXQKICBlbHNlIHNpemUgKj0gZWxlbWVudFNpemUKCiAgaWYgKG9mZnNldCA8IDAgfHwgb2Zmc2V0ID4gYnVmZmVyLmJ5dGVMZW5ndGgpIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdvZmZzZXQgaXMgb3V0IG9mIHJhbmdlJykKICB9CgogIGlmIChzaXplIDwgMCB8fCBzaXplID4gYnVmZmVyLmJ5dGVMZW5ndGgpIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdzaXplIGlzIG91dCBvZiByYW5nZScpCiAgfQoKICBpZiAob2Zmc2V0ICsgc2l6ZSA+IGJ1ZmZlci5ieXRlTGVuZ3RoKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignb2Zmc2V0ICsgc2l6ZSBpcyBvdXQgb2YgcmFuZ2UnKQogIH0KCiAgbGV0IGFycmF5YnVmZmVyCgogIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoYnVmZmVyKSkgewogICAgb2Zmc2V0ICs9IGJ1ZmZlci5ieXRlT2Zmc2V0CiAgICBhcnJheWJ1ZmZlciA9IGJ1ZmZlci5idWZmZXIKICB9IGVsc2UgewogICAgYXJyYXlidWZmZXIgPSBidWZmZXIKICB9CgogIGJpbmRpbmcucmFuZG9tRmlsbChhcnJheWJ1ZmZlciwgb2Zmc2V0LCBzaXplKQoKICBpZiAoY2IpIHF1ZXVlTWljcm90YXNrKCgpID0+IGNiKG51bGwsIGJ1ZmZlcikpCiAgZWxzZSByZXR1cm4gYnVmZmVyCn0KCmV4cG9ydHMucmFuZG9tVVVJRCA9IGZ1bmN0aW9uIHJhbmRvbVVVSUQoKSB7CiAgY29uc3QgdXVpZCA9IGV4cG9ydHMucmFuZG9tQnl0ZXMoMTYpCgogIHV1aWRbNl0gPSAodXVpZFs2XSA+Pj4gNCkgfCAwYjAxMDAwMDAwCiAgdXVpZFs4XSA9ICh1dWlkWzhdID4+PiAyKSB8IDBiMTAwMDAwMDAKCiAgcmV0dXJuICgKICAgIHV1aWQuc3ViYXJyYXkoMCwgNCkudG9TdHJpbmcoJ2hleCcpICsKICAgICctJyArCiAgICB1dWlkLnN1YmFycmF5KDQsIDYpLnRvU3RyaW5nKCdoZXgnKSArCiAgICAnLScgKwogICAgdXVpZC5zdWJhcnJheSg2LCA4KS50b1N0cmluZygnaGV4JykgKwogICAgJy0nICsKICAgIHV1aWQuc3ViYXJyYXkoOCwgMTApLnRvU3RyaW5nKCdoZXgnKSArCiAgICAnLScgKwogICAgdXVpZC5zdWJhcnJheSgxMCwgMTYpLnRvU3RyaW5nKCdoZXgnKQogICkKfQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCmNvbnN0IHsKICBrZXlUeXBlOiB7IEVEMjU1MTkgfQp9ID0gY29uc3RhbnRzCgpleHBvcnRzLnNpZ24gPSBmdW5jdGlvbiBzaWduKGFsZ29yaXRobSwgZGF0YSwga2V5KSB7CiAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhkYXRhKSkgewogICAgZGF0YSA9IEJ1ZmZlci5jb2VyY2UoZGF0YSkKICB9IGVsc2UgewogICAgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEpCiAgfQoKICBzd2l0Y2ggKGtleS5fa2V5VHlwZSkgewogICAgY2FzZSBFRDI1NTE5OgogICAgICByZXR1cm4gQnVmZmVyLmZyb20oCiAgICAgICAgYmluZGluZy5lZDI1NTE5U2lnbihkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0LCBkYXRhLmJ5dGVMZW5ndGgsIGtleS5fa2V5KQogICAgICApCiAgfQp9CgpleHBvcnRzLnZlcmlmeSA9IGZ1bmN0aW9uIHZlcmlmeShhbGdvcml0aG0sIGRhdGEsIGtleSwgc2lnbmF0dXJlKSB7CiAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhkYXRhKSkgewogICAgZGF0YSA9IEJ1ZmZlci5jb2VyY2UoZGF0YSkKICB9IGVsc2UgewogICAgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEpCiAgfQoKICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KHNpZ25hdHVyZSkpIHsKICAgIHNpZ25hdHVyZSA9IEJ1ZmZlci5jb2VyY2Uoc2lnbmF0dXJlKQogIH0gZWxzZSB7CiAgICBzaWduYXR1cmUgPSBCdWZmZXIuZnJvbShzaWduYXR1cmUpCiAgfQoKICBzd2l0Y2ggKGtleS5fa2V5VHlwZSkgewogICAgY2FzZSBFRDI1NTE5OgogICAgICByZXR1cm4gYmluZGluZy5lZDI1NTE5VmVyaWZ5KAogICAgICAgIGRhdGEuYnVmZmVyLAogICAgICAgIGRhdGEuYnl0ZU9mZnNldCwKICAgICAgICBkYXRhLmJ5dGVMZW5ndGgsCiAgICAgICAgc2lnbmF0dXJlLmJ1ZmZlciwKICAgICAgICBzaWduYXR1cmUuYnl0ZU9mZnNldCwKICAgICAgICBrZXkuX2tleQogICAgICApCiAgfQp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJy4uLy4uLy4uJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uLy4uLy4uL2JpbmRpbmcnKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuLi8uLi9lcnJvcnMnKQpjb25zdCB7IEVkMjU1MTlQdWJsaWNLZXksIEVkMjU1MTlQcml2YXRlS2V5IH0gPSByZXF1aXJlKCcuLi8uLi9rZXknKQpjb25zdCBDcnlwdG9LZXkgPSByZXF1aXJlKCcuLi9jcnlwdG8ta2V5JykKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2VkMjU1MTkKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2VkMjU1MTktb3BlcmF0aW9ucy1zaWduCmV4cG9ydHMuc2lnbiA9IGZ1bmN0aW9uIHNpZ24oYWxnb3JpdGhtLCBrZXksIGRhdGEpIHsKICBpZiAoa2V5LnR5cGUgIT09ICdwcml2YXRlJykgewogICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKCdNdXN0IHBhc3MgcHJpdmF0ZSBrZXkgZm9yIEVkMjU1MTkgc2lnbmluZycpCiAgfQoKICBjb25zdCBzaWduYXR1cmUgPSBjcnlwdG8uc2lnbihudWxsLCBkYXRhLCBrZXkuX2hhbmRsZSkKCiAgcmV0dXJuIHNpZ25hdHVyZS5idWZmZXIuc2xpY2UoMCwgc2lnbmF0dXJlLmJ5dGVMZW5ndGgpCn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2VkMjU1MTktb3BlcmF0aW9ucy12ZXJpZnkKZXhwb3J0cy52ZXJpZnkgPSBmdW5jdGlvbiB2ZXJpZnkoYWxnb3JpdGhtLCBrZXksIHNpZ25hdHVyZSwgZGF0YSkgewogIGlmIChrZXkudHlwZSAhPT0gJ3B1YmxpYycpIHsKICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUygnTXVzdCBwYXNzIHB1YmxpYyBrZXkgZm9yIEVkMjU1MTkgdmVyaWZpY2F0aW9uJykKICB9CgogIHJldHVybiBjcnlwdG8udmVyaWZ5KG51bGwsIGRhdGEsIGtleS5faGFuZGxlLCBzaWduYXR1cmUpCn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2VkMjU1MTktb3BlcmF0aW9ucy1nZW5lcmF0ZS1rZXkKZXhwb3J0cy5nZW5lcmF0ZUtleSA9IGZ1bmN0aW9uIGdlbmVyYXRlS2V5KGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykgewogIGZvciAoY29uc3QgdXNhZ2Ugb2YgdXNhZ2VzKSB7CiAgICBpZiAodXNhZ2UgIT09ICdzaWduJyAmJiB1c2FnZSAhPT0gJ3ZlcmlmeScpIHsKICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKAogICAgICAgIGBVc2FnZSAnJHt1c2FnZX0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgRWQyNTUxOSBnZW5lcmF0ZUtleSgpIG9wZXJhdGlvbmAKICAgICAgKQogICAgfQogIH0KCiAgY29uc3Qga2V5cyA9IGNyeXB0by5nZW5lcmF0ZUtleVBhaXIoJ2VkMjU1MTknKQoKICBhbGdvcml0aG0gPSB7IG5hbWU6ICdFZDI1NTE5JyB9CgogIHJldHVybiB7CiAgICBwdWJsaWNLZXk6IG5ldyBDcnlwdG9LZXkoJ3B1YmxpYycsIHRydWUsIGFsZ29yaXRobSwgWyd2ZXJpZnknXSwga2V5cy5wdWJsaWNLZXkpLAogICAgcHJpdmF0ZUtleTogbmV3IENyeXB0b0tleSgncHJpdmF0ZScsIGV4dHJhY3RhYmxlLCBhbGdvcml0aG0sIFsnc2lnbiddLCBrZXlzLnByaXZhdGVLZXkpCiAgfQp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNlZDI1NTE5LW9wZXJhdGlvbnMtaW1wb3J0LWtleQpleHBvcnRzLmltcG9ydEtleSA9IGZ1bmN0aW9uIGltcG9ydEtleShmb3JtYXQsIGtleURhdGEsIGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykgewogIHN3aXRjaCAoZm9ybWF0KSB7CiAgICBjYXNlICdzcGtpJzoKICAgICAgZm9yIChjb25zdCB1c2FnZSBvZiB1c2FnZXMpIHsKICAgICAgICBpZiAodXNhZ2UgIT09ICd2ZXJpZnknKSB7CiAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoCiAgICAgICAgICAgIGBVc2FnZSAnJHt1c2FnZX0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgRWQyNTUxOSBpbXBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICAgICApCiAgICAgICAgfQogICAgICB9CgogICAgICBrZXlEYXRhID0gYmluZGluZy5lZDI1NTE5RnJvbVNQS0koa2V5RGF0YS5idWZmZXIsIGtleURhdGEuYnl0ZU9mZnNldCwga2V5RGF0YS5ieXRlTGVuZ3RoKQoKICAgICAgcmV0dXJuIG5ldyBDcnlwdG9LZXkoCiAgICAgICAgJ3B1YmxpYycsCiAgICAgICAgZXh0cmFjdGFibGUsCiAgICAgICAgewogICAgICAgICAgbmFtZTogJ0VkMjU1MTknCiAgICAgICAgfSwKICAgICAgICB1c2FnZXMsCiAgICAgICAgbmV3IEVkMjU1MTlQdWJsaWNLZXkoa2V5RGF0YSkKICAgICAgKQogICAgY2FzZSAncGtjczgnOgogICAgICBmb3IgKGNvbnN0IHVzYWdlIG9mIHVzYWdlcykgewogICAgICAgIGlmICh1c2FnZSAhPT0gJ3NpZ24nKSB7CiAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoCiAgICAgICAgICAgIGBVc2FnZSAnJHt1c2FnZX0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgRWQyNTUxOSBpbXBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICAgICApCiAgICAgICAgfQogICAgICB9CgogICAgICBrZXlEYXRhID0gYmluZGluZy5lZDI1NTE5RnJvbVBLQ1M4KGtleURhdGEuYnVmZmVyLCBrZXlEYXRhLmJ5dGVPZmZzZXQsIGtleURhdGEuYnl0ZUxlbmd0aCkKCiAgICAgIHJldHVybiBuZXcgQ3J5cHRvS2V5KAogICAgICAgICdwcml2YXRlJywKICAgICAgICBleHRyYWN0YWJsZSwKICAgICAgICB7CiAgICAgICAgICBuYW1lOiAnRWQyNTUxOScKICAgICAgICB9LAogICAgICAgIHVzYWdlcywKICAgICAgICBuZXcgRWQyNTUxOVByaXZhdGVLZXkoa2V5RGF0YSkKICAgICAgKQogICAgY2FzZSAncmF3JzoKICAgICAgZm9yIChjb25zdCB1c2FnZSBvZiB1c2FnZXMpIHsKICAgICAgICBpZiAodXNhZ2UgIT09ICd2ZXJpZnknKSB7CiAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoCiAgICAgICAgICAgIGBVc2FnZSAnJHt1c2FnZX0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgRWQyNTUxOSBpbXBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICAgICApCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoa2V5RGF0YS5ieXRlTGVuZ3RoICogOCAhPT0gMjU2KSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnS2V5IG11c3QgYmUgMjU2IGJpdHMnKQogICAgICB9CgogICAgICByZXR1cm4gbmV3IENyeXB0b0tleSgKICAgICAgICAncHVibGljJywKICAgICAgICBleHRyYWN0YWJsZSwKICAgICAgICB7CiAgICAgICAgICBuYW1lOiAnRWQyNTUxOScKICAgICAgICB9LAogICAgICAgIHVzYWdlcywKICAgICAgICBuZXcgRWQyNTUxOVB1YmxpY0tleShrZXlEYXRhLmJ1ZmZlcikKICAgICAgKQogICAgY2FzZSAnandrJzoKICAgICAgY29uc3QgandrID0ga2V5RGF0YQoKICAgICAgaWYgKCdkJyBpbiBqd2spIHsKICAgICAgICBpZiAodXNhZ2VzLnNvbWUoKHVzYWdlKSA9PiB1c2FnZSAhPT0gJ3NpZ24nKSkgewogICAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKCdKV0sgbXVzdCBiZSB2YWxpZCBmb3Igc2lnbmluZycpCiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmICh1c2FnZXMuc29tZSgodXNhZ2UpID0+IHVzYWdlICE9PSAndmVyaWZ5JykpIHsKICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcignSldLIG11c3QgYmUgdmFsaWQgZm9yIHZlcmlmaWNhdGlvbicpCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoandrLmt0eSAhPT0gJ09LUCcpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdKV0sga2V5IG11c3QgYmUgYW4gb2N0ZXQga2V5LXBhaXInKQogICAgICB9CgogICAgICBpZiAoandrLmNydiAhPT0gJ0VkMjU1MTknKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnSldLIG11c3QgdXNlIHRoZSBFZDI1NTE5IGN1cnZlJykKICAgICAgfQoKICAgICAgaWYgKCdhbGcnIGluIGp3ayAmJiBqd2suYWxnICE9PSAnRWQyNTUxOScgJiYgandrLmFsZyAhPT0gJ0VkRFNBJykgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0pXSyBtdXN0IHVzZSB0aGUgRWQyNTUxOSBjdXJ2ZScpCiAgICAgIH0KCiAgICAgIGlmICh1c2FnZXMubGVuZ3RoICYmICd1c2UnIGluIGp3ayAmJiBqd2sudXNlICE9PSAnc2lnJykgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0pXSyBjYW5ub3QgYmUgdXNlZCBmb3Igc2lnbmF0dXJlcycpCiAgICAgIH0KCiAgICAgIGlmICgnZXh0JyBpbiBqd2sgJiYgandrLmV4dCAhPT0gZXh0cmFjdGFibGUgJiYgZXh0cmFjdGFibGUpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdKV0sgaXMgbm90IGV4dHJhY3RhYmxlJykKICAgICAgfQoKICAgICAgaWYgKCdkJyBpbiBqd2spIHsKICAgICAgICBjb25zdCBrZXkgPSBCdWZmZXIuY29uY2F0KFsKICAgICAgICAgIEJ1ZmZlci5mcm9tKGp3ay5kLCAnYmFzZTY0dXJsJyksCiAgICAgICAgICBCdWZmZXIuZnJvbShqd2sueCwgJ2Jhc2U2NHVybCcpCiAgICAgICAgXSkKCiAgICAgICAgaWYgKGtleS5ieXRlTGVuZ3RoICogOCAhPT0gNTEyKSB7CiAgICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdLZXkgbXVzdCBiZSA1MTIgYml0cycpCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbmV3IENyeXB0b0tleSgKICAgICAgICAgICdwcml2YXRlJywKICAgICAgICAgIGV4dHJhY3RhYmxlLAogICAgICAgICAgewogICAgICAgICAgICBuYW1lOiAnRWQyNTUxOScKICAgICAgICAgIH0sCiAgICAgICAgICB1c2FnZXMsCiAgICAgICAgICBuZXcgRWQyNTUxOVByaXZhdGVLZXkoa2V5LmJ1ZmZlcikKICAgICAgICApCiAgICAgIH0KCiAgICAgIGNvbnN0IGtleSA9IEJ1ZmZlci5mcm9tKGp3ay54LCAnYmFzZTY0dXJsJykKCiAgICAgIGlmIChrZXkuYnl0ZUxlbmd0aCAqIDggIT09IDI1NikgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0tleSBtdXN0IGJlIDI1NiBiaXRzJykKICAgICAgfQoKICAgICAgcmV0dXJuIG5ldyBDcnlwdG9LZXkoCiAgICAgICAgJ3B1YmxpYycsCiAgICAgICAgZXh0cmFjdGFibGUsCiAgICAgICAgewogICAgICAgICAgbmFtZTogJ0VkMjU1MTknCiAgICAgICAgfSwKICAgICAgICB1c2FnZXMsCiAgICAgICAgbmV3IEVkMjU1MTlQdWJsaWNLZXkoa2V5LmJ1ZmZlcikKICAgICAgKQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgYEZvcm1hdCAnJHtmb3JtYXR9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEVkMjU1MTkgaW1wb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICApCiAgfQp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNlZDI1NTE5LW9wZXJhdGlvbnMtZXhwb3J0LWtleQpleHBvcnRzLmV4cG9ydEtleSA9IGZ1bmN0aW9uIGV4cG9ydEtleShmb3JtYXQsIGtleSkgewogIGNvbnN0IGRhdGEgPSBrZXkuX2hhbmRsZQoKICBzd2l0Y2ggKGZvcm1hdCkgewogICAgY2FzZSAnc3BraSc6CiAgICAgIGlmIChrZXkudHlwZSAhPT0gJ3B1YmxpYycpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoCiAgICAgICAgICBgS2V5IG9mIHR5cGUgJyR7a2V5LnR5cGV9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEVkMjU1MTkgZXhwb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgICAgfQoKICAgICAgcmV0dXJuIGJpbmRpbmcuZWQyNTUxOVRvU1BLSShkYXRhLl9rZXkpCiAgICBjYXNlICdwa2NzOCc6CiAgICAgIGlmIChrZXkudHlwZSAhPT0gJ3ByaXZhdGUnKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKAogICAgICAgICAgYEtleSBvZiB0eXBlICcke2tleS50eXBlfScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBFZDI1NTE5IGV4cG9ydEtleSgpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICAgIH0KCiAgICAgIHJldHVybiBiaW5kaW5nLmVkMjU1MTlUb1BLQ1M4KGRhdGEuX2tleSkKICAgIGNhc2UgJ3Jhdyc6IHsKICAgICAgaWYgKGtleS50eXBlICE9PSAncHVibGljJykgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUygKICAgICAgICAgIGBLZXkgb2YgdHlwZSAnJHtrZXkudHlwZX0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgRWQyNTUxOSBleHBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgICB9CgogICAgICByZXR1cm4gZGF0YS5fa2V5LnNsaWNlKCkKICAgIH0KICAgIGNhc2UgJ2p3ayc6IHsKICAgICAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmZyb20oZGF0YS5fa2V5KQoKICAgICAgaWYgKGtleS50eXBlID09PSAncHJpdmF0ZScpIHsKICAgICAgICBjb25zdCBkID0gYnVmZmVyLnN1YmFycmF5KDAsIDMyKS50b1N0cmluZygnYmFzZTY0dXJsJykKICAgICAgICBjb25zdCB4ID0gYnVmZmVyLnN1YmFycmF5KDMyKS50b1N0cmluZygnYmFzZTY0dXJsJykKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGt0eTogJ09LUCcsCiAgICAgICAgICBhbGc6ICdFZDI1NTE5JywKICAgICAgICAgIGNydjogJ0VkMjU1MTknLAogICAgICAgICAgeCwKICAgICAgICAgIGQsCiAgICAgICAgICBrZXlfb3BzOiBrZXkudXNhZ2VzLAogICAgICAgICAgZXh0OiBrZXkuZXh0cmFjdGFibGUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAga3R5OiAnT0tQJywKICAgICAgICBhbGc6ICdFZDI1NTE5JywKICAgICAgICBjcnY6ICdFZDI1NTE5JywKICAgICAgICB4OiBidWZmZXIudG9TdHJpbmcoJ2Jhc2U2NHVybCcpLAogICAgICAgIGtleV9vcHM6IGtleS51c2FnZXMsCiAgICAgICAgZXh0OiBrZXkuZXh0cmFjdGFibGUKICAgICAgfQogICAgfQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgYEZvcm1hdCAnJHtmb3JtYXR9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEhNQUMgZXhwb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICApCiAgfQp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJy4uLy4uLy4uJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi4vLi4vZXJyb3JzJykKY29uc3QgQ3J5cHRvS2V5ID0gcmVxdWlyZSgnLi4vY3J5cHRvLWtleScpCgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNobWFjCgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNobWFjLW9wZXJhdGlvbnMtc2lnbgpleHBvcnRzLnNpZ24gPSBmdW5jdGlvbiBzaWduKGFsZ29yaXRobSwga2V5LCBkYXRhKSB7CiAgY29uc3QgZGlnZXN0ID0gY3J5cHRvLmNyZWF0ZUhtYWMoa2V5LmFsZ29yaXRobS5oYXNoLm5hbWUsIGtleS5faGFuZGxlKS51cGRhdGUoZGF0YSkuZGlnZXN0KCkKCiAgcmV0dXJuIGRpZ2VzdC5idWZmZXIuc2xpY2UoMCwgZGlnZXN0LmJ5dGVMZW5ndGgpCn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2htYWMtb3BlcmF0aW9ucy12ZXJpZnkKZXhwb3J0cy52ZXJpZnkgPSBmdW5jdGlvbiB2ZXJpZnkoYWxnb3JpdGhtLCBrZXksIHNpZ25hdHVyZSwgZGF0YSkgewogIGNvbnN0IGRpZ2VzdCA9IGNyeXB0by5jcmVhdGVIbWFjKGtleS5hbGdvcml0aG0uaGFzaC5uYW1lLCBrZXkuX2hhbmRsZSkudXBkYXRlKGRhdGEpLmRpZ2VzdCgpCgogIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoc2lnbmF0dXJlKSkgewogICAgc2lnbmF0dXJlID0gQnVmZmVyLmNvZXJjZShzaWduYXR1cmUpCiAgfSBlbHNlIHsKICAgIHNpZ25hdHVyZSA9IEJ1ZmZlci5mcm9tKHNpZ25hdHVyZSkKICB9CgogIHJldHVybiBzaWduYXR1cmUuZXF1YWxzKGRpZ2VzdCkKfQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jaG1hYy1vcGVyYXRpb25zLWdlbmVyYXRlLWtleQpleHBvcnRzLmdlbmVyYXRlS2V5ID0gZnVuY3Rpb24gZ2VuZXJhdGVLZXkoYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKSB7CiAgZm9yIChjb25zdCB1c2FnZSBvZiB1c2FnZXMpIHsKICAgIGlmICh1c2FnZSAhPT0gJ3NpZ24nICYmIHVzYWdlICE9PSAndmVyaWZ5JykgewogICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYFVzYWdlICcke3VzYWdlfScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBITUFDIGdlbmVyYXRlS2V5KCkgb3BlcmF0aW9uYCkKICAgIH0KICB9CgogIGNvbnN0IHsgbGVuZ3RoID0gZXhwb3J0cy5nZXRLZXlMZW5ndGgoYWxnb3JpdGhtKSB9ID0gYWxnb3JpdGhtLmxlbmd0aAoKICBsZXQgaGFzaCA9IGFsZ29yaXRobS5oYXNoCgogIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3N0cmluZycpIGhhc2ggPSB7IG5hbWU6IGhhc2ggfQoKICBjb25zdCBrZXkgPSBjcnlwdG8uY3JlYXRlSG1hYyhoYXNoLm5hbWUsIGNyeXB0by5yYW5kb21CeXRlcyhsZW5ndGgpKS5kaWdlc3QoKQoKICByZXR1cm4gbmV3IENyeXB0b0tleSgKICAgICdzZWNyZXQnLAogICAgZXh0cmFjdGFibGUsCiAgICB7CiAgICAgIG5hbWU6ICdITUFDJywKICAgICAgbGVuZ3RoLAogICAgICBoYXNoOiB7CiAgICAgICAgbmFtZTogaGFzaC5uYW1lLnRvVXBwZXJDYXNlKCkKICAgICAgfQogICAgfSwKICAgIHVzYWdlcywKICAgIGtleQogICkKfQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jaG1hYy1vcGVyYXRpb25zLWltcG9ydC1rZXkKZXhwb3J0cy5pbXBvcnRLZXkgPSBmdW5jdGlvbiBpbXBvcnRLZXkoZm9ybWF0LCBrZXlEYXRhLCBhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpIHsKICBmb3IgKGNvbnN0IHVzYWdlIG9mIHVzYWdlcykgewogICAgaWYgKHVzYWdlICE9PSAnc2lnbicgJiYgdXNhZ2UgIT09ICd2ZXJpZnknKSB7CiAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihgSW52YWxpZCB1c2FnZSAke3VzYWdlfWApCiAgICB9CiAgfQoKICBsZXQgaGFzaCA9IGFsZ29yaXRobS5oYXNoCgogIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3N0cmluZycpIGhhc2ggPSB7IG5hbWU6IGhhc2ggfQoKICBsZXQgZGF0YQoKICBzd2l0Y2ggKGZvcm1hdCkgewogICAgY2FzZSAncmF3JzoKICAgICAgZGF0YSA9IGtleURhdGEKICAgICAgYnJlYWsKICAgIGNhc2UgJ2p3ayc6CiAgICAgIGNvbnN0IGp3ayA9IGtleURhdGEKCiAgICAgIGlmIChqd2sua3R5ICE9PSAnb2N0JykgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0pXSyBrZXkgbXVzdCBiZSBhbiBvY3RldCBzZXF1ZW5jZScpCiAgICAgIH0KCiAgICAgIGRhdGEgPSBCdWZmZXIuZnJvbShqd2suaywgJ2Jhc2U2NHVybCcpCgogICAgICBzd2l0Y2ggKGhhc2gubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgY2FzZSAnc2hhLTEnOgogICAgICAgICAgaWYgKGp3ay5hbGcgPT09ICdIUzEnKSBicmVhawogICAgICAgICAgZWxzZSB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdJbnZhbGlkIEpXSyBrZXkgYWxnb3JpdGhtJykKICAgICAgICBjYXNlICdzaGEtMjU2JzoKICAgICAgICAgIGlmIChqd2suYWxnID09PSAnSFMyNTYnKSBicmVhawogICAgICAgICAgZWxzZSB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdJbnZhbGlkIEpXSyBrZXkgYWxnb3JpdGhtJykKICAgICAgICBjYXNlICdzaGEtMzg0JzoKICAgICAgICAgIGlmIChqd2suYWxnID09PSAnSFMzODQnKSBicmVhawogICAgICAgICAgZWxzZSB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdJbnZhbGlkIEpXSyBrZXkgYWxnb3JpdGhtJykKICAgICAgICBjYXNlICdzaGEtNTEyJzoKICAgICAgICAgIGlmIChqd2suYWxnID09PSAnSFM1MTInKSBicmVhawogICAgICAgICAgZWxzZSB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdJbnZhbGlkIEpXSyBrZXkgYWxnb3JpdGhtJykKICAgICAgfQoKICAgICAgaWYgKHVzYWdlcy5sZW5ndGggJiYgJ3VzZScgaW4gandrICYmIGp3ay51c2UgIT09ICdzaWduJykgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0pXSyBjYW5ub3QgYmUgdXNlZCBmb3Igc2lnbmluZycpCiAgICAgIH0KCiAgICAgIGlmICgnZXh0JyBpbiBqd2sgJiYgandrLmV4dCAhPT0gZXh0cmFjdGFibGUgJiYgZXh0cmFjdGFibGUpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdKV0sgaXMgbm90IGV4dHJhY3RhYmxlJykKICAgICAgfQogICAgICBicmVhawogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgYEZvcm1hdCAnJHtmb3JtYXR9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEhNQUMgaW1wb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICApCiAgfQoKICBjb25zdCBsZW5ndGggPSBkYXRhLmJ5dGVMZW5ndGggKiA4CgogIGlmIChsZW5ndGggPT09IDApIHsKICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0tleSBjYW5ub3QgYmUgZW1wdHknKQogIH0KCiAgcmV0dXJuIG5ldyBDcnlwdG9LZXkoCiAgICAnc2VjcmV0JywKICAgIGV4dHJhY3RhYmxlLAogICAgewogICAgICBuYW1lOiAnSE1BQycsCiAgICAgIGxlbmd0aCwKICAgICAgaGFzaDogewogICAgICAgIG5hbWU6IGhhc2gubmFtZS50b1VwcGVyQ2FzZSgpCiAgICAgIH0KICAgIH0sCiAgICB1c2FnZXMsCiAgICBkYXRhCiAgKQp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNobWFjLW9wZXJhdGlvbnMtZXhwb3J0LWtleQpleHBvcnRzLmV4cG9ydEtleSA9IGZ1bmN0aW9uIGV4cG9ydEtleShmb3JtYXQsIGtleSkgewogIGNvbnN0IGRhdGEgPSBrZXkuX2hhbmRsZQoKICBzd2l0Y2ggKGZvcm1hdCkgewogICAgY2FzZSAncmF3JzoKICAgICAgcmV0dXJuIGRhdGEuYnVmZmVyLnNsaWNlKDAsIGRhdGEuYnl0ZUxlbmd0aCkKICAgIGNhc2UgJ2p3ayc6IHsKICAgICAgY29uc3QgandrID0gewogICAgICAgIGt0eTogJ29jdCcsCiAgICAgICAgazogZGF0YS50b1N0cmluZygnYmFzZTY0dXJsJyksCiAgICAgICAgYWxnOiBudWxsLAogICAgICAgIGtleV9vcHM6IGtleS51c2FnZXMsCiAgICAgICAgZXh0OiBrZXkuZXh0cmFjdGFibGUKICAgICAgfQoKICAgICAgc3dpdGNoIChrZXkuYWxnb3JpdGhtLmhhc2gubmFtZSkgewogICAgICAgIGNhc2UgJ1NIQS0xJzoKICAgICAgICAgIGp3ay5hbGcgPSAnSFMxJwogICAgICAgICAgYnJlYWsKICAgICAgICBjYXNlICdTSEEtMjU2JzoKICAgICAgICAgIGp3ay5hbGcgPSAnSFMyNTYnCiAgICAgICAgICBicmVhawogICAgICAgIGNhc2UgJ1NIQS0zODQnOgogICAgICAgICAgandrLmFsZyA9ICdIUzM4NCcKICAgICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAnU0hBLTUxMic6CiAgICAgICAgICBqd2suYWxnID0gJ0hTNTEyJwogICAgICAgICAgYnJlYWsKICAgICAgfQoKICAgICAgcmV0dXJuIGp3awogICAgfQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgYEZvcm1hdCAnJHtmb3JtYXR9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEhNQUMgZXhwb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICApCiAgfQp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNobWFjLW9wZXJhdGlvbnMtZ2V0LWtleS1sZW5ndGgKZXhwb3J0cy5nZXRLZXlMZW5ndGggPSBmdW5jdGlvbiBnZXRLZXlMZW5ndGgoYWxnb3JpdGhtKSB7CiAgY29uc3QgeyBsZW5ndGgsIGhhc2ggfSA9IGFsZ29yaXRobQoKICBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQpIHsKICAgIGlmIChoYXNoID09PSAnU0hBLTEnIHx8IGhhc2ggPT09ICdTSEEtMjU2JykgcmV0dXJuIDUxMgogICAgaWYgKGhhc2ggPT09ICdTSEEtNTEyJykgcmV0dXJuIDEwMjQKCiAgICB0aHJvdyBlcnJvcnMuT1BFUkFUSU9OX0VSUk9SKGBJbnZhbGlkIGhhc2ggJyR7aGFzaH0nYCkKICB9CgogIGlmIChsZW5ndGggPT09IDApIHsKICAgIHRocm93IGVycm9ycy5PUEVSQVRJT05fRVJST1IoYEludmFsaWQgbGVuZ3RoICR7bGVuZ3RofWApCiAgfQoKICByZXR1cm4gbGVuZ3RoCn0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnLi4vLi4vLi4nKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuLi8uLi9lcnJvcnMnKQpjb25zdCBDcnlwdG9LZXkgPSByZXF1aXJlKCcuLi9jcnlwdG8ta2V5JykKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI3Bia2RmMgoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jcGJrZGYyLW9wZXJhdGlvbnMtZGVyaXZlLWJpdHMKZXhwb3J0cy5kZXJpdmVCaXRzID0gZnVuY3Rpb24gZGVyaXZlQml0cyhhbGdvcml0aG0sIGtleSwgbGVuZ3RoKSB7CiAgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkIHx8IGxlbmd0aCAlIDgpIHsKICAgIHRocm93IGVycm9ycy5PUEVSQVRJT05fRVJST1IoJ0xlbmd0aCBtdXN0IGJlIG11bHRpcGxlIG9mIDgnKQogIH0KCiAgaWYgKGFsZ29yaXRobS5pdGVyYXRpb25zID09PSAwKSB7CiAgICB0aHJvdyBlcnJvcnMuT1BFUkFUSU9OX0VSUk9SKCdJdGVyYXRpb25zIG11c3QgYmUgbm9uLTAnKQogIH0KCiAgaWYgKGxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIG5ldyBBcnJheUJ1ZmZlcigwKQogIH0KCiAgbGV0IGhhc2ggPSBhbGdvcml0aG0uaGFzaAoKICBpZiAodHlwZW9mIGhhc2ggPT09ICdzdHJpbmcnKSBoYXNoID0geyBuYW1lOiBoYXNoIH0KCiAgY29uc3QgcmVzdWx0ID0gY3J5cHRvLnBia2RmMigKICAgIGtleS5faGFuZGxlLAogICAgYWxnb3JpdGhtLnNhbHQsCiAgICBhbGdvcml0aG0uaXRlcmF0aW9ucywKICAgIGxlbmd0aCAvIDgsCiAgICBoYXNoLm5hbWUKICApCgogIHJldHVybiByZXN1bHQuYnVmZmVyCn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI3Bia2RmMi1vcGVyYXRpb25zLWltcG9ydC1rZXkKZXhwb3J0cy5pbXBvcnRLZXkgPSBmdW5jdGlvbiBpbXBvcnRLZXkoZm9ybWF0LCBrZXlEYXRhLCBhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpIHsKICBpZiAoZm9ybWF0ICE9PSAncmF3JykgewogICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgIGBGb3JtYXQgJyR7Zm9ybWF0fScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBQQktERjIgaW1wb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgKQogIH0KCiAgZm9yIChjb25zdCB1c2FnZSBvZiB1c2FnZXMpIHsKICAgIGlmICh1c2FnZSAhPT0gJ2Rlcml2ZUtleScgJiYgdXNhZ2UgIT09ICdkZXJpdmVCaXRzJykgewogICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYEludmFsaWQgdXNhZ2UgJHt1c2FnZX1gKQogICAgfQogIH0KCiAgaWYgKGV4dHJhY3RhYmxlKSB7CiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoJ0V4dHJhY3RhYmxlIG11c3QgYmUgZmFsc2UnKQogIH0KCiAgcmV0dXJuIG5ldyBDcnlwdG9LZXkoCiAgICAnc2VjcmV0JywKICAgIGV4dHJhY3RhYmxlLAogICAgewogICAgICBuYW1lOiAnUEJLREYyJwogICAgfSwKICAgIHVzYWdlcywKICAgIGtleURhdGEKICApCn0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnLi4vLi4vLi4nKQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jc2hhCgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNzaGEtb3BlcmF0aW9ucy1kaWdlc3QKZXhwb3J0cy5kaWdlc3QgPSBmdW5jdGlvbiBkaWdlc3QobmFtZSwgZGF0YSkgewogIGNvbnN0IGRpZ2VzdCA9IGNyeXB0by5jcmVhdGVIYXNoKG5hbWUpLnVwZGF0ZShkYXRhKS5kaWdlc3QoKQoKICByZXR1cm4gZGlnZXN0LmJ1ZmZlci5zbGljZSgwLCBkaWdlc3QuYnl0ZUxlbmd0aCkKfQovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNjcnlwdG9rZXktaW50ZXJmYWNlCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ3J5cHRvS2V5IHsKICBjb25zdHJ1Y3Rvcih0eXBlLCBleHRyYWN0YWJsZSwgYWxnb3JpdGhtLCB1c2FnZXMsIGhhbmRsZSA9IG51bGwpIHsKICAgIHRoaXMuX3R5cGUgPSB0eXBlCiAgICB0aGlzLl9leHRyYWN0YWJsZSA9IGV4dHJhY3RhYmxlCiAgICB0aGlzLl9hbGdvcml0aG0gPSBhbGdvcml0aG0KICAgIHRoaXMuX3VzYWdlcyA9IHVzYWdlcwogICAgdGhpcy5faGFuZGxlID0gaGFuZGxlCiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNkb20tY3J5cHRva2V5LXR5cGUKICBnZXQgdHlwZSgpIHsKICAgIHJldHVybiB0aGlzLl90eXBlCiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNkb20tY3J5cHRva2V5LWV4dHJhY3RhYmxlCiAgZ2V0IGV4dHJhY3RhYmxlKCkgewogICAgcmV0dXJuIHRoaXMuX2V4dHJhY3RhYmxlCiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNkb20tY3J5cHRva2V5LWFsZ29yaXRobQogIGdldCBhbGdvcml0aG0oKSB7CiAgICByZXR1cm4gdGhpcy5fYWxnb3JpdGhtCiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNkb20tY3J5cHRva2V5LXVzYWdlcwogIGdldCB1c2FnZXMoKSB7CiAgICByZXR1cm4gdGhpcy5fdXNhZ2VzCiAgfQoKICBbU3ltYm9sLmZvcignYmFyZS5pbnNwZWN0JyldKCkgewogICAgcmV0dXJuIHsKICAgICAgX19wcm90b19fOiB7IGNvbnN0cnVjdG9yOiBDcnlwdG9LZXkgfSwKCiAgICAgIHR5cGU6IHRoaXMudHlwZSwKICAgICAgZXh0cmFjdGFibGU6IHRoaXMuZXh0cmFjdGFibGUsCiAgICAgIGFsZ29yaXRobTogdGhpcy5hbGdvcml0aG0sCiAgICAgIHVzYWdlczogdGhpcy51c2FnZXMKICAgIH0KICB9Cn0KewogICJuYW1lIjogImJhcmUtY3J5cHRvIiwKICAidmVyc2lvbiI6ICIxLjEyLjAiLAogICJkZXNjcmlwdGlvbiI6ICJDcnlwdG9ncmFwaGljIHByaW1pdGl2ZXMgZm9yIEphdmFTY3JpcHQiLAogICJleHBvcnRzIjogewogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLiI6IHsKICAgICAgInR5cGVzIjogIi4vaW5kZXguZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vaW5kZXguanMiCiAgICB9LAogICAgIi4vd2ViIjogewogICAgICAidHlwZXMiOiAiLi93ZWIuZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vd2ViLmpzIgogICAgfSwKICAgICIuL2dsb2JhbCI6IHsKICAgICAgInR5cGVzIjogIi4vZ2xvYmFsLmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2dsb2JhbC5qcyIKICAgIH0sCiAgICAiLi9jb25zdGFudHMiOiAiLi9saWIvY29uc3RhbnRzLmpzIiwKICAgICIuL2Vycm9ycyI6ICIuL2xpYi9lcnJvcnMuanMiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImluZGV4LmQudHMiLAogICAgIndlYi5qcyIsCiAgICAid2ViLmQudHMiLAogICAgImdsb2JhbC5qcyIsCiAgICAiZ2xvYmFsLmQudHMiLAogICAgImJpbmRpbmcuYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiLAogICAgImxpYiIsCiAgICAicHJlYnVpbGRzIgogIF0sCiAgImFkZG9uIjogdHJ1ZSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBiYXJlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1jcnlwdG8uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1jcnlwdG8vaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLWNyeXB0byNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1zdHJlYW0iOiAiXjIuNi4zIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWJ1ZmZlciI6ICJeMy4wLjEiLAogICAgImJyaXR0bGUiOiAiXjMuNS4wIiwKICAgICJjbWFrZS1iYXJlIjogIl4xLjEuNiIsCiAgICAiY21ha2UtZmV0Y2giOiAiXjEuMC4wIiwKICAgICJwcmV0dGllciI6ICJeMy40LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1idWZmZXIiOiAiKiIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzTWV0YSI6IHsKICAgICJiYXJlLWJ1ZmZlciI6IHsKICAgICAgIm9wdGlvbmFsIjogdHJ1ZQogICAgfQogIH0KfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCcuJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi9saWIvZXJyb3JzJykKY29uc3QgQ3J5cHRvS2V5ID0gcmVxdWlyZSgnLi9saWIvd2ViL2NyeXB0by1rZXknKQpjb25zdCBobWFjID0gcmVxdWlyZSgnLi9saWIvd2ViL2FsZ29yaXRobS9obWFjJykKY29uc3QgcGJrZGYyID0gcmVxdWlyZSgnLi9saWIvd2ViL2FsZ29yaXRobS9wYmtkZjInKQpjb25zdCBlZDI1NTE5ID0gcmVxdWlyZSgnLi9saWIvd2ViL2FsZ29yaXRobS9lZDI1NTE5JykKY29uc3Qgc2hhID0gcmVxdWlyZSgnLi9saWIvd2ViL2FsZ29yaXRobS9zaGEnKQoKZXhwb3J0cy5DcnlwdG9LZXkgPSBDcnlwdG9LZXkKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI0NyeXB0by1tZXRob2QtZ2V0UmFuZG9tVmFsdWVzCmV4cG9ydHMuZ2V0UmFuZG9tVmFsdWVzID0gZnVuY3Rpb24gZ2V0UmFuZG9tVmFsdWVzKGFycmF5KSB7CiAgcmV0dXJuIGNyeXB0by5yYW5kb21GaWxsU3luYyhhcnJheSkKfQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jZGZuLUNyeXB0by1tZXRob2QtcmFuZG9tVVVJRApleHBvcnRzLnJhbmRvbVVVSUQgPSBjcnlwdG8ucmFuZG9tVVVJRAoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jc3VidGxlY3J5cHRvLWludGVyZmFjZQpleHBvcnRzLlN1YnRsZUNyeXB0byA9IGNsYXNzIFN1YnRsZUNyeXB0byB7CiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jU3VidGxlQ3J5cHRvLW1ldGhvZC1nZW5lcmF0ZUtleQogIGFzeW5jIGdlbmVyYXRlS2V5KGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykgewogICAgaWYgKHR5cGVvZiBhbGdvcml0aG0gPT09ICdzdHJpbmcnKSBhbGdvcml0aG0gPSB7IG5hbWU6IGFsZ29yaXRobSB9CgogICAgc3dpdGNoIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIGNhc2UgJ2htYWMnOgogICAgICAgIHJldHVybiBobWFjLmdlbmVyYXRlS2V5KGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykKICAgICAgY2FzZSAnZWQyNTUxOSc6CiAgICAgICAgcmV0dXJuIGVkMjU1MTkuZ2VuZXJhdGVLZXkoYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgICAgYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IHN1cHBvcnQgdGhlIGdlbmVyYXRlS2V5KCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgIH0KICB9CgogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI1N1YnRsZUNyeXB0by1tZXRob2QtaW1wb3J0S2V5CiAgYXN5bmMgaW1wb3J0S2V5KGZvcm1hdCwga2V5RGF0YSwgYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKSB7CiAgICBpZiAodHlwZW9mIGFsZ29yaXRobSA9PT0gJ3N0cmluZycpIGFsZ29yaXRobSA9IHsgbmFtZTogYWxnb3JpdGhtIH0KCiAgICBzd2l0Y2ggKGZvcm1hdCkgewogICAgICBjYXNlICdyYXcnOgogICAgICBjYXNlICdwa2NzOCc6CiAgICAgIGNhc2UgJ3Nwa2knOgogICAgICAgIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoa2V5RGF0YSkpIHsKICAgICAgICAgIGtleURhdGEgPSBCdWZmZXIuZnJvbShrZXlEYXRhKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBrZXlEYXRhID0gQnVmZmVyLmZyb20oa2V5RGF0YS5zbGljZSgpKQogICAgICAgIH0KICAgICAgICBicmVhawogICAgfQoKICAgIHN3aXRjaCAoYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdobWFjJzoKICAgICAgICByZXR1cm4gaG1hYy5pbXBvcnRLZXkoZm9ybWF0LCBrZXlEYXRhLCBhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpCiAgICAgIGNhc2UgJ2VkMjU1MTknOgogICAgICAgIHJldHVybiBlZDI1NTE5LmltcG9ydEtleShmb3JtYXQsIGtleURhdGEsIGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykKICAgICAgY2FzZSAncGJrZGYyJzoKICAgICAgICByZXR1cm4gcGJrZGYyLmltcG9ydEtleShmb3JtYXQsIGtleURhdGEsIGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICAgIGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBzdXBwb3J0IHRoZSBpbXBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgfQogIH0KCiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jU3VidGxlQ3J5cHRvLW1ldGhvZC1leHBvcnRLZXkKICBhc3luYyBleHBvcnRLZXkoZm9ybWF0LCBrZXkpIHsKICAgIGlmICgha2V5LmV4dHJhY3RhYmxlKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUygnS2V5IGlzIG5vdCBleHRyYWN0YWJsZScpCiAgICB9CgogICAgc3dpdGNoIChrZXkuYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdobWFjJzoKICAgICAgICByZXR1cm4gaG1hYy5leHBvcnRLZXkoZm9ybWF0LCBrZXkpCiAgICAgIGNhc2UgJ2VkMjU1MTknOgogICAgICAgIHJldHVybiBlZDI1NTE5LmV4cG9ydEtleShmb3JtYXQsIGtleSkKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICAgIGBBbGdvcml0aG0gJyR7a2V5LmFsZ29yaXRobS5uYW1lfScgZG9lcyBub3Qgc3VwcG9ydCB0aGUgZXhwb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgIH0KICB9CgogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI1N1YnRsZUNyeXB0by1tZXRob2Qtc2lnbgogIGFzeW5jIHNpZ24oYWxnb3JpdGhtLCBrZXksIGRhdGEpIHsKICAgIGlmICh0eXBlb2YgYWxnb3JpdGhtID09PSAnc3RyaW5nJykgYWxnb3JpdGhtID0geyBuYW1lOiBhbGdvcml0aG0gfQoKICAgIGlmIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpICE9PSBrZXkuYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IG1hdGNoIGtleSdgKQogICAgfQoKICAgIGlmICgha2V5LnVzYWdlcy5pbmNsdWRlcygnc2lnbicpKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUygnS2V5IGNhbm5vdCBiZSB1c2VkIGZvciBzaWduaW5nJykKICAgIH0KCiAgICBzd2l0Y2ggKGFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAnaG1hYyc6CiAgICAgICAgcmV0dXJuIGhtYWMuc2lnbihhbGdvcml0aG0sIGtleSwgZGF0YSkKICAgICAgY2FzZSAnZWQyNTUxOSc6CiAgICAgICAgcmV0dXJuIGVkMjU1MTkuc2lnbihhbGdvcml0aG0sIGtleSwgZGF0YSkKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICAgIGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBzdXBwb3J0IHRoZSBzaWduKCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgIH0KICB9CgogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI1N1YnRsZUNyeXB0by1tZXRob2QtdmVyaWZ5CiAgYXN5bmMgdmVyaWZ5KGFsZ29yaXRobSwga2V5LCBzaWduYXR1cmUsIGRhdGEpIHsKICAgIGlmICh0eXBlb2YgYWxnb3JpdGhtID09PSAnc3RyaW5nJykgYWxnb3JpdGhtID0geyBuYW1lOiBhbGdvcml0aG0gfQoKICAgIGlmIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpICE9PSBrZXkuYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IG1hdGNoIGtleSdgKQogICAgfQoKICAgIGlmICgha2V5LnVzYWdlcy5pbmNsdWRlcygndmVyaWZ5JykpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKCdLZXkgY2Fubm90IGJlIHVzZWQgZm9yIHZlcmlmaWNhdGlvbicpCiAgICB9CgogICAgc3dpdGNoIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIGNhc2UgJ2htYWMnOgogICAgICAgIHJldHVybiBobWFjLnZlcmlmeShhbGdvcml0aG0sIGtleSwgc2lnbmF0dXJlLCBkYXRhKQogICAgICBjYXNlICdlZDI1NTE5JzoKICAgICAgICByZXR1cm4gZWQyNTUxOS52ZXJpZnkoYWxnb3JpdGhtLCBrZXksIHNpZ25hdHVyZSwgZGF0YSkKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICAgIGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBzdXBwb3J0IHRoZSB2ZXJpZnkoKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgfQogIH0KCiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jU3VidGxlQ3J5cHRvLW1ldGhvZC1kZXJpdmVCaXRzCiAgYXN5bmMgZGVyaXZlQml0cyhhbGdvcml0aG0sIGtleSwgbGVuZ3RoKSB7CiAgICBpZiAodHlwZW9mIGFsZ29yaXRobSA9PT0gJ3N0cmluZycpIGFsZ29yaXRobSA9IHsgbmFtZTogYWxnb3JpdGhtIH0KCiAgICBpZiAoYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSAhPT0ga2V5LmFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBtYXRjaCBrZXknYCkKICAgIH0KCiAgICBpZiAoIWtleS51c2FnZXMuaW5jbHVkZXMoJ2Rlcml2ZUJpdHMnKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoJ0tleSBjYW5ub3QgYmUgdXNlZCB0byBkZXJpdmUgYml0cycpCiAgICB9CgogICAgc3dpdGNoIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIGNhc2UgJ3Bia2RmMic6CiAgICAgICAgcmV0dXJuIHBia2RmMi5kZXJpdmVCaXRzKGFsZ29yaXRobSwga2V5LCBsZW5ndGgpCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgICBgQWxnb3JpdGhtICcke2FsZ29yaXRobS5uYW1lfScgZG9lcyBub3Qgc3VwcG9ydCB0aGUgZGVyaXZlQml0cygpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICB9CiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNTdWJ0bGVDcnlwdG8tbWV0aG9kLWRlcml2ZUtleQogIGFzeW5jIGRlcml2ZUtleShhbGdvcml0aG0sIGJhc2VLZXksIGRlcml2ZWRLZXlUeXBlLCBleHRyYWN0YWJsZSwgdXNhZ2VzKSB7CiAgICBpZiAodHlwZW9mIGFsZ29yaXRobSA9PT0gJ3N0cmluZycpIGFsZ29yaXRobSA9IHsgbmFtZTogYWxnb3JpdGhtIH0KCiAgICBpZiAodHlwZW9mIGRlcml2ZWRLZXlUeXBlID09PSAnc3RyaW5nJykgewogICAgICBkZXJpdmVkS2V5VHlwZSA9IHsgbmFtZTogZGVyaXZlZEtleVR5cGUgfQogICAgfQoKICAgIGlmIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpICE9PSBiYXNlS2V5LmFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBtYXRjaCBrZXknYCkKICAgIH0KCiAgICBpZiAoIWJhc2VLZXkudXNhZ2VzLmluY2x1ZGVzKCdkZXJpdmVLZXknKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoJ0tleSBjYW5ub3QgYmUgdXNlZCB0byBkZXJpdmUga2V5JykKICAgIH0KCiAgICBsZXQgbGVuZ3RoCgogICAgc3dpdGNoIChkZXJpdmVkS2V5VHlwZS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAnaG1hYyc6CiAgICAgICAgbGVuZ3RoID0gaG1hYy5nZXRLZXlMZW5ndGgoZGVyaXZlZEtleVR5cGUpCiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICAgIGBBbGdvcml0aG0gJyR7ZGVyaXZlZEtleVR5cGUubmFtZX0nIGRvZXMgbm90IHN1cHBvcnQgdGhlIGdldEtleUxlbmd0aCgpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICB9CgogICAgbGV0IHNlY3JldAoKICAgIHN3aXRjaCAoYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdwYmtkZjInOgogICAgICAgIHNlY3JldCA9IHBia2RmMi5kZXJpdmVCaXRzKGFsZ29yaXRobSwgYmFzZUtleSwgbGVuZ3RoKQogICAgICAgIGJyZWFrCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgICBgQWxnb3JpdGhtICcke2FsZ29yaXRobS5uYW1lfScgZG9lcyBub3Qgc3VwcG9ydCB0aGUgZGVyaXZlQml0cygpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICB9CgogICAgcmV0dXJuIHRoaXMuaW1wb3J0S2V5KCdyYXcnLCBzZWNyZXQsIGRlcml2ZWRLZXlUeXBlLCBleHRyYWN0YWJsZSwgdXNhZ2VzKQogIH0KCiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jU3VidGxlQ3J5cHRvLW1ldGhvZC1kaWdlc3QKICBhc3luYyBkaWdlc3QoYWxnb3JpdGhtLCBkYXRhKSB7CiAgICBpZiAodHlwZW9mIGFsZ29yaXRobSA9PT0gJ3N0cmluZycpIGFsZ29yaXRobSA9IHsgbmFtZTogYWxnb3JpdGhtIH0KCiAgICBzd2l0Y2ggKGFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAnc2hhLTEnOgogICAgICAgIHJldHVybiBzaGEuZGlnZXN0KCdzaGExJywgZGF0YSkKICAgICAgY2FzZSAnc2hhLTI1Nic6CiAgICAgICAgcmV0dXJuIHNoYS5kaWdlc3QoJ3NoYTI1NicsIGRhdGEpCiAgICAgIGNhc2UgJ3NoYS01MTInOgogICAgICAgIHJldHVybiBzaGEuZGlnZXN0KCdzaGE1MTInLCBkYXRhKQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgICAgYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IHN1cHBvcnQgdGhlIGRpZ2VzdCgpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICB9CiAgfQp9CgpleHBvcnRzLnN1YnRsZSA9IG5ldyBleHBvcnRzLlN1YnRsZUNyeXB0bygpCgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNjcnlwdG8taW50ZXJmYWNlCmV4cG9ydHMuQ3J5cHRvID0gY2xhc3MgQ3J5cHRvIHsKICBnZXQgc3VidGxlKCkgewogICAgcmV0dXJuIGV4cG9ydHMuc3VidGxlCiAgfQoKICBnZXRSYW5kb21WYWx1ZXMoYXJyYXkpIHsKICAgIHJldHVybiBleHBvcnRzLmdldFJhbmRvbVZhbHVlcyhhcnJheSkKICB9CgogIHJhbmRvbVVVSUQoKSB7CiAgICByZXR1cm4gZXhwb3J0cy5yYW5kb21VVUlEKCkKICB9Cn0KY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi9saWIvZXJyb3JzJykKCmNsYXNzIEV2ZW50TGlzdGVuZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5saXN0ID0gW10KICAgIHRoaXMuY291bnQgPSAwCiAgfQoKICBhcHBlbmQoY3R4LCBuYW1lLCBmbiwgb25jZSkgewogICAgdGhpcy5jb3VudCsrCiAgICBjdHguZW1pdCgnbmV3TGlzdGVuZXInLCBuYW1lLCBmbikgLy8gRW1pdCBCRUZPUkUgYWRkaW5nCiAgICB0aGlzLmxpc3QucHVzaChbZm4sIG9uY2VdKQogIH0KCiAgcHJlcGVuZChjdHgsIG5hbWUsIGZuLCBvbmNlKSB7CiAgICB0aGlzLmNvdW50KysKICAgIGN0eC5lbWl0KCduZXdMaXN0ZW5lcicsIG5hbWUsIGZuKSAvLyBFbWl0IEJFRk9SRSBhZGRpbmcKICAgIHRoaXMubGlzdC51bnNoaWZ0KFtmbiwgb25jZV0pCiAgfQoKICByZW1vdmUoY3R4LCBuYW1lLCBmbikgewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSB0aGlzLmxpc3QubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIGNvbnN0IGwgPSB0aGlzLmxpc3RbaV0KCiAgICAgIGlmIChsWzBdID09PSBmbikgewogICAgICAgIHRoaXMubGlzdC5zcGxpY2UoaSwgMSkKCiAgICAgICAgaWYgKHRoaXMuY291bnQgPT09IDEpIGRlbGV0ZSBjdHguX2V2ZW50c1tuYW1lXQoKICAgICAgICBjdHguZW1pdCgncmVtb3ZlTGlzdGVuZXInLCBuYW1lLCBmbikgLy8gRW1pdCBBRlRFUiByZW1vdmluZwoKICAgICAgICB0aGlzLmNvdW50LS0KICAgICAgICByZXR1cm4KICAgICAgfQogICAgfQogIH0KCiAgcmVtb3ZlQWxsKGN0eCwgbmFtZSkgewogICAgY29uc3QgbGlzdCA9IFsuLi50aGlzLmxpc3RdCiAgICB0aGlzLmxpc3QgPSBbXQoKICAgIGlmICh0aGlzLmNvdW50ID09PSBsaXN0Lmxlbmd0aCkgZGVsZXRlIGN0eC5fZXZlbnRzW25hbWVdCgogICAgZm9yIChsZXQgaSA9IGxpc3QubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY3R4LmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgbmFtZSwgbGlzdFtpXVswXSkgLy8gRW1pdCBBRlRFUiByZW1vdmluZwogICAgfQoKICAgIHRoaXMuY291bnQgLT0gbGlzdC5sZW5ndGgKICB9CgogIGVtaXQoY3R4LCBuYW1lLCAuLi5hcmdzKSB7CiAgICBjb25zdCBsaXN0ID0gWy4uLnRoaXMubGlzdF0KCiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGxpc3QubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIGNvbnN0IGwgPSBsaXN0W2ldCgogICAgICBpZiAobFsxXSA9PT0gdHJ1ZSkgdGhpcy5yZW1vdmUoY3R4LCBuYW1lLCBsWzBdKQoKICAgICAgUmVmbGVjdC5hcHBseShsWzBdLCBjdHgsIGFyZ3MpCiAgICB9CgogICAgcmV0dXJuIGxpc3QubGVuZ3RoID4gMAogIH0KfQoKZnVuY3Rpb24gYXBwZW5kTGlzdGVuZXIoY3R4LCBuYW1lLCBmbiwgb25jZSkgewogIGlmIChjdHguX2V2ZW50cyA9PT0gdW5kZWZpbmVkKSBjdHguX2V2ZW50cyA9IE9iamVjdC5jcmVhdGUobnVsbCkKICBjb25zdCBlID0gY3R4Ll9ldmVudHNbbmFtZV0gfHwgKGN0eC5fZXZlbnRzW25hbWVdID0gbmV3IEV2ZW50TGlzdGVuZXIoKSkKICBlLmFwcGVuZChjdHgsIG5hbWUsIGZuLCBvbmNlKQogIHJldHVybiBjdHgKfQoKZnVuY3Rpb24gcHJlcGVuZExpc3RlbmVyKGN0eCwgbmFtZSwgZm4sIG9uY2UpIHsKICBpZiAoY3R4Ll9ldmVudHMgPT09IHVuZGVmaW5lZCkgY3R4Ll9ldmVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpCiAgY29uc3QgZSA9IGN0eC5fZXZlbnRzW25hbWVdIHx8IChjdHguX2V2ZW50c1tuYW1lXSA9IG5ldyBFdmVudExpc3RlbmVyKCkpCiAgZS5wcmVwZW5kKGN0eCwgbmFtZSwgZm4sIG9uY2UpCiAgcmV0dXJuIGN0eAp9CgpmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihjdHgsIG5hbWUsIGZuKSB7CiAgaWYgKGN0eC5fZXZlbnRzID09PSB1bmRlZmluZWQpIHJldHVybiBjdHgKICBjb25zdCBlID0gY3R4Ll9ldmVudHNbbmFtZV0KICBpZiAoZSAhPT0gdW5kZWZpbmVkKSBlLnJlbW92ZShjdHgsIG5hbWUsIGZuKQogIHJldHVybiBjdHgKfQoKZnVuY3Rpb24gdGhyb3dVbmhhbmRsZWRFcnJvciguLi5hcmdzKSB7CiAgbGV0IGVycgoKICBpZiAoYXJncy5sZW5ndGggPiAwKSBlcnIgPSBhcmdzWzBdCgogIGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvciA9PT0gZmFsc2UpIGVyciA9IGVycm9ycy5VTkhBTkRMRURfRVJST1IoZXJyKQoKICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKGVyciwgZXhwb3J0cy5wcm90b3R5cGUuZW1pdCkKICB9CgogIHF1ZXVlTWljcm90YXNrKCgpID0+IHsKICAgIHRocm93IGVycgogIH0pCn0KCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IGNsYXNzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLl9ldmVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpCiAgfQoKICBhZGRMaXN0ZW5lcihuYW1lLCBmbikgewogICAgcmV0dXJuIGFwcGVuZExpc3RlbmVyKHRoaXMsIG5hbWUsIGZuLCBmYWxzZSkKICB9CgogIGFkZE9uY2VMaXN0ZW5lcihuYW1lLCBmbikgewogICAgcmV0dXJuIGFwcGVuZExpc3RlbmVyKHRoaXMsIG5hbWUsIGZuLCB0cnVlKQogIH0KCiAgcHJlcGVuZExpc3RlbmVyKG5hbWUsIGZuKSB7CiAgICByZXR1cm4gcHJlcGVuZExpc3RlbmVyKHRoaXMsIG5hbWUsIGZuLCBmYWxzZSkKICB9CgogIHByZXBlbmRPbmNlTGlzdGVuZXIobmFtZSwgZm4pIHsKICAgIHJldHVybiBwcmVwZW5kTGlzdGVuZXIodGhpcywgbmFtZSwgZm4sIHRydWUpCiAgfQoKICByZW1vdmVMaXN0ZW5lcihuYW1lLCBmbikgewogICAgcmV0dXJuIHJlbW92ZUxpc3RlbmVyKHRoaXMsIG5hbWUsIGZuKQogIH0KCiAgb24obmFtZSwgZm4pIHsKICAgIHJldHVybiBhcHBlbmRMaXN0ZW5lcih0aGlzLCBuYW1lLCBmbiwgZmFsc2UpCiAgfQoKICBvbmNlKG5hbWUsIGZuKSB7CiAgICByZXR1cm4gYXBwZW5kTGlzdGVuZXIodGhpcywgbmFtZSwgZm4sIHRydWUpCiAgfQoKICBvZmYobmFtZSwgZm4pIHsKICAgIHJldHVybiByZW1vdmVMaXN0ZW5lcih0aGlzLCBuYW1lLCBmbikKICB9CgogIGVtaXQobmFtZSwgLi4uYXJncykgewogICAgaWYgKG5hbWUgPT09ICdlcnJvcicgJiYgdGhpcy5fZXZlbnRzICE9PSB1bmRlZmluZWQgJiYgdGhpcy5fZXZlbnRzLmVycm9yID09PSB1bmRlZmluZWQpIHsKICAgICAgdGhyb3dVbmhhbmRsZWRFcnJvciguLi5hcmdzKQogICAgfQoKICAgIGlmICh0aGlzLl9ldmVudHMgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlCiAgICBjb25zdCBlID0gdGhpcy5fZXZlbnRzW25hbWVdCiAgICByZXR1cm4gZSA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBlLmVtaXQodGhpcywgbmFtZSwgLi4uYXJncykKICB9CgogIGxpc3RlbmVycyhuYW1lKSB7CiAgICBpZiAodGhpcy5fZXZlbnRzID09PSB1bmRlZmluZWQpIHJldHVybiBbXQogICAgY29uc3QgZSA9IHRoaXMuX2V2ZW50c1tuYW1lXQogICAgcmV0dXJuIGUgPT09IHVuZGVmaW5lZCA/IFtdIDogWy4uLmUubGlzdF0KICB9CgogIGxpc3RlbmVyQ291bnQobmFtZSkgewogICAgaWYgKHRoaXMuX2V2ZW50cyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gMAogICAgY29uc3QgZSA9IHRoaXMuX2V2ZW50c1tuYW1lXQogICAgcmV0dXJuIGUgPT09IHVuZGVmaW5lZCA/IDAgOiBlLmxpc3QubGVuZ3RoCiAgfQoKICBnZXRNYXhMaXN0ZW5lcnMoKSB7CiAgICByZXR1cm4gRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnMKICB9CgogIHNldE1heExpc3RlbmVycyhuKSB7fQoKICByZW1vdmVBbGxMaXN0ZW5lcnMobmFtZSkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgZm9yIChjb25zdCBrZXkgb2YgUmVmbGVjdC5vd25LZXlzKHRoaXMuX2V2ZW50cykpIHsKICAgICAgICBpZiAoa2V5ID09PSAncmVtb3ZlTGlzdGVuZXInKSBjb250aW51ZQogICAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKGtleSkKICAgICAgfQogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygncmVtb3ZlTGlzdGVuZXInKQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgZSA9IHRoaXMuX2V2ZW50c1tuYW1lXQogICAgICBpZiAoZSAhPT0gdW5kZWZpbmVkKSBlLnJlbW92ZUFsbCh0aGlzLCBuYW1lKQogICAgfQogICAgcmV0dXJuIHRoaXMKICB9Cn0KCmV4cG9ydHMuRXZlbnRFbWl0dGVyID0gZXhwb3J0cwoKZXhwb3J0cy5lcnJvcnMgPSBlcnJvcnMKCmV4cG9ydHMuZGVmYXVsdE1heExpc3RlbmVycyA9IDEwCgpleHBvcnRzLm9uID0gZnVuY3Rpb24gb24oZW1pdHRlciwgbmFtZSwgb3B0cyA9IHt9KSB7CiAgY29uc3QgeyBzaWduYWwgfSA9IG9wdHMKCiAgaWYgKHNpZ25hbCAmJiBzaWduYWwuYWJvcnRlZCkgewogICAgdGhyb3cgZXJyb3JzLk9QRVJBVElPTl9BQk9SVEVEKHNpZ25hbC5yZWFzb24pCiAgfQoKICBsZXQgZXJyb3IgPSBudWxsCiAgbGV0IGRvbmUgPSBmYWxzZQoKICBjb25zdCBldmVudHMgPSBbXQogIGNvbnN0IHByb21pc2VzID0gW10KCiAgaWYgKG5hbWUgIT09ICdlcnJvcicpIGVtaXR0ZXIub24oJ2Vycm9yJywgb25lcnJvcikKCiAgaWYgKHNpZ25hbCkgc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoJ2Fib3J0Jywgb25hYm9ydCkKCiAgZW1pdHRlci5vbihuYW1lLCBvbmV2ZW50KQoKICByZXR1cm4gewogICAgbmV4dCgpIHsKICAgICAgaWYgKGV2ZW50cy5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgdmFsdWU6IGV2ZW50cy5zaGlmdCgpLCBkb25lOiBmYWxzZSB9KQogICAgICB9CgogICAgICBpZiAoZXJyb3IpIHsKICAgICAgICBjb25zdCBlcnIgPSBlcnJvcgoKICAgICAgICBlcnJvciA9IG51bGwKCiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICAgICAgfQoKICAgICAgaWYgKGRvbmUpIHJldHVybiBvbmNsb3NlKCkKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiBwcm9taXNlcy5wdXNoKHsgcmVzb2x2ZSwgcmVqZWN0IH0pKQogICAgfSwKCiAgICByZXR1cm4oKSB7CiAgICAgIHJldHVybiBvbmNsb3NlKCkKICAgIH0sCgogICAgdGhyb3coZXJyKSB7CiAgICAgIHJldHVybiBvbmVycm9yKGVycikKICAgIH0sCgogICAgW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHsKICAgICAgcmV0dXJuIHRoaXMKICAgIH0KICB9CgogIGZ1bmN0aW9uIG9uZXZlbnQoLi4uYXJncykgewogICAgaWYgKHByb21pc2VzLmxlbmd0aCkgewogICAgICBwcm9taXNlcy5zaGlmdCgpLnJlc29sdmUoeyB2YWx1ZTogYXJncywgZG9uZTogZmFsc2UgfSkKICAgIH0gZWxzZSB7CiAgICAgIGV2ZW50cy5wdXNoKGFyZ3MpCiAgICB9CiAgfQoKICBmdW5jdGlvbiBvbmVycm9yKGVycikgewogICAgZW1pdHRlci5vZmYobmFtZSwgb25ldmVudCkub2ZmKCdlcnJvcicsIG9uZXJyb3IpCgogICAgaWYgKHByb21pc2VzLmxlbmd0aCkgewogICAgICBwcm9taXNlcy5zaGlmdCgpLnJlamVjdChlcnIpCiAgICB9IGVsc2UgewogICAgICBlcnJvciA9IGVycgogICAgfQoKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBkb25lOiB0cnVlIH0pCiAgfQoKICBmdW5jdGlvbiBvbmFib3J0KCkgewogICAgc2lnbmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2Fib3J0Jywgb25hYm9ydCkKCiAgICBvbmVycm9yKGVycm9ycy5PUEVSQVRJT05fQUJPUlRFRChzaWduYWwucmVhc29uKSkKICB9CgogIGZ1bmN0aW9uIG9uY2xvc2UoKSB7CiAgICBlbWl0dGVyLm9mZihuYW1lLCBvbmV2ZW50KQoKICAgIGlmIChuYW1lICE9PSAnZXJyb3InKSBlbWl0dGVyLm9mZignZXJyb3InLCBvbmVycm9yKQoKICAgIGlmIChzaWduYWwpIHNpZ25hbC5yZW1vdmVFdmVudExpc3RlbmVyKCdhYm9ydCcsIG9uYWJvcnQpCgogICAgZG9uZSA9IHRydWUKCiAgICBpZiAocHJvbWlzZXMubGVuZ3RoKSBwcm9taXNlcy5zaGlmdCgpLnJlc29sdmUoeyBkb25lOiB0cnVlIH0pCgogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGRvbmU6IHRydWUgfSkKICB9Cn0KCmV4cG9ydHMub25jZSA9IGZ1bmN0aW9uIG9uY2UoZW1pdHRlciwgbmFtZSwgb3B0cyA9IHt9KSB7CiAgY29uc3QgeyBzaWduYWwgfSA9IG9wdHMKCiAgaWYgKHNpZ25hbCAmJiBzaWduYWwuYWJvcnRlZCkgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9ycy5PUEVSQVRJT05fQUJPUlRFRChzaWduYWwucmVhc29uKSkKICB9CgogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBpZiAobmFtZSAhPT0gJ2Vycm9yJykgZW1pdHRlci5vbignZXJyb3InLCBvbmVycm9yKQoKICAgIGlmIChzaWduYWwpIHNpZ25hbC5hZGRFdmVudExpc3RlbmVyKCdhYm9ydCcsIG9uYWJvcnQpCgogICAgZW1pdHRlci5vbmNlKG5hbWUsIG9uZXZlbnQpCgogICAgZnVuY3Rpb24gb25ldmVudCguLi5hcmdzKSB7CiAgICAgIGlmIChuYW1lICE9PSAnZXJyb3InKSBlbWl0dGVyLm9mZignZXJyb3InLCBvbmVycm9yKQoKICAgICAgaWYgKHNpZ25hbCkgc2lnbmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2Fib3J0Jywgb25hYm9ydCkKCiAgICAgIHJlc29sdmUoYXJncykKICAgIH0KCiAgICBmdW5jdGlvbiBvbmVycm9yKGVycikgewogICAgICBlbWl0dGVyLm9mZihuYW1lLCBvbmV2ZW50KQoKICAgICAgaWYgKG5hbWUgIT09ICdlcnJvcicpIGVtaXR0ZXIub2ZmKCdlcnJvcicsIG9uZXJyb3IpCgogICAgICByZWplY3QoZXJyKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uYWJvcnQoKSB7CiAgICAgIHNpZ25hbC5yZW1vdmVFdmVudExpc3RlbmVyKCdhYm9ydCcsIG9uYWJvcnQpCgogICAgICBvbmVycm9yKGVycm9ycy5PUEVSQVRJT05fQUJPUlRFRChzaWduYWwucmVhc29uKSkKICAgIH0KICB9KQp9CgpleHBvcnRzLmZvcndhcmQgPSBmdW5jdGlvbiBmb3J3YXJkKGZyb20sIHRvLCBuYW1lcywgb3B0cyA9IHt9KSB7CiAgaWYgKHR5cGVvZiBuYW1lcyA9PT0gJ3N0cmluZycpIG5hbWVzID0gW25hbWVzXQoKICBjb25zdCB7IGVtaXQgPSB0by5lbWl0LmJpbmQodG8pIH0gPSBvcHRzCgogIGNvbnN0IGxpc3RlbmVycyA9IG5hbWVzLm1hcCgKICAgIChuYW1lKSA9PgogICAgICBmdW5jdGlvbiBvbmV2ZW50KC4uLmFyZ3MpIHsKICAgICAgICBlbWl0KG5hbWUsIC4uLmFyZ3MpCiAgICAgIH0KICApCgogIHRvLm9uKCduZXdMaXN0ZW5lcicsIChuYW1lKSA9PiB7CiAgICBjb25zdCBpID0gbmFtZXMuaW5kZXhPZihuYW1lKQoKICAgIGlmIChpICE9PSAtMSAmJiB0by5saXN0ZW5lckNvdW50KG5hbWUpID09PSAwKSB7CiAgICAgIGZyb20ub24obmFtZSwgbGlzdGVuZXJzW2ldKQogICAgfQogIH0pLm9uKCdyZW1vdmVMaXN0ZW5lcicsIChuYW1lKSA9PiB7CiAgICBjb25zdCBpID0gbmFtZXMuaW5kZXhPZihuYW1lKQoKICAgIGlmIChpICE9PSAtMSAmJiB0by5saXN0ZW5lckNvdW50KG5hbWUpID09PSAwKSB7CiAgICAgIGZyb20ub2ZmKG5hbWUsIGxpc3RlbmVyc1tpXSkKICAgIH0KICB9KQp9CgpleHBvcnRzLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbiBsaXN0ZW5lckNvdW50KGVtaXR0ZXIsIG5hbWUpIHsKICByZXR1cm4gZW1pdHRlci5saXN0ZW5lckNvdW50KG5hbWUpCn0KCmV4cG9ydHMuZ2V0TWF4TGlzdGVuZXJzID0gZnVuY3Rpb24gZ2V0TWF4TGlzdGVuZXJzKGVtaXR0ZXIpIHsKICBpZiAodHlwZW9mIGVtaXR0ZXIuZ2V0TWF4TGlzdGVuZXJzID09PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm4gZW1pdHRlci5nZXRNYXhMaXN0ZW5lcnMoKQogIH0KCiAgcmV0dXJuIGV4cG9ydHMuZGVmYXVsdE1heExpc3RlbmVycwp9CgpleHBvcnRzLnNldE1heExpc3RlbmVycyA9IGZ1bmN0aW9uIHNldE1heExpc3RlbmVycyhuLCAuLi5lbWl0dGVycykgewogIGlmIChlbWl0dGVycy5sZW5ndGggPT09IDApIGV4cG9ydHMuZGVmYXVsdE1heExpc3RlbmVycyA9IG4KICBlbHNlIHsKICAgIGZvciAoY29uc3QgZW1pdHRlciBvZiBlbWl0dGVycykgewogICAgICBpZiAodHlwZW9mIGVtaXR0ZXIuc2V0TWF4TGlzdGVuZXJzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgZW1pdHRlci5zZXRNYXhMaXN0ZW5lcnMobikKICAgICAgfQogICAgfQogIH0KfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEV2ZW50RW1pdHRlckVycm9yIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yKG1zZywgY29kZSwgZm4gPSBFdmVudEVtaXR0ZXJFcnJvciwgb3B0cykgewogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWAsIG9wdHMpCiAgICB0aGlzLmNvZGUgPSBjb2RlCgogICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIGZuKQogICAgfQogIH0KCiAgZ2V0IG5hbWUoKSB7CiAgICByZXR1cm4gJ0V2ZW50RW1pdHRlckVycm9yJwogIH0KCiAgc3RhdGljIE9QRVJBVElPTl9BQk9SVEVEKGNhdXNlLCBtc2cgPSAnT3BlcmF0aW9uIGFib3J0ZWQnKSB7CiAgICByZXR1cm4gbmV3IEV2ZW50RW1pdHRlckVycm9yKG1zZywgJ09QRVJBVElPTl9BQk9SVEVEJywgRXZlbnRFbWl0dGVyRXJyb3IuT1BFUkFUSU9OX0FCT1JURUQsIHsKICAgICAgY2F1c2UKICAgIH0pCiAgfQoKICBzdGF0aWMgVU5IQU5ETEVEX0VSUk9SKGNhdXNlLCBtc2cgPSAnVW5oYW5kbGVkIGVycm9yJykgewogICAgcmV0dXJuIG5ldyBFdmVudEVtaXR0ZXJFcnJvcihtc2csICdVTkhBTkRMRURfRVJST1InLCBFdmVudEVtaXR0ZXJFcnJvci5VTkhBTkRMRURfRVJST1IsIHsKICAgICAgY2F1c2UKICAgIH0pCiAgfQp9CnsKICAibmFtZSI6ICJiYXJlLWV2ZW50cyIsCiAgInZlcnNpb24iOiAiMi44LjIiLAogICJkZXNjcmlwdGlvbiI6ICJFdmVudCBlbWl0dGVycyBmb3IgSmF2YVNjcmlwdCIsCiAgImV4cG9ydHMiOiB7CiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuIjogewogICAgICAidHlwZXMiOiAiLi9pbmRleC5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9pbmRleC5qcyIKICAgIH0sCiAgICAiLi9nbG9iYWwiOiB7CiAgICAgICJ0eXBlcyI6ICIuL2dsb2JhbC5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9nbG9iYWwuanMiCiAgICB9LAogICAgIi4vd2ViIjogewogICAgICAidHlwZXMiOiAiLi93ZWIuZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vd2ViLmpzIgogICAgfSwKICAgICIuL2Vycm9ycyI6ICIuL2xpYi9lcnJvcnMuanMiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImluZGV4LmQudHMiLAogICAgImdsb2JhbC5qcyIsCiAgICAiZ2xvYmFsLmQudHMiLAogICAgIndlYi5qcyIsCiAgICAid2ViLmQudHMiLAogICAgImxpYiIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAibnBtIHJ1biBsaW50ICYmIG5wbSBydW4gdGVzdDpiYXJlICYmIG5wbSBydW4gdGVzdDpub2RlIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0LmpzIiwKICAgICJ0ZXN0Om5vZGUiOiAibm9kZSB0ZXN0LmpzIiwKICAgICJsaW50IjogInByZXR0aWVyIC4gLS1jaGVjayIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLWV2ZW50cy5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLWV2ZW50cy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtZXZlbnRzI3JlYWRtZSIsCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWFib3J0LWNvbnRyb2xsZXIiOiAiXjEuMC4wIiwKICAgICJicml0dGxlIjogIl4zLjMuMiIsCiAgICAicHJldHRpZXIiOiAiXjMuNC4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIsCiAgICAidW5jYXVnaHRzIjogIl4xLjEuMSIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYWJvcnQtY29udHJvbGxlciI6ICIqIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXNNZXRhIjogewogICAgImJhcmUtYWJvcnQtY29udHJvbGxlciI6IHsKICAgICAgIm9wdGlvbmFsIjogdHJ1ZQogICAgfQogIH0KfQptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUuYWRkb24oKQpjb25zdCBGSUZPID0gcmVxdWlyZSgnZmFzdC1maWZvJykKY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnYmFyZS1ldmVudHMnKQpjb25zdCBwYXRoID0gcmVxdWlyZSgnYmFyZS1wYXRoJykKY29uc3QgeyBmaWxlVVJMVG9QYXRoIH0gPSByZXF1aXJlKCdiYXJlLXVybCcpCmNvbnN0IHsgUmVhZGFibGUsIFdyaXRhYmxlIH0gPSByZXF1aXJlKCdiYXJlLXN0cmVhbScpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuL2JpbmRpbmcnKQpjb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2xpYi9jb25zdGFudHMnKQpjb25zdCBGaWxlRXJyb3IgPSByZXF1aXJlKCcuL2xpYi9lcnJvcnMnKQoKY29uc3QgaXNXaW5kb3dzID0gQmFyZS5wbGF0Zm9ybSA9PT0gJ3dpbjMyJwoKZXhwb3J0cy5jb25zdGFudHMgPSBjb25zdGFudHMKCmNsYXNzIEZpbGVSZXF1ZXN0IHsKICBzdGF0aWMgX2ZyZWUgPSBbXQoKICBzdGF0aWMgYm9ycm93KCkgewogICAgaWYgKHRoaXMuX2ZyZWUubGVuZ3RoID4gMCkgcmV0dXJuIHRoaXMuX2ZyZWUucG9wKCkKICAgIHJldHVybiBuZXcgRmlsZVJlcXVlc3QoKQogIH0KCiAgc3RhdGljIHJldHVybihyZXEpIHsKICAgIGlmICh0aGlzLl9mcmVlLmxlbmd0aCA8IDMyKSB0aGlzLl9mcmVlLnB1c2gocmVxLnJlc2V0KCkpCiAgICBlbHNlIHJlcS5kZXN0cm95KCkKICB9CgogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5fcmVzZXQoKQogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5yZXF1ZXN0SW5pdCh0aGlzLCB0aGlzLl9vbnJlc3VsdCkKICB9CgogIGdldCBoYW5kbGUoKSB7CiAgICByZXR1cm4gdGhpcy5faGFuZGxlCiAgfQoKICByZXRhaW4odmFsdWUpIHsKICAgIHRoaXMuX3JldGFpbiA9IHZhbHVlIC8vIFRpZSB0aGUgbGlmZXRpbWUgb2YgYHZhbHVlYCB0byB0aGUgbGlmZXRpbWUgb2YgYHRoaXNgCiAgfQoKICByZXNldCgpIHsKICAgIGlmICh0aGlzLl9oYW5kbGUgPT09IG51bGwpIHJldHVybiB0aGlzCgogICAgYmluZGluZy5yZXF1ZXN0UmVzZXQodGhpcy5faGFuZGxlKQoKICAgIHRoaXMuX3Jlc2V0KCkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLl9oYW5kbGUgPT09IG51bGwpIHJldHVybiB0aGlzCgogICAgYmluZGluZy5yZXF1ZXN0RGVzdHJveSh0aGlzLl9oYW5kbGUpCgogICAgdGhpcy5fcmVzZXQoKQogICAgdGhpcy5faGFuZGxlID0gbnVsbAoKICAgIHJldHVybiB0aGlzCiAgfQoKICB0aGVuKHJlc29sdmUsIHJlamVjdCkgewogICAgcmV0dXJuIHRoaXMuX3Byb21pc2UudGhlbihyZXNvbHZlLCByZWplY3QpCiAgfQoKICByZXR1cm4oKSB7CiAgICBpZiAodGhpcy5faGFuZGxlID09PSBudWxsKSByZXR1cm4gdGhpcwoKICAgIEZpbGVSZXF1ZXN0LnJldHVybih0aGlzKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBbU3ltYm9sLmRpc3Bvc2VdKCkgewogICAgdGhpcy5yZXR1cm4oKQogIH0KCiAgX3Jlc2V0KCkgewogICAgY29uc3QgeyBwcm9taXNlLCByZXNvbHZlLCByZWplY3QgfSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpCgogICAgdGhpcy5fcHJvbWlzZSA9IHByb21pc2UKICAgIHRoaXMuX3Jlc29sdmUgPSByZXNvbHZlCiAgICB0aGlzLl9yZWplY3QgPSByZWplY3QKICAgIHRoaXMuX3JldGFpbiA9IG51bGwKICB9CgogIF9vbnJlc3VsdChlcnIsIHN0YXR1cykgewogICAgaWYgKGVycikgdGhpcy5fcmVqZWN0KGVycikKICAgIGVsc2UgdGhpcy5fcmVzb2x2ZShzdGF0dXMpCiAgfQp9CgpmdW5jdGlvbiBvayhyZXN1bHQsIGNiKSB7CiAgaWYgKHR5cGVvZiByZXN1bHQgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gcmVzdWx0CiAgICByZXN1bHQgPSB1bmRlZmluZWQKICB9CgogIGlmIChjYikgY2IobnVsbCwgcmVzdWx0KQogIGVsc2UgcmV0dXJuIHJlc3VsdAp9CgpmdW5jdGlvbiBmYWlsKGVyciwgY2IpIHsKICBpZiAoY2IpIGNiKGVycikKICBlbHNlIHRocm93IGVycgp9CgpmdW5jdGlvbiBkb25lKGVyciwgcmVzdWx0LCBjYikgewogIGlmICh0eXBlb2YgcmVzdWx0ID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IHJlc3VsdAogICAgcmVzdWx0ID0gdW5kZWZpbmVkCiAgfQoKICBpZiAoZXJyKSBmYWlsKGVyciwgY2IpCiAgZWxzZSByZXR1cm4gb2socmVzdWx0LCBjYikKfQoKYXN5bmMgZnVuY3Rpb24gb3BlbihmaWxlcGF0aCwgZmxhZ3MgPSAncicsIG1vZGUgPSAwbzY2NiwgY2IpIHsKICBpZiAodHlwZW9mIGZsYWdzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IGZsYWdzCiAgICBmbGFncyA9ICdyJwogICAgbW9kZSA9IDBvNjY2CiAgfSBlbHNlIGlmICh0eXBlb2YgbW9kZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBtb2RlCiAgICBtb2RlID0gMG82NjYKICB9CgogIGlmICh0eXBlb2YgZmxhZ3MgPT09ICdzdHJpbmcnKSBmbGFncyA9IHRvRmxhZ3MoZmxhZ3MpCiAgaWYgKHR5cGVvZiBtb2RlID09PSAnc3RyaW5nJykgbW9kZSA9IHRvTW9kZShtb2RlKQoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBmZAogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcub3BlbihyZXEuaGFuZGxlLCBmaWxlcGF0aCwgZmxhZ3MsIG1vZGUpCgogICAgZmQgPSBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdvcGVuJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgZmQsIGNiKQp9CgpmdW5jdGlvbiBvcGVuU3luYyhmaWxlcGF0aCwgZmxhZ3MgPSAncicsIG1vZGUgPSAwbzY2NikgewogIGlmICh0eXBlb2YgZmxhZ3MgPT09ICdzdHJpbmcnKSBmbGFncyA9IHRvRmxhZ3MoZmxhZ3MpCiAgaWYgKHR5cGVvZiBtb2RlID09PSAnc3RyaW5nJykgbW9kZSA9IHRvTW9kZShtb2RlKQoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICByZXR1cm4gYmluZGluZy5vcGVuU3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCwgZmxhZ3MsIG1vZGUpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnb3BlbicsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBjbG9zZShmZCwgY2IpIHsKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLmNsb3NlKHJlcS5oYW5kbGUsIGZkKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ2Nsb3NlJywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gY2xvc2VTeW5jKGZkKSB7CiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcuY2xvc2VTeW5jKHJlcS5oYW5kbGUsIGZkKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ2Nsb3NlJywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gYWNjZXNzKGZpbGVwYXRoLCBtb2RlID0gY29uc3RhbnRzLkZfT0ssIGNiKSB7CiAgaWYgKHR5cGVvZiBtb2RlID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG1vZGUKICAgIG1vZGUgPSBjb25zdGFudHMuRl9PSwogIH0KCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLmFjY2VzcyhyZXEuaGFuZGxlLCBmaWxlcGF0aCwgbW9kZSkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdhY2Nlc3MnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gYWNjZXNzU3luYyhmaWxlcGF0aCwgbW9kZSA9IGNvbnN0YW50cy5GX09LKSB7CiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5hY2Nlc3NTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoLCBtb2RlKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ2FjY2VzcycsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBleGlzdHMoZmlsZXBhdGgsIGNiKSB7CiAgbGV0IG9rID0gdHJ1ZQogIHRyeSB7CiAgICBhd2FpdCBhY2Nlc3MoZmlsZXBhdGgpCiAgfSBjYXRjaCB7CiAgICBvayA9IGZhbHNlCiAgfQoKICByZXR1cm4gZG9uZShudWxsLCBvaywgY2IpCn0KCmZ1bmN0aW9uIGV4aXN0c1N5bmMoZmlsZXBhdGgpIHsKICB0cnkgewogICAgYWNjZXNzU3luYyhmaWxlcGF0aCkKICB9IGNhdGNoIHsKICAgIHJldHVybiBmYWxzZQogIH0KCiAgcmV0dXJuIHRydWUKfQoKYXN5bmMgZnVuY3Rpb24gcmVhZChmZCwgYnVmZmVyLCBvZmZzZXQgPSAwLCBsZW4gPSBidWZmZXIuYnl0ZUxlbmd0aCAtIG9mZnNldCwgcG9zID0gLTEsIGNiKSB7CiAgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb2Zmc2V0CiAgICBvZmZzZXQgPSAwCiAgICBsZW4gPSBidWZmZXIuYnl0ZUxlbmd0aAogICAgcG9zID0gLTEKICB9IGVsc2UgaWYgKHR5cGVvZiBsZW4gPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gbGVuCiAgICBsZW4gPSBidWZmZXIuYnl0ZUxlbmd0aCAtIG9mZnNldAogICAgcG9zID0gLTEKICB9IGVsc2UgaWYgKHR5cGVvZiBwb3MgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gcG9zCiAgICBwb3MgPSAtMQogIH0KCiAgaWYgKHR5cGVvZiBwb3MgIT09ICdudW1iZXInKSBwb3MgPSAtMQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgYnl0ZXMKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnJlYWQocmVxLmhhbmRsZSwgZmQsIGJ1ZmZlciwgb2Zmc2V0LCBsZW4sIHBvcykKCiAgICBieXRlcyA9IGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ3JlYWQnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGJ5dGVzLCBjYikKfQoKZnVuY3Rpb24gcmVhZFN5bmMoZmQsIGJ1ZmZlciwgb2Zmc2V0ID0gMCwgbGVuID0gYnVmZmVyLmJ5dGVMZW5ndGggLSBvZmZzZXQsIHBvcyA9IC0xKSB7CiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIHJldHVybiBiaW5kaW5nLnJlYWRTeW5jKHJlcS5oYW5kbGUsIGZkLCBidWZmZXIsIG9mZnNldCwgbGVuLCBwb3MpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAncmVhZCcsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJlYWR2KGZkLCBidWZmZXJzLCBwb3MgPSAtMSwgY2IpIHsKICBpZiAodHlwZW9mIHBvcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBwb3MKICAgIHBvcyA9IC0xCiAgfQoKICBpZiAodHlwZW9mIHBvcyAhPT0gJ251bWJlcicpIHBvcyA9IC0xCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBieXRlcwogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcucmVhZHYocmVxLmhhbmRsZSwgZmQsIGJ1ZmZlcnMsIHBvcykKCiAgICBieXRlcyA9IGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ3JlYWR2JywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBieXRlcywgY2IpCn0KCmZ1bmN0aW9uIHJlYWR2U3luYyhmZCwgYnVmZmVycywgcG9zID0gLTEpIHsKICBpZiAodHlwZW9mIHBvcyAhPT0gJ251bWJlcicpIHBvcyA9IC0xCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICByZXR1cm4gYmluZGluZy5yZWFkdlN5bmMocmVxLmhhbmRsZSwgZmQsIGJ1ZmZlcnMsIHBvcykKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdyZWFkdicsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHdyaXRlKGZkLCBkYXRhLCBvZmZzZXQgPSAwLCBsZW4sIHBvcyA9IC0xLCBjYikgewogIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgIGxldCBlbmNvZGluZyA9IGxlbgogICAgY2IgPSBwb3MKICAgIHBvcyA9IG9mZnNldAoKICAgIGlmICh0eXBlb2YgcG9zID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gcG9zCiAgICAgIHBvcyA9IC0xCiAgICAgIGVuY29kaW5nID0gJ3V0ZjgnCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGVuY29kaW5nCiAgICAgIGVuY29kaW5nID0gJ3V0ZjgnCiAgICB9CgogICAgaWYgKHR5cGVvZiBwb3MgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gcG9zCiAgICAgIHBvcyA9IC0xCiAgICB9CgogICAgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEsIGVuY29kaW5nKQogICAgb2Zmc2V0ID0gMAogICAgbGVuID0gZGF0YS5ieXRlTGVuZ3RoCiAgfSBlbHNlIGlmICh0eXBlb2Ygb2Zmc2V0ID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9mZnNldAogICAgb2Zmc2V0ID0gMAogICAgbGVuID0gZGF0YS5ieXRlTGVuZ3RoCiAgICBwb3MgPSAtMQogIH0gZWxzZSBpZiAodHlwZW9mIGxlbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBsZW4KICAgIGxlbiA9IGRhdGEuYnl0ZUxlbmd0aCAtIG9mZnNldAogICAgcG9zID0gLTEKICB9IGVsc2UgaWYgKHR5cGVvZiBwb3MgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gcG9zCiAgICBwb3MgPSAtMQogIH0KCiAgaWYgKHR5cGVvZiBsZW4gIT09ICdudW1iZXInKSBsZW4gPSBkYXRhLmJ5dGVMZW5ndGggLSBvZmZzZXQKICBpZiAodHlwZW9mIHBvcyAhPT0gJ251bWJlcicpIHBvcyA9IC0xCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBieXRlcwogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcud3JpdGUocmVxLmhhbmRsZSwgZmQsIGRhdGEsIG9mZnNldCwgbGVuLCBwb3MpCgogICAgYnl0ZXMgPSBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICd3cml0ZScsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgYnl0ZXMsIGNiKQp9CgpmdW5jdGlvbiB3cml0ZVN5bmMoZmQsIGRhdGEsIG9mZnNldCA9IDAsIGxlbiwgcG9zID0gLTEpIHsKICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICBsZXQgZW5jb2RpbmcgPSBsZW4KICAgIHBvcyA9IG9mZnNldAoKICAgIGlmICh0eXBlb2YgcG9zID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IHBvcwogICAgICBwb3MgPSAtMQogICAgfQoKICAgIGRhdGEgPSBCdWZmZXIuZnJvbShkYXRhLCBlbmNvZGluZykKICAgIG9mZnNldCA9IDAKICAgIGxlbiA9IGRhdGEuYnl0ZUxlbmd0aAogIH0KCiAgaWYgKHR5cGVvZiBsZW4gIT09ICdudW1iZXInKSBsZW4gPSBkYXRhLmJ5dGVMZW5ndGggLSBvZmZzZXQKICBpZiAodHlwZW9mIHBvcyAhPT0gJ251bWJlcicpIHBvcyA9IC0xCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICByZXR1cm4gYmluZGluZy53cml0ZVN5bmMocmVxLmhhbmRsZSwgZmQsIGRhdGEsIG9mZnNldCwgbGVuLCBwb3MpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnd3JpdGUnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiB3cml0ZXYoZmQsIGJ1ZmZlcnMsIHBvcyA9IC0xLCBjYikgewogIGlmICh0eXBlb2YgcG9zID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IHBvcwogICAgcG9zID0gLTEKICB9CgogIGlmICh0eXBlb2YgcG9zICE9PSAnbnVtYmVyJykgcG9zID0gLTEKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGJ5dGVzCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy53cml0ZXYocmVxLmhhbmRsZSwgZmQsIGJ1ZmZlcnMsIHBvcykKCiAgICBieXRlcyA9IGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ3dyaXRldicsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgYnl0ZXMsIGNiKQp9CgpmdW5jdGlvbiB3cml0ZXZTeW5jKGZkLCBidWZmZXJzLCBwb3MgPSAtMSkgewogIGlmICh0eXBlb2YgcG9zICE9PSAnbnVtYmVyJykgcG9zID0gLTEKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIHJldHVybiBiaW5kaW5nLndyaXRldlN5bmMocmVxLmhhbmRsZSwgZmQsIGJ1ZmZlcnMsIHBvcykKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICd3cml0ZXYnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBzdGF0KGZpbGVwYXRoLCBjYikgewogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IHN0CiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5zdGF0KHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIGF3YWl0IHJlcQoKICAgIHN0ID0gbmV3IFN0YXRzKC4uLmJpbmRpbmcucmVxdWVzdFJlc3VsdFN0YXQocmVxLmhhbmRsZSkpCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnc3RhdCcsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIHN0LCBjYikKfQoKZnVuY3Rpb24gc3RhdFN5bmMoZmlsZXBhdGgpIHsKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLnN0YXRTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIHJldHVybiBuZXcgU3RhdHMoLi4uYmluZGluZy5yZXF1ZXN0UmVzdWx0U3RhdChyZXEuaGFuZGxlKSkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdzdGF0JywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGxzdGF0KGZpbGVwYXRoLCBjYikgewogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IHN0CiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5sc3RhdChyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICBhd2FpdCByZXEKCiAgICBzdCA9IG5ldyBTdGF0cyguLi5iaW5kaW5nLnJlcXVlc3RSZXN1bHRTdGF0KHJlcS5oYW5kbGUpKQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ2xzdGF0JywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgc3QsIGNiKQp9CgpmdW5jdGlvbiBsc3RhdFN5bmMoZmlsZXBhdGgpIHsKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLmxzdGF0U3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICByZXR1cm4gbmV3IFN0YXRzKC4uLmJpbmRpbmcucmVxdWVzdFJlc3VsdFN0YXQocmVxLmhhbmRsZSkpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnbHN0YXQnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZnN0YXQoZmQsIGNiKSB7CiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IHN0CiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5mc3RhdChyZXEuaGFuZGxlLCBmZCkKCiAgICBhd2FpdCByZXEKCiAgICBzdCA9IG5ldyBTdGF0cyguLi5iaW5kaW5nLnJlcXVlc3RSZXN1bHRTdGF0KHJlcS5oYW5kbGUpKQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ2ZzdGF0JywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBzdCwgY2IpCn0KCmZ1bmN0aW9uIGZzdGF0U3luYyhmZCkgewogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLmZzdGF0U3luYyhyZXEuaGFuZGxlLCBmZCkKCiAgICByZXR1cm4gbmV3IFN0YXRzKC4uLmJpbmRpbmcucmVxdWVzdFJlc3VsdFN0YXQocmVxLmhhbmRsZSkpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnZnN0YXQnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBmdHJ1bmNhdGUoZmQsIGxlbiA9IDAsIGNiKSB7CiAgaWYgKHR5cGVvZiBsZW4gPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gbGVuCiAgICBsZW4gPSAwCiAgfQoKICBpZiAodHlwZW9mIGxlbiAhPT0gJ251bWJlcicpIGxlbiA9IDAKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5mdHJ1bmNhdGUocmVxLmhhbmRsZSwgZmQsIGxlbikKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdmdHJ1bmNhdGUnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiBmdHJ1bmNhdGVTeW5jKGZkLCBsZW4gPSAwKSB7CiAgaWYgKHR5cGVvZiBsZW4gIT09ICdudW1iZXInKSBsZW4gPSAwCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLmZ0cnVuY2F0ZVN5bmMocmVxLmhhbmRsZSwgZmQsIGxlbikKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdmdHJ1bmNhdGUnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBjaG1vZChmaWxlcGF0aCwgbW9kZSwgY2IpIHsKICBpZiAodHlwZW9mIG1vZGUgPT09ICdzdHJpbmcnKSBtb2RlID0gdG9Nb2RlKG1vZGUpCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5jaG1vZChyZXEuaGFuZGxlLCBmaWxlcGF0aCwgbW9kZSkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdjaG1vZCcsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiBjaG1vZFN5bmMoZmlsZXBhdGgsIG1vZGUpIHsKICBpZiAodHlwZW9mIG1vZGUgPT09ICdzdHJpbmcnKSBtb2RlID0gdG9Nb2RlKG1vZGUpCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcuY2htb2RTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoLCBtb2RlKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ2NobW9kJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGZjaG1vZChmZCwgbW9kZSwgY2IpIHsKICBpZiAodHlwZW9mIG1vZGUgPT09ICdzdHJpbmcnKSBtb2RlID0gdG9Nb2RlKG1vZGUpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcuZmNobW9kKHJlcS5oYW5kbGUsIGZkLCBtb2RlKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ2ZjaG1vZCcsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIGZjaG1vZFN5bmMoZmQsIG1vZGUpIHsKICBpZiAodHlwZW9mIG1vZGUgPT09ICdzdHJpbmcnKSBtb2RlID0gdG9Nb2RlKG1vZGUpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLmZjaG1vZFN5bmMocmVxLmhhbmRsZSwgZmQsIG1vZGUpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnZmNobW9kJywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gdXRpbWVzKGZpbGVwYXRoLCBhdGltZSwgbXRpbWUsIGNiKSB7CiAgaWYgKHR5cGVvZiBhdGltZSAhPT0gJ251bWJlcicpIGF0aW1lID0gYXRpbWUuZ2V0VGltZSgpIC8gMTAwMAogIGlmICh0eXBlb2YgbXRpbWUgIT09ICdudW1iZXInKSBtdGltZSA9IG10aW1lLmdldFRpbWUoKSAvIDEwMDAKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnV0aW1lcyhyZXEuaGFuZGxlLCBmaWxlcGF0aCwgYXRpbWUsIG10aW1lKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3V0aW1lcycsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiB1dGltZXNTeW5jKGZpbGVwYXRoLCBhdGltZSwgbXRpbWUpIHsKICBpZiAodHlwZW9mIGF0aW1lICE9PSAnbnVtYmVyJykgYXRpbWUgPSBhdGltZS5nZXRUaW1lKCkgLyAxMDAwCiAgaWYgKHR5cGVvZiBtdGltZSAhPT0gJ251bWJlcicpIG10aW1lID0gbXRpbWUuZ2V0VGltZSgpIC8gMTAwMAoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLnV0aW1lc1N5bmMocmVxLmhhbmRsZSwgZmlsZXBhdGgsIGF0aW1lLCBtdGltZSkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICd1dGltZXMnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gbWtkaXIoZmlsZXBhdGgsIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7IG1vZGU6IDBvNzc3IH0KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ251bWJlcicpIG9wdHMgPSB7IG1vZGU6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgbW9kZSA9IHR5cGVvZiBvcHRzLm1vZGUgPT09ICdudW1iZXInID8gb3B0cy5tb2RlIDogMG83NzcKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICBpZiAob3B0cy5yZWN1cnNpdmUpIHsKICAgIGxldCBlcnIgPSBudWxsCiAgICB0cnkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IG1rZGlyKGZpbGVwYXRoLCB7IG1vZGUgfSkKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKGVyci5jb2RlICE9PSAnRU5PRU5UJykgewogICAgICAgICAgaWYgKCEoYXdhaXQgc3RhdChmaWxlcGF0aCkpLmlzRGlyZWN0b3J5KCkpIHRocm93IGVycgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3aGlsZSAoZmlsZXBhdGguZW5kc1dpdGgocGF0aC5zZXApKSBmaWxlcGF0aCA9IGZpbGVwYXRoLnNsaWNlKDAsIC0xKQogICAgICAgICAgY29uc3QgaSA9IGZpbGVwYXRoLmxhc3RJbmRleE9mKHBhdGguc2VwKQogICAgICAgICAgaWYgKGkgPD0gMCkgdGhyb3cgZXJyCgogICAgICAgICAgYXdhaXQgbWtkaXIoZmlsZXBhdGguc2xpY2UoMCwgaSksIHsgbW9kZSwgcmVjdXJzaXZlOiB0cnVlIH0pCgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgbWtkaXIoZmlsZXBhdGgsIHsgbW9kZSB9KQogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGlmICghKGF3YWl0IHN0YXQoZmlsZXBhdGgpKS5pc0RpcmVjdG9yeSgpKSB0aHJvdyBlcnIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyID0gZQogICAgfQoKICAgIHJldHVybiBkb25lKGVyciwgY2IpCiAgfQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLm1rZGlyKHJlcS5oYW5kbGUsIGZpbGVwYXRoLCBtb2RlKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ21rZGlyJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIG1rZGlyU3luYyhmaWxlcGF0aCwgb3B0cykgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ251bWJlcicpIG9wdHMgPSB7IG1vZGU6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgbW9kZSA9IHR5cGVvZiBvcHRzLm1vZGUgPT09ICdudW1iZXInID8gb3B0cy5tb2RlIDogMG83NzcKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICBpZiAob3B0cy5yZWN1cnNpdmUpIHsKICAgIHRyeSB7CiAgICAgIG1rZGlyU3luYyhmaWxlcGF0aCwgeyBtb2RlIH0pCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKGVyci5jb2RlICE9PSAnRU5PRU5UJykgewogICAgICAgIGlmICghc3RhdFN5bmMoZmlsZXBhdGgpLmlzRGlyZWN0b3J5KCkpIHRocm93IGVycgogICAgICB9IGVsc2UgewogICAgICAgIHdoaWxlIChmaWxlcGF0aC5lbmRzV2l0aChwYXRoLnNlcCkpIGZpbGVwYXRoID0gZmlsZXBhdGguc2xpY2UoMCwgLTEpCiAgICAgICAgY29uc3QgaSA9IGZpbGVwYXRoLmxhc3RJbmRleE9mKHBhdGguc2VwKQogICAgICAgIGlmIChpIDw9IDApIHRocm93IGVycgoKICAgICAgICBta2RpclN5bmMoZmlsZXBhdGguc2xpY2UoMCwgaSksIHsgbW9kZSwgcmVjdXJzaXZlOiB0cnVlIH0pCgogICAgICAgIHRyeSB7CiAgICAgICAgICBta2RpclN5bmMoZmlsZXBhdGgsIHsgbW9kZSB9KQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgaWYgKCFzdGF0U3luYyhmaWxlcGF0aCkuaXNEaXJlY3RvcnkoKSkgdGhyb3cgZXJyCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuCiAgfQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5ta2RpclN5bmMocmVxLmhhbmRsZSwgZmlsZXBhdGgsIG1vZGUpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnbWtkaXInLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcm1kaXIoZmlsZXBhdGgsIGNiKSB7CiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnJtZGlyKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3JtZGlyJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIHJtZGlyU3luYyhmaWxlcGF0aCkgewogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcucm1kaXJTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3JtZGlyJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJtKGZpbGVwYXRoLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgY29uc3Qgc3QgPSBhd2FpdCBsc3RhdChmaWxlcGF0aCkKCiAgICBpZiAoc3QuaXNEaXJlY3RvcnkoKSkgewogICAgICBpZiAob3B0cy5yZWN1cnNpdmUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgYXdhaXQgcm1kaXIoZmlsZXBhdGgpCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBpZiAoZXJyLmNvZGUgIT09ICdFTk9URU1QVFknKSB0aHJvdyBlcnIKCiAgICAgICAgICBjb25zdCBmaWxlcyA9IGF3YWl0IHJlYWRkaXIoZmlsZXBhdGgpCgogICAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7CiAgICAgICAgICAgIGF3YWl0IHJtKGZpbGVwYXRoICsgcGF0aC5zZXAgKyBmaWxlLCBvcHRzKQogICAgICAgICAgfQoKICAgICAgICAgIGF3YWl0IHJtZGlyKGZpbGVwYXRoKQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRmlsZUVycm9yKCdpcyBhIGRpcmVjdG9yeScsIHsKICAgICAgICAgIG9wZXJhdGlvbjogJ3JtJywKICAgICAgICAgIGNvZGU6ICdFSVNESVInLAogICAgICAgICAgcGF0aDogZmlsZXBhdGgKICAgICAgICB9KQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBhd2FpdCB1bmxpbmsoZmlsZXBhdGgpCiAgICB9CiAgfSBjYXRjaCAoZSkgewogICAgaWYgKGUuY29kZSAhPT0gJ0VOT0VOVCcgfHwgIW9wdHMuZm9yY2UpIGVyciA9IGUKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIHJtU3luYyhmaWxlcGF0aCwgb3B0cykgewogIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdHJ5IHsKICAgIGNvbnN0IHN0ID0gbHN0YXRTeW5jKGZpbGVwYXRoKQoKICAgIGlmIChzdC5pc0RpcmVjdG9yeSgpKSB7CiAgICAgIGlmIChvcHRzLnJlY3Vyc2l2ZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBybWRpclN5bmMoZmlsZXBhdGgpCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBpZiAoZXJyLmNvZGUgIT09ICdFTk9URU1QVFknKSB0aHJvdyBlcnIKCiAgICAgICAgICBjb25zdCBmaWxlcyA9IHJlYWRkaXJTeW5jKGZpbGVwYXRoKQoKICAgICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykgewogICAgICAgICAgICBybVN5bmMoZmlsZXBhdGggKyBwYXRoLnNlcCArIGZpbGUsIG9wdHMpCiAgICAgICAgICB9CgogICAgICAgICAgcm1kaXJTeW5jKGZpbGVwYXRoKQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRmlsZUVycm9yKCdpcyBhIGRpcmVjdG9yeScsIHsKICAgICAgICAgIG9wZXJhdGlvbjogJ3JtJywKICAgICAgICAgIGNvZGU6ICdFSVNESVInLAogICAgICAgICAgcGF0aDogZmlsZXBhdGgKICAgICAgICB9KQogICAgICB9CiAgICB9IGVsc2UgewogICAgICB1bmxpbmtTeW5jKGZpbGVwYXRoKQogICAgfQogIH0gY2F0Y2ggKGVycikgewogICAgaWYgKGVyci5jb2RlICE9PSAnRU5PRU5UJyB8fCAhb3B0cy5mb3JjZSkgdGhyb3cgZXJyCiAgfQp9Cgphc3luYyBmdW5jdGlvbiB1bmxpbmsoZmlsZXBhdGgsIGNiKSB7CiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnVubGluayhyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICd1bmxpbmsnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gdW5saW5rU3luYyhmaWxlcGF0aCkgewogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcudW5saW5rU3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICd1bmxpbmsnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcmVuYW1lKHNyYywgZHN0LCBjYikgewogIHNyYyA9IHRvTmFtZXNwYWNlZFBhdGgoc3JjKQogIGRzdCA9IHRvTmFtZXNwYWNlZFBhdGgoZHN0KQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnJlbmFtZShyZXEuaGFuZGxlLCBzcmMsIGRzdCkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdyZW5hbWUnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IHNyYywKICAgICAgZGVzdGluYXRpb246IGRzdAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIHJlbmFtZVN5bmMoc3JjLCBkc3QpIHsKICBzcmMgPSB0b05hbWVzcGFjZWRQYXRoKHNyYykKICBkc3QgPSB0b05hbWVzcGFjZWRQYXRoKGRzdCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcucmVuYW1lU3luYyhyZXEuaGFuZGxlLCBzcmMsIGRzdCkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdyZW5hbWUnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IHNyYywKICAgICAgZGVzdGluYXRpb246IGRzdAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGNvcHlGaWxlKHNyYywgZHN0LCBtb2RlID0gMCwgY2IpIHsKICBpZiAodHlwZW9mIG1vZGUgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gbW9kZQogICAgbW9kZSA9IDAKICB9CgogIHNyYyA9IHRvTmFtZXNwYWNlZFBhdGgoc3JjKQogIGRzdCA9IHRvTmFtZXNwYWNlZFBhdGgoZHN0KQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLmNvcHlmaWxlKHJlcS5oYW5kbGUsIHNyYywgZHN0LCBtb2RlKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ2NvcHlmaWxlJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBzcmMsCiAgICAgIGRlc3RpbmF0aW9uOiBkc3QKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiBjb3B5RmlsZVN5bmMoc3JjLCBkc3QsIG1vZGUgPSAwKSB7CiAgc3JjID0gdG9OYW1lc3BhY2VkUGF0aChzcmMpCiAgZHN0ID0gdG9OYW1lc3BhY2VkUGF0aChkc3QpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLmNvcHlmaWxlU3luYyhyZXEuaGFuZGxlLCBzcmMsIGRzdCwgbW9kZSkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdjb3B5ZmlsZScsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogc3JjLAogICAgICBkZXN0aW5hdGlvbjogZHN0CiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gY3Aoc3JjLCBkc3QsIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7fQogIH0KCiAgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgc3JjID0gdG9OYW1lc3BhY2VkUGF0aChzcmMpCiAgZHN0ID0gdG9OYW1lc3BhY2VkUGF0aChkc3QpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGNvbnN0IHN0ID0gYXdhaXQgbHN0YXQoc3JjKQoKICAgIGlmIChzdC5pc0RpcmVjdG9yeSgpKSB7CiAgICAgIGlmIChvcHRzLnJlY3Vyc2l2ZSAhPT0gdHJ1ZSkgewogICAgICAgIHRocm93IG5ldyBGaWxlRXJyb3IoJ2lzIGEgZGlyZWN0b3J5JywgewogICAgICAgICAgb3BlcmF0aW9uOiAnY3AnLAogICAgICAgICAgY29kZTogJ0VJU0RJUicsCiAgICAgICAgICBwYXRoOiBzcmMKICAgICAgICB9KQogICAgICB9CgogICAgICB0cnkgewogICAgICAgIGF3YWl0IGxzdGF0KGRzdCkKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChlLmNvZGUgPT09ICdFTk9FTlQnKSB7CiAgICAgICAgICBhd2FpdCBta2Rpcihkc3QsIHsgbW9kZTogc3QubW9kZSwgcmVjdXJzaXZlOiB0cnVlIH0pCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IGUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IGRpciA9IGF3YWl0IG9wZW5kaXIoc3JjKQogICAgICBmb3IgYXdhaXQgKGNvbnN0IHsgbmFtZSB9IG9mIGRpcikgewogICAgICAgIGF3YWl0IGNwKHBhdGguam9pbihzcmMsIG5hbWUpLCBwYXRoLmpvaW4oZHN0LCBuYW1lKSwgb3B0cykKICAgICAgfQogICAgfSBlbHNlIGlmIChzdC5pc0ZpbGUoKSkgewogICAgICBhd2FpdCBjb3B5RmlsZShzcmMsIGRzdCkKICAgICAgYXdhaXQgY2htb2QoZHN0LCBzdC5tb2RlKQogICAgfQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IGUKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmFzeW5jIGZ1bmN0aW9uIHJlYWxwYXRoKGZpbGVwYXRoLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGNvbnN0IHsgZW5jb2RpbmcgPSAndXRmOCcgfSA9IG9wdHMKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgcmVzCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5yZWFscGF0aChyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICBhd2FpdCByZXEKCiAgICByZXMgPSBCdWZmZXIuZnJvbShiaW5kaW5nLnJlcXVlc3RSZXN1bHRTdHJpbmcocmVxLmhhbmRsZSkpCgogICAgaWYgKGVuY29kaW5nICE9PSAnYnVmZmVyJykgcmVzID0gcmVzLnRvU3RyaW5nKGVuY29kaW5nKQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3JlYWxwYXRoJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgcmVzLCBjYikKfQoKZnVuY3Rpb24gcmVhbHBhdGhTeW5jKGZpbGVwYXRoLCBvcHRzKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgeyBlbmNvZGluZyA9ICd1dGY4JyB9ID0gb3B0cwoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLnJlYWxwYXRoU3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICBsZXQgcmVzID0gQnVmZmVyLmZyb20oYmluZGluZy5yZXF1ZXN0UmVzdWx0U3RyaW5nKHJlcS5oYW5kbGUpKQoKICAgIGlmIChlbmNvZGluZyAhPT0gJ2J1ZmZlcicpIHJlcyA9IHJlcy50b1N0cmluZyhlbmNvZGluZykKCiAgICByZXR1cm4gcmVzCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAncmVhbHBhdGgnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcmVhZGxpbmsoZmlsZXBhdGgsIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7fQogIH0KCiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgeyBlbmNvZGluZyA9ICd1dGY4JyB9ID0gb3B0cwoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCByZXMKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnJlYWRsaW5rKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIGF3YWl0IHJlcQoKICAgIHJlcyA9IEJ1ZmZlci5mcm9tKGJpbmRpbmcucmVxdWVzdFJlc3VsdFN0cmluZyhyZXEuaGFuZGxlKSkKCiAgICBpZiAoZW5jb2RpbmcgIT09ICdidWZmZXInKSByZXMgPSByZXMudG9TdHJpbmcoZW5jb2RpbmcpCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAncmVhZGxpbmsnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCByZXMsIGNiKQp9CgpmdW5jdGlvbiByZWFkbGlua1N5bmMoZmlsZXBhdGgsIG9wdHMpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBjb25zdCB7IGVuY29kaW5nID0gJ3V0ZjgnIH0gPSBvcHRzCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcucmVhZGxpbmtTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIGxldCByZXMgPSBCdWZmZXIuZnJvbShiaW5kaW5nLnJlcXVlc3RSZXN1bHRTdHJpbmcocmVxLmhhbmRsZSkpCgogICAgaWYgKGVuY29kaW5nICE9PSAnYnVmZmVyJykgcmVzID0gcmVzLnRvU3RyaW5nKGVuY29kaW5nKQoKICAgIHJldHVybiByZXMKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdyZWFkbGluaycsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9CgpmdW5jdGlvbiBub3JtYWxpemVTeW1saW5rVGFyZ2V0KHRhcmdldCwgdHlwZSwgZmlsZXBhdGgpIHsKICBpZiAoaXNXaW5kb3dzKSB7CiAgICBpZiAodHlwZSA9PT0gJ2p1bmN0aW9uJykgdGFyZ2V0ID0gcGF0aC5yZXNvbHZlKGZpbGVwYXRoLCAnLi4nLCB0YXJnZXQpCgogICAgaWYgKHBhdGguaXNBYnNvbHV0ZSh0YXJnZXQpKSByZXR1cm4gcGF0aC50b05hbWVzcGFjZWRQYXRoKHRhcmdldCkKCiAgICByZXR1cm4gdGFyZ2V0LnJlcGxhY2UoL1wvL2csIHBhdGguc2VwKQogIH0KCiAgcmV0dXJuIHRhcmdldAp9Cgphc3luYyBmdW5jdGlvbiBzeW1saW5rKHRhcmdldCwgZmlsZXBhdGgsIHR5cGUsIGNiKSB7CiAgaWYgKHR5cGVvZiB0eXBlID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IHR5cGUKICAgIHR5cGUgPSBudWxsCiAgfQoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIGlmICh0eXBlb2YgdHlwZSA9PT0gJ3N0cmluZycpIHsKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlICdmaWxlJzoKICAgICAgZGVmYXVsdDoKICAgICAgICB0eXBlID0gMAogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ2Rpcic6CiAgICAgICAgdHlwZSA9IGNvbnN0YW50cy5VVl9GU19TWU1MSU5LX0RJUgogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ2p1bmN0aW9uJzoKICAgICAgICB0eXBlID0gY29uc3RhbnRzLlVWX0ZTX1NZTUxJTktfSlVOQ1RJT04KICAgICAgICBicmVhawogICAgfQogIH0gZWxzZSBpZiAodHlwZW9mIHR5cGUgIT09ICdudW1iZXInKSB7CiAgICBpZiAoaXNXaW5kb3dzKSB7CiAgICAgIHRhcmdldCA9IHBhdGgucmVzb2x2ZShmaWxlcGF0aCwgJy4uJywgdGFyZ2V0KQoKICAgICAgdHJ5IHsKICAgICAgICB0eXBlID0gKGF3YWl0IHN0YXQodGFyZ2V0KSkuaXNEaXJlY3RvcnkoKQogICAgICAgICAgPyBjb25zdGFudHMuVVZfRlNfU1lNTElOS19ESVIKICAgICAgICAgIDogY29uc3RhbnRzLlVWX0ZTX1NZTUxJTktfSlVOQ1RJT04KICAgICAgfSBjYXRjaCB7CiAgICAgICAgdHlwZSA9IDAKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdHlwZSA9IDAKICAgIH0KICB9CgogIHRhcmdldCA9IG5vcm1hbGl6ZVN5bWxpbmtUYXJnZXQodGFyZ2V0KQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnN5bWxpbmsocmVxLmhhbmRsZSwgdGFyZ2V0LCBmaWxlcGF0aCwgdHlwZSkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdzeW1saW5rJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiB0YXJnZXQsCiAgICAgIGRlc3RpbmF0aW9uOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIHN5bWxpbmtTeW5jKHRhcmdldCwgZmlsZXBhdGgsIHR5cGUpIHsKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIGlmICh0eXBlb2YgdHlwZSA9PT0gJ3N0cmluZycpIHsKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlICdmaWxlJzoKICAgICAgZGVmYXVsdDoKICAgICAgICB0eXBlID0gMAogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ2Rpcic6CiAgICAgICAgdHlwZSA9IGNvbnN0YW50cy5VVl9GU19TWU1MSU5LX0RJUgogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ2p1bmN0aW9uJzoKICAgICAgICB0eXBlID0gY29uc3RhbnRzLlVWX0ZTX1NZTUxJTktfSlVOQ1RJT04KICAgICAgICBicmVhawogICAgfQogIH0gZWxzZSBpZiAodHlwZW9mIHR5cGUgIT09ICdudW1iZXInKSB7CiAgICBpZiAoaXNXaW5kb3dzKSB7CiAgICAgIHRhcmdldCA9IHBhdGgucmVzb2x2ZShmaWxlcGF0aCwgJy4uJywgdGFyZ2V0KQoKICAgICAgdHJ5IHsKICAgICAgICB0eXBlID0gc3RhdFN5bmModGFyZ2V0KS5pc0RpcmVjdG9yeSgpCiAgICAgICAgICA/IGNvbnN0YW50cy5VVl9GU19TWU1MSU5LX0RJUgogICAgICAgICAgOiBjb25zdGFudHMuVVZfRlNfU1lNTElOS19KVU5DVElPTgogICAgICB9IGNhdGNoIHsKICAgICAgICB0eXBlID0gMAogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0eXBlID0gMAogICAgfQogIH0KCiAgdGFyZ2V0ID0gbm9ybWFsaXplU3ltbGlua1RhcmdldCh0YXJnZXQpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLnN5bWxpbmtTeW5jKHJlcS5oYW5kbGUsIHRhcmdldCwgZmlsZXBhdGgsIHR5cGUpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnc3ltbGluaycsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogdGFyZ2V0LAogICAgICBkZXN0aW5hdGlvbjogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBvcGVuZGlyKGZpbGVwYXRoLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGRpcgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcub3BlbmRpcihyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICBhd2FpdCByZXEKCiAgICBkaXIgPSBuZXcgRGlyKGZpbGVwYXRoLCBiaW5kaW5nLnJlcXVlc3RSZXN1bHREaXIocmVxLmhhbmRsZSksIG9wdHMpCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnb3BlbmRpcicsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGRpciwgY2IpCn0KCmZ1bmN0aW9uIG9wZW5kaXJTeW5jKGZpbGVwYXRoLCBvcHRzKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5vcGVuZGlyU3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICByZXR1cm4gbmV3IERpcihmaWxlcGF0aCwgYmluZGluZy5yZXF1ZXN0UmVzdWx0RGlyKHJlcS5oYW5kbGUpLCBvcHRzKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ29wZW5kaXInLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcmVhZGRpcihmaWxlcGF0aCwgb3B0cywgY2IpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb3B0cwogICAgb3B0cyA9IHt9CiAgfQoKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBjb25zdCB7IHdpdGhGaWxlVHlwZXMgPSBmYWxzZSB9ID0gb3B0cwoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIGxldCByZXN1bHQgPSBbXQogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGNvbnN0IGRpciA9IGF3YWl0IG9wZW5kaXIoZmlsZXBhdGgpCgogICAgZm9yIGF3YWl0IChjb25zdCBlbnRyeSBvZiBkaXIpIHsKICAgICAgcmVzdWx0LnB1c2god2l0aEZpbGVUeXBlcyA/IGVudHJ5IDogZW50cnkubmFtZSkKICAgIH0KICB9IGNhdGNoIChlKSB7CiAgICByZXN1bHQgPSBbXQogICAgZXJyID0gZQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCByZXN1bHQsIGNiKQp9CgpmdW5jdGlvbiByZWFkZGlyU3luYyhmaWxlcGF0aCwgb3B0cykgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGNvbnN0IHsgd2l0aEZpbGVUeXBlcyA9IGZhbHNlIH0gPSBvcHRzCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgY29uc3QgZGlyID0gb3BlbmRpclN5bmMoZmlsZXBhdGgsIG9wdHMpCiAgY29uc3QgcmVzdWx0ID0gW10KCiAgZm9yIChjb25zdCBlbnRyeSBvZiBkaXIpIHsKICAgIHJlc3VsdC5wdXNoKHdpdGhGaWxlVHlwZXMgPyBlbnRyeSA6IGVudHJ5Lm5hbWUpCiAgfQoKICByZXR1cm4gcmVzdWx0Cn0KCmFzeW5jIGZ1bmN0aW9uIHJlYWRGaWxlKGZpbGVwYXRoLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGNvbnN0IHsgZW5jb2RpbmcgPSAnYnVmZmVyJyB9ID0gb3B0cwoKICBsZXQgZmQgPSAtMQogIGxldCBidWZmZXIgPSBudWxsCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgZmQgPSBhd2FpdCBvcGVuKGZpbGVwYXRoLCBvcHRzLmZsYWcgfHwgJ3InKQoKICAgIGNvbnN0IHN0ID0gYXdhaXQgZnN0YXQoZmQpCgogICAgbGV0IGxlbiA9IDAKCiAgICBpZiAoc3Quc2l6ZSA9PT0gMCkgewogICAgICBjb25zdCBidWZmZXJzID0gW10KCiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKDgxOTIpCiAgICAgICAgY29uc3QgciA9IGF3YWl0IHJlYWQoZmQsIGJ1ZmZlcikKICAgICAgICBsZW4gKz0gcgogICAgICAgIGlmIChyID09PSAwKSBicmVhawogICAgICAgIGJ1ZmZlcnMucHVzaChidWZmZXIuc3ViYXJyYXkoMCwgcikpCiAgICAgIH0KCiAgICAgIGJ1ZmZlciA9IEJ1ZmZlci5jb25jYXQoYnVmZmVycykKICAgIH0gZWxzZSB7CiAgICAgIGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShzdC5zaXplKQoKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBjb25zdCByID0gYXdhaXQgcmVhZChmZCwgbGVuID8gYnVmZmVyLnN1YmFycmF5KGxlbikgOiBidWZmZXIpCiAgICAgICAgbGVuICs9IHIKICAgICAgICBpZiAociA9PT0gMCB8fCBsZW4gPT09IGJ1ZmZlci5ieXRlTGVuZ3RoKSBicmVhawogICAgICB9CgogICAgICBpZiAobGVuICE9PSBidWZmZXIuYnl0ZUxlbmd0aCkgYnVmZmVyID0gYnVmZmVyLnN1YmFycmF5KDAsIGxlbikKICAgIH0KCiAgICBpZiAoZW5jb2RpbmcgIT09ICdidWZmZXInKSBidWZmZXIgPSBidWZmZXIudG9TdHJpbmcoZW5jb2RpbmcpCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gZQogIH0gZmluYWxseSB7CiAgICBpZiAoZmQgIT09IC0xKSBhd2FpdCBjbG9zZShmZCkKICB9CgogIHJldHVybiBkb25lKGVyciwgYnVmZmVyLCBjYikKfQoKZnVuY3Rpb24gcmVhZEZpbGVTeW5jKGZpbGVwYXRoLCBvcHRzKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgeyBlbmNvZGluZyA9ICdidWZmZXInIH0gPSBvcHRzCgogIGxldCBmZCA9IC0xCiAgdHJ5IHsKICAgIGZkID0gb3BlblN5bmMoZmlsZXBhdGgsIG9wdHMuZmxhZyB8fCAncicpCgogICAgY29uc3Qgc3QgPSBmc3RhdFN5bmMoZmQpCgogICAgbGV0IGJ1ZmZlcgogICAgbGV0IGxlbiA9IDAKCiAgICBpZiAoc3Quc2l6ZSA9PT0gMCkgewogICAgICBjb25zdCBidWZmZXJzID0gW10KCiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKDgxOTIpCiAgICAgICAgY29uc3QgciA9IHJlYWRTeW5jKGZkLCBidWZmZXIpCiAgICAgICAgbGVuICs9IHIKICAgICAgICBpZiAociA9PT0gMCkgYnJlYWsKICAgICAgICBidWZmZXJzLnB1c2goYnVmZmVyLnN1YmFycmF5KDAsIHIpKQogICAgICB9CgogICAgICBidWZmZXIgPSBCdWZmZXIuY29uY2F0KGJ1ZmZlcnMpCiAgICB9IGVsc2UgewogICAgICBidWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUoc3Quc2l6ZSkKCiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgY29uc3QgciA9IHJlYWRTeW5jKGZkLCBsZW4gPyBidWZmZXIuc3ViYXJyYXkobGVuKSA6IGJ1ZmZlcikKICAgICAgICBsZW4gKz0gcgogICAgICAgIGlmIChyID09PSAwIHx8IGxlbiA9PT0gYnVmZmVyLmJ5dGVMZW5ndGgpIGJyZWFrCiAgICAgIH0KCiAgICAgIGlmIChsZW4gIT09IGJ1ZmZlci5ieXRlTGVuZ3RoKSBidWZmZXIgPSBidWZmZXIuc3ViYXJyYXkoMCwgbGVuKQogICAgfQoKICAgIGlmIChlbmNvZGluZyAhPT0gJ2J1ZmZlcicpIGJ1ZmZlciA9IGJ1ZmZlci50b1N0cmluZyhlbmNvZGluZykKCiAgICByZXR1cm4gYnVmZmVyCiAgfSBmaW5hbGx5IHsKICAgIGlmIChmZCAhPT0gLTEpIGNsb3NlU3luYyhmZCkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHdyaXRlRmlsZShmaWxlcGF0aCwgZGF0YSwgb3B0cywgY2IpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb3B0cwogICAgb3B0cyA9IHt9CiAgfQoKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSBkYXRhID0gQnVmZmVyLmZyb20oZGF0YSwgb3B0cy5lbmNvZGluZykKCiAgbGV0IGZkID0gLTEKICBsZXQgbGVuID0gMAogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGZkID0gYXdhaXQgb3BlbihmaWxlcGF0aCwgb3B0cy5mbGFnIHx8ICd3Jywgb3B0cy5tb2RlIHx8IDBvNjY2KQoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGxlbiArPSBhd2FpdCB3cml0ZShmZCwgbGVuID8gZGF0YS5zdWJhcnJheShsZW4pIDogZGF0YSkKICAgICAgaWYgKGxlbiA9PT0gZGF0YS5ieXRlTGVuZ3RoKSBicmVhawogICAgfQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IGUKICB9IGZpbmFsbHkgewogICAgaWYgKGZkICE9PSAtMSkgYXdhaXQgY2xvc2UoZmQpCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGxlbiwgY2IpCn0KCmZ1bmN0aW9uIHdyaXRlRmlsZVN5bmMoZmlsZXBhdGgsIGRhdGEsIG9wdHMpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSBkYXRhID0gQnVmZmVyLmZyb20oZGF0YSwgb3B0cy5lbmNvZGluZykKCiAgbGV0IGZkID0gLTEKICB0cnkgewogICAgZmQgPSBvcGVuU3luYyhmaWxlcGF0aCwgb3B0cy5mbGFnIHx8ICd3Jywgb3B0cy5tb2RlIHx8IDBvNjY2KQoKICAgIGxldCBsZW4gPSAwCgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgbGVuICs9IHdyaXRlU3luYyhmZCwgbGVuID8gZGF0YS5zdWJhcnJheShsZW4pIDogZGF0YSkKICAgICAgaWYgKGxlbiA9PT0gZGF0YS5ieXRlTGVuZ3RoKSBicmVhawogICAgfQogIH0gZmluYWxseSB7CiAgICBpZiAoZmQgIT09IC0xKSBjbG9zZVN5bmMoZmQpCiAgfQp9CgpmdW5jdGlvbiBhcHBlbmRGaWxlKGZpbGVwYXRoLCBkYXRhLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGlmICghb3B0cy5mbGFnKSBvcHRzID0geyAuLi5vcHRzLCBmbGFnOiAnYScgfQoKICByZXR1cm4gd3JpdGVGaWxlKGZpbGVwYXRoLCBkYXRhLCBvcHRzLCBjYikKfQoKZnVuY3Rpb24gYXBwZW5kRmlsZVN5bmMoZmlsZXBhdGgsIGRhdGEsIG9wdHMpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBpZiAoIW9wdHMuZmxhZykgb3B0cyA9IHsgLi4ub3B0cywgZmxhZzogJ2EnIH0KCiAgcmV0dXJuIHdyaXRlRmlsZVN5bmMoZmlsZXBhdGgsIGRhdGEsIG9wdHMpCn0KCmZ1bmN0aW9uIHdhdGNoKGZpbGVwYXRoLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgcmV0dXJuIG5ldyBXYXRjaGVyKGZpbGVwYXRoLCBvcHRzLCBjYikKfQoKY2xhc3MgU3RhdHMgewogIGNvbnN0cnVjdG9yKAogICAgZGV2LAogICAgbW9kZSwKICAgIG5saW5rLAogICAgdWlkLAogICAgZ2lkLAogICAgcmRldiwKICAgIGJsa3NpemUsCiAgICBpbm8sCiAgICBzaXplLAogICAgYmxvY2tzLAogICAgYXRpbWVNcywKICAgIG10aW1lTXMsCiAgICBjdGltZU1zLAogICAgYmlydGh0aW1lTXMKICApIHsKICAgIHRoaXMuZGV2ID0gZGV2CiAgICB0aGlzLm1vZGUgPSBtb2RlCiAgICB0aGlzLm5saW5rID0gbmxpbmsKICAgIHRoaXMudWlkID0gdWlkCiAgICB0aGlzLmdpZCA9IGdpZAogICAgdGhpcy5yZGV2ID0gcmRldgogICAgdGhpcy5ibGtzaXplID0gYmxrc2l6ZQogICAgdGhpcy5pbm8gPSBpbm8KICAgIHRoaXMuc2l6ZSA9IHNpemUKICAgIHRoaXMuYmxvY2tzID0gYmxvY2tzCiAgICB0aGlzLmF0aW1lTXMgPSBhdGltZU1zCiAgICB0aGlzLm10aW1lTXMgPSBtdGltZU1zCiAgICB0aGlzLmN0aW1lTXMgPSBjdGltZU1zCiAgICB0aGlzLmJpcnRodGltZU1zID0gYmlydGh0aW1lTXMKICAgIHRoaXMuYXRpbWUgPSBuZXcgRGF0ZShhdGltZU1zKQogICAgdGhpcy5tdGltZSA9IG5ldyBEYXRlKG10aW1lTXMpCiAgICB0aGlzLmN0aW1lID0gbmV3IERhdGUoY3RpbWVNcykKICAgIHRoaXMuYmlydGh0aW1lID0gbmV3IERhdGUoYmlydGh0aW1lTXMpCiAgfQoKICBpc0RpcmVjdG9yeSgpIHsKICAgIHJldHVybiAodGhpcy5tb2RlICYgY29uc3RhbnRzLlNfSUZNVCkgPT09IGNvbnN0YW50cy5TX0lGRElSCiAgfQoKICBpc0ZpbGUoKSB7CiAgICByZXR1cm4gKHRoaXMubW9kZSAmIGNvbnN0YW50cy5TX0lGTVQpID09PSBjb25zdGFudHMuU19JRlJFRwogIH0KCiAgaXNCbG9ja0RldmljZSgpIHsKICAgIHJldHVybiAodGhpcy5tb2RlICYgY29uc3RhbnRzLlNfSUZNVCkgPT09IGNvbnN0YW50cy5TX0lGQkxLCiAgfQoKICBpc0NoYXJhY3RlckRldmljZSgpIHsKICAgIHJldHVybiAodGhpcy5tb2RlICYgY29uc3RhbnRzLlNfSUZDSFIpID09PSBjb25zdGFudHMuU19JRkNIUgogIH0KCiAgaXNGSUZPKCkgewogICAgcmV0dXJuICh0aGlzLm1vZGUgJiBjb25zdGFudHMuU19JRk1UKSA9PT0gY29uc3RhbnRzLlNfSUZJRk8KICB9CgogIGlzU3ltYm9saWNMaW5rKCkgewogICAgcmV0dXJuICh0aGlzLm1vZGUgJiBjb25zdGFudHMuU19JRk1UKSA9PT0gY29uc3RhbnRzLlNfSUZMTksKICB9CgogIGlzU29ja2V0KCkgewogICAgcmV0dXJuICh0aGlzLm1vZGUgJiBjb25zdGFudHMuU19JRk1UKSA9PT0gY29uc3RhbnRzLlNfSUZTT0NLCiAgfQp9CgpjbGFzcyBEaXIgewogIGNvbnN0cnVjdG9yKHBhdGgsIGhhbmRsZSwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IGVuY29kaW5nID0gJ3V0ZjgnLCBidWZmZXJTaXplID0gMzIgfSA9IG9wdHMKCiAgICB0aGlzLnBhdGggPSBwYXRoCgogICAgdGhpcy5fZW5jb2RpbmcgPSBlbmNvZGluZwogICAgdGhpcy5fY2FwYWNpdHkgPSBidWZmZXJTaXplCiAgICB0aGlzLl9idWZmZXIgPSBuZXcgRklGTygpCiAgICB0aGlzLl9lbmRlZCA9IGZhbHNlCiAgICB0aGlzLl9oYW5kbGUgPSBoYW5kbGUKICB9CgogIGFzeW5jIHJlYWQoY2IpIHsKICAgIGlmICh0aGlzLl9idWZmZXIubGVuZ3RoKSByZXR1cm4gb2sodGhpcy5fYnVmZmVyLnNoaWZ0KCksIGNiKQogICAgaWYgKHRoaXMuX2VuZGVkKSByZXR1cm4gb2sobnVsbCwgY2IpCgogICAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgICBsZXQgZW50cmllcwogICAgbGV0IGVyciA9IG51bGwKICAgIHRyeSB7CiAgICAgIHJlcS5yZXRhaW4oYmluZGluZy5yZWFkZGlyKHJlcS5oYW5kbGUsIHRoaXMuX2hhbmRsZSwgdGhpcy5fY2FwYWNpdHkpKQoKICAgICAgYXdhaXQgcmVxCgogICAgICBlbnRyaWVzID0gYmluZGluZy5yZXF1ZXN0UmVzdWx0RGlyZW50cyhyZXEuaGFuZGxlKQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICAgIG9wZXJhdGlvbjogJ3JlYWRkaXInLAogICAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgICBwYXRoOiB0aGlzLnBhdGgKICAgICAgfSkKICAgIH0KCiAgICBpZiAoZXJyKSByZXR1cm4gZmFpbChlcnIsIGNiKQoKICAgIGlmIChlbnRyaWVzLmxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLl9lbmRlZCA9IHRydWUKCiAgICAgIHJldHVybiBvayhudWxsLCBjYikKICAgIH0KCiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGVudHJpZXMpIHsKICAgICAgbGV0IG5hbWUgPSBCdWZmZXIuZnJvbShlbnRyeS5uYW1lKQoKICAgICAgaWYgKHRoaXMuX2VuY29kaW5nICE9PSAnYnVmZmVyJykgbmFtZSA9IG5hbWUudG9TdHJpbmcodGhpcy5fZW5jb2RpbmcpCgogICAgICB0aGlzLl9idWZmZXIucHVzaChuZXcgRGlyZW50KHRoaXMucGF0aCwgbmFtZSwgZW50cnkudHlwZSkpCiAgICB9CgogICAgcmV0dXJuIG9rKHRoaXMuX2J1ZmZlci5zaGlmdCgpLCBjYikKICB9CgogIHJlYWRTeW5jKCkgewogICAgaWYgKHRoaXMuX2J1ZmZlci5sZW5ndGgpIHJldHVybiB0aGlzLl9idWZmZXIuc2hpZnQoKQogICAgaWYgKHRoaXMuX2VuZGVkKSByZXR1cm4gbnVsbAoKICAgIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogICAgbGV0IGVudHJpZXMKICAgIHRyeSB7CiAgICAgIHJlcS5yZXRhaW4oYmluZGluZy5yZWFkZGlyU3luYyhyZXEuaGFuZGxlLCB0aGlzLl9oYW5kbGUsIHRoaXMuX2NhcGFjaXR5KSkKCiAgICAgIGVudHJpZXMgPSBiaW5kaW5nLnJlcXVlc3RSZXN1bHREaXJlbnRzKHJlcS5oYW5kbGUpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgICAgb3BlcmF0aW9uOiAncmVhZGRpcicsCiAgICAgICAgY29kZTogZS5jb2RlLAogICAgICAgIHBhdGg6IHRoaXMucGF0aAogICAgICB9KQogICAgfQoKICAgIGlmIChlbnRyaWVzLmxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLl9lbmRlZCA9IHRydWUKCiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgZm9yIChjb25zdCBlbnRyeSBvZiBlbnRyaWVzKSB7CiAgICAgIGxldCBuYW1lID0gQnVmZmVyLmZyb20oZW50cnkubmFtZSkKCiAgICAgIGlmICh0aGlzLl9lbmNvZGluZyAhPT0gJ2J1ZmZlcicpIG5hbWUgPSBuYW1lLnRvU3RyaW5nKHRoaXMuX2VuY29kaW5nKQoKICAgICAgdGhpcy5fYnVmZmVyLnB1c2gobmV3IERpcmVudCh0aGlzLnBhdGgsIG5hbWUsIGVudHJ5LnR5cGUpKQogICAgfQoKICAgIHJldHVybiB0aGlzLl9idWZmZXIuc2hpZnQoKQogIH0KCiAgYXN5bmMgY2xvc2UoY2IpIHsKICAgIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogICAgbGV0IGVyciA9IG51bGwKICAgIHRyeSB7CiAgICAgIGJpbmRpbmcuY2xvc2VkaXIocmVxLmhhbmRsZSwgdGhpcy5faGFuZGxlKQoKICAgICAgYXdhaXQgcmVxCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgICAgb3BlcmF0aW9uOiAnY2xvc2VkaXInLAogICAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgICBwYXRoOiB0aGlzLnBhdGgKICAgICAgfSkKICAgIH0KCiAgICB0aGlzLl9oYW5kbGUgPSBudWxsCgogICAgcmV0dXJuIGRvbmUoZXJyLCBjYikKICB9CgogIGNsb3NlU3luYygpIHsKICAgIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogICAgdHJ5IHsKICAgICAgYmluZGluZy5jbG9zZWRpclN5bmMocmVxLmhhbmRsZSwgdGhpcy5faGFuZGxlKQogICAgfSBjYXRjaCAoZSkgewogICAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICAgIG9wZXJhdGlvbjogJ2Nsb3NlZGlyJywKICAgICAgICBjb2RlOiBlLmNvZGUsCiAgICAgICAgcGF0aDogdGhpcy5wYXRoCiAgICAgIH0pCiAgICB9CgogICAgdGhpcy5faGFuZGxlID0gbnVsbAogIH0KCiAgW1N5bWJvbC5kaXNwb3NlXSgpIHsKICAgIHRoaXMuY2xvc2VTeW5jKCkKICB9CgogIGFzeW5jIFtTeW1ib2wuYXN5bmNEaXNwb3NlXSgpIHsKICAgIGF3YWl0IHRoaXMuY2xvc2UoKQogIH0KCiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgd2hpbGUgKHRydWUpIHsKICAgICAgY29uc3QgZW50cnkgPSB0aGlzLnJlYWRTeW5jKCkKICAgICAgaWYgKGVudHJ5ID09PSBudWxsKSBicmVhawogICAgICB5aWVsZCBlbnRyeQogICAgfQoKICAgIHRoaXMuY2xvc2VTeW5jKCkKICB9CgogIGFzeW5jICpbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgewogICAgd2hpbGUgKHRydWUpIHsKICAgICAgY29uc3QgZW50cnkgPSBhd2FpdCB0aGlzLnJlYWQoKQogICAgICBpZiAoZW50cnkgPT09IG51bGwpIGJyZWFrCiAgICAgIHlpZWxkIGVudHJ5CiAgICB9CgogICAgYXdhaXQgdGhpcy5jbG9zZSgpCiAgfQp9CgpjbGFzcyBEaXJlbnQgewogIGNvbnN0cnVjdG9yKHBhcmVudFBhdGgsIG5hbWUsIHR5cGUpIHsKICAgIHRoaXMucGFyZW50UGF0aCA9IHBhcmVudFBhdGgKICAgIHRoaXMubmFtZSA9IG5hbWUKICAgIHRoaXMudHlwZSA9IHR5cGUKICB9CgogIGlzRmlsZSgpIHsKICAgIHJldHVybiB0aGlzLnR5cGUgPT09IGNvbnN0YW50cy5VVl9ESVJFTlRfRklMRQogIH0KCiAgaXNEaXJlY3RvcnkoKSB7CiAgICByZXR1cm4gdGhpcy50eXBlID09PSBjb25zdGFudHMuVVZfRElSRU5UX0RJUgogIH0KCiAgaXNTeW1ib2xpY0xpbmsoKSB7CiAgICByZXR1cm4gdGhpcy50eXBlID09PSBjb25zdGFudHMuVVZfRElSRU5UX0xJTksKICB9CgogIGlzRklGTygpIHsKICAgIHJldHVybiB0aGlzLnR5cGUgPT09IGNvbnN0YW50cy5VVl9ESVJFTlRfRklGTwogIH0KCiAgaXNTb2NrZXQoKSB7CiAgICByZXR1cm4gdGhpcy50eXBlID09PSBjb25zdGFudHMuVVZfRElSRU5UX1NPQ0tFVAogIH0KCiAgaXNDaGFyYWN0ZXJEZXZpY2UoKSB7CiAgICByZXR1cm4gdGhpcy50eXBlID09PSBjb25zdGFudHMuVVZfRElSRU5UX0NIQVIKICB9CgogIGlzQmxvY2tEZXZpY2UoKSB7CiAgICByZXR1cm4gdGhpcy50eXBlID09PSBjb25zdGFudHMuVVZfRElSRU5UX0JMT0NLCiAgfQp9CgpjbGFzcyBGaWxlUmVhZFN0cmVhbSBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3RvcihwYXRoLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgZWFnZXJPcGVuID0gdHJ1ZSB9ID0gb3B0cwoKICAgIHN1cGVyKHsgZWFnZXJPcGVuLCAuLi5vcHRzIH0pCgogICAgdGhpcy5wYXRoID0gcGF0aAogICAgdGhpcy5mZCA9IHR5cGVvZiBvcHRzLmZkID09PSAnbnVtYmVyJyA/IG9wdHMuZmQgOiAtMQogICAgdGhpcy5mbGFncyA9IG9wdHMuZmxhZ3MgfHwgJ3InCiAgICB0aGlzLm1vZGUgPSBvcHRzLm1vZGUgfHwgMG82NjYKCiAgICB0aGlzLl9vZmZzZXQgPSBvcHRzLnN0YXJ0IHx8IDAKICAgIHRoaXMuX21pc3NpbmcgPSAwCgogICAgaWYgKG9wdHMubGVuZ3RoKSB7CiAgICAgIHRoaXMuX21pc3NpbmcgPSBvcHRzLmxlbmd0aAogICAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0cy5lbmQgPT09ICdudW1iZXInKSB7CiAgICAgIHRoaXMuX21pc3NpbmcgPSBvcHRzLmVuZCAtIHRoaXMuX29mZnNldCArIDEKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX21pc3NpbmcgPSAtMQogICAgfQogIH0KCiAgYXN5bmMgX29wZW4oY2IpIHsKICAgIGxldCBlcnIKCiAgICBpZiAodGhpcy5mZCA9PT0gLTEpIHsKICAgICAgZXJyID0gbnVsbAogICAgICB0cnkgewogICAgICAgIHRoaXMuZmQgPSBhd2FpdCBvcGVuKHRoaXMucGF0aCwgdGhpcy5mbGFncywgdGhpcy5tb2RlKQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZXJyID0gZQogICAgICB9CgogICAgICBpZiAoZXJyKSByZXR1cm4gY2IoZXJyKQogICAgfQoKICAgIGxldCBzdAogICAgZXJyID0gbnVsbAogICAgdHJ5IHsKICAgICAgc3QgPSBhd2FpdCBmc3RhdCh0aGlzLmZkKQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnIgPSBlCiAgICB9CgogICAgaWYgKGVycikgcmV0dXJuIGNiKGVycikKCiAgICBpZiAodGhpcy5fbWlzc2luZyA9PT0gLTEpIHRoaXMuX21pc3NpbmcgPSBzdC5zaXplCgogICAgaWYgKHN0LnNpemUgPCB0aGlzLl9vZmZzZXQpIHsKICAgICAgdGhpcy5fb2Zmc2V0ID0gc3Quc2l6ZQogICAgICB0aGlzLl9taXNzaW5nID0gMAogICAgfSBlbHNlIGlmIChzdC5zaXplIDwgdGhpcy5fb2Zmc2V0ICsgdGhpcy5fbWlzc2luZykgewogICAgICB0aGlzLl9taXNzaW5nID0gc3Quc2l6ZSAtIHRoaXMuX29mZnNldAogICAgfQoKICAgIGNiKG51bGwpCiAgfQoKICBhc3luYyBfcmVhZChzaXplKSB7CiAgICBpZiAodGhpcy5fbWlzc2luZyA8PSAwKSByZXR1cm4gdGhpcy5wdXNoKG51bGwpCgogICAgY29uc3QgZGF0YSA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShNYXRoLm1pbih0aGlzLl9taXNzaW5nLCBzaXplKSkKCiAgICBsZXQgbGVuCiAgICBsZXQgZXJyID0gbnVsbAogICAgdHJ5IHsKICAgICAgbGVuID0gYXdhaXQgcmVhZCh0aGlzLmZkLCBkYXRhLCAwLCBkYXRhLmJ5dGVMZW5ndGgsIHRoaXMuX29mZnNldCkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyID0gZQogICAgfQoKICAgIGlmIChlcnIpIHJldHVybiB0aGlzLmRlc3Ryb3koZXJyKQoKICAgIGlmIChsZW4gPT09IDApIHJldHVybiB0aGlzLnB1c2gobnVsbCkKCiAgICBpZiAodGhpcy5fbWlzc2luZyA8IGxlbikgbGVuID0gdGhpcy5fbWlzc2luZwoKICAgIHRoaXMuX21pc3NpbmcgLT0gbGVuCiAgICB0aGlzLl9vZmZzZXQgKz0gbGVuCgogICAgdGhpcy5wdXNoKGRhdGEuc3ViYXJyYXkoMCwgbGVuKSkKICB9CgogIGFzeW5jIF9kZXN0cm95KGVyciwgY2IpIHsKICAgIGlmICh0aGlzLmZkID09PSAtMSkgcmV0dXJuIGNiKGVycikKCiAgICBlcnIgPSBudWxsCiAgICB0cnkgewogICAgICBhd2FpdCBjbG9zZSh0aGlzLmZkKQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnIgPSBlCiAgICB9CgogICAgY2IoZXJyKQogIH0KfQoKY2xhc3MgRmlsZVdyaXRlU3RyZWFtIGV4dGVuZHMgV3JpdGFibGUgewogIGNvbnN0cnVjdG9yKHBhdGgsIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyBlYWdlck9wZW4gPSB0cnVlIH0gPSBvcHRzCgogICAgc3VwZXIoeyBlYWdlck9wZW4sIC4uLm9wdHMgfSkKCiAgICB0aGlzLnBhdGggPSBwYXRoCiAgICB0aGlzLmZkID0gdHlwZW9mIG9wdHMuZmQgPT09ICdudW1iZXInID8gb3B0cy5mZCA6IC0xCiAgICB0aGlzLmZsYWdzID0gb3B0cy5mbGFncyB8fCAndycKICAgIHRoaXMubW9kZSA9IG9wdHMubW9kZSB8fCAwbzY2NgogIH0KCiAgYXN5bmMgX29wZW4oY2IpIHsKICAgIGlmICh0aGlzLmZkICE9PSAtMSkgcmV0dXJuIGNiKG51bGwpCgogICAgbGV0IGVyciA9IG51bGwKICAgIHRyeSB7CiAgICAgIHRoaXMuZmQgPSBhd2FpdCBvcGVuKHRoaXMucGF0aCwgdGhpcy5mbGFncywgdGhpcy5tb2RlKQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnIgPSBlCiAgICB9CgogICAgY2IoZXJyKQogIH0KCiAgYXN5bmMgX3dyaXRldihiYXRjaCwgY2IpIHsKICAgIGxldCBlcnIgPSBudWxsCiAgICB0cnkgewogICAgICBhd2FpdCB3cml0ZXYoCiAgICAgICAgdGhpcy5mZCwKICAgICAgICBiYXRjaC5tYXAoKHsgY2h1bmsgfSkgPT4gY2h1bmspCiAgICAgICkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyID0gZQogICAgfQoKICAgIGNiKGVycikKICB9CgogIGFzeW5jIF9kZXN0cm95KGVyciwgY2IpIHsKICAgIGlmICh0aGlzLmZkID09PSAtMSkgcmV0dXJuIGNiKGVycikKCiAgICBlcnIgPSBudWxsCiAgICB0cnkgewogICAgICBhd2FpdCBjbG9zZSh0aGlzLmZkKQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnIgPSBlCiAgICB9CgogICAgY2IoZXJyKQogIH0KfQoKY2xhc3MgV2F0Y2hlciBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IocGF0aCwgb3B0cywgb25jaGFuZ2UpIHsKICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBvbmNoYW5nZSA9IG9wdHMKICAgICAgb3B0cyA9IHt9CiAgICB9CgogICAgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgICBjb25zdCB7IHBlcnNpc3RlbnQgPSB0cnVlLCByZWN1cnNpdmUgPSBmYWxzZSwgZW5jb2RpbmcgPSAndXRmOCcgfSA9IG9wdHMKCiAgICBzdXBlcigpCgogICAgdGhpcy5fY2xvc2VkID0gZmFsc2UKICAgIHRoaXMuX2VuY29kaW5nID0gZW5jb2RpbmcKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcud2F0Y2hlckluaXQocGF0aCwgcmVjdXJzaXZlLCB0aGlzLCB0aGlzLl9vbmV2ZW50LCB0aGlzLl9vbmNsb3NlKQoKICAgIGlmICghcGVyc2lzdGVudCkgdGhpcy51bnJlZigpCgogICAgaWYgKG9uY2hhbmdlKSB0aGlzLm9uKCdjaGFuZ2UnLCBvbmNoYW5nZSkKICB9CgogIGNsb3NlKCkgewogICAgaWYgKHRoaXMuX2Nsb3NlZCkgcmV0dXJuCiAgICB0aGlzLl9jbG9zZWQgPSB0cnVlCgogICAgYmluZGluZy53YXRjaGVyQ2xvc2UodGhpcy5faGFuZGxlKQogIH0KCiAgcmVmKCkgewogICAgaWYgKHRoaXMuX2hhbmRsZSkgYmluZGluZy53YXRjaGVyUmVmKHRoaXMuX2hhbmRsZSkKICAgIHJldHVybiB0aGlzCiAgfQoKICB1bnJlZigpIHsKICAgIGlmICh0aGlzLl9oYW5kbGUpIGJpbmRpbmcud2F0Y2hlclVucmVmKHRoaXMuX2hhbmRsZSkKICAgIHJldHVybiB0aGlzCiAgfQoKICBbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgewogICAgY29uc3QgYnVmZmVyID0gW10KICAgIGxldCBkb25lID0gZmFsc2UKICAgIGxldCBlcnJvciA9IG51bGwKICAgIGxldCBuZXh0ID0gbnVsbAoKICAgIHRoaXMub24oJ2NoYW5nZScsIChldmVudFR5cGUsIGZpbGVuYW1lKSA9PiB7CiAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgbmV4dC5yZXNvbHZlKHsgZG9uZTogZmFsc2UsIHZhbHVlOiB7IGV2ZW50VHlwZSwgZmlsZW5hbWUgfSB9KQogICAgICAgIG5leHQgPSBudWxsCiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnVmZmVyLnB1c2goeyBldmVudFR5cGUsIGZpbGVuYW1lIH0pCiAgICAgIH0KICAgIH0pCiAgICAgIC5vbignZXJyb3InLCAoZXJyKSA9PiB7CiAgICAgICAgZG9uZSA9IHRydWUKICAgICAgICBlcnJvciA9IGVycgoKICAgICAgICBpZiAobmV4dCkgewogICAgICAgICAgbmV4dC5yZWplY3QoZXJyb3IpCiAgICAgICAgICBuZXh0ID0gbnVsbAogICAgICAgIH0KICAgICAgfSkKICAgICAgLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgICBkb25lID0gdHJ1ZQoKICAgICAgICBpZiAobmV4dCkgewogICAgICAgICAgbmV4dC5yZXNvbHZlKHsgZG9uZSB9KQogICAgICAgICAgbmV4dCA9IG51bGwKICAgICAgICB9CiAgICAgIH0pCgogICAgcmV0dXJuIHsKICAgICAgbmV4dDogKCkgPT4KICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgICBpZiAoZXJyb3IpIHJldHVybiByZWplY3QoZXJyb3IpCgogICAgICAgICAgaWYgKGJ1ZmZlci5sZW5ndGgpIHJldHVybiByZXNvbHZlKHsgZG9uZTogZmFsc2UsIHZhbHVlOiBidWZmZXIuc2hpZnQoKSB9KQoKICAgICAgICAgIGlmIChkb25lKSByZXR1cm4gcmVzb2x2ZSh7IGRvbmUgfSkKCiAgICAgICAgICBuZXh0ID0geyByZXNvbHZlLCByZWplY3QgfQogICAgICAgIH0pCiAgICB9CiAgfQoKICBfb25ldmVudChlcnIsIGV2ZW50cywgZmlsZW5hbWUpIHsKICAgIGlmIChlcnIpIHsKICAgICAgdGhpcy5jbG9zZSgpCiAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlcnIpCiAgICB9IGVsc2UgewogICAgICBjb25zdCBwYXRoID0KICAgICAgICB0aGlzLl9lbmNvZGluZyA9PT0gJ2J1ZmZlcicKICAgICAgICAgID8gQnVmZmVyLmZyb20oZmlsZW5hbWUpCiAgICAgICAgICA6IEJ1ZmZlci5mcm9tKGZpbGVuYW1lKS50b1N0cmluZyh0aGlzLl9lbmNvZGluZykKCiAgICAgIGlmIChldmVudHMgJiBiaW5kaW5nLlVWX1JFTkFNRSkgewogICAgICAgIHRoaXMuZW1pdCgnY2hhbmdlJywgJ3JlbmFtZScsIHBhdGgpCiAgICAgIH0KCiAgICAgIGlmIChldmVudHMgJiBiaW5kaW5nLlVWX0NIQU5HRSkgewogICAgICAgIHRoaXMuZW1pdCgnY2hhbmdlJywgJ2NoYW5nZScsIHBhdGgpCiAgICAgIH0KICAgIH0KICB9CgogIF9vbmNsb3NlKCkgewogICAgdGhpcy5faGFuZGxlID0gbnVsbAoKICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogIH0KfQoKZXhwb3J0cy5hY2Nlc3MgPSBhY2Nlc3MKZXhwb3J0cy5hcHBlbmRGaWxlID0gYXBwZW5kRmlsZQpleHBvcnRzLmNobW9kID0gY2htb2QKLy8gZXhwb3J0cy5jaG93biA9IGNob3duIFRPRE8KZXhwb3J0cy5jbG9zZSA9IGNsb3NlCmV4cG9ydHMuY29weUZpbGUgPSBjb3B5RmlsZQpleHBvcnRzLmNwID0gY3AKZXhwb3J0cy5leGlzdHMgPSBleGlzdHMKZXhwb3J0cy5mY2htb2QgPSBmY2htb2QKLy8gZXhwb3J0cy5mY2hvd24gPSBmY2hvd24gVE9ETwovLyBleHBvcnRzLmZkYXRhc3luYyA9IGZkYXRhc3luYyBUT0RPCmV4cG9ydHMuZnN0YXQgPSBmc3RhdAovLyBleHBvcnRzLmZzeW5jID0gZnN5bmMgVE9ETwpleHBvcnRzLmZ0cnVuY2F0ZSA9IGZ0cnVuY2F0ZQovLyBleHBvcnRzLmZ1dGltZXMgPSBmdXRpbWVzIFRPRE8KLy8gZXhwb3J0cy5sY2htb2QgPSBsY2htb2QgVE9ETwovLyBleHBvcnRzLmxjaG93biA9IGxjaG93biBUT0RPCi8vIGV4cG9ydHMubHV0aW1lcyA9IGx1dGltZXMgVE9ETwovLyBleHBvcnRzLmxpbmsgPSBsaW5rIFRPRE8KZXhwb3J0cy5sc3RhdCA9IGxzdGF0CmV4cG9ydHMubWtkaXIgPSBta2RpcgovLyBleHBvcnRzLm1rZHRlbXAgPSBta2R0ZW1wIFRPRE8KZXhwb3J0cy5vcGVuID0gb3BlbgpleHBvcnRzLm9wZW5kaXIgPSBvcGVuZGlyCmV4cG9ydHMucmVhZCA9IHJlYWQKZXhwb3J0cy5yZWFkRmlsZSA9IHJlYWRGaWxlCmV4cG9ydHMucmVhZGRpciA9IHJlYWRkaXIKZXhwb3J0cy5yZWFkbGluayA9IHJlYWRsaW5rCmV4cG9ydHMucmVhZHYgPSByZWFkdgpleHBvcnRzLnJlYWxwYXRoID0gcmVhbHBhdGgKZXhwb3J0cy5yZW5hbWUgPSByZW5hbWUKZXhwb3J0cy5ybSA9IHJtCmV4cG9ydHMucm1kaXIgPSBybWRpcgpleHBvcnRzLnN0YXQgPSBzdGF0Ci8vIGV4cG9ydHMuc3RhdGZzID0gc3RhdGZzIFRPRE8KZXhwb3J0cy5zeW1saW5rID0gc3ltbGluawovLyBleHBvcnRzLnRydW5jYXRlID0gdHJ1bmNhdGUgVE9ETwpleHBvcnRzLnVubGluayA9IHVubGluawpleHBvcnRzLnV0aW1lcyA9IHV0aW1lcwpleHBvcnRzLndhdGNoID0gd2F0Y2gKZXhwb3J0cy53cml0ZSA9IHdyaXRlCmV4cG9ydHMud3JpdGVGaWxlID0gd3JpdGVGaWxlCmV4cG9ydHMud3JpdGV2ID0gd3JpdGV2CgpleHBvcnRzLmFjY2Vzc1N5bmMgPSBhY2Nlc3NTeW5jCmV4cG9ydHMuYXBwZW5kRmlsZVN5bmMgPSBhcHBlbmRGaWxlU3luYwpleHBvcnRzLmNobW9kU3luYyA9IGNobW9kU3luYwovLyBleHBvcnRzLmNob3duU3luYyA9IGNob3duU3luYyBUT0RPCmV4cG9ydHMuY2xvc2VTeW5jID0gY2xvc2VTeW5jCmV4cG9ydHMuY29weUZpbGVTeW5jID0gY29weUZpbGVTeW5jCmV4cG9ydHMuZXhpc3RzU3luYyA9IGV4aXN0c1N5bmMKZXhwb3J0cy5mY2htb2RTeW5jID0gZmNobW9kU3luYwovLyBleHBvcnRzLmZjaG93blN5bmMgPSBmY2hvd25TeW5jIFRPRE8KLy8gZXhwb3J0cy5mZGF0YXN5bmNTeW5jID0gZmRhdGFzeW5jU3luYyBUT0RPCmV4cG9ydHMuZnN0YXRTeW5jID0gZnN0YXRTeW5jCi8vIGV4cG9ydHMuZnN5bmNTeW5jID0gZnN5bmNTeW5jIFRPRE8KZXhwb3J0cy5mdHJ1bmNhdGVTeW5jID0gZnRydW5jYXRlU3luYwovLyBleHBvcnRzLmZ1dGltZXNTeW5jID0gZnV0aW1lc1N5bmMgVE9ETwovLyBleHBvcnRzLmxjaG1vZFN5bmMgPSBsY2htb2RTeW5jIFRPRE8KLy8gZXhwb3J0cy5sY2hvd25TeW5jID0gbGNob3duU3luYyBUT0RPCi8vIGV4cG9ydHMubHV0aW1lc1N5bmMgPSBsdXRpbWVzU3luYyBUT0RPCi8vIGV4cG9ydHMubGlua1N5bmMgPSBsaW5rU3luYyBUT0RPCmV4cG9ydHMubHN0YXRTeW5jID0gbHN0YXRTeW5jCmV4cG9ydHMubWtkaXJTeW5jID0gbWtkaXJTeW5jCi8vIGV4cG9ydHMubWtkdGVtcFN5bmMgPSBta2R0ZW1wU3luYyBUT0RPCmV4cG9ydHMub3BlblN5bmMgPSBvcGVuU3luYwpleHBvcnRzLm9wZW5kaXJTeW5jID0gb3BlbmRpclN5bmMKZXhwb3J0cy5yZWFkRmlsZVN5bmMgPSByZWFkRmlsZVN5bmMKZXhwb3J0cy5yZWFkU3luYyA9IHJlYWRTeW5jCmV4cG9ydHMucmVhZGRpclN5bmMgPSByZWFkZGlyU3luYwpleHBvcnRzLnJlYWRsaW5rU3luYyA9IHJlYWRsaW5rU3luYwpleHBvcnRzLnJlYWR2U3luYyA9IHJlYWR2U3luYwpleHBvcnRzLnJlYWxwYXRoU3luYyA9IHJlYWxwYXRoU3luYwpleHBvcnRzLnJlbmFtZVN5bmMgPSByZW5hbWVTeW5jCmV4cG9ydHMucm1TeW5jID0gcm1TeW5jCmV4cG9ydHMucm1kaXJTeW5jID0gcm1kaXJTeW5jCmV4cG9ydHMuc3RhdFN5bmMgPSBzdGF0U3luYwovLyBleHBvcnRzLnN0YXRmc1N5bmMgPSBzdGF0ZnNTeW5jIFRPRE8KZXhwb3J0cy5zeW1saW5rU3luYyA9IHN5bWxpbmtTeW5jCi8vIGV4cG9ydHMudHJ1bmNhdGVTeW5jID0gdHJ1bmNhdGVTeW5jIFRPRE8KZXhwb3J0cy51bmxpbmtTeW5jID0gdW5saW5rU3luYwpleHBvcnRzLnV0aW1lc1N5bmMgPSB1dGltZXNTeW5jCmV4cG9ydHMud3JpdGVGaWxlU3luYyA9IHdyaXRlRmlsZVN5bmMKZXhwb3J0cy53cml0ZVN5bmMgPSB3cml0ZVN5bmMKZXhwb3J0cy53cml0ZXZTeW5jID0gd3JpdGV2U3luYwoKZXhwb3J0cy5wcm9taXNlcyA9IHJlcXVpcmUoJy4vcHJvbWlzZXMnKQoKZXhwb3J0cy5TdGF0cyA9IFN0YXRzCmV4cG9ydHMuRGlyID0gRGlyCmV4cG9ydHMuRGlyZW50ID0gRGlyZW50CmV4cG9ydHMuV2F0Y2hlciA9IFdhdGNoZXIKCmV4cG9ydHMuUmVhZFN0cmVhbSA9IEZpbGVSZWFkU3RyZWFtCgpleHBvcnRzLmNyZWF0ZVJlYWRTdHJlYW0gPSBmdW5jdGlvbiBjcmVhdGVSZWFkU3RyZWFtKHBhdGgsIG9wdHMpIHsKICByZXR1cm4gbmV3IEZpbGVSZWFkU3RyZWFtKHBhdGgsIG9wdHMpCn0KCmV4cG9ydHMuV3JpdGVTdHJlYW0gPSBGaWxlV3JpdGVTdHJlYW0KCmV4cG9ydHMuY3JlYXRlV3JpdGVTdHJlYW0gPSBmdW5jdGlvbiBjcmVhdGVXcml0ZVN0cmVhbShwYXRoLCBvcHRzKSB7CiAgcmV0dXJuIG5ldyBGaWxlV3JpdGVTdHJlYW0ocGF0aCwgb3B0cykKfQoKZnVuY3Rpb24gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkgewogIGlmICh0eXBlb2YgZmlsZXBhdGggIT09ICdzdHJpbmcnKSB7CiAgICBpZiAoVVJMLmlzVVJMKGZpbGVwYXRoKSkgZmlsZXBhdGggPSBmaWxlVVJMVG9QYXRoKGZpbGVwYXRoKQogICAgZWxzZSBmaWxlcGF0aCA9IGZpbGVwYXRoLnRvU3RyaW5nKCkKICB9CgogIHJldHVybiBwYXRoLnRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCn0KCmZ1bmN0aW9uIHRvRmxhZ3MoZmxhZ3MpIHsKICBzd2l0Y2ggKGZsYWdzKSB7CiAgICBjYXNlICdyJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX1JET05MWQogICAgY2FzZSAncnMnOiAvLyBGYWxsIHRocm91Z2guCiAgICBjYXNlICdzcic6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19SRE9OTFkgfCBjb25zdGFudHMuT19TWU5DCiAgICBjYXNlICdyKyc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19SRFdSCiAgICBjYXNlICdycysnOiAvLyBGYWxsIHRocm91Z2guCiAgICBjYXNlICdzcisnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fUkRXUiB8IGNvbnN0YW50cy5PX1NZTkMKCiAgICBjYXNlICd3JzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX1RSVU5DIHwgY29uc3RhbnRzLk9fQ1JFQVQgfCBjb25zdGFudHMuT19XUk9OTFkKICAgIGNhc2UgJ3d4JzogLy8gRmFsbCB0aHJvdWdoLgogICAgY2FzZSAneHcnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fVFJVTkMgfCBjb25zdGFudHMuT19DUkVBVCB8IGNvbnN0YW50cy5PX1dST05MWSB8IGNvbnN0YW50cy5PX0VYQ0wKCiAgICBjYXNlICd3Kyc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19UUlVOQyB8IGNvbnN0YW50cy5PX0NSRUFUIHwgY29uc3RhbnRzLk9fUkRXUgogICAgY2FzZSAnd3grJzogLy8gRmFsbCB0aHJvdWdoLgogICAgY2FzZSAneHcrJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX1RSVU5DIHwgY29uc3RhbnRzLk9fQ1JFQVQgfCBjb25zdGFudHMuT19SRFdSIHwgY29uc3RhbnRzLk9fRVhDTAoKICAgIGNhc2UgJ2EnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fQVBQRU5EIHwgY29uc3RhbnRzLk9fQ1JFQVQgfCBjb25zdGFudHMuT19XUk9OTFkKICAgIGNhc2UgJ2F4JzogLy8gRmFsbCB0aHJvdWdoLgogICAgY2FzZSAneGEnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fQVBQRU5EIHwgY29uc3RhbnRzLk9fQ1JFQVQgfCBjb25zdGFudHMuT19XUk9OTFkgfCBjb25zdGFudHMuT19FWENMCiAgICBjYXNlICdhcyc6IC8vIEZhbGwgdGhyb3VnaC4KICAgIGNhc2UgJ3NhJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX0FQUEVORCB8IGNvbnN0YW50cy5PX0NSRUFUIHwgY29uc3RhbnRzLk9fV1JPTkxZIHwgY29uc3RhbnRzLk9fU1lOQwoKICAgIGNhc2UgJ2ErJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX0FQUEVORCB8IGNvbnN0YW50cy5PX0NSRUFUIHwgY29uc3RhbnRzLk9fUkRXUgogICAgY2FzZSAnYXgrJzogLy8gRmFsbCB0aHJvdWdoLgogICAgY2FzZSAneGErJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX0FQUEVORCB8IGNvbnN0YW50cy5PX0NSRUFUIHwgY29uc3RhbnRzLk9fUkRXUiB8IGNvbnN0YW50cy5PX0VYQ0wKICAgIGNhc2UgJ2FzKyc6IC8vIEZhbGwgdGhyb3VnaC4KICAgIGNhc2UgJ3NhKyc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19BUFBFTkQgfCBjb25zdGFudHMuT19DUkVBVCB8IGNvbnN0YW50cy5PX1JEV1IgfCBjb25zdGFudHMuT19TWU5DCiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gMAogIH0KfQoKZnVuY3Rpb24gdG9Nb2RlKG1vZGUpIHsKICByZXR1cm4gcGFyc2VJbnQobW9kZSwgOCkKfQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCgptb2R1bGUuZXhwb3J0cyA9IHsKICBPX1JEV1I6IGJpbmRpbmcuT19SRFdSLAogIE9fUkRPTkxZOiBiaW5kaW5nLk9fUkRPTkxZLAogIE9fV1JPTkxZOiBiaW5kaW5nLk9fV1JPTkxZLAogIE9fQ1JFQVQ6IGJpbmRpbmcuT19DUkVBVCwKICBPX1RSVU5DOiBiaW5kaW5nLk9fVFJVTkMsCiAgT19BUFBFTkQ6IGJpbmRpbmcuT19BUFBFTkQsCgogIEZfT0s6IGJpbmRpbmcuRl9PSyB8fCAwLAogIFJfT0s6IGJpbmRpbmcuUl9PSyB8fCAwLAogIFdfT0s6IGJpbmRpbmcuV19PSyB8fCAwLAogIFhfT0s6IGJpbmRpbmcuWF9PSyB8fCAwLAoKICBTX0lGTVQ6IGJpbmRpbmcuU19JRk1ULAogIFNfSUZSRUc6IGJpbmRpbmcuU19JRlJFRywKICBTX0lGRElSOiBiaW5kaW5nLlNfSUZESVIsCiAgU19JRkNIUjogYmluZGluZy5TX0lGQ0hSLAogIFNfSUZMTks6IGJpbmRpbmcuU19JRkxOSywKICBTX0lGQkxLOiBiaW5kaW5nLlNfSUZCTEsgfHwgMCwKICBTX0lGSUZPOiBiaW5kaW5nLlNfSUZJRk8gfHwgMCwKICBTX0lGU09DSzogYmluZGluZy5TX0lGU09DSyB8fCAwLAoKICBTX0lSVVNSOiBiaW5kaW5nLlNfSVJVU1IgfHwgMCwKICBTX0lXVVNSOiBiaW5kaW5nLlNfSVdVU1IgfHwgMCwKICBTX0lYVVNSOiBiaW5kaW5nLlNfSVhVU1IgfHwgMCwKICBTX0lSR1JQOiBiaW5kaW5nLlNfSVJHUlAgfHwgMCwKICBTX0lXR1JQOiBiaW5kaW5nLlNfSVdHUlAgfHwgMCwKICBTX0lYR1JQOiBiaW5kaW5nLlNfSVhHUlAgfHwgMCwKICBTX0lST1RIOiBiaW5kaW5nLlNfSVJPVEggfHwgMCwKICBTX0lXT1RIOiBiaW5kaW5nLlNfSVdPVEggfHwgMCwKICBTX0lYT1RIOiBiaW5kaW5nLlNfSVhPVEggfHwgMCwKCiAgVVZfRElSRU5UX1VOS05PV046IGJpbmRpbmcuVVZfRElSRU5UX1VOS05PV04sCiAgVVZfRElSRU5UX0ZJTEU6IGJpbmRpbmcuVVZfRElSRU5UX0ZJTEUsCiAgVVZfRElSRU5UX0RJUjogYmluZGluZy5VVl9ESVJFTlRfRElSLAogIFVWX0RJUkVOVF9MSU5LOiBiaW5kaW5nLlVWX0RJUkVOVF9MSU5LLAogIFVWX0RJUkVOVF9GSUZPOiBiaW5kaW5nLlVWX0RJUkVOVF9GSUZPLAogIFVWX0RJUkVOVF9TT0NLRVQ6IGJpbmRpbmcuVVZfRElSRU5UX1NPQ0tFVCwKICBVVl9ESVJFTlRfQ0hBUjogYmluZGluZy5VVl9ESVJFTlRfQ0hBUiwKICBVVl9ESVJFTlRfQkxPQ0s6IGJpbmRpbmcuVVZfRElSRU5UX0JMT0NLLAoKICBDT1BZRklMRV9FWENMOiBiaW5kaW5nLlVWX0ZTX0NPUFlGSUxFX0VYQ0wsCiAgQ09QWUZJTEVfRklDTE9ORTogYmluZGluZy5VVl9GU19DT1BZRklMRV9GSUNMT05FLAogIENPUFlGSUxFX0ZJQ0xPTkVfRk9SQ0U6IGJpbmRpbmcuVVZfRlNfQ09QWUZJTEVfRklDTE9ORV9GT1JDRSwKICBVVl9GU19TWU1MSU5LX0RJUjogYmluZGluZy5VVl9GU19TWU1MSU5LX0RJUiwKICBVVl9GU19TWU1MSU5LX0pVTkNUSU9OOiBiaW5kaW5nLlVWX0ZTX1NZTUxJTktfSlVOQ1RJT04KfQpjb25zdCBvcyA9IHJlcXVpcmUoJ2JhcmUtb3MnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBGaWxlRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobXNnLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgY29kZSwgb3BlcmF0aW9uID0gbnVsbCwgcGF0aCA9IG51bGwsIGRlc3RpbmF0aW9uID0gbnVsbCwgZmQgPSAtMSB9ID0gb3B0cwoKICAgIGlmIChvcGVyYXRpb24gIT09IG51bGwpIG1zZyArPSBkZXNjcmliZShvcGVyYXRpb24sIG9wdHMpCgogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWApCgogICAgdGhpcy5jb2RlID0gY29kZQoKICAgIGlmIChvcGVyYXRpb24gIT09IG51bGwpIHRoaXMub3BlcmF0aW9uID0gb3BlcmF0aW9uCiAgICBpZiAocGF0aCAhPT0gbnVsbCkgdGhpcy5wYXRoID0gcGF0aAogICAgaWYgKGRlc3RpbmF0aW9uICE9PSBudWxsKSB0aGlzLmRlc3RpbmF0aW9uID0gZGVzdGluYXRpb24KICAgIGlmIChmZCAhPT0gLTEpIHRoaXMuZmQgPSBmZAogIH0KCiAgZ2V0IG5hbWUoKSB7CiAgICByZXR1cm4gJ0ZpbGVFcnJvcicKICB9CgogIC8vIEZvciBOb2RlLmpzIGNvbXBhdGliaWxpdHkKICBnZXQgZXJybm8oKSB7CiAgICByZXR1cm4gb3MuY29uc3RhbnRzLmVycm5vc1t0aGlzLmNvZGVdCiAgfQoKICAvLyBGb3IgTm9kZS5qcyBjb21wYXRpYmlsaXR5CiAgZ2V0IHN5c2NhbGwoKSB7CiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb24KICB9CgogIC8vIEZvciBOb2RlLmpzIGNvbXBhdGliaWxpdHkKICBnZXQgZGVzdCgpIHsKICAgIHJldHVybiB0aGlzLmRlc3RpbmF0aW9uCiAgfQp9CgpmdW5jdGlvbiBkZXNjcmliZShvcGVyYXRpb24sIG9wdHMpIHsKICBjb25zdCB7IHBhdGggPSBudWxsLCBkZXN0aW5hdGlvbiA9IG51bGwsIGZkID0gLTEgfSA9IG9wdHMKCiAgbGV0IHJlc3VsdCA9IGAsICR7b3BlcmF0aW9ufWAKCiAgaWYgKHBhdGggIT09IG51bGwpIHsKICAgIHJlc3VsdCArPSBgICR7SlNPTi5zdHJpbmdpZnkocGF0aCl9YAoKICAgIGlmIChkZXN0aW5hdGlvbiAhPT0gbnVsbCkgewogICAgICByZXN1bHQgKz0gYCAtPiAke0pTT04uc3RyaW5naWZ5KGRlc3RpbmF0aW9uKX1gCiAgICB9CiAgfSBlbHNlIGlmIChmZCAhPT0gLTEpIHsKICAgIHJlc3VsdCArPSBgICR7ZmR9YAogIH0KCiAgcmV0dXJuIHJlc3VsdAp9CnsKICAibmFtZSI6ICJiYXJlLWZzIiwKICAidmVyc2lvbiI6ICI0LjUuMiIsCiAgImRlc2NyaXB0aW9uIjogIk5hdGl2ZSBmaWxlIHN5c3RlbSBvcGVyYXRpb25zIGZvciBKYXZhc2NyaXB0IiwKICAiZXhwb3J0cyI6IHsKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4iOiB7CiAgICAgICJ0eXBlcyI6ICIuL2luZGV4LmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2luZGV4LmpzIgogICAgfSwKICAgICIuL3Byb21pc2VzIjogewogICAgICAidHlwZXMiOiAiLi9wcm9taXNlcy5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9wcm9taXNlcy5qcyIKICAgIH0sCiAgICAiLi9jb25zdGFudHMiOiB7CiAgICAgICJ0eXBlcyI6ICIuL2xpYi9jb25zdGFudHMuZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vbGliL2NvbnN0YW50cy5qcyIKICAgIH0KICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiaW5kZXguZC50cyIsCiAgICAicHJvbWlzZXMuanMiLAogICAgInByb21pc2VzLmQudHMiLAogICAgImJpbmRpbmcuYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiLAogICAgImxpYiIsCiAgICAicHJlYnVpbGRzIgogIF0sCiAgImFkZG9uIjogdHJ1ZSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBiYXJlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1mcy5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLWZzL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1mcyNyZWFkbWUiLAogICJlbmdpbmVzIjogewogICAgImJhcmUiOiAiPj0xLjE2LjAiCiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtZXZlbnRzIjogIl4yLjUuNCIsCiAgICAiYmFyZS1wYXRoIjogIl4zLjAuMCIsCiAgICAiYmFyZS1zdHJlYW0iOiAiXjIuNi40IiwKICAgICJiYXJlLXVybCI6ICJeMi4yLjIiLAogICAgImZhc3QtZmlmbyI6ICJeMS4zLjIiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYnVmZmVyIjogIl4zLjAuMiIsCiAgICAiYmFyZS1jcnlwdG8iOiAiXjEuMTEuMiIsCiAgICAiYnJpdHRsZSI6ICJeMy4xLjEiLAogICAgImNtYWtlLWJhcmUiOiAiXjEuMS43IiwKICAgICJwcmV0dGllciI6ICJeMy40LjEiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1idWZmZXIiOiAiKiIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzTWV0YSI6IHsKICAgICJiYXJlLWJ1ZmZlciI6IHsKICAgICAgIm9wdGlvbmFsIjogdHJ1ZQogICAgfQogIH0KfQpjb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdiYXJlLWV2ZW50cycpCmNvbnN0IGZzID0gcmVxdWlyZSgnLicpCgpjbGFzcyBGaWxlSGFuZGxlIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvcihmZCkgewogICAgdGhpcy5mZCA9IGZkCiAgfQoKICBhc3luYyBjbG9zZSgpIHsKICAgIGF3YWl0IGZzLmNsb3NlKGZkKQoKICAgIHRoaXMuZmQgPSAtMQogICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgfQoKICBhc3luYyByZWFkKGJ1ZmZlciwgLi4uYXJncykgewogICAgcmV0dXJuIHsKICAgICAgYnl0ZXNSZWFkOiBhd2FpdCBmcy5yZWFkKHRoaXMuZmQsIGJ1ZmZlciwgLi4uYXJncyksCiAgICAgIGJ1ZmZlcgogICAgfQogIH0KCiAgYXN5bmMgcmVhZHYoYnVmZmVycywgLi4uYXJncykgewogICAgcmV0dXJuIHsKICAgICAgYnl0ZXNSZWFkOiBhd2FpdCBmcy5yZWFkdih0aGlzLmZkLCBidWZmZXJzLCAuLi5hcmdzKSwKICAgICAgYnVmZmVycwogICAgfQogIH0KCiAgYXN5bmMgd3JpdGUoYnVmZmVyLCAuLi5hcmdzKSB7CiAgICByZXR1cm4gewogICAgICBieXRlc1dyaXR0ZW46IGF3YWl0IGZzLndyaXRlKHRoaXMuZmQsIGJ1ZmZlciwgLi4uYXJncyksCiAgICAgIGJ1ZmZlcgogICAgfQogIH0KCiAgYXN5bmMgd3JpdGV2KGJ1ZmZlcnMsIC4uLmFyZ3MpIHsKICAgIHJldHVybiB7CiAgICAgIGJ5dGVzV3JpdHRlbjogYXdhaXQgZnMud3JpdGV2KHRoaXMuZmQsIGJ1ZmZlcnMsIC4uLmFyZ3MpLAogICAgICBidWZmZXJzCiAgICB9CiAgfQoKICBhc3luYyBzdGF0KCkgewogICAgcmV0dXJuIGZzLmZzdGF0KHRoaXMuZmQpCiAgfQoKICBhc3luYyBjaG1vZChtb2RlKSB7CiAgICBhd2FpdCBmcy5mY2htb2QodGhpcy5mZCwgbW9kZSkKICB9CgogIGNyZWF0ZVJlYWRTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIGZzLmNyZWF0ZVJlYWRTdHJlYW0obnVsbCwgeyAuLi5vcHRzLCBmZDogdGhpcy5mZCB9KQogIH0KCiAgY3JlYXRlV3JpdGVTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIGZzLmNyZWF0ZVdyaXRlU3RyZWFtKG51bGwsIHsgLi4ub3B0cywgZmQ6IHRoaXMuZmQgfSkKICB9CgogIGFzeW5jIFtTeW1ib2wuYXN5bmNEaXNwb3NlXSgpIHsKICAgIGF3YWl0IHRoaXMuY2xvc2UoKQogIH0KfQoKZXhwb3J0cy5vcGVuID0gYXN5bmMgZnVuY3Rpb24gb3BlbihmaWxlcGF0aCwgZmxhZ3MsIG1vZGUpIHsKICByZXR1cm4gbmV3IEZpbGVIYW5kbGUoYXdhaXQgZnMub3BlbihmaWxlcGF0aCwgZmxhZ3MsIG1vZGUpKQp9CgpleHBvcnRzLmFjY2VzcyA9IGZzLmFjY2VzcwpleHBvcnRzLmFwcGVuZEZpbGUgPSBmcy5hcHBlbmRGaWxlCmV4cG9ydHMuY2htb2QgPSBmcy5jaG1vZApleHBvcnRzLmNvbnN0YW50cyA9IGZzLmNvbnN0YW50cwpleHBvcnRzLmNvcHlGaWxlID0gZnMuY29weUZpbGUKZXhwb3J0cy5jcCA9IGZzLmNwCmV4cG9ydHMubHN0YXQgPSBmcy5sc3RhdApleHBvcnRzLm1rZGlyID0gZnMubWtkaXIKZXhwb3J0cy5vcGVuZGlyID0gZnMub3BlbmRpcgpleHBvcnRzLnJlYWRGaWxlID0gZnMucmVhZEZpbGUKZXhwb3J0cy5yZWFkZGlyID0gZnMucmVhZGRpcgpleHBvcnRzLnJlYWRsaW5rID0gZnMucmVhZGxpbmsKZXhwb3J0cy5yZWFscGF0aCA9IGZzLnJlYWxwYXRoCmV4cG9ydHMucmVuYW1lID0gZnMucmVuYW1lCmV4cG9ydHMucm0gPSBmcy5ybQpleHBvcnRzLnJtZGlyID0gZnMucm1kaXIKZXhwb3J0cy5zdGF0ID0gZnMuc3RhdApleHBvcnRzLnN5bWxpbmsgPSBmcy5zeW1saW5rCmV4cG9ydHMudW5saW5rID0gZnMudW5saW5rCmV4cG9ydHMudXRpbWVzID0gZnMudXRpbWVzCmV4cG9ydHMud2F0Y2ggPSBmcy53YXRjaApleHBvcnRzLndyaXRlRmlsZSA9IGZzLndyaXRlRmlsZQptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUuYWRkb24oKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi9iaW5kaW5nJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi9saWIvZXJyb3JzJykKY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9saWIvY29uc3RhbnRzJykKCmV4cG9ydHMuY29uc3RhbnRzID0gY29uc3RhbnRzCgpleHBvcnRzLkVPTCA9IGJpbmRpbmcucGxhdGZvcm0gPT09ICd3aW4zMicgPyAnXHJcbicgOiAnXG4nCgpleHBvcnRzLnBsYXRmb3JtID0gZnVuY3Rpb24gcGxhdGZvcm0oKSB7CiAgcmV0dXJuIGJpbmRpbmcucGxhdGZvcm0KfQoKZXhwb3J0cy5hcmNoID0gZnVuY3Rpb24gYXJjaCgpIHsKICByZXR1cm4gYmluZGluZy5hcmNoCn0KCmV4cG9ydHMudHlwZSA9IGJpbmRpbmcudHlwZQpleHBvcnRzLnZlcnNpb24gPSBiaW5kaW5nLnZlcnNpb24KZXhwb3J0cy5yZWxlYXNlID0gYmluZGluZy5yZWxlYXNlCmV4cG9ydHMubWFjaGluZSA9IGJpbmRpbmcubWFjaGluZQpleHBvcnRzLmV4ZWNQYXRoID0gYmluZGluZy5leGVjUGF0aApleHBvcnRzLnBpZCA9IGJpbmRpbmcucGlkCmV4cG9ydHMucHBpZCA9IGJpbmRpbmcucHBpZApleHBvcnRzLmN3ZCA9IGJpbmRpbmcuY3dkCmV4cG9ydHMuY2hkaXIgPSBiaW5kaW5nLmNoZGlyCmV4cG9ydHMudG1wZGlyID0gYmluZGluZy50bXBkaXIKZXhwb3J0cy5ob21lZGlyID0gYmluZGluZy5ob21lZGlyCmV4cG9ydHMuaG9zdG5hbWUgPSBiaW5kaW5nLmhvc3RuYW1lCmV4cG9ydHMudXNlckluZm8gPSBiaW5kaW5nLnVzZXJJbmZvCgpleHBvcnRzLmtpbGwgPSBmdW5jdGlvbiBraWxsKHBpZCwgc2lnbmFsID0gY29uc3RhbnRzLnNpZ25hbHMuU0lHVEVSTSkgewogIGlmICh0eXBlb2Ygc2lnbmFsID09PSAnc3RyaW5nJykgewogICAgaWYgKHNpZ25hbCBpbiBjb25zdGFudHMuc2lnbmFscyA9PT0gZmFsc2UpIHsKICAgICAgdGhyb3cgZXJyb3JzLlVOS05PV05fU0lHTkFMKCdVbmtub3duIHNpZ25hbDogJyArIHNpZ25hbCkKICAgIH0KCiAgICBzaWduYWwgPSBjb25zdGFudHMuc2lnbmFsc1tzaWduYWxdCiAgfQoKICBiaW5kaW5nLmtpbGwocGlkLCBzaWduYWwpCn0KCmV4cG9ydHMuZW5kaWFubmVzcyA9IGZ1bmN0aW9uIGVuZGlhbm5lc3MoKSB7CiAgcmV0dXJuIGJpbmRpbmcuaXNMaXR0bGVFbmRpYW4gPyAnTEUnIDogJ0JFJwp9CgpleHBvcnRzLmF2YWlsYWJsZVBhcmFsbGVsaXNtID0gYmluZGluZy5hdmFpbGFibGVQYXJhbGxlbGlzbQoKZXhwb3J0cy5jcHVVc2FnZSA9IGZ1bmN0aW9uIGNwdVVzYWdlKHByZXZpb3VzKSB7CiAgY29uc3QgY3VycmVudCA9IGJpbmRpbmcuY3B1VXNhZ2UoKQoKICBpZiAocHJldmlvdXMpIHsKICAgIHJldHVybiB7CiAgICAgIHVzZXI6IGN1cnJlbnQudXNlciAtIHByZXZpb3VzLnVzZXIsCiAgICAgIHN5c3RlbTogY3VycmVudC5zeXN0ZW0gLSBwcmV2aW91cy5zeXN0ZW0KICAgIH0KICB9CgogIHJldHVybiBjdXJyZW50Cn0KCmV4cG9ydHMudGhyZWFkQ3B1VXNhZ2UgPSBmdW5jdGlvbiB0aHJlYWRDcHVVc2FnZShwcmV2aW91cykgewogIGNvbnN0IGN1cnJlbnQgPSBiaW5kaW5nLnRocmVhZENwdVVzYWdlKCkKCiAgaWYgKHByZXZpb3VzKSB7CiAgICByZXR1cm4gewogICAgICB1c2VyOiBjdXJyZW50LnVzZXIgLSBwcmV2aW91cy51c2VyLAogICAgICBzeXN0ZW06IGN1cnJlbnQuc3lzdGVtIC0gcHJldmlvdXMuc3lzdGVtCiAgICB9CiAgfQoKICByZXR1cm4gY3VycmVudAp9CgpleHBvcnRzLnJlc291cmNlVXNhZ2UgPSBiaW5kaW5nLnJlc291cmNlVXNhZ2UKZXhwb3J0cy5tZW1vcnlVc2FnZSA9IGJpbmRpbmcubWVtb3J5VXNhZ2UKZXhwb3J0cy5mcmVlbWVtID0gYmluZGluZy5mcmVlbWVtCmV4cG9ydHMudG90YWxtZW0gPSBiaW5kaW5nLnRvdGFsbWVtCmV4cG9ydHMudXB0aW1lID0gYmluZGluZy51cHRpbWUKZXhwb3J0cy5sb2FkYXZnID0gYmluZGluZy5sb2FkYXZnCmV4cG9ydHMuY3B1cyA9IGJpbmRpbmcuY3B1cwoKZXhwb3J0cy5nZXRQcm9jZXNzVGl0bGUgPSBiaW5kaW5nLmdldFByb2Nlc3NUaXRsZQoKZXhwb3J0cy5zZXRQcm9jZXNzVGl0bGUgPSBmdW5jdGlvbiBzZXRQcm9jZXNzVGl0bGUodGl0bGUpIHsKICBpZiAodHlwZW9mIHRpdGxlICE9PSAnc3RyaW5nJykgdGl0bGUgPSB0aXRsZS50b1N0cmluZygpCgogIGlmICh0aXRsZS5sZW5ndGggPj0gMjU2KSB7CiAgICB0aHJvdyBlcnJvcnMuVElUTEVfT1ZFUkZMT1coJ1Byb2Nlc3MgdGl0bGUgaXMgdG9vIGxvbmcnKQogIH0KCiAgYmluZGluZy5zZXRQcm9jZXNzVGl0bGUodGl0bGUpCn0KCmV4cG9ydHMuZ2V0RW52S2V5cyA9IGJpbmRpbmcuZ2V0RW52S2V5cwpleHBvcnRzLmdldEVudiA9IGJpbmRpbmcuZ2V0RW52CmV4cG9ydHMuaGFzRW52ID0gYmluZGluZy5oYXNFbnYKZXhwb3J0cy5zZXRFbnYgPSBiaW5kaW5nLnNldEVudgpleHBvcnRzLnVuc2V0RW52ID0gYmluZGluZy51bnNldEVudgpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCgptb2R1bGUuZXhwb3J0cyA9IHsKICBzaWduYWxzOiBiaW5kaW5nLnNpZ25hbHMsCiAgZXJybm9zOiBiaW5kaW5nLmVycm5vcwp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgT1NFcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3Rvcihtc2csIGNvZGUsIGZuID0gT1NFcnJvcikgewogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWApCiAgICB0aGlzLmNvZGUgPSBjb2RlCgogICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIGZuKQogICAgfQogIH0KCiAgZ2V0IG5hbWUoKSB7CiAgICByZXR1cm4gJ09TRXJyb3InCiAgfQoKICBzdGF0aWMgVU5LTk9XTl9TSUdOQUwobXNnKSB7CiAgICByZXR1cm4gbmV3IE9TRXJyb3IobXNnLCAnVU5LTk9XTl9TSUdOQUwnLCBPU0Vycm9yLlVOS05PV05fU0lHTkFMKQogIH0KCiAgc3RhdGljIFRJVExFX09WRVJGTE9XKG1zZykgewogICAgcmV0dXJuIG5ldyBPU0Vycm9yKG1zZywgJ1RJVExFX09WRVJGTE9XJywgT1NFcnJvci5USVRMRV9PVkVSRkxPVykKICB9Cn0KewogICJuYW1lIjogImJhcmUtb3MiLAogICJ2ZXJzaW9uIjogIjMuNi4yIiwKICAiZGVzY3JpcHRpb24iOiAiT3BlcmF0aW5nIHN5c3RlbSB1dGlsaXRpZXMgZm9yIEphdmFzY3JpcHQiLAogICJleHBvcnRzIjogewogICAgIi4iOiB7CiAgICAgICJ0eXBlcyI6ICIuL2luZGV4LmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2luZGV4LmpzIgogICAgfSwKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4vY29uc3RhbnRzIjogIi4vbGliL2NvbnN0YW50cy5qcyIsCiAgICAiLi9lcnJvcnMiOiAiLi9saWIvZXJyb3JzLmpzIgogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJpbmRleC5kLnRzIiwKICAgICJiaW5kaW5nLmMiLAogICAgImJpbmRpbmcuanMiLAogICAgIkNNYWtlTGlzdHMudHh0IiwKICAgICJsaWIiLAogICAgInByZWJ1aWxkcyIKICBdLAogICJhZGRvbiI6IHRydWUsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYmFyZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtb3MuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1vcy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtb3MjcmVhZG1lIiwKICAiZW5naW5lcyI6IHsKICAgICJiYXJlIjogIj49MS4xNC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjEuMSIsCiAgICAiY21ha2UtYmFyZSI6ICJeMS4xLjYiLAogICAgInByZXR0aWVyIjogIl4zLjQuMiIsCiAgICAicHJldHRpZXItY29uZmlnLXN0YW5kYXJkIjogIl43LjAuMCIKICB9Cn0KLyogZ2xvYmFsIEJhcmUgKi8KCi8vIFRoaXMgZXhwb3J0IFNIT1VMRCBOT1QgYmUgc2hvcnRlbmVkIGluIGFueSB3YXkgYXMgaGF2aW5nIHRoZSBmdWxsCi8vIGBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoLi4uKWAgc3RhdGVtZW50IGlzIGNydWNpYWwgZm9yIHN5bnRoZXNpemluZwovLyBFU00gZXhwb3J0cy4KCmlmIChCYXJlLnBsYXRmb3JtID09PSAnd2luMzInKSB7CiAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCcuL2xpYi93aW4zMicpCn0gZWxzZSB7CiAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCcuL2xpYi9wb3NpeCcpCn0KbW9kdWxlLmV4cG9ydHMgPSB7CiAgQ0hBUl9VUFBFUkNBU0VfQTogMHg0MSwKICBDSEFSX0xPV0VSQ0FTRV9BOiAweDYxLAogIENIQVJfVVBQRVJDQVNFX1o6IDB4NWEsCiAgQ0hBUl9MT1dFUkNBU0VfWjogMHg3YSwKICBDSEFSX0RPVDogMHgyZSwKICBDSEFSX0ZPUldBUkRfU0xBU0g6IDB4MmYsCiAgQ0hBUl9CQUNLV0FSRF9TTEFTSDogMHg1YywKICBDSEFSX0NPTE9OOiAweDNhLAogIENIQVJfUVVFU1RJT05fTUFSSzogMHgzZgp9CmNvbnN0IG9zID0gcmVxdWlyZSgnYmFyZS1vcycpCgpjb25zdCB7IG5vcm1hbGl6ZVN0cmluZyB9ID0gcmVxdWlyZSgnLi9zaGFyZWQnKQpjb25zdCB7CiAgQ0hBUl9ET1QsCiAgQ0hBUl9GT1JXQVJEX1NMQVNICn0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgpmdW5jdGlvbiBpc1Bvc2l4UGF0aFNlcGFyYXRvciAoY29kZSkgewogIHJldHVybiBjb2RlID09PSBDSEFSX0ZPUldBUkRfU0xBU0gKfQoKZXhwb3J0cy53aW4zMiA9IHJlcXVpcmUoJy4vd2luMzInKQpleHBvcnRzLnBvc2l4ID0gZXhwb3J0cwoKZXhwb3J0cy5zZXAgPSAnLycKZXhwb3J0cy5kZWxpbWl0ZXIgPSAnOicKCmV4cG9ydHMucmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmUgKC4uLmFyZ3MpIHsKICBsZXQgcmVzb2x2ZWRQYXRoID0gJycKICBsZXQgcmVzb2x2ZWRBYnNvbHV0ZSA9IGZhbHNlCgogIGZvciAobGV0IGkgPSBhcmdzLmxlbmd0aCAtIDE7IGkgPj0gLTEgJiYgIXJlc29sdmVkQWJzb2x1dGU7IGktLSkgewogICAgY29uc3QgcGF0aCA9IGkgPj0gMCA/IGFyZ3NbaV0gOiBvcy5jd2QoKQoKICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkgewogICAgICBjb250aW51ZQogICAgfQoKICAgIHJlc29sdmVkUGF0aCA9IGAke3BhdGh9LyR7cmVzb2x2ZWRQYXRofWAKICAgIHJlc29sdmVkQWJzb2x1dGUgPSBwYXRoLmNoYXJDb2RlQXQoMCkgPT09IENIQVJfRk9SV0FSRF9TTEFTSAogIH0KCiAgcmVzb2x2ZWRQYXRoID0gbm9ybWFsaXplU3RyaW5nKHJlc29sdmVkUGF0aCwgIXJlc29sdmVkQWJzb2x1dGUsICcvJywgaXNQb3NpeFBhdGhTZXBhcmF0b3IpCgogIGlmIChyZXNvbHZlZEFic29sdXRlKSB7CiAgICByZXR1cm4gYC8ke3Jlc29sdmVkUGF0aH1gCiAgfQoKICByZXR1cm4gcmVzb2x2ZWRQYXRoLmxlbmd0aCA+IDAgPyByZXNvbHZlZFBhdGggOiAnLicKfQoKZXhwb3J0cy5ub3JtYWxpemUgPSBmdW5jdGlvbiBub3JtYWxpemUgKHBhdGgpIHsKICBpZiAocGF0aC5sZW5ndGggPT09IDApIHJldHVybiAnLicKCiAgY29uc3QgaXNBYnNvbHV0ZSA9IHBhdGguY2hhckNvZGVBdCgwKSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNICiAgY29uc3QgdHJhaWxpbmdTZXBhcmF0b3IgPSBwYXRoLmNoYXJDb2RlQXQocGF0aC5sZW5ndGggLSAxKSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNICgogIHBhdGggPSBub3JtYWxpemVTdHJpbmcocGF0aCwgIWlzQWJzb2x1dGUsICcvJywgaXNQb3NpeFBhdGhTZXBhcmF0b3IpCgogIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkgewogICAgaWYgKGlzQWJzb2x1dGUpIHJldHVybiAnLycKICAgIHJldHVybiB0cmFpbGluZ1NlcGFyYXRvciA/ICcuLycgOiAnLicKICB9CgogIGlmICh0cmFpbGluZ1NlcGFyYXRvcikgcGF0aCArPSAnLycKCiAgcmV0dXJuIGlzQWJzb2x1dGUgPyBgLyR7cGF0aH1gIDogcGF0aAp9CgpleHBvcnRzLmlzQWJzb2x1dGUgPSBmdW5jdGlvbiBpc0Fic29sdXRlIChwYXRoKSB7CiAgcmV0dXJuIHBhdGgubGVuZ3RoID4gMCAmJiBwYXRoLmNoYXJDb2RlQXQoMCkgPT09IENIQVJfRk9SV0FSRF9TTEFTSAp9CgpleHBvcnRzLmpvaW4gPSBmdW5jdGlvbiBqb2luICguLi5hcmdzKSB7CiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gJy4nCiAgbGV0IGpvaW5lZAogIGZvciAobGV0IGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7ICsraSkgewogICAgY29uc3QgYXJnID0gYXJnc1tpXQogICAgaWYgKGFyZy5sZW5ndGggPiAwKSB7CiAgICAgIGlmIChqb2luZWQgPT09IHVuZGVmaW5lZCkgam9pbmVkID0gYXJnCiAgICAgIGVsc2Ugam9pbmVkICs9IGAvJHthcmd9YAogICAgfQogIH0KICBpZiAoam9pbmVkID09PSB1bmRlZmluZWQpIHJldHVybiAnLicKICByZXR1cm4gZXhwb3J0cy5ub3JtYWxpemUoam9pbmVkKQp9CgpleHBvcnRzLnJlbGF0aXZlID0gZnVuY3Rpb24gcmVsYXRpdmUgKGZyb20sIHRvKSB7CiAgaWYgKGZyb20gPT09IHRvKSByZXR1cm4gJycKCiAgZnJvbSA9IGV4cG9ydHMucmVzb2x2ZShmcm9tKQogIHRvID0gZXhwb3J0cy5yZXNvbHZlKHRvKQoKICBpZiAoZnJvbSA9PT0gdG8pIHJldHVybiAnJwoKICBjb25zdCBmcm9tU3RhcnQgPSAxCiAgY29uc3QgZnJvbUVuZCA9IGZyb20ubGVuZ3RoCiAgY29uc3QgZnJvbUxlbiA9IGZyb21FbmQgLSBmcm9tU3RhcnQKICBjb25zdCB0b1N0YXJ0ID0gMQogIGNvbnN0IHRvTGVuID0gdG8ubGVuZ3RoIC0gdG9TdGFydAoKICBjb25zdCBsZW5ndGggPSAoZnJvbUxlbiA8IHRvTGVuID8gZnJvbUxlbiA6IHRvTGVuKQogIGxldCBsYXN0Q29tbW9uU2VwID0gLTEKICBsZXQgaSA9IDAKICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBmcm9tQ29kZSA9IGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQgKyBpKQogICAgaWYgKGZyb21Db2RlICE9PSB0by5jaGFyQ29kZUF0KHRvU3RhcnQgKyBpKSkgewogICAgICBicmVhawogICAgfSBlbHNlIGlmIChmcm9tQ29kZSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNIKSB7CiAgICAgIGxhc3RDb21tb25TZXAgPSBpCiAgICB9CiAgfQogIGlmIChpID09PSBsZW5ndGgpIHsKICAgIGlmICh0b0xlbiA+IGxlbmd0aCkgewogICAgICBpZiAodG8uY2hhckNvZGVBdCh0b1N0YXJ0ICsgaSkgPT09IENIQVJfRk9SV0FSRF9TTEFTSCkgewogICAgICAgIHJldHVybiB0by5zdWJzdHJpbmcodG9TdGFydCArIGkgKyAxKQogICAgICB9CiAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRvLnN1YnN0cmluZyh0b1N0YXJ0ICsgaSkKICAgICAgfQogICAgfSBlbHNlIGlmIChmcm9tTGVuID4gbGVuZ3RoKSB7CiAgICAgIGlmIChmcm9tLmNoYXJDb2RlQXQoZnJvbVN0YXJ0ICsgaSkgPT09IENIQVJfRk9SV0FSRF9TTEFTSCkgewogICAgICAgIGxhc3RDb21tb25TZXAgPSBpCiAgICAgIH0gZWxzZSBpZiAoaSA9PT0gMCkgewogICAgICAgIGxhc3RDb21tb25TZXAgPSAwCiAgICAgIH0KICAgIH0KICB9CgogIGxldCBvdXQgPSAnJwogIGZvciAoaSA9IGZyb21TdGFydCArIGxhc3RDb21tb25TZXAgKyAxOyBpIDw9IGZyb21FbmQ7ICsraSkgewogICAgaWYgKGkgPT09IGZyb21FbmQgfHwgZnJvbS5jaGFyQ29kZUF0KGkpID09PSBDSEFSX0ZPUldBUkRfU0xBU0gpIHsKICAgICAgb3V0ICs9IG91dC5sZW5ndGggPT09IDAgPyAnLi4nIDogJy8uLicKICAgIH0KICB9CgogIHJldHVybiBgJHtvdXR9JHt0by5zdWJzdHJpbmcodG9TdGFydCArIGxhc3RDb21tb25TZXApfWAKfQoKZXhwb3J0cy50b05hbWVzcGFjZWRQYXRoID0gZnVuY3Rpb24gdG9OYW1lc3BhY2VkUGF0aCAocGF0aCkgewogIHJldHVybiBwYXRoCn0KCmV4cG9ydHMuZGlybmFtZSA9IGZ1bmN0aW9uIGRpcm5hbWUgKHBhdGgpIHsKICBpZiAocGF0aC5sZW5ndGggPT09IDApIHJldHVybiAnLicKICBjb25zdCBoYXNSb290ID0gcGF0aC5jaGFyQ29kZUF0KDApID09PSBDSEFSX0ZPUldBUkRfU0xBU0gKICBsZXQgZW5kID0gLTEKICBsZXQgbWF0Y2hlZFNsYXNoID0gdHJ1ZQogIGZvciAobGV0IGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gMTsgLS1pKSB7CiAgICBpZiAocGF0aC5jaGFyQ29kZUF0KGkpID09PSBDSEFSX0ZPUldBUkRfU0xBU0gpIHsKICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICBlbmQgPSBpCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2UKICAgIH0KICB9CgogIGlmIChlbmQgPT09IC0xKSByZXR1cm4gaGFzUm9vdCA/ICcvJyA6ICcuJwogIGlmIChoYXNSb290ICYmIGVuZCA9PT0gMSkgcmV0dXJuICcvLycKICByZXR1cm4gcGF0aC5zdWJzdHJpbmcoMCwgZW5kKQp9CgpleHBvcnRzLmJhc2VuYW1lID0gZnVuY3Rpb24gYmFzZW5hbWUgKHBhdGgsIHN1ZmZpeCkgewogIGxldCBzdGFydCA9IDAKICBsZXQgZW5kID0gLTEKICBsZXQgbWF0Y2hlZFNsYXNoID0gdHJ1ZQoKICBpZiAoc3VmZml4ICE9PSB1bmRlZmluZWQgJiYgc3VmZml4Lmxlbmd0aCA+IDAgJiYgc3VmZml4Lmxlbmd0aCA8PSBwYXRoLmxlbmd0aCkgewogICAgaWYgKHN1ZmZpeCA9PT0gcGF0aCkgeyByZXR1cm4gJycgfQogICAgbGV0IGV4dElkeCA9IHN1ZmZpeC5sZW5ndGggLSAxCiAgICBsZXQgZmlyc3ROb25TbGFzaEVuZCA9IC0xCiAgICBmb3IgKGxldCBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICBjb25zdCBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpCiAgICAgIGlmIChjb2RlID09PSBDSEFSX0ZPUldBUkRfU0xBU0gpIHsKICAgICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgICAgc3RhcnQgPSBpICsgMQogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGZpcnN0Tm9uU2xhc2hFbmQgPT09IC0xKSB7CiAgICAgICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZQogICAgICAgICAgZmlyc3ROb25TbGFzaEVuZCA9IGkgKyAxCiAgICAgICAgfQogICAgICAgIGlmIChleHRJZHggPj0gMCkgewogICAgICAgICAgaWYgKGNvZGUgPT09IHN1ZmZpeC5jaGFyQ29kZUF0KGV4dElkeCkpIHsKICAgICAgICAgICAgaWYgKC0tZXh0SWR4ID09PSAtMSkgewogICAgICAgICAgICAgIGVuZCA9IGkKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXh0SWR4ID0gLTEKICAgICAgICAgICAgZW5kID0gZmlyc3ROb25TbGFzaEVuZAogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChzdGFydCA9PT0gZW5kKSBlbmQgPSBmaXJzdE5vblNsYXNoRW5kCiAgICBlbHNlIGlmIChlbmQgPT09IC0xKSBlbmQgPSBwYXRoLmxlbmd0aAogICAgcmV0dXJuIHBhdGguc3Vic3RyaW5nKHN0YXJ0LCBlbmQpCiAgfQoKICBmb3IgKGxldCBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgaWYgKHBhdGguY2hhckNvZGVBdChpKSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNIKSB7CiAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgc3RhcnQgPSBpICsgMQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZW5kID09PSAtMSkgewogICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZQogICAgICBlbmQgPSBpICsgMQogICAgfQogIH0KCiAgaWYgKGVuZCA9PT0gLTEpIHJldHVybiAnJwogIHJldHVybiBwYXRoLnN1YnN0cmluZyhzdGFydCwgZW5kKQp9CgpleHBvcnRzLmV4dG5hbWUgPSBmdW5jdGlvbiBleHRuYW1lIChwYXRoKSB7CiAgbGV0IHN0YXJ0RG90ID0gLTEKICBsZXQgc3RhcnRQYXJ0ID0gMAogIGxldCBlbmQgPSAtMQogIGxldCBtYXRjaGVkU2xhc2ggPSB0cnVlCiAgbGV0IHByZURvdFN0YXRlID0gMAogIGZvciAobGV0IGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICBjb25zdCBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpCiAgICBpZiAoY29kZSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNIKSB7CiAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgc3RhcnRQYXJ0ID0gaSArIDEKICAgICAgICBicmVhawogICAgICB9CiAgICAgIGNvbnRpbnVlCiAgICB9CiAgICBpZiAoZW5kID09PSAtMSkgewogICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZQogICAgICBlbmQgPSBpICsgMQogICAgfQogICAgaWYgKGNvZGUgPT09IENIQVJfRE9UKSB7CiAgICAgIGlmIChzdGFydERvdCA9PT0gLTEpIHN0YXJ0RG90ID0gaQogICAgICBlbHNlIGlmIChwcmVEb3RTdGF0ZSAhPT0gMSkgcHJlRG90U3RhdGUgPSAxCiAgICB9IGVsc2UgaWYgKHN0YXJ0RG90ICE9PSAtMSkgewogICAgICBwcmVEb3RTdGF0ZSA9IC0xCiAgICB9CiAgfQoKICBpZiAoc3RhcnREb3QgPT09IC0xIHx8IGVuZCA9PT0gLTEgfHwgcHJlRG90U3RhdGUgPT09IDAgfHwgKHByZURvdFN0YXRlID09PSAxICYmIHN0YXJ0RG90ID09PSBlbmQgLSAxICYmIHN0YXJ0RG90ID09PSBzdGFydFBhcnQgKyAxKSkgewogICAgcmV0dXJuICcnCiAgfQogIHJldHVybiBwYXRoLnN1YnN0cmluZyhzdGFydERvdCwgZW5kKQp9CmNvbnN0IHsKICBDSEFSX0RPVCwKICBDSEFSX0ZPUldBUkRfU0xBU0gKfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCmV4cG9ydHMubm9ybWFsaXplU3RyaW5nID0gZnVuY3Rpb24gbm9ybWFsaXplU3RyaW5nIChwYXRoLCBhbGxvd0Fib3ZlUm9vdCwgc2VwYXJhdG9yLCBpc1BhdGhTZXBhcmF0b3IpIHsKICBsZXQgcmVzID0gJycKICBsZXQgbGFzdFNlZ21lbnRMZW5ndGggPSAwCiAgbGV0IGxhc3RTbGFzaCA9IC0xCiAgbGV0IGRvdHMgPSAwCiAgbGV0IGNvZGUgPSAwCiAgZm9yIChsZXQgaSA9IDA7IGkgPD0gcGF0aC5sZW5ndGg7ICsraSkgewogICAgaWYgKGkgPCBwYXRoLmxlbmd0aCkgewogICAgICBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpCiAgICB9IGVsc2UgaWYgKGlzUGF0aFNlcGFyYXRvcihjb2RlKSkgewogICAgICBicmVhawogICAgfSBlbHNlIHsKICAgICAgY29kZSA9IENIQVJfRk9SV0FSRF9TTEFTSAogICAgfQoKICAgIGlmIChpc1BhdGhTZXBhcmF0b3IoY29kZSkpIHsKICAgICAgaWYgKGxhc3RTbGFzaCA9PT0gaSAtIDEgfHwgZG90cyA9PT0gMSkgOwogICAgICBlbHNlIGlmIChkb3RzID09PSAyKSB7CiAgICAgICAgaWYgKHJlcy5sZW5ndGggPCAyIHx8IGxhc3RTZWdtZW50TGVuZ3RoICE9PSAyIHx8IHJlcy5jaGFyQ29kZUF0KHJlcy5sZW5ndGggLSAxKSAhPT0gQ0hBUl9ET1QgfHwgcmVzLmNoYXJDb2RlQXQocmVzLmxlbmd0aCAtIDIpICE9PSBDSEFSX0RPVCkgewogICAgICAgICAgaWYgKHJlcy5sZW5ndGggPiAyKSB7CiAgICAgICAgICAgIGNvbnN0IGxhc3RTbGFzaEluZGV4ID0gcmVzLmxhc3RJbmRleE9mKHNlcGFyYXRvcikKICAgICAgICAgICAgaWYgKGxhc3RTbGFzaEluZGV4ID09PSAtMSkgewogICAgICAgICAgICAgIHJlcyA9ICcnCiAgICAgICAgICAgICAgbGFzdFNlZ21lbnRMZW5ndGggPSAwCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzID0gcmVzLnN1YnN0cmluZygwLCBsYXN0U2xhc2hJbmRleCkKICAgICAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9CiAgICAgICAgICAgICAgICByZXMubGVuZ3RoIC0gMSAtIHJlcy5sYXN0SW5kZXhPZihzZXBhcmF0b3IpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdFNsYXNoID0gaQogICAgICAgICAgICBkb3RzID0gMAogICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgfSBlbHNlIGlmIChyZXMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIHJlcyA9ICcnCiAgICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gMAogICAgICAgICAgICBsYXN0U2xhc2ggPSBpCiAgICAgICAgICAgIGRvdHMgPSAwCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChhbGxvd0Fib3ZlUm9vdCkgewogICAgICAgICAgcmVzICs9IHJlcy5sZW5ndGggPiAwID8gYCR7c2VwYXJhdG9yfS4uYCA6ICcuLicKICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gMgogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAocmVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHJlcyArPSBgJHtzZXBhcmF0b3J9JHtwYXRoLnN1YnN0cmluZyhsYXN0U2xhc2ggKyAxLCBpKX1gCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlcyA9IHBhdGguc3Vic3RyaW5nKGxhc3RTbGFzaCArIDEsIGkpCiAgICAgICAgfQogICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gaSAtIGxhc3RTbGFzaCAtIDEKICAgICAgfQogICAgICBsYXN0U2xhc2ggPSBpCiAgICAgIGRvdHMgPSAwCiAgICB9IGVsc2UgaWYgKGNvZGUgPT09IENIQVJfRE9UICYmIGRvdHMgIT09IC0xKSB7CiAgICAgICsrZG90cwogICAgfSBlbHNlIHsKICAgICAgZG90cyA9IC0xCiAgICB9CiAgfQogIHJldHVybiByZXMKfQpjb25zdCBvcyA9IHJlcXVpcmUoJ2JhcmUtb3MnKQoKY29uc3QgeyBub3JtYWxpemVTdHJpbmcgfSA9IHJlcXVpcmUoJy4vc2hhcmVkJykKY29uc3QgewogIENIQVJfVVBQRVJDQVNFX0EsCiAgQ0hBUl9MT1dFUkNBU0VfQSwKICBDSEFSX1VQUEVSQ0FTRV9aLAogIENIQVJfTE9XRVJDQVNFX1osCiAgQ0hBUl9ET1QsCiAgQ0hBUl9GT1JXQVJEX1NMQVNILAogIENIQVJfQkFDS1dBUkRfU0xBU0gsCiAgQ0hBUl9DT0xPTiwKICBDSEFSX1FVRVNUSU9OX01BUksKfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCmZ1bmN0aW9uIGlzV2luZG93c1BhdGhTZXBhcmF0b3IgKGNvZGUpIHsKICByZXR1cm4gY29kZSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNIIHx8IGNvZGUgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gKfQoKZnVuY3Rpb24gaXNXaW5kb3dzRGV2aWNlUm9vdCAoY29kZSkgewogIHJldHVybiAoY29kZSA+PSBDSEFSX1VQUEVSQ0FTRV9BICYmIGNvZGUgPD0gQ0hBUl9VUFBFUkNBU0VfWikgfHwKICAgICAgICAgKGNvZGUgPj0gQ0hBUl9MT1dFUkNBU0VfQSAmJiBjb2RlIDw9IENIQVJfTE9XRVJDQVNFX1opCn0KCmV4cG9ydHMucG9zaXggPSByZXF1aXJlKCcuL3Bvc2l4JykKZXhwb3J0cy53aW4zMiA9IGV4cG9ydHMKCmV4cG9ydHMuc2VwID0gJ1xcJwpleHBvcnRzLmRlbGltaXRlciA9ICc7JwoKZXhwb3J0cy5yZXNvbHZlID0gZnVuY3Rpb24gcmVzb2x2ZSAoLi4uYXJncykgewogIGxldCByZXNvbHZlZERldmljZSA9ICcnCiAgbGV0IHJlc29sdmVkVGFpbCA9ICcnCiAgbGV0IHJlc29sdmVkQWJzb2x1dGUgPSBmYWxzZQoKICBmb3IgKGxldCBpID0gYXJncy5sZW5ndGggLSAxOyBpID49IC0xOyBpLS0pIHsKICAgIGxldCBwYXRoCiAgICBpZiAoaSA+PSAwKSB7CiAgICAgIHBhdGggPSBhcmdzW2ldCgogICAgICBpZiAocGF0aC5sZW5ndGggPT09IDApIGNvbnRpbnVlCiAgICB9IGVsc2UgaWYgKHJlc29sdmVkRGV2aWNlLmxlbmd0aCA9PT0gMCkgewogICAgICBwYXRoID0gb3MuY3dkKCkKICAgIH0gZWxzZSB7CiAgICAgIHBhdGggPSBvcy5nZXRFbnYoYD0ke3Jlc29sdmVkRGV2aWNlfWApIHx8IG9zLmN3ZCgpCgogICAgICBpZiAocGF0aCA9PT0gdW5kZWZpbmVkIHx8IChwYXRoLnN1YnN0cmluZygwLCAyKS50b0xvd2VyQ2FzZSgpICE9PSByZXNvbHZlZERldmljZS50b0xvd2VyQ2FzZSgpICYmIHBhdGguY2hhckNvZGVBdCgyKSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkpIHsKICAgICAgICBwYXRoID0gYCR7cmVzb2x2ZWREZXZpY2V9XFxgCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBsZW4gPSBwYXRoLmxlbmd0aAogICAgbGV0IHJvb3RFbmQgPSAwCiAgICBsZXQgZGV2aWNlID0gJycKICAgIGxldCBpc0Fic29sdXRlID0gZmFsc2UKICAgIGNvbnN0IGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoMCkKCiAgICBpZiAobGVuID09PSAxKSB7CiAgICAgIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGNvZGUpKSB7CiAgICAgICAgcm9vdEVuZCA9IDEKICAgICAgICBpc0Fic29sdXRlID0gdHJ1ZQogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IoY29kZSkpIHsKICAgICAgaXNBYnNvbHV0ZSA9IHRydWUKCiAgICAgIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdCgxKSkpIHsKICAgICAgICBsZXQgaiA9IDIKICAgICAgICBsZXQgbGFzdCA9IGoKICAgICAgICB3aGlsZSAoaiA8IGxlbiAmJiAhaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaikpKSB7CiAgICAgICAgICBqKysKICAgICAgICB9CiAgICAgICAgaWYgKGogPCBsZW4gJiYgaiAhPT0gbGFzdCkgewogICAgICAgICAgY29uc3QgZmlyc3RQYXJ0ID0gcGF0aC5zdWJzdHJpbmcobGFzdCwgaikKICAgICAgICAgIGxhc3QgPSBqCiAgICAgICAgICB3aGlsZSAoaiA8IGxlbiAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChqKSkpIHsKICAgICAgICAgICAgaisrCiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaiA8IGxlbiAmJiBqICE9PSBsYXN0KSB7CiAgICAgICAgICAgIGxhc3QgPSBqCiAgICAgICAgICAgIHdoaWxlIChqIDwgbGVuICYmICFpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChqKSkpIHsKICAgICAgICAgICAgICBqKysKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaiA9PT0gbGVuIHx8IGogIT09IGxhc3QpIHsKICAgICAgICAgICAgICBkZXZpY2UgPSBgXFxcXCR7Zmlyc3RQYXJ0fVxcJHtwYXRoLnN1YnN0cmluZyhsYXN0LCBqKX1gCiAgICAgICAgICAgICAgcm9vdEVuZCA9IGoKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByb290RW5kID0gMQogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzV2luZG93c0RldmljZVJvb3QoY29kZSkgJiYgcGF0aC5jaGFyQ29kZUF0KDEpID09PSBDSEFSX0NPTE9OKSB7CiAgICAgIGRldmljZSA9IHBhdGguc3Vic3RyaW5nKDAsIDIpCiAgICAgIHJvb3RFbmQgPSAyCiAgICAgIGlmIChsZW4gPiAyICYmIGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KDIpKSkgewogICAgICAgIGlzQWJzb2x1dGUgPSB0cnVlCiAgICAgICAgcm9vdEVuZCA9IDMKICAgICAgfQogICAgfQoKICAgIGlmIChkZXZpY2UubGVuZ3RoID4gMCkgewogICAgICBpZiAocmVzb2x2ZWREZXZpY2UubGVuZ3RoID4gMCkgewogICAgICAgIGlmIChkZXZpY2UudG9Mb3dlckNhc2UoKSAhPT0gcmVzb2x2ZWREZXZpY2UudG9Mb3dlckNhc2UoKSkgeyBjb250aW51ZSB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzb2x2ZWREZXZpY2UgPSBkZXZpY2UKICAgICAgfQogICAgfQoKICAgIGlmIChyZXNvbHZlZEFic29sdXRlKSB7CiAgICAgIGlmIChyZXNvbHZlZERldmljZS5sZW5ndGggPiAwKSB7IGJyZWFrIH0KICAgIH0gZWxzZSB7CiAgICAgIHJlc29sdmVkVGFpbCA9IGAke3BhdGguc3Vic3RyaW5nKHJvb3RFbmQpfVxcJHtyZXNvbHZlZFRhaWx9YAogICAgICByZXNvbHZlZEFic29sdXRlID0gaXNBYnNvbHV0ZQogICAgICBpZiAoaXNBYnNvbHV0ZSAmJiByZXNvbHZlZERldmljZS5sZW5ndGggPiAwKSB7CiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQogIH0KCiAgcmVzb2x2ZWRUYWlsID0gbm9ybWFsaXplU3RyaW5nKHJlc29sdmVkVGFpbCwgIXJlc29sdmVkQWJzb2x1dGUsICdcXCcsIGlzV2luZG93c1BhdGhTZXBhcmF0b3IpCgogIHJldHVybiByZXNvbHZlZEFic29sdXRlID8gYCR7cmVzb2x2ZWREZXZpY2V9XFwke3Jlc29sdmVkVGFpbH1gIDogYCR7cmVzb2x2ZWREZXZpY2V9JHtyZXNvbHZlZFRhaWx9YCB8fCAnLicKfQoKZXhwb3J0cy5ub3JtYWxpemUgPSBmdW5jdGlvbiBub3JtYWxpemUgKHBhdGgpIHsKICBjb25zdCBsZW4gPSBwYXRoLmxlbmd0aAogIGlmIChsZW4gPT09IDApIHJldHVybiAnLicKICBsZXQgcm9vdEVuZCA9IDAKICBsZXQgZGV2aWNlCiAgbGV0IGlzQWJzb2x1dGUgPSBmYWxzZQogIGNvbnN0IGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoMCkKCiAgaWYgKGxlbiA9PT0gMSkgewogICAgcmV0dXJuIGNvZGUgPT09IENIQVJfRk9SV0FSRF9TTEFTSCA/ICdcXCcgOiBwYXRoCiAgfQoKICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihjb2RlKSkgewogICAgaXNBYnNvbHV0ZSA9IHRydWUKCiAgICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoMSkpKSB7CiAgICAgIGxldCBqID0gMgogICAgICBsZXQgbGFzdCA9IGoKICAgICAgd2hpbGUgKGogPCBsZW4gJiYgIWlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGopKSkgewogICAgICAgIGorKwogICAgICB9CiAgICAgIGlmIChqIDwgbGVuICYmIGogIT09IGxhc3QpIHsKICAgICAgICBjb25zdCBmaXJzdFBhcnQgPSBwYXRoLnN1YnN0cmluZyhsYXN0LCBqKQogICAgICAgIGxhc3QgPSBqCiAgICAgICAgd2hpbGUgKGogPCBsZW4gJiYgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaikpKSB7CiAgICAgICAgICBqKysKICAgICAgICB9CiAgICAgICAgaWYgKGogPCBsZW4gJiYgaiAhPT0gbGFzdCkgewogICAgICAgICAgbGFzdCA9IGoKICAgICAgICAgIHdoaWxlIChqIDwgbGVuICYmICFpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChqKSkpIHsKICAgICAgICAgICAgaisrCiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaiA9PT0gbGVuKSB7CiAgICAgICAgICAgIHJldHVybiBgXFxcXCR7Zmlyc3RQYXJ0fVxcJHtwYXRoLnN1YnN0cmluZyhsYXN0KX1cXGAKICAgICAgICAgIH0KICAgICAgICAgIGlmIChqICE9PSBsYXN0KSB7CiAgICAgICAgICAgIGRldmljZSA9IGBcXFxcJHtmaXJzdFBhcnR9XFwke3BhdGguc3Vic3RyaW5nKGxhc3QsIGopfWAKICAgICAgICAgICAgcm9vdEVuZCA9IGoKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJvb3RFbmQgPSAxCiAgICB9CiAgfSBlbHNlIGlmIChpc1dpbmRvd3NEZXZpY2VSb290KGNvZGUpICYmIHBhdGguY2hhckNvZGVBdCgxKSA9PT0gQ0hBUl9DT0xPTikgewogICAgZGV2aWNlID0gcGF0aC5zdWJzdHJpbmcoMCwgMikKICAgIHJvb3RFbmQgPSAyCiAgICBpZiAobGVuID4gMiAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdCgyKSkpIHsKICAgICAgaXNBYnNvbHV0ZSA9IHRydWUKICAgICAgcm9vdEVuZCA9IDMKICAgIH0KICB9CgogIGxldCB0YWlsID0gcm9vdEVuZCA8IGxlbiA/IG5vcm1hbGl6ZVN0cmluZyhwYXRoLnN1YnN0cmluZyhyb290RW5kKSwgIWlzQWJzb2x1dGUsICdcXCcsIGlzV2luZG93c1BhdGhTZXBhcmF0b3IpIDogJycKICBpZiAodGFpbC5sZW5ndGggPT09IDAgJiYgIWlzQWJzb2x1dGUpIHsKICAgIHRhaWwgPSAnLicKICB9CiAgaWYgKHRhaWwubGVuZ3RoID4gMCAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChsZW4gLSAxKSkpIHsKICAgIHRhaWwgKz0gJ1xcJwogIH0KICBpZiAoZGV2aWNlID09PSB1bmRlZmluZWQpIHsKICAgIHJldHVybiBpc0Fic29sdXRlID8gYFxcJHt0YWlsfWAgOiB0YWlsCiAgfQogIHJldHVybiBpc0Fic29sdXRlID8gYCR7ZGV2aWNlfVxcJHt0YWlsfWAgOiBgJHtkZXZpY2V9JHt0YWlsfWAKfQoKZXhwb3J0cy5pc0Fic29sdXRlID0gZnVuY3Rpb24gaXNBYnNvbHV0ZSAocGF0aCkgewogIGNvbnN0IGxlbiA9IHBhdGgubGVuZ3RoCiAgaWYgKGxlbiA9PT0gMCkgcmV0dXJuIGZhbHNlCgogIGNvbnN0IGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoMCkKCiAgcmV0dXJuIGlzV2luZG93c1BhdGhTZXBhcmF0b3IoY29kZSkgfHwgKGxlbiA+IDIgJiYgaXNXaW5kb3dzRGV2aWNlUm9vdChjb2RlKSAmJiBwYXRoLmNoYXJDb2RlQXQoMSkgPT09IENIQVJfQ09MT04gJiYgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoMikpKQp9CgpleHBvcnRzLmpvaW4gPSBmdW5jdGlvbiBqb2luICguLi5hcmdzKSB7CiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gJy4nCgogIGxldCBqb2luZWQKICBsZXQgZmlyc3RQYXJ0CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgKytpKSB7CiAgICBjb25zdCBhcmcgPSBhcmdzW2ldCiAgICBpZiAoYXJnLmxlbmd0aCA+IDApIHsKICAgICAgaWYgKGpvaW5lZCA9PT0gdW5kZWZpbmVkKSBqb2luZWQgPSBmaXJzdFBhcnQgPSBhcmcKICAgICAgZWxzZSBqb2luZWQgKz0gYFxcJHthcmd9YAogICAgfQogIH0KCiAgaWYgKGpvaW5lZCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gJy4nCgogIGxldCBuZWVkc1JlcGxhY2UgPSB0cnVlCiAgbGV0IHNsYXNoQ291bnQgPSAwCiAgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IoZmlyc3RQYXJ0LmNoYXJDb2RlQXQoMCkpKSB7CiAgICArK3NsYXNoQ291bnQKICAgIGNvbnN0IGZpcnN0TGVuID0gZmlyc3RQYXJ0Lmxlbmd0aAogICAgaWYgKGZpcnN0TGVuID4gMSAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGZpcnN0UGFydC5jaGFyQ29kZUF0KDEpKSkgewogICAgICArK3NsYXNoQ291bnQKICAgICAgaWYgKGZpcnN0TGVuID4gMikgewogICAgICAgIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGZpcnN0UGFydC5jaGFyQ29kZUF0KDIpKSkgewogICAgICAgICAgKytzbGFzaENvdW50CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5lZWRzUmVwbGFjZSA9IGZhbHNlCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGlmIChuZWVkc1JlcGxhY2UpIHsKICAgIHdoaWxlIChzbGFzaENvdW50IDwgam9pbmVkLmxlbmd0aCAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGpvaW5lZC5jaGFyQ29kZUF0KHNsYXNoQ291bnQpKSkgewogICAgICBzbGFzaENvdW50KysKICAgIH0KCiAgICBpZiAoc2xhc2hDb3VudCA+PSAyKSB7CiAgICAgIGpvaW5lZCA9IGBcXCR7am9pbmVkLnN1YnN0cmluZyhzbGFzaENvdW50KX1gCiAgICB9CiAgfQoKICByZXR1cm4gZXhwb3J0cy5ub3JtYWxpemUoam9pbmVkKQp9CgpleHBvcnRzLnJlbGF0aXZlID0gZnVuY3Rpb24gcmVsYXRpdmUgKGZyb20sIHRvKSB7CiAgaWYgKGZyb20gPT09IHRvKSByZXR1cm4gJycKCiAgY29uc3QgZnJvbU9yaWcgPSBleHBvcnRzLnJlc29sdmUoZnJvbSkKICBjb25zdCB0b09yaWcgPSBleHBvcnRzLnJlc29sdmUodG8pCgogIGlmIChmcm9tT3JpZyA9PT0gdG9PcmlnKSByZXR1cm4gJycKCiAgZnJvbSA9IGZyb21PcmlnLnRvTG93ZXJDYXNlKCkKICB0byA9IHRvT3JpZy50b0xvd2VyQ2FzZSgpCgogIGlmIChmcm9tID09PSB0bykgcmV0dXJuICcnCgogIGxldCBmcm9tU3RhcnQgPSAwCiAgd2hpbGUgKGZyb21TdGFydCA8IGZyb20ubGVuZ3RoICYmIGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICBmcm9tU3RhcnQrKwogIH0KICBsZXQgZnJvbUVuZCA9IGZyb20ubGVuZ3RoCiAgd2hpbGUgKGZyb21FbmQgLSAxID4gZnJvbVN0YXJ0ICYmIGZyb20uY2hhckNvZGVBdChmcm9tRW5kIC0gMSkgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpIHsKICAgIGZyb21FbmQtLQogIH0KICBjb25zdCBmcm9tTGVuID0gZnJvbUVuZCAtIGZyb21TdGFydAoKICBsZXQgdG9TdGFydCA9IDAKICB3aGlsZSAodG9TdGFydCA8IHRvLmxlbmd0aCAmJiB0by5jaGFyQ29kZUF0KHRvU3RhcnQpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICB0b1N0YXJ0KysKICB9CiAgbGV0IHRvRW5kID0gdG8ubGVuZ3RoCiAgd2hpbGUgKHRvRW5kIC0gMSA+IHRvU3RhcnQgJiYgdG8uY2hhckNvZGVBdCh0b0VuZCAtIDEpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICB0b0VuZC0tCiAgfQogIGNvbnN0IHRvTGVuID0gdG9FbmQgLSB0b1N0YXJ0CgogIGNvbnN0IGxlbmd0aCA9IGZyb21MZW4gPCB0b0xlbiA/IGZyb21MZW4gOiB0b0xlbgogIGxldCBsYXN0Q29tbW9uU2VwID0gLTEKICBsZXQgaSA9IDAKICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBmcm9tQ29kZSA9IGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQgKyBpKQogICAgaWYgKGZyb21Db2RlICE9PSB0by5jaGFyQ29kZUF0KHRvU3RhcnQgKyBpKSkgewogICAgICBicmVhawogICAgfSBlbHNlIGlmIChmcm9tQ29kZSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkgewogICAgICBsYXN0Q29tbW9uU2VwID0gaQogICAgfQogIH0KCiAgaWYgKGkgIT09IGxlbmd0aCkgewogICAgaWYgKGxhc3RDb21tb25TZXAgPT09IC0xKSByZXR1cm4gdG9PcmlnCiAgfSBlbHNlIHsKICAgIGlmICh0b0xlbiA+IGxlbmd0aCkgewogICAgICBpZiAodG8uY2hhckNvZGVBdCh0b1N0YXJ0ICsgaSkgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpIHsKICAgICAgICByZXR1cm4gdG9PcmlnLnN1YnN0cmluZyh0b1N0YXJ0ICsgaSArIDEpCiAgICAgIH0KICAgICAgaWYgKGkgPT09IDIpIHsKICAgICAgICByZXR1cm4gdG9PcmlnLnN1YnN0cmluZyh0b1N0YXJ0ICsgaSkKICAgICAgfQogICAgfQogICAgaWYgKGZyb21MZW4gPiBsZW5ndGgpIHsKICAgICAgaWYgKGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQgKyBpKSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkgewogICAgICAgIGxhc3RDb21tb25TZXAgPSBpCiAgICAgIH0gZWxzZSBpZiAoaSA9PT0gMikgewogICAgICAgIGxhc3RDb21tb25TZXAgPSAzCiAgICAgIH0KICAgIH0KICAgIGlmIChsYXN0Q29tbW9uU2VwID09PSAtMSkgbGFzdENvbW1vblNlcCA9IDAKICB9CgogIGxldCBvdXQgPSAnJwogIGZvciAoaSA9IGZyb21TdGFydCArIGxhc3RDb21tb25TZXAgKyAxOyBpIDw9IGZyb21FbmQ7ICsraSkgewogICAgaWYgKGkgPT09IGZyb21FbmQgfHwgZnJvbS5jaGFyQ29kZUF0KGkpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICAgIG91dCArPSBvdXQubGVuZ3RoID09PSAwID8gJy4uJyA6ICdcXC4uJwogICAgfQogIH0KCiAgdG9TdGFydCArPSBsYXN0Q29tbW9uU2VwCgogIGlmIChvdXQubGVuZ3RoID4gMCkgewogICAgcmV0dXJuIGAke291dH0ke3RvT3JpZy5zdWJzdHJpbmcodG9TdGFydCwgdG9FbmQpfWAKICB9CiAgaWYgKHRvT3JpZy5jaGFyQ29kZUF0KHRvU3RhcnQpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICArK3RvU3RhcnQKICB9CiAgcmV0dXJuIHRvT3JpZy5zdWJzdHJpbmcodG9TdGFydCwgdG9FbmQpCn0KCmV4cG9ydHMudG9OYW1lc3BhY2VkUGF0aCA9IGZ1bmN0aW9uIHRvTmFtZXNwYWNlZFBhdGggKHBhdGgpIHsKICBpZiAocGF0aC5sZW5ndGggPT09IDApIHJldHVybiBwYXRoCgogIGNvbnN0IHJlc29sdmVkUGF0aCA9IGV4cG9ydHMucmVzb2x2ZShwYXRoKQoKICBpZiAocmVzb2x2ZWRQYXRoLmxlbmd0aCA8PSAyKSByZXR1cm4gcGF0aAoKICBpZiAocmVzb2x2ZWRQYXRoLmNoYXJDb2RlQXQoMCkgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpIHsKICAgIGlmIChyZXNvbHZlZFBhdGguY2hhckNvZGVBdCgxKSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkgewogICAgICBjb25zdCBjb2RlID0gcmVzb2x2ZWRQYXRoLmNoYXJDb2RlQXQoMikKICAgICAgaWYgKGNvZGUgIT09IENIQVJfUVVFU1RJT05fTUFSSyAmJiBjb2RlICE9PSBDSEFSX0RPVCkgewogICAgICAgIHJldHVybiBgXFxcXD9cXFVOQ1xcJHtyZXNvbHZlZFBhdGguc3Vic3RyaW5nKDIpfWAKICAgICAgfQogICAgfQogIH0gZWxzZSBpZiAoCiAgICBpc1dpbmRvd3NEZXZpY2VSb290KHJlc29sdmVkUGF0aC5jaGFyQ29kZUF0KDApKSAmJgogICAgICByZXNvbHZlZFBhdGguY2hhckNvZGVBdCgxKSA9PT0gQ0hBUl9DT0xPTiAmJgogICAgICByZXNvbHZlZFBhdGguY2hhckNvZGVBdCgyKSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSAogICkgewogICAgcmV0dXJuIGBcXFxcP1xcJHtyZXNvbHZlZFBhdGh9YAogIH0KCiAgcmV0dXJuIHBhdGgKfQoKZXhwb3J0cy5kaXJuYW1lID0gZnVuY3Rpb24gZGlybmFtZSAocGF0aCkgewogIGNvbnN0IGxlbiA9IHBhdGgubGVuZ3RoCiAgaWYgKGxlbiA9PT0gMCkgcmV0dXJuICcuJwogIGxldCByb290RW5kID0gLTEKICBsZXQgb2Zmc2V0ID0gMAogIGNvbnN0IGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoMCkKCiAgaWYgKGxlbiA9PT0gMSkgewogICAgcmV0dXJuIGlzV2luZG93c1BhdGhTZXBhcmF0b3IoY29kZSkgPyBwYXRoIDogJy4nCiAgfQoKICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihjb2RlKSkgewogICAgcm9vdEVuZCA9IG9mZnNldCA9IDEKCiAgICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoMSkpKSB7CiAgICAgIGxldCBqID0gMgogICAgICBsZXQgbGFzdCA9IGoKICAgICAgd2hpbGUgKGogPCBsZW4gJiYgIWlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGopKSkgewogICAgICAgIGorKwogICAgICB9CiAgICAgIGlmIChqIDwgbGVuICYmIGogIT09IGxhc3QpIHsKICAgICAgICBsYXN0ID0gagogICAgICAgIHdoaWxlIChqIDwgbGVuICYmIGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGopKSkgewogICAgICAgICAgaisrCiAgICAgICAgfQogICAgICAgIGlmIChqIDwgbGVuICYmIGogIT09IGxhc3QpIHsKICAgICAgICAgIGxhc3QgPSBqCiAgICAgICAgICB3aGlsZSAoaiA8IGxlbiAmJiAhaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaikpKSB7CiAgICAgICAgICAgIGorKwogICAgICAgICAgfQogICAgICAgICAgaWYgKGogPT09IGxlbikgewogICAgICAgICAgICByZXR1cm4gcGF0aAogICAgICAgICAgfQogICAgICAgICAgaWYgKGogIT09IGxhc3QpIHsKICAgICAgICAgICAgcm9vdEVuZCA9IG9mZnNldCA9IGogKyAxCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSBlbHNlIGlmIChpc1dpbmRvd3NEZXZpY2VSb290KGNvZGUpICYmIHBhdGguY2hhckNvZGVBdCgxKSA9PT0gQ0hBUl9DT0xPTikgewogICAgcm9vdEVuZCA9IGxlbiA+IDIgJiYgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoMikpID8gMyA6IDIKICAgIG9mZnNldCA9IHJvb3RFbmQKICB9CgogIGxldCBlbmQgPSAtMQogIGxldCBtYXRjaGVkU2xhc2ggPSB0cnVlCiAgZm9yIChsZXQgaSA9IGxlbiAtIDE7IGkgPj0gb2Zmc2V0OyAtLWkpIHsKICAgIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChpKSkpIHsKICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICBlbmQgPSBpCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2UKICAgIH0KICB9CgogIGlmIChlbmQgPT09IC0xKSB7CiAgICBpZiAocm9vdEVuZCA9PT0gLTEpIHJldHVybiAnLicKCiAgICBlbmQgPSByb290RW5kCiAgfQogIHJldHVybiBwYXRoLnN1YnN0cmluZygwLCBlbmQpCn0KCmV4cG9ydHMuYmFzZW5hbWUgPSBmdW5jdGlvbiBiYXNlbmFtZSAocGF0aCwgc3VmZml4KSB7CiAgbGV0IHN0YXJ0ID0gMAogIGxldCBlbmQgPSAtMQogIGxldCBtYXRjaGVkU2xhc2ggPSB0cnVlCgogIGlmIChwYXRoLmxlbmd0aCA+PSAyICYmIGlzV2luZG93c0RldmljZVJvb3QocGF0aC5jaGFyQ29kZUF0KDApKSAmJiBwYXRoLmNoYXJDb2RlQXQoMSkgPT09IENIQVJfQ09MT04pIHsKICAgIHN0YXJ0ID0gMgogIH0KCiAgaWYgKHN1ZmZpeCAhPT0gdW5kZWZpbmVkICYmIHN1ZmZpeC5sZW5ndGggPiAwICYmIHN1ZmZpeC5sZW5ndGggPD0gcGF0aC5sZW5ndGgpIHsKICAgIGlmIChzdWZmaXggPT09IHBhdGgpIHJldHVybiAnJwogICAgbGV0IGV4dElkeCA9IHN1ZmZpeC5sZW5ndGggLSAxCiAgICBsZXQgZmlyc3ROb25TbGFzaEVuZCA9IC0xCiAgICBmb3IgKGxldCBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IHN0YXJ0OyAtLWkpIHsKICAgICAgY29uc3QgY29kZSA9IHBhdGguY2hhckNvZGVBdChpKQogICAgICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihjb2RlKSkgewogICAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgICBzdGFydCA9IGkgKyAxCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZmlyc3ROb25TbGFzaEVuZCA9PT0gLTEpIHsKICAgICAgICAgIG1hdGNoZWRTbGFzaCA9IGZhbHNlCiAgICAgICAgICBmaXJzdE5vblNsYXNoRW5kID0gaSArIDEKICAgICAgICB9CiAgICAgICAgaWYgKGV4dElkeCA+PSAwKSB7CiAgICAgICAgICBpZiAoY29kZSA9PT0gc3VmZml4LmNoYXJDb2RlQXQoZXh0SWR4KSkgewogICAgICAgICAgICBpZiAoLS1leHRJZHggPT09IC0xKSB7CiAgICAgICAgICAgICAgZW5kID0gaQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBleHRJZHggPSAtMQogICAgICAgICAgICBlbmQgPSBmaXJzdE5vblNsYXNoRW5kCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKHN0YXJ0ID09PSBlbmQpIGVuZCA9IGZpcnN0Tm9uU2xhc2hFbmQKICAgIGVsc2UgaWYgKGVuZCA9PT0gLTEpIGVuZCA9IHBhdGgubGVuZ3RoCiAgICByZXR1cm4gcGF0aC5zdWJzdHJpbmcoc3RhcnQsIGVuZCkKICB9CiAgZm9yIChsZXQgaSA9IHBhdGgubGVuZ3RoIC0gMTsgaSA+PSBzdGFydDsgLS1pKSB7CiAgICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaSkpKSB7CiAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgc3RhcnQgPSBpICsgMQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZW5kID09PSAtMSkgewogICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZQogICAgICBlbmQgPSBpICsgMQogICAgfQogIH0KCiAgaWYgKGVuZCA9PT0gLTEpIHJldHVybiAnJwogIHJldHVybiBwYXRoLnN1YnN0cmluZyhzdGFydCwgZW5kKQp9CgpleHBvcnRzLmV4dG5hbWUgPSBmdW5jdGlvbiBleHRuYW1lIChwYXRoKSB7CiAgbGV0IHN0YXJ0ID0gMAogIGxldCBzdGFydERvdCA9IC0xCiAgbGV0IHN0YXJ0UGFydCA9IDAKICBsZXQgZW5kID0gLTEKICBsZXQgbWF0Y2hlZFNsYXNoID0gdHJ1ZQogIGxldCBwcmVEb3RTdGF0ZSA9IDAKCiAgaWYgKHBhdGgubGVuZ3RoID49IDIgJiYgcGF0aC5jaGFyQ29kZUF0KDEpID09PSBDSEFSX0NPTE9OICYmIGlzV2luZG93c0RldmljZVJvb3QocGF0aC5jaGFyQ29kZUF0KDApKSkgewogICAgc3RhcnQgPSBzdGFydFBhcnQgPSAyCiAgfQoKICBmb3IgKGxldCBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IHN0YXJ0OyAtLWkpIHsKICAgIGNvbnN0IGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoaSkKICAgIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGNvZGUpKSB7CiAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgc3RhcnRQYXJ0ID0gaSArIDEKICAgICAgICBicmVhawogICAgICB9CiAgICAgIGNvbnRpbnVlCiAgICB9CiAgICBpZiAoZW5kID09PSAtMSkgewogICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZQogICAgICBlbmQgPSBpICsgMQogICAgfQogICAgaWYgKGNvZGUgPT09IENIQVJfRE9UKSB7CiAgICAgIGlmIChzdGFydERvdCA9PT0gLTEpIHN0YXJ0RG90ID0gaQogICAgICBlbHNlIGlmIChwcmVEb3RTdGF0ZSAhPT0gMSkgcHJlRG90U3RhdGUgPSAxCiAgICB9IGVsc2UgaWYgKHN0YXJ0RG90ICE9PSAtMSkgewogICAgICBwcmVEb3RTdGF0ZSA9IC0xCiAgICB9CiAgfQoKICBpZiAoc3RhcnREb3QgPT09IC0xIHx8IGVuZCA9PT0gLTEgfHwgcHJlRG90U3RhdGUgPT09IDAgfHwgKHByZURvdFN0YXRlID09PSAxICYmIHN0YXJ0RG90ID09PSBlbmQgLSAxICYmIHN0YXJ0RG90ID09PSBzdGFydFBhcnQgKyAxKSkgewogICAgcmV0dXJuICcnCiAgfQogIHJldHVybiBwYXRoLnN1YnN0cmluZyhzdGFydERvdCwgZW5kKQp9CnsKICAibmFtZSI6ICJiYXJlLXBhdGgiLAogICJ2ZXJzaW9uIjogIjMuMC4wIiwKICAiZGVzY3JpcHRpb24iOiAiUGF0aCBtYW5pcHVsYXRpb24gbGlicmFyeSBmb3IgSmF2YVNjcmlwdCIsCiAgImV4cG9ydHMiOiB7CiAgICAiLiI6ICIuL2luZGV4LmpzIiwKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4vcG9zaXgiOiAiLi9saWIvcG9zaXguanMiLAogICAgIi4vd2luMzIiOiAiLi9saWIvd2luMzIuanMiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYiIsCiAgICAiTk9USUNFIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBiYXJlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1wYXRoLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtcGF0aC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtcGF0aCNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1vcyI6ICJeMy4wLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMy4yIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0KfQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgbSA9IHJlcXVpcmUoJy4vbGliL21lc3NhZ2VzJykKY29uc3QgeyB0eXBlOiB0LCBzdHJlYW06IHMgfSA9IHJlcXVpcmUoJy4vbGliL2NvbnN0YW50cycpCmNvbnN0IEluY29taW5nUmVxdWVzdCA9IHJlcXVpcmUoJy4vbGliL2luY29taW5nLXJlcXVlc3QnKQpjb25zdCBJbmNvbWluZ1N0cmVhbSA9IHJlcXVpcmUoJy4vbGliL2luY29taW5nLXN0cmVhbScpCmNvbnN0IE91dGdvaW5nUmVxdWVzdCA9IHJlcXVpcmUoJy4vbGliL291dGdvaW5nLXJlcXVlc3QnKQpjb25zdCBPdXRnb2luZ1N0cmVhbSA9IHJlcXVpcmUoJy4vbGliL291dGdvaW5nLXN0cmVhbScpCmNvbnN0IENvbW1hbmRSb3V0ZXIgPSByZXF1aXJlKCcuL2xpYi9jb21tYW5kLXJvdXRlcicpCgptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBjbGFzcyBSUEMgewogIGNvbnN0cnVjdG9yKHN0cmVhbSwgb25yZXF1ZXN0ID0gbm9vcCkgewogICAgdGhpcy5fc3RyZWFtID0gc3RyZWFtCiAgICB0aGlzLl9pZCA9IDAKCiAgICB0aGlzLl9vdXRnb2luZ1JlcXVlc3RzID0gbmV3IE1hcCgpCiAgICB0aGlzLl9vdXRnb2luZ1Jlc3BvbnNlcyA9IG5ldyBNYXAoKQogICAgdGhpcy5faW5jb21pbmdSZXF1ZXN0cyA9IG5ldyBNYXAoKQogICAgdGhpcy5faW5jb21pbmdSZXNwb25zZXMgPSBuZXcgTWFwKCkKICAgIHRoaXMuX3BlbmRpbmdSZXF1ZXN0cyA9IG5ldyBTZXQoKQogICAgdGhpcy5fcGVuZGluZ1Jlc3BvbnNlcyA9IG5ldyBTZXQoKQoKICAgIHRoaXMuX2J1ZmZlciA9IFtdCiAgICB0aGlzLl9idWZmZXJlZCA9IDAKICAgIHRoaXMuX2ZyYW1lID0gLTEKICAgIHRoaXMuX2RyYWluaW5nID0gW10KCiAgICBpZiAodHlwZW9mIG9ucmVxdWVzdCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBvbnJlcXVlc3QgPSBvbnJlcXVlc3QuYmluZCh0aGlzKQogICAgfSBlbHNlIHsKICAgICAgb25yZXF1ZXN0ID0gb25yZXF1ZXN0Ll9vbnJlcXVlc3QuYmluZChvbnJlcXVlc3QpCiAgICB9CgogICAgdGhpcy5fb25yZXF1ZXN0ID0gb25yZXF1ZXN0CiAgICB0aGlzLl9vbmVycm9yID0gdGhpcy5fb25lcnJvci5iaW5kKHRoaXMpCiAgICB0aGlzLl9vbmRhdGEgPSB0aGlzLl9vbmRhdGEuYmluZCh0aGlzKQogICAgdGhpcy5fb25kcmFpbiA9IHRoaXMuX29uZHJhaW4uYmluZCh0aGlzKQoKICAgIHRoaXMuX3N0cmVhbQogICAgICAub24oJ2Vycm9yJywgdGhpcy5fb25lcnJvcikKICAgICAgLm9uKCdkYXRhJywgdGhpcy5fb25kYXRhKQogICAgICAub24oJ2RyYWluJywgdGhpcy5fb25kcmFpbikKICB9CgogIHJlcXVlc3QoY29tbWFuZCkgewogICAgcmV0dXJuIG5ldyBPdXRnb2luZ1JlcXVlc3QodGhpcywgKyt0aGlzLl9pZCwgY29tbWFuZCkKICB9CgogIF9zZW5kTWVzc2FnZShtZXNzYWdlLCBjYikgewogICAgY29uc3QgaGVhZGVyID0gYy5lbmNvZGUobS5oZWFkZXIsIG1lc3NhZ2UpCgogICAgbGV0IGZsdXNoZWQgPSB0aGlzLl9zdHJlYW0ud3JpdGUoaGVhZGVyKQoKICAgIGlmIChtZXNzYWdlLmRhdGEpIGZsdXNoZWQgPSB0aGlzLl9zdHJlYW0ud3JpdGUobWVzc2FnZS5kYXRhKQoKICAgIGlmIChjYikgewogICAgICBpZiAoZmx1c2hlZCkgY2IobnVsbCkKICAgICAgZWxzZSB0aGlzLl9kcmFpbmluZy5wdXNoKGNiKQogICAgfQogIH0KCiAgX3NlbmRSZXF1ZXN0KHJlcXVlc3QsIGRhdGEgPSBudWxsKSB7CiAgICB0aGlzLl9vdXRnb2luZ1JlcXVlc3RzLnNldChyZXF1ZXN0LmlkLCByZXF1ZXN0KQoKICAgIHRoaXMuX3NlbmRNZXNzYWdlKHsKICAgICAgdHlwZTogdC5SRVFVRVNULAogICAgICBpZDogcmVxdWVzdC5pZCwKICAgICAgY29tbWFuZDogcmVxdWVzdC5jb21tYW5kLAogICAgICBzdHJlYW06IDAsCiAgICAgIGRhdGEKICAgIH0pCiAgfQoKICBfY3JlYXRlUmVxdWVzdFN0cmVhbShyZXF1ZXN0LCBpc0luaXRpYXRvciwgb3B0cykgewogICAgaWYgKGlzSW5pdGlhdG9yKSB7CiAgICAgIHRoaXMuX291dGdvaW5nUmVxdWVzdHMuc2V0KHJlcXVlc3QuaWQsIHJlcXVlc3QpCgogICAgICByZXF1ZXN0Ll9yZXF1ZXN0U3RyZWFtID0gbmV3IE91dGdvaW5nU3RyZWFtKAogICAgICAgIHRoaXMsCiAgICAgICAgcmVxdWVzdCwKICAgICAgICB0LlJFUVVFU1QsCiAgICAgICAgb3B0cwogICAgICApCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9pbmNvbWluZ1JlcXVlc3RzLnNldChyZXF1ZXN0LmlkLCByZXF1ZXN0KQoKICAgICAgcmVxdWVzdC5fcmVxdWVzdFN0cmVhbSA9IG5ldyBJbmNvbWluZ1N0cmVhbSgKICAgICAgICB0aGlzLAogICAgICAgIHJlcXVlc3QsCiAgICAgICAgdC5SRVFVRVNULAogICAgICAgIG9wdHMKICAgICAgKQoKICAgICAgcmVxdWVzdC5fcmVxdWVzdFN0cmVhbS5vbignY2xvc2UnLCAoKSA9PgogICAgICAgIHRoaXMuX2luY29taW5nUmVxdWVzdHMuZGVsZXRlKHJlcXVlc3QuaWQpCiAgICAgICkKICAgIH0KICB9CgogIF9zZW5kUmVzcG9uc2UocmVxdWVzdCwgZGF0YSkgewogICAgdGhpcy5fc2VuZE1lc3NhZ2UoewogICAgICB0eXBlOiB0LlJFU1BPTlNFLAogICAgICBpZDogcmVxdWVzdC5pZCwKICAgICAgc3RyZWFtOiAwLAogICAgICBlcnJvcjogbnVsbCwKICAgICAgZGF0YQogICAgfSkKICB9CgogIF9jcmVhdGVSZXNwb25zZVN0cmVhbShyZXF1ZXN0LCBpc0luaXRpYXRvciwgb3B0cykgewogICAgaWYgKGlzSW5pdGlhdG9yKSB7CiAgICAgIHRoaXMuX291dGdvaW5nUmVzcG9uc2VzLnNldChyZXF1ZXN0LmlkLCByZXF1ZXN0KQoKICAgICAgcmVxdWVzdC5fcmVzcG9uc2VTdHJlYW0gPSBuZXcgT3V0Z29pbmdTdHJlYW0oCiAgICAgICAgdGhpcywKICAgICAgICByZXF1ZXN0LAogICAgICAgIHQuUkVTUE9OU0UsCiAgICAgICAgb3B0cwogICAgICApCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9pbmNvbWluZ1Jlc3BvbnNlcy5zZXQocmVxdWVzdC5pZCwgcmVxdWVzdCkKCiAgICAgIHJlcXVlc3QuX3Jlc3BvbnNlU3RyZWFtID0gbmV3IEluY29taW5nU3RyZWFtKAogICAgICAgIHRoaXMsCiAgICAgICAgcmVxdWVzdCwKICAgICAgICB0LlJFU1BPTlNFLAogICAgICAgIG9wdHMKICAgICAgKQoKICAgICAgcmVxdWVzdC5fcmVzcG9uc2VTdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4KICAgICAgICB0aGlzLl9pbmNvbWluZ1Jlc3BvbnNlcy5kZWxldGUocmVxdWVzdC5pZCkKICAgICAgKQogICAgfQogIH0KCiAgX3NlbmRFcnJvcihyZXF1ZXN0LCBlcnIpIHsKICAgIHRoaXMuX3NlbmRNZXNzYWdlKHsKICAgICAgdHlwZTogdC5SRVNQT05TRSwKICAgICAgaWQ6IHJlcXVlc3QuaWQsCiAgICAgIHN0cmVhbTogMCwKICAgICAgZXJyb3I6IGVyciwKICAgICAgZGF0YTogbnVsbAogICAgfSkKICB9CgogIF9vbmVycm9yKGVycikgewogICAgdGhpcy5fb25kcmFpbihlcnIpCgogICAgLy8gVE9ETyBEZXN0cm95IHBlbmRpbmcgcmVxdWVzdHMgYW5kIHJlc3BvbnNlcwogIH0KCiAgX29uZGF0YShkYXRhKSB7CiAgICB0aGlzLl9idWZmZXIucHVzaChkYXRhKQogICAgdGhpcy5fYnVmZmVyZWQgKz0gZGF0YS5ieXRlTGVuZ3RoCgogICAgaWYgKHRoaXMuX2ZyYW1lID09PSAtMSkgewogICAgICB0aGlzLl9vbmJlZm9yZWZyYW1lKCkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX29uYWZ0ZXJmcmFtZSgpCiAgICB9CiAgfQoKICBfb25iZWZvcmVmcmFtZSgpIHsKICAgIGlmICh0aGlzLl9idWZmZXJlZCA8IDQpIHJldHVybgoKICAgIGNvbnN0IGJ1ZmZlciA9CiAgICAgIHRoaXMuX2J1ZmZlci5sZW5ndGggPT09IDEgPyB0aGlzLl9idWZmZXJbMF0gOiBiNGEuY29uY2F0KHRoaXMuX2J1ZmZlcikKCiAgICB0aGlzLl9idWZmZXIgPSBbYnVmZmVyXQogICAgdGhpcy5fZnJhbWUgPSA0ICsgYy51aW50MzIuZGVjb2RlKGMuc3RhdGUoMCwgNCwgYnVmZmVyKSkKCiAgICB0aGlzLl9vbmFmdGVyZnJhbWUoKQogIH0KCiAgX29uYWZ0ZXJmcmFtZSgpIHsKICAgIGlmICh0aGlzLl9idWZmZXJlZCA8IHRoaXMuX2ZyYW1lKSByZXR1cm4KCiAgICBjb25zdCBidWZmZXIgPQogICAgICB0aGlzLl9idWZmZXIubGVuZ3RoID09PSAxID8gdGhpcy5fYnVmZmVyWzBdIDogYjRhLmNvbmNhdCh0aGlzLl9idWZmZXIpCgogICAgY29uc3QgZnJhbWUgPSB0aGlzLl9mcmFtZQoKICAgIHRoaXMuX2J1ZmZlcmVkIC09IGZyYW1lCiAgICB0aGlzLl9idWZmZXIgPSB0aGlzLl9idWZmZXJlZCA+IDAgPyBbYnVmZmVyLnN1YmFycmF5KGZyYW1lKV0gOiBbXQogICAgdGhpcy5fZnJhbWUgPSAtMQoKICAgIHRoaXMuX29ubWVzc2FnZShidWZmZXIuc3ViYXJyYXkoMCwgZnJhbWUpKQogICAgdGhpcy5fb25iZWZvcmVmcmFtZSgpCiAgfQoKICBhc3luYyBfb25tZXNzYWdlKGJ1ZmZlcikgewogICAgbGV0IG1lc3NhZ2UKICAgIHRyeSB7CiAgICAgIG1lc3NhZ2UgPSBtLm1lc3NhZ2UuZGVjb2RlKGMuc3RhdGUoMCwgYnVmZmVyLmxlbmd0aCwgYnVmZmVyKSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCgogICAgICByZXR1cm4gdGhpcy5fc3RyZWFtLmRlc3Ryb3koZXJyKQogICAgfQoKICAgIHN3aXRjaCAobWVzc2FnZS50eXBlKSB7CiAgICAgIGNhc2UgdC5SRVFVRVNUOgogICAgICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgSW5jb21pbmdSZXF1ZXN0KAogICAgICAgICAgdGhpcywKICAgICAgICAgIG1lc3NhZ2UuaWQsCiAgICAgICAgICBtZXNzYWdlLmNvbW1hbmQsCiAgICAgICAgICBtZXNzYWdlLmRhdGEKICAgICAgICApCgogICAgICAgIHRyeSB7CiAgICAgICAgICBhd2FpdCB0aGlzLl9vbnJlcXVlc3QocmVxdWVzdCkKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHNhZmV0eUNhdGNoKGVycikKCiAgICAgICAgICB0aGlzLl9zZW5kRXJyb3IocmVxdWVzdCwgZXJyKQogICAgICAgIH0KICAgICAgICBicmVhawogICAgICBjYXNlIHQuUkVTUE9OU0U6CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHRoaXMuX29ucmVzcG9uc2UobWVzc2FnZSkKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgICAgICB9CiAgICAgICAgYnJlYWsKICAgICAgY2FzZSB0LlNUUkVBTToKICAgICAgICB0cnkgewogICAgICAgICAgdGhpcy5fb25zdHJlYW0obWVzc2FnZSkKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgICAgICB9CiAgICB9CiAgfQoKICBfb25yZXNwb25zZShtZXNzYWdlKSB7CiAgICBpZiAobWVzc2FnZS5pZCA9PT0gMCkgcmV0dXJuCgogICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX291dGdvaW5nUmVxdWVzdHMuZ2V0KG1lc3NhZ2UuaWQpCiAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICBpZiAobWVzc2FnZS5lcnJvcikgewogICAgICByZXF1ZXN0Ll9yZWplY3QobWVzc2FnZS5lcnJvcikKICAgIH0gZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gPT09IDApIHsKICAgICAgcmVxdWVzdC5fcmVzb2x2ZShtZXNzYWdlLmRhdGEpCiAgICB9CiAgfQoKICBfb25zdHJlYW0obWVzc2FnZSkgewogICAgaWYgKG1lc3NhZ2UuaWQgPT09IDApIHJldHVybgoKICAgIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuT1BFTikgdGhpcy5fb25zdHJlYW1vcGVuKG1lc3NhZ2UpCiAgICBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuQ0xPU0UpIHRoaXMuX29uc3RyZWFtY2xvc2UobWVzc2FnZSkKICAgIGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5QQVVTRSkgdGhpcy5fb25zdHJlYW1wYXVzZShtZXNzYWdlKQogICAgZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFU1VNRSkgdGhpcy5fb25zdHJlYW1yZXN1bWUobWVzc2FnZSkKICAgIGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5EQVRBKSB0aGlzLl9vbnN0cmVhbWRhdGEobWVzc2FnZSkKICAgIGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5FTkQpIHRoaXMuX29uc3RyZWFtZW5kKG1lc3NhZ2UpCiAgICBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuREVTVFJPWSkgdGhpcy5fb25zdHJlYW1kZXN0cm95KG1lc3NhZ2UpCiAgfQoKICBfb25zdHJlYW1vcGVuKG1lc3NhZ2UpIHsKICAgIGxldCBzdHJlYW0KCiAgICBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFUVVFU1QpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX291dGdvaW5nUmVxdWVzdHMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLl9wZW5kaW5nUmVxdWVzdHMuYWRkKG1lc3NhZ2UuaWQpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3JlcXVlc3RTdHJlYW0KCiAgICAgIGlmIChzdHJlYW0uX3BlbmRpbmdPcGVuID09PSBudWxsKSB7CiAgICAgICAgdGhpcy5fcGVuZGluZ1JlcXVlc3RzLmFkZChtZXNzYWdlLmlkKQogICAgICAgIHJldHVybgogICAgICB9CiAgICB9IGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVNQT05TRSkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fb3V0Z29pbmdSZXNwb25zZXMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLl9wZW5kaW5nUmVzcG9uc2VzLmFkZChtZXNzYWdlLmlkKQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXNwb25zZVN0cmVhbQoKICAgICAgaWYgKHN0cmVhbS5fcGVuZGluZ09wZW4gPT09IG51bGwpIHsKICAgICAgICB0aGlzLl9wZW5kaW5nUmVzcG9uc2VzLmFkZChtZXNzYWdlLmlkKQogICAgICAgIHJldHVybgogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4KICAgIH0KCiAgICBzdHJlYW0uX2NvbnRpbnVlT3BlbigpCiAgfQoKICBfb25zdHJlYW1jbG9zZShtZXNzYWdlKSB7CiAgICBsZXQgc3RyZWFtCgogICAgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVFVRVNUKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9pbmNvbWluZ1JlcXVlc3RzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3JlcXVlc3RTdHJlYW0KICAgIH0gZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFU1BPTlNFKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9pbmNvbWluZ1Jlc3BvbnNlcy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXNwb25zZVN0cmVhbQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKG1lc3NhZ2UuZXJyb3IpIHN0cmVhbS5kZXN0cm95KG1lc3NhZ2UuZXJyb3IpCiAgICBlbHNlIHN0cmVhbS5wdXNoKG51bGwpCiAgfQoKICBfb25zdHJlYW1wYXVzZShtZXNzYWdlKSB7CiAgICBsZXQgc3RyZWFtCgogICAgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVFVRVNUKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9vdXRnb2luZ1JlcXVlc3RzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3JlcXVlc3RTdHJlYW0KICAgIH0gZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFU1BPTlNFKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9vdXRnb2luZ1Jlc3BvbnNlcy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXNwb25zZVN0cmVhbQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgc3RyZWFtLmNvcmsoKQogIH0KCiAgX29uc3RyZWFtcmVzdW1lKG1lc3NhZ2UpIHsKICAgIGxldCBzdHJlYW0KCiAgICBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFUVVFU1QpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX291dGdvaW5nUmVxdWVzdHMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVxdWVzdFN0cmVhbQogICAgfSBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVTUE9OU0UpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX291dGdvaW5nUmVzcG9uc2VzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3Jlc3BvbnNlU3RyZWFtCiAgICB9IGVsc2UgewogICAgICByZXR1cm4KICAgIH0KCiAgICBzdHJlYW0udW5jb3JrKCkKICB9CgogIF9vbnN0cmVhbWRhdGEobWVzc2FnZSkgewogICAgbGV0IHN0cmVhbQoKICAgIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVRVUVTVCkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5faW5jb21pbmdSZXF1ZXN0cy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXF1ZXN0U3RyZWFtCiAgICB9IGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVNQT05TRSkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5faW5jb21pbmdSZXNwb25zZXMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVzcG9uc2VTdHJlYW0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChzdHJlYW0ucHVzaChtZXNzYWdlLmRhdGEpID09PSBmYWxzZSkgewogICAgICB0aGlzLl9zZW5kTWVzc2FnZSh7CiAgICAgICAgdHlwZTogdC5TVFJFQU0sCiAgICAgICAgaWQ6IHN0cmVhbS5fcmVxdWVzdC5pZCwKICAgICAgICBzdHJlYW06IHN0cmVhbS5fbWFzayB8IHMuUEFVU0UsCiAgICAgICAgZXJyb3I6IG51bGwsCiAgICAgICAgZGF0YTogbnVsbAogICAgICB9KQogICAgfQogIH0KCiAgX29uc3RyZWFtZW5kKG1lc3NhZ2UpIHsKICAgIGxldCBzdHJlYW0KCiAgICBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFUVVFU1QpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX2luY29taW5nUmVxdWVzdHMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVxdWVzdFN0cmVhbQogICAgfSBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVTUE9OU0UpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX2luY29taW5nUmVzcG9uc2VzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3Jlc3BvbnNlU3RyZWFtCiAgICB9IGVsc2UgewogICAgICByZXR1cm4KICAgIH0KCiAgICBzdHJlYW0ucHVzaChudWxsKQogIH0KCiAgX29uc3RyZWFtZGVzdHJveShtZXNzYWdlKSB7CiAgICBsZXQgc3RyZWFtCgogICAgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVFVRVNUKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9vdXRnb2luZ1JlcXVlc3RzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3JlcXVlc3RTdHJlYW0KICAgIH0gZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFU1BPTlNFKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9vdXRnb2luZ1Jlc3BvbnNlcy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXNwb25zZVN0cmVhbQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgc3RyZWFtLmRlc3Ryb3kobWVzc2FnZS5lcnJvcikKICB9CgogIF9vbmRyYWluKGVyciA9IG51bGwpIHsKICAgIGNvbnN0IGRyYWluaW5nID0gdGhpcy5fZHJhaW5pbmcKCiAgICB0aGlzLl9kcmFpbmluZyA9IFtdCgogICAgZm9yIChjb25zdCBjYiBvZiBkcmFpbmluZykgY2IoZXJyKQogIH0KfQoKZXhwb3J0cy5Db21tYW5kUm91dGVyID0gQ29tbWFuZFJvdXRlcgoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUlBDQ29tbWFuZFJvdXRlciB7CiAgY29uc3RydWN0b3Iob3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IHZhbHVlRW5jb2RpbmcgPSBjLnJhdyB9ID0gb3B0cwoKICAgIHRoaXMuX3Jlc3BvbmRlcnMgPSBuZXcgTWFwKCkKICAgIHRoaXMuX2RlZmF1bHRWYWx1ZUVuY29kaW5nID0gdmFsdWVFbmNvZGluZwogIH0KCiAgcmVzcG9uZChjb21tYW5kLCBvcHRzID0ge30sIG9ucmVxdWVzdCkgewogICAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIG9ucmVxdWVzdCA9IG9wdHMKICAgICAgb3B0cyA9IHt9CiAgICB9CgogICAgY29uc3QgewogICAgICB2YWx1ZUVuY29kaW5nID0gdGhpcy5fZGVmYXVsdFZhbHVlRW5jb2RpbmcsCiAgICAgIHJlcXVlc3RFbmNvZGluZyA9IHZhbHVlRW5jb2RpbmcsCiAgICAgIHJlc3BvbnNlRW5jb2RpbmcgPSB2YWx1ZUVuY29kaW5nCiAgICB9ID0gb3B0cwoKICAgIHRoaXMuX3Jlc3BvbmRlcnMuc2V0KGNvbW1hbmQsIHsKICAgICAgb25yZXF1ZXN0LAogICAgICByZXF1ZXN0RW5jb2RpbmcsCiAgICAgIHJlc3BvbnNlRW5jb2RpbmcKICAgIH0pCiAgfQoKICBhc3luYyBfb25yZXF1ZXN0KHJlcSkgewogICAgY29uc3QgcmVzcG9uZGVyID0gdGhpcy5fcmVzcG9uZGVycy5nZXQocmVxLmNvbW1hbmQpCgogICAgaWYgKHJlc3BvbmRlciA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICBjb25zdCB7IG9ucmVxdWVzdCwgcmVxdWVzdEVuY29kaW5nLCByZXNwb25zZUVuY29kaW5nIH0gPSByZXNwb25kZXIKCiAgICBsZXQgZGF0YSA9IHJlcS5kYXRhCgogICAgaWYgKHJlcXVlc3RFbmNvZGluZykgZGF0YSA9IGMuZGVjb2RlKHJlcXVlc3RFbmNvZGluZywgZGF0YSkKCiAgICBkYXRhID0gYXdhaXQgb25yZXF1ZXN0KHJlcSwgZGF0YSkKCiAgICBpZiAocmVxLnNlbnQpIHJldHVybgoKICAgIGlmIChyZXNwb25zZUVuY29kaW5nKSBkYXRhID0gYy5lbmNvZGUocmVzcG9uc2VFbmNvZGluZywgZGF0YSkKCiAgICByZXEucmVwbHkoZGF0YSkKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSB7CiAgdHlwZTogewogICAgUkVRVUVTVDogMSwKICAgIFJFU1BPTlNFOiAyLAogICAgU1RSRUFNOiAzCiAgfSwKICBzdHJlYW06IHsKICAgIE9QRU46IDB4MSwKICAgIENMT1NFOiAweDIsCiAgICBQQVVTRTogMHg0LAogICAgUkVTVU1FOiAweDgsCiAgICBEQVRBOiAweDEwLAogICAgRU5EOiAweDIwLAogICAgREVTVFJPWTogMHg0MCwKICAgIEVSUk9SOiAweDgwLAogICAgUkVRVUVTVDogMHgxMDAsCiAgICBSRVNQT05TRTogMHgyMDAKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSUENFcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3Rvcihtc2csIGNvZGUsIGZuID0gUlBDRXJyb3IpIHsKICAgIHN1cGVyKGAke2NvZGV9OiAke21zZ31gKQogICAgdGhpcy5jb2RlID0gY29kZQoKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBmbikKICAgIH0KICB9CgogIGdldCBuYW1lKCkgewogICAgcmV0dXJuICdSUENFcnJvcicKICB9CgogIHN0YXRpYyBVTktOT1dOX01FU1NBR0UobXNnKSB7CiAgICByZXR1cm4gbmV3IFJQQ0Vycm9yKG1zZywgJ1VOS05PV05fTUVTU0FHRScsIFJQQ0Vycm9yLlVOS05PV05fTUVTU0FHRSkKICB9CgogIHN0YXRpYyBBTFJFQURZX1NFTlQobXNnKSB7CiAgICByZXR1cm4gbmV3IFJQQ0Vycm9yKG1zZywgJ0FMUkVBRFlfU0VOVCcsIFJQQ0Vycm9yLkFMUkVBRFlfU0VOVCkKICB9CgogIHN0YXRpYyBBTFJFQURZX1JFQ0VJVkVEKG1zZykgewogICAgcmV0dXJuIG5ldyBSUENFcnJvcihtc2csICdBTFJFQURZX1JFQ0VJVkVEJywgUlBDRXJyb3IuQUxSRUFEWV9SRUNFSVZFRCkKICB9Cn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuL2Vycm9ycycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJQQ0luY29taW5nUmVxdWVzdCB7CiAgY29uc3RydWN0b3IocnBjLCBpZCwgY29tbWFuZCwgZGF0YSkgewogICAgdGhpcy5ycGMgPSBycGMKICAgIHRoaXMuaWQgPSBpZAogICAgdGhpcy5jb21tYW5kID0gY29tbWFuZAogICAgdGhpcy5kYXRhID0gZGF0YQogICAgdGhpcy5zZW50ID0gZmFsc2UKICAgIHRoaXMucmVjZWl2ZWQgPSBmYWxzZQoKICAgIHRoaXMuX3JlcXVlc3RTdHJlYW0gPSBudWxsCiAgICB0aGlzLl9yZXNwb25zZVN0cmVhbSA9IG51bGwKICB9CgogIHJlcGx5KGRhdGEsIGVuY29kaW5nKSB7CiAgICBpZiAodGhpcy5zZW50KSB7CiAgICAgIHRocm93IGVycm9ycy5BTFJFQURZX1NFTlQoJ1Jlc3BvbnNlIGhhcyBhbHJlYWR5IGJlZW4gc2VudCcpCiAgICB9CgogICAgZW5jb2RpbmcgPQogICAgICBlbmNvZGluZyAmJiBlbmNvZGluZyAhPT0gJ2J1ZmZlcicKICAgICAgICA/IGMuZnJvbShlbmNvZGluZykKICAgICAgICA6IHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJwogICAgICAgICAgPyBjLnJhdy51dGY4CiAgICAgICAgICA6IG51bGwKCiAgICB0aGlzLnNlbnQgPSB0cnVlCgogICAgdGhpcy5ycGMuX3NlbmRSZXNwb25zZSh0aGlzLCBlbmNvZGluZyA/IGMuZW5jb2RlKGVuY29kaW5nLCBkYXRhKSA6IGRhdGEpCiAgfQoKICBjcmVhdGVSZXNwb25zZVN0cmVhbShvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLnNlbnQpIHsKICAgICAgdGhyb3cgZXJyb3JzLkFMUkVBRFlfU0VOVCgnUmVzcG9uc2UgaGFzIGFscmVhZHkgYmVlbiBzZW50JykKICAgIH0KCiAgICB0aGlzLnNlbnQgPSB0cnVlCgogICAgdGhpcy5ycGMuX2NyZWF0ZVJlc3BvbnNlU3RyZWFtKHRoaXMsIHRydWUsIG9wdHMpCgogICAgcmV0dXJuIHRoaXMuX3Jlc3BvbnNlU3RyZWFtCiAgfQoKICBjcmVhdGVSZXF1ZXN0U3RyZWFtKG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMucmVjZWl2ZWQpIHsKICAgICAgdGhyb3cgZXJyb3JzLkFMUkVBRFlfUkVDRUlWRUQoJ1JlcXVlc3QgaGFzIGFscmVhZHkgYmVlbiByZWNlaXZlZCcpCiAgICB9CgogICAgdGhpcy5yZWNlaXZlZCA9IHRydWUKCiAgICB0aGlzLnJwYy5fY3JlYXRlUmVxdWVzdFN0cmVhbSh0aGlzLCBmYWxzZSwgb3B0cykKCiAgICByZXR1cm4gdGhpcy5fcmVxdWVzdFN0cmVhbQogIH0KfQpjb25zdCB7IFJlYWRhYmxlIH0gPSByZXF1aXJlKCdiYXJlLXN0cmVhbScpCmNvbnN0IHsgdHlwZTogdCwgc3RyZWFtOiBzIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJQQ0luY29taW5nU3RyZWFtIGV4dGVuZHMgUmVhZGFibGUgewogIGNvbnN0cnVjdG9yKHJwYywgcmVxdWVzdCwgdHlwZSwgb3B0cykgewogICAgc3VwZXIoeyAuLi5vcHRzLCBlYWdlck9wZW46IHRydWUgfSkKCiAgICB0aGlzLl9ycGMgPSBycGMKICAgIHRoaXMuX3JlcXVlc3QgPSByZXF1ZXN0CiAgICB0aGlzLl90eXBlID0gdHlwZQogICAgdGhpcy5fbWFzayA9IHR5cGUgPT09IHQuUkVRVUVTVCA/IHMuUkVRVUVTVCA6IHMuUkVTUE9OU0UKICB9CgogIF9vcGVuKGNiKSB7CiAgICB0aGlzLl9ycGMuX3NlbmRNZXNzYWdlKAogICAgICB7CiAgICAgICAgdHlwZTogdC5TVFJFQU0sCiAgICAgICAgaWQ6IHRoaXMuX3JlcXVlc3QuaWQsCiAgICAgICAgc3RyZWFtOiB0aGlzLl9tYXNrIHwgcy5PUEVOLAogICAgICAgIGVycm9yOiBudWxsLAogICAgICAgIGRhdGE6IG51bGwKICAgICAgfSwKICAgICAgY2IKICAgICkKICB9CgogIF9yZWFkKCkgewogICAgdGhpcy5fcnBjLl9zZW5kTWVzc2FnZSh7CiAgICAgIHR5cGU6IHQuU1RSRUFNLAogICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgc3RyZWFtOiB0aGlzLl9tYXNrIHwgcy5SRVNVTUUsCiAgICAgIGVycm9yOiBudWxsLAogICAgICBkYXRhOiBudWxsCiAgICB9KQogIH0KCiAgX2Rlc3Ryb3koZXJyLCBjYikgewogICAgaWYgKGVycikgewogICAgICB0aGlzLl9ycGMuX3NlbmRNZXNzYWdlKAogICAgICAgIHsKICAgICAgICAgIHR5cGU6IHQuU1RSRUFNLAogICAgICAgICAgaWQ6IHRoaXMuX3JlcXVlc3QuaWQsCiAgICAgICAgICBzdHJlYW06IHRoaXMuX21hc2sgfCBzLkRFU1RST1kgfCBzLkVSUk9SLAogICAgICAgICAgZXJyb3I6IGVyciwKICAgICAgICAgIGRhdGE6IG51bGwKICAgICAgICB9LAogICAgICAgIGNiCiAgICAgICkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgICAgewogICAgICAgICAgdHlwZTogdC5TVFJFQU0sCiAgICAgICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgICAgIHN0cmVhbTogdGhpcy5fbWFzayB8IHMuREVTVFJPWSwKICAgICAgICAgIGVycm9yOiBudWxsLAogICAgICAgICAgZGF0YTogbnVsbAogICAgICAgIH0sCiAgICAgICAgY2IKICAgICAgKQogICAgfQogIH0KfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IHsgdHlwZTogdCwgc3RyZWFtOiBzIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4vZXJyb3JzJykKCmNvbnN0IGVycm9yID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51dGY4LnByZWVuY29kZShzdGF0ZSwgbS5tZXNzYWdlKQogICAgYy51dGY4LnByZWVuY29kZShzdGF0ZSwgU3RyaW5nKG0uY29kZSkgfHwgJycpCiAgICBjLmludC5wcmVlbmNvZGUoc3RhdGUsIE51bWJlcihtLmVycm5vKSB8fCAwKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnV0ZjguZW5jb2RlKHN0YXRlLCBtLm1lc3NhZ2UpCiAgICBjLnV0ZjguZW5jb2RlKHN0YXRlLCBTdHJpbmcobS5jb2RlKSB8fCAnJykKICAgIGMuaW50LmVuY29kZShzdGF0ZSwgTnVtYmVyKG0uZXJybm8pIHx8IDApCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGVyciA9IG5ldyBFcnJvcihgJHtjLnV0ZjguZGVjb2RlKHN0YXRlKX1gKQogICAgZXJyLmNvZGUgPSBjLnV0ZjguZGVjb2RlKHN0YXRlKQogICAgZXJyLmVycm5vID0gYy5pbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIGVycgogIH0KfQoKZXhwb3J0cy5oZWFkZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQzMi5wcmVlbmNvZGUoc3RhdGUsIDApIC8vIEZyYW1lCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnR5cGUpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmlkKQoKICAgIGxldCBoYXNEYXRhID0gZmFsc2UKCiAgICBzd2l0Y2ggKG0udHlwZSkgewogICAgICBjYXNlIHQuUkVRVUVTVDoKICAgICAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmNvbW1hbmQpCiAgICAgICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdHJlYW0pCiAgICAgICAgaWYgKG0uc3RyZWFtID09PSAwKSBoYXNEYXRhID0gdHJ1ZQogICAgICAgIGJyZWFrCgogICAgICBjYXNlIHQuUkVTUE9OU0U6CiAgICAgICAgYy5ib29sLnByZWVuY29kZShzdGF0ZSwgISFtLmVycm9yKQogICAgICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RyZWFtKQoKICAgICAgICBpZiAobS5lcnJvcikgZXJyb3IucHJlZW5jb2RlKHN0YXRlLCBtLmVycm9yKQogICAgICAgIGVsc2UgaWYgKG0uc3RyZWFtID09PSAwKSBoYXNEYXRhID0gdHJ1ZQogICAgICAgIGJyZWFrCgogICAgICBjYXNlIHQuU1RSRUFNOgogICAgICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RyZWFtKQoKICAgICAgICBpZiAobS5zdHJlYW0gJiBzLkVSUk9SKSBlcnJvci5wcmVlbmNvZGUoc3RhdGUsIG0uZXJyb3IpCiAgICAgICAgZWxzZSBpZiAobS5zdHJlYW0gJiBzLkRBVEEpIGhhc0RhdGEgPSB0cnVlCiAgICAgICAgYnJlYWsKICAgIH0KCiAgICBpZiAoaGFzRGF0YSkgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5kYXRhID8gbS5kYXRhLmJ5dGVMZW5ndGggOiAwKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmcmFtZSA9IHN0YXRlLnN0YXJ0CgogICAgYy51aW50MzIuZW5jb2RlKHN0YXRlLCAwKSAvLyBGcmFtZQoKICAgIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnR5cGUpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmlkKQoKICAgIGxldCBoYXNEYXRhID0gZmFsc2UKCiAgICBzd2l0Y2ggKG0udHlwZSkgewogICAgICBjYXNlIHQuUkVRVUVTVDoKICAgICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmNvbW1hbmQpCiAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdHJlYW0pCiAgICAgICAgaWYgKG0uc3RyZWFtID09PSAwKSBoYXNEYXRhID0gdHJ1ZQogICAgICAgIGJyZWFrCgogICAgICBjYXNlIHQuUkVTUE9OU0U6CiAgICAgICAgYy5ib29sLmVuY29kZShzdGF0ZSwgISFtLmVycm9yKQogICAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RyZWFtKQoKICAgICAgICBpZiAobS5lcnJvcikgZXJyb3IuZW5jb2RlKHN0YXRlLCBtLmVycm9yKQogICAgICAgIGVsc2UgaWYgKG0uc3RyZWFtID09PSAwKSBoYXNEYXRhID0gdHJ1ZQogICAgICAgIGJyZWFrCgogICAgICBjYXNlIHQuU1RSRUFNOgogICAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RyZWFtKQoKICAgICAgICBpZiAobS5zdHJlYW0gJiBzLkVSUk9SKSBlcnJvci5lbmNvZGUoc3RhdGUsIG0uZXJyb3IpCiAgICAgICAgZWxzZSBpZiAobS5zdHJlYW0gJiBzLkRBVEEpIGhhc0RhdGEgPSB0cnVlCiAgICAgICAgYnJlYWsKICAgIH0KCiAgICBpZiAoaGFzRGF0YSkgYy51aW50LmVuY29kZShzdGF0ZSwgbS5kYXRhID8gbS5kYXRhLmJ5dGVMZW5ndGggOiAwKQoKICAgIGNvbnN0IGVuZCA9IHN0YXRlLnN0YXJ0CgogICAgc3RhdGUuc3RhcnQgPSBmcmFtZQoKICAgIGMudWludDMyLmVuY29kZSgKICAgICAgc3RhdGUsCiAgICAgIGVuZCAtIHN0YXJ0ICsgKGhhc0RhdGEgJiYgbS5kYXRhID8gbS5kYXRhLmJ5dGVMZW5ndGggOiAwKQogICAgKQoKICAgIHN0YXRlLnN0YXJ0ID0gZW5kCiAgfQp9CgpleHBvcnRzLm1lc3NhZ2UgPSB7CiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmcmFtZSA9IGMudWludDMyLmRlY29kZShzdGF0ZSkKCiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCBmcmFtZSkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ091dCBvZiBib3VuZHMnKQoKICAgIGNvbnN0IHR5cGUgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgaWQgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlIHQuUkVRVUVTVDogewogICAgICAgIGNvbnN0IGNvbW1hbmQgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgICAgIGNvbnN0IHN0cmVhbSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICAgICAgY29uc3QgZGF0YSA9IHN0cmVhbSA9PT0gMCA/IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkgOiBudWxsCgogICAgICAgIHJldHVybiB7IHR5cGUsIGlkLCBjb21tYW5kLCBzdHJlYW0sIGRhdGEgfQogICAgICB9CgogICAgICBjYXNlIHQuUkVTUE9OU0U6IHsKICAgICAgICBjb25zdCBlcnIgPSBjLmJvb2wuZGVjb2RlKHN0YXRlKQogICAgICAgIGNvbnN0IHN0cmVhbSA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHJldHVybiB7IHR5cGUsIGlkLCBzdHJlYW0sIGVycm9yOiBlcnJvci5kZWNvZGUoc3RhdGUpLCBkYXRhOiBudWxsIH0KICAgICAgICB9CgogICAgICAgIGlmIChzdHJlYW0gPT09IDApIHsKICAgICAgICAgIHJldHVybiB7IHR5cGUsIGlkLCBzdHJlYW0sIGVycm9yOiBudWxsLCBkYXRhOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB7IHR5cGUsIGlkLCBzdHJlYW0sIGVycm9yOiBudWxsLCBkYXRhOiBudWxsIH0KICAgICAgfQoKICAgICAgY2FzZSB0LlNUUkVBTToKICAgICAgICBjb25zdCBzdHJlYW0gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgICAgICBpZiAoc3RyZWFtICYgcy5FUlJPUikgewogICAgICAgICAgcmV0dXJuIHsgdHlwZSwgaWQsIHN0cmVhbSwgZXJyb3I6IGVycm9yLmRlY29kZShzdGF0ZSksIGRhdGE6IG51bGwgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHN0cmVhbSAmIHMuREFUQSkgewogICAgICAgICAgcmV0dXJuIHsgdHlwZSwgaWQsIHN0cmVhbSwgZXJyb3I6IG51bGwsIGRhdGE6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsgdHlwZSwgaWQsIHN0cmVhbSwgZXJyb3I6IG51bGwsIGRhdGE6IG51bGwgfQoKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuVU5LTk9XTl9NRVNTQUdFKGBVbmtub3duIG1lc3NhZ2UgJyR7dHlwZX0nYCkKICAgIH0KICB9Cn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuL2Vycm9ycycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJQQ091dGdvaW5nUmVxdWVzdCB7CiAgY29uc3RydWN0b3IocnBjLCBpZCwgY29tbWFuZCkgewogICAgdGhpcy5ycGMgPSBycGMKICAgIHRoaXMuaWQgPSBpZAogICAgdGhpcy5jb21tYW5kID0gY29tbWFuZAogICAgdGhpcy5zZW50ID0gZmFsc2UKICAgIHRoaXMucmVjZWl2ZWQgPSBmYWxzZQoKICAgIHRoaXMuX3Byb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIHRoaXMuX3Jlc29sdmUgPSByZXNvbHZlCiAgICAgIHRoaXMuX3JlamVjdCA9IHJlamVjdAogICAgfSkKCiAgICB0aGlzLl9yZXF1ZXN0U3RyZWFtID0gbnVsbAogICAgdGhpcy5fcmVzcG9uc2VTdHJlYW0gPSBudWxsCiAgfQoKICBzZW5kKGRhdGEsIGVuY29kaW5nKSB7CiAgICBpZiAodGhpcy5zZW50KSB7CiAgICAgIHRocm93IGVycm9ycy5BTFJFQURZX1NFTlQoJ1JlcXVlc3QgaGFzIGFscmVhZHkgYmVlbiBzZW50JykKICAgIH0KCiAgICBlbmNvZGluZyA9CiAgICAgIGVuY29kaW5nICYmIGVuY29kaW5nICE9PSAnYnVmZmVyJwogICAgICAgID8gYy5mcm9tKGVuY29kaW5nKQogICAgICAgIDogdHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnCiAgICAgICAgICA/IGMucmF3LnV0ZjgKICAgICAgICAgIDogbnVsbAoKICAgIHRoaXMuc2VudCA9IHRydWUKCiAgICB0aGlzLnJwYy5fc2VuZFJlcXVlc3QodGhpcywgZW5jb2RpbmcgPyBjLmVuY29kZShlbmNvZGluZywgZGF0YSkgOiBkYXRhKQogIH0KCiAgcmVwbHkoZW5jb2RpbmcpIHsKICAgIGlmICh0aGlzLnJlY2VpdmVkKSB7CiAgICAgIHRocm93IGVycm9ycy5BTFJFQURZX1JFQ0VJVkVEKCdSZXNwb25zZSBpcyBhbHJlYWR5IGJlaW5nIHJlY2VpdmVkJykKICAgIH0KCiAgICBlbmNvZGluZyA9IGVuY29kaW5nICYmIGVuY29kaW5nICE9PSAnYnVmZmVyJyA/IGMuZnJvbShlbmNvZGluZykgOiBudWxsCgogICAgdGhpcy5yZWNlaXZlZCA9IHRydWUKCiAgICByZXR1cm4gZW5jb2RpbmcKICAgICAgPyB0aGlzLl9wcm9taXNlLnRoZW4oKGRhdGEpID0+IGMuZGVjb2RlKGVuY29kaW5nLCBkYXRhKSkKICAgICAgOiB0aGlzLl9wcm9taXNlCiAgfQoKICBjcmVhdGVSZXF1ZXN0U3RyZWFtKG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMuc2VudCkgewogICAgICB0aHJvdyBlcnJvcnMuQUxSRUFEWV9TRU5UKCdSZXF1ZXN0IGhhcyBhbHJlYWR5IGJlZW4gc2VudCcpCiAgICB9CgogICAgdGhpcy5zZW50ID0gdHJ1ZQoKICAgIHRoaXMucnBjLl9jcmVhdGVSZXF1ZXN0U3RyZWFtKHRoaXMsIHRydWUsIG9wdHMpCgogICAgcmV0dXJuIHRoaXMuX3JlcXVlc3RTdHJlYW0KICB9CgogIGNyZWF0ZVJlc3BvbnNlU3RyZWFtKG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMucmVjZWl2ZWQpIHsKICAgICAgdGhyb3cgZXJyb3JzLkFMUkVBRFlfUkVDRUlWRUQoJ1Jlc3BvbnNlIGhhcyBhbHJlYWR5IGJlZW4gcmVjZWl2ZWQnKQogICAgfQoKICAgIHRoaXMucmVjZWl2ZWQgPSB0cnVlCgogICAgdGhpcy5ycGMuX2NyZWF0ZVJlc3BvbnNlU3RyZWFtKHRoaXMsIGZhbHNlLCBvcHRzKQoKICAgIHJldHVybiB0aGlzLl9yZXNwb25zZVN0cmVhbQogIH0KfQpjb25zdCB7IFdyaXRhYmxlIH0gPSByZXF1aXJlKCdiYXJlLXN0cmVhbScpCmNvbnN0IHsgdHlwZTogdCwgc3RyZWFtOiBzIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJQQ091dGdvaW5nU3RyZWFtIGV4dGVuZHMgV3JpdGFibGUgewogIGNvbnN0cnVjdG9yKHJwYywgcmVxdWVzdCwgdHlwZSwgb3B0cykgewogICAgc3VwZXIoeyAuLi5vcHRzLCBlYWdlck9wZW46IHRydWUgfSkKCiAgICB0aGlzLl9ycGMgPSBycGMKICAgIHRoaXMuX3JlcXVlc3QgPSByZXF1ZXN0CiAgICB0aGlzLl90eXBlID0gdHlwZQogICAgdGhpcy5fbWFzayA9IHR5cGUgPT09IHQuUkVRVUVTVCA/IHMuUkVRVUVTVCA6IHMuUkVTUE9OU0UKCiAgICB0aGlzLl9wZW5kaW5nT3BlbiA9IG51bGwKICB9CgogIF9vcGVuKGNiKSB7CiAgICBsZXQgcGVuZGluZwoKICAgIGNvbnN0IG9uZmx1c2hlZCA9ICgpID0+IHsKICAgICAgaWYgKHBlbmRpbmcuaGFzKHRoaXMuX3JlcXVlc3QuaWQpKSB7CiAgICAgICAgcGVuZGluZy5kZWxldGUodGhpcy5fcmVxdWVzdC5pZCkKCiAgICAgICAgY2IobnVsbCkKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9wZW5kaW5nT3BlbiA9IGNiCiAgICAgIH0KICAgIH0KCiAgICBzd2l0Y2ggKHRoaXMuX3R5cGUpIHsKICAgICAgY2FzZSB0LlJFUVVFU1Q6CiAgICAgICAgcGVuZGluZyA9IHRoaXMuX3JwYy5fcGVuZGluZ1JlcXVlc3RzCgogICAgICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgICAgICB7CiAgICAgICAgICAgIHR5cGU6IHQuUkVRVUVTVCwKICAgICAgICAgICAgaWQ6IHRoaXMuX3JlcXVlc3QuaWQsCiAgICAgICAgICAgIGNvbW1hbmQ6IHRoaXMuX3JlcXVlc3QuY29tbWFuZCwKICAgICAgICAgICAgc3RyZWFtOiBzLk9QRU4sCiAgICAgICAgICAgIGRhdGE6IG51bGwKICAgICAgICAgIH0sCiAgICAgICAgICBvbmZsdXNoZWQKICAgICAgICApCiAgICAgICAgYnJlYWsKCiAgICAgIGNhc2UgdC5SRVNQT05TRToKICAgICAgICBwZW5kaW5nID0gdGhpcy5fcnBjLl9wZW5kaW5nUmVzcG9uc2VzCgogICAgICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgICAgICB7CiAgICAgICAgICAgIHR5cGU6IHQuUkVTUE9OU0UsCiAgICAgICAgICAgIGlkOiB0aGlzLl9yZXF1ZXN0LmlkLAogICAgICAgICAgICBlcnJvcjogZmFsc2UsCiAgICAgICAgICAgIHN0cmVhbTogcy5PUEVOLAogICAgICAgICAgICBkYXRhOiBudWxsCiAgICAgICAgICB9LAogICAgICAgICAgb25mbHVzaGVkCiAgICAgICAgKQogICAgICAgIGJyZWFrCiAgICB9CiAgfQoKICBfY29udGludWVPcGVuKCkgewogICAgaWYgKHRoaXMuX3BlbmRpbmdPcGVuID09PSBudWxsKSByZXR1cm4KICAgIGNvbnN0IGNiID0gdGhpcy5fcGVuZGluZ09wZW4KICAgIHRoaXMuX3BlbmRpbmdPcGVuID0gbnVsbAogICAgY2IoKQogIH0KCiAgX3dyaXRlKGRhdGEsIGVuY29kaW5nLCBjYikgewogICAgdGhpcy5fcnBjLl9zZW5kTWVzc2FnZSgKICAgICAgewogICAgICAgIHR5cGU6IHQuU1RSRUFNLAogICAgICAgIGlkOiB0aGlzLl9yZXF1ZXN0LmlkLAogICAgICAgIHN0cmVhbTogdGhpcy5fbWFzayB8IHMuREFUQSwKICAgICAgICBlcnJvcjogbnVsbCwKICAgICAgICBkYXRhCiAgICAgIH0sCiAgICAgIGNiCiAgICApCiAgfQoKICBfZmluYWwoY2IpIHsKICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgIHsKICAgICAgICB0eXBlOiB0LlNUUkVBTSwKICAgICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgICBzdHJlYW06IHRoaXMuX21hc2sgfCBzLkVORCwKICAgICAgICBlcnJvcjogbnVsbCwKICAgICAgICBkYXRhOiBudWxsCiAgICAgIH0sCiAgICAgIGNiCiAgICApCiAgfQoKICBfZGVzdHJveShlcnIsIGNiKSB7CiAgICBpZiAoZXJyKSB7CiAgICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgICAgewogICAgICAgICAgdHlwZTogdC5TVFJFQU0sCiAgICAgICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgICAgIHN0cmVhbTogdGhpcy5fbWFzayB8IHMuQ0xPU0UgfCBzLkVSUk9SLAogICAgICAgICAgZXJyb3I6IGVyciwKICAgICAgICAgIGRhdGE6IG51bGwKICAgICAgICB9LAogICAgICAgIGNiCiAgICAgICkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgICAgewogICAgICAgICAgdHlwZTogdC5TVFJFQU0sCiAgICAgICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgICAgIHN0cmVhbTogdGhpcy5fbWFzayB8IHMuQ0xPU0UsCiAgICAgICAgICBlcnJvcjogbnVsbCwKICAgICAgICAgIGRhdGE6IG51bGwKICAgICAgICB9LAogICAgICAgIGNiCiAgICAgICkKICAgIH0KICB9Cn0KewogICJuYW1lIjogImJhcmUtcnBjIiwKICAidmVyc2lvbiI6ICIwLjIuMTMiLAogICJkZXNjcmlwdGlvbiI6ICJsaWJycGMgQUJJIGNvbXBhdGlibGUgUlBDIGZvciBCYXJlIiwKICAiZXhwb3J0cyI6IHsKICAgICIuIjogewogICAgICAidHlwZXMiOiAiLi9pbmRleC5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9pbmRleC5qcyIKICAgIH0sCiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuL2Vycm9ycyI6IHsKICAgICAgInR5cGVzIjogIi4vbGliL2Vycm9ycy5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9saWIvZXJyb3JzLmpzIgogICAgfQogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJpbmRleC5kLnRzIiwKICAgICJsaWIiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBiYXJlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1ycGMuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1ycGMvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXJwYyNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNiIsCiAgICAiYmFyZS1zdHJlYW0iOiAiXjIuMS4zIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjE1LjAiLAogICAgInNhZmV0eS1jYXRjaCI6ICJeMS4wLjIiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYnVmZmVyIjogIl4zLjAuMSIsCiAgICAiYmFyZS1pcGMiOiAiXjEuMS4wIiwKICAgICJicml0dGxlIjogIl4zLjIuMSIsCiAgICAicHJldHRpZXIiOiAiXjMuNC4yIiwKICAgICJwcmV0dGllci1jb25maWctc3RhbmRhcmQiOiAiXjcuMC4wIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1idWZmZXIiOiAiKiIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzTWV0YSI6IHsKICAgICJiYXJlLWJ1ZmZlciI6IHsKICAgICAgIm9wdGlvbmFsIjogdHJ1ZQogICAgfQogIH0KfQpjb25zdCBzdHJlYW0gPSByZXF1aXJlKCdzdHJlYW14JykKCmNvbnN0IGRlZmF1bHRFbmNvZGluZyA9ICd1dGY4JwoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gc3RyZWFtLlN0cmVhbQoKZXhwb3J0cy5waXBlbGluZSA9IHN0cmVhbS5waXBlbGluZQoKZXhwb3J0cy5pc1N0cmVhbSA9IHN0cmVhbS5pc1N0cmVhbQpleHBvcnRzLmlzRW5kZWQgPSBzdHJlYW0uaXNFbmRlZApleHBvcnRzLmlzRmluaXNoZWQgPSBzdHJlYW0uaXNGaW5pc2hlZApleHBvcnRzLmlzRGlzdHVyYmVkID0gc3RyZWFtLmlzRGlzdHVyYmVkCgpleHBvcnRzLmdldFN0cmVhbUVycm9yID0gc3RyZWFtLmdldFN0cmVhbUVycm9yCgpleHBvcnRzLlN0cmVhbSA9IGV4cG9ydHMKCmV4cG9ydHMuUmVhZGFibGUgPSBjbGFzcyBSZWFkYWJsZSBleHRlbmRzIHN0cmVhbS5SZWFkYWJsZSB7CiAgY29uc3RydWN0b3Iob3B0cyA9IHt9KSB7CiAgICBzdXBlcih7CiAgICAgIC4uLm9wdHMsCiAgICAgIGJ5dGVMZW5ndGg6IG51bGwsCiAgICAgIGJ5dGVMZW5ndGhSZWFkYWJsZTogbnVsbCwKICAgICAgbWFwOiBudWxsLAogICAgICBtYXBSZWFkYWJsZTogbnVsbAogICAgfSkKCiAgICBpZiAodGhpcy5fY29uc3RydWN0KSB0aGlzLl9vcGVuID0gdGhpcy5fY29uc3RydWN0CgogICAgaWYgKHRoaXMuX3JlYWQgIT09IHN0cmVhbS5SZWFkYWJsZS5wcm90b3R5cGUuX3JlYWQpIHsKICAgICAgdGhpcy5fcmVhZCA9IHJlYWQuYmluZCh0aGlzLCB0aGlzLl9yZWFkKQogICAgfQoKICAgIGlmICh0aGlzLl9kZXN0cm95ICE9PSBzdHJlYW0uU3RyZWFtLnByb3RvdHlwZS5fZGVzdHJveSkgewogICAgICB0aGlzLl9kZXN0cm95ID0gZGVzdHJveS5iaW5kKHRoaXMsIHRoaXMuX2Rlc3Ryb3kpCiAgICB9CiAgfQoKICBwdXNoKGNodW5rLCBlbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nKQogICAgfQoKICAgIHJldHVybiBzdXBlci5wdXNoKGNodW5rKQogIH0KCiAgdW5zaGlmdChjaHVuaywgZW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZykKICAgIH0KCiAgICBzdXBlci51bnNoaWZ0KGNodW5rKQogIH0KfQoKZXhwb3J0cy5Xcml0YWJsZSA9IGNsYXNzIFdyaXRhYmxlIGV4dGVuZHMgc3RyZWFtLldyaXRhYmxlIHsKICBjb25zdHJ1Y3RvcihvcHRzID0ge30pIHsKICAgIHN1cGVyKHsKICAgICAgLi4ub3B0cywKICAgICAgYnl0ZUxlbmd0aDogbnVsbCwKICAgICAgYnl0ZUxlbmd0aFdyaXRhYmxlLAogICAgICBtYXA6IG51bGwsCiAgICAgIG1hcFdyaXRhYmxlOiBudWxsCiAgICB9KQoKICAgIGlmICh0aGlzLl9jb25zdHJ1Y3QpIHRoaXMuX29wZW4gPSB0aGlzLl9jb25zdHJ1Y3QKCiAgICBpZiAodGhpcy5fd3JpdGUgIT09IHN0cmVhbS5Xcml0YWJsZS5wcm90b3R5cGUuX3dyaXRlKSB7CiAgICAgIHRoaXMuX3dyaXRlID0gd3JpdGUuYmluZCh0aGlzLCB0aGlzLl93cml0ZSkKICAgIH0KCiAgICBpZiAodGhpcy5fZGVzdHJveSAhPT0gc3RyZWFtLlN0cmVhbS5wcm90b3R5cGUuX2Rlc3Ryb3kpIHsKICAgICAgdGhpcy5fZGVzdHJveSA9IGRlc3Ryb3kuYmluZCh0aGlzLCB0aGlzLl9kZXN0cm95KQogICAgfQogIH0KCiAgd3JpdGUoY2h1bmssIGVuY29kaW5nLCBjYikgewogICAgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGVuY29kaW5nCiAgICAgIGVuY29kaW5nID0gbnVsbAogICAgfQoKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nCiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nKQogICAgfSBlbHNlIHsKICAgICAgZW5jb2RpbmcgPSAnYnVmZmVyJwogICAgfQoKICAgIGNvbnN0IHJlc3VsdCA9IHN1cGVyLndyaXRlKHsgY2h1bmssIGVuY29kaW5nIH0pCgogICAgaWYgKGNiKSBzdHJlYW0uV3JpdGFibGUuZHJhaW5lZCh0aGlzKS50aGVuKCgpID0+IGNiKG51bGwpLCBjYikKCiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICBlbmQoY2h1bmssIGVuY29kaW5nLCBjYikgewogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGNodW5rCiAgICAgIGNodW5rID0gbnVsbAogICAgfSBlbHNlIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSBlbmNvZGluZwogICAgICBlbmNvZGluZyA9IG51bGwKICAgIH0KCiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZwogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcpCiAgICB9IGVsc2UgewogICAgICBlbmNvZGluZyA9ICdidWZmZXInCiAgICB9CgogICAgY29uc3QgcmVzdWx0ID0KICAgICAgY2h1bmsgIT09IHVuZGVmaW5lZCAmJiBjaHVuayAhPT0gbnVsbAogICAgICAgID8gc3VwZXIuZW5kKHsgY2h1bmssIGVuY29kaW5nIH0pCiAgICAgICAgOiBzdXBlci5lbmQoKQoKICAgIGlmIChjYikgdGhpcy5vbmNlKCdmaW5pc2gnLCAoKSA9PiBjYihudWxsKSkKCiAgICByZXR1cm4gcmVzdWx0CiAgfQp9CgpleHBvcnRzLkR1cGxleCA9IGNsYXNzIER1cGxleCBleHRlbmRzIHN0cmVhbS5EdXBsZXggewogIGNvbnN0cnVjdG9yKG9wdHMgPSB7fSkgewogICAgc3VwZXIoewogICAgICAuLi5vcHRzLAogICAgICBieXRlTGVuZ3RoOiBudWxsLAogICAgICBieXRlTGVuZ3RoUmVhZGFibGU6IG51bGwsCiAgICAgIGJ5dGVMZW5ndGhXcml0YWJsZSwKICAgICAgbWFwOiBudWxsLAogICAgICBtYXBSZWFkYWJsZTogbnVsbCwKICAgICAgbWFwV3JpdGFibGU6IG51bGwKICAgIH0pCgogICAgaWYgKHRoaXMuX2NvbnN0cnVjdCkgdGhpcy5fb3BlbiA9IHRoaXMuX2NvbnN0cnVjdAoKICAgIGlmICh0aGlzLl9yZWFkICE9PSBzdHJlYW0uUmVhZGFibGUucHJvdG90eXBlLl9yZWFkKSB7CiAgICAgIHRoaXMuX3JlYWQgPSByZWFkLmJpbmQodGhpcywgdGhpcy5fcmVhZCkKICAgIH0KCiAgICBpZiAodGhpcy5fd3JpdGUgIT09IHN0cmVhbS5EdXBsZXgucHJvdG90eXBlLl93cml0ZSkgewogICAgICB0aGlzLl93cml0ZSA9IHdyaXRlLmJpbmQodGhpcywgdGhpcy5fd3JpdGUpCiAgICB9CgogICAgaWYgKHRoaXMuX2Rlc3Ryb3kgIT09IHN0cmVhbS5TdHJlYW0ucHJvdG90eXBlLl9kZXN0cm95KSB7CiAgICAgIHRoaXMuX2Rlc3Ryb3kgPSBkZXN0cm95LmJpbmQodGhpcywgdGhpcy5fZGVzdHJveSkKICAgIH0KICB9CgogIHB1c2goY2h1bmssIGVuY29kaW5nKSB7CiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcpCiAgICB9CgogICAgcmV0dXJuIHN1cGVyLnB1c2goY2h1bmspCiAgfQoKICB1bnNoaWZ0KGNodW5rLCBlbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nKQogICAgfQoKICAgIHN1cGVyLnVuc2hpZnQoY2h1bmspCiAgfQoKICB3cml0ZShjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgICBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gZW5jb2RpbmcKICAgICAgZW5jb2RpbmcgPSBudWxsCiAgICB9CgogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcpCiAgICB9IGVsc2UgewogICAgICBlbmNvZGluZyA9ICdidWZmZXInCiAgICB9CgogICAgY29uc3QgcmVzdWx0ID0gc3VwZXIud3JpdGUoeyBjaHVuaywgZW5jb2RpbmcgfSkKCiAgICBpZiAoY2IpIHN0cmVhbS5Xcml0YWJsZS5kcmFpbmVkKHRoaXMpLnRoZW4oKCkgPT4gY2IobnVsbCksIGNiKQoKICAgIHJldHVybiByZXN1bHQKICB9CgogIGVuZChjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gY2h1bmsKICAgICAgY2h1bmsgPSBudWxsCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGVuY29kaW5nCiAgICAgIGVuY29kaW5nID0gbnVsbAogICAgfQoKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nCiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nKQogICAgfSBlbHNlIHsKICAgICAgZW5jb2RpbmcgPSAnYnVmZmVyJwogICAgfQoKICAgIGNvbnN0IHJlc3VsdCA9CiAgICAgIGNodW5rICE9PSB1bmRlZmluZWQgJiYgY2h1bmsgIT09IG51bGwKICAgICAgICA/IHN1cGVyLmVuZCh7IGNodW5rLCBlbmNvZGluZyB9KQogICAgICAgIDogc3VwZXIuZW5kKCkKCiAgICBpZiAoY2IpIHRoaXMub25jZSgnZmluaXNoJywgKCkgPT4gY2IobnVsbCkpCgogICAgcmV0dXJuIHJlc3VsdAogIH0KfQoKZXhwb3J0cy5UcmFuc2Zvcm0gPSBjbGFzcyBUcmFuc2Zvcm0gZXh0ZW5kcyBzdHJlYW0uVHJhbnNmb3JtIHsKICBjb25zdHJ1Y3RvcihvcHRzID0ge30pIHsKICAgIHN1cGVyKHsKICAgICAgLi4ub3B0cywKICAgICAgYnl0ZUxlbmd0aDogbnVsbCwKICAgICAgYnl0ZUxlbmd0aFJlYWRhYmxlOiBudWxsLAogICAgICBieXRlTGVuZ3RoV3JpdGFibGUsCiAgICAgIG1hcDogbnVsbCwKICAgICAgbWFwUmVhZGFibGU6IG51bGwsCiAgICAgIG1hcFdyaXRhYmxlOiBudWxsCiAgICB9KQoKICAgIGlmICh0aGlzLl90cmFuc2Zvcm0gIT09IHN0cmVhbS5UcmFuc2Zvcm0ucHJvdG90eXBlLl90cmFuc2Zvcm0pIHsKICAgICAgdGhpcy5fdHJhbnNmb3JtID0gdHJhbnNmb3JtLmJpbmQodGhpcywgdGhpcy5fdHJhbnNmb3JtKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fdHJhbnNmb3JtID0gcGFzc3Rocm91Z2gKICAgIH0KICB9CgogIHB1c2goY2h1bmssIGVuY29kaW5nKSB7CiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcpCiAgICB9CgogICAgcmV0dXJuIHN1cGVyLnB1c2goY2h1bmspCiAgfQoKICB1bnNoaWZ0KGNodW5rLCBlbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nKQogICAgfQoKICAgIHN1cGVyLnVuc2hpZnQoY2h1bmspCiAgfQoKICB3cml0ZShjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgICBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gZW5jb2RpbmcKICAgICAgZW5jb2RpbmcgPSBudWxsCiAgICB9CgogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcpCiAgICB9IGVsc2UgewogICAgICBlbmNvZGluZyA9ICdidWZmZXInCiAgICB9CgogICAgY29uc3QgcmVzdWx0ID0gc3VwZXIud3JpdGUoeyBjaHVuaywgZW5jb2RpbmcgfSkKCiAgICBpZiAoY2IpIHN0cmVhbS5Xcml0YWJsZS5kcmFpbmVkKHRoaXMpLnRoZW4oKCkgPT4gY2IobnVsbCksIGNiKQoKICAgIHJldHVybiByZXN1bHQKICB9CgogIGVuZChjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gY2h1bmsKICAgICAgY2h1bmsgPSBudWxsCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGVuY29kaW5nCiAgICAgIGVuY29kaW5nID0gbnVsbAogICAgfQoKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nCiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nKQogICAgfSBlbHNlIHsKICAgICAgZW5jb2RpbmcgPSAnYnVmZmVyJwogICAgfQoKICAgIGNvbnN0IHJlc3VsdCA9CiAgICAgIGNodW5rICE9PSB1bmRlZmluZWQgJiYgY2h1bmsgIT09IG51bGwKICAgICAgICA/IHN1cGVyLmVuZCh7IGNodW5rLCBlbmNvZGluZyB9KQogICAgICAgIDogc3VwZXIuZW5kKCkKCiAgICBpZiAoY2IpIHRoaXMub25jZSgnZmluaXNoJywgKCkgPT4gY2IobnVsbCkpCgogICAgcmV0dXJuIHJlc3VsdAogIH0KfQoKZXhwb3J0cy5QYXNzVGhyb3VnaCA9IGNsYXNzIFBhc3NUaHJvdWdoIGV4dGVuZHMgZXhwb3J0cy5UcmFuc2Zvcm0ge30KCmV4cG9ydHMuZmluaXNoZWQgPSBmdW5jdGlvbiBmaW5pc2hlZChzdHJlYW0sIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7fQogIH0KCiAgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgeyBjbGVhbnVwID0gZmFsc2UgfSA9IG9wdHMKCiAgY29uc3QgZG9uZSA9ICgpID0+IHsKICAgIGNiKGV4cG9ydHMuZ2V0U3RyZWFtRXJyb3Ioc3RyZWFtLCB7IGFsbDogdHJ1ZSB9KSkKCiAgICBpZiAoY2xlYW51cCkgZGV0YWNoKCkKICB9CgogIGNvbnN0IGRldGFjaCA9ICgpID0+IHsKICAgIHN0cmVhbS5vZmYoJ2Nsb3NlJywgZG9uZSkKICAgIHN0cmVhbS5vZmYoJ2Vycm9yJywgbm9vcCkKICB9CgogIGlmIChzdHJlYW0uZGVzdHJveWVkKSB7CiAgICBkb25lKCkKICB9IGVsc2UgewogICAgc3RyZWFtLm9uKCdjbG9zZScsIGRvbmUpCiAgICBzdHJlYW0ub24oJ2Vycm9yJywgbm9vcCkKICB9CgogIHJldHVybiBkZXRhY2gKfQoKZnVuY3Rpb24gcmVhZChyZWFkLCBjYikgewogIHJlYWQuY2FsbCh0aGlzLCA2NTUzNikKCiAgY2IobnVsbCkKfQoKZnVuY3Rpb24gd3JpdGUod3JpdGUsIGRhdGEsIGNiKSB7CiAgd3JpdGUuY2FsbCh0aGlzLCBkYXRhLmNodW5rLCBkYXRhLmVuY29kaW5nLCBjYikKfQoKZnVuY3Rpb24gdHJhbnNmb3JtKHRyYW5zZm9ybSwgZGF0YSwgY2IpIHsKICB0cmFuc2Zvcm0uY2FsbCh0aGlzLCBkYXRhLmNodW5rLCBkYXRhLmVuY29kaW5nLCBjYikKfQoKZnVuY3Rpb24gZGVzdHJveShkZXN0cm95LCBjYikgewogIGRlc3Ryb3kuY2FsbCh0aGlzLCBleHBvcnRzLmdldFN0cmVhbUVycm9yKHRoaXMpLCBjYikKfQoKZnVuY3Rpb24gcGFzc3Rocm91Z2goZGF0YSwgY2IpIHsKICBjYihudWxsLCBkYXRhLmNodW5rKQp9CgpmdW5jdGlvbiBieXRlTGVuZ3RoV3JpdGFibGUoZGF0YSkgewogIHJldHVybiBkYXRhLmNodW5rLmJ5dGVMZW5ndGgKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CnsKICAibmFtZSI6ICJiYXJlLXN0cmVhbSIsCiAgInZlcnNpb24iOiAiMi43LjAiLAogICJkZXNjcmlwdGlvbiI6ICJTdHJlYW1pbmcgZGF0YSBmb3IgSmF2YVNjcmlwdCIsCiAgImV4cG9ydHMiOiB7CiAgICAiLiI6IHsKICAgICAgInR5cGVzIjogIi4vaW5kZXguZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vaW5kZXguanMiCiAgICB9LAogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLi9wcm9taXNlcyI6ICIuL3Byb21pc2VzLmpzIiwKICAgICIuL3dlYiI6IHsKICAgICAgInR5cGVzIjogIi4vd2ViLmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL3dlYi5qcyIKICAgIH0sCiAgICAiLi9nbG9iYWwiOiAiLi9nbG9iYWwuanMiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImluZGV4LmQudHMiLAogICAgInByb21pc2VzLmpzIiwKICAgICJ3ZWIuanMiLAogICAgIndlYi5kLnRzIiwKICAgICJnbG9iYWwuanMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBiYXJlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1zdHJlYW0uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1zdHJlYW0vaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXN0cmVhbSNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAic3RyZWFteCI6ICJeMi4yMS4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWJ1ZmZlciI6ICJeMy4wLjAiLAogICAgImJhcmUtZXZlbnRzIjogIl4yLjUuNCIsCiAgICAiYnJpdHRsZSI6ICJeMy41LjIiLAogICAgInByZXR0aWVyIjogIl4zLjMuMyIsCiAgICAicHJldHRpZXItY29uZmlnLXN0YW5kYXJkIjogIl43LjAuMCIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYnVmZmVyIjogIioiLAogICAgImJhcmUtZXZlbnRzIjogIioiCiAgfSwKICAicGVlckRlcGVuZGVuY2llc01ldGEiOiB7CiAgICAiYmFyZS1idWZmZXIiOiB7CiAgICAgICJvcHRpb25hbCI6IHRydWUKICAgIH0sCiAgICAiYmFyZS1ldmVudHMiOiB7CiAgICAgICJvcHRpb25hbCI6IHRydWUKICAgIH0KICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCkKY29uc3QgcGF0aCA9IHJlcXVpcmUoJ2JhcmUtcGF0aCcpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuL2JpbmRpbmcnKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuL2xpYi9lcnJvcnMnKQpjb25zdCBVUkxTZWFyY2hQYXJhbXMgPSByZXF1aXJlKCcuL2xpYi91cmwtc2VhcmNoLXBhcmFtcycpCgpjb25zdCBraW5kID0gU3ltYm9sLmZvcignYmFyZS51cmwua2luZCcpCgpjb25zdCBpc1dpbmRvd3MgPSBCYXJlLnBsYXRmb3JtID09PSAnd2luMzInCgptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBjbGFzcyBVUkwgewogIHN0YXRpYyBnZXQgW2tpbmRdKCkgewogICAgcmV0dXJuIDAgLy8gQ29tcGF0aWJpbGl0eSB2ZXJzaW9uCiAgfQoKICBjb25zdHJ1Y3RvcihpbnB1dCwgYmFzZSwgb3B0cyA9IHt9KSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgdGhyb3cgZXJyb3JzLklOVkFMSURfVVJMKCkKCiAgICBpbnB1dCA9IFN0cmluZyhpbnB1dCkKCiAgICBpZiAoYmFzZSAhPT0gdW5kZWZpbmVkKSBiYXNlID0gU3RyaW5nKGJhc2UpCgogICAgdGhpcy5fY29tcG9uZW50cyA9IG5ldyBVaW50MzJBcnJheSg4KQoKICAgIHRoaXMuX3BhcnNlKGlucHV0LCBiYXNlLCBvcHRzLnRocm93ICE9PSBmYWxzZSkKCiAgICBpZiAodGhpcy5faHJlZikgdGhpcy5fcGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh0aGlzLnNlYXJjaCwgdGhpcykKICB9CgogIGdldCBba2luZF0oKSB7CiAgICByZXR1cm4gVVJMW2tpbmRdCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtaHJlZgoKICBnZXQgaHJlZigpIHsKICAgIHJldHVybiB0aGlzLl9ocmVmCiAgfQoKICBzZXQgaHJlZih2YWx1ZSkgewogICAgdGhpcy5fdXBkYXRlKHZhbHVlKQoKICAgIHRoaXMuX3BhcmFtcy5fcGFyc2UodGhpcy5zZWFyY2gpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtcHJvdG9jb2wKCiAgZ2V0IHByb3RvY29sKCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKDAsIHRoaXMuX2NvbXBvbmVudHNbMF0pICsgJzonCiAgfQoKICBzZXQgcHJvdG9jb2wodmFsdWUpIHsKICAgIHRoaXMuX3VwZGF0ZSh0aGlzLl9yZXBsYWNlKHZhbHVlLnJlcGxhY2UoLzorJC8sICcnKSwgMCwgdGhpcy5fY29tcG9uZW50c1swXSkpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtdXNlcm5hbWUKCiAgZ2V0IHVzZXJuYW1lKCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKHRoaXMuX2NvbXBvbmVudHNbMF0gKyAzIC8qIDovLyAqLywgdGhpcy5fY29tcG9uZW50c1sxXSkKICB9CgogIHNldCB1c2VybmFtZSh2YWx1ZSkgewogICAgaWYgKGNhbm5vdEhhdmVDcmVkZW50aWFsc09yUG9ydCh0aGlzKSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy51c2VybmFtZSA9PT0gJycpIHZhbHVlICs9ICdAJwoKICAgIHRoaXMuX3VwZGF0ZSh0aGlzLl9yZXBsYWNlKHZhbHVlLCB0aGlzLl9jb21wb25lbnRzWzBdICsgMyAvKiA6Ly8gKi8sIHRoaXMuX2NvbXBvbmVudHNbMV0pKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsLXBhc3N3b3JkCgogIGdldCBwYXNzd29yZCgpIHsKICAgIHJldHVybiB0aGlzLl9ocmVmLnNsaWNlKHRoaXMuX2NvbXBvbmVudHNbMV0gKyAxIC8qIDogKi8sIHRoaXMuX2NvbXBvbmVudHNbMl0gLSAxIC8qIEAgKi8pCiAgfQoKICBzZXQgcGFzc3dvcmQodmFsdWUpIHsKICAgIGlmIChjYW5ub3RIYXZlQ3JlZGVudGlhbHNPclBvcnQodGhpcykpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgbGV0IHN0YXJ0ID0gdGhpcy5fY29tcG9uZW50c1sxXSArIDEgLyogOiAqLwogICAgbGV0IGVuZCA9IHRoaXMuX2NvbXBvbmVudHNbMl0gLSAxIC8qIEAgKi8KCiAgICBpZiAodGhpcy5wYXNzd29yZCA9PT0gJycpIHsKICAgICAgdmFsdWUgPSAnOicgKyB2YWx1ZQogICAgICBzdGFydC0tCiAgICB9CgogICAgaWYgKHRoaXMudXNlcm5hbWUgPT09ICcnKSB7CiAgICAgIHZhbHVlICs9ICdAJwogICAgICBlbmQrKwogICAgfQoKICAgIHRoaXMuX3VwZGF0ZSh0aGlzLl9yZXBsYWNlKHZhbHVlLCBzdGFydCwgZW5kKSkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1ob3N0CgogIGdldCBob3N0KCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKHRoaXMuX2NvbXBvbmVudHNbMl0sIHRoaXMuX2NvbXBvbmVudHNbNV0pCiAgfQoKICBzZXQgaG9zdCh2YWx1ZSkgewogICAgaWYgKGhhc09wYXF1ZVBhdGgodGhpcykpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5fdXBkYXRlKAogICAgICB0aGlzLl9yZXBsYWNlKHZhbHVlLCB0aGlzLl9jb21wb25lbnRzWzJdLCB0aGlzLl9jb21wb25lbnRzW3ZhbHVlLmluY2x1ZGVzKCc6JykgPyA1IDogM10pCiAgICApCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtaG9zdG5hbWUKCiAgZ2V0IGhvc3RuYW1lKCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKHRoaXMuX2NvbXBvbmVudHNbMl0sIHRoaXMuX2NvbXBvbmVudHNbM10pCiAgfQoKICBzZXQgaG9zdG5hbWUodmFsdWUpIHsKICAgIGlmIChoYXNPcGFxdWVQYXRoKHRoaXMpKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuX3VwZGF0ZSh0aGlzLl9yZXBsYWNlKHZhbHVlLCB0aGlzLl9jb21wb25lbnRzWzJdLCB0aGlzLl9jb21wb25lbnRzWzNdKSkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1wb3J0CgogIGdldCBwb3J0KCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKHRoaXMuX2NvbXBvbmVudHNbM10gKyAxIC8qIDogKi8sIHRoaXMuX2NvbXBvbmVudHNbNV0pCiAgfQoKICBzZXQgcG9ydCh2YWx1ZSkgewogICAgaWYgKGNhbm5vdEhhdmVDcmVkZW50aWFsc09yUG9ydCh0aGlzKSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICBsZXQgc3RhcnQgPSB0aGlzLl9jb21wb25lbnRzWzNdICsgMSAvKiA6ICovCgogICAgaWYgKHRoaXMucG9ydCA9PT0gJycpIHsKICAgICAgdmFsdWUgPSAnOicgKyB2YWx1ZQogICAgICBzdGFydC0tCiAgICB9CgogICAgdGhpcy5fdXBkYXRlKHRoaXMuX3JlcGxhY2UodmFsdWUsIHN0YXJ0LCB0aGlzLl9jb21wb25lbnRzWzVdKSkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1wYXRobmFtZQoKICBnZXQgcGF0aG5hbWUoKSB7CiAgICByZXR1cm4gdGhpcy5fc2xpY2UodGhpcy5fY29tcG9uZW50c1s1XSwgdGhpcy5fY29tcG9uZW50c1s2XSAtIDEgLyogPyAqLykKICB9CgogIHNldCBwYXRobmFtZSh2YWx1ZSkgewogICAgaWYgKGhhc09wYXF1ZVBhdGgodGhpcykpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHZhbHVlWzBdICE9PSAnLycgJiYgdmFsdWVbMF0gIT09ICdcXCcpIHsKICAgICAgdmFsdWUgPSAnLycgKyB2YWx1ZQogICAgfQoKICAgIHRoaXMuX3VwZGF0ZSh0aGlzLl9yZXBsYWNlKHZhbHVlLCB0aGlzLl9jb21wb25lbnRzWzVdLCB0aGlzLl9jb21wb25lbnRzWzZdIC0gMSAvKiA/ICovKSkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1zZWFyY2gKCiAgZ2V0IHNlYXJjaCgpIHsKICAgIHJldHVybiB0aGlzLl9zbGljZSh0aGlzLl9jb21wb25lbnRzWzZdIC0gMSAvKiA/ICovLCB0aGlzLl9jb21wb25lbnRzWzddIC0gMSAvKiAjICovKQogIH0KCiAgc2V0IHNlYXJjaCh2YWx1ZSkgewogICAgaWYgKHZhbHVlICYmIHZhbHVlWzBdICE9PSAnPycpIHZhbHVlID0gJz8nICsgdmFsdWUKCiAgICB0aGlzLl91cGRhdGUoCiAgICAgIHRoaXMuX3JlcGxhY2UodmFsdWUsIHRoaXMuX2NvbXBvbmVudHNbNl0gLSAxIC8qID8gKi8sIHRoaXMuX2NvbXBvbmVudHNbN10gLSAxIC8qICMgKi8pCiAgICApCgogICAgdGhpcy5fcGFyYW1zLl9wYXJzZSh0aGlzLnNlYXJjaCkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1zZWFyY2hwYXJhbXMKCiAgZ2V0IHNlYXJjaFBhcmFtcygpIHsKICAgIHJldHVybiB0aGlzLl9wYXJhbXMKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1oYXNoCgogIGdldCBoYXNoKCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKHRoaXMuX2NvbXBvbmVudHNbN10gLSAxIC8qICMgKi8pCiAgfQoKICBzZXQgaGFzaCh2YWx1ZSkgewogICAgaWYgKHZhbHVlICYmIHZhbHVlWzBdICE9PSAnIycpIHZhbHVlID0gJyMnICsgdmFsdWUKCiAgICB0aGlzLl91cGRhdGUodGhpcy5fcmVwbGFjZSh2YWx1ZSwgdGhpcy5fY29tcG9uZW50c1s3XSAtIDEgLyogIyAqLykpCiAgfQoKICB0b1N0cmluZygpIHsKICAgIHJldHVybiB0aGlzLl9ocmVmCiAgfQoKICB0b0pTT04oKSB7CiAgICByZXR1cm4gdGhpcy5faHJlZgogIH0KCiAgW1N5bWJvbC5mb3IoJ2JhcmUuaW5zcGVjdCcpXSgpIHsKICAgIHJldHVybiB7CiAgICAgIF9fcHJvdG9fXzogeyBjb25zdHJ1Y3RvcjogVVJMIH0sCgogICAgICBocmVmOiB0aGlzLmhyZWYsCiAgICAgIHByb3RvY29sOiB0aGlzLnByb3RvY29sLAogICAgICB1c2VybmFtZTogdGhpcy51c2VybmFtZSwKICAgICAgcGFzc3dvcmQ6IHRoaXMucGFzc3dvcmQsCiAgICAgIGhvc3Q6IHRoaXMuaG9zdCwKICAgICAgaG9zdG5hbWU6IHRoaXMuaG9zdG5hbWUsCiAgICAgIHBvcnQ6IHRoaXMucG9ydCwKICAgICAgcGF0aG5hbWU6IHRoaXMucGF0aG5hbWUsCiAgICAgIHNlYXJjaDogdGhpcy5zZWFyY2gsCiAgICAgIHNlYXJjaFBhcmFtczogdGhpcy5zZWFyY2hQYXJhbXMsCiAgICAgIGhhc2g6IHRoaXMuaGFzaAogICAgfQogIH0KCiAgX3NsaWNlKHN0YXJ0LCBlbmQgPSB0aGlzLl9ocmVmLmxlbmd0aCkgewogICAgcmV0dXJuIHRoaXMuX2hyZWYuc2xpY2Uoc3RhcnQsIGVuZCkKICB9CgogIF9yZXBsYWNlKHJlcGxhY2VtZW50LCBzdGFydCwgZW5kID0gdGhpcy5faHJlZi5sZW5ndGgpIHsKICAgIHJldHVybiB0aGlzLl9zbGljZSgwLCBzdGFydCkgKyByZXBsYWNlbWVudCArIHRoaXMuX3NsaWNlKGVuZCkKICB9CgogIF9wYXJzZShpbnB1dCwgYmFzZSwgc2hvdWxkVGhyb3cpIHsKICAgIHRyeSB7CiAgICAgIHRoaXMuX2hyZWYgPSBiaW5kaW5nLnBhcnNlKAogICAgICAgIFN0cmluZyhpbnB1dCksCiAgICAgICAgYmFzZSA/IFN0cmluZyhiYXNlKSA6IG51bGwsCiAgICAgICAgdGhpcy5fY29tcG9uZW50cywKICAgICAgICBzaG91bGRUaHJvdwogICAgICApCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIFR5cGVFcnJvcikgdGhyb3cgZXJyCgogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9VUkwoYEludmFsaWQgVVJMICcke2lucHV0fSdgLCBpbnB1dCkKICAgIH0KICB9CgogIF91cGRhdGUoaW5wdXQpIHsKICAgIHRyeSB7CiAgICAgIHRoaXMuX3BhcnNlKGlucHV0LCBudWxsLCB0cnVlKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBUeXBlRXJyb3IpIHRocm93IGVycgogICAgfQogIH0KfQoKLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyN1cmwtb3BhcXVlLXBhdGgKZnVuY3Rpb24gaGFzT3BhcXVlUGF0aCh1cmwpIHsKICByZXR1cm4gdXJsLnBhdGhuYW1lWzBdICE9PSAnLycKfQoKLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNjYW5ub3QtaGF2ZS1hLXVzZXJuYW1lLXBhc3N3b3JkLXBvcnQKZnVuY3Rpb24gY2Fubm90SGF2ZUNyZWRlbnRpYWxzT3JQb3J0KHVybCkgewogIHJldHVybiB1cmwuaG9zdG5hbWUgPT09ICcnIHx8IHVybC5wcm90b2NvbCA9PT0gJ2ZpbGU6Jwp9Cgpjb25zdCBVUkwgPSBleHBvcnRzCgpleHBvcnRzLlVSTCA9IFVSTApleHBvcnRzLlVSTFNlYXJjaFBhcmFtcyA9IFVSTFNlYXJjaFBhcmFtcwoKZXhwb3J0cy5lcnJvcnMgPSBlcnJvcnMKCmV4cG9ydHMuaXNVUkwgPSBmdW5jdGlvbiBpc1VSTCh2YWx1ZSkgewogIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFVSTCkgcmV0dXJuIHRydWUKCiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdmFsdWUgIT09IG51bGwgJiYgdmFsdWVba2luZF0gPT09IFVSTFtraW5kXQp9CgovLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtcGFyc2UKZXhwb3J0cy5wYXJzZSA9IGZ1bmN0aW9uIHBhcnNlKGlucHV0LCBiYXNlKSB7CiAgY29uc3QgdXJsID0gbmV3IFVSTChpbnB1dCwgYmFzZSwgeyB0aHJvdzogZmFsc2UgfSkKICByZXR1cm4gdXJsLl9ocmVmID8gdXJsIDogbnVsbAp9CgovLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtY2FucGFyc2UKZXhwb3J0cy5jYW5QYXJzZSA9IGZ1bmN0aW9uIGNhblBhcnNlKGlucHV0LCBiYXNlKSB7CiAgcmV0dXJuIGJpbmRpbmcuY2FuUGFyc2UoU3RyaW5nKGlucHV0KSwgYmFzZSA/IFN0cmluZyhiYXNlKSA6IG51bGwpCn0KCmV4cG9ydHMuZmlsZVVSTFRvUGF0aCA9IGZ1bmN0aW9uIGZpbGVVUkxUb1BhdGgodXJsKSB7CiAgaWYgKHR5cGVvZiB1cmwgPT09ICdzdHJpbmcnKSB7CiAgICB1cmwgPSBuZXcgVVJMKHVybCkKICB9CgogIGlmICh1cmwucHJvdG9jb2wgIT09ICdmaWxlOicpIHsKICAgIHRocm93IGVycm9ycy5JTlZBTElEX1VSTF9TQ0hFTUUoJ1RoZSBVUkwgbXVzdCB1c2UgdGhlIGZpbGU6IHByb3RvY29sJykKICB9CgogIGlmIChpc1dpbmRvd3MpIHsKICAgIGlmICgvJTJmfCU1Yy9pLnRlc3QodXJsLnBhdGhuYW1lKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9GSUxFX1VSTF9QQVRIKAogICAgICAgICdUaGUgZmlsZTogVVJMIHBhdGggbXVzdCBub3QgaW5jbHVkZSBlbmNvZGVkIFxcIG9yIC8gY2hhcmFjdGVycycKICAgICAgKQogICAgfQogIH0gZWxzZSB7CiAgICBpZiAodXJsLmhvc3RuYW1lKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0ZJTEVfVVJMX0hPU1QoIlRoZSBmaWxlOiBVUkwgaG9zdCBtdXN0IGJlICdsb2NhbGhvc3QnIG9yIGVtcHR5IikKICAgIH0KCiAgICBpZiAoLyUyZi9pLnRlc3QodXJsLnBhdGhuYW1lKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9GSUxFX1VSTF9QQVRIKCdUaGUgZmlsZTogVVJMIHBhdGggbXVzdCBub3QgaW5jbHVkZSBlbmNvZGVkIC8gY2hhcmFjdGVycycpCiAgICB9CiAgfQoKICBjb25zdCBwYXRobmFtZSA9IHBhdGgubm9ybWFsaXplKGRlY29kZVVSSUNvbXBvbmVudCh1cmwucGF0aG5hbWUpKQoKICBpZiAoaXNXaW5kb3dzKSB7CiAgICBpZiAodXJsLmhvc3RuYW1lKSByZXR1cm4gJ1xcXFwnICsgdXJsLmhvc3RuYW1lICsgcGF0aG5hbWUKCiAgICBjb25zdCBsZXR0ZXIgPSBwYXRobmFtZS5jaGFyQ29kZUF0KDEpIHwgMHgyMAoKICAgIGlmIChsZXR0ZXIgPCAweDYxIC8qIGEgKi8gfHwgbGV0dGVyID4gMHg3YSAvKiB6ICovIHx8IHBhdGhuYW1lLmNoYXJDb2RlQXQoMikgIT09IDB4M2EgLyogOiAqLykgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9GSUxFX1VSTF9QQVRIKCdUaGUgZmlsZTogVVJMIHBhdGggbXVzdCBiZSBhYnNvbHV0ZScpCiAgICB9CgogICAgcmV0dXJuIHBhdGhuYW1lLnNsaWNlKDEpCiAgfQoKICByZXR1cm4gcGF0aG5hbWUKfQoKZXhwb3J0cy5wYXRoVG9GaWxlVVJMID0gZnVuY3Rpb24gcGF0aFRvRmlsZVVSTChwYXRobmFtZSkgewogIGxldCByZXNvbHZlZCA9IHBhdGgucmVzb2x2ZShwYXRobmFtZSkKCiAgaWYgKHBhdGhuYW1lW3BhdGhuYW1lLmxlbmd0aCAtIDFdID09PSAnLycpIHsKICAgIHJlc29sdmVkICs9ICcvJwogIH0gZWxzZSBpZiAoaXNXaW5kb3dzICYmIHBhdGhuYW1lW3BhdGhuYW1lLmxlbmd0aCAtIDFdID09PSAnXFwnKSB7CiAgICByZXNvbHZlZCArPSAnXFwnCiAgfQoKICByZXNvbHZlZCA9IHJlc29sdmVkCiAgICAucmVwbGFjZUFsbCgnJScsICclMjUnKSAvLyBNdXN0IGJlIGZpcnN0CiAgICAucmVwbGFjZUFsbCgnIycsICclMjMnKQogICAgLnJlcGxhY2VBbGwoJz8nLCAnJTNmJykKICAgIC5yZXBsYWNlQWxsKCdcbicsICclMGEnKQogICAgLnJlcGxhY2VBbGwoJ1xyJywgJyUwZCcpCiAgICAucmVwbGFjZUFsbCgnXHQnLCAnJTA5JykKCiAgaWYgKCFpc1dpbmRvd3MpIHsKICAgIHJlc29sdmVkID0gcmVzb2x2ZWQucmVwbGFjZUFsbCgnXFwnLCAnJTVjJykKICB9CgogIHJldHVybiBuZXcgVVJMKCdmaWxlOicgKyByZXNvbHZlZCkKfQoKZXhwb3J0cy5mb3JtYXQgPSBmdW5jdGlvbiBmb3JtYXQocGFydHMpIHsKICBjb25zdCB7IHByb3RvY29sLCBhdXRoLCBob3N0LCBob3N0bmFtZSwgcG9ydCwgcGF0aG5hbWUsIHNlYXJjaCwgcXVlcnksIGhhc2gsIHNsYXNoZXMgfSA9IHBhcnRzCgogIGxldCByZXN1bHQgPSAnJwoKICBpZiAodHlwZW9mIHByb3RvY29sID09PSAnc3RyaW5nJykgewogICAgcmVzdWx0ICs9IHByb3RvY29sCgogICAgaWYgKHByb3RvY29sW3Byb3RvY29sLmxlbmd0aCAtIDFdICE9PSAnOicpIHsKICAgICAgcmVzdWx0ICs9ICc6JwogICAgfQoKICAgIGlmIChzbGFzaGVzID09PSB0cnVlIHx8IC9odHRwcz98ZnRwfGdvcGhlcnxmaWxlLy50ZXN0KHByb3RvY29sKSkgewogICAgICByZXN1bHQgKz0gJy8vJwogICAgfQogIH0KCiAgaWYgKHR5cGVvZiBhdXRoID09PSAnc3RyaW5nJykgewogICAgaWYgKGhvc3QgfHwgaG9zdG5hbWUpIHJlc3VsdCArPSBhdXRoICsgJ0AnCiAgfQoKICBpZiAodHlwZW9mIGhvc3QgPT09ICdzdHJpbmcnKSByZXN1bHQgKz0gaG9zdAogIGVsc2UgewogICAgcmVzdWx0ICs9IGhvc3RuYW1lCgogICAgaWYgKHBvcnQpIHJlc3VsdCArPSAnOicgKyBwb3J0CiAgfQoKICBpZiAodHlwZW9mIHBhdGhuYW1lID09PSAnc3RyaW5nJyAmJiBwYXRobmFtZSAhPT0gJycpIHsKICAgIGlmIChwYXRobmFtZVswXSAhPT0gJy8nKSByZXN1bHQgKz0gJy8nCiAgICByZXN1bHQgKz0gcGF0aG5hbWUKICB9CgogIGlmICh0eXBlb2Ygc2VhcmNoID09PSAnc3RyaW5nJykgewogICAgaWYgKHNlYXJjaFswXSAhPT0gJz8nKSByZXN1bHQgKz0gJz8nCiAgICByZXN1bHQgKz0gc2VhcmNoCiAgfSBlbHNlIGlmICh0eXBlb2YgcXVlcnkgPT09ICdvYmplY3QnICYmIHF1ZXJ5ICE9PSBudWxsKSB7CiAgICByZXN1bHQgKz0gJz8nICsgbmV3IFVSTFNlYXJjaFBhcmFtcyhxdWVyeSkKICB9CgogIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3N0cmluZycpIHsKICAgIGlmIChoYXNoWzBdICE9PSAnIycpIHJlc3VsdCArPSAnIycKICAgIHJlc3VsdCArPSBoYXNoCiAgfQoKICByZXR1cm4gcmVzdWx0Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBVUkxFcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3Rvcihtc2csIGZuID0gVVJMRXJyb3IsIGNvZGUgPSBmbi5uYW1lKSB7CiAgICBzdXBlcihgJHtjb2RlfTogJHttc2d9YCkKCiAgICB0aGlzLmNvZGUgPSBjb2RlCgogICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBmbikKICB9CgogIGdldCBuYW1lKCkgewogICAgcmV0dXJuICdVUkxFcnJvcicKICB9CgogIHN0YXRpYyBJTlZBTElEX1VSTChtc2csIGlucHV0KSB7CiAgICBjb25zdCBlcnIgPSBuZXcgVVJMRXJyb3IobXNnLCBVUkxFcnJvci5JTlZBTElEX1VSTCkKCiAgICBlcnIuaW5wdXQgPSBpbnB1dAoKICAgIHJldHVybiBlcnIKICB9CgogIHN0YXRpYyBJTlZBTElEX1VSTF9TQ0hFTUUobXNnID0gJ0ludmFsaWQgVVJMJykgewogICAgcmV0dXJuIG5ldyBVUkxFcnJvcihtc2csIFVSTEVycm9yLklOVkFMSURfVVJMX1NDSEVNRSkKICB9CgogIHN0YXRpYyBJTlZBTElEX0ZJTEVfVVJMX0hPU1QobXNnID0gJ0ludmFsaWQgZmlsZTogVVJMIGhvc3QnKSB7CiAgICByZXR1cm4gbmV3IFVSTEVycm9yKG1zZywgVVJMRXJyb3IuSU5WQUxJRF9GSUxFX1VSTF9IT1NUKQogIH0KCiAgc3RhdGljIElOVkFMSURfRklMRV9VUkxfUEFUSChtc2cgPSAnSW52YWxpZCBmaWxlOiBVUkwgcGF0aCcpIHsKICAgIHJldHVybiBuZXcgVVJMRXJyb3IobXNnLCBVUkxFcnJvci5JTlZBTElEX0ZJTEVfVVJMX1BBVEgpCiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVVJMU2VhcmNoUGFyYW1zIHsKICBzdGF0aWMgX3VybHMgPSBuZXcgV2Vha01hcCgpCgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybHNlYXJjaHBhcmFtcy11cmxzZWFyY2hwYXJhbXMKICBjb25zdHJ1Y3Rvcihpbml0LCB1cmwgPSBudWxsKSB7CiAgICB0aGlzLl9wYXJhbXMgPSBuZXcgTWFwKCkKCiAgICBpZiAodXJsKSBVUkxTZWFyY2hQYXJhbXMuX3VybHMuc2V0KHRoaXMsIHVybCkKCiAgICBpZiAodHlwZW9mIGluaXQgPT09ICdzdHJpbmcnKSB7CiAgICAgIHRoaXMuX3BhcnNlKGluaXQpCiAgICB9IGVsc2UgaWYgKGluaXQpIHsKICAgICAgZm9yIChjb25zdCBbbmFtZSwgdmFsdWVdIG9mIHR5cGVvZiBpbml0W1N5bWJvbC5pdGVyYXRvcl0gPT09ICdmdW5jdGlvbicKICAgICAgICA/IGluaXQKICAgICAgICA6IE9iamVjdC5lbnRyaWVzKGluaXQpKSB7CiAgICAgICAgdGhpcy5hcHBlbmQobmFtZSwgdmFsdWUpCiAgICAgIH0KICAgIH0KICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybHNlYXJjaHBhcmFtcy1zaXplCiAgZ2V0IHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5fcGFyYW1zLmxlbmd0aAogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsc2VhcmNocGFyYW1zLWFwcGVuZAogIGFwcGVuZChuYW1lLCB2YWx1ZSA9IG51bGwpIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuCgogICAgbGV0IGxpc3QgPSB0aGlzLl9wYXJhbXMuZ2V0KG5hbWUpCgogICAgaWYgKGxpc3QgPT09IHVuZGVmaW5lZCkgewogICAgICBsaXN0ID0gW10KICAgICAgdGhpcy5fcGFyYW1zLnNldChuYW1lLCBsaXN0KQogICAgfQoKICAgIGxpc3QucHVzaCh2YWx1ZSkKCiAgICB0aGlzLl91cGRhdGUoKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsc2VhcmNocGFyYW1zLWRlbGV0ZQogIGRlbGV0ZShuYW1lLCB2YWx1ZSA9IG51bGwpIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgdGhpcy5fcGFyYW1zLmRlbGV0ZShuYW1lKQogICAgZWxzZSB7CiAgICAgIGxldCBsaXN0ID0gdGhpcy5fcGFyYW1zLmdldChuYW1lKQoKICAgICAgaWYgKGxpc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBsaXN0ID0gbGlzdC5maWx0ZXIoKGZvdW5kKSA9PiBmb3VuZCAhPT0gdmFsdWUpCgogICAgICBpZiAobGlzdC5sZW5ndGggPT09IDApIHRoaXMuX3BhcmFtcy5kZWxldGUobmFtZSkKICAgICAgZWxzZSB0aGlzLl9wYXJhbXMuc2V0KG5hbWUsIGxpc3QpCiAgICB9CgogICAgdGhpcy5fdXBkYXRlKCkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybHNlYXJjaHBhcmFtcy1nZXQKICBnZXQobmFtZSkgewogICAgY29uc3QgbGlzdCA9IHRoaXMuX3BhcmFtcy5nZXQobmFtZSkKCiAgICBpZiAobGlzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbAoKICAgIHJldHVybiBsaXN0WzBdCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmxzZWFyY2hwYXJhbXMtZ2V0YWxsCiAgZ2V0QWxsKG5hbWUpIHsKICAgIGNvbnN0IGxpc3QgPSB0aGlzLl9wYXJhbXMuZ2V0KG5hbWUpCgogICAgaWYgKGxpc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuIFtdCgogICAgcmV0dXJuIEFycmF5LmZyb20obGlzdCkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybHNlYXJjaHBhcmFtcy1oYXMKICBoYXMobmFtZSwgdmFsdWUgPSBudWxsKSB7CiAgICBjb25zdCBsaXN0ID0gdGhpcy5fcGFyYW1zLmdldChuYW1lKQoKICAgIGlmIChsaXN0ID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZQoKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIHRydWUKCiAgICByZXR1cm4gbGlzdC5pbmNsdWRlcyh2YWx1ZSkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybHNlYXJjaHBhcmFtcy1zZXQKICBzZXQobmFtZSwgdmFsdWUgPSBudWxsKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwpIHRoaXMuX3BhcmFtcy5kZWxldGUobmFtZSkKICAgIGVsc2UgdGhpcy5fcGFyYW1zLnNldChuYW1lLCBbdmFsdWVdKQoKICAgIHRoaXMuX3VwZGF0ZSgpCiAgfQoKICB0b1N0cmluZygpIHsKICAgIHJldHVybiB0aGlzLl9zZXJpYWxpemUoKQogIH0KCiAgdG9KU09OKCkgewogICAgcmV0dXJuIFsuLi50aGlzXQogIH0KCiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgZm9yIChjb25zdCBbbmFtZSwgdmFsdWVzXSBvZiB0aGlzLl9wYXJhbXMpIHsKICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiB2YWx1ZXMpIHlpZWxkIFtuYW1lLCB2YWx1ZV0KICAgIH0KICB9CgogIFtTeW1ib2wuZm9yKCdiYXJlLmluc3BlY3QnKV0oKSB7CiAgICBjb25zdCBvYmplY3QgPSB7CiAgICAgIF9fcHJvdG9fXzogeyBjb25zdHJ1Y3RvcjogVVJMU2VhcmNoUGFyYW1zIH0KICAgIH0KCiAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZXNdIG9mIHRoaXMuX3BhcmFtcykgewogICAgICBpZiAodmFsdWVzLmxlbmd0aCA9PT0gMSkgb2JqZWN0W25hbWVdID0gdmFsdWVzWzBdCiAgICAgIGVsc2Ugb2JqZWN0W25hbWVdID0gdmFsdWVzCiAgICB9CgogICAgcmV0dXJuIG9iamVjdAogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LXVybHNlYXJjaHBhcmFtcy11cGRhdGUKICBfdXBkYXRlKCkgewogICAgY29uc3QgdXJsID0gVVJMU2VhcmNoUGFyYW1zLl91cmxzLmdldCh0aGlzKQoKICAgIGlmICh1cmwgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgdXJsLnNlYXJjaCA9IHRoaXMuX3NlcmlhbGl6ZSgpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtdXJsZW5jb2RlZC1wYXJzZXIKICBfcGFyc2UoaW5wdXQpIHsKICAgIGlmIChpbnB1dFswXSA9PT0gJz8nKSBpbnB1dCA9IGlucHV0LnN1YnN0cmluZygxKQoKICAgIHRoaXMuX3BhcmFtcyA9IG5ldyBNYXAoKQoKICAgIGZvciAoY29uc3Qgc2VxdWVuY2Ugb2YgaW5wdXQuc3BsaXQoJyYnKSkgewogICAgICBpZiAoc2VxdWVuY2UubGVuZ3RoID09PSAwKSBjb250aW51ZQoKICAgICAgbGV0IGkgPSBzZXF1ZW5jZS5pbmRleE9mKCc9JykKICAgICAgaWYgKGkgPT09IC0xKSBpID0gc2VxdWVuY2UubGVuZ3RoCgogICAgICBjb25zdCBuYW1lID0gZGVjb2RlVVJJQ29tcG9uZW50KHNlcXVlbmNlLnN1YnN0cmluZygwLCBpKSkKICAgICAgY29uc3QgdmFsdWUgPSBkZWNvZGVVUklDb21wb25lbnQoc2VxdWVuY2Uuc3Vic3RyaW5nKGkgKyAxLCBzZXF1ZW5jZS5sZW5ndGgpKQoKICAgICAgbGV0IGxpc3QgPSB0aGlzLl9wYXJhbXMuZ2V0KG5hbWUpCgogICAgICBpZiAobGlzdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgbGlzdCA9IFtdCiAgICAgICAgdGhpcy5fcGFyYW1zLnNldChuYW1lLCBsaXN0KQogICAgICB9CgogICAgICBsaXN0LnB1c2godmFsdWUpCiAgICB9CiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtdXJsZW5jb2RlZC1zZXJpYWxpemVyCiAgX3NlcmlhbGl6ZSgpIHsKICAgIGxldCBvdXRwdXQgPSAnJwoKICAgIGZvciAobGV0IFtuYW1lLCB2YWx1ZXNdIG9mIHRoaXMuX3BhcmFtcykgewogICAgICBuYW1lID0gZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpCgogICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICAgIGlmIChvdXRwdXQpIG91dHB1dCArPSAnJicKCiAgICAgICAgb3V0cHV0ICs9IG5hbWUgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gb3V0cHV0CiAgfQp9CnsKICAibmFtZSI6ICJiYXJlLXVybCIsCiAgInZlcnNpb24iOiAiMi4zLjIiLAogICJkZXNjcmlwdGlvbiI6ICJXSEFUV0cgVVJMIGltcGxlbWVudGF0aW9uIGZvciBKYXZhU2NyaXB0IiwKICAiZXhwb3J0cyI6IHsKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4iOiB7CiAgICAgICJ0eXBlcyI6ICIuL2luZGV4LmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2luZGV4LmpzIgogICAgfSwKICAgICIuL2dsb2JhbCI6IHsKICAgICAgInR5cGVzIjogIi4vZ2xvYmFsLmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2dsb2JhbC5qcyIKICAgIH0KICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiaW5kZXguZC50cyIsCiAgICAiZ2xvYmFsLmpzIiwKICAgICJnbG9iYWwuZC50cyIsCiAgICAiYmluZGluZy5jIiwKICAgICJiaW5kaW5nLmpzIiwKICAgICJDTWFrZUxpc3RzLnR4dCIsCiAgICAibGliIiwKICAgICJwcmVidWlsZHMiCiAgXSwKICAiYWRkb24iOiB0cnVlLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJhcmUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXVybC5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXVybC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtdXJsIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtcGF0aCI6ICJeMy4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMy4yIiwKICAgICJjbWFrZS1iYXJlIjogIl4xLjEuNiIsCiAgICAiY21ha2UtZmV0Y2giOiAiXjEuMC4wIiwKICAgICJwcmV0dGllciI6ICJeMy4zLjMiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0KfQpjb25zdCBGQUNUT1IgPSBuZXcgVWludDE2QXJyYXkoOCkKCmZ1bmN0aW9uIGZhY3RvcjQwOTYgKGksIG4pIHsKICB3aGlsZSAobiA+IDApIHsKICAgIGNvbnN0IGYgPSBpICYgNDA5NQogICAgRkFDVE9SWy0tbl0gPSBmCiAgICBpID0gKGkgLSBmKSAvIDQwOTYKICB9CiAgcmV0dXJuIEZBQ1RPUgp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEJpZ1NwYXJzZUFycmF5IHsKICBjb25zdHJ1Y3RvciAoKSB7CiAgICB0aGlzLnRpbnkgPSBuZXcgVGlueUFycmF5KCkKICAgIHRoaXMubWF4TGVuZ3RoID0gNDA5NgogICAgdGhpcy5mYWN0b3IgPSAxCiAgfQoKICBzZXQgKGluZGV4LCB2YWwpIHsKICAgIGlmICh2YWwgIT09IHVuZGVmaW5lZCkgewogICAgICB3aGlsZSAoaW5kZXggPj0gdGhpcy5tYXhMZW5ndGgpIHsKICAgICAgICB0aGlzLm1heExlbmd0aCAqPSA0MDk2CiAgICAgICAgdGhpcy5mYWN0b3IrKwogICAgICAgIGlmICghdGhpcy50aW55LmlzRW1wdHlpc2goKSkgewogICAgICAgICAgY29uc3QgdCA9IG5ldyBUaW55QXJyYXkoKQogICAgICAgICAgdC5zZXQoMCwgdGhpcy50aW55KQogICAgICAgICAgdGhpcy50aW55ID0gdAogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGNvbnN0IGYgPSBmYWN0b3I0MDk2KGluZGV4LCB0aGlzLmZhY3RvcikKICAgIGNvbnN0IGxhc3QgPSB0aGlzLmZhY3RvciAtIDEKCiAgICBsZXQgdGlueSA9IHRoaXMudGlueQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsYXN0OyBpKyspIHsKICAgICAgY29uc3QgbmV4dCA9IHRpbnkuZ2V0KGZbaV0pCiAgICAgIGlmIChuZXh0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAodmFsID09PSB1bmRlZmluZWQpIHJldHVybgogICAgICAgIHRpbnkgPSB0aW55LnNldChmW2ldLCBuZXcgVGlueUFycmF5KCkpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGlueSA9IG5leHQKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aW55LnNldChmW2xhc3RdLCB2YWwpCiAgfQoKICBnZXQgKGluZGV4KSB7CiAgICBpZiAoaW5kZXggPj0gdGhpcy5tYXhMZW5ndGgpIHJldHVybgoKICAgIGNvbnN0IGYgPSBmYWN0b3I0MDk2KGluZGV4LCB0aGlzLmZhY3RvcikKICAgIGNvbnN0IGxhc3QgPSB0aGlzLmZhY3RvciAtIDEKCiAgICBsZXQgdGlueSA9IHRoaXMudGlueQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsYXN0OyBpKyspIHsKICAgICAgdGlueSA9IHRpbnkuZ2V0KGZbaV0pCiAgICAgIGlmICh0aW55ID09PSB1bmRlZmluZWQpIHJldHVybgogICAgfQoKICAgIHJldHVybiB0aW55LmdldChmW2xhc3RdKQogIH0KfQoKY2xhc3MgVGlueUFycmF5IHsKICBjb25zdHJ1Y3RvciAoKSB7CiAgICB0aGlzLnMgPSAwCiAgICB0aGlzLmIgPSBuZXcgQXJyYXkoMSkKICAgIHRoaXMuZiA9IG5ldyBVaW50MTZBcnJheSgxKQogIH0KCiAgaXNFbXB0eWlzaCAoKSB7CiAgICByZXR1cm4gdGhpcy5iLmxlbmd0aCA9PT0gMSAmJiB0aGlzLmJbMF0gPT09IHVuZGVmaW5lZAogIH0KCiAgZ2V0IChpKSB7CiAgICBpZiAodGhpcy5zID09PSAxMikgcmV0dXJuIHRoaXMuYltpXQogICAgY29uc3QgZiA9IGkgPj4+IHRoaXMucwogICAgY29uc3QgciA9IGkgJiAodGhpcy5iLmxlbmd0aCAtIDEpCiAgICByZXR1cm4gdGhpcy5mW3JdID09PSBmID8gdGhpcy5iW3JdIDogdW5kZWZpbmVkCiAgfQoKICBzZXQgKGksIHYpIHsKICAgIHdoaWxlICh0aGlzLnMgIT09IDEyKSB7CiAgICAgIGNvbnN0IGYgPSBpID4+PiB0aGlzLnMKICAgICAgY29uc3QgciA9IGkgJiAodGhpcy5iLmxlbmd0aCAtIDEpCiAgICAgIGNvbnN0IG8gPSB0aGlzLmJbcl0KCiAgICAgIGlmIChvID09PSB1bmRlZmluZWQgfHwgZiA9PT0gdGhpcy5mW3JdKSB7CiAgICAgICAgdGhpcy5iW3JdID0gdgogICAgICAgIHRoaXMuZltyXSA9IGYKICAgICAgICByZXR1cm4gdgogICAgICB9CgogICAgICB0aGlzLmdyb3coKQogICAgfQoKICAgIHRoaXMuYltpXSA9IHYKICAgIHJldHVybiB2CiAgfQoKICBncm93ICgpIHsKICAgIGNvbnN0IG9zID0gdGhpcy5zCiAgICBjb25zdCBvYiA9IHRoaXMuYgogICAgY29uc3Qgb2YgPSB0aGlzLmYKCiAgICB0aGlzLnMgKz0gNAogICAgdGhpcy5iID0gbmV3IEFycmF5KHRoaXMuYi5sZW5ndGggPDwgNCkKICAgIHRoaXMuZiA9IHRoaXMucyA9PT0gMTIgPyBudWxsIDogbmV3IFVpbnQ4QXJyYXkodGhpcy5iLmxlbmd0aCkKCiAgICBjb25zdCBtID0gdGhpcy5iLmxlbmd0aCAtIDEKCiAgICBmb3IgKGxldCBvciA9IDA7IG9yIDwgb2IubGVuZ3RoOyBvcisrKSB7CiAgICAgIGlmIChvYltvcl0gPT09IHVuZGVmaW5lZCkgY29udGludWUKCiAgICAgIGNvbnN0IGkgPSBvZltvcl0gPDwgb3MgfCBvcgogICAgICBjb25zdCBmID0gaSA+Pj4gdGhpcy5zCiAgICAgIGNvbnN0IHIgPSBpICYgbQoKICAgICAgdGhpcy5iW3JdID0gb2Jbb3JdCiAgICAgIGlmICh0aGlzLnMgIT09IDEyKSB0aGlzLmZbcl0gPSBmCiAgICB9CiAgfQp9CnsKICAibmFtZSI6ICJiaWctc3BhcnNlLWFycmF5IiwKICAidmVyc2lvbiI6ICIxLjAuMyIsCiAgImRlc2NyaXB0aW9uIjogIkEgc3BhcnNlIGFycmF5IG9wdGltaXNlZCBmb3IgbG93IG1lbW9yeSB3aGlsc3Qgc3RpbGwgYmVpbmcgZmFzdCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMS4xIiwKICAgICJzdGFuZGFyZCI6ICJeMTYuMC4zIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvYmlnLXNwYXJzZS1hcnJheS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvYmlnLXNwYXJzZS1hcnJheS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9iaWctc3BhcnNlLWFycmF5Igp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpmdW5jdGlvbiBieXRlTGVuZ3RoIChzaXplKSB7CiAgcmV0dXJuIE1hdGguY2VpbChzaXplIC8gOCkKfQoKZnVuY3Rpb24gZ2V0IChidWZmZXIsIGJpdCkgewogIGNvbnN0IG4gPSBidWZmZXIuQllURVNfUEVSX0VMRU1FTlQgKiA4CgogIGNvbnN0IG9mZnNldCA9IGJpdCAmIChuIC0gMSkKICBjb25zdCBpID0gKGJpdCAtIG9mZnNldCkgLyBuCgogIHJldHVybiAoYnVmZmVyW2ldICYgKDEgPDwgb2Zmc2V0KSkgIT09IDAKfQoKZnVuY3Rpb24gc2V0IChidWZmZXIsIGJpdCwgdmFsdWUgPSB0cnVlKSB7CiAgY29uc3QgbiA9IGJ1ZmZlci5CWVRFU19QRVJfRUxFTUVOVCAqIDgKCiAgY29uc3Qgb2Zmc2V0ID0gYml0ICYgKG4gLSAxKQogIGNvbnN0IGkgPSAoYml0IC0gb2Zmc2V0KSAvIG4KICBjb25zdCBtYXNrID0gMSA8PCBvZmZzZXQKCiAgaWYgKHZhbHVlKSB7CiAgICBpZiAoKGJ1ZmZlcltpXSAmIG1hc2spICE9PSAwKSByZXR1cm4gZmFsc2UKICB9IGVsc2UgewogICAgaWYgKChidWZmZXJbaV0gJiBtYXNrKSA9PT0gMCkgcmV0dXJuIGZhbHNlCiAgfQoKICBidWZmZXJbaV0gXj0gbWFzawogIHJldHVybiB0cnVlCn0KCmZ1bmN0aW9uIHNldFJhbmdlIChidWZmZXIsIHN0YXJ0LCBlbmQsIHZhbHVlID0gdHJ1ZSkgewogIGNvbnN0IG4gPSBidWZmZXIuQllURVNfUEVSX0VMRU1FTlQgKiA4CgogIGxldCByZW1haW5pbmcgPSBlbmQgLSBzdGFydAogIGxldCBvZmZzZXQgPSBzdGFydCAmIChuIC0gMSkKICBsZXQgaSA9IChzdGFydCAtIG9mZnNldCkgLyBuCgogIGxldCBjaGFuZ2VkID0gZmFsc2UKCiAgd2hpbGUgKHJlbWFpbmluZyA+IDApIHsKICAgIGNvbnN0IG1hc2sgPSAoMiAqKiBNYXRoLm1pbihyZW1haW5pbmcsIG4gLSBvZmZzZXQpIC0gMSkgPDwgb2Zmc2V0CgogICAgaWYgKHZhbHVlKSB7CiAgICAgIGlmICgoYnVmZmVyW2ldICYgbWFzaykgIT09IG1hc2spIHsKICAgICAgICBidWZmZXJbaV0gfD0gbWFzawogICAgICAgIGNoYW5nZWQgPSB0cnVlCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmICgoYnVmZmVyW2ldICYgbWFzaykgIT09IDApIHsKICAgICAgICBidWZmZXJbaV0gJj0gfm1hc2sKICAgICAgICBjaGFuZ2VkID0gdHJ1ZQogICAgICB9CiAgICB9CgogICAgcmVtYWluaW5nIC09IG4gLSBvZmZzZXQKICAgIG9mZnNldCA9IDAKICAgIGkrKwogIH0KCiAgcmV0dXJuIGNoYW5nZWQKfQoKZnVuY3Rpb24gZmlsbCAoYnVmZmVyLCB2YWx1ZSwgc3RhcnQgPSAwLCBlbmQgPSBidWZmZXIuYnl0ZUxlbmd0aCAqIDgpIHsKICBjb25zdCBuID0gYnVmZmVyLkJZVEVTX1BFUl9FTEVNRU5UICogOAogIGxldCBpLCBqCgogIHsKICAgIGNvbnN0IG9mZnNldCA9IHN0YXJ0ICYgKG4gLSAxKQogICAgaSA9IChzdGFydCAtIG9mZnNldCkgLyBuCgogICAgaWYgKG9mZnNldCAhPT0gMCkgewogICAgICBjb25zdCBtYXNrID0gKDIgKiogTWF0aC5taW4obiAtIG9mZnNldCwgZW5kIC0gc3RhcnQpIC0gMSkgPDwgb2Zmc2V0CgogICAgICBpZiAodmFsdWUpIGJ1ZmZlcltpXSB8PSBtYXNrCiAgICAgIGVsc2UgYnVmZmVyW2ldICY9IH5tYXNrCgogICAgICBpKysKICAgIH0KICB9CgogIHsKICAgIGNvbnN0IG9mZnNldCA9IGVuZCAmIChuIC0gMSkKICAgIGogPSAoZW5kIC0gb2Zmc2V0KSAvIG4KCiAgICBpZiAob2Zmc2V0ICE9PSAwICYmIGogPj0gaSkgewogICAgICBjb25zdCBtYXNrID0gKDIgKiogb2Zmc2V0KSAtIDEKCiAgICAgIGlmICh2YWx1ZSkgYnVmZmVyW2pdIHw9IG1hc2sKICAgICAgZWxzZSBidWZmZXJbal0gJj0gfm1hc2sKICAgIH0KICB9CgogIHJldHVybiBidWZmZXIuZmlsbCh2YWx1ZSA/ICgyICoqIG4pIC0gMSA6IDAsIGksIGopCn0KCmZ1bmN0aW9uIHRvZ2dsZSAoYnVmZmVyLCBiaXQpIHsKICBjb25zdCBuID0gYnVmZmVyLkJZVEVTX1BFUl9FTEVNRU5UICogOAoKICBjb25zdCBvZmZzZXQgPSBiaXQgJiAobiAtIDEpCiAgY29uc3QgaSA9IChiaXQgLSBvZmZzZXQpIC8gbgogIGNvbnN0IG1hc2sgPSAxIDw8IG9mZnNldAoKICBidWZmZXJbaV0gXj0gbWFzawogIHJldHVybiAoYnVmZmVyW2ldICYgbWFzaykgIT09IDAKfQoKZnVuY3Rpb24gcmVtb3ZlIChidWZmZXIsIGJpdCkgewogIHJldHVybiBzZXQoYnVmZmVyLCBiaXQsIGZhbHNlKQp9CgpmdW5jdGlvbiByZW1vdmVSYW5nZSAoYnVmZmVyLCBzdGFydCwgZW5kKSB7CiAgcmV0dXJuIHNldFJhbmdlKGJ1ZmZlciwgc3RhcnQsIGVuZCwgZmFsc2UpCn0KCmZ1bmN0aW9uIGluZGV4T2YgKGJ1ZmZlciwgdmFsdWUsIHBvc2l0aW9uID0gMCkgewogIGZvciAobGV0IGkgPSBwb3NpdGlvbiwgbiA9IGJ1ZmZlci5ieXRlTGVuZ3RoICogODsgaSA8IG47IGkrKykgewogICAgaWYgKGdldChidWZmZXIsIGkpID09PSB2YWx1ZSkgcmV0dXJuIGkKICB9CgogIHJldHVybiAtMQp9CgpmdW5jdGlvbiBsYXN0SW5kZXhPZiAoYnVmZmVyLCB2YWx1ZSwgcG9zaXRpb24gPSBidWZmZXIuYnl0ZUxlbmd0aCAqIDggLSAxKSB7CiAgZm9yIChsZXQgaSA9IHBvc2l0aW9uOyBpID49IDA7IGktLSkgewogICAgaWYgKGdldChidWZmZXIsIGkpID09PSB2YWx1ZSkgcmV0dXJuIGkKICB9CgogIHJldHVybiAtMQp9CgpmdW5jdGlvbiBvZiAoLi4uYml0cykgewogIHJldHVybiBmcm9tKGJpdHMpCn0KCmZ1bmN0aW9uIGZyb20gKGJpdHMpIHsKICBjb25zdCBidWZmZXIgPSBiNGEuYWxsb2MoYnl0ZUxlbmd0aChiaXRzLmxlbmd0aCkpCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBiaXRzLmxlbmd0aDsgaSsrKSBzZXQoYnVmZmVyLCBpLCBiaXRzW2ldKQogIHJldHVybiBidWZmZXIKfQoKZnVuY3Rpb24gKiBpdGVyYXRvciAoYnVmZmVyKSB7CiAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWZmZXIuYnl0ZUxlbmd0aCAqIDg7IGkgPCBuOyBpKyspIHlpZWxkIGdldChidWZmZXIsIGkpCn0KCm1vZHVsZS5leHBvcnRzID0gewogIGJ5dGVMZW5ndGgsCiAgZ2V0LAogIHNldCwKICBzZXRSYW5nZSwKICBmaWxsLAogIHRvZ2dsZSwKICByZW1vdmUsCiAgcmVtb3ZlUmFuZ2UsCiAgaW5kZXhPZiwKICBsYXN0SW5kZXhPZiwKICBvZiwKICBmcm9tLAogIGl0ZXJhdG9yCn0KewogICJuYW1lIjogImJpdHMtdG8tYnl0ZXMiLAogICJ2ZXJzaW9uIjogIjEuMy4wIiwKICAiZGVzY3JpcHRpb24iOiAiRnVuY3Rpb25zIGZvciBkb2luZyBiaXQgbWFuaXB1bGF0aW9uIG9mIHR5cGVkIGFycmF5cyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0Lm1qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iaXRzLXRvLWJ5dGVzLmdpdCIKICB9LAogICJhdXRob3IiOiAiS2FzcGVyIElzYWdlciBEYWxzZ2Fyw7AgPGthc3BlckBmdW5rdGlvbmVsLmNvPiIsCiAgImxpY2Vuc2UiOiAiSVNDIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JpdHMtdG8tYnl0ZXMvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iaXRzLXRvLWJ5dGVzI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNS4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4yLjMuMSIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9Cn0KY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykKY29uc3QgUHJvdG9tdXggPSByZXF1aXJlKCdwcm90b211eCcpCmNvbnN0IHsgUmVhZGFibGUgfSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiaXRmaWVsZCA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmctYml0ZmllbGQnKQpjb25zdCBiaXRzID0gcmVxdWlyZSgnYml0cy10by1ieXRlcycpCmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4vbGliL2Vycm9ycycpCgpleHBvcnRzLlNlcnZlciA9IGNsYXNzIEJsaW5kUmVsYXlTZXJ2ZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICBjb25zdCB7CiAgICAgIGNyZWF0ZVN0cmVhbQogICAgfSA9IG9wdHMKCiAgICB0aGlzLl9jcmVhdGVTdHJlYW0gPSBjcmVhdGVTdHJlYW0KICAgIHRoaXMuX3BhaXJpbmcgPSBuZXcgTWFwKCkKICAgIHRoaXMuX3Nlc3Npb25zID0gbmV3IFNldCgpCiAgfQoKICBnZXQgc2Vzc2lvbnMgKCkgewogICAgcmV0dXJuIHRoaXMuX3Nlc3Npb25zW1N5bWJvbC5pdGVyYXRvcl0oKQogIH0KCiAgYWNjZXB0IChzdHJlYW0sIG9wdHMpIHsKICAgIGNvbnN0IHNlc3Npb24gPSBuZXcgQmxpbmRSZWxheVNlc3Npb24odGhpcywgc3RyZWFtLCBvcHRzKQoKICAgIHRoaXMuX3Nlc3Npb25zLmFkZChzZXNzaW9uKQoKICAgIHJldHVybiBzZXNzaW9uCiAgfQoKICBhc3luYyBjbG9zZSAoKSB7CiAgICBjb25zdCBlbmRpbmcgPSBbXQoKICAgIGZvciAoY29uc3Qgc2Vzc2lvbiBvZiB0aGlzLl9zZXNzaW9ucykgewogICAgICBlbmRpbmcucHVzaChzZXNzaW9uLmVuZCgpKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsKGVuZGluZykKCiAgICB0aGlzLl9wYWlyaW5nLmNsZWFyKCkKICB9Cn0KCmNsYXNzIEJsaW5kUmVsYXlTZXNzaW9uIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvciAoc2VydmVyLCBzdHJlYW0sIG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIGNvbnN0IHsKICAgICAgaWQsCiAgICAgIGhhbmRzaGFrZSwKICAgICAgaGFuZHNoYWtlRW5jb2RpbmcKICAgIH0gPSBvcHRzCgogICAgdGhpcy5fc2VydmVyID0gc2VydmVyCiAgICB0aGlzLl9tdXggPSBQcm90b211eC5mcm9tKHN0cmVhbSkKCiAgICB0aGlzLl9jaGFubmVsID0gdGhpcy5fbXV4LmNyZWF0ZUNoYW5uZWwoewogICAgICBwcm90b2NvbDogJ2JsaW5kLXJlbGF5JywKICAgICAgaWQsCiAgICAgIGhhbmRzaGFrZTogaGFuZHNoYWtlID8gaGFuZHNoYWtlRW5jb2RpbmcgfHwgYy5yYXcgOiBudWxsLAogICAgICBvbm9wZW46IHRoaXMuX29ub3Blbi5iaW5kKHRoaXMpLAogICAgICBvbmNsb3NlOiB0aGlzLl9vbmNsb3NlLmJpbmQodGhpcyksCiAgICAgIG9uZGVzdHJveTogdGhpcy5fb25kZXN0cm95LmJpbmQodGhpcykKICAgIH0pCgogICAgdGhpcy5fcGFpciA9IHRoaXMuX2NoYW5uZWwuYWRkTWVzc2FnZSh7CiAgICAgIGVuY29kaW5nOiBtLnBhaXIsCiAgICAgIG9ubWVzc2FnZTogdGhpcy5fb25wYWlyLmJpbmQodGhpcykKICAgIH0pCgogICAgdGhpcy5fdW5wYWlyID0gdGhpcy5fY2hhbm5lbC5hZGRNZXNzYWdlKHsKICAgICAgZW5jb2Rpbmc6IG0udW5wYWlyLAogICAgICBvbm1lc3NhZ2U6IHRoaXMuX29udW5wYWlyLmJpbmQodGhpcykKICAgIH0pCgogICAgdGhpcy5fZW5kaW5nID0gbnVsbAogICAgdGhpcy5fZGVzdHJveWVkID0gZmFsc2UKICAgIHRoaXMuX2Vycm9yID0gbnVsbAogICAgdGhpcy5fcGFpcmluZyA9IG5ldyBTZXQoKQogICAgdGhpcy5fc3RyZWFtcyA9IG5ldyBNYXAoKQoKICAgIHRoaXMuX29uZXJyb3IgPSAoZXJyKSA9PiB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyKQoKICAgIHRoaXMuX2NoYW5uZWwub3BlbihoYW5kc2hha2UpCiAgfQoKICBnZXQgY2xvc2VkICgpIHsKICAgIHJldHVybiB0aGlzLl9jaGFubmVsLmNsb3NlZAogIH0KCiAgZ2V0IG11eCAoKSB7CiAgICByZXR1cm4gdGhpcy5fbXV4CiAgfQoKICBnZXQgc3RyZWFtICgpIHsKICAgIHJldHVybiB0aGlzLl9tdXguc3RyZWFtCiAgfQoKICBfb25vcGVuICgpIHsKICAgIHRoaXMuZW1pdCgnb3BlbicpCiAgfQoKICBfb25jbG9zZSAoKSB7CiAgICB0aGlzLl9lbmRpbmcgPSBQcm9taXNlLnJlc29sdmUoKQoKICAgIGNvbnN0IGVyciA9IHRoaXMuX2Vycm9yIHx8IGVycm9ycy5DSEFOTkVMX0NMT1NFRCgpCgogICAgZm9yIChjb25zdCB0b2tlbiBvZiB0aGlzLl9wYWlyaW5nKSB7CiAgICAgIHRoaXMuX3NlcnZlci5fcGFpcmluZy5kZWxldGUodG9rZW4udG9TdHJpbmcoJ2hleCcpKQogICAgfQoKICAgIGZvciAoY29uc3Qgc3RyZWFtIG9mIHRoaXMuX3N0cmVhbXMudmFsdWVzKCkpIHsKICAgICAgc3RyZWFtCiAgICAgICAgLm9mZignZXJyb3InLCB0aGlzLl9vbmVycm9yKQogICAgICAgIC5vbignZXJyb3InLCBub29wKQogICAgICAgIC5kZXN0cm95KGVycikKICAgIH0KCiAgICB0aGlzLl9wYWlyaW5nLmNsZWFyKCkKICAgIHRoaXMuX3N0cmVhbXMuY2xlYXIoKQoKICAgIHRoaXMuX3NlcnZlci5fc2Vzc2lvbnMuZGVsZXRlKHRoaXMpCgogICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgfQoKICBfb25kZXN0cm95ICgpIHsKICAgIHRoaXMuX2Rlc3Ryb3llZCA9IHRydWUKICAgIHRoaXMuZW1pdCgnZGVzdHJveScpCiAgfQoKICBfb25wYWlyICh7IGlzSW5pdGlhdG9yLCB0b2tlbiwgaWQ6IHJlbW90ZUlkIH0pIHsKICAgIGNvbnN0IGtleVN0cmluZyA9IHRva2VuLnRvU3RyaW5nKCdoZXgnKQoKICAgIGxldCBwYWlyID0gdGhpcy5fc2VydmVyLl9wYWlyaW5nLmdldChrZXlTdHJpbmcpCgogICAgaWYgKHBhaXIgPT09IHVuZGVmaW5lZCkgewogICAgICBwYWlyID0gbmV3IEJsaW5kUmVsYXlQYWlyKHRva2VuKQogICAgICB0aGlzLl9zZXJ2ZXIuX3BhaXJpbmcuc2V0KGtleVN0cmluZywgcGFpcikKICAgIH0gZWxzZSBpZiAocGFpci5saW5rc1sraXNJbml0aWF0b3JdKSByZXR1cm4KCiAgICB0aGlzLl9wYWlyaW5nLmFkZChrZXlTdHJpbmcpCgogICAgcGFpci5saW5rc1sraXNJbml0aWF0b3JdID0gbmV3IEJsaW5kUmVsYXlMaW5rKHRoaXMsIGlzSW5pdGlhdG9yLCByZW1vdGVJZCkKCiAgICBpZiAoIXBhaXIucGFpcmVkKSByZXR1cm4KCiAgICB0aGlzLl9zZXJ2ZXIuX3BhaXJpbmcuZGVsZXRlKGtleVN0cmluZykKCiAgICAvLyAxc3QgcGFzczogQ3JlYXRlIHRoZSByYXcgc3RyZWFtcyBuZWVkZWQgZm9yIGVhY2ggZW5kIG9mIHRoZSBsaW5rLgogICAgZm9yIChjb25zdCBsaW5rIG9mIHBhaXIubGlua3MpIHsKICAgICAgbGluay5jcmVhdGVTdHJlYW0oKQogICAgfQoKICAgIC8vIDJuZCBwYXNzOiBDb25uZWN0IHRoZSByYXcgc3RyZWFtcyBhbmQgc2V0IHVwIGhhbmRsZXJzLgogICAgZm9yIChjb25zdCB7IGlzSW5pdGlhdG9yLCBzZXNzaW9uLCBzdHJlYW0gfSBvZiBwYWlyLmxpbmtzKSB7CiAgICAgIGNvbnN0IHJlbW90ZSA9IHBhaXIucmVtb3RlKGlzSW5pdGlhdG9yKQoKICAgICAgc3RyZWFtCiAgICAgICAgLm9uKCdlcnJvcicsIHNlc3Npb24uX29uZXJyb3IpCiAgICAgICAgLm9uKCdjbG9zZScsICgpID0+IHNlc3Npb24uX3N0cmVhbXMuZGVsZXRlKGtleVN0cmluZykpCiAgICAgICAgLnJlbGF5VG8ocmVtb3RlLnN0cmVhbSkKCiAgICAgIHNlc3Npb24uX3BhaXJpbmcuZGVsZXRlKGtleVN0cmluZykKICAgICAgc2Vzc2lvbi5fc3RyZWFtcy5zZXQoa2V5U3RyaW5nLCBzdHJlYW0pCiAgICB9CgogICAgLy8gM3JkIHBhc3M6IExldCBlaXRoZXIgZW5kIG9mIHRoZSBsaW5rIGtub3cgdGhlIHN0cmVhbXMgd2VyZSBzZXQgdXAuCiAgICBmb3IgKGNvbnN0IHsgaXNJbml0aWF0b3IsIHNlc3Npb24sIHJlbW90ZUlkLCBzdHJlYW0gfSBvZiBwYWlyLmxpbmtzKSB7CiAgICAgIHNlc3Npb24uX3BhaXIuc2VuZCh7CiAgICAgICAgaXNJbml0aWF0b3IsCiAgICAgICAgdG9rZW4sCiAgICAgICAgaWQ6IHN0cmVhbS5pZCwKICAgICAgICBzZXE6IDAKICAgICAgfSkKCiAgICAgIHNlc3Npb24uX2VuZE1heWJlKCkKCiAgICAgIHNlc3Npb24uZW1pdCgncGFpcicsIGlzSW5pdGlhdG9yLCB0b2tlbiwgc3RyZWFtLCByZW1vdGVJZCkKICAgIH0KICB9CgogIF9vbnVucGFpciAoeyB0b2tlbiB9KSB7CiAgICBjb25zdCBrZXlTdHJpbmcgPSB0b2tlbi50b1N0cmluZygnaGV4JykKCiAgICBjb25zdCBwYWlyID0gdGhpcy5fc2VydmVyLl9wYWlyaW5nLmdldChrZXlTdHJpbmcpCgogICAgaWYgKHBhaXIpIHsKICAgICAgZm9yIChjb25zdCBsaW5rIG9mIHBhaXIubGlua3MpIHsKICAgICAgICBpZiAobGluaykgbGluay5zZXNzaW9uLl9wYWlyaW5nLmRlbGV0ZShrZXlTdHJpbmcpCiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLl9zZXJ2ZXIuX3BhaXJpbmcuZGVsZXRlKGtleVN0cmluZykKICAgIH0KCiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLl9zdHJlYW1zLmdldChrZXlTdHJpbmcpCgogICAgaWYgKHN0cmVhbSkgewogICAgICBzdHJlYW0KICAgICAgICAub2ZmKCdlcnJvcicsIHRoaXMuX29uZXJyb3IpCiAgICAgICAgLm9uKCdlcnJvcicsIG5vb3ApCiAgICAgICAgLmRlc3Ryb3koZXJyb3JzLlBBSVJJTkdfQ0FOQ0VMTEVEKCkpCgogICAgICB0aGlzLl9zdHJlYW1zLmRlbGV0ZShrZXlTdHJpbmcpCiAgICB9CiAgfQoKICBjb3JrICgpIHsKICAgIHRoaXMuX2NoYW5uZWwuY29yaygpCiAgfQoKICB1bmNvcmsgKCkgewogICAgdGhpcy5fY2hhbm5lbC51bmNvcmsoKQogIH0KCiAgYXN5bmMgZW5kICgpIHsKICAgIGlmICh0aGlzLl9lbmRpbmcpIHJldHVybiB0aGlzLl9lbmRpbmcKCiAgICB0aGlzLl9lbmRpbmcgPSBFdmVudEVtaXR0ZXIub25jZSh0aGlzLCAnY2xvc2UnKQogICAgdGhpcy5fZW5kTWF5YmUoKQoKICAgIHJldHVybiB0aGlzLl9lbmRpbmcKICB9CgogIF9lbmRNYXliZSAoKSB7CiAgICBpZiAodGhpcy5fZW5kaW5nICYmIHRoaXMuX3BhaXJpbmcuc2l6ZSA9PT0gMCkgewogICAgICB0aGlzLl9jaGFubmVsLmNsb3NlKCkKICAgIH0KICB9CgogIGRlc3Ryb3kgKGVycikgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLl9kZXN0cm95ZWQgPSB0cnVlCgogICAgdGhpcy5fZXJyb3IgPSBlcnIgfHwgZXJyb3JzLkNIQU5ORUxfREVTVFJPWUVEKCkKICAgIHRoaXMuX2NoYW5uZWwuY2xvc2UoKQogIH0KfQoKY2xhc3MgQmxpbmRSZWxheVBhaXIgewogIGNvbnN0cnVjdG9yICh0b2tlbikgewogICAgdGhpcy50b2tlbiA9IHRva2VuCiAgICB0aGlzLmxpbmtzID0gW251bGwsIG51bGxdCiAgfQoKICBnZXQgcGFpcmVkICgpIHsKICAgIHJldHVybiB0aGlzLmxpbmtzWzBdICE9PSBudWxsICYmIHRoaXMubGlua3NbMV0gIT09IG51bGwKICB9CgogIHJlbW90ZSAoaXNJbml0aWF0b3IpIHsKICAgIHJldHVybiB0aGlzLmxpbmtzW2lzSW5pdGlhdG9yID8gMCA6IDFdCiAgfQp9CgpjbGFzcyBCbGluZFJlbGF5TGluayB7CiAgY29uc3RydWN0b3IgKHNlc3Npb24sIGlzSW5pdGlhdG9yLCByZW1vdGVJZCkgewogICAgdGhpcy5zZXNzaW9uID0gc2Vzc2lvbgogICAgdGhpcy5pc0luaXRpYXRvciA9IGlzSW5pdGlhdG9yCiAgICB0aGlzLnJlbW90ZUlkID0gcmVtb3RlSWQKICAgIHRoaXMuc3RyZWFtID0gbnVsbAogIH0KCiAgY3JlYXRlU3RyZWFtICgpIHsKICAgIGlmICh0aGlzLnN0cmVhbSkgcmV0dXJuCgogICAgdGhpcy5zdHJlYW0gPSB0aGlzLnNlc3Npb24uX3NlcnZlci5fY3JlYXRlU3RyZWFtKHsKICAgICAgZmlyZXdhbGw6IHRoaXMuX29uZmlyZXdhbGwuYmluZCh0aGlzKQogICAgfSkKICB9CgogIF9vbmZpcmV3YWxsIChzb2NrZXQsIHBvcnQsIGhvc3QpIHsKICAgIHRoaXMuc3RyZWFtLmNvbm5lY3Qoc29ja2V0LCB0aGlzLnJlbW90ZUlkLCBwb3J0LCBob3N0KQoKICAgIHJldHVybiBmYWxzZQogIH0KfQoKZXhwb3J0cy5DbGllbnQgPSBjbGFzcyBCbGluZFJlbGF5Q2xpZW50IGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBzdGF0aWMgX2NsaWVudHMgPSBuZXcgV2Vha01hcCgpCgogIHN0YXRpYyBmcm9tIChzdHJlYW0sIG9wdHMpIHsKICAgIGxldCBjbGllbnQgPSB0aGlzLl9jbGllbnRzLmdldChzdHJlYW0pCiAgICBpZiAoY2xpZW50KSByZXR1cm4gY2xpZW50CiAgICBjbGllbnQgPSBuZXcgdGhpcyhzdHJlYW0sIG9wdHMpCiAgICB0aGlzLl9jbGllbnRzLnNldChzdHJlYW0sIGNsaWVudCkKICAgIHJldHVybiBjbGllbnQKICB9CgogIGNvbnN0cnVjdG9yIChzdHJlYW0sIG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIGNvbnN0IHsKICAgICAgaWQsCiAgICAgIGhhbmRzaGFrZSwKICAgICAgaGFuZHNoYWtlRW5jb2RpbmcKICAgIH0gPSBvcHRzCgogICAgdGhpcy5fbXV4ID0gUHJvdG9tdXguZnJvbShzdHJlYW0pCgogICAgdGhpcy5fY2hhbm5lbCA9IHRoaXMuX211eC5jcmVhdGVDaGFubmVsKHsKICAgICAgcHJvdG9jb2w6ICdibGluZC1yZWxheScsCiAgICAgIGlkLAogICAgICBoYW5kc2hha2U6IGhhbmRzaGFrZSA/IGhhbmRzaGFrZUVuY29kaW5nIHx8IGMucmF3IDogbnVsbCwKICAgICAgb25vcGVuOiB0aGlzLl9vbm9wZW4uYmluZCh0aGlzKSwKICAgICAgb25jbG9zZTogdGhpcy5fb25jbG9zZS5iaW5kKHRoaXMpLAogICAgICBvbmRlc3Ryb3k6IHRoaXMuX29uZGVzdHJveS5iaW5kKHRoaXMpCiAgICB9KQoKICAgIHRoaXMuX3BhaXIgPSB0aGlzLl9jaGFubmVsLmFkZE1lc3NhZ2UoewogICAgICBlbmNvZGluZzogbS5wYWlyLAogICAgICBvbm1lc3NhZ2U6IHRoaXMuX29ucGFpci5iaW5kKHRoaXMpCiAgICB9KQoKICAgIHRoaXMuX3VucGFpciA9IHRoaXMuX2NoYW5uZWwuYWRkTWVzc2FnZSh7CiAgICAgIGVuY29kaW5nOiBtLnVucGFpcgogICAgfSkKCiAgICB0aGlzLl9lbmRpbmcgPSBmYWxzZQogICAgdGhpcy5fZGVzdHJveWVkID0gZmFsc2UKICAgIHRoaXMuX2Vycm9yID0gbnVsbAogICAgdGhpcy5fcmVxdWVzdHMgPSBuZXcgTWFwKCkKCiAgICB0aGlzLl9jaGFubmVsLm9wZW4oaGFuZHNoYWtlKQogIH0KCiAgZ2V0IGNsb3NlZCAoKSB7CiAgICByZXR1cm4gdGhpcy5fY2hhbm5lbC5jbG9zZWQKICB9CgogIGdldCBtdXggKCkgewogICAgcmV0dXJuIHRoaXMuX211eAogIH0KCiAgZ2V0IHN0cmVhbSAoKSB7CiAgICByZXR1cm4gdGhpcy5fbXV4LnN0cmVhbQogIH0KCiAgZ2V0IHJlcXVlc3RzICgpIHsKICAgIHJldHVybiB0aGlzLl9yZXF1ZXN0cy52YWx1ZXMoKQogIH0KCiAgX29ub3BlbiAoKSB7CiAgICB0aGlzLmVtaXQoJ29wZW4nKQogIH0KCiAgX29uY2xvc2UgKCkgewogICAgdGhpcy5fZW5kaW5nID0gUHJvbWlzZS5yZXNvbHZlKCkKCiAgICBjb25zdCBlcnIgPSB0aGlzLl9lcnJvciB8fCBlcnJvcnMuQ0hBTk5FTF9DTE9TRUQoKQoKICAgIGZvciAoY29uc3QgcmVxdWVzdCBvZiB0aGlzLl9yZXF1ZXN0cy52YWx1ZXMoKSkgewogICAgICByZXF1ZXN0LmRlc3Ryb3koZXJyKQogICAgfQoKICAgIHRoaXMuX3JlcXVlc3RzLmNsZWFyKCkKCiAgICB0aGlzLmNvbnN0cnVjdG9yLl9jbGllbnRzLmRlbGV0ZSh0aGlzLnN0cmVhbSkKCiAgICB0aGlzLmVtaXQoJ2Nsb3NlJykKICB9CgogIF9vbmRlc3Ryb3kgKCkgewogICAgdGhpcy5fZGVzdHJveWVkID0gdHJ1ZQogICAgdGhpcy5lbWl0KCdkZXN0cm95JykKICB9CgogIF9vbnBhaXIgKHsgaXNJbml0aWF0b3IsIHRva2VuLCBpZDogcmVtb3RlSWQgfSkgewogICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX3JlcXVlc3RzLmdldCh0b2tlbi50b1N0cmluZygnaGV4JykpCgogICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCB8fCByZXF1ZXN0LmlzSW5pdGlhdG9yICE9PSBpc0luaXRpYXRvcikgcmV0dXJuCgogICAgcmVxdWVzdC5wdXNoKHJlbW90ZUlkKQogICAgcmVxdWVzdC5wdXNoKG51bGwpCgogICAgdGhpcy5lbWl0KCdwYWlyJywgcmVxdWVzdC5pc0luaXRpYXRvciwgcmVxdWVzdC50b2tlbiwgcmVxdWVzdC5zdHJlYW0sIHJlbW90ZUlkKQogIH0KCiAgcGFpciAoaXNJbml0aWF0b3IsIHRva2VuLCBzdHJlYW0pIHsKICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHRocm93IGVycm9ycy5DSEFOTkVMX0RFU1RST1lFRCgpCgogICAgY29uc3Qga2V5U3RyaW5nID0gdG9rZW4udG9TdHJpbmcoJ2hleCcpCgogICAgaWYgKHRoaXMuX3JlcXVlc3RzLmhhcyhrZXlTdHJpbmcpKSB0aHJvdyBlcnJvcnMuQUxSRUFEWV9QQUlSSU5HKCkKCiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IEJsaW5kUmVsYXlSZXF1ZXN0KHRoaXMsIGlzSW5pdGlhdG9yLCB0b2tlbiwgc3RyZWFtKQoKICAgIHRoaXMuX3JlcXVlc3RzLnNldChrZXlTdHJpbmcsIHJlcXVlc3QpCgogICAgcmV0dXJuIHJlcXVlc3QKICB9CgogIHVucGFpciAodG9rZW4pIHsKICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHRocm93IGVycm9ycy5DSEFOTkVMX0RFU1RST1lFRCgpCgogICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX3JlcXVlc3RzLmdldCh0b2tlbi50b1N0cmluZygnaGV4JykpCgogICAgaWYgKHJlcXVlc3QpIHJlcXVlc3QuZGVzdHJveShlcnJvcnMuUEFJUklOR19DQU5DRUxMRUQoKSkKCiAgICB0aGlzLl91bnBhaXIuc2VuZCh7IHRva2VuIH0pCiAgfQoKICBjb3JrICgpIHsKICAgIHRoaXMuX2NoYW5uZWwuY29yaygpCiAgfQoKICB1bmNvcmsgKCkgewogICAgdGhpcy5fY2hhbm5lbC51bmNvcmsoKQogIH0KCiAgYXN5bmMgZW5kICgpIHsKICAgIGlmICh0aGlzLl9lbmRpbmcpIHJldHVybiB0aGlzLl9lbmRpbmcKCiAgICB0aGlzLl9lbmRpbmcgPSBFdmVudEVtaXR0ZXIub25jZSh0aGlzLCAnY2xvc2UnKQogICAgdGhpcy5fZW5kTWF5YmUoKQoKICAgIHJldHVybiB0aGlzLl9lbmRpbmcKICB9CgogIF9lbmRNYXliZSAoKSB7CiAgICBpZiAodGhpcy5fZW5kaW5nICYmIHRoaXMuX3JlcXVlc3RzLnNpemUgPT09IDApIHsKICAgICAgdGhpcy5fY2hhbm5lbC5jbG9zZSgpCiAgICB9CiAgfQoKICBkZXN0cm95IChlcnIpIHsKICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5fZGVzdHJveWVkID0gdHJ1ZQoKICAgIHRoaXMuX2Vycm9yID0gZXJyIHx8IGVycm9ycy5DSEFOTkVMX0RFU1RST1lFRCgpCiAgICB0aGlzLl9jaGFubmVsLmNsb3NlKCkKICB9Cn0KCmNsYXNzIEJsaW5kUmVsYXlSZXF1ZXN0IGV4dGVuZHMgUmVhZGFibGUgewogIGNvbnN0cnVjdG9yIChjbGllbnQsIGlzSW5pdGlhdG9yLCB0b2tlbiwgc3RyZWFtKSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5jbGllbnQgPSBjbGllbnQKICAgIHRoaXMuaXNJbml0aWF0b3IgPSBpc0luaXRpYXRvcgogICAgdGhpcy50b2tlbiA9IHRva2VuCiAgICB0aGlzLnN0cmVhbSA9IHN0cmVhbQogIH0KCiAgX29wZW4gKGNiKSB7CiAgICBpZiAodGhpcy5jbGllbnQuX2Rlc3Ryb3llZCkgcmV0dXJuIGNiKGVycm9ycy5DSEFOTkVMX0RFU1RST1lFRCgpKQoKICAgIHRoaXMuY2xpZW50Ll9wYWlyLnNlbmQoewogICAgICBpc0luaXRpYXRvcjogdGhpcy5pc0luaXRpYXRvciwKICAgICAgdG9rZW46IHRoaXMudG9rZW4sCiAgICAgIGlkOiB0aGlzLnN0cmVhbS5pZCwKICAgICAgc2VxOiAwCiAgICB9KQoKICAgIGNiKG51bGwpCiAgfQoKICBfZGVzdHJveSAoY2IpIHsKICAgIHRoaXMuY2xpZW50Ll9yZXF1ZXN0cy5kZWxldGUodGhpcy50b2tlbi50b1N0cmluZygnaGV4JykpCgogICAgY2IobnVsbCkKCiAgICB0aGlzLmNsaWVudC5fZW5kTWF5YmUoKQogIH0KfQoKZXhwb3J0cy50b2tlbiA9IGZ1bmN0aW9uIHRva2VuIChidWYgPSBiNGEuYWxsb2NVbnNhZmUoMzIpKSB7CiAgc29kaXVtLnJhbmRvbWJ5dGVzX2J1ZihidWYpCiAgcmV0dXJuIGJ1Zgp9CgpmdW5jdGlvbiBub29wICgpIHt9Cgpjb25zdCBtID0gZXhwb3J0cy5tZXNzYWdlcyA9IHt9Cgpjb25zdCBmbGFncyA9IGJpdGZpZWxkKDcpCgptLnBhaXIgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgZmxhZ3MucHJlZW5jb2RlKHN0YXRlKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS50b2tlbikKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uaWQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnNlcSkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGZsYWdzLmVuY29kZShzdGF0ZSwgYml0cy5vZihtLmlzSW5pdGlhdG9yKSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0udG9rZW4pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zZXEpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBbaXNJbml0aWF0b3JdID0gYml0cy5pdGVyYXRvcihmbGFncy5kZWNvZGUoc3RhdGUpKQoKICAgIHJldHVybiB7CiAgICAgIGlzSW5pdGlhdG9yLAogICAgICB0b2tlbjogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIGlkOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2VxOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKbS51bnBhaXIgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgZmxhZ3MucHJlZW5jb2RlKHN0YXRlKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS50b2tlbikKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGZsYWdzLmVuY29kZShzdGF0ZSwgYml0cy5vZigpKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS50b2tlbikKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGZsYWdzLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB0b2tlbjogYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBCbGluZFJlbGF5RXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IgKG1zZywgY29kZSwgZm4gPSBCbGluZFJlbGF5RXJyb3IpIHsKICAgIHN1cGVyKGAke2NvZGV9OiAke21zZ31gKQogICAgdGhpcy5jb2RlID0gY29kZQoKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBmbikKICAgIH0KICB9CgogIGdldCBuYW1lICgpIHsKICAgIHJldHVybiAnQmxpbmRSZWxheUVycm9yJwogIH0KCiAgc3RhdGljIERVUExJQ0FURV9DSEFOTkVMIChtc2cgPSAnRHVwbGljYXRlIGNoYW5uZWwnKSB7CiAgICByZXR1cm4gbmV3IEJsaW5kUmVsYXlFcnJvcihtc2csICdEVVBMSUNBVEVfQ0hBTk5FTCcsIEJsaW5kUmVsYXlFcnJvci5EVVBMSUNBVEVfQ0hBTk5FTCkKICB9CgogIHN0YXRpYyBDSEFOTkVMX0NMT1NFRCAobXNnID0gJ0NoYW5uZWwgY2xvc2VkJykgewogICAgcmV0dXJuIG5ldyBCbGluZFJlbGF5RXJyb3IobXNnLCAnQ0hBTk5FTF9DTE9TRUQnLCBCbGluZFJlbGF5RXJyb3IuQ0hBTk5FTF9DTE9TRUQpCiAgfQoKICBzdGF0aWMgQ0hBTk5FTF9ERVNUUk9ZRUQgKG1zZyA9ICdDaGFubmVsIGRlc3Ryb3llZCcpIHsKICAgIHJldHVybiBuZXcgQmxpbmRSZWxheUVycm9yKG1zZywgJ0NIQU5ORUxfREVTVFJPWUVEJywgQmxpbmRSZWxheUVycm9yLkNIQU5ORUxfREVTVFJPWUVEKQogIH0KCiAgc3RhdGljIEFMUkVBRFlfUEFJUklORyAobXNnID0gJ0FscmVhZHkgcGFpcmluZycpIHsKICAgIHJldHVybiBuZXcgQmxpbmRSZWxheUVycm9yKG1zZywgJ0FMUkVBRFlfUEFJUklORycsIEJsaW5kUmVsYXlFcnJvci5BTFJFQURZX1BBSVJJTkcpCiAgfQoKICBzdGF0aWMgUEFJUklOR19DQU5DRUxMRUQgKG1zZyA9ICdQYWlyaW5nIGNhbmNlbGxlZCcpIHsKICAgIHJldHVybiBuZXcgQmxpbmRSZWxheUVycm9yKG1zZywgJ1BBSVJJTkdfQ0FOQ0VMTEVEJywgQmxpbmRSZWxheUVycm9yLlBBSVJJTkdfQ0FOQ0VMTEVEKQogIH0KfQp7CiAgIm5hbWUiOiAiYmxpbmQtcmVsYXkiLAogICJ2ZXJzaW9uIjogIjEuNC4wIiwKICAiZGVzY3JpcHRpb24iOiAiQmxpbmQgcmVsYXkgZm9yIFVEWCBvdmVyIFByb3RvbXV4IGNoYW5uZWxzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJsaWIiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5tanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmxpbmQtcmVsYXkuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmxpbmQtcmVsYXkvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9ibGluZC1yZWxheSNyZWFkbWUiLAogICJpbXBvcnRzIjogewogICAgImV2ZW50cyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1ldmVudHMiLAogICAgICAiZGVmYXVsdCI6ICJldmVudHMiCiAgICB9CiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjQiLAogICAgImJhcmUtZXZlbnRzIjogIl4yLjIuMCIsCiAgICAiYml0cy10by1ieXRlcyI6ICJeMS4zLjAiLAogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuMTIuMCIsCiAgICAiY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZCI6ICJeMS4wLjAiLAogICAgInByb3RvbXV4IjogIl4zLjUuMSIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjAiLAogICAgInN0cmVhbXgiOiAiXjIuMTUuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4yLjEiLAogICAgImh5cGVyZGh0IjogIl42LjYuMSIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIsCiAgICAidWR4LW5hdGl2ZSI6ICJeMS42LjEiCiAgfQp9Ci8vIGh0dHBzOi8vaXBpbmZvLmlvL2JvZ29uCgpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IG5ldCA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmctbmV0JykKCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IGZ1bmN0aW9uIGlzQm9nb24gKGlwKSB7CiAgcmV0dXJuIGlzQm9nb25JUChlbnN1cmVCdWZmZXIoaXApKQp9CgpleHBvcnRzLmlzQm9nb24gPSBleHBvcnRzCgpleHBvcnRzLmlzUHJpdmF0ZSA9IGZ1bmN0aW9uIGlzUHJpdmF0ZSAoaXApIHsKICByZXR1cm4gaXNQcml2YXRlSVAoZW5zdXJlQnVmZmVyKGlwKSkKfQoKZnVuY3Rpb24gaXNCb2dvbklQIChpcCkgewogIHJldHVybiBpc1ByaXZhdGVJUChpcCkgfHwgaXNSZXNlcnZlZElQKGlwKQp9CgpmdW5jdGlvbiBpc1ByaXZhdGVJUCAoaXApIHsKICByZXR1cm4gaXAuYnl0ZUxlbmd0aCA9PT0gNCA/IGlzUHJpdmF0ZUlQdjQoaXApIDogZmFsc2UgLy8gSVB2NiBoYXMgbm8gcHJpdmF0ZSBJUHMKfQoKZnVuY3Rpb24gaXNQcml2YXRlSVB2NCAoaXApIHsKICByZXR1cm4gKAogICAgLy8gMTAuMC4wLjAvOCAgUHJpdmF0ZS11c2UgbmV0d29ya3MKICAgIChpcFswXSA9PT0gMTApIHx8CiAgICAvLyAxMDAuNjQuMC4wLzEwIENhcnJpZXItZ3JhZGUgTkFUCiAgICAoaXBbMF0gPT09IDEwMCAmJiBpcFsxXSA+PSA2NCAmJiBpcFsxXSA8PSAxMjcpIHx8CiAgICAvLyAxMjcuMC4wLjAvOCBMb29wYmFjayArIE5hbWUgY29sbGlzaW9uIG9jY3VycmVuY2UgKDEyNy4wLjUzLjUzKQogICAgKGlwWzBdID09PSAxMjcpIHx8CiAgICAvLyAxNjkuMjU0LjAuMC8xNiAgTGluayBsb2NhbAogICAgKGlwWzBdID09PSAxNjkgJiYgaXBbMV0gPT09IDI1NCkgfHwKICAgIC8vIDE3Mi4xNi4wLjAvMTIgUHJpdmF0ZS11c2UgbmV0d29ya3MKICAgIChpcFswXSA9PT0gMTcyICYmIGlwWzFdID49IDE2ICYmIGlwWzFdIDw9IDMxKSB8fAogICAgLy8gMTkyLjE2OC4wLjAvMTYgIFByaXZhdGUtdXNlIG5ldHdvcmtzCiAgICAoaXBbMF0gPT09IDE5MiAmJiBpcFsxXSA9PT0gMTY4KQogICkKfQoKZnVuY3Rpb24gaXNSZXNlcnZlZElQIChpcCkgewogIHJldHVybiBpcC5ieXRlTGVuZ3RoID09PSA0ID8gaXNSZXNlcnZlZElQdjQoaXApIDogaXNSZXNlcnZlZElQdjYoaXApCn0KCmZ1bmN0aW9uIGlzUmVzZXJ2ZWRJUHY0IChpcCkgewogIHJldHVybiAoCiAgICAvLyAwLjAuMC4wLzggIlRoaXMiIG5ldHdvcmsKICAgIChpcFswXSA9PT0gMCkgfHwKICAgIC8vIDE5Mi4wLjAuMC8yNCAgSUVURiBwcm90b2NvbCBhc3NpZ25tZW50cwogICAgKGlwWzBdID09PSAxOTIgJiYgaXBbMV0gPT09IDAgJiYgaXBbMl0gPT09IDApIHx8CiAgICAvLyAxOTIuMC4yLjAvMjQgIFRFU1QtTkVULTEKICAgIChpcFswXSA9PT0gMTkyICYmIGlwWzFdID09PSAwICYmIGlwWzJdID09PSAyKSB8fAogICAgLy8gMTk4LjE4LjAuMC8xNSBOZXR3b3JrIGludGVyY29ubmVjdCBkZXZpY2UgYmVuY2htYXJrIHRlc3RpbmcKICAgIChpcFswXSA9PT0gMTk4ICYmIGlwWzFdID49IDE4ICYmIGlwWzFdIDw9IDE5KSB8fAogICAgLy8gMTk4LjUxLjEwMC4wLzI0IFRFU1QtTkVULTIKICAgIChpcFswXSA9PT0gMTk4ICYmIGlwWzFdID09PSA1MSAmJiBpcFsyXSA9PT0gMTAwKSB8fAogICAgLy8gMjAzLjAuMTEzLjAvMjQgIFRFU1QtTkVULTMKICAgIChpcFswXSA9PT0gMjAzICYmIGlwWzFdID09PSAwICYmIGlwWzJdID09PSAxMTMpIHx8CiAgICAvLyAyMjQuMC4wLjAvNCBNdWx0aWNhc3QKICAgIChpcFswXSA+PSAyMjQgJiYgaXBbMF0gPD0gMjM5KSB8fAogICAgLy8gMjQwLjAuMC4wLzQgUmVzZXJ2ZWQgZm9yIGZ1dHVyZSB1c2UKICAgIChpcFswXSA+PSAyNDApIHx8CiAgICAvLyAyNTUuMjU1LjI1NS4yNTUvMzIKICAgIChpcFswXSA9PT0gMjU1ICYmIGlwWzFdID09PSAyNTUgJiYgaXBbMl0gPT09IDI1NSAmJiBpcFszXSA9PT0gMjU1KQogICkKfQoKZnVuY3Rpb24gaXNSZXNlcnZlZElQdjYgKGlwKSB7CiAgcmV0dXJuICgKICAgIC8vIDo6LzEyOCBOb2RlLXNjb3BlIHVuaWNhc3QgdW5zcGVjaWZpZWQgYWRkcmVzcwogICAgLy8gOjoxLzEyOCBOb2RlLXNjb3BlIHVuaWNhc3QgbG9vcGJhY2sgYWRkcmVzcwogICAgKAogICAgICBpcFswXSA9PT0gMCAmJiBpcFsxXSA9PT0gMCAmJiBpcFsyXSA9PT0gMCAmJiBpcFszXSA9PT0gMCAmJiBpcFs0XSA9PT0gMCAmJgogICAgICBpcFs1XSA9PT0gMCAmJiBpcFs2XSA9PT0gMCAmJiBpcFs3XSA9PT0gMCAmJiBpcFs4XSA9PT0gMCAmJiBpcFs5XSA9PT0gMCAmJgogICAgICBpcFsxMF0gPT09IDAgJiYgaXBbMTFdID09PSAwICYmIGlwWzEyXSA9PT0gMCAmJiBpcFsxM10gPT09IDAgJiYgaXBbMTRdID09PSAwICYmCiAgICAgIGlwWzE1XSA8PSAxCiAgICApIHx8CiAgICAvLyA6OmZmZmY6MDowLzk2IElQdjQtbWFwcGVkIGFkZHJlc3NlcwogICAgLy8gOjovOTYgSVB2NC1jb21wYXRpYmxlIGFkZHJlc3NlcwogICAgKAogICAgICBpcFswXSA9PT0gMCAmJiBpcFsxXSA9PT0gMCAmJiBpcFsyXSA9PT0gMCAmJiBpcFszXSA9PT0gMCAmJiBpcFs0XSA9PT0gMCAmJgogICAgICBpcFs1XSA9PT0gMCAmJiBpcFs2XSA9PT0gMCAmJiBpcFs3XSA9PT0gMCAmJiBpcFs4XSA9PT0gMCAmJiBpcFs5XSA9PT0gMCAmJgogICAgICAoaXBbMTBdID09PSAwIHx8IGlwWzEwXSA9PT0gMHhmZikgJiYKICAgICAgKGlwWzExXSA9PT0gMCB8fCBpcFsxMV0gPT09IDB4ZmYpCiAgICApIHx8CiAgICAvLyAxMDA6Oi82NCBSZW1vdGVseSB0cmlnZ2VyZWQgYmxhY2sgaG9sZSBhZGRyZXNzZXMKICAgIChpcFswXSA9PT0gMHgwMSAmJiBpcFsxXSA9PT0gMCAmJiBpcFsyXSA9PT0gMCAmJiBpcFszXSA9PT0gMCAmJiBpcFs0XSA9PT0gMCAmJiBpcFs1XSA9PT0gMCAmJiBpcFs2XSA9PT0gMCAmJiBpcFs3XSA9PT0gMCkgfHwKICAgIC8vIDIwMDE6MTA6Oi8yOCBPdmVybGF5IHJvdXRhYmxlIGNyeXB0b2dyYXBoaWMgaGFzaCBpZGVudGlmaWVycyAoT1JDSElEKQogICAgKGlwWzBdID09PSAweDIwICYmIGlwWzFdID09PSAweDAxICYmIGlwWzJdID09PSAwICYmIGlwWzNdID49IDB4MTAgJiYgaXBbM10gPD0gMHgxZikgfHwKICAgIC8vIDIwMDE6MjA6Oi8yOCBPdmVybGF5IHJvdXRhYmxlIGNyeXB0b2dyYXBoaWMgaGFzaCBpZGVudGlmaWVycyB2ZXJzaW9uIDIgKE9SQ0hJRHYyKQogICAgKGlwWzBdID09PSAweDIwICYmIGlwWzFdID09PSAweDAxICYmIGlwWzJdID09PSAwICYmIGlwWzNdID49IDB4MjAgJiYgaXBbM10gPD0gMHgyZikgfHwKICAgIC8vIDIwMDE6ZGI4OjovMzIgRG9jdW1lbnRhdGlvbiBwcmVmaXgKICAgIChpcFswXSA9PT0gMHgyMCAmJiBpcFsxXSA9PT0gMHgwMSAmJiBpcFsyXSA9PT0gMHgwZCAmJiBpcFszXSA9PT0gMHhiOCkgfHwKICAgIC8vIGZjMDA6Oi83IFVuaXF1ZSBsb2NhbCBhZGRyZXNzZXMgKFVMQSkKICAgIChpcFswXSA+PSAweGZjICYmIGlwWzBdIDw9IDB4ZmQpIHx8CiAgICAvLyBmZTgwOjovMTAgTGluay1sb2NhbCB1bmljYXN0CiAgICAoaXBbMF0gPT09IDB4ZmUgJiYgaXBbMV0gPj0gMHg4MCAmJiBpcFsxXSA8PSAweGJmKSB8fAogICAgLy8gZmYwMDo6LzggTXVsdGljYXN0CiAgICAoaXBbMF0gPT09IDB4ZmYpCiAgKQp9Cgpjb25zdCBzdGF0ZSA9IGMuc3RhdGUoMCwgMCwgYjRhLmFsbG9jVW5zYWZlKDEgLyogZmFtaWx5ICovICsgMTYpKQoKZnVuY3Rpb24gZW5zdXJlQnVmZmVyIChpcCkgewogIGlmIChiNGEuaXNCdWZmZXIoaXApKSByZXR1cm4gaXAKCiAgbmV0LmlwLnByZWVuY29kZShzdGF0ZSwgaXApCiAgbmV0LmlwLmVuY29kZShzdGF0ZSwgaXApCgogIGNvbnN0IGJ1ZmZlciA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheSgxIC8qIGZhbWlseSAqLywgc3RhdGUuZW5kKQoKICBzdGF0ZS5zdGFydCA9IDAKICBzdGF0ZS5lbmQgPSAwCgogIHJldHVybiBidWZmZXIKfQp7CiAgIm5hbWUiOiAiYm9nb24iLAogICJ2ZXJzaW9uIjogIjEuMS4wIiwKICAiZGVzY3JpcHRpb24iOiAiQ2hlY2sgaWYgYW4gSVAgaXMgYSBib2dvbiIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0Lm1qcyIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xMS4wIiwKICAgICJjb21wYWN0LWVuY29kaW5nLW5ldCI6ICJeMS4yLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMC40IiwKICAgICJuYW5vYmVuY2giOiAiXjIuMS4xIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2JvZ29uLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9ib2dvbi9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9ib2dvbiIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKbW9kdWxlLmV4cG9ydHMgPSBjb2RlY3MKCmNvZGVjcy5hc2NpaSA9IGNyZWF0ZVN0cmluZygnYXNjaWknKQpjb2RlY3MudXRmOCA9IGNyZWF0ZVN0cmluZygndXRmLTgnKQpjb2RlY3MuaGV4ID0gY3JlYXRlU3RyaW5nKCdoZXgnKQpjb2RlY3MuYmFzZTY0ID0gY3JlYXRlU3RyaW5nKCdiYXNlNjQnKQpjb2RlY3MudWNzMiA9IGNyZWF0ZVN0cmluZygndWNzMicpCmNvZGVjcy51dGYxNmxlID0gY3JlYXRlU3RyaW5nKCd1dGYxNmxlJykKY29kZWNzLm5kanNvbiA9IGNyZWF0ZUpTT04odHJ1ZSkKY29kZWNzLmpzb24gPSBjcmVhdGVKU09OKGZhbHNlKQpjb2RlY3MuYmluYXJ5ID0gewogIG5hbWU6ICdiaW5hcnknLAogIGVuY29kZTogZnVuY3Rpb24gZW5jb2RlQmluYXJ5IChvYmopIHsKICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnc3RyaW5nJwogICAgICA/IGI0YS5mcm9tKG9iaiwgJ3V0Zi04JykKICAgICAgOiBiNGEudG9CdWZmZXIob2JqKQogIH0sCiAgZGVjb2RlOiBmdW5jdGlvbiBkZWNvZGVCaW5hcnkgKGJ1ZikgewogICAgcmV0dXJuIGI0YS50b0J1ZmZlcihidWYpCiAgfQp9CgpmdW5jdGlvbiBpc0NvbXBhY3RFbmNvZGluZyAoYykgewogIHJldHVybiAhIShjLmVuY29kZSAmJiBjLmRlY29kZSAmJiBjLnByZWVuY29kZSkKfQoKZnVuY3Rpb24gZnJvbUNvbXBhY3RFbmNvZGluZyAoYykgewogIHJldHVybiB7CiAgICBuYW1lOiAnY29tcGFjdC1lbmNvZGluZycsCiAgICBlbmNvZGU6IGZ1bmN0aW9uIGVuY29kZVdpdGhDb21wYWN0ICh2YWx1ZSkgewogICAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogMCwgYnVmZmVyOiBudWxsLCBjYWNoZTogbnVsbCB9CiAgICAgIGMucHJlZW5jb2RlKHN0YXRlLCB2YWx1ZSkKICAgICAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHN0YXRlLmVuZCkKICAgICAgYy5lbmNvZGUoc3RhdGUsIHZhbHVlKQogICAgICByZXR1cm4gc3RhdGUuYnVmZmVyCiAgICB9LAogICAgZGVjb2RlOiBmdW5jdGlvbiBkZWNvZGVXaXRoQ29tcGFjdCAoYnVmZmVyKSB7CiAgICAgIHJldHVybiBjLmRlY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoLCBidWZmZXIsIGNhY2hlOiBudWxsIH0pCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBjb2RlY3MgKGZtdCwgZmFsbGJhY2spIHsKICBpZiAodHlwZW9mIGZtdCA9PT0gJ29iamVjdCcgJiYgZm10KSB7CiAgICByZXR1cm4gaXNDb21wYWN0RW5jb2RpbmcoZm10KSA/IGZyb21Db21wYWN0RW5jb2RpbmcoZm10KSA6IGZtdAogIH0KCiAgc3dpdGNoIChmbXQpIHsKICAgIGNhc2UgJ25kanNvbic6IHJldHVybiBjb2RlY3MubmRqc29uCiAgICBjYXNlICdqc29uJzogcmV0dXJuIGNvZGVjcy5qc29uCiAgICBjYXNlICdhc2NpaSc6IHJldHVybiBjb2RlY3MuYXNjaWkKICAgIGNhc2UgJ3V0Zi04JzoKICAgIGNhc2UgJ3V0ZjgnOiByZXR1cm4gY29kZWNzLnV0ZjgKICAgIGNhc2UgJ2hleCc6IHJldHVybiBjb2RlY3MuaGV4CiAgICBjYXNlICdiYXNlNjQnOiByZXR1cm4gY29kZWNzLmJhc2U2NAogICAgY2FzZSAndWNzLTInOgogICAgY2FzZSAndWNzMic6IHJldHVybiBjb2RlY3MudWNzMgogICAgY2FzZSAndXRmMTYtbGUnOgogICAgY2FzZSAndXRmMTZsZSc6IHJldHVybiBjb2RlY3MudXRmMTZsZQogIH0KCiAgcmV0dXJuIGZhbGxiYWNrICE9PSB1bmRlZmluZWQgPyBmYWxsYmFjayA6IGNvZGVjcy5iaW5hcnkKfQoKZnVuY3Rpb24gY3JlYXRlSlNPTiAobmV3bGluZSkgewogIHJldHVybiB7CiAgICBuYW1lOiBuZXdsaW5lID8gJ25kanNvbicgOiAnanNvbicsCiAgICBlbmNvZGU6IG5ld2xpbmUgPyBlbmNvZGVOREpTT04gOiBlbmNvZGVKU09OLAogICAgZGVjb2RlOiBmdW5jdGlvbiBkZWNvZGVKU09OIChidWYpIHsKICAgICAgcmV0dXJuIEpTT04ucGFyc2UoYjRhLnRvU3RyaW5nKGJ1ZikpCiAgICB9CiAgfQoKICBmdW5jdGlvbiBlbmNvZGVKU09OICh2YWwpIHsKICAgIHJldHVybiBiNGEuZnJvbShKU09OLnN0cmluZ2lmeSh2YWwpKQogIH0KCiAgZnVuY3Rpb24gZW5jb2RlTkRKU09OICh2YWwpIHsKICAgIHJldHVybiBiNGEuZnJvbShKU09OLnN0cmluZ2lmeSh2YWwpICsgJ1xuJykKICB9Cn0KCmZ1bmN0aW9uIGNyZWF0ZVN0cmluZyAodHlwZSkgewogIHJldHVybiB7CiAgICBuYW1lOiB0eXBlLAogICAgZW5jb2RlOiBmdW5jdGlvbiBlbmNvZGVTdHJpbmcgKHZhbCkgewogICAgICBpZiAodHlwZW9mIHZhbCAhPT0gJ3N0cmluZycpIHZhbCA9IHZhbC50b1N0cmluZygpCiAgICAgIHJldHVybiBiNGEuZnJvbSh2YWwsIHR5cGUpCiAgICB9LAogICAgZGVjb2RlOiBmdW5jdGlvbiBkZWNvZGVTdHJpbmcgKGJ1ZikgewogICAgICByZXR1cm4gYjRhLnRvU3RyaW5nKGJ1ZiwgdHlwZSkKICAgIH0KICB9Cn0KewogICJuYW1lIjogImNvZGVjcyIsCiAgInZlcnNpb24iOiAiMy4xLjAiLAogICJkZXNjcmlwdGlvbiI6ICJDcmVhdGUgYW4gYmluYXJ5IGVuY29kZXIvZGVjb2RlciBmb3IganNvbiwgdXRmLTggb3IgY3VzdG9tIHR5cGVzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi4zIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjIuMSIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xMS4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvY29kZWNzLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9jb2RlY3MvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvY29kZWNzIgp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gYml0ZmllbGQgKGxlbmd0aCkgewogIGlmIChsZW5ndGggPiA2NCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0JpdGZpZWxkIGNhbm5vdCBiZSBsYXJnZXIgdGhhbiA2NCBiaXRzJykKCiAgbGV0IGJ5dGVMZW5ndGgKICBpZiAobGVuZ3RoIDwgOCkgYnl0ZUxlbmd0aCA9IDEKICBlbHNlIGlmIChsZW5ndGggPD0gMTYpIGJ5dGVMZW5ndGggPSAyCiAgZWxzZSBpZiAobGVuZ3RoIDw9IDMyKSBieXRlTGVuZ3RoID0gNAogIGVsc2UgYnl0ZUxlbmd0aCA9IDgKCiAgcmV0dXJuIHsKICAgIHByZWVuY29kZSAoc3RhdGUpIHsKICAgICAgc3RhdGUuZW5kKysgLy8gTGVuZ3RoIGJ5dGUsIHVzZWQgZm9yIGRhdGEgd2hlbiBieXRlTGVuZ3RoID09PSAxCgogICAgICBpZiAoYnl0ZUxlbmd0aCA9PT0gMSkgOwogICAgICBlbHNlIGlmIChieXRlTGVuZ3RoID09PSAyKSBjLnVpbnQxNi5wcmVlbmNvZGUoc3RhdGUpCiAgICAgIGVsc2UgaWYgKGJ5dGVMZW5ndGggPT09IDQpIGMudWludDMyLnByZWVuY29kZShzdGF0ZSkKICAgICAgZWxzZSBjLnVpbnQ2NC5wcmVlbmNvZGUoc3RhdGUpCiAgICB9LAoKICAgIGVuY29kZSAoc3RhdGUsIGIpIHsKICAgICAgaWYgKGJ5dGVMZW5ndGggPT09IDEpIDsKICAgICAgZWxzZSBpZiAoYnl0ZUxlbmd0aCA9PT0gMikgYy51aW50OC5lbmNvZGUoc3RhdGUsIDB4ZmQpCiAgICAgIGVsc2UgaWYgKGJ5dGVMZW5ndGggPT09IDQpIGMudWludDguZW5jb2RlKHN0YXRlLCAweGZlKQogICAgICBlbHNlIGMudWludDguZW5jb2RlKHN0YXRlLCAweGZmKQoKICAgICAgaWYgKHR5cGVvZiBiID09PSAnbnVtYmVyJykgewogICAgICAgIGlmIChieXRlTGVuZ3RoID09PSAxKSBjLnVpbnQ4LmVuY29kZShzdGF0ZSwgYikKICAgICAgICBlbHNlIGlmIChieXRlTGVuZ3RoID09PSAyKSBjLnVpbnQxNi5lbmNvZGUoc3RhdGUsIGIpCiAgICAgICAgZWxzZSBpZiAoYnl0ZUxlbmd0aCA9PT0gNCkgYy51aW50MzIuZW5jb2RlKHN0YXRlLCBiKQogICAgICAgIGVsc2UgYy51aW50NjQuZW5jb2RlKHN0YXRlLCBiKQogICAgICB9IGVsc2UgewogICAgICAgIHN0YXRlLmJ1ZmZlci5zZXQoYiwgc3RhdGUuc3RhcnQpCgogICAgICAgIGlmIChiLmJ5dGVMZW5ndGggPCBieXRlTGVuZ3RoKSB7CiAgICAgICAgICAvLyBaZXJvLWZpbGwgdGhlIHJlc3Qgb2YgdGhlIGJ5dGUgbGVuZ3RoLgogICAgICAgICAgc3RhdGUuYnVmZmVyLmZpbGwoCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIHN0YXRlLnN0YXJ0ICsgYi5ieXRlTGVuZ3RoLAogICAgICAgICAgICBzdGF0ZS5zdGFydCArIGJ5dGVMZW5ndGgKICAgICAgICAgICkKICAgICAgICB9CgogICAgICAgIHN0YXRlLnN0YXJ0ICs9IGJ5dGVMZW5ndGgKICAgICAgfQogICAgfSwKCiAgICBkZWNvZGUgKHN0YXRlKSB7CiAgICAgIGNvbnN0IGJ5dGUgPSBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnRdCgogICAgICBsZXQgYnl0ZUxlbmd0aAogICAgICBpZiAoYnl0ZSA8PSAweGZjKSBieXRlTGVuZ3RoID0gMQogICAgICBlbHNlIGlmIChieXRlID09PSAweGZkKSBieXRlTGVuZ3RoID0gMgogICAgICBlbHNlIGlmIChieXRlID09PSAweGZlKSBieXRlTGVuZ3RoID0gNAogICAgICBlbHNlIGJ5dGVMZW5ndGggPSA4CgogICAgICBpZiAoYnl0ZUxlbmd0aCA+IDEpIHN0YXRlLnN0YXJ0KysgLy8gU2tpcCB0aGUgbGVuZ3RoIGJ5dGUKCiAgICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IGJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCgogICAgICBjb25zdCBiID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0LCAoc3RhdGUuc3RhcnQgKz0gYnl0ZUxlbmd0aCkpCgogICAgICByZXR1cm4gbGVuZ3RoIDw9IDggPyBiLnN1YmFycmF5KDAsIDEpIDogYgogICAgfQogIH0KfQp7CiAgIm5hbWUiOiAiY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZCIsCiAgInZlcnNpb24iOiAiMS4wLjAiLAogICJkZXNjcmlwdGlvbiI6ICJDb21wYWN0IGNvZGVjIGZvciBiaXRmaWVsZHMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5tanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vY29tcGFjdC1lbmNvZGluZy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkLmdpdCIKICB9LAogICJhdXRob3IiOiAiS2FzcGVyIElzYWdlciBEYWxzZ2Fyw7AgPGthc3BlckBmdW5rdGlvbmVsLmNvPiIsCiAgImxpY2Vuc2UiOiAiSVNDIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2NvbXBhY3QtZW5jb2RpbmcvY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2NvbXBhY3QtZW5jb2RpbmcvY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZCNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi40LjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjEuMy41IiwKICAgICJzdGFuZGFyZCI6ICJeMTYuMC4zIgogIH0sCiAgInN0YW5kYXJkIjogewogICAgImlnbm9yZSI6IFsKICAgICAgIl9fc25hcHNob3RzX18vKioiCiAgICBdCiAgfQp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKCmNvbnN0IHBvcnQgPSBjLnVpbnQxNgoKY29uc3QgYWRkcmVzcyA9IChob3N0LCBmYW1pbHkpID0+IHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgICBob3N0LnByZWVuY29kZShzdGF0ZSwgbS5ob3N0KQogICAgICBwb3J0LnByZWVuY29kZShzdGF0ZSwgbS5wb3J0KQogICAgfSwKICAgIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgICAgaG9zdC5lbmNvZGUoc3RhdGUsIG0uaG9zdCkKICAgICAgcG9ydC5lbmNvZGUoc3RhdGUsIG0ucG9ydCkKICAgIH0sCiAgICBkZWNvZGUgKHN0YXRlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgaG9zdDogaG9zdC5kZWNvZGUoc3RhdGUpLAogICAgICAgIGZhbWlseSwKICAgICAgICBwb3J0OiBwb3J0LmRlY29kZShzdGF0ZSkKICAgICAgfQogICAgfQogIH0KfQoKY29uc3QgaXB2NCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlKSB7CiAgICBzdGF0ZS5lbmQgKz0gNAogIH0sCiAgZW5jb2RlIChzdGF0ZSwgc3RyaW5nKSB7CiAgICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgICBjb25zdCBlbmQgPSBzdGFydCArIDQKCiAgICBsZXQgaSA9IDAKCiAgICB3aGlsZSAoaSA8IHN0cmluZy5sZW5ndGgpIHsKICAgICAgbGV0IG4gPSAwCiAgICAgIGxldCBjCgogICAgICB3aGlsZSAoaSA8IHN0cmluZy5sZW5ndGggJiYgKGMgPSBzdHJpbmcuY2hhckNvZGVBdChpKyspKSAhPT0gLyogLiAqLyAweDJlKSB7CiAgICAgICAgbiA9IG4gKiAxMCArIChjIC0gLyogMCAqLyAweDMwKQogICAgICB9CgogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuCiAgICB9CgogICAgc3RhdGUuc3RhcnQgPSBlbmQKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDQpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gKAogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKyAnLicgKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKyAnLicgKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKyAnLicgKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICkKICB9Cn0KCmNvbnN0IGlwdjRBZGRyZXNzID0gYWRkcmVzcyhpcHY0LCA0KQoKY29uc3QgaXB2NiA9IHsKICBwcmVlbmNvZGUgKHN0YXRlKSB7CiAgICBzdGF0ZS5lbmQgKz0gMTYKICB9LAogIGVuY29kZSAoc3RhdGUsIHN0cmluZykgewogICAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogICAgY29uc3QgZW5kID0gc3RhcnQgKyAxNgoKICAgIGxldCBpID0gMAogICAgbGV0IHNwbGl0ID0gbnVsbAoKICAgIHdoaWxlIChpIDwgc3RyaW5nLmxlbmd0aCkgewogICAgICBsZXQgbiA9IDAKICAgICAgbGV0IGMKCiAgICAgIHdoaWxlIChpIDwgc3RyaW5nLmxlbmd0aCAmJiAoYyA9IHN0cmluZy5jaGFyQ29kZUF0KGkrKykpICE9PSAvKiA6ICovIDB4M2EpIHsKICAgICAgICBpZiAoYyA+PSAweDMwICYmIGMgPD0gMHgzOSkgbiA9IG4gKiAweDEwICsgKGMgLSAvKiAwICovIDB4MzApCiAgICAgICAgZWxzZSBpZiAoYyA+PSAweDQxICYmIGMgPD0gMHg0NikgbiA9IG4gKiAweDEwICsgKGMgLSAvKiBBICovIDB4NDEgKyAxMCkKICAgICAgICBlbHNlIGlmIChjID49IDB4NjEgJiYgYyA8PSAweDY2KSBuID0gbiAqIDB4MTAgKyAoYyAtIC8qIGEgKi8gMHg2MSArIDEwKQogICAgICB9CgogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuID4+PiA4CiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KCiAgICAgIGlmIChpIDwgc3RyaW5nLmxlbmd0aCAmJiBzdHJpbmcuY2hhckNvZGVBdChpKSA9PT0gLyogOiAqLyAweDNhKSB7CiAgICAgICAgaSsrCiAgICAgICAgc3BsaXQgPSBzdGF0ZS5zdGFydAogICAgICB9CiAgICB9CgogICAgaWYgKHNwbGl0ICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IG9mZnNldCA9IGVuZCAtIHN0YXRlLnN0YXJ0CiAgICAgIHN0YXRlLmJ1ZmZlcgogICAgICAgIC5jb3B5V2l0aGluKHNwbGl0ICsgb2Zmc2V0LCBzcGxpdCkKICAgICAgICAuZmlsbCgwLCBzcGxpdCwgc3BsaXQgKyBvZmZzZXQpCiAgICB9CgogICAgc3RhdGUuc3RhcnQgPSBlbmQKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDE2KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuICgKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSkudG9TdHJpbmcoMTYpICsgJzonICsKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSkudG9TdHJpbmcoMTYpICsgJzonICsKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSkudG9TdHJpbmcoMTYpICsgJzonICsKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSkudG9TdHJpbmcoMTYpICsgJzonICsKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSkudG9TdHJpbmcoMTYpICsgJzonICsKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSkudG9TdHJpbmcoMTYpICsgJzonICsKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSkudG9TdHJpbmcoMTYpICsgJzonICsKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSkudG9TdHJpbmcoMTYpCiAgICApCiAgfQp9Cgpjb25zdCBpcHY2QWRkcmVzcyA9IGFkZHJlc3MoaXB2NiwgNikKCmNvbnN0IGlwID0gewogIHByZWVuY29kZSAoc3RhdGUsIHN0cmluZykgewogICAgY29uc3QgZmFtaWx5ID0gc3RyaW5nLmluY2x1ZGVzKCc6JykgPyA2IDogNAogICAgYy51aW50OC5wcmVlbmNvZGUoc3RhdGUsIGZhbWlseSkKICAgIGlmIChmYW1pbHkgPT09IDQpIGlwdjQucHJlZW5jb2RlKHN0YXRlKQogICAgZWxzZSBpcHY2LnByZWVuY29kZShzdGF0ZSkKICB9LAogIGVuY29kZSAoc3RhdGUsIHN0cmluZykgewogICAgY29uc3QgZmFtaWx5ID0gc3RyaW5nLmluY2x1ZGVzKCc6JykgPyA2IDogNAogICAgYy51aW50OC5lbmNvZGUoc3RhdGUsIGZhbWlseSkKICAgIGlmIChmYW1pbHkgPT09IDQpIGlwdjQuZW5jb2RlKHN0YXRlLCBzdHJpbmcpCiAgICBlbHNlIGlwdjYuZW5jb2RlKHN0YXRlLCBzdHJpbmcpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmYW1pbHkgPSBjLnVpbnQ4LmRlY29kZShzdGF0ZSkKICAgIGlmIChmYW1pbHkgPT09IDQpIHJldHVybiBpcHY0LmRlY29kZShzdGF0ZSkKICAgIGVsc2UgcmV0dXJuIGlwdjYuZGVjb2RlKHN0YXRlKQogIH0KfQoKY29uc3QgaXBBZGRyZXNzID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGlwLnByZWVuY29kZShzdGF0ZSwgbS5ob3N0KQogICAgcG9ydC5wcmVlbmNvZGUoc3RhdGUsIG0ucG9ydCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGlwLmVuY29kZShzdGF0ZSwgbS5ob3N0KQogICAgcG9ydC5lbmNvZGUoc3RhdGUsIG0ucG9ydCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IGZhbWlseSA9IGMudWludDguZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgaG9zdDogZmFtaWx5ID09PSA0ID8gaXB2NC5kZWNvZGUoc3RhdGUpIDogaXB2Ni5kZWNvZGUoc3RhdGUpLAogICAgICBmYW1pbHksCiAgICAgIHBvcnQ6IHBvcnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgcG9ydCwKICBpcHY0LAogIGlwdjRBZGRyZXNzLAogIGlwdjYsCiAgaXB2NkFkZHJlc3MsCiAgaXAsCiAgaXBBZGRyZXNzCn0KewogICJuYW1lIjogImNvbXBhY3QtZW5jb2RpbmctbmV0IiwKICAidmVyc2lvbiI6ICIxLjIuMCIsCiAgImRlc2NyaXB0aW9uIjogIkNvbXBhY3QgY29kZWNzIGZvciBuZXQgdHlwZXMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5tanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vY29tcGFjdC1lbmNvZGluZy9jb21wYWN0LWVuY29kaW5nLW5ldC5naXQiCiAgfSwKICAiYXV0aG9yIjogIkthc3BlciBJc2FnZXIgRGFsc2dhcsOwIDxrYXNwZXJAZnVua3Rpb25lbC5jbz4iLAogICJsaWNlbnNlIjogIklTQyIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9jb21wYWN0LWVuY29kaW5nL2NvbXBhY3QtZW5jb2RpbmctbmV0L2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vY29tcGFjdC1lbmNvZGluZy9jb21wYWN0LWVuY29kaW5nLW5ldCNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi40LjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjEuMy41IiwKICAgICJuYW5vYmVuY2giOiAiXjIuMS4xIiwKICAgICJzdGFuZGFyZCI6ICJeMTYuMC4zIgogIH0KfQpjb25zdCBMRSA9IChleHBvcnRzLkxFID0KICBuZXcgVWludDhBcnJheShuZXcgVWludDE2QXJyYXkoWzB4ZmZdKS5idWZmZXIpWzBdID09PSAweGZmKQoKZXhwb3J0cy5CRSA9ICFMRQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgeyBCRSB9ID0gcmVxdWlyZSgnLi9lbmRpYW4nKQoKZXhwb3J0cy5zdGF0ZSA9IGZ1bmN0aW9uIChzdGFydCA9IDAsIGVuZCA9IDAsIGJ1ZmZlciA9IG51bGwpIHsKICByZXR1cm4geyBzdGFydCwgZW5kLCBidWZmZXIgfQp9Cgpjb25zdCByYXcgPSAoZXhwb3J0cy5yYXcgPSByZXF1aXJlKCcuL3JhdycpKQoKY29uc3QgdWludCA9IChleHBvcnRzLnVpbnQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gbiA8PSAweGZjID8gMSA6IG4gPD0gMHhmZmZmID8gMyA6IG4gPD0gMHhmZmZmZmZmZiA/IDUgOiA5CiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGlmIChuIDw9IDB4ZmMpIHVpbnQ4LmVuY29kZShzdGF0ZSwgbikKICAgIGVsc2UgaWYgKG4gPD0gMHhmZmZmKSB7CiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4ZmQKICAgICAgdWludDE2LmVuY29kZShzdGF0ZSwgbikKICAgIH0gZWxzZSBpZiAobiA8PSAweGZmZmZmZmZmKSB7CiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4ZmUKICAgICAgdWludDMyLmVuY29kZShzdGF0ZSwgbikKICAgIH0gZWxzZSB7CiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4ZmYKICAgICAgdWludDY0LmVuY29kZShzdGF0ZSwgbikKICAgIH0KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgYSA9IHVpbnQ4LmRlY29kZShzdGF0ZSkKICAgIGlmIChhIDw9IDB4ZmMpIHJldHVybiBhCiAgICBpZiAoYSA9PT0gMHhmZCkgcmV0dXJuIHVpbnQxNi5kZWNvZGUoc3RhdGUpCiAgICBpZiAoYSA9PT0gMHhmZSkgcmV0dXJuIHVpbnQzMi5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gdWludDY0LmRlY29kZShzdGF0ZSkKICB9Cn0pCgpjb25zdCB1aW50OCA9IChleHBvcnRzLnVpbnQ4ID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kICs9IDEKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgdmFsaWRhdGVVaW50KG4pCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5zdGFydCA+PSBzdGF0ZS5lbmQpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgfQp9KQoKY29uc3QgdWludDE2ID0gKGV4cG9ydHMudWludDE2ID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kICs9IDIKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgdmFsaWRhdGVVaW50KG4pCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuID4+PiA4CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDIpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMHgxMDAKICB9Cn0pCgpjb25zdCB1aW50MjQgPSAoZXhwb3J0cy51aW50MjQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gMwogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICB2YWxpZGF0ZVVpbnQobikKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDgKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDE2CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDMpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gKAogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMCArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwMDAKICAgICkKICB9Cn0pCgpjb25zdCB1aW50MzIgPSAoZXhwb3J0cy51aW50MzIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gNAogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICB2YWxpZGF0ZVVpbnQobikKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDgKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDE2CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuID4+PiAyNAogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA0KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuICgKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMHgxMDAgKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMDAwICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMHgxMDAwMDAwCiAgICApCiAgfQp9KQoKY29uc3QgdWludDQwID0gKGV4cG9ydHMudWludDQwID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kICs9IDUKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgdmFsaWRhdGVVaW50KG4pCiAgICBjb25zdCByID0gTWF0aC5mbG9vcihuIC8gMHgxMDApCiAgICB1aW50OC5lbmNvZGUoc3RhdGUsIG4pCiAgICB1aW50MzIuZW5jb2RlKHN0YXRlLCByKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA1KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuIHVpbnQ4LmRlY29kZShzdGF0ZSkgKyAweDEwMCAqIHVpbnQzMi5kZWNvZGUoc3RhdGUpCiAgfQp9KQoKY29uc3QgdWludDQ4ID0gKGV4cG9ydHMudWludDQ4ID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kICs9IDYKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgdmFsaWRhdGVVaW50KG4pCiAgICBjb25zdCByID0gTWF0aC5mbG9vcihuIC8gMHgxMDAwMCkKICAgIHVpbnQxNi5lbmNvZGUoc3RhdGUsIG4pCiAgICB1aW50MzIuZW5jb2RlKHN0YXRlLCByKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA2KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuIHVpbnQxNi5kZWNvZGUoc3RhdGUpICsgMHgxMDAwMCAqIHVpbnQzMi5kZWNvZGUoc3RhdGUpCiAgfQp9KQoKY29uc3QgdWludDU2ID0gKGV4cG9ydHMudWludDU2ID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kICs9IDcKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgdmFsaWRhdGVVaW50KG4pCiAgICBjb25zdCByID0gTWF0aC5mbG9vcihuIC8gMHgxMDAwMDAwKQogICAgdWludDI0LmVuY29kZShzdGF0ZSwgbikKICAgIHVpbnQzMi5lbmNvZGUoc3RhdGUsIHIpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDcpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gdWludDI0LmRlY29kZShzdGF0ZSkgKyAweDEwMDAwMDAgKiB1aW50MzIuZGVjb2RlKHN0YXRlKQogIH0KfSkKCmNvbnN0IHVpbnQ2NCA9IChleHBvcnRzLnVpbnQ2NCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSA4CiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHZhbGlkYXRlVWludChuKQogICAgY29uc3QgciA9IE1hdGguZmxvb3IobiAvIDB4MTAwMDAwMDAwKQogICAgdWludDMyLmVuY29kZShzdGF0ZSwgbikKICAgIHVpbnQzMi5lbmNvZGUoc3RhdGUsIHIpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDgpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gdWludDMyLmRlY29kZShzdGF0ZSkgKyAweDEwMDAwMDAwMCAqIHVpbnQzMi5kZWNvZGUoc3RhdGUpCiAgfQp9KQoKY29uc3QgaW50ID0gKGV4cG9ydHMuaW50ID0gemlnWmFnSW50KHVpbnQpKQpleHBvcnRzLmludDggPSB6aWdaYWdJbnQodWludDgpCmV4cG9ydHMuaW50MTYgPSB6aWdaYWdJbnQodWludDE2KQpleHBvcnRzLmludDI0ID0gemlnWmFnSW50KHVpbnQyNCkKZXhwb3J0cy5pbnQzMiA9IHppZ1phZ0ludCh1aW50MzIpCmV4cG9ydHMuaW50NDAgPSB6aWdaYWdJbnQodWludDQwKQpleHBvcnRzLmludDQ4ID0gemlnWmFnSW50KHVpbnQ0OCkKZXhwb3J0cy5pbnQ1NiA9IHppZ1phZ0ludCh1aW50NTYpCmV4cG9ydHMuaW50NjQgPSB6aWdaYWdJbnQodWludDY0KQoKY29uc3QgYmlndWludDY0ID0gKGV4cG9ydHMuYmlndWludDY0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kICs9IDgKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldygKICAgICAgc3RhdGUuYnVmZmVyLmJ1ZmZlciwKICAgICAgc3RhdGUuc3RhcnQgKyBzdGF0ZS5idWZmZXIuYnl0ZU9mZnNldCwKICAgICAgOAogICAgKQogICAgdmlldy5zZXRCaWdVaW50NjQoMCwgbiwgdHJ1ZSkgLy8gbGl0dGxlIGVuZGlhbgogICAgc3RhdGUuc3RhcnQgKz0gOAogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA4KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldygKICAgICAgc3RhdGUuYnVmZmVyLmJ1ZmZlciwKICAgICAgc3RhdGUuc3RhcnQgKyBzdGF0ZS5idWZmZXIuYnl0ZU9mZnNldCwKICAgICAgOAogICAgKQogICAgY29uc3QgbiA9IHZpZXcuZ2V0QmlnVWludDY0KDAsIHRydWUpIC8vIGxpdHRsZSBlbmRpYW4KICAgIHN0YXRlLnN0YXJ0ICs9IDgKICAgIHJldHVybiBuCiAgfQp9KQoKZXhwb3J0cy5iaWdpbnQ2NCA9IHppZ1phZ0JpZ0ludChiaWd1aW50NjQpCgpjb25zdCBiaWd1aW50ID0gKGV4cG9ydHMuYmlndWludCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGxldCBsZW4gPSAwCiAgICBmb3IgKGxldCBtID0gbjsgbTsgbSA9IG0gPj4gNjRuKSBsZW4rKwogICAgdWludC5wcmVlbmNvZGUoc3RhdGUsIGxlbikKICAgIHN0YXRlLmVuZCArPSA4ICogbGVuCiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGxldCBsZW4gPSAwCiAgICBmb3IgKGxldCBtID0gbjsgbTsgbSA9IG0gPj4gNjRuKSBsZW4rKwogICAgdWludC5lbmNvZGUoc3RhdGUsIGxlbikKICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoCiAgICAgIHN0YXRlLmJ1ZmZlci5idWZmZXIsCiAgICAgIHN0YXRlLnN0YXJ0ICsgc3RhdGUuYnVmZmVyLmJ5dGVPZmZzZXQsCiAgICAgIDggKiBsZW4KICAgICkKICAgIGZvciAobGV0IG0gPSBuLCBpID0gMDsgbTsgbSA9IG0gPj4gNjRuLCBpICs9IDgpIHsKICAgICAgdmlldy5zZXRCaWdVaW50NjQoaSwgQmlnSW50LmFzVWludE4oNjQsIG0pLCB0cnVlKSAvLyBsaXR0bGUgZW5kaWFuCiAgICB9CiAgICBzdGF0ZS5zdGFydCArPSA4ICogbGVuCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGxlbiA9IHVpbnQuZGVjb2RlKHN0YXRlKQogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgOCAqIGxlbikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoCiAgICAgIHN0YXRlLmJ1ZmZlci5idWZmZXIsCiAgICAgIHN0YXRlLnN0YXJ0ICsgc3RhdGUuYnVmZmVyLmJ5dGVPZmZzZXQsCiAgICAgIDggKiBsZW4KICAgICkKICAgIGxldCBuID0gMG4KICAgIGZvciAobGV0IGkgPSBsZW4gLSAxOyBpID49IDA7IGktLSkKICAgICAgbiA9IChuIDw8IDY0bikgKyB2aWV3LmdldEJpZ1VpbnQ2NChpICogOCwgdHJ1ZSkgLy8gbGl0dGxlIGVuZGlhbgogICAgc3RhdGUuc3RhcnQgKz0gOCAqIGxlbgogICAgcmV0dXJuIG4KICB9Cn0pCgpleHBvcnRzLmJpZ2ludCA9IHppZ1phZ0JpZ0ludChiaWd1aW50KQoKZXhwb3J0cy5sZXhpbnQgPSByZXF1aXJlKCcuL2xleGludCcpCgpleHBvcnRzLmZsb2F0MzIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gNAogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KAogICAgICBzdGF0ZS5idWZmZXIuYnVmZmVyLAogICAgICBzdGF0ZS5zdGFydCArIHN0YXRlLmJ1ZmZlci5ieXRlT2Zmc2V0LAogICAgICA0CiAgICApCiAgICB2aWV3LnNldEZsb2F0MzIoMCwgbiwgdHJ1ZSkgLy8gbGl0dGxlIGVuZGlhbgogICAgc3RhdGUuc3RhcnQgKz0gNAogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA0KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldygKICAgICAgc3RhdGUuYnVmZmVyLmJ1ZmZlciwKICAgICAgc3RhdGUuc3RhcnQgKyBzdGF0ZS5idWZmZXIuYnl0ZU9mZnNldCwKICAgICAgNAogICAgKQogICAgY29uc3QgZmxvYXQgPSB2aWV3LmdldEZsb2F0MzIoMCwgdHJ1ZSkgLy8gbGl0dGxlIGVuZGlhbgogICAgc3RhdGUuc3RhcnQgKz0gNAogICAgcmV0dXJuIGZsb2F0CiAgfQp9CgpleHBvcnRzLmZsb2F0NjQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gOAogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KAogICAgICBzdGF0ZS5idWZmZXIuYnVmZmVyLAogICAgICBzdGF0ZS5zdGFydCArIHN0YXRlLmJ1ZmZlci5ieXRlT2Zmc2V0LAogICAgICA4CiAgICApCiAgICB2aWV3LnNldEZsb2F0NjQoMCwgbiwgdHJ1ZSkgLy8gbGl0dGxlIGVuZGlhbgogICAgc3RhdGUuc3RhcnQgKz0gOAogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA4KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldygKICAgICAgc3RhdGUuYnVmZmVyLmJ1ZmZlciwKICAgICAgc3RhdGUuc3RhcnQgKyBzdGF0ZS5idWZmZXIuYnl0ZU9mZnNldCwKICAgICAgOAogICAgKQogICAgY29uc3QgZmxvYXQgPSB2aWV3LmdldEZsb2F0NjQoMCwgdHJ1ZSkgLy8gbGl0dGxlIGVuZGlhbgogICAgc3RhdGUuc3RhcnQgKz0gOAogICAgcmV0dXJuIGZsb2F0CiAgfQp9Cgpjb25zdCBidWZmZXIgPSAoZXhwb3J0cy5idWZmZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBpZiAoYikgdWludDhhcnJheS5wcmVlbmNvZGUoc3RhdGUsIGIpCiAgICBlbHNlIHN0YXRlLmVuZCsrCiAgfSwKICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGlmIChiKSB1aW50OGFycmF5LmVuY29kZShzdGF0ZSwgYikKICAgIGVsc2Ugc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMAogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBsZW4gPSB1aW50LmRlY29kZShzdGF0ZSkKICAgIGlmIChsZW4gPT09IDApIHJldHVybiBudWxsCiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCBsZW4pIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0LCAoc3RhdGUuc3RhcnQgKz0gbGVuKSkKICB9Cn0pCgpleHBvcnRzLmJpbmFyeSA9IHsKICAuLi5idWZmZXIsCiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBpZiAodHlwZW9mIGIgPT09ICdzdHJpbmcnKSB1dGY4LnByZWVuY29kZShzdGF0ZSwgYikKICAgIGVsc2UgYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgYikKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgaWYgKHR5cGVvZiBiID09PSAnc3RyaW5nJykgdXRmOC5lbmNvZGUoc3RhdGUsIGIpCiAgICBlbHNlIGJ1ZmZlci5lbmNvZGUoc3RhdGUsIGIpCiAgfQp9CgpleHBvcnRzLmFycmF5YnVmZmVyID0gewogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgdWludC5wcmVlbmNvZGUoc3RhdGUsIGIuYnl0ZUxlbmd0aCkKICAgIHN0YXRlLmVuZCArPSBiLmJ5dGVMZW5ndGgKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgdWludC5lbmNvZGUoc3RhdGUsIGIuYnl0ZUxlbmd0aCkKCiAgICBjb25zdCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYikKCiAgICBzdGF0ZS5idWZmZXIuc2V0KHZpZXcsIHN0YXRlLnN0YXJ0KQogICAgc3RhdGUuc3RhcnQgKz0gYi5ieXRlTGVuZ3RoCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGxlbiA9IHVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGNvbnN0IGIgPSBuZXcgQXJyYXlCdWZmZXIobGVuKQogICAgY29uc3QgdmlldyA9IG5ldyBVaW50OEFycmF5KGIpCgogICAgdmlldy5zZXQoc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0LCAoc3RhdGUuc3RhcnQgKz0gbGVuKSkpCgogICAgcmV0dXJuIGIKICB9Cn0KCmZ1bmN0aW9uIHR5cGVkYXJyYXkoVHlwZWRBcnJheSwgc3dhcCkgewogIGNvbnN0IG4gPSBUeXBlZEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UCgogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgICAgdWludC5wcmVlbmNvZGUoc3RhdGUsIGIubGVuZ3RoKQogICAgICBzdGF0ZS5lbmQgKz0gYi5ieXRlTGVuZ3RoCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICAgIHVpbnQuZW5jb2RlKHN0YXRlLCBiLmxlbmd0aCkKCiAgICAgIGNvbnN0IHZpZXcgPSBuZXcgVWludDhBcnJheShiLmJ1ZmZlciwgYi5ieXRlT2Zmc2V0LCBiLmJ5dGVMZW5ndGgpCgogICAgICBpZiAoQkUgJiYgc3dhcCkgc3dhcCh2aWV3KQoKICAgICAgc3RhdGUuYnVmZmVyLnNldCh2aWV3LCBzdGF0ZS5zdGFydCkKICAgICAgc3RhdGUuc3RhcnQgKz0gYi5ieXRlTGVuZ3RoCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIGNvbnN0IGxlbiA9IHVpbnQuZGVjb2RlKHN0YXRlKQoKICAgICAgbGV0IGIgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIChzdGF0ZS5zdGFydCArPSBsZW4gKiBuKSkKICAgICAgaWYgKGIuYnl0ZUxlbmd0aCAhPT0gbGVuICogbikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgICAgaWYgKGIuYnl0ZU9mZnNldCAlIG4gIT09IDApIGIgPSBuZXcgVWludDhBcnJheShiKQoKICAgICAgaWYgKEJFICYmIHN3YXApIHN3YXAoYikKCiAgICAgIHJldHVybiBuZXcgVHlwZWRBcnJheShiLmJ1ZmZlciwgYi5ieXRlT2Zmc2V0LCBiLmJ5dGVMZW5ndGggLyBuKQogICAgfQogIH0KfQoKY29uc3QgdWludDhhcnJheSA9IChleHBvcnRzLnVpbnQ4YXJyYXkgPSB0eXBlZGFycmF5KFVpbnQ4QXJyYXkpKQpleHBvcnRzLnVpbnQxNmFycmF5ID0gdHlwZWRhcnJheShVaW50MTZBcnJheSwgYjRhLnN3YXAxNikKZXhwb3J0cy51aW50MzJhcnJheSA9IHR5cGVkYXJyYXkoVWludDMyQXJyYXksIGI0YS5zd2FwMzIpCgpleHBvcnRzLmludDhhcnJheSA9IHR5cGVkYXJyYXkoSW50OEFycmF5KQpleHBvcnRzLmludDE2YXJyYXkgPSB0eXBlZGFycmF5KEludDE2QXJyYXksIGI0YS5zd2FwMTYpCmV4cG9ydHMuaW50MzJhcnJheSA9IHR5cGVkYXJyYXkoSW50MzJBcnJheSwgYjRhLnN3YXAzMikKCmV4cG9ydHMuYmlndWludDY0YXJyYXkgPSB0eXBlZGFycmF5KEJpZ1VpbnQ2NEFycmF5LCBiNGEuc3dhcDY0KQpleHBvcnRzLmJpZ2ludDY0YXJyYXkgPSB0eXBlZGFycmF5KEJpZ0ludDY0QXJyYXksIGI0YS5zd2FwNjQpCgpleHBvcnRzLmZsb2F0MzJhcnJheSA9IHR5cGVkYXJyYXkoRmxvYXQzMkFycmF5LCBiNGEuc3dhcDMyKQpleHBvcnRzLmZsb2F0NjRhcnJheSA9IHR5cGVkYXJyYXkoRmxvYXQ2NEFycmF5LCBiNGEuc3dhcDY0KQoKZnVuY3Rpb24gc3RyaW5nKGVuY29kaW5nKSB7CiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgcykgewogICAgICBjb25zdCBsZW4gPSBiNGEuYnl0ZUxlbmd0aChzLCBlbmNvZGluZykKICAgICAgdWludC5wcmVlbmNvZGUoc3RhdGUsIGxlbikKICAgICAgc3RhdGUuZW5kICs9IGxlbgogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgcykgewogICAgICBjb25zdCBsZW4gPSBiNGEuYnl0ZUxlbmd0aChzLCBlbmNvZGluZykKICAgICAgdWludC5lbmNvZGUoc3RhdGUsIGxlbikKICAgICAgYjRhLndyaXRlKHN0YXRlLmJ1ZmZlciwgcywgc3RhdGUuc3RhcnQsIGVuY29kaW5nKQogICAgICBzdGF0ZS5zdGFydCArPSBsZW4KICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgY29uc3QgbGVuID0gdWludC5kZWNvZGUoc3RhdGUpCiAgICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IGxlbikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgICAgcmV0dXJuIGI0YS50b1N0cmluZygKICAgICAgICBzdGF0ZS5idWZmZXIsCiAgICAgICAgZW5jb2RpbmcsCiAgICAgICAgc3RhdGUuc3RhcnQsCiAgICAgICAgKHN0YXRlLnN0YXJ0ICs9IGxlbikKICAgICAgKQogICAgfSwKICAgIGZpeGVkKG4pIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBwcmVlbmNvZGUoc3RhdGUpIHsKICAgICAgICAgIHN0YXRlLmVuZCArPSBuCiAgICAgICAgfSwKICAgICAgICBlbmNvZGUoc3RhdGUsIHMpIHsKICAgICAgICAgIGI0YS53cml0ZShzdGF0ZS5idWZmZXIsIHMsIHN0YXRlLnN0YXJ0LCBuLCBlbmNvZGluZykKICAgICAgICAgIHN0YXRlLnN0YXJ0ICs9IG4KICAgICAgICB9LAogICAgICAgIGRlY29kZShzdGF0ZSkgewogICAgICAgICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgbikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgICAgICAgIHJldHVybiBiNGEudG9TdHJpbmcoCiAgICAgICAgICAgIHN0YXRlLmJ1ZmZlciwKICAgICAgICAgICAgZW5jb2RpbmcsCiAgICAgICAgICAgIHN0YXRlLnN0YXJ0LAogICAgICAgICAgICAoc3RhdGUuc3RhcnQgKz0gbikKICAgICAgICAgICkKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Cn0KCmNvbnN0IHV0ZjggPSAoZXhwb3J0cy5zdHJpbmcgPSBleHBvcnRzLnV0ZjggPSBzdHJpbmcoJ3V0Zi04JykpCmV4cG9ydHMuYXNjaWkgPSBzdHJpbmcoJ2FzY2lpJykKZXhwb3J0cy5oZXggPSBzdHJpbmcoJ2hleCcpCmV4cG9ydHMuYmFzZTY0ID0gc3RyaW5nKCdiYXNlNjQnKQpleHBvcnRzLnVjczIgPSBleHBvcnRzLnV0ZjE2bGUgPSBzdHJpbmcoJ3V0ZjE2bGUnKQoKZXhwb3J0cy5ib29sID0gewogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgc3RhdGUuZW5kKysKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gYiA/IDEgOiAwCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5zdGFydCA+PSBzdGF0ZS5lbmQpIHRocm93IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPT09IDEKICB9Cn0KCmNvbnN0IGZpeGVkID0gKGV4cG9ydHMuZml4ZWQgPSBmdW5jdGlvbiBmaXhlZChuKSB7CiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgcykgewogICAgICBpZiAocy5ieXRlTGVuZ3RoICE9PSBuKSB0aHJvdyBuZXcgRXJyb3IoJ0luY29ycmVjdCBidWZmZXIgc2l6ZScpCiAgICAgIHN0YXRlLmVuZCArPSBuCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBzKSB7CiAgICAgIHN0YXRlLmJ1ZmZlci5zZXQocywgc3RhdGUuc3RhcnQpCiAgICAgIHN0YXRlLnN0YXJ0ICs9IG4KICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgbikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgICAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCwgKHN0YXRlLnN0YXJ0ICs9IG4pKQogICAgfQogIH0KfSkKCmV4cG9ydHMuZml4ZWQzMiA9IGZpeGVkKDMyKQpleHBvcnRzLmZpeGVkNjQgPSBmaXhlZCg2NCkKCmV4cG9ydHMuYXJyYXkgPSBmdW5jdGlvbiBhcnJheShlbmMpIHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBsaXN0KSB7CiAgICAgIHVpbnQucHJlZW5jb2RlKHN0YXRlLCBsaXN0Lmxlbmd0aCkKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSBlbmMucHJlZW5jb2RlKHN0YXRlLCBsaXN0W2ldKQogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgbGlzdCkgewogICAgICB1aW50LmVuY29kZShzdGF0ZSwgbGlzdC5sZW5ndGgpCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgZW5jLmVuY29kZShzdGF0ZSwgbGlzdFtpXSkKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgY29uc3QgbGVuID0gdWludC5kZWNvZGUoc3RhdGUpCiAgICAgIGlmIChsZW4gPiAweDEwMDAwMCkgdGhyb3cgbmV3IEVycm9yKCdBcnJheSBpcyB0b28gYmlnJykKICAgICAgY29uc3QgYXJyID0gbmV3IEFycmF5KGxlbikKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykgYXJyW2ldID0gZW5jLmRlY29kZShzdGF0ZSkKICAgICAgcmV0dXJuIGFycgogICAgfQogIH0KfQoKZXhwb3J0cy5mcmFtZSA9IGZ1bmN0aW9uIGZyYW1lKGVuYykgewogIGNvbnN0IGR1bW15ID0gZXhwb3J0cy5zdGF0ZSgpCgogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgY29uc3QgZW5kID0gc3RhdGUuZW5kCiAgICAgIGVuYy5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICAgIHVpbnQucHJlZW5jb2RlKHN0YXRlLCBzdGF0ZS5lbmQgLSBlbmQpCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIGR1bW15LmVuZCA9IDAKICAgICAgZW5jLnByZWVuY29kZShkdW1teSwgbSkKICAgICAgdWludC5lbmNvZGUoc3RhdGUsIGR1bW15LmVuZCkKICAgICAgZW5jLmVuY29kZShzdGF0ZSwgbSkKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgY29uc3QgZW5kID0gc3RhdGUuZW5kCiAgICAgIGNvbnN0IGxlbiA9IHVpbnQuZGVjb2RlKHN0YXRlKQogICAgICBzdGF0ZS5lbmQgPSBzdGF0ZS5zdGFydCArIGxlbgogICAgICBjb25zdCBtID0gZW5jLmRlY29kZShzdGF0ZSkKICAgICAgc3RhdGUuc3RhcnQgPSBzdGF0ZS5lbmQKICAgICAgc3RhdGUuZW5kID0gZW5kCiAgICAgIHJldHVybiBtCiAgICB9CiAgfQp9CgpleHBvcnRzLmRhdGUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBkKSB7CiAgICBpbnQucHJlZW5jb2RlKHN0YXRlLCBkLmdldFRpbWUoKSkKICB9LAogIGVuY29kZShzdGF0ZSwgZCkgewogICAgaW50LmVuY29kZShzdGF0ZSwgZC5nZXRUaW1lKCkpCiAgfSwKICBkZWNvZGUoc3RhdGUsIGQpIHsKICAgIHJldHVybiBuZXcgRGF0ZShpbnQuZGVjb2RlKHN0YXRlKSkKICB9Cn0KCmV4cG9ydHMuanNvbiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHYpIHsKICAgIHV0ZjgucHJlZW5jb2RlKHN0YXRlLCBKU09OLnN0cmluZ2lmeSh2KSkKICB9LAogIGVuY29kZShzdGF0ZSwgdikgewogICAgdXRmOC5lbmNvZGUoc3RhdGUsIEpTT04uc3RyaW5naWZ5KHYpKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gSlNPTi5wYXJzZSh1dGY4LmRlY29kZShzdGF0ZSkpCiAgfQp9CgpleHBvcnRzLm5kanNvbiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHYpIHsKICAgIHV0ZjgucHJlZW5jb2RlKHN0YXRlLCBKU09OLnN0cmluZ2lmeSh2KSArICdcbicpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHYpIHsKICAgIHV0ZjguZW5jb2RlKHN0YXRlLCBKU09OLnN0cmluZ2lmeSh2KSArICdcbicpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiBKU09OLnBhcnNlKHV0ZjguZGVjb2RlKHN0YXRlKSkKICB9Cn0KCi8vIHNpbXBsZSBoZWxwZXIgZm9yIHdoZW4geW91IHdhbnQgdG8ganVzdCBleHByZXNzIG5vdGhpbmcKZXhwb3J0cy5ub25lID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgLy8gZG8gbm90aGluZwogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICAvLyBkbyBub3RoaW5nCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiBudWxsCiAgfQp9CgovLyAiYW55IiBlbmNvZGVycyBoZXJlIGZvciBoZWxwaW5nIGp1c3Qgc3RydWN0dXJlIGFueSBvYmplY3Qgd2l0aG91dCBzY2hlbWF0aXNpbmcgaXQKCmNvbnN0IGFueUFycmF5ID0gewogIHByZWVuY29kZShzdGF0ZSwgYXJyKSB7CiAgICB1aW50LnByZWVuY29kZShzdGF0ZSwgYXJyLmxlbmd0aCkKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICAgIGFueS5wcmVlbmNvZGUoc3RhdGUsIGFycltpXSkKICAgIH0KICB9LAogIGVuY29kZShzdGF0ZSwgYXJyKSB7CiAgICB1aW50LmVuY29kZShzdGF0ZSwgYXJyLmxlbmd0aCkKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICAgIGFueS5lbmNvZGUoc3RhdGUsIGFycltpXSkKICAgIH0KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgYXJyID0gW10KICAgIGxldCBsZW4gPSB1aW50LmRlY29kZShzdGF0ZSkKICAgIHdoaWxlIChsZW4tLSA+IDApIHsKICAgICAgYXJyLnB1c2goYW55LmRlY29kZShzdGF0ZSkpCiAgICB9CiAgICByZXR1cm4gYXJyCiAgfQp9Cgpjb25zdCBhbnlPYmplY3QgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBvKSB7CiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMobykKICAgIHVpbnQucHJlZW5jb2RlKHN0YXRlLCBrZXlzLmxlbmd0aCkKICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHsKICAgICAgdXRmOC5wcmVlbmNvZGUoc3RhdGUsIGtleSkKICAgICAgYW55LnByZWVuY29kZShzdGF0ZSwgb1trZXldKQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBvKSB7CiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMobykKICAgIHVpbnQuZW5jb2RlKHN0YXRlLCBrZXlzLmxlbmd0aCkKICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHsKICAgICAgdXRmOC5lbmNvZGUoc3RhdGUsIGtleSkKICAgICAgYW55LmVuY29kZShzdGF0ZSwgb1trZXldKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBsZXQgbGVuID0gdWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBvID0ge30KICAgIHdoaWxlIChsZW4tLSA+IDApIHsKICAgICAgY29uc3Qga2V5ID0gdXRmOC5kZWNvZGUoc3RhdGUpCiAgICAgIG9ba2V5XSA9IGFueS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgICByZXR1cm4gbwogIH0KfQoKY29uc3QgYW55VHlwZXMgPSBbCiAgZXhwb3J0cy5ub25lLAogIGV4cG9ydHMuYm9vbCwKICBleHBvcnRzLnN0cmluZywKICBleHBvcnRzLmJ1ZmZlciwKICBleHBvcnRzLnVpbnQsCiAgZXhwb3J0cy5pbnQsCiAgZXhwb3J0cy5mbG9hdDY0LAogIGFueUFycmF5LAogIGFueU9iamVjdCwKICBleHBvcnRzLmRhdGUKXQoKY29uc3QgYW55ID0gKGV4cG9ydHMuYW55ID0gewogIHByZWVuY29kZShzdGF0ZSwgbykgewogICAgY29uc3QgdCA9IGdldFR5cGUobykKICAgIHVpbnQucHJlZW5jb2RlKHN0YXRlLCB0KQogICAgYW55VHlwZXNbdF0ucHJlZW5jb2RlKHN0YXRlLCBvKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBvKSB7CiAgICBjb25zdCB0ID0gZ2V0VHlwZShvKQogICAgdWludC5lbmNvZGUoc3RhdGUsIHQpCiAgICBhbnlUeXBlc1t0XS5lbmNvZGUoc3RhdGUsIG8pCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHQgPSB1aW50LmRlY29kZShzdGF0ZSkKICAgIGlmICh0ID49IGFueVR5cGVzLmxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHR5cGU6ICcgKyB0KQogICAgcmV0dXJuIGFueVR5cGVzW3RdLmRlY29kZShzdGF0ZSkKICB9Cn0pCgpjb25zdCBwb3J0ID0gKGV4cG9ydHMucG9ydCA9IHVpbnQxNikKCmNvbnN0IGFkZHJlc3MgPSAoaG9zdCwgZmFtaWx5KSA9PiB7CiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgICBob3N0LnByZWVuY29kZShzdGF0ZSwgbS5ob3N0KQogICAgICBwb3J0LnByZWVuY29kZShzdGF0ZSwgbS5wb3J0KQogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgbSkgewogICAgICBob3N0LmVuY29kZShzdGF0ZSwgbS5ob3N0KQogICAgICBwb3J0LmVuY29kZShzdGF0ZSwgbS5wb3J0KQogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICByZXR1cm4gewogICAgICAgIGhvc3Q6IGhvc3QuZGVjb2RlKHN0YXRlKSwKICAgICAgICBmYW1pbHksCiAgICAgICAgcG9ydDogcG9ydC5kZWNvZGUoc3RhdGUpCiAgICAgIH0KICAgIH0KICB9Cn0KCmNvbnN0IGlwdjQgPSAoZXhwb3J0cy5pcHY0ID0gewogIHByZWVuY29kZShzdGF0ZSkgewogICAgc3RhdGUuZW5kICs9IDQKICB9LAogIGVuY29kZShzdGF0ZSwgc3RyaW5nKSB7CiAgICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgICBjb25zdCBlbmQgPSBzdGFydCArIDQKCiAgICBsZXQgaSA9IDAKCiAgICB3aGlsZSAoaSA8IHN0cmluZy5sZW5ndGgpIHsKICAgICAgbGV0IG4gPSAwCiAgICAgIGxldCBjCgogICAgICB3aGlsZSAoCiAgICAgICAgaSA8IHN0cmluZy5sZW5ndGggJiYKICAgICAgICAoYyA9IHN0cmluZy5jaGFyQ29kZUF0KGkrKykpICE9PSAvKiAuICovIDB4MmUKICAgICAgKSB7CiAgICAgICAgbiA9IG4gKiAxMCArIChjIC0gLyogMCAqLyAweDMwKQogICAgICB9CgogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuCiAgICB9CgogICAgc3RhdGUuc3RhcnQgPSBlbmQKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgNCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiAoCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArCiAgICAgICcuJyArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArCiAgICAgICcuJyArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArCiAgICAgICcuJyArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogICAgKQogIH0KfSkKCmV4cG9ydHMuaXB2NEFkZHJlc3MgPSBhZGRyZXNzKGlwdjQsIDQpCgpjb25zdCBpcHY2ID0gKGV4cG9ydHMuaXB2NiA9IHsKICBwcmVlbmNvZGUoc3RhdGUpIHsKICAgIHN0YXRlLmVuZCArPSAxNgogIH0sCiAgZW5jb2RlKHN0YXRlLCBzdHJpbmcpIHsKICAgIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgMTYKCiAgICBsZXQgaSA9IDAKICAgIGxldCBzcGxpdCA9IG51bGwKCiAgICB3aGlsZSAoaSA8IHN0cmluZy5sZW5ndGgpIHsKICAgICAgbGV0IG4gPSAwCiAgICAgIGxldCBjCgogICAgICB3aGlsZSAoCiAgICAgICAgaSA8IHN0cmluZy5sZW5ndGggJiYKICAgICAgICAoYyA9IHN0cmluZy5jaGFyQ29kZUF0KGkrKykpICE9PSAvKiA6ICovIDB4M2EKICAgICAgKSB7CiAgICAgICAgaWYgKGMgPj0gMHgzMCAmJiBjIDw9IDB4MzkpIG4gPSBuICogMHgxMCArIChjIC0gLyogMCAqLyAweDMwKQogICAgICAgIGVsc2UgaWYgKGMgPj0gMHg0MSAmJiBjIDw9IDB4NDYpIG4gPSBuICogMHgxMCArIChjIC0gLyogQSAqLyAweDQxICsgMTApCiAgICAgICAgZWxzZSBpZiAoYyA+PSAweDYxICYmIGMgPD0gMHg2NikgbiA9IG4gKiAweDEwICsgKGMgLSAvKiBhICovIDB4NjEgKyAxMCkKICAgICAgfQoKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gOAogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuCgogICAgICBpZiAoaSA8IHN0cmluZy5sZW5ndGggJiYgc3RyaW5nLmNoYXJDb2RlQXQoaSkgPT09IC8qIDogKi8gMHgzYSkgewogICAgICAgIGkrKwogICAgICAgIHNwbGl0ID0gc3RhdGUuc3RhcnQKICAgICAgfQogICAgfQoKICAgIGlmIChzcGxpdCAhPT0gbnVsbCkgewogICAgICBjb25zdCBvZmZzZXQgPSBlbmQgLSBzdGF0ZS5zdGFydAogICAgICBzdGF0ZS5idWZmZXIKICAgICAgICAuY29weVdpdGhpbihzcGxpdCArIG9mZnNldCwgc3BsaXQpCiAgICAgICAgLmZpbGwoMCwgc3BsaXQsIHNwbGl0ICsgb2Zmc2V0KQogICAgfQoKICAgIHN0YXRlLnN0YXJ0ID0gZW5kCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDE2KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuICgKICAgICAgKAogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgICAgICkudG9TdHJpbmcoMTYpICsKICAgICAgJzonICsKICAgICAgKAogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgICAgICkudG9TdHJpbmcoMTYpICsKICAgICAgJzonICsKICAgICAgKAogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgICAgICkudG9TdHJpbmcoMTYpICsKICAgICAgJzonICsKICAgICAgKAogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgICAgICkudG9TdHJpbmcoMTYpICsKICAgICAgJzonICsKICAgICAgKAogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgICAgICkudG9TdHJpbmcoMTYpICsKICAgICAgJzonICsKICAgICAgKAogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgICAgICkudG9TdHJpbmcoMTYpICsKICAgICAgJzonICsKICAgICAgKAogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgICAgICkudG9TdHJpbmcoMTYpICsKICAgICAgJzonICsKICAgICAgKAogICAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDI1NiArCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgICAgICkudG9TdHJpbmcoMTYpCiAgICApCiAgfQp9KQoKZXhwb3J0cy5pcHY2QWRkcmVzcyA9IGFkZHJlc3MoaXB2NiwgNikKCmNvbnN0IGlwID0gKGV4cG9ydHMuaXAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBzdHJpbmcpIHsKICAgIGNvbnN0IGZhbWlseSA9IHN0cmluZy5pbmNsdWRlcygnOicpID8gNiA6IDQKICAgIHVpbnQ4LnByZWVuY29kZShzdGF0ZSwgZmFtaWx5KQogICAgaWYgKGZhbWlseSA9PT0gNCkgaXB2NC5wcmVlbmNvZGUoc3RhdGUpCiAgICBlbHNlIGlwdjYucHJlZW5jb2RlKHN0YXRlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBzdHJpbmcpIHsKICAgIGNvbnN0IGZhbWlseSA9IHN0cmluZy5pbmNsdWRlcygnOicpID8gNiA6IDQKICAgIHVpbnQ4LmVuY29kZShzdGF0ZSwgZmFtaWx5KQogICAgaWYgKGZhbWlseSA9PT0gNCkgaXB2NC5lbmNvZGUoc3RhdGUsIHN0cmluZykKICAgIGVsc2UgaXB2Ni5lbmNvZGUoc3RhdGUsIHN0cmluZykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmFtaWx5ID0gdWludDguZGVjb2RlKHN0YXRlKQogICAgaWYgKGZhbWlseSA9PT0gNCkgcmV0dXJuIGlwdjQuZGVjb2RlKHN0YXRlKQogICAgZWxzZSByZXR1cm4gaXB2Ni5kZWNvZGUoc3RhdGUpCiAgfQp9KQoKZXhwb3J0cy5pcEFkZHJlc3MgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBpcC5wcmVlbmNvZGUoc3RhdGUsIG0uaG9zdCkKICAgIHBvcnQucHJlZW5jb2RlKHN0YXRlLCBtLnBvcnQpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGlwLmVuY29kZShzdGF0ZSwgbS5ob3N0KQogICAgcG9ydC5lbmNvZGUoc3RhdGUsIG0ucG9ydCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmFtaWx5ID0gdWludDguZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgaG9zdDogZmFtaWx5ID09PSA0ID8gaXB2NC5kZWNvZGUoc3RhdGUpIDogaXB2Ni5kZWNvZGUoc3RhdGUpLAogICAgICBmYW1pbHksCiAgICAgIHBvcnQ6IHBvcnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKZnVuY3Rpb24gZ2V0VHlwZShvKSB7CiAgaWYgKG8gPT09IG51bGwgfHwgbyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gMAogIGlmICh0eXBlb2YgbyA9PT0gJ2Jvb2xlYW4nKSByZXR1cm4gMQogIGlmICh0eXBlb2YgbyA9PT0gJ3N0cmluZycpIHJldHVybiAyCiAgaWYgKGI0YS5pc0J1ZmZlcihvKSkgcmV0dXJuIDMKICBpZiAodHlwZW9mIG8gPT09ICdudW1iZXInKSB7CiAgICBpZiAoTnVtYmVyLmlzSW50ZWdlcihvKSkgcmV0dXJuIG8gPj0gMCA/IDQgOiA1CiAgICByZXR1cm4gNgogIH0KICBpZiAoQXJyYXkuaXNBcnJheShvKSkgcmV0dXJuIDcKICBpZiAobyBpbnN0YW5jZW9mIERhdGUpIHJldHVybiA5CiAgaWYgKHR5cGVvZiBvID09PSAnb2JqZWN0JykgcmV0dXJuIDgKCiAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB0eXBlIGZvciAnICsgbykKfQoKZXhwb3J0cy5mcm9tID0gZnVuY3Rpb24gZnJvbShlbmMpIHsKICBpZiAodHlwZW9mIGVuYyA9PT0gJ3N0cmluZycpIHJldHVybiBmcm9tTmFtZWQoZW5jKQogIGlmIChlbmMucHJlZW5jb2RlKSByZXR1cm4gZW5jCiAgaWYgKGVuYy5lbmNvZGluZ0xlbmd0aCkgcmV0dXJuIGZyb21BYnN0cmFjdEVuY29kZXIoZW5jKQogIHJldHVybiBmcm9tQ29kZWMoZW5jKQp9CgpmdW5jdGlvbiBmcm9tTmFtZWQoZW5jKSB7CiAgc3dpdGNoIChlbmMpIHsKICAgIGNhc2UgJ2FzY2lpJzoKICAgICAgcmV0dXJuIHJhdy5hc2NpaQogICAgY2FzZSAndXRmLTgnOgogICAgY2FzZSAndXRmOCc6CiAgICAgIHJldHVybiByYXcudXRmOAogICAgY2FzZSAnaGV4JzoKICAgICAgcmV0dXJuIHJhdy5oZXgKICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgIHJldHVybiByYXcuYmFzZTY0CiAgICBjYXNlICd1dGYxNi1sZSc6CiAgICBjYXNlICd1dGYxNmxlJzoKICAgIGNhc2UgJ3Vjcy0yJzoKICAgIGNhc2UgJ3VjczInOgogICAgICByZXR1cm4gcmF3LnVjczIKICAgIGNhc2UgJ25kanNvbic6CiAgICAgIHJldHVybiByYXcubmRqc29uCiAgICBjYXNlICdqc29uJzoKICAgICAgcmV0dXJuIHJhdy5qc29uCiAgICBjYXNlICdiaW5hcnknOgogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIHJhdy5iaW5hcnkKICB9Cn0KCmZ1bmN0aW9uIGZyb21Db2RlYyhlbmMpIHsKICBsZXQgdG1wTSA9IG51bGwKICBsZXQgdG1wQnVmID0gbnVsbAoKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIHRtcE0gPSBtCiAgICAgIHRtcEJ1ZiA9IGVuYy5lbmNvZGUobSkKICAgICAgc3RhdGUuZW5kICs9IHRtcEJ1Zi5ieXRlTGVuZ3RoCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIHJhdy5lbmNvZGUoc3RhdGUsIG0gPT09IHRtcE0gPyB0bXBCdWYgOiBlbmMuZW5jb2RlKG0pKQogICAgICB0bXBNID0gdG1wQnVmID0gbnVsbAogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICByZXR1cm4gZW5jLmRlY29kZShyYXcuZGVjb2RlKHN0YXRlKSkKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGZyb21BYnN0cmFjdEVuY29kZXIoZW5jKSB7CiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgICBzdGF0ZS5lbmQgKz0gZW5jLmVuY29kaW5nTGVuZ3RoKG0pCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIGVuYy5lbmNvZGUobSwgc3RhdGUuYnVmZmVyLCBzdGF0ZS5zdGFydCkKICAgICAgc3RhdGUuc3RhcnQgKz0gZW5jLmVuY29kZS5ieXRlcwogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICBjb25zdCBtID0gZW5jLmRlY29kZShzdGF0ZS5idWZmZXIsIHN0YXRlLnN0YXJ0LCBzdGF0ZS5lbmQpCiAgICAgIHN0YXRlLnN0YXJ0ICs9IGVuYy5kZWNvZGUuYnl0ZXMKICAgICAgcmV0dXJuIG0KICAgIH0KICB9Cn0KCmV4cG9ydHMuZW5jb2RlID0gZnVuY3Rpb24gZW5jb2RlKGVuYywgbSkgewogIGNvbnN0IHN0YXRlID0gZXhwb3J0cy5zdGF0ZSgpCiAgZW5jLnByZWVuY29kZShzdGF0ZSwgbSkKICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQogIGVuYy5lbmNvZGUoc3RhdGUsIG0pCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlcgp9CgpleHBvcnRzLmRlY29kZSA9IGZ1bmN0aW9uIGRlY29kZShlbmMsIGJ1ZmZlcikgewogIHJldHVybiBlbmMuZGVjb2RlKGV4cG9ydHMuc3RhdGUoMCwgYnVmZmVyLmJ5dGVMZW5ndGgsIGJ1ZmZlcikpCn0KCmZ1bmN0aW9uIHppZ1phZ0ludChlbmMpIHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICAgIGVuYy5wcmVlbmNvZGUoc3RhdGUsIHppZ1phZ0VuY29kZUludChuKSkKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgICAgZW5jLmVuY29kZShzdGF0ZSwgemlnWmFnRW5jb2RlSW50KG4pKQogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICByZXR1cm4gemlnWmFnRGVjb2RlSW50KGVuYy5kZWNvZGUoc3RhdGUpKQogICAgfQogIH0KfQoKZnVuY3Rpb24gemlnWmFnRGVjb2RlSW50KG4pIHsKICByZXR1cm4gbiA9PT0gMCA/IG4gOiAobiAmIDEpID09PSAwID8gbiAvIDIgOiAtKG4gKyAxKSAvIDIKfQoKZnVuY3Rpb24gemlnWmFnRW5jb2RlSW50KG4pIHsKICAvLyAwLCAtMSwgMSwgLTIsIDIsIC4uLgogIHJldHVybiBuIDwgMCA/IDIgKiAtbiAtIDEgOiBuID09PSAwID8gMCA6IDIgKiBuCn0KCmZ1bmN0aW9uIHppZ1phZ0JpZ0ludChlbmMpIHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICAgIGVuYy5wcmVlbmNvZGUoc3RhdGUsIHppZ1phZ0VuY29kZUJpZ0ludChuKSkKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgICAgZW5jLmVuY29kZShzdGF0ZSwgemlnWmFnRW5jb2RlQmlnSW50KG4pKQogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICByZXR1cm4gemlnWmFnRGVjb2RlQmlnSW50KGVuYy5kZWNvZGUoc3RhdGUpKQogICAgfQogIH0KfQoKZnVuY3Rpb24gemlnWmFnRGVjb2RlQmlnSW50KG4pIHsKICByZXR1cm4gbiA9PT0gMG4gPyBuIDogKG4gJiAxbikgPT09IDBuID8gbiAvIDJuIDogLShuICsgMW4pIC8gMm4KfQoKZnVuY3Rpb24gemlnWmFnRW5jb2RlQmlnSW50KG4pIHsKICAvLyAwLCAtMSwgMSwgLTIsIDIsIC4uLgogIHJldHVybiBuIDwgMG4gPyAybiAqIC1uIC0gMW4gOiBuID09PSAwbiA/IDBuIDogMm4gKiBuCn0KCmZ1bmN0aW9uIHZhbGlkYXRlVWludChuKSB7CiAgaWYgKG4gPj0gMCA9PT0gZmFsc2UgLyogSGFuZGxlcyBOYU4gYXMgd2VsbCAqLykKICAgIHRocm93IG5ldyBFcnJvcigndWludCBtdXN0IGJlIHBvc2l0aXZlJykKfQptb2R1bGUuZXhwb3J0cyA9IHsKICBwcmVlbmNvZGUsCiAgZW5jb2RlLAogIGRlY29kZQp9CgpmdW5jdGlvbiBwcmVlbmNvZGUoc3RhdGUsIG51bSkgewogIGlmIChudW0gPCAyNTEpIHsKICAgIHN0YXRlLmVuZCsrCiAgfSBlbHNlIGlmIChudW0gPCAyNTYpIHsKICAgIHN0YXRlLmVuZCArPSAyCiAgfSBlbHNlIGlmIChudW0gPCAweDEwMDAwKSB7CiAgICBzdGF0ZS5lbmQgKz0gMwogIH0gZWxzZSBpZiAobnVtIDwgMHgxMDAwMDAwKSB7CiAgICBzdGF0ZS5lbmQgKz0gNAogIH0gZWxzZSBpZiAobnVtIDwgMHgxMDAwMDAwMDApIHsKICAgIHN0YXRlLmVuZCArPSA1CiAgfSBlbHNlIHsKICAgIHN0YXRlLmVuZCsrCiAgICBjb25zdCBleHAgPSBNYXRoLmZsb29yKE1hdGgubG9nKG51bSkgLyBNYXRoLmxvZygyKSkgLSAzMgogICAgcHJlZW5jb2RlKHN0YXRlLCBleHApCiAgICBzdGF0ZS5lbmQgKz0gNgogIH0KfQoKZnVuY3Rpb24gZW5jb2RlKHN0YXRlLCBudW0pIHsKICBjb25zdCBtYXggPSAyNTEKICBjb25zdCB4ID0gbnVtIC0gbWF4CgogIGlmIChudW0gPCBtYXgpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG51bQogIH0gZWxzZSBpZiAobnVtIDwgMjU2KSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBtYXgKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IHgKICB9IGVsc2UgaWYgKG51bSA8IDB4MTAwMDApIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG1heCArIDEKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9ICh4ID4+IDgpICYgMHhmZgogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0geCAmIDB4ZmYKICB9IGVsc2UgaWYgKG51bSA8IDB4MTAwMDAwMCkgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbWF4ICsgMgogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0geCA+PiAxNgogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gKHggPj4gOCkgJiAweGZmCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSB4ICYgMHhmZgogIH0gZWxzZSBpZiAobnVtIDwgMHgxMDAwMDAwMDApIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG1heCArIDMKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IHggPj4gMjQKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9ICh4ID4+IDE2KSAmIDB4ZmYKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9ICh4ID4+IDgpICYgMHhmZgogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0geCAmIDB4ZmYKICB9IGVsc2UgewogICAgLy8gbmVlZCB0byB1c2UgTWF0aCBoZXJlIGFzIGJpdHdpc2Ugb3BzIGFyZSAzMiBiaXQKICAgIGNvbnN0IGV4cCA9IE1hdGguZmxvb3IoTWF0aC5sb2coeCkgLyBNYXRoLmxvZygyKSkgLSAzMgogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHhmZgoKICAgIGVuY29kZShzdGF0ZSwgZXhwKQogICAgY29uc3QgcmVtID0geCAvIE1hdGgucG93KDIsIGV4cCAtIDExKQoKICAgIGZvciAobGV0IGkgPSA1OyBpID49IDA7IGktLSkgewogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAocmVtIC8gTWF0aC5wb3coMiwgOCAqIGkpKSAmIDB4ZmYKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGRlY29kZShzdGF0ZSkgewogIGNvbnN0IG1heCA9IDI1MQoKICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCAxKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQoKICBjb25zdCBmbGFnID0gc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCgogIGlmIChmbGFnIDwgbWF4KSByZXR1cm4gZmxhZwoKICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCBmbGFnIC0gbWF4ICsgMSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzLicpCiAgfQoKICBpZiAoZmxhZyA8IDI1MikgewogICAgcmV0dXJuIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArIG1heAogIH0KCiAgaWYgKGZsYWcgPCAyNTMpIHsKICAgIHJldHVybiAoCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPDwgOCkgKyBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKyBtYXgKICAgICkKICB9CgogIGlmIChmbGFnIDwgMjU0KSB7CiAgICByZXR1cm4gKAogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdIDw8IDE2KSArCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPDwgOCkgKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKwogICAgICBtYXgKICAgICkKICB9CgogIC8vIDw8IDI0IHJlc3VsdCBtYXkgYmUgaW50ZXJwcmV0ZWQgYXMgbmVnYXRpdmUKICBpZiAoZmxhZyA8IDI1NSkgewogICAgcmV0dXJuICgKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMHgxMDAwMDAwICsKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA8PCAxNikgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdIDw8IDgpICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsKICAgICAgbWF4CiAgICApCiAgfQoKICBjb25zdCBleHAgPSBkZWNvZGUoc3RhdGUpCgogIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDYpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCgogIGxldCByZW0gPSAwCiAgZm9yIChsZXQgaSA9IDU7IGkgPj0gMDsgaS0tKSB7CiAgICByZW0gKz0gc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogTWF0aC5wb3coMiwgOCAqIGkpCiAgfQoKICByZXR1cm4gcmVtICogTWF0aC5wb3coMiwgZXhwIC0gMTEpICsgbWF4Cn0KewogICJuYW1lIjogImNvbXBhY3QtZW5jb2RpbmciLAogICJ2ZXJzaW9uIjogIjIuMTguMCIsCiAgImRlc2NyaXB0aW9uIjogIkEgc2VyaWVzIG9mIGNvbXBhY3QgZW5jb2Rpbmcgc2NoZW1lcyBmb3IgYnVpbGRpbmcgc21hbGwgYW5kIGZhc3QgcGFyc2VycyBhbmQgc2VyaWFsaXplcnMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS4zLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMC4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjEuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC4gLS13cml0ZSIsCiAgICAidGVzdCI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vY29tcGFjdC1lbmNvZGluZy9jb21wYWN0LWVuY29kaW5nLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9jb21wYWN0LWVuY29kaW5nL2NvbXBhY3QtZW5jb2RpbmcvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9jb21wYWN0LWVuY29kaW5nL2NvbXBhY3QtZW5jb2RpbmciCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IHsgQkUgfSA9IHJlcXVpcmUoJy4vZW5kaWFuJykKCmV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIHN0YXRlLmVuZCArPSBiLmJ5dGVMZW5ndGgKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgc3RhdGUuYnVmZmVyLnNldChiLCBzdGF0ZS5zdGFydCkKICAgIHN0YXRlLnN0YXJ0ICs9IGIuYnl0ZUxlbmd0aAogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBiID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0LCBzdGF0ZS5lbmQpCiAgICBzdGF0ZS5zdGFydCA9IHN0YXRlLmVuZAogICAgcmV0dXJuIGIKICB9Cn0KCmNvbnN0IGJ1ZmZlciA9IChleHBvcnRzLmJ1ZmZlciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGlmIChiKSB1aW50OGFycmF5LnByZWVuY29kZShzdGF0ZSwgYikKICAgIGVsc2Ugc3RhdGUuZW5kKysKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgaWYgKGIpIHVpbnQ4YXJyYXkuZW5jb2RlKHN0YXRlLCBiKQogICAgZWxzZSBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAwCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGIgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQpCiAgICBpZiAoYi5ieXRlTGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbAogICAgc3RhdGUuc3RhcnQgPSBzdGF0ZS5lbmQKICAgIHJldHVybiBiCiAgfQp9KQoKZXhwb3J0cy5iaW5hcnkgPSB7CiAgLi4uYnVmZmVyLAogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgaWYgKHR5cGVvZiBiID09PSAnc3RyaW5nJykgdXRmOC5wcmVlbmNvZGUoc3RhdGUsIGIpCiAgICBlbHNlIGJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIGIpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGlmICh0eXBlb2YgYiA9PT0gJ3N0cmluZycpIHV0ZjguZW5jb2RlKHN0YXRlLCBiKQogICAgZWxzZSBidWZmZXIuZW5jb2RlKHN0YXRlLCBiKQogIH0KfQoKZXhwb3J0cy5hcnJheWJ1ZmZlciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIHN0YXRlLmVuZCArPSBiLmJ5dGVMZW5ndGgKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgY29uc3QgdmlldyA9IG5ldyBVaW50OEFycmF5KGIpCgogICAgc3RhdGUuYnVmZmVyLnNldCh2aWV3LCBzdGF0ZS5zdGFydCkKICAgIHN0YXRlLnN0YXJ0ICs9IGIuYnl0ZUxlbmd0aAogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBiID0gbmV3IEFycmF5QnVmZmVyKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0KQogICAgY29uc3QgdmlldyA9IG5ldyBVaW50OEFycmF5KGIpCgogICAgdmlldy5zZXQoc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0KSkKCiAgICBzdGF0ZS5zdGFydCA9IHN0YXRlLmVuZAoKICAgIHJldHVybiBiCiAgfQp9CgpmdW5jdGlvbiB0eXBlZGFycmF5KFR5cGVkQXJyYXksIHN3YXApIHsKICBjb25zdCBuID0gVHlwZWRBcnJheS5CWVRFU19QRVJfRUxFTUVOVAoKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICAgIHN0YXRlLmVuZCArPSBiLmJ5dGVMZW5ndGgKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgICAgY29uc3QgdmlldyA9IG5ldyBVaW50OEFycmF5KGIuYnVmZmVyLCBiLmJ5dGVPZmZzZXQsIGIuYnl0ZUxlbmd0aCkKCiAgICAgIGlmIChCRSAmJiBzd2FwKSBzd2FwKHZpZXcpCgogICAgICBzdGF0ZS5idWZmZXIuc2V0KHZpZXcsIHN0YXRlLnN0YXJ0KQogICAgICBzdGF0ZS5zdGFydCArPSBiLmJ5dGVMZW5ndGgKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgbGV0IGIgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQpCiAgICAgIGlmIChiLmJ5dGVPZmZzZXQgJSBuICE9PSAwKSBiID0gbmV3IFVpbnQ4QXJyYXkoYikKCiAgICAgIGlmIChCRSAmJiBzd2FwKSBzd2FwKGIpCgogICAgICBzdGF0ZS5zdGFydCA9IHN0YXRlLmVuZAoKICAgICAgcmV0dXJuIG5ldyBUeXBlZEFycmF5KGIuYnVmZmVyLCBiLmJ5dGVPZmZzZXQsIGIuYnl0ZUxlbmd0aCAvIG4pCiAgICB9CiAgfQp9Cgpjb25zdCB1aW50OGFycmF5ID0gKGV4cG9ydHMudWludDhhcnJheSA9IHR5cGVkYXJyYXkoVWludDhBcnJheSkpCmV4cG9ydHMudWludDE2YXJyYXkgPSB0eXBlZGFycmF5KFVpbnQxNkFycmF5LCBiNGEuc3dhcDE2KQpleHBvcnRzLnVpbnQzMmFycmF5ID0gdHlwZWRhcnJheShVaW50MzJBcnJheSwgYjRhLnN3YXAzMikKCmV4cG9ydHMuaW50OGFycmF5ID0gdHlwZWRhcnJheShJbnQ4QXJyYXkpCmV4cG9ydHMuaW50MTZhcnJheSA9IHR5cGVkYXJyYXkoSW50MTZBcnJheSwgYjRhLnN3YXAxNikKZXhwb3J0cy5pbnQzMmFycmF5ID0gdHlwZWRhcnJheShJbnQzMkFycmF5LCBiNGEuc3dhcDMyKQoKZXhwb3J0cy5iaWd1aW50NjRhcnJheSA9IHR5cGVkYXJyYXkoQmlnVWludDY0QXJyYXksIGI0YS5zd2FwNjQpCmV4cG9ydHMuYmlnaW50NjRhcnJheSA9IHR5cGVkYXJyYXkoQmlnSW50NjRBcnJheSwgYjRhLnN3YXA2NCkKCmV4cG9ydHMuZmxvYXQzMmFycmF5ID0gdHlwZWRhcnJheShGbG9hdDMyQXJyYXksIGI0YS5zd2FwMzIpCmV4cG9ydHMuZmxvYXQ2NGFycmF5ID0gdHlwZWRhcnJheShGbG9hdDY0QXJyYXksIGI0YS5zd2FwNjQpCgpmdW5jdGlvbiBzdHJpbmcoZW5jb2RpbmcpIHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBzKSB7CiAgICAgIHN0YXRlLmVuZCArPSBiNGEuYnl0ZUxlbmd0aChzLCBlbmNvZGluZykKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIHMpIHsKICAgICAgc3RhdGUuc3RhcnQgKz0gYjRhLndyaXRlKHN0YXRlLmJ1ZmZlciwgcywgc3RhdGUuc3RhcnQsIGVuY29kaW5nKQogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICBjb25zdCBzID0gYjRhLnRvU3RyaW5nKHN0YXRlLmJ1ZmZlciwgZW5jb2RpbmcsIHN0YXRlLnN0YXJ0KQogICAgICBzdGF0ZS5zdGFydCA9IHN0YXRlLmVuZAogICAgICByZXR1cm4gcwogICAgfQogIH0KfQoKY29uc3QgdXRmOCA9IChleHBvcnRzLnN0cmluZyA9IGV4cG9ydHMudXRmOCA9IHN0cmluZygndXRmLTgnKSkKZXhwb3J0cy5hc2NpaSA9IHN0cmluZygnYXNjaWknKQpleHBvcnRzLmhleCA9IHN0cmluZygnaGV4JykKZXhwb3J0cy5iYXNlNjQgPSBzdHJpbmcoJ2Jhc2U2NCcpCmV4cG9ydHMudWNzMiA9IGV4cG9ydHMudXRmMTZsZSA9IHN0cmluZygndXRmMTZsZScpCgpleHBvcnRzLmFycmF5ID0gZnVuY3Rpb24gYXJyYXkoZW5jKSB7CiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgbGlzdCkgewogICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIGxpc3QpIGVuYy5wcmVlbmNvZGUoc3RhdGUsIHZhbHVlKQogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgbGlzdCkgewogICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIGxpc3QpIGVuYy5lbmNvZGUoc3RhdGUsIHZhbHVlKQogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICBjb25zdCBhcnIgPSBbXQogICAgICB3aGlsZSAoc3RhdGUuc3RhcnQgPCBzdGF0ZS5lbmQpIGFyci5wdXNoKGVuYy5kZWNvZGUoc3RhdGUpKQogICAgICByZXR1cm4gYXJyCiAgICB9CiAgfQp9CgpleHBvcnRzLmpzb24gPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCB2KSB7CiAgICB1dGY4LnByZWVuY29kZShzdGF0ZSwgSlNPTi5zdHJpbmdpZnkodikpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHYpIHsKICAgIHV0ZjguZW5jb2RlKHN0YXRlLCBKU09OLnN0cmluZ2lmeSh2KSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIEpTT04ucGFyc2UodXRmOC5kZWNvZGUoc3RhdGUpKQogIH0KfQoKZXhwb3J0cy5uZGpzb24gPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCB2KSB7CiAgICB1dGY4LnByZWVuY29kZShzdGF0ZSwgSlNPTi5zdHJpbmdpZnkodikgKyAnXG4nKQogIH0sCiAgZW5jb2RlKHN0YXRlLCB2KSB7CiAgICB1dGY4LmVuY29kZShzdGF0ZSwgSlNPTi5zdHJpbmdpZnkodikgKyAnXG4nKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gSlNPTi5wYXJzZSh1dGY4LmRlY29kZShzdGF0ZSkpCiAgfQp9CmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ29yZUNvdXBsZXIgewogIGNvbnN0cnVjdG9yICh0YXJnZXQsIHdha2V1cCkgewogICAgdGhpcy50YXJnZXQgPSB0YXJnZXQKICAgIHRoaXMud2FrZXVwID0gd2FrZXVwCiAgICB0aGlzLmNvdXBsZWQgPSBuZXcgU2V0KCkKCiAgICB0aGlzLl9vbnBlZXJhZGRCb3VuZCA9IHRoaXMuX29ucGVlcmFkZC5iaW5kKHRoaXMpCiAgICB0aGlzLnRhcmdldC5vbigncGVlci1hZGQnLCB0aGlzLl9vbnBlZXJhZGRCb3VuZCkKICB9CgogIGFkZCAoY29yZSkgewogICAgY29uc3QgYWRkZWQgPSB0aGlzLmNvdXBsZWQuc2l6ZQogICAgdGhpcy5jb3VwbGVkLmFkZChjb3JlKQogICAgaWYgKGFkZGVkICE9PSB0aGlzLmNvdXBsZWQuc2l6ZSkgdGhpcy5fY291cGxlKGNvcmUpCiAgfQoKICByZW1vdmUgKGNvcmUpIHsKICAgIHRoaXMuY291cGxlZC5kZWxldGUoY29yZSkKICB9CgogIGRlc3Ryb3kgKCkgewogICAgdGhpcy50YXJnZXQub2ZmKCdwZWVyLWFkZCcsIHRoaXMuX29ucGVlcmFkZEJvdW5kKQogIH0KCiAgYXN5bmMgdXBkYXRlIChzdHJlYW0pIHsKICAgIGNvbnN0IG11eGVyID0gc3RyZWFtLnVzZXJEYXRhCiAgICBpZiAoIW11eGVyKSByZXR1cm4KCiAgICB0cnkgewogICAgICBpZiAoIShhd2FpdCB0aGlzLl9oYXNNdXhlcih0aGlzLnRhcmdldCwgbXV4ZXIpKSkgcmV0dXJuCgogICAgICBsZXQgd2FrZXVwID0gbnVsbAoKICAgICAgZm9yIChjb25zdCBjb3JlIG9mIHRoaXMuY291cGxlZCkgewogICAgICAgIGlmIChhd2FpdCB0aGlzLl9oYXNNdXhlcihjb3JlLCBtdXhlcikpIGNvbnRpbnVlCiAgICAgICAgaWYgKHdha2V1cCA9PT0gbnVsbCkgd2FrZXVwID0gW10KICAgICAgICB3YWtldXAucHVzaChjb3JlKQogICAgICB9CgogICAgICBpZiAod2FrZXVwICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy53YWtldXAoc3RyZWFtLCB3YWtldXApCiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICB9CiAgfQoKICBhc3luYyBfY291cGxlIChjb3JlKSB7CiAgICB0cnkgewogICAgICBsZXQgd2FrZXVwID0gbnVsbAoKICAgICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMudGFyZ2V0LnBlZXJzKSB7CiAgICAgICAgaWYgKGF3YWl0IHRoaXMuX2hhc1BlZXIoY29yZSwgcGVlcikpIGNvbnRpbnVlCiAgICAgICAgaWYgKHdha2V1cCA9PT0gbnVsbCkgd2FrZXVwID0gW10KICAgICAgICB3YWtldXAucHVzaChwZWVyKQogICAgICB9CgogICAgICBpZiAod2FrZXVwICE9PSBudWxsICYmIHRoaXMuY291cGxlZC5oYXMoY29yZSkpIHsKICAgICAgICBmb3IgKGNvbnN0IHBlZXIgb2Ygd2FrZXVwKSB0aGlzLndha2V1cChwZWVyLnN0cmVhbSwgW2NvcmVdKQogICAgICB9CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgfQogIH0KCiAgYXN5bmMgX29ucGVlcmFkZCAocGVlcikgewogICAgdHJ5IHsKICAgICAgbGV0IHdha2V1cCA9IG51bGwKCiAgICAgIGZvciAoY29uc3QgY29yZSBvZiB0aGlzLmNvdXBsZWQpIHsKICAgICAgICBpZiAoYXdhaXQgdGhpcy5faGFzUGVlcihjb3JlLCBwZWVyKSkgY29udGludWUKICAgICAgICBpZiAod2FrZXVwID09PSBudWxsKSB3YWtldXAgPSBbXQogICAgICAgIHdha2V1cC5wdXNoKGNvcmUpCiAgICAgIH0KCiAgICAgIGlmICh3YWtldXAgIT09IG51bGwpIHsKICAgICAgICB0aGlzLndha2V1cChwZWVyLnN0cmVhbSwgd2FrZXVwKQogICAgICB9CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgfQogIH0KCiAgX2hhc011eGVyIChjb3JlLCBtdXhlcikgewogICAgY29uc3QgY2ggPSBtdXhlci5nZXRMYXN0Q2hhbm5lbCh7IHByb3RvY29sOiAnaHlwZXJjb3JlJywgaWQ6IGNvcmUuZGlzY292ZXJ5S2V5IH0pCiAgICBpZiAoY2gpIHJldHVybiBjaC5mdWxseU9wZW5lZCgpCgogICAgY29uc3QgY2hhID0gbXV4ZXIuZ2V0TGFzdENoYW5uZWwoeyBwcm90b2NvbDogJ2h5cGVyY29yZS9hbHBoYScsIGlkOiBjb3JlLmRpc2NvdmVyeUtleSB9KQogICAgaWYgKGNoYSkgcmV0dXJuIGNoYS5mdWxseU9wZW5lZCgpCgogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxzZSkKICB9CgogIF9oYXNQZWVyIChjb3JlLCBwZWVyKSB7CiAgICByZXR1cm4gdGhpcy5faGFzTXV4ZXIoY29yZSwgcGVlci5wcm90b211eCkKICB9Cn0KewogICJuYW1lIjogImNvcmUtY291cGxlciIsCiAgInZlcnNpb24iOiAiMi4wLjAiLAogICJkZXNjcmlwdGlvbiI6ICJDb3VwbGUgdGhlIHBlZXJzIG9mIGNvcmVzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAic2FmZXR5LWNhdGNoIjogIl4xLjAuMiIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiY29yZXN0b3JlIjogIl42LjE4LjIiLAogICAgInN0YW5kYXJkIjogIl4xNy4xLjAiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9jb3JlLWNvdXBsZXIuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2ggSW5jIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2NvcmUtY291cGxlci9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2NvcmUtY291cGxlciIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBIeXBlcmNvcmUgPSByZXF1aXJlKCdoeXBlcmNvcmUnKQpjb25zdCBSZWFkeVJlc291cmNlID0gcmVxdWlyZSgncmVhZHktcmVzb3VyY2UnKQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IElEID0gcmVxdWlyZSgnaHlwZXJjb3JlLWlkLWVuY29kaW5nJykKY29uc3QgeyBpc0FuZHJvaWQgfSA9IHJlcXVpcmUoJ3doaWNoLXJ1bnRpbWUnKQpjb25zdCB7IFNUT1JBR0VfRU1QVFksIEFTU0VSVElPTiB9ID0gcmVxdWlyZSgnaHlwZXJjb3JlLWVycm9ycycpCgpjb25zdCBhdWRpdFN0b3JlID0gcmVxdWlyZSgnLi9saWIvYXVkaXQuanMnKQoKY29uc3QgW05TXSA9IGNyeXB0by5uYW1lc3BhY2UoJ2NvcmVzdG9yZScsIDEpCmNvbnN0IERFRkFVTFRfTkFNRVNQQUNFID0gYjRhLmFsbG9jKDMyKSAvLyBUaGlzIGlzIG1lYW50IHRvIGJlIDMyIDAtYnl0ZXMKCmNsYXNzIFN0cmVhbVRyYWNrZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5yZWNvcmRzID0gW10KICB9CgogIGFkZChzdHJlYW0sIGlzRXh0ZXJuYWwpIHsKICAgIGNvbnN0IHJlY29yZCA9IHsgaW5kZXg6IDAsIHN0cmVhbSwgaXNFeHRlcm5hbCB9CiAgICByZWNvcmQuaW5kZXggPSB0aGlzLnJlY29yZHMucHVzaChyZWNvcmQpIC0gMQogICAgcmV0dXJuIHJlY29yZAogIH0KCiAgcmVtb3ZlKHJlY29yZCkgewogICAgY29uc3QgcG9wcGVkID0gdGhpcy5yZWNvcmRzLnBvcCgpCiAgICBpZiAocG9wcGVkID09PSByZWNvcmQpIHJldHVybgogICAgdGhpcy5yZWNvcmRzWyhwb3BwZWQuaW5kZXggPSByZWNvcmQuaW5kZXgpXSA9IHBvcHBlZAogIH0KCiAgYXR0YWNoQWxsKGNvcmUpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5yZWNvcmRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHJlY29yZCA9IHRoaXMucmVjb3Jkc1tpXQogICAgICBjb25zdCBtdXhlciA9IHJlY29yZC5zdHJlYW0ubm9pc2VTdHJlYW0udXNlckRhdGEKICAgICAgaWYgKCFjb3JlLnJlcGxpY2F0b3IuYXR0YWNoZWQobXV4ZXIpKSBjb3JlLnJlcGxpY2F0b3IuYXR0YWNoVG8obXV4ZXIpCiAgICB9CiAgfQoKICBkZXN0cm95KCkgewogICAgLy8gcmV2ZXJzZSBpcyBzYWZlciBjYXVzZSB3ZSBkZWxldGUgbWIKICAgIGZvciAobGV0IGkgPSB0aGlzLnJlY29yZHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgcmVjb3JkID0gdGhpcy5yZWNvcmRzW2ldCiAgICAgIGlmICghcmVjb3JkLmlzRXh0ZXJuYWwpIHJlY29yZC5zdHJlYW0uZGVzdHJveSgpCiAgICB9CiAgfQp9CgpjbGFzcyBTZXNzaW9uVHJhY2tlciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLm1hcCA9IG5ldyBNYXAoKQogIH0KCiAgZ2V0IHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5tYXAuc2l6ZQogIH0KCiAgZ2V0KGlkKSB7CiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMubWFwLmdldChpZCkKICAgIGlmIChleGlzdGluZyAhPT0gdW5kZWZpbmVkKSByZXR1cm4gZXhpc3RpbmcKICAgIGNvbnN0IGZyZXNoID0gW10KICAgIHRoaXMubWFwLnNldChpZCwgZnJlc2gpCiAgICByZXR1cm4gZnJlc2gKICB9CgogIGdjKGlkKSB7CiAgICB0aGlzLm1hcC5kZWxldGUoaWQpCiAgfQoKICBsaXN0KGlkKSB7CiAgICByZXR1cm4gaWQgPyB0aGlzLm1hcC5nZXQoaWQpIHx8IFtdIDogWy4uLnRoaXNdCiAgfQoKICAqW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICBmb3IgKGNvbnN0IHNlc3Npb25zIG9mIHRoaXMubWFwLnZhbHVlcygpKSB7CiAgICAgIHlpZWxkKiBzZXNzaW9uc1tTeW1ib2wuaXRlcmF0b3JdKCkKICAgIH0KICB9Cn0KCmNsYXNzIENvcmVUcmFja2VyIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMubWFwID0gbmV3IE1hcCgpCiAgICB0aGlzLndhdGNoaW5nID0gW10KCiAgICB0aGlzLl9nY2luZyA9IG5ldyBTZXQoKQogICAgdGhpcy5fZ2NJbnRlcnZhbCA9IG51bGwKICAgIHRoaXMuX2djQ3ljbGVCb3VuZCA9IHRoaXMuX2djQ3ljbGUuYmluZCh0aGlzKQogIH0KCiAgZ2V0IHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5tYXAuc2l6ZQogIH0KCiAgd2F0Y2goc3RvcmUpIHsKICAgIGlmIChzdG9yZS53YXRjaEluZGV4ICE9PSAtMSkgcmV0dXJuCiAgICBzdG9yZS53YXRjaEluZGV4ID0gdGhpcy53YXRjaGluZy5wdXNoKHN0b3JlKSAtIDEKICB9CgogIHVud2F0Y2goc3RvcmUpIHsKICAgIGlmIChzdG9yZS53YXRjaEluZGV4ID09PSAtMSkgcmV0dXJuCiAgICBjb25zdCBoZWFkID0gdGhpcy53YXRjaGluZy5wb3AoKQogICAgaWYgKGhlYWQgIT09IHN0b3JlKSB0aGlzLndhdGNoaW5nWyhoZWFkLndhdGNoSW5kZXggPSBzdG9yZS53YXRjaEluZGV4KV0gPSBoZWFkCiAgICBzdG9yZS53YXRjaEluZGV4ID0gLTEKICB9CgogIHJlc3VtZShpZCkgewogICAgY29uc3QgY29yZSA9IHRoaXMubWFwLmdldChpZCkKCiAgICBpZiAoIWNvcmUpIHJldHVybiBudWxsCgogICAgLy8gc2lnbmFsIGJhY2sgdGhhdCB3ZSBoYXZlIGEgY2xvc2luZyBvbmUgc3RvcmVkCiAgICBpZiAoY29yZS5jbG9zaW5nKSByZXR1cm4gY29yZQoKICAgIGlmIChjb3JlLmdjKSB7CiAgICAgIHRoaXMuX2djaW5nLmRlbGV0ZShjb3JlKQogICAgICBpZiAodGhpcy5fZ2Npbmcuc2l6ZSA9PT0gMCkgdGhpcy5fc3RvcEdDKCkKICAgICAgY29yZS5nYyA9IDAKICAgIH0KCiAgICByZXR1cm4gY29yZQogIH0KCiAgb3BlbmVkKGlkKSB7CiAgICBjb25zdCBjb3JlID0gdGhpcy5tYXAuZ2V0KGlkKQogICAgcmV0dXJuICEhKGNvcmUgJiYgY29yZS5vcGVuZWQgJiYgIWNvcmUuY2xvc2luZykKICB9CgogIGdldChpZCkgewogICAgLy8gd2UgYWxsb3cgeW91IGRvIGNhbGwgdGhpcyBmcm9tIHRoZSBvdXRzaWRlLCBzbyBzdXBwb3J0IG5vcm1hbCBidWZmZXJzIGFsc28KICAgIGlmIChiNGEuaXNCdWZmZXIoaWQpKSBpZCA9IGI0YS50b1N0cmluZyhpZCwgJ2hleCcpCiAgICBjb25zdCBjb3JlID0gdGhpcy5tYXAuZ2V0KGlkKQogICAgaWYgKCFjb3JlIHx8IGNvcmUuY2xvc2luZykgcmV0dXJuIG51bGwKICAgIHJldHVybiBjb3JlCiAgfQoKICBzZXQoaWQsIGNvcmUpIHsKICAgIHRoaXMubWFwLnNldChpZCwgY29yZSkKICAgIGlmICh0aGlzLndhdGNoaW5nLmxlbmd0aCA+IDApIHRoaXMuX2VtaXQoY29yZSkKICB9CgogIF9lbWl0KGNvcmUpIHsKICAgIGZvciAobGV0IGkgPSB0aGlzLndhdGNoaW5nLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHN0b3JlID0gdGhpcy53YXRjaGluZ1tpXQogICAgICBmb3IgKGNvbnN0IGZuIG9mIHN0b3JlLndhdGNoZXJzKSBmbihjb3JlKQogICAgfQogIH0KCiAgX2djKGNvcmUpIHsKICAgIGNvbnN0IGlkID0gdG9IZXgoY29yZS5kaXNjb3ZlcnlLZXkpCiAgICBpZiAodGhpcy5tYXAuZ2V0KGlkKSA9PT0gY29yZSkgdGhpcy5tYXAuZGVsZXRlKGlkKQogIH0KCiAgX2djQ3ljbGUoKSB7CiAgICBmb3IgKGNvbnN0IGNvcmUgb2YgdGhpcy5fZ2NpbmcpIHsKICAgICAgaWYgKCsrY29yZS5nYyA8IDQpIGNvbnRpbnVlCiAgICAgIGNvbnN0IGdjID0gdGhpcy5fZ2MuYmluZCh0aGlzLCBjb3JlKQogICAgICBjb3JlLmNsb3NlKCkudGhlbihnYywgZ2MpCiAgICAgIHRoaXMuX2djaW5nLmRlbGV0ZShjb3JlKQogICAgfQoKICAgIGlmICh0aGlzLl9nY2luZy5zaXplID09PSAwKSB0aGlzLl9zdG9wR0MoKQogIH0KCiAgZ2MoY29yZSkgewogICAgY29yZS5nYyA9IDEgLy8gZmlyc3Qgc3RyaWtlCiAgICB0aGlzLl9nY2luZy5hZGQoY29yZSkKICAgIGlmICh0aGlzLl9nY2luZy5zaXplID09PSAxKSB0aGlzLl9zdGFydEdDKCkKICB9CgogIF9zdG9wR0MoKSB7CiAgICBjbGVhckludGVydmFsKHRoaXMuX2djSW50ZXJ2YWwpCiAgICB0aGlzLl9nY0ludGVydmFsID0gbnVsbAogIH0KCiAgX3N0YXJ0R0MoKSB7CiAgICBpZiAodGhpcy5fZ2NJbnRlcnZhbCkgcmV0dXJuCiAgICB0aGlzLl9nY0ludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5fZ2NDeWNsZUJvdW5kLCAyMDAwKQogICAgaWYgKHRoaXMuX2djSW50ZXJ2YWwudW5yZWYpIHRoaXMuX2djSW50ZXJ2YWwudW5yZWYoKQogIH0KCiAgY2xvc2UoKSB7CiAgICB0aGlzLl9zdG9wR0MoKQogICAgdGhpcy5fZ2NpbmcuY2xlYXIoKQoKICAgIGNvbnN0IGFsbCA9IFtdCiAgICBmb3IgKGNvbnN0IGNvcmUgb2YgdGhpcy5tYXAudmFsdWVzKCkpIHsKICAgICAgY29yZS5vbmlkbGUgPSBub29wIC8vIG5vIHJlZW50cnkKICAgICAgYWxsLnB1c2goY29yZS5jbG9zZSgpKQogICAgfQogICAgdGhpcy5tYXAuY2xlYXIoKQoKICAgIHJldHVybiBQcm9taXNlLmFsbChhbGwpCiAgfQoKICAqW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICBmb3IgKGNvbnN0IGNvcmUgb2YgdGhpcy5tYXAudmFsdWVzKCkpIHsKICAgICAgaWYgKCFjb3JlLmNsb3NpbmcpIHlpZWxkIGNvcmUKICAgIH0KICB9Cn0KCmNsYXNzIEZpbmRpbmdQZWVycyB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLmNvdW50ID0gMAogICAgdGhpcy5wZW5kaW5nID0gW10KICB9CgogIGFkZChjb3JlKSB7CiAgICBpZiAodGhpcy5jb3VudCA9PT0gMCkgcmV0dXJuCiAgICB0aGlzLnBlbmRpbmcucHVzaChjb3JlLmZpbmRpbmdQZWVycygpKQogIH0KCiAgaW5jKHNlc3Npb25zKSB7CiAgICBpZiAoKyt0aGlzLmNvdW50ICE9PSAxKSByZXR1cm4KCiAgICBmb3IgKGNvbnN0IGNvcmUgb2Ygc2Vzc2lvbnMpIHsKICAgICAgdGhpcy5wZW5kaW5nLnB1c2goY29yZS5maW5kaW5nUGVlcnMoKSkKICAgIH0KICB9CgogIGRlYyhzZXNzaW9ucykgewogICAgaWYgKC0tdGhpcy5jb3VudCAhPT0gMCkgcmV0dXJuCiAgICB3aGlsZSAodGhpcy5wZW5kaW5nLmxlbmd0aCA+IDApIHRoaXMucGVuZGluZy5wb3AoKSgpCiAgfQp9CgpjbGFzcyBDb3Jlc3RvcmUgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvcihzdG9yYWdlLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLnJvb3QgPSBvcHRzLnJvb3QgfHwgbnVsbAogICAgdGhpcy5zdG9yYWdlID0gdGhpcy5yb290CiAgICAgID8gdGhpcy5yb290LnN0b3JhZ2UKICAgICAgOiBIeXBlcmNvcmUuZGVmYXVsdFN0b3JhZ2Uoc3RvcmFnZSwgewogICAgICAgICAgaWQ6IG9wdHMuaWQsCiAgICAgICAgICBhbGxvd0JhY2t1cDogb3B0cy5hbGxvd0JhY2t1cCwKICAgICAgICAgIHJlYWRPbmx5OiBvcHRzLnJlYWRPbmx5LAogICAgICAgICAgd2FpdDogb3B0cy53YWl0CiAgICAgICAgfSkKICAgIHRoaXMuc3RyZWFtVHJhY2tlciA9IHRoaXMucm9vdCA/IHRoaXMucm9vdC5zdHJlYW1UcmFja2VyIDogbmV3IFN0cmVhbVRyYWNrZXIoKQogICAgdGhpcy5jb3JlcyA9IHRoaXMucm9vdCA/IHRoaXMucm9vdC5jb3JlcyA6IG5ldyBDb3JlVHJhY2tlcigpCiAgICB0aGlzLnNlc3Npb25zID0gbmV3IFNlc3Npb25UcmFja2VyKCkKICAgIHRoaXMuY29yZXN0b3JlcyA9IHRoaXMucm9vdCA/IHRoaXMucm9vdC5jb3Jlc3RvcmVzIDogbmV3IFNldCgpCiAgICB0aGlzLnJlYWRPbmx5ID0gb3B0cy53cml0YWJsZSA9PT0gZmFsc2UgfHwgISFvcHRzLnJlYWRPbmx5CiAgICB0aGlzLmdsb2JhbENhY2hlID0gdGhpcy5yb290ID8gdGhpcy5yb290Lmdsb2JhbENhY2hlIDogb3B0cy5nbG9iYWxDYWNoZSB8fCBudWxsCiAgICB0aGlzLnByaW1hcnlLZXkgPSB0aGlzLnJvb3QgPyB0aGlzLnJvb3QucHJpbWFyeUtleSA6IG9wdHMucHJpbWFyeUtleSB8fCBudWxsCiAgICB0aGlzLm5zID0gb3B0cy5uYW1lc3BhY2UgfHwgREVGQVVMVF9OQU1FU1BBQ0UKICAgIHRoaXMubWFuaWZlc3RWZXJzaW9uID0gb3B0cy5tYW5pZmVzdFZlcnNpb24gfHwgMQogICAgdGhpcy5zaG91bGRTdXNwZW5kID0gaXNBbmRyb2lkID8gISFvcHRzLnN1c3BlbmQgOiBvcHRzLnN1c3BlbmQgIT09IGZhbHNlCiAgICB0aGlzLmFjdGl2ZSA9IG9wdHMuYWN0aXZlICE9PSBmYWxzZQoKICAgIHRoaXMud2F0Y2hlcnMgPSBudWxsCiAgICB0aGlzLndhdGNoSW5kZXggPSAtMQoKICAgIHRoaXMuX2ZpbmRpbmdQZWVycyA9IG51bGwgLy8gaGVyZSBmb3IgbGVnYWN5CiAgICB0aGlzLl9vbmdjQm91bmQgPSB0aGlzLl9vbmdjLmJpbmQodGhpcykKCiAgICBpZiAob3B0cy5wcmltYXJ5S2V5ICYmICF0aGlzLnJvb3QgJiYgIW9wdHMudW5zYWZlKSB7CiAgICAgIHRocm93IEFTU0VSVElPTigKICAgICAgICAnUGFzc2luZyB0aGUgcHJpbWFyeSBrZXkgaXMgdW5zYWZlIHVubGVzcyB5b3Uga25vdyB3aGF0IHlvdSBhcmUgZG9pbmcuIFNldCB1bnNhZmU6IHRydWUgdG8gYWNrbm93bGVkZ2UgdGhhdCcKICAgICAgKQogICAgfQoKICAgIGlmICh0aGlzLnJvb3QpIHRoaXMuY29yZXN0b3Jlcy5hZGQodGhpcykKCiAgICB0aGlzLnJlYWR5KCkuY2F0Y2gobm9vcCkKICB9CgogIHdhdGNoKGZuKSB7CiAgICBpZiAodGhpcy53YXRjaGVycyA9PT0gbnVsbCkgewogICAgICB0aGlzLndhdGNoZXJzID0gbmV3IFNldCgpCiAgICAgIHRoaXMuY29yZXMud2F0Y2godGhpcykKICAgIH0KCiAgICB0aGlzLndhdGNoZXJzLmFkZChmbikKICB9CgogIHVud2F0Y2goZm4pIHsKICAgIGlmICh0aGlzLndhdGNoZXJzID09PSBudWxsKSByZXR1cm4KCiAgICB0aGlzLndhdGNoZXJzLmRlbGV0ZShmbikKCiAgICBpZiAodGhpcy53YXRjaGVycy5zaXplID09PSAwKSB7CiAgICAgIHRoaXMud2F0Y2hlcnMgPSBudWxsCiAgICAgIHRoaXMuY29yZXMudW53YXRjaCh0aGlzKQogICAgfQogIH0KCiAgZmluZGluZ1BlZXJzKCkgewogICAgaWYgKHRoaXMuX2ZpbmRpbmdQZWVycyA9PT0gbnVsbCkgdGhpcy5fZmluZGluZ1BlZXJzID0gbmV3IEZpbmRpbmdQZWVycygpCiAgICB0aGlzLl9maW5kaW5nUGVlcnMuaW5jKHRoaXMuc2Vzc2lvbnMpCiAgICBsZXQgZG9uZSA9IGZhbHNlCiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAoZG9uZSkgcmV0dXJuCiAgICAgIGRvbmUgPSB0cnVlCiAgICAgIHRoaXMuX2ZpbmRpbmdQZWVycy5kZWModGhpcy5zZXNzaW9ucykKICAgIH0KICB9CgogIGF1ZGl0KG9wdHMgPSB7fSkgewogICAgcmV0dXJuIGF1ZGl0U3RvcmUodGhpcywgb3B0cykKICB9CgogIGFzeW5jIHN1c3BlbmQoeyBsb2cgPSBub29wIH0gPSB7fSkgewogICAgYXdhaXQgbG9nKCdGbHVzaGluZyBkYi4uLicpCiAgICAvLyBJZiByZWFkT25seSB3ZSBkb24ndCBuZWVkIHRvIGZsdXNoCiAgICBpZiAoIXRoaXMuc3RvcmFnZS5yZWFkT25seSkgYXdhaXQgdGhpcy5zdG9yYWdlLmRiLmZsdXNoKCkKICAgIGlmICghdGhpcy5zaG91bGRTdXNwZW5kKSByZXR1cm4KICAgIGF3YWl0IGxvZygnU3VzcGVuZGluZyBkYi4uLicpCiAgICBhd2FpdCB0aGlzLnN0b3JhZ2Uuc3VzcGVuZCgpCiAgfQoKICByZXN1bWUoKSB7CiAgICByZXR1cm4gdGhpcy5zdG9yYWdlLnJlc3VtZSgpCiAgfQoKICBzZXNzaW9uKG9wdHMpIHsKICAgIHRoaXMuX21heWJlQ2xvc2VkKCkKICAgIGNvbnN0IHJvb3QgPSB0aGlzLnJvb3QgfHwgdGhpcwogICAgcmV0dXJuIG5ldyBDb3Jlc3RvcmUobnVsbCwgewogICAgICBtYW5pZmVzdFZlcnNpb246IHRoaXMubWFuaWZlc3RWZXJzaW9uLAogICAgICAuLi5vcHRzLAogICAgICByb290CiAgICB9KQogIH0KCiAgbmFtZXNwYWNlKG5hbWUsIG9wdHMpIHsKICAgIHJldHVybiB0aGlzLnNlc3Npb24oewogICAgICAuLi5vcHRzLAogICAgICBuYW1lc3BhY2U6IGdlbmVyYXRlTmFtZXNwYWNlKHRoaXMubnMsIG5hbWUpCiAgICB9KQogIH0KCiAgbGlzdChuYW1lc3BhY2UpIHsKICAgIHJldHVybiB0aGlzLnN0b3JhZ2UuY3JlYXRlRGlzY292ZXJ5S2V5U3RyZWFtKG5hbWVzcGFjZSkKICB9CgogIGdldEF1dGgoZGlzY292ZXJ5S2V5KSB7CiAgICByZXR1cm4gdGhpcy5zdG9yYWdlLmdldEF1dGgoZGlzY292ZXJ5S2V5KQogIH0KCiAgX29uZ2Moc2Vzc2lvbikgewogICAgaWYgKHNlc3Npb24uc2Vzc2lvbnMubGVuZ3RoID09PSAwKSB0aGlzLnNlc3Npb25zLmdjKHNlc3Npb24uaWQpCiAgfQoKICBhc3luYyBfZ2V0T3JTZXRTZWVkKCkgewogICAgY29uc3Qgc2VlZCA9IGF3YWl0IHRoaXMuc3RvcmFnZS5nZXRTZWVkKCkKICAgIGlmIChzZWVkICE9PSBudWxsKSByZXR1cm4gc2VlZAogICAgcmV0dXJuIGF3YWl0IHRoaXMuc3RvcmFnZS5zZXRTZWVkKHRoaXMucHJpbWFyeUtleSB8fCBjcnlwdG8ucmFuZG9tQnl0ZXMoMzIpKQogIH0KCiAgYXN5bmMgX29wZW4oKSB7CiAgICBpZiAodGhpcy5yb290ICE9PSBudWxsKSB7CiAgICAgIGlmICh0aGlzLnJvb3Qub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yb290LnJlYWR5KCkKICAgICAgdGhpcy5wcmltYXJ5S2V5ID0gdGhpcy5yb290LnByaW1hcnlLZXkKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgcHJpbWFyeUtleSA9IGF3YWl0IHRoaXMuX2dldE9yU2V0U2VlZCgpCgogICAgaWYgKHRoaXMucHJpbWFyeUtleSA9PT0gbnVsbCkgewogICAgICB0aGlzLnByaW1hcnlLZXkgPSBwcmltYXJ5S2V5CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICghYjRhLmVxdWFscyhwcmltYXJ5S2V5LCB0aGlzLnByaW1hcnlLZXkpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQW5vdGhlciBjb3Jlc3RvcmUgaXMgc3RvcmVkIGhlcmUnKQogICAgfQogIH0KCiAgYXN5bmMgX2Nsb3NlKCkgewogICAgY29uc3QgY2xvc2luZyA9IFtdCiAgICBjb25zdCBoYW5naW5nID0gWy4uLnRoaXMuc2Vzc2lvbnNdCiAgICBmb3IgKGNvbnN0IHNlc3Mgb2YgaGFuZ2luZykgY2xvc2luZy5wdXNoKHNlc3MuY2xvc2UoKSkKCiAgICBpZiAodGhpcy53YXRjaGVycyAhPT0gbnVsbCkgdGhpcy5jb3Jlcy51bndhdGNoKHRoaXMpCgogICAgaWYgKHRoaXMucm9vdCAhPT0gbnVsbCkgewogICAgICBhd2FpdCBQcm9taXNlLmFsbChjbG9zaW5nKQogICAgICByZXR1cm4KICAgIH0KCiAgICBmb3IgKGNvbnN0IHN0b3JlIG9mIHRoaXMuY29yZXN0b3JlcykgewogICAgICBjbG9zaW5nLnB1c2goc3RvcmUuY2xvc2UoKSkKICAgIH0KCiAgICBhd2FpdCBQcm9taXNlLmFsbChjbG9zaW5nKQoKICAgIGF3YWl0IHRoaXMuY29yZXMuY2xvc2UoKQogICAgYXdhaXQgdGhpcy5zdG9yYWdlLmNsb3NlKCkKICB9CgogIGFzeW5jIF9hdHRhY2hNYXliZShtdXhlciwgZGlzY292ZXJ5S2V5KSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmICgKICAgICAgIXRoaXMuY29yZXMub3BlbmVkKHRvSGV4KGRpc2NvdmVyeUtleSkpICYmCiAgICAgICEoYXdhaXQgdGhpcy5zdG9yYWdlLmhhc0NvcmUoZGlzY292ZXJ5S2V5LCB7IGlmTWlncmF0ZWQ6IHRydWUgfSkpCiAgICApCiAgICAgIHJldHVybgogICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuCgogICAgY29uc3QgY29yZSA9IHRoaXMuX29wZW5Db3JlKGRpc2NvdmVyeUtleSwgeyBjcmVhdGVJZk1pc3Npbmc6IGZhbHNlIH0pCgogICAgaWYgKCFjb3JlKSByZXR1cm4KICAgIGlmICghY29yZS5vcGVuZWQpIGF3YWl0IGNvcmUucmVhZHkoKQoKICAgIGlmICghY29yZS5yZXBsaWNhdG9yLmF0dGFjaGVkKG11eGVyKSkgewogICAgICBjb3JlLnJlcGxpY2F0b3IuYXR0YWNoVG8obXV4ZXIpCiAgICB9CgogICAgY29yZS5jaGVja0lmSWRsZSgpCiAgfQoKICBfc2hvdWxkUmVwbGljYXRlKGNvcmUsIG11eGVyKSB7CiAgICByZXR1cm4gKAogICAgICBjb3JlLnJlcGxpY2F0b3IuZG93bmxvYWRpbmcgJiYgIWNvcmUucmVwbGljYXRvci5hdHRhY2hlZChtdXhlcikgJiYgY29yZS5vcGVuZWQgJiYgdGhpcy5hY3RpdmUKICAgICkKICB9CgogIHJlcGxpY2F0ZShpc0luaXRpYXRvciwgb3B0cykgewogICAgdGhpcy5fbWF5YmVDbG9zZWQoKQoKICAgIGNvbnN0IGlzRXh0ZXJuYWwgPSBpc1N0cmVhbShpc0luaXRpYXRvcikKICAgIGNvbnN0IHN0cmVhbSA9IEh5cGVyY29yZS5jcmVhdGVQcm90b2NvbFN0cmVhbShpc0luaXRpYXRvciwgewogICAgICAuLi5vcHRzLAogICAgICBvbmRpc2NvdmVyeWtleTogKGRpc2NvdmVyeUtleSkgPT4gewogICAgICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybgogICAgICAgIGNvbnN0IG11eGVyID0gc3RyZWFtLm5vaXNlU3RyZWFtLnVzZXJEYXRhCiAgICAgICAgcmV0dXJuIHRoaXMuX2F0dGFjaE1heWJlKG11eGVyLCBkaXNjb3ZlcnlLZXkpCiAgICAgIH0KICAgIH0pCgogICAgaWYgKHRoaXMuY29yZXMuc2l6ZSA+IDApIHsKICAgICAgY29uc3QgbXV4ZXIgPSBzdHJlYW0ubm9pc2VTdHJlYW0udXNlckRhdGEKICAgICAgY29uc3QgdW5jb3JrID0gbXV4ZXIudW5jb3JrLmJpbmQobXV4ZXIpCiAgICAgIG11eGVyLmNvcmsoKQoKICAgICAgZm9yIChjb25zdCBjb3JlIG9mIHRoaXMuY29yZXMpIHsKICAgICAgICBpZiAoIXRoaXMuX3Nob3VsZFJlcGxpY2F0ZShjb3JlLCBtdXhlcikpIHsKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogICAgICAgIGNvcmUucmVwbGljYXRvci5hdHRhY2hUbyhtdXhlcikKICAgICAgfQoKICAgICAgc3RyZWFtLm5vaXNlU3RyZWFtLm9wZW5lZC50aGVuKHVuY29yaykKICAgIH0KCiAgICBjb25zdCByZWNvcmQgPSB0aGlzLnN0cmVhbVRyYWNrZXIuYWRkKHN0cmVhbSwgaXNFeHRlcm5hbCkKICAgIHN0cmVhbS5vbmNlKCdjbG9zZScsICgpID0+IHRoaXMuc3RyZWFtVHJhY2tlci5yZW1vdmUocmVjb3JkKSkKICAgIHJldHVybiBzdHJlYW0KICB9CgogIF9tYXliZUNsb3NlZCgpIHsKICAgIGlmICh0aGlzLmNsb3NpbmcgfHwgKHRoaXMucm9vdCAhPT0gbnVsbCAmJiB0aGlzLnJvb3QuY2xvc2luZykpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3Jlc3RvcmUgaXMgY2xvc2VkJykKICAgIH0KICB9CgogIGFzeW5jIHN0YXRpY2lmeShjb3JlLCBvcHRzKSB7CiAgICBpZiAoIXRoaXMub3BlbmVkKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmICghY29yZS5vcGVuZWQpIGF3YWl0IGNvcmUucmVhZHkoKQoKICAgIGNvbnN0IHJ4ID0gY29yZS5zdGF0ZS5zdG9yYWdlLnJlYWQoKQoKICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCiAgICBjb25zdCBhdXRoUHJvbWlzZSA9IHJ4LmdldEF1dGgoKQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBbaGVhZCwgYXV0aF0gPSBhd2FpdCBQcm9taXNlLmFsbChbaGVhZFByb21pc2UsIGF1dGhQcm9taXNlXSkKICAgIGlmICghaGVhZCB8fCBoZWFkLmxlbmd0aCA9PT0gMCkgdGhyb3cgbmV3IEVycm9yKCdDb3JlIG11c3QgaGF2ZSBkYXRhJykKCiAgICBjb25zdCBwcm9sb2d1ZSA9IHsKICAgICAgbGVuZ3RoOiBoZWFkLmxlbmd0aCwKICAgICAgaGFzaDogaGVhZC5yb290SGFzaAogICAgfQoKICAgIGNvbnN0IG1hbmlmZXN0ID0gewogICAgICB2ZXJzaW9uOiAxLAogICAgICBoYXNoOiBhdXRoLm1hbmlmZXN0Lmhhc2gsCiAgICAgIHF1b3J1bTogMCwKICAgICAgc2lnbmVyczogW10sCiAgICAgIHByb2xvZ3VlCiAgICB9CgogICAgY29uc3QgYyA9IHsKICAgICAga2V5OiBudWxsLAogICAgICBkaXNjb3ZlcnlLZXk6IG51bGwsCiAgICAgIG1hbmlmZXN0LAogICAgICBjb3JlOiBjb3JlLnN0YXRlLnN0b3JhZ2UuY29yZQogICAgfQoKICAgIGMua2V5ID0gSHlwZXJjb3JlLmtleShjLm1hbmlmZXN0KQogICAgYy5kaXNjb3ZlcnlLZXkgPSBIeXBlcmNvcmUuZGlzY292ZXJ5S2V5KGMua2V5KQoKICAgIGF3YWl0IHRoaXMuc3RvcmFnZS5jcmVhdGVDb3JlKGMpCgogICAgY29uc3Qgc3RhdGljQ29yZSA9IHRoaXMuZ2V0KHsgLi4ub3B0cywga2V5OiBjLmtleSB9KQogICAgYXdhaXQgc3RhdGljQ29yZS5yZWFkeSgpCiAgICByZXR1cm4gc3RhdGljQ29yZQogIH0KCiAgZ2V0KG9wdHMpIHsKICAgIHRoaXMuX21heWJlQ2xvc2VkKCkKCiAgICBpZiAoYjRhLmlzQnVmZmVyKG9wdHMpIHx8IHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsga2V5OiBvcHRzIH0KICAgIGlmICghb3B0cykgb3B0cyA9IHt9CgogICAgY29uc3QgY29uZiA9IHsKICAgICAgcHJlbG9hZDogbnVsbCwKICAgICAgc2Vzc2lvbnM6IG51bGwsCiAgICAgIG9uZ2M6IG51bGwsCiAgICAgIGNvcmU6IG51bGwsCiAgICAgIGFjdGl2ZTogb3B0cy5hY3RpdmUgIT09IGZhbHNlLAogICAgICBlbmNyeXB0aW9uOiBvcHRzLmVuY3J5cHRpb24gfHwgbnVsbCwKICAgICAgZW5jcnlwdGlvbktleTogb3B0cy5lbmNyeXB0aW9uS2V5IHx8IG51bGwsIC8vIGJhY2sgY29tcGF0LCBzaG91bGQgcmVtb3ZlCiAgICAgIGlzQmxvY2tLZXk6ICEhb3B0cy5pc0Jsb2NrS2V5LCAvLyBiYWNrIGNvbXBhdCwgc2hvdWxkIHJlbW92ZQogICAgICB2YWx1ZUVuY29kaW5nOiBvcHRzLnZhbHVlRW5jb2RpbmcgfHwgbnVsbCwKICAgICAgZXhjbHVzaXZlOiAhIW9wdHMuZXhjbHVzaXZlLAogICAgICBtYW5pZmVzdDogb3B0cy5tYW5pZmVzdCB8fCBudWxsLAogICAgICBrZXlQYWlyOiBvcHRzLmtleVBhaXIgfHwgbnVsbCwKICAgICAgb253YWl0OiBvcHRzLm9ud2FpdCB8fCBudWxsLAogICAgICB3YWl0OiBvcHRzLndhaXQgIT09IGZhbHNlLAogICAgICB0aW1lb3V0OiBvcHRzLnRpbWVvdXQgfHwgMCwKICAgICAgZHJhZnQ6ICEhb3B0cy5kcmFmdCwKICAgICAgd3JpdGFibGU6IG9wdHMud3JpdGFibGUgPT09IHVuZGVmaW5lZCAmJiB0aGlzLnJlYWRPbmx5ID8gZmFsc2UgOiBvcHRzLndyaXRhYmxlCiAgICB9CgogICAgLy8gbmFtZSByZXF1aXJlcyB1cyB0byBydCB0byBzdG9yYWdlICsgcmVhZHksIHNvIG5lZWRzIHByZWxvYWQKICAgIC8vIHNhbWUgZ29lcyBpZiB1c2VyIGhhcyBkZWZpbmVkIGFzeW5jIHByZWxvYWQgb2J2cwogICAgaWYgKG9wdHMubmFtZSB8fCBvcHRzLnByZWxvYWQpIHsKICAgICAgY29uZi5wcmVsb2FkID0gdGhpcy5fcHJlbG9hZChvcHRzKQogICAgICByZXR1cm4gdGhpcy5fbWFrZVNlc3Npb24oY29uZikKICAgIH0KCiAgICBpZiAob3B0cy5kaXNjb3ZlcnlLZXkgJiYgIW9wdHMua2V5ICYmICFvcHRzLm1hbmlmZXN0KSB7CiAgICAgIGNvbmYucHJlbG9hZCA9IHRoaXMuX3ByZWxvYWRDaGVja0lmRXhpc3RzKG9wdHMpCiAgICAgIHJldHVybiB0aGlzLl9tYWtlU2Vzc2lvbihjb25mKQogICAgfQoKICAgIC8vIGlmIG5vdCBub3Qgd2UgY2FuIHN5bmMgY3JlYXRlIGl0LCB3aGljaCBqdXN0IGlzIGVhc2llciBmb3IgdGhlCiAgICAvLyB1cHN0cmVhbSB1c2VyIGluIHRlcm1zIG9mIGd1YXJhbnRlZXMgKGtleSBpcyB0aGVyZSBldGMgZXRjKQogICAgY29uc3QgY29yZSA9IHRoaXMuX29wZW5Db3JlKG51bGwsIG9wdHMpCgogICAgY29uZi5jb3JlID0gY29yZQogICAgY29uZi5zZXNzaW9ucyA9IHRoaXMuc2Vzc2lvbnMuZ2V0KGNvcmUuaWQpCiAgICBjb25mLm9uZ2MgPSB0aGlzLl9vbmdjQm91bmQKCiAgICByZXR1cm4gdGhpcy5fbWFrZVNlc3Npb24oY29uZikKICB9CgogIF9tYWtlU2Vzc2lvbihjb25mKSB7CiAgICBjb25zdCBzZXNzaW9uID0gbmV3IEh5cGVyY29yZShudWxsLCBudWxsLCBjb25mKQogICAgaWYgKHRoaXMuX2ZpbmRpbmdQZWVycyAhPT0gbnVsbCkgdGhpcy5fZmluZGluZ1BlZXJzLmFkZChzZXNzaW9uKQogICAgcmV0dXJuIHNlc3Npb24KICB9CgogIGFzeW5jIGNyZWF0ZUtleVBhaXIobmFtZSwgbnMgPSB0aGlzLm5zKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIHJldHVybiBjcmVhdGVLZXlQYWlyKHRoaXMucHJpbWFyeUtleSwgbnMsIG5hbWUpCiAgfQoKICBhc3luYyBfcHJlbG9hZENoZWNrSWZFeGlzdHMob3B0cykgewogICAgY29uc3QgaGFzID0gYXdhaXQgdGhpcy5zdG9yYWdlLmhhc0NvcmUob3B0cy5kaXNjb3ZlcnlLZXkpCiAgICBpZiAoIWhhcykgdGhyb3cgU1RPUkFHRV9FTVBUWSgnTm8gSHlwZXJjb3JlIGlzIHN0b3JlZCBoZXJlJykKICAgIHJldHVybiB0aGlzLl9wcmVsb2FkKG9wdHMpCiAgfQoKICBhc3luYyBfcHJlbG9hZChvcHRzKSB7CiAgICBpZiAob3B0cy5wcmVsb2FkKSBvcHRzID0geyAuLi5vcHRzLCAuLi4oYXdhaXQgb3B0cy5wcmVsb2FkKSB9CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICBjb25zdCBkaXNjb3ZlcnlLZXkgPSBvcHRzLm5hbWUKICAgICAgPyBhd2FpdCB0aGlzLnN0b3JhZ2UuZ2V0QWxpYXMoeyBuYW1lOiBvcHRzLm5hbWUsIG5hbWVzcGFjZTogdGhpcy5ucyB9KQogICAgICA6IG51bGwKICAgIHRoaXMuX21heWJlQ2xvc2VkKCkKCiAgICBjb25zdCBjb3JlID0gdGhpcy5fb3BlbkNvcmUoZGlzY292ZXJ5S2V5LCBvcHRzKQoKICAgIHJldHVybiB7CiAgICAgIGNvcmUsCiAgICAgIHNlc3Npb25zOiB0aGlzLnNlc3Npb25zLmdldChjb3JlLmlkKSwKICAgICAgb25nYzogdGhpcy5fb25nY0JvdW5kLAogICAgICBlbmNyeXB0aW9uOiBvcHRzLmVuY3J5cHRpb24gfHwgbnVsbCwKICAgICAgZW5jcnlwdGlvbktleTogb3B0cy5lbmNyeXB0aW9uS2V5IHx8IG51bGwsIC8vIGJhY2sgY29tcGF0LCBzaG91bGQgcmVtb3ZlCiAgICAgIGlzQmxvY2tLZXk6ICEhb3B0cy5pc0Jsb2NrS2V5IC8vIGJhY2sgY29tcGF0LCBzaG91bGQgcmVtb3ZlCiAgICB9CiAgfQoKICBfYXV0aChkaXNjb3ZlcnlLZXksIG9wdHMpIHsKICAgIGNvbnN0IHJlc3VsdCA9IHsKICAgICAga2V5UGFpcjogbnVsbCwKICAgICAga2V5OiBudWxsLAogICAgICBkaXNjb3ZlcnlLZXksCiAgICAgIG1hbmlmZXN0OiBudWxsCiAgICB9CgogICAgaWYgKG9wdHMubmFtZSkgewogICAgICByZXN1bHQua2V5UGFpciA9IGNyZWF0ZUtleVBhaXIodGhpcy5wcmltYXJ5S2V5LCB0aGlzLm5zLCBvcHRzLm5hbWUpCiAgICB9IGVsc2UgaWYgKG9wdHMua2V5UGFpcikgewogICAgICByZXN1bHQua2V5UGFpciA9IG9wdHMua2V5UGFpcgogICAgfQoKICAgIGlmIChvcHRzLm1hbmlmZXN0KSB7CiAgICAgIHJlc3VsdC5tYW5pZmVzdCA9IG9wdHMubWFuaWZlc3QKICAgIH0gZWxzZSBpZiAocmVzdWx0LmtleVBhaXIgJiYgIXJlc3VsdC5kaXNjb3ZlcnlLZXkpIHsKICAgICAgcmVzdWx0Lm1hbmlmZXN0ID0gewogICAgICAgIHZlcnNpb246IHRoaXMubWFuaWZlc3RWZXJzaW9uLAogICAgICAgIHNpZ25lcnM6IFt7IHB1YmxpY0tleTogcmVzdWx0LmtleVBhaXIucHVibGljS2V5IH1dCiAgICAgIH0KICAgIH0KCiAgICBpZiAob3B0cy5rZXkpIHJlc3VsdC5rZXkgPSBJRC5kZWNvZGUob3B0cy5rZXkpCiAgICBlbHNlIGlmIChyZXN1bHQubWFuaWZlc3QpIHJlc3VsdC5rZXkgPSBIeXBlcmNvcmUua2V5KHJlc3VsdC5tYW5pZmVzdCkKCiAgICBpZiAocmVzdWx0LmRpc2NvdmVyeUtleSkgcmV0dXJuIHJlc3VsdAoKICAgIGlmIChvcHRzLmRpc2NvdmVyeUtleSkgcmVzdWx0LmRpc2NvdmVyeUtleSA9IElELmRlY29kZShvcHRzLmRpc2NvdmVyeUtleSkKICAgIGVsc2UgaWYgKHJlc3VsdC5rZXkpIHJlc3VsdC5kaXNjb3ZlcnlLZXkgPSBjcnlwdG8uZGlzY292ZXJ5S2V5KHJlc3VsdC5rZXkpCiAgICBlbHNlIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGRlcml2ZSBkaXNjb3ZlcnkgZnJvbSBpbnB1dCcpCgogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgX29wZW5Db3JlKGRpc2NvdmVyeUtleSwgb3B0cykgewogICAgY29uc3QgYXV0aCA9IHRoaXMuX2F1dGgoZGlzY292ZXJ5S2V5LCBvcHRzKQoKICAgIGNvbnN0IGlkID0gdG9IZXgoYXV0aC5kaXNjb3ZlcnlLZXkpCiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuY29yZXMucmVzdW1lKGlkKQogICAgaWYgKGV4aXN0aW5nICYmICFleGlzdGluZy5jbG9zaW5nKSByZXR1cm4gZXhpc3RpbmcKCiAgICBjb25zdCBjb3JlID0gSHlwZXJjb3JlLmNyZWF0ZUNvcmUodGhpcy5zdG9yYWdlLCB7CiAgICAgIHByZW9wZW46IGV4aXN0aW5nICYmIGV4aXN0aW5nLm9wZW5lZCA/IGV4aXN0aW5nLmNsb3NpbmcgOiBudWxsLCAvLyBhbHdheXMgd2FpdCBmb3IgdGhlIHByZXYgb25lIHRvIGNsb3NlIGZpcnN0IGluIGFueSBjYXNlLi4uCiAgICAgIGVhZ2VyVXBncmFkZTogdHJ1ZSwKICAgICAgbm90RG93bmxvYWRpbmdMaW5nZXI6IG9wdHMubm90RG93bmxvYWRpbmdMaW5nZXIsCiAgICAgIGFsbG93Rm9yazogb3B0cy5hbGxvd0ZvcmsgIT09IGZhbHNlLAogICAgICBpbmZsaWdodFJhbmdlOiBvcHRzLmluZmxpZ2h0UmFuZ2UsCiAgICAgIGNvbXBhdDogZmFsc2UsIC8vIG5vIGNvbXBhdCBmb3Igbm93IDopCiAgICAgIGZvcmNlOiBvcHRzLmZvcmNlLAogICAgICBjcmVhdGVJZk1pc3Npbmc6IG9wdHMuY3JlYXRlSWZNaXNzaW5nLAogICAgICBkaXNjb3ZlcnlLZXk6IGF1dGguZGlzY292ZXJ5S2V5LAogICAgICBvdmVyd3JpdGU6IG9wdHMub3ZlcndyaXRlLAogICAgICBrZXk6IGF1dGgua2V5LAogICAgICBrZXlQYWlyOiBhdXRoLmtleVBhaXIsCiAgICAgIGxlZ2FjeTogb3B0cy5sZWdhY3ksCiAgICAgIG1hbmlmZXN0OiBhdXRoLm1hbmlmZXN0LAogICAgICBnbG9iYWxDYWNoZTogb3B0cy5nbG9iYWxDYWNoZSB8fCB0aGlzLmdsb2JhbENhY2hlIHx8IG51bGwsCiAgICAgIGFsaWFzOiBvcHRzLm5hbWUgPyB7IG5hbWU6IG9wdHMubmFtZSwgbmFtZXNwYWNlOiB0aGlzLm5zIH0gOiBudWxsCiAgICB9KQoKICAgIGNvcmUub25pZGxlID0gKCkgPT4gewogICAgICB0aGlzLmNvcmVzLmdjKGNvcmUpCiAgICB9CgogICAgY29yZS5yZXBsaWNhdG9yLm9uZG93bmxvYWRpbmcgPSAoKSA9PiB7CiAgICAgIGlmICh0aGlzLmFjdGl2ZSkgdGhpcy5zdHJlYW1UcmFja2VyLmF0dGFjaEFsbChjb3JlKQogICAgfQoKICAgIHRoaXMuY29yZXMuc2V0KGlkLCBjb3JlKQogICAgcmV0dXJuIGNvcmUKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gQ29yZXN0b3JlCgpmdW5jdGlvbiBpc1N0cmVhbShzKSB7CiAgcmV0dXJuIHR5cGVvZiBzID09PSAnb2JqZWN0JyAmJiBzICYmIHR5cGVvZiBzLnBpcGUgPT09ICdmdW5jdGlvbicKfQoKZnVuY3Rpb24gZ2VuZXJhdGVOYW1lc3BhY2UobmFtZXNwYWNlLCBuYW1lKSB7CiAgaWYgKCFiNGEuaXNCdWZmZXIobmFtZSkpIG5hbWUgPSBiNGEuZnJvbShuYW1lKQogIGNvbnN0IG91dCA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coMzIpCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChvdXQsIFtuYW1lc3BhY2UsIG5hbWVdKQogIHJldHVybiBvdXQKfQoKZnVuY3Rpb24gZGVyaXZlU2VlZChwcmltYXJ5S2V5LCBuYW1lc3BhY2UsIG5hbWUpIHsKICBpZiAoIWI0YS5pc0J1ZmZlcihuYW1lKSkgbmFtZSA9IGI0YS5mcm9tKG5hbWUpCiAgY29uc3Qgb3V0ID0gYjRhLmFsbG9jKDMyKQogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2gob3V0LCBbTlMsIG5hbWVzcGFjZSwgbmFtZV0sIHByaW1hcnlLZXkpCiAgcmV0dXJuIG91dAp9CgpmdW5jdGlvbiBjcmVhdGVLZXlQYWlyKHByaW1hcnlLZXksIG5hbWVzcGFjZSwgbmFtZSkgewogIGNvbnN0IHNlZWQgPSBkZXJpdmVTZWVkKHByaW1hcnlLZXksIG5hbWVzcGFjZSwgbmFtZSkKICBjb25zdCBidWYgPSBiNGEuYWxsb2Moc29kaXVtLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTICsgc29kaXVtLmNyeXB0b19zaWduX1NFQ1JFVEtFWUJZVEVTKQogIGNvbnN0IGtleVBhaXIgPSB7CiAgICBwdWJsaWNLZXk6IGJ1Zi5zdWJhcnJheSgwLCBzb2RpdW0uY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpLAogICAgc2VjcmV0S2V5OiBidWYuc3ViYXJyYXkoc29kaXVtLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogIH0KICBzb2RpdW0uY3J5cHRvX3NpZ25fc2VlZF9rZXlwYWlyKGtleVBhaXIucHVibGljS2V5LCBrZXlQYWlyLnNlY3JldEtleSwgc2VlZCkKICByZXR1cm4ga2V5UGFpcgp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIHRvSGV4KGRpc2NvdmVyeUtleSkgewogIHJldHVybiBiNGEudG9TdHJpbmcoZGlzY292ZXJ5S2V5LCAnaGV4JykKfQptb2R1bGUuZXhwb3J0cyA9IGFzeW5jIGZ1bmN0aW9uKiBhdWRpdChzdG9yZSwgeyBkcnlSdW4gPSBmYWxzZSB9ID0ge30pIHsKICBmb3IgYXdhaXQgKGNvbnN0IHsgZGlzY292ZXJ5S2V5LCBjb3JlIH0gb2Ygc3RvcmUuc3RvcmFnZS5jcmVhdGVDb3JlU3RyZWFtKCkpIHsKICAgIGlmIChjb3JlLnZlcnNpb24gPCAxKSBjb250aW51ZSAvLyBub3QgbWlncmF0ZWQsIGlnbm9yZQoKICAgIGNvbnN0IGMgPSBzdG9yZS5nZXQoeyBkaXNjb3ZlcnlLZXksIGFjdGl2ZTogZmFsc2UgfSkKICAgIGF3YWl0IGMucmVhZHkoKQoKICAgIHlpZWxkIHsgZGlzY292ZXJ5S2V5LCBrZXk6IGMua2V5LCBhdWRpdDogYXdhaXQgYy5jb3JlLmF1ZGl0KHsgZHJ5UnVuIH0pIH0KCiAgICB0cnkgewogICAgICBhd2FpdCBjLmNsb3NlKCkKICAgIH0gY2F0Y2ggewogICAgICAvLyBpZ25vcmUgaWYgZmFpbGVkLCB3ZSBhcmUgYXVkaXRpbmcuLi4KICAgIH0KICB9Cn0KewogICJuYW1lIjogImNvcmVzdG9yZSIsCiAgInZlcnNpb24iOiAiNy43LjAiLAogICJkZXNjcmlwdGlvbiI6ICJBIEh5cGVyY29yZSBmYWN0b3J5IHRoYXQgc2ltcGxpZmllcyBtYW5hZ2luZyBjb2xsZWN0aW9ucyBvZiBjb3Jlcy4iLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYi8qIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi43IiwKICAgICJoeXBlcmNvcmUiOiAiXjExLjE5LjAiLAogICAgImh5cGVyY29yZS1jcnlwdG8iOiAiXjMuNC4yIiwKICAgICJoeXBlcmNvcmUtZXJyb3JzIjogIl4xLjQuMCIsCiAgICAiaHlwZXJjb3JlLWlkLWVuY29kaW5nIjogIl4xLjMuMCIsCiAgICAicmVhZHktcmVzb3VyY2UiOiAiXjEuMS4xIiwKICAgICJzb2RpdW0tdW5pdmVyc2FsIjogIl41LjAuMSIsCiAgICAid2hpY2gtcnVudGltZSI6ICJeMS4yLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuNy4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIiwKICAgICJyYWNoZSI6ICJeMS4wLjAiLAogICAgInRlc3QtdG1wIjogIl4xLjMuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgInRlc3QiOiAicHJldHRpZXIgLS1jaGVjayAuICYmIGJyaXR0bGUgdGVzdC8qLmpzIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0L2Jhc2ljLmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vY29yZXN0b3JlLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYyIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2NvcmVzdG9yZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2NvcmVzdG9yZSIKfQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGRlYm91bmNlICh3b3JrZXIsIGNvbnRleHQgPSBudWxsKSB7CiAgZGVib3VuY2VkLnJ1bm5pbmcgPSBudWxsCiAgcmV0dXJuIGRlYm91bmNlZAoKICBhc3luYyBmdW5jdGlvbiBkZWJvdW5jZWQgKCkgewogICAgaWYgKGRlYm91bmNlZC5ydW5uaW5nICE9PSBudWxsKSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgZGVib3VuY2VkLnJ1bm5pbmcKICAgICAgfSBjYXRjaCAoXykgewogICAgICAgIC8vIGlnbm9yZSAtIGRvIG5vdCBmYWlsIG9uIG9sZCBlcnJvcnMKICAgICAgfQogICAgfQoKICAgIC8vIGFub3RoZXIgInRocmVhZCIgYmVhdCB1cyB0byBpdCwganVzdCBwaWdneSBwYWNrIG9uIHRoYXQgb25lCiAgICBpZiAoZGVib3VuY2VkLnJ1bm5pbmcgIT09IG51bGwpIHJldHVybiBkZWJvdW5jZWQucnVubmluZwoKICAgIGRlYm91bmNlZC5ydW5uaW5nID0gd29ya2VyLmNhbGwoY29udGV4dCkKCiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgZGVib3VuY2VkLnJ1bm5pbmcKICAgIH0gZmluYWxseSB7CiAgICAgIGRlYm91bmNlZC5ydW5uaW5nID0gbnVsbAogICAgfQogIH0KfQp7CiAgIm5hbWUiOiAiZGVib3VuY2VpZnkiLAogICJ2ZXJzaW9uIjogIjEuMS4wIiwKICAiZGVzY3JpcHRpb24iOiAiVGlueSBhc3luYyBkZWJvdW5jZXIiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTYuMC4zIiwKICAgICJ0YXBlIjogIl41LjEuMSIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9kZWJvdW5jZWlmeS5naXQiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9kZWJvdW5jZWlmeS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9kZWJvdW5jZWlmeSIKfQpjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJykKY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKQpjb25zdCBmc3ggPSByZXF1aXJlKCdmcy1uYXRpdmUtZXh0ZW5zaW9ucycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCmNvbnN0IEZETG9jayA9IHJlcXVpcmUoJ2ZkLWxvY2snKQoKY29uc3QgUExBVEZPUk0gPSBnbG9iYWwuQmFyZSA/IGdsb2JhbC5CYXJlLnBsYXRmb3JtIDogZ2xvYmFsLnByb2Nlc3MucGxhdGZvcm0KY29uc3QgSVNfV0lOID0gUExBVEZPUk0gPT09ICd3aW4zMicKY29uc3QgSVNfTElOVVggPSBQTEFURk9STSA9PT0gJ2xpbnV4Jwpjb25zdCBNT0RJRklFRF9TTEFDSyA9IDUwMDAKY29uc3QgRU1QVFkgPSBiNGEuYWxsb2MoMCkKY29uc3QgQVRUUiA9IElTX0xJTlVYID8gJ3VzZXIuZGV2aWNlLWZpbGUnIDogJ2RldmljZS1maWxlJwoKY29uc3QgbmwgPSBJU19XSU4gPyAnXHJcbicgOiAnXG4nCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIERldmljZUZpbGUgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvcihmaWxlbmFtZSwgeyBjcmVhdGUgPSB0cnVlLCB3YWl0ID0gZmFsc2UsIGxvY2sgPSB3YWl0LCBkYXRhID0ge30gfSA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5maWxlbmFtZSA9IGZpbGVuYW1lCiAgICB0aGlzLmRhdGEgPSBkYXRhCiAgICB0aGlzLmxvY2sgPSBudWxsCgogICAgdGhpcy5fY3JlYXRlID0gY3JlYXRlCiAgICB0aGlzLl93YWl0ID0gd2FpdAogICAgdGhpcy5fbG9jayA9IGxvY2sKICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgaWYgKGF3YWl0IHZlcmlmeURldmljZUZpbGUodGhpcykpIHJldHVybgogICAgaWYgKCF0aGlzLl9jcmVhdGUpIHRocm93IG5ldyBFcnJvcignTm8gZGV2aWNlIGZpbGUgcHJlc2VudCcpCiAgICBhd2FpdCB3cml0ZURldmljZUZpbGUodGhpcykKICB9CgogIHRyYW5zZmVyKCkgewogICAgcmV0dXJuIHRoaXMubG9jayA/IHRoaXMubG9jay50cmFuc2ZlcigpIDogLTEKICB9CgogIGFzeW5jIF9jbG9zZSgpIHsKICAgIGlmICh0aGlzLmxvY2spIGF3YWl0IHRoaXMubG9jay5jbG9zZSgpCiAgfQoKICBhc3luYyBzdXNwZW5kKCkgewogICAgaWYgKCF0aGlzLm9wZW5lZCkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAodGhpcy5sb2NrKSBhd2FpdCB0aGlzLmxvY2suc3VzcGVuZCgpCiAgfQoKICBhc3luYyByZXN1bWUoKSB7CiAgICBpZiAoIXRoaXMub3BlbmVkKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmICh0aGlzLmxvY2spIGF3YWl0IHRoaXMubG9jay5yZXN1bWUoKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gd3JpdGVEZXZpY2VGaWxlKGRldmljZSkgewogIGxldCBzID0gJycKCiAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoZGV2aWNlLmRhdGEpKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwpIGNvbnRpbnVlCiAgICBzICs9IGtleSArICc9JyArIHZhbHVlICsgbmwKICB9CgogIGF3YWl0IGZzLnByb21pc2VzLm1rZGlyKHBhdGguZGlybmFtZShkZXZpY2UuZmlsZW5hbWUpLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KQoKICBjb25zdCBmZCA9IGF3YWl0IG9wZW4oZGV2aWNlLmZpbGVuYW1lLCAndycpCgogIGRldmljZS5sb2NrID0gZGV2aWNlLl9sb2NrID8gbmV3IEZETG9jayhmZCwgeyB3YWl0OiBkZXZpY2UuX3dhaXQgfSkgOiBudWxsCgogIGlmIChkZXZpY2UubG9jaykgewogICAgdHJ5IHsKICAgICAgYXdhaXQgZGV2aWNlLmxvY2sucmVhZHkoKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGF3YWl0IGRldmljZS5sb2NrLmNsb3NlKCkKICAgICAgdGhyb3cgZXJyCiAgICB9CiAgfQoKICBjb25zdCBzdCA9IGF3YWl0IGZzdGF0KGZkKQoKICBjb25zdCBjcmVhdGVkID0gRGF0ZS5ub3coKQoKICBzICs9ICdkZXZpY2UvcGxhdGZvcm09JyArIFBMQVRGT1JNICsgbmwKICBzICs9ICdkZXZpY2UvaW5vZGU9JyArIHN0LmlubyArIG5sCiAgcyArPSAnZGV2aWNlL2NyZWF0ZWQ9JyArIGNyZWF0ZWQgKyBubAoKICBpZiAoYXdhaXQgc2V0QXR0cihmZCwgQVRUUiwgYjRhLmZyb20oJ29yaWdpbmFsJykpKSB7CiAgICBzICs9ICdkZXZpY2UvYXR0cmlidXRlPW9yaWdpbmFsJyArIG5sCiAgfQoKICBhd2FpdCB3cml0ZShmZCwgYjRhLmZyb20ocykpCgogIGlmICghZGV2aWNlLmxvY2spIGF3YWl0IGNsb3NlKGZkKQp9Cgphc3luYyBmdW5jdGlvbiB2ZXJpZnlEZXZpY2VGaWxlKGRldmljZSkgewogIGxldCBmZCA9IDAKCiAgdHJ5IHsKICAgIGZkID0gYXdhaXQgb3BlbihkZXZpY2UuZmlsZW5hbWUsICdyKycpCiAgfSBjYXRjaCAoZSkgewogICAgZmQgPSAwCiAgfQoKICBpZiAoZmQgPT09IDApIHJldHVybiBmYWxzZQoKICBkZXZpY2UubG9jayA9IGRldmljZS5fbG9jayA/IG5ldyBGRExvY2soZmQsIHsgd2FpdDogZGV2aWNlLl93YWl0IH0pIDogbnVsbAoKICBpZiAoZGV2aWNlLmxvY2spIHsKICAgIHRyeSB7CiAgICAgIGF3YWl0IGRldmljZS5sb2NrLnJlYWR5KCkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBhd2FpdCBkZXZpY2UubG9jay5jbG9zZSgpCiAgICAgIHRocm93IGVycgogICAgfQogIH0KCiAgY29uc3QgYnVmID0gYXdhaXQgcmVhZChmZCkKICBjb25zdCByZXN1bHQgPSB7fQoKICBjb25zdCBzID0gYjRhLnRvU3RyaW5nKGJ1ZikudHJpbSgpLnNwbGl0KCdcbicpCgogIGxldCBpbm9kZSA9IDAKICBsZXQgY3JlYXRlZCA9IDAKICBsZXQgYXR0ciA9ICcnCiAgbGV0IHBsYXRmb3JtID0gJycKCiAgZm9yIChjb25zdCBsbiBvZiBzKSB7CiAgICBjb25zdCBpID0gbG4uaW5kZXhPZignPScpCiAgICBpZiAoaSA9PT0gLTEpIGNvbnRpbnVlCgogICAgY29uc3QgayA9IGxuLnNsaWNlKDAsIGkpLnRyaW0oKQogICAgY29uc3QgdiA9IGxuLnNsaWNlKGkgKyAxKS50cmltKCkKCiAgICBzd2l0Y2ggKGspIHsKICAgICAgY2FzZSAnZGV2aWNlL3BsYXRmb3JtJzoKICAgICAgICBwbGF0Zm9ybSA9IHYKICAgICAgICBicmVhawogICAgICBjYXNlICdkZXZpY2UvaW5vZGUnOgogICAgICAgIGlub2RlID0gTnVtYmVyKHYpCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAnZGV2aWNlL2NyZWF0ZWQnOgogICAgICAgIGNyZWF0ZWQgPSBOdW1iZXIodikKICAgICAgICBicmVhawogICAgICBjYXNlICdkZXZpY2UvYXR0cmlidXRlJzoKICAgICAgICBhdHRyID0gdgogICAgICAgIGJyZWFrCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVzdWx0W2tdID0gdgogICAgICAgIGJyZWFrCiAgICB9CiAgfQoKICBmb3IgKGNvbnN0IFtrLCB2XSBvZiBPYmplY3QuZW50cmllcyhkZXZpY2UuZGF0YSkpIHsKICAgIGlmICh2ID09PSBudWxsKSBjb250aW51ZQogICAgaWYgKHJlc3VsdFtrXSA9PT0gdW5kZWZpbmVkKSBjb250aW51ZSAvLyBhbGxvdyB1cHNlcnRzCiAgICBpZiAocmVzdWx0W2tdICE9PSAnJyArIHYpIHsKICAgICAgYXdhaXQgdGVhcmRvd24oKQogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZGV2aWNlIGZpbGUsICcgKyBrICsgJyBoYXMgY2hhbmdlZC4gV2FzICcgKyByZXN1bHRba10gKyAnLCBpcyAnICsgdikKICAgIH0KICB9CgogIGNvbnN0IHN0ID0gYXdhaXQgZnN0YXQoZmQpCiAgY29uc3QgYXQgPSBhd2FpdCBnZXRBdHRyKGZkLCBBVFRSKQoKICBjb25zdCBzYW1lQXR0ciA9IGI0YS50b1N0cmluZyhhdCB8fCBFTVBUWSkgPT09IGF0dHIKICBjb25zdCBtb2RpZmllZCA9IE1hdGgubWF4KHN0Lm10aW1lLmdldFRpbWUoKSwgc3QuYmlydGh0aW1lLmdldFRpbWUoKSkKCiAgaWYgKHBsYXRmb3JtICYmIHBsYXRmb3JtICE9PSBQTEFURk9STSkgewogICAgYXdhaXQgdGVhcmRvd24oKQogICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGRldmljZSBmaWxlLCB3YXMgbWFkZSBvbiBkaWZmZXJlbnQgcGxhdGZvcm0nKQogIH0KCiAgaWYgKCFzYW1lQXR0cikgewogICAgYXdhaXQgdGVhcmRvd24oKQogICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGRldmljZSBmaWxlLCB3YXMgbW92ZWQgdW5zYWZlbHknKQogIH0KCiAgaWYgKHN0LmlubyAhPT0gaW5vZGUgfHwgKGNyZWF0ZWQgJiYgTWF0aC5hYnMobW9kaWZpZWQgLSBjcmVhdGVkKSA+PSBNT0RJRklFRF9TTEFDSykpIHsKICAgIGF3YWl0IHRlYXJkb3duKCkKICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBkZXZpY2UgZmlsZSwgd2FzIG1vZGlmaWVkJykKICB9CgogIGlmICghZGV2aWNlLmxvY2spIGF3YWl0IGNsb3NlKGZkKQoKICBkZXZpY2UuZGF0YSA9IHJlc3VsdAogIHJldHVybiB0cnVlCgogIGFzeW5jIGZ1bmN0aW9uIHRlYXJkb3duICgpIHsKICAgIGlmIChkZXZpY2UubG9jaykgYXdhaXQgZGV2aWNlLmxvY2suY2xvc2UoKQogICAgZWxzZSBhd2FpdCBjbG9zZShmZCkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGdldEF0dHIoZmQsIG5hbWUpIHsKICB0cnkgewogICAgcmV0dXJuIGF3YWl0IGZzeC5nZXRBdHRyKGZkLCBuYW1lKQogIH0gY2F0Y2ggewogICAgcmV0dXJuIG51bGwKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHNldEF0dHIoZmQsIG5hbWUsIHZhbHVlKSB7CiAgdHJ5IHsKICAgIGF3YWl0IGZzeC5zZXRBdHRyKGZkLCBuYW1lLCB2YWx1ZSkKICAgIHJldHVybiB0cnVlCiAgfSBjYXRjaCB7CiAgICByZXR1cm4gZmFsc2UKICB9Cn0KCmZ1bmN0aW9uIGZzdGF0KGZkKSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIGZzLmZzdGF0KGZkLCAoZXJyLCBzdCkgPT4gewogICAgICBpZiAoZXJyKSByZWplY3QoZXJyKQogICAgICByZXNvbHZlKHN0KQogICAgfSkKICB9KQp9CgpmdW5jdGlvbiBjbG9zZShmZCkgewogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBmcy5jbG9zZShmZCwgKGVyciwgc3QpID0+IHsKICAgICAgaWYgKGVycikgcmVqZWN0KGVycikKICAgICAgcmVzb2x2ZShzdCkKICAgIH0pCiAgfSkKfQoKZnVuY3Rpb24gd3JpdGUoZmQsIGJ1ZikgewogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBsZXQgb2Zmc2V0ID0gMAoKICAgIG9ud3JpdGUobnVsbCwgMCkKCiAgICBmdW5jdGlvbiBvbndyaXRlKGVyciwgd3JvdGUpIHsKICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdChlcnIpCiAgICAgIGlmIChvZmZzZXQgPT09IGJ1Zi5ieXRlTGVuZ3RoKSByZXR1cm4gcmVzb2x2ZSgpCiAgICAgIG9mZnNldCArPSB3cm90ZQogICAgICBmcy53cml0ZShmZCwgYnVmLCBvZmZzZXQsIGJ1Zi5ieXRlTGVuZ3RoIC0gb2Zmc2V0LCBvZmZzZXQsIG9ud3JpdGUpCiAgICB9CiAgfSkKfQoKZnVuY3Rpb24gcmVhZChmZCkgewogIGNvbnN0IGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZSg0MDk2KQoKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgbGV0IG9mZnNldCA9IDAKCiAgICBmcy5yZWFkKGZkLCBidWYsIDAsIGJ1Zi5ieXRlTGVuZ3RoLCAwLCBvbnJlYWQpCgogICAgZnVuY3Rpb24gb25yZWFkKGVyciwgcmVhZCkgewogICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycikKICAgICAgaWYgKHJlYWQgPT09IDApIHJldHVybiByZXNvbHZlKGJ1Zi5zdWJhcnJheSgwLCBvZmZzZXQpKQogICAgICBvZmZzZXQgKz0gcmVhZAogICAgICBmcy5yZWFkKGZkLCBidWYsIG9mZnNldCwgYnVmLmJ5dGVMZW5ndGggLSBvZmZzZXQsIG9mZnNldCwgb25yZWFkKQogICAgfQogIH0pCn0KCmZ1bmN0aW9uIG9wZW4oZmlsZW5hbWUsIGZsYWdzKSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIGZzLm9wZW4oZmlsZW5hbWUsIGZsYWdzLCAoZXJyLCBmZCkgPT4gewogICAgICBpZiAoZXJyKSByZWplY3QoZXJyKQogICAgICByZXNvbHZlKGZkKQogICAgfSkKICB9KQp9CnsKICAibmFtZSI6ICJkZXZpY2UtZmlsZSIsCiAgInZlcnNpb24iOiAiMi4xLjMiLAogICJkZXNjcmlwdGlvbiI6ICJEZXZpY2Ugb25seSBmaWxlIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi43IiwKICAgICJiYXJlLWZzIjogIl40LjAuMSIsCiAgICAiYmFyZS1wYXRoIjogIl4zLjAuMCIsCiAgICAiZmQtbG9jayI6ICJeMi4xLjAiLAogICAgImZzLW5hdGl2ZS1leHRlbnNpb25zIjogIl4xLjQuMCIsCiAgICAicmVhZHktcmVzb3VyY2UiOiAiXjEuMi4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjEzLjEiLAogICAgImx1bnRlIjogIl4xLjAuMiIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuICYmIGx1bnRlIiwKICAgICJ0ZXN0IjogImJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJpbXBvcnRzIjogewogICAgImZzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWZzIiwKICAgICAgImRlZmF1bHQiOiAiZnMiCiAgICB9LAogICAgInBhdGgiOiB7CiAgICAgICJiYXJlIjogImJhcmUtcGF0aCIsCiAgICAgICJkZWZhdWx0IjogInBhdGgiCiAgICB9CiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9kZXZpY2UtZmlsZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMiLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vZGV2aWNlLWZpbGUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9kZXZpY2UtZmlsZSIKfQpjb25zdCB7IEV2ZW50RW1pdHRlciB9ID0gcmVxdWlyZSgnZXZlbnRzJykKY29uc3QgVGFibGUgPSByZXF1aXJlKCdrYWRlbWxpYS1yb3V0aW5nLXRhYmxlJykKY29uc3QgVE9TID0gcmVxdWlyZSgndGltZS1vcmRlcmVkLXNldCcpCmNvbnN0IFVEWCA9IHJlcXVpcmUoJ3VkeC1uYXRpdmUnKQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBOYXRTYW1wbGVyID0gcmVxdWlyZSgnbmF0LXNhbXBsZXInKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBJTyA9IHJlcXVpcmUoJy4vbGliL2lvJykKY29uc3QgUXVlcnkgPSByZXF1aXJlKCcuL2xpYi9xdWVyeScpCmNvbnN0IFNlc3Npb24gPSByZXF1aXJlKCcuL2xpYi9zZXNzaW9uJykKY29uc3QgcGVlciA9IHJlcXVpcmUoJy4vbGliL3BlZXInKQpjb25zdCB7IFVOS05PV05fQ09NTUFORCwgSU5WQUxJRF9UT0tFTiB9ID0gcmVxdWlyZSgnLi9saWIvZXJyb3JzJykKY29uc3QgeyBQSU5HLCBQSU5HX05BVCwgRklORF9OT0RFLCBET1dOX0hJTlQgfSA9IHJlcXVpcmUoJy4vbGliL2NvbW1hbmRzJykKCmNvbnN0IFRNUCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKY29uc3QgVElDS19JTlRFUlZBTCA9IDUwMDAKY29uc3QgU0xFRVBJTkdfSU5URVJWQUwgPSAzICogVElDS19JTlRFUlZBTApjb25zdCBTVEFCTEVfVElDS1MgPSAyNDAgLy8gaWYgbm90aGluZyBtYWpvciBiYWQgaGFwcGVucyBpbiB+MjBtaW5zIHdlIGNhbiBjb25zaWRlciB0aGlzIG5vZGUgc3RhYmxlIChpZiBuYXQgaXMgZnJpZW5kbHkpCmNvbnN0IE1PUkVfU1RBQkxFX1RJQ0tTID0gMyAqIFNUQUJMRV9USUNLUwpjb25zdCBSRUZSRVNIX1RJQ0tTID0gNjAgLy8gcmVmcmVzaCBldmVyeSB+NW1pbiB3aGVuIGlkbGUKY29uc3QgUkVDRU5UX05PREUgPSAxMiAvLyB3ZSd2ZSBoZWFyZCBmcm9tIGEgbm9kZSBsZXNzIHRoYW4gMW1pbiBhZ28KY29uc3QgT0xEX05PREUgPSAzNjAgLy8gaWYgYW4gbm9kZSBoYXMgYmVlbiBhcm91bmQgbW9yZSB0aGFuIDMwIG1pbiB3ZSBjb25zaWRlciBpdCBvbGQKCmNsYXNzIERIVCBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3Iob3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5ib290c3RyYXBOb2RlcyA9IG9wdHMuYm9vdHN0cmFwID09PSBmYWxzZSA/IFtdIDogKG9wdHMuYm9vdHN0cmFwIHx8IFtdKS5tYXAocGFyc2VOb2RlKQogICAgdGhpcy50YWJsZSA9IG5ldyBUYWJsZShyYW5kb21CeXRlcygzMikpCiAgICB0aGlzLm5vZGVzID0gbmV3IFRPUygpCiAgICB0aGlzLnVkeCA9IG9wdHMudWR4IHx8IG5ldyBVRFgoKQogICAgdGhpcy5pbyA9IG5ldyBJTyh0aGlzLnRhYmxlLCB0aGlzLnVkeCwgewogICAgICAuLi5vcHRzLAogICAgICBvbnJlcXVlc3Q6IHRoaXMuX29ucmVxdWVzdC5iaW5kKHRoaXMpLAogICAgICBvbnJlc3BvbnNlOiB0aGlzLl9vbnJlc3BvbnNlLmJpbmQodGhpcyksCiAgICAgIG9udGltZW91dDogdGhpcy5fb250aW1lb3V0LmJpbmQodGhpcykKICAgIH0pCgogICAgdGhpcy5jb25jdXJyZW5jeSA9IG9wdHMuY29uY3VycmVuY3kgfHwgMTAKICAgIHRoaXMuYm9vdHN0cmFwcGVkID0gZmFsc2UKICAgIHRoaXMuZXBoZW1lcmFsID0gdHJ1ZQogICAgdGhpcy5maXJld2FsbGVkID0gdGhpcy5pby5maXJld2FsbGVkCiAgICB0aGlzLmFkYXB0aXZlID0gdHlwZW9mIG9wdHMuZXBoZW1lcmFsICE9PSAnYm9vbGVhbicgJiYgb3B0cy5hZGFwdGl2ZSAhPT0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKICAgIHRoaXMub25saW5lID0gdHJ1ZQogICAgdGhpcy5zdGF0cyA9IHsKICAgICAgcXVlcmllczogeyBhY3RpdmU6IDAsIHRvdGFsOiAwIH0sCiAgICAgIHJlcXVlc3RzOiB0aGlzLmlvLnN0YXRzLnJlcXVlc3RzLAogICAgICBjb21tYW5kczogewogICAgICAgIHBpbmc6IHRoaXMuaW8uc3RhdHMuY29tbWFuZHNbUElOR10sCiAgICAgICAgcGluZ05hdDogdGhpcy5pby5zdGF0cy5jb21tYW5kc1tQSU5HX05BVF0sCiAgICAgICAgZmluZE5vZGU6IHRoaXMuaW8uc3RhdHMuY29tbWFuZHNbRklORF9OT0RFXSwKICAgICAgICBkb3duSGludDogdGhpcy5pby5zdGF0cy5jb21tYW5kc1tET1dOX0hJTlRdCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9uYXQgPSBuZXcgTmF0U2FtcGxlcigpCiAgICB0aGlzLl9xdWlja0ZpcmV3YWxsID0gb3B0cy5xdWlja0ZpcmV3YWxsICE9PSBmYWxzZQogICAgdGhpcy5fZm9yY2VQZXJzaXN0ZW50ID0gb3B0cy5lcGhlbWVyYWwgPT09IGZhbHNlCiAgICB0aGlzLl9yZXBpbmdpbmcgPSAwCiAgICB0aGlzLl9jaGVja3MgPSAwCiAgICB0aGlzLl90aWNrID0gcmFuZG9tT2Zmc2V0KDEwMCkgLy8gbWFrZSBzdXJlIHRvIHJhbmRvbSBvZmZzZXQgYWxsIHRoZSBuZXR3b3JrIHRpY2tzCiAgICB0aGlzLl9yZWZyZXNoVGlja3MgPSByYW5kb21PZmZzZXQoUkVGUkVTSF9USUNLUykKICAgIHRoaXMuX3N0YWJsZVRpY2tzID0gdGhpcy5hZGFwdGl2ZSA/IFNUQUJMRV9USUNLUyA6IDAKICAgIHRoaXMuX3RpY2tJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuX29udGljay5iaW5kKHRoaXMpLCBUSUNLX0lOVEVSVkFMKQogICAgdGhpcy5fbGFzdFRpY2sgPSBEYXRlLm5vdygpCiAgICB0aGlzLl9sYXN0SG9zdCA9IG51bGwKICAgIHRoaXMuX2ZpbHRlck5vZGUgPSBvcHRzLmZpbHRlck5vZGUgfHwgb3B0cy5hZGROb2RlIHx8IG51bGwgLy8gb3B0cy5hZGROb2RlIGlzIGRlcHJlY2F0aW5nLCB1c2Ugb3B0cy5maWx0ZXJOb2RlIGluc3RlYWQKICAgIHRoaXMuX29ucm93ID0gKHJvdykgPT4gcm93Lm9uKCdmdWxsJywgKG5vZGUpID0+IHRoaXMuX29uZnVsbHJvdyhub2RlLCByb3cpKQogICAgdGhpcy5fbm9uZVBlcnNpc3RlbnRTYW1wbGVzID0gW10KICAgIHRoaXMuX2Jvb3RzdHJhcHBpbmcgPSB0aGlzLl9ib290c3RyYXAoKQogICAgdGhpcy5fYm9vdHN0cmFwcGluZy5jYXRjaChub29wKQoKICAgIHRoaXMudGFibGUub24oJ3JvdycsIHRoaXMuX29ucm93KQoKICAgIHRoaXMuaW8ubmV0d29ya0ludGVyZmFjZXMub24oJ2NoYW5nZScsIChpbnRlcmZhY2VzKSA9PiB0aGlzLl9vbm5ldHdvcmtjaGFuZ2UoaW50ZXJmYWNlcykpCgogICAgaWYgKG9wdHMubm9kZXMpIHsKICAgICAgZm9yIChsZXQgaSA9IG9wdHMubm9kZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICB0aGlzLmFkZE5vZGUob3B0cy5ub2Rlc1tpXSkKICAgICAgfQogICAgfQogIH0KCiAgc3RhdGljIGJvb3RzdHJhcHBlcihwb3J0LCBob3N0LCBvcHRzKSB7CiAgICBpZiAoIXBvcnQpIHRocm93IG5ldyBFcnJvcignUG9ydCBpcyByZXF1aXJlZCcpCiAgICBpZiAoIWhvc3QpIHRocm93IG5ldyBFcnJvcignSG9zdCBpcyByZXF1aXJlZCcpCiAgICBpZiAoaG9zdCA9PT0gJzAuMC4wLjAnIHx8IGhvc3QgPT09ICc6OicpIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBob3N0JykKICAgIGlmICghVURYLmlzSVB2NChob3N0KSkgdGhyb3cgbmV3IEVycm9yKCdIb3N0IG11c3QgYmUgYSBJUHY0IGFkZHJlc3MnKQoKICAgIGNvbnN0IGRodCA9IG5ldyB0aGlzKHsKICAgICAgcG9ydCwKICAgICAgZXBoZW1lcmFsOiBmYWxzZSwKICAgICAgZmlyZXdhbGxlZDogZmFsc2UsCiAgICAgIGFueVBvcnQ6IGZhbHNlLAogICAgICBib290c3RyYXA6IFtdLAogICAgICAuLi5vcHRzCiAgICB9KQogICAgZGh0Ll9uYXQuYWRkKGhvc3QsIHBvcnQpCiAgICByZXR1cm4gZGh0CiAgfQoKICBnZXQgaWQoKSB7CiAgICByZXR1cm4gdGhpcy5lcGhlbWVyYWwgPyBudWxsIDogdGhpcy50YWJsZS5pZAogIH0KCiAgZ2V0IGhvc3QoKSB7CiAgICByZXR1cm4gdGhpcy5fbmF0Lmhvc3QKICB9CgogIGdldCBwb3J0KCkgewogICAgcmV0dXJuIHRoaXMuX25hdC5wb3J0CiAgfQoKICBnZXQgcmFuZG9taXplZCgpIHsKICAgIHJldHVybiB0aGlzLl9uYXQuaG9zdCAhPT0gbnVsbCAmJiB0aGlzLl9uYXQucG9ydCA9PT0gMAogIH0KCiAgZ2V0IHNvY2tldCgpIHsKICAgIHJldHVybiB0aGlzLmZpcmV3YWxsZWQgPyB0aGlzLmlvLmNsaWVudFNvY2tldCA6IHRoaXMuaW8uc2VydmVyU29ja2V0CiAgfQoKICBvbm1lc3NhZ2Uoc29ja2V0LCBidWYsIHJpbmZvKSB7CiAgICBpZiAoYnVmLmJ5dGVMZW5ndGggPiAxKSB0aGlzLmlvLm9ubWVzc2FnZShzb2NrZXQsIGJ1ZiwgcmluZm8pCiAgfQoKICBiaW5kKCkgewogICAgcmV0dXJuIHRoaXMuaW8uYmluZCgpCiAgfQoKICBhc3luYyBzdXNwZW5kKHsgbG9nID0gbm9vcCB9ID0ge30pIHsKICAgIGxvZygnU3VzcGVuZGluZyB3YWl0aW5nIGZvciBpbyBiaW5kLi4uJykKICAgIGF3YWl0IHRoaXMuaW8uYmluZCgpCiAgICBsb2coJ0RvbmUsIGNvbnRpbnVpbmcnKQogICAgaWYgKHRoaXMuc3VzcGVuZGVkIHx8IHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuc3VzcGVuZGVkID0gdHJ1ZQogICAgY2xlYXJJbnRlcnZhbCh0aGlzLl90aWNrSW50ZXJ2YWwpCiAgICBsb2coJ0RvbmUsIHN1c3BlbmRpbmcgaW8nKQogICAgYXdhaXQgdGhpcy5pby5zdXNwZW5kKHsgbG9nIH0pCiAgICBsb2coJ0RvbmUsIGRodCBzdXNwZW5kZWQnKQogICAgdGhpcy5lbWl0KCdzdXNwZW5kJykKICB9CgogIGFzeW5jIHJlc3VtZSh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICBpZiAoIXRoaXMuc3VzcGVuZGVkIHx8IHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKICAgIHRoaXMuX3RpY2tJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuX29udGljay5iaW5kKHRoaXMpLCBUSUNLX0lOVEVSVkFMKQogICAgdGhpcy5fb253YWtldXAoKQogICAgbG9nKCdSZXN1bWluZyBpbycpCiAgICBhd2FpdCB0aGlzLmlvLnJlc3VtZSgpCiAgICBsb2coJ0RvbmUsIGRodCByZXN1bWVkJykKICAgIHRoaXMuaW8ubmV0d29ya0ludGVyZmFjZXMub24oJ2NoYW5nZScsIChpbnRlcmZhY2VzKSA9PiB0aGlzLl9vbm5ldHdvcmtjaGFuZ2UoaW50ZXJmYWNlcykpCiAgICB0aGlzLnJlZnJlc2goKQogICAgdGhpcy5lbWl0KCdyZXN1bWUnKQogIH0KCiAgYWRkcmVzcygpIHsKICAgIGNvbnN0IHNvY2tldCA9IHRoaXMuc29ja2V0CiAgICByZXR1cm4gc29ja2V0ID8gc29ja2V0LmFkZHJlc3MoKSA6IG51bGwKICB9CgogIGxvY2FsQWRkcmVzcygpIHsKICAgIGlmICghdGhpcy5pby5zZXJ2ZXJTb2NrZXQpIHJldHVybiBudWxsCgogICAgcmV0dXJuIHsKICAgICAgaG9zdDogbG9jYWxJUCh0aGlzLnVkeCksCiAgICAgIHBvcnQ6IHRoaXMuaW8uc2VydmVyU29ja2V0LmFkZHJlc3MoKS5wb3J0CiAgICB9CiAgfQoKICByZW1vdGVBZGRyZXNzKCkgewogICAgaWYgKCF0aGlzLmhvc3QpIHJldHVybiBudWxsCiAgICBpZiAoIXRoaXMucG9ydCkgcmV0dXJuIG51bGwKICAgIGlmICh0aGlzLmZpcmV3YWxsZWQpIHJldHVybiBudWxsCiAgICBpZiAoIXRoaXMuaW8uc2VydmVyU29ja2V0KSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHBvcnQgPSB0aGlzLmlvLnNlcnZlclNvY2tldC5hZGRyZXNzKCkucG9ydAogICAgaWYgKHBvcnQgIT09IHRoaXMucG9ydCkgcmV0dXJuIG51bGwKCiAgICByZXR1cm4gewogICAgICBob3N0OiB0aGlzLmhvc3QsCiAgICAgIHBvcnQKICAgIH0KICB9CgogIGFkZE5vZGUoeyBob3N0LCBwb3J0IH0pIHsKICAgIHRoaXMuX2FkZE5vZGUoewogICAgICBpZDogcGVlci5pZChob3N0LCBwb3J0KSwKICAgICAgcG9ydCwKICAgICAgaG9zdCwKICAgICAgdG9rZW46IG51bGwsCiAgICAgIHRvOiBudWxsLAogICAgICBzYW1wbGVkOiAwLAogICAgICBhZGRlZDogdGhpcy5fdGljaywKICAgICAgcGluZ2VkOiAwLAogICAgICBzZWVuOiAwLAogICAgICBkb3duSGludHM6IDAsCiAgICAgIHByZXY6IG51bGwsCiAgICAgIG5leHQ6IG51bGwKICAgIH0pCiAgfQoKICB0b0FycmF5KG9wdHMpIHsKICAgIGNvbnN0IGxpbWl0ID0gb3B0cyAmJiBvcHRzLmxpbWl0CiAgICBpZiAobGltaXQgPT09IDApIHJldHVybiBbXQogICAgcmV0dXJuIHRoaXMubm9kZXMudG9BcnJheSh7IGxpbWl0LCByZXZlcnNlOiB0cnVlIH0pLm1hcCgoeyBob3N0LCBwb3J0IH0pID0+ICh7IGhvc3QsIHBvcnQgfSkpCiAgfQoKICBhc3luYyBmdWxseUJvb3RzdHJhcHBlZCgpIHsKICAgIHJldHVybiB0aGlzLl9ib290c3RyYXBwaW5nCiAgfQoKICByZWFkeSgpIHsKICAgIC8vIERlcHJlY2F0aW5nLCB1c2UgZnVsbHlCb290c3RyYXBwZWQgaW5zdGVhZCAocmVtb3ZlZCBvbiBuZXh0IG1ham9yKQogICAgcmV0dXJuIHRoaXMuZnVsbHlCb290c3RyYXBwZWQoKQogIH0KCiAgZmluZE5vZGUodGFyZ2V0LCBvcHRzKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcignTm9kZSBkZXN0cm95ZWQnKQogICAgdGhpcy5fcmVmcmVzaFRpY2tzID0gUkVGUkVTSF9USUNLUwogICAgcmV0dXJuIG5ldyBRdWVyeSh0aGlzLCB0YXJnZXQsIHRydWUsIEZJTkRfTk9ERSwgbnVsbCwgb3B0cykKICB9CgogIHF1ZXJ5KHsgdGFyZ2V0LCBjb21tYW5kLCB2YWx1ZSB9LCBvcHRzKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcignTm9kZSBkZXN0cm95ZWQnKQogICAgdGhpcy5fcmVmcmVzaFRpY2tzID0gUkVGUkVTSF9USUNLUwogICAgcmV0dXJuIG5ldyBRdWVyeSh0aGlzLCB0YXJnZXQsIGZhbHNlLCBjb21tYW5kLCB2YWx1ZSB8fCBudWxsLCBvcHRzKQogIH0KCiAgcGluZyh7IGhvc3QsIHBvcnQgfSwgb3B0cykgewogICAgbGV0IHZhbHVlID0gbnVsbAoKICAgIGlmIChvcHRzICYmIG9wdHMuc2l6ZSAmJiBvcHRzLnNpemUgPiAwKSB2YWx1ZSA9IGI0YS5hbGxvYyhvcHRzLnNpemUpCgogICAgY29uc3QgcmVxID0gdGhpcy5pby5jcmVhdGVSZXF1ZXN0KAogICAgICB7IGlkOiBudWxsLCBob3N0LCBwb3J0IH0sCiAgICAgIG51bGwsCiAgICAgIHRydWUsCiAgICAgIFBJTkcsCiAgICAgIG51bGwsCiAgICAgIHZhbHVlLAogICAgICAob3B0cyAmJiBvcHRzLnNlc3Npb24pIHx8IG51bGwsCiAgICAgIG9wdHMgJiYgb3B0cy50dGwKICAgICkKICAgIHJldHVybiB0aGlzLl9yZXF1ZXN0VG9Qcm9taXNlKHJlcSwgb3B0cykKICB9CgogIHJlcXVlc3QoeyB0b2tlbiA9IG51bGwsIGNvbW1hbmQsIHRhcmdldCA9IG51bGwsIHZhbHVlID0gbnVsbCB9LCB7IGhvc3QsIHBvcnQgfSwgb3B0cykgewogICAgY29uc3QgcmVxID0gdGhpcy5pby5jcmVhdGVSZXF1ZXN0KAogICAgICB7IGlkOiBudWxsLCBob3N0LCBwb3J0IH0sCiAgICAgIHRva2VuLAogICAgICBmYWxzZSwKICAgICAgY29tbWFuZCwKICAgICAgdGFyZ2V0LAogICAgICB2YWx1ZSwKICAgICAgKG9wdHMgJiYgb3B0cy5zZXNzaW9uKSB8fCBudWxsLAogICAgICBvcHRzICYmIG9wdHMudHRsCiAgICApCiAgICByZXR1cm4gdGhpcy5fcmVxdWVzdFRvUHJvbWlzZShyZXEsIG9wdHMpCiAgfQoKICBzZXNzaW9uKCkgewogICAgcmV0dXJuIG5ldyBTZXNzaW9uKHRoaXMpCiAgfQoKICBfcmVxdWVzdFRvUHJvbWlzZShyZXEsIG9wdHMpIHsKICAgIGlmIChyZXEgPT09IG51bGwpIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ05vZGUgZGVzdHJveWVkJykpCgogICAgaWYgKG9wdHMgJiYgb3B0cy5zb2NrZXQpIHJlcS5zb2NrZXQgPSBvcHRzLnNvY2tldAogICAgaWYgKG9wdHMgJiYgb3B0cy5yZXRyeSA9PT0gZmFsc2UpIHJlcS5yZXRyaWVzID0gMAoKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIHJlcS5vbnJlc3BvbnNlID0gcmVzb2x2ZQogICAgICByZXEub25lcnJvciA9IHJlamVjdAogICAgICByZXEuc2VuZCgpCiAgICB9KQogIH0KCiAgYXN5bmMgX2Jvb3RzdHJhcCgpIHsKICAgIGNvbnN0IHNlbGYgPSB0aGlzCgogICAgYXdhaXQgUHJvbWlzZS5yZXNvbHZlKCkgLy8gd2FpdCBhIHRpY2ssIHNvIGFwaXMgY2FuIGJlIHVzZWQgZnJvbSB0aGUgb3V0c2lkZQogICAgYXdhaXQgdGhpcy5pby5iaW5kKCkKCiAgICB0aGlzLmVtaXQoJ2xpc3RlbmluZycpCgogICAgLy8gVE9ETzogc29tZSBwYXBlcnMgZGVzY3JpYmUgbW9yZSBhZHZhbmNlZCB3YXlzIG9mIGJvb3RzdHJhcHBpbmcgLSB3ZSBzaG91bGQgcHJvYiBsb29rIGludG8gdGhhdAoKICAgIGxldCBmaXJzdCA9IHRoaXMuZmlyZXdhbGxlZCAmJiB0aGlzLl9xdWlja0ZpcmV3YWxsICYmICF0aGlzLl9mb3JjZVBlcnNpc3RlbnQKICAgIGxldCB0ZXN0TmF0ID0gZmFsc2UKCiAgICBjb25zdCBvbmx5RmlyZXdhbGwgPSAhdGhpcy5fZm9yY2VQZXJzaXN0ZW50CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyOyBpKyspIHsKICAgICAgYXdhaXQgdGhpcy5fYmFja2dyb3VuZFF1ZXJ5KHRoaXMudGFibGUuaWQpLm9uKCdkYXRhJywgb25kYXRhKS5maW5pc2hlZCgpCgogICAgICBpZiAodGhpcy5ib290c3RyYXBwZWQgfHwgKCF0ZXN0TmF0ICYmICF0aGlzLl9mb3JjZVBlcnNpc3RlbnQpKSBicmVhawogICAgICBpZiAoIShhd2FpdCB0aGlzLl91cGRhdGVOZXR3b3JrU3RhdGUob25seUZpcmV3YWxsKSkpIGJyZWFrCiAgICB9CgogICAgaWYgKHRoaXMuYm9vdHN0cmFwcGVkKSByZXR1cm4KICAgIHRoaXMuYm9vdHN0cmFwcGVkID0gdHJ1ZQoKICAgIHRoaXMuZW1pdCgncmVhZHknKQoKICAgIGZ1bmN0aW9uIG9uZGF0YShkYXRhKSB7CiAgICAgIC8vIFNpbXBsZSBRVUlDSyBuYXQgaGV1cmlzdGljLgogICAgICAvLyBJZiB3ZSBnZXQgT05FIHBvc2l0aXZlIG5hdCBwaW5nIGJlZm9yZSB0aGUgYm9vdHN0cmFwIHF1ZXJ5IGZpbmlzaGVzCiAgICAgIC8vIHRoZW4gd2UgYWx3YXlzIHRvIGEgbmF0IHRlc3QsIG5vIG1hdHRlciBpZiB3ZSBhcmUgYWRhcHRpdmUuLi4KICAgICAgLy8gVGhpcyBzaG91bGQgYmUgZXhwYW5kZWQgaW4gdGhlIGZ1dHVyZSB0byB0cnkgbW9yZSB0aGFuIG9uZSBub2RlIGV0Yywgbm90IGFsd2F5cyBoaXQgdGhlIGZpcnN0IGV0YwogICAgICAvLyBJZiB0aGlzIGZhaWxzLCB0aGVuIG5iZCwgYXMgdGhlIG9uc3RhYmxlIGhvb2sgd2lsbCBwaWNrIGl0IHVwIGxhdGVyLgoKICAgICAgaWYgKCFmaXJzdCkgcmV0dXJuCiAgICAgIGZpcnN0ID0gZmFsc2UKCiAgICAgIGNvbnN0IHZhbHVlID0gYjRhLmFsbG9jVW5zYWZlKDIpCiAgICAgIGMudWludDE2LmVuY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IDIsIGJ1ZmZlcjogdmFsdWUgfSwgc2VsZi5pby5zZXJ2ZXJTb2NrZXQuYWRkcmVzcygpLnBvcnQpCgogICAgICBzZWxmLl9yZXF1ZXN0KAogICAgICAgIGRhdGEuZnJvbSwKICAgICAgICBmYWxzZSwKICAgICAgICB0cnVlLAogICAgICAgIFBJTkdfTkFULAogICAgICAgIG51bGwsCiAgICAgICAgdmFsdWUsCiAgICAgICAgbnVsbCwKICAgICAgICAoKSA9PiB7CiAgICAgICAgICB0ZXN0TmF0ID0gdHJ1ZQogICAgICAgIH0sCiAgICAgICAgbm9vcAogICAgICApCiAgICB9CiAgfQoKICByZWZyZXNoKCkgewogICAgY29uc3Qgbm9kZSA9IHRoaXMudGFibGUucmFuZG9tKCkKICAgIHRoaXMuX2JhY2tncm91bmRRdWVyeShub2RlID8gbm9kZS5pZCA6IHRoaXMudGFibGUuaWQpLm9uKCdlcnJvcicsIG5vb3ApCiAgfQoKICBhc3luYyBkZXN0cm95KCkgewogICAgY29uc3QgZW1pdENsb3NlID0gIXRoaXMuZGVzdHJveWVkCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fdGlja0ludGVydmFsKQogICAgYXdhaXQgdGhpcy5pby5kZXN0cm95KCkKICAgIGlmIChlbWl0Q2xvc2UpIHRoaXMuZW1pdCgnY2xvc2UnKQogIH0KCiAgX3JlcXVlc3QodG8sIGZvcmNlLCBpbnRlcm5hbCwgY29tbWFuZCwgdGFyZ2V0LCB2YWx1ZSwgc2Vzc2lvbiwgb25yZXNwb25zZSwgb25lcnJvcikgewogICAgY29uc3QgcmVxID0gdGhpcy5pby5jcmVhdGVSZXF1ZXN0KHRvLCBudWxsLCBpbnRlcm5hbCwgY29tbWFuZCwgdGFyZ2V0LCB2YWx1ZSwgc2Vzc2lvbikKICAgIGlmIChyZXEgPT09IG51bGwpIHJldHVybiBudWxsCgogICAgcmVxLm9ucmVzcG9uc2UgPSBvbnJlc3BvbnNlCiAgICByZXEub25lcnJvciA9IG9uZXJyb3IKICAgIHJlcS5zZW5kKGZvcmNlKQoKICAgIHJldHVybiByZXEKICB9CgogIF9uYXRBZGQoaG9zdCwgcG9ydCkgewogICAgY29uc3QgcHJldkhvc3QgPSB0aGlzLl9uYXQuaG9zdAogICAgY29uc3QgcHJldlBvcnQgPSB0aGlzLl9uYXQucG9ydAoKICAgIHRoaXMuX25hdC5hZGQoaG9zdCwgcG9ydCkKCiAgICBpZiAocHJldkhvc3QgPT09IHRoaXMuX25hdC5ob3N0ICYmIHByZXZQb3J0ID09PSB0aGlzLl9uYXQucG9ydCkgcmV0dXJuCgogICAgdGhpcy5lbWl0KCduYXQtdXBkYXRlJywgdGhpcy5fbmF0Lmhvc3QsIHRoaXMuX25hdC5wb3J0KQogIH0KCiAgLy8gd2UgZG9uJ3QgY2hlY2sgdGhhdCB0aGlzIGlzIGEgYm9vdHN0cmFwIG5vZGUgYnV0IHdlIGxpbWl0IHRoZSBzYW1wbGUgc2l6ZSB0byB2ZXJ5IGZldyBub2Rlcywgc28gZmluZQogIF9zYW1wbGVCb290c3RyYXBNYXliZShmcm9tLCB0bykgewogICAgaWYgKHRoaXMuX25vbmVQZXJzaXN0ZW50U2FtcGxlcy5sZW5ndGggPj0gTWF0aC5tYXgoMSwgdGhpcy5ib290c3RyYXBOb2Rlcy5sZW5ndGgpKSByZXR1cm4KICAgIGNvbnN0IGlkID0gZnJvbS5ob3N0ICsgJzonICsgZnJvbS5wb3J0CiAgICBpZiAodGhpcy5fbm9uZVBlcnNpc3RlbnRTYW1wbGVzLmluZGV4T2YoaWQpID4gLTEpIHJldHVybgogICAgdGhpcy5fbm9uZVBlcnNpc3RlbnRTYW1wbGVzLnB1c2goaWQpCiAgICB0aGlzLl9uYXRBZGQodG8uaG9zdCwgdG8ucG9ydCkKICB9CgogIF9hZGROb2RlRnJvbU5ldHdvcmsoc2FtcGxlLCBmcm9tLCB0bykgewogICAgaWYgKHRoaXMuX2ZpbHRlck5vZGUgIT09IG51bGwgJiYgIXRoaXMuX2ZpbHRlck5vZGUoZnJvbSkpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKGZyb20uaWQgPT09IG51bGwpIHsKICAgICAgdGhpcy5fc2FtcGxlQm9vdHN0cmFwTWF5YmUoZnJvbSwgdG8pCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IG9sZE5vZGUgPSB0aGlzLnRhYmxlLmdldChmcm9tLmlkKQoKICAgIC8vIHJlZnJlc2ggaXQsIGlmIHdlJ3ZlIHNlZW4gdGhpcyBiZWZvcmUKICAgIGlmIChvbGROb2RlKSB7CiAgICAgIGlmIChzYW1wbGUgJiYgKG9sZE5vZGUuc2FtcGxlZCA9PT0gMCB8fCB0aGlzLl90aWNrIC0gb2xkTm9kZS5zYW1wbGVkID49IE9MRF9OT0RFKSkgewogICAgICAgIG9sZE5vZGUudG8gPSB0bwogICAgICAgIG9sZE5vZGUuc2FtcGxlZCA9IHRoaXMuX3RpY2sKICAgICAgICB0aGlzLl9uYXRBZGQodG8uaG9zdCwgdG8ucG9ydCkKICAgICAgfQoKICAgICAgb2xkTm9kZS5waW5nZWQgPSBvbGROb2RlLnNlZW4gPSB0aGlzLl90aWNrCiAgICAgIHRoaXMubm9kZXMuYWRkKG9sZE5vZGUpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuX2FkZE5vZGUoewogICAgICBpZDogZnJvbS5pZCwKICAgICAgcG9ydDogZnJvbS5wb3J0LAogICAgICBob3N0OiBmcm9tLmhvc3QsCiAgICAgIHRvLAogICAgICBzYW1wbGVkOiAwLAogICAgICBhZGRlZDogdGhpcy5fdGljaywKICAgICAgcGluZ2VkOiB0aGlzLl90aWNrLCAvLyBsYXN0IHRpbWUgd2UgaW50ZXJhY3RlZCB3aXRoIHRoZW0KICAgICAgc2VlbjogdGhpcy5fdGljaywgLy8gbGFzdCB0aW1lIHdlIGhlYXJkIGZyb20gdGhlbQogICAgICBkb3duSGludHM6IDAsCiAgICAgIHByZXY6IG51bGwsCiAgICAgIG5leHQ6IG51bGwKICAgIH0pCiAgfQoKICBfYWRkTm9kZShub2RlKSB7CiAgICBpZiAodGhpcy5ub2Rlcy5oYXMobm9kZSkgfHwgYjRhLmVxdWFscyhub2RlLmlkLCB0aGlzLnRhYmxlLmlkKSkgcmV0dXJuCgogICAgbm9kZS5hZGRlZCA9IG5vZGUucGluZ2VkID0gbm9kZS5zZWVuID0gdGhpcy5fdGljawoKICAgIGlmICghdGhpcy50YWJsZS5hZGQobm9kZSkpIHJldHVybgogICAgdGhpcy5ub2Rlcy5hZGQobm9kZSkKCiAgICBpZiAobm9kZS50byAmJiBub2RlLnNhbXBsZWQgPT09IDApIHsKICAgICAgbm9kZS5zYW1wbGVkID0gdGhpcy5fdGljawogICAgICB0aGlzLl9uYXRBZGQobm9kZS50by5ob3N0LCBub2RlLnRvLnBvcnQpCiAgICB9CgogICAgdGhpcy5lbWl0KCdhZGQtbm9kZScsIG5vZGUpCiAgfQoKICBfcmVtb3ZlU3RhbGVOb2RlKG5vZGUsIGxhc3RTZWVuKSB7CiAgICBpZiAobm9kZS5zZWVuIDw9IGxhc3RTZWVuKSB0aGlzLl9yZW1vdmVOb2RlKG5vZGUpCiAgfQoKICBfcmVtb3ZlTm9kZShub2RlKSB7CiAgICBpZiAoIXRoaXMubm9kZXMuaGFzKG5vZGUpKSByZXR1cm4KCiAgICB0aGlzLnRhYmxlLnJlbW92ZShub2RlLmlkKQogICAgdGhpcy5ub2Rlcy5yZW1vdmUobm9kZSkKCiAgICB0aGlzLmVtaXQoJ3JlbW92ZS1ub2RlJywgbm9kZSkKICB9CgogIF9vbndha2V1cCgpIHsKICAgIHRoaXMuX3RpY2sgKz0gMiAqIE9MRF9OT0RFIC8vIGJ1bXAgdGhlIHRpY2sgZW5vdWdoIHRoYXQgZXZlcnl0aGluZyBhcHBlYXJzIG9sZC4KICAgIHRoaXMuX3RpY2sgKz0gOCAtICh0aGlzLl90aWNrICYgNykgLSAyIC8vIHRyaWdnZXJzIGEgc2VyaWVzIG9mIHBpbmdzIGluIHR3byB0aWNrcwogICAgdGhpcy5fc3RhYmxlVGlja3MgPSBNT1JFX1NUQUJMRV9USUNLUwogICAgdGhpcy5fcmVmcmVzaFRpY2tzID0gMSAvLyB0cmlnZ2VycyBhIHJlZnJlc2ggbmV4dCB0aWNrIChhbGxvdyBuZXR3b3JrIHRpbWUgdG8gd2FrZSB1cCBhbHNvKQogICAgdGhpcy5fbGFzdEhvc3QgPSBudWxsIC8vIGNsZWFyIG5ldHdvcmsgY2FjaGUgY2hlY2sKCiAgICBpZiAodGhpcy5hZGFwdGl2ZSkgewogICAgICAvLyBUT0RPOiByZS1lbmFibGUgdGhpcyBhcyBzb29uIGFzIHdlIGZpbmQgb3V0IHdoeSB0aGlzIGlzIG92ZXIgdHJpZ2dlcmluZyBpbiBzb21lIGVkZ2UgY2FzZXMKICAgICAgLy8gdGhpcy5maXJld2FsbGVkID0gdHJ1ZQogICAgICAvLyB0aGlzLmlvLmZpcmV3YWxsZWQgPSB0cnVlCgogICAgICBpZiAoIXRoaXMuZXBoZW1lcmFsKSB7CiAgICAgICAgdGhpcy5lcGhlbWVyYWwgPSB0cnVlCiAgICAgICAgdGhpcy5pby5lcGhlbWVyYWwgPSB0cnVlCiAgICAgICAgdGhpcy5lbWl0KCdlcGhlbWVyYWwnKQogICAgICB9CiAgICB9CgogICAgdGhpcy5lbWl0KCd3YWtldXAnKQogIH0KCiAgX29uZnVsbHJvdyhuZXdOb2RlLCByb3cpIHsKICAgIGlmICghdGhpcy5ib290c3RyYXBwZWQgfHwgdGhpcy5fcmVwaW5naW5nID49IDMpIHJldHVybgoKICAgIGxldCBvbGRlc3QgPSBudWxsCiAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygcm93Lm5vZGVzKSB7CiAgICAgIGlmIChub2RlLnBpbmdlZCA9PT0gdGhpcy5fdGljaykgY29udGludWUKICAgICAgaWYgKAogICAgICAgIG9sZGVzdCA9PT0gbnVsbCB8fAogICAgICAgIG9sZGVzdC5waW5nZWQgPiBub2RlLnBpbmdlZCB8fAogICAgICAgIChvbGRlc3QucGluZ2VkID09PSBub2RlLnBpbmdlZCAmJiBvbGRlc3QuYWRkZWQgPiBub2RlLmFkZGVkKQogICAgICApIHsKICAgICAgICBvbGRlc3QgPSBub2RlCiAgICAgIH0KICAgIH0KCiAgICBpZiAob2xkZXN0ID09PSBudWxsKSByZXR1cm4KICAgIGlmICh0aGlzLl90aWNrIC0gb2xkZXN0LnBpbmdlZCA8IFJFQ0VOVF9OT0RFICYmIHRoaXMuX3RpY2sgLSBvbGRlc3QuYWRkZWQgPiBPTERfTk9ERSkgcmV0dXJuCgogICAgdGhpcy5fcmVwaW5nQW5kU3dhcChuZXdOb2RlLCBvbGRlc3QpCiAgfQoKICBfb25uZXR3b3JrY2hhbmdlKGludGVyZmFjZXMpIHsKICAgIHRoaXMuZW1pdCgnbmV0d29yay1jaGFuZ2UnLCBpbnRlcmZhY2VzKQogICAgdGhpcy5lbWl0KCduZXR3b3JrLXVwZGF0ZScpCiAgfQoKICBfcmVwaW5nQW5kU3dhcChuZXdOb2RlLCBvbGROb2RlKSB7CiAgICBjb25zdCBzZWxmID0gdGhpcwogICAgY29uc3QgbGFzdFNlZW4gPSBvbGROb2RlLnNlZW4KCiAgICBvbGROb2RlLnBpbmdlZCA9IHRoaXMuX3RpY2sKCiAgICB0aGlzLl9yZXBpbmdpbmcrKwogICAgdGhpcy5fcmVxdWVzdCgKICAgICAgeyBpZDogbnVsbCwgaG9zdDogb2xkTm9kZS5ob3N0LCBwb3J0OiBvbGROb2RlLnBvcnQgfSwKICAgICAgZmFsc2UsCiAgICAgIHRydWUsCiAgICAgIFBJTkcsCiAgICAgIG51bGwsCiAgICAgIG51bGwsCiAgICAgIG51bGwsCiAgICAgIG9uc3VjY2VzcywKICAgICAgb25zd2FwCiAgICApCgogICAgZnVuY3Rpb24gb25zdWNjZXNzKG0pIHsKICAgICAgaWYgKG9sZE5vZGUuc2VlbiA8PSBsYXN0U2VlbikgcmV0dXJuIG9uc3dhcCgpCiAgICAgIHNlbGYuX3JlcGluZ2luZy0tCiAgICB9CgogICAgZnVuY3Rpb24gb25zd2FwKGUpIHsKICAgICAgc2VsZi5fcmVwaW5naW5nLS0KICAgICAgc2VsZi5fcmVtb3ZlTm9kZShvbGROb2RlKQogICAgICBzZWxmLl9hZGROb2RlKG5ld05vZGUpCiAgICB9CiAgfQoKICBfb25yZXF1ZXN0KHJlcSwgZXh0ZXJuYWwpIHsKICAgIGlmIChyZXEuZnJvbS5pZCAhPT0gbnVsbCkgewogICAgICB0aGlzLl9hZGROb2RlRnJvbU5ldHdvcmsoIWV4dGVybmFsLCByZXEuZnJvbSwgcmVxLnRvKQogICAgfQoKICAgIGlmIChyZXEuaW50ZXJuYWwpIHsKICAgICAgc3dpdGNoIChyZXEuY29tbWFuZCkgewogICAgICAgIC8vIHN0YW5kYXJkIGtlZXAgYWxpdmUgY2FsbAogICAgICAgIGNhc2UgUElORzogewogICAgICAgICAgcmVxLnNlbmRSZXBseSgwLCBudWxsLCBmYWxzZSwgZmFsc2UpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgLy8gY2hlY2sgaWYgdGhlIG90aGVyIHNpZGUgY2FuIHJlY2VpdmUgYSBtZXNzYWdlIHRvIHRoZWlyIG90aGVyIHNvY2tldAogICAgICAgIGNhc2UgUElOR19OQVQ6IHsKICAgICAgICAgIGlmIChyZXEudmFsdWUgPT09IG51bGwgfHwgcmVxLnZhbHVlLmJ5dGVMZW5ndGggPCAyKSByZXR1cm4KICAgICAgICAgIGNvbnN0IHBvcnQgPSBjLnVpbnQxNi5kZWNvZGUoeyBzdGFydDogMCwgZW5kOiAyLCBidWZmZXI6IHJlcS52YWx1ZSB9KQogICAgICAgICAgaWYgKHBvcnQgPT09IDApIHJldHVybgogICAgICAgICAgcmVxLmZyb20ucG9ydCA9IHBvcnQKICAgICAgICAgIHJlcS5zZW5kUmVwbHkoMCwgbnVsbCwgZmFsc2UsIGZhbHNlKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIC8vIGVtcHR5IGRodCByZXBseSBiYWNrCiAgICAgICAgY2FzZSBGSU5EX05PREU6IHsKICAgICAgICAgIGlmICghcmVxLnRhcmdldCkgcmV0dXJuCiAgICAgICAgICByZXEuc2VuZFJlcGx5KDAsIG51bGwsIGZhbHNlLCB0cnVlKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIC8vICJ0aGlzIGlzIG5vZGUgeW91IHNlbnQgbWUgaXMgZG93biIgLSBsZXQncyB0cnkgdG8gcGluZyBpdAogICAgICAgIGNhc2UgRE9XTl9ISU5UOiB7CiAgICAgICAgICBpZiAocmVxLnZhbHVlID09PSBudWxsIHx8IHJlcS52YWx1ZS5ieXRlTGVuZ3RoIDwgNikgcmV0dXJuCiAgICAgICAgICBpZiAodGhpcy5fY2hlY2tzIDwgMTApIHsKICAgICAgICAgICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChUTVAsIHJlcS52YWx1ZS5zdWJhcnJheSgwLCA2KSkKICAgICAgICAgICAgY29uc3Qgbm9kZSA9IHRoaXMudGFibGUuZ2V0KFRNUCkKICAgICAgICAgICAgaWYgKG5vZGUgJiYgKG5vZGUucGluZ2VkIDwgdGhpcy5fdGljayB8fCBub2RlLmRvd25IaW50cyA9PT0gMCkpIHsKICAgICAgICAgICAgICBub2RlLmRvd25IaW50cysrCiAgICAgICAgICAgICAgdGhpcy5fY2hlY2sobm9kZSkKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVxLnNlbmRSZXBseSgwLCBudWxsLCBmYWxzZSwgZmFsc2UpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJlcS5zZW5kUmVwbHkoVU5LTk9XTl9DT01NQU5ELCBudWxsLCBmYWxzZSwgcmVxLnRhcmdldCAhPT0gbnVsbCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gYXNrIHRoZSB1c2VyIHRvIGhhbmRsZSBpdCBvciByZXBseSBiYWNrIHdpdGggYSBiYWQgY29tbWFuZAogICAgaWYgKHRoaXMub25yZXF1ZXN0KHJlcSkgPT09IGZhbHNlKSB7CiAgICAgIHJlcS5zZW5kUmVwbHkoVU5LTk9XTl9DT01NQU5ELCBudWxsLCBmYWxzZSwgcmVxLnRhcmdldCAhPT0gbnVsbCkKICAgIH0KICB9CgogIG9ucmVxdWVzdChyZXEpIHsKICAgIHJldHVybiB0aGlzLmVtaXQoJ3JlcXVlc3QnLCByZXEpCiAgfQoKICBfb25yZXNwb25zZShyZXMsIGV4dGVybmFsKSB7CiAgICB0aGlzLl9hZGROb2RlRnJvbU5ldHdvcmsoIWV4dGVybmFsLCByZXMuZnJvbSwgcmVzLnRvKQogIH0KCiAgX29udGltZW91dChyZXEpIHsKICAgIGlmICghcmVxLnRvLmlkKSByZXR1cm4KICAgIGNvbnN0IG5vZGUgPSB0aGlzLnRhYmxlLmdldChyZXEudG8uaWQpCiAgICBpZiAobm9kZSkgdGhpcy5fcmVtb3ZlTm9kZShub2RlKQogIH0KCiAgX3BpbmdTb21lKCkgewogICAgbGV0IGNudCA9IHRoaXMuaW8uaW5mbGlnaHQubGVuZ3RoID4gMiA/IDMgOiA1CiAgICBsZXQgb2xkZXN0ID0gdGhpcy5ub2Rlcy5vbGRlc3QKCiAgICAvLyB0aW55IGRodCwgcGluZ2VkIHRoZSBib290c3RyYXAgYWdhaW4KICAgIGlmICghb2xkZXN0KSB7CiAgICAgIHRoaXMucmVmcmVzaCgpCiAgICAgIHJldHVybgogICAgfQoKICAgIC8vIHdlJ3ZlIHJlY2VudGx5IHBpbmdlZCB0aGUgb2xkZXN0IG9uZSwgc28gb25seSB0cmlnZ2VyIGEgY291cGxlIG9mIHJlcGluZ3MKICAgIGlmICh0aGlzLl90aWNrIC0gb2xkZXN0LnBpbmdlZCA8IFJFQ0VOVF9OT0RFKSB7CiAgICAgIGNudCA9IDIKICAgIH0KCiAgICB3aGlsZSAoY250LS0pIHsKICAgICAgaWYgKCFvbGRlc3QgfHwgdGhpcy5fdGljayA9PT0gb2xkZXN0LnBpbmdlZCkgY29udGludWUKICAgICAgdGhpcy5fY2hlY2sob2xkZXN0KQogICAgICBvbGRlc3QgPSBvbGRlc3QubmV4dAogICAgfQogIH0KCiAgX2NoZWNrKG5vZGUpIHsKICAgIG5vZGUucGluZ2VkID0gdGhpcy5fdGljawoKICAgIGNvbnN0IGxhc3RTZWVuID0gbm9kZS5zZWVuCiAgICBjb25zdCBvbnJlc3BvbnNlID0gKCkgPT4gewogICAgICB0aGlzLl9jaGVja3MtLQogICAgICB0aGlzLl9yZW1vdmVTdGFsZU5vZGUobm9kZSwgbGFzdFNlZW4pCiAgICB9CiAgICBjb25zdCBvbmVycm9yID0gKCkgPT4gewogICAgICB0aGlzLl9jaGVja3MtLQogICAgICB0aGlzLl9yZW1vdmVOb2RlKG5vZGUpCiAgICB9CgogICAgdGhpcy5fY2hlY2tzKysKICAgIHRoaXMuX3JlcXVlc3QoCiAgICAgIHsgaWQ6IG51bGwsIGhvc3Q6IG5vZGUuaG9zdCwgcG9ydDogbm9kZS5wb3J0IH0sCiAgICAgIGZhbHNlLAogICAgICB0cnVlLAogICAgICBQSU5HLAogICAgICBudWxsLAogICAgICBudWxsLAogICAgICBudWxsLAogICAgICBvbnJlc3BvbnNlLAogICAgICBvbmVycm9yCiAgICApCiAgfQoKICBfb250aWNrKCkgewogICAgY29uc3QgdGltZSA9IERhdGUubm93KCkKCiAgICBpZiAodGltZSAtIHRoaXMuX2xhc3RUaWNrID4gU0xFRVBJTkdfSU5URVJWQUwgJiYgdGhpcy5zdXNwZW5kZWQgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMuX29ud2FrZXVwKCkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3RpY2srKwogICAgfQoKICAgIHRoaXMuX2xhc3RUaWNrID0gdGltZQoKICAgIGlmICghdGhpcy5ib290c3RyYXBwZWQgfHwgdGhpcy5zdXNwZW5kZWQpIHJldHVybgoKICAgIGlmICh0aGlzLmFkYXB0aXZlICYmIHRoaXMuZXBoZW1lcmFsICYmIC0tdGhpcy5fc3RhYmxlVGlja3MgPD0gMCkgewogICAgICBpZiAodGhpcy5fbGFzdEhvc3QgPT09IHRoaXMuX25hdC5ob3N0KSB7CiAgICAgICAgLy8gZG8gbm90IHJlY2hlY2sgdGhlIHNhbWUgbmV0d29yay4uLgogICAgICAgIHRoaXMuX3N0YWJsZVRpY2tzID0gTU9SRV9TVEFCTEVfVElDS1MKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl91cGRhdGVOZXR3b3JrU3RhdGUoKSAvLyB0aGUgcHJvbWlzZSByZXR1cm5lZCBoZXJlIG5ldmVyIGZhaWxzIHNvIGp1c3QgaWdub3JlIGl0CiAgICAgIH0KICAgIH0KCiAgICBpZiAoKHRoaXMuX3RpY2sgJiA3KSA9PT0gMCkgewogICAgICB0aGlzLl9waW5nU29tZSgpCiAgICB9CgogICAgaWYgKAogICAgICAoKHRoaXMuX3RpY2sgJiA2MykgPT09IDAgJiYgdGhpcy5ub2Rlcy5sZW5ndGggPCB0aGlzLnRhYmxlLmspIHx8CiAgICAgIC0tdGhpcy5fcmVmcmVzaFRpY2tzIDw9IDAKICAgICkgewogICAgICB0aGlzLnJlZnJlc2goKQogICAgfQogIH0KCiAgYXN5bmMgX3VwZGF0ZU5ldHdvcmtTdGF0ZShvbmx5RmlyZXdhbGwgPSBmYWxzZSkgewogICAgaWYgKCF0aGlzLmVwaGVtZXJhbCkgcmV0dXJuIGZhbHNlCiAgICBpZiAob25seUZpcmV3YWxsICYmICF0aGlzLmZpcmV3YWxsZWQpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IHsgaG9zdCwgcG9ydCB9ID0gdGhpcy5fbmF0CgogICAgaWYgKCFvbmx5RmlyZXdhbGwpIHsKICAgICAgLy8gcmVtZW1iZXIgd2hhdCBob3N0IHdlIGNoZWNrZWQgYW5kIHJlc2V0IHRoZSBjb3VudGVyCiAgICAgIHRoaXMuX3N0YWJsZVRpY2tzID0gTU9SRV9TVEFCTEVfVElDS1MKICAgICAgdGhpcy5fbGFzdEhvc3QgPSBob3N0CiAgICB9CgogICAgLy8gY2hlY2sgaWYgd2UgaGF2ZSBhIGNvbnNpc3RlbnQgaG9zdCBhbmQgcG9ydAogICAgaWYgKGhvc3QgPT09IG51bGwgfHwgcG9ydCA9PT0gMCkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBjb25zdCBuYXRTYW1wbGVyID0gdGhpcy5maXJld2FsbGVkID8gbmV3IE5hdFNhbXBsZXIoKSA6IHRoaXMuX25hdAoKICAgIC8vIGFzayByZW1vdGUgbm9kZXMgdG8gcGluZyB1cyBvbiBvdXIgc2VydmVyIHNvY2tldCB0byBzZWUgaWYgd2UgaGF2ZSB0aGUgcG9ydCBvcGVuCiAgICBjb25zdCBmaXJld2FsbGVkID0gdGhpcy5maXJld2FsbGVkICYmIChhd2FpdCB0aGlzLl9jaGVja0lmRmlyZXdhbGxlZChuYXRTYW1wbGVyKSkKICAgIGlmIChmaXJld2FsbGVkKSByZXR1cm4gZmFsc2UKCiAgICB0aGlzLmZpcmV3YWxsZWQgPSB0aGlzLmlvLmZpcmV3YWxsZWQgPSBmYWxzZQoKICAgIC8vIGluY2FzZSBpdCdzIGNhbGxlZCBpbiBwYXJhbGxlbCBmb3Igc29tZSByZWFzb24sIG9yIGlmIG91ciBuYXQgc3RhdHVzIHNvbWVob3cgY2hhbmdlZAogICAgaWYgKCF0aGlzLmVwaGVtZXJhbCB8fCBob3N0ICE9PSB0aGlzLl9uYXQuaG9zdCB8fCBwb3J0ICE9PSB0aGlzLl9uYXQucG9ydCkgcmV0dXJuIGZhbHNlCiAgICAvLyBpZiB0aGUgZmlyZXdhbGwgcHJvYmUgcmV0dXJuZWQgYSBkaWZmZXJlbnQgaG9zdCAvIG5vbiBjb25zaXN0ZW50IHBvcnQsIGJhaWwgYXMgd2VsbAogICAgaWYgKG5hdFNhbXBsZXIuaG9zdCAhPT0gaG9zdCB8fCBuYXRTYW1wbGVyLnBvcnQgPT09IDApIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGlkID0gcGVlci5pZChuYXRTYW1wbGVyLmhvc3QsIG5hdFNhbXBsZXIucG9ydCkKCiAgICBpZiAoIW9ubHlGaXJld2FsbCkgewogICAgICB0aGlzLmVwaGVtZXJhbCA9IHRoaXMuaW8uZXBoZW1lcmFsID0gZmFsc2UKICAgIH0KCiAgICBpZiAobmF0U2FtcGxlciAhPT0gdGhpcy5fbmF0KSB7CiAgICAgIGNvbnN0IHByZXZIb3N0ID0gdGhpcy5fbmF0Lmhvc3QKICAgICAgY29uc3QgcHJldlBvcnQgPSB0aGlzLl9uYXQucG9ydAoKICAgICAgdGhpcy5fbm9uZVBlcnNpc3RlbnRTYW1wbGVzID0gW10KICAgICAgdGhpcy5fbmF0ID0gbmF0U2FtcGxlcgoKICAgICAgaWYgKHByZXZIb3N0ICE9PSB0aGlzLl9uYXQuaG9zdCB8fCBwcmV2UG9ydCAhPT0gdGhpcy5fbmF0LnBvcnQpIHsKICAgICAgICB0aGlzLmVtaXQoJ25hdC11cGRhdGUnLCB0aGlzLl9uYXQuaG9zdCwgdGhpcy5fbmF0LnBvcnQpCiAgICAgIH0KICAgIH0KCiAgICAvLyBUT0RPOiB3ZSBzaG91bGQgbWFrZSB0aGlzIGEgYml0IG1vcmUgZGVmZW5zaXZlIGluIHRlcm1zIG9mIHVzaW5nIG1vcmUKICAgIC8vIHJlc291cmNlcyB0byBtYWtlIHN1cmUgdGhhdCB0aGUgbmV3IHJvdXRpbmcgdGFibGUgY29udGFpbnMgYXMgbWFueSBhbGl2ZSBub2RlcwogICAgLy8gYXMgcG9zc2libGUsIHZzIGJsaW5kbHkgY29weWluZyB0aGVtIG92ZXIuLi4KCiAgICAvLyBhbGwgZ29vZCEgY29weSBvdmVyIHRoZSBvbGQgcm91dGluZyB0YWJsZSB0byB0aGUgbmV3IG9uZQogICAgaWYgKCFiNGEuZXF1YWxzKHRoaXMudGFibGUuaWQsIGlkKSkgewogICAgICBjb25zdCBub2RlcyA9IHRoaXMudGFibGUudG9BcnJheSgpCgogICAgICB0aGlzLnRhYmxlID0gdGhpcy5pby50YWJsZSA9IG5ldyBUYWJsZShpZCkKCiAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiBub2RlcykgewogICAgICAgIGlmIChiNGEuZXF1YWxzKG5vZGUuaWQsIGlkKSkgY29udGludWUKICAgICAgICBpZiAoIXRoaXMudGFibGUuYWRkKG5vZGUpKSB0aGlzLm5vZGVzLnJlbW92ZShub2RlKQogICAgICB9CgogICAgICB0aGlzLnRhYmxlLm9uKCdyb3cnLCB0aGlzLl9vbnJvdykKCiAgICAgIC8vIHdlIG5lZWQgdG8gcmVib290c3RyYXAvcmVmcmVzaCBzaW5jZSB3ZSB1cGRhdGVkIG91ciBpZAogICAgICBpZiAodGhpcy5ib290c3RyYXBwZWQpIHRoaXMucmVmcmVzaCgpCiAgICB9CgogICAgaWYgKCF0aGlzLmVwaGVtZXJhbCkgewogICAgICB0aGlzLmVtaXQoJ3BlcnNpc3RlbnQnKQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyAqX3Jlc29sdmVCb290c3RyYXBOb2RlcygpIHsKICAgIGZvciAobGV0IHsgaG9zdCwgcG9ydCB9IG9mIHRoaXMuYm9vdHN0cmFwTm9kZXMpIHsKICAgICAgbGV0IGRvTG9va3VwID0gZmFsc2UKCiAgICAgIGlmIChob3N0LmluZGV4T2YoJ0AnKSA9PT0gLTEpIHsKICAgICAgICBkb0xvb2t1cCA9IHRydWUKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBbc3VnZ2VzdGVkSVAsIGZhbGxiYWNrSG9zdF0gPSBob3N0LnNwbGl0KCdAJykKICAgICAgICB0cnkgewogICAgICAgICAgYXdhaXQgdGhpcy5waW5nKHsgaG9zdDogc3VnZ2VzdGVkSVAsIHBvcnQgfSkKICAgICAgICAgIGhvc3QgPSBzdWdnZXN0ZWRJUAogICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgaG9zdCA9IGZhbGxiYWNrSG9zdAogICAgICAgICAgZG9Mb29rdXAgPSB0cnVlCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoZG9Mb29rdXApIHsKICAgICAgICB0cnkgewogICAgICAgICAgaG9zdCA9IFVEWC5pc0lQdjQoaG9zdCkgPyBob3N0IDogKGF3YWl0IHRoaXMudWR4Lmxvb2t1cChob3N0LCB7IGZhbWlseTogNCB9KSkuaG9zdAogICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHlpZWxkIHsKICAgICAgICBpZDogcGVlci5pZChob3N0LCBwb3J0KSwKICAgICAgICBob3N0LAogICAgICAgIHBvcnQKICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgX2FkZEJvb3RzdHJhcE5vZGVzKG5vZGVzKSB7CiAgICBmb3IgYXdhaXQgKGNvbnN0IG5vZGUgb2YgdGhpcy5fcmVzb2x2ZUJvb3RzdHJhcE5vZGVzKCkpIHsKICAgICAgbm9kZXMucHVzaChub2RlKQogICAgfQogIH0KCiAgYXN5bmMgX2NoZWNrSWZGaXJld2FsbGVkKG5hdFNhbXBsZXIgPSBuZXcgTmF0U2FtcGxlcigpKSB7CiAgICBjb25zdCBub2RlcyA9IFtdCiAgICBmb3IgKGxldCBub2RlID0gdGhpcy5ub2Rlcy5sYXRlc3Q7IG5vZGUgJiYgbm9kZXMubGVuZ3RoIDwgNTsgbm9kZSA9IG5vZGUucHJldikgewogICAgICBub2Rlcy5wdXNoKG5vZGUpCiAgICB9CgogICAgaWYgKG5vZGVzLmxlbmd0aCA8IDUpIGF3YWl0IHRoaXMuX2FkZEJvb3RzdHJhcE5vZGVzKG5vZGVzKQogICAgLy8gaWYgbm8gbm9kZXMgYXJlIGF2YWlsYWJsZSwgaW5jbHVkaW5nIGJvb3RzdHJhcHBlcnMgLSBiYWlsCiAgICBpZiAobm9kZXMubGVuZ3RoID09PSAwKSByZXR1cm4gdHJ1ZQoKICAgIGNvbnN0IGhvc3RzID0gbmV3IFNldCgpCiAgICBjb25zdCB2YWx1ZSA9IGI0YS5hbGxvY1Vuc2FmZSgyKQoKICAgIGMudWludDE2LmVuY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IDIsIGJ1ZmZlcjogdmFsdWUgfSwgdGhpcy5pby5zZXJ2ZXJTb2NrZXQuYWRkcmVzcygpLnBvcnQpCgogICAgLy8gZG91YmxlIGNoZWNrIHRoZXkgYWN0dWFsbHkgY2FtZSBvbiB0aGUgc2VydmVyIHNvY2tldC4uLgogICAgdGhpcy5pby5zZXJ2ZXJTb2NrZXQub24oJ21lc3NhZ2UnLCBvbm1lc3NhZ2UpCgogICAgY29uc3QgcG9uZ3MgPSBhd2FpdCByZXF1ZXN0QWxsKHRoaXMsIHRydWUsIFBJTkdfTkFULCB2YWx1ZSwgbm9kZXMpCgogICAgbGV0IGNvdW50ID0gMAogICAgZm9yIChjb25zdCByZXMgb2YgcG9uZ3MpIHsKICAgICAgaWYgKGhvc3RzLmhhcyhyZXMuZnJvbS5ob3N0KSkgewogICAgICAgIGNvdW50KysKICAgICAgICBuYXRTYW1wbGVyLmFkZChyZXMudG8uaG9zdCwgcmVzLnRvLnBvcnQpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmlvLnNlcnZlclNvY2tldC5yZW1vdmVMaXN0ZW5lcignbWVzc2FnZScsIG9ubWVzc2FnZSkKCiAgICAvLyBpZiB3ZSBnb3Qgbm8gb3IgdmVyeSBmZXcgcmVwbGllcywgY29uc2lkZXIgaXQgYSBmbHVrZQogICAgaWYgKGNvdW50IDwgKG5vZGVzLmxlbmd0aCA+PSA1ID8gMyA6IDEpKSByZXR1cm4gdHJ1ZQoKICAgIC8vIGNoZWNrIHRoYXQgdGhlIHNlcnZlciBzb2NrZXQgaGFzIHRoZSBzYW1lIGlwIGFzIHRoZSBjbGllbnQgc29ja2V0CiAgICBpZiAobmF0U2FtcGxlci5ob3N0ID09PSBudWxsIHx8IHRoaXMuX25hdC5ob3N0ICE9PSBuYXRTYW1wbGVyLmhvc3QpIHJldHVybiB0cnVlCgogICAgLy8gY2hlY2sgdGhhdCB0aGUgbG9jYWwgcG9ydCBvZiB0aGUgc2VydmVyIHNvY2tldCBpcyB0aGUgc2FtZSBhcyB0aGUgcmVtb3RlIHBvcnQKICAgIC8vIFRPRE86IHdlIG1pZ2h0IHdhbnQgYSBmbGFnIHRvIG9wdCBvdXQgb2YgdGhpcyBoZXVyaXN0aWMgZm9yIHNwZWNpZmljIHJlbWFwcGVkIHBvcnQgc2VydmVycwogICAgaWYgKG5hdFNhbXBsZXIucG9ydCA9PT0gMCB8fCBuYXRTYW1wbGVyLnBvcnQgIT09IHRoaXMuaW8uc2VydmVyU29ja2V0LmFkZHJlc3MoKS5wb3J0KSB7CiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCgogICAgZnVuY3Rpb24gb25tZXNzYWdlKF8sIHsgaG9zdCB9KSB7CiAgICAgIGhvc3RzLmFkZChob3N0KQogICAgfQogIH0KCiAgX2JhY2tncm91bmRRdWVyeSh0YXJnZXQpIHsKICAgIHRoaXMuX3JlZnJlc2hUaWNrcyA9IFJFRlJFU0hfVElDS1MKCiAgICBjb25zdCBiYWNrZ3JvdW5kQ29uID0gTWF0aC5taW4odGhpcy5jb25jdXJyZW5jeSwgTWF0aC5tYXgoMiwgKHRoaXMuY29uY3VycmVuY3kgLyA4KSB8IDApKQogICAgY29uc3QgcSA9IG5ldyBRdWVyeSh0aGlzLCB0YXJnZXQsIHRydWUsIEZJTkRfTk9ERSwgbnVsbCwgewogICAgICBjb25jdXJyZW5jeTogYmFja2dyb3VuZENvbiwKICAgICAgbWF4U2xvdzogMAogICAgfSkKCiAgICBxLm9uKCdkYXRhJywgKCkgPT4gewogICAgICAvLyB5aWVsZCB0byBvdGhlciB0cmFmZmljCiAgICAgIHEuY29uY3VycmVuY3kgPSB0aGlzLmlvLmluZmxpZ2h0Lmxlbmd0aCA8IDMgPyB0aGlzLmNvbmN1cnJlbmN5IDogYmFja2dyb3VuZENvbgogICAgfSkKCiAgICByZXR1cm4gcQogIH0KCiAgLy8gY2FsbGVkIGJ5IHRoZSBxdWVyeQogIF9vbmxpbmUoKSB7CiAgICBpZiAodGhpcy5vbmxpbmUpIHJldHVybgogICAgdGhpcy5vbmxpbmUgPSB0cnVlCiAgICB0aGlzLmVtaXQoJ25ldHdvcmstdXBkYXRlJykKICB9CgogIC8vIGNhbGxlZCBieSB0aGUgcXVlcnkKICBfb2ZmbGluZSgpIHsKICAgIGlmICghdGhpcy5vbmxpbmUpIHJldHVybgogICAgdGhpcy5vbmxpbmUgPSBmYWxzZQogICAgdGhpcy5lbWl0KCduZXR3b3JrLXVwZGF0ZScpCiAgfQp9CgpESFQuT0sgPSAwCkRIVC5FUlJPUl9VTktOT1dOX0NPTU1BTkQgPSBVTktOT1dOX0NPTU1BTkQKREhULkVSUk9SX0lOVkFMSURfVE9LRU4gPSBJTlZBTElEX1RPS0VOCgptb2R1bGUuZXhwb3J0cyA9IERIVAoKZnVuY3Rpb24gbG9jYWxJUCh1ZHgsIGZhbWlseSA9IDQpIHsKICBsZXQgaG9zdCA9IG51bGwKCiAgZm9yIChjb25zdCBuIG9mIHVkeC5uZXR3b3JrSW50ZXJmYWNlcygpKSB7CiAgICBpZiAobi5mYW1pbHkgIT09IGZhbWlseSB8fCBuLmludGVybmFsKSBjb250aW51ZQoKICAgIC8vIG1hYyByZWFsbHkgbGlrZXMgZW4wLCBtYiBhIGJldHRlciB3YXkgYnV0IHRoaXMgc2hvdWxkbnQgYmUgYmFkIGFueXdoZXJlIHNvIHJldHVybiBub3cKICAgIGlmIChuLm5hbWUgPT09ICdlbjAnKSByZXR1cm4gbi5ob3N0CgogICAgLy8gb3RoZXJ3aXNlIHBpY2sgdGhlIGZpcnN0IG5vbiBpbnRlcm5hbCBob3N0IChsZXQgdGhlIGxvb3AgY29udGludWUgaW4gY2FzZSB3ZSBzZWUgZW4wKQogICAgaWYgKGhvc3QgPT09IG51bGwpIGhvc3QgPSBuLmhvc3QKICB9CgogIHJldHVybiBob3N0IHx8IChmYW1pbHkgPT09IDQgPyAnMTI3LjAuMC4xJyA6ICc6OjEnKQp9CgpmdW5jdGlvbiBwYXJzZU5vZGUocykgewogIGlmICh0eXBlb2YgcyA9PT0gJ29iamVjdCcpIHJldHVybiBzCiAgaWYgKHR5cGVvZiBzID09PSAnbnVtYmVyJykgcmV0dXJuIHsgaG9zdDogJzEyNy4wLjAuMScsIHBvcnQ6IHMgfQogIGNvbnN0IFtob3N0LCBwb3J0XSA9IHMuc3BsaXQoJzonKQogIGlmICghcG9ydCkgdGhyb3cgbmV3IEVycm9yKCdCb290c3RyYXAgbm9kZSBmb3JtYXQgaXMgaG9zdDpwb3J0JykKCiAgcmV0dXJuIHsKICAgIGhvc3QsCiAgICBwb3J0OiBOdW1iZXIocG9ydCkKICB9Cn0KCmZ1bmN0aW9uIHJhbmRvbUJ5dGVzKG4pIHsKICBjb25zdCBiID0gYjRhLmFsbG9jKG4pCiAgc29kaXVtLnJhbmRvbWJ5dGVzX2J1ZihiKQogIHJldHVybiBiCn0KCmZ1bmN0aW9uIHJhbmRvbU9mZnNldChuKSB7CiAgcmV0dXJuIG4gLSAoKE1hdGgucmFuZG9tKCkgKiAwLjUgKiBuKSB8IDApCn0KCmZ1bmN0aW9uIHJlcXVlc3RBbGwoZGh0LCBpbnRlcm5hbCwgY29tbWFuZCwgdmFsdWUsIG5vZGVzKSB7CiAgbGV0IG1pc3NpbmcgPSBub2Rlcy5sZW5ndGgKICBjb25zdCByZXBsaWVzID0gW10KCiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIHsKICAgICAgY29uc3QgcmVxID0gZGh0Ll9yZXF1ZXN0KAogICAgICAgIG5vZGUsCiAgICAgICAgZmFsc2UsCiAgICAgICAgaW50ZXJuYWwsCiAgICAgICAgY29tbWFuZCwKICAgICAgICBudWxsLAogICAgICAgIHZhbHVlLAogICAgICAgIG51bGwsCiAgICAgICAgb25zdWNjZXNzLAogICAgICAgIG9uZXJyb3IKICAgICAgKQogICAgICBpZiAoIXJlcSkgcmV0dXJuIHJlc29sdmUocmVwbGllcykKICAgIH0KCiAgICBmdW5jdGlvbiBvbnN1Y2Nlc3MocmVzKSB7CiAgICAgIHJlcGxpZXMucHVzaChyZXMpCiAgICAgIGlmICgtLW1pc3NpbmcgPT09IDApIHJlc29sdmUocmVwbGllcykKICAgIH0KCiAgICBmdW5jdGlvbiBvbmVycm9yKCkgewogICAgICBpZiAoLS1taXNzaW5nID09PSAwKSByZXNvbHZlKHJlcGxpZXMpCiAgICB9CiAgfSkKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmV4cG9ydHMuUElORyA9IDAKZXhwb3J0cy5QSU5HX05BVCA9IDEKZXhwb3J0cy5GSU5EX05PREUgPSAyCmV4cG9ydHMuRE9XTl9ISU5UID0gMwptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIERIVEVycm9yIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yKG1zZywgY29kZSwgZm4gPSBESFRFcnJvcikgewogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWApCiAgICB0aGlzLmNvZGUgPSBjb2RlCgogICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIGZuKQogICAgfQogIH0KCiAgZ2V0IG5hbWUoKSB7CiAgICByZXR1cm4gJ0RIVEVycm9yJwogIH0KCiAgc3RhdGljIFVOS05PV05fQ09NTUFORCA9IDEKICBzdGF0aWMgSU5WQUxJRF9UT0tFTiA9IDIKCiAgc3RhdGljIFJFUVVFU1RfVElNRU9VVChtc2cgPSAnUmVxdWVzdCB0aW1lZCBvdXQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ1JFUVVFU1RfVElNRU9VVCcsIERIVEVycm9yLlJFUVVFU1RfVElNRU9VVCkKICB9CgogIHN0YXRpYyBSRVFVRVNUX0RFU1RST1lFRChtc2cgPSAnUmVxdWVzdCBkZXN0cm95ZWQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ1JFUVVFU1RfREVTVFJPWUVEJywgREhURXJyb3IuUkVRVUVTVF9ERVNUUk9ZRUQpCiAgfQoKICBzdGF0aWMgSU9fU1VTUEVOREVEKG1zZyA9ICdJL08gc3VzcGVuZGVkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdJT19TVVNQRU5ERUQnLCBESFRFcnJvci5JT19TVVNQRU5ERUQpCiAgfQp9CmNvbnN0IEZJRk8gPSByZXF1aXJlKCdmYXN0LWZpZm8nKQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBwZWVyID0gcmVxdWlyZSgnLi9wZWVyJykKY29uc3QgeyBJTlZBTElEX1RPS0VOLCBSRVFVRVNUX1RJTUVPVVQsIFJFUVVFU1RfREVTVFJPWUVELCBJT19TVVNQRU5ERUQgfSA9IHJlcXVpcmUoJy4vZXJyb3JzJykKCmNvbnN0IFZFUlNJT04gPSAwYjExCmNvbnN0IFJFU1BPTlNFX0lEID0gKDBiMDAwMSA8PCA0KSB8IFZFUlNJT04KY29uc3QgUkVRVUVTVF9JRCA9ICgwYjAwMDAgPDwgNCkgfCBWRVJTSU9OCmNvbnN0IEVNUFRZX0FSUkFZID0gW10KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgSU8gewogIGNvbnN0cnVjdG9yKAogICAgdGFibGUsCiAgICB1ZHgsCiAgICB7CiAgICAgIG1heFdpbmRvdyA9IDgwLAogICAgICBwb3J0ID0gMCwKICAgICAgaG9zdCA9ICcwLjAuMC4wJywKICAgICAgYW55UG9ydCA9IHRydWUsCiAgICAgIGZpcmV3YWxsZWQgPSB0cnVlLAogICAgICBvbnJlcXVlc3QsCiAgICAgIG9ucmVzcG9uc2UgPSBub29wLAogICAgICBvbnRpbWVvdXQgPSBub29wCiAgICB9ID0ge30KICApIHsKICAgIHRoaXMudGFibGUgPSB0YWJsZQogICAgdGhpcy51ZHggPSB1ZHgKICAgIHRoaXMuaW5mbGlnaHQgPSBbXQogICAgdGhpcy5jbGllbnRTb2NrZXQgPSBudWxsCiAgICB0aGlzLnNlcnZlclNvY2tldCA9IG51bGwKICAgIHRoaXMuZmlyZXdhbGxlZCA9IGZpcmV3YWxsZWQgIT09IGZhbHNlCiAgICB0aGlzLmVwaGVtZXJhbCA9IHRydWUKICAgIHRoaXMuY29uZ2VzdGlvbiA9IG5ldyBDb25nZXN0aW9uV2luZG93KG1heFdpbmRvdykKICAgIHRoaXMubmV0d29ya0ludGVyZmFjZXMgPSB1ZHgud2F0Y2hOZXR3b3JrSW50ZXJmYWNlcygpCiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCgogICAgdGhpcy5zdGF0cyA9IHsKICAgICAgcmVxdWVzdHM6IHsgYWN0aXZlOiAwLCB0b3RhbDogMCB9LAogICAgICBjb21tYW5kczogWwogICAgICAgIHsgdHg6IDAsIHJ4OiAwIH0sIC8vIHR4ID0gdHJhbnNtaXR0ZWQsIHJ4ID0gcmVjZWl2ZWQKICAgICAgICB7IHR4OiAwLCByeDogMCB9LAogICAgICAgIHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgICAgeyB0eDogMCwgcng6IDAgfQogICAgICBdCiAgICB9CgogICAgdGhpcy5vbnJlcXVlc3QgPSBvbnJlcXVlc3QKICAgIHRoaXMub25yZXNwb25zZSA9IG9ucmVzcG9uc2UKICAgIHRoaXMub250aW1lb3V0ID0gb250aW1lb3V0CgogICAgdGhpcy5fcGVuZGluZyA9IG5ldyBGSUZPKCkKICAgIHRoaXMuX3JvdGF0ZVNlY3JldHMgPSAxMAogICAgdGhpcy5fdGlkID0gKE1hdGgucmFuZG9tKCkgKiA2NTUzNikgfCAwCiAgICB0aGlzLl9zZWNyZXRzID0gbnVsbAogICAgdGhpcy5fZHJhaW5JbnRlcnZhbCA9IG51bGwKICAgIHRoaXMuX2Rlc3Ryb3lpbmcgPSBudWxsCiAgICB0aGlzLl9iaW5kaW5nID0gbnVsbAoKICAgIC8vIHBvcnQgY2FuIGJlIGEgbnVtYmVyIG9yIGEgcmFuZ2UgW3N0YXJ0LCB0b10KICAgIHRoaXMucG9ydFJhbmdlID0gcG9ydC5sZW5ndGggPyBwb3J0IDogcG9ydCA9PT0gMCA/IFswLCAwXSA6IFtwb3J0LCBwb3J0ICsgNV0KCiAgICB0aGlzLl9ob3N0ID0gaG9zdAogICAgdGhpcy5fYW55UG9ydCA9IGFueVBvcnQgIT09IGZhbHNlCiAgICB0aGlzLl9ib3VuZFNlcnZlclBvcnQgPSAwCiAgICB0aGlzLl9ib3VuZENsaWVudFBvcnQgPSAwCiAgfQoKICBvbm1lc3NhZ2Uoc29ja2V0LCBidWZmZXIsIHsgaG9zdCwgcG9ydCB9KSB7CiAgICBpZiAoYnVmZmVyLmJ5dGVMZW5ndGggPCAyIHx8ICEocG9ydCA+IDAgJiYgcG9ydCA8IDY1NTM2KSB8fCB0aGlzLnN1c3BlbmRlZCA9PT0gdHJ1ZSkgcmV0dXJuCgogICAgY29uc3QgZnJvbSA9IHsgaWQ6IG51bGwsIGhvc3QsIHBvcnQgfQogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAxLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoLCBidWZmZXIgfQogICAgY29uc3QgZXhwZWN0ZWRTb2NrZXQgPSB0aGlzLmZpcmV3YWxsZWQgPyB0aGlzLmNsaWVudFNvY2tldCA6IHRoaXMuc2VydmVyU29ja2V0CiAgICBjb25zdCBleHRlcm5hbCA9IHNvY2tldCAhPT0gZXhwZWN0ZWRTb2NrZXQKCiAgICBpZiAoYnVmZmVyWzBdID09PSBSRVFVRVNUX0lEKSB7CiAgICAgIGNvbnN0IHJlcSA9IFJlcXVlc3QuZGVjb2RlKHRoaXMsIHNvY2tldCwgZnJvbSwgc3RhdGUpCiAgICAgIGlmIChyZXEgPT09IG51bGwpIHJldHVybgogICAgICBpZiAoCiAgICAgICAgcmVxLnRva2VuICE9PSBudWxsICYmCiAgICAgICAgIWI0YS5lcXVhbHMocmVxLnRva2VuLCB0aGlzLnRva2VuKHJlcS5mcm9tLCAxKSkgJiYKICAgICAgICAhYjRhLmVxdWFscyhyZXEudG9rZW4sIHRoaXMudG9rZW4ocmVxLmZyb20sIDApKQogICAgICApIHsKICAgICAgICByZXEuZXJyb3IoSU5WQUxJRF9UT0tFTiwgeyB0b2tlbjogdHJ1ZSB9KQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIHRoaXMub25yZXF1ZXN0KHJlcSwgZXh0ZXJuYWwpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChidWZmZXJbMF0gPT09IFJFU1BPTlNFX0lEKSB7CiAgICAgIGNvbnN0IHJlcyA9IGRlY29kZVJlcGx5KGZyb20sIHN0YXRlKQogICAgICBpZiAocmVzID09PSBudWxsKSByZXR1cm4KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5pbmZsaWdodC5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHJlcSA9IHRoaXMuaW5mbGlnaHRbaV0KICAgICAgICBpZiAocmVxLnRpZCAhPT0gcmVzLnRpZCkgY29udGludWUKCiAgICAgICAgcmVzLnJ0dCA9IERhdGUubm93KCkgLSByZXEuX3RpbWVzdGFtcAoKICAgICAgICBpZiAoaSA9PT0gdGhpcy5pbmZsaWdodC5sZW5ndGggLSAxKSB0aGlzLmluZmxpZ2h0LnBvcCgpCiAgICAgICAgZWxzZSB0aGlzLmluZmxpZ2h0W2ldID0gdGhpcy5pbmZsaWdodC5wb3AoKQoKICAgICAgICBpZiAocmVxLnNlc3Npb24pIHJlcS5zZXNzaW9uLl9kZXRhY2gocmVxKQoKICAgICAgICAvLyBUT0RPOiBBdXRvIHJldHJ5IGhlcmUgaWYgZXJyb3JzLklOVkFMSURfVE9LRU4gaXMgcmV0dXJuZWQ/CgogICAgICAgIGlmIChyZXEuX3RpbWVvdXQpIHsKICAgICAgICAgIGNsZWFyVGltZW91dChyZXEuX3RpbWVvdXQpCiAgICAgICAgICByZXEuX3RpbWVvdXQgPSBudWxsCiAgICAgICAgfQoKICAgICAgICB0aGlzLmNvbmdlc3Rpb24ucmVjdigpCgogICAgICAgIGlmIChyZXEuaW50ZXJuYWwgJiYgcmVxLmNvbW1hbmQgPCB0aGlzLnN0YXRzLmNvbW1hbmRzLmxlbmd0aCkgewogICAgICAgICAgdGhpcy5zdGF0cy5jb21tYW5kc1tyZXEuY29tbWFuZF0ucngrKwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zdGF0cy5yZXF1ZXN0cy5hY3RpdmUtLQoKICAgICAgICB0aGlzLm9ucmVzcG9uc2UocmVzLCBleHRlcm5hbCkKICAgICAgICByZXEub25yZXNwb25zZShyZXMsIHJlcSkKICAgICAgICBicmVhawogICAgICB9CiAgICB9CiAgfQoKICB0b2tlbihhZGRyLCBpKSB7CiAgICBpZiAodGhpcy5fc2VjcmV0cyA9PT0gbnVsbCkgewogICAgICBjb25zdCBidWYgPSBiNGEuYWxsb2MoNjQpCiAgICAgIHRoaXMuX3NlY3JldHMgPSBbYnVmLnN1YmFycmF5KDAsIDMyKSwgYnVmLnN1YmFycmF5KDMyLCA2NCldCiAgICAgIHNvZGl1bS5yYW5kb21ieXRlc19idWYodGhpcy5fc2VjcmV0c1swXSkKICAgICAgc29kaXVtLnJhbmRvbWJ5dGVzX2J1Zih0aGlzLl9zZWNyZXRzWzFdKQogICAgfQoKICAgIGNvbnN0IHRva2VuID0gYjRhLmFsbG9jVW5zYWZlKDMyKQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaCh0b2tlbiwgYjRhLmZyb20oYWRkci5ob3N0KSwgdGhpcy5fc2VjcmV0c1tpXSkKICAgIHJldHVybiB0b2tlbgogIH0KCiAgYXN5bmMgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLl9kZXN0cm95aW5nKSByZXR1cm4gdGhpcy5fZGVzdHJveWluZwogICAgdGhpcy5fZGVzdHJveWluZyA9IHRoaXMuX2Rlc3Ryb3koKQogICAgcmV0dXJuIHRoaXMuX2Rlc3Ryb3lpbmcKICB9CgogIGFzeW5jIF9kZXN0cm95KCkgewogICAgLy8gc2ltcGxpZmllcyB0aW1pbmcgdG8gYXdhaXQgdGhlIGJpbmQgaGVyZSBhbHNvLCBhbHRob3VnaCBpdCBtaWdodCBiZSB1bm5lZWRlZAogICAgYXdhaXQgdGhpcy5iaW5kKCkKICAgIGF3YWl0IHRoaXMuX2NsZWFyKGZhbHNlKQogIH0KCiAgYXN5bmMgX2NsZWFyKHN1c3BlbmRlZCkgewogICAgaWYgKHRoaXMuX2RyYWluSW50ZXJ2YWwpIHsKICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9kcmFpbkludGVydmFsKQogICAgICB0aGlzLl9kcmFpbkludGVydmFsID0gbnVsbAogICAgfQoKICAgIHdoaWxlICh0aGlzLmluZmxpZ2h0Lmxlbmd0aCkgewogICAgICBjb25zdCByZXEgPSB0aGlzLmluZmxpZ2h0LnBvcCgpCiAgICAgIGlmIChyZXEuX3RpbWVvdXQpIGNsZWFyVGltZW91dChyZXEuX3RpbWVvdXQpCiAgICAgIHJlcS5fdGltZW91dCA9IG51bGwKICAgICAgcmVxLmRlc3Ryb3llZCA9IHRydWUKCiAgICAgIGlmIChyZXEuc2Vzc2lvbikgcmVxLnNlc3Npb24uX2RldGFjaChyZXEpCgogICAgICB0aGlzLmNvbmdlc3Rpb24ucmVjdigpCiAgICAgIHRoaXMuc3RhdHMucmVxdWVzdHMuYWN0aXZlLS0KCiAgICAgIHJlcS5vbmVycm9yKHN1c3BlbmRlZCA/IElPX1NVU1BFTkRFRCgpIDogUkVRVUVTVF9ERVNUUk9ZRUQoKSwgcmVxKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChbdGhpcy5zZXJ2ZXJTb2NrZXQuY2xvc2UoKSwgdGhpcy5jbGllbnRTb2NrZXQuY2xvc2UoKV0pCgogICAgdGhpcy5uZXR3b3JrSW50ZXJmYWNlcy5kZXN0cm95KCkKICB9CgogIGFzeW5jIHN1c3BlbmQoKSB7CiAgICB0aGlzLnN1c3BlbmRlZCA9IHRydWUKICAgIGF3YWl0IHRoaXMuX2NsZWFyKHRydWUpCgogICAgdGhpcy5jb25nZXN0aW9uLmNsZWFyKCkKCiAgICBpZiAodGhpcy5fZHJhaW5JbnRlcnZhbCkgewogICAgICBjbGVhckludGVydmFsKHRoaXMuX2RyYWluSW50ZXJ2YWwpCiAgICAgIHRoaXMuX2RyYWluSW50ZXJ2YWwgPSBudWxsCiAgICB9CiAgfQoKICBhc3luYyBfcmViaW5kKGJpbmRpbmcpIHsKICAgIGlmIChiaW5kaW5nKSBhd2FpdCBiaW5kaW5nCiAgICBpZiAodGhpcy5fZGVzdHJveWluZykgcmV0dXJuIHRoaXMuX2Rlc3Ryb3lpbmcKICAgIGF3YWl0IHRoaXMuX2JpbmRTb2NrZXRzKCkKICAgIHRoaXMubmV0d29ya0ludGVyZmFjZXMgPSB0aGlzLnVkeC53YXRjaE5ldHdvcmtJbnRlcmZhY2VzKCkKICB9CgogIHJlc3VtZSgpIHsKICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKICAgIGNvbnN0IGJpbmRpbmcgPSB0aGlzLl9iaW5kaW5nCiAgICB0aGlzLl9iaW5kaW5nID0gdGhpcy5fcmViaW5kKGJpbmRpbmcpCiAgICByZXR1cm4gdGhpcy5fYmluZGluZwogIH0KCiAgYmluZCgpIHsKICAgIGlmICh0aGlzLl9iaW5kaW5nKSByZXR1cm4gdGhpcy5fYmluZGluZwogICAgdGhpcy5fYmluZGluZyA9IHRoaXMuX2JpbmRTb2NrZXRzKCkKICAgIHJldHVybiB0aGlzLl9iaW5kaW5nCiAgfQoKICBhc3luYyBfYmluZFNvY2tldHMoKSB7CiAgICBjb25zdCBzZXJ2ZXJTb2NrZXQgPSB0aGlzLnVkeC5jcmVhdGVTb2NrZXQoKQoKICAgIGNvbnN0IGNhbmRpZGF0ZVBvcnRzID0gW10KCiAgICAvLyBSZXRyeWluZyBwcmV2aW91cyBwb3J0IGFsd2F5cyBoYXMgcHJlY2VkZW5jZQogICAgaWYgKHRoaXMuX2JvdW5kU2VydmVyUG9ydCkgY2FuZGlkYXRlUG9ydHMucHVzaCh0aGlzLl9ib3VuZFNlcnZlclBvcnQpCgogICAgZm9yIChsZXQgaSA9IHRoaXMucG9ydFJhbmdlWzBdOyBpIDwgdGhpcy5wb3J0UmFuZ2VbMV07IGkrKykgY2FuZGlkYXRlUG9ydHMucHVzaChpKQoKICAgIGZvciAoY29uc3QgcG9ydCBvZiBjYW5kaWRhdGVQb3J0cykgewogICAgICBpZiAoc2VydmVyU29ja2V0LmJvdW5kKSBicmVhawoKICAgICAgdHJ5IHsKICAgICAgICBzZXJ2ZXJTb2NrZXQuYmluZChwb3J0LCB0aGlzLl9ob3N0KQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBpZiAoIXRoaXMuX2FueVBvcnQpIHsKICAgICAgICAgIGF3YWl0IHNlcnZlclNvY2tldC5jbG9zZSgpCiAgICAgICAgICB0aHJvdyBlcnIKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAoIXNlcnZlclNvY2tldC5ib3VuZCkgewogICAgICB0cnkgewogICAgICAgIHNlcnZlclNvY2tldC5iaW5kKDAsIHRoaXMuX2hvc3QpCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGF3YWl0IHNlcnZlclNvY2tldC5jbG9zZSgpCiAgICAgICAgdGhyb3cgZXJyCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBjbGllbnRTb2NrZXQgPSB0aGlzLnVkeC5jcmVhdGVTb2NrZXQoKQoKICAgIHRyeSB7CiAgICAgIGNsaWVudFNvY2tldC5iaW5kKHRoaXMuX2JvdW5kQ2xpZW50UG9ydCB8fCAwLCB0aGlzLl9ob3N0KQogICAgfSBjYXRjaCB7CiAgICAgIHRyeSB7CiAgICAgICAgY2xpZW50U29ja2V0LmJpbmQoMCwgdGhpcy5faG9zdCkKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgYXdhaXQgc2VydmVyU29ja2V0LmNsb3NlKCkKICAgICAgICBhd2FpdCBjbGllbnRTb2NrZXQuY2xvc2UoKQogICAgICAgIHRocm93IGVycgogICAgICB9CiAgICB9CgogICAgdGhpcy5fYm91bmRTZXJ2ZXJQb3J0ID0gc2VydmVyU29ja2V0LmFkZHJlc3MoKS5wb3J0CiAgICB0aGlzLl9ib3VuZENsaWVudFBvcnQgPSBjbGllbnRTb2NrZXQuYWRkcmVzcygpLnBvcnQKCiAgICB0aGlzLmNsaWVudFNvY2tldCA9IGNsaWVudFNvY2tldAogICAgdGhpcy5zZXJ2ZXJTb2NrZXQgPSBzZXJ2ZXJTb2NrZXQKCiAgICB0aGlzLnNlcnZlclNvY2tldC5vbignbWVzc2FnZScsIHRoaXMub25tZXNzYWdlLmJpbmQodGhpcywgdGhpcy5zZXJ2ZXJTb2NrZXQpKQogICAgdGhpcy5jbGllbnRTb2NrZXQub24oJ21lc3NhZ2UnLCB0aGlzLm9ubWVzc2FnZS5iaW5kKHRoaXMsIHRoaXMuY2xpZW50U29ja2V0KSkKCiAgICBpZiAodGhpcy5fZHJhaW5JbnRlcnZhbCA9PT0gbnVsbCkgewogICAgICB0aGlzLl9kcmFpbkludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5fZHJhaW4uYmluZCh0aGlzKSwgNzUwKQogICAgICBpZiAodGhpcy5fZHJhaW5JbnRlcnZhbC51bnJlZikgdGhpcy5fZHJhaW5JbnRlcnZhbC51bnJlZigpCiAgICB9CgogICAgZm9yIChjb25zdCByZXEgb2YgdGhpcy5pbmZsaWdodCkgewogICAgICBpZiAoIXJlcS5zb2NrZXQpIHJlcS5zb2NrZXQgPSB0aGlzLmZpcmV3YWxsZWQgPyB0aGlzLmNsaWVudFNvY2tldCA6IHRoaXMuc2VydmVyU29ja2V0CiAgICAgIHJlcS5zZW50ID0gMAogICAgICByZXEuc2VuZChmYWxzZSkKICAgIH0KICB9CgogIF9kcmFpbigpIHsKICAgIGlmICh0aGlzLl9zZWNyZXRzICE9PSBudWxsICYmIC0tdGhpcy5fcm90YXRlU2VjcmV0cyA9PT0gMCkgewogICAgICB0aGlzLl9yb3RhdGVTZWNyZXRzID0gMTAKICAgICAgY29uc3QgdG1wID0gdGhpcy5fc2VjcmV0c1swXQogICAgICB0aGlzLl9zZWNyZXRzWzBdID0gdGhpcy5fc2VjcmV0c1sxXQogICAgICB0aGlzLl9zZWNyZXRzWzFdID0gdG1wCiAgICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2godG1wLCB0bXApCiAgICB9CgogICAgdGhpcy5jb25nZXN0aW9uLmRyYWluKCkKCiAgICB3aGlsZSAoIXRoaXMuY29uZ2VzdGlvbi5pc0Z1bGwoKSkgewogICAgICBjb25zdCBwID0gdGhpcy5fcGVuZGluZy5zaGlmdCgpCiAgICAgIGlmIChwID09PSB1bmRlZmluZWQpIHJldHVybgogICAgICBwLl9zZW5kTm93KCkKICAgIH0KICB9CgogIGNyZWF0ZVJlcXVlc3QodG8sIHRva2VuLCBpbnRlcm5hbCwgY29tbWFuZCwgdGFyZ2V0LCB2YWx1ZSwgc2Vzc2lvbiwgdHRsKSB7CiAgICBpZiAodGhpcy5fZGVzdHJveWluZyAhPT0gbnVsbCkgcmV0dXJuIG51bGwKCiAgICBpZiAodGhpcy5fdGlkID09PSA2NTUzNikgdGhpcy5fdGlkID0gMAoKICAgIGNvbnN0IHRpZCA9IHRoaXMuX3RpZCsrCiAgICBjb25zdCBzb2NrZXQgPSB0aGlzLmZpcmV3YWxsZWQgPyB0aGlzLmNsaWVudFNvY2tldCA6IHRoaXMuc2VydmVyU29ja2V0CgogICAgY29uc3QgcmVxID0gbmV3IFJlcXVlc3QoCiAgICAgIHRoaXMsCiAgICAgIHNvY2tldCwKICAgICAgdGlkLAogICAgICBudWxsLAogICAgICB0bywKICAgICAgdG9rZW4sCiAgICAgIGludGVybmFsLAogICAgICBjb21tYW5kLAogICAgICB0YXJnZXQsCiAgICAgIHZhbHVlLAogICAgICBzZXNzaW9uLAogICAgICB0dGwgfHwgMAogICAgKQogICAgdGhpcy5pbmZsaWdodC5wdXNoKHJlcSkKICAgIGlmIChzZXNzaW9uKSBzZXNzaW9uLl9hdHRhY2gocmVxKQoKICAgIGlmIChpbnRlcm5hbCAmJiBjb21tYW5kIDwgdGhpcy5zdGF0cy5jb21tYW5kcy5sZW5ndGgpIHsKICAgICAgdGhpcy5zdGF0cy5jb21tYW5kc1tjb21tYW5kXS50eCsrCiAgICB9CgogICAgdGhpcy5zdGF0cy5yZXF1ZXN0cy5hY3RpdmUrKwogICAgdGhpcy5zdGF0cy5yZXF1ZXN0cy50b3RhbCsrCgogICAgcmV0dXJuIHJlcQogIH0KfQoKY2xhc3MgUmVxdWVzdCB7CiAgY29uc3RydWN0b3IoaW8sIHNvY2tldCwgdGlkLCBmcm9tLCB0bywgdG9rZW4sIGludGVybmFsLCBjb21tYW5kLCB0YXJnZXQsIHZhbHVlLCBzZXNzaW9uLCB0dGwpIHsKICAgIHRoaXMuc29ja2V0ID0gc29ja2V0CiAgICB0aGlzLnRpZCA9IHRpZAogICAgdGhpcy5mcm9tID0gZnJvbQogICAgdGhpcy50byA9IHRvCiAgICB0aGlzLnRva2VuID0gdG9rZW4KICAgIHRoaXMuY29tbWFuZCA9IGNvbW1hbmQKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0CiAgICB0aGlzLnZhbHVlID0gdmFsdWUKICAgIHRoaXMuaW50ZXJuYWwgPSBpbnRlcm5hbAogICAgdGhpcy5zZXNzaW9uID0gc2Vzc2lvbgogICAgdGhpcy50dGwgPSB0dGwKICAgIHRoaXMuaW5kZXggPSAtMQogICAgdGhpcy5zZW50ID0gMAogICAgdGhpcy5yZXRyaWVzID0gMwogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQoKICAgIHRoaXMub25jeWNsZSA9IG5vb3AKICAgIHRoaXMub25lcnJvciA9IG5vb3AKICAgIHRoaXMub25yZXNwb25zZSA9IG5vb3AKCiAgICB0aGlzLl9idWZmZXIgPSBudWxsCiAgICB0aGlzLl9pbyA9IGlvCiAgICB0aGlzLl90aW1lb3V0ID0gbnVsbAogICAgdGhpcy5fdGltZXN0YW1wID0gRGF0ZS5ub3coKQogIH0KCiAgc3RhdGljIGRlY29kZShpbywgc29ja2V0LCBmcm9tLCBzdGF0ZSkgewogICAgdHJ5IHsKICAgICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgICBjb25zdCB0aWQgPSBjLnVpbnQxNi5kZWNvZGUoc3RhdGUpCiAgICAgIGNvbnN0IHRvID0gcGVlci5pcHY0LmRlY29kZShzdGF0ZSkKICAgICAgY29uc3QgaWQgPSBmbGFncyAmIDEgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgICAgY29uc3QgdG9rZW4gPSBmbGFncyAmIDIgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgICAgY29uc3QgaW50ZXJuYWwgPSAoZmxhZ3MgJiA0KSAhPT0gMAogICAgICBjb25zdCBjb21tYW5kID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgICAgY29uc3QgdGFyZ2V0ID0gZmxhZ3MgJiA4ID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICAgIGNvbnN0IHZhbHVlID0gZmxhZ3MgJiAxNiA/IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkgOiBudWxsCgogICAgICBpZiAoaWQgIT09IG51bGwpIGZyb20uaWQgPSB2YWxpZGF0ZUlkKGlkLCBmcm9tKQoKICAgICAgcmV0dXJuIG5ldyBSZXF1ZXN0KAogICAgICAgIGlvLAogICAgICAgIHNvY2tldCwKICAgICAgICB0aWQsCiAgICAgICAgZnJvbSwKICAgICAgICB0bywKICAgICAgICB0b2tlbiwKICAgICAgICBpbnRlcm5hbCwKICAgICAgICBjb21tYW5kLAogICAgICAgIHRhcmdldCwKICAgICAgICB2YWx1ZSwKICAgICAgICBudWxsLAogICAgICAgIDAKICAgICAgKQogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiBudWxsCiAgICB9CiAgfQoKICByZXBseSh2YWx1ZSwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCBzb2NrZXQgPSBvcHRzLnNvY2tldCB8fCB0aGlzLnNvY2tldAogICAgY29uc3QgdG8gPSBvcHRzLnRvIHx8IHRoaXMuZnJvbQogICAgdGhpcy5fc2VuZFJlcGx5KDAsIHZhbHVlIHx8IG51bGwsIG9wdHMudG9rZW4gIT09IGZhbHNlLCBvcHRzLmNsb3Nlck5vZGVzICE9PSBmYWxzZSwgdG8sIHNvY2tldCkKICB9CgogIGVycm9yKGNvZGUsIG9wdHMgPSB7fSkgewogICAgY29uc3Qgc29ja2V0ID0gb3B0cy5zb2NrZXQgfHwgdGhpcy5zb2NrZXQKICAgIGNvbnN0IHRvID0gb3B0cy50byB8fCB0aGlzLmZyb20KICAgIHRoaXMuX3NlbmRSZXBseShjb2RlLCBudWxsLCBvcHRzLnRva2VuID09PSB0cnVlLCBvcHRzLmNsb3Nlck5vZGVzICE9PSBmYWxzZSwgdG8sIHNvY2tldCkKICB9CgogIHJlbGF5KHZhbHVlLCB0bywgb3B0cykgewogICAgY29uc3Qgc29ja2V0ID0gKG9wdHMgJiYgb3B0cy5zb2NrZXQpIHx8IHRoaXMuc29ja2V0CiAgICBjb25zdCBidWZmZXIgPSB0aGlzLl9lbmNvZGVSZXF1ZXN0KG51bGwsIHZhbHVlLCB0bywgc29ja2V0KQogICAgc29ja2V0LnRyeVNlbmQoYnVmZmVyLCB0by5wb3J0LCB0by5ob3N0LCB0aGlzLnR0bCkKICB9CgogIHNlbmQoZm9yY2UgPSBmYWxzZSkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KCiAgICBpZiAodGhpcy5zb2NrZXQgPT09IG51bGwpIHJldHVybgogICAgaWYgKHRoaXMuX2J1ZmZlciA9PT0gbnVsbCkgewogICAgICB0aGlzLl9idWZmZXIgPSB0aGlzLl9lbmNvZGVSZXF1ZXN0KHRoaXMudG9rZW4sIHRoaXMudmFsdWUsIHRoaXMudG8sIHRoaXMuc29ja2V0KQogICAgfQoKICAgIGlmICghZm9yY2UgJiYgdGhpcy5faW8uY29uZ2VzdGlvbi5pc0Z1bGwoKSkgewogICAgICB0aGlzLl9pby5fcGVuZGluZy5wdXNoKHRoaXMpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuX3NlbmROb3coKQogIH0KCiAgc2VuZFJlcGx5KGVycm9yLCB2YWx1ZSwgdG9rZW4sIGhhc0Nsb3Nlck5vZGVzKSB7CiAgICB0aGlzLl9zZW5kUmVwbHkoZXJyb3IsIHZhbHVlLCB0b2tlbiwgaGFzQ2xvc2VyTm9kZXMsIHRoaXMuZnJvbSwgdGhpcy5zb2NrZXQsIG51bGwpCiAgfQoKICBfc2VuZE5vdygpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLnNlbnQrKwogICAgdGhpcy5faW8uY29uZ2VzdGlvbi5zZW5kKCkKICAgIHRoaXMuc29ja2V0LnRyeVNlbmQodGhpcy5fYnVmZmVyLCB0aGlzLnRvLnBvcnQsIHRoaXMudG8uaG9zdCwgdGhpcy50dGwpCiAgICBpZiAodGhpcy5fdGltZW91dCkgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVvdXQpCiAgICB0aGlzLl90aW1lb3V0ID0gc2V0VGltZW91dChvbmN5Y2xlLCAxMDAwLCB0aGlzKQogIH0KCiAgZGVzdHJveShlcnIpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKCiAgICBpZiAodGhpcy5fdGltZW91dCkgewogICAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZW91dCkKICAgICAgdGhpcy5fdGltZW91dCA9IG51bGwKICAgIH0KCiAgICBjb25zdCBpID0gdGhpcy5faW8uaW5mbGlnaHQuaW5kZXhPZih0aGlzKQogICAgaWYgKGkgPT09IC0xKSByZXR1cm4KCiAgICBpZiAoaSA9PT0gdGhpcy5faW8uaW5mbGlnaHQubGVuZ3RoIC0gMSkgdGhpcy5faW8uaW5mbGlnaHQucG9wKCkKICAgIGVsc2UgdGhpcy5faW8uaW5mbGlnaHRbaV0gPSB0aGlzLl9pby5pbmZsaWdodC5wb3AoKQoKICAgIGlmICh0aGlzLnNlc3Npb24pIHRoaXMuc2Vzc2lvbi5fZGV0YWNoKHRoaXMpCgogICAgdGhpcy5faW8uc3RhdHMucmVxdWVzdHMuYWN0aXZlLS0KICAgIHRoaXMuX2lvLmNvbmdlc3Rpb24ucmVjdigpCgogICAgdGhpcy5vbmVycm9yKGVyciB8fCBSRVFVRVNUX0RFU1RST1lFRCgpLCB0aGlzKQogIH0KCiAgX3NlbmRSZXBseShlcnJvciwgdmFsdWUsIHRva2VuLCBoYXNDbG9zZXJOb2RlcywgZnJvbSwgc29ja2V0KSB7CiAgICBpZiAoc29ja2V0ID09PSBudWxsIHx8IHRoaXMuZGVzdHJveWVkKSByZXR1cm4KCiAgICBjb25zdCBpZCA9IHRoaXMuX2lvLmVwaGVtZXJhbCA9PT0gZmFsc2UgJiYgc29ja2V0ID09PSB0aGlzLl9pby5zZXJ2ZXJTb2NrZXQKICAgIGNvbnN0IGNsb3Nlck5vZGVzID0KICAgICAgdGhpcy50YXJnZXQgIT09IG51bGwgJiYgaGFzQ2xvc2VyTm9kZXMgPyB0aGlzLl9pby50YWJsZS5jbG9zZXN0KHRoaXMudGFyZ2V0KSA6IEVNUFRZX0FSUkFZCiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogMSArIDEgKyA2ICsgMiwgYnVmZmVyOiBudWxsIH0gLy8gKHR5cGUgfCB2ZXJzaW9uKSArIGZsYWdzICsgdG8gKyB0aWQKCiAgICBpZiAoaWQpIHN0YXRlLmVuZCArPSAzMgogICAgaWYgKHRva2VuKSBzdGF0ZS5lbmQgKz0gMzIKICAgIGlmIChjbG9zZXJOb2Rlcy5sZW5ndGggPiAwKSBwZWVyLmlwdjRBcnJheS5wcmVlbmNvZGUoc3RhdGUsIGNsb3Nlck5vZGVzKQogICAgaWYgKGVycm9yID4gMCkgYy51aW50LnByZWVuY29kZShzdGF0ZSwgZXJyb3IpCiAgICBpZiAodmFsdWUpIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdmFsdWUpCgogICAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHN0YXRlLmVuZCkKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IFJFU1BPTlNFX0lECiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPQogICAgICAoaWQgPyAxIDogMCkgfAogICAgICAodG9rZW4gPyAyIDogMCkgfAogICAgICAoY2xvc2VyTm9kZXMubGVuZ3RoID4gMCA/IDQgOiAwKSB8CiAgICAgIChlcnJvciA+IDAgPyA4IDogMCkgfAogICAgICAodmFsdWUgPyAxNiA6IDApCgogICAgYy51aW50MTYuZW5jb2RlKHN0YXRlLCB0aGlzLnRpZCkKICAgIHBlZXIuaXB2NC5lbmNvZGUoc3RhdGUsIGZyb20pCgogICAgaWYgKGlkKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCB0aGlzLl9pby50YWJsZS5pZCkKICAgIGlmICh0b2tlbikgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgdGhpcy5faW8udG9rZW4oZnJvbSwgMSkpCiAgICBpZiAoY2xvc2VyTm9kZXMubGVuZ3RoID4gMCkgcGVlci5pcHY0QXJyYXkuZW5jb2RlKHN0YXRlLCBjbG9zZXJOb2RlcykKICAgIGlmIChlcnJvciA+IDApIGMudWludC5lbmNvZGUoc3RhdGUsIGVycm9yKQogICAgaWYgKHZhbHVlKSBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHZhbHVlKQoKICAgIHNvY2tldC50cnlTZW5kKHN0YXRlLmJ1ZmZlciwgZnJvbS5wb3J0LCBmcm9tLmhvc3QsIHRoaXMudHRsKQogIH0KCiAgX2VuY29kZVJlcXVlc3QodG9rZW4sIHZhbHVlLCB0bywgc29ja2V0KSB7CiAgICBjb25zdCBpZCA9IHRoaXMuX2lvLmVwaGVtZXJhbCA9PT0gZmFsc2UgJiYgc29ja2V0ID09PSB0aGlzLl9pby5zZXJ2ZXJTb2NrZXQKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiAxICsgMSArIDYgKyAyLCBidWZmZXI6IG51bGwgfSAvLyAodHlwZSB8IHZlcnNpb24pICsgZmxhZ3MgKyB0byArIHRpZAoKICAgIGlmIChpZCkgc3RhdGUuZW5kICs9IDMyCiAgICBpZiAodG9rZW4pIHN0YXRlLmVuZCArPSAzMgoKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHRoaXMuY29tbWFuZCkKCiAgICBpZiAodGhpcy50YXJnZXQpIHN0YXRlLmVuZCArPSAzMgogICAgaWYgKHZhbHVlKSBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHZhbHVlKQoKICAgIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShzdGF0ZS5lbmQpCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBSRVFVRVNUX0lECiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPQogICAgICAoaWQgPyAxIDogMCkgfAogICAgICAodG9rZW4gPyAyIDogMCkgfAogICAgICAodGhpcy5pbnRlcm5hbCA/IDQgOiAwKSB8CiAgICAgICh0aGlzLnRhcmdldCA/IDggOiAwKSB8CiAgICAgICh2YWx1ZSA/IDE2IDogMCkKCiAgICBjLnVpbnQxNi5lbmNvZGUoc3RhdGUsIHRoaXMudGlkKQogICAgcGVlci5pcHY0LmVuY29kZShzdGF0ZSwgdG8pCgogICAgaWYgKGlkKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCB0aGlzLl9pby50YWJsZS5pZCkKICAgIGlmICh0b2tlbikgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgdG9rZW4pCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdGhpcy5jb21tYW5kKQoKICAgIGlmICh0aGlzLnRhcmdldCkgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgdGhpcy50YXJnZXQpCiAgICBpZiAodmFsdWUpIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgdmFsdWUpCgogICAgcmV0dXJuIHN0YXRlLmJ1ZmZlcgogIH0KfQoKY2xhc3MgQ29uZ2VzdGlvbldpbmRvdyB7CiAgY29uc3RydWN0b3IobWF4V2luZG93KSB7CiAgICB0aGlzLl9pID0gMAogICAgdGhpcy5fdG90YWwgPSAwCiAgICB0aGlzLl93aW5kb3cgPSBbMCwgMCwgMCwgMF0KICAgIHRoaXMuX21heFdpbmRvdyA9IG1heFdpbmRvdwogIH0KCiAgY2xlYXIoKSB7CiAgICB0aGlzLl9pID0gMAogICAgdGhpcy5fdG90YWwgPSAwCiAgICB0aGlzLl93aW5kb3cgPSBbMCwgMCwgMCwgMF0KICB9CgogIGlzRnVsbCgpIHsKICAgIHJldHVybiB0aGlzLl90b3RhbCA+PSAyICogdGhpcy5fbWF4V2luZG93IHx8IHRoaXMuX3dpbmRvd1t0aGlzLl9pXSA+PSB0aGlzLl9tYXhXaW5kb3cKICB9CgogIHJlY3YoKSB7CiAgICBpZiAodGhpcy5fd2luZG93W3RoaXMuX2ldID4gMCkgewogICAgICB0aGlzLl93aW5kb3dbdGhpcy5faV0tLQogICAgICB0aGlzLl90b3RhbC0tCiAgICB9CiAgfQoKICBzZW5kKCkgewogICAgdGhpcy5fdG90YWwrKwogICAgdGhpcy5fd2luZG93W3RoaXMuX2ldKysKICB9CgogIGRyYWluKCkgewogICAgdGhpcy5faSA9ICh0aGlzLl9pICsgMSkgJiAzCiAgICB0aGlzLl90b3RhbCAtPSB0aGlzLl93aW5kb3dbdGhpcy5faV0KICAgIHRoaXMuX3dpbmRvd1t0aGlzLl9pXSA9IDAgLy8gY2xlYXIgb2xkZXN0CiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIG9uY3ljbGUocmVxKSB7CiAgcmVxLl90aW1lb3V0ID0gbnVsbAogIHJlcS5vbmN5Y2xlKHJlcSkKICBpZiAocmVxLnNlbnQgPj0gcmVxLnJldHJpZXMpIHsKICAgIHJlcS5kZXN0cm95KFJFUVVFU1RfVElNRU9VVCgpKQogICAgcmVxLl9pby5vbnRpbWVvdXQocmVxKQogIH0gZWxzZSB7CiAgICByZXEuc2VuZCgpCiAgfQp9CgpmdW5jdGlvbiBkZWNvZGVSZXBseShmcm9tLCBzdGF0ZSkgewogIHRyeSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCB0aWQgPSBjLnVpbnQxNi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCB0byA9IHBlZXIuaXB2NC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBpZCA9IGZsYWdzICYgMSA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgY29uc3QgdG9rZW4gPSBmbGFncyAmIDIgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIGNvbnN0IGNsb3Nlck5vZGVzID0gZmxhZ3MgJiA0ID8gcGVlci5pcHY0QXJyYXkuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIGNvbnN0IGVycm9yID0gZmxhZ3MgJiA4ID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCiAgICBjb25zdCB2YWx1ZSA9IGZsYWdzICYgMTYgPyBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpIDogbnVsbAoKICAgIGlmIChpZCAhPT0gbnVsbCkgZnJvbS5pZCA9IHZhbGlkYXRlSWQoaWQsIGZyb20pCgogICAgcmV0dXJuIHsgdGlkLCBydHQ6IDAsIGZyb20sIHRvLCB0b2tlbiwgY2xvc2VyTm9kZXMsIGVycm9yLCB2YWx1ZSB9CiAgfSBjYXRjaCB7CiAgICByZXR1cm4gbnVsbAogIH0KfQoKZnVuY3Rpb24gdmFsaWRhdGVJZChpZCwgZnJvbSkgewogIGNvbnN0IGV4cGVjdGVkID0gcGVlci5pZChmcm9tLmhvc3QsIGZyb20ucG9ydCkKICByZXR1cm4gYjRhLmVxdWFscyhleHBlY3RlZCwgaWQpID8gZXhwZWN0ZWQgOiBudWxsCn0KY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgbmV0ID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZy1uZXQnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgaXB2NCA9IHsKICAuLi5uZXQuaXB2NEFkZHJlc3MsCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBpcCA9IG5ldC5pcHY0QWRkcmVzcy5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBpZDogbnVsbCwgLy8gcG9wdWxhdGVkIGJ5IHRoZSBjYWxsZWUKICAgICAgaG9zdDogaXAuaG9zdCwKICAgICAgcG9ydDogaXAucG9ydAogICAgfQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSB7IGlkLCBpcHY0LCBpcHY0QXJyYXk6IGMuYXJyYXkoaXB2NCkgfQoKZnVuY3Rpb24gaWQoaG9zdCwgcG9ydCwgb3V0ID0gYjRhLmFsbG9jVW5zYWZlU2xvdygzMikpIHsKICBjb25zdCBhZGRyID0gb3V0LnN1YmFycmF5KDAsIDYpCiAgaXB2NC5lbmNvZGUoeyBzdGFydDogMCwgZW5kOiA2LCBidWZmZXI6IGFkZHIgfSwgeyBob3N0LCBwb3J0IH0pCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChvdXQsIGFkZHIpCiAgcmV0dXJuIG91dAp9CmNvbnN0IHsgUmVhZGFibGUsIGdldFN0cmVhbUVycm9yIH0gPSByZXF1aXJlKCdzdHJlYW14JykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgcGVlciA9IHJlcXVpcmUoJy4vcGVlcicpCmNvbnN0IHsgRE9XTl9ISU5UIH0gPSByZXF1aXJlKCcuL2NvbW1hbmRzJykKCmNvbnN0IERPTkUgPSBbXQpjb25zdCBET1dOID0gW10KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUXVlcnkgZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3IoZGh0LCB0YXJnZXQsIGludGVybmFsLCBjb21tYW5kLCB2YWx1ZSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgZGh0LnN0YXRzLnF1ZXJpZXMudG90YWwrKwogICAgZGh0LnN0YXRzLnF1ZXJpZXMuYWN0aXZlKysKCiAgICB0aGlzLmZvcmNlID0gISFvcHRzLmZvcmNlCiAgICB0aGlzLmRodCA9IGRodAogICAgdGhpcy5rID0gdGhpcy5kaHQudGFibGUuawogICAgdGhpcy50YXJnZXQgPSB0YXJnZXQKICAgIHRoaXMuaW50ZXJuYWwgPSBpbnRlcm5hbAogICAgdGhpcy5jb21tYW5kID0gY29tbWFuZAogICAgdGhpcy52YWx1ZSA9IHZhbHVlCiAgICB0aGlzLmVycm9ycyA9IDAKICAgIHRoaXMuc3VjY2Vzc2VzID0gMAogICAgdGhpcy5jb25jdXJyZW5jeSA9IG9wdHMuY29uY3VycmVuY3kgfHwgdGhpcy5kaHQuY29uY3VycmVuY3kKICAgIHRoaXMuaW5mbGlnaHQgPSAwCiAgICB0aGlzLm1hcCA9IG9wdHMubWFwIHx8IGRlZmF1bHRNYXAKICAgIHRoaXMucmV0cmllcyA9IG9wdHMucmV0cmllcyA9PT0gMCA/IDAgOiBvcHRzLnJldHJpZXMgfHwgMwogICAgdGhpcy5tYXhTbG93ID0gb3B0cy5tYXhTbG93ID09PSAwID8gMCA6IG9wdHMubWF4U2xvdyB8fCA1CiAgICB0aGlzLmNsb3Nlc3RSZXBsaWVzID0gW10KCiAgICB0aGlzLl9zbG93ID0gMAogICAgdGhpcy5fb25saW5lID0gZmFsc2UKICAgIHRoaXMuX3Nsb3dkb3duID0gZmFsc2UKICAgIHRoaXMuX3NlZW4gPSBuZXcgTWFwKCkKICAgIHRoaXMuX3BlbmRpbmcgPSBbXQogICAgdGhpcy5fZnJvbVRhYmxlID0gZmFsc2UKICAgIHRoaXMuX2NvbW1pdCA9IG9wdHMuY29tbWl0ID09PSB0cnVlID8gYXV0b0NvbW1pdCA6IG9wdHMuY29tbWl0IHx8IG51bGwKICAgIHRoaXMuX2NvbW1pdGluZyA9IGZhbHNlCiAgICB0aGlzLl9zZXNzaW9uID0gb3B0cy5zZXNzaW9uIHx8IGRodC5zZXNzaW9uKCkKICAgIHRoaXMuX2F1dG9EZXN0cm95U2Vzc2lvbiA9ICFvcHRzLnNlc3Npb24KICAgIHRoaXMuX29ubHlDbG9zZXN0Tm9kZXMgPSBmYWxzZQoKICAgIHRoaXMuX29udmlzaXRib3VuZCA9IHRoaXMuX29udmlzaXQuYmluZCh0aGlzKQogICAgdGhpcy5fb25lcnJvcmJvdW5kID0gdGhpcy5fb25lcnJvci5iaW5kKHRoaXMpCiAgICB0aGlzLl9vbmN5Y2xlYm91bmQgPSB0aGlzLl9vbmN5Y2xlLmJpbmQodGhpcykKCiAgICBjb25zdCBub2RlcyA9IG9wdHMubm9kZXMgfHwgb3B0cy5jbG9zZXN0Tm9kZXMKICAgIGNvbnN0IHJlcGxpZXMgPSBvcHRzLnJlcGxpZXMgfHwgb3B0cy5jbG9zZXN0UmVwbGllcwoKICAgIC8vIGFkZCB0aGVtIHJldmVyc2UgYXMgd2UgcG9wIGJlbG93CiAgICBpZiAobm9kZXMpIHsKICAgICAgZm9yIChsZXQgaSA9IG5vZGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IG5vZGVzW2ldCiAgICAgICAgdGhpcy5fYWRkUGVuZGluZygKICAgICAgICAgIHsKICAgICAgICAgICAgaWQ6IG5vZGUuaWQgfHwgcGVlci5pZChub2RlLmhvc3QsIG5vZGUucG9ydCksCiAgICAgICAgICAgIGhvc3Q6IG5vZGUuaG9zdCwKICAgICAgICAgICAgcG9ydDogbm9kZS5wb3J0CiAgICAgICAgICB9LAogICAgICAgICAgbnVsbAogICAgICAgICkKICAgICAgfQogICAgfSBlbHNlIGlmIChyZXBsaWVzKSB7CiAgICAgIGZvciAobGV0IGkgPSByZXBsaWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgdGhpcy5fYWRkUGVuZGluZyhyZXBsaWVzW2ldLmZyb20sIG51bGwpCiAgICAgIH0KICAgIH0KCiAgICBpZiAob3B0cy5vbmx5Q2xvc2VzdE5vZGVzKSB0aGlzLl9vbmx5Q2xvc2VzdE5vZGVzID0gdHJ1ZQogIH0KCiAgZ2V0IGNsb3Nlc3ROb2RlcygpIHsKICAgIGNvbnN0IG5vZGVzID0gbmV3IEFycmF5KHRoaXMuY2xvc2VzdFJlcGxpZXMubGVuZ3RoKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgbm9kZXNbaV0gPSB0aGlzLmNsb3Nlc3RSZXBsaWVzW2ldLmZyb20KICAgIH0KCiAgICByZXR1cm4gbm9kZXMKICB9CgogIGZpbmlzaGVkKCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgaWYgKHRoaXMuZGVzdHJveWVkKSB7CiAgICAgICAgY29uc3QgZXJyb3IgPSBnZXRTdHJlYW1FcnJvcih0aGlzKQogICAgICAgIGlmIChlcnJvcikgcmVqZWN0KGVycm9yKQogICAgICAgIGVsc2UgcmVzb2x2ZSgpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIGNvbnN0IHNlbGYgPSB0aGlzCiAgICAgIGxldCBlcnJvciA9IG51bGwKCiAgICAgIHRoaXMucmVzdW1lKCkKICAgICAgdGhpcy5vbignZXJyb3InLCBvbmVycm9yKQogICAgICB0aGlzLm9uKCdjbG9zZScsIG9uY2xvc2UpCgogICAgICBmdW5jdGlvbiBvbmNsb3NlKCkgewogICAgICAgIHNlbGYucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgb25lcnJvcikKICAgICAgICBzZWxmLnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIG9uY2xvc2UpCiAgICAgICAgaWYgKGVycm9yKSByZWplY3QoZXJyb3IpCiAgICAgICAgZWxzZSByZXNvbHZlKCkKICAgICAgfQoKICAgICAgZnVuY3Rpb24gb25lcnJvcihlcnIpIHsKICAgICAgICBlcnJvciA9IGVycgogICAgICB9CiAgICB9KQogIH0KCiAgX2FkZEZyb21UYWJsZSgpIHsKICAgIGlmICh0aGlzLl9wZW5kaW5nLmxlbmd0aCA+PSB0aGlzLmspIHJldHVybgogICAgdGhpcy5fZnJvbVRhYmxlID0gdHJ1ZQoKICAgIGNvbnN0IGNsb3Nlc3QgPSB0aGlzLmRodC50YWJsZS5jbG9zZXN0KHRoaXMudGFyZ2V0LCB0aGlzLmsgLSB0aGlzLl9wZW5kaW5nLmxlbmd0aCkKCiAgICBmb3IgKGNvbnN0IG5vZGUgb2YgY2xvc2VzdCkgewogICAgICB0aGlzLl9hZGRQZW5kaW5nKHsgaWQ6IG5vZGUuaWQsIGhvc3Q6IG5vZGUuaG9zdCwgcG9ydDogbm9kZS5wb3J0IH0sIG51bGwpCiAgICB9CiAgfQoKICBhc3luYyBfb3BlbihjYikgewogICAgdGhpcy5fYWRkRnJvbVRhYmxlKCkKICAgIGlmICh0aGlzLl9wZW5kaW5nLmxlbmd0aCA+PSB0aGlzLmspIHJldHVybiBjYihudWxsKQoKICAgIGZvciBhd2FpdCAoY29uc3Qgbm9kZSBvZiB0aGlzLmRodC5fcmVzb2x2ZUJvb3RzdHJhcE5vZGVzKCkpIHsKICAgICAgdGhpcy5fYWRkUGVuZGluZyhub2RlLCBudWxsKQogICAgfQoKICAgIGNiKG51bGwpCiAgfQoKICBfaXNDbG9zZXIoaWQpIHsKICAgIHJldHVybiAoCiAgICAgIHRoaXMuY2xvc2VzdFJlcGxpZXMubGVuZ3RoIDwgdGhpcy5rIHx8CiAgICAgIHRoaXMuX2NvbXBhcmUoaWQsIHRoaXMuY2xvc2VzdFJlcGxpZXNbdGhpcy5jbG9zZXN0UmVwbGllcy5sZW5ndGggLSAxXS5mcm9tLmlkKSA8IDAKICAgICkKICB9CgogIF9hZGRQZW5kaW5nKG5vZGUsIHJlZikgewogICAgaWYgKHRoaXMuX29ubHlDbG9zZXN0Tm9kZXMpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGFkZHIgPSBub2RlLmhvc3QgKyAnOicgKyBub2RlLnBvcnQKICAgIGNvbnN0IHJlZnMgPSB0aGlzLl9zZWVuLmdldChhZGRyKQogICAgY29uc3QgaXNDbG9zZXIgPSB0aGlzLl9pc0Nsb3Nlcihub2RlLmlkKQoKICAgIGlmIChyZWZzID09PSBET05FKSB7CiAgICAgIHJldHVybiBpc0Nsb3NlcgogICAgfQoKICAgIGlmIChyZWZzID09PSBET1dOKSB7CiAgICAgIGlmIChyZWYpIHRoaXMuX2Rvd25IaW50KHJlZiwgbm9kZSkKICAgICAgcmV0dXJuIGlzQ2xvc2VyCiAgICB9CgogICAgaWYgKHJlZnMpIHsKICAgICAgaWYgKHJlZiAhPT0gbnVsbCkgcmVmcy5wdXNoKHJlZikKICAgICAgcmV0dXJuIGlzQ2xvc2VyCiAgICB9CgogICAgaWYgKCFpc0Nsb3NlcikgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICB0aGlzLl9zZWVuLnNldChhZGRyLCByZWYgPT09IG51bGwgPyBbXSA6IFtyZWZdKQogICAgdGhpcy5fcGVuZGluZy5wdXNoKG5vZGUpCgogICAgcmV0dXJuIHRydWUKICB9CgogIF9yZWFkKGNiKSB7CiAgICB0aGlzLl9yZWFkTW9yZSgpCiAgICBjYihudWxsKQogIH0KCiAgX3JlYWRNb3JlKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWluZyB8fCB0aGlzLl9jb21taXRpbmcpIHJldHVybgoKICAgIGNvbnN0IGNvbmN1cnJlbmN5ID0gKHRoaXMuX3Nsb3dkb3duID8gMyA6IHRoaXMuY29uY3VycmVuY3kpICsgdGhpcy5fc2xvdwoKICAgIHdoaWxlICh0aGlzLmluZmxpZ2h0IDwgY29uY3VycmVuY3kgJiYgdGhpcy5fcGVuZGluZy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG5leHQgPSB0aGlzLl9wZW5kaW5nLnBvcCgpCiAgICAgIGlmIChuZXh0ICYmIG5leHQuaWQgJiYgIXRoaXMuX2lzQ2xvc2VyKG5leHQuaWQpKSBjb250aW51ZQogICAgICB0aGlzLl92aXNpdChuZXh0KQogICAgfQoKICAgIC8vIGlmIHJldXNpbmcgY2xvc2VzdCBub2Rlcywgc2xvdyBkb3duIGFmdGVyIHRoZSBmaXJzdCByZWFkTW9yZSB0aWNrIHRvIGFsbG93CiAgICAvLyB0aGUgY2xvc2VzdCBub2RlIGEgY2hhbmNlIHRvIHJlcGx5IGJlZm9yZSBnb2luZyBicm9hZCB0byBxdWVzdGlvbiBtb3JlCiAgICBpZiAoIXRoaXMuX2Zyb21UYWJsZSAmJiB0aGlzLnN1Y2Nlc3NlcyA9PT0gMCAmJiB0aGlzLmVycm9ycyA9PT0gMCkgewogICAgICB0aGlzLl9zbG93ZG93biA9IHRydWUKICAgIH0KCiAgICBpZiAodGhpcy5fcGVuZGluZy5sZW5ndGggPiAwKSByZXR1cm4KCiAgICAvLyBpZiBubyBpbmZsaWdodCBPUiBhbGwgdGhlIHF1ZXJpZXMgd2UgYXJlIHdhaXRpbmcgb24gYXJlIG1hcmtlZCBhcyBzbG93ICh3aXRoaW4gb3VyIGxpbWl0cykgYW5kIHdlIGhhdmUgYSBmdWxsIHJlc3VsdC4KICAgIGlmICgKICAgICAgdGhpcy5pbmZsaWdodCA9PT0gMCB8fAogICAgICAodGhpcy5fc2xvdyA8PSB0aGlzLm1heFNsb3cgJiYKICAgICAgICB0aGlzLl9zbG93ID09PSB0aGlzLmluZmxpZ2h0ICYmCiAgICAgICAgdGhpcy5jbG9zZXN0UmVwbGllcy5sZW5ndGggPj0gdGhpcy5rKQogICAgKSB7CiAgICAgIC8vIGlmIG1vcmUgdGhhbiAzLzQgZmFpbGVkIGFuZCB3ZSBvbmx5IHVzZWQgY2FjaGVkIG5vZGVzLCB0cnkgYWdhaW4gZnJvbSB0aGUgcm91dGluZyB0YWJsZQogICAgICBpZiAoIXRoaXMuX2Zyb21UYWJsZSAmJiB0aGlzLnN1Y2Nlc3NlcyA8IHRoaXMuayAvIDQpIHsKICAgICAgICB0aGlzLl9hZGRGcm9tVGFibGUoKQogICAgICAgIHRoaXMuX3JlYWRNb3JlKCkKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgdGhpcy5fZmx1c2goKQogICAgfQogIH0KCiAgX2ZsdXNoKCkgewogICAgaWYgKHRoaXMuX2NvbW1pdGluZykgcmV0dXJuCiAgICB0aGlzLl9jb21taXRpbmcgPSB0cnVlCgogICAgaWYgKHRoaXMuX2NvbW1pdCA9PT0gbnVsbCkgewogICAgICB0aGlzLnB1c2gobnVsbCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgcCA9IFtdCiAgICBmb3IgKGNvbnN0IG0gb2YgdGhpcy5jbG9zZXN0UmVwbGllcykgcC5wdXNoKHRoaXMuX2NvbW1pdChtLCB0aGlzLmRodCwgdGhpcykpCiAgICB0aGlzLl9lbmRBZnRlckNvbW1pdChwKQogIH0KCiAgX2VuZEFmdGVyQ29tbWl0KHBzKSB7CiAgICBpZiAoIXBzLmxlbmd0aCkgewogICAgICB0aGlzLmRlc3Ryb3kobmV3IEVycm9yKCdUb28gZmV3IG5vZGVzIHJlc3BvbmRlZCcpKQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBzZWxmID0gdGhpcwoKICAgIGxldCBwZW5kaW5nID0gcHMubGVuZ3RoCiAgICBsZXQgc3VjY2VzcyA9IDAKCiAgICBmb3IgKGNvbnN0IHAgb2YgcHMpIHAudGhlbihvbmRvbmUsIG9uZXJyb3IpCgogICAgZnVuY3Rpb24gb25kb25lKCkgewogICAgICBzdWNjZXNzKysKICAgICAgaWYgKC0tcGVuZGluZyA9PT0gMCkgc2VsZi5wdXNoKG51bGwpCiAgICB9CgogICAgZnVuY3Rpb24gb25lcnJvcihlcnIpIHsKICAgICAgaWYgKC0tcGVuZGluZyA+IDApIHJldHVybgogICAgICBpZiAoc3VjY2Vzcykgc2VsZi5wdXNoKG51bGwpCiAgICAgIGVsc2Ugc2VsZi5kZXN0cm95KGVycikKICAgIH0KICB9CgogIF9kZWMocmVxKSB7CiAgICBpZiAocmVxLm9uY3ljbGUgPT09IG5vb3ApIHsKICAgICAgdGhpcy5fc2xvdy0tCiAgICB9IGVsc2UgewogICAgICByZXEub25jeWNsZSA9IG5vb3AKICAgIH0KICAgIHRoaXMuaW5mbGlnaHQtLQogIH0KCiAgX29udmlzaXQobSwgcmVxKSB7CiAgICB0aGlzLl9kZWMocmVxKQoKICAgIHRoaXMuX29ubGluZSA9IHRydWUKICAgIGlmICghdGhpcy5kaHQub25saW5lKSB0aGlzLmRodC5fb25saW5lKCkKCiAgICBjb25zdCBhZGRyID0gcmVxLnRvLmhvc3QgKyAnOicgKyByZXEudG8ucG9ydAogICAgdGhpcy5fc2Vlbi5zZXQoYWRkciwgRE9ORSkKCiAgICBpZiAodGhpcy5fY29tbWl0aW5nKSByZXR1cm4KCiAgICBpZiAobS5lcnJvciA9PT0gMCkgdGhpcy5zdWNjZXNzZXMrKwogICAgZWxzZSB0aGlzLmVycm9ycysrCgogICAgaWYgKG0uZXJyb3IgPT09IDAgJiYgbS5mcm9tLmlkICE9PSBudWxsICYmIHRoaXMuX2lzQ2xvc2VyKG0uZnJvbS5pZCkpIHRoaXMuX3B1c2hDbG9zZXN0KG0pCgogICAgaWYgKG0uY2xvc2VyTm9kZXMgIT09IG51bGwpIHsKICAgICAgZm9yIChjb25zdCBub2RlIG9mIG0uY2xvc2VyTm9kZXMpIHsKICAgICAgICBub2RlLmlkID0gcGVlci5pZChub2RlLmhvc3QsIG5vZGUucG9ydCkKICAgICAgICBpZiAodGhpcy5kaHQuX2ZpbHRlck5vZGUgIT09IG51bGwgJiYgIXRoaXMuZGh0Ll9maWx0ZXJOb2RlKG5vZGUpKSBjb250aW51ZQogICAgICAgIGlmIChiNGEuZXF1YWxzKG5vZGUuaWQsIHRoaXMuZGh0LnRhYmxlLmlkKSkgY29udGludWUKICAgICAgICAvLyBUT0RPOiB3ZSBjb3VsZCBjb250aW51ZSBoZXJlIGluc3RlYWQgb2YgYnJlYWtpbmcgdG8gZW5zdXJlIHRoYXQgb25lIG9mIHRoZSBub2RlcyBpbiB0aGUgY2xvc2VyIGxpc3QKICAgICAgICAvLyBpcyBsYXRlciBtYXJrZWQgYXMgRE9XTiB0aGF0IHdlIGdvc3NpcCB0aGF0IGJhY2sKICAgICAgICBpZiAoIXRoaXMuX2FkZFBlbmRpbmcobm9kZSwgbS5mcm9tKSkgYnJlYWsKICAgICAgfQogICAgfQoKICAgIGlmICghdGhpcy5fZnJvbVRhYmxlICYmIHRoaXMuc3VjY2Vzc2VzICsgdGhpcy5lcnJvcnMgPj0gdGhpcy5jb25jdXJyZW5jeSkgewogICAgICB0aGlzLl9zbG93ZG93biA9IGZhbHNlCiAgICB9CgogICAgaWYgKG0uZXJyb3IgIT09IDApIHsKICAgICAgdGhpcy5fcmVhZE1vcmUoKQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBkYXRhID0gdGhpcy5tYXAobSkKICAgIGlmICghZGF0YSB8fCB0aGlzLnB1c2goZGF0YSkgIT09IGZhbHNlKSB7CiAgICAgIHRoaXMuX3JlYWRNb3JlKCkKICAgIH0KICB9CgogIF9vbmVycm9yKGVyciwgcmVxKSB7CiAgICBjb25zdCBhZGRyID0gcmVxLnRvLmhvc3QgKyAnOicgKyByZXEudG8ucG9ydAogICAgY29uc3QgcmVmcyA9IHRoaXMuX3NlZW4uZ2V0KGFkZHIpCgogICAgaWYgKGVyci5jb2RlID09PSAnUkVRVUVTVF9USU1FT1VUJykgewogICAgICB0aGlzLl9zZWVuLnNldChhZGRyLCBET1dOKQogICAgICBmb3IgKGNvbnN0IG5vZGUgb2YgcmVmcykgdGhpcy5fZG93bkhpbnQobm9kZSwgcmVxLnRvKQogICAgfQoKICAgIHRoaXMuX2RlYyhyZXEpCiAgICB0aGlzLmVycm9ycysrCiAgICB0aGlzLl9yZWFkTW9yZSgpCiAgfQoKICBfb25jeWNsZShyZXEpIHsKICAgIHJlcS5vbmN5Y2xlID0gbm9vcAogICAgdGhpcy5fc2xvdysrCiAgICB0aGlzLl9yZWFkTW9yZSgpCiAgfQoKICBfZG93bkhpbnQobm9kZSwgZG93bikgewogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDYsIGJ1ZmZlcjogYjRhLmFsbG9jVW5zYWZlKDYpIH0KICAgIHBlZXIuaXB2NC5lbmNvZGUoc3RhdGUsIGRvd24pCiAgICB0aGlzLmRodC5fcmVxdWVzdChub2RlLCBmYWxzZSwgdHJ1ZSwgRE9XTl9ISU5ULCBudWxsLCBzdGF0ZS5idWZmZXIsIHRoaXMuX3Nlc3Npb24sIG5vb3AsIG5vb3ApCiAgfQoKICBfcHVzaENsb3Nlc3QobSkgewogICAgdGhpcy5jbG9zZXN0UmVwbGllcy5wdXNoKG0pCiAgICBmb3IgKGxldCBpID0gdGhpcy5jbG9zZXN0UmVwbGllcy5sZW5ndGggLSAyOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBwcmV2ID0gdGhpcy5jbG9zZXN0UmVwbGllc1tpXQogICAgICBjb25zdCBjbXAgPSB0aGlzLl9jb21wYXJlKHByZXYuZnJvbS5pZCwgbS5mcm9tLmlkKQogICAgICAvLyBpZiBzb3J0ZWQsIGRvbmUhCiAgICAgIGlmIChjbXAgPCAwKSBicmVhawogICAgICAvLyBpZiBkdXAsIHNwbGljZSBpdCBvdXQgKHJhcmUpCiAgICAgIGlmIChjbXAgPT09IDApIHsKICAgICAgICB0aGlzLmNsb3Nlc3RSZXBsaWVzLnNwbGljZShpICsgMSwgMSkKICAgICAgICBicmVhawogICAgICB9CiAgICAgIC8vIHN3YXAgYW5kIGNvbnRpbnVlIGRvd24KICAgICAgdGhpcy5jbG9zZXN0UmVwbGllc1tpICsgMV0gPSBwcmV2CiAgICAgIHRoaXMuY2xvc2VzdFJlcGxpZXNbaV0gPSBtCiAgICB9CiAgICBpZiAodGhpcy5jbG9zZXN0UmVwbGllcy5sZW5ndGggPiB0aGlzLmspIHRoaXMuY2xvc2VzdFJlcGxpZXMucG9wKCkKICB9CgogIF9jb21wYXJlKGEsIGIpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkrKykgewogICAgICBpZiAoYVtpXSA9PT0gYltpXSkgY29udGludWUKICAgICAgY29uc3QgdCA9IHRoaXMudGFyZ2V0W2ldCiAgICAgIHJldHVybiAodCBeIGFbaV0pIC0gKHQgXiBiW2ldKQogICAgfQogICAgcmV0dXJuIDAKICB9CgogIF92aXNpdCh0bykgewogICAgdGhpcy5pbmZsaWdodCsrCgogICAgY29uc3QgcmVxID0gdGhpcy5kaHQuX3JlcXVlc3QoCiAgICAgIHRvLAogICAgICB0aGlzLmZvcmNlLAogICAgICB0aGlzLmludGVybmFsLAogICAgICB0aGlzLmNvbW1hbmQsCiAgICAgIHRoaXMudGFyZ2V0LAogICAgICB0aGlzLnZhbHVlLAogICAgICB0aGlzLl9zZXNzaW9uLAogICAgICB0aGlzLl9vbnZpc2l0Ym91bmQsCiAgICAgIHRoaXMuX29uZXJyb3Jib3VuZAogICAgKQogICAgaWYgKHJlcSA9PT0gbnVsbCkgewogICAgICB0aGlzLmRlc3Ryb3kobmV3IEVycm9yKCdOb2RlIHdhcyBkZXN0cm95ZWQnKSkKICAgICAgcmV0dXJuCiAgICB9CiAgICByZXEucmV0cmllcyA9IHRoaXMucmV0cmllcwogICAgcmVxLm9uY3ljbGUgPSB0aGlzLl9vbmN5Y2xlYm91bmQKICAgIGlmICh0aGlzLmZvcmNlKSByZXEucmV0cmllcyA9IDAKICB9CgogIF9kZXN0cm95KGNiKSB7CiAgICB0aGlzLmRodC5zdGF0cy5xdWVyaWVzLmFjdGl2ZS0tCiAgICBpZiAoIXRoaXMuX29ubGluZSAmJiB0aGlzLmRodC5vbmxpbmUpIHRoaXMuZGh0Ll9vZmZsaW5lKCkKICAgIGlmICh0aGlzLl9hdXRvRGVzdHJveVNlc3Npb24pIHRoaXMuX3Nlc3Npb24uZGVzdHJveSgpCiAgICBjYihudWxsKQogIH0KfQoKZnVuY3Rpb24gYXV0b0NvbW1pdChyZXBseSwgZGh0LCBxdWVyeSkgewogIGlmICghcmVwbHkudG9rZW4pIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ05vIHRva2VuIHJlY2VpdmVkIGZvciBjbG9zZXN0IG5vZGUnKSkKICByZXR1cm4gZGh0LnJlcXVlc3QoCiAgICB7CiAgICAgIHRva2VuOiByZXBseS50b2tlbiwKICAgICAgdGFyZ2V0OiBxdWVyeS50YXJnZXQsCiAgICAgIGNvbW1hbmQ6IHF1ZXJ5LmNvbW1hbmQsCiAgICAgIHZhbHVlOiBxdWVyeS52YWx1ZQogICAgfSwKICAgIHJlcGx5LmZyb20KICApCn0KCmZ1bmN0aW9uIGRlZmF1bHRNYXAobSkgewogIHJldHVybiBtCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFNlc3Npb24gewogIGNvbnN0cnVjdG9yKGRodCkgewogICAgdGhpcy5kaHQgPSBkaHQKICAgIHRoaXMuaW5mbGlnaHQgPSBbXQogIH0KCiAgX2F0dGFjaChyZXEpIHsKICAgIHJlcS5pbmRleCA9IHRoaXMuaW5mbGlnaHQucHVzaChyZXEpIC0gMQogIH0KCiAgX2RldGFjaChyZXEpIHsKICAgIGNvbnN0IGkgPSByZXEuaW5kZXgKICAgIGlmIChpID09PSAtMSkgcmV0dXJuCiAgICByZXEuaW5kZXggPSAtMQoKICAgIGlmIChpID09PSB0aGlzLmluZmxpZ2h0Lmxlbmd0aCAtIDEpIHRoaXMuaW5mbGlnaHQucG9wKCkKICAgIGVsc2UgewogICAgICBjb25zdCByZXEgPSAodGhpcy5pbmZsaWdodFtpXSA9IHRoaXMuaW5mbGlnaHQucG9wKCkpCiAgICAgIHJlcS5pbmRleCA9IGkKICAgIH0KICB9CgogIHF1ZXJ5KHsgdGFyZ2V0LCBjb21tYW5kLCB2YWx1ZSB9LCBvcHRzID0ge30pIHsKICAgIHJldHVybiB0aGlzLmRodC5xdWVyeSh7IHRhcmdldCwgY29tbWFuZCwgdmFsdWUgfSwgeyAuLi5vcHRzLCBzZXNzaW9uOiB0aGlzIH0pCiAgfQoKICByZXF1ZXN0KHsgdG9rZW4sIGNvbW1hbmQsIHRhcmdldCwgdmFsdWUgfSwgeyBob3N0LCBwb3J0IH0sIG9wdHMgPSB7fSkgewogICAgcmV0dXJuIHRoaXMuZGh0LnJlcXVlc3QoCiAgICAgIHsgdG9rZW4sIGNvbW1hbmQsIHRhcmdldCwgdmFsdWUgfSwKICAgICAgeyBob3N0LCBwb3J0IH0sCiAgICAgIHsgLi4ub3B0cywgc2Vzc2lvbjogdGhpcyB9CiAgICApCiAgfQoKICBwaW5nKHsgaG9zdCwgcG9ydCB9LCBvcHRzID0ge30pIHsKICAgIHJldHVybiB0aGlzLmRodC5waW5nKHsgaG9zdCwgcG9ydCB9LCB7IC4uLm9wdHMsIHNlc3Npb246IHRoaXMgfSkKICB9CgogIGRlc3Ryb3koZXJyKSB7CiAgICB3aGlsZSAodGhpcy5pbmZsaWdodC5sZW5ndGgpIHsKICAgICAgY29uc3QgcmVxID0gdGhpcy5pbmZsaWdodFswXQogICAgICAvLyBwcmV2ZW50IGRlc3Ryb3llZCByZXF1ZXN0cyBmcm9tIGNvbnRyaWJ1dGluZyB0byBjb25nZXN0aW9uIGNvdW50cwogICAgICB0aGlzLmRodC5pby5jb25nZXN0aW9uLnJlY3YoKQogICAgICByZXEuZGVzdHJveShlcnIpCiAgICB9CiAgfQp9CnsKICAibmFtZSI6ICJkaHQtcnBjIiwKICAidmVyc2lvbiI6ICI2LjIwLjIiLAogICJkZXNjcmlwdGlvbiI6ICJNYWtlIFJQQyBjYWxscyBvdmVyIGEgS2FkZW1saWEgYmFzZWQgREhUIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJsaWIvKi5qcyIKICBdLAogICJpbXBvcnRzIjogewogICAgImV2ZW50cyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1ldmVudHMiLAogICAgICAiZGVmYXVsdCI6ICJldmVudHMiCiAgICB9CiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjEiLAogICAgImJhcmUtZXZlbnRzIjogIl4yLjIuMCIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xMS4wIiwKICAgICJjb21wYWN0LWVuY29kaW5nLW5ldCI6ICJeMS4yLjAiLAogICAgImZhc3QtZmlmbyI6ICJeMS4xLjAiLAogICAgImthZGVtbGlhLXJvdXRpbmctdGFibGUiOiAiXjEuMC4xIiwKICAgICJuYXQtc2FtcGxlciI6ICJeMS4wLjEiLAogICAgInNvZGl1bS11bml2ZXJzYWwiOiAiXjUuMC4wIiwKICAgICJzdHJlYW14IjogIl4yLjEzLjIiLAogICAgInRpbWUtb3JkZXJlZC1zZXQiOiAiXjIuMC4wIiwKICAgICJ1ZHgtbmF0aXZlIjogIl4xLjUuMyIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4wLjAiLAogICAgImx1bnRlIjogIl4xLjMuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIsCiAgICAidGVzdC1zdXNwZW5kIjogIl4xLjAuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgInRlc3QiOiAibnBtIHJ1biB0ZXN0Om5vZGUgJiYgbnBtIHJ1biB0ZXN0OmJhcmUiLAogICAgInRlc3Q6YmFyZSI6ICJicml0dGxlLWJhcmUgLS1jb3ZlcmFnZSB0ZXN0LmpzIiwKICAgICJsaW50IjogInByZXR0aWVyIC0tY2hlY2sgLiAmJiBsdW50ZSIsCiAgICAidGVzdDpub2RlIjogImJyaXR0bGUtbm9kZSAtLWNvdmVyYWdlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvZGh0LXJwYy5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvZGh0LXJwYy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9kaHQtcnBjIgp9Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnYmFyZS1ldmVudHMnKQp7CiAgIm5hbWUiOiAiZXZlbnRzLXVuaXZlcnNhbCIsCiAgInZlcnNpb24iOiAiMS4wLjEiLAogICJkZXNjcmlwdGlvbiI6ICJVbml2ZXJzYWwgd3JhcHBlciBmb3IgdGhlIE5vZGUuanMgZXZlbnRzIG1vZHVsZSIsCiAgImV4cG9ydHMiOiB7CiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuIjogewogICAgICAiYmFyZSI6ICIuL2JhcmUuanMiLAogICAgICAicmVhY3QtbmF0aXZlIjogIi4vcmVhY3QtbmF0aXZlLmpzIiwKICAgICAgImRlZmF1bHQiOiAiLi9kZWZhdWx0LmpzIgogICAgfQogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJkZWZhdWx0LmpzIiwKICAgICJiYXJlLmpzIiwKICAgICJyZWFjdC1uYXRpdmUuanMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9ldmVudHMtdW5pdmVyc2FsLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2V2ZW50cy11bml2ZXJzYWwvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9ldmVudHMtdW5pdmVyc2FsI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWV2ZW50cyI6ICJeMi43LjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInByZXR0aWVyIjogIl4zLjQuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMS4wLjAiCiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgRml4ZWRGSUZPIHsKICBjb25zdHJ1Y3RvciAoaHdtKSB7CiAgICBpZiAoIShod20gPiAwKSB8fCAoKGh3bSAtIDEpICYgaHdtKSAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdNYXggc2l6ZSBmb3IgYSBGaXhlZEZJRk8gc2hvdWxkIGJlIGEgcG93ZXIgb2YgdHdvJykKICAgIHRoaXMuYnVmZmVyID0gbmV3IEFycmF5KGh3bSkKICAgIHRoaXMubWFzayA9IGh3bSAtIDEKICAgIHRoaXMudG9wID0gMAogICAgdGhpcy5idG0gPSAwCiAgICB0aGlzLm5leHQgPSBudWxsCiAgfQoKICBjbGVhciAoKSB7CiAgICB0aGlzLnRvcCA9IHRoaXMuYnRtID0gMAogICAgdGhpcy5uZXh0ID0gbnVsbAogICAgdGhpcy5idWZmZXIuZmlsbCh1bmRlZmluZWQpCiAgfQoKICBwdXNoIChkYXRhKSB7CiAgICBpZiAodGhpcy5idWZmZXJbdGhpcy50b3BdICE9PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZQogICAgdGhpcy5idWZmZXJbdGhpcy50b3BdID0gZGF0YQogICAgdGhpcy50b3AgPSAodGhpcy50b3AgKyAxKSAmIHRoaXMubWFzawogICAgcmV0dXJuIHRydWUKICB9CgogIHNoaWZ0ICgpIHsKICAgIGNvbnN0IGxhc3QgPSB0aGlzLmJ1ZmZlclt0aGlzLmJ0bV0KICAgIGlmIChsYXN0ID09PSB1bmRlZmluZWQpIHJldHVybiB1bmRlZmluZWQKICAgIHRoaXMuYnVmZmVyW3RoaXMuYnRtXSA9IHVuZGVmaW5lZAogICAgdGhpcy5idG0gPSAodGhpcy5idG0gKyAxKSAmIHRoaXMubWFzawogICAgcmV0dXJuIGxhc3QKICB9CgogIHBlZWsgKCkgewogICAgcmV0dXJuIHRoaXMuYnVmZmVyW3RoaXMuYnRtXQogIH0KCiAgaXNFbXB0eSAoKSB7CiAgICByZXR1cm4gdGhpcy5idWZmZXJbdGhpcy5idG1dID09PSB1bmRlZmluZWQKICB9Cn0KY29uc3QgRml4ZWRGSUZPID0gcmVxdWlyZSgnLi9maXhlZC1zaXplJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgRmFzdEZJRk8gewogIGNvbnN0cnVjdG9yIChod20pIHsKICAgIHRoaXMuaHdtID0gaHdtIHx8IDE2CiAgICB0aGlzLmhlYWQgPSBuZXcgRml4ZWRGSUZPKHRoaXMuaHdtKQogICAgdGhpcy50YWlsID0gdGhpcy5oZWFkCiAgICB0aGlzLmxlbmd0aCA9IDAKICB9CgogIGNsZWFyICgpIHsKICAgIHRoaXMuaGVhZCA9IHRoaXMudGFpbAogICAgdGhpcy5oZWFkLmNsZWFyKCkKICAgIHRoaXMubGVuZ3RoID0gMAogIH0KCiAgcHVzaCAodmFsKSB7CiAgICB0aGlzLmxlbmd0aCsrCiAgICBpZiAoIXRoaXMuaGVhZC5wdXNoKHZhbCkpIHsKICAgICAgY29uc3QgcHJldiA9IHRoaXMuaGVhZAogICAgICB0aGlzLmhlYWQgPSBwcmV2Lm5leHQgPSBuZXcgRml4ZWRGSUZPKDIgKiB0aGlzLmhlYWQuYnVmZmVyLmxlbmd0aCkKICAgICAgdGhpcy5oZWFkLnB1c2godmFsKQogICAgfQogIH0KCiAgc2hpZnQgKCkgewogICAgaWYgKHRoaXMubGVuZ3RoICE9PSAwKSB0aGlzLmxlbmd0aC0tCiAgICBjb25zdCB2YWwgPSB0aGlzLnRhaWwuc2hpZnQoKQogICAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkICYmIHRoaXMudGFpbC5uZXh0KSB7CiAgICAgIGNvbnN0IG5leHQgPSB0aGlzLnRhaWwubmV4dAogICAgICB0aGlzLnRhaWwubmV4dCA9IG51bGwKICAgICAgdGhpcy50YWlsID0gbmV4dAogICAgICByZXR1cm4gdGhpcy50YWlsLnNoaWZ0KCkKICAgIH0KCiAgICByZXR1cm4gdmFsCiAgfQoKICBwZWVrICgpIHsKICAgIGNvbnN0IHZhbCA9IHRoaXMudGFpbC5wZWVrKCkKICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCAmJiB0aGlzLnRhaWwubmV4dCkgcmV0dXJuIHRoaXMudGFpbC5uZXh0LnBlZWsoKQogICAgcmV0dXJuIHZhbAogIH0KCiAgaXNFbXB0eSAoKSB7CiAgICByZXR1cm4gdGhpcy5sZW5ndGggPT09IDAKICB9Cn0KewogICJuYW1lIjogImZhc3QtZmlmbyIsCiAgInZlcnNpb24iOiAiMS4zLjIiLAogICJkZXNjcmlwdGlvbiI6ICJBIGZhc3QgZmlmbyBpbXBsZW1lbnRhdGlvbiBzaW1pbGFyIHRvIHRoZSBvbmUgcG93ZXJpbmcgbmV4dFRpY2sgaW4gTm9kZS5qcyBjb3JlIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgIi4vaW5kZXguanMiLAogICAgIi4vZml4ZWQtc2l6ZS5qcyIKICBdLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xNy4xLjAiLAogICAgImJyaXR0bGUiOiAiXjMuMy4yIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvZmFzdC1maWZvLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9mYXN0LWZpZm8vaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvZmFzdC1maWZvIgp9CmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKQpjb25zdCBmc3ggPSByZXF1aXJlKCdmcy1uYXRpdmUtZXh0ZW5zaW9ucycpCmNvbnN0IG9uZXhpdCA9IHJlcXVpcmUoJ3Jlc291cmNlLW9uLWV4aXQnKQpjb25zdCBSZWFkeVJlc291cmNlID0gcmVxdWlyZSgncmVhZHktcmVzb3VyY2UnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBGRExvY2sgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvcihmZCwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IHdhaXQgPSBmYWxzZSB9ID0gb3B0cwoKICAgIHN1cGVyKCkKCiAgICB0aGlzLl9mZCA9IGZkCiAgICB0aGlzLl93YWl0ID0gd2FpdAogICAgdGhpcy5fbG9ja2VkID0gZmFsc2UKCiAgICBvbmV4aXQuYWRkKHRoaXMsIGNsb3NlU3luYykKICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fcmVzdW1lKCkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBvbmV4aXQucmVtb3ZlKHRoaXMpCiAgICAgIGF3YWl0IGNsb3NlKHRoaXMpCiAgICAgIHRocm93IGVycgogICAgfQogIH0KCiAgYXN5bmMgX2Nsb3NlKCkgewogICAgb25leGl0LnJlbW92ZSh0aGlzKQogICAgYXdhaXQgY2xvc2UodGhpcykKICB9CgogIHRyYW5zZmVyKCkgewogICAgY29uc3QgZmQgPSB0aGlzLl9mZAogICAgaWYgKGZkID09PSAtMSkgdGhyb3cgbmV3IEVycm9yKCdMb2NrIGhhcyBhbHJlYWR5IGJlZW4gdHJhbnNmZXJyZWQnKQogICAgdGhpcy5fZmQgPSAtMQogICAgb25leGl0LnJlbW92ZSh0aGlzKQogICAgcmV0dXJuIGZkCiAgfQoKICBhc3luYyBzdXNwZW5kKCkgewogICAgaWYgKCF0aGlzLm9wZW5lZCkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICByZXR1cm4gdGhpcy5fc3VzcGVuZCgpCiAgfQoKICBhc3luYyBfc3VzcGVuZCgpIHsKICAgIGlmICh0aGlzLl9mZCA9PT0gLTEgfHwgdGhpcy5fbG9ja2VkID09PSBmYWxzZSkgcmV0dXJuCiAgICBmc3gudW5sb2NrKHRoaXMuX2ZkKQogICAgdGhpcy5fbG9ja2VkID0gZmFsc2UKICB9CgogIGFzeW5jIHJlc3VtZSgpIHsKICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgcmV0dXJuIHRoaXMuX3Jlc3VtZSgpCiAgfQoKICBhc3luYyBfcmVzdW1lKCkgewogICAgaWYgKHRoaXMuX2ZkID09PSAtMSB8fCB0aGlzLl9sb2NrZWQgPT09IHRydWUpIHJldHVybgogICAgaWYgKHRoaXMuX3dhaXQpIGF3YWl0IGZzeC53YWl0Rm9yTG9jayh0aGlzLl9mZCkKICAgIGVsc2UgaWYgKCFmc3gudHJ5TG9jayh0aGlzLl9mZCkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdGaWxlIGRlc2NyaXB0b3IgY291bGQgbm90IGJlIGxvY2tlZCcpCiAgICB9CiAgICB0aGlzLl9sb2NrZWQgPSB0cnVlCiAgfQp9CgpmdW5jdGlvbiBjbG9zZShsb2NrKSB7CiAgY29uc3QgZmQgPSBsb2NrLl9mZAogIGlmIChmZCA9PT0gLTEpIHJldHVybgogIGxvY2suX2ZkID0gLTEKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IGZzLmNsb3NlKGZkLCAoKSA9PiByZXNvbHZlKCkpKQp9CgpmdW5jdGlvbiBjbG9zZVN5bmMobG9jaykgewogIGNvbnN0IGZkID0gbG9jay5fZmQKICBpZiAoZmQgPT09IC0xKSByZXR1cm4KICBsb2NrLl9mZCA9IC0xCiAgdHJ5IHsKICAgIGZzLmNsb3NlU3luYyhmZCkKICB9IGNhdGNoIHt9Cn0KewogICJuYW1lIjogImZkLWxvY2siLAogICJ2ZXJzaW9uIjogIjIuMS4xIiwKICAiZGVzY3JpcHRpb24iOiAiU3RhdGVmdWwgZmlsZSBkZXNjcmlwdG9yIGxvY2tzIGZvciBKYXZhU2NyaXB0IiwKICAiZXhwb3J0cyI6IHsKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4iOiAiLi9pbmRleC5qcyIKICB9LAogICJpbXBvcnRzIjogewogICAgImZzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWZzIiwKICAgICAgImRlZmF1bHQiOiAiZnMiCiAgICB9CiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogIm5wbSBydW4gbGludCAmJiBucG0gcnVuIHRlc3Q6YmFyZSAmJiBucG0gcnVuIHRlc3Q6bm9kZSIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC5qcyIsCiAgICAidGVzdDpub2RlIjogIm5vZGUgdGVzdC5qcyIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4iLAogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vZmQtbG9jay5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9mZC1sb2NrL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vZmQtbG9jayNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1mcyI6ICJeNC41LjAiLAogICAgImZzLW5hdGl2ZS1leHRlbnNpb25zIjogIl4xLjQuNCIsCiAgICAicmVhZHktcmVzb3VyY2UiOiAiXjEuMi4wIiwKICAgICJyZXNvdXJjZS1vbi1leGl0IjogIl4xLjAuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4zLjIiLAogICAgInByZXR0aWVyIjogIl4zLjQuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiCiAgfQp9CmV4cG9ydHMuZnVsbFJvb3RzID0gZnVuY3Rpb24gKGluZGV4LCByZXN1bHQpIHsKICBpZiAoaW5kZXggJiAxKSB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBjYW4gb25seSBsb29rIHVwIHJvb3RzIGZvciBkZXB0aCgwKSBibG9ja3MnKQogIGlmICghcmVzdWx0KSByZXN1bHQgPSBbXQoKICBpbmRleCAvPSAyCgogIGxldCBvZmZzZXQgPSAwCiAgbGV0IGZhY3RvciA9IDEKCiAgd2hpbGUgKHRydWUpIHsKICAgIGlmICghaW5kZXgpIHJldHVybiByZXN1bHQKICAgIHdoaWxlIChmYWN0b3IgKiAyIDw9IGluZGV4KSBmYWN0b3IgKj0gMgogICAgcmVzdWx0LnB1c2gob2Zmc2V0ICsgZmFjdG9yIC0gMSkKICAgIG9mZnNldCA9IG9mZnNldCArIDIgKiBmYWN0b3IKICAgIGluZGV4IC09IGZhY3RvcgogICAgZmFjdG9yID0gMQogIH0KfQoKZXhwb3J0cy5mdXR1cmVSb290cyA9IGZ1bmN0aW9uIChpbmRleCwgcmVzdWx0KSB7CiAgaWYgKGluZGV4ICYgMSkgdGhyb3cgbmV3IEVycm9yKCdZb3UgY2FuIG9ubHkgbG9vayB1cCBmdXR1cmUgcm9vdHMgZm9yIGRlcHRoKDApIGJsb2NrcycpCiAgaWYgKCFyZXN1bHQpIHJlc3VsdCA9IFtdCgogIGxldCBmYWN0b3IgPSAxCgogIC8vIG1ha2UgZmlyc3Qgcm9vdAogIHdoaWxlIChmYWN0b3IgKiAyIDw9IGluZGV4KSBmYWN0b3IgKj0gMgoKICAvLyBmdWxsIGZhY3RvciBvZiAyIC0gZG9uZQogIGlmIChmYWN0b3IgKiAyIC0gMiA9PT0gaW5kZXgpIHJldHVybiByZXN1bHQKCiAgbGV0IHBvcyA9IGZhY3RvciAvIDIgLSAxCgogIC8vIHdoaWxlIGl0cyBub3QgYSBmdWxsIHRyZWUKICB3aGlsZSAoKHBvcyArIGZhY3RvciAvIDIgLSAxKSAhPT0gaW5kZXgpIHsKICAgIHBvcyArPSBmYWN0b3IKCiAgICAvLyByZWFkIHRvbyBmYXIsIHRvIHRvIGxlZnQgY2hpbGQKICAgIHdoaWxlICgocG9zICsgZmFjdG9yIC8gMiAtIDEpID4gaW5kZXgpIHsKICAgICAgZmFjdG9yIC89IDIKICAgICAgcG9zIC09IGZhY3RvciAvIDIKICAgIH0KCiAgICAvLyB0aGUgImdhcCIgaXMgYSBmdXR1cmUgcm9vdAogICAgcmVzdWx0LnB1c2gocG9zIC0gZmFjdG9yIC8gMikKICB9CgogIHJldHVybiByZXN1bHQKfQoKZXhwb3J0cy5wYXRjaCA9IGZ1bmN0aW9uIChmcm9tLCB0bykgewogIGlmIChmcm9tID09PSAwIHx8IGZyb20gPj0gdG8pIHJldHVybiBbXQoKICBjb25zdCByb290cyA9IGV4cG9ydHMuZnVsbFJvb3RzKGZyb20pCiAgY29uc3QgdGFyZ2V0ID0gZXhwb3J0cy5mdWxsUm9vdHModG8pCgogIC8vIGZpcnN0IGZpbmQgdGhlIGZpcnN0IHJvb3QgdGhhdCBpcyBkaWZmZXJlbnQKCiAgbGV0IGkgPSAwCiAgZm9yICg7IGkgPCB0YXJnZXQubGVuZ3RoOyBpKyspIHsKICAgIGlmIChpID49IHJvb3RzLmxlbmd0aCB8fCByb290c1tpXSAhPT0gdGFyZ2V0W2ldKSBicmVhawogIH0KCiAgY29uc3QgcGF0Y2ggPSBbXQoKICBpZiAoaSA8IHJvb3RzLmxlbmd0aCkgewogICAgLy8gbm93IHdlIG5lZWQgdG8gZ3JvdyB0aGUgbmV3ZXN0IHJvb3QgdW50aWwgaXQgaGl0cyB0aGUgZGlmZiBvbmUKICAgIGxldCBwcmV2ID0gcm9vdHMubGVuZ3RoIC0gMQoKICAgIGNvbnN0IGl0ZSA9IGV4cG9ydHMuaXRlcmF0b3Iocm9vdHNbcHJldi0tXSkKCiAgICB3aGlsZSAoaXRlLmluZGV4ICE9PSB0YXJnZXRbaV0pIHsKICAgICAgaXRlLnNpYmxpbmcoKQoKICAgICAgaWYgKHByZXYgPj0gMCAmJiBpdGUuaW5kZXggPT09IHJvb3RzW3ByZXZdKSB7CiAgICAgICAgcHJldi0tCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGF0Y2gucHVzaChpdGUuaW5kZXgpCiAgICAgIH0KCiAgICAgIHBhdGNoLnB1c2goaXRlLnBhcmVudCgpKQogICAgfQoKICAgIGkrKyAvLyBwYXRjaGVkIHRvIG5leHQgcm9vdCwgc28gaW5jCiAgfQoKICAvLyBpbmNsdWRlIHRoZSByZXN0CgogIGZvciAoOyBpIDwgdGFyZ2V0Lmxlbmd0aDsgaSsrKSBwYXRjaC5wdXNoKHRhcmdldFtpXSkKCiAgcmV0dXJuIHBhdGNoCn0KCmV4cG9ydHMuZGVwdGggPSBmdW5jdGlvbiAoaW5kZXgpIHsKICBsZXQgZGVwdGggPSAwCgogIGluZGV4ICs9IDEKICB3aGlsZSAoIShpbmRleCAmIDEpKSB7CiAgICBkZXB0aCsrCiAgICBpbmRleCA9IHJpZ2h0U2hpZnQoaW5kZXgpCiAgfQoKICByZXR1cm4gZGVwdGgKfQoKZXhwb3J0cy5zaWJsaW5nID0gZnVuY3Rpb24gKGluZGV4LCBkZXB0aCkgewogIGlmICghZGVwdGgpIGRlcHRoID0gZXhwb3J0cy5kZXB0aChpbmRleCkKICBjb25zdCBvZmZzZXQgPSBleHBvcnRzLm9mZnNldChpbmRleCwgZGVwdGgpCgogIHJldHVybiBleHBvcnRzLmluZGV4KGRlcHRoLCBvZmZzZXQgJiAxID8gb2Zmc2V0IC0gMSA6IG9mZnNldCArIDEpCn0KCmV4cG9ydHMucGFyZW50ID0gZnVuY3Rpb24gKGluZGV4LCBkZXB0aCkgewogIGlmICghZGVwdGgpIGRlcHRoID0gZXhwb3J0cy5kZXB0aChpbmRleCkKICBjb25zdCBvZmZzZXQgPSBleHBvcnRzLm9mZnNldChpbmRleCwgZGVwdGgpCgogIHJldHVybiBleHBvcnRzLmluZGV4KGRlcHRoICsgMSwgcmlnaHRTaGlmdChvZmZzZXQpKQp9CgpleHBvcnRzLmxlZnRDaGlsZCA9IGZ1bmN0aW9uIChpbmRleCwgZGVwdGgpIHsKICBpZiAoIShpbmRleCAmIDEpKSByZXR1cm4gLTEKICBpZiAoIWRlcHRoKSBkZXB0aCA9IGV4cG9ydHMuZGVwdGgoaW5kZXgpCiAgcmV0dXJuIGV4cG9ydHMuaW5kZXgoZGVwdGggLSAxLCBleHBvcnRzLm9mZnNldChpbmRleCwgZGVwdGgpICogMikKfQoKZXhwb3J0cy5yaWdodENoaWxkID0gZnVuY3Rpb24gKGluZGV4LCBkZXB0aCkgewogIGlmICghKGluZGV4ICYgMSkpIHJldHVybiAtMQogIGlmICghZGVwdGgpIGRlcHRoID0gZXhwb3J0cy5kZXB0aChpbmRleCkKICByZXR1cm4gZXhwb3J0cy5pbmRleChkZXB0aCAtIDEsIDEgKyAoZXhwb3J0cy5vZmZzZXQoaW5kZXgsIGRlcHRoKSAqIDIpKQp9CgpleHBvcnRzLmNoaWxkcmVuID0gZnVuY3Rpb24gKGluZGV4LCBkZXB0aCkgewogIGlmICghKGluZGV4ICYgMSkpIHJldHVybiBudWxsCgogIGlmICghZGVwdGgpIGRlcHRoID0gZXhwb3J0cy5kZXB0aChpbmRleCkKICBjb25zdCBvZmZzZXQgPSBleHBvcnRzLm9mZnNldChpbmRleCwgZGVwdGgpICogMgoKICByZXR1cm4gWwogICAgZXhwb3J0cy5pbmRleChkZXB0aCAtIDEsIG9mZnNldCksCiAgICBleHBvcnRzLmluZGV4KGRlcHRoIC0gMSwgb2Zmc2V0ICsgMSkKICBdCn0KCmV4cG9ydHMubGVmdFNwYW4gPSBmdW5jdGlvbiAoaW5kZXgsIGRlcHRoKSB7CiAgaWYgKCEoaW5kZXggJiAxKSkgcmV0dXJuIGluZGV4CiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQogIHJldHVybiBleHBvcnRzLm9mZnNldChpbmRleCwgZGVwdGgpICogdHdvUG93KGRlcHRoICsgMSkKfQoKZXhwb3J0cy5yaWdodFNwYW4gPSBmdW5jdGlvbiAoaW5kZXgsIGRlcHRoKSB7CiAgaWYgKCEoaW5kZXggJiAxKSkgcmV0dXJuIGluZGV4CiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQogIHJldHVybiAoZXhwb3J0cy5vZmZzZXQoaW5kZXgsIGRlcHRoKSArIDEpICogdHdvUG93KGRlcHRoICsgMSkgLSAyCn0KCmV4cG9ydHMubmV4dExlYWYgPSBmdW5jdGlvbiAoaW5kZXgpIHsKICBsZXQgZmFjdG9yID0gMQogIGxldCByID0gaW5kZXgKCiAgd2hpbGUgKChyICYgMSkgPT09IDEpIHsKICAgIHIgPSAociAtIDEpIC8gMgogICAgZmFjdG9yICo9IDIKICB9CgogIHJldHVybiBpbmRleCArIGZhY3RvciArIDEKfQoKZXhwb3J0cy5jb3VudCA9IGZ1bmN0aW9uIChpbmRleCwgZGVwdGgpIHsKICBpZiAoIShpbmRleCAmIDEpKSByZXR1cm4gMQogIGlmICghZGVwdGgpIGRlcHRoID0gZXhwb3J0cy5kZXB0aChpbmRleCkKICByZXR1cm4gdHdvUG93KGRlcHRoICsgMSkgLSAxCn0KCmV4cG9ydHMuY291bnRMZWF2ZXMgPSBmdW5jdGlvbiAoaW5kZXgpIHsKICByZXR1cm4gKGV4cG9ydHMuY291bnQoaW5kZXgpICsgMSkgLyAyCn0KCmV4cG9ydHMuc3BhbnMgPSBmdW5jdGlvbiAoaW5kZXgsIGRlcHRoKSB7CiAgaWYgKCEoaW5kZXggJiAxKSkgcmV0dXJuIFtpbmRleCwgaW5kZXhdCiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQoKICBjb25zdCBvZmZzZXQgPSBleHBvcnRzLm9mZnNldChpbmRleCwgZGVwdGgpCiAgY29uc3Qgd2lkdGggPSB0d29Qb3coZGVwdGggKyAxKQoKICByZXR1cm4gW29mZnNldCAqIHdpZHRoLCAob2Zmc2V0ICsgMSkgKiB3aWR0aCAtIDJdCn0KCmV4cG9ydHMuaW5kZXggPSBmdW5jdGlvbiAoZGVwdGgsIG9mZnNldCkgewogIHJldHVybiAoMSArIDIgKiBvZmZzZXQpICogdHdvUG93KGRlcHRoKSAtIDEKfQoKZXhwb3J0cy5vZmZzZXQgPSBmdW5jdGlvbiAoaW5kZXgsIGRlcHRoKSB7CiAgaWYgKCEoaW5kZXggJiAxKSkgcmV0dXJuIGluZGV4IC8gMgogIGlmICghZGVwdGgpIGRlcHRoID0gZXhwb3J0cy5kZXB0aChpbmRleCkKCiAgcmV0dXJuICgoaW5kZXggKyAxKSAvIHR3b1BvdyhkZXB0aCkgLSAxKSAvIDIKfQoKZXhwb3J0cy5pdGVyYXRvciA9IGZ1bmN0aW9uIChpbmRleCkgewogIGNvbnN0IGl0ZSA9IG5ldyBJdGVyYXRvcigpCiAgaXRlLnNlZWsoaW5kZXggfHwgMCkKICByZXR1cm4gaXRlCn0KCmZ1bmN0aW9uIHR3b1BvdyAobikgewogIHJldHVybiBuIDwgMzEgPyAxIDw8IG4gOiAoKDEgPDwgMzApICogKDEgPDwgKG4gLSAzMCkpKQp9CgpmdW5jdGlvbiByaWdodFNoaWZ0IChuKSB7CiAgcmV0dXJuIChuIC0gKG4gJiAxKSkgLyAyCn0KCmZ1bmN0aW9uIEl0ZXJhdG9yICgpIHsKICB0aGlzLmluZGV4ID0gMAogIHRoaXMub2Zmc2V0ID0gMAogIHRoaXMuZmFjdG9yID0gMAp9CgpJdGVyYXRvci5wcm90b3R5cGUuc2VlayA9IGZ1bmN0aW9uIChpbmRleCkgewogIHRoaXMuaW5kZXggPSBpbmRleAogIGlmICh0aGlzLmluZGV4ICYgMSkgewogICAgdGhpcy5vZmZzZXQgPSBleHBvcnRzLm9mZnNldChpbmRleCkKICAgIHRoaXMuZmFjdG9yID0gdHdvUG93KGV4cG9ydHMuZGVwdGgoaW5kZXgpICsgMSkKICB9IGVsc2UgewogICAgdGhpcy5vZmZzZXQgPSBpbmRleCAvIDIKICAgIHRoaXMuZmFjdG9yID0gMgogIH0KfQoKSXRlcmF0b3IucHJvdG90eXBlLmlzTGVmdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gKHRoaXMub2Zmc2V0ICYgMSkgPT09IDAKfQoKSXRlcmF0b3IucHJvdG90eXBlLmlzUmlnaHQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuICh0aGlzLm9mZnNldCAmIDEpID09PSAxCn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5pc1Jvb3QgPSBmdW5jdGlvbiAobGVuZ3RoKSB7CiAgY29uc3QgY3VycmVudExlbmd0aCA9IDEgKyAodGhpcy5pbmRleCArIHRoaXMuZmFjdG9yIC8gMiAtIDEpIC8gMgogIGlmIChsZW5ndGggPCBjdXJyZW50TGVuZ3RoKSByZXR1cm4gZmFsc2UKCiAgY29uc3QgZmFjdG9yID0gdGhpcy5mYWN0b3IgKiAyCiAgY29uc3QgaW5kZXggPSAodGhpcy5vZmZzZXQgJiAxKQogICAgPyB0aGlzLmluZGV4IC0gdGhpcy5mYWN0b3IgLyAyCiAgICA6IHRoaXMuaW5kZXggKyB0aGlzLmZhY3RvciAvIDIKCiAgY29uc3QgcGFyZW50TGVuZ3RoID0gMSArIChpbmRleCArIGZhY3RvciAvIDIgLSAxKSAvIDIKICByZXR1cm4gcGFyZW50TGVuZ3RoID4gbGVuZ3RoCn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5jb250YWlucyA9IGZ1bmN0aW9uIChpbmRleCkgewogIHJldHVybiBpbmRleCA+IHRoaXMuaW5kZXgKICAgID8gaW5kZXggPCAodGhpcy5pbmRleCArIHRoaXMuZmFjdG9yIC8gMikKICAgIDogaW5kZXggPCB0aGlzLmluZGV4CiAgICAgID8gaW5kZXggPiAodGhpcy5pbmRleCAtIHRoaXMuZmFjdG9yIC8gMikKICAgICAgOiB0cnVlCn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5wcmV2ID0gZnVuY3Rpb24gKCkgewogIGlmICghdGhpcy5vZmZzZXQpIHJldHVybiB0aGlzLmluZGV4CiAgdGhpcy5vZmZzZXQtLQogIHRoaXMuaW5kZXggLT0gdGhpcy5mYWN0b3IKICByZXR1cm4gdGhpcy5pbmRleAp9CgpJdGVyYXRvci5wcm90b3R5cGUubmV4dCA9IGZ1bmN0aW9uICgpIHsKICB0aGlzLm9mZnNldCsrCiAgdGhpcy5pbmRleCArPSB0aGlzLmZhY3RvcgogIHJldHVybiB0aGlzLmluZGV4Cn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5jb3VudCA9IGZ1bmN0aW9uICgpIHsKICBpZiAoISh0aGlzLmluZGV4ICYgMSkpIHJldHVybiAxCiAgcmV0dXJuIHRoaXMuZmFjdG9yIC0gMQp9CgpJdGVyYXRvci5wcm90b3R5cGUuY291bnRMZWF2ZXMgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuICh0aGlzLmNvdW50KCkgKyAxKSAvIDIKfQoKSXRlcmF0b3IucHJvdG90eXBlLnNpYmxpbmcgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuaXNMZWZ0KCkgPyB0aGlzLm5leHQoKSA6IHRoaXMucHJldigpCn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5wYXJlbnQgPSBmdW5jdGlvbiAoKSB7CiAgaWYgKHRoaXMub2Zmc2V0ICYgMSkgewogICAgdGhpcy5pbmRleCAtPSB0aGlzLmZhY3RvciAvIDIKICAgIHRoaXMub2Zmc2V0ID0gKHRoaXMub2Zmc2V0IC0gMSkgLyAyCiAgfSBlbHNlIHsKICAgIHRoaXMuaW5kZXggKz0gdGhpcy5mYWN0b3IgLyAyCiAgICB0aGlzLm9mZnNldCAvPSAyCiAgfQogIHRoaXMuZmFjdG9yICo9IDIKICByZXR1cm4gdGhpcy5pbmRleAp9CgpJdGVyYXRvci5wcm90b3R5cGUubGVmdFNwYW4gPSBmdW5jdGlvbiAoKSB7CiAgdGhpcy5pbmRleCA9IHRoaXMuaW5kZXggLSB0aGlzLmZhY3RvciAvIDIgKyAxCiAgdGhpcy5vZmZzZXQgPSB0aGlzLmluZGV4IC8gMgogIHRoaXMuZmFjdG9yID0gMgogIHJldHVybiB0aGlzLmluZGV4Cn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5wZWVrTGVmdFNwYW4gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuaW5kZXggLSB0aGlzLmZhY3RvciAvIDIgKyAxCn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5yaWdodFNwYW4gPSBmdW5jdGlvbiAoKSB7CiAgdGhpcy5pbmRleCA9IHRoaXMuaW5kZXggKyB0aGlzLmZhY3RvciAvIDIgLSAxCiAgdGhpcy5vZmZzZXQgPSB0aGlzLmluZGV4IC8gMgogIHRoaXMuZmFjdG9yID0gMgogIHJldHVybiB0aGlzLmluZGV4Cn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5wZWVrUmlnaHRTcGFuID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLmluZGV4ICsgdGhpcy5mYWN0b3IgLyAyIC0gMQp9CgpJdGVyYXRvci5wcm90b3R5cGUubGVmdENoaWxkID0gZnVuY3Rpb24gKCkgewogIGlmICh0aGlzLmZhY3RvciA9PT0gMikgcmV0dXJuIHRoaXMuaW5kZXgKICB0aGlzLmZhY3RvciAvPSAyCiAgdGhpcy5pbmRleCAtPSB0aGlzLmZhY3RvciAvIDIKICB0aGlzLm9mZnNldCAqPSAyCiAgcmV0dXJuIHRoaXMuaW5kZXgKfQoKSXRlcmF0b3IucHJvdG90eXBlLnJpZ2h0Q2hpbGQgPSBmdW5jdGlvbiAoKSB7CiAgaWYgKHRoaXMuZmFjdG9yID09PSAyKSByZXR1cm4gdGhpcy5pbmRleAogIHRoaXMuZmFjdG9yIC89IDIKICB0aGlzLmluZGV4ICs9IHRoaXMuZmFjdG9yIC8gMgogIHRoaXMub2Zmc2V0ID0gMiAqIHRoaXMub2Zmc2V0ICsgMQogIHJldHVybiB0aGlzLmluZGV4Cn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5uZXh0VHJlZSA9IGZ1bmN0aW9uICgpIHsKICB0aGlzLmluZGV4ID0gdGhpcy5pbmRleCArIHRoaXMuZmFjdG9yIC8gMiArIDEKICB0aGlzLm9mZnNldCA9IHRoaXMuaW5kZXggLyAyCiAgdGhpcy5mYWN0b3IgPSAyCiAgcmV0dXJuIHRoaXMuaW5kZXgKfQoKSXRlcmF0b3IucHJvdG90eXBlLnByZXZUcmVlID0gZnVuY3Rpb24gKCkgewogIGlmICghdGhpcy5vZmZzZXQpIHsKICAgIHRoaXMuaW5kZXggPSAwCiAgICB0aGlzLmZhY3RvciA9IDIKICB9IGVsc2UgewogICAgdGhpcy5pbmRleCA9IHRoaXMuaW5kZXggLSB0aGlzLmZhY3RvciAvIDIgLSAxCiAgICB0aGlzLm9mZnNldCA9IHRoaXMuaW5kZXggLyAyCiAgICB0aGlzLmZhY3RvciA9IDIKICB9CiAgcmV0dXJuIHRoaXMuaW5kZXgKfQoKSXRlcmF0b3IucHJvdG90eXBlLmZ1bGxSb290ID0gZnVuY3Rpb24gKGluZGV4KSB7CiAgaWYgKGluZGV4IDw9IHRoaXMuaW5kZXggfHwgKHRoaXMuaW5kZXggJiAxKSA+IDApIHJldHVybiBmYWxzZQogIHdoaWxlIChpbmRleCA+IHRoaXMuaW5kZXggKyB0aGlzLmZhY3RvciArIHRoaXMuZmFjdG9yIC8gMikgewogICAgdGhpcy5pbmRleCArPSB0aGlzLmZhY3RvciAvIDIKICAgIHRoaXMuZmFjdG9yICo9IDIKICAgIHRoaXMub2Zmc2V0IC89IDIKICB9CiAgcmV0dXJuIHRydWUKfQp7CiAgIm5hbWUiOiAiZmxhdC10cmVlIiwKICAidmVyc2lvbiI6ICIxLjEzLjAiLAogICJkZXNjcmlwdGlvbiI6ICJBIHNlcmllcyBvZiBmdW5jdGlvbnMgdG8gbWFwIGEgYmluYXJ5IHRyZWUgdG8gYSBsaXN0IiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4zLjIiLAogICAgInN0YW5kYXJkIjogIl4xNy4xLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9mbGF0LXRyZWUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2ZsYXQtdHJlZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9mbGF0LXRyZWUiCn0KcmVxdWlyZS5hZGRvbiA9IHJlcXVpcmUoJ3JlcXVpcmUtYWRkb24nKQoKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCcuJywgX19maWxlbmFtZSkKY29uc3QgeyBpc1dpbmRvd3MgfSA9IHJlcXVpcmUoJ3doaWNoLXJ1bnRpbWUnKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi9iaW5kaW5nJykKCmZ1bmN0aW9uIG9ud29yayhlcnIsIHJlc3VsdCkgewogIGlmIChlcnIpIHRoaXMucmVqZWN0KGVycikKICBlbHNlIHRoaXMucmVzb2x2ZShyZXN1bHQpCn0KCmV4cG9ydHMudHJ5TG9jayA9IGZ1bmN0aW9uIHRyeUxvY2soZmQsIG9mZnNldCA9IDAsIGxlbmd0aCA9IDAsIG9wdHMgPSB7fSkgewogIGlmICh0eXBlb2Ygb2Zmc2V0ID09PSAnb2JqZWN0JykgewogICAgb3B0cyA9IG9mZnNldAogICAgb2Zmc2V0ID0gMAogIH0KCiAgaWYgKHR5cGVvZiBsZW5ndGggPT09ICdvYmplY3QnKSB7CiAgICBvcHRzID0gbGVuZ3RoCiAgICBsZW5ndGggPSAwCiAgfQoKICBpZiAodHlwZW9mIG9wdHMgIT09ICdvYmplY3QnIHx8IG9wdHMgPT09IG51bGwpIHsKICAgIG9wdHMgPSB7fQogIH0KCiAgdHJ5IHsKICAgIGJpbmRpbmcudHJ5TG9jayhmZCwgb2Zmc2V0LCBsZW5ndGgsIG9wdHMuc2hhcmVkICE9PSB0cnVlKQogIH0gY2F0Y2ggKGVycikgewogICAgaWYgKGVyci5jb2RlID09PSAnRUFHQUlOJykgcmV0dXJuIGZhbHNlCiAgICB0aHJvdyBlcnIKICB9CgogIHJldHVybiB0cnVlCn0KCmV4cG9ydHMud2FpdEZvckxvY2sgPSBmdW5jdGlvbiB3YWl0Rm9yTG9jaygKICBmZCwKICBvZmZzZXQgPSAwLAogIGxlbmd0aCA9IDAsCiAgb3B0cyA9IHt9CikgewogIGlmICh0eXBlb2Ygb2Zmc2V0ID09PSAnb2JqZWN0JykgewogICAgb3B0cyA9IG9mZnNldAogICAgb2Zmc2V0ID0gMAogIH0KCiAgaWYgKHR5cGVvZiBsZW5ndGggPT09ICdvYmplY3QnKSB7CiAgICBvcHRzID0gbGVuZ3RoCiAgICBsZW5ndGggPSAwCiAgfQoKICBpZiAodHlwZW9mIG9wdHMgIT09ICdvYmplY3QnIHx8IG9wdHMgPT09IG51bGwpIHsKICAgIG9wdHMgPSB7fQogIH0KCiAgY29uc3QgcmVxID0gewogICAgaGFuZGxlOiBudWxsLAogICAgcmVzb2x2ZTogbnVsbCwKICAgIHJlamVjdDogbnVsbAogIH0KCiAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgcmVxLnJlamVjdCA9IHJlamVjdAogIH0pCgogIHRyeSB7CiAgICByZXEuaGFuZGxlID0gYmluZGluZy53YWl0Rm9yTG9jaygKICAgICAgZmQsCiAgICAgIG9mZnNldCwKICAgICAgbGVuZ3RoLAogICAgICBvcHRzLnNoYXJlZCAhPT0gdHJ1ZSwKICAgICAgcmVxLAogICAgICBvbndvcmsKICAgICkKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpCiAgfQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLnRyeURvd25ncmFkZUxvY2sgPSBmdW5jdGlvbiB0cnlEb3duZ3JhZGVMb2NrKAogIGZkLAogIG9mZnNldCA9IDAsCiAgbGVuZ3RoID0gMAopIHsKICB0cnkgewogICAgYmluZGluZy50cnlEb3duZ3JhZGVMb2NrKGZkLCBvZmZzZXQsIGxlbmd0aCkKICB9IGNhdGNoIChlcnIpIHsKICAgIGlmIChlcnIuY29kZSA9PT0gJ0VBR0FJTicpIHJldHVybiBmYWxzZQogICAgdGhyb3cgZXJyCiAgfQoKICByZXR1cm4gdHJ1ZQp9CgpleHBvcnRzLndhaXRGb3JEb3duZ3JhZGVMb2NrID0gZnVuY3Rpb24gZG93bmdyYWRlTG9jaygKICBmZCwKICBvZmZzZXQgPSAwLAogIGxlbmd0aCA9IDAKKSB7CiAgY29uc3QgcmVxID0gewogICAgaGFuZGxlOiBudWxsLAogICAgcmVzb2x2ZTogbnVsbCwKICAgIHJlamVjdDogbnVsbAogIH0KCiAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgcmVxLnJlamVjdCA9IHJlamVjdAogIH0pCgogIHRyeSB7CiAgICByZXEuaGFuZGxlID0gYmluZGluZy53YWl0Rm9yRG93bmdyYWRlTG9jayhmZCwgb2Zmc2V0LCBsZW5ndGgsIHJlcSwgb253b3JrKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICB9CgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMudHJ5VXBncmFkZUxvY2sgPSBmdW5jdGlvbiB0cnlVcGdyYWRlTG9jayhmZCwgb2Zmc2V0ID0gMCwgbGVuZ3RoID0gMCkgewogIHRyeSB7CiAgICBiaW5kaW5nLnRyeVVwZ3JhZGVMb2NrKGZkLCBvZmZzZXQsIGxlbmd0aCkKICB9IGNhdGNoIChlcnIpIHsKICAgIGlmIChlcnIuY29kZSA9PT0gJ0VBR0FJTicpIHJldHVybiBmYWxzZQogICAgdGhyb3cgZXJyCiAgfQoKICByZXR1cm4gdHJ1ZQp9CgpleHBvcnRzLndhaXRGb3JVcGdyYWRlTG9jayA9IGZ1bmN0aW9uIHVwZ3JhZGVMb2NrKGZkLCBvZmZzZXQgPSAwLCBsZW5ndGggPSAwKSB7CiAgY29uc3QgcmVxID0gewogICAgaGFuZGxlOiBudWxsLAogICAgcmVzb2x2ZTogbnVsbCwKICAgIHJlamVjdDogbnVsbAogIH0KCiAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgcmVxLnJlamVjdCA9IHJlamVjdAogIH0pCgogIHRyeSB7CiAgICByZXEuaGFuZGxlID0gYmluZGluZy53YWl0Rm9yVXBncmFkZUxvY2soZmQsIG9mZnNldCwgbGVuZ3RoLCByZXEsIG9ud29yaykKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpCiAgfQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLnVubG9jayA9IGZ1bmN0aW9uIHVubG9jayhmZCwgb2Zmc2V0ID0gMCwgbGVuZ3RoID0gMCkgewogIGJpbmRpbmcudW5sb2NrKGZkLCBvZmZzZXQsIGxlbmd0aCkKfQoKZXhwb3J0cy50cmltID0gZnVuY3Rpb24gdHJpbShmZCwgb2Zmc2V0LCBsZW5ndGgpIHsKICBjb25zdCByZXEgPSB7CiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLnRyaW0oZmQsIG9mZnNldCwgbGVuZ3RoLCByZXEsIG9ud29yaykKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpCiAgfQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLnNwYXJzZSA9IGZ1bmN0aW9uIHNwYXJzZShmZCkgewogIC8vIFNob3J0IGNpcmN1aXQgb24gZXZlcnl0aGluZyBidXQgV2luZG93cwogIGlmICghaXNXaW5kb3dzKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKCiAgY29uc3QgcmVxID0gewogICAgaGFuZGxlOiBudWxsLAogICAgcmVzb2x2ZTogbnVsbCwKICAgIHJlamVjdDogbnVsbAogIH0KCiAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgcmVxLnJlamVjdCA9IHJlamVjdAogIH0pCgogIHRyeSB7CiAgICByZXEuaGFuZGxlID0gYmluZGluZy5zcGFyc2UoZmQsIHJlcSwgb253b3JrKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICB9CgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMuc3dhcCA9IGZ1bmN0aW9uIHN3YXAoZnJvbSwgdG8pIHsKICBjb25zdCByZXEgPSB7CiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLnN3YXAoZnJvbSwgdG8sIHJlcSwgb253b3JrKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICB9CgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMuZ2V0QXR0ciA9IGZ1bmN0aW9uIGdldEF0dHIoZmQsIG5hbWUpIHsKICBjb25zdCByZXEgPSB7CiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLmdldEF0dHIoZmQsIG5hbWUsIHJlcSwgb253b3JrKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICB9CgogIHJldHVybiBwcm9taXNlLnRoZW4oKGJ1ZmZlcikgPT4KICAgIGJ1ZmZlciA9PT0gbnVsbCA/IG51bGwgOiBCdWZmZXIuZnJvbShidWZmZXIpCiAgKQp9CgpleHBvcnRzLnNldEF0dHIgPSBmdW5jdGlvbiBzZXRBdHRyKGZkLCBuYW1lLCB2YWx1ZSwgZW5jb2RpbmcpIHsKICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgdmFsdWUgPSBCdWZmZXIuZnJvbSh2YWx1ZSwgZW5jb2RpbmcpCgogIGNvbnN0IHJlcSA9IHsKICAgIHZhbHVlLAogICAgaGFuZGxlOiBudWxsLAogICAgcmVzb2x2ZTogbnVsbCwKICAgIHJlamVjdDogbnVsbAogIH0KCiAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgcmVxLnJlamVjdCA9IHJlamVjdAogIH0pCgogIHRyeSB7CiAgICByZXEuaGFuZGxlID0gYmluZGluZy5zZXRBdHRyKAogICAgICBmZCwKICAgICAgbmFtZSwKICAgICAgdmFsdWUuYnVmZmVyLAogICAgICB2YWx1ZS5ieXRlT2Zmc2V0LAogICAgICB2YWx1ZS5ieXRlTGVuZ3RoLAogICAgICByZXEsCiAgICAgIG9ud29yawogICAgKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICB9CgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMucmVtb3ZlQXR0ciA9IGZ1bmN0aW9uIHJlbW92ZUF0dHIoZmQsIG5hbWUpIHsKICBjb25zdCByZXEgPSB7CiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLnJlbW92ZUF0dHIoZmQsIG5hbWUsIHJlcSwgb253b3JrKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICB9CgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMubGlzdEF0dHJzID0gZnVuY3Rpb24gbGlzdEF0dHJzKGZkKSB7CiAgY29uc3QgcmVxID0gewogICAgaGFuZGxlOiBudWxsLAogICAgcmVzb2x2ZTogbnVsbCwKICAgIHJlamVjdDogbnVsbAogIH0KCiAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgcmVxLnJlamVjdCA9IHJlamVjdAogIH0pCgogIHRyeSB7CiAgICByZXEuaGFuZGxlID0gYmluZGluZy5saXN0QXR0cnMoZmQsIHJlcSwgb253b3JrKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICB9CgogIHJldHVybiBwcm9taXNlCn0KewogICJuYW1lIjogImZzLW5hdGl2ZS1leHRlbnNpb25zIiwKICAidmVyc2lvbiI6ICIxLjQuNSIsCiAgImRlc2NyaXB0aW9uIjogIk5hdGl2ZSBmaWxlIHN5c3RlbSBleHRlbnNpb25zIGZvciBhZHZhbmNlZCBmaWxlIG9wZXJhdGlvbnMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgIm1hY3Jvcy5oIiwKICAgICJiaW5kaW5nLmMiLAogICAgImJpbmRpbmcuanMiLAogICAgIkNNYWtlTGlzdHMudHh0IiwKICAgICJpbmNsdWRlIiwKICAgICJzcmMiLAogICAgInByZWJ1aWxkcyIKICBdLAogICJpbXBvcnRzIjogewogICAgImNoaWxkX3Byb2Nlc3MiOiB7CiAgICAgICJiYXJlIjogImJhcmUtc3VicHJvY2VzcyIsCiAgICAgICJkZWZhdWx0IjogImNoaWxkX3Byb2Nlc3MiCiAgICB9LAogICAgImZzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWZzIiwKICAgICAgImRlZmF1bHQiOiAiZnMiCiAgICB9LAogICAgImZzLyoiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZnMvKiIsCiAgICAgICJkZWZhdWx0IjogImZzLyoiCiAgICB9LAogICAgInBhdGgiOiB7CiAgICAgICJiYXJlIjogImJhcmUtcGF0aCIsCiAgICAgICJkZWZhdWx0IjogInBhdGgiCiAgICB9CiAgfSwKICAiYWRkb24iOiB0cnVlLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAibnBtIHJ1biBsaW50ICYmIG5wbSBydW4gdGVzdDpiYXJlICYmIG5wbSBydW4gdGVzdDpub2RlIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0LmpzIiwKICAgICJ0ZXN0Om5vZGUiOiAibm9kZSB0ZXN0LmpzIiwKICAgICJsaW50IjogInByZXR0aWVyIC4gLS1jaGVjayIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9mcy1uYXRpdmUtZXh0ZW5zaW9ucy5naXQiCiAgfSwKICAiYXV0aG9yIjogIkthc3BlciBJc2FnZXIgRGFsc2dhcsOwIDxrYXNwZXJAZnVua3Rpb25lbC5jbz4iLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vZnMtbmF0aXZlLWV4dGVuc2lvbnMvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9mcy1uYXRpdmUtZXh0ZW5zaW9ucyNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAicmVxdWlyZS1hZGRvbiI6ICJeMS4xLjAiLAogICAgIndoaWNoLXJ1bnRpbWUiOiAiXjEuMi4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWNvbXBhdC1uYXBpIjogIl4xLjMuOCIsCiAgICAiYmFyZS1mcyI6ICJeNC40LjQiLAogICAgImJhcmUtcGF0aCI6ICJeMy4wLjAiLAogICAgImJhcmUtc3VicHJvY2VzcyI6ICJeNC4wLjUiLAogICAgImJyaXR0bGUiOiAiXjMuMS4xIiwKICAgICJjbWFrZS1iYXJlIjogIl4xLjEuMTAiLAogICAgImNtYWtlLWZldGNoIjogIl4xLjQuNyIsCiAgICAiY21ha2UtbmFwaSI6ICJeMS4wLjUiLAogICAgImNtYWtlLW5wbSI6ICJeMS4xLjAiLAogICAgIm1pbmltaXN0IjogIl4xLjIuNiIsCiAgICAicHJldHRpZXIiOiAiXjMuNS4zIiwKICAgICJwcmV0dGllci1jb25maWctc3RhbmRhcmQiOiAiXjcuMC4wIiwKICAgICJ0ZXN0LXRtcCI6ICJeMS4yLjEiCiAgfQp9CmNvbnN0IGNvZGVjcyA9IHJlcXVpcmUoJ2NvZGVjcycpCmNvbnN0IHsgUmVhZGFibGUgfSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQpjb25zdCBtdXRleGlmeSA9IHJlcXVpcmUoJ211dGV4aWZ5L3Byb21pc2UnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCmNvbnN0IGRlYm91bmNlID0gcmVxdWlyZSgnZGVib3VuY2VpZnknKQpjb25zdCBSYWNoZSA9IHJlcXVpcmUoJ3JhY2hlJykKY29uc3QgcnJwID0gcmVxdWlyZSgncmVzb2x2ZS1yZWplY3QtcHJvbWlzZScpCgpjb25zdCB7IGFsbDogdW5zbGFiQWxsIH0gPSByZXF1aXJlKCd1bnNsYWInKQoKY29uc3QgUmFuZ2VJdGVyYXRvciA9IHJlcXVpcmUoJy4vaXRlcmF0b3JzL3JhbmdlJykKY29uc3QgSGlzdG9yeUl0ZXJhdG9yID0gcmVxdWlyZSgnLi9pdGVyYXRvcnMvaGlzdG9yeScpCmNvbnN0IERpZmZJdGVyYXRvciA9IHJlcXVpcmUoJy4vaXRlcmF0b3JzL2RpZmYnKQpjb25zdCBMb2NhbEJsb2NrSXRlcmF0b3IgPSByZXF1aXJlKCcuL2l0ZXJhdG9ycy9sb2NhbCcpCmNvbnN0IEV4dGVuc2lvbiA9IHJlcXVpcmUoJy4vbGliL2V4dGVuc2lvbicpCmNvbnN0IHsgWW9sb0luZGV4LCBOb2RlLCBIZWFkZXIgfSA9IHJlcXVpcmUoJy4vbGliL21lc3NhZ2VzJykKY29uc3QgeyBCTE9DS19OT1RfQVZBSUxBQkxFLCBERUNPRElOR19FUlJPUiB9ID0gcmVxdWlyZSgnaHlwZXJjb3JlLWVycm9ycycpCgpjb25zdCBUID0gNQpjb25zdCBNSU5fS0VZUyA9IFQgLSAxCmNvbnN0IE1BWF9DSElMRFJFTiA9IE1JTl9LRVlTICogMiArIDEKCmNvbnN0IFNFUCA9IGI0YS5hbGxvYygxKQpjb25zdCBFTVBUWSA9IGI0YS5hbGxvYygwKQoKY2xhc3MgS2V5IHsKICBjb25zdHJ1Y3RvciAoc2VxLCB2YWx1ZSkgewogICAgdGhpcy5zZXEgPSBzZXEKICAgIHRoaXMudmFsdWUgPSB2YWx1ZQogIH0KfQoKY2xhc3MgQ2hpbGQgewogIGNvbnN0cnVjdG9yIChzZXEsIG9mZnNldCwgdmFsdWUpIHsKICAgIHRoaXMuc2VxID0gc2VxCiAgICB0aGlzLm9mZnNldCA9IG9mZnNldAogICAgdGhpcy52YWx1ZSA9IHZhbHVlCiAgfQp9CgpjbGFzcyBDYWNoZSB7CiAgY29uc3RydWN0b3IgKHJhY2hlKSB7CiAgICB0aGlzLmtleXMgPSByYWNoZQogICAgdGhpcy5sZW5ndGggPSAwCiAgfQoKICBnZXQgKHNlcSkgewogICAgcmV0dXJuIHRoaXMua2V5cy5nZXQoc2VxKSB8fCBudWxsCiAgfQoKICBzZXQgKHNlcSwga2V5KSB7CiAgICB0aGlzLmtleXMuc2V0KHNlcSwga2V5KQogICAgaWYgKHNlcSA+PSB0aGlzLmxlbmd0aCkgdGhpcy5sZW5ndGggPSBzZXEgKyAxCiAgfQoKICBnYyAobGVuZ3RoKSB7CiAgICAvLyBpZiB3ZSBuZWVkIHRvICJ3b3JrIiBtb3JlIHRoYW4gMTI4IHRpY2tzLCBqdXN0IGJ1c3QgdGhlIGNhY2hlLi4uCiAgICBpZiAodGhpcy5sZW5ndGggLSBsZW5ndGggPiAxMjgpIHsKICAgICAgdGhpcy5rZXlzLmNsZWFyKCkKICAgIH0gZWxzZSB7CiAgICAgIGZvciAobGV0IGkgPSBsZW5ndGg7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy5rZXlzLmRlbGV0ZShpKQogICAgICB9CiAgICB9CgogICAgdGhpcy5sZW5ndGggPSBsZW5ndGgKICB9CgogIGNsZWFyICgpIHsKICAgIHRoaXMua2V5cy5jbGVhcigpCiAgfQp9CgpjbGFzcyBQb2ludGVycyB7CiAgY29uc3RydWN0b3IgKGRlY29kZWQpIHsKICAgIHRoaXMubGV2ZWxzID0gZGVjb2RlZC5sZXZlbHMubWFwKGwgPT4gewogICAgICBjb25zdCBjaGlsZHJlbiA9IFtdCiAgICAgIGNvbnN0IGtleXMgPSBbXQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsLmtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBrZXlzLnB1c2gobmV3IEtleShsLmtleXNbaV0sIG51bGwpKQogICAgICB9CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGwuY2hpbGRyZW4ubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICBjaGlsZHJlbi5wdXNoKG5ldyBDaGlsZChsLmNoaWxkcmVuW2ldLCBsLmNoaWxkcmVuW2kgKyAxXSwgbnVsbCkpCiAgICAgIH0KCiAgICAgIHJldHVybiB7IGtleXMsIGNoaWxkcmVuIH0KICAgIH0pCiAgfQoKICBnZXQgKGkpIHsKICAgIHJldHVybiB0aGlzLmxldmVsc1tpXQogIH0KCiAgaGFzS2V5IChzZXEpIHsKICAgIGZvciAoY29uc3QgbHZsIG9mIHRoaXMubGV2ZWxzKSB7CiAgICAgIGZvciAoY29uc3Qga2V5IG9mIGx2bC5rZXlzKSB7CiAgICAgICAgaWYgKGtleS5zZXEgPT09IHNlcSkgcmV0dXJuIHRydWUKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlCiAgfQp9CgpmdW5jdGlvbiBpbmZsYXRlIChlbnRyeSkgewogIGlmIChlbnRyeS5pbmZsYXRlZCA9PT0gbnVsbCkgewogICAgZW50cnkuaW5mbGF0ZWQgPSBZb2xvSW5kZXguZGVjb2RlKGVudHJ5LmluZGV4KQogICAgZW50cnkuaW5kZXggPSBudWxsCiAgfQogIHJldHVybiBuZXcgUG9pbnRlcnMoZW50cnkuaW5mbGF0ZWQpCn0KCmZ1bmN0aW9uIGRlZmxhdGUgKGluZGV4KSB7CiAgY29uc3QgbGV2ZWxzID0gaW5kZXgubWFwKGwgPT4gewogICAgY29uc3Qga2V5cyA9IFtdCiAgICBjb25zdCBjaGlsZHJlbiA9IFtdCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsLnZhbHVlLmtleXMubGVuZ3RoOyBpKyspIHsKICAgICAga2V5cy5wdXNoKGwudmFsdWUua2V5c1tpXS5zZXEpCiAgICB9CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsLnZhbHVlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNoaWxkcmVuLnB1c2gobC52YWx1ZS5jaGlsZHJlbltpXS5zZXEsIGwudmFsdWUuY2hpbGRyZW5baV0ub2Zmc2V0KQogICAgfQoKICAgIHJldHVybiB7IGtleXMsIGNoaWxkcmVuIH0KICB9KQoKICByZXR1cm4gWW9sb0luZGV4LmVuY29kZSh7IGxldmVscyB9KQp9CgpjbGFzcyBUcmVlTm9kZSB7CiAgY29uc3RydWN0b3IgKGJsb2NrLCBrZXlzLCBjaGlsZHJlbiwgb2Zmc2V0KSB7CiAgICB0aGlzLmJsb2NrID0gYmxvY2sKICAgIHRoaXMub2Zmc2V0ID0gb2Zmc2V0CiAgICB0aGlzLmtleXMgPSBrZXlzCiAgICB0aGlzLmNoaWxkcmVuID0gY2hpbGRyZW4KICAgIHRoaXMuY2hhbmdlZCA9IGZhbHNlCgogICAgdGhpcy5wcmVsb2FkKCkKICB9CgogIHByZWxvYWQgKCkgewogICAgaWYgKHRoaXMuYmxvY2sgPT09IG51bGwpIHJldHVybgoKICAgIGNvbnN0IGNvcmUgPSBnZXRCYWNraW5nQ29yZSh0aGlzLmJsb2NrLnRyZWUuY29yZSkKICAgIGlmICghY29yZSkgcmV0dXJuCgogICAgY29uc3QgYml0ZmllbGQgPSBjb3JlLmNvcmUuYml0ZmllbGQKICAgIGNvbnN0IGJsb2NrcyA9IFtdCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgayA9IHRoaXMua2V5c1tpXQogICAgICBpZiAoay52YWx1ZSkgY29udGludWUKICAgICAgaWYgKGsuc2VxID49IGNvcmUuc2lnbmVkTGVuZ3RoIHx8IChiaXRmaWVsZCAmJiBiaXRmaWVsZC5nZXQoay5zZXEpKSkgY29udGludWUKICAgICAgYmxvY2tzLnB1c2goay5zZXEpCiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYyA9IHRoaXMuY2hpbGRyZW5baV0KICAgICAgaWYgKGMudmFsdWUpIGNvbnRpbnVlCiAgICAgIGlmIChjLnNlcSA+PSBjb3JlLnNpZ25lZExlbmd0aCB8fCAoYml0ZmllbGQgJiYgYml0ZmllbGQuZ2V0KGMuc2VxKSkpIGNvbnRpbnVlCiAgICAgIGJsb2Nrcy5wdXNoKGMuc2VxKQogICAgfQoKICAgIGlmIChibG9ja3MubGVuZ3RoKSBjb3JlLmRvd25sb2FkKHsgYmxvY2tzIH0pCiAgfQoKICBhc3luYyBpbnNlcnRLZXkgKGtleSwgdmFsdWUsIGNoaWxkLCBub2RlLCBlbmNvZGluZywgY2FzKSB7CiAgICBsZXQgcyA9IDAKICAgIGxldCBlID0gdGhpcy5rZXlzLmxlbmd0aAogICAgbGV0IGMKCiAgICB3aGlsZSAocyA8IGUpIHsKICAgICAgY29uc3QgbWlkID0gKHMgKyBlKSA+PiAxCiAgICAgIGMgPSBiNGEuY29tcGFyZShrZXkudmFsdWUsIGF3YWl0IHRoaXMuZ2V0S2V5KG1pZCkpCgogICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgIGlmIChjYXMpIHsKICAgICAgICAgIGNvbnN0IHByZXYgPSBhd2FpdCB0aGlzLmdldEtleU5vZGUobWlkKQogICAgICAgICAgaWYgKCEoYXdhaXQgY2FzKHByZXYuZmluYWwoZW5jb2RpbmcpLCBub2RlKSkpIHJldHVybiB0cnVlCiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5ibG9jay50cmVlLnRyZWUuYWx3YXlzRHVwbGljYXRlKSB7CiAgICAgICAgICBjb25zdCBwcmV2ID0gYXdhaXQgdGhpcy5nZXRLZXlOb2RlKG1pZCkKICAgICAgICAgIGlmIChzYW1lVmFsdWUocHJldi52YWx1ZSwgdmFsdWUpKSByZXR1cm4gdHJ1ZQogICAgICAgIH0KICAgICAgICB0aGlzLmNoYW5nZWQgPSB0cnVlCiAgICAgICAgdGhpcy5rZXlzW21pZF0gPSBrZXkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CgogICAgICBpZiAoYyA8IDApIGUgPSBtaWQKICAgICAgZWxzZSBzID0gbWlkICsgMQogICAgfQoKICAgIGNvbnN0IGkgPSBjIDwgMCA/IGUgOiBzCiAgICB0aGlzLmtleXMuc3BsaWNlKGksIDAsIGtleSkKICAgIGlmIChjaGlsZCkgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaSArIDEsIDAsIG5ldyBDaGlsZCgwLCAwLCBjaGlsZCkpCiAgICB0aGlzLmNoYW5nZWQgPSB0cnVlCgogICAgcmV0dXJuIHRoaXMua2V5cy5sZW5ndGggPCBNQVhfQ0hJTERSRU4KICB9CgogIHJlbW92ZUtleSAoaW5kZXgpIHsKICAgIHRoaXMua2V5cy5zcGxpY2UoaW5kZXgsIDEpCiAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgdGhpcy5jaGlsZHJlbltpbmRleCArIDFdLnNlcSA9IDAgLy8gbWFyayBhcyBmcmVlZAogICAgICB0aGlzLmNoaWxkcmVuLnNwbGljZShpbmRleCArIDEsIDEpCiAgICB9CiAgICB0aGlzLmNoYW5nZWQgPSB0cnVlCiAgfQoKICBhc3luYyBzaWJsaW5ncyAocGFyZW50KSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcmVudC5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBpZiAocGFyZW50LmNoaWxkcmVuW2ldLnZhbHVlID09PSB0aGlzKSB7CiAgICAgICAgY29uc3QgW2xlZnQsIHJpZ2h0XSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgICAgICAgIGkgPyBwYXJlbnQuZ2V0Q2hpbGROb2RlKGkgLSAxKSA6IG51bGwsCiAgICAgICAgICBpIDwgcGFyZW50LmNoaWxkcmVuLmxlbmd0aCAtIDEgPyBwYXJlbnQuZ2V0Q2hpbGROb2RlKGkgKyAxKSA6IG51bGwKICAgICAgICBdKQogICAgICAgIHJldHVybiB7IGxlZnQsIGluZGV4OiBpLCByaWdodCB9CiAgICAgIH0KICAgIH0KCiAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhZCBwYXJlbnQnKQogIH0KCiAgbWVyZ2UgKG5vZGUsIG1lZGlhbikgewogICAgdGhpcy5jaGFuZ2VkID0gdHJ1ZQogICAgdGhpcy5rZXlzLnB1c2gobWVkaWFuKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLmtleXMubGVuZ3RoOyBpKyspIHRoaXMua2V5cy5wdXNoKG5vZGUua2V5c1tpXSkKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgdGhpcy5jaGlsZHJlbi5wdXNoKG5vZGUuY2hpbGRyZW5baV0pCiAgfQoKICBhc3luYyBzcGxpdCAoKSB7CiAgICBjb25zdCBsZW4gPSB0aGlzLmtleXMubGVuZ3RoID4+IDEKICAgIGNvbnN0IHJpZ2h0ID0gVHJlZU5vZGUuY3JlYXRlKHRoaXMuYmxvY2spCgogICAgd2hpbGUgKHJpZ2h0LmtleXMubGVuZ3RoIDwgbGVuKSByaWdodC5rZXlzLnB1c2godGhpcy5rZXlzLnBvcCgpKQogICAgcmlnaHQua2V5cy5yZXZlcnNlKCkKCiAgICBhd2FpdCB0aGlzLmdldEtleSh0aGlzLmtleXMubGVuZ3RoIC0gMSkgLy8gbWFrZSBzdXJlIHRoZSBtZWRpYW4gaXMgbG9hZGVkCiAgICBjb25zdCBtZWRpYW4gPSB0aGlzLmtleXMucG9wKCkKCiAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgd2hpbGUgKHJpZ2h0LmNoaWxkcmVuLmxlbmd0aCA8IGxlbiArIDEpIHJpZ2h0LmNoaWxkcmVuLnB1c2godGhpcy5jaGlsZHJlbi5wb3AoKSkKICAgICAgcmlnaHQuY2hpbGRyZW4ucmV2ZXJzZSgpCiAgICB9CgogICAgdGhpcy5jaGFuZ2VkID0gdHJ1ZQoKICAgIHJldHVybiB7CiAgICAgIGxlZnQ6IHRoaXMsCiAgICAgIG1lZGlhbiwKICAgICAgcmlnaHQKICAgIH0KICB9CgogIGdldEtleU5vZGUgKGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5ibG9jay50cmVlLmdldEJsb2NrKHRoaXMua2V5c1tpbmRleF0uc2VxKQogIH0KCiAgYXN5bmMgZ2V0Q2hpbGROb2RlIChpbmRleCkgewogICAgY29uc3QgY2hpbGQgPSB0aGlzLmNoaWxkcmVuW2luZGV4XQogICAgaWYgKGNoaWxkLnZhbHVlKSByZXR1cm4gY2hpbGQudmFsdWUKICAgIGNvbnN0IGJsb2NrID0gY2hpbGQuc2VxID09PSB0aGlzLmJsb2NrLnNlcSA/IHRoaXMuYmxvY2sgOiBhd2FpdCB0aGlzLmJsb2NrLnRyZWUuZ2V0QmxvY2soY2hpbGQuc2VxKQogICAgcmV0dXJuIChjaGlsZC52YWx1ZSA9IGJsb2NrLmdldFRyZWVOb2RlKGNoaWxkLm9mZnNldCkpCiAgfQoKICBzZXRLZXkgKGluZGV4LCBrZXkpIHsKICAgIHRoaXMua2V5c1tpbmRleF0gPSBrZXkKICAgIHRoaXMuY2hhbmdlZCA9IHRydWUKICB9CgogIGFzeW5jIGdldEtleSAoaW5kZXgpIHsKICAgIGNvbnN0IGtleSA9IHRoaXMua2V5c1tpbmRleF0KICAgIGlmIChrZXkudmFsdWUpIHJldHVybiBrZXkudmFsdWUKICAgIGNvbnN0IGsgPSBrZXkuc2VxID09PSB0aGlzLmJsb2NrLnNlcSA/IHRoaXMuYmxvY2sua2V5IDogYXdhaXQgdGhpcy5ibG9jay50cmVlLmdldEtleShrZXkuc2VxKQogICAgcmV0dXJuIChrZXkudmFsdWUgPSBrKQogIH0KCiAgaW5kZXhDaGFuZ2VzIChpbmRleCwgc2VxKSB7CiAgICBjb25zdCBvZmZzZXQgPSBpbmRleC5wdXNoKG51bGwpIC0gMQogICAgdGhpcy5jaGFuZ2VkID0gZmFsc2UKCiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRoaXMuY2hpbGRyZW4pIHsKICAgICAgaWYgKCFjaGlsZC52YWx1ZSB8fCAhY2hpbGQudmFsdWUuY2hhbmdlZCkgY29udGludWUKICAgICAgY2hpbGQuc2VxID0gc2VxCiAgICAgIGNoaWxkLm9mZnNldCA9IGNoaWxkLnZhbHVlLmluZGV4Q2hhbmdlcyhpbmRleCwgc2VxKQogICAgICBpbmRleFtjaGlsZC5vZmZzZXRdID0gY2hpbGQKICAgIH0KCiAgICByZXR1cm4gb2Zmc2V0CiAgfQoKICB1cGRhdGVDaGlsZHJlbiAoc2VxLCBibG9jaykgewogICAgZm9yIChjb25zdCBjaGlsZCBvZiB0aGlzLmNoaWxkcmVuKSB7CiAgICAgIGlmICghY2hpbGQudmFsdWUgfHwgY2hpbGQuc2VxICE9PSBzZXEpIGNvbnRpbnVlCiAgICAgIGNoaWxkLnZhbHVlLmJsb2NrID0gYmxvY2sKICAgICAgY2hpbGQudmFsdWUudXBkYXRlQ2hpbGRyZW4oc2VxLCBibG9jaykKICAgIH0KICB9CgogIHN0YXRpYyBjcmVhdGUgKGJsb2NrKSB7CiAgICBjb25zdCBub2RlID0gbmV3IFRyZWVOb2RlKGJsb2NrLCBbXSwgW10sIDApCiAgICBub2RlLmNoYW5nZWQgPSB0cnVlCiAgICByZXR1cm4gbm9kZQogIH0KfQoKY2xhc3MgQmxvY2tFbnRyeSB7CiAgY29uc3RydWN0b3IgKHNlcSwgdHJlZSwgZW50cnkpIHsKICAgIHRoaXMuc2VxID0gc2VxCiAgICB0aGlzLnRyZWUgPSB0cmVlCiAgICB0aGlzLmluZGV4ID0gbnVsbAogICAgdGhpcy5lbnRyeSA9IGVudHJ5CiAgICB0aGlzLmtleSA9IGVudHJ5LmtleQogICAgdGhpcy52YWx1ZSA9IGVudHJ5LnZhbHVlCiAgfQoKICBpc1RhcmdldCAoa2V5KSB7CiAgICByZXR1cm4gYjRhLmVxdWFscyh0aGlzLmtleSwga2V5KQogIH0KCiAgaW5mbGF0ZSAoKSB7CiAgICBpZiAodGhpcy5pbmRleCA9PT0gbnVsbCkgewogICAgICB0aGlzLmluZGV4ID0gaW5mbGF0ZSh0aGlzLmVudHJ5KQogICAgfQogIH0KCiAgaXNEZWxldGlvbiAoKSB7CiAgICBpZiAodGhpcy52YWx1ZSAhPT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogICAgaWYgKHRoaXMuaW5kZXggPT09IG51bGwpIHsKICAgICAgdGhpcy5pbmRleCA9IGluZmxhdGUodGhpcy5lbnRyeSkKICAgIH0KCiAgICByZXR1cm4gIXRoaXMuaW5kZXguaGFzS2V5KHRoaXMuc2VxKQogIH0KCiAgZmluYWwgKGVuY29kaW5nKSB7CiAgICByZXR1cm4gewogICAgICBzZXE6IHRoaXMuc2VxLAogICAgICBrZXk6IGVuY29kaW5nLmtleSA/IGVuY29kaW5nLmtleS5kZWNvZGUodGhpcy5rZXkpIDogdGhpcy5rZXksCiAgICAgIHZhbHVlOiB0aGlzLnZhbHVlICYmIChlbmNvZGluZy52YWx1ZSA/IGVuY29kaW5nLnZhbHVlLmRlY29kZSh0aGlzLnZhbHVlKSA6IHRoaXMudmFsdWUpCiAgICB9CiAgfQoKICBnZXRUcmVlTm9kZSAob2Zmc2V0KSB7CiAgICBpZiAodGhpcy5pbmRleCA9PT0gbnVsbCkgewogICAgICB0aGlzLmluZGV4ID0gaW5mbGF0ZSh0aGlzLmVudHJ5KQogICAgfQogICAgY29uc3QgZW50cnkgPSB0aGlzLmluZGV4LmdldChvZmZzZXQpCiAgICByZXR1cm4gbmV3IFRyZWVOb2RlKHRoaXMsIGVudHJ5LmtleXMsIGVudHJ5LmNoaWxkcmVuLCBvZmZzZXQpCiAgfQp9CgpjbGFzcyBDYWNoZUxvY2sgewogIGNvbnN0cnVjdG9yICgpIHsKICAgIHRoaXMubWFwID0gbmV3IE1hcCgpCiAgfQoKICBlbnRlciAoc2VxKSB7CiAgICBjb25zdCBwZW5kaW5nID0gdGhpcy5tYXAuZ2V0KHNlcSkKCiAgICBpZiAoIXBlbmRpbmcpIHsKICAgICAgdGhpcy5tYXAuc2V0KHNlcSwgW10pCiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQogICAgfQoKICAgIGNvbnN0IHsgcmVzb2x2ZSwgcHJvbWlzZSB9ID0gcnJwKCkKICAgIHBlbmRpbmcucHVzaChyZXNvbHZlKQogICAgcmV0dXJuIHByb21pc2UKICB9CgogIGV4aXQgKHNlcSkgewogICAgY29uc3QgcGVuZGluZyA9IHRoaXMubWFwLmdldChzZXEpCiAgICBpZiAoIXBlbmRpbmcubGVuZ3RoKSB7CiAgICAgIHRoaXMubWFwLmRlbGV0ZShzZXEpCiAgICAgIHJldHVybgogICAgfQoKICAgIHBlbmRpbmcucG9wKCkoKQogIH0KfQoKY2xhc3MgQmF0Y2hFbnRyeSBleHRlbmRzIEJsb2NrRW50cnkgewogIGNvbnN0cnVjdG9yIChzZXEsIHRyZWUsIGtleSwgdmFsdWUsIGluZGV4KSB7CiAgICBzdXBlcihzZXEsIHRyZWUsIHsga2V5LCB2YWx1ZSwgaW5kZXg6IG51bGwsIGluZmxhdGVkOiBudWxsIH0pCiAgICB0aGlzLnBlbmRpbmdJbmRleCA9IGluZGV4CiAgfQoKICBpc1RhcmdldCAoa2V5KSB7CiAgICByZXR1cm4gZmFsc2UKICB9CgogIGdldFRyZWVOb2RlIChvZmZzZXQpIHsKICAgIHJldHVybiB0aGlzLnBlbmRpbmdJbmRleFtvZmZzZXRdLnZhbHVlCiAgfQp9CgpjbGFzcyBIeXBlcmJlZSBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yIChjb3JlLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKICAgIC8vIHRoaXMuZmVlZCBpcyBub3cgZGVwcmVjYXRlZCwgYW5kIHdpbGwgYmUgdGhpcy5jb3JlIGdvaW5nIGZvcndhcmQKICAgIHRoaXMuZmVlZCA9IGNvcmUKICAgIHRoaXMuY29yZSA9IGNvcmUKCiAgICB0aGlzLmtleUVuY29kaW5nID0gb3B0cy5rZXlFbmNvZGluZyA/IGNvZGVjcyhvcHRzLmtleUVuY29kaW5nKSA6IG51bGwKICAgIHRoaXMudmFsdWVFbmNvZGluZyA9IG9wdHMudmFsdWVFbmNvZGluZyA/IGNvZGVjcyhvcHRzLnZhbHVlRW5jb2RpbmcpIDogbnVsbAogICAgdGhpcy5leHRlbnNpb24gPSBvcHRzLmV4dGVuc2lvbiAhPT0gZmFsc2UgPyBnZXRFeHRlbnNpb24odGhpcywgb3B0cykgOiBudWxsCiAgICB0aGlzLm1ldGFkYXRhID0gb3B0cy5tZXRhZGF0YSB8fCBudWxsCiAgICB0aGlzLmxvY2sgPSBvcHRzLmxvY2sgfHwgbXV0ZXhpZnkoKQogICAgdGhpcy5zZXAgPSBvcHRzLnNlcCB8fCBTRVAKICAgIHRoaXMucmVhZG9ubHkgPSAhIW9wdHMucmVhZG9ubHkKICAgIHRoaXMucHJlZml4ID0gb3B0cy5wcmVmaXggfHwgbnVsbAoKICAgIC8vIEluIGEgZnV0dXJlIHZlcnNpb24sIHRoaXMgc2hvdWxkIGJlIGZhbHNlIGJ5IGRlZmF1bHQKICAgIHRoaXMuYWx3YXlzRHVwbGljYXRlID0gb3B0cy5hbHdheXNEdXBsaWNhdGUgIT09IGZhbHNlCgogICAgdGhpcy5fdW5wcmVmaXhlZEtleUVuY29kaW5nID0gdGhpcy5rZXlFbmNvZGluZwogICAgdGhpcy5fc3ViID0gISF0aGlzLnByZWZpeAogICAgdGhpcy5fY2hlY2tvdXQgPSBvcHRzLmNoZWNrb3V0IHx8IDAKICAgIHRoaXMuX3ZpZXcgPSAhIW9wdHMuX3ZpZXcKCiAgICB0aGlzLl9vbmFwcGVuZEJvdW5kID0gdGhpcy5fdmlldyA/IG51bGwgOiB0aGlzLl9vbmFwcGVuZC5iaW5kKHRoaXMpCiAgICB0aGlzLl9vbnRydW5jYXRlQm91bmQgPSB0aGlzLl92aWV3ID8gbnVsbCA6IHRoaXMuX29udHJ1bmNhdGUuYmluZCh0aGlzKQogICAgdGhpcy5fd2F0Y2hlcnMgPSB0aGlzLl9vbmFwcGVuZEJvdW5kID8gW10gOiBudWxsCiAgICB0aGlzLl9lbnRyeVdhdGNoZXJzID0gdGhpcy5fb25hcHBlbmRCb3VuZCA/IFtdIDogbnVsbAogICAgdGhpcy5fc2Vzc2lvbnMgPSBvcHRzLnNlc3Npb25zICE9PSBmYWxzZQoKICAgIHRoaXMuX2tleUNhY2hlID0gbnVsbAogICAgdGhpcy5fbm9kZUNhY2hlID0gbnVsbAogICAgdGhpcy5fY2FjaGVMb2NrID0gbmV3IENhY2hlTG9jaygpCgogICAgdGhpcy5fYmF0Y2hlcyA9IFtdCgogICAgaWYgKHRoaXMuX3dhdGNoZXJzKSB7CiAgICAgIHRoaXMuY29yZS5vbignYXBwZW5kJywgdGhpcy5fb25hcHBlbmRCb3VuZCkKICAgICAgdGhpcy5jb3JlLm9uKCd0cnVuY2F0ZScsIHRoaXMuX29udHJ1bmNhdGVCb3VuZCkKICAgIH0KCiAgICBpZiAodGhpcy5wcmVmaXggJiYgb3B0cy5fc3ViKSB7CiAgICAgIHRoaXMua2V5RW5jb2RpbmcgPSBwcmVmaXhFbmNvZGluZyh0aGlzLnByZWZpeCwgdGhpcy5rZXlFbmNvZGluZykKICAgIH0KCiAgICB0aGlzLnJlYWR5KCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgfQoKICBhc3luYyBfb3BlbiAoKSB7CiAgICBpZiAodGhpcy5jb3JlLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCgogICAgLy8gc25hcHNob3QKICAgIGlmICh0aGlzLl9jaGVja291dCA9PT0gLTEpIHRoaXMuX2NoZWNrb3V0ID0gTWF0aC5tYXgoMSwgdGhpcy5jb3JlLmxlbmd0aCkKCiAgICBjb25zdCBiYXNlQ2FjaGUgPSBSYWNoZS5mcm9tKHRoaXMuY29yZS5nbG9iYWxDYWNoZSkKICAgIHRoaXMuX2tleUNhY2hlID0gbmV3IENhY2hlKGJhc2VDYWNoZSkKICAgIHRoaXMuX25vZGVDYWNoZSA9IG5ldyBDYWNoZShSYWNoZS5mcm9tKGJhc2VDYWNoZSkpCiAgfQoKICBnZXQgdmVyc2lvbiAoKSB7CiAgICByZXR1cm4gTWF0aC5tYXgoMSwgdGhpcy5fY2hlY2tvdXQgfHwgdGhpcy5jb3JlLmxlbmd0aCkKICB9CgogIGdldCBpZCAoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLmlkCiAgfQoKICBnZXQga2V5ICgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUua2V5CiAgfQoKICBnZXQgZGlzY292ZXJ5S2V5ICgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5CiAgfQoKICBnZXQgd3JpdGFibGUgKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS53cml0YWJsZQogIH0KCiAgZ2V0IHJlYWRhYmxlICgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUucmVhZGFibGUKICB9CgogIHJlcGxpY2F0ZSAoaXNJbml0aWF0b3IsIG9wdHMpIHsKICAgIHJldHVybiB0aGlzLmNvcmUucmVwbGljYXRlKGlzSW5pdGlhdG9yLCBvcHRzKQogIH0KCiAgdXBkYXRlIChvcHRzKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLnVwZGF0ZShvcHRzKQogIH0KCiAgcGVlayAocmFuZ2UsIG9wdHMpIHsKICAgIHJldHVybiBpdGVyYXRvclBlZWsodGhpcy5jcmVhdGVSYW5nZUl0ZXJhdG9yKHJhbmdlLCB7IC4uLm9wdHMsIGxpbWl0OiAxIH0pKQogIH0KCiAgY3JlYXRlUmFuZ2VJdGVyYXRvciAocmFuZ2UsIG9wdHMgPSB7fSkgewogICAgLy8gYmFja3dhcmRzIGNvbXBhdCByYW5nZSBhcmcKICAgIG9wdHMgPSBvcHRzID8geyAuLi5vcHRzLCAuLi5yYW5nZSB9IDogcmFuZ2UKCiAgICBjb25zdCBleHRlbnNpb24gPSAob3B0cy5leHRlbnNpb24gPT09IGZhbHNlICYmIG9wdHMubGltaXQgIT09IDApID8gbnVsbCA6IHRoaXMuZXh0ZW5zaW9uCiAgICBjb25zdCBrZXlFbmNvZGluZyA9IG9wdHMua2V5RW5jb2RpbmcgPyBjb2RlY3Mob3B0cy5rZXlFbmNvZGluZykgOiB0aGlzLmtleUVuY29kaW5nCgogICAgaWYgKGV4dGVuc2lvbikgewogICAgICBjb25zdCB7IG9uc2VxLCBvbndhaXQgfSA9IG9wdHMKICAgICAgbGV0IHZlcnNpb24gPSAwCiAgICAgIGxldCBuZXh0ID0gMAoKICAgICAgb3B0cyA9IGVuY1JhbmdlKGtleUVuY29kaW5nLCB7CiAgICAgICAgLi4ub3B0cywKICAgICAgICBzdWI6IHRoaXMuX3N1YiwKICAgICAgICBvbnNlcSAoc2VxKSB7CiAgICAgICAgICBpZiAoIXZlcnNpb24pIHZlcnNpb24gPSBzZXEgKyAxCiAgICAgICAgICBpZiAobmV4dCkgbmV4dC0tCiAgICAgICAgICBpZiAob25zZXEpIG9uc2VxKHNlcSkKICAgICAgICB9LAogICAgICAgIG9ud2FpdCAoc2VxKSB7CiAgICAgICAgICBpZiAoIW5leHQpIHsKICAgICAgICAgICAgbmV4dCA9IEV4dGVuc2lvbi5CQVRDSF9TSVpFCiAgICAgICAgICAgIGV4dGVuc2lvbi5pdGVyYXRvcihpdGUuc25hcHNob3QodmVyc2lvbikpCiAgICAgICAgICB9CiAgICAgICAgICBpZiAob253YWl0KSBvbndhaXQoc2VxKQogICAgICAgIH0KICAgICAgfSkKICAgIH0gZWxzZSB7CiAgICAgIG9wdHMgPSBlbmNSYW5nZShrZXlFbmNvZGluZywgeyAuLi5vcHRzLCBzdWI6IHRoaXMuX3N1YiB9KQogICAgfQoKICAgIGNvbnN0IGl0ZSA9IG5ldyBSYW5nZUl0ZXJhdG9yKG5ldyBCYXRjaCh0aGlzLCB0aGlzLl9tYWtlU25hcHNob3QoKSwgbnVsbCwgZmFsc2UsIG9wdHMpLCBudWxsLCBvcHRzKQogICAgcmV0dXJuIGl0ZQogIH0KCiAgY3JlYXRlUmVhZFN0cmVhbSAocmFuZ2UsIG9wdHMpIHsKICAgIGNvbnN0IHNpZ25hbCA9IChvcHRzICYmIG9wdHMuc2lnbmFsKSB8fCBudWxsCiAgICByZXR1cm4gaXRlcmF0b3JUb1N0cmVhbSh0aGlzLmNyZWF0ZVJhbmdlSXRlcmF0b3IocmFuZ2UsIG9wdHMpLCBzaWduYWwpCiAgfQoKICBjcmVhdGVIaXN0b3J5U3RyZWFtIChvcHRzKSB7CiAgICBjb25zdCBzZXNzaW9uID0gKG9wdHMgJiYgb3B0cy5saXZlKSA/IHRoaXMuY29yZS5zZXNzaW9uKCkgOiB0aGlzLl9tYWtlU25hcHNob3QoKQogICAgY29uc3Qgc2lnbmFsID0gKG9wdHMgJiYgb3B0cy5zaWduYWwpIHx8IG51bGwKICAgIHJldHVybiBpdGVyYXRvclRvU3RyZWFtKG5ldyBIaXN0b3J5SXRlcmF0b3IobmV3IEJhdGNoKHRoaXMsIHNlc3Npb24sIG51bGwsIGZhbHNlLCBvcHRzKSwgb3B0cyksIHNpZ25hbCkKICB9CgogIGNyZWF0ZURpZmZTdHJlYW0gKHJpZ2h0LCByYW5nZSwgb3B0cykgewogICAgaWYgKHR5cGVvZiByaWdodCA9PT0gJ251bWJlcicpIHJpZ2h0ID0gdGhpcy5jaGVja291dChNYXRoLm1heCgxLCByaWdodCksIHsgcmV1c2VTZXNzaW9uOiB0cnVlIH0pCgogICAgLy8gYmFja3dhcmRzIGNvbXBhdCByYW5nZSBhcmcKICAgIG9wdHMgPSBvcHRzID8geyAuLi5vcHRzLCAuLi5yYW5nZSB9IDogcmFuZ2UKCiAgICBjb25zdCBzaWduYWwgPSAob3B0cyAmJiBvcHRzLnNpZ25hbCkgfHwgbnVsbAoKICAgIGNvbnN0IGtleUVuY29kaW5nID0gb3B0cyAmJiBvcHRzLmtleUVuY29kaW5nID8gY29kZWNzKG9wdHMua2V5RW5jb2RpbmcpIDogdGhpcy5rZXlFbmNvZGluZwogICAgaWYgKGtleUVuY29kaW5nKSBvcHRzID0gZW5jUmFuZ2Uoa2V5RW5jb2RpbmcsIHsgLi4ub3B0cywgc3ViOiB0aGlzLl9zdWIgfSkKCiAgICBsZXQgZG9uZQogICAgbGV0IGNsb3NpbmcKICAgIGxldCBpdGUKCiAgICBjb25zdCBsZWZ0ID0gdGhpcwoKICAgIGNvbnN0IHJzID0gbmV3IFJlYWRhYmxlKHsKICAgICAgc2lnbmFsLAogICAgICBlYWdlck9wZW46IHRydWUsCiAgICAgIGFzeW5jIG9wZW4gKGNiKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmIChyaWdodC5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCByaWdodC5yZWFkeSgpCiAgICAgICAgICBpZiAobGVmdC5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCBsZWZ0LnJlYWR5KCkKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIGNiKGVycikKICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgaWYgKGNsb3NpbmcpIHsKICAgICAgICAgIGNiKG51bGwpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIGlmIChsZWZ0LmNvcmUuY2xvc2luZyB8fCByaWdodC5jb3JlLmNsb3NpbmcpIHsKICAgICAgICAgIGNiKG5ldyBFcnJvcignQmVlIGNsb3NlZCcpKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQoKICAgICAgICBjb25zdCBzbmFwc2hvdCA9IHJpZ2h0LnZlcnNpb24gPiBsZWZ0LnZlcnNpb24KICAgICAgICAgID8gcmlnaHQuX21ha2VTbmFwc2hvdCgpCiAgICAgICAgICA6IGxlZnQuX21ha2VTbmFwc2hvdCgpCgogICAgICAgIGRvbmUgPSBjYgogICAgICAgIGl0ZSA9IG5ldyBEaWZmSXRlcmF0b3IoCiAgICAgICAgICBuZXcgQmF0Y2gobGVmdCwgc25hcHNob3QsIG51bGwsIGZhbHNlLCBvcHRzKSwKICAgICAgICAgIG5ldyBCYXRjaChyaWdodCwgc25hcHNob3QsIG51bGwsIGZhbHNlLCBvcHRzKSwKICAgICAgICAgIG9wdHMKICAgICAgICApCiAgICAgICAgaXRlLm9wZW4oKS50aGVuKGZpbiwgZmluKQogICAgICB9LAogICAgICByZWFkIChjYikgewogICAgICAgIGRvbmUgPSBjYgogICAgICAgIGl0ZS5uZXh0KCkudGhlbihwdXNoLCBmaW4pCiAgICAgIH0sCiAgICAgIHByZWRlc3Ryb3kgKCkgewogICAgICAgIGlmICghaXRlKSB7CiAgICAgICAgICBjbG9zaW5nID0gUHJvbWlzZS5yZXNvbHZlKCkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2xvc2luZyA9IGl0ZS5jbG9zZSgpCiAgICAgICAgICBjbG9zaW5nLmNhdGNoKG5vb3ApCiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95IChjYikgewogICAgICAgIGRvbmUgPSBjYgogICAgICAgIGlmICghY2xvc2luZykgY2xvc2luZyA9IGl0ZS5jbG9zZSgpCiAgICAgICAgY2xvc2luZy50aGVuKGZpbiwgZmluKQogICAgICB9CiAgICB9KQoKICAgIHJldHVybiBycwoKICAgIGZ1bmN0aW9uIGZpbiAoZXJyKSB7CiAgICAgIGRvbmUoZXJyKQogICAgfQoKICAgIGZ1bmN0aW9uIHB1c2ggKHZhbCkgewogICAgICBycy5wdXNoKHZhbCkKICAgICAgZG9uZShudWxsKQogICAgfQogIH0KCiAgZ2V0IChrZXksIG9wdHMpIHsKICAgIGNvbnN0IGIgPSBuZXcgQmF0Y2godGhpcywgdGhpcy5fbWFrZVNuYXBzaG90KCksIG51bGwsIHRydWUsIG9wdHMpCiAgICByZXR1cm4gYi5nZXQoa2V5KQogIH0KCiAgZ2V0QnlTZXEgKHNlcSwgb3B0cykgewogICAgY29uc3QgYiA9IG5ldyBCYXRjaCh0aGlzLCB0aGlzLl9tYWtlU25hcHNob3QoKSwgbnVsbCwgdHJ1ZSwgb3B0cykKICAgIHJldHVybiBiLmdldEJ5U2VxKHNlcSkKICB9CgogIHB1dCAoa2V5LCB2YWx1ZSwgb3B0cykgewogICAgY29uc3QgYiA9IG5ldyBCYXRjaCh0aGlzLCB0aGlzLmNvcmUsIG51bGwsIHRydWUsIG9wdHMpCiAgICByZXR1cm4gYi5wdXQoa2V5LCB2YWx1ZSwgb3B0cykKICB9CgogIGJhdGNoIChvcHRzKSB7CiAgICByZXR1cm4gbmV3IEJhdGNoKHRoaXMsIHRoaXMuY29yZSwgbXV0ZXhpZnkoKSwgdHJ1ZSwgb3B0cykKICB9CgogIGRlbCAoa2V5LCBvcHRzKSB7CiAgICBjb25zdCBiID0gbmV3IEJhdGNoKHRoaXMsIHRoaXMuY29yZSwgbnVsbCwgdHJ1ZSwgb3B0cykKICAgIHJldHVybiBiLmRlbChrZXksIG9wdHMpCiAgfQoKICB3YXRjaCAocmFuZ2UsIG9wdHMpIHsKICAgIGlmICghdGhpcy5fd2F0Y2hlcnMpIHRocm93IG5ldyBFcnJvcignQ2FuIG9ubHkgd2F0Y2ggdGhlIG1haW4gYmVlIGluc3RhbmNlJykKICAgIHJldHVybiBuZXcgV2F0Y2hlcih0aGlzLCByYW5nZSwgb3B0cykKICB9CgogIGFzeW5jIGdldEFuZFdhdGNoIChrZXksIG9wdHMpIHsKICAgIGlmICghdGhpcy5fd2F0Y2hlcnMpIHRocm93IG5ldyBFcnJvcignQ2FuIG9ubHkgd2F0Y2ggdGhlIG1haW4gYmVlIGluc3RhbmNlJykKCiAgICBjb25zdCB3YXRjaGVyID0gbmV3IEVudHJ5V2F0Y2hlcih0aGlzLCBrZXksIG9wdHMpCiAgICBhd2FpdCB3YXRjaGVyLl9kZWJvdW5jZWRVcGRhdGUoKQoKICAgIGlmICh0aGlzLmNsb3NpbmcpIHsKICAgICAgYXdhaXQgd2F0Y2hlci5jbG9zZSgpCiAgICAgIHRocm93IG5ldyBFcnJvcignQmVlIGNsb3NlZCcpCiAgICB9CgogICAgcmV0dXJuIHdhdGNoZXIKICB9CgogIF9vbmFwcGVuZCAoKSB7CiAgICBmb3IgKGNvbnN0IHdhdGNoZXIgb2YgdGhpcy5fd2F0Y2hlcnMpIHsKICAgICAgd2F0Y2hlci5fb25hcHBlbmQoKQogICAgfQoKICAgIGZvciAoY29uc3Qgd2F0Y2hlciBvZiB0aGlzLl9lbnRyeVdhdGNoZXJzKSB7CiAgICAgIHdhdGNoZXIuX29uYXBwZW5kKCkKICAgIH0KICB9CgogIF9vbnRydW5jYXRlIChsZW5ndGgpIHsKICAgIGZvciAoY29uc3Qgd2F0Y2hlciBvZiB0aGlzLl93YXRjaGVycykgewogICAgICB3YXRjaGVyLl9vbnRydW5jYXRlKCkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHdhdGNoZXIgb2YgdGhpcy5fZW50cnlXYXRjaGVycykgewogICAgICB3YXRjaGVyLl9vbnRydW5jYXRlKCkKICAgIH0KCiAgICB0aGlzLl9ub2RlQ2FjaGUuZ2MobGVuZ3RoKQogICAgdGhpcy5fa2V5Q2FjaGUuZ2MobGVuZ3RoKQogIH0KCiAgX21ha2VTbmFwc2hvdCAoKSB7CiAgICBpZiAodGhpcy5fc2Vzc2lvbnMgPT09IGZhbHNlKSByZXR1cm4gdGhpcy5jb3JlCiAgICAvLyBUT0RPOiBiZXR0ZXIgaWYgd2UgY291bGQgZW5jYXBzdWxhdGUgdGhpcyBpbiBoeXBlcmNvcmUgaW4gdGhlIGZ1dHVyZQogICAgcmV0dXJuICh0aGlzLl9jaGVja291dCA8PSB0aGlzLmNvcmUubGVuZ3RoIHx8IHRoaXMuX2NoZWNrb3V0IDw9IDEpID8gdGhpcy5jb3JlLnNuYXBzaG90KCkgOiB0aGlzLmNvcmUuc2Vzc2lvbih7IHNuYXBzaG90OiBmYWxzZSB9KQogIH0KCiAgYXN5bmMgY2xlYXJVbmxpbmtlZCAob3B0aW9ucyA9IHt9KSB7CiAgICBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICBjb25zdCB7IGd0ZSA9IDAsIGx0ID0gdGhpcy52ZXJzaW9uIC0gMSwgYmF0Y2hTaXplID0gNDA5Niwgd2FpdCA9IHRydWUgfSA9IG9wdGlvbnMKICAgIGNvbnN0IGNoZWNrb3V0ID0gdGhpcy52ZXJzaW9uCgogICAgbGV0IHByZXYgPSB0aGlzLmJhdGNoKHsgd2FpdDogZmFsc2UsIGNoZWNrb3V0OiBndGUgfSkKICAgIGxldCBiID0gdGhpcy5iYXRjaCh7IHdhaXQsIGNoZWNrb3V0IH0pCgogICAgY29uc3QgaXRlQmF0Y2ggPSB0aGlzLmJhdGNoKHsgd2FpdDogZmFsc2UsIGNoZWNrb3V0IH0pCiAgICBjb25zdCBpdGUgPSBuZXcgTG9jYWxCbG9ja0l0ZXJhdG9yKGl0ZUJhdGNoLCB7IGd0ZSwgbHQgfSkKICAgIGF3YWl0IGl0ZS5vcGVuKCkKCiAgICBsZXQgdGlja3MgPSAwCgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IGl0ZS5uZXh0KCkKICAgICAgaWYgKCFkYXRhKSBicmVhawoKICAgICAgaWYgKCEoYXdhaXQgaXNMaW5rZWQoYiwgZGF0YSkpKSB7CiAgICAgICAgaWYgKGIuY29yZS5jbG9zaW5nIHx8IHRoaXMuY29yZS5jbG9zaW5nIHx8IHRoaXMuY2xvc2luZykgYnJlYWsKICAgICAgICBhd2FpdCB0aGlzLmNvcmUuY2xlYXIoZGF0YS5zZXEpCiAgICAgIH0KCiAgICAgIGNvbnN0IHByZXZOb2RlID0gYXdhaXQgcHJldi5nZXQoZGF0YS5rZXksIHsgZmluYWxpemU6IGZhbHNlIH0pLmNhdGNoKHRvTnVsbCkKCiAgICAgIGlmIChwcmV2Tm9kZSAmJiAhKGF3YWl0IGlzTGlua2VkKGIsIHByZXZOb2RlKSkpIHsKICAgICAgICBpZiAoYi5jb3JlLmNsb3NpbmcgfHwgdGhpcy5jb3JlLmNsb3NpbmcgfHwgdGhpcy5jbG9zaW5nKSBicmVhawogICAgICAgIGF3YWl0IHRoaXMuY29yZS5jbGVhcihwcmV2Tm9kZS5zZXEpCiAgICAgIH0KCiAgICAgIGlmICh0aWNrcysrID49IGJhdGNoU2l6ZSkgewogICAgICAgIHRpY2tzID0gMAogICAgICAgIGF3YWl0IHByZXYuY2xvc2UoKQogICAgICAgIGF3YWl0IGIuY2xvc2UoKQoKICAgICAgICBwcmV2ID0gdGhpcy5iYXRjaCh7IHdhaXQ6IGZhbHNlLCBjaGVja291dDogZ3RlIH0pCiAgICAgICAgYiA9IHRoaXMuYmF0Y2goeyB3YWl0LCBjaGVja291dCB9KQogICAgICB9CiAgICB9CgogICAgaWYgKGIuY29yZS5jbG9zaW5nIHx8IHRoaXMuY29yZS5jbG9zaW5nIHx8IHRoaXMuY2xvc2luZykgdGhyb3cgbmV3IEVycm9yKCdDb3JlIGlzIGNsb3NlZCcpCgogICAgYXdhaXQgYi5jbG9zZSgpCiAgICBhd2FpdCBwcmV2LmNsb3NlKCkKICAgIGF3YWl0IGl0ZS5jbG9zZSgpCiAgICBhd2FpdCBpdGVCYXRjaC5jbG9zZSgpCgogICAgcmV0dXJuIGx0CiAgfQoKICBjaGVja291dCAodmVyc2lvbiwgb3B0cyA9IHt9KSB7CiAgICBpZiAodmVyc2lvbiA9PT0gMCkgdmVyc2lvbiA9IDEKCiAgICAvLyBzYW1lIGFzIGFib3ZlLCBqdXN0IGNoZWNrb3V0IGlzbid0IHNldCB5ZXQuLi4KICAgIGNvbnN0IHNuYXAgPSAob3B0cy5yZXVzZVNlc3Npb24gfHwgdGhpcy5fc2Vzc2lvbnMgPT09IGZhbHNlKQogICAgICA/IHRoaXMuY29yZQogICAgICA6ICh2ZXJzaW9uIDw9IHRoaXMuY29yZS5sZW5ndGggfHwgdmVyc2lvbiA8PSAxKSA/IHRoaXMuY29yZS5zbmFwc2hvdCgpIDogdGhpcy5jb3JlLnNlc3Npb24oeyBzbmFwc2hvdDogZmFsc2UgfSkKCiAgICByZXR1cm4gbmV3IEh5cGVyYmVlKHNuYXAsIHsKICAgICAgX3ZpZXc6IHRydWUsCiAgICAgIF9zdWI6IGZhbHNlLAogICAgICBwcmVmaXg6IHRoaXMucHJlZml4LAogICAgICBzZXA6IHRoaXMuc2VwLAogICAgICBsb2NrOiB0aGlzLmxvY2ssCiAgICAgIGNoZWNrb3V0OiB2ZXJzaW9uLAogICAgICBrZXlFbmNvZGluZzogb3B0cy5rZXlFbmNvZGluZyB8fCB0aGlzLmtleUVuY29kaW5nLAogICAgICB2YWx1ZUVuY29kaW5nOiBvcHRzLnZhbHVlRW5jb2RpbmcgfHwgdGhpcy52YWx1ZUVuY29kaW5nLAogICAgICBleHRlbnNpb246IHRoaXMuZXh0ZW5zaW9uICE9PSBudWxsID8gdGhpcy5leHRlbnNpb24gOiBmYWxzZQogICAgfSkKICB9CgogIHNuYXBzaG90IChvcHRzKSB7CiAgICByZXR1cm4gdGhpcy5jaGVja291dCgodGhpcy5jb3JlLm9wZW5lZCA9PT0gZmFsc2UgfHwgdGhpcy5fY2hlY2tvdXQgPD0gMCkgPyAtMSA6IE1hdGgubWF4KDEsIHRoaXMudmVyc2lvbiksIG9wdHMpCiAgfQoKICBzdWIgKHByZWZpeCwgb3B0cyA9IHt9KSB7CiAgICBsZXQgc2VwID0gb3B0cy5zZXAgfHwgdGhpcy5zZXAKICAgIGlmICghYjRhLmlzQnVmZmVyKHNlcCkpIHNlcCA9IGI0YS5mcm9tKHNlcCkKCiAgICBwcmVmaXggPSBiNGEuY29uY2F0KFt0aGlzLnByZWZpeCB8fCBFTVBUWSwgYjRhLmZyb20ocHJlZml4KSwgc2VwXSkKCiAgICBjb25zdCB2YWx1ZUVuY29kaW5nID0gY29kZWNzKG9wdHMudmFsdWVFbmNvZGluZyB8fCB0aGlzLnZhbHVlRW5jb2RpbmcpCiAgICBjb25zdCBrZXlFbmNvZGluZyA9IGNvZGVjcyhvcHRzLmtleUVuY29kaW5nIHx8IHRoaXMuX3VucHJlZml4ZWRLZXlFbmNvZGluZykKCiAgICByZXR1cm4gbmV3IEh5cGVyYmVlKHRoaXMuY29yZSwgewogICAgICBfdmlldzogdHJ1ZSwKICAgICAgX3N1YjogdHJ1ZSwKICAgICAgcHJlZml4LAogICAgICBzZXA6IHRoaXMuc2VwLAogICAgICBsb2NrOiB0aGlzLmxvY2ssCiAgICAgIGNoZWNrb3V0OiB0aGlzLl9jaGVja291dCwKICAgICAgdmFsdWVFbmNvZGluZywKICAgICAga2V5RW5jb2RpbmcsCiAgICAgIGV4dGVuc2lvbjogdGhpcy5leHRlbnNpb24gIT09IG51bGwgPyB0aGlzLmV4dGVuc2lvbiA6IGZhbHNlLAogICAgICBtZXRhZGF0YTogdGhpcy5tZXRhZGF0YQogICAgfSkKICB9CgogIGFzeW5jIGdldEhlYWRlciAob3B0cykgewogICAgY29uc3QgYmxrID0gYXdhaXQgdGhpcy5jb3JlLmdldCgwLCBvcHRzKQogICAgdHJ5IHsKICAgICAgcmV0dXJuIGJsayAmJiBIZWFkZXIuZGVjb2RlKGJsaykKICAgIH0gY2F0Y2ggewogICAgICB0aHJvdyBERUNPRElOR19FUlJPUigpCiAgICB9CiAgfQoKICBhc3luYyBfY2xvc2UgKCkgewogICAgaWYgKCF0aGlzLl92aWV3KSB7CiAgICAgIGlmICh0aGlzLl9rZXlDYWNoZSkgdGhpcy5fa2V5Q2FjaGUuY2xlYXIoKQogICAgICBpZiAodGhpcy5fbm9kZUNhY2hlKSB0aGlzLl9ub2RlQ2FjaGUuY2xlYXIoKQogICAgfQoKICAgIGlmICh0aGlzLl93YXRjaGVycykgewogICAgICB0aGlzLmNvcmUub2ZmKCdhcHBlbmQnLCB0aGlzLl9vbmFwcGVuZEJvdW5kKQogICAgICB0aGlzLmNvcmUub2ZmKCd0cnVuY2F0ZScsIHRoaXMuX29udHJ1bmNhdGVCb3VuZCkKCiAgICAgIHdoaWxlICh0aGlzLl93YXRjaGVycy5sZW5ndGgpIHsKICAgICAgICBhd2FpdCB0aGlzLl93YXRjaGVyc1t0aGlzLl93YXRjaGVycy5sZW5ndGggLSAxXS5jbG9zZSgpCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5fZW50cnlXYXRjaGVycykgewogICAgICB3aGlsZSAodGhpcy5fZW50cnlXYXRjaGVycy5sZW5ndGgpIHsKICAgICAgICBhd2FpdCB0aGlzLl9lbnRyeVdhdGNoZXJzW3RoaXMuX2VudHJ5V2F0Y2hlcnMubGVuZ3RoIC0gMV0uY2xvc2UoKQogICAgICB9CiAgICB9CgogICAgd2hpbGUgKHRoaXMuX2JhdGNoZXMubGVuZ3RoKSB7CiAgICAgIGF3YWl0IHRoaXMuX2JhdGNoZXNbdGhpcy5fYmF0Y2hlcy5sZW5ndGggLSAxXS5jbG9zZSgpCiAgICB9CgogICAgcmV0dXJuIHRoaXMuY29yZS5jbG9zZSgpCiAgfQoKICBzdGF0aWMgYXN5bmMgaXNIeXBlcmJlZSAoY29yZSwgb3B0cykgewogICAgYXdhaXQgY29yZS5yZWFkeSgpCgogICAgY29uc3QgYmxrMCA9IGF3YWl0IGNvcmUuZ2V0KDAsIG9wdHMpCiAgICBpZiAoYmxrMCA9PT0gbnVsbCkgdGhyb3cgQkxPQ0tfTk9UX0FWQUlMQUJMRSgpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIEhlYWRlci5kZWNvZGUoYmxrMCkucHJvdG9jb2wgPT09ICdoeXBlcmJlZScKICAgIH0gY2F0Y2ggKGVycikgeyAvLyB1bmRlY29kYWJsZQogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICB9Cn0KCmNsYXNzIEJhdGNoIHsKICBjb25zdHJ1Y3RvciAodHJlZSwgY29yZSwgYmF0Y2hMb2NrLCBjYWNoZSwgb3B0aW9ucyA9IHt9KSB7CiAgICB0aGlzLnRyZWUgPSB0cmVlCiAgICAvLyB0aGlzLmZlZWQgaXMgbm93IGRlcHJlY2F0ZWQsIGFuZCB3aWxsIGJlIHRoaXMuY29yZSBnb2luZyBmb3J3YXJkCiAgICB0aGlzLmZlZWQgPSBjb3JlCiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICB0aGlzLmluZGV4ID0gdHJlZS5fYmF0Y2hlcy5wdXNoKHRoaXMpIC0gMQogICAgdGhpcy5ibG9ja3MgPSBjYWNoZSA/IG5ldyBNYXAoKSA6IG51bGwKICAgIHRoaXMuYXV0b0ZsdXNoID0gIWJhdGNoTG9jawogICAgdGhpcy5tYXhCbG9ja3NDYWNoZWQgPSBvcHRpb25zLm1heEJsb2Nrc0NhY2hlZCB8fCAxMjgKICAgIHRoaXMucm9vdFNlcSA9IDAKICAgIHRoaXMucm9vdCA9IG51bGwKICAgIHRoaXMubGVuZ3RoID0gMAogICAgdGhpcy5jaGVja291dCA9IG9wdGlvbnMuY2hlY2tvdXQgPT09IHVuZGVmaW5lZCA/IC0xIDogb3B0aW9ucy5jaGVja291dAogICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucwogICAgdGhpcy5sb2NrZWQgPSBudWxsCiAgICB0aGlzLmJhdGNoTG9jayA9IGJhdGNoTG9jawogICAgdGhpcy5vbnNlcSA9IHRoaXMub3B0aW9ucy5vbnNlcSB8fCBub29wCiAgICB0aGlzLmFwcGVuZGluZyA9IG51bGwKICAgIHRoaXMuaXNTbmFwc2hvdCA9IHRoaXMuY29yZSAhPT0gdGhpcy50cmVlLmNvcmUKICAgIHRoaXMuc2hvdWxkVXBkYXRlID0gdGhpcy5vcHRpb25zLnVwZGF0ZSAhPT0gZmFsc2UKICAgIHRoaXMudXBkYXRpbmcgPSBudWxsCiAgICB0aGlzLmVuY29kaW5nID0gewogICAgICBrZXk6IG9wdGlvbnMua2V5RW5jb2RpbmcgPyBjb2RlY3Mob3B0aW9ucy5rZXlFbmNvZGluZykgOiB0cmVlLmtleUVuY29kaW5nLAogICAgICB2YWx1ZTogb3B0aW9ucy52YWx1ZUVuY29kaW5nID8gY29kZWNzKG9wdGlvbnMudmFsdWVFbmNvZGluZykgOiB0cmVlLnZhbHVlRW5jb2RpbmcKICAgIH0KICB9CgogIGFzeW5jIHJlYWR5ICgpIHsKICAgIGlmICh0aGlzLmNvcmUub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKICAgIGlmICh0aGlzLnRyZWUub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy50cmVlLnJlYWR5KCkKICB9CgogIGFzeW5jIGxvY2sgKCkgewogICAgaWYgKHRoaXMudHJlZS5yZWFkb25seSkgdGhyb3cgbmV3IEVycm9yKCdIeXBlcmJlZSBpcyBtYXJrZWQgYXMgcmVhZC1vbmx5JykKICAgIGlmICh0aGlzLmxvY2tlZCA9PT0gbnVsbCkgdGhpcy5sb2NrZWQgPSBhd2FpdCB0aGlzLnRyZWUubG9jaygpCiAgfQoKICBnZXQgdmVyc2lvbiAoKSB7CiAgICBpZiAodGhpcy5jaGVja291dCAhPT0gLTEpIHJldHVybiBNYXRoLm1heCgxLCB0aGlzLmNoZWNrb3V0KQogICAgcmV0dXJuIE1hdGgubWF4KDEsIHRoaXMudHJlZS5fY2hlY2tvdXQgfHwgKHRoaXMuY29yZS5sZW5ndGggKyB0aGlzLmxlbmd0aCkpCiAgfQoKICBhc3luYyBnZXRSb290IChlbnN1cmVIZWFkZXIpIHsKICAgIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKGVuc3VyZUhlYWRlcikgewogICAgICBpZiAodGhpcy5jb3JlLmxlbmd0aCA9PT0gMCAmJiB0aGlzLmNvcmUud3JpdGFibGUgJiYgIXRoaXMudHJlZS5yZWFkb25seSkgewogICAgICAgIGF3YWl0IHRoaXMuY29yZS5hcHBlbmQoSGVhZGVyLmVuY29kZSh7CiAgICAgICAgICBwcm90b2NvbDogJ2h5cGVyYmVlJywKICAgICAgICAgIG1ldGFkYXRhOiB0aGlzLnRyZWUubWV0YWRhdGEKICAgICAgICB9KSkKICAgICAgfQogICAgfQogICAgaWYgKHRoaXMudHJlZS5fY2hlY2tvdXQgPT09IDAgJiYgdGhpcy5jaGVja291dCA9PT0gLTEgJiYgdGhpcy5zaG91bGRVcGRhdGUpIHsKICAgICAgaWYgKHRoaXMudXBkYXRpbmcgPT09IG51bGwpIHRoaXMudXBkYXRpbmcgPSB0aGlzLmNvcmUudXBkYXRlKCkKICAgICAgYXdhaXQgdGhpcy51cGRhdGluZwogICAgfQogICAgaWYgKHRoaXMudmVyc2lvbiA8IDIpIHJldHVybiBudWxsCiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0QmxvY2sodGhpcy52ZXJzaW9uIC0gMSkpLmdldFRyZWVOb2RlKDApCiAgfQoKICBhc3luYyBnZXRLZXkgKHNlcSkgewogICAgYXdhaXQgdGhpcy50cmVlLl9jYWNoZUxvY2suZW50ZXIoc2VxKQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IGsgPSB0aGlzLmNvcmUuZm9yayA9PT0gdGhpcy50cmVlLmNvcmUuZm9yayA/IHRoaXMudHJlZS5fa2V5Q2FjaGUuZ2V0KHNlcSkgOiBudWxsCiAgICAgIGlmIChrICE9PSBudWxsKSByZXR1cm4gawogICAgICBjb25zdCBrZXkgPSAoYXdhaXQgdGhpcy5fZ2V0QmxvY2soc2VxKSkua2V5CiAgICAgIGlmICh0aGlzLmNvcmUuZm9yayA9PT0gdGhpcy50cmVlLmNvcmUuZm9yaykgdGhpcy50cmVlLl9rZXlDYWNoZS5zZXQoc2VxLCBrZXkpCiAgICAgIHJldHVybiBrZXkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMudHJlZS5fY2FjaGVMb2NrLmV4aXQoc2VxKQogICAgfQogIH0KCiAgYXN5bmMgX2dldE5vZGUgKHNlcSkgewogICAgY29uc3QgY2FjaGVkID0gKHRoaXMudHJlZS5fbm9kZUNhY2hlICE9PSBudWxsICYmIHRoaXMuY29yZS5mb3JrID09PSB0aGlzLnRyZWUuY29yZS5mb3JrKSA/IHRoaXMudHJlZS5fbm9kZUNhY2hlLmdldChzZXEpIDogbnVsbAogICAgaWYgKGNhY2hlZCAhPT0gbnVsbCkgcmV0dXJuIGNhY2hlZAogICAgY29uc3QgZW50cnkgPSBhd2FpdCB0aGlzLmNvcmUuZ2V0KHNlcSwgeyAuLi50aGlzLm9wdGlvbnMsIHZhbHVlRW5jb2Rpbmc6IE5vZGUgfSkKICAgIGlmIChlbnRyeSA9PT0gbnVsbCkgdGhyb3cgQkxPQ0tfTk9UX0FWQUlMQUJMRSgpCiAgICBjb25zdCB3cmFwID0gY29weUVudHJ5KGVudHJ5KQogICAgaWYgKHRoaXMuY29yZS5mb3JrID09PSB0aGlzLnRyZWUuY29yZS5mb3JrICYmIHRoaXMudHJlZS5fbm9kZUNhY2hlICE9PSBudWxsKSB0aGlzLnRyZWUuX25vZGVDYWNoZS5zZXQoc2VxLCB3cmFwKQogICAgcmV0dXJuIHdyYXAKICB9CgogIGFzeW5jIGdldEJsb2NrIChzZXEpIHsKICAgIGlmICh0aGlzLnJvb3RTZXEgPT09IDApIHRoaXMucm9vdFNlcSA9IHNlcQogICAgYXdhaXQgdGhpcy50cmVlLl9jYWNoZUxvY2suZW50ZXIoc2VxKQoKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9nZXRCbG9jayhzZXEpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLnRyZWUuX2NhY2hlTG9jay5leGl0KHNlcSkKICAgIH0KICB9CgogIGFzeW5jIF9nZXRCbG9jayAoc2VxKSB7CiAgICBsZXQgYiA9IHRoaXMuYmxvY2tzICYmIHRoaXMuYmxvY2tzLmdldChzZXEpCiAgICBpZiAoYikgcmV0dXJuIGIKICAgIHRoaXMub25zZXEoc2VxKQogICAgY29uc3QgZW50cnkgPSBhd2FpdCB0aGlzLl9nZXROb2RlKHNlcSkKICAgIGIgPSB0aGlzLmJsb2NrcyAmJiB0aGlzLmJsb2Nrcy5nZXQoc2VxKQogICAgaWYgKGIpIHJldHVybiBiCiAgICBiID0gbmV3IEJsb2NrRW50cnkoc2VxLCB0aGlzLCBlbnRyeSkKICAgIGlmICh0aGlzLmJsb2NrcyAmJiAodGhpcy5ibG9ja3Muc2l6ZSAtIHRoaXMubGVuZ3RoKSA8IHRoaXMubWF4QmxvY2tzQ2FjaGVkKSB0aGlzLmJsb2Nrcy5zZXQoc2VxLCBiKQogICAgcmV0dXJuIGIKICB9CgogIF9vbndhaXQgKGtleSkgewogICAgdGhpcy5vcHRpb25zLm9ud2FpdCA9IG51bGwKICAgIHRoaXMudHJlZS5leHRlbnNpb24uZ2V0KHRoaXMucm9vdFNlcSArIDEsIGtleSkKICB9CgogIF9nZXRFbmNvZGluZyAob3B0cykgewogICAgaWYgKCFvcHRzKSByZXR1cm4gdGhpcy5lbmNvZGluZwogICAgcmV0dXJuIHsKICAgICAga2V5OiBvcHRzLmtleUVuY29kaW5nID8gY29kZWNzKG9wdHMua2V5RW5jb2RpbmcpIDogdGhpcy5lbmNvZGluZy5rZXksCiAgICAgIHZhbHVlOiBvcHRzLnZhbHVlRW5jb2RpbmcgPyBjb2RlY3Mob3B0cy52YWx1ZUVuY29kaW5nKSA6IHRoaXMuZW5jb2RpbmcudmFsdWUKICAgIH0KICB9CgogIHBlZWsgKHJhbmdlLCBvcHRzKSB7CiAgICByZXR1cm4gaXRlcmF0b3JQZWVrKHRoaXMuY3JlYXRlUmFuZ2VJdGVyYXRvcihyYW5nZSwgeyAuLi5vcHRzLCBsaW1pdDogMSB9KSkKICB9CgogIGNyZWF0ZVJhbmdlSXRlcmF0b3IgKHJhbmdlLCBvcHRzID0ge30pIHsKICAgIC8vIGJhY2t3YXJkcyBjb21wYXQgcmFuZ2UgYXJnCiAgICBvcHRzID0gb3B0cyA/IHsgLi4ub3B0cywgLi4ucmFuZ2UgfSA6IHJhbmdlCgogICAgY29uc3QgZW5jb2RpbmcgPSB0aGlzLl9nZXRFbmNvZGluZyhvcHRzKQogICAgcmV0dXJuIG5ldyBSYW5nZUl0ZXJhdG9yKHRoaXMsIGVuY29kaW5nLCBlbmNSYW5nZShlbmNvZGluZy5rZXksIHsgLi4ub3B0cywgc3ViOiB0aGlzLnRyZWUuX3N1YiB9KSkKICB9CgogIGNyZWF0ZVJlYWRTdHJlYW0gKHJhbmdlLCBvcHRzKSB7CiAgICBjb25zdCBzaWduYWwgPSAob3B0cyAmJiBvcHRzLnNpZ25hbCkgfHwgbnVsbAogICAgcmV0dXJuIGl0ZXJhdG9yVG9TdHJlYW0odGhpcy5jcmVhdGVSYW5nZUl0ZXJhdG9yKHJhbmdlLCBvcHRzKSwgc2lnbmFsKQogIH0KCiAgYXN5bmMgZ2V0QnlTZXEgKHNlcSwgb3B0cykgewogICAgY29uc3QgZW5jb2RpbmcgPSB0aGlzLl9nZXRFbmNvZGluZyhvcHRzKQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IGJsb2NrID0gKGF3YWl0IHRoaXMuZ2V0QmxvY2soc2VxKSkuZmluYWwoZW5jb2RpbmcpCiAgICAgIHJldHVybiB7IGtleTogYmxvY2sua2V5LCB2YWx1ZTogYmxvY2sudmFsdWUgfQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgdGhpcy5fY2xvc2VTbmFwc2hvdCgpCiAgICB9CiAgfQoKICBhc3luYyBnZXQgKGtleSwgb3B0cykgewogICAgY29uc3QgZW5jb2RpbmcgPSB0aGlzLl9nZXRFbmNvZGluZyhvcHRzKQogICAgY29uc3QgZmluYWxpemUgPSBvcHRzID8gb3B0cy5maW5hbGl6ZSAhPT0gZmFsc2UgOiB0cnVlCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2dldChrZXksIGVuY29kaW5nLCBmaW5hbGl6ZSkKICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IHRoaXMuX2Nsb3NlU25hcHNob3QoKQogICAgfQogIH0KCiAgYXN5bmMgX2dldCAoa2V5LCBlbmNvZGluZywgZmluYWxpemUpIHsKICAgIGtleSA9IGVuYyhlbmNvZGluZy5rZXksIGtleSkKCiAgICBpZiAodGhpcy50cmVlLmV4dGVuc2lvbiAhPT0gbnVsbCAmJiB0aGlzLm9wdGlvbnMuZXh0ZW5zaW9uICE9PSBmYWxzZSkgewogICAgICB0aGlzLm9wdGlvbnMub253YWl0ID0gdGhpcy5fb253YWl0LmJpbmQodGhpcywga2V5KQogICAgfQoKICAgIGxldCBub2RlID0gYXdhaXQgdGhpcy5nZXRSb290KGZhbHNlKQogICAgaWYgKCFub2RlKSByZXR1cm4gbnVsbAoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmIChub2RlLmJsb2NrLmlzVGFyZ2V0KGtleSkpIHsKICAgICAgICByZXR1cm4gbm9kZS5ibG9jay5pc0RlbGV0aW9uKCkgPyBudWxsIDogKGZpbmFsaXplID8gbm9kZS5ibG9jay5maW5hbChlbmNvZGluZykgOiBub2RlLmJsb2NrKQogICAgICB9CgogICAgICBsZXQgcyA9IDAKICAgICAgbGV0IGUgPSBub2RlLmtleXMubGVuZ3RoCiAgICAgIGxldCBjCgogICAgICB3aGlsZSAocyA8IGUpIHsKICAgICAgICBjb25zdCBtaWQgPSAocyArIGUpID4+IDEKCiAgICAgICAgYyA9IGI0YS5jb21wYXJlKGtleSwgYXdhaXQgbm9kZS5nZXRLZXkobWlkKSkKCiAgICAgICAgaWYgKGMgPT09IDApIHsKICAgICAgICAgIGNvbnN0IGJsb2NrID0gYXdhaXQgdGhpcy5nZXRCbG9jayhub2RlLmtleXNbbWlkXS5zZXEpCiAgICAgICAgICByZXR1cm4gZmluYWxpemUgPyBibG9jay5maW5hbChlbmNvZGluZykgOiBibG9jawogICAgICAgIH0KCiAgICAgICAgaWYgKGMgPCAwKSBlID0gbWlkCiAgICAgICAgZWxzZSBzID0gbWlkICsgMQogICAgICB9CgogICAgICBpZiAoIW5vZGUuY2hpbGRyZW4ubGVuZ3RoKSByZXR1cm4gbnVsbAoKICAgICAgY29uc3QgaSA9IGMgPCAwID8gZSA6IHMKICAgICAgbm9kZSA9IGF3YWl0IG5vZGUuZ2V0Q2hpbGROb2RlKGkpCiAgICB9CiAgfQoKICBhc3luYyBsaW5rcyAoa2V5LCBzZXEpIHsKICAgIGxldCBub2RlID0gYXdhaXQgdGhpcy5nZXRSb290KGZhbHNlKQogICAgaWYgKCFub2RlKSByZXR1cm4gZmFsc2UKCiAgICBpZiAobm9kZS5ibG9jay5zZXEgPT09IHNlcSkgcmV0dXJuIHRydWUKCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAobm9kZS5ibG9jay5pc1RhcmdldChrZXkpKSByZXR1cm4gZmFsc2UKCiAgICAgIGxldCBzID0gMAogICAgICBsZXQgZSA9IG5vZGUua2V5cy5sZW5ndGgKICAgICAgbGV0IGMKCiAgICAgIHdoaWxlIChzIDwgZSkgewogICAgICAgIGNvbnN0IG1pZCA9IChzICsgZSkgPj4gMQoKICAgICAgICBpZiAobm9kZS5rZXlzW21pZF0uc2VxID09PSBzZXEpIHJldHVybiB0cnVlCiAgICAgICAgYyA9IGI0YS5jb21wYXJlKGtleSwgYXdhaXQgbm9kZS5nZXRLZXkobWlkKSkKCiAgICAgICAgaWYgKGMgPT09IDApIHJldHVybiBmYWxzZQoKICAgICAgICBpZiAoYyA8IDApIGUgPSBtaWQKICAgICAgICBlbHNlIHMgPSBtaWQgKyAxCiAgICAgIH0KCiAgICAgIGlmICghbm9kZS5jaGlsZHJlbi5sZW5ndGgpIHJldHVybiBmYWxzZQoKICAgICAgY29uc3QgaSA9IGMgPCAwID8gZSA6IHMKICAgICAgbm9kZSA9IGF3YWl0IG5vZGUuZ2V0Q2hpbGROb2RlKGkpCiAgICAgIGlmIChub2RlLmJsb2NrLnNlcSA9PT0gc2VxKSByZXR1cm4gdHJ1ZQogICAgfQogIH0KCiAgYXN5bmMgcHV0IChrZXksIHZhbHVlLCBvcHRzKSB7CiAgICBjb25zdCByZWxlYXNlID0gdGhpcy5iYXRjaExvY2sgPyBhd2FpdCB0aGlzLmJhdGNoTG9jaygpIDogbnVsbAoKICAgIGNvbnN0IGNhcyA9IChvcHRzICYmIG9wdHMuY2FzKSB8fCBudWxsCiAgICBjb25zdCBlbmNvZGluZyA9IHRoaXMuX2dldEVuY29kaW5nKG9wdHMpCgogICAgaWYgKCF0aGlzLmxvY2tlZCkgYXdhaXQgdGhpcy5sb2NrKCkKICAgIGlmICghcmVsZWFzZSkgcmV0dXJuIHRoaXMuX3B1dChrZXksIHZhbHVlLCBlbmNvZGluZywgY2FzKQoKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9wdXQoa2V5LCB2YWx1ZSwgZW5jb2RpbmcsIGNhcykKICAgIH0gZmluYWxseSB7CiAgICAgIHJlbGVhc2UoKQogICAgfQogIH0KCiAgYXN5bmMgX3B1dCAoa2V5LCB2YWx1ZSwgZW5jb2RpbmcsIGNhcykgewogICAgY29uc3QgbmV3Tm9kZSA9IHsKICAgICAgc2VxOiAwLAogICAgICBrZXksCiAgICAgIHZhbHVlCiAgICB9CiAgICBrZXkgPSBlbmMoZW5jb2Rpbmcua2V5LCBrZXkpCiAgICB2YWx1ZSA9IGVuYyhlbmNvZGluZy52YWx1ZSwgdmFsdWUpCgogICAgY29uc3Qgc3RhY2sgPSBbXQoKICAgIGxldCByb290CiAgICBsZXQgbm9kZSA9IHJvb3QgPSBhd2FpdCB0aGlzLmdldFJvb3QodHJ1ZSkKICAgIGlmICghbm9kZSkgbm9kZSA9IHJvb3QgPSBUcmVlTm9kZS5jcmVhdGUobnVsbCkKCiAgICBjb25zdCBzZXEgPSBuZXdOb2RlLnNlcSA9IHRoaXMuY29yZS5sZW5ndGggKyB0aGlzLmxlbmd0aAogICAgY29uc3QgdGFyZ2V0ID0gbmV3IEtleShzZXEsIGtleSkKCiAgICB3aGlsZSAobm9kZS5jaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgc3RhY2sucHVzaChub2RlKQogICAgICBub2RlLmNoYW5nZWQgPSB0cnVlIC8vIGNoYW5nZWQsIGJ1dCBjb21wcmVzc2libGUKCiAgICAgIGxldCBzID0gMAogICAgICBsZXQgZSA9IG5vZGUua2V5cy5sZW5ndGgKICAgICAgbGV0IGMKCiAgICAgIHdoaWxlIChzIDwgZSkgewogICAgICAgIGNvbnN0IG1pZCA9IChzICsgZSkgPj4gMQogICAgICAgIGMgPSBiNGEuY29tcGFyZSh0YXJnZXQudmFsdWUsIGF3YWl0IG5vZGUuZ2V0S2V5KG1pZCkpCgogICAgICAgIGlmIChjID09PSAwKSB7CiAgICAgICAgICBpZiAoY2FzKSB7CiAgICAgICAgICAgIGNvbnN0IHByZXYgPSBhd2FpdCBub2RlLmdldEtleU5vZGUobWlkKQogICAgICAgICAgICBpZiAoIShhd2FpdCBjYXMocHJldi5maW5hbChlbmNvZGluZyksIG5ld05vZGUpKSkgcmV0dXJuIHRoaXMuX3VubG9ja01heWJlKCkKICAgICAgICAgIH0KICAgICAgICAgIGlmICghdGhpcy50cmVlLmFsd2F5c0R1cGxpY2F0ZSkgewogICAgICAgICAgICBjb25zdCBwcmV2ID0gYXdhaXQgbm9kZS5nZXRLZXlOb2RlKG1pZCkKICAgICAgICAgICAgaWYgKHNhbWVWYWx1ZShwcmV2LnZhbHVlLCB2YWx1ZSkpIHJldHVybiB0aGlzLl91bmxvY2tNYXliZSgpCiAgICAgICAgICB9CiAgICAgICAgICBub2RlLnNldEtleShtaWQsIHRhcmdldCkKICAgICAgICAgIHJldHVybiB0aGlzLl9hcHBlbmQocm9vdCwgc2VxLCBrZXksIHZhbHVlKQogICAgICAgIH0KCiAgICAgICAgaWYgKGMgPCAwKSBlID0gbWlkCiAgICAgICAgZWxzZSBzID0gbWlkICsgMQogICAgICB9CgogICAgICBjb25zdCBpID0gYyA8IDAgPyBlIDogcwogICAgICBub2RlID0gYXdhaXQgbm9kZS5nZXRDaGlsZE5vZGUoaSkKICAgIH0KCiAgICBsZXQgbmVlZHNTcGxpdCA9ICEoYXdhaXQgbm9kZS5pbnNlcnRLZXkodGFyZ2V0LCB2YWx1ZSwgbnVsbCwgbmV3Tm9kZSwgZW5jb2RpbmcsIGNhcykpCiAgICBpZiAoIW5vZGUuY2hhbmdlZCkgcmV0dXJuIHRoaXMuX3VubG9ja01heWJlKCkKCiAgICB3aGlsZSAobmVlZHNTcGxpdCkgewogICAgICBjb25zdCBwYXJlbnQgPSBzdGFjay5wb3AoKQogICAgICBjb25zdCB7IG1lZGlhbiwgcmlnaHQgfSA9IGF3YWl0IG5vZGUuc3BsaXQoKQoKICAgICAgaWYgKHBhcmVudCkgewogICAgICAgIG5lZWRzU3BsaXQgPSAhKGF3YWl0IHBhcmVudC5pbnNlcnRLZXkobWVkaWFuLCB2YWx1ZSwgcmlnaHQsIG51bGwsIGVuY29kaW5nLCBudWxsKSkKICAgICAgICBub2RlID0gcGFyZW50CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcm9vdCA9IFRyZWVOb2RlLmNyZWF0ZShub2RlLmJsb2NrKQogICAgICAg","IHJvb3QuY2hhbmdlZCA9IHRydWUKICAgICAgICByb290LmtleXMucHVzaChtZWRpYW4pCiAgICAgICAgcm9vdC5jaGlsZHJlbi5wdXNoKG5ldyBDaGlsZCgwLCAwLCBub2RlKSwgbmV3IENoaWxkKDAsIDAsIHJpZ2h0KSkKICAgICAgICBuZWVkc1NwbGl0ID0gZmFsc2UKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzLl9hcHBlbmQocm9vdCwgc2VxLCBrZXksIHZhbHVlKQogIH0KCiAgYXN5bmMgZGVsIChrZXksIG9wdHMpIHsKICAgIGNvbnN0IHJlbGVhc2UgPSB0aGlzLmJhdGNoTG9jayA/IGF3YWl0IHRoaXMuYmF0Y2hMb2NrKCkgOiBudWxsCiAgICBjb25zdCBjYXMgPSAob3B0cyAmJiBvcHRzLmNhcykgfHwgbnVsbAogICAgY29uc3QgZW5jb2RpbmcgPSB0aGlzLl9nZXRFbmNvZGluZyhvcHRzKQoKICAgIGlmICghdGhpcy5sb2NrZWQpIGF3YWl0IHRoaXMubG9jaygpCiAgICBpZiAoIXJlbGVhc2UpIHJldHVybiB0aGlzLl9kZWwoa2V5LCBlbmNvZGluZywgY2FzKQoKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9kZWwoa2V5LCBlbmNvZGluZywgY2FzKQogICAgfSBmaW5hbGx5IHsKICAgICAgcmVsZWFzZSgpCiAgICB9CiAgfQoKICBhc3luYyBfZGVsIChrZXksIGVuY29kaW5nLCBjYXMpIHsKICAgIGNvbnN0IGRlbE5vZGUgPSB7CiAgICAgIHNlcTogMCwKICAgICAga2V5LAogICAgICB2YWx1ZTogbnVsbAogICAgfQoKICAgIGtleSA9IGVuYyhlbmNvZGluZy5rZXksIGtleSkKCiAgICBjb25zdCBzdGFjayA9IFtdCgogICAgbGV0IG5vZGUgPSBhd2FpdCB0aGlzLmdldFJvb3QodHJ1ZSkKICAgIGlmICghbm9kZSkgcmV0dXJuIHRoaXMuX3VubG9ja01heWJlKCkKCiAgICBjb25zdCBzZXEgPSBkZWxOb2RlLnNlcSA9IHRoaXMuY29yZS5sZW5ndGggKyB0aGlzLmxlbmd0aAoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIHN0YWNrLnB1c2gobm9kZSkKCiAgICAgIGxldCBzID0gMAogICAgICBsZXQgZSA9IG5vZGUua2V5cy5sZW5ndGgKICAgICAgbGV0IGMKCiAgICAgIHdoaWxlIChzIDwgZSkgewogICAgICAgIGNvbnN0IG1pZCA9IChzICsgZSkgPj4gMQogICAgICAgIGMgPSBiNGEuY29tcGFyZShrZXksIGF3YWl0IG5vZGUuZ2V0S2V5KG1pZCkpCgogICAgICAgIGlmIChjID09PSAwKSB7CiAgICAgICAgICBpZiAoY2FzKSB7CiAgICAgICAgICAgIGNvbnN0IHByZXYgPSBhd2FpdCBub2RlLmdldEtleU5vZGUobWlkKQogICAgICAgICAgICBpZiAoIShhd2FpdCBjYXMocHJldi5maW5hbChlbmNvZGluZyksIGRlbE5vZGUpKSkgcmV0dXJuIHRoaXMuX3VubG9ja01heWJlKCkKICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlLmNoaWxkcmVuLmxlbmd0aCkgYXdhaXQgc2V0S2V5VG9OZWFyZXN0TGVhZihub2RlLCBtaWQsIHN0YWNrKQogICAgICAgICAgZWxzZSBub2RlLnJlbW92ZUtleShtaWQpCiAgICAgICAgICAvLyB3ZSBtYXJrIHRoZXNlIGFzIGNoYW5nZWQgbGF0ZSwgc28gd2UgZG9uJ3QgcmV3cml0ZSB0aGVtIGlmIGl0IGlzIGEgNDA0CiAgICAgICAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygc3RhY2spIG5vZGUuY2hhbmdlZCA9IHRydWUKICAgICAgICAgIHJldHVybiB0aGlzLl9hcHBlbmQoYXdhaXQgcmViYWxhbmNlKHN0YWNrKSwgc2VxLCBrZXksIG51bGwpCiAgICAgICAgfQoKICAgICAgICBpZiAoYyA8IDApIGUgPSBtaWQKICAgICAgICBlbHNlIHMgPSBtaWQgKyAxCiAgICAgIH0KCiAgICAgIGlmICghbm9kZS5jaGlsZHJlbi5sZW5ndGgpIHJldHVybiB0aGlzLl91bmxvY2tNYXliZSgpCgogICAgICBjb25zdCBpID0gYyA8IDAgPyBlIDogcwogICAgICBub2RlID0gYXdhaXQgbm9kZS5nZXRDaGlsZE5vZGUoaSkKICAgIH0KICB9CgogIGFzeW5jIF9jbG9zZVNuYXBzaG90ICgpIHsKICAgIGlmICh0aGlzLmlzU25hcHNob3QpIHsKICAgICAgYXdhaXQgdGhpcy5jb3JlLmNsb3NlKCkKICAgICAgdGhpcy5fZmluYWxpemUoKQogICAgfQogIH0KCiAgYXN5bmMgY2xvc2UgKCkgewogICAgaWYgKHRoaXMuaXNTbmFwc2hvdCkgcmV0dXJuIHRoaXMuX2Nsb3NlU25hcHNob3QoKQoKICAgIHRoaXMucm9vdCA9IG51bGwKICAgIGlmICh0aGlzLmJsb2NrcykgdGhpcy5ibG9ja3MuY2xlYXIoKQogICAgdGhpcy5sZW5ndGggPSAwCiAgICB0aGlzLl91bmxvY2soKQogIH0KCiAgZGVzdHJveSAoKSB7IC8vIGNvbXBhdCwgcmVtb3ZlIGxhdGVyCiAgICB0aGlzLmNsb3NlKCkuY2F0Y2gobm9vcCkKICB9CgogIHRvQmxvY2tzICgpIHsKICAgIGlmICh0aGlzLmFwcGVuZGluZykgcmV0dXJuIHRoaXMuYXBwZW5kaW5nCgogICAgY29uc3QgYmF0Y2ggPSBuZXcgQXJyYXkodGhpcy5sZW5ndGgpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHNlcSA9IHRoaXMuY29yZS5sZW5ndGggKyBpCiAgICAgIGNvbnN0IHsgcGVuZGluZ0luZGV4LCBrZXksIHZhbHVlIH0gPSB0aGlzLmJsb2Nrcy5nZXQoc2VxKQoKICAgICAgaWYgKGkgPCB0aGlzLmxlbmd0aCAtIDEpIHsKICAgICAgICBwZW5kaW5nSW5kZXhbMF0gPSBudWxsCiAgICAgICAgbGV0IGogPSAwCgogICAgICAgIHdoaWxlIChqIDwgcGVuZGluZ0luZGV4Lmxlbmd0aCkgewogICAgICAgICAgY29uc3QgaWR4ID0gcGVuZGluZ0luZGV4W2pdCiAgICAgICAgICBpZiAoaWR4ICE9PSBudWxsICYmIGlkeC5zZXEgPT09IHNlcSkgewogICAgICAgICAgICBpZHgub2Zmc2V0ID0gaisrCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaiA9PT0gcGVuZGluZ0luZGV4Lmxlbmd0aCAtIDEpIHBlbmRpbmdJbmRleC5wb3AoKQogICAgICAgICAgZWxzZSBwZW5kaW5nSW5kZXhbal0gPSBwZW5kaW5nSW5kZXgucG9wKCkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGJhdGNoW2ldID0gTm9kZS5lbmNvZGUoewogICAgICAgIGtleSwKICAgICAgICB2YWx1ZSwKICAgICAgICBpbmRleDogZGVmbGF0ZShwZW5kaW5nSW5kZXgpCiAgICAgIH0pCiAgICB9CgogICAgdGhpcy5hcHBlbmRpbmcgPSBiYXRjaAogICAgcmV0dXJuIGJhdGNoCiAgfQoKICBmbHVzaCAoKSB7CiAgICBpZiAoIXRoaXMubGVuZ3RoKSByZXR1cm4gdGhpcy5jbG9zZSgpCgogICAgY29uc3QgYmF0Y2ggPSB0aGlzLnRvQmxvY2tzKCkKCiAgICB0aGlzLnJvb3QgPSBudWxsCiAgICB0aGlzLmJsb2Nrcy5jbGVhcigpCiAgICB0aGlzLmxlbmd0aCA9IDAKCiAgICByZXR1cm4gdGhpcy5fYXBwZW5kQmF0Y2goYmF0Y2gpCiAgfQoKICBfdW5sb2NrTWF5YmUgKCkgewogICAgaWYgKHRoaXMuYXV0b0ZsdXNoKSB0aGlzLl91bmxvY2soKQogIH0KCiAgX3VubG9jayAoKSB7CiAgICBjb25zdCBsb2NrZWQgPSB0aGlzLmxvY2tlZAogICAgdGhpcy5sb2NrZWQgPSBudWxsCiAgICBpZiAobG9ja2VkICE9PSBudWxsKSBsb2NrZWQoKQogICAgdGhpcy5fZmluYWxpemUoKQogIH0KCiAgX2ZpbmFsaXplICgpIHsKICAgIC8vIHRlY2huaWNhbGx5IGZpbmFsaXplIGNhbiBiZSBjYWxsZWQgbW9yZSB0aGFuIG9uY2UsIHNvIGhlcmUgd2UganVzdCBjaGVjayBpZiB3ZSBhbHJlYWR5IGhhdmUgYmVlbiByZW1vdmVkCiAgICBpZiAodGhpcy5pbmRleCA+PSB0aGlzLnRyZWUuX2JhdGNoZXMubGVuZ3RoIHx8IHRoaXMudHJlZS5fYmF0Y2hlc1t0aGlzLmluZGV4XSAhPT0gdGhpcykgcmV0dXJuCiAgICBjb25zdCB0b3AgPSB0aGlzLnRyZWUuX2JhdGNoZXMucG9wKCkKICAgIGlmICh0b3AgPT09IHRoaXMpIHJldHVybgogICAgdG9wLmluZGV4ID0gdGhpcy5pbmRleAogICAgdGhpcy50cmVlLl9iYXRjaGVzW3RvcC5pbmRleF0gPSB0b3AKICB9CgogIF9hcHBlbmQgKHJvb3QsIHNlcSwga2V5LCB2YWx1ZSkgewogICAgY29uc3QgaW5kZXggPSBbXQogICAgcm9vdC5pbmRleENoYW5nZXMoaW5kZXgsIHNlcSkKICAgIGluZGV4WzBdID0gbmV3IENoaWxkKHNlcSwgMCwgcm9vdCkKCiAgICBpZiAoIXRoaXMuYXV0b0ZsdXNoKSB7CiAgICAgIGNvbnN0IGJsb2NrID0gbmV3IEJhdGNoRW50cnkoc2VxLCB0aGlzLCBrZXksIHZhbHVlLCBpbmRleCkKICAgICAgcm9vdC5ibG9jayA9IGJsb2NrCiAgICAgIHRoaXMucm9vdCA9IHJvb3QKICAgICAgdGhpcy5sZW5ndGgrKwogICAgICB0aGlzLmJsb2Nrcy5zZXQoc2VxLCBibG9jaykKCiAgICAgIHJvb3QudXBkYXRlQ2hpbGRyZW4oc2VxLCBibG9jaykKICAgICAgcmV0dXJuCiAgICB9CgogICAgcmV0dXJuIHRoaXMuX2FwcGVuZEJhdGNoKE5vZGUuZW5jb2RlKHsKICAgICAga2V5LAogICAgICB2YWx1ZSwKICAgICAgaW5kZXg6IGRlZmxhdGUoaW5kZXgpCiAgICB9KSkKICB9CgogIGFzeW5jIF9hcHBlbmRCYXRjaCAocmF3KSB7CiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLmNvcmUuYXBwZW5kKHJhdykKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX3VubG9jaygpCiAgICB9CiAgfQp9CgpjbGFzcyBFbnRyeVdhdGNoZXIgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvciAoYmVlLCBrZXksIG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMua2V5RW5jb2RpbmcgPSBvcHRzLmtleUVuY29kaW5nIHx8IGJlZS5rZXlFbmNvZGluZwogICAgdGhpcy52YWx1ZUVuY29kaW5nID0gb3B0cy52YWx1ZUVuY29kaW5nIHx8IGJlZS52YWx1ZUVuY29kaW5nCgogICAgdGhpcy5pbmRleCA9IGJlZS5fZW50cnlXYXRjaGVycy5wdXNoKHRoaXMpIC0gMQogICAgdGhpcy5iZWUgPSBiZWUKCiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy5ub2RlID0gbnVsbAoKICAgIHRoaXMuX2ZvcmNlVXBkYXRlID0gZmFsc2UKICAgIHRoaXMuX2RlYm91bmNlZFVwZGF0ZSA9IGRlYm91bmNlKHRoaXMuX3Byb2Nlc3NVcGRhdGUuYmluZCh0aGlzKSkKICB9CgogIF9jbG9zZSAoKSB7CiAgICBjb25zdCB0b3AgPSB0aGlzLmJlZS5fZW50cnlXYXRjaGVycy5wb3AoKQogICAgaWYgKHRvcCAhPT0gdGhpcykgewogICAgICB0b3AuaW5kZXggPSB0aGlzLmluZGV4CiAgICAgIHRoaXMuYmVlLl9lbnRyeVdhdGNoZXJzW3RvcC5pbmRleF0gPSB0b3AKICAgIH0KICB9CgogIF9vbmFwcGVuZCAoKSB7CiAgICB0aGlzLl9kZWJvdW5jZWRVcGRhdGUoKQogIH0KCiAgX29udHJ1bmNhdGUgKCkgewogICAgdGhpcy5fZm9yY2VVcGRhdGUgPSB0cnVlCiAgICB0aGlzLl9kZWJvdW5jZWRVcGRhdGUoKQogIH0KCiAgYXN5bmMgX3Byb2Nlc3NVcGRhdGUgKCkgewogICAgY29uc3QgZm9yY2UgPSB0aGlzLl9mb3JjZVVwZGF0ZQogICAgdGhpcy5fZm9yY2VVcGRhdGUgPSBmYWxzZQoKICAgIGxldCBuZXdOb2RlCiAgICB0cnkgewogICAgICBuZXdOb2RlID0gYXdhaXQgdGhpcy5iZWUuZ2V0KHRoaXMua2V5LCB7CiAgICAgICAga2V5RW5jb2Rpbmc6IHRoaXMua2V5RW5jb2RpbmcsCiAgICAgICAgdmFsdWVFbmNvZGluZzogdGhpcy52YWx1ZUVuY29kaW5nCiAgICAgIH0pCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGlmIChlLmNvZGUgPT09ICdTTkFQU0hPVF9OT1RfQVZBSUxBQkxFJykgewogICAgICAgIC8vIFRoZXJlIHdhcyBhIHRydW5jYXRlIGV2ZW50IGJlZm9yZSB0aGUgZ2V0IHJlc29sdmVkCiAgICAgICAgLy8gU28gdGhpcyBoYW5kbGVyIHdpbGwgcnVuIGFnYWluIGFueXdheQogICAgICAgIHJldHVybgogICAgICB9IGVsc2UgaWYgKHRoaXMuYmVlLmNsb3NpbmcpIHsKICAgICAgICB0aGlzLmNsb3NlKCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGUpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChmb3JjZSB8fCBuZXdOb2RlPy5zZXEgIT09IHRoaXMubm9kZT8uc2VxKSB7CiAgICAgIHRoaXMubm9kZSA9IG5ld05vZGUKICAgICAgdGhpcy5lbWl0KCd1cGRhdGUnKQogICAgfQogIH0KfQoKY2xhc3MgV2F0Y2hlciBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yIChiZWUsIHJhbmdlLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmtleUVuY29kaW5nID0gb3B0cy5rZXlFbmNvZGluZyB8fCBiZWUua2V5RW5jb2RpbmcKICAgIHRoaXMudmFsdWVFbmNvZGluZyA9IG9wdHMudmFsdWVFbmNvZGluZyB8fCBiZWUudmFsdWVFbmNvZGluZwogICAgdGhpcy5pbmRleCA9IGJlZS5fd2F0Y2hlcnMucHVzaCh0aGlzKSAtIDEKICAgIHRoaXMuYmVlID0gYmVlCiAgICB0aGlzLmNvcmUgPSBiZWUuY29yZQoKICAgIHRoaXMubGF0ZXN0RGlmZiA9IDAKICAgIHRoaXMucmFuZ2UgPSByYW5nZQogICAgdGhpcy5tYXAgPSBvcHRzLm1hcCB8fCBkZWZhdWx0V2F0Y2hNYXAKCiAgICB0aGlzLmN1cnJlbnQgPSBudWxsCiAgICB0aGlzLnByZXZpb3VzID0gbnVsbAogICAgdGhpcy5jdXJyZW50TWFwcGVkID0gbnVsbAogICAgdGhpcy5wcmV2aW91c01hcHBlZCA9IG51bGwKICAgIHRoaXMuc3RyZWFtID0gbnVsbAoKICAgIHRoaXMuX2xvY2sgPSBtdXRleGlmeSgpCiAgICB0aGlzLl9mbG93aW5nID0gZmFsc2UKICAgIHRoaXMuX3Jlc29sdmVPbkNoYW5nZSA9IG51bGwKICAgIHRoaXMuX2RpZmZlciA9IG9wdHMuZGlmZmVyIHx8IGRlZmF1bHREaWZmZXIKICAgIHRoaXMuX2VhZ2VyID0gISFvcHRzLmVhZ2VyCiAgICB0aGlzLl9vbmNoYW5nZSA9IG9wdHMub25jaGFuZ2UgfHwgbnVsbAoKICAgIHRoaXMub24oJ25ld0xpc3RlbmVyJywgYXV0b0Zsb3dPblVwZGF0ZSkKCiAgICB0aGlzLnJlYWR5KCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgfQoKICBhc3luYyBfY29uc3VtZSAoKSB7CiAgICBpZiAodGhpcy5fZmxvd2luZykgcmV0dXJuCiAgICB0cnkgewogICAgICBmb3IgYXdhaXQgKGNvbnN0IF8gb2YgdGhpcykge30gLy8gZXNsaW50LWRpc2FibGUtbGluZQogICAgfSBjYXRjaCB7fQogIH0KCiAgYXN5bmMgX29wZW4gKCkgewogICAgYXdhaXQgdGhpcy5iZWUucmVhZHkoKQoKICAgIGNvbnN0IG9wdHMgPSB7CiAgICAgIGtleUVuY29kaW5nOiB0aGlzLmtleUVuY29kaW5nLAogICAgICB2YWx1ZUVuY29kaW5nOiB0aGlzLnZhbHVlRW5jb2RpbmcKICAgIH0KCiAgICAvLyBQb2ludCBmcm9tIHdoaWNoIHRvIHN0YXJ0IHdhdGNoaW5nCiAgICB0aGlzLmN1cnJlbnQgPSB0aGlzLl9lYWdlciA/IHRoaXMuYmVlLmNoZWNrb3V0KDEsIG9wdHMpIDogdGhpcy5iZWUuc25hcHNob3Qob3B0cykKICAgIGF3YWl0IHRoaXMuY3VycmVudC5yZWFkeSgpCgogICAgaWYgKHRoaXMuX29uY2hhbmdlKSB7CiAgICAgIGlmICh0aGlzLl9lYWdlcikgYXdhaXQgdGhpcy5fb25jaGFuZ2UoKQogICAgICB0aGlzLl9jb25zdW1lKCkKICAgIH0KICB9CgogIFtTeW1ib2wuYXN5bmNJdGVyYXRvcl0gKCkgewogICAgdGhpcy5fZmxvd2luZyA9IHRydWUKICAgIHJldHVybiB0aGlzCiAgfQoKICBfb250cnVuY2F0ZSAoKSB7CiAgICB0aGlzLl9vbmFwcGVuZCgpCiAgfQoKICBfb25hcHBlbmQgKCkgewogICAgY29uc3QgcmVzb2x2ZSA9IHRoaXMuX3Jlc29sdmVPbkNoYW5nZQogICAgdGhpcy5fcmVzb2x2ZU9uQ2hhbmdlID0gbnVsbAogICAgaWYgKHJlc29sdmUpIHJlc29sdmUoKQogIH0KCiAgYXN5bmMgX3dhaXRGb3JDaGFuZ2VzICgpIHsKICAgIGlmICh0aGlzLmN1cnJlbnQudmVyc2lvbiA8IHRoaXMuYmVlLnZlcnNpb24gfHwgdGhpcy5jbG9zaW5nKSByZXR1cm4KCiAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHsKICAgICAgdGhpcy5fcmVzb2x2ZU9uQ2hhbmdlID0gcmVzb2x2ZQogICAgfSkKICB9CgogIGFzeW5jIG5leHQgKCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX25leHQoKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybiB7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfQogICAgICBhd2FpdCB0aGlzLmNsb3NlKCkKICAgICAgdGhyb3cgZXJyCiAgICB9CiAgfQoKICBhc3luYyBfbmV4dCAoKSB7CiAgICBjb25zdCByZWxlYXNlID0gYXdhaXQgdGhpcy5fbG9jaygpCgogICAgdHJ5IHsKICAgICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuIHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9CgogICAgICBpZiAoIXRoaXMub3BlbmVkKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fd2FpdEZvckNoYW5nZXMoKQoKICAgICAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4geyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH0KCiAgICAgICAgYXdhaXQgdGhpcy5fY2xvc2VQcmV2aW91cygpCiAgICAgICAgdGhpcy5wcmV2aW91cyA9IHRoaXMuY3VycmVudC5zbmFwc2hvdCgpCgogICAgICAgIGF3YWl0IHRoaXMuX2Nsb3NlQ3VycmVudCgpCiAgICAgICAgdGhpcy5jdXJyZW50ID0gdGhpcy5iZWUuc25hcHNob3QoewogICAgICAgICAga2V5RW5jb2Rpbmc6IHRoaXMua2V5RW5jb2RpbmcsCiAgICAgICAgICB2YWx1ZUVuY29kaW5nOiB0aGlzLnZhbHVlRW5jb2RpbmcKICAgICAgICB9KQoKICAgICAgICBhd2FpdCB0aGlzLmN1cnJlbnQucmVhZHkoKQogICAgICAgIGF3YWl0IHRoaXMucHJldmlvdXMucmVhZHkoKQoKICAgICAgICBpZiAodGhpcy5jdXJyZW50LmNvcmUuZm9yayAhPT0gdGhpcy5wcmV2aW91cy5jb3JlLmZvcmspIHsKICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl95aWVsZCgpCiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0cmVhbSA9IHRoaXMuX2RpZmZlcih0aGlzLmN1cnJlbnQsIHRoaXMucHJldmlvdXMsIHRoaXMucmFuZ2UpCgogICAgICAgIHRyeSB7CiAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgdGhpcy5zdHJlYW0pIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZQogICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5feWllbGQoKQogICAgICAgICAgfQogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICB0aGlzLnN0cmVhbSA9IG51bGwKICAgICAgICB9CiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIHJlbGVhc2UoKQogICAgfQogIH0KCiAgYXN5bmMgX3lpZWxkICgpIHsKICAgIHRoaXMuY3VycmVudE1hcHBlZCA9IHRoaXMubWFwKHRoaXMuY3VycmVudCkKICAgIHRoaXMucHJldmlvdXNNYXBwZWQgPSB0aGlzLm1hcCh0aGlzLnByZXZpb3VzKQoKICAgIGlmICh0aGlzLl9vbmNoYW5nZSkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuX29uY2hhbmdlKCkKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgICB9CiAgICB9CgogICAgdGhpcy5lbWl0KCd1cGRhdGUnKQogICAgcmV0dXJuIHsgZG9uZTogZmFsc2UsIHZhbHVlOiBbdGhpcy5jdXJyZW50TWFwcGVkLCB0aGlzLnByZXZpb3VzTWFwcGVkXSB9CiAgfQoKICBhc3luYyByZXR1cm4gKCkgewogICAgYXdhaXQgdGhpcy5jbG9zZSgpCiAgICByZXR1cm4geyBkb25lOiB0cnVlIH0KICB9CgogIGFzeW5jIF9jbG9zZSAoKSB7CiAgICBjb25zdCB0b3AgPSB0aGlzLmJlZS5fd2F0Y2hlcnMucG9wKCkKICAgIGlmICh0b3AgIT09IHRoaXMpIHsKICAgICAgdG9wLmluZGV4ID0gdGhpcy5pbmRleAogICAgICB0aGlzLmJlZS5fd2F0Y2hlcnNbdG9wLmluZGV4XSA9IHRvcAogICAgfQoKICAgIGlmICh0aGlzLnN0cmVhbSAmJiAhdGhpcy5zdHJlYW0uZGVzdHJveWluZykgewogICAgICB0aGlzLnN0cmVhbS5kZXN0cm95KCkKICAgIH0KCiAgICB0aGlzLl9vbmFwcGVuZCgpIC8vIENvbnRpbnVlIGV4ZWN1dGlvbiBiZWluZyBjbG9zZWQKCiAgICBhd2FpdCB0aGlzLl9jbG9zZUN1cnJlbnQoKS5jYXRjaChzYWZldHlDYXRjaCkKICAgIGF3YWl0IHRoaXMuX2Nsb3NlUHJldmlvdXMoKS5jYXRjaChzYWZldHlDYXRjaCkKCiAgICBjb25zdCByZWxlYXNlID0gYXdhaXQgdGhpcy5fbG9jaygpCiAgICByZWxlYXNlKCkKICB9CgogIGRlc3Ryb3kgKCkgewogICAgcmV0dXJuIHRoaXMuY2xvc2UoKQogIH0KCiAgYXN5bmMgX2Nsb3NlQ3VycmVudCAoKSB7CiAgICBpZiAodGhpcy5jdXJyZW50TWFwcGVkKSBhd2FpdCB0aGlzLmN1cnJlbnRNYXBwZWQuY2xvc2UoKQogICAgaWYgKHRoaXMuY3VycmVudCkgYXdhaXQgdGhpcy5jdXJyZW50LmNsb3NlKCkKICAgIHRoaXMuY3VycmVudCA9IHRoaXMuY3VycmVudE1hcHBlZCA9IG51bGwKICB9CgogIGFzeW5jIF9jbG9zZVByZXZpb3VzICgpIHsKICAgIGlmICh0aGlzLnByZXZpb3VzTWFwcGVkKSBhd2FpdCB0aGlzLnByZXZpb3VzTWFwcGVkLmNsb3NlKCkKICAgIGlmICh0aGlzLnByZXZpb3VzKSBhd2FpdCB0aGlzLnByZXZpb3VzLmNsb3NlKCkKICAgIHRoaXMucHJldmlvdXMgPSB0aGlzLnByZXZpb3VzTWFwcGVkID0gbnVsbAogIH0KfQoKZnVuY3Rpb24gYXV0b0Zsb3dPblVwZGF0ZSAobmFtZSkgewogIGlmIChuYW1lID09PSAndXBkYXRlJykgdGhpcy5fY29uc3VtZSgpCn0KCmZ1bmN0aW9uIGRlZmF1bHRXYXRjaE1hcCAoc25hcHNob3QpIHsKICByZXR1cm4gc25hcHNob3QKfQoKYXN5bmMgZnVuY3Rpb24gbGVhZlNpemUgKG5vZGUsIGdvTGVmdCkgewogIHdoaWxlIChub2RlLmNoaWxkcmVuLmxlbmd0aCkgbm9kZSA9IGF3YWl0IG5vZGUuZ2V0Q2hpbGROb2RlKGdvTGVmdCA/IDAgOiBub2RlLmNoaWxkcmVuLmxlbmd0aCAtIDEpCiAgcmV0dXJuIG5vZGUua2V5cy5sZW5ndGgKfQoKYXN5bmMgZnVuY3Rpb24gc2V0S2V5VG9OZWFyZXN0TGVhZiAobm9kZSwgaW5kZXgsIHN0YWNrKSB7CiAgbGV0IFtsZWZ0LCByaWdodF0gPSBhd2FpdCBQcm9taXNlLmFsbChbbm9kZS5nZXRDaGlsZE5vZGUoaW5kZXgpLCBub2RlLmdldENoaWxkTm9kZShpbmRleCArIDEpXSkKICBjb25zdCBbbHMsIHJzXSA9IGF3YWl0IFByb21pc2UuYWxsKFtsZWFmU2l6ZShsZWZ0LCBmYWxzZSksIGxlYWZTaXplKHJpZ2h0LCB0cnVlKV0pCgogIGlmIChscyA8IHJzKSB7IC8vIGlmIGZld2VyIGxlYXZlcyBvbiB0aGUgbGVmdAogICAgc3RhY2sucHVzaChyaWdodCkKICAgIHdoaWxlIChyaWdodC5jaGlsZHJlbi5sZW5ndGgpIHN0YWNrLnB1c2gocmlnaHQgPSByaWdodC5jaGlsZHJlblswXS52YWx1ZSkKICAgIG5vZGUua2V5c1tpbmRleF0gPSByaWdodC5rZXlzLnNoaWZ0KCkKICB9IGVsc2UgeyAvLyBpZiBmZXdlciBsZWF2ZXMgb24gdGhlIHJpZ2h0CiAgICBzdGFjay5wdXNoKGxlZnQpCiAgICB3aGlsZSAobGVmdC5jaGlsZHJlbi5sZW5ndGgpIHN0YWNrLnB1c2gobGVmdCA9IGxlZnQuY2hpbGRyZW5bbGVmdC5jaGlsZHJlbi5sZW5ndGggLSAxXS52YWx1ZSkKICAgIG5vZGUua2V5c1tpbmRleF0gPSBsZWZ0LmtleXMucG9wKCkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJlYmFsYW5jZSAoc3RhY2spIHsKICBjb25zdCByb290ID0gc3RhY2tbMF0KCiAgd2hpbGUgKHN0YWNrLmxlbmd0aCA+IDEpIHsKICAgIGNvbnN0IG5vZGUgPSBzdGFjay5wb3AoKQogICAgY29uc3QgcGFyZW50ID0gc3RhY2tbc3RhY2subGVuZ3RoIC0gMV0KCiAgICBpZiAobm9kZS5rZXlzLmxlbmd0aCA+PSBNSU5fS0VZUykgcmV0dXJuIHJvb3QKCiAgICBsZXQgeyBsZWZ0LCBpbmRleCwgcmlnaHQgfSA9IGF3YWl0IG5vZGUuc2libGluZ3MocGFyZW50KQoKICAgIC8vIG1heWJlIGJvcnJvdyBmcm9tIGxlZnQgc2libGluZz8KICAgIGlmIChsZWZ0ICYmIGxlZnQua2V5cy5sZW5ndGggPiBNSU5fS0VZUykgewogICAgICBsZWZ0LmNoYW5nZWQgPSB0cnVlCiAgICAgIG5vZGUua2V5cy51bnNoaWZ0KHBhcmVudC5rZXlzW2luZGV4IC0gMV0pCiAgICAgIGlmIChsZWZ0LmNoaWxkcmVuLmxlbmd0aCkgbm9kZS5jaGlsZHJlbi51bnNoaWZ0KGxlZnQuY2hpbGRyZW4ucG9wKCkpCiAgICAgIHBhcmVudC5rZXlzW2luZGV4IC0gMV0gPSBsZWZ0LmtleXMucG9wKCkKICAgICAgcmV0dXJuIHJvb3QKICAgIH0KCiAgICAvLyBtYXliZSBib3Jyb3cgZnJvbSByaWdodCBzaWJsaW5nPwogICAgaWYgKHJpZ2h0ICYmIHJpZ2h0LmtleXMubGVuZ3RoID4gTUlOX0tFWVMpIHsKICAgICAgcmlnaHQuY2hhbmdlZCA9IHRydWUKICAgICAgbm9kZS5rZXlzLnB1c2gocGFyZW50LmtleXNbaW5kZXhdKQogICAgICBpZiAocmlnaHQuY2hpbGRyZW4ubGVuZ3RoKSBub2RlLmNoaWxkcmVuLnB1c2gocmlnaHQuY2hpbGRyZW4uc2hpZnQoKSkKICAgICAgcGFyZW50LmtleXNbaW5kZXhdID0gcmlnaHQua2V5cy5zaGlmdCgpCiAgICAgIHJldHVybiByb290CiAgICB9CgogICAgLy8gbWVyZ2Ugbm9kZSB3aXRoIGFub3RoZXIgc2libGluZwogICAgaWYgKGxlZnQpIHsKICAgICAgaW5kZXgtLQogICAgICByaWdodCA9IG5vZGUKICAgIH0gZWxzZSB7CiAgICAgIGxlZnQgPSBub2RlCiAgICB9CgogICAgbGVmdC5tZXJnZShyaWdodCwgcGFyZW50LmtleXNbaW5kZXhdKQogICAgcGFyZW50LnJlbW92ZUtleShpbmRleCkKICB9CgogIC8vIGNoZWNrIGlmIHRoZSB0cmVlIHNocnVuawogIGlmICghcm9vdC5rZXlzLmxlbmd0aCAmJiByb290LmNoaWxkcmVuLmxlbmd0aCkgcmV0dXJuIHJvb3QuZ2V0Q2hpbGROb2RlKDApCiAgcmV0dXJuIHJvb3QKfQoKZnVuY3Rpb24gaXRlcmF0b3JUb1N0cmVhbSAoaXRlLCBzaWduYWwpIHsKICBsZXQgZG9uZQogIGxldCBjbG9zaW5nCgogIGNvbnN0IHJzID0gbmV3IFJlYWRhYmxlKHsKICAgIHNpZ25hbCwKICAgIG9wZW4gKGNiKSB7CiAgICAgIGRvbmUgPSBjYgogICAgICBpdGUub3BlbigpLnRoZW4oZmluLCBmaW4pCiAgICB9LAogICAgcmVhZCAoY2IpIHsKICAgICAgZG9uZSA9IGNiCiAgICAgIGl0ZS5uZXh0KCkudGhlbihwdXNoLCBmaW4pCiAgICB9LAogICAgcHJlZGVzdHJveSAoKSB7CiAgICAgIGNsb3NpbmcgPSBpdGUuY2xvc2UoKQogICAgICBjbG9zaW5nLmNhdGNoKG5vb3ApCiAgICB9LAogICAgZGVzdHJveSAoY2IpIHsKICAgICAgZG9uZSA9IGNiCiAgICAgIGlmICghY2xvc2luZykgY2xvc2luZyA9IGl0ZS5jbG9zZSgpCiAgICAgIGNsb3NpbmcudGhlbihmaW4sIGZpbikKICAgIH0KICB9KQoKICByZXR1cm4gcnMKCiAgZnVuY3Rpb24gZmluIChlcnIpIHsKICAgIGRvbmUoZXJyKQogIH0KCiAgZnVuY3Rpb24gcHVzaCAodmFsKSB7CiAgICBycy5wdXNoKHZhbCkKICAgIGRvbmUobnVsbCkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGl0ZXJhdG9yUGVlayAoaXRlKSB7CiAgdHJ5IHsKICAgIGF3YWl0IGl0ZS5vcGVuKCkKICAgIHJldHVybiBhd2FpdCBpdGUubmV4dCgpCiAgfSBmaW5hbGx5IHsKICAgIGF3YWl0IGl0ZS5jbG9zZSgpCiAgfQp9CgpmdW5jdGlvbiBlbmNSYW5nZSAoZSwgb3B0cykgewogIGlmICghZSkgcmV0dXJuIG9wdHMKCiAgaWYgKGUuZW5jb2RlUmFuZ2UpIHsKICAgIGNvbnN0IHIgPSBlLmVuY29kZVJhbmdlKHsgZ3Q6IG9wdHMuZ3QsIGd0ZTogb3B0cy5ndGUsIGx0OiBvcHRzLmx0LCBsdGU6IG9wdHMubHRlIH0pCiAgICBvcHRzLmd0ID0gci5ndAogICAgb3B0cy5ndGUgPSByLmd0ZQogICAgb3B0cy5sdCA9IHIubHQKICAgIG9wdHMubHRlID0gci5sdGUKICAgIHJldHVybiBvcHRzCiAgfQoKICBpZiAob3B0cy5ndCAhPT0gdW5kZWZpbmVkKSBvcHRzLmd0ID0gZW5jKGUsIG9wdHMuZ3QpCiAgaWYgKG9wdHMuZ3RlICE9PSB1bmRlZmluZWQpIG9wdHMuZ3RlID0gZW5jKGUsIG9wdHMuZ3RlKQogIGlmIChvcHRzLmx0ICE9PSB1bmRlZmluZWQpIG9wdHMubHQgPSBlbmMoZSwgb3B0cy5sdCkKICBpZiAob3B0cy5sdGUgIT09IHVuZGVmaW5lZCkgb3B0cy5sdGUgPSBlbmMoZSwgb3B0cy5sdGUpCiAgaWYgKG9wdHMuc3ViICYmICFvcHRzLmd0ICYmICFvcHRzLmd0ZSkgb3B0cy5ndCA9IGVuYyhlLCBTRVApCiAgaWYgKG9wdHMuc3ViICYmICFvcHRzLmx0ICYmICFvcHRzLmx0ZSkgb3B0cy5sdCA9IGJ1bXAoZW5jKGUsIEVNUFRZKSkKCiAgcmV0dXJuIG9wdHMKfQoKZnVuY3Rpb24gYnVtcCAoa2V5KSB7CiAgLy8ga2V5IHNob3VsZCBoYXZlIGJlZW4gY29waWVkIGJ5IGVuYyBhYm92ZSBiZWZvcmUgaGl0dGluZyB0aGlzCiAga2V5W2tleS5sZW5ndGggLSAxXSsrCiAgcmV0dXJuIGtleQp9CgpmdW5jdGlvbiBlbmMgKGUsIHYpIHsKICBpZiAodiA9PT0gdW5kZWZpbmVkIHx8IHYgPT09IG51bGwpIHJldHVybiBudWxsCiAgaWYgKGUgIT09IG51bGwpIHJldHVybiBlLmVuY29kZSh2KQogIGlmICh0eXBlb2YgdiA9PT0gJ3N0cmluZycpIHJldHVybiBiNGEuZnJvbSh2KQogIHJldHVybiB2Cn0KCmZ1bmN0aW9uIHByZWZpeEVuY29kaW5nIChwcmVmaXgsIGtleUVuY29kaW5nKSB7CiAgcmV0dXJuIHsKICAgIGVuY29kZSAoa2V5KSB7CiAgICAgIHJldHVybiBiNGEuY29uY2F0KFtwcmVmaXgsIGI0YS5pc0J1ZmZlcihrZXkpID8ga2V5IDogZW5jKGtleUVuY29kaW5nLCBrZXkpXSkKICAgIH0sCiAgICBkZWNvZGUgKGtleSkgewogICAgICBjb25zdCBzbGljZWQgPSBrZXkuc2xpY2UocHJlZml4Lmxlbmd0aCwga2V5Lmxlbmd0aCkKICAgICAgcmV0dXJuIGtleUVuY29kaW5nID8ga2V5RW5jb2RpbmcuZGVjb2RlKHNsaWNlZCkgOiBzbGljZWQKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGNvcHlFbnRyeSAoZW50cnkpIHsKICBsZXQga2V5ID0gZW50cnkua2V5CiAgbGV0IHZhbHVlID0gZW50cnkudmFsdWUKICBsZXQgaW5kZXggPSBlbnRyeS5pbmRleAoKICAvLyBrZXksIHZhbHVlIGFuZCBpbmRleCBhbGwgcmVmZXIgdG8gdGhlIHNhbWUgYnVmZmVyIChvbmUgaHlwZXJjb3JlIGJsb2NrKQogIC8vIElmIHRvZ2V0aGVyIHRoZXkgYXJlIGxhcmdlciB0aGFuIGhhbGYgdGhlIGJ1ZmZlcidzIGJ5dGVMZW5ndGgsCiAgLy8gdGhpcyBtZWFucyB0aGF0IHRoZXkgZ290IHRoZWlyIG93biBwcml2YXRlIHNsYWIgKHNlZSBCdWZmZXIuYWxsb2NVbnNhZmUgZG9jcykKICAvLyBzbyBubyBuZWVkIHRvIHVuc2xhYgogIGNvbnN0IHNpemUgPSBrZXkuYnl0ZUxlbmd0aCArICh2YWx1ZSA9PT0gbnVsbCA/IDAgOiB2YWx1ZS5ieXRlTGVuZ3RoKSArIChpbmRleCA9PT0gbnVsbCA/IDAgOiBpbmRleC5ieXRlTGVuZ3RoKQogIGlmICgyICogc2l6ZSA8IGtleS5idWZmZXIuYnl0ZUxlbmd0aCkgewogICAgY29uc3QgW25ld0tleSwgbmV3VmFsdWUsIG5ld0luZGV4XSA9IHVuc2xhYkFsbChbZW50cnkua2V5LCBlbnRyeS52YWx1ZSwgZW50cnkuaW5kZXhdKQogICAga2V5ID0gbmV3S2V5CiAgICB2YWx1ZSA9IG5ld1ZhbHVlCiAgICBpbmRleCA9IG5ld0luZGV4CiAgfQoKICByZXR1cm4gewogICAga2V5LAogICAgdmFsdWUsCiAgICBpbmRleCwKICAgIGluZmxhdGVkOiBudWxsCiAgfQp9CgpmdW5jdGlvbiBkZWZhdWx0RGlmZmVyIChjdXJyZW50U25hcCwgcHJldmlvdXNTbmFwLCBvcHRzKSB7CiAgcmV0dXJuIGN1cnJlbnRTbmFwLmNyZWF0ZURpZmZTdHJlYW0ocHJldmlvdXNTbmFwLCBvcHRzKQp9CgpmdW5jdGlvbiB0b051bGwgKCkgewogIHJldHVybiBudWxsCn0KCmZ1bmN0aW9uIGdldEJhY2tpbmdDb3JlIChjb3JlKSB7CiAgaWYgKGNvcmUuY29yZSkgcmV0dXJuIGNvcmUKICBpZiAoY29yZS5nZXRCYWNraW5nQ29yZSkgcmV0dXJuIGNvcmUuZ2V0QmFja2luZ0NvcmUoKS5zZXNzaW9uCiAgcmV0dXJuIG51bGwKfQoKZnVuY3Rpb24gc2FtZVZhbHVlIChhLCBiKSB7CiAgcmV0dXJuIGEgPT09IGIgfHwgKGEgIT09IG51bGwgJiYgYiAhPT0gbnVsbCAmJiBiNGEuZXF1YWxzKGEsIGIpKQp9CgpmdW5jdGlvbiBub29wICgpIHt9CgpmdW5jdGlvbiBnZXRFeHRlbnNpb24gKGRiLCBvcHRzKSB7CiAgaWYgKG9wdHMuZXh0ZW5zaW9uID09PSBmYWxzZSkgcmV0dXJuIG51bGwKICBpZiAob3B0cy5leHRlbnNpb24gJiYgb3B0cy5leHRlbnNpb24gIT09IHRydWUpIHJldHVybiBvcHRzLmV4dGVuc2lvbgogIHJldHVybiBFeHRlbnNpb24ucmVnaXN0ZXIoZGIpCn0KCmFzeW5jIGZ1bmN0aW9uIGlzTGlua2VkIChiYXRjaCwgYmxvY2spIHsKICBjb25zdCBzZXEgPSBibG9jay5zZXEKICBibG9jay5pbmZsYXRlKCkKCiAgY29uc3Qga2V5cyA9IFtibG9jay5rZXldCiAgY29uc3Qgd2FpdCA9IGJhdGNoLm9wdGlvbnMud2FpdAoKICBmb3IgKGNvbnN0IGwgb2YgYmxvY2suaW5kZXgubGV2ZWxzKSB7CiAgICBpZiAoIWwua2V5cy5sZW5ndGgpIGNvbnRpbnVlCiAgICBiYXRjaC5vcHRpb25zLndhaXQgPSBmYWxzZQogICAgdHJ5IHsKICAgICAga2V5cy5wdXNoKGF3YWl0IGJhdGNoLmdldEtleShsLmtleXNbMF0uc2VxKSkKICAgIH0gY2F0Y2gge30KICAgIGJhdGNoLm9wdGlvbnMud2FpdCA9IHdhaXQKICB9CgogIGZvciAoY29uc3QgayBvZiBrZXlzKSB7CiAgICBpZiAoYXdhaXQgYmF0Y2gubGlua3Moaywgc2VxKSkgcmV0dXJuIHRydWUKICB9CgogIGlmIChiYXRjaC5jb3JlLmNsb3NpbmcpIHRocm93IG5ldyBFcnJvcignQ29yZSBpcyBjbG9zZWQnKQoKICByZXR1cm4gZmFsc2UKfQoKbW9kdWxlLmV4cG9ydHMgPSBIeXBlcmJlZQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY2xhc3MgU3ViVHJlZSB7CiAgY29uc3RydWN0b3IgKG5vZGUsIHBhcmVudCkgewogICAgdGhpcy5ub2RlID0gbm9kZQogICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQKCiAgICB0aGlzLmlzS2V5ID0gbm9kZS5jaGlsZHJlbi5sZW5ndGggPT09IDAKICAgIHRoaXMuaSA9IHRoaXMuaXNLZXkgPyAxIDogMAogICAgdGhpcy5uID0gMAoKICAgIGNvbnN0IGNoaWxkID0gdGhpcy5pc0tleSA/IG51bGwgOiB0aGlzLm5vZGUuY2hpbGRyZW5bMF0KICAgIHRoaXMuc2VxID0gY2hpbGQgIT09IG51bGwgPyBjaGlsZC5zZXEgOiB0aGlzLm5vZGUua2V5c1swXS5zZXEKICAgIHRoaXMub2Zmc2V0ID0gY2hpbGQgIT09IG51bGwgPyBjaGlsZC5vZmZzZXQgOiAwCiAgfQoKICBuZXh0ICgpIHsKICAgIHRoaXMuaSsrCiAgICB0aGlzLmlzS2V5ID0gKHRoaXMuaSAmIDEpID09PSAxCiAgICBpZiAoIXRoaXMuaXNLZXkgJiYgIXRoaXMubm9kZS5jaGlsZHJlbi5sZW5ndGgpIHRoaXMuaSsrCiAgICByZXR1cm4gdGhpcy51cGRhdGUoKQogIH0KCiAgYXN5bmMgYmlzZWN0IChrZXksIGluY2wpIHsKICAgIGxldCBzID0gMAogICAgbGV0IGUgPSB0aGlzLm5vZGUua2V5cy5sZW5ndGgKICAgIGxldCBjCgogICAgd2hpbGUgKHMgPCBlKSB7CiAgICAgIGNvbnN0IG1pZCA9IChzICsgZSkgPj4gMQogICAgICBjID0gY21wKGtleSwgYXdhaXQgdGhpcy5ub2RlLmdldEtleShtaWQpKQoKICAgICAgaWYgKGMgPT09IDApIHsKICAgICAgICBpZiAoaW5jbCkgdGhpcy5pID0gbWlkICogMiArIDEKICAgICAgICBlbHNlIHRoaXMuaSA9IG1pZCAqIDIgKyAodGhpcy5ub2RlLmNoaWxkcmVuLmxlbmd0aCA/IDIgOiAzKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KCiAgICAgIGlmIChjIDwgMCkgZSA9IG1pZAogICAgICBlbHNlIHMgPSBtaWQgKyAxCiAgICB9CgogICAgY29uc3QgaSA9IGMgPCAwID8gZSA6IHMKICAgIHRoaXMuaSA9IDIgKiBpICsgKHRoaXMubm9kZS5jaGlsZHJlbi5sZW5ndGggPyAwIDogMSkKICAgIHJldHVybiB0aGlzLm5vZGUuY2hpbGRyZW4ubGVuZ3RoID09PSAwCiAgfQoKICB1cGRhdGUgKCkgewogICAgdGhpcy5pc0tleSA9ICh0aGlzLmkgJiAxKSA9PT0gMQogICAgdGhpcy5uID0gdGhpcy5pID4+IDEKICAgIGlmICh0aGlzLm4gPj0gKHRoaXMuaXNLZXkgPyB0aGlzLm5vZGUua2V5cy5sZW5ndGggOiB0aGlzLm5vZGUuY2hpbGRyZW4ubGVuZ3RoKSkgcmV0dXJuIGZhbHNlCiAgICBjb25zdCBjaGlsZCA9IHRoaXMuaXNLZXkgPyBudWxsIDogdGhpcy5ub2RlLmNoaWxkcmVuW3RoaXMubl0KICAgIHRoaXMuc2VxID0gY2hpbGQgIT09IG51bGwgPyBjaGlsZC5zZXEgOiB0aGlzLm5vZGUua2V5c1t0aGlzLm5dLnNlcQogICAgdGhpcy5vZmZzZXQgPSBjaGlsZCAhPT0gbnVsbCA/IGNoaWxkLm9mZnNldCA6IDAKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBrZXkgKCkgewogICAgcmV0dXJuIHRoaXMubiA8IHRoaXMubm9kZS5rZXlzLmxlbmd0aCA/IHRoaXMubm9kZS5nZXRLZXkodGhpcy5uKSA6ICh0aGlzLnBhcmVudCAmJiB0aGlzLnBhcmVudC5rZXkoKSkKICB9CgogIGFzeW5jIGNvbXBhcmUgKHRyZWUpIHsKICAgIGNvbnN0IFthLCBiXSA9IGF3YWl0IFByb21pc2UuYWxsKFt0aGlzLmtleSgpLCB0cmVlLmtleSgpXSkKICAgIHJldHVybiBjbXAoYSwgYikKICB9Cn0KCmNsYXNzIFRyZWVJdGVyYXRvciB7CiAgY29uc3RydWN0b3IgKGJhdGNoLCBvcHRzKSB7CiAgICB0aGlzLmJhdGNoID0gYmF0Y2gKICAgIHRoaXMuc3RhY2sgPSBbXQogICAgdGhpcy5sdCA9IG9wdHMubHQgfHwgb3B0cy5sdGUgfHwgbnVsbAogICAgdGhpcy5sdGUgPSAhIW9wdHMubHRlCiAgICB0aGlzLmd0ID0gb3B0cy5ndCB8fCBvcHRzLmd0ZSB8fCBudWxsCiAgICB0aGlzLmd0ZSA9ICEhb3B0cy5ndGUKICAgIHRoaXMuc2Vla2luZyA9ICEhdGhpcy5ndAogICAgdGhpcy5lbmNvZGluZyA9IG9wdHMuZW5jb2RpbmcgfHwgYmF0Y2guZW5jb2RpbmcKICB9CgogIGFzeW5jIG9wZW4gKCkgewogICAgY29uc3Qgbm9kZSA9IGF3YWl0IHRoaXMuYmF0Y2guZ2V0Um9vdChmYWxzZSkKICAgIGlmICghbm9kZSB8fCAhbm9kZS5rZXlzLmxlbmd0aCkgcmV0dXJuCiAgICBjb25zdCB0cmVlID0gbmV3IFN1YlRyZWUobm9kZSwgbnVsbCkKICAgIGlmICh0aGlzLnNlZWtpbmcgJiYgIShhd2FpdCB0aGlzLl9zZWVrKHRyZWUpKSkgcmV0dXJuCiAgICB0aGlzLnN0YWNrLnB1c2godHJlZSkKICB9CgogIGFzeW5jIF9zZWVrICh0cmVlKSB7CiAgICBjb25zdCBkb25lID0gYXdhaXQgdHJlZS5iaXNlY3QodGhpcy5ndCwgdGhpcy5ndGUpCiAgICBjb25zdCBvb2IgPSAhdHJlZS51cGRhdGUoKQogICAgaWYgKGRvbmUgfHwgb29iKSB7CiAgICAgIHRoaXMuc2Vla2luZyA9IGZhbHNlCiAgICAgIGlmIChvb2IpIHJldHVybiBmYWxzZQogICAgfQogICAgcmV0dXJuIHRydWUKICB9CgogIHBlZWsgKCkgewogICAgaWYgKCF0aGlzLnN0YWNrLmxlbmd0aCkgcmV0dXJuIG51bGwKICAgIHJldHVybiB0aGlzLnN0YWNrW3RoaXMuc3RhY2subGVuZ3RoIC0gMV0KICB9CgogIHNraXAgKCkgewogICAgaWYgKCF0aGlzLnN0YWNrLmxlbmd0aCkgcmV0dXJuCiAgICBpZiAoIXRoaXMuc3RhY2tbdGhpcy5zdGFjay5sZW5ndGggLSAxXS5uZXh0KCkpIHRoaXMuc3RhY2sucG9wKCkKICB9CgogIGFzeW5jIG5leHRLZXkgKCkgewogICAgbGV0IG4gPSBudWxsCiAgICB3aGlsZSAodGhpcy5zdGFjay5sZW5ndGggJiYgbiA9PT0gbnVsbCkgbiA9IGF3YWl0IHRoaXMubmV4dCgpCiAgICBpZiAobiA9PT0gbnVsbCkgcmV0dXJuIG51bGwKICAgIGlmICghdGhpcy5sdCkgcmV0dXJuIG4uZmluYWwodGhpcy5lbmNvZGluZykKCiAgICBjb25zdCBjID0gY21wKG4ua2V5LCB0aGlzLmx0KQogICAgaWYgKHRoaXMubHRlID8gYyA8PSAwIDogYyA8IDApIHJldHVybiBuLmZpbmFsKHRoaXMuZW5jb2RpbmcpCiAgICB0aGlzLnN0YWNrID0gW10KICAgIHJldHVybiBudWxsCiAgfQoKICBhc3luYyBuZXh0ICgpIHsKICAgIGlmICghdGhpcy5zdGFjay5sZW5ndGgpIHJldHVybiBudWxsCgogICAgY29uc3QgdG9wID0gdGhpcy5zdGFja1t0aGlzLnN0YWNrLmxlbmd0aCAtIDFdCiAgICBjb25zdCB7IGlzS2V5LCBuLCBzZXEgfSA9IHRvcAoKICAgIGlmICghdG9wLm5leHQoKSkgewogICAgICB0aGlzLnN0YWNrLnBvcCgpCiAgICB9CgogICAgaWYgKGlzS2V5KSB7CiAgICAgIHRoaXMuc2Vla2luZyA9IGZhbHNlCiAgICAgIHJldHVybiB0aGlzLmJhdGNoLmdldEJsb2NrKHNlcSkKICAgIH0KCiAgICBjb25zdCBjaGlsZCA9IGF3YWl0IHRvcC5ub2RlLmdldENoaWxkTm9kZShuKQogICAgdG9wLm5vZGUuY2hpbGRyZW5bbl0gPSBudWxsIC8vIHVubGluayB0byBzYXZlIG1lbW9yeQogICAgY29uc3QgdHJlZSA9IG5ldyBTdWJUcmVlKGNoaWxkLCB0b3ApCiAgICBpZiAodGhpcy5zZWVraW5nICYmICEoYXdhaXQgdGhpcy5fc2Vlayh0cmVlKSkpIHJldHVybiBudWxsCiAgICB0aGlzLnN0YWNrLnB1c2godHJlZSkKCiAgICByZXR1cm4gbnVsbAogIH0KCiAgY2xvc2UgKCkgewogICAgcmV0dXJuIHRoaXMuYmF0Y2guX2Nsb3NlU25hcHNob3QoKQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBEaWZmSXRlcmF0b3IgewogIGNvbnN0cnVjdG9yIChsZWZ0LCByaWdodCwgb3B0cyA9IHt9KSB7CiAgICB0aGlzLmxlZnQgPSBuZXcgVHJlZUl0ZXJhdG9yKGxlZnQsIG9wdHMpCiAgICB0aGlzLnJpZ2h0ID0gbmV3IFRyZWVJdGVyYXRvcihyaWdodCwgb3B0cykKICAgIHRoaXMubGltaXQgPSB0eXBlb2Ygb3B0cy5saW1pdCA9PT0gJ251bWJlcicgPyBvcHRzLmxpbWl0IDogLTEKICB9CgogIGFzeW5jIG9wZW4gKCkgewogICAgYXdhaXQgUHJvbWlzZS5hbGwoW3RoaXMubGVmdC5vcGVuKCksIHRoaXMucmlnaHQub3BlbigpXSkKICB9CgogIGFzeW5jIG5leHQgKCkgewogICAgaWYgKHRoaXMubGltaXQgPT09IDApIHJldHVybiBudWxsCiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLl9uZXh0KCkKICAgIGlmICghcmVzIHx8IChyZXMubGVmdCA9PT0gbnVsbCAmJiByZXMucmlnaHQgPT09IG51bGwpKSByZXR1cm4gbnVsbAogICAgdGhpcy5saW1pdC0tCiAgICByZXR1cm4gcmVzCiAgfQoKICBhc3luYyBfbmV4dCAoKSB7CiAgICBjb25zdCBhID0gdGhpcy5sZWZ0CiAgICBjb25zdCBiID0gdGhpcy5yaWdodAoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGNvbnN0IFtsLCByXSA9IGF3YWl0IFByb21pc2UuYWxsKFthLnBlZWsoKSwgYi5wZWVrKCldKQoKICAgICAgaWYgKCFsICYmICFyKSByZXR1cm4gbnVsbAogICAgICBpZiAoIWwpIHJldHVybiB7IGxlZnQ6IG51bGwsIHJpZ2h0OiBhd2FpdCBiLm5leHRLZXkoKSB9CiAgICAgIGlmICghcikgcmV0dXJuIHsgbGVmdDogYXdhaXQgYS5uZXh0S2V5KCksIHJpZ2h0OiBudWxsIH0KCiAgICAgIGlmIChsLnNlcSA9PT0gci5zZXEgJiYgbC5pc0tleSA9PT0gci5pc0tleSAmJiBsLm9mZnNldCA9PT0gci5vZmZzZXQpIHsKICAgICAgICBhLnNraXAoKQogICAgICAgIGIuc2tpcCgpCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgY29uc3QgYyA9IGF3YWl0IGwuY29tcGFyZShyKQoKICAgICAgaWYgKGwuaXNLZXkgJiYgIXIuaXNLZXkpIHsKICAgICAgICBhd2FpdCBiLm5leHQoKQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGlmICghbC5pc0tleSAmJiByLmlzS2V5KSB7CiAgICAgICAgYXdhaXQgYS5uZXh0KCkKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBpZiAobC5pc0tleSAmJiByLmlzS2V5KSB7CiAgICAgICAgaWYgKGMgPT09IDApIHJldHVybiB7IGxlZnQ6IGF3YWl0IGEubmV4dEtleSgpLCByaWdodDogYXdhaXQgYi5uZXh0S2V5KCkgfQogICAgICAgIGlmIChjIDwgMCkgcmV0dXJuIHsgbGVmdDogYXdhaXQgYS5uZXh0S2V5KCksIHJpZ2h0OiBudWxsIH0KICAgICAgICByZXR1cm4geyBsZWZ0OiBudWxsLCByaWdodDogYXdhaXQgYi5uZXh0S2V5KCkgfQogICAgICB9CgogICAgICBpZiAoYyA9PT0gMCkgYXdhaXQgUHJvbWlzZS5hbGwoW2EubmV4dCgpLCBiLm5leHQoKV0pCiAgICAgIGVsc2UgaWYgKGMgPCAwKSBhd2FpdCBiLm5leHQoKQogICAgICBlbHNlIGF3YWl0IGEubmV4dCgpCiAgICB9CiAgfQoKICBhc3luYyBjbG9zZSAoKSB7CiAgICBhd2FpdCBQcm9taXNlLmFsbChbdGhpcy5sZWZ0LmNsb3NlKCksIHRoaXMucmlnaHQuY2xvc2UoKV0pCiAgfQp9CgpmdW5jdGlvbiBjbXAgKGEsIGIpIHsKICBpZiAoIWEpIHJldHVybiBiID8gMSA6IDAKICBpZiAoIWIpIHJldHVybiBhID8gLTEgOiAwCiAgcmV0dXJuIGI0YS5jb21wYXJlKGEsIGIpCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBIaXN0b3J5SXRlcmF0b3IgewogIGNvbnN0cnVjdG9yIChiYXRjaCwgb3B0cyA9IHt9KSB7CiAgICB0aGlzLmJhdGNoID0gYmF0Y2gKICAgIHRoaXMub3B0aW9ucyA9IG9wdHMKICAgIHRoaXMubGl2ZSA9ICEhb3B0cy5saXZlCiAgICB0aGlzLmd0ZSA9IDAKICAgIHRoaXMubHQgPSAwCiAgICB0aGlzLnJldmVyc2UgPSAhIW9wdHMucmV2ZXJzZQogICAgdGhpcy5saW1pdCA9IHR5cGVvZiBvcHRzLmxpbWl0ID09PSAnbnVtYmVyJyA/IG9wdHMubGltaXQgOiAtMQogICAgdGhpcy5lbmNvZGluZyA9IG9wdHMuZW5jb2RpbmcgfHwgYmF0Y2guZW5jb2RpbmcKICAgIGlmICh0aGlzLmxpdmUgJiYgdGhpcy5yZXZlcnNlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGhhdmUgYm90aCBsaXZlIGFuZCByZXZlcnNlIGVuYWJsZWQnKQogICAgfQogIH0KCiAgYXN5bmMgb3BlbiAoKSB7CiAgICBhd2FpdCB0aGlzLmJhdGNoLmdldFJvb3QoZmFsc2UpIC8vIGRvZXMgdGhlIHVwZGF0ZSBkYW5jZQogICAgdGhpcy5ndGUgPSBndGUodGhpcy5vcHRpb25zLCB0aGlzLmJhdGNoLnZlcnNpb24pCiAgICB0aGlzLmx0ID0gdGhpcy5saXZlID8gSW5maW5pdHkgOiBsdCh0aGlzLm9wdGlvbnMsIHRoaXMuYmF0Y2gudmVyc2lvbikKICB9CgogIGFzeW5jIG5leHQgKCkgewogICAgaWYgKHRoaXMubGltaXQgPT09IDApIHJldHVybiBudWxsCiAgICBpZiAodGhpcy5saW1pdCA+IDApIHRoaXMubGltaXQtLQoKICAgIGlmICh0aGlzLmd0ZSA+PSB0aGlzLmx0KSByZXR1cm4gbnVsbAoKICAgIGlmICh0aGlzLnJldmVyc2UpIHsKICAgICAgaWYgKHRoaXMubHQgPD0gMSkgcmV0dXJuIG51bGwKICAgICAgcmV0dXJuIGZpbmFsKGF3YWl0IHRoaXMuYmF0Y2guZ2V0QmxvY2soLS10aGlzLmx0KSwgdGhpcy5lbmNvZGluZykKICAgIH0KCiAgICByZXR1cm4gZmluYWwoYXdhaXQgdGhpcy5iYXRjaC5nZXRCbG9jayh0aGlzLmd0ZSsrKSwgdGhpcy5lbmNvZGluZykKICB9CgogIGNsb3NlICgpIHsKICAgIHJldHVybiB0aGlzLmJhdGNoLl9jbG9zZVNuYXBzaG90KCkKICB9Cn0KCmZ1bmN0aW9uIGZpbmFsIChub2RlLCBlbmNvZGluZykgewogIGNvbnN0IHR5cGUgPSBub2RlLmlzRGVsZXRpb24oKSA/ICdkZWwnIDogJ3B1dCcKICByZXR1cm4geyB0eXBlLCAuLi5ub2RlLmZpbmFsKGVuY29kaW5nKSB9Cn0KCmZ1bmN0aW9uIGd0ZSAob3B0cywgdmVyc2lvbikgewogIGlmIChvcHRzLmd0KSByZXR1cm4gKG9wdHMuZ3QgPCAwID8gKG9wdHMuZ3QgKyB2ZXJzaW9uKSA6IG9wdHMuZ3QpICsgMQogIGNvbnN0IGd0ZSA9IG9wdHMuZ3RlIHx8IG9wdHMuc2luY2UgfHwgMQogIHJldHVybiBndGUgPCAwID8gZ3RlICsgdmVyc2lvbiA6IGd0ZQp9CgpmdW5jdGlvbiBsdCAob3B0cywgdmVyc2lvbikgewogIGlmIChvcHRzLmx0ZSA9PT0gMCB8fCBvcHRzLmx0ID09PSAwIHx8IG9wdHMuZW5kID09PSAwKSByZXR1cm4gMAogIGlmIChvcHRzLmx0ZSkgcmV0dXJuIChvcHRzLmx0ZSA8IDAgPyAob3B0cy5sdGUgKyB2ZXJzaW9uKSA6IG9wdHMubHRlKSArIDEKICBjb25zdCBsdCA9IG9wdHMubHQgfHwgb3B0cy5lbmQgfHwgdmVyc2lvbgogIHJldHVybiBsdCA8IDAgPyBsdCArIHZlcnNpb24gOiBsdAp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgTG9jYWxCbG9ja3NJdGVyYXRvciB7CiAgY29uc3RydWN0b3IgKGJhdGNoLCBvcHRzID0ge30pIHsKICAgIHRoaXMuYmF0Y2ggPSBiYXRjaAogICAgdGhpcy5vcHRpb25zID0gb3B0cwogICAgdGhpcy5ndGUgPSAwCiAgICB0aGlzLmx0ID0gMAogICAgdGhpcy5saW1pdCA9IHR5cGVvZiBvcHRzLmxpbWl0ID09PSAnbnVtYmVyJyA/IG9wdHMubGltaXQgOiAtMQogIH0KCiAgYXN5bmMgb3BlbiAoKSB7CiAgICBhd2FpdCB0aGlzLmJhdGNoLmdldFJvb3QoZmFsc2UpIC8vIGRvZXMgdGhlIHVwZGF0ZSBkYW5jZQogICAgdGhpcy5ndGUgPSBndGUodGhpcy5vcHRpb25zLCB0aGlzLmJhdGNoLnZlcnNpb24pCiAgICB0aGlzLmx0ID0gbHQodGhpcy5vcHRpb25zLCB0aGlzLmJhdGNoLnZlcnNpb24pCiAgfQoKICBhc3luYyBuZXh0ICgpIHsKICAgIGlmICh0aGlzLmxpbWl0ID09PSAwKSByZXR1cm4gbnVsbAogICAgaWYgKHRoaXMubGltaXQgPiAwKSB0aGlzLmxpbWl0LS0KCiAgICB3aGlsZSAodGhpcy5ndGUgPCB0aGlzLmx0KSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuYmF0Y2guZ2V0QmxvY2sodGhpcy5ndGUrKykKICAgICAgfSBjYXRjaCB7CiAgICAgICAgY29udGludWUKICAgICAgfQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBjbG9zZSAoKSB7CiAgICByZXR1cm4gdGhpcy5iYXRjaC5fY2xvc2VTbmFwc2hvdCgpCiAgfQp9CgpmdW5jdGlvbiBndGUgKG9wdHMsIHZlcnNpb24pIHsKICBpZiAob3B0cy5ndCkgcmV0dXJuIChvcHRzLmd0IDwgMCA/IChvcHRzLmd0ICsgdmVyc2lvbikgOiBvcHRzLmd0KSArIDEKICBjb25zdCBndGUgPSBvcHRzLmd0ZSB8fCBvcHRzLnNpbmNlIHx8IDEKICByZXR1cm4gZ3RlIDwgMCA/IGd0ZSArIHZlcnNpb24gOiBndGUKfQoKZnVuY3Rpb24gbHQgKG9wdHMsIHZlcnNpb24pIHsKICBpZiAob3B0cy5sdGUgPT09IDAgfHwgb3B0cy5sdCA9PT0gMCB8fCBvcHRzLmVuZCA9PT0gMCkgcmV0dXJuIDAKICBpZiAob3B0cy5sdGUpIHJldHVybiAob3B0cy5sdGUgPCAwID8gKG9wdHMubHRlICsgdmVyc2lvbikgOiBvcHRzLmx0ZSkgKyAxCiAgY29uc3QgbHQgPSBvcHRzLmx0IHx8IG9wdHMuZW5kIHx8IHZlcnNpb24KICByZXR1cm4gbHQgPCAwID8gbHQgKyB2ZXJzaW9uIDogbHQKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSYW5nZUl0ZXJhdG9yIHsKICBjb25zdHJ1Y3RvciAoYmF0Y2gsIGVuY29kaW5nLCBvcHRzID0ge30pIHsKICAgIHRoaXMuYmF0Y2ggPSBiYXRjaAogICAgdGhpcy5zdGFjayA9IFtdCiAgICB0aGlzLm9wZW5lZCA9IGZhbHNlCiAgICB0aGlzLmVuY29kaW5nID0gZW5jb2RpbmcgfHwgYmF0Y2guZW5jb2RpbmcKCiAgICB0aGlzLl9saW1pdCA9IHR5cGVvZiBvcHRzLmxpbWl0ID09PSAnbnVtYmVyJyA/IG9wdHMubGltaXQgOiAtMQogICAgdGhpcy5fZ0luY2wgPSAhb3B0cy5ndAogICAgdGhpcy5fZ0tleSA9IG9wdHMuZ3QgfHwgb3B0cy5ndGUgfHwgbnVsbAogICAgdGhpcy5fbEluY2wgPSAhb3B0cy5sdAogICAgdGhpcy5fbEtleSA9IG9wdHMubHQgfHwgb3B0cy5sdGUgfHwgbnVsbAogICAgdGhpcy5fcmV2ZXJzZSA9ICEhb3B0cy5yZXZlcnNlCiAgICB0aGlzLl92ZXJzaW9uID0gMAogICAgdGhpcy5fY2hlY2twb2ludCA9IChvcHRzLmNoZWNrcG9pbnQgJiYgb3B0cy5jaGVja3BvaW50Lmxlbmd0aCkgPyBvcHRzLmNoZWNrcG9pbnQgOiBudWxsCiAgICB0aGlzLl9uZXh0aW5nID0gZmFsc2UKICB9CgogIHNuYXBzaG90ICh2ZXJzaW9uID0gdGhpcy5iYXRjaC52ZXJzaW9uKSB7CiAgICBjb25zdCBjaGVja3BvaW50ID0gW10KICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLnN0YWNrKSB7CiAgICAgIGxldCB7IG5vZGUsIGkgfSA9IHMKICAgICAgaWYgKHRoaXMuX25leHRpbmcgJiYgcyA9PT0gdGhpcy5zdGFja1t0aGlzLnN0YWNrLmxlbmd0aCAtIDFdKSBpID0gdGhpcy5fcmV2ZXJzZSA/IGkgKyAxIDogaSAtIDEKICAgICAgaWYgKCFub2RlLmJsb2NrKSBjb250aW51ZQogICAgICBpZiAoaSA8IDApIGNvbnRpbnVlCiAgICAgIGNoZWNrcG9pbnQucHVzaChub2RlLmJsb2NrLnNlcSwgbm9kZS5vZmZzZXQsIGkpCiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbiwKICAgICAgZ3RlOiB0aGlzLl9nSW5jbCA/IHRoaXMuX2dLZXkgOiBudWxsLAogICAgICBndDogdGhpcy5fZ0luY2wgPyBudWxsIDogdGhpcy5fZ0tleSwKICAgICAgbHRlOiB0aGlzLl9sSW5jbCA/IHRoaXMuX2xLZXkgOiBudWxsLAogICAgICBsdDogdGhpcy5fbEluY2wgPyBudWxsIDogdGhpcy5fbEtleSwKICAgICAgbGltaXQ6IHRoaXMuX2xpbWl0LAogICAgICByZXZlcnNlOiB0aGlzLl9yZXZlcnNlLAogICAgICBlbmRlZDogdGhpcy5vcGVuZWQgJiYgIWNoZWNrcG9pbnQubGVuZ3RoLAogICAgICBjaGVja3BvaW50OiB0aGlzLm9wZW5lZCA/IGNoZWNrcG9pbnQgOiBbXQogICAgfQogIH0KCiAgYXN5bmMgb3BlbiAoKSB7CiAgICBhd2FpdCB0aGlzLl9vcGVuKCkKICAgIHRoaXMub3BlbmVkID0gdHJ1ZQogIH0KCiAgYXN5bmMgX29wZW4gKCkgewogICAgaWYgKHRoaXMuX2NoZWNrcG9pbnQpIHsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB0aGlzLl9jaGVja3BvaW50Lmxlbmd0aDsgaiArPSAzKSB7CiAgICAgICAgY29uc3Qgc2VxID0gdGhpcy5fY2hlY2twb2ludFtqXQogICAgICAgIGNvbnN0IG9mZnNldCA9IHRoaXMuX2NoZWNrcG9pbnRbaiArIDFdCiAgICAgICAgY29uc3QgaSA9IHRoaXMuX2NoZWNrcG9pbnRbaiArIDJdCiAgICAgICAgdGhpcy5zdGFjay5wdXNoKHsKICAgICAgICAgIG5vZGU6IChhd2FpdCB0aGlzLmJhdGNoLmdldEJsb2NrKHNlcSkpLmdldFRyZWVOb2RlKG9mZnNldCksCiAgICAgICAgICBpCiAgICAgICAgfSkKICAgICAgfQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLl9uZXh0aW5nID0gdHJ1ZQoKICAgIGxldCBub2RlID0gYXdhaXQgdGhpcy5iYXRjaC5nZXRSb290KGZhbHNlKQogICAgaWYgKCFub2RlKSB7CiAgICAgIHRoaXMuX25leHRpbmcgPSBmYWxzZQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBpbmNsID0gdGhpcy5fcmV2ZXJzZSA/IHRoaXMuX2xJbmNsIDogdGhpcy5fZ0luY2wKICAgIGNvbnN0IHN0YXJ0ID0gdGhpcy5fcmV2ZXJzZSA/IHRoaXMuX2xLZXkgOiB0aGlzLl9nS2V5CgogICAgaWYgKCFzdGFydCkgewogICAgICB0aGlzLnN0YWNrLnB1c2goeyBub2RlLCBpOiB0aGlzLl9yZXZlcnNlID8gbm9kZS5rZXlzLmxlbmd0aCA8PCAxIDogMCB9KQogICAgICB0aGlzLl9uZXh0aW5nID0gZmFsc2UKICAgICAgcmV0dXJuCiAgICB9CgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgY29uc3QgZW50cnkgPSB7IG5vZGUsIGk6IHRoaXMuX3JldmVyc2UgPyBub2RlLmtleXMubGVuZ3RoIDw8IDEgOiAwIH0KCiAgICAgIGxldCBzID0gMAogICAgICBsZXQgZSA9IG5vZGUua2V5cy5sZW5ndGgKICAgICAgbGV0IGMKCiAgICAgIHdoaWxlIChzIDwgZSkgewogICAgICAgIGNvbnN0IG1pZCA9IChzICsgZSkgPj4gMQogICAgICAgIGMgPSBiNGEuY29tcGFyZShzdGFydCwgYXdhaXQgbm9kZS5nZXRLZXkobWlkKSkKCiAgICAgICAgaWYgKGMgPT09IDApIHsKICAgICAgICAgIGlmIChpbmNsKSBlbnRyeS5pID0gbWlkICogMiArIDEKICAgICAgICAgIGVsc2UgZW50cnkuaSA9IG1pZCAqIDIgKyAodGhpcy5fcmV2ZXJzZSA/IDAgOiAyKQogICAgICAgICAgdGhpcy5zdGFjay5wdXNoKGVudHJ5KQogICAgICAgICAgdGhpcy5fbmV4dGluZyA9IGZhbHNlCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIGlmIChjIDwgMCkgZSA9IG1pZAogICAgICAgIGVsc2UgcyA9IG1pZCArIDEKICAgICAgfQoKICAgICAgY29uc3QgaSA9IGMgPCAwID8gZSA6IHMKICAgICAgZW50cnkuaSA9IDIgKiBpICsgKHRoaXMuX3JldmVyc2UgPyAtMSA6IDEpCgogICAgICBpZiAoZW50cnkuaSA+PSAwICYmIGVudHJ5LmkgPD0gKG5vZGUua2V5cy5sZW5ndGggPDwgMSkpIHRoaXMuc3RhY2sucHVzaChlbnRyeSkKICAgICAgaWYgKCFub2RlLmNoaWxkcmVuLmxlbmd0aCkgewogICAgICAgIHRoaXMuX25leHRpbmcgPSBmYWxzZQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICBub2RlID0gYXdhaXQgbm9kZS5nZXRDaGlsZE5vZGUoaSkKICAgIH0KICB9CgogIGFzeW5jIG5leHQgKCkgewogICAgLy8gVE9ETzogdGhpcyBuZXh0aW5nIGZsYWcgaXMgb25seSBuZWVkZWQgaWYgc29tZW9uZSBhc2tzIGZvciBhIHNuYXBzaG90IGR1cmluZwogICAgLy8gYSBsb29rdXAgKGllIHRoZSBleHRlbnNpb24sIHByZXR0eSBpbXBvcnRhbnQuLi4pLgogICAgLy8gQSBiZXR0ZXIgc29sdXRpb24gd291bGQgYmUgdG8gcmVmYWN0b3IgdGhpcyBzbyB0b3AuaSBpcyBpbmNyZW1lbnRlZCBlYWdlcmx5CiAgICAvLyB0byBnZXQgdGhlIGN1cnJlbnQgYmxvY2sgaW5zdGVhZCBvZiB0aGUgd2F5IGl0IGlzIGRvbmUgbm93ICgrK2kgdnMgaSsrKQogICAgdGhpcy5fbmV4dGluZyA9IHRydWUKCiAgICBjb25zdCBlbmQgPSB0aGlzLl9yZXZlcnNlID8gdGhpcy5fZ0tleSA6IHRoaXMuX2xLZXkKICAgIGNvbnN0IGluY2wgPSB0aGlzLl9yZXZlcnNlID8gdGhpcy5fZ0luY2wgOiB0aGlzLl9sSW5jbAoKICAgIHdoaWxlICh0aGlzLnN0YWNrLmxlbmd0aCAmJiAodGhpcy5fbGltaXQgPT09IC0xIHx8IHRoaXMuX2xpbWl0ID4gMCkpIHsKICAgICAgY29uc3QgdG9wID0gdGhpcy5zdGFja1t0aGlzLnN0YWNrLmxlbmd0aCAtIDFdCiAgICAgIGNvbnN0IGlzS2V5ID0gKHRvcC5pICYgMSkgPT09IDEKICAgICAgY29uc3QgbiA9IHRoaXMuX3JldmVyc2UKICAgICAgICA/ICh0b3AuaSA8IDAgPyB0b3Aubm9kZS5rZXlzLmxlbmd0aCA6IHRvcC5pLS0gPj4gMSkKICAgICAgICA6IHRvcC5pKysgPj4gMQoKICAgICAgaWYgKCFpc0tleSkgewogICAgICAgIGlmICghdG9wLm5vZGUuY2hpbGRyZW4ubGVuZ3RoKSBjb250aW51ZQogICAgICAgIGNvbnN0IG5vZGUgPSBhd2FpdCB0b3Aubm9kZS5nZXRDaGlsZE5vZGUobikKICAgICAgICBpZiAodG9wLm5vZGUuYmxvY2suc2VxIDwgdGhpcy5iYXRjaC5jb3JlLmxlbmd0aCkgewogICAgICAgICAgdG9wLm5vZGUuY2hpbGRyZW5bbl0udmFsdWUgPSBudWxsIC8vIHVubGluayBpdCB0byBzYXZlIG1lbW9yeQogICAgICAgIH0KICAgICAgICB0aGlzLnN0YWNrLnB1c2goeyBpOiB0aGlzLl9yZXZlcnNlID8gbm9kZS5rZXlzLmxlbmd0aCA8PCAxIDogMCwgbm9kZSB9KQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGlmIChuID49IHRvcC5ub2RlLmtleXMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5zdGFjay5wb3AoKQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGNvbnN0IGtleSA9IHRvcC5ub2RlLmtleXNbbl0KICAgICAgY29uc3QgYmxvY2sgPSBhd2FpdCB0aGlzLmJhdGNoLmdldEJsb2NrKGtleS5zZXEpCiAgICAgIGlmIChlbmQpIHsKICAgICAgICBjb25zdCBjID0gYjRhLmNvbXBhcmUoYmxvY2sua2V5LCBlbmQpCiAgICAgICAgaWYgKGMgPT09IDAgPyAhaW5jbCA6ICh0aGlzLl9yZXZlcnNlID8gYyA8IDAgOiBjID4gMCkpIHsKICAgICAgICAgIHRoaXMuX2xpbWl0ID0gMAogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHRoaXMuX2xpbWl0ID4gMCkgdGhpcy5fbGltaXQtLQogICAgICB0aGlzLl9uZXh0aW5nID0gZmFsc2UKICAgICAgcmV0dXJuIGJsb2NrLmZpbmFsKHRoaXMuZW5jb2RpbmcpCiAgICB9CgogICAgdGhpcy5fbmV4dGluZyA9IGZhbHNlCiAgICByZXR1cm4gbnVsbAogIH0KCiAgY2xvc2UgKCkgewogICAgcmV0dXJuIHRoaXMuYmF0Y2guX2Nsb3NlU25hcHNob3QoKQogIH0KfQpjb25zdCB7IEV4dGVuc2lvbiB9ID0gcmVxdWlyZSgnLi9tZXNzYWdlcycpCgovLyBjb25zdCBNQVhfQUNUSVZFID0gMzIKY29uc3QgRkxVU0hfQkFUQ0ggPSAxMjgKY29uc3QgTUFYX1BBU1NJVkVfQkFUQ0ggPSAyMDQ4CmNvbnN0IE1BWF9BQ1RJVkVfQkFUQ0ggPSBNQVhfUEFTU0lWRV9CQVRDSCArIEZMVVNIX0JBVENICgpjbGFzcyBCYXRjaCB7CiAgY29uc3RydWN0b3IgKG91dGdvaW5nLCBmcm9tKSB7CiAgICB0aGlzLmJsb2NrcyA9IFtdCiAgICB0aGlzLnN0YXJ0ID0gMAogICAgdGhpcy5lbmQgPSAwCiAgICB0aGlzLm91dGdvaW5nID0gb3V0Z29pbmcKICAgIHRoaXMuZnJvbSA9IGZyb20KICB9CgogIHB1c2ggKHNlcSkgewogICAgY29uc3QgbGVuID0gdGhpcy5ibG9ja3MucHVzaChzZXEpCiAgICBpZiAobGVuID09PSAxIHx8IHNlcSA8IHRoaXMuc3RhcnQpIHRoaXMuc3RhcnQgPSBzZXEKICAgIGlmIChsZW4gPT09IDEgfHwgc2VxID49IHRoaXMuZW5kKSB0aGlzLmVuZCA9IHNlcSArIDEKICAgIGlmIChsZW4gPj0gRkxVU0hfQkFUQ0gpIHsKICAgICAgdGhpcy5zZW5kKCkKICAgICAgdGhpcy5jbGVhcigpCiAgICB9CiAgfQoKICBzZW5kICgpIHsKICAgIGlmICghdGhpcy5ibG9ja3MubGVuZ3RoKSByZXR1cm4KICAgIHRoaXMub3V0Z29pbmcuc2VuZChFeHRlbnNpb24uZW5jb2RlKHsgY2FjaGU6IHsgYmxvY2tzOiB0aGlzLmJsb2Nrcywgc3RhcnQ6IHRoaXMuc3RhcnQsIGVuZDogdGhpcy5lbmQgfSB9KSwgdGhpcy5mcm9tKQogIH0KCiAgY2xlYXIgKCkgewogICAgdGhpcy5zdGFydCA9IHRoaXMuZW5kID0gMAogICAgdGhpcy5ibG9ja3MgPSBbXQogIH0KfQoKY2xhc3MgSHlwZXJiZWVFeHRlbnNpb24gewogIGNvbnN0cnVjdG9yIChkYikgewogICAgdGhpcy5lbmNvZGluZyA9IG51bGwKICAgIHRoaXMub3V0Z29pbmcgPSBudWxsCiAgICB0aGlzLmRiID0gZGIKICAgIHRoaXMuYWN0aXZlID0gMAogIH0KCiAgZ2V0ICh2ZXJzaW9uLCBrZXkpIHsKICAgIHRoaXMub3V0Z29pbmcuYnJvYWRjYXN0KEV4dGVuc2lvbi5lbmNvZGUoeyBnZXQ6IHsgdmVyc2lvbiwga2V5IH0gfSkpCiAgfQoKICBpdGVyYXRvciAoc25hcHNob3QpIHsKICAgIGlmIChzbmFwc2hvdC5lbmRlZCkgcmV0dXJuCiAgICBpZiAoc25hcHNob3QubGltaXQgPT09IDApIHJldHVybgogICAgaWYgKHNuYXBzaG90LmxpbWl0ID09PSAtMSkgc25hcHNob3QubGltaXQgPSAwCiAgICB0aGlzLm91dGdvaW5nLmJyb2FkY2FzdChFeHRlbnNpb24uZW5jb2RlKHsgaXRlcmF0b3I6IHNuYXBzaG90IH0pKQogIH0KCiAgb25tZXNzYWdlIChidWYsIGZyb20pIHsKICAgIC8vIFRPRE86IGhhbmRsZSBtYXggYWN0aXZlIGV4dGVuc2lvbiBtZXNzYWdlcwogICAgLy8gdGhpcy5hY3RpdmUrKwoKICAgIGNvbnN0IG1lc3NhZ2UgPSBkZWNvZGUoYnVmKQogICAgaWYgKCFtZXNzYWdlKSByZXR1cm4KCiAgICBpZiAobWVzc2FnZS5jYWNoZSkgdGhpcy5vbmNhY2hlKG1lc3NhZ2UuY2FjaGUsIGZyb20pCiAgICBpZiAobWVzc2FnZS5nZXQpIHRoaXMub25nZXQobWVzc2FnZS5nZXQsIGZyb20pCiAgICBpZiAobWVzc2FnZS5pdGVyYXRvcikgdGhpcy5vbml0ZXJhdG9yKG1lc3NhZ2UuaXRlcmF0b3IsIGZyb20pCiAgfQoKICBvbmNhY2hlIChtZXNzYWdlLCBmcm9tKSB7CiAgICBpZiAoIW1lc3NhZ2UuYmxvY2tzLmxlbmd0aCkgcmV0dXJuCiAgICB0aGlzLmRiLmNvcmUuZG93bmxvYWQobWVzc2FnZSkKICB9CgogIG9uZ2V0IChtZXNzYWdlLCBmcm9tKSB7CiAgICBpZiAoIW1lc3NhZ2UudmVyc2lvbiB8fCBtZXNzYWdlLnZlcnNpb24gPiB0aGlzLmRiLnZlcnNpb24pIHJldHVybgoKICAgIGNvbnN0IGIgPSBuZXcgQmF0Y2godGhpcy5vdXRnb2luZywgZnJvbSkKICAgIGNvbnN0IGRiID0gdGhpcy5kYi5jaGVja291dChtZXNzYWdlLnZlcnNpb24pCgogICAgZGIuZ2V0KG1lc3NhZ2Uua2V5LCB7IGV4dGVuc2lvbjogZmFsc2UsIHdhaXQ6IGZhbHNlLCB1cGRhdGU6IGZhbHNlLCBvbnNlcSB9KS50aGVuKGRvbmUsIGRvbmUpCgogICAgZnVuY3Rpb24gZG9uZSAoKSB7CiAgICAgIGRiLmNsb3NlKCkuY2F0Y2gobm9vcCkKICAgICAgYi5zZW5kKCkKICAgIH0KCiAgICBmdW5jdGlvbiBvbnNlcSAoc2VxKSB7CiAgICAgIGIucHVzaChzZXEpCiAgICB9CiAgfQoKICBhc3luYyBvbml0ZXJhdG9yIChtZXNzYWdlLCBmcm9tKSB7CiAgICBpZiAoIW1lc3NhZ2UudmVyc2lvbiB8fCBtZXNzYWdlLnZlcnNpb24gPiB0aGlzLmRiLnZlcnNpb24pIHJldHVybgoKICAgIGNvbnN0IGIgPSBuZXcgQmF0Y2godGhpcy5vdXRnb2luZywgZnJvbSkKICAgIGNvbnN0IHNlcXMgPSBuZXcgU2V0KCkKCiAgICBsZXQgc2tpcCA9IG1lc3NhZ2UuY2hlY2twb2ludC5sZW5ndGgKICAgIGxldCB3b3JrID0gMAoKICAgIGNvbnN0IGRiID0gdGhpcy5kYi5jaGVja291dChtZXNzYWdlLnZlcnNpb24pCiAgICBjb25zdCBpdGUgPSBkYi5jcmVhdGVSYW5nZUl0ZXJhdG9yKHsKICAgICAgLi4ubWVzc2FnZSwKICAgICAgd2FpdDogZmFsc2UsCiAgICAgIGV4dGVuc2lvbjogZmFsc2UsCiAgICAgIHVwZGF0ZTogZmFsc2UsCiAgICAgIGxpbWl0OiBtZXNzYWdlLmxpbWl0ID09PSAwID8gLTEgOiBtZXNzYWdlLmxpbWl0LAogICAgICBvbnNlcSAoc2VxKSB7CiAgICAgICAgaWYgKHNraXAgJiYgc2tpcC0tKSByZXR1cm4KICAgICAgICBpZiAoc2Vxcy5oYXMoc2VxKSkgcmV0dXJuCiAgICAgICAgd29yaysrCiAgICAgICAgc2Vxcy5hZGQoc2VxKQogICAgICAgIGIucHVzaChzZXEpCiAgICAgIH0KICAgIH0pCgogICAgdHJ5IHsKICAgICAgYXdhaXQgaXRlLm9wZW4oKQogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW5tb2RpZmllZC1sb29wLWNvbmRpdGlvbgogICAgICB3aGlsZSAod29yayA8IE1BWF9BQ1RJVkVfQkFUQ0gpIHsKICAgICAgICBpZiAoIShhd2FpdCBpdGUubmV4dCgpKSkgYnJlYWsKICAgICAgfQogICAgfSBjYXRjaCAoXykgewogICAgICAvLyBkbyBub3RoaW5nCiAgICB9IGZpbmFsbHkgewogICAgICBpdGUuY2xvc2UoKS5jYXRjaChub29wKQogICAgICBkYi5jbG9zZSgpLmNhdGNoKG5vb3ApCiAgICAgIGIuc2VuZCgpCiAgICB9CiAgfQoKICBzdGF0aWMgcmVnaXN0ZXIgKGRiKSB7CiAgICBjb25zdCBlID0gbmV3IHRoaXMoZGIpCiAgICBlLm91dGdvaW5nID0gZGIuY29yZS5yZWdpc3RlckV4dGVuc2lvbignaHlwZXJiZWUnLCBlKQogICAgcmV0dXJuIGUKICB9Cn0KCkh5cGVyYmVlRXh0ZW5zaW9uLkJBVENIX1NJWkUgPSBNQVhfUEFTU0lWRV9CQVRDSAoKbW9kdWxlLmV4cG9ydHMgPSBIeXBlcmJlZUV4dGVuc2lvbgoKZnVuY3Rpb24gZGVjb2RlIChidWYpIHsKICB0cnkgewogICAgcmV0dXJuIEV4dGVuc2lvbi5kZWNvZGUoYnVmKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIG51bGwKICB9Cn0KCmZ1bmN0aW9uIG5vb3AgKCkge30KLy8gVGhpcyBmaWxlIGlzIGF1dG8gZ2VuZXJhdGVkIGJ5IHRoZSBwcm90b2NvbC1idWZmZXJzIGNvbXBpbGVyCgovKiBlc2xpbnQtZGlzYWJsZSBxdW90ZXMgKi8KLyogZXNsaW50LWRpc2FibGUgaW5kZW50ICovCi8qIGVzbGludC1kaXNhYmxlIG5vLXJlZGVjbGFyZSAqLwovKiBlc2xpbnQtZGlzYWJsZSBjYW1lbGNhc2UgKi8KLyogZXNsaW50LWRpc2FibGUgbm8tdmFyICovCgovLyBSZW1lbWJlciB0byBgbnBtIGluc3RhbGwgLS1zYXZlIHByb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzYAp2YXIgZW5jb2RpbmdzID0gcmVxdWlyZSgncHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MnKQp2YXIgYjRhID0gcmVxdWlyZSgnYjRhJykKdmFyIHZhcmludCA9IGVuY29kaW5ncy52YXJpbnQKdmFyIHNraXAgPSBlbmNvZGluZ3Muc2tpcAoKdmFyIFlvbG9JbmRleCA9IGV4cG9ydHMuWW9sb0luZGV4ID0gewogIGJ1ZmZlcjogdHJ1ZSwKICBlbmNvZGluZ0xlbmd0aDogbnVsbCwKICBlbmNvZGU6IG51bGwsCiAgZGVjb2RlOiBudWxsCn0KCnZhciBIZWFkZXIgPSBleHBvcnRzLkhlYWRlciA9IHsKICBidWZmZXI6IHRydWUsCiAgZW5jb2RpbmdMZW5ndGg6IG51bGwsCiAgZW5jb2RlOiBudWxsLAogIGRlY29kZTogbnVsbAp9Cgp2YXIgTm9kZSA9IGV4cG9ydHMuTm9kZSA9IHsKICBidWZmZXI6IHRydWUsCiAgZW5jb2RpbmdMZW5ndGg6IG51bGwsCiAgZW5jb2RlOiBudWxsLAogIGRlY29kZTogbnVsbAp9Cgp2YXIgRXh0ZW5zaW9uID0gZXhwb3J0cy5FeHRlbnNpb24gPSB7CiAgYnVmZmVyOiB0cnVlLAogIGVuY29kaW5nTGVuZ3RoOiBudWxsLAogIGVuY29kZTogbnVsbCwKICBkZWNvZGU6IG51bGwKfQoKZGVmaW5lWW9sb0luZGV4KCkKZGVmaW5lSGVhZGVyKCkKZGVmaW5lTm9kZSgpCmRlZmluZUV4dGVuc2lvbigpCgpmdW5jdGlvbiBkZWZpbmVZb2xvSW5kZXggKCkgewogIHZhciBMZXZlbCA9IFlvbG9JbmRleC5MZXZlbCA9IHsKICAgIGJ1ZmZlcjogdHJ1ZSwKICAgIGVuY29kaW5nTGVuZ3RoOiBudWxsLAogICAgZW5jb2RlOiBudWxsLAogICAgZGVjb2RlOiBudWxsCiAgfQoKICBkZWZpbmVMZXZlbCgpCgogIGZ1bmN0aW9uIGRlZmluZUxldmVsICgpIHsKICAgIExldmVsLmVuY29kaW5nTGVuZ3RoID0gZW5jb2RpbmdMZW5ndGgKICAgIExldmVsLmVuY29kZSA9IGVuY29kZQogICAgTGV2ZWwuZGVjb2RlID0gZGVjb2RlCgogICAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKG9iaikgewogICAgICB2YXIgbGVuZ3RoID0gMAogICAgICBpZiAoZGVmaW5lZChvYmoua2V5cykpIHsKICAgICAgICB2YXIgcGFja2VkTGVuID0gMAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmoua2V5c1tpXSkpIGNvbnRpbnVlCiAgICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGluZ0xlbmd0aChvYmoua2V5c1tpXSkKICAgICAgICAgIHBhY2tlZExlbiArPSBsZW4KICAgICAgICB9CiAgICAgICAgaWYgKHBhY2tlZExlbikgewogICAgICAgICAgbGVuZ3RoICs9IDEgKyBwYWNrZWRMZW4gKyB2YXJpbnQuZW5jb2RpbmdMZW5ndGgocGFja2VkTGVuKQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmouY2hpbGRyZW4pKSB7CiAgICAgICAgdmFyIHBhY2tlZExlbiA9IDAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5jaGlsZHJlbltpXSkpIGNvbnRpbnVlCiAgICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGluZ0xlbmd0aChvYmouY2hpbGRyZW5baV0pCiAgICAgICAgICBwYWNrZWRMZW4gKz0gbGVuCiAgICAgICAgfQogICAgICAgIGlmIChwYWNrZWRMZW4pIHsKICAgICAgICAgIGxlbmd0aCArPSAxICsgcGFja2VkTGVuICsgdmFyaW50LmVuY29kaW5nTGVuZ3RoKHBhY2tlZExlbikKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGxlbmd0aAogICAgfQoKICAgIGZ1bmN0aW9uIGVuY29kZSAob2JqLCBidWYsIG9mZnNldCkgewogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgICBpZiAoIWJ1ZikgYnVmID0gYjRhLmFsbG9jVW5zYWZlKGVuY29kaW5nTGVuZ3RoKG9iaikpCiAgICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgICAgaWYgKGRlZmluZWQob2JqLmtleXMpKSB7CiAgICAgICAgdmFyIHBhY2tlZExlbiA9IDAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5rZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmtleXNbaV0pKSBjb250aW51ZQogICAgICAgICAgcGFja2VkTGVuICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLmtleXNbaV0pCiAgICAgICAgfQogICAgICAgIGlmIChwYWNrZWRMZW4pIHsKICAgICAgICAgIGJ1ZltvZmZzZXQrK10gPSAxMAogICAgICAgICAgdmFyaW50LmVuY29kZShwYWNrZWRMZW4sIGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmoua2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5rZXlzW2ldKSkgY29udGludWUKICAgICAgICAgIGVuY29kaW5ncy52YXJpbnQuZW5jb2RlKG9iai5rZXlzW2ldLCBidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kZS5ieXRlcwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmouY2hpbGRyZW4pKSB7CiAgICAgICAgdmFyIHBhY2tlZExlbiA9IDAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5jaGlsZHJlbltpXSkpIGNvbnRpbnVlCiAgICAgICAgICBwYWNrZWRMZW4gKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGluZ0xlbmd0aChvYmouY2hpbGRyZW5baV0pCiAgICAgICAgfQogICAgICAgIGlmIChwYWNrZWRMZW4pIHsKICAgICAgICAgIGJ1ZltvZmZzZXQrK10gPSAxOAogICAgICAgICAgdmFyaW50LmVuY29kZShwYWNrZWRMZW4sIGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmouY2hpbGRyZW5baV0pKSBjb250aW51ZQogICAgICAgICAgZW5jb2RpbmdzLnZhcmludC5lbmNvZGUob2JqLmNoaWxkcmVuW2ldLCBidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kZS5ieXRlcwogICAgICAgIH0KICAgICAgfQogICAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgcmV0dXJuIGJ1ZgogICAgfQoKICAgIGZ1bmN0aW9uIGRlY29kZSAoYnVmLCBvZmZzZXQsIGVuZCkgewogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgICBpZiAoIWVuZCkgZW5kID0gYnVmLmxlbmd0aAogICAgICBpZiAoIShlbmQgPD0gYnVmLmxlbmd0aCAmJiBvZmZzZXQgPD0gYnVmLmxlbmd0aCkpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgICAgdmFyIG9iaiA9IHsKICAgICAgICBrZXlzOiBbXSwKICAgICAgICBjaGlsZHJlbjogW10KICAgICAgfQogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGlmIChlbmQgPD0gb2Zmc2V0KSB7CiAgICAgICAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgICAgIHJldHVybiBvYmoKICAgICAgICB9CiAgICAgICAgdmFyIHByZWZpeCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICB2YXIgdGFnID0gcHJlZml4ID4+IDMKICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgdmFyIHBhY2tlZEVuZCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgcGFja2VkRW5kICs9IG9mZnNldAogICAgICAgICAgd2hpbGUgKG9mZnNldCA8IHBhY2tlZEVuZCkgewogICAgICAgICAgICBvYmoua2V5cy5wdXNoKGVuY29kaW5ncy52YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KSkKICAgICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICB9CiAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgdmFyIHBhY2tlZEVuZCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgcGFja2VkRW5kICs9IG9mZnNldAogICAgICAgICAgd2hpbGUgKG9mZnNldCA8IHBhY2tlZEVuZCkgewogICAgICAgICAgICBvYmouY2hpbGRyZW4ucHVzaChlbmNvZGluZ3MudmFyaW50LmRlY29kZShidWYsIG9mZnNldCkpCiAgICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgfQogICAgICAgICAgYnJlYWsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBvZmZzZXQgPSBza2lwKHByZWZpeCAmIDcsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgWW9sb0luZGV4LmVuY29kaW5nTGVuZ3RoID0gZW5jb2RpbmdMZW5ndGgKICBZb2xvSW5kZXguZW5jb2RlID0gZW5jb2RlCiAgWW9sb0luZGV4LmRlY29kZSA9IGRlY29kZQoKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAob2JqKSB7CiAgICB2YXIgbGVuZ3RoID0gMAogICAgaWYgKGRlZmluZWQob2JqLmxldmVscykpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmoubGV2ZWxzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5sZXZlbHNbaV0pKSBjb250aW51ZQogICAgICAgIHZhciBsZW4gPSBMZXZlbC5lbmNvZGluZ0xlbmd0aChvYmoubGV2ZWxzW2ldKQogICAgICAgIGxlbmd0aCArPSB2YXJpbnQuZW5jb2RpbmdMZW5ndGgobGVuKQogICAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIH0KICAgIH0KICAgIHJldHVybiBsZW5ndGgKICB9CgogIGZ1bmN0aW9uIGVuY29kZSAob2JqLCBidWYsIG9mZnNldCkgewogICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgIGlmICghYnVmKSBidWYgPSBiNGEuYWxsb2NVbnNhZmUoZW5jb2RpbmdMZW5ndGgob2JqKSkKICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgIGlmIChkZWZpbmVkKG9iai5sZXZlbHMpKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmxldmVscy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICghZGVmaW5lZChvYmoubGV2ZWxzW2ldKSkgY29udGludWUKICAgICAgICBidWZbb2Zmc2V0KytdID0gMTAKICAgICAgICB2YXJpbnQuZW5jb2RlKExldmVsLmVuY29kaW5nTGVuZ3RoKG9iai5sZXZlbHNbaV0pLCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgICAgIExldmVsLmVuY29kZShvYmoubGV2ZWxzW2ldLCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gTGV2ZWwuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgIH0KICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgcmV0dXJuIGJ1ZgogIH0KCiAgZnVuY3Rpb24gZGVjb2RlIChidWYsIG9mZnNldCwgZW5kKSB7CiAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgaWYgKCFlbmQpIGVuZCA9IGJ1Zi5sZW5ndGgKICAgIGlmICghKGVuZCA8PSBidWYubGVuZ3RoICYmIG9mZnNldCA8PSBidWYubGVuZ3RoKSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgIHZhciBvYmogPSB7CiAgICAgIGxldmVsczogW10KICAgIH0KICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmIChlbmQgPD0gb2Zmc2V0KSB7CiAgICAgICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgICAgcmV0dXJuIG9iagogICAgICB9CiAgICAgIHZhciBwcmVmaXggPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICB2YXIgdGFnID0gcHJlZml4ID4+IDMKICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICBjYXNlIDE6CiAgICAgICAgdmFyIGxlbiA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICBvYmoubGV2ZWxzLnB1c2goTGV2ZWwuZGVjb2RlKGJ1Ziwgb2Zmc2V0LCBvZmZzZXQgKyBsZW4pKQogICAgICAgIG9mZnNldCArPSBMZXZlbC5kZWNvZGUuYnl0ZXMKICAgICAgICBicmVhawogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgb2Zmc2V0ID0gc2tpcChwcmVmaXggJiA3LCBidWYsIG9mZnNldCkKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gZGVmaW5lSGVhZGVyICgpIHsKICB2YXIgTWV0YWRhdGEgPSBIZWFkZXIuTWV0YWRhdGEgPSB7CiAgICBidWZmZXI6IHRydWUsCiAgICBlbmNvZGluZ0xlbmd0aDogbnVsbCwKICAgIGVuY29kZTogbnVsbCwKICAgIGRlY29kZTogbnVsbAogIH0KCiAgZGVmaW5lTWV0YWRhdGEoKQoKICBmdW5jdGlvbiBkZWZpbmVNZXRhZGF0YSAoKSB7CiAgICBNZXRhZGF0YS5lbmNvZGluZ0xlbmd0aCA9IGVuY29kaW5nTGVuZ3RoCiAgICBNZXRhZGF0YS5lbmNvZGUgPSBlbmNvZGUKICAgIE1ldGFkYXRhLmRlY29kZSA9IGRlY29kZQoKICAgIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChvYmopIHsKICAgICAgdmFyIGxlbmd0aCA9IDAKICAgICAgaWYgKGRlZmluZWQob2JqLmNvbnRlbnRGZWVkKSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLmNvbnRlbnRGZWVkKQogICAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLnVzZXJEYXRhKSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLnVzZXJEYXRhKQogICAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIH0KICAgICAgcmV0dXJuIGxlbmd0aAogICAgfQoKICAgIGZ1bmN0aW9uIGVuY29kZSAob2JqLCBidWYsIG9mZnNldCkgewogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgICBpZiAoIWJ1ZikgYnVmID0gYjRhLmFsbG9jVW5zYWZlKGVuY29kaW5nTGVuZ3RoKG9iaikpCiAgICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgICAgaWYgKGRlZmluZWQob2JqLmNvbnRlbnRGZWVkKSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSAxMAogICAgICAgIGVuY29kaW5ncy5ieXRlcy5lbmNvZGUob2JqLmNvbnRlbnRGZWVkLCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai51c2VyRGF0YSkpIHsKICAgICAgICBidWZbb2Zmc2V0KytdID0gMTgKICAgICAgICBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlKG9iai51c2VyRGF0YSwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgcmV0dXJuIGJ1ZgogICAgfQoKICAgIGZ1bmN0aW9uIGRlY29kZSAoYnVmLCBvZmZzZXQsIGVuZCkgewogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgICBpZiAoIWVuZCkgZW5kID0gYnVmLmxlbmd0aAogICAgICBpZiAoIShlbmQgPD0gYnVmLmxlbmd0aCAmJiBvZmZzZXQgPD0gYnVmLmxlbmd0aCkpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgICAgdmFyIG9iaiA9IHsKICAgICAgICBjb250ZW50RmVlZDogbnVsbCwKICAgICAgICB1c2VyRGF0YTogbnVsbAogICAgICB9CiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgaWYgKGVuZCA8PSBvZmZzZXQpIHsKICAgICAgICAgIGRlY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICAgICAgcmV0dXJuIG9iagogICAgICAgIH0KICAgICAgICB2YXIgcHJlZml4ID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIHZhciB0YWcgPSBwcmVmaXggPj4gMwogICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICBvYmouY29udGVudEZlZWQgPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICBvYmoudXNlckRhdGEgPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgb2Zmc2V0ID0gc2tpcChwcmVmaXggJiA3LCBidWYsIG9mZnNldCkKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIEhlYWRlci5lbmNvZGluZ0xlbmd0aCA9IGVuY29kaW5nTGVuZ3RoCiAgSGVhZGVyLmVuY29kZSA9IGVuY29kZQogIEhlYWRlci5kZWNvZGUgPSBkZWNvZGUKCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKG9iaikgewogICAgdmFyIGxlbmd0aCA9IDAKICAgIGlmICghZGVmaW5lZChvYmoucHJvdG9jb2wpKSB0aHJvdyBuZXcgRXJyb3IoInByb3RvY29sIGlzIHJlcXVpcmVkIikKICAgIHZhciBsZW4gPSBlbmNvZGluZ3Muc3RyaW5nLmVuY29kaW5nTGVuZ3RoKG9iai5wcm90b2NvbCkKICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICBpZiAoZGVmaW5lZChvYmoubWV0YWRhdGEpKSB7CiAgICAgIHZhciBsZW4gPSBNZXRhZGF0YS5lbmNvZGluZ0xlbmd0aChvYmoubWV0YWRhdGEpCiAgICAgIGxlbmd0aCArPSB2YXJpbnQuZW5jb2RpbmdMZW5ndGgobGVuKQogICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgfQogICAgcmV0dXJuIGxlbmd0aAogIH0KCiAgZnVuY3Rpb24gZW5jb2RlIChvYmosIGJ1Ziwgb2Zmc2V0KSB7CiAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgaWYgKCFidWYpIGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShlbmNvZGluZ0xlbmd0aChvYmopKQogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgaWYgKCFkZWZpbmVkKG9iai5wcm90b2NvbCkpIHRocm93IG5ldyBFcnJvcigicHJvdG9jb2wgaXMgcmVxdWlyZWQiKQogICAgYnVmW29mZnNldCsrXSA9IDEwCiAgICBlbmNvZGluZ3Muc3RyaW5nLmVuY29kZShvYmoucHJvdG9jb2wsIGJ1Ziwgb2Zmc2V0KQogICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5zdHJpbmcuZW5jb2RlLmJ5dGVzCiAgICBpZiAoZGVmaW5lZChvYmoubWV0YWRhdGEpKSB7CiAgICAgIGJ1ZltvZmZzZXQrK10gPSAxOAogICAgICB2YXJpbnQuZW5jb2RlKE1ldGFkYXRhLmVuY29kaW5nTGVuZ3RoKG9iai5tZXRhZGF0YSksIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgICBNZXRhZGF0YS5lbmNvZGUob2JqLm1ldGFkYXRhLCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IE1ldGFkYXRhLmVuY29kZS5ieXRlcwogICAgfQogICAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICByZXR1cm4gYnVmCiAgfQoKICBmdW5jdGlvbiBkZWNvZGUgKGJ1Ziwgb2Zmc2V0LCBlbmQpIHsKICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICBpZiAoIWVuZCkgZW5kID0gYnVmLmxlbmd0aAogICAgaWYgKCEoZW5kIDw9IGJ1Zi5sZW5ndGggJiYgb2Zmc2V0IDw9IGJ1Zi5sZW5ndGgpKSB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgbWVzc2FnZSBpcyBub3QgdmFsaWQiKQogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgdmFyIG9iaiA9IHsKICAgICAgcHJvdG9jb2w6ICIiLAogICAgICBtZXRhZGF0YTogbnVsbAogICAgfQogICAgdmFyIGZvdW5kMCA9IGZhbHNlCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAoZW5kIDw9IG9mZnNldCkgewogICAgICAgIGlmICghZm91bmQwKSB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgbWVzc2FnZSBpcyBub3QgdmFsaWQiKQogICAgICAgIGRlY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICAgIHJldHVybiBvYmoKICAgICAgfQogICAgICB2YXIgcHJlZml4ID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgdmFyIHRhZyA9IHByZWZpeCA+PiAzCiAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgIG9iai5wcm90b2NvbCA9IGVuY29kaW5ncy5zdHJpbmcuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3Muc3RyaW5nLmRlY29kZS5ieXRlcwogICAgICAgIGZvdW5kMCA9IHRydWUKICAgICAgICBicmVhawogICAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgbGVuID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIG9iai5tZXRhZGF0YSA9IE1ldGFkYXRhLmRlY29kZShidWYsIG9mZnNldCwgb2Zmc2V0ICsgbGVuKQogICAgICAgIG9mZnNldCArPSBNZXRhZGF0YS5kZWNvZGUuYnl0ZXMKICAgICAgICBicmVhawogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgb2Zmc2V0ID0gc2tpcChwcmVmaXggJiA3LCBidWYsIG9mZnNldCkKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gZGVmaW5lTm9kZSAoKSB7CiAgTm9kZS5lbmNvZGluZ0xlbmd0aCA9IGVuY29kaW5nTGVuZ3RoCiAgTm9kZS5lbmNvZGUgPSBlbmNvZGUKICBOb2RlLmRlY29kZSA9IGRlY29kZQoKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAob2JqKSB7CiAgICB2YXIgbGVuZ3RoID0gMAogICAgaWYgKCFkZWZpbmVkKG9iai5pbmRleCkpIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgcmVxdWlyZWQiKQogICAgdmFyIGxlbiA9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGluZ0xlbmd0aChvYmouaW5kZXgpCiAgICBsZW5ndGggKz0gMSArIGxlbgogICAgaWYgKCFkZWZpbmVkKG9iai5rZXkpKSB0aHJvdyBuZXcgRXJyb3IoImtleSBpcyByZXF1aXJlZCIpCiAgICB2YXIgbGVuID0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kaW5nTGVuZ3RoKG9iai5rZXkpCiAgICBsZW5ndGggKz0gMSArIGxlbgogICAgaWYgKGRlZmluZWQob2JqLnZhbHVlKSkgewogICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kaW5nTGVuZ3RoKG9iai52YWx1ZSkKICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgIH0KICAgIHJldHVybiBsZW5ndGgKICB9CgogIGZ1bmN0aW9uIGVuY29kZSAob2JqLCBidWYsIG9mZnNldCkgewogICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgIGlmICghYnVmKSBidWYgPSBiNGEuYWxsb2NVbnNhZmUoZW5jb2RpbmdMZW5ndGgob2JqKSkKICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgIGlmICghZGVmaW5lZChvYmouaW5kZXgpKSB0aHJvdyBuZXcgRXJyb3IoImluZGV4IGlzIHJlcXVpcmVkIikKICAgIGJ1ZltvZmZzZXQrK10gPSAxMAogICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmouaW5kZXgsIGJ1Ziwgb2Zmc2V0KQogICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGUuYnl0ZXMKICAgIGlmICghZGVmaW5lZChvYmoua2V5KSkgdGhyb3cgbmV3IEVycm9yKCJrZXkgaXMgcmVxdWlyZWQiKQogICAgYnVmW29mZnNldCsrXSA9IDE4CiAgICBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlKG9iai5rZXksIGJ1Ziwgb2Zmc2V0KQogICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGUuYnl0ZXMKICAgIGlmIChkZWZpbmVkKG9iai52YWx1ZSkpIHsKICAgICAgYnVmW29mZnNldCsrXSA9IDI2CiAgICAgIGVuY29kaW5ncy5ieXRlcy5lbmNvZGUob2JqLnZhbHVlLCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGUuYnl0ZXMKICAgIH0KICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgcmV0dXJuIGJ1ZgogIH0KCiAgZnVuY3Rpb24gZGVjb2RlIChidWYsIG9mZnNldCwgZW5kKSB7CiAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgaWYgKCFlbmQpIGVuZCA9IGJ1Zi5sZW5ndGgKICAgIGlmICghKGVuZCA8PSBidWYubGVuZ3RoICYmIG9mZnNldCA8PSBidWYubGVuZ3RoKSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgIHZhciBvYmogPSB7CiAgICAgIGluZGV4OiBudWxsLAogICAgICBrZXk6IG51bGwsCiAgICAgIHZhbHVlOiBudWxsCiAgICB9CiAgICB2YXIgZm91bmQwID0gZmFsc2UKICAgIHZhciBmb3VuZDEgPSBmYWxzZQogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKGVuZCA8PSBvZmZzZXQpIHsKICAgICAgICBpZiAoIWZvdW5kMCB8fCAhZm91bmQxKSB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgbWVzc2FnZSBpcyBub3QgdmFsaWQiKQogICAgICAgIGRlY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICAgIHJldHVybiBvYmoKICAgICAgfQogICAgICB2YXIgcHJlZml4ID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgdmFyIHRhZyA9IHByZWZpeCA+PiAzCiAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgIG9iai5pbmRleCA9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUuYnl0ZXMKICAgICAgICBmb3VuZDAgPSB0cnVlCiAgICAgICAgYnJlYWsKICAgICAgICBjYXNlIDI6CiAgICAgICAgb2JqLmtleSA9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUuYnl0ZXMKICAgICAgICBmb3VuZDEgPSB0cnVlCiAgICAgICAgYnJlYWsKICAgICAgICBjYXNlIDM6CiAgICAgICAgb2JqLnZhbHVlID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZS5ieXRlcwogICAgICAgIGJyZWFrCiAgICAgICAgZGVmYXVsdDoKICAgICAgICBvZmZzZXQgPSBza2lwKHByZWZpeCAmIDcsIGJ1Ziwgb2Zmc2V0KQogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBkZWZpbmVFeHRlbnNpb24gKCkgewogIHZhciBHZXQgPSBFeHRlbnNpb24uR2V0ID0gewogICAgYnVmZmVyOiB0cnVlLAogICAgZW5jb2RpbmdMZW5ndGg6IG51bGwsCiAgICBlbmNvZGU6IG51bGwsCiAgICBkZWNvZGU6IG51bGwKICB9CgogIHZhciBJdGVyYXRvciA9IEV4dGVuc2lvbi5JdGVyYXRvciA9IHsKICAgIGJ1ZmZlcjogdHJ1ZSwKICAgIGVuY29kaW5nTGVuZ3RoOiBudWxsLAogICAgZW5jb2RlOiBudWxsLAogICAgZGVjb2RlOiBudWxsCiAgfQoKICB2YXIgQ2FjaGUgPSBFeHRlbnNpb24uQ2FjaGUgPSB7CiAgICBidWZmZXI6IHRydWUsCiAgICBlbmNvZGluZ0xlbmd0aDogbnVsbCwKICAgIGVuY29kZTogbnVsbCwKICAgIGRlY29kZTogbnVsbAogIH0KCiAgZGVmaW5lR2V0KCkKICBkZWZpbmVJdGVyYXRvcigpCiAgZGVmaW5lQ2FjaGUoKQoKICBmdW5jdGlvbiBkZWZpbmVHZXQgKCkgewogICAgR2V0LmVuY29kaW5nTGVuZ3RoID0gZW5jb2RpbmdMZW5ndGgKICAgIEdldC5lbmNvZGUgPSBlbmNvZGUKICAgIEdldC5kZWNvZGUgPSBkZWNvZGUKCiAgICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAob2JqKSB7CiAgICAgIHZhciBsZW5ndGggPSAwCiAgICAgIGlmIChkZWZpbmVkKG9iai52ZXJzaW9uKSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai52ZXJzaW9uKQogICAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmtleSkpIHsKICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kaW5nTGVuZ3RoKG9iai5rZXkpCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICByZXR1cm4gbGVuZ3RoCiAgICB9CgogICAgZnVuY3Rpb24gZW5jb2RlIChvYmosIGJ1Ziwgb2Zmc2V0KSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghYnVmKSBidWYgPSBiNGEuYWxsb2NVbnNhZmUoZW5jb2RpbmdMZW5ndGgob2JqKSkKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICBpZiAoZGVmaW5lZChvYmoudmVyc2lvbikpIHsKICAgICAgICBidWZbb2Zmc2V0KytdID0gOAogICAgICAgIGVuY29kaW5ncy52YXJpbnQuZW5jb2RlKG9iai52ZXJzaW9uLCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoua2V5KSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSAxOAogICAgICAgIGVuY29kaW5ncy5ieXRlcy5lbmNvZGUob2JqLmtleSwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgcmV0dXJuIGJ1ZgogICAgfQoKICAgIGZ1bmN0aW9uIGRlY29kZSAoYnVmLCBvZmZzZXQsIGVuZCkgewogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgICBpZiAoIWVuZCkgZW5kID0gYnVmLmxlbmd0aAogICAgICBpZiAoIShlbmQgPD0gYnVmLmxlbmd0aCAmJiBvZmZzZXQgPD0gYnVmLmxlbmd0aCkpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgICAgdmFyIG9iaiA9IHsKICAgICAgICB2ZXJzaW9uOiAwLAogICAgICAgIGtleTogbnVsbAogICAgICB9CiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgaWYgKGVuZCA8PSBvZmZzZXQpIHsKICAgICAgICAgIGRlY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICAgICAgcmV0dXJuIG9iagogICAgICAgIH0KICAgICAgICB2YXIgcHJlZml4ID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIHZhciB0YWcgPSBwcmVmaXggPj4gMwogICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICBvYmoudmVyc2lvbiA9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgb2JqLmtleSA9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZS5ieXRlcwogICAgICAgICAgYnJlYWsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBvZmZzZXQgPSBza2lwKHByZWZpeCAmIDcsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZGVmaW5lSXRlcmF0b3IgKCkgewogICAgSXRlcmF0b3IuZW5jb2RpbmdMZW5ndGggPSBlbmNvZGluZ0xlbmd0aAogICAgSXRlcmF0b3IuZW5jb2RlID0gZW5jb2RlCiAgICBJdGVyYXRvci5kZWNvZGUgPSBkZWNvZGUKCiAgICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAob2JqKSB7CiAgICAgIHZhciBsZW5ndGggPSAwCiAgICAgIGlmIChkZWZpbmVkKG9iai52ZXJzaW9uKSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai52ZXJzaW9uKQogICAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmd0ZSkpIHsKICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kaW5nTGVuZ3RoKG9iai5ndGUpCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmouZ3QpKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGluZ0xlbmd0aChvYmouZ3QpCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoubHRlKSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLmx0ZSkKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5sdCkpIHsKICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kaW5nTGVuZ3RoKG9iai5sdCkKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5saW1pdCkpIHsKICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGluZ0xlbmd0aChvYmoubGltaXQpCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoucmV2ZXJzZSkpIHsKICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLmJvb2wuZW5jb2RpbmdMZW5ndGgob2JqLnJldmVyc2UpCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmouY2hlY2twb2ludCkpIHsKICAgICAgICB2YXIgcGFja2VkTGVuID0gMAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmNoZWNrcG9pbnQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmouY2hlY2twb2ludFtpXSkpIGNvbnRpbnVlCiAgICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGluZ0xlbmd0aChvYmouY2hlY2twb2ludFtpXSkKICAgICAgICAgIHBhY2tlZExlbiArPSBsZW4KICAgICAgICB9CiAgICAgICAgaWYgKHBhY2tlZExlbikgewogICAgICAgICAgbGVuZ3RoICs9IDEgKyBwYWNrZWRMZW4gKyB2YXJpbnQuZW5jb2RpbmdMZW5ndGgocGFja2VkTGVuKQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbGVuZ3RoCiAgICB9CgogICAgZnVuY3Rpb24gZW5jb2RlIChvYmosIGJ1Ziwgb2Zmc2V0KSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghYnVmKSBidWYgPSBiNGEuYWxsb2NVbnNhZmUoZW5jb2RpbmdMZW5ndGgob2JqKSkKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICBpZiAoZGVmaW5lZChvYmoudmVyc2lvbikpIHsKICAgICAgICBidWZbb2Zmc2V0KytdID0gOAogICAgICAgIGVuY29kaW5ncy52YXJpbnQuZW5jb2RlKG9iai52ZXJzaW9uLCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmouZ3RlKSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSAxOAogICAgICAgIGVuY29kaW5ncy5ieXRlcy5lbmNvZGUob2JqLmd0ZSwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmouZ3QpKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDI2CiAgICAgICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmouZ3QsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmx0ZSkpIHsKICAgICAgICBidWZbb2Zmc2V0KytdID0gMzQKICAgICAgICBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlKG9iai5sdGUsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmx0KSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSA0MgogICAgICAgIGVuY29kaW5ncy5ieXRlcy5lbmNvZGUob2JqLmx0LCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5saW1pdCkpIHsKICAgICAgICBidWZbb2Zmc2V0KytdID0gNDgKICAgICAgICBlbmNvZGluZ3MudmFyaW50LmVuY29kZShvYmoubGltaXQsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5yZXZlcnNlKSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSA1NgogICAgICAgIGVuY29kaW5ncy5ib29sLmVuY29kZShvYmoucmV2ZXJzZSwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ib29sLmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5jaGVja3BvaW50KSkgewogICAgICAgIHZhciBwYWNrZWRMZW4gPSAwCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouY2hlY2twb2ludC5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5jaGVja3BvaW50W2ldKSkgY29udGludWUKICAgICAgICAgIHBhY2tlZExlbiArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5jaGVja3BvaW50W2ldKQogICAgICAgIH0KICAgICAgICBpZiAocGFja2VkTGVuKSB7CiAgICAgICAgICBidWZbb2Zmc2V0KytdID0gNjYKICAgICAgICAgIHZhcmludC5lbmNvZGUocGFja2VkTGVuLCBidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmNoZWNrcG9pbnQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmouY2hlY2twb2ludFtpXSkpIGNvbnRpbnVlCiAgICAgICAgICBlbmNvZGluZ3MudmFyaW50LmVuY29kZShvYmouY2hlY2twb2ludFtpXSwgYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgICB9CiAgICAgIH0KICAgICAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgIHJldHVybiBidWYKICAgIH0KCiAgICBmdW5jdGlvbiBkZWNvZGUgKGJ1Ziwgb2Zmc2V0LCBlbmQpIHsKICAgICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgICAgaWYgKCFlbmQpIGVuZCA9IGJ1Zi5sZW5ndGgKICAgICAgaWYgKCEoZW5kIDw9IGJ1Zi5sZW5ndGggJiYgb2Zmc2V0IDw9IGJ1Zi5sZW5ndGgpKSB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgbWVzc2FnZSBpcyBub3QgdmFsaWQiKQogICAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICAgIHZhciBvYmogPSB7CiAgICAgICAgdmVyc2lvbjogMCwKICAgICAgICBndGU6IG51bGwsCiAgICAgICAgZ3Q6IG51bGwsCiAgICAgICAgbHRlOiBudWxsLAogICAgICAgIGx0OiBudWxsLAogICAgICAgIGxpbWl0OiAwLAogICAgICAgIHJldmVyc2U6IGZhbHNlLAogICAgICAgIGNoZWNrcG9pbnQ6IFtdCiAgICAgIH0KICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBpZiAoZW5kIDw9IG9mZnNldCkgewogICAgICAgICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgICAgICByZXR1cm4gb2JqCiAgICAgICAgfQogICAgICAgIHZhciBwcmVmaXggPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgdmFyIHRhZyA9IHByZWZpeCA+PiAzCiAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgIG9iai52ZXJzaW9uID0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICBvYmouZ3RlID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgb2JqLmd0ID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgb2JqLmx0ZSA9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZS5ieXRlcwogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgNToKICAgICAgICAgIG9iai5sdCA9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZS5ieXRlcwogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgIG9iai5saW1pdCA9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSA3OgogICAgICAgICAgb2JqLnJldmVyc2UgPSBlbmNvZGluZ3MuYm9vbC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJvb2wuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSA4OgogICAgICAgICAgdmFyIHBhY2tlZEVuZCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgcGFja2VkRW5kICs9IG9mZnNldAogICAgICAgICAgd2hpbGUgKG9mZnNldCA8IHBhY2tlZEVuZCkgewogICAgICAgICAgICBvYmouY2hlY2twb2ludC5wdXNoKGVuY29kaW5ncy52YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KSkKICAgICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICB9CiAgICAgICAgICBicmVhawogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIG9mZnNldCA9IHNraXAocHJlZml4ICYgNywgYnVmLCBvZmZzZXQpCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkZWZpbmVDYWNoZSAoKSB7CiAgICBDYWNoZS5lbmNvZGluZ0xlbmd0aCA9IGVuY29kaW5nTGVuZ3RoCiAgICBDYWNoZS5lbmNvZGUgPSBlbmNvZGUKICAgIENhY2hlLmRlY29kZSA9IGRlY29kZQoKICAgIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChvYmopIHsKICAgICAgdmFyIGxlbmd0aCA9IDAKICAgICAgaWYgKCFkZWZpbmVkKG9iai5zdGFydCkpIHRocm93IG5ldyBFcnJvcigic3RhcnQgaXMgcmVxdWlyZWQiKQogICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGluZ0xlbmd0aChvYmouc3RhcnQpCiAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIGlmICghZGVmaW5lZChvYmouZW5kKSkgdGhyb3cgbmV3IEVycm9yKCJlbmQgaXMgcmVxdWlyZWQiKQogICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGluZ0xlbmd0aChvYmouZW5kKQogICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICBpZiAoZGVmaW5lZChvYmouYmxvY2tzKSkgewogICAgICAgIHZhciBwYWNrZWRMZW4gPSAwCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouYmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmJsb2Nrc1tpXSkpIGNvbnRpbnVlCiAgICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGluZ0xlbmd0aChvYmouYmxvY2tzW2ldKQogICAgICAgICAgcGFja2VkTGVuICs9IGxlbgogICAgICAgIH0KICAgICAgICBpZiAocGFja2VkTGVuKSB7CiAgICAgICAgICBsZW5ndGggKz0gMSArIHBhY2tlZExlbiArIHZhcmludC5lbmNvZGluZ0xlbmd0aChwYWNrZWRMZW4pCiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBsZW5ndGgKICAgIH0KCiAgICBmdW5jdGlvbiBlbmNvZGUgKG9iaiwgYnVmLCBvZmZzZXQpIHsKICAgICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgICAgaWYgKCFidWYpIGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShlbmNvZGluZ0xlbmd0aChvYmopKQogICAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICAgIGlmICghZGVmaW5lZChvYmouc3RhcnQpKSB0aHJvdyBuZXcgRXJyb3IoInN0YXJ0IGlzIHJlcXVpcmVkIikKICAgICAgYnVmW29mZnNldCsrXSA9IDgKICAgICAgZW5jb2RpbmdzLnZhcmludC5lbmNvZGUob2JqLnN0YXJ0LCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgIGlmICghZGVmaW5lZChvYmouZW5kKSkgdGhyb3cgbmV3IEVycm9yKCJlbmQgaXMgcmVxdWlyZWQiKQogICAgICBidWZbb2Zmc2V0KytdID0gMTYKICAgICAgZW5jb2RpbmdzLnZhcmludC5lbmNvZGUob2JqLmVuZCwgYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kZS5ieXRlcwogICAgICBpZiAoZGVmaW5lZChvYmouYmxvY2tzKSkgewogICAgICAgIHZhciBwYWNrZWRMZW4gPSAwCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouYmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmJsb2Nrc1tpXSkpIGNvbnRpbnVlCiAgICAgICAgICBwYWNrZWRMZW4gKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGluZ0xlbmd0aChvYmouYmxvY2tzW2ldKQogICAgICAgIH0KICAgICAgICBpZiAocGFja2VkTGVuKSB7CiAgICAgICAgICBidWZbb2Zmc2V0KytdID0gMjYKICAgICAgICAgIHZhcmludC5lbmNvZGUocGFja2VkTGVuLCBidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmJsb2Nrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5ibG9ja3NbaV0pKSBjb250aW51ZQogICAgICAgICAgZW5jb2RpbmdzLnZhcmludC5lbmNvZGUob2JqLmJsb2Nrc1tpXSwgYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgICB9CiAgICAgIH0KICAgICAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgIHJldHVybiBidWYKICAgIH0KCiAgICBmdW5jdGlvbiBkZWNvZGUgKGJ1Ziwgb2Zmc2V0LCBlbmQpIHsKICAgICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgICAgaWYgKCFlbmQpIGVuZCA9IGJ1Zi5sZW5ndGgKICAgICAgaWYgKCEoZW5kIDw9IGJ1Zi5sZW5ndGggJiYgb2Zmc2V0IDw9IGJ1Zi5sZW5ndGgpKSB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgbWVzc2FnZSBpcyBub3QgdmFsaWQiKQogICAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICAgIHZhciBvYmogPSB7CiAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgZW5kOiAwLAogICAgICAgIGJsb2NrczogW10KICAgICAgfQogICAgICB2YXIgZm91bmQwID0gZmFsc2UKICAgICAgdmFyIGZvdW5kMSA9IGZhbHNlCiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgaWYgKGVuZCA8PSBvZmZzZXQpIHsKICAgICAgICAgIGlmICghZm91bmQwIHx8ICFmb3VuZDEpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICAgICAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgICAgIHJldHVybiBvYmoKICAgICAgICB9CiAgICAgICAgdmFyIHByZWZpeCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICB2YXIgdGFnID0gcHJlZml4ID4+IDMKICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgb2JqLnN0YXJ0ID0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGZvdW5kMCA9IHRydWUKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICBvYmouZW5kID0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGZvdW5kMSA9IHRydWUKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICB2YXIgcGFja2VkRW5kID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBwYWNrZWRFbmQgKz0gb2Zmc2V0CiAgICAgICAgICB3aGlsZSAob2Zmc2V0IDwgcGFja2VkRW5kKSB7CiAgICAgICAgICAgIG9iai5ibG9ja3MucHVzaChlbmNvZGluZ3MudmFyaW50LmRlY29kZShidWYsIG9mZnNldCkpCiAgICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgfQogICAgICAgICAgYnJlYWsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBvZmZzZXQgPSBza2lwKHByZWZpeCAmIDcsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgRXh0ZW5zaW9uLmVuY29kaW5nTGVuZ3RoID0gZW5jb2RpbmdMZW5ndGgKICBFeHRlbnNpb24uZW5jb2RlID0gZW5jb2RlCiAgRXh0ZW5zaW9uLmRlY29kZSA9IGRlY29kZQoKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAob2JqKSB7CiAgICB2YXIgbGVuZ3RoID0gMAogICAgaWYgKGRlZmluZWQob2JqLmNhY2hlKSkgewogICAgICB2YXIgbGVuID0gQ2FjaGUuZW5jb2RpbmdMZW5ndGgob2JqLmNhY2hlKQogICAgICBsZW5ndGggKz0gdmFyaW50LmVuY29kaW5nTGVuZ3RoKGxlbikKICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgIH0KICAgIGlmIChkZWZpbmVkKG9iai5nZXQpKSB7CiAgICAgIHZhciBsZW4gPSBHZXQuZW5jb2RpbmdMZW5ndGgob2JqLmdldCkKICAgICAgbGVuZ3RoICs9IHZhcmludC5lbmNvZGluZ0xlbmd0aChsZW4pCiAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICB9CiAgICBpZiAoZGVmaW5lZChvYmouaXRlcmF0b3IpKSB7CiAgICAgIHZhciBsZW4gPSBJdGVyYXRvci5lbmNvZGluZ0xlbmd0aChvYmouaXRlcmF0b3IpCiAgICAgIGxlbmd0aCArPSB2YXJpbnQuZW5jb2RpbmdMZW5ndGgobGVuKQogICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgfQogICAgcmV0dXJuIGxlbmd0aAogIH0KCiAgZnVuY3Rpb24gZW5jb2RlIChvYmosIGJ1Ziwgb2Zmc2V0KSB7CiAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgaWYgKCFidWYpIGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShlbmNvZGluZ0xlbmd0aChvYmopKQogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgaWYgKGRlZmluZWQob2JqLmNhY2hlKSkgewogICAgICBidWZbb2Zmc2V0KytdID0gMTAKICAgICAgdmFyaW50LmVuY29kZShDYWNoZS5lbmNvZGluZ0xlbmd0aChvYmouY2FjaGUpLCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgQ2FjaGUuZW5jb2RlKG9iai5jYWNoZSwgYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSBDYWNoZS5lbmNvZGUuYnl0ZXMKICAgIH0KICAgIGlmIChkZWZpbmVkKG9iai5nZXQpKSB7CiAgICAgIGJ1ZltvZmZzZXQrK10gPSAxOAogICAgICB2YXJpbnQuZW5jb2RlKEdldC5lbmNvZGluZ0xlbmd0aChvYmouZ2V0KSwgYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgIEdldC5lbmNvZGUob2JqLmdldCwgYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSBHZXQuZW5jb2RlLmJ5dGVzCiAgICB9CiAgICBpZiAoZGVmaW5lZChvYmouaXRlcmF0b3IpKSB7CiAgICAgIGJ1ZltvZmZzZXQrK10gPSAyNgogICAgICB2YXJpbnQuZW5jb2RlKEl0ZXJhdG9yLmVuY29kaW5nTGVuZ3RoKG9iai5pdGVyYXRvciksIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgICBJdGVyYXRvci5lbmNvZGUob2JqLml0ZXJhdG9yLCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IEl0ZXJhdG9yLmVuY29kZS5ieXRlcwogICAgfQogICAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICByZXR1cm4gYnVmCiAgfQoKICBmdW5jdGlvbiBkZWNvZGUgKGJ1Ziwgb2Zmc2V0LCBlbmQpIHsKICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICBpZiAoIWVuZCkgZW5kID0gYnVmLmxlbmd0aAogICAgaWYgKCEoZW5kIDw9IGJ1Zi5sZW5ndGggJiYgb2Zmc2V0IDw9IGJ1Zi5sZW5ndGgpKSB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgbWVzc2FnZSBpcyBub3QgdmFsaWQiKQogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgdmFyIG9iaiA9IHsKICAgICAgY2FjaGU6IG51bGwsCiAgICAgIGdldDogbnVsbCwKICAgICAgaXRlcmF0b3I6IG51bGwKICAgIH0KICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmIChlbmQgPD0gb2Zmc2V0KSB7CiAgICAgICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgICAgcmV0dXJuIG9iagogICAgICB9CiAgICAgIHZhciBwcmVmaXggPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICB2YXIgdGFnID0gcHJlZml4ID4+IDMKICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICBjYXNlIDE6CiAgICAgICAgdmFyIGxlbiA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICBvYmouY2FjaGUgPSBDYWNoZS5kZWNvZGUoYnVmLCBvZmZzZXQsIG9mZnNldCArIGxlbikKICAgICAgICBvZmZzZXQgKz0gQ2FjaGUuZGVjb2RlLmJ5dGVzCiAgICAgICAgYnJlYWsKICAgICAgICBjYXNlIDI6CiAgICAgICAgdmFyIGxlbiA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICBvYmouZ2V0ID0gR2V0LmRlY29kZShidWYsIG9mZnNldCwgb2Zmc2V0ICsgbGVuKQogICAgICAgIG9mZnNldCArPSBHZXQuZGVjb2RlLmJ5dGVzCiAgICAgICAgYnJlYWsKICAgICAgICBjYXNlIDM6CiAgICAgICAgdmFyIGxlbiA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICBvYmouaXRlcmF0b3IgPSBJdGVyYXRvci5kZWNvZGUoYnVmLCBvZmZzZXQsIG9mZnNldCArIGxlbikKICAgICAgICBvZmZzZXQgKz0gSXRlcmF0b3IuZGVjb2RlLmJ5dGVzCiAgICAgICAgYnJlYWsKICAgICAgICBkZWZhdWx0OgogICAgICAgIG9mZnNldCA9IHNraXAocHJlZml4ICYgNywgYnVmLCBvZmZzZXQpCiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGRlZmluZWQgKHZhbCkgewogIHJldHVybiB2YWwgIT09IG51bGwgJiYgdmFsICE9PSB1bmRlZmluZWQgJiYgKHR5cGVvZiB2YWwgIT09ICdudW1iZXInIHx8ICFpc05hTih2YWwpKQp9CnsKICAibmFtZSI6ICJoeXBlcmJlZSIsCiAgInZlcnNpb24iOiAiMi4yNi41IiwKICAiZGVzY3JpcHRpb24iOiAiQW4gYXBwZW5kLW9ubHkgQi10cmVlIHJ1bm5pbmcgb24gYSBIeXBlcmNvcmUuIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJsaWIvKiouanMiLAogICAgIml0ZXJhdG9ycy8qKi5qcyIKICBdLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMCIsCiAgICAiY29kZWNzIjogIl4zLjAuMCIsCiAgICAiZGVib3VuY2VpZnkiOiAiXjEuMC4wIiwKICAgICJoeXBlcmNvcmUtZXJyb3JzIjogIl4xLjAuMCIsCiAgICAibXV0ZXhpZnkiOiAiXjEuNC4wIiwKICAgICJwcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncyI6ICJeMS4yLjAiLAogICAgInJhY2hlIjogIl4xLjAuMCIsCiAgICAicmVhZHktcmVzb3VyY2UiOiAiXjEuMC4wIiwKICAgICJyZXNvbHZlLXJlamVjdC1wcm9taXNlIjogIl4xLjEuMCIsCiAgICAic2FmZXR5LWNhdGNoIjogIl4xLjAuMiIsCiAgICAic3RyZWFteCI6ICJeMi4xMi40IiwKICAgICJ1bnNsYWIiOiAiXjEuMi4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjEuMCIsCiAgICAiaHlwZXJjb3JlIjogIl4xMS4wLjAiLAogICAgInByb3RvY29sLWJ1ZmZlcnMiOiAiXjQuMi4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIiwKICAgICJzdWItZW5jb2RlciI6ICJeMS4wLjYiLAogICAgInRyZWUtdG8tc3RyaW5nIjogIl4xLjEuMSIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LyouanMiLAogICAgInByb3RvYnVmIjogInByb3RvY29sLWJ1ZmZlcnMgc2NoZW1hLnByb3RvIC1vIC4vbGliL21lc3NhZ2VzLmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJiZWUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJiZWUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmJlZSIKfQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKLy8gaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvTWVya2xlX3RyZWUjU2Vjb25kX3ByZWltYWdlX2F0dGFjawpjb25zdCBMRUFGX1RZUEUgPSBiNGEuZnJvbShbMF0pCmNvbnN0IFBBUkVOVF9UWVBFID0gYjRhLmZyb20oWzFdKQpjb25zdCBST09UX1RZUEUgPSBiNGEuZnJvbShbMl0pCgpjb25zdCBIWVBFUkNPUkUgPSBiNGEuZnJvbSgnaHlwZXJjb3JlJykKCmV4cG9ydHMua2V5UGFpciA9IGZ1bmN0aW9uIChzZWVkKSB7CiAgLy8ga2V5IHBhaXJzIG1pZ2h0IHN0YXkgYXJvdW5kIGZvciBhIHdoaWxlLCBzbyBiZXR0ZXIgbm90IHRvIHVzZSBhIGRlZmF1bHQgc2xhYiB0byBhdm9pZCByZXRhaW5pbmcgaXQgY29tcGxldGVseQogIGNvbnN0IHNsYWIgPSBiNGEuYWxsb2NVbnNhZmVTbG93KHNvZGl1bS5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUyArIHNvZGl1bS5jcnlwdG9fc2lnbl9TRUNSRVRLRVlCWVRFUykKICBjb25zdCBwdWJsaWNLZXkgPSBzbGFiLnN1YmFycmF5KDAsIHNvZGl1bS5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICBjb25zdCBzZWNyZXRLZXkgPSBzbGFiLnN1YmFycmF5KHNvZGl1bS5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKCiAgaWYgKHNlZWQpIHNvZGl1bS5jcnlwdG9fc2lnbl9zZWVkX2tleXBhaXIocHVibGljS2V5LCBzZWNyZXRLZXksIHNlZWQpCiAgZWxzZSBzb2RpdW0uY3J5cHRvX3NpZ25fa2V5cGFpcihwdWJsaWNLZXksIHNlY3JldEtleSkKCiAgcmV0dXJuIHsKICAgIHB1YmxpY0tleSwKICAgIHNlY3JldEtleQogIH0KfQoKZXhwb3J0cy52YWxpZGF0ZUtleVBhaXIgPSBmdW5jdGlvbiAoa2V5UGFpcikgewogIGNvbnN0IHBrID0gYjRhLmFsbG9jVW5zYWZlKHNvZGl1bS5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICBzb2RpdW0uY3J5cHRvX3NpZ25fZWQyNTUxOV9za190b19wayhwaywga2V5UGFpci5zZWNyZXRLZXkpCiAgcmV0dXJuIGI0YS5lcXVhbHMocGssIGtleVBhaXIucHVibGljS2V5KQp9CgpleHBvcnRzLnNpZ24gPSBmdW5jdGlvbiAobWVzc2FnZSwgc2VjcmV0S2V5KSB7CiAgLy8gRGVkaWNhdGVkIHNsYWIgZm9yIHRoZSBzaWduYXR1cmUsIHRvIGF2b2lkIHJldGFpbmluZyB1bm5lZWRlZCBtZW0gYW5kIGZvciBzZWN1cml0eQogIGNvbnN0IHNpZ25hdHVyZSA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coc29kaXVtLmNyeXB0b19zaWduX0JZVEVTKQogIHNvZGl1bS5jcnlwdG9fc2lnbl9kZXRhY2hlZChzaWduYXR1cmUsIG1lc3NhZ2UsIHNlY3JldEtleSkKICByZXR1cm4gc2lnbmF0dXJlCn0KCmV4cG9ydHMudmVyaWZ5ID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHNpZ25hdHVyZSwgcHVibGljS2V5KSB7CiAgaWYgKHNpZ25hdHVyZS5ieXRlTGVuZ3RoICE9PSBzb2RpdW0uY3J5cHRvX3NpZ25fQllURVMpIHJldHVybiBmYWxzZQogIGlmIChwdWJsaWNLZXkuYnl0ZUxlbmd0aCAhPT0gc29kaXVtLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKSByZXR1cm4gZmFsc2UKICByZXR1cm4gc29kaXVtLmNyeXB0b19zaWduX3ZlcmlmeV9kZXRhY2hlZChzaWduYXR1cmUsIG1lc3NhZ2UsIHB1YmxpY0tleSkKfQoKZXhwb3J0cy5lbmNyeXB0ID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHB1YmxpY0tleSkgewogIGNvbnN0IGNpcGhlcnRleHQgPSBiNGEuYWxsb2MobWVzc2FnZS5ieXRlTGVuZ3RoICsgc29kaXVtLmNyeXB0b19ib3hfU0VBTEJZVEVTKQogIHNvZGl1bS5jcnlwdG9fYm94X3NlYWwoY2lwaGVydGV4dCwgbWVzc2FnZSwgcHVibGljS2V5KQogIHJldHVybiBjaXBoZXJ0ZXh0Cn0KCmV4cG9ydHMuZGVjcnlwdCA9IGZ1bmN0aW9uIChjaXBoZXJ0ZXh0LCBrZXlQYWlyKSB7CiAgaWYgKGNpcGhlcnRleHQuYnl0ZUxlbmd0aCA8IHNvZGl1bS5jcnlwdG9fYm94X1NFQUxCWVRFUykgcmV0dXJuIG51bGwKCiAgY29uc3QgcGxhaW50ZXh0ID0gYjRhLmFsbG9jKGNpcGhlcnRleHQuYnl0ZUxlbmd0aCAtIHNvZGl1bS5jcnlwdG9fYm94X1NFQUxCWVRFUykKCiAgaWYgKCFzb2RpdW0uY3J5cHRvX2JveF9zZWFsX29wZW4ocGxhaW50ZXh0LCBjaXBoZXJ0ZXh0LCBrZXlQYWlyLnB1YmxpY0tleSwga2V5UGFpci5zZWNyZXRLZXkpKSB7CiAgICByZXR1cm4gbnVsbAogIH0KCiAgcmV0dXJuIHBsYWludGV4dAp9CgpleHBvcnRzLmVuY3J5cHRpb25LZXlQYWlyID0gZnVuY3Rpb24gKHNlZWQpIHsKICBjb25zdCBwdWJsaWNLZXkgPSBiNGEuYWxsb2Moc29kaXVtLmNyeXB0b19ib3hfUFVCTElDS0VZQllURVMpCiAgY29uc3Qgc2VjcmV0S2V5ID0gYjRhLmFsbG9jKHNvZGl1bS5jcnlwdG9fYm94X1NFQ1JFVEtFWUJZVEVTKQoKICBpZiAoc2VlZCkgewogICAgc29kaXVtLmNyeXB0b19ib3hfc2VlZF9rZXlwYWlyKHB1YmxpY0tleSwgc2VjcmV0S2V5LCBzZWVkKQogIH0gZWxzZSB7CiAgICBzb2RpdW0uY3J5cHRvX2JveF9rZXlwYWlyKHB1YmxpY0tleSwgc2VjcmV0S2V5KQogIH0KCiAgcmV0dXJuIHsKICAgIHB1YmxpY0tleSwKICAgIHNlY3JldEtleQogIH0KfQoKZXhwb3J0cy5kYXRhID0gZnVuY3Rpb24gKGRhdGEpIHsKICBjb25zdCBvdXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCgogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2gob3V0LCBbCiAgICBMRUFGX1RZUEUsCiAgICBjLmVuY29kZShjLnVpbnQ2NCwgZGF0YS5ieXRlTGVuZ3RoKSwKICAgIGRhdGEKICBdKQoKICByZXR1cm4gb3V0Cn0KCmV4cG9ydHMucGFyZW50ID0gZnVuY3Rpb24gKGEsIGIpIHsKICBpZiAoYS5pbmRleCA+IGIuaW5kZXgpIHsKICAgIGNvbnN0IHRtcCA9IGEKICAgIGEgPSBiCiAgICBiID0gdG1wCiAgfQoKICBjb25zdCBvdXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCgogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2gob3V0LCBbCiAgICBQQVJFTlRfVFlQRSwKICAgIGMuZW5jb2RlKGMudWludDY0LCBhLnNpemUgKyBiLnNpemUpLAogICAgYS5oYXNoLAogICAgYi5oYXNoCiAgXSkKCiAgcmV0dXJuIG91dAp9CgpleHBvcnRzLnRyZWUgPSBmdW5jdGlvbiAocm9vdHMsIG91dCkgewogIGNvbnN0IGJ1ZmZlcnMgPSBuZXcgQXJyYXkoMyAqIHJvb3RzLmxlbmd0aCArIDEpCiAgbGV0IGogPSAwCgogIGJ1ZmZlcnNbaisrXSA9IFJPT1RfVFlQRQoKICBmb3IgKGxldCBpID0gMDsgaSA8IHJvb3RzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCByID0gcm9vdHNbaV0KICAgIGJ1ZmZlcnNbaisrXSA9IHIuaGFzaAogICAgYnVmZmVyc1tqKytdID0gYy5lbmNvZGUoYy51aW50NjQsIHIuaW5kZXgpCiAgICBidWZmZXJzW2orK10gPSBjLmVuY29kZShjLnVpbnQ2NCwgci5zaXplKQogIH0KCiAgaWYgKCFvdXQpIG91dCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKG91dCwgYnVmZmVycykKICByZXR1cm4gb3V0Cn0KCmV4cG9ydHMuaGFzaCA9IGZ1bmN0aW9uIChkYXRhLCBvdXQpIHsKICBpZiAoIW91dCkgb3V0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKQogIGlmICghQXJyYXkuaXNBcnJheShkYXRhKSkgZGF0YSA9IFtkYXRhXQoKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKG91dCwgZGF0YSkKCiAgcmV0dXJuIG91dAp9CgpleHBvcnRzLnJhbmRvbUJ5dGVzID0gZnVuY3Rpb24gKG4pIHsKICBjb25zdCBidWYgPSBiNGEuYWxsb2NVbnNhZmUobikKICBzb2RpdW0ucmFuZG9tYnl0ZXNfYnVmKGJ1ZikKICByZXR1cm4gYnVmCn0KCmV4cG9ydHMuZGlzY292ZXJ5S2V5ID0gZnVuY3Rpb24gKGtleSkgewogIGlmICgha2V5IHx8IGtleS5ieXRlTGVuZ3RoICE9PSAzMikgdGhyb3cgbmV3IEVycm9yKCdNdXN0IHBhc3MgYSAzMiBieXRlIGJ1ZmZlcicpCiAgLy8gRGlzY292ZXJ5IGtleXMgbWlnaHQgc3RheSBhcm91bmQgZm9yIGEgd2hpbGUsIHNvIGJldHRlciBub3QgdG8gdXNlIHNsYWIgbWVtb3J5IChmb3IgYmV0dGVyIGdjKQogIGNvbnN0IGRpZ2VzdCA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coMzIpCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChkaWdlc3QsIEhZUEVSQ09SRSwga2V5KQogIHJldHVybiBkaWdlc3QKfQoKaWYgKHNvZGl1bS5zb2RpdW1fZnJlZSkgewogIGV4cG9ydHMuZnJlZSA9IGZ1bmN0aW9uIChzZWN1cmVCdWYpIHsKICAgIGlmIChzZWN1cmVCdWYuc2VjdXJlKSBzb2RpdW0uc29kaXVtX2ZyZWUoc2VjdXJlQnVmKQogIH0KfSBlbHNlIHsKICBleHBvcnRzLmZyZWUgPSBmdW5jdGlvbiAoKSB7fQp9CgpleHBvcnRzLm5hbWVzcGFjZSA9IGZ1bmN0aW9uIChuYW1lLCBjb3VudCkgewogIGNvbnN0IGlkcyA9IHR5cGVvZiBjb3VudCA9PT0gJ251bWJlcicgPyByYW5nZShjb3VudCkgOiBjb3VudAoKICAvLyBOYW1lc3BhY2VzIGFyZSBsb25nLWxpdmVkLCBzbyBiZXR0ZXIgdG8gdXNlIGEgZGVkaWNhdGVkIHNsYWIKICBjb25zdCBidWYgPSBiNGEuYWxsb2NVbnNhZmVTbG93KDMyICogaWRzLmxlbmd0aCkKCiAgY29uc3QgbGlzdCA9IG5ldyBBcnJheShpZHMubGVuZ3RoKQoKICAvLyBucyBpcyBlbWhlbWVyYWwsIHNvIGRlZmF1bHQgc2xhYgogIGNvbnN0IG5zID0gYjRhLmFsbG9jVW5zYWZlKDMzKQogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2gobnMuc3ViYXJyYXkoMCwgMzIpLCB0eXBlb2YgbmFtZSA9PT0gJ3N0cmluZycgPyBiNGEuZnJvbShuYW1lKSA6IG5hbWUpCgogIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgbGlzdFtpXSA9IGJ1Zi5zdWJhcnJheSgzMiAqIGksIDMyICogaSArIDMyKQogICAgbnNbMzJdID0gaWRzW2ldCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGxpc3RbaV0sIG5zKQogIH0KCiAgcmV0dXJuIGxpc3QKfQoKZnVuY3Rpb24gcmFuZ2UgKGNvdW50KSB7CiAgY29uc3QgYXJyID0gbmV3IEFycmF5KGNvdW50KQogIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykgYXJyW2ldID0gaQogIHJldHVybiBhcnIKfQp7CiAgIm5hbWUiOiAiaHlwZXJjb3JlLWNyeXB0byIsCiAgInZlcnNpb24iOiAiMy42LjEiLAogICJkZXNjcmlwdGlvbiI6ICJUaGUgY3J5cHRvIHByaW1pdGl2ZXMgdXNlZCBpbiBoeXBlcmNvcmUsIGV4dHJhY3RlZCBpbnRvIGEgc2VwYXJhdGUgbW9kdWxlIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi42IiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjE1LjAiLAogICAgInNvZGl1bS11bml2ZXJzYWwiOiAiXjUuMC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjUuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2h5cGVyY29yZS1jcnlwdG8uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2h5cGVyY29yZS1jcnlwdG8vaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvaHlwZXJjb3JlLWNyeXB0byIKfQpjb25zdCBJZEVuYyA9IHJlcXVpcmUoJ2h5cGVyY29yZS1pZC1lbmNvZGluZycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEh5cGVyY29yZUVycm9yIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yIChtc2csIGNvZGUsIGZuID0gSHlwZXJjb3JlRXJyb3IsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIGlmIChkaXNjb3ZlcnlLZXkpIG1zZyA9IGAke21zZ30gKGRpc2NvdmVyeSBrZXk6ICR7SWRFbmMubm9ybWFsaXplKGRpc2NvdmVyeUtleSl9KWAKICAgIHN1cGVyKGAke2NvZGV9OiAke21zZ31gKQoKICAgIHRoaXMuY29kZSA9IGNvZGUKICAgIHRoaXMuZGlzY292ZXJ5S2V5ID0gZGlzY292ZXJ5S2V5CgogICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIGZuKQogICAgfQogIH0KCiAgZ2V0IG5hbWUgKCkgewogICAgcmV0dXJuICdIeXBlcmNvcmVFcnJvcicKICB9CgogIHN0YXRpYyBBU1NFUlRJT04gKG1zZywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgeyAvLyBFUlJfQVNTRVJUSU9OIGlzIHBpY2tlZCB1cCBieSBzYWZldHktY2F0Y2ggYWxzbwogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdFUlJfQVNTRVJUSU9OJywgSHlwZXJjb3JlRXJyb3IuQVNTRVJULCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgQkFEX0FSR1VNRU5UIChtc2csIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnQkFEX0FSR1VNRU5UJywgSHlwZXJjb3JlRXJyb3IuQkFEX0FSR1VNRU5ULCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgU1RPUkFHRV9FTVBUWSAobXNnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ1NUT1JBR0VfRU1QVFknLCBIeXBlcmNvcmVFcnJvci5TVE9SQUdFX0VNUFRZLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgU1RPUkFHRV9DT05GTElDVCAobXNnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ1NUT1JBR0VfQ09ORkxJQ1QnLCBIeXBlcmNvcmVFcnJvci5TVE9SQUdFX0NPTkZMSUNULCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgSU5WQUxJRF9TSUdOQVRVUkUgKG1zZywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdJTlZBTElEX1NJR05BVFVSRScsIEh5cGVyY29yZUVycm9yLklOVkFMSURfU0lHTkFUVVJFLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgSU5WQUxJRF9DQVBBQklMSVRZIChtc2csIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnSU5WQUxJRF9DQVBBQklMSVRZJywgSHlwZXJjb3JlRXJyb3IuSU5WQUxJRF9DQVBBQklMSVRZLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgSU5WQUxJRF9DSEVDS1NVTSAobXNnID0gJ0ludmFsaWQgY2hlY2tzdW0nLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0lOVkFMSURfQ0hFQ0tTVU0nLCBIeXBlcmNvcmVFcnJvci5JTlZBTElEX0NIRUNLU1VNLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgSU5WQUxJRF9PUEVSQVRJT04gKG1zZywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdJTlZBTElEX09QRVJBVElPTicsIEh5cGVyY29yZUVycm9yLklOVkFMSURfT1BFUkFUSU9OLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgSU5WQUxJRF9QUk9PRiAobXNnID0gJ1Byb29mIG5vdCB2ZXJpZmlhYmxlJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdJTlZBTElEX1BST09GJywgSHlwZXJjb3JlRXJyb3IuSU5WQUxJRF9QUk9PRiwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIEJMT0NLX05PVF9BVkFJTEFCTEUgKG1zZyA9ICdCbG9jayBpcyBub3QgYXZhaWxhYmxlJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdCTE9DS19OT1RfQVZBSUxBQkxFJywgSHlwZXJjb3JlRXJyb3IuQkxPQ0tfTk9UX0FWQUlMQUJMRSwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIFNOQVBTSE9UX05PVF9BVkFJTEFCTEUgKG1zZyA9ICdTbmFwc2hvdCBpcyBub3QgYXZhaWxhYmxlJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdTTkFQU0hPVF9OT1RfQVZBSUxBQkxFJywgSHlwZXJjb3JlRXJyb3IuU05BUFNIT1RfTk9UX0FWQUlMQUJMRSwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIFJFUVVFU1RfQ0FOQ0VMTEVEIChtc2cgPSAnUmVxdWVzdCB3YXMgY2FuY2VsbGVkJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdSRVFVRVNUX0NBTkNFTExFRCcsIEh5cGVyY29yZUVycm9yLlJFUVVFU1RfQ0FOQ0VMTEVELCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgUkVRVUVTVF9USU1FT1VUIChtc2cgPSAnUmVxdWVzdCB0aW1lZCBvdXQnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ1JFUVVFU1RfVElNRU9VVCcsIEh5cGVyY29yZUVycm9yLlJFUVVFU1RfVElNRU9VVCwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIFNFU1NJT05fTk9UX1dSSVRBQkxFIChtc2cgPSAnU2Vzc2lvbiBpcyBub3Qgd3JpdGFibGUnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ1NFU1NJT05fTk9UX1dSSVRBQkxFJywgSHlwZXJjb3JlRXJyb3IuU0VTU0lPTl9OT1RfV1JJVEFCTEUsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBTRVNTSU9OX0NMT1NFRCAobXNnID0gJ1Nlc3Npb24gaXMgY2xvc2VkJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdTRVNTSU9OX0NMT1NFRCcsIEh5cGVyY29yZUVycm9yLlNFU1NJT05fQ0xPU0VELCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgQkFUQ0hfVU5GTFVTSEVEIChtc2cgPSAnQmF0Y2ggbm90IHlldCBmbHVzaGVkJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdCQVRDSF9VTkZMVVNIRUQnLCBIeXBlcmNvcmVFcnJvci5CQVRDSF9VTkZMVVNIRUQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBCQVRDSF9BTFJFQURZX0VYSVNUUyAobXNnID0gJ0JhdGNoIGFscmVhZHkgZXhpc3RzJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdCQVRDSF9BTFJFQURZX0VYSVNUUycsIEh5cGVyY29yZUVycm9yLkJBVENIX0FMUkVBRFlfRVhJU1RTLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgQkFUQ0hfQUxSRUFEWV9GTFVTSEVEIChtc2cgPSAnQmF0Y2ggaGFzIGFscmVhZHkgYmVlbiBmbHVzaGVkJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdCQVRDSF9BTFJFQURZX0ZMVVNIRUQnLCBIeXBlcmNvcmVFcnJvci5CQVRDSF9BTFJFQURZX0ZMVVNIRUQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBPUExPR19DT1JSVVBUIChtc2cgPSAnT3Bsb2cgZmlsZSBhcHBlYXJzIGNvcnJ1cHQgb3Igb3V0IG9mIGRhdGUnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ09QTE9HX0NPUlJVUFQnLCBIeXBlcmNvcmVFcnJvci5PUExPR19DT1JSVVBULCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgT1BMT0dfSEVBREVSX09WRVJGTE9XIChtc2cgPSAnT3Bsb2cgaGVhZGVyIGV4Y2VlZHMgcGFnZSBzaXplJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdPUExPR19IRUFERVJfT1ZFUkZMT1cnLCBIeXBlcmNvcmVFcnJvci5PUExPR19IRUFERVJfT1ZFUkZMT1csIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBJTlZBTElEX09QTE9HX1ZFUlNJT04gKG1zZyA9ICdJbnZhbGlkIGhlYWRlciB2ZXJzaW9uJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdJTlZBTElEX09QTE9HX1ZFUlNJT04nLCBIeXBlcmNvcmVFcnJvci5JTlZBTElEX09QTE9HX1ZFUlNJT04sIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBXUklURV9GQUlMRUQgKG1zZyA9ICdXcml0ZSB0byBzdG9yYWdlIGZhaWxlZCcsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnV1JJVEVfRkFJTEVEJywgSHlwZXJjb3JlRXJyb3IuV1JJVEVfRkFJTEVELCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgREVDT0RJTkdfRVJST1IgKG1zZyA9ICdEZWNvZGluZyBlcnJvcicsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnREVDT0RJTkdfRVJST1InLCBIeXBlcmNvcmVFcnJvci5ERUNPRElOR19FUlJPUiwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIFNFU1NJT05fTU9WRUQgKG1zZyA9ICdTZXNzaW9uIG1vdmVkJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdTRVNTSU9OX01PVkVEJywgSHlwZXJjb3JlRXJyb3IuU0VTU0lPTl9NT1ZFRCwgZGlzY292ZXJ5S2V5KQogIH0KfQp7CiAgIm5hbWUiOiAiaHlwZXJjb3JlLWVycm9ycyIsCiAgInZlcnNpb24iOiAiMS41LjAiLAogICJkZXNjcmlwdGlvbiI6ICJIeXBlcmNvcmUgZXJyb3JzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmNvcmUtZXJyb3JzLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyY29yZS1lcnJvcnMvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmNvcmUtZXJyb3JzI3JlYWRtZSIsCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi43IiwKICAgICJicml0dGxlIjogIl4zLjEuMyIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiaHlwZXJjb3JlLWlkLWVuY29kaW5nIjogIl4xLjMuMCIKICB9Cn0KY29uc3QgejMyID0gcmVxdWlyZSgnejMyJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCm1vZHVsZS5leHBvcnRzID0gewogIGVuY29kZSwKICBkZWNvZGUsCiAgbm9ybWFsaXplLAogIGlzVmFsaWQKfQoKZnVuY3Rpb24gZW5jb2RlIChrZXkpIHsKICBpZiAoIWI0YS5pc0J1ZmZlcihrZXkpKSB0aHJvdyBuZXcgRXJyb3IoJ0tleSBtdXN0IGJlIGEgQnVmZmVyJykKICBpZiAoa2V5LmJ5dGVMZW5ndGggIT09IDMyKSB0aHJvdyBuZXcgRXJyb3IoJ0tleSBtdXN0IGJlIDMyLWJ5dGVzIGxvbmcnKQogIHJldHVybiB6MzIuZW5jb2RlKGtleSkKfQoKZnVuY3Rpb24gZGVjb2RlIChpZCkgewogIGlmIChiNGEuaXNCdWZmZXIoaWQpKSB7CiAgICBpZiAoaWQuYnl0ZUxlbmd0aCAhPT0gMzIpIHRocm93IG5ldyBFcnJvcignSUQgbXVzdCBiZSAzMi1ieXRlcyBsb25nJykKICAgIHJldHVybiBpZAogIH0KICBpZiAodHlwZW9mIGlkID09PSAnc3RyaW5nJykgewogICAgaWYgKGlkLnN0YXJ0c1dpdGgoJ3BlYXI6Ly8nKSkgaWQgPSBpZC5zbGljZSg3KS5zcGxpdCgnLycpWzBdCiAgICBpZiAoaWQubGVuZ3RoID09PSA1MikgcmV0dXJuIHozMi5kZWNvZGUoaWQpCiAgICBpZiAoaWQubGVuZ3RoID09PSA2NCkgewogICAgICBjb25zdCBidWYgPSBiNGEuZnJvbShpZCwgJ2hleCcpCiAgICAgIGlmIChidWYuYnl0ZUxlbmd0aCA9PT0gMzIpIHJldHVybiBidWYKICAgIH0KICB9CiAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIEh5cGVyY29yZSBrZXknKQp9CgpmdW5jdGlvbiBub3JtYWxpemUgKGFueSkgewogIHJldHVybiBlbmNvZGUoZGVjb2RlKGFueSkpCn0KCmZ1bmN0aW9uIGlzVmFsaWQgKGFueSkgewogIHRyeSB7CiAgICBkZWNvZGUoYW55KQogICAgcmV0dXJuIHRydWUKICB9IGNhdGNoIHsKICAgIHJldHVybiBmYWxzZQogIH0KfQp7CiAgIm5hbWUiOiAiaHlwZXJjb3JlLWlkLWVuY29kaW5nIiwKICAidmVyc2lvbiI6ICIxLjMuMCIsCiAgImRlc2NyaXB0aW9uIjogIkNvbnZlcnQgSHlwZXJjb3JlIGtleXMgdG8vZnJvbSB6LWJhc2UzMiBvciBoZXgiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjUuMyIsCiAgICAiejMyIjogIl4xLjAuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4xLjEiLAogICAgImh5cGVyY29yZSI6ICJeMTAuMC4wIiwKICAgICJyYW5kb20tYWNjZXNzLW1lbW9yeSI6ICJeNi4wLjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4xLjAiCiAgfSwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJjb3JlLWlkLWVuY29kaW5nLmdpdCIKICB9LAogICJrZXl3b3JkcyI6IFtdLAogICJhdXRob3IiOiAiIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyY29yZS1pZC1lbmNvZGluZy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyY29yZS1pZC1lbmNvZGluZyNyZWFkbWUiCn0KY29uc3QgUm9ja3NEQiA9IHJlcXVpcmUoJ3JvY2tzZGItbmF0aXZlJykKY29uc3QgcnJwID0gcmVxdWlyZSgncmVzb2x2ZS1yZWplY3QtcHJvbWlzZScpCmNvbnN0IFNjb3BlTG9jayA9IHJlcXVpcmUoJ3Njb3BlLWxvY2snKQpjb25zdCBEZXZpY2VGaWxlID0gcmVxdWlyZSgnZGV2aWNlLWZpbGUnKQpjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpCmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKQpjb25zdCBWaWV3ID0gcmVxdWlyZSgnLi9saWIvdmlldy5qcycpCgpjb25zdCBWRVJTSU9OID0gMQpjb25zdCBDT0xVTU5fRkFNSUxZID0gJ2NvcmVzdG9yZScKCmNvbnN0IHsgc3RvcmUsIGNvcmUgfSA9IHJlcXVpcmUoJy4vbGliL2tleXMuanMnKQoKY29uc3QgeyBDb3Jlc3RvcmVSWCwgQ29yZXN0b3JlVFgsIENvcmVUWCwgQ29yZVJYIH0gPSByZXF1aXJlKCcuL2xpYi90eC5qcycpCgpjb25zdCB7CiAgY3JlYXRlQ29yZVN0cmVhbSwKICBjcmVhdGVBbGlhc1N0cmVhbSwKICBjcmVhdGVEaXNjb3ZlcnlLZXlTdHJlYW0sCiAgY3JlYXRlQmxvY2tTdHJlYW0sCiAgY3JlYXRlQml0ZmllbGRTdHJlYW0sCiAgY3JlYXRlVXNlckRhdGFTdHJlYW0sCiAgY3JlYXRlVHJlZU5vZGVTdHJlYW0sCiAgY3JlYXRlTG9jYWxTdHJlYW0KfSA9IHJlcXVpcmUoJy4vbGliL3N0cmVhbXMuanMnKQoKY29uc3QgRU1QVFkgPSBuZXcgVmlldygpCgpjbGFzcyBBdG9tIHsKICBjb25zdHJ1Y3RvcihkYikgewogICAgdGhpcy5kYiA9IGRiCiAgICB0aGlzLnZpZXcgPSBuZXcgVmlldygpCiAgICB0aGlzLmZsdXNoZWRQcm9taXNlID0gbnVsbAogICAgdGhpcy5mbHVzaGluZyA9IGZhbHNlCiAgICB0aGlzLmZsdXNoZXMgPSBbXQogIH0KCiAgb25mbHVzaChmbikgewogICAgdGhpcy5mbHVzaGVzLnB1c2goZm4pCiAgfQoKICBmbHVzaGVkKCkgewogICAgaWYgKCF0aGlzLmZsdXNoaW5nKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKICAgIGlmICh0aGlzLmZsdXNoZWRQcm9taXNlICE9PSBudWxsKSByZXR1cm4gdGhpcy5mbHVzaGVkUHJvbWlzZS5wcm9taXNlCiAgICB0aGlzLmZsdXNoZWRQcm9taXNlID0gcnJwKCkKICAgIHJldHVybiB0aGlzLmZsdXNoZWRQcm9taXNlLnByb21pc2UKICB9CgogIF9yZXNvbHZlKCkgewogICAgY29uc3QgZiA9IHRoaXMuZmx1c2hlZFByb21pc2UKICAgIHRoaXMuZmx1c2hlZFByb21pc2UgPSBudWxsCiAgICBmLnJlc29sdmUoKQogIH0KCiAgYXN5bmMgZmx1c2goKSB7CiAgICBpZiAodGhpcy5mbHVzaGluZykgdGhyb3cgbmV3IEVycm9yKCdBdG9tIGFscmVhZHkgZmx1c2hpbmcnKQogICAgdGhpcy5mbHVzaGluZyA9IHRydWUKCiAgICB0cnkgewogICAgICBhd2FpdCBWaWV3LmZsdXNoKHRoaXMudmlldy5jaGFuZ2VzLCB0aGlzLmRiKQogICAgICB0aGlzLnZpZXcucmVzZXQoKQoKICAgICAgY29uc3QgcHJvbWlzZXMgPSBbXQogICAgICBjb25zdCBsZW4gPSB0aGlzLmZsdXNoZXMubGVuZ3RoIC8vIGluIGNhc2Ugb2YgcmVlbnRyeQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSBwcm9taXNlcy5wdXNoKHRoaXMuZmx1c2hlc1tpXSgpKQoKICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLmZsdXNoaW5nID0gZmFsc2UKICAgICAgaWYgKHRoaXMuZmx1c2hlZFByb21pc2UgIT09IG51bGwpIHRoaXMuX3Jlc29sdmUoKQogICAgfQogIH0KfQoKY2xhc3MgSHlwZXJjb3JlU3RvcmFnZSB7CiAgY29uc3RydWN0b3Ioc3RvcmUsIGRiLCBjb3JlLCB2aWV3LCBhdG9tKSB7CiAgICB0aGlzLnN0b3JlID0gc3RvcmUKICAgIHRoaXMuZGIgPSBkYgogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy52aWV3ID0gdmlldwogICAgdGhpcy5hdG9tID0gYXRvbQoKICAgIHRoaXMudmlldy5yZWFkU3RhcnQoKQogIH0KCiAgZ2V0IHJlYWRPbmx5KCkgewogICAgcmV0dXJuIHRoaXMuc3RvcmUucmVhZE9ubHkKICB9CgogIGdldCBkZXBlbmRlbmNpZXMoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLmRlcGVuZGVuY2llcwogIH0KCiAgZ2V0RGVwZW5kZW5jeUxlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzLmxlbmd0aAogICAgICA/IHRoaXMuY29yZS5kZXBlbmRlbmNpZXNbdGhpcy5jb3JlLmRlcGVuZGVuY2llcy5sZW5ndGggLSAxXS5sZW5ndGgKICAgICAgOiAtMQogIH0KCiAgZ2V0RGVwZW5kZW5jeShsZW5ndGgpIHsKICAgIGZvciAobGV0IGkgPSB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IGRlcCA9IHRoaXMuY29yZS5kZXBlbmRlbmNpZXNbaV0KICAgICAgaWYgKGRlcC5sZW5ndGggPCBsZW5ndGgpIHJldHVybiBkZXAKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgc2V0RGVwZW5kZW5jeUhlYWQoZGVwKSB7CiAgICBjb25zdCBkZXBzID0gdGhpcy5jb3JlLmRlcGVuZGVuY2llcwoKICAgIGZvciAobGV0IGkgPSBkZXBzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IGQgPSBkZXBzW2ldCgogICAgICBpZiAoZC5kYXRhUG9pbnRlciAhPT0gZGVwLmRhdGFQb2ludGVyKSBjb250aW51ZQoKICAgICAgLy8gY2hlY2sgaWYgbm90aGluZyBjaGFuZ2VkCiAgICAgIGlmIChkLmxlbmd0aCA9PT0gZGVwLmxlbmd0aCAmJiBpID09PSBkZXBzLmxlbmd0aCAtIDEpIHJldHVybgoKICAgICAgdGhpcy5jb3JlID0gewogICAgICAgIGNvcmVQb2ludGVyOiB0aGlzLmNvcmUuY29yZVBvaW50ZXIsCiAgICAgICAgZGF0YVBvaW50ZXI6IHRoaXMuY29yZS5kYXRhUG9pbnRlciwKICAgICAgICBkZXBlbmRlbmNpZXM6IGRlcHMuc2xpY2UoMCwgaSArIDEpCiAgICAgIH0KCiAgICAgIHRoaXMuY29yZS5kZXBlbmRlbmNpZXNbaV0gPSB7CiAgICAgICAgZGF0YVBvaW50ZXI6IGRlcC5kYXRhUG9pbnRlciwKICAgICAgICBsZW5ndGg6IGRlcC5sZW5ndGgKICAgICAgfQogICAgfQoKICAgIHRoaXMuY29yZS5kZXBlbmRlbmNpZXMgPSBbCiAgICAgIHsKICAgICAgICBkYXRhUG9pbnRlcjogZGVwLmRhdGFQb2ludGVyLAogICAgICAgIGxlbmd0aDogZGVwLmxlbmd0aAogICAgICB9CiAgICBdCiAgfQoKICAvLyBUT0RPOiB0aGlzIG1pZ2h0IGhhdmUgdG8gYmUgYXN5bmMgaWYgdGhlIGRlcGVuZGVudHMgaGF2ZSBjaGFuZ2VkLCBidXQgcHJvcCBvayBmb3Igbm93CiAgdXBkYXRlRGVwZW5kZW5jeUxlbmd0aChsZW5ndGgsIHRydW5jYXRlZCkgewogICAgY29uc3QgZGVwcyA9IHRoaXMuY29yZS5kZXBlbmRlbmNpZXMKCiAgICBjb25zdCBpID0gdGhpcy5maW5kRGVwZW5kZW5jeUluZGV4KGxlbmd0aCwgdHJ1bmNhdGVkKQogICAgaWYgKGkgPT09IC0xKSB0aHJvdyBuZXcgRXJyb3IoJ0RlcGVuZGVuY3kgbm90IGZvdW5kJykKCiAgICB0aGlzLmNvcmUgPSB7CiAgICAgIGNvcmVQb2ludGVyOiB0aGlzLmNvcmUuY29yZVBvaW50ZXIsCiAgICAgIGRhdGFQb2ludGVyOiB0aGlzLmNvcmUuZGF0YVBvaW50ZXIsCiAgICAgIGRlcGVuZGVuY2llczogZGVwcy5zbGljZSgwLCBpICsgMSkKICAgIH0KCiAgICBpZiAodGhpcy5jb3JlLmRlcGVuZGVuY2llc1tpXS5sZW5ndGggIT09IGxlbmd0aCkgewogICAgICB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzW2ldID0gewogICAgICAgIGRhdGFQb2ludGVyOiBkZXBzW2ldLmRhdGFQb2ludGVyLAogICAgICAgIGxlbmd0aAogICAgICB9CiAgICB9CiAgfQoKICBmaW5kRGVwZW5kZW5jeUluZGV4KGxlbmd0aCwgdHJ1bmNhdGVkKSB7CiAgICBjb25zdCBkZXBzID0gdGhpcy5jb3JlLmRlcGVuZGVuY2llcwoKICAgIGlmICh0cnVuY2F0ZWQpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZXBzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGRlcHNbaV0ubGVuZ3RoID49IGxlbmd0aCkgcmV0dXJuIGkKICAgICAgfQoKICAgICAgcmV0dXJuIC0xCiAgICB9CgogICAgZm9yIChsZXQgaSA9IGRlcHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgaWYgKGRlcHNbaV0ubGVuZ3RoIDw9IGxlbmd0aCkgcmV0dXJuIGkKICAgIH0KCiAgICByZXR1cm4gLTEKICB9CgogIGdldCBzbmFwc2hvdHRlZCgpIHsKICAgIHJldHVybiB0aGlzLmRiLl9zbmFwc2hvdCAhPT0gbnVsbAogIH0KCiAgc25hcHNob3QoKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZVN0b3JhZ2UoCiAgICAgIHRoaXMuc3RvcmUsCiAgICAgIHRoaXMuZGIuc25hcHNob3QoKSwKICAgICAgdGhpcy5jb3JlLAogICAgICB0aGlzLnZpZXcuc25hcHNob3QoKSwKICAgICAgdGhpcy5hdG9tCiAgICApCiAgfQoKICBjb21wYWN0KCkgewogICAgcmV0dXJuIFByb21pc2UuYWxsKFsKICAgICAgdGhpcy5kYi5jb21wYWN0UmFuZ2UoY29yZS5jb3JlKHRoaXMuY29yZS5jb3JlUG9pbnRlciksIGNvcmUuY29yZSh0aGlzLmNvcmUuY29yZVBvaW50ZXIpKSwKICAgICAgdGhpcy5kYi5jb21wYWN0UmFuZ2UoY29yZS5kYXRhKHRoaXMuY29yZS5kYXRhUG9pbnRlciksIGNvcmUuZGF0YSh0aGlzLmNvcmUuZGF0YVBvaW50ZXIpKQogICAgXSkKICB9CgogIGF0b21pemUoYXRvbSkgewogICAgaWYgKHRoaXMuYXRvbSAmJiB0aGlzLmF0b20gIT09IGF0b20pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgYXRvbWl6ZSBhbmQgYXRvbWl6ZWQgc2Vzc2lvbiB3aXRoIGEgbmV3IGF0b20nKQogICAgfQogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVTdG9yYWdlKHRoaXMuc3RvcmUsIHRoaXMuZGIuc2Vzc2lvbigpLCB0aGlzLmNvcmUsIGF0b20udmlldywgYXRvbSkKICB9CgogIGNyZWF0ZUF0b20oKSB7CiAgICByZXR1cm4gdGhpcy5zdG9yZS5jcmVhdGVBdG9tKCkKICB9CgogIGNyZWF0ZUJsb2NrU3RyZWFtKG9wdHMpIHsKICAgIHJldHVybiBjcmVhdGVCbG9ja1N0cmVhbSh0aGlzLmNvcmUsIHRoaXMuZGIsIHRoaXMudmlldywgb3B0cykKICB9CgogIGNyZWF0ZVRyZWVOb2RlU3RyZWFtKG9wdHMpIHsKICAgIHJldHVybiBjcmVhdGVUcmVlTm9kZVN0cmVhbSh0aGlzLmNvcmUsIHRoaXMuZGIsIHRoaXMudmlldywgb3B0cykKICB9CgogIGNyZWF0ZUJpdGZpZWxkU3RyZWFtKG9wdHMpIHsKICAgIHJldHVybiBjcmVhdGVCaXRmaWVsZFN0cmVhbSh0aGlzLmNvcmUsIHRoaXMuZGIsIHRoaXMudmlldywgb3B0cykKICB9CgogIGNyZWF0ZVVzZXJEYXRhU3RyZWFtKG9wdHMpIHsKICAgIHJldHVybiBjcmVhdGVVc2VyRGF0YVN0cmVhbSh0aGlzLmNvcmUsIHRoaXMuZGIsIHRoaXMudmlldywgb3B0cykKICB9CgogIGNyZWF0ZUxvY2FsU3RyZWFtKG9wdHMpIHsKICAgIHJldHVybiBjcmVhdGVMb2NhbFN0cmVhbSh0aGlzLmNvcmUsIHRoaXMuZGIsIHRoaXMudmlldywgb3B0cykKICB9CgogIGFzeW5jIHJlc3VtZVNlc3Npb24obmFtZSkgewogICAgY29uc3QgcnggPSB0aGlzLnJlYWQoKQogICAgY29uc3QgZXhpc3RpbmdTZXNzaW9uc1Byb21pc2UgPSByeC5nZXRTZXNzaW9ucygpCgogICAgcngudHJ5Rmx1c2goKQogICAgY29uc3QgZXhpc3RpbmdTZXNzaW9ucyA9IGF3YWl0IGV4aXN0aW5nU2Vzc2lvbnNQcm9taXNlCgogICAgY29uc3Qgc2Vzc2lvbnMgPSBleGlzdGluZ1Nlc3Npb25zIHx8IFtdCiAgICBjb25zdCBzZXNzaW9uID0gZ2V0QmF0Y2goc2Vzc2lvbnMsIG5hbWUsIGZhbHNlKQoKICAgIGlmIChzZXNzaW9uID09PSBudWxsKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IGNvcmUgPSB7CiAgICAgIGNvcmVQb2ludGVyOiB0aGlzLmNvcmUuY29yZVBvaW50ZXIsCiAgICAgIGRhdGFQb2ludGVyOiBzZXNzaW9uLmRhdGFQb2ludGVyLAogICAgICBkZXBlbmRlbmNpZXM6IFtdCiAgICB9CgogICAgY29uc3QgY29yZVJ4ID0gbmV3IENvcmVSWChjb3JlLCB0aGlzLmRiLCB0aGlzLnZpZXcpCgogICAgY29uc3QgZGVwZW5kZW5jeVByb21pc2UgPSBjb3JlUnguZ2V0RGVwZW5kZW5jeSgpCiAgICBjb3JlUngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IGRlcGVuZGVuY3kgPSBhd2FpdCBkZXBlbmRlbmN5UHJvbWlzZQogICAgaWYgKGRlcGVuZGVuY3kpIGNvcmUuZGVwZW5kZW5jaWVzID0gdGhpcy5fYWRkRGVwZW5kZW5jeShkZXBlbmRlbmN5KQoKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlU3RvcmFnZSgKICAgICAgdGhpcy5zdG9yZSwKICAgICAgdGhpcy5kYi5zZXNzaW9uKCksCiAgICAgIGNvcmUsCiAgICAgIHRoaXMuYXRvbSA/IHRoaXMudmlldyA6IG5ldyBWaWV3KCksCiAgICAgIHRoaXMuYXRvbQogICAgKQogIH0KCiAgYXN5bmMgY3JlYXRlU2Vzc2lvbihuYW1lLCBoZWFkKSB7CiAgICBjb25zdCByeCA9IHRoaXMucmVhZCgpCgogICAgY29uc3QgZXhpc3RpbmdTZXNzaW9uc1Byb21pc2UgPSByeC5nZXRTZXNzaW9ucygpCiAgICBjb25zdCBleGlzdGluZ0hlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IFtleGlzdGluZ1Nlc3Npb25zLCBleGlzdGluZ0hlYWRdID0gYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgICBleGlzdGluZ1Nlc3Npb25zUHJvbWlzZSwKICAgICAgZXhpc3RpbmdIZWFkUHJvbWlzZQogICAgXSkKICAgIGlmIChoZWFkID09PSBudWxsKSBoZWFkID0gZXhpc3RpbmdIZWFkCgogICAgaWYgKGV4aXN0aW5nSGVhZCAhPT0gbnVsbCAmJiBoZWFkLmxlbmd0aCA+IGV4aXN0aW5nSGVhZC5sZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGhlYWQgcGFzc2VkLCBhaGVhZCBvZiBjb3JlJykKICAgIH0KCiAgICBjb25zdCBzZXNzaW9ucyA9IGV4aXN0aW5nU2Vzc2lvbnMgfHwgW10KICAgIGNvbnN0IHNlc3Npb24gPSBnZXRCYXRjaChzZXNzaW9ucywgbmFtZSwgdHJ1ZSkKICAgIGNvbnN0IGZyZXNoID0gc2Vzc2lvbi5kYXRhUG9pbnRlciA9PT0gLTEKCiAgICBpZiAoZnJlc2gpIHsKICAgICAgc2Vzc2lvbi5kYXRhUG9pbnRlciA9IGF3YWl0IHRoaXMuc3RvcmUuX2FsbG9jRGF0YSgpCiAgICB9CgogICAgY29uc3QgdHggPSB0aGlzLndyaXRlKCkKCiAgICB0eC5zZXRTZXNzaW9ucyhzZXNzaW9ucykKCiAgICBjb25zdCBsZW5ndGggPSBoZWFkID09PSBudWxsID8gMCA6IGhlYWQubGVuZ3RoCiAgICBjb25zdCBjb3JlID0gewogICAgICBjb3JlUG9pbnRlcjogdGhpcy5jb3JlLmNvcmVQb2ludGVyLAogICAgICBkYXRhUG9pbnRlcjogc2Vzc2lvbi5kYXRhUG9pbnRlciwKICAgICAgZGVwZW5kZW5jaWVzOiB0aGlzLl9hZGREZXBlbmRlbmN5KHsKICAgICAgICBkYXRhUG9pbnRlcjogdGhpcy5jb3JlLmRhdGFQb2ludGVyLAogICAgICAgIGxlbmd0aAogICAgICB9KQogICAgfQoKICAgIGNvbnN0IGNvcmVUeCA9IG5ldyBDb3JlVFgoY29yZSwgdGhpcy5kYiwgdHgudmlldywgdHguY2hhbmdlcykKCiAgICBpZiAobGVuZ3RoID4gMCkgY29yZVR4LnNldEhlYWQoaGVhZCkKICAgIGNvcmVUeC5zZXREZXBlbmRlbmN5KGNvcmUuZGVwZW5kZW5jaWVzW2NvcmUuZGVwZW5kZW5jaWVzLmxlbmd0aCAtIDFdKQoKICAgIGlmICghZnJlc2gpIHsKICAgICAgLy8gbnVrZSBhbGwgZXhpc3Rpbmcgc3RhdGUuLi4KICAgICAgY29yZVR4LmRlbGV0ZUJsb2NrUmFuZ2UoMCwgLTEpCiAgICAgIGNvcmVUeC5kZWxldGVUcmVlTm9kZVJhbmdlKDAsIC0xKQogICAgICBjb3JlVHguZGVsZXRlQml0ZmllbGRQYWdlUmFuZ2UoMCwgLTEpCiAgICB9CgogICAgYXdhaXQgdHguZmx1c2goKQoKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlU3RvcmFnZSgKICAgICAgdGhpcy5zdG9yZSwKICAgICAgdGhpcy5kYi5zZXNzaW9uKCksCiAgICAgIGNvcmUsCiAgICAgIHRoaXMuYXRvbSA/IHRoaXMudmlldyA6IG5ldyBWaWV3KCksCiAgICAgIHRoaXMuYXRvbQogICAgKQogIH0KCiAgYXN5bmMgY3JlYXRlQXRvbWljU2Vzc2lvbihhdG9tLCBoZWFkKSB7CiAgICBjb25zdCBsZW5ndGggPSBoZWFkID09PSBudWxsID8gMCA6IGhlYWQubGVuZ3RoCiAgICBjb25zdCBjb3JlID0gewogICAgICBjb3JlUG9pbnRlcjogdGhpcy5jb3JlLmNvcmVQb2ludGVyLAogICAgICBkYXRhUG9pbnRlcjogdGhpcy5jb3JlLmRhdGFQb2ludGVyLAogICAgICBkZXBlbmRlbmNpZXM6IHRoaXMuX2FkZERlcGVuZGVuY3kobnVsbCkKICAgIH0KCiAgICBjb25zdCBjb3JlVHggPSBuZXcgQ29yZVRYKGNvcmUsIHRoaXMuZGIsIGF0b20udmlldywgW10pCgogICAgaWYgKGxlbmd0aCA+IDApIGNvcmVUeC5zZXRIZWFkKGhlYWQpCgogICAgYXdhaXQgY29yZVR4LmZsdXNoKCkKCiAgICByZXR1cm4gdGhpcy5hdG9taXplKGF0b20pCiAgfQoKICBfYWRkRGVwZW5kZW5jeShkZXApIHsKICAgIGNvbnN0IGRlcHMgPSBbXQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5jb3JlLmRlcGVuZGVuY2llcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBkID0gdGhpcy5jb3JlLmRlcGVuZGVuY2llc1tpXQoKICAgICAgaWYgKGRlcCAhPT0gbnVsbCAmJiBkLmxlbmd0aCA+IGRlcC5sZW5ndGgpIHsKICAgICAgICBpZiAoZC5kYXRhUG9pbnRlciAhPT0gZGVwLmRhdGFQb2ludGVyKSB7CiAgICAgICAgICBkZXBzLnB1c2goeyBkYXRhUG9pbnRlcjogZC5kYXRhUG9pbnRlciwgbGVuZ3RoOiBkZXAubGVuZ3RoIH0pCiAgICAgICAgfQogICAgICAgIHJldHVybiBkZXBzCiAgICAgIH0KCiAgICAgIGRlcHMucHVzaChkKQogICAgfQoKICAgIGlmICgKICAgICAgZGVwICE9PSBudWxsICYmCiAgICAgIChkZXBzLmxlbmd0aCA9PT0gMCB8fCBkZXBzW2RlcHMubGVuZ3RoIC0gMV0uZGF0YVBvaW50ZXIgIT09IGRlcC5kYXRhUG9pbnRlcikKICAgICkgewogICAgICBkZXBzLnB1c2goZGVwKQogICAgfQogICAgcmV0dXJuIGRlcHMKICB9CgogIHJlYWQoKSB7CiAgICByZXR1cm4gbmV3IENvcmVSWCh0aGlzLmNvcmUsIHRoaXMuZGIsIHRoaXMudmlldykKICB9CgogIHdyaXRlKCkgewogICAgcmV0dXJuIG5ldyBDb3JlVFgodGhpcy5jb3JlLCB0aGlzLmRiLCB0aGlzLmF0b20gPyB0aGlzLnZpZXcgOiBudWxsLCBbXSkKICB9CgogIGNsb3NlKCkgewogICAgaWYgKHRoaXMudmlldyAhPT0gbnVsbCkgewogICAgICB0aGlzLnZpZXcucmVhZFN0b3AoKQogICAgICB0aGlzLnZpZXcgPSBudWxsCiAgICB9CgogICAgcmV0dXJuIHRoaXMuZGIuY2xvc2UoKQogIH0KCiAgc3RhdGljIGFzeW5jIGV4cG9ydChwdHIsIGRiLCB7IGJhdGNoZXMgPSBmYWxzZSB9ID0ge30pIHsKICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVSWChwdHIsIGRiLCBFTVBUWSkKCiAgICBjb25zdCBjb3JlID0gewogICAgICBoZWFkOiBudWxsLAogICAgICBhdXRoOiBudWxsLAogICAgICBzZXNzaW9uczogW10sCiAgICAgIGRhdGE6IG51bGwKICAgIH0KCiAgICBjb25zdCBzZXNzaW9uc1Byb21pc2UgPSByeC5nZXRTZXNzaW9ucygpCiAgICBjb25zdCBoZWFkUHJvbWlzZSA9IHJ4LmdldEhlYWQoKQogICAgY29uc3QgYXV0aFByb21pc2UgPSByeC5nZXRBdXRoKCkKCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgW3Nlc3Npb25zLCBoZWFkLCBhdXRoXSA9IGF3YWl0IFByb21pc2UuYWxsKFtzZXNzaW9uc1Byb21pc2UsIGhlYWRQcm9taXNlLCBhdXRoUHJvbWlzZV0pCgogICAgY29yZS5oZWFkID0gaGVhZAogICAgY29yZS5hdXRoID0geyAuLi5hdXRoLCBrZXlQYWlyOiBudWxsIH0KICAgIGlmIChzZXNzaW9ucykgY29yZS5zZXNzaW9ucyA9IHNlc3Npb25zLm1hcCgocykgPT4gcy5uYW1lKQoKICAgIGNvbnN0IGRhdGEgPSBbXQoKICAgIGRhdGEucHVzaChleHBvcnREYXRhKHB0ciwgZGIpKQoKICAgIGlmIChiYXRjaGVzKSB7CiAgICAgIGZvciAoY29uc3QgeyBkYXRhUG9pbnRlciB9IG9mIHNlc3Npb25zKSB7CiAgICAgICAgZGF0YS5wdXNoKGV4cG9ydERhdGEoeyBkYXRhUG9pbnRlciwgZGVwZW5kZW5jaWVzOiBbXSB9LCBkYikpCiAgICAgIH0KICAgIH0KCiAgICBjb3JlLmRhdGEgPSBhd2FpdCBQcm9taXNlLmFsbChkYXRhKQoKICAgIHJldHVybiBjb3JlCiAgfQp9CgpjbGFzcyBDb3Jlc3RvcmVTdG9yYWdlIHsKICBjb25zdHJ1Y3RvcihkYiwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCBzdG9yYWdlID0gdHlwZW9mIGRiID09PSAnc3RyaW5nJyA/IGRiIDogbnVsbAoKICAgIHRoaXMuYm9vdHN0cmFwID0gc3RvcmFnZSAhPT0gbnVsbAogICAgdGhpcy5wYXRoID0gc3RvcmFnZSAhPT0gbnVsbCA/IHN0b3JhZ2UgOiBwYXRoLmpvaW4oZGIucGF0aCwgJy4uJykKICAgIHRoaXMucmVhZE9ubHkgPSAhIW9wdHMucmVhZE9ubHkKICAgIHRoaXMuYWxsb3dCYWNrdXAgPSAhIW9wdHMuYWxsb3dCYWNrdXAKICAgIHRoaXMuZGV2aWNlRmlsZSA9IG51bGwKICAgIHRoaXMud2FpdCA9ICEhb3B0cy53YWl0CgogICAgLy8gdG1wIHN5bmMgZml4IGZvciBzaW1wbGljdHkgc2luY2Ugbm90IHN1cGVyIGRlcGxveWVkIHlldAogICAgaWYgKHRoaXMuYm9vdHN0cmFwICYmICF0aGlzLnJlYWRPbmx5KSB0bXBGaXhTdG9yYWdlKHRoaXMucGF0aCkKCiAgICB0aGlzLmlkID0gb3B0cy5pZCB8fCBudWxsCiAgICB0aGlzLnZpZXcgPSBudWxsCiAgICB0aGlzLmVudGVycyA9IDAKICAgIHRoaXMubG9jayA9IG5ldyBTY29wZUxvY2soKQogICAgdGhpcy5mbHVzaGluZyA9IG51bGwKICAgIHRoaXMudmVyc2lvbiA9IDAKICAgIHRoaXMubWlncmF0aW5nID0gbnVsbAoKICAgIGlmICgodGhpcy5ib290c3RyYXAgJiYgIXRoaXMucmVhZE9ubHkgJiYgIXRoaXMuYWxsb3dCYWNrdXApIHx8IHRoaXMud2FpdCkgewogICAgICBjb25zdCBjb3Jlc3RvcmVGaWxlID0gcGF0aC5qb2luKHRoaXMucGF0aCwgJ0NPUkVTVE9SRScpCgogICAgICB0aGlzLmRldmljZUZpbGUgPSBuZXcgRGV2aWNlRmlsZShjb3Jlc3RvcmVGaWxlLCB7CiAgICAgICAgbG9jazogdHJ1ZSwKICAgICAgICB3YWl0OiB0aGlzLndhaXQsCiAgICAgICAgZGF0YTogeyBpZDogdGhpcy5pZCB9CiAgICAgIH0pCiAgICB9CgogICAgY29uc3QgZGJQYXRoID0gcGF0aC5qb2luKHRoaXMucGF0aCwgJ2RiJykKCiAgICB0aGlzLnJvY2tzID0gc3RvcmFnZSA9PT0gbnVsbCA/IGRiIDogbmV3IFJvY2tzREIoZGJQYXRoLCB7IC4uLm9wdHMsIGxvY2s6IHRoaXMuZGV2aWNlRmlsZSB9KQogICAgdGhpcy5kYiA9IGNyZWF0ZUNvbHVtbkZhbWlseSh0aGlzLnJvY2tzLCBvcHRzKQogIH0KCiAgZ2V0IG9wZW5lZCgpIHsKICAgIHJldHVybiB0aGlzLmRiLm9wZW5lZAogIH0KCiAgZ2V0IGNsb3NlZCgpIHsKICAgIHJldHVybiB0aGlzLmRiLmNsb3NlZAogIH0KCiAgYXN5bmMgcmVhZHkoKSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSBhd2FpdCB0aGlzLl9taWdyYXRlU3RvcmUoKQogICAgcmV0dXJuIHRoaXMuZGIucmVhZHkoKQogIH0KCiAgY29tcGFjdCgpIHsKICAgIHJldHVybiB0aGlzLmRiLmNvbXBhY3RSYW5nZSgpCiAgfQoKICBhc3luYyBhdWRpdCgpIHsKICAgIGZvciBhd2FpdCAoY29uc3QgeyBjb3JlIH0gb2YgdGhpcy5jcmVhdGVDb3JlU3RyZWFtKCkpIHsKICAgICAgY29uc3QgY29yZVJ4ID0gbmV3IENvcmVSWChjb3JlLCB0aGlzLmRiLCBFTVBUWSkKICAgICAgY29uc3QgYXV0aFByb21pc2UgPSBjb3JlUnguZ2V0QXV0aCgpCgogICAgICBjb3JlUngudHJ5Rmx1c2goKQoKICAgICAgY29uc3QgYXV0aCA9IGF3YWl0IGF1dGhQcm9taXNlCgogICAgICBpZiAoIWF1dGgubWFuaWZlc3QgfHwgYXV0aC5tYW5pZmVzdC52ZXJzaW9uID4gMCkgY29udGludWUKICAgICAgaWYgKGF1dGgubWFuaWZlc3QubGlua2VkID09PSBudWxsKSBjb250aW51ZQoKICAgICAgYXV0aC5tYW5pZmVzdC5saW5rZWQgPSBudWxsCiAgICAgIGNvbnN0IGNvcmVUeCA9IG5ldyBDb3JlVFgoY29yZSwgdGhpcy5kYiwgbnVsbCwgW10pCiAgICAgIGNvcmVUeC5zZXRBdXRoKGF1dGgpCiAgICAgIGF3YWl0IGNvcmVUeC5mbHVzaCgpCiAgICB9CiAgfQoKICBhc3luYyBkZWxldGVDb3JlKHB0cikgewogICAgY29uc3QgcnggPSBuZXcgQ29yZVJYKHB0ciwgdGhpcy5kYiwgRU1QVFkpCgogICAgY29uc3QgYXV0aFByb21pc2UgPSByeC5nZXRBdXRoKCkKICAgIGNvbnN0IHNlc3Npb25zUHJvbWlzZSA9IHJ4LmdldFNlc3Npb25zKCkKCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgYXV0aCA9IGF3YWl0IGF1dGhQcm9taXNlCiAgICBjb25zdCBzZXNzaW9ucyA9IGF3YWl0IHNlc3Npb25zUHJvbWlzZQoKICAgIC8vIG5vIGNvcmUgc3RvcmVkIGhlcmUKICAgIGlmICghYXV0aCkgcmV0dXJuCgogICAgY29uc3QgdHggPSB0aGlzLmRiLndyaXRlKHsgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKCiAgICB0eC50cnlEZWxldGUoc3RvcmUuY29yZShhdXRoLmRpc2NvdmVyeUtleSkpCgogICAgLy8gY2xlYXIgY29yZQogICAgY29uc3Qgc3RhcnQgPSBjb3JlLmNvcmUocHRyLmNvcmVQb2ludGVyKQogICAgY29uc3QgZW5kID0gY29yZS5jb3JlKHB0ci5jb3JlUG9pbnRlciArIDEpCiAgICB0eC50cnlEZWxldGVSYW5nZShzdGFydCwgZW5kKQoKICAgIGlmIChzZXNzaW9ucykgewogICAgICBmb3IgKGNvbnN0IHsgZGF0YVBvaW50ZXIgfSBvZiBzZXNzaW9ucykgewogICAgICAgIGNvbnN0IHN0YXJ0ID0gY29yZS5kYXRhKGRhdGFQb2ludGVyKQogICAgICAgIGNvbnN0IGVuZCA9IGNvcmUuZGF0YShkYXRhUG9pbnRlciArIDEpCiAgICAgICAgdHgudHJ5RGVsZXRlUmFuZ2Uoc3RhcnQsIGVuZCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0eC5mbHVzaCgpCiAgfQoKICBzdGF0aWMgaXNDb3JlU3RvcmFnZShkYikgewogICAgcmV0dXJuIGlzQ29yZXN0b3JlU3RvcmFnZShkYikKICB9CgogIHN0YXRpYyBmcm9tKGRiKSB7CiAgICBpZiAoaXNDb3Jlc3RvcmVTdG9yYWdlKGRiKSkgcmV0dXJuIGRiCiAgICByZXR1cm4gbmV3IHRoaXMoZGIpCiAgfQoKICBhc3luYyBfZmx1c2goKSB7CiAgICB3aGlsZSAodGhpcy5lbnRlcnMgPiAwKSB7CiAgICAgIGF3YWl0IHRoaXMubG9jay5sb2NrKCkKICAgICAgYXdhaXQgdGhpcy5sb2NrLnVubG9jaygpCiAgICB9CiAgfQoKICAvLyBydW5zIHByZSBhbnkgb3RoZXIgbXV0YXRpb24gYW5kIHJlYWQKICBhc3luYyBfbWlncmF0ZVN0b3JlKCkgewogICAgY29uc3QgdmlldyA9IGF3YWl0IHRoaXMuX2VudGVyKCkKCiAgICB0cnkgewogICAgICBpZiAodGhpcy52ZXJzaW9uID09PSBWRVJTSU9OKSByZXR1cm4KCiAgICAgIGF3YWl0IHRoaXMuX3ByZW9wZW4KICAgICAgYXdhaXQgdGhpcy5kYi5yZWFkeSgpCgogICAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCB2aWV3KQogICAgICBjb25zdCBoZWFkUHJvbWlzZSA9IHJ4LmdldEhlYWQoKQoKICAgICAgcngudHJ5Rmx1c2goKQogICAgICBjb25zdCBoZWFkID0gYXdhaXQgaGVhZFByb21pc2UKCiAgICAgIGNvbnN0IHZlcnNpb24gPSBoZWFkID09PSBudWxsID8gMCA6IGhlYWQudmVyc2lvbgogICAgICBpZiAodmVyc2lvbiA9PT0gVkVSU0lPTikgewogICAgICAgIHRoaXMudmVyc2lvbiA9IFZFUlNJT04KICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgY29uc3QgdGFyZ2V0ID0geyB2ZXJzaW9uOiBWRVJTSU9OLCBkcnlSdW46IGZhbHNlIH0KCiAgICAgIHN3aXRjaCAodmVyc2lvbikgewogICAgICAgIGNhc2UgMDogewogICAgICAgICAgYXdhaXQgcmVxdWlyZSgnLi9taWdyYXRpb25zLzAnKS5zdG9yZSh0aGlzLCB0YXJnZXQpCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICdVbnN1cHBvcnRlZCB2ZXJzaW9uOiAnICsgdmVyc2lvbiArICcgLSB5b3Ugc2hvdWxkIHByb2JhYmx5IHVwZ3JhZGUgeW91ciBkZXBlbmRlbmNpZXMnCiAgICAgICAgICApCiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLnZlcnNpb24gPSBWRVJTSU9OCiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCB0aGlzLl9leGl0KCkKICAgIH0KICB9CgogIC8vIHJ1bnMgcHJlIHRoZSBjb3JlIGlzIHJldHVybmVkIHRvIHRoZSB1c2VyCiAgYXN5bmMgX21pZ3JhdGVDb3JlKGNvcmUsIGRpc2NvdmVyeUtleSwgdmVyc2lvbiwgbG9ja2VkKSB7CiAgICBjb25zdCB2aWV3ID0gbG9ja2VkID8gdGhpcy52aWV3IDogYXdhaXQgdGhpcy5fZW50ZXIoKQogICAgdHJ5IHsKICAgICAgaWYgKHZlcnNpb24gPT09IFZFUlNJT04pIHJldHVybgoKICAgICAgY29uc3QgdGFyZ2V0ID0geyB2ZXJzaW9uOiBWRVJTSU9OLCBkcnlSdW46IGZhbHNlIH0KCiAgICAgIHN3aXRjaCAodmVyc2lvbikgewogICAgICAgIGNhc2UgMDogewogICAgICAgICAgYXdhaXQgcmVxdWlyZSgnLi9taWdyYXRpb25zLzAnKS5jb3JlKGNvcmUsIHRhcmdldCkKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgJ1Vuc3VwcG9ydGVkIHZlcnNpb246ICcgKyB2ZXJzaW9uICsgJyAtIHlvdSBzaG91bGQgcHJvYmFibHkgdXBncmFkZSB5b3VyIGRlcGVuZGVuY2llcycKICAgICAgICAgICkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChsb2NrZWQgPT09IGZhbHNlKSByZXR1cm4KCiAgICAgIC8vIGlmIGl0cyBsb2NrZWQsIHRoZW4gbW92ZSB0aGUgY29yZSBzdGF0ZSBpbnRvIHRoZSBtZW12aWV3CiAgICAgIC8vIGluIGNhc2UgdGhlIGNvcmUgaXMgcmVvcGVuZWQgZnJvbSB0aGUgbWVtdmlldywgcHJlIGZsdXNoCgogICAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCBFTVBUWSkKICAgICAgY29uc3QgdHggPSBuZXcgQ29yZXN0b3JlVFgodmlldykKCiAgICAgIGNvbnN0IGNvcmVQcm9taXNlID0gcnguZ2V0Q29yZShkaXNjb3ZlcnlLZXkpCiAgICAgIHJ4LnRyeUZsdXNoKCkKCiAgICAgIHR4LnB1dENvcmUoZGlzY292ZXJ5S2V5LCBhd2FpdCBjb3JlUHJvbWlzZSkKICAgICAgdHguYXBwbHkoKQogICAgfSBmaW5hbGx5IHsKICAgICAgaWYgKCFsb2NrZWQpIGF3YWl0IHRoaXMuX2V4aXQoKQogICAgfQogIH0KCiAgYXN5bmMgX2VudGVyKCkgewogICAgdGhpcy5lbnRlcnMrKwogICAgYXdhaXQgdGhpcy5sb2NrLmxvY2soKQogICAgaWYgKHRoaXMudmlldyA9PT0gbnVsbCkgdGhpcy52aWV3ID0gbmV3IFZpZXcoKQogICAgcmV0dXJuIHRoaXMudmlldwogIH0KCiAgYXN5bmMgX2V4aXQoKSB7CiAgICB0aGlzLmVudGVycy0tCgogICAgaWYgKHRoaXMuZmx1c2hpbmcgPT09IG51bGwpIHRoaXMuZmx1c2hpbmcgPSBycnAoKQogICAgY29uc3QgZmx1c2hlZCA9IHRoaXMuZmx1c2hpbmcucHJvbWlzZQoKICAgIGlmICh0aGlzLmVudGVycyA9PT0gMCB8fCB0aGlzLnZpZXcuc2l6ZSgpID4gMTI4KSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgVmlldy5mbHVzaCh0aGlzLnZpZXcuY2hhbmdlcywgdGhpcy5kYikKICAgICAgICB0aGlzLmZsdXNoaW5nLnJlc29sdmUoKQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICB0aGlzLmZsdXNoaW5nLnJlamVjdChlcnIpCiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgdGhpcy5mbHVzaGluZyA9IG51bGwKICAgICAgICB0aGlzLnZpZXcgPSBudWxsCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmxvY2sudW5sb2NrKCkKICAgIHJldHVybiBmbHVzaGVkCiAgfQoKICAvLyB3aGVuIHVzZWQgd2l0aCBjb3JlIGNhdGNoZXMgdGhpcyBpc250IHRyYW5zYWN0aW9uYWwgZm9yIHNpbXBsaWNpdHksIEhPV0VWRVIsIGl0cyBqdXN0IGEgbnVtYmVyCiAgLy8gc28gd29ydGggdGhlIHRyYWRlb2ZmCiAgYXN5bmMgX2FsbG9jRGF0YSgpIHsKICAgIGxldCBkYXRhUG9pbnRlciA9IDAKCiAgICBjb25zdCB2aWV3ID0gYXdhaXQgdGhpcy5fZW50ZXIoKQogICAgY29uc3QgdHggPSBuZXcgQ29yZXN0b3JlVFgodmlldykKCiAgICB0cnkgewogICAgICBjb25zdCBoZWFkID0gYXdhaXQgdGhpcy5fZ2V0SGVhZCh2aWV3KQoKICAgICAgZGF0YVBvaW50ZXIgPSBoZWFkLmFsbG9jYXRlZC5kYXRhcysrCgogICAgICB0eC5zZXRIZWFkKGhlYWQpCiAgICAgIHR4LmFwcGx5KCkKICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IHRoaXMuX2V4aXQoKQogICAgfQoKICAgIHJldHVybiBkYXRhUG9pbnRlcgogIH0KCiAgLy8gZXhwb3NlcyBoZXJlIHNvIG1pZ3JhdGlvbnMgY2FuIGVhc2lseSBhY2Nlc3MgdGhlIGhlYWQgaW4gYW4gaW5pdCBzdGF0ZQogIGFzeW5jIF9nZXRIZWFkKHZpZXcpIHsKICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIHZpZXcpCiAgICBjb25zdCBoZWFkUHJvbWlzZSA9IHJ4LmdldEhlYWQoKQogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IGhlYWQgPSBhd2FpdCBoZWFkUHJvbWlzZQogICAgcmV0dXJuIGhlYWQgPT09IG51bGwgPyBpbml0U3RvcmVIZWFkKCkgOiBoZWFkCiAgfQoKICBjcmVhdGVBdG9tKCkgewogICAgcmV0dXJuIG5ldyBBdG9tKHRoaXMuZGIpCiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGF3YWl0IHRoaXMucm9ja3MuZmx1c2goKQogIH0KCiAgYXN5bmMgY2xvc2UoKSB7CiAgICBpZiAodGhpcy5kYi5jbG9zZWQpIHJldHVybgogICAgYXdhaXQgdGhpcy5fZmx1c2goKQogICAgYXdhaXQgdGhpcy5kYi5jbG9zZSgpCiAgICBhd2FpdCB0aGlzLnJvY2tzLmNsb3NlKCkKICAgIGlmICh0aGlzLmRldmljZUZpbGUpIGF3YWl0IHRoaXMuZGV2aWNlRmlsZS5jbG9zZSgpCiAgfQoKICBhc3luYyBjbGVhcigpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgY29uc3QgdmlldyA9IGF3YWl0IHRoaXMuX2VudGVyKCkKICAgIGNvbnN0IHR4ID0gbmV3IENvcmVzdG9yZVRYKHZpZXcpCgogICAgdHguY2xlYXIoKQogICAgdHguYXBwbHkoKQoKICAgIGF3YWl0IHRoaXMuX2V4aXQoKQogIH0KCiAgY3JlYXRlQ29yZVN0cmVhbSgpIHsKICAgIC8vIFRPRE86IGJlIG5pY2UgdG8gcnVuIHRoZSBtZ2lyYXRpb24gaGVyZSBhbHNvLCBidXQgdG9vIG11Y2ggcGx1bWJpbmcgYXRtCiAgICByZXR1cm4gY3JlYXRlQ29yZVN0cmVhbSh0aGlzLmRiLCBFTVBUWSkKICB9CgogIGNyZWF0ZUFsaWFzU3RyZWFtKG5hbWVzcGFjZSkgewogICAgLy8gVE9ETzogYmUgbmljZSB0byBydW4gdGhlIG1naXJhdGlvbiBoZXJlIGFsc28sIGJ1dCB0b28gbXVjaCBwbHVtYmluZyBhdG0KICAgIHJldHVybiBjcmVhdGVBbGlhc1N0cmVhbSh0aGlzLmRiLCBFTVBUWSwgbmFtZXNwYWNlKQogIH0KCiAgY3JlYXRlRGlzY292ZXJ5S2V5U3RyZWFtKG5hbWVzcGFjZSkgewogICAgcmV0dXJuIGNyZWF0ZURpc2NvdmVyeUtleVN0cmVhbSh0aGlzLmRiLCBFTVBUWSwgbmFtZXNwYWNlKQogIH0KCiAgYXN5bmMgZ2V0QWxpYXMoYWxpYXMpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgRU1QVFkpCiAgICBjb25zdCBkaXNjb3ZlcnlLZXlQcm9taXNlID0gcnguZ2V0Q29yZUJ5QWxpYXMoYWxpYXMpCiAgICByeC50cnlGbHVzaCgpCiAgICByZXR1cm4gZGlzY292ZXJ5S2V5UHJvbWlzZQogIH0KCiAgYXN5bmMgZ2V0U2VlZCgpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgRU1QVFkpCiAgICBjb25zdCBoZWFkUHJvbWlzZSA9IHJ4LmdldEhlYWQoKQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBoZWFkID0gYXdhaXQgaGVhZFByb21pc2UKICAgIHJldHVybiBoZWFkID09PSBudWxsID8gbnVsbCA6IGhlYWQuc2VlZAogIH0KCiAgYXN5bmMgc2V0U2VlZChzZWVkLCB7IG92ZXJ3cml0ZSA9IHRydWUgfSA9IHt9KSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSBhd2FpdCB0aGlzLl9taWdyYXRlU3RvcmUoKQoKICAgIGNvbnN0IHZpZXcgPSBhd2FpdCB0aGlzLl9lbnRlcigpCiAgICBjb25zdCB0eCA9IG5ldyBDb3Jlc3RvcmVUWCh2aWV3KQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIHZpZXcpCiAgICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCgogICAgICByeC50cnlGbHVzaCgpCgogICAgICBjb25zdCBoZWFkID0gKGF3YWl0IGhlYWRQcm9taXNlKSB8fCBpbml0U3RvcmVIZWFkKCkKCiAgICAgIGlmIChoZWFkLnNlZWQgPT09IG51bGwgfHwgb3ZlcndyaXRlKSBoZWFkLnNlZWQgPSBzZWVkCiAgICAgIHR4LnNldEhlYWQoaGVhZCkKICAgICAgdHguYXBwbHkoKQoKICAgICAgcmV0dXJuIGhlYWQuc2VlZAogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgdGhpcy5fZXhpdCgpCiAgICB9CiAgfQoKICBhc3luYyBnZXREZWZhdWx0RGlzY292ZXJ5S2V5KCkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCBFTVBUWSkKICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IGhlYWQgPSBhd2FpdCBoZWFkUHJvbWlzZQogICAgcmV0dXJuIGhlYWQgPT09IG51bGwgPyBudWxsIDogaGVhZC5kZWZhdWx0RGlzY292ZXJ5S2V5CiAgfQoKICBhc3luYyBzZXREZWZhdWx0RGlzY292ZXJ5S2V5KGRpc2NvdmVyeUtleSwgeyBvdmVyd3JpdGUgPSB0cnVlIH0gPSB7fSkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBjb25zdCB2aWV3ID0gYXdhaXQgdGhpcy5fZW50ZXIoKQogICAgY29uc3QgdHggPSBuZXcgQ29yZXN0b3JlVFgodmlldykKCiAgICB0cnkgewogICAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCB2aWV3KQogICAgICBjb25zdCBoZWFkUHJvbWlzZSA9IHJ4LmdldEhlYWQoKQoKICAgICAgcngudHJ5Rmx1c2goKQoKICAgICAgY29uc3QgaGVhZCA9IChhd2FpdCBoZWFkUHJvbWlzZSkgfHwgaW5pdFN0b3JlSGVhZCgpCgogICAgICBpZiAoaGVhZC5kZWZhdWx0RGlzY292ZXJ5S2V5ID09PSBudWxsIHx8IG92ZXJ3cml0ZSkgaGVhZC5kZWZhdWx0RGlzY292ZXJ5S2V5ID0gZGlzY292ZXJ5S2V5CiAgICAgIHR4LnNldEhlYWQoaGVhZCkKICAgICAgdHguYXBwbHkoKQoKICAgICAgcmV0dXJuIGhlYWQuZGVmYXVsdERpc2NvdmVyeUtleQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgdGhpcy5fZXhpdCgpCiAgICB9CiAgfQoKICBhc3luYyBoYXNDb3JlKGRpc2NvdmVyeUtleSwgeyBpZk1pZ3JhdGVkID0gZmFsc2UgfSA9IHt9KSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSBhd2FpdCB0aGlzLl9taWdyYXRlU3RvcmUoKQoKICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIEVNUFRZKQogICAgY29uc3QgcHJvbWlzZSA9IHJ4LmdldENvcmUoZGlzY292ZXJ5S2V5KQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBjb3JlID0gYXdhaXQgcHJvbWlzZQoKICAgIGlmIChjb3JlID09PSBudWxsKSByZXR1cm4gZmFsc2UKICAgIGlmIChjb3JlLnZlcnNpb24gIT09IFZFUlNJT04gJiYgaWZNaWdyYXRlZCkgcmV0dXJuIGZhbHNlCgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIGdldEF1dGgoZGlzY292ZXJ5S2V5KSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSBhd2FpdCB0aGlzLl9taWdyYXRlU3RvcmUoKQoKICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIEVNUFRZKQogICAgY29uc3QgY29yZVByb21pc2UgPSByeC5nZXRDb3JlKGRpc2NvdmVyeUtleSkKCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgY29yZSA9IGF3YWl0IGNvcmVQcm9taXNlCiAgICBpZiAoY29yZSA9PT0gbnVsbCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCByZWFkID0gdGhpcy5kYi5yZWFkKHsgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKICAgIGNvbnN0IGF1dGhQcm9taXNlID0gQ29yZVJYLmdldEF1dGgocmVhZCwgY29yZSkKCiAgICByZWFkLnRyeUZsdXNoKCkKCiAgICByZXR1cm4gYXV0aFByb21pc2UKICB9CgogIGFzeW5jIGdldEluZm8oZGlzY292ZXJ5S2V5LCBvcHRzKSB7CiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0SW5mb3MoW2Rpc2NvdmVyeUtleV0sIG9wdHMpKVswXQogIH0KCiAgYXN5bmMgZ2V0SW5mb3MoZGlzY292ZXJ5S2V5cywgeyBhdXRoID0gdHJ1ZSwgaGVhZCA9IHRydWUsIGhpbnRzID0gdHJ1ZSB9ID0ge30pIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgRU1QVFkpCiAgICBjb25zdCBjb3JlUHJvbWlzZXMgPSBuZXcgQXJyYXkoZGlzY292ZXJ5S2V5cy5sZW5ndGgpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkaXNjb3ZlcnlLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvcmVQcm9taXNlc1tpXSA9IHJ4LmdldENvcmUoZGlzY292ZXJ5S2V5c1tpXSkKICAgIH0KCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgY29yZXMgPSBhd2FpdCBQcm9taXNlLmFsbChjb3JlUHJvbWlzZXMpCiAgICBjb25zdCByZWFkID0gdGhpcy5kYi5yZWFkKHsgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKCiAgICBjb25zdCByZXN1bHRQcm9taXNlcyA9IG5ldyBBcnJheShjb3Jlcy5sZW5ndGgpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3Jlcy5sZW5ndGg7IGkrKykgewogICAgICByZXN1bHRQcm9taXNlc1tpXSA9IGNvcmVzW2ldCiAgICAgICAgPyBnZXRJbmZvRnJvbUJhdGNoKHJlYWQsIGNvcmVzW2ldLCBkaXNjb3ZlcnlLZXlzW2ldLCBhdXRoLCBoZWFkLCBoaW50cykKICAgICAgICA6IG51bGwKICAgIH0KCiAgICByZWFkLnRyeUZsdXNoKCkKCiAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVzdWx0UHJvbWlzZXMpCiAgfQoKICBhc3luYyBzdXNwZW5kKCkgewogICAgYXdhaXQgdGhpcy5kYi5zdXNwZW5kKCkKICAgIGlmICh0aGlzLmRldmljZUZpbGUpIGF3YWl0IHRoaXMuZGV2aWNlRmlsZS5zdXNwZW5kKCkKICB9CgogIGFzeW5jIHJlc3VtZSgpIHsKICAgIGlmICh0aGlzLmRldmljZUZpbGUpIGF3YWl0IHRoaXMuZGV2aWNlRmlsZS5yZXN1bWUoKQogICAgYXdhaXQgdGhpcy5kYi5yZXN1bWUoKQogIH0KCiAgYXN5bmMgcmVzdW1lQ29yZShkaXNjb3ZlcnlLZXkpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgaWYgKCFkaXNjb3ZlcnlLZXkpIHsKICAgICAgZGlzY292ZXJ5S2V5ID0gYXdhaXQgdGhpcy5nZXREZWZhdWx0RGlzY292ZXJ5S2V5KCkKICAgICAgaWYgKCFkaXNjb3ZlcnlLZXkpIHJldHVybiBudWxsCiAgICB9CgogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgRU1QVFkpCiAgICBjb25zdCBjb3JlUHJvbWlzZSA9IHJ4LmdldENvcmUoZGlzY292ZXJ5S2V5KQoKICAgIHJ4LnRyeUZsdXNoKCkKICAgIGNvbnN0IGNvcmUgPSBhd2FpdCBjb3JlUHJvbWlzZQoKICAgIGlmIChjb3JlID09PSBudWxsKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHRoaXMuX3Jlc3VtZUZyb21Qb2ludGVycyhFTVBUWSwgZGlzY292ZXJ5S2V5LCBmYWxzZSwgY29yZSkKICB9CgogIGFzeW5jIGV4cG9ydChkaXNjb3ZlcnlLZXksIG9wdHMpIHsKICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIEVNUFRZKQogICAgY29uc3QgY29yZVByb21pc2UgPSByeC5nZXRDb3JlKGRpc2NvdmVyeUtleSkKCiAgICByeC50cnlGbHVzaCgpCiAgICBjb25zdCBjb3JlID0gYXdhaXQgY29yZVByb21pc2UKICAgIGlmIChjb3JlID09PSBudWxsKSByZXR1cm4gbnVsbAoKICAgIGxldCB7IGRhdGFQb2ludGVyLCBjb3JlUG9pbnRlciB9ID0gY29yZQoKICAgIGNvbnN0IHB0ciA9IHsgY29yZVBvaW50ZXIsIGRhdGFQb2ludGVyLCBkZXBlbmRlbmNpZXM6IFtdIH0KCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBjb25zdCByeCA9IG5ldyBDb3JlUlgoeyBkYXRhUG9pbnRlciwgY29yZVBvaW50ZXI6IDAsIGRlcGVuZGVuY2llczogW10gfSwgdGhpcy5kYiwgRU1QVFkpCiAgICAgIGNvbnN0IGRlcGVuZGVuY3lQcm9taXNlID0gcnguZ2V0RGVwZW5kZW5jeSgpCiAgICAgIHJ4LnRyeUZsdXNoKCkKICAgICAgY29uc3QgZGVwZW5kZW5jeSA9IGF3YWl0IGRlcGVuZGVuY3lQcm9taXNlCiAgICAgIGlmICghZGVwZW5kZW5jeSkgYnJlYWsKICAgICAgcHRyLmRlcGVuZGVuY2llcy5wdXNoKGRlcGVuZGVuY3kpCiAgICAgIGRhdGFQb2ludGVyID0gZGVwZW5kZW5jeS5kYXRhUG9pbnRlcgogICAgfQoKICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLmRiLnNlc3Npb24oKQogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IEh5cGVyY29yZVN0b3JhZ2UuZXhwb3J0KHB0ciwgc2Vzc2lvbiwgb3B0cykKICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IHNlc3Npb24uY2xvc2UoKQogICAgfQogIH0KCiAgYXN5bmMgX3Jlc3VtZUZyb21Qb2ludGVycyh2aWV3LCBkaXNjb3ZlcnlLZXksIGNyZWF0ZSwgeyB2ZXJzaW9uLCBjb3JlUG9pbnRlciwgZGF0YVBvaW50ZXIgfSkgewogICAgY29uc3QgY29yZSA9IHsgY29yZVBvaW50ZXIsIGRhdGFQb2ludGVyLCBkZXBlbmRlbmNpZXM6IFtdIH0KCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBjb25zdCByeCA9IG5ldyBDb3JlUlgoeyBkYXRhUG9pbnRlciwgY29yZVBvaW50ZXI6IDAsIGRlcGVuZGVuY2llczogW10gfSwgdGhpcy5kYiwgdmlldykKICAgICAgY29uc3QgZGVwZW5kZW5jeVByb21pc2UgPSByeC5nZXREZXBlbmRlbmN5KCkKICAgICAgcngudHJ5Rmx1c2goKQogICAgICBjb25zdCBkZXBlbmRlbmN5ID0gYXdhaXQgZGVwZW5kZW5jeVByb21pc2UKICAgICAgaWYgKCFkZXBlbmRlbmN5KSBicmVhawogICAgICBjb3JlLmRlcGVuZGVuY2llcy5wdXNoKGRlcGVuZGVuY3kpCiAgICAgIGRhdGFQb2ludGVyID0gZGVwZW5kZW5jeS5kYXRhUG9pbnRlcgogICAgfQoKICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBIeXBlcmNvcmVTdG9yYWdlKHRoaXMsIHRoaXMuZGIuc2Vzc2lvbigpLCBjb3JlLCBFTVBUWSwgbnVsbCkKCiAgICBpZiAodmVyc2lvbiA8IFZFUlNJT04pIGF3YWl0IHRoaXMuX21pZ3JhdGVDb3JlKHJlc3VsdCwgZGlzY292ZXJ5S2V5LCB2ZXJzaW9uLCBjcmVhdGUpCiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICAvLyBub3QgYWxsb3dlZCB0byB0aHJvdyB2YWxpZGF0aW9uIGVycm9ycyBhcyBpdHMgYSBzaGFyZWQgdHghCiAgYXN5bmMgX2NyZWF0ZSgKICAgIHZpZXcsCiAgICB7IGtleSwgbWFuaWZlc3QsIGtleVBhaXIsIGVuY3J5cHRpb25LZXksIGRpc2NvdmVyeUtleSwgYWxpYXMsIHVzZXJEYXRhLCBjb3JlOiBwdHJzIH0KICApIHsKICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIHZpZXcpCiAgICBjb25zdCB0eCA9IG5ldyBDb3Jlc3RvcmVUWCh2aWV3KQoKICAgIGNvbnN0IGNvcmVQcm9taXNlID0gcnguZ2V0Q29yZShkaXNjb3ZlcnlLZXkpCiAgICBjb25zdCBoZWFkUHJvbWlzZSA9IHJ4LmdldEhlYWQoKQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBsZXQgW2NvcmUsIGhlYWRdID0gYXdhaXQgUHJvbWlzZS5hbGwoW2NvcmVQcm9taXNlLCBoZWFkUHJvbWlzZV0pCiAgICBpZiAoY29yZSkgcmV0dXJuIHRoaXMuX3Jlc3VtZUZyb21Qb2ludGVycyh2aWV3LCBkaXNjb3ZlcnlLZXksIHRydWUsIGNvcmUpCgogICAgaWYgKGhlYWQgPT09IG51bGwpIGhlYWQgPSBpbml0U3RvcmVIZWFkKCkKICAgIGlmIChoZWFkLmRlZmF1bHREaXNjb3ZlcnlLZXkgPT09IG51bGwpIGhlYWQuZGVmYXVsdERpc2NvdmVyeUtleSA9IGRpc2NvdmVyeUtleQoKICAgIGNvbnN0IGNvcmVQb2ludGVyID0gcHRycyA/IHB0cnMuY29yZVBvaW50ZXIgOiBoZWFkLmFsbG9jYXRlZC5jb3JlcysrCiAgICBjb25zdCBkYXRhUG9pbnRlciA9IHB0cnMgPyBwdHJzLmRhdGFQb2ludGVyIDogaGVhZC5hbGxvY2F0ZWQuZGF0YXMrKwoKICAgIGNvcmUgPSB7IHZlcnNpb246IFZFUlNJT04sIGNvcmVQb2ludGVyLCBkYXRhUG9pbnRlciwgYWxpYXMgfQoKICAgIHR4LnNldEhlYWQoaGVhZCkKICAgIHR4LnB1dENvcmUoZGlzY292ZXJ5S2V5LCBjb3JlKQogICAgaWYgKGFsaWFzKSB0eC5wdXRDb3JlQnlBbGlhcyhhbGlhcywgZGlzY292ZXJ5S2V5KQoKICAgIGNvbnN0IHB0ciA9IHsgY29yZVBvaW50ZXIsIGRhdGFQb2ludGVyLCBkZXBlbmRlbmNpZXM6IFtdIH0KICAgIGNvbnN0IGN0eCA9IG5ldyBDb3JlVFgocHRyLCB0aGlzLmRiLCB2aWV3LCB0eC5jaGFuZ2VzKQoKICAgIGN0eC5zZXRBdXRoKHsKICAgICAga2V5LAogICAgICBkaXNjb3ZlcnlLZXksCiAgICAgIG1hbmlmZXN0LAogICAgICBrZXlQYWlyLAogICAgICBlbmNyeXB0aW9uS2V5CiAgICB9KQoKICAgIGlmICh1c2VyRGF0YSkgewogICAgICBmb3IgKGNvbnN0IHsga2V5LCB2YWx1ZSB9IG9mIHVzZXJEYXRhKSB7CiAgICAgICAgY3R4LnB1dFVzZXJEYXRhKGtleSwgdmFsdWUpCiAgICAgIH0KICAgIH0KCiAgICB0eC5hcHBseSgpCgogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVTdG9yYWdlKHRoaXMsIHRoaXMuZGIuc2Vzc2lvbigpLCBwdHIsIEVNUFRZLCBudWxsKQogIH0KCiAgYXN5bmMgY3JlYXRlQ29yZShkYXRhKSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSBhd2FpdCB0aGlzLl9taWdyYXRlU3RvcmUoKQoKICAgIGNvbnN0IHZpZXcgPSBhd2FpdCB0aGlzLl9lbnRlcigpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2NyZWF0ZSh2aWV3LCBkYXRhKQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgdGhpcy5fZXhpdCgpCiAgICB9CiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IENvcmVzdG9yZVN0b3JhZ2UKCmZ1bmN0aW9uIGluaXRTdG9yZUhlYWQoKSB7CiAgcmV0dXJuIHsKICAgIHZlcnNpb246IDAsIC8vIGNhdXNlIHdlIHdhbm5hIHJ1biB0aGUgbWlncmF0aW9uCiAgICBhbGxvY2F0ZWQ6IHsKICAgICAgZGF0YXM6IDAsCiAgICAgIGNvcmVzOiAwCiAgICB9LAogICAgc2VlZDogbnVsbCwKICAgIGRlZmF1bHREaXNjb3ZlcnlLZXk6IG51bGwKICB9Cn0KCmZ1bmN0aW9uIGdldEJhdGNoKHNlc3Npb25zLCBuYW1lLCBhbGxvYykgewogIGZvciAobGV0IGkgPSAwOyBpIDwgc2Vzc2lvbnMubGVuZ3RoOyBpKyspIHsKICAgIGlmIChzZXNzaW9uc1tpXS5uYW1lID09PSBuYW1lKSByZXR1cm4gc2Vzc2lvbnNbaV0KICB9CgogIGlmICghYWxsb2MpIHJldHVybiBudWxsCgogIGNvbnN0IHJlc3VsdCA9IHsgbmFtZSwgZGF0YVBvaW50ZXI6IC0xIH0KICBzZXNzaW9ucy5wdXNoKHJlc3VsdCkKICByZXR1cm4gcmVzdWx0Cn0KCmZ1bmN0aW9uIGlzQ29yZXN0b3JlU3RvcmFnZShzKSB7CiAgcmV0dXJuIHR5cGVvZiBzID09PSAnb2JqZWN0JyAmJiAhIXMgJiYgdHlwZW9mIHMuc2V0RGVmYXVsdERpc2NvdmVyeUtleSA9PT0gJ2Z1bmN0aW9uJwp9CgpmdW5jdGlvbiBjcmVhdGVDb2x1bW5GYW1pbHkoZGIsIG9wdHMgPSB7fSkgewogIGNvbnN0IHsKICAgIHRhYmxlQ2FjaGVJbmRleEFuZEZpbHRlckJsb2NrcyA9IHRydWUsCiAgICBibG9ja0NhY2hlID0gdHJ1ZSwKICAgIG9wdGltaXplRmlsdGVyc0Zvck1lbW9yeSA9IGZhbHNlCiAgfSA9IG9wdHMKCiAgY29uc3QgY29sID0gbmV3IFJvY2tzREIuQ29sdW1uRmFtaWx5KENPTFVNTl9GQU1JTFksIHsKICAgIGVuYWJsZUJsb2JGaWxlczogdHJ1ZSwKICAgIG1pbkJsb2JTaXplOiA0MDk2LAogICAgYmxvYkZpbGVTaXplOiAyNTYgKiAxMDI0ICogMTAyNCwKICAgIGVuYWJsZUJsb2JHYXJiYWdlQ29sbGVjdGlvbjogdHJ1ZSwKICAgIHRhYmxlQmxvY2tTaXplOiA4MTkyLAogICAgdGFibGVDYWNoZUluZGV4QW5kRmlsdGVyQmxvY2tzLAogICAgdGFibGVGb3JtYXRWZXJzaW9uOiA2LAogICAgb3B0aW1pemVGaWx0ZXJzRm9yTWVtb3J5LAogICAgYmxvY2tDYWNoZQogIH0pCgogIHJldHVybiBkYi5jb2x1bW5GYW1pbHkoY29sKQp9CgovLyBUT0RPOiByZW1vdmUgaW4gbGlrZSAzLTYgbW8KZnVuY3Rpb24gdG1wRml4U3RvcmFnZShwKSB7CiAgLy8gaWYgQ09SRVNUT1JFIGZpbGUgaXMgd3JpdHRlbiwgbmV3IGZvcm1hdAogIGlmIChmcy5leGlzdHNTeW5jKHBhdGguam9pbihwLCAnQ09SRVNUT1JFJykpKSByZXR1cm4KCiAgbGV0IGZpbGVzID0gW10KCiAgdHJ5IHsKICAgIGZpbGVzID0gZnMucmVhZGRpclN5bmMocCkKICB9IGNhdGNoIHt9CgogIGNvbnN0IG5vdFJvY2tzID0gbmV3IFNldChbCiAgICAnQ09SRVNUT1JFJywKICAgICdwcmltYXJ5LWtleScsCiAgICAnY29yZXMnLAogICAgJ2FwcC1wcmVmZXJlbmNlcycsCiAgICAnY2FjaGUnLAogICAgJ3ByZWZlcmVuY2VzLmpzb24nLAogICAgJ2RiJywKICAgICdjbG9uZScsCiAgICAnY29yZScsCiAgICAnbm90aWZpY2F0aW9ucycKICBdKQoKICBmb3IgKGNvbnN0IGYgb2YgZmlsZXMpIHsKICAgIGlmIChub3RSb2Nrcy5oYXMoZikpIGNvbnRpbnVlCgogICAgdHJ5IHsKICAgICAgZnMubWtkaXJTeW5jKHBhdGguam9pbihwLCAnZGInKSkKICAgIH0gY2F0Y2gge30KCiAgICBmcy5yZW5hbWVTeW5jKHBhdGguam9pbihwLCBmKSwgcGF0aC5qb2luKHAsICdkYicsIGYpKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZXhwb3J0RGF0YShwdHIsIGRiLCBvcHRzKSB7CiAgLy8ganVzdCBuZWVkIGRhdGFQb2ludGVyCiAgY29uc3QgcmVhZHMgPSBbCiAgICB0b0FycmF5KGNyZWF0ZUJsb2NrU3RyZWFtKHB0ciwgZGIsIEVNUFRZLCBvcHRzKSksCiAgICB0b0FycmF5KGNyZWF0ZVRyZWVOb2RlU3RyZWFtKHB0ciwgZGIsIEVNUFRZLCBvcHRzKSksCiAgICB0b0FycmF5KGNyZWF0ZUJpdGZpZWxkU3RyZWFtKHB0ciwgZGIsIEVNUFRZLCBvcHRzKSkKICBdCgogIGNvbnN0IFtibG9ja3MsIHRyZWUsIGJpdGZpZWxkXSA9IGF3YWl0IFByb21pc2UuYWxsKHJlYWRzKQoKICByZXR1cm4gewogICAgYmxvY2tzLAogICAgdHJlZSwKICAgIGJpdGZpZWxkCiAgfQp9Cgphc3luYyBmdW5jdGlvbiB0b0FycmF5KHN0cmVhbSkgewogIGNvbnN0IGFsbCA9IFtdCiAgZm9yIGF3YWl0IChjb25zdCBlIG9mIHN0cmVhbSkgYWxsLnB1c2goZSkKICByZXR1cm4gYWxsCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKYXN5bmMgZnVuY3Rpb24gZ2V0SW5mb0Zyb21CYXRjaChkYiwgYywgZGlzY292ZXJ5S2V5LCBnZXRBdXRoLCBnZXRIZWFkLCBnZXRIaW50cykgewogIGNvbnN0IGF1dGhQcm9taXNlID0gZ2V0QXV0aCA/IENvcmVSWC5nZXRBdXRoKGRiLCBjKSA6IG51bGwKICBjb25zdCBoZWFkUHJvbWlzZSA9IGdldEhlYWQgPyBDb3JlUlguZ2V0SGVhZChkYiwgYykgOiBudWxsCiAgY29uc3QgaGludHNQcm9taXNlID0gZ2V0SGludHMgPyBDb3JlUlguZ2V0SGludHMoZGIsIGMpIDogbnVsbAoKICAvLyBlbnN1cmUgbm8gdW5jYXVnaHRzCiAgaWYgKGF1dGhQcm9taXNlKSBhdXRoUHJvbWlzZS5jYXRjaChub29wKQogIGlmIChoZWFkUHJvbWlzZSkgaGVhZFByb21pc2UuY2F0Y2gobm9vcCkKICBpZiAoaGludHNQcm9taXNlKSBoaW50c1Byb21pc2UuY2F0Y2gobm9vcCkKCiAgcmV0dXJuIHsKICAgIGRpc2NvdmVyeUtleSwKICAgIGNvcmU6IGMsCiAgICBhdXRoOiBhd2FpdCBhdXRoUHJvbWlzZSwKICAgIGhlYWQ6IGF3YWl0IGhlYWRQcm9taXNlLAogICAgaGludHM6IGF3YWl0IGhpbnRzUHJvbWlzZQogIH0KfQpjb25zdCB7IFJlYWRhYmxlLCBnZXRTdHJlYW1FcnJvciB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IHsgY29yZSB9ID0gcmVxdWlyZSgnLi9rZXlzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQmxvY2tTdHJlYW0gZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3IoY29yZSwgZGIsIHVwZGF0ZXMsIHN0YXJ0LCBlbmQsIHJldmVyc2UpIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICB0aGlzLmRiID0gZGIKICAgIHRoaXMudXBkYXRlcyA9IHVwZGF0ZXMKICAgIHRoaXMuc3RhcnQgPSBzdGFydAogICAgdGhpcy5lbmQgPSBlbmQKICAgIHRoaXMucmV2ZXJzZSA9IHJldmVyc2UgPT09IHRydWUKCiAgICB0aGlzLl9kcmFpbmVkID0gdHJ1ZQogICAgdGhpcy5fY29uc3VtZWQgPSAwCiAgICB0aGlzLl9zdHJlYW0gPSBudWxsCiAgICB0aGlzLl9vbmNsb3NlQm91bmQgPSB0aGlzLl9vbmNsb3NlLmJpbmQodGhpcykKICAgIHRoaXMuX21heWJlRHJhaW5Cb3VuZCA9IHRoaXMuX21heWJlRHJhaW4uYmluZCh0aGlzKQoKICAgIHRoaXMuX3VwZGF0ZSgpCiAgfQoKICBfdXBkYXRlKCkgewogICAgaWYgKHRoaXMuX2NvbnN1bWVkID4gdGhpcy5jb3JlLmRlcGVuZGVuY2llcy5sZW5ndGgpIHJldHVybgoKICAgIGNvbnN0IGRlcHMgPSB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzCiAgICBjb25zdCBpbmRleCA9IHRoaXMuX2ZpbmREZXBlbmRlbmN5SW5kZXgoZGVwcykKCiAgICBjb25zdCBjdXJyID0gaW5kZXggPCBkZXBzLmxlbmd0aCA/IGRlcHNbaW5kZXhdIDogbnVsbAogICAgY29uc3QgcHJldiA9IGluZGV4ID4gMCAmJiBpbmRleCAtIDEgPCBkZXBzLmxlbmd0aCA/IGRlcHNbaW5kZXggLSAxXSA6IG51bGwKCiAgICBjb25zdCBzdGFydCA9IHByZXYgJiYgcHJldi5sZW5ndGggPiB0aGlzLnN0YXJ0ID8gcHJldi5sZW5ndGggOiB0aGlzLnN0YXJ0CiAgICBjb25zdCBlbmQgPSBjdXJyICYmICh0aGlzLmVuZCA9PT0gLTEgfHwgY3Vyci5sZW5ndGggPCB0aGlzLmVuZCkgPyBjdXJyLmxlbmd0aCA6IHRoaXMuZW5kCgogICAgY29uc3QgcHRyID0gY3VyciA/IGN1cnIuZGF0YVBvaW50ZXIgOiB0aGlzLmNvcmUuZGF0YVBvaW50ZXIKCiAgICB0aGlzLl9tYWtlU3RyZWFtKGNvcmUuYmxvY2socHRyLCBzdGFydCksIGNvcmUuYmxvY2socHRyLCBlbmQpKQogIH0KCiAgX2ZpbmREZXBlbmRlbmN5SW5kZXgoZGVwcykgewogICAgaWYgKCF0aGlzLnJldmVyc2UpIHJldHVybiB0aGlzLl9jb25zdW1lZCsrCgogICAgbGV0IGkgPSBkZXBzLmxlbmd0aCAtIHRoaXMuX2NvbnN1bWVkKysKICAgIHdoaWxlIChpID4gMCkgewogICAgICBpZiAoZGVwc1tpIC0gMV0ubGVuZ3RoIDw9IHRoaXMuZW5kKSByZXR1cm4gaQogICAgICBpLS0KICAgICAgdGhpcy5fY29uc3VtZWQrKwogICAgfQoKICAgIHJldHVybiAwCiAgfQoKICBfcHJlZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLl9zdHJlYW0gIT09IG51bGwpIHRoaXMuX3N0cmVhbS5kZXN0cm95KCkKICB9CgogIF9yZWFkKGNiKSB7CiAgICB0aGlzLl9kcmFpbmVkID0gdGhpcy5fb25yZWFkYWJsZSgpCiAgICBjYihudWxsKQogIH0KCiAgX21heWJlRHJhaW4oKSB7CiAgICBpZiAodGhpcy5fZHJhaW5lZCA9PT0gdHJ1ZSkgcmV0dXJuCiAgICB0aGlzLl9kcmFpbmVkID0gdGhpcy5fb25yZWFkYWJsZSgpCiAgfQoKICBfb25yZWFkYWJsZSgpIHsKICAgIGlmICh0aGlzLl9zdHJlYW0gPT09IG51bGwpIHsKICAgICAgdGhpcy5wdXNoKG51bGwpCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgbGV0IGRhdGEgPSB0aGlzLl9zdHJlYW0ucmVhZCgpCgogICAgaWYgKGRhdGEgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIGRvIHsKICAgICAgdGhpcy5wdXNoKGRhdGEpCiAgICAgIGRhdGEgPSB0aGlzLl9zdHJlYW0ucmVhZCgpCiAgICB9IHdoaWxlIChkYXRhICE9PSBudWxsKQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfb25jbG9zZSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3lpbmcpIHJldHVybgoKICAgIGNvbnN0IGVyciA9IGdldFN0cmVhbUVycm9yKHRoaXMuX3N0cmVhbSkKCiAgICBpZiAoZXJyICE9PSBudWxsKSB7CiAgICAgIHRoaXMuZGVzdHJveShlcnIpCiAgICAgIHJldHVybgogICAgfQoKICAgIC8vIGVtcHR5IHRoZSBjdXJyZW50IHN0cmVhbQogICAgaWYgKHRoaXMuX29ucmVhZGFibGUoKSA9PT0gdHJ1ZSkgdGhpcy5fZHJhaW5lZCA9IHRydWUKCiAgICB0aGlzLl9zdHJlYW0gPSBudWxsCgogICAgdGhpcy5fdXBkYXRlKCkKICAgIHRoaXMuX21heWJlRHJhaW4oKQogIH0KCiAgX21ha2VTdHJlYW0oc3RhcnQsIGVuZCkgewogICAgdGhpcy5fc3RyZWFtID0gdGhpcy51cGRhdGVzLml0ZXJhdG9yKHRoaXMuZGIsIHN0YXJ0LCBlbmQsIHRoaXMucmV2ZXJzZSkKICAgIHRoaXMuX3N0cmVhbS5vbigncmVhZGFibGUnLCB0aGlzLl9tYXliZURyYWluQm91bmQpCiAgICB0aGlzLl9zdHJlYW0ub24oJ2Vycm9yJywgbm9vcCkKICAgIHRoaXMuX3N0cmVhbS5vbignY2xvc2UnLCB0aGlzLl9vbmNsb3NlQm91bmQpCiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KY29uc3QgeyBSZWFkYWJsZSB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCgovLyB1c2VkIGZvciByZXR1cm5lZCBhIHN0cmVhbSB0aGF0IGp1c3QgZXJyb3JzIChkdXJpbmcgcmVhZCBkdXJpbmcgdGVhcmRvd24pCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENsb3NlRXJyb3JTdHJlYW0gZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3IoZXJyKSB7CiAgICBzdXBlcigpCiAgICB0aGlzLmVycm9yID0gZXJyCiAgfQoKICBfb3BlbihjYikgewogICAgY2IodGhpcy5lcnJvcikKICB9Cn0KY29uc3QgeyBVSU5ULCBTVFJJTkcgfSA9IHJlcXVpcmUoJ2luZGV4LWVuY29kZXInKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBUTF9IRUFEID0gMApjb25zdCBUTF9DT1JFX0JZX0RLRVkgPSAxCmNvbnN0IFRMX0NPUkVfQllfQUxJQVMgPSAyCmNvbnN0IFRMX0NPUkUgPSAzCmNvbnN0IFRMX0RBVEEgPSA0Cgpjb25zdCBUTF9FTkQgPSBUTF9EQVRBICsgMQoKY29uc3QgQ09SRV9BVVRIID0gMApjb25zdCBDT1JFX1NFU1NJT05TID0gMQoKY29uc3QgREFUQV9IRUFEID0gMApjb25zdCBEQVRBX0RFUEVOREVOQ1kgPSAxCmNvbnN0IERBVEFfSElOVFMgPSAyCmNvbnN0IERBVEFfQkxPQ0sgPSAzCmNvbnN0IERBVEFfVFJFRSA9IDQKY29uc3QgREFUQV9CSVRGSUVMRCA9IDUKY29uc3QgREFUQV9VU0VSX0RBVEEgPSA2CmNvbnN0IERBVEFfTE9DQUwgPSA3Cgpjb25zdCBzbGFiID0geyBidWZmZXI6IGI0YS5hbGxvY1Vuc2FmZSg2NTUzNiksIHN0YXJ0OiAwLCBlbmQ6IDAgfQoKY29uc3Qgc3RvcmUgPSB7fQpjb25zdCBjb3JlID0ge30KCnN0b3JlLmNsZWFyID0gZnVuY3Rpb24gKCkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGxldCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIDApCiAgY29uc3QgYSA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCiAgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9FTkQpCiAgY29uc3QgYiA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCiAgcmV0dXJuIFthLCBiXQp9CgpzdG9yZS5oZWFkID0gZnVuY3Rpb24gKCkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfSEVBRCkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKc3RvcmUuY29yZSA9IGZ1bmN0aW9uIChkaXNjb3ZlcnlLZXkpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0NPUkVfQllfREtFWSkKICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBkaXNjb3ZlcnlLZXkpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCnN0b3JlLmNvcmVTdGFydCA9IGZ1bmN0aW9uICgpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0NPUkVfQllfREtFWSkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKc3RvcmUuY29yZUVuZCA9IGZ1bmN0aW9uICgpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0NPUkVfQllfREtFWSArIDEpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCnN0b3JlLmNvcmVCeUFsaWFzID0gZnVuY3Rpb24gKHsgbmFtZXNwYWNlLCBuYW1lIH0pIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0NPUkVfQllfQUxJQVMpCiAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbmFtZXNwYWNlKQogIFNUUklORy5lbmNvZGUoc3RhdGUsIG5hbWUpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCnN0b3JlLmNvcmVCeUFsaWFzU3RhcnQgPSBmdW5jdGlvbiAobmFtZXNwYWNlKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9DT1JFX0JZX0FMSUFTKQogIGlmIChuYW1lc3BhY2UpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG5hbWVzcGFjZSkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKc3RvcmUuY29yZUJ5QWxpYXNFbmQgPSBmdW5jdGlvbiAobmFtZXNwYWNlKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAoKICBpZiAobmFtZXNwYWNlKSB7CiAgICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRV9CWV9BTElBUykKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG5hbWVzcGFjZSkKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4ZmYKICB9IGVsc2UgewogICAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0NPUkVfQllfQUxJQVMgKyAxKQogIH0KCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCnN0b3JlLmFsaWFzID0gZnVuY3Rpb24gKGJ1ZmZlcikgewogIGNvbnN0IHN0YXRlID0geyBidWZmZXIsIHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoIH0KICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gbnMKICBjb25zdCBuYW1lc3BhY2UgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogIGNvbnN0IG5hbWUgPSBTVFJJTkcuZGVjb2RlKHN0YXRlKQogIHJldHVybiB7IG5hbWVzcGFjZSwgbmFtZSB9Cn0KCnN0b3JlLmRpc2NvdmVyeUtleSA9IGZ1bmN0aW9uIChidWZmZXIpIHsKICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyLCBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCB9CiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIG5zCiAgcmV0dXJuIGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCn0KCmNvcmUuY29yZSA9IGZ1bmN0aW9uIChwdHIpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0NPUkUpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS5kYXRhID0gZnVuY3Rpb24gKHB0cikgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfREFUQSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLmF1dGggPSBmdW5jdGlvbiAocHRyKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9DT1JFKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIENPUkVfQVVUSCkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS5zZXNzaW9ucyA9IGZ1bmN0aW9uIChwdHIpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0NPUkUpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgQ09SRV9TRVNTSU9OUykKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS5oZWFkID0gZnVuY3Rpb24gKHB0cikgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfREFUQSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBEQVRBX0hFQUQpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUuZGVwZW5kZW5jeSA9IGZ1bmN0aW9uIChwdHIpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0RBVEEpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgREFUQV9ERVBFTkRFTkNZKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLmhpbnRzID0gZnVuY3Rpb24gKHB0cikgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfREFUQSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBEQVRBX0hJTlRTKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLmJsb2NrID0gZnVuY3Rpb24gKHB0ciwgaW5kZXgpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0RBVEEpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgREFUQV9CTE9DSykKICBVSU5ULmVuY29kZShzdGF0ZSwgaW5kZXgpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUudHJlZSA9IGZ1bmN0aW9uIChwdHIsIGluZGV4KSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfVFJFRSkKICBVSU5ULmVuY29kZShzdGF0ZSwgaW5kZXgpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUuYml0ZmllbGQgPSBmdW5jdGlvbiAocHRyLCBpbmRleCwgdHlwZSkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfREFUQSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBEQVRBX0JJVEZJRUxEKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBpbmRleCkKICBVSU5ULmVuY29kZShzdGF0ZSwgdHlwZSkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS51c2VyRGF0YSA9IGZ1bmN0aW9uIChwdHIsIGtleSkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfREFUQSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBEQVRBX1VTRVJfREFUQSkKICBTVFJJTkcuZW5jb2RlKHN0YXRlLCBrZXkpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUudXNlckRhdGFFbmQgPSBmdW5jdGlvbiAocHRyKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfVVNFUl9EQVRBICsgMSkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS5sb2NhbCA9IGZ1bmN0aW9uIChwdHIsIGtleSkgewogIGlmIChrZXkuYnl0ZUxlbmd0aCA+IDIwNDgpIHsKICAgIHRocm93IG5ldyBFcnJvcignbG9jYWwga2V5cyBoYXMgYW4gdXBwZXIgbGltaXQgb2YgMjA0OCBieXRlcyBhdG0nKQogIH0KCiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfTE9DQUwpCgogIHN0YXRlLmJ1ZmZlci5zZXQoa2V5LCBzdGF0ZS5zdGFydCkKICBzdGF0ZS5zdGFydCArPSBrZXkuYnl0ZUxlbmd0aAogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLmxvY2FsRW5kID0gZnVuY3Rpb24gKHB0cikgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfREFUQSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBEQVRBX0xPQ0FMICsgMSkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS5ibG9ja0luZGV4ID0gZnVuY3Rpb24gKGJ1ZmZlcikgewogIGNvbnN0IHN0YXRlID0geyBidWZmZXIsIHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoIH0KICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gbnMKICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gcHRyCiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIHR5cGUKICByZXR1cm4gVUlOVC5kZWNvZGUoc3RhdGUpCn0KCmNvcmUuYml0ZmllbGRJbmRleEFuZFR5cGUgPSBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlciwgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGggfQogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBucwogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBwdHIKICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gdHlwZQogIHJldHVybiBbVUlOVC5kZWNvZGUoc3RhdGUpLCBVSU5ULmRlY29kZShzdGF0ZSldCn0KCmNvcmUudXNlckRhdGFLZXkgPSBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlciwgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGggfQogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBucwogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBwdHIKICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gdHlwZQogIHJldHVybiBTVFJJTkcuZGVjb2RlKHN0YXRlKQp9Cgpjb3JlLmxvY2FsS2V5ID0gZnVuY3Rpb24gKGJ1ZmZlcikgewogIGNvbnN0IHN0YXRlID0geyBidWZmZXIsIHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoIH0KICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gbnMKICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gcHRyCiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIHR5cGUKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0LCBzdGF0ZS5lbmQpCn0KCm1vZHVsZS5leHBvcnRzID0geyBzdG9yZSwgY29yZSB9CgpmdW5jdGlvbiBhbGxvYygpIHsKICBpZiAoc2xhYi5idWZmZXIuYnl0ZUxlbmd0aCAtIHNsYWIuc3RhcnQgPCA0MDk2KSB7CiAgICBzbGFiLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShzbGFiLmJ1ZmZlci5ieXRlTGVuZ3RoKQogICAgc2xhYi5zdGFydCA9IDAKICB9CiAgcmV0dXJuIHNsYWIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBCbG9ja0RlcGVuZGVuY3lTdHJlYW0gPSByZXF1aXJlKCcuL2Jsb2NrLWRlcGVuZGVuY3ktc3RyZWFtLmpzJykKY29uc3QgeyBjb3JlLCBzdG9yZSB9ID0gcmVxdWlyZSgnLi9rZXlzLmpzJykKY29uc3Qgc2NoZW1hID0gcmVxdWlyZSgnLi4vc3BlYy9oeXBlcnNjaGVtYScpCgpjb25zdCBDT1JFU1RPUkVfQ09SRSA9IHNjaGVtYS5nZXRFbmNvZGluZygnQGNvcmVzdG9yZS9jb3JlJykKY29uc3QgQ09SRV9UUkVFX05PREUgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0Bjb3JlL3RyZWUtbm9kZScpCmNvbnN0IEVNUFRZID0gYjRhLmFsbG9jKDApCgptb2R1bGUuZXhwb3J0cyA9IHsKICBjcmVhdGVCbG9ja1N0cmVhbSwKICBjcmVhdGVCaXRmaWVsZFN0cmVhbSwKICBjcmVhdGVVc2VyRGF0YVN0cmVhbSwKICBjcmVhdGVDb3JlU3RyZWFtLAogIGNyZWF0ZUFsaWFzU3RyZWFtLAogIGNyZWF0ZURpc2NvdmVyeUtleVN0cmVhbSwKICBjcmVhdGVUcmVlTm9kZVN0cmVhbSwKICBjcmVhdGVMb2NhbFN0cmVhbQp9CgpmdW5jdGlvbiBjcmVhdGVDb3JlU3RyZWFtKGRiLCB2aWV3KSB7CiAgY29uc3Qgc3RhcnQgPSBzdG9yZS5jb3JlU3RhcnQoKQogIGNvbnN0IGVuZCA9IHN0b3JlLmNvcmVFbmQoKQoKICBjb25zdCBpdGUgPSB2aWV3Lml0ZXJhdG9yKGRiLCBzdGFydCwgZW5kLCBmYWxzZSkKCiAgaXRlLl9yZWFkYWJsZVN0YXRlLm1hcCA9IG1hcENvcmUKICByZXR1cm4gaXRlCn0KCmZ1bmN0aW9uIGNyZWF0ZURpc2NvdmVyeUtleVN0cmVhbShkYiwgdmlldywgbmFtZXNwYWNlKSB7CiAgY29uc3Qgc3RhcnQgPSBuYW1lc3BhY2UgPyBzdG9yZS5jb3JlQnlBbGlhc1N0YXJ0KG5hbWVzcGFjZSkgOiBzdG9yZS5jb3JlU3RhcnQoKQogIGNvbnN0IGVuZCA9IG5hbWVzcGFjZSA/IHN0b3JlLmNvcmVCeUFsaWFzRW5kKG5hbWVzcGFjZSkgOiBzdG9yZS5jb3JlRW5kKCkKCiAgY29uc3QgaXRlID0gdmlldy5pdGVyYXRvcihkYiwgc3RhcnQsIGVuZCwgZmFsc2UpCgogIGl0ZS5fcmVhZGFibGVTdGF0ZS5tYXAgPSBuYW1lc3BhY2UgPyBtYXBOYW1lc3BhY2VEaXNjb3ZlcnlLZXlzIDogbWFwQWxsRGlzY292ZXJ5S2V5cwogIHJldHVybiBpdGUKfQoKZnVuY3Rpb24gY3JlYXRlQWxpYXNTdHJlYW0oZGIsIHZpZXcsIG5hbWVzcGFjZSkgewogIGNvbnN0IHN0YXJ0ID0gc3RvcmUuY29yZUJ5QWxpYXNTdGFydChuYW1lc3BhY2UpCiAgY29uc3QgZW5kID0gc3RvcmUuY29yZUJ5QWxpYXNFbmQobmFtZXNwYWNlKQoKICBjb25zdCBpdGUgPSB2aWV3Lml0ZXJhdG9yKGRiLCBzdGFydCwgZW5kLCBmYWxzZSkKCiAgaXRlLl9yZWFkYWJsZVN0YXRlLm1hcCA9IG1hcEFsaWFzCiAgcmV0dXJuIGl0ZQp9CgpmdW5jdGlvbiBjcmVhdGVCbG9ja0l0ZXJhdG9yKHB0ciwgZGIsIHZpZXcsIHN0YXJ0LCBlbmQsIHJldmVyc2UpIHsKICBpZiAocHRyLmRlcGVuZGVuY2llcy5sZW5ndGggPiAwKSB7CiAgICByZXR1cm4gbmV3IEJsb2NrRGVwZW5kZW5jeVN0cmVhbShwdHIsIGRiLCB2aWV3LCBzdGFydCwgZW5kLCByZXZlcnNlKQogIH0KCiAgY29uc3QgcyA9IGNvcmUuYmxvY2socHRyLmRhdGFQb2ludGVyLCBzdGFydCkKICBjb25zdCBlID0gY29yZS5ibG9jayhwdHIuZGF0YVBvaW50ZXIsIGVuZCA9PT0gLTEgPyBJbmZpbml0eSA6IGVuZCkKICByZXR1cm4gdmlldy5pdGVyYXRvcihkYiwgcywgZSwgcmV2ZXJzZSkKfQoKZnVuY3Rpb24gY3JlYXRlQmxvY2tTdHJlYW0oCiAgcHRyLAogIGRiLAogIHZpZXcsCiAgeyBndCA9IC0xLCBndGUgPSBndCArIDEsIGx0ZSA9IC0xLCBsdCA9IGx0ZSA9PT0gLTEgPyAtMSA6IGx0ZSArIDEsIHJldmVyc2UgPSBmYWxzZSB9ID0ge30KKSB7CiAgY29uc3QgaXRlID0gY3JlYXRlQmxvY2tJdGVyYXRvcihwdHIsIGRiLCB2aWV3LCBndGUsIGx0LCByZXZlcnNlKQoKICBpdGUuX3JlYWRhYmxlU3RhdGUubWFwID0gbWFwQmxvY2sKICByZXR1cm4gaXRlCn0KCmZ1bmN0aW9uIGNyZWF0ZUJpdGZpZWxkU3RyZWFtKAogIHB0ciwKICBkYiwKICB2aWV3LAogIHsgZ3QgPSAtMSwgZ3RlID0gZ3QgKyAxLCBsdGUgPSAtMSwgbHQgPSBsdGUgPT09IC0xID8gLTEgOiBsdGUgKyAxLCByZXZlcnNlID0gZmFsc2UgfSA9IHt9CikgewogIGNvbnN0IHMgPSBjb3JlLmJpdGZpZWxkKHB0ci5kYXRhUG9pbnRlciwgZ3RlLCAwKQogIGNvbnN0IGUgPSBjb3JlLmJpdGZpZWxkKHB0ci5kYXRhUG9pbnRlciwgbHQgPT09IC0xID8gSW5maW5pdHkgOiBsdCwgMCkKICBjb25zdCBpdGUgPSB2aWV3Lml0ZXJhdG9yKGRiLCBzLCBlLCBmYWxzZSkKCiAgaXRlLl9yZWFkYWJsZVN0YXRlLm1hcCA9IG1hcEJpdGZpZWxkCiAgcmV0dXJuIGl0ZQp9CgovLyBOT1RFOiB0aGlzIGRvZXMgbm90IGRvIGRlcGVuZGVuY3kgbG9va3VwcyBhdG0KZnVuY3Rpb24gY3JlYXRlVHJlZU5vZGVTdHJlYW0oCiAgcHRyLAogIGRiLAogIHZpZXcsCiAgeyBndCA9IC0xLCBndGUgPSBndCArIDEsIGx0ZSA9IC0xLCBsdCA9IGx0ZSA9PT0gLTEgPyAtMSA6IGx0ZSArIDEsIHJldmVyc2UgPSBmYWxzZSB9ID0ge30KKSB7CiAgY29uc3QgcyA9IGNvcmUudHJlZShwdHIuZGF0YVBvaW50ZXIsIGd0ZSwgMCkKICBjb25zdCBlID0gY29yZS50cmVlKHB0ci5kYXRhUG9pbnRlciwgbHQgPT09IC0xID8gSW5maW5pdHkgOiBsdCwgMCkKICBjb25zdCBpdGUgPSB2aWV3Lml0ZXJhdG9yKGRiLCBzLCBlLCBmYWxzZSkKCiAgaXRlLl9yZWFkYWJsZVN0YXRlLm1hcCA9IG1hcFRyZWVOb2RlCiAgcmV0dXJuIGl0ZQp9CgpmdW5jdGlvbiBjcmVhdGVVc2VyRGF0YVN0cmVhbSgKICBwdHIsCiAgZGIsCiAgdmlldywKICB7IGd0ID0gbnVsbCwgZ3RlID0gJycsIGx0ZSA9IG51bGwsIGx0ID0gbnVsbCwgcmV2ZXJzZSA9IGZhbHNlIH0gPSB7fQopIHsKICBpZiAoZ3QgIT09IG51bGwgfHwgbHRlICE9PSBudWxsKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ2d0IGFuZCBsdGUgbm90IHlldCBzdXBwb3J0ZWQgZm9yIHVzZXIgZGF0YSBzdHJlYW1zJykKICB9CgogIGNvbnN0IHMgPSBjb3JlLnVzZXJEYXRhKHB0ci5kYXRhUG9pbnRlciwgZ3RlKQogIGNvbnN0IGUgPSBsdCA9PT0gbnVsbCA/IGNvcmUudXNlckRhdGFFbmQocHRyLmRhdGFQb2ludGVyKSA6IGNvcmUudXNlckRhdGEocHRyLmRhdGFQb2ludGVyLCBsdCkKICBjb25zdCBpdGUgPSB2aWV3Lml0ZXJhdG9yKGRiLCBzLCBlLCBmYWxzZSkKCiAgaXRlLl9yZWFkYWJsZVN0YXRlLm1hcCA9IG1hcFVzZXJEYXRhCiAgcmV0dXJuIGl0ZQp9CgpmdW5jdGlvbiBjcmVhdGVMb2NhbFN0cmVhbSgKICBwdHIsCiAgZGIsCiAgdmlldywKICB7IGd0ID0gbnVsbCwgZ3RlID0gRU1QVFksIGx0ZSA9IG51bGwsIGx0ID0gbnVsbCwgcmV2ZXJzZSA9IGZhbHNlIH0gPSB7fQopIHsKICBpZiAoZ3QgIT09IG51bGwgfHwgbHRlICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ2d0IGFuZCBsdGUgbm90IHlldCBzdXBwb3J0ZWQgZm9yIGxvY2FsIHN0cmVhbXMnKQoKICBjb25zdCBzID0gY29yZS5sb2NhbChwdHIuZGF0YVBvaW50ZXIsIGd0ZSkKICBjb25zdCBlID0gbHQgPT09IG51bGwgPyBjb3JlLmxvY2FsRW5kKHB0ci5kYXRhUG9pbnRlcikgOiBjb3JlLmxvY2FsKHB0ci5kYXRhUG9pbnRlciwgbHQpCiAgY29uc3QgaXRlID0gdmlldy5pdGVyYXRvcihkYiwgcywgZSwgZmFsc2UpCgogIGl0ZS5fcmVhZGFibGVTdGF0ZS5tYXAgPSBtYXBMb2NhbAogIHJldHVybiBpdGUKfQoKZnVuY3Rpb24gbWFwQml0ZmllbGQoZGF0YSkgewogIGNvbnN0IFtpbmRleCwgdHlwZV0gPSBjb3JlLmJpdGZpZWxkSW5kZXhBbmRUeXBlKGRhdGEua2V5KQogIGlmICh0eXBlICE9PSAwKSByZXR1cm4gbnVsbCAvLyBpZ25vcmUgZm9yIG5vdwogIHJldHVybiB7IGluZGV4LCBwYWdlOiBkYXRhLnZhbHVlIH0KfQoKZnVuY3Rpb24gbWFwTG9jYWwoZGF0YSkgewogIGNvbnN0IGtleSA9IGNvcmUubG9jYWxLZXkoZGF0YS5rZXkpCiAgcmV0dXJuIHsga2V5LCB2YWx1ZTogZGF0YS52YWx1ZSB9Cn0KCmZ1bmN0aW9uIG1hcFVzZXJEYXRhKGRhdGEpIHsKICBjb25zdCBrZXkgPSBjb3JlLnVzZXJEYXRhS2V5KGRhdGEua2V5KQogIHJldHVybiB7IGtleSwgdmFsdWU6IGRhdGEudmFsdWUgfQp9CgpmdW5jdGlvbiBtYXBDb3JlKGRhdGEpIHsKICBjb25zdCBkaXNjb3ZlcnlLZXkgPSBzdG9yZS5kaXNjb3ZlcnlLZXkoZGF0YS5rZXkpCiAgY29uc3QgY29yZSA9IENPUkVTVE9SRV9DT1JFLmRlY29kZSh7CiAgICBzdGFydDogMCwKICAgIGVuZDogZGF0YS52YWx1ZS5ieXRlTGVuZ3RoLAogICAgYnVmZmVyOiBkYXRhLnZhbHVlCiAgfSkKICByZXR1cm4geyBkaXNjb3ZlcnlLZXksIGNvcmUgfQp9CgpmdW5jdGlvbiBtYXBBbGxEaXNjb3ZlcnlLZXlzKGRhdGEpIHsKICByZXR1cm4gc3RvcmUuZGlzY292ZXJ5S2V5KGRhdGEua2V5KQp9CgpmdW5jdGlvbiBtYXBOYW1lc3BhY2VEaXNjb3ZlcnlLZXlzKGRhdGEpIHsKICByZXR1cm4gZGF0YS52YWx1ZQp9CgpmdW5jdGlvbiBtYXBBbGlhcyhkYXRhKSB7CiAgY29uc3QgYWxpYXMgPSBzdG9yZS5hbGlhcyhkYXRhLmtleSkKICByZXR1cm4geyBhbGlhcywgZGlzY292ZXJ5S2V5OiBkYXRhLnZhbHVlIH0KfQoKZnVuY3Rpb24gbWFwQmxvY2soZGF0YSkgewogIHJldHVybiB7IGluZGV4OiBjb3JlLmJsb2NrSW5kZXgoZGF0YS5rZXkpLCB2YWx1ZTogZGF0YS52YWx1ZSB9Cn0KCmZ1bmN0aW9uIG1hcFRyZWVOb2RlKGRhdGEpIHsKICByZXR1cm4gQ09SRV9UUkVFX05PREUuZGVjb2RlKHsKICAgIHN0YXJ0OiAwLAogICAgZW5kOiBkYXRhLnZhbHVlLmJ5dGVMZW5ndGgsCiAgICBidWZmZXI6IGRhdGEudmFsdWUKICB9KQp9CmNvbnN0IHNjaGVtYSA9IHJlcXVpcmUoJy4uL3NwZWMvaHlwZXJzY2hlbWEnKQpjb25zdCB7IHN0b3JlLCBjb3JlIH0gPSByZXF1aXJlKCcuL2tleXMuanMnKQpjb25zdCBWaWV3ID0gcmVxdWlyZSgnLi92aWV3LmpzJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgZmxhdCA9IHJlcXVpcmUoJ2ZsYXQtdHJlZScpCgpjb25zdCBDT1JFU1RPUkVfSEVBRCA9IHNjaGVtYS5nZXRFbmNvZGluZygnQGNvcmVzdG9yZS9oZWFkJykKY29uc3QgQ09SRVNUT1JFX0NPUkUgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0Bjb3Jlc3RvcmUvY29yZScpCgpjb25zdCBDT1JFX0FVVEggPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0Bjb3JlL2F1dGgnKQpjb25zdCBDT1JFX1NFU1NJT05TID0gc2NoZW1hLmdldEVuY29kaW5nKCdAY29yZS9zZXNzaW9ucycpCmNvbnN0IENPUkVfSEVBRCA9IHNjaGVtYS5nZXRFbmNvZGluZygnQGNvcmUvaGVhZCcpCmNvbnN0IENPUkVfVFJFRV9OT0RFID0gc2NoZW1hLmdldEVuY29kaW5nKCdAY29yZS90cmVlLW5vZGUnKQpjb25zdCBDT1JFX0RFUEVOREVOQ1kgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0Bjb3JlL2RlcGVuZGVuY3knKQpjb25zdCBDT1JFX0hJTlRTID0gc2NoZW1hLmdldEVuY29kaW5nKCdAY29yZS9oaW50cycpCgpjbGFzcyBDb3JlVFggewogIGNvbnN0cnVjdG9yKGNvcmUsIGRiLCB2aWV3LCBjaGFuZ2VzKSB7CiAgICBpZiAoZGIuc25hcHNob3R0ZWQpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IG9wZW4gY29yZSB0eCBvbiBzbmFwc2hvdCcpCiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICB0aGlzLmRiID0gZGIKICAgIHRoaXMudmlldyA9IHZpZXcKICAgIHRoaXMuY2hhbmdlcyA9IGNoYW5nZXMKICB9CgogIHNldEF1dGgoYXV0aCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUuYXV0aCh0aGlzLmNvcmUuY29yZVBvaW50ZXIpLCBlbmNvZGUoQ09SRV9BVVRILCBhdXRoKSwgbnVsbF0pCiAgfQoKICBzZXRTZXNzaW9ucyhzZXNzaW9ucykgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUuc2Vzc2lvbnModGhpcy5jb3JlLmNvcmVQb2ludGVyKSwgZW5jb2RlKENPUkVfU0VTU0lPTlMsIHNlc3Npb25zKSwgbnVsbF0pCiAgfQoKICBzZXRIZWFkKGhlYWQpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLmhlYWQodGhpcy5jb3JlLmRhdGFQb2ludGVyKSwgZW5jb2RlKENPUkVfSEVBRCwgaGVhZCksIG51bGxdKQogIH0KCiAgZGVsZXRlSGVhZCgpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLmhlYWQodGhpcy5jb3JlLmRhdGFQb2ludGVyKSwgbnVsbCwgbnVsbF0pCiAgfQoKICBzZXREZXBlbmRlbmN5KGRlcCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUuZGVwZW5kZW5jeSh0aGlzLmNvcmUuZGF0YVBvaW50ZXIpLCBlbmNvZGUoQ09SRV9ERVBFTkRFTkNZLCBkZXApLCBudWxsXSkKICB9CgogIHNldEhpbnRzKGhpbnRzKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5oaW50cyh0aGlzLmNvcmUuZGF0YVBvaW50ZXIpLCBlbmNvZGUoQ09SRV9ISU5UUywgaGludHMpLCBudWxsXSkKICB9CgogIHB1dEJsb2NrKGluZGV4LCBkYXRhKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5ibG9jayh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGluZGV4KSwgZGF0YSwgbnVsbF0pCiAgfQoKICBkZWxldGVCbG9jayhpbmRleCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUuYmxvY2sodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBpbmRleCksIG51bGwsIG51bGxdKQogIH0KCiAgZGVsZXRlQmxvY2tSYW5nZShzdGFydCwgZW5kKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbCiAgICAgIGNvcmUuYmxvY2sodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBzdGFydCksCiAgICAgIG51bGwsCiAgICAgIGNvcmUuYmxvY2sodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBlbmQgPT09IC0xID8gSW5maW5pdHkgOiBlbmQpCiAgICBdKQogIH0KCiAgcHV0Qml0ZmllbGRQYWdlKGluZGV4LCBkYXRhKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5iaXRmaWVsZCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGluZGV4LCAwKSwgZGF0YSwgbnVsbF0pCiAgfQoKICBkZWxldGVCaXRmaWVsZFBhZ2UoaW5kZXgpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLmJpdGZpZWxkKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgaW5kZXgsIDApLCBudWxsLCBudWxsXSkKICB9CgogIGRlbGV0ZUJpdGZpZWxkUGFnZVJhbmdlKHN0YXJ0LCBlbmQpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFsKICAgICAgY29yZS5iaXRmaWVsZCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIHN0YXJ0LCAwKSwKICAgICAgbnVsbCwKICAgICAgY29yZS5iaXRmaWVsZCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGVuZCA9PT0gLTEgPyBJbmZpbml0eSA6IGVuZCwgMCkKICAgIF0pCiAgfQoKICBwdXRUcmVlTm9kZShub2RlKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbCiAgICAgIGNvcmUudHJlZSh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIG5vZGUuaW5kZXgpLAogICAgICBlbmNvZGUoQ09SRV9UUkVFX05PREUsIG5vZGUpLAogICAgICBudWxsCiAgICBdKQogIH0KCiAgZGVsZXRlVHJlZU5vZGUoaW5kZXgpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLnRyZWUodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBpbmRleCksIG51bGwsIG51bGxdKQogIH0KCiAgZGVsZXRlVHJlZU5vZGVSYW5nZShzdGFydCwgZW5kKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbCiAgICAgIGNvcmUudHJlZSh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIHN0YXJ0KSwKICAgICAgbnVsbCwKICAgICAgY29yZS50cmVlKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgZW5kID09PSAtMSA/IEluZmluaXR5IDogZW5kKQogICAgXSkKICB9CgogIHB1dFVzZXJEYXRhKGtleSwgdmFsdWUpIHsKICAgIGNvbnN0IGJ1ZmZlciA9IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyBiNGEuZnJvbSh2YWx1ZSkgOiB2YWx1ZQogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUudXNlckRhdGEodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBrZXkpLCBidWZmZXIsIG51bGxdKQogIH0KCiAgZGVsZXRlVXNlckRhdGEoa2V5KSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS51c2VyRGF0YSh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGtleSksIG51bGwsIG51bGxdKQogIH0KCiAgcHV0TG9jYWwoa2V5LCB2YWx1ZSkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUubG9jYWwodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBrZXkpLCB2YWx1ZSwgbnVsbF0pCiAgfQoKICBkZWxldGVMb2NhbChrZXkpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLmxvY2FsKHRoaXMuY29yZS5kYXRhUG9pbnRlciwga2V5KSwgbnVsbCwgbnVsbF0pCiAgfQoKICBkZWxldGVMb2NhbFJhbmdlKHN0YXJ0LCBlbmQpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFsKICAgICAgY29yZS5sb2NhbCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIHN0YXJ0KSwKICAgICAgbnVsbCwKICAgICAgZW5kID09PSBudWxsID8gY29yZS5sb2NhbEVuZCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIpIDogY29yZS5sb2NhbCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGVuZCkKICAgIF0pCiAgfQoKICBmbHVzaCgpIHsKICAgIGNvbnN0IGNoYW5nZXMgPSB0aGlzLmNoYW5nZXMKICAgIGlmIChjaGFuZ2VzID09PSBudWxsKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCF0aGlzLnZpZXcpCgogICAgdGhpcy5jaGFuZ2VzID0gbnVsbAoKICAgIGlmICh0aGlzLnZpZXcpIHsKICAgICAgdGhpcy52aWV3LmFwcGx5KGNoYW5nZXMpCiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpCiAgICB9CgogICAgcmV0dXJuIFZpZXcuZmx1c2goY2hhbmdlcywgdGhpcy5kYikKICB9Cn0KCmNsYXNzIENvcmVSWCB7CiAgY29uc3RydWN0b3IoY29yZSwgZGIsIHZpZXcpIHsKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMucmVhZCA9IGRiLnJlYWQoeyBhdXRvRGVzdHJveTogdHJ1ZSB9KQogICAgdGhpcy52aWV3ID0gdmlldwoKICAgIHZpZXcucmVhZFN0YXJ0KCkKICB9CgogIHN0YXRpYyBhc3luYyBnZXRBdXRoKGRiLCBjKSB7CiAgICByZXR1cm4gYXdhaXQgZGVjb2RlKENPUkVfQVVUSCwgYXdhaXQgZGIuZ2V0KGNvcmUuYXV0aChjLmNvcmVQb2ludGVyKSkpCiAgfQoKICBhc3luYyBnZXRBdXRoKCkgewogICAgcmV0dXJuIGF3YWl0IGRlY29kZShDT1JFX0FVVEgsIGF3YWl0IHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBjb3JlLmF1dGgodGhpcy5jb3JlLmNvcmVQb2ludGVyKSkpCiAgfQoKICBhc3luYyBnZXRTZXNzaW9ucygpIHsKICAgIHJldHVybiBhd2FpdCBkZWNvZGUoCiAgICAgIENPUkVfU0VTU0lPTlMsCiAgICAgIGF3YWl0IHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBjb3JlLnNlc3Npb25zKHRoaXMuY29yZS5jb3JlUG9pbnRlcikpCiAgICApCiAgfQoKICBzdGF0aWMgYXN5bmMgZ2V0SGVhZChkYiwgYykgewogICAgcmV0dXJuIGF3YWl0IGRlY29kZShDT1JFX0hFQUQsIGF3YWl0IGRiLmdldChjb3JlLmhlYWQoYy5kYXRhUG9pbnRlcikpKQogIH0KCiAgYXN5bmMgZ2V0SGVhZCgpIHsKICAgIHJldHVybiBhd2FpdCBkZWNvZGUoQ09SRV9IRUFELCBhd2FpdCB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgY29yZS5oZWFkKHRoaXMuY29yZS5kYXRhUG9pbnRlcikpKQogIH0KCiAgYXN5bmMgZ2V0RGVwZW5kZW5jeSgpIHsKICAgIHJldHVybiBhd2FpdCBkZWNvZGUoCiAgICAgIENPUkVfREVQRU5ERU5DWSwKICAgICAgYXdhaXQgdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUuZGVwZW5kZW5jeSh0aGlzLmNvcmUuZGF0YVBvaW50ZXIpKQogICAgKQogIH0KCiAgc3RhdGljIGFzeW5jIGdldEhpbnRzKGRiLCBjKSB7CiAgICByZXR1cm4gYXdhaXQgZGVjb2RlKENPUkVfSElOVFMsIGF3YWl0IGRiLmdldChjb3JlLmhpbnRzKGMuZGF0YVBvaW50ZXIpKSkKICB9CgogIGFzeW5jIGdldEhpbnRzKCkgewogICAgcmV0dXJuIGF3YWl0IGRlY29kZSgKICAgICAgQ09SRV9ISU5UUywKICAgICAgYXdhaXQgdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUuaGludHModGhpcy5jb3JlLmRhdGFQb2ludGVyKSkKICAgICkKICB9CgogIGdldEJsb2NrKGluZGV4KSB7CiAgICBjb25zdCBkZXAgPSBmaW5kQmxvY2tEZXBlbmRlbmN5KHRoaXMuY29yZS5kZXBlbmRlbmNpZXMsIGluZGV4KQogICAgY29uc3QgZGF0YSA9IGRlcCA9PT0gbnVsbCA/IHRoaXMuY29yZS5kYXRhUG9pbnRlciA6IGRlcC5kYXRhUG9pbnRlcgogICAgcmV0dXJuIHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBjb3JlLmJsb2NrKGRhdGEsIGluZGV4KSkKICB9CgogIGdldEJpdGZpZWxkUGFnZShpbmRleCkgewogICAgcmV0dXJuIHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBjb3JlLmJpdGZpZWxkKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgaW5kZXgsIDApKQogIH0KCiAgYXN5bmMgZ2V0VHJlZU5vZGUoaW5kZXgpIHsKICAgIGNvbnN0IGRlcCA9IGZpbmRUcmVlRGVwZW5kZW5jeSh0aGlzLmNvcmUuZGVwZW5kZW5jaWVzLCBpbmRleCkKICAgIGNvbnN0IGRhdGEgPSBkZXAgPT09IG51bGwgPyB0aGlzLmNvcmUuZGF0YVBvaW50ZXIgOiBkZXAuZGF0YVBvaW50ZXIKICAgIHJldHVybiBkZWNvZGUoQ09SRV9UUkVFX05PREUsIGF3YWl0IHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBjb3JlLnRyZWUoZGF0YSwgaW5kZXgpKSkKICB9CgogIGFzeW5jIGhhc1RyZWVOb2RlKGluZGV4KSB7CiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0VHJlZU5vZGUoaW5kZXgpKSAhPT0gbnVsbAogIH0KCiAgZ2V0VXNlckRhdGEoa2V5KSB7CiAgICByZXR1cm4gdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUudXNlckRhdGEodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBrZXkpKQogIH0KCiAgZ2V0TG9jYWwoa2V5KSB7CiAgICByZXR1cm4gdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUubG9jYWwodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBrZXkpKQogIH0KCiAgdHJ5Rmx1c2goKSB7CiAgICB0aGlzLnJlYWQudHJ5Rmx1c2goKQogICAgdGhpcy5fZnJlZSgpCiAgfQoKICBkZXN0cm95KCkgewogICAgdGhpcy5yZWFkLmRlc3Ryb3koKQogICAgdGhpcy5fZnJlZSgpCiAgfQoKICBfZnJlZSgpIHsKICAgIGlmICh0aGlzLnZpZXcgPT09IG51bGwpIHJldHVybgogICAgdGhpcy52aWV3LnJlYWRTdG9wKCkKICAgIHRoaXMudmlldyA9IG51bGwKICB9Cn0KCmNsYXNzIENvcmVzdG9yZVRYIHsKICBjb25zdHJ1Y3Rvcih2aWV3KSB7CiAgICB0aGlzLnZpZXcgPSB2aWV3CiAgICB0aGlzLmNoYW5nZXMgPSBbXQogIH0KCiAgc2V0SGVhZChoZWFkKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbc3RvcmUuaGVhZCgpLCBlbmNvZGUoQ09SRVNUT1JFX0hFQUQsIGhlYWQpLCBudWxsXSkKICB9CgogIHB1dENvcmUoZGlzY292ZXJ5S2V5LCBwdHIpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtzdG9yZS5jb3JlKGRpc2NvdmVyeUtleSksIGVuY29kZShDT1JFU1RPUkVfQ09SRSwgcHRyKSwgbnVsbF0pCiAgfQoKICBwdXRDb3JlQnlBbGlhcyhhbGlhcywgZGlzY292ZXJ5S2V5KSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbc3RvcmUuY29yZUJ5QWxpYXMoYWxpYXMpLCBkaXNjb3ZlcnlLZXksIG51bGxdKQogIH0KCiAgY2xlYXIoKSB7CiAgICBjb25zdCBbc3RhcnQsIGVuZF0gPSBzdG9yZS5jbGVhcigpCiAgICB0aGlzLmNoYW5nZXMucHVzaChbc3RhcnQsIG51bGwsIGVuZF0pCiAgfQoKICBhcHBseSgpIHsKICAgIGlmICh0aGlzLmNoYW5nZXMgPT09IG51bGwpIHJldHVybgogICAgdGhpcy52aWV3LmFwcGx5KHRoaXMuY2hhbmdlcykKICAgIHRoaXMuY2hhbmdlcyA9IG51bGwKICB9Cn0KCmNsYXNzIENvcmVzdG9yZVJYIHsKICBjb25zdHJ1Y3RvcihkYiwgdmlldykgewogICAgdGhpcy5yZWFkID0gZGIucmVhZCh7IGF1dG9EZXN0cm95OiB0cnVlIH0pCiAgICB0aGlzLnZpZXcgPSB2aWV3CgogICAgdmlldy5yZWFkU3RhcnQoKQogIH0KCiAgYXN5bmMgZ2V0SGVhZCgpIHsKICAgIHJldHVybiBkZWNvZGUoQ09SRVNUT1JFX0hFQUQsIGF3YWl0IHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBzdG9yZS5oZWFkKCkpKQogIH0KCiAgYXN5bmMgZ2V0Q29yZShkaXNjb3ZlcnlLZXkpIHsKICAgIHJldHVybiBkZWNvZGUoQ09SRVNUT1JFX0NPUkUsIGF3YWl0IHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBzdG9yZS5jb3JlKGRpc2NvdmVyeUtleSkpKQogIH0KCiAgZ2V0Q29yZUJ5QWxpYXMoYWxpYXMpIHsKICAgIHJldHVybiB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgc3RvcmUuY29yZUJ5QWxpYXMoYWxpYXMpKQogIH0KCiAgdHJ5Rmx1c2goKSB7CiAgICB0aGlzLnJlYWQudHJ5Rmx1c2goKQogICAgdGhpcy5fZnJlZSgpCiAgfQoKICBkZXN0cm95KCkgewogICAgdGhpcy5yZWFkLmRlc3Ryb3koKQogICAgdGhpcy5fZnJlZSgpCiAgfQoKICBfZnJlZSgpIHsKICAgIGlmICh0aGlzLnZpZXcgPT09IG51bGwpIHJldHVybgogICAgdGhpcy52aWV3LnJlYWRTdG9wKCkKICAgIHRoaXMudmlldyA9IG51bGwKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0geyBDb3Jlc3RvcmVUWCwgQ29yZXN0b3JlUlgsIENvcmVUWCwgQ29yZVJYIH0KCmZ1bmN0aW9uIGZpbmRCbG9ja0RlcGVuZGVuY3koZGVwZW5kZW5jaWVzLCBpbmRleCkgewogIGZvciAobGV0IGkgPSAwOyBpIDwgZGVwZW5kZW5jaWVzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBkZXAgPSBkZXBlbmRlbmNpZXNbaV0KICAgIGlmIChpbmRleCA8IGRlcC5sZW5ndGgpIHJldHVybiBkZXAKICB9CgogIHJldHVybiBudWxsCn0KCmZ1bmN0aW9uIGZpbmRUcmVlRGVwZW5kZW5jeShkZXBlbmRlbmNpZXMsIGluZGV4KSB7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZXBlbmRlbmNpZXMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IGRlcCA9IGRlcGVuZGVuY2llc1tpXQogICAgaWYgKGZsYXQucmlnaHRTcGFuKGluZGV4KSA8PSAoZGVwLmxlbmd0aCAtIDEpICogMikgcmV0dXJuIGRlcAogIH0KCiAgcmV0dXJuIG51bGwKfQoKZnVuY3Rpb24gZGVjb2RlKGVuYywgYnVmZmVyKSB7CiAgaWYgKGJ1ZmZlciA9PT0gbnVsbCkgcmV0dXJuIG51bGwKICByZXR1cm4gZW5jLmRlY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoLCBidWZmZXIgfSkKfQoKZnVuY3Rpb24gZW5jb2RlKGVuYywgbSkgewogIC8vIFRPRE86IHVzZSBmYW5jeSBzbGFiIGZvciBzbWFsbCBtZXNzYWdlcwogIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiAwLCBidWZmZXI6IG51bGwgfQogIGVuYy5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHN0YXRlLmVuZCkKICBlbmMuZW5jb2RlKHN0YXRlLCBtKQogIHJldHVybiBzdGF0ZS5idWZmZXIKfQpjb25zdCB7IFJlYWRhYmxlLCBnZXRTdHJlYW1FcnJvciB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IENsb3NlRXJyb3JTdHJlYW0gPSByZXF1aXJlKCcuL2Nsb3NlLWVycm9yLXN0cmVhbS5qcycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjbGFzcyBPdmVybGF5U3RyZWFtIGV4dGVuZHMgUmVhZGFibGUgewogIGNvbnN0cnVjdG9yKHN0cmVhbSwgc3RhcnQsIGVuZCwgcmV2ZXJzZSwgY2hhbmdlcywgY2xlYXJlZCkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuc3RhcnQgPSBzdGFydAogICAgdGhpcy5lbmQgPSBlbmQKICAgIHRoaXMucmV2ZXJzZSA9IHJldmVyc2UKICAgIHRoaXMuY2hhbmdlcyA9IGNoYW5nZXMKICAgIHRoaXMuY2xlYXJlZCA9IGNsZWFyZWQKICAgIHRoaXMuY2hhbmdlID0gMAogICAgdGhpcy5yYW5nZSA9IDAKCiAgICB0aGlzLl9zdHJlYW0gPSBzdHJlYW0KICAgIHRoaXMuX2RyYWluZWQgPSBmYWxzZQoKICAgIHRoaXMuX3N0cmVhbS5vbigncmVhZGFibGUnLCB0aGlzLl9kcmFpbk1heWJlLmJpbmQodGhpcykpCiAgICB0aGlzLl9zdHJlYW0ub24oJ2Vycm9yJywgbm9vcCkKICAgIHRoaXMuX3N0cmVhbS5vbignY2xvc2UnLCB0aGlzLl9vbmNsb3NlLmJpbmQodGhpcykpCiAgfQoKICBfZHJhaW5NYXliZSgpIHsKICAgIGlmICh0aGlzLl9kcmFpbmVkID09PSB0cnVlKSByZXR1cm4KICAgIHRoaXMuX2RyYWluZWQgPSB0aGlzLl9vbnJlYWRhYmxlKCkKICB9CgogIF9vbmNsb3NlKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWluZykgcmV0dXJuCgogICAgY29uc3QgZXJyID0gZ2V0U3RyZWFtRXJyb3IodGhpcy5fc3RyZWFtKQoKICAgIGlmIChlcnIgIT09IG51bGwpIHsKICAgICAgdGhpcy5kZXN0cm95KGVycikKICAgICAgcmV0dXJuCiAgICB9CgogICAgd2hpbGUgKHRoaXMuY2hhbmdlIDwgdGhpcy5jaGFuZ2VzLmxlbmd0aCkgewogICAgICBjb25zdCBjID0gdGhpcy5jaGFuZ2VzW3RoaXMuY2hhbmdlKytdCiAgICAgIGNvbnN0IGtleSA9IGNbMF0KICAgICAgY29uc3QgdmFsdWUgPSBjWzFdCgogICAgICBpZiAodmFsdWUgIT09IG51bGwgJiYgdGhpcy5faW5SYW5nZShrZXkpKSB0aGlzLnB1c2goeyBrZXksIHZhbHVlIH0pCiAgICB9CgogICAgdGhpcy5wdXNoKG51bGwpCiAgICB0aGlzLl9zdHJlYW0gPSBudWxsCiAgfQoKICBfb25yZWFkYWJsZSgpIHsKICAgIGxldCBkYXRhID0gdGhpcy5fc3RyZWFtLnJlYWQoKQogICAgaWYgKGRhdGEgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIGxldCBkcmFpbmVkID0gZmFsc2UKCiAgICBkbyB7CiAgICAgIGlmICh0aGlzLl9wdXNoKGRhdGEpID09PSB0cnVlKSBkcmFpbmVkID0gdHJ1ZQogICAgICBkYXRhID0gdGhpcy5fc3RyZWFtLnJlYWQoKQogICAgfSB3aGlsZSAoZGF0YSAhPT0gbnVsbCkKCiAgICByZXR1cm4gZHJhaW5lZAogIH0KCiAgX3JlYWQoY2IpIHsKICAgIHRoaXMuX2RyYWluZWQgPSB0aGlzLl9vbnJlYWRhYmxlKCkKICAgIGNiKG51bGwpCiAgfQoKICBfcHJlZGVzdHJveSgpIHsKICAgIHRoaXMuc3RyZWFtLmRlc3Ryb3koKQogIH0KCiAgX3B1c2goZW50cnkpIHsKICAgIGNvbnN0IGtleSA9IGVudHJ5LmtleQoKICAgIHdoaWxlICh0aGlzLnJhbmdlIDwgdGhpcy5jbGVhcmVkLmxlbmd0aCkgewogICAgICBjb25zdCBjID0gdGhpcy5jbGVhcmVkW3RoaXMucmFuZ2VdCgogICAgICAvLyB3ZSBtb3ZlZCBwYXN0IHRoZSByYW5nZQogICAgICBpZiAodGhpcy5yZXZlcnNlID8gYjRhLmNvbXBhcmUoa2V5LCBjWzBdKSA8IDAgOiBiNGEuY29tcGFyZShjWzJdLCBrZXkpIDw9IDApIHsKICAgICAgICB0aGlzLnJhbmdlKysKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICAvLyB3ZSBkaWRudCBtb3ZlIHBhc3QgYW5kIGFyZSBpbiwgZHJvcAogICAgICBpZiAoYjRhLmNvbXBhcmUoY1swXSwga2V5KSA8PSAwICYmIGI0YS5jb21wYXJlKGtleSwgY1syXSkgPCAwKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgIH0KCiAgICAgIGJyZWFrCiAgICB9CgogICAgbGV0IHVwZGF0ZWQgPSBmYWxzZQoKICAgIHdoaWxlICh0aGlzLmNoYW5nZSA8IHRoaXMuY2hhbmdlcy5sZW5ndGgpIHsKICAgICAgY29uc3QgYyA9IHRoaXMuY2hhbmdlc1t0aGlzLmNoYW5nZV0KICAgICAgY29uc3Qga2V5ID0gY1swXQogICAgICBjb25zdCB2YWx1ZSA9IHR5cGVvZiBjWzFdID09PSAnc3RyaW5nJyA/IGI0YS5mcm9tKGNbMV0pIDogY1sxXQogICAgICBjb25zdCBjbXAgPSBiNGEuY29tcGFyZShrZXksIGVudHJ5LmtleSkKCiAgICAgIC8vIHNhbWUgdmFsdWUsIGlmIG5vdCBkZWxldGVkLCByZXR1cm4gbmV3IG9uZQogICAgICBpZiAoY21wID09PSAwKSB7CiAgICAgICAgdGhpcy5jaGFuZ2UrKwogICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB0aGlzLl9pblJhbmdlKGtleSkgPT09IGZhbHNlKSByZXR1cm4gdXBkYXRlZAogICAgICAgIHRoaXMucHVzaCh7IGtleSwgdmFsdWUgfSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CgogICAgICAvLyB3ZSBtb3ZlZCBwYXN0IHRoZSBjaGFuZ2UsIHB1c2ggaXQKICAgICAgaWYgKHRoaXMucmV2ZXJzZSA/IGNtcCA+IDAgOiBjbXAgPCAwKSB7CiAgICAgICAgdGhpcy5jaGFuZ2UrKwogICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB0aGlzLl9pblJhbmdlKGtleSkgPT09IGZhbHNlKSBjb250aW51ZQogICAgICAgIHRoaXMucHVzaCh7IGtleSwgdmFsdWUgfSkKICAgICAgICB1cGRhdGVkID0gdHJ1ZQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIHRoaXMucHVzaChlbnRyeSkKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICB0aGlzLnB1c2goZW50cnkpCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX2luUmFuZ2Uoa2V5KSB7CiAgICByZXR1cm4gYjRhLmNvbXBhcmUodGhpcy5zdGFydCwga2V5KSA8PSAwICYmIGI0YS5jb21wYXJlKGtleSwgdGhpcy5lbmQpIDwgMAogIH0KfQoKY2xhc3MgT3ZlcmxheSB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLmluZGV4ZWQgPSAwCiAgICB0aGlzLmNoYW5nZXMgPSBudWxsCiAgICB0aGlzLmNsZWFyZWQgPSBudWxsCiAgICB0aGlzLnJldmVyc2UgPSBmYWxzZQogIH0KCiAgdXBkYXRlKHZpZXcsIHJldmVyc2UpIHsKICAgIGlmICh2aWV3LmluZGV4ZWQgPT09IHRoaXMuaW5kZXhlZCkgcmV0dXJuCgogICAgY29uc3QgY2hhbmdlcyA9IHZpZXcubWFwID09PSBudWxsID8gW10gOiBbLi4udmlldy5tYXAudmFsdWVzKCldCiAgICBjb25zdCBjbGVhcmVkID0gdmlldy5jbGVhcmVkID09PSBudWxsID8gW10gOiB2aWV3LmNsZWFyZWQuc2xpY2UoMCkKCiAgICBjb25zdCBjbXAgPSByZXZlcnNlID8gY21wQ2hhbmdlUmV2ZXJzZSA6IGNtcENoYW5nZQoKICAgIGNoYW5nZXMuc29ydChjbXApCiAgICBjbGVhcmVkLnNvcnQoY21wKQoKICAgIHRoaXMuaW5kZXhlZCA9IHZpZXcuaW5kZXhlZAogICAgdGhpcy5jaGFuZ2VzID0gY2hhbmdlcwogICAgdGhpcy5jbGVhcmVkID0gY2xlYXJlZAogICAgdGhpcy5yZXZlcnNlID0gcmV2ZXJzZQogIH0KCiAgY3JlYXRlU3RyZWFtKHN0cmVhbSwgc3RhcnQsIGVuZCwgcmV2ZXJzZSkgewogICAgcmV0dXJuIG5ldyBPdmVybGF5U3RyZWFtKAogICAgICBzdHJlYW0sCiAgICAgIHN0YXJ0LAogICAgICBlbmQsCiAgICAgIHJldmVyc2UsCiAgICAgIHRoaXMucmV2ZXJzZSA9PT0gcmV2ZXJzZSA/IHRoaXMuY2hhbmdlcyA6IHJldmVyc2VBcnJheSh0aGlzLmNoYW5nZXMpLAogICAgICB0aGlzLnJldmVyc2UgPT09IHJldmVyc2UgPyB0aGlzLmNsZWFyZWQgOiByZXZlcnNlQXJyYXkodGhpcy5jbGVhcmVkKQogICAgKQogIH0KfQoKY2xhc3MgVmlldyB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLm1hcCA9IG51bGwKICAgIHRoaXMuaW5kZXhlZCA9IDAKICAgIHRoaXMuY2hhbmdlcyA9IG51bGwKICAgIHRoaXMuY2xlYXJlZCA9IG51bGwKICAgIHRoaXMub3ZlcmxheSA9IG51bGwKICAgIHRoaXMuc25hcCA9IG51bGwKICAgIHRoaXMucmVhZGVycyA9IDAKICB9CgogIHNuYXBzaG90KCkgewogICAgaWYgKHRoaXMuX2F0dGFjaGVkKCkpIHJldHVybiB0aGlzLnNuYXAuc25hcHNob3QoKQoKICAgIGNvbnN0IHNuYXAgPSBuZXcgVmlldygpCgogICAgc25hcC5tYXAgPSB0aGlzLm1hcAogICAgc25hcC5pbmRleGVkID0gdGhpcy5pbmRleGVkCiAgICBzbmFwLmNoYW5nZXMgPSB0aGlzLmNoYW5nZXMKICAgIHNuYXAuY2xlYXJlZCA9IHRoaXMuY2xlYXJlZAoKICAgIGlmICh0aGlzLl9mcm96ZW4oKSkgcmV0dXJuIHNuYXAKCiAgICB0aGlzLnJlYWRlcnMrKwogICAgc25hcC5zbmFwID0gdGhpcwoKICAgIHJldHVybiBzbmFwCiAgfQoKICByZWFkU3RhcnQoKSB7CiAgICBpZiAodGhpcy5zbmFwICE9PSBudWxsKSB0aGlzLnJlYWRlcnMrKwogIH0KCiAgcmVhZFN0b3AoKSB7CiAgICBpZiAodGhpcy5zbmFwICE9PSBudWxsICYmIC0tdGhpcy5yZWFkZXJzID09PSAwKSB0aGlzLnNuYXAucmVhZGVycy0tCiAgfQoKICBzaXplKCkgewogICAgcmV0dXJuIHRoaXMuY2hhbmdlcyA9PT0gbnVsbCA/IDAgOiB0aGlzLmNoYW5nZXMubGVuZ3RoCiAgfQoKICB1cGRhdGVkKCkgewogICAgcmV0dXJuIHRoaXMuY2hhbmdlcyA9PT0gbnVsbAogIH0KCiAgZ2V0KHJlYWQsIGtleSkgewogICAgcmV0dXJuIHRoaXMuY2hhbmdlcyA9PT0gbnVsbCA/IHJlYWQuZ2V0KGtleSkgOiB0aGlzLl9pbmRleEFuZEdldChyZWFkLCBrZXkpCiAgfQoKICByZXNldCgpIHsKICAgIHRoaXMuaW5kZXhlZCA9IDAKICAgIHRoaXMuc25hcCA9IHRoaXMubWFwID0gdGhpcy5jaGFuZ2VzID0gdGhpcy5jbGVhcmVkID0gdGhpcy5vdmVybGF5ID0gbnVsbAogIH0KCiAgaXRlcmF0b3IoZGIsIHN0YXJ0LCBlbmQsIHJldmVyc2UpIHsKICAgIGlmIChkYkNsb3NpbmcoZGIpKSByZXR1cm4gbmV3IENsb3NlRXJyb3JTdHJlYW0obmV3IEVycm9yKCdSb2Nrc0RCIHNlc3Npb24gaXMgY2xvc2VkJykpCgogICAgY29uc3Qgc3RyZWFtID0gZGIuaXRlcmF0b3IoeyBndGU6IHN0YXJ0LCBsdDogZW5kLCByZXZlcnNlIH0pCiAgICBpZiAodGhpcy5jaGFuZ2VzID09PSBudWxsKSByZXR1cm4gc3RyZWFtCgogICAgdGhpcy5faW5kZXgoKQoKICAgIGlmICh0aGlzLm92ZXJsYXkgPT09IG51bGwpIHRoaXMub3ZlcmxheSA9IG5ldyBPdmVybGF5KCkKICAgIHRoaXMub3ZlcmxheS51cGRhdGUodGhpcywgcmV2ZXJzZSkKICAgIHJldHVybiB0aGlzLm92ZXJsYXkuY3JlYXRlU3RyZWFtKHN0cmVhbSwgc3RhcnQsIGVuZCwgcmV2ZXJzZSkKICB9CgogIF9pbmRleEFuZEdldChyZWFkLCBrZXkpIHsKICAgIHRoaXMuX2luZGV4KCkKICAgIGNvbnN0IGNoYW5nZSA9IHRoaXMubWFwLmdldChiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykpCgogICAgaWYgKGNoYW5nZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiB0aGlzLmNsZWFyZWQgPT09IG51bGwgPyByZWFkLmdldChrZXkpIDogdGhpcy5fcmVhZEFuZE1heWJlRHJvcChyZWFkLCBrZXkpCiAgICB9CgogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShjaGFuZ2VbMV0pCiAgfQoKICBhc3luYyBfcmVhZEFuZE1heWJlRHJvcChyZWFkLCBrZXkpIHsKICAgIGNvbnN0IGNsZWFyZWQgPSB0aGlzLmNsZWFyZWQgLy8gaW4gY2FzZSBpdHMgY2xlYXJlZAogICAgY29uc3QgdmFsdWUgPSBhd2FpdCByZWFkLmdldChrZXkpCiAgICBpZiAodmFsdWUgPT09IG51bGwpIHJldHVybiBudWxsCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjbGVhcmVkLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGMgPSBjbGVhcmVkW2ldCiAgICAgIC8vIGNoZWNrIGlmIGluIHJhbmdlCiAgICAgIGlmIChiNGEuY29tcGFyZShjWzBdLCBrZXkpIDw9IDAgJiYgYjRhLmNvbXBhcmUoa2V5LCBjWzJdKSA8IDApIHJldHVybiBudWxsCiAgICB9CgogICAgcmV0dXJuIHZhbHVlCiAgfQoKICBfYXR0YWNoZWQoKSB7CiAgICByZXR1cm4gdGhpcy5zbmFwICE9PSBudWxsICYmIHRoaXMuY2hhbmdlcyA9PT0gdGhpcy5zbmFwLmNoYW5nZXMKICB9CgogIF9mcm96ZW4oKSB7CiAgICByZXR1cm4gdGhpcy5jaGFuZ2VzID09PSBudWxsIHx8ICh0aGlzLnNuYXAgIT09IG51bGwgJiYgdGhpcy5jaGFuZ2VzICE9PSB0aGlzLnNuYXAuY2hhbmdlcykKICB9CgogIF9pbmRleCgpIHsKICAgIC8vIGlmIHdlIGFyZSBhIHNuYXAgYW5kIHdlIGFyZSBzdGlsbCBhdHRhY2hlZCAoaWUgbm8gbXV0YXRpb25zKSwgc2ltcGx5IGNvcHkgdGhlIHJlZnMKICAgIGlmICh0aGlzLl9hdHRhY2hlZCgpKSB7CiAgICAgIHRoaXMuc25hcC5faW5kZXgoKQogICAgICB0aGlzLm1hcCA9IHRoaXMuc25hcC5tYXAKICAgICAgdGhpcy5jbGVhcmVkID0gdGhpcy5zbmFwLmNsZWFyZWQKICAgICAgdGhpcy5pbmRleGVkID0gdGhpcy5zbmFwLmluZGV4ZWQKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMubWFwID09PSBudWxsKSB0aGlzLm1hcCA9IG5ldyBNYXAoKQogICAgaWYgKHRoaXMuY2hhbmdlcy5sZW5ndGggPT09IHRoaXMuaW5kZXhlZCkgcmV0dXJuCgogICAgd2hpbGUgKHRoaXMuaW5kZXhlZCA8IHRoaXMuY2hhbmdlcy5sZW5ndGgpIHsKICAgICAgY29uc3QgYyA9IHRoaXMuY2hhbmdlc1t0aGlzLmluZGV4ZWQrK10KCiAgICAgIGlmIChjWzJdID09PSBudWxsKSB0aGlzLm1hcC5zZXQoYjRhLnRvU3RyaW5nKGNbMF0sICdoZXgnKSwgYykKICAgICAgZWxzZSB0aGlzLl9pbmRleFJhbmdlKGMpCiAgICB9CiAgfQoKICBfaW5kZXhSYW5nZShyYW5nZSkgewogICAgY29uc3QgcyA9IGI0YS50b1N0cmluZyhyYW5nZVswXSwgJ2hleCcpCiAgICBjb25zdCBlID0gYjRhLnRvU3RyaW5nKHJhbmdlWzJdLCAnaGV4JykKCiAgICBmb3IgKGNvbnN0IFtrZXksIGNdIG9mIHRoaXMubWFwKSB7CiAgICAgIGlmIChzIDw9IGtleSAmJiBrZXkgPCBlKSB0aGlzLm1hcC5zZXQoa2V5LCBbY1swXSwgbnVsbCwgbnVsbF0pCiAgICB9CgogICAgaWYgKHRoaXMuY2xlYXJlZCA9PT0gbnVsbCkgdGhpcy5jbGVhcmVkID0gW10KICAgIHRoaXMuY2xlYXJlZC5wdXNoKHJhbmdlKQogIH0KCiAgYXBwbHkoY2hhbmdlcykgewogICAgaWYgKHRoaXMuc25hcCAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdJbGxlZ2FsIHRvIHB1c2ggY2hhbmdlcyB0byBhIHNuYXBzaG90JykKCiAgICBpZiAodGhpcy5yZWFkZXJzICE9PSAwICYmIHRoaXMuY2hhbmdlcyAhPT0gbnVsbCkgewogICAgICB0aGlzLmNoYW5nZXMgPSB0aGlzLmNoYW5nZXMuc2xpY2UoMCkKICAgICAgdGhpcy5jbGVhcmVkID0gdGhpcy5jbGVhcmVkID09PSBudWxsID8gbnVsbCA6IHRoaXMuY2xlYXJlZC5zbGljZSgwKQogICAgICB0aGlzLm1hcCA9IHRoaXMubWFwID09PSBudWxsID8gbnVsbCA6IG5ldyBNYXAoWy4uLnRoaXMubWFwXSkKICAgIH0KCiAgICBpZiAodGhpcy5jaGFuZ2VzID09PSBudWxsKSB7CiAgICAgIHRoaXMuY2hhbmdlcyA9IGNoYW5nZXMKICAgICAgcmV0dXJuCiAgICB9CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHRoaXMuY2hhbmdlcy5wdXNoKGNoYW5nZXNbaV0pCiAgICB9CiAgfQoKICBzdGF0aWMgYXN5bmMgZmx1c2goY2hhbmdlcywgZGIpIHsKICAgIGlmIChjaGFuZ2VzID09PSBudWxsKSByZXR1cm4gdHJ1ZQoKICAgIGNvbnN0IHcgPSBkYi53cml0ZSh7IGF1dG9EZXN0cm95OiB0cnVlIH0pCgogICAgZm9yIChjb25zdCBbc3RhcnQsIHZhbHVlLCBlbmRdIG9mIGNoYW5nZXMpIHsKICAgICAgaWYgKGVuZCAhPT0gbnVsbCkgdy50cnlEZWxldGVSYW5nZShzdGFydCwgZW5kKQogICAgICBlbHNlIGlmICh2YWx1ZSAhPT0gbnVsbCkgdy50cnlQdXQoc3RhcnQsIHZhbHVlKQogICAgICBlbHNlIHcudHJ5RGVsZXRlKHN0YXJ0KQogICAgfQoKICAgIGF3YWl0IHcuZmx1c2goKQoKICAgIHJldHVybiB0cnVlCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IFZpZXcKCmZ1bmN0aW9uIGNtcENoYW5nZShhLCBiKSB7CiAgY29uc3QgYyA9IGI0YS5jb21wYXJlKGFbMF0sIGJbMF0pCiAgcmV0dXJuIGMgPT09IDAgPyBiNGEuY29tcGFyZShhWzJdLCBiWzJdKSA6IGMKfQoKZnVuY3Rpb24gY21wQ2hhbmdlUmV2ZXJzZShhLCBiKSB7CiAgcmV0dXJuIGNtcENoYW5nZShiLCBhKQp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIHJldmVyc2VBcnJheShsaXN0KSB7CiAgY29uc3QgciA9IG5ldyBBcnJheShsaXN0Lmxlbmd0aCkKICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHJbci5sZW5ndGggLSAxIC0gaV0gPSBsaXN0W2ldCiAgcmV0dXJuIHIKfQoKLy8gVE9ETzogZXhwb3NlIGZyb20gcm9ja3MgaW5zdGVhZApmdW5jdGlvbiBkYkNsb3NpbmcoZGIpIHsKICByZXR1cm4gZGIuX3N0YXRlLmNsb3NpbmcgfHwgZGIuX2luZGV4ID09PSAtMQp9CmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKQpjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpCmNvbnN0IHsgUmVhZGFibGUgfSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBmbGF0ID0gcmVxdWlyZSgnZmxhdC10cmVlJykKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgbSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMuanMnKQpjb25zdCBWaWV3ID0gcmVxdWlyZSgnLi4vLi4vbGliL3ZpZXcuanMnKQpjb25zdCB7IENvcmVzdG9yZVRYLCBDb3JlVFgsIENvcmVzdG9yZVJYIH0gPSByZXF1aXJlKCcuLi8uLi9saWIvdHguanMnKQoKY29uc3QgRU1QVFlfTk9ERSA9IGI0YS5hbGxvYyg0MCkKY29uc3QgRU1QVFlfUEFHRSA9IGI0YS5hbGxvYyg0MDk2KQoKbGV0IFRSRUVfMDFfU0tJUCA9IG51bGwKbGV0IFRSRUVfMDRfU0tJUCA9IG51bGwKbGV0IFRSRUVfMTZfU0tJUCA9IG51bGwKCmNsYXNzIENvcmVMaXN0U3RyZWFtIGV4dGVuZHMgUmVhZGFibGUgewogIGNvbnN0cnVjdG9yIChzdG9yYWdlKSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5zdG9yYWdlID0gc3RvcmFnZQogICAgdGhpcy5zdGFjayA9IFtdCiAgfQoKICBhc3luYyBfb3BlbiAoY2IpIHsKICAgIGZvciAoY29uc3QgYSBvZiBhd2FpdCByZWFkZGlyKHBhdGguam9pbih0aGlzLnN0b3JhZ2UsICdjb3JlcycpKSkgewogICAgICBmb3IgKGNvbnN0IGIgb2YgYXdhaXQgcmVhZGRpcihwYXRoLmpvaW4odGhpcy5zdG9yYWdlLCAnY29yZXMnLCBhKSkpIHsKICAgICAgICBmb3IgKGNvbnN0IGRrZXkgb2YgYXdhaXQgcmVhZGRpcihwYXRoLmpvaW4odGhpcy5zdG9yYWdlLCAnY29yZXMnLCBhLCBiKSkpIHsKICAgICAgICAgIHRoaXMuc3RhY2sucHVzaChwYXRoLmpvaW4odGhpcy5zdG9yYWdlLCAnY29yZXMnLCBhLCBiLCBka2V5KSkKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBjYihudWxsKQogIH0KCiAgYXN5bmMgX3JlYWQgKGNiKSB7CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBjb25zdCBuZXh0ID0gdGhpcy5zdGFjay5wb3AoKQogICAgICBpZiAoIW5leHQpIHsKICAgICAgICB0aGlzLnB1c2gobnVsbCkKICAgICAgICBicmVhawogICAgICB9CgogICAgICBjb25zdCBvcGxvZyA9IHBhdGguam9pbihuZXh0LCAnb3Bsb2cnKQogICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZWFkT3Bsb2cob3Bsb2cpCiAgICAgIGlmICghcmVzdWx0KSBjb250aW51ZQoKICAgICAgdGhpcy5wdXNoKHJlc3VsdCkKICAgICAgYnJlYWsKICAgIH0KCiAgICBjYihudWxsKQogIH0KfQoKZnVuY3Rpb24gZGVjb2RlT3Bsb2dIZWFkZXIgKHN0YXRlKSB7CiAgYy51aW50MzIuZGVjb2RlKHN0YXRlKSAvLyBja3N1bSwgaWdub3JlIGZvciBub3cKCiAgY29uc3QgbCA9IGMudWludDMyLmRlY29kZShzdGF0ZSkKICBjb25zdCBsZW5ndGggPSBsID4+IDIKICBjb25zdCBoZWFkZXJCaXQgPSBsICYgMQogIGNvbnN0IHBhcnRpYWxCaXQgPSBsICYgMgoKICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCBsZW5ndGgpIHJldHVybiBudWxsCgogIGNvbnN0IGVuZCA9IHN0YXRlLnN0YXJ0ICsgbGVuZ3RoCiAgY29uc3QgcmVzdWx0ID0geyBoZWFkZXI6IGhlYWRlckJpdCwgcGFydGlhbDogcGFydGlhbEJpdCAhPT0gMCwgYnl0ZUxlbmd0aDogbGVuZ3RoICsgOCwgbWVzc2FnZTogbnVsbCB9CgogIHRyeSB7CiAgICByZXN1bHQubWVzc2FnZSA9IG0ub3Bsb2cuaGVhZGVyLmRlY29kZSh7IHN0YXJ0OiBzdGF0ZS5zdGFydCwgZW5kLCBidWZmZXI6IHN0YXRlLmJ1ZmZlciB9KQogIH0gY2F0Y2ggewogICAgcmV0dXJuIG51bGwKICB9CgogIHN0YXRlLnN0YXJ0ID0gZW5kCiAgcmV0dXJuIHJlc3VsdAp9CgpmdW5jdGlvbiBkZWNvZGVPcGxvZ0VudHJ5IChzdGF0ZSkgewogIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDgpIHJldHVybiBudWxsCgogIGMudWludDMyLmRlY29kZShzdGF0ZSkgLy8gY2tzdW0sIGlnbm9yZSBmb3Igbm93CgogIGNvbnN0IGwgPSBjLnVpbnQzMi5kZWNvZGUoc3RhdGUpCiAgY29uc3QgbGVuZ3RoID0gbCA+Pj4gMgogIGNvbnN0IGhlYWRlckJpdCA9IGwgJiAxCiAgY29uc3QgcGFydGlhbEJpdCA9IGwgJiAyCgogIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IGxlbmd0aCkgcmV0dXJuIG51bGwKCiAgY29uc3QgZW5kID0gc3RhdGUuc3RhcnQgKyBsZW5ndGgKCiAgY29uc3QgcmVzdWx0ID0geyBoZWFkZXI6IGhlYWRlckJpdCwgcGFydGlhbDogcGFydGlhbEJpdCAhPT0gMCwgYnl0ZUxlbmd0aDogbGVuZ3RoICsgOCwgbWVzc2FnZTogbnVsbCB9CgogIHRyeSB7CiAgICByZXN1bHQubWVzc2FnZSA9IG0ub3Bsb2cuZW50cnkuZGVjb2RlKHsgc3RhcnQ6IHN0YXRlLnN0YXJ0LCBlbmQsIGJ1ZmZlcjogc3RhdGUuYnVmZmVyIH0pCiAgfSBjYXRjaCB7CiAgICByZXR1cm4gbnVsbAogIH0KCiAgc3RhdGUuc3RhcnQgPSBlbmQKCiAgcmV0dXJuIHJlc3VsdAp9Cgptb2R1bGUuZXhwb3J0cyA9IHsgc3RvcmUsIGNvcmUgfQoKYXN5bmMgZnVuY3Rpb24gc3RvcmUgKHN0b3JhZ2UsIHsgdmVyc2lvbiwgZHJ5UnVuID0gdHJ1ZSwgZ2MgPSB0cnVlIH0pIHsKICBjb25zdCBzdHJlYW0gPSBuZXcgQ29yZUxpc3RTdHJlYW0oc3RvcmFnZS5wYXRoKQogIGNvbnN0IHZpZXcgPSBuZXcgVmlldygpCgogIGNvbnN0IHR4ID0gbmV3IENvcmVzdG9yZVRYKHZpZXcpCiAgY29uc3QgaGVhZCA9IGF3YWl0IHN0b3JhZ2UuX2dldEhlYWQodmlldykKICBjb25zdCBwcmltYXJ5S2V5RmlsZSA9IHBhdGguam9pbihzdG9yYWdlLnBhdGgsICdwcmltYXJ5LWtleScpCgogIGNvbnN0IHByaW1hcnlLZXkgPSBhd2FpdCByZWFkRmlsZShwcmltYXJ5S2V5RmlsZSkKCiAgaWYgKCFoZWFkLnNlZWQpIGhlYWQuc2VlZCA9IHByaW1hcnlLZXkKCiAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIHN0cmVhbSkgewogICAgY29uc3Qga2V5ID0gZGF0YS5oZWFkZXIua2V5CiAgICBjb25zdCBkaXNjb3ZlcnlLZXkgPSBjcnlwdG8uZGlzY292ZXJ5S2V5KGRhdGEuaGVhZGVyLmtleSkKICAgIGNvbnN0IGZpbGVzID0gZ2V0RmlsZXMoZGF0YS5wYXRoKQoKICAgIGlmIChoZWFkLmRlZmF1bHREaXNjb3ZlcnlLZXkgPT09IG51bGwpIGhlYWQuZGVmYXVsdERpc2NvdmVyeUtleSA9IGRpc2NvdmVyeUtleQoKICAgIGNvbnN0IGNvcmUgPSB7CiAgICAgIHZlcnNpb246IDAsIC8vIG5lZWQgbGF0ZXIgbWlncmF0aW9uCiAgICAgIGNvcmVQb2ludGVyOiBoZWFkLmFsbG9jYXRlZC5jb3JlcysrLAogICAgICBkYXRhUG9pbnRlcjogaGVhZC5hbGxvY2F0ZWQuZGF0YXMrKywKICAgICAgYWxpYXM6IG51bGwKICAgIH0KCiAgICBjb25zdCBwdHIgPSB7IHZlcnNpb246IDAsIGNvcmVQb2ludGVyOiBjb3JlLmNvcmVQb2ludGVyLCBkYXRhUG9pbnRlcjogY29yZS5kYXRhUG9pbnRlciwgZGVwZW5kZW5jaWVzOiBbXSB9CiAgICBjb25zdCBjdHggPSBuZXcgQ29yZVRYKHB0ciwgc3RvcmFnZS5kYiwgdmlldywgW10pCiAgICBjb25zdCB1c2VyRGF0YSA9IG5ldyBNYXAoKQogICAgY29uc3QgdHJlZU5vZGVzID0gbmV3IE1hcCgpCgogICAgY29uc3QgYXV0aCA9IHsKICAgICAga2V5LAogICAgICBkaXNjb3ZlcnlLZXksCiAgICAgIG1hbmlmZXN0OiBkYXRhLmhlYWRlci5tYW5pZmVzdCwKICAgICAga2V5UGFpcjogZGF0YS5oZWFkZXIua2V5UGFpciwKICAgICAgZW5jcnlwdGlvbktleTogbnVsbAogICAgfQoKICAgIGNvbnN0IHRyZWUgPSB7CiAgICAgIGxlbmd0aDogMCwKICAgICAgZm9yazogMCwKICAgICAgcm9vdEhhc2g6IG51bGwsCiAgICAgIHNpZ25hdHVyZTogbnVsbAogICAgfQoKICAgIGlmIChkYXRhLmhlYWRlci50cmVlICYmIGRhdGEuaGVhZGVyLnRyZWUubGVuZ3RoKSB7CiAgICAgIHRyZWUubGVuZ3RoID0gZGF0YS5oZWFkZXIudHJlZS5sZW5ndGgKICAgICAgdHJlZS5mb3JrID0gZGF0YS5oZWFkZXIudHJlZS5mb3JrCiAgICAgIHRyZWUucm9vdEhhc2ggPSBkYXRhLmhlYWRlci50cmVlLnJvb3RIYXNoCiAgICAgIHRyZWUuc2lnbmF0dXJlID0gZGF0YS5oZWFkZXIudHJlZS5zaWduYXR1cmUKICAgIH0KCiAgICBmb3IgKGNvbnN0IHsga2V5LCB2YWx1ZSB9IG9mIGRhdGEuaGVhZGVyLnVzZXJEYXRhKSB7CiAgICAgIHVzZXJEYXRhLnNldChrZXksIHZhbHVlKQogICAgfQoKICAgIGZvciAoY29uc3QgZSBvZiBkYXRhLmVudHJpZXMpIHsKICAgICAgaWYgKGUudXNlckRhdGEpIHVzZXJEYXRhLnNldChlLnVzZXJEYXRhLmtleSwgZS51c2VyRGF0YS52YWx1ZSkKCiAgICAgIGlmIChlLnRyZWVOb2RlcykgewogICAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiBlLnRyZWVOb2RlcykgewogICAgICAgICAgdHJlZU5vZGVzLnNldChub2RlLmluZGV4LCBub2RlKQogICAgICAgICAgY3R4LnB1dFRyZWVOb2RlKG5vZGUpCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoZS50cmVlVXBncmFkZSkgewogICAgICAgIGlmIChlLnRyZWVVcGdyYWRlLmFuY2VzdG9ycyAhPT0gdHJlZS5sZW5ndGgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5mbHVzaGVkIHRydW5jYXRpb25zIG5vdCBtaWdyYXRlLWFibGUgYXRtJykKICAgICAgICB9CgogICAgICAgIHRyZWUubGVuZ3RoID0gZS50cmVlVXBncmFkZS5sZW5ndGgKICAgICAgICB0cmVlLmZvcmsgPSBlLnRyZWVVcGdyYWRlLmZvcmsKICAgICAgICB0cmVlLnJvb3RIYXNoID0gbnVsbAogICAgICAgIHRyZWUuc2lnbmF0dXJlID0gZS50cmVlVXBncmFkZS5zaWduYXR1cmUKICAgICAgfQogICAgfQoKICAgIGlmICh1c2VyRGF0YS5oYXMoJ2NvcmVzdG9yZS9uYW1lJykgJiYgdXNlckRhdGEuaGFzKCdjb3Jlc3RvcmUvbmFtZXNwYWNlJykpIHsKICAgICAgY29yZS5hbGlhcyA9IHsKICAgICAgICBuYW1lOiBiNGEudG9TdHJpbmcodXNlckRhdGEuZ2V0KCdjb3Jlc3RvcmUvbmFtZScpKSwKICAgICAgICBuYW1lc3BhY2U6IHVzZXJEYXRhLmdldCgnY29yZXN0b3JlL25hbWVzcGFjZScpCiAgICAgIH0KICAgICAgdXNlckRhdGEuZGVsZXRlKCdjb3Jlc3RvcmUvbmFtZScpCiAgICAgIHVzZXJEYXRhLmRlbGV0ZSgnY29yZXN0b3JlL25hbWVzcGFjZScpCiAgICB9CgogICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgdXNlckRhdGEpIHsKICAgICAgY3R4LnB1dFVzZXJEYXRhKGtleSwgdmFsdWUpCiAgICB9CgogICAgY3R4LnNldEF1dGgoYXV0aCkKCiAgICBjb25zdCBnZXRUcmVlTm9kZSA9IChpbmRleCkgPT4gKHRyZWVOb2Rlcy5nZXQoaW5kZXgpIHx8IGdldFRyZWVOb2RlRnJvbUZpbGUoZmlsZXMudHJlZSwgaW5kZXgpKQoKICAgIGlmICh0cmVlLmxlbmd0aCkgewogICAgICBpZiAodHJlZS5yb290SGFzaCA9PT0gbnVsbCkgdHJlZS5yb290SGFzaCA9IGNyeXB0by50cmVlKGF3YWl0IGdldFJvb3RzKHRyZWUubGVuZ3RoLCBnZXRUcmVlTm9kZSkpCiAgICAgIGN0eC5zZXRIZWFkKHRyZWUpCiAgICB9CgogICAgdHgucHV0Q29yZShkaXNjb3ZlcnlLZXksIGNvcmUpCiAgICBpZiAoY29yZS5hbGlhcykgdHgucHV0Q29yZUJ5QWxpYXMoY29yZS5hbGlhcywgZGlzY292ZXJ5S2V5KQoKICAgIGF3YWl0IGN0eC5mbHVzaCgpCiAgfQoKICBoZWFkLnZlcnNpb24gPSB2ZXJzaW9uCiAgdHguc2V0SGVhZChoZWFkKQogIHR4LmFwcGx5KCkKCiAgaWYgKGRyeVJ1bikgcmV0dXJuCgogIGF3YWl0IFZpZXcuZmx1c2godmlldy5jaGFuZ2VzLCBzdG9yYWdlLmRiKQoKICBpZiAoZ2MpIGF3YWl0IHJtKHByaW1hcnlLZXlGaWxlKQp9CgpjbGFzcyBCbG9ja1NsaWNlciB7CiAgY29uc3RydWN0b3IgKGZpbGVuYW1lKSB7CiAgICB0aGlzLnN0cmVhbSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0oZmlsZW5hbWUpCiAgICB0aGlzLmNsb3NlZCA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gdGhpcy5zdHJlYW0ub25jZSgnY2xvc2UnLCByZXNvbHZlKSkKICAgIHRoaXMub2Zmc2V0ID0gMAogICAgdGhpcy5vdmVyZmxvdyA9IG51bGwKICB9CgogIGFzeW5jIHRha2UgKG9mZnNldCwgc2l6ZSkgewogICAgbGV0IGJ1ZmZlciA9IG51bGwKICAgIGlmIChvZmZzZXQgPCB0aGlzLm9mZnNldCkgdGhyb3cgbmV3IEVycm9yKCdvdmVycmVhZCcpCgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgbGV0IGRhdGEgPSBudWxsCgogICAgICBpZiAodGhpcy5vdmVyZmxvdykgewogICAgICAgIGRhdGEgPSB0aGlzLm92ZXJmbG93CiAgICAgICAgdGhpcy5vdmVyZmxvdyA9IG51bGwKICAgICAgfSBlbHNlIHsKICAgICAgICBkYXRhID0gdGhpcy5zdHJlYW0ucmVhZCgpCgogICAgICAgIGlmICghZGF0YSkgewogICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiB0aGlzLnN0cmVhbS5vbmNlKCdyZWFkYWJsZScsIHJlc29sdmUpKQogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGxldCBjaHVuayA9IG51bGwKCiAgICAgIGlmICh0aGlzLm9mZnNldCA9PT0gb2Zmc2V0IHx8IGJ1ZmZlcikgewogICAgICAgIGNodW5rID0gZGF0YQogICAgICB9IGVsc2UgaWYgKHRoaXMub2Zmc2V0ICsgZGF0YS5ieXRlTGVuZ3RoID4gb2Zmc2V0KSB7CiAgICAgICAgY2h1bmsgPSBkYXRhLnN1YmFycmF5KG9mZnNldCAtIHRoaXMub2Zmc2V0KQogICAgICB9CgogICAgICB0aGlzLm9mZnNldCArPSBkYXRhLmJ5dGVMZW5ndGgKICAgICAgaWYgKCFjaHVuaykgY29udGludWUKCiAgICAgIGlmIChidWZmZXIpIGJ1ZmZlciA9IGI0YS5jb25jYXQoW2J1ZmZlciwgY2h1bmtdKQogICAgICBlbHNlIGJ1ZmZlciA9IGNodW5rCgogICAgICBpZiAoYnVmZmVyLmJ5dGVMZW5ndGggPCBzaXplKSBjb250aW51ZQoKICAgICAgY29uc3QgcmVzdWx0ID0gYnVmZmVyLnN1YmFycmF5KDAsIHNpemUpCiAgICAgIHRoaXMub3ZlcmZsb3cgPSBzaXplID09PSBidWZmZXIuYnl0ZUxlbmd0aCA/IG51bGwgOiBidWZmZXIuc3ViYXJyYXkocmVzdWx0LmJ5dGVMZW5ndGgpCiAgICAgIHRoaXMub2Zmc2V0IC09ICh0aGlzLm92ZXJmbG93ID8gdGhpcy5vdmVyZmxvdy5ieXRlTGVuZ3RoIDogMCkKICAgICAgcmV0dXJuIHJlc3VsdAogICAgfQogIH0KCiAgY2xvc2UgKCkgewogICAgdGhpcy5zdHJlYW0ub24oJ2Vycm9yJywgbm9vcCkKICAgIHRoaXMuc3RyZWFtLmRlc3Ryb3koKQogICAgcmV0dXJuIHRoaXMuY2xvc2VkCiAgfQp9CgpjbGFzcyBUcmVlU2xpY2VyIHsKICBjb25zdHJ1Y3RvciAoKSB7CiAgICB0aGlzLmJ1ZmZlciA9IG51bGwKICAgIHRoaXMub2Zmc2V0ID0gMAogIH0KCiAgZ2V0IHNpemUgKCkgewogICAgcmV0dXJuIHRoaXMuYnVmZmVyID09PSBudWxsID8gMCA6IHRoaXMuYnVmZmVyLmJ5dGVMZW5ndGgKICB9CgogIHB1c2ggKGRhdGEpIHsKICAgIGlmICh0aGlzLmJ1ZmZlciA9PT0gbnVsbCkgdGhpcy5idWZmZXIgPSBkYXRhCiAgICBlbHNlIHRoaXMuYnVmZmVyID0gYjRhLmNvbmNhdChbdGhpcy5idWZmZXIsIGRhdGFdKQogICAgdGhpcy5vZmZzZXQgKz0gZGF0YS5ieXRlTGVuZ3RoCiAgfQoKICBza2lwICgpIHsKICAgIGxldCBza2lwcGVkID0gMAoKICAgIGlmIChUUkVFXzAxX1NLSVAgPT09IG51bGwpIHsKICAgICAgVFJFRV8xNl9TS0lQID0gYjRhLmFsbG9jKDE2ICogNDAgKiAxMDApCiAgICAgIFRSRUVfMDRfU0tJUCA9IFRSRUVfMTZfU0tJUC5zdWJhcnJheSgwLCA0ICogNDAgKiAxMDApCiAgICAgIFRSRUVfMDFfU0tJUCA9IFRSRUVfMTZfU0tJUC5zdWJhcnJheSgwLCAxICogNDAgKiAxMDApCiAgICB9CgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKHRoaXMuYnVmZmVyLmJ5dGVMZW5ndGggPj0gVFJFRV8xNl9TS0lQLmJ5dGVMZW5ndGgpIHsKICAgICAgICBpZiAoYjRhLmVxdWFscyh0aGlzLmJ1ZmZlci5zdWJhcnJheSgwLCBUUkVFXzE2X1NLSVAuYnl0ZUxlbmd0aCksIFRSRUVfMTZfU0tJUCkpIHsKICAgICAgICAgIHRoaXMuYnVmZmVyID0gdGhpcy5idWZmZXIuc3ViYXJyYXkoVFJFRV8xNl9TS0lQLmJ5dGVMZW5ndGgpCiAgICAgICAgICBza2lwcGVkICs9IDE2MDAKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5idWZmZXIuYnl0ZUxlbmd0aCA+PSBUUkVFXzA0X1NLSVAuYnl0ZUxlbmd0aCkgewogICAgICAgIGlmIChiNGEuZXF1YWxzKHRoaXMuYnVmZmVyLnN1YmFycmF5KDAsIFRSRUVfMDRfU0tJUC5ieXRlTGVuZ3RoKSwgVFJFRV8wNF9TS0lQKSkgewogICAgICAgICAgdGhpcy5idWZmZXIgPSB0aGlzLmJ1ZmZlci5zdWJhcnJheShUUkVFXzA0X1NLSVAuYnl0ZUxlbmd0aCkKICAgICAgICAgIHNraXBwZWQgKz0gNDAwCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMuYnVmZmVyLmJ5dGVMZW5ndGggPj0gVFJFRV8wMV9TS0lQLmJ5dGVMZW5ndGgpIHsKICAgICAgICBpZiAoYjRhLmVxdWFscyh0aGlzLmJ1ZmZlci5zdWJhcnJheSgwLCBUUkVFXzAxX1NLSVAuYnl0ZUxlbmd0aCksIFRSRUVfMDFfU0tJUCkpIHsKICAgICAgICAgIHRoaXMuYnVmZmVyID0gdGhpcy5idWZmZXIuc3ViYXJyYXkoVFJFRV8wMV9TS0lQLmJ5dGVMZW5ndGgpCiAgICAgICAgICBza2lwcGVkICs9IDEwMAogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgIH0KICAgICAgYnJlYWsKICAgIH0KCiAgICByZXR1cm4gc2tpcHBlZAogIH0KCiAgdGFrZSAoKSB7CiAgICBjb25zdCBsZW4gPSA0MAoKICAgIGlmIChsZW4gPD0gdGhpcy5zaXplKSB7CiAgICAgIGNvbnN0IGNodW5rID0gdGhpcy5idWZmZXIuc3ViYXJyYXkoMCwgbGVuKQogICAgICB0aGlzLmJ1ZmZlciA9IHRoaXMuYnVmZmVyLnN1YmFycmF5KGxlbikKICAgICAgcmV0dXJuIGNodW5rCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGNvcmUgKGNvcmUsIHsgdmVyc2lvbiwgZHJ5UnVuID0gdHJ1ZSwgZ2MgPSB0cnVlIH0pIHsKICBpZiAoZHJ5UnVuKSByZXR1cm4gLy8gZHJ5UnVuIG1vZGUgbm90IHN1cHBvcnRlZCBhdG0KCiAgY29uc3QgcnggPSBjb3JlLnJlYWQoKQoKICBjb25zdCBwcm9taXNlcyA9IFtyeC5nZXRBdXRoKCksIHJ4LmdldEhlYWQoKV0KICByeC50cnlGbHVzaCgpCgogIGNvbnN0IFthdXRoLCBoZWFkXSA9IGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKQoKICBpZiAoIWF1dGgpIHJldHVybgoKICBjb25zdCBkayA9IGI0YS50b1N0cmluZyhhdXRoLmRpc2NvdmVyeUtleSwgJ2hleCcpCiAgY29uc3QgZmlsZXMgPSBnZXRGaWxlcyhwYXRoLmpvaW4oY29yZS5zdG9yZS5wYXRoLCAnY29yZXMnLCBkay5zbGljZSgwLCAyKSwgZGsuc2xpY2UoMiwgNCksIGRrKSkKCiAgaWYgKGhlYWQgPT09IG51bGwgfHwgaGVhZC5sZW5ndGggPT09IDApIHsKICAgIGF3YWl0IGNvbW1pdENvcmVNaWdyYXRpb24oYXV0aCwgY29yZSwgdmVyc2lvbikKICAgIGlmIChnYykgYXdhaXQgcnVuR0MoKQogICAgcmV0dXJuIC8vIG5vIGRhdGEKICB9CgogIGNvbnN0IG9wbG9nID0gYXdhaXQgcmVhZE9wbG9nKGZpbGVzLm9wbG9nKQogIGlmICghb3Bsb2cpIHsKICAgIGNvbnN0IHdyaXRhYmxlID0gISFhdXRoLmtleVBhaXIKCiAgICBpZiAod3JpdGFibGUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBvcGxvZyBhdmFpbGFibGUgd3JpdGFibGUgY29yZSBmb3IgJyArIGZpbGVzLm9wbG9nICsgJywgbGVuZ3RoID0gJyArIChoZWFkID8gaGVhZC5sZW5ndGggOiAwKSkKICAgIH0KCiAgICAvLyBpZiBub3Qgd3JpdGFibGUsIGp1c3QgbnVrZSBpdCB0byByZWNvdmVyLCBzb21lIGJhZCBzdGF0ZSBoYXBwZW5lZCBoZXJlLCBwcm9wIGNvcnJ1cHRpb24gZnJvbSBlYXJsaWVyIHZlcnNpb25zCiAgICBjb25zdCB3ID0gY29yZS53cml0ZSgpCgogICAgdy5kZWxldGVCbG9ja1JhbmdlKDAsIC0xKQogICAgdy5kZWxldGVUcmVlTm9kZVJhbmdlKDAsIC0xKQogICAgdy5kZWxldGVCaXRmaWVsZFBhZ2VSYW5nZSgwLCAtMSkKICAgIHcuZGVsZXRlSGVhZCgpCgogICAgYXdhaXQgdy5mbHVzaCgpCgogICAgYXdhaXQgY29tbWl0Q29yZU1pZ3JhdGlvbihhdXRoLCBjb3JlLCB2ZXJzaW9uKQogICAgaWYgKGdjKSBhd2FpdCBydW5HQygpCiAgICByZXR1cm4gLy8gbm8gZGF0YQogIH0KCiAgY29uc3QgdHJlZURhdGEgPSBuZXcgVHJlZVNsaWNlcigpCgogIGxldCB0cmVlSW5kZXggPSAwCgogIGlmIChhd2FpdCBleGlzdHMoZmlsZXMudHJlZSkpIHsKICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiBmcy5jcmVhdGVSZWFkU3RyZWFtKGZpbGVzLnRyZWUpKSB7CiAgICAgIHRyZWVEYXRhLnB1c2goZGF0YSkKCiAgICAgIGxldCB3cml0ZSA9IG51bGwKCiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgY29uc3Qgc2tpcCA9IHRyZWVEYXRhLnNraXAoKQogICAgICAgIHRyZWVJbmRleCArPSBza2lwCgogICAgICAgIGNvbnN0IGJ1ZiA9IHRyZWVEYXRhLnRha2UoKQogICAgICAgIGlmIChidWYgPT09IG51bGwpIGJyZWFrCgogICAgICAgIGNvbnN0IGluZGV4ID0gdHJlZUluZGV4KysKICAgICAgICBpZiAoYjRhLmVxdWFscyhidWYsIEVNUFRZX05PREUpKSBjb250aW51ZQoKICAgICAgICBpZiAod3JpdGUgPT09IG51bGwpIHdyaXRlID0gY29yZS53cml0ZSgpCiAgICAgICAgd3JpdGUucHV0VHJlZU5vZGUoZGVjb2RlVHJlZU5vZGUoaW5kZXgsIGJ1ZikpCiAgICAgIH0KCiAgICAgIGlmICh3cml0ZSAhPT0gbnVsbCkgYXdhaXQgd3JpdGUuZmx1c2goKQogICAgfQogIH0KCiAgY29uc3QgYnVmID0gW10KICBpZiAoYXdhaXQgZXhpc3RzKGZpbGVzLmJpdGZpZWxkKSkgewogICAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIGZzLmNyZWF0ZVJlYWRTdHJlYW0oZmlsZXMuYml0ZmllbGQpKSB7CiAgICAgIGJ1Zi5wdXNoKGRhdGEpCiAgICB9CiAgfQoKICBsZXQgYml0ZmllbGQgPSBiNGEuY29uY2F0KGJ1ZikKICBpZiAoYml0ZmllbGQuYnl0ZUxlbmd0aCAmIDQwOTUpIGJpdGZpZWxkID0gYjRhLmNvbmNhdChbYml0ZmllbGQsIGI0YS5hbGxvYyg0MDk2IC0gKGJpdGZpZWxkLmJ5dGVMZW5ndGggJiA0MDk1KSldKQoKICBjb25zdCBwYWdlcyA9IG5ldyBNYXAoKQogIGNvbnN0IGhlYWRlckJpdHMgPSBuZXcgTWFwKCkKCiAgY29uc3Qgcm9vdHMgPSBhd2FpdCBnZXRSb290c0Zyb21TdG9yYWdlKGNvcmUsIGhlYWQubGVuZ3RoKQoKICBmb3IgKGNvbnN0IGUgb2Ygb3Bsb2cuZW50cmllcykgewogICAgaWYgKCFlLmJpdGZpZWxkKSBjb250aW51ZQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZS5iaXRmaWVsZC5sZW5ndGg7IGkrKykgewogICAgICBoZWFkZXJCaXRzLnNldChpICsgZS5iaXRmaWVsZC5zdGFydCwgIWUuYml0ZmllbGQuZHJvcCkKICAgIH0KICB9CgogIGxldCBiYXRjaCA9IFtdCgogIGNvbnN0IGNhY2hlID0gbmV3IE1hcCgpCiAgY29uc3QgYmxvY2tzID0gbmV3IEJsb2NrU2xpY2VyKGZpbGVzLmRhdGEpCgogIGZvciAoY29uc3QgaW5kZXggb2YgYWxsQml0cyhiaXRmaWVsZCkpIHsKICAgIGlmIChoZWFkZXJCaXRzLmdldChpbmRleCkgPT09IGZhbHNlKSBjb250aW51ZQogICAgaWYgKGluZGV4ID49IGhlYWQubGVuZ3RoKSBjb250aW51ZQoKICAgIHNldEJpdEluUGFnZShpbmRleCkKCiAgICBiYXRjaC5wdXNoKGluZGV4KQogICAgaWYgKGJhdGNoLmxlbmd0aCA8IDEwMjQpIGNvbnRpbnVlCgogICAgYXdhaXQgd3JpdGVCbG9ja3NCYXRjaCgpCiAgICBjb250aW51ZQogIH0KCiAgaWYgKGJhdGNoLmxlbmd0aCkgYXdhaXQgd3JpdGVCbG9ja3NCYXRjaCgpCgogIGF3YWl0IGJsb2Nrcy5jbG9zZSgpCgogIGNvbnN0IHcgPSBjb3JlLndyaXRlKCkKCiAgZm9yIChjb25zdCBbaW5kZXgsIGJpdF0gb2YgaGVhZGVyQml0cykgewogICAgaWYgKCFiaXQpIGNvbnRpbnVlCiAgICBpZiAoaW5kZXggPj0gaGVhZC5sZW5ndGgpIGNvbnRpbnVlCgogICAgc2V0Qml0SW5QYWdlKGluZGV4KQoKICAgIGNvbnN0IGJsayA9IGF3YWl0IGdldEJsb2NrRnJvbUZpbGUoZmlsZXMuZGF0YSwgY29yZSwgaW5kZXgsIHJvb3RzLCBjYWNoZSkKICAgIHcucHV0QmxvY2soaW5kZXgsIGJsaykKICB9CgogIGZvciAoY29uc3QgW2luZGV4LCBwYWdlXSBvZiBwYWdlcykgewogICAgdy5wdXRCaXRmaWVsZFBhZ2UoaW5kZXgsIGI0YS5mcm9tKHBhZ2UuYnVmZmVyLCBwYWdlLmJ5dGVPZmZzZXQsIHBhZ2UuYnl0ZUxlbmd0aCkpCiAgfQoKICBhd2FpdCB3LmZsdXNoKCkKCiAgbGV0IGNvbnRpZ3VvdXNMZW5ndGggPSAwCiAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIGNvcmUuY3JlYXRlQmxvY2tTdHJlYW0oKSkgewogICAgaWYgKGRhdGEuaW5kZXggPT09IGNvbnRpZ3VvdXNMZW5ndGgpIGNvbnRpZ3VvdXNMZW5ndGgrKwogICAgZWxzZSBicmVhawogIH0KCiAgaWYgKGNvbnRpZ3VvdXNMZW5ndGgpIHsKICAgIGNvbnN0IHcgPSBjb3JlLndyaXRlKCkKICAgIHcuc2V0SGludHMoeyBjb250aWd1b3VzTGVuZ3RoIH0pCiAgICBhd2FpdCB3LmZsdXNoKCkKICB9CgogIGF3YWl0IGNvbW1pdENvcmVNaWdyYXRpb24oYXV0aCwgY29yZSwgdmVyc2lvbikKCiAgaWYgKGdjKSBhd2FpdCBydW5HQygpCgogIGFzeW5jIGZ1bmN0aW9uIHJ1bkdDICgpIHsKICAgIGF3YWl0IHJtKGZpbGVzLnBhdGgpCiAgICBhd2FpdCBybWRpcihwYXRoLmpvaW4oZmlsZXMucGF0aCwgJy4uJykpCiAgICBhd2FpdCBybWRpcihwYXRoLmpvaW4oZmlsZXMucGF0aCwgJy4uLy4uJykpCiAgICBhd2FpdCBybWRpcihwYXRoLmpvaW4oY29yZS5zdG9yZS5wYXRoLCAnY29yZXMnKSkKICB9CgogIGZ1bmN0aW9uIHNldEJpdEluUGFnZSAoaW5kZXgpIHsKICAgIGNvbnN0IG4gPSBpbmRleCAmIDMyNzY3CiAgICBjb25zdCBwID0gKGluZGV4IC0gbikgLyAzMjc2OAoKICAgIGxldCBwYWdlID0gcGFnZXMuZ2V0KHApCgogICAgaWYgKCFwYWdlKSB7CiAgICAgIHBhZ2UgPSBuZXcgVWludDMyQXJyYXkoMTAyNCkKICAgICAgcGFnZXMuc2V0KHAsIHBhZ2UpCiAgICB9CgogICAgY29uc3QgbyA9IG4gJiAzMQogICAgY29uc3QgYiA9IChuIC0gbykgLyAzMgogICAgY29uc3QgdiA9IDEgPDwgbwoKICAgIHBhZ2VbYl0gfD0gdgogIH0KCiAgYXN5bmMgZnVuY3Rpb24gd3JpdGVCbG9ja3NCYXRjaCAoKSB7CiAgICBjb25zdCByZWFkID0gY29yZS5yZWFkKCkKICAgIGNvbnN0IHByb21pc2VzID0gW10KICAgIGZvciAoY29uc3QgaW5kZXggb2YgYmF0Y2gpIHByb21pc2VzLnB1c2goZ2V0Qnl0ZVJhbmdlRnJvbVN0b3JhZ2UocmVhZCwgMiAqIGluZGV4LCByb290cywgY2FjaGUpKQogICAgcmVhZC50cnlGbHVzaCgpCgogICAgY29uc3QgciA9IGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKQogICAgY29uc3QgdHggPSBjb3JlLndyaXRlKCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHIubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgaW5kZXggPSBiYXRjaFtpXQogICAgICBjb25zdCBbb2Zmc2V0LCBzaXplXSA9IHJbaV0KCiAgICAgIGNvbnN0IGJsayA9IGF3YWl0IGJsb2Nrcy50YWtlKG9mZnNldCwgc2l6ZSkKICAgICAgdHgucHV0QmxvY2soaW5kZXgsIGJsaykKICAgIH0KCiAgICBiYXRjaCA9IFtdCiAgICBpZiAoY2FjaGUuc2l6ZSA+IDE2Mzg0KSBjYWNoZS5jbGVhcigpCgogICAgYXdhaXQgdHguZmx1c2goKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gY29tbWl0Q29yZU1pZ3JhdGlvbiAoYXV0aCwgY29yZSwgdmVyc2lvbikgewogIGNvbnN0IHZpZXcgPSBuZXcgVmlldygpCiAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgoY29yZS5kYiwgdmlldykKCiAgY29uc3Qgc3RvcmVDb3JlUHJvbWlzZSA9IHJ4LmdldENvcmUoYXV0aC5kaXNjb3ZlcnlLZXkpCiAgcngudHJ5Rmx1c2goKQoKICBjb25zdCBzdG9yZUNvcmUgPSBhd2FpdCBzdG9yZUNvcmVQcm9taXNlCgogIHN0b3JlQ29yZS52ZXJzaW9uID0gdmVyc2lvbgoKICBjb25zdCB0eCA9IG5ldyBDb3Jlc3RvcmVUWCh2aWV3KQoKICB0eC5wdXRDb3JlKGF1dGguZGlzY292ZXJ5S2V5LCBzdG9yZUNvcmUpCiAgdHguYXBwbHkoKQoKICBhd2FpdCBWaWV3LmZsdXNoKHZpZXcuY2hhbmdlcywgY29yZS5kYikKfQoKYXN5bmMgZnVuY3Rpb24gZ2V0QmxvY2tGcm9tRmlsZSAoZmlsZSwgY29yZSwgaW5kZXgsIHJvb3RzLCBjYWNoZSkgewogIGNvbnN0IHJ4ID0gY29yZS5yZWFkKCkKICBjb25zdCBwcm9taXNlID0gZ2V0Qnl0ZVJhbmdlRnJvbVN0b3JhZ2UocngsIDIgKiBpbmRleCwgcm9vdHMsIGNhY2hlKQogIHJ4LnRyeUZsdXNoKCkKICBjb25zdCBbb2Zmc2V0LCBzaXplXSA9IGF3YWl0IHByb21pc2UKCiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICByZWFkQWxsKGZpbGUsIHNpemUsIG9mZnNldCwgZnVuY3Rpb24gKGVyciwgYnVmKSB7CiAgICAgIGlmIChlcnIpIHJldHVybiByZXNvbHZlKG51bGwpCiAgICAgIHJlc29sdmUoYnVmKQogICAgfSkKICB9KQp9CgpmdW5jdGlvbiBnZXRGaWxlcyAoZGlyKSB7CiAgcmV0dXJuIHsKICAgIHBhdGg6IGRpciwKICAgIG9wbG9nOiBwYXRoLmpvaW4oZGlyLCAnb3Bsb2cnKSwKICAgIGRhdGE6IHBhdGguam9pbihkaXIsICdkYXRhJyksCiAgICB0cmVlOiBwYXRoLmpvaW4oZGlyLCAndHJlZScpLAogICAgYml0ZmllbGQ6IHBhdGguam9pbihkaXIsICdiaXRmaWVsZCcpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBnZXRSb290c0Zyb21TdG9yYWdlIChjb3JlLCBsZW5ndGgpIHsKICBjb25zdCBhbGwgPSBbXQogIGNvbnN0IHJ4ID0gY29yZS5yZWFkKCkKICBmb3IgKGNvbnN0IGluZGV4IG9mIGZsYXQuZnVsbFJvb3RzKDIgKiBsZW5ndGgpKSB7CiAgICBhbGwucHVzaChyeC5nZXRUcmVlTm9kZShpbmRleCkpCiAgfQogIHJ4LnRyeUZsdXNoKCkKICByZXR1cm4gUHJvbWlzZS5hbGwoYWxsKQp9Cgphc3luYyBmdW5jdGlvbiBnZXRSb290cyAobGVuZ3RoLCBnZXRUcmVlTm9kZSkgewogIGNvbnN0IGFsbCA9IFtdCiAgZm9yIChjb25zdCBpbmRleCBvZiBmbGF0LmZ1bGxSb290cygyICogbGVuZ3RoKSkgewogICAgYWxsLnB1c2goYXdhaXQgZ2V0VHJlZU5vZGUoaW5kZXgpKQogIH0KICByZXR1cm4gYWxsCn0KCmZ1bmN0aW9uIGdldENhY2hlZCAocmVhZCwgY2FjaGUsIGluZGV4KSB7CiAgaWYgKGNhY2hlLmhhcyhpbmRleCkpIHJldHVybiBjYWNoZS5nZXQoaW5kZXgpCiAgY29uc3QgcCA9IHJlYWQuZ2V0VHJlZU5vZGUoaW5kZXgpCiAgY2FjaGUuc2V0KGluZGV4LCBwKQogIHJldHVybiBwCn0KCmFzeW5jIGZ1bmN0aW9uIGdldEJ5dGVSYW5nZUZyb21TdG9yYWdlIChyZWFkLCBpbmRleCwgcm9vdHMsIGNhY2hlKSB7CiAgY29uc3QgcHJvbWlzZXMgPSBbZ2V0Q2FjaGVkKHJlYWQsIGNhY2hlLCBpbmRleCksIGdldEJ5dGVPZmZzZXRGcm9tU3RvcmFnZShyZWFkLCBpbmRleCwgcm9vdHMsIGNhY2hlKV0KICBjb25zdCBbbm9kZSwgb2Zmc2V0XSA9IGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKQogIGlmICghbm9kZSkgdGhyb3cgbmV3IEVycm9yKCdOb2RlIG5vdCBmb3VuZCBkdXJpbmcgbWlncmF0aW9uOiAnICsgaW5kZXgpCiAgcmV0dXJuIFtvZmZzZXQsIG5vZGUuc2l6ZV0KfQoKYXN5bmMgZnVuY3Rpb24gZ2V0Qnl0ZU9mZnNldEZyb21TdG9yYWdlIChyeCwgaW5kZXgsIHJvb3RzLCBjYWNoZSkgewogIGlmIChpbmRleCA9PT0gMCkgcmV0dXJuIDAKICBpZiAoKGluZGV4ICYgMSkgPT09IDEpIGluZGV4ID0gZmxhdC5sZWZ0U3BhbihpbmRleCkKCiAgbGV0IGhlYWQgPSAwCiAgbGV0IG9mZnNldCA9IDAKCiAgZm9yIChjb25zdCBub2RlIG9mIHJvb3RzKSB7IC8vIGFsbCBhc3luYyB0aWNrcyBoYXBwZW4gb25jZSB3ZSBmaW5kIHRoZSByb290IHNvIHNhZmUKICAgIGhlYWQgKz0gMiAqICgobm9kZS5pbmRleCAtIGhlYWQpICsgMSkKCiAgICBpZiAoaW5kZXggPj0gaGVhZCkgewogICAgICBvZmZzZXQgKz0gbm9kZS5zaXplCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihub2RlLmluZGV4KQogICAgY29uc3QgcHJvbWlzZXMgPSBbXQoKICAgIHdoaWxlIChpdGUuaW5kZXggIT09IGluZGV4KSB7CiAgICAgIGlmIChpbmRleCA8IGl0ZS5pbmRleCkgewogICAgICAgIGl0ZS5sZWZ0Q2hpbGQoKQogICAgICB9IGVsc2UgewogICAgICAgIHByb21pc2VzLnB1c2goZ2V0Q2FjaGVkKHJ4LCBjYWNoZSwgaXRlLmxlZnRDaGlsZCgpKSkKICAgICAgICBpdGUuc2libGluZygpCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBub2RlcyA9IGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKQogICAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSBvZmZzZXQgKz0gbm9kZS5zaXplCgogICAgcmV0dXJuIG9mZnNldAogIH0KCiAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gZmluZCBvZmZzZXQnKQp9CgpmdW5jdGlvbiBkZWNvZGVUcmVlTm9kZSAoaW5kZXgsIGJ1ZikgewogIHJldHVybiB7IGluZGV4LCBzaXplOiBjLmRlY29kZShjLnVpbnQ2NCwgYnVmKSwgaGFzaDogYnVmLnN1YmFycmF5KDgpIH0KfQoKYXN5bmMgZnVuY3Rpb24gZ2V0VHJlZU5vZGVGcm9tRmlsZSAoZmlsZSwgaW5kZXgpIHsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgIHJlYWRBbGwoZmlsZSwgNDAsIGluZGV4ICogNDAsIGZ1bmN0aW9uIChlcnIsIGJ1ZikgewogICAgICBpZiAoZXJyKSByZXR1cm4gcmVzb2x2ZShudWxsKQogICAgICByZXNvbHZlKGRlY29kZVRyZWVOb2RlKGluZGV4LCBidWYpKQogICAgfSkKICB9KQp9CgpmdW5jdGlvbiByZWFkQWxsIChmaWxlbmFtZSwgbGVuZ3RoLCBwb3MsIGNiKSB7CiAgY29uc3QgYnVmID0gYjRhLmFsbG9jKGxlbmd0aCkKCiAgZnMub3BlbihmaWxlbmFtZSwgJ3InLCBmdW5jdGlvbiAoZXJyLCBmZCkgewogICAgaWYgKGVycikgcmV0dXJuIGNiKGVycikKCiAgICBsZXQgb2Zmc2V0ID0gMAoKICAgIGZzLnJlYWQoZmQsIGJ1Ziwgb2Zmc2V0LCBidWYuYnl0ZUxlbmd0aCwgcG9zLCBmdW5jdGlvbiBsb29wIChlcnIsIHJlYWQpIHsKICAgICAgaWYgKGVycikgcmV0dXJuIGRvbmUoZXJyKQogICAgICBpZiAocmVhZCA9PT0gMCkgcmV0dXJuIGRvbmUobmV3IEVycm9yKCdQYXJ0aWFsIHJlYWQnKSkKICAgICAgb2Zmc2V0ICs9IHJlYWQKICAgICAgaWYgKG9mZnNldCA9PT0gYnVmLmJ5dGVMZW5ndGgpIHJldHVybiBkb25lKG51bGwsIGJ1ZikKICAgICAgZnMucmVhZChmZCwgb2Zmc2V0LCBidWYuYnl0ZUxlbmd0aCAtIG9mZnNldCwgYnVmLCBwb3MgKyBvZmZzZXQsIGxvb3ApCiAgICB9KQoKICAgIGZ1bmN0aW9uIGRvbmUgKGVyciwgdmFsdWUpIHsKICAgICAgZnMuY2xvc2UoZmQsICgpID0+IGNiKGVyciwgdmFsdWUpKQogICAgfQogIH0pCn0KCmFzeW5jIGZ1bmN0aW9uIHJlYWRkaXIgKGRpcikgewogIHRyeSB7CiAgICByZXR1cm4gYXdhaXQgZnMucHJvbWlzZXMucmVhZGRpcihkaXIpCiAgfSBjYXRjaCB7CiAgICByZXR1cm4gW10KICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGV4aXN0cyAoZmlsZSkgewogIHRyeSB7CiAgICBhd2FpdCBmcy5wcm9taXNlcy5zdGF0KGZpbGUpCiAgICByZXR1cm4gdHJ1ZQogIH0gY2F0Y2ggewogICAgcmV0dXJuIGZhbHNlCiAgfQp9Cgphc3luYyBmdW5jdGlvbiByZWFkRmlsZSAoZmlsZSkgewogIHRyeSB7CiAgICByZXR1cm4gYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUoZmlsZSkKICB9IGNhdGNoIHsKICAgIHJldHVybiBudWxsCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBybSAoZGlyKSB7CiAgdHJ5IHsKICAgIGF3YWl0IGZzLnByb21pc2VzLnJtKGRpciwgeyByZWN1cnNpdmU6IHRydWUgfSkKICB9IGNhdGNoIHt9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJtZGlyIChkaXIpIHsKICB0cnkgewogICAgYXdhaXQgZnMucHJvbWlzZXMucm1kaXIoZGlyKQogIH0gY2F0Y2gge30KfQoKZnVuY3Rpb24gKiBhbGxCaXRzIChidWZmZXIpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlci5ieXRlTGVuZ3RoOyBpICs9IEVNUFRZX1BBR0UuYnl0ZUxlbmd0aCkgewogICAgY29uc3QgcGFnZSA9IGJ1ZmZlci5zdWJhcnJheShpLCBpICsgRU1QVFlfTk9ERS5ieXRlTGVuZ3RoKQogICAgaWYgKGI0YS5lcXVhbHMocGFnZSwgRU1QVFlfUEFHRSkpIGNvbnRpbnVlCgogICAgY29uc3QgdmlldyA9IG5ldyBVaW50MzJBcnJheShwYWdlLmJ1ZmZlciwgcGFnZS5ieXRlT2Zmc2V0LCBFTVBUWV9QQUdFLmJ5dGVMZW5ndGggLyA0KQoKICAgIGZvciAobGV0IGogPSAwOyBqIDwgdmlldy5sZW5ndGg7IGorKykgewogICAgICBjb25zdCBuID0gdmlld1tqXQogICAgICBpZiAobiA9PT0gMCkgY29udGludWUKCiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgMzI7IGsrKykgewogICAgICAgIGNvbnN0IG0gPSAxIDw8IGsKICAgICAgICBpZiAobiAmIG0pIHlpZWxkIGkgKiA4ICsgaiAqIDMyICsgawogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiByZWFkT3Bsb2cgKG9wbG9nKSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICBmcy5yZWFkRmlsZShvcGxvZywgZnVuY3Rpb24gKGVyciwgYnVmZmVyKSB7CiAgICAgIGlmIChlcnIpIHJldHVybiByZXNvbHZlKG51bGwpCgogICAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGgsIGJ1ZmZlciB9CiAgICAgIGNvbnN0IGhlYWRlcnMgPSBbMSwgMF0KCiAgICAgIGNvbnN0IGgxID0gZGVjb2RlT3Bsb2dIZWFkZXIoc3RhdGUpCiAgICAgIHN0YXRlLnN0YXJ0ID0gNDA5NgoKICAgICAgY29uc3QgaDIgPSBkZWNvZGVPcGxvZ0hlYWRlcihzdGF0ZSkKICAgICAgc3RhdGUuc3RhcnQgPSA0MDk2ICogMgoKICAgICAgaWYgKCFoMSAmJiAhaDIpIHJldHVybiByZXNvbHZlKG51bGwpCgogICAgICBpZiAoaDEgJiYgIWgyKSB7CiAgICAgICAgaGVhZGVyc1swXSA9IGgxLmhlYWRlcgogICAgICAgIGhlYWRlcnNbMV0gPSBoMS5oZWFkZXIKICAgICAgfSBlbHNlIGlmICghaDEgJiYgaDIpIHsKICAgICAgICBoZWFkZXJzWzBdID0gKGgyLmhlYWRlciArIDEpICYgMQogICAgICAgIGhlYWRlcnNbMV0gPSBoMi5oZWFkZXIKICAgICAgfSBlbHNlIHsKICAgICAgICBoZWFkZXJzWzBdID0gaDEuaGVhZGVyCiAgICAgICAgaGVhZGVyc1sxXSA9IGgyLmhlYWRlcgogICAgICB9CgogICAgICBjb25zdCBoZWFkZXIgPSAoaGVhZGVyc1swXSArIGhlYWRlcnNbMV0pICYgMQogICAgICBjb25zdCByZXN1bHQgPSB7IHBhdGg6IHBhdGguZGlybmFtZShvcGxvZyksIGhlYWRlcjogbnVsbCwgZW50cmllczogW10gfQogICAgICBjb25zdCBkZWNvZGVkID0gW10KCiAgICAgIHJlc3VsdC5oZWFkZXIgPSBoZWFkZXIgPyBoMi5tZXNzYWdlIDogaDEubWVzc2FnZQoKICAgICAgaWYgKHJlc3VsdC5oZWFkZXIuZXh0ZXJuYWwpIHsKICAgICAgICBmcy5yZWFkRmlsZShwYXRoLmpvaW4ob3Bsb2csICcuLi9oZWFkZXInKSwgZnVuY3Rpb24gKGVyciwgYnVmZmVyKSB7CiAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVzb2x2ZShudWxsKQogICAgICAgICAgY29uc3Qgc3RhcnQgPSByZXN1bHQuaGVhZGVyLmV4dGVybmFsLnN0YXJ0CiAgICAgICAgICBjb25zdCBlbmQgPSBzdGFydCArIHJlc3VsdC5oZWFkZXIuZXh0ZXJuYWwubGVuZ3RoCiAgICAgICAgICByZXN1bHQuaGVhZGVyID0gbS5vcGxvZy5oZWFkZXIuZGVjb2RlKHsgYnVmZmVyLCBzdGFydCwgZW5kIH0pCiAgICAgICAgICBmaW5pc2goKQogICAgICAgIH0pCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIGZpbmlzaCgpCgogICAgICBmdW5jdGlvbiBmaW5pc2ggKCkgewogICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICBjb25zdCBlbnRyeSA9IGRlY29kZU9wbG9nRW50cnkoc3RhdGUpCiAgICAgICAgICBpZiAoIWVudHJ5KSBicmVhawogICAgICAgICAgaWYgKGVudHJ5LmhlYWRlciAhPT0gaGVhZGVyKSBicmVhawoKICAgICAgICAgIGRlY29kZWQucHVzaChlbnRyeSkKICAgICAgICB9CgogICAgICAgIHdoaWxlIChkZWNvZGVkLmxlbmd0aCA+IDAgJiYgZGVjb2RlZFtkZWNvZGVkLmxlbmd0aCAtIDFdLnBhcnRpYWwpIGRlY29kZWQucG9wKCkKCiAgICAgICAgZm9yIChjb25zdCBlIG9mIGRlY29kZWQpIHsKICAgICAgICAgIHJlc3VsdC5lbnRyaWVzLnB1c2goZS5tZXNzYWdlKQogICAgICAgIH0KCiAgICAgICAgcmVzb2x2ZShyZXN1bHQpCiAgICAgIH0KICAgIH0pCiAgfSkKfQoKZnVuY3Rpb24gbm9vcCAoKSB7fQovLyBuZWVkZWQgaGVyZSBmb3IgY29tcGF0LCBjb3BpZWQgZnJvbSBvbGQgaHlwZXJjb3JlLCBkbyBub3QgY2hhbmdlIHRoaXMKCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IEVNUFRZID0gYjRhLmFsbG9jKDApCmNvbnN0IERFRkFVTFRfTkFNRVNQQUNFID0gYjRhLmZyb20oJzQxNDRlZWE1MzFlNDgzZDU0ZTBjMTRmNGNhNjhlMDY0NGYzNTUzNDNmZjZmY2IwZjAwNTIwMGUxMmNkNzQ3Y2InLCAnaGV4JykKCmNvbnN0IGhhc2hlcyA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBzbWFsbCB1aW50CiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBpZiAobSA9PT0gJ2JsYWtlMmInKSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApCiAgICAgIHJldHVybgogICAgfQoKICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBoYXNoOiAnICsgbSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IG4gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgaWYgKG4gPT09IDApIHJldHVybiAnYmxha2UyYicKICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBoYXNoIGlkOiAnICsgbikKICB9Cn0KCmNvbnN0IHNpZ25hdHVyZXMgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gc21hbGwgdWludAogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgaWYgKG0gPT09ICdlZDI1NTE5JykgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAwKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gc2lnbmF0dXJlOiAnICsgbSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IG4gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgaWYgKG4gPT09IDApIHJldHVybiAnZWQyNTUxOScKICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBzaWduYXR1cmUgaWQ6ICcgKyBuKQogIH0KfQoKY29uc3Qgc2lnbmVyID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHNpZ25hdHVyZXMucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ubmFtZXNwYWNlKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzaWduYXR1cmVzLmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc2lnbmF0dXJlOiBzaWduYXR1cmVzLmRlY29kZShzdGF0ZSksCiAgICAgIG5hbWVzcGFjZTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIHB1YmxpY0tleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHNpZ25lckFycmF5ID0gYy5hcnJheShzaWduZXIpCgpjb25zdCBwcm9sb2d1ZSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBwKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBwLmhhc2gpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBwLmxlbmd0aCkKICB9LAogIGVuY29kZSAoc3RhdGUsIHApIHsKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIHAuaGFzaCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHAubGVuZ3RoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaGFzaDogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IG1hbmlmZXN0djAgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgaGFzaGVzLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgc3RhdGUuZW5kKysgLy8gdHlwZQoKICAgIGlmIChtLnByb2xvZ3VlICYmIG0uc2lnbmVycy5sZW5ndGggPT09IDApIHsKICAgICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5wcm9sb2d1ZS5oYXNoKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAobS5xdW9ydW0gPT09IDEgJiYgbS5zaWduZXJzLmxlbmd0aCA9PT0gMSAmJiAhbS5hbGxvd1BhdGNoKSB7CiAgICAgIHNpZ25lci5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmVyc1swXSkKICAgIH0gZWxzZSB7CiAgICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucXVvcnVtKQogICAgICBzaWduZXJBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmVycykKICAgIH0KICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGhhc2hlcy5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKCiAgICBpZiAobS5wcm9sb2d1ZSAmJiBtLnNpZ25lcnMubGVuZ3RoID09PSAwKSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApCiAgICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucHJvbG9ndWUuaGFzaCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKG0ucXVvcnVtID09PSAxICYmIG0uc2lnbmVycy5sZW5ndGggPT09IDEgJiYgIW0uYWxsb3dQYXRjaCkgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKQogICAgICBzaWduZXIuZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnNbMF0pCiAgICB9IGVsc2UgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAyKQogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmFsbG93UGF0Y2ggPyAxIDogMCkKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5xdW9ydW0pCiAgICAgIHNpZ25lckFycmF5LmVuY29kZShzdGF0ZSwgbS5zaWduZXJzKQogICAgfQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgaGFzaCA9IGhhc2hlcy5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCB0eXBlID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAodHlwZSA+IDIpIHRocm93IG5ldyBFcnJvcignVW5rbm93biB0eXBlOiAnICsgdHlwZSkKCiAgICBpZiAodHlwZSA9PT0gMCkgewogICAgICByZXR1cm4gewogICAgICAgIHZlcnNpb246IDAsCiAgICAgICAgaGFzaCwKICAgICAgICBhbGxvd1BhdGNoOiBmYWxzZSwKICAgICAgICBxdW9ydW06IDAsCiAgICAgICAgc2lnbmVyczogW10sCiAgICAgICAgcHJvbG9ndWU6IHsKICAgICAgICAgIGhhc2g6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICAgICAgbGVuZ3RoOiAwCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKHR5cGUgPT09IDEpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uOiAwLAogICAgICAgIGhhc2gsCiAgICAgICAgYWxsb3dQYXRjaDogZmFsc2UsCiAgICAgICAgcXVvcnVtOiAxLAogICAgICAgIHNpZ25lcnM6IFtzaWduZXIuZGVjb2RlKHN0YXRlKV0sCiAgICAgICAgcHJvbG9ndWU6IG51bGwKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiAwLAogICAgICBoYXNoLAogICAgICBhbGxvd1BhdGNoOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgcXVvcnVtOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmVyczogc2lnbmVyQXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgcHJvbG9ndWU6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IG1hbmlmZXN0ID0gZXhwb3J0cy5tYW5pZmVzdCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyB2ZXJzaW9uCiAgICBpZiAobS52ZXJzaW9uID09PSAwKSByZXR1cm4gbWFuaWZlc3R2MC5wcmVlbmNvZGUoc3RhdGUsIG0pCgogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGhhc2hlcy5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnF1b3J1bSkKICAgIHNpZ25lckFycmF5LnByZWVuY29kZShzdGF0ZSwgbS5zaWduZXJzKQogICAgaWYgKG0ucHJvbG9ndWUpIHByb2xvZ3VlLnByZWVuY29kZShzdGF0ZSwgbS5wcm9sb2d1ZSkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIGlmIChtLnZlcnNpb24gPT09IDApIHJldHVybiBtYW5pZmVzdHYwLmVuY29kZShzdGF0ZSwgbSkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAobS5hbGxvd1BhdGNoID8gMSA6IDApIHwgKG0ucHJvbG9ndWUgPyAyIDogMCkgfCAobS51bmVuY3J5cHRlZCA/IDQgOiAwKSkKICAgIGhhc2hlcy5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnF1b3J1bSkKICAgIHNpZ25lckFycmF5LmVuY29kZShzdGF0ZSwgbS5zaWduZXJzKQogICAgaWYgKG0ucHJvbG9ndWUpIHByb2xvZ3VlLmVuY29kZShzdGF0ZSwgbS5wcm9sb2d1ZSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IHYgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgaWYgKHYgPT09IDApIHJldHVybiBtYW5pZmVzdHYwLmRlY29kZShzdGF0ZSkKICAgIGlmICh2ICE9PSAxKSB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gdmVyc2lvbjogJyArIHYpCgogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgaGFzaCA9IGhhc2hlcy5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBxdW9ydW0gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3Qgc2lnbmVycyA9IHNpZ25lckFycmF5LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHVuZW5jcnlwdGVkID0gKGZsYWdzICYgNCkgIT09IDAKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiAxLAogICAgICBoYXNoLAogICAgICBhbGxvd1BhdGNoOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgcXVvcnVtLAogICAgICBzaWduZXJzLAogICAgICBwcm9sb2d1ZTogKGZsYWdzICYgMikgPT09IDAgPyBudWxsIDogcHJvbG9ndWUuZGVjb2RlKHN0YXRlKSwKICAgICAgdW5lbmNyeXB0ZWQKICAgIH0KICB9Cn0KCmNvbnN0IG5vZGUgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5pbmRleCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4uc2l6ZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG4uaGFzaCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG4pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uaW5kZXgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLnNpemUpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBuLmhhc2gpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpbmRleDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpemU6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBoYXNoOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qgbm9kZUFycmF5ID0gYy5hcnJheShub2RlKQoKY29uc3Qgd2lyZSA9IGV4cG9ydHMud2lyZSA9IHt9Cgp3aXJlLmhhbmRzaGFrZSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCAxKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5jYXBhYmlsaXR5KQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zZWVrcyA/IDEgOiAwKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5jYXBhYmlsaXR5KQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgc2Vla3M6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBjYXBhYmlsaXR5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVxdWVzdEJsb2NrID0gewogIHByZWVuY29kZSAoc3RhdGUsIGIpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgYikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpbmRleDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVxdWVzdFNlZWsgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgcykgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgcy5ieXRlcykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHMucGFkZGluZykKICB9LAogIGVuY29kZSAoc3RhdGUsIHMpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHMuYnl0ZXMpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBzLnBhZGRpbmcpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBieXRlczogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHBhZGRpbmc6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZXF1ZXN0VXBncmFkZSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1LnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1LnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUucmVxdWVzdCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZm9yaykKCiAgICBpZiAobS5ibG9jaykgcmVxdWVzdEJsb2NrLnByZWVuY29kZShzdGF0ZSwgbS5ibG9jaykKICAgIGlmIChtLmhhc2gpIHJlcXVlc3RCbG9jay5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGlmIChtLnNlZWspIHJlcXVlc3RTZWVrLnByZWVuY29kZShzdGF0ZSwgbS5zZWVrKQogICAgaWYgKG0udXBncmFkZSkgcmVxdWVzdFVwZ3JhZGUucHJlZW5jb2RlKHN0YXRlLCBtLnVwZ3JhZGUpCiAgICBpZiAobS5wcmlvcml0eSkgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5wcmlvcml0eSkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gKG0uYmxvY2sgPyAxIDogMCkgfCAobS5oYXNoID8gMiA6IDApIHwgKG0uc2VlayA/IDQgOiAwKSB8IChtLnVwZ3JhZGUgPyA4IDogMCkgfCAobS5tYW5pZmVzdCA/IDE2IDogMCkgfCAobS5wcmlvcml0eSA/IDMyIDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uaWQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmZvcmspCgogICAgaWYgKG0uYmxvY2spIHJlcXVlc3RCbG9jay5lbmNvZGUoc3RhdGUsIG0uYmxvY2spCiAgICBpZiAobS5oYXNoKSByZXF1ZXN0QmxvY2suZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBpZiAobS5zZWVrKSByZXF1ZXN0U2Vlay5lbmNvZGUoc3RhdGUsIG0uc2VlaykKICAgIGlmIChtLnVwZ3JhZGUpIHJlcXVlc3RVcGdyYWRlLmVuY29kZShzdGF0ZSwgbS51cGdyYWRlKQogICAgaWYgKG0ucHJpb3JpdHkpIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucHJpb3JpdHkpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgaWQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBmb3JrOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYmxvY2s6IGZsYWdzICYgMSA/IHJlcXVlc3RCbG9jay5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgaGFzaDogZmxhZ3MgJiAyID8gcmVxdWVzdEJsb2NrLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBzZWVrOiBmbGFncyAmIDQgPyByZXF1ZXN0U2Vlay5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdXBncmFkZTogZmxhZ3MgJiA4ID8gcmVxdWVzdFVwZ3JhZGUuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIG1hbmlmZXN0OiAoZmxhZ3MgJiAxNikgIT09IDAsCiAgICAgIHByaW9yaXR5OiBmbGFncyAmIDMyID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCiAgICB9CiAgfQp9Cgp3aXJlLmNhbmNlbCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgfSwKICBkZWNvZGUgKHN0YXRlLCBtKSB7CiAgICByZXR1cm4gewogICAgICByZXF1ZXN0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgZGF0YVVwZ3JhZGUgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgdSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogICAgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgdS5ub2RlcykKICAgIG5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIHUuYWRkaXRpb25hbE5vZGVzKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCB1LnNpZ25hdHVyZSkKICB9LAogIGVuY29kZSAoc3RhdGUsIHUpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUuc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIHUubm9kZXMpCiAgICBub2RlQXJyYXkuZW5jb2RlKHN0YXRlLCB1LmFkZGl0aW9uYWxOb2RlcykKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgdS5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgYWRkaXRpb25hbE5vZGVzOiBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBkYXRhU2VlayA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBzKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBzLmJ5dGVzKQogICAgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgcy5ub2RlcykKICB9LAogIGVuY29kZSAoc3RhdGUsIHMpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHMuYnl0ZXMpCiAgICBub2RlQXJyYXkuZW5jb2RlKHN0YXRlLCBzLm5vZGVzKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgYnl0ZXM6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBub2Rlczogbm9kZUFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGRhdGFCbG9jayA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBiLnZhbHVlKQogICAgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGVuY29kZSAoc3RhdGUsIGIpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIGIudmFsdWUpCiAgICBub2RlQXJyYXkuZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICB2YWx1ZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKSB8fCBFTVBUWSwKICAgICAgbm9kZXM6IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBkYXRhSGFzaCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGVuY29kZSAoc3RhdGUsIGIpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBub2RlQXJyYXkuZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBub2Rlczogbm9kZUFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUuZGF0YSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZXF1ZXN0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5mb3JrKQoKICAgIGlmIChtLmJsb2NrKSBkYXRhQmxvY2sucHJlZW5jb2RlKHN0YXRlLCBtLmJsb2NrKQogICAgaWYgKG0uaGFzaCkgZGF0YUhhc2gucHJlZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBpZiAobS5zZWVrKSBkYXRhU2Vlay5wcmVlbmNvZGUoc3RhdGUsIG0uc2VlaykKICAgIGlmIChtLnVwZ3JhZGUpIGRhdGFVcGdyYWRlLnByZWVuY29kZShzdGF0ZSwgbS51cGdyYWRlKQogICAgaWYgKG0ubWFuaWZlc3QpIG1hbmlmZXN0LnByZWVuY29kZShzdGF0ZSwgbS5tYW5pZmVzdCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gKG0uYmxvY2sgPyAxIDogMCkgfCAobS5oYXNoID8gMiA6IDApIHwgKG0uc2VlayA/IDQgOiAwKSB8IChtLnVwZ3JhZGUgPyA4IDogMCkgfCAobS5tYW5pZmVzdCA/IDE2IDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZm9yaykKCiAgICBpZiAobS5ibG9jaykgZGF0YUJsb2NrLmVuY29kZShzdGF0ZSwgbS5ibG9jaykKICAgIGlmIChtLmhhc2gpIGRhdGFIYXNoLmVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgaWYgKG0uc2VlaykgZGF0YVNlZWsuZW5jb2RlKHN0YXRlLCBtLnNlZWspCiAgICBpZiAobS51cGdyYWRlKSBkYXRhVXBncmFkZS5lbmNvZGUoc3RhdGUsIG0udXBncmFkZSkKICAgIGlmIChtLm1hbmlmZXN0KSBtYW5pZmVzdC5lbmNvZGUoc3RhdGUsIG0ubWFuaWZlc3QpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgcmVxdWVzdDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGZvcms6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBibG9jazogZmxhZ3MgJiAxID8gZGF0YUJsb2NrLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBoYXNoOiBmbGFncyAmIDIgPyBkYXRhSGFzaC5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgc2VlazogZmxhZ3MgJiA0ID8gZGF0YVNlZWsuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHVwZ3JhZGU6IGZsYWdzICYgOCA/IGRhdGFVcGdyYWRlLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBtYW5pZmVzdDogZmxhZ3MgJiAxNiA/IG1hbmlmZXN0LmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgp3aXJlLm5vRGF0YSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgfSwKICBkZWNvZGUgKHN0YXRlLCBtKSB7CiAgICByZXR1cm4gewogICAgICByZXF1ZXN0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS53YW50ID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS51bndhbnQgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSwgbSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLnJhbmdlID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgaWYgKG0ubGVuZ3RoICE9PSAxKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIChtLmRyb3AgPyAxIDogMCkgfCAobS5sZW5ndGggPT09IDEgPyAyIDogMCkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgaWYgKG0ubGVuZ3RoICE9PSAxKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBkcm9wOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IChmbGFncyAmIDIpICE9PSAwID8gMSA6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLmJpdGZpZWxkID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQzMmFycmF5LnByZWVuY29kZShzdGF0ZSwgbS5iaXRmaWVsZCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQzMmFycmF5LmVuY29kZShzdGF0ZSwgbS5iaXRmaWVsZCkKICB9LAogIGRlY29kZSAoc3RhdGUsIG0pIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYml0ZmllbGQ6IGMudWludDMyYXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5zeW5jID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmZvcmspCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVtb3RlTGVuZ3RoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgKG0uY2FuVXBncmFkZSA/IDEgOiAwKSB8IChtLnVwbG9hZGluZyA/IDIgOiAwKSB8IChtLmRvd25sb2FkaW5nID8gNCA6IDApIHwgKG0uaGFzTWFuaWZlc3QgPyA4IDogMCkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmZvcmspCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVtb3RlTGVuZ3RoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGZvcms6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICByZW1vdGVMZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBjYW5VcGdyYWRlOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgdXBsb2FkaW5nOiAoZmxhZ3MgJiAyKSAhPT0gMCwKICAgICAgZG93bmxvYWRpbmc6IChmbGFncyAmIDQpICE9PSAwLAogICAgICBoYXNNYW5pZmVzdDogKGZsYWdzICYgOCkgIT09IDAKICAgIH0KICB9Cn0KCndpcmUucmVvcmdIaW50ID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZnJvbSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udG8pCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmFuY2VzdG9ycykKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZnJvbSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udG8pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmFuY2VzdG9ycykKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGZyb206IGMudWludC5lbmNvZGUoc3RhdGUpLAogICAgICB0bzogYy51aW50LmVuY29kZShzdGF0ZSksCiAgICAgIGFuY2VzdG9yczogYy51aW50LmVuY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUuZXh0ZW5zaW9uID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgbS5uYW1lKQogICAgYy5yYXcucHJlZW5jb2RlKHN0YXRlLCBtLm1lc3NhZ2UpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIG0ubmFtZSkKICAgIGMucmF3LmVuY29kZShzdGF0ZSwgbS5tZXNzYWdlKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgbmFtZTogYy5zdHJpbmcuZGVjb2RlKHN0YXRlKSwKICAgICAgbWVzc2FnZTogYy5yYXcuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qga2V5VmFsdWUgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgcCkgewogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCBwLmtleSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgcC52YWx1ZSkKICB9LAogIGVuY29kZSAoc3RhdGUsIHApIHsKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgcC5rZXkpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHAudmFsdWUpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBrZXk6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSksCiAgICAgIHZhbHVlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCB0cmVlVXBncmFkZSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1LmZvcmspCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1LmFuY2VzdG9ycykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCB1LnNpZ25hdHVyZSkKICB9LAogIGVuY29kZSAoc3RhdGUsIHUpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUuZm9yaykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUuYW5jZXN0b3JzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHUuc2lnbmF0dXJlKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgZm9yazogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGFuY2VzdG9yczogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25hdHVyZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgYml0ZmllbGRVcGRhdGUgPSB7IC8vIFRPRE86IGNhbiBtYXliZSBiZSBmb2xkZWQgaW50byBhIEhBVkUgbGF0ZXIgb24gd2l0aCB0aGUgbW9zdCByZWNlbnQgc3BlYwogIHByZWVuY29kZSAoc3RhdGUsIGIpIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgYi5sZW5ndGgpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBiKSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBiLmRyb3AgPyAxIDogMAogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGIubGVuZ3RoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgZHJvcDogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qgb3Bsb2cgPSBleHBvcnRzLm9wbG9nID0ge30KCm9wbG9nLmVudHJ5ID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBpZiAobS51c2VyRGF0YSkga2V5VmFsdWUucHJlZW5jb2RlKHN0YXRlLCBtLnVzZXJEYXRhKQogICAgaWYgKG0udHJlZU5vZGVzKSBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLnRyZWVOb2RlcykKICAgIGlmIChtLnRyZWVVcGdyYWRlKSB0cmVlVXBncmFkZS5wcmVlbmNvZGUoc3RhdGUsIG0udHJlZVVwZ3JhZGUpCiAgICBpZiAobS5iaXRmaWVsZCkgYml0ZmllbGRVcGRhdGUucHJlZW5jb2RlKHN0YXRlLCBtLmJpdGZpZWxkKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgY29uc3QgcyA9IHN0YXRlLnN0YXJ0KysKICAgIGxldCBmbGFncyA9IDAKCiAgICBpZiAobS51c2VyRGF0YSkgewogICAgICBmbGFncyB8PSAxCiAgICAgIGtleVZhbHVlLmVuY29kZShzdGF0ZSwgbS51c2VyRGF0YSkKICAgIH0KICAgIGlmIChtLnRyZWVOb2RlcykgewogICAgICBmbGFncyB8PSAyCiAgICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIG0udHJlZU5vZGVzKQogICAgfQogICAgaWYgKG0udHJlZVVwZ3JhZGUpIHsKICAgICAgZmxhZ3MgfD0gNAogICAgICB0cmVlVXBncmFkZS5lbmNvZGUoc3RhdGUsIG0udHJlZVVwZ3JhZGUpCiAgICB9CiAgICBpZiAobS5iaXRmaWVsZCkgewogICAgICBmbGFncyB8PSA4CiAgICAgIGJpdGZpZWxkVXBkYXRlLmVuY29kZShzdGF0ZSwgbS5iaXRmaWVsZCkKICAgIH0KCiAgICBzdGF0ZS5idWZmZXJbc10gPSBmbGFncwogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgdXNlckRhdGE6IChmbGFncyAmIDEpICE9PSAwID8ga2V5VmFsdWUuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHRyZWVOb2RlczogKGZsYWdzICYgMikgIT09IDAgPyBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHRyZWVVcGdyYWRlOiAoZmxhZ3MgJiA0KSAhPT0gMCA/IHRyZWVVcGdyYWRlLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBiaXRmaWVsZDogKGZsYWdzICYgOCkgIT09IDAgPyBiaXRmaWVsZFVwZGF0ZS5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKY29uc3Qga2V5UGFpciA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBrcCkgewogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBrcC5wdWJsaWNLZXkpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIGtwLnNlY3JldEtleSkKICB9LAogIGVuY29kZSAoc3RhdGUsIGtwKSB7CiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIGtwLnB1YmxpY0tleSkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwga3Auc2VjcmV0S2V5KQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcHVibGljS2V5OiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpLAogICAgICBzZWNyZXRLZXk6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlb3JnSGludCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCByKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCByLmZyb20pCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCByLnRvKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgci5hbmNlc3RvcnMpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCByKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCByLmZyb20pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCByLnRvKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgci5hbmNlc3RvcnMpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBmcm9tOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgdG86IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBhbmNlc3RvcnM6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZW9yZ0hpbnRBcnJheSA9IGMuYXJyYXkocmVvcmdIaW50KQoKY29uc3QgaGludHMgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgaCkgewogICAgcmVvcmdIaW50QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBoLnJlb3JncykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGguY29udGlndW91c0xlbmd0aCkKICB9LAogIGVuY29kZSAoc3RhdGUsIGgpIHsKICAgIHJlb3JnSGludEFycmF5LmVuY29kZShzdGF0ZSwgaC5yZW9yZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBoLmNvbnRpZ3VvdXNMZW5ndGgpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICByZW9yZ3M6IHJlb3JnSGludEFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IHN0YXRlLnN0YXJ0IDwgc3RhdGUuZW5kID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCiAgICB9CiAgfQp9Cgpjb25zdCB0cmVlSGVhZGVyID0gewogIHByZWVuY29kZSAoc3RhdGUsIHQpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHQuZm9yaykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHQubGVuZ3RoKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCB0LnJvb3RIYXNoKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCB0LnNpZ25hdHVyZSkKICB9LAogIGVuY29kZSAoc3RhdGUsIHQpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHQuZm9yaykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHQubGVuZ3RoKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB0LnJvb3RIYXNoKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB0LnNpZ25hdHVyZSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGZvcms6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICByb290SGFzaDogYy5idWZmZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCB0eXBlcyA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCB0KSB7CiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIHQudHJlZSkKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgdC5iaXRmaWVsZCkKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgdC5zaWduZXIpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCB0KSB7CiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIHQudHJlZSkKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgdC5iaXRmaWVsZCkKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgdC5zaWduZXIpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICB0cmVlOiBjLnN0cmluZy5kZWNvZGUoc3RhdGUpLAogICAgICBiaXRmaWVsZDogYy5zdHJpbmcuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmVyOiBjLnN0cmluZy5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBleHRlcm5hbEhlYWRlciA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGtleVZhbHVlQXJyYXkgPSBjLmFycmF5KGtleVZhbHVlKQoKb3Bsb2cuaGVhZGVyID0gewogIHByZWVuY29kZSAoc3RhdGUsIGgpIHsKICAgIHN0YXRlLmVuZCArPSAyIC8vIHZlcnNpb24gKyBmbGFncwogICAgaWYgKGguZXh0ZXJuYWwpIHsKICAgICAgZXh0ZXJuYWxIZWFkZXIucHJlZW5jb2RlKHN0YXRlLCBoLmV4dGVybmFsKQogICAgICByZXR1cm4KICAgIH0KICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIGgua2V5KQogICAgaWYgKGgubWFuaWZlc3QpIG1hbmlmZXN0LnByZWVuY29kZShzdGF0ZSwgaC5tYW5pZmVzdCkKICAgIGlmIChoLmtleVBhaXIpIGtleVBhaXIucHJlZW5jb2RlKHN0YXRlLCBoLmtleVBhaXIpCiAgICBrZXlWYWx1ZUFycmF5LnByZWVuY29kZShzdGF0ZSwgaC51c2VyRGF0YSkKICAgIHRyZWVIZWFkZXIucHJlZW5jb2RlKHN0YXRlLCBoLnRyZWUpCiAgICBoaW50cy5wcmVlbmNvZGUoc3RhdGUsIGguaGludHMpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBoKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKQogICAgaWYgKGguZXh0ZXJuYWwpIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMSkgLy8gT05MWSBzZXQgdGhlIGZpcnN0IGJpZyBmb3IgY2xhcml0eQogICAgICBleHRlcm5hbEhlYWRlci5lbmNvZGUoc3RhdGUsIGguZXh0ZXJuYWwpCiAgICAgIHJldHVybgogICAgfQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgKGgubWFuaWZlc3QgPyAyIDogMCkgfCAoaC5rZXlQYWlyID8gNCA6IDApKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgaC5rZXkpCiAgICBpZiAoaC5tYW5pZmVzdCkgbWFuaWZlc3QuZW5jb2RlKHN0YXRlLCBoLm1hbmlmZXN0KQogICAgaWYgKGgua2V5UGFpcikga2V5UGFpci5lbmNvZGUoc3RhdGUsIGgua2V5UGFpcikKICAgIGtleVZhbHVlQXJyYXkuZW5jb2RlKHN0YXRlLCBoLnVzZXJEYXRhKQogICAgdHJlZUhlYWRlci5lbmNvZGUoc3RhdGUsIGgudHJlZSkKICAgIGhpbnRzLmVuY29kZShzdGF0ZSwgaC5oaW50cykKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmICh2ZXJzaW9uID4gMSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgaGVhZGVyIHZlcnNpb24uIEV4cGVjdGVkIDw9IDEsIGdvdCAnICsgdmVyc2lvbikKICAgIH0KCiAgICBpZiAodmVyc2lvbiA9PT0gMCkgewogICAgICBjb25zdCBvbGQgPSB7CiAgICAgICAgdHlwZXM6IHR5cGVzLmRlY29kZShzdGF0ZSksCiAgICAgICAgdXNlckRhdGE6IGtleVZhbHVlQXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgICB0cmVlOiB0cmVlSGVhZGVyLmRlY29kZShzdGF0ZSksCiAgICAgICAgc2lnbmVyOiBrZXlQYWlyLmRlY29kZShzdGF0ZSksCiAgICAgICAgaGludHM6IGhpbnRzLmRlY29kZShzdGF0ZSkKICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICBleHRlcm5hbDogbnVsbCwKICAgICAgICBrZXk6IG9sZC5zaWduZXIucHVibGljS2V5LAogICAgICAgIG1hbmlmZXN0OiB7CiAgICAgICAgICB2ZXJzaW9uOiAwLAogICAgICAgICAgaGFzaDogb2xkLnR5cGVzLnRyZWUsCiAgICAgICAgICBhbGxvd1BhdGNoOiBmYWxzZSwKICAgICAgICAgIHF1b3J1bTogMSwKICAgICAgICAgIHNpZ25lcnM6IFt7CiAgICAgICAgICAgIHNpZ25hdHVyZTogb2xkLnR5cGVzLnNpZ25lciwKICAgICAgICAgICAgbmFtZXNwYWNlOiBERUZBVUxUX05BTUVTUEFDRSwKICAgICAgICAgICAgcHVibGljS2V5OiBvbGQuc2lnbmVyLnB1YmxpY0tleQogICAgICAgICAgfV0sCiAgICAgICAgICBwcm9sb2d1ZTogbnVsbAogICAgICAgIH0sCiAgICAgICAga2V5UGFpcjogb2xkLnNpZ25lci5zZWNyZXRLZXkgPyBvbGQuc2lnbmVyIDogbnVsbCwKICAgICAgICB1c2VyRGF0YTogb2xkLnVzZXJEYXRhLAogICAgICAgIHRyZWU6IG9sZC50cmVlLAogICAgICAgIGhpbnRzOiBvbGQuaGludHMKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAoZmxhZ3MgJiAxKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZXh0ZXJuYWw6IGV4dGVybmFsSGVhZGVyLmRlY29kZShzdGF0ZSksCiAgICAgICAga2V5OiBudWxsLAogICAgICAgIG1hbmlmZXN0OiBudWxsLAogICAgICAgIGtleVBhaXI6IG51bGwsCiAgICAgICAgdXNlckRhdGE6IG51bGwsCiAgICAgICAgdHJlZTogbnVsbCwKICAgICAgICBoaW50czogbnVsbAogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZXh0ZXJuYWw6IG51bGwsCiAgICAgIGtleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIG1hbmlmZXN0OiAoZmxhZ3MgJiAyKSAhPT0gMCA/IG1hbmlmZXN0LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBrZXlQYWlyOiAoZmxhZ3MgJiA0KSAhPT0gMCA/IGtleVBhaXIuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHVzZXJEYXRhOiBrZXlWYWx1ZUFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIHRyZWU6IHRyZWVIZWFkZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgaGludHM6IGhpbnRzLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHVpbnRBcnJheSA9IGMuYXJyYXkoYy51aW50KQoKY29uc3QgbXVsdGlzaWdJbnB1dCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBpbnApIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGlucC5zaWduZXIpCiAgICBjLmZpeGVkNjQucHJlZW5jb2RlKHN0YXRlLCBpbnAuc2lnbmF0dXJlKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgaW5wLnBhdGNoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgaW5wKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBpbnAuc2lnbmVyKQogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgaW5wLnNpZ25hdHVyZSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGlucC5wYXRjaCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHNpZ25lcjogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25hdHVyZTogYy5maXhlZDY0LmRlY29kZShzdGF0ZSksCiAgICAgIHBhdGNoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcGF0Y2hFbmNvZGluZ3YwID0gewogIHByZWVuY29kZSAoc3RhdGUsIG4pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4uc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLmxlbmd0aCkKICAgIHVpbnRBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG4ubm9kZXMpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5sZW5ndGgpCiAgICB1aW50QXJyYXkuZW5jb2RlKHN0YXRlLCBuLm5vZGVzKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBub2RlczogdWludEFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IG11bHRpc2lnSW5wdXR2MCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQrKwogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5zaWduZXIpCiAgICBjLmZpeGVkNjQucHJlZW5jb2RlKHN0YXRlLCBuLnNpZ25hdHVyZSkKICAgIGlmIChuLnBhdGNoKSBwYXRjaEVuY29kaW5ndjAucHJlZW5jb2RlKHN0YXRlLCBuLnBhdGNoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5wYXRjaCA/IDEgOiAwKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5zaWduZXIpCiAgICBjLmZpeGVkNjQuZW5jb2RlKHN0YXRlLCBuLnNpZ25hdHVyZSkKICAgIGlmIChuLnBhdGNoKSBwYXRjaEVuY29kaW5ndjAuZW5jb2RlKHN0YXRlLCBuLnBhdGNoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgc2lnbmVyOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmZpeGVkNjQuZGVjb2RlKHN0YXRlKSwKICAgICAgcGF0Y2g6IChmbGFncyAmIDEpID8gcGF0Y2hFbmNvZGluZ3YwLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBtdWx0aXNpZ0lucHV0QXJyYXl2MCA9IGMuYXJyYXkobXVsdGlzaWdJbnB1dHYwKQpjb25zdCBtdWx0aXNpZ0lucHV0QXJyYXkgPSBjLmFycmF5KG11bHRpc2lnSW5wdXQpCgpjb25zdCBjb21wYWN0Tm9kZSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLmluZGV4KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5zaXplKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbi5oYXNoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5pbmRleCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uc2l6ZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG4uaGFzaCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGluZGV4OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2l6ZTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGhhc2g6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBjb21wYWN0Tm9kZUFycmF5ID0gYy5hcnJheShjb21wYWN0Tm9kZSkKCmV4cG9ydHMubXVsdGlTaWduYXR1cmV2MCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBzKSB7CiAgICBtdWx0aXNpZ0lucHV0QXJyYXl2MC5wcmVlbmNvZGUoc3RhdGUsIHMucHJvb2ZzKQogICAgY29tcGFjdE5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIHMucGF0Y2gpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBzKSB7CiAgICBtdWx0aXNpZ0lucHV0QXJyYXl2MC5lbmNvZGUoc3RhdGUsIHMucHJvb2ZzKQogICAgY29tcGFjdE5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIHMucGF0Y2gpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBwcm9vZnM6IG11bHRpc2lnSW5wdXRBcnJheXYwLmRlY29kZShzdGF0ZSksCiAgICAgIHBhdGNoOiBjb21wYWN0Tm9kZUFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmV4cG9ydHMubXVsdGlTaWduYXR1cmUgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgcykgewogICAgbXVsdGlzaWdJbnB1dEFycmF5LnByZWVuY29kZShzdGF0ZSwgcy5wcm9vZnMpCiAgICBjb21wYWN0Tm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgcy5wYXRjaCkKICB9LAogIGVuY29kZSAoc3RhdGUsIHMpIHsKICAgIG11bHRpc2lnSW5wdXRBcnJheS5lbmNvZGUoc3RhdGUsIHMucHJvb2ZzKQogICAgY29tcGFjdE5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIHMucGF0Y2gpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBwcm9vZnM6IG11bHRpc2lnSW5wdXRBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICBwYXRjaDogY29tcGFjdE5vZGVBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CnsKICAibmFtZSI6ICJoeXBlcmNvcmUtc3RvcmFnZSIsCiAgInZlcnNpb24iOiAiMi40LjEiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYi8qLmpzIiwKICAgICJzcGVjL2h5cGVyc2NoZW1hLyouanMiLAogICAgIm1pZ3JhdGlvbnMvMC8qLmpzIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4gJiYgbHVudGUiLAogICAgInRlc3QiOiAibm9kZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC9hbGwuanMiLAogICAgInRlc3Q6Z2VuZXJhdGUiOiAiYnJpdHRsZSAtciB0ZXN0L2FsbC5qcyB0ZXN0LyouanMiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMuIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiU3RvcmFnZSBlbmdpbmUgZm9yIEh5cGVyY29yZSIsCiAgImltcG9ydHMiOiB7CiAgICAiZnMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZnMiLAogICAgICAiZGVmYXVsdCI6ICJmcyIKICAgIH0sCiAgICAicGF0aCI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1wYXRoIiwKICAgICAgImRlZmF1bHQiOiAicGF0aCIKICAgIH0KICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNyIsCiAgICAiYmFyZS1mcyI6ICJeNC4wLjEiLAogICAgImJhcmUtcGF0aCI6ICJeMy4wLjAiLAogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuMTYuMCIsCiAgICAiZGV2aWNlLWZpbGUiOiAiXjIuMS4yIiwKICAgICJmbGF0LXRyZWUiOiAiXjEuMTIuMSIsCiAgICAiaHlwZXJjb3JlLWNyeXB0byI6ICJeMy40LjIiLAogICAgImh5cGVyc2NoZW1hIjogIl4xLjcuMCIsCiAgICAiaW5kZXgtZW5jb2RlciI6ICJeMy4zLjIiLAogICAgInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiAiXjEuMC4wIiwKICAgICJyb2Nrc2RiLW5hdGl2ZSI6ICJeMy4xMS4wIiwKICAgICJzY29wZS1sb2NrIjogIl4xLjIuNCIsCiAgICAic3RyZWFteCI6ICJeMi4yMS4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjcuMCIsCiAgICAibHVudGUiOiAiXjEuMi4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIiwKICAgICJ0ZXN0LXRtcCI6ICJeMS4zLjEiCiAgfQp9Ci8vIFRoaXMgZmlsZSBpcyBhdXRvZ2VuZXJhdGVkIGJ5IHRoZSBoeXBlcnNjaGVtYSBjb21waWxlcgovLyBTY2hlbWEgVmVyc2lvbjogMQovKiBlc2xpbnQtZGlzYWJsZSBjYW1lbGNhc2UgKi8KLyogZXNsaW50LWRpc2FibGUgcXVvdGVzICovCi8qIGVzbGludC1kaXNhYmxlIHNwYWNlLWJlZm9yZS1mdW5jdGlvbi1wYXJlbiAqLwoKY29uc3QgeyBjIH0gPSByZXF1aXJlKCdoeXBlcnNjaGVtYS9ydW50aW1lJykKCmNvbnN0IFZFUlNJT04gPSAxCgovLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLXZhcnMKbGV0IHZlcnNpb24gPSBWRVJTSU9OCgovLyBAY29yZXN0b3JlL2FsbG9jYXRlZApjb25zdCBlbmNvZGluZzAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmNvcmVzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5kYXRhcykKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5jb3JlcykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZGF0YXMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBjb3JlczogcjAsCiAgICAgIGRhdGFzOiByMQogICAgfQogIH0KfQoKLy8gQGNvcmVzdG9yZS9oZWFkCmNvbnN0IGVuY29kaW5nMSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDQgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0uYWxsb2NhdGVkKSBlbmNvZGluZzAucHJlZW5jb2RlKHN0YXRlLCBtLmFsbG9jYXRlZCkKICAgIGlmIChtLnNlZWQpIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0uc2VlZCkKICAgIGlmIChtLmRlZmF1bHREaXNjb3ZlcnlLZXkpIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0uZGVmYXVsdERpc2NvdmVyeUtleSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPQogICAgICAobS5hbGxvY2F0ZWQgPyAxIDogMCkgfAogICAgICAobS5zZWVkID8gMiA6IDApIHwKICAgICAgKG0uZGVmYXVsdERpc2NvdmVyeUtleSA/IDQgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLmFsbG9jYXRlZCkgZW5jb2RpbmcwLmVuY29kZShzdGF0ZSwgbS5hbGxvY2F0ZWQpCiAgICBpZiAobS5zZWVkKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnNlZWQpCiAgICBpZiAobS5kZWZhdWx0RGlzY292ZXJ5S2V5KSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmRlZmF1bHREaXNjb3ZlcnlLZXkpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiByMCwKICAgICAgYWxsb2NhdGVkOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGVuY29kaW5nMC5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgc2VlZDogKGZsYWdzICYgMikgIT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGRlZmF1bHREaXNjb3ZlcnlLZXk6IChmbGFncyAmIDQpICE9PSAwID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9CgovLyBAY29yZXN0b3JlL2FsaWFzCmNvbnN0IGVuY29kaW5nMiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgbS5uYW1lKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgbS5uYW1lKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy5zdHJpbmcuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IHIwLAogICAgICBuYW1lc3BhY2U6IHIxCiAgICB9CiAgfQp9CgovLyBAY29yZXN0b3JlL2NvcmUKY29uc3QgZW5jb2RpbmczID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5jb3JlUG9pbnRlcikKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZGF0YVBvaW50ZXIpCiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAxIHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLmFsaWFzKSBlbmNvZGluZzIucHJlZW5jb2RlKHN0YXRlLCBtLmFsaWFzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IG0uYWxpYXMgPyAxIDogMAoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uY29yZVBvaW50ZXIpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmRhdGFQb2ludGVyKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0uYWxpYXMpIGVuY29kaW5nMi5lbmNvZGUoc3RhdGUsIG0uYWxpYXMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIyID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiByMCwKICAgICAgY29yZVBvaW50ZXI6IHIxLAogICAgICBkYXRhUG9pbnRlcjogcjIsCiAgICAgIGFsaWFzOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGVuY29kaW5nMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKY29uc3QgZW5jb2Rpbmc0X2VudW0gPSB7CiAgYmxha2UyYjogJ2JsYWtlMmInCn0KCi8vIEBjb3JlL2hhc2hlcyBlbnVtCmNvbnN0IGVuY29kaW5nNCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZW51bSBpcyAwIHNvIGFsd2F5cyBvbmUgYnl0ZQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3dpdGNoIChtKSB7CiAgICAgIGNhc2UgJ2JsYWtlMmInOgogICAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApCiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gZW51bScpCiAgICB9CiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBzd2l0Y2ggKGMudWludC5kZWNvZGUoc3RhdGUpKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICByZXR1cm4gJ2JsYWtlMmInCiAgICAgIGRlZmF1bHQ6IHJldHVybiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBlbmNvZGluZzVfZW51bSA9IHsKICBlZDI1NTE5OiAnZWQyNTUxOScKfQoKLy8gQGNvcmUvc2lnbmF0dXJlcyBlbnVtCmNvbnN0IGVuY29kaW5nNSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZW51bSBpcyAwIHNvIGFsd2F5cyBvbmUgYnl0ZQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3dpdGNoIChtKSB7CiAgICAgIGNhc2UgJ2VkMjU1MTknOgogICAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApCiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gZW51bScpCiAgICB9CiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBzd2l0Y2ggKGMudWludC5kZWNvZGUoc3RhdGUpKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICByZXR1cm4gJ2VkMjU1MTknCiAgICAgIGRlZmF1bHQ6IHJldHVybiBudWxsCiAgICB9CiAgfQp9CgovLyBAY29yZS90cmVlLW5vZGUKY29uc3QgZW5jb2Rpbmc2ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5pbmRleCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc2l6ZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5pbmRleCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc2l6ZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjIgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGluZGV4OiByMCwKICAgICAgc2l6ZTogcjEsCiAgICAgIGhhc2g6IHIyCiAgICB9CiAgfQp9CgovLyBAY29yZS9zaWduZXIKY29uc3QgZW5jb2Rpbmc3ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgZW5jb2Rpbmc1LnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBlbmNvZGluZzUuZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ubmFtZXNwYWNlKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gZW5jb2Rpbmc1LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIyID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBzaWduYXR1cmU6IHIwLAogICAgICBuYW1lc3BhY2U6IHIxLAogICAgICBwdWJsaWNLZXk6IHIyCiAgICB9CiAgfQp9CgovLyBAY29yZS9wcm9sb2d1ZQpjb25zdCBlbmNvZGluZzggPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBoYXNoOiByMCwKICAgICAgbGVuZ3RoOiByMQogICAgfQogIH0KfQoKLy8gQGNvcmUvbWFuaWZlc3Quc2lnbmVycwpjb25zdCBlbmNvZGluZzlfNCA9IGMuYXJyYXkoZW5jb2Rpbmc3KQovLyBAY29yZS9tYW5pZmVzdC5saW5rZWQKY29uc3QgZW5jb2Rpbmc5XzYgPSBjLmFycmF5KGMuZml4ZWQzMikKCi8vIEBjb3JlL21hbmlmZXN0CmNvbnN0IGVuY29kaW5nOSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDggc28gYWx3YXlzIG9uZSBieXRlCiAgICBlbmNvZGluZzQucHJlZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnF1b3J1bSkKICAgIGVuY29kaW5nOV80LnByZWVuY29kZShzdGF0ZSwgbS5zaWduZXJzKQoKICAgIGlmIChtLnByb2xvZ3VlKSBlbmNvZGluZzgucHJlZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlKQogICAgaWYgKG0ubGlua2VkKSBlbmNvZGluZzlfNi5wcmVlbmNvZGUoc3RhdGUsIG0ubGlua2VkKQogICAgaWYgKG0udXNlckRhdGEpIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS51c2VyRGF0YSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPQogICAgICAobS5hbGxvd1BhdGNoID8gMSA6IDApIHwKICAgICAgKG0ucHJvbG9ndWUgPyAyIDogMCkgfAogICAgICAobS5saW5rZWQgPyA0IDogMCkgfAogICAgICAobS51c2VyRGF0YSA/IDggOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgZW5jb2Rpbmc0LmVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5xdW9ydW0pCiAgICBlbmNvZGluZzlfNC5lbmNvZGUoc3RhdGUsIG0uc2lnbmVycykKCiAgICBpZiAobS5wcm9sb2d1ZSkgZW5jb2Rpbmc4LmVuY29kZShzdGF0ZSwgbS5wcm9sb2d1ZSkKICAgIGlmIChtLmxpbmtlZCkgZW5jb2Rpbmc5XzYuZW5jb2RlKHN0YXRlLCBtLmxpbmtlZCkKICAgIGlmIChtLnVzZXJEYXRhKSBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0udXNlckRhdGEpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiByMCwKICAgICAgaGFzaDogZW5jb2Rpbmc0LmRlY29kZShzdGF0ZSksCiAgICAgIHF1b3J1bTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGFsbG93UGF0Y2g6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBzaWduZXJzOiBlbmNvZGluZzlfNC5kZWNvZGUoc3RhdGUpLAogICAgICBwcm9sb2d1ZTogKGZsYWdzICYgMikgIT09IDAgPyBlbmNvZGluZzguZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGxpbmtlZDogKGZsYWdzICYgNCkgIT09IDAgPyBlbmNvZGluZzlfNi5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdXNlckRhdGE6IChmbGFncyAmIDgpICE9PSAwID8gYy5idWZmZXIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCi8vIEBjb3JlL2tleVBhaXIKY29uc3QgZW5jb2RpbmcxMCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0uc2VjcmV0S2V5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnNlY3JldEtleSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBwdWJsaWNLZXk6IHIwLAogICAgICBzZWNyZXRLZXk6IHIxCiAgICB9CiAgfQp9CgovLyBAY29yZS9hdXRoLm1hbmlmZXN0CmNvbnN0IGVuY29kaW5nMTFfMiA9IGMuZnJhbWUoZW5jb2Rpbmc5KQoKLy8gQGNvcmUvYXV0aApjb25zdCBlbmNvZGluZzExID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmRpc2NvdmVyeUtleSkKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDQgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0ubWFuaWZlc3QpIGVuY29kaW5nMTFfMi5wcmVlbmNvZGUoc3RhdGUsIG0ubWFuaWZlc3QpCiAgICBpZiAobS5rZXlQYWlyKSBlbmNvZGluZzEwLnByZWVuY29kZShzdGF0ZSwgbS5rZXlQYWlyKQogICAgaWYgKG0uZW5jcnlwdGlvbktleSkgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLmVuY3J5cHRpb25LZXkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0KICAgICAgKG0ubWFuaWZlc3QgPyAxIDogMCkgfAogICAgICAobS5rZXlQYWlyID8gMiA6IDApIHwKICAgICAgKG0uZW5jcnlwdGlvbktleSA/IDQgOiAwKQoKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5kaXNjb3ZlcnlLZXkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5tYW5pZmVzdCkgZW5jb2RpbmcxMV8yLmVuY29kZShzdGF0ZSwgbS5tYW5pZmVzdCkKICAgIGlmIChtLmtleVBhaXIpIGVuY29kaW5nMTAuZW5jb2RlKHN0YXRlLCBtLmtleVBhaXIpCiAgICBpZiAobS5lbmNyeXB0aW9uS2V5KSBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0uZW5jcnlwdGlvbktleSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGtleTogcjAsCiAgICAgIGRpc2NvdmVyeUtleTogcjEsCiAgICAgIG1hbmlmZXN0OiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGVuY29kaW5nMTFfMi5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAga2V5UGFpcjogKGZsYWdzICYgMikgIT09IDAgPyBlbmNvZGluZzEwLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBlbmNyeXB0aW9uS2V5OiAoZmxhZ3MgJiA0KSAhPT0gMCA/IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9CgovLyBAY29yZS9oZWFkCmNvbnN0IGVuY29kaW5nMTIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmZvcmspCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ucm9vdEhhc2gpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmZvcmspCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucm9vdEhhc2gpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMiA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMyA9IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBmb3JrOiByMCwKICAgICAgbGVuZ3RoOiByMSwKICAgICAgcm9vdEhhc2g6IHIyLAogICAgICBzaWduYXR1cmU6IHIzCiAgICB9CiAgfQp9CgovLyBAY29yZS9oaW50cwpjb25zdCBlbmNvZGluZzEzID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMiBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5jb250aWd1b3VzTGVuZ3RoKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmNvbnRpZ3VvdXNMZW5ndGgpCiAgICBpZiAobS5yZW1vdGVDb250aWd1b3VzTGVuZ3RoKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0KICAgICAgKG0uY29udGlndW91c0xlbmd0aCA/IDEgOiAwKSB8CiAgICAgIChtLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGggPyAyIDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5jb250aWd1b3VzTGVuZ3RoKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmNvbnRpZ3VvdXNMZW5ndGgpCiAgICBpZiAobS5yZW1vdGVDb250aWd1b3VzTGVuZ3RoKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBjb250aWd1b3VzTGVuZ3RoOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMCwKICAgICAgcmVtb3RlQ29udGlndW91c0xlbmd0aDogKGZsYWdzICYgMikgIT09IDAgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCi8vIEBjb3JlL3Nlc3Npb24KY29uc3QgZW5jb2RpbmcxNCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgbS5uYW1lKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5kYXRhUG9pbnRlcikKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCBtLm5hbWUpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmRhdGFQb2ludGVyKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMuc3RyaW5nLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBuYW1lOiByMCwKICAgICAgZGF0YVBvaW50ZXI6IHIxCiAgICB9CiAgfQp9CgovLyBAY29yZS9zZXNzaW9ucwpjb25zdCBlbmNvZGluZzE1ID0gYy5hcnJheShlbmNvZGluZzE0KQoKLy8gQGNvcmUvZGVwZW5kZW5jeQpjb25zdCBlbmNvZGluZzE2ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5kYXRhUG9pbnRlcikKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmRhdGFQb2ludGVyKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBkYXRhUG9pbnRlcjogcjAsCiAgICAgIGxlbmd0aDogcjEKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHNldFZlcnNpb24odikgewogIHZlcnNpb24gPSB2Cn0KCmZ1bmN0aW9uIGVuY29kZShuYW1lLCB2YWx1ZSwgdiA9IFZFUlNJT04pIHsKICB2ZXJzaW9uID0gdgogIHJldHVybiBjLmVuY29kZShnZXRFbmNvZGluZyhuYW1lKSwgdmFsdWUpCn0KCmZ1bmN0aW9uIGRlY29kZShuYW1lLCBidWZmZXIsIHYgPSBWRVJTSU9OKSB7CiAgdmVyc2lvbiA9IHYKICByZXR1cm4gYy5kZWNvZGUoZ2V0RW5jb2RpbmcobmFtZSksIGJ1ZmZlcikKfQoKZnVuY3Rpb24gZ2V0RW51bShuYW1lKSB7CiAgc3dpdGNoIChuYW1lKSB7CiAgICBjYXNlICdAY29yZS9oYXNoZXMnOgogICAgICByZXR1cm4gZW5jb2Rpbmc0X2VudW0KICAgIGNhc2UgJ0Bjb3JlL3NpZ25hdHVyZXMnOgogICAgICByZXR1cm4gZW5jb2Rpbmc1X2VudW0KICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcignRW51bSBub3QgZm91bmQgJyArIG5hbWUpCiAgfQp9CgpmdW5jdGlvbiBnZXRFbmNvZGluZyhuYW1lKSB7CiAgc3dpdGNoIChuYW1lKSB7CiAgICBjYXNlICdAY29yZXN0b3JlL2FsbG9jYXRlZCc6CiAgICAgIHJldHVybiBlbmNvZGluZzAKICAgIGNhc2UgJ0Bjb3Jlc3RvcmUvaGVhZCc6CiAgICAgIHJldHVybiBlbmNvZGluZzEKICAgIGNhc2UgJ0Bjb3Jlc3RvcmUvYWxpYXMnOgogICAgICByZXR1cm4gZW5jb2RpbmcyCiAgICBjYXNlICdAY29yZXN0b3JlL2NvcmUnOgogICAgICByZXR1cm4gZW5jb2RpbmczCiAgICBjYXNlICdAY29yZS9oYXNoZXMnOgogICAgICByZXR1cm4gZW5jb2Rpbmc0CiAgICBjYXNlICdAY29yZS9zaWduYXR1cmVzJzoKICAgICAgcmV0dXJuIGVuY29kaW5nNQogICAgY2FzZSAnQGNvcmUvdHJlZS1ub2RlJzoKICAgICAgcmV0dXJuIGVuY29kaW5nNgogICAgY2FzZSAnQGNvcmUvc2lnbmVyJzoKICAgICAgcmV0dXJuIGVuY29kaW5nNwogICAgY2FzZSAnQGNvcmUvcHJvbG9ndWUnOgogICAgICByZXR1cm4gZW5jb2Rpbmc4CiAgICBjYXNlICdAY29yZS9tYW5pZmVzdCc6CiAgICAgIHJldHVybiBlbmNvZGluZzkKICAgIGNhc2UgJ0Bjb3JlL2tleVBhaXInOgogICAgICByZXR1cm4gZW5jb2RpbmcxMAogICAgY2FzZSAnQGNvcmUvYXV0aCc6CiAgICAgIHJldHVybiBlbmNvZGluZzExCiAgICBjYXNlICdAY29yZS9oZWFkJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTIKICAgIGNhc2UgJ0Bjb3JlL2hpbnRzJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTMKICAgIGNhc2UgJ0Bjb3JlL3Nlc3Npb24nOgogICAgICByZXR1cm4gZW5jb2RpbmcxNAogICAgY2FzZSAnQGNvcmUvc2Vzc2lvbnMnOgogICAgICByZXR1cm4gZW5jb2RpbmcxNQogICAgY2FzZSAnQGNvcmUvZGVwZW5kZW5jeSc6CiAgICAgIHJldHVybiBlbmNvZGluZzE2CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY29kZXIgbm90IGZvdW5kICcgKyBuYW1lKQogIH0KfQoKZnVuY3Rpb24gZ2V0U3RydWN0KG5hbWUsIHYgPSBWRVJTSU9OKSB7CiAgY29uc3QgZW5jID0gZ2V0RW5jb2RpbmcobmFtZSkKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIHZlcnNpb24gPSB2CiAgICAgIGVuYy5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIHZlcnNpb24gPSB2CiAgICAgIGVuYy5lbmNvZGUoc3RhdGUsIG0pCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIHZlcnNpb24gPSB2CiAgICAgIHJldHVybiBlbmMuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVzb2x2ZVN0cnVjdCA9IGdldFN0cnVjdCAvLyBjb21wYXQKCm1vZHVsZS5leHBvcnRzID0gewogIHJlc29sdmVTdHJ1Y3QsCiAgZ2V0U3RydWN0LAogIGdldEVudW0sCiAgZ2V0RW5jb2RpbmcsCiAgZW5jb2RlLAogIGRlY29kZSwKICBzZXRWZXJzaW9uLAogIHZlcnNpb24KfQpjb25zdCB7IEV2ZW50RW1pdHRlciB9ID0gcmVxdWlyZSgnZXZlbnRzJykKY29uc3QgaXNPcHRpb25zID0gcmVxdWlyZSgnaXMtb3B0aW9ucycpCmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBDb3JlU3RvcmFnZSA9IHJlcXVpcmUoJ2h5cGVyY29yZS1zdG9yYWdlJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBOb2lzZVNlY3JldFN0cmVhbSA9IHJlcXVpcmUoJ0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0nKQpjb25zdCBQcm90b211eCA9IHJlcXVpcmUoJ3Byb3RvbXV4JykKY29uc3QgaWQgPSByZXF1aXJlKCdoeXBlcmNvcmUtaWQtZW5jb2RpbmcnKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IHVuc2xhYiA9IHJlcXVpcmUoJ3Vuc2xhYicpCgpjb25zdCBpbnNwZWN0ID0gcmVxdWlyZSgnLi9saWIvaW5zcGVjdCcpCmNvbnN0IENvcmUgPSByZXF1aXJlKCcuL2xpYi9jb3JlJykKY29uc3QgSW5mbyA9IHJlcXVpcmUoJy4vbGliL2luZm8nKQpjb25zdCBEb3dubG9hZCA9IHJlcXVpcmUoJy4vbGliL2Rvd25sb2FkJykKY29uc3QgRGVmYXVsdEVuY3J5cHRpb24gPSByZXF1aXJlKCcuL2xpYi9kZWZhdWx0LWVuY3J5cHRpb24nKQpjb25zdCBjYXBzID0gcmVxdWlyZSgnLi9saWIvY2FwcycpCmNvbnN0IFJlcGxpY2F0b3IgPSByZXF1aXJlKCcuL2xpYi9yZXBsaWNhdG9yJykKY29uc3QgeyBtYW5pZmVzdEhhc2gsIGNyZWF0ZU1hbmlmZXN0IH0gPSByZXF1aXJlKCcuL2xpYi92ZXJpZmllcicpCmNvbnN0IHsgUmVhZFN0cmVhbSwgV3JpdGVTdHJlYW0sIEJ5dGVTdHJlYW0gfSA9IHJlcXVpcmUoJy4vbGliL3N0cmVhbXMnKQpjb25zdCB7IE1lcmtsZVRyZWUgfSA9IHJlcXVpcmUoJy4vbGliL21lcmtsZS10cmVlJykKY29uc3QgewogIEFTU0VSVElPTiwKICBCQURfQVJHVU1FTlQsCiAgU0VTU0lPTl9DTE9TRUQsCiAgU0VTU0lPTl9NT1ZFRCwKICBTRVNTSU9OX05PVF9XUklUQUJMRSwKICBTTkFQU0hPVF9OT1RfQVZBSUxBQkxFLAogIERFQ09ESU5HX0VSUk9SCn0gPSByZXF1aXJlKCdoeXBlcmNvcmUtZXJyb3JzJykKCi8vIEh5cGVyY29yZSBhY3R1YWxseSBkb2VzIG5vdCBoYXZlIGFueSBub3Rpb24gb2YgbWF4L21pbiBibG9jayBzaXplcwovLyBidXQgd2UgZW5mb3JjZSAxNW1iIHRvIGVuc3VyZSBzbW9vdGggcmVwbGljYXRpb24gKGVhY2ggYmxvY2sgaXMgdHJhbnNtaXR0ZWQgYXRvbWljYWxseSkKY29uc3QgTUFYX1NVR0dFU1RFRF9CTE9DS19TSVpFID0gMTUgKiAxMDI0ICogMTAyNAoKY2xhc3MgSHlwZXJjb3JlIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvcihzdG9yYWdlLCBrZXksIG9wdHMpIHsKICAgIHN1cGVyKCkKCiAgICBpZiAoaXNPcHRpb25zKHN0b3JhZ2UpICYmICFzdG9yYWdlLmRiKSB7CiAgICAgIG9wdHMgPSBzdG9yYWdlCiAgICAgIHN0b3JhZ2UgPSBudWxsCiAgICAgIGtleSA9IG9wdHMua2V5IHx8IG51bGwKICAgIH0gZWxzZSBpZiAoaXNPcHRpb25zKGtleSkpIHsKICAgICAgb3B0cyA9IGtleQogICAgICBrZXkgPSBvcHRzLmtleSB8fCBudWxsCiAgICB9CgogICAgaWYgKGtleSAmJiB0eXBlb2Yga2V5ID09PSAnc3RyaW5nJykga2V5ID0gaWQuZGVjb2RlKGtleSkKICAgIGlmICghb3B0cykgb3B0cyA9IHt9CgogICAgaWYgKCFzdG9yYWdlKSBzdG9yYWdlID0gb3B0cy5zdG9yYWdlCgogICAgdGhpcy5jb3JlID0gbnVsbAogICAgdGhpcy5zdGF0ZSA9IG51bGwKICAgIHRoaXMuZW5jcnlwdGlvbiA9IG51bGwKICAgIHRoaXMuZXh0ZW5zaW9ucyA9IG5ldyBNYXAoKQoKICAgIHRoaXMudmFsdWVFbmNvZGluZyA9IG51bGwKICAgIHRoaXMuZW5jb2RlQmF0Y2ggPSBudWxsCiAgICB0aGlzLmFjdGl2ZVJlcXVlc3RzID0gW10KICAgIHRoaXMuc2Vzc2lvbnMgPSBudWxsCiAgICB0aGlzLm9uZ2MgPSBudWxsCgogICAgdGhpcy5rZXlQYWlyID0gb3B0cy5rZXlQYWlyIHx8IG51bGwKICAgIHRoaXMucmVhZGFibGUgPSB0cnVlCiAgICB0aGlzLndyaXRhYmxlID0gZmFsc2UKICAgIHRoaXMuZXhjbHVzaXZlID0gZmFsc2UKICAgIHRoaXMub3BlbmVkID0gZmFsc2UKICAgIHRoaXMuY2xvc2VkID0gZmFsc2UKICAgIHRoaXMud2VhayA9ICEhb3B0cy53ZWFrCiAgICB0aGlzLnNuYXBzaG90dGVkID0gISFvcHRzLnNuYXBzaG90CiAgICB0aGlzLm9uc2VxID0gb3B0cy5vbnNlcSB8fCBudWxsCiAgICB0aGlzLm9ud2FpdCA9IG9wdHMub253YWl0IHx8IG51bGwKICAgIHRoaXMud2FpdCA9IG9wdHMud2FpdCAhPT0gZmFsc2UKICAgIHRoaXMudGltZW91dCA9IG9wdHMudGltZW91dCB8fCAwCiAgICB0aGlzLnByZWxvYWQgPSBudWxsCiAgICB0aGlzLmNsb3NpbmcgPSBudWxsCiAgICB0aGlzLm9wZW5pbmcgPSBudWxsCgogICAgdGhpcy5fcmVhZG9ubHkgPSBvcHRzLndyaXRhYmxlID09PSBmYWxzZQogICAgdGhpcy5fcHJlYXBwZW5kID0gcHJlYXBwZW5kLmJpbmQodGhpcykKICAgIHRoaXMuX3NuYXBzaG90ID0gbnVsbAogICAgdGhpcy5fZmluZGluZ1BlZXJzID0gMAogICAgdGhpcy5fYWN0aXZlID0gb3B0cy53ZWFrID8gISFvcHRzLmFjdGl2ZSA6IG9wdHMuYWN0aXZlICE9PSBmYWxzZQoKICAgIHRoaXMuX3Nlc3Npb25JbmRleCA9IC0xCiAgICB0aGlzLl9zdGF0ZUluZGV4ID0gLTEgLy8gbWFpbnRhaW5lZCBieSBzZXNzaW9uIHN0YXRlCiAgICB0aGlzLl9tb25pdG9ySW5kZXggPSAtMSAvLyBtYWludGFpbmVkIGJ5IHJlcGxpY2F0aW9uIHN0YXRlCgogICAgdGhpcy5vcGVuaW5nID0gdGhpcy5fb3BlbihzdG9yYWdlLCBrZXksIG9wdHMpCiAgICB0aGlzLm9wZW5pbmcuY2F0Y2goc2FmZXR5Q2F0Y2gpCgogICAgdGhpcy5vbignbmV3TGlzdGVuZXInLCBtYXliZUFkZE1vbml0b3IpCiAgfQoKICBbU3ltYm9sLmZvcignbm9kZWpzLnV0aWwuaW5zcGVjdC5jdXN0b20nKV0oZGVwdGgsIG9wdHMpIHsKICAgIHJldHVybiBpbnNwZWN0KHRoaXMsIGRlcHRoLCBvcHRzKQogIH0KCiAgc3RhdGljIE1BWF9TVUdHRVNURURfQkxPQ0tfU0laRSA9IE1BWF9TVUdHRVNURURfQkxPQ0tfU0laRQoKICBzdGF0aWMgRGVmYXVsdEVuY3J5cHRpb24gPSBEZWZhdWx0RW5jcnlwdGlvbgoKICBzdGF0aWMga2V5KG1hbmlmZXN0LCB7IGNvbXBhdCwgdmVyc2lvbiwgbmFtZXNwYWNlIH0gPSB7fSkgewogICAgaWYgKGI0YS5pc0J1ZmZlcihtYW5pZmVzdCkpIHsKICAgICAgbWFuaWZlc3QgPSB7IHZlcnNpb24sIHNpZ25lcnM6IFt7IHB1YmxpY0tleTogbWFuaWZlc3QsIG5hbWVzcGFjZSB9XSB9CiAgICB9CiAgICByZXR1cm4gY29tcGF0ID8gbWFuaWZlc3Quc2lnbmVyc1swXS5wdWJsaWNLZXkgOiBtYW5pZmVzdEhhc2goY3JlYXRlTWFuaWZlc3QobWFuaWZlc3QpKQogIH0KCiAgc3RhdGljIGRpc2NvdmVyeUtleShrZXkpIHsKICAgIHJldHVybiBjcnlwdG8uZGlzY292ZXJ5S2V5KGtleSkKICB9CgogIHN0YXRpYyBibG9ja0VuY3J5cHRpb25LZXkoa2V5LCBlbmNyeXB0aW9uS2V5KSB7CiAgICByZXR1cm4gRGVmYXVsdEVuY3J5cHRpb24uYmxvY2tFbmNyeXB0aW9uS2V5KGtleSwgZW5jcnlwdGlvbktleSkKICB9CgogIHN0YXRpYyBnZXRQcm90b2NvbE11eGVyKHN0cmVhbSkgewogICAgcmV0dXJuIHN0cmVhbS5ub2lzZVN0cmVhbS51c2VyRGF0YQogIH0KCiAgc3RhdGljIGNyZWF0ZUNvcmUoc3RvcmFnZSwgb3B0cykgewogICAgcmV0dXJuIG5ldyBDb3JlKEh5cGVyY29yZS5kZWZhdWx0U3RvcmFnZShzdG9yYWdlKSwgeyBhdXRvQ2xvc2U6IGZhbHNlLCAuLi5vcHRzIH0pCiAgfQoKICBzdGF0aWMgY3JlYXRlUHJvdG9jb2xTdHJlYW0oaXNJbml0aWF0b3IsIG9wdHMgPSB7fSkgewogICAgbGV0IG91dGVyU3RyZWFtID0gUHJvdG9tdXguaXNQcm90b211eChpc0luaXRpYXRvcikKICAgICAgPyBpc0luaXRpYXRvci5zdHJlYW0KICAgICAgOiBpc1N0cmVhbShpc0luaXRpYXRvcikKICAgICAgICA/IGlzSW5pdGlhdG9yCiAgICAgICAgOiBvcHRzLnN0cmVhbQoKICAgIGxldCBub2lzZVN0cmVhbSA9IG51bGwKCiAgICBpZiAob3V0ZXJTdHJlYW0pIHsKICAgICAgbm9pc2VTdHJlYW0gPSBvdXRlclN0cmVhbS5ub2lzZVN0cmVhbQogICAgfSBlbHNlIHsKICAgICAgbm9pc2VTdHJlYW0gPSBuZXcgTm9pc2VTZWNyZXRTdHJlYW0oaXNJbml0aWF0b3IsIG51bGwsIG9wdHMpCiAgICAgIG91dGVyU3RyZWFtID0gbm9pc2VTdHJlYW0ucmF3U3RyZWFtCiAgICB9CiAgICBpZiAoIW5vaXNlU3RyZWFtKSB0aHJvdyBCQURfQVJHVU1FTlQoJ0ludmFsaWQgc3RyZWFtJywgdGhpcy5kaXNjb3ZlcnlLZXkpCgogICAgaWYgKCFub2lzZVN0cmVhbS51c2VyRGF0YSkgewogICAgICBjb25zdCBwcm90b2NvbCA9IFByb3RvbXV4LmZyb20obm9pc2VTdHJlYW0pCgogICAgICBpZiAob3B0cy5rZWVwQWxpdmUgIT09IGZhbHNlICYmIG5vaXNlU3RyZWFtLmtlZXBBbGl2ZSA9PT0gMCkgewogICAgICAgIG5vaXNlU3RyZWFtLnNldEtlZXBBbGl2ZSg1MDAwKQogICAgICB9CiAgICAgIG5vaXNlU3RyZWFtLnVzZXJEYXRhID0gcHJvdG9jb2wKICAgIH0KCiAgICBpZiAob3B0cy5vbmRpc2NvdmVyeWtleSkgewogICAgICBub2lzZVN0cmVhbS51c2VyRGF0YS5wYWlyKHsgcHJvdG9jb2w6ICdoeXBlcmNvcmUvYWxwaGEnIH0sIG9wdHMub25kaXNjb3ZlcnlrZXkpCiAgICB9CgogICAgcmV0dXJuIG91dGVyU3RyZWFtCiAgfQoKICBzdGF0aWMgZGVmYXVsdFN0b3JhZ2Uoc3RvcmFnZSwgb3B0cyA9IHt9KSB7CiAgICBpZiAoQ29yZVN0b3JhZ2UuaXNDb3JlU3RvcmFnZShzdG9yYWdlKSkgcmV0dXJuIHN0b3JhZ2UKCiAgICBjb25zdCBkaXJlY3RvcnkgPSBzdG9yYWdlCiAgICByZXR1cm4gbmV3IENvcmVTdG9yYWdlKGRpcmVjdG9yeSwgb3B0cykKICB9CgogIHN0YXRpYyBjbGVhclJlcXVlc3RzKHNlc3Npb24sIGVycikgewogICAgcmV0dXJuIFJlcGxpY2F0b3IuY2xlYXJSZXF1ZXN0cyhzZXNzaW9uLCBlcnIpCiAgfQoKICBzbmFwc2hvdChvcHRzKSB7CiAgICByZXR1cm4gdGhpcy5zZXNzaW9uKHsgLi4ub3B0cywgc25hcHNob3Q6IHRydWUgfSkKICB9CgogIGNvbXBhY3QoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLmNvbXBhY3QoKQogIH0KCiAgc2Vzc2lvbihvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLmNsb3NpbmcpIHsKICAgICAgLy8gVGhpcyBtYWtlcyB0aGUgY2xvc2luZyBsb2dpYyBhIGxvdCBlYXNpZXIuIElmIHRoaXMgdHVybnMgb3V0IHRvIGJlIGEgcHJvYmxlbQogICAgICAvLyBpbiBwcmFjdGljZSwgb3BlbiBhbiBpc3N1ZSBhbmQgd2UnbGwgdHJ5IHRvIG1ha2UgYSBzb2x1dGlvbiBmb3IgaXQuCiAgICAgIHRocm93IFNFU1NJT05fQ0xPU0VEKCdDYW5ub3QgbWFrZSBzZXNzaW9ucyBvbiBhIGNsb3NpbmcgY29yZScsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQogICAgaWYgKG9wdHMuY2hlY2tvdXQgIT09IHVuZGVmaW5lZCAmJiAhb3B0cy5uYW1lICYmICFvcHRzLmF0b20pIHsKICAgICAgdGhyb3cgQVNTRVJUSU9OKCdDaGVja291dHMgYXJlIG9ubHkgc3VwcG9ydGVkIG9uIGF0b21zIG9yIG5hbWVkIHNlc3Npb25zJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgY29uc3Qgd2FpdCA9IG9wdHMud2FpdCA9PT0gZmFsc2UgPyBmYWxzZSA6IHRoaXMud2FpdAogICAgY29uc3Qgd3JpdGFibGUgPSBvcHRzLndyaXRhYmxlID09PSB1bmRlZmluZWQgPyAhdGhpcy5fcmVhZG9ubHkgOiBvcHRzLndyaXRhYmxlID09PSB0cnVlCiAgICBjb25zdCBvbndhaXQgPSBvcHRzLm9ud2FpdCA9PT0gdW5kZWZpbmVkID8gdGhpcy5vbndhaXQgOiBvcHRzLm9ud2FpdAogICAgY29uc3Qgb25zZXEgPSBvcHRzLm9uc2VxID09PSB1bmRlZmluZWQgPyB0aGlzLm9uc2VxIDogb3B0cy5vbnNlcQogICAgY29uc3QgdGltZW91dCA9IG9wdHMudGltZW91dCA9PT0gdW5kZWZpbmVkID8gdGhpcy50aW1lb3V0IDogb3B0cy50aW1lb3V0CiAgICBjb25zdCB3ZWFrID0gb3B0cy53ZWFrID09PSB1bmRlZmluZWQgPyB0aGlzLndlYWsgOiBvcHRzLndlYWsKICAgIGNvbnN0IENseiA9IG9wdHMuY2xhc3MgfHwgSHlwZXJjb3JlCiAgICBjb25zdCBzID0gbmV3IENseihudWxsLCB0aGlzLmtleSwgewogICAgICAuLi5vcHRzLAogICAgICB3YWl0LAogICAgICBvbndhaXQsCiAgICAgIG9uc2VxLAogICAgICB0aW1lb3V0LAogICAgICB3cml0YWJsZSwKICAgICAgd2VhaywKICAgICAgcGFyZW50OiB0aGlzCiAgICB9KQoKICAgIHJldHVybiBzCiAgfQoKICBhc3luYyBzZXRFbmNyeXB0aW9uS2V5KGtleSwgb3B0cykgewogICAgaWYgKCF0aGlzLm9wZW5lZCkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBjb25zdCBlbmNyeXB0aW9uID0gdGhpcy5fZ2V0RW5jcnlwdGlvblByb3ZpZGVyKHsga2V5LCBibG9jazogISEob3B0cyAmJiBvcHRzLmJsb2NrKSB9KQogICAgcmV0dXJuIHRoaXMuc2V0RW5jcnlwdGlvbihlbmNyeXB0aW9uKQogIH0KCiAgYXN5bmMgc2V0RW5jcnlwdGlvbihlbmNyeXB0aW9uKSB7CiAgICBpZiAoIXRoaXMub3BlbmVkKSBhd2FpdCB0aGlzLm9wZW5pbmcKCiAgICBpZiAoZW5jcnlwdGlvbiA9PT0gbnVsbCkgewogICAgICB0aGlzLmVuY3J5cHRpb24gPSBlbmNyeXB0aW9uCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICghaXNFbmNyeXB0aW9uUHJvdmlkZXIoZW5jcnlwdGlvbikpIHsKICAgICAgdGhyb3cgQVNTRVJUSU9OKCdQcm92aWRlciBkb2VzIG5vdCBzYXRpc2Z5IEh5cGVyY29yZUVuY3J5cHRpb24gaW50ZXJmYWNlJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgdGhpcy5lbmNyeXB0aW9uID0gZW5jcnlwdGlvbgogIH0KCiAgc2V0S2V5UGFpcihrZXlQYWlyKSB7CiAgICB0aGlzLmtleVBhaXIgPSBrZXlQYWlyCiAgfQoKICBzZXRBY3RpdmUoYm9vbCkgewogICAgY29uc3QgYWN0aXZlID0gISFib29sCiAgICBpZiAoYWN0aXZlID09PSB0aGlzLl9hY3RpdmUgfHwgdGhpcy5jbG9zaW5nKSByZXR1cm4KICAgIHRoaXMuX2FjdGl2ZSA9IGFjdGl2ZQogICAgaWYgKCF0aGlzLm9wZW5lZCkgcmV0dXJuCiAgICB0aGlzLmNvcmUucmVwbGljYXRvci51cGRhdGVBY3Rpdml0eSh0aGlzLl9hY3RpdmUgPyAxIDogLTEpCiAgfQoKICBhc3luYyBfb3BlbihzdG9yYWdlLCBrZXksIG9wdHMpIHsKICAgIGNvbnN0IHByZWxvYWQgPSBvcHRzLnByZWxvYWQgfHwgKG9wdHMucGFyZW50ICYmIG9wdHMucGFyZW50LnByZWxvYWQpCgogICAgaWYgKHByZWxvYWQpIHsKICAgICAgdGhpcy5zZXNzaW9ucyA9IFtdIC8vIGluIGNhc2Ugc29tZW9uZSBsb29rcyBhdCBpdCBsaWtlIHdpdGggcGVlcnMKICAgICAgdGhpcy5wcmVsb2FkID0gcHJlbG9hZAogICAgICBvcHRzID0geyAuLi5vcHRzLCAuLi4oYXdhaXQgdGhpcy5wcmVsb2FkKSB9CiAgICAgIHRoaXMucHJlbG9hZCA9IG51bGwKICAgIH0KCiAgICBjb25zdCBwYXJlbnQgPSBvcHRzLnBhcmVudCB8fCBudWxsCiAgICBjb25zdCBjb3JlID0gb3B0cy5jb3JlIHx8IChwYXJlbnQgJiYgcGFyZW50LmNvcmUpCiAgICBjb25zdCBzZXNzaW9ucyA9IG9wdHMuc2Vzc2lvbnMgfHwgKHBhcmVudCAmJiBwYXJlbnQuc2Vzc2lvbnMpCiAgICBjb25zdCBvbmdjID0gb3B0cy5vbmdjIHx8IChwYXJlbnQgJiYgcGFyZW50Lm9uZ2MpCgogICAgaWYgKGNvcmUpIHRoaXMuY29yZSA9IGNvcmUKICAgIGlmIChvbmdjKSB0aGlzLm9uZ2MgPSBvbmdjCiAgICBpZiAoc2Vzc2lvbnMpIHRoaXMuc2Vzc2lvbnMgPSBzZXNzaW9ucwoKICAgIGlmICh0aGlzLnNlc3Npb25zID09PSBudWxsKSB0aGlzLnNlc3Npb25zID0gW10KICAgIHRoaXMuX3Nlc3Npb25JbmRleCA9IHRoaXMuc2Vzc2lvbnMucHVzaCh0aGlzKSAtIDEKCiAgICBpZiAodGhpcy5jb3JlID09PSBudWxsKSBpbml0T25jZSh0aGlzLCBzdG9yYWdlLCBrZXksIG9wdHMpCiAgICBpZiAodGhpcy5fbW9uaXRvckluZGV4ID09PSAtMikgdGhpcy5jb3JlLmFkZE1vbml0b3IodGhpcykKCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9vcGVuU2Vzc2lvbihvcHRzKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmICh0aGlzLmNvcmUuYXV0b0Nsb3NlICYmIHRoaXMuY29yZS5oYXNTZXNzaW9uKCkgPT09IGZhbHNlKSBhd2FpdCB0aGlzLmNvcmUuY2xvc2UoKQoKICAgICAgaWYgKHRoaXMuZXhjbHVzaXZlKSB0aGlzLmNvcmUudW5sb2NrRXhjbHVzaXZlKCkKCiAgICAgIHRoaXMuY29yZS5yZW1vdmVNb25pdG9yKHRoaXMpCiAgICAgIHRoaXMuX3JlbW92ZVNlc3Npb24oKQoKICAgICAgaWYgKHRoaXMuc3RhdGUgIT09IG51bGwpIHRoaXMuc3RhdGUucmVtb3ZlU2Vzc2lvbih0aGlzKQoKICAgICAgdGhpcy5jbG9zZWQgPSB0cnVlCiAgICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogICAgICB0aHJvdyBlcnIKICAgIH0KCiAgICB0aGlzLmVtaXQoJ3JlYWR5JykKCiAgICAvLyBpZiB3ZSBhcmUgYSB3ZWFrIHNlc3Npb24gdGhlIGNvcmUgbWlnaHQgaGF2ZSBjbG9zZWQuLi4KICAgIGlmICh0aGlzLmNvcmUuY2xvc2luZykgdGhpcy5jbG9zZSgpLmNhdGNoKHNhZmV0eUNhdGNoKQogIH0KCiAgX3JlbW92ZVNlc3Npb24oKSB7CiAgICBpZiAodGhpcy5fc2Vzc2lvbkluZGV4ID09PSAtMSkgcmV0dXJuCiAgICBjb25zdCBoZWFkID0gdGhpcy5zZXNzaW9ucy5wb3AoKQogICAgaWYgKGhlYWQgIT09IHRoaXMpIHRoaXMuc2Vzc2lvbnNbKGhlYWQuX3Nlc3Npb25JbmRleCA9IHRoaXMuX3Nlc3Npb25JbmRleCldID0gaGVhZAogICAgdGhpcy5fc2Vzc2lvbkluZGV4ID0gLTEKICAgIGlmICh0aGlzLm9uZ2MgIT09IG51bGwpIHRoaXMub25nYyh0aGlzKQogIH0KCiAgYXN5bmMgX29wZW5TZXNzaW9uKG9wdHMpIHsKICAgIGlmICh0aGlzLmNvcmUub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKCiAgICBpZiAodGhpcy5rZXlQYWlyID09PSBudWxsKSB0aGlzLmtleVBhaXIgPSBvcHRzLmtleVBhaXIgfHwgdGhpcy5jb3JlLmhlYWRlci5rZXlQYWlyCgogICAgY29uc3QgcGFyZW50ID0gb3B0cy5wYXJlbnQgfHwgbnVsbAogICAgaWYgKHBhcmVudCAmJiBwYXJlbnQuZW5jcnlwdGlvbikgdGhpcy5lbmNyeXB0aW9uID0gcGFyZW50LmVuY3J5cHRpb24KCiAgICBjb25zdCBlID0gZ2V0RW5jcnlwdGlvbk9wdGlvbihvcHRzKQogICAgaWYgKCF0aGlzLmVuY3J5cHRpb24pIHRoaXMuZW5jcnlwdGlvbiA9IHRoaXMuX2dldEVuY3J5cHRpb25Qcm92aWRlcihlKQoKICAgIHRoaXMud3JpdGFibGUgPSB0aGlzLl9pc1dyaXRhYmxlKCkKCiAgICBpZiAob3B0cy52YWx1ZUVuY29kaW5nKSB7CiAgICAgIHRoaXMudmFsdWVFbmNvZGluZyA9IGMuZnJvbShvcHRzLnZhbHVlRW5jb2RpbmcpCiAgICB9CiAgICBpZiAob3B0cy5lbmNvZGVCYXRjaCkgewogICAgICB0aGlzLmVuY29kZUJhdGNoID0gb3B0cy5lbmNvZGVCYXRjaAogICAgfQoKICAgIGlmIChwYXJlbnQpIHsKICAgICAgaWYgKHBhcmVudC5fc3RhdGVJbmRleCA9PT0gLTEpIGF3YWl0IHBhcmVudC5yZWFkeSgpCiAgICAgIGlmICghdGhpcy5rZXlQYWlyKSB0aGlzLmtleVBhaXIgPSBwYXJlbnQua2V5UGFpcgoKICAgICAgY29uc3QgcHMgPSBwYXJlbnQuc3RhdGUKCiAgICAgIGlmIChwcykgewogICAgICAgIGNvbnN0IHNob3VsZFNuYXBzaG90ID0gdGhpcy5zbmFwc2hvdHRlZCAmJiAhcHMuaXNTbmFwc2hvdCgpCiAgICAgICAgdGhpcy5zdGF0ZSA9IHNob3VsZFNuYXBzaG90ID8gYXdhaXQgcHMuc25hcHNob3QoKSA6IHBzLnJlZigpCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnNuYXBzaG90dGVkICYmIHRoaXMuY29yZSAmJiAhdGhpcy5fc25hcHNob3QpIHsKICAgICAgICB0aGlzLl91cGRhdGVTbmFwc2hvdCgpCiAgICAgIH0KICAgIH0KCiAgICBpZiAob3B0cy5leGNsdXNpdmUgJiYgb3B0cy53cml0YWJsZSAhPT0gZmFsc2UpIHsKICAgICAgdGhpcy5leGNsdXNpdmUgPSB0cnVlCiAgICAgIGF3YWl0IHRoaXMuY29yZS5sb2NrRXhjbHVzaXZlKCkKICAgIH0KCiAgICBjb25zdCBwYXJlbnRTdGF0ZSA9IHBhcmVudCA/IHBhcmVudC5zdGF0ZSA6IHRoaXMuY29yZS5zdGF0ZQogICAgY29uc3QgY2hlY2tvdXQgPSBvcHRzLmNoZWNrb3V0ID09PSB1bmRlZmluZWQgPyAtMSA6IG9wdHMuY2hlY2tvdXQKICAgIGNvbnN0IHN0YXRlID0gdGhpcy5zdGF0ZQoKICAgIGlmIChvcHRzLmF0b20pIHsKICAgICAgdGhpcy5zdGF0ZSA9IGF3YWl0IHBhcmVudFN0YXRlLmNyZWF0ZVNlc3Npb24obnVsbCwgZmFsc2UsIG9wdHMuYXRvbSkKICAgICAgaWYgKHN0YXRlKSBzdGF0ZS51bnJlZigpCiAgICB9IGVsc2UgaWYgKG9wdHMubmFtZSkgewogICAgICAvLyB0b2RvOiBuZWVkIHRvIG1ha2UgbmFtZWQgc2Vzc2lvbnMgc2FmZSBiZWZvcmUgcmVhZHkKICAgICAgLy8gYXRtIHdlIGFsd2F5cyBjb3B5IHRoZSBzdGF0ZSBpbiBwYXNzQ2FwYWJpbGl0aWVzCiAgICAgIHRoaXMuc3RhdGUgPSBhd2FpdCBwYXJlbnRTdGF0ZS5jcmVhdGVTZXNzaW9uKG9wdHMubmFtZSwgISFvcHRzLm92ZXJ3cml0ZSwgbnVsbCkKICAgICAgaWYgKHN0YXRlKSBzdGF0ZS51bnJlZigpIC8vIHJlZidlZCBhYm92ZSBpbiBzZXR1cCBzZXNzaW9uCiAgICB9CgogICAgaWYgKHRoaXMuc3RhdGUgJiYgY2hlY2tvdXQgIT09IC0xKSB7CiAgICAgIGlmICghb3B0cy5uYW1lICYmICFvcHRzLmF0b20pIHsKICAgICAgICB0aHJvdyBBU1NFUlRJT04oJ0NoZWNrb3V0cyBtdXN0IGJlIG5hbWVkIG9yIGF0b21pemVkJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICAgIH0KICAgICAgaWYgKGNoZWNrb3V0ID4gdGhpcy5zdGF0ZS5sZW5ndGgpIHsKICAgICAgICB0aHJvdyBBU1NFUlRJT04oCiAgICAgICAgICBgSW52YWxpZCBjaGVja291dCAke2NoZWNrb3V0fSBmb3IgJHtvcHRzLm5hbWV9LCBsZW5ndGggaXMgJHt0aGlzLnN0YXRlLmxlbmd0aH1gLAogICAgICAgICAgdGhpcy5kaXNjb3ZlcnlLZXkKICAgICAgICApCiAgICAgIH0KICAgICAgaWYgKHRoaXMuc3RhdGUucHJvbG9ndWUgJiYgY2hlY2tvdXQgPCB0aGlzLnN0YXRlLnByb2xvZ3VlLmxlbmd0aCkgewogICAgICAgIHRocm93IEFTU0VSVElPTigKICAgICAgICAgIGBJbnZhbGlkIGNoZWNrb3V0ICR7Y2hlY2tvdXR9IGZvciAke29wdHMubmFtZX0sIHByb2xvZ3VlIGxlbmd0aCBpcyAke3RoaXMuc3RhdGUucHJvbG9ndWUubGVuZ3RofWAsCiAgICAgICAgICB0aGlzLmRpc2NvdmVyeUtleQogICAgICAgICkKICAgICAgfQogICAgICBpZiAoY2hlY2tvdXQgPCB0aGlzLnN0YXRlLmxlbmd0aCkgYXdhaXQgdGhpcy5zdGF0ZS50cnVuY2F0ZShjaGVja291dCwgdGhpcy5mb3JrKQogICAgfQoKICAgIGlmICh0aGlzLnN0YXRlID09PSBudWxsKSB7CiAgICAgIHRoaXMuc3RhdGUgPSB0aGlzLmNvcmUuc3RhdGUucmVmKCkKICAgIH0KCiAgICB0aGlzLndyaXRhYmxlID0gdGhpcy5faXNXcml0YWJsZSgpCgogICAgaWYgKHRoaXMuc25hcHNob3R0ZWQgJiYgdGhpcy5jb3JlKSB0aGlzLl91cGRhdGVTbmFwc2hvdCgpCgogICAgdGhpcy5zdGF0ZS5hZGRTZXNzaW9uKHRoaXMpCiAgICAvLyBUT0RPOiB3ZSBuZWVkIHRvIHJld29yayB0aGUgY29yZSByZWZlcmVuY2UgZmxvdywgYXMgdGhlIHN0YXRlIGFuZCBzZXNzaW9uIGRvIG5vdCBhbHdheXMgYWdyZWUgbm93IGR1ZSB0byBtb3ZlVG8KICAgIHRoaXMuY29yZSA9IHRoaXMuc3RhdGUuY29yZSAvLyBpbiBjYXNlIGl0IHdhcyB3cm9uZy4uLgoKICAgIGlmIChvcHRzLnVzZXJEYXRhKSB7CiAgICAgIGNvbnN0IHR4ID0gdGhpcy5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMob3B0cy51c2VyRGF0YSkpIHsKICAgICAgICB0eC5wdXRVc2VyRGF0YShrZXksIHZhbHVlKQogICAgICB9CiAgICAgIGF3YWl0IHR4LmZsdXNoKCkKICAgIH0KCiAgICBpZiAob3B0cy5tYW5pZmVzdCAmJiAhdGhpcy5jb3JlLmhlYWRlci5tYW5pZmVzdCkgewogICAgICBhd2FpdCB0aGlzLmNvcmUuc2V0TWFuaWZlc3QoY3JlYXRlTWFuaWZlc3Qob3B0cy5tYW5pZmVzdCkpCiAgICB9CgogICAgdGhpcy5jb3JlLnJlcGxpY2F0b3IudXBkYXRlQWN0aXZpdHkodGhpcy5fYWN0aXZlID8gMSA6IDApCgogICAgdGhpcy5vcGVuZWQgPSB0cnVlCiAgfQoKICBnZXQgcmVwbGljYXRvcigpIHsKICAgIHJldHVybiB0aGlzLmNvcmUgPT09IG51bGwgPyBudWxsIDogdGhpcy5jb3JlLnJlcGxpY2F0b3IKICB9CgogIF9nZXRTbmFwc2hvdCgpIHsKICAgIHJldHVybiB7CiAgICAgIGxlbmd0aDogdGhpcy5zdGF0ZS5sZW5ndGgsCiAgICAgIGJ5dGVMZW5ndGg6IHRoaXMuc3RhdGUuYnl0ZUxlbmd0aCwKICAgICAgZm9yazogdGhpcy5zdGF0ZS5mb3JrCiAgICB9CiAgfQoKICBfdXBkYXRlU25hcHNob3QoKSB7CiAgICBjb25zdCBwcmV2ID0gdGhpcy5fc25hcHNob3QKICAgIGNvbnN0IG5leHQgPSAodGhpcy5fc25hcHNob3QgPSB0aGlzLl9nZXRTbmFwc2hvdCgpKQoKICAgIGlmICghcHJldikgcmV0dXJuIHRydWUKICAgIHJldHVybiBwcmV2Lmxlbmd0aCAhPT0gbmV4dC5sZW5ndGggfHwgcHJldi5mb3JrICE9PSBuZXh0LmZvcmsKICB9CgogIF9pc1dyaXRhYmxlKCkgewogICAgaWYgKHRoaXMuX3JlYWRvbmx5KSByZXR1cm4gZmFsc2UKICAgIGlmICh0aGlzLnN0YXRlICYmICF0aGlzLnN0YXRlLmlzRGVmYXVsdCgpKSByZXR1cm4gdHJ1ZQogICAgcmV0dXJuICEhKHRoaXMua2V5UGFpciAmJiB0aGlzLmtleVBhaXIuc2VjcmV0S2V5KQogIH0KCiAgY2xvc2UoeyBlcnJvciB9ID0ge30pIHsKICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybiB0aGlzLmNsb3NpbmcKCiAgICB0aGlzLmNsb3NpbmcgPSB0aGlzLl9jbG9zZShlcnJvciB8fCBudWxsKQogICAgcmV0dXJuIHRoaXMuY2xvc2luZwogIH0KCiAgY2xlYXJSZXF1ZXN0cyhhY3RpdmVSZXF1ZXN0cywgZXJyb3IpIHsKICAgIGlmICghYWN0aXZlUmVxdWVzdHMubGVuZ3RoKSByZXR1cm4KICAgIGlmICh0aGlzLmNvcmUpIHRoaXMuY29yZS5yZXBsaWNhdG9yLmNsZWFyUmVxdWVzdHMoYWN0aXZlUmVxdWVzdHMsIGVycm9yKQogIH0KCiAgYXN5bmMgX2Nsb3NlKGVycm9yKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmICghdGhpcy5jbG9zZWQpIHRocm93IGVycgogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMuY2xvc2VkID09PSB0cnVlKSByZXR1cm4KCiAgICB0aGlzLmNvcmUucmVtb3ZlTW9uaXRvcih0aGlzKQogICAgdGhpcy5zdGF0ZS5yZW1vdmVTZXNzaW9uKHRoaXMpCiAgICB0aGlzLl9yZW1vdmVTZXNzaW9uKCkKCiAgICB0aGlzLnJlYWRhYmxlID0gZmFsc2UKICAgIHRoaXMud3JpdGFibGUgPSBmYWxzZQogICAgdGhpcy5vcGVuZWQgPSBmYWxzZQoKICAgIGNvbnN0IGdjID0gW10KICAgIGZvciAoY29uc3QgZXh0IG9mIHRoaXMuZXh0ZW5zaW9ucy52YWx1ZXMoKSkgewogICAgICBpZiAoZXh0LnNlc3Npb24gPT09IHRoaXMpIGdjLnB1c2goZXh0KQogICAgfQogICAgZm9yIChjb25zdCBleHQgb2YgZ2MpIGV4dC5kZXN0cm95KCkKCiAgICB0aGlzLmNvcmUucmVwbGljYXRvci5maW5kaW5nUGVlcnMgLT0gdGhpcy5fZmluZGluZ1BlZXJzCiAgICB0aGlzLmNvcmUucmVwbGljYXRvci5jbGVhclJlcXVlc3RzKHRoaXMuYWN0aXZlUmVxdWVzdHMsIGVycm9yKQogICAgdGhpcy5jb3JlLnJlcGxpY2F0b3IudXBkYXRlQWN0aXZpdHkodGhpcy5fYWN0aXZlID8gLTEgOiAwKQoKICAgIHRoaXMuX2ZpbmRpbmdQZWVycyA9IDAKCiAgICB0aGlzLnN0YXRlLnVucmVmKCkKCiAgICBpZiAodGhpcy5leGNsdXNpdmUpIHRoaXMuY29yZS51bmxvY2tFeGNsdXNpdmUoKQoKICAgIGlmICh0aGlzLmNvcmUuaGFzU2Vzc2lvbigpKSB7CiAgICAgIC8vIGVtaXQgImZha2UiIGNsb3NlIGFzIHRoaXMgaXMgYSBzZXNzaW9uCiAgICAgIHRoaXMuY2xvc2VkID0gdHJ1ZQogICAgICB0aGlzLmVtaXQoJ2Nsb3NlJykKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMuY29yZS5hdXRvQ2xvc2UpIGF3YWl0IHRoaXMuY29yZS5jbG9zZSgpCgogICAgdGhpcy5jbG9zZWQgPSB0cnVlCiAgICB0aGlzLmVtaXQoJ2Nsb3NlJykKICB9CgogIGFzeW5jIGNvbW1pdChzZXNzaW9uLCBvcHRzKSB7CiAgICBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGF3YWl0IHNlc3Npb24ucmVhZHkoKQoKICAgIHJldHVybiB0aGlzLnN0YXRlLmNvbW1pdChzZXNzaW9uLnN0YXRlLCB7IGtleVBhaXI6IHRoaXMua2V5UGFpciwgLi4ub3B0cyB9KQogIH0KCiAgcmVwbGljYXRlKGlzSW5pdGlhdG9yLCBvcHRzID0ge30pIHsKICAgIC8vIE9ubHkgbGltaXRhdGlvbiBoZXJlIGlzIHRoYXQgb25kaXNjb3ZlcnlrZXkgZG9lc24ndCB3b3JrIGF0bSB3aGVuIHBhc3NpbmcgYSBtdXhlciBkaXJlY3RseSwKICAgIC8vIGJlY2F1c2UgaXQgZG9lc24ndCByZWFsbHkgbWFrZSBhIGxvdCBvZiBzZW5zZS4KICAgIGlmIChQcm90b211eC5pc1Byb3RvbXV4KGlzSW5pdGlhdG9yKSkgcmV0dXJuIHRoaXMuX2F0dGFjaFRvTXV4ZXIoaXNJbml0aWF0b3IpCgogICAgLy8gaWYgc2FtZSBzdHJlYW0gaXMgcGFzc2VkIHR3aWNlLCBpZ25vcmUgdGhlIDJuZCBvbmUgYmVmb3JlIHdlIG1ha2Ugc2Vzc2lvbnMgZXRjCiAgICBpZiAoaXNTdHJlYW0oaXNJbml0aWF0b3IpICYmIHRoaXMuX2lzQXR0YWNoZWQoaXNJbml0aWF0b3IpKSByZXR1cm4gaXNJbml0aWF0b3IKCiAgICBjb25zdCBwcm90b2NvbFN0cmVhbSA9IEh5cGVyY29yZS5jcmVhdGVQcm90b2NvbFN0cmVhbShpc0luaXRpYXRvciwgb3B0cykKICAgIGNvbnN0IG5vaXNlU3RyZWFtID0gcHJvdG9jb2xTdHJlYW0ubm9pc2VTdHJlYW0KICAgIGNvbnN0IHByb3RvY29sID0gbm9pc2VTdHJlYW0udXNlckRhdGEKCiAgICB0aGlzLl9hdHRhY2hUb011eGVyKHByb3RvY29sKQoKICAgIHJldHVybiBwcm90b2NvbFN0cmVhbQogIH0KCiAgX2lzQXR0YWNoZWQoc3RyZWFtKSB7CiAgICByZXR1cm4gKAogICAgICBzdHJlYW0udXNlckRhdGEgJiYKICAgICAgdGhpcy5jb3JlICYmCiAgICAgIHRoaXMuY29yZS5yZXBsaWNhdG9yICYmCiAgICAgIHRoaXMuY29yZS5yZXBsaWNhdG9yLmF0dGFjaGVkKHN0cmVhbS51c2VyRGF0YSkKICAgICkKICB9CgogIF9hdHRhY2hUb011eGVyKG11eCkgewogICAgaWYgKHRoaXMub3BlbmVkKSB7CiAgICAgIHRoaXMuY29yZS5yZXBsaWNhdG9yLmF0dGFjaFRvKG11eCkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMub3BlbmluZy50aGVuKCgpID0+IHRoaXMuY29yZS5yZXBsaWNhdG9yLmF0dGFjaFRvKG11eCksIG11eC5kZXN0cm95LmJpbmQobXV4KSkKICAgIH0KCiAgICByZXR1cm4gbXV4CiAgfQoKICBnZXQgaWQoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlID09PSBudWxsID8gbnVsbCA6IHRoaXMuY29yZS5pZAogIH0KCiAgZ2V0IGtleSgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUgPT09IG51bGwgPyBudWxsIDogdGhpcy5jb3JlLmtleQogIH0KCiAgZ2V0IGRpc2NvdmVyeUtleSgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUgPT09IG51bGwgPyBudWxsIDogdGhpcy5jb3JlLmRpc2NvdmVyeUtleQogIH0KCiAgZ2V0IG1hbmlmZXN0KCkgewogICAgcmV0dXJuIHRoaXMuY29yZSA9PT0gbnVsbCA/IG51bGwgOiB0aGlzLmNvcmUubWFuaWZlc3QKICB9CgogIGdldCBsZW5ndGgoKSB7CiAgICBpZiAodGhpcy5fc25hcHNob3QpIHJldHVybiB0aGlzLl9zbmFwc2hvdC5sZW5ndGgKICAgIHJldHVybiB0aGlzLm9wZW5lZCA9PT0gZmFsc2UgPyAwIDogdGhpcy5zdGF0ZS5sZW5ndGgKICB9CgogIGdldCBzaWduZWRMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5vcGVuZWQgPT09IGZhbHNlID8gMCA6IHRoaXMuc3RhdGUuc2lnbmVkTGVuZ3RoKCkKICB9CgogIC8qKgogICAqIERlcHJlY2F0ZWQuIFVzZSBgY29uc3QgeyBieXRlTGVuZ3RoIH0gPSBhd2FpdCBjb3JlLmluZm8oKWAuCiAgICovCiAgZ2V0IGJ5dGVMZW5ndGgoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSByZXR1cm4gMAogICAgaWYgKHRoaXMuX3NuYXBzaG90KSByZXR1cm4gdGhpcy5fc25hcHNob3QuYnl0ZUxlbmd0aAogICAgcmV0dXJuIHRoaXMuc3RhdGUuYnl0ZUxlbmd0aCAtIHRoaXMuc3RhdGUubGVuZ3RoICogdGhpcy5wYWRkaW5nCiAgfQoKICBnZXQgcmVtb3RlQ29udGlndW91c0xlbmd0aCgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIHJldHVybiAwCiAgICByZXR1cm4gTWF0aC5taW4odGhpcy5jb3JlLnN0YXRlLmxlbmd0aCwgdGhpcy5jb3JlLmhlYWRlci5oaW50cy5yZW1vdGVDb250aWd1b3VzTGVuZ3RoKQogIH0KCiAgZ2V0IGNvbnRpZ3VvdXNMZW5ndGgoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSByZXR1cm4gMAogICAgcmV0dXJuIE1hdGgubWluKHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgsIHRoaXMuY29yZS5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCkKICB9CgogIGdldCBjb250aWd1b3VzQnl0ZUxlbmd0aCgpIHsKICAgIHJldHVybiAwCiAgfQoKICBnZXQgZm9yaygpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIHJldHVybiAwCiAgICByZXR1cm4gdGhpcy5zdGF0ZS5mb3JrCiAgfQoKICBnZXQgcGFkZGluZygpIHsKICAgIGlmICh0aGlzLmVuY3J5cHRpb24gJiYgdGhpcy5rZXkgJiYgdGhpcy5tYW5pZmVzdCkgewogICAgICByZXR1cm4gdGhpcy5lbmNyeXB0aW9uLnBhZGRpbmcodGhpcy5jb3JlLCB0aGlzLmxlbmd0aCkKICAgIH0KCiAgICByZXR1cm4gMAogIH0KCiAgZ2V0IHBlZXJzKCkgewogICAgcmV0dXJuIHRoaXMub3BlbmVkID09PSBmYWxzZSA/IFtdIDogdGhpcy5jb3JlLnJlcGxpY2F0b3IucGVlcnMKICB9CgogIGdldCBnbG9iYWxDYWNoZSgpIHsKICAgIHJldHVybiB0aGlzLm9wZW5lZCA9PT0gZmFsc2UgPyBudWxsIDogdGhpcy5jb3JlLmdsb2JhbENhY2hlCiAgfQoKICByZWFkeSgpIHsKICAgIHJldHVybiB0aGlzLm9wZW5pbmcKICB9CgogIGFzeW5jIHNldFVzZXJEYXRhKGtleSwgdmFsdWUpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCB0aGlzLmdldFVzZXJEYXRhKGtleSkKICAgIGlmIChleGlzdGluZyAmJiBiNGEuaXNCdWZmZXIodmFsdWUpICYmIGI0YS5lcXVhbHMoZXhpc3RpbmcsIHZhbHVlKSkgcmV0dXJuCiAgICBhd2FpdCB0aGlzLnN0YXRlLnNldFVzZXJEYXRhKGtleSwgdmFsdWUpCiAgfQoKICBhc3luYyBnZXRVc2VyRGF0YShrZXkpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgY29uc3QgYmF0Y2ggPSB0aGlzLnN0YXRlLnN0b3JhZ2UucmVhZCgpCiAgICBjb25zdCBwID0gYmF0Y2guZ2V0VXNlckRhdGEoa2V5KQogICAgYmF0Y2gudHJ5Rmx1c2goKQogICAgcmV0dXJuIHAKICB9CgogIHRyYW5zZmVyU2Vzc2lvbihjb3JlKSB7CiAgICAvLyB0b2RvOiB2YWxpZGF0ZSB3ZSBjYW4gbW92ZQoKICAgIGlmICh0aGlzLndlYWsgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMuY29yZS5hY3RpdmVTZXNzaW9ucy0tCiAgICAgIGNvcmUuYWN0aXZlU2Vzc2lvbnMrKwogICAgfQoKICAgIGlmICh0aGlzLl9tb25pdG9ySW5kZXggPj0gMCkgewogICAgICB0aGlzLmNvcmUucmVtb3ZlTW9uaXRvcih0aGlzKQogICAgICBjb3JlLmFkZE1vbml0b3IodGhpcykKICAgIH0KCiAgICBjb25zdCBvbGQgPSB0aGlzLmNvcmUKCiAgICB0aGlzLmNvcmUgPSBjb3JlCgogICAgb2xkLnJlcGxpY2F0b3IuY2xlYXJSZXF1ZXN0cyh0aGlzLmFjdGl2ZVJlcXVlc3RzLCBTRVNTSU9OX01PVkVEKCkpCgogICAgdGhpcy5lbWl0KCdtaWdyYXRlJywgdGhpcy5rZXkpCiAgfQoKICBmaW5kaW5nUGVlcnMoKSB7CiAgICB0aGlzLl9maW5kaW5nUGVlcnMrKwogICAgaWYgKHRoaXMuY29yZSAhPT0gbnVsbCAmJiAhdGhpcy5jbG9zaW5nKSB0aGlzLmNvcmUucmVwbGljYXRvci5maW5kaW5nUGVlcnMrKwoKICAgIGxldCBvbmNlID0gdHJ1ZQoKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmICh0aGlzLmNsb3NpbmcgfHwgIW9uY2UpIHJldHVybgogICAgICBvbmNlID0gZmFsc2UKICAgICAgdGhpcy5fZmluZGluZ1BlZXJzLS0KICAgICAgaWYgKHRoaXMuY29yZSAhPT0gbnVsbCAmJiAtLXRoaXMuY29yZS5yZXBsaWNhdG9yLmZpbmRpbmdQZWVycyA9PT0gMCkgewogICAgICAgIHRoaXMuY29yZS5yZXBsaWNhdG9yLnVwZGF0ZUFsbCgpCiAgICAgIH0KICAgIH0KICB9CgogIGFzeW5jIGluZm8ob3B0cykgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCgogICAgcmV0dXJuIEluZm8uZnJvbSh0aGlzLCBvcHRzKQogIH0KCiAgYXN5bmMgdXBkYXRlKG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgaWYgKHRoaXMuY2xvc2luZyAhPT0gbnVsbCkgcmV0dXJuIGZhbHNlCiAgICBpZiAodGhpcy5zbmFwc2hvdHRlZCkgcmV0dXJuIGZhbHNlCgogICAgaWYgKHRoaXMud3JpdGFibGUgJiYgKCFvcHRzIHx8IG9wdHMuZm9yY2UgIT09IHRydWUpKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCByZW1vdGVXYWl0ID0gdGhpcy5fc2hvdWxkV2FpdChvcHRzLCB0aGlzLmNvcmUucmVwbGljYXRvci5maW5kaW5nUGVlcnMgPiAwKQoKICAgIGxldCB1cGdyYWRlZCA9IGZhbHNlCgogICAgaWYgKGF3YWl0IHRoaXMuY29yZS5yZXBsaWNhdG9yLmFwcGx5UGVuZGluZ1Jlb3JnKCkpIHsKICAgICAgdXBncmFkZWQgPSB0cnVlCiAgICB9CgogICAgaWYgKCF1cGdyYWRlZCAmJiByZW1vdGVXYWl0KSB7CiAgICAgIGNvbnN0IGFjdGl2ZVJlcXVlc3RzID0gKG9wdHMgJiYgb3B0cy5hY3RpdmVSZXF1ZXN0cykgfHwgdGhpcy5hY3RpdmVSZXF1ZXN0cwogICAgICBjb25zdCByZXEgPSB0aGlzLmNvcmUucmVwbGljYXRvci5hZGRVcGdyYWRlKGFjdGl2ZVJlcXVlc3RzKQoKICAgICAgdHJ5IHsKICAgICAgICB1cGdyYWRlZCA9IGF3YWl0IHJlcS5wcm9taXNlCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmIChpc1Nlc3Npb25Nb3ZlZChlcnIpKSByZXR1cm4gdGhpcy51cGRhdGUob3B0cykKICAgICAgICB0aHJvdyBlcnIKICAgICAgfQogICAgfQoKICAgIGlmICghdXBncmFkZWQpIHJldHVybiBmYWxzZQogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIHNlZWsoYnl0ZXMsIG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgaWYgKCFpc1ZhbGlkSW5kZXgoYnl0ZXMpKSB0aHJvdyBBU1NFUlRJT04oJ3NlZWsgaXMgaW52YWxpZCcsIHRoaXMuZGlzY292ZXJ5S2V5KQoKICAgIGNvbnN0IGFjdGl2ZVJlcXVlc3RzID0gKG9wdHMgJiYgb3B0cy5hY3RpdmVSZXF1ZXN0cykgfHwgdGhpcy5hY3RpdmVSZXF1ZXN0cwoKICAgIGlmICh0aGlzLmVuY3J5cHRpb24gJiYgIXRoaXMuY29yZS5tYW5pZmVzdCkgewogICAgICBjb25zdCByZXEgPSB0aGlzLnJlcGxpY2F0b3IuYWRkVXBncmFkZShhY3RpdmVSZXF1ZXN0cykKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCByZXEucHJvbWlzZQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBpZiAoaXNTZXNzaW9uTW92ZWQoZXJyKSkgcmV0dXJuIHRoaXMuc2VlayhieXRlcywgb3B0cykKICAgICAgICB0aHJvdyBlcnIKICAgICAgfQogICAgfQoKICAgIGNvbnN0IHMgPSBNZXJrbGVUcmVlLnNlZWsodGhpcy5zdGF0ZSwgYnl0ZXMsIHRoaXMucGFkZGluZykKCiAgICBjb25zdCBvZmZzZXQgPSBhd2FpdCBzLnVwZGF0ZSgpCiAgICBpZiAob2Zmc2V0KSByZXR1cm4gb2Zmc2V0CgogICAgaWYgKHRoaXMuY2xvc2luZyAhPT0gbnVsbCkgewogICAgICB0aHJvdyBTRVNTSU9OX0NMT1NFRCgnY2Fubm90IHNlZWsgb24gYSBjbG9zZWQgc2Vzc2lvbicsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIGlmICghdGhpcy5fc2hvdWxkV2FpdChvcHRzLCB0aGlzLndhaXQpKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHJlcSA9IHRoaXMuY29yZS5yZXBsaWNhdG9yLmFkZFNlZWsoYWN0aXZlUmVxdWVzdHMsIHMpCgogICAgY29uc3QgdGltZW91dCA9IG9wdHMgJiYgb3B0cy50aW1lb3V0ICE9PSB1bmRlZmluZWQgPyBvcHRzLnRpbWVvdXQgOiB0aGlzLnRpbWVvdXQKICAgIGlmICh0aW1lb3V0KSByZXEuY29udGV4dC5zZXRUaW1lb3V0KHJlcSwgdGltZW91dCkKCiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgcmVxLnByb21pc2UKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAoaXNTZXNzaW9uTW92ZWQoZXJyKSkgcmV0dXJuIHRoaXMuc2VlayhieXRlcywgb3B0cykKICAgICAgdGhyb3cgZXJyCiAgICB9CiAgfQoKICBhc3luYyBoYXMoc3RhcnQsIGVuZCA9IHN0YXJ0ICsgMSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBpZiAoIWlzVmFsaWRJbmRleChzdGFydCkgfHwgIWlzVmFsaWRJbmRleChlbmQpKSB7CiAgICAgIHRocm93IEFTU0VSVElPTignaGFzIHJhbmdlIGlzIGludmFsaWQnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICBpZiAodGhpcy5zdGF0ZS5pc0RlZmF1bHQoKSkgewogICAgICBpZiAoZW5kID09PSBzdGFydCArIDEpIHJldHVybiB0aGlzLmNvcmUuYml0ZmllbGQuZ2V0KHN0YXJ0KQoKICAgICAgY29uc3QgaSA9IHRoaXMuY29yZS5iaXRmaWVsZC5maXJzdFVuc2V0KHN0YXJ0KQogICAgICByZXR1cm4gaSA9PT0gLTEgfHwgaSA+PSBlbmQKICAgIH0KCiAgICBpZiAoZW5kID09PSBzdGFydCArIDEpIHsKICAgICAgY29uc3QgcnggPSB0aGlzLnN0YXRlLnN0b3JhZ2UucmVhZCgpCiAgICAgIGNvbnN0IGJsb2NrID0gcnguZ2V0QmxvY2soc3RhcnQpCiAgICAgIHJ4LnRyeUZsdXNoKCkKCiAgICAgIHJldHVybiAoYXdhaXQgYmxvY2spICE9PSBudWxsCiAgICB9CgogICAgbGV0IGNvdW50ID0gMAoKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RhdGUuc3RvcmFnZS5jcmVhdGVCbG9ja1N0cmVhbSh7IGd0ZTogc3RhcnQsIGx0OiBlbmQgfSkKICAgIGZvciBhd2FpdCAoY29uc3QgYmxvY2sgb2Ygc3RyZWFtKSB7CiAgICAgIGlmIChibG9jayA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCiAgICAgIGNvdW50KysKICAgIH0KCiAgICByZXR1cm4gY291bnQgPT09IGVuZCAtIHN0YXJ0CiAgfQoKICBhc3luYyBnZXQoaW5kZXgsIG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgaWYgKCFpc1ZhbGlkSW5kZXgoaW5kZXgpKSB0aHJvdyBBU1NFUlRJT04oJ2Jsb2NrIGluZGV4IGlzIGludmFsaWQnLCB0aGlzLmRpc2NvdmVyeUtleSkKCiAgICBpZiAodGhpcy5jbG9zaW5nICE9PSBudWxsKSB7CiAgICAgIHRocm93IFNFU1NJT05fQ0xPU0VEKCdjYW5ub3QgZ2V0IG9uIGEgY2xvc2VkIHNlc3Npb24nLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICBjb25zdCBlbmNvZGluZyA9CiAgICAgIChvcHRzICYmIG9wdHMudmFsdWVFbmNvZGluZyAmJiBjLmZyb20ob3B0cy52YWx1ZUVuY29kaW5nKSkgfHwgdGhpcy52YWx1ZUVuY29kaW5nCgogICAgaWYgKHRoaXMub25zZXEgIT09IG51bGwpIHRoaXMub25zZXEoaW5kZXgsIHRoaXMpCgogICAgY29uc3QgcmVxID0gdGhpcy5fZ2V0KGluZGV4LCBvcHRzKQoKICAgIGxldCBibG9jayA9IGF3YWl0IHJlcQogICAgaWYgKCFibG9jaykgcmV0dXJuIG51bGwKCiAgICBpZiAob3B0cyAmJiBvcHRzLnJhdykgcmV0dXJuIGJsb2NrCgogICAgaWYgKHRoaXMuZW5jcnlwdGlvbiAmJiAoIW9wdHMgfHwgb3B0cy5kZWNyeXB0ICE9PSBmYWxzZSkpIHsKICAgICAgLy8gQ29weSB0aGUgYmxvY2sgYXMgaXQgbWlnaHQgYmUgc2hhcmVkIHdpdGggb3RoZXIgc2Vzc2lvbnMuCiAgICAgIGJsb2NrID0gYjRhLmZyb20oYmxvY2spCgogICAgICBhd2FpdCB0aGlzLmVuY3J5cHRpb24uZGVjcnlwdChpbmRleCwgYmxvY2ssIHRoaXMuY29yZSkKICAgIH0KCiAgICByZXR1cm4gdGhpcy5fZGVjb2RlKGVuY29kaW5nLCBibG9jaywgaW5kZXgpCiAgfQoKICBhc3luYyBjbGVhcihzdGFydCwgZW5kID0gc3RhcnQgKyAxLCBvcHRzKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGlmICh0aGlzLmNsb3NpbmcgIT09IG51bGwpIHsKICAgICAgdGhyb3cgU0VTU0lPTl9DTE9TRUQoJ2Nhbm5vdCBjbGVhciBvbiBhIGNsb3NlZCBzZXNzaW9uJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgaWYgKHR5cGVvZiBlbmQgPT09ICdvYmplY3QnKSB7CiAgICAgIG9wdHMgPSBlbmQKICAgICAgZW5kID0gc3RhcnQgKyAxCiAgICB9CgogICAgaWYgKCFpc1ZhbGlkSW5kZXgoc3RhcnQpIHx8ICFpc1ZhbGlkSW5kZXgoZW5kKSkgewogICAgICB0aHJvdyBBU1NFUlRJT04oJ2NsZWFyIHJhbmdlIGlzIGludmFsaWQnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICBjb25zdCBjbGVhcmVkID0gb3B0cyAmJiBvcHRzLmRpZmYgPyB7IGJsb2NrczogMCB9IDogbnVsbAoKICAgIGlmIChzdGFydCA+PSBlbmQpIHJldHVybiBjbGVhcmVkCiAgICBpZiAoc3RhcnQgPj0gdGhpcy5sZW5ndGgpIHJldHVybiBjbGVhcmVkCgogICAgYXdhaXQgdGhpcy5zdGF0ZS5jbGVhcihzdGFydCwgZW5kLCBjbGVhcmVkKQoKICAgIHJldHVybiBjbGVhcmVkCiAgfQoKICBhc3luYyBwdXJnZSgpIHsKICAgIGF3YWl0IHRoaXMuX2Nsb3NlQWxsU2Vzc2lvbnMobnVsbCkKICAgIGF3YWl0IHRoaXMuY29yZS5wdXJnZSgpCiAgfQoKICBhc3luYyBfZ2V0KGluZGV4LCBvcHRzKSB7CiAgICBjb25zdCBibG9jayA9IGF3YWl0IHJlYWRCbG9jayh0aGlzLnN0YXRlLnN0b3JhZ2UucmVhZCgpLCBpbmRleCkKCiAgICBpZiAoYmxvY2sgIT09IG51bGwpIHJldHVybiBibG9jawoKICAgIGlmICh0aGlzLmNsb3NpbmcgIT09IG51bGwpIHsKICAgICAgdGhyb3cgU0VTU0lPTl9DTE9TRUQoJ2Nhbm5vdCBnZXQgb24gYSBjbG9zZWQgc2Vzc2lvbicsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIC8vIHNuYXBzaG90IHNob3VsZCBjaGVjayBpZiBjb3JlIGhhcyBibG9jawogICAgaWYgKHRoaXMuX3NuYXBzaG90ICE9PSBudWxsKSB7CiAgICAgIGNoZWNrU25hcHNob3QodGhpcywgaW5kZXgpCiAgICAgIGNvbnN0IGNvcmVCbG9jayA9IGF3YWl0IHJlYWRCbG9jayh0aGlzLmNvcmUuc3RhdGUuc3RvcmFnZS5yZWFkKCksIGluZGV4KQoKICAgICAgY2hlY2tTbmFwc2hvdCh0aGlzLCBpbmRleCkKICAgICAgaWYgKGNvcmVCbG9jayAhPT0gbnVsbCkgcmV0dXJuIGNvcmVCbG9jawogICAgfQoKICAgIC8vIGxldHMgY2hlY2sgdGhlIGJpdGZpZWxkIHRvIHNlZSBpZiB3ZSBnb3QgaXQgZHVyaW5nIHRoZSBhYm92ZSBhc3luYyBjYWxscwogICAgLy8gdGhpcyBpcyB0aGUgbGFzdCByZXNvcnQgYmVmb3JlIHJlcGxpY2F0aW9uLCBzbyBhbHdheXMgc2FmZS4KICAgIGlmICh0aGlzLmNvcmUuYml0ZmllbGQuZ2V0KGluZGV4KSkgewogICAgICBjb25zdCBjb3JlQmxvY2sgPSBhd2FpdCByZWFkQmxvY2sodGhpcy5zdGF0ZS5zdG9yYWdlLnJlYWQoKSwgaW5kZXgpCiAgICAgIC8vIFRPRE86IHRoaXMgc2hvdWxkIG5vdCBiZSBuZWVkZWQsIG9ubHkgbmVlZGVkIGF0bSBpbiBjYXNlIHdlIGFyZSBkb2luZyBhIG1vdmVUbyBkdXJpbmcgdGhpcyAod2Ugc2hvdWxkIGZpeCkKICAgICAgaWYgKGNvcmVCbG9jayAhPT0gbnVsbCkgcmV0dXJuIGNvcmVCbG9jawogICAgfQoKICAgIGlmICghdGhpcy5fc2hvdWxkV2FpdChvcHRzLCB0aGlzLndhaXQpKSByZXR1cm4gbnVsbAoKICAgIGlmIChvcHRzICYmIG9wdHMub253YWl0KSBvcHRzLm9ud2FpdChpbmRleCwgdGhpcykKICAgIGlmICh0aGlzLm9ud2FpdCkgdGhpcy5vbndhaXQoaW5kZXgsIHRoaXMpCgogICAgY29uc3QgYWN0aXZlUmVxdWVzdHMgPSAob3B0cyAmJiBvcHRzLmFjdGl2ZVJlcXVlc3RzKSB8fCB0aGlzLmFjdGl2ZVJlcXVlc3RzCgogICAgY29uc3QgcmVxID0gdGhpcy5jb3JlLnJlcGxpY2F0b3IuYWRkQmxvY2soYWN0aXZlUmVxdWVzdHMsIGluZGV4KQogICAgcmVxLnNuYXBzaG90ID0gaW5kZXggPCB0aGlzLmxlbmd0aAoKICAgIGNvbnN0IHRpbWVvdXQgPSBvcHRzICYmIG9wdHMudGltZW91dCAhPT0gdW5kZWZpbmVkID8gb3B0cy50aW1lb3V0IDogdGhpcy50aW1lb3V0CiAgICBpZiAodGltZW91dCkgcmVxLmNvbnRleHQuc2V0VGltZW91dChyZXEsIHRpbWVvdXQpCgogICAgbGV0IHJlcGxpY2F0ZWRCbG9jayA9IG51bGwKCiAgICB0cnkgewogICAgICByZXBsaWNhdGVkQmxvY2sgPSBhd2FpdCByZXEucHJvbWlzZQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmIChpc1Nlc3Npb25Nb3ZlZChlcnIpKSByZXR1cm4gdGhpcy5fZ2V0KGluZGV4LCBvcHRzKQogICAgICB0aHJvdyBlcnIKICAgIH0KCiAgICBpZiAodGhpcy5fc25hcHNob3QgIT09IG51bGwpIGNoZWNrU25hcHNob3QodGhpcywgaW5kZXgpCiAgICByZXR1cm4gbWF5YmVVbnNsYWIocmVwbGljYXRlZEJsb2NrKQogIH0KCiAgX3Nob3VsZFdhaXQob3B0cywgZGVmYXVsdFZhbHVlKSB7CiAgICBpZiAob3B0cykgewogICAgICBpZiAob3B0cy53YWl0ID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlCiAgICAgIGlmIChvcHRzLndhaXQgPT09IHRydWUpIHJldHVybiB0cnVlCiAgICB9CiAgICByZXR1cm4gZGVmYXVsdFZhbHVlCiAgfQoKICBjcmVhdGVSZWFkU3RyZWFtKG9wdHMpIHsKICAgIHJldHVybiBuZXcgUmVhZFN0cmVhbSh0aGlzLCBvcHRzKQogIH0KCiAgY3JlYXRlV3JpdGVTdHJlYW0oKSB7CiAgICByZXR1cm4gbmV3IFdyaXRlU3RyZWFtKHRoaXMpCiAgfQoKICBjcmVhdGVCeXRlU3RyZWFtKG9wdHMpIHsKICAgIHJldHVybiBuZXcgQnl0ZVN0cmVhbSh0aGlzLCBvcHRzKQogIH0KCiAgZG93bmxvYWQocmFuZ2UpIHsKICAgIHJldHVybiBuZXcgRG93bmxvYWQodGhpcywgcmFuZ2UpCiAgfQoKICAvLyBUT0RPOiBnZXQgcmlkIG9mIHRoaXMgLyBkZXByZWNhdGUgaXQ/CiAgdW5kb3dubG9hZChyYW5nZSkgewogICAgcmFuZ2UuZGVzdHJveShudWxsKQogIH0KCiAgLy8gVE9ETzogZ2V0IHJpZCBvZiB0aGlzIC8gZGVwcmVjYXRlIGl0PwogIGNhbmNlbChyZXF1ZXN0KSB7CiAgICAvLyBEbyBub3RoaW5nIGZvciBub3cKICB9CgogIGFzeW5jIHRydW5jYXRlKG5ld0xlbmd0aCA9IDAsIG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCgogICAgY29uc3QgewogICAgICBmb3JrID0gdGhpcy5zdGF0ZS5mb3JrICsgMSwKICAgICAga2V5UGFpciA9IHRoaXMua2V5UGFpciwKICAgICAgc2lnbmF0dXJlID0gbnVsbAogICAgfSA9IHR5cGVvZiBvcHRzID09PSAnbnVtYmVyJyA/IHsgZm9yazogb3B0cyB9IDogb3B0cwoKICAgIGNvbnN0IGlzRGVmYXVsdCA9IHRoaXMuc3RhdGUgPT09IHRoaXMuY29yZS5zdGF0ZQogICAgY29uc3Qgd3JpdGFibGUgPSAhdGhpcy5fcmVhZG9ubHkgJiYgISEoc2lnbmF0dXJlIHx8IChrZXlQYWlyICYmIGtleVBhaXIuc2VjcmV0S2V5KSkKICAgIGlmIChpc0RlZmF1bHQgJiYgd3JpdGFibGUgPT09IGZhbHNlICYmIChuZXdMZW5ndGggPiAwIHx8IGZvcmsgIT09IHRoaXMuc3RhdGUuZm9yaykpIHsKICAgICAgdGhyb3cgU0VTU0lPTl9OT1RfV1JJVEFCTEUoJ2Nhbm5vdCBhcHBlbmQgdG8gYSBub24td3JpdGFibGUgY29yZScsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIGF3YWl0IHRoaXMuc3RhdGUudHJ1bmNhdGUobmV3TGVuZ3RoLCBmb3JrLCB7IGtleVBhaXIsIHNpZ25hdHVyZSB9KQoKICAgIC8vIFRPRE86IFNob3VsZCBwcm9wYWdhdGUgZnJvbSBhbiBldmVudCB0cmlnZ2VyZWQgYnkgdGhlIG9wbG9nCiAgICBpZiAodGhpcy5zdGF0ZSA9PT0gdGhpcy5jb3JlLnN0YXRlKSB0aGlzLmNvcmUucmVwbGljYXRvci51cGRhdGVBbGwoKQogIH0KCiAgYXN5bmMgYXBwZW5kKGJsb2Nrcywgb3B0cyA9IHt9KSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKCiAgICBjb25zdCBpc0RlZmF1bHQgPSB0aGlzLnN0YXRlID09PSB0aGlzLmNvcmUuc3RhdGUKICAgIGNvbnN0IGRlZmF1bHRLZXlQYWlyID0gdGhpcy5zdGF0ZS5uYW1lID09PSBudWxsID8gdGhpcy5rZXlQYWlyIDogbnVsbAoKICAgIGNvbnN0IHsga2V5UGFpciA9IGRlZmF1bHRLZXlQYWlyLCBzaWduYXR1cmUgPSBudWxsLCBtYXhMZW5ndGgsIHBvc3RhcHBlbmQgPSBudWxsIH0gPSBvcHRzCiAgICBjb25zdCB3cml0YWJsZSA9CiAgICAgICFpc0RlZmF1bHQgfHwgISFzaWduYXR1cmUgfHwgISEoa2V5UGFpciAmJiBrZXlQYWlyLnNlY3JldEtleSkgfHwgb3B0cy53cml0YWJsZSA9PT0gdHJ1ZQoKICAgIGlmICh0aGlzLl9yZWFkb25seSB8fCB3cml0YWJsZSA9PT0gZmFsc2UpIHsKICAgICAgdGhyb3cgU0VTU0lPTl9OT1RfV1JJVEFCTEUoJ2Nhbm5vdCBhcHBlbmQgdG8gYSByZWFkb25seSBjb3JlJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgYmxvY2tzID0gQXJyYXkuaXNBcnJheShibG9ja3MpID8gYmxvY2tzIDogW2Jsb2Nrc10KCiAgICBjb25zdCBwcmVhcHBlbmQgPSB0aGlzLmVuY3J5cHRpb24gJiYgdGhpcy5fcHJlYXBwZW5kCgogICAgY29uc3QgYnVmZmVycyA9IHRoaXMuZW5jb2RlQmF0Y2ggIT09IG51bGwgPyB0aGlzLmVuY29kZUJhdGNoKGJsb2NrcykgOiBuZXcgQXJyYXkoYmxvY2tzLmxlbmd0aCkKCiAgICBpZiAodGhpcy5lbmNvZGVCYXRjaCA9PT0gbnVsbCkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJsb2Nrcy5sZW5ndGg7IGkrKykgewogICAgICAgIGJ1ZmZlcnNbaV0gPSB0aGlzLl9lbmNvZGUodGhpcy52YWx1ZUVuY29kaW5nLCBibG9ja3NbaV0pCiAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3QgYiBvZiBidWZmZXJzKSB7CiAgICAgIGlmIChiLmJ5dGVMZW5ndGggPiBNQVhfU1VHR0VTVEVEX0JMT0NLX1NJWkUpIHsKICAgICAgICB0aHJvdyBCQURfQVJHVU1FTlQoCiAgICAgICAgICAnQXBwZW5kZWQgYmxvY2sgZXhjZWVkcyB0aGUgbWF4aW11bSBzdWdnZXN0ZWQgYmxvY2sgc2l6ZScsCiAgICAgICAgICB0aGlzLmRpc2NvdmVyeUtleQogICAgICAgICkKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzLnN0YXRlLmFwcGVuZChidWZmZXJzLCB7IGtleVBhaXIsIHNpZ25hdHVyZSwgcHJlYXBwZW5kLCBwb3N0YXBwZW5kLCBtYXhMZW5ndGggfSkKICB9CgogIGFzeW5jIHNpZ25hYmxlKGxlbmd0aCA9IC0xLCBmb3JrID0gLTEpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgaWYgKGxlbmd0aCA9PT0gLTEpIGxlbmd0aCA9IHRoaXMubGVuZ3RoCiAgICBpZiAoZm9yayA9PT0gLTEpIGZvcmsgPSB0aGlzLmZvcmsKCiAgICByZXR1cm4gY2Fwcy50cmVlU2lnbmFibGUodGhpcy5rZXksIGF3YWl0IHRoaXMudHJlZUhhc2gobGVuZ3RoKSwgbGVuZ3RoLCBmb3JrKQogIH0KCiAgYXN5bmMgdHJlZUhhc2gobGVuZ3RoID0gLTEpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgaWYgKGxlbmd0aCA9PT0gLTEpIGxlbmd0aCA9IHRoaXMubGVuZ3RoCgogICAgY29uc3Qgcm9vdHMgPSBhd2FpdCBNZXJrbGVUcmVlLmdldFJvb3RzKHRoaXMuc3RhdGUsIGxlbmd0aCkKICAgIHJldHVybiBjcnlwdG8udHJlZShyb290cykKICB9CgogIGFzeW5jIG1pc3NpbmdOb2RlcyhpbmRleCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICByZXR1cm4gYXdhaXQgTWVya2xlVHJlZS5taXNzaW5nTm9kZXModGhpcy5jb3JlLnN0YXRlLCAyICogaW5kZXgsIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpCiAgfQoKICBhc3luYyBwcm9vZihvcHRzKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGNvbnN0IHJ4ID0gdGhpcy5zdGF0ZS5zdG9yYWdlLnJlYWQoKQogICAgY29uc3QgcHJvb2ZQcm9taXNlID0gTWVya2xlVHJlZS5wcm9vZih0aGlzLnN0YXRlLCByeCwgb3B0cykKICAgIGNvbnN0IGJsb2NrUHJvbWlzZSA9IG9wdHMgJiYgb3B0cy5ibG9jayA/IHJ4LmdldEJsb2NrKG9wdHMuYmxvY2suaW5kZXgpIDogbnVsbAogICAgcngudHJ5Rmx1c2goKQogICAgY29uc3QgW3Byb29mLCBibG9ja10gPSBhd2FpdCBQcm9taXNlLmFsbChbcHJvb2ZQcm9taXNlLCBibG9ja1Byb21pc2VdKQogICAgY29uc3Qgc2V0dGxlZCA9IGF3YWl0IHByb29mLnNldHRsZSgpCiAgICBpZiAoYmxvY2spIHNldHRsZWQuYmxvY2sudmFsdWUgPSBibG9jawogICAgcmV0dXJuIHNldHRsZWQKICB9CgogIGFzeW5jIGFwcGx5UHJvb2YocHJvb2YsIGZyb20pIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgcmV0dXJuIHRoaXMuY29yZS52ZXJpZnkocHJvb2YsIGZyb20pCiAgfQoKICBhc3luYyB2ZXJpZnlGdWxseVJlbW90ZShwcm9vZikgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBjb25zdCBiYXRjaCA9IGF3YWl0IE1lcmtsZVRyZWUudmVyaWZ5RnVsbHlSZW1vdGUodGhpcy5zdGF0ZSwgcHJvb2YpCiAgICBhd2FpdCB0aGlzLmNvcmUuX3ZlcmlmeUJhdGNoVXBncmFkZShiYXRjaCwgcHJvb2YubWFuaWZlc3QpCiAgICByZXR1cm4gYmF0Y2gKICB9CgogIHJlZ2lzdGVyRXh0ZW5zaW9uKG5hbWUsIGhhbmRsZXJzID0ge30pIHsKICAgIGlmICh0aGlzLmV4dGVuc2lvbnMuaGFzKG5hbWUpKSB7CiAgICAgIGNvbnN0IGV4dCA9IHRoaXMuZXh0ZW5zaW9ucy5nZXQobmFtZSkKICAgICAgZXh0LmhhbmRsZXJzID0gaGFuZGxlcnMKICAgICAgZXh0LmVuY29kaW5nID0gYy5mcm9tKGhhbmRsZXJzLmVuY29kaW5nIHx8IGMuYnVmZmVyKQogICAgICBleHQuc2Vzc2lvbiA9IHRoaXMKICAgICAgcmV0dXJuIGV4dAogICAgfQoKICAgIGNvbnN0IGV4dCA9IHsKICAgICAgbmFtZSwKICAgICAgaGFuZGxlcnMsCiAgICAgIGVuY29kaW5nOiBjLmZyb20oaGFuZGxlcnMuZW5jb2RpbmcgfHwgYy5idWZmZXIpLAogICAgICBzZXNzaW9uOiB0aGlzLAogICAgICBzZW5kKG1lc3NhZ2UsIHBlZXIpIHsKICAgICAgICBjb25zdCBidWZmZXIgPSBjLmVuY29kZSh0aGlzLmVuY29kaW5nLCBtZXNzYWdlKQogICAgICAgIHBlZXIuZXh0ZW5zaW9uKG5hbWUsIGJ1ZmZlcikKICAgICAgfSwKICAgICAgYnJvYWRjYXN0KG1lc3NhZ2UpIHsKICAgICAgICBjb25zdCBidWZmZXIgPSBjLmVuY29kZSh0aGlzLmVuY29kaW5nLCBtZXNzYWdlKQogICAgICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnNlc3Npb24ucGVlcnMpIHsKICAgICAgICAgIHBlZXIuZXh0ZW5zaW9uKG5hbWUsIGJ1ZmZlcikKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3koKSB7CiAgICAgICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMuc2Vzc2lvbi5wZWVycykgewogICAgICAgICAgaWYgKHBlZXIuZXh0ZW5zaW9ucy5nZXQobmFtZSkgPT09IGV4dCkgcGVlci5leHRlbnNpb25zLmRlbGV0ZShuYW1lKQogICAgICAgIH0KICAgICAgICB0aGlzLnNlc3Npb24uZXh0ZW5zaW9ucy5kZWxldGUobmFtZSkKICAgICAgfSwKICAgICAgX29ubWVzc2FnZShzdGF0ZSwgcGVlcikgewogICAgICAgIGNvbnN0IG0gPSB0aGlzLmVuY29kaW5nLmRlY29kZShzdGF0ZSkKICAgICAgICBpZiAodGhpcy5oYW5kbGVycy5vbm1lc3NhZ2UpIHRoaXMuaGFuZGxlcnMub25tZXNzYWdlKG0sIHBlZXIpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmV4dGVuc2lvbnMuc2V0KG5hbWUsIGV4dCkKCiAgICBpZiAodGhpcy5jb3JlID09PSBudWxsKSB0aGlzLl9tb25pdG9ySW5kZXggPSAtMgogICAgZWxzZSB0aGlzLmNvcmUuYWRkTW9uaXRvcih0aGlzKQoKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSB7CiAgICAgIHBlZXIuZXh0ZW5zaW9ucy5zZXQobmFtZSwgZXh0KQogICAgfQoKICAgIHJldHVybiBleHQKICB9CgogIF9lbmNvZGUoZW5jLCB2YWwpIHsKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogdGhpcy5wYWRkaW5nLCBlbmQ6IHRoaXMucGFkZGluZywgYnVmZmVyOiBudWxsIH0KCiAgICBpZiAoYjRhLmlzQnVmZmVyKHZhbCkpIHsKICAgICAgaWYgKHN0YXRlLnN0YXJ0ID09PSAwKSByZXR1cm4gdmFsCiAgICAgIHN0YXRlLmVuZCArPSB2YWwuYnl0ZUxlbmd0aAogICAgfSBlbHNlIGlmIChlbmMpIHsKICAgICAgZW5jLnByZWVuY29kZShzdGF0ZSwgdmFsKQogICAgfSBlbHNlIHsKICAgICAgdmFsID0gYjRhLmZyb20odmFsKQogICAgICBpZiAoc3RhdGUuc3RhcnQgPT09IDApIHJldHVybiB2YWwKICAgICAgc3RhdGUuZW5kICs9IHZhbC5ieXRlTGVuZ3RoCiAgICB9CgogICAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHN0YXRlLmVuZCkKCiAgICBpZiAoZW5jKSBlbmMuZW5jb2RlKHN0YXRlLCB2YWwpCiAgICBlbHNlIHN0YXRlLmJ1ZmZlci5zZXQodmFsLCBzdGF0ZS5zdGFydCkKCiAgICByZXR1cm4gc3RhdGUuYnVmZmVyCiAgfQoKICBfZGVjb2RlKGVuYywgYmxvY2ssIGluZGV4KSB7CiAgICBpZiAodGhpcy5lbmNyeXB0aW9uKSBibG9jayA9IGJsb2NrLnN1YmFycmF5KHRoaXMuZW5jcnlwdGlvbi5wYWRkaW5nKHRoaXMuY29yZSwgaW5kZXgpKQogICAgdHJ5IHsKICAgICAgaWYgKGVuYykgcmV0dXJuIGMuZGVjb2RlKGVuYywgYmxvY2spCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhyb3cgREVDT0RJTkdfRVJST1IoZXJyLm1lc3NhZ2UsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQogICAgcmV0dXJuIGJsb2NrCiAgfQoKICBfZ2V0RW5jcnlwdGlvblByb3ZpZGVyKGUpIHsKICAgIGlmIChpc0VuY3J5cHRpb25Qcm92aWRlcihlKSkgcmV0dXJuIGUKICAgIGlmICghZSB8fCAhZS5rZXkpIHJldHVybiBudWxsCiAgICByZXR1cm4gbmV3IERlZmF1bHRFbmNyeXB0aW9uKGUua2V5LCB0aGlzLmtleSwgeyBibG9jazogZS5ibG9jaywgY29tcGF0OiB0aGlzLmNvcmUuY29tcGF0IH0pCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IEh5cGVyY29yZQoKZnVuY3Rpb24gaXNTdHJlYW0ocykgewogIHJldHVybiB0eXBlb2YgcyA9PT0gJ29iamVjdCcgJiYgcyAmJiB0eXBlb2Ygcy5waXBlID09PSAnZnVuY3Rpb24nCn0KCmFzeW5jIGZ1bmN0aW9uIHByZWFwcGVuZChibG9ja3MpIHsKICBjb25zdCBvZmZzZXQgPSB0aGlzLnN0YXRlLmxlbmd0aAogIGNvbnN0IGZvcmsgPSB0aGlzLnN0YXRlLmVuY3J5cHRpb25Gb3JrCgogIGZvciAobGV0IGkgPSAwOyBpIDwgYmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICBhd2FpdCB0aGlzLmVuY3J5cHRpb24uZW5jcnlwdChvZmZzZXQgKyBpLCBibG9ja3NbaV0sIGZvcmssIHRoaXMuY29yZSkKICB9Cn0KCmZ1bmN0aW9uIGlzVmFsaWRJbmRleChpbmRleCkgewogIHJldHVybiBpbmRleCA9PT0gMCB8fCBpbmRleCA+IDAKfQoKZnVuY3Rpb24gbWF5YmVVbnNsYWIoYmxvY2spIHsKICAvLyBVbnNsYWIgb25seSB3aGVuIGl0IHRha2VzIHVwIGxlc3MgdGhlbiBoYWxmIHRoZSBzbGFiCiAgcmV0dXJuIGJsb2NrICE9PSBudWxsICYmIDIgKiBibG9jay5ieXRlTGVuZ3RoIDwgYmxvY2suYnVmZmVyLmJ5dGVMZW5ndGggPyB1bnNsYWIoYmxvY2spIDogYmxvY2sKfQoKZnVuY3Rpb24gY2hlY2tTbmFwc2hvdChzbmFwc2hvdCwgaW5kZXgpIHsKICBpZiAoaW5kZXggPj0gc25hcHNob3Quc3RhdGUuc25hcHNob3RDb21wYXRMZW5ndGgpIHsKICAgIHRocm93IFNOQVBTSE9UX05PVF9BVkFJTEFCTEUoCiAgICAgIGBzbmFwc2hvdCBhdCBpbmRleCAke2luZGV4fSBub3QgYXZhaWxhYmxlIChtYXggY29tcGF0IGxlbmd0aCAke3NuYXBzaG90LnN0YXRlLnNuYXBzaG90Q29tcGF0TGVuZ3RofSlgLAogICAgICBzbmFwc2hvdC5kaXNjb3ZlcnlLZXkKICAgICkKICB9Cn0KCmZ1bmN0aW9uIHJlYWRCbG9jayhyeCwgaW5kZXgpIHsKICBjb25zdCBwcm9taXNlID0gcnguZ2V0QmxvY2soaW5kZXgpCiAgcngudHJ5Rmx1c2goKQogIHJldHVybiBwcm9taXNlCn0KCmZ1bmN0aW9uIGluaXRPbmNlKHNlc3Npb24sIHN0b3JhZ2UsIGtleSwgb3B0cykgewogIGlmIChzdG9yYWdlID09PSBudWxsKSBzdG9yYWdlID0gb3B0cy5zdG9yYWdlIHx8IG51bGwKICBpZiAoa2V5ID09PSBudWxsKSBrZXkgPSBvcHRzLmtleSB8fCBudWxsCgogIHNlc3Npb24uY29yZSA9IG5ldyBDb3JlKEh5cGVyY29yZS5kZWZhdWx0U3RvcmFnZShzdG9yYWdlKSwgewogICAgcHJlb3Blbjogb3B0cy5wcmVvcGVuLAogICAgZWFnZXJVcGdyYWRlOiBvcHRzLmVhZ2VyVXBncmFkZSAhPT0gZmFsc2UsCiAgICBub3REb3dubG9hZGluZ0xpbmdlcjogb3B0cy5ub3REb3dubG9hZGluZ0xpbmdlciwKICAgIGFsbG93Rm9yazogb3B0cy5hbGxvd0ZvcmsgIT09IGZhbHNlLAogICAgYWxsb3dQdXNoOiAhIW9wdHMuYWxsb3dQdXNoLAogICAgYWx3YXlzTGF0ZXN0QmxvY2s6ICEhb3B0cy5hbGxvd0xhdGVzdEJsb2NrLAogICAgaW5mbGlnaHRSYW5nZTogb3B0cy5pbmZsaWdodFJhbmdlLAogICAgY29tcGF0OiBvcHRzLmNvbXBhdCA9PT0gdHJ1ZSwKICAgIGZvcmNlOiBvcHRzLmZvcmNlLAogICAgY3JlYXRlSWZNaXNzaW5nOiBvcHRzLmNyZWF0ZUlmTWlzc2luZywKICAgIGRpc2NvdmVyeUtleTogb3B0cy5kaXNjb3ZlcnlLZXksCiAgICBvdmVyd3JpdGU6IG9wdHMub3ZlcndyaXRlLAogICAga2V5LAogICAga2V5UGFpcjogb3B0cy5rZXlQYWlyLAogICAgbGVnYWN5OiBvcHRzLmxlZ2FjeSwKICAgIG1hbmlmZXN0OiBvcHRzLm1hbmlmZXN0LAogICAgZ2xvYmFsQ2FjaGU6IG9wdHMuZ2xvYmFsQ2FjaGUgfHwgbnVsbCAvLyBzZXNzaW9uIGlzIGEgdGVtcCBvcHRpb24sIG5vdCB0byBiZSByZWxpZWQgb24gdW5sZXNzIHlvdSBrbm93IHdoYXQgeW91IGFyZSBkb2luZyAobm8gc2VtdmVyIGd1YXJhbnRlZXMpCiAgfSkKfQoKZnVuY3Rpb24gbWF5YmVBZGRNb25pdG9yKG5hbWUpIHsKICBpZiAobmFtZSA9PT0gJ2FwcGVuZCcgfHwgbmFtZSA9PT0gJ3RydW5jYXRlJykgcmV0dXJuCiAgaWYgKHRoaXMuX21vbml0b3JJbmRleCA+PSAwIHx8IHRoaXMuY2xvc2luZykgcmV0dXJuCgogIGlmICh0aGlzLmNvcmUgPT09IG51bGwpIHsKICAgIHRoaXMuX21vbml0b3JJbmRleCA9IC0yCiAgfSBlbHNlIHsKICAgIHRoaXMuY29yZS5hZGRNb25pdG9yKHRoaXMpCiAgfQp9CgpmdW5jdGlvbiBpc1Nlc3Npb25Nb3ZlZChlcnIpIHsKICByZXR1cm4gZXJyLmNvZGUgPT09ICdTRVNTSU9OX01PVkVEJwp9CgpmdW5jdGlvbiBnZXRFbmNyeXB0aW9uT3B0aW9uKG9wdHMpIHsKICAvLyBvbGQgc3R5bGUsIHN1cHBvcnRlZCBmb3Igbm93IGJ1dCB3aWxsIGdvIGF3YXkKICBpZiAob3B0cy5lbmNyeXB0aW9uS2V5KSByZXR1cm4geyBrZXk6IG9wdHMuZW5jcnlwdGlvbktleSwgYmxvY2s6ICEhb3B0cy5pc0Jsb2NrS2V5IH0KICBpZiAoIW9wdHMuZW5jcnlwdGlvbikgcmV0dXJuIG51bGwKICByZXR1cm4gYjRhLmlzQnVmZmVyKG9wdHMuZW5jcnlwdGlvbikgPyB7IGtleTogb3B0cy5lbmNyeXB0aW9uIH0gOiBvcHRzLmVuY3J5cHRpb24KfQoKZnVuY3Rpb24gaXNFbmNyeXB0aW9uUHJvdmlkZXIoZSkgewogIHJldHVybiBlICYmIGlzRnVuY3Rpb24oZS5wYWRkaW5nKSAmJiBpc0Z1bmN0aW9uKGUuZW5jcnlwdCkgJiYgaXNGdW5jdGlvbihlLmRlY3J5cHQpCn0KCmZ1bmN0aW9uIGlzRnVuY3Rpb24oZm4pIHsKICByZXR1cm4gISFmbiAmJiB0eXBlb2YgZm4gPT09ICdmdW5jdGlvbicKfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgZmxhdCA9IHJlcXVpcmUoJ2ZsYXQtdHJlZScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHsgTWVya2xlVHJlZSB9ID0gcmVxdWlyZSgnLi9tZXJrbGUtdHJlZScpCgptb2R1bGUuZXhwb3J0cyA9IGFzeW5jIGZ1bmN0aW9uIGF1ZGl0Q29yZSgKICBjb3JlLAogIHsgdHJlZSA9IHRydWUsIGJsb2NrcyA9IHRydWUsIGJpdGZpZWxkID0gdHJ1ZSwgZHJ5UnVuID0gZmFsc2UgfSA9IHt9CikgewogIGNvbnN0IGxlbmd0aCA9IGNvcmUuc3RhdGUubGVuZ3RoCiAgY29uc3Qgc3RhdHMgPSB7CiAgICB0cmVlTm9kZXM6IDAsCiAgICBibG9ja3M6IDAsCiAgICBiaXRzOiAwLAogICAgZHJvcHBlZFRyZWVOb2RlczogMCwKICAgIGRyb3BwZWRCbG9ja3M6IDAsCiAgICBkcm9wcGVkQml0czogMCwKICAgIGNvcnJ1cHQ6IGZhbHNlCiAgfQoKICAvLyBhdWRpdCB0aGUgdHJlZQogIGlmICh0cmVlKSB7CiAgICBsZXQgdHggPSBudWxsCgogICAgY29uc3Qgcm9vdHMgPSBhd2FpdCBNZXJrbGVUcmVlLmdldFJvb3RzRnJvbVN0b3JhZ2UoY29yZS5zdGF0ZS5zdG9yYWdlLCBsZW5ndGgpCiAgICBjb25zdCBzdGFjayA9IFtdCgogICAgZm9yIChjb25zdCByIG9mIHJvb3RzKSB7CiAgICAgIGlmIChyID09PSBudWxsKSB7CiAgICAgICAgaWYgKCFkcnlSdW4pIHsKICAgICAgICAgIGNvbnN0IHN0b3JhZ2UgPSBjb3JlLnN0YXRlLnN0b3JhZ2UKICAgICAgICAgIGF3YWl0IHN0b3JhZ2Uuc3RvcmUuZGVsZXRlQ29yZShzdG9yYWdlLmNvcmUpCiAgICAgICAgICByZXR1cm4gbnVsbAogICAgICAgIH0KCiAgICAgICAgc3RhdHMuY29ycnVwdCA9IHRydWUKICAgICAgfQoKICAgICAgc3RhY2sucHVzaChyKQogICAgfQoKICAgIHN0YXRzLnRyZWVOb2RlcyArPSByb290cy5sZW5ndGgKCiAgICB3aGlsZSAoc3RhY2subGVuZ3RoID4gMCkgewogICAgICBjb25zdCBub2RlID0gc3RhY2sucG9wKCkKCiAgICAgIGlmICgobm9kZS5pbmRleCAmIDEpID09PSAwKSBjb250aW51ZQoKICAgICAgY29uc3QgW2xlZnQsIHJpZ2h0XSA9IGZsYXQuY2hpbGRyZW4obm9kZS5pbmRleCkKCiAgICAgIGNvbnN0IHJ4ID0gY29yZS5zdGF0ZS5zdG9yYWdlLnJlYWQoKQogICAgICBjb25zdCBsZWZ0Tm9kZVByb21pc2UgPSByeC5nZXRUcmVlTm9kZShsZWZ0KQogICAgICBjb25zdCByaWdodE5vZGVQcm9taXNlID0gcnguZ2V0VHJlZU5vZGUocmlnaHQpCgogICAgICByeC50cnlGbHVzaCgpCgogICAgICBjb25zdCBbbGVmdE5vZGUsIHJpZ2h0Tm9kZV0gPSBhd2FpdCBQcm9taXNlLmFsbChbbGVmdE5vZGVQcm9taXNlLCByaWdodE5vZGVQcm9taXNlXSkKCiAgICAgIGlmIChpc0JhZFRyZWUobm9kZSwgbGVmdE5vZGUsIHJpZ2h0Tm9kZSkpIHsKICAgICAgICBpZiAoIXR4ICYmICFzdGF0cy5jb3JydXB0KSB0eCA9IGNvcmUuc3RhdGUuc3RvcmFnZS53cml0ZSgpCiAgICAgICAgY29uc3QgW2wsIHJdID0gZmxhdC5zcGFucyhub2RlLmluZGV4KQogICAgICAgIHR4LmRlbGV0ZVRyZWVOb2RlUmFuZ2UobCwgciArIDEpCiAgICAgICAgc3RhdHMuZHJvcHBlZFRyZWVOb2RlcysrCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgaWYgKCFsZWZ0Tm9kZSkgY29udGludWUKCiAgICAgIHN0YXRzLnRyZWVOb2RlcyArPSAyCiAgICAgIHN0YWNrLnB1c2gobGVmdE5vZGUsIHJpZ2h0Tm9kZSkKICAgIH0KCiAgICBpZiAodHggJiYgIWRyeVJ1bikgYXdhaXQgdHguZmx1c2goKQogIH0KCiAgLy8gYXVkaXQgdGhlIGJsb2NrcwogIGlmIChibG9ja3MpIHsKICAgIGxldCB0eCA9IG51bGwKCiAgICBmb3IgYXdhaXQgKGNvbnN0IGJsb2NrIG9mIGNvcmUuc3RhdGUuc3RvcmFnZS5jcmVhdGVCbG9ja1N0cmVhbSgpKSB7CiAgICAgIGlmICghY29yZS5iaXRmaWVsZC5nZXQoYmxvY2suaW5kZXgpKSB7CiAgICAgICAgaWYgKCF0eCAmJiAhc3RhdHMuY29ycnVwdCkgdHggPSBjb3JlLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQogICAgICAgIHR4LmRlbGV0ZUJsb2NrKGJsb2NrLmluZGV4KQogICAgICAgIHN0YXRzLmRyb3BwZWRCbG9ja3MrKwogICAgICB9CgogICAgICBjb25zdCByeCA9IGNvcmUuc3RhdGUuc3RvcmFnZS5yZWFkKCkKICAgICAgY29uc3QgdHJlZU5vZGVQcm9taXNlID0gcnguZ2V0VHJlZU5vZGUoMiAqIGJsb2NrLmluZGV4KQoKICAgICAgcngudHJ5Rmx1c2goKQoKICAgICAgY29uc3QgdHJlZU5vZGUgPSBhd2FpdCB0cmVlTm9kZVByb21pc2UKCiAgICAgIGlmIChpc0JhZEJsb2NrKHRyZWVOb2RlLCBibG9jay52YWx1ZSkpIHsKICAgICAgICBpZiAoIXR4ICYmICFzdGF0cy5jb3JydXB0KSB0eCA9IGNvcmUuc3RhdGUuc3RvcmFnZS53cml0ZSgpCiAgICAgICAgdHguZGVsZXRlQmxvY2soYmxvY2suaW5kZXgpCiAgICAgICAgc3RhdHMuZHJvcHBlZEJsb2NrcysrCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgc3RhdHMuYmxvY2tzKysKICAgIH0KCiAgICBpZiAodHggJiYgIWRyeVJ1bikgYXdhaXQgdHguZmx1c2goKQogIH0KCiAgaWYgKGJpdGZpZWxkKSB7CiAgICBsZXQgdHggPSBudWxsCgogICAgZm9yIChjb25zdCBpbmRleCBvZiBhbGxCaXRzKGNvcmUuYml0ZmllbGQpKSB7CiAgICAgIGNvbnN0IHJ4ID0gY29yZS5zdGF0ZS5zdG9yYWdlLnJlYWQoKQogICAgICBjb25zdCBibG9ja1Byb21pc2UgPSByeC5nZXRCbG9jayhpbmRleCkKCiAgICAgIHJ4LnRyeUZsdXNoKCkKCiAgICAgIGNvbnN0IGJsb2NrID0gYXdhaXQgYmxvY2tQcm9taXNlCiAgICAgIGlmICghYmxvY2spIHsKICAgICAgICBzdGF0cy5kcm9wcGVkQml0cysrCiAgICAgICAgaWYgKGRyeVJ1bikgY29udGludWUKCiAgICAgICAgaWYgKCF0eCAmJiAhc3RhdHMuY29ycnVwdCkgdHggPSBjb3JlLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQoKICAgICAgICBjb3JlLmJpdGZpZWxkLnNldChpbmRleCwgZmFsc2UpCgogICAgICAgIGNvbnN0IHBhZ2UgPSBjb3JlLmJpdGZpZWxkLmdldEJpdGZpZWxkKGluZGV4KQogICAgICAgIGlmIChwYWdlLmJpdGZpZWxkKSB0eC5wdXRCaXRmaWVsZFBhZ2UocGFnZS5pbmRleCwgcGFnZS5iaXRmaWVsZCkKICAgICAgICBlbHNlIHR4LmRlbGV0ZUJpdGZpZWxkUGFnZShwYWdlLmluZGV4KQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIHN0YXRzLmJpdHMrKwogICAgfQoKICAgIGlmICh0eCAmJiAhZHJ5UnVuKSBhd2FpdCB0eC5mbHVzaCgpCiAgfQoKICByZXR1cm4gc3RhdHMKfQoKZnVuY3Rpb24gaXNCYWRCbG9jayhub2RlLCBibG9jaykgewogIGlmICghbm9kZSkgcmV0dXJuIHRydWUKICBjb25zdCBoYXNoID0gY3J5cHRvLmRhdGEoYmxvY2spCiAgcmV0dXJuICFiNGEuZXF1YWxzKGhhc2gsIG5vZGUuaGFzaCkgfHwgbm9kZS5zaXplICE9PSBibG9jay5ieXRlTGVuZ3RoCn0KCmZ1bmN0aW9uIGlzQmFkVHJlZShwYXJlbnQsIGxlZnQsIHJpZ2h0KSB7CiAgaWYgKCFsZWZ0ICYmICFyaWdodCkgcmV0dXJuIGZhbHNlCiAgaWYgKCFsZWZ0IHx8ICFyaWdodCkgcmV0dXJuIHRydWUKICBjb25zdCBoYXNoID0gY3J5cHRvLnBhcmVudChsZWZ0LCByaWdodCkKICByZXR1cm4gIWI0YS5lcXVhbHMoaGFzaCwgcGFyZW50Lmhhc2gpIHx8IHBhcmVudC5zaXplICE9PSBsZWZ0LnNpemUgKyByaWdodC5zaXplCn0KCmZ1bmN0aW9uKiBhbGxCaXRzKGJpdGZpZWxkKSB7CiAgbGV0IGkgPSAwCiAgaWYgKGJpdGZpZWxkLmdldCgwKSkgeWllbGQgMAogIHdoaWxlICh0cnVlKSB7CiAgICBpID0gYml0ZmllbGQuZmluZEZpcnN0KHRydWUsIGkgKyAxKQogICAgaWYgKGkgPT09IC0xKSBicmVhawogICAgeWllbGQgaQogIH0KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBxdWlja2JpdCA9IHJlcXVpcmUoJy4vY29tcGF0JykucXVpY2tiaXQKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQml0SW50ZXJsdWRlIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMucmFuZ2VzID0gW10KICB9CgogIGNvbnRpZ3VvdXNMZW5ndGgoZnJvbSkgewogICAgZm9yIChjb25zdCByIG9mIHRoaXMucmFuZ2VzKSB7CiAgICAgIGlmIChyLnN0YXJ0ID4gZnJvbSkgYnJlYWsKICAgICAgaWYgKCFyLnZhbHVlICYmIHIuc3RhcnQgPD0gZnJvbSkgcmV0dXJuIHIuc3RhcnQKICAgIH0KCiAgICAvLyBUT0RPOiBiZSBzbWFydGVyCiAgICB3aGlsZSAodGhpcy5nZXQoZnJvbSkgPT09IHRydWUpIGZyb20rKwogICAgcmV0dXJuIGZyb20KICB9CgogIGdldChpbmRleCkgewogICAgbGV0IHN0YXJ0ID0gMAogICAgbGV0IGVuZCA9IHRoaXMucmFuZ2VzLmxlbmd0aAoKICAgIHdoaWxlIChzdGFydCA8IGVuZCkgewogICAgICBjb25zdCBtaWQgPSAoc3RhcnQgKyBlbmQpID4+IDEKICAgICAgY29uc3QgciA9IHRoaXMucmFuZ2VzW21pZF0KCiAgICAgIGlmIChpbmRleCA8IHIuc3RhcnQpIHsKICAgICAgICBlbmQgPSBtaWQKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBpZiAoaW5kZXggPj0gci5lbmQpIHsKICAgICAgICBpZiAobWlkID09PSBzdGFydCkgYnJlYWsKICAgICAgICBzdGFydCA9IG1pZAogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIHJldHVybiByLnZhbHVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBzZXRSYW5nZShzdGFydCwgZW5kLCB2YWx1ZSkgewogICAgaWYgKHN0YXJ0ID09PSBlbmQpIHJldHVybgoKICAgIGxldCByID0gbnVsbAoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5yYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgciA9IHRoaXMucmFuZ2VzW2ldCgogICAgICAvLyBpZiBhbHJlYWR5IGluc2lkZSwgc3RvcAogICAgICBpZiAoci5zdGFydCA8PSBzdGFydCAmJiBlbmQgPD0gci5lbmQpIHsKICAgICAgICBpZiAodmFsdWUgPT09IHIudmFsdWUpIHJldHVybgoKICAgICAgICBjb25zdCByYW5nZXMgPSBtZXJnZVJhbmdlcyhyLCB7IHN0YXJ0LCBlbmQsIHZhbHVlIH0pCiAgICAgICAgdGhpcy5yYW5nZXMuc3BsaWNlKGksIDEsIC4uLnJhbmdlcykKCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIC8vIHdlIHdhbm5hIG92ZXJ1biB0aGUgaW50ZXJ2YWwKICAgICAgaWYgKHN0YXJ0ID4gci5lbmQpIHsKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICAvLyB3ZSBvdmVycmFuIGJ1dCB0aGlzIGludGVydmFsIGlzIGVuZGluZyBhZnRlciB1cywgbW92ZSBpdCBiYWNrCiAgICAgIGlmIChlbmQgPj0gci5zdGFydCAmJiBlbmQgPD0gci5lbmQpIHsKICAgICAgICByLnN0YXJ0ID0gci52YWx1ZSA9PT0gdmFsdWUgPyBzdGFydCA6IGVuZAogICAgICAgIGlmIChyLnZhbHVlICE9PSB2YWx1ZSkgdGhpcy5yYW5nZXMuc3BsaWNlKGksIDAsIHsgc3RhcnQsIGVuZCwgdmFsdWUgfSkKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgLy8gd2Ugb3ZlcnJhbiBidXQgb3VyIHN0YXJ0IGlzIGNvbnRhaW5lZCBpbiB0aGlzIGludGVydmFsLCBtb3ZlIHN0YXJ0IGJhY2sKICAgICAgaWYgKHN0YXJ0ID49IHIuc3RhcnQgJiYgc3RhcnQgPD0gci5lbmQpIHsKICAgICAgICBpZiAoci52YWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgIHIuZW5kID0gc3RhcnQgLy8gQ3JvcCBjdXJyZW50IGNvbXBhcmlzb24KCiAgICAgICAgICAvLyBJZiB0aGVyZSdzIGEgbmV4dCByYW5nZQogICAgICAgICAgaWYgKHRoaXMucmFuZ2VzLmxlbmd0aCAtIDEgPiBpKSB7CiAgICAgICAgICAgIGNvbnN0IG5leHQgPSB0aGlzLnJhbmdlc1tpICsgMV0KICAgICAgICAgICAgLy8gSWYgdGhlIHNhbWUsIGdvIG5leHQKICAgICAgICAgICAgaWYgKG5leHQudmFsdWUgPT09IHZhbHVlKSBjb250aW51ZQogICAgICAgICAgICAvLyBFbHNlIHdlIG92ZXJsYXAgc28gdXBkYXRlIG5leHQgcmFuZ2UKICAgICAgICAgICAgaWYgKG5leHQuc3RhcnQgPCBlbmQpIG5leHQuc3RhcnQgPSBlbmQKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLnJhbmdlcy5zcGxpY2UoKytpLCAwLCB7IHN0YXJ0LCBlbmQsIHZhbHVlIH0pCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIHN0YXJ0ID0gci5zdGFydAogICAgICB9CgogICAgICBsZXQgcmVtb3ZlID0gMAoKICAgICAgZm9yIChsZXQgaiA9IGk7IGogPCB0aGlzLnJhbmdlcy5sZW5ndGg7IGorKykgewogICAgICAgIGNvbnN0IG4gPSB0aGlzLnJhbmdlc1tqXQogICAgICAgIGlmIChuLnN0YXJ0ID4gZW5kIHx8IG4udmFsdWUgIT09IHZhbHVlKSBicmVhawogICAgICAgIGlmIChuLnN0YXJ0IDw9IGVuZCAmJiBuLmVuZCA+IGVuZCkgZW5kID0gbi5lbmQKICAgICAgICByZW1vdmUrKwogICAgICB9CgogICAgICB0aGlzLnJhbmdlcy5zcGxpY2UoaSwgcmVtb3ZlLCB7IHN0YXJ0LCBlbmQsIHZhbHVlIH0pCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChyICE9PSBudWxsKSB7CiAgICAgIGlmIChzdGFydCA8PSByLmVuZCAmJiBlbmQgPiByLmVuZCkgewogICAgICAgIHIuZW5kID0gZW5kCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIC8vIHdlIG5ldmVyCiAgICAgIGlmIChyLmVuZCA+IHN0YXJ0KSByZXR1cm4KICAgIH0KCiAgICB0aGlzLnJhbmdlcy5wdXNoKHsgc3RhcnQsIGVuZCwgdmFsdWUgfSkKICB9CgogIGZsdXNoKHR4LCBiaXRmaWVsZCkgewogICAgaWYgKCF0aGlzLnJhbmdlcy5sZW5ndGgpIHJldHVybiBbXQoKICAgIGxldCBpbmRleCA9IHRoaXMucmFuZ2VzWzBdLnN0YXJ0CiAgICBjb25zdCBmaW5hbCA9IHRoaXMucmFuZ2VzW3RoaXMucmFuZ2VzLmxlbmd0aCAtIDFdLmVuZAoKICAgIGxldCBpID0gMAoKICAgIHdoaWxlIChpbmRleCA8IGZpbmFsKSB7CiAgICAgIGNvbnN0IHBhZ2UgPSBiaXRmaWVsZC5nZXRCaXRmaWVsZChpbmRleCkgLy8gcmVhZCBvbmx5CiAgICAgIGNvbnN0IHBhZ2VJbmRleCA9IHBhZ2UgPyBwYWdlLmluZGV4IDogYml0ZmllbGQuZ2V0UGFnZUluZGV4KGluZGV4KQoKICAgICAgY29uc3QgYnVmID0gYjRhLmFsbG9jVW5zYWZlKGJpdGZpZWxkLmdldFBhZ2VCeXRlTGVuZ3RoKCkpCgogICAgICBpZiAocGFnZSkgewogICAgICAgIGNvbnN0IHNyYyA9IHBhZ2UuYml0ZmllbGQgLy8gVWludDMyQXJyYXkKICAgICAgICBidWYuc2V0KGI0YS5mcm9tKHNyYy5idWZmZXIsIHNyYy5ieXRlT2Zmc2V0LCBzcmMuYnl0ZUxlbmd0aCksIDApCiAgICAgIH0gZWxzZSB7CiAgICAgICAgYjRhLmZpbGwoYnVmLCAwKQogICAgICB9CgogICAgICBjb25zdCBsYXN0ID0gKHBhZ2VJbmRleCArIDEpICogKGJ1Zi5ieXRlTGVuZ3RoIDw8IDMpCiAgICAgIGNvbnN0IG9mZnNldCA9IHBhZ2VJbmRleCAqIChidWYuYnl0ZUxlbmd0aCA8PCAzKQoKICAgICAgbGV0IGhhc1ZhbHVlID0gZmFsc2UKCiAgICAgIHdoaWxlIChpIDwgdGhpcy5yYW5nZXMubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgeyBzdGFydCwgZW5kLCB2YWx1ZSB9ID0gdGhpcy5yYW5nZXNbaV0KCiAgICAgICAgaWYgKCFoYXNWYWx1ZSAmJiB2YWx1ZSkgaGFzVmFsdWUgPSB0cnVlCgogICAgICAgIGNvbnN0IGZyb20gPSBzdGFydCA8IGluZGV4ID8gaW5kZXggOiBzdGFydAogICAgICAgIGNvbnN0IHRvID0gZW5kIDwgbGFzdCA/IGVuZCA6IGxhc3QKCiAgICAgICAgcXVpY2tiaXQuZmlsbChidWYsIHZhbHVlLCBmcm9tIC0gb2Zmc2V0LCB0byAtIG9mZnNldCkKCiAgICAgICAgaW5kZXggPSB0bwoKICAgICAgICBpZiAodG8gPT09IGxhc3QpIGJyZWFrCgogICAgICAgIGkrKwogICAgICB9CgogICAgICBpZiAocGFnZSB8fCBoYXNWYWx1ZSkgdHgucHV0Qml0ZmllbGRQYWdlKHBhZ2VJbmRleCwgYnVmKQogICAgfQoKICAgIHJldHVybiB0aGlzLnJhbmdlcwogIH0KfQoKZnVuY3Rpb24gbWVyZ2VSYW5nZXMoYSwgYikgewogIGNvbnN0IHJhbmdlcyA9IFtdCiAgaWYgKGEuc3RhcnQgPCBiLnN0YXJ0KSByYW5nZXMucHVzaCh7IHN0YXJ0OiBhLnN0YXJ0LCBlbmQ6IGIuc3RhcnQsIHZhbHVlOiBhLnZhbHVlIH0pCiAgcmFuZ2VzLnB1c2goeyBzdGFydDogYi5zdGFydCwgZW5kOiBiLmVuZCwgdmFsdWU6IGIudmFsdWUgfSkKICBpZiAoYi5lbmQgPCBhLmVuZCkgcmFuZ2VzLnB1c2goeyBzdGFydDogYi5lbmQsIGVuZDogYS5lbmQsIHZhbHVlOiBhLnZhbHVlIH0pCgogIHJldHVybiByYW5nZXMKfQpjb25zdCBCaWdTcGFyc2VBcnJheSA9IHJlcXVpcmUoJ2JpZy1zcGFyc2UtYXJyYXknKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBxdWlja2JpdCA9IHJlcXVpcmUoJy4vY29tcGF0JykucXVpY2tiaXQKCmNvbnN0IEJJVFNfUEVSX1BBR0UgPSAzMjc2OApjb25zdCBCWVRFU19QRVJfUEFHRSA9IEJJVFNfUEVSX1BBR0UgLyA4CmNvbnN0IFdPUkRTX1BFUl9QQUdFID0gQllURVNfUEVSX1BBR0UgLyA0CmNvbnN0IEJJVFNfUEVSX1NFR01FTlQgPSAyMDk3MTUyCmNvbnN0IEJZVEVTX1BFUl9TRUdNRU5UID0gQklUU19QRVJfU0VHTUVOVCAvIDgKY29uc3QgV09SRFNfUEVSX1NFR01FTlQgPSBCWVRFU19QRVJfU0VHTUVOVCAvIDQKY29uc3QgSU5JVElBTF9XT1JEU19QRVJfU0VHTUVOVCA9IDEwMjQKY29uc3QgUEFHRVNfUEVSX1NFR01FTlQgPSBCSVRTX1BFUl9TRUdNRU5UIC8gQklUU19QRVJfUEFHRQpjb25zdCBTRUdNRU5UX0dST1dUSF9GQUNUT1IgPSA0CgpjbGFzcyBCaXRmaWVsZFBhZ2UgewogIGNvbnN0cnVjdG9yKGluZGV4LCBzZWdtZW50KSB7CiAgICB0aGlzLmluZGV4ID0gaW5kZXgKICAgIHRoaXMub2Zmc2V0ID0gaW5kZXggKiBCWVRFU19QRVJfUEFHRSAtIHNlZ21lbnQub2Zmc2V0CiAgICB0aGlzLmJpdGZpZWxkID0gbnVsbAogICAgdGhpcy5zZWdtZW50ID0gc2VnbWVudAoKICAgIHNlZ21lbnQuYWRkKHRoaXMpCiAgfQoKICBnZXQgdHJlZSgpIHsKICAgIHJldHVybiB0aGlzLnNlZ21lbnQudHJlZQogIH0KCiAgZ2V0KGluZGV4LCBkaXJ0eSkgewogICAgcmV0dXJuIHF1aWNrYml0LmdldCh0aGlzLmJpdGZpZWxkLCBpbmRleCkKICB9CgogIHNldChpbmRleCwgdmFsKSB7CiAgICBpZiAocXVpY2tiaXQuc2V0KHRoaXMuYml0ZmllbGQsIGluZGV4LCB2YWwpKSB7CiAgICAgIHRoaXMudHJlZS51cGRhdGUodGhpcy5vZmZzZXQgKiA4ICsgaW5kZXgpCiAgICB9CiAgfQoKICBzZXRSYW5nZShzdGFydCwgZW5kLCB2YWwpIHsKICAgIHF1aWNrYml0LmZpbGwodGhpcy5iaXRmaWVsZCwgdmFsLCBzdGFydCwgZW5kKQoKICAgIGxldCBpID0gTWF0aC5mbG9vcihzdGFydCAvIDEyOCkKICAgIGNvbnN0IG4gPSBpICsgTWF0aC5jZWlsKChlbmQgLSBzdGFydCkgLyAxMjgpCgogICAgd2hpbGUgKGkgPD0gbikgdGhpcy50cmVlLnVwZGF0ZSh0aGlzLm9mZnNldCAqIDggKyBpKysgKiAxMjgpCiAgfQoKICBmaW5kRmlyc3QodmFsLCBwb3NpdGlvbikgewogICAgcmV0dXJuIHF1aWNrYml0LmZpbmRGaXJzdCh0aGlzLmJpdGZpZWxkLCB2YWwsIHBvc2l0aW9uKQogIH0KCiAgZmluZExhc3QodmFsLCBwb3NpdGlvbikgewogICAgcmV0dXJuIHF1aWNrYml0LmZpbmRMYXN0KHRoaXMuYml0ZmllbGQsIHZhbCwgcG9zaXRpb24pCiAgfQoKICBjb3VudChzdGFydCwgbGVuZ3RoLCB2YWwpIHsKICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgbGVuZ3RoCgogICAgbGV0IGkgPSBzdGFydAogICAgbGV0IGMgPSAwCgogICAgd2hpbGUgKGxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgbCA9IHRoaXMuZmluZEZpcnN0KHZhbCwgaSkKICAgICAgaWYgKGwgPT09IC0xIHx8IGwgPj0gZW5kKSByZXR1cm4gYwoKICAgICAgY29uc3QgaCA9IHRoaXMuZmluZEZpcnN0KCF2YWwsIGwgKyAxKQogICAgICBpZiAoaCA9PT0gLTEgfHwgaCA+PSBlbmQpIHJldHVybiBjICsgZW5kIC0gbAoKICAgICAgYyArPSBoIC0gbAogICAgICBsZW5ndGggLT0gaCAtIGkKICAgICAgaSA9IGgKICAgIH0KCiAgICByZXR1cm4gYwogIH0KfQoKY2xhc3MgQml0ZmllbGRTZWdtZW50IHsKICBjb25zdHJ1Y3RvcihpbmRleCwgYml0ZmllbGQpIHsKICAgIHRoaXMuaW5kZXggPSBpbmRleAogICAgdGhpcy5vZmZzZXQgPSBpbmRleCAqIEJZVEVTX1BFUl9TRUdNRU5UCiAgICB0aGlzLnRyZWUgPSBxdWlja2JpdC5JbmRleC5mcm9tKGJpdGZpZWxkLCBCWVRFU19QRVJfU0VHTUVOVCkKICAgIHRoaXMucGFnZXMgPSBuZXcgQXJyYXkoUEFHRVNfUEVSX1NFR01FTlQpCiAgfQoKICBnZXQgYml0ZmllbGQoKSB7CiAgICByZXR1cm4gdGhpcy50cmVlLmZpZWxkCiAgfQoKICBhZGQocGFnZSkgewogICAgY29uc3QgaSA9IHBhZ2UuaW5kZXggLSB0aGlzLmluZGV4ICogUEFHRVNfUEVSX1NFR01FTlQKICAgIHRoaXMucGFnZXNbaV0gPSBwYWdlCgogICAgY29uc3Qgc3RhcnQgPSBpICogV09SRFNfUEVSX1BBR0UKICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgV09SRFNfUEVSX1BBR0UKCiAgICBpZiAoZW5kID49IHRoaXMuYml0ZmllbGQubGVuZ3RoKSB0aGlzLnJlYWxsb2NhdGUoZW5kKQoKICAgIHBhZ2UuYml0ZmllbGQgPSB0aGlzLmJpdGZpZWxkLnN1YmFycmF5KHN0YXJ0LCBlbmQpCiAgfQoKICByZWFsbG9jYXRlKGxlbmd0aCkgewogICAgbGV0IHRhcmdldCA9IHRoaXMuYml0ZmllbGQubGVuZ3RoCiAgICB3aGlsZSAodGFyZ2V0IDwgbGVuZ3RoKSB0YXJnZXQgKj0gU0VHTUVOVF9HUk9XVEhfRkFDVE9SCgogICAgY29uc3QgYml0ZmllbGQgPSBuZXcgVWludDMyQXJyYXkodGFyZ2V0KQogICAgYml0ZmllbGQuc2V0KHRoaXMuYml0ZmllbGQpCgogICAgdGhpcy50cmVlID0gcXVpY2tiaXQuSW5kZXguZnJvbShiaXRmaWVsZCwgQllURVNfUEVSX1NFR01FTlQpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHBhZ2UgPSB0aGlzLnBhZ2VzW2ldCiAgICAgIGlmICghcGFnZSkgY29udGludWUKCiAgICAgIGNvbnN0IHN0YXJ0ID0gaSAqIFdPUkRTX1BFUl9QQUdFCiAgICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgV09SRFNfUEVSX1BBR0UKCiAgICAgIHBhZ2UuYml0ZmllbGQgPSBiaXRmaWVsZC5zdWJhcnJheShzdGFydCwgZW5kKQogICAgfQogIH0KCiAgZmluZEZpcnN0KHZhbCwgcG9zaXRpb24pIHsKICAgIHBvc2l0aW9uID0gdGhpcy50cmVlLnNraXBGaXJzdCghdmFsLCBwb3NpdGlvbikKCiAgICBsZXQgaiA9IHBvc2l0aW9uICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgbGV0IGkgPSAocG9zaXRpb24gLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICBpZiAoaSA+PSBQQUdFU19QRVJfU0VHTUVOVCkgcmV0dXJuIC0xCgogICAgd2hpbGUgKGkgPCB0aGlzLnBhZ2VzLmxlbmd0aCkgewogICAgICBjb25zdCBwID0gdGhpcy5wYWdlc1tpXQoKICAgICAgbGV0IGluZGV4ID0gLTEKCiAgICAgIGlmIChwKSBpbmRleCA9IHAuZmluZEZpcnN0KHZhbCwgaikKICAgICAgZWxzZSBpZiAoIXZhbCkgaW5kZXggPSBqCgogICAgICBpZiAoaW5kZXggIT09IC0xKSByZXR1cm4gaSAqIEJJVFNfUEVSX1BBR0UgKyBpbmRleAoKICAgICAgaiA9IDAKICAgICAgaSsrCiAgICB9CgogICAgcmV0dXJuIC0xCiAgfQoKICBmaW5kTGFzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICBwb3NpdGlvbiA9IHRoaXMudHJlZS5za2lwTGFzdCghdmFsLCBwb3NpdGlvbikKCiAgICBsZXQgaiA9IHBvc2l0aW9uICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgbGV0IGkgPSAocG9zaXRpb24gLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICBpZiAoaSA+PSBQQUdFU19QRVJfU0VHTUVOVCkgcmV0dXJuIC0xCgogICAgd2hpbGUgKGkgPj0gMCkgewogICAgICBjb25zdCBwID0gdGhpcy5wYWdlc1tpXQoKICAgICAgbGV0IGluZGV4ID0gLTEKCiAgICAgIGlmIChwKSBpbmRleCA9IHAuZmluZExhc3QodmFsLCBqKQogICAgICBlbHNlIGlmICghdmFsKSBpbmRleCA9IGoKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBpICogQklUU19QRVJfUEFHRSArIGluZGV4CgogICAgICBqID0gQklUU19QRVJfUEFHRSAtIDEKICAgICAgaS0tCiAgICB9CgogICAgcmV0dXJuIC0xCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEJpdGZpZWxkIHsKICBzdGF0aWMgQklUU19QRVJfUEFHRSA9IEJJVFNfUEVSX1BBR0UKICBzdGF0aWMgQllURVNfUEVSX1BBR0UgPSBCWVRFU19QRVJfUEFHRQoKICBjb25zdHJ1Y3RvcihidWZmZXIpIHsKICAgIHRoaXMucmVzdW1lZCA9ICEhKGJ1ZmZlciAmJiBidWZmZXIuYnl0ZUxlbmd0aCA+PSAwKQoKICAgIHRoaXMuX3BhZ2VzID0gbmV3IEJpZ1NwYXJzZUFycmF5KCkKICAgIHRoaXMuX3NlZ21lbnRzID0gbmV3IEJpZ1NwYXJzZUFycmF5KCkKCiAgICBjb25zdCB2aWV3ID0gdGhpcy5yZXN1bWVkCiAgICAgID8gbmV3IFVpbnQzMkFycmF5KGJ1ZmZlci5idWZmZXIsIGJ1ZmZlci5ieXRlT2Zmc2V0LCBNYXRoLmZsb29yKGJ1ZmZlci5ieXRlTGVuZ3RoIC8gNCkpCiAgICAgIDogbmV3IFVpbnQzMkFycmF5KElOSVRJQUxfV09SRFNfUEVSX1NFR01FTlQpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2aWV3Lmxlbmd0aDsgaSArPSBXT1JEU19QRVJfU0VHTUVOVCkgewogICAgICBsZXQgYml0ZmllbGQgPSB2aWV3LnN1YmFycmF5KGksIGkgKyBXT1JEU19QRVJfU0VHTUVOVCkKICAgICAgbGV0IGxlbmd0aCA9IFdPUkRTX1BFUl9TRUdNRU5UCgogICAgICBpZiAoaSA9PT0gMCkgewogICAgICAgIGxlbmd0aCA9IElOSVRJQUxfV09SRFNfUEVSX1NFR01FTlQKICAgICAgICB3aGlsZSAobGVuZ3RoIDwgYml0ZmllbGQubGVuZ3RoKSBsZW5ndGggKj0gU0VHTUVOVF9HUk9XVEhfRkFDVE9SCiAgICAgIH0KCiAgICAgIGlmIChiaXRmaWVsZC5sZW5ndGggIT09IGxlbmd0aCkgewogICAgICAgIGNvbnN0IGNvcHkgPSBuZXcgVWludDMyQXJyYXkobGVuZ3RoKQogICAgICAgIGNvcHkuc2V0KGJpdGZpZWxkLCAwKQogICAgICAgIGJpdGZpZWxkID0gY29weQogICAgICB9CgogICAgICBjb25zdCBzZWdtZW50ID0gbmV3IEJpdGZpZWxkU2VnbWVudChpIC8gV09SRFNfUEVSX1NFR01FTlQsIGJpdGZpZWxkKQogICAgICB0aGlzLl9zZWdtZW50cy5zZXQoc2VnbWVudC5pbmRleCwgc2VnbWVudCkKCiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgYml0ZmllbGQubGVuZ3RoOyBqICs9IFdPUkRTX1BFUl9QQUdFKSB7CiAgICAgICAgY29uc3QgcGFnZSA9IG5ldyBCaXRmaWVsZFBhZ2UoKGkgKyBqKSAvIFdPUkRTX1BFUl9QQUdFLCBzZWdtZW50KQogICAgICAgIHRoaXMuX3BhZ2VzLnNldChwYWdlLmluZGV4LCBwYWdlKQogICAgICB9CiAgICB9CiAgfQoKICBzdGF0aWMgZnJvbShiaXRmaWVsZCkgewogICAgcmV0dXJuIG5ldyBCaXRmaWVsZChiaXRmaWVsZC50b0J1ZmZlcihiaXRmaWVsZC5fcGFnZXMubWF4TGVuZ3RoICogQklUU19QRVJfUEFHRSkpCiAgfQoKICB0b0J1ZmZlcihsZW5ndGgpIHsKICAgIGNvbnN0IHBhZ2VzID0gTWF0aC5jZWlsKGxlbmd0aCAvIEJJVFNfUEVSX1BBR0UpCiAgICBjb25zdCBidWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUocGFnZXMgKiBCWVRFU19QRVJfUEFHRSkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhZ2VzOyBpKyspIHsKICAgICAgY29uc3QgcGFnZSA9IHRoaXMuX3BhZ2VzLmdldChpKQogICAgICBjb25zdCBvZmZzZXQgPSBpICogQllURVNfUEVSX1BBR0UKCiAgICAgIGlmIChwYWdlKSB7CiAgICAgICAgY29uc3QgYnVmID0gYjRhLmZyb20oCiAgICAgICAgICBwYWdlLmJpdGZpZWxkLmJ1ZmZlciwKICAgICAgICAgIHBhZ2UuYml0ZmllbGQuYnl0ZU9mZnNldCwKICAgICAgICAgIHBhZ2UuYml0ZmllbGQuYnl0ZUxlbmd0aAogICAgICAgICkKCiAgICAgICAgYnVmZmVyLnNldChidWYsIG9mZnNldCkKICAgICAgfSBlbHNlIHsKICAgICAgICBidWZmZXIuZmlsbCgwLCBvZmZzZXQsIG9mZnNldCArIEJZVEVTX1BFUl9QQUdFKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGJ1ZmZlcgogIH0KCiAgZ2V0Qml0ZmllbGQoaW5kZXgpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmdldFBhZ2VJbmRleChpbmRleCkKCiAgICBjb25zdCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCiAgICByZXR1cm4gcCB8fCBudWxsCiAgfQoKICBtZXJnZShiaXRmaWVsZCwgbGVuZ3RoKSB7CiAgICBsZXQgaSA9IDAKCiAgICB3aGlsZSAoaSA8IGxlbmd0aCkgewogICAgICBjb25zdCBzdGFydCA9IGJpdGZpZWxkLmZpcnN0U2V0KGkpCiAgICAgIGlmIChzdGFydCA9PT0gLTEpIGJyZWFrCgogICAgICBpID0gYml0ZmllbGQuZmlyc3RVbnNldChzdGFydCkKCiAgICAgIGlmIChpID09PSAtMSB8fCBpID4gbGVuZ3RoKSBpID0gbGVuZ3RoCgogICAgICB0aGlzLnNldFJhbmdlKHN0YXJ0LCBpLCB0cnVlKQoKICAgICAgaWYgKGkgPj0gbGVuZ3RoKSBicmVhawogICAgfQogIH0KCiAgZ2V0KGluZGV4KSB7CiAgICBjb25zdCBqID0gaW5kZXggJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBjb25zdCBpID0gKGluZGV4IC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgY29uc3QgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgIHJldHVybiBwID8gcC5nZXQoaikgOiBmYWxzZQogIH0KCiAgZ2V0UGFnZUJ5dGVMZW5ndGgoKSB7CiAgICByZXR1cm4gQllURVNfUEVSX1BBR0UKICB9CgogIGdldFBhZ2VJbmRleChpbmRleCkgewogICAgY29uc3QgaiA9IGluZGV4ICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgcmV0dXJuIChpbmRleCAtIGopIC8gQklUU19QRVJfUEFHRQogIH0KCiAgZ2V0UGFnZShpbmRleCwgY3JlYXRlKSB7CiAgICBjb25zdCBpID0gdGhpcy5nZXRQYWdlSW5kZXgoaW5kZXgpCgogICAgbGV0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKCiAgICBpZiAocCkgcmV0dXJuIHAKCiAgICBpZiAoIWNyZWF0ZSkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBrID0gTWF0aC5mbG9vcihpIC8gUEFHRVNfUEVSX1NFR01FTlQpCiAgICBjb25zdCBzID0KICAgICAgdGhpcy5fc2VnbWVudHMuZ2V0KGspIHx8CiAgICAgIHRoaXMuX3NlZ21lbnRzLnNldCgKICAgICAgICBrLAogICAgICAgIG5ldyBCaXRmaWVsZFNlZ21lbnQoCiAgICAgICAgICBrLAogICAgICAgICAgbmV3IFVpbnQzMkFycmF5KGsgPT09IDAgPyBJTklUSUFMX1dPUkRTX1BFUl9TRUdNRU5UIDogV09SRFNfUEVSX1NFR01FTlQpCiAgICAgICAgKQogICAgICApCgogICAgcCA9IHRoaXMuX3BhZ2VzLnNldChpLCBuZXcgQml0ZmllbGRQYWdlKGksIHMpKQoKICAgIHJldHVybiBwCiAgfQoKICBzZXQoaW5kZXgsIHZhbCkgewogICAgY29uc3QgaiA9IGluZGV4ICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgY29uc3QgaSA9IChpbmRleCAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIGxldCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCgogICAgaWYgKCFwICYmIHZhbCkgewogICAgICBjb25zdCBrID0gTWF0aC5mbG9vcihpIC8gUEFHRVNfUEVSX1NFR01FTlQpCiAgICAgIGNvbnN0IHMgPQogICAgICAgIHRoaXMuX3NlZ21lbnRzLmdldChrKSB8fAogICAgICAgIHRoaXMuX3NlZ21lbnRzLnNldCgKICAgICAgICAgIGssCiAgICAgICAgICBuZXcgQml0ZmllbGRTZWdtZW50KAogICAgICAgICAgICBrLAogICAgICAgICAgICBuZXcgVWludDMyQXJyYXkoayA9PT0gMCA/IElOSVRJQUxfV09SRFNfUEVSX1NFR01FTlQgOiBXT1JEU19QRVJfU0VHTUVOVCkKICAgICAgICAgICkKICAgICAgICApCgogICAgICBwID0gdGhpcy5fcGFnZXMuc2V0KGksIG5ldyBCaXRmaWVsZFBhZ2UoaSwgcykpCiAgICB9CgogICAgaWYgKHApIHAuc2V0KGosIHZhbCkKICB9CgogIHNldFJhbmdlKHN0YXJ0LCBlbmQsIHZhbCkgewogICAgbGV0IGogPSBzdGFydCAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGxldCBpID0gKHN0YXJ0IC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgd2hpbGUgKHN0YXJ0IDwgZW5kKSB7CiAgICAgIGxldCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCgogICAgICBpZiAoIXAgJiYgdmFsKSB7CiAgICAgICAgY29uc3QgayA9IE1hdGguZmxvb3IoaSAvIFBBR0VTX1BFUl9TRUdNRU5UKQogICAgICAgIGNvbnN0IHMgPQogICAgICAgICAgdGhpcy5fc2VnbWVudHMuZ2V0KGspIHx8CiAgICAgICAgICB0aGlzLl9zZWdtZW50cy5zZXQoCiAgICAgICAgICAgIGssCiAgICAgICAgICAgIG5ldyBCaXRmaWVsZFNlZ21lbnQoCiAgICAgICAgICAgICAgaywKICAgICAgICAgICAgICBuZXcgVWludDMyQXJyYXkoayA9PT0gMCA/IElOSVRJQUxfV09SRFNfUEVSX1NFR01FTlQgOiBXT1JEU19QRVJfU0VHTUVOVCkKICAgICAgICAgICAgKQogICAgICAgICAgKQoKICAgICAgICBwID0gdGhpcy5fcGFnZXMuc2V0KGksIG5ldyBCaXRmaWVsZFBhZ2UoaSwgcykpCiAgICAgIH0KCiAgICAgIGNvbnN0IG9mZnNldCA9IGkgKiBCSVRTX1BFUl9QQUdFCiAgICAgIGNvbnN0IGxhc3QgPSBNYXRoLm1pbihlbmQgLSBvZmZzZXQsIEJJVFNfUEVSX1BBR0UpCiAgICAgIGNvbnN0IHJhbmdlID0gbGFzdCAtIGoKCiAgICAgIGlmIChwKSBwLnNldFJhbmdlKGosIGxhc3QsIHZhbCkKCiAgICAgIGogPSAwCiAgICAgIGkrKwogICAgICBzdGFydCArPSByYW5nZQogICAgfQogIH0KCiAgZmluZEZpcnN0KHZhbCwgcG9zaXRpb24pIHsKICAgIGxldCBqID0gcG9zaXRpb24gJiAoQklUU19QRVJfU0VHTUVOVCAtIDEpCiAgICBsZXQgaSA9IChwb3NpdGlvbiAtIGopIC8gQklUU19QRVJfU0VHTUVOVAoKICAgIHdoaWxlIChpIDwgdGhpcy5fc2VnbWVudHMubWF4TGVuZ3RoKSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLl9zZWdtZW50cy5nZXQoaSkKCiAgICAgIGxldCBpbmRleCA9IC0xCgogICAgICBpZiAocykgaW5kZXggPSBzLmZpbmRGaXJzdCh2YWwsIGopCiAgICAgIGVsc2UgaWYgKCF2YWwpIGluZGV4ID0gagoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIGkgKiBCSVRTX1BFUl9TRUdNRU5UICsgaW5kZXgKCiAgICAgIGogPSAwCiAgICAgIGkrKwogICAgfQoKICAgIHJldHVybiB2YWwgPyAtMSA6IHRoaXMuX3NlZ21lbnRzLm1heExlbmd0aCAqIEJJVFNfUEVSX1NFR01FTlQKICB9CgogIGZpcnN0U2V0KHBvc2l0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5maW5kRmlyc3QodHJ1ZSwgcG9zaXRpb24pCiAgfQoKICBmaXJzdFVuc2V0KHBvc2l0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5maW5kRmlyc3QoZmFsc2UsIHBvc2l0aW9uKQogIH0KCiAgZmluZExhc3QodmFsLCBwb3NpdGlvbikgewogICAgbGV0IGogPSBwb3NpdGlvbiAmIChCSVRTX1BFUl9TRUdNRU5UIC0gMSkKICAgIGxldCBpID0gKHBvc2l0aW9uIC0gaikgLyBCSVRTX1BFUl9TRUdNRU5UCgogICAgd2hpbGUgKGkgPj0gMCkgewogICAgICBjb25zdCBzID0gdGhpcy5fc2VnbWVudHMuZ2V0KGkpCgogICAgICBsZXQgaW5kZXggPSAtMQoKICAgICAgaWYgKHMpIGluZGV4ID0gcy5maW5kTGFzdCh2YWwsIGopCiAgICAgIGVsc2UgaWYgKCF2YWwpIGluZGV4ID0gagoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIGkgKiBCSVRTX1BFUl9TRUdNRU5UICsgaW5kZXgKCiAgICAgIGogPSBCSVRTX1BFUl9TRUdNRU5UIC0gMQogICAgICBpLS0KICAgIH0KCiAgICByZXR1cm4gLTEKICB9CgogIGxhc3RTZXQocG9zaXRpb24pIHsKICAgIHJldHVybiB0aGlzLmZpbmRMYXN0KHRydWUsIHBvc2l0aW9uKQogIH0KCiAgbGFzdFVuc2V0KHBvc2l0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5maW5kTGFzdChmYWxzZSwgcG9zaXRpb24pCiAgfQoKICBoYXNTZXQoc3RhcnQsIGxlbmd0aCkgewogICAgY29uc3QgZW5kID0gc3RhcnQgKyBsZW5ndGgKCiAgICBsZXQgaiA9IHN0YXJ0ICYgKEJJVFNfUEVSX1NFR01FTlQgLSAxKQogICAgbGV0IGkgPSAoc3RhcnQgLSBqKSAvIEJJVFNfUEVSX1NFR01FTlQKCiAgICB3aGlsZSAoaSA8IHRoaXMuX3NlZ21lbnRzLm1heExlbmd0aCkgewogICAgICBjb25zdCBzID0gdGhpcy5fc2VnbWVudHMuZ2V0KGkpCgogICAgICBsZXQgaW5kZXggPSAtMQoKICAgICAgaWYgKHMpIGluZGV4ID0gcy5maW5kRmlyc3QodHJ1ZSwgaikKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBpICogQklUU19QRVJfU0VHTUVOVCArIGluZGV4IDwgZW5kCgogICAgICBqID0gMAogICAgICBpKysKCiAgICAgIGlmIChpICogQklUU19QRVJfU0VHTUVOVCA+PSBlbmQpIHJldHVybiBmYWxzZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgY291bnQoc3RhcnQsIGxlbmd0aCwgdmFsKSB7CiAgICBsZXQgaiA9IHN0YXJ0ICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgbGV0IGkgPSAoc3RhcnQgLSBqKSAvIEJJVFNfUEVSX1BBR0UKICAgIGxldCBjID0gMAoKICAgIHdoaWxlIChsZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKCiAgICAgIGNvbnN0IGVuZCA9IE1hdGgubWluKGogKyBsZW5ndGgsIEJJVFNfUEVSX1BBR0UpCiAgICAgIGNvbnN0IHJhbmdlID0gZW5kIC0gagoKICAgICAgaWYgKHApIGMgKz0gcC5jb3VudChqLCByYW5nZSwgdmFsKQogICAgICBlbHNlIGlmICghdmFsKSBjICs9IHJhbmdlCgogICAgICBqID0gMAogICAgICBpKysKICAgICAgbGVuZ3RoIC09IHJhbmdlCiAgICB9CgogICAgcmV0dXJuIGMKICB9CgogIGNvdW50U2V0KHN0YXJ0LCBsZW5ndGgpIHsKICAgIHJldHVybiB0aGlzLmNvdW50KHN0YXJ0LCBsZW5ndGgsIHRydWUpCiAgfQoKICBjb3VudFVuc2V0KHN0YXJ0LCBsZW5ndGgpIHsKICAgIHJldHVybiB0aGlzLmNvdW50KHN0YXJ0LCBsZW5ndGgsIGZhbHNlKQogIH0KCiAgKndhbnQoc3RhcnQsIGxlbmd0aCkgewogICAgY29uc3QgaiA9IHN0YXJ0ICYgKEJJVFNfUEVSX1NFR01FTlQgLSAxKQogICAgbGV0IGkgPSAoc3RhcnQgLSBqKSAvIEJJVFNfUEVSX1NFR01FTlQKCiAgICB3aGlsZSAobGVuZ3RoID4gMCkgewogICAgICBjb25zdCBzID0gdGhpcy5fc2VnbWVudHMuZ2V0KGkpCgogICAgICBpZiAocykgewogICAgICAgIC8vIFdlIGFsd2F5cyBzZW5kIGF0IGxlYXN0IDQgS2lCIHdvcnRoIG9mIGJpdGZpZWxkIGluIGEgd2FudCwgcm91bmRpbmcKICAgICAgICAvLyB0byB0aGUgbmVhcmVzdCA0IEtpQi4KICAgICAgICBjb25zdCBlbmQgPSBjZWlsVG8oY2xhbXAobGVuZ3RoIC8gOCwgNDA5NiwgQllURVNfUEVSX1NFR01FTlQpLCA0MDk2KQoKICAgICAgICB5aWVsZCB7CiAgICAgICAgICBzdGFydDogaSAqIEJJVFNfUEVSX1NFR01FTlQsCiAgICAgICAgICBiaXRmaWVsZDogcy5iaXRmaWVsZC5zdWJhcnJheSgwLCBlbmQgLyA0KQogICAgICAgIH0KICAgICAgfQoKICAgICAgaSsrCiAgICAgIGxlbmd0aCAtPSBCSVRTX1BFUl9TRUdNRU5UCiAgICB9CiAgfQoKICBjbGVhcih0eCkgewogICAgcmV0dXJuIHR4LmRlbGV0ZUJpdGZpZWxkUGFnZVJhbmdlKDAsIC0xKQogIH0KCiAgb251cGRhdGUocmFuZ2VzKSB7CiAgICBmb3IgKGNvbnN0IHsgc3RhcnQsIGVuZCwgdmFsdWUgfSBvZiByYW5nZXMpIHsKICAgICAgdGhpcy5zZXRSYW5nZShzdGFydCwgZW5kLCB2YWx1ZSkKICAgIH0KICB9CgogIHN0YXRpYyBhc3luYyBvcGVuKHN0b3JhZ2UsIGxlbmd0aCkgewogICAgaWYgKGxlbmd0aCA9PT0gMCkgcmV0dXJuIG5ldyBCaXRmaWVsZChzdG9yYWdlLCBudWxsKQoKICAgIGNvbnN0IHBhZ2VzID0gTWF0aC5jZWlsKGxlbmd0aCAvIEJJVFNfUEVSX1BBR0UpCiAgICBjb25zdCBidWZmZXIgPSBiNGEuYWxsb2MocGFnZXMgKiBCWVRFU19QRVJfUEFHRSkKICAgIGNvbnN0IHN0cmVhbSA9IHN0b3JhZ2UuY3JlYXRlQml0ZmllbGRTdHJlYW0oeyBsdDogcGFnZXMgfSkKCiAgICBmb3IgYXdhaXQgKGNvbnN0IHsgaW5kZXgsIHBhZ2UgfSBvZiBzdHJlYW0pIHsKICAgICAgYnVmZmVyLnNldChwYWdlLCBpbmRleCAqIEJZVEVTX1BFUl9QQUdFKQogICAgfQoKICAgIHJldHVybiBuZXcgQml0ZmllbGQoYnVmZmVyKQogIH0KfQoKZnVuY3Rpb24gY2xhbXAobiwgbWluLCBtYXgpIHsKICByZXR1cm4gTWF0aC5taW4oTWF0aC5tYXgobiwgbWluKSwgbWF4KQp9CgpmdW5jdGlvbiBjZWlsVG8obiwgbXVsdGlwbGUgPSAxKSB7CiAgY29uc3QgcmVtYWluZGVyID0gbiAlIG11bHRpcGxlCiAgaWYgKHJlbWFpbmRlciA9PT0gMCkgcmV0dXJuIG4KICByZXR1cm4gbiArIG11bHRpcGxlIC0gcmVtYWluZGVyCn0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCgovLyBUT0RPOiByZW5hbWUgdGhpcyB0byAiY3J5cHRvIiBhbmQgbW92ZSBldmVyeXRoaW5nIGhhc2hpbmcgcmVsYXRlZCBldGMgaW4gaGVyZQovLyBBbHNvIGxldHMgbW92ZSB0aGUgdHJlZSBzdHVmZiBmcm9tIGh5cGVyY29yZS1jcnlwdG8gaGVyZQoKY29uc3QgWwogIFRSRUUsCiAgUkVQTElDQVRFX0lOSVRJQVRPUiwKICBSRVBMSUNBVEVfUkVTUE9OREVSLAogIE1BTklGRVNULAogIERFRkFVTFRfTkFNRVNQQUNFLAogIERFRkFVTFRfRU5DUllQVElPTgpdID0gY3J5cHRvLm5hbWVzcGFjZSgnaHlwZXJjb3JlJywgNikKCmV4cG9ydHMuTUFOSUZFU1QgPSBNQU5JRkVTVApleHBvcnRzLkRFRkFVTFRfTkFNRVNQQUNFID0gREVGQVVMVF9OQU1FU1BBQ0UKZXhwb3J0cy5ERUZBVUxUX0VOQ1JZUFRJT04gPSBERUZBVUxUX0VOQ1JZUFRJT04KCmV4cG9ydHMucmVwbGljYXRlID0gZnVuY3Rpb24gKGlzSW5pdGlhdG9yLCBrZXksIGhhbmRzaGFrZUhhc2gpIHsKICBjb25zdCBvdXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaCgKICAgIG91dCwKICAgIFtpc0luaXRpYXRvciA/IFJFUExJQ0FURV9JTklUSUFUT1IgOiBSRVBMSUNBVEVfUkVTUE9OREVSLCBrZXldLAogICAgaGFuZHNoYWtlSGFzaAogICkKICByZXR1cm4gb3V0Cn0KCmV4cG9ydHMudHJlZVNpZ25hYmxlID0gZnVuY3Rpb24gKG1hbmlmZXN0SGFzaCwgdHJlZUhhc2gsIGxlbmd0aCwgZm9yaykgewogIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiAxMTIsIGJ1ZmZlcjogYjRhLmFsbG9jVW5zYWZlKDExMikgfQogIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIFRSRUUpCiAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbWFuaWZlc3RIYXNoKQogIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIHRyZWVIYXNoKQogIGMudWludDY0LmVuY29kZShzdGF0ZSwgbGVuZ3RoKQogIGMudWludDY0LmVuY29kZShzdGF0ZSwgZm9yaykKICByZXR1cm4gc3RhdGUuYnVmZmVyCn0KCmV4cG9ydHMudHJlZVNpZ25hYmxlQ29tcGF0ID0gZnVuY3Rpb24gKGhhc2gsIGxlbmd0aCwgZm9yaywgbm9IZWFkZXIpIHsKICBjb25zdCBlbmQgPSBub0hlYWRlciA/IDQ4IDogODAKICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZCwgYnVmZmVyOiBiNGEuYWxsb2NVbnNhZmUoZW5kKSB9CiAgaWYgKCFub0hlYWRlcikgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgVFJFRSkgLy8gdWx0cmEgbGVnYWN5IG1vZGUsIGtpbGwgaW4gZnV0dXJlIG1ham9yCiAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgaGFzaCkKICBjLnVpbnQ2NC5lbmNvZGUoc3RhdGUsIGxlbmd0aCkKICBjLnVpbnQ2NC5lbmNvZGUoc3RhdGUsIGZvcmspCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlcgp9Ci8vIEV4cG9ydCB0aGUgYXBwcm9wcmlhdGUgdmVyc2lvbiBvZiBgcXVpY2tiaXQtdW5pdmVyc2FsYCBhcyB0aGUgcGxhaW4gaW1wb3J0Ci8vIG1heSByZXNvbHZlIHRvIGFuIG9sZGVyIHZlcnNpb24gaW4gc29tZSBlbnZpcm9ubWVudHMKbGV0IHF1aWNrYml0ID0gcmVxdWlyZSgncXVpY2tiaXQtdW5pdmVyc2FsJykKaWYgKAogIHR5cGVvZiBxdWlja2JpdC5maW5kRmlyc3QgIT09ICdmdW5jdGlvbicgfHwKICB0eXBlb2YgcXVpY2tiaXQuZmluZExhc3QgIT09ICdmdW5jdGlvbicgfHwKICB0eXBlb2YgcXVpY2tiaXQuY2xlYXIgIT09ICdmdW5jdGlvbicKKSB7CiAgLy8gVGhpcyBzaG91bGQgYWx3YXlzIGxvYWQgdGhlIGZhbGxiYWNrIGZyb20gdGhlIGxvY2FsbHkgaW5zdGFsbGVkIHZlcnNpb24KICBxdWlja2JpdCA9IHJlcXVpcmUoJ3F1aWNrYml0LXVuaXZlcnNhbC9mYWxsYmFjaycpCn0KZXhwb3J0cy5xdWlja2JpdCA9IHF1aWNrYml0CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBmbGF0ID0gcmVxdWlyZSgnZmxhdC10cmVlJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgcXVpY2tiaXQgPSByZXF1aXJlKCdxdWlja2JpdC11bml2ZXJzYWwnKQpjb25zdCBCaXRmaWVsZCA9IHJlcXVpcmUoJy4vYml0ZmllbGQnKQoKY29uc3QgTUFYX0JBVENIX1VTRUQgPSA0ICogMTAyNCAqIDEwMjQKY29uc3QgTUlOX0JBVENIX1VTRUQgPSA1MTIgKiAxMDI0CgovLyBqdXN0IGluIGl0cyBvd24gZmlsZSBhcyBpdHMgYSBiaXQgaW52b2x2ZWQKCm1vZHVsZS5leHBvcnRzID0gY29weVByb2xvZ3VlCgphc3luYyBmdW5jdGlvbiBjb3B5UHJvbG9ndWUoc3JjLCBkc3QpIHsKICBjb25zdCBwcm9sb2d1ZSA9IGRzdC5oZWFkZXIubWFuaWZlc3QucHJvbG9ndWUKCiAgaWYgKHNyYy5sZW5ndGggPCBwcm9sb2d1ZS5sZW5ndGggfHwgcHJvbG9ndWUubGVuZ3RoID09PSAwKSByZXR1cm4KCiAgY29uc3Qgc3RhY2sgPSBbXQogIGNvbnN0IHJvb3RzID0gZmxhdC5mdWxsUm9vdHMocHJvbG9ndWUubGVuZ3RoICogMikKICBjb25zdCBiYXRjaCA9IHsgcm9vdHMsIGZpcnN0OiB0cnVlLCBsYXN0OiBmYWxzZSwgY29udGlnOiAwLCB1c2VkOiAwLCB0cmVlOiBbXSwgYmxvY2tzOiBbXSB9CgogIGZvciAobGV0IGkgPSAwOyBpIDwgcm9vdHMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IG5vZGUgPSByb290c1tpXQogICAgYmF0Y2gudHJlZS5wdXNoKG5vZGUpCiAgICBzdGFjay5wdXNoKG5vZGUpCiAgfQoKICBsZXQgbGFzdFBhZ2UgPSAtMQogIGxldCBsYXN0QmxvY2sgPSAtMQoKICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2Ygc3JjLnN0b3JhZ2UuY3JlYXRlQmxvY2tTdHJlYW0oewogICAgZ3RlOiAwLAogICAgbHQ6IHByb2xvZ3VlLmxlbmd0aCwKICAgIHJldmVyc2U6IHRydWUKICB9KSkgewogICAgaWYgKHdhbGtUcmVlKHN0YWNrLCBkYXRhLmluZGV4ICogMiwgYmF0Y2gpID09PSBmYWxzZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgYmxvY2sgb3IgdHJlZSBub2RlIGZvciAnICsgZGF0YS5pbmRleCkKICAgIH0KCiAgICBiYXRjaC5jb250aWcgPSBkYXRhLmluZGV4ICsgMSA9PT0gbGFzdEJsb2NrID8gYmF0Y2guY29udGlnICsgMSA6IDEKICAgIGxhc3RCbG9jayA9IGRhdGEuaW5kZXgKCiAgICBjb25zdCBwYWdlID0gZ2V0Qml0ZmllbGRQYWdlKGRhdGEuaW5kZXgpCiAgICBiYXRjaC5ibG9ja3MucHVzaChkYXRhKQoKICAgIGlmIChsYXN0UGFnZSAhPT0gcGFnZSkgYmF0Y2gudXNlZCArPSA0MDk2CiAgICBiYXRjaC51c2VkICs9IE1hdGgubWF4KGRhdGEudmFsdWUuYnl0ZUxlbmd0aCwgMTI4KSAvLyAxMjggaXMganVzdCBhIHNhbml0eSBudW1iZXIgdG8gYXZvaWQgbWVnYSBiYXRjaGVzCgogICAgLy8gYWx3YXlzIHNhZmUgdG8gcGFydGlhbGx5IGZsdXNoIHNvIHdlIGRvIHRoYXQgb25kZW1hbmQgdG8gcmVkdWNlIG1lbW9yeSB1c2FnZS4uLgogICAgaWYgKChiYXRjaC51c2VkID49IE1JTl9CQVRDSF9VU0VEICYmIHBhZ2UgIT09IGxhc3RQYWdlKSB8fCBiYXRjaC51c2VkID49IE1BWF9CQVRDSF9VU0VEKSB7CiAgICAgIGF3YWl0IGZsdXNoQmF0Y2gocHJvbG9ndWUsIHNyYywgZHN0LCBiYXRjaCkKICAgIH0KCiAgICBsYXN0UGFnZSA9IHBhZ2UKICB9CgogIGlmIChsYXN0QmxvY2sgIT09IDApIGJhdGNoLmNvbnRpZyA9IDAKCiAgYmF0Y2gubGFzdCA9IHRydWUKICBhd2FpdCBmbHVzaEJhdGNoKHByb2xvZ3VlLCBzcmMsIGRzdCwgYmF0Y2gpCn0KCmFzeW5jIGZ1bmN0aW9uIGZsdXNoQmF0Y2gocHJvbG9ndWUsIHNyYywgZHN0LCBiYXRjaCkgewogIGNvbnN0IG5vZGVQcm9taXNlcyA9IFtdCgogIGNvbnN0IHNyY1JlYWRlciA9IHNyYy5zdG9yYWdlLnJlYWQoKQogIGZvciAoY29uc3QgaW5kZXggb2YgYmF0Y2gudHJlZSkgewogICAgbm9kZVByb21pc2VzLnB1c2goc3JjUmVhZGVyLmdldFRyZWVOb2RlKGluZGV4KSkKICB9CiAgc3JjUmVhZGVyLnRyeUZsdXNoKCkKCiAgY29uc3Qgbm9kZXMgPSBhd2FpdCBQcm9taXNlLmFsbChub2RlUHJvbWlzZXMpCgogIGNvbnN0IHBhZ2VQcm9taXNlcyA9IFtdCiAgY29uc3QgZHN0UmVhZGVyID0gZHN0LnN0b3JhZ2UucmVhZCgpCgogIGNvbnN0IGhlYWRQcm9taXNlID0gYmF0Y2guZmlyc3QgPyBkc3RSZWFkZXIuZ2V0SGVhZCgpIDogbnVsbAogIGlmIChoZWFkUHJvbWlzZSkgaGVhZFByb21pc2UuY2F0Y2gobm9vcCkKCiAgbGV0IGxhc3RQYWdlID0gLTEKICBmb3IgKGNvbnN0IHsgaW5kZXggfSBvZiBiYXRjaC5ibG9ja3MpIHsKICAgIGNvbnN0IHBhZ2UgPSBnZXRCaXRmaWVsZFBhZ2UoaW5kZXgpCiAgICBpZiAocGFnZSA9PT0gbGFzdFBhZ2UpIGNvbnRpbnVlCiAgICBsYXN0UGFnZSA9IHBhZ2UKICAgIHBhZ2VQcm9taXNlcy5wdXNoKGRzdFJlYWRlci5nZXRCaXRmaWVsZFBhZ2UocGFnZSkpCiAgfQoKICBkc3RSZWFkZXIudHJ5Rmx1c2goKQoKICBjb25zdCBwYWdlcyA9IGF3YWl0IFByb21pc2UuYWxsKHBhZ2VQcm9taXNlcykKICBjb25zdCBoZWFkID0gaGVhZFByb21pc2UgPT09IG51bGwgPyBudWxsIDogYXdhaXQgaGVhZFByb21pc2UKICBjb25zdCB1c2VyRGF0YSA9IFtdCgogIC8vIHJlYWRzIGRvbmUhCgogIGlmIChiYXRjaC5maXJzdCkgewogICAgY29uc3Qgcm9vdHMgPSBub2Rlcy5zbGljZSgwLCBiYXRjaC5yb290cy5sZW5ndGgpCgogICAgZm9yIChjb25zdCBub2RlIG9mIHJvb3RzKSB7CiAgICAgIGlmICghbm9kZSkgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIG5vZGVzIGZvciBwcm9sb2d1ZSBoYXNoJykKICAgIH0KCiAgICBjb25zdCB0cmVlSGFzaCA9IGNyeXB0by50cmVlKHJvb3RzKQogICAgaWYgKCFiNGEuZXF1YWxzKHRyZWVIYXNoLCBwcm9sb2d1ZS5oYXNoKSkgdGhyb3cgbmV3IEVycm9yKCdQcm9sb2d1ZSBkb2VzIG5vdCBtYXRjaCBzb3VyY2UnKQogIH0KCiAgaWYgKGJhdGNoLmZpcnN0KSB7CiAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2Ygc3JjLnN0b3JhZ2UuY3JlYXRlVXNlckRhdGFTdHJlYW0oKSkgdXNlckRhdGEucHVzaChkYXRhKQogIH0KCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYWdlcy5sZW5ndGg7IGkrKykgewogICAgaWYgKCFwYWdlc1tpXSkgcGFnZXNbaV0gPSBiNGEuYWxsb2MoNDA5NikKICB9CgogIGNvbnN0IHR4ID0gZHN0LnN0b3JhZ2Uud3JpdGUoKQoKICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIHR4LnB1dFRyZWVOb2RlKG5vZGUpCgogIGxhc3RQYWdlID0gLTEKICBsZXQgcGFnZUluZGV4ID0gLTEKCiAgZm9yIChjb25zdCB7IGluZGV4LCB2YWx1ZSB9IG9mIGJhdGNoLmJsb2NrcykgewogICAgY29uc3QgcGFnZSA9IGdldEJpdGZpZWxkUGFnZShpbmRleCkKCiAgICBpZiAocGFnZSAhPT0gbGFzdFBhZ2UpIHsKICAgICAgbGFzdFBhZ2UgPSBwYWdlCiAgICAgIHBhZ2VJbmRleCsrCiAgICAgIC8vIHF1ZXVlIHRoZSBwYWdlIG5vdywgd2UgbXV0YXRlIGl0IGJlbG93IGJ1dCBpdHMgdGhlIHNhbWUgcmVmCiAgICAgIHR4LnB1dEJpdGZpZWxkUGFnZShwYWdlSW5kZXgsIHBhZ2VzW3BhZ2VJbmRleF0pCiAgICB9CgogICAgY29uc3QgcGFnZUJ1ZmZlciA9IHBhZ2VzW3BhZ2VJbmRleF0KICAgIHF1aWNrYml0LnNldChwYWdlQnVmZmVyLCBnZXRCaXRmaWVsZE9mZnNldChpbmRleCksIHRydWUpCiAgICB0eC5wdXRCbG9jayhpbmRleCwgdmFsdWUpCiAgfQoKICBmb3IgKGNvbnN0IHsga2V5LCB2YWx1ZSB9IG9mIHVzZXJEYXRhKSB7CiAgICB0eC5wdXRVc2VyRGF0YShrZXksIHZhbHVlKQogIH0KCiAgbGV0IHVwZ3JhZGVkID0gYmF0Y2guZmlyc3QgJiYgIWhlYWQKICBpZiAodXBncmFkZWQpIHsKICAgIHR4LnNldEhlYWQocHJvbG9ndWVUb1RyZWUocHJvbG9ndWUpKQogIH0KCiAgYXdhaXQgdHguZmx1c2goKQoKICBpZiAodXBncmFkZWQpIHsKICAgIGNvbnN0IHJvb3RzID0gbm9kZXMuc2xpY2UoMCwgYmF0Y2gucm9vdHMubGVuZ3RoKQogICAgZHN0LnN0YXRlLnNldFJvb3RzKHJvb3RzKQogICAgZHN0LmhlYWRlci50cmVlID0gcHJvbG9ndWVUb1RyZWUocHJvbG9ndWUpCiAgfQoKICBpZiAodXNlckRhdGEubGVuZ3RoID4gMCkgewogICAgZHN0LmhlYWRlci51c2VyRGF0YSA9IHVzZXJEYXRhLmNvbmNhdChkc3QuaGVhZGVyLnVzZXJEYXRhKQogIH0KCiAgaWYgKGJhdGNoLmNvbnRpZykgewogICAgLy8gVE9ETzogd2UgbmVlZCB0byBwZXJzaXN0IHRoaXMgc29tZWhvdwogICAgZHN0LmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoID0gYmF0Y2guY29udGlnCiAgfQoKICBsZXQgc3RhcnQgPSAwCiAgbGV0IGxlbmd0aCA9IDAKCiAgLy8gdXBkYXRlIGluIG1lbW9yeSBiaXRmaWVsZAogIGZvciAoY29uc3QgeyBpbmRleCB9IG9mIGJhdGNoLmJsb2NrcykgewogICAgaWYgKHN0YXJ0ID09PSAwIHx8IHN0YXJ0IC0gMSA9PT0gaW5kZXgpIHsKICAgICAgbGVuZ3RoKysKICAgIH0gZWxzZSB7CiAgICAgIGlmIChsZW5ndGggPiAwKSBzaWduYWxSZXBsaWNhdG9yKGRzdCwgdXBncmFkZWQsIHN0YXJ0LCBsZW5ndGgpCiAgICAgIHVwZ3JhZGVkID0gZmFsc2UKICAgICAgbGVuZ3RoID0gMQogICAgfQoKICAgIHN0YXJ0ID0gaW5kZXgKICAgIGRzdC5iaXRmaWVsZC5zZXQoaW5kZXgsIHRydWUpCiAgfQoKICBpZiAobGVuZ3RoID4gMCkgc2lnbmFsUmVwbGljYXRvcihkc3QsIHVwZ3JhZGVkLCBzdGFydCwgbGVuZ3RoKQoKICAvLyB1bmxpbmsKICBiYXRjaC50cmVlID0gW10KICBiYXRjaC5ibG9ja3MgPSBbXQogIGJhdGNoLmZpcnN0ID0gZmFsc2UKICBiYXRjaC51c2VkID0gMAp9CgpmdW5jdGlvbiBzaWduYWxSZXBsaWNhdG9yKGNvcmUsIHVwZ3JhZGVkLCBzdGFydCwgbGVuZ3RoKSB7CiAgaWYgKHVwZ3JhZGVkKSB7CiAgICBjb3JlLnJlcGxpY2F0b3IuY29yaygpCiAgICBjb3JlLnJlcGxpY2F0b3Iub25oYXZlKHN0YXJ0LCBsZW5ndGgsIGZhbHNlKQogICAgY29yZS5yZXBsaWNhdG9yLm9udXBncmFkZSgpCiAgICBjb3JlLnJlcGxpY2F0b3IudW5jb3JrKCkKICB9IGVsc2UgewogICAgY29yZS5yZXBsaWNhdG9yLm9uaGF2ZShzdGFydCwgbGVuZ3RoLCBmYWxzZSkKICB9Cn0KCmZ1bmN0aW9uIHByb2xvZ3VlVG9UcmVlKHByb2xvZ3VlKSB7CiAgcmV0dXJuIHsKICAgIGZvcms6IDAsCiAgICBsZW5ndGg6IHByb2xvZ3VlLmxlbmd0aCwKICAgIHJvb3RIYXNoOiBwcm9sb2d1ZS5oYXNoLAogICAgc2lnbmF0dXJlOiBudWxsCiAgfQp9CgpmdW5jdGlvbiBnZXRCaXRmaWVsZFBhZ2UoaW5kZXgpIHsKICByZXR1cm4gTWF0aC5mbG9vcihpbmRleCAvIEJpdGZpZWxkLkJJVFNfUEVSX1BBR0UpCn0KCmZ1bmN0aW9uIGdldEJpdGZpZWxkT2Zmc2V0KGluZGV4KSB7CiAgcmV0dXJuIGluZGV4ICYgKEJpdGZpZWxkLkJJVFNfUEVSX1BBR0UgLSAxKQp9CgpmdW5jdGlvbiB3YWxrVHJlZShzdGFjaywgdGFyZ2V0LCBiYXRjaCkgewogIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7CiAgICBjb25zdCBub2RlID0gc3RhY2sucG9wKCkKCiAgICBpZiAoKG5vZGUgJiAxKSA9PT0gMCkgewogICAgICBpZiAobm9kZSA9PT0gdGFyZ2V0KSByZXR1cm4gdHJ1ZQogICAgICBjb250aW51ZQogICAgfQoKICAgIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3Iobm9kZSkKICAgIGlmICghaXRlLmNvbnRhaW5zKHRhcmdldCkpIGNvbnRpbnVlCgogICAgd2hpbGUgKChpdGUuaW5kZXggJiAxKSAhPT0gMCkgewogICAgICBjb25zdCBsZWZ0ID0gaXRlLmxlZnRDaGlsZCgpCiAgICAgIGNvbnN0IHJpZ2h0ID0gaXRlLnNpYmxpbmcoKSAvLyBpcyByaWdodCBjaGlsZAoKICAgICAgYmF0Y2gudHJlZS5wdXNoKGxlZnQsIHJpZ2h0KQoKICAgICAgaWYgKGl0ZS5jb250YWlucyh0YXJnZXQpKSBzdGFjay5wdXNoKGxlZnQpCiAgICAgIGVsc2UgaXRlLnNpYmxpbmcoKQogICAgfQoKICAgIGlmIChpdGUuaW5kZXggPT09IHRhcmdldCkgcmV0dXJuIHRydWUKICB9CgogIHJldHVybiBmYWxzZQp9CgpmdW5jdGlvbiBub29wKCkge30KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHVuc2xhYiA9IHJlcXVpcmUoJ3Vuc2xhYicpCmNvbnN0IHozMiA9IHJlcXVpcmUoJ3ozMicpCmNvbnN0IE11dGV4ID0gcmVxdWlyZSgnLi9tdXRleCcpCmNvbnN0IHsgTWVya2xlVHJlZSwgUmVvcmdCYXRjaCB9ID0gcmVxdWlyZSgnLi9tZXJrbGUtdHJlZScpCmNvbnN0IEJpdEludGVybHVkZSA9IHJlcXVpcmUoJy4vYml0LWludGVybHVkZScpCmNvbnN0IEJpdGZpZWxkID0gcmVxdWlyZSgnLi9iaXRmaWVsZCcpCmNvbnN0IFJlbW90ZUJpdGZpZWxkID0gcmVxdWlyZSgnLi9yZW1vdGUtYml0ZmllbGQnKQpjb25zdCB7CiAgQkFEX0FSR1VNRU5ULAogIFNUT1JBR0VfRU1QVFksCiAgU1RPUkFHRV9DT05GTElDVCwKICBJTlZBTElEX1NJR05BVFVSRSwKICBJTlZBTElEX0NIRUNLU1VNCn0gPSByZXF1aXJlKCdoeXBlcmNvcmUtZXJyb3JzJykKY29uc3QgVmVyaWZpZXIgPSByZXF1aXJlKCcuL3ZlcmlmaWVyJykKY29uc3QgYXVkaXQgPSByZXF1aXJlKCcuL2F1ZGl0JykKY29uc3QgY29weVByb2xvZ3VlID0gcmVxdWlyZSgnLi9jb3B5LXByb2xvZ3VlJykKY29uc3QgU2Vzc2lvblN0YXRlID0gcmVxdWlyZSgnLi9zZXNzaW9uLXN0YXRlJykKY29uc3QgUmVwbGljYXRvciA9IHJlcXVpcmUoJy4vcmVwbGljYXRvcicpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENvcmUgewogIGNvbnN0cnVjdG9yKGRiLCBvcHRzID0ge30pIHsKICAgIHRoaXMuZGIgPSBkYgogICAgdGhpcy5zdG9yYWdlID0gbnVsbAogICAgdGhpcy5yZXBsaWNhdG9yID0gbmV3IFJlcGxpY2F0b3IodGhpcywgb3B0cykKICAgIHRoaXMuc2Vzc2lvblN0YXRlcyA9IFtdCiAgICB0aGlzLm1vbml0b3JzID0gW10KICAgIHRoaXMuYWN0aXZlU2Vzc2lvbnMgPSAwCiAgICB0aGlzLmdjID0gMCAvLyBjb3Jlc3RvcmUgdXNlcyB0aGlzIHRvIG1haW4gYSBnYyBzdHJpa2UgcG9vbAoKICAgIHRoaXMuaWQgPSBvcHRzLmtleSA/IHozMi5lbmNvZGUob3B0cy5rZXkpIDogbnVsbAogICAgdGhpcy5rZXkgPSBvcHRzLmtleSB8fCBudWxsCiAgICB0aGlzLmRpc2NvdmVyeUtleSA9IG9wdHMuZGlzY292ZXJ5S2V5IHx8IChvcHRzLmtleSAmJiBjcnlwdG8uZGlzY292ZXJ5S2V5KG9wdHMua2V5KSkgfHwgbnVsbAogICAgdGhpcy5tYW5pZmVzdCA9IG51bGwKICAgIHRoaXMub3BlbmluZyA9IG51bGwKICAgIHRoaXMuY2xvc2luZyA9IG51bGwKICAgIHRoaXMuZXhjbHVzaXZlID0gbnVsbAoKICAgIHRoaXMucHJldXBkYXRlID0gbnVsbAogICAgdGhpcy5oZWFkZXIgPSBudWxsCiAgICB0aGlzLmNvbXBhdCA9IGZhbHNlCiAgICB0aGlzLmJpdGZpZWxkID0gbnVsbAogICAgdGhpcy52ZXJpZmllciA9IG51bGwKICAgIHRoaXMudHJ1bmNhdGluZyA9IDAKICAgIHRoaXMudXBkYXRpbmcgPSBmYWxzZQogICAgdGhpcy5za2lwQml0ZmllbGQgPSBudWxsCiAgICB0aGlzLmdsb2JhbENhY2hlID0gb3B0cy5nbG9iYWxDYWNoZSB8fCBudWxsCiAgICB0aGlzLmF1dG9DbG9zZSA9IG9wdHMuYXV0b0Nsb3NlICE9PSBmYWxzZQogICAgdGhpcy5vbmlkbGUgPSBub29wCgogICAgdGhpcy5zdGF0ZSA9IG51bGwKICAgIHRoaXMub3BlbmVkID0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICAgIHRoaXMuY2xvc2VkID0gZmFsc2UKCiAgICB0aGlzLmhpbnRzQ2hhbmdlZCA9IGZhbHNlCgogICAgdGhpcy5fYml0ZmllbGQgPSBudWxsCiAgICB0aGlzLl92ZXJpZmllcyA9IG51bGwKICAgIHRoaXMuX3ZlcmlmaWVzRmx1c2hlZCA9IG51bGwKICAgIHRoaXMuX2xlZ2FjeSA9ICEhb3B0cy5sZWdhY3kKCiAgICB0aGlzLm9wZW5pbmcgPSB0aGlzLl9vcGVuKG9wdHMpCiAgICB0aGlzLm9wZW5pbmcuY2F0Y2gobm9vcCkKICB9CgogIHJlYWR5KCkgewogICAgcmV0dXJuIHRoaXMub3BlbmluZwogIH0KCiAgYWRkTW9uaXRvcihzKSB7CiAgICBpZiAocy5fbW9uaXRvckluZGV4ID49IDApIHJldHVybgogICAgcy5fbW9uaXRvckluZGV4ID0gdGhpcy5tb25pdG9ycy5wdXNoKHMpIC0gMQogIH0KCiAgcmVtb3ZlTW9uaXRvcihzKSB7CiAgICBpZiAocy5fbW9uaXRvckluZGV4IDwgMCkgcmV0dXJuCiAgICBjb25zdCBoZWFkID0gdGhpcy5tb25pdG9ycy5wb3AoKQogICAgaWYgKGhlYWQgIT09IHMpIHRoaXMubW9uaXRvcnNbKGhlYWQuX21vbml0b3JJbmRleCA9IHMuX21vbml0b3JJbmRleCldID0gaGVhZAogICAgcy5fbW9uaXRvckluZGV4ID0gLTEKICB9CgogIGVtaXRNYW5pZmVzdCgpIHsKICAgIGZvciAobGV0IGkgPSB0aGlzLm1vbml0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIHRoaXMubW9uaXRvcnNbaV0uZW1pdCgnbWFuaWZlc3QnKQogICAgfQogIH0KCiAgY3JlYXRlVXNlckRhdGFTdHJlYW0ob3B0cywgc2Vzc2lvbiA9IHRoaXMuc3RhdGUpIHsKICAgIHJldHVybiBzZXNzaW9uLnN0b3JhZ2UuY3JlYXRlVXNlckRhdGFTdHJlYW0ob3B0cykKICB9CgogIGFsbFNlc3Npb25zKCkgewogICAgY29uc3Qgc2Vzc2lvbnMgPSBbXQogICAgZm9yIChjb25zdCBzdGF0ZSBvZiB0aGlzLnNlc3Npb25TdGF0ZXMpIHsKICAgICAgaWYgKHN0YXRlLnNlc3Npb25zLmxlbmd0aCkgc2Vzc2lvbnMucHVzaCguLi5zdGF0ZS5zZXNzaW9ucykKICAgIH0KICAgIHJldHVybiBzZXNzaW9ucwogIH0KCiAgaGFzU2Vzc2lvbigpIHsKICAgIHJldHVybiB0aGlzLmFjdGl2ZVNlc3Npb25zICE9PSAwCiAgfQoKICBjb21wYWN0KCkgewogICAgY29uc3QgY29tcGFjdGluZyA9IFtdCiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5zZXNzaW9uU3RhdGVzKSB7CiAgICAgIGNvbXBhY3RpbmcucHVzaChzLnN0b3JhZ2UuY29tcGFjdCgpKQogICAgfQogICAgcmV0dXJuIFByb21pc2UuYWxsKGNvbXBhY3RpbmcpCiAgfQoKICBjaGVja0lmSWRsZSgpIHsKICAgIGlmICghdGhpcy5vcGVuZWQgfHwgdGhpcy5kZXN0cm95ZWQgPT09IHRydWUgfHwgdGhpcy5oYXNTZXNzaW9uKCkgPT09IHRydWUpIHJldHVybgogICAgaWYgKHRoaXMucmVwbGljYXRvci5pZGxlKCkgPT09IGZhbHNlKSByZXR1cm4KICAgIGlmICh0aGlzLnN0YXRlID09PSBudWxsIHx8IHRoaXMuc3RhdGUubXV0ZXguaWRsZSgpID09PSBmYWxzZSkgcmV0dXJuCiAgICB0aGlzLm9uaWRsZSgpCiAgfQoKICBhc3luYyBsb2NrRXhjbHVzaXZlKCkgewogICAgaWYgKHRoaXMuZXhjbHVzaXZlID09PSBudWxsKSB0aGlzLmV4Y2x1c2l2ZSA9IG5ldyBNdXRleCgpCiAgICBhd2FpdCB0aGlzLmV4Y2x1c2l2ZS5sb2NrKCkKICB9CgogIHVubG9ja0V4Y2x1c2l2ZSgpIHsKICAgIGlmICh0aGlzLmV4Y2x1c2l2ZSAhPT0gbnVsbCkgdGhpcy5leGNsdXNpdmUudW5sb2NrKCkKICB9CgogIGFzeW5jIF9vcGVuKG9wdHMpIHsKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX3RyeU9wZW4ob3B0cykKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLm9uaWRsZSgpCiAgICAgIHRocm93IGVycgogICAgfQoKICAgIHRoaXMub3BlbmVkID0gdHJ1ZQogIH0KCiAgYXN5bmMgX3RyeU9wZW4ob3B0cykgewogICAgaWYgKG9wdHMucHJlb3BlbikgYXdhaXQgb3B0cy5wcmVvcGVuIC8vIGp1c3QgYSBob29rIHRvIGFsbG93IGV4Y2x1c2l2ZSBhY2Nlc3MgaGVyZS4uLgoKICAgIGxldCBzdG9yYWdlID0gYXdhaXQgdGhpcy5kYi5yZXN1bWVDb3JlKHRoaXMuZGlzY292ZXJ5S2V5KQoKICAgIGxldCBvdmVyd3JpdGUgPSBvcHRzLm92ZXJ3cml0ZSA9PT0gdHJ1ZQoKICAgIGNvbnN0IGZvcmNlID0gb3B0cy5mb3JjZSA9PT0gdHJ1ZQogICAgY29uc3QgY3JlYXRlSWZNaXNzaW5nID0gb3B0cy5jcmVhdGVJZk1pc3NpbmcgIT09IGZhbHNlCiAgICAvLyBraWxsIHRoaXMgZmxhZyBzb29uCiAgICBjb25zdCBsZWdhY3kgPSAhIW9wdHMubGVnYWN5CgogICAgLy8gZGVmYXVsdCB0byB0cnVlIGZvciBub3cgaWYgbm8gbWFuaWZlc3QgaXMgcHJvdmlkZWQKICAgIGxldCBjb21wYXQgPSBvcHRzLmNvbXBhdCA9PT0gdHJ1ZSB8fCAob3B0cy5jb21wYXQgIT09IGZhbHNlICYmICFvcHRzLm1hbmlmZXN0KQoKICAgIGxldCBoZWFkZXIgPSBzdG9yYWdlID8gcGFyc2VIZWFkZXIoYXdhaXQgZ2V0Q29yZUluZm8oc3RvcmFnZSkpIDogbnVsbAoKICAgIGNvbnN0IGhhZE1hbmlmZXN0ID0gISFoZWFkZXIgJiYgISFoZWFkZXIubWFuaWZlc3QgJiYgISFoZWFkZXIua2V5CiAgICBjb25zdCBoYWRLZXlQYWlyID0gISFoZWFkZXIgJiYgISFoZWFkZXIua2V5UGFpcgoKICAgIGlmIChmb3JjZSAmJiBvcHRzLmtleSAmJiBoZWFkZXIgJiYgIWI0YS5lcXVhbHMoaGVhZGVyLmtleSwgb3B0cy5rZXkpKSB7CiAgICAgIG92ZXJ3cml0ZSA9IHRydWUKICAgIH0KCiAgICBpZiAoIWhlYWRlciAmJiBvcHRzLmRpc2NvdmVyeUtleSAmJiAhKG9wdHMua2V5IHx8IG9wdHMubWFuaWZlc3QpKSB7CiAgICAgIHRocm93IFNUT1JBR0VfRU1QVFkoJ05vIEh5cGVyY29yZSBpcyBzdG9yZWQgaGVyZScsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIGlmICghaGVhZGVyIHx8IG92ZXJ3cml0ZSkgewogICAgICBpZiAoIWNyZWF0ZUlmTWlzc2luZykgewogICAgICAgIHRocm93IFNUT1JBR0VfRU1QVFkoJ05vIEh5cGVyY29yZSBpcyBzdG9yZWQgaGVyZScsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgICB9CgogICAgICBpZiAoY29tcGF0KSB7CiAgICAgICAgaWYgKG9wdHMua2V5ICYmIG9wdHMua2V5UGFpciAmJiAhYjRhLmVxdWFscyhvcHRzLmtleSwgb3B0cy5rZXlQYWlyLnB1YmxpY0tleSkpIHsKICAgICAgICAgIHRocm93IEJBRF9BUkdVTUVOVCgnS2V5IG11c3QgbWF0Y2ggcHVibGljS2V5IHdoZW4gaW4gY29tcGF0IG1vZGUnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IGtleVBhaXIgPSBvcHRzLmtleVBhaXIgfHwgKG9wdHMua2V5ID8gbnVsbCA6IGNyeXB0by5rZXlQYWlyKCkpCgogICAgICBjb25zdCBkZWZhdWx0TWFuaWZlc3QgPQogICAgICAgICFvcHRzLm1hbmlmZXN0ICYmCiAgICAgICAgKCEhb3B0cy5jb21wYXQgfHwgIW9wdHMua2V5IHx8ICEhKGtleVBhaXIgJiYgYjRhLmVxdWFscyhvcHRzLmtleSwga2V5UGFpci5wdWJsaWNLZXkpKSkKICAgICAgY29uc3QgbWFuaWZlc3QgPSBkZWZhdWx0TWFuaWZlc3QKICAgICAgICA/IFZlcmlmaWVyLmRlZmF1bHRTaWduZXJNYW5pZmVzdChvcHRzLmtleSB8fCBrZXlQYWlyLnB1YmxpY0tleSkKICAgICAgICA6IFZlcmlmaWVyLmNyZWF0ZU1hbmlmZXN0KG9wdHMubWFuaWZlc3QpCgogICAgICBoZWFkZXIgPSB7CiAgICAgICAga2V5OiBvcHRzLmtleSB8fCAoY29tcGF0ID8gbWFuaWZlc3Quc2lnbmVyc1swXS5wdWJsaWNLZXkgOiBWZXJpZmllci5tYW5pZmVzdEhhc2gobWFuaWZlc3QpKSwKICAgICAgICBtYW5pZmVzdCwKICAgICAgICBrZXlQYWlyOiBrZXlQYWlyCiAgICAgICAgICA/IHsgcHVibGljS2V5OiBrZXlQYWlyLnB1YmxpY0tleSwgc2VjcmV0S2V5OiBrZXlQYWlyLnNlY3JldEtleSB8fCBudWxsIH0KICAgICAgICAgIDogbnVsbCwKICAgICAgICBmcm96ZW46IGZhbHNlLAogICAgICAgIHRyZWU6IHsKICAgICAgICAgIGZvcms6IDAsCiAgICAgICAgICBsZW5ndGg6IDAsCiAgICAgICAgICByb290SGFzaDogbnVsbCwKICAgICAgICAgIHNpZ25hdHVyZTogbnVsbAogICAgICAgIH0sCiAgICAgICAgaGludHM6IHsKICAgICAgICAgIHJlb3JnczogW10sCiAgICAgICAgICBjb250aWd1b3VzTGVuZ3RoOiAwLAogICAgICAgICAgcmVtb3RlQ29udGlndW91c0xlbmd0aDogMAogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgZGlzY292ZXJ5S2V5ID0gb3B0cy5kaXNjb3ZlcnlLZXkgfHwgY3J5cHRvLmRpc2NvdmVyeUtleShoZWFkZXIua2V5KQoKICAgICAgc3RvcmFnZSA9IGF3YWl0IHRoaXMuZGIuY3JlYXRlQ29yZSh7CiAgICAgICAga2V5OiBoZWFkZXIua2V5LAogICAgICAgIG1hbmlmZXN0LAogICAgICAgIGtleVBhaXIsCiAgICAgICAgZnJvemVuOiBmYWxzZSwKICAgICAgICBkaXNjb3ZlcnlLZXksCiAgICAgICAgdXNlckRhdGE6IG9wdHMudXNlckRhdGEgfHwgW10sCiAgICAgICAgYWxpYXM6IG9wdHMuYWxpYXMgfHwgbnVsbAogICAgICB9KQogICAgfQoKICAgIC8vIHVuc2xhYiB0aGUgbG9uZyBsaXZlZCBidWZmZXJzIHRvIGF2b2lkIGtlZXBpbmcgdGhlIHNsYWIgYWxpdmUKICAgIGhlYWRlci5rZXkgPSB1bnNsYWIoaGVhZGVyLmtleSkKCiAgICBpZiAoaGVhZGVyLnRyZWUpIHsKICAgICAgaGVhZGVyLnRyZWUucm9vdEhhc2ggPSB1bnNsYWIoaGVhZGVyLnRyZWUucm9vdEhhc2gpCiAgICAgIGhlYWRlci50cmVlLnNpZ25hdHVyZSA9IHVuc2xhYihoZWFkZXIudHJlZS5zaWduYXR1cmUpCiAgICB9CgogICAgaWYgKGhlYWRlci5rZXlQYWlyKSB7CiAgICAgIGhlYWRlci5rZXlQYWlyLnB1YmxpY0tleSA9IHVuc2xhYihoZWFkZXIua2V5UGFpci5wdWJsaWNLZXkpCiAgICAgIGhlYWRlci5rZXlQYWlyLnNlY3JldEtleSA9IHVuc2xhYihoZWFkZXIua2V5UGFpci5zZWNyZXRLZXkpCiAgICB9CgogICAgaWYgKGhlYWRlci5rZXlQYWlyKSB7CiAgICAgIGhlYWRlci5rZXlQYWlyLnB1YmxpY0tleSA9IHVuc2xhYihoZWFkZXIua2V5UGFpci5wdWJsaWNLZXkpCiAgICAgIGhlYWRlci5rZXlQYWlyLnNlY3JldEtleSA9IHVuc2xhYihoZWFkZXIua2V5UGFpci5zZWNyZXRLZXkpCiAgICB9CgogICAgaWYgKG9wdHMubWFuaWZlc3QpIHsKICAgICAgLy8gaWYgd2UgcHJvdmlkZSBhIG1hbmlmZXN0IGFuZCBubyBrZXksIHZlcmlmeSB0aGF0IHRoZSBzdG9yZWQga2V5IGlzIHRoZSBzYW1lCiAgICAgIGlmICgKICAgICAgICAhb3B0cy5rZXkgJiYKICAgICAgICAhVmVyaWZpZXIuaXNWYWxpZE1hbmlmZXN0KGhlYWRlci5rZXksIFZlcmlmaWVyLmNyZWF0ZU1hbmlmZXN0KG9wdHMubWFuaWZlc3QpKQogICAgICApIHsKICAgICAgICB0aHJvdyBTVE9SQUdFX0NPTkZMSUNUKCdNYW5pZmVzdCBkb2VzIG5vdCBoYXNoIHRvIHByb3ZpZGVkIGtleScsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgICB9CgogICAgICBpZiAoIWhlYWRlci5tYW5pZmVzdCkgaGVhZGVyLm1hbmlmZXN0ID0gb3B0cy5tYW5pZmVzdAogICAgfQoKICAgIGlmIChvcHRzLmtleSAmJiAhYjRhLmVxdWFscyhoZWFkZXIua2V5LCBvcHRzLmtleSkpIHsKICAgICAgdGhyb3cgU1RPUkFHRV9DT05GTElDVCgnQW5vdGhlciBIeXBlcmNvcmUgaXMgc3RvcmVkIGhlcmUnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICAvLyBpZiB3ZSBzaWduYWxsZWQgY29tcGF0LCBidXQgYWxyZWFkeSBub3cgdGhpcyBjb3JlIGlzbid0IGRpc2FibGUgaXQKICAgIGlmIChjb21wYXQgJiYgaGVhZGVyLm1hbmlmZXN0ICYmICFWZXJpZmllci5pc0NvbXBhdChoZWFkZXIua2V5LCBoZWFkZXIubWFuaWZlc3QpKSB7CiAgICAgIGNvbXBhdCA9IGZhbHNlCiAgICB9IGVsc2UgaWYgKCFjb21wYXQgJiYgaGVhZGVyLm1hbmlmZXN0ICYmIFZlcmlmaWVyLmlzQ29tcGF0KGhlYWRlci5rZXksIGhlYWRlci5tYW5pZmVzdCkpIHsKICAgICAgY29tcGF0ID0gdHJ1ZQogICAgfQoKICAgIGNvbnN0IHByb2xvZ3VlID0gaGVhZGVyLm1hbmlmZXN0ID8gaGVhZGVyLm1hbmlmZXN0LnByb2xvZ3VlIDogbnVsbAoKICAgIGNvbnN0IGJpdGZpZWxkID0gYXdhaXQgQml0ZmllbGQub3BlbihzdG9yYWdlLCBoZWFkZXIudHJlZS5sZW5ndGgpCgogICAgY29uc3QgdHJlZUluZm8gPSB7CiAgICAgIGZvcms6IGhlYWRlci50cmVlLmZvcmssCiAgICAgIGxlbmd0aDogaGVhZGVyLnRyZWUubGVuZ3RoLAogICAgICBzaWduYXR1cmU6IGhlYWRlci50cmVlLnNpZ25hdHVyZSwKICAgICAgcm9vdHM6IGhlYWRlci50cmVlLmxlbmd0aAogICAgICAgID8gYXdhaXQgTWVya2xlVHJlZS5nZXRSb290c0Zyb21TdG9yYWdlKHN0b3JhZ2UsIGhlYWRlci50cmVlLmxlbmd0aCkKICAgICAgICA6IFtdLAogICAgICBwcm9sb2d1ZQogICAgfQoKICAgIGlmIChvdmVyd3JpdGUpIHsKICAgICAgY29uc3QgdHggPSBzdG9yYWdlLndyaXRlKCkKICAgICAgdHguZGVsZXRlVHJlZU5vZGVSYW5nZSgwLCAtMSkKICAgICAgdHguZGVsZXRlQmxvY2tSYW5nZSgwLCAtMSkKICAgICAgYml0ZmllbGQuY2xlYXIodHgpCiAgICAgIGF3YWl0IHR4LmZsdXNoKCkKICAgIH0KCiAgICBjb25zdCBsZW4gPSBiaXRmaWVsZC5maW5kRmlyc3QoZmFsc2UsIGhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoKQogICAgaWYgKGhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoICE9PSBsZW4gJiYgIXN0b3JhZ2UucmVhZE9ubHkpIHsKICAgICAgaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGggPSBsZW4KICAgICAgY29uc3QgdHggPSBzdG9yYWdlLndyaXRlKCkKICAgICAgdHguc2V0SGludHMoaGVhZGVyLmhpbnRzKQogICAgICBhd2FpdCB0eC5mbHVzaCgpCiAgICB9CgogICAgLy8gdG8gdW5zbGFiCiAgICBpZiAoaGVhZGVyLm1hbmlmZXN0KSB7CiAgICAgIGhlYWRlci5tYW5pZmVzdCA9IFZlcmlmaWVyLmNyZWF0ZU1hbmlmZXN0KGhlYWRlci5tYW5pZmVzdCkKICAgICAgaWYgKCFoYWRNYW5pZmVzdCB8fCAoaGVhZGVyLmtleVBhaXIgJiYgIWhhZEtleVBhaXIpKSB7CiAgICAgICAgY29uc3QgdHggPSBzdG9yYWdlLndyaXRlKCkKICAgICAgICB0eC5zZXRBdXRoKHsKICAgICAgICAgIGtleTogaGVhZGVyLmtleSwKICAgICAgICAgIGRpc2NvdmVyeUtleTogY3J5cHRvLmRpc2NvdmVyeUtleShoZWFkZXIua2V5KSwKICAgICAgICAgIG1hbmlmZXN0OiBoZWFkZXIubWFuaWZlc3QsCiAgICAgICAgICBrZXlQYWlyOiBoZWFkZXIua2V5UGFpcgogICAgICAgIH0pCiAgICAgICAgYXdhaXQgdHguZmx1c2goKQogICAgICB9CiAgICB9CgogICAgY29uc3QgdmVyaWZpZXIgPSBoZWFkZXIubWFuaWZlc3QKICAgICAgPyBuZXcgVmVyaWZpZXIoaGVhZGVyLmtleSwgaGVhZGVyLm1hbmlmZXN0LCB7IGNyeXB0bywgbGVnYWN5IH0pCiAgICAgIDogbnVsbAoKICAgIHRoaXMuc3RvcmFnZSA9IHN0b3JhZ2UKICAgIHRoaXMuaGVhZGVyID0gaGVhZGVyCiAgICB0aGlzLmNvbXBhdCA9IGNvbXBhdAogICAgdGhpcy5iaXRmaWVsZCA9IGJpdGZpZWxkCiAgICB0aGlzLnZlcmlmaWVyID0gdmVyaWZpZXIKICAgIHRoaXMuc3RhdGUgPSBuZXcgU2Vzc2lvblN0YXRlKHRoaXMsIG51bGwsIHN0b3JhZ2UsIHRyZWVJbmZvLCBudWxsKQoKICAgIGlmICh0aGlzLmtleSA9PT0gbnVsbCkgdGhpcy5rZXkgPSB0aGlzLmhlYWRlci5rZXkKICAgIGlmICh0aGlzLmRpc2NvdmVyeUtleSA9PT0gbnVsbCkgdGhpcy5kaXNjb3ZlcnlLZXkgPSBjcnlwdG8uZGlzY292ZXJ5S2V5KHRoaXMua2V5KQogICAgaWYgKHRoaXMuaWQgPT09IG51bGwpIHRoaXMuaWQgPSB6MzIuZW5jb2RlKHRoaXMua2V5KQogICAgaWYgKHRoaXMubWFuaWZlc3QgPT09IG51bGwpIHRoaXMubWFuaWZlc3QgPSB0aGlzLmhlYWRlci5tYW5pZmVzdAogIH0KCiAgYXN5bmMgYXVkaXQob3B0cykgewogICAgYXdhaXQgdGhpcy5zdGF0ZS5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgYXVkaXQodGhpcywgb3B0cykKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuc3RhdGUuX3VubG9jaygpCiAgICB9CiAgfQoKICBhc3luYyBzZXRNYW5pZmVzdChtYW5pZmVzdCkgewogICAgYXdhaXQgdGhpcy5zdGF0ZS5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBpZiAobWFuaWZlc3QgJiYgdGhpcy5oZWFkZXIubWFuaWZlc3QgPT09IG51bGwpIHsKICAgICAgICBpZiAoIVZlcmlmaWVyLmlzVmFsaWRNYW5pZmVzdCh0aGlzLmhlYWRlci5rZXksIG1hbmlmZXN0KSkgewogICAgICAgICAgdGhyb3cgSU5WQUxJRF9DSEVDS1NVTSgnTWFuaWZlc3QgaGFzaCBkb2VzIG5vdCBtYXRjaCcsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgICAgIH0KCiAgICAgICAgY29uc3QgdHggPSB0aGlzLnN0YXRlLmNyZWF0ZVdyaXRlQmF0Y2goKQogICAgICAgIHRoaXMuX3NldE1hbmlmZXN0KHR4LCBWZXJpZmllci5jcmVhdGVNYW5pZmVzdChtYW5pZmVzdCksIG51bGwpCiAgICAgICAgYXdhaXQgdGhpcy5zdGF0ZS5mbHVzaCgpCiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuc3RhdGUuX3VubG9jaygpCiAgICB9CiAgfQoKICBfc2V0TWFuaWZlc3QodHgsIG1hbmlmZXN0LCBrZXlQYWlyKSB7CiAgICBpZiAoIW1hbmlmZXN0ICYmIGI0YS5lcXVhbHMoa2V5UGFpci5wdWJsaWNLZXksIHRoaXMuaGVhZGVyLmtleSkpIHsKICAgICAgbWFuaWZlc3QgPSBWZXJpZmllci5kZWZhdWx0U2lnbmVyTWFuaWZlc3QodGhpcy5oZWFkZXIua2V5KQogICAgfQogICAgaWYgKCFtYW5pZmVzdCkgcmV0dXJuCgogICAgY29uc3QgdmVyaWZpZXIgPSBuZXcgVmVyaWZpZXIodGhpcy5oZWFkZXIua2V5LCBtYW5pZmVzdCwgeyBsZWdhY3k6IHRoaXMuX2xlZ2FjeSB9KQoKICAgIGlmICh2ZXJpZmllci5wcm9sb2d1ZSkgdGhpcy5zdGF0ZS5wcm9sb2d1ZSA9IE9iamVjdC5hc3NpZ24oe30sIHZlcmlmaWVyLnByb2xvZ3VlKQoKICAgIHRoaXMubWFuaWZlc3QgPSB0aGlzLmhlYWRlci5tYW5pZmVzdCA9IG1hbmlmZXN0CgogICAgdHguc2V0QXV0aCh7CiAgICAgIGtleTogdGhpcy5oZWFkZXIua2V5LAogICAgICBkaXNjb3ZlcnlLZXk6IHRoaXMuZGlzY292ZXJ5S2V5LAogICAgICBtYW5pZmVzdCwKICAgICAga2V5UGFpcjogdGhpcy5oZWFkZXIua2V5UGFpcgogICAgICAvLyBUT0RPOiBlbmNyeXB0aW9uS2V5PwogICAgfSkKCiAgICB0aGlzLmNvbXBhdCA9IHZlcmlmaWVyLmNvbXBhdAogICAgdGhpcy52ZXJpZmllciA9IHZlcmlmaWVyCgogICAgdGhpcy5yZXBsaWNhdG9yLm9udXBncmFkZSgpCiAgICB0aGlzLmVtaXRNYW5pZmVzdCgpCiAgfQoKICBhc3luYyBjb3B5UHJvbG9ndWUoc3JjKSB7CiAgICBhd2FpdCB0aGlzLnN0YXRlLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHNyYy5tdXRleC5sb2NrKCkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLnN0YXRlLm11dGV4LnVubG9jaygpCiAgICAgIHRocm93IGVycgogICAgfQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IGNvcHlQcm9sb2d1ZShzcmMsIHRoaXMpCiAgICB9IGZpbmFsbHkgewogICAgICBzcmMubXV0ZXgudW5sb2NrKCkKICAgICAgdGhpcy5zdGF0ZS5tdXRleC51bmxvY2soKQogICAgICB0aGlzLmNoZWNrSWZJZGxlKCkKICAgIH0KICB9CgogIGZsdXNoZWQoKSB7CiAgICByZXR1cm4gdGhpcy5zdGF0ZS5mbHVzaGVkKCkKICB9CgogIGFzeW5jIF92YWxpZGF0ZUNvbW1pdChzdGF0ZSwgdHJlZUxlbmd0aCkgewogICAgaWYgKHRoaXMuc3RhdGUubGVuZ3RoID4gc3RhdGUubGVuZ3RoKSB7CiAgICAgIHJldHVybiBmYWxzZSAvLyBUT0RPOiBwYXJ0aWFsIGNvbW1pdCBhbmQgdHJ1bmNhdGlvbiBwb3NzaWJsZSBpbiB0aGUgZnV0dXJlCiAgICB9CgogICAgaWYgKHRoaXMuc3RhdGUubGVuZ3RoID4gdHJlZUxlbmd0aCkgewogICAgICBmb3IgKGNvbnN0IHJvb3Qgb2YgdGhpcy5zdGF0ZS5yb290cykgewogICAgICAgIGNvbnN0IGJhdGNoUm9vdCA9IGF3YWl0IE1lcmtsZVRyZWUuZ2V0KHN0YXRlLCByb290LmluZGV4KQogICAgICAgIGlmIChiYXRjaFJvb3Quc2l6ZSAhPT0gcm9vdC5zaXplIHx8ICFiNGEuZXF1YWxzKGJhdGNoUm9vdC5oYXNoLCByb290Lmhhc2gpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy52ZXJpZmllciA9PT0gbnVsbCkgewogICAgICByZXR1cm4gZmFsc2UgLy8gZWFzaWVyIHRvIGFzc2VydCB0aGFuIHVwc2VydAogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfdmVyaWZ5QmF0Y2hVcGdyYWRlKGJhdGNoLCBtYW5pZmVzdCkgewogICAgaWYgKCF0aGlzLmhlYWRlci5tYW5pZmVzdCkgewogICAgICAvLyBjb21wYXQsIGRyb3AgYXQgc29tZSBwb2ludAogICAgICBpZiAoIW1hbmlmZXN0KSBtYW5pZmVzdCA9IFZlcmlmaWVyLmRlZmF1bHRTaWduZXJNYW5pZmVzdCh0aGlzLmhlYWRlci5rZXkpCgogICAgICBpZiAoCiAgICAgICAgIW1hbmlmZXN0IHx8CiAgICAgICAgISgKICAgICAgICAgIFZlcmlmaWVyLmlzVmFsaWRNYW5pZmVzdCh0aGlzLmhlYWRlci5rZXksIG1hbmlmZXN0KSB8fAogICAgICAgICAgVmVyaWZpZXIuaXNDb21wYXQodGhpcy5oZWFkZXIua2V5LCBtYW5pZmVzdCkKICAgICAgICApCiAgICAgICkgewogICAgICAgIHRocm93IElOVkFMSURfU0lHTkFUVVJFKCdQcm9vZiBjb250YWlucyBhbiBpbnZhbGlkIG1hbmlmZXN0JywgdGhpcy5kaXNjb3ZlcnlLZXkpIC8vIFRPRE86IHByb3BlciBlcnJvciB0eXBlCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCB2ZXJpZmllciA9CiAgICAgIHRoaXMudmVyaWZpZXIgfHwKICAgICAgbmV3IFZlcmlmaWVyKHRoaXMuaGVhZGVyLmtleSwgVmVyaWZpZXIuY3JlYXRlTWFuaWZlc3QobWFuaWZlc3QpLCB7IGxlZ2FjeTogdGhpcy5fbGVnYWN5IH0pCgogICAgaWYgKCF2ZXJpZmllci52ZXJpZnkoYmF0Y2gsIGJhdGNoLnNpZ25hdHVyZSkpIHsKICAgICAgdGhyb3cgSU5WQUxJRF9TSUdOQVRVUkUoJ1Byb29mIGNvbnRhaW5zIGFuIGludmFsaWQgc2lnbmF0dXJlJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgcmV0dXJuIG1hbmlmZXN0CiAgfQoKICBhc3luYyBfdmVyaWZ5RXhjbHVzaXZlKHsgYmF0Y2gsIGJpdGZpZWxkLCB2YWx1ZSwgbWFuaWZlc3QgfSkgewogICAgbWFuaWZlc3QgPSB0aGlzLl92ZXJpZnlCYXRjaFVwZ3JhZGUoYmF0Y2gsIG1hbmlmZXN0KQoKICAgIGlmICgKICAgICAgIShhd2FpdCB0aGlzLnN0YXRlLl92ZXJpZnlCbG9jaygKICAgICAgICBiYXRjaCwKICAgICAgICBiaXRmaWVsZCwKICAgICAgICB2YWx1ZSwKICAgICAgICB0aGlzLmhlYWRlci5tYW5pZmVzdCA/IG51bGwgOiBtYW5pZmVzdAogICAgICApKQogICAgKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmICghYmF0Y2gudXBncmFkZWQgJiYgYml0ZmllbGQpIHsKICAgICAgdGhpcy5yZXBsaWNhdG9yLm9uaGF2ZShiaXRmaWVsZC5zdGFydCwgYml0ZmllbGQubGVuZ3RoLCBiaXRmaWVsZC5kcm9wKQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBfdmVyaWZ5U2hhcmVkKCkgewogICAgaWYgKCF0aGlzLl92ZXJpZmllcy5sZW5ndGgpIHJldHVybiBmYWxzZQoKICAgIGF3YWl0IHRoaXMuc3RhdGUubXV0ZXgubG9jaygpCgogICAgY29uc3QgdHggPSB0aGlzLnN0YXRlLmNyZWF0ZVdyaXRlQmF0Y2goKQoKICAgIGNvbnN0IHZlcmlmaWVzID0gdGhpcy5fdmVyaWZpZXMKICAgIHRoaXMuX3ZlcmlmaWVzID0gbnVsbAogICAgdGhpcy5fdmVyaWZpZWQgPSBudWxsCgogICAgdHJ5IHsKICAgICAgZm9yIChjb25zdCB7IGJhdGNoLCBiaXRmaWVsZCwgdmFsdWUgfSBvZiB2ZXJpZmllcykgewogICAgICAgIGlmICghYmF0Y2guY29tbWl0YWJsZSgpKSBjb250aW51ZQoKICAgICAgICBpZiAoYml0ZmllbGQpIHsKICAgICAgICAgIHR4LnB1dEJsb2NrKGJpdGZpZWxkLnN0YXJ0LCB2YWx1ZSkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IGJpdHMgPSBuZXcgQml0SW50ZXJsdWRlKCkKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVyaWZpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB7IGJhdGNoLCBiaXRmaWVsZCwgbWFuaWZlc3QgfSA9IHZlcmlmaWVzW2ldCgogICAgICAgIGlmICghYmF0Y2guY29tbWl0YWJsZSgpKSB7CiAgICAgICAgICB2ZXJpZmllc1tpXSA9IG51bGwgLy8gc2lnbmFsIHRoYXQgd2UgY2Fubm90IGNvbW1pdCB0aGlzIG9uZQogICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIGlmIChiaXRmaWVsZCkgewogICAgICAgICAgYml0cy5zZXRSYW5nZShiaXRmaWVsZC5zdGFydCwgYml0ZmllbGQuc3RhcnQgKyAxLCB0cnVlKQogICAgICAgIH0KCiAgICAgICAgLy8gaWYgd2UgZ290IGEgbWFuaWZlc3QgQU5EIGl0cyBzdHJpY3RseSBhIG5vbiBjb21wYXQgb25lLCBsZXRzIHN0b3JlIGl0CiAgICAgICAgaWYgKG1hbmlmZXN0ICYmIHRoaXMuaGVhZGVyLm1hbmlmZXN0ID09PSBudWxsKSB7CiAgICAgICAgICBpZiAoIVZlcmlmaWVyLmlzVmFsaWRNYW5pZmVzdCh0aGlzLmhlYWRlci5rZXksIG1hbmlmZXN0KSkgewogICAgICAgICAgICB0aHJvdyBJTlZBTElEX0NIRUNLU1VNKCdNYW5pZmVzdCBoYXNoIGRvZXMgbm90IG1hdGNoJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9zZXRNYW5pZmVzdCh0eCwgbWFuaWZlc3QsIG51bGwpCiAgICAgICAgfQoKICAgICAgICBpZiAoYmF0Y2guY29tbWl0YWJsZSgpKSBiYXRjaC5jb21taXQodHgpCiAgICAgIH0KCiAgICAgIGNvbnN0IHJhbmdlcyA9IGJpdHMuZmx1c2godHgsIHRoaXMuYml0ZmllbGQpCgogICAgICBhd2FpdCB0aGlzLnN0YXRlLmZsdXNoKCkKCiAgICAgIGZvciAoY29uc3QgeyBzdGFydCwgZW5kLCB2YWx1ZSB9IG9mIHJhbmdlcykgewogICAgICAgIHRoaXMuX3NldEJpdGZpZWxkUmFuZ2VzKHN0YXJ0LCBlbmQsIHZhbHVlKQogICAgICB9CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcmlmaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgYml0ZmllbGQgPSB2ZXJpZmllc1tpXSAmJiB2ZXJpZmllc1tpXS5iaXRmaWVsZAogICAgICAgIGlmIChiaXRmaWVsZCkgewogICAgICAgICAgdGhpcy51cGRhdGVDb250aWd1b3VzTGVuZ3RoKGJpdGZpZWxkKQogICAgICAgICAgdGhpcy5yZXBsaWNhdG9yLm9uaGF2ZShiaXRmaWVsZC5zdGFydCwgYml0ZmllbGQubGVuZ3RoLCBiaXRmaWVsZC5kcm9wKQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMuaGludHNDaGFuZ2VkKSBhd2FpdCB0aGlzLmZsdXNoSGludHMoKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5zdGF0ZS5fY2xlYXJBY3RpdmVCYXRjaCgpCiAgICAgIHRoaXMuc3RhdGUubXV0ZXgudW5sb2NrKCkKICAgIH0KCiAgICByZXR1cm4gdmVyaWZpZXNbMF0gIT09IG51bGwKICB9CgogIGFzeW5jIGZsdXNoSGludHMoKSB7CiAgICBpZiAoIXRoaXMuaGludHNDaGFuZ2VkKSByZXR1cm4KICAgIHRoaXMuaGludHNDaGFuZ2VkID0gZmFsc2UgLy8gd2UgdW5zZXQgdGhpcyBpbW1lZGlhdGVseSBhcyBhICJkZWJvdW5jZSIKCiAgICBjb25zdCB0eCA9IHRoaXMuc3RhdGUuc3RvcmFnZS53cml0ZSgpCgogICAgdHguc2V0SGludHMoewogICAgICBjb250aWd1b3VzTGVuZ3RoOiB0aGlzLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoLAogICAgICByZW1vdGVDb250aWd1b3VzTGVuZ3RoOiB0aGlzLmhlYWRlci5oaW50cy5yZW1vdGVDb250aWd1b3VzTGVuZ3RoCiAgICB9KQoKICAgIGF3YWl0IHR4LmZsdXNoKCkKICB9CgogIGFzeW5jIGNoZWNrQ29uZmxpY3QocHJvb2YsIGZyb20pIHsKICAgIGlmICh0aGlzLnN0YXRlLmxlbmd0aCA8IHByb29mLnVwZ3JhZGUubGVuZ3RoIHx8IHByb29mLmZvcmsgIT09IHRoaXMuc3RhdGUuZm9yaykgewogICAgICAvLyBvdXQgb2YgZGF0ZSB0aGlzIHByb29mIC0gaWdub3JlIGZvciBub3cKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgLy8gc2FuaXR5IGNoZWNrIC0+IG5vIG1hbmlmZXN0LCBubyB3YXkgdG8gdmVyaWZ5CiAgICBpZiAoIXRoaXMuaGVhZGVyLm1hbmlmZXN0KSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnN0IGJhdGNoID0gTWVya2xlVHJlZS52ZXJpZnlGdWxseVJlbW90ZSh0aGlzLnN0YXRlLCBwcm9vZikKCiAgICB0cnkgewogICAgICB0aGlzLl92ZXJpZnlCYXRjaFVwZ3JhZGUoYmF0Y2gsIHByb29mLm1hbmlmZXN0KQogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgY29uc3Qgcm9vdHMgPSBhd2FpdCBNZXJrbGVUcmVlLmdldFJvb3RzRnJvbVN0b3JhZ2UodGhpcy5zdG9yYWdlLCBwcm9vZi51cGdyYWRlLmxlbmd0aCkKICAgIGNvbnN0IHJlbW90ZVRyZWVIYXNoID0gY3J5cHRvLnRyZWUocHJvb2YudXBncmFkZS5ub2RlcykKICAgIGNvbnN0IGxvY2FsVHJlZUhhc2ggPSBjcnlwdG8udHJlZShyb290cykKCiAgICB0cnkgewogICAgICBjb25zdCByeCA9IHRoaXMuc3RhdGUuc3RvcmFnZS5yZWFkKCkKICAgICAgY29uc3QgdHJlZVByb29mUHJvbWlzZSA9IE1lcmtsZVRyZWUucHJvb2YodGhpcy5zdGF0ZSwgcngsIHsKICAgICAgICBibG9jazogbnVsbCwKICAgICAgICBoYXNoOiBudWxsLAogICAgICAgIHNlZWs6IG51bGwsCiAgICAgICAgdXBncmFkZTogewogICAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgICBsZW5ndGg6IHByb29mLnVwZ3JhZGUubGVuZ3RoCiAgICAgICAgfQogICAgICB9KQoKICAgICAgcngudHJ5Rmx1c2goKQoKICAgICAgY29uc3QgdHJlZVByb29mID0gYXdhaXQgdHJlZVByb29mUHJvbWlzZQoKICAgICAgY29uc3QgdmVyaWZ5QmF0Y2ggPSBNZXJrbGVUcmVlLnZlcmlmeUZ1bGx5UmVtb3RlKHRoaXMuc3RhdGUsIGF3YWl0IHRyZWVQcm9vZi5zZXR0bGUoKSkKICAgICAgdGhpcy5fdmVyaWZ5QmF0Y2hVcGdyYWRlKHZlcmlmeUJhdGNoLCB0aGlzLmhlYWRlci5tYW5pZmVzdCkKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIC8vIGJvdGggcHJvb2ZzIGFyZSB2YWxpZCwgbm93IGNoZWNrIGlmIHRoZXkgZm9ya2VkCiAgICBpZiAoYjRhLmVxdWFscyhsb2NhbFRyZWVIYXNoLCByZW1vdGVUcmVlSGFzaCkpIHJldHVybiBmYWxzZQoKICAgIGF3YWl0IHRoaXMuc3RhdGUubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgY29uc3QgdHggPSB0aGlzLnN0YXRlLmNyZWF0ZVdyaXRlQmF0Y2goKQoKICAgICAgdGhpcy5oZWFkZXIuZnJvemVuID0gdHJ1ZQoKICAgICAgdHguc2V0QXV0aCh7CiAgICAgICAga2V5OiB0aGlzLmhlYWRlci5rZXksCiAgICAgICAgZGlzY292ZXJ5S2V5OiB0aGlzLmRpc2NvdmVyeUtleSwKICAgICAgICBtYW5pZmVzdDogdGhpcy5oZWFkZXIubWFuaWZlc3QsCiAgICAgICAga2V5UGFpcjogdGhpcy5oZWFkZXIua2V5UGFpciwKICAgICAgICBmcm96ZW46IHRydWUKICAgICAgfSkKCiAgICAgIGF3YWl0IHRoaXMuc3RhdGUuZmx1c2goKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5zdGF0ZS5tdXRleC51bmxvY2soKQogICAgfQoKICAgIC8vIHRtcCBsb2cgc28gd2UgY2FuIHNlZSB0aGVzZQogICAgY29uc3QgaWQgPSBiNGEudG9TdHJpbmcodGhpcy5kaXNjb3ZlcnlLZXksICdoZXgnKQogICAgY29uc29sZS5sb2coCiAgICAgICdbaHlwZXJjb3JlXSBjb25mbGljdCBkZXRlY3RlZCBpbiAnICsKICAgICAgICBpZCArCiAgICAgICAgJyAod3JpdGFibGU9JyArCiAgICAgICAgISF0aGlzLmhlYWRlci5rZXlQYWlyICsKICAgICAgICAnLHF1b3J1bT0nICsKICAgICAgICB0aGlzLmhlYWRlci5tYW5pZmVzdC5xdW9ydW0gKwogICAgICAgICcpJwogICAgKQogICAgYXdhaXQgdGhpcy5fb25jb25mbGljdChwcm9vZikKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyB2ZXJpZnlSZW9yZyhwcm9vZikgewogICAgY29uc3QgYmF0Y2ggPSBuZXcgUmVvcmdCYXRjaCh0aGlzLnN0YXRlKQogICAgYXdhaXQgTWVya2xlVHJlZS5yZW9yZyh0aGlzLnN0YXRlLCBwcm9vZiwgYmF0Y2gpCiAgICBjb25zdCBtYW5pZmVzdCA9IHRoaXMuX3ZlcmlmeUJhdGNoVXBncmFkZShiYXRjaCwgcHJvb2YubWFuaWZlc3QpCgogICAgaWYgKG1hbmlmZXN0ICYmICF0aGlzLmhlYWRlci5tYW5pZmVzdCkgewogICAgICBhd2FpdCB0aGlzLnN0YXRlLm11dGV4LmxvY2soKQogICAgICB0cnkgewogICAgICAgIGlmIChtYW5pZmVzdCAmJiB0aGlzLmhlYWRlci5tYW5pZmVzdCA9PT0gbnVsbCkgewogICAgICAgICAgY29uc3QgdHggPSB0aGlzLnN0YXRlLmNyZWF0ZVdyaXRlQmF0Y2goKQogICAgICAgICAgdGhpcy5fc2V0TWFuaWZlc3QodHgsIFZlcmlmaWVyLmNyZWF0ZU1hbmlmZXN0KG1hbmlmZXN0KSwgbnVsbCkKICAgICAgICAgIGF3YWl0IHRoaXMuc3RhdGUuZmx1c2goKQogICAgICAgIH0KICAgICAgfSBmaW5hbGx5IHsKICAgICAgICB0aGlzLnN0YXRlLl91bmxvY2soKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGJhdGNoCiAgfQoKICBhc3luYyB2ZXJpZnkocHJvb2YsIGZyb20pIHsKICAgIC8vIFdlIGNhbm5vdCBhcHBseSAib3RoZXIgZm9ya3MiIGF0bS4KICAgIC8vIFdlIHNob3VsZCBwcm9iYWJseSBzdGlsbCB0cnkgYW5kIHRoZXkgYXJlIGxpa2VseSBzdXBlciBzaW1pbGFyIGZvciBub24gdXBncmFkZXMKICAgIC8vIGJ1dCB0aGlzIGlzIGVhc3kgYXRtIChhbmQgdGhlIGFib3ZlIGxheWVyIHdpbGwganVzdCByZXRyeSkKICAgIGlmIChwcm9vZi5mb3JrICE9PSB0aGlzLnN0YXRlLmZvcmspIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGJhdGNoID0gYXdhaXQgTWVya2xlVHJlZS52ZXJpZnkodGhpcy5zdGF0ZSwgcHJvb2YpCgogICAgaWYgKGJhdGNoLnVwZ3JhZGVkICYmIGJhdGNoLmxlbmd0aCA8PSB0aGlzLnN0YXRlLmxlbmd0aCkgewogICAgICBhd2FpdCBiYXRjaC5kb3duZ3JhZGUoKQogICAgfQoKICAgIGlmICghYmF0Y2guY29tbWl0YWJsZSgpKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnN0IHZhbHVlID0gKHByb29mLmJsb2NrICYmIHByb29mLmJsb2NrLnZhbHVlKSB8fCBudWxsCiAgICBjb25zdCBvcCA9IHsKICAgICAgYmF0Y2gsCiAgICAgIGJpdGZpZWxkOiB2YWx1ZSAmJiB7IGRyb3A6IGZhbHNlLCBzdGFydDogcHJvb2YuYmxvY2suaW5kZXgsIGxlbmd0aDogMSB9LAogICAgICB2YWx1ZSwKICAgICAgbWFuaWZlc3Q6IHByb29mLm1hbmlmZXN0LAogICAgICBmcm9tCiAgICB9CgogICAgaWYgKGJhdGNoLnVwZ3JhZGVkKSB7CiAgICAgIHJldHVybiB0aGlzLl92ZXJpZnlFeGNsdXNpdmUob3ApCiAgICB9CgogICAgaWYgKHRoaXMuX3ZlcmlmaWVzICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IHZlcmlmaWVzID0gdGhpcy5fdmVyaWZpZXMKICAgICAgY29uc3QgaSA9IHZlcmlmaWVzLnB1c2gob3ApCiAgICAgIGF3YWl0IHRoaXMuX3ZlcmlmaWVkCiAgICAgIHJldHVybiB2ZXJpZmllc1tpXSAhPT0gbnVsbAogICAgfQoKICAgIHRoaXMuX3ZlcmlmaWVzID0gW29wXQogICAgdGhpcy5fdmVyaWZpZWQgPSB0aGlzLl92ZXJpZnlTaGFyZWQoKQoKICAgIHJldHVybiB0aGlzLl92ZXJpZmllZAogIH0KCiAgYXN5bmMgcmVvcmcoYmF0Y2gpIHsKICAgIGlmICghYmF0Y2guY29tbWl0YWJsZSgpKSByZXR1cm4gZmFsc2UKCiAgICB0aGlzLnRydW5jYXRpbmcrKwoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuc3RhdGUucmVvcmcoYmF0Y2gpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLnRydW5jYXRpbmctLQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBvcGVuU2tpcEJpdGZpZWxkKCkgewogICAgaWYgKHRoaXMuc2tpcEJpdGZpZWxkICE9PSBudWxsKSByZXR1cm4gdGhpcy5za2lwQml0ZmllbGQKICAgIHRoaXMuc2tpcEJpdGZpZWxkID0gbmV3IFJlbW90ZUJpdGZpZWxkKCkKICAgIGNvbnN0IGJ1ZiA9IHRoaXMuYml0ZmllbGQudG9CdWZmZXIodGhpcy5zdGF0ZS5sZW5ndGgpCiAgICBjb25zdCBiaXRmaWVsZCA9IG5ldyBVaW50MzJBcnJheShidWYuYnVmZmVyLCBidWYuYnl0ZU9mZnNldCwgYnVmLmJ5dGVMZW5ndGggLyA0KQogICAgdGhpcy5za2lwQml0ZmllbGQuaW5zZXJ0KDAsIGJpdGZpZWxkKQogICAgcmV0dXJuIHRoaXMuc2tpcEJpdGZpZWxkCiAgfQoKICBfc2V0Qml0ZmllbGRSYW5nZXMoc3RhcnQsIGVuZCwgdmFsdWUpIHsKICAgIHRoaXMuYml0ZmllbGQuc2V0UmFuZ2Uoc3RhcnQsIGVuZCwgdmFsdWUpCiAgICBpZiAodGhpcy5za2lwQml0ZmllbGQgIT09IG51bGwpIHRoaXMuc2tpcEJpdGZpZWxkLnNldFJhbmdlKHN0YXJ0LCBlbmQsIHZhbHVlKQogIH0KCiAgY2xvc2UoKSB7CiAgICBpZiAoIXRoaXMuY2xvc2luZykgdGhpcy5jbG9zaW5nID0gdGhpcy5fY2xvc2UoKQogICAgcmV0dXJuIHRoaXMuY2xvc2luZwogIH0KCiAgdXBkYXRlQ29udGlndW91c0xlbmd0aChiaXRmaWVsZCkgewogICAgY29uc3QgY29udGlnID0gdXBkYXRlQ29udGlnQmF0Y2godGhpcy5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCwgYml0ZmllbGQsIHRoaXMuYml0ZmllbGQpCgogICAgaWYgKGNvbnRpZy5sZW5ndGggIT09IC0xICYmIGNvbnRpZy5sZW5ndGggIT09IHRoaXMuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgpIHsKICAgICAgdGhpcy5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCA9IGNvbnRpZy5sZW5ndGgKICAgICAgdGhpcy5oaW50c0NoYW5nZWQgPSB0cnVlCiAgICB9CiAgfQoKICB1cGRhdGVSZW1vdGVDb250aWd1b3VzTGVuZ3RoKGxlbmd0aCkgewogICAgdGhpcy5oZWFkZXIuaGludHMucmVtb3RlQ29udGlndW91c0xlbmd0aCA9IGxlbmd0aAogICAgdGhpcy5oaW50c0NoYW5nZWQgPSB0cnVlCgogICAgZm9yIChsZXQgaSA9IHRoaXMubW9uaXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgdGhpcy5tb25pdG9yc1tpXS5lbWl0KCdyZW1vdGUtY29udGlndW91cy1sZW5ndGgnLCBsZW5ndGgpCiAgICB9CiAgfQoKICBvbmFwcGVuZCh0cmVlLCBiaXRmaWVsZCkgewogICAgdGhpcy5oZWFkZXIudHJlZSA9IHRyZWUKCiAgICBpZiAoIWJpdGZpZWxkKSB7CiAgICAgIHRoaXMucmVwbGljYXRvci5vbnVwZ3JhZGUoKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLnJlcGxpY2F0b3IuY29yaygpCgogICAgY29uc3QgeyBzdGFydCwgbGVuZ3RoLCBkcm9wIH0gPSBiaXRmaWVsZAoKICAgIHRoaXMuX3NldEJpdGZpZWxkUmFuZ2VzKHN0YXJ0LCBzdGFydCArIGxlbmd0aCwgdHJ1ZSkKICAgIHRoaXMudXBkYXRlQ29udGlndW91c0xlbmd0aCh7IHN0YXJ0LCBsZW5ndGgsIGRyb3A6IGZhbHNlIH0pCgogICAgdGhpcy5yZXBsaWNhdG9yLm9udXBncmFkZSgpCiAgICB0aGlzLnJlcGxpY2F0b3Iub25oYXZlKHN0YXJ0LCBsZW5ndGgsIGRyb3ApCiAgICB0aGlzLnJlcGxpY2F0b3IudW5jb3JrKCkKICB9CgogIG9udHJ1bmNhdGUodHJlZSwgeyBzdGFydCwgbGVuZ3RoIH0pIHsKICAgIGlmICh0cmVlKSB0aGlzLmhlYWRlci50cmVlID0gdHJlZQoKICAgIHRoaXMucmVwbGljYXRvci5jb3JrKCkKCiAgICB0aGlzLnJlcGxpY2F0b3Iub250cnVuY2F0ZShzdGFydCwgbGVuZ3RoKQogICAgdGhpcy5yZXBsaWNhdG9yLm9uaGF2ZShzdGFydCwgbGVuZ3RoLCB0cnVlKQogICAgdGhpcy5yZXBsaWNhdG9yLm9udXBncmFkZSgpCiAgICB0aGlzLnJlcGxpY2F0b3IudW5jb3JrKCkKCiAgICBmb3IgKGNvbnN0IHNlc3Npb25TdGF0ZSBvZiB0aGlzLnNlc3Npb25TdGF0ZXMpIHsKICAgICAgaWYgKHN0YXJ0IDwgc2Vzc2lvblN0YXRlLnNuYXBzaG90Q29tcGF0TGVuZ3RoKSBzZXNzaW9uU3RhdGUuc25hcHNob3RDb21wYXRMZW5ndGggPSBzdGFydAogICAgfQoKICAgIHRoaXMuX3NldEJpdGZpZWxkUmFuZ2VzKHN0YXJ0LCBzdGFydCArIGxlbmd0aCwgZmFsc2UpCiAgICB0aGlzLnVwZGF0ZUNvbnRpZ3VvdXNMZW5ndGgoeyBzdGFydCwgbGVuZ3RoLCBkcm9wOiB0cnVlIH0pCiAgfQoKICBhc3luYyBfb25jb25mbGljdChwcm9vZikgewogICAgYXdhaXQgdGhpcy5yZXBsaWNhdG9yLm9uY29uZmxpY3QoKQoKICAgIGZvciAobGV0IGkgPSB0aGlzLm1vbml0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLm1vbml0b3JzW2ldCiAgICAgIHMuZW1pdCgnY29uZmxpY3QnLCBwcm9vZi51cGdyYWRlLmxlbmd0aCwgcHJvb2YuZm9yaywgcHJvb2YpCiAgICB9CgogICAgY29uc3QgZXJyID0gbmV3IEVycm9yKCdUd28gY29uZmxpY3Rpbmcgc2lnbmF0dXJlcyBleGlzdCBmb3IgbGVuZ3RoICcgKyBwcm9vZi51cGdyYWRlLmxlbmd0aCkKICAgIGF3YWl0IHRoaXMuY2xvc2VBbGxTZXNzaW9ucyhlcnIpCiAgfQoKICBhc3luYyBjbG9zZUFsbFNlc3Npb25zKGVycikgewogICAgLy8gdGhpcy5zZXNzaW9ucyBtb2RpZmllcyBpdHNlbGYgd2hlbiBhIHNlc3Npb24gY2xvc2VzCiAgICAvLyBUaGlzIHdheSB3ZSBlbnN1cmUgd2UgaW5kZWVkIGl0ZXJhdGUgb3ZlciBhbGwgc2Vzc2lvbnMKICAgIGNvbnN0IHNlc3Npb25zID0gdGhpcy5hbGxTZXNzaW9ucygpCgogICAgY29uc3QgYWxsID0gW10KICAgIGZvciAoY29uc3QgcyBvZiBzZXNzaW9ucykgYWxsLnB1c2gocy5jbG9zZSh7IGVycm9yOiBlcnIsIGZvcmNlOiBmYWxzZSB9KSkgLy8gZm9yY2UgZmFsc2Ugb3IgZWxzZSBpbmZpbml0ZSByZWN1cnNpb24KICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChhbGwpCiAgfQoKICBhc3luYyBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkID09PSB0cnVlKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQoKICAgIGlmICh0aGlzLmhhc1Nlc3Npb24oKSA9PT0gdHJ1ZSkgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZGVzdHJveSB3aGlsZSBzZXNzaW9ucyBhcmUgb3BlbicpCgogICAgY29uc3Qgd2Vha1Nlc3Npb25zID0gdGhpcy5hbGxTZXNzaW9ucygpCgogICAgaWYgKHRoaXMucmVwbGljYXRvcikgdGhpcy5yZXBsaWNhdG9yLmRlc3Ryb3koKQogICAgaWYgKHRoaXMuc3RhdGUpIGF3YWl0IHRoaXMuc3RhdGUuY2xvc2UoKQoKICAgIC8vIGNsb3NlIGFsbCBwZW5kaW5nIHdlYWsgc2Vzc2lvbnMuLi4KICAgIGZvciAoY29uc3QgcyBvZiB3ZWFrU2Vzc2lvbnMpIHMuY2xvc2UoKS5jYXRjaChub29wKQogIH0KCiAgYXN5bmMgX2Nsb3NlKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBpZiAodGhpcy5oYXNTZXNzaW9uKCkgPT09IHRydWUpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGNsb3NlIHdoaWxlIHNlc3Npb25zIGFyZSBvcGVuJykKCiAgICBpZiAodGhpcy5yZXBsaWNhdG9yKSBhd2FpdCB0aGlzLnJlcGxpY2F0b3IuY2xvc2UoKQoKICAgIGF3YWl0IHRoaXMuZGVzdHJveSgpCiAgICBpZiAodGhpcy5hdXRvQ2xvc2UpIGF3YWl0IHRoaXMuc3RvcmFnZS5zdG9yZS5jbG9zZSgpCgogICAgdGhpcy5jbG9zZWQgPSB0cnVlCiAgfQp9CgpmdW5jdGlvbiB1cGRhdGVDb250aWdCYXRjaChzdGFydCwgdXBkLCBiaXRmaWVsZCkgewogIGNvbnN0IGVuZCA9IHVwZC5zdGFydCArIHVwZC5sZW5ndGgKCiAgbGV0IGMgPSBzdGFydAoKICBpZiAodXBkLmRyb3ApIHsKICAgIC8vIElmIHdlIGRyb3BwZWQgYSBibG9jayBpbiB0aGUgY3VycmVudCBjb250aWcgcmFuZ2UsICJkb3duZ3JhZGUiIGl0CiAgICBpZiAoYyA+IHVwZC5zdGFydCkgewogICAgICBjID0gdXBkLnN0YXJ0CiAgICB9CiAgfSBlbHNlIHsKICAgIGlmIChjIDw9IGVuZCAmJiBjID49IHVwZC5zdGFydCkgewogICAgICBjID0gZW5kCiAgICAgIHdoaWxlIChiaXRmaWVsZC5nZXQoYykpIGMrKwogICAgfQogIH0KCiAgaWYgKGMgPT09IHN0YXJ0KSB7CiAgICByZXR1cm4gewogICAgICBsZW5ndGg6IC0xCiAgICB9CiAgfQoKICBpZiAoYyA+IHN0YXJ0KSB7CiAgICByZXR1cm4gewogICAgICBsZW5ndGg6IGMKICAgIH0KICB9CgogIHJldHVybiB7CiAgICBsZW5ndGg6IGMKICB9Cn0KCmZ1bmN0aW9uIGdldERlZmF1bHRUcmVlKCkgewogIHJldHVybiB7CiAgICBmb3JrOiAwLAogICAgbGVuZ3RoOiAwLAogICAgcm9vdEhhc2g6IG51bGwsCiAgICBzaWduYXR1cmU6IG51bGwKICB9Cn0KCmZ1bmN0aW9uIHBhcnNlSGVhZGVyKGluZm8pIHsKICBpZiAoIWluZm8pIHJldHVybiBudWxsCgogIHJldHVybiB7CiAgICBrZXk6IGluZm8ua2V5LAogICAgbWFuaWZlc3Q6IGluZm8ubWFuaWZlc3QsCiAgICBleHRlcm5hbDogbnVsbCwKICAgIGtleVBhaXI6IGluZm8ua2V5UGFpciwKICAgIHRyZWU6IGluZm8uaGVhZCB8fCBnZXREZWZhdWx0VHJlZSgpLAogICAgaGludHM6IHsKICAgICAgcmVvcmdzOiBbXSwKICAgICAgY29udGlndW91c0xlbmd0aDogaW5mby5oaW50cyA/IGluZm8uaGludHMuY29udGlndW91c0xlbmd0aCA6IDAsCiAgICAgIHJlbW90ZUNvbnRpZ3VvdXNMZW5ndGg6IGluZm8uaGludHMgPyBpbmZvLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGggOiAwCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KCmFzeW5jIGZ1bmN0aW9uIGdldENvcmVJbmZvKHN0b3JhZ2UpIHsKICBjb25zdCByID0gc3RvcmFnZS5yZWFkKCkKCiAgY29uc3QgYXV0aCA9IHIuZ2V0QXV0aCgpCiAgY29uc3QgaGVhZCA9IHIuZ2V0SGVhZCgpCiAgY29uc3QgaGludHMgPSByLmdldEhpbnRzKCkKCiAgci50cnlGbHVzaCgpCgogIGNvbnN0IFthdXRoSW5mbywgaGVhZEluZm8sIGhpbnRzSW5mb10gPSBhd2FpdCBQcm9taXNlLmFsbChbYXV0aCwgaGVhZCwgaGludHNdKQogIHJldHVybiB7CiAgICAuLi5hdXRoSW5mbywKICAgIGhlYWQ6IGhlYWRJbmZvLAogICAgaGludHM6IGhpbnRzSW5mbwogIH0KfQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCB7IERFRkFVTFRfRU5DUllQVElPTiB9ID0gcmVxdWlyZSgnLi9jYXBzJykKCmNvbnN0IG5vbmNlID0gYjRhLmFsbG9jKHNvZGl1bS5jcnlwdG9fc3RyZWFtX05PTkNFQllURVMpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIERlZmF1bHRFbmNyeXB0aW9uIHsKICBzdGF0aWMgUEFERElORyA9IDgKCiAgY29uc3RydWN0b3IoZW5jcnlwdGlvbktleSwgaHlwZXJjb3JlS2V5LCBvcHRzID0ge30pIHsKICAgIHRoaXMua2V5ID0gZW5jcnlwdGlvbktleQogICAgdGhpcy5jb21wYXQgPSBvcHRzLmNvbXBhdCA9PT0gdHJ1ZQoKICAgIGNvbnN0IGtleXMgPSBEZWZhdWx0RW5jcnlwdGlvbi5kZXJpdmVLZXlzKGVuY3J5cHRpb25LZXksIGh5cGVyY29yZUtleSwgb3B0cykKCiAgICB0aGlzLmJsb2NrS2V5ID0ga2V5cy5ibG9jawogICAgdGhpcy5ibGluZGluZ0tleSA9IGtleXMuYmxpbmRpbmcKICB9CgogIHN0YXRpYyBkZXJpdmVLZXlzKGVuY3J5cHRpb25LZXksIGh5cGVyY29yZUtleSwgeyBibG9jayA9IGZhbHNlLCBjb21wYXQgPSBmYWxzZSB9ID0ge30pIHsKICAgIGNvbnN0IHN1YktleXMgPSBiNGEuYWxsb2MoMiAqIHNvZGl1bS5jcnlwdG9fc3RyZWFtX0tFWUJZVEVTKQoKICAgIGNvbnN0IGJsb2NrS2V5ID0gYmxvY2sgPyBlbmNyeXB0aW9uS2V5IDogc3ViS2V5cy5zdWJhcnJheSgwLCBzb2RpdW0uY3J5cHRvX3N0cmVhbV9LRVlCWVRFUykKICAgIGNvbnN0IGJsaW5kaW5nS2V5ID0gc3ViS2V5cy5zdWJhcnJheShzb2RpdW0uY3J5cHRvX3N0cmVhbV9LRVlCWVRFUykKCiAgICBpZiAoIWJsb2NrKSB7CiAgICAgIGlmIChjb21wYXQpIHsKICAgICAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKGJsb2NrS2V5LCBbZW5jcnlwdGlvbktleV0sIGh5cGVyY29yZUtleSkKICAgICAgfSBlbHNlIHsKICAgICAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKGJsb2NrS2V5LCBbREVGQVVMVF9FTkNSWVBUSU9OLCBoeXBlcmNvcmVLZXksIGVuY3J5cHRpb25LZXldKQogICAgICB9CiAgICB9CgogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChibGluZGluZ0tleSwgYmxvY2tLZXkpCgogICAgcmV0dXJuIHsKICAgICAgYmxpbmRpbmc6IGJsaW5kaW5nS2V5LAogICAgICBibG9jazogYmxvY2tLZXkKICAgIH0KICB9CgogIHN0YXRpYyBibG9ja0VuY3J5cHRpb25LZXkoaHlwZXJjb3JlS2V5LCBlbmNyeXB0aW9uS2V5KSB7CiAgICBjb25zdCBibG9ja0tleSA9IGI0YS5hbGxvYyhzb2RpdW0uY3J5cHRvX3N0cmVhbV9LRVlCWVRFUykKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2goYmxvY2tLZXksIFtERUZBVUxUX0VOQ1JZUFRJT04sIGh5cGVyY29yZUtleSwgZW5jcnlwdGlvbktleV0pCiAgICByZXR1cm4gYmxvY2tLZXkKICB9CgogIHN0YXRpYyBlbmNyeXB0KGluZGV4LCBibG9jaywgZm9yaywgYmxvY2tLZXksIGJsaW5kaW5nS2V5KSB7CiAgICBjb25zdCBwYWRkaW5nID0gYmxvY2suc3ViYXJyYXkoMCwgRGVmYXVsdEVuY3J5cHRpb24uUEFERElORykKICAgIGJsb2NrID0gYmxvY2suc3ViYXJyYXkoRGVmYXVsdEVuY3J5cHRpb24uUEFERElORykKCiAgICBjLnVpbnQ2NC5lbmNvZGUoeyBzdGFydDogMCwgZW5kOiA4LCBidWZmZXI6IHBhZGRpbmcgfSwgZm9yaykKICAgIGMudWludDY0LmVuY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IDgsIGJ1ZmZlcjogbm9uY2UgfSwgaW5kZXgpCgogICAgLy8gWmVybyBvdXQgYW55IHByZXZpb3VzIHBhZGRpbmcuCiAgICBub25jZS5maWxsKDAsIDgsIDggKyBwYWRkaW5nLmJ5dGVMZW5ndGgpCgogICAgLy8gQmxpbmQgdGhlIGZvcmsgSUQsIHBvc3NpYmx5IHJpc2tpbmcgcmV1c2luZyB0aGUgbm9uY2Ugb24gYSByZW9yZyBvZiB0aGUKICAgIC8vIEh5cGVyY29yZS4gVGhpcyBpcyBmaW5lIGFzIHRoZSBibGluZGluZyBpcyBiZXN0LWVmZm9ydCBhbmQgdGhlIGxhdGVzdAogICAgLy8gZm9yayBJRCBzaGFyZWQgb24gcmVwbGljYXRpb24gYW55d2F5LgogICAgc29kaXVtLmNyeXB0b19zdHJlYW1feG9yKHBhZGRpbmcsIHBhZGRpbmcsIG5vbmNlLCBibGluZGluZ0tleSkKCiAgICBub25jZS5zZXQocGFkZGluZywgOCkKCiAgICAvLyBUaGUgY29tYmluYXRpb24gb2YgYSAoYmxpbmRlZCkgZm9yayBJRCBhbmQgYSBibG9jayBpbmRleCBpcyB1bmlxdWUgZm9yIGEKICAgIC8vIGdpdmVuIEh5cGVyY29yZSBhbmQgaXMgdGhlcmVmb3JlIGEgdmFsaWQgbm9uY2UgZm9yIGVuY3J5cHRpbmcgdGhlIGJsb2NrLgogICAgc29kaXVtLmNyeXB0b19zdHJlYW1feG9yKGJsb2NrLCBibG9jaywgbm9uY2UsIGJsb2NrS2V5KQogIH0KCiAgc3RhdGljIGRlY3J5cHQoaW5kZXgsIGJsb2NrLCBibG9ja0tleSkgewogICAgY29uc3QgcGFkZGluZyA9IGJsb2NrLnN1YmFycmF5KDAsIERlZmF1bHRFbmNyeXB0aW9uLlBBRERJTkcpCiAgICBibG9jayA9IGJsb2NrLnN1YmFycmF5KERlZmF1bHRFbmNyeXB0aW9uLlBBRERJTkcpCgogICAgYy51aW50NjQuZW5jb2RlKHsgc3RhcnQ6IDAsIGVuZDogOCwgYnVmZmVyOiBub25jZSB9LCBpbmRleCkKCiAgICBub25jZS5zZXQocGFkZGluZywgOCkKCiAgICAvLyBEZWNyeXB0IHRoZSBibG9jayB1c2luZyB0aGUgYmxpbmRlZCBmb3JrIElELgogICAgc29kaXVtLmNyeXB0b19zdHJlYW1feG9yKGJsb2NrLCBibG9jaywgbm9uY2UsIGJsb2NrS2V5KQogIH0KCiAgZW5jcnlwdChpbmRleCwgYmxvY2ssIGZvcmssIGNvcmUpIHsKICAgIGlmIChjb3JlLmNvbXBhdCAhPT0gdGhpcy5jb21wYXQpIHRoaXMuX3JlbG9hZChjb3JlKQogICAgcmV0dXJuIERlZmF1bHRFbmNyeXB0aW9uLmVuY3J5cHQoaW5kZXgsIGJsb2NrLCBmb3JrLCB0aGlzLmJsb2NrS2V5LCB0aGlzLmJsaW5kaW5nS2V5KQogIH0KCiAgZGVjcnlwdChpbmRleCwgYmxvY2ssIGNvcmUpIHsKICAgIGlmIChjb3JlLmNvbXBhdCAhPT0gdGhpcy5jb21wYXQpIHRoaXMuX3JlbG9hZChjb3JlKQogICAgcmV0dXJuIERlZmF1bHRFbmNyeXB0aW9uLmRlY3J5cHQoaW5kZXgsIGJsb2NrLCB0aGlzLmJsb2NrS2V5KQogIH0KCiAgcGFkZGluZygpIHsKICAgIHJldHVybiBEZWZhdWx0RW5jcnlwdGlvbi5QQURESU5HCiAgfQoKICBfcmVsb2FkKGNvcmUpIHsKICAgIGNvbnN0IGJsb2NrID0gYjRhLmVxdWFscyh0aGlzLmtleSwgdGhpcy5ibG9ja0tleSkKICAgIGNvbnN0IGtleXMgPSBEZWZhdWx0RW5jcnlwdGlvbi5kZXJpdmVLZXlzKHRoaXMua2V5LCBjb3JlLmtleSwgeyBibG9jaywgY29tcGF0OiBjb3JlLmNvbXBhdCB9KQoKICAgIHRoaXMuYmxvY2tLZXkgPSBrZXlzLmJsb2NrS2V5CiAgICB0aGlzLmJsaW5kaW5nS2V5ID0ga2V5cy5ibGluZGluZ0tleQogIH0KfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIERvd25sb2FkIHsKICBjb25zdHJ1Y3RvcihzZXNzaW9uLCByYW5nZSkgewogICAgdGhpcy5zZXNzaW9uID0gc2Vzc2lvbgogICAgdGhpcy5yYW5nZSA9IHJhbmdlCiAgICB0aGlzLnJlcXVlc3QgPSBudWxsCiAgICB0aGlzLm9wZW5lZCA9IGZhbHNlCiAgICB0aGlzLm9wZW5pbmcgPSB0aGlzLl9vcGVuKCkKICAgIHRoaXMub3BlbmluZy5jYXRjaChub29wKQogIH0KCiAgcmVhZHkoKSB7CiAgICByZXR1cm4gdGhpcy5vcGVuaW5nCiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIGlmICh0aGlzLnNlc3Npb24ub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5zZXNzaW9uLm9wZW5pbmcKICAgIHRoaXMuX2Rvd25sb2FkKCkKICAgIHRoaXMub3BlbmVkID0gdHJ1ZQogIH0KCiAgYXN5bmMgZG9uZSgpIHsKICAgIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnJlcXVlc3QucHJvbWlzZQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmIChpc1Nlc3Npb25Nb3ZlZChlcnIpKSByZXR1cm4gdGhpcy5fZG93bmxvYWQoKQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIF9kb3dubG9hZCgpIHsKICAgIGNvbnN0IGFjdGl2ZVJlcXVlc3RzID0gKHRoaXMucmFuZ2UgJiYgdGhpcy5yYW5nZS5hY3RpdmVSZXF1ZXN0cykgfHwgdGhpcy5zZXNzaW9uLmFjdGl2ZVJlcXVlc3RzCiAgICB0aGlzLnJlcXVlc3QgPSB0aGlzLnNlc3Npb24uY29yZS5yZXBsaWNhdG9yLmFkZFJhbmdlKGFjdGl2ZVJlcXVlc3RzLCB0aGlzLnJhbmdlKQogICAgdGhpcy5yZXF1ZXN0LnByb21pc2UuY2F0Y2gobm9vcCkKICAgIHJldHVybiB0aGlzLnJlcXVlc3QucHJvbWlzZQogIH0KCiAgLyoqCiAgICogRGVwcmVjYXRlZC4gVXNlIGByYW5nZS5kb25lKClgLgogICAqLwogIGRvd25sb2FkZWQoKSB7CiAgICByZXR1cm4gdGhpcy5kb25lKCkKICB9CgogIGRlc3Ryb3koKSB7CiAgICB0aGlzLl9kZXN0cm95QmFja2dyb3VuZCgpLmNhdGNoKG5vb3ApCiAgfQoKICBhc3luYyBfZGVzdHJveUJhY2tncm91bmQoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmICh0aGlzLnJlcXVlc3QuY29udGV4dCkgdGhpcy5yZXF1ZXN0LmNvbnRleHQuZGV0YWNoKHRoaXMucmVxdWVzdCkKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gaXNTZXNzaW9uTW92ZWQoZXJyKSB7CiAgcmV0dXJuIGVyci5jb2RlID09PSAnU0VTU0lPTl9NT1ZFRCcKfQpjb25zdCBUSUNLUyA9IDE2Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEhvdHN3YXBRdWV1ZSB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLnByaW9yaXRpZXMgPSBbW10sIFtdLCBbXV0KICB9CgogICpwaWNrKHBlZXIpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5wcmlvcml0aWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIC8vIHRyeSBmaXJzdCBvbmUgbW9yZSB0aGFuIHNlY29uZCBvbmUgZXRjIGV0YwogICAgICBsZXQgdGlja3MgPSAodGhpcy5wcmlvcml0aWVzLmxlbmd0aCAtIGkpICogVElDS1MKICAgICAgY29uc3QgcXVldWUgPSB0aGlzLnByaW9yaXRpZXNbaV0KCiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcXVldWUubGVuZ3RoOyBqKyspIHsKICAgICAgICBjb25zdCByID0gaiArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHF1ZXVlLmxlbmd0aCAtIGopCiAgICAgICAgY29uc3QgYSA9IHF1ZXVlW2pdCiAgICAgICAgY29uc3QgYiA9IHF1ZXVlW3JdCgogICAgICAgIGlmIChyICE9PSBqKSB7CiAgICAgICAgICBxdWV1ZVsoYi5ob3Rzd2FwLmluZGV4ID0gaildID0gYgogICAgICAgICAgcXVldWVbKGEuaG90c3dhcC5pbmRleCA9IHIpXSA9IGEKICAgICAgICB9CgogICAgICAgIGlmIChoYXNJbmZsaWdodChiLCBwZWVyKSkgY29udGludWUKCiAgICAgICAgeWllbGQgYgoKICAgICAgICBpZiAoLS10aWNrcyA8PSAwKSBicmVhawogICAgICB9CiAgICB9CiAgfQoKICBhZGQoYmxvY2spIHsKICAgIGlmIChibG9jay5ob3Rzd2FwICE9PSBudWxsKSB0aGlzLnJlbW92ZShibG9jaykKICAgIGlmIChibG9jay5pbmZsaWdodC5sZW5ndGggPT09IDAgfHwgYmxvY2suaW5mbGlnaHQubGVuZ3RoID49IDMpIHJldHVybgoKICAgIC8vIFRPRE86IGFsc28gdXNlIG90aGVyIHN0dWZmIHRvIGRldGVybWluZSBxdWV1ZSBwcmlvCiAgICBjb25zdCBxdWV1ZSA9IHRoaXMucHJpb3JpdGllc1tibG9jay5pbmZsaWdodC5sZW5ndGggLSAxXQoKICAgIGNvbnN0IGluZGV4ID0gcXVldWUucHVzaChibG9jaykgLSAxCiAgICBibG9jay5ob3Rzd2FwID0geyByZWY6IHRoaXMsIHF1ZXVlLCBpbmRleCB9CiAgfQoKICByZW1vdmUoYmxvY2spIHsKICAgIGNvbnN0IGhvdHN3YXAgPSBibG9jay5ob3Rzd2FwCiAgICBpZiAoaG90c3dhcCA9PT0gbnVsbCkgcmV0dXJuCgogICAgYmxvY2suaG90c3dhcCA9IG51bGwKICAgIGNvbnN0IGhlYWQgPSBob3Rzd2FwLnF1ZXVlLnBvcCgpCiAgICBpZiAoaGVhZCA9PT0gYmxvY2spIHJldHVybgogICAgaG90c3dhcC5xdWV1ZVsoaGVhZC5ob3Rzd2FwLmluZGV4ID0gaG90c3dhcC5pbmRleCldID0gaGVhZAogIH0KfQoKZnVuY3Rpb24gaGFzSW5mbGlnaHQoYmxvY2ssIHBlZXIpIHsKICBmb3IgKGxldCBqID0gMDsgaiA8IGJsb2NrLmluZmxpZ2h0Lmxlbmd0aDsgaisrKSB7CiAgICBpZiAoYmxvY2suaW5mbGlnaHRbal0ucGVlciA9PT0gcGVlcikgcmV0dXJuIHRydWUKICB9CiAgcmV0dXJuIGZhbHNlCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBJbmZvIHsKICBjb25zdHJ1Y3RvcihvcHRzID0ge30pIHsKICAgIHRoaXMua2V5ID0gb3B0cy5rZXkKICAgIHRoaXMuZGlzY292ZXJ5S2V5ID0gb3B0cy5kaXNjb3ZlcnlLZXkKICAgIHRoaXMubGVuZ3RoID0gb3B0cy5sZW5ndGggfHwgMAogICAgdGhpcy5jb250aWd1b3VzTGVuZ3RoID0gb3B0cy5jb250aWd1b3VzTGVuZ3RoIHx8IDAKICAgIHRoaXMuYnl0ZUxlbmd0aCA9IG9wdHMuYnl0ZUxlbmd0aCB8fCAwCiAgICB0aGlzLmZvcmsgPSBvcHRzLmZvcmsgfHwgMAogICAgdGhpcy5wYWRkaW5nID0gb3B0cy5wYWRkaW5nIHx8IDAKICAgIHRoaXMuc3RvcmFnZSA9IG9wdHMuc3RvcmFnZSB8fCBudWxsCiAgfQoKICBzdGF0aWMgYXN5bmMgZnJvbShzZXNzaW9uLCBvcHRzID0ge30pIHsKICAgIHJldHVybiBuZXcgSW5mbyh7CiAgICAgIGtleTogc2Vzc2lvbi5rZXksCiAgICAgIGRpc2NvdmVyeUtleTogc2Vzc2lvbi5kaXNjb3ZlcnlLZXksCiAgICAgIGxlbmd0aDogc2Vzc2lvbi5sZW5ndGgsCiAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IHNlc3Npb24uY29udGlndW91c0xlbmd0aCwKICAgICAgYnl0ZUxlbmd0aDogc2Vzc2lvbi5ieXRlTGVuZ3RoLAogICAgICBmb3JrOiBzZXNzaW9uLmZvcmssCiAgICAgIHBhZGRpbmc6IHNlc3Npb24ucGFkZGluZywKICAgICAgc3RvcmFnZTogb3B0cy5zdG9yYWdlID8gYXdhaXQgdGhpcy5zdG9yYWdlKHNlc3Npb24pIDogbnVsbAogICAgfSkKICB9CgogIHN0YXRpYyBhc3luYyBzdG9yYWdlKHNlc3Npb24pIHsKICAgIGNvbnN0IHsgb3Bsb2csIHRyZWUsIGJsb2NrcywgYml0ZmllbGQgfSA9IHNlc3Npb24uY29yZQogICAgdHJ5IHsKICAgICAgcmV0dXJuIHsKICAgICAgICBvcGxvZzogYXdhaXQgSW5mby5ieXRlc1VzZWQob3Bsb2cuc3RvcmFnZSksCiAgICAgICAgdHJlZTogYXdhaXQgSW5mby5ieXRlc1VzZWQodHJlZS5zdG9yYWdlKSwKICAgICAgICBibG9ja3M6IGF3YWl0IEluZm8uYnl0ZXNVc2VkKGJsb2Nrcy5zdG9yYWdlKSwKICAgICAgICBiaXRmaWVsZDogYXdhaXQgSW5mby5ieXRlc1VzZWQoYml0ZmllbGQuc3RvcmFnZSkKICAgICAgfQogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiBudWxsCiAgICB9CiAgfQoKICBzdGF0aWMgYnl0ZXNVc2VkKGZpbGUpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGZpbGUuc3RhdCgoZXJyLCBzdCkgPT4gewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHJlc29sdmUoMCkgLy8gcHJvYiBqdXN0IGZpbGUgbm90IGZvdW5kIChUT0RPLCBpbXByb3ZlKQogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0LmJsb2NrcyAhPT0gJ251bWJlcicpIHsKICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ2Nhbm5vdCBkZXRlcm1pbmUgYnl0ZXMgdXNlZCcpKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXNvbHZlKHN0LmJsb2NrcyAqIDUxMikKICAgICAgICB9CiAgICAgIH0pCiAgICB9KQogIH0KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoY29yZSwgZGVwdGgsIG9wdHMpIHsKICBsZXQgaW5kZW50ID0gJycKICBpZiAodHlwZW9mIG9wdHMuaW5kZW50YXRpb25MdmwgPT09ICdudW1iZXInKSB7CiAgICB3aGlsZSAoaW5kZW50Lmxlbmd0aCA8IG9wdHMuaW5kZW50YXRpb25MdmwpIGluZGVudCArPSAnICcKICB9CgogIGxldCBwZWVycyA9ICcnCiAgY29uc3QgbWluID0gTWF0aC5taW4oY29yZS5wZWVycy5sZW5ndGgsIDUpCgogIGZvciAobGV0IGkgPSAwOyBpIDwgbWluOyBpKyspIHsKICAgIGNvbnN0IHBlZXIgPSBjb3JlLnBlZXJzW2ldCgogICAgcGVlcnMgKz0gYCR7aW5kZW50fSAgICBQZWVyKFxuYAogICAgcGVlcnMgKz0gYCR7aW5kZW50fSAgICAgIHJlbW90ZVB1YmxpY0tleTogJHtvcHRzLnN0eWxpemUodG9IZXgocGVlci5yZW1vdGVQdWJsaWNLZXkpLCAnc3RyaW5nJyl9XG5gCiAgICBwZWVycyArPSBgJHtpbmRlbnR9ICAgICAgcmVtb3RlTGVuZ3RoOiAke29wdHMuc3R5bGl6ZShwZWVyLnJlbW90ZUxlbmd0aCwgJ251bWJlcicpfVxuYAogICAgcGVlcnMgKz0gYCR7aW5kZW50fSAgICAgIHJlbW90ZUZvcms6ICR7b3B0cy5zdHlsaXplKHBlZXIucmVtb3RlRm9yaywgJ251bWJlcicpfVxuYAogICAgcGVlcnMgKz0gYCR7aW5kZW50fSAgICAgIHJlbW90ZUNhblVwZ3JhZGU6ICR7b3B0cy5zdHlsaXplKHBlZXIucmVtb3RlQ2FuVXBncmFkZSwgJ2Jvb2xlYW4nKX1cbmAKICAgIHBlZXJzICs9IGAke2luZGVudH0gICAgKVxuYAogIH0KCiAgaWYgKGNvcmUucGVlcnMubGVuZ3RoID4gNSkgewogICAgcGVlcnMgKz0gYCR7aW5kZW50fSAgLi4uIGFuZCAke2NvcmUucGVlcnMubGVuZ3RoIC0gNX0gbW9yZVxuYAogIH0KCiAgaWYgKHBlZXJzKSBwZWVycyA9IGBbXG4ke3BlZXJzfSR7aW5kZW50fSAgXWAKICBlbHNlIHBlZXJzID0gYFsgJHtvcHRzLnN0eWxpemUoMCwgJ251bWJlcicpfSBdYAoKICByZXR1cm4gKAogICAgYCR7Y29yZS5jb25zdHJ1Y3Rvci5uYW1lfShcbmAgKwogICAgYCR7aW5kZW50fSAgaWQ6ICR7b3B0cy5zdHlsaXplKGNvcmUuaWQsICdzdHJpbmcnKX1cbmAgKwogICAgYCR7aW5kZW50fSAga2V5OiAke29wdHMuc3R5bGl6ZSh0b0hleChjb3JlLmtleSksICdzdHJpbmcnKX1cbmAgKwogICAgYCR7aW5kZW50fSAgZGlzY292ZXJ5S2V5OiAke29wdHMuc3R5bGl6ZSh0b0hleChjb3JlLmRpc2NvdmVyeUtleSksICdzdHJpbmcnKX1cbmAgKwogICAgYCR7aW5kZW50fSAgb3BlbmVkOiAke29wdHMuc3R5bGl6ZShjb3JlLm9wZW5lZCwgJ2Jvb2xlYW4nKX1cbmAgKwogICAgYCR7aW5kZW50fSAgY2xvc2VkOiAke29wdHMuc3R5bGl6ZShjb3JlLmNsb3NlZCwgJ2Jvb2xlYW4nKX1cbmAgKwogICAgYCR7aW5kZW50fSAgc25hcHNob3R0ZWQ6ICR7b3B0cy5zdHlsaXplKGNvcmUuc25hcHNob3R0ZWQsICdib29sZWFuJyl9XG5gICsKICAgIGAke2luZGVudH0gIHdyaXRhYmxlOiAke29wdHMuc3R5bGl6ZShjb3JlLndyaXRhYmxlLCAnYm9vbGVhbicpfVxuYCArCiAgICBgJHtpbmRlbnR9ICBsZW5ndGg6ICR7b3B0cy5zdHlsaXplKGNvcmUubGVuZ3RoLCAnbnVtYmVyJyl9XG5gICsKICAgIGAke2luZGVudH0gIGZvcms6ICR7b3B0cy5zdHlsaXplKGNvcmUuZm9yaywgJ251bWJlcicpfVxuYCArCiAgICBgJHtpbmRlbnR9ICBzZXNzaW9uczogWyAke29wdHMuc3R5bGl6ZShjb3JlLnNlc3Npb25zLmxlbmd0aCwgJ251bWJlcicpfSBdXG5gICsKICAgIGAke2luZGVudH0gIGFjdGl2ZVJlcXVlc3RzOiBbICR7b3B0cy5zdHlsaXplKGNvcmUuYWN0aXZlUmVxdWVzdHMubGVuZ3RoLCAnbnVtYmVyJyl9IF1cbmAgKwogICAgYCR7aW5kZW50fSAgcGVlcnM6ICR7cGVlcnN9XG5gICsKICAgIGAke2luZGVudH0pYAogICkKfQoKZnVuY3Rpb24gdG9IZXgoYnVmKSB7CiAgcmV0dXJuIGJ1ZiAmJiBiNGEudG9TdHJpbmcoYnVmLCAnaGV4JykKfQpjb25zdCBmbGF0ID0gcmVxdWlyZSgnZmxhdC10cmVlJykKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHVuc2xhYiA9IHJlcXVpcmUoJ3Vuc2xhYicpCmNvbnN0IGNhcHMgPSByZXF1aXJlKCcuL2NhcHMnKQpjb25zdCB7CiAgSU5WQUxJRF9QUk9PRiwKICBJTlZBTElEX0NIRUNLU1VNLAogIElOVkFMSURfT1BFUkFUSU9OLAogIEJBRF9BUkdVTUVOVCwKICBBU1NFUlRJT04KfSA9IHJlcXVpcmUoJ2h5cGVyY29yZS1lcnJvcnMnKQoKY2xhc3MgTm9kZVF1ZXVlIHsKICBjb25zdHJ1Y3Rvcihub2RlcywgZXh0cmEgPSBudWxsKSB7CiAgICB0aGlzLmkgPSAwCiAgICB0aGlzLm5vZGVzID0gbm9kZXMKICAgIHRoaXMuZXh0cmEgPSBleHRyYQogICAgdGhpcy5sZW5ndGggPSBub2Rlcy5sZW5ndGggKyAodGhpcy5leHRyYSA9PT0gbnVsbCA/IDAgOiAxKQogIH0KCiAgc2hpZnQoaW5kZXgpIHsKICAgIGlmICh0aGlzLmV4dHJhICE9PSBudWxsICYmIHRoaXMuZXh0cmEuaW5kZXggPT09IGluZGV4KSB7CiAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLmV4dHJhCiAgICAgIHRoaXMuZXh0cmEgPSBudWxsCiAgICAgIHRoaXMubGVuZ3RoLS0KICAgICAgcmV0dXJuIG5vZGUKICAgIH0KCiAgICBpZiAodGhpcy5pID49IHRoaXMubm9kZXMubGVuZ3RoKSB7CiAgICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdFeHBlY3RlZCBub2RlICcgKyBpbmRleCArICcsIGdvdCAobmlsKScpCiAgICB9CgogICAgY29uc3Qgbm9kZSA9IHRoaXMubm9kZXNbdGhpcy5pKytdCiAgICBpZiAobm9kZS5pbmRleCAhPT0gaW5kZXgpIHsKICAgICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0V4cGVjdGVkIG5vZGUgJyArIGluZGV4ICsgJywgZ290IG5vZGUgJyArIG5vZGUuaW5kZXgpCiAgICB9CgogICAgdGhpcy5sZW5ndGgtLQogICAgcmV0dXJuIG5vZGUKICB9Cn0KCmNsYXNzIE1lcmtsZVRyZWVCYXRjaCB7CiAgY29uc3RydWN0b3Ioc2Vzc2lvbikgewogICAgdGhpcy5mb3JrID0gc2Vzc2lvbi5mb3JrCiAgICB0aGlzLnJvb3RzID0gWy4uLnNlc3Npb24ucm9vdHNdCiAgICB0aGlzLmxlbmd0aCA9IHNlc3Npb24ubGVuZ3RoCiAgICB0aGlzLnNpZ25hdHVyZSA9IHNlc3Npb24uc2lnbmF0dXJlCiAgICB0aGlzLmFuY2VzdG9ycyA9IHNlc3Npb24ubGVuZ3RoCiAgICB0aGlzLmJ5dGVMZW5ndGggPSBzZXNzaW9uLmJ5dGVMZW5ndGgKICAgIHRoaXMucHJvbG9ndWUgPSBzZXNzaW9uLnByb2xvZ3VlCiAgICB0aGlzLmhhc2hDYWNoZWQgPSBudWxsCgogICAgdGhpcy5jb21taXR0ZWQgPSBmYWxzZQogICAgdGhpcy50cnVuY2F0ZWQgPSBmYWxzZQogICAgdGhpcy50cmVlTGVuZ3RoID0gc2Vzc2lvbi5sZW5ndGgKICAgIHRoaXMudHJlZUZvcmsgPSBzZXNzaW9uLmZvcmsKICAgIHRoaXMuc3RvcmFnZSA9IHNlc3Npb24uc3RvcmFnZQogICAgdGhpcy5zZXNzaW9uID0gc2Vzc2lvbgogICAgdGhpcy5ub2RlcyA9IFtdCiAgICB0aGlzLnVwZ3JhZGVkID0gZmFsc2UKICB9CgogIGNoZWNrb3V0KGxlbmd0aCwgYWRkaXRpb25hbFJvb3RzKSB7CiAgICBjb25zdCByb290cyA9IFtdCiAgICBsZXQgciA9IDAKCiAgICBjb25zdCBoZWFkID0gMiAqIGxlbmd0aCAtIDIKICAgIGNvbnN0IGdhcHMgPSBuZXcgU2V0KCkKICAgIGNvbnN0IGFsbCA9IG5ldyBNYXAoKQoKICAgIC8vIGFkZGl0aW9uYWwgcm9vdHMgaXMgc28gdGhlIG9yaWdpbmFsIHJvb3RzIGNhbiBiZSBwYXNzZWQgKHdlIG11dGF0ZSB0aGUgYXJyYXkgaW4gYXBwZW5kUm9vdCkKICAgIGlmIChhZGRpdGlvbmFsUm9vdHMpIHsKICAgICAgZm9yIChjb25zdCBub2RlIG9mIGFkZGl0aW9uYWxSb290cykgYWxsLnNldChub2RlLmluZGV4LCBub2RlKQogICAgfQoKICAgIGZvciAoY29uc3Qgbm9kZSBvZiB0aGlzLm5vZGVzKSBhbGwuc2V0KG5vZGUuaW5kZXgsIG5vZGUpCgogICAgZm9yIChjb25zdCBpbmRleCBvZiBmbGF0LmZ1bGxSb290cyhoZWFkICsgMikpIHsKICAgICAgY29uc3QgbGVmdCA9IGZsYXQubGVmdFNwYW4oaW5kZXgpCiAgICAgIGlmIChsZWZ0ICE9PSAwKSBnYXBzLmFkZChsZWZ0IC0gMSkKCiAgICAgIGlmIChyIDwgdGhpcy5yb290cy5sZW5ndGggJiYgdGhpcy5yb290c1tyXS5pbmRleCA9PT0gaW5kZXgpIHsKICAgICAgICByb290cy5wdXNoKHRoaXMucm9vdHNbcisrXSkKICAgICAgICBjb250aW51ZQogICAgICB9CiAgICAgIGNvbnN0IG5vZGUgPSBhbGwuZ2V0KGluZGV4KQogICAgICBpZiAoIW5vZGUpIHRocm93IG5ldyBCQURfQVJHVU1FTlQoJ3Jvb3QgbWlzc2luZyBmb3IgZ2l2ZW4gbGVuZ3RoJykKICAgICAgcm9vdHMucHVzaChub2RlKQogICAgfQoKICAgIHRoaXMucm9vdHMgPSByb290cwogICAgdGhpcy5sZW5ndGggPSBsZW5ndGgKICAgIHRoaXMuYnl0ZUxlbmd0aCA9IHRvdGFsU2l6ZShyb290cykKICAgIHRoaXMuaGFzaENhY2hlZCA9IG51bGwKICAgIHRoaXMuc2lnbmF0dXJlID0gbnVsbAoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5ub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBpbmRleCA9IHRoaXMubm9kZXNbaV0uaW5kZXgKICAgICAgaWYgKGluZGV4IDw9IGhlYWQgJiYgIWdhcHMuaGFzKGluZGV4KSkgY29udGludWUKICAgICAgY29uc3QgbGFzdCA9IHRoaXMubm9kZXMucG9wKCkKICAgICAgaWYgKGkgPCB0aGlzLm5vZGVzLmxlbmd0aCkgdGhpcy5ub2Rlc1tpLS1dID0gbGFzdAogICAgfQogIH0KCiAgcHJ1bmUobGVuZ3RoKSB7CiAgICBpZiAobGVuZ3RoID09PSAwKSByZXR1cm4KCiAgICBjb25zdCBoZWFkID0gMiAqIGxlbmd0aCAtIDIKICAgIGNvbnN0IGdhcHMgPSBuZXcgU2V0KCkKCiAgICAvLyBUT0RPOiBtYWtlIGEgZnVuY3Rpb24gZm9yIHRoaXMgaW4gZmxhdC10cmVlCiAgICBmb3IgKGNvbnN0IGluZGV4IG9mIGZsYXQuZnVsbFJvb3RzKGhlYWQgKyAyKSkgewogICAgICBjb25zdCBsZWZ0ID0gZmxhdC5sZWZ0U3BhbihpbmRleCkKICAgICAgaWYgKGxlZnQgIT09IDApIGdhcHMuYWRkKGxlZnQgLSAxKQogICAgfQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5ub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBpbmRleCA9IHRoaXMubm9kZXNbaV0uaW5kZXgKICAgICAgaWYgKGluZGV4ID4gaGVhZCB8fCBnYXBzLmhhcyhpbmRleCkpIGNvbnRpbnVlCiAgICAgIGNvbnN0IGxhc3QgPSB0aGlzLm5vZGVzLnBvcCgpCiAgICAgIGlmIChpIDwgdGhpcy5ub2Rlcy5sZW5ndGgpIHRoaXMubm9kZXNbaS0tXSA9IGxhc3QKICAgIH0KICB9CgogIGNsb25lKCkgewogICAgY29uc3QgYiA9IG5ldyBNZXJrbGVUcmVlQmF0Y2godGhpcy5zZXNzaW9uKQoKICAgIGIuZm9yayA9IHRoaXMuZm9yawogICAgYi5yb290cyA9IFsuLi50aGlzLnJvb3RzXQogICAgYi5sZW5ndGggPSB0aGlzLmxlbmd0aAogICAgYi5ieXRlTGVuZ3RoID0gdGhpcy5ieXRlTGVuZ3RoCiAgICBiLnNpZ25hdHVyZSA9IHRoaXMuc2lnbmF0dXJlCiAgICBiLnRyZWVMZW5ndGggPSB0aGlzLnRyZWVMZW5ndGgKICAgIGIudHJlZUZvcmsgPSB0aGlzLnRyZWVGb3JrCiAgICBiLnRyZWUgPSB0aGlzLnRyZWUKICAgIGIubm9kZXMgPSBbLi4udGhpcy5ub2Rlc10KICAgIGIudXBncmFkZWQgPSB0aGlzLnVwZ3JhZGVkCgogICAgcmV0dXJuIGIKICB9CgogIGhhc2goKSB7CiAgICBpZiAodGhpcy5oYXNoQ2FjaGVkID09PSBudWxsKSB0aGlzLmhhc2hDYWNoZWQgPSB1bnNsYWIoY3J5cHRvLnRyZWUodGhpcy5yb290cykpCiAgICByZXR1cm4gdGhpcy5oYXNoQ2FjaGVkCiAgfQoKICBzaWduYWJsZShtYW5pZmVzdEhhc2gpIHsKICAgIHJldHVybiBjYXBzLnRyZWVTaWduYWJsZShtYW5pZmVzdEhhc2gsIHRoaXMuaGFzaCgpLCB0aGlzLmxlbmd0aCwgdGhpcy5mb3JrKQogIH0KCiAgc2lnbmFibGVDb21wYXQobm9IZWFkZXIpIHsKICAgIHJldHVybiBjYXBzLnRyZWVTaWduYWJsZUNvbXBhdCh0aGlzLmhhc2goKSwgdGhpcy5sZW5ndGgsIHRoaXMuZm9yaywgbm9IZWFkZXIpCiAgfQoKICBnZXQoaW5kZXgpIHsKICAgIGlmIChpbmRleCA+PSB0aGlzLmxlbmd0aCAqIDIpIHsKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBmb3IgKGNvbnN0IG4gb2YgdGhpcy5ub2RlcykgewogICAgICBpZiAobi5pbmRleCA9PT0gaW5kZXgpIHJldHVybiBuCiAgICB9CgogICAgcmV0dXJuIGdldFRyZWVOb2RlRnJvbVN0b3JhZ2UodGhpcy5zZXNzaW9uLnN0b3JhZ2UsIGluZGV4KQogIH0KCiAgLy8gZGVwcmVjYXRlZCwgdXNlIHNzc2lvbiBwcm9vZiBpbnN0ZWFkCiAgcHJvb2YoYmF0Y2gsIHsgYmxvY2ssIGhhc2gsIHNlZWssIHVwZ3JhZGUgfSkgewogICAgcmV0dXJuIGdlbmVyYXRlUHJvb2YodGhpcy5zZXNzaW9uLCBiYXRjaCwgYmxvY2ssIGhhc2gsIHNlZWssIHVwZ3JhZGUpCiAgfQoKICB2ZXJpZnlVcGdyYWRlKHByb29mKSB7CiAgICBjb25zdCB1bnZlcmlmaWVkID0gdmVyaWZ5VHJlZShwcm9vZiwgdGhpcy5ub2RlcykKCiAgICBpZiAoIXByb29mLnVwZ3JhZGUpIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdFeHBlY3RlZCB1cGdyYWRlIHByb29mJykKCiAgICByZXR1cm4gdmVyaWZ5VXBncmFkZShwcm9vZiwgdW52ZXJpZmllZCwgdGhpcykKICB9CgogIGFkZE5vZGVzVW5zYWZlKG5vZGVzKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHRoaXMubm9kZXMucHVzaChub2Rlc1tpXSkKICAgIH0KICB9CgogIGFwcGVuZChidWYpIHsKICAgIGNvbnN0IGhlYWQgPSB0aGlzLmxlbmd0aCAqIDIKICAgIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IoaGVhZCkKICAgIGNvbnN0IG5vZGUgPSBibG9ja05vZGUoaGVhZCwgYnVmKQoKICAgIHRoaXMuYXBwZW5kUm9vdChub2RlLCBpdGUpCiAgfQoKICBhcHBlbmRSb290KG5vZGUsIGl0ZSkgewogICAgbm9kZSA9IHVuc2xhYk5vZGUobm9kZSkKICAgIHRoaXMuaGFzaENhY2hlZCA9IG51bGwKICAgIHRoaXMudXBncmFkZWQgPSB0cnVlCiAgICB0aGlzLmxlbmd0aCArPSBpdGUuZmFjdG9yIC8gMgogICAgdGhpcy5ieXRlTGVuZ3RoICs9IG5vZGUuc2l6ZQogICAgdGhpcy5yb290cy5wdXNoKG5vZGUpCiAgICB0aGlzLm5vZGVzLnB1c2gobm9kZSkKCiAgICB3aGlsZSAodGhpcy5yb290cy5sZW5ndGggPiAxKSB7CiAgICAgIGNvbnN0IGEgPSB0aGlzLnJvb3RzW3RoaXMucm9vdHMubGVuZ3RoIC0gMV0KICAgICAgY29uc3QgYiA9IHRoaXMucm9vdHNbdGhpcy5yb290cy5sZW5ndGggLSAyXQoKICAgICAgLy8gVE9ETzoganVzdCBoYXZlIGEgcGVlayBzaWJsaW5nIGluc3RlYWQ/IChwcmV0dHkgc3VyZSBpdCdzIGFsd2F5cyB0aGUgbGVmdCBzaWIgYXMgd2VsbCkKICAgICAgaWYgKGl0ZS5zaWJsaW5nKCkgIT09IGIuaW5kZXgpIHsKICAgICAgICBpdGUuc2libGluZygpIC8vIHVuc2V0IHNvIGl0IGFsd2F5cyBwb2ludHMgdG8gbGFzdCByb290CiAgICAgICAgYnJlYWsKICAgICAgfQoKICAgICAgY29uc3Qgbm9kZSA9IHVuc2xhYk5vZGUocGFyZW50Tm9kZShpdGUucGFyZW50KCksIGEsIGIpKQogICAgICB0aGlzLm5vZGVzLnB1c2gobm9kZSkKICAgICAgdGhpcy5yb290cy5wb3AoKQogICAgICB0aGlzLnJvb3RzLnBvcCgpCiAgICAgIHRoaXMucm9vdHMucHVzaChub2RlKQogICAgfQogIH0KCiAgY29tbWl0YWJsZSgpIHsKICAgIHJldHVybiAoCiAgICAgIHRoaXMudHJlZUZvcmsgPT09IHRoaXMuc2Vzc2lvbi5mb3JrICYmCiAgICAgICh0aGlzLnVwZ3JhZGVkCiAgICAgICAgPyB0aGlzLnRyZWVMZW5ndGggPT09IHRoaXMuc2Vzc2lvbi5sZW5ndGgKICAgICAgICA6IHRoaXMudHJlZUxlbmd0aCA8PSB0aGlzLnNlc3Npb24ubGVuZ3RoKQogICAgKQogIH0KCiAgY29tbWl0KHR4KSB7CiAgICBpZiAodHggPT09IHVuZGVmaW5lZCkgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ05vIGRhdGFiYXNlIGJhdGNoIHdhcyBwYXNzZWQnKQogICAgaWYgKCF0aGlzLmNvbW1pdGFibGUoKSkgewogICAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTignVHJlZSB3YXMgbW9kaWZpZWQgZHVyaW5nIGJhdGNoLCByZWZ1c2luZyB0byBjb21taXQnKQogICAgfQoKICAgIGlmICh0aGlzLnVwZ3JhZGVkKSB0aGlzLl9jb21taXRVcGdyYWRlKHR4KQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5ub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBub2RlID0gdGhpcy5ub2Rlc1tpXQogICAgICB0eC5wdXRUcmVlTm9kZShub2RlKQogICAgfQoKICAgIHRoaXMuY29tbWl0dGVkID0gdHJ1ZQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBfY29tbWl0VXBncmFkZSh0eCkgewogICAgLy8gVE9ETzogSWYgZWFzeSB0byBkZXRlY3QsIHdlIHNob3VsZCByZWZ1c2UgYW4gdHJ1bmMrYXBwZW5kIGhlcmUgd2l0aG91dCBhIGZvcmsgaWQKICAgIC8vIGNoYW5nZS4gV2lsbCBvbmx5IGhhcHBlbiBvbiB1c2VyIGVycm9yIHNvIG1vc3RseSB0byBwcmV2ZW50IHRoYXQuCgogICAgaWYgKHRoaXMuYW5jZXN0b3JzIDwgdGhpcy50cmVlTGVuZ3RoKSB7CiAgICAgIHR4LmRlbGV0ZVRyZWVOb2RlUmFuZ2UodGhpcy5hbmNlc3RvcnMgKiAyLCB0aGlzLnRyZWVMZW5ndGggKiAyKQoKICAgICAgaWYgKHRoaXMuYW5jZXN0b3JzID4gMCkgewogICAgICAgIGNvbnN0IGhlYWQgPSB0aGlzLmFuY2VzdG9ycyAqIDIKICAgICAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKGhlYWQgLSAyKQoKICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgaWYgKGl0ZS5jb250YWlucyhoZWFkKSAmJiBpdGUuaW5kZXggPCBoZWFkKSB7CiAgICAgICAgICAgIHR4LmRlbGV0ZVRyZWVOb2RlKGl0ZS5pbmRleCkKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpdGUub2Zmc2V0ID09PSAwKSBicmVhawogICAgICAgICAgaXRlLnBhcmVudCgpCiAgICAgICAgfQoKICAgICAgICB0aGlzLnRydW5jYXRlZCA9IHRydWUKICAgICAgfQogICAgfQogIH0KCiAgc2VlayhieXRlcywgcGFkZGluZykgewogICAgcmV0dXJuIG5ldyBCeXRlU2Vla2VyKHRoaXMsIHRoaXMsIGJ5dGVzLCBwYWRkaW5nKQogIH0KCiAgYnl0ZVJhbmdlKGluZGV4KSB7CiAgICBjb25zdCByeCA9IHRoaXMuc3RvcmFnZS5yZWFkKCkKICAgIGNvbnN0IHJhbmdlID0gZ2V0Qnl0ZVJhbmdlKHRoaXMsIGluZGV4LCByeCkKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICByZXR1cm4gcmFuZ2UKICB9CgogIGJ5dGVPZmZzZXQoaW5kZXgpIHsKICAgIGlmIChpbmRleCA9PT0gMiAqIHRoaXMubGVuZ3RoKSByZXR1cm4gdGhpcy5ieXRlTGVuZ3RoCgogICAgY29uc3QgcnggPSB0aGlzLnN0b3JhZ2UucmVhZCgpCiAgICBjb25zdCBvZmZzZXQgPSBnZXRCeXRlT2Zmc2V0KHRoaXMsIGluZGV4LCByeCkKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICByZXR1cm4gb2Zmc2V0CiAgfQoKICBhc3luYyBkb3duZ3JhZGUoKSB7CiAgICBpZiAoIXRoaXMudXBncmFkZWQpIHJldHVybiB0cnVlCgogICAgY29uc3QgcnggPSB0aGlzLnN0b3JhZ2UucmVhZCgpCiAgICBjb25zdCBub2RlUHJvbWlzZXMgPSBbXQoKICAgIGZvciAoY29uc3QgciBvZiB0aGlzLnJvb3RzKSB7CiAgICAgIG5vZGVQcm9taXNlcy5wdXNoKHJ4LmdldFRyZWVOb2RlKHIuaW5kZXgpKQogICAgfQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBub2RlcyA9IGF3YWl0IFByb21pc2UuYWxsKG5vZGVQcm9taXNlcykKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucm9vdHMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qgcm9vdCA9IHRoaXMucm9vdHNbaV0KICAgICAgY29uc3Qgbm9kZSA9IG5vZGVzW2ldCgogICAgICBpZiAoIW5vZGUpIHJldHVybiBmYWxzZQogICAgICBpZiAoIWI0YS5lcXVhbHMobm9kZS5oYXNoLCByb290Lmhhc2gpKSByZXR1cm4gZmFsc2UKICAgIH0KCiAgICB0aGlzLnVwZ3JhZGVkID0gZmFsc2UKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyByZXN0b3JlKGxlbmd0aCkgewogICAgaWYgKGxlbmd0aCA9PT0gdGhpcy5sZW5ndGgpIHJldHVybiB0aGlzCgogICAgY29uc3Qgcm9vdHMgPSB1bnNsYWJOb2Rlcyhhd2FpdCBNZXJrbGVUcmVlLmdldFJvb3RzRnJvbVN0b3JhZ2UodGhpcy5zdG9yYWdlLCBsZW5ndGgpKQoKICAgIHRoaXMucm9vdHMgPSByb290cwogICAgdGhpcy5sZW5ndGggPSBsZW5ndGgKICAgIHRoaXMuYnl0ZUxlbmd0aCA9IHRvdGFsU2l6ZShyb290cykKICAgIHRoaXMuYW5jZXN0b3JzID0gbGVuZ3RoCgogICAgZm9yIChjb25zdCBub2RlIG9mIHJvb3RzKSB0aGlzLmJ5dGVMZW5ndGggKz0gbm9kZS5zaXplCgogICAgcmV0dXJuIHRoaXMKICB9Cn0KCmNsYXNzIFJlb3JnQmF0Y2ggZXh0ZW5kcyBNZXJrbGVUcmVlQmF0Y2ggewogIGNvbnN0cnVjdG9yKHNlc3Npb24pIHsKICAgIHN1cGVyKHNlc3Npb24pCgogICAgdGhpcy5yb290cyA9IFtdCiAgICB0aGlzLmxlbmd0aCA9IDAKICAgIHRoaXMuYnl0ZUxlbmd0aCA9IDAKICAgIHRoaXMuZGlmZiA9IG51bGwKICAgIHRoaXMuYW5jZXN0b3JzID0gMAogICAgLy8gV2Ugc2V0IHVwZ3JhZGVkIGJlY2F1c2UgcmVvcmdzIGFyZSBzaWduZWQgc28gaGl0IHdpbGwKICAgIC8vIGhpdCB0aGUgc2FtZSBjb2RlIHBhdGhzIChsaWtlIHRoZSB0cmVlTGVuZ3RoIGNoZWNrIGluIGNvbW1pdCkKICAgIHRoaXMudXBncmFkZWQgPSB0cnVlCiAgICB0aGlzLndhbnQgPSB7CiAgICAgIG5vZGVzOiAwLAogICAgICBzdGFydDogMCwKICAgICAgZW5kOiAwCiAgICB9CiAgfQoKICBnZXQgZmluaXNoZWQoKSB7CiAgICByZXR1cm4gdGhpcy53YW50ID09PSBudWxsCiAgfQoKICB1cGRhdGUocHJvb2YpIHsKICAgIGlmICh0aGlzLndhbnQgPT09IG51bGwpIHJldHVybiB0cnVlCgogICAgY29uc3Qgbm9kZXMgPSBbXQogICAgY29uc3Qgcm9vdCA9IHZlcmlmeVRyZWUocHJvb2YsIG5vZGVzKQoKICAgIGlmIChyb290ID09PSBudWxsIHx8ICFiNGEuZXF1YWxzKHJvb3QuaGFzaCwgdGhpcy5kaWZmLmhhc2gpKSByZXR1cm4gZmFsc2UKCiAgICB0aGlzLm5vZGVzLnB1c2goLi4ubm9kZXMpCiAgICByZXR1cm4gdGhpcy5fdXBkYXRlKG5vZGVzKQogIH0KCiAgYXN5bmMgX3VwZGF0ZShub2RlcykgewogICAgY29uc3QgbiA9IG5ldyBNYXAoKQogICAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSBuLnNldChub2RlLmluZGV4LCBub2RlKQoKICAgIGxldCBkaWZmID0gbnVsbAogICAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcih0aGlzLmRpZmYuaW5kZXgpCiAgICBjb25zdCBzdGFydGluZ0RpZmYgPSB0aGlzLmRpZmYKCiAgICB3aGlsZSAoKGl0ZS5pbmRleCAmIDEpICE9PSAwKSB7CiAgICAgIGNvbnN0IGxlZnQgPSBuLmdldChpdGUubGVmdENoaWxkKCkpCiAgICAgIGlmICghbGVmdCkgYnJlYWsKCiAgICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZSh0aGlzLnNlc3Npb24uc3RvcmFnZSwgbGVmdC5pbmRleCkKICAgICAgaWYgKCFleGlzdGluZyB8fCAhYjRhLmVxdWFscyhleGlzdGluZy5oYXNoLCBsZWZ0Lmhhc2gpKSB7CiAgICAgICAgZGlmZiA9IGxlZnQKICAgICAgfSBlbHNlIHsKICAgICAgICBkaWZmID0gbi5nZXQoaXRlLnNpYmxpbmcoKSkKICAgICAgfQogICAgfQoKICAgIGlmICgodGhpcy5kaWZmLmluZGV4ICYgMSkgPT09IDApIHJldHVybiB0cnVlCiAgICBpZiAoZGlmZiA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCiAgICBpZiAoc3RhcnRpbmdEaWZmICE9PSB0aGlzLmRpZmYpIHJldHVybiBmYWxzZQoKICAgIHJldHVybiB0aGlzLl91cGRhdGVEaWZmUm9vdChkaWZmKQogIH0KCiAgX3VwZGF0ZURpZmZSb290KGRpZmYpIHsKICAgIGlmICh0aGlzLndhbnQgPT09IG51bGwpIHJldHVybiB0cnVlCgogICAgY29uc3Qgc3BhbnMgPSBmbGF0LnNwYW5zKGRpZmYuaW5kZXgpCiAgICBjb25zdCBzdGFydCA9IHNwYW5zWzBdIC8gMgogICAgY29uc3QgZW5kID0gTWF0aC5taW4odGhpcy50cmVlTGVuZ3RoLCBzcGFuc1sxXSAvIDIgKyAxKQogICAgY29uc3QgbGVuID0gZW5kIC0gc3RhcnQKCiAgICB0aGlzLmFuY2VzdG9ycyA9IHN0YXJ0CiAgICB0aGlzLmRpZmYgPSBkaWZmCgogICAgaWYgKChkaWZmLmluZGV4ICYgMSkgPT09IDAgfHwgdGhpcy53YW50LnN0YXJ0ID49IHRoaXMudHJlZUxlbmd0aCB8fCBsZW4gPD0gMCkgewogICAgICB0aGlzLndhbnQgPSBudWxsCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgdGhpcy53YW50LnN0YXJ0ID0gc3RhcnQKICAgIHRoaXMud2FudC5lbmQgPSBlbmQKICAgIHRoaXMud2FudC5ub2RlcyA9IGxvZzIoc3BhbnNbMV0gLSBzcGFuc1swXSArIDIpIC0gMQoKICAgIHJldHVybiBmYWxzZQogIH0KfQoKY2xhc3MgQnl0ZVNlZWtlciB7CiAgY29uc3RydWN0b3Ioc2Vzc2lvbiwgYnl0ZXMsIHBhZGRpbmcgPSAwKSB7CiAgICB0aGlzLnNlc3Npb24gPSBzZXNzaW9uCiAgICB0aGlzLmJ5dGVzID0gYnl0ZXMKICAgIHRoaXMucGFkZGluZyA9IHBhZGRpbmcKCiAgICBjb25zdCBzaXplID0gc2Vzc2lvbi5ieXRlTGVuZ3RoIC0gc2Vzc2lvbi5sZW5ndGggKiBwYWRkaW5nCgogICAgdGhpcy5zdGFydCA9IGJ5dGVzID49IHNpemUgPyBzZXNzaW9uLmxlbmd0aCA6IDAKICAgIHRoaXMuZW5kID0gYnl0ZXMgPCBzaXplID8gc2Vzc2lvbi5sZW5ndGggOiAwCiAgfQoKICBhc3luYyBfc2VlayhieXRlcykgewogICAgaWYgKCFieXRlcykgcmV0dXJuIFswLCAwXQoKICAgIGZvciAoY29uc3Qgbm9kZSBvZiB0aGlzLnNlc3Npb24ucm9vdHMpIHsKICAgICAgLy8gYWxsIGFzeW5jIHRpY2tzIGhhcHBlbiBvbmNlIHdlIGZpbmQgdGhlIHJvb3Qgc28gc2FmZQogICAgICBjb25zdCBzaXplID0gZ2V0VW5wYWRkZWRTaXplKG5vZGUsIHRoaXMucGFkZGluZywgbnVsbCkKCiAgICAgIGlmIChieXRlcyA9PT0gc2l6ZSkgcmV0dXJuIFtmbGF0LnJpZ2h0U3Bhbihub2RlLmluZGV4KSArIDIsIDBdCiAgICAgIGlmIChieXRlcyA+IHNpemUpIHsKICAgICAgICBieXRlcyAtPSBzaXplCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihub2RlLmluZGV4KQoKICAgICAgd2hpbGUgKChpdGUuaW5kZXggJiAxKSAhPT0gMCkgewogICAgICAgIGNvbnN0IGwgPSBhd2FpdCBnZXRUcmVlTm9kZUZyb21TdG9yYWdlKHRoaXMuc2Vzc2lvbi5zdG9yYWdlLCBpdGUubGVmdENoaWxkKCkpCgogICAgICAgIGlmIChsKSB7CiAgICAgICAgICBjb25zdCBzaXplID0gZ2V0VW5wYWRkZWRTaXplKGwsIHRoaXMucGFkZGluZywgaXRlKQoKICAgICAgICAgIGlmIChzaXplID09PSBieXRlcykgcmV0dXJuIFtpdGUucmlnaHRTcGFuKCkgKyAyLCAwXQogICAgICAgICAgaWYgKHNpemUgPiBieXRlcykgY29udGludWUKICAgICAgICAgIGJ5dGVzIC09IHNpemUKICAgICAgICAgIGl0ZS5zaWJsaW5nKCkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaXRlLnBhcmVudCgpCiAgICAgICAgICByZXR1cm4gW2l0ZS5pbmRleCwgYnl0ZXNdCiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gW2l0ZS5pbmRleCwgYnl0ZXNdCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIGFzeW5jIHVwZGF0ZSgpIHsKICAgIC8vIFRPRE86IGNvbWJpbmUgX3NlZWsgYW5kIHRoaXMsIG11Y2ggc2ltcGxlcgogICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5fc2Vlayh0aGlzLmJ5dGVzKQogICAgaWYgKCFyZXMpIHJldHVybiBudWxsCiAgICBpZiAoKHJlc1swXSAmIDEpID09PSAwKSByZXR1cm4gW3Jlc1swXSAvIDIsIHJlc1sxXV0KCiAgICBjb25zdCBzcGFuID0gZmxhdC5zcGFucyhyZXNbMF0pCiAgICB0aGlzLnN0YXJ0ID0gc3BhblswXSAvIDIKICAgIHRoaXMuZW5kID0gc3BhblsxXSAvIDIgKyAxCgogICAgcmV0dXJuIG51bGwKICB9Cn0KCmNsYXNzIFRyZWVQcm9vZiB7CiAgY29uc3RydWN0b3Ioc2Vzc2lvbiwgYmxvY2ssIGhhc2gsIHNlZWssIHVwZ3JhZGUpIHsKICAgIHRoaXMuZm9yayA9IHNlc3Npb24uZm9yawogICAgdGhpcy5zaWduYXR1cmUgPSBzZXNzaW9uLnNpZ25hdHVyZQoKICAgIHRoaXMuYmxvY2sgPSBibG9jawogICAgdGhpcy5oYXNoID0gaGFzaAogICAgdGhpcy5zZWVrID0gc2VlawogICAgdGhpcy51cGdyYWRlID0gdXBncmFkZQoKICAgIHRoaXMucGVuZGluZyA9IHsKICAgICAgbm9kZTogbnVsbCwKICAgICAgc2VlazogbnVsbCwKICAgICAgdXBncmFkZTogbnVsbCwKICAgICAgYWRkaXRpb25hbFVwZ3JhZGU6IG51bGwKICAgIH0KICB9CgogIGFzeW5jIHNldHRsZSgpIHsKICAgIGNvbnN0IHJlc3VsdCA9IHsKICAgICAgZm9yazogdGhpcy5mb3JrLAogICAgICBibG9jazogbnVsbCwKICAgICAgaGFzaDogbnVsbCwKICAgICAgc2VlazogbnVsbCwKICAgICAgdXBncmFkZTogbnVsbCwKICAgICAgbWFuaWZlc3Q6IG51bGwKICAgIH0KCiAgICBjb25zdCBbcE5vZGUsIHBTZWVrLCBwVXBncmFkZSwgcEFkZGl0aW9uYWxdID0gYXdhaXQgc2V0dGxlUHJvb2YodGhpcy5wZW5kaW5nKQoKICAgIGlmICh0aGlzLmJsb2NrKSB7CiAgICAgIGlmIChwTm9kZSA9PT0gbnVsbCkgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0ludmFsaWQgYmxvY2sgcmVxdWVzdCcpCiAgICAgIHJlc3VsdC5ibG9jayA9IHsKICAgICAgICBpbmRleDogdGhpcy5ibG9jay5pbmRleCwKICAgICAgICB2YWx1ZTogbnVsbCwgLy8gcG9wdWxhdGVkIHVwc3RyZWFtLCBhbGxvYyBpdCBoZXJlIGZvciBzaW1wbGljaXR5CiAgICAgICAgbm9kZXM6IHBOb2RlCiAgICAgIH0KICAgIH0gZWxzZSBpZiAodGhpcy5oYXNoKSB7CiAgICAgIGlmIChwTm9kZSA9PT0gbnVsbCkgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0ludmFsaWQgYmxvY2sgcmVxdWVzdCcpCiAgICAgIHJlc3VsdC5oYXNoID0gewogICAgICAgIGluZGV4OiB0aGlzLmhhc2guaW5kZXgsCiAgICAgICAgbm9kZXM6IHBOb2RlCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5zZWVrICYmIHBTZWVrICE9PSBudWxsKSB7CiAgICAgIHJlc3VsdC5zZWVrID0gewogICAgICAgIGJ5dGVzOiB0aGlzLnNlZWsuYnl0ZXMsCiAgICAgICAgbm9kZXM6IHBTZWVrCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy51cGdyYWRlKSB7CiAgICAgIHJlc3VsdC51cGdyYWRlID0gewogICAgICAgIHN0YXJ0OiB0aGlzLnVwZ3JhZGUuc3RhcnQsCiAgICAgICAgbGVuZ3RoOiB0aGlzLnVwZ3JhZGUubGVuZ3RoLAogICAgICAgIG5vZGVzOiBwVXBncmFkZSwKICAgICAgICBhZGRpdGlvbmFsTm9kZXM6IHBBZGRpdGlvbmFsIHx8IFtdLAogICAgICAgIHNpZ25hdHVyZTogdGhpcy5zaWduYXR1cmUKICAgICAgfQogICAgfQoKICAgIHJldHVybiByZXN1bHQKICB9Cn0KCmNsYXNzIE1lcmtsZVRyZWUgewogIHN0YXRpYyBoYXNoKHMpIHsKICAgIHJldHVybiB1bnNsYWIoY3J5cHRvLnRyZWUocy5yb290cykpCiAgfQoKICBzdGF0aWMgc2lnbmFibGUocywgbmFtZXNwYWNlKSB7CiAgICByZXR1cm4gY2Fwcy50cmVlU2lnbmFibGUobmFtZXNwYWNlLCBNZXJrbGVUcmVlLmhhc2gocyksIHMubGVuZ3RoLCBzLmZvcmspCiAgfQoKICBzdGF0aWMgc2l6ZShyb290cykgewogICAgcmV0dXJuIHRvdGFsU2l6ZShyb290cykKICB9CgogIHN0YXRpYyBzcGFuKHJvb3RzKSB7CiAgICByZXR1cm4gdG90YWxTcGFuKHJvb3RzKQogIH0KCiAgc3RhdGljIGdldFJvb3RzKHNlc3Npb24sIGxlbmd0aCkgewogICAgcmV0dXJuIE1lcmtsZVRyZWUuZ2V0Um9vdHNGcm9tU3RvcmFnZShzZXNzaW9uLnN0b3JhZ2UsIGxlbmd0aCkKICB9CgogIHN0YXRpYyBnZXRSb290c0Zyb21TdG9yYWdlKHN0b3JhZ2UsIGxlbmd0aCkgewogICAgY29uc3QgaW5kZXhlcyA9IGZsYXQuZnVsbFJvb3RzKDIgKiBsZW5ndGgpCiAgICBjb25zdCByb290cyA9IG5ldyBBcnJheShpbmRleGVzLmxlbmd0aCkKICAgIGNvbnN0IHJ4ID0gc3RvcmFnZS5yZWFkKCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZGV4ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgcm9vdHNbaV0gPSBnZXRUcmVlTm9kZU9yRXJyb3IocngsIGluZGV4ZXNbaV0pCiAgICB9CgogICAgcngudHJ5Rmx1c2goKQoKICAgIHJldHVybiBQcm9taXNlLmFsbChyb290cykKICB9CgogIHN0YXRpYyBhc3luYyB1cGdyYWRlYWJsZShzZXNzaW9uLCBsZW5ndGgpIHsKICAgIGNvbnN0IGluZGV4ZXMgPSBmbGF0LmZ1bGxSb290cygyICogbGVuZ3RoKQogICAgY29uc3Qgcm9vdHMgPSBuZXcgQXJyYXkoaW5kZXhlcy5sZW5ndGgpCiAgICBjb25zdCByeCA9IHNlc3Npb24uc3RvcmFnZS5yZWFkKCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZGV4ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgcm9vdHNbaV0gPSByeC5nZXRUcmVlTm9kZShpbmRleGVzW2ldKQogICAgfQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBmb3IgKGNvbnN0IG5vZGUgb2YgYXdhaXQgUHJvbWlzZS5hbGwocm9vdHMpKSB7CiAgICAgIGlmIChub2RlID09PSBudWxsKSByZXR1cm4gZmFsc2UKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgc3RhdGljIHNlZWsoc2Vzc2lvbiwgYnl0ZXMsIHBhZGRpbmcpIHsKICAgIHJldHVybiBuZXcgQnl0ZVNlZWtlcihzZXNzaW9uLCBieXRlcywgcGFkZGluZykKICB9CgogIHN0YXRpYyBnZXQoc2Vzc2lvbiwgaW5kZXgpIHsKICAgIHJldHVybiBnZXRUcmVlTm9kZUZyb21TdG9yYWdlKHNlc3Npb24uc3RvcmFnZSwgaW5kZXgpCiAgfQoKICBzdGF0aWMgYXN5bmMgdHJ1bmNhdGUoc2Vzc2lvbiwgbGVuZ3RoLCBiYXRjaCwgZm9yayA9IGJhdGNoLmZvcmspIHsKICAgIGNvbnN0IGhlYWQgPSBsZW5ndGggKiAyCiAgICBjb25zdCBmdWxsUm9vdHMgPSBmbGF0LmZ1bGxSb290cyhoZWFkKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZnVsbFJvb3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHJvb3QgPSBmdWxsUm9vdHNbaV0KICAgICAgaWYgKGkgPCBiYXRjaC5yb290cy5sZW5ndGggJiYgYmF0Y2gucm9vdHNbaV0uaW5kZXggPT09IHJvb3QpIGNvbnRpbnVlCgogICAgICB3aGlsZSAoYmF0Y2gucm9vdHMubGVuZ3RoID4gaSkgYmF0Y2gucm9vdHMucG9wKCkKICAgICAgYmF0Y2gucm9vdHMucHVzaCh1bnNsYWJOb2RlKGF3YWl0IGdldFRyZWVOb2RlRnJvbVN0b3JhZ2VPckVycm9yKHNlc3Npb24uc3RvcmFnZSwgcm9vdCkpKQogICAgfQoKICAgIHdoaWxlIChiYXRjaC5yb290cy5sZW5ndGggPiBmdWxsUm9vdHMubGVuZ3RoKSB7CiAgICAgIGJhdGNoLnJvb3RzLnBvcCgpCiAgICB9CgogICAgYmF0Y2guZm9yayA9IGZvcmsKICAgIGJhdGNoLmxlbmd0aCA9IGxlbmd0aAogICAgYmF0Y2guYW5jZXN0b3JzID0gbGVuZ3RoCiAgICBiYXRjaC5ieXRlTGVuZ3RoID0gdG90YWxTaXplKGJhdGNoLnJvb3RzKQogICAgYmF0Y2gudXBncmFkZWQgPSB0cnVlCgogICAgcmV0dXJuIGJhdGNoCiAgfQoKICBzdGF0aWMgYXN5bmMgcmVvcmcoc2Vzc2lvbiwgcHJvb2YsIGJhdGNoKSB7CiAgICBsZXQgdW52ZXJpZmllZCA9IG51bGwKCiAgICBpZiAocHJvb2YuYmxvY2sgfHwgcHJvb2YuaGFzaCB8fCBwcm9vZi5zZWVrKSB7CiAgICAgIHVudmVyaWZpZWQgPSB2ZXJpZnlUcmVlKHByb29mLCBiYXRjaC5ub2RlcykKICAgIH0KCiAgICBpZiAoIXZlcmlmeVVwZ3JhZGUocHJvb2YsIHVudmVyaWZpZWQsIGJhdGNoKSkgewogICAgICB0aHJvdyBJTlZBTElEX1BST09GKCdGb3JrIHByb29mIG5vdCB2ZXJpZmlhYmxlJykKICAgIH0KCiAgICBmb3IgKGNvbnN0IHJvb3Qgb2YgYmF0Y2gucm9vdHMpIHsKICAgICAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCBnZXRUcmVlTm9kZUZyb21TdG9yYWdlKHNlc3Npb24uc3RvcmFnZSwgcm9vdC5pbmRleCkKICAgICAgaWYgKGV4aXN0aW5nICYmIGI0YS5lcXVhbHMoZXhpc3RpbmcuaGFzaCwgcm9vdC5oYXNoKSkgY29udGludWUKICAgICAgYmF0Y2guX3VwZGF0ZURpZmZSb290KHJvb3QpCiAgICAgIGJyZWFrCiAgICB9CgogICAgaWYgKGJhdGNoLmRpZmYgIT09IG51bGwpIHsKICAgICAgYXdhaXQgYmF0Y2guX3VwZGF0ZShiYXRjaC5ub2RlcykKICAgIH0gZWxzZSB7CiAgICAgIGJhdGNoLndhbnQgPSBudWxsCiAgICAgIGJhdGNoLmFuY2VzdG9ycyA9IGJhdGNoLmxlbmd0aAogICAgfQoKICAgIHJldHVybiBiYXRjaAogIH0KCiAgc3RhdGljIHZlcmlmeUZ1bGx5UmVtb3RlKHNlc3Npb24sIHByb29mKSB7CiAgICAvLyBUT0RPOiBpbXBsIHRoaXMgbGVzcyBoYWNraXNobHkKICAgIGNvbnN0IGJhdGNoID0gbmV3IE1lcmtsZVRyZWVCYXRjaChzZXNzaW9uKQoKICAgIGJhdGNoLmZvcmsgPSBwcm9vZi5mb3JrCiAgICBiYXRjaC5yb290cyA9IFtdCiAgICBiYXRjaC5sZW5ndGggPSAwCiAgICBiYXRjaC5hbmNlc3RvcnMgPSAwCiAgICBiYXRjaC5ieXRlTGVuZ3RoID0gMAoKICAgIGxldCB1bnZlcmlmaWVkID0gdmVyaWZ5VHJlZShwcm9vZiwgYmF0Y2gubm9kZXMpCgogICAgaWYgKHByb29mLnVwZ3JhZGUpIHsKICAgICAgaWYgKHZlcmlmeVVwZ3JhZGUocHJvb2YsIHVudmVyaWZpZWQsIGJhdGNoKSkgewogICAgICAgIHVudmVyaWZpZWQgPSBudWxsCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYmF0Y2gKICB9CgogIHN0YXRpYyBhc3luYyB2ZXJpZnkoc2Vzc2lvbiwgcHJvb2YpIHsKICAgIGNvbnN0IGJhdGNoID0gbmV3IE1lcmtsZVRyZWVCYXRjaChzZXNzaW9uKQoKICAgIGxldCB1bnZlcmlmaWVkID0gdmVyaWZ5VHJlZShwcm9vZiwgYmF0Y2gubm9kZXMpCgogICAgaWYgKHByb29mLnVwZ3JhZGUpIHsKICAgICAgaWYgKHZlcmlmeVVwZ3JhZGUocHJvb2YsIHVudmVyaWZpZWQsIGJhdGNoKSkgewogICAgICAgIHVudmVyaWZpZWQgPSBudWxsCiAgICAgIH0KICAgIH0KCiAgICBpZiAodW52ZXJpZmllZCkgewogICAgICBjb25zdCB2ZXJpZmllZCA9IGF3YWl0IGdldFRyZWVOb2RlRnJvbVN0b3JhZ2VPckVycm9yKHNlc3Npb24uc3RvcmFnZSwgdW52ZXJpZmllZC5pbmRleCkKICAgICAgaWYgKCFiNGEuZXF1YWxzKHZlcmlmaWVkLmhhc2gsIHVudmVyaWZpZWQuaGFzaCkpIHsKICAgICAgICB0aHJvdyBJTlZBTElEX0NIRUNLU1VNKCdJbnZhbGlkIGNoZWNrc3VtIGF0IG5vZGUgJyArIHVudmVyaWZpZWQuaW5kZXgpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYmF0Y2gKICB9CgogIHN0YXRpYyBwcm9vZihzZXNzaW9uLCByeCwgeyBibG9jaywgaGFzaCwgc2VlaywgdXBncmFkZSB9KSB7CiAgICByZXR1cm4gZ2VuZXJhdGVQcm9vZihzZXNzaW9uLCByeCwgYmxvY2ssIGhhc2gsIHNlZWssIHVwZ3JhZGUpCiAgfQoKICBzdGF0aWMgbWF4TWlzc2luZ05vZGVzKGluZGV4LCBsZW5ndGgpIHsKICAgIGNvbnN0IGhlYWQgPSAyICogbGVuZ3RoCiAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKGluZGV4KQoKICAgIC8vIFNlZSBpdGVyYXRvci5yaWdodFNwYW4oKQogICAgY29uc3QgaXRlUmlnaHRTcGFuID0gaXRlLmluZGV4ICsgaXRlLmZhY3RvciAvIDIgLSAxCiAgICAvLyBJZiB0aGUgaW5kZXggaXMgbm90IGluIHRoZSBjdXJyZW50IHRyZWUsIHdlIGRvIG5vdCBrbm93IGhvdyBtYW55IG1pc3Npbmcgbm9kZXMgdGhlcmUgYXJlLi4uCiAgICBpZiAoaXRlUmlnaHRTcGFuID49IGhlYWQpIHJldHVybiAwCgogICAgZm9yIChjb25zdCByIG9mIGZsYXQuZnVsbFJvb3RzKGhlYWQpKSB7CiAgICAgIGlmIChyID09PSBpbmRleCkgcmV0dXJuIDAKICAgIH0KCiAgICBsZXQgY250ID0gMAogICAgd2hpbGUgKCFpdGUuY29udGFpbnMoaGVhZCkpIHsKICAgICAgY250KysKICAgICAgaXRlLnBhcmVudCgpCiAgICB9CgogICAgcmV0dXJuIGNudAogIH0KCiAgc3RhdGljIGFzeW5jIG1pc3NpbmdOb2RlcyhzZXNzaW9uLCBpbmRleCwgbGVuZ3RoKSB7CiAgICBjb25zdCBoZWFkID0gMiAqIGxlbmd0aAogICAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihpbmRleCkKCiAgICAvLyBTZWUgaXRlcmF0b3IucmlnaHRTcGFuKCkKICAgIGNvbnN0IGl0ZVJpZ2h0U3BhbiA9IGl0ZS5pbmRleCArIGl0ZS5mYWN0b3IgLyAyIC0gMQogICAgLy8gSWYgdGhlIGluZGV4IGlzIG5vdCBpbiB0aGUgY3VycmVudCB0cmVlLCB3ZSBkbyBub3Qga25vdyBob3cgbWFueSBtaXNzaW5nIG5vZGVzIHRoZXJlIGFyZS4uLgogICAgaWYgKGl0ZVJpZ2h0U3BhbiA+PSBoZWFkKSByZXR1cm4gMAoKICAgIGxldCBjbnQgPSAwCiAgICAvLyBUT0RPOiB3ZSBjb3VsZCBwcm9wIHVzZSBhIHJlYWQgYmF0Y2ggaGVyZSBhbmQgZG8gdGhpcyBpbiBibG9ja3Mgb2YgWCBmb3IgcGVyZgogICAgd2hpbGUgKCFpdGUuY29udGFpbnMoaGVhZCkgJiYgIShhd2FpdCBoYXNUcmVlTm9kZShzZXNzaW9uLnN0b3JhZ2UsIGl0ZS5pbmRleCkpKSB7CiAgICAgIGNudCsrCiAgICAgIGlmIChjbnQgPj0gMTAyNCkgewogICAgICAgIHRocm93IEFTU0VSVElPTignQmFkIGFyZ3VtZW50cyB0byBtaXNzaW5nTm9kZXMgaW5kZXg9JyArIGluZGV4ICsgJyBhdCBsZW5ndGg9JyArIGxlbmd0aCkKICAgICAgfQogICAgICBpdGUucGFyZW50KCkKICAgIH0KCiAgICByZXR1cm4gY250CiAgfQoKICBzdGF0aWMgYnl0ZU9mZnNldChzZXNzaW9uLCBpbmRleCkgewogICAgcmV0dXJuIGdldEJ5dGVPZmZzZXRTZXNzaW9uKHNlc3Npb24sIGluZGV4LCBudWxsKQogIH0KCiAgc3RhdGljIGJ5dGVSYW5nZShzZXNzaW9uLCBpbmRleCkgewogICAgY29uc3QgcnggPSBzZXNzaW9uLnN0b3JhZ2UucmVhZCgpCiAgICBjb25zdCBvZmZzZXQgPSBnZXRCeXRlT2Zmc2V0U2Vzc2lvbihzZXNzaW9uLCBpbmRleCwgcngpCiAgICBjb25zdCBzaXplID0gZ2V0Tm9kZVNpemUoaW5kZXgsIHJ4KQogICAgcngudHJ5Rmx1c2goKQogICAgcmV0dXJuIFByb21pc2UuYWxsKFtvZmZzZXQsIHNpemVdKQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgTWVya2xlVHJlZUJhdGNoLAogIFJlb3JnQmF0Y2gsCiAgTWVya2xlVHJlZQp9Cgphc3luYyBmdW5jdGlvbiBnZXROb2RlU2l6ZShpbmRleCwgcngpIHsKICByZXR1cm4gKGF3YWl0IGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaW5kZXgpKS5zaXplCn0KCmFzeW5jIGZ1bmN0aW9uIGdldEJ5dGVPZmZzZXRTZXNzaW9uKHNlc3Npb24sIGluZGV4LCByeCkgewogIGlmIChpbmRleCA9PT0gMiAqIHNlc3Npb24ubGVuZ3RoKSByZXR1cm4gc2Vzc2lvbi5ieXRlTGVuZ3RoCgogIGNvbnN0IHRyZWVOb2RlcyA9CiAgICByeCA9PT0gbnVsbAogICAgICA/IGF3YWl0IGdldEJ5dGVPZmZzZXRCYXRjaEZsdXNoKHNlc3Npb24ucm9vdHMsIGluZGV4LCBzZXNzaW9uLnN0b3JhZ2UucmVhZCgpKQogICAgICA6IGF3YWl0IGdldEJ5dGVPZmZzZXRCYXRjaChzZXNzaW9uLnJvb3RzLCBpbmRleCwgcngpCgogIGxldCBvZmZzZXQgPSAwCiAgZm9yIChjb25zdCBub2RlIG9mIHRyZWVOb2Rlcykgb2Zmc2V0ICs9IG5vZGUuc2l6ZQoKICByZXR1cm4gb2Zmc2V0Cn0KCmFzeW5jIGZ1bmN0aW9uIGdldEJ5dGVPZmZzZXQodHJlZSwgaW5kZXgsIHJ4KSB7CiAgaWYgKGluZGV4ID09PSAyICogdHJlZS5sZW5ndGgpIHJldHVybiB0cmVlLmJ5dGVMZW5ndGgKCiAgY29uc3QgdHJlZU5vZGVzID0gYXdhaXQgZ2V0Qnl0ZU9mZnNldEJhdGNoKHRyZWUucm9vdHMsIGluZGV4LCByeCkKCiAgbGV0IG9mZnNldCA9IDAKICBmb3IgKGNvbnN0IG5vZGUgb2YgdHJlZU5vZGVzKSBvZmZzZXQgKz0gbm9kZS5zaXplCgogIHJldHVybiBvZmZzZXQKfQoKZnVuY3Rpb24gZ2V0Qnl0ZU9mZnNldEJhdGNoRmx1c2gocm9vdHMsIGluZGV4LCByeCkgewogIGNvbnN0IHRyZWVOb2RlcyA9IGdldEJ5dGVPZmZzZXRCYXRjaChyb290cywgaW5kZXgsIHJ4KQogIHJ4LnRyeUZsdXNoKCkKICByZXR1cm4gdHJlZU5vZGVzCn0KCmZ1bmN0aW9uIGdldEJ5dGVPZmZzZXRCYXRjaChyb290cywgaW5kZXgsIHJ4KSB7CiAgaWYgKChpbmRleCAmIDEpID09PSAxKSBpbmRleCA9IGZsYXQubGVmdFNwYW4oaW5kZXgpCgogIGxldCBoZWFkID0gMAogIGxldCBjbnQgPSAwCgogIGNvbnN0IHByb21pc2VzID0gW10KCiAgZm9yIChjb25zdCBub2RlIG9mIHJvb3RzKSB7CiAgICAvLyBhbGwgYXN5bmMgdGlja3MgaGFwcGVuIG9uY2Ugd2UgZmluZCB0aGUgcm9vdCBzbyBzYWZlCiAgICBoZWFkICs9IDIgKiAobm9kZS5pbmRleCAtIGhlYWQgKyAxKQoKICAgIGlmIChpbmRleCA+PSBoZWFkKSB7CiAgICAgIHByb21pc2VzLnB1c2gobm9kZS5zaXplKQogICAgICBjb250aW51ZQogICAgfQoKICAgIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3Iobm9kZS5pbmRleCkKCiAgICB3aGlsZSAoaXRlLmluZGV4ICE9PSBpbmRleCkgewogICAgICBpZiAoKytjbnQgPj0gMTAyNCkgdGhyb3cgQVNTRVJUSU9OKCdCYWQgZ2V0Qnl0ZU9mZnNldFNlc3Npb24gaW5kZXg9JyArIGluZGV4KQoKICAgICAgaWYgKGluZGV4IDwgaXRlLmluZGV4KSB7CiAgICAgICAgaXRlLmxlZnRDaGlsZCgpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcHJvbWlzZXMucHVzaChnZXRUcmVlTm9kZU9yRXJyb3IocngsIGl0ZS5sZWZ0Q2hpbGQoKSkpCiAgICAgICAgaXRlLnNpYmxpbmcoKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKQogIH0KCiAgdGhyb3cgQVNTRVJUSU9OKCdGYWlsZWQgdG8gZmluZCBvZmZzZXQnKQp9CgpmdW5jdGlvbiBnZXRCeXRlUmFuZ2UodHJlZSwgaW5kZXgsIHJ4KSB7CiAgY29uc3QgaGVhZCA9IDIgKiB0cmVlLmxlbmd0aAogIGlmICgoKGluZGV4ICYgMSkgPT09IDAgPyBpbmRleCA6IGZsYXQucmlnaHRTcGFuKGluZGV4KSkgPj0gaGVhZCkgewogICAgdGhyb3cgQkFEX0FSR1VNRU5UKCdJbmRleCBpcyBvdXQgb2YgYm91bmRzJykKICB9CgogIGNvbnN0IG9mZnNldCA9IGdldEJ5dGVPZmZzZXQodHJlZSwgaW5kZXgsIHJ4KQogIGNvbnN0IHNpemUgPSBnZXROb2RlU2l6ZShpbmRleCwgcngpCgogIHJldHVybiBQcm9taXNlLmFsbChbb2Zmc2V0LCBzaXplXSkKfQoKLy8gQWxsIHRoZSBtZXRob2RzIG5lZWRlZCBmb3IgcHJvb2YgdmVyaWZpY2F0aW9uCgpmdW5jdGlvbiB2ZXJpZnlUcmVlKHsgYmxvY2ssIGhhc2gsIHNlZWsgfSwgbm9kZXMpIHsKICBjb25zdCB1bnRydXN0ZWROb2RlID0gYmxvY2sKICAgID8geyBpbmRleDogMiAqIGJsb2NrLmluZGV4LCB2YWx1ZTogYmxvY2sudmFsdWUsIG5vZGVzOiBibG9jay5ub2RlcyB9CiAgICA6IGhhc2gKICAgICAgPyB7IGluZGV4OiBoYXNoLmluZGV4LCB2YWx1ZTogbnVsbCwgbm9kZXM6IGhhc2gubm9kZXMgfQogICAgICA6IG51bGwKCiAgaWYgKHVudHJ1c3RlZE5vZGUgPT09IG51bGwgJiYgKCFzZWVrIHx8ICFzZWVrLm5vZGVzLmxlbmd0aCkpIHJldHVybiBudWxsCgogIGxldCByb290ID0gbnVsbAoKICBpZiAoc2VlayAmJiBzZWVrLm5vZGVzLmxlbmd0aCkgewogICAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihzZWVrLm5vZGVzWzBdLmluZGV4KQogICAgY29uc3QgcSA9IG5ldyBOb2RlUXVldWUoc2Vlay5ub2RlcykKCiAgICByb290ID0gcS5zaGlmdChpdGUuaW5kZXgpCiAgICBub2Rlcy5wdXNoKHJvb3QpCgogICAgd2hpbGUgKHEubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBub2RlID0gcS5zaGlmdChpdGUuc2libGluZygpKQoKICAgICAgcm9vdCA9IHBhcmVudE5vZGUoaXRlLnBhcmVudCgpLCByb290LCBub2RlKQogICAgICBub2Rlcy5wdXNoKG5vZGUpCiAgICAgIG5vZGVzLnB1c2gocm9vdCkKICAgIH0KICB9CgogIGlmICh1bnRydXN0ZWROb2RlID09PSBudWxsKSByZXR1cm4gcm9vdAoKICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKHVudHJ1c3RlZE5vZGUuaW5kZXgpCiAgY29uc3QgYmxvY2tIYXNoID0gdW50cnVzdGVkTm9kZS52YWx1ZSAmJiBibG9ja05vZGUoaXRlLmluZGV4LCB1bnRydXN0ZWROb2RlLnZhbHVlKQoKICBjb25zdCBxID0gbmV3IE5vZGVRdWV1ZSh1bnRydXN0ZWROb2RlLm5vZGVzLCByb290KQoKICByb290ID0gYmxvY2tIYXNoIHx8IHEuc2hpZnQoaXRlLmluZGV4KQogIG5vZGVzLnB1c2gocm9vdCkKCiAgd2hpbGUgKHEubGVuZ3RoID4gMCkgewogICAgY29uc3Qgbm9kZSA9IHEuc2hpZnQoaXRlLnNpYmxpbmcoKSkKCiAgICByb290ID0gcGFyZW50Tm9kZShpdGUucGFyZW50KCksIHJvb3QsIG5vZGUpCiAgICBub2Rlcy5wdXNoKG5vZGUpCiAgICBub2Rlcy5wdXNoKHJvb3QpCiAgfQoKICByZXR1cm4gcm9vdAp9CgpmdW5jdGlvbiB2ZXJpZnlVcGdyYWRlKHsgZm9yaywgdXBncmFkZSB9LCBibG9ja1Jvb3QsIGJhdGNoKSB7CiAgY29uc3QgcHJvbG9ndWUgPSBiYXRjaC5wcm9sb2d1ZQoKICBpZiAocHJvbG9ndWUpIHsKICAgIGNvbnN0IHsgc3RhcnQsIGxlbmd0aCB9ID0gdXBncmFkZQogICAgaWYgKHN0YXJ0IDwgcHJvbG9ndWUubGVuZ3RoICYmIChzdGFydCAhPT0gMCB8fCBsZW5ndGggPCBwcm9sb2d1ZS5sZW5ndGgpKSB7CiAgICAgIHRocm93IElOVkFMSURfUFJPT0YoJ1VwZ3JhZGUgZG9lcyBub3Qgc2F0aXNmeSBwcm9sb2d1ZScpCiAgICB9CiAgfQoKICBjb25zdCBxID0gbmV3IE5vZGVRdWV1ZSh1cGdyYWRlLm5vZGVzLCBibG9ja1Jvb3QpCgogIGxldCBncm93ID0gYmF0Y2gucm9vdHMubGVuZ3RoID4gMAogIGxldCBpID0gMAoKICBjb25zdCB0byA9IDIgKiAodXBncmFkZS5zdGFydCArIHVwZ3JhZGUubGVuZ3RoKQogIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IoMCkKCiAgZm9yICg7IGl0ZS5mdWxsUm9vdCh0byk7IGl0ZS5uZXh0VHJlZSgpKSB7CiAgICBpZiAoaSA8IGJhdGNoLnJvb3RzLmxlbmd0aCAmJiBiYXRjaC5yb290c1tpXS5pbmRleCA9PT0gaXRlLmluZGV4KSB7CiAgICAgIGkrKwogICAgICBjb250aW51ZQogICAgfQoKICAgIGlmIChncm93KSB7CiAgICAgIGdyb3cgPSBmYWxzZQogICAgICBjb25zdCByb290ID0gaXRlLmluZGV4CiAgICAgIGlmIChpIDwgYmF0Y2gucm9vdHMubGVuZ3RoKSB7CiAgICAgICAgaXRlLnNlZWsoYmF0Y2gucm9vdHNbYmF0Y2gucm9vdHMubGVuZ3RoIC0gMV0uaW5kZXgpCiAgICAgICAgd2hpbGUgKGl0ZS5pbmRleCAhPT0gcm9vdCkgewogICAgICAgICAgYmF0Y2guYXBwZW5kUm9vdChxLnNoaWZ0KGl0ZS5zaWJsaW5nKCkpLCBpdGUpCiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KICAgIH0KCiAgICBiYXRjaC5hcHBlbmRSb290KHEuc2hpZnQoaXRlLmluZGV4KSwgaXRlKQogIH0KCiAgaWYgKHByb2xvZ3VlICYmIGJhdGNoLmxlbmd0aCA9PT0gcHJvbG9ndWUubGVuZ3RoKSB7CiAgICBpZiAoIWI0YS5lcXVhbHMocHJvbG9ndWUuaGFzaCwgYmF0Y2guaGFzaCgpKSkgewogICAgICB0aHJvdyBJTlZBTElEX1BST09GKCdJbnZhbGlkIGhhc2gnKQogICAgfQogIH0KCiAgY29uc3QgZXh0cmEgPSB1cGdyYWRlLmFkZGl0aW9uYWxOb2RlcwoKICBpdGUuc2VlayhiYXRjaC5yb290c1tiYXRjaC5yb290cy5sZW5ndGggLSAxXS5pbmRleCkKICBpID0gMAoKICB3aGlsZSAoaSA8IGV4dHJhLmxlbmd0aCAmJiBleHRyYVtpXS5pbmRleCA9PT0gaXRlLnNpYmxpbmcoKSkgewogICAgYmF0Y2guYXBwZW5kUm9vdChleHRyYVtpKytdLCBpdGUpCiAgfQoKICB3aGlsZSAoaSA8IGV4dHJhLmxlbmd0aCkgewogICAgY29uc3Qgbm9kZSA9IGV4dHJhW2krK10KCiAgICB3aGlsZSAobm9kZS5pbmRleCAhPT0gaXRlLmluZGV4KSB7CiAgICAgIGlmIChpdGUuZmFjdG9yID09PSAyKSB0aHJvdyBJTlZBTElEX09QRVJBVElPTignVW5leHBlY3RlZCBub2RlOiAnICsgbm9kZS5pbmRleCkKICAgICAgaXRlLmxlZnRDaGlsZCgpCiAgICB9CgogICAgYmF0Y2guYXBwZW5kUm9vdChub2RlLCBpdGUpCiAgICBpdGUuc2libGluZygpCiAgfQoKICBiYXRjaC5zaWduYXR1cmUgPSB1bnNsYWIodXBncmFkZS5zaWduYXR1cmUpCiAgYmF0Y2guZm9yayA9IGZvcmsKCiAgcmV0dXJuIHEuZXh0cmEgPT09IG51bGwKfQoKYXN5bmMgZnVuY3Rpb24gc2Vla0Zyb21IZWFkKHNlc3Npb24sIGhlYWQsIGJ5dGVzLCBwYWRkaW5nKSB7CiAgY29uc3Qgcm9vdHMgPSBmbGF0LmZ1bGxSb290cyhoZWFkKQoKICBmb3IgKGxldCBpID0gMDsgaSA8IHJvb3RzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCByb290ID0gcm9vdHNbaV0KICAgIGNvbnN0IG5vZGUgPSBhd2FpdCBnZXRUcmVlTm9kZUZyb21TdG9yYWdlKHNlc3Npb24uc3RvcmFnZSwgcm9vdCkKICAgIGNvbnN0IHNpemUgPSBnZXRVbnBhZGRlZFNpemUobm9kZSwgcGFkZGluZywgbnVsbCkKCiAgICBpZiAoYnl0ZXMgPT09IHNpemUpIHJldHVybiByb290CiAgICBpZiAoYnl0ZXMgPiBzaXplKSB7CiAgICAgIGJ5dGVzIC09IHNpemUKICAgICAgY29udGludWUKICAgIH0KCiAgICByZXR1cm4gc2Vla1RydXN0ZWRUcmVlKHNlc3Npb24sIHJvb3QsIGJ5dGVzLCBwYWRkaW5nKQogIH0KCiAgcmV0dXJuIGhlYWQKfQoKLy8gdHJ1c3QgdGhhdCBieXRlcyBhcmUgd2l0aGluIHRoZSByb290IHRyZWUgYW5kIGZpbmQgdGhlIGJsb2NrIGF0IGJ5dGVzCgphc3luYyBmdW5jdGlvbiBzZWVrVHJ1c3RlZFRyZWUoc2Vzc2lvbiwgcm9vdCwgYnl0ZXMsIHBhZGRpbmcpIHsKICBpZiAoIWJ5dGVzKSByZXR1cm4gcm9vdAoKICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKHJvb3QpCiAgbGV0IGNudCA9IDAKCiAgd2hpbGUgKChpdGUuaW5kZXggJiAxKSAhPT0gMCkgewogICAgaWYgKCsrY250ID49IDEwMjQpIHRocm93IEFTU0VSVElPTignQmFkIHNlZWtUcnVzdGVkIGJ5dGVzPScgKyBieXRlcyArICcsIHBhZGRkaW5nPScgKyBwYWRkaW5nKQogICAgY29uc3QgbCA9IGF3YWl0IGdldFRyZWVOb2RlRnJvbVN0b3JhZ2Uoc2Vzc2lvbi5zdG9yYWdlLCBpdGUubGVmdENoaWxkKCkpCgogICAgaWYgKGwpIHsKICAgICAgY29uc3Qgc2l6ZSA9IGdldFVucGFkZGVkU2l6ZShsLCBwYWRkaW5nLCBpdGUpCiAgICAgIGlmIChzaXplID09PSBieXRlcykgcmV0dXJuIGl0ZS5pbmRleAogICAgICBpZiAoc2l6ZSA+IGJ5dGVzKSBjb250aW51ZQogICAgICBieXRlcyAtPSBzaXplCiAgICAgIGl0ZS5zaWJsaW5nKCkKICAgIH0gZWxzZSB7CiAgICAgIGl0ZS5wYXJlbnQoKQogICAgICByZXR1cm4gaXRlLmluZGV4CiAgICB9CiAgfQoKICByZXR1cm4gaXRlLmluZGV4Cn0KCi8vIHRyeSB0byBmaW5kIHRoZSBibG9jayBhdCBieXRlcyB3aXRob3V0IHRydXN0aW5nIHRoYXQgaXMgKmlzKiB3aXRoaW4gdGhlIHJvb3QgcGFzc2VkCgphc3luYyBmdW5jdGlvbiBzZWVrVW50cnVzdGVkVHJlZShzZXNzaW9uLCByb290LCBieXRlcywgcGFkZGluZykgewogIGNvbnN0IG9mZnNldCA9CiAgICAoYXdhaXQgZ2V0Qnl0ZU9mZnNldFNlc3Npb24oc2Vzc2lvbiwgcm9vdCwgbnVsbCkpIC0KICAgIChwYWRkaW5nID8gKHBhZGRpbmcgKiBmbGF0LmxlZnRTcGFuKHJvb3QpKSAvIDIgOiAwKQoKICBpZiAob2Zmc2V0ID4gYnl0ZXMpIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdJbnZhbGlkIHNlZWsnKQogIGlmIChvZmZzZXQgPT09IGJ5dGVzKSByZXR1cm4gcm9vdAoKICBieXRlcyAtPSBvZmZzZXQKCiAgY29uc3Qgbm9kZSA9IGF3YWl0IGdldFRyZWVOb2RlRnJvbVN0b3JhZ2VPckVycm9yKHNlc3Npb24uc3RvcmFnZSwgcm9vdCkKCiAgaWYgKGdldFVucGFkZGVkU2l6ZShub2RlLCBwYWRkaW5nLCBudWxsKSA8PSBieXRlcykgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0ludmFsaWQgc2VlaycpCgogIHJldHVybiBzZWVrVHJ1c3RlZFRyZWUoc2Vzc2lvbiwgcm9vdCwgYnl0ZXMsIHBhZGRpbmcpCn0KCi8vIEJlbG93IGlzIHByb29mIHByb2R1Y3Rpb24sIGllLCBjb25zdHJ1Y3QgcHJvb2ZzIHRvIHZlcmlmeSBhIHJlcXVlc3QKLy8gTm90ZSwgdGhhdCBhbGwgdGhlc2UgbWV0aG9kcyBhcmUgc3luYyBhcyB3ZSBjYW4gc3RhdGljYWxseSBpbmZlciB3aGljaCBub2RlcwovLyBhcmUgbmVlZGVkIGZvciB0aGUgcmVtb3RlIHRvIHZlcmlmeSBnaXZlbiB0aGV5IGFyZ3VtZW50cyB0aGV5IHBhc3NlZCB1cwoKZnVuY3Rpb24gc2Vla1Byb29mKHNlc3Npb24sIHJ4LCBzZWVrUm9vdCwgcm9vdCwgcCkgewogIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3Ioc2Vla1Jvb3QpCiAgbGV0IGNudCA9IDAKCiAgcC5zZWVrID0gW10KICBwLnNlZWsucHVzaChnZXRUcmVlTm9kZU9yRXJyb3IocngsIGl0ZS5pbmRleCkpCgogIHdoaWxlIChpdGUuaW5kZXggIT09IHJvb3QpIHsKICAgIGlmICgrK2NudCA+PSAxMDI0KSB0aHJvdyBBU1NFUlRJT04oJ0JhZCBzZWVrUHJvb2Ygc2Vla1Jvb3Q9JyArIHNlZWtSb290ICsgJywgcm9vdD0nICsgcm9vdCkKICAgIGl0ZS5zaWJsaW5nKCkKICAgIHAuc2Vlay5wdXNoKGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaXRlLmluZGV4KSkKICAgIGl0ZS5wYXJlbnQoKQogIH0KfQoKZnVuY3Rpb24gYmxvY2tBbmRTZWVrUHJvb2Yoc2Vzc2lvbiwgcngsIG5vZGUsIHNlZWssIHNlZWtSb290LCByb290LCBwKSB7CiAgaWYgKCFub2RlKSByZXR1cm4gc2Vla1Byb29mKHNlc3Npb24sIHJ4LCBzZWVrUm9vdCwgcm9vdCwgcCkKCiAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihub2RlLmluZGV4KQogIGxldCBjbnQgPSAwCgogIHAubm9kZSA9IFtdCiAgaWYgKCFub2RlLnZhbHVlKSBwLm5vZGUucHVzaChnZXRUcmVlTm9kZU9yRXJyb3IocngsIGl0ZS5pbmRleCkpCgogIHdoaWxlIChpdGUuaW5kZXggIT09IHJvb3QpIHsKICAgIGlmICgrK2NudCA+PSAxMDI0KSB7CiAgICAgIHRocm93IEFTU0VSVElPTignQmFkIGJsb2NrQW5kU2Vla1Byb29mIHNlZWtSb290PScgKyBzZWVrUm9vdCArICcsIHJvb3Q9JyArIHJvb3QpCiAgICB9CiAgICBpdGUuc2libGluZygpCgogICAgaWYgKHNlZWsgJiYgaXRlLmNvbnRhaW5zKHNlZWtSb290KSAmJiBpdGUuaW5kZXggIT09IHNlZWtSb290KSB7CiAgICAgIHNlZWtQcm9vZihzZXNzaW9uLCByeCwgc2Vla1Jvb3QsIGl0ZS5pbmRleCwgcCkKICAgIH0gZWxzZSB7CiAgICAgIHAubm9kZS5wdXNoKGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaXRlLmluZGV4KSkKICAgIH0KCiAgICBpdGUucGFyZW50KCkKICB9Cn0KCmZ1bmN0aW9uIHVwZ3JhZGVQcm9vZihzZXNzaW9uLCByeCwgbm9kZSwgc2VlaywgZnJvbSwgdG8sIHN1YlRyZWUsIHApIHsKICBpZiAoZnJvbSA9PT0gMCkgcC51cGdyYWRlID0gW10KCiAgZm9yIChjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKDApOyBpdGUuZnVsbFJvb3QodG8pOyBpdGUubmV4dFRyZWUoKSkgewogICAgLy8gY2hlY2sgaWYgdGhleSBhbHJlYWR5IGhhdmUgdGhlIG5vZGUKICAgIGlmIChpdGUuaW5kZXggKyBpdGUuZmFjdG9yIC8gMiA8IGZyb20pIGNvbnRpbnVlCgogICAgLy8gY29ubmVjdCBleGlzdGluZyB0cmVlCiAgICBpZiAocC51cGdyYWRlID09PSBudWxsICYmIGl0ZS5jb250YWlucyhmcm9tIC0gMikpIHsKICAgICAgcC51cGdyYWRlID0gW10KCiAgICAgIGNvbnN0IHJvb3QgPSBpdGUuaW5kZXgKICAgICAgY29uc3QgdGFyZ2V0ID0gZnJvbSAtIDIKICAgICAgbGV0IGNudCA9IDAKCiAgICAgIGl0ZS5zZWVrKHRhcmdldCkKCiAgICAgIHdoaWxlIChpdGUuaW5kZXggIT09IHJvb3QpIHsKICAgICAgICBpZiAoKytjbnQgPj0gMTAyNCkgdGhyb3cgQVNTRVJUSU9OKCdCYWQgdXBncmFkZVByb29mIHRhcmdldD0nICsgdGFyZ2V0ICsgJywgcm9vdD0nICsgcm9vdCkKCiAgICAgICAgaXRlLnNpYmxpbmcoKQogICAgICAgIGlmIChpdGUuaW5kZXggPiB0YXJnZXQpIHsKICAgICAgICAgIGlmIChwLm5vZGUgPT09IG51bGwgJiYgcC5zZWVrID09PSBudWxsICYmIGl0ZS5jb250YWlucyhzdWJUcmVlKSkgewogICAgICAgICAgICBibG9ja0FuZFNlZWtQcm9vZihzZXNzaW9uLCByeCwgbm9kZSwgc2Vlaywgc3ViVHJlZSwgaXRlLmluZGV4LCBwKQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcC51cGdyYWRlLnB1c2goZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpdGUuaW5kZXgpKQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpdGUucGFyZW50KCkKICAgICAgfQoKICAgICAgY29udGludWUKICAgIH0KCiAgICBpZiAocC51cGdyYWRlID09PSBudWxsKSB7CiAgICAgIHAudXBncmFkZSA9IFtdCiAgICB9CgogICAgLy8gaWYgdGhlIHN1YnRyZWUgaW5jbHVkZWQgaXMgYSBjaGlsZCBvZiB0aGlzIHRyZWUsIGluY2x1ZGUgdGhhdCBvbmUKICAgIC8vIGluc3RlYWQgb2YgYSBkdXAgbm9kZQogICAgaWYgKHAubm9kZSA9PT0gbnVsbCAmJiBwLnNlZWsgPT09IG51bGwgJiYgaXRlLmNvbnRhaW5zKHN1YlRyZWUpKSB7CiAgICAgIGJsb2NrQW5kU2Vla1Byb29mKHNlc3Npb24sIHJ4LCBub2RlLCBzZWVrLCBzdWJUcmVlLCBpdGUuaW5kZXgsIHApCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgLy8gYWRkIHJvb3QgKGNhbiBiZSBvcHRpbWlzZWQgc2luY2UgdGhlIHJvb3QgbWlnaHQgYmUgaW4gdHJlZS5yb290cykKICAgIHAudXBncmFkZS5wdXNoKGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaXRlLmluZGV4KSkKICB9Cn0KCmZ1bmN0aW9uIGFkZGl0aW9uYWxVcGdyYWRlUHJvb2Yoc2Vzc2lvbiwgcngsIGZyb20sIHRvLCBwKSB7CiAgaWYgKGZyb20gPT09IDApIHAuYWRkaXRpb25hbFVwZ3JhZGUgPSBbXQoKICBmb3IgKGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IoMCk7IGl0ZS5mdWxsUm9vdCh0byk7IGl0ZS5uZXh0VHJlZSgpKSB7CiAgICAvLyBjaGVjayBpZiB0aGV5IGFscmVhZHkgaGF2ZSB0aGUgbm9kZQogICAgaWYgKGl0ZS5pbmRleCArIGl0ZS5mYWN0b3IgLyAyIDwgZnJvbSkgY29udGludWUKCiAgICAvLyBjb25uZWN0IGV4aXN0aW5nIHRyZWUKICAgIGlmIChwLmFkZGl0aW9uYWxVcGdyYWRlID09PSBudWxsICYmIGl0ZS5jb250YWlucyhmcm9tIC0gMikpIHsKICAgICAgcC5hZGRpdGlvbmFsVXBncmFkZSA9IFtdCgogICAgICBjb25zdCByb290ID0gaXRlLmluZGV4CiAgICAgIGNvbnN0IHRhcmdldCA9IGZyb20gLSAyCiAgICAgIGxldCBjbnQgPSAwCgogICAgICBpdGUuc2Vlayh0YXJnZXQpCgogICAgICB3aGlsZSAoaXRlLmluZGV4ICE9PSByb290KSB7CiAgICAgICAgaWYgKCsrY250ID49IDEwMjQpIHsKICAgICAgICAgIHRocm93IEFTU0VSVElPTigKICAgICAgICAgICAgJ0JhZCBhcmd1bWVudHMgdG8gYWRkaXRpb25hbFVwZ3JhZGVQcm9vZiByb290PScgKyByb290ICsgJyB0YXJnZXQ9JyArIHRhcmdldAogICAgICAgICAgKQogICAgICAgIH0KICAgICAgICBpdGUuc2libGluZygpCiAgICAgICAgaWYgKGl0ZS5pbmRleCA+IHRhcmdldCkgewogICAgICAgICAgcC5hZGRpdGlvbmFsVXBncmFkZS5wdXNoKGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaXRlLmluZGV4KSkKICAgICAgICB9CiAgICAgICAgaXRlLnBhcmVudCgpCiAgICAgIH0KCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgaWYgKHAuYWRkaXRpb25hbFVwZ3JhZGUgPT09IG51bGwpIHsKICAgICAgcC5hZGRpdGlvbmFsVXBncmFkZSA9IFtdCiAgICB9CgogICAgLy8gYWRkIHJvb3QgKGNhbiBiZSBvcHRpbWlzZWQgc2luY2UgdGhlIHJvb3QgaXMgaW4gdHJlZS5yb290cykKICAgIHAuYWRkaXRpb25hbFVwZ3JhZGUucHVzaChnZXRUcmVlTm9kZU9yRXJyb3IocngsIGl0ZS5pbmRleCkpCiAgfQp9CgpmdW5jdGlvbiBub2Rlc1RvUm9vdChpbmRleCwgbm9kZXMsIGhlYWQpIHsKICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKGluZGV4KQoKICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGVzOyBpKyspIHsKICAgIGl0ZS5wYXJlbnQoKQogICAgaWYgKGl0ZS5jb250YWlucyhoZWFkKSkgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ05vZGVzIGlzIG91dCBvZiBib3VuZHMnKQogIH0KCiAgcmV0dXJuIGl0ZS5pbmRleAp9CgpmdW5jdGlvbiB0b3RhbFNpemUobm9kZXMpIHsKICBsZXQgcyA9IDAKICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIHMgKz0gbm9kZS5zaXplCiAgcmV0dXJuIHMKfQoKZnVuY3Rpb24gdG90YWxTcGFuKG5vZGVzKSB7CiAgbGV0IHMgPSAwCiAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSBzICs9IDIgKiAobm9kZS5pbmRleCAtIHMgKyAxKQogIHJldHVybiBzCn0KCmZ1bmN0aW9uIGJsb2NrTm9kZShpbmRleCwgdmFsdWUpIHsKICByZXR1cm4geyBpbmRleCwgc2l6ZTogdmFsdWUuYnl0ZUxlbmd0aCwgaGFzaDogY3J5cHRvLmRhdGEodmFsdWUpIH0KfQoKZnVuY3Rpb24gcGFyZW50Tm9kZShpbmRleCwgYSwgYikgewogIHJldHVybiB7IGluZGV4LCBzaXplOiBhLnNpemUgKyBiLnNpemUsIGhhc2g6IGNyeXB0by5wYXJlbnQoYSwgYikgfQp9CgpmdW5jdGlvbiBsb2cyKG4pIHsKICBsZXQgcmVzID0gMQoKICB3aGlsZSAobiA+IDIpIHsKICAgIG4gLz0gMgogICAgcmVzKysKICB9CgogIHJldHVybiByZXMKfQoKZnVuY3Rpb24gbm9ybWFsaXplSW5kZXhlZChibG9jaywgaGFzaCkgewogIGlmIChibG9jaykgewogICAgcmV0dXJuIHsKICAgICAgdmFsdWU6IHRydWUsCiAgICAgIGluZGV4OiBibG9jay5pbmRleCAqIDIsCiAgICAgIG5vZGVzOiBibG9jay5ub2RlcywKICAgICAgbGFzdEluZGV4OiBibG9jay5pbmRleAogICAgfQogIH0KICBpZiAoaGFzaCkgewogICAgcmV0dXJuIHsKICAgICAgdmFsdWU6IGZhbHNlLAogICAgICBpbmRleDogaGFzaC5pbmRleCwKICAgICAgbm9kZXM6IGhhc2gubm9kZXMsCiAgICAgIGxhc3RJbmRleDogZmxhdC5yaWdodFNwYW4oaGFzaC5pbmRleCkgLyAyCiAgICB9CiAgfQogIHJldHVybiBudWxsCn0KCmFzeW5jIGZ1bmN0aW9uIGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaW5kZXgpIHsKICBjb25zdCBub2RlID0gYXdhaXQgcnguZ2V0VHJlZU5vZGUoaW5kZXgpCiAgaWYgKG5vZGUgPT09IG51bGwpIHsKICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdFeHBlY3RlZCB0cmVlIG5vZGUgJyArIGluZGV4ICsgJyBmcm9tIHN0b3JhZ2UsIGdvdCAobmlsKScpCiAgfQogIHJldHVybiBub2RlCn0KCmZ1bmN0aW9uIGdldFRyZWVOb2RlRnJvbVN0b3JhZ2VPckVycm9yKHN0b3JhZ2UsIGluZGV4KSB7CiAgY29uc3QgcnggPSBzdG9yYWdlLnJlYWQoKQogIGNvbnN0IHAgPSBnZXRUcmVlTm9kZU9yRXJyb3IocngsIGluZGV4KQogIHJ4LnRyeUZsdXNoKCkKICByZXR1cm4gcAp9CgpmdW5jdGlvbiBnZXRUcmVlTm9kZUZyb21TdG9yYWdlKHN0b3JhZ2UsIGluZGV4KSB7CiAgY29uc3QgcnggPSBzdG9yYWdlLnJlYWQoKQogIGNvbnN0IG5vZGUgPSByeC5nZXRUcmVlTm9kZShpbmRleCkKICByeC50cnlGbHVzaCgpCiAgcmV0dXJuIG5vZGUKfQoKZnVuY3Rpb24gaGFzVHJlZU5vZGUoc3RvcmFnZSwgaW5kZXgpIHsKICBjb25zdCByeCA9IHN0b3JhZ2UucmVhZCgpCiAgY29uc3QgaGFzID0gcnguaGFzVHJlZU5vZGUoaW5kZXgpCiAgcngudHJ5Rmx1c2goKQogIHJldHVybiBoYXMKfQoKYXN5bmMgZnVuY3Rpb24gc2V0dGxlUHJvb2YocCkgewogIGNvbnN0IHJlc3VsdCA9IFsKICAgIHAubm9kZSAmJiBQcm9taXNlLmFsbChwLm5vZGUpLAogICAgcC5zZWVrICYmIFByb21pc2UuYWxsKHAuc2VlayksCiAgICBwLnVwZ3JhZGUgJiYgUHJvbWlzZS5hbGwocC51cGdyYWRlKSwKICAgIHAuYWRkaXRpb25hbFVwZ3JhZGUgJiYgUHJvbWlzZS5hbGwocC5hZGRpdGlvbmFsVXBncmFkZSkKICBdCgogIHRyeSB7CiAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5hbGwocmVzdWx0KQogIH0gY2F0Y2ggKGVycikgewogICAgaWYgKHAubm9kZSkgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHAubm9kZSkKICAgIGlmIChwLnNlZWspIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChwLnNlZWspCiAgICBpZiAocC51cGdyYWRlKSBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQocC51cGdyYWRlKQogICAgaWYgKHAuYWRkaXRpb25hbFVwZ3JhZGUpIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChwLmFkZGl0aW9uYWxVcGdyYWRlKQogICAgdGhyb3cgZXJyCiAgfQp9CgovLyB0cmVlIGNhbiBiZSBlaXRoZXIgdGhlIG1lcmtsZSB0cmVlIG9yIGEgbWVya2xlIHRyZWUgYmF0Y2gKYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVQcm9vZihzZXNzaW9uLCByeCwgYmxvY2ssIGhhc2gsIHNlZWssIHVwZ3JhZGUpIHsKICAvLyBJbXBvcnRhbnQgdGhhdCB0aGlzIGRvZXMgbm90IHRocm93IGluYmV0d2VlbiBtYWtpbmcgdGhlIHByb21pc2UgYXJyYXlzCiAgLy8gYW5kIGZpbmFsaXNlIGJlaW5nIGNhbGxlZCwgb3RoZXJ3aXNlIHRoZXJlIHdpbGwgYmUgbGluZ2VyaW5nIHByb21pc2VzIGluIHRoZSBiYWNrZ3JvdW5kCgogIGlmIChzZXNzaW9uLnByb2xvZ3VlICYmIHVwZ3JhZGUpIHsKICAgIHVwZ3JhZGUuc3RhcnQgPSB1cGdyYWRlLnN0YXJ0IDwgc2Vzc2lvbi5wcm9sb2d1ZS5sZW5ndGggPyAwIDogdXBncmFkZS5zdGFydAogICAgdXBncmFkZS5sZW5ndGggPQogICAgICB1cGdyYWRlLnN0YXJ0IDwgc2Vzc2lvbi5wcm9sb2d1ZS5sZW5ndGggPyBzZXNzaW9uLnByb2xvZ3VlLmxlbmd0aCA6IHVwZ3JhZGUubGVuZ3RoCiAgfQoKICBjb25zdCBoZWFkID0gMiAqIHNlc3Npb24ubGVuZ3RoCiAgY29uc3QgZnJvbSA9IHVwZ3JhZGUgPyB1cGdyYWRlLnN0YXJ0ICogMiA6IDAKICBjb25zdCB0byA9IHVwZ3JhZGUgPyBmcm9tICsgdXBncmFkZS5sZW5ndGggKiAyIDogaGVhZAogIGNvbnN0IG5vZGUgPSBub3JtYWxpemVJbmRleGVkKGJsb2NrLCBoYXNoKQoKICAvLyBjYW4ndCBkbyBhbnl0aGluZyBhcyB3ZSBoYXZlIG5vIGRhdGEuLi4KICBpZiAoaGVhZCA9PT0gMCkgcmV0dXJuIG5ldyBUcmVlUHJvb2Yoc2Vzc2lvbiwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCkKCiAgaWYgKGZyb20gPj0gdG8gfHwgdG8gPiBoZWFkKSB7CiAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTignSW52YWxpZCB1cGdyYWRlJykKICB9CiAgaWYgKHNlZWsgJiYgdXBncmFkZSAmJiBub2RlICE9PSBudWxsICYmIG5vZGUuaW5kZXggPj0gZnJvbSkgewogICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0Nhbm5vdCBib3RoIGRvIGEgc2VlayBhbmQgYmxvY2svaGFzaCByZXF1ZXN0IHdoZW4gdXBncmFkaW5nJykKICB9CgogIGxldCBzdWJUcmVlID0gaGVhZAoKICBjb25zdCBwID0gbmV3IFRyZWVQcm9vZihzZXNzaW9uLCBibG9jaywgaGFzaCwgc2VlaywgdXBncmFkZSkKCiAgaWYgKG5vZGUgIT09IG51bGwgJiYgKCF1cGdyYWRlIHx8IG5vZGUubGFzdEluZGV4IDwgdXBncmFkZS5zdGFydCkpIHsKICAgIHN1YlRyZWUgPSBub2Rlc1RvUm9vdChub2RlLmluZGV4LCBub2RlLm5vZGVzLCB0bykKICAgIGNvbnN0IHNlZWtSb290ID0gc2VlawogICAgICA/IGF3YWl0IHNlZWtVbnRydXN0ZWRUcmVlKHNlc3Npb24sIHN1YlRyZWUsIHNlZWsuYnl0ZXMsIHNlZWsucGFkZGluZykKICAgICAgOiBoZWFkCiAgICBibG9ja0FuZFNlZWtQcm9vZihzZXNzaW9uLCByeCwgbm9kZSwgc2Vlaywgc2Vla1Jvb3QsIHN1YlRyZWUsIHAucGVuZGluZykKICB9IGVsc2UgaWYgKChub2RlIHx8IHNlZWspICYmIHVwZ3JhZGUpIHsKICAgIHN1YlRyZWUgPSBzZWVrID8gYXdhaXQgc2Vla0Zyb21IZWFkKHNlc3Npb24sIHRvLCBzZWVrLmJ5dGVzLCBzZWVrLnBhZGRpbmcpIDogbm9kZS5pbmRleAogIH0KCiAgaWYgKHVwZ3JhZGUpIHsKICAgIHVwZ3JhZGVQcm9vZihzZXNzaW9uLCByeCwgbm9kZSwgc2VlaywgZnJvbSwgdG8sIHN1YlRyZWUsIHAucGVuZGluZykKICAgIGlmIChoZWFkID4gdG8pIGFkZGl0aW9uYWxVcGdyYWRlUHJvb2Yoc2Vzc2lvbiwgcngsIHRvLCBoZWFkLCBwLnBlbmRpbmcpCiAgfQoKICByZXR1cm4gcAp9CgpmdW5jdGlvbiBnZXRVbnBhZGRlZFNpemUobm9kZSwgcGFkZGluZywgaXRlKSB7CiAgcmV0dXJuIHBhZGRpbmcgPT09IDAKICAgID8gbm9kZS5zaXplCiAgICA6IG5vZGUuc2l6ZSAtIHBhZGRpbmcgKiAoaXRlID8gaXRlLmNvdW50TGVhdmVzKCkgOiBmbGF0LmNvdW50TGVhdmVzKG5vZGUuaW5kZXgpKQp9CgpmdW5jdGlvbiB1bnNsYWJOb2Rlcyhub2RlcykgewogIGZvciAoY29uc3Qgbm9kZSBvZiBub2RlcykgdW5zbGFiTm9kZShub2RlKQogIHJldHVybiBub2Rlcwp9CgpmdW5jdGlvbiB1bnNsYWJOb2RlKG5vZGUpIHsKICBpZiAobm9kZSA9PT0gbnVsbCkgcmV0dXJuIG5vZGUKICBub2RlLmhhc2ggPSB1bnNsYWIobm9kZS5oYXNoKQogIHJldHVybiBub2RlCn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCB7IERFRkFVTFRfTkFNRVNQQUNFIH0gPSByZXF1aXJlKCcuL2NhcHMnKQpjb25zdCB7IElOVkFMSURfT1BMT0dfVkVSU0lPTiB9ID0gcmVxdWlyZSgnaHlwZXJjb3JlLWVycm9ycycpCmNvbnN0IHVuc2xhYiA9IHJlcXVpcmUoJ3Vuc2xhYicpCgpjb25zdCBFTVBUWSA9IGI0YS5hbGxvYygwKQoKY29uc3QgTUFOSUZFU1RfUEFUQ0ggPSAwYjAwMDAwMDAxCmNvbnN0IE1BTklGRVNUX1BST0xPR1VFID0gMGIwMDAwMDAxMApjb25zdCBNQU5JRkVTVF9MSU5LRUQgPSAwYjAwMDAwMTAwCmNvbnN0IE1BTklGRVNUX1VTRVJfREFUQSA9IDBiMDAwMDEwMDAKCmNvbnN0IGhhc2hlcyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIHNtYWxsIHVpbnQKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgaWYgKG0gPT09ICdibGFrZTJiJykgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAwKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gaGFzaDogJyArIG0pCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IG4gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgaWYgKG4gPT09IDApIHJldHVybiAnYmxha2UyYicKICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBoYXNoIGlkOiAnICsgbikKICB9Cn0KCmNvbnN0IHNpZ25hdHVyZXMgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBzbWFsbCB1aW50CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGlmIChtID09PSAnZWQyNTUxOScpIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHNpZ25hdHVyZTogJyArIG0pCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IG4gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgaWYgKG4gPT09IDApIHJldHVybiAnZWQyNTUxOScKICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBzaWduYXR1cmUgaWQ6ICcgKyBuKQogIH0KfQoKY29uc3Qgc2lnbmVyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc2lnbmF0dXJlcy5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgc2lnbmF0dXJlcy5lbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc2lnbmF0dXJlOiBzaWduYXR1cmVzLmRlY29kZShzdGF0ZSksCiAgICAgIG5hbWVzcGFjZTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIHB1YmxpY0tleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHNpZ25lckFycmF5ID0gYy5hcnJheShzaWduZXIpCgpjb25zdCBwcm9sb2d1ZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHApIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIHAuaGFzaCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHAubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBwKSB7CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBwLmhhc2gpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBwLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaGFzaDogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IG1hbmlmZXN0djAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBoYXNoZXMucHJlZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBzdGF0ZS5lbmQrKyAvLyB0eXBlCgogICAgaWYgKG0ucHJvbG9ndWUgJiYgbS5zaWduZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlLmhhc2gpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChtLnF1b3J1bSA9PT0gMSAmJiBtLnNpZ25lcnMubGVuZ3RoID09PSAxICYmICFtLmFsbG93UGF0Y2gpIHsKICAgICAgc2lnbmVyLnByZWVuY29kZShzdGF0ZSwgbS5zaWduZXJzWzBdKQogICAgfSBlbHNlIHsKICAgICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5xdW9ydW0pCiAgICAgIHNpZ25lckFycmF5LnByZWVuY29kZShzdGF0ZSwgbS5zaWduZXJzKQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBoYXNoZXMuZW5jb2RlKHN0YXRlLCBtLmhhc2gpCgogICAgaWYgKG0ucHJvbG9ndWUgJiYgbS5zaWduZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAwKQogICAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlLmhhc2gpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChtLnF1b3J1bSA9PT0gMSAmJiBtLnNpZ25lcnMubGVuZ3RoID09PSAxICYmICFtLmFsbG93UGF0Y2gpIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMSkKICAgICAgc2lnbmVyLmVuY29kZShzdGF0ZSwgbS5zaWduZXJzWzBdKQogICAgfSBlbHNlIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMikKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5hbGxvd1BhdGNoID8gMSA6IDApCiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucXVvcnVtKQogICAgICBzaWduZXJBcnJheS5lbmNvZGUoc3RhdGUsIG0uc2lnbmVycykKICAgIH0KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgaGFzaCA9IGhhc2hlcy5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCB0eXBlID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAodHlwZSA+IDIpIHRocm93IG5ldyBFcnJvcignVW5rbm93biB0eXBlOiAnICsgdHlwZSkKCiAgICBpZiAodHlwZSA9PT0gMCkgewogICAgICByZXR1cm4gewogICAgICAgIHZlcnNpb246IDAsCiAgICAgICAgaGFzaCwKICAgICAgICBhbGxvd1BhdGNoOiBmYWxzZSwKICAgICAgICBxdW9ydW06IDAsCiAgICAgICAgc2lnbmVyczogW10sCiAgICAgICAgcHJvbG9ndWU6IHsKICAgICAgICAgIGhhc2g6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICAgICAgbGVuZ3RoOiAwCiAgICAgICAgfSwKICAgICAgICBsaW5rZWQ6IG51bGwsCiAgICAgICAgdXNlckRhdGE6IG51bGwKICAgICAgfQogICAgfQoKICAgIGlmICh0eXBlID09PSAxKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmVyc2lvbjogMCwKICAgICAgICBoYXNoLAogICAgICAgIGFsbG93UGF0Y2g6IGZhbHNlLAogICAgICAgIHF1b3J1bTogMSwKICAgICAgICBzaWduZXJzOiBbc2lnbmVyLmRlY29kZShzdGF0ZSldLAogICAgICAgIHByb2xvZ3VlOiBudWxsLAogICAgICAgIGxpbmtlZDogbnVsbCwKICAgICAgICB1c2VyRGF0YTogbnVsbAogICAgICB9CiAgICB9CgogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IDAsCiAgICAgIGhhc2gsCiAgICAgIGFsbG93UGF0Y2g6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBxdW9ydW06IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduZXJzOiBzaWduZXJBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICBwcm9sb2d1ZTogbnVsbCwKICAgICAgbGlua2VkOiBudWxsLAogICAgICB1c2VyRGF0YTogbnVsbAogICAgfQogIH0KfQoKY29uc3QgZml4ZWQzMkFycmF5ID0gYy5hcnJheShjLmZpeGVkMzIpCgpjb25zdCBtYW5pZmVzdCA9IChleHBvcnRzLm1hbmlmZXN0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gdmVyc2lvbgoKICAgIGlmIChtLnZlcnNpb24gPT09IDApIHJldHVybiBtYW5pZmVzdHYwLnByZWVuY29kZShzdGF0ZSwgbSkKCiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgaGFzaGVzLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQoKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucXVvcnVtKQogICAgc2lnbmVyQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCgogICAgaWYgKG0ucHJvbG9ndWUpIHByb2xvZ3VlLnByZWVuY29kZShzdGF0ZSwgbS5wcm9sb2d1ZSkKICAgIGlmIChtLmxpbmtlZCkgZml4ZWQzMkFycmF5LnByZWVuY29kZShzdGF0ZSwgbS5saW5rZWQpCiAgICBpZiAobS51c2VyRGF0YSkgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnVzZXJEYXRhKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCgogICAgaWYgKG0udmVyc2lvbiA9PT0gMCkgcmV0dXJuIG1hbmlmZXN0djAuZW5jb2RlKHN0YXRlLCBtKQoKICAgIGxldCBmbGFncyA9IDAKICAgIGlmIChtLmFsbG93UGF0Y2gpIGZsYWdzIHw9IE1BTklGRVNUX1BBVENICiAgICBpZiAobS5wcm9sb2d1ZSkgZmxhZ3MgfD0gTUFOSUZFU1RfUFJPTE9HVUUKICAgIGlmIChtLmxpbmtlZCkgZmxhZ3MgfD0gTUFOSUZFU1RfTElOS0VECiAgICBpZiAobS51c2VyRGF0YSkgZmxhZ3MgfD0gTUFOSUZFU1RfVVNFUl9EQVRBCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBoYXNoZXMuZW5jb2RlKHN0YXRlLCBtLmhhc2gpCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5xdW9ydW0pCiAgICBzaWduZXJBcnJheS5lbmNvZGUoc3RhdGUsIG0uc2lnbmVycykKCiAgICBpZiAobS5wcm9sb2d1ZSkgcHJvbG9ndWUuZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlKQogICAgaWYgKG0ubGlua2VkKSBmaXhlZDMyQXJyYXkuZW5jb2RlKHN0YXRlLCBtLmxpbmtlZCkKICAgIGlmIChtLnVzZXJEYXRhKSBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0udXNlckRhdGEpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmICh2ZXJzaW9uID09PSAwKSByZXR1cm4gbWFuaWZlc3R2MC5kZWNvZGUoc3RhdGUpCiAgICBpZiAodmVyc2lvbiA+IDIpIHRocm93IG5ldyBFcnJvcignVW5rbm93biB2ZXJzaW9uOiAnICsgdmVyc2lvbikKCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBoYXNoID0gaGFzaGVzLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHF1b3J1bSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBzaWduZXJzID0gc2lnbmVyQXJyYXkuZGVjb2RlKHN0YXRlKQoKICAgIGNvbnN0IGhhc1BhdGNoID0gKGZsYWdzICYgTUFOSUZFU1RfUEFUQ0gpICE9PSAwCiAgICBjb25zdCBoYXNQcm9sb2d1ZSA9IChmbGFncyAmIE1BTklGRVNUX1BST0xPR1VFKSAhPT0gMAogICAgY29uc3QgaGFzTGlua2VkID0gKGZsYWdzICYgTUFOSUZFU1RfTElOS0VEKSAhPT0gMAogICAgY29uc3QgaGFzVXNlckRhdGEgPSAoZmxhZ3MgJiBNQU5JRkVTVF9VU0VSX0RBVEEpICE9PSAwCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbiwKICAgICAgaGFzaCwKICAgICAgYWxsb3dQYXRjaDogaGFzUGF0Y2gsCiAgICAgIHF1b3J1bSwKICAgICAgc2lnbmVycywKICAgICAgcHJvbG9ndWU6IGhhc1Byb2xvZ3VlID8gcHJvbG9ndWUuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGxpbmtlZDogaGFzTGlua2VkID8gZml4ZWQzMkFycmF5LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB1c2VyRGF0YTogaGFzVXNlckRhdGEgPyBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfSkKCmNvbnN0IG5vZGUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLmluZGV4KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5zaXplKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbi5oYXNoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLmluZGV4KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5zaXplKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbi5oYXNoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpbmRleDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpemU6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBoYXNoOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qgbm9kZUFycmF5ID0gYy5hcnJheShub2RlKQoKY29uc3Qgd2lyZSA9IChleHBvcnRzLndpcmUgPSB7fSkKCndpcmUuaGFuZHNoYWtlID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgMSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0uY2FwYWJpbGl0eSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zZWVrcyA/IDEgOiAwKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5jYXBhYmlsaXR5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBzZWVrczogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIGNhcGFiaWxpdHk6IHVuc2xhYihjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlcXVlc3RCbG9jayA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBub2RlczogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlcXVlc3RTZWVrID0gewogIHByZWVuY29kZShzdGF0ZSwgcykgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgcy5ieXRlcykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHMucGFkZGluZykKICB9LAogIGVuY29kZShzdGF0ZSwgcykgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgcy5ieXRlcykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHMucGFkZGluZykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgYnl0ZXM6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBwYWRkaW5nOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVxdWVzdFVwZ3JhZGUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1LnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHUpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUuc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLnJlcXVlc3QgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZm9yaykKCiAgICBpZiAobS5ibG9jaykgcmVxdWVzdEJsb2NrLnByZWVuY29kZShzdGF0ZSwgbS5ibG9jaykKICAgIGlmIChtLmhhc2gpIHJlcXVlc3RCbG9jay5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGlmIChtLnNlZWspIHJlcXVlc3RTZWVrLnByZWVuY29kZShzdGF0ZSwgbS5zZWVrKQogICAgaWYgKG0udXBncmFkZSkgcmVxdWVzdFVwZ3JhZGUucHJlZW5jb2RlKHN0YXRlLCBtLnVwZ3JhZGUpCiAgICBpZiAobS5wcmlvcml0eSkgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5wcmlvcml0eSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPQogICAgICAobS5ibG9jayA/IDEgOiAwKSB8CiAgICAgIChtLmhhc2ggPyAyIDogMCkgfAogICAgICAobS5zZWVrID8gNCA6IDApIHwKICAgICAgKG0udXBncmFkZSA/IDggOiAwKSB8CiAgICAgIChtLm1hbmlmZXN0ID8gMTYgOiAwKSB8CiAgICAgIChtLnByaW9yaXR5ID8gMzIgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZm9yaykKCiAgICBpZiAobS5ibG9jaykgcmVxdWVzdEJsb2NrLmVuY29kZShzdGF0ZSwgbS5ibG9jaykKICAgIGlmIChtLmhhc2gpIHJlcXVlc3RCbG9jay5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGlmIChtLnNlZWspIHJlcXVlc3RTZWVrLmVuY29kZShzdGF0ZSwgbS5zZWVrKQogICAgaWYgKG0udXBncmFkZSkgcmVxdWVzdFVwZ3JhZGUuZW5jb2RlKHN0YXRlLCBtLnVwZ3JhZGUpCiAgICBpZiAobS5wcmlvcml0eSkgYy51aW50LmVuY29kZShzdGF0ZSwgbS5wcmlvcml0eSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGlkOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgZm9yazogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGJsb2NrOiBmbGFncyAmIDEgPyByZXF1ZXN0QmxvY2suZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGhhc2g6IGZsYWdzICYgMiA/IHJlcXVlc3RCbG9jay5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgc2VlazogZmxhZ3MgJiA0ID8gcmVxdWVzdFNlZWsuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHVwZ3JhZGU6IGZsYWdzICYgOCA/IHJlcXVlc3RVcGdyYWRlLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBtYW5pZmVzdDogKGZsYWdzICYgMTYpICE9PSAwLAogICAgICBwcmlvcml0eTogZmxhZ3MgJiAzMiA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgfQogIH0KfQoKd2lyZS5jYW5jZWwgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICB9LAogIGRlY29kZShzdGF0ZSwgbSkgewogICAgcmV0dXJuIHsKICAgICAgcmVxdWVzdDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGRhdGFVcGdyYWRlID0gewogIHByZWVuY29kZShzdGF0ZSwgdSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogICAgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgdS5ub2RlcykKICAgIG5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIHUuYWRkaXRpb25hbE5vZGVzKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCB1LnNpZ25hdHVyZSkKICB9LAogIGVuY29kZShzdGF0ZSwgdSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgdS5ub2RlcykKICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIHUuYWRkaXRpb25hbE5vZGVzKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB1LnNpZ25hdHVyZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBub2Rlczogbm9kZUFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIGFkZGl0aW9uYWxOb2Rlczogbm9kZUFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25hdHVyZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgZGF0YVNlZWsgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBzKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBzLmJ5dGVzKQogICAgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgcy5ub2RlcykKICB9LAogIGVuY29kZShzdGF0ZSwgcykgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgcy5ieXRlcykKICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIHMubm9kZXMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGJ5dGVzOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbm9kZXM6IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBkYXRhQmxvY2sgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBiLnZhbHVlKQogICAgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgYi52YWx1ZSkKICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGluZGV4OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgdmFsdWU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkgfHwgRU1QVFksCiAgICAgIG5vZGVzOiBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgZGF0YUhhc2ggPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGluZGV4OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbm9kZXM6IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLmRhdGEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZXF1ZXN0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5mb3JrKQoKICAgIGlmIChtLmJsb2NrKSBkYXRhQmxvY2sucHJlZW5jb2RlKHN0YXRlLCBtLmJsb2NrKQogICAgaWYgKG0uaGFzaCkgZGF0YUhhc2gucHJlZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBpZiAobS5zZWVrKSBkYXRhU2Vlay5wcmVlbmNvZGUoc3RhdGUsIG0uc2VlaykKICAgIGlmIChtLnVwZ3JhZGUpIGRhdGFVcGdyYWRlLnByZWVuY29kZShzdGF0ZSwgbS51cGdyYWRlKQogICAgaWYgKG0ubWFuaWZlc3QpIG1hbmlmZXN0LnByZWVuY29kZShzdGF0ZSwgbS5tYW5pZmVzdCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPQogICAgICAobS5ibG9jayA/IDEgOiAwKSB8CiAgICAgIChtLmhhc2ggPyAyIDogMCkgfAogICAgICAobS5zZWVrID8gNCA6IDApIHwKICAgICAgKG0udXBncmFkZSA/IDggOiAwKSB8CiAgICAgIChtLm1hbmlmZXN0ID8gMTYgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZXF1ZXN0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5mb3JrKQoKICAgIGlmIChtLmJsb2NrKSBkYXRhQmxvY2suZW5jb2RlKHN0YXRlLCBtLmJsb2NrKQogICAgaWYgKG0uaGFzaCkgZGF0YUhhc2guZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBpZiAobS5zZWVrKSBkYXRhU2Vlay5lbmNvZGUoc3RhdGUsIG0uc2VlaykKICAgIGlmIChtLnVwZ3JhZGUpIGRhdGFVcGdyYWRlLmVuY29kZShzdGF0ZSwgbS51cGdyYWRlKQogICAgaWYgKG0ubWFuaWZlc3QpIG1hbmlmZXN0LmVuY29kZShzdGF0ZSwgbS5tYW5pZmVzdCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHJlcXVlc3Q6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBmb3JrOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYmxvY2s6IGZsYWdzICYgMSA/IGRhdGFCbG9jay5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgaGFzaDogZmxhZ3MgJiAyID8gZGF0YUhhc2guZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHNlZWs6IGZsYWdzICYgNCA/IGRhdGFTZWVrLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB1cGdyYWRlOiBmbGFncyAmIDggPyBkYXRhVXBncmFkZS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgbWFuaWZlc3Q6IGZsYWdzICYgMTYgPyBtYW5pZmVzdC5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKd2lyZS5ub0RhdGEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnJlYXNvbiA/IDEgOiAwKQogICAgaWYgKG0ucmVhc29uKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnJlYXNvbikKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZXF1ZXN0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZWFzb24gPyAxIDogMCkKICAgIGlmIChtLnJlYXNvbikgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZWFzb24pCiAgfSwKICBkZWNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IHJlcXVlc3QgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBzdGF0ZS5zdGFydCA8IHN0YXRlLmVuZCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgcmV0dXJuIHsKICAgICAgcmVxdWVzdCwKICAgICAgcmVhc29uOiBmbGFncyAmIDEgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCndpcmUud2FudCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUudW53YW50ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUsIG0pIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5yYW5nZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgaWYgKG0ubGVuZ3RoICE9PSAxKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgKG0uZHJvcCA/IDEgOiAwKSB8IChtLmxlbmd0aCA9PT0gMSA/IDIgOiAwKSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBpZiAobS5sZW5ndGggIT09IDEpIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgZHJvcDogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IDEgOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5iaXRmaWVsZCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQzMmFycmF5LnByZWVuY29kZShzdGF0ZSwgbS5iaXRmaWVsZCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludDMyYXJyYXkuZW5jb2RlKHN0YXRlLCBtLmJpdGZpZWxkKQogIH0sCiAgZGVjb2RlKHN0YXRlLCBtKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGJpdGZpZWxkOiBjLnVpbnQzMmFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUuc3luYyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmZvcmspCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVtb3RlTGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKAogICAgICBzdGF0ZSwKICAgICAgKG0uY2FuVXBncmFkZSA/IDEgOiAwKSB8CiAgICAgICAgKG0udXBsb2FkaW5nID8gMiA6IDApIHwKICAgICAgICAobS5kb3dubG9hZGluZyA/IDQgOiAwKSB8CiAgICAgICAgKG0uaGFzTWFuaWZlc3QgPyA4IDogMCkgfAogICAgICAgIChtLmFsbG93UHVzaCA/IDE2IDogMCkKICAgICkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZm9yaykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZW1vdGVMZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBmb3JrOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgcmVtb3RlTGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgY2FuVXBncmFkZTogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIHVwbG9hZGluZzogKGZsYWdzICYgMikgIT09IDAsCiAgICAgIGRvd25sb2FkaW5nOiAoZmxhZ3MgJiA0KSAhPT0gMCwKICAgICAgaGFzTWFuaWZlc3Q6IChmbGFncyAmIDgpICE9PSAwLAogICAgICBhbGxvd1B1c2g6IChmbGFncyAmIDE2KSAhPT0gMAogICAgfQogIH0KfQoKd2lyZS5yZW9yZ0hpbnQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmZyb20pCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnRvKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5hbmNlc3RvcnMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZnJvbSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udG8pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmFuY2VzdG9ycykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgZnJvbTogYy51aW50LmVuY29kZShzdGF0ZSksCiAgICAgIHRvOiBjLnVpbnQuZW5jb2RlKHN0YXRlKSwKICAgICAgYW5jZXN0b3JzOiBjLnVpbnQuZW5jb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5leHRlbnNpb24gPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIG0ubmFtZSkKICAgIGMucmF3LnByZWVuY29kZShzdGF0ZSwgbS5tZXNzYWdlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIG0ubmFtZSkKICAgIGMucmF3LmVuY29kZShzdGF0ZSwgbS5tZXNzYWdlKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBuYW1lOiBjLnN0cmluZy5kZWNvZGUoc3RhdGUpLAogICAgICBtZXNzYWdlOiBjLnJhdy5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBrZXlWYWx1ZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHApIHsKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgcC5rZXkpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHAudmFsdWUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHApIHsKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgcC5rZXkpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHAudmFsdWUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGtleTogYy5zdHJpbmcuZGVjb2RlKHN0YXRlKSwKICAgICAgdmFsdWU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHRyZWVVcGdyYWRlID0gewogIHByZWVuY29kZShzdGF0ZSwgdSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5mb3JrKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5hbmNlc3RvcnMpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdS5zaWduYXR1cmUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHUpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUuZm9yaykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUuYW5jZXN0b3JzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHUuc2lnbmF0dXJlKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBmb3JrOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYW5jZXN0b3JzOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBiaXRmaWVsZFVwZGF0ZSA9IHsKICAvLyBUT0RPOiBjYW4gbWF5YmUgYmUgZm9sZGVkIGludG8gYSBIQVZFIGxhdGVyIG9uIHdpdGggdGhlIG1vc3QgcmVjZW50IHNwZWMKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgYi5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IGIuZHJvcCA/IDEgOiAwCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIGRyb3A6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IG9wbG9nID0gKGV4cG9ydHMub3Bsb2cgPSB7fSkKCm9wbG9nLmVudHJ5ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGlmIChtLnVzZXJEYXRhKSBrZXlWYWx1ZS5wcmVlbmNvZGUoc3RhdGUsIG0udXNlckRhdGEpCiAgICBpZiAobS50cmVlTm9kZXMpIG5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0udHJlZU5vZGVzKQogICAgaWYgKG0udHJlZVVwZ3JhZGUpIHRyZWVVcGdyYWRlLnByZWVuY29kZShzdGF0ZSwgbS50cmVlVXBncmFkZSkKICAgIGlmIChtLmJpdGZpZWxkKSBiaXRmaWVsZFVwZGF0ZS5wcmVlbmNvZGUoc3RhdGUsIG0uYml0ZmllbGQpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IHMgPSBzdGF0ZS5zdGFydCsrCiAgICBsZXQgZmxhZ3MgPSAwCgogICAgaWYgKG0udXNlckRhdGEpIHsKICAgICAgZmxhZ3MgfD0gMQogICAgICBrZXlWYWx1ZS5lbmNvZGUoc3RhdGUsIG0udXNlckRhdGEpCiAgICB9CiAgICBpZiAobS50cmVlTm9kZXMpIHsKICAgICAgZmxhZ3MgfD0gMgogICAgICBub2RlQXJyYXkuZW5jb2RlKHN0YXRlLCBtLnRyZWVOb2RlcykKICAgIH0KICAgIGlmIChtLnRyZWVVcGdyYWRlKSB7CiAgICAgIGZsYWdzIHw9IDQKICAgICAgdHJlZVVwZ3JhZGUuZW5jb2RlKHN0YXRlLCBtLnRyZWVVcGdyYWRlKQogICAgfQogICAgaWYgKG0uYml0ZmllbGQpIHsKICAgICAgZmxhZ3MgfD0gOAogICAgICBiaXRmaWVsZFVwZGF0ZS5lbmNvZGUoc3RhdGUsIG0uYml0ZmllbGQpCiAgICB9CgogICAgc3RhdGUuYnVmZmVyW3NdID0gZmxhZ3MKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgdXNlckRhdGE6IChmbGFncyAmIDEpICE9PSAwID8ga2V5VmFsdWUuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHRyZWVOb2RlczogKGZsYWdzICYgMikgIT09IDAgPyBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHRyZWVVcGdyYWRlOiAoZmxhZ3MgJiA0KSAhPT0gMCA/IHRyZWVVcGdyYWRlLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBiaXRmaWVsZDogKGZsYWdzICYgOCkgIT09IDAgPyBiaXRmaWVsZFVwZGF0ZS5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKY29uc3Qga2V5UGFpciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGtwKSB7CiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIGtwLnB1YmxpY0tleSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwga3Auc2VjcmV0S2V5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBrcCkgewogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBrcC5wdWJsaWNLZXkpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIGtwLnNlY3JldEtleSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcHVibGljS2V5OiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpLAogICAgICBzZWNyZXRLZXk6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlb3JnSGludCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHIpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHIuZnJvbSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHIudG8pCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCByLmFuY2VzdG9ycykKICB9LAogIGVuY29kZShzdGF0ZSwgcikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgci5mcm9tKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgci50bykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHIuYW5jZXN0b3JzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBmcm9tOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgdG86IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBhbmNlc3RvcnM6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZW9yZ0hpbnRBcnJheSA9IGMuYXJyYXkocmVvcmdIaW50KQoKY29uc3QgaGludHMgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBoKSB7CiAgICByZW9yZ0hpbnRBcnJheS5wcmVlbmNvZGUoc3RhdGUsIGgucmVvcmdzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgaC5jb250aWd1b3VzTGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBoKSB7CiAgICByZW9yZ0hpbnRBcnJheS5lbmNvZGUoc3RhdGUsIGgucmVvcmdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgaC5jb250aWd1b3VzTGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICByZW9yZ3M6IHJlb3JnSGludEFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IHN0YXRlLnN0YXJ0IDwgc3RhdGUuZW5kID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCiAgICB9CiAgfQp9Cgpjb25zdCB0cmVlSGVhZGVyID0gewogIHByZWVuY29kZShzdGF0ZSwgdCkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdC5mb3JrKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdC5sZW5ndGgpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHQucm9vdEhhc2gpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHQuc2lnbmF0dXJlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCB0KSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB0LmZvcmspCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB0Lmxlbmd0aCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgdC5yb290SGFzaCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgdC5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGZvcms6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICByb290SGFzaDogYy5idWZmZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCB0eXBlcyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHQpIHsKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgdC50cmVlKQogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCB0LmJpdGZpZWxkKQogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCB0LnNpZ25lcikKICB9LAogIGVuY29kZShzdGF0ZSwgdCkgewogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCB0LnRyZWUpCiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIHQuYml0ZmllbGQpCiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIHQuc2lnbmVyKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICB0cmVlOiBjLnN0cmluZy5kZWNvZGUoc3RhdGUpLAogICAgICBiaXRmaWVsZDogYy5zdHJpbmcuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmVyOiBjLnN0cmluZy5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBleHRlcm5hbEhlYWRlciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGtleVZhbHVlQXJyYXkgPSBjLmFycmF5KGtleVZhbHVlKQoKb3Bsb2cuaGVhZGVyID0gewogIHByZWVuY29kZShzdGF0ZSwgaCkgewogICAgc3RhdGUuZW5kICs9IDIgLy8gdmVyc2lvbiArIGZsYWdzCiAgICBpZiAoaC5leHRlcm5hbCkgewogICAgICBleHRlcm5hbEhlYWRlci5wcmVlbmNvZGUoc3RhdGUsIGguZXh0ZXJuYWwpCiAgICAgIHJldHVybgogICAgfQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgaC5rZXkpCiAgICBpZiAoaC5tYW5pZmVzdCkgbWFuaWZlc3QucHJlZW5jb2RlKHN0YXRlLCBoLm1hbmlmZXN0KQogICAgaWYgKGgua2V5UGFpcikga2V5UGFpci5wcmVlbmNvZGUoc3RhdGUsIGgua2V5UGFpcikKICAgIGtleVZhbHVlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBoLnVzZXJEYXRhKQogICAgdHJlZUhlYWRlci5wcmVlbmNvZGUoc3RhdGUsIGgudHJlZSkKICAgIGhpbnRzLnByZWVuY29kZShzdGF0ZSwgaC5oaW50cykKICB9LAogIGVuY29kZShzdGF0ZSwgaCkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgMSkKICAgIGlmIChoLmV4dGVybmFsKSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpIC8vIE9OTFkgc2V0IHRoZSBmaXJzdCBiaWcgZm9yIGNsYXJpdHkKICAgICAgZXh0ZXJuYWxIZWFkZXIuZW5jb2RlKHN0YXRlLCBoLmV4dGVybmFsKQogICAgICByZXR1cm4KICAgIH0KICAgIGMudWludC5lbmNvZGUoc3RhdGUsIChoLm1hbmlmZXN0ID8gMiA6IDApIHwgKGgua2V5UGFpciA/IDQgOiAwKSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIGgua2V5KQogICAgaWYgKGgubWFuaWZlc3QpIG1hbmlmZXN0LmVuY29kZShzdGF0ZSwgaC5tYW5pZmVzdCkKICAgIGlmIChoLmtleVBhaXIpIGtleVBhaXIuZW5jb2RlKHN0YXRlLCBoLmtleVBhaXIpCiAgICBrZXlWYWx1ZUFycmF5LmVuY29kZShzdGF0ZSwgaC51c2VyRGF0YSkKICAgIHRyZWVIZWFkZXIuZW5jb2RlKHN0YXRlLCBoLnRyZWUpCiAgICBoaW50cy5lbmNvZGUoc3RhdGUsIGguaGludHMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmICh2ZXJzaW9uID4gMSkgewogICAgICB0aHJvdyBJTlZBTElEX09QTE9HX1ZFUlNJT04oJ0ludmFsaWQgaGVhZGVyIHZlcnNpb24uIEV4cGVjdGVkIDw9IDEsIGdvdCAnICsgdmVyc2lvbikKICAgIH0KCiAgICBpZiAodmVyc2lvbiA9PT0gMCkgewogICAgICBjb25zdCBvbGQgPSB7CiAgICAgICAgdHlwZXM6IHR5cGVzLmRlY29kZShzdGF0ZSksCiAgICAgICAgdXNlckRhdGE6IGtleVZhbHVlQXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgICB0cmVlOiB0cmVlSGVhZGVyLmRlY29kZShzdGF0ZSksCiAgICAgICAgc2lnbmVyOiBrZXlQYWlyLmRlY29kZShzdGF0ZSksCiAgICAgICAgaGludHM6IGhpbnRzLmRlY29kZShzdGF0ZSkKICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICBleHRlcm5hbDogbnVsbCwKICAgICAgICBrZXk6IG9sZC5zaWduZXIucHVibGljS2V5LAogICAgICAgIG1hbmlmZXN0OiB7CiAgICAgICAgICB2ZXJzaW9uOiAwLAogICAgICAgICAgaGFzaDogb2xkLnR5cGVzLnRyZWUsCiAgICAgICAgICBhbGxvd1BhdGNoOiBmYWxzZSwKICAgICAgICAgIHF1b3J1bTogMSwKICAgICAgICAgIHNpZ25lcnM6IFsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHNpZ25hdHVyZTogb2xkLnR5cGVzLnNpZ25lciwKICAgICAgICAgICAgICBuYW1lc3BhY2U6IERFRkFVTFRfTkFNRVNQQUNFLAogICAgICAgICAgICAgIHB1YmxpY0tleTogb2xkLnNpZ25lci5wdWJsaWNLZXkKICAgICAgICAgICAgfQogICAgICAgICAgXSwKICAgICAgICAgIHByb2xvZ3VlOiBudWxsLAogICAgICAgICAgbGlua2VkOiBudWxsLAogICAgICAgICAgdXNlckRhdGE6IG51bGwKICAgICAgICB9LAogICAgICAgIGtleVBhaXI6IG9sZC5zaWduZXIuc2VjcmV0S2V5ID8gb2xkLnNpZ25lciA6IG51bGwsCiAgICAgICAgdXNlckRhdGE6IG9sZC51c2VyRGF0YSwKICAgICAgICB0cmVlOiBvbGQudHJlZSwKICAgICAgICBoaW50czogb2xkLmhpbnRzCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgaWYgKGZsYWdzICYgMSkgewogICAgICByZXR1cm4gewogICAgICAgIGV4dGVybmFsOiBleHRlcm5hbEhlYWRlci5kZWNvZGUoc3RhdGUpLAogICAgICAgIGtleTogbnVsbCwKICAgICAgICBtYW5pZmVzdDogbnVsbCwKICAgICAgICBrZXlQYWlyOiBudWxsLAogICAgICAgIHVzZXJEYXRhOiBudWxsLAogICAgICAgIHRyZWU6IG51bGwsCiAgICAgICAgaGludHM6IG51bGwKICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGV4dGVybmFsOiBudWxsLAogICAgICBrZXk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBtYW5pZmVzdDogKGZsYWdzICYgMikgIT09IDAgPyBtYW5pZmVzdC5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAga2V5UGFpcjogKGZsYWdzICYgNCkgIT09IDAgPyBrZXlQYWlyLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB1c2VyRGF0YToga2V5VmFsdWVBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICB0cmVlOiB0cmVlSGVhZGVyLmRlY29kZShzdGF0ZSksCiAgICAgIGhpbnRzOiBoaW50cy5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCB1aW50QXJyYXkgPSBjLmFycmF5KGMudWludCkKCmNvbnN0IG11bHRpc2lnSW5wdXQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBpbnApIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGlucC5zaWduZXIpCiAgICBjLmZpeGVkNjQucHJlZW5jb2RlKHN0YXRlLCBpbnAuc2lnbmF0dXJlKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgaW5wLnBhdGNoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBpbnApIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGlucC5zaWduZXIpCiAgICBjLmZpeGVkNjQuZW5jb2RlKHN0YXRlLCBpbnAuc2lnbmF0dXJlKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgaW5wLnBhdGNoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzaWduZXI6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuZml4ZWQ2NC5kZWNvZGUoc3RhdGUpLAogICAgICBwYXRjaDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHBhdGNoRW5jb2Rpbmd2MCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4uc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLmxlbmd0aCkKICAgIHVpbnRBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG4ubm9kZXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLmxlbmd0aCkKICAgIHVpbnRBcnJheS5lbmNvZGUoc3RhdGUsIG4ubm9kZXMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbm9kZXM6IHVpbnRBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBtdWx0aXNpZ0lucHV0djAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQrKwogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5zaWduZXIpCiAgICBjLmZpeGVkNjQucHJlZW5jb2RlKHN0YXRlLCBuLnNpZ25hdHVyZSkKICAgIGlmIChuLnBhdGNoKSBwYXRjaEVuY29kaW5ndjAucHJlZW5jb2RlKHN0YXRlLCBuLnBhdGNoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLnBhdGNoID8gMSA6IDApCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLnNpZ25lcikKICAgIGMuZml4ZWQ2NC5lbmNvZGUoc3RhdGUsIG4uc2lnbmF0dXJlKQogICAgaWYgKG4ucGF0Y2gpIHBhdGNoRW5jb2Rpbmd2MC5lbmNvZGUoc3RhdGUsIG4ucGF0Y2gpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIHNpZ25lcjogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25hdHVyZTogYy5maXhlZDY0LmRlY29kZShzdGF0ZSksCiAgICAgIHBhdGNoOiBmbGFncyAmIDEgPyBwYXRjaEVuY29kaW5ndjAuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IG11bHRpc2lnSW5wdXRBcnJheXYwID0gYy5hcnJheShtdWx0aXNpZ0lucHV0djApCmNvbnN0IG11bHRpc2lnSW5wdXRBcnJheSA9IGMuYXJyYXkobXVsdGlzaWdJbnB1dCkKCmNvbnN0IGNvbXBhY3ROb2RlID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5pbmRleCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4uc2l6ZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG4uaGFzaCkKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5pbmRleCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uc2l6ZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG4uaGFzaCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaXplOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgaGFzaDogYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGNvbXBhY3ROb2RlQXJyYXkgPSBjLmFycmF5KGNvbXBhY3ROb2RlKQoKZXhwb3J0cy5tdWx0aVNpZ25hdHVyZXYwID0gewogIHByZWVuY29kZShzdGF0ZSwgcykgewogICAgbXVsdGlzaWdJbnB1dEFycmF5djAucHJlZW5jb2RlKHN0YXRlLCBzLnByb29mcykKICAgIGNvbXBhY3ROb2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBzLnBhdGNoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBzKSB7CiAgICBtdWx0aXNpZ0lucHV0QXJyYXl2MC5lbmNvZGUoc3RhdGUsIHMucHJvb2ZzKQogICAgY29tcGFjdE5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIHMucGF0Y2gpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHByb29mczogbXVsdGlzaWdJbnB1dEFycmF5djAuZGVjb2RlKHN0YXRlKSwKICAgICAgcGF0Y2g6IGNvbXBhY3ROb2RlQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKZXhwb3J0cy5tdWx0aVNpZ25hdHVyZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHMpIHsKICAgIG11bHRpc2lnSW5wdXRBcnJheS5wcmVlbmNvZGUoc3RhdGUsIHMucHJvb2ZzKQogICAgY29tcGFjdE5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIHMucGF0Y2gpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHMpIHsKICAgIG11bHRpc2lnSW5wdXRBcnJheS5lbmNvZGUoc3RhdGUsIHMucHJvb2ZzKQogICAgY29tcGFjdE5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIHMucGF0Y2gpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHByb29mczogbXVsdGlzaWdJbnB1dEFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIHBhdGNoOiBjb21wYWN0Tm9kZUFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBmbGF0ID0gcmVxdWlyZSgnZmxhdC10cmVlJykKY29uc3QgeyBNZXJrbGVUcmVlIH0gPSByZXF1aXJlKCcuL21lcmtsZS10cmVlJykKY29uc3QgeyBtdWx0aVNpZ25hdHVyZSwgbXVsdGlTaWduYXR1cmV2MCB9ID0gcmVxdWlyZSgnLi9tZXNzYWdlcycpCgptb2R1bGUuZXhwb3J0cyA9IHsKICBhc3NlbWJsZXYwLAogIGFzc2VtYmxlLAogIGluZmxhdGV2MCwKICBpbmZsYXRlLAogIHBhcnRpYWxTaWduYXR1cmUsCiAgc2lnbmFibGVMZW5ndGgKfQoKZnVuY3Rpb24gaW5mbGF0ZXYwKGRhdGEpIHsKICByZXR1cm4gYy5kZWNvZGUobXVsdGlTaWduYXR1cmV2MCwgZGF0YSkKfQoKZnVuY3Rpb24gaW5mbGF0ZShkYXRhKSB7CiAgcmV0dXJuIGMuZGVjb2RlKG11bHRpU2lnbmF0dXJlLCBkYXRhKQp9Cgphc3luYyBmdW5jdGlvbiBwYXJ0aWFsU2lnbmF0dXJlKAogIGNvcmUsCiAgc2lnbmVyLAogIGZyb20sCiAgdG8gPSBjb3JlLnN0YXRlLmxlbmd0aCwKICBzaWduYXR1cmUgPSBjb3JlLnN0YXRlLnNpZ25hdHVyZQopIHsKICBpZiAoZnJvbSA+IGNvcmUuc3RhdGUubGVuZ3RoKSByZXR1cm4gbnVsbAogIGNvbnN0IG5vZGVzID0gdG8gPD0gZnJvbSA/IG51bGwgOiBhd2FpdCB1cGdyYWRlTm9kZXMoY29yZSwgZnJvbSwgdG8pCgogIGlmIChzaWduYXR1cmUuYnl0ZUxlbmd0aCAhPT0gNjQpIHsKICAgIHNpZ25hdHVyZSA9IGMuZGVjb2RlKG11bHRpU2lnbmF0dXJlLCBzaWduYXR1cmUpLnByb29mc1swXS5zaWduYXR1cmUKICB9CgogIHJldHVybiB7CiAgICBzaWduZXIsCiAgICBzaWduYXR1cmUsCiAgICBwYXRjaDogbm9kZXMgPyB0byAtIGZyb20gOiAwLAogICAgbm9kZXMKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHVwZ3JhZGVOb2Rlcyhjb3JlLCBmcm9tLCB0bykgewogIGNvbnN0IHJ4ID0gY29yZS5zdGF0ZS5zdG9yYWdlLnJlYWQoKQogIGxldCBwID0gbnVsbAogIHRyeSB7CiAgICBwID0gYXdhaXQgTWVya2xlVHJlZS5wcm9vZihjb3JlLnN0YXRlLCByeCwgeyB1cGdyYWRlOiB7IHN0YXJ0OiBmcm9tLCBsZW5ndGg6IHRvIC0gZnJvbSB9IH0pCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByeC5kZXN0cm95KCkKICAgIHRocm93IGVycgogIH0KICByeC50cnlGbHVzaCgpCiAgcmV0dXJuIChhd2FpdCBwLnNldHRsZSgpKS51cGdyYWRlLm5vZGVzCn0KCmZ1bmN0aW9uIHNpZ25hYmxlTGVuZ3RoKGxlbmd0aHMsIHF1b3J1bSkgewogIGlmIChxdW9ydW0gPD0gMCkgcXVvcnVtID0gMQogIGlmIChxdW9ydW0gPiBsZW5ndGhzLmxlbmd0aCkgcmV0dXJuIDAKCiAgcmV0dXJuIGxlbmd0aHMuc29ydChjbXApW3F1b3J1bSAtIDFdCn0KCmZ1bmN0aW9uIGNtcChhLCBiKSB7CiAgcmV0dXJuIGIgLSBhCn0KCmZ1bmN0aW9uIGFzc2VtYmxldjAoaW5wdXRzKSB7CiAgY29uc3QgcHJvb2ZzID0gW10KICBjb25zdCBwYXRjaCA9IFtdCgogIGZvciAoY29uc3QgdSBvZiBpbnB1dHMpIHsKICAgIHByb29mcy5wdXNoKGNvbXByZXNzUHJvb2YodSwgcGF0Y2gpKQogIH0KCiAgcmV0dXJuIGMuZW5jb2RlKG11bHRpU2lnbmF0dXJldjAsIHsgcHJvb2ZzLCBwYXRjaCB9KQp9CgpmdW5jdGlvbiBhc3NlbWJsZShpbnB1dHMpIHsKICBjb25zdCBwcm9vZnMgPSBbXQogIGNvbnN0IHBhdGNoID0gW10KICBjb25zdCBzZWVuID0gbmV3IFNldCgpCgogIGZvciAoY29uc3QgdSBvZiBpbnB1dHMpIHsKICAgIGlmICh1Lm5vZGVzKSB7CiAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiB1Lm5vZGVzKSB7CiAgICAgICAgaWYgKHNlZW4uaGFzKG5vZGUuaW5kZXgpKSBjb250aW51ZQogICAgICAgIHNlZW4uYWRkKG5vZGUuaW5kZXgpCiAgICAgICAgcGF0Y2gucHVzaChub2RlKQogICAgICB9CiAgICB9CgogICAgcHJvb2ZzLnB1c2goewogICAgICBzaWduZXI6IHUuc2lnbmVyLAogICAgICBzaWduYXR1cmU6IHUuc2lnbmF0dXJlLAogICAgICBwYXRjaDogdS5wYXRjaAogICAgfSkKICB9CgogIHJldHVybiBjLmVuY29kZShtdWx0aVNpZ25hdHVyZSwgeyBwcm9vZnMsIHBhdGNoIH0pCn0KCmZ1bmN0aW9uIGNvbXBhcmVOb2RlKGEsIGIpIHsKICBpZiAoYS5pbmRleCAhPT0gYi5pbmRleCkgcmV0dXJuIGZhbHNlCiAgaWYgKGEuc2l6ZSAhPT0gYi5zaXplKSByZXR1cm4gZmFsc2UKICByZXR1cm4gYjRhLmVxdWFscyhhLmhhc2gsIGIuaGFzaCkKfQoKZnVuY3Rpb24gY29tcHJlc3NQcm9vZihwcm9vZiwgbm9kZXMpIHsKICByZXR1cm4gewogICAgc2lnbmVyOiBwcm9vZi5zaWduZXIsCiAgICBzaWduYXR1cmU6IHByb29mLnNpZ25hdHVyZSwKICAgIHBhdGNoOiBwcm9vZi5wYXRjaCA/IGNvbXByZXNzVXBncmFkZShwcm9vZiwgbm9kZXMpIDogbnVsbAogIH0KfQoKZnVuY3Rpb24gY29tcHJlc3NVcGdyYWRlKHAsIG5vZGVzKSB7CiAgY29uc3QgdSA9IHsKICAgIHN0YXJ0OiBmbGF0LnJpZ2h0U3BhbihwLm5vZGVzW3Aubm9kZXMubGVuZ3RoIC0gMV0uaW5kZXgpIC8gMiArIDEsCiAgICBsZW5ndGg6IHAucGF0Y2gsCiAgICBub2RlczogW10KICB9CgogIGZvciAoY29uc3Qgbm9kZSBvZiBwLm5vZGVzKSB7CiAgICBsZXQgcHJlc2VudCA9IGZhbHNlCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICghY29tcGFyZU5vZGUobm9kZXNbaV0sIG5vZGUpKSBjb250aW51ZQoKICAgICAgdS5ub2Rlcy5wdXNoKGkpCiAgICAgIHByZXNlbnQgPSB0cnVlCiAgICAgIGJyZWFrCiAgICB9CgogICAgaWYgKHByZXNlbnQpIGNvbnRpbnVlCiAgICB1Lm5vZGVzLnB1c2gobm9kZXMucHVzaChub2RlKSAtIDEpCiAgfQoKICByZXR1cm4gdQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgTXV0ZXggewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5sb2NrZWQgPSBmYWxzZQogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQoKICAgIHRoaXMuX2Rlc3Ryb3lpbmcgPSBudWxsCiAgICB0aGlzLl9kZXN0cm95RXJyb3IgPSBudWxsCiAgICB0aGlzLl9xdWV1ZSA9IFtdCiAgICB0aGlzLl9lbnF1ZXVlID0gKHJlc29sdmUsIHJlamVjdCkgPT4gdGhpcy5fcXVldWUucHVzaChbcmVzb2x2ZSwgcmVqZWN0XSkKICB9CgogIGlkbGUoKSB7CiAgICByZXR1cm4gdGhpcy5fcXVldWUubGVuZ3RoID09PSAwICYmIHRoaXMubG9ja2VkID09PSBmYWxzZQogIH0KCiAgbG9jaygpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgewogICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QodGhpcy5fZGVzdHJveUVycm9yIHx8IG5ldyBFcnJvcignTXV0ZXggaGFzIGJlZW4gZGVzdHJveWVkJykpCiAgICB9CiAgICBpZiAodGhpcy5sb2NrZWQpIHJldHVybiBuZXcgUHJvbWlzZSh0aGlzLl9lbnF1ZXVlKQogICAgdGhpcy5sb2NrZWQgPSB0cnVlCiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKICB9CgogIHVubG9jaygpIHsKICAgIGlmICghdGhpcy5fcXVldWUubGVuZ3RoKSB7CiAgICAgIHRoaXMubG9ja2VkID0gZmFsc2UKICAgICAgcmV0dXJuCiAgICB9CiAgICB0aGlzLl9xdWV1ZS5zaGlmdCgpWzBdKCkKICB9CgogIGRlc3Ryb3koZXJyKSB7CiAgICBpZiAoIXRoaXMuX2Rlc3Ryb3lpbmcpIHsKICAgICAgdGhpcy5fZGVzdHJveWluZyA9IHRoaXMubG9ja2VkID8gdGhpcy5sb2NrKCkuY2F0Y2goKCkgPT4ge30pIDogUHJvbWlzZS5yZXNvbHZlKCkKICAgIH0KCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICAgIGlmIChlcnIpIHRoaXMuX2Rlc3Ryb3lFcnJvciA9IGVycgoKICAgIGlmIChlcnIpIHsKICAgICAgd2hpbGUgKHRoaXMuX3F1ZXVlLmxlbmd0aCkgdGhpcy5fcXVldWUuc2hpZnQoKVsxXShlcnIpCiAgICB9CgogICAgcmV0dXJuIHRoaXMuX2Rlc3Ryb3lpbmcKICB9Cn0KY29uc3QgRklGTyA9IHJlcXVpcmUoJ2Zhc3QtZmlmbycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJlY2VpdmVyUXVldWUgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5xdWV1ZSA9IG5ldyBGSUZPKCkKICAgIHRoaXMucHJpb3JpdHkgPSBbXQogICAgdGhpcy5yZXF1ZXN0cyA9IG5ldyBNYXAoKQogICAgdGhpcy5sZW5ndGggPSAwCiAgfQoKICBwdXNoKHJlcSkgewogICAgLy8gVE9ETzogdXNlIGEgaGVhcCBhdCBzb21lIHBvaW50IGlmIHdlIHdhbm5hIHN1cHBvcnQgbXVsdGlwbGUgcHJpb3MKICAgIGlmIChyZXEucHJpb3JpdHkgPiAwKSB0aGlzLnByaW9yaXR5LnB1c2gocmVxKQogICAgZWxzZSB0aGlzLnF1ZXVlLnB1c2gocmVxKQoKICAgIHRoaXMucmVxdWVzdHMuc2V0KHJlcS5pZCwgcmVxKQogICAgdGhpcy5sZW5ndGgrKwogIH0KCiAgc2hpZnQoKSB7CiAgICB3aGlsZSAodGhpcy5wcmlvcml0eS5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG1zZyA9IHRoaXMucHJpb3JpdHkucG9wKCkKICAgICAgY29uc3QgcmVxID0gdGhpcy5fcHJvY2Vzc1JlcXVlc3QobXNnKQogICAgICBpZiAocmVxICE9PSBudWxsKSByZXR1cm4gcmVxCiAgICB9CgogICAgd2hpbGUgKHRoaXMucXVldWUubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBtc2cgPSB0aGlzLnF1ZXVlLnNoaWZ0KCkKICAgICAgY29uc3QgcmVxID0gdGhpcy5fcHJvY2Vzc1JlcXVlc3QobXNnKQogICAgICBpZiAocmVxICE9PSBudWxsKSByZXR1cm4gcmVxCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIF9wcm9jZXNzUmVxdWVzdChyZXEpIHsKICAgIGlmIChyZXEuYmxvY2sgfHwgcmVxLmhhc2ggfHwgcmVxLnNlZWsgfHwgcmVxLnVwZ3JhZGUgfHwgcmVxLm1hbmlmZXN0KSB7CiAgICAgIHRoaXMucmVxdWVzdHMuZGVsZXRlKHJlcS5pZCkKICAgICAgdGhpcy5sZW5ndGgtLQogICAgICByZXR1cm4gcmVxCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIGNsZWFyKCkgewogICAgdGhpcy5xdWV1ZS5jbGVhcigpCiAgICB0aGlzLnByaW9yaXR5ID0gW10KICAgIHRoaXMubGVuZ3RoID0gMAogICAgdGhpcy5yZXF1ZXN0cy5jbGVhcigpCiAgfQoKICBkZWxldGUoaWQpIHsKICAgIGNvbnN0IHJlcSA9IHRoaXMucmVxdWVzdHMuZ2V0KGlkKQogICAgaWYgKCFyZXEpIHJldHVybgoKICAgIHJlcS5ibG9jayA9IG51bGwKICAgIHJlcS5oYXNoID0gbnVsbAogICAgcmVxLnNlZWsgPSBudWxsCiAgICByZXEudXBncmFkZSA9IG51bGwKICAgIHJlcS5tYW5pZmVzdCA9IGZhbHNlCgogICAgdGhpcy5yZXF1ZXN0cy5kZWxldGUoaWQpCiAgICB0aGlzLmxlbmd0aC0tCgogICAgaWYgKHRoaXMubGVuZ3RoID09PSAwKSB7CiAgICAgIHRoaXMucXVldWUuY2xlYXIoKQogICAgICB0aGlzLnByaW9yaXR5ID0gW10KICAgIH0KICB9Cn0KY29uc3QgQmlnU3BhcnNlQXJyYXkgPSByZXF1aXJlKCdiaWctc3BhcnNlLWFycmF5JykKY29uc3QgcXVpY2tiaXQgPSByZXF1aXJlKCcuL2NvbXBhdCcpLnF1aWNrYml0Cgpjb25zdCBCSVRTX1BFUl9QQUdFID0gMzI3NjgKY29uc3QgQllURVNfUEVSX1BBR0UgPSBCSVRTX1BFUl9QQUdFIC8gOApjb25zdCBXT1JEU19QRVJfUEFHRSA9IEJZVEVTX1BFUl9QQUdFIC8gNApjb25zdCBCSVRTX1BFUl9TRUdNRU5UID0gMjA5NzE1Mgpjb25zdCBCWVRFU19QRVJfU0VHTUVOVCA9IEJJVFNfUEVSX1NFR01FTlQgLyA4CmNvbnN0IFBBR0VTX1BFUl9TRUdNRU5UID0gQklUU19QRVJfU0VHTUVOVCAvIEJJVFNfUEVSX1BBR0UKCmNsYXNzIFJlbW90ZUJpdGZpZWxkUGFnZSB7CiAgY29uc3RydWN0b3IoaW5kZXgsIGJpdGZpZWxkLCBzZWdtZW50KSB7CiAgICB0aGlzLmluZGV4ID0gaW5kZXgKICAgIHRoaXMub2Zmc2V0ID0gaW5kZXggKiBCWVRFU19QRVJfUEFHRSAtIHNlZ21lbnQub2Zmc2V0CiAgICB0aGlzLmJpdGZpZWxkID0gYml0ZmllbGQKICAgIHRoaXMuc2VnbWVudCA9IHNlZ21lbnQKCiAgICBzZWdtZW50LmFkZCh0aGlzKQogIH0KCiAgZ2V0IHRyZWUoKSB7CiAgICByZXR1cm4gdGhpcy5zZWdtZW50LnRyZWUKICB9CgogIGdldChpbmRleCkgewogICAgcmV0dXJuIHF1aWNrYml0LmdldCh0aGlzLmJpdGZpZWxkLCBpbmRleCkKICB9CgogIHNldChpbmRleCwgdmFsKSB7CiAgICBpZiAocXVpY2tiaXQuc2V0KHRoaXMuYml0ZmllbGQsIGluZGV4LCB2YWwpKSB7CiAgICAgIHRoaXMudHJlZS51cGRhdGUodGhpcy5vZmZzZXQgKiA4ICsgaW5kZXgpCiAgICB9CiAgfQoKICBzZXRSYW5nZShzdGFydCwgZW5kLCB2YWwpIHsKICAgIHF1aWNrYml0LmZpbGwodGhpcy5iaXRmaWVsZCwgdmFsLCBzdGFydCwgZW5kKQoKICAgIGxldCBpID0gTWF0aC5mbG9vcihzdGFydCAvIDEyOCkKICAgIGNvbnN0IG4gPSBpICsgTWF0aC5jZWlsKChlbmQgLSBzdGFydCkgLyAxMjgpCgogICAgd2hpbGUgKGkgPD0gbikgdGhpcy50cmVlLnVwZGF0ZSh0aGlzLm9mZnNldCAqIDggKyBpKysgKiAxMjgpCiAgfQoKICBmaW5kRmlyc3QodmFsLCBwb3NpdGlvbikgewogICAgcmV0dXJuIHF1aWNrYml0LmZpbmRGaXJzdCh0aGlzLmJpdGZpZWxkLCB2YWwsIHBvc2l0aW9uKQogIH0KCiAgZmluZExhc3QodmFsLCBwb3NpdGlvbikgewogICAgcmV0dXJuIHF1aWNrYml0LmZpbmRMYXN0KHRoaXMuYml0ZmllbGQsIHZhbCwgcG9zaXRpb24pCiAgfQoKICBpbnNlcnQoc3RhcnQsIGJpdGZpZWxkKSB7CiAgICB0aGlzLmJpdGZpZWxkLnNldChiaXRmaWVsZCwgc3RhcnQgLyAzMikKICAgIHRoaXMuc2VnbWVudC5yZWZyZXNoKCkKICB9CgogIGNsZWFyKHN0YXJ0LCBiaXRmaWVsZCkgewogICAgcXVpY2tiaXQuY2xlYXIodGhpcy5iaXRmaWVsZCwgeyBmaWVsZDogYml0ZmllbGQsIG9mZnNldDogc3RhcnQgfSkKICB9Cn0KCmNsYXNzIFJlbW90ZUJpdGZpZWxkU2VnbWVudCB7CiAgY29uc3RydWN0b3IoaW5kZXgpIHsKICAgIHRoaXMuaW5kZXggPSBpbmRleAogICAgdGhpcy5vZmZzZXQgPSBpbmRleCAqIEJZVEVTX1BFUl9TRUdNRU5UCiAgICB0aGlzLnRyZWUgPSBxdWlja2JpdC5JbmRleC5mcm9tKFtdLCBCWVRFU19QRVJfU0VHTUVOVCkKICAgIHRoaXMucGFnZXMgPSBuZXcgQXJyYXkoUEFHRVNfUEVSX1NFR01FTlQpCiAgICB0aGlzLnBhZ2VzTGVuZ3RoID0gMAogIH0KCiAgZ2V0IGNodW5rcygpIHsKICAgIHJldHVybiB0aGlzLnRyZWUuY2h1bmtzCiAgfQoKICByZWZyZXNoKCkgewogICAgdGhpcy50cmVlID0gcXVpY2tiaXQuSW5kZXguZnJvbSh0aGlzLnRyZWUuY2h1bmtzLCBCWVRFU19QRVJfU0VHTUVOVCkKICB9CgogIGFkZChwYWdlKSB7CiAgICBjb25zdCBwYWdlSW5kZXggPSBwYWdlLmluZGV4IC0gdGhpcy5pbmRleCAqIFBBR0VTX1BFUl9TRUdNRU5UCiAgICBpZiAocGFnZUluZGV4ID49IHRoaXMucGFnZXNMZW5ndGgpIHRoaXMucGFnZXNMZW5ndGggPSBwYWdlSW5kZXggKyAxCgogICAgdGhpcy5wYWdlc1twYWdlSW5kZXhdID0gcGFnZQoKICAgIGNvbnN0IGNodW5rID0geyBmaWVsZDogcGFnZS5iaXRmaWVsZCwgb2Zmc2V0OiBwYWdlLm9mZnNldCB9CgogICAgdGhpcy5jaHVua3MucHVzaChjaHVuaykKCiAgICBmb3IgKGxldCBpID0gdGhpcy5jaHVua3MubGVuZ3RoIC0gMjsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgcHJldiA9IHRoaXMuY2h1bmtzW2ldCiAgICAgIGlmIChwcmV2Lm9mZnNldCA8PSBjaHVuay5vZmZzZXQpIGJyZWFrCiAgICAgIHRoaXMuY2h1bmtzW2ldID0gY2h1bmsKICAgICAgdGhpcy5jaHVua3NbaSArIDFdID0gcHJldgogICAgfQogIH0KCiAgZmluZEZpcnN0KHZhbCwgcG9zaXRpb24pIHsKICAgIHBvc2l0aW9uID0gdGhpcy50cmVlLnNraXBGaXJzdCghdmFsLCBwb3NpdGlvbikKCiAgICBsZXQgaiA9IHBvc2l0aW9uICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgbGV0IGkgPSAocG9zaXRpb24gLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICBpZiAoaSA+PSBQQUdFU19QRVJfU0VHTUVOVCkgcmV0dXJuIC0xCgogICAgd2hpbGUgKGkgPCB0aGlzLnBhZ2VzTGVuZ3RoKSB7CiAgICAgIGNvbnN0IHAgPSB0aGlzLnBhZ2VzW2ldCgogICAgICBsZXQgaW5kZXggPSAtMQoKICAgICAgaWYgKHApIGluZGV4ID0gcC5maW5kRmlyc3QodmFsLCBqKQogICAgICBlbHNlIGlmICghdmFsKSBpbmRleCA9IGoKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBpICogQklUU19QRVJfUEFHRSArIGluZGV4CgogICAgICBqID0gMAogICAgICBpKysKICAgIH0KCiAgICByZXR1cm4gdmFsIHx8IHRoaXMucGFnZXNMZW5ndGggPT09IFBBR0VTX1BFUl9TRUdNRU5UID8gLTEgOiB0aGlzLnBhZ2VzTGVuZ3RoICogQklUU19QRVJfUEFHRQogIH0KCiAgZmluZExhc3QodmFsLCBwb3NpdGlvbikgewogICAgcG9zaXRpb24gPSB0aGlzLnRyZWUuc2tpcExhc3QoIXZhbCwgcG9zaXRpb24pCgogICAgbGV0IGogPSBwb3NpdGlvbiAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGxldCBpID0gKHBvc2l0aW9uIC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgaWYgKGkgPj0gUEFHRVNfUEVSX1NFR01FTlQpIHJldHVybiAtMQoKICAgIHdoaWxlIChpID49IDApIHsKICAgICAgY29uc3QgcCA9IHRoaXMucGFnZXNbaV0KCiAgICAgIGxldCBpbmRleCA9IC0xCgogICAgICBpZiAocCkgaW5kZXggPSBwLmZpbmRMYXN0KHZhbCwgaikKICAgICAgZWxzZSBpZiAoIXZhbCkgaW5kZXggPSBqCgogICAgICBpZiAoaW5kZXggIT09IC0xKSByZXR1cm4gaSAqIEJJVFNfUEVSX1BBR0UgKyBpbmRleAoKICAgICAgaiA9IEJJVFNfUEVSX1BBR0UgLSAxCiAgICAgIGktLQogICAgfQoKICAgIHJldHVybiAtMQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSZW1vdGVCaXRmaWVsZCB7CiAgc3RhdGljIEJJVFNfUEVSX1BBR0UgPSBCSVRTX1BFUl9QQUdFCgogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5fcGFnZXMgPSBuZXcgQmlnU3BhcnNlQXJyYXkoKQogICAgdGhpcy5fc2VnbWVudHMgPSBuZXcgQmlnU3BhcnNlQXJyYXkoKQogICAgdGhpcy5fbWF4U2VnbWVudHMgPSAwCiAgfQoKICBnZXRCaXRmaWVsZChpbmRleCkgewogICAgY29uc3QgaiA9IGluZGV4ICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgY29uc3QgaSA9IChpbmRleCAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIGNvbnN0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKICAgIHJldHVybiBwIHx8IG51bGwKICB9CgogIGdldChpbmRleCkgewogICAgY29uc3QgaiA9IGluZGV4ICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgY29uc3QgaSA9IChpbmRleCAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIGNvbnN0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKCiAgICByZXR1cm4gcCA/IHAuZ2V0KGopIDogZmFsc2UKICB9CgogIHNldChpbmRleCwgdmFsKSB7CiAgICBjb25zdCBqID0gaW5kZXggJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBjb25zdCBpID0gKGluZGV4IC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgbGV0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKCiAgICBpZiAoIXAgJiYgdmFsKSB7CiAgICAgIGNvbnN0IGsgPSBNYXRoLmZsb29yKGkgLyBQQUdFU19QRVJfU0VHTUVOVCkKICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZ21lbnRzLmdldChrKSB8fCB0aGlzLl9zZWdtZW50cy5zZXQoaywgbmV3IFJlbW90ZUJpdGZpZWxkU2VnbWVudChrKSkKICAgICAgaWYgKHRoaXMuX21heFNlZ21lbnRzIDw9IGspIHRoaXMuX21heFNlZ21lbnRzID0gayArIDEKCiAgICAgIHAgPSB0aGlzLl9wYWdlcy5zZXQoaSwgbmV3IFJlbW90ZUJpdGZpZWxkUGFnZShpLCBuZXcgVWludDMyQXJyYXkoV09SRFNfUEVSX1BBR0UpLCBzKSkKICAgIH0KCiAgICBpZiAocCkgcC5zZXQoaiwgdmFsKQogIH0KCiAgc2V0UmFuZ2Uoc3RhcnQsIGVuZCwgdmFsKSB7CiAgICBsZXQgaiA9IHN0YXJ0ICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgbGV0IGkgPSAoc3RhcnQgLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICB3aGlsZSAoc3RhcnQgPCBlbmQpIHsKICAgICAgbGV0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKCiAgICAgIGlmICghcCAmJiB2YWwpIHsKICAgICAgICBjb25zdCBrID0gTWF0aC5mbG9vcihpIC8gUEFHRVNfUEVSX1NFR01FTlQpCiAgICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZ21lbnRzLmdldChrKSB8fCB0aGlzLl9zZWdtZW50cy5zZXQoaywgbmV3IFJlbW90ZUJpdGZpZWxkU2VnbWVudChrKSkKICAgICAgICBpZiAodGhpcy5fbWF4U2VnbWVudHMgPD0gaykgdGhpcy5fbWF4U2VnbWVudHMgPSBrICsgMQoKICAgICAgICBwID0gdGhpcy5fcGFnZXMuc2V0KGksIG5ldyBSZW1vdGVCaXRmaWVsZFBhZ2UoaSwgbmV3IFVpbnQzMkFycmF5KFdPUkRTX1BFUl9QQUdFKSwgcykpCiAgICAgIH0KCiAgICAgIGNvbnN0IG9mZnNldCA9IGkgKiBCSVRTX1BFUl9QQUdFCiAgICAgIGNvbnN0IGxhc3QgPSBNYXRoLm1pbihlbmQgLSBvZmZzZXQsIEJJVFNfUEVSX1BBR0UpCiAgICAgIGNvbnN0IHJhbmdlID0gbGFzdCAtIGoKCiAgICAgIGlmIChwKSBwLnNldFJhbmdlKGosIGxhc3QsIHZhbCkKCiAgICAgIGogPSAwCiAgICAgIGkrKwogICAgICBzdGFydCArPSByYW5nZQogICAgfQogIH0KCiAgZmluZEZpcnN0KHZhbCwgcG9zaXRpb24pIHsKICAgIGxldCBqID0gcG9zaXRpb24gJiAoQklUU19QRVJfU0VHTUVOVCAtIDEpCiAgICBsZXQgaSA9IChwb3NpdGlvbiAtIGopIC8gQklUU19QRVJfU0VHTUVOVAoKICAgIHdoaWxlIChpIDwgdGhpcy5fbWF4U2VnbWVudHMpIHsKICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZ21lbnRzLmdldChpKQoKICAgICAgbGV0IGluZGV4ID0gLTEKCiAgICAgIGlmIChzKSBpbmRleCA9IHMuZmluZEZpcnN0KHZhbCwgaikKICAgICAgZWxzZSBpZiAoIXZhbCkgaW5kZXggPSBqCgogICAgICBpZiAoaW5kZXggIT09IC0xKSByZXR1cm4gaSAqIEJJVFNfUEVSX1NFR01FTlQgKyBpbmRleAoKICAgICAgaiA9IDAKICAgICAgaSsrCiAgICB9CgogICAgLy8gRm9yIHRoZSB2YWwgPT09IGZhbHNlIGNhc2UsIHdlIGFsd2F5cyByZXR1cm4gYXQgbGVhc3QKICAgIC8vIHRoZSAncG9zaXRpb24nLCBhbHNvIGlmIG5vdGhpbmcgd2FzIGZvdW5kCiAgICByZXR1cm4gdmFsID8gLTEgOiBNYXRoLm1heChwb3NpdGlvbiwgdGhpcy5fbWF4U2VnbWVudHMgKiBCSVRTX1BFUl9TRUdNRU5UKQogIH0KCiAgZmlyc3RTZXQocG9zaXRpb24pIHsKICAgIHJldHVybiB0aGlzLmZpbmRGaXJzdCh0cnVlLCBwb3NpdGlvbikKICB9CgogIGZpcnN0VW5zZXQocG9zaXRpb24pIHsKICAgIHJldHVybiB0aGlzLmZpbmRGaXJzdChmYWxzZSwgcG9zaXRpb24pCiAgfQoKICBmaW5kTGFzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICBsZXQgaiA9IHBvc2l0aW9uICYgKEJJVFNfUEVSX1NFR01FTlQgLSAxKQogICAgbGV0IGkgPSAocG9zaXRpb24gLSBqKSAvIEJJVFNfUEVSX1NFR01FTlQKCiAgICB3aGlsZSAoaSA+PSAwKSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLl9zZWdtZW50cy5nZXQoaSkKCiAgICAgIGxldCBpbmRleCA9IC0xCgogICAgICBpZiAocykgaW5kZXggPSBzLmZpbmRMYXN0KHZhbCwgaikKICAgICAgZWxzZSBpZiAoIXZhbCkgaW5kZXggPSBqCgogICAgICBpZiAoaW5kZXggIT09IC0xKSByZXR1cm4gaSAqIEJJVFNfUEVSX1NFR01FTlQgKyBpbmRleAoKICAgICAgaiA9IEJJVFNfUEVSX1NFR01FTlQgLSAxCiAgICAgIGktLQogICAgfQoKICAgIHJldHVybiAtMQogIH0KCiAgbGFzdFNldChwb3NpdGlvbikgewogICAgcmV0dXJuIHRoaXMuZmluZExhc3QodHJ1ZSwgcG9zaXRpb24pCiAgfQoKICBsYXN0VW5zZXQocG9zaXRpb24pIHsKICAgIHJldHVybiB0aGlzLmZpbmRMYXN0KGZhbHNlLCBwb3NpdGlvbikKICB9CgogIGluc2VydChzdGFydCwgYml0ZmllbGQpIHsKICAgIGlmIChzdGFydCAlIDMyICE9PSAwKSByZXR1cm4gZmFsc2UKCiAgICBsZXQgbGVuZ3RoID0gYml0ZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgICBsZXQgaiA9IHN0YXJ0ICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgbGV0IGkgPSAoc3RhcnQgLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICB3aGlsZSAobGVuZ3RoID4gMCkgewogICAgICBsZXQgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgICAgaWYgKCFwKSB7CiAgICAgICAgY29uc3QgayA9IE1hdGguZmxvb3IoaSAvIFBBR0VTX1BFUl9TRUdNRU5UKQogICAgICAgIGNvbnN0IHMgPSB0aGlzLl9zZWdtZW50cy5nZXQoaykgfHwgdGhpcy5fc2VnbWVudHMuc2V0KGssIG5ldyBSZW1vdGVCaXRmaWVsZFNlZ21lbnQoaykpCiAgICAgICAgaWYgKHRoaXMuX21heFNlZ21lbnRzIDw9IGspIHRoaXMuX21heFNlZ21lbnRzID0gayArIDEKCiAgICAgICAgcCA9IHRoaXMuX3BhZ2VzLnNldChpLCBuZXcgUmVtb3RlQml0ZmllbGRQYWdlKGksIG5ldyBVaW50MzJBcnJheShXT1JEU19QRVJfUEFHRSksIHMpKQogICAgICB9CgogICAgICBjb25zdCBlbmQgPSBNYXRoLm1pbihqICsgbGVuZ3RoLCBCSVRTX1BFUl9QQUdFKQogICAgICBjb25zdCByYW5nZSA9IGVuZCAtIGoKCiAgICAgIHAuaW5zZXJ0KGosIGJpdGZpZWxkLnN1YmFycmF5KDAsIHJhbmdlIC8gMzIpKQoKICAgICAgYml0ZmllbGQgPSBiaXRmaWVsZC5zdWJhcnJheShyYW5nZSAvIDMyKQoKICAgICAgaiA9IDAKICAgICAgaSsrCiAgICAgIGxlbmd0aCAtPSByYW5nZQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBjbGVhcihzdGFydCwgYml0ZmllbGQpIHsKICAgIGlmIChzdGFydCAlIDMyICE9PSAwKSByZXR1cm4gZmFsc2UKCiAgICBsZXQgbGVuZ3RoID0gYml0ZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgICBsZXQgaiA9IHN0YXJ0ICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgbGV0IGkgPSAoc3RhcnQgLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICB3aGlsZSAobGVuZ3RoID4gMCkgewogICAgICBsZXQgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgICAgaWYgKCFwKSB7CiAgICAgICAgY29uc3QgayA9IE1hdGguZmxvb3IoaSAvIFBBR0VTX1BFUl9TRUdNRU5UKQogICAgICAgIGNvbnN0IHMgPSB0aGlzLl9zZWdtZW50cy5nZXQoaykgfHwgdGhpcy5fc2VnbWVudHMuc2V0KGssIG5ldyBSZW1vdGVCaXRmaWVsZFNlZ21lbnQoaykpCiAgICAgICAgaWYgKHRoaXMuX21heFNlZ21lbnRzIDw9IGspIHRoaXMuX21heFNlZ21lbnRzID0gayArIDEKCiAgICAgICAgcCA9IHRoaXMuX3BhZ2VzLnNldChpLCBuZXcgUmVtb3RlQml0ZmllbGRQYWdlKGksIG5ldyBVaW50MzJBcnJheShXT1JEU19QRVJfUEFHRSksIHMpKQogICAgICB9CgogICAgICBjb25zdCBlbmQgPSBNYXRoLm1pbihqICsgbGVuZ3RoLCBCSVRTX1BFUl9QQUdFKQogICAgICBjb25zdCByYW5nZSA9IGVuZCAtIGoKCiAgICAgIHAuY2xlYXIoaiwgYml0ZmllbGQuc3ViYXJyYXkoMCwgcmFuZ2UgLyAzMikpCgogICAgICBiaXRmaWVsZCA9IGJpdGZpZWxkLnN1YmFycmF5KHJhbmdlIC8gMzIpCgogICAgICBqID0gMAogICAgICBpKysKICAgICAgbGVuZ3RoIC09IHJhbmdlCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9Cn0KLyogREVWIERPQ1MKICBFdmVyeSBoeXBlcmNvcmUgaGFzIG9uZSBSZXBsaWNhdG9yIG9iamVjdCBtYW5hZ2luZyBpdHMgY29ubmVjdGlvbnMgdG8gb3RoZXIgcGVlcnMuCiAgVGhlcmUgaXMgb25lIFBlZXIgb2JqZWN0IHBlciBwZWVyIGNvbm5lY3RlZCB0byB0aGUgSHlwZXJjb3JlLgogIEh5cGVyY29yZXMgZG8gbm90IGtub3cgYWJvdXQgb3RoZXIgaHlwZXJjb3Jlcywgc28gd2hlbiBhIHBlZXIgaXMgY29ubmVjdGVkIHRvIG11bHRpcGxlIGNvcmVzLCB0aGVyZSBleGlzdHMgb25lIFBlZXIgb2JqZWN0IHBlciBjb3JlLgoKICBIeXBlcmNvcmUgaW5kaWNhdGVzIGJsb2NrIHNob3VsZCBiZSBkb3dubG9hZGVkIHRocm91Z2ggbWV0aG9kcyBsaWtlIFJlcGxpY2F0b3IuYWRkUmFuZ2Ugb3IgUmVwbGljYXRvci5hZGRCbG9jawogIEh5cGVyY29yZSBjYWxscyBSZXBsaWNhdG9yLnVwZGF0ZUFjdGl2aXR5IGV2ZXJ5IHRpbWUgYSBoeXBlcmNvcmUgc2Vzc2lvbiBvcGVucy9jbG9zZXMKICBSZXBsaWNhdG9yLnVwZGF0ZUFjdGl2aXR5IGVuc3VyZXMgdGhlIEh5cGVyY29yZSBpcyBkb3dubG9hZGluZyBibG9ja3MgYXMgZXhwZWN0ZWQKICBSZXBsaWNhdG9yIGtlZXBzIHRyYWNrIG9mOgogICAgLSBXaGljaCBibG9ja3MgbmVlZCB0byBiZSBkb3dubG9hZGVkIChSZXBsaWNhdG9yLl9ibG9ja3MpCiAgICAtIFdoaWNoIGJsb2NrcyBjdXJyZW50bHkgaGF2ZSBpbmZsaWdodCByZXF1ZXN0cyAoUmVwbGljYXRvci5faW5mbGlnaHQpCgogIEJsb2NrcyBhcmUgcmVxdWVzdGVkIGZyb20gcmVtb3RlIHBlZXJzIGJ5IFBlZXIgb2JqZWN0cy4gVGhlIGZsb3cgaXM6CiAgICAtIFRoZSByZXBsaWNhdG9yJ3MgdXBkYXRlUGVlciBtZXRob2QgZ2V0cyBjYWxsZWQKICAgIC0gVGhlIHJlcGxpY2F0b3IgZGV0ZWN0cyB3aGV0aGVyIHRoZSBQZWVyIGNhbiBhY2NlcHQgbW9yZSByZXF1ZXN0cyAoZm9yIGV4YW1wbGUgYnkgY2hlY2tpbmcgaWYgaXQncyBtYXhlZCBvdXQgb24gaW5mbGlnaHQgYmxvY2tzKQogICAgLSBUaGUgcmVwbGljYXRvciB0aGVuIHRlbGxzIHRoZSBQZWVyIHdoYXQgdG8gcmVxdWVzdCAoZS5nLiBQZWVyX3JlcXVlc3RSYW5nZSBvciBQZWVyLl9yZXF1ZXN0QmxvY2sgbWV0aG9kcykKCiAgVGhlIFBlZXIgb2JqZWN0IGlzIHJlc3BvbnNpYmxlIGZvciB0cmFja2luZwogICAgLSBXaGljaCBibG9ja3MgZG9lcyB0aGUgUGVlciBoYXZlIGF2YWlsYWJsZSAodHJhY2tlZCBpbiByZW1vdGVCaXRmaWVsZCkKICAgIC0gV2hpY2ggYmxvY2tzIGFyZSB5b3UgYWN0aXZlbHkgbG9va2luZyBmb3IgZnJvbSB0aGlzIHBlZXIgKHRyYWNrZWQgaW4gbWlzc2luZ0Jsb2NrcykKICAgIC0gSG93IG1hbnkgYmxvY2tzIGFyZSBjdXJyZW50bHkgaW5mbGlnaHQgKHRyYWNrZWQgaW4gaW5mbGlnaHQpCiAgVGhlIFBlZXIgdXNlcyB0aGlzIGluZm9ybWF0aW9uIHRvIGRlY2lkZSB3aGljaCBibG9ja3MgdG8gcmVxdWVzdCBmcm9tIHRoZSBwZWVyIGluIHJlc3BvbnNlIHRvIF9yZXF1ZXN0UmFuZ2UgcmVxdWVzdHMgYW5kIHRoZSBsaWtlLgoqLwoKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCBSYW5kb21JdGVyYXRvciA9IHJlcXVpcmUoJ3JhbmRvbS1hcnJheS1pdGVyYXRvcicpCmNvbnN0IGZsYXRUcmVlID0gcmVxdWlyZSgnZmxhdC10cmVlJykKY29uc3QgTXV0ZXggPSByZXF1aXJlKCcuL211dGV4JykKY29uc3QgUmVjZWl2ZXJRdWV1ZSA9IHJlcXVpcmUoJy4vcmVjZWl2ZXItcXVldWUnKQpjb25zdCBIb3Rzd2FwUXVldWUgPSByZXF1aXJlKCcuL2hvdHN3YXAtcXVldWUnKQpjb25zdCBSZW1vdGVCaXRmaWVsZCA9IHJlcXVpcmUoJy4vcmVtb3RlLWJpdGZpZWxkJykKY29uc3QgeyBNZXJrbGVUcmVlIH0gPSByZXF1aXJlKCcuL21lcmtsZS10cmVlJykKY29uc3QgewogIFJFUVVFU1RfQ0FOQ0VMTEVELAogIFJFUVVFU1RfVElNRU9VVCwKICBJTlZBTElEX0NBUEFCSUxJVFksCiAgU05BUFNIT1RfTk9UX0FWQUlMQUJMRSwKICBBU1NFUlRJT04KfSA9IHJlcXVpcmUoJ2h5cGVyY29yZS1lcnJvcnMnKQpjb25zdCBtID0gcmVxdWlyZSgnLi9tZXNzYWdlcycpCmNvbnN0IGNhcHMgPSByZXF1aXJlKCcuL2NhcHMnKQoKY29uc3QgREVGQVVMVF9NQVhfSU5GTElHSFQgPSBbMTYsIDUxMl0KY29uc3QgU0NBTEVfTEFURU5DWSA9IDUwCmNvbnN0IERFRkFVTFRfU0VHTUVOVF9TSVpFID0gMjU2ICogMTAyNCAqIDggLy8gMjU2IEtpQiBpbiBiaXRzCmNvbnN0IE5PVF9ET1dOTE9BRElOR19TTEFDSyA9ICgyMDAwMCArIE1hdGgucmFuZG9tKCkgKiAyMDAwMCkgfCAwCmNvbnN0IE1BWF9QRUVSU19VUEdSQURFID0gMwpjb25zdCBMQVNUX0JMT0NLUyA9IDI1Ngpjb25zdCBNQVhfUkVNT1RFX1NFR01FTlRTID0gMjA0OAoKY29uc3QgTUFYX1JBTkdFUyA9IDY0Cgpjb25zdCBOT1RfQVZBSUxBQkxFID0gMQpjb25zdCBJTlZBTElEX1JFUVVFU1QgPSAyCmNvbnN0IE1BWF9JTlZBTElEX1JFUVVFU1RTID0gNjQKY29uc3QgTUFYX0JBQ0tPRkZTID0gTUFYX0lOVkFMSURfUkVRVUVTVFMgLyAyCgpjb25zdCBQUklPUklUWSA9IHsKICBOT1JNQUw6IDAsCiAgSElHSDogMSwKICBWRVJZX0hJR0g6IDIsCiAgQ0FOQ0VMTEVEOiAyNTUgLy8gcmVzZXJ2ZWQgdG8gbWFyayBjYW5jZWxsYXRpb24KfQoKY2xhc3MgQXR0YWNoYWJsZSB7CiAgY29uc3RydWN0b3IocmVwbGljYXRvcikgewogICAgdGhpcy5yZXBsaWNhdG9yID0gcmVwbGljYXRvcgogICAgdGhpcy5yZXNvbHZlZCA9IGZhbHNlCiAgICB0aGlzLnByb2Nlc3NpbmcgPSBmYWxzZQogICAgdGhpcy5yZWZzID0gW10KICB9CgogIGF0dGFjaChzZXNzaW9uKSB7CiAgICBjb25zdCByID0gewogICAgICBjb250ZXh0OiB0aGlzLAogICAgICBzZXNzaW9uLAogICAgICBzaW5kZXg6IDAsCiAgICAgIHJpbmRleDogMCwKICAgICAgc25hcHNob3Q6IHRydWUsCiAgICAgIHJlc29sdmU6IG51bGwsCiAgICAgIHJlamVjdDogbnVsbCwKICAgICAgcHJvbWlzZTogbnVsbCwKICAgICAgdGltZW91dDogbnVsbAogICAgfQoKICAgIHIuc2luZGV4ID0gc2Vzc2lvbi5wdXNoKHIpIC0gMQogICAgci5yaW5kZXggPSB0aGlzLnJlZnMucHVzaChyKSAtIDEKICAgIHIucHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgci5yZXNvbHZlID0gcmVzb2x2ZQogICAgICByLnJlamVjdCA9IHJlamVjdAogICAgfSkKCiAgICByZXR1cm4gcgogIH0KCiAgZGV0YWNoKHIsIGVyciA9IG51bGwpIHsKICAgIGlmIChyLmNvbnRleHQgIT09IHRoaXMpIHJldHVybiBmYWxzZQoKICAgIHRoaXMuX2RldGFjaChyKQogICAgdGhpcy5fY2FuY2VsKHIsIGVycikKICAgIHRoaXMuZ2MoKQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfZGV0YWNoKHIpIHsKICAgIGNvbnN0IHJoID0gdGhpcy5yZWZzLnBvcCgpCiAgICBjb25zdCBzaCA9IHIuc2Vzc2lvbi5wb3AoKQoKICAgIGlmIChyLnJpbmRleCA8IHRoaXMucmVmcy5sZW5ndGgpIHRoaXMucmVmc1socmgucmluZGV4ID0gci5yaW5kZXgpXSA9IHJoCiAgICBpZiAoci5zaW5kZXggPCByLnNlc3Npb24ubGVuZ3RoKSByLnNlc3Npb25bKHNoLnNpbmRleCA9IHIuc2luZGV4KV0gPSBzaAoKICAgIGRlc3Ryb3lSZXF1ZXN0VGltZW91dChyKQogICAgci5jb250ZXh0ID0gbnVsbAoKICAgIHJldHVybiByCiAgfQoKICBnYygpIHsKICAgIGlmICh0aGlzLnJlZnMubGVuZ3RoID09PSAwICYmICF0aGlzLnByb2Nlc3NpbmcpIHRoaXMuX3VucmVmKCkKICB9CgogIHByb2Nlc3NlZCgpIHsKICAgIHRoaXMucHJvY2Vzc2luZyA9IGZhbHNlCiAgICB0aGlzLmdjKCkKICB9CgogIF9jYW5jZWwociwgZXJyKSB7CiAgICByLnJlamVjdChlcnIgfHwgUkVRVUVTVF9DQU5DRUxMRUQoKSkKICB9CgogIF91bnJlZigpIHsKICAgIC8vIG92ZXJ3cml0ZSBtZQogIH0KCiAgcmVzb2x2ZSh2YWwpIHsKICAgIHRoaXMucmVzb2x2ZWQgPSB0cnVlCiAgICB3aGlsZSAodGhpcy5yZWZzLmxlbmd0aCA+IDApIHsKICAgICAgdGhpcy5fZGV0YWNoKHRoaXMucmVmc1t0aGlzLnJlZnMubGVuZ3RoIC0gMV0pLnJlc29sdmUodmFsKQogICAgfQogIH0KCiAgcmVqZWN0KGVycikgewogICAgdGhpcy5yZXNvbHZlZCA9IHRydWUKICAgIHdoaWxlICh0aGlzLnJlZnMubGVuZ3RoID4gMCkgewogICAgICB0aGlzLl9kZXRhY2godGhpcy5yZWZzW3RoaXMucmVmcy5sZW5ndGggLSAxXSkucmVqZWN0KGVycikKICAgIH0KICB9CgogIHNldFRpbWVvdXQociwgbXMpIHsKICAgIGRlc3Ryb3lSZXF1ZXN0VGltZW91dChyKQogICAgci50aW1lb3V0ID0gc2V0VGltZW91dChvbnJlcXVlc3R0aW1lb3V0LCBtcywgcikKICB9Cn0KCmNsYXNzIEJsb2NrUmVxdWVzdCBleHRlbmRzIEF0dGFjaGFibGUgewogIGNvbnN0cnVjdG9yKHJlcGxpY2F0b3IsIHRyYWNrZXIsIGluZGV4LCBwcmlvcml0eSkgewogICAgc3VwZXIocmVwbGljYXRvcikKCiAgICB0aGlzLmluZGV4ID0gaW5kZXgKICAgIHRoaXMucHJpb3JpdHkgPSBwcmlvcml0eQogICAgdGhpcy5pbmZsaWdodCA9IFtdCiAgICB0aGlzLnF1ZXVlZCA9IGZhbHNlCiAgICB0aGlzLmhvdHN3YXAgPSBudWxsCiAgICB0aGlzLnRyYWNrZXIgPSB0cmFja2VyCiAgfQoKICBfdW5yZWYoKSB7CiAgICB0aGlzLnF1ZXVlZCA9IGZhbHNlCgogICAgZm9yIChjb25zdCByZXEgb2YgdGhpcy5pbmZsaWdodCkgewogICAgICByZXEucGVlci5fY2FuY2VsUmVxdWVzdChyZXEpCiAgICB9CgogICAgdGhpcy50cmFja2VyLnJlbW92ZSh0aGlzLmluZGV4KQogICAgcmVtb3ZlSG90c3dhcCh0aGlzKQogIH0KfQoKY2xhc3MgUmFuZ2VSZXF1ZXN0IGV4dGVuZHMgQXR0YWNoYWJsZSB7CiAgY29uc3RydWN0b3IocmVwbGljYXRvciwgcmFuZ2VzLCBzdGFydCwgZW5kLCBsaW5lYXIsIGlmQXZhaWxhYmxlLCBibG9ja3MpIHsKICAgIHN1cGVyKHJlcGxpY2F0b3IpCgogICAgdGhpcy5zdGFydCA9IHN0YXJ0CiAgICB0aGlzLmVuZCA9IGVuZAogICAgdGhpcy5saW5lYXIgPSBsaW5lYXIKICAgIHRoaXMuaWZBdmFpbGFibGUgPSBpZkF2YWlsYWJsZQogICAgdGhpcy5ibG9ja3MgPSBibG9ja3MKICAgIHRoaXMucmFuZ2VzID0gcmFuZ2VzCiAgICByYW5nZXMucHVzaCh0aGlzKQoKICAgIGlmICh0aGlzLmVuZCA9PT0gLTEpIHsKICAgICAgdGhpcy5yZXBsaWNhdG9yLl9hbHdheXNMYXRlc3RCbG9jaysrCiAgICB9CgogICAgLy8gQXMgcGFzc2VkIGJ5IHRoZSB1c2VyLCBpbW11dAogICAgdGhpcy51c2VyU3RhcnQgPSBzdGFydAogICAgdGhpcy51c2VyRW5kID0gZW5kCiAgfQoKICBfdW5yZWYoKSB7CiAgICBjb25zdCByYW5nZUluZGV4ID0gdGhpcy5yYW5nZXMuaW5kZXhPZih0aGlzKQogICAgaWYgKHJhbmdlSW5kZXggPT09IC0xKSByZXR1cm4KCiAgICBjb25zdCBoID0gdGhpcy5yYW5nZXMucG9wKCkKICAgIGlmIChoICE9PSB0aGlzKSB7CiAgICAgIHRoaXMucmFuZ2VzW3JhbmdlSW5kZXhdID0gaAogICAgfQoKICAgIGlmICh0aGlzLmVuZCA9PT0gLTEpIHsKICAgICAgdGhpcy5yZXBsaWNhdG9yLl9hbHdheXNMYXRlc3RCbG9jay0tCiAgICB9CiAgfQoKICBfY2FuY2VsKHIpIHsKICAgIHIucmVzb2x2ZShmYWxzZSkKICB9Cn0KCmNsYXNzIFVwZ3JhZGVSZXF1ZXN0IGV4dGVuZHMgQXR0YWNoYWJsZSB7CiAgY29uc3RydWN0b3IocmVwbGljYXRvciwgZm9yaywgbGVuZ3RoKSB7CiAgICBzdXBlcihyZXBsaWNhdG9yKQoKICAgIHRoaXMuZm9yayA9IGZvcmsKICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLmluZmxpZ2h0ID0gW10KICB9CgogIF91bnJlZigpIHsKICAgIGlmICh0aGlzLnJlcGxpY2F0b3IuZWFnZXJVcGdyYWRlID09PSB0cnVlIHx8IHRoaXMuaW5mbGlnaHQubGVuZ3RoID4gMCkgcmV0dXJuCiAgICB0aGlzLnJlcGxpY2F0b3IuX3VwZ3JhZGUgPSBudWxsCiAgfQoKICBfY2FuY2VsKHIpIHsKICAgIHIucmVzb2x2ZShmYWxzZSkKICB9Cn0KCmNsYXNzIFNlZWtSZXF1ZXN0IGV4dGVuZHMgQXR0YWNoYWJsZSB7CiAgY29uc3RydWN0b3IocmVwbGljYXRvciwgc2Vla3MsIHNlZWtlcikgewogICAgc3VwZXIocmVwbGljYXRvcikKCiAgICB0aGlzLnNlZWtlciA9IHNlZWtlcgogICAgdGhpcy5pbmZsaWdodCA9IFtdCiAgICB0aGlzLnNlZWtzID0gc2Vla3MKICB9CgogIF91bnJlZigpIHsKICAgIGlmICh0aGlzLmluZmxpZ2h0Lmxlbmd0aCA+IDApIHJldHVybgogICAgY29uc3QgaSA9IHRoaXMuc2Vla3MuaW5kZXhPZih0aGlzKQogICAgaWYgKGkgPT09IC0xKSByZXR1cm4KICAgIGNvbnN0IGggPSB0aGlzLnNlZWtzLnBvcCgpCiAgICBpZiAoaSA8IHRoaXMuc2Vla3MubGVuZ3RoKSB0aGlzLnNlZWtzW2ldID0gaAogIH0KfQoKY2xhc3MgSW5mbGlnaHRUcmFja2VyIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuX3JlcXVlc3RzID0gW10KICAgIHRoaXMuX2ZyZWUgPSBbXQogICAgdGhpcy5fYWN0aXZlID0gMAogIH0KCiAgZ2V0IGlkbGUoKSB7CiAgICByZXR1cm4gdGhpcy5fYWN0aXZlID09PSAwCiAgfQoKICAqW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICBmb3IgKGNvbnN0IHJlcSBvZiB0aGlzLl9yZXF1ZXN0cykgewogICAgICBpZiAocmVxICE9PSBudWxsKSB5aWVsZCByZXEKICAgIH0KICB9CgogIGFkZChyZXEpIHsKICAgIGNvbnN0IGlkID0gdGhpcy5fZnJlZS5sZW5ndGggPyB0aGlzLl9mcmVlLnBvcCgpIDogdGhpcy5fcmVxdWVzdHMucHVzaChudWxsKQogICAgcmVxLmlkID0gaWQKICAgIHRoaXMuX3JlcXVlc3RzW2lkIC0gMV0gPSByZXEKICAgIHRoaXMuX2FjdGl2ZSsrCiAgICByZXR1cm4gcmVxCiAgfQoKICBnZXQoaWQpIHsKICAgIHJldHVybiBpZCA8PSB0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPyB0aGlzLl9yZXF1ZXN0c1tpZCAtIDFdIDogbnVsbAogIH0KCiAgcmVtb3ZlKGlkLCByb3VuZHRyaXApIHsKICAgIGlmIChpZCA+IHRoaXMuX3JlcXVlc3RzLmxlbmd0aCkgcmV0dXJuCiAgICBpZiAodGhpcy5fcmVxdWVzdHNbaWQgLSAxXSkgdGhpcy5fYWN0aXZlLS0KICAgIHRoaXMuX3JlcXVlc3RzW2lkIC0gMV0gPSBudWxsCiAgICBpZiAocm91bmR0cmlwID09PSB0cnVlKSB0aGlzLl9mcmVlLnB1c2goaWQpCiAgfQoKICByZXVzYWJsZShpZCkgewogICAgdGhpcy5fZnJlZS5wdXNoKGlkKQogIH0KfQoKY2xhc3MgQmxvY2tUcmFja2VyIHsKICBjb25zdHJ1Y3RvcihyZXBsaWNhdG9yKSB7CiAgICB0aGlzLl9yZXBsaWNhdG9yID0gcmVwbGljYXRvcgogICAgdGhpcy5fbWFwID0gbmV3IE1hcCgpCiAgfQoKICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLl9tYXAudmFsdWVzKCkKICB9CgogIGlzRW1wdHkoKSB7CiAgICByZXR1cm4gdGhpcy5fbWFwLnNpemUgPT09IDAKICB9CgogIGhhcyhpbmRleCkgewogICAgcmV0dXJuIHRoaXMuX21hcC5oYXMoaW5kZXgpCiAgfQoKICBnZXQoaW5kZXgpIHsKICAgIHJldHVybiB0aGlzLl9tYXAuZ2V0KGluZGV4KSB8fCBudWxsCiAgfQoKICBhZGQoaW5kZXgsIHByaW9yaXR5KSB7CiAgICBsZXQgYiA9IHRoaXMuX21hcC5nZXQoaW5kZXgpCiAgICBpZiAoYikgcmV0dXJuIGIKCiAgICBiID0gbmV3IEJsb2NrUmVxdWVzdCh0aGlzLl9yZXBsaWNhdG9yLCB0aGlzLCBpbmRleCwgcHJpb3JpdHkpCiAgICB0aGlzLl9tYXAuc2V0KGluZGV4LCBiKQoKICAgIHJldHVybiBiCiAgfQoKICByZW1vdmUoaW5kZXgpIHsKICAgIGNvbnN0IGIgPSB0aGlzLmdldChpbmRleCkKICAgIHRoaXMuX21hcC5kZWxldGUoaW5kZXgpCiAgICByZXR1cm4gYgogIH0KfQoKY2xhc3MgUm91bmR0cmlwUXVldWUgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5xdWV1ZSA9IFtdCiAgICB0aGlzLnRpY2sgPSAwCiAgfQoKICBjbGVhcigpIHsKICAgIGNvbnN0IGlkcyA9IG5ldyBBcnJheSh0aGlzLnF1ZXVlLmxlbmd0aCkKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaWRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlkc1tpXSA9IHRoaXMucXVldWVbaV1bMV0KICAgIH0KCiAgICB0aGlzLnF1ZXVlID0gW10KCiAgICByZXR1cm4gaWRzCiAgfQoKICBhZGQoaWQpIHsKICAgIHRoaXMucXVldWUucHVzaChbKyt0aGlzLnRpY2ssIGlkXSkKICB9CgogIGZsdXNoKHRpY2spIHsKICAgIGxldCBmbHVzaGVkID0gbnVsbAoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5xdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICBpZiAodGhpcy5xdWV1ZVtpXVswXSA+IHRpY2spIGJyZWFrCiAgICAgIGlmIChmbHVzaGVkID09PSBudWxsKSBmbHVzaGVkID0gW10KICAgICAgZmx1c2hlZC5wdXNoKHRoaXMucXVldWVbaV1bMV0pCiAgICB9CgogICAgaWYgKGZsdXNoZWQgIT09IG51bGwpIHRoaXMucXVldWUuc3BsaWNlKDAsIGZsdXNoZWQubGVuZ3RoKQogICAgcmV0dXJuIGZsdXNoZWQKICB9Cn0KCmNsYXNzIFByb29mUmVxdWVzdCB7CiAgY29uc3RydWN0b3IobXNnLCBwcm9vZiwgYmxvY2ssIG1hbmlmZXN0KSB7CiAgICB0aGlzLm1zZyA9IG1zZwogICAgdGhpcy5wcm9vZiA9IHByb29mCiAgICB0aGlzLmJsb2NrID0gYmxvY2sKICAgIHRoaXMubWFuaWZlc3QgPSBtYW5pZmVzdAogIH0KCiAgYXN5bmMgZnVsZmlsbCgpIHsKICAgIGlmICh0aGlzLnByb29mID09PSBudWxsKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IFtwcm9vZiwgYmxvY2tdID0gYXdhaXQgUHJvbWlzZS5hbGwoW3RoaXMucHJvb2Yuc2V0dGxlKCksIHRoaXMuYmxvY2tdKQoKICAgIGlmICh0aGlzLm1hbmlmZXN0KSBwcm9vZi5tYW5pZmVzdCA9IHRoaXMubWFuaWZlc3QKICAgIGlmICghYmxvY2sgJiYgcHJvb2YuYmxvY2spIHJldHVybiBudWxsCgogICAgaWYgKGJsb2NrKSBwcm9vZi5ibG9jay52YWx1ZSA9IGJsb2NrCiAgICByZXR1cm4gcHJvb2YKICB9Cn0KCmNsYXNzIFBlZXIgewogIGNvbnN0cnVjdG9yKHJlcGxpY2F0b3IsIHByb3RvbXV4LCBjaGFubmVsLCBpbmZsaWdodFJhbmdlKSB7CiAgICB0aGlzLmNvcmUgPSByZXBsaWNhdG9yLmNvcmUKICAgIHRoaXMucmVwbGljYXRvciA9IHJlcGxpY2F0b3IKICAgIHRoaXMuc3RyZWFtID0gcHJvdG9tdXguc3RyZWFtCiAgICB0aGlzLnByb3RvbXV4ID0gcHJvdG9tdXgKICAgIHRoaXMucmVtb3RlUHVibGljS2V5ID0gdGhpcy5zdHJlYW0ucmVtb3RlUHVibGljS2V5CiAgICB0aGlzLnJlbW90ZVN1cHBvcnRzU2Vla3MgPSBmYWxzZQogICAgdGhpcy5pbmZsaWdodFJhbmdlID0gaW5mbGlnaHRSYW5nZQogICAgdGhpcy5yZW1vdGVTZWdtZW50c1dhbnRlZCA9IG5ldyBTZXQoKQogICAgdGhpcy5mdWxseURvd25sb2FkZWRTaWduYWxlZCA9IGZhbHNlCgogICAgdGhpcy5wYXVzZWQgPSBmYWxzZQogICAgdGhpcy5yZW1vdmVkID0gZmFsc2UKCiAgICB0aGlzLmNoYW5uZWwgPSBjaGFubmVsCiAgICB0aGlzLmNoYW5uZWwudXNlckRhdGEgPSB0aGlzCgogICAgdGhpcy53aXJlU3luYyA9IHRoaXMuY2hhbm5lbC5tZXNzYWdlc1swXQogICAgdGhpcy53aXJlUmVxdWVzdCA9IHRoaXMuY2hhbm5lbC5tZXNzYWdlc1sxXQogICAgdGhpcy53aXJlQ2FuY2VsID0gdGhpcy5jaGFubmVsLm1lc3NhZ2VzWzJdCiAgICB0aGlzLndpcmVEYXRhID0gdGhpcy5jaGFubmVsLm1lc3NhZ2VzWzNdCiAgICB0aGlzLndpcmVOb0RhdGEgPSB0aGlzLmNoYW5uZWwubWVzc2FnZXNbNF0KICAgIHRoaXMud2lyZVdhbnQgPSB0aGlzLmNoYW5uZWwubWVzc2FnZXNbNV0KICAgIHRoaXMud2lyZVVud2FudCA9IHRoaXMuY2hhbm5lbC5tZXNzYWdlc1s2XQogICAgdGhpcy53aXJlQml0ZmllbGQgPSB0aGlzLmNoYW5uZWwubWVzc2FnZXNbN10KICAgIHRoaXMud2lyZVJhbmdlID0gdGhpcy5jaGFubmVsLm1lc3NhZ2VzWzhdCiAgICB0aGlzLndpcmVFeHRlbnNpb24gPSB0aGlzLmNoYW5uZWwubWVzc2FnZXNbOV0KCiAgICAvLyBTYW1lIHN0YXRzIGFzIHJlcGxpY2F0b3IsIGJ1dCBmb3IgdGhpcyBzcGVjaWZpYyBwZWVyCiAgICB0aGlzLnN0YXRzID0gewogICAgICB3aXJlU3luYzogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZVJlcXVlc3Q6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVDYW5jZWw6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVEYXRhOiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlV2FudDogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZUJpdGZpZWxkOiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlUmFuZ2U6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVFeHRlbnNpb246IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIGhvdHN3YXBzOiAwLAogICAgICBpbnZhbGlkRGF0YTogMCwKICAgICAgaW52YWxpZFJlcXVlc3RzOiAwLAogICAgICBiYWNrb2ZmczogMAogICAgfQoKICAgIHRoaXMucmVjZWl2ZXJRdWV1ZSA9IG5ldyBSZWNlaXZlclF1ZXVlKCkKICAgIHRoaXMucmVjZWl2ZXJCdXN5ID0gZmFsc2UKCiAgICAvLyBtb3N0IG9mdGVuIG5vdCB1c2VkLCBzbyBtYWRlIG9uIGRlbWFuZAogICAgdGhpcy5yb3VuZHRyaXBRdWV1ZSA9IG51bGwKCiAgICB0aGlzLmluZmxpZ2h0ID0gMAogICAgdGhpcy5kYXRhUHJvY2Vzc2luZyA9IDAKCiAgICB0aGlzLmNhblVwZ3JhZGUgPSB0cnVlCgogICAgdGhpcy5uZWVkc1N5bmMgPSBmYWxzZQogICAgdGhpcy5zeW5jc1Byb2Nlc3NpbmcgPSAwCiAgICB0aGlzLmxhc3RVcGdyYWRhYmxlTGVuZ3RoID0gMAogICAgdGhpcy5sYXN0VXBncmFkYWJsZUZvcmsgPSAwCgogICAgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCA9IDAKCiAgICAvLyBUT0RPOiB0d2VhayBwaXBlbGluaW5nIHNvIHRoYXQgZGF0YSBzZW50IEJFRk9SRSByZW1vdGVPcGVuZWQgaXMgbm90IGNhcCB2ZXJpZmllZCEKICAgIC8vIHdlIG1pZ2h0IHdhbm5hIHR3ZWFrIHRoYXQgd2l0aCBzb21lIGNyeXB0bywgaWUgdXNlIHRoZSBjYXAgdG8gZW5jcnlwdCBpdC4uLgogICAgLy8gb3IganVzdCBiZSBhd2FyZSBvZiB0aGF0LCB0byBvbmx5IHB1c2ggbm9uIGxlYWt5IGRhdGEKCiAgICB0aGlzLnJlbW90ZU9wZW5lZCA9IGZhbHNlCiAgICB0aGlzLnJlbW90ZUJpdGZpZWxkID0gbmV3IFJlbW90ZUJpdGZpZWxkKCkKICAgIHRoaXMubWlzc2luZ0Jsb2NrcyA9IG5ldyBSZW1vdGVCaXRmaWVsZCgpCgogICAgdGhpcy5wdXNoZWRMZW5ndGggPSAwCgogICAgdGhpcy5yZW1vdGVGb3JrID0gMAogICAgdGhpcy5yZW1vdGVMZW5ndGggPSAwCiAgICB0aGlzLnJlbW90ZUNhblVwZ3JhZGUgPSBmYWxzZQogICAgdGhpcy5yZW1vdGVVcGxvYWRpbmcgPSB0cnVlCiAgICB0aGlzLnJlbW90ZURvd25sb2FkaW5nID0gdHJ1ZQogICAgdGhpcy5yZW1vdGVTeW5jZWQgPSBmYWxzZQogICAgdGhpcy5yZW1vdGVIYXNNYW5pZmVzdCA9IGZhbHNlCiAgICB0aGlzLnJlbW90ZUFsbG93UHVzaCA9IGZhbHNlCiAgICB0aGlzLnJlbW90ZVJlcXVlc3RzID0gbmV3IE1hcCgpCgogICAgdGhpcy5zZWdtZW50c1dhbnRlZCA9IG5ldyBTZXQoKQogICAgdGhpcy5icm9hZGNhc3RlZE5vblNwYXJzZSA9IGZhbHNlCgogICAgdGhpcy5sZW5ndGhBY2tlZCA9IDAKCiAgICB0aGlzLmV4dGVuc2lvbnMgPSBuZXcgTWFwKCkKICAgIHRoaXMubGFzdEV4dGVuc2lvblNlbnQgPSAnJwogICAgdGhpcy5sYXN0RXh0ZW5zaW9uUmVjdiA9ICcnCgogICAgcmVwbGljYXRvci5faWZBdmFpbGFibGUrKwogICAgcmVwbGljYXRvci5fYWN0aXZlKysKICB9CgogIGdldCByZW1vdGVDb250aWd1b3VzTGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMucmVtb3RlQml0ZmllbGQuZmluZEZpcnN0KGZhbHNlLCB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoKQogIH0KCiAgZ2V0TWF4SW5mbGlnaHQoKSB7CiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbS5yYXdTdHJlYW0KICAgIGlmICghc3RyZWFtLnVkeCkgcmV0dXJuIE1hdGgubWluKHRoaXMuaW5mbGlnaHRSYW5nZVsxXSwgdGhpcy5pbmZsaWdodFJhbmdlWzBdICogMykKCiAgICBjb25zdCBzY2FsZSA9CiAgICAgIHN0cmVhbS5ydHQgPD0gU0NBTEVfTEFURU5DWQogICAgICAgID8gMQogICAgICAgIDogKHN0cmVhbS5ydHQgLyBTQ0FMRV9MQVRFTkNZKSAqIE1hdGgubWluKDEsIDIgLyB0aGlzLnJlcGxpY2F0b3IucGVlcnMubGVuZ3RoKQogICAgcmV0dXJuIE1hdGgubWF4KAogICAgICB0aGlzLmluZmxpZ2h0UmFuZ2VbMF0sCiAgICAgIE1hdGgucm91bmQoTWF0aC5taW4odGhpcy5pbmZsaWdodFJhbmdlWzFdLCB0aGlzLmluZmxpZ2h0UmFuZ2VbMF0gKiBzY2FsZSkpCiAgICApCiAgfQoKICBnZXRNYXhIb3Rzd2FwSW5mbGlnaHQoKSB7CiAgICBjb25zdCBpbmYgPSB0aGlzLmdldE1heEluZmxpZ2h0KCkKICAgIHJldHVybiBNYXRoLm1heCgxNiwgaW5mIC8gMikKICB9CgogIHNpZ25hbFVwZ3JhZGUoKSB7CiAgICBpZiAodGhpcy5mdWxseURvd25sb2FkZWRTaWduYWxlZCAmJiAhdGhpcy5yZXBsaWNhdG9yLmZ1bGx5RG93bmxvYWRlZCgpKSB7CiAgICAgIHRoaXMuZnVsbHlEb3dubG9hZGVkU2lnbmFsZWQgPSBmYWxzZQogICAgfQogICAgaWYgKHRoaXMuX3Nob3VsZFVwZGF0ZUNhblVwZ3JhZGUoKSA9PT0gdHJ1ZSkgdGhpcy5fdXBkYXRlQ2FuVXBncmFkZUFuZFN5bmMoKQogICAgZWxzZSB0aGlzLnNlbmRTeW5jKCkKICB9CgogIF9tYXJrSW5mbGlnaHQoaW5kZXgpIHsKICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5zZXQoaW5kZXgsIGZhbHNlKQogIH0KCiAgYnJvYWRjYXN0UmFuZ2Uoc3RhcnQsIGxlbmd0aCwgZHJvcCkgewogICAgaWYgKCF0aGlzLmlzQWN0aXZlKCkpIHJldHVybgoKICAgIGlmIChkcm9wKSB0aGlzLl91bmNsZWFyTG9jYWxSYW5nZShzdGFydCwgbGVuZ3RoKQogICAgZWxzZSB0aGlzLl9jbGVhckxvY2FsUmFuZ2Uoc3RhcnQsIGxlbmd0aCkKCiAgICBjb25zdCBpID0gTWF0aC5mbG9vcihzdGFydCAvIERFRkFVTFRfU0VHTUVOVF9TSVpFKQogICAgY29uc3QgZnVsbHlDb250aWcgPSB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGggPT09IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgKCiAgICBpZiAoCiAgICAgIHN0YXJ0ICsgTEFTVF9CTE9DS1MgPCB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoICYmCiAgICAgICF0aGlzLnJlbW90ZVNlZ21lbnRzV2FudGVkLmhhcyhpKSAmJgogICAgICAhZHJvcCAmJgogICAgICAhZnVsbHlDb250aWcKICAgICkgewogICAgICByZXR1cm4KICAgIH0KCiAgICBsZXQgZm9yY2UgPSBmYWxzZQogICAgaWYgKGZ1bGx5Q29udGlnICYmICFkcm9wKSB7CiAgICAgIHN0YXJ0ID0gMAogICAgICBsZW5ndGggPSB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoCgogICAgICAvLyBBbHdheXMgc2VuZCB0aGUgYnJvYWRjYXN0IHdoZW4gd2Ugc3dpdGNoIGZyb20gc3BhcnNlIHRvIGZ1bGx5IGNvbnRpZ3VvdXMsIHNvIHJlbW90ZSBrbm93cyB0b28KICAgICAgaWYgKCF0aGlzLmZ1bGx5RG93bmxvYWRlZFNpZ25hbGVkKSB7CiAgICAgICAgdGhpcy5mdWxseURvd25sb2FkZWRTaWduYWxlZCA9IHRydWUKICAgICAgICBmb3JjZSA9IHRydWUKICAgICAgfQogICAgfQoKICAgIC8vIFRPRE86IGNvbnNpZGVyIGFsc28gYWRkaW5nIGVhcmx5LXJldHVybnMgb24gdGhlIGRyb3A9PT10cnVlIGNhc2UKICAgIGlmICghZm9yY2UgJiYgIWRyb3ApIHsKICAgICAgLy8gTm8gbmVlZCB0byBicm9hZGNhc3QgaWYgdGhlIHJlbW90ZSBhbHJlYWR5IGhhcyB0aGlzIHJhbmdlCgogICAgICBpZiAodGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCA+PSBzdGFydCArIGxlbmd0aCkgcmV0dXJuCgogICAgICBpZiAobGVuZ3RoID09PSAxKSB7CiAgICAgICAgaWYgKHRoaXMucmVtb3RlQml0ZmllbGQuZ2V0KHN0YXJ0KSkgcmV0dXJuCiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHRoaXMucmVtb3RlQml0ZmllbGQuZmlyc3RVbnNldChzdGFydCkgPj0gc3RhcnQgKyBsZW5ndGgpIHJldHVybgogICAgICB9CiAgICB9CgogICAgdGhpcy53aXJlUmFuZ2Uuc2VuZCh7CiAgICAgIGRyb3AsCiAgICAgIHN0YXJ0LAogICAgICBsZW5ndGgKICAgIH0pCiAgICBpbmNyZW1lbnRUeCh0aGlzLnN0YXRzLndpcmVSYW5nZSwgdGhpcy5yZXBsaWNhdG9yLnN0YXRzLndpcmVSYW5nZSkKICB9CgogIGV4dGVuc2lvbihuYW1lLCBtZXNzYWdlKSB7CiAgICB0aGlzLndpcmVFeHRlbnNpb24uc2VuZCh7IG5hbWU6IG5hbWUgPT09IHRoaXMubGFzdEV4dGVuc2lvblNlbnQgPyAnJyA6IG5hbWUsIG1lc3NhZ2UgfSkKICAgIGluY3JlbWVudFR4KHRoaXMuc3RhdHMud2lyZUV4dGVuc2lvbiwgdGhpcy5yZXBsaWNhdG9yLnN0YXRzLndpcmVFeHRlbnNpb24pCiAgICB0aGlzLmxhc3RFeHRlbnNpb25TZW50ID0gbmFtZQogIH0KCiAgb25leHRlbnNpb24obWVzc2FnZSkgewogICAgY29uc3QgbmFtZSA9IG1lc3NhZ2UubmFtZSB8fCB0aGlzLmxhc3RFeHRlbnNpb25SZWN2CiAgICB0aGlzLmxhc3RFeHRlbnNpb25SZWN2ID0gbmFtZQogICAgY29uc3QgZXh0ID0gdGhpcy5leHRlbnNpb25zLmdldChuYW1lKQogICAgaWYgKGV4dCkgewogICAgICBleHQuX29ubWVzc2FnZSh7IHN0YXJ0OiAwLCBlbmQ6IG1lc3NhZ2UubWVzc2FnZS5ieXRlTGVuZ3RoLCBidWZmZXI6IG1lc3NhZ2UubWVzc2FnZSB9LCB0aGlzKQogICAgfQogIH0KCiAgc2VuZFN5bmMoKSB7CiAgICBpZiAodGhpcy5zeW5jc1Byb2Nlc3NpbmcgIT09IDApIHsKICAgICAgdGhpcy5uZWVkc1N5bmMgPSB0cnVlCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLmNvcmUuc3RhdGUuZm9yayAhPT0gdGhpcy5yZW1vdGVGb3JrKSB7CiAgICAgIHRoaXMuY2FuVXBncmFkZSA9IGZhbHNlCiAgICB9CgogICAgdGhpcy5uZWVkc1N5bmMgPSBmYWxzZQoKICAgIHRoaXMud2lyZVN5bmMuc2VuZCh7CiAgICAgIGZvcms6IHRoaXMuY29yZS5zdGF0ZS5mb3JrLAogICAgICBsZW5ndGg6IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgsCiAgICAgIHJlbW90ZUxlbmd0aDogdGhpcy5jb3JlLnN0YXRlLmZvcmsgPT09IHRoaXMucmVtb3RlRm9yayA/IHRoaXMucmVtb3RlTGVuZ3RoIDogMCwKICAgICAgY2FuVXBncmFkZTogdGhpcy5jYW5VcGdyYWRlLAogICAgICB1cGxvYWRpbmc6IHRydWUsCiAgICAgIGRvd25sb2FkaW5nOiB0aGlzLnJlcGxpY2F0b3IuaXNEb3dubG9hZGluZygpLAogICAgICBoYXNNYW5pZmVzdDogISF0aGlzLmNvcmUuaGVhZGVyLm1hbmlmZXN0ICYmIHRoaXMuY29yZS5jb21wYXQgPT09IGZhbHNlLAogICAgICBhbGxvd1B1c2g6IHRoaXMucmVwbGljYXRvci5hbGxvd1B1c2gKICAgIH0pCiAgICBpbmNyZW1lbnRUeCh0aGlzLnN0YXRzLndpcmVTeW5jLCB0aGlzLnJlcGxpY2F0b3Iuc3RhdHMud2lyZVN5bmMpCiAgfQoKICBvbm9wZW4oeyBzZWVrcywgY2FwYWJpbGl0eSB9KSB7CiAgICBjb25zdCBleHBlY3RlZCA9IGNhcHMucmVwbGljYXRlKAogICAgICB0aGlzLnN0cmVhbS5pc0luaXRpYXRvciA9PT0gZmFsc2UsCiAgICAgIHRoaXMuY29yZS5rZXksCiAgICAgIHRoaXMuc3RyZWFtLmhhbmRzaGFrZUhhc2gKICAgICkKCiAgICBpZiAoYjRhLmVxdWFscyhjYXBhYmlsaXR5LCBleHBlY3RlZCkgIT09IHRydWUpIHsKICAgICAgLy8gVE9ETzogY2hhbmdlIHRoaXMgdG8gYSByZWplY3Rpb24gaW5zdGVhZCwgbGVzcyBsZWFrYWdlCiAgICAgIHRocm93IElOVkFMSURfQ0FQQUJJTElUWSgnUmVtb3RlIHNlbnQgYW4gaW52YWxpZCByZXBsaWNhdGlvbiBjYXBhYmlsaXR5JykKICAgIH0KCiAgICBpZiAodGhpcy5yZW1vdGVPcGVuZWQgPT09IHRydWUpIHJldHVybgogICAgdGhpcy5yZW1vdGVPcGVuZWQgPSB0cnVlCiAgICB0aGlzLnJlbW90ZVN1cHBvcnRzU2Vla3MgPSBzZWVrcwoKICAgIHRoaXMucHJvdG9tdXguY29yaygpCgogICAgdGhpcy5zZW5kU3luYygpCgogICAgY29uc3QgY29udGlnID0gTWF0aC5taW4odGhpcy5jb3JlLnN0YXRlLmxlbmd0aCwgdGhpcy5jb3JlLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoKQogICAgaWYgKGNvbnRpZyA+IDApIHsKICAgICAgdGhpcy5icm9hZGNhc3RSYW5nZSgwLCBjb250aWcsIGZhbHNlKQoKICAgICAgaWYgKGNvbnRpZyA9PT0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkgewogICAgICAgIHRoaXMuYnJvYWRjYXN0ZWROb25TcGFyc2UgPSB0cnVlCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnJlcGxpY2F0b3IuX2lmQXZhaWxhYmxlLS0KICAgIHRoaXMucmVwbGljYXRvci5fYWRkUGVlcih0aGlzKQoKICAgIHRoaXMucHJvdG9tdXgudW5jb3JrKCkKCiAgICB0aGlzLmNvcmUuY2hlY2tJZklkbGUoKQogIH0KCiAgb25jbG9zZShpc1JlbW90ZSkgewogICAgLy8gd2UgbWlnaHQgaGF2ZSBzaWduYWxsZWQgdG8gdGhlIHJlbW90ZSB0aGF0IHdlIGFyZSBkb25lIChpZSBub3QgZG93bmxvYWRpbmcpIGFuZCB0aGUgcmVtb3RlIG1pZ2h0IGFncmVlIG9uIHRoYXQKICAgIC8vIGlmIHRoYXQgaGFwcGVucywgdGhlIGNoYW5uZWwgbWlnaHQgYmUgY2xvc2VkIGJ5IHRoZSByZW1vdGUuIGlmIHNvIGp1c3QgcmVuZWdvdGlhdGUgaXQuCiAgICAvLyBUT0RPOiBhZGQgYSBDTE9TRV9SRUFTT04gdG8gbXV4IHRvIHdlIGNhbiBtYWtlIHRoaXMgY2xlYW5lci4uLgogICAgY29uc3QgcmVvcGVuID0KICAgICAgaXNSZW1vdGUgPT09IHRydWUgJiYKICAgICAgdGhpcy5yZW1vdGVPcGVuZWQgPT09IHRydWUgJiYKICAgICAgdGhpcy5yZW1vdGVEb3dubG9hZGluZyA9PT0gZmFsc2UgJiYKICAgICAgdGhpcy5yZW1vdGVVcGxvYWRpbmcgPT09IHRydWUgJiYKICAgICAgdGhpcy5yZXBsaWNhdG9yLmRvd25sb2FkaW5nID09PSB0cnVlCgogICAgaWYgKHRoaXMucmVtb3RlT3BlbmVkID09PSBmYWxzZSkgewogICAgICB0aGlzLnJlcGxpY2F0b3IuX2lmQXZhaWxhYmxlLS0KICAgICAgdGhpcy5yZXBsaWNhdG9yLnVwZGF0ZUFsbCgpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMucmVtb3RlT3BlbmVkID0gZmFsc2UKICAgIHRoaXMucmVtb3ZlZCA9IHRydWUKICAgIHRoaXMucmVtb3RlUmVxdWVzdHMuY2xlYXIoKSAvLyBjYW5jZWwgYWxsCiAgICB0aGlzLnJlY2VpdmVyUXVldWUuY2xlYXIoKQoKICAgIGlmICh0aGlzLnJvdW5kdHJpcFF1ZXVlICE9PSBudWxsKSB7CiAgICAgIGZvciAoY29uc3QgaWQgb2YgdGhpcy5yb3VuZHRyaXBRdWV1ZS5jbGVhcigpKSB0aGlzLnJlcGxpY2F0b3IuX2luZmxpZ2h0LnJldXNhYmxlKGlkKQogICAgfQoKICAgIHRoaXMucmVwbGljYXRvci5fcmVtb3ZlUGVlcih0aGlzKQoKICAgIGlmIChyZW9wZW4pIHsKICAgICAgdGhpcy5yZXBsaWNhdG9yLl9tYWtlUGVlcih0aGlzLnByb3RvbXV4KQogICAgfQogIH0KCiAgY2xvc2VJZklkbGUoKSB7CiAgICBpZiAodGhpcy5yZW1vdGVEb3dubG9hZGluZyA9PT0gZmFsc2UgJiYgdGhpcy5yZXBsaWNhdG9yLmlzRG93bmxvYWRpbmcoKSA9PT0gZmFsc2UpIHsKICAgICAgLy8gaWRsaW5nLCBzaHV0IGl0IGRvd24uLi4KICAgICAgdGhpcy5jaGFubmVsLmNsb3NlKCkKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIGFzeW5jIG9uc3luYyhtc2cpIHsKICAgIGNvbnN0IHsKICAgICAgZm9yaywKICAgICAgbGVuZ3RoLAogICAgICByZW1vdGVMZW5ndGgsCiAgICAgIGNhblVwZ3JhZGUsCiAgICAgIHVwbG9hZGluZywKICAgICAgZG93bmxvYWRpbmcsCiAgICAgIGhhc01hbmlmZXN0LAogICAgICBhbGxvd1B1c2gKICAgIH0gPSBtc2cKCiAgICBjb25zdCBsZW5ndGhDaGFuZ2VkID0gbGVuZ3RoICE9PSB0aGlzLnJlbW90ZUxlbmd0aAogICAgY29uc3Qgc2FtZUZvcmsgPSBmb3JrID09PSB0aGlzLmNvcmUuc3RhdGUuZm9yawoKICAgIHRoaXMucmVtb3RlU3luY2VkID0gdHJ1ZQogICAgdGhpcy5yZW1vdGVGb3JrID0gZm9yawogICAgdGhpcy5yZW1vdGVMZW5ndGggPSBsZW5ndGgKICAgIHRoaXMucmVtb3RlQ2FuVXBncmFkZSA9IGNhblVwZ3JhZGUKICAgIHRoaXMucmVtb3RlVXBsb2FkaW5nID0gdXBsb2FkaW5nCiAgICB0aGlzLnJlbW90ZURvd25sb2FkaW5nID0gZG93bmxvYWRpbmcKICAgIHRoaXMucmVtb3RlSGFzTWFuaWZlc3QgPSBoYXNNYW5pZmVzdAogICAgdGhpcy5yZW1vdGVBbGxvd1B1c2ggPSBhbGxvd1B1c2gKCiAgICBpZiAodGhpcy5jbG9zZUlmSWRsZSgpKSByZXR1cm4KCiAgICB0aGlzLmxlbmd0aEFja2VkID0gc2FtZUZvcmsgPyByZW1vdGVMZW5ndGggOiAwCiAgICB0aGlzLnN5bmNzUHJvY2Vzc2luZysrCgogICAgdGhpcy5yZXBsaWNhdG9yLl91cGRhdGVGb3JrKHRoaXMpCgogICAgaWYgKHRoaXMucmVtb3RlTGVuZ3RoID4gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCAmJiB0aGlzLmxlbmd0aEFja2VkID09PSB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoKSB7CiAgICAgIGlmICh0aGlzLnJlcGxpY2F0b3IuX2FkZFVwZ3JhZGVNYXliZSgpICE9PSBudWxsKSB0aGlzLl91cGRhdGUoKQogICAgfQoKICAgIGNvbnN0IHVwZ3JhZGUgPQogICAgICBsZW5ndGhDaGFuZ2VkID09PSBmYWxzZSB8fCBzYW1lRm9yayA9PT0gZmFsc2UKICAgICAgICA/IHRoaXMuY2FuVXBncmFkZSAmJiBzYW1lRm9yawogICAgICAgIDogYXdhaXQgdGhpcy5fY2FuVXBncmFkZShsZW5ndGgsIGZvcmspCgogICAgaWYgKGxlbmd0aCA9PT0gdGhpcy5yZW1vdGVMZW5ndGggJiYgZm9yayA9PT0gdGhpcy5jb3JlLnN0YXRlLmZvcmspIHsKICAgICAgdGhpcy5jYW5VcGdyYWRlID0gdXBncmFkZQogICAgICBpZiAodXBncmFkZSkgewogICAgICAgIHRoaXMubGFzdFVwZ3JhZGFibGVGb3JrID0gZm9yawogICAgICAgIHRoaXMubGFzdFVwZ3JhZGFibGVMZW5ndGggPSBsZW5ndGgKICAgICAgfQogICAgfQoKICAgIGlmICgtLXRoaXMuc3luY3NQcm9jZXNzaW5nICE9PSAwKSByZXR1cm4gLy8gaWUgbm90IGxhdGVzdAoKICAgIGlmICgKICAgICAgdGhpcy5uZWVkc1N5bmMgPT09IHRydWUgfHwKICAgICAgKHRoaXMuY29yZS5zdGF0ZS5mb3JrID09PSB0aGlzLnJlbW90ZUZvcmsgJiYgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCA+IHRoaXMucmVtb3RlTGVuZ3RoKQogICAgKSB7CiAgICAgIHRoaXMuc2lnbmFsVXBncmFkZSgpCiAgICB9CgogICAgdGhpcy5fdXBkYXRlKCkKICB9CgogIF9zaG91bGRVcGRhdGVDYW5VcGdyYWRlKCkgewogICAgcmV0dXJuICgKICAgICAgdGhpcy5jb3JlLnN0YXRlLmZvcmsgPT09IHRoaXMucmVtb3RlRm9yayAmJgogICAgICB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoID4gdGhpcy5yZW1vdGVMZW5ndGggJiYKICAgICAgdGhpcy5jYW5VcGdyYWRlID09PSBmYWxzZSAmJgogICAgICB0aGlzLnN5bmNzUHJvY2Vzc2luZyA9PT0gMAogICAgKQogIH0KCiAgYXN5bmMgX3VwZGF0ZUNhblVwZ3JhZGVBbmRTeW5jKCkgewogICAgY29uc3QgeyBsZW5ndGgsIGZvcmsgfSA9IHRoaXMuY29yZS5zdGF0ZQoKICAgIGNvbnN0IHJlbW90ZUxlbmd0aCA9IHRoaXMucmVtb3RlTGVuZ3RoCiAgICBjb25zdCByZW1vdGVGb3JrID0gdGhpcy5yZW1vdGVGb3JrCiAgICBjb25zdCBjYW5VcGdyYWRlID0gYXdhaXQgdGhpcy5fY2FuVXBncmFkZSh0aGlzLnJlbW90ZUxlbmd0aCwgdGhpcy5yZW1vdGVGb3JrKQoKICAgIGlmICgKICAgICAgdGhpcy5zeW5jc1Byb2Nlc3NpbmcgPiAwIHx8CiAgICAgIGxlbmd0aCAhPT0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCB8fAogICAgICBmb3JrICE9PSB0aGlzLmNvcmUuc3RhdGUuZm9yawogICAgKSB7CiAgICAgIHJldHVybgogICAgfQogICAgaWYgKHJlbW90ZUxlbmd0aCAhPT0gdGhpcy5yZW1vdGVMZW5ndGggfHwgcmVtb3RlRm9yayAhPT0gdGhpcy5yZW1vdGVGb3JrKSB7CiAgICAgIHJldHVybgogICAgfQogICAgaWYgKGNhblVwZ3JhZGUgPT09IHRoaXMuY2FuVXBncmFkZSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLmNhblVwZ3JhZGUgPSBjYW5VcGdyYWRlCiAgICBpZiAoY2FuVXBncmFkZSkgewogICAgICB0aGlzLmxhc3RVcGdyYWRhYmxlTGVuZ3RoID0gdGhpcy5yZW1vdGVMZW5ndGgKICAgICAgdGhpcy5sYXN0VXBncmFkYWJsZUZvcmsgPSB0aGlzLnJlbW90ZUZvcmsKICAgIH0KCiAgICB0aGlzLnNlbmRTeW5jKCkKICB9CgogIC8vIFNhZmUgdG8gY2FsbCBpbiB0aGUgYmFja2dyb3VuZCAtIG5ldmVyIGZhaWxzCiAgYXN5bmMgX2NhblVwZ3JhZGUocmVtb3RlTGVuZ3RoLCByZW1vdGVGb3JrKSB7CiAgICBpZiAocmVtb3RlRm9yayAhPT0gdGhpcy5jb3JlLnN0YXRlLmZvcmspIHJldHVybiBmYWxzZQoKICAgIGlmIChyZW1vdGVMZW5ndGggPT09IDApIHJldHVybiB0cnVlCiAgICBpZiAocmVtb3RlTGVuZ3RoID49IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpIHJldHVybiBmYWxzZQoKICAgIHRyeSB7CiAgICAgIC8vIFJlbHkgb24gY2FjaGluZyB0byBtYWtlIHN1cmUgdGhpcyBpcyBjaGVhcC4uLgogICAgICBjb25zdCBjYW5VcGdyYWRlID0gYXdhaXQgTWVya2xlVHJlZS51cGdyYWRlYWJsZSh0aGlzLmNvcmUuc3RhdGUsIHJlbW90ZUxlbmd0aCkKCiAgICAgIGlmIChyZW1vdGVGb3JrICE9PSB0aGlzLmNvcmUuc3RhdGUuZm9yaykgcmV0dXJuIGZhbHNlCgogICAgICByZXR1cm4gY2FuVXBncmFkZQogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0KCiAgYXN5bmMgX2dldFByb29mKGJhdGNoLCBtc2csIHB1c2hpbmcpIHsKICAgIGxldCBibG9jayA9IG51bGwKCiAgICBpZiAobXNnLmJsb2NrKSB7CiAgICAgIGNvbnN0IGluZGV4ID0gbXNnLmJsb2NrLmluZGV4CgogICAgICBpZiAoIXB1c2hpbmcgJiYgKG1zZy5mb3JrICE9PSB0aGlzLmNvcmUuc3RhdGUuZm9yayB8fCAhdGhpcy5jb3JlLmJpdGZpZWxkLmdldChpbmRleCkpKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9vZlJlcXVlc3QobXNnLCBudWxsLCBudWxsLCBudWxsKQogICAgICB9CgogICAgICBibG9jayA9IGJhdGNoLmdldEJsb2NrKGluZGV4KQogICAgICBibG9jay5jYXRjaChub29wKQogICAgfQoKICAgIGNvbnN0IG1hbmlmZXN0ID0gbXNnLm1hbmlmZXN0ICYmICF0aGlzLmNvcmUuY29tcGF0ID8gdGhpcy5jb3JlLmhlYWRlci5tYW5pZmVzdCA6IG51bGwKCiAgICB0cnkgewogICAgICBjb25zdCBwcm9vZiA9IGF3YWl0IE1lcmtsZVRyZWUucHJvb2YodGhpcy5jb3JlLnN0YXRlLCBiYXRjaCwgbXNnKQogICAgICByZXR1cm4gbmV3IFByb29mUmVxdWVzdChtc2csIHByb29mLCBibG9jaywgbWFuaWZlc3QpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgYmF0Y2guZGVzdHJveSgpCgogICAgICB0aGlzLnJlcGxpY2F0b3IuX29uaW52YWxpZHJlcXVlc3QoZXJyLCBtc2csIHRoaXMpCgogICAgICBpZiAodGhpcy5zdGF0cy5pbnZhbGlkUmVxdWVzdHMgPj0gTUFYX0lOVkFMSURfUkVRVUVTVFMpIHRocm93IGVycgoKICAgICAgYXdhaXQgYmFja29mZih0aGlzLnN0YXRzLmludmFsaWRSZXF1ZXN0cykKICAgICAgcmV0dXJuIG51bGwKICAgIH0KICB9CgogIGFzeW5jIG9ucmVxdWVzdChtc2cpIHsKICAgIGNvbnN0IHNpemUgPSB0aGlzLnJlbW90ZVJlcXVlc3RzLnNpemUKICAgIHRoaXMucmVtb3RlUmVxdWVzdHMuc2V0KG1zZy5pZCwgbXNnKQoKICAgIC8vIGlmIHNpemUgZGlkbnQgY2hhbmdlIC0+IGlkIG92ZXJ3cml0ZSAtPiBvbGQgb25lIGlzIGRlbGV0ZWQsIGNhbmNlbCBjdXJyZW50IGFuZCByZS1hZGQKICAgIGlmIChzaXplID09PSB0aGlzLnJlbW90ZVJlcXVlc3RzLnNpemUpIHsKICAgICAgdGhpcy5fY2FuY2VsKG1zZy5pZCkKICAgICAgdGhpcy5yZW1vdGVSZXF1ZXN0cy5zZXQobXNnLmlkLCBtc2cpCiAgICB9CgogICAgaWYgKCF0aGlzLnByb3RvbXV4LmRyYWluZWQgfHwgdGhpcy5yZWNlaXZlclF1ZXVlLmxlbmd0aCkgewogICAgICB0aGlzLnJlY2VpdmVyUXVldWUucHVzaChtc2cpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLnJlcGxpY2F0b3IuZGVzdHJveWVkKSByZXR1cm4KCiAgICBhd2FpdCB0aGlzLl9oYW5kbGVSZXF1ZXN0KG1zZykKICB9CgogIG9uY2FuY2VsKG1zZykgewogICAgdGhpcy5fY2FuY2VsKG1zZy5yZXF1ZXN0KQogIH0KCiAgX2NhbmNlbChpZCkgewogICAgdGhpcy5yZW1vdGVSZXF1ZXN0cy5kZWxldGUoaWQpCiAgICB0aGlzLnJlY2VpdmVyUXVldWUuZGVsZXRlKGlkKQogIH0KCiAgb25kcmFpbigpIHsKICAgIHJldHVybiB0aGlzLl9oYW5kbGVSZXF1ZXN0cygpCiAgfQoKICBhc3luYyBfaGFuZGxlUmVxdWVzdHMoKSB7CiAgICBpZiAodGhpcy5yZWNlaXZlckJ1c3kgfHwgdGhpcy5yZXBsaWNhdG9yLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLnJlY2VpdmVyQnVzeSA9IHRydWUKICAgIHRoaXMucHJvdG9tdXguY29yaygpCgogICAgd2hpbGUgKAogICAgICB0aGlzLnJlbW90ZU9wZW5lZCAmJgogICAgICB0aGlzLnByb3RvbXV4LmRyYWluZWQgJiYKICAgICAgdGhpcy5yZWNlaXZlclF1ZXVlLmxlbmd0aCA+IDAgJiYKICAgICAgIXRoaXMucmVtb3ZlZAogICAgKSB7CiAgICAgIGNvbnN0IG1zZyA9IHRoaXMucmVjZWl2ZXJRdWV1ZS5zaGlmdCgpCiAgICAgIGF3YWl0IHRoaXMuX2hhbmRsZVJlcXVlc3QobXNnKQogICAgfQoKICAgIHRoaXMucHJvdG9tdXgudW5jb3JrKCkKICAgIHRoaXMucmVjZWl2ZXJCdXN5ID0gZmFsc2UKICB9CgogIGFzeW5jIHB1c2goaW5kZXgpIHsKICAgIGlmICghdGhpcy5yZW1vdGVBbGxvd1B1c2gpIHJldHVybgogICAgaWYgKHRoaXMuY29yZS5zdGF0ZS5mb3JrICE9PSB0aGlzLnJlbW90ZUZvcmspIHJldHVybgogICAgaWYgKHRoaXMucmVtb3RlQml0ZmllbGQuZ2V0KGluZGV4KSkgcmV0dXJuCgogICAgY29uc3QgbXNnID0gewogICAgICBpZDogMCwKICAgICAgZm9yazogdGhpcy5jb3JlLnN0YXRlLmZvcmssCiAgICAgIGJsb2NrOiBudWxsLAogICAgICBoYXNoOiBudWxsLAogICAgICBzZWVrOiBudWxsLAogICAgICB1cGdyYWRlOiBudWxsLAogICAgICBtYW5pZmVzdDogdGhpcy5yZW1vdGVMZW5ndGggPT09IDAsCiAgICAgIHByaW9yaXR5OiAwCiAgICB9CgogICAgY29uc3QgcmVtb3RlTGVuZ3RoID0gTWF0aC5tYXgodGhpcy5yZW1vdGVMZW5ndGgsIHRoaXMucHVzaGVkTGVuZ3RoKQoKICAgIG1zZy5ibG9jayA9IHsKICAgICAgaW5kZXgsCiAgICAgIG5vZGVzOiBNZXJrbGVUcmVlLm1heE1pc3NpbmdOb2RlcygyICogaW5kZXgsIHJlbW90ZUxlbmd0aCkKICAgIH0KCiAgICBpZiAoaW5kZXggPj0gdGhpcy5yZW1vdGVMZW5ndGgpIHsKICAgICAgbXNnLnVwZ3JhZGUgPSB7CiAgICAgICAgc3RhcnQ6IHJlbW90ZUxlbmd0aCwKICAgICAgICBsZW5ndGg6IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggLSByZW1vdGVMZW5ndGgKICAgICAgfQogICAgfQoKICAgIGxldCByZXEgPSBudWxsCiAgICBjb25zdCBiYXRjaCA9IHRoaXMuY29yZS5zdG9yYWdlLnJlYWQoKQogICAgdHJ5IHsKICAgICAgcmVxID0gYXdhaXQgdGhpcy5fZ2V0UHJvb2YoYmF0Y2gsIG1zZywgdHJ1ZSkKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAocmVxID09PSBudWxsKSByZXR1cm4KICAgIGJhdGNoLnRyeUZsdXNoKCkKCiAgICBhd2FpdCB0aGlzLl9mdWxmaWxsUmVxdWVzdChyZXEsIHRydWUpCiAgfQoKICBhc3luYyBfaGFuZGxlUmVxdWVzdChtc2cpIHsKICAgIGNvbnN0IGJhdGNoID0gdGhpcy5jb3JlLnN0b3JhZ2UucmVhZCgpCgogICAgLy8gVE9ETzogY291bGQgc3RpbGwgYmUgYW5zd2VyYWJsZSBpZiAoaW5kZXgsIGZvcmspIGlzIGFuIGFuY2VzdG9yIG9mIHRoZSBjdXJyZW50IGZvcmsKICAgIGNvbnN0IHJlcSA9CiAgICAgIG1zZy5mb3JrID09PSB0aGlzLmNvcmUuc3RhdGUuZm9yawogICAgICAgID8gYXdhaXQgdGhpcy5fZ2V0UHJvb2YoYmF0Y2gsIG1zZywgZmFsc2UpCiAgICAgICAgOiBuZXcgUHJvb2ZSZXF1ZXN0KG1zZywgbnVsbCwgbnVsbCwgbnVsbCkKCiAgICBpZiAocmVxID09PSBudWxsKSB7CiAgICAgIHRoaXMud2lyZU5vRGF0YS5zZW5kKHsgcmVxdWVzdDogbXNnLmlkLCByZWFzb246IElOVkFMSURfUkVRVUVTVCB9KQogICAgICByZXR1cm4KICAgIH0KCiAgICBiYXRjaC50cnlGbHVzaCgpCgogICAgYXdhaXQgdGhpcy5fZnVsZmlsbFJlcXVlc3QocmVxLCBmYWxzZSkKICB9CgogIGFzeW5jIF9mdWxmaWxsUmVxdWVzdChyZXEsIHB1c2hpbmcpIHsKICAgIGNvbnN0IHByb29mID0gYXdhaXQgcmVxLmZ1bGZpbGwoKQoKICAgIGlmICghcHVzaGluZykgewogICAgICAvLyBpZiBjYW5jZWxsZWQgZG8gbm90IHJlcGx5CiAgICAgIGlmICh0aGlzLnJlbW90ZVJlcXVlc3RzLmdldChyZXEubXNnLmlkKSAhPT0gcmVxLm1zZykgewogICAgICAgIHJldHVybgogICAgICB9CgogICAgICAvLyBzeW5jIGZyb20gbm93IG9uLCBzbyBzYWZlIHRvIGRlbGV0ZSBmcm9tIHRoZSBtYXAKICAgICAgdGhpcy5yZW1vdGVSZXF1ZXN0cy5kZWxldGUocmVxLm1zZy5pZCkKICAgIH0gZWxzZSBpZiAoIXRoaXMucmVtb3RlQWxsb3dQdXNoKSB7CiAgICAgIC8vIGlmIHB1c2hpbmcgYnV0IHJlbW90ZSBkaXNhYmxlZCBpdCwganVzdCBkcm9wIGl0CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICghdGhpcy5pc0FjdGl2ZSgpICYmIHByb29mLmJsb2NrICE9PSBudWxsKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChwcm9vZiA9PT0gbnVsbCkgewogICAgICBpZiAocmVxLm1zZy5tYW5pZmVzdCAmJiB0aGlzLmNvcmUuaGVhZGVyLm1hbmlmZXN0KSB7CiAgICAgICAgY29uc3QgbWFuaWZlc3QgPSB0aGlzLmNvcmUuaGVhZGVyLm1hbmlmZXN0CiAgICAgICAgdGhpcy53aXJlRGF0YS5zZW5kKHsKICAgICAgICAgIHJlcXVlc3Q6IHJlcS5tc2cuaWQsCiAgICAgICAgICBmb3JrOiB0aGlzLmNvcmUuc3RhdGUuZm9yaywKICAgICAgICAgIGJsb2NrOiBudWxsLAogICAgICAgICAgaGFzaDogbnVsbCwKICAgICAgICAgIHNlZWs6IG51bGwsCiAgICAgICAgICB1cGdyYWRlOiBudWxsLAogICAgICAgICAgbWFuaWZlc3QKICAgICAgICB9KQogICAgICAgIGluY3JlbWVudFR4KHRoaXMuc3RhdHMud2lyZURhdGEsIHRoaXMucmVwbGljYXRvci5zdGF0cy53aXJlRGF0YSkKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgdGhpcy53aXJlTm9EYXRhLnNlbmQoeyByZXF1ZXN0OiByZXEubXNnLmlkLCByZWFzb246IE5PVF9BVkFJTEFCTEUgfSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHByb29mLmJsb2NrICE9PSBudWxsKSB7CiAgICAgIHRoaXMucmVwbGljYXRvci5fb251cGxvYWQocHJvb2YuYmxvY2suaW5kZXgsIHByb29mLmJsb2NrLnZhbHVlLmJ5dGVMZW5ndGgsIHRoaXMpCiAgICB9CgogICAgaWYgKHByb29mLnVwZ3JhZGUpIHsKICAgICAgY29uc3QgcmVtb3RlTGVuZ3RoID0gcHJvb2YudXBncmFkZS5zdGFydCArIHByb29mLnVwZ3JhZGUubGVuZ3RoCiAgICAgIGlmIChyZW1vdGVMZW5ndGggPiB0aGlzLnB1c2hlZExlbmd0aCkgdGhpcy5wdXNoZWRMZW5ndGggPSByZW1vdGVMZW5ndGgKICAgIH0KCiAgICB0aGlzLndpcmVEYXRhLnNlbmQoewogICAgICByZXF1ZXN0OiByZXEubXNnLmlkLAogICAgICBmb3JrOiByZXEubXNnLmZvcmssCiAgICAgIGJsb2NrOiBwcm9vZi5ibG9jaywKICAgICAgaGFzaDogcHJvb2YuaGFzaCwKICAgICAgc2VlazogcHJvb2Yuc2VlaywKICAgICAgdXBncmFkZTogcHJvb2YudXBncmFkZSwKICAgICAgbWFuaWZlc3Q6IHByb29mLm1hbmlmZXN0CiAgICB9KQogICAgaW5jcmVtZW50VHgodGhpcy5zdGF0cy53aXJlRGF0YSwgdGhpcy5yZXBsaWNhdG9yLnN0YXRzLndpcmVEYXRhKQogIH0KCiAgX2NhbmNlbFJlcXVlc3QocmVxKSB7CiAgICBpZiAocmVxLnByaW9yaXR5ID09PSBQUklPUklUWS5DQU5DRUxMRUQpIHJldHVybgogICAgLy8gbWFyayBhcyBjYW5jZWxsZWQgYWxzbyBhbmQgYXZvaWQgcmUtZW50cnkKICAgIHJlcS5wcmlvcml0eSA9IFBSSU9SSVRZLkNBTkNFTExFRAoKICAgIHRoaXMuaW5mbGlnaHQtLQogICAgdGhpcy5yZXBsaWNhdG9yLl9yZXF1ZXN0RG9uZShyZXEuaWQsIGZhbHNlKQoKICAgIC8vIGNsZWFyIGluZmxpZ2h0IHN0YXRlCiAgICBpZiAoaXNCbG9ja1JlcXVlc3QocmVxKSkgdGhpcy5yZXBsaWNhdG9yLl91bm1hcmtJbmZsaWdodChyZXEuYmxvY2suaW5kZXgpCiAgICBpZiAoaXNVcGdyYWRlUmVxdWVzdChyZXEpKSB0aGlzLnJlcGxpY2F0b3IuX2NsZWFySW5mbGlnaHRVcGdyYWRlKHJlcSkKCiAgICBpZiAodGhpcy5yb3VuZHRyaXBRdWV1ZSA9PT0gbnVsbCkgdGhpcy5yb3VuZHRyaXBRdWV1ZSA9IG5ldyBSb3VuZHRyaXBRdWV1ZSgpCiAgICB0aGlzLnJvdW5kdHJpcFF1ZXVlLmFkZChyZXEuaWQpCiAgICB0aGlzLndpcmVDYW5jZWwuc2VuZCh7IHJlcXVlc3Q6IHJlcS5pZCB9KQogICAgaW5jcmVtZW50VHgodGhpcy5zdGF0cy53aXJlQ2FuY2VsLCB0aGlzLnJlcGxpY2F0b3Iuc3RhdHMud2lyZUNhbmNlbCkKICB9CgogIF9jaGVja0lmQ29uZmxpY3QoKSB7CiAgICB0aGlzLnBhdXNlZCA9IHRydWUKCiAgICBjb25zdCBsZW5ndGggPSBNYXRoLm1pbih0aGlzLmNvcmUuc3RhdGUubGVuZ3RoLCB0aGlzLnJlbW90ZUxlbmd0aCkKICAgIGlmIChsZW5ndGggPT09IDApIHJldHVybiAvLyBwYXVzZSBhbmQgaWdub3JlCgogICAgdGhpcy53aXJlUmVxdWVzdC5zZW5kKHsKICAgICAgaWQ6IDAsIC8vIFRPRE86IHVzZSBhbiBtb3JlIGV4cGxpY2l0IGlkIGZvciB0aGlzIGV2ZW50dWFsbHkuLi4KICAgICAgZm9yazogdGhpcy5yZW1vdGVGb3JrLAogICAgICBibG9jazogbnVsbCwKICAgICAgaGFzaDogbnVsbCwKICAgICAgc2VlazogbnVsbCwKICAgICAgdXBncmFkZTogewogICAgICAgIHN0YXJ0OiAwLAogICAgICAgIGxlbmd0aAogICAgICB9CiAgICB9KQoKICAgIGluY3JlbWVudFR4KHRoaXMuc3RhdHMud2lyZVJlcXVlc3QsIHRoaXMucmVwbGljYXRvci5zdGF0cy53aXJlUmVxdWVzdCkKICB9CgogIF91bm1hcmtJbmZsaWdodEJsb2NrUmVxdWVzdChyZXEsIGRhdGEpIHsKICAgIGlmIChpc0Jsb2NrUmVxdWVzdChyZXEpKSB0aGlzLnJlcGxpY2F0b3IuX3VubWFya0luZmxpZ2h0KHJlcS5ibG9jay5pbmRleCkKICAgIGVsc2UgaWYgKGRhdGEuYmxvY2sgJiYgIXJlcSkgdGhpcy5yZXBsaWNhdG9yLl91bm1hcmtJbmZsaWdodChkYXRhLmJsb2NrLmluZGV4KQogIH0KCiAgYXN5bmMgb25kYXRhKGRhdGEpIHsKICAgIGlmIChkYXRhLnJlcXVlc3QgIT09IDApIHJldHVybiB0aGlzLl9oYW5kbGVEYXRhKGRhdGEpCgogICAgYXdhaXQgdGhpcy5yZXBsaWNhdG9yLl9wdXNoTG9jay5sb2NrKCkKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2hhbmRsZURhdGEoZGF0YSkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMucmVwbGljYXRvci5fcHVzaExvY2sudW5sb2NrKCkKICAgIH0KICB9CgogIGFzeW5jIF9oYW5kbGVEYXRhKGRhdGEpIHsKICAgIC8vIGFsd2F5cyBhbGxvdyBhIGZvcmsgY29uZmxpY3QgcHJvb2YgdG8gYmUgc2VudAogICAgaWYgKGRhdGEucmVxdWVzdCA9PT0gMCAmJiBkYXRhLnVwZ3JhZGUgJiYgZGF0YS51cGdyYWRlLnN0YXJ0ID09PSAwKSB7CiAgICAgIGlmIChhd2FpdCB0aGlzLmNvcmUuY2hlY2tDb25mbGljdChkYXRhLCB0aGlzKSkgcmV0dXJuCiAgICAgIHRoaXMucGF1c2VkID0gZmFsc2UKICAgIH0KCiAgICBjb25zdCByZXEgPSBkYXRhLnJlcXVlc3QgPiAwID8gdGhpcy5yZXBsaWNhdG9yLl9pbmZsaWdodC5nZXQoZGF0YS5yZXF1ZXN0KSA6IG51bGwKICAgIGNvbnN0IHJlb3JnID0gZGF0YS5mb3JrID4gdGhpcy5jb3JlLnN0YXRlLmZvcmsKCiAgICAvLyBubyBwdXNoIGF0bSwgVE9ETzogY2hlY2sgaWYgdGhpcyBzYXRpc2ZpZXMgYW5vdGhlciBwZW5kaW5nIHJlcXVlc3QKICAgIC8vIGFsbG93IHJlb3JnIHB1c2hlcyB0aG8gYXMgdGhvc2UgYXJlIG5vdCB3cml0dGVuIHRvIHN0b3JhZ2Ugc28gd2UnbGwgdGFrZSBhbGwgdGhlIGhlbHAgd2UgY2FuIGdldAogICAgaWYgKHJlcSA9PT0gbnVsbCAmJiByZW9yZyA9PT0gZmFsc2UgJiYgIXRoaXMucmVwbGljYXRvci5hbGxvd1B1c2gpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHJlcSA9PT0gbnVsbCAmJiByZW9yZyA9PT0gZmFsc2UgJiYgZGF0YS5ibG9jaykgewogICAgICAvLyBtYXJrIHRoaXMgYXMgaW5mbGlnaHQgdG8gYXZvaWQgcGFyYWxsZWwgcmVxdWVzdHMKICAgICAgdGhpcy5yZXBsaWNhdG9yLl9tYXJrSW5mbGlnaHQoZGF0YS5ibG9jay5pbmRleCkKICAgIH0KCiAgICBpZiAocmVxICE9PSBudWxsKSB7CiAgICAgIGlmIChyZXEucGVlciAhPT0gdGhpcykgcmV0dXJuCiAgICAgIHRoaXMuX29ucmVxdWVzdHJvdW5kdHJpcChyZXEpCiAgICB9CgogICAgdHJ5IHsKICAgICAgaWYgKHJlb3JnID09PSB0cnVlKSByZXR1cm4gYXdhaXQgdGhpcy5yZXBsaWNhdG9yLl9vbnJlb3JnZGF0YSh0aGlzLCByZXEsIGRhdGEpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgICB0aGlzLl91bm1hcmtJbmZsaWdodEJsb2NrUmVxdWVzdChyZXEsIGRhdGEpCgogICAgICB0aGlzLnBhdXNlZCA9IHRydWUKICAgICAgdGhpcy5yZXBsaWNhdG9yLl9vbmludmFsaWRkYXRhKGVyciwgcmVxLCBkYXRhLCB0aGlzKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLmRhdGFQcm9jZXNzaW5nKysKICAgIGlmIChpc0Jsb2NrUmVxdWVzdChyZXEpKSB0aGlzLnJlcGxpY2F0b3IuX21hcmtQcm9jZXNzaW5nKHJlcS5ibG9jay5pbmRleCkKCiAgICB0cnkgewogICAgICBpZiAoIXRoaXMucmVwbGljYXRvci5fbWF0Y2hpbmdSZXF1ZXN0KHJlcSwgZGF0YSkgfHwgIShhd2FpdCB0aGlzLmNvcmUudmVyaWZ5KGRhdGEsIHRoaXMpKSkgewogICAgICAgIHRoaXMucmVwbGljYXRvci5fb25ub2RhdGEodGhpcywgcmVxLCAwKQogICAgICAgIHJldHVybgogICAgICB9CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgICB0aGlzLl91bm1hcmtJbmZsaWdodEJsb2NrUmVxdWVzdChyZXEsIGRhdGEpCgogICAgICBpZiAoZXJyLmNvZGUgPT09ICdXUklURV9GQUlMRUQnKSB7CiAgICAgICAgLy8gRm9yIGV4YW1wbGUsIHdlIGRvbid0IHdhbnQgdG8ga2VlcCBwdWxsaW5nIGRhdGEgd2hlbiBzdG9yYWdlIGlzIGZ1bGwKICAgICAgICAvLyBUT0RPOiBub3RpZnkgdGhlIHVzZXIgc29tZWhvdwogICAgICAgIHRoaXMucGF1c2VkID0gdHJ1ZQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICBpZiAodGhpcy5jb3JlLmNsb3NlZCAmJiAhaXNDcml0aWNhbEVycm9yKGVycikpIHJldHVybgoKICAgICAgaWYgKGVyci5jb2RlICE9PSAnSU5WQUxJRF9PUEVSQVRJT04nKSB7CiAgICAgICAgLy8gbWlnaHQgYmUgYSBmb3JrLCB2ZXJpZnkKICAgICAgICB0aGlzLl9jaGVja0lmQ29uZmxpY3QoKQogICAgICB9CgogICAgICAvLyBpZiBwdXNoIG1vZGUsIHdlIE1JR0hUIGdldCBhbiBvY2Nhc2lvbmFsIGJhZCBtZXNzYWdlCiAgICAgIC8vIG5vIG5lZWQgdG8gbWVnYSBiYWlsIGZvciB0aGF0LiBUT0RPOiByYXRlIGxpbWl0IGluc3RlYWQgYXMgYSBnZW5lcmFsIHRoaW5nCiAgICAgIGlmICghdGhpcy5yZXBsaWNhdG9yLmFsbG93UHVzaCkgewogICAgICAgIHRoaXMucGF1c2VkID0gdHJ1ZQogICAgICB9CgogICAgICB0aGlzLnJlcGxpY2F0b3IuX29ubm9kYXRhKHRoaXMsIHJlcSwgMCkKICAgICAgdGhpcy5yZXBsaWNhdG9yLl9vbmludmFsaWRkYXRhKGVyciwgcmVxLCBkYXRhLCB0aGlzKQogICAgICByZXR1cm4KICAgIH0gZmluYWxseSB7CiAgICAgIGlmIChpc0Jsb2NrUmVxdWVzdChyZXEpKSB0aGlzLnJlcGxpY2F0b3IuX21hcmtQcm9jZXNzZWQocmVxLmJsb2NrLmluZGV4KQogICAgICB0aGlzLmRhdGFQcm9jZXNzaW5nLS0KICAgIH0KCiAgICB0aGlzLnJlcGxpY2F0b3IuX29uZGF0YSh0aGlzLCByZXEsIGRhdGEpCgogICAgaWYgKHRoaXMuX3Nob3VsZFVwZGF0ZUNhblVwZ3JhZGUoKSA9PT0gdHJ1ZSkgewogICAgICB0aGlzLl91cGRhdGVDYW5VcGdyYWRlQW5kU3luYygpCiAgICB9CiAgfQoKICBvbm5vZGF0YSh7IHJlcXVlc3QsIHJlYXNvbiB9KSB7CiAgICBjb25zdCByZXEgPSByZXF1ZXN0ID4gMCA/IHRoaXMucmVwbGljYXRvci5faW5mbGlnaHQuZ2V0KHJlcXVlc3QpIDogbnVsbAoKICAgIGlmIChyZXEgPT09IG51bGwgfHwgcmVxLnBlZXIgIT09IHRoaXMpIHsKICAgICAgdGhpcy5yZXBsaWNhdG9yLnVwZGF0ZUFsbCgpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuX29ucmVxdWVzdHJvdW5kdHJpcChyZXEpCiAgICB0aGlzLnJlcGxpY2F0b3IuX29ubm9kYXRhKHRoaXMsIHJlcSwgcmVhc29uKQogIH0KCiAgX29ucmVxdWVzdHJvdW5kdHJpcChyZXEpIHsKICAgIGlmIChyZXEucHJpb3JpdHkgPT09IFBSSU9SSVRZLkNBTkNFTExFRCkgcmV0dXJuCiAgICAvLyB0byBhdm9pZCByZS1lbnRyeSB3ZSBhbHNvIGp1c3QgbWFyayBpdCBhcyBjYW5jZWxsZWQKICAgIHJlcS5wcmlvcml0eSA9IFBSSU9SSVRZLkNBTkNFTExFRAoKICAgIHRoaXMuaW5mbGlnaHQtLQogICAgdGhpcy5yZXBsaWNhdG9yLl9yZXF1ZXN0RG9uZShyZXEuaWQsIHRydWUpCiAgICBpZiAodGhpcy5yb3VuZHRyaXBRdWV1ZSA9PT0gbnVsbCkgcmV0dXJuCiAgICBjb25zdCBmbHVzaGVkID0gdGhpcy5yb3VuZHRyaXBRdWV1ZS5mbHVzaChyZXEucnQpCiAgICBpZiAoZmx1c2hlZCA9PT0gbnVsbCkgcmV0dXJuCiAgICBmb3IgKGNvbnN0IGlkIG9mIGZsdXNoZWQpIHRoaXMucmVwbGljYXRvci5faW5mbGlnaHQucmV1c2FibGUoaWQpCiAgfQoKICBvbndhbnQoeyBzdGFydCwgbGVuZ3RoIH0pIHsKICAgIGNvbnN0IGkgPSBNYXRoLmZsb29yKHN0YXJ0IC8gREVGQVVMVF9TRUdNRU5UX1NJWkUpCiAgICBpZiAodGhpcy5yZW1vdGVTZWdtZW50c1dhbnRlZC5zaXplID49IE1BWF9SRU1PVEVfU0VHTUVOVFMpIHRoaXMucmVtb3RlU2VnbWVudHNXYW50ZWQuY2xlYXIoKSAvLyBqdXN0IGluIGNhc2Ugb2YgYWJ1c2UKICAgIHRoaXMucmVtb3RlU2VnbWVudHNXYW50ZWQuYWRkKGkpCiAgICB0aGlzLnJlcGxpY2F0b3IuX29ud2FudCh0aGlzLCBzdGFydCwgbGVuZ3RoKQogIH0KCiAgb251bndhbnQoKSB7CiAgICAvLyBUT0RPCiAgfQoKICBvbmJpdGZpZWxkKHsgc3RhcnQsIGJpdGZpZWxkIH0pIHsKICAgIGlmIChzdGFydCA8IHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpIHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGggPSBzdGFydCAvLyBiaXRmaWVsZCBpcyBhbHdheXMgdGhlIHRydXRoCiAgICB0aGlzLnJlbW90ZUJpdGZpZWxkLmluc2VydChzdGFydCwgYml0ZmllbGQpCiAgICB0aGlzLm1pc3NpbmdCbG9ja3MuaW5zZXJ0KHN0YXJ0LCBiaXRmaWVsZCkKICAgIHRoaXMuX2NsZWFyTG9jYWxSYW5nZShzdGFydCwgYml0ZmllbGQuYnl0ZUxlbmd0aCAqIDgpCiAgICB0aGlzLl91cGRhdGUoKQogIH0KCiAgX2NsZWFyTG9jYWxSYW5nZShzdGFydCwgbGVuZ3RoKSB7CiAgICBjb25zdCBiaXRmaWVsZCA9IHRoaXMuY29yZS5za2lwQml0ZmllbGQgPT09IG51bGwgPyB0aGlzLmNvcmUuYml0ZmllbGQgOiB0aGlzLmNvcmUuc2tpcEJpdGZpZWxkCgogICAgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICB0aGlzLm1pc3NpbmdCbG9ja3Muc2V0KHN0YXJ0LCB0aGlzLl9yZW1vdGVIYXNCbG9jayhzdGFydCkgJiYgIWJpdGZpZWxkLmdldChzdGFydCkpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IGNvbnRpZyA9IE1hdGgubWluKHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgsIHRoaXMuY29yZS5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCkKCiAgICBpZiAoc3RhcnQgKyBsZW5ndGggPCBjb250aWcpIHsKICAgICAgdGhpcy5taXNzaW5nQmxvY2tzLnNldFJhbmdlKHN0YXJ0LCBjb250aWcsIGZhbHNlKQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCByZW0gPSBzdGFydCAmIDMyNzY3CiAgICBpZiAocmVtID4gMCkgewogICAgICBzdGFydCAtPSByZW0KICAgICAgbGVuZ3RoICs9IHJlbQogICAgfQoKICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgTWF0aC5taW4obGVuZ3RoLCB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoKQogICAgd2hpbGUgKHN0YXJ0IDwgZW5kKSB7CiAgICAgIGNvbnN0IGxvY2FsID0gYml0ZmllbGQuZ2V0Qml0ZmllbGQoc3RhcnQpCgogICAgICBpZiAobG9jYWwgJiYgbG9jYWwuYml0ZmllbGQpIHsKICAgICAgICB0aGlzLm1pc3NpbmdCbG9ja3MuY2xlYXIoc3RhcnQsIGxvY2FsLmJpdGZpZWxkKQogICAgICB9CgogICAgICBzdGFydCArPSAzMjc2OAogICAgfQogIH0KCiAgX3Jlc2V0TWlzc2luZ0Jsb2NrKGluZGV4KSB7CiAgICBjb25zdCBiaXRmaWVsZCA9IHRoaXMuY29yZS5za2lwQml0ZmllbGQgPT09IG51bGwgPyB0aGlzLmNvcmUuYml0ZmllbGQgOiB0aGlzLmNvcmUuc2tpcEJpdGZpZWxkCiAgICB0aGlzLm1pc3NpbmdCbG9ja3Muc2V0KGluZGV4LCB0aGlzLl9yZW1vdGVIYXNCbG9jayhpbmRleCkgJiYgIWJpdGZpZWxkLmdldChpbmRleCkpCiAgfQoKICBfdW5jbGVhckxvY2FsUmFuZ2Uoc3RhcnQsIGxlbmd0aCkgewogICAgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICB0aGlzLl9yZXNldE1pc3NpbmdCbG9jayhzdGFydCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgcmVtID0gc3RhcnQgJiAyMDk3MTUxCiAgICBpZiAocmVtID4gMCkgewogICAgICBzdGFydCAtPSByZW0KICAgICAgbGVuZ3RoICs9IHJlbQogICAgfQoKICAgIGNvbnN0IGZpeGVkU3RhcnQgPSBzdGFydAoKICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgTWF0aC5taW4obGVuZ3RoLCB0aGlzLnJlbW90ZUxlbmd0aCkKICAgIHdoaWxlIChzdGFydCA8IGVuZCkgewogICAgICBjb25zdCByZW1vdGUgPSB0aGlzLnJlbW90ZUJpdGZpZWxkLmdldEJpdGZpZWxkKHN0YXJ0KQogICAgICBpZiAocmVtb3RlICYmIHJlbW90ZS5iaXRmaWVsZCkgewogICAgICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5pbnNlcnQoc3RhcnQsIHJlbW90ZS5iaXRmaWVsZCkKICAgICAgfQoKICAgICAgc3RhcnQgKz0gMjA5NzE1MgogICAgfQoKICAgIHRoaXMuX2NsZWFyTG9jYWxSYW5nZShmaXhlZFN0YXJ0LCBsZW5ndGgpCiAgfQoKICBhc3luYyBvbnJhbmdlKHsgZHJvcCwgc3RhcnQsIGxlbmd0aCB9KSB7CiAgICBjb25zdCBoYXMgPSBkcm9wID09PSBmYWxzZQoKICAgIGlmIChkcm9wID09PSB0cnVlICYmIHN0YXJ0IDwgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCkgewogICAgICB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoID0gc3RhcnQKICAgIH0KCiAgICBpZiAoc3RhcnQgPT09IDAgJiYgZHJvcCA9PT0gZmFsc2UpIHsKICAgICAgaWYgKGxlbmd0aCA+IHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpIHsKICAgICAgICB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoID0gbGVuZ3RoCiAgICAgICAgaWYgKAogICAgICAgICAgdGhpcy5yZW1vdGVGb3JrID09PSB0aGlzLmNvcmUuc3RhdGUuZm9yayAmJgogICAgICAgICAgbGVuZ3RoID4gdGhpcy5jb3JlLmhlYWRlci5oaW50cy5yZW1vdGVDb250aWd1b3VzTGVuZ3RoCiAgICAgICAgKSB7CiAgICAgICAgICB0aGlzLmNvcmUudXBkYXRlUmVtb3RlQ29udGlndW91c0xlbmd0aChsZW5ndGgpCiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICBjb25zdCBiaXRmaWVsZCA9IHRoaXMuY29yZS5za2lwQml0ZmllbGQgPT09IG51bGwgPyB0aGlzLmNvcmUuYml0ZmllbGQgOiB0aGlzLmNvcmUuc2tpcEJpdGZpZWxkCiAgICAgIHRoaXMucmVtb3RlQml0ZmllbGQuc2V0KHN0YXJ0LCBoYXMpCiAgICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5zZXQoc3RhcnQsIGhhcyAmJiAhYml0ZmllbGQuZ2V0KHN0YXJ0KSkKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHJhbmdlU3RhcnQgPSB0aGlzLnJlbW90ZUJpdGZpZWxkLmZpbmRGaXJzdCghaGFzLCBzdGFydCkKICAgICAgY29uc3QgcmFuZ2VFbmQgPSBsZW5ndGggKyBzdGFydAoKICAgICAgaWYgKHJhbmdlU3RhcnQgIT09IC0xICYmIHJhbmdlU3RhcnQgPCByYW5nZUVuZCkgewogICAgICAgIHRoaXMucmVtb3RlQml0ZmllbGQuc2V0UmFuZ2UocmFuZ2VTdGFydCwgcmFuZ2VFbmQsIGhhcykKICAgICAgICB0aGlzLm1pc3NpbmdCbG9ja3Muc2V0UmFuZ2UocmFuZ2VTdGFydCwgcmFuZ2VFbmQsIGhhcykKICAgICAgICBpZiAoaGFzKSB0aGlzLl9jbGVhckxvY2FsUmFuZ2UocmFuZ2VTdGFydCwgcmFuZ2VFbmQgLSByYW5nZVN0YXJ0KQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMuY29yZS5oaW50c0NoYW5nZWQpIGF3YWl0IHRoaXMuY29yZS5mbHVzaEhpbnRzKCkKICAgIGlmIChkcm9wID09PSBmYWxzZSkgdGhpcy5fdXBkYXRlKCkKICB9CgogIG9ucmVvcmdoaW50KCkgewogICAgLy8gVE9ETwogIH0KCiAgX3VwZGF0ZSgpIHsKICAgIC8vIFRPRE86IGlmIHRoaXMgaXMgaW4gYSBiYXRjaCBvciBzaW1pbGFyIGl0IHdvdWxkIGJlIGJldHRlciB0byBkZWZlciBpdAogICAgLy8gd2UgY291bGQgZG8gdGhhdCB3aXRoIG5leHRUaWNrL21pY3JvdGljayBtYj8gKGNvbWJpbmVkIHdpdGggYSBwcm9wZXJ0eSBvbiB0aGUgc2Vzc2lvbiB0byBzaWduYWwgcmVhZCBidWZmZXIgbWIpCiAgICB0aGlzLnJlcGxpY2F0b3IudXBkYXRlUGVlcih0aGlzKQogIH0KCiAgYXN5bmMgX29uY29uZmxpY3QoKSB7CiAgICB0aGlzLnByb3RvbXV4LmNvcmsoKQogICAgaWYgKHRoaXMucmVtb3RlTGVuZ3RoID4gMCAmJiB0aGlzLmNvcmUuc3RhdGUuZm9yayA9PT0gdGhpcy5yZW1vdGVGb3JrKSB7CiAgICAgIGF3YWl0IHRoaXMub25yZXF1ZXN0KHsKICAgICAgICBpZDogMCwKICAgICAgICBmb3JrOiB0aGlzLmNvcmUuc3RhdGUuZm9yaywKICAgICAgICBibG9jazogbnVsbCwKICAgICAgICBoYXNoOiBudWxsLAogICAgICAgIHNlZWs6IG51bGwsCiAgICAgICAgdXBncmFkZTogewogICAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgICBsZW5ndGg6IE1hdGgubWluKHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgsIHRoaXMucmVtb3RlTGVuZ3RoKQogICAgICAgIH0KICAgICAgfSkKICAgIH0KICAgIHRoaXMuY2hhbm5lbC5jbG9zZSgpCiAgICB0aGlzLnByb3RvbXV4LnVuY29yaygpCiAgfQoKICBfbWFrZVJlcXVlc3QobmVlZHNVcGdyYWRlLCBwcmlvcml0eSwgbWluTGVuZ3RoKSB7CiAgICBpZiAobmVlZHNVcGdyYWRlID09PSB0cnVlICYmIHRoaXMucmVwbGljYXRvci5fc2hvdWxkVXBncmFkZSh0aGlzKSA9PT0gZmFsc2UpIHsKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICAvLyBlbnN1cmUgdGhhdCB0aGUgcmVtb3RlIGhhcyBzaWduYWxsZWQgdGhleSBoYXZlIHRoZSBsZW5ndGggd2UgcmVxdWVzdAogICAgaWYgKHRoaXMucmVtb3RlTGVuZ3RoIDwgbWluTGVuZ3RoKSB7CiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgaWYgKG5lZWRzVXBncmFkZSA9PT0gZmFsc2UgJiYgdGhpcy5yZXBsaWNhdG9yLl9hdXRvVXBncmFkZSh0aGlzKSA9PT0gdHJ1ZSkgewogICAgICBuZWVkc1VwZ3JhZGUgPSB0cnVlCiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgcGVlcjogdGhpcywKICAgICAgcnQ6IHRoaXMucm91bmR0cmlwUXVldWUgPT09IG51bGwgPyAwIDogdGhpcy5yb3VuZHRyaXBRdWV1ZS50aWNrLAogICAgICBpZDogMCwKICAgICAgZm9yazogdGhpcy5yZW1vdGVGb3JrLAogICAgICBibG9jazogbnVsbCwKICAgICAgaGFzaDogbnVsbCwKICAgICAgc2VlazogbnVsbCwKICAgICAgdXBncmFkZToKICAgICAgICBuZWVkc1VwZ3JhZGUgPT09IGZhbHNlCiAgICAgICAgICA/IG51bGwKICAgICAgICAgIDogeyBzdGFydDogdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCwgbGVuZ3RoOiB0aGlzLnJlbW90ZUxlbmd0aCAtIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggfSwKICAgICAgLy8gcmVtb3RlIG1hbmlmZXN0IGNoZWNrIGNhbiBiZSByZW1vdmVkIGV2ZW50dWFsbHkuLi4KICAgICAgbWFuaWZlc3Q6IHRoaXMuY29yZS5oZWFkZXIubWFuaWZlc3QgPT09IG51bGwgJiYgdGhpcy5yZW1vdGVIYXNNYW5pZmVzdCA9PT0gdHJ1ZSwKICAgICAgcHJpb3JpdHksCiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgZWxhcHNlZDogMAogICAgfQogIH0KCiAgX3JlcXVlc3RNYW5pZmVzdCgpIHsKICAgIGNvbnN0IHJlcSA9IHRoaXMuX21ha2VSZXF1ZXN0KGZhbHNlLCAwLCAwKQogICAgdGhpcy5fc2VuZChyZXEpCiAgfQoKICBfaW5jbHVkZUxhc3RCbG9jaygpIHsKICAgIGlmICh0aGlzLnJlcGxpY2F0b3IuX2Fsd2F5c0xhdGVzdEJsb2NrID09PSAwKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IGluZGV4ID0gdGhpcy5yZW1vdGVMZW5ndGggLSAxCgogICAgLy8gb25seSB2YWxpZCBpZiBpdHMgYW4gT09CIGdldAogICAgaWYgKGluZGV4IDwgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkgcmV0dXJuIG51bGwKCiAgICAvLyBkbyB0aGUgbm9ybWFsIGNoZWNrcwogICAgaWYgKCF0aGlzLl9yZW1vdGVIYXNCbG9jayhpbmRleCkpIHJldHVybiBudWxsCiAgICBpZiAoIXRoaXMuX2NhblJlcXVlc3QoaW5kZXgpKSByZXR1cm4gbnVsbAoKICAgIC8vIGF0bSB3ZSBvbmx5IGV2ZXIgZG8gb25lIHVwZ3JhZGUgcmVxdWVzdCBpbiBwYXJhbGxlbCwgaWYgdGhhdCBjaGFuZ2VzCiAgICAvLyB0aGVuIHdlIHNob3VsZCBhZGQgc29tZSBjaGVjayBoZXJlIGZvciBpbmZsaWdodHMgdG8gYXZvaWQgb3ZlciByZXF1ZXN0aW5nCiAgICBjb25zdCBiID0gdGhpcy5yZXBsaWNhdG9yLl9ibG9ja3MuYWRkKGluZGV4LCBQUklPUklUWS5OT1JNQUwpCiAgICByZXR1cm4gYgogIH0KCiAgX3JlcXVlc3RVcGdyYWRlKHUpIHsKICAgIGNvbnN0IHJlcSA9IHRoaXMuX21ha2VSZXF1ZXN0KHRydWUsIDAsIDApCiAgICBpZiAocmVxID09PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBiID0gdGhpcy5faW5jbHVkZUxhc3RCbG9jaygpCgogICAgaWYgKGIpIHRoaXMuX3NlbmRCbG9ja1JlcXVlc3QocmVxLCBiKQogICAgZWxzZSB0aGlzLl9zZW5kKHJlcSkKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3JlcXVlc3RTZWVrKHMpIHsKICAgIC8vIGlmIHJlcGxpY2F0b3IgaXMgdXBkYXRpbmcgdGhlIHNlZWtzIGV0YywgYmFpbCBhbmQgd2FpdCBmb3IgaXQgdG8gZHJhaW4KICAgIGlmICh0aGlzLnJlcGxpY2F0b3IuX3VwZGF0ZXNQZW5kaW5nID4gMCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgeyBsZW5ndGgsIGZvcmsgfSA9IHRoaXMuY29yZS5zdGF0ZQoKICAgIGlmIChmb3JrICE9PSB0aGlzLnJlbW90ZUZvcmspIHJldHVybiBmYWxzZQoKICAgIGlmIChzLnNlZWtlci5zdGFydCA+PSBsZW5ndGgpIHsKICAgICAgY29uc3QgcmVxID0gdGhpcy5fbWFrZVJlcXVlc3QodHJ1ZSwgMCwgMCkKCiAgICAgIC8vIFdlIG5lZWQgYW4gdXBncmFkZSBmb3IgdGhlIHNlZWssIGlmIG5vbiBjYW4gYmUgcHJvdmlkZWQsIHNraXAKICAgICAgaWYgKHJlcSA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogICAgICByZXEuc2VlayA9IHRoaXMucmVtb3RlU3VwcG9ydHNTZWVrcwogICAgICAgID8geyBieXRlczogcy5zZWVrZXIuYnl0ZXMsIHBhZGRpbmc6IHMuc2Vla2VyLnBhZGRpbmcgfQogICAgICAgIDogbnVsbAoKICAgICAgcy5pbmZsaWdodC5wdXNoKHJlcSkKICAgICAgdGhpcy5fc2VuZChyZXEpCgogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGNvbnN0IGxlbiA9IHMuc2Vla2VyLmVuZCAtIHMuc2Vla2VyLnN0YXJ0CiAgICBjb25zdCBvZmYgPSBzLnNlZWtlci5zdGFydCArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGxlbikKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIGxldCBpbmRleCA9IG9mZiArIGkKICAgICAgaWYgKGluZGV4ID4gcy5zZWVrZXIuZW5kKSBpbmRleCAtPSBsZW4KCiAgICAgIGlmICh0aGlzLl9yZW1vdGVIYXNCbG9jayhpbmRleCkgPT09IGZhbHNlKSBjb250aW51ZQogICAgICBpZiAodGhpcy5jb3JlLmJpdGZpZWxkLmdldChpbmRleCkgPT09IHRydWUpIGNvbnRpbnVlCiAgICAgIGlmICghdGhpcy5fY2FuUmVxdWVzdChpbmRleCkpIGNvbnRpbnVlCgogICAgICAvLyBDaGVjayBpZiB0aGlzIGJsb2NrIGlzIGN1cnJlbnRseSBpbmZsaWdodCAtIGlmIHNvIHBpY2sgYW5vdGhlcgogICAgICBjb25zdCBiID0gdGhpcy5yZXBsaWNhdG9yLl9ibG9ja3MuZ2V0KGluZGV4KQogICAgICBpZiAoYiAhPT0gbnVsbCAmJiBiLmluZmxpZ2h0Lmxlbmd0aCA+IDApIGNvbnRpbnVlCgogICAgICAvLyBCbG9jayBpcyBub3QgaW5mbGlnaHQsIGJ1dCB3ZSBvbmx5IHdhbnQgdGhlIGhhc2gsIGNoZWNrIGlmIHRoYXQgaXMgaW5mbGlnaHQKICAgICAgY29uc3QgaCA9IHRoaXMucmVwbGljYXRvci5faGFzaGVzLmFkZChpbmRleCwgUFJJT1JJVFkuTk9STUFMKQogICAgICBpZiAoaC5pbmZsaWdodC5sZW5ndGggPiAwKSBjb250aW51ZQoKICAgICAgY29uc3QgcmVxID0gdGhpcy5fbWFrZVJlcXVlc3QoZmFsc2UsIGgucHJpb3JpdHksIGluZGV4ICsgMSkKICAgICAgaWYgKHJlcSA9PT0gbnVsbCkgY29udGludWUKCiAgICAgIGNvbnN0IG5vZGVzID0gZmxhdFRyZWUuZGVwdGgocy5zZWVrZXIuc3RhcnQgKyBzLnNlZWtlci5lbmQgLSAxKQoKICAgICAgcmVxLmhhc2ggPSB7IGluZGV4OiAyICogaW5kZXgsIG5vZGVzIH0KICAgICAgcmVxLnNlZWsgPSB0aGlzLnJlbW90ZVN1cHBvcnRzU2Vla3MKICAgICAgICA/IHsgYnl0ZXM6IHMuc2Vla2VyLmJ5dGVzLCBwYWRkaW5nOiBzLnNlZWtlci5wYWRkaW5nIH0KICAgICAgICA6IG51bGwKCiAgICAgIHMuaW5mbGlnaHQucHVzaChyZXEpCiAgICAgIGguaW5mbGlnaHQucHVzaChyZXEpCiAgICAgIHRoaXMuX3NlbmQocmVxKQoKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICB0aGlzLl9tYXliZVdhbnQocy5zZWVrZXIuc3RhcnQsIGxlbikKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX2NhblJlcXVlc3QoaW5kZXgpIHsKICAgIGlmICghKGluZGV4ID49IDApKSB0aHJvdyBBU1NFUlRJT04oJ2JhZCBpbmRleCB0byBfY2FuUmVxdWVzdDogJyArIGluZGV4KQoKICAgIGlmICh0aGlzLnJlbW90ZUxlbmd0aCA+PSB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoKSB7CiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgaWYgKGluZGV4IDwgdGhpcy5sYXN0VXBncmFkYWJsZUxlbmd0aCAmJiB0aGlzLmxhc3RVcGdyYWRhYmxlRm9yayA9PT0gdGhpcy5jb3JlLnN0YXRlLmZvcmspIHsKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBpZiAodGhpcy5jYW5VcGdyYWRlICYmIHRoaXMuc3luY3NQcm9jZXNzaW5nID09PSAwKSB7CiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBfcmVtb3RlSGFzQmxvY2soaW5kZXgpIHsKICAgIHJldHVybiBpbmRleCA8IHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGggfHwgdGhpcy5yZW1vdGVCaXRmaWVsZC5nZXQoaW5kZXgpID09PSB0cnVlCiAgfQoKICBfc2VuZEJsb2NrUmVxdWVzdChyZXEsIGIpIHsKICAgIHJlcS5ibG9jayA9IHsgaW5kZXg6IGIuaW5kZXgsIG5vZGVzOiAwIH0KICAgIHRoaXMucmVwbGljYXRvci5fbWFya0luZmxpZ2h0KGIuaW5kZXgpCgogICAgYi5pbmZsaWdodC5wdXNoKHJlcSkKICAgIHRoaXMucmVwbGljYXRvci5ob3Rzd2Fwcy5hZGQoYikKICAgIHRoaXMuX3NlbmQocmVxKQogIH0KCiAgX3JlcXVlc3RCbG9jayhiKSB7CiAgICBjb25zdCB7IGxlbmd0aCwgZm9yayB9ID0gdGhpcy5jb3JlLnN0YXRlCgogICAgaWYgKHRoaXMuX3JlbW90ZUhhc0Jsb2NrKGIuaW5kZXgpID09PSBmYWxzZSB8fCBmb3JrICE9PSB0aGlzLnJlbW90ZUZvcmspIHsKICAgICAgdGhpcy5fbWF5YmVXYW50KGIuaW5kZXgpCiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmICghdGhpcy5fY2FuUmVxdWVzdChiLmluZGV4KSkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgcmVxID0gdGhpcy5fbWFrZVJlcXVlc3QoYi5pbmRleCA+PSBsZW5ndGgsIGIucHJpb3JpdHksIGIuaW5kZXggKyAxKQogICAgaWYgKHJlcSA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogICAgdGhpcy5fc2VuZEJsb2NrUmVxdWVzdChyZXEsIGIpCgogICAgcmV0dXJuIHRydWUKICB9CgogIF9yZXF1ZXN0UmFuZ2VCbG9jayhpbmRleCwgbGVuZ3RoKSB7CiAgICBpZiAodGhpcy5jb3JlLmJpdGZpZWxkLmdldChpbmRleCkgPT09IHRydWUgfHwgIXRoaXMuX2NhblJlcXVlc3QoaW5kZXgpKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBiID0gdGhpcy5yZXBsaWNhdG9yLl9ibG9ja3MuYWRkKGluZGV4LCBQUklPUklUWS5OT1JNQUwpCiAgICBpZiAoYi5pbmZsaWdodC5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5zZXQoaW5kZXgsIGZhbHNlKSAvLyBpbiBjYXNlIHdlIG1pc3NlZCBzb21lIHN0YXRlcyBqdXN0IHNldCB0aGVtIG9uZGVtYW5kLCBuYmQKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc3QgcmVxID0gdGhpcy5fbWFrZVJlcXVlc3QoaW5kZXggPj0gbGVuZ3RoLCBiLnByaW9yaXR5LCBpbmRleCArIDEpCgogICAgLy8gSWYgdGhlIHJlcXVlc3QgY2Fubm90IGJlIHNhdGlzZmllZCwgZGVhbGxvYyB0aGUgYmxvY2sgcmVxdWVzdCBpZiBubyBvbmUgaXMgc3Vic2NyaWJlZCB0byBpdAogICAgaWYgKHJlcSA9PT0gbnVsbCkgewogICAgICBiLmdjKCkKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgdGhpcy5fc2VuZEJsb2NrUmVxdWVzdChyZXEsIGIpCgogICAgLy8gRG9uJ3QgdGhpbmsgdGhpcyB3aWxsIGV2ZXIgaGFwcGVuLCBhcyB0aGUgcGVuZGluZyBxdWV1ZSBpcyBkcmFpbmVkIGJlZm9yZSB0aGUgcmFuZ2UgcXVldWUKICAgIC8vIGJ1dCBkb2Vzbid0IGh1cnQgdG8gY2hlY2sgdGhpcyBleHBsaWNpdGx5IGhlcmUgYWxzby4KICAgIGlmIChiLnF1ZXVlZCkgYi5xdWV1ZWQgPSBmYWxzZQogICAgcmV0dXJuIHRydWUKICB9CgogIF9maW5kTmV4dChpKSB7CiAgICBpZiAoaSA8IHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpIHsKICAgICAgaWYgKHRoaXMuY29yZS5za2lwQml0ZmllbGQgPT09IG51bGwpIHRoaXMucmVwbGljYXRvci5fb3BlblNraXBCaXRmaWVsZCgpCiAgICAgIGkgPSB0aGlzLmNvcmUuc2tpcEJpdGZpZWxkLmZpbmRGaXJzdChmYWxzZSwgaSkKICAgICAgaWYgKGkgPCB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoICYmIGkgPiAtMSkgcmV0dXJuIGkKICAgICAgaSA9IHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGgKICAgIH0KCiAgICByZXR1cm4gdGhpcy5taXNzaW5nQmxvY2tzLmZpbmRGaXJzdCh0cnVlLCBpKQogIH0KCiAgX3JlcXVlc3RSYW5nZShyKSB7CiAgICBpZiAodGhpcy5zeW5jc1Byb2Nlc3NpbmcgPiAwKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCB7IGxlbmd0aCwgZm9yayB9ID0gdGhpcy5jb3JlLnN0YXRlCgogICAgaWYgKHIuYmxvY2tzKSB7CiAgICAgIGxldCBtaW4gPSAtMQogICAgICBsZXQgbWF4ID0gLTEKCiAgICAgIGZvciAobGV0IGkgPSByLnN0YXJ0OyBpIDwgci5lbmQ7IGkrKykgewogICAgICAgIGNvbnN0IGluZGV4ID0gci5ibG9ja3NbaV0KICAgICAgICBpZiAobWluID09PSAtMSB8fCBpbmRleCA8IG1pbikgbWluID0gaW5kZXgKICAgICAgICBpZiAobWF4ID09PSAtMSB8fCBpbmRleCA+IG1heCkgbWF4ID0gaW5kZXgKICAgICAgICBjb25zdCBoYXMgPSBpbmRleCA8IHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGggfHwgdGhpcy5taXNzaW5nQmxvY2tzLmdldChpbmRleCkgPT09IHRydWUKICAgICAgICBpZiAoaGFzID09PSB0cnVlICYmIHRoaXMuX3JlcXVlc3RSYW5nZUJsb2NrKGluZGV4LCBsZW5ndGgpKSByZXR1cm4gdHJ1ZQogICAgICB9CgogICAgICBpZiAobWluID4gLTEpIHRoaXMuX21heWJlV2FudChtaW4sIG1heCAtIG1pbikKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgLy8gaWYgd2UgY2FuIHVwZ3JhZGUgdGhlIHJlbW90ZSwgb3IgdGhlIHJlbW90ZSBpcyBhaGVhZCwgdGhlbiBhbGwgdGhlIHJlbW90ZXMgYmxvY2tzIGFyZSB2YWxpZAogICAgLy8gb3RoZXJ3aXNlIHRydW5jYXRlIHRvIHRoZSBsYXN0IGxlbmd0aCB0aGUgcmVtb3RlIGhhcyBhY2tlZCBmb3IgdXMKICAgIGNvbnN0IG1heExvY2FsTGVuZ3RoID0KICAgICAgdGhpcy5jYW5VcGdyYWRlIHx8IHRoaXMucmVtb3RlTGVuZ3RoID49IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgKICAgICAgICA/IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgKICAgICAgICA6IGZvcmsgPT09IHRoaXMubGFzdFVwZ3JhZGFibGVGb3JrCiAgICAgICAgICA/IE1hdGgubWluKHRoaXMubGFzdFVwZ3JhZGFibGVMZW5ndGgsIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpCiAgICAgICAgICA6IDAKCiAgICBjb25zdCBlbmQgPSBNYXRoLm1pbigKICAgICAgbWF4TG9jYWxMZW5ndGgsCiAgICAgIE1hdGgubWluKHIuZW5kID09PSAtMSA/IHRoaXMucmVtb3RlTGVuZ3RoIDogci5lbmQsIHRoaXMucmVtb3RlTGVuZ3RoKQogICAgKQogICAgaWYgKGVuZCA8PSByLnN0YXJ0IHx8IGZvcmsgIT09IHRoaXMucmVtb3RlRm9yaykgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgbGVuID0gZW5kIC0gci5zdGFydAogICAgY29uc3Qgb2ZmID0gci5zdGFydCArIChyLmxpbmVhciA/IDAgOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBsZW4pKQoKICAgIGxldCBpID0gb2ZmCiAgICAvLyBzaG91bGQgYmUgd2F5IGxlc3MgdGhhbiB0aGlzLCBidXQgdGhpcyBpcyB3b3JzdCBjYXNlIHVwcGVyIGJvdW5kIGZvciB0aGUgc2tpcGxpc3QKICAgIGxldCB0cmllcyA9IHRoaXMuaW5mbGlnaHQKCiAgICBkbyB7CiAgICAgIGkgPSB0aGlzLl9maW5kTmV4dChpKQogICAgICBpZiAoaSA9PT0gLTEgfHwgaSA+PSBlbmQpIGJyZWFrCgogICAgICBpZiAodGhpcy5fcmVxdWVzdFJhbmdlQmxvY2soaSwgbGVuZ3RoKSkgcmV0dXJuIHRydWUKICAgICAgaSsrCiAgICB9IHdoaWxlICh0cmllcy0tID4gMCkKCiAgICBpID0gci5zdGFydAoKICAgIGRvIHsKICAgICAgaSA9IHRoaXMuX2ZpbmROZXh0KGkpCiAgICAgIGlmIChpID09PSAtMSB8fCBpID49IG9mZikgYnJlYWsKCiAgICAgIGlmICh0aGlzLl9yZXF1ZXN0UmFuZ2VCbG9jayhpLCBsZW5ndGgpKSByZXR1cm4gdHJ1ZQogICAgICBpKysKICAgIH0gd2hpbGUgKHRyaWVzLS0gPiAwKQoKICAgIHRoaXMuX21heWJlV2FudChyLnN0YXJ0LCBsZW4pCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF9yZXF1ZXN0Rm9ya1Byb29mKGYpIHsKICAgIGlmICghdGhpcy5yZW1vdGVMZW5ndGgpIHJldHVybgoKICAgIGNvbnN0IHJlcSA9IHRoaXMuX21ha2VSZXF1ZXN0KGZhbHNlLCAwLCAwKQoKICAgIHJlcS51cGdyYWRlID0geyBzdGFydDogMCwgbGVuZ3RoOiB0aGlzLnJlbW90ZUxlbmd0aCB9CiAgICByZXEubWFuaWZlc3QgPSAhdGhpcy5jb3JlLmhlYWRlci5tYW5pZmVzdAoKICAgIGYuaW5mbGlnaHQucHVzaChyZXEpCiAgICB0aGlzLl9zZW5kKHJlcSkKICB9CgogIF9yZXF1ZXN0Rm9ya1JhbmdlKGYpIHsKICAgIGlmIChmLmZvcmsgIT09IHRoaXMucmVtb3RlRm9yayB8fCBmLmJhdGNoLndhbnQgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGVuZCA9IE1hdGgubWluKGYuYmF0Y2gud2FudC5lbmQsIHRoaXMucmVtb3RlTGVuZ3RoKQogICAgaWYgKGVuZCA8IGYuYmF0Y2gud2FudC5zdGFydCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgbGVuID0gZW5kIC0gZi5iYXRjaC53YW50LnN0YXJ0CiAgICBjb25zdCBvZmYgPSBmLmJhdGNoLndhbnQuc3RhcnQgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBsZW4pCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICBsZXQgaW5kZXggPSBvZmYgKyBpCiAgICAgIGlmIChpbmRleCA+PSBlbmQpIGluZGV4IC09IGxlbgoKICAgICAgaWYgKHRoaXMuX3JlbW90ZUhhc0Jsb2NrKGluZGV4KSA9PT0gZmFsc2UpIGNvbnRpbnVlCgogICAgICBjb25zdCByZXEgPSB0aGlzLl9tYWtlUmVxdWVzdChmYWxzZSwgMCwgMCkKCiAgICAgIHJlcS5oYXNoID0geyBpbmRleDogMiAqIGluZGV4LCBub2RlczogZi5iYXRjaC53YW50Lm5vZGVzIH0KCiAgICAgIGYuaW5mbGlnaHQucHVzaChyZXEpCiAgICAgIHRoaXMuX3NlbmQocmVxKQoKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICB0aGlzLl9tYXliZVdhbnQoZi5iYXRjaC53YW50LnN0YXJ0LCBsZW4pCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF9tYXliZVdhbnQoc3RhcnQsIGxlbmd0aCA9IDEpIHsKICAgIGlmIChzdGFydCArIGxlbmd0aCA8PSB0aGlzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpIHJldHVybgoKICAgIGxldCBpID0gTWF0aC5mbG9vcihzdGFydCAvIERFRkFVTFRfU0VHTUVOVF9TSVpFKQogICAgY29uc3QgbiA9IE1hdGguY2VpbCgoc3RhcnQgKyBsZW5ndGgpIC8gREVGQVVMVF9TRUdNRU5UX1NJWkUpCgogICAgZm9yICg7IGkgPCBuOyBpKyspIHsKICAgICAgaWYgKHRoaXMuc2VnbWVudHNXYW50ZWQuaGFzKGkpKSBjb250aW51ZQogICAgICB0aGlzLnNlZ21lbnRzV2FudGVkLmFkZChpKQoKICAgICAgdGhpcy53aXJlV2FudC5zZW5kKHsKICAgICAgICBzdGFydDogaSAqIERFRkFVTFRfU0VHTUVOVF9TSVpFLAogICAgICAgIGxlbmd0aDogREVGQVVMVF9TRUdNRU5UX1NJWkUKICAgICAgfSkKICAgICAgaW5jcmVtZW50VHgodGhpcy5zdGF0cy53aXJlV2FudCwgdGhpcy5yZXBsaWNhdG9yLnN0YXRzLndpcmVXYW50KQogICAgfQogIH0KCiAgaXNBY3RpdmUoKSB7CiAgICBpZiAodGhpcy5wYXVzZWQgfHwgdGhpcy5yZW1vdmVkIHx8IHRoaXMuY29yZS5oZWFkZXIuZnJvemVuKSByZXR1cm4gZmFsc2UKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBfc2VuZChyZXEpIHsKICAgIGNvbnN0IGZvcmsgPSB0aGlzLmNvcmUuc3RhdGUuZm9yawoKICAgIHRoaXMuaW5mbGlnaHQrKwogICAgdGhpcy5yZXBsaWNhdG9yLl9pbmZsaWdodC5hZGQocmVxKQoKICAgIGlmIChyZXEudXBncmFkZSAhPT0gbnVsbCAmJiByZXEuZm9yayA9PT0gZm9yaykgewogICAgICBjb25zdCB1ID0gdGhpcy5yZXBsaWNhdG9yLl9hZGRVcGdyYWRlKCkKICAgICAgdS5pbmZsaWdodC5wdXNoKHJlcSkKICAgIH0KCiAgICB0cnkgewogICAgICBpZiAocmVxLmJsb2NrICE9PSBudWxsICYmIHJlcS5mb3JrID09PSBmb3JrKSB7CiAgICAgICAgcmVxLmJsb2NrLm5vZGVzID0gYXdhaXQgTWVya2xlVHJlZS5taXNzaW5nTm9kZXMoCiAgICAgICAgICB0aGlzLmNvcmUuc3RhdGUsCiAgICAgICAgICAyICogcmVxLmJsb2NrLmluZGV4LAogICAgICAgICAgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aAogICAgICAgICkKICAgICAgICBpZiAocmVxLnByaW9yaXR5ID09PSBQUklPUklUWS5DQU5DRUxMRUQpIHJldHVybgogICAgICB9CiAgICAgIGlmIChyZXEuaGFzaCAhPT0gbnVsbCAmJiByZXEuZm9yayA9PT0gZm9yayAmJiByZXEuaGFzaC5ub2RlcyA9PT0gMCkgewogICAgICAgIHJlcS5oYXNoLm5vZGVzID0gYXdhaXQgTWVya2xlVHJlZS5taXNzaW5nTm9kZXMoCiAgICAgICAgICB0aGlzLmNvcmUuc3RhdGUsCiAgICAgICAgICByZXEuaGFzaC5pbmRleCwKICAgICAgICAgIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgKICAgICAgICApCiAgICAgICAgaWYgKHJlcS5wcmlvcml0eSA9PT0gUFJJT1JJVFkuQ0FOQ0VMTEVEKSByZXR1cm4KCiAgICAgICAgLy8gbm9kZXMgPT09IDAsIHdlIGFscmVhZHkgaGF2ZSBpdCwgYmFpbAogICAgICAgIGlmIChyZXEuaGFzaC5ub2RlcyA9PT0gMCAmJiAocmVxLmhhc2guaW5kZXggJiAxKSA9PT0gMCkgewogICAgICAgICAgdGhpcy5pbmZsaWdodC0tCiAgICAgICAgICB0aGlzLnJlcGxpY2F0b3IuX3Jlc29sdmVIYXNoTG9jYWxseSh0aGlzLCByZXEpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLnN0cmVhbS5kZXN0cm95KGVycikKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy53aXJlUmVxdWVzdC5zZW5kKHJlcSkKICAgIGluY3JlbWVudFR4KHRoaXMuc3RhdHMud2lyZVJlcXVlc3QsIHRoaXMucmVwbGljYXRvci5zdGF0cy53aXJlUmVxdWVzdCkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUmVwbGljYXRvciB7CiAgc3RhdGljIFBlZXIgPSBQZWVyIC8vIGhhY2sgdG8gYmUgYWJsZSB0byBhY2Nlc3MgUGVlciBmcm9tIG91dHNpZGUgdGhpcyBtb2R1bGUKCiAgY29uc3RydWN0b3IoCiAgICBjb3JlLAogICAgewogICAgICBub3REb3dubG9hZGluZ0xpbmdlciA9IE5PVF9ET1dOTE9BRElOR19TTEFDSywKICAgICAgZWFnZXJVcGdyYWRlID0gdHJ1ZSwKICAgICAgYWxsb3dGb3JrID0gdHJ1ZSwKICAgICAgYWxsb3dQdXNoID0gZmFsc2UsCiAgICAgIGFsd2F5c0xhdGVzdEJsb2NrID0gZmFsc2UsCiAgICAgIGluZmxpZ2h0UmFuZ2UgPSBudWxsCiAgICB9ID0ge30KICApIHsKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMuZWFnZXJVcGdyYWRlID0gZWFnZXJVcGdyYWRlCiAgICB0aGlzLmFsbG93Rm9yayA9IGFsbG93Rm9yawogICAgdGhpcy5hbGxvd1B1c2ggPSBhbGxvd1B1c2gKICAgIHRoaXMub25kb3dubG9hZGluZyA9IG51bGwgLy8gb3B0aW9uYWwgZXh0ZXJuYWwgaG9vayBmb3IgbW9uaXRvcmluZyBkb3dubG9hZGluZyBzdGF0dXMKICAgIHRoaXMucGVlcnMgPSBbXQogICAgdGhpcy5maW5kaW5nUGVlcnMgPSAwIC8vIHVwZGF0YWJsZSBmcm9tIHRoZSBvdXRzaWRlCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLmRvd25sb2FkaW5nID0gZmFsc2UKICAgIHRoaXMuYWN0aXZlU2Vzc2lvbnMgPSAwCgogICAgdGhpcy5ob3Rzd2FwcyA9IG5ldyBIb3Rzd2FwUXVldWUoKQogICAgdGhpcy5pbmZsaWdodFJhbmdlID0gaW5mbGlnaHRSYW5nZSB8fCBERUZBVUxUX01BWF9JTkZMSUdIVAoKICAgIC8vIE5vdGU6IG5vZGF0YSBhbmQgdW53YW50IG5vdCBjdXJyZW50bHkgdHJhY2tlZAogICAgLy8gdHggPSB0cmFuc21pdHRlZCwgcnggPSByZWNlaXZlZAogICAgdGhpcy5zdGF0cyA9IHsKICAgICAgd2lyZVN5bmM6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVSZXF1ZXN0OiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlQ2FuY2VsOiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlRGF0YTogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZVdhbnQ6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVCaXRmaWVsZDogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZVJhbmdlOiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlRXh0ZW5zaW9uOiB7IHR4OiAwLCByeDogMCB9LAogICAgICBob3Rzd2FwczogMCwKICAgICAgaW52YWxpZERhdGE6IDAsCiAgICAgIGludmFsaWRSZXF1ZXN0czogMCwKICAgICAgYmFja29mZnM6IDAKICAgIH0KCiAgICB0aGlzLl9hdHRhY2hlZCA9IG5ldyBTZXQoKQogICAgdGhpcy5faW5mbGlnaHQgPSBuZXcgSW5mbGlnaHRUcmFja2VyKCkKICAgIHRoaXMuX2Jsb2NrcyA9IG5ldyBCbG9ja1RyYWNrZXIodGhpcykKICAgIHRoaXMuX2hhc2hlcyA9IG5ldyBCbG9ja1RyYWNrZXIodGhpcykKCiAgICB0aGlzLl9hbHdheXNMYXRlc3RCbG9jayA9IGFsd2F5c0xhdGVzdEJsb2NrID8gMSA6IDAKICAgIHRoaXMuX3F1ZXVlZCA9IFtdCgogICAgdGhpcy5fc2Vla3MgPSBbXQogICAgdGhpcy5fdXBncmFkZSA9IG51bGwKICAgIHRoaXMuX3Jlb3JncyA9IFtdCiAgICB0aGlzLl9yYW5nZXMgPSBbXQoKICAgIHRoaXMuX3B1c2hMb2NrID0gbmV3IE11dGV4KCkKICAgIHRoaXMuX2hhZFBlZXJzID0gZmFsc2UKICAgIHRoaXMuX2FjdGl2ZSA9IDAKICAgIHRoaXMuX2lmQXZhaWxhYmxlID0gMAogICAgdGhpcy5fdXBkYXRlc1BlbmRpbmcgPSAwCiAgICB0aGlzLl9hcHBseWluZ1Jlb3JnID0gbnVsbAogICAgdGhpcy5fbWFuaWZlc3RQZWVyID0gbnVsbAogICAgdGhpcy5fbm90RG93bmxvYWRpbmdMaW5nZXIgPSBub3REb3dubG9hZGluZ0xpbmdlcgogICAgdGhpcy5fZG93bmxvYWRpbmdUaW1lciA9IG51bGwKCiAgICBjb25zdCBzZWxmID0gdGhpcwogICAgdGhpcy5fb25zdHJlYW1jbG9zZSA9IG9uc3RyZWFtY2xvc2UKCiAgICBmdW5jdGlvbiBvbnN0cmVhbWNsb3NlKCkgewogICAgICBzZWxmLmRldGFjaEZyb20odGhpcy51c2VyRGF0YSkKICAgIH0KICB9CgogIHVwZGF0ZUFjdGl2aXR5KGluYywgc2Vzc2lvbikgewogICAgdGhpcy5hY3RpdmVTZXNzaW9ucyArPSBpbmMKICAgIHRoaXMuc2V0RG93bmxvYWRpbmcodGhpcy5hY3RpdmVTZXNzaW9ucyAhPT0gMCwgc2Vzc2lvbikKICB9CgogIGlzRG93bmxvYWRpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5kb3dubG9hZGluZyB8fCAhdGhpcy5faW5mbGlnaHQuaWRsZQogIH0KCiAgYXN5bmMgcHVzaChpbmRleCkgewogICAgY29uc3QgYWxsID0gW10KICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSB7CiAgICAgIGFsbC5wdXNoKHBlZXIucHVzaChpbmRleCkpCiAgICB9CiAgICBhd2FpdCBQcm9taXNlLmFsbChhbGwpCiAgfQoKICBzZXRBbGxvd1B1c2goYWxsb3dQdXNoKSB7CiAgICBpZiAoYWxsb3dQdXNoID09PSB0aGlzLmFsbG93UHVzaCkgcmV0dXJuCiAgICB0aGlzLmFsbG93UHVzaCA9IGFsbG93UHVzaAogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHBlZXIuc2VuZFN5bmMoKQogIH0KCiAgc2V0RG93bmxvYWRpbmcoZG93bmxvYWRpbmcpIHsKICAgIGNsZWFyVGltZW91dCh0aGlzLl9kb3dubG9hZGluZ1RpbWVyKQoKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICBpZiAoZG93bmxvYWRpbmcgfHwgdGhpcy5fbm90RG93bmxvYWRpbmdMaW5nZXIgPT09IDApIHsKICAgICAgdGhpcy5zZXREb3dubG9hZGluZ05vdyhkb3dubG9hZGluZykKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5fZG93bmxvYWRpbmdUaW1lciA9IHNldFRpbWVvdXQoCiAgICAgIHNldERvd25sb2FkaW5nTGF0ZXIsCiAgICAgIHRoaXMuX25vdERvd25sb2FkaW5nTGluZ2VyLAogICAgICB0aGlzLAogICAgICBkb3dubG9hZGluZwogICAgKQogICAgaWYgKHRoaXMuX2Rvd25sb2FkaW5nVGltZXIudW5yZWYpIHRoaXMuX2Rvd25sb2FkaW5nVGltZXIudW5yZWYoKQogIH0KCiAgc2V0RG93bmxvYWRpbmdOb3coZG93bmxvYWRpbmcpIHsKICAgIHRoaXMuX2Rvd25sb2FkaW5nVGltZXIgPSBudWxsCiAgICBpZiAodGhpcy5kb3dubG9hZGluZyA9PT0gZG93bmxvYWRpbmcpIHJldHVybgogICAgdGhpcy5kb3dubG9hZGluZyA9IGRvd25sb2FkaW5nCiAgICBpZiAoIWRvd25sb2FkaW5nICYmIHRoaXMuaXNEb3dubG9hZGluZygpKSByZXR1cm4KCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5zaWduYWxVcGdyYWRlKCkKCiAgICBpZiAoZG93bmxvYWRpbmcpIHsKICAgICAgLy8gcmVzdGFydCBjaGFubmVsIGlmIG5lZWRlZC4uLgogICAgICBmb3IgKGNvbnN0IHByb3RvbXV4IG9mIHRoaXMuX2F0dGFjaGVkKSB7CiAgICAgICAgaWYgKCFwcm90b211eC5zdHJlYW0uaGFuZHNoYWtlSGFzaCkgY29udGludWUKICAgICAgICBpZiAocHJvdG9tdXgub3BlbmVkKHsgcHJvdG9jb2w6ICdoeXBlcmNvcmUvYWxwaGEnLCBpZDogdGhpcy5jb3JlLmRpc2NvdmVyeUtleSB9KSkgY29udGludWUKICAgICAgICB0aGlzLl9tYWtlUGVlcihwcm90b211eCwgdHJ1ZSkKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHBlZXIuY2xvc2VJZklkbGUoKQogICAgfQoKICAgIGlmICh0aGlzLm9uZG93bmxvYWRpbmcgIT09IG51bGwgJiYgZG93bmxvYWRpbmcpIHRoaXMub25kb3dubG9hZGluZygpCiAgfQoKICBjb3JrKCkgewogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHBlZXIucHJvdG9tdXguY29yaygpCiAgfQoKICB1bmNvcmsoKSB7CiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5wcm90b211eC51bmNvcmsoKQogIH0KCiAgLy8gQ2FsbGVkIGV4dGVybmFsbHkgd2hlbiBhIHJhbmdlIG9mIG5ldyBibG9ja3MgaGFzIGJlZW4gcHJvY2Vzc2VkL3JlbW92ZWQKICBvbmhhdmUoc3RhcnQsIGxlbmd0aCwgZHJvcCA9IGZhbHNlKSB7CiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5icm9hZGNhc3RSYW5nZShzdGFydCwgbGVuZ3RoLCBkcm9wKQogIH0KCiAgLy8gQ2FsbGVkIGV4dGVybmFsbHkgd2hlbiBhIHRydW5jYXRpb24gdXBncmFkZSBoYXMgYmVlbiBwcm9jZXNzZWQKICBvbnRydW5jYXRlKG5ld0xlbmd0aCwgdHJ1bmNhdGVkKSB7CiAgICBjb25zdCBub3RpZnkgPSBbXQoKICAgIGZvciAoY29uc3QgYmxrIG9mIHRoaXMuX2Jsb2NrcykgewogICAgICBpZiAoYmxrLmluZGV4IDwgbmV3TGVuZ3RoKSBjb250aW51ZQogICAgICBub3RpZnkucHVzaChibGspCiAgICB9CgogICAgZm9yIChjb25zdCBibGsgb2Ygbm90aWZ5KSB7CiAgICAgIGZvciAoY29uc3QgciBvZiBibGsucmVmcykgewogICAgICAgIGlmIChyLnNuYXBzaG90ID09PSBmYWxzZSkgY29udGludWUKICAgICAgICBibGsuZGV0YWNoKHIsIFNOQVBTSE9UX05PVF9BVkFJTEFCTEUoKSkKICAgICAgfQogICAgfQoKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSBwZWVyLl91bmNsZWFyTG9jYWxSYW5nZShuZXdMZW5ndGgsIHRydW5jYXRlZCkKICB9CgogIC8vIENhbGxlZCBleHRlcm5hbGx5IHdoZW4gYSB1cGdyYWRlIGhhcyBiZWVuIHByb2Nlc3NlZAogIG9udXBncmFkZSgpIHsKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSBwZWVyLnNpZ25hbFVwZ3JhZGUoKQogICAgaWYgKHRoaXMuX2Jsb2Nrcy5pc0VtcHR5KCkgPT09IGZhbHNlKSB0aGlzLl9yZXNvbHZlQmxvY2tzTG9jYWxseSgpCiAgICBpZiAodGhpcy5fdXBncmFkZSAhPT0gbnVsbCkgdGhpcy5fcmVzb2x2ZVVwZ3JhZGVSZXF1ZXN0KG51bGwpCiAgICBpZiAoIXRoaXMuX2Jsb2Nrcy5pc0VtcHR5KCkgfHwgdGhpcy5fcmFuZ2VzLmxlbmd0aCAhPT0gMCB8fCB0aGlzLl9zZWVrcy5sZW5ndGggIT09IDApIHsKICAgICAgdGhpcy5fdXBkYXRlTm9uUHJpbWFyeSh0cnVlKQogICAgfQogIH0KCiAgLy8gQ2FsbGVkIGV4dGVybmFsbHkgd2hlbiBhIGNvbmZsaWN0IGhhcyBiZWVuIGRldGVjdGVkIGFuZCB2ZXJpZmllZAogIGFzeW5jIG9uY29uZmxpY3QoKSB7CiAgICBjb25zdCBhbGwgPSBbXQogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHsKICAgICAgYWxsLnB1c2gocGVlci5fb25jb25mbGljdCgpKQogICAgfQogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKGFsbCkKICB9CgogIGFzeW5jIGFwcGx5UGVuZGluZ1Jlb3JnKCkgewogICAgaWYgKHRoaXMuX2FwcGx5aW5nUmVvcmcgIT09IG51bGwpIHsKICAgICAgYXdhaXQgdGhpcy5fYXBwbHlpbmdSZW9yZwogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGZvciAobGV0IGkgPSB0aGlzLl9yZW9yZ3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgZiA9IHRoaXMuX3Jlb3Jnc1tpXQogICAgICBpZiAoZi5iYXRjaCAhPT0gbnVsbCAmJiBmLmJhdGNoLmZpbmlzaGVkKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fYXBwbHlSZW9yZyhmKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIGFkZFVwZ3JhZGUoc2Vzc2lvbikgewogICAgaWYgKHRoaXMuX3VwZ3JhZGUgIT09IG51bGwpIHsKICAgICAgY29uc3QgcmVmID0gdGhpcy5fdXBncmFkZS5hdHRhY2goc2Vzc2lvbikKICAgICAgdGhpcy5fY2hlY2tVcGdyYWRlSWZBdmFpbGFibGUoKQogICAgICByZXR1cm4gcmVmCiAgICB9CgogICAgY29uc3QgcmVmID0gdGhpcy5fYWRkVXBncmFkZSgpLmF0dGFjaChzZXNzaW9uKQoKICAgIHRoaXMudXBkYXRlQWxsKCkKCiAgICByZXR1cm4gcmVmCiAgfQoKICBhZGRCbG9jayhzZXNzaW9uLCBpbmRleCkgewogICAgY29uc3QgYiA9IHRoaXMuX2Jsb2Nrcy5hZGQoaW5kZXgsIFBSSU9SSVRZLkhJR0gpCiAgICBjb25zdCByZWYgPSBiLmF0dGFjaChzZXNzaW9uKQoKICAgIHRoaXMuX3F1ZXVlQmxvY2soYikKICAgIHRoaXMudXBkYXRlQWxsKCkKCiAgICByZXR1cm4gcmVmCiAgfQoKICBhZGRTZWVrKHNlc3Npb24sIHNlZWtlcikgewogICAgY29uc3QgcyA9IG5ldyBTZWVrUmVxdWVzdCh0aGlzLCB0aGlzLl9zZWVrcywgc2Vla2VyKQogICAgY29uc3QgcmVmID0gcy5hdHRhY2goc2Vzc2lvbikKCiAgICB0aGlzLl9zZWVrcy5wdXNoKHMpCiAgICB0aGlzLnVwZGF0ZUFsbCgpCgogICAgcmV0dXJuIHJlZgogIH0KCiAgYWRkUmFuZ2UoCiAgICBzZXNzaW9uLAogICAgewogICAgICBzdGFydCA9IDAsCiAgICAgIGVuZCA9IC0xLAogICAgICBsZW5ndGggPSB0b0xlbmd0aChzdGFydCwgZW5kKSwKICAgICAgYmxvY2tzID0gbnVsbCwKICAgICAgbGluZWFyID0gZmFsc2UsCiAgICAgIGlmQXZhaWxhYmxlID0gZmFsc2UKICAgIH0gPSB7fQogICkgewogICAgaWYgKGJsb2NrcyAhPT0gbnVsbCkgewogICAgICAvLyBpZiB1c2luZyBibG9ja3MsIHN0YXJ0LCBlbmQganVzdCBhY3RzIGFzIGZyYW1lcyBhcm91bmQgdGhlIGJsb2NrcyBhcnJheQogICAgICBzdGFydCA9IDAKICAgICAgZW5kID0gbGVuZ3RoID0gYmxvY2tzLmxlbmd0aAogICAgfQoKICAgIGNvbnN0IHIgPSBuZXcgUmFuZ2VSZXF1ZXN0KAogICAgICB0aGlzLAogICAgICB0aGlzLl9yYW5nZXMsCiAgICAgIHN0YXJ0LAogICAgICBsZW5ndGggPT09IC0xID8gLTEgOiBzdGFydCArIGxlbmd0aCwKICAgICAgbGluZWFyLAogICAgICBpZkF2YWlsYWJsZSwKICAgICAgYmxvY2tzCiAgICApCgogICAgY29uc3QgcmVmID0gci5hdHRhY2goc2Vzc2lvbikKCiAgICAvLyBUcmlnZ2VyIHRoaXMgdG8gc2VlIGlmIHRoaXMgaXMgYWxyZWFkeSByZXNvbHZlZC4uLgogICAgLy8gQWxzbyBhdXRvIGNvbXByZXNzZXMgdGhlIHJhbmdlIGJhc2VkIG9uIGxvY2FsIGJpdGZpZWxkCiAgICBjbGFtcFJhbmdlKHRoaXMuY29yZSwgcikKCiAgICBpZiAoci5lbmQgIT09IC0xICYmIHIuc3RhcnQgPj0gci5lbmQpIHsKICAgICAgdGhpcy5fcmVzb2x2ZVJhbmdlUmVxdWVzdChyKQogICAgICByZXR1cm4gcmVmCiAgICB9CgogICAgdGhpcy51cGRhdGVBbGwoKQoKICAgIHJldHVybiByZWYKICB9CgogIGNhbmNlbChyZWYpIHsKICAgIHJlZi5jb250ZXh0LmRldGFjaChyZWYsIG51bGwpCiAgfQoKICBzdGF0aWMgY2xlYXJSZXF1ZXN0cyhzZXNzaW9uLCBlcnIpIHsKICAgIGlmIChzZXNzaW9uLmxlbmd0aCA9PT0gMCkgcmV0dXJuCgogICAgY29uc3QgdXBkYXRlZCA9IG5ldyBTZXQoKQoKICAgIHdoaWxlIChzZXNzaW9uLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgcmVmID0gc2Vzc2lvbltzZXNzaW9uLmxlbmd0aCAtIDFdCiAgICAgIHVwZGF0ZWQuYWRkKHJlZi5jb250ZXh0LnJlcGxpY2F0b3IpCiAgICAgIHJlZi5jb250ZXh0LmRldGFjaChyZWYsIGVycikKICAgIH0KCiAgICBmb3IgKGNvbnN0IHJlcGxpY2F0b3Igb2YgdXBkYXRlZCkgewogICAgICByZXBsaWNhdG9yLnVwZGF0ZUFsbCgpCiAgICB9CiAgfQoKICBjbGVhclJlcXVlc3RzKHNlc3Npb24sIGVyciA9IG51bGwpIHsKICAgIGxldCBjbGVhcmVkID0gZmFsc2UKICAgIHdoaWxlIChzZXNzaW9uLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgcmVmID0gc2Vzc2lvbltzZXNzaW9uLmxlbmd0aCAtIDFdCiAgICAgIHJlZi5jb250ZXh0LmRldGFjaChyZWYsIGVycikKICAgICAgY2xlYXJlZCA9IHRydWUKICAgIH0KCiAgICBpZiAoY2xlYXJlZCkgdGhpcy51cGRhdGVBbGwoKQogIH0KCiAgX21hdGNoaW5nUmVxdWVzdChyZXEsIGRhdGEpIHsKICAgIGlmICh0aGlzLmFsbG93UHVzaCkgewogICAgICByZXR1cm4gdHJ1ZQogICAgfQogICAgaWYgKGRhdGEuYmxvY2sgIT09IG51bGwgJiYgKHJlcS5ibG9jayA9PT0gbnVsbCB8fCByZXEuYmxvY2suaW5kZXggIT09IGRhdGEuYmxvY2suaW5kZXgpKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogICAgaWYgKGRhdGEuaGFzaCAhPT0gbnVsbCAmJiAocmVxLmhhc2ggPT09IG51bGwgfHwgcmVxLmhhc2guaW5kZXggIT09IGRhdGEuaGFzaC5pbmRleCkpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgICBpZiAoZGF0YS5zZWVrICE9PSBudWxsICYmIChyZXEuc2VlayA9PT0gbnVsbCB8fCByZXEuc2Vlay5ieXRlcyAhPT0gZGF0YS5zZWVrLmJ5dGVzKSkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICAgIGlmIChkYXRhLnVwZ3JhZGUgIT09IG51bGwgJiYgcmVxLnVwZ3JhZGUgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgICByZXR1cm4gcmVxLmZvcmsgPT09IGRhdGEuZm9yawogIH0KCiAgX2FkZFVwZ3JhZGVNYXliZSgpIHsKICAgIHJldHVybiB0aGlzLmVhZ2VyVXBncmFkZSA9PT0gdHJ1ZSA/IHRoaXMuX2FkZFVwZ3JhZGUoKSA6IHRoaXMuX3VwZ3JhZGUKICB9CgogIC8vIFRPRE86IHRoaXMgZnVuY3Rpb24gaXMgT1ZFUiBjYWxsZWQgYXRtLCBhdCBlYWNoIHVwZGF0ZVBlZXIvdXBkYXRlQWxsCiAgLy8gaW5zdGVhZCBpdHMgbW9yZSBlZmZpY2llbnQgdG8gb25seSBjYWxsIGl0IHdoZW4gdGhlIGNvbmRpdGlvbnMgaW4gaGVyZSBjaGFuZ2UgLSBpZSBvbiBzeW5jL2FkZC9yZW1vdmUgcGVlcgogIC8vIERvIHRoaXMgd2hlbiB3ZSBoYXZlIG1vcmUgdGVzdHMuCiAgX2NoZWNrVXBncmFkZUlmQXZhaWxhYmxlKCkgewogICAgaWYgKHRoaXMuX2lmQXZhaWxhYmxlID4gMCAmJiB0aGlzLnBlZXJzLmxlbmd0aCA8IE1BWF9QRUVSU19VUEdSQURFKSByZXR1cm4KICAgIGlmICh0aGlzLl91cGdyYWRlID09PSBudWxsIHx8IHRoaXMuX3VwZ3JhZGUucmVmcy5sZW5ndGggPT09IDApIHJldHVybgogICAgaWYgKHRoaXMuX2hhZFBlZXJzID09PSBmYWxzZSAmJiB0aGlzLmZpbmRpbmdQZWVycyA+IDApIHJldHVybgoKICAgIGNvbnN0IG1heFBlZXJzID0gTWF0aC5taW4odGhpcy5wZWVycy5sZW5ndGgsIE1BWF9QRUVSU19VUEdSQURFKQoKICAgIC8vIGNoZWNrIGlmIGEgcGVlciBjYW4gdXBncmFkZSB1cwoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWF4UGVlcnM7IGkrKykgewogICAgICBjb25zdCBwZWVyID0gdGhpcy5wZWVyc1tpXQoKICAgICAgaWYgKHBlZXIucmVtb3RlU3luY2VkID09PSBmYWxzZSkgcmV0dXJuCgogICAgICBpZiAodGhpcy5jb3JlLnN0YXRlLmxlbmd0aCA9PT0gMCAmJiBwZWVyLnJlbW90ZUxlbmd0aCA+IDApIHJldHVybgoKICAgICAgaWYgKHBlZXIucmVtb3RlTGVuZ3RoIDw9IHRoaXMuX3VwZ3JhZGUubGVuZ3RoIHx8IHBlZXIucmVtb3RlRm9yayAhPT0gdGhpcy5fdXBncmFkZS5mb3JrKSB7CiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgaWYgKHBlZXIuc3luY3NQcm9jZXNzaW5nID4gMCkgcmV0dXJuCgogICAgICBpZiAocGVlci5sZW5ndGhBY2tlZCAhPT0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCAmJiBwZWVyLnJlbW90ZUZvcmsgPT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrKSB7CiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIGlmIChwZWVyLnJlbW90ZUNhblVwZ3JhZGUgPT09IHRydWUpIHJldHVybgogICAgfQoKICAgIC8vIGNoZWNrIGlmIHJlb3JncyBpbiBwcm9ncmVzcy4uLgoKICAgIGlmICh0aGlzLl9hcHBseWluZ1Jlb3JnICE9PSBudWxsKSByZXR1cm4KCiAgICAvLyBUT0RPOiB3ZSBwcm9iIHNob3VsZCBOT1Qgd2FpdCBmb3IgaW5mbGlnaHQgcmVvcmdzIGhlcmUsIHNlZW1zIGJldHRlciB0byBqdXN0IHJlc29sdmUgdGhlIHVwZ3JhZGUKICAgIC8vIGFuZCB0aGVuIGFwcGx5IHRoZSByZW9yZyBvbiB0aGUgbmV4dCBjYWxsIGluIGNhc2UgaXQncyBzbG93IC0gbmVlZHMgc29tZSB0ZXN0aW5nIGluIHByYWN0aWNlCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9yZW9yZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgciA9IHRoaXMuX3Jlb3Jnc1tpXQogICAgICBpZiAoci5pbmZsaWdodC5sZW5ndGggPiAwKSByZXR1cm4KICAgIH0KCiAgICAvLyBpZiBzb21ldGhpbmcgaXMgaW5mbGlnaHQsIHdhaXQgZm9yIHRoYXQgZmlyc3QKICAgIGlmICh0aGlzLl91cGdyYWRlLmluZmxpZ2h0Lmxlbmd0aCA+IDApIHJldHVybgoKICAgIC8vIG5vdGhpbmcgdG8gZG8sIGluZGljYXRlIG5vIHVwZGF0ZSBhdmFpbAoKICAgIGNvbnN0IHUgPSB0aGlzLl91cGdyYWRlCiAgICB0aGlzLl91cGdyYWRlID0gbnVsbAogICAgdS5yZXNvbHZlKGZhbHNlKQogIH0KCiAgX2FkZFVwZ3JhZGUoKSB7CiAgICBpZiAodGhpcy5fdXBncmFkZSAhPT0gbnVsbCkgcmV0dXJuIHRoaXMuX3VwZ3JhZGUKCiAgICAvLyBUT0RPOiBuZWVkcyBhIHJlb3JnOiB0cnVlL2ZhbHNlIGZsYWcgdG8gaW5kaWNhdGUgaWYgdGhlIHVzZXIgcmVxdWVzdGVkIGEgcmVvcmcKICAgIHRoaXMuX3VwZ3JhZGUgPSBuZXcgVXBncmFkZVJlcXVlc3QodGhpcywgdGhpcy5jb3JlLnN0YXRlLmZvcmssIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpCgogICAgcmV0dXJuIHRoaXMuX3VwZ3JhZGUKICB9CgogIF9hZGRSZW9yZyhmb3JrLCBwZWVyKSB7CiAgICBpZiAodGhpcy5hbGxvd0ZvcmsgPT09IGZhbHNlKSByZXR1cm4gbnVsbAoKICAgIC8vIFRPRE86IGVhZ2VyIGdjIG9sZCByZW9yZ3MgZnJvbSB0aGUgc2FtZSBwZWVyCiAgICAvLyBub3Qgc3VwZXIgaW1wb3J0YW50IGJlY2F1c2UgdGhleSdsbCBnZXQgZ2MnZWQgd2hlbiB0aGUgcmVxdWVzdCBmaW5pc2hlcwogICAgLy8gYnV0IGp1c3Qgc3BhbSB0aGUgcmVtb3RlIGNhbiBkbyAuLi4KCiAgICBmb3IgKGNvbnN0IGYgb2YgdGhpcy5fcmVvcmdzKSB7CiAgICAgIGlmIChmLmZvcmsgPiBmb3JrICYmIGYuYmF0Y2ggIT09IG51bGwpIHJldHVybiBudWxsCiAgICAgIGlmIChmLmZvcmsgPT09IGZvcmspIHJldHVybiBmCiAgICB9CgogICAgY29uc3QgZiA9IHsKICAgICAgZm9yaywKICAgICAgaW5mbGlnaHQ6IFtdLAogICAgICBiYXRjaDogbnVsbAogICAgfQoKICAgIHRoaXMuX3Jlb3Jncy5wdXNoKGYpCgogICAgLy8gbWFpbnRhaW4gc29ydGVkIGJ5IGZvcmsKICAgIGxldCBpID0gdGhpcy5fcmVvcmdzLmxlbmd0aCAtIDEKICAgIHdoaWxlIChpID4gMCAmJiB0aGlzLl9yZW9yZ3NbaSAtIDFdLmZvcmsgPiBmb3JrKSB7CiAgICAgIHRoaXMuX3Jlb3Jnc1tpXSA9IHRoaXMuX3Jlb3Jnc1tpIC0gMV0KICAgICAgdGhpcy5fcmVvcmdzWy0taV0gPSBmCiAgICB9CgogICAgcmV0dXJuIGYKICB9CgogIF9zaG91bGRVcGdyYWRlKHBlZXIpIHsKICAgIGlmICh0aGlzLl91cGdyYWRlICE9PSBudWxsICYmIHRoaXMuX3VwZ3JhZGUuaW5mbGlnaHQubGVuZ3RoID4gMCkgcmV0dXJuIGZhbHNlCiAgICByZXR1cm4gKAogICAgICBwZWVyLnJlbW90ZUNhblVwZ3JhZGUgPT09IHRydWUgJiYKICAgICAgcGVlci5yZW1vdGVMZW5ndGggPiB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoICYmCiAgICAgIHBlZXIubGVuZ3RoQWNrZWQgPT09IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgKICAgICkKICB9CgogIF9hdXRvVXBncmFkZShwZWVyKSB7CiAgICByZXR1cm4gKAogICAgICB0aGlzLl91cGdyYWRlICE9PSBudWxsICYmCiAgICAgIHBlZXIucmVtb3RlRm9yayA9PT0gdGhpcy5jb3JlLnN0YXRlLmZvcmsgJiYKICAgICAgdGhpcy5fc2hvdWxkVXBncmFkZShwZWVyKQogICAgKQogIH0KCiAgX2FkZFBlZXIocGVlcikgewogICAgdGhpcy5faGFkUGVlcnMgPSB0cnVlCiAgICB0aGlzLnBlZXJzLnB1c2gocGVlcikKICAgIHRoaXMudXBkYXRlUGVlcihwZWVyKQogICAgdGhpcy5fb25wZWVydXBkYXRlKHRydWUsIHBlZXIpCiAgfQoKICBfcmVxdWVzdERvbmUoaWQsIHJvdW5kdHJpcCkgewogICAgdGhpcy5faW5mbGlnaHQucmVtb3ZlKGlkLCByb3VuZHRyaXApCiAgICBpZiAodGhpcy5pc0Rvd25sb2FkaW5nKCkgPT09IHRydWUpIHJldHVybgogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHBlZXIuc2lnbmFsVXBncmFkZSgpCiAgfQoKICBfcmVtb3ZlUGVlcihwZWVyKSB7CiAgICB0aGlzLnBlZXJzLnNwbGljZSh0aGlzLnBlZXJzLmluZGV4T2YocGVlciksIDEpCgogICAgaWYgKHRoaXMuX21hbmlmZXN0UGVlciA9PT0gcGVlcikgdGhpcy5fbWFuaWZlc3RQZWVyID0gbnVsbAoKICAgIGZvciAoY29uc3QgcmVxIG9mIHRoaXMuX2luZmxpZ2h0KSB7CiAgICAgIGlmIChyZXEucGVlciAhPT0gcGVlcikgY29udGludWUKICAgICAgdGhpcy5faW5mbGlnaHQucmVtb3ZlKHJlcS5pZCwgdHJ1ZSkKICAgICAgdGhpcy5fY2xlYXJSZXF1ZXN0KHBlZXIsIHJlcSkKICAgIH0KCiAgICB0aGlzLl9vbnBlZXJ1cGRhdGUoZmFsc2UsIHBlZXIpCiAgICB0aGlzLnVwZGF0ZUFsbCgpCiAgfQoKICBfcXVldWVCbG9jayhiKSB7CiAgICBpZiAoYi5pbmZsaWdodC5sZW5ndGggPiAwIHx8IGIucXVldWVkID09PSB0cnVlKSByZXR1cm4KICAgIGIucXVldWVkID0gdHJ1ZQogICAgdGhpcy5fcXVldWVkLnB1c2goYikKICB9CgogIF9yZXNvbHZlSGFzaExvY2FsbHkocGVlciwgcmVxKSB7CiAgICB0aGlzLl9yZXF1ZXN0RG9uZShyZXEuaWQsIGZhbHNlKQogICAgdGhpcy5fcmVzb2x2ZUJsb2NrUmVxdWVzdCh0aGlzLl9oYXNoZXMsIHJlcS5oYXNoLmluZGV4IC8gMiwgbnVsbCwgcmVxKQogICAgdGhpcy51cGRhdGVQZWVyKHBlZXIpCiAgfQoKICAvLyBSdW5zIGluIHRoZSBiYWNrZ3JvdW5kIC0gbm90IGFsbG93ZWQgdG8gdGhyb3cKICBhc3luYyBfcmVzb2x2ZUJsb2Nrc0xvY2FsbHkoKSB7CiAgICAvLyBUT0RPOiBjaGVjayBpZiBmb3JrIGNvbXBhdCBldGMuIFJlcXVpcmVzIHRoYXQgd2UgcGFzcyBkb3duIHRydW5jYXRpb24gaW5mbwoKICAgIGNvbnN0IGNsZWFyID0gW10KICAgIGNvbnN0IGJsb2NrcyA9IFtdCgogICAgY29uc3QgcmVhZGVyID0gdGhpcy5jb3JlLnN0b3JhZ2UucmVhZCgpCiAgICBmb3IgKGNvbnN0IGIgb2YgdGhpcy5fYmxvY2tzKSB7CiAgICAgIGlmICh0aGlzLmNvcmUuYml0ZmllbGQuZ2V0KGIuaW5kZXgpID09PSBmYWxzZSkgY29udGludWUKICAgICAgYmxvY2tzLnB1c2godGhpcy5fcmVzb2x2ZUxvY2FsQmxvY2soYiwgcmVhZGVyLCBjbGVhcikpCiAgICB9CiAgICByZWFkZXIudHJ5Rmx1c2goKQoKICAgIGF3YWl0IFByb21pc2UuYWxsKGJsb2NrcykKCiAgICBpZiAoIWNsZWFyLmxlbmd0aCkgcmV0dXJuCgogICAgLy8gQ3VycmVudGx5IHRoZSBibG9jayB0cmFja2VyIGRvZXMgbm90IHN1cHBvcnQgZGVsZXRlcyBkdXJpbmcgaXRlcmF0aW9uLCBzbyB3ZSBtYWtlCiAgICAvLyBzdXJlIHRvIGNsZWFyIHRoZW0gYWZ0ZXJ3YXJkcy4KICAgIGZvciAoY29uc3QgYiBvZiBjbGVhcikgewogICAgICB0aGlzLl9ibG9ja3MucmVtb3ZlKGIuaW5kZXgpCiAgICAgIHJlbW92ZUhvdHN3YXAoYikKICAgIH0KICB9CgogIGFzeW5jIF9yZXNvbHZlTG9jYWxCbG9jayhiLCByZWFkZXIsIHJlc29sdmVkKSB7CiAgICB0cnkgewogICAgICBiLnJlc29sdmUoYXdhaXQgcmVhZGVyLmdldEJsb2NrKGIuaW5kZXgpKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGIucmVqZWN0KGVycikKICAgICAgcmV0dXJuCiAgICB9CgogICAgcmVzb2x2ZWQucHVzaChiKQogIH0KCiAgX3Jlc29sdmVCbG9ja1JlcXVlc3QodHJhY2tlciwgaW5kZXgsIHZhbHVlLCByZXEpIHsKICAgIGNvbnN0IGIgPSB0cmFja2VyLnJlbW92ZShpbmRleCkKICAgIGlmIChiID09PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgICByZW1vdmVJbmZsaWdodChiLmluZmxpZ2h0LCByZXEpCiAgICByZW1vdmVIb3Rzd2FwKGIpCiAgICBiLnF1ZXVlZCA9IGZhbHNlCgogICAgYi5yZXNvbHZlKHZhbHVlKQoKICAgIGlmIChiLmluZmxpZ2h0Lmxlbmd0aCA+IDApIHsKICAgICAgLy8gaWYgYW55dGhpbmcgaXMgc3RpbGwgaW5mbGlnaHQsIGNhbmNlbCBpdAogICAgICBmb3IgKGxldCBpID0gYi5pbmZsaWdodC5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGNvbnN0IHJlcSA9IGIuaW5mbGlnaHRbaV0KICAgICAgICByZXEucGVlci5fY2FuY2VsUmVxdWVzdChyZXEpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3Jlc29sdmVVcGdyYWRlUmVxdWVzdChyZXEpIHsKICAgIGlmIChyZXEgIT09IG51bGwpIHJlbW92ZUluZmxpZ2h0KHRoaXMuX3VwZ3JhZGUuaW5mbGlnaHQsIHJlcSkKCiAgICBpZiAoCiAgICAgIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggPT09IHRoaXMuX3VwZ3JhZGUubGVuZ3RoICYmCiAgICAgIHRoaXMuY29yZS5zdGF0ZS5mb3JrID09PSB0aGlzLl91cGdyYWRlLmZvcmsKICAgICkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBjb25zdCB1ID0gdGhpcy5fdXBncmFkZQogICAgdGhpcy5fdXBncmFkZSA9IG51bGwKICAgIHUucmVzb2x2ZSh0cnVlKQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfcmVzb2x2ZVJhbmdlUmVxdWVzdChyZXEpIHsKICAgIHJlcS5yZXNvbHZlKHRydWUpCiAgICByZXEuZ2MoKQogIH0KCiAgX2NsZWFySW5mbGlnaHRCbG9jayh0cmFja2VyLCByZXEpIHsKICAgIGNvbnN0IGlzQmxvY2sgPSB0cmFja2VyID09PSB0aGlzLl9ibG9ja3MKICAgIGNvbnN0IGluZGV4ID0gaXNCbG9jayA9PT0gdHJ1ZSA/IHJlcS5ibG9jay5pbmRleCA6IHJlcS5oYXNoLmluZGV4IC8gMgogICAgY29uc3QgYiA9IHRyYWNrZXIuZ2V0KGluZGV4KQoKICAgIGlmIChiID09PSBudWxsIHx8IHJlbW92ZUluZmxpZ2h0KGIuaW5mbGlnaHQsIHJlcSkgPT09IGZhbHNlKSByZXR1cm4KCiAgICBpZiAocmVtb3ZlSG90c3dhcChiKSA9PT0gdHJ1ZSAmJiBiLmluZmxpZ2h0Lmxlbmd0aCA+IDApIHsKICAgICAgdGhpcy5ob3Rzd2Fwcy5hZGQoYikKICAgIH0KCiAgICBpZiAoYi5yZWZzLmxlbmd0aCA+IDAgJiYgaXNCbG9jayA9PT0gdHJ1ZSkgewogICAgICB0aGlzLl9xdWV1ZUJsb2NrKGIpCiAgICAgIHJldHVybgogICAgfQoKICAgIGIuZ2MoKQogIH0KCiAgX2NsZWFySW5mbGlnaHRVcGdyYWRlKHJlcSkgewogICAgaWYgKHRoaXMuX3VwZ3JhZGUgPT09IG51bGwgfHwgcmVtb3ZlSW5mbGlnaHQodGhpcy5fdXBncmFkZS5pbmZsaWdodCwgcmVxKSA9PT0gZmFsc2UpIHJldHVybgogICAgdGhpcy5fdXBncmFkZS5nYygpCiAgfQoKICBfY2xlYXJJbmZsaWdodFNlZWtzKHJlcSkgewogICAgZm9yIChjb25zdCBzIG9mIHRoaXMuX3NlZWtzKSB7CiAgICAgIGlmIChyZW1vdmVJbmZsaWdodChzLmluZmxpZ2h0LCByZXEpID09PSBmYWxzZSkgY29udGludWUKICAgICAgcy5nYygpCiAgICB9CiAgfQoKICBfY2xlYXJJbmZsaWdodFJlb3JncyhyZXEpIHsKICAgIGZvciAoY29uc3QgciBvZiB0aGlzLl9yZW9yZ3MpIHsKICAgICAgcmVtb3ZlSW5mbGlnaHQoci5pbmZsaWdodCwgcmVxKQogICAgfQogIH0KCiAgX2NsZWFyT2xkUmVvcmdzKGZvcmspIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fcmVvcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGYgPSB0aGlzLl9yZW9yZ3NbaV0KICAgICAgaWYgKGYuZm9yayA+PSBmb3JrKSBjb250aW51ZQogICAgICBpZiAoaSA9PT0gdGhpcy5fcmVvcmdzLmxlbmd0aCAtIDEpIHRoaXMuX3Jlb3Jncy5wb3AoKQogICAgICBlbHNlIHRoaXMuX3Jlb3Jnc1tpXSA9IHRoaXMuX3Jlb3Jncy5wb3AoKQogICAgICBpLS0KICAgIH0KICB9CgogIC8vICJzbG93IiB1cGRhdGVzIGhlcmUgLSBhc3luYyBidXQgbm90IGFsbG93ZWQgdG8gZXZlciB0aHJvdwogIGFzeW5jIF91cGRhdGVOb25QcmltYXJ5KHVwZGF0ZUFsbCkgewogICAgLy8gQ2hlY2sgaWYgcnVubmluZywgaWYgc28gc2tpcCBpdCBhbmQgdGhlIHJ1bm5pbmcgb25lIHdpbGwgaXNzdWUgYW5vdGhlciB1cGRhdGUgZm9yIHVzIChkZWJvdW5jZSkKICAgIHdoaWxlICgrK3RoaXMuX3VwZGF0ZXNQZW5kaW5nID09PSAxKSB7CiAgICAgIGxldCBsZW4gPSBNYXRoLm1pbihNQVhfUkFOR0VTLCB0aGlzLl9yYW5nZXMubGVuZ3RoKQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgIGNvbnN0IHIgPSB0aGlzLl9yYW5nZXNbaV0KCiAgICAgICAgY2xhbXBSYW5nZSh0aGlzLmNvcmUsIHIpCgogICAgICAgIGlmIChyLmVuZCAhPT0gLTEgJiYgci5zdGFydCA+PSByLmVuZCkgewogICAgICAgICAgdGhpcy5fcmVzb2x2ZVJhbmdlUmVxdWVzdChyKQogICAgICAgICAgaS0tCiAgICAgICAgICBpZiAobGVuID4gdGhpcy5fcmFuZ2VzLmxlbmd0aCkgbGVuLS0KICAgICAgICAgIGlmICh0aGlzLl9yYW5nZXMubGVuZ3RoID09PSBNQVhfUkFOR0VTKSB1cGRhdGVBbGwgPSB0cnVlCiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3NlZWtzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZWtzW2ldCgogICAgICAgIGxldCBlcnIgPSBudWxsCiAgICAgICAgbGV0IHJlcyA9IG51bGwKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJlcyA9IGF3YWl0IHMuc2Vla2VyLnVwZGF0ZSgpCiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIGVyciA9IGVycm9yCiAgICAgICAgfQoKICAgICAgICBpZiAoIXJlcyAmJiAhZXJyKSBjb250aW51ZQoKICAgICAgICBpZiAoaSA8IHRoaXMuX3NlZWtzLmxlbmd0aCAtIDEpIHRoaXMuX3NlZWtzW2ldID0gdGhpcy5fc2Vla3MucG9wKCkKICAgICAgICBlbHNlIHRoaXMuX3NlZWtzLnBvcCgpCgogICAgICAgIGktLQoKICAgICAgICBpZiAoZXJyKSBzLnJlamVjdChlcnIpCiAgICAgICAgZWxzZSBzLnJlc29sdmUocmVzKQogICAgICB9CgogICAgICAvLyBObyBhZGRpdGlvbmFsIHVwZGF0ZXMgc2NoZWR1bGVkIC0gYnJlYWsKICAgICAgaWYgKC0tdGhpcy5fdXBkYXRlc1BlbmRpbmcgPT09IDApIGJyZWFrCiAgICAgIC8vIERlYm91bmNlIHRoZSBhZGRpdGlvbmFsIHVwZGF0ZXMgLSBjb250aW51ZQogICAgICB0aGlzLl91cGRhdGVzUGVuZGluZyA9IDAKICAgIH0KCiAgICBpZiAodGhpcy5faW5mbGlnaHQuaWRsZSB8fCB1cGRhdGVBbGwpIHRoaXMudXBkYXRlQWxsKCkKICB9CgogIF9tYXliZVJlc29sdmVJZkF2YWlsYWJsZVJhbmdlcygpIHsKICAgIGlmICh0aGlzLl9pZkF2YWlsYWJsZSA+IDAgfHwgIXRoaXMuX2luZmxpZ2h0LmlkbGUgfHwgIXRoaXMuX3Jhbmdlcy5sZW5ndGgpIHJldHVybgoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5wZWVycy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodGhpcy5wZWVyc1tpXS5kYXRhUHJvY2Vzc2luZyA+IDApIHJldHVybgogICAgfQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fcmFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHIgPSB0aGlzLl9yYW5nZXNbaV0KCiAgICAgIGlmIChyLmlmQXZhaWxhYmxlKSB7CiAgICAgICAgdGhpcy5fcmVzb2x2ZVJhbmdlUmVxdWVzdChyKQogICAgICAgIGktLQogICAgICB9CiAgICB9CiAgfQoKICBfY2xlYXJSZXF1ZXN0KHBlZXIsIHJlcSkgewogICAgaWYgKHJlcS5ibG9jayAhPT0gbnVsbCkgewogICAgICB0aGlzLl9jbGVhckluZmxpZ2h0QmxvY2sodGhpcy5fYmxvY2tzLCByZXEpCiAgICAgIHRoaXMuX3VubWFya0luZmxpZ2h0KHJlcS5ibG9jay5pbmRleCkKICAgIH0KCiAgICBpZiAocmVxLmhhc2ggIT09IG51bGwpIHsKICAgICAgdGhpcy5fY2xlYXJJbmZsaWdodEJsb2NrKHRoaXMuX2hhc2hlcywgcmVxKQogICAgfQoKICAgIGlmIChyZXEudXBncmFkZSAhPT0gbnVsbCAmJiB0aGlzLl91cGdyYWRlICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX2NsZWFySW5mbGlnaHRVcGdyYWRlKHJlcSkKICAgIH0KCiAgICBpZiAodGhpcy5fc2Vla3MubGVuZ3RoID4gMCkgewogICAgICB0aGlzLl9jbGVhckluZmxpZ2h0U2Vla3MocmVxKQogICAgfQoKICAgIGlmICh0aGlzLl9yZW9yZ3MubGVuZ3RoID4gMCkgewogICAgICB0aGlzLl9jbGVhckluZmxpZ2h0UmVvcmdzKHJlcSkKICAgIH0KICB9CgogIF9vbm5vZGF0YShwZWVyLCByZXEsIHJlYXNvbikgewogICAgaWYgKHJlYXNvbiA9PT0gSU5WQUxJRF9SRVFVRVNUKSB7CiAgICAgIHBlZXIuc3RhdHMuYmFja29mZnMrKwogICAgICB0aGlzLnN0YXRzLmJhY2tvZmZzKysKCiAgICAgIGlmIChwZWVyLnN0YXRzLmJhY2tvZmZzID49IE1BWF9CQUNLT0ZGUykgewogICAgICAgIHBlZXIucGF1c2VkID0gdHJ1ZQogICAgICB9CiAgICB9CgogICAgaWYgKHJlcSkgewogICAgICB0aGlzLl9jbGVhclJlcXVlc3QocGVlciwgcmVxKQogICAgfQoKICAgIHRoaXMudXBkYXRlQWxsKCkKICB9CgogIF9vcGVuU2tpcEJpdGZpZWxkKCkgewogICAgLy8gdGVjaG5pY2FsbHkgdGhlIHNraXAgYml0ZmllbGQgZ2V0cyBiaXRzIGNsZWFyZWQgaWYgLmNsZWFyKCkgaXMgY2FsbGVkCiAgICAvLyBhbHNvIHdoaWNoIG1pZ2h0IGJlIGluIGluZmxpZ2h0IGFsc28sIGJ1dCB0aGF0IGp1c3QgcmVzdWx0cyBpbiB0aGF0IHNlY3Rpb24gYmVpbmcgb3ZlcmNhbGxlZCBzaG9ydGx5CiAgICAvLyB3b3JzdCBjYXNlLCBzbyBvayBmb3Igbm93CgogICAgY29uc3QgYml0ZmllbGQgPSB0aGlzLmNvcmUub3BlblNraXBCaXRmaWVsZCgpCgogICAgZm9yIChjb25zdCByZXEgb2YgdGhpcy5faW5mbGlnaHQpIHsKICAgICAgaWYgKHJlcS5ibG9jaykgYml0ZmllbGQuc2V0KHJlcS5ibG9jay5pbmRleCwgdHJ1ZSkgLy8gc2tpcAogICAgfQogIH0KCiAgX21hcmtQcm9jZXNzaW5nKGluZGV4KSB7CiAgICBjb25zdCBiID0gdGhpcy5fYmxvY2tzLmdldChpbmRleCkKICAgIGlmIChiKSB7CiAgICAgIGIucHJvY2Vzc2luZyA9IHRydWUKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgaCA9IHRoaXMuX2hhc2hlcy5nZXQoaW5kZXgpCiAgICBpZiAoaCkgaC5wcm9jZXNzaW5nID0gdHJ1ZQogIH0KCiAgX21hcmtQcm9jZXNzZWQoaW5kZXgpIHsKICAgIGNvbnN0IGIgPSB0aGlzLl9ibG9ja3MuZ2V0KGluZGV4KQogICAgaWYgKGIpIHJldHVybiBiLnByb2Nlc3NlZCgpCgogICAgY29uc3QgaCA9IHRoaXMuX2hhc2hlcy5nZXQoaW5kZXgpCiAgICBpZiAoaCkgaC5wcm9jZXNzZWQoKQogIH0KCiAgX21hcmtJbmZsaWdodChpbmRleCkgewogICAgaWYgKHRoaXMuY29yZS5za2lwQml0ZmllbGQgIT09IG51bGwpIHRoaXMuY29yZS5za2lwQml0ZmllbGQuc2V0KGluZGV4LCB0cnVlKQogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHBlZXIuX21hcmtJbmZsaWdodChpbmRleCkKICB9CgogIF91bm1hcmtJbmZsaWdodChpbmRleCkgewogICAgaWYgKHRoaXMuY29yZS5za2lwQml0ZmllbGQgIT09IG51bGwpIHsKICAgICAgdGhpcy5jb3JlLnNraXBCaXRmaWVsZC5zZXQoaW5kZXgsIHRoaXMuY29yZS5iaXRmaWVsZC5nZXQoaW5kZXgpKQogICAgfQogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHBlZXIuX3Jlc2V0TWlzc2luZ0Jsb2NrKGluZGV4KQogIH0KCiAgZnVsbHlEb3dubG9hZGVkKCkgewogICAgaWYgKCF0aGlzLmNvcmUuc3RhdGUubGVuZ3RoKSByZXR1cm4gZmFsc2UKICAgIHJldHVybiB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoID09PSB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgKICB9CgogIF9vbmRhdGEocGVlciwgcmVxLCBkYXRhKSB7CiAgICBpZiAocmVxKSB7CiAgICAgIHJlcS5lbGFwc2VkID0gRGF0ZS5ub3coKSAtIHJlcS50aW1lc3RhbXAKICAgIH0KCiAgICBpZiAoZGF0YS5ibG9jayAhPT0gbnVsbCkgewogICAgICB0aGlzLl9yZXNvbHZlQmxvY2tSZXF1ZXN0KHRoaXMuX2Jsb2NrcywgZGF0YS5ibG9jay5pbmRleCwgZGF0YS5ibG9jay52YWx1ZSwgcmVxKQogICAgICB0aGlzLl9vbmRvd25sb2FkKGRhdGEuYmxvY2suaW5kZXgsIGRhdGEuYmxvY2sudmFsdWUuYnl0ZUxlbmd0aCwgcGVlciwgcmVxKQogICAgfQoKICAgIGlmIChkYXRhLmhhc2ggIT09IG51bGwgJiYgKGRhdGEuaGFzaC5pbmRleCAmIDEpID09PSAwKSB7CiAgICAgIHRoaXMuX3Jlc29sdmVCbG9ja1JlcXVlc3QodGhpcy5faGFzaGVzLCBkYXRhLmhhc2guaW5kZXggLyAyLCBudWxsLCByZXEpCiAgICB9CgogICAgaWYgKHRoaXMuX3VwZ3JhZGUgIT09IG51bGwpIHsKICAgICAgdGhpcy5fcmVzb2x2ZVVwZ3JhZGVSZXF1ZXN0KHJlcSkKICAgIH0KCiAgICBpZiAodGhpcy5fc2Vla3MubGVuZ3RoID4gMCkgewogICAgICB0aGlzLl9jbGVhckluZmxpZ2h0U2Vla3MocmVxKQogICAgfQoKICAgIGlmICh0aGlzLl9yZW9yZ3MubGVuZ3RoID4gMCkgewogICAgICB0aGlzLl9jbGVhckluZmxpZ2h0UmVvcmdzKHJlcSkKICAgIH0KCiAgICBpZiAodGhpcy5fbWFuaWZlc3RQZWVyID09PSBwZWVyICYmIHRoaXMuY29yZS5oZWFkZXIubWFuaWZlc3QgIT09IG51bGwpIHsKICAgICAgdGhpcy5fbWFuaWZlc3RQZWVyID0gbnVsbAogICAgfQoKICAgIGlmICh0aGlzLl9zZWVrcy5sZW5ndGggPiAwIHx8IHRoaXMuX3Jhbmdlcy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuX3VwZGF0ZU5vblByaW1hcnkodGhpcy5fc2Vla3MubGVuZ3RoID4gMCkKICAgIH0KCiAgICB0aGlzLnVwZGF0ZVBlZXIocGVlcikKICB9CgogIF9vbndhbnQocGVlciwgc3RhcnQsIGxlbmd0aCkgewogICAgaWYgKCFwZWVyLmlzQWN0aXZlKCkpIHJldHVybgoKICAgIGNvbnN0IGNvbnRpZyA9IE1hdGgubWluKHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgsIHRoaXMuY29yZS5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCkKCiAgICBpZiAoc3RhcnQgKyBsZW5ndGggPCBjb250aWcgfHwgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCA9PT0gY29udGlnKSB7CiAgICAgIHBlZXIud2lyZVJhbmdlLnNlbmQoewogICAgICAgIGRyb3A6IGZhbHNlLAogICAgICAgIHN0YXJ0OiAwLAogICAgICAgIGxlbmd0aDogY29udGlnCiAgICAgIH0pCiAgICAgIGluY3JlbWVudFR4KHBlZXIuc3RhdHMud2lyZVJhbmdlLCB0aGlzLnN0YXRzLndpcmVSYW5nZSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgbGVuZ3RoID0gTWF0aC5taW4obGVuZ3RoLCB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoIC0gc3RhcnQpCgogICAgcGVlci5wcm90b211eC5jb3JrKCkKCiAgICBmb3IgKGNvbnN0IG1zZyBvZiB0aGlzLmNvcmUuYml0ZmllbGQud2FudChzdGFydCwgbGVuZ3RoKSkgewogICAgICBwZWVyLndpcmVCaXRmaWVsZC5zZW5kKG1zZykKICAgICAgaW5jcmVtZW50VHgocGVlci5zdGF0cy53aXJlQml0ZmllbGQsIHRoaXMuc3RhdHMud2lyZUJpdGZpZWxkKQogICAgfQoKICAgIHBlZXIucHJvdG9tdXgudW5jb3JrKCkKICB9CgogIGFzeW5jIF9vbnJlb3JnZGF0YShwZWVyLCByZXEsIGRhdGEpIHsKICAgIGNvbnN0IG5ld0JhdGNoID0gZGF0YS51cGdyYWRlICYmIChhd2FpdCB0aGlzLmNvcmUudmVyaWZ5UmVvcmcoZGF0YSkpCiAgICBjb25zdCBmID0gdGhpcy5fYWRkUmVvcmcoZGF0YS5mb3JrLCBwZWVyKQoKICAgIGlmIChmID09PSBudWxsKSB7CiAgICAgIHRoaXMudXBkYXRlQWxsKCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgcmVtb3ZlSW5mbGlnaHQoZi5pbmZsaWdodCwgcmVxKQoKICAgIGlmIChmLmJhdGNoKSB7CiAgICAgIGF3YWl0IGYuYmF0Y2gudXBkYXRlKGRhdGEpCiAgICB9IGVsc2UgaWYgKGRhdGEudXBncmFkZSkgewogICAgICBmLmJhdGNoID0gbmV3QmF0Y2gKCiAgICAgIC8vIFJlbW92ZSAib2xkZXIiIHJlb3JncyBpbiBwcm9ncmVzcyBhcyB3ZSBqdXN0IHZlcmlmaWVkIHRoaXMgb25lLgogICAgICB0aGlzLl9jbGVhck9sZFJlb3JncyhmLmZvcmspCiAgICB9CgogICAgaWYgKGYuYmF0Y2ggJiYgZi5iYXRjaC5maW5pc2hlZCkgewogICAgICBpZiAodGhpcy5fYWRkVXBncmFkZU1heWJlKCkgIT09IG51bGwpIHsKICAgICAgICBhd2FpdCB0aGlzLl9hcHBseVJlb3JnKGYpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnVwZGF0ZUFsbCgpCiAgfQoKICAvLyBOZXZlciB0aHJvd3MsIGFsbG93ZWQgdG8gcnVuIGluIHRoZSBiYWNrZ3JvdW5kCiAgYXN5bmMgX2FwcGx5UmVvcmcoZikgewogICAgLy8gVE9ETzogbW9yZSBvcHRpbWFsIGhlcmUgdG8gY2hlY2sgaWYgcG90ZW50aWFsbHkgYSBiZXR0ZXIgcmVvcmcKICAgIC8vIGlzIGF2YWlsYWJsZSwgaWUgaGlnaGVyIGZvcmssIGFuZCByZXF1ZXN0IHRoYXQgb25lIGZpcnN0LgogICAgLy8gVGhpcyB3aWxsIHJlcXVlc3QgdGhhdCBvbmUgYWZ0ZXIgdGhpcyBmaW5pc2hlcywgd2hpY2ggaXMgZmluZSwgYnV0IHdlCiAgICAvLyBzaG91bGQgaW52ZXN0aWdhdGUgdGhlIGNvbXBsZXhpdHkgaW4gZ29pbmcgdGhlIG90aGVyIHdheQoKICAgIGNvbnN0IHUgPSB0aGlzLl91cGdyYWRlCgogICAgdGhpcy5fcmVvcmdzID0gW10gLy8gY2xlYXIgYWxsIGFzIHRoZSBub2RlcyBhcmUgYWdhaW5zdCB0aGUgb2xkIHRyZWUgLSBlYXNpZXIKICAgIHRoaXMuX2FwcGx5aW5nUmVvcmcgPSB0aGlzLmNvcmUucmVvcmcoZi5iYXRjaCwgbnVsbCkgLy8gVE9ETzogbnVsbCBzaG91bGQgYmUgdGhlIGZpcnN0L2xhc3QgcGVlcj8KCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9hcHBseWluZ1Jlb3JnCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5fdXBncmFkZSA9IG51bGwKICAgICAgdS5yZWplY3QoZXJyKQogICAgfQoKICAgIHRoaXMuX2FwcGx5aW5nUmVvcmcgPSBudWxsCgogICAgaWYgKHRoaXMuX3VwZ3JhZGUgIT09IG51bGwpIHsKICAgICAgdGhpcy5fcmVzb2x2ZVVwZ3JhZGVSZXF1ZXN0KG51bGwpCiAgICB9CgogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHRoaXMuX3VwZGF0ZUZvcmsocGVlcikKCiAgICAvLyBUT0RPOiBhbGwgdGhlIHJlbWFpbmluZyBpcyBhIHRtcCB3b3JrYXJvdW5kIHVudGlsIHdlIGhhdmUgYSBmbGFnL3dheSBmb3IgQU5ZX0ZPUksKICAgIGZvciAoY29uc3QgciBvZiB0aGlzLl9yYW5nZXMpIHsKICAgICAgci5zdGFydCA9IHIudXNlclN0YXJ0CiAgICAgIHIuZW5kID0gci51c2VyRW5kCiAgICB9CgogICAgdGhpcy51cGRhdGVBbGwoKQogIH0KCiAgX21heWJlVXBkYXRlKCkgewogICAgcmV0dXJuIHRoaXMuX3VwZ3JhZGUgIT09IG51bGwgJiYgdGhpcy5fdXBncmFkZS5pbmZsaWdodC5sZW5ndGggPT09IDAKICB9CgogIF9tYXliZVJlcXVlc3RNYW5pZmVzdCgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUuaGVhZGVyLm1hbmlmZXN0ID09PSBudWxsICYmIHRoaXMuX21hbmlmZXN0UGVlciA9PT0gbnVsbAogIH0KCiAgX3VwZGF0ZUZvcmsocGVlcikgewogICAgaWYgKAogICAgICB0aGlzLl9hcHBseWluZ1Jlb3JnICE9PSBudWxsIHx8CiAgICAgIHRoaXMuYWxsb3dGb3JrID09PSBmYWxzZSB8fAogICAgICBwZWVyLnJlbW90ZUZvcmsgPD0gdGhpcy5jb3JlLnN0YXRlLmZvcmsKICAgICkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBjb25zdCBmID0gdGhpcy5fYWRkUmVvcmcocGVlci5yZW1vdGVGb3JrLCBwZWVyKQoKICAgIC8vIFRPRE86IG9uZSBwZXIgcGVlciBpcyBiZXR0ZXIKICAgIGlmIChmICE9PSBudWxsICYmIGYuYmF0Y2ggPT09IG51bGwgJiYgZi5pbmZsaWdodC5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHBlZXIuX3JlcXVlc3RGb3JrUHJvb2YoZikKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF91cGRhdGVIb3Rzd2FwKHBlZXIpIHsKICAgIGNvbnN0IG1heEhvdHN3YXBzID0gcGVlci5nZXRNYXhIb3Rzd2FwSW5mbGlnaHQoKQogICAgaWYgKCFwZWVyLmlzQWN0aXZlKCkgfHwgcGVlci5pbmZsaWdodCA+PSBtYXhIb3Rzd2FwcykgcmV0dXJuCgogICAgZm9yIChjb25zdCBiIG9mIHRoaXMuaG90c3dhcHMucGljayhwZWVyKSkgewogICAgICBpZiAocGVlci5fcmVxdWVzdEJsb2NrKGIpID09PSBmYWxzZSkgY29udGludWUKICAgICAgcGVlci5zdGF0cy5ob3Rzd2FwcysrCiAgICAgIHBlZXIucmVwbGljYXRvci5zdGF0cy5ob3Rzd2FwcysrCiAgICAgIGlmIChwZWVyLmluZmxpZ2h0ID49IG1heEhvdHN3YXBzKSBicmVhawogICAgfQogIH0KCiAgX3VwZGF0ZVBlZXIocGVlcikgewogICAgaWYgKCFwZWVyLmlzQWN0aXZlKCkgfHwgcGVlci5pbmZsaWdodCA+PSBwZWVyLmdldE1heEluZmxpZ2h0KCkgfHwgIXBlZXIucmVtb3RlVXBsb2FkaW5nKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIC8vIEVhZ2VybHkgcmVxdWVzdCB0aGUgbWFuaWZlc3QgZXZlbiBpZiB0aGUgcmVtb3RlIGxlbmd0aCBpcyAwLiBJZiBub3QgMCB3ZSdsbCBnZXQgYXMgcGFydCBvZiB0aGUgdXBncmFkZSByZXF1ZXN0Li4uCiAgICBpZiAoCiAgICAgIHRoaXMuX21heWJlUmVxdWVzdE1hbmlmZXN0KCkgPT09IHRydWUgJiYKICAgICAgcGVlci5yZW1vdGVMZW5ndGggPT09IDAgJiYKICAgICAgcGVlci5yZW1vdGVIYXNNYW5pZmVzdCA9PT0gdHJ1ZQogICAgKSB7CiAgICAgIHRoaXMuX21hbmlmZXN0UGVlciA9IHBlZXIKICAgICAgcGVlci5fcmVxdWVzdE1hbmlmZXN0KCkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5fc2Vla3MpIHsKICAgICAgaWYgKHMuaW5mbGlnaHQubGVuZ3RoID4gMCkgY29udGludWUgLy8gVE9ETzogb25lIHBlciBwZWVyIGlzIGJldHRlcgogICAgICBpZiAocGVlci5fcmVxdWVzdFNlZWsocykgPT09IHRydWUpIHsKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CgogICAgLy8gSW1wbGllZCB0aGF0IGFueSBibG9jayBpbiB0aGUgcXVldWUgc2hvdWxkIGJlIHJlcXVlc3RlZCwgbm8gbWF0dGVyIGhvdyBtYW55IGluZmxpZ2h0cwogICAgY29uc3QgYmxrcyA9IG5ldyBSYW5kb21JdGVyYXRvcih0aGlzLl9xdWV1ZWQpCgogICAgZm9yIChjb25zdCBiIG9mIGJsa3MpIHsKICAgICAgaWYgKGIucXVldWVkID09PSBmYWxzZSB8fCBwZWVyLl9yZXF1ZXN0QmxvY2soYikgPT09IHRydWUpIHsKICAgICAgICBiLnF1ZXVlZCA9IGZhbHNlCiAgICAgICAgYmxrcy5kZXF1ZXVlKCkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBfdXBkYXRlUGVlck5vblByaW1hcnkocGVlcikgewogICAgaWYgKCFwZWVyLmlzQWN0aXZlKCkgfHwgcGVlci5pbmZsaWdodCA+PSBwZWVyLmdldE1heEluZmxpZ2h0KCkgfHwgIXBlZXIucmVtb3RlVXBsb2FkaW5nKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnN0IHJhbmdlcyA9IG5ldyBSYW5kb21JdGVyYXRvcih0aGlzLl9yYW5nZXMpCiAgICBsZXQgdHJpZWQgPSAwCgogICAgZm9yIChjb25zdCByIG9mIHJhbmdlcykgewogICAgICBpZiAocGVlci5fcmVxdWVzdFJhbmdlKHIpID09PSB0cnVlKSB7CiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgICBpZiAoKyt0cmllZCA+PSBNQVhfUkFOR0VTKSBicmVhawogICAgfQoKICAgIC8vIEl0ZXJhdGUgZnJvbSBuZXdlc3QgZm9yayB0byBvbGRlc3QgZm9yay4uLgogICAgZm9yIChsZXQgaSA9IHRoaXMuX3Jlb3Jncy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBmID0gdGhpcy5fcmVvcmdzW2ldCiAgICAgIGlmIChmLmJhdGNoICE9PSBudWxsICYmIGYuaW5mbGlnaHQubGVuZ3RoID09PSAwICYmIHBlZXIuX3JlcXVlc3RGb3JrUmFuZ2UoZikgPT09IHRydWUpIHsKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMuX21heWJlVXBkYXRlKCkgPT09IHRydWUgJiYgcGVlci5fcmVxdWVzdFVwZ3JhZGUodGhpcy5fdXBncmFkZSkgPT09IHRydWUpIHsKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIHVwZGF0ZVBlZXIocGVlcikgewogICAgLy8gUXVpY2sgc2hvcnRjdXQgdG8gd2FpdCBmb3IgZmx1c2hpbmcgcmVvcmdzIC0gbm90IG5lZWRlZCBidXQgbGVzcyB3YWlzdGVkIHJlcXVlc3RzCiAgICBpZiAodGhpcy5fYXBwbHlpbmdSZW9yZyAhPT0gbnVsbCkgcmV0dXJuCgogICAgd2hpbGUgKHRoaXMuX3VwZGF0ZVBlZXIocGVlcikgPT09IHRydWUpOwogICAgd2hpbGUgKHRoaXMuX3VwZGF0ZVBlZXJOb25QcmltYXJ5KHBlZXIpID09PSB0cnVlKTsKCiAgICBpZiAodGhpcy5wZWVycy5sZW5ndGggPiAxICYmIHRoaXMuX2Jsb2Nrcy5pc0VtcHR5KCkgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMuX3VwZGF0ZUhvdHN3YXAocGVlcikKICAgIH0KCiAgICB0aGlzLl9jaGVja1VwZ3JhZGVJZkF2YWlsYWJsZSgpCiAgICB0aGlzLl9tYXliZVJlc29sdmVJZkF2YWlsYWJsZVJhbmdlcygpCiAgfQoKICB1cGRhdGVBbGwoKSB7CiAgICAvLyBRdWljayBzaG9ydGN1dCB0byB3YWl0IGZvciBmbHVzaGluZyByZW9yZ3MgLSBub3QgbmVlZGVkIGJ1dCBsZXNzIHdhaXN0ZWQgcmVxdWVzdHMKICAgIGlmICh0aGlzLl9hcHBseWluZ1Jlb3JnICE9PSBudWxsKSByZXR1cm4KCiAgICBjb25zdCBwZWVycyA9IG5ldyBSYW5kb21JdGVyYXRvcih0aGlzLnBlZXJzKQoKICAgIGZvciAoY29uc3QgcGVlciBvZiBwZWVycykgewogICAgICBpZiAodGhpcy5fdXBkYXRlUGVlcihwZWVyKSA9PT0gdHJ1ZSkgewogICAgICAgIHBlZXJzLnJlcXVldWUoKQogICAgICB9CiAgICB9CgogICAgLy8gQ2hlY2sgaWYgd2UgY2FuIHNraXAgdGhlIG5vbiBwcmltYXJ5IGNoZWNrIGZ1bGx5CiAgICBpZiAodGhpcy5fbWF5YmVVcGRhdGUoKSA9PT0gZmFsc2UgJiYgdGhpcy5fcmFuZ2VzLmxlbmd0aCA9PT0gMCAmJiB0aGlzLl9yZW9yZ3MubGVuZ3RoID09PSAwKSB7CiAgICAgIHRoaXMuX2NoZWNrVXBncmFkZUlmQXZhaWxhYmxlKCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgZm9yIChjb25zdCBwZWVyIG9mIHBlZXJzLnJlc3RhcnQoKSkgewogICAgICBpZiAodGhpcy5fdXBkYXRlUGVlck5vblByaW1hcnkocGVlcikgPT09IHRydWUpIHsKICAgICAgICBwZWVycy5yZXF1ZXVlKCkKICAgICAgfQogICAgfQoKICAgIHRoaXMuX2NoZWNrVXBncmFkZUlmQXZhaWxhYmxlKCkKICAgIHRoaXMuX21heWJlUmVzb2x2ZUlmQXZhaWxhYmxlUmFuZ2VzKCkKICB9CgogIG9ucGVlcmRlc3Ryb3koKSB7CiAgICBpZiAoLS10aGlzLl9hY3RpdmUgPT09IDApIHRoaXMuY29yZS5jaGVja0lmSWRsZSgpCiAgfQoKICBhdHRhY2hlZChwcm90b211eCkgewogICAgcmV0dXJuIHRoaXMuX2F0dGFjaGVkLmhhcyhwcm90b211eCkKICB9CgogIGF0dGFjaFRvKHByb3RvbXV4KSB7CiAgICBpZiAodGhpcy5jb3JlLmNsb3NlZCkgcmV0dXJuCgogICAgY29uc3QgbWFrZVBlZXIgPSB0aGlzLl9tYWtlUGVlci5iaW5kKHRoaXMsIHByb3RvbXV4KQoKICAgIHRoaXMuX2F0dGFjaGVkLmFkZChwcm90b211eCkKICAgIHByb3RvbXV4LnBhaXIoeyBwcm90b2NvbDogJ2h5cGVyY29yZS9hbHBoYScsIGlkOiB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5IH0sIG1ha2VQZWVyKQogICAgcHJvdG9tdXguc3RyZWFtLnNldE1heExpc3RlbmVycygwKQogICAgcHJvdG9tdXguc3RyZWFtLm9uKCdjbG9zZScsIHRoaXMuX29uc3RyZWFtY2xvc2UpCgogICAgdGhpcy5faWZBdmFpbGFibGUrKwogICAgdGhpcy5fYWN0aXZlKysKCiAgICBwcm90b211eC5zdHJlYW0ub3BlbmVkLnRoZW4oKG9wZW5lZCkgPT4gewogICAgICB0aGlzLl9pZkF2YWlsYWJsZS0tCiAgICAgIHRoaXMuX2FjdGl2ZS0tCgogICAgICBpZiAob3BlbmVkICYmICF0aGlzLmRlc3Ryb3llZCkgbWFrZVBlZXIoKQogICAgICB0aGlzLl9jaGVja1VwZ3JhZGVJZkF2YWlsYWJsZSgpCgogICAgICB0aGlzLmNvcmUuY2hlY2tJZklkbGUoKQogICAgfSkKICB9CgogIGRldGFjaEZyb20ocHJvdG9tdXgpIHsKICAgIGlmICh0aGlzLl9hdHRhY2hlZC5kZWxldGUocHJvdG9tdXgpKSB7CiAgICAgIHByb3RvbXV4LnN0cmVhbS5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCB0aGlzLl9vbnN0cmVhbWNsb3NlKQogICAgICBwcm90b211eC51bnBhaXIoeyBwcm90b2NvbDogJ2h5cGVyY29yZS9hbHBoYScsIGlkOiB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5IH0pCiAgICB9CiAgfQoKICBpZGxlKCkgewogICAgcmV0dXJuIHRoaXMucGVlcnMubGVuZ3RoID09PSAwICYmIHRoaXMuX2FjdGl2ZSA9PT0gMAogIH0KCiAgY2xvc2UoKSB7CiAgICBjb25zdCB3YWl0aW5nID0gW10KCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgewogICAgICB3YWl0aW5nLnB1c2gocGVlci5jaGFubmVsLmZ1bGx5Q2xvc2VkKCkpCiAgICB9CgogICAgdGhpcy5kZXN0cm95KCkKICAgIHJldHVybiBQcm9taXNlLmFsbCh3YWl0aW5nKQogIH0KCiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKCiAgICBpZiAodGhpcy5fZG93bmxvYWRpbmdUaW1lcikgewogICAgICBjbGVhclRpbWVvdXQodGhpcy5fZG93bmxvYWRpbmdUaW1lcikKICAgICAgdGhpcy5fZG93bmxvYWRpbmdUaW1lciA9IG51bGwKICAgIH0KCiAgICB3aGlsZSAodGhpcy5wZWVycy5sZW5ndGgpIHsKICAgICAgY29uc3QgcGVlciA9IHRoaXMucGVlcnNbdGhpcy5wZWVycy5sZW5ndGggLSAxXQogICAgICB0aGlzLmRldGFjaEZyb20ocGVlci5wcm90b211eCkKICAgICAgcGVlci5jaGFubmVsLmNsb3NlKCkgLy8gcGVlciBpcyByZW1vdmVkIGZyb20gYXJyYXkgaW4gb25jbG9zZQogICAgfQoKICAgIGZvciAoY29uc3QgcHJvdG9tdXggb2YgdGhpcy5fYXR0YWNoZWQpIHsKICAgICAgdGhpcy5kZXRhY2hGcm9tKHByb3RvbXV4KQogICAgfQogIH0KCiAgX21ha2VQZWVyKHByb3RvbXV4KSB7CiAgICBjb25zdCByZXBsaWNhdG9yID0gdGhpcwogICAgaWYgKHByb3RvbXV4Lm9wZW5lZCh7IHByb3RvY29sOiAnaHlwZXJjb3JlL2FscGhhJywgaWQ6IHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkgfSkpIHsKICAgICAgcmV0dXJuIG9ubm9jaGFubmVsKCkKICAgIH0KCiAgICBjb25zdCBjaGFubmVsID0gcHJvdG9tdXguY3JlYXRlQ2hhbm5lbCh7CiAgICAgIHVzZXJEYXRhOiBudWxsLAogICAgICBwcm90b2NvbDogJ2h5cGVyY29yZS9hbHBoYScsCiAgICAgIGFsaWFzZXM6IFsnaHlwZXJjb3JlJ10sCiAgICAgIGlkOiB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5LAogICAgICBoYW5kc2hha2U6IG0ud2lyZS5oYW5kc2hha2UsCiAgICAgIG1lc3NhZ2VzOiBbCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLnN5bmMsIG9ubWVzc2FnZTogb253aXJlc3luYyB9LAogICAgICAgIHsgZW5jb2Rpbmc6IG0ud2lyZS5yZXF1ZXN0LCBvbm1lc3NhZ2U6IG9ud2lyZXJlcXVlc3QgfSwKICAgICAgICB7IGVuY29kaW5nOiBtLndpcmUuY2FuY2VsLCBvbm1lc3NhZ2U6IG9ud2lyZWNhbmNlbCB9LAogICAgICAgIHsgZW5jb2Rpbmc6IG0ud2lyZS5kYXRhLCBvbm1lc3NhZ2U6IG9ud2lyZWRhdGEgfSwKICAgICAgICB7IGVuY29kaW5nOiBtLndpcmUubm9EYXRhLCBvbm1lc3NhZ2U6IG9ud2lyZW5vZGF0YSB9LAogICAgICAgIHsgZW5jb2Rpbmc6IG0ud2lyZS53YW50LCBvbm1lc3NhZ2U6IG9ud2lyZXdhbnQgfSwKICAgICAgICB7IGVuY29kaW5nOiBtLndpcmUudW53YW50LCBvbm1lc3NhZ2U6IG9ud2lyZXVud2FudCB9LAogICAgICAgIHsgZW5jb2Rpbmc6IG0ud2lyZS5iaXRmaWVsZCwgb25tZXNzYWdlOiBvbndpcmViaXRmaWVsZCB9LAogICAgICAgIHsgZW5jb2Rpbmc6IG0ud2lyZS5yYW5nZSwgb25tZXNzYWdlOiBvbndpcmVyYW5nZSB9LAogICAgICAgIHsgZW5jb2Rpbmc6IG0ud2lyZS5leHRlbnNpb24sIG9ubWVzc2FnZTogb253aXJlZXh0ZW5zaW9uIH0KICAgICAgXSwKICAgICAgb25vcGVuOiBvbndpcmVvcGVuLAogICAgICBvbmNsb3NlOiBvbndpcmVjbG9zZSwKICAgICAgb25kcmFpbjogb253aXJlZHJhaW4sCiAgICAgIG9uZGVzdHJveTogb253aXJlZGVzdHJveQogICAgfSkKCiAgICBpZiAoY2hhbm5lbCA9PT0gbnVsbCkgcmV0dXJuIG9ubm9jaGFubmVsKCkKCiAgICBjb25zdCBwZWVyID0gbmV3IFBlZXIocmVwbGljYXRvciwgcHJvdG9tdXgsIGNoYW5uZWwsIHRoaXMuaW5mbGlnaHRSYW5nZSkKICAgIGNvbnN0IHN0cmVhbSA9IHByb3RvbXV4LnN0cmVhbQoKICAgIHBlZXIuY2hhbm5lbC5vcGVuKHsKICAgICAgc2Vla3M6IHRydWUsCiAgICAgIGNhcGFiaWxpdHk6IGNhcHMucmVwbGljYXRlKHN0cmVhbS5pc0luaXRpYXRvciwgdGhpcy5jb3JlLmtleSwgc3RyZWFtLmhhbmRzaGFrZUhhc2gpCiAgICB9KQoKICAgIHJldHVybiB0cnVlCgogICAgZnVuY3Rpb24gb25ub2NoYW5uZWwoKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0KCiAgX29ucGVlcnVwZGF0ZShhZGRlZCwgcGVlcikgewogICAgY29uc3QgbmFtZSA9IGFkZGVkID8gJ3BlZXItYWRkJyA6ICdwZWVyLXJlbW92ZScKICAgIGNvbnN0IHNlc3Npb25zID0gdGhpcy5jb3JlLm1vbml0b3JzCgogICAgZm9yIChsZXQgaSA9IHNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIHNlc3Npb25zW2ldLmVtaXQobmFtZSwgcGVlcikKCiAgICAgIGlmIChhZGRlZCkgewogICAgICAgIGZvciAoY29uc3QgZXh0IG9mIHNlc3Npb25zW2ldLmV4dGVuc2lvbnMudmFsdWVzKCkpIHsKICAgICAgICAgIHBlZXIuZXh0ZW5zaW9ucy5zZXQoZXh0Lm5hbWUsIGV4dCkKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIF9vbmRvd25sb2FkKGluZGV4LCBieXRlTGVuZ3RoLCBmcm9tLCByZXEpIHsKICAgIGNvbnN0IHNlc3Npb25zID0gdGhpcy5jb3JlLm1vbml0b3JzCgogICAgZm9yIChsZXQgaSA9IHNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHMgPSBzZXNzaW9uc1tpXQogICAgICBzLmVtaXQoJ2Rvd25sb2FkJywgaW5kZXgsIGJ5dGVMZW5ndGggLSBzLnBhZGRpbmcsIGZyb20sIHJlcSkKICAgIH0KICB9CgogIF9vbnVwbG9hZChpbmRleCwgYnl0ZUxlbmd0aCwgZnJvbSkgewogICAgY29uc3Qgc2Vzc2lvbnMgPSB0aGlzLmNvcmUubW9uaXRvcnMKCiAgICBmb3IgKGxldCBpID0gc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgcyA9IHNlc3Npb25zW2ldCiAgICAgIHMuZW1pdCgndXBsb2FkJywgaW5kZXgsIGJ5dGVMZW5ndGggLSBzLnBhZGRpbmcsIGZyb20pCiAgICB9CiAgfQoKICBfb25pbnZhbGlkZGF0YShlcnIsIHJlcSwgcmVzLCBmcm9tKSB7CiAgICBjb25zdCBzZXNzaW9ucyA9IHRoaXMuY29yZS5tb25pdG9ycwoKICAgIHRoaXMuc3RhdHMuaW52YWxpZERhdGErKwogICAgZnJvbS5zdGF0cy5pbnZhbGlkRGF0YSsrCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlc3Npb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgIHNlc3Npb25zW2ldLmVtaXQoJ3ZlcmlmaWNhdGlvbi1lcnJvcicsIGVyciwgcmVxLCByZXMsIGZyb20pCiAgICB9CiAgfQoKICBfb25pbnZhbGlkcmVxdWVzdChlcnIsIHJlcSwgZnJvbSkgewogICAgY29uc3Qgc2Vzc2lvbnMgPSB0aGlzLmNvcmUubW9uaXRvcnMKCiAgICBmcm9tLnN0YXRzLmludmFsaWRSZXF1ZXN0cysrCiAgICB0aGlzLnN0YXRzLmludmFsaWRSZXF1ZXN0cysrCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlc3Npb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgIHNlc3Npb25zW2ldLmVtaXQoJ2ludmFsaWQtcmVxdWVzdCcsIGVyciwgcmVxLCBmcm9tKQogICAgfQogIH0KfQoKZnVuY3Rpb24gcmVtb3ZlSG90c3dhcChibG9jaykgewogIGlmIChibG9jay5ob3Rzd2FwID09PSBudWxsKSByZXR1cm4gZmFsc2UKICBibG9jay5ob3Rzd2FwLnJlZi5yZW1vdmUoYmxvY2spCiAgcmV0dXJuIHRydWUKfQoKZnVuY3Rpb24gcmVtb3ZlSW5mbGlnaHQoaW5mLCByZXEpIHsKICBjb25zdCBpID0gaW5mLmluZGV4T2YocmVxKQogIGlmIChpID09PSAtMSkgcmV0dXJuIGZhbHNlCiAgaWYgKGkgPCBpbmYubGVuZ3RoIC0gMSkgaW5mW2ldID0gaW5mLnBvcCgpCiAgZWxzZSBpbmYucG9wKCkKICByZXR1cm4gdHJ1ZQp9CgpmdW5jdGlvbiB0b0xlbmd0aChzdGFydCwgZW5kKSB7CiAgcmV0dXJuIGVuZCA9PT0gLTEgPyAtMSA6IGVuZCA8IHN0YXJ0ID8gMCA6IGVuZCAtIHN0YXJ0Cn0KCmZ1bmN0aW9uIGNsYW1wUmFuZ2UoY29yZSwgcikgewogIGlmIChyLmJsb2NrcyA9PT0gbnVsbCkgewogICAgY29uc3Qgc3RhcnQgPSBjb3JlLmJpdGZpZWxkLmZpcnN0VW5zZXQoci5zdGFydCkKCiAgICBpZiAoci5lbmQgPT09IC0xKSByLnN0YXJ0ID0gc3RhcnQgPT09IC0xID8gY29yZS5zdGF0ZS5sZW5ndGggOiBzdGFydAogICAgZWxzZSBpZiAoc3RhcnQgPT09IC0xIHx8IHN0YXJ0ID49IHIuZW5kKSByLnN0YXJ0ID0gci5lbmQKICAgIGVsc2UgewogICAgICByLnN0YXJ0ID0gc3RhcnQKCiAgICAgIGNvbnN0IGVuZCA9IGNvcmUuYml0ZmllbGQubGFzdFVuc2V0KHIuZW5kIC0gMSkKCiAgICAgIGlmIChlbmQgPT09IC0xIHx8IHN0YXJ0ID49IGVuZCArIDEpIHIuZW5kID0gci5zdGFydAogICAgICBlbHNlIHIuZW5kID0gZW5kICsgMQogICAgfQogIH0gZWxzZSB7CiAgICB3aGlsZSAoci5zdGFydCA8IHIuZW5kICYmIGNvcmUuYml0ZmllbGQuZ2V0KHIuYmxvY2tzW3Iuc3RhcnRdKSkgci5zdGFydCsrCiAgICB3aGlsZSAoci5zdGFydCA8IHIuZW5kICYmIGNvcmUuYml0ZmllbGQuZ2V0KHIuYmxvY2tzW3IuZW5kIC0gMV0pKSByLmVuZC0tCiAgfQp9CgpmdW5jdGlvbiBvbnJlcXVlc3R0aW1lb3V0KHJlcSkgewogIGlmIChyZXEuY29udGV4dCkgcmVxLmNvbnRleHQuZGV0YWNoKHJlcSwgUkVRVUVTVF9USU1FT1VUKCkpCn0KCmZ1bmN0aW9uIGRlc3Ryb3lSZXF1ZXN0VGltZW91dChyZXEpIHsKICBpZiAocmVxLnRpbWVvdXQgIT09IG51bGwpIHsKICAgIGNsZWFyVGltZW91dChyZXEudGltZW91dCkKICAgIHJlcS50aW1lb3V0ID0gbnVsbAogIH0KfQoKZnVuY3Rpb24gaXNDcml0aWNhbEVycm9yKGVycikgewogIC8vIFRPRE86IGV4cG9zZSAuY3JpdGljYWwgb3Igc2ltaWxhciBvbiB0aGUgaHlwZXJjb3JlIGVycm9ycyB0aGF0IGFyZSBjcml0aWNhbCAoaWYgYWxsIG5vdCBhcmUpCiAgcmV0dXJuIGVyci5uYW1lID09PSAnSHlwZXJjb3JlRXJyb3InCn0KCmZ1bmN0aW9uIG9ud2lyZW9wZW4obSwgYykgewogIHJldHVybiBjLnVzZXJEYXRhLm9ub3BlbihtKQp9CgpmdW5jdGlvbiBvbndpcmVjbG9zZShpc1JlbW90ZSwgYykgewogIHJldHVybiBjLnVzZXJEYXRhLm9uY2xvc2UoaXNSZW1vdGUpCn0KCmZ1bmN0aW9uIG9ud2lyZWRlc3Ryb3koYykgewogIGMudXNlckRhdGEucmVwbGljYXRvci5vbnBlZXJkZXN0cm95KCkKfQoKZnVuY3Rpb24gb253aXJlZHJhaW4oYykgewogIHJldHVybiBjLnVzZXJEYXRhLm9uZHJhaW4oKQp9CgpmdW5jdGlvbiBvbndpcmVzeW5jKG0sIGMpIHsKICBpbmNyZW1lbnRSeChjLnVzZXJEYXRhLnN0YXRzLndpcmVTeW5jLCBjLnVzZXJEYXRhLnJlcGxpY2F0b3Iuc3RhdHMud2lyZVN5bmMpCiAgcmV0dXJuIGMudXNlckRhdGEub25zeW5jKG0pCn0KCmZ1bmN0aW9uIG9ud2lyZXJlcXVlc3QobSwgYykgewogIGluY3JlbWVudFJ4KGMudXNlckRhdGEuc3RhdHMud2lyZVJlcXVlc3QsIGMudXNlckRhdGEucmVwbGljYXRvci5zdGF0cy53aXJlUmVxdWVzdCkKICByZXR1cm4gYy51c2VyRGF0YS5vbnJlcXVlc3QobSkKfQoKZnVuY3Rpb24gb253aXJlY2FuY2VsKG0sIGMpIHsKICBpbmNyZW1lbnRSeChjLnVzZXJEYXRhLnN0YXRzLndpcmVDYW5jZWwsIGMudXNlckRhdGEucmVwbGljYXRvci5zdGF0cy53aXJlQ2FuY2VsKQogIHJldHVybiBjLnVzZXJEYXRhLm9uY2FuY2VsKG0pCn0KCmZ1bmN0aW9uIG9ud2lyZWRhdGEobSwgYykgewogIGluY3JlbWVudFJ4KGMudXNlckRhdGEuc3RhdHMud2lyZURhdGEsIGMudXNlckRhdGEucmVwbGljYXRvci5zdGF0cy53aXJlRGF0YSkKICByZXR1cm4gYy51c2VyRGF0YS5vbmRhdGEobSkKfQoKZnVuY3Rpb24gb253aXJlbm9kYXRhKG0sIGMpIHsKICByZXR1cm4gYy51c2VyRGF0YS5vbm5vZGF0YShtKQp9CgpmdW5jdGlvbiBvbndpcmV3YW50KG0sIGMpIHsKICBpbmNyZW1lbnRSeChjLnVzZXJEYXRhLnN0YXRzLndpcmVXYW50LCBjLnVzZXJEYXRhLnJlcGxpY2F0b3Iuc3RhdHMud2lyZVdhbnQpCiAgcmV0dXJuIGMudXNlckRhdGEub253YW50KG0pCn0KCmZ1bmN0aW9uIG9ud2lyZXVud2FudChtLCBjKSB7CiAgcmV0dXJuIGMudXNlckRhdGEub251bndhbnQobSkKfQoKZnVuY3Rpb24gb253aXJlYml0ZmllbGQobSwgYykgewogIGluY3JlbWVudFJ4KGMudXNlckRhdGEuc3RhdHMud2lyZUJpdGZpZWxkLCBjLnVzZXJEYXRhLnJlcGxpY2F0b3Iuc3RhdHMud2lyZUJpdGZpZWxkKQogIHJldHVybiBjLnVzZXJEYXRhLm9uYml0ZmllbGQobSkKfQoKZnVuY3Rpb24gb253aXJlcmFuZ2UobSwgYykgewogIGluY3JlbWVudFJ4KGMudXNlckRhdGEuc3RhdHMud2lyZVJhbmdlLCBjLnVzZXJEYXRhLnJlcGxpY2F0b3Iuc3RhdHMud2lyZVJhbmdlKQogIHJldHVybiBjLnVzZXJEYXRhLm9ucmFuZ2UobSkKfQoKZnVuY3Rpb24gb253aXJlZXh0ZW5zaW9uKG0sIGMpIHsKICBpbmNyZW1lbnRSeChjLnVzZXJEYXRhLnN0YXRzLndpcmVFeHRlbnNpb24sIGMudXNlckRhdGEucmVwbGljYXRvci5zdGF0cy53aXJlRXh0ZW5zaW9uKQogIHJldHVybiBjLnVzZXJEYXRhLm9uZXh0ZW5zaW9uKG0pCn0KCmZ1bmN0aW9uIHNldERvd25sb2FkaW5nTGF0ZXIocmVwbCwgZG93bmxvYWRpbmcsIHNlc3Npb24pIHsKICByZXBsLnNldERvd25sb2FkaW5nTm93KGRvd25sb2FkaW5nLCBzZXNzaW9uKQp9CgpmdW5jdGlvbiBpc0Jsb2NrUmVxdWVzdChyZXEpIHsKICByZXR1cm4gcmVxICE9PSBudWxsICYmIHJlcS5ibG9jayAhPT0gbnVsbAp9CgpmdW5jdGlvbiBpc1VwZ3JhZGVSZXF1ZXN0KHJlcSkgewogIHJldHVybiByZXEgIT09IG51bGwgJiYgcmVxLnVwZ3JhZGUgIT09IG51bGwKfQoKZnVuY3Rpb24gaW5jcmVtZW50VHgoc3RhdHMxLCBzdGF0czIpIHsKICBzdGF0czEudHgrKwogIHN0YXRzMi50eCsrCn0KCmZ1bmN0aW9uIGluY3JlbWVudFJ4KHN0YXRzMSwgc3RhdHMyKSB7CiAgc3RhdHMxLnJ4KysKICBzdGF0czIucngrKwp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIGJhY2tvZmYodGltZXMpIHsKICBjb25zdCBzbGVlcCA9IHRpbWVzIDwgMiA/IDIwMCA6IHRpbWVzIDwgNSA/IDUwMCA6IHRpbWVzIDwgNDAgPyAxMDAwIDogNTAwMAogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCBzbGVlcCkpCn0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ25hbm9hc3NlcnQnKQpjb25zdCBmbGF0ID0gcmVxdWlyZSgnZmxhdC10cmVlJykKY29uc3QgcXVpY2tiaXQgPSByZXF1aXJlKCdxdWlja2JpdC11bml2ZXJzYWwnKQoKY29uc3QgeyBJTlZBTElEX09QRVJBVElPTiwgSU5WQUxJRF9TSUdOQVRVUkUgfSA9IHJlcXVpcmUoJ2h5cGVyY29yZS1lcnJvcnMnKQoKY29uc3QgTXV0ZXggPSByZXF1aXJlKCcuL211dGV4JykKY29uc3QgQml0ZmllbGQgPSByZXF1aXJlKCcuL2JpdGZpZWxkJykKY29uc3QgeyBNZXJrbGVUcmVlLCBNZXJrbGVUcmVlQmF0Y2ggfSA9IHJlcXVpcmUoJy4vbWVya2xlLXRyZWUnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBTZXNzaW9uU3RhdGUgewogIGNvbnN0cnVjdG9yKGNvcmUsIHBhcmVudCwgc3RvcmFnZSwgdHJlZUluZm8sIG5hbWUpIHsKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMuaW5kZXggPSB0aGlzLmNvcmUuc2Vzc2lvblN0YXRlcy5wdXNoKHRoaXMpIC0gMQoKICAgIHRoaXMuc3RvcmFnZSA9IHN0b3JhZ2UKICAgIHRoaXMubmFtZSA9IG5hbWUKICAgIHRoaXMuc2Vzc2lvbnMgPSBbXQoKICAgIC8vIHNtYWxsIGhhY2sgdG8gY2xvc2Ugb2xkIHN0b3JhZ2VzIGFzIGxhdGUgYXMgcG9zc2libGUuCiAgICAvLyBUT0RPOiBhZGQgYSByZWFkIGxvY2sgc28gd2UgY2FuIGF2b2lkIHRoYXQKICAgIHRoaXMubGluZ2VycyA9IG51bGwKCiAgICB0aGlzLnBhcmVudCA9IHBhcmVudAogICAgdGhpcy5hdG9taXplZCA9IG51bGwKICAgIHRoaXMubXV0ZXggPSBuZXcgTXV0ZXgoKQoKICAgIC8vIG1lcmtsZSBzdGF0ZQogICAgdGhpcy5yb290cyA9IHRyZWVJbmZvLnJvb3RzLmxlbmd0aCA/IHRyZWVJbmZvLnJvb3RzIDogW10KICAgIHRoaXMuZm9yayA9IHRyZWVJbmZvLmZvcmsgfHwgMAogICAgdGhpcy5sZW5ndGggPSBNZXJrbGVUcmVlLnNwYW4odGhpcy5yb290cykgLyAyCiAgICB0aGlzLmJ5dGVMZW5ndGggPSBNZXJrbGVUcmVlLnNpemUodGhpcy5yb290cykKICAgIHRoaXMucHJvbG9ndWUgPSB0cmVlSW5mby5wcm9sb2d1ZSB8fCBudWxsCiAgICB0aGlzLnNpZ25hdHVyZSA9IHRyZWVJbmZvLnNpZ25hdHVyZSB8fCBudWxsCgogICAgdGhpcy5zbmFwc2hvdENvbXBhdExlbmd0aCA9IHRoaXMuaXNTbmFwc2hvdCgpCiAgICAgID8gTWF0aC5taW4odGhpcy5sZW5ndGgsIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpCiAgICAgIDogLTEKICAgIHRoaXMubGFzdFRydW5jYXRpb24gPSBudWxsCgogICAgdGhpcy5hY3RpdmUgPSAwCgogICAgdGhpcy5fYWN0aXZlVHggPSBudWxsCiAgICB0aGlzLl9wZW5kaW5nQml0ZmllbGQgPSBudWxsCgogICAgdGhpcy5yZWYoKQogIH0KCiAgaXNTbmFwc2hvdCgpIHsKICAgIHJldHVybiB0aGlzLnN0b3JhZ2Uuc25hcHNob3R0ZWQKICB9CgogIGlzRGVmYXVsdCgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUuc3RhdGUgPT09IHRoaXMgfHwgdGhpcy5pc0F0b21pY0RlZmF1bHQoKQogIH0KCiAgaXNBdG9taWNEZWZhdWx0KCkgewogICAgcmV0dXJuICEhdGhpcy5zdG9yYWdlLmF0b20gJiYgISF0aGlzLnBhcmVudCAmJiB0aGlzLnBhcmVudC5pc0RlZmF1bHQoKQogIH0KCiAgY3JlYXRlVHJlZUJhdGNoKCkgewogICAgcmV0dXJuIG5ldyBNZXJrbGVUcmVlQmF0Y2godGhpcykKICB9CgogIGFkZFNlc3Npb24ocykgewogICAgaWYgKHMuX3N0YXRlSW5kZXggIT09IC0xKSByZXR1cm4KICAgIHMuX3N0YXRlSW5kZXggPSB0aGlzLnNlc3Npb25zLnB1c2gocykgLSAxCiAgICBpZiAocy53ZWFrID09PSBmYWxzZSkgdGhpcy5jb3JlLmFjdGl2ZVNlc3Npb25zKysKICB9CgogIHJlbW92ZVNlc3Npb24ocykgewogICAgaWYgKHMuX3N0YXRlSW5kZXggPT09IC0xKSByZXR1cm4KICAgIGNvbnN0IGhlYWQgPSB0aGlzLnNlc3Npb25zLnBvcCgpCiAgICBpZiAoaGVhZCAhPT0gcykgdGhpcy5zZXNzaW9uc1soaGVhZC5fc3RhdGVJbmRleCA9IHMuX3N0YXRlSW5kZXgpXSA9IGhlYWQKICAgIHMuX3N0YXRlSW5kZXggPSAtMQogICAgaWYgKHMud2VhayA9PT0gZmFsc2UpIHRoaXMuY29yZS5hY3RpdmVTZXNzaW9ucy0tCiAgICB0aGlzLmNvcmUuY2hlY2tJZklkbGUoKQogIH0KCiAgZmx1c2hlZExlbmd0aCgpIHsKICAgIGlmICh0aGlzLmlzRGVmYXVsdCgpIHx8IHRoaXMuaXNTbmFwc2hvdCgpKSByZXR1cm4gdGhpcy5sZW5ndGgKICAgIGNvbnN0IGRlcHMgPSB0aGlzLnN0b3JhZ2UuZGVwZW5kZW5jaWVzCiAgICBpZiAoZGVwcy5sZW5ndGgpIHJldHVybiBkZXBzW2RlcHMubGVuZ3RoIC0gMV0ubGVuZ3RoCiAgICByZXR1cm4gMAogIH0KCiAgc2lnbmVkTGVuZ3RoKCkgewogICAgY29uc3QgbCA9IE1hdGgubWluKHRoaXMuZmx1c2hlZExlbmd0aCgpLCB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoKQogICAgcmV0dXJuIHRoaXMuaXNTbmFwc2hvdCgpICYmIGwgPiB0aGlzLnNuYXBzaG90Q29tcGF0TGVuZ3RoID8gdGhpcy5zbmFwc2hvdENvbXBhdExlbmd0aCA6IGwKICB9CgogIHVucmVmKCkgewogICAgaWYgKC0tdGhpcy5hY3RpdmUgPiAwKSByZXR1cm4KICAgIHRoaXMuY2xvc2UoKS5jYXRjaChub29wKSAvLyB0ZWNobmljYWxseSBhc3luYywgYnV0IG9ubHkgZm9yIHRoZSBsYXN0IGRiIHNlc3Npb24KICB9CgogIHJlZigpIHsKICAgIHRoaXMuYWN0aXZlKysKICAgIHJldHVybiB0aGlzCiAgfQoKICBoYXNoKCkgewogICAgcmV0dXJuIE1lcmtsZVRyZWUuaGFzaCh0aGlzKQogIH0KCiAgc2V0Um9vdHMocm9vdHMpIHsKICAgIHRoaXMucm9vdHMgPSByb290cwogICAgdGhpcy5sZW5ndGggPSBNZXJrbGVUcmVlLnNwYW4ocm9vdHMpIC8gMgogICAgdGhpcy5ieXRlTGVuZ3RoID0gTWVya2xlVHJlZS5zaXplKHJvb3RzKQogIH0KCiAgZ2V0IGVuY3J5cHRpb25Gb3JrKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5oZWFkZXIudHJlZS5mb3JrCiAgfQoKICBhc3luYyB1cGRhdGVTbmFwc2hvdFN0b3JhZ2Uoc3RvcmFnZSkgewogICAgaWYgKCF0aGlzLmF0b21pemVkIHx8ICF0aGlzLmF0b21pemVkLmZsdXNoaW5nKSByZXR1cm4gdGhpcy50cmVlSW5mbygpCiAgICBhd2FpdCB0aGlzLmF0b21pemVkLmZsdXNoZWQoKQoKICAgIGxldCByeCA9IHN0b3JhZ2UucmVhZCgpCiAgICBjb25zdCBoZWFkUHJvbWlzZSA9IHJ4LmdldEhlYWQoKQogICAgY29uc3QgYXV0aFByb21pc2UgPSByeC5nZXRBdXRoKCkKICAgIGNvbnN0IGRlcFByb21pc2UgPSByeC5nZXREZXBlbmRlbmN5KCkKCiAgICByeC50cnlGbHVzaCgpCiAgICBjb25zdCBbaGVhZCwgYXV0aCwgZGVwXSA9IGF3YWl0IFByb21pc2UuYWxsKFtoZWFkUHJvbWlzZSwgYXV0aFByb21pc2UsIGRlcFByb21pc2VdKQoKICAgIHN0b3JhZ2Uuc2V0RGVwZW5kZW5jeUhlYWQoZGVwKQoKICAgIGNvbnN0IGZvcmsgPSBoZWFkID8gaGVhZC5mb3JrIDogMAogICAgY29uc3QgbGVuZ3RoID0gaGVhZCA/IGhlYWQubGVuZ3RoIDogMAoKICAgIHJ4ID0gc3RvcmFnZS5yZWFkKCkKICAgIGNvbnN0IHJvb3RQcm9taXNlcyA9IFtdCiAgICBmb3IgKGNvbnN0IHIgb2YgZmxhdC5mdWxsUm9vdHMobGVuZ3RoICogMikpIHsKICAgICAgcm9vdFByb21pc2VzLnB1c2gocnguZ2V0VHJlZU5vZGUocikpCiAgICB9CgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IHJvb3RzID0gYXdhaXQgUHJvbWlzZS5hbGwocm9vdFByb21pc2VzKQoKICAgIC8vIGRibCBjaGVjayBpZiB3ZSBhcmUgaGl0dGluZyBhbiByZWdyZXNzaW9uIGZyb20gZWFybGVyCiAgICBmb3IgKGNvbnN0IHJvb3Qgb2Ygcm9vdHMpIHsKICAgICAgaWYgKHJvb3QgPT09IG51bGwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAnQmFkIHNuYXBzaG90IGZyb20gYXRvbWl6ZWQgc2Vzc2lvbiwgaWQgPSAnICsKICAgICAgICAgICAgdGhpcy5jb3JlLmlkICsKICAgICAgICAgICAgJyBsZW5ndGggPSAnICsKICAgICAgICAgICAgbGVuZ3RoICsKICAgICAgICAgICAgJyBmb3JrID0gJyArCiAgICAgICAgICAgIGZvcmsKICAgICAgICApCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gewogICAgICBmb3JrLAogICAgICByb290cywKICAgICAgbGVuZ3RoLAogICAgICBwcm9sb2d1ZTogYXV0aC5tYW5pZmVzdCAmJiBhdXRoLm1hbmlmZXN0LnByb2xvZ3VlLAogICAgICBzaWduYXR1cmU6IGhlYWQgJiYgaGVhZC5zaWduYXR1cmUKICAgIH0KICB9CgogIHRyZWVJbmZvKCkgewogICAgcmV0dXJuIHsKICAgICAgZm9yazogdGhpcy5mb3JrLAogICAgICByb290czogdGhpcy5yb290cy5zbGljZSgpLAogICAgICBsZW5ndGg6IHRoaXMubGVuZ3RoLAogICAgICBwcm9sb2d1ZTogdGhpcy5wcm9sb2d1ZSwKICAgICAgc2lnbmF0dXJlOiB0aGlzLnNpZ25hdHVyZQogICAgfQogIH0KCiAgYXN5bmMgY2xvc2UoKSB7CiAgICBpZiAodGhpcy5pbmRleCA9PT0gLTEpIHJldHVybgoKICAgIHRoaXMuYWN0aXZlID0gMAogICAgdGhpcy5tdXRleC5kZXN0cm95KG5ldyBFcnJvcignQ2xvc2VkJykpLmNhdGNoKG5vb3ApCiAgICBpZiAodGhpcy5wYXJlbnQgJiYgdGhpcy5wYXJlbnQuYXRvbWl6ZWQpIHRoaXMucGFyZW50LmF0b21pemVkID0gbnVsbAoKICAgIGNvbnN0IGNsb3NpbmcgPSB0aGlzLnN0b3JhZ2UuY2xvc2UoKQoKICAgIGNvbnN0IGhlYWQgPSB0aGlzLmNvcmUuc2Vzc2lvblN0YXRlcy5wb3AoKQogICAgaWYgKGhlYWQgIT09IHRoaXMpIHRoaXMuY29yZS5zZXNzaW9uU3RhdGVzWyhoZWFkLmluZGV4ID0gdGhpcy5pbmRleCldID0gaGVhZAoKICAgIHRoaXMuaW5kZXggPSAtMQogICAgdGhpcy5jb3JlLmNoZWNrSWZJZGxlKCkKCiAgICBpZiAodGhpcy5saW5nZXJzICE9PSBudWxsKSB7CiAgICAgIGZvciAoY29uc3Qgc3RvcmFnZSBvZiB0aGlzLmxpbmdlcnMpIGF3YWl0IHN0b3JhZ2UuY2xvc2UoKQogICAgfQoKICAgIHJldHVybiBjbG9zaW5nCiAgfQoKICBhc3luYyBzbmFwc2hvdCgpIHsKICAgIGNvbnN0IHN0b3JhZ2UgPSB0aGlzLnN0b3JhZ2Uuc25hcHNob3QoKQogICAgY29uc3QgdHJlZUluZm8gPSBhd2FpdCB0aGlzLnVwZGF0ZVNuYXBzaG90U3RvcmFnZShzdG9yYWdlKQoKICAgIGNvbnN0IHMgPSBuZXcgU2Vzc2lvblN0YXRlKHRoaXMuY29yZSwgbnVsbCwgc3RvcmFnZSwgdHJlZUluZm8sIHRoaXMubmFtZSkKCiAgICByZXR1cm4gcwogIH0KCiAgdXBkYXRlRGVwZW5kZW5jeSh0eCwgbGVuZ3RoKSB7CiAgICBjb25zdCBkZXBlbmRlbmN5ID0gdXBkYXRlRGVwZW5kZW5jeSh0aGlzLCBsZW5ndGgsIGZhbHNlKQogICAgaWYgKGRlcGVuZGVuY3kpIHR4LnNldERlcGVuZGVuY3koZGVwZW5kZW5jeSkKICAgIHJldHVybiBkZXBlbmRlbmN5CiAgfQoKICBfY2xlYXJBY3RpdmVCYXRjaCgpIHsKICAgIHRoaXMuX2FjdGl2ZVR4ID0gbnVsbAogIH0KCiAgY3JlYXRlV3JpdGVCYXRjaCgpIHsKICAgIGFzc2VydCghdGhpcy5fYWN0aXZlVHggJiYgIXRoaXMuc3RvcmFnZS5zbmFwc2hvdHRlZCkKCiAgICB0aGlzLl9hY3RpdmVUeCA9IHRoaXMuc3RvcmFnZS53cml0ZSgpCiAgICByZXR1cm4gdGhpcy5fYWN0aXZlVHgKICB9CgogIF91bmxvY2soKSB7CiAgICB0aGlzLl9jbGVhckFjdGl2ZUJhdGNoKCkKICAgIHRoaXMubXV0ZXgudW5sb2NrKCkKICAgIHRoaXMuY29yZS5jaGVja0lmSWRsZSgpCiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGNvbnN0IHR4ID0gdGhpcy5fYWN0aXZlVHgKICAgIHRoaXMuX2FjdGl2ZVR4ID0gbnVsbAoKICAgIHRyeSB7CiAgICAgIGlmICghKGF3YWl0IHR4LmZsdXNoKCkpKSByZXR1cm4gZmFsc2UKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX2NsZWFyQWN0aXZlQmF0Y2goKQogICAgfQoKICAgIHRoaXMubGFzdFRydW5jYXRpb24gPSBudWxsCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3ByZWNvbW1pdCgpIHsKICAgIHRoaXMuY29tbWl0aW5nID0gdHJ1ZQogIH0KCiAgYXN5bmMgX2NvbW1pdCgpIHsKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgY29uc3QgYml0ZmllbGQgPSB0aGlzLl9wZW5kaW5nQml0ZmllbGQKICAgICAgdGhpcy5fcGVuZGluZ0JpdGZpZWxkID0gbnVsbAogICAgICB0aGlzLmxhc3RUcnVuY2F0aW9uID0gbnVsbAogICAgICBhd2FpdCB0aGlzLnBhcmVudC5fb25jb21taXQodGhpcywgYml0ZmllbGQpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLmNvbW1pdGluZyA9IGZhbHNlCiAgICAgIHRoaXMubXV0ZXgudW5sb2NrKCkKICAgIH0KICB9CgogIGFzeW5jIF9vbmNvbW1pdChzcmMsIGJpdGZpZWxkKSB7CiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IGN1cnJMZW5ndGggPSB0aGlzLmxlbmd0aAoKICAgICAgLy8gbG9hZCBkZXBlbmRlbmN5IGludG8gbWVtb3J5CiAgICAgIGNvbnN0IHJ4ID0gdGhpcy5zdG9yYWdlLnJlYWQoKQogICAgICBjb25zdCBkZXBlbmRlbmN5UHJvbWlzZSA9IHJ4LmdldERlcGVuZGVuY3koKQoKICAgICAgcngudHJ5Rmx1c2goKQoKICAgICAgY29uc3QgZGVwZW5kZW5jeSA9IGF3YWl0IGRlcGVuZGVuY3lQcm9taXNlCgogICAgICB0aGlzLmZvcmsgPSBzcmMuZm9yawogICAgICB0aGlzLmxlbmd0aCA9IHNyYy5sZW5ndGgKICAgICAgdGhpcy5ieXRlTGVuZ3RoID0gc3JjLmJ5dGVMZW5ndGgKICAgICAgdGhpcy5yb290cyA9IHNyYy5yb290cy5zbGljZSgpCiAgICAgIHRoaXMuc2lnbmF0dXJlID0gc3JjLnNpZ25hdHVyZQoKICAgICAgY29uc3QgdHJlZSA9IHsKICAgICAgICBmb3JrOiB0aGlzLmZvcmssCiAgICAgICAgbGVuZ3RoOiB0aGlzLmxlbmd0aCwKICAgICAgICByb290SGFzaDogdGhpcy5oYXNoKCksCiAgICAgICAgc2lnbmF0dXJlOiB0aGlzLnNpZ25hdHVyZQogICAgICB9CgogICAgICBpZiAoZGVwZW5kZW5jeSkgdGhpcy5zdG9yYWdlLnNldERlcGVuZGVuY3lIZWFkKGRlcGVuZGVuY3kpCgogICAgICBjb25zdCBiID0gYml0ZmllbGQKCiAgICAgIGlmIChiICYmIGIudHJ1bmNhdGVkICYmIGIuc3RhcnQgPCBjdXJyTGVuZ3RoKSB7CiAgICAgICAgdGhpcy5vbnRydW5jYXRlKHRyZWUsIGIuc3RhcnQsIGN1cnJMZW5ndGgsIHRydWUpCiAgICAgICAgaWYgKCFiIHx8IGIuYXBwZW5kcyA9PT0gMCkgcmV0dXJuCiAgICAgIH0KCiAgICAgIGNvbnN0IGFwcGVuZCA9IGIgPyB7IHN0YXJ0OiBiLnN0YXJ0LCBsZW5ndGg6IGIuYXBwZW5kcywgZHJvcDogZmFsc2UgfSA6IG51bGwKCiAgICAgIHRoaXMub25hcHBlbmQodHJlZSwgYXBwZW5kLCB0cnVlKQoKICAgICAgaWYgKHRoaXMuY29yZS5oaW50c0NoYW5nZWQgJiYgdGhpcy5pc0RlZmF1bHQoKSkgYXdhaXQgdGhpcy5jb3JlLmZsdXNoSGludHMoKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5tdXRleC51bmxvY2soKQogICAgICB0aGlzLmNvcmUuY2hlY2tJZklkbGUoKQogICAgfQogIH0KCiAgYXN5bmMgc2V0VXNlckRhdGEoa2V5LCB2YWx1ZSkgewogICAgYXdhaXQgdGhpcy5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBjb25zdCB0eCA9IHRoaXMuY3JlYXRlV3JpdGVCYXRjaCgpCiAgICAgIHR4LnB1dFVzZXJEYXRhKGtleSwgdmFsdWUpCgogICAgICByZXR1cm4gYXdhaXQgdGhpcy5mbHVzaCgpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl91bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgX3ZlcmlmeUJsb2NrKGJhdGNoLCBiaXRmaWVsZCwgdmFsdWUsIG1hbmlmZXN0LCBmcm9tKSB7CiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGlmIChiYXRjaC51cGdyYWRlZCAmJiBiYXRjaC5sZW5ndGggPD0gdGhpcy5sZW5ndGgpIHsKICAgICAgICBhd2FpdCBiYXRjaC5kb3duZ3JhZGUoKQogICAgICB9CgogICAgICBpZiAoIWJhdGNoLmNvbW1pdGFibGUoKSkgewogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9CgogICAgICBpZiAodGhpcy5jb3JlLnByZXVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgIGF3YWl0IHRoaXMuY29yZS5wcmV1cGRhdGUoYmF0Y2gsIHRoaXMuY29yZS5oZWFkZXIua2V5KQogICAgICB9CgogICAgICBjb25zdCB0eCA9IHRoaXMuY3JlYXRlV3JpdGVCYXRjaCgpCiAgICAgIHRoaXMudXBkYXRpbmcgPSB0cnVlCgogICAgICBpZiAoYml0ZmllbGQpIHsKICAgICAgICB0eC5wdXRCbG9jayhiaXRmaWVsZC5zdGFydCwgdmFsdWUpCiAgICAgIH0KCiAgICAgIGlmIChiaXRmaWVsZCAmJiB0aGlzLmlzRGVmYXVsdCgpKSB7CiAgICAgICAgYXdhaXQgc3RvcmVCaXRmaWVsZFJhbmdlKHRoaXMuc3RvcmFnZSwgdHgsIGJpdGZpZWxkLnN0YXJ0LCBiaXRmaWVsZC5zdGFydCArIDEsIHRydWUpCiAgICAgIH0KCiAgICAgIGlmIChtYW5pZmVzdCkgdGhpcy5jb3JlLl9zZXRNYW5pZmVzdCh0eCwgbWFuaWZlc3QsIG51bGwpCgogICAgICBhc3NlcnQoYmF0Y2guY29tbWl0YWJsZSgpLCAnU2hvdWxkIHN0aWxsIGJlIGNvbW1pdGFibGUnKQogICAgICBiYXRjaC5jb21taXQodHgpCgogICAgICBjb25zdCBoZWFkID0gewogICAgICAgIGZvcms6IGJhdGNoLmZvcmssCiAgICAgICAgbGVuZ3RoOiBiYXRjaC5sZW5ndGgsCiAgICAgICAgcm9vdEhhc2g6IGJhdGNoLmhhc2goKSwKICAgICAgICBzaWduYXR1cmU6IGJhdGNoLnNpZ25hdHVyZQogICAgICB9CgogICAgICBpZiAoYmF0Y2gudXBncmFkZWQpIHR4LnNldEhlYWQoaGVhZCkKCiAgICAgIGNvbnN0IGZsdXNoZWQgPSBhd2FpdCB0aGlzLmZsdXNoKCkKCiAgICAgIGlmIChiYXRjaC51cGdyYWRlZCkgewogICAgICAgIHRoaXMucm9vdHMgPSBiYXRjaC5yb290cwogICAgICAgIHRoaXMubGVuZ3RoID0gYmF0Y2gubGVuZ3RoCiAgICAgICAgdGhpcy5ieXRlTGVuZ3RoID0gYmF0Y2guYnl0ZUxlbmd0aAogICAgICAgIHRoaXMuZm9yayA9IGJhdGNoLmZvcmsKICAgICAgICB0aGlzLnNpZ25hdHVyZSA9IGJhdGNoLnNpZ25hdHVyZQoKICAgICAgICB0aGlzLm9uYXBwZW5kKGhlYWQsIGJpdGZpZWxkLCBmbHVzaGVkKQogICAgICB9CgogICAgICBpZiAodGhpcy5jb3JlLmhpbnRzQ2hhbmdlZCAmJiB0aGlzLmlzRGVmYXVsdCgpKSBhd2FpdCB0aGlzLmNvcmUuZmx1c2hIaW50cygpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl9jbGVhckFjdGl2ZUJhdGNoKCkKICAgICAgdGhpcy51cGRhdGluZyA9IGZhbHNlCiAgICAgIHRoaXMubXV0ZXgudW5sb2NrKCkKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgdHJ1bmNhdGUobGVuZ3RoLCBmb3JrLCB7IHNpZ25hdHVyZSwga2V5UGFpciB9ID0ge30pIHsKICAgIGlmICgha2V5UGFpciAmJiB0aGlzLmlzRGVmYXVsdCgpKSBrZXlQYWlyID0gdGhpcy5jb3JlLmhlYWRlci5rZXlQYWlyCgogICAgYXdhaXQgdGhpcy5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBpZiAodGhpcy5wcm9sb2d1ZSAmJiBsZW5ndGggPCB0aGlzLnByb2xvZ3VlLmxlbmd0aCkgewogICAgICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdUcnVuY2F0aW9uIGJyZWFrcyBwcm9sb2d1ZScsIHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkpCiAgICAgIH0KICAgICAgaWYgKGxlbmd0aCA+IHRoaXMubGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oCiAgICAgICAgICAnTm90IGEgdHJ1bmNhdGlvbiwgJyArIGxlbmd0aCArICcgbXVzdCBiZSBsZXNzIG9yIGVxdWFsIHRvICcgKyB0aGlzLmxlbmd0aCwKICAgICAgICAgIHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkKICAgICAgICApCiAgICAgIH0KCiAgICAgIGNvbnN0IGJhdGNoID0gdGhpcy5jcmVhdGVUcmVlQmF0Y2goKQogICAgICBhd2FpdCBNZXJrbGVUcmVlLnRydW5jYXRlKHRoaXMsIGxlbmd0aCwgYmF0Y2gsIGZvcmspCgogICAgICBpZiAoIXNpZ25hdHVyZSAmJiBrZXlQYWlyICYmIGxlbmd0aCA+IDApIHNpZ25hdHVyZSA9IHRoaXMuY29yZS52ZXJpZmllci5zaWduKGJhdGNoLCBrZXlQYWlyKQogICAgICBpZiAoc2lnbmF0dXJlKSBiYXRjaC5zaWduYXR1cmUgPSBzaWduYXR1cmUKCiAgICAgIGNvbnN0IHR4ID0gdGhpcy5jcmVhdGVXcml0ZUJhdGNoKCkKCiAgICAgIC8vIHVwc2VydCBjb21wYXQgbWFuaWZlc3QKICAgICAgaWYgKHRoaXMuY29yZS52ZXJpZmllciA9PT0gbnVsbCAmJiBrZXlQYWlyKSB0aGlzLmNvcmUuX3NldE1hbmlmZXN0KHR4LCBudWxsLCBrZXlQYWlyKQoKICAgICAgY29uc3QgeyBkZXBlbmRlbmN5LCB0cmVlLCByb290cyB9ID0gYXdhaXQgdGhpcy5fdHJ1bmNhdGUodHgsIGJhdGNoKQoKICAgICAgZm9yIChjb25zdCBzZXNzaW9uU3RhdGUgb2YgdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXMpIHsKICAgICAgICBpZiAoCiAgICAgICAgICBzZXNzaW9uU3RhdGUuaXNTbmFwc2hvdCgpICYmCiAgICAgICAgICBzZXNzaW9uU3RhdGUubmFtZSA9PT0gdGhpcy5uYW1lICYmCiAgICAgICAgICBsZW5ndGggPCBzZXNzaW9uU3RhdGUuc25hcHNob3RDb21wYXRMZW5ndGgKICAgICAgICApIHsKICAgICAgICAgIHNlc3Npb25TdGF0ZS5zbmFwc2hvdENvbXBhdExlbmd0aCA9IGxlbmd0aAogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgZmx1c2hlZCA9IGF3YWl0IHRoaXMuZmx1c2goKQoKICAgICAgdGhpcy5mb3JrID0gdHJlZS5mb3JrCiAgICAgIHRoaXMubGVuZ3RoID0gdHJlZS5sZW5ndGgKICAgICAgdGhpcy5ieXRlTGVuZ3RoID0gTWVya2xlVHJlZS5zaXplKHJvb3RzKQogICAgICB0aGlzLnJvb3RzID0gcm9vdHMKICAgICAgdGhpcy5zaWduYXR1cmUgPSB0cmVlLnNpZ25hdHVyZQoKICAgICAgaWYgKGRlcGVuZGVuY3kpIHRoaXMuc3RvcmFnZS5zZXREZXBlbmRlbmN5SGVhZChkZXBlbmRlbmN5KQoKICAgICAgdGhpcy5vbnRydW5jYXRlKHRyZWUsIHRyZWUubGVuZ3RoLCBiYXRjaC50cmVlTGVuZ3RoLCBmbHVzaGVkKQoKICAgICAgaWYgKHRoaXMuY29yZS5oaW50c0NoYW5nZWQgJiYgdGhpcy5pc0RlZmF1bHQoKSkgYXdhaXQgdGhpcy5jb3JlLmZsdXNoSGludHMoKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fdW5sb2NrKCkKICAgIH0KICB9CgogIGFzeW5jIHJlb3JnKGJhdGNoKSB7CiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIGNvbnN0IHN0b3JhZ2UgPSB0aGlzLmNyZWF0ZVdyaXRlQmF0Y2goKQoKICAgIHRyeSB7CiAgICAgIGlmICghYmF0Y2guY29tbWl0YWJsZSgpKSByZXR1cm4gZmFsc2UKCiAgICAgIGNvbnN0IHsgZGVwZW5kZW5jeSwgdHJlZSB9ID0gYXdhaXQgdGhpcy5fdHJ1bmNhdGUoc3RvcmFnZSwgYmF0Y2gpCgogICAgICBjb25zdCBmbHVzaGVkID0gYXdhaXQgdGhpcy5mbHVzaCgpCgogICAgICB0aGlzLmZvcmsgPSBiYXRjaC5mb3JrCiAgICAgIHRoaXMubGVuZ3RoID0gYmF0Y2gubGVuZ3RoCiAgICAgIHRoaXMuYnl0ZUxlbmd0aCA9IGJhdGNoLmJ5dGVMZW5ndGgKICAgICAgdGhpcy5yb290cyA9IGJhdGNoLnJvb3RzCiAgICAgIHRoaXMuc2lnbmF0dXJlID0gYmF0Y2guc2lnbmF0dXJlCgogICAgICBpZiAoZGVwZW5kZW5jeSkgdGhpcy5zdG9yYWdlLnNldERlcGVuZGVuY3lIZWFkKGRlcGVuZGVuY3kpCgogICAgICB0aGlzLm9udHJ1bmNhdGUodHJlZSwgYmF0Y2guYW5jZXN0b3JzLCBiYXRjaC50cmVlTGVuZ3RoLCBmbHVzaGVkKQoKICAgICAgaWYgKHRoaXMuY29yZS5oaW50c0NoYW5nZWQgJiYgdGhpcy5pc0RlZmF1bHQoKSkgYXdhaXQgdGhpcy5jb3JlLmZsdXNoSGludHMoKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fdW5sb2NrKCkKICAgIH0KICB9CgogIGFzeW5jIF90cnVuY2F0ZShzdG9yYWdlLCBiYXRjaCkgewogICAgc3RvcmFnZS5kZWxldGVCbG9ja1JhbmdlKGJhdGNoLmFuY2VzdG9ycywgYmF0Y2gudHJlZUxlbmd0aCkKCiAgICBhc3NlcnQoYmF0Y2guY29tbWl0YWJsZSgpLCAnQmF0Y2ggbXVzdCBiZSBjb21taXRhYmxlJykKCiAgICBjb25zdCB0cmVlID0gewogICAgICBmb3JrOiBiYXRjaC5mb3JrLAogICAgICBsZW5ndGg6IGJhdGNoLmxlbmd0aCwKICAgICAgcm9vdEhhc2g6IGJhdGNoLmhhc2goKSwKICAgICAgc2lnbmF0dXJlOiBiYXRjaC5zaWduYXR1cmUKICAgIH0KCiAgICBzdG9yYWdlLnNldEhlYWQodHJlZSkKICAgIGJhdGNoLmNvbW1pdChzdG9yYWdlKQoKICAgIGNvbnN0IHRydW5jYXRlZCA9IGJhdGNoLmxlbmd0aCA8IHRoaXMuZmx1c2hlZExlbmd0aCgpCiAgICBjb25zdCBkZXBlbmRlbmN5ID0gdHJ1bmNhdGVkID8gdXBkYXRlRGVwZW5kZW5jeSh0aGlzLCBiYXRjaC5sZW5ndGgsIHRydWUpIDogbnVsbAoKICAgIGlmIChkZXBlbmRlbmN5KSBzdG9yYWdlLnNldERlcGVuZGVuY3koZGVwZW5kZW5jeSkKCiAgICBpZiAodGhpcy5pc0RlZmF1bHQoKSkgewogICAgICBhd2FpdCBzdG9yZUJpdGZpZWxkUmFuZ2UodGhpcy5zdG9yYWdlLCBzdG9yYWdlLCBiYXRjaC5hbmNlc3RvcnMsIGJhdGNoLnRyZWVMZW5ndGgsIGZhbHNlKQogICAgICBpZiAoYmF0Y2guYW5jZXN0b3JzIDwgdGhpcy5jb3JlLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoKSB7CiAgICAgICAgdGhpcy5jb3JlLmhlYWRlci5oaW50cy5yZW1vdGVDb250aWd1b3VzTGVuZ3RoID0gTWF0aC5taW4oCiAgICAgICAgICBiYXRjaC5sZW5ndGgsCiAgICAgICAgICB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgKICAgICAgICApCiAgICAgICAgc3RvcmFnZS5zZXRIaW50cyh7CiAgICAgICAgICBjb250aWd1b3VzTGVuZ3RoOiBiYXRjaC5hbmNlc3RvcnMsCiAgICAgICAgICByZW1vdGVDb250aWd1b3VzTGVuZ3RoOiB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgKICAgICAgICB9KQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsgZGVwZW5kZW5jeSwgdHJlZSwgcm9vdHM6IGJhdGNoLnJvb3RzIH0KICB9CgogIGFzeW5jIGNsZWFyKHN0YXJ0LCBlbmQsIGNsZWFyZWQpIHsKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgY29uc3QgdHggPSB0aGlzLmNyZWF0ZVdyaXRlQmF0Y2goKQoKICAgICAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihzdGFydCAqIDIpCiAgICAgIHdoaWxlICghaXNSb290SW5kZXgoaXRlLmluZGV4LCB0aGlzLnJvb3RzKSkgewogICAgICAgIGNvbnN0IGEgPSBpdGUuaW5kZXgKICAgICAgICBjb25zdCBiID0gaXRlLnNpYmxpbmcoKQogICAgICAgIGl0ZS5wYXJlbnQoKQoKICAgICAgICBjb25zdCBbbGVmdCwgcmlnaHRdID0gZmxhdC5zcGFucyhiKQogICAgICAgIGNvbnN0IHMgPSBsZWZ0IC8gMgogICAgICAgIGNvbnN0IGUgPSByaWdodCAvIDIgKyAxCiAgICAgICAgY29uc3QgaGFzID0gcyA8PSBzdGFydCAmJiBlIDw9IGVuZCA/IGZhbHNlIDogdGhpcy5jb3JlLmJpdGZpZWxkLmhhc1NldChzLCBlIC0gcykKICAgICAgICBpZiAoaGFzKSBicmVhawoKICAgICAgICB0eC5kZWxldGVUcmVlTm9kZShhKQogICAgICAgIHR4LmRlbGV0ZVRyZWVOb2RlKGIpCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmlzRGVmYXVsdCgpKSB7CiAgICAgICAgYXdhaXQgc3RvcmVCaXRmaWVsZFJhbmdlKHRoaXMuc3RvcmFnZSwgdHgsIHN0YXJ0LCBlbmQsIGZhbHNlKQogICAgICAgIGlmIChzdGFydCA8IHRoaXMuY29yZS5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCkgewogICAgICAgICAgdHguc2V0SGludHMoewogICAgICAgICAgICBjb250aWd1b3VzTGVuZ3RoOiBzdGFydCwKICAgICAgICAgICAgcmVtb3RlQ29udGlndW91c0xlbmd0aDogdGhpcy5jb3JlLmhlYWRlci5oaW50cy5yZW1vdGVDb250aWd1b3VzTGVuZ3RoCiAgICAgICAgICB9KQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGVuZCAtIHN0YXJ0ID09PSAxKSB0eC5kZWxldGVCbG9jayhzdGFydCkKICAgICAgZWxzZSB0eC5kZWxldGVCbG9ja1JhbmdlKHN0YXJ0LCBlbmQpCgogICAgICBjb25zdCBkZXBlbmRlbmN5ID0gc3RhcnQgPCB0aGlzLmZsdXNoZWRMZW5ndGgoKSA/IHVwZGF0ZURlcGVuZGVuY3kodGhpcywgc3RhcnQsIHRydWUpIDogbnVsbAoKICAgICAgY29uc3QgZmx1c2hlZCA9IGF3YWl0IHRoaXMuZmx1c2goKQoKICAgICAgaWYgKGRlcGVuZGVuY3kpIHRoaXMuc3RvcmFnZS5zZXREZXBlbmRlbmN5SGVhZChkZXBlbmRlbmN5KQoKICAgICAgLy8gdG9kbzogYXRvbWljIGV2ZW50IGhhbmRsZQogICAgICBpZiAodGhpcy5pc0RlZmF1bHQoKSAmJiBmbHVzaGVkKSB7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gZW5kIC0gc3RhcnQKCiAgICAgICAgdGhpcy5jb3JlLnVwZGF0ZUNvbnRpZ3VvdXNMZW5ndGgoeyBzdGFydCwgbGVuZ3RoLCBkcm9wOiB0cnVlIH0pCiAgICAgICAgdGhpcy5jb3JlLl9zZXRCaXRmaWVsZFJhbmdlcyhzdGFydCwgZW5kLCBmYWxzZSkKICAgICAgICB0aGlzLmNvcmUucmVwbGljYXRvci5vbmhhdmUoc3RhcnQsIGxlbmd0aCwgdHJ1ZSkKCiAgICAgICAgaWYgKHRoaXMuY29yZS5oaW50c0NoYW5nZWQpIGF3YWl0IHRoaXMuY29yZS5mbHVzaEhpbnRzKCkKICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fdW5sb2NrKCkKICAgIH0KICB9CgogIGFzeW5jIGFwcGVuZCh2YWx1ZXMsIHsgc2lnbmF0dXJlLCBrZXlQYWlyLCBwcmVhcHBlbmQsIHBvc3RhcHBlbmQsIG1heExlbmd0aCA9IC0xIH0gPSB7fSkgewogICAgaWYgKCFrZXlQYWlyICYmIHRoaXMuaXNEZWZhdWx0KCkpIGtleVBhaXIgPSB0aGlzLmNvcmUuaGVhZGVyLmtleVBhaXIKCiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGlmIChtYXhMZW5ndGggPj0gMCAmJiB0aGlzLmxlbmd0aCArIHZhbHVlcy5sZW5ndGggPiBtYXhMZW5ndGgpIHsKICAgICAgICByZXR1cm4geyBsZW5ndGg6IHRoaXMubGVuZ3RoLCBieXRlTGVuZ3RoOiB0aGlzLmJ5dGVMZW5ndGggfQogICAgICB9CgogICAgICBjb25zdCB0eCA9IHRoaXMuY3JlYXRlV3JpdGVCYXRjaCgpCgogICAgICAvLyB1cHNlcnQgY29tcGF0IG1hbmlmZXN0CiAgICAgIGlmICh0aGlzLmNvcmUudmVyaWZpZXIgPT09IG51bGwgJiYga2V5UGFpcikgdGhpcy5jb3JlLl9zZXRNYW5pZmVzdCh0eCwgbnVsbCwga2V5UGFpcikKCiAgICAgIGlmIChwcmVhcHBlbmQpIGF3YWl0IHByZWFwcGVuZCh2YWx1ZXMpCgogICAgICBpZiAoIXZhbHVlcy5sZW5ndGgpIHsKICAgICAgICBhd2FpdCB0aGlzLmZsdXNoKCkKICAgICAgICByZXR1cm4geyBsZW5ndGg6IHRoaXMubGVuZ3RoLCBieXRlTGVuZ3RoOiB0aGlzLmJ5dGVMZW5ndGggfQogICAgICB9CgogICAgICBjb25zdCBiYXRjaCA9IHRoaXMuY3JlYXRlVHJlZUJhdGNoKCkKICAgICAgZm9yIChjb25zdCB2YWwgb2YgdmFsdWVzKSBiYXRjaC5hcHBlbmQodmFsKQoKICAgICAgLy8gb25seSBtdWx0aXNpZyBjYW4gaGF2ZSBwcm9sb2d1ZSBzbyBzaWduYXR1cmUgaXMgYWx3YXlzIHByZXNlbnQKICAgICAgaWYgKHRoaXMucHJvbG9ndWUgJiYgYmF0Y2gubGVuZ3RoIDwgdGhpcy5wcm9sb2d1ZS5sZW5ndGgpIHsKICAgICAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTignQXBwZW5kIGlzIG5vdCBjb25zaXN0ZW50IHdpdGggcHJvbG9ndWUnLCB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5KQogICAgICB9CgogICAgICBpZiAoIXNpZ25hdHVyZSAmJiBrZXlQYWlyKSBzaWduYXR1cmUgPSB0aGlzLmNvcmUudmVyaWZpZXIuc2lnbihiYXRjaCwga2V5UGFpcikKICAgICAgaWYgKHNpZ25hdHVyZSkgYmF0Y2guc2lnbmF0dXJlID0gc2lnbmF0dXJlCgogICAgICBiYXRjaC5jb21taXQodHgpCgogICAgICBjb25zdCB0cmVlID0gewogICAgICAgIGZvcms6IGJhdGNoLmZvcmssCiAgICAgICAgbGVuZ3RoOiBiYXRjaC5sZW5ndGgsCiAgICAgICAgcm9vdEhhc2g6IGJhdGNoLmhhc2goKSwKICAgICAgICBzaWduYXR1cmU6IGJhdGNoLnNpZ25hdHVyZQogICAgICB9CgogICAgICB0eC5zZXRIZWFkKHRyZWUpCgogICAgICBpZiAodGhpcy5pc0RlZmF1bHQoKSkgewogICAgICAgIGF3YWl0IHN0b3JlQml0ZmllbGRSYW5nZSh0aGlzLnN0b3JhZ2UsIHR4LCBiYXRjaC5hbmNlc3RvcnMsIGJhdGNoLmxlbmd0aCwgdHJ1ZSkKICAgICAgICBpZiAodGhpcy5sZW5ndGggPT09IHRoaXMuY29yZS5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCkgewogICAgICAgICAgdHguc2V0SGludHMoewogICAgICAgICAgICBjb250aWd1b3VzTGVuZ3RoOiB0aGlzLmxlbmd0aCArIHZhbHVlcy5sZW5ndGgsCiAgICAgICAgICAgIHJlbW90ZUNvbnRpZ3VvdXNMZW5ndGg6IHRoaXMuY29yZS5oZWFkZXIuaGludHMucmVtb3RlQ29udGlndW91c0xlbmd0aAogICAgICAgICAgfSkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdHgucHV0QmxvY2sodGhpcy5sZW5ndGggKyBpLCB2YWx1ZXNbaV0pCiAgICAgIH0KCiAgICAgIGNvbnN0IGJpdGZpZWxkID0gewogICAgICAgIGRyb3A6IGZhbHNlLAogICAgICAgIHN0YXJ0OiBiYXRjaC5hbmNlc3RvcnMsCiAgICAgICAgbGVuZ3RoOiB2YWx1ZXMubGVuZ3RoCiAgICAgIH0KCiAgICAgIGNvbnN0IGZsdXNoZWQgPSBhd2FpdCB0aGlzLmZsdXNoKCkKCiAgICAgIHRoaXMuZm9yayA9IGJhdGNoLmZvcmsKICAgICAgdGhpcy5yb290cyA9IGJhdGNoLnJvb3RzCiAgICAgIHRoaXMubGVuZ3RoID0gYmF0Y2gubGVuZ3RoCiAgICAgIHRoaXMuYnl0ZUxlbmd0aCA9IGJhdGNoLmJ5dGVMZW5ndGgKICAgICAgdGhpcy5zaWduYXR1cmUgPSBiYXRjaC5zaWduYXR1cmUKCiAgICAgIGlmIChwb3N0YXBwZW5kKSBhd2FpdCBwb3N0YXBwZW5kKHZhbHVlcykKCiAgICAgIHRoaXMub25hcHBlbmQodHJlZSwgYml0ZmllbGQsIGZsdXNoZWQpCgogICAgICBpZiAodGhpcy5jb3JlLmhpbnRzQ2hhbmdlZCAmJiB0aGlzLmlzRGVmYXVsdCgpKSBhd2FpdCB0aGlzLmNvcmUuZmx1c2hIaW50cygpCgogICAgICByZXR1cm4geyBsZW5ndGg6IHRoaXMubGVuZ3RoLCBieXRlTGVuZ3RoOiB0aGlzLmJ5dGVMZW5ndGggfQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fdW5sb2NrKCkKICAgIH0KICB9CgogIG9uYXBwZW5kKHRyZWUsIGJpdGZpZWxkLCBmbHVzaGVkKSB7CiAgICBpZiAoIWZsdXNoZWQpIHRoaXMuX3VwZGF0ZUJpdGZpZWxkKGJpdGZpZWxkKQogICAgZWxzZSBpZiAodGhpcy5pc0RlZmF1bHQoKSkgdGhpcy5jb3JlLm9uYXBwZW5kKHRyZWUsIGJpdGZpZWxkKQoKICAgIGZvciAobGV0IGkgPSB0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIHRoaXMuc2Vzc2lvbnNbaV0uZW1pdCgnYXBwZW5kJykKICAgIH0KICB9CgogIG9udHJ1bmNhdGUodHJlZSwgdG8sIGZyb20sIGZsdXNoZWQpIHsKICAgIGNvbnN0IGJpdGZpZWxkID0geyBzdGFydDogdG8sIGxlbmd0aDogZnJvbSAtIHRvLCBkcm9wOiB0cnVlIH0KCiAgICB0aGlzLmxhc3RUcnVuY2F0aW9uID0geyBmcm9tLCB0byB9CgogICAgaWYgKCFmbHVzaGVkKSB0aGlzLl91cGRhdGVCaXRmaWVsZChiaXRmaWVsZCkKICAgIGVsc2UgaWYgKHRoaXMuaXNEZWZhdWx0KCkpIHRoaXMuY29yZS5vbnRydW5jYXRlKHRyZWUsIGJpdGZpZWxkKQoKICAgIGZvciAoY29uc3Qgc2Vzc2lvblN0YXRlIG9mIHRoaXMuY29yZS5zZXNzaW9uU3RhdGVzKSB7CiAgICAgIGlmICgKICAgICAgICBzZXNzaW9uU3RhdGUuaXNTbmFwc2hvdCgpICYmCiAgICAgICAgc2Vzc2lvblN0YXRlLm5hbWUgPT09IHRoaXMubmFtZSAmJgogICAgICAgIHRvIDwgc2Vzc2lvblN0YXRlLnNuYXBzaG90Q29tcGF0TGVuZ3RoCiAgICAgICkgewogICAgICAgIHNlc3Npb25TdGF0ZS5zbmFwc2hvdENvbXBhdExlbmd0aCA9IHRvCiAgICAgIH0KICAgIH0KCiAgICBmb3IgKGxldCBpID0gdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICB0aGlzLnNlc3Npb25zW2ldLmVtaXQoJ3RydW5jYXRlJywgdG8sIHRyZWUuZm9yaykKICAgIH0KICB9CgogIF91cGRhdGVCaXRmaWVsZChiaXRmaWVsZCwgZmx1c2hlZCkgewogICAgaWYgKCFiaXRmaWVsZCkgcmV0dXJuCgogICAgY29uc3QgcCA9IHRoaXMuX3BlbmRpbmdCaXRmaWVsZAogICAgY29uc3QgYiA9IGJpdGZpZWxkCgogICAgaWYgKGIuZHJvcCkgewogICAgICAvLyB0cnVuY2F0aW9uIG11c3QgYmUgZnJvbSBlbmQKICAgICAgaWYgKHAgJiYgYi5zdGFydCArIGIubGVuZ3RoICE9PSBwLnN0YXJ0ICsgcC5hcHBlbmRzKSB7CiAgICAgICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0F0b21pYyB0cnVuY2F0aW9ucyBtdXN0IGJlIGNvbnRpZ3VvdXMnLCB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5KQogICAgICB9CgogICAgICAvLyBhY3R1YWwgdHJ1bmNhdGlvbgogICAgICBpZiAocCA9PT0gbnVsbCB8fCBiLnN0YXJ0IDwgcC5zdGFydCkgewogICAgICAgIHRoaXMuX3BlbmRpbmdCaXRmaWVsZCA9IHsgdHJ1bmNhdGVkOiB0cnVlLCBzdGFydDogYi5zdGFydCwgYXBwZW5kczogMCB9CiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIC8vIGp1c3QgY2xlYXJpbmcgYmF0Y2ggZGF0YQogICAgICBwLmFwcGVuZHMgPSBiLnN0YXJ0IC0gcC5zdGFydAoKICAgICAgLy8gd2UgY2xlYXJlZCB0aGUgY3VycmVudCBiYXRjaAogICAgICBpZiAocC5hcHBlbmRzID09PSAwKSB0aGlzLl9wZW5kaW5nQml0ZmllbGQgPSBudWxsCgogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAocCA9PT0gbnVsbCkgewogICAgICB0aGlzLl9wZW5kaW5nQml0ZmllbGQgPSB7IHRydW5jYXRlZDogZmFsc2UsIHN0YXJ0OiBiLnN0YXJ0LCBhcHBlbmRzOiBiLmxlbmd0aCB9CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChiLnN0YXJ0ICE9PSBwLnN0YXJ0ICsgcC5hcHBlbmRzKSB7CiAgICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdBdG9taWMgb3BlcmF0aW9ucyBtdXN0IGJlIGNvbnRpZ3VvdXMnLCB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIHAuYXBwZW5kcyArPSBiLmxlbmd0aAogIH0KCiAgYXN5bmMgY2F0Y2h1cChsZW5ndGgpIHsKICAgIGFzc2VydCghdGhpcy5pc0RlZmF1bHQoKSwgJ0Nhbm5vdCBjYXRjaHVwIHNpZ25lZCBzdGF0ZScpIC8vIFRPRE86IG1ha2UgdGhpcyBjaGVjayBiZXR0ZXIKCiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IG9yaWdMZW5ndGggPSB0aGlzLmxlbmd0aAoKICAgICAgbGV0IHNoYXJlZExlbmd0aCA9IDAKICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc3RvcmFnZS5kZXBlbmRlbmNpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBjb25zdCBkZXAgPSB0aGlzLnN0b3JhZ2UuZGVwZW5kZW5jaWVzW2ldCiAgICAgICAgaWYgKGRlcC5kYXRhUG9pbnRlciA9PT0gdGhpcy5jb3JlLnN0YXRlLnN0b3JhZ2UuY29yZS5kYXRhUG9pbnRlcikgewogICAgICAgICAgc2hhcmVkTGVuZ3RoID0gZGVwLmxlbmd0aAogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IHR4ID0gdGhpcy5jcmVhdGVXcml0ZUJhdGNoKCkKICAgICAgY29uc3QgcnggPSB0aGlzLmNvcmUuc3RhdGUuc3RvcmFnZS5yZWFkKCkKICAgICAgY29uc3Qgcm9vdFByb21pc2VzID0gW10KCiAgICAgIGZvciAoY29uc3Qgcm9vdCBvZiBmbGF0LmZ1bGxSb290cyhsZW5ndGggKiAyKSkgewogICAgICAgIHJvb3RQcm9taXNlcy5wdXNoKHJ4LmdldFRyZWVOb2RlKHJvb3QpKQogICAgICB9CgogICAgICByeC50cnlGbHVzaCgpCgogICAgICBjb25zdCByb290cyA9IGF3YWl0IFByb21pc2UuYWxsKHJvb3RQcm9taXNlcykKICAgICAgY29uc3QgdHJ1bmNhdGluZyA9IHNoYXJlZExlbmd0aCA8IG9yaWdMZW5ndGgKCiAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiByb290cykgewogICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTigKICAgICAgICAgICAgJ0ludmFsaWQgY2F0Y2h1cCBsZW5ndGgsIHRyZWUgbm9kZXMgbm90IGF2YWlsYWJsZScsCiAgICAgICAgICAgIHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkKICAgICAgICAgICkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IGZvcmsgPSB0cnVuY2F0aW5nID8gdGhpcy5mb3JrICsgMSA6IHRoaXMuZm9yawoKICAgICAgLy8gb3ZlcndyaXRlIGl0IGF0bSwgVE9ETzoga2VlcCB3aGF0IHdlIGNhbiBjb25uZWN0IHRvIHRoZSB0cmVlCiAgICAgIHR4LmRlbGV0ZUJsb2NrUmFuZ2UoMCwgLTEpCiAgICAgIHR4LmRlbGV0ZVRyZWVOb2RlUmFuZ2UoMCwgLTEpCiAgICAgIHR4LmRlbGV0ZUJpdGZpZWxkUGFnZVJhbmdlKDAsIC0xKQoKICAgICAgY29uc3QgdHJlZSA9IHsKICAgICAgICBmb3JrLAogICAgICAgIGxlbmd0aCwKICAgICAgICByb290SGFzaDogY3J5cHRvLnRyZWUocm9vdHMpLAogICAgICAgIHNpZ25hdHVyZTogbnVsbAogICAgICB9CgogICAgICB0eC5zZXRIZWFkKHRyZWUpCgogICAgICAvLyBwcm9wIGEgYmV0dGVyIHdheSB0byBkbyB0aGlzCiAgICAgIGNvbnN0IGRlcCA9IHVwZGF0ZURlcGVuZGVuY3kodGhpcywgc2hhcmVkTGVuZ3RoLCB0cnVlKQogICAgICBkZXAubGVuZ3RoID0gbGVuZ3RoCgogICAgICB0eC5zZXREZXBlbmRlbmN5KGRlcCkKCiAgICAgIGNvbnN0IGZsdXNoZWQgPSBhd2FpdCB0aGlzLmZsdXNoKCkKCiAgICAgIHRoaXMuc3RvcmFnZS5zZXREZXBlbmRlbmN5SGVhZChkZXApCgogICAgICB0aGlzLmZvcmsgPSB0cmVlLmZvcmsKICAgICAgdGhpcy5yb290cyA9IHJvb3RzCiAgICAgIHRoaXMubGVuZ3RoID0gdHJlZS5sZW5ndGgKICAgICAgdGhpcy5ieXRlTGVuZ3RoID0gTWVya2xlVHJlZS5zaXplKHJvb3RzKQoKICAgICAgaWYgKHRydW5jYXRpbmcpIHRoaXMub250cnVuY2F0ZSh0cmVlLCBzaGFyZWRMZW5ndGgsIG9yaWdMZW5ndGgsIGZsdXNoZWQpCiAgICAgIGlmIChzaGFyZWRMZW5ndGggPCBsZW5ndGgpIHRoaXMub25hcHBlbmQodHJlZSwgbnVsbCwgZmx1c2hlZCkKCiAgICAgIGlmICh0aGlzLmNvcmUuaGludHNDaGFuZ2VkICYmIHRoaXMuaXNEZWZhdWx0KCkpIGF3YWl0IHRoaXMuY29yZS5mbHVzaEhpbnRzKCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMubXV0ZXgudW5sb2NrKCkKICAgIH0KICB9CgogIGFzeW5jIF9vdmVyd3JpdGUoc291cmNlLCBmb3JrLCBsZW5ndGgsIHRyZWVMZW5ndGgsIHNpZ25hdHVyZSkgewogICAgY29uc3QgYmxvY2tQcm9taXNlcyA9IFtdCiAgICBjb25zdCB0cmVlUHJvbWlzZXMgPSBbXQogICAgY29uc3Qgcm9vdFByb21pc2VzID0gW10KCiAgICBjb25zdCByeCA9IHNvdXJjZS5zdG9yYWdlLnJlYWQoKQoKICAgIGZvciAoY29uc3Qgcm9vdCBvZiBmbGF0LmZ1bGxSb290cyhsZW5ndGggKiAyKSkgewogICAgICByb290UHJvbWlzZXMucHVzaChyeC5nZXRUcmVlTm9kZShyb290KSkKICAgIH0KCiAgICBmb3IgKGNvbnN0IGluZGV4IG9mIGZsYXQucGF0Y2godHJlZUxlbmd0aCAqIDIsIGxlbmd0aCAqIDIpKSB7CiAgICAgIHRyZWVQcm9taXNlcy5wdXNoKHJ4LmdldFRyZWVOb2RlKGluZGV4KSkKICAgIH0KCiAgICBmb3IgKGxldCBpID0gdHJlZUxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHRyZWVQcm9taXNlcy5wdXNoKHJ4LmdldFRyZWVOb2RlKGkgKiAyKSkKICAgICAgdHJlZVByb21pc2VzLnB1c2gocnguZ2V0VHJlZU5vZGUoaSAqIDIgKyAxKSkKICAgICAgYmxvY2tQcm9taXNlcy5wdXNoKHJ4LmdldEJsb2NrKGkpKQogICAgfQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBibG9ja3MgPSBhd2FpdCBQcm9taXNlLmFsbChibG9ja1Byb21pc2VzKQogICAgY29uc3Qgbm9kZXMgPSBhd2FpdCBQcm9taXNlLmFsbCh0cmVlUHJvbWlzZXMpCiAgICBjb25zdCByb290cyA9IGF3YWl0IFByb21pc2UuYWxsKHJvb3RQcm9taXNlcykKCiAgICBpZiAodGhpcy5jb3JlLmRlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdDb3JlIGRlc3Ryb3llZCcpCgogICAgaWYgKHNpZ25hdHVyZSkgewogICAgICBjb25zdCBiYXRjaCA9IHRoaXMuY3JlYXRlVHJlZUJhdGNoKCkKICAgICAgYmF0Y2gucm9vdHMgPSByb290cwogICAgICBiYXRjaC5sZW5ndGggPSBsZW5ndGgKCiAgICAgIGlmICghdGhpcy5jb3JlLnZlcmlmaWVyLnZlcmlmeShiYXRjaCwgc2lnbmF0dXJlKSkgewogICAgICAgIHRocm93IElOVkFMSURfU0lHTkFUVVJFKAogICAgICAgICAgJ1NpZ25hdHVyZSBpcyBub3QgdmFsaWQgb3ZlciBjb21taXR0ZWQgdHJlZScsCiAgICAgICAgICB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5CiAgICAgICAgKQogICAgICB9CiAgICB9CgogICAgY29uc3QgdHggPSB0aGlzLmNyZWF0ZVdyaXRlQmF0Y2goKQoKICAgIC8vIHRydW5jYXRlIGV4aXN0aW5nIHRyZWUKICAgIGlmICh0cmVlTGVuZ3RoIDwgdGhpcy5sZW5ndGgpIHsKICAgICAgdHguZGVsZXRlQmxvY2tSYW5nZSh0cmVlTGVuZ3RoLCB0aGlzLmxlbmd0aCkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHJvb3Qgb2Ygcm9vdHMpIHR4LnB1dFRyZWVOb2RlKHJvb3QpCgogICAgLy8gbm8gbm9kZXMgd2lsbCBiZSBjb3BpZWQgaW4gc2hhbGxvdyBtb2RlCiAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIHsKICAgICAgaWYgKG5vZGUgIT09IG51bGwpIHR4LnB1dFRyZWVOb2RlKG5vZGUpCiAgICB9CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBibG9ja3MubGVuZ3RoOyBpKyspIHsKICAgICAgYXNzZXJ0KGJsb2Nrc1tpXSAhPT0gbnVsbCwgJ2hhcyBibG9jaycpCiAgICAgIHR4LnB1dEJsb2NrKGkgKyB0cmVlTGVuZ3RoLCBibG9ja3NbaV0pCiAgICB9CgogICAgY29uc3QgdG90YWxMZW5ndGggPSBNYXRoLm1heChsZW5ndGgsIHRoaXMubGVuZ3RoKQoKICAgIGlmICh0b3RhbExlbmd0aCA+IHRyZWVMZW5ndGgpIHsKICAgICAgY29uc3QgZmlyc3RQYWdlID0gZ2V0Qml0ZmllbGRQYWdlKHRyZWVMZW5ndGgpCiAgICAgIGNvbnN0IGxhc3RQYWdlID0gZ2V0Qml0ZmllbGRQYWdlKHRvdGFsTGVuZ3RoIC0gMSkKCiAgICAgIGNvbnN0IHNyeCA9IHRoaXMuc3RvcmFnZS5yZWFkKCkKICAgICAgY29uc3QgYml0ZmllbGRQYWdlUHJvbWlzZSA9IHNyeC5nZXRCaXRmaWVsZFBhZ2UoZmlyc3RQYWdlKQogICAgICBzcngudHJ5Rmx1c2goKQoKICAgICAgY29uc3QgYml0ZmllbGRQYWdlID0gYXdhaXQgYml0ZmllbGRQYWdlUHJvbWlzZQoKICAgICAgbGV0IGluZGV4ID0gdHJlZUxlbmd0aAoKICAgICAgZm9yIChsZXQgaSA9IGZpcnN0UGFnZTsgaSA8PSBsYXN0UGFnZTsgaSsrKSB7CiAgICAgICAgY29uc3QgcGFnZSA9IGI0YS5hbGxvYyhCaXRmaWVsZC5CWVRFU19QRVJfUEFHRSkKICAgICAgICB0eC5wdXRCaXRmaWVsZFBhZ2UoaSwgcGFnZSkKCiAgICAgICAgLy8gY29weSBleGlzdGluZyBiaXRzIGluCiAgICAgICAgaWYgKGkgPT09IGZpcnN0UGFnZSAmJiBiaXRmaWVsZFBhZ2UpIHBhZ2Uuc2V0KGJpdGZpZWxkUGFnZSkKCiAgICAgICAgaWYgKGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpbmRleCA9IGZpbGxCaXRmaWVsZFBhZ2UocGFnZSwgaW5kZXgsIGxlbmd0aCwgaSwgdHJ1ZSkKICAgICAgICAgIGlmIChpbmRleCA8IGxlbmd0aCkgY29udGludWUKICAgICAgICB9CgogICAgICAgIGlmIChpbmRleCA8IHRoaXMubGVuZ3RoKSB7CiAgICAgICAgICBpbmRleCA9IGZpbGxCaXRmaWVsZFBhZ2UocGFnZSwgaW5kZXgsIHRoaXMubGVuZ3RoLCBpLCBmYWxzZSkKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBjb25zdCB0cmVlID0gewogICAgICBmb3JrLAogICAgICBsZW5ndGgsCiAgICAgIHJvb3RIYXNoOiBjcnlwdG8udHJlZShyb290cyksCiAgICAgIHNpZ25hdHVyZQogICAgfQoKICAgIGNvbnN0IHVwZ3JhZGVkID0gdHJlZUxlbmd0aCA8IHRoaXMubGVuZ3RoIHx8IHRoaXMubGVuZ3RoIDwgbGVuZ3RoIHx8IHRyZWUuZm9yayAhPT0gdGhpcy5mb3JrCgogICAgaWYgKHVwZ3JhZGVkKSB0eC5zZXRIZWFkKHRyZWUpCgogICAgY29uc3QgZmx1c2hlZCA9IGF3YWl0IHRoaXMuZmx1c2goKQoKICAgIHRoaXMuZm9yayA9IHRyZWUuZm9yawogICAgdGhpcy5yb290cyA9IHJvb3RzCiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aAogICAgdGhpcy5ieXRlTGVuZ3RoID0gTWVya2xlVHJlZS5zaXplKHJvb3RzKQogICAgdGhpcy5zaWduYXR1cmUgPSBzaWduYXR1cmUKCiAgICByZXR1cm4geyB0cmVlLCBmbHVzaGVkIH0KICB9CgogIGFzeW5jIGNvbW1pdChzdGF0ZSwgeyBzaWduYXR1cmUsIGtleVBhaXIsIGxlbmd0aCA9IHN0YXRlLmxlbmd0aCwgdHJlZUxlbmd0aCA9IC0xIH0gPSB7fSkgewogICAgYXNzZXJ0KAogICAgICB0aGlzLmlzRGVmYXVsdCgpIHx8ICh0aGlzLnBhcmVudCAmJiB0aGlzLnBhcmVudC5pc0RlZmF1bHQoKSksCiAgICAgICdDYW4gb25seSBjb21taXQgaW50byBkZWZhdWx0IHN0YXRlJwogICAgKQoKICAgIGxldCBzcmNMb2NrZWQgPSBmYWxzZQogICAgYXdhaXQgdGhpcy5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBhd2FpdCBzdGF0ZS5tdXRleC5sb2NrKCkKICAgICAgc3JjTG9ja2VkID0gdHJ1ZQoKICAgICAgaWYgKHRyZWVMZW5ndGggPT09IC0xKSB0cmVlTGVuZ3RoID0gc3RhdGUuZmx1c2hlZExlbmd0aCgpCgogICAgICBpZiAoIShhd2FpdCB0aGlzLmNvcmUuX3ZhbGlkYXRlQ29tbWl0KHN0YXRlLCB0cmVlTGVuZ3RoKSkpIHJldHVybiBudWxsCiAgICAgIGlmICh0aGlzLmxlbmd0aCA+IGxlbmd0aCkgcmV0dXJuIG51bGwKCiAgICAgIGlmICh0aGlzLmxlbmd0aCA8IGxlbmd0aCAmJiAhc2lnbmF0dXJlKSB7CiAgICAgICAgaWYgKCFrZXlQYWlyKSBrZXlQYWlyID0gdGhpcy5jb3JlLmhlYWRlci5rZXlQYWlyCiAgICAgICAgY29uc3QgYmF0Y2ggPSBzdGF0ZS5jcmVhdGVUcmVlQmF0Y2goKQogICAgICAgIGlmIChsZW5ndGggIT09IGJhdGNoLmxlbmd0aCkgYXdhaXQgYmF0Y2gucmVzdG9yZShsZW5ndGgpCiAgICAgICAgc2lnbmF0dXJlID0gdGhpcy5jb3JlLnZlcmlmaWVyLnNpZ24oYmF0Y2gsIGtleVBhaXIpCiAgICAgIH0KCiAgICAgIGNvbnN0IHsgdHJlZSwgZmx1c2hlZCB9ID0gYXdhaXQgdGhpcy5fb3ZlcndyaXRlKAogICAgICAgIHN0YXRlLAogICAgICAgIHRoaXMuZm9yaywKICAgICAgICBsZW5ndGgsCiAgICAgICAgdHJlZUxlbmd0aCwKICAgICAgICBzaWduYXR1cmUKICAgICAgKQoKICAgICAgLy8gZ2MgYmxvY2tzIGZyb20gc291cmNlCiAgICAgIGlmICh0cmVlTGVuZ3RoIDwgbGVuZ3RoKSB7CiAgICAgICAgY29uc3QgdHggPSBzdGF0ZS5jcmVhdGVXcml0ZUJhdGNoKCkKCiAgICAgICAgdHguZGVsZXRlQmxvY2tSYW5nZSh0cmVlTGVuZ3RoLCBsZW5ndGgpCiAgICAgICAgY29uc3QgZGVwZW5kZW5jeSA9IHN0YXRlLnVwZGF0ZURlcGVuZGVuY3kodHgsIGxlbmd0aCkKCiAgICAgICAgYXdhaXQgc3RhdGUuZmx1c2godHgpCgogICAgICAgIGlmIChkZXBlbmRlbmN5KSBzdGF0ZS5zdG9yYWdlLnNldERlcGVuZGVuY3lIZWFkKGRlcGVuZGVuY3kpCiAgICAgIH0KCiAgICAgIGNvbnN0IGJpdGZpZWxkID0geyBzdGFydDogdHJlZUxlbmd0aCwgbGVuZ3RoOiBsZW5ndGggLSB0cmVlTGVuZ3RoLCBkcm9wOiBmYWxzZSB9CiAgICAgIHRoaXMub25hcHBlbmQodHJlZSwgYml0ZmllbGQsIGZsdXNoZWQpCgogICAgICByZXR1cm4gewogICAgICAgIGxlbmd0aDogdGhpcy5sZW5ndGgsCiAgICAgICAgYnl0ZUxlbmd0aDogdGhpcy5ieXRlTGVuZ3RoCiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMudXBkYXRpbmcgPSBmYWxzZQogICAgICB0aGlzLm11dGV4LnVubG9jaygpCgogICAgICBpZiAoc3JjTG9ja2VkKSB7CiAgICAgICAgc3RhdGUubXV0ZXgudW5sb2NrKCkKICAgICAgICBzdGF0ZS5fY2xlYXJBY3RpdmVCYXRjaCgpCiAgICAgIH0KCiAgICAgIHRoaXMuY29yZS5jaGVja0lmSWRsZSgpCiAgICB9CiAgfQoKICBhc3luYyBfZ2V0VHJlZUhlYWRBdChsZW5ndGgpIHsKICAgIGlmIChsZW5ndGggPT09IG51bGwpIHJldHVybiB0aGlzLnRyZWVJbmZvKCkKCiAgICBjb25zdCBoZWFkID0gZ2V0RGVmYXVsdFRyZWUoKQoKICAgIGhlYWQubGVuZ3RoID0gbGVuZ3RoCgogICAgY29uc3Qgcm9vdHMgPSBhd2FpdCBNZXJrbGVUcmVlLmdldFJvb3RzRnJvbVN0b3JhZ2UodGhpcy5zdG9yYWdlLCBsZW5ndGgpCiAgICBjb25zdCByb290SGFzaCA9IGNyeXB0by50cmVlKHJvb3RzKQoKICAgIGhlYWQuZm9yayA9IHRoaXMuZm9yawogICAgaGVhZC5yb290SGFzaCA9IHJvb3RIYXNoCgogICAgaWYgKGxlbmd0aCA9PT0gdGhpcy5sZW5ndGgpIGhlYWQuc2lnbmF0dXJlID0gdGhpcy5zaWduYXR1cmUKCiAgICByZXR1cm4gaGVhZAogIH0KCiAgX21vdmVUb0NvcmUoY29yZSwgdHJ1bmNhdGVkLCBhcHBlbmRlZCkgewogICAgY29uc3QgaGVhZCA9IHRoaXMuY29yZS5zZXNzaW9uU3RhdGVzLnBvcCgpCiAgICBpZiAoaGVhZCAhPT0gdGhpcykgdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXNbKGhlYWQuaW5kZXggPSB0aGlzLmluZGV4KV0gPSBoZWFkCgogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy5pbmRleCA9IHRoaXMuY29yZS5zZXNzaW9uU3RhdGVzLnB1c2godGhpcykgLSAxCgogICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgcyA9IHRoaXMuc2Vzc2lvbnNbaV0KICAgICAgY29uc3QgbWFuaWZlc3QgPSBzLm1hbmlmZXN0CiAgICAgIHMudHJhbnNmZXJTZXNzaW9uKHRoaXMuY29yZSkKICAgICAgaWYgKCFtYW5pZmVzdCAmJiBzLm1hbmlmZXN0KSBzLmVtaXQoJ21hbmlmZXN0JykKICAgICAgaWYgKHRydW5jYXRlZCkgcy5lbWl0KCd0cnVuY2F0ZScsIHRydW5jYXRlZC50bywgdHJ1bmNhdGVkLmZvcmspCiAgICAgIGlmIChhcHBlbmRlZCkgcy5lbWl0KCdhcHBlbmQnKQogICAgfQogIH0KCiAgYXN5bmMgbW92ZVRvKGNvcmUsIGxlbmd0aCkgewogICAgY29uc3Qgc3RhdGUgPSBjb3JlLnN0YXRlCgogICAgYXdhaXQgdGhpcy5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICAvLyBpZiAoc3RhdGUuc3RvcmFnZSAmJiAoYXdhaXQgc3RhdGUuc3RvcmFnZS5yZXN1bWVTZXNzaW9uKHRoaXMubmFtZSkpICE9PSBudWxsKSB7CiAgICAgIC8vICAgdGhyb3cgU1RPUkFHRV9DT05GTElDVCgnQmF0Y2ggaGFzIGFscmVhZHkgYmVlbiBjcmVhdGVkJykKICAgICAgLy8gfQoKICAgICAgY29uc3QgdHJlZUxlbmd0aCA9IHRoaXMubGVuZ3RoCgogICAgICBsZXQgdHJ1bmNhdGVkID0gbnVsbAogICAgICBsZXQgYXBwZW5kZWQgPSBmYWxzZQoKICAgICAgaWYgKCF0aGlzLmlzU25hcHNob3QoKSkgewogICAgICAgIGlmICh0aGlzLmxpbmdlcnMgPT09IG51bGwpIHRoaXMubGluZ2VycyA9IFtdCiAgICAgICAgdGhpcy5saW5nZXJzLnB1c2godGhpcy5zdG9yYWdlKQoKICAgICAgICBjb25zdCByZXN1bWVkID0gYXdhaXQgc3RhdGUuc3RvcmFnZS5yZXN1bWVTZXNzaW9uKHRoaXMubmFtZSkKCiAgICAgICAgY29uc3QgdHJ1bmNhdGlvbiA9IGxlbmd0aCA8IHRoaXMubGVuZ3RoID8gYXdhaXQgdHJ1bmNhdGVBbmRGbHVzaCh0aGlzLCBsZW5ndGgpIDogbnVsbAogICAgICAgIGNvbnN0IHRyZWVJbmZvID0gdHJ1bmNhdGlvbgogICAgICAgICAgPyB0cnVuY2F0aW9uLnRyZWUKICAgICAgICAgIDogcmVzdW1lZAogICAgICAgICAgICA/IG51bGwKICAgICAgICAgICAgOiBhd2FpdCBzdGF0ZS5fZ2V0VHJlZUhlYWRBdCh0aGlzLmxlbmd0aCkKCiAgICAgICAgY29uc3QgZm9yayA9IHRydW5jYXRpb24gPyB0aGlzLmZvcmsgKyAxIDogdGhpcy5mb3JrCgogICAgICAgIC8vIHRvZG86IHZhbGlkYXRlIHRyZWVJbmZvCgogICAgICAgIGxldCBzdG9yYWdlID0gbnVsbAoKICAgICAgICBpZiAocmVzdW1lZCkgewogICAgICAgICAgc3RvcmFnZSA9IHJlc3VtZWQKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdHJlZUluZm8uZm9yayA9IGZvcmsKICAgICAgICAgIHN0b3JhZ2UgPSBhd2FpdCBzdGF0ZS5zdG9yYWdlLmNyZWF0ZVNlc3Npb24odGhpcy5uYW1lLCB0cmVlSW5mbykKICAgICAgICB9CgogICAgICAgIGNvbnN0IHJvb3RzID0gYXdhaXQgTWVya2xlVHJlZS5nZXRSb290c0Zyb21TdG9yYWdlKHN0b3JhZ2UsIGxlbmd0aCkKCiAgICAgICAgdGhpcy5zdG9yYWdlID0gc3RvcmFnZQogICAgICAgIHRoaXMucHJvbG9ndWUgPSBzdGF0ZS5wcm9sb2d1ZQogICAgICAgIHRoaXMuZm9yayA9IGZvcmsKICAgICAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aAogICAgICAgIHRoaXMuYnl0ZUxlbmd0aCA9IE1lcmtsZVRyZWUuc2l6ZShyb290cykKICAgICAgICB0aGlzLnJvb3RzID0gcm9vdHMKCiAgICAgICAgaWYgKHRydW5jYXRpb24pIHsKICAgICAgICAgIGNvbnN0IHsgZGVwZW5kZW5jeSB9ID0gdHJ1bmNhdGlvbgoKICAgICAgICAgIGlmIChkZXBlbmRlbmN5KSB0aGlzLnN0b3JhZ2Uuc2V0RGVwZW5kZW5jeUhlYWQoZGVwZW5kZW5jeSkKICAgICAgICAgIHRydW5jYXRlZCA9IHsgdG86IHRyZWVMZW5ndGgsIGZvcmsgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMubGVuZ3RoID4gdHJlZUxlbmd0aCkgewogICAgICAgICAgYXBwZW5kZWQgPSB0cnVlCiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKGxldCBpID0gdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuY29yZS5zZXNzaW9uU3RhdGVzW2ldCiAgICAgICAgaWYgKHN0YXRlID09PSB0aGlzKSBjb250aW51ZQogICAgICAgIGlmIChzdGF0ZS5uYW1lID09PSB0aGlzLm5hbWUpIHN0YXRlLl9tb3ZlVG9Db3JlKGNvcmUuY29yZSkKICAgICAgfQoKICAgICAgdGhpcy5fbW92ZVRvQ29yZShjb3JlLmNvcmUsIHRydW5jYXRlZCwgYXBwZW5kZWQpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLm11dGV4LnVubG9jaygpCiAgICB9CiAgfQoKICBhc3luYyBjcmVhdGVTZXNzaW9uKG5hbWUsIG92ZXJ3cml0ZSwgYXRvbSkgewogICAgbGV0IHN0b3JhZ2UgPSBudWxsCiAgICBsZXQgdHJlZUluZm8gPSBudWxsCgogICAgaWYgKCFhdG9tICYmICFvdmVyd3JpdGUgJiYgdGhpcy5zdG9yYWdlKSB7CiAgICAgIHN0b3JhZ2UgPSBhd2FpdCB0aGlzLnN0b3JhZ2UucmVzdW1lU2Vzc2lvbihuYW1lKQoKICAgICAgaWYgKHN0b3JhZ2UgIT09IG51bGwpIHRyZWVJbmZvID0gKGF3YWl0IGdldENvcmVIZWFkKHN0b3JhZ2UpKSB8fCBnZXREZWZhdWx0VHJlZSgpCiAgICB9CgogICAgY29uc3QgbGVuZ3RoID0gdHJlZUluZm8gPyB0cmVlSW5mby5sZW5ndGggOiB0aGlzLmxlbmd0aAoKICAgIGlmIChzdG9yYWdlID09PSBudWxsKSB7CiAgICAgIHRyZWVJbmZvID0gYXdhaXQgdGhpcy5fZ2V0VHJlZUhlYWRBdChsZW5ndGgpCgogICAgICBpZiAoYXRvbSkgewogICAgICAgIHN0b3JhZ2UgPSBhd2FpdCB0aGlzLnN0b3JhZ2UuY3JlYXRlQXRvbWljU2Vzc2lvbihhdG9tLCB0cmVlSW5mbykKICAgICAgfSBlbHNlIHsKICAgICAgICBzdG9yYWdlID0gYXdhaXQgdGhpcy5zdG9yYWdlLmNyZWF0ZVNlc3Npb24obmFtZSwgdHJlZUluZm8pCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5hdG9taXplZCAmJiBhdG9tKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignU2Vzc2lvbiBhbHJlYWR5IGF0b21pemVkJykKICAgIH0KCiAgICBjb25zdCBoZWFkID0gewogICAgICBmb3JrOiB0aGlzLmZvcmssCiAgICAgIHJvb3RzOgogICAgICAgIGxlbmd0aCA9PT0gdGhpcy5sZW5ndGgKICAgICAgICAgID8gdGhpcy5yb290cy5zbGljZSgpCiAgICAgICAgICA6IGF3YWl0IE1lcmtsZVRyZWUuZ2V0Um9vdHNGcm9tU3RvcmFnZShzdG9yYWdlLCBsZW5ndGgpLAogICAgICBsZW5ndGgsCiAgICAgIHByb2xvZ3VlOiB0aGlzLnByb2xvZ3VlLAogICAgICBzaWduYXR1cmU6IGxlbmd0aCA9PT0gdGhpcy5sZW5ndGggPyB0aGlzLnNpZ25hdHVyZSA6IG51bGwKICAgIH0KCiAgICBjb25zdCBzdGF0ZSA9IG5ldyBTZXNzaW9uU3RhdGUoCiAgICAgIHRoaXMuY29yZSwKICAgICAgYXRvbSA/IHRoaXMgOiBudWxsLAogICAgICBzdG9yYWdlLAogICAgICBoZWFkLAogICAgICBhdG9tID8gdGhpcy5uYW1lIDogbmFtZQogICAgKQoKICAgIGlmIChhdG9tKSB7CiAgICAgIHRoaXMuYXRvbWl6ZWQgPSBhdG9tCiAgICAgIGF0b20ub25mbHVzaChzdGF0ZS5fY29tbWl0LmJpbmQoc3RhdGUpKQogICAgfQoKICAgIHJldHVybiBzdGF0ZQogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CgpmdW5jdGlvbiBnZXRCaXRmaWVsZFBhZ2UoaW5kZXgpIHsKICByZXR1cm4gTWF0aC5mbG9vcihpbmRleCAvIEJpdGZpZWxkLkJJVFNfUEVSX1BBR0UpCn0KCmZ1bmN0aW9uIGZpbGxCaXRmaWVsZFBhZ2UocGFnZSwgc3RhcnQsIGVuZCwgcGFnZUluZGV4LCB2YWx1ZSkgewogIGNvbnN0IG9mZnNldCA9IHBhZ2VJbmRleCAqIEJpdGZpZWxkLkJJVFNfUEVSX1BBR0UKICBjb25zdCBtYXggPSBvZmZzZXQgKyBCaXRmaWVsZC5CSVRTX1BFUl9QQUdFCgogIGNvbnN0IGluZGV4ID0gbWF4IDwgZW5kID8gbWF4IDogZW5kCgogIGNvbnN0IGZyb20gPSBzdGFydCAtIG9mZnNldAogIGNvbnN0IHRvID0gaW5kZXggLSBvZmZzZXQKCiAgcXVpY2tiaXQuZmlsbChwYWdlLCB2YWx1ZSwgZnJvbSwgdG8pCgogIHJldHVybiBpbmRleAp9Cgphc3luYyBmdW5jdGlvbiBzdG9yZUJpdGZpZWxkUmFuZ2Uoc3RvcmFnZSwgdHgsIGZyb20sIHRvLCB2YWx1ZSkgewogIGlmIChmcm9tID49IHRvKSByZXR1cm4KCiAgY29uc3QgZmlyc3RQYWdlID0gZ2V0Qml0ZmllbGRQYWdlKGZyb20pCiAgY29uc3QgbGFzdFBhZ2UgPSBnZXRCaXRmaWVsZFBhZ2UodG8gLSAxKQoKICBsZXQgaW5kZXggPSBmcm9tCgogIGNvbnN0IHJ4ID0gc3RvcmFnZS5yZWFkKCkKCiAgY29uc3QgcHJvbWlzZXMgPSBbXQogIGZvciAobGV0IGkgPSBmaXJzdFBhZ2U7IGkgPD0gbGFzdFBhZ2U7IGkrKykgewogICAgcHJvbWlzZXMucHVzaChyeC5nZXRCaXRmaWVsZFBhZ2UoaSkpCiAgfQoKICByeC50cnlGbHVzaCgpCgogIGNvbnN0IHBhZ2VzID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpCiAgY29uc3QgY250ID0gbGFzdFBhZ2UgLSBmaXJzdFBhZ2UgKyAxCgogIGZvciAobGV0IGkgPSAwOyBpIDwgY250OyBpKyspIHsKICAgIGNvbnN0IHBhZ2VJbmRleCA9IGkgKyBmaXJzdFBhZ2UKICAgIGlmICghcGFnZXNbaV0pIHBhZ2VzW2ldID0gYjRhLmFsbG9jKEJpdGZpZWxkLkJZVEVTX1BFUl9QQUdFKQoKICAgIGluZGV4ID0gZmlsbEJpdGZpZWxkUGFnZShwYWdlc1tpXSwgaW5kZXgsIHRvLCBwYWdlSW5kZXgsIHZhbHVlKQogICAgdHgucHV0Qml0ZmllbGRQYWdlKHBhZ2VJbmRleCwgcGFnZXNbaV0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiB0cnVuY2F0ZUFuZEZsdXNoKHMsIGxlbmd0aCkgewogIGNvbnN0IGJhdGNoID0gcy5jcmVhdGVUcmVlQmF0Y2goKQogIGF3YWl0IE1lcmtsZVRyZWUudHJ1bmNhdGUocywgbGVuZ3RoLCBiYXRjaCwgcy5mb3JrKQogIGNvbnN0IHR4ID0gcy5jcmVhdGVXcml0ZUJhdGNoKCkKCiAgY29uc3QgaW5mbyA9IGF3YWl0IHMuX3RydW5jYXRlKHR4LCBiYXRjaCkKICBjb25zdCBmbHVzaGVkID0gYXdhaXQgcy5mbHVzaCgpCgogIHJldHVybiB7CiAgICB0cmVlOiBpbmZvLnRyZWUsCiAgICByb290czogaW5mby5yb290cywKICAgIGRlcGVuZGVuY3k6IGluZm8uZGVwZW5kZW5jeSwKICAgIGZsdXNoZWQKICB9Cn0KCmZ1bmN0aW9uIHVwZGF0ZURlcGVuZGVuY3koc3RhdGUsIGxlbmd0aCwgdHJ1bmNhdGVkKSB7CiAgY29uc3QgaSA9IHN0YXRlLnN0b3JhZ2UuZmluZERlcGVuZGVuY3lJbmRleChsZW5ndGgsIHRydW5jYXRlZCkKICBpZiAoaSA9PT0gLTEpIHJldHVybiBudWxsIC8vIHNraXAgZGVmYXVsdCBzdGF0ZSBhbmQgb3ZlcmxheXMgb2YgZGVmYXVsdAoKICByZXR1cm4gewogICAgZGF0YVBvaW50ZXI6IHN0YXRlLnN0b3JhZ2UuZGVwZW5kZW5jaWVzW2ldLmRhdGFQb2ludGVyLAogICAgbGVuZ3RoCiAgfQp9CgpmdW5jdGlvbiBnZXREZWZhdWx0VHJlZSgpIHsKICByZXR1cm4gewogICAgZm9yazogMCwKICAgIGxlbmd0aDogMCwKICAgIHJvb3RIYXNoOiBudWxsLAogICAgc2lnbmF0dXJlOiBudWxsCiAgfQp9CgpmdW5jdGlvbiBnZXRDb3JlSGVhZChzdG9yYWdlKSB7CiAgY29uc3QgYiA9IHN0b3JhZ2UucmVhZCgpCiAgY29uc3QgcCA9IGIuZ2V0SGVhZCgpCiAgYi50cnlGbHVzaCgpCiAgcmV0dXJuIHAKfQoKZnVuY3Rpb24gaXNSb290SW5kZXgoaW5kZXgsIHJvb3RzKSB7CiAgZm9yIChjb25zdCBub2RlIG9mIHJvb3RzKSB7CiAgICBpZiAobm9kZS5pbmRleCA9PT0gaW5kZXgpIHJldHVybiB0cnVlCiAgfQoKICByZXR1cm4gZmFsc2UKfQpjb25zdCB7IFdyaXRhYmxlLCBSZWFkYWJsZSB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCgpjbGFzcyBSZWFkU3RyZWFtIGV4dGVuZHMgUmVhZGFibGUgewogIGNvbnN0cnVjdG9yKGNvcmUsIG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMuc3RhcnQgPSBvcHRzLnN0YXJ0IHx8IDAKICAgIHRoaXMuZW5kID0gdHlwZW9mIG9wdHMuZW5kID09PSAnbnVtYmVyJyA/IG9wdHMuZW5kIDogLTEKICAgIHRoaXMuc25hcHNob3QgPSAhb3B0cy5saXZlICYmIG9wdHMuc25hcHNob3QgIT09IGZhbHNlCiAgICB0aGlzLmxpdmUgPSB0aGlzLmVuZCA9PT0gLTEgPyAhIW9wdHMubGl2ZSA6IGZhbHNlCiAgICB0aGlzLndhaXQgPSB0eXBlb2Ygb3B0cy53YWl0ID09PSAnYm9vbGVhbicgPyBvcHRzLndhaXQgOiB0aGlzLmNvcmUud2FpdAogICAgdGhpcy50aW1lb3V0ID0gb3B0cy50aW1lb3V0IHx8IGNvcmUudGltZW91dAogIH0KCiAgX29wZW4oY2IpIHsKICAgIHRoaXMuX29wZW5QKCkudGhlbihjYiwgY2IpCiAgfQoKICBfcmVhZChjYikgewogICAgdGhpcy5fcmVhZFAoKS50aGVuKGNiLCBjYikKICB9CgogIGFzeW5jIF9vcGVuUCgpIHsKICAgIGlmICh0aGlzLmVuZCA9PT0gLTEpIGF3YWl0IHRoaXMuY29yZS51cGRhdGUoKQogICAgZWxzZSBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQogICAgaWYgKHRoaXMuc25hcHNob3QgJiYgdGhpcy5lbmQgPT09IC0xKSB0aGlzLmVuZCA9IHRoaXMuY29yZS5sZW5ndGgKICB9CgogIGFzeW5jIF9yZWFkUCgpIHsKICAgIGNvbnN0IGVuZCA9IHRoaXMubGl2ZSA/IC0xIDogdGhpcy5lbmQgPT09IC0xID8gdGhpcy5jb3JlLmxlbmd0aCA6IHRoaXMuZW5kCiAgICBpZiAoZW5kID49IDAgJiYgdGhpcy5zdGFydCA+PSBlbmQpIHsKICAgICAgdGhpcy5wdXNoKG51bGwpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMucHVzaChhd2FpdCB0aGlzLmNvcmUuZ2V0KHRoaXMuc3RhcnQrKywgeyB3YWl0OiB0aGlzLndhaXQsIHRpbWVvdXQ6IHRoaXMudGltZW91dCB9KSkKICB9Cn0KCmV4cG9ydHMuUmVhZFN0cmVhbSA9IFJlYWRTdHJlYW0KCmNsYXNzIFdyaXRlU3RyZWFtIGV4dGVuZHMgV3JpdGFibGUgewogIGNvbnN0cnVjdG9yKGNvcmUpIHsKICAgIHN1cGVyKCkKICAgIHRoaXMuY29yZSA9IGNvcmUKICB9CgogIF93cml0ZXYoYmF0Y2gsIGNiKSB7CiAgICB0aGlzLl93cml0ZXZQKGJhdGNoKS50aGVuKGNiLCBjYikKICB9CgogIGFzeW5jIF93cml0ZXZQKGJhdGNoKSB7CiAgICBhd2FpdCB0aGlzLmNvcmUuYXBwZW5kKGJhdGNoKQogIH0KfQoKZXhwb3J0cy5Xcml0ZVN0cmVhbSA9IFdyaXRlU3RyZWFtCgpjbGFzcyBCeXRlU3RyZWFtIGV4dGVuZHMgUmVhZGFibGUgewogIGNvbnN0cnVjdG9yKGNvcmUsIG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuX2NvcmUgPSBjb3JlCiAgICB0aGlzLl9pbmRleCA9IDAKICAgIHRoaXMuX3JhbmdlID0gbnVsbAoKICAgIHRoaXMuX2J5dGVPZmZzZXQgPSBvcHRzLmJ5dGVPZmZzZXQgfHwgMAogICAgdGhpcy5fYnl0ZUxlbmd0aCA9IHR5cGVvZiBvcHRzLmJ5dGVMZW5ndGggPT09ICdudW1iZXInID8gb3B0cy5ieXRlTGVuZ3RoIDogLTEKICAgIHRoaXMuX3ByZWZldGNoID0gdHlwZW9mIG9wdHMucHJlZmV0Y2ggPT09ICdudW1iZXInID8gb3B0cy5wcmVmZXRjaCA6IDMyCgogICAgdGhpcy5fYXBwbHlPZmZzZXQgPSB0aGlzLl9ieXRlT2Zmc2V0ID4gMAogIH0KCiAgX29wZW4oY2IpIHsKICAgIHRoaXMuX29wZW5wKCkudGhlbihjYiwgY2IpCiAgfQoKICBfcmVhZChjYikgewogICAgdGhpcy5fcmVhZHAoKS50aGVuKGNiLCBjYikKICB9CgogIGFzeW5jIF9vcGVucCgpIHsKICAgIGlmICh0aGlzLl9ieXRlTGVuZ3RoID09PSAtMSkgewogICAgICBhd2FpdCB0aGlzLl9jb3JlLnVwZGF0ZSgpCiAgICAgIHRoaXMuX2J5dGVMZW5ndGggPSBNYXRoLm1heCh0aGlzLl9jb3JlLmJ5dGVMZW5ndGggLSB0aGlzLl9ieXRlT2Zmc2V0LCAwKQogICAgfQogIH0KCiAgYXN5bmMgX3JlYWRwKCkgewogICAgbGV0IGRhdGEgPSBudWxsCgogICAgaWYgKHRoaXMuX2J5dGVMZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5wdXNoKG51bGwpCiAgICAgIHJldHVybgogICAgfQoKICAgIGxldCByZWxhdGl2ZU9mZnNldCA9IDAKCiAgICBpZiAodGhpcy5fYXBwbHlPZmZzZXQpIHsKICAgICAgdGhpcy5fYXBwbHlPZmZzZXQgPSBmYWxzZQoKICAgICAgY29uc3QgW2Jsb2NrLCBieXRlT2Zmc2V0XSA9IGF3YWl0IHRoaXMuX2NvcmUuc2Vlayh0aGlzLl9ieXRlT2Zmc2V0KQoKICAgICAgdGhpcy5faW5kZXggPSBibG9jawogICAgICByZWxhdGl2ZU9mZnNldCA9IGJ5dGVPZmZzZXQKICAgIH0KCiAgICB0aGlzLl9wcmVkb3dubG9hZCh0aGlzLl9pbmRleCArIDEpCiAgICBkYXRhID0gYXdhaXQgdGhpcy5fY29yZS5nZXQodGhpcy5faW5kZXgrKywgeyB2YWx1ZUVuY29kaW5nOiAnYmluYXJ5JyB9KQoKICAgIGlmIChyZWxhdGl2ZU9mZnNldCA+IDApIGRhdGEgPSBkYXRhLnN1YmFycmF5KHJlbGF0aXZlT2Zmc2V0KQoKICAgIGlmIChkYXRhLmJ5dGVMZW5ndGggPiB0aGlzLl9ieXRlTGVuZ3RoKSBkYXRhID0gZGF0YS5zdWJhcnJheSgwLCB0aGlzLl9ieXRlTGVuZ3RoKQogICAgdGhpcy5fYnl0ZUxlbmd0aCAtPSBkYXRhLmJ5dGVMZW5ndGgKCiAgICB0aGlzLnB1c2goZGF0YSkKICAgIGlmICh0aGlzLl9ieXRlTGVuZ3RoID09PSAwKSB0aGlzLnB1c2gobnVsbCkKICB9CgogIF9wcmVkb3dubG9hZChpbmRleCkgewogICAgaWYgKHRoaXMuX3JhbmdlKSB0aGlzLl9yYW5nZS5kZXN0cm95KCkKICAgIHRoaXMuX3JhbmdlID0gdGhpcy5fY29yZS5kb3dubG9hZCh7IHN0YXJ0OiBpbmRleCwgZW5kOiBpbmRleCArIHRoaXMuX3ByZWZldGNoLCBsaW5lYXI6IHRydWUgfSkKICB9CgogIF9kZXN0cm95KGNiKSB7CiAgICBpZiAodGhpcy5fcmFuZ2UpIHRoaXMuX3JhbmdlLmRlc3Ryb3koKQogICAgY2IobnVsbCkKICB9Cn0KCmV4cG9ydHMuQnl0ZVN0cmVhbSA9IEJ5dGVTdHJlYW0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgZmxhdCA9IHJlcXVpcmUoJ2ZsYXQtdHJlZScpCmNvbnN0IHsgQkFEX0FSR1VNRU5UIH0gPSByZXF1aXJlKCdoeXBlcmNvcmUtZXJyb3JzJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKCmNvbnN0IG0gPSByZXF1aXJlKCcuL21lc3NhZ2VzJykKY29uc3QgbXVsdGlzaWcgPSByZXF1aXJlKCcuL211bHRpc2lnJykKY29uc3QgY2FwcyA9IHJlcXVpcmUoJy4vY2FwcycpCgpjbGFzcyBTaWduZXIgewogIGNvbnN0cnVjdG9yKAogICAgbWFuaWZlc3RIYXNoLAogICAgdmVyc2lvbiwKICAgIGluZGV4LAogICAgeyBzaWduYXR1cmUgPSAnZWQyNTUxOScsIHB1YmxpY0tleSwgbmFtZXNwYWNlID0gY2Fwcy5ERUZBVUxUX05BTUVTUEFDRSB9ID0ge30KICApIHsKICAgIGlmICghcHVibGljS2V5KSB0aHJvdyBCQURfQVJHVU1FTlQoJ3B1YmxpYyBrZXkgaXMgcmVxdWlyZWQgZm9yIGEgc2lnbmVyJykKICAgIGlmIChzaWduYXR1cmUgIT09ICdlZDI1NTE5JykgdGhyb3cgQkFEX0FSR1VNRU5UKCdPbmx5IEVkMjU1MTkgc2lnbmF0dXJlcyBhcmUgc3VwcG9ydGVkJykKCiAgICB0aGlzLm1hbmlmZXN0SGFzaCA9IG1hbmlmZXN0SGFzaAogICAgdGhpcy52ZXJzaW9uID0gdmVyc2lvbgogICAgdGhpcy5zaWduZXIgPSBpbmRleAogICAgdGhpcy5zaWduYXR1cmUgPSBzaWduYXR1cmUKICAgIHRoaXMucHVibGljS2V5ID0gcHVibGljS2V5CiAgICB0aGlzLm5hbWVzcGFjZSA9IG5hbWVzcGFjZQogIH0KCiAgX2N0eCgpIHsKICAgIHJldHVybiB0aGlzLnZlcnNpb24gPT09IDAgPyB0aGlzLm5hbWVzcGFjZSA6IHRoaXMubWFuaWZlc3RIYXNoCiAgfQoKICB2ZXJpZnkoYmF0Y2gsIHNpZ25hdHVyZSkgewogICAgcmV0dXJuIGNyeXB0by52ZXJpZnkoYmF0Y2guc2lnbmFibGUodGhpcy5fY3R4KCkpLCBzaWduYXR1cmUsIHRoaXMucHVibGljS2V5KQogIH0KCiAgc2lnbihiYXRjaCwga2V5UGFpcikgewogICAgcmV0dXJuIGNyeXB0by5zaWduKGJhdGNoLnNpZ25hYmxlKHRoaXMuX2N0eCgpKSwga2V5UGFpci5zZWNyZXRLZXkpCiAgfQp9CgpjbGFzcyBDb21wYXRTaWduZXIgZXh0ZW5kcyBTaWduZXIgewogIGNvbnN0cnVjdG9yKGluZGV4LCBzaWduZXIsIGxlZ2FjeSkgewogICAgc3VwZXIobnVsbCwgMCwgaW5kZXgsIHNpZ25lcikKICAgIHRoaXMubGVnYWN5ID0gbGVnYWN5CiAgfQoKICB2ZXJpZnkoYmF0Y2gsIHNpZ25hdHVyZSkgewogICAgcmV0dXJuIGNyeXB0by52ZXJpZnkoYmF0Y2guc2lnbmFibGVDb21wYXQodGhpcy5sZWdhY3kpLCBzaWduYXR1cmUsIHRoaXMucHVibGljS2V5KQogIH0KCiAgc2lnbihiYXRjaCwga2V5UGFpcikgewogICAgcmV0dXJuIGNyeXB0by5zaWduKGJhdGNoLnNpZ25hYmxlQ29tcGF0KHRoaXMubGVnYWN5KSwga2V5UGFpci5zZWNyZXRLZXkpCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFZlcmlmaWVyIHsKICBjb25zdHJ1Y3RvcigKICAgIG1hbmlmZXN0SGFzaCwKICAgIG1hbmlmZXN0LAogICAgeyBjb21wYXQgPSBpc0NvbXBhdChtYW5pZmVzdEhhc2gsIG1hbmlmZXN0KSwgbGVnYWN5ID0gZmFsc2UgfSA9IHt9CiAgKSB7CiAgICBjb25zdCBzZWxmID0gdGhpcwoKICAgIHRoaXMubWFuaWZlc3RIYXNoID0gbWFuaWZlc3RIYXNoCiAgICB0aGlzLmNvbXBhdCA9IGNvbXBhdCB8fCBtYW5pZmVzdCA9PT0gbnVsbAogICAgdGhpcy52ZXJzaW9uID0gdGhpcy5jb21wYXQgPyAwIDogdHlwZW9mIG1hbmlmZXN0LnZlcnNpb24gPT09ICdudW1iZXInID8gbWFuaWZlc3QudmVyc2lvbiA6IDEKICAgIHRoaXMuaGFzaCA9IG1hbmlmZXN0Lmhhc2ggfHwgJ2JsYWtlMmInCiAgICB0aGlzLmFsbG93UGF0Y2ggPSAhdGhpcy5jb21wYXQgJiYgISFtYW5pZmVzdC5hbGxvd1BhdGNoCiAgICB0aGlzLnF1b3J1bSA9IHRoaXMuY29tcGF0ID8gMSA6IGRlZmF1bHRRdW9ydW0obWFuaWZlc3QpCgogICAgdGhpcy5zaWduZXJzID0gbWFuaWZlc3Quc2lnbmVycyA/IG1hbmlmZXN0LnNpZ25lcnMubWFwKGNyZWF0ZVNpZ25lcikgOiBbXQogICAgdGhpcy5wcm9sb2d1ZSA9IHRoaXMuY29tcGF0ID8gbnVsbCA6IG1hbmlmZXN0LnByb2xvZ3VlIHx8IG51bGwKCiAgICBmdW5jdGlvbiBjcmVhdGVTaWduZXIoc2lnbmVyLCBpbmRleCkgewogICAgICByZXR1cm4gc2VsZi5jb21wYXQKICAgICAgICA/IG5ldyBDb21wYXRTaWduZXIoaW5kZXgsIHNpZ25lciwgbGVnYWN5KQogICAgICAgIDogbmV3IFNpZ25lcihtYW5pZmVzdEhhc2gsIHNlbGYudmVyc2lvbiwgaW5kZXgsIHNpZ25lcikKICAgIH0KICB9CgogIF92ZXJpZnlDb21wYXQoYmF0Y2gsIHNpZ25hdHVyZSkgewogICAgaWYgKCFzaWduYXR1cmUpIHJldHVybiBmYWxzZQoKICAgIGlmICh0aGlzLmNvbXBhdCB8fCAoIXRoaXMuYWxsb3dQYXRjaCAmJiB0aGlzLnNpZ25lcnMubGVuZ3RoID09PSAxKSkgewogICAgICByZXR1cm4gISFzaWduYXR1cmUgJiYgdGhpcy5zaWduZXJzWzBdLnZlcmlmeShiYXRjaCwgc2lnbmF0dXJlKQogICAgfQoKICAgIHJldHVybiB0aGlzLl92ZXJpZnlNdWx0aShiYXRjaCwgc2lnbmF0dXJlKQogIH0KCiAgX2luZmxhdGUoc2lnbmF0dXJlKSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID49IDEpIHJldHVybiBtdWx0aXNpZy5pbmZsYXRlKHNpZ25hdHVyZSkKICAgIGNvbnN0IHsgcHJvb2ZzLCBwYXRjaCB9ID0gbXVsdGlzaWcuaW5mbGF0ZXYwKHNpZ25hdHVyZSkKCiAgICByZXR1cm4gewogICAgICBwcm9vZnM6IHByb29mcy5tYXAocHJvb2ZUb1ZlcnNpb24xKSwKICAgICAgcGF0Y2gKICAgIH0KICB9CgogIF92ZXJpZnlNdWx0aShiYXRjaCwgc2lnbmF0dXJlKSB7CiAgICBpZiAoIXNpZ25hdHVyZSB8fCB0aGlzLnF1b3J1bSA9PT0gMCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgeyBwcm9vZnMsIHBhdGNoIH0gPSB0aGlzLl9pbmZsYXRlKHNpZ25hdHVyZSkKICAgIGlmIChwcm9vZnMubGVuZ3RoIDwgdGhpcy5xdW9ydW0pIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IHRyaWVkID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5zaWduZXJzLmxlbmd0aCkKICAgIGNvbnN0IG5vZGVzID0gdGhpcy5hbGxvd1BhdGNoICYmIHBhdGNoLmxlbmd0aCA/IHRvTWFwKHBhdGNoKSA6IG51bGwKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucXVvcnVtOyBpKyspIHsKICAgICAgY29uc3QgaW5wID0gcHJvb2ZzW2ldCgogICAgICBsZXQgdHJlZSA9IGJhdGNoCgogICAgICBpZiAoaW5wLnBhdGNoICYmIHRoaXMuYWxsb3dQYXRjaCkgewogICAgICAgIHRyZWUgPSBiYXRjaC5jbG9uZSgpCgogICAgICAgIGNvbnN0IHVwZ3JhZGUgPSBnZW5lcmF0ZVVwZ3JhZGUobm9kZXMsIGJhdGNoLmxlbmd0aCwgaW5wLnBhdGNoKQogICAgICAgIGNvbnN0IHByb29mID0gewogICAgICAgICAgZm9yazogdHJlZS5mb3JrLAogICAgICAgICAgYmxvY2s6IG51bGwsCiAgICAgICAgICBoYXNoOiBudWxsLAogICAgICAgICAgc2VlazogbnVsbCwKICAgICAgICAgIHVwZ3JhZGUsCiAgICAgICAgICBtYW5pZmVzdDogbnVsbAogICAgICAgIH0KCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmICghdHJlZS52ZXJpZnlVcGdyYWRlKHByb29mKSkgcmV0dXJuIGZhbHNlCiAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChpbnAuc2lnbmVyID49IHRoaXMuc2lnbmVycy5sZW5ndGggfHwgdHJpZWRbaW5wLnNpZ25lcl0pIHJldHVybiBmYWxzZQogICAgICB0cmllZFtpbnAuc2lnbmVyXSA9IDEKCiAgICAgIGNvbnN0IHMgPSB0aGlzLnNpZ25lcnNbaW5wLnNpZ25lcl0KICAgICAgaWYgKCFzLnZlcmlmeSh0cmVlLCBpbnAuc2lnbmF0dXJlKSkgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIHZlcmlmeShiYXRjaCwgc2lnbmF0dXJlKSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSB7CiAgICAgIHJldHVybiB0aGlzLl92ZXJpZnlDb21wYXQoYmF0Y2gsIHNpZ25hdHVyZSkKICAgIH0KCiAgICBpZiAodGhpcy5wcm9sb2d1ZSAhPT0gbnVsbCAmJiBiYXRjaC5sZW5ndGggPD0gdGhpcy5wcm9sb2d1ZS5sZW5ndGgpIHsKICAgICAgcmV0dXJuIGJhdGNoLmxlbmd0aCA9PT0gdGhpcy5wcm9sb2d1ZS5sZW5ndGggJiYgYjRhLmVxdWFscyhiYXRjaC5oYXNoKCksIHRoaXMucHJvbG9ndWUuaGFzaCkKICAgIH0KCiAgICByZXR1cm4gdGhpcy5fdmVyaWZ5TXVsdGkoYmF0Y2gsIHNpZ25hdHVyZSkKICB9CgogIC8vIFRPRE86IGJldHRlciBhcGkgZm9yIHRoaXMgdGhhdCBpcyBtb3JlIC4uLiBtdWx0aXNpZy1leQogIHNpZ24oYmF0Y2gsIGtleVBhaXIpIHsKICAgIGlmICgha2V5UGFpciB8fCAha2V5UGFpci5zZWNyZXRLZXkpIHRocm93IEJBRF9BUkdVTUVOVCgnTm8ga2V5IHBhaXIgd2FzIHBhc3NlZCcpCgogICAgZm9yIChjb25zdCBzIG9mIHRoaXMuc2lnbmVycykgewogICAgICBpZiAoYjRhLmVxdWFscyhzLnB1YmxpY0tleSwga2V5UGFpci5wdWJsaWNLZXkpKSB7CiAgICAgICAgY29uc3Qgc2lnbmF0dXJlID0gcy5zaWduKGJhdGNoLCBrZXlQYWlyKQogICAgICAgIGlmICh0aGlzLnNpZ25lcnMubGVuZ3RoICE9PSAxIHx8IHRoaXMudmVyc2lvbiA9PT0gMCkgcmV0dXJuIHNpZ25hdHVyZQogICAgICAgIHJldHVybiB0aGlzLmFzc2VtYmxlKFt7IHNpZ25lcjogMCwgc2lnbmF0dXJlLCBwYXRjaDogMCwgbm9kZXM6IG51bGwgfV0pCiAgICAgIH0KICAgIH0KCiAgICB0aHJvdyBCQURfQVJHVU1FTlQoJ1B1YmxpYyBrZXkgaXMgbm90IGEgZGVjbGFyZWQgc2lnbmVyJykKICB9CgogIGFzc2VtYmxlKGlucHV0cykgewogICAgcmV0dXJuIHRoaXMudmVyc2lvbiA9PT0gMCA/IG11bHRpc2lnLmFzc2VtYmxldjAoaW5wdXRzKSA6IG11bHRpc2lnLmFzc2VtYmxlKGlucHV0cykKICB9CgogIHN0YXRpYyBtYW5pZmVzdEhhc2gobWFuaWZlc3QpIHsKICAgIHJldHVybiBtYW5pZmVzdEhhc2gobWFuaWZlc3QpCiAgfQoKICBzdGF0aWMgZW5jb2RlTWFuaWZlc3QobWFuaWZlc3QpIHsKICAgIHJldHVybiBjLmVuY29kZShtLm1hbmlmZXN0LCBtYW5pZmVzdCkKICB9CgogIHN0YXRpYyBkZWNvZGVNYW5pZmVzdChtYW5pZmVzdCkgewogICAgcmV0dXJuIGMuZGVjb2RlKG0ubWFuaWZlc3QsIG1hbmlmZXN0KQogIH0KCiAgc3RhdGljIGRlZmF1bHRTaWduZXJNYW5pZmVzdChwdWJsaWNLZXkpIHsKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IDEsCiAgICAgIGhhc2g6ICdibGFrZTJiJywKICAgICAgYWxsb3dQYXRjaDogZmFsc2UsCiAgICAgIHF1b3J1bTogMSwKICAgICAgc2lnbmVyczogWwogICAgICAgIHsKICAgICAgICAgIHNpZ25hdHVyZTogJ2VkMjU1MTknLAogICAgICAgICAgbmFtZXNwYWNlOiBjYXBzLkRFRkFVTFRfTkFNRVNQQUNFLAogICAgICAgICAgcHVibGljS2V5CiAgICAgICAgfQogICAgICBdLAogICAgICBwcm9sb2d1ZTogbnVsbCwKICAgICAgbGlua2VkOiBudWxsLAogICAgICB1c2VyRGF0YTogbnVsbAogICAgfQogIH0KCiAgc3RhdGljIGZyb21NYW5pZmVzdChtYW5pZmVzdCwgb3B0cykgewogICAgY29uc3QgbSA9IHRoaXMuY3JlYXRlTWFuaWZlc3QobWFuaWZlc3QpCiAgICByZXR1cm4gbmV3IHRoaXMobWFuaWZlc3RIYXNoKG0pLCBtLCBvcHRzKQogIH0KCiAgc3RhdGljIGNyZWF0ZU1hbmlmZXN0KGlucCkgewogICAgaWYgKCFpbnApIHJldHVybiBudWxsCgogICAgY29uc3QgbWFuaWZlc3QgPSB7CiAgICAgIHZlcnNpb246IGdldE1hbmlmZXN0VmVyc2lvbihpbnApLCAvLyBkZWZhdWx0cyB0byB2MQogICAgICBoYXNoOiAnYmxha2UyYicsCiAgICAgIGFsbG93UGF0Y2g6ICEhaW5wLmFsbG93UGF0Y2gsCiAgICAgIHF1b3J1bTogZGVmYXVsdFF1b3J1bShpbnApLAogICAgICBzaWduZXJzOiBpbnAuc2lnbmVycyA/IGlucC5zaWduZXJzLm1hcChwYXJzZVNpZ25lcikgOiBbXSwKICAgICAgcHJvbG9ndWU6IG51bGwsCiAgICAgIGxpbmtlZDogbnVsbCwKICAgICAgdXNlckRhdGE6IGlucC51c2VyRGF0YSB8fCBudWxsCiAgICB9CgogICAgaWYgKGlucC5oYXNoICYmIGlucC5oYXNoICE9PSAnYmxha2UyYicpIHRocm93IEJBRF9BUkdVTUVOVCgnT25seSBCbGFrZTJiIGhhc2hlcyBhcmUgc3VwcG9ydGVkJykKCiAgICBpZiAoaW5wLnByb2xvZ3VlKSB7CiAgICAgIGlmICgKICAgICAgICAhKGI0YS5pc0J1ZmZlcihpbnAucHJvbG9ndWUuaGFzaCkgJiYgaW5wLnByb2xvZ3VlLmhhc2guYnl0ZUxlbmd0aCA9PT0gMzIpIHx8CiAgICAgICAgIShpbnAucHJvbG9ndWUubGVuZ3RoID49IDApCiAgICAgICkgewogICAgICAgIHRocm93IEJBRF9BUkdVTUVOVCgnSW52YWxpZCBwcm9sb2d1ZScpCiAgICAgIH0KCiAgICAgIG1hbmlmZXN0LnByb2xvZ3VlID0gaW5wLnByb2xvZ3VlCiAgICAgIG1hbmlmZXN0LnByb2xvZ3VlLmhhc2ggPSB1bnNsYWIobWFuaWZlc3QucHJvbG9ndWUuaGFzaCkKICAgIH0KCiAgICBpZiAobWFuaWZlc3QudXNlckRhdGEgIT09IG51bGwgJiYgbWFuaWZlc3QudmVyc2lvbiA8IDIpIHsKICAgICAgdGhyb3cgQkFEX0FSR1VNRU5UKCdJbnZhbGlkIGZpZWxkOiB1c2VyRGF0YScpCiAgICB9CgogICAgaWYgKGlucC5saW5rZWQgJiYgaW5wLmxpbmtlZC5sZW5ndGgpIHsKICAgICAgaWYgKG1hbmlmZXN0LnZlcnNpb24gPCAyKSB0aHJvdyBCQURfQVJHVU1FTlQoJ0ludmFsaWQgZmllbGQ6IGxpbmtlZCcpCgogICAgICBmb3IgKGNvbnN0IGtleSBvZiBpbnAubGlua2VkKSB7CiAgICAgICAgaWYgKCEoYjRhLmlzQnVmZmVyKGtleSkgJiYga2V5LmJ5dGVMZW5ndGggPT09IDMyKSkgewogICAgICAgICAgdGhyb3cgQkFEX0FSR1VNRU5UKCdJbnZhbGlkIGtleScpCiAgICAgICAgfQogICAgICB9CgogICAgICBtYW5pZmVzdC5saW5rZWQgPSBpbnAubGlua2VkCiAgICB9CgogICAgcmV0dXJuIG1hbmlmZXN0CiAgfQoKICBzdGF0aWMgaXNWYWxpZE1hbmlmZXN0KGtleSwgbWFuaWZlc3QpIHsKICAgIHJldHVybiBiNGEuZXF1YWxzKGtleSwgbWFuaWZlc3RIYXNoKG1hbmlmZXN0KSkKICB9CgogIHN0YXRpYyBpc0NvbXBhdChrZXksIG1hbmlmZXN0KSB7CiAgICByZXR1cm4gaXNDb21wYXQoa2V5LCBtYW5pZmVzdCkKICB9CgogIHN0YXRpYyBzaWduKG1hbmlmZXN0LCBiYXRjaCwga2V5UGFpciwgb3B0cykgewogICAgcmV0dXJuIFZlcmlmaWVyLmZyb21NYW5pZmVzdChtYW5pZmVzdCwgb3B0cykuc2lnbihiYXRjaCwga2V5UGFpcikKICB9Cn0KCmZ1bmN0aW9uIHRvTWFwKG5vZGVzKSB7CiAgY29uc3QgbSA9IG5ldyBNYXAoKQogIGZvciAoY29uc3Qgbm9kZSBvZiBub2RlcykgbS5zZXQobm9kZS5pbmRleCwgbm9kZSkKICByZXR1cm4gbQp9CgpmdW5jdGlvbiBpc0NvbXBhdChrZXksIG1hbmlmZXN0KSB7CiAgcmV0dXJuICEhKAogICAgbWFuaWZlc3QgJiYKICAgIG1hbmlmZXN0LnNpZ25lcnMubGVuZ3RoID09PSAxICYmCiAgICBiNGEuZXF1YWxzKGtleSwgbWFuaWZlc3Quc2lnbmVyc1swXS5wdWJsaWNLZXkpCiAgKQp9CgpmdW5jdGlvbiBkZWZhdWx0UXVvcnVtKG1hbikgewogIGlmICh0eXBlb2YgbWFuLnF1b3J1bSA9PT0gJ251bWJlcicpIHJldHVybiBtYW4ucXVvcnVtCiAgaWYgKCFtYW4uc2lnbmVycyB8fCAhbWFuLnNpZ25lcnMubGVuZ3RoKSByZXR1cm4gMAogIHJldHVybiAobWFuLnNpZ25lcnMubGVuZ3RoID4+IDEpICsgMQp9CgpmdW5jdGlvbiBnZW5lcmF0ZVVwZ3JhZGUocGF0Y2gsIHN0YXJ0LCBsZW5ndGgpIHsKICBjb25zdCB1cGdyYWRlID0geyBzdGFydCwgbGVuZ3RoLCBub2RlczogbnVsbCwgYWRkaXRpb25hbE5vZGVzOiBbXSwgc2lnbmF0dXJlOiBudWxsIH0KCiAgY29uc3QgZnJvbSA9IHN0YXJ0ICogMgogIGNvbnN0IHRvID0gZnJvbSArIGxlbmd0aCAqIDIKCiAgZm9yIChjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKDApOyBpdGUuZnVsbFJvb3QodG8pOyBpdGUubmV4dFRyZWUoKSkgewogICAgaWYgKGl0ZS5pbmRleCArIGl0ZS5mYWN0b3IgLyAyIDwgZnJvbSkgY29udGludWUKCiAgICBpZiAodXBncmFkZS5ub2RlcyA9PT0gbnVsbCAmJiBpdGUuY29udGFpbnMoZnJvbSAtIDIpKSB7CiAgICAgIHVwZ3JhZGUubm9kZXMgPSBbXQoKICAgICAgY29uc3Qgcm9vdCA9IGl0ZS5pbmRleAogICAgICBjb25zdCB0YXJnZXQgPSBmcm9tIC0gMgoKICAgICAgaXRlLnNlZWsodGFyZ2V0KQoKICAgICAgd2hpbGUgKGl0ZS5pbmRleCAhPT0gcm9vdCkgewogICAgICAgIGl0ZS5zaWJsaW5nKCkKICAgICAgICBpZiAoaXRlLmluZGV4ID4gdGFyZ2V0KSB1cGdyYWRlLm5vZGVzLnB1c2gocGF0Y2guZ2V0KGl0ZS5pbmRleCkpCiAgICAgICAgaXRlLnBhcmVudCgpCiAgICAgIH0KCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgaWYgKHVwZ3JhZGUubm9kZXMgPT09IG51bGwpIHVwZ3JhZGUubm9kZXMgPSBbXQogICAgdXBncmFkZS5ub2Rlcy5wdXNoKHBhdGNoLmdldChpdGUuaW5kZXgpKQogIH0KCiAgaWYgKHVwZ3JhZGUubm9kZXMgPT09IG51bGwpIHVwZ3JhZGUubm9kZXMgPSBbXQogIHJldHVybiB1cGdyYWRlCn0KCmZ1bmN0aW9uIHBhcnNlU2lnbmVyKHNpZ25lcikgewogIHZhbGlkYXRlU2lnbmVyKHNpZ25lcikKICByZXR1cm4gewogICAgc2lnbmF0dXJlOiAnZWQyNTUxOScsCiAgICBuYW1lc3BhY2U6IHVuc2xhYihzaWduZXIubmFtZXNwYWNlIHx8IGNhcHMuREVGQVVMVF9OQU1FU1BBQ0UpLAogICAgcHVibGljS2V5OiB1bnNsYWIoc2lnbmVyLnB1YmxpY0tleSkKICB9Cn0KCmZ1bmN0aW9uIHZhbGlkYXRlU2lnbmVyKHNpZ25lcikgewogIGlmICghc2lnbmVyIHx8ICFzaWduZXIucHVibGljS2V5KSB0aHJvdyBCQURfQVJHVU1FTlQoJ1NpZ25lciBtaXNzaW5nIHB1YmxpYyBrZXknKQogIGlmIChzaWduZXIuc2lnbmF0dXJlICYmIHNpZ25lci5zaWduYXR1cmUgIT09ICdlZDI1NTE5JykgewogICAgdGhyb3cgQkFEX0FSR1VNRU5UKCdPbmx5IEVkMjU1MTkgc2lnbmF0dXJlcyBhcmUgc3VwcG9ydGVkJykKICB9Cn0KCmZ1bmN0aW9uIG1hbmlmZXN0SGFzaChtYW5pZmVzdCkgewogIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiAzMiwgYnVmZmVyOiBudWxsIH0KICBtLm1hbmlmZXN0LnByZWVuY29kZShzdGF0ZSwgbWFuaWZlc3QpCiAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHN0YXRlLmVuZCkKICBjLnJhdy5lbmNvZGUoc3RhdGUsIGNhcHMuTUFOSUZFU1QpCiAgbS5tYW5pZmVzdC5lbmNvZGUoc3RhdGUsIG1hbmlmZXN0KQogIHJldHVybiBjcnlwdG8uaGFzaChzdGF0ZS5idWZmZXIpCn0KCmZ1bmN0aW9uIHByb29mVG9WZXJzaW9uMShwcm9vZikgewogIHJldHVybiB7CiAgICBzaWduZXI6IHByb29mLnNpZ25lciwKICAgIHNpZ25hdHVyZTogcHJvb2Yuc2lnbmF0dXJlLAogICAgcGF0Y2g6IHByb29mLnBhdGNoID8gcHJvb2YucGF0Y2gubGVuZ3RoIDogMAogIH0KfQoKZnVuY3Rpb24gZ2V0TWFuaWZlc3RWZXJzaW9uKGlucCkgewogIGlmICh0eXBlb2YgaW5wLnZlcnNpb24gPT09ICdudW1iZXInKSByZXR1cm4gaW5wLnZlcnNpb24KICBpZiAoaW5wLmxpbmtlZCAmJiBpbnAubGlua2VkLmxlbmd0aCkgcmV0dXJuIDIKICBpZiAoaW5wLnVzZXJEYXRhKSByZXR1cm4gMgogIHJldHVybiAxCn0KewogICJuYW1lIjogImh5cGVyY29yZSIsCiAgInZlcnNpb24iOiAiMTEuMjEuNSIsCiAgImRlc2NyaXB0aW9uIjogIkh5cGVyY29yZSBpcyBhIHNlY3VyZSwgZGlzdHJpYnV0ZWQgYXBwZW5kLW9ubHkgbG9nIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4gJiYgbHVudGUiLAogICAgInRlc3QiOiAiYnJpdHRsZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC9hbGwuanMiLAogICAgInRlc3Q6Z2VuZXJhdGUiOiAiYnJpdHRsZSAtciB0ZXN0L2FsbC5qcyB0ZXN0LyouanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJjb3JlLmdpdCIKICB9LAogICJjb250cmlidXRvcnMiOiBbCiAgICB7CiAgICAgICJuYW1lIjogIk1hdGhpYXMgQnV1cyIsCiAgICAgICJlbWFpbCI6ICJtYXRoaWFzYnV1c0BnbWFpbC5jb20iLAogICAgICAidXJsIjogImh0dHBzOi8vbWFmaW50by5zaCIKICAgIH0sCiAgICB7CiAgICAgICJuYW1lIjogIkFuZHJldyBPc2hlcm9mZiIsCiAgICAgICJlbWFpbCI6ICJhbmRyZXdvc2hAZ21haWwuY29tIiwKICAgICAgInVybCI6ICJodHRwczovL2FuZHJld29zaC5jb20iCiAgICB9CiAgXSwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJjb3JlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJjb3JlI3JlYWRtZSIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJlcnJvcnMuanMiLAogICAgIm1lc3NhZ2VzLmpzIiwKICAgICJsaWIvKiouanMiCiAgXSwKICAiaW1wb3J0cyI6IHsKICAgICJldmVudHMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZXZlbnRzIiwKICAgICAgImRlZmF1bHQiOiAiZXZlbnRzIgogICAgfQogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtIjogIl42LjAuMCIsCiAgICAiYjRhIjogIl4xLjEuMCIsCiAgICAiYmFyZS1ldmVudHMiOiAiXjIuMi4wIiwKICAgICJiaWctc3BhcnNlLWFycmF5IjogIl4xLjAuMyIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xMS4wIiwKICAgICJmYXN0LWZpZm8iOiAiXjEuMy4wIiwKICAgICJmbGF0LXRyZWUiOiAiXjEuOS4wIiwKICAgICJoeXBlcmNvcmUtY3J5cHRvIjogIl4zLjIuMSIsCiAgICAiaHlwZXJjb3JlLWVycm9ycyI6ICJeMS41LjAiLAogICAgImh5cGVyY29yZS1pZC1lbmNvZGluZyI6ICJeMS4yLjAiLAogICAgImh5cGVyY29yZS1zdG9yYWdlIjogIl4yLjAuMCIsCiAgICAiaXMtb3B0aW9ucyI6ICJeMS4wLjEiLAogICAgIm5hbm9hc3NlcnQiOiAiXjIuMC4wIiwKICAgICJwcm90b211eCI6ICJeMy41LjAiLAogICAgInF1aWNrYml0LXVuaXZlcnNhbCI6ICJeMi4yLjAiLAogICAgInJhbmRvbS1hcnJheS1pdGVyYXRvciI6ICJeMS4wLjAiLAogICAgInNhZmV0eS1jYXRjaCI6ICJeMS4wLjEiLAogICAgInNvZGl1bS11bml2ZXJzYWwiOiAiXjUuMC4xIiwKICAgICJzdHJlYW14IjogIl4yLjEyLjQiLAogICAgInVuc2xhYiI6ICJeMS4zLjAiLAogICAgInozMiI6ICJeMS4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMC4wIiwKICAgICJkZWJ1Z2dpbmctc3RyZWFtIjogIl4zLjEuMCIsCiAgICAiaHlwZXJzd2FybSI6ICJeNC4zLjYiLAogICAgImx1bnRlIjogIl4xLjMuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIsCiAgICAicmFjaGUiOiAiXjEuMC4wIiwKICAgICJyYW5nZS1wYXJzZXIiOiAiXjEuMi4xIiwKICAgICJyZXNvbHZlLXJlamVjdC1wcm9taXNlIjogIl4xLjEuMCIsCiAgICAic3BlZWRvbWV0ZXIiOiAiXjEuMS4wIiwKICAgICJ0ZXN0LXRtcCI6ICJeMS4wLjIiLAogICAgInRpbnktYnl0ZS1zaXplIjogIl4xLjEuMCIsCiAgICAidWR4LW5hdGl2ZSI6ICJeMS42LjEiLAogICAgInVuY2F1Z2h0cyI6ICJeMS4xLjAiCiAgfQp9CmNvbnN0IERIVCA9IHJlcXVpcmUoJ2RodC1ycGMnKQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IG0gPSByZXF1aXJlKCcuL2xpYi9tZXNzYWdlcycpCmNvbnN0IFNvY2tldFBvb2wgPSByZXF1aXJlKCcuL2xpYi9zb2NrZXQtcG9vbCcpCmNvbnN0IFBlcnNpc3RlbnQgPSByZXF1aXJlKCcuL2xpYi9wZXJzaXN0ZW50JykKY29uc3QgUm91dGVyID0gcmVxdWlyZSgnLi9saWIvcm91dGVyJykKY29uc3QgQ2FjaGUgPSByZXF1aXJlKCd4YWNoZScpCmNvbnN0IFNlcnZlciA9IHJlcXVpcmUoJy4vbGliL3NlcnZlcicpCmNvbnN0IGNvbm5lY3QgPSByZXF1aXJlKCcuL2xpYi9jb25uZWN0JykKY29uc3QgeyBGSVJFV0FMTCwgQk9PVFNUUkFQX05PREVTLCBLTk9XTl9OT0RFUywgQ09NTUFORFMgfSA9IHJlcXVpcmUoJy4vbGliL2NvbnN0YW50cycpCmNvbnN0IHsgaGFzaCwgY3JlYXRlS2V5UGFpciB9ID0gcmVxdWlyZSgnLi9saWIvY3J5cHRvJykKY29uc3QgeyBkZWNvZGUgfSA9IHJlcXVpcmUoJ2h5cGVyY29yZS1pZC1lbmNvZGluZycpCmNvbnN0IFJhd1N0cmVhbVNldCA9IHJlcXVpcmUoJy4vbGliL3Jhdy1zdHJlYW0tc2V0JykKY29uc3QgQ29ubmVjdGlvblBvb2wgPSByZXF1aXJlKCcuL2xpYi9jb25uZWN0aW9uLXBvb2wnKQpjb25zdCB7IFNUUkVBTV9OT1RfQ09OTkVDVEVEIH0gPSByZXF1aXJlKCcuL2xpYi9lcnJvcnMnKQoKY2xhc3MgSHlwZXJESFQgZXh0ZW5kcyBESFQgewogIGNvbnN0cnVjdG9yKG9wdHMgPSB7fSkgewogICAgY29uc3QgcG9ydCA9IG9wdHMucG9ydCB8fCA0OTczNwogICAgY29uc3QgYm9vdHN0cmFwID0gb3B0cy5ib290c3RyYXAgfHwgQk9PVFNUUkFQX05PREVTCiAgICBjb25zdCBub2RlcyA9IG9wdHMubm9kZXMgfHwgS05PV05fTk9ERVMKCiAgICBzdXBlcih7IC4uLm9wdHMsIHBvcnQsIGJvb3RzdHJhcCwgbm9kZXMsIGZpbHRlck5vZGUgfSkKCiAgICBjb25zdCB7IHJvdXRlciwgcmVsYXlBZGRyZXNzZXMsIHBlcnNpc3RlbnQgfSA9IGRlZmF1bHRDYWNoZU9wdHMob3B0cykKCiAgICB0aGlzLmRlZmF1bHRLZXlQYWlyID0gb3B0cy5rZXlQYWlyIHx8IGNyZWF0ZUtleVBhaXIob3B0cy5zZWVkKQogICAgdGhpcy5saXN0ZW5pbmcgPSBuZXcgU2V0KCkKICAgIHRoaXMuY29ubmVjdGlvbktlZXBBbGl2ZSA9CiAgICAgIG9wdHMuY29ubmVjdGlvbktlZXBBbGl2ZSA9PT0gZmFsc2UgPyAwIDogb3B0cy5jb25uZWN0aW9uS2VlcEFsaXZlIHx8IDUwMDAKCiAgICAvLyBzdGF0cyBpcyBpbmhlcml0ZWQgZnJvbSBkaHQtcnBjIHNvIGZ3ZCB0aGUgb25lcyBmcm9tIHRoZXJlCiAgICB0aGlzLnN0YXRzID0gewogICAgICBwdW5jaGVzOiB7IGNvbnNpc3RlbnQ6IDAsIHJhbmRvbTogMCwgb3BlbjogMCB9LAogICAgICByZWxheWluZzogeyBhdHRlbXB0czogMCwgc3VjY2Vzc2VzOiAwLCBhYm9ydHM6IDAgfSwKICAgICAgLi4udGhpcy5zdGF0cwogICAgfQogICAgdGhpcy5yYXdTdHJlYW1zID0gbmV3IFJhd1N0cmVhbVNldCh0aGlzKQoKICAgIHRoaXMuX3JvdXRlciA9IG5ldyBSb3V0ZXIodGhpcywgcm91dGVyKQogICAgdGhpcy5fc29ja2V0UG9vbCA9IG5ldyBTb2NrZXRQb29sKHRoaXMsIG9wdHMuaG9zdCB8fCAnMC4wLjAuMCcpCiAgICB0aGlzLl9wZXJzaXN0ZW50ID0gbnVsbAogICAgdGhpcy5fdmFsaWRhdGVkTG9jYWxBZGRyZXNzZXMgPSBuZXcgTWFwKCkKICAgIHRoaXMuX3JlbGF5QWRkcmVzc2VzQ2FjaGUgPSBuZXcgQ2FjaGUocmVsYXlBZGRyZXNzZXMpCgogICAgdGhpcy5fZGVmZXJSYW5kb21QdW5jaCA9ICEhb3B0cy5kZWZlclJhbmRvbVB1bmNoCiAgICB0aGlzLl9sYXN0UmFuZG9tUHVuY2ggPSB0aGlzLl9kZWZlclJhbmRvbVB1bmNoID8gRGF0ZS5ub3coKSA6IDAKICAgIHRoaXMuX2Nvbm5lY3RhYmxlID0gdHJ1ZQogICAgdGhpcy5fcmFuZG9tUHVuY2hJbnRlcnZhbCA9IG9wdHMucmFuZG9tUHVuY2hJbnRlcnZhbCB8fCAyMDAwMCAvLyBtaW4gMjBzIGJldHdlZW4gcmFuZG9tIHB1bmNoZXMuLi4KICAgIHRoaXMuX3JhbmRvbVB1bmNoZXMgPSAwCiAgICB0aGlzLl9yYW5kb21QdW5jaExpbWl0ID0gMSAvLyBzZXQgdG8gb25lIGZvciBleHRyYSBzYWZldHkgZm9yIG5vdwoKICAgIHRoaXMub25jZSgncGVyc2lzdGVudCcsICgpID0+IHsKICAgICAgdGhpcy5fcGVyc2lzdGVudCA9IG5ldyBQZXJzaXN0ZW50KHRoaXMsIHBlcnNpc3RlbnQpCiAgICB9KQoKICAgIHRoaXMub24oJ25ldHdvcmstY2hhbmdlJywgKCkgPT4gewogICAgICBmb3IgKGNvbnN0IHNlcnZlciBvZiB0aGlzLmxpc3RlbmluZykgc2VydmVyLnJlZnJlc2goKQogICAgfSkKCiAgICB0aGlzLm9uKCduZXR3b3JrLXVwZGF0ZScsICgpID0+IHsKICAgICAgaWYgKCF0aGlzLm9ubGluZSkgcmV0dXJuCiAgICAgIGZvciAoY29uc3Qgc2VydmVyIG9mIHRoaXMubGlzdGVuaW5nKSBzZXJ2ZXIubm90aWZ5T25saW5lKCkKICAgIH0pCiAgfQoKICBjb25uZWN0KHJlbW90ZVB1YmxpY0tleSwgb3B0cykgewogICAgcmV0dXJuIGNvbm5lY3QodGhpcywgZGVjb2RlKHJlbW90ZVB1YmxpY0tleSksIG9wdHMpCiAgfQoKICBjcmVhdGVTZXJ2ZXIob3B0cywgb25jb25uZWN0aW9uKSB7CiAgICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHJldHVybiB0aGlzLmNyZWF0ZVNlcnZlcih7fSwgb3B0cykKICAgIGlmIChvcHRzICYmIG9wdHMub25jb25uZWN0aW9uKSBvbmNvbm5lY3Rpb24gPSBvcHRzLm9uY29ubmVjdGlvbgogICAgY29uc3QgcyA9IG5ldyBTZXJ2ZXIodGhpcywgb3B0cykKICAgIGlmIChvbmNvbm5lY3Rpb24pIHMub24oJ2Nvbm5lY3Rpb24nLCBvbmNvbm5lY3Rpb24pCiAgICByZXR1cm4gcwogIH0KCiAgcG9vbCgpIHsKICAgIHJldHVybiBuZXcgQ29ubmVjdGlvblBvb2wodGhpcykKICB9CgogIGFzeW5jIHJlc3VtZSh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICBpZiAodGhpcy5fZGVmZXJSYW5kb21QdW5jaCkgdGhpcy5fbGFzdFJhbmRvbVB1bmNoID0gRGF0ZS5ub3coKQogICAgYXdhaXQgc3VwZXIucmVzdW1lKHsgbG9nIH0pCiAgICBjb25zdCByZXN1bWluZyA9IFtdCiAgICBmb3IgKGNvbnN0IHNlcnZlciBvZiB0aGlzLmxpc3RlbmluZykgcmVzdW1pbmcucHVzaChzZXJ2ZXIucmVzdW1lKCkpCiAgICBsb2coJ1Jlc3VtaW5nIGh5cGVyZGh0IHNlcnZlcnMnKQogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHJlc3VtaW5nKQogICAgbG9nKCdEb25lLCBoeXBlcmRodCBmdWxseSByZXN1bWVkJykKICB9CgogIGFzeW5jIHN1c3BlbmQoeyBsb2cgPSBub29wIH0gPSB7fSkgewogICAgdGhpcy5fY29ubmVjdGFibGUgPSBmYWxzZSAvLyBqdXN0IHNvIG5vdGhpbmcgZ2V0cyBjb25uZWN0ZWQgZHVyaW5nIHN1c3BlbnNpb24KICAgIGNvbnN0IHN1c3BlbmRpbmcgPSBbXQogICAgZm9yIChjb25zdCBzZXJ2ZXIgb2YgdGhpcy5saXN0ZW5pbmcpIHN1c3BlbmRpbmcucHVzaChzZXJ2ZXIuc3VzcGVuZCgpKQogICAgbG9nKCdTdXNwZW5kaW5nIGFsbCBoeXBlcmRodCBzZXJ2ZXJzJykKICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzdXNwZW5kaW5nKQogICAgbG9nKCdEb25lLCBjbGVhcmluZyBhbGwgcmF3IHN0cmVhbXMnKQogICAgYXdhaXQgdGhpcy5yYXdTdHJlYW1zLmNsZWFyKCkKICAgIGxvZygnRG9uZSwgc3VzcGVuZGluZyBkaHQtcnBjJykKICAgIGF3YWl0IHN1cGVyLnN1c3BlbmQoeyBsb2cgfSkKICAgIGxvZygnRG9uZSwgY2xlYXJpbmcgcmF3IHN0cmVhbXMgYWdhaW4nKQogICAgYXdhaXQgdGhpcy5yYXdTdHJlYW1zLmNsZWFyKCkKICAgIGxvZygnRG9uZSwgaHlwZXJkaHQgZnVsbHkgc3VzcGVuZGVkJykKICAgIHRoaXMuX2Nvbm5lY3RhYmxlID0gdHJ1ZQogIH0KCiAgYXN5bmMgZGVzdHJveSh7IGZvcmNlID0gZmFsc2UgfSA9IHt9KSB7CiAgICBpZiAoIWZvcmNlKSB7CiAgICAgIGNvbnN0IGNsb3NpbmcgPSBbXQogICAgICBmb3IgKGNvbnN0IHNlcnZlciBvZiB0aGlzLmxpc3RlbmluZykgY2xvc2luZy5wdXNoKHNlcnZlci5jbG9zZSgpKQogICAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoY2xvc2luZykKICAgIH0KICAgIHRoaXMuX3JvdXRlci5kZXN0cm95KCkKICAgIGlmICh0aGlzLl9wZXJzaXN0ZW50KSB0aGlzLl9wZXJzaXN0ZW50LmRlc3Ryb3koKQogICAgYXdhaXQgdGhpcy5yYXdTdHJlYW1zLmNsZWFyKCkKICAgIGF3YWl0IHRoaXMuX3NvY2tldFBvb2wuZGVzdHJveSgpCiAgICBhd2FpdCBzdXBlci5kZXN0cm95KCkKICB9CgogIGFzeW5jIHZhbGlkYXRlTG9jYWxBZGRyZXNzZXMoYWRkcmVzc2VzKSB7CiAgICBjb25zdCBsaXN0ID0gW10KICAgIGNvbnN0IHNvY2tzID0gW10KICAgIGNvbnN0IHdhaXRpbmcgPSBbXQoKICAgIGZvciAoY29uc3QgYWRkciBvZiBhZGRyZXNzZXMpIHsKICAgICAgY29uc3QgeyBob3N0IH0gPSBhZGRyCgogICAgICBpZiAodGhpcy5fdmFsaWRhdGVkTG9jYWxBZGRyZXNzZXMuaGFzKGhvc3QpKSB7CiAgICAgICAgaWYgKGF3YWl0IHRoaXMuX3ZhbGlkYXRlZExvY2FsQWRkcmVzc2VzLmdldChob3N0KSkgewogICAgICAgICAgbGlzdC5wdXNoKGFkZHIpCiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGNvbnN0IHNvY2sgPSB0aGlzLnVkeC5jcmVhdGVTb2NrZXQoKQogICAgICB0cnkgewogICAgICAgIHNvY2suYmluZCgwLCBob3N0KQogICAgICB9IGNhdGNoIHsKICAgICAgICB0aGlzLl92YWxpZGF0ZWRMb2NhbEFkZHJlc3Nlcy5zZXQoaG9zdCwgUHJvbWlzZS5yZXNvbHZlKGZhbHNlKSkKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBzb2Nrcy5wdXNoKHNvY2spCgogICAgICAvLyBzZW1pIHRlcnJpYmxlIGhldXJpc3RpYyB1bnRpbCB3ZSBwcm9wZXIgZml4IGxvY2FsIGNvbm5lY3Rpb25zIGJ5IHJhY2luZyB0aGVtIHRvIHRoZSByZW1vdGUuLi4KICAgICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgc29jay5vbignbWVzc2FnZScsICgpID0+IHJlc29sdmUodHJ1ZSkpCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiByZXNvbHZlKGZhbHNlKSwgNTAwKQogICAgICAgIHNvY2sudHJ5U2VuZChiNGEuYWxsb2MoMSksIHNvY2suYWRkcmVzcygpLnBvcnQsIGFkZHIuaG9zdCkKICAgICAgfSkKCiAgICAgIHRoaXMuX3ZhbGlkYXRlZExvY2FsQWRkcmVzc2VzLnNldChob3N0LCBwcm9taXNlKQogICAgICB3YWl0aW5nLnB1c2goYWRkcikKICAgIH0KCiAgICBmb3IgKGNvbnN0IGFkZHIgb2Ygd2FpdGluZykgewogICAgICBjb25zdCB7IGhvc3QgfSA9IGFkZHIKICAgICAgaWYgKHRoaXMuX3ZhbGlkYXRlZExvY2FsQWRkcmVzc2VzLmhhcyhob3N0KSkgewogICAgICAgIGlmIChhd2FpdCB0aGlzLl92YWxpZGF0ZWRMb2NhbEFkZHJlc3Nlcy5nZXQoaG9zdCkpIHsKICAgICAgICAgIGxpc3QucHVzaChhZGRyKQogICAgICAgIH0KICAgICAgICBjb250aW51ZQogICAgICB9CiAgICB9CgogICAgZm9yIChjb25zdCBzb2NrIG9mIHNvY2tzKSBhd2FpdCBzb2NrLmNsb3NlKCkKCiAgICByZXR1cm4gbGlzdAogIH0KCiAgZmluZFBlZXIocHVibGljS2V5LCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHRhcmdldCA9IG9wdHMuaGFzaCA9PT0gZmFsc2UgPyBwdWJsaWNLZXkgOiBoYXNoKHB1YmxpY0tleSkKICAgIG9wdHMgPSB7IC4uLm9wdHMsIG1hcDogbWFwRmluZFBlZXIgfQogICAgcmV0dXJuIHRoaXMucXVlcnkoeyB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLkZJTkRfUEVFUiwgdmFsdWU6IG51bGwgfSwgb3B0cykKICB9CgogIGxvb2t1cCh0YXJnZXQsIG9wdHMgPSB7fSkgewogICAgb3B0cyA9IHsgLi4ub3B0cywgbWFwOiBtYXBMb29rdXAgfQogICAgcmV0dXJuIHRoaXMucXVlcnkoeyB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLkxPT0tVUCwgdmFsdWU6IG51bGwgfSwgb3B0cykKICB9CgogIGxvb2t1cEFuZFVuYW5ub3VuY2UodGFyZ2V0LCBrZXlQYWlyLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHVuYW5ub3VuY2VzID0gW10KICAgIGNvbnN0IGRodCA9IHRoaXMKICAgIGNvbnN0IHVzZXJDb21taXQgPSBvcHRzLmNvbW1pdCB8fCBub29wCiAgICBjb25zdCBzaWduVW5hbm5vdW5jZSA9IG9wdHMuc2lnblVuYW5ub3VuY2UgfHwgUGVyc2lzdGVudC5zaWduVW5hbm5vdW5jZQoKICAgIGlmICh0aGlzLl9wZXJzaXN0ZW50ICE9PSBudWxsKSB7CiAgICAgIC8vIHVubGluayBzZWxmCiAgICAgIHRoaXMuX3BlcnNpc3RlbnQudW5hbm5vdW5jZSh0YXJnZXQsIGtleVBhaXIucHVibGljS2V5KQogICAgfQoKICAgIG9wdHMgPSB7IC4uLm9wdHMsIG1hcCwgY29tbWl0IH0KICAgIHJldHVybiB0aGlzLnF1ZXJ5KHsgdGFyZ2V0LCBjb21tYW5kOiBDT01NQU5EUy5MT09LVVAsIHZhbHVlOiBudWxsIH0sIG9wdHMpCgogICAgYXN5bmMgZnVuY3Rpb24gY29tbWl0KHJlcGx5LCBkaHQsIHF1ZXJ5KSB7CiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHVuYW5ub3VuY2VzKSAvLyBjYW4gbmV2ZXIgZmFpbCwgY2F1Z2h0IGJlbG93CiAgICAgIHJldHVybiB1c2VyQ29tbWl0KHJlcGx5LCBkaHQsIHF1ZXJ5KQogICAgfQoKICAgIGZ1bmN0aW9uIG1hcChyZXBseSkgewogICAgICBjb25zdCBkYXRhID0gbWFwTG9va3VwKHJlcGx5KQoKICAgICAgaWYgKCFkYXRhIHx8ICFkYXRhLnRva2VuKSByZXR1cm4gZGF0YQoKICAgICAgbGV0IGZvdW5kID0gZGF0YS5wZWVycy5sZW5ndGggPj0gMjAKICAgICAgZm9yIChsZXQgaSA9IDA7ICFmb3VuZCAmJiBpIDwgZGF0YS5wZWVycy5sZW5ndGg7IGkrKykgewogICAgICAgIGZvdW5kID0gYjRhLmVxdWFscyhkYXRhLnBlZXJzW2ldLnB1YmxpY0tleSwga2V5UGFpci5wdWJsaWNLZXkpCiAgICAgIH0KCiAgICAgIGlmICghZm91bmQpIHJldHVybiBkYXRhCgogICAgICBpZiAoIWRhdGEuZnJvbS5pZCkgcmV0dXJuIGRhdGEKCiAgICAgIHVuYW5ub3VuY2VzLnB1c2goCiAgICAgICAgZGh0CiAgICAgICAgICAuX3JlcXVlc3RVbmFubm91bmNlKGtleVBhaXIsIGRodCwgdGFyZ2V0LCBkYXRhLnRva2VuLCBkYXRhLmZyb20sIHNpZ25VbmFubm91bmNlKQogICAgICAgICAgLmNhdGNoKHNhZmV0eUNhdGNoKQogICAgICApCgogICAgICByZXR1cm4gZGF0YQogICAgfQogIH0KCiAgdW5hbm5vdW5jZSh0YXJnZXQsIGtleVBhaXIsIG9wdHMgPSB7fSkgewogICAgcmV0dXJuIHRoaXMubG9va3VwQW5kVW5hbm5vdW5jZSh0YXJnZXQsIGtleVBhaXIsIG9wdHMpLmZpbmlzaGVkKCkKICB9CgogIGFubm91bmNlKHRhcmdldCwga2V5UGFpciwgcmVsYXlBZGRyZXNzZXMsIG9wdHMgPSB7fSkgewogICAgY29uc3Qgc2lnbkFubm91bmNlID0gb3B0cy5zaWduQW5ub3VuY2UgfHwgUGVyc2lzdGVudC5zaWduQW5ub3VuY2UKICAgIGNvbnN0IGJ1bXAgPSBvcHRzLmJ1bXAgfHwgMAoKICAgIG9wdHMgPSB7IC4uLm9wdHMsIGNvbW1pdCB9CgogICAgcmV0dXJuIG9wdHMuY2xlYXIgPyB0aGlzLmxvb2t1cEFuZFVuYW5ub3VuY2UodGFyZ2V0LCBrZXlQYWlyLCBvcHRzKSA6IHRoaXMubG9va3VwKHRhcmdldCwgb3B0cykKCiAgICBmdW5jdGlvbiBjb21taXQocmVwbHksIGRodCkgewogICAgICByZXR1cm4gZGh0Ll9yZXF1ZXN0QW5ub3VuY2UoCiAgICAgICAga2V5UGFpciwKICAgICAgICBkaHQsCiAgICAgICAgdGFyZ2V0LAogICAgICAgIHJlcGx5LnRva2VuLAogICAgICAgIHJlcGx5LmZyb20sCiAgICAgICAgcmVsYXlBZGRyZXNzZXMsCiAgICAgICAgc2lnbkFubm91bmNlLAogICAgICAgIGJ1bXAKICAgICAgKQogICAgfQogIH0KCiAgYXN5bmMgaW1tdXRhYmxlR2V0KHRhcmdldCwgb3B0cyA9IHt9KSB7CiAgICBvcHRzID0geyAuLi5vcHRzLCBtYXA6IG1hcEltbXV0YWJsZSB9CgogICAgY29uc3QgcXVlcnkgPSB0aGlzLnF1ZXJ5KHsgdGFyZ2V0LCBjb21tYW5kOiBDT01NQU5EUy5JTU1VVEFCTEVfR0VULCB2YWx1ZTogbnVsbCB9LCBvcHRzKQogICAgY29uc3QgY2hlY2sgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCgogICAgZm9yIGF3YWl0IChjb25zdCBub2RlIG9mIHF1ZXJ5KSB7CiAgICAgIGNvbnN0IHsgdmFsdWUgfSA9IG5vZGUKICAgICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChjaGVjaywgdmFsdWUpCiAgICAgIGlmIChiNGEuZXF1YWxzKGNoZWNrLCB0YXJnZXQpKSByZXR1cm4gbm9kZQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBhc3luYyBpbW11dGFibGVQdXQodmFsdWUsIG9wdHMgPSB7fSkgewogICAgY29uc3QgdGFyZ2V0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaCh0YXJnZXQsIHZhbHVlKQoKICAgIG9wdHMgPSB7CiAgICAgIC4uLm9wdHMsCiAgICAgIG1hcDogbWFwSW1tdXRhYmxlLAogICAgICBjb21taXQocmVwbHksIGRodCkgewogICAgICAgIHJldHVybiBkaHQucmVxdWVzdCgKICAgICAgICAgIHsgdG9rZW46IHJlcGx5LnRva2VuLCB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLklNTVVUQUJMRV9QVVQsIHZhbHVlIH0sCiAgICAgICAgICByZXBseS5mcm9tCiAgICAgICAgKQogICAgICB9CiAgICB9CgogICAgY29uc3QgcXVlcnkgPSB0aGlzLnF1ZXJ5KHsgdGFyZ2V0LCBjb21tYW5kOiBDT01NQU5EUy5JTU1VVEFCTEVfR0VULCB2YWx1ZTogbnVsbCB9LCBvcHRzKQogICAgYXdhaXQgcXVlcnkuZmluaXNoZWQoKQoKICAgIHJldHVybiB7IGhhc2g6IHRhcmdldCwgY2xvc2VzdE5vZGVzOiBxdWVyeS5jbG9zZXN0Tm9kZXMgfQogIH0KCiAgYXN5bmMgbXV0YWJsZUdldChwdWJsaWNLZXksIG9wdHMgPSB7fSkgewogICAgbGV0IHJlZnJlc2ggPSBvcHRzLnJlZnJlc2ggfHwgbnVsbAogICAgbGV0IHNpZ25lZCA9IG51bGwKICAgIGxldCByZXN1bHQgPSBudWxsCgogICAgb3B0cyA9IHsgLi4ub3B0cywgbWFwOiBtYXBNdXRhYmxlLCBjb21taXQ6IHJlZnJlc2ggPyBjb21taXQgOiBudWxsIH0KCiAgICBjb25zdCB0YXJnZXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKHRhcmdldCwgcHVibGljS2V5KQoKICAgIGNvbnN0IHVzZXJTZXEgPSBvcHRzLnNlcSB8fCAwCiAgICBjb25zdCBxdWVyeSA9IHRoaXMucXVlcnkoCiAgICAgIHsgdGFyZ2V0LCBjb21tYW5kOiBDT01NQU5EUy5NVVRBQkxFX0dFVCwgdmFsdWU6IGMuZW5jb2RlKGMudWludCwgdXNlclNlcSkgfSwKICAgICAgb3B0cwogICAgKQogICAgY29uc3QgbGF0ZXN0ID0gb3B0cy5sYXRlc3QgIT09IGZhbHNlCgogICAgZm9yIGF3YWl0IChjb25zdCBub2RlIG9mIHF1ZXJ5KSB7CiAgICAgIGlmIChyZXN1bHQgJiYgbm9kZS5zZXEgPD0gcmVzdWx0LnNlcSkgY29udGludWUKICAgICAgaWYgKAogICAgICAgIG5vZGUuc2VxIDwgdXNlclNlcSB8fAogICAgICAgICFQZXJzaXN0ZW50LnZlcmlmeU11dGFibGUobm9kZS5zaWduYXR1cmUsIG5vZGUuc2VxLCBub2RlLnZhbHVlLCBwdWJsaWNLZXkpCiAgICAgICkKICAgICAgICBjb250aW51ZQogICAgICBpZiAoIWxhdGVzdCkgcmV0dXJuIG5vZGUKICAgICAgaWYgKCFyZXN1bHQgfHwgbm9kZS5zZXEgPiByZXN1bHQuc2VxKSByZXN1bHQgPSBub2RlCiAgICB9CgogICAgcmV0dXJuIHJlc3VsdAoKICAgIGZ1bmN0aW9uIGNvbW1pdChyZXBseSwgZGh0KSB7CiAgICAgIGlmICghc2lnbmVkICYmIHJlc3VsdCAmJiByZWZyZXNoKSB7CiAgICAgICAgaWYgKHJlZnJlc2gocmVzdWx0KSkgewogICAgICAgICAgc2lnbmVkID0gYy5lbmNvZGUobS5tdXRhYmxlUHV0UmVxdWVzdCwgewogICAgICAgICAgICBwdWJsaWNLZXksCiAgICAgICAgICAgIHNlcTogcmVzdWx0LnNlcSwKICAgICAgICAgICAgdmFsdWU6IHJlc3VsdC52YWx1ZSwKICAgICAgICAgICAgc2lnbmF0dXJlOiByZXN1bHQuc2lnbmF0dXJlCiAgICAgICAgICB9KQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZWZyZXNoID0gbnVsbAogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHNpZ25lZAogICAgICAgID8gZGh0LnJlcXVlc3QoCiAgICAgICAgICAgIHsgdG9rZW46IHJlcGx5LnRva2VuLCB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLk1VVEFCTEVfUFVULCB2YWx1ZTogc2lnbmVkIH0sCiAgICAgICAgICAgIHJlcGx5LmZyb20KICAgICAgICAgICkKICAgICAgICA6IFByb21pc2UucmVzb2x2ZShudWxsKQogICAgfQogIH0KCiAgYXN5bmMgbXV0YWJsZVB1dChrZXlQYWlyLCB2YWx1ZSwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCBzaWduTXV0YWJsZSA9IG9wdHMuc2lnbk11dGFibGUgfHwgUGVyc2lzdGVudC5zaWduTXV0YWJsZQoKICAgIGNvbnN0IHRhcmdldCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2godGFyZ2V0LCBrZXlQYWlyLnB1YmxpY0tleSkKCiAgICBjb25zdCBzZXEgPSBvcHRzLnNlcSB8fCAwCiAgICBjb25zdCBzaWduYXR1cmUgPSBhd2FpdCBzaWduTXV0YWJsZShzZXEsIHZhbHVlLCBrZXlQYWlyKQoKICAgIGNvbnN0IHNpZ25lZCA9IGMuZW5jb2RlKG0ubXV0YWJsZVB1dFJlcXVlc3QsIHsKICAgICAgcHVibGljS2V5OiBrZXlQYWlyLnB1YmxpY0tleSwKICAgICAgc2VxLAogICAgICB2YWx1ZSwKICAgICAgc2lnbmF0dXJlCiAgICB9KQoKICAgIG9wdHMgPSB7CiAgICAgIC4uLm9wdHMsCiAgICAgIG1hcDogbWFwTXV0YWJsZSwKICAgICAgY29tbWl0KHJlcGx5LCBkaHQpIHsKICAgICAgICByZXR1cm4gZGh0LnJlcXVlc3QoCiAgICAgICAgICB7IHRva2VuOiByZXBseS50b2tlbiwgdGFyZ2V0LCBjb21tYW5kOiBDT01NQU5EUy5NVVRBQkxFX1BVVCwgdmFsdWU6IHNpZ25lZCB9LAogICAgICAgICAgcmVwbHkuZnJvbQogICAgICAgICkKICAgICAgfQogICAgfQoKICAgIC8vIHVzZSBzZXEgPSAwLCBmb3IgdGhlIHF1ZXJ5IHBhcnQgaGVyZSwgYXMgd2UgZG9uJ3QgY2FyZSBhYm91dCB0aGUgYWN0dWFsIHZhbHVlcwogICAgY29uc3QgcXVlcnkgPSB0aGlzLnF1ZXJ5KAogICAgICB7IHRhcmdldCwgY29tbWFuZDogQ09NTUFORFMuTVVUQUJMRV9HRVQsIHZhbHVlOiBjLmVuY29kZShjLnVpbnQsIDApIH0sCiAgICAgIG9wdHMKICAgICkKICAgIGF3YWl0IHF1ZXJ5LmZpbmlzaGVkKCkKCiAgICByZXR1cm4geyBwdWJsaWNLZXk6IGtleVBhaXIucHVibGljS2V5LCBjbG9zZXN0Tm9kZXM6IHF1ZXJ5LmNsb3Nlc3ROb2Rlcywgc2VxLCBzaWduYXR1cmUgfQogIH0KCiAgb25yZXF1ZXN0KHJlcSkgewogICAgc3dpdGNoIChyZXEuY29tbWFuZCkgewogICAgICBjYXNlIENPTU1BTkRTLlBFRVJfSEFORFNIQUtFOiB7CiAgICAgICAgdGhpcy5fcm91dGVyLm9ucGVlcmhhbmRzaGFrZShyZXEpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgICBjYXNlIENPTU1BTkRTLlBFRVJfSE9MRVBVTkNIOiB7CiAgICAgICAgdGhpcy5fcm91dGVyLm9ucGVlcmhvbGVwdW5jaChyZXEpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLl9wZXJzaXN0ZW50ID09PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgICBzd2l0Y2ggKHJlcS5jb21tYW5kKSB7CiAgICAgIGNhc2UgQ09NTUFORFMuRklORF9QRUVSOiB7CiAgICAgICAgdGhpcy5fcGVyc2lzdGVudC5vbmZpbmRwZWVyKHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIGNhc2UgQ09NTUFORFMuTE9PS1VQOiB7CiAgICAgICAgdGhpcy5fcGVyc2lzdGVudC5vbmxvb2t1cChyZXEpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgICBjYXNlIENPTU1BTkRTLkFOTk9VTkNFOiB7CiAgICAgICAgdGhpcy5fcGVyc2lzdGVudC5vbmFubm91bmNlKHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIGNhc2UgQ09NTUFORFMuVU5BTk5PVU5DRTogewogICAgICAgIHRoaXMuX3BlcnNpc3RlbnQub251bmFubm91bmNlKHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIGNhc2UgQ09NTUFORFMuTVVUQUJMRV9QVVQ6IHsKICAgICAgICB0aGlzLl9wZXJzaXN0ZW50Lm9ubXV0YWJsZXB1dChyZXEpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgICBjYXNlIENPTU1BTkRTLk1VVEFCTEVfR0VUOiB7CiAgICAgICAgdGhpcy5fcGVyc2lzdGVudC5vbm11dGFibGVnZXQocmVxKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgICAgY2FzZSBDT01NQU5EUy5JTU1VVEFCTEVfUFVUOiB7CiAgICAgICAgdGhpcy5fcGVyc2lzdGVudC5vbmltbXV0YWJsZXB1dChyZXEpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgICBjYXNlIENPTU1BTkRTLklNTVVUQUJMRV9HRVQ6IHsKICAgICAgICB0aGlzLl9wZXJzaXN0ZW50Lm9uaW1tdXRhYmxlZ2V0KHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBzdGF0aWMga2V5UGFpcihzZWVkKSB7CiAgICByZXR1cm4gY3JlYXRlS2V5UGFpcihzZWVkKQogIH0KCiAgc3RhdGljIGhhc2goZGF0YSkgewogICAgcmV0dXJuIGhhc2goZGF0YSkKICB9CgogIHN0YXRpYyBjb25uZWN0UmF3U3RyZWFtKGVuY3J5cHRlZFN0cmVhbSwgcmF3U3RyZWFtLCByZW1vdGVJZCkgewogICAgY29uc3Qgc3RyZWFtID0gZW5jcnlwdGVkU3RyZWFtLnJhd1N0cmVhbQoKICAgIGlmICghc3RyZWFtLmNvbm5lY3RlZCkgdGhyb3cgU1RSRUFNX05PVF9DT05ORUNURUQoKQoKICAgIHJhd1N0cmVhbS5jb25uZWN0KHN0cmVhbS5zb2NrZXQsIHJlbW90ZUlkLCBzdHJlYW0ucmVtb3RlUG9ydCwgc3RyZWFtLnJlbW90ZUhvc3QpCiAgfQoKICBjcmVhdGVSYXdTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIHRoaXMucmF3U3RyZWFtcy5hZGQob3B0cykKICB9CgogIGFzeW5jIF9yZXF1ZXN0QW5ub3VuY2Uoa2V5UGFpciwgZGh0LCB0YXJnZXQsIHRva2VuLCBmcm9tLCByZWxheUFkZHJlc3Nlcywgc2lnbiwgYnVtcCkgewogICAgY29uc3QgYW5uID0gewogICAgICBwZWVyOiB7CiAgICAgICAgcHVibGljS2V5OiBrZXlQYWlyLnB1YmxpY0tleSwKICAgICAgICByZWxheUFkZHJlc3NlczogcmVsYXlBZGRyZXNzZXMgfHwgW10KICAgICAgfSwKICAgICAgcmVmcmVzaDogbnVsbCwKICAgICAgc2lnbmF0dXJlOiBudWxsLAogICAgICBidW1wCiAgICB9CgogICAgYW5uLnNpZ25hdHVyZSA9IGF3YWl0IHNpZ24odGFyZ2V0LCB0b2tlbiwgZnJvbS5pZCwgYW5uLCBrZXlQYWlyKQoKICAgIGNvbnN0IHZhbHVlID0gYy5lbmNvZGUobS5hbm5vdW5jZSwgYW5uKQoKICAgIHJldHVybiBkaHQucmVxdWVzdCgKICAgICAgewogICAgICAgIHRva2VuLAogICAgICAgIHRhcmdldCwKICAgICAgICBjb21tYW5kOiBDT01NQU5EUy5BTk5PVU5DRSwKICAgICAgICB2YWx1ZQogICAgICB9LAogICAgICBmcm9tCiAgICApCiAgfQoKICBhc3luYyBfcmVxdWVzdFVuYW5ub3VuY2Uoa2V5UGFpciwgZGh0LCB0YXJnZXQsIHRva2VuLCBmcm9tLCBzaWduKSB7CiAgICBjb25zdCB1bmFubiA9IHsKICAgICAgcGVlcjogewogICAgICAgIHB1YmxpY0tleToga2V5UGFpci5wdWJsaWNLZXksCiAgICAgICAgcmVsYXlBZGRyZXNzZXM6IFtdCiAgICAgIH0sCiAgICAgIHNpZ25hdHVyZTogbnVsbAogICAgfQoKICAgIHVuYW5uLnNpZ25hdHVyZSA9IGF3YWl0IHNpZ24odGFyZ2V0LCB0b2tlbiwgZnJvbS5pZCwgdW5hbm4sIGtleVBhaXIpCgogICAgY29uc3QgdmFsdWUgPSBjLmVuY29kZShtLmFubm91bmNlLCB1bmFubikKCiAgICByZXR1cm4gZGh0LnJlcXVlc3QoCiAgICAgIHsKICAgICAgICB0b2tlbiwKICAgICAgICB0YXJnZXQsCiAgICAgICAgY29tbWFuZDogQ09NTUFORFMuVU5BTk5PVU5DRSwKICAgICAgICB2YWx1ZQogICAgICB9LAogICAgICBmcm9tCiAgICApCiAgfQp9CgpIeXBlckRIVC5CT09UU1RSQVAgPSBCT09UU1RSQVBfTk9ERVMKSHlwZXJESFQuRklSRVdBTEwgPSBGSVJFV0FMTAoKbW9kdWxlLmV4cG9ydHMgPSBIeXBlckRIVAoKZnVuY3Rpb24gbWFwTG9va3VwKG5vZGUpIHsKICBpZiAoIW5vZGUudmFsdWUpIHJldHVybiBudWxsCgogIGNvbnN0IGwgPSBjLmRlY29kZShtLmxvb2t1cFJhd1JlcGx5LCBub2RlLnZhbHVlKQoKICB0cnkgewogICAgcmV0dXJuIHsKICAgICAgdG9rZW46IG5vZGUudG9rZW4sCiAgICAgIGZyb206IG5vZGUuZnJvbSwKICAgICAgdG86IG5vZGUudG8sCiAgICAgIHBlZXJzOiBsLnBlZXJzLAogICAgICBidW1wOiBsLmJ1bXAKICAgIH0KICB9IGNhdGNoIHsKICAgIHJldHVybiBudWxsCiAgfQp9CgpmdW5jdGlvbiBtYXBGaW5kUGVlcihub2RlKSB7CiAgaWYgKCFub2RlLnZhbHVlKSByZXR1cm4gbnVsbAoKICB0cnkgewogICAgcmV0dXJuIHsKICAgICAgdG9rZW46IG5vZGUudG9rZW4sCiAgICAgIGZyb206IG5vZGUuZnJvbSwKICAgICAgdG86IG5vZGUudG8sCiAgICAgIHBlZXI6IGMuZGVjb2RlKG0ucGVlciwgbm9kZS52YWx1ZSkKICAgIH0KICB9IGNhdGNoIHsKICAgIHJldHVybiBudWxsCiAgfQp9CgpmdW5jdGlvbiBtYXBJbW11dGFibGUobm9kZSkgewogIGlmICghbm9kZS52YWx1ZSkgcmV0dXJuIG51bGwKCiAgcmV0dXJuIHsKICAgIHRva2VuOiBub2RlLnRva2VuLAogICAgZnJvbTogbm9kZS5mcm9tLAogICAgdG86IG5vZGUudG8sCiAgICB2YWx1ZTogbm9kZS52YWx1ZQogIH0KfQoKZnVuY3Rpb24gbWFwTXV0YWJsZShub2RlKSB7CiAgaWYgKCFub2RlLnZhbHVlKSByZXR1cm4gbnVsbAoKICB0cnkgewogICAgY29uc3QgeyBzZXEsIHZhbHVlLCBzaWduYXR1cmUgfSA9IGMuZGVjb2RlKG0ubXV0YWJsZUdldFJlc3BvbnNlLCBub2RlLnZhbHVlKQoKICAgIHJldHVybiB7CiAgICAgIHRva2VuOiBub2RlLnRva2VuLAogICAgICBmcm9tOiBub2RlLmZyb20sCiAgICAgIHRvOiBub2RlLnRvLAogICAgICBzZXEsCiAgICAgIHZhbHVlLAogICAgICBzaWduYXR1cmUKICAgIH0KICB9IGNhdGNoIHsKICAgIHJldHVybiBudWxsCiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIGZpbHRlck5vZGUobm9kZSkgewogIC8vIGFsd2F5cyBza2lwIHRoZXNlIHRlc3RuZXQgbm9kZXMgdGhhdCBnb3QgbWl4ZWQgaW4gYnkgYWNjaWRlbnQsIHVudGlsIHRoZXkgZ2V0IHVwZGF0ZWQKICByZXR1cm4gKAogICAgIShub2RlLnBvcnQgPT09IDQ5NzM4ICYmIChub2RlLmhvc3QgPT09ICcxMzQuMjA5LjI4Ljk4JyB8fCBub2RlLmhvc3QgPT09ICcxNjcuOTkuMTQyLjE4NScpKSAmJgogICAgIShub2RlLnBvcnQgPT09IDk0MDAgJiYgbm9kZS5ob3N0ID09PSAnMzUuMjMzLjQ3LjI1MicpICYmCiAgICAhKG5vZGUuaG9zdCA9PT0gJzE1MC4xMzYuMTQyLjExNicpCiAgKQp9Cgpjb25zdCBkZWZhdWx0TWF4U2l6ZSA9IDY1NTM2CmNvbnN0IGRlZmF1bHRNYXhBZ2UgPSAyMCAqIDYwICogMTAwMCAvLyAyMCBtaW51dGVzCgpmdW5jdGlvbiBkZWZhdWx0Q2FjaGVPcHRzKG9wdHMpIHsKICBjb25zdCBtYXhTaXplID0gb3B0cy5tYXhTaXplIHx8IGRlZmF1bHRNYXhTaXplCiAgY29uc3QgbWF4QWdlID0gb3B0cy5tYXhBZ2UgfHwgZGVmYXVsdE1heEFnZQoKICByZXR1cm4gewogICAgcm91dGVyOiB7CiAgICAgIGZvcndhcmRzOiB7IG1heFNpemUsIG1heEFnZSB9CiAgICB9LAogICAgcmVsYXlBZGRyZXNzZXM6IHsgbWF4U2l6ZTogTWF0aC5taW4obWF4U2l6ZSwgNTEyKSwgbWF4QWdlOiAwIH0sCiAgICBwZXJzaXN0ZW50OiB7CiAgICAgIHJlY29yZHM6IHsgbWF4U2l6ZSwgbWF4QWdlIH0sCiAgICAgIHJlZnJlc2hlczogeyBtYXhTaXplLCBtYXhBZ2UgfSwKICAgICAgbXV0YWJsZXM6IHsKICAgICAgICBtYXhTaXplOiAobWF4U2l6ZSAvIDIpIHwgMCwKICAgICAgICBtYXhBZ2U6IG9wdHMubWF4QWdlIHx8IDQ4ICogNjAgKiA2MCAqIDEwMDAgLy8gNDggaG91cnMKICAgICAgfSwKICAgICAgaW1tdXRhYmxlczogewogICAgICAgIG1heFNpemU6IChtYXhTaXplIC8gMikgfCAwLAogICAgICAgIG1heEFnZTogb3B0cy5tYXhBZ2UgfHwgNDggKiA2MCAqIDYwICogMTAwMCAvLyA0OCBob3VycwogICAgICB9LAogICAgICBidW1wczogeyBtYXhTaXplLCBtYXhBZ2UgfQogICAgfQogIH0KfQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgU2lnbmFsID0gcmVxdWlyZSgnc2lnbmFsLXByb21pc2UnKQpjb25zdCB7IGVuY29kZVVuc2xhYiB9ID0gcmVxdWlyZSgnLi9lbmNvZGUnKQpjb25zdCBTbGVlcGVyID0gcmVxdWlyZSgnLi9zbGVlcGVyJykKY29uc3QgbSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMnKQpjb25zdCBQZXJzaXN0ZW50ID0gcmVxdWlyZSgnLi9wZXJzaXN0ZW50JykKY29uc3QgeyBDT01NQU5EUyB9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKY29uc3QgTUlOX0FDVElWRSA9IDMKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQW5ub3VuY2VyIHsKICBjb25zdHJ1Y3RvcihkaHQsIGtleVBhaXIsIHRhcmdldCwgb3B0cyA9IHt9KSB7CiAgICB0aGlzLmRodCA9IGRodAogICAgdGhpcy5rZXlQYWlyID0ga2V5UGFpcgogICAgdGhpcy50YXJnZXQgPSB0YXJnZXQKICAgIHRoaXMucmVsYXlzID0gW10KICAgIHRoaXMucmVsYXlBZGRyZXNzZXMgPSBbXQogICAgdGhpcy5zdG9wcGVkID0gZmFsc2UKICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKICAgIHRoaXMucmVjb3JkID0gZW5jb2RlVW5zbGFiKG0ucGVlciwgeyBwdWJsaWNLZXk6IGtleVBhaXIucHVibGljS2V5LCByZWxheUFkZHJlc3NlczogW10gfSkKICAgIHRoaXMub25saW5lID0gbmV3IFNpZ25hbCgpCgogICAgdGhpcy5fcmVmcmVzaGluZyA9IGZhbHNlCiAgICB0aGlzLl9jbG9zZXN0Tm9kZXMgPSBudWxsCiAgICB0aGlzLl9hY3RpdmUgPSBudWxsCiAgICB0aGlzLl9zbGVlcGVyID0gbmV3IFNsZWVwZXIoKQogICAgdGhpcy5fcmVzdW1lZCA9IG5ldyBTaWduYWwoKQogICAgdGhpcy5fc2lnbkFubm91bmNlID0gb3B0cy5zaWduQW5ub3VuY2UgfHwgUGVyc2lzdGVudC5zaWduQW5ub3VuY2UKICAgIHRoaXMuX3NpZ25VbmFubm91bmNlID0gb3B0cy5zaWduVW5hbm5vdW5jZSB8fCBQZXJzaXN0ZW50LnNpZ25VbmFubm91bmNlCiAgICB0aGlzLl91cGRhdGluZyA9IG51bGwKICAgIHRoaXMuX2FjdGl2ZVF1ZXJ5ID0gbnVsbAogICAgdGhpcy5fdW5hbm5vdW5jaW5nID0gbnVsbAoKICAgIHRoaXMuX3NlcnZlclJlbGF5cyA9IFtuZXcgTWFwKCksIG5ldyBNYXAoKSwgbmV3IE1hcCgpXQogIH0KCiAgaXNSZWxheShhZGRyKSB7CiAgICBjb25zdCBpZCA9IGFkZHIuaG9zdCArICc6JyArIGFkZHIucG9ydAogICAgY29uc3QgW2EsIGIsIGNdID0gdGhpcy5fc2VydmVyUmVsYXlzCiAgICByZXR1cm4gYS5oYXMoaWQpIHx8IGIuaGFzKGlkKSB8fCBjLmhhcyhpZCkKICB9CgogIGFzeW5jIHN1c3BlbmQoeyBsb2cgPSBub29wIH0gPSB7fSkgewogICAgaWYgKHRoaXMuc3VzcGVuZGVkKSByZXR1cm4KICAgIHRoaXMuc3VzcGVuZGVkID0gdHJ1ZQoKICAgIGxvZygnU3VzcGVuZGluZyBhbm5vdW5jZXInKQoKICAgIC8vIFN1c3BlbmQgaGFzIGl0cyBvd24gc2xlZXAgbG9naWMKICAgIC8vIHNvIHdlIGRvbid0IHdhbnQgdG8gaGFuZyBvbiB0aGlzIG9uZQogICAgdGhpcy5vbmxpbmUubm90aWZ5KCkKCiAgICBpZiAodGhpcy5fYWN0aXZlUXVlcnkpIHRoaXMuX2FjdGl2ZVF1ZXJ5LmRlc3Ryb3koKQoKICAgIHRoaXMuX3NsZWVwZXIucmVzdW1lKCkKICAgIGlmICh0aGlzLl91cGRhdGluZykgYXdhaXQgdGhpcy5fdXBkYXRpbmcKICAgIGxvZygnU3VzcGVuZGluZyBhbm5vdW5jZXIgKHBvc3QgdXBkYXRlKScpCgogICAgaWYgKHRoaXMuc3VzcGVuZGVkID09PSBmYWxzZSB8fCB0aGlzLnN0b3BwZWQpIHJldHVybgoKICAgIGxvZygnU3VzcGVuZGluZyBhbm5vdW5jZXIgKHByZSB1bmFubm91bmNlKScpCiAgICBhd2FpdCB0aGlzLl91bmFubm91bmNlQ3VycmVudCgpCiAgICBsb2coJ1N1c3BlbmRpbmcgYW5ub3VuY2VyIChwb3N0IHVuYW5ub3VuY2UpJykKICB9CgogIHJlc3VtZSgpIHsKICAgIGlmICghdGhpcy5zdXNwZW5kZWQpIHJldHVybgogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQoKICAgIHRoaXMucmVmcmVzaCgpCiAgICB0aGlzLl9zbGVlcGVyLnJlc3VtZSgpCiAgICB0aGlzLl9yZXN1bWVkLm5vdGlmeSgpCiAgfQoKICByZWZyZXNoKCkgewogICAgaWYgKHRoaXMuc3RvcHBlZCkgcmV0dXJuCiAgICB0aGlzLl9yZWZyZXNoaW5nID0gdHJ1ZQogIH0KCiAgYXN5bmMgc3RhcnQoKSB7CiAgICBpZiAodGhpcy5zdG9wcGVkKSByZXR1cm4KICAgIHRoaXMuX2FjdGl2ZSA9IHRoaXMuX3J1blVwZGF0ZSgpCiAgICBhd2FpdCB0aGlzLl9hY3RpdmUKICAgIGlmICh0aGlzLnN0b3BwZWQpIHJldHVybgogICAgdGhpcy5fYWN0aXZlID0gdGhpcy5fYmFja2dyb3VuZCgpCiAgfQoKICBhc3luYyBzdG9wKCkgewogICAgdGhpcy5zdG9wcGVkID0gdHJ1ZQogICAgdGhpcy5vbmxpbmUubm90aWZ5KCkgLy8gQnJlYWsgb3V0IG9mIHRoZSBfYmFja2dyb3VuZCBsb29wIGlmIHdlJ3JlIG9mZmxpbmUKICAgIHRoaXMuX3NsZWVwZXIucmVzdW1lKCkKICAgIHRoaXMuX3Jlc3VtZWQubm90aWZ5KCkKICAgIGF3YWl0IHRoaXMuX2FjdGl2ZQogICAgYXdhaXQgdGhpcy5fdW5hbm5vdW5jZUN1cnJlbnQoKQogIH0KCiAgYXN5bmMgX3VuYW5ub3VuY2VDdXJyZW50KCkgewogICAgd2hpbGUgKHRoaXMuX3VuYW5ub3VuY2luZyAhPT0gbnVsbCkgYXdhaXQgdGhpcy5fdW5hbm5vdW5jaW5nCiAgICBjb25zdCB1biA9ICh0aGlzLl91bmFubm91bmNpbmcgPSB0aGlzLl91bmFubm91bmNlQWxsKHRoaXMuX3NlcnZlclJlbGF5c1syXS52YWx1ZXMoKSkpCiAgICBhd2FpdCB0aGlzLl91bmFubm91bmNpbmcKICAgIGlmICh1biA9PT0gdGhpcy5fdW5hbm5vdW5jaW5nKSB0aGlzLl91bmFubm91bmNpbmcgPSBudWxsCiAgfQoKICBhc3luYyBfYmFja2dyb3VuZCgpIHsKICAgIHdoaWxlICghdGhpcy5kaHQuZGVzdHJveWVkICYmICF0aGlzLnN0b3BwZWQpIHsKICAgICAgdHJ5IHsKICAgICAgICB0aGlzLl9yZWZyZXNoaW5nID0gZmFsc2UKCiAgICAgICAgLy8gfjVtaW4gKy0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwMCAmJiAhdGhpcy5zdG9wcGVkICYmICF0aGlzLl9yZWZyZXNoaW5nICYmICF0aGlzLnN1c3BlbmRlZDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwaW5ncyA9IFtdCgogICAgICAgICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMuX3NlcnZlclJlbGF5c1syXS52YWx1ZXMoKSkgewogICAgICAgICAgICBwaW5ncy5wdXNoKHRoaXMuZGh0LnBpbmcobm9kZSkpCiAgICAgICAgICB9CgogICAgICAgICAgY29uc3QgYWN0aXZlID0gYXdhaXQgcmVzb2x2ZWQocGluZ3MpCiAgICAgICAgICBpZiAoYWN0aXZlIDwgTWF0aC5taW4ocGluZ3MubGVuZ3RoLCBNSU5fQUNUSVZFKSkgewogICAgICAgICAgICB0aGlzLnJlZnJlc2goKSAvLyB3ZSBsb3N0IHRvbyBtYW55IHJlbGF5IG5vZGVzLCByZXRyeSBhbGwKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodGhpcy5zdG9wcGVkKSByZXR1cm4KCiAgICAgICAgICBpZiAoIXRoaXMuc3VzcGVuZGVkICYmICF0aGlzLl9yZWZyZXNoaW5nKSBhd2FpdCB0aGlzLl9zbGVlcGVyLnBhdXNlKDMwMDApCiAgICAgICAgfQoKICAgICAgICB3aGlsZSAoIXRoaXMuc3RvcHBlZCAmJiB0aGlzLnN1c3BlbmRlZCkgYXdhaXQgdGhpcy5fcmVzdW1lZC53YWl0KCkKCiAgICAgICAgaWYgKCF0aGlzLnN0b3BwZWQpIGF3YWl0IHRoaXMuX3J1blVwZGF0ZSgpCgogICAgICAgIHdoaWxlICghdGhpcy5kaHQub25saW5lICYmICF0aGlzLnN0b3BwZWQgJiYgIXRoaXMuc3VzcGVuZGVkKSB7CiAgICAgICAgICAvLyBCZWluZyBvZmZsaW5lIGNhbiBtYWtlIF9iYWNrZ3JvdW5kIHJlcGVhdCB2ZXJ5IHF1aWNrbHkKICAgICAgICAgIC8vIFNvIHdhaXQgdW50aWwgd2UncmUgYmFjayBvbmxpbmUKICAgICAgICAgIGF3YWl0IHRoaXMub25saW5lLndhaXQoKQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBfcnVuVXBkYXRlKCkgewogICAgdGhpcy5fdXBkYXRpbmcgPSB0aGlzLl91cGRhdGUoKQogICAgYXdhaXQgdGhpcy5fdXBkYXRpbmcKICAgIHRoaXMuX3VwZGF0aW5nID0gbnVsbAogIH0KCiAgYXN5bmMgX3VwZGF0ZSgpIHsKICAgIHdoaWxlICh0aGlzLl91bmFubm91bmNpbmcpIGF3YWl0IHRoaXMuX3VuYW5ub3VuY2luZwoKICAgIHRoaXMuX2N5Y2xlKCkKCiAgICBjb25zdCBxID0gKHRoaXMuX2FjdGl2ZVF1ZXJ5ID0gdGhpcy5kaHQuZmluZFBlZXIodGhpcy50YXJnZXQsIHsKICAgICAgaGFzaDogZmFsc2UsCiAgICAgIG5vZGVzOiB0aGlzLl9jbG9zZXN0Tm9kZXMKICAgIH0pKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHEuZmluaXNoZWQoKQogICAgfSBjYXRjaCB7CiAgICAgIC8vIGlnbm9yZSBmYWlsdXJlcy4uLgogICAgfQoKICAgIHRoaXMuX2FjdGl2ZVF1ZXJ5ID0gbnVsbAoKICAgIGlmICh0aGlzLnN0b3BwZWQgfHwgdGhpcy5zdXNwZW5kZWQpIHJldHVybgoKICAgIGNvbnN0IGFubiA9IFtdCiAgICBjb25zdCByZXBsaWVzID0gcGlja0Jlc3QocS5jbG9zZXN0UmVwbGllcykKCiAgICBjb25zdCByZWxheXMgPSBbXQogICAgY29uc3QgcmVsYXlBZGRyZXNzZXMgPSBbXQoKICAgIGlmICghdGhpcy5kaHQuZmlyZXdhbGxlZCkgewogICAgICBjb25zdCBhZGRyID0gdGhpcy5kaHQucmVtb3RlQWRkcmVzcygpCiAgICAgIGlmIChhZGRyKSByZWxheUFkZHJlc3Nlcy5wdXNoKGFkZHIpCiAgICB9CgogICAgZm9yIChjb25zdCBtc2cgb2YgcmVwbGllcykgewogICAgICBhbm4ucHVzaCh0aGlzLl9jb21taXQobXNnLCByZWxheXMsIHJlbGF5QWRkcmVzc2VzKSkKICAgIH0KCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoYW5uKQogICAgaWYgKHRoaXMuc3RvcHBlZCB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCgogICAgdGhpcy5fY2xvc2VzdE5vZGVzID0gcS5jbG9zZXN0Tm9kZXMKICAgIHRoaXMucmVsYXlzID0gcmVsYXlzCiAgICB0aGlzLnJlbGF5QWRkcmVzc2VzID0gcmVsYXlBZGRyZXNzZXMKCiAgICBjb25zdCByZW1vdmVkID0gW10KICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHRoaXMuX3NlcnZlclJlbGF5c1sxXSkgewogICAgICBpZiAoIXRoaXMuX3NlcnZlclJlbGF5c1syXS5oYXMoa2V5KSkgcmVtb3ZlZC5wdXNoKHZhbHVlKQogICAgfQoKICAgIGF3YWl0IHRoaXMuX3VuYW5ub3VuY2VBbGwocmVtb3ZlZCkKICB9CgogIF91bmFubm91bmNlQWxsKHJlbGF5cykgewogICAgY29uc3QgdW5hbm4gPSBbXQogICAgZm9yIChjb25zdCByIG9mIHJlbGF5cykgdW5hbm4ucHVzaCh0aGlzLl91bmFubm91bmNlKHIpKQogICAgcmV0dXJuIFByb21pc2UuYWxsU2V0dGxlZCh1bmFubikKICB9CgogIGFzeW5jIF91bmFubm91bmNlKHRvKSB7CiAgICBjb25zdCB1bmFubiA9IHsKICAgICAgcGVlcjogewogICAgICAgIHB1YmxpY0tleTogdGhpcy5rZXlQYWlyLnB1YmxpY0tleSwKICAgICAgICByZWxheUFkZHJlc3NlczogW10KICAgICAgfSwKICAgICAgcmVmcmVzaDogbnVsbCwKICAgICAgc2lnbmF0dXJlOiBudWxsCiAgICB9CgogICAgY29uc3QgeyBmcm9tLCB0b2tlbiwgdmFsdWUgfSA9IGF3YWl0IHRoaXMuZGh0LnJlcXVlc3QoCiAgICAgIHsKICAgICAgICB0b2tlbjogbnVsbCwKICAgICAgICBjb21tYW5kOiBDT01NQU5EUy5GSU5EX1BFRVIsCiAgICAgICAgdGFyZ2V0OiB0aGlzLnRhcmdldCwKICAgICAgICB2YWx1ZTogbnVsbAogICAgICB9LAogICAgICB0bwogICAgKQoKICAgIGlmICghdG9rZW4gfHwgIWZyb20uaWQgfHwgIXZhbHVlKSByZXR1cm4KCiAgICB1bmFubi5zaWduYXR1cmUgPSBhd2FpdCB0aGlzLl9zaWduVW5hbm5vdW5jZSh0aGlzLnRhcmdldCwgdG9rZW4sIGZyb20uaWQsIHVuYW5uLCB0aGlzLmtleVBhaXIpCgogICAgYXdhaXQgdGhpcy5kaHQucmVxdWVzdCgKICAgICAgewogICAgICAgIHRva2VuLAogICAgICAgIGNvbW1hbmQ6IENPTU1BTkRTLlVOQU5OT1VOQ0UsCiAgICAgICAgdGFyZ2V0OiB0aGlzLnRhcmdldCwKICAgICAgICB2YWx1ZTogYy5lbmNvZGUobS5hbm5vdW5jZSwgdW5hbm4pCiAgICAgIH0sCiAgICAgIHRvCiAgICApCiAgfQoKICBhc3luYyBfY29tbWl0KG1zZywgcmVsYXlzLCByZWxheUFkZHJlc3NlcykgewogICAgY29uc3QgYW5uID0gewogICAgICBwZWVyOiB7CiAgICAgICAgcHVibGljS2V5OiB0aGlzLmtleVBhaXIucHVibGljS2V5LAogICAgICAgIHJlbGF5QWRkcmVzc2VzOiBbXQogICAgICB9LAogICAgICByZWZyZXNoOiBudWxsLAogICAgICBzaWduYXR1cmU6IG51bGwKICAgIH0KCiAgICBhbm4uc2lnbmF0dXJlID0gYXdhaXQgdGhpcy5fc2lnbkFubm91bmNlKHRoaXMudGFyZ2V0LCBtc2cudG9rZW4sIG1zZy5mcm9tLmlkLCBhbm4sIHRoaXMua2V5UGFpcikKCiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmRodC5yZXF1ZXN0KAogICAgICB7CiAgICAgICAgdG9rZW46IG1zZy50b2tlbiwKICAgICAgICBjb21tYW5kOiBDT01NQU5EUy5BTk5PVU5DRSwKICAgICAgICB0YXJnZXQ6IHRoaXMudGFyZ2V0LAogICAgICAgIHZhbHVlOiBjLmVuY29kZShtLmFubm91bmNlLCBhbm4pCiAgICAgIH0sCiAgICAgIG1zZy5mcm9tCiAgICApCgogICAgaWYgKHJlcy5lcnJvciAhPT0gMCkgcmV0dXJuCgogICAgaWYgKHJlbGF5QWRkcmVzc2VzLmxlbmd0aCA8IDMpIHJlbGF5QWRkcmVzc2VzLnB1c2goeyBob3N0OiBtc2cuZnJvbS5ob3N0LCBwb3J0OiBtc2cuZnJvbS5wb3J0IH0pCiAgICByZWxheXMucHVzaCh7IHJlbGF5QWRkcmVzczogbXNnLmZyb20sIHBlZXJBZGRyZXNzOiBtc2cudG8gfSkKCiAgICB0aGlzLl9zZXJ2ZXJSZWxheXNbMl0uc2V0KG1zZy5mcm9tLmhvc3QgKyAnOicgKyBtc2cuZnJvbS5wb3J0LCBtc2cuZnJvbSkKICB9CgogIF9jeWNsZSgpIHsKICAgIGNvbnN0IHRtcCA9IHRoaXMuX3NlcnZlclJlbGF5c1swXQogICAgdGhpcy5fc2VydmVyUmVsYXlzWzBdID0gdGhpcy5fc2VydmVyUmVsYXlzWzFdCiAgICB0aGlzLl9zZXJ2ZXJSZWxheXNbMV0gPSB0aGlzLl9zZXJ2ZXJSZWxheXNbMl0KICAgIHRoaXMuX3NlcnZlclJlbGF5c1syXSA9IHRtcAogICAgdG1wLmNsZWFyKCkKICB9Cn0KCmZ1bmN0aW9uIHJlc29sdmVkKHBzKSB7CiAgbGV0IHJlcGxpZWQgPSAwCiAgbGV0IHRpY2tzID0gcHMubGVuZ3RoICsgMQoKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgIGZvciAoY29uc3QgcCBvZiBwcykgcC50aGVuKHB1c2gsIHRpY2spCiAgICB0aWNrKCkKCiAgICBmdW5jdGlvbiBwdXNoKHYpIHsKICAgICAgcmVwbGllZCsrCiAgICAgIHRpY2soKQogICAgfQoKICAgIGZ1bmN0aW9uIHRpY2soKSB7CiAgICAgIGlmICgtLXRpY2tzID09PSAwKSByZXNvbHZlKHJlcGxpZWQpCiAgICB9CiAgfSkKfQoKZnVuY3Rpb24gcGlja0Jlc3QocmVwbGllcykgewogIC8vIFRPRE86IHBpY2sgdGhlIG9uZXMgY2xvc2VzdCB0byB1cyBSVFQgd2lzZQogIHJldHVybiByZXBsaWVzLnNsaWNlKDAsIDMpCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCBOb2lzZVNlY3JldFN0cmVhbSA9IHJlcXVpcmUoJ0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0nKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCByZWxheSA9IHJlcXVpcmUoJ2JsaW5kLXJlbGF5JykKY29uc3QgeyBpc1ByaXZhdGUsIGlzQm9nb24gfSA9IHJlcXVpcmUoJ2JvZ29uJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCB1bnNsYWIgPSByZXF1aXJlKCd1bnNsYWInKQpjb25zdCBTZW1hcGhvcmUgPSByZXF1aXJlKCcuL3NlbWFwaG9yZScpCmNvbnN0IE5vaXNlV3JhcCA9IHJlcXVpcmUoJy4vbm9pc2Utd3JhcCcpCmNvbnN0IFNlY3VyZVBheWxvYWQgPSByZXF1aXJlKCcuL3NlY3VyZS1wYXlsb2FkJykKY29uc3QgSG9sZXB1bmNoZXIgPSByZXF1aXJlKCcuL2hvbGVwdW5jaGVyJykKY29uc3QgU2xlZXBlciA9IHJlcXVpcmUoJy4vc2xlZXBlcicpCmNvbnN0IHsgRklSRVdBTEwsIEVSUk9SIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCmNvbnN0IHsgdW5zbGFiYmVkSGFzaCB9ID0gcmVxdWlyZSgnLi9jcnlwdG8nKQpjb25zdCB7CiAgQ0FOTk9UX0hPTEVQVU5DSCwKICBIQU5EU0hBS0VfSU5WQUxJRCwKICBIT0xFUFVOQ0hfQUJPUlRFRCwKICBIT0xFUFVOQ0hfSU5WQUxJRCwKICBIT0xFUFVOQ0hfUFJPQkVfVElNRU9VVCwKICBIT0xFUFVOQ0hfRE9VQkxFX1JBTkRPTUlaRURfTkFUUywKICBQRUVSX0NPTk5FQ1RJT05fRkFJTEVELAogIFBFRVJfTk9UX0ZPVU5ELAogIFJFTU9URV9BQk9SVEVELAogIFJFTU9URV9OT1RfSE9MRVBVTkNIQUJMRSwKICBSRU1PVEVfTk9UX0hPTEVQVU5DSElORywKICBTRVJWRVJfRVJST1IsCiAgU0VSVkVSX0lOQ09NUEFUSUJMRSwKICBSRUxBWV9BQk9SVEVELAogIFNVU1BFTkRFRAp9ID0gcmVxdWlyZSgnLi9lcnJvcnMnKQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBjb25uZWN0KGRodCwgcHVibGljS2V5LCBvcHRzID0ge30pIHsKICBjb25zdCBwb29sID0gb3B0cy5wb29sIHx8IG51bGwKCiAgaWYgKHBvb2wgJiYgcG9vbC5oYXMocHVibGljS2V5KSkgcmV0dXJuIHBvb2wuZ2V0KHB1YmxpY0tleSkKCiAgcHVibGljS2V5ID0gdW5zbGFiKHB1YmxpY0tleSkKCiAgY29uc3Qga2V5UGFpciA9IG9wdHMua2V5UGFpciB8fCBkaHQuZGVmYXVsdEtleVBhaXIKICBjb25zdCByZWxheVRocm91Z2ggPSBzZWxlY3RSZWxheShvcHRzLnJlbGF5VGhyb3VnaCB8fCBudWxsKQogIGNvbnN0IGVuY3J5cHRlZFNvY2tldCA9IChvcHRzLmNyZWF0ZVNlY3JldFN0cmVhbSB8fCBkZWZhdWx0Q3JlYXRlU2VjcmV0U3RyZWFtKSh0cnVlLCBudWxsLCB7CiAgICBwdWJsaWNLZXk6IGtleVBhaXIucHVibGljS2V5LAogICAgcmVtb3RlUHVibGljS2V5OiBwdWJsaWNLZXksCiAgICBhdXRvU3RhcnQ6IGZhbHNlLAogICAga2VlcEFsaXZlOiBkaHQuY29ubmVjdGlvbktlZXBBbGl2ZQogIH0pCgogIC8vIGluIGNhc2UgYSBzb2NrZXQgaXMgbWFkZSBkdXJpbmcgc3VzcGVuZGVkIHN0YXRlLCBkZXN0cm95IGl0IGltbWVkaWF0ZWx5CiAgaWYgKGRodC5zdXNwZW5kZWQgfHwgIWRodC5fY29ubmVjdGFibGUpIHsKICAgIGVuY3J5cHRlZFNvY2tldC5kZXN0cm95KFNVU1BFTkRFRCgpKQogICAgcmV0dXJuIGVuY3J5cHRlZFNvY2tldAogIH0KCiAgaWYgKHBvb2wpIHBvb2wuX2F0dGFjaFN0cmVhbShlbmNyeXB0ZWRTb2NrZXQsIGZhbHNlKQoKICBjb25zdCBpZCA9IGI0YS50b1N0cmluZyhwdWJsaWNLZXksICdoZXgnKQogIGNvbnN0IGMgPSB7CiAgICBpZCwKICAgIGRodCwKICAgIHNlc3Npb246IGRodC5zZXNzaW9uKCksCiAgICByZWxheUFkZHJlc3Nlczogb3B0cy5yZWxheUFkZHJlc3NlcyB8fCBbXSwKICAgIHJlbW90ZVJlbGF5QWRkcmVzc2VzOiBbXSwKICAgIHBvb2wsCiAgICByb3VuZDogMCwKICAgIHRhcmdldDogdW5zbGFiYmVkSGFzaChwdWJsaWNLZXkpLAogICAgcmVtb3RlUHVibGljS2V5OiBwdWJsaWNLZXksCiAgICByZXVzYWJsZVNvY2tldDogISFvcHRzLnJldXNhYmxlU29ja2V0LAogICAgaGFuZHNoYWtlOiAob3B0cy5jcmVhdGVIYW5kc2hha2UgfHwgZGVmYXVsdENyZWF0ZUhhbmRzaGFrZSkoa2V5UGFpciwgcHVibGljS2V5KSwKICAgIHJlcXVlc3Q6IG51bGwsCiAgICByZXF1ZXN0aW5nOiBmYWxzZSwKICAgIGxhbjogb3B0cy5sb2NhbENvbm5lY3Rpb24gIT09IGZhbHNlLAogICAgZmlyZXdhbGw6IEZJUkVXQUxMLlVOS05PV04sCiAgICByYXdTdHJlYW06IGRodC5jcmVhdGVSYXdTdHJlYW0oeyBmcmFtZWQ6IHRydWUsIGZpcmV3YWxsIH0pLAogICAgY29ubmVjdDogbnVsbCwKICAgIHF1ZXJ5OiBudWxsLAogICAgcHVuY2hlcjogbnVsbCwKICAgIHBheWxvYWQ6IG51bGwsCiAgICBwYXNzaXZlQ29ubmVjdFRpbWVvdXQ6IG51bGwsCiAgICBzZXJ2ZXJTb2NrZXQ6IG51bGwsCiAgICBzZXJ2ZXJBZGRyZXNzOiBudWxsLAogICAgb25zb2NrZXQ6IG51bGwsCiAgICBzbGVlcGVyOiBuZXcgU2xlZXBlcigpLAogICAgZW5jcnlwdGVkU29ja2V0LAoKICAgIC8vIFJlbGF5IHN0YXRlCiAgICByZWxheVRpbWVvdXQ6IG51bGwsCiAgICByZWxheVRocm91Z2gsCiAgICByZWxheVRva2VuOiByZWxheVRocm91Z2ggPyByZWxheS50b2tlbigpIDogbnVsbCwKICAgIHJlbGF5U29ja2V0OiBudWxsLAogICAgcmVsYXlDbGllbnQ6IG51bGwsCiAgICByZWxheVBhaXJlZDogZmFsc2UsCiAgICByZWxheUtlZXBBbGl2ZTogb3B0cy5yZWxheUtlZXBBbGl2ZSB8fCA1MDAwCiAgfQoKICAvLyBJZiB0aGUgcmF3IHN0cmVhbSByZWNlaXZlcyBhbiBlcnJvciBzaWduYWwgcHJlIGNvbm5lY3QgKGllIGZyb20gdGhlIGZpcmV3YWxsIGhvb2spLCBtYWtlIHN1cmUKICAvLyB0byBmb3J3YXJkIHRoYXQgdG8gdGhlIGVuY3J5cHRlZCBzb2NrZXQgZm9yIHByb3BlciB0ZWFyZG93bgogIGMucmF3U3RyZWFtLm9uKCdlcnJvcicsIGF1dG9EZXN0cm95KQogIGMucmF3U3RyZWFtLm9uY2UoJ2Nvbm5lY3QnLCAoKSA9PiB7CiAgICBjLnJhd1N0cmVhbS5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBhdXRvRGVzdHJveSkKICB9KQoKICBlbmNyeXB0ZWRTb2NrZXQub24oJ2Nsb3NlJywgZnVuY3Rpb24gKCkgewogICAgaWYgKGMucGFzc2l2ZUNvbm5lY3RUaW1lb3V0KSBjbGVhclBhc3NpdmVDb25uZWN0VGltZW91dChjKQogICAgaWYgKGMucXVlcnkpIGMucXVlcnkuZGVzdHJveSgpCiAgICBpZiAoYy5wdW5jaGVyKSBjLnB1bmNoZXIuZGVzdHJveSgpCiAgICBpZiAoYy5yYXdTdHJlYW0pIGMucmF3U3RyZWFtLmRlc3Ryb3koKQogICAgYy5zZXNzaW9uLmRlc3Ryb3koKQogICAgYy5zbGVlcGVyLnJlc3VtZSgpCiAgfSkKCiAgLy8gU2FmZSB0byBydW4gaW4gdGhlIGJhY2tncm91bmQgLSBuZXZlciB0aHJvd3MKICBpZiAoZGh0LnN1c3BlbmRlZCkgZW5jcnlwdGVkU29ja2V0LmRlc3Ryb3koU1VTUEVOREVEKCkpCiAgZWxzZSBjb25uZWN0QW5kSG9sZXB1bmNoKGMsIG9wdHMpCgogIHJldHVybiBlbmNyeXB0ZWRTb2NrZXQKCiAgZnVuY3Rpb24gYXV0b0Rlc3Ryb3koZXJyKSB7CiAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgZXJyKQogIH0KCiAgZnVuY3Rpb24gZmlyZXdhbGwoc29ja2V0LCBwb3J0LCBob3N0KSB7CiAgICAvLyBDaGVjayBpZiB0aGUgdHJhZmZpYyBvcmlnaW5hdGVkIGZyb20gdGhlIHNvY2tldCBvbiB3aGljaCB3ZSdyZSBleHBlY3RpbmcgcmVsYXkgdHJhZmZpYy4gSWYgc28sCiAgICAvLyB3ZSBoYXZlbid0IGhvbGUgcHVuY2hlZCB5ZXQgYW5kIHRoZSBvdGhlciBzaWRlIGlzIGp1c3Qgc2VuZGluZyB1cyB0cmFmZmljIHRocm91Z2ggdGhlIHJlbGF5LgogICAgaWYgKGMucmVsYXlTb2NrZXQgJiYgaXNSZWxheShjLnJlbGF5U29ja2V0LCBzb2NrZXQsIHBvcnQsIGhvc3QpKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmIChjLm9uc29ja2V0KSB7CiAgICAgIGMub25zb2NrZXQoc29ja2V0LCBwb3J0LCBob3N0KQogICAgfSBlbHNlIHsKICAgICAgYy5zZXJ2ZXJTb2NrZXQgPSBzb2NrZXQKICAgICAgYy5zZXJ2ZXJBZGRyZXNzID0geyBwb3J0LCBob3N0IH0KICAgIH0KICAgIHJldHVybiBmYWxzZQogIH0KfQoKZnVuY3Rpb24gaXNEb25lKGMpIHsKICAvLyB3ZSBhcmUgZGVzdHJveWluZyBvciB0aGUgcHVuY2hlciBpcyBjb25uZWN0ZWQgLSBkb25lCiAgaWYgKGMuZW5jcnlwdGVkU29ja2V0LmRlc3Ryb3lpbmcgfHwgISEoYy5wdW5jaGVyICYmIGMucHVuY2hlci5jb25uZWN0ZWQpKSB7CiAgICByZXR1cm4gdHJ1ZQogIH0KICAvLyBub3QgZGVzdHJveWluZywgYnV0IG5vIHJhdyBzdHJlYW0gLSBkZWYgbm90IGRvbmUKICBpZiAoYy5lbmNyeXB0ZWRTb2NrZXQucmF3U3RyZWFtID09PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2UKICB9CiAgLy8gd2UgYXJlIHJlbGF5ZWQsIGJ1dCB0aGUgcHVuY2hlciBpcyBub3QgZG9uZSB5ZXQKICBpZiAoYy5yZWxheVNvY2tldCAmJiAhIShjLnB1bmNoZXIgJiYgIWMucHVuY2hlci5jb25uZWN0ZWQgJiYgIWMucHVuY2hlci5kZXN0cm95ZWQpKSB7CiAgICByZXR1cm4gZmFsc2UKICB9CiAgLy8gd2UgYXJlIGRvbmUKICByZXR1cm4gdHJ1ZQp9Cgphc3luYyBmdW5jdGlvbiByZXRyeVJvdXRlKGMsIHJvdXRlKSB7CiAgY29uc3QgcmVmID0gYy5kaHQuX3NvY2tldFBvb2wubG9va3VwKHJvdXRlLnNvY2tldCkKCiAgaWYgKCFyZWYpIHsKICAgIGlmIChyb3V0ZS5zb2NrZXQgPT09IGMuZGh0LnNvY2tldCkgewogICAgICBhd2FpdCBjb25uZWN0VGhyb3VnaE5vZGUoYywgcm91dGUuYWRkcmVzcywgYy5kaHQuc29ja2V0KQogICAgfQogICAgcmV0dXJuCiAgfQoKICByZWYuYWN0aXZlKCkKCiAgdHJ5IHsKICAgIGF3YWl0IGNvbm5lY3RUaHJvdWdoTm9kZShjLCByb3V0ZS5hZGRyZXNzLCByb3V0ZS5zb2NrZXQpCiAgfSBjYXRjaCB7CiAgICAvLyBpZiBlcnJvciwganVzdCBpZ25vcmUsIGFuZCBjb250aW51ZSB0aHJvdWdoIHRoZSBleGlzdGluZyBzdHJhdAogIH0KCiAgcmVmLmluYWN0aXZlKCkKfQoKYXN5bmMgZnVuY3Rpb24gY29ubmVjdEFuZEhvbGVwdW5jaChjLCBvcHRzKSB7CiAgY29uc3Qgcm91dGUgPSBjLnJldXNhYmxlU29ja2V0ID8gYy5kaHQuX3NvY2tldFBvb2wucm91dGVzLmdldChjLnJlbW90ZVB1YmxpY0tleSkgOiBudWxsCgogIGlmIChyb3V0ZSkgewogICAgYXdhaXQgcmV0cnlSb3V0ZShjLCByb3V0ZSkKICAgIGlmIChpc0RvbmUoYykpIHJldHVybgogIH0KCiAgYXdhaXQgZmluZEFuZENvbm5lY3QoYywgb3B0cykKICBpZiAoaXNEb25lKGMpKSByZXR1cm4KCiAgaWYgKCFjLmNvbm5lY3QpIHsKICAgIC8vIFRPRE86IGp1c3QgYSBxdWljayBmaXggZm9yIG5vdywgc2hvdWxkIHJldHJ5IHByb2IKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBIQU5EU0hBS0VfSU5WQUxJRCgpKQogICAgcmV0dXJuCiAgfQoKICBhd2FpdCBob2xlcHVuY2goYywgb3B0cykKfQoKZnVuY3Rpb24gZ2V0Rmlyc3RSZW1vdGVBZGRyZXNzKGFkZHJzLCBzZXJ2ZXJBZGRyZXNzKSB7CiAgZm9yIChjb25zdCBhZGRyIG9mIGFkZHJzKSB7CiAgICBpZiAoaXNCb2dvbihhZGRyLmhvc3QpKSBjb250aW51ZQogICAgcmV0dXJuIGFkZHIKICB9CgogIHJldHVybiBzZXJ2ZXJBZGRyZXNzCn0KCmFzeW5jIGZ1bmN0aW9uIGhvbGVwdW5jaChjLCBvcHRzKSB7CiAgbGV0IHsgcmVsYXlBZGRyZXNzLCBzZXJ2ZXJBZGRyZXNzLCBjbGllbnRBZGRyZXNzLCBwYXlsb2FkIH0gPSBjLmNvbm5lY3QKCiAgY29uc3QgcmVtb3RlSG9sZXB1bmNoYWJsZSA9ICEhKHBheWxvYWQuaG9sZXB1bmNoICYmIHBheWxvYWQuaG9sZXB1bmNoLnJlbGF5cy5sZW5ndGgpCgogIGNvbnN0IHJlbGF5ZWQgPSBkaWZmQWRkcmVzcyhzZXJ2ZXJBZGRyZXNzLCByZWxheUFkZHJlc3MpCgogIGlmIChwYXlsb2FkLmZpcmV3YWxsID09PSBGSVJFV0FMTC5PUEVOIHx8IChyZWxheWVkICYmICFyZW1vdGVIb2xlcHVuY2hhYmxlKSkgewogICAgY29uc3QgYWRkciA9IGdldEZpcnN0UmVtb3RlQWRkcmVzcyhwYXlsb2FkLmFkZHJlc3NlczQsIHNlcnZlckFkZHJlc3MpCiAgICBpZiAoYWRkcikgewogICAgICBjb25zdCBzb2NrZXQgPSBjLmRodC5zb2NrZXQKICAgICAgYy5kaHQuc3RhdHMucHVuY2hlcy5vcGVuKysKICAgICAgYy5vbnNvY2tldChzb2NrZXQsIGFkZHIucG9ydCwgYWRkci5ob3N0KQogICAgICByZXR1cm4KICAgIH0KICAgIC8vIFRPRE86IGNoZWNrIGFsbCBhZGRyZXNzZXMgYWxzbyBvYnZzCiAgfQoKICBjb25zdCBvbmFib3J0ID0gKCkgPT4gewogICAgYy5zZXNzaW9uLmRlc3Ryb3koKQogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIEhPTEVQVU5DSF9BQk9SVEVEKCkpCiAgfQoKICBpZiAoYy5maXJld2FsbCA9PT0gRklSRVdBTEwuT1BFTikgewogICAgYy5wYXNzaXZlQ29ubmVjdFRpbWVvdXQgPSBzZXRUaW1lb3V0KG9uYWJvcnQsIDEwMDAwKQogICAgcmV0dXJuCiAgfQoKICAvLyBUT0RPOiB3b3VsZCBiZSBiZXR0ZXIgdG8ganVzdCB0cnkgbG9jYWwgYWRkcnMgaW4gdGhlIGJhY2tncm91bmQgd2hpbHN0IGNvbnRpbnVpbmcgd2l0aCBvdGhlciBzdHJhdGVnaWVzLi4uCiAgaWYgKGMubGFuICYmIHJlbGF5ZWQgJiYgY2xpZW50QWRkcmVzcy5ob3N0ID09PSBzZXJ2ZXJBZGRyZXNzLmhvc3QpIHsKICAgIGNvbnN0IHNlcnZlckFkZHJlc3NlcyA9IHBheWxvYWQuYWRkcmVzc2VzNC5maWx0ZXIob25seVByaXZhdGVIb3N0cykKCiAgICBpZiAoc2VydmVyQWRkcmVzc2VzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgbXlBZGRyZXNzZXMgPSBIb2xlcHVuY2hlci5sb2NhbEFkZHJlc3NlcyhjLmRodC5pby5zZXJ2ZXJTb2NrZXQpCiAgICAgIGNvbnN0IGFkZHIgPSBIb2xlcHVuY2hlci5tYXRjaEFkZHJlc3MobXlBZGRyZXNzZXMsIHNlcnZlckFkZHJlc3NlcykgfHwgc2VydmVyQWRkcmVzc2VzWzBdCgogICAgICBjb25zdCBzb2NrZXQgPSBjLmRodC5pby5zZXJ2ZXJTb2NrZXQKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCBjLmRodC5waW5nKGFkZHIpCiAgICAgIH0gY2F0Y2ggewogICAgICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBIT0xFUFVOQ0hfQUJPUlRFRCgpKQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIGMub25zb2NrZXQoc29ja2V0LCBhZGRyLnBvcnQsIGFkZHIuaG9zdCkKICAgICAgcmV0dXJuCiAgICB9CiAgfQoKICBpZiAoIXJlbW90ZUhvbGVwdW5jaGFibGUpIHsKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBDQU5OT1RfSE9MRVBVTkNIKCkpCiAgICByZXR1cm4KICB9CgogIGMucHVuY2hlciA9IG5ldyBIb2xlcHVuY2hlcihjLmRodCwgYy5zZXNzaW9uLCB0cnVlLCBwYXlsb2FkLmZpcmV3YWxsKQoKICBjLnB1bmNoZXIub25jb25uZWN0ID0gYy5vbnNvY2tldAogIGMucHVuY2hlci5vbmFib3J0ID0gb25hYm9ydAoKICBjb25zdCBzZXJ2ZXJSZWxheSA9IHBpY2tTZXJ2ZXJSZWxheShwYXlsb2FkLmhvbGVwdW5jaC5yZWxheXMsIHJlbGF5QWRkcmVzcykKCiAgLy8gQmVnaW4gaG9sZXB1bmNoaW5nIQoKICBsZXQgcHJvYmUKICB0cnkgewogICAgcHJvYmUgPSBhd2FpdCBwcm9iZVJvdW5kKGMsIG9wdHMuZmFzdE9wZW4gPT09IGZhbHNlID8gbnVsbCA6IHNlcnZlckFkZHJlc3MsIHNlcnZlclJlbGF5LCB0cnVlKQogIH0gY2F0Y2ggKGVycikgewogICAgZGVzdHJveVB1bmNoZXIoYykKICAgIC8vIFRPRE86IHdlIHNob3VsZCByZXRyeSBoZXJlIHdpdGggc29tZSBvZiB0aGUgb3RoZXIgcmVsYXlzLCBiYWlsIGZvciBub3cKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBlcnIpCiAgICByZXR1cm4KICB9CgogIGlmIChpc0RvbmUoYykgfHwgIXByb2JlKSByZXR1cm4KICBjb25zdCB7IHRva2VuLCBwZWVyQWRkcmVzcyB9ID0gcHJvYmUKCiAgLy8gSWYgdGhlIHJlbGF5IHRoZSBzZXJ2ZXIgcGlja2VkIGlzIHRoZSBzYW1lIGFzIHRoZSByZWxheSB0aGUgY2xpZW50IHBpY2tlZCwKICAvLyB0aGVuIHdlIGNhbiB1c2UgdGhlIHBlZXJBZGRyZXNzIHRoYXQgcm91bmQgb25lIGluZGljYXRlcyB0aGUgc2VydmVyIHdhbnRzIHRvIHVzZS4KICAvLyBUaGlzIHNoYXZlcyBvZmYgYSByb3VuZHRyaXAgaWYgdGhlIHNlcnZlciBjaG9zZSB0byByZXJvbGwgaXRzIHNvY2tldCBkdWUgdG8gc29tZSBOQVQKICAvLyBpc3N1ZSB3aXRoIHRoZSBmaXJzdCBvbmUgaXQgcGlja2VkIChpZSBtb2JpbGUgbmF0IGluY29uc2lzdGVuY2llcy4uLikuCiAgLy8gSWYgdGhlIHJlbGF5cyB3ZXJlIGRpZmZlcmVudCwgdGhlbiB0aGUgc2VydmVyIHdvdWxkIG5vdCBoYXZlIGEgVURQIHNlc3Npb24gb3BlbiBvbiB0aGlzIGFkZHJlc3MKICAvLyB0byB0aGUgY2xpZW50IHJlbGF5LCB3aGljaCByb3VuZDIgdXNlcy4KICBpZiAoCiAgICAhZGlmZkFkZHJlc3Moc2VydmVyUmVsYXkucmVsYXlBZGRyZXNzLCByZWxheUFkZHJlc3MpICYmCiAgICBkaWZmQWRkcmVzcyhzZXJ2ZXJBZGRyZXNzLCBwZWVyQWRkcmVzcykKICApIHsKICAgIHNlcnZlckFkZHJlc3MgPSBwZWVyQWRkcmVzcwogICAgYXdhaXQgYy5wdW5jaGVyLm9wZW5TZXNzaW9uKHNlcnZlckFkZHJlc3MpCiAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4KICB9CgogIC8vIFRPRE86IHN0aWxsIGNvbnRpbnVlIGhlcmUgaWYgYSBsb2NhbCBjb25uZWN0aW9uIG1pZ2h0IHdvcmssIGJ1dCB0aGVuIGRvIG5vdCBob2xlcHVuY2guLi4KICBpZiAoCiAgICBvcHRzLmhvbGVwdW5jaCAmJgogICAgIW9wdHMuaG9sZXB1bmNoKAogICAgICBjLnB1bmNoZXIucmVtb3RlRmlyZXdhbGwsCiAgICAgIGMucHVuY2hlci5uYXQuZmlyZXdhbGwsCiAgICAgIGMucHVuY2hlci5yZW1vdGVBZGRyZXNzZXMsCiAgICAgIGMucHVuY2hlci5uYXQuYWRkcmVzc2VzCiAgICApCiAgKSB7CiAgICBhd2FpdCBhYm9ydChjLCBzZXJ2ZXJSZWxheSwgSE9MRVBVTkNIX0FCT1JURUQoJ0NsaWVudCBhYm9ydGVkIGhvbGVwdW5jaCcpKQogICAgcmV0dXJuCiAgfQoKICB0cnkgewogICAgYXdhaXQgcm91bmRQdW5jaChjLCBzZXJ2ZXJBZGRyZXNzLCB0b2tlbiwgcmVsYXlBZGRyZXNzLCBzZXJ2ZXJSZWxheSwgZmFsc2UpCiAgfSBjYXRjaCAoZXJyKSB7CiAgICBkZXN0cm95UHVuY2hlcihjKQogICAgLy8gVE9ETzogcmV0cnkgd2l0aCBhbm90aGVyIHJlbGF5PwogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIGVycikKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGZpbmRBbmRDb25uZWN0KGMsIG9wdHMpIHsKICBsZXQgYXR0ZW1wdHMgPSAwCiAgbGV0IGNsb3Nlc3ROb2RlcyA9IG9wdHMucmVsYXlBZGRyZXNzZXMgJiYgb3B0cy5yZWxheUFkZHJlc3Nlcy5sZW5ndGggPyBvcHRzLnJlbGF5QWRkcmVzc2VzIDogbnVsbAoKICBpZiAoIWNsb3Nlc3ROb2RlcykgewogICAgY29uc3QgY2FjaGVkUmVsYXlBZGRyZXNzZXMgPSBjLmRodC5fcmVsYXlBZGRyZXNzZXNDYWNoZS5nZXQoYy5pZCkKICAgIGlmIChjYWNoZWRSZWxheUFkZHJlc3NlcykgY2xvc2VzdE5vZGVzID0gY2FjaGVkUmVsYXlBZGRyZXNzZXMKICB9CgogIGlmIChjLmRodC5fcGVyc2lzdGVudCkgewogICAgLy8gY2hlY2sgaWYgd2Uga25vdyB0aGUgcm91dGUgb3Vyc2VsZi4uLgogICAgY29uc3Qgcm91dGUgPSBjLmRodC5fcm91dGVyLmdldChjLnRhcmdldCkKICAgIGlmIChyb3V0ZSAmJiByb3V0ZS5yZWxheSAhPT0gbnVsbCkgewogICAgICBjbG9zZXN0Tm9kZXMgPSBbeyBob3N0OiByb3V0ZS5yZWxheS5ob3N0LCBwb3J0OiByb3V0ZS5yZWxheS5wb3J0IH1dCiAgICB9CiAgfQoKICAvLyAyIGlzIGhvdyBtYW55IHBhcmFsbGVsIGNvbm5lY3QgYXR0ZW1wdHMgd2Ugd2FudCB0byBkbywgd2UgY2FuIG1ha2UgdGhpcyBjb25maWd1cmFibGUKICBjb25zdCBzZW0gPSBuZXcgU2VtYXBob3JlKDIpCiAgY29uc3Qgc2lnbmFsID0gc2VtLnNpZ25hbC5iaW5kKHNlbSkKICBjb25zdCB0cmllcyA9IGNsb3Nlc3ROb2RlcyAhPT0gbnVsbCA/IDIgOiAxCgogIHRyeSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRyaWVzICYmICFpc0RvbmUoYykgJiYgIWMuY29ubmVjdDsgaSsrKSB7CiAgICAgIGMucXVlcnkgPSBjLmRodC5maW5kUGVlcihjLnRhcmdldCwgewogICAgICAgIGhhc2g6IGZhbHNlLAogICAgICAgIHNlc3Npb246IGMuc2Vzc2lvbiwKICAgICAgICBjbG9zZXN0Tm9kZXMsCiAgICAgICAgb25seUNsb3Nlc3ROb2RlczogY2xvc2VzdE5vZGVzICE9PSBudWxsLAogICAgICAgIHJldHJpZXM6IGNsb3Nlc3ROb2RlcyA/IDEgOiAzCiAgICAgIH0pCgogICAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgYy5xdWVyeSkgewogICAgICAgIGF3YWl0IHNlbS53YWl0KCkKICAgICAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4KCiAgICAgICAgaWYgKGMuY29ubmVjdCkgewogICAgICAgICAgc2VtLnNpZ25hbCgpCiAgICAgICAgICBicmVhawogICAgICAgIH0KCiAgICAgICAgYy5yZW1vdGVSZWxheUFkZHJlc3Nlcy5wdXNoKGRhdGEuZnJvbSkKICAgICAgICBhdHRlbXB0cysrCiAgICAgICAgY29ubmVjdFRocm91Z2hOb2RlKGMsIGRhdGEuZnJvbSwgbnVsbCkudGhlbihzaWduYWwsIHNpZ25hbCkKICAgICAgfQoKICAgICAgY2xvc2VzdE5vZGVzID0gbnVsbAoKICAgICAgaWYgKGF0dGVtcHRzID4gMCkgYXdhaXQgc2VtLmZsdXNoKCkKICAgIH0KCiAgICBjLnF1ZXJ5ID0gbnVsbAogICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCgogICAgLy8gZmx1c2ggdGhlIHNlbWFwaG9yZQogICAgYXdhaXQgc2VtLmZsdXNoKCkKICAgIGlmIChpc0RvbmUoYykpIHJldHVybgogIH0gY2F0Y2ggKGVycikgewogICAgYy5xdWVyeSA9IG51bGwKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBlcnIpCiAgICByZXR1cm4KICB9CgogIGlmICghYy5jb25uZWN0KSB7CiAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgYXR0ZW1wdHMgPyBQRUVSX0NPTk5FQ1RJT05fRkFJTEVEKCkgOiBQRUVSX05PVF9GT1VORCgpKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gY29ubmVjdFRocm91Z2hOb2RlKGMsIGFkZHJlc3MsIHNvY2tldCkgewogIGlmICghYy5yZXF1ZXN0aW5nKSB7CiAgICAvLyBJZiB3ZSBoYXZlIGEgc3RhYmxlIHNlcnZlciBhZGRyZXNzLCBzZW5kIGl0IG92ZXIgbm93CiAgICBjb25zdCBhZGRyID0gYy5kaHQucmVtb3RlQWRkcmVzcygpCiAgICBjb25zdCBsb2NhbEFkZHJzID0gYy5sYW4gPyBIb2xlcHVuY2hlci5sb2NhbEFkZHJlc3NlcyhjLmRodC5pby5zZXJ2ZXJTb2NrZXQpIDogbnVsbAogICAgY29uc3QgYWRkcmVzc2VzNCA9IFtdCgogICAgaWYgKGFkZHIpIGFkZHJlc3NlczQucHVzaChhZGRyKQogICAgaWYgKGxvY2FsQWRkcnMpIGFkZHJlc3NlczQucHVzaCguLi5sb2NhbEFkZHJzKQoKICAgIGMuZmlyZXdhbGwgPSBhZGRyID8gRklSRVdBTEwuT1BFTiA6IEZJUkVXQUxMLlVOS05PV04KICAgIGMucmVxdWVzdGluZyA9IHRydWUKICAgIGMucmVxdWVzdCA9IGF3YWl0IGMuaGFuZHNoYWtlLnNlbmQoewogICAgICBlcnJvcjogRVJST1IuTk9ORSwKICAgICAgZmlyZXdhbGw6IGMuZmlyZXdhbGwsCiAgICAgIGhvbGVwdW5jaDogbnVsbCwKICAgICAgYWRkcmVzc2VzNCwKICAgICAgYWRkcmVzc2VzNjogW10sCiAgICAgIHVkeDogewogICAgICAgIHJldXNhYmxlU29ja2V0OiBjLnJldXNhYmxlU29ja2V0LAogICAgICAgIGlkOiBjLnJhd1N0cmVhbS5pZCwKICAgICAgICBzZXE6IDAKICAgICAgfSwKICAgICAgc2VjcmV0U3RyZWFtOiB7fSwKICAgICAgcmVsYXlUaHJvdWdoOiBjLnJlbGF5VGhyb3VnaCA/IHsgcHVibGljS2V5OiBjLnJlbGF5VGhyb3VnaCwgdG9rZW46IGMucmVsYXlUb2tlbiB9IDogbnVsbAogICAgfSkKICAgIGlmIChpc0RvbmUoYykpIHJldHVybgogIH0KCiAgY29uc3QgeyBzZXJ2ZXJBZGRyZXNzLCBjbGllbnRBZGRyZXNzLCByZWxheWVkLCBub2lzZSB9ID0gYXdhaXQgYy5kaHQuX3JvdXRlci5wZWVySGFuZHNoYWtlKAogICAgYy50YXJnZXQsCiAgICB7IG5vaXNlOiBjLnJlcXVlc3QsIHNvY2tldCwgc2Vzc2lvbjogYy5zZXNzaW9uIH0sCiAgICBhZGRyZXNzCiAgKQogIGlmIChpc0RvbmUoYykgfHwgYy5jb25uZWN0KSByZXR1cm4KCiAgY29uc3QgcGF5bG9hZCA9IGF3YWl0IGMuaGFuZHNoYWtlLnJlY3Yobm9pc2UpCiAgaWYgKGlzRG9uZShjKSB8fCAhcGF5bG9hZCkgcmV0dXJuCgogIGlmIChwYXlsb2FkLnZlcnNpb24gIT09IDEpIHsKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBTRVJWRVJfSU5DT01QQVRJQkxFKCkpCiAgICByZXR1cm4KICB9CiAgaWYgKHBheWxvYWQuZXJyb3IgIT09IEVSUk9SLk5PTkUpIHsKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBTRVJWRVJfRVJST1IoKSkKICAgIHJldHVybgogIH0KICBpZiAoIXBheWxvYWQudWR4KSB7CiAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgU0VSVkVSX0VSUk9SKCdTZXJ2ZXIgZGlkIG5vdCBzZW5kIFVEWCBkYXRhJykpCiAgICByZXR1cm4KICB9CgogIGNvbnN0IGhzID0gYy5oYW5kc2hha2UuZmluYWwoKQoKICBjLmhhbmRzaGFrZSA9IG51bGwKICBjLnJlcXVlc3QgPSBudWxsCiAgYy5yZXF1ZXN0aW5nID0gZmFsc2UKICBjLmNvbm5lY3QgPSB7CiAgICByZWxheWVkLAogICAgcmVsYXlBZGRyZXNzOiBhZGRyZXNzLAogICAgY2xpZW50QWRkcmVzcywKICAgIHNlcnZlckFkZHJlc3MsCiAgICBwYXlsb2FkCiAgfQoKICBjLnBheWxvYWQgPSBuZXcgU2VjdXJlUGF5bG9hZChocy5ob2xlcHVuY2hTZWNyZXQpCgogIGMub25zb2NrZXQgPSBmdW5jdGlvbiAoc29ja2V0LCBwb3J0LCBob3N0KSB7CiAgICBpZiAoYy5yYXdTdHJlYW0gPT09IG51bGwpIHJldHVybiAvLyBBbHJlYWR5IGhvbGUgcHVuY2hlZAoKICAgIGlmIChjLnJhd1N0cmVhbS5jb25uZWN0ZWQpIHsKICAgICAgY29uc3QgcmVtb3RlQ2hhbmdpbmcgPSBjLnJhd1N0cmVhbS5jaGFuZ2VSZW1vdGUoc29ja2V0LCBjLmNvbm5lY3QucGF5bG9hZC51ZHguaWQsIHBvcnQsIGhvc3QpCgogICAgICBpZiAocmVtb3RlQ2hhbmdpbmcpIHJlbW90ZUNoYW5naW5nLmNhdGNoKHNhZmV0eUNhdGNoKQogICAgfSBlbHNlIHsKICAgICAgLy8gY2FjaGUgdGhlIHJlbGF5IGFkZHJzIGZvciBhIGZ1dHVyZSByZWNvbm5lY3QsIHdlIHByZWZlciB0aGUgcmVtb3RlIG9uZSBzbyB0aGV5CiAgICAgIC8vIGNhbiBnaXZlIHVzIHRoZSBjb3JyZWN0IG9uZXMgZnJvbSB0aGVpciBwb3YKICAgICAgaWYgKHBheWxvYWQucmVsYXlBZGRyZXNzZXMgJiYgcGF5bG9hZC5yZWxheUFkZHJlc3Nlcy5sZW5ndGgpIHsKICAgICAgICBjLmRodC5fcmVsYXlBZGRyZXNzZXNDYWNoZS5zZXQoYy5pZCwgcGF5bG9hZC5yZWxheUFkZHJlc3NlcykKICAgICAgfSBlbHNlIGlmIChjLnJlbW90ZVJlbGF5QWRkcmVzc2VzLmxlbmd0aCkgewogICAgICAgIGMuZGh0Ll9yZWxheUFkZHJlc3Nlc0NhY2hlLnNldChjLmlkLCBjLnJlbW90ZVJlbGF5QWRkcmVzc2VzKQogICAgICB9CgogICAgICBjLnJhd1N0cmVhbS5jb25uZWN0KHNvY2tldCwgYy5jb25uZWN0LnBheWxvYWQudWR4LmlkLCBwb3J0LCBob3N0KQogICAgICBjLmVuY3J5cHRlZFNvY2tldC5zdGFydChjLnJhd1N0cmVhbSwgeyBoYW5kc2hha2U6IGhzIH0pCiAgICB9CgogICAgaWYgKGMucmV1c2FibGVTb2NrZXQgJiYgcGF5bG9hZC51ZHgucmV1c2FibGVTb2NrZXQpIHsKICAgICAgYy5kaHQuX3NvY2tldFBvb2wucm91dGVzLmFkZChjLnJlbW90ZVB1YmxpY0tleSwgYy5yYXdTdHJlYW0pCiAgICB9CgogICAgaWYgKGMucHVuY2hlcikgewogICAgICBjLnB1bmNoZXIub25hYm9ydCA9IG5vb3AKICAgICAgYy5wdW5jaGVyLmRlc3Ryb3koKQogICAgfQoKICAgIGlmIChjLnBhc3NpdmVDb25uZWN0VGltZW91dCkgewogICAgICBjbGVhclBhc3NpdmVDb25uZWN0VGltZW91dChjKQogICAgfQoKICAgIGMucmF3U3RyZWFtID0gbnVsbAogIH0KCiAgaWYgKHBheWxvYWQucmVsYXlUaHJvdWdoIHx8IGMucmVsYXlUaHJvdWdoKSB7CiAgICByZWxheUNvbm5lY3Rpb24oYywgYy5yZWxheVRocm91Z2gsIHBheWxvYWQsIGhzKQogIH0KCiAgaWYgKGMuc2VydmVyU29ja2V0KSB7CiAgICBjLm9uc29ja2V0KGMuc2VydmVyU29ja2V0LCBjLnNlcnZlckFkZHJlc3MucG9ydCwgYy5zZXJ2ZXJBZGRyZXNzLmhvc3QpCiAgICByZXR1cm4KICB9CgogIGlmICghcmVsYXllZCkgewogICAgYy5vbnNvY2tldChzb2NrZXQgfHwgYy5kaHQuc29ja2V0LCBhZGRyZXNzLnBvcnQsIGFkZHJlc3MuaG9zdCkKICB9CgogIGMuc2Vzc2lvbi5kZXN0cm95KCkKfQoKYXN5bmMgZnVuY3Rpb24gdXBkYXRlSG9sZXB1bmNoKGMsIHBlZXJBZGRyZXNzLCByZWxheUFkZHIsIHBheWxvYWQpIHsKICBjb25zdCBob2xlcHVuY2ggPSBhd2FpdCBjLmRodC5fcm91dGVyLnBlZXJIb2xlcHVuY2goCiAgICBjLnRhcmdldCwKICAgIHsKICAgICAgaWQ6IGMuY29ubmVjdC5wYXlsb2FkLmhvbGVwdW5jaC5pZCwKICAgICAgcGF5bG9hZDogYy5wYXlsb2FkLmVuY3J5cHQocGF5bG9hZCksCiAgICAgIHBlZXJBZGRyZXNzLAogICAgICBzb2NrZXQ6IGMucHVuY2hlci5zb2NrZXQsCiAgICAgIHNlc3Npb246IGMuc2Vzc2lvbgogICAgfSwKICAgIHJlbGF5QWRkcgogICkKCiAgaWYgKGlzRG9uZShjKSkgcmV0dXJuIG51bGwKCiAgY29uc3QgcmVtb3RlUGF5bG9hZCA9IGMucGF5bG9hZC5kZWNyeXB0KGhvbGVwdW5jaC5wYXlsb2FkKQogIGlmICghcmVtb3RlUGF5bG9hZCkgewogICAgdGhyb3cgSE9MRVBVTkNIX0lOVkFMSUQoKQogIH0KCiAgY29uc3QgeyBlcnJvciwgZmlyZXdhbGwsIHB1bmNoaW5nLCBhZGRyZXNzZXMsIHJlbW90ZVRva2VuIH0gPSByZW1vdGVQYXlsb2FkCgogIGlmIChlcnJvciA9PT0gRVJST1IuVFJZX0xBVEVSICYmIGMucmVsYXlUb2tlbiAmJiBwYXlsb2FkLnB1bmNoaW5nKSB7CiAgICByZXR1cm4gewogICAgICB0cnlMYXRlcjogdHJ1ZSwKICAgICAgLi4uaG9sZXB1bmNoLAogICAgICBwYXlsb2FkOiByZW1vdGVQYXlsb2FkCiAgICB9CiAgfQoKICBpZiAoZXJyb3IgIT09IEVSUk9SLk5PTkUpIHsKICAgIHRocm93IFJFTU9URV9BQk9SVEVEKCdSZW1vdGUgYWJvcnRlZCB3aXRoIGVycm9yIGNvZGUgJyArIGVycm9yKQogIH0KCiAgY29uc3QgZWNob2VkID0gISEocmVtb3RlVG9rZW4gJiYgcGF5bG9hZC50b2tlbiAmJiBiNGEuZXF1YWxzKHJlbW90ZVRva2VuLCBwYXlsb2FkLnRva2VuKSkKCiAgYy5wdW5jaGVyLnVwZGF0ZVJlbW90ZSh7CiAgICBwdW5jaGluZywKICAgIGZpcmV3YWxsLAogICAgYWRkcmVzc2VzLAogICAgdmVyaWZpZWQ6IGVjaG9lZCA/IHBlZXJBZGRyZXNzLmhvc3QgOiBudWxsCiAgfSkKCiAgcmV0dXJuIHsKICAgIHRyeUxhdGVyOiBmYWxzZSwKICAgIC4uLmhvbGVwdW5jaCwKICAgIHBheWxvYWQ6IHJlbW90ZVBheWxvYWQKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHByb2JlUm91bmQoYywgc2VydmVyQWRkcmVzcywgc2VydmVyUmVsYXksIHJldHJ5KSB7CiAgLy8gT3BlbiBhIHF1aWNrIGxvdyB0dGwgc2Vzc2lvbiBhZ2FpbnN0IHdoYXQgd2UgdGhpbmsgaXMgdGhlIHNlcnZlcgogIGlmIChzZXJ2ZXJBZGRyZXNzKSBhd2FpdCBjLnB1bmNoZXIub3BlblNlc3Npb24oc2VydmVyQWRkcmVzcykKCiAgaWYgKGlzRG9uZShjKSkgcmV0dXJuIG51bGwKCiAgY29uc3QgcmVwbHkgPSBhd2FpdCB1cGRhdGVIb2xlcHVuY2goYywgc2VydmVyUmVsYXkucGVlckFkZHJlc3MsIHNlcnZlclJlbGF5LnJlbGF5QWRkcmVzcywgewogICAgZXJyb3I6IEVSUk9SLk5PTkUsCiAgICBmaXJld2FsbDogYy5wdW5jaGVyLm5hdC5maXJld2FsbCwKICAgIHJvdW5kOiBjLnJvdW5kKyssCiAgICBjb25uZWN0ZWQ6IGZhbHNlLAogICAgcHVuY2hpbmc6IGZhbHNlLAogICAgYWRkcmVzc2VzOiBjLnB1bmNoZXIubmF0LmFkZHJlc3NlcywKICAgIHJlbW90ZUFkZHJlc3M6IHNlcnZlckFkZHJlc3MsCiAgICB0b2tlbjogbnVsbCwKICAgIHJlbW90ZVRva2VuOiBudWxsCiAgfSkKCiAgaWYgKGlzRG9uZShjKSB8fCAhcmVwbHkpIHJldHVybiBudWxsCgogIGNvbnN0IHsgcGVlckFkZHJlc3MgfSA9IHJlcGx5CiAgY29uc3QgeyBhZGRyZXNzLCB0b2tlbiB9ID0gcmVwbHkucGF5bG9hZAoKICBjLnB1bmNoZXIubmF0LmFkZChyZXBseS50bywgcmVwbHkuZnJvbSkKCiAgLy8gT3BlbiBhbm90aGVyIHF1aWNrIGxvdyB0dGwgc2Vzc2lvbiBhZ2FpbnN0IHdoYXQgdGhlIHNlcnZlciBzYXlzIHRoZWlyIGFkZHJlc3MgaXMsCiAgLy8gaWYgdGhleSBoYXZlbid0IHNhaWQgdGhleSBhcmUgcmFuZG9tIHlldAogIGlmICgKICAgIGMucHVuY2hlci5yZW1vdGVGaXJld2FsbCA8IEZJUkVXQUxMLlJBTkRPTSAmJgogICAgYWRkcmVzcyAmJgogICAgYWRkcmVzcy5ob3N0ICYmCiAgICBhZGRyZXNzLnBvcnQgJiYKICAgIGRpZmZBZGRyZXNzKGFkZHJlc3MsIHNlcnZlckFkZHJlc3MpCiAgKSB7CiAgICBhd2FpdCBjLnB1bmNoZXIub3BlblNlc3Npb24oYWRkcmVzcykKICAgIGlmIChpc0RvbmUoYykpIHJldHVybiBudWxsCiAgfQoKICAvLyBJZiB0aGUgcmVtb3RlIHRvbGQgdXMgdGhleSBkaWRuJ3Qga25vdyB0aGVpciBuYXQgZmlyZXdhbGwgeWV0LCBnaXZlIHRoZW0gYSBjaGFuY2UgdG8gZmlndXJlIGl0IG91dAogIC8vIFRoZXkgbWlnaHQgc2F5IHRoaXMgdG8gc2VlIGlmIHRoZSAiZmFzdCBtb2RlIiBwdW5jaCBjb21lcyB0aHJvdWdoIGZpcnN0LgogIGlmIChjLnB1bmNoZXIucmVtb3RlRmlyZXdhbGwgPT09IEZJUkVXQUxMLlVOS05PV04pIHsKICAgIGF3YWl0IGMuc2xlZXBlci5wYXVzZSgxMDAwKQogICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuIG51bGwKICB9CgogIGxldCBzdGFibGUgPSBhd2FpdCBjLnB1bmNoZXIuYW5hbHl6ZShmYWxzZSkKICBpZiAoaXNEb25lKGMpKSByZXR1cm4gbnVsbAoKICAvLyBJZiB0aGUgc29ja2V0IHNlZW1zIHVuc3RhYmxlLCB0cnkgdG8gbWFrZSBpdCBzdGFibGUgYnkgc2V0dGluZyB0aGUgImFsbG93UmVvcGVuIiBmbGFnCiAgLy8gTW9zdGx5IHJlbGV2YW50IGZvciBtb2JpbGUgbmV0d29ya3MKICBpZiAoIXN0YWJsZSkgewogICAgc3RhYmxlID0gYXdhaXQgYy5wdW5jaGVyLmFuYWx5emUodHJ1ZSkKICAgIGlmIChpc0RvbmUoYykpIHJldHVybiBudWxsCiAgICBpZiAoc3RhYmxlKSByZXR1cm4gcHJvYmVSb3VuZChjLCBzZXJ2ZXJBZGRyZXNzLCBzZXJ2ZXJSZWxheSwgZmFsc2UpCiAgfQoKICBpZiAoKGMucHVuY2hlci5yZW1vdGVGaXJld2FsbCA9PT0gRklSRVdBTEwuVU5LTk9XTiB8fCAhdG9rZW4pICYmIHJldHJ5KSB7CiAgICByZXR1cm4gcHJvYmVSb3VuZChjLCBzZXJ2ZXJBZGRyZXNzLCBzZXJ2ZXJSZWxheSwgZmFsc2UpCiAgfQoKICBpZiAoCiAgICBjLnB1bmNoZXIucmVtb3RlRmlyZXdhbGwgPT09IEZJUkVXQUxMLlVOS05PV04gfHwKICAgIGMucHVuY2hlci5uYXQuZmlyZXdhbGwgPT09IEZJUkVXQUxMLlVOS05PV04KICApIHsKICAgIGF3YWl0IGFib3J0KGMsIHNlcnZlclJlbGF5LCBIT0xFUFVOQ0hfUFJPQkVfVElNRU9VVCgpKQogICAgcmV0dXJuIG51bGwKICB9CgogIGlmIChjLnB1bmNoZXIucmVtb3RlRmlyZXdhbGwgPj0gRklSRVdBTEwuUkFORE9NICYmIGMucHVuY2hlci5uYXQuZmlyZXdhbGwgPj0gRklSRVdBTEwuUkFORE9NKSB7CiAgICBhd2FpdCBhYm9ydChjLCBzZXJ2ZXJSZWxheSwgSE9MRVBVTkNIX0RPVUJMRV9SQU5ET01JWkVEX05BVFMoKSkKICAgIHJldHVybiBudWxsCiAgfQoKICByZXR1cm4geyB0b2tlbiwgcGVlckFkZHJlc3MgfQp9Cgphc3luYyBmdW5jdGlvbiByb3VuZFB1bmNoKGMsIHNlcnZlckFkZHJlc3MsIHJlbW90ZVRva2VuLCBjbGllbnRSZWxheSwgc2VydmVyUmVsYXksIGRlbGF5ZWQpIHsKICAvLyBXZSBhcmUgZ29zc2lwaW5nIG91ciBmaW5hbCBOQVQgc3RhdHVzIHRvIHRoZSBvdGhlciBwZWVyIG5vdwogIC8vIHNvIG1ha2Ugc3VyZSB3ZSBkb24ndCB1cGRhdGUgb3VyIGxvY2FsIHZpZXcgZm9yIG5vdyBhcyB0aGF0IGNhbiBtYWtlIHRoaW5ncyB3ZWlyZAogIGMucHVuY2hlci5uYXQuZnJlZXplKCkKCiAgY29uc3QgaXNSYW5kb20gPQogICAgYy5wdW5jaGVyLnJlbW90ZUZpcmV3YWxsID49IEZJUkVXQUxMLlJBTkRPTSB8fCBjLnB1bmNoZXIubmF0LmZpcmV3YWxsID49IEZJUkVXQUxMLlJBTkRPTQogIGlmIChpc1JhbmRvbSkgewogICAgd2hpbGUgKAogICAgICBjLmRodC5fcmFuZG9tUHVuY2hlcyA+PSBjLmRodC5fcmFuZG9tUHVuY2hMaW1pdCB8fAogICAgICBEYXRlLm5vdygpIC0gYy5kaHQuX2xhc3RSYW5kb21QdW5jaCA8IGMuZGh0Ll9yYW5kb21QdW5jaEludGVydmFsCiAgICApIHsKICAgICAgLy8gaWYgbm8gcmVsYXkgY2FuIGhlbHAsIGJhaWwKICAgICAgaWYgKCFjLnJlbGF5VG9rZW4pIHRocm93IEhPTEVQVU5DSF9BQk9SVEVEKCkKCiAgICAgIGlmICghZGVsYXllZCkgewogICAgICAgIGRlbGF5ZWQgPSB0cnVlCiAgICAgICAgYXdhaXQgdXBkYXRlSG9sZXB1bmNoKGMsIHNlcnZlckFkZHJlc3MsIGNsaWVudFJlbGF5LCB7CiAgICAgICAgICBlcnJvcjogRVJST1IuTk9ORSwKICAgICAgICAgIGZpcmV3YWxsOiBjLnB1bmNoZXIubmF0LmZpcmV3YWxsLAogICAgICAgICAgcm91bmQ6IGMucm91bmQrKywKICAgICAgICAgIGNvbm5lY3RlZDogZmFsc2UsCiAgICAgICAgICBwdW5jaGluZzogZmFsc2UsCiAgICAgICAgICBhZGRyZXNzZXM6IGMucHVuY2hlci5uYXQuYWRkcmVzc2VzLAogICAgICAgICAgcmVtb3RlQWRkcmVzczogbnVsbCwKICAgICAgICAgIHRva2VuOiBjLnBheWxvYWQudG9rZW4oc2VydmVyQWRkcmVzcyksCiAgICAgICAgICByZW1vdGVUb2tlbgogICAgICAgIH0pCiAgICAgICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCiAgICAgIH0KCiAgICAgIGF3YWl0IHRyeUxhdGVyKGMpCiAgICAgIGlmIChpc0RvbmUoYykpIHJldHVybgogICAgfQogIH0KCiAgLy8gaW5jcmVtZW50IG5vdywgc28gd2UgY2FuIGNvbW1pdCB0byBwdW5jaGluZwogIGlmIChpc1JhbmRvbSkgYy5kaHQuX3JhbmRvbVB1bmNoZXMrKwoKICBsZXQgcmVwbHkKCiAgdHJ5IHsKICAgIC8vIGlmIGRlbGF5ZWQgc3dpdGNoIHRvIHRoZSBzZXJ2ZXJzIGNob3NlbiByZWxheSAtIHdlIHZhbGlkYXRlZCBhbnl3YXkKICAgIHJlcGx5ID0gYXdhaXQgdXBkYXRlSG9sZXB1bmNoKAogICAgICBjLAogICAgICBkZWxheWVkID8gc2VydmVyUmVsYXkucGVlckFkZHJlc3MgOiBzZXJ2ZXJBZGRyZXNzLAogICAgICBkZWxheWVkID8gc2VydmVyUmVsYXkucmVsYXlBZGRyZXNzIDogY2xpZW50UmVsYXksCiAgICAgIHsKICAgICAgICBlcnJvcjogRVJST1IuTk9ORSwKICAgICAgICBmaXJld2FsbDogYy5wdW5jaGVyLm5hdC5maXJld2FsbCwKICAgICAgICByb3VuZDogYy5yb3VuZCsrLAogICAgICAgIGNvbm5lY3RlZDogZmFsc2UsCiAgICAgICAgcHVuY2hpbmc6IHRydWUsCiAgICAgICAgYWRkcmVzc2VzOiBjLnB1bmNoZXIubmF0LmFkZHJlc3NlcywKICAgICAgICByZW1vdGVBZGRyZXNzOiBudWxsLAogICAgICAgIHRva2VuOiBkZWxheWVkID8gbnVsbCA6IGMucGF5bG9hZC50b2tlbihzZXJ2ZXJBZGRyZXNzKSwKICAgICAgICByZW1vdGVUb2tlbgogICAgICB9CiAgICApCiAgfSBmaW5hbGx5IHsKICAgIC8vIGRlY3JlbWVudCBhcyBwdW5jaCBpbmNyZW1lbnRzIGZvciB1cwogICAgaWYgKGlzUmFuZG9tKSBjLmRodC5fcmFuZG9tUHVuY2hlcy0tCiAgfQoKICBpZiAoaXNEb25lKGMpKSByZXR1cm4KICBpZiAoIXJlcGx5KSByZXR1cm4KCiAgaWYgKHJlcGx5LnRyeUxhdGVyKSB7CiAgICBhd2FpdCB0cnlMYXRlcihjKQogICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCiAgICByZXR1cm4gcm91bmRQdW5jaChjLCBzZXJ2ZXJBZGRyZXNzLCByZW1vdGVUb2tlbiwgY2xpZW50UmVsYXksIHNlcnZlclJlbGF5LCB0cnVlKQogIH0KCiAgaWYgKCFjLnB1bmNoZXIucmVtb3RlSG9sZXB1bmNoaW5nKSB7CiAgICB0aHJvdyBSRU1PVEVfTk9UX0hPTEVQVU5DSElORygpCiAgfQoKICBpZiAoIShhd2FpdCBjLnB1bmNoZXIucHVuY2goKSkpIHsKICAgIHRocm93IFJFTU9URV9OT1RfSE9MRVBVTkNIQUJMRSgpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiB0cnlMYXRlcihjKSB7CiAgaWYgKCFjLnJlbGF5VG9rZW4pIHRocm93IEhPTEVQVU5DSF9BQk9SVEVEKCkKICBhd2FpdCBjLnNsZWVwZXIucGF1c2UoMTAwMDAgKyBNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkgKiAxMDAwMCkpCn0KCmZ1bmN0aW9uIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBlcnIpIHsKICBpZiAoaXNEb25lKGMpKSByZXR1cm4KICBpZiAoYy5lbmNyeXB0ZWRTb2NrZXQucmF3U3RyZWFtKSByZXR1cm4KICBpZiAoYy5yZWxheVNvY2tldCkgcmV0dXJuIC8vIHdhaXRpbmcgZm9yIHRoZSByZWxheQogIGlmIChjLnB1bmNoZXIgJiYgIWMucHVuY2hlci5kZXN0cm95ZWQpIHJldHVybiAvLyB3YWl0aW5nIGZvciB0aGUgcHVuY2hlcgogIGMuc2Vzc2lvbi5kZXN0cm95KCkKICBjLmVuY3J5cHRlZFNvY2tldC5kZXN0cm95KGVycikKfQoKYXN5bmMgZnVuY3Rpb24gYWJvcnQoYywgeyBwZWVyQWRkcmVzcywgcmVsYXlBZGRyZXNzIH0sIGVycikgewogIHRyeSB7CiAgICBhd2FpdCB1cGRhdGVIb2xlcHVuY2gocGVlckFkZHJlc3MsIHJlbGF5QWRkcmVzcywgewogICAgICBlcnJvcjogRVJST1IuQUJPUlRFRCwKICAgICAgZmlyZXdhbGw6IEZJUkVXQUxMLlVOS05PV04sCiAgICAgIHJvdW5kOiBjLnJvdW5kKyssCiAgICAgIGNvbm5lY3RlZDogZmFsc2UsCiAgICAgIHB1bmNoaW5nOiBmYWxzZSwKICAgICAgYWRkcmVzc2VzOiBudWxsLAogICAgICByZW1vdGVBZGRyZXNzOiBudWxsLAogICAgICB0b2tlbjogbnVsbCwKICAgICAgcmVtb3RlVG9rZW46IG51bGwKICAgIH0pCiAgfSBjYXRjaCB7fQoKICBkZXN0cm95UHVuY2hlcihjKQogIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBlcnIpCn0KCmZ1bmN0aW9uIHJlbGF5Q29ubmVjdGlvbihjLCByZWxheVRocm91Z2gsIHBheWxvYWQsIGhzKSB7CiAgbGV0IGlzSW5pdGlhdG9yCiAgbGV0IHB1YmxpY0tleQogIGxldCB0b2tlbgoKICBpZiAocGF5bG9hZC5yZWxheVRocm91Z2gpIHsKICAgIGlzSW5pdGlhdG9yID0gZmFsc2UKICAgIHB1YmxpY0tleSA9IHBheWxvYWQucmVsYXlUaHJvdWdoLnB1YmxpY0tleQogICAgdG9rZW4gPSBwYXlsb2FkLnJlbGF5VGhyb3VnaC50b2tlbgogIH0gZWxzZSB7CiAgICBpc0luaXRpYXRvciA9IHRydWUKICAgIHB1YmxpY0tleSA9IHJlbGF5VGhyb3VnaAogICAgdG9rZW4gPSBjLnJlbGF5VG9rZW4KICB9CgogIGMucmVsYXlUb2tlbiA9IHRva2VuCiAgYy5yZWxheVNvY2tldCA9IGMuZGh0LmNvbm5lY3QocHVibGljS2V5KQogIGMucmVsYXlTb2NrZXQuc2V0S2VlcEFsaXZlKGMucmVsYXlLZWVwQWxpdmUpCiAgYy5yZWxheUNsaWVudCA9IHJlbGF5LkNsaWVudC5mcm9tKGMucmVsYXlTb2NrZXQsIHsgaWQ6IGMucmVsYXlTb2NrZXQucHVibGljS2V5IH0pCiAgYy5yZWxheVRpbWVvdXQgPSBzZXRUaW1lb3V0KG9uYWJvcnQsIDE1MDAwLCBudWxsKQoKICBjLnJlbGF5Q2xpZW50LnBhaXIoaXNJbml0aWF0b3IsIHRva2VuLCBjLnJhd1N0cmVhbSkub24oJ2Vycm9yJywgb25hYm9ydCkub24oJ2RhdGEnLCBvbmRhdGEpCgogIGZ1bmN0aW9uIG9uZGF0YShyZW1vdGVJZCkgewogICAgaWYgKGMucmVsYXlUaW1lb3V0KSBjbGVhclJlbGF5VGltZW91dChjKQogICAgaWYgKGMucmF3U3RyZWFtID09PSBudWxsKSB7CiAgICAgIG9uYWJvcnQobnVsbCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgYy5yZWxheVBhaXJlZCA9IHRydWUKCiAgICBjb25zdCB7IHJlbW90ZVBvcnQsIHJlbW90ZUhvc3QsIHNvY2tldCB9ID0gYy5yZWxheVNvY2tldC5yYXdTdHJlYW0KCiAgICBjLnJhd1N0cmVhbQogICAgICAub24oJ2Nsb3NlJywgKCkgPT4gYy5yZWxheVNvY2tldC5kZXN0cm95KCkpCiAgICAgIC5jb25uZWN0KHNvY2tldCwgcmVtb3RlSWQsIHJlbW90ZVBvcnQsIHJlbW90ZUhvc3QpCgogICAgYy5lbmNyeXB0ZWRTb2NrZXQuc3RhcnQoYy5yYXdTdHJlYW0sIHsgaGFuZHNoYWtlOiBocyB9KQogIH0KCiAgZnVuY3Rpb24gb25hYm9ydChlcnIpIHsKICAgIGlmIChjLnJlbGF5VGltZW91dCkgY2xlYXJSZWxheVRpbWVvdXQoYykKICAgIGNvbnN0IHNvY2tldCA9IGMucmVsYXlTb2NrZXQKICAgIGMucmVsYXlUb2tlbiA9IG51bGwKICAgIGMucmVsYXlTb2NrZXQgPSBudWxsCiAgICBpZiAoc29ja2V0KSBzb2NrZXQuZGVzdHJveSgpCiAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgZXJyIHx8IFJFTEFZX0FCT1JURUQoKSkKICB9Cn0KCmZ1bmN0aW9uIGNsZWFyUGFzc2l2ZUNvbm5lY3RUaW1lb3V0KGMpIHsKICBjbGVhclRpbWVvdXQoYy5wYXNzaXZlQ29ubmVjdFRpbWVvdXQpCiAgYy5wYXNzaXZlQ29ubmVjdFRpbWVvdXQgPSBudWxsCn0KCmZ1bmN0aW9uIGNsZWFyUmVsYXlUaW1lb3V0KGMpIHsKICBjbGVhclRpbWVvdXQoYy5yZWxheVRpbWVvdXQpCiAgYy5yZWxheVRpbWVvdXQgPSBudWxsCn0KCmZ1bmN0aW9uIGRlc3Ryb3lQdW5jaGVyKGMpIHsKICBpZiAoYy5wdW5jaGVyKSBjLnB1bmNoZXIuZGVzdHJveSgpCiAgYy5zZXNzaW9uLmRlc3Ryb3koKQp9CgpmdW5jdGlvbiBwaWNrU2VydmVyUmVsYXkocmVsYXlzLCBjbGllbnRSZWxheSkgewogIGZvciAoY29uc3QgciBvZiByZWxheXMpIHsKICAgIGlmICghZGlmZkFkZHJlc3Moci5yZWxheUFkZHJlc3MsIGNsaWVudFJlbGF5KSkgcmV0dXJuIHIKICB9CiAgcmV0dXJuIHJlbGF5c1swXQp9CgpmdW5jdGlvbiBkaWZmQWRkcmVzcyhhLCBiKSB7CiAgcmV0dXJuIGEuaG9zdCAhPT0gYi5ob3N0IHx8IGEucG9ydCAhPT0gYi5wb3J0Cn0KCmZ1bmN0aW9uIGRlZmF1bHRDcmVhdGVIYW5kc2hha2Uoa2V5UGFpciwgcmVtb3RlUHVibGljS2V5KSB7CiAgcmV0dXJuIG5ldyBOb2lzZVdyYXAoa2V5UGFpciwgcmVtb3RlUHVibGljS2V5KQp9CgpmdW5jdGlvbiBkZWZhdWx0Q3JlYXRlU2VjcmV0U3RyZWFtKGlzSW5pdGlhdG9yLCByYXdTdHJlYW0sIG9wdHMpIHsKICByZXR1cm4gbmV3IE5vaXNlU2VjcmV0U3RyZWFtKGlzSW5pdGlhdG9yLCByYXdTdHJlYW0sIG9wdHMpCn0KCmZ1bmN0aW9uIG9ubHlQcml2YXRlSG9zdHMoYWRkcikgewogIHJldHVybiBpc1ByaXZhdGUoYWRkci5ob3N0KQp9CgpmdW5jdGlvbiBpc1JlbGF5KHJlbGF5U29ja2V0LCBzb2NrZXQsIHBvcnQsIGhvc3QpIHsKICBjb25zdCBzdHJlYW0gPSByZWxheVNvY2tldC5yYXdTdHJlYW0KICBpZiAoIXN0cmVhbSkgcmV0dXJuIGZhbHNlCiAgaWYgKHN0cmVhbS5zb2NrZXQgIT09IHNvY2tldCkgcmV0dXJuIGZhbHNlCiAgcmV0dXJuIHBvcnQgPT09IHN0cmVhbS5yZW1vdGVQb3J0ICYmIGhvc3QgPT09IHN0cmVhbS5yZW1vdGVIb3N0Cn0KCmZ1bmN0aW9uIHNlbGVjdFJlbGF5KHJlbGF5VGhyb3VnaCkgewogIGlmICh0eXBlb2YgcmVsYXlUaHJvdWdoID09PSAnZnVuY3Rpb24nKSByZWxheVRocm91Z2ggPSByZWxheVRocm91Z2goKQogIGlmIChyZWxheVRocm91Z2ggPT09IG51bGwpIHJldHVybiBudWxsCiAgaWYgKEFycmF5LmlzQXJyYXkocmVsYXlUaHJvdWdoKSkKICAgIHJldHVybiByZWxheVRocm91Z2hbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogcmVsYXlUaHJvdWdoLmxlbmd0aCldCiAgcmV0dXJuIHJlbGF5VGhyb3VnaAp9CgpmdW5jdGlvbiBub29wKCkge30KY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi9lcnJvcnMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBDb25uZWN0aW9uUG9vbCBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IoZGh0KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5fZGh0ID0gZGh0CiAgICB0aGlzLl9zZXJ2ZXJzID0gbmV3IE1hcCgpCiAgICB0aGlzLl9jb25uZWN0aW5nID0gbmV3IE1hcCgpCiAgICB0aGlzLl9jb25uZWN0aW9ucyA9IG5ldyBNYXAoKQogIH0KCiAgX2F0dGFjaFNlcnZlcihzZXJ2ZXIpIHsKICAgIGNvbnN0IGtleVN0cmluZyA9IGI0YS50b1N0cmluZyhzZXJ2ZXIucHVibGljS2V5LCAnaGV4JykKCiAgICB0aGlzLl9zZXJ2ZXJzLnNldChrZXlTdHJpbmcsIHNlcnZlcikKCiAgICBzZXJ2ZXIKICAgICAgLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgICB0aGlzLl9zZXJ2ZXJzLmRlbGV0ZShrZXlTdHJpbmcpCiAgICAgIH0pCiAgICAgIC5vbignY29ubmVjdGlvbicsIChzb2NrZXQpID0+IHsKICAgICAgICB0aGlzLl9hdHRhY2hTdHJlYW0oc29ja2V0LCB0cnVlKQogICAgICB9KQogIH0KCiAgX2F0dGFjaFN0cmVhbShzdHJlYW0sIG9wZW5lZCkgewogICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLmdldChzdHJlYW0ucmVtb3RlUHVibGljS2V5KQoKICAgIGlmIChleGlzdGluZykgewogICAgICBjb25zdCBrZWVwTmV3ID0KICAgICAgICBzdHJlYW0uaXNJbml0aWF0b3IgPT09IGV4aXN0aW5nLmlzSW5pdGlhdG9yIHx8CiAgICAgICAgYjRhLmNvbXBhcmUoc3RyZWFtLnB1YmxpY0tleSwgc3RyZWFtLnJlbW90ZVB1YmxpY0tleSkgPiAwCgogICAgICBpZiAoa2VlcE5ldykgewogICAgICAgIGxldCBjbG9zZWQgPSBmYWxzZQoKICAgICAgICBjb25zdCBvbmNsb3NlID0gKCkgPT4gewogICAgICAgICAgY2xvc2VkID0gdHJ1ZQogICAgICAgIH0KCiAgICAgICAgZXhpc3RpbmcKICAgICAgICAgIC5vbignZXJyb3InLCBub29wKQogICAgICAgICAgLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgICAgICAgaWYgKGNsb3NlZCkgcmV0dXJuCgogICAgICAgICAgICBzdHJlYW0ub2ZmKCdlcnJvcicsIG5vb3ApLm9mZignY2xvc2UnLCBvbmNsb3NlKQoKICAgICAgICAgICAgdGhpcy5fYXR0YWNoU3RyZWFtKHN0cmVhbSwgb3BlbmVkKQogICAgICAgICAgfSkKICAgICAgICAgIC5kZXN0cm95KGVycm9ycy5EVVBMSUNBVEVfQ09OTkVDVElPTigpKQoKICAgICAgICBzdHJlYW0ub24oJ2Vycm9yJywgbm9vcCkub24oJ2Nsb3NlJywgb25jbG9zZSkKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHJlYW0ub24oJ2Vycm9yJywgbm9vcCkuZGVzdHJveShlcnJvcnMuRFVQTElDQVRFX0NPTk5FQ1RJT04oKSkKICAgICAgfQoKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3Qgc2Vzc2lvbiA9IG5ldyBDb25uZWN0aW9uUmVmKHRoaXMsIHN0cmVhbSkKCiAgICBjb25zdCBrZXlTdHJpbmcgPSBiNGEudG9TdHJpbmcoc3RyZWFtLnJlbW90ZVB1YmxpY0tleSwgJ2hleCcpCgogICAgaWYgKG9wZW5lZCkgewogICAgICB0aGlzLl9jb25uZWN0aW9ucy5zZXQoa2V5U3RyaW5nLCBzZXNzaW9uKQoKICAgICAgc3RyZWFtLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgICB0aGlzLl9jb25uZWN0aW9ucy5kZWxldGUoa2V5U3RyaW5nKQogICAgICB9KQoKICAgICAgdGhpcy5lbWl0KCdjb25uZWN0aW9uJywgc3RyZWFtLCBzZXNzaW9uKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fY29ubmVjdGluZy5zZXQoa2V5U3RyaW5nLCBzZXNzaW9uKQoKICAgICAgc3RyZWFtCiAgICAgICAgLm9uKCdlcnJvcicsIG5vb3ApCiAgICAgICAgLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgICAgIGlmIChvcGVuZWQpIHRoaXMuX2Nvbm5lY3Rpb25zLmRlbGV0ZShrZXlTdHJpbmcpCiAgICAgICAgICBlbHNlIHRoaXMuX2Nvbm5lY3RpbmcuZGVsZXRlKGtleVN0cmluZykKICAgICAgICB9KQogICAgICAgIC5vbignb3BlbicsICgpID0+IHsKICAgICAgICAgIG9wZW5lZCA9IHRydWUKCiAgICAgICAgICB0aGlzLl9jb25uZWN0aW5nLmRlbGV0ZShrZXlTdHJpbmcpCiAgICAgICAgICB0aGlzLl9jb25uZWN0aW9ucy5zZXQoa2V5U3RyaW5nLCBzZXNzaW9uKQoKICAgICAgICAgIHN0cmVhbS5vZmYoJ2Vycm9yJywgbm9vcCkKCiAgICAgICAgICB0aGlzLmVtaXQoJ2Nvbm5lY3Rpb24nLCBzdHJlYW0sIHNlc3Npb24pCiAgICAgICAgfSkKICAgIH0KCiAgICByZXR1cm4gc2Vzc2lvbgogIH0KCiAgZ2V0IGNvbm5lY3RpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5fY29ubmVjdGluZy5zaXplCiAgfQoKICBnZXQgY29ubmVjdGlvbnMoKSB7CiAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbnMudmFsdWVzKCkKICB9CgogIGhhcyhwdWJsaWNLZXkpIHsKICAgIGNvbnN0IGtleVN0cmluZyA9IGI0YS50b1N0cmluZyhwdWJsaWNLZXksICdoZXgnKQoKICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9ucy5oYXMoa2V5U3RyaW5nKSB8fCB0aGlzLl9jb25uZWN0aW5nLmhhcyhrZXlTdHJpbmcpCiAgfQoKICBnZXQocHVibGljS2V5KSB7CiAgICBjb25zdCBrZXlTdHJpbmcgPSBiNGEudG9TdHJpbmcocHVibGljS2V5LCAnaGV4JykKCiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuX2Nvbm5lY3Rpb25zLmdldChrZXlTdHJpbmcpIHx8IHRoaXMuX2Nvbm5lY3RpbmcuZ2V0KGtleVN0cmluZykKCiAgICByZXR1cm4gZXhpc3Rpbmc/Ll9zdHJlYW0gfHwgbnVsbAogIH0KfQoKY2xhc3MgQ29ubmVjdGlvblJlZiB7CiAgY29uc3RydWN0b3IocG9vbCwgc3RyZWFtKSB7CiAgICB0aGlzLl9wb29sID0gcG9vbAogICAgdGhpcy5fc3RyZWFtID0gc3RyZWFtCiAgICB0aGlzLl9yZWZzID0gMAogIH0KCiAgYWN0aXZlKCkgewogICAgdGhpcy5fcmVmcysrCiAgfQoKICBpbmFjdGl2ZSgpIHsKICAgIHRoaXMuX3JlZnMtLQogIH0KCiAgcmVsZWFzZSgpIHsKICAgIHRoaXMuX3N0cmVhbS5kZXN0cm95KCkKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKCmNvbnN0IENPTU1BTkRTID0gKGV4cG9ydHMuQ09NTUFORFMgPSB7CiAgUEVFUl9IQU5EU0hBS0U6IDAsCiAgUEVFUl9IT0xFUFVOQ0g6IDEsCiAgRklORF9QRUVSOiAyLAogIExPT0tVUDogMywKICBBTk5PVU5DRTogNCwKICBVTkFOTk9VTkNFOiA1LAogIE1VVEFCTEVfUFVUOiA2LAogIE1VVEFCTEVfR0VUOiA3LAogIElNTVVUQUJMRV9QVVQ6IDgsCiAgSU1NVVRBQkxFX0dFVDogOQp9KQoKZXhwb3J0cy5CT09UU1RSQVBfTk9ERVMgPSBnbG9iYWwuUGVhcj8uY29uZmlnLmRodD8uYm9vdHN0cmFwIHx8IFsKICAnODguOTkuMy44NkBub2RlMS5oeXBlcmRodC5vcmc6NDk3MzcnLAogICcxNDIuOTMuOTAuMTEzQG5vZGUyLmh5cGVyZGh0Lm9yZzo0OTczNycsCiAgJzEzOC42OC4xNDcuOEBub2RlMy5oeXBlcmRodC5vcmc6NDk3MzcnCl0KCmV4cG9ydHMuS05PV05fTk9ERVMgPSBnbG9iYWwuUGVhcj8uY29uZmlnLmRodD8ubm9kZXMgfHwgW10KCmV4cG9ydHMuRklSRVdBTEwgPSB7CiAgVU5LTk9XTjogMCwKICBPUEVOOiAxLAogIENPTlNJU1RFTlQ6IDIsCiAgUkFORE9NOiAzCn0KCmV4cG9ydHMuRVJST1IgPSB7CiAgLy8gbm9pc2UgLyBjb25uZWN0aW9uIHJlbGF0ZWQKICBOT05FOiAwLAogIEFCT1JURUQ6IDEsCiAgVkVSU0lPTl9NSVNNQVRDSDogMiwKICBUUllfTEFURVI6IDMsCiAgLy8gZGh0IHJlbGF0ZWQKICBTRVFfUkVVU0VEOiAxNiwKICBTRVFfVE9PX0xPVzogMTcKfQoKY29uc3QgW05TX0FOTk9VTkNFLCBOU19VTkFOTk9VTkNFLCBOU19NVVRBQkxFX1BVVCwgTlNfUEVFUl9IQU5EU0hBS0UsIE5TX1BFRVJfSE9MRVBVTkNIXSA9CiAgY3J5cHRvLm5hbWVzcGFjZSgnaHlwZXJzd2FybS9kaHQnLCBbCiAgICBDT01NQU5EUy5BTk5PVU5DRSwKICAgIENPTU1BTkRTLlVOQU5OT1VOQ0UsCiAgICBDT01NQU5EUy5NVVRBQkxFX1BVVCwKICAgIENPTU1BTkRTLlBFRVJfSEFORFNIQUtFLAogICAgQ09NTUFORFMuUEVFUl9IT0xFUFVOQ0gKICBdKQoKZXhwb3J0cy5OUyA9IHsKICBBTk5PVU5DRTogTlNfQU5OT1VOQ0UsCiAgVU5BTk5PVU5DRTogTlNfVU5BTk5PVU5DRSwKICBNVVRBQkxFX1BVVDogTlNfTVVUQUJMRV9QVVQsCiAgUEVFUl9IQU5EU0hBS0U6IE5TX1BFRVJfSEFORFNIQUtFLAogIFBFRVJfSE9MRVBVTkNIOiBOU19QRUVSX0hPTEVQVU5DSAp9CmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKZnVuY3Rpb24gaGFzaChkYXRhKSB7CiAgY29uc3Qgb3V0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKQogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2gob3V0LCBkYXRhKQogIHJldHVybiBvdXQKfQoKZnVuY3Rpb24gdW5zbGFiYmVkSGFzaChkYXRhKSB7CiAgY29uc3Qgb3V0ID0gYjRhLmFsbG9jVW5zYWZlU2xvdygzMikKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKG91dCwgZGF0YSkKICByZXR1cm4gb3V0Cn0KCmZ1bmN0aW9uIGNyZWF0ZUtleVBhaXIoc2VlZCkgewogIGNvbnN0IHB1YmxpY0tleSA9IGI0YS5hbGxvYygzMikKICBjb25zdCBzZWNyZXRLZXkgPSBiNGEuYWxsb2MoNjQpCiAgaWYgKHNlZWQpIHNvZGl1bS5jcnlwdG9fc2lnbl9zZWVkX2tleXBhaXIocHVibGljS2V5LCBzZWNyZXRLZXksIHNlZWQpCiAgZWxzZSBzb2RpdW0uY3J5cHRvX3NpZ25fa2V5cGFpcihwdWJsaWNLZXksIHNlY3JldEtleSkKICByZXR1cm4geyBwdWJsaWNLZXksIHNlY3JldEtleSB9Cn0KCm1vZHVsZS5leHBvcnRzID0gewogIGhhc2gsCiAgdW5zbGFiYmVkSGFzaCwKICBjcmVhdGVLZXlQYWlyCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgY2VuYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQoKZnVuY3Rpb24gZW5jb2RlVW5zbGFiKGVuYywgbSkgewogIC8vIEZhc3RlciB0aGFuIHVuc2xhYihjLmVuY29kZShlbmMsIGRhdGEpKSBiZWNhdXNlIGl0IGF2b2lkcyB0aGUgbWVtIGNvcHkuCiAgLy8gTWFrZXMgc2Vuc2UgdG8gcHV0IGluIGNvbXBhY3QtZW5jb2Rpbmcgd2hlbiB3ZSBuZWVkIGl0IGluIG90aGVyIG1vZHVsZXMgdG9vCiAgY29uc3Qgc3RhdGUgPSBjZW5jLnN0YXRlKCkKICBlbmMucHJlZW5jb2RlKHN0YXRlLCBtKQogIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coc3RhdGUuZW5kKQogIGVuYy5lbmNvZGUoc3RhdGUsIG0pCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlcgp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBlbmNvZGVVbnNsYWIKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIERIVEVycm9yIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yKG1zZywgY29kZSwgZm4gPSBESFRFcnJvcikgewogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWApCiAgICB0aGlzLmNvZGUgPSBjb2RlCgogICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIGZuKQogICAgfQogIH0KCiAgZ2V0IG5hbWUoKSB7CiAgICByZXR1cm4gJ0RIVEVycm9yJwogIH0KCiAgc3RhdGljIEJBRF9IQU5EU0hBS0VfUkVQTFkobXNnID0gJ0JhZCBoYW5kc2hha2UgcmVwbHknKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0JBRF9IQU5EU0hBS0VfUkVQTFknLCBESFRFcnJvci5CQURfSEFORFNIQUtFX1JFUExZKQogIH0KCiAgc3RhdGljIEJBRF9IT0xFUFVOQ0hfUkVQTFkobXNnID0gJ0JhZCBob2xlcHVuY2ggcmVwbHknKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0JBRF9IT0xFUFVOQ0hfUkVQTFknLCBESFRFcnJvci5CQURfSE9MRVBVTkNIX1JFUExZKQogIH0KCiAgc3RhdGljIEhPTEVQVU5DSF9BQk9SVEVEKG1zZyA9ICdIb2xlcHVuY2ggYWJvcnRlZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnSE9MRVBVTkNIX0FCT1JURUQnLCBESFRFcnJvci5IT0xFUFVOQ0hfQUJPUlRFRCkKICB9CgogIHN0YXRpYyBIT0xFUFVOQ0hfSU5WQUxJRChtc2cgPSAnSW52YWxpZCBob2xlcHVuY2ggcGF5bG9hZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnSE9MRVBVTkNIX0lOVkFMSUQnLCBESFRFcnJvci5IT0xFUFVOQ0hfSU5WQUxJRCkKICB9CgogIHN0YXRpYyBIT0xFUFVOQ0hfUFJPQkVfVElNRU9VVChtc2cgPSAnSG9sZXB1bmNoaW5nIHByb2JlIGRpZCBub3QgZmluaXNoIGluIHRpbWUnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0hPTEVQVU5DSF9QUk9CRV9USU1FT1VUJywgREhURXJyb3IuSE9MRVBVTkNIX1BST0JFX1RJTUVPVVQpCiAgfQoKICBzdGF0aWMgSE9MRVBVTkNIX0RPVUJMRV9SQU5ET01JWkVEX05BVFMobXNnID0gJ0JvdGggcmVtb3RlIGFuZCBsb2NhbCBOQVRzIGFyZSByYW5kb21pemVkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcigKICAgICAgbXNnLAogICAgICAnSE9MRVBVTkNIX0RPVUJMRV9SQU5ET01JWkVEX05BVFMnLAogICAgICBESFRFcnJvci5IT0xFUFVOQ0hfRE9VQkxFX1JBTkRPTUlaRURfTkFUUwogICAgKQogIH0KCiAgc3RhdGljIENBTk5PVF9IT0xFUFVOQ0gobXNnID0gJ0Nhbm5vdCBob2xlcHVuY2ggdG8gcmVtb3RlJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdDQU5OT1RfSE9MRVBVTkNIJywgREhURXJyb3IuQ0FOTk9UX0hPTEVQVU5DSCkKICB9CgogIHN0YXRpYyBSRU1PVEVfTk9UX0hPTEVQVU5DSElORyhtc2cgPSAnUmVtb3RlIGlzIG5vdCBob2xlcHVuY2hpbmcnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ1JFTU9URV9OT1RfSE9MRVBVTkNISU5HJywgREhURXJyb3IuUkVNT1RFX05PVF9IT0xFUFVOQ0hJTkcpCiAgfQoKICBzdGF0aWMgUkVNT1RFX05PVF9IT0xFUFVOQ0hBQkxFKG1zZyA9ICdSZW1vdGUgaXMgbm90IGhvbGVwdW5jaGFibGUnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ1JFTU9URV9OT1RfSE9MRVBVTkNIQUJMRScsIERIVEVycm9yLlJFTU9URV9OT1RfSE9MRVBVTkNIQUJMRSkKICB9CgogIHN0YXRpYyBSRU1PVEVfQUJPUlRFRChtc2cgPSAnUmVtb3RlIGFib3J0ZWQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ1JFTU9URV9BQk9SVEVEJywgREhURXJyb3IuUkVNT1RFX0FCT1JURUQpCiAgfQoKICBzdGF0aWMgSEFORFNIQUtFX1VORklOSVNIRUQobXNnID0gJ0hhbmRzaGFrZSBkaWQgbm90IGZpbmlzaCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnSEFORFNIQUtFX1VORklOSVNIRUQnLCBESFRFcnJvci5IQU5EU0hBS0VfVU5GSU5JU0hFRCkKICB9CgogIHN0YXRpYyBIQU5EU0hBS0VfSU5WQUxJRChtc2cgPSAnUmVjZWl2ZWQgaW52YWxpZCBoYW5kc2hha2UnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0hBTkRTSEFLRV9JTlZBTElEJywgREhURXJyb3IuSEFORFNIQUtFX0lOVkFMSUQpCiAgfQoKICBzdGF0aWMgQUxSRUFEWV9MSVNURU5JTkcobXNnID0gJ0FscmVhZHkgbGlzdGVuaW5nJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdBTFJFQURZX0xJU1RFTklORycsIERIVEVycm9yLkFMUkVBRFlfTElTVEVOSU5HKQogIH0KCiAgc3RhdGljIEtFWVBBSVJfQUxSRUFEWV9VU0VEKG1zZyA9ICdLZXlwYWlyIGFscmVhZHkgdXNlZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnS0VZUEFJUl9BTFJFQURZX1VTRUQnLCBESFRFcnJvci5LRVlQQUlSX0FMUkVBRFlfVVNFRCkKICB9CgogIHN0YXRpYyBOT0RFX0RFU1RST1lFRChtc2cgPSAnTm9kZSBkZXN0cm95ZWQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ05PREVfREVTVFJPWUVEJywgREhURXJyb3IuTk9ERV9ERVNUUk9ZRUQpCiAgfQoKICBzdGF0aWMgUEVFUl9DT05ORUNUSU9OX0ZBSUxFRChtc2cgPSAnQ291bGQgbm90IGNvbm5lY3QgdG8gcGVlcicpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnUEVFUl9DT05ORUNUSU9OX0ZBSUxFRCcsIERIVEVycm9yLlBFRVJfQ09OTkVDVElPTl9GQUlMRUQpCiAgfQoKICBzdGF0aWMgUEVFUl9OT1RfRk9VTkQobXNnID0gJ1BlZXIgbm90IGZvdW5kJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdQRUVSX05PVF9GT1VORCcsIERIVEVycm9yLlBFRVJfTk9UX0ZPVU5EKQogIH0KCiAgc3RhdGljIFNUUkVBTV9OT1RfQ09OTkVDVEVEKG1zZyA9ICdTdHJlYW0gaXMgbm90IGNvbm5lY3RlZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnU1RSRUFNX05PVF9DT05ORUNURUQnLCBESFRFcnJvci5TVFJFQU1fRElTQ09OTkVDVEVEKQogIH0KCiAgc3RhdGljIFNFUlZFUl9JTkNPTVBBVElCTEUobXNnID0gJ1NlcnZlciBpcyB1c2luZyBhbiBpbmNvbXBhdGlibGUgdmVyc2lvbicpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnU0VSVkVSX0lOQ09NUEFUSUJMRScsIERIVEVycm9yLlNFUlZFUl9JTkNPTVBBVElCTEUpCiAgfQoKICBzdGF0aWMgU0VSVkVSX0VSUk9SKG1zZyA9ICdTZXJ2ZXIgcmV0dXJuZWQgYW4gZXJyb3InKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ1NFUlZFUl9FUlJPUicsIERIVEVycm9yLlNFUlZFUl9FUlJPUikKICB9CgogIHN0YXRpYyBEVVBMSUNBVEVfQ09OTkVDVElPTihtc2cgPSAnRHVwbGljYXRlIGNvbm5lY3Rpb24nKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0RVUExJQ0FURV9DT05ORUNUSU9OJywgREhURXJyb3IuRFVQTElDQVRFX0NPTk5FQ1RJT04pCiAgfQoKICBzdGF0aWMgUkVMQVlfQUJPUlRFRChtc2cgPSAnUmVsYXkgYWJvcnRlZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnUkVMQVlfQUJPUlRFRCcsIERIVEVycm9yLlJFTEFZX0FCT1JURUQpCiAgfQoKICBzdGF0aWMgU1VTUEVOREVEKG1zZyA9ICdTdXNwZW5kZWQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ1NVU1BFTkRFRCcsIERIVEVycm9yLlNVU1BFTkRFRCkKICB9Cn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgTmF0ID0gcmVxdWlyZSgnLi9uYXQnKQpjb25zdCBTbGVlcGVyID0gcmVxdWlyZSgnLi9zbGVlcGVyJykKY29uc3QgeyBGSVJFV0FMTCB9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKY29uc3QgQklSVEhEQVlfU09DS0VUUyA9IDI1Ngpjb25zdCBIT0xFUFVOQ0ggPSBiNGEuZnJvbShbMF0pCmNvbnN0IEhPTEVQVU5DSF9UVEwgPSA1CmNvbnN0IERFRkFVTFRfVFRMID0gNjQKY29uc3QgTUFYX1JFT1BFTlMgPSAzCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEhvbGVwdW5jaGVyIHsKICBjb25zdHJ1Y3RvcihkaHQsIHNlc3Npb24sIGlzSW5pdGlhdG9yLCByZW1vdGVGaXJld2FsbCA9IEZJUkVXQUxMLlVOS05PV04pIHsKICAgIGNvbnN0IGhvbGRlciA9IGRodC5fc29ja2V0UG9vbC5hY3F1aXJlKCkKCiAgICB0aGlzLmRodCA9IGRodAogICAgdGhpcy5zZXNzaW9uID0gc2Vzc2lvbgoKICAgIHRoaXMubmF0ID0gbmV3IE5hdChkaHQsIHNlc3Npb24sIGhvbGRlci5zb2NrZXQpCiAgICB0aGlzLm5hdC5hdXRvU2FtcGxlKCkKCiAgICB0aGlzLmlzSW5pdGlhdG9yID0gaXNJbml0aWF0b3IKCiAgICAvLyBldmVudHMKICAgIHRoaXMub25jb25uZWN0ID0gbm9vcAogICAgdGhpcy5vbmFib3J0ID0gbm9vcAoKICAgIHRoaXMucHVuY2hpbmcgPSBmYWxzZQogICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZQogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5yYW5kb21pemVkID0gZmFsc2UKCiAgICAvLyB0cmFjayByZW1vdGUgc3RhdGUKICAgIHRoaXMucmVtb3RlRmlyZXdhbGwgPSByZW1vdGVGaXJld2FsbAogICAgdGhpcy5yZW1vdGVBZGRyZXNzZXMgPSBbXQogICAgdGhpcy5yZW1vdGVIb2xlcHVuY2hpbmcgPSBmYWxzZQoKICAgIHRoaXMuX3NsZWVwZXIgPSBuZXcgU2xlZXBlcigpCiAgICB0aGlzLl9yZW9wZW5pbmcgPSBudWxsCiAgICB0aGlzLl90aW1lb3V0ID0gbnVsbAogICAgdGhpcy5fcHVuY2hpbmcgPSBudWxsCiAgICB0aGlzLl9hbGxIb2xkZXJzID0gW10KICAgIHRoaXMuX2hvbGRlciA9IHRoaXMuX2FkZFJlZihob2xkZXIpCiAgfQoKICBnZXQgc29ja2V0KCkgewogICAgcmV0dXJuIHRoaXMuX2hvbGRlci5zb2NrZXQKICB9CgogIHVwZGF0ZVJlbW90ZSh7IHB1bmNoaW5nLCBmaXJld2FsbCwgYWRkcmVzc2VzLCB2ZXJpZmllZCB9KSB7CiAgICBjb25zdCByZW1vdGVBZGRyZXNzZXMgPSBbXQoKICAgIGlmIChhZGRyZXNzZXMpIHsKICAgICAgZm9yIChjb25zdCBhZGRyIG9mIGFkZHJlc3NlcykgewogICAgICAgIHJlbW90ZUFkZHJlc3Nlcy5wdXNoKHsKICAgICAgICAgIGhvc3Q6IGFkZHIuaG9zdCwKICAgICAgICAgIHBvcnQ6IGFkZHIucG9ydCwKICAgICAgICAgIHZlcmlmaWVkOiB2ZXJpZmllZCA9PT0gYWRkci5ob3N0IHx8IHRoaXMuX2lzVmVyaWZpZWQoYWRkci5ob3N0KQogICAgICAgIH0pCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnJlbW90ZUZpcmV3YWxsID0gZmlyZXdhbGwKICAgIHRoaXMucmVtb3RlQWRkcmVzc2VzID0gcmVtb3RlQWRkcmVzc2VzCiAgICB0aGlzLnJlbW90ZUhvbGVwdW5jaGluZyA9IHB1bmNoaW5nCiAgfQoKICBfaXNWZXJpZmllZChob3N0KSB7CiAgICBmb3IgKGNvbnN0IGFkZHIgb2YgdGhpcy5yZW1vdGVBZGRyZXNzZXMpIHsKICAgICAgaWYgKGFkZHIudmVyaWZpZWQgJiYgYWRkci5ob3N0ID09PSBob3N0KSB7CiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBwaW5nKGFkZHIsIHNvY2tldCA9IHRoaXMuX2hvbGRlci5zb2NrZXQpIHsKICAgIHJldHVybiBob2xlcHVuY2goc29ja2V0LCBhZGRyLCBmYWxzZSkKICB9CgogIG9wZW5TZXNzaW9uKGFkZHIsIHNvY2tldCA9IHRoaXMuX2hvbGRlci5zb2NrZXQpIHsKICAgIHJldHVybiBob2xlcHVuY2goc29ja2V0LCBhZGRyLCB0cnVlKQogIH0KCiAgYXN5bmMgYW5hbHl6ZShhbGxvd1Jlb3BlbikgewogICAgYXdhaXQgdGhpcy5uYXQuYW5hbHl6aW5nCiAgICBpZiAodGhpcy5fdW5zdGFibGUoKSkgewogICAgICBpZiAoIWFsbG93UmVvcGVuKSByZXR1cm4gZmFsc2UKICAgICAgaWYgKCF0aGlzLl9yZW9wZW5pbmcpIHRoaXMuX3Jlb3BlbmluZyA9IHRoaXMuX3Jlb3BlbigpCiAgICAgIHJldHVybiB0aGlzLl9yZW9wZW5pbmcKICAgIH0KICAgIHJldHVybiB0cnVlCiAgfQoKICBfdW5zdGFibGUoKSB7CiAgICAvLyBUT0RPISE6IFdlIG5lZWQgYW4gYWRkaXRpb25hbCBoZXVyaXN0aWMgaGVyZS4uLiBJZiB3ZSB3ZXJlIE5PVCByYW5kb20gaW4gdGhlIHBhc3Qgd2Ugc2hvdWxkIGFsc28gZG8gdGhpcy4KICAgIGNvbnN0IGZpcmV3YWxsID0gdGhpcy5uYXQuZmlyZXdhbGwKICAgIHJldHVybiAoCiAgICAgICh0aGlzLnJlbW90ZUZpcmV3YWxsID49IEZJUkVXQUxMLlJBTkRPTSAmJiBmaXJld2FsbCA+PSBGSVJFV0FMTC5SQU5ET00pIHx8CiAgICAgIGZpcmV3YWxsID09PSBGSVJFV0FMTC5VTktOT1dOCiAgICApCiAgfQoKICBfcmVzZXQoKSB7CiAgICBjb25zdCBwcmV2ID0gdGhpcy5faG9sZGVyCgogICAgdGhpcy5fYWxsSG9sZGVycy5wb3AoKQogICAgdGhpcy5faG9sZGVyID0gdGhpcy5fYWRkUmVmKHRoaXMuZGh0Ll9zb2NrZXRQb29sLmFjcXVpcmUoKSkKCiAgICBwcmV2LnJlbGVhc2UoKQogICAgdGhpcy5uYXQuZGVzdHJveSgpCgogICAgdGhpcy5uYXQgPSBuZXcgTmF0KHRoaXMuZGh0LCB0aGlzLnNlc3Npb24sIHRoaXMuX2hvbGRlci5zb2NrZXQpCiAgICAvLyBUT0RPOiBtYXliZSBtYWtlIGF1dG8gc2FtcGxpbmcgY29uZmlndXJhYmxlIHNvbWVob3c/CiAgICB0aGlzLm5hdC5hdXRvU2FtcGxlKCkKICB9CgogIF9hZGRSZWYocmVmKSB7CiAgICB0aGlzLl9hbGxIb2xkZXJzLnB1c2gocmVmKQogICAgcmVmLm9uaG9sZXB1bmNobWVzc2FnZSA9IChtc2csIHJpbmZvKSA9PiB0aGlzLl9vbmhvbGVwdW5jaG1lc3NhZ2UobXNnLCByaW5mbywgcmVmKQogICAgcmV0dXJuIHJlZgogIH0KCiAgX29uaG9sZXB1bmNobWVzc2FnZShfLCBhZGRyLCByZWYpIHsKICAgIGlmICghdGhpcy5pc0luaXRpYXRvcikgewogICAgICAvLyBUT0RPOiB3ZSBkb24ndCBuZWVkIHRoaXMgaWYgd2UgaGFkIGEgd2F5IHRvIGNvbm5lY3QgYSBzb2NrZXQgdG8gbWFueSBob3N0cwogICAgICBob2xlcHVuY2gocmVmLnNvY2tldCwgYWRkciwgZmFsc2UpIC8vIG5ldmVyIGZhaWxzCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLmNvbm5lY3RlZCkgcmV0dXJuCgogICAgdGhpcy5jb25uZWN0ZWQgPSB0cnVlCiAgICB0aGlzLnB1bmNoaW5nID0gZmFsc2UKCiAgICBmb3IgKGNvbnN0IHIgb2YgdGhpcy5fYWxsSG9sZGVycykgewogICAgICBpZiAociA9PT0gcmVmKSBjb250aW51ZQogICAgICByLnJlbGVhc2UoKQogICAgfQoKICAgIHRoaXMuX2FsbEhvbGRlcnNbMF0gPSByZWYKICAgIHdoaWxlICh0aGlzLl9hbGxIb2xkZXJzLmxlbmd0aCA+IDEpIHRoaXMuX2FsbEhvbGRlcnMucG9wKCkKCiAgICB0aGlzLl9kZWNyZW1lbnRSYW5kb21pemVkKCkKICAgIHRoaXMub25jb25uZWN0KHJlZi5zb2NrZXQsIGFkZHIucG9ydCwgYWRkci5ob3N0KQogIH0KCiAgX2RvbmUoKSB7CiAgICByZXR1cm4gdGhpcy5kZXN0cm95ZWQgfHwgdGhpcy5jb25uZWN0ZWQKICB9CgogIGFzeW5jIF9yZW9wZW4oKSB7CiAgICBmb3IgKGxldCBpID0gMDsgdGhpcy5fdW5zdGFibGUoKSAmJiBpIDwgTUFYX1JFT1BFTlMgJiYgIXRoaXMuX2RvbmUoKSAmJiAhdGhpcy5wdW5jaGluZzsgaSsrKSB7CiAgICAgIHRoaXMuX3Jlc2V0KCkKICAgICAgYXdhaXQgdGhpcy5uYXQuYW5hbHl6aW5nCiAgICB9CgogICAgcmV0dXJuIGNvZXJjZUZpcmV3YWxsKHRoaXMubmF0LmZpcmV3YWxsKSA9PT0gRklSRVdBTEwuQ09OU0lTVEVOVAogIH0KCiAgcHVuY2goKSB7CiAgICBpZiAoIXRoaXMuX3B1bmNoaW5nKSB0aGlzLl9wdW5jaGluZyA9IHRoaXMuX3B1bmNoKCkKICAgIHJldHVybiB0aGlzLl9wdW5jaGluZwogIH0KCiAgYXN5bmMgX3B1bmNoKCkgewogICAgaWYgKHRoaXMuX2RvbmUoKSB8fCAhdGhpcy5yZW1vdGVBZGRyZXNzZXMubGVuZ3RoKSByZXR1cm4gZmFsc2UKCiAgICB0aGlzLnB1bmNoaW5nID0gdHJ1ZQoKICAgIC8vIENvZXJjZSBpbnRvIGNvbnNpc3RlbmN5IGZvciBub3cuIE9idnMgd2UgY291bGQgbWFrZSB0aGlzIHRoaXMgbW9yZSBlZmZpY2llbnQgaWYgd2UgdXNlIHRoYXQgaW5mbwogICAgLy8gYnV0IHRoYXQncyBzZWxkb21seSB1c2VkIHNpbmNlIHRob3NlIHdpbGwganVzdCB1c2UgdGNwIG1vc3Qgb2YgdGhlIHRpbWUuCgogICAgY29uc3QgbG9jYWwgPSBjb2VyY2VGaXJld2FsbCh0aGlzLm5hdC5maXJld2FsbCkKICAgIGNvbnN0IHJlbW90ZSA9IGNvZXJjZUZpcmV3YWxsKHRoaXMucmVtb3RlRmlyZXdhbGwpCgogICAgLy8gTm90ZSB0aGF0IG1vc3Qgb2YgdGhlc2UgYXN5bmMgZnVuY3Rpb25zIGFyZSBtZWFudCB0byBydW4gaW4gdGhlIGJhY2tncm91bmQKICAgIC8vIHdoaWNoIGlzIHdoeSB3ZSBkb24ndCBhd2FpdCB0aGVtIGhlcmUgYW5kIHdoeSB0aGV5IGFyZSBub3QgYWxsb3dlZCB0byB0aHJvdwoKICAgIGxldCByZW1vdGVWZXJpZmllZEFkZHJlc3MgPSBudWxsCiAgICBmb3IgKGNvbnN0IGFkZHIgb2YgdGhpcy5yZW1vdGVBZGRyZXNzZXMpIHsKICAgICAgaWYgKGFkZHIudmVyaWZpZWQpIHsKICAgICAgICByZW1vdGVWZXJpZmllZEFkZHJlc3MgPSBhZGRyCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIGlmIChsb2NhbCA9PT0gRklSRVdBTEwuQ09OU0lTVEVOVCAmJiByZW1vdGUgPT09IEZJUkVXQUxMLkNPTlNJU1RFTlQpIHsKICAgICAgdGhpcy5kaHQuc3RhdHMucHVuY2hlcy5jb25zaXN0ZW50KysKICAgICAgdGhpcy5fY29uc2lzdGVudFByb2JlKCkKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBpZiAoIXJlbW90ZVZlcmlmaWVkQWRkcmVzcykgcmV0dXJuIGZhbHNlCgogICAgaWYgKGxvY2FsID09PSBGSVJFV0FMTC5DT05TSVNURU5UICYmIHJlbW90ZSA+PSBGSVJFV0FMTC5SQU5ET00pIHsKICAgICAgdGhpcy5kaHQuc3RhdHMucHVuY2hlcy5yYW5kb20rKwogICAgICB0aGlzLl9pbmNyZW1lbnRSYW5kb21pemVkKCkKICAgICAgdGhpcy5fcmFuZG9tUHJvYmVzKHJlbW90ZVZlcmlmaWVkQWRkcmVzcykKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBpZiAobG9jYWwgPj0gRklSRVdBTEwuUkFORE9NICYmIHJlbW90ZSA9PT0gRklSRVdBTEwuQ09OU0lTVEVOVCkgewogICAgICB0aGlzLmRodC5zdGF0cy5wdW5jaGVzLnJhbmRvbSsrCiAgICAgIHRoaXMuX2luY3JlbWVudFJhbmRvbWl6ZWQoKQogICAgICBhd2FpdCB0aGlzLl9vcGVuQmlydGhkYXlTb2NrZXRzKHJlbW90ZVZlcmlmaWVkQWRkcmVzcykKICAgICAgaWYgKHRoaXMucHVuY2hpbmcpIHRoaXMuX2tlZXBBbGl2ZVJhbmRvbU5hdChyZW1vdGVWZXJpZmllZEFkZHJlc3MpCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICAvLyBOb3RlIHRoYXQgdGhpcyBuZXZlciB0aHJvd3Mgc28gaXQgaXMgc2FmZSB0byBydW4gaW4gdGhlIGJhY2tncm91bmQKICBhc3luYyBfY29uc2lzdGVudFByb2JlKCkgewogICAgLy8gSGVyZSB3ZSBkbyB0aGUgc2xlZXAgZmlyc3QgYmVjYXVzZSB0aGUgImZhc3Qgb3BlbiIgbW9kZSBpbiB0aGUgc2VydmVyIGp1c3QgZmlyZWQgYSBwaW5nCiAgICBpZiAoIXRoaXMuaXNJbml0aWF0b3IpIGF3YWl0IHRoaXMuX3NsZWVwZXIucGF1c2UoMTAwMCkKCiAgICBsZXQgdHJpZXMgPSAwCgogICAgd2hpbGUgKHRoaXMucHVuY2hpbmcgJiYgdHJpZXMrKyA8IDEwKSB7CiAgICAgIGZvciAoY29uc3QgYWRkciBvZiB0aGlzLnJlbW90ZUFkZHJlc3NlcykgewogICAgICAgIC8vIG9ubHkgdHJ5IHVudmVyaWZpZWQgYWRkcmVzc2VzIGV2ZXJ5IDQgdGlja3MKICAgICAgICBpZiAoIWFkZHIudmVyaWZpZWQgJiYgKHRyaWVzICYgMykgIT09IDApIGNvbnRpbnVlCiAgICAgICAgYXdhaXQgaG9sZXB1bmNoKHRoaXMuX2hvbGRlci5zb2NrZXQsIGFkZHIsIGZhbHNlKQogICAgICB9CiAgICAgIGlmICh0aGlzLnB1bmNoaW5nKSBhd2FpdCB0aGlzLl9zbGVlcGVyLnBhdXNlKDEwMDApCiAgICB9CgogICAgdGhpcy5fYXV0b0Rlc3Ryb3koKQogIH0KCiAgLy8gTm90ZSB0aGF0IHRoaXMgbmV2ZXIgdGhyb3dzIHNvIGl0IGlzIHNhZmUgdG8gcnVuIGluIHRoZSBiYWNrZ3JvdW5kCiAgYXN5bmMgX3JhbmRvbVByb2JlcyhyZW1vdGVBZGRyKSB7CiAgICBsZXQgdHJpZXMgPSAxNzUwIC8vIH4zNXMKCiAgICB3aGlsZSAodGhpcy5wdW5jaGluZyAmJiB0cmllcy0tID4gMCkgewogICAgICBjb25zdCBhZGRyID0geyBob3N0OiByZW1vdGVBZGRyLmhvc3QsIHBvcnQ6IHJhbmRvbVBvcnQoKSB9CiAgICAgIGF3YWl0IGhvbGVwdW5jaCh0aGlzLl9ob2xkZXIuc29ja2V0LCBhZGRyLCBmYWxzZSkKICAgICAgaWYgKHRoaXMucHVuY2hpbmcpIGF3YWl0IHRoaXMuX3NsZWVwZXIucGF1c2UoMjApCiAgICB9CgogICAgdGhpcy5fYXV0b0Rlc3Ryb3koKQogIH0KCiAgLy8gTm90ZSB0aGF0IHRoaXMgbmV2ZXIgdGhyb3dzIHNvIGl0IGlzIHNhZmUgdG8gcnVuIGluIHRoZSBiYWNrZ3JvdW5kCiAgYXN5bmMgX2tlZXBBbGl2ZVJhbmRvbU5hdChyZW1vdGVBZGRyKSB7CiAgICBsZXQgaSA9IDAKICAgIGxldCBsb3dUVExSb3VuZHMgPSAxCgogICAgLy8gVE9ETzogZXhwZXJpbWVudCB3aXRoIHRoaXMgaGVyZS4gV2UganVzdCBidXJzdGVkIGFsbCB0aGUgbWVzc2FnZXMgaW4KICAgIC8vIG9wZW5PdGhlclNvY2tldHMgdG8gZW5zdXJlIHRoZSBzb2NrZXRzIGFyZSBvcGVuLCBzbyBpdCdzIHBvdGVudGlhbGx5CiAgICAvLyBhIGdvb2QgaWRlYSB0byBzbG93IGRvd24gZm9yIGEgYml0LgogICAgYXdhaXQgdGhpcy5fc2xlZXBlci5wYXVzZSgxMDApCgogICAgbGV0IHRyaWVzID0gMTc1MCAvLyB+MzVzCgogICAgd2hpbGUgKHRoaXMucHVuY2hpbmcgJiYgdHJpZXMtLSA+IDApIHsKICAgICAgaWYgKGkgPT09IHRoaXMuX2FsbEhvbGRlcnMubGVuZ3RoKSB7CiAgICAgICAgaSA9IDAKICAgICAgICBpZiAobG93VFRMUm91bmRzID4gMCkgbG93VFRMUm91bmRzLS0KICAgICAgfQoKICAgICAgYXdhaXQgaG9sZXB1bmNoKHRoaXMuX2FsbEhvbGRlcnNbaSsrXS5zb2NrZXQsIHJlbW90ZUFkZHIsIGxvd1RUTFJvdW5kcyA+IDApCiAgICAgIGlmICh0aGlzLnB1bmNoaW5nKSBhd2FpdCB0aGlzLl9zbGVlcGVyLnBhdXNlKDIwKQogICAgfQoKICAgIHRoaXMuX2F1dG9EZXN0cm95KCkKICB9CgogIGFzeW5jIF9vcGVuQmlydGhkYXlTb2NrZXRzKHJlbW90ZUFkZHIpIHsKICAgIHdoaWxlICh0aGlzLnB1bmNoaW5nICYmIHRoaXMuX2FsbEhvbGRlcnMubGVuZ3RoIDwgQklSVEhEQVlfU09DS0VUUykgewogICAgICBjb25zdCByZWYgPSB0aGlzLl9hZGRSZWYodGhpcy5kaHQuX3NvY2tldFBvb2wuYWNxdWlyZSgpKQogICAgICBhd2FpdCBob2xlcHVuY2gocmVmLnNvY2tldCwgcmVtb3RlQWRkciwgSE9MRVBVTkNIX1RUTCkKICAgIH0KICB9CgogIF9hdXRvRGVzdHJveSgpIHsKICAgIGlmICghdGhpcy5jb25uZWN0ZWQpIHRoaXMuZGVzdHJveSgpCiAgfQoKICBfaW5jcmVtZW50UmFuZG9taXplZCgpIHsKICAgIGlmICghdGhpcy5yYW5kb21pemVkKSB7CiAgICAgIHRoaXMucmFuZG9taXplZCA9IHRydWUKICAgICAgdGhpcy5kaHQuX3JhbmRvbVB1bmNoZXMrKwogICAgfQogIH0KCiAgX2RlY3JlbWVudFJhbmRvbWl6ZWQoKSB7CiAgICBpZiAodGhpcy5yYW5kb21pemVkKSB7CiAgICAgIHRoaXMuZGh0Ll9sYXN0UmFuZG9tUHVuY2ggPSBEYXRlLm5vdygpCiAgICAgIHRoaXMucmFuZG9taXplZCA9IGZhbHNlCiAgICAgIHRoaXMuZGh0Ll9yYW5kb21QdW5jaGVzLS0KICAgIH0KICB9CgogIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCiAgICB0aGlzLnB1bmNoaW5nID0gZmFsc2UKCiAgICBmb3IgKGNvbnN0IHJlZiBvZiB0aGlzLl9hbGxIb2xkZXJzKSByZWYucmVsZWFzZSgpCiAgICB0aGlzLl9hbGxIb2xkZXJzID0gW10KICAgIHRoaXMubmF0LmRlc3Ryb3koKQoKICAgIGlmICghdGhpcy5jb25uZWN0ZWQpIHsKICAgICAgdGhpcy5fZGVjcmVtZW50UmFuZG9taXplZCgpCiAgICAgIHRoaXMub25hYm9ydCgpCiAgICB9CiAgfQoKICBzdGF0aWMgcGluZyhzb2NrZXQsIGFkZHIpIHsKICAgIHJldHVybiBob2xlcHVuY2goc29ja2V0LCBhZGRyLCBmYWxzZSkKICB9CgogIHN0YXRpYyBsb2NhbEFkZHJlc3Nlcyhzb2NrZXQpIHsKICAgIHJldHVybiBsb2NhbEFkZHJlc3Nlcyhzb2NrZXQpCiAgfQoKICBzdGF0aWMgbWF0Y2hBZGRyZXNzKG15QWRkcmVzc2VzLCBleHRlcm5hbEFkZHJlc3NlcykgewogICAgcmV0dXJuIG1hdGNoQWRkcmVzcyhteUFkZHJlc3NlcywgZXh0ZXJuYWxBZGRyZXNzZXMpCiAgfQp9CgpmdW5jdGlvbiBob2xlcHVuY2goc29ja2V0LCBhZGRyLCBsb3dUVEwpIHsKICByZXR1cm4gc29ja2V0LnNlbmQoSE9MRVBVTkNILCBhZGRyLnBvcnQsIGFkZHIuaG9zdCwgbG93VFRMID8gSE9MRVBVTkNIX1RUTCA6IERFRkFVTFRfVFRMKQp9CgpmdW5jdGlvbiByYW5kb21Qb3J0KCkgewogIHJldHVybiAoMTAwMCArIE1hdGgucmFuZG9tKCkgKiA2NDUzNikgfCAwCn0KCmZ1bmN0aW9uIGNvZXJjZUZpcmV3YWxsKGZ3KSB7CiAgcmV0dXJuIGZ3ID09PSBGSVJFV0FMTC5PUEVOID8gRklSRVdBTEwuQ09OU0lTVEVOVCA6IGZ3Cn0KCmZ1bmN0aW9uIGxvY2FsQWRkcmVzc2VzKHNvY2tldCkgewogIGNvbnN0IGFkZHJzID0gW10KICBjb25zdCB7IGhvc3QsIHBvcnQgfSA9IHNvY2tldC5hZGRyZXNzKCkKCiAgaWYgKGhvc3QgPT09ICcxMjcuMC4wLjEnKSByZXR1cm4gW3sgaG9zdCwgcG9ydCB9XQoKICBmb3IgKGNvbnN0IG4gb2Ygc29ja2V0LnVkeC5uZXR3b3JrSW50ZXJmYWNlcygpKSB7CiAgICBpZiAobi5mYW1pbHkgIT09IDQgfHwgbi5pbnRlcm5hbCkgY29udGludWUKCiAgICBhZGRycy5wdXNoKHsgaG9zdDogbi5ob3N0LCBwb3J0IH0pCiAgfQoKICBpZiAoYWRkcnMubGVuZ3RoID09PSAwKSB7CiAgICBhZGRycy5wdXNoKHsgaG9zdDogJzEyNy4wLjAuMScsIHBvcnQgfSkKICB9CgogIHJldHVybiBhZGRycwp9CgpmdW5jdGlvbiBtYXRjaEFkZHJlc3MobG9jYWxBZGRyZXNzZXMsIHJlbW90ZUxvY2FsQWRkcmVzc2VzKSB7CiAgaWYgKHJlbW90ZUxvY2FsQWRkcmVzc2VzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGwKCiAgbGV0IGJlc3QgPSB7IHNlZ21lbnQ6IDEsIGFkZHI6IG51bGwgfQoKICBmb3IgKGNvbnN0IGxvY2FsQWRkcmVzcyBvZiBsb2NhbEFkZHJlc3NlcykgewogICAgLy8gPT4gMTkyLjE2OC4xMjIuMjM4CiAgICBjb25zdCBhID0gbG9jYWxBZGRyZXNzLmhvc3Quc3BsaXQoJy4nKQoKICAgIGZvciAoY29uc3QgcmVtb3RlQWRkcmVzcyBvZiByZW1vdGVMb2NhbEFkZHJlc3NlcykgewogICAgICAvLyA9PiAxOTIuMTY4LjAuMjMKICAgICAgLy8gPT4gMTkyLjE2OC4xMjIuMQogICAgICBjb25zdCBiID0gcmVtb3RlQWRkcmVzcy5ob3N0LnNwbGl0KCcuJykKCiAgICAgIC8vIE1hdGNoZXMgMTkyLiouKi4qCiAgICAgIGlmIChhWzBdID09PSBiWzBdKSB7CiAgICAgICAgaWYgKGJlc3Quc2VnbWVudCA9PT0gMSkgYmVzdCA9IHsgc2VnbWVudDogMiwgYWRkcjogcmVtb3RlQWRkcmVzcyB9CgogICAgICAgIC8vIE1hdGNoZXMgMTkyLjE2OC4qLioKICAgICAgICBpZiAoYVsxXSA9PT0gYlsxXSkgewogICAgICAgICAgaWYgKGJlc3Quc2VnbWVudCA9PT0gMikgYmVzdCA9IHsgc2VnbWVudDogMywgYWRkcjogcmVtb3RlQWRkcmVzcyB9CgogICAgICAgICAgLy8gTWF0Y2hlcyAxOTIuMTY4LjEyMi4qCiAgICAgICAgICBpZiAoYVsyXSA9PT0gYlsyXSkgcmV0dXJuIHJlbW90ZUFkZHJlc3MKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiBiZXN0LmFkZHIKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgbmV0ID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZy1uZXQnKQoKY29uc3QgaXB2NCA9IHsKICAuLi5uZXQuaXB2NEFkZHJlc3MsCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBpcCA9IG5ldC5pcHY0QWRkcmVzcy5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBob3N0OiBpcC5ob3N0LAogICAgICBwb3J0OiBpcC5wb3J0CiAgICB9CiAgfQp9Cgpjb25zdCBpcHY0QXJyYXkgPSBjLmFycmF5KGlwdjQpCgpjb25zdCBpcHY2ID0gewogIC4uLm5ldC5pcHY2QWRkcmVzcywKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGlwID0gbmV0LmlwdjZBZGRyZXNzLmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIGhvc3Q6IGlwLmhvc3QsCiAgICAgIHBvcnQ6IGlwLnBvcnQKICAgIH0KICB9Cn0KCmNvbnN0IGlwdjZBcnJheSA9IGMuYXJyYXkoaXB2NikKCmV4cG9ydHMuaGFuZHNoYWtlID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kICs9IDEgKyAxICsgKG0ucGVlckFkZHJlc3MgPyA2IDogMCkgKyAobS5yZWxheUFkZHJlc3MgPyA2IDogMCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS5ub2lzZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSAobS5wZWVyQWRkcmVzcyA/IDEgOiAwKSB8IChtLnJlbGF5QWRkcmVzcyA/IDIgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5tb2RlKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLm5vaXNlKQoKICAgIGlmIChtLnBlZXJBZGRyZXNzKSBpcHY0LmVuY29kZShzdGF0ZSwgbS5wZWVyQWRkcmVzcykKICAgIGlmIChtLnJlbGF5QWRkcmVzcykgaXB2NC5lbmNvZGUoc3RhdGUsIG0ucmVsYXlBZGRyZXNzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgbW9kZTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vaXNlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpLAogICAgICBwZWVyQWRkcmVzczogZmxhZ3MgJiAxID8gaXB2NC5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgcmVsYXlBZGRyZXNzOiBmbGFncyAmIDIgPyBpcHY0LmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCByZWxheUluZm8gPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQgKz0gMTIKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgaXB2NC5lbmNvZGUoc3RhdGUsIG0ucmVsYXlBZGRyZXNzKQogICAgaXB2NC5lbmNvZGUoc3RhdGUsIG0ucGVlckFkZHJlc3MpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHJlbGF5QWRkcmVzczogaXB2NC5kZWNvZGUoc3RhdGUpLAogICAgICBwZWVyQWRkcmVzczogaXB2NC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZWxheUluZm9BcnJheSA9IGMuYXJyYXkocmVsYXlJbmZvKQoKY29uc3QgaG9sZXB1bmNoSW5mbyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uaWQpCiAgICByZWxheUluZm9BcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0ucmVsYXlzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgcmVsYXlJbmZvQXJyYXkuZW5jb2RlKHN0YXRlLCBtLnJlbGF5cykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaWQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICByZWxheXM6IHJlbGF5SW5mb0FycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHVkeEluZm8gPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQgKz0gMiAvLyB2ZXJzaW9uICsgZmVhdHVyZXMKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uaWQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnNlcSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgMSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmV1c2FibGVTb2NrZXQgPyAxIDogMCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uaWQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnNlcSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmZWF0dXJlcyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbiwKICAgICAgcmV1c2FibGVTb2NrZXQ6IChmZWF0dXJlcyAmIDEpICE9PSAwLAogICAgICBpZDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNlcTogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHNlY3JldFN0cmVhbUluZm8gPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCAxKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVsYXlUaHJvdWdoSW5mbyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIDEpIC8vIHZlcnNpb24KICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIDApIC8vIGZsYWdzCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0udG9rZW4pCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAwKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnRva2VuKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbiwKICAgICAgcHVibGljS2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgdG9rZW46IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CgpleHBvcnRzLm5vaXNlUGF5bG9hZCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCArPSA0IC8vIHZlcnNpb24gKyBmbGFncyArIGVycm9yICsgZmlyZXdhbGwKICAgIGlmIChtLmhvbGVwdW5jaCkgaG9sZXB1bmNoSW5mby5wcmVlbmNvZGUoc3RhdGUsIG0uaG9sZXB1bmNoKQogICAgaWYgKG0uYWRkcmVzc2VzNCAmJiBtLmFkZHJlc3NlczQubGVuZ3RoKSBpcHY0QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLmFkZHJlc3NlczQpCiAgICBpZiAobS5hZGRyZXNzZXM2ICYmIG0uYWRkcmVzc2VzNi5sZW5ndGgpIGlwdjZBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0uYWRkcmVzc2VzNikKICAgIGlmIChtLnVkeCkgdWR4SW5mby5wcmVlbmNvZGUoc3RhdGUsIG0udWR4KQogICAgaWYgKG0uc2VjcmV0U3RyZWFtKSBzZWNyZXRTdHJlYW1JbmZvLnByZWVuY29kZShzdGF0ZSwgbS5zZWNyZXRTdHJlYW0pCiAgICBpZiAobS5yZWxheVRocm91Z2gpIHJlbGF5VGhyb3VnaEluZm8ucHJlZW5jb2RlKHN0YXRlLCBtLnJlbGF5VGhyb3VnaCkKICAgIGlmIChtLnJlbGF5QWRkcmVzc2VzKSBpcHY0QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLnJlbGF5QWRkcmVzc2VzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBsZXQgZmxhZ3MgPSAwCgogICAgaWYgKG0uaG9sZXB1bmNoKSBmbGFncyB8PSAxCiAgICBpZiAobS5hZGRyZXNzZXM0ICYmIG0uYWRkcmVzc2VzNC5sZW5ndGgpIGZsYWdzIHw9IDIKICAgIGlmIChtLmFkZHJlc3NlczYgJiYgbS5hZGRyZXNzZXM2Lmxlbmd0aCkgZmxhZ3MgfD0gNAogICAgaWYgKG0udWR4KSBmbGFncyB8PSA4CiAgICBpZiAobS5zZWNyZXRTdHJlYW0pIGZsYWdzIHw9IDE2CiAgICBpZiAobS5yZWxheVRocm91Z2gpIGZsYWdzIHw9IDMyCiAgICBpZiAobS5yZWxheUFkZHJlc3NlcykgZmxhZ3MgfD0gNjQKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKSAvLyB2ZXJzaW9uCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZXJyb3IpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmZpcmV3YWxsKQoKICAgIGlmIChtLmhvbGVwdW5jaCkgaG9sZXB1bmNoSW5mby5lbmNvZGUoc3RhdGUsIG0uaG9sZXB1bmNoKQogICAgaWYgKG0uYWRkcmVzc2VzNCAmJiBtLmFkZHJlc3NlczQubGVuZ3RoKSBpcHY0QXJyYXkuZW5jb2RlKHN0YXRlLCBtLmFkZHJlc3NlczQpCiAgICBpZiAobS5hZGRyZXNzZXM2ICYmIG0uYWRkcmVzc2VzNi5sZW5ndGgpIGlwdjZBcnJheS5lbmNvZGUoc3RhdGUsIG0uYWRkcmVzc2VzNikKICAgIGlmIChtLnVkeCkgdWR4SW5mby5lbmNvZGUoc3RhdGUsIG0udWR4KQogICAgaWYgKG0uc2VjcmV0U3RyZWFtKSBzZWNyZXRTdHJlYW1JbmZvLmVuY29kZShzdGF0ZSwgbS5zZWNyZXRTdHJlYW0pCiAgICBpZiAobS5yZWxheVRocm91Z2gpIHJlbGF5VGhyb3VnaEluZm8uZW5jb2RlKHN0YXRlLCBtLnJlbGF5VGhyb3VnaCkKICAgIGlmIChtLnJlbGF5QWRkcmVzc2VzKSBpcHY0QXJyYXkuZW5jb2RlKHN0YXRlLCBtLnJlbGF5QWRkcmVzc2VzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAodmVyc2lvbiAhPT0gMSkgewogICAgICAvLyBEbyBub3QgYXR0ZW1wdCB0byBkZWNvZGUgYnV0IHJldHVybiB0aGlzIGJhY2sgdG8gdGhlIHVzZXIgc28gdGhleSBjYW4KICAgICAgLy8gYWN0dWFsbHkgaGFuZGxlIGl0CiAgICAgIHJldHVybiB7CiAgICAgICAgdmVyc2lvbiwKICAgICAgICBlcnJvcjogMCwKICAgICAgICBmaXJld2FsbDogMCwKICAgICAgICBob2xlcHVuY2g6IG51bGwsCiAgICAgICAgYWRkcmVzc2VzNDogW10sCiAgICAgICAgYWRkcmVzc2VzNjogW10sCiAgICAgICAgdWR4OiBudWxsLAogICAgICAgIHNlY3JldFN0cmVhbTogbnVsbCwKICAgICAgICByZWxheVRocm91Z2g6IG51bGwsCiAgICAgICAgcmVsYXlBZGRyZXNzZXM6IG51bGwKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICBlcnJvcjogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGZpcmV3YWxsOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgaG9sZXB1bmNoOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGhvbGVwdW5jaEluZm8uZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGFkZHJlc3NlczQ6IChmbGFncyAmIDIpICE9PSAwID8gaXB2NEFycmF5LmRlY29kZShzdGF0ZSkgOiBbXSwKICAgICAgYWRkcmVzc2VzNjogKGZsYWdzICYgNCkgIT09IDAgPyBpcHY2QXJyYXkuZGVjb2RlKHN0YXRlKSA6IFtdLAogICAgICB1ZHg6IChmbGFncyAmIDgpICE9PSAwID8gdWR4SW5mby5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgc2VjcmV0U3RyZWFtOiAoZmxhZ3MgJiAxNikgIT09IDAgPyBzZWNyZXRTdHJlYW1JbmZvLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICByZWxheVRocm91Z2g6IChmbGFncyAmIDMyKSAhPT0gMCA/IHJlbGF5VGhyb3VnaEluZm8uZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHJlbGF5QWRkcmVzc2VzOiAoZmxhZ3MgJiA2NCkgIT09IDAgPyBpcHY0QXJyYXkuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmV4cG9ydHMuaG9sZXB1bmNoID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kICs9IDIKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uaWQpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0ucGF5bG9hZCkKICAgIGlmIChtLnBlZXJBZGRyZXNzKSBpcHY0LnByZWVuY29kZShzdGF0ZSwgbS5wZWVyQWRkcmVzcykKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSBtLnBlZXJBZGRyZXNzID8gMSA6IDAKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5tb2RlKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS5wYXlsb2FkKQogICAgaWYgKG0ucGVlckFkZHJlc3MpIGlwdjQuZW5jb2RlKHN0YXRlLCBtLnBlZXJBZGRyZXNzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBtb2RlOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgaWQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBwYXlsb2FkOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpLAogICAgICBwZWVyQWRkcmVzczogZmxhZ3MgJiAxID8gaXB2NC5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKZXhwb3J0cy5ob2xlcHVuY2hQYXlsb2FkID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kICs9IDQgLy8gZmxhZ3MgKyBlcnJvciArIGZpcmV3YWxsICsgcm91bmQKICAgIGlmIChtLmFkZHJlc3NlcykgaXB2NEFycmF5LnByZWVuY29kZShzdGF0ZSwgbS5hZGRyZXNzZXMpCiAgICBpZiAobS5yZW1vdGVBZGRyZXNzKSBzdGF0ZS5lbmQgKz0gNgogICAgaWYgKG0udG9rZW4pIHN0YXRlLmVuZCArPSAzMgogICAgaWYgKG0ucmVtb3RlVG9rZW4pIHN0YXRlLmVuZCArPSAzMgogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9CiAgICAgIChtLmNvbm5lY3RlZCA/IDEgOiAwKSB8CiAgICAgIChtLnB1bmNoaW5nID8gMiA6IDApIHwKICAgICAgKG0uYWRkcmVzc2VzID8gNCA6IDApIHwKICAgICAgKG0ucmVtb3RlQWRkcmVzcyA/IDggOiAwKSB8CiAgICAgIChtLnRva2VuID8gMTYgOiAwKSB8CiAgICAgIChtLnJlbW90ZVRva2VuID8gMzIgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5lcnJvcikKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZmlyZXdhbGwpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJvdW5kKQoKICAgIGlmIChtLmFkZHJlc3NlcykgaXB2NEFycmF5LmVuY29kZShzdGF0ZSwgbS5hZGRyZXNzZXMpCiAgICBpZiAobS5yZW1vdGVBZGRyZXNzKSBpcHY0LmVuY29kZShzdGF0ZSwgbS5yZW1vdGVBZGRyZXNzKQogICAgaWYgKG0udG9rZW4pIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0udG9rZW4pCiAgICBpZiAobS5yZW1vdGVUb2tlbikgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5yZW1vdGVUb2tlbikKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGVycm9yOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgZmlyZXdhbGw6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICByb3VuZDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGNvbm5lY3RlZDogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIHB1bmNoaW5nOiAoZmxhZ3MgJiAyKSAhPT0gMCwKICAgICAgYWRkcmVzc2VzOiAoZmxhZ3MgJiA0KSAhPT0gMCA/IGlwdjRBcnJheS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgcmVtb3RlQWRkcmVzczogKGZsYWdzICYgOCkgIT09IDAgPyBpcHY0LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB0b2tlbjogKGZsYWdzICYgMTYpICE9PSAwID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICByZW1vdGVUb2tlbjogKGZsYWdzICYgMzIpICE9PSAwID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBwZWVyID0gKGV4cG9ydHMucGVlciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCArPSAzMgogICAgaXB2NEFycmF5LnByZWVuY29kZShzdGF0ZSwgbS5yZWxheUFkZHJlc3NlcykKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgICBpcHY0QXJyYXkuZW5jb2RlKHN0YXRlLCBtLnJlbGF5QWRkcmVzc2VzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBwdWJsaWNLZXk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICByZWxheUFkZHJlc3NlczogaXB2NEFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0pCgpjb25zdCBwZWVycyA9IChleHBvcnRzLnBlZXJzID0gYy5hcnJheShwZWVyKSkKCmNvbnN0IHJhd1BlZXJzID0gYy5hcnJheShjLnJhdykKCmV4cG9ydHMubG9va3VwUmF3UmVwbHkgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICByYXdQZWVycy5wcmVlbmNvZGUoc3RhdGUsIG0ucGVlcnMpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmJ1bXApCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHJhd1BlZXJzLmVuY29kZShzdGF0ZSwgbS5wZWVycykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uYnVtcCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcGVlcnM6IHBlZXJzLmRlY29kZShzdGF0ZSksCiAgICAgIGJ1bXA6IHN0YXRlLnN0YXJ0IDwgc3RhdGUuZW5kID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCiAgICB9CiAgfQp9CgpleHBvcnRzLmFubm91bmNlID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGlmIChtLnBlZXIpIHBlZXIucHJlZW5jb2RlKHN0YXRlLCBtLnBlZXIpCiAgICBpZiAobS5yZWZyZXNoKSBzdGF0ZS5lbmQgKz0gMzIKICAgIGlmIChtLnNpZ25hdHVyZSkgc3RhdGUuZW5kICs9IDY0CiAgICBpZiAobS5idW1wKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmJ1bXApCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gKG0ucGVlciA/IDEgOiAwKSB8IChtLnJlZnJlc2ggPyAyIDogMCkgfCAobS5zaWduYXR1cmUgPyA0IDogMCkgfCAobS5idW1wID8gOCA6IDApCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICAgIGlmIChtLnBlZXIpIHBlZXIuZW5jb2RlKHN0YXRlLCBtLnBlZXIpCiAgICBpZiAobS5yZWZyZXNoKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnJlZnJlc2gpCiAgICBpZiAobS5zaWduYXR1cmUpIGMuZml4ZWQ2NC5lbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgaWYgKG0uYnVtcCkgYy51aW50LmVuY29kZShzdGF0ZSwgbS5idW1wKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgcGVlcjogKGZsYWdzICYgMSkgIT09IDAgPyBwZWVyLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICByZWZyZXNoOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgc2lnbmF0dXJlOiAoZmxhZ3MgJiA0KSAhPT0gMCA/IGMuZml4ZWQ2NC5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgYnVtcDogKGZsYWdzICYgOCkgIT09IDAgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCmV4cG9ydHMubXV0YWJsZVNpZ25hYmxlID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zZXEpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0udmFsdWUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc2VxKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnZhbHVlKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzZXE6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICB2YWx1ZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKZXhwb3J0cy5tdXRhYmxlUHV0UmVxdWVzdCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zZXEpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0udmFsdWUpCiAgICBjLmZpeGVkNjQucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnNlcSkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICAgIGMuZml4ZWQ2NC5lbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBwdWJsaWNLZXk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBzZXE6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICB2YWx1ZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmZpeGVkNjQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKZXhwb3J0cy5tdXRhYmxlR2V0UmVzcG9uc2UgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnNlcSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICAgIGMuZml4ZWQ2NC5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnNlcSkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICAgIGMuZml4ZWQ2NC5lbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzZXE6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICB2YWx1ZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmZpeGVkNjQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQpjb25zdCB7IEZJUkVXQUxMIH0gPSByZXF1aXJlKCcuLi9saWIvY29uc3RhbnRzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgTmF0IHsKICBjb25zdHJ1Y3RvcihkaHQsIHNlc3Npb24sIHNvY2tldCkgewogICAgdGhpcy5fc2FtcGxlc0hvc3QgPSBbXQogICAgdGhpcy5fc2FtcGxlc0Z1bGwgPSBbXQogICAgdGhpcy5fdmlzaXRlZCA9IG5ldyBNYXAoKQogICAgdGhpcy5fcmVzb2x2ZSA9IG51bGwKICAgIHRoaXMuX21pblNhbXBsZXMgPSA0CiAgICB0aGlzLl9hdXRvU2FtcGxpbmcgPSBmYWxzZQoKICAgIHRoaXMuZGh0ID0gZGh0CiAgICB0aGlzLnNlc3Npb24gPSBzZXNzaW9uCiAgICB0aGlzLnNvY2tldCA9IHNvY2tldAoKICAgIHRoaXMuc2FtcGxlZCA9IDAKICAgIHRoaXMuZmlyZXdhbGwgPSBkaHQuZmlyZXdhbGxlZCA/IEZJUkVXQUxMLlVOS05PV04gOiBGSVJFV0FMTC5PUEVOCiAgICB0aGlzLmFkZHJlc3NlcyA9IG51bGwKCiAgICB0aGlzLmFuYWx5emluZyA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgIHRoaXMuX3Jlc29sdmUgPSByZXNvbHZlCiAgICB9KQogIH0KCiAgYXV0b1NhbXBsZShyZXRyeSA9IHRydWUpIHsKICAgIGlmICh0aGlzLl9hdXRvU2FtcGxpbmcpIHJldHVybgogICAgdGhpcy5fYXV0b1NhbXBsaW5nID0gdHJ1ZQoKICAgIGNvbnN0IHNlbGYgPSB0aGlzCiAgICBjb25zdCBzb2NrZXQgPSB0aGlzLnNvY2tldAogICAgY29uc3QgbWF4UGluZ3MgPSB0aGlzLl9taW5TYW1wbGVzCgogICAgbGV0IHNraXAgPSB0aGlzLmRodC5ub2Rlcy5sZW5ndGggPj0gOCA/IDUgOiAwCiAgICBsZXQgcGVuZGluZyA9IDAKCiAgICAvLyBUT0RPOiBpdCB3b3VsZCBiZSBiZXN0IHRvIHBpY2sgdGhlIG5vZGVzIHRvIGhlbHAgdXMgYmFzZWQgb24gbGF0ZW5jeSB0byB1cwogICAgLy8gVGhhdCBzaG91bGQgcmVkdWNlIGNvbm5lY3QgbGF0ZW5jeSBpbiBnZW5lcmFsLiBXZSBzaG91bGQgaW52ZXN0aWdhdGUgdHJhY2tpbmcgdGhhdCBsYXRlciBvbi4KCiAgICAvLyBUT0RPIDI6IHRyeSB0byBwaWNrIG5vZGVzIHdpdGggZGlmZmVyZW50IElQcyBhcyB3ZWxsLCBhcyB0aGF0J2xsIGhlbHAgbXVsdGkgSVAgY2VsbCBjb25uZWN0aW9ucy4uLgogICAgLy8gSWYgd2UgZXhwb3NlIHRoaXMgZnJvbSB0aGUgbmF0IHNhbXBsZXIgdGhlbiB0aGUgREhUIHNob3VsZCBiZSBhYmxlIHRvIGhlbHAgdXMgZmlsdGVyIG91dCBzY2FtcyBhcyB3ZWxsLi4uCgogICAgZm9yICgKICAgICAgbGV0IG5vZGUgPSB0aGlzLmRodC5ub2Rlcy5sYXRlc3Q7CiAgICAgIG5vZGUgJiYgdGhpcy5zYW1wbGVkICsgcGVuZGluZyA8IG1heFBpbmdzOwogICAgICBub2RlID0gbm9kZS5wcmV2CiAgICApIHsKICAgICAgaWYgKHNraXAgPiAwKSB7CiAgICAgICAgc2tpcC0tCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgY29uc3QgcmVmID0gbm9kZS5ob3N0ICsgJzonICsgbm9kZS5wb3J0CgogICAgICBpZiAodGhpcy5fdmlzaXRlZC5oYXMocmVmKSkgY29udGludWUKICAgICAgdGhpcy5fdmlzaXRlZC5zZXQocmVmLCAxKQoKICAgICAgcGVuZGluZysrCiAgICAgIHRoaXMuc2Vzc2lvbi5waW5nKG5vZGUsIHsgc29ja2V0LCByZXRyeTogZmFsc2UgfSkudGhlbihvbnBvbmcsIG9uc2tpcCkKICAgIH0KCiAgICBwZW5kaW5nKysKICAgIG9uc2tpcCgpCgogICAgZnVuY3Rpb24gb25wb25nKHJlcykgewogICAgICBzZWxmLmFkZChyZXMudG8sIHJlcy5mcm9tKQogICAgICBvbnNraXAoKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uc2tpcCgpIHsKICAgICAgaWYgKC0tcGVuZGluZyA9PT0gMCAmJiBzZWxmLnNhbXBsZWQgPCBzZWxmLl9taW5TYW1wbGVzKSB7CiAgICAgICAgaWYgKHJldHJ5KSB7CiAgICAgICAgICBzZWxmLl9hdXRvU2FtcGxpbmcgPSBmYWxzZQogICAgICAgICAgc2VsZi5hdXRvU2FtcGxlKGZhbHNlKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIHNlbGYuX3Jlc29sdmUoKQogICAgICB9CiAgICB9CiAgfQoKICBkZXN0cm95KCkgewogICAgdGhpcy5fYXV0b1NhbXBsaW5nID0gdHJ1ZQogICAgdGhpcy5fbWluU2FtcGxlcyA9IDAKICAgIHRoaXMuX3Jlc29sdmUoKQogIH0KCiAgdW5mcmVlemUoKSB7CiAgICB0aGlzLmZyb3plbiA9IGZhbHNlCiAgICB0aGlzLl91cGRhdGVGaXJld2FsbCgpCiAgICB0aGlzLl91cGRhdGVBZGRyZXNzZXMoKQogIH0KCiAgZnJlZXplKCkgewogICAgdGhpcy5mcm96ZW4gPSB0cnVlCiAgfQoKICBfdXBkYXRlRmlyZXdhbGwoKSB7CiAgICBpZiAoIXRoaXMuZGh0LmZpcmV3YWxsZWQpIHsKICAgICAgdGhpcy5maXJld2FsbCA9IEZJUkVXQUxMLk9QRU4KICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMuc2FtcGxlZCA8IDMpIHJldHVybgoKICAgIGNvbnN0IG1heCA9IHRoaXMuX3NhbXBsZXNGdWxsWzBdLmhpdHMKCiAgICBpZiAobWF4ID49IDMpIHsKICAgICAgdGhpcy5maXJld2FsbCA9IEZJUkVXQUxMLkNPTlNJU1RFTlQKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKG1heCA9PT0gMSkgewogICAgICB0aGlzLmZpcmV3YWxsID0gRklSRVdBTEwuUkFORE9NCiAgICAgIHJldHVybgogICAgfQoKICAgIC8vIGVsc2UgbWF4ID09PSAyCgogICAgLy8gMSBob3N0LCA+PSA0IHRvdGFsIHNhbXBsZXMgaWUsIDIgYmFkIG9uZXMgLT4gcmFuZG9tCiAgICBpZiAodGhpcy5fc2FtcGxlc0hvc3QubGVuZ3RoID09PSAxICYmIHRoaXMuc2FtcGxlZCA+IDMpIHsKICAgICAgdGhpcy5maXJld2FsbCA9IEZJUkVXQUxMLlJBTkRPTQogICAgICByZXR1cm4KICAgIH0KCiAgICAvLyBkb3VibGUgaGl0IG9uIHR3byBkaWZmZXJlbnQgaXBzIC0+IGFzc3VtZSBjb25zaXN0ZW50CiAgICBpZiAodGhpcy5fc2FtcGxlc0hvc3QubGVuZ3RoID4gMSAmJiB0aGlzLl9zYW1wbGVzRnVsbFsxXS5oaXRzID4gMSkgewogICAgICB0aGlzLmZpcmV3YWxsID0gRklSRVdBTEwuQ09OU0lTVEVOVAogICAgICByZXR1cm4KICAgIH0KCiAgICAvLyAoNCBpcyBqdXN0IG1lYW5zIC0gYWxsIHRoZSBzYW1wbGVzIHdlIGV4cGVjdCkgLSBubyBkZWNpc2lvbiAtIGFzc3VtZSByYW5kb20KICAgIGlmICh0aGlzLnNhbXBsZWQgPiA0KSB7CiAgICAgIHRoaXMuZmlyZXdhbGwgPSBGSVJFV0FMTC5SQU5ET00KICAgIH0KICB9CgogIF91cGRhdGVBZGRyZXNzZXMoKSB7CiAgICBpZiAodGhpcy5maXJld2FsbCA9PT0gRklSRVdBTEwuVU5LTk9XTikgewogICAgICB0aGlzLmFkZHJlc3NlcyA9IG51bGwKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMuZmlyZXdhbGwgPT09IEZJUkVXQUxMLlJBTkRPTSkgewogICAgICB0aGlzLmFkZHJlc3NlcyA9IFt0aGlzLl9zYW1wbGVzSG9zdFswXV0KICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMuZmlyZXdhbGwgPT09IEZJUkVXQUxMLkNPTlNJU1RFTlQpIHsKICAgICAgdGhpcy5hZGRyZXNzZXMgPSBbXQogICAgICBmb3IgKGNvbnN0IGFkZHIgb2YgdGhpcy5fc2FtcGxlc0Z1bGwpIHsKICAgICAgICBpZiAoYWRkci5oaXRzID49IDIgfHwgdGhpcy5hZGRyZXNzZXMubGVuZ3RoIDwgMikgdGhpcy5hZGRyZXNzZXMucHVzaChhZGRyKQogICAgICB9CiAgICB9CiAgfQoKICB1cGRhdGUoKSB7CiAgICBpZiAodGhpcy5kaHQuZmlyZXdhbGxlZCAmJiB0aGlzLmZpcmV3YWxsID09PSBGSVJFV0FMTC5PUEVOKSB7CiAgICAgIHRoaXMuZmlyZXdhbGwgPSBGSVJFV0FMTC5VTktOT1dOCiAgICB9CiAgICB0aGlzLl91cGRhdGVGaXJld2FsbCgpCiAgICB0aGlzLl91cGRhdGVBZGRyZXNzZXMoKQogIH0KCiAgYWRkKGFkZHIsIGZyb20pIHsKICAgIGNvbnN0IHJlZiA9IGZyb20uaG9zdCArICc6JyArIGZyb20ucG9ydAoKICAgIGlmICh0aGlzLl92aXNpdGVkLmdldChyZWYpID09PSAyKSByZXR1cm4KICAgIHRoaXMuX3Zpc2l0ZWQuc2V0KHJlZiwgMikKCiAgICBhZGRTYW1wbGUodGhpcy5fc2FtcGxlc0hvc3QsIGFkZHIuaG9zdCwgMCkKICAgIGFkZFNhbXBsZSh0aGlzLl9zYW1wbGVzRnVsbCwgYWRkci5ob3N0LCBhZGRyLnBvcnQpCgogICAgaWYgKCgrK3RoaXMuc2FtcGxlZCA+PSAzIHx8ICF0aGlzLmRodC5maXJld2FsbGVkKSAmJiAhdGhpcy5mcm96ZW4pIHsKICAgICAgdGhpcy51cGRhdGUoKQogICAgfQoKICAgIGlmICh0aGlzLmZpcmV3YWxsID09PSBGSVJFV0FMTC5DT05TSVNURU5UIHx8IHRoaXMuZmlyZXdhbGwgPT09IEZJUkVXQUxMLk9QRU4pIHsKICAgICAgdGhpcy5fcmVzb2x2ZSgpCiAgICB9IGVsc2UgaWYgKHRoaXMuc2FtcGxlZCA+PSB0aGlzLl9taW5TYW1wbGVzKSB7CiAgICAgIHRoaXMuX3Jlc29sdmUoKQogICAgfQogIH0KfQoKZnVuY3Rpb24gYWRkU2FtcGxlKHNhbXBsZXMsIGhvc3QsIHBvcnQpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IHNhbXBsZXMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHMgPSBzYW1wbGVzW2ldCgogICAgaWYgKHMucG9ydCAhPT0gcG9ydCB8fCBzLmhvc3QgIT09IGhvc3QpIGNvbnRpbnVlCiAgICBzLmhpdHMrKwoKICAgIGZvciAoOyBpID4gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHByZXYgPSBzYW1wbGVzW2kgLSAxXQogICAgICBpZiAocHJldi5oaXRzID49IHMuaGl0cykgcmV0dXJuCiAgICAgIHNhbXBsZXNbaSAtIDFdID0gcwogICAgICBzYW1wbGVzW2ldID0gcHJldgogICAgfQoKICAgIHJldHVybgogIH0KCiAgc2FtcGxlcy5wdXNoKHsKICAgIGhvc3QsCiAgICBwb3J0LAogICAgaGl0czogMQogIH0pCn0KY29uc3QgTm9pc2VTZWNyZXRTdHJlYW0gPSByZXF1aXJlKCdAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtJykKY29uc3QgTm9pc2VIYW5kc2hha2UgPSByZXF1aXJlKCdub2lzZS1oYW5kc2hha2UnKQpjb25zdCBjdXJ2ZSA9IHJlcXVpcmUoJ25vaXNlLWN1cnZlLWVkJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgbSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMnKQpjb25zdCB7IE5TIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCmNvbnN0IHsgSEFORFNIQUtFX1VORklOSVNIRUQgfSA9IHJlcXVpcmUoJy4vZXJyb3JzJykKCmNvbnN0IE5PSVNFX1BST0xPVUdFID0gTlMuUEVFUl9IQU5EU0hBS0UKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgTm9pc2VXcmFwIHsKICBjb25zdHJ1Y3RvcihrZXlQYWlyLCByZW1vdGVQdWJsaWNLZXkpIHsKICAgIHRoaXMuaXNJbml0aWF0b3IgPSAhIXJlbW90ZVB1YmxpY0tleQogICAgdGhpcy5yZW1vdGVQdWJsaWNLZXkgPSByZW1vdGVQdWJsaWNLZXkKICAgIHRoaXMua2V5UGFpciA9IGtleVBhaXIKICAgIHRoaXMuaGFuZHNoYWtlID0gbmV3IE5vaXNlSGFuZHNoYWtlKCdJSycsIHRoaXMuaXNJbml0aWF0b3IsIGtleVBhaXIsIHsgY3VydmUgfSkKICAgIHRoaXMuaGFuZHNoYWtlLmluaXRpYWxpc2UoTk9JU0VfUFJPTE9VR0UsIHJlbW90ZVB1YmxpY0tleSkKICB9CgogIHNlbmQocGF5bG9hZCkgewogICAgY29uc3QgYnVmID0gYy5lbmNvZGUobS5ub2lzZVBheWxvYWQsIHBheWxvYWQpCiAgICByZXR1cm4gdGhpcy5oYW5kc2hha2Uuc2VuZChidWYpCiAgfQoKICByZWN2KGJ1ZikgewogICAgY29uc3QgcGF5bG9hZCA9IGMuZGVjb2RlKG0ubm9pc2VQYXlsb2FkLCB0aGlzLmhhbmRzaGFrZS5yZWN2KGJ1ZikpCiAgICB0aGlzLnJlbW90ZVB1YmxpY0tleSA9IGI0YS50b0J1ZmZlcih0aGlzLmhhbmRzaGFrZS5ycykKICAgIHJldHVybiBwYXlsb2FkCiAgfQoKICBmaW5hbCgpIHsKICAgIGlmICghdGhpcy5oYW5kc2hha2UuY29tcGxldGUpIHRocm93IEhBTkRTSEFLRV9VTkZJTklTSEVEKCkKCiAgICBjb25zdCBob2xlcHVuY2hTZWNyZXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCgogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChob2xlcHVuY2hTZWNyZXQsIE5TLlBFRVJfSE9MRVBVTkNILCB0aGlzLmhhbmRzaGFrZS5oYXNoKQoKICAgIHJldHVybiB7CiAgICAgIGlzSW5pdGlhdG9yOiB0aGlzLmlzSW5pdGlhdG9yLAogICAgICBwdWJsaWNLZXk6IHRoaXMua2V5UGFpci5wdWJsaWNLZXksCiAgICAgIHN0cmVhbUlkOiB0aGlzLnN0cmVhbUlkLAogICAgICByZW1vdGVQdWJsaWNLZXk6IHRoaXMucmVtb3RlUHVibGljS2V5LAogICAgICByZW1vdGVJZDogTm9pc2VTZWNyZXRTdHJlYW0uaWQodGhpcy5oYW5kc2hha2UuaGFzaCwgIXRoaXMuaXNJbml0aWF0b3IpLAogICAgICBob2xlcHVuY2hTZWNyZXQsCiAgICAgIGhhc2g6IGI0YS50b0J1ZmZlcih0aGlzLmhhbmRzaGFrZS5oYXNoKSwKICAgICAgcng6IGI0YS50b0J1ZmZlcih0aGlzLmhhbmRzaGFrZS5yeCksCiAgICAgIHR4OiBiNGEudG9CdWZmZXIodGhpcy5oYW5kc2hha2UudHgpCiAgICB9CiAgfQp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IFJlY29yZENhY2hlID0gcmVxdWlyZSgncmVjb3JkLWNhY2hlJykKY29uc3QgQ2FjaGUgPSByZXF1aXJlKCd4YWNoZScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHVuc2xhYiA9IHJlcXVpcmUoJ3Vuc2xhYicpCgpjb25zdCB7IGVuY29kZVVuc2xhYiB9ID0gcmVxdWlyZSgnLi9lbmNvZGUnKQpjb25zdCBtID0gcmVxdWlyZSgnLi9tZXNzYWdlcycpCmNvbnN0IHsgTlMsIEVSUk9SIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgpjb25zdCBFTVBUWSA9IGI0YS5hbGxvYygwKQpjb25zdCBUTVAgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCmNvbnN0IE1BWF9CVU1QX0RSSUZUID0gNjBfMDAwCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFBlcnNpc3RlbnQgewogIGNvbnN0cnVjdG9yKGRodCwgb3B0cykgewogICAgdGhpcy5kaHQgPSBkaHQKICAgIHRoaXMucmVjb3JkcyA9IG5ldyBSZWNvcmRDYWNoZShvcHRzLnJlY29yZHMpCiAgICB0aGlzLmJ1bXBzID0gbmV3IENhY2hlKG9wdHMuYnVtcHMpCiAgICB0aGlzLnJlZnJlc2hlcyA9IG5ldyBDYWNoZShvcHRzLnJlZnJlc2hlcykKICAgIHRoaXMubXV0YWJsZXMgPSBuZXcgQ2FjaGUob3B0cy5tdXRhYmxlcykKICAgIHRoaXMuaW1tdXRhYmxlcyA9IG5ldyBDYWNoZShvcHRzLmltbXV0YWJsZXMpCiAgfQoKICBvbmxvb2t1cChyZXEpIHsKICAgIGlmICghcmVxLnRhcmdldCkgcmV0dXJuCgogICAgY29uc3QgayA9IGI0YS50b1N0cmluZyhyZXEudGFyZ2V0LCAnaGV4JykKICAgIGNvbnN0IHJlY29yZHMgPSB0aGlzLnJlY29yZHMuZ2V0KGssIDIwKQogICAgY29uc3QgYnVtcCA9IHRoaXMuYnVtcHMuZ2V0KGspIHx8IDAKICAgIGNvbnN0IGZ3ZCA9IHRoaXMuZGh0Ll9yb3V0ZXIuZ2V0KGspCgogICAgaWYgKGZ3ZCAmJiByZWNvcmRzLmxlbmd0aCA8IDIwKSByZWNvcmRzLnB1c2goZndkLnJlY29yZCkKCiAgICByZXEucmVwbHkocmVjb3Jkcy5sZW5ndGggPyBjLmVuY29kZShtLmxvb2t1cFJhd1JlcGx5LCB7IHBlZXJzOiByZWNvcmRzLCBidW1wIH0pIDogbnVsbCkKICB9CgogIG9uZmluZHBlZXIocmVxKSB7CiAgICBpZiAoIXJlcS50YXJnZXQpIHJldHVybgogICAgY29uc3QgZndkID0gdGhpcy5kaHQuX3JvdXRlci5nZXQocmVxLnRhcmdldCkKICAgIHJlcS5yZXBseShmd2QgPyBmd2QucmVjb3JkIDogbnVsbCkKICB9CgogIHVuYW5ub3VuY2UodGFyZ2V0LCBwdWJsaWNLZXkpIHsKICAgIGNvbnN0IGsgPSBiNGEudG9TdHJpbmcodGFyZ2V0LCAnaGV4JykKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goVE1QLCBwdWJsaWNLZXkpCgogICAgaWYgKGI0YS5lcXVhbHMoVE1QLCB0YXJnZXQpKSB0aGlzLmRodC5fcm91dGVyLmRlbGV0ZShrKQogICAgdGhpcy5yZWNvcmRzLnJlbW92ZShrLCBwdWJsaWNLZXkpCiAgfQoKICBvbnVuYW5ub3VuY2UocmVxKSB7CiAgICBpZiAoIXJlcS50YXJnZXQgfHwgIXJlcS50b2tlbikgcmV0dXJuCgogICAgY29uc3QgdW5hbm4gPSBkZWNvZGUobS5hbm5vdW5jZSwgcmVxLnZhbHVlKQogICAgaWYgKHVuYW5uID09PSBudWxsKSByZXR1cm4KCiAgICBjb25zdCB7IHBlZXIsIHNpZ25hdHVyZSB9ID0gdW5hbm4KICAgIGlmICghcGVlciB8fCAhc2lnbmF0dXJlKSByZXR1cm4KCiAgICBjb25zdCBzaWduYWJsZSA9IGFublNpZ25hYmxlKHJlcS50YXJnZXQsIHJlcS50b2tlbiwgdGhpcy5kaHQuaWQsIHVuYW5uLCBOUy5VTkFOTk9VTkNFKQoKICAgIGlmICghc29kaXVtLmNyeXB0b19zaWduX3ZlcmlmeV9kZXRhY2hlZChzaWduYXR1cmUsIHNpZ25hYmxlLCBwZWVyLnB1YmxpY0tleSkpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy51bmFubm91bmNlKHJlcS50YXJnZXQsIHBlZXIucHVibGljS2V5KQogICAgcmVxLnJlcGx5KG51bGwsIHsgdG9rZW46IGZhbHNlLCBjbG9zZXJOb2RlczogZmFsc2UgfSkKICB9CgogIF9vbnJlZnJlc2godG9rZW4sIHJlcSkgewogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChUTVAsIHRva2VuKQogICAgY29uc3QgYWN0aXZlUmVmcmVzaCA9IGI0YS50b1N0cmluZyhUTVAsICdoZXgnKQoKICAgIGNvbnN0IHIgPSB0aGlzLnJlZnJlc2hlcy5nZXQoYWN0aXZlUmVmcmVzaCkKICAgIGlmICghcikgcmV0dXJuCgogICAgY29uc3QgeyBhbm5vdW5jZVNlbGYsIGssIHJlY29yZCB9ID0gcgogICAgY29uc3QgcHVibGljS2V5ID0gcmVjb3JkLnN1YmFycmF5KDAsIDMyKQoKICAgIGlmIChhbm5vdW5jZVNlbGYpIHsKICAgICAgdGhpcy5kaHQuX3JvdXRlci5zZXQoaywgewogICAgICAgIHJlbGF5OiByZXEuZnJvbSwKICAgICAgICByZWNvcmQsCiAgICAgICAgb25jb25uZWN0OiBudWxsLAogICAgICAgIG9uaG9sZXB1bmNoOiBudWxsCiAgICAgIH0pCiAgICAgIHRoaXMucmVjb3Jkcy5yZW1vdmUoaywgcHVibGljS2V5KQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5yZWNvcmRzLmFkZChrLCBwdWJsaWNLZXksIHJlY29yZCkKICAgIH0KCiAgICB0aGlzLnJlZnJlc2hlcy5kZWxldGUoYWN0aXZlUmVmcmVzaCkKICAgIHRoaXMucmVmcmVzaGVzLnNldChiNGEudG9TdHJpbmcodG9rZW4sICdoZXgnKSwgcikKCiAgICByZXEucmVwbHkobnVsbCwgeyB0b2tlbjogZmFsc2UsIGNsb3Nlck5vZGVzOiBmYWxzZSB9KQogIH0KCiAgb25hbm5vdW5jZShyZXEpIHsKICAgIGlmICghcmVxLnRhcmdldCB8fCAhcmVxLnRva2VuIHx8ICF0aGlzLmRodC5pZCkgcmV0dXJuCgogICAgY29uc3QgYW5uID0gZGVjb2RlKG0uYW5ub3VuY2UsIHJlcS52YWx1ZSkKICAgIGlmIChhbm4gPT09IG51bGwpIHJldHVybgoKICAgIGNvbnN0IHNpZ25hYmxlID0gYW5uU2lnbmFibGUocmVxLnRhcmdldCwgcmVxLnRva2VuLCB0aGlzLmRodC5pZCwgYW5uLCBOUy5BTk5PVU5DRSkKICAgIGNvbnN0IHsgcGVlciwgcmVmcmVzaCwgc2lnbmF0dXJlLCBidW1wIH0gPSBhbm4KCiAgICBpZiAoIXBlZXIpIHsKICAgICAgaWYgKCFyZWZyZXNoKSByZXR1cm4KICAgICAgdGhpcy5fb25yZWZyZXNoKHJlZnJlc2gsIHJlcSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKCFzaWduYXR1cmUgfHwgIXNvZGl1bS5jcnlwdG9fc2lnbl92ZXJpZnlfZGV0YWNoZWQoc2lnbmF0dXJlLCBzaWduYWJsZSwgcGVlci5wdWJsaWNLZXkpKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIC8vIFRPRE86IGl0IHdvdWxkIGJlIHBvdGVudGlhbGx5IGJlIG1vcmUgb3B0aW1hbCB0byBhbGxvdyBtb3JlIHRoYW4gMyBhZGRyZXNzZXMgaGVyZSBmb3IgYSBmaW5kUGVlciByZXNwb25zZQogICAgLy8gYW5kIG9ubHkgdXNlIG1heCAzIGZvciBhIGxvb2t1cCByZXBseQogICAgaWYgKHBlZXIucmVsYXlBZGRyZXNzZXMubGVuZ3RoID4gMykgewogICAgICBwZWVyLnJlbGF5QWRkcmVzc2VzID0gcGVlci5yZWxheUFkZHJlc3Nlcy5zbGljZSgwLCAzKQogICAgfQoKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goVE1QLCBwZWVyLnB1YmxpY0tleSkKCiAgICBjb25zdCBrID0gYjRhLnRvU3RyaW5nKHJlcS50YXJnZXQsICdoZXgnKQogICAgY29uc3QgYW5ub3VuY2VTZWxmID0gYjRhLmVxdWFscyhUTVAsIHJlcS50YXJnZXQpCiAgICBjb25zdCByZWNvcmQgPSBlbmNvZGVVbnNsYWIobS5wZWVyLCBwZWVyKQoKICAgIGlmIChhbm5vdW5jZVNlbGYpIHsKICAgICAgdGhpcy5kaHQuX3JvdXRlci5zZXQoaywgewogICAgICAgIHJlbGF5OiByZXEuZnJvbSwKICAgICAgICByZWNvcmQsCiAgICAgICAgb25jb25uZWN0OiBudWxsLAogICAgICAgIG9uaG9sZXB1bmNoOiBudWxsCiAgICAgIH0pCiAgICAgIHRoaXMucmVjb3Jkcy5yZW1vdmUoaywgcGVlci5wdWJsaWNLZXkpCiAgICB9IGVsc2UgewogICAgICBjb25zdCBjdXJyZW50QnVtcCA9IHRoaXMuYnVtcHMuZ2V0KGspIHx8IDAKICAgICAgaWYgKGJ1bXAgPiBjdXJyZW50QnVtcCAmJiBidW1wIDw9IERhdGUubm93KCkgKyBNQVhfQlVNUF9EUklGVCkgdGhpcy5idW1wcy5zZXQoaywgYnVtcCkKICAgICAgdGhpcy5yZWNvcmRzLmFkZChrLCBwZWVyLnB1YmxpY0tleSwgcmVjb3JkKQogICAgfQoKICAgIGlmIChyZWZyZXNoKSB7CiAgICAgIHRoaXMucmVmcmVzaGVzLnNldChiNGEudG9TdHJpbmcocmVmcmVzaCwgJ2hleCcpLCB7IGssIHJlY29yZCwgYW5ub3VuY2VTZWxmIH0pCiAgICB9CgogICAgcmVxLnJlcGx5KG51bGwsIHsgdG9rZW46IGZhbHNlLCBjbG9zZXJOb2RlczogZmFsc2UgfSkKICB9CgogIG9ubXV0YWJsZWdldChyZXEpIHsKICAgIGlmICghcmVxLnRhcmdldCB8fCAhcmVxLnZhbHVlKSByZXR1cm4KCiAgICBsZXQgc2VxID0gMAogICAgdHJ5IHsKICAgICAgc2VxID0gYy5kZWNvZGUoYy51aW50LCByZXEudmFsdWUpCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgayA9IGI0YS50b1N0cmluZyhyZXEudGFyZ2V0LCAnaGV4JykKICAgIGNvbnN0IHZhbHVlID0gdGhpcy5tdXRhYmxlcy5nZXQoaykKCiAgICBpZiAoIXZhbHVlKSB7CiAgICAgIHJlcS5yZXBseShudWxsKQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBsb2NhbFNlcSA9IGMuZGVjb2RlKGMudWludCwgdmFsdWUpCiAgICByZXEucmVwbHkobG9jYWxTZXEgPCBzZXEgPyBudWxsIDogdmFsdWUpCiAgfQoKICBvbm11dGFibGVwdXQocmVxKSB7CiAgICBpZiAoIXJlcS50YXJnZXQgfHwgIXJlcS50b2tlbiB8fCAhcmVxLnZhbHVlKSByZXR1cm4KCiAgICBjb25zdCBwID0gZGVjb2RlKG0ubXV0YWJsZVB1dFJlcXVlc3QsIHJlcS52YWx1ZSkKICAgIGlmICghcCkgcmV0dXJuCgogICAgY29uc3QgeyBwdWJsaWNLZXksIHNlcSwgdmFsdWUsIHNpZ25hdHVyZSB9ID0gcAoKICAgIGNvbnN0IGhhc2ggPSBiNGEuYWxsb2NVbnNhZmUoMzIpCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGhhc2gsIHB1YmxpY0tleSkKICAgIGlmICghYjRhLmVxdWFscyhoYXNoLCByZXEudGFyZ2V0KSkgcmV0dXJuCgogICAgaWYgKCF2YWx1ZSB8fCAhdmVyaWZ5TXV0YWJsZShzaWduYXR1cmUsIHNlcSwgdmFsdWUsIHB1YmxpY0tleSkpIHJldHVybgoKICAgIGNvbnN0IGsgPSBiNGEudG9TdHJpbmcoaGFzaCwgJ2hleCcpCiAgICBjb25zdCBsb2NhbCA9IHRoaXMubXV0YWJsZXMuZ2V0KGspCgogICAgaWYgKGxvY2FsKSB7CiAgICAgIGNvbnN0IGV4aXN0aW5nID0gYy5kZWNvZGUobS5tdXRhYmxlR2V0UmVzcG9uc2UsIGxvY2FsKQogICAgICBpZiAoZXhpc3RpbmcudmFsdWUgJiYgZXhpc3Rpbmcuc2VxID09PSBzZXEgJiYgYjRhLmNvbXBhcmUodmFsdWUsIGV4aXN0aW5nLnZhbHVlKSAhPT0gMCkgewogICAgICAgIHJlcS5lcnJvcihFUlJPUi5TRVFfUkVVU0VEKQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIGlmIChzZXEgPCBleGlzdGluZy5zZXEpIHsKICAgICAgICByZXEuZXJyb3IoRVJST1IuU0VRX1RPT19MT1cpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLm11dGFibGVzLnNldChrLCBlbmNvZGVVbnNsYWIobS5tdXRhYmxlR2V0UmVzcG9uc2UsIHsgc2VxLCB2YWx1ZSwgc2lnbmF0dXJlIH0pKQogICAgcmVxLnJlcGx5KG51bGwpCiAgfQoKICBvbmltbXV0YWJsZWdldChyZXEpIHsKICAgIGlmICghcmVxLnRhcmdldCkgcmV0dXJuCgogICAgY29uc3QgayA9IGI0YS50b1N0cmluZyhyZXEudGFyZ2V0LCAnaGV4JykKICAgIGNvbnN0IHZhbHVlID0gdGhpcy5pbW11dGFibGVzLmdldChrKQoKICAgIHJlcS5yZXBseSh2YWx1ZSB8fCBudWxsKQogIH0KCiAgb25pbW11dGFibGVwdXQocmVxKSB7CiAgICBpZiAoIXJlcS50YXJnZXQgfHwgIXJlcS50b2tlbiB8fCAhcmVxLnZhbHVlKSByZXR1cm4KCiAgICBjb25zdCBoYXNoID0gYjRhLmFsbG9jKDMyKQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChoYXNoLCByZXEudmFsdWUpCiAgICBpZiAoIWI0YS5lcXVhbHMoaGFzaCwgcmVxLnRhcmdldCkpIHJldHVybgoKICAgIGNvbnN0IGsgPSBiNGEudG9TdHJpbmcoaGFzaCwgJ2hleCcpCiAgICB0aGlzLmltbXV0YWJsZXMuc2V0KGssIHVuc2xhYihyZXEudmFsdWUpKQoKICAgIHJlcS5yZXBseShudWxsKQogIH0KCiAgZGVzdHJveSgpIHsKICAgIHRoaXMucmVjb3Jkcy5kZXN0cm95KCkKICAgIHRoaXMucmVmcmVzaGVzLmRlc3Ryb3koKQogICAgdGhpcy5tdXRhYmxlcy5kZXN0cm95KCkKICAgIHRoaXMuaW1tdXRhYmxlcy5kZXN0cm95KCkKICB9CgogIHN0YXRpYyBzaWduTXV0YWJsZShzZXEsIHZhbHVlLCBrZXlQYWlyKSB7CiAgICBjb25zdCBzaWduYWJsZSA9IGI0YS5hbGxvY1Vuc2FmZSgzMiArIDMyKQogICAgY29uc3QgaGFzaCA9IHNpZ25hYmxlLnN1YmFycmF5KDMyKQoKICAgIHNpZ25hYmxlLnNldChOUy5NVVRBQkxFX1BVVCwgMCkKCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGhhc2gsIGMuZW5jb2RlKG0ubXV0YWJsZVNpZ25hYmxlLCB7IHNlcSwgdmFsdWUgfSkpCiAgICByZXR1cm4gc2lnbihzaWduYWJsZSwga2V5UGFpcikKICB9CgogIHN0YXRpYyB2ZXJpZnlNdXRhYmxlKHNpZ25hdHVyZSwgc2VxLCB2YWx1ZSwgcHVibGljS2V5KSB7CiAgICByZXR1cm4gdmVyaWZ5TXV0YWJsZShzaWduYXR1cmUsIHNlcSwgdmFsdWUsIHB1YmxpY0tleSkKICB9CgogIHN0YXRpYyBzaWduQW5ub3VuY2UodGFyZ2V0LCB0b2tlbiwgaWQsIGFubiwga2V5UGFpcikgewogICAgcmV0dXJuIHNpZ24oYW5uU2lnbmFibGUodGFyZ2V0LCB0b2tlbiwgaWQsIGFubiwgTlMuQU5OT1VOQ0UpLCBrZXlQYWlyKQogIH0KCiAgc3RhdGljIHNpZ25VbmFubm91bmNlKHRhcmdldCwgdG9rZW4sIGlkLCBhbm4sIGtleVBhaXIpIHsKICAgIHJldHVybiBzaWduKGFublNpZ25hYmxlKHRhcmdldCwgdG9rZW4sIGlkLCBhbm4sIE5TLlVOQU5OT1VOQ0UpLCBrZXlQYWlyKQogIH0KfQoKZnVuY3Rpb24gdmVyaWZ5TXV0YWJsZShzaWduYXR1cmUsIHNlcSwgdmFsdWUsIHB1YmxpY0tleSkgewogIGNvbnN0IHNpZ25hYmxlID0gYjRhLmFsbG9jVW5zYWZlKDMyICsgMzIpCiAgY29uc3QgaGFzaCA9IHNpZ25hYmxlLnN1YmFycmF5KDMyKQoKICBzaWduYWJsZS5zZXQoTlMuTVVUQUJMRV9QVVQsIDApCgogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goaGFzaCwgYy5lbmNvZGUobS5tdXRhYmxlU2lnbmFibGUsIHsgc2VxLCB2YWx1ZSB9KSkKICByZXR1cm4gc29kaXVtLmNyeXB0b19zaWduX3ZlcmlmeV9kZXRhY2hlZChzaWduYXR1cmUsIHNpZ25hYmxlLCBwdWJsaWNLZXkpCn0KCmZ1bmN0aW9uIGFublNpZ25hYmxlKHRhcmdldCwgdG9rZW4sIGlkLCBhbm4sIG5zKSB7CiAgY29uc3Qgc2lnbmFibGUgPSBiNGEuYWxsb2NVbnNhZmUoMzIgKyAzMikKICBjb25zdCBoYXNoID0gc2lnbmFibGUuc3ViYXJyYXkoMzIpCgogIHNpZ25hYmxlLnNldChucywgMCkKCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChoYXNoLCBbCiAgICB0YXJnZXQsCiAgICBpZCwKICAgIHRva2VuLAogICAgYy5lbmNvZGUobS5wZWVyLCBhbm4ucGVlciksIC8vIG5vdGUgdGhhdCB0aGlzIGlzIHRoZSBwYXJ0aWFsIGVuY29kaW5nIG9mIHRoZSBhbm5vdW5jZSBtZXNzYWdlIHNvIHdlIGNvdWxkIGp1c3QgdXNlIHRoYXQgZm9yIHBlcmYKICAgIGFubi5yZWZyZXNoIHx8IEVNUFRZCiAgXSkKCiAgcmV0dXJuIHNpZ25hYmxlCn0KCmZ1bmN0aW9uIHNpZ24oc2lnbmFibGUsIGtleVBhaXIpIHsKICBpZiAoa2V5UGFpci5zaWduKSB7CiAgICByZXR1cm4ga2V5UGFpci5zaWduKHNpZ25hYmxlKQogIH0KICBjb25zdCBzZWNyZXRLZXkgPSBrZXlQYWlyLnNlY3JldEtleSA/IGtleVBhaXIuc2VjcmV0S2V5IDoga2V5UGFpcgogIGNvbnN0IHNpZ25hdHVyZSA9IGI0YS5hbGxvY1Vuc2FmZSg2NCkKICBzb2RpdW0uY3J5cHRvX3NpZ25fZGV0YWNoZWQoc2lnbmF0dXJlLCBzaWduYWJsZSwgc2VjcmV0S2V5KQogIHJldHVybiBzaWduYXR1cmUKfQoKZnVuY3Rpb24gZGVjb2RlKGVuYywgdmFsKSB7CiAgdHJ5IHsKICAgIHJldHVybiB2YWwgJiYgYy5kZWNvZGUoZW5jLCB2YWwpCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gbnVsbAogIH0KfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJhd1N0cmVhbVNldCB7CiAgY29uc3RydWN0b3IoZGh0KSB7CiAgICB0aGlzLl9kaHQgPSBkaHQKCiAgICB0aGlzLl9wcmVmaXggPSAxNiAtIDEgLy8gMTYgaXMgdGhlIGRlZmF1bHQgc3RyZWFtLXNldCBzaWRlIGluIHVkeAogICAgdGhpcy5fc3RyZWFtcyA9IG5ldyBNYXAoKQogIH0KCiAgZ2V0IHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5fc3RyZWFtcy5zaXplCiAgfQoKICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLl9zdHJlYW1zLnZhbHVlcygpCiAgfQoKICBhZGQob3B0cykgewogICAgY29uc3Qgc2VsZiA9IHRoaXMKCiAgICAvLyBUT0RPOiB3ZSBzaG91bGQgcHJvYiBoYXZlIGEgdWR4IGhlbHBlciBmb3IgaWQgZ2VuZXJhdGlvbiwgZ2l2ZW4gdGhlIHNsaWdodCBjb21wbGV4aXR5CiAgICAvLyBvZiB0aGUgYmVsb3cuIHJlcXVpcmVzIGEgUFJORyBpbiB1ZHggdGhvLgoKICAgIGxldCBpZCA9IDAKCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZCA9IChNYXRoLnJhbmRvbSgpICogMHgxMDAwMDAwMDApID4+PiAwCgogICAgICBpZiAodGhpcy5fc3RyZWFtcy5oYXMoaWQgJiB0aGlzLl9wcmVmaXgpKSBjb250aW51ZQogICAgICBicmVhawogICAgfQoKICAgIC8vIGFsd2F5cyBoYXZlIH41MCUgY2hhbmdlIG9mIHJvbGxpbmcgYSBmcmVlIG9uZQogICAgaWYgKDIgKiB0aGlzLl9zdHJlYW1zLnNpemUgPj0gdGhpcy5fcHJlZml4KSB7CiAgICAgIC8vIGllIDBiMTExMTEgPSAwYjExMTEgKyAxICsgMGIxMTExCiAgICAgIHRoaXMuX3ByZWZpeCA9IDIgKiB0aGlzLl9wcmVmaXggKyAxCgogICAgICAvLyBtb3ZlIHRoZSBwcmVmaXhlcyBvdmVyCiAgICAgIGNvbnN0IG5leHQgPSBuZXcgTWFwKCkKICAgICAgZm9yIChjb25zdCBzdHJlYW0gb2YgdGhpcy5fc3RyZWFtcy52YWx1ZXMoKSkgewogICAgICAgIG5leHQuc2V0KHN0cmVhbS5pZCAmIHRoaXMuX3ByZWZpeCwgc3RyZWFtKQogICAgICB9CiAgICAgIHRoaXMuX3N0cmVhbXMgPSBuZXh0CiAgICB9CgogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5fZGh0LnVkeC5jcmVhdGVTdHJlYW0oaWQsIG9wdHMpCiAgICB0aGlzLl9zdHJlYW1zLnNldChpZCAmIHRoaXMuX3ByZWZpeCwgc3RyZWFtKQoKICAgIHN0cmVhbS5vbignY2xvc2UnLCBvbmNsb3NlKQoKICAgIHJldHVybiBzdHJlYW0KCiAgICBmdW5jdGlvbiBvbmNsb3NlKCkgewogICAgICBzZWxmLl9zdHJlYW1zLmRlbGV0ZShpZCAmIHNlbGYuX3ByZWZpeCkKICAgIH0KICB9CgogIGFzeW5jIGNsZWFyKCkgewogICAgY29uc3QgZGVzdHJveWluZyA9IFtdCgogICAgZm9yIChjb25zdCBzdHJlYW0gb2YgdGhpcy5fc3RyZWFtcy52YWx1ZXMoKSkgewogICAgICBkZXN0cm95aW5nLnB1c2gobmV3IFByb21pc2UoKHJlc29sdmUpID0+IHN0cmVhbS5vbmNlKCdjbG9zZScsIHJlc29sdmUpLmRlc3Ryb3koKSkpCiAgICB9CgogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKGRlc3Ryb3lpbmcpCiAgfQp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgQ2FjaGUgPSByZXF1aXJlKCd4YWNoZScpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgeyBoYW5kc2hha2UsIGhvbGVwdW5jaCB9ID0gcmVxdWlyZSgnLi9tZXNzYWdlcycpCmNvbnN0IHsgQ09NTUFORFMgfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKY29uc3QgeyBCQURfSEFORFNIQUtFX1JFUExZLCBCQURfSE9MRVBVTkNIX1JFUExZIH0gPSByZXF1aXJlKCcuL2Vycm9ycycpCgpjb25zdCBGUk9NX0NMSUVOVCA9IDAKY29uc3QgRlJPTV9TRVJWRVIgPSAxCmNvbnN0IEZST01fUkVMQVkgPSAyCmNvbnN0IEZST01fU0VDT05EX1JFTEFZID0gMwpjb25zdCBSRVBMWSA9IDQKCi8vIFRPRE86IFdoaWxlIHRoZSBjdXJyZW50IGRlc2lnbiBpcyB2ZXJ5IHRydXN0bGVzcyBpbiByZWdhcmRzIHRvIGNsaWVudHMvc2VydmVycyB0cnVzdGluZyB0aGUgREhULAovLyB3ZSBzaG91bGQgYWRkIGEgYnVuY2ggb2YgcmF0ZSBsaW1pdHMgZXZlcnl3aGVyZSwgZXNwZWNpYWxseSBpbmNsdWRpbmcgaGVyZSB0byBhdm9pZCBiYWQgdXNlcnMKLy8gdXNpbmcgYSBESFQgbm9kZSB0byByZWxheSB0cmFmZmljIGluZGlzY3JpbWluYXRlbHkgdXNpbmcgdGhlIGNvbm5lY3QvaG9sZXB1bmNoIG1lc3NhZ2VzLgovLyBUaGF0J3MgbW9zdGx5IGZyb20gYW4gYWJ1c2UgUE9WIGFzIG5vbmUgb2YgdGhlIG1lc3NzYWdlcyBkbyBhbXBsaWNhdGlvbi4KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUm91dGVyIHsKICBjb25zdHJ1Y3RvcihkaHQsIG9wdHMpIHsKICAgIHRoaXMuZGh0ID0gZGh0CiAgICB0aGlzLmZvcndhcmRzID0gbmV3IENhY2hlKG9wdHMuZm9yd2FyZHMpCiAgfQoKICBzZXQodGFyZ2V0LCBzdGF0ZSkgewogICAgaWYgKHN0YXRlLm9ucGVlcmhhbmRzaGFrZSkgewogICAgICB0aGlzLmZvcndhcmRzLnJldGFpbih0b1N0cmluZyh0YXJnZXQpLCBzdGF0ZSkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuZm9yd2FyZHMuc2V0KHRvU3RyaW5nKHRhcmdldCksIHN0YXRlKQogICAgfQogIH0KCiAgZ2V0KHRhcmdldCkgewogICAgcmV0dXJuIHRoaXMuZm9yd2FyZHMuZ2V0KHRvU3RyaW5nKHRhcmdldCkpCiAgfQoKICBkZWxldGUodGFyZ2V0KSB7CiAgICB0aGlzLmZvcndhcmRzLmRlbGV0ZSh0b1N0cmluZyh0YXJnZXQpKQogIH0KCiAgZGVzdHJveSgpIHsKICAgIHRoaXMuZm9yd2FyZHMuZGVzdHJveSgpCiAgfQoKICBhc3luYyBwZWVySGFuZHNoYWtlKHRhcmdldCwgeyBub2lzZSwgcGVlckFkZHJlc3MsIHJlbGF5QWRkcmVzcywgc29ja2V0LCBzZXNzaW9uIH0sIHRvKSB7CiAgICBjb25zdCBkaHQgPSB0aGlzLmRodAoKICAgIGNvbnN0IHJlcXVlc3RWYWx1ZSA9IGMuZW5jb2RlKGhhbmRzaGFrZSwgewogICAgICBtb2RlOiBGUk9NX0NMSUVOVCwKICAgICAgbm9pc2UsCiAgICAgIHBlZXJBZGRyZXNzLAogICAgICByZWxheUFkZHJlc3MKICAgIH0pCgogICAgY29uc3QgcmVzID0gYXdhaXQgZGh0LnJlcXVlc3QoCiAgICAgIHsgY29tbWFuZDogQ09NTUFORFMuUEVFUl9IQU5EU0hBS0UsIHRhcmdldCwgdmFsdWU6IHJlcXVlc3RWYWx1ZSB9LAogICAgICB0bywKICAgICAgeyBzb2NrZXQsIHNlc3Npb24gfQogICAgKQoKICAgIGNvbnN0IGhzID0gZGVjb2RlKGhhbmRzaGFrZSwgcmVzLnZhbHVlKQogICAgaWYgKAogICAgICAhaHMgfHwKICAgICAgaHMubW9kZSAhPT0gUkVQTFkgfHwKICAgICAgdG8uaG9zdCAhPT0gcmVzLmZyb20uaG9zdCB8fAogICAgICB0by5wb3J0ICE9PSByZXMuZnJvbS5wb3J0IHx8CiAgICAgICFocy5ub2lzZQogICAgKSB7CiAgICAgIHRocm93IEJBRF9IQU5EU0hBS0VfUkVQTFkoKQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIG5vaXNlOiBocy5ub2lzZSwKICAgICAgcmVsYXllZDogISFocy5wZWVyQWRkcmVzcywKICAgICAgc2VydmVyQWRkcmVzczogaHMucGVlckFkZHJlc3MgfHwgdG8sCiAgICAgIGNsaWVudEFkZHJlc3M6IHJlcy50bwogICAgfQogIH0KCiAgYXN5bmMgb25wZWVyaGFuZHNoYWtlKHJlcSkgewogICAgY29uc3QgaHMgPSByZXEudmFsdWUgJiYgZGVjb2RlKGhhbmRzaGFrZSwgcmVxLnZhbHVlKQogICAgaWYgKCFocykgcmV0dXJuCgogICAgY29uc3QgeyBtb2RlLCBub2lzZSwgcGVlckFkZHJlc3MsIHJlbGF5QWRkcmVzcyB9ID0gaHMKCiAgICBjb25zdCBzdGF0ZSA9IHJlcS50YXJnZXQgJiYgdGhpcy5nZXQocmVxLnRhcmdldCkKICAgIGNvbnN0IGlzU2VydmVyID0gISEoc3RhdGUgJiYgc3RhdGUub25wZWVyaGFuZHNoYWtlKQogICAgY29uc3QgcmVsYXkgPSBzdGF0ZSAmJiBzdGF0ZS5yZWxheQoKICAgIGlmIChpc1NlcnZlcikgewogICAgICBsZXQgcmVwbHkgPSBudWxsCiAgICAgIHRyeSB7CiAgICAgICAgcmVwbHkgPSBub2lzZSAmJiAoYXdhaXQgc3RhdGUub25wZWVyaGFuZHNoYWtlKHsgbm9pc2UsIHBlZXJBZGRyZXNzIH0sIHJlcSkpCiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBzYWZldHlDYXRjaChlKQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIGlmICghcmVwbHkgfHwgIXJlcGx5Lm5vaXNlKSByZXR1cm4KICAgICAgY29uc3Qgb3B0cyA9IHsgc29ja2V0OiByZXBseS5zb2NrZXQsIGNsb3Nlck5vZGVzOiBmYWxzZSwgdG9rZW46IGZhbHNlIH0KCiAgICAgIHN3aXRjaCAobW9kZSkgewogICAgICAgIGNhc2UgRlJPTV9DTElFTlQ6IHsKICAgICAgICAgIHJlcS5yZXBseSgKICAgICAgICAgICAgYy5lbmNvZGUoaGFuZHNoYWtlLCB7IG1vZGU6IFJFUExZLCBub2lzZTogcmVwbHkubm9pc2UsIHBlZXJBZGRyZXNzOiBudWxsIH0pLAogICAgICAgICAgICBvcHRzCiAgICAgICAgICApCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgY2FzZSBGUk9NX1JFTEFZOiB7CiAgICAgICAgICByZXEucmVsYXkoCiAgICAgICAgICAgIGMuZW5jb2RlKGhhbmRzaGFrZSwgeyBtb2RlOiBGUk9NX1NFUlZFUiwgbm9pc2U6IHJlcGx5Lm5vaXNlLCBwZWVyQWRkcmVzcyB9KSwKICAgICAgICAgICAgcmVxLmZyb20sCiAgICAgICAgICAgIG9wdHMKICAgICAgICAgICkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICBjYXNlIEZST01fU0VDT05EX1JFTEFZOiB7CiAgICAgICAgICBpZiAoIXJlbGF5QWRkcmVzcykgcmV0dXJuCiAgICAgICAgICByZXEucmVsYXkoCiAgICAgICAgICAgIGMuZW5jb2RlKGhhbmRzaGFrZSwgeyBtb2RlOiBGUk9NX1NFUlZFUiwgbm9pc2U6IHJlcGx5Lm5vaXNlLCBwZWVyQWRkcmVzcyB9KSwKICAgICAgICAgICAgcmVsYXlBZGRyZXNzLAogICAgICAgICAgICBvcHRzCiAgICAgICAgICApCiAgICAgICAgICByZXR1cm4gLy8gZXNsaW50LWRpc2FibGUtbGluZQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgc3dpdGNoIChtb2RlKSB7CiAgICAgICAgY2FzZSBGUk9NX0NMSUVOVDogewogICAgICAgICAgLy8gVE9ETzogaWYgbm8gcmVsYXkgaXMga25vd24gcm91dGUgY2xvc2VyIHRvIHRoZSB0YXJnZXQgaW5zdGVhZCBvZiB0aW1pbmcgb3V0CiAgICAgICAgICBpZiAoIW5vaXNlKSByZXR1cm4KICAgICAgICAgIGlmICghcmVsYXkgJiYgIXJlbGF5QWRkcmVzcykgewogICAgICAgICAgICAvLyBoZWxwIHRoZSB1c2VyIHJvdXRlCiAgICAgICAgICAgIHJlcS5yZXBseShudWxsLCB7IHRva2VuOiBmYWxzZSwgY2xvc2VyTm9kZXM6IHRydWUgfSkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICB9CiAgICAgICAgICByZXEucmVsYXkoCiAgICAgICAgICAgIGMuZW5jb2RlKGhhbmRzaGFrZSwgewogICAgICAgICAgICAgIG1vZGU6IEZST01fUkVMQVksCiAgICAgICAgICAgICAgbm9pc2UsCiAgICAgICAgICAgICAgcGVlckFkZHJlc3M6IHJlcS5mcm9tLAogICAgICAgICAgICAgIHJlbGF5QWRkcmVzczogbnVsbAogICAgICAgICAgICB9KSwKICAgICAgICAgICAgcmVsYXlBZGRyZXNzIHx8IHJlbGF5CiAgICAgICAgICApCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgY2FzZSBGUk9NX1JFTEFZOiB7CiAgICAgICAgICBpZiAoIXJlbGF5IHx8ICFub2lzZSkgcmV0dXJuCiAgICAgICAgICByZXEucmVsYXkoCiAgICAgICAgICAgIGMuZW5jb2RlKGhhbmRzaGFrZSwgewogICAgICAgICAgICAgIG1vZGU6IEZST01fU0VDT05EX1JFTEFZLAogICAgICAgICAgICAgIG5vaXNlLAogICAgICAgICAgICAgIHBlZXJBZGRyZXNzLAogICAgICAgICAgICAgIHJlbGF5QWRkcmVzczogcmVxLmZyb20KICAgICAgICAgICAgfSksCiAgICAgICAgICAgIHJlbGF5CiAgICAgICAgICApCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgY2FzZSBGUk9NX1NFUlZFUjogewogICAgICAgICAgaWYgKCFwZWVyQWRkcmVzcyB8fCAhbm9pc2UpIHJldHVybgogICAgICAgICAgcmVxLnJlcGx5KAogICAgICAgICAgICBjLmVuY29kZShoYW5kc2hha2UsIHsgbW9kZTogUkVQTFksIG5vaXNlLCBwZWVyQWRkcmVzczogcmVxLmZyb20sIHJlbGF5QWRkcmVzczogbnVsbCB9KSwKICAgICAgICAgICAgeyB0bzogcGVlckFkZHJlc3MsIGNsb3Nlck5vZGVzOiBmYWxzZSwgdG9rZW46IGZhbHNlIH0KICAgICAgICAgICkKICAgICAgICAgIHJldHVybiAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBwZWVySG9sZXB1bmNoKHRhcmdldCwgeyBpZCwgcGF5bG9hZCwgcGVlckFkZHJlc3MsIHNvY2tldCwgc2Vzc2lvbiB9LCB0bykgewogICAgY29uc3QgZGh0ID0gdGhpcy5kaHQKICAgIGNvbnN0IHJlcXVlc3RWYWx1ZSA9IGMuZW5jb2RlKGhvbGVwdW5jaCwgewogICAgICBtb2RlOiBGUk9NX0NMSUVOVCwKICAgICAgaWQsCiAgICAgIHBheWxvYWQsCiAgICAgIHBlZXJBZGRyZXNzCiAgICB9KQoKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGRodC5yZXF1ZXN0KAogICAgICB7IGNvbW1hbmQ6IENPTU1BTkRTLlBFRVJfSE9MRVBVTkNILCB0YXJnZXQsIHZhbHVlOiByZXF1ZXN0VmFsdWUgfSwKICAgICAgdG8sCiAgICAgIHsgc29ja2V0LCBzZXNzaW9uIH0KICAgICkKCiAgICBjb25zdCBocCA9IGRlY29kZShob2xlcHVuY2gsIHJlcy52YWx1ZSkKICAgIGlmICghaHAgfHwgaHAubW9kZSAhPT0gUkVQTFkgfHwgdG8uaG9zdCAhPT0gcmVzLmZyb20uaG9zdCB8fCB0by5wb3J0ICE9PSByZXMuZnJvbS5wb3J0KSB7CiAgICAgIHRocm93IEJBRF9IT0xFUFVOQ0hfUkVQTFkoKQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGZyb206IHJlcy5mcm9tLAogICAgICB0bzogcmVzLnRvLAogICAgICBwYXlsb2FkOiBocC5wYXlsb2FkLAogICAgICBwZWVyQWRkcmVzczogaHAucGVlckFkZHJlc3MgfHwgdG8KICAgIH0KICB9CgogIGFzeW5jIG9ucGVlcmhvbGVwdW5jaChyZXEpIHsKICAgIGNvbnN0IGhwID0gcmVxLnZhbHVlICYmIGRlY29kZShob2xlcHVuY2gsIHJlcS52YWx1ZSkKICAgIGlmICghaHApIHJldHVybgoKICAgIGNvbnN0IHsgbW9kZSwgaWQsIHBheWxvYWQsIHBlZXJBZGRyZXNzIH0gPSBocAoKICAgIGNvbnN0IHN0YXRlID0gcmVxLnRhcmdldCAmJiB0aGlzLmdldChyZXEudGFyZ2V0KQogICAgY29uc3QgaXNTZXJ2ZXIgPSAhIShzdGF0ZSAmJiBzdGF0ZS5vbnBlZXJob2xlcHVuY2gpCiAgICBjb25zdCByZWxheSA9IHN0YXRlICYmIHN0YXRlLnJlbGF5CgogICAgc3dpdGNoIChtb2RlKSB7CiAgICAgIGNhc2UgRlJPTV9DTElFTlQ6IHsKICAgICAgICBpZiAoIXBlZXJBZGRyZXNzICYmICFyZWxheSkgcmV0dXJuCiAgICAgICAgcmVxLnJlbGF5KAogICAgICAgICAgYy5lbmNvZGUoaG9sZXB1bmNoLCB7IG1vZGU6IEZST01fUkVMQVksIGlkLCBwYXlsb2FkLCBwZWVyQWRkcmVzczogcmVxLmZyb20gfSksCiAgICAgICAgICBwZWVyQWRkcmVzcyB8fCByZWxheQogICAgICAgICkKICAgICAgICByZXR1cm4KICAgICAgfQogICAgICBjYXNlIEZST01fUkVMQVk6IHsKICAgICAgICBpZiAoIWlzU2VydmVyIHx8ICFwZWVyQWRkcmVzcykgcmV0dXJuCiAgICAgICAgbGV0IHJlcGx5ID0gbnVsbAogICAgICAgIHRyeSB7CiAgICAgICAgICByZXBseSA9IGF3YWl0IHN0YXRlLm9ucGVlcmhvbGVwdW5jaCh7IGlkLCBwYXlsb2FkLCBwZWVyQWRkcmVzcyB9LCByZXEpCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgc2FmZXR5Q2F0Y2goZSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICBpZiAoIXJlcGx5KSByZXR1cm4KICAgICAgICBjb25zdCBvcHRzID0geyBzb2NrZXQ6IHJlcGx5LnNvY2tldCwgY2xvc2VyTm9kZXM6IGZhbHNlLCB0b2tlbjogZmFsc2UgfQogICAgICAgIHJlcS5yZWxheSgKICAgICAgICAgIGMuZW5jb2RlKGhvbGVwdW5jaCwgeyBtb2RlOiBGUk9NX1NFUlZFUiwgaWQ6IDAsIHBheWxvYWQ6IHJlcGx5LnBheWxvYWQsIHBlZXJBZGRyZXNzIH0pLAogICAgICAgICAgcmVxLmZyb20sCiAgICAgICAgICBvcHRzCiAgICAgICAgKQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIGNhc2UgRlJPTV9TRVJWRVI6IHsKICAgICAgICByZXEucmVwbHkoYy5lbmNvZGUoaG9sZXB1bmNoLCB7IG1vZGU6IFJFUExZLCBpZCwgcGF5bG9hZCwgcGVlckFkZHJlc3M6IHJlcS5mcm9tIH0pLCB7CiAgICAgICAgICB0bzogcGVlckFkZHJlc3MsCiAgICAgICAgICBjbG9zZXJOb2RlczogZmFsc2UsCiAgICAgICAgICB0b2tlbjogZmFsc2UKICAgICAgICB9KQogICAgICAgIHJldHVybiAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGRlY29kZShlbmMsIHZhbCkgewogIHRyeSB7CiAgICByZXR1cm4gYy5kZWNvZGUoZW5jLCB2YWwpCiAgfSBjYXRjaCB7CiAgICByZXR1cm4gbnVsbAogIH0KfQoKZnVuY3Rpb24gdG9TdHJpbmcodCkgewogIHJldHVybiB0eXBlb2YgdCA9PT0gJ3N0cmluZycgPyB0IDogYjRhLnRvU3RyaW5nKHQsICdoZXgnKQp9CmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCB7IGhvbGVwdW5jaFBheWxvYWQgfSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBIb2xlcHVuY2hQYXlsb2FkIHsKICBjb25zdHJ1Y3Rvcihob2xlcHVuY2hTZWNyZXQpIHsKICAgIHRoaXMuX3NoYXJlZFNlY3JldCA9IGhvbGVwdW5jaFNlY3JldAogICAgdGhpcy5fbG9jYWxTZWNyZXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCgogICAgc29kaXVtLnJhbmRvbWJ5dGVzX2J1Zih0aGlzLl9sb2NhbFNlY3JldCkKICB9CgogIGRlY3J5cHQoYnVmZmVyKSB7CiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDI0LCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoIC0gMTYsIGJ1ZmZlciB9CgogICAgaWYgKHN0YXRlLmVuZCA8PSBzdGF0ZS5zdGFydCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBub25jZSA9IGJ1ZmZlci5zdWJhcnJheSgwLCAyNCkKICAgIGNvbnN0IG1zZyA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCwgc3RhdGUuZW5kKQogICAgY29uc3QgY2lwaGVyID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0KQoKICAgIGlmICghc29kaXVtLmNyeXB0b19zZWNyZXRib3hfb3Blbl9lYXN5KG1zZywgY2lwaGVyLCBub25jZSwgdGhpcy5fc2hhcmVkU2VjcmV0KSkgcmV0dXJuIG51bGwKCiAgICB0cnkgewogICAgICByZXR1cm4gaG9sZXB1bmNoUGF5bG9hZC5kZWNvZGUoc3RhdGUpCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIG51bGwKICAgIH0KICB9CgogIGVuY3J5cHQocGF5bG9hZCkgewogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAyNCwgZW5kOiAyNCwgYnVmZmVyOiBudWxsIH0KICAgIGhvbGVwdW5jaFBheWxvYWQucHJlZW5jb2RlKHN0YXRlLCBwYXlsb2FkKQogICAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHN0YXRlLmVuZCArIDE2KQoKICAgIGNvbnN0IG5vbmNlID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KDAsIDI0KQogICAgY29uc3QgbXNnID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0LCBzdGF0ZS5lbmQpCiAgICBjb25zdCBjaXBoZXIgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQpCgogICAgaG9sZXB1bmNoUGF5bG9hZC5lbmNvZGUoc3RhdGUsIHBheWxvYWQpCiAgICBzb2RpdW0ucmFuZG9tYnl0ZXNfYnVmKG5vbmNlKQogICAgc29kaXVtLmNyeXB0b19zZWNyZXRib3hfZWFzeShjaXBoZXIsIG1zZywgbm9uY2UsIHRoaXMuX3NoYXJlZFNlY3JldCkKCiAgICByZXR1cm4gc3RhdGUuYnVmZmVyCiAgfQoKICB0b2tlbihhZGRyKSB7CiAgICBjb25zdCBvdXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKG91dCwgYjRhLmZyb20oYWRkci5ob3N0KSwgdGhpcy5fbG9jYWxTZWNyZXQpCiAgICByZXR1cm4gb3V0CiAgfQp9CmNvbnN0IERPTkUgPSBQcm9taXNlLnJlc29sdmUodHJ1ZSkKY29uc3QgREVTVFJPWUVEID0gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBTZW1hcGhvcmUgewogIGNvbnN0cnVjdG9yKGxpbWl0ID0gMSkgewogICAgdGhpcy5saW1pdCA9IGxpbWl0CiAgICB0aGlzLmFjdGl2ZSA9IDAKICAgIHRoaXMud2FpdGluZyA9IFtdCgogICAgdGhpcy5mbHVzaGVkUHJvbWlzZSA9IG51bGwKICAgIHRoaXMuZmx1c2hlZFJlc29sdmUgPSBudWxsCgogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQoKICAgIHRoaXMuX29ud2FpdCA9IHRoaXMuX3F1ZXVlV2FpdGluZy5iaW5kKHRoaXMpCiAgICB0aGlzLl9vbmZsdXNoID0gdGhpcy5fcXVldWVGbHVzaGVkLmJpbmQodGhpcykKICB9CgogIF9xdWV1ZVdhaXRpbmcocmVzb2x2ZSkgewogICAgdGhpcy53YWl0aW5nLnB1c2gocmVzb2x2ZSkKICB9CgogIF9xdWV1ZUZsdXNoZWQocmVzb2x2ZSkgewogICAgdGhpcy5mbHVzaGVkUmVzb2x2ZSA9IHJlc29sdmUKICB9CgogIHdhaXQoKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQgPT09IHRydWUpIHJldHVybiBERVNUUk9ZRUQKCiAgICBpZiAodGhpcy5hY3RpdmUgPCB0aGlzLmxpbWl0ICYmIHRoaXMud2FpdGluZy5sZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5hY3RpdmUrKwogICAgICByZXR1cm4gRE9ORQogICAgfQoKICAgIHJldHVybiBuZXcgUHJvbWlzZSh0aGlzLl9vbndhaXQpCiAgfQoKICBzaWduYWwoKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQgPT09IHRydWUpIHJldHVybgoKICAgIHRoaXMuYWN0aXZlLS0KICAgIHdoaWxlICh0aGlzLmFjdGl2ZSA8IHRoaXMubGltaXQgJiYgdGhpcy53YWl0aW5nLmxlbmd0aCA+IDAgJiYgdGhpcy5kZXN0cm95ZWQgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMuYWN0aXZlKysKICAgICAgdGhpcy53YWl0aW5nLnNoaWZ0KCkodHJ1ZSkKICAgIH0KCiAgICBpZiAodGhpcy5hY3RpdmUgPT09IDAgJiYgdGhpcy5mbHVzaGVkUmVzb2x2ZSkgewogICAgICBjb25zdCByZXNvbHZlID0gdGhpcy5mbHVzaGVkUmVzb2x2ZQogICAgICB0aGlzLmZsdXNoZWRSZXNvbHZlID0gbnVsbAogICAgICB0aGlzLmZsdXNoZWRQcm9taXNlID0gbnVsbAogICAgICByZXNvbHZlKHRydWUpCiAgICB9CiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCA9PT0gdHJ1ZSkgcmV0dXJuCiAgICBpZiAodGhpcy5hY3RpdmUgPT09IDApIHJldHVybgogICAgaWYgKHRoaXMuZmx1c2hlZFByb21pc2UpIHJldHVybiB0aGlzLmZsdXNoZWRQcm9taXNlCiAgICB0aGlzLmZsdXNoZWRQcm9taXNlID0gbmV3IFByb21pc2UodGhpcy5fb25mbHVzaCkKICAgIHJldHVybiB0aGlzLmZsdXNoZWRQcm9taXNlCiAgfQoKICBkZXN0cm95KCkgewogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCiAgICB0aGlzLmFjdGl2ZSA9IDAKICAgIHdoaWxlICh0aGlzLndhaXRpbmcubGVuZ3RoKSB0aGlzLndhaXRpbmcucG9wKCkoZmFsc2UpCiAgICBpZiAodGhpcy5mbHVzaGVkUmVzb2x2ZSkgdGhpcy5mbHVzaGVkUmVzb2x2ZShmYWxzZSkKICB9Cn0KY29uc3QgeyBFdmVudEVtaXR0ZXIgfSA9IHJlcXVpcmUoJ2V2ZW50cycpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgTm9pc2VTZWNyZXRTdHJlYW0gPSByZXF1aXJlKCdAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgcmVsYXkgPSByZXF1aXJlKCdibGluZC1yZWxheScpCmNvbnN0IE5vaXNlV3JhcCA9IHJlcXVpcmUoJy4vbm9pc2Utd3JhcCcpCmNvbnN0IEFubm91bmNlciA9IHJlcXVpcmUoJy4vYW5ub3VuY2VyJykKY29uc3QgeyBGSVJFV0FMTCwgRVJST1IgfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKY29uc3QgeyB1bnNsYWJiZWRIYXNoIH0gPSByZXF1aXJlKCcuL2NyeXB0bycpCmNvbnN0IFNlY3VyZVBheWxvYWQgPSByZXF1aXJlKCcuL3NlY3VyZS1wYXlsb2FkJykKY29uc3QgSG9sZXB1bmNoZXIgPSByZXF1aXJlKCcuL2hvbGVwdW5jaGVyJykKY29uc3QgeyBpc1ByaXZhdGUgfSA9IHJlcXVpcmUoJ2JvZ29uJykKY29uc3QgeyBBTFJFQURZX0xJU1RFTklORywgTk9ERV9ERVNUUk9ZRUQsIEtFWVBBSVJfQUxSRUFEWV9VU0VEIH0gPSByZXF1aXJlKCcuL2Vycm9ycycpCgpjb25zdCBIQU5EU0hBS0VfQ0xFQVJfV0FJVCA9IDEwMDAwCmNvbnN0IEhBTkRTSEFLRV9JTklUSUFMX1RJTUVPVVQgPSAxMDAwMAoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBTZXJ2ZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKGRodCwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5kaHQgPSBkaHQKICAgIHRoaXMudGFyZ2V0ID0gbnVsbAoKICAgIHRoaXMuY2xvc2VkID0gZmFsc2UKICAgIHRoaXMuZmlyZXdhbGwgPSBvcHRzLmZpcmV3YWxsIHx8ICgoKSA9PiBmYWxzZSkKICAgIHRoaXMuaG9sZXB1bmNoID0gb3B0cy5ob2xlcHVuY2ggfHwgKCgpID0+IHRydWUpCiAgICB0aGlzLnJlbGF5VGhyb3VnaCA9IG9wdHMucmVsYXlUaHJvdWdoIHx8IG51bGwKICAgIHRoaXMucmVsYXlLZWVwQWxpdmUgPSBvcHRzLnJlbGF5S2VlcEFsaXZlIHx8IDUwMDAKICAgIHRoaXMucG9vbCA9IG9wdHMucG9vbCB8fCBudWxsCiAgICB0aGlzLmNyZWF0ZUhhbmRzaGFrZSA9IG9wdHMuY3JlYXRlSGFuZHNoYWtlIHx8IGRlZmF1bHRDcmVhdGVIYW5kc2hha2UKICAgIHRoaXMuY3JlYXRlU2VjcmV0U3RyZWFtID0gb3B0cy5jcmVhdGVTZWNyZXRTdHJlYW0gfHwgZGVmYXVsdENyZWF0ZVNlY3JldFN0cmVhbQogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgdGhpcy5oYW5kc2hha2VDbGVhcldhaXQgPSBvcHRzLmhhbmRzaGFrZUNsZWFyV2FpdCB8fCBIQU5EU0hBS0VfQ0xFQVJfV0FJVAoKICAgIHRoaXMuX3NoYXJlTG9jYWxBZGRyZXNzID0gb3B0cy5zaGFyZUxvY2FsQWRkcmVzcyAhPT0gZmFsc2UKICAgIHRoaXMuX3JldXNhYmxlU29ja2V0ID0gISFvcHRzLnJldXNhYmxlU29ja2V0CiAgICB0aGlzLl9uZXZlclB1bmNoID0gb3B0cy5ob2xlcHVuY2ggPT09IGZhbHNlIC8vIHVzZWZ1bCBmb3IgZnVsbHkgZGlzYWJsaW5nIHB1bmNoaW5nCiAgICB0aGlzLl9rZXlQYWlyID0gbnVsbAogICAgdGhpcy5fYW5ub3VuY2VyID0gbnVsbAogICAgdGhpcy5fY29ubmVjdHMgPSBuZXcgTWFwKCkKICAgIHRoaXMuX2hvbGVwdW5jaGVzID0gW10KICAgIHRoaXMuX2xpc3RlbmluZyA9IG51bGwKICAgIHRoaXMuX2Nsb3NpbmcgPSBudWxsCiAgfQoKICBnZXQgbGlzdGVuaW5nKCkgewogICAgcmV0dXJuIHRoaXMuX2xpc3RlbmluZyAhPT0gbnVsbAogIH0KCiAgZ2V0IHB1YmxpY0tleSgpIHsKICAgIHJldHVybiB0aGlzLl9rZXlQYWlyICYmIHRoaXMuX2tleVBhaXIucHVibGljS2V5CiAgfQoKICBnZXQgcmVsYXlBZGRyZXNzZXMoKSB7CiAgICByZXR1cm4gdGhpcy5fYW5ub3VuY2VyID8gdGhpcy5fYW5ub3VuY2VyLnJlbGF5QWRkcmVzc2VzIDogW10KICB9CgogIG9uY29ubmVjdGlvbihlbmNyeXB0ZWRTb2NrZXQpIHsKICAgIHRoaXMuZW1pdCgnY29ubmVjdGlvbicsIGVuY3J5cHRlZFNvY2tldCkKICB9CgogIGFzeW5jIHN1c3BlbmQoeyBsb2cgPSBub29wIH0gPSB7fSkgewogICAgbG9nKCdTdXNwZW5kaW5nIGh5cGVyZGh0IHNlcnZlcicpCiAgICBpZiAodGhpcy5fbGlzdGVuaW5nICE9PSBudWxsKSBhd2FpdCB0aGlzLl9saXN0ZW5pbmcKICAgIGxvZygnU3VzcGVuZGluZyBoeXBlcmRodCBzZXJ2ZXIgKHBvc3QgbGlzdGVuaW5nKScpCiAgICB0aGlzLnN1c3BlbmRlZCA9IHRydWUKICAgIHRoaXMuX2NsZWFyQWxsKCkKICAgIHJldHVybiB0aGlzLl9hbm5vdW5jZXIgPyB0aGlzLl9hbm5vdW5jZXIuc3VzcGVuZCh7IGxvZyB9KSA6IFByb21pc2UucmVzb2x2ZSgpCiAgfQoKICBhc3luYyByZXN1bWUoKSB7CiAgICBpZiAodGhpcy5fbGlzdGVuaW5nICE9PSBudWxsKSBhd2FpdCB0aGlzLl9saXN0ZW5pbmcKICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKICAgIHJldHVybiB0aGlzLl9hbm5vdW5jZXIgPyB0aGlzLl9hbm5vdW5jZXIucmVzdW1lKCkgOiBQcm9taXNlLnJlc29sdmUoKQogIH0KCiAgYWRkcmVzcygpIHsKICAgIGlmICghdGhpcy5fa2V5UGFpcikgcmV0dXJuIG51bGwKCiAgICByZXR1cm4gewogICAgICBwdWJsaWNLZXk6IHRoaXMuX2tleVBhaXIucHVibGljS2V5LAogICAgICBob3N0OiB0aGlzLmRodC5ob3N0LAogICAgICBwb3J0OiB0aGlzLmRodC5wb3J0CiAgICB9CiAgfQoKICBjbG9zZSgpIHsKICAgIGlmICh0aGlzLl9jbG9zaW5nKSByZXR1cm4gdGhpcy5fY2xvc2luZwogICAgdGhpcy5fY2xvc2luZyA9IHRoaXMuX2Nsb3NlKCkKICAgIHJldHVybiB0aGlzLl9jbG9zaW5nCiAgfQoKICBfZ2MoKSB7CiAgICB0aGlzLmRodC5saXN0ZW5pbmcuZGVsZXRlKHRoaXMpCiAgICBpZiAodGhpcy50YXJnZXQpIHRoaXMuZGh0Ll9yb3V0ZXIuZGVsZXRlKHRoaXMudGFyZ2V0KQogIH0KCiAgYXN5bmMgX3N0b3BMaXN0ZW5pbmcoKSB7CiAgICB0cnkgewogICAgICBpZiAodGhpcy5fYW5ub3VuY2VyKSBhd2FpdCB0aGlzLl9hbm5vdW5jZXIuc3RvcCgpCiAgICB9IGNhdGNoIHsKICAgICAgLy8gaWdub3JlCiAgICB9CgogICAgdGhpcy5fYW5ub3VuY2VyID0gbnVsbAogICAgdGhpcy5fbGlzdGVuaW5nID0gbnVsbAogICAgdGhpcy5fa2V5UGFpciA9IG51bGwKICB9CgogIGFzeW5jIF9jbG9zZSgpIHsKICAgIGlmICh0aGlzLl9saXN0ZW5pbmcgPT09IG51bGwpIHsKICAgICAgdGhpcy5jbG9zZWQgPSB0cnVlCiAgICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9saXN0ZW5pbmcKICAgIH0gY2F0Y2gge30KCiAgICB0aGlzLl9nYygpCiAgICB0aGlzLl9jbGVhckFsbCgpCgogICAgYXdhaXQgdGhpcy5fc3RvcExpc3RlbmluZygpCgogICAgdGhpcy5jbG9zZWQgPSB0cnVlCiAgICB0aGlzLmVtaXQoJ2Nsb3NlJykKICB9CgogIF9jbGVhckFsbCgpIHsKICAgIHdoaWxlICh0aGlzLl9ob2xlcHVuY2hlcy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IGggPSB0aGlzLl9ob2xlcHVuY2hlcy5wb3AoKQogICAgICBpZiAoaCAmJiBoLnB1bmNoZXIpIGgucHVuY2hlci5kZXN0cm95KCkKICAgICAgaWYgKGggJiYgaC5jbGVhcmluZykgY2xlYXJUaW1lb3V0KGguY2xlYXJpbmcpCiAgICAgIGlmIChoICYmIGgucHJlcHVuY2hpbmcpIGNsZWFyVGltZW91dChoLnByZXB1bmNoaW5nKQogICAgICBpZiAoaCAmJiBoLnJhd1N0cmVhbSkgaC5yYXdTdHJlYW0uZGVzdHJveSgpCiAgICB9CgogICAgdGhpcy5fY29ubmVjdHMuY2xlYXIoKQogIH0KCiAgYXN5bmMgbGlzdGVuKGtleVBhaXIgPSB0aGlzLmRodC5kZWZhdWx0S2V5UGFpciwgb3B0cyA9IHt9KSB7CiAgICBpZiAodGhpcy5fbGlzdGVuaW5nICE9PSBudWxsKSB0aHJvdyBBTFJFQURZX0xJU1RFTklORygpCiAgICBpZiAodGhpcy5kaHQuZGVzdHJveWVkKSB0aHJvdyBOT0RFX0RFU1RST1lFRCgpCgogICAgdGhpcy5fbGlzdGVuaW5nID0gdGhpcy5fbGlzdGVuKGtleVBhaXIsIG9wdHMpCiAgICBhd2FpdCB0aGlzLl9saXN0ZW5pbmcKICAgIHJldHVybiB0aGlzCiAgfQoKICBhc3luYyBfbGlzdGVuKGtleVBhaXIsIG9wdHMpIHsKICAgIC8vIEZyb20gbm93IG9uLCB0aGUgREhUIG9iamVjdCB3aGljaCBjcmVhdGVkIG1lIGlzIHJlc3BvbnNpYmxlIGZvciBjbG9zaW5nIG1lCiAgICB0aGlzLmRodC5saXN0ZW5pbmcuYWRkKHRoaXMpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5kaHQuYmluZCgpCiAgICAgIGlmICh0aGlzLl9jbG9zaW5nKSByZXR1cm4KCiAgICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLmRodC5saXN0ZW5pbmcpIHsKICAgICAgICBpZiAocy5fa2V5UGFpciAmJiBiNGEuZXF1YWxzKHMuX2tleVBhaXIucHVibGljS2V5LCBrZXlQYWlyLnB1YmxpY0tleSkpIHsKICAgICAgICAgIHRocm93IEtFWVBBSVJfQUxSRUFEWV9VU0VEKCkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMudGFyZ2V0ID0gdW5zbGFiYmVkSGFzaChrZXlQYWlyLnB1YmxpY0tleSkKICAgICAgdGhpcy5fa2V5UGFpciA9IGtleVBhaXIKICAgICAgdGhpcy5fYW5ub3VuY2VyID0gbmV3IEFubm91bmNlcih0aGlzLmRodCwga2V5UGFpciwgdGhpcy50YXJnZXQsIG9wdHMpCgogICAgICB0aGlzLmRodC5fcm91dGVyLnNldCh0aGlzLnRhcmdldCwgewogICAgICAgIHJlbGF5OiBudWxsLAogICAgICAgIHJlY29yZDogdGhpcy5fYW5ub3VuY2VyLnJlY29yZCwKICAgICAgICBvbnBlZXJoYW5kc2hha2U6IHRoaXMuX29ucGVlcmhhbmRzaGFrZS5iaW5kKHRoaXMpLAogICAgICAgIG9ucGVlcmhvbGVwdW5jaDogdGhpcy5fb25wZWVyaG9sZXB1bmNoLmJpbmQodGhpcykKICAgICAgfSkKCiAgICAgIC8vIHdhcm0gaXQgdXAgZm9yIG5vdwogICAgICB0aGlzLl9sb2NhbEFkZHJlc3NlcygpLmNhdGNoKHNhZmV0eUNhdGNoKQoKICAgICAgYXdhaXQgdGhpcy5fYW5ub3VuY2VyLnN0YXJ0KCkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBhd2FpdCB0aGlzLl9zdG9wTGlzdGVuaW5nKCkKICAgICAgdGhpcy5fZ2MoKQogICAgICB0aHJvdyBlcnIKICAgIH0KCiAgICBpZiAodGhpcy5fY2xvc2luZykgcmV0dXJuCiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIGF3YWl0IHRoaXMuX2Fubm91bmNlci5zdXNwZW5kKCkKCiAgICBpZiAodGhpcy5fY2xvc2luZykgcmV0dXJuCiAgICBpZiAodGhpcy5kaHQuZGVzdHJveWVkKSB0aHJvdyBOT0RFX0RFU1RST1lFRCgpCgogICAgaWYgKHRoaXMucG9vbCkgdGhpcy5wb29sLl9hdHRhY2hTZXJ2ZXIodGhpcykKCiAgICB0aGlzLmVtaXQoJ2xpc3RlbmluZycpCiAgfQoKICByZWZyZXNoKCkgewogICAgaWYgKHRoaXMuX2Fubm91bmNlciAmJiAhdGhpcy5zdXNwZW5kZWQpIHRoaXMuX2Fubm91bmNlci5yZWZyZXNoKCkKICB9CgogIG5vdGlmeU9ubGluZSgpIHsKICAgIGlmICh0aGlzLl9hbm5vdW5jZXIpIHRoaXMuX2Fubm91bmNlci5vbmxpbmUubm90aWZ5KCkKICB9CgogIF9sb2NhbEFkZHJlc3NlcygpIHsKICAgIHJldHVybiB0aGlzLmRodC52YWxpZGF0ZUxvY2FsQWRkcmVzc2VzKEhvbGVwdW5jaGVyLmxvY2FsQWRkcmVzc2VzKHRoaXMuZGh0LmlvLnNlcnZlclNvY2tldCkpCiAgfQoKICBhc3luYyBfYWRkSGFuZHNoYWtlKGssIG5vaXNlLCBjbGllbnRBZGRyZXNzLCB7IGZyb20sIHRvOiBzZXJ2ZXJBZGRyZXNzLCBzb2NrZXQgfSwgZGlyZWN0KSB7CiAgICBsZXQgaWQgPSB0aGlzLl9ob2xlcHVuY2hlcy5pbmRleE9mKG51bGwpCiAgICBpZiAoaWQgPT09IC0xKSBpZCA9IHRoaXMuX2hvbGVwdW5jaGVzLnB1c2gobnVsbCkgLSAxCgogICAgY29uc3QgaHMgPSB7CiAgICAgIHJvdW5kOiAwLAogICAgICByZXBseTogbnVsbCwKICAgICAgcHVuY2hlcjogbnVsbCwKICAgICAgcGF5bG9hZDogbnVsbCwKICAgICAgcmF3U3RyZWFtOiBudWxsLAogICAgICBlbmNyeXB0ZWRTb2NrZXQ6IG51bGwsCiAgICAgIHByZXB1bmNoaW5nOiBudWxsLAogICAgICBmaXJld2FsbGVkOiB0cnVlLAogICAgICBjbGVhcmluZzogbnVsbCwKICAgICAgb25zb2NrZXQ6IG51bGwsCiAgICAgIGFib3J0ZWQ6IGZhbHNlLAoKICAgICAgLy8gUmVsYXkgc3RhdGUKICAgICAgcmVsYXlUaW1lb3V0OiBudWxsLAogICAgICByZWxheVRva2VuOiBudWxsLAogICAgICByZWxheVNvY2tldDogbnVsbCwKICAgICAgcmVsYXlDbGllbnQ6IG51bGwsCiAgICAgIHJlbGF5UGFpcmVkOiBmYWxzZQogICAgfQoKICAgIHRoaXMuX2hvbGVwdW5jaGVzW2lkXSA9IGhzCgogICAgY29uc3QgaGFuZHNoYWtlID0gdGhpcy5jcmVhdGVIYW5kc2hha2UodGhpcy5fa2V5UGFpciwgbnVsbCkKCiAgICBsZXQgcmVtb3RlUGF5bG9hZAogICAgdHJ5IHsKICAgICAgcmVtb3RlUGF5bG9hZCA9IGF3YWl0IGhhbmRzaGFrZS5yZWN2KG5vaXNlKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgICAgdGhpcy5fY2xlYXJMYXRlcihocywgaWQsIGspCiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgaWYgKHRoaXMuX2Nsb3NpbmcgfHwgdGhpcy5zdXNwZW5kZWQpIHJldHVybiBudWxsCgogICAgdHJ5IHsKICAgICAgaHMuZmlyZXdhbGxlZCA9IGF3YWl0IHRoaXMuZmlyZXdhbGwoaGFuZHNoYWtlLnJlbW90ZVB1YmxpY0tleSwgcmVtb3RlUGF5bG9hZCwgY2xpZW50QWRkcmVzcykKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICB9CgogICAgaWYgKHRoaXMuX2Nsb3NpbmcgfHwgdGhpcy5zdXNwZW5kZWQpIHJldHVybiBudWxsCgogICAgaWYgKGhzLmZpcmV3YWxsZWQpIHsKICAgICAgdGhpcy5fY2xlYXJMYXRlcihocywgaWQsIGspCiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgY29uc3QgZXJyb3IgPQogICAgICByZW1vdGVQYXlsb2FkLnZlcnNpb24gPT09IDEKICAgICAgICA/IHJlbW90ZVBheWxvYWQudWR4CiAgICAgICAgICA/IEVSUk9SLk5PTkUKICAgICAgICAgIDogRVJST1IuQUJPUlRFRAogICAgICAgIDogRVJST1IuVkVSU0lPTl9NSVNNQVRDSAoKICAgIGNvbnN0IGFkZHJlc3NlcyA9IFtdCiAgICBjb25zdCBvdXJSZW1vdGVBZGRyID0gdGhpcy5kaHQucmVtb3RlQWRkcmVzcygpCiAgICBjb25zdCBvdXJMb2NhbEFkZHJzID0gdGhpcy5fc2hhcmVMb2NhbEFkZHJlc3MgPyBhd2FpdCB0aGlzLl9sb2NhbEFkZHJlc3NlcygpIDogbnVsbAoKICAgIGlmICh0aGlzLl9jbG9zaW5nIHx8IHRoaXMuc3VzcGVuZGVkKSByZXR1cm4gbnVsbAoKICAgIGlmIChvdXJSZW1vdGVBZGRyKSBhZGRyZXNzZXMucHVzaChvdXJSZW1vdGVBZGRyKQogICAgaWYgKG91ckxvY2FsQWRkcnMpIGFkZHJlc3Nlcy5wdXNoKC4uLm91ckxvY2FsQWRkcnMpCgogICAgaWYgKGVycm9yID09PSBFUlJPUi5OT05FKSB7CiAgICAgIGhzLnJhd1N0cmVhbSA9IHRoaXMuZGh0LmNyZWF0ZVJhd1N0cmVhbSh7CiAgICAgICAgZnJhbWVkOiB0cnVlLAogICAgICAgIGZpcmV3YWxsKHNvY2tldCwgcG9ydCwgaG9zdCkgewogICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIHRyYWZmaWMgb3JpZ2luYXRlZCBmcm9tIHRoZSBzb2NrZXQgb24gd2hpY2ggd2UncmUgZXhwZWN0aW5nIHJlbGF5IHRyYWZmaWMuIElmIHNvLAogICAgICAgICAgLy8gd2UgaGF2ZW4ndCBob2xlIHB1bmNoZWQgeWV0IGFuZCB0aGUgb3RoZXIgc2lkZSBpcyBqdXN0IHNlbmRpbmcgdXMgdHJhZmZpYyB0aHJvdWdoIHRoZSByZWxheS4KICAgICAgICAgIGlmIChocy5yZWxheVNvY2tldCAmJiBpc1JlbGF5KGhzLnJlbGF5U29ja2V0LCBzb2NrZXQsIHBvcnQsIGhvc3QpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgICAgfQoKICAgICAgICAgIGhzLm9uc29ja2V0KHNvY2tldCwgcG9ydCwgaG9zdCkKICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgfSkKCiAgICAgIGhzLnJhd1N0cmVhbS5vbignZXJyb3InLCBhdXRvRGVzdHJveSkKCiAgICAgIC8vIEhhbmRsZXMgdGhlIGNhc2Ugd2hlcmUgb25zb2NrZXQgaXMgbmV2ZXIgY2FsbGVkLCBidXQgdGhlIHN0cmVhbSBnb3Qgc2V0dXAKICAgICAgLy8gVGhpcyBjYW4gaGFwcGVuIG9uIGEgcmVsYXllZCBjb25uZWN0aW9uIHdoaWNoIG5ldmVyIGNvbm5lY3RzIGRpcmVjdGx5CiAgICAgIC8vIChvbnNvY2tldCBpcyBjYWxsZWQgdGhlcmUgb25seSB3aGVuIHRoZSBkaXJlY3QgY29ubmVjdGlvbiBpcyBlc3RhYmxpc2hlZCkKICAgICAgY29uc3Qgb25yYXdzdHJlYW1jbG9zZSA9ICgpID0+IHsKICAgICAgICBpZiAodGhpcy5fY2xvc2luZykgcmV0dXJuCiAgICAgICAgdGhpcy5fY2xlYXJMYXRlcihocywgaWQsIGspCiAgICAgIH0KICAgICAgaHMucmF3U3RyZWFtLm9uKCdjbG9zZScsIG9ucmF3c3RyZWFtY2xvc2UpCgogICAgICBocy5vbnNvY2tldCA9IChzb2NrZXQsIHBvcnQsIGhvc3QpID0+IHsKICAgICAgICBpZiAoaHMucmF3U3RyZWFtID09PSBudWxsKSByZXR1cm4gLy8gQWxyZWFkeSBob2xlIHB1bmNoZWQKCiAgICAgICAgdGhpcy5fY2xlYXJMYXRlcihocywgaWQsIGspCgogICAgICAgIGlmIChocy5wcmVwdW5jaGluZykgewogICAgICAgICAgY2xlYXJUaW1lb3V0KGhzLnByZXB1bmNoaW5nKQogICAgICAgICAgaHMucHJlcHVuY2hpbmcgPSBudWxsCiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fcmV1c2FibGVTb2NrZXQgJiYgcmVtb3RlUGF5bG9hZC51ZHgucmV1c2FibGVTb2NrZXQpIHsKICAgICAgICAgIHRoaXMuZGh0Ll9zb2NrZXRQb29sLnJvdXRlcy5hZGQoaGFuZHNoYWtlLnJlbW90ZVB1YmxpY0tleSwgaHMucmF3U3RyZWFtKQogICAgICAgIH0KCiAgICAgICAgaHMucmF3U3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIGF1dG9EZXN0cm95KQogICAgICAgIGhzLnJhd1N0cmVhbS5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBvbnJhd3N0cmVhbWNsb3NlKQoKICAgICAgICBpZiAoaHMucmF3U3RyZWFtLmNvbm5lY3RlZCkgewogICAgICAgICAgY29uc3QgcmVtb3RlQ2hhbmdpbmcgPSBocy5yYXdTdHJlYW0uY2hhbmdlUmVtb3RlKHNvY2tldCwgcmVtb3RlUGF5bG9hZC51ZHguaWQsIHBvcnQsIGhvc3QpCgogICAgICAgICAgaWYgKHJlbW90ZUNoYW5naW5nKSByZW1vdGVDaGFuZ2luZy5jYXRjaChzYWZldHlDYXRjaCkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaHMucmF3U3RyZWFtLmNvbm5lY3Qoc29ja2V0LCByZW1vdGVQYXlsb2FkLnVkeC5pZCwgcG9ydCwgaG9zdCkKICAgICAgICAgIGhzLmVuY3J5cHRlZFNvY2tldCA9IHRoaXMuY3JlYXRlU2VjcmV0U3RyZWFtKGZhbHNlLCBocy5yYXdTdHJlYW0sIHsKICAgICAgICAgICAgaGFuZHNoYWtlOiBoLAogICAgICAgICAgICBrZWVwQWxpdmU6IHRoaXMuZGh0LmNvbm5lY3Rpb25LZWVwQWxpdmUKICAgICAgICAgIH0pCgogICAgICAgICAgdGhpcy5vbmNvbm5lY3Rpb24oaHMuZW5jcnlwdGVkU29ja2V0KQogICAgICAgIH0KCiAgICAgICAgaWYgKGhzLnB1bmNoZXIpIHsKICAgICAgICAgIGhzLnB1bmNoZXIub25hYm9ydCA9IG5vb3AKICAgICAgICAgIGhzLnB1bmNoZXIuZGVzdHJveSgpCiAgICAgICAgfQoKICAgICAgICBocy5yYXdTdHJlYW0gPSBudWxsCiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGF1dG9EZXN0cm95KCkgewogICAgICAgIGlmIChocy5wdW5jaGVyKSBocy5wdW5jaGVyLmRlc3Ryb3koKQogICAgICB9CiAgICB9CgogICAgY29uc3QgcmVsYXlBZGRyZXNzZXMgPSB0aGlzLnJlbGF5QWRkcmVzc2VzCiAgICBjb25zdCByZWxheVRocm91Z2ggPSBzZWxlY3RSZWxheSh0aGlzLnJlbGF5VGhyb3VnaCkKCiAgICBpZiAocmVsYXlUaHJvdWdoKSBocy5yZWxheVRva2VuID0gcmVsYXkudG9rZW4oKQoKICAgIHRyeSB7CiAgICAgIGhzLnJlcGx5ID0gYXdhaXQgaGFuZHNoYWtlLnNlbmQoewogICAgICAgIGVycm9yLAogICAgICAgIGZpcmV3YWxsOiBvdXJSZW1vdGVBZGRyID8gRklSRVdBTEwuT1BFTiA6IEZJUkVXQUxMLlVOS05PV04sCiAgICAgICAgaG9sZXB1bmNoOiBvdXJSZW1vdGVBZGRyID8gbnVsbCA6IHsgaWQsIHJlbGF5czogdGhpcy5fYW5ub3VuY2VyLnJlbGF5cyB9LAogICAgICAgIGFkZHJlc3NlczQ6IGFkZHJlc3NlcywKICAgICAgICBhZGRyZXNzZXM2OiBudWxsLAogICAgICAgIHVkeDogewogICAgICAgICAgcmV1c2FibGVTb2NrZXQ6IHRoaXMuX3JldXNhYmxlU29ja2V0LAogICAgICAgICAgaWQ6IGhzLnJhd1N0cmVhbSA/IGhzLnJhd1N0cmVhbS5pZCA6IDAsCiAgICAgICAgICBzZXE6IDAKICAgICAgICB9LAogICAgICAgIHNlY3JldFN0cmVhbToge30sCiAgICAgICAgcmVsYXlUaHJvdWdoOiByZWxheVRocm91Z2ggPyB7IHB1YmxpY0tleTogcmVsYXlUaHJvdWdoLCB0b2tlbjogaHMucmVsYXlUb2tlbiB9IDogbnVsbCwKICAgICAgICByZWxheUFkZHJlc3NlczogcmVsYXlBZGRyZXNzZXMubGVuZ3RoID8gcmVsYXlBZGRyZXNzZXMgOiBudWxsCiAgICAgIH0pCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgICBocy5yYXdTdHJlYW0uZGVzdHJveSgpCiAgICAgIHRoaXMuX2NsZWFyTGF0ZXIoaHMsIGlkLCBrKQogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGlmICh0aGlzLl9jbG9zaW5nIHx8IHRoaXMuc3VzcGVuZGVkKSB7CiAgICAgIGhzLnJhd1N0cmVhbS5kZXN0cm95KCkKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBjb25zdCBoID0gaGFuZHNoYWtlLmZpbmFsKCkKCiAgICBpZiAoZXJyb3IgIT09IEVSUk9SLk5PTkUpIHsKICAgICAgaHMucmF3U3RyZWFtLmRlc3Ryb3koKQogICAgICB0aGlzLl9jbGVhckxhdGVyKGhzLCBpZCwgaykKICAgICAgcmV0dXJuIGhzCiAgICB9CgogICAgaWYgKHJlbW90ZVBheWxvYWQuZmlyZXdhbGwgPT09IEZJUkVXQUxMLk9QRU4gfHwgZGlyZWN0KSB7CiAgICAgIGNvbnN0IHNvY2sgPSBkaXJlY3QgPyBzb2NrZXQgOiB0aGlzLmRodC5zb2NrZXQKICAgICAgdGhpcy5kaHQuc3RhdHMucHVuY2hlcy5vcGVuKysKICAgICAgaHMub25zb2NrZXQoc29jaywgY2xpZW50QWRkcmVzcy5wb3J0LCBjbGllbnRBZGRyZXNzLmhvc3QpCiAgICAgIHJldHVybiBocwogICAgfQoKICAgIGlmIChyZWxheVRocm91Z2ggfHwgcmVtb3RlUGF5bG9hZC5yZWxheVRocm91Z2gpIHsKICAgICAgdGhpcy5fcmVsYXlDb25uZWN0aW9uKGhzLCByZWxheVRocm91Z2gsIHJlbW90ZVBheWxvYWQsIGgpCiAgICB9CgogICAgY29uc3Qgb25hYm9ydCA9ICgpID0+IHsKICAgICAgaHMuYWJvcnRlZCA9IHRydWUKICAgICAgaWYgKGhzLnByZXB1bmNoaW5nKSBjbGVhclRpbWVvdXQoaHMucHJlcHVuY2hpbmcpCiAgICAgIGhzLnByZXB1bmNoaW5nID0gbnVsbAogICAgICBpZiAoaHMucmF3U3RyZWFtLmRlc3Ryb3llZCkgewogICAgICAgIHRoaXMuX2NsZWFyTGF0ZXIoaHMsIGlkLCBrKQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICBocy5yYXdTdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4gdGhpcy5fY2xlYXJMYXRlcihocywgaWQsIGspKQogICAgICBpZiAoaHMucmVsYXlUb2tlbiA9PT0gbnVsbCkgaHMucmF3U3RyZWFtLmRlc3Ryb3koKQogICAgfQoKICAgIGlmICghZGlyZWN0ICYmIGNsaWVudEFkZHJlc3MuaG9zdCA9PT0gc2VydmVyQWRkcmVzcy5ob3N0KSB7CiAgICAgIGNvbnN0IGNsaWVudEFkZHJlc3NlcyA9IHJlbW90ZVBheWxvYWQuYWRkcmVzc2VzNC5maWx0ZXIob25seVByaXZhdGVIb3N0cykKCiAgICAgIGlmIChjbGllbnRBZGRyZXNzZXMubGVuZ3RoID4gMCAmJiB0aGlzLl9zaGFyZUxvY2FsQWRkcmVzcykgewogICAgICAgIGNvbnN0IG15QWRkcmVzc2VzID0gYXdhaXQgdGhpcy5fbG9jYWxBZGRyZXNzZXMoKQogICAgICAgIGNvbnN0IGFkZHIgPSBIb2xlcHVuY2hlci5tYXRjaEFkZHJlc3MobXlBZGRyZXNzZXMsIGNsaWVudEFkZHJlc3NlcykKCiAgICAgICAgaWYgKGFkZHIpIHsKICAgICAgICAgIGhzLnByZXB1bmNoaW5nID0gc2V0VGltZW91dChvbmFib3J0LCBIQU5EU0hBS0VfSU5JVElBTF9USU1FT1VUKQogICAgICAgICAgcmV0dXJuIGhzCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMuX2Nsb3NpbmcgfHwgdGhpcy5zdXNwZW5kZWQpIHJldHVybiBudWxsCgogICAgaWYgKG91clJlbW90ZUFkZHIgfHwgdGhpcy5fbmV2ZXJQdW5jaCkgewogICAgICBocy5wcmVwdW5jaGluZyA9IHNldFRpbWVvdXQob25hYm9ydCwgSEFORFNIQUtFX0lOSVRJQUxfVElNRU9VVCkKICAgICAgcmV0dXJuIGhzCiAgICB9CgogICAgaHMucGF5bG9hZCA9IG5ldyBTZWN1cmVQYXlsb2FkKGguaG9sZXB1bmNoU2VjcmV0KQogICAgaHMucHVuY2hlciA9IG5ldyBIb2xlcHVuY2hlcih0aGlzLmRodCwgdGhpcy5kaHQuc2Vzc2lvbigpLCBmYWxzZSwgcmVtb3RlUGF5bG9hZC5maXJld2FsbCkKCiAgICBocy5wdW5jaGVyLm9uY29ubmVjdCA9IGhzLm9uc29ja2V0CiAgICBocy5wdW5jaGVyLm9uYWJvcnQgPSBvbmFib3J0CiAgICBocy5wcmVwdW5jaGluZyA9IHNldFRpbWVvdXQoaHMucHVuY2hlci5kZXN0cm95LmJpbmQoaHMucHVuY2hlciksIEhBTkRTSEFLRV9JTklUSUFMX1RJTUVPVVQpCgogICAgcmV0dXJuIGhzCiAgfQoKICBfY2xlYXJMYXRlcihocywgaWQsIGspIHsKICAgIGlmIChocy5jbGVhcmluZykgcmV0dXJuCiAgICBocy5jbGVhcmluZyA9IHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fY2xlYXIoaHMsIGlkLCBrKSwgdGhpcy5oYW5kc2hha2VDbGVhcldhaXQpCiAgfQoKICBfY2xlYXIoaHMsIGlkLCBrKSB7CiAgICBpZiAoaWQgPj0gdGhpcy5faG9sZXB1bmNoZXMubGVuZ3RoIHx8IHRoaXMuX2hvbGVwdW5jaGVzW2lkXSAhPT0gaHMpIHJldHVybgogICAgaWYgKGhzLmNsZWFyaW5nKSBjbGVhclRpbWVvdXQoaHMuY2xlYXJpbmcpCgogICAgdGhpcy5faG9sZXB1bmNoZXNbaWRdID0gbnVsbAogICAgd2hpbGUgKAogICAgICB0aGlzLl9ob2xlcHVuY2hlcy5sZW5ndGggPiAwICYmCiAgICAgIHRoaXMuX2hvbGVwdW5jaGVzW3RoaXMuX2hvbGVwdW5jaGVzLmxlbmd0aCAtIDFdID09PSBudWxsCiAgICApIHsKICAgICAgdGhpcy5faG9sZXB1bmNoZXMucG9wKCkKICAgIH0KICAgIHRoaXMuX2Nvbm5lY3RzLmRlbGV0ZShrKQogIH0KCiAgYXN5bmMgX29ucGVlcmhhbmRzaGFrZSh7IG5vaXNlLCBwZWVyQWRkcmVzcyB9LCByZXEpIHsKICAgIGNvbnN0IGsgPSBiNGEudG9TdHJpbmcobm9pc2UsICdoZXgnKQoKICAgIC8vIFRoZSBuZXh0IGNvdXBsZSBvZiBzdGF0ZW1lbnRzIE1VU1QgcnVuIHdpdGhpbiB0aGUgc2FtZSB0aWNrIHRvIHByZXZlbnQKICAgIC8vIGEgbWFsaWNpb3VzIHBlZXIgZnJvbSBmbG9vZGluZyB1cyB3aXRoIGhhbmRzaGFrZXMuCiAgICBsZXQgcCA9IHRoaXMuX2Nvbm5lY3RzLmdldChrKQogICAgaWYgKCFwKSB7CiAgICAgIHAgPSB0aGlzLl9hZGRIYW5kc2hha2Uoaywgbm9pc2UsIHBlZXJBZGRyZXNzIHx8IHJlcS5mcm9tLCByZXEsICFwZWVyQWRkcmVzcykKICAgICAgdGhpcy5fY29ubmVjdHMuc2V0KGssIHApCiAgICB9CgogICAgY29uc3QgaCA9IGF3YWl0IHAKICAgIGlmICghaCkgcmV0dXJuIG51bGwKCiAgICBpZiAodGhpcy5fY2xvc2luZyAhPT0gbnVsbCB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuIG51bGwKCiAgICByZXR1cm4geyBzb2NrZXQ6IGgucHVuY2hlciAmJiBoLnB1bmNoZXIuc29ja2V0LCBub2lzZTogaC5yZXBseSB9CiAgfQoKICBhc3luYyBfb25wZWVyaG9sZXB1bmNoKHsgaWQsIHBlZXJBZGRyZXNzLCBwYXlsb2FkIH0sIHJlcSkgewogICAgY29uc3QgaCA9IGlkIDwgdGhpcy5faG9sZXB1bmNoZXMubGVuZ3RoID8gdGhpcy5faG9sZXB1bmNoZXNbaWRdIDogbnVsbAogICAgaWYgKCFoKSByZXR1cm4gbnVsbAoKICAgIGlmICghcGVlckFkZHJlc3MgfHwgdGhpcy5fY2xvc2luZyAhPT0gbnVsbCB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBwID0gaC5wdW5jaGVyCiAgICBpZiAoIXAgfHwgIXAuc29ja2V0KSByZXR1cm4gdGhpcy5fYWJvcnQoaCkgLy8gbm90IG9wZW5lZAoKICAgIGNvbnN0IHJlbW90ZVBheWxvYWQgPSBoLnBheWxvYWQuZGVjcnlwdChwYXlsb2FkKQogICAgaWYgKCFyZW1vdGVQYXlsb2FkKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IGlzU2VydmVyUmVsYXkgPSB0aGlzLl9hbm5vdW5jZXIuaXNSZWxheShyZXEuZnJvbSkKICAgIGNvbnN0IHsgZXJyb3IsIGZpcmV3YWxsLCByb3VuZCwgcHVuY2hpbmcsIGFkZHJlc3NlcywgcmVtb3RlQWRkcmVzcywgcmVtb3RlVG9rZW4gfSA9CiAgICAgIHJlbW90ZVBheWxvYWQKCiAgICBpZiAoZXJyb3IgIT09IEVSUk9SLk5PTkUpIHsKICAgICAgLy8gV2UgYWN0dWFsbHkgZG8gbm90IG5lZWQgdG8gc2V0IHRoZSByb3VuZCBoZXJlLCBidXQganVzdCBkbyBpdCBmb3IgY29uc2lzdGVuY3kuCiAgICAgIGlmIChyb3VuZCA+PSBoLnJvdW5kKSBoLnJvdW5kID0gcm91bmQKICAgICAgcmV0dXJuIHRoaXMuX2Fib3J0KGgpCiAgICB9CgogICAgY29uc3QgdG9rZW4gPSBoLnBheWxvYWQudG9rZW4ocGVlckFkZHJlc3MpCiAgICBjb25zdCBlY2hvZWQgPSBpc1NlcnZlclJlbGF5ICYmICEhcmVtb3RlVG9rZW4gJiYgYjRhLmVxdWFscyh0b2tlbiwgcmVtb3RlVG9rZW4pCgogICAgLy8gVXBkYXRlIG91ciBoZXVyaXN0aWNzIGhlcmUKICAgIGlmIChyZXEuc29ja2V0ID09PSBwLnNvY2tldCkgewogICAgICBwLm5hdC5hZGQocmVxLnRvLCByZXEuZnJvbSkKICAgIH0KCiAgICBpZiAocm91bmQgPj0gaC5yb3VuZCkgewogICAgICBoLnJvdW5kID0gcm91bmQKICAgICAgcC51cGRhdGVSZW1vdGUoeyBwdW5jaGluZywgZmlyZXdhbGwsIGFkZHJlc3NlcywgdmVyaWZpZWQ6IGVjaG9lZCA/IHBlZXJBZGRyZXNzLmhvc3QgOiBudWxsIH0pCiAgICB9CgogICAgLy8gV2FpdCBmb3IgdGhlIGFuYWx5emVyIHRvIHJlYWNoIGEgY29uY2x1c2lvbi4uLgogICAgbGV0IHN0YWJsZSA9IGF3YWl0IHAuYW5hbHl6ZShmYWxzZSkKICAgIGlmIChwLmRlc3Ryb3llZCkgcmV0dXJuIG51bGwKCiAgICBpZiAoIXAucmVtb3RlSG9sZXB1bmNoaW5nICYmICFzdGFibGUpIHsKICAgICAgc3RhYmxlID0gYXdhaXQgcC5hbmFseXplKHRydWUpCiAgICAgIGlmIChwLmRlc3Ryb3llZCkgcmV0dXJuIG51bGwKICAgICAgaWYgKCFzdGFibGUpIHJldHVybiB0aGlzLl9hYm9ydChoKQogICAgfQoKICAgIC8vIEZhc3QgbW9kZSEgSWYgd2UgYXJlIGNvbnNpc3RlbnQgYW5kIHRoZSByZW1vdGUgaGFzIG9wZW5lZCBhIHNlc3Npb24gdG8gdXMgKHJlbW90ZUFkZHJlc3MpCiAgICAvLyB0aGVuIGZpcmUgYSBxdWljayBwdW5jaCBiYWNrLiBOb3RlIHRoZSBhd2FpdCBoZXJlIGp1c3Qgd2FpdHMgZm9yIHRoZSB1ZHAgc29ja2V0IHRvIGZsdXNoLgogICAgaWYgKAogICAgICBpc0NvbnNpc3RlbnQocC5uYXQuZmlyZXdhbGwpICYmCiAgICAgIHJlbW90ZUFkZHJlc3MgJiYKICAgICAgaGFzU2FtZUFkZHIocC5uYXQuYWRkcmVzc2VzLCByZW1vdGVBZGRyZXNzKQogICAgKSB7CiAgICAgIGF3YWl0IHAucGluZyhwZWVyQWRkcmVzcykKICAgICAgaWYgKHAuZGVzdHJveWVkKSByZXR1cm4gbnVsbAogICAgfQoKICAgIC8vIFJlbW90ZSBzYWlkIHRoZXkgYXJlIHB1bmNoaW5nIChvciB3aWxsaW5nIHRvKSwgc28gd2Ugd2lsbCBwdW5jaCBhcyB3ZWxsLgogICAgLy8gTm90ZSB0aGF0IHRoaXMgcmV0dXJucyB3aGVuIHRoZSBwdW5jaGluZyBoYXMgU1RBUlRFRCwgc28gbm8gZ3VhcmFudGVlCiAgICAvLyB3ZSB3aWxsIGhhdmUgYSBjb25uZWN0aW9uIGFmdGVyIHRoaXMgcHJvbWlzZSBldGMuCiAgICBpZiAocC5yZW1vdGVIb2xlcHVuY2hpbmcpIHsKICAgICAgLy8gVE9ETzogc3RpbGwgY29udGludWUgaGVyZSBpZiBhIGxvY2FsIGNvbm5lY3Rpb24gbWlnaHQgd29yaywgYnV0IHRoZW4gZG8gbm90IGhvbGVwdW5jaC4uLgogICAgICBpZiAoIXRoaXMuaG9sZXB1bmNoKHAucmVtb3RlRmlyZXdhbGwsIHAubmF0LmZpcmV3YWxsLCBwLnJlbW90ZUFkZHJlc3NlcywgcC5uYXQuYWRkcmVzc2VzKSkgewogICAgICAgIHJldHVybiBwLmRlc3Ryb3llZCA/IG51bGwgOiB0aGlzLl9hYm9ydChoKQogICAgICB9CgogICAgICBpZiAoaC5wcmVwdW5jaGluZykgewogICAgICAgIGNsZWFyVGltZW91dChoLnByZXB1bmNoaW5nKQogICAgICAgIGgucHJlcHVuY2hpbmcgPSBudWxsCiAgICAgIH0KCiAgICAgIGlmIChwLnJlbW90ZUZpcmV3YWxsID49IEZJUkVXQUxMLlJBTkRPTSB8fCBwLm5hdC5maXJld2FsbCA+PSBGSVJFV0FMTC5SQU5ET00pIHsKICAgICAgICBpZiAoCiAgICAgICAgICB0aGlzLmRodC5fcmFuZG9tUHVuY2hlcyA+PSB0aGlzLmRodC5fcmFuZG9tUHVuY2hMaW1pdCB8fAogICAgICAgICAgRGF0ZS5ub3coKSAtIHRoaXMuZGh0Ll9sYXN0UmFuZG9tUHVuY2ggPCB0aGlzLmRodC5fcmFuZG9tUHVuY2hJbnRlcnZhbAogICAgICAgICkgewogICAgICAgICAgaWYgKCFoLnJlbGF5VG9rZW4pIHJldHVybiB0aGlzLl9hYm9ydChoLCBFUlJPUi5UUllfTEFURVIpCiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzb2NrZXQ6IHAuc29ja2V0LAogICAgICAgICAgICBwYXlsb2FkOiBoLnBheWxvYWQuZW5jcnlwdCh7CiAgICAgICAgICAgICAgZXJyb3I6IEVSUk9SLlRSWV9MQVRFUiwKICAgICAgICAgICAgICBmaXJld2FsbDogcC5uYXQuZmlyZXdhbGwsCiAgICAgICAgICAgICAgcm91bmQ6IGgucm91bmQsCiAgICAgICAgICAgICAgY29ubmVjdGVkOiBwLmNvbm5lY3RlZCwKICAgICAgICAgICAgICBwdW5jaGluZzogcC5wdW5jaGluZywKICAgICAgICAgICAgICBhZGRyZXNzZXM6IHAubmF0LmFkZHJlc3NlcywKICAgICAgICAgICAgICByZW1vdGVBZGRyZXNzOiBudWxsLAogICAgICAgICAgICAgIHRva2VuOiBpc1NlcnZlclJlbGF5ID8gdG9rZW4gOiBudWxsLAogICAgICAgICAgICAgIHJlbW90ZVRva2VuOiByZW1vdGVQYXlsb2FkLnRva2VuCiAgICAgICAgICAgIH0pCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCBwdW5jaGluZyA9IGF3YWl0IHAucHVuY2goKQogICAgICBpZiAocC5kZXN0cm95ZWQpIHJldHVybiBudWxsCiAgICAgIGlmICghcHVuY2hpbmcpIHJldHVybiB0aGlzLl9hYm9ydChoKQogICAgfQoKICAgIC8vIEZyZWV6ZSB0aGF0IGFuYWx5c2lzIGFzIHNvb24gYXMgd2UgaGF2ZSBhIHJlc3VsdCB3ZSBhcmUgZ2l2aW5nIHRvIHRoZSBvdGhlciBwZWVyCiAgICBpZiAocC5uYXQuZmlyZXdhbGwgIT09IEZJUkVXQUxMLlVOS05PV04pIHsKICAgICAgcC5uYXQuZnJlZXplKCkKICAgIH0KCiAgICByZXR1cm4gewogICAgICBzb2NrZXQ6IHAuc29ja2V0LAogICAgICBwYXlsb2FkOiBoLnBheWxvYWQuZW5jcnlwdCh7CiAgICAgICAgZXJyb3I6IEVSUk9SLk5PTkUsCiAgICAgICAgZmlyZXdhbGw6IHAubmF0LmZpcmV3YWxsLAogICAgICAgIHJvdW5kOiBoLnJvdW5kLAogICAgICAgIGNvbm5lY3RlZDogcC5jb25uZWN0ZWQsCiAgICAgICAgcHVuY2hpbmc6IHAucHVuY2hpbmcsCiAgICAgICAgYWRkcmVzc2VzOiBwLm5hdC5hZGRyZXNzZXMsCiAgICAgICAgcmVtb3RlQWRkcmVzczogbnVsbCwKICAgICAgICB0b2tlbjogaXNTZXJ2ZXJSZWxheSA/IHRva2VuIDogbnVsbCwKICAgICAgICByZW1vdGVUb2tlbjogcmVtb3RlUGF5bG9hZC50b2tlbgogICAgICB9KQogICAgfQogIH0KCiAgX2Fib3J0KGgsIGVycm9yID0gRVJST1IuQUJPUlRFRCkgewogICAgaWYgKCFoLnBheWxvYWQpIHsKICAgICAgaWYgKGgucHVuY2hlcikgaC5wdW5jaGVyLmRlc3Ryb3koKQogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGNvbnN0IHBheWxvYWQgPSBoLnBheWxvYWQuZW5jcnlwdCh7CiAgICAgIGVycm9yLAogICAgICBmaXJld2FsbDogRklSRVdBTEwuVU5LTk9XTiwKICAgICAgcm91bmQ6IGgucm91bmQsCiAgICAgIGNvbm5lY3RlZDogZmFsc2UsCiAgICAgIHB1bmNoaW5nOiBmYWxzZSwKICAgICAgYWRkcmVzc2VzOiBudWxsLAogICAgICByZW1vdGVBZGRyZXNzOiBudWxsLAogICAgICB0b2tlbjogbnVsbCwKICAgICAgcmVtb3RlVG9rZW46IG51bGwKICAgIH0pCgogICAgaC5wdW5jaGVyLmRlc3Ryb3koKQoKICAgIHJldHVybiB7IHNvY2tldDogdGhpcy5kaHQuc29ja2V0LCBwYXlsb2FkIH0KICB9CgogIF9yZWxheUNvbm5lY3Rpb24oaHMsIHJlbGF5VGhyb3VnaCwgcmVtb3RlUGF5bG9hZCwgaCkgewogICAgdGhpcy5kaHQuc3RhdHMucmVsYXlpbmcuYXR0ZW1wdHMrKwoKICAgIGxldCBpc0luaXRpYXRvcgogICAgbGV0IHB1YmxpY0tleQogICAgbGV0IHRva2VuCgogICAgaWYgKHJlbGF5VGhyb3VnaCkgewogICAgICBpc0luaXRpYXRvciA9IHRydWUKICAgICAgcHVibGljS2V5ID0gcmVsYXlUaHJvdWdoCiAgICAgIHRva2VuID0gaHMucmVsYXlUb2tlbgogICAgfSBlbHNlIHsKICAgICAgaXNJbml0aWF0b3IgPSBmYWxzZQogICAgICBwdWJsaWNLZXkgPSByZW1vdGVQYXlsb2FkLnJlbGF5VGhyb3VnaC5wdWJsaWNLZXkKICAgICAgdG9rZW4gPSByZW1vdGVQYXlsb2FkLnJlbGF5VGhyb3VnaC50b2tlbgogICAgfQoKICAgIGhzLnJlbGF5VG9rZW4gPSB0b2tlbgogICAgaHMucmVsYXlTb2NrZXQgPSB0aGlzLmRodC5jb25uZWN0KHB1YmxpY0tleSkKICAgIGhzLnJlbGF5U29ja2V0LnNldEtlZXBBbGl2ZSh0aGlzLnJlbGF5S2VlcEFsaXZlKQogICAgaHMucmVsYXlDbGllbnQgPSByZWxheS5DbGllbnQuZnJvbShocy5yZWxheVNvY2tldCwgeyBpZDogaHMucmVsYXlTb2NrZXQucHVibGljS2V5IH0pCiAgICBocy5yZWxheVRpbWVvdXQgPSBzZXRUaW1lb3V0KG9uYWJvcnQsIDE1MDAwKQoKICAgIGhzLnJlbGF5Q2xpZW50CiAgICAgIC5wYWlyKGlzSW5pdGlhdG9yLCB0b2tlbiwgaHMucmF3U3RyZWFtKQogICAgICAub24oJ2Vycm9yJywgb25hYm9ydCkKICAgICAgLm9uKCdkYXRhJywgKHJlbW90ZUlkKSA9PiB7CiAgICAgICAgaWYgKGhzLnJlbGF5VGltZW91dCkgY2xlYXJSZWxheVRpbWVvdXQoaHMpCiAgICAgICAgaWYgKGhzLnJhd1N0cmVhbSA9PT0gbnVsbCkgewogICAgICAgICAgb25hYm9ydChudWxsKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQoKICAgICAgICBocy5yZWxheVBhaXJlZCA9IHRydWUKICAgICAgICB0aGlzLmRodC5zdGF0cy5yZWxheWluZy5zdWNjZXNzZXMrKwoKICAgICAgICBpZiAoaHMucHJlcHVuY2hpbmcpIGNsZWFyVGltZW91dChocy5wcmVwdW5jaGluZykKICAgICAgICBocy5wcmVwdW5jaGluZyA9IG51bGwKCiAgICAgICAgY29uc3QgeyByZW1vdGVQb3J0LCByZW1vdGVIb3N0LCBzb2NrZXQgfSA9IGhzLnJlbGF5U29ja2V0LnJhd1N0cmVhbQoKICAgICAgICBocy5yYXdTdHJlYW0KICAgICAgICAgIC5vbignY2xvc2UnLCAoKSA9PiBocy5yZWxheVNvY2tldC5kZXN0cm95KCkpCiAgICAgICAgICAuY29ubmVjdChzb2NrZXQsIHJlbW90ZUlkLCByZW1vdGVQb3J0LCByZW1vdGVIb3N0KQoKICAgICAgICBocy5lbmNyeXB0ZWRTb2NrZXQgPSB0aGlzLmNyZWF0ZVNlY3JldFN0cmVhbShmYWxzZSwgaHMucmF3U3RyZWFtLCB7IGhhbmRzaGFrZTogaCB9KQoKICAgICAgICB0aGlzLm9uY29ubmVjdGlvbihocy5lbmNyeXB0ZWRTb2NrZXQpCiAgICAgIH0pCgogICAgY29uc3QgZGh0ID0gdGhpcy5kaHQKICAgIGZ1bmN0aW9uIG9uYWJvcnQoKSB7CiAgICAgIGlmICghaHMucmVsYXlQYWlyZWQpIGRodC5zdGF0cy5yZWxheWluZy5hYm9ydHMrKwogICAgICBpZiAoaHMucmVsYXlUaW1lb3V0KSBjbGVhclJlbGF5VGltZW91dChocykKICAgICAgY29uc3Qgc29ja2V0ID0gaHMucmVsYXlTb2NrZXQKICAgICAgaHMucmVsYXlUb2tlbiA9IG51bGwKICAgICAgaHMucmVsYXlTb2NrZXQgPSBudWxsCiAgICAgIGlmIChzb2NrZXQpIHNvY2tldC5kZXN0cm95KCkKICAgICAgaWYgKGhzLmFib3J0ZWQgJiYgaHMucmF3U3RyZWFtKSBocy5yYXdTdHJlYW0uZGVzdHJveSgpCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBjbGVhclJlbGF5VGltZW91dChocykgewogIGNsZWFyVGltZW91dChocy5yZWxheVRpbWVvdXQpCiAgaHMucmVsYXlUaW1lb3V0ID0gbnVsbAp9CgpmdW5jdGlvbiBpc0NvbnNpc3RlbnQoZncpIHsKICByZXR1cm4gZncgPT09IEZJUkVXQUxMLk9QRU4gfHwgZncgPT09IEZJUkVXQUxMLkNPTlNJU1RFTlQKfQoKZnVuY3Rpb24gaGFzU2FtZUFkZHIoYWRkcnMsIG90aGVyKSB7CiAgaWYgKGFkZHJzID09PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgZm9yIChjb25zdCBhZGRyIG9mIGFkZHJzKSB7CiAgICBpZiAoYWRkci5wb3J0ID09PSBvdGhlci5wb3J0ICYmIGFkZHIuaG9zdCA9PT0gb3RoZXIuaG9zdCkgcmV0dXJuIHRydWUKICB9CiAgcmV0dXJuIGZhbHNlCn0KCmZ1bmN0aW9uIGRlZmF1bHRDcmVhdGVIYW5kc2hha2Uoa2V5UGFpciwgcmVtb3RlUHVibGljS2V5KSB7CiAgcmV0dXJuIG5ldyBOb2lzZVdyYXAoa2V5UGFpciwgcmVtb3RlUHVibGljS2V5KQp9CgpmdW5jdGlvbiBkZWZhdWx0Q3JlYXRlU2VjcmV0U3RyZWFtKGlzSW5pdGlhdG9yLCByYXdTdHJlYW0sIG9wdHMpIHsKICByZXR1cm4gbmV3IE5vaXNlU2VjcmV0U3RyZWFtKGlzSW5pdGlhdG9yLCByYXdTdHJlYW0sIG9wdHMpCn0KCmZ1bmN0aW9uIG9ubHlQcml2YXRlSG9zdHMoYWRkcikgewogIHJldHVybiBpc1ByaXZhdGUoYWRkci5ob3N0KQp9CgpmdW5jdGlvbiBpc1JlbGF5KHJlbGF5U29ja2V0LCBzb2NrZXQsIHBvcnQsIGhvc3QpIHsKICBjb25zdCBzdHJlYW0gPSByZWxheVNvY2tldC5yYXdTdHJlYW0KICBpZiAoIXN0cmVhbSkgcmV0dXJuIGZhbHNlCiAgaWYgKHN0cmVhbS5zb2NrZXQgIT09IHNvY2tldCkgcmV0dXJuIGZhbHNlCiAgcmV0dXJuIHBvcnQgPT09IHN0cmVhbS5yZW1vdGVQb3J0ICYmIGhvc3QgPT09IHN0cmVhbS5yZW1vdGVIb3N0Cn0KCmZ1bmN0aW9uIHNlbGVjdFJlbGF5KHJlbGF5VGhyb3VnaCkgewogIGlmICh0eXBlb2YgcmVsYXlUaHJvdWdoID09PSAnZnVuY3Rpb24nKSByZWxheVRocm91Z2ggPSByZWxheVRocm91Z2goKQogIGlmIChyZWxheVRocm91Z2ggPT09IG51bGwpIHJldHVybiBudWxsCiAgaWYgKEFycmF5LmlzQXJyYXkocmVsYXlUaHJvdWdoKSkgewogICAgcmV0dXJuIHJlbGF5VGhyb3VnaFtNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiByZWxheVRocm91Z2gubGVuZ3RoKV0KICB9CiAgcmV0dXJuIHJlbGF5VGhyb3VnaAp9CgpmdW5jdGlvbiBub29wKCkge30KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBTbGVlcGVyIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuX3RpbWVvdXQgPSBudWxsCiAgICB0aGlzLl9yZXNvbHZlID0gbnVsbAoKICAgIHRoaXMuX3N0YXJ0ID0gKHJlc29sdmUpID0+IHsKICAgICAgdGhpcy5fcmVzb2x2ZSA9IHJlc29sdmUKICAgIH0KCiAgICB0aGlzLl90cmlnZ2VyID0gKCkgPT4gewogICAgICBpZiAodGhpcy5fcmVzb2x2ZSA9PT0gbnVsbCkgcmV0dXJuCiAgICAgIGNvbnN0IHJlc29sdmUgPSB0aGlzLl9yZXNvbHZlCiAgICAgIHRoaXMuX3RpbWVvdXQgPSBudWxsCiAgICAgIHRoaXMuX3Jlc29sdmUgPSBudWxsCiAgICAgIHJlc29sdmUoKQogICAgfQogIH0KCiAgcGF1c2UobXMpIHsKICAgIGNvbnN0IHAgPSBuZXcgUHJvbWlzZSh0aGlzLl9zdGFydCkKICAgIGlmICh0aGlzLl90aW1lb3V0ICE9PSBudWxsKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lb3V0KQogICAgICB0aGlzLl90cmlnZ2VyKCkKICAgIH0KICAgIHRoaXMuX3RpbWVvdXQgPSBzZXRUaW1lb3V0KHRoaXMuX3RyaWdnZXIsIG1zKQogICAgcmV0dXJuIHAKICB9CgogIHJlc3VtZSgpIHsKICAgIGlmICh0aGlzLl90aW1lb3V0ICE9PSBudWxsKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lb3V0KQogICAgICB0aGlzLl90cmlnZ2VyKCkKICAgIH0KICB9Cn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IExJTkdFUl9USU1FID0gMzAwMAoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBTb2NrZXRQb29sIHsKICBjb25zdHJ1Y3RvcihkaHQsIGhvc3QpIHsKICAgIHRoaXMuX2RodCA9IGRodAogICAgdGhpcy5fc29ja2V0cyA9IG5ldyBNYXAoKQogICAgdGhpcy5fbGluZ2VyaW5nID0gbmV3IFNldCgpIC8vIHVwZGF0ZWQgYnkgdGhlIHJlZgogICAgdGhpcy5faG9zdCA9IGhvc3QKCiAgICB0aGlzLnJvdXRlcyA9IG5ldyBTb2NrZXRSb3V0ZXModGhpcykKICB9CgogIF9vbm1lc3NhZ2UocmVmLCBkYXRhLCBhZGRyZXNzKSB7CiAgICB0aGlzLl9kaHQub25tZXNzYWdlKHJlZi5zb2NrZXQsIGRhdGEsIGFkZHJlc3MpCiAgfQoKICBfYWRkKHJlZikgewogICAgdGhpcy5fc29ja2V0cy5zZXQocmVmLnNvY2tldCwgcmVmKQogIH0KCiAgX3JlbW92ZShyZWYpIHsKICAgIHRoaXMuX3NvY2tldHMuZGVsZXRlKHJlZi5zb2NrZXQpCiAgICB0aGlzLl9saW5nZXJpbmcuZGVsZXRlKHJlZikKICB9CgogIGxvb2t1cChzb2NrZXQpIHsKICAgIHJldHVybiB0aGlzLl9zb2NrZXRzLmdldChzb2NrZXQpIHx8IG51bGwKICB9CgogIHNldFJldXNhYmxlKHNvY2tldCwgYm9vbCkgewogICAgY29uc3QgcmVmID0gdGhpcy5sb29rdXAoc29ja2V0KQogICAgaWYgKHJlZikgcmVmLnJldXNhYmxlID0gYm9vbAogIH0KCiAgYWNxdWlyZSgpIHsKICAgIC8vIFRPRE86IEVuYWJsZSBzb2NrZXQgcmV1c2UKICAgIHJldHVybiBuZXcgU29ja2V0UmVmKHRoaXMpCiAgfQoKICBhc3luYyBkZXN0cm95KCkgewogICAgY29uc3QgY2xvc2luZyA9IFtdCgogICAgZm9yIChjb25zdCByZWYgb2YgdGhpcy5fc29ja2V0cy52YWx1ZXMoKSkgewogICAgICByZWYuX3VubGluZ2VyKCkKICAgICAgY2xvc2luZy5wdXNoKHJlZi5zb2NrZXQuY2xvc2UoKSkKICAgIH0KCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoY2xvc2luZykKICB9Cn0KCmNsYXNzIFNvY2tldFJvdXRlcyB7CiAgY29uc3RydWN0b3IocG9vbCkgewogICAgdGhpcy5fcG9vbCA9IHBvb2wKICAgIHRoaXMuX3JvdXRlcyA9IG5ldyBNYXAoKQogIH0KCiAgYWRkKHB1YmxpY0tleSwgcmF3U3RyZWFtKSB7CiAgICBpZiAocmF3U3RyZWFtLnNvY2tldCkgdGhpcy5fb25jb25uZWN0KHB1YmxpY0tleSwgcmF3U3RyZWFtKQogICAgZWxzZSByYXdTdHJlYW0ub24oJ2Nvbm5lY3QnLCB0aGlzLl9vbmNvbm5lY3QuYmluZCh0aGlzLCBwdWJsaWNLZXksIHJhd1N0cmVhbSkpCiAgfQoKICBnZXQocHVibGljS2V5KSB7CiAgICBjb25zdCBpZCA9IGI0YS50b1N0cmluZyhwdWJsaWNLZXksICdoZXgnKQogICAgY29uc3Qgcm91dGUgPSB0aGlzLl9yb3V0ZXMuZ2V0KGlkKQogICAgaWYgKCFyb3V0ZSkgcmV0dXJuIG51bGwKICAgIHJldHVybiByb3V0ZQogIH0KCiAgX29uY29ubmVjdChwdWJsaWNLZXksIHJhd1N0cmVhbSkgewogICAgY29uc3QgaWQgPSBiNGEudG9TdHJpbmcocHVibGljS2V5LCAnaGV4JykKICAgIGNvbnN0IHNvY2tldCA9IHJhd1N0cmVhbS5zb2NrZXQKCiAgICBsZXQgcm91dGUgPSB0aGlzLl9yb3V0ZXMuZ2V0KGlkKQoKICAgIGlmICghcm91dGUpIHsKICAgICAgY29uc3QgZ2MgPSAoKSA9PiB7CiAgICAgICAgaWYgKHRoaXMuX3JvdXRlcy5nZXQoaWQpID09PSByb3V0ZSkgdGhpcy5fcm91dGVzLmRlbGV0ZShpZCkKICAgICAgICBzb2NrZXQucmVtb3ZlTGlzdGVuZXIoJ2Nsb3NlJywgZ2MpCiAgICAgIH0KCiAgICAgIHJvdXRlID0gewogICAgICAgIHNvY2tldCwKICAgICAgICBhZGRyZXNzOiB7IGhvc3Q6IHJhd1N0cmVhbS5yZW1vdGVIb3N0LCBwb3J0OiByYXdTdHJlYW0ucmVtb3RlUG9ydCB9LAogICAgICAgIGdjCiAgICAgIH0KCiAgICAgIHRoaXMuX3JvdXRlcy5zZXQoaWQsIHJvdXRlKQogICAgICBzb2NrZXQub24oJ2Nsb3NlJywgZ2MpCiAgICB9CgogICAgdGhpcy5fcG9vbC5zZXRSZXVzYWJsZShzb2NrZXQsIHRydWUpCgogICAgcmF3U3RyZWFtLm9uKCdlcnJvcicsICgpID0+IHsKICAgICAgdGhpcy5fcG9vbC5zZXRSZXVzYWJsZShzb2NrZXQsIGZhbHNlKQogICAgICBpZiAoIXJvdXRlKSByb3V0ZSA9IHRoaXMuX3JvdXRlcy5nZXQoaWQpCiAgICAgIGlmIChyb3V0ZSAmJiByb3V0ZS5zb2NrZXQgPT09IHNvY2tldCkgcm91dGUuZ2MoKQogICAgfSkKICB9Cn0KCi8vIFRPRE86IHdlIHNob3VsZCBqdXN0IG1ha2Ugc29tZSAidXNlciBkYXRhIiBvYmplY3Qgb24gdWR4IHRvIGFsbG93IHRvIGF0dGFjaCB0aGlzIGluZm8KY2xhc3MgU29ja2V0UmVmIHsKICBjb25zdHJ1Y3Rvcihwb29sKSB7CiAgICB0aGlzLl9wb29sID0gcG9vbAoKICAgIC8vIEV2ZW50cwogICAgdGhpcy5vbmhvbGVwdW5jaG1lc3NhZ2UgPSBub29wCgogICAgLy8gV2hldGhlciBpdCBzaG91bGQgdGVhcmRvd24gaW1tZWRpYXRlbHkgb3Igd2FpdCBhIGJpdAogICAgdGhpcy5yZXVzYWJsZSA9IGZhbHNlCgogICAgdGhpcy5zb2NrZXQgPSBwb29sLl9kaHQudWR4LmNyZWF0ZVNvY2tldCgpCiAgICB0aGlzLnNvY2tldAogICAgICAub24oJ2Nsb3NlJywgdGhpcy5fb25jbG9zZS5iaW5kKHRoaXMpKQogICAgICAub24oJ21lc3NhZ2UnLCB0aGlzLl9vbm1lc3NhZ2UuYmluZCh0aGlzKSkKICAgICAgLm9uKCdpZGxlJywgdGhpcy5fb25pZGxlLmJpbmQodGhpcykpCiAgICAgIC5vbignYnVzeScsIHRoaXMuX29uYnVzeS5iaW5kKHRoaXMpKQogICAgICAuYmluZCgwLCB0aGlzLl9wb29sLl9ob3N0KQoKICAgIHRoaXMuX3JlZnMgPSAxCiAgICB0aGlzLl9yZWxlYXNlZCA9IGZhbHNlCiAgICB0aGlzLl9jbG9zZWQgPSBmYWxzZQoKICAgIHRoaXMuX3RpbWVvdXQgPSBudWxsCiAgICB0aGlzLl93YXNCdXN5ID0gZmFsc2UKCiAgICB0aGlzLl9wb29sLl9hZGQodGhpcykKICB9CgogIF9vbmNsb3NlKCkgewogICAgdGhpcy5fcG9vbC5fcmVtb3ZlKHRoaXMpCiAgfQoKICBfb25tZXNzYWdlKGRhdGEsIGFkZHJlc3MpIHsKICAgIGlmIChkYXRhLmJ5dGVMZW5ndGggPiAxKSB7CiAgICAgIHRoaXMuX3Bvb2wuX29ubWVzc2FnZSh0aGlzLCBkYXRhLCBhZGRyZXNzKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5vbmhvbGVwdW5jaG1lc3NhZ2UoZGF0YSwgYWRkcmVzcywgdGhpcykKICAgIH0KICB9CgogIF9vbmlkbGUoKSB7CiAgICB0aGlzLl9jbG9zZU1heWJlKCkKICB9CgogIF9vbmJ1c3koKSB7CiAgICB0aGlzLl93YXNCdXN5ID0gdHJ1ZQogICAgdGhpcy5fdW5saW5nZXIoKQogIH0KCiAgX3Jlc2V0KCkgewogICAgdGhpcy5vbmhvbGVwdW5jaG1lc3NhZ2UgPSBub29wCiAgfQoKICBfY2xvc2VNYXliZSgpIHsKICAgIGlmICh0aGlzLl9yZWZzID09PSAwICYmIHRoaXMuc29ja2V0LmlkbGUgJiYgIXRoaXMuX3RpbWVvdXQpIHRoaXMuX2Nsb3NlKCkKICB9CgogIF9saW5nZXJpbmdDbG9zZSgpIHsKICAgIHRoaXMuX3Bvb2wuX2xpbmdlcmluZy5kZWxldGUodGhpcykKICAgIHRoaXMuX3RpbWVvdXQgPSBudWxsCiAgICB0aGlzLl9jbG9zZU1heWJlKCkKICB9CgogIF9jbG9zZSgpIHsKICAgIHRoaXMuX3VubGluZ2VyKCkKCiAgICBpZiAodGhpcy5yZXVzYWJsZSAmJiB0aGlzLl93YXNCdXN5KSB7CiAgICAgIHRoaXMuX3dhc0J1c3kgPSBmYWxzZQogICAgICB0aGlzLl9wb29sLl9saW5nZXJpbmcuYWRkKHRoaXMpCiAgICAgIHRoaXMuX3RpbWVvdXQgPSBzZXRUaW1lb3V0KHRoaXMuX2xpbmdlcmluZ0Nsb3NlLmJpbmQodGhpcyksIExJTkdFUl9USU1FKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLl9jbG9zZWQgPSB0cnVlCiAgICB0aGlzLnNvY2tldC5jbG9zZSgpCiAgfQoKICBfdW5saW5nZXIoKSB7CiAgICBpZiAodGhpcy5fdGltZW91dCAhPT0gbnVsbCkgewogICAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZW91dCkKICAgICAgdGhpcy5fcG9vbC5fbGluZ2VyaW5nLmRlbGV0ZSh0aGlzKQogICAgICB0aGlzLl90aW1lb3V0ID0gbnVsbAogICAgfQogIH0KCiAgZ2V0IGZyZWUoKSB7CiAgICByZXR1cm4gdGhpcy5fcmVmcyA9PT0gMAogIH0KCiAgYWN0aXZlKCkgewogICAgdGhpcy5fcmVmcysrCiAgICB0aGlzLl91bmxpbmdlcigpCiAgfQoKICBpbmFjdGl2ZSgpIHsKICAgIHRoaXMuX3JlZnMtLQogICAgdGhpcy5fY2xvc2VNYXliZSgpCiAgfQoKICBhZGRyZXNzKCkgewogICAgcmV0dXJuIHRoaXMuc29ja2V0LmFkZHJlc3MoKQogIH0KCiAgcmVsZWFzZSgpIHsKICAgIGlmICh0aGlzLl9yZWxlYXNlZCkgcmV0dXJuCgogICAgdGhpcy5fcmVsZWFzZWQgPSB0cnVlCiAgICB0aGlzLl9yZXNldCgpCgogICAgdGhpcy5fcmVmcy0tCiAgICB0aGlzLl9jbG9zZU1heWJlKCkKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQp7CiAgIm5hbWUiOiAiaHlwZXJkaHQiLAogICJ2ZXJzaW9uIjogIjYuMjcuMSIsCiAgImRlc2NyaXB0aW9uIjogIlRoZSBESFQgcG93ZXJpbmcgSHlwZXJzd2FybSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJicm93c2VyIjogImJyb3dzZXIuanMiLAogICJiaW4iOiB7CiAgICAiaHlwZXJkaHQiOiAiLi9iaW4uanMiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImJyb3dzZXIuanMiLAogICAgInRlc3RuZXQuanMiLAogICAgImJpbi5qcyIsCiAgICAibGliLyoqLmpzIgogIF0sCiAgImltcG9ydHMiOiB7CiAgICAiZXZlbnRzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWV2ZW50cyIsCiAgICAgICJkZWZhdWx0IjogImV2ZW50cyIKICAgIH0sCiAgICAiY2hpbGRfcHJvY2VzcyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1ub2RlLWNoaWxkLXByb2Nlc3MiLAogICAgICAiZGVmYXVsdCI6ICJjaGlsZF9wcm9jZXNzIgogICAgfQogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtIjogIl42LjYuMiIsCiAgICAiYjRhIjogIl4xLjMuMSIsCiAgICAiYmFyZS1ldmVudHMiOiAiXjIuMi4wIiwKICAgICJibGluZC1yZWxheSI6ICJeMS4zLjAiLAogICAgImJvZ29uIjogIl4xLjAuMCIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi40LjEiLAogICAgImNvbXBhY3QtZW5jb2RpbmctbmV0IjogIl4xLjAuMSIsCiAgICAiZGh0LXJwYyI6ICJeNi4xNS4xIiwKICAgICJoeXBlcmNvcmUtY3J5cHRvIjogIl4zLjMuMCIsCiAgICAiaHlwZXJjb3JlLWlkLWVuY29kaW5nIjogIl4xLjIuMCIsCiAgICAibm9pc2UtY3VydmUtZWQiOiAiXjIuMC4wIiwKICAgICJub2lzZS1oYW5kc2hha2UiOiAiXjQuMC4wIiwKICAgICJyZWNvcmQtY2FjaGUiOiAiXjEuMS4xIiwKICAgICJzYWZldHktY2F0Y2giOiAiXjEuMC4xIiwKICAgICJzaWduYWwtcHJvbWlzZSI6ICJeMS4wLjMiLAogICAgInNvZGl1bS11bml2ZXJzYWwiOiAiXjUuMC4xIiwKICAgICJzdHJlYW14IjogIl4yLjE2LjEiLAogICAgInVuc2xhYiI6ICJeMS4zLjAiLAogICAgInhhY2hlIjogIl4xLjEuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1ub2RlLWNoaWxkLXByb2Nlc3MiOiAiXjEuMC4xIiwKICAgICJicml0dGxlIjogIl4zLjAuMCIsCiAgICAiZ3JhY2VmdWwtZ29vZGJ5ZSI6ICJeMS4zLjAiLAogICAgIm5ld2xpbmUtZGVjb2RlciI6ICJeMS4wLjIiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIiwKICAgICJ0ZXN0IjogInByZXR0aWVyIC0tY2hlY2sgLiAmJiBub2RlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDpnZW5lcmF0ZSI6ICJicml0dGxlIC1yIHRlc3QvYWxsLmpzIHRlc3QvKi5qcyIsCiAgICAiaW50ZWdyYXRpb24iOiAiYnJpdHRsZSB0ZXN0L2ludGVncmF0aW9uLyouanMiLAogICAgImVuZC10by1lbmQiOiAiYnJpdHRsZSB0ZXN0L2VuZC10by1lbmQvKi5qcyIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiZGlyZWN0b3JpZXMiOiB7CiAgICAibGliIjogImxpYiIsCiAgICAidGVzdCI6ICJ0ZXN0IgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyZGh0LmdpdCIKICB9LAogICJrZXl3b3JkcyI6IFtdLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJkaHQvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmRodCNyZWFkbWUiCn0KewogICJuYW1lIjogImh5cGVyc2NoZW1hIiwKICAidmVyc2lvbiI6ICIxLjE4LjAiLAogICJkZXNjcmlwdGlvbiI6ICJDcmVhdGUgcmVnaXN0cmllcyBvZiBkZWNsYXJhdGl2ZSBjb21wYWN0LWVuY29kaW5nIHNjaGVtYXMiLAogICJmaWxlcyI6IFsKICAgICJsaWIvKi5qcyIsCiAgICAiYnVpbGRlci5tanMiLAogICAgImJ1aWxkZXIuY2pzIiwKICAgICJydW50aW1lLm1qcyIsCiAgICAicnVudGltZS5janMiLAogICAgInByaW1pdGl2ZXMubWpzIiwKICAgICJwcmltaXRpdmVzLmNqcyIKICBdLAogICJleHBvcnRzIjogewogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLiI6IHsKICAgICAgImltcG9ydCI6ICIuL2J1aWxkZXIubWpzIiwKICAgICAgImRlZmF1bHQiOiAiLi9idWlsZGVyLmNqcyIKICAgIH0sCiAgICAiLi9ydW50aW1lIjogewogICAgICAiaW1wb3J0IjogIi4vcnVudGltZS5tanMiLAogICAgICAiZGVmYXVsdCI6ICIuL3J1bnRpbWUuY2pzIgogICAgfSwKICAgICIuL3ByaW1pdGl2ZXMiOiB7CiAgICAgICJpbXBvcnQiOiAiLi9wcmltaXRpdmVzLm1qcyIsCiAgICAgICJkZWZhdWx0IjogIi4vcHJpbWl0aXZlcy5janMiCiAgICB9CiAgfSwKICAiaW1wb3J0cyI6IHsKICAgICJmcyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1mcyIsCiAgICAgICJkZWZhdWx0IjogImZzIgogICAgfSwKICAgICJwYXRoIjogewogICAgICAiYmFyZSI6ICJiYXJlLXBhdGgiLAogICAgICAiZGVmYXVsdCI6ICJwYXRoIgogICAgfQogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC4gLS13cml0ZSIsCiAgICAidGVzdCI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYnJpdHRsZSB0ZXN0L2luZGV4LmpzIiwKICAgICJ0ZXN0OmJhcmUiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJhcmUgdGVzdC9pbmRleC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcnNjaGVtYS5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcnNjaGVtYS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyc2NoZW1hI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWZzIjogIl40LjAuMSIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xNS4wIiwKICAgICJnZW5lcmF0ZS1vYmplY3QtcHJvcGVydHkiOiAiXjIuMC4wIiwKICAgICJnZW5lcmF0ZS1zdHJpbmciOiAiXjEuMC4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjcuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4xLjAuMCIsCiAgICAidGVzdC10bXAiOiAiXjEuMy4wIgogIH0KfQptb2R1bGUuZXhwb3J0cyA9IHsKICBjOiByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKfQpjb25zdCB7IEV2ZW50RW1pdHRlciB9ID0gcmVxdWlyZSgnZXZlbnRzJykKY29uc3QgeyBnZXRTdHJlYW1FcnJvciB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IERIVCA9IHJlcXVpcmUoJ2h5cGVyZGh0JykKY29uc3Qgc3BxID0gcmVxdWlyZSgnc2h1ZmZsZWQtcHJpb3JpdHktcXVldWUnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCB1bnNsYWIgPSByZXF1aXJlKCd1bnNsYWInKQoKY29uc3QgUGVlckluZm8gPSByZXF1aXJlKCcuL2xpYi9wZWVyLWluZm8nKQpjb25zdCBSZXRyeVRpbWVyID0gcmVxdWlyZSgnLi9saWIvcmV0cnktdGltZXInKQpjb25zdCBDb25uZWN0aW9uU2V0ID0gcmVxdWlyZSgnLi9saWIvY29ubmVjdGlvbi1zZXQnKQpjb25zdCBQZWVyRGlzY292ZXJ5ID0gcmVxdWlyZSgnLi9saWIvcGVlci1kaXNjb3ZlcnknKQoKY29uc3QgTUFYX1BFRVJTID0gNjQKY29uc3QgTUFYX1BBUkFMTEVMID0gMwpjb25zdCBNQVhfQ0xJRU5UX0NPTk5FQ1RJT05TID0gSW5maW5pdHkgLy8gVE9ETzogQ2hhbmdlCmNvbnN0IE1BWF9TRVJWRVJfQ09OTkVDVElPTlMgPSBJbmZpbml0eQoKY29uc3QgRVJSX01JU1NJTkdfVE9QSUMgPSAnVG9waWMgaXMgcmVxdWlyZWQgYW5kIG11c3QgYmUgYSAzMi1ieXRlIGJ1ZmZlcicKY29uc3QgRVJSX0RFU1RST1lFRCA9ICdTd2FybSBoYXMgYmVlbiBkZXN0cm95ZWQnCmNvbnN0IEVSUl9EVVBMSUNBVEUgPSAnRHVwbGljYXRlIGNvbm5lY3Rpb24nCmNvbnN0IEVSUl9GSVJFV0FMTCA9ICdQZWVyIGlzIGZpcmV3YWxsZWQnCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEh5cGVyc3dhcm0gZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQogICAgY29uc3QgewogICAgICBzZWVkLAogICAgICByZWxheVRocm91Z2gsCiAgICAgIGtleVBhaXIgPSBESFQua2V5UGFpcihzZWVkKSwKICAgICAgbWF4UGVlcnMgPSBNQVhfUEVFUlMsCiAgICAgIG1heENsaWVudENvbm5lY3Rpb25zID0gTUFYX0NMSUVOVF9DT05ORUNUSU9OUywKICAgICAgbWF4U2VydmVyQ29ubmVjdGlvbnMgPSBNQVhfU0VSVkVSX0NPTk5FQ1RJT05TLAogICAgICBtYXhQYXJhbGxlbCA9IE1BWF9QQVJBTExFTCwKICAgICAgZmlyZXdhbGwgPSBhbGxvd0FsbAogICAgfSA9IG9wdHMKICAgIHRoaXMua2V5UGFpciA9IGtleVBhaXIKCiAgICB0aGlzLmRodCA9CiAgICAgIG9wdHMuZGh0IHx8CiAgICAgIG5ldyBESFQoewogICAgICAgIGJvb3RzdHJhcDogb3B0cy5ib290c3RyYXAsCiAgICAgICAgbm9kZXM6IG9wdHMubm9kZXMsCiAgICAgICAgcG9ydDogb3B0cy5wb3J0LAogICAgICAgIGRlZmVyUmFuZG9tUHVuY2g6IG9wdHMuZGVmZXJSYW5kb21QdW5jaCwKICAgICAgICByYW5kb21QdW5jaEludGVydmFsOiBvcHRzLnJhbmRvbVB1bmNoSW50ZXJ2YWwKICAgICAgfSkKICAgIHRoaXMuc2VydmVyID0gdGhpcy5kaHQuY3JlYXRlU2VydmVyKAogICAgICB7CiAgICAgICAgZmlyZXdhbGw6IHRoaXMuX2hhbmRsZUZpcmV3YWxsLmJpbmQodGhpcyksCiAgICAgICAgcmVsYXlUaHJvdWdoOiB0aGlzLl9tYXliZVJlbGF5Q29ubmVjdGlvbi5iaW5kKHRoaXMpLAogICAgICAgIGhhbmRzaGFrZUNsZWFyV2FpdDogb3B0cy5oYW5kc2hha2VDbGVhcldhaXQKICAgICAgfSwKICAgICAgdGhpcy5faGFuZGxlU2VydmVyQ29ubmVjdGlvbi5iaW5kKHRoaXMpCiAgICApCgogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgdGhpcy5tYXhQZWVycyA9IG1heFBlZXJzCiAgICB0aGlzLm1heENsaWVudENvbm5lY3Rpb25zID0gbWF4Q2xpZW50Q29ubmVjdGlvbnMKICAgIHRoaXMubWF4U2VydmVyQ29ubmVjdGlvbnMgPSBtYXhTZXJ2ZXJDb25uZWN0aW9ucwogICAgdGhpcy5tYXhQYXJhbGxlbCA9IG1heFBhcmFsbGVsCiAgICB0aGlzLnJlbGF5VGhyb3VnaCA9IHJlbGF5VGhyb3VnaCA/IHRvUmVsYXlGdW5jdGlvbihyZWxheVRocm91Z2gpIDogbnVsbAoKICAgIHRoaXMuY29ubmVjdGluZyA9IDAKICAgIHRoaXMuY29ubmVjdGlvbnMgPSBuZXcgU2V0KCkKICAgIHRoaXMucGVlcnMgPSBuZXcgTWFwKCkKICAgIHRoaXMuZXhwbGljaXRQZWVycyA9IG5ldyBTZXQoKQogICAgdGhpcy5saXN0ZW5pbmcgPSBudWxsCiAgICB0aGlzLnN0YXRzID0gewogICAgICB1cGRhdGVzOiAwLAogICAgICBjb25uZWN0czogewogICAgICAgIGNsaWVudDogewogICAgICAgICAgb3BlbmVkOiAwLAogICAgICAgICAgY2xvc2VkOiAwLAogICAgICAgICAgYXR0ZW1wdGVkOiAwCiAgICAgICAgfSwKICAgICAgICBzZXJ2ZXI6IHsKICAgICAgICAgIC8vIE5vdGU6IHRoZXJlIGlzIG5vIG5vdGlvbiBvZiAnYXR0ZW1wdHMnIGZvciBzZXJ2ZXIgY29ubmVjdGlvbnMKICAgICAgICAgIG9wZW5lZDogMCwKICAgICAgICAgIGNsb3NlZDogMAogICAgICAgIH0KICAgICAgfSwKICAgICAgYmFubmVkUGVlcnM6IDAKICAgIH0KCiAgICB0aGlzLl9kaXNjb3ZlcnkgPSBuZXcgTWFwKCkKICAgIHRoaXMuX3RpbWVyID0gbmV3IFJldHJ5VGltZXIodGhpcy5fcmVxdWV1ZS5iaW5kKHRoaXMpLCB7CiAgICAgIGJhY2tvZmZzOiBvcHRzLmJhY2tvZmZzLAogICAgICBqaXR0ZXI6IG9wdHMuaml0dGVyCiAgICB9KQogICAgdGhpcy5fcXVldWUgPSBzcHEoKQoKICAgIHRoaXMuX2FsbENvbm5lY3Rpb25zID0gbmV3IENvbm5lY3Rpb25TZXQoKQogICAgdGhpcy5fcGVuZGluZ0ZsdXNoZXMgPSBbXQogICAgdGhpcy5fZmx1c2hUaWNrID0gMAoKICAgIHRoaXMuX2RyYWluaW5nUXVldWUgPSBmYWxzZQogICAgdGhpcy5fY2xpZW50Q29ubmVjdGlvbnMgPSAwCiAgICB0aGlzLl9zZXJ2ZXJDb25uZWN0aW9ucyA9IDAKICAgIHRoaXMuX2ZpcmV3YWxsID0gZmlyZXdhbGwKCiAgICB0aGlzLmRodC5vbignbmV0d29yay1jaGFuZ2UnLCB0aGlzLl9oYW5kbGVOZXR3b3JrQ2hhbmdlLmJpbmQodGhpcykpCiAgICB0aGlzLmRodC5vbignbmV0d29yay11cGRhdGUnLCB0aGlzLl9oYW5kbGVOZXR3b3JrVXBkYXRlLmJpbmQodGhpcykpCiAgICB0aGlzLm9uKCd1cGRhdGUnLCB0aGlzLl9oYW5kbGVVcGRhdGUpCiAgfQoKICBfbWF5YmVSZWxheUNvbm5lY3Rpb24oZm9yY2UpIHsKICAgIGlmICghdGhpcy5yZWxheVRocm91Z2gpIHJldHVybiBudWxsCiAgICByZXR1cm4gdGhpcy5yZWxheVRocm91Z2goZm9yY2UsIHRoaXMpCiAgfQoKICBfZW5xdWV1ZShwZWVySW5mbykgewogICAgaWYgKHBlZXJJbmZvLnF1ZXVlZCkgcmV0dXJuCiAgICBwZWVySW5mby5xdWV1ZWQgPSB0cnVlCiAgICBwZWVySW5mby5fZmx1c2hUaWNrID0gdGhpcy5fZmx1c2hUaWNrCiAgICB0aGlzLl9xdWV1ZS5hZGQocGVlckluZm8pCgogICAgdGhpcy5fYXR0ZW1wdENsaWVudENvbm5lY3Rpb25zKCkKICB9CgogIF9yZXF1ZXVlKGJhdGNoKSB7CiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIHJldHVybgogICAgZm9yIChjb25zdCBwZWVySW5mbyBvZiBiYXRjaCkgewogICAgICBwZWVySW5mby53YWl0aW5nID0gZmFsc2UKCiAgICAgIGlmICgKICAgICAgICBwZWVySW5mby5fdXBkYXRlUHJpb3JpdHkoKSA9PT0gZmFsc2UgfHwKICAgICAgICB0aGlzLl9hbGxDb25uZWN0aW9ucy5oYXMocGVlckluZm8ucHVibGljS2V5KSB8fAogICAgICAgIHBlZXJJbmZvLnF1ZXVlZAogICAgICApCiAgICAgICAgY29udGludWUKICAgICAgcGVlckluZm8ucXVldWVkID0gdHJ1ZQogICAgICBwZWVySW5mby5fZmx1c2hUaWNrID0gdGhpcy5fZmx1c2hUaWNrCiAgICAgIHRoaXMuX3F1ZXVlLmFkZChwZWVySW5mbykKICAgIH0KCiAgICB0aGlzLl9hdHRlbXB0Q2xpZW50Q29ubmVjdGlvbnMoKQogIH0KCiAgX2ZsdXNoTWF5YmUocGVlckluZm8pIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fcGVuZGluZ0ZsdXNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgZmx1c2ggPSB0aGlzLl9wZW5kaW5nRmx1c2hlc1tpXQogICAgICBpZiAocGVlckluZm8uX2ZsdXNoVGljayA+IGZsdXNoLnRpY2spIGNvbnRpbnVlCiAgICAgIGlmICgtLWZsdXNoLm1pc3NpbmcgPiAwKSBjb250aW51ZQogICAgICBmbHVzaC5vbmZsdXNoKHRydWUpCiAgICAgIHRoaXMuX3BlbmRpbmdGbHVzaGVzLnNwbGljZShpLS0sIDEpCiAgICB9CiAgfQoKICBfZmx1c2hBbGxNYXliZSgpIHsKICAgIGlmICgKICAgICAgdGhpcy5jb25uZWN0aW5nID4gMCB8fAogICAgICAodGhpcy5fYWxsQ29ubmVjdGlvbnMuc2l6ZSA8IHRoaXMubWF4UGVlcnMgJiYKICAgICAgICB0aGlzLl9jbGllbnRDb25uZWN0aW9ucyA8IHRoaXMubWF4Q2xpZW50Q29ubmVjdGlvbnMpCiAgICApIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgd2hpbGUgKHRoaXMuX3BlbmRpbmdGbHVzaGVzLmxlbmd0aCkgewogICAgICBjb25zdCBmbHVzaCA9IHRoaXMuX3BlbmRpbmdGbHVzaGVzLnBvcCgpCiAgICAgIGZsdXNoLm9uZmx1c2godHJ1ZSkKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3Nob3VsZENvbm5lY3RFeHBsaWNpdCgpIHsKICAgIHJldHVybiAhdGhpcy5kZXN0cm95ZWQgJiYgIXRoaXMuc3VzcGVuZGVkICYmIHRoaXMuY29ubmVjdGluZyA8IHRoaXMubWF4UGFyYWxsZWwKICB9CgogIF9zaG91bGRDb25uZWN0KCkgewogICAgcmV0dXJuICgKICAgICAgIXRoaXMuZGVzdHJveWVkICYmCiAgICAgICF0aGlzLnN1c3BlbmRlZCAmJgogICAgICB0aGlzLmNvbm5lY3RpbmcgPCB0aGlzLm1heFBhcmFsbGVsICYmCiAgICAgIHRoaXMuX2FsbENvbm5lY3Rpb25zLnNpemUgPCB0aGlzLm1heFBlZXJzICYmCiAgICAgIHRoaXMuX2NsaWVudENvbm5lY3Rpb25zIDwgdGhpcy5tYXhDbGllbnRDb25uZWN0aW9ucwogICAgKQogIH0KCiAgX3Nob3VsZFJlcXVldWUocGVlckluZm8pIHsKICAgIGlmICh0aGlzLnN1c3BlbmRlZCkgcmV0dXJuIGZhbHNlCiAgICBpZiAocGVlckluZm8uZXhwbGljaXQpIHJldHVybiB0cnVlCiAgICBmb3IgKGNvbnN0IHRvcGljIG9mIHBlZXJJbmZvLnRvcGljcykgewogICAgICBpZiAodGhpcy5fZGlzY292ZXJ5LmhhcyhiNGEudG9TdHJpbmcodG9waWMsICdoZXgnKSkgJiYgIXRoaXMuZGVzdHJveWVkKSB7CiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBfY29ubmVjdChwZWVySW5mbywgcXVldWVkKSB7CiAgICBpZiAocGVlckluZm8uYmFubmVkIHx8IHRoaXMuX2FsbENvbm5lY3Rpb25zLmhhcyhwZWVySW5mby5wdWJsaWNLZXkpKSB7CiAgICAgIGlmIChxdWV1ZWQpIHRoaXMuX2ZsdXNoTWF5YmUocGVlckluZm8pCiAgICAgIHJldHVybgogICAgfQoKICAgIC8vIFRPRE86IFN1cHBvcnQgYXN5bmMgZmlyZXdhbGxpbmcgYXQgc29tZSBwb2ludC4KICAgIGlmICh0aGlzLl9oYW5kbGVGaXJld2FsbChwZWVySW5mby5wdWJsaWNLZXksIG51bGwpKSB7CiAgICAgIGlmIChxdWV1ZWQpIHRoaXMuX2ZsdXNoTWF5YmUocGVlckluZm8pCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IHJlbGF5VGhyb3VnaCA9IHRoaXMuX21heWJlUmVsYXlDb25uZWN0aW9uKHBlZXJJbmZvLmZvcmNlUmVsYXlpbmcpCiAgICBjb25zdCBjb25uID0gdGhpcy5kaHQuY29ubmVjdChwZWVySW5mby5wdWJsaWNLZXksIHsKICAgICAgcmVsYXlBZGRyZXNzZXM6IHBlZXJJbmZvLnJlbGF5QWRkcmVzc2VzLAogICAgICBrZXlQYWlyOiB0aGlzLmtleVBhaXIsCiAgICAgIHJlbGF5VGhyb3VnaAogICAgfSkKICAgIHRoaXMuX2FsbENvbm5lY3Rpb25zLmFkZChjb25uKQoKICAgIHRoaXMuc3RhdHMuY29ubmVjdHMuY2xpZW50LmF0dGVtcHRlZCsrCgogICAgdGhpcy5jb25uZWN0aW5nKysKICAgIHRoaXMuX2NsaWVudENvbm5lY3Rpb25zKysKICAgIGxldCBvcGVuZWQgPSBmYWxzZQoKICAgIGNvbnN0IG9uZXJyb3IgPSAoZXJyKSA9PiB7CiAgICAgIGlmICh0aGlzLnJlbGF5VGhyb3VnaCAmJiBzaG91bGRGb3JjZVJlbGF5aW5nKGVyci5jb2RlKSkgewogICAgICAgIHBlZXJJbmZvLmZvcmNlUmVsYXlpbmcgPSB0cnVlCiAgICAgICAgLy8gUmVzZXQgdGhlIGF0dGVtcHRzIGluIG9yZGVyIHRvIGZhc3QgY29ubmVjdCB0byByZWxheQogICAgICAgIHBlZXJJbmZvLmF0dGVtcHRzID0gMAogICAgICB9CiAgICB9CgogICAgLy8gUmVtb3ZlZCBvbmNlIGEgY29ubmVjdGlvbiBpcyBvcGVuZWQKICAgIGNvbm4ub24oJ2Vycm9yJywgb25lcnJvcikKCiAgICBjb25uLm9uKCdvcGVuJywgKCkgPT4gewogICAgICBvcGVuZWQgPSB0cnVlCiAgICAgIHRoaXMuc3RhdHMuY29ubmVjdHMuY2xpZW50Lm9wZW5lZCsrCgogICAgICB0aGlzLl9jb25uZWN0RG9uZSgpCiAgICAgIHRoaXMuY29ubmVjdGlvbnMuYWRkKGNvbm4pCiAgICAgIGNvbm4ucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgb25lcnJvcikKICAgICAgcGVlckluZm8uX2Nvbm5lY3RlZCgpCiAgICAgIHBlZXJJbmZvLmNsaWVudCA9IHRydWUKICAgICAgdGhpcy5lbWl0KCdjb25uZWN0aW9uJywgY29ubiwgcGVlckluZm8pCiAgICAgIGlmIChxdWV1ZWQpIHRoaXMuX2ZsdXNoTWF5YmUocGVlckluZm8pCgogICAgICB0aGlzLmVtaXQoJ3VwZGF0ZScpCiAgICB9KQogICAgY29ubi5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgIGlmICghb3BlbmVkKSB0aGlzLl9jb25uZWN0RG9uZSgpCiAgICAgIHRoaXMuc3RhdHMuY29ubmVjdHMuY2xpZW50LmNsb3NlZCsrCgogICAgICBjb25zdCBlcnIgPSBnZXRTdHJlYW1FcnJvcihjb25uKQogICAgICBpZiAoc2hvdWxkQmFuKGVycikpIHsKICAgICAgICB0aGlzLl9iYW5QZWVyKHBlZXJJbmZvLCB0cnVlLCBlcnIpCiAgICAgIH0KCiAgICAgIHRoaXMuY29ubmVjdGlvbnMuZGVsZXRlKGNvbm4pCiAgICAgIHRoaXMuX2FsbENvbm5lY3Rpb25zLmRlbGV0ZShjb25uKQogICAgICB0aGlzLl9jbGllbnRDb25uZWN0aW9ucy0tCiAgICAgIHBlZXJJbmZvLl9kaXNjb25uZWN0ZWQoKQoKICAgICAgcGVlckluZm8ud2FpdGluZyA9IHRoaXMuX3Nob3VsZFJlcXVldWUocGVlckluZm8pICYmIHRoaXMuX3RpbWVyLmFkZChwZWVySW5mbykKICAgICAgdGhpcy5fbWF5YmVEZWxldGVQZWVyKHBlZXJJbmZvKQoKICAgICAgaWYgKCFvcGVuZWQgJiYgcXVldWVkKSB0aGlzLl9mbHVzaE1heWJlKHBlZXJJbmZvKQoKICAgICAgdGhpcy5fYXR0ZW1wdENsaWVudENvbm5lY3Rpb25zKCkKCiAgICAgIHRoaXMuZW1pdCgndXBkYXRlJykKICAgIH0pCgogICAgdGhpcy5lbWl0KCd1cGRhdGUnKQogIH0KCiAgX2Nvbm5lY3REb25lKCkgewogICAgdGhpcy5jb25uZWN0aW5nLS0KCiAgICBpZiAodGhpcy5jb25uZWN0aW5nIDwgdGhpcy5tYXhQYXJhbGxlbCkgdGhpcy5fYXR0ZW1wdENsaWVudENvbm5lY3Rpb25zKCkKICAgIGlmICh0aGlzLmNvbm5lY3RpbmcgPT09IDApIHRoaXMuX2ZsdXNoQWxsTWF5YmUoKQogIH0KCiAgLy8gQ2FsbGVkIHdoZW4gdGhlIFBlZXJRdWV1ZSBpbmRpY2F0ZXMgYSBjb25uZWN0aW9uIHNob3VsZCBiZSBhdHRlbXB0ZWQuCiAgX2F0dGVtcHRDbGllbnRDb25uZWN0aW9ucygpIHsKICAgIC8vIEd1YXJkIGFnYWluc3QgcmUtZW50cmllcyAtIHVuc3VyZSBpZiBpdCBzdGlsbCBuZWVkZWQgYnV0IGRvZXNuJ3QgaHVydAogICAgaWYgKHRoaXMuX2RyYWluaW5nUXVldWUgfHwgdGhpcy5zdXNwZW5kZWQpIHJldHVybgogICAgdGhpcy5fZHJhaW5pbmdRdWV1ZSA9IHRydWUKCiAgICBmb3IgKGNvbnN0IHBlZXJJbmZvIG9mIHRoaXMuZXhwbGljaXRQZWVycykgewogICAgICBpZiAoIXRoaXMuX3Nob3VsZENvbm5lY3RFeHBsaWNpdCgpKSBicmVhawogICAgICBpZiAoCiAgICAgICAgcGVlckluZm8uYXR0ZW1wdHMgPj0gNSB8fAogICAgICAgIERhdGUubm93KCkgLSBwZWVySW5mby5kaXNjb25uZWN0ZWRUaW1lIDwgcGVlckluZm8uYXR0ZW1wdHMgKiAxMDAwCiAgICAgICkKICAgICAgICBjb250aW51ZQogICAgICB0aGlzLl9jb25uZWN0KHBlZXJJbmZvLCBmYWxzZSkKICAgIH0KCiAgICB3aGlsZSAodGhpcy5fcXVldWUubGVuZ3RoICYmIHRoaXMuX3Nob3VsZENvbm5lY3QoKSkgewogICAgICBjb25zdCBwZWVySW5mbyA9IHRoaXMuX3F1ZXVlLnNoaWZ0KCkKICAgICAgcGVlckluZm8ucXVldWVkID0gZmFsc2UKICAgICAgdGhpcy5fY29ubmVjdChwZWVySW5mbywgdHJ1ZSkKICAgIH0KICAgIHRoaXMuX2RyYWluaW5nUXVldWUgPSBmYWxzZQogICAgaWYgKHRoaXMuY29ubmVjdGluZyA9PT0gMCkgdGhpcy5fZmx1c2hBbGxNYXliZSgpCiAgfQoKICBfaGFuZGxlRmlyZXdhbGwocmVtb3RlUHVibGljS2V5LCBwYXlsb2FkKSB7CiAgICBpZiAoYjRhLmVxdWFscyhyZW1vdGVQdWJsaWNLZXksIHRoaXMua2V5UGFpci5wdWJsaWNLZXkpKSByZXR1cm4gdHJ1ZQoKICAgIGxldCBwZWVySW5mbyA9IHRoaXMucGVlcnMuZ2V0KGI0YS50b1N0cmluZyhyZW1vdGVQdWJsaWNLZXksICdoZXgnKSkKICAgIGlmIChwZWVySW5mbyAmJiBwZWVySW5mby5iYW5uZWQpIHJldHVybiB0cnVlCgogICAgY29uc3QgZmlyZXdhbGxlZCA9IHRoaXMuX2ZpcmV3YWxsKHJlbW90ZVB1YmxpY0tleSwgcGF5bG9hZCkKICAgIGlmIChmaXJld2FsbGVkKSB7CiAgICAgIGlmICghcGVlckluZm8pIHBlZXJJbmZvID0gdGhpcy5fdXBzZXJ0UGVlcihyZW1vdGVQdWJsaWNLZXkpCiAgICAgIHRoaXMuX2JhblBlZXIocGVlckluZm8sIHRydWUsIG5ldyBFcnJvcihFUlJfRklSRVdBTEwpKQogICAgfQoKICAgIHJldHVybiBmaXJld2FsbGVkCiAgfQoKICBfaGFuZGxlU2VydmVyQ29ubmVjdGlvblN3YXAoZXhpc3RpbmcsIGNvbm4pIHsKICAgIGxldCBjbG9zZWQgPSBmYWxzZQoKICAgIGV4aXN0aW5nLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgaWYgKGNsb3NlZCkgcmV0dXJuCgogICAgICBjb25uLnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIG5vb3ApCiAgICAgIGNvbm4ucmVtb3ZlTGlzdGVuZXIoJ2Nsb3NlJywgb25jbG9zZSkKCiAgICAgIHRoaXMuX2hhbmRsZVNlcnZlckNvbm5lY3Rpb24oY29ubikKICAgIH0pCgogICAgY29ubi5vbignZXJyb3InLCBub29wKQogICAgY29ubi5vbignY2xvc2UnLCBvbmNsb3NlKQoKICAgIGZ1bmN0aW9uIG9uY2xvc2UoKSB7CiAgICAgIGNsb3NlZCA9IHRydWUKICAgIH0KICB9CgogIC8vIENhbGxlZCB3aGVuIHRoZSBESFQgcmVjZWl2ZXMgYSBuZXcgc2VydmVyIGNvbm5lY3Rpb24uCiAgX2hhbmRsZVNlcnZlckNvbm5lY3Rpb24oY29ubikgewogICAgaWYgKHRoaXMuZGVzdHJveWVkIHx8IHRoaXMuc3VzcGVuZGVkKSB7CiAgICAgIC8vIFRPRE86IEludmVzdGlnYXRlIHdoeSBhIGZpbmFsIHNlcnZlciBjb25uZWN0aW9uIGNhbiBiZSByZWNlaXZlZCBhZnRlciBjbG9zZQogICAgICBjb25uLm9uKCdlcnJvcicsIG5vb3ApCiAgICAgIHJldHVybiBjb25uLmRlc3Ryb3koRVJSX0RFU1RST1lFRCkKICAgIH0KCiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuX2FsbENvbm5lY3Rpb25zLmdldChjb25uLnJlbW90ZVB1YmxpY0tleSkKCiAgICBpZiAoZXhpc3RpbmcpIHsKICAgICAgLy8gSWYgYm90aCBjb25uZWN0aW9ucyBhcmUgZnJvbSB0aGUgc2FtZSBwZWVyLAogICAgICAvLyAtIHBpY2sgdGhlIG5ldyBvbmUgaWYgdGhlIGV4aXN0aW5nIHN0cmVhbSBpcyBhbHJlYWR5IGVzdGFibGlzaGVkIChoYXMgc2VudCBhbmQgcmVjZWl2ZWQgYnl0ZXMpLAogICAgICAvLyAgIGJlY2F1c2UgdGhlIG90aGVyIGNsaWVudCBtdXN0IGhhdmUgbG9zdCB0aGF0IGNvbm5lY3Rpb24gYW5kIGJlIHJlY29ubmVjdGluZwogICAgICAvLyAtIG90aGVyd2lzZSwgcGljayB0aGUgb25lIHRoYXRzIGV4cGVjdGVkIHRvIGluaXRpYXRlIGluIGEgdGllIGJyZWFrCiAgICAgIGNvbnN0IGV4aXN0aW5nSXNPdXRkYXRlZCA9IGV4aXN0aW5nLnJhd0J5dGVzUmVhZCA+IDAgJiYgZXhpc3RpbmcucmF3Qnl0ZXNXcml0dGVuID4gMAogICAgICBjb25zdCBleHBlY3RlZEluaXRpYXRvciA9IGI0YS5jb21wYXJlKGNvbm4ucHVibGljS2V5LCBjb25uLnJlbW90ZVB1YmxpY0tleSkgPiAwCiAgICAgIGNvbnN0IGtlZXBOZXcgPSBleGlzdGluZ0lzT3V0ZGF0ZWQgfHwgZXhwZWN0ZWRJbml0aWF0b3IgPT09IGNvbm4uaXNJbml0aWF0b3IKCiAgICAgIGlmIChrZWVwTmV3ID09PSBmYWxzZSkgewogICAgICAgIGV4aXN0aW5nLnNlbmRLZWVwQWxpdmUoKQogICAgICAgIGNvbm4ub24oJ2Vycm9yJywgbm9vcCkKICAgICAgICBjb25uLmRlc3Ryb3kobmV3IEVycm9yKEVSUl9EVVBMSUNBVEUpKQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICBleGlzdGluZy5vbignZXJyb3InLCBub29wKQogICAgICBleGlzdGluZy5kZXN0cm95KG5ldyBFcnJvcihFUlJfRFVQTElDQVRFKSkKICAgICAgdGhpcy5faGFuZGxlU2VydmVyQ29ubmVjdGlvblN3YXAoZXhpc3RpbmcsIGNvbm4pCiAgICAgIHJldHVybgogICAgfQoKICAgIC8vIFdoZW4gcmVhY2hpbmcgaGVyZSwgdGhlIGNvbm5lY3Rpb24gd2lsbCBhbHdheXMgYmUgJ29wZW5lZCcgbmV4dCB0aWNrCiAgICB0aGlzLnN0YXRzLmNvbm5lY3RzLnNlcnZlci5vcGVuZWQrKwoKICAgIGNvbnN0IHBlZXJJbmZvID0gdGhpcy5fdXBzZXJ0UGVlcihjb25uLnJlbW90ZVB1YmxpY0tleSwgbnVsbCkKCiAgICB0aGlzLmNvbm5lY3Rpb25zLmFkZChjb25uKQogICAgdGhpcy5fYWxsQ29ubmVjdGlvbnMuYWRkKGNvbm4pCiAgICB0aGlzLl9zZXJ2ZXJDb25uZWN0aW9ucysrCgogICAgY29ubi5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgIGNvbnN0IGVyciA9IGdldFN0cmVhbUVycm9yKGNvbm4pCiAgICAgIGlmIChzaG91bGRCYW4oZXJyKSkgewogICAgICAgIHRoaXMuX2JhblBlZXIocGVlckluZm8sIHRydWUsIGVycikKICAgICAgfQoKICAgICAgdGhpcy5jb25uZWN0aW9ucy5kZWxldGUoY29ubikKICAgICAgdGhpcy5fYWxsQ29ubmVjdGlvbnMuZGVsZXRlKGNvbm4pCiAgICAgIHRoaXMuX3NlcnZlckNvbm5lY3Rpb25zLS0KICAgICAgdGhpcy5zdGF0cy5jb25uZWN0cy5zZXJ2ZXIuY2xvc2VkKysKCiAgICAgIHRoaXMuX21heWJlRGVsZXRlUGVlcihwZWVySW5mbykKCiAgICAgIHRoaXMuX2F0dGVtcHRDbGllbnRDb25uZWN0aW9ucygpCgogICAgICB0aGlzLmVtaXQoJ3VwZGF0ZScpCiAgICB9KQogICAgcGVlckluZm8uY2xpZW50ID0gZmFsc2UKICAgIHRoaXMuZW1pdCgnY29ubmVjdGlvbicsIGNvbm4sIHBlZXJJbmZvKQoKICAgIHRoaXMuZW1pdCgndXBkYXRlJykKICB9CgogIF91cHNlcnRQZWVyKHB1YmxpY0tleSwgcmVsYXlBZGRyZXNzZXMpIHsKICAgIGlmIChiNGEuZXF1YWxzKHB1YmxpY0tleSwgdGhpcy5rZXlQYWlyLnB1YmxpY0tleSkpIHJldHVybiBudWxsCiAgICBjb25zdCBrZXlTdHJpbmcgPSBiNGEudG9TdHJpbmcocHVibGljS2V5LCAnaGV4JykKICAgIGxldCBwZWVySW5mbyA9IHRoaXMucGVlcnMuZ2V0KGtleVN0cmluZykKCiAgICBpZiAocGVlckluZm8pIHsKICAgICAgcGVlckluZm8ucmVsYXlBZGRyZXNzZXMgPSByZWxheUFkZHJlc3NlcyAvLyBuZXcgaXMgYWx3YXlzIGJldHRlcgogICAgICByZXR1cm4gcGVlckluZm8KICAgIH0KCiAgICBwZWVySW5mbyA9IG5ldyBQZWVySW5mbyh7CiAgICAgIHB1YmxpY0tleSwKICAgICAgcmVsYXlBZGRyZXNzZXMKICAgIH0pCgogICAgdGhpcy5wZWVycy5zZXQoa2V5U3RyaW5nLCBwZWVySW5mbykKICAgIHJldHVybiBwZWVySW5mbwogIH0KCiAgX2hhbmRsZVVwZGF0ZSgpIHsKICAgIHRoaXMuc3RhdHMudXBkYXRlcysrCiAgfQoKICBfbWF5YmVEZWxldGVQZWVyKHBlZXJJbmZvKSB7CiAgICBpZiAoIXBlZXJJbmZvLnNob3VsZEdDKCkpIHJldHVybgoKICAgIGNvbnN0IGhhc0FjdGl2ZUNvbm4gPSB0aGlzLl9hbGxDb25uZWN0aW9ucy5oYXMocGVlckluZm8ucHVibGljS2V5KQogICAgaWYgKGhhc0FjdGl2ZUNvbm4pIHJldHVybgoKICAgIGNvbnN0IGtleVN0cmluZyA9IGI0YS50b1N0cmluZyhwZWVySW5mby5wdWJsaWNLZXksICdoZXgnKQogICAgdGhpcy5wZWVycy5kZWxldGUoa2V5U3RyaW5nKQogIH0KCiAgLyoKICAgKiBDYWxsZWQgd2hlbiBhIHBlZXIgaXMgYWN0aXZlbHkgZGlzY292ZXJlZCBkdXJpbmcgYSBsb29rdXAuCiAgICoKICAgKiBUaHJlZSBjb25kaXRpb25zOgogICAqICAxLiBOb3QgYSBrbm93biBwZWVyIC0tIGluc2VydCBpbnRvIHF1ZXVlCiAgICogIDIuIEEga25vd24gcGVlciB3aXRoIG5vcm1hbCBwcmlvcml0eSAtLSBkbyBub3RoaW5nCiAgICogIDMuIEEga25vd24gcGVlciB3aXRoIGxvdyBwcmlvcml0eSAtLSBidW1wIHByaW9yaXR5LCBiZWNhdXNlIGl0J3MgYmVlbiByZWRpc2NvdmVyZWQKICAgKi8KICBfaGFuZGxlUGVlcihwZWVyLCB0b3BpYykgewogICAgY29uc3QgcGVlckluZm8gPSB0aGlzLl91cHNlcnRQZWVyKHBlZXIucHVibGljS2V5LCBwZWVyLnJlbGF5QWRkcmVzc2VzKQogICAgaWYgKHBlZXJJbmZvKSBwZWVySW5mby5fdG9waWModG9waWMpCiAgICBpZiAoIXBlZXJJbmZvIHx8IHRoaXMuX2FsbENvbm5lY3Rpb25zLmhhcyhwZWVyLnB1YmxpY0tleSkpIHJldHVybgogICAgaWYgKCFwZWVySW5mby5wcmlvcml0aXplZCB8fCBwZWVySW5mby5zZXJ2ZXIpIHBlZXJJbmZvLl9yZXNldCgpCiAgICBpZiAocGVlckluZm8uX3VwZGF0ZVByaW9yaXR5KCkpIHsKICAgICAgdGhpcy5fZW5xdWV1ZShwZWVySW5mbykKICAgIH0KICB9CgogIGFzeW5jIF9oYW5kbGVOZXR3b3JrVXBkYXRlKCkgewogICAgaWYgKCF0aGlzLm9ubGluZSkgcmV0dXJuCiAgICB0aGlzLl9oYW5kbGVOZXR3b3JrQ2hhbmdlKCkKICB9CgogIGFzeW5jIF9oYW5kbGVOZXR3b3JrQ2hhbmdlKCkgewogICAgaWYgKHRoaXMuc3VzcGVuZGVkKSByZXR1cm4KCiAgICAvLyBwcmlvcml0aXplIGZpZ3VyaW5nIG91dCBpZiBleGlzdGluZyBjb25uZWN0aW9ucyBhcmUgZGVhZAogICAgZm9yIChjb25zdCBjb25uIG9mIHRoaXMuX2FsbENvbm5lY3Rpb25zKSB7CiAgICAgIGNvbm4uc2VuZEtlZXBBbGl2ZSgpCiAgICB9CgogICAgY29uc3QgcmVmcmVzaGVzID0gW10KCiAgICBmb3IgKGNvbnN0IGRpc2NvdmVyeSBvZiB0aGlzLl9kaXNjb3ZlcnkudmFsdWVzKCkpIHsKICAgICAgcmVmcmVzaGVzLnB1c2goZGlzY292ZXJ5LnJlZnJlc2goKSkKICAgIH0KCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQocmVmcmVzaGVzKQogIH0KCiAgX2JhblBlZXIocGVlckluZm8sIGJhbm5lZCwgZXJyKSB7CiAgICBwZWVySW5mby5iYW4oYmFubmVkKQogICAgdGhpcy5zdGF0cy5iYW5uZWRQZWVycysrCiAgICB0aGlzLmVtaXQoJ2JhbicsIHBlZXJJbmZvLCBlcnIpCiAgfQoKICBzdGF0dXMoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5fZGlzY292ZXJ5LmdldChiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykpIHx8IG51bGwKICB9CgogIGxpc3RlbigpIHsKICAgIGlmICghdGhpcy5saXN0ZW5pbmcpIHsKICAgICAgaWYgKHRoaXMuZGVzdHJveWVkKSB0aHJvdyBuZXcgRXJyb3IoJ1N3YXJtIGRlc3Ryb3llZCcpCiAgICAgIHRoaXMubGlzdGVuaW5nID0gdGhpcy5zZXJ2ZXIubGlzdGVuKHRoaXMua2V5UGFpcikKICAgIH0KICAgIHJldHVybiB0aGlzLmxpc3RlbmluZwogIH0KCiAgLy8gT2JqZWN0IHRoYXQgZXhwb3NlcyBhIGNhbmNlbGxhdGlvbiBtZXRob2QgKGRlc3Ryb3kpCiAgLy8gVE9ETzogV2hlbiB5b3UgcmVqb2luLCBpdCBzaG91bGQgcmVhbm5vdW5jZSArIGJ1bXAgbG9va3VwIHByaW9yaXR5CiAgam9pbih0b3BpYywgb3B0cyA9IHt9KSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcignU3dhcm0gZGVzdHJveWVkJykKICAgIGlmICghdG9waWMpIHRocm93IG5ldyBFcnJvcihFUlJfTUlTU0lOR19UT1BJQykKICAgIHRvcGljID0gdW5zbGFiKHRvcGljKQoKICAgIGNvbnN0IHRvcGljU3RyaW5nID0gYjRhLnRvU3RyaW5nKHRvcGljLCAnaGV4JykKCiAgICBsZXQgZGlzY292ZXJ5ID0gdGhpcy5fZGlzY292ZXJ5LmdldCh0b3BpY1N0cmluZykKCiAgICBpZiAoZGlzY292ZXJ5ICYmICFkaXNjb3ZlcnkuZGVzdHJveWVkKSB7CiAgICAgIHJldHVybiBkaXNjb3Zlcnkuc2Vzc2lvbihvcHRzKQogICAgfQoKICAgIGRpc2NvdmVyeSA9IG5ldyBQZWVyRGlzY292ZXJ5KHRoaXMsIHRvcGljLCB7CiAgICAgIGxpbWl0OiBvcHRzLmxpbWl0LAogICAgICB3YWl0OiBkaXNjb3ZlcnkgPyBkaXNjb3ZlcnkuZGVzdHJveSgpIDogbnVsbCwKICAgICAgc3VzcGVuZGVkOiB0aGlzLnN1c3BlbmRlZCwKICAgICAgb25wZWVyOiAocGVlcikgPT4gdGhpcy5faGFuZGxlUGVlcihwZWVyLCB0b3BpYykKICAgIH0pCiAgICB0aGlzLl9kaXNjb3Zlcnkuc2V0KHRvcGljU3RyaW5nLCBkaXNjb3ZlcnkpCiAgICByZXR1cm4gZGlzY292ZXJ5LnNlc3Npb24ob3B0cykKICB9CgogIC8vIFJldHVybnMgYSBwcm9taXNlCiAgYXN5bmMgbGVhdmUodG9waWMpIHsKICAgIGlmICghdG9waWMpIHRocm93IG5ldyBFcnJvcihFUlJfTUlTU0lOR19UT1BJQykKICAgIGNvbnN0IHRvcGljU3RyaW5nID0gYjRhLnRvU3RyaW5nKHRvcGljLCAnaGV4JykKICAgIGlmICghdGhpcy5fZGlzY292ZXJ5Lmhhcyh0b3BpY1N0cmluZykpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQoKICAgIGNvbnN0IGRpc2NvdmVyeSA9IHRoaXMuX2Rpc2NvdmVyeS5nZXQodG9waWNTdHJpbmcpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgZGlzY292ZXJ5LmRlc3Ryb3koKQogICAgfSBjYXRjaCB7CiAgICAgIC8vIGlnbm9yZSwgcHJvcCBuZXR3b3JrCiAgICB9CgogICAgaWYgKHRoaXMuX2Rpc2NvdmVyeS5nZXQodG9waWNTdHJpbmcpID09PSBkaXNjb3ZlcnkpIHsKICAgICAgdGhpcy5fZGlzY292ZXJ5LmRlbGV0ZSh0b3BpY1N0cmluZykKICAgIH0KICB9CgogIGpvaW5QZWVyKHB1YmxpY0tleSkgewogICAgY29uc3QgcGVlckluZm8gPSB0aGlzLl91cHNlcnRQZWVyKHB1YmxpY0tleSwgbnVsbCkKICAgIGlmICghcGVlckluZm8pIHJldHVybgogICAgaWYgKCF0aGlzLmV4cGxpY2l0UGVlcnMuaGFzKHBlZXJJbmZvKSkgewogICAgICBwZWVySW5mby5leHBsaWNpdCA9IHRydWUKICAgICAgdGhpcy5leHBsaWNpdFBlZXJzLmFkZChwZWVySW5mbykKICAgIH0KICAgIGlmICh0aGlzLl9hbGxDb25uZWN0aW9ucy5oYXMocHVibGljS2V5KSkgcmV0dXJuCiAgICBpZiAocGVlckluZm8uX3VwZGF0ZVByaW9yaXR5KCkpIHsKICAgICAgdGhpcy5fZW5xdWV1ZShwZWVySW5mbykKICAgIH0KICB9CgogIGxlYXZlUGVlcihwdWJsaWNLZXkpIHsKICAgIGNvbnN0IGtleVN0cmluZyA9IGI0YS50b1N0cmluZyhwdWJsaWNLZXksICdoZXgnKQogICAgaWYgKCF0aGlzLnBlZXJzLmhhcyhrZXlTdHJpbmcpKSByZXR1cm4KCiAgICBjb25zdCBwZWVySW5mbyA9IHRoaXMucGVlcnMuZ2V0KGtleVN0cmluZykKICAgIHBlZXJJbmZvLmV4cGxpY2l0ID0gZmFsc2UKICAgIHRoaXMuZXhwbGljaXRQZWVycy5kZWxldGUocGVlckluZm8pCiAgICB0aGlzLl9tYXliZURlbGV0ZVBlZXIocGVlckluZm8pCiAgfQoKICAvLyBSZXR1cm5zIGEgcHJvbWlzZQogIGFzeW5jIGZsdXNoKCkgewogICAgY29uc3QgYWxsRmx1c2hlZCA9IFsuLi50aGlzLl9kaXNjb3ZlcnkudmFsdWVzKCldLm1hcCgodikgPT4gdi5mbHVzaGVkKCkpCiAgICBhd2FpdCBQcm9taXNlLmFsbChhbGxGbHVzaGVkKQogICAgaWYgKHRoaXMuX2ZsdXNoQWxsTWF5YmUoKSkgcmV0dXJuIHRydWUKICAgIGNvbnN0IHBlbmRpbmdTaXplID0gdGhpcy5fYWxsQ29ubmVjdGlvbnMuc2l6ZSAtIHRoaXMuY29ubmVjdGlvbnMuc2l6ZQogICAgaWYgKCF0aGlzLl9xdWV1ZS5sZW5ndGggJiYgIXBlbmRpbmdTaXplKSByZXR1cm4gdHJ1ZQogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgIHRoaXMuX3BlbmRpbmdGbHVzaGVzLnB1c2goewogICAgICAgIG9uZmx1c2g6IHJlc29sdmUsCiAgICAgICAgbWlzc2luZzogdGhpcy5fcXVldWUubGVuZ3RoICsgcGVuZGluZ1NpemUsCiAgICAgICAgdGljazogdGhpcy5fZmx1c2hUaWNrKysKICAgICAgfSkKICAgIH0pCiAgfQoKICBhc3luYyBjbGVhcigpIHsKICAgIGNvbnN0IGNsZWFyZWQgPSBQcm9taXNlLmFsbFNldHRsZWQoWy4uLnRoaXMuX2Rpc2NvdmVyeS52YWx1ZXMoKV0ubWFwKChkKSA9PiBkLmRlc3Ryb3koKSkpCiAgICB0aGlzLl9kaXNjb3ZlcnkuY2xlYXIoKQogICAgcmV0dXJuIGNsZWFyZWQKICB9CgogIGFzeW5jIGRlc3Ryb3koeyBmb3JjZSB9ID0ge30pIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCAmJiAhZm9yY2UpIHJldHVybgogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCgogICAgdGhpcy5fdGltZXIuZGVzdHJveSgpCgogICAgaWYgKCFmb3JjZSkgYXdhaXQgdGhpcy5jbGVhcigpCgogICAgYXdhaXQgdGhpcy5zZXJ2ZXIuY2xvc2UoKQoKICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nRmx1c2hlcy5sZW5ndGgpIHsKICAgICAgY29uc3QgZmx1c2ggPSB0aGlzLl9wZW5kaW5nRmx1c2hlcy5wb3AoKQogICAgICBmbHVzaC5vbmZsdXNoKGZhbHNlKQogICAgfQoKICAgIGF3YWl0IHRoaXMuZGh0LmRlc3Ryb3koeyBmb3JjZSB9KQogIH0KCiAgYXN5bmMgc3VzcGVuZCh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIHJldHVybgoKICAgIGNvbnN0IHByb21pc2VzID0gW10KCiAgICBwcm9taXNlcy5wdXNoKHRoaXMuc2VydmVyLnN1c3BlbmQoeyBsb2cgfSkpCgogICAgZm9yIChjb25zdCBkaXNjb3Zlcnkgb2YgdGhpcy5fZGlzY292ZXJ5LnZhbHVlcygpKSB7CiAgICAgIHByb21pc2VzLnB1c2goZGlzY292ZXJ5LnN1c3BlbmQoeyBsb2cgfSkpCiAgICB9CgogICAgY29uc3QgcGVuZGluZyA9IFtdCiAgICBmb3IgKGNvbnN0IGNvbm5lY3Rpb24gb2YgdGhpcy5fYWxsQ29ubmVjdGlvbnMpIHsKICAgICAgY29ubmVjdGlvbi5kZXN0cm95KCkKICAgICAgcGVuZGluZy5wdXNoKG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBjb25uZWN0aW9uLm9uKCdjbG9zZScsIHJlc29sdmUpKSkKICAgIH0KCiAgICB0aGlzLnN1c3BlbmRlZCA9IHRydWUKCiAgICBsb2coJ1N1c3BlbmRpbmcgc2VydmVyIGFuZCBkaXNjb3ZlcnkuLi4gKCcgKyBwcm9taXNlcy5sZW5ndGggKyAnKScpCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQocHJvbWlzZXMpCiAgICBsb2coJ0RvbmUsIHN1c3BlbmRpbmcgdGhlIGRodC4uLicpCiAgICBhd2FpdCB0aGlzLmRodC5zdXNwZW5kKHsgbG9nIH0pCiAgICBsb2coJ0RvbmUsIHN3YXJtIGZ1bGx5IHN1c3BlbmRlZCcpCgogICAgYXdhaXQgUHJvbWlzZS5hbGwocGVuZGluZykKCiAgICAvLyByZXNldCBxdWV1ZQogICAgdGhpcy5fdGltZXIuZGVzdHJveSgpCiAgICB0aGlzLl90aW1lciA9IG5ldyBSZXRyeVRpbWVyKHRoaXMuX3JlcXVldWUuYmluZCh0aGlzKSwgewogICAgICBiYWNrb2ZmczogdGhpcy5fdGltZXIuYmFja29mZnMsCiAgICAgIGppdHRlcjogdGhpcy5fdGltZXIuaml0dGVyCiAgICB9KQogICAgdGhpcy5fcXVldWUgPSBzcHEoKQogIH0KCiAgYXN5bmMgcmVzdW1lKHsgbG9nID0gbm9vcCB9ID0ge30pIHsKICAgIGlmICghdGhpcy5zdXNwZW5kZWQpIHJldHVybgoKICAgIGxvZygnUmVzdW1pbmcgdGhlIGRodCcpCiAgICBhd2FpdCB0aGlzLmRodC5yZXN1bWUoKQogICAgbG9nKCdEb25lLCByZXN1bWluZyB0aGUgc2VydmVyJykKICAgIGF3YWl0IHRoaXMuc2VydmVyLnJlc3VtZSgpCiAgICBsb2coJ0RvbmUsIGFsbCBkaXNjb3ZlcnknKQoKICAgIGZvciAoY29uc3QgZGlzY292ZXJ5IG9mIHRoaXMuX2Rpc2NvdmVyeS52YWx1ZXMoKSkgewogICAgICBkaXNjb3ZlcnkucmVzdW1lKCkKICAgIH0KCiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCiAgICB0aGlzLl9hdHRlbXB0Q2xpZW50Q29ubmVjdGlvbnMoKQogIH0KCiAgdG9waWNzKCkgewogICAgcmV0dXJuIHRoaXMuX2Rpc2NvdmVyeS52YWx1ZXMoKQogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CgpmdW5jdGlvbiBhbGxvd0FsbCgpIHsKICByZXR1cm4gZmFsc2UKfQoKZnVuY3Rpb24gc2hvdWxkRm9yY2VSZWxheWluZyhjb2RlKSB7CiAgcmV0dXJuICgKICAgIGNvZGUgPT09ICdIT0xFUFVOQ0hfQUJPUlRFRCcgfHwKICAgIGNvZGUgPT09ICdIT0xFUFVOQ0hfRE9VQkxFX1JBTkRPTUlaRURfTkFUUycgfHwKICAgIGNvZGUgPT09ICdSRU1PVEVfTk9UX0hPTEVQVU5DSEFCTEUnCiAgKQp9CgpmdW5jdGlvbiBzaG91bGRCYW4oKSB7CiAgLy8gcmV0dXJuICEhZXJyICYmIGVyci5uYW1lID09PSAnSHlwZXJjb3JlRXJyb3InICYmIGVyci5jb2RlID09PSAnSU5WQUxJRF9PUEVSQVRJT04nCiAgcmV0dXJuIGZhbHNlCn0KCmZ1bmN0aW9uIHRvUmVsYXlGdW5jdGlvbihyZWxheVRocm91Z2gpIHsKICByZXR1cm4gdHlwZW9mIHJlbGF5VGhyb3VnaCA9PT0gJ2Z1bmN0aW9uJwogICAgPyByZWxheVRocm91Z2gKICAgIDogKGZvcmNlLCBzd2FybSkgPT4gKGZvcmNlIHx8IHN3YXJtLmRodC5yYW5kb21pemVkID8gcmVsYXlUaHJvdWdoIDogbnVsbCkKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEJ1bGtUaW1lciB7CiAgY29uc3RydWN0b3IodGltZSwgZm4pIHsKICAgIHRoaXMuX3RpbWUgPSB0aW1lCiAgICB0aGlzLl9mbiA9IGZuCiAgICB0aGlzLl9pbnRlcnZhbCA9IG51bGwKICAgIHRoaXMuX25leHQgPSBbXQogICAgdGhpcy5fcGVuZGluZyA9IFtdCiAgICB0aGlzLl9kZXN0cm95ZWQgPSBmYWxzZQogIH0KCiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5fZGVzdHJveWVkID0gdHJ1ZQogICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9pbnRlcnZhbCkKICAgIHRoaXMuX2ludGVydmFsID0gbnVsbAogIH0KCiAgX29udGljaygpIHsKICAgIGlmICghdGhpcy5fbmV4dC5sZW5ndGggJiYgIXRoaXMuX3BlbmRpbmcubGVuZ3RoKSByZXR1cm4KICAgIGlmICh0aGlzLl9uZXh0Lmxlbmd0aCkgdGhpcy5fZm4odGhpcy5fbmV4dCkKICAgIHRoaXMuX25leHQgPSB0aGlzLl9wZW5kaW5nCiAgICB0aGlzLl9wZW5kaW5nID0gW10KICB9CgogIGFkZChpbmZvKSB7CiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSByZXR1cm4KICAgIGlmICghdGhpcy5faW50ZXJ2YWwpIHsKICAgICAgdGhpcy5faW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLl9vbnRpY2suYmluZCh0aGlzKSwgTWF0aC5mbG9vcih0aGlzLl90aW1lICogMC42NikpCiAgICB9CgogICAgdGhpcy5fcGVuZGluZy5wdXNoKGluZm8pCiAgfQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENvbm5lY3Rpb25TZXQgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5fYnlQdWJsaWNLZXkgPSBuZXcgTWFwKCkKICB9CgogIFtTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgcmV0dXJuIHRoaXMuX2J5UHVibGljS2V5LnZhbHVlcygpCiAgfQoKICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLl9ieVB1YmxpY0tleS5zaXplCiAgfQoKICBoYXMocHVibGljS2V5KSB7CiAgICByZXR1cm4gdGhpcy5fYnlQdWJsaWNLZXkuaGFzKHRvSGV4KHB1YmxpY0tleSkpCiAgfQoKICBnZXQocHVibGljS2V5KSB7CiAgICByZXR1cm4gdGhpcy5fYnlQdWJsaWNLZXkuZ2V0KHRvSGV4KHB1YmxpY0tleSkpCiAgfQoKICBhZGQoY29ubmVjdGlvbikgewogICAgdGhpcy5fYnlQdWJsaWNLZXkuc2V0KGI0YS50b1N0cmluZyhjb25uZWN0aW9uLnJlbW90ZVB1YmxpY0tleSwgJ2hleCcpLCBjb25uZWN0aW9uKQogIH0KCiAgZGVsZXRlKGNvbm5lY3Rpb24pIHsKICAgIGNvbnN0IGtleVN0cmluZyA9IGI0YS50b1N0cmluZyhjb25uZWN0aW9uLnJlbW90ZVB1YmxpY0tleSwgJ2hleCcpCiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuX2J5UHVibGljS2V5LmdldChrZXlTdHJpbmcpCiAgICBpZiAoZXhpc3RpbmcgIT09IGNvbm5lY3Rpb24pIHJldHVybgogICAgdGhpcy5fYnlQdWJsaWNLZXkuZGVsZXRlKGtleVN0cmluZykKICB9Cn0KCmZ1bmN0aW9uIHRvSGV4KGIpIHsKICByZXR1cm4gdHlwZW9mIGIgPT09ICdzdHJpbmcnID8gYiA6IGI0YS50b1N0cmluZyhiLCAnaGV4JykKfQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBSRUZSRVNIX0lOVEVSVkFMID0gMTAwMCAqIDYwICogMTAgLy8gMTAgbWluCmNvbnN0IFJBTkRPTV9KSVRURVIgPSAxMDAwICogNjAgKiAyIC8vIDIgbWluCmNvbnN0IERFTEFZX0dSQUNFX1BFUklPRCA9IDEwMDAgKiAzMCAvLyAzMHMKCmNvbnN0IE1BWF9ESVNDT1ZFUllfQ0FDSEUgPSA2NAoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBQZWVyRGlzY292ZXJ5IHsKICBjb25zdHJ1Y3RvcigKICAgIHN3YXJtLAogICAgdG9waWMsCiAgICB7IGxpbWl0ID0gSW5maW5pdHksIHdhaXQgPSBudWxsLCBzdXNwZW5kZWQgPSBmYWxzZSwgb25wZWVyID0gbm9vcCwgb25lcnJvciA9IHNhZmV0eUNhdGNoIH0KICApIHsKICAgIHRoaXMubGltaXQgPSBsaW1pdAogICAgdGhpcy5zd2FybSA9IHN3YXJtCiAgICB0aGlzLnRvcGljID0gdG9waWMKICAgIHRoaXMuaXNDbGllbnQgPSBmYWxzZQogICAgdGhpcy5pc1NlcnZlciA9IGZhbHNlCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLmRlc3Ryb3lpbmcgPSBudWxsCiAgICB0aGlzLnN1c3BlbmRlZCA9IHN1c3BlbmRlZAoKICAgIHRoaXMuX3Nlc3Npb25zID0gW10KICAgIHRoaXMuX2NsaWVudFNlc3Npb25zID0gMAogICAgdGhpcy5fc2VydmVyU2Vzc2lvbnMgPSAwCgogICAgdGhpcy5fb25wZWVyID0gb25wZWVyCiAgICB0aGlzLl9vbmVycm9yID0gb25lcnJvcgoKICAgIHRoaXMuX2Rpc2NvdmVyZWQgPSBuZXcgU2V0KCkKICAgIHRoaXMuX2FjdGl2ZVF1ZXJ5ID0gbnVsbAogICAgdGhpcy5fdGltZXIgPSBudWxsCiAgICB0aGlzLl9jdXJyZW50UmVmcmVzaCA9IG51bGwKICAgIHRoaXMuX2Nsb3Nlc3ROb2RlcyA9IG51bGwKICAgIHRoaXMuX2ZpcnN0QW5ub3VuY2UgPSB0cnVlCiAgICB0aGlzLl9uZWVkc1VuYW5ub3VuY2UgPSBmYWxzZQogICAgdGhpcy5fcmVmcmVzaGVzID0gMAogICAgdGhpcy5fd2FpdCA9IHdhaXQKICB9CgogIHNlc3Npb24oeyBzZXJ2ZXIgPSB0cnVlLCBjbGllbnQgPSB0cnVlLCBsaW1pdCA9IEluZmluaXR5LCBvbmVycm9yID0gc2FmZXR5Q2F0Y2ggfSkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSB0aHJvdyBuZXcgRXJyb3IoJ1BlZXJEaXNjb3ZlcnkgaXMgZGVzdHJveWVkJykKICAgIGNvbnN0IHNlc3Npb24gPSBuZXcgUGVlckRpc2NvdmVyeVNlc3Npb24odGhpcykKICAgIHNlc3Npb24ucmVmcmVzaCh7IHNlcnZlciwgY2xpZW50LCBsaW1pdCB9KS5jYXRjaChvbmVycm9yKQogICAgdGhpcy5fc2Vzc2lvbnMucHVzaChzZXNzaW9uKQogICAgcmV0dXJuIHNlc3Npb24KICB9CgogIF9yZWZyZXNoTGF0ZXIoZWFnZXIpIHsKICAgIGNvbnN0IGppdHRlciA9IE1hdGgucm91bmQoTWF0aC5yYW5kb20oKSAqIFJBTkRPTV9KSVRURVIpCiAgICBjb25zdCBkZWxheSA9ICFlYWdlciA/IFJFRlJFU0hfSU5URVJWQUwgKyBqaXR0ZXIgOiBqaXR0ZXIKCiAgICBpZiAodGhpcy5fdGltZXIpIGNsZWFyVGltZW91dCh0aGlzLl90aW1lcikKCiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpCiAgICB0aGlzLl90aW1lciA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAvLyBJZiB5b3VyIGxhcHRvcCB3ZW50IHRvIHNsZWVwLCBhbmQgaXMgY29taW5nIGJhY2sgb25saW5lLi4uCiAgICAgIGNvbnN0IG92ZXJkdWUgPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lID4gZGVsYXkgKyBERUxBWV9HUkFDRV9QRVJJT0QKICAgICAgaWYgKG92ZXJkdWUpIHRoaXMuX3JlZnJlc2hMYXRlcih0cnVlKQogICAgICBlbHNlIHRoaXMucmVmcmVzaCgpLmNhdGNoKHRoaXMuX29uZXJyb3IpCiAgICB9LCBkZWxheSkKICB9CgogIF9pc0FjdGl2ZSgpIHsKICAgIHJldHVybiAhdGhpcy5kZXN0cm95ZWQgJiYgIXRoaXMuc3VzcGVuZGVkCiAgfQoKICAvLyBUT0RPOiBBbGxvdyBhbm5vdW5jZSB0byBiZSBhbiBhcmd1bWVudCB0byB0aGlzCiAgLy8gVE9ETzogTWF5YmUgYW5ub3VuY2Ugc2hvdWxkIGJlIGEgc2V0dGVyPwogIGFzeW5jIF9yZWZyZXNoKCkgewogICAgaWYgKHRoaXMuc3VzcGVuZGVkKSByZXR1cm4KICAgIGNvbnN0IGNsb2NrID0gKyt0aGlzLl9yZWZyZXNoZXMKCiAgICBpZiAodGhpcy5fd2FpdCkgewogICAgICBhd2FpdCB0aGlzLl93YWl0CiAgICAgIHRoaXMuX3dhaXQgPSBudWxsCiAgICAgIGlmIChjbG9jayAhPT0gdGhpcy5fcmVmcmVzaGVzIHx8ICF0aGlzLl9pc0FjdGl2ZSgpKSByZXR1cm4KICAgIH0KCiAgICBjb25zdCBjbGVhciA9IHRoaXMuaXNTZXJ2ZXIgJiYgdGhpcy5fZmlyc3RBbm5vdW5jZQogICAgaWYgKGNsZWFyKSB0aGlzLl9maXJzdEFubm91bmNlID0gZmFsc2UKCiAgICBjb25zdCBvcHRzID0gewogICAgICBjbGVhciwKICAgICAgY2xvc2VzdE5vZGVzOiB0aGlzLl9jbG9zZXN0Tm9kZXMKICAgIH0KCiAgICBpZiAodGhpcy5pc1NlcnZlcikgewogICAgICBhd2FpdCB0aGlzLnN3YXJtLmxpc3RlbigpCiAgICAgIC8vIGlmIGEgcGFyYWxsZWwgcmVmcmVzaCBpcyBoYXBwZW5pbmcsIHlpZWxkIHRvIHRoZSBuZXcgb25lCiAgICAgIGlmIChjbG9jayAhPT0gdGhpcy5fcmVmcmVzaGVzIHx8ICF0aGlzLl9pc0FjdGl2ZSgpKSByZXR1cm4KICAgICAgdGhpcy5fbmVlZHNVbmFubm91bmNlID0gdHJ1ZQogICAgfQoKICAgIGxldCBsaW1pdCA9IHRoaXMubGltaXQKCiAgICBpZiAobGltaXQgPCBJbmZpbml0eSAmJiBsaW1pdCA+IDApIHsKICAgICAgZm9yIChjb25zdCBpZCBvZiB0aGlzLl9kaXNjb3ZlcmVkKSB7CiAgICAgICAgaWYgKCF0aGlzLnN3YXJtLmNvbm5lY3Rpb25zLmhhcyhpZCkpIGNvbnRpbnVlCiAgICAgICAgaWYgKC0tbGltaXQgPT09IDApIGJyZWFrCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9kaXNjb3ZlcmVkLmNsZWFyKCkKCiAgICBjb25zdCBhbm5vdW5jaW5nID0gdGhpcy5pc1NlcnZlcgogICAgY29uc3QgcXVlcnkgPSAodGhpcy5fYWN0aXZlUXVlcnkgPSBhbm5vdW5jaW5nCiAgICAgID8gdGhpcy5zd2FybS5kaHQuYW5ub3VuY2UoCiAgICAgICAgICB0aGlzLnRvcGljLAogICAgICAgICAgdGhpcy5zd2FybS5rZXlQYWlyLAogICAgICAgICAgdGhpcy5zd2FybS5zZXJ2ZXIucmVsYXlBZGRyZXNzZXMsCiAgICAgICAgICBvcHRzCiAgICAgICAgKQogICAgICA6IHRoaXMuX25lZWRzVW5hbm5vdW5jZQogICAgICAgID8gdGhpcy5zd2FybS5kaHQubG9va3VwQW5kVW5hbm5vdW5jZSh0aGlzLnRvcGljLCB0aGlzLnN3YXJtLmtleVBhaXIsIG9wdHMpCiAgICAgICAgOiB0aGlzLnN3YXJtLmRodC5sb29rdXAodGhpcy50b3BpYywgb3B0cykpCgogICAgdHJ5IHsKICAgICAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIHRoaXMuX2FjdGl2ZVF1ZXJ5KSB7CiAgICAgICAgaWYgKCF0aGlzLmlzQ2xpZW50IHx8ICF0aGlzLl9pc0FjdGl2ZSgpKSBjb250aW51ZQogICAgICAgIGZvciAoY29uc3QgcGVlciBvZiBkYXRhLnBlZXJzKSB7CiAgICAgICAgICBpZiAobGltaXQgPCBJbmZpbml0eSkgewogICAgICAgICAgICBjb25zdCBpZCA9IGI0YS50b1N0cmluZyhwZWVyLnB1YmxpY0tleSwgJ2hleCcpCgogICAgICAgICAgICBpZiAodGhpcy5fZGlzY292ZXJlZC5zaXplIDwgTUFYX0RJU0NPVkVSWV9DQUNIRSkgewogICAgICAgICAgICAgIHRoaXMuX2Rpc2NvdmVyZWQuYWRkKGlkKQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobGltaXQgPT09IDApIGNvbnRpbnVlCgogICAgICAgICAgICAvLyB0aGVyZSBpcyBhIGNoYW5jZSBpdCBoYXMgdXBkYXRlZCBhIGNvbm5lY3Rpb24gZHVyaW5nIGRpc2NvdmVyeSBhbmQgd2UgZ28gb3ZlcgogICAgICAgICAgICAvLyB0aGUgbGltaXQgLSB0aGF0cyBhY2NlcHRhYmxlIHRvIGF2b2lkIGEgY29tcGxleGl0eSBzcGlyYWwgaGVyZS4KICAgICAgICAgICAgaWYgKCF0aGlzLnN3YXJtLmNvbm5lY3Rpb25zLmhhcyhpZCkpIGxpbWl0LS0KICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLl9vbnBlZXIocGVlciwgZGF0YSkKICAgICAgICB9CiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAodGhpcy5faXNBY3RpdmUoKSkgdGhyb3cgZXJyCiAgICB9IGZpbmFsbHkgewogICAgICBpZiAodGhpcy5fYWN0aXZlUXVlcnkgPT09IHF1ZXJ5KSB7CiAgICAgICAgdGhpcy5fYWN0aXZlUXVlcnkgPSBudWxsCiAgICAgICAgaWYgKCF0aGlzLmRlc3Ryb3llZCAmJiAhdGhpcy5zdXNwZW5kZWQpIHRoaXMuX3JlZnJlc2hMYXRlcihmYWxzZSkKICAgICAgfQogICAgfQoKICAgIC8vIFRoaXMgaXMgc2V0IGF0IHRoZSB2ZXJ5IGVuZCwgd2hlbiB0aGUgcXVlcnkgY29tcGxldGVzIHN1Y2Nlc3NmdWxseS4KICAgIHRoaXMuX2Nsb3Nlc3ROb2RlcyA9IHF1ZXJ5LmNsb3Nlc3ROb2RlcwoKICAgIGlmIChjbG9jayAhPT0gdGhpcy5fcmVmcmVzaGVzKSByZXR1cm4KCiAgICAvLyBJbiB0aGlzIGlzIHRoZSBsYXRlc3QgcXVlcnksIHVuYW5ub3VuY2UgaGFzIGJlZW4gZnVsZmlsbGVkIGFzIHdlbGwKICAgIGlmICghYW5ub3VuY2luZykgdGhpcy5fbmVlZHNVbmFubm91bmNlID0gZmFsc2UKICB9CgogIGFzeW5jIHJlZnJlc2goKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcignUGVlckRpc2NvdmVyeSBpcyBkZXN0cm95ZWQnKQoKICAgIGNvbnN0IHNlcnZlciA9IHRoaXMuX3NlcnZlclNlc3Npb25zID4gMAogICAgY29uc3QgY2xpZW50ID0gdGhpcy5fY2xpZW50U2Vzc2lvbnMgPiAwCgogICAgaWYgKHRoaXMuc3VzcGVuZGVkKSByZXR1cm4KCiAgICBpZiAoc2VydmVyID09PSB0aGlzLmlzU2VydmVyICYmIGNsaWVudCA9PT0gdGhpcy5pc0NsaWVudCkgewogICAgICBpZiAodGhpcy5fY3VycmVudFJlZnJlc2gpIHJldHVybiB0aGlzLl9jdXJyZW50UmVmcmVzaAogICAgICB0aGlzLl9jdXJyZW50UmVmcmVzaCA9IHRoaXMuX3JlZnJlc2goKQogICAgfSBlbHNlIHsKICAgICAgaWYgKHRoaXMuX2FjdGl2ZVF1ZXJ5KSB0aGlzLl9hY3RpdmVRdWVyeS5kZXN0cm95KCkKICAgICAgdGhpcy5pc1NlcnZlciA9IHNlcnZlcgogICAgICB0aGlzLmlzQ2xpZW50ID0gY2xpZW50CiAgICAgIHRoaXMuX2N1cnJlbnRSZWZyZXNoID0gdGhpcy5fcmVmcmVzaCgpCiAgICB9CgogICAgY29uc3QgcmVmcmVzaCA9IHRoaXMuX2N1cnJlbnRSZWZyZXNoCiAgICB0cnkgewogICAgICBhd2FpdCByZWZyZXNoCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9IGZpbmFsbHkgewogICAgICBpZiAocmVmcmVzaCA9PT0gdGhpcy5fY3VycmVudFJlZnJlc2gpIHsKICAgICAgICB0aGlzLl9jdXJyZW50UmVmcmVzaCA9IG51bGwKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBmbHVzaGVkKCkgewogICAgaWYgKHRoaXMuc3dhcm0ubGlzdGVuaW5nKSBhd2FpdCB0aGlzLnN3YXJtLmxpc3RlbmluZwoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2N1cnJlbnRSZWZyZXNoCiAgICAgIHJldHVybiB0cnVlCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQoKICBhc3luYyBfZGVzdHJveU1heWJlKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KCiAgICB0cnkgewogICAgICBpZiAodGhpcy5fc2Vzc2lvbnMubGVuZ3RoID09PSAwKSBhd2FpdCB0aGlzLnN3YXJtLmxlYXZlKHRoaXMudG9waWMpCiAgICAgIGVsc2UgaWYgKHRoaXMuX3NlcnZlclNlc3Npb25zID09PSAwICYmIHRoaXMuX25lZWRzVW5hbm5vdW5jZSkgYXdhaXQgdGhpcy5yZWZyZXNoKCkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICAvLyBpZ25vcmUgbmV0d29yayBmYWlsdXJlcyBoZXJlLCBhcyB3ZSBhcmUgdGVhcmluZyBkb3duCiAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgIH0KICB9CgogIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5kZXN0cm95aW5nKSByZXR1cm4gdGhpcy5kZXN0cm95aW5nCiAgICB0aGlzLmRlc3Ryb3lpbmcgPSB0aGlzLl9kZXN0cm95KCkKICAgIHJldHVybiB0aGlzLmRlc3Ryb3lpbmcKICB9CgogIGFzeW5jIF9hYm9ydChsb2cpIHsKICAgIGNvbnN0IGlkID0gbG9nID09PSBub29wID8gJycgOiBiNGEudG9TdHJpbmcodGhpcy50b3BpYywgJ2hleCcpCgogICAgbG9nKCdBYm9ydGluZyBkaXNjb3ZlcnknLCBpZCkKICAgIGlmICh0aGlzLl93YWl0KSBhd2FpdCB0aGlzLl93YWl0CiAgICBsb2coJ0Fib3J0aW5nIGRpc2NvdmVyeSAocG9zdCB3YWl0KScsIGlkKQoKICAgIGlmICh0aGlzLl9hY3RpdmVRdWVyeSkgewogICAgICB0aGlzLl9hY3RpdmVRdWVyeS5kZXN0cm95KCkKICAgICAgdGhpcy5fYWN0aXZlUXVlcnkgPSBudWxsCiAgICB9CiAgICBpZiAodGhpcy5fdGltZXIpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVyKQogICAgICB0aGlzLl90aW1lciA9IG51bGwKICAgIH0KCiAgICBsZXQgbm9kZXMgPSB0aGlzLl9jbG9zZXN0Tm9kZXMKCiAgICBpZiAodGhpcy5fY3VycmVudFJlZnJlc2gpIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLl9jdXJyZW50UmVmcmVzaAogICAgICB9IGNhdGNoIHsKICAgICAgICAvLyBJZiB0aGUgZGVzdHJveSBjYXVzZXMgdGhlIHJlZnJlc2ggdG8gZmFpbCwgc3VwcHJlc3MgaXQuCiAgICAgIH0KICAgIH0KCiAgICBsb2coJ0Fib3J0aW5nIGRpc2NvdmVyeSAocG9zdCByZWZyZXNoKScsIGlkKQogICAgaWYgKHRoaXMuX2lzQWN0aXZlKCkpIHJldHVybgoKICAgIGlmICghbm9kZXMpIG5vZGVzID0gdGhpcy5fY2xvc2VzdE5vZGVzCiAgICBlbHNlIGlmICh0aGlzLl9jbG9zZXN0Tm9kZXMgIT09IG5vZGVzKSB7CiAgICAgIGNvbnN0IGxlbiA9IG5vZGVzLmxlbmd0aAogICAgICBmb3IgKGNvbnN0IG5ld2VyIG9mIHRoaXMuX2Nsb3Nlc3ROb2RlcykgewogICAgICAgIGlmIChuZXdlci5pZCAmJiAhaGFzTm9kZShub2RlcywgbGVuLCBuZXdlcikpIG5vZGVzLnB1c2gobmV3ZXIpCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5fbmVlZHNVbmFubm91bmNlKSB7CiAgICAgIGxvZygnVW5hbm5vdW5jaW5nIGRpc2NvdmVyeScsIGlkKQogICAgICBpZiAobm9kZXMgJiYgbm9kZXMubGVuZ3RoKQogICAgICAgIGF3YWl0IHRoaXMuc3dhcm0uZGh0LnVuYW5ub3VuY2UodGhpcy50b3BpYywgdGhpcy5zd2FybS5rZXlQYWlyLCB7CiAgICAgICAgICBjbG9zZXN0Tm9kZXM6IG5vZGVzLAogICAgICAgICAgb25seUNsb3Nlc3ROb2RlczogdHJ1ZSwKICAgICAgICAgIGZvcmNlOiB0cnVlCiAgICAgICAgfSkKICAgICAgdGhpcy5fbmVlZHNVbmFubm91bmNlID0gZmFsc2UKICAgICAgbG9nKCdVbmFubm91bmNpbmcgZGlzY292ZXJ5IChkb25lKScsIGlkKQogICAgfQogIH0KCiAgX2Rlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCiAgICByZXR1cm4gdGhpcy5fYWJvcnQobm9vcCkKICB9CgogIGFzeW5jIHN1c3BlbmQoeyBsb2cgPSBub29wIH0gPSB7fSkgewogICAgaWYgKHRoaXMuc3VzcGVuZGVkKSByZXR1cm4KICAgIHRoaXMuc3VzcGVuZGVkID0gdHJ1ZQogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fYWJvcnQobG9nKQogICAgfSBjYXRjaCB7CiAgICAgIC8vIGlnbm9yZQogICAgfQogIH0KCiAgcmVzdW1lKCkgewogICAgaWYgKCF0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCiAgICB0aGlzLnJlZnJlc2goKS5jYXRjaChub29wKQogIH0KfQoKY2xhc3MgUGVlckRpc2NvdmVyeVNlc3Npb24gewogIGNvbnN0cnVjdG9yKGRpc2NvdmVyeSkgewogICAgdGhpcy5kaXNjb3ZlcnkgPSBkaXNjb3ZlcnkKICAgIHRoaXMuaXNDbGllbnQgPSBmYWxzZQogICAgdGhpcy5pc1NlcnZlciA9IGZhbHNlCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCiAgfQoKICBnZXQgc3dhcm0oKSB7CiAgICByZXR1cm4gdGhpcy5kaXNjb3Zlcnkuc3dhcm0KICB9CgogIGdldCB0b3BpYygpIHsKICAgIHJldHVybiB0aGlzLmRpc2NvdmVyeS50b3BpYwogIH0KCiAgYXN5bmMgcmVmcmVzaCh7IGNsaWVudCA9IHRoaXMuaXNDbGllbnQsIHNlcnZlciA9IHRoaXMuaXNTZXJ2ZXIsIGxpbWl0ID0gSW5maW5pdHkgfSA9IHt9KSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcignUGVlckRpc2NvdmVyeSBpcyBkZXN0cm95ZWQnKQogICAgaWYgKCFjbGllbnQgJiYgIXNlcnZlcikgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgcmVmcmVzaCB3aXRoIG5laXRoZXIgY2xpZW50IG5vciBzZXJ2ZXIgb3B0aW9uJykKCiAgICBpZiAoY2xpZW50ICE9PSB0aGlzLmlzQ2xpZW50KSB7CiAgICAgIHRoaXMuaXNDbGllbnQgPSBjbGllbnQKICAgICAgdGhpcy5kaXNjb3ZlcnkuX2NsaWVudFNlc3Npb25zICs9IGNsaWVudCA/IDEgOiAtMQogICAgfQoKICAgIGlmIChzZXJ2ZXIgIT09IHRoaXMuaXNTZXJ2ZXIpIHsKICAgICAgdGhpcy5pc1NlcnZlciA9IHNlcnZlcgogICAgICB0aGlzLmRpc2NvdmVyeS5fc2VydmVyU2Vzc2lvbnMgKz0gc2VydmVyID8gMSA6IC0xCiAgICB9CgogICAgdGhpcy5kaXNjb3ZlcnkubGltaXQgPSBsaW1pdAoKICAgIHJldHVybiB0aGlzLmRpc2NvdmVyeS5yZWZyZXNoKCkKICB9CgogIGFzeW5jIGZsdXNoZWQoKSB7CiAgICByZXR1cm4gdGhpcy5kaXNjb3ZlcnkuZmx1c2hlZCgpCiAgfQoKICBhc3luYyBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQoKICAgIGlmICh0aGlzLmlzQ2xpZW50KSB0aGlzLmRpc2NvdmVyeS5fY2xpZW50U2Vzc2lvbnMtLQogICAgaWYgKHRoaXMuaXNTZXJ2ZXIpIHRoaXMuZGlzY292ZXJ5Ll9zZXJ2ZXJTZXNzaW9ucy0tCgogICAgY29uc3QgaW5kZXggPSB0aGlzLmRpc2NvdmVyeS5fc2Vzc2lvbnMuaW5kZXhPZih0aGlzKQogICAgY29uc3QgaGVhZCA9IHRoaXMuZGlzY292ZXJ5Ll9zZXNzaW9ucy5wb3AoKQoKICAgIGlmIChoZWFkICE9PSB0aGlzKSB0aGlzLmRpc2NvdmVyeS5fc2Vzc2lvbnNbaW5kZXhdID0gaGVhZAoKICAgIHJldHVybiB0aGlzLmRpc2NvdmVyeS5fZGVzdHJveU1heWJlKCkKICB9Cn0KCmZ1bmN0aW9uIGhhc05vZGUobm9kZXMsIGxlbiwgbm9kZSkgewogIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgIGNvbnN0IGV4aXN0aW5nID0gbm9kZXNbaV0KICAgIGlmIChleGlzdGluZy5pZCAmJiBiNGEuZXF1YWxzKGV4aXN0aW5nLmlkLCBub2RlLmlkKSkgcmV0dXJuIHRydWUKICB9CgogIHJldHVybiBmYWxzZQp9CgpmdW5jdGlvbiBub29wKCkge30KY29uc3QgeyBFdmVudEVtaXR0ZXIgfSA9IHJlcXVpcmUoJ2V2ZW50cycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHVuc2xhYiA9IHJlcXVpcmUoJ3Vuc2xhYicpCgpjb25zdCBNSU5fQ09OTkVDVElPTl9USU1FID0gMTUwMDAKCmNvbnN0IFZFUllfTE9XX1BSSU9SSVRZID0gMApjb25zdCBMT1dfUFJJT1JJVFkgPSAxCmNvbnN0IE5PUk1BTF9QUklPUklUWSA9IDIKY29uc3QgSElHSF9QUklPUklUWSA9IDMKY29uc3QgVkVSWV9ISUdIX1BSSU9SSVRZID0gNAoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBQZWVySW5mbyBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IoeyBwdWJsaWNLZXksIHJlbGF5QWRkcmVzc2VzIH0pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLnB1YmxpY0tleSA9IHVuc2xhYihwdWJsaWNLZXkpCiAgICB0aGlzLnJlbGF5QWRkcmVzc2VzID0gcmVsYXlBZGRyZXNzZXMKCiAgICB0aGlzLnJlY29ubmVjdGluZyA9IHRydWUKICAgIHRoaXMucHJvdmVuID0gZmFsc2UKICAgIHRoaXMuY29ubmVjdGVkVGltZSA9IC0xCiAgICB0aGlzLmRpc2Nvbm5lY3RlZFRpbWUgPSAwCiAgICB0aGlzLmJhbm5lZCA9IGZhbHNlCiAgICB0aGlzLnRyaWVkID0gZmFsc2UKICAgIHRoaXMuZXhwbGljaXQgPSBmYWxzZQogICAgdGhpcy53YWl0aW5nID0gZmFsc2UKICAgIHRoaXMuZm9yY2VSZWxheWluZyA9IGZhbHNlCgogICAgLy8gU2V0IGJ5IHRoZSBTd2FybQogICAgdGhpcy5xdWV1ZWQgPSBmYWxzZQogICAgdGhpcy5jbGllbnQgPSBmYWxzZQogICAgdGhpcy50b3BpY3MgPSBbXSAvLyBUT0RPOiByZW1vdmUgb24gbmV4dCBtYWpvciAoY2hlY2sgd2l0aCBtYWZpbnRvc2ggZm9yIGNvbnRleHQpCgogICAgdGhpcy5hdHRlbXB0cyA9IDAKICAgIHRoaXMucHJpb3JpdHkgPSBOT1JNQUxfUFJJT1JJVFkKCiAgICAvLyBVc2VkIGJ5IHNodWZmbGVkLXByaW9yaXR5LXF1ZXVlCiAgICB0aGlzLl9pbmRleCA9IDAKCiAgICAvLyBVc2VkIGZvciBmbHVzaCBtYW5hZ2VtZW50CiAgICB0aGlzLl9mbHVzaFRpY2sgPSAwCgogICAgLy8gVXNlZCBmb3IgdG9waWMgbXVsdGlwbGV4aW5nCiAgICB0aGlzLl9zZWVuVG9waWNzID0gbmV3IFNldCgpCiAgfQoKICBnZXQgc2VydmVyKCkgewogICAgcmV0dXJuICF0aGlzLmNsaWVudAogIH0KCiAgZ2V0IHByaW9yaXRpemVkKCkgewogICAgcmV0dXJuIHRoaXMucHJpb3JpdHkgPj0gTk9STUFMX1BSSU9SSVRZCiAgfQoKICBfZ2V0UHJpb3JpdHkoKSB7CiAgICBjb25zdCBwZWVySXNTdGFsZSA9IHRoaXMudHJpZWQgJiYgIXRoaXMucHJvdmVuCiAgICBpZiAocGVlcklzU3RhbGUgfHwgdGhpcy5hdHRlbXB0cyA+IDMpIHJldHVybiBWRVJZX0xPV19QUklPUklUWQogICAgaWYgKHRoaXMuYXR0ZW1wdHMgPT09IDMpIHJldHVybiBMT1dfUFJJT1JJVFkKICAgIGlmICh0aGlzLmF0dGVtcHRzID09PSAyKSByZXR1cm4gSElHSF9QUklPUklUWQogICAgaWYgKHRoaXMuYXR0ZW1wdHMgPT09IDEpIHJldHVybiBWRVJZX0hJR0hfUFJJT1JJVFkKICAgIHJldHVybiBOT1JNQUxfUFJJT1JJVFkKICB9CgogIF9jb25uZWN0ZWQoKSB7CiAgICB0aGlzLnByb3ZlbiA9IHRydWUKICAgIHRoaXMuY29ubmVjdGVkVGltZSA9IERhdGUubm93KCkKICB9CgogIF9kaXNjb25uZWN0ZWQoKSB7CiAgICB0aGlzLmRpc2Nvbm5lY3RlZFRpbWUgPSBEYXRlLm5vdygpCiAgICBpZiAodGhpcy5jb25uZWN0ZWRUaW1lID4gLTEpIHsKICAgICAgaWYgKHRoaXMuZGlzY29ubmVjdGVkVGltZSAtIHRoaXMuY29ubmVjdGVkVGltZSA+PSBNSU5fQ09OTkVDVElPTl9USU1FKSB0aGlzLmF0dGVtcHRzID0gMCAvLyBmYXN0IHJldHJ5CiAgICAgIHRoaXMuY29ubmVjdGVkVGltZSA9IC0xCiAgICB9CiAgICB0aGlzLmF0dGVtcHRzKysKICB9CgogIF9kZXByaW9yaXRpemUoKSB7CiAgICB0aGlzLmF0dGVtcHRzID0gMwogIH0KCiAgX3Jlc2V0KCkgewogICAgdGhpcy5jbGllbnQgPSBmYWxzZQogICAgdGhpcy5wcm92ZW4gPSBmYWxzZQogICAgdGhpcy50cmllZCA9IGZhbHNlCiAgICB0aGlzLmF0dGVtcHRzID0gMAogIH0KCiAgX3VwZGF0ZVByaW9yaXR5KCkgewogICAgaWYgKHRoaXMuZXhwbGljaXQgJiYgdGhpcy5hdHRlbXB0cyA+IDMpIHRoaXMuX2RlcHJpb3JpdGl6ZSgpCiAgICBpZiAodGhpcy5iYW5uZWQgfHwgdGhpcy5xdWV1ZWQgfHwgdGhpcy5hdHRlbXB0cyA+IDMpIHJldHVybiBmYWxzZQogICAgdGhpcy5wcmlvcml0eSA9IHRoaXMuX2dldFByaW9yaXR5KCkKICAgIHJldHVybiB0cnVlCiAgfQoKICBfdG9waWModG9waWMpIHsKICAgIGNvbnN0IHRvcGljU3RyaW5nID0gYjRhLnRvU3RyaW5nKHRvcGljLCAnaGV4JykKICAgIGlmICh0aGlzLl9zZWVuVG9waWNzLmhhcyh0b3BpY1N0cmluZykpIHJldHVybgogICAgdGhpcy5fc2VlblRvcGljcy5hZGQodG9waWNTdHJpbmcpCiAgICB0aGlzLnRvcGljcy5wdXNoKHRvcGljKQogICAgdGhpcy5lbWl0KCd0b3BpYycsIHRvcGljKQogIH0KCiAgcmVjb25uZWN0KHZhbCkgewogICAgdGhpcy5yZWNvbm5lY3RpbmcgPSAhIXZhbAogIH0KCiAgYmFuKHZhbCkgewogICAgdGhpcy5iYW5uZWQgPSAhIXZhbAogIH0KCiAgc2hvdWxkR0MoKSB7CiAgICByZXR1cm4gISh0aGlzLmJhbm5lZCB8fCB0aGlzLnF1ZXVlZCB8fCB0aGlzLmV4cGxpY2l0IHx8IHRoaXMud2FpdGluZykKICB9Cn0KY29uc3QgQnVsa1RpbWVyID0gcmVxdWlyZSgnLi9idWxrLXRpbWVyJykKCmNvbnN0IEJBQ0tPRkZfSklUVEVSID0gNTAwCmNvbnN0IEJBQ0tPRkZfUyA9IDEwMDAgKyBNYXRoLnJvdW5kKEJBQ0tPRkZfSklUVEVSICogTWF0aC5yYW5kb20oKSkKY29uc3QgQkFDS09GRl9NID0gNTAwMCArIE1hdGgucm91bmQoMiAqIEJBQ0tPRkZfSklUVEVSICogTWF0aC5yYW5kb20oKSkKY29uc3QgQkFDS09GRl9MID0gMTUwMDAgKyBNYXRoLnJvdW5kKDQgKiBCQUNLT0ZGX0pJVFRFUiAqIE1hdGgucmFuZG9tKCkpCmNvbnN0IEJBQ0tPRkZfWCA9IDEwMDAgKiA2MCAqIDEwICsgTWF0aC5yb3VuZCgyNDAgKiBCQUNLT0ZGX0pJVFRFUiAqIE1hdGgucmFuZG9tKCkpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJldHJ5VGltZXIgewogIGNvbnN0cnVjdG9yKAogICAgcHVzaCwKICAgIHsgYmFja29mZnMgPSBbQkFDS09GRl9TLCBCQUNLT0ZGX00sIEJBQ0tPRkZfTCwgQkFDS09GRl9YXSwgaml0dGVyID0gQkFDS09GRl9KSVRURVIgfSA9IHt9CiAgKSB7CiAgICB0aGlzLmppdHRlciA9IGppdHRlcgogICAgdGhpcy5iYWNrb2ZmcyA9IGJhY2tvZmZzCgogICAgdGhpcy5fc1RpbWVyID0gbmV3IEJ1bGtUaW1lcihiYWNrb2Zmc1swXSArIE1hdGgucm91bmQoaml0dGVyICogTWF0aC5yYW5kb20oKSksIHB1c2gpCiAgICB0aGlzLl9tVGltZXIgPSBuZXcgQnVsa1RpbWVyKGJhY2tvZmZzWzFdICsgTWF0aC5yb3VuZChqaXR0ZXIgKiBNYXRoLnJhbmRvbSgpKSwgcHVzaCkKICAgIHRoaXMuX2xUaW1lciA9IG5ldyBCdWxrVGltZXIoYmFja29mZnNbMl0gKyBNYXRoLnJvdW5kKGppdHRlciAqIE1hdGgucmFuZG9tKCkpLCBwdXNoKQogICAgdGhpcy5feFRpbWVyID0gbmV3IEJ1bGtUaW1lcihiYWNrb2Zmc1szXSArIE1hdGgucm91bmQoaml0dGVyICogTWF0aC5yYW5kb20oKSksIHB1c2gpCiAgfQoKICBfc2VsZWN0UmV0cnlUaW1lcihwZWVySW5mbykgewogICAgaWYgKHBlZXJJbmZvLmJhbm5lZCB8fCAhcGVlckluZm8ucmVjb25uZWN0aW5nKSByZXR1cm4gbnVsbAoKICAgIGlmIChwZWVySW5mby5hdHRlbXB0cyA+IDMpIHsKICAgICAgcmV0dXJuIHBlZXJJbmZvLmV4cGxpY2l0ID8gdGhpcy5feFRpbWVyIDogbnVsbAogICAgfQoKICAgIGlmIChwZWVySW5mby5hdHRlbXB0cyA9PT0gMCkgcmV0dXJuIHRoaXMuX3NUaW1lcgogICAgaWYgKHBlZXJJbmZvLnByb3ZlbikgewogICAgICBzd2l0Y2ggKHBlZXJJbmZvLmF0dGVtcHRzKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgICAgcmV0dXJuIHRoaXMuX3NUaW1lcgogICAgICAgIGNhc2UgMjoKICAgICAgICAgIHJldHVybiB0aGlzLl9tVGltZXIKICAgICAgICBjYXNlIDM6CiAgICAgICAgICByZXR1cm4gdGhpcy5fbFRpbWVyCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHN3aXRjaCAocGVlckluZm8uYXR0ZW1wdHMpIHsKICAgICAgICBjYXNlIDE6CiAgICAgICAgICByZXR1cm4gdGhpcy5fbVRpbWVyCiAgICAgICAgY2FzZSAyOgogICAgICAgICAgcmV0dXJuIHRoaXMuX2xUaW1lcgogICAgICAgIGNhc2UgMzoKICAgICAgICAgIHJldHVybiB0aGlzLl9sVGltZXIKICAgICAgfQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBhZGQocGVlckluZm8pIHsKICAgIGNvbnN0IHRpbWVyID0gdGhpcy5fc2VsZWN0UmV0cnlUaW1lcihwZWVySW5mbykKICAgIGlmICghdGltZXIpIHJldHVybiBmYWxzZQoKICAgIHRpbWVyLmFkZChwZWVySW5mbykKICAgIHJldHVybiB0cnVlCiAgfQoKICBkZXN0cm95KCkgewogICAgdGhpcy5fc1RpbWVyLmRlc3Ryb3koKQogICAgdGhpcy5fbVRpbWVyLmRlc3Ryb3koKQogICAgdGhpcy5fbFRpbWVyLmRlc3Ryb3koKQogICAgdGhpcy5feFRpbWVyLmRlc3Ryb3koKQogIH0KfQp7CiAgIm5hbWUiOiAiaHlwZXJzd2FybSIsCiAgInZlcnNpb24iOiAiNC4xNi4wIiwKICAiZGVzY3JpcHRpb24iOiAiQSBkaXN0cmlidXRlZCBuZXR3b3JraW5nIHN0YWNrIGZvciBjb25uZWN0aW5nIHBlZXJzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYi8qKi5qcyIKICBdLAogICJpbXBvcnRzIjogewogICAgImV2ZW50cyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1ldmVudHMiLAogICAgICAiZGVmYXVsdCI6ICJldmVudHMiCiAgICB9CiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS4zLjEiLAogICAgImJhcmUtZXZlbnRzIjogIl4yLjIuMCIsCiAgICAiaHlwZXJkaHQiOiAiXjYuMjEuMCIsCiAgICAic2FmZXR5LWNhdGNoIjogIl4xLjAuMiIsCiAgICAic2h1ZmZsZWQtcHJpb3JpdHktcXVldWUiOiAiXjIuMS4wIiwKICAgICJzdHJlYW14IjogIl4yLjIyLjEiLAogICAgInVuc2xhYiI6ICJeMS4zLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMC4yIiwKICAgICJoeXBlcmNvcmUtY3J5cHRvIjogIl4zLjQuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuIiwKICAgICJ0ZXN0IjogIm5vZGUgdGVzdC9hbGwuanMiLAogICAgInRlc3Q6Z2VuZXJhdGUiOiAiYnJpdHRsZSAtciB0ZXN0L2FsbC5qcyB0ZXN0LyouanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcnN3YXJtLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImNvbnRyaWJ1dG9ycyI6IFsKICAgICJEYXZpZCBNYXJrIENsZW1lbnRzIChAZGF2aWRtYXJrY2xlbSkiLAogICAgIkFuZHJldyBPc2hlcm9mZiAoQGFuZHJld29zaCkiCiAgXSwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJzd2FybS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyc3dhcm0iCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IEVNUFRZID0gYjRhLmFsbG9jKDApCmNvbnN0IE1BWCA9IGI0YS5mcm9tKFsweGZmXSkKY29uc3QgQlVGRkVSID0ge30KCkJVRkZFUi5wcmVlbmNvZGUgPSBmdW5jdGlvbiAoc3RhdGUsIGJ1ZikgewogIGlmIChidWYgPT09IG51bGwpIGJ1ZiA9IEVNUFRZCgogIGxldCBpID0gMAogIGxldCBleHRyYSA9IDMKCiAgd2hpbGUgKChpID0gYjRhLmluZGV4T2YoYnVmLCAweDAwLCBpKSkgPiAtMSkgewogICAgaSsrCiAgICBleHRyYSsrCiAgfQoKICBzdGF0ZS5lbmQgKz0gYnVmLmJ5dGVMZW5ndGggKyBleHRyYQp9CgpCVUZGRVIuZW5jb2RlID0gZnVuY3Rpb24gKHN0YXRlLCBidWYpIHsKICBpZiAoYnVmID09PSBudWxsKSBidWYgPSBFTVBUWQoKICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweDAwCgogIGxldCBwcmV2ID0gMAogIGxldCBpID0gMAoKICB3aGlsZSAoKGkgPSBiNGEuaW5kZXhPZihidWYsIDB4MDAsIGkpKSA+IC0xKSB7CiAgICBjb25zdCBzbGljZSA9IGJ1Zi5zdWJhcnJheShwcmV2LCArK2kpCgogICAgc3RhdGUuYnVmZmVyLnNldChzbGljZSwgc3RhdGUuc3RhcnQpCiAgICBzdGF0ZS5zdGFydCArPSBzbGljZS5ieXRlTGVuZ3RoCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweDAyCiAgICBwcmV2ID0gaQogIH0KCiAgY29uc3Qgc2xpY2UgPSBidWYuc3ViYXJyYXkocHJldikKCiAgc3RhdGUuYnVmZmVyLnNldChzbGljZSwgc3RhdGUuc3RhcnQpCiAgc3RhdGUuc3RhcnQgKz0gc2xpY2UuYnl0ZUxlbmd0aAoKICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweDAwCiAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHgwMQp9CgpCVUZGRVIuZGVjb2RlID0gZnVuY3Rpb24gKHN0YXRlKSB7CiAgaWYgKHN0YXRlLnN0YXJ0ID49IHN0YXRlLmVuZCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICBpZiAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICE9PSAweDAwKSB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc3RhcnQgb2Ygc3RyaW5nJykKCiAgbGV0IGVzY2FwZWQgPSBudWxsCgogIGxldCBwcmV2ID0gc3RhdGUuc3RhcnQKICBsZXQgaSA9IHN0YXRlLnN0YXJ0CgogIHdoaWxlICgoaSA9IGI0YS5pbmRleE9mKHN0YXRlLmJ1ZmZlciwgMHgwMCwgaSkpID4gLTEpIHsKICAgIGNvbnN0IG5leHQgPSArK2kgPCBzdGF0ZS5lbmQgPyBzdGF0ZS5idWZmZXJbaV0gOiAweDAwCgogICAgaSsrCgogICAgaWYgKG5leHQgPT09IDB4MDEpIHsKICAgICAgYnJlYWsKICAgIH0KCiAgICBpZiAobmV4dCA9PT0gMHgwMikgewogICAgICBpZiAoZXNjYXBlZCA9PT0gbnVsbCkgZXNjYXBlZCA9IFtdCiAgICAgIGVzY2FwZWQucHVzaChzdGF0ZS5idWZmZXIuc3ViYXJyYXkocHJldiwgaSAtIDEpKQogICAgICBwcmV2ID0gaQogICAgICBjb250aW51ZQogICAgfQoKICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biB2YWx1ZSBpbiB0ZXJtaW5hdG9yJykKICB9CgogIGlmIChpID09PSAtMSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdObyB0ZXJtaW5hdG9yIGZvdW5kJykKICB9CgogIHN0YXRlLnN0YXJ0ID0gaQogIGNvbnN0IGxhc3QgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkocHJldiwgaSAtIDIpCiAgaWYgKGVzY2FwZWQgPT09IG51bGwpIHJldHVybiBsYXN0CgogIGVzY2FwZWQucHVzaChsYXN0KQogIHJldHVybiBiNGEuY29uY2F0KGVzY2FwZWQpCn0KCi8vIFRPRE86IGNhbiBiZSBvcHRpbWlzZWQgYSBsb3QKCmNvbnN0IFNUUklORyA9IHt9CgpTVFJJTkcucHJlZW5jb2RlID0gZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHsKICBCVUZGRVIucHJlZW5jb2RlKHN0YXRlLCBiNGEuZnJvbShzdHIgfHwgJycpKQp9CgpTVFJJTkcuZW5jb2RlID0gZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHsKICBCVUZGRVIuZW5jb2RlKHN0YXRlLCBiNGEuZnJvbShzdHIgfHwgJycpKQp9CgpTVFJJTkcuZGVjb2RlID0gZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHsKICByZXR1cm4gYjRhLnRvU3RyaW5nKEJVRkZFUi5kZWNvZGUoc3RhdGUpKQp9Cgpjb25zdCBVSU5UID0ge30KClVJTlQucHJlZW5jb2RlID0gZnVuY3Rpb24gKHN0YXRlLCBuKSB7CiAgc3RhdGUuZW5kICs9IG4gPD0gMHhmYiA/IDEgOiBuIDw9IDB4ZmZmZiA/IDMgOiBuIDw9IDB4ZmZmZmZmZmYgPyA1IDogKG4gPT09IEluZmluaXR5ID8gMSA6IDkpCn0KClVJTlQuZW5jb2RlID0gZnVuY3Rpb24gKHN0YXRlLCBuKSB7CiAgaWYgKG4gPT09IEluZmluaXR5KSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweGZmCiAgICByZXR1cm4KICB9CgogIGlmIChuIDw9IDB4ZmIpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KICAgIHJldHVybgogIH0KCiAgaWYgKG4gPD0gMHhmZmZmKSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweGZjCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuID4+PiA4CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuCiAgICByZXR1cm4KICB9CgogIGlmIChuIDw9IDB4ZmZmZmZmZmYpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4ZmQKICAgIGVuY29kZVVpbnQzMihzdGF0ZSwgbikKICAgIHJldHVybgogIH0KCiAgaWYgKE51bWJlci5pc1NhZmVJbnRlZ2VyKG4pKSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweGZlCgogICAgY29uc3QgciA9IE1hdGguZmxvb3IobiAvIDB4MTAwMDAwMDAwKQogICAgZW5jb2RlVWludDMyKHN0YXRlLCByKQogICAgZW5jb2RlVWludDMyKHN0YXRlLCBuKQogICAgcmV0dXJuCiAgfQoKICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgbnVtYmVyICcgKyBuKQp9CgpVSU5ULmRlY29kZSA9IGZ1bmN0aW9uIChzdGF0ZSkgewogIGlmIChzdGF0ZS5zdGFydCA+PSBzdGF0ZS5lbmQpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCgogIGNvbnN0IGEgPSBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KCiAgaWYgKGEgPD0gMHhmYikgcmV0dXJuIGEKCiAgaWYgKGEgPT09IDB4ZmMpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDIpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gKAogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMCArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogICAgKQogIH0KCiAgaWYgKGEgPT09IDB4ZmQpIHsKICAgIHJldHVybiBkZWNvZGVVaW50MzIoc3RhdGUpCiAgfQoKICBpZiAoYSA9PT0gMHhmZSkgewogICAgcmV0dXJuICgKICAgICAgZGVjb2RlVWludDMyKHN0YXRlKSAqIDB4MTAwMDAwMDAwICsKICAgICAgZGVjb2RlVWludDMyKHN0YXRlKQogICAgKQogIH0KCiAgcmV0dXJuIEluZmluaXR5Cn0KCmNvbnN0IEJPT0wgPSB7fQoKQk9PTC5wcmVlbmNvZGUgPSAoc3RhdGUsIGIpID0+IFVJTlQucHJlZW5jb2RlKHN0YXRlLCBiID8gMSA6IDApCkJPT0wuZW5jb2RlID0gKHN0YXRlLCBiKSA9PiBVSU5ULmVuY29kZShzdGF0ZSwgYiA/IDEgOiAwKQpCT09MLmRlY29kZSA9IChzdGF0ZSwgYikgPT4gISFVSU5ULmRlY29kZShzdGF0ZSkKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgSW5kZXhFbmNvZGVyIHsKICBjb25zdHJ1Y3RvciAoZW5jb2RpbmdzLCB7IHByZWZpeCA9IC0xIH0gPSB7fSkgewogICAgdGhpcy5lbmNvZGluZ3MgPSBlbmNvZGluZ3MKICAgIHRoaXMucHJlZml4ID0gcHJlZml4CiAgfQoKICBzdGF0aWMgQlVGRkVSID0gQlVGRkVSCiAgc3RhdGljIFNUUklORyA9IFNUUklORwogIHN0YXRpYyBVSU5UID0gVUlOVAogIHN0YXRpYyBCT09MID0gQk9PTAoKICBzdGF0aWMgbG9va3VwIChjKSB7CiAgICBzd2l0Y2ggKGMpIHsKICAgICAgY2FzZSAndWludCc6IHJldHVybiBVSU5UCiAgICAgIGNhc2UgJ3VpbnQ4JzogcmV0dXJuIFVJTlQKICAgICAgY2FzZSAndWludDE2JzogcmV0dXJuIFVJTlQKICAgICAgY2FzZSAndWludDI0JzogcmV0dXJuIFVJTlQKICAgICAgY2FzZSAndWludDMyJzogcmV0dXJuIFVJTlQKICAgICAgY2FzZSAndWludDQwJzogcmV0dXJuIFVJTlQKICAgICAgY2FzZSAndWludDQ4JzogcmV0dXJuIFVJTlQKICAgICAgY2FzZSAndWludDU2JzogcmV0dXJuIFVJTlQKICAgICAgY2FzZSAndWludDY0JzogcmV0dXJuIFVJTlQKICAgICAgY2FzZSAnc3RyaW5nJzogcmV0dXJuIFNUUklORwogICAgICBjYXNlICd1dGY4JzogcmV0dXJuIFNUUklORwogICAgICBjYXNlICdhc2NpaSc6IHJldHVybiBTVFJJTkcKICAgICAgY2FzZSAnaGV4JzogcmV0dXJuIFNUUklORwogICAgICBjYXNlICdiYXNlNjQnOiByZXR1cm4gU1RSSU5HCiAgICAgIGNhc2UgJ2ZpeGVkMzInOiByZXR1cm4gQlVGRkVSCiAgICAgIGNhc2UgJ2ZpeGVkNjQnOiByZXR1cm4gQlVGRkVSCiAgICAgIGNhc2UgJ2J1ZmZlcic6IHJldHVybiBCVUZGRVIKICAgICAgY2FzZSAnYm9vbCc6IHJldHVybiBCT09MCiAgICB9CgogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHR5cGUnKQogIH0KCiAgZW5jb2RlIChrZXlzKSB7CiAgICByZXR1cm4gdGhpcy5fZW5jb2RlKGtleXMsIGZhbHNlKQogIH0KCiAgX2VuY29kZSAoa2V5cywgdGVybWluYXRlKSB7CiAgICBpZiAoYjRhLmlzQnVmZmVyKGtleXMpKSByZXR1cm4ga2V5cwoKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiAwLCBidWZmZXI6IG51bGwgfQoKICAgIGlmICh0aGlzLnByZWZpeCAhPT0gLTEpIFVJTlQucHJlZW5jb2RlKHN0YXRlLCB0aGlzLnByZWZpeCkKICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICB0aGlzLmVuY29kaW5nc1tpXS5wcmVlbmNvZGUoc3RhdGUsIGtleXNbaV0pCiAgICB9CgogICAgaWYgKHRlcm1pbmF0ZSAmJiBrZXlzLmxlbmd0aCA8IHRoaXMuZW5jb2RpbmdzLmxlbmd0aCkgewogICAgICBzdGF0ZS5lbmQrKwogICAgfQoKICAgIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShzdGF0ZS5lbmQpCgogICAgaWYgKHRoaXMucHJlZml4ICE9PSAtMSkgVUlOVC5lbmNvZGUoc3RhdGUsIHRoaXMucHJlZml4KQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHRoaXMuZW5jb2RpbmdzW2ldLmVuY29kZShzdGF0ZSwga2V5c1tpXSkKICAgIH0KCiAgICBpZiAodGVybWluYXRlICYmIGtleXMubGVuZ3RoIDwgdGhpcy5lbmNvZGluZ3MubGVuZ3RoKSB7CiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IE1BWFswXQogICAgfQoKICAgIHJldHVybiBzdGF0ZS5idWZmZXIKICB9CgogIGRlY29kZSAoYnVmZmVyKSB7CiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGgsIGJ1ZmZlciB9CiAgICBjb25zdCByZXN1bHQgPSBbXQoKICAgIGlmICh0aGlzLnByZWZpeCAhPT0gLTEpIFVJTlQuZGVjb2RlKHN0YXRlKQogICAgZm9yIChjb25zdCBlbmMgb2YgdGhpcy5lbmNvZGluZ3MpIHsKICAgICAgY29uc3Qga2V5ID0gc3RhdGUuc3RhcnQgPCBzdGF0ZS5lbmQgPyBlbmMuZGVjb2RlKHN0YXRlKSA6IChlbmMgPT09IFVJTlQgPyAwIDogbnVsbCkKICAgICAgcmVzdWx0LnB1c2goa2V5KQogICAgfQoKICAgIHJldHVybiByZXN1bHQKICB9CgogIGVuY29kZVJhbmdlICh7IGd0LCBndGUsIGx0LCBsdGUgfSkgewogICAgY29uc3QgcmFuZ2UgPSB7CiAgICAgIGd0OiBndCAmJiB0aGlzLl9lbmNvZGUoZ3QsIHRydWUpLAogICAgICBndGU6IGd0ZSAmJiB0aGlzLl9lbmNvZGUoZ3RlLCBmYWxzZSksCiAgICAgIGx0OiBsdCAmJiB0aGlzLl9lbmNvZGUobHQsIGZhbHNlKSwKICAgICAgbHRlOiBsdGUgJiYgdGhpcy5fZW5jb2RlKGx0ZSwgdHJ1ZSkKICAgIH0KCiAgICBpZiAodGhpcy5wcmVmaXggIT09IC0xKSB7CiAgICAgIGlmICghZ3QgJiYgIWd0ZSkgcmFuZ2UuZ3RlID0gZW5jb2RlVWludCh0aGlzLnByZWZpeCkKICAgICAgaWYgKCFsdCAmJiAhbHRlKSByYW5nZS5sdCA9IGVuY29kZVVpbnQodGhpcy5wcmVmaXggKyAxKQogICAgfQoKICAgIHJldHVybiByYW5nZQogIH0KfQoKZnVuY3Rpb24gZW5jb2RlVWludCAobikgewogIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiAwLCBidWZmZXI6IG51bGwgfQogIFVJTlQucHJlZW5jb2RlKHN0YXRlLCBuKQogIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShzdGF0ZS5lbmQpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIG4pCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlcgp9CgpmdW5jdGlvbiBlbmNvZGVVaW50MzIgKHN0YXRlLCBuKSB7CiAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gMjQKICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuID4+PiAxNgogIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDgKICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuCn0KCmZ1bmN0aW9uIGRlY29kZVVpbnQzMiAoc3RhdGUsIG4pIHsKICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA0KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogIHJldHVybiAoCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMDAwMDAgKwogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMHgxMDAwMCArCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMCArCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICApCn0KewogICJuYW1lIjogImluZGV4LWVuY29kZXIiLAogICJ2ZXJzaW9uIjogIjMuNC4wIiwKICAiZGVzY3JpcHRpb24iOiAiRW5jb2RlIG11bHRpcGxlIHZhbHVlcyBpbnRvIHNvcnRlZCBrZXlzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi40IgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjIuMSIsCiAgICAiaHlwZXJiZWUiOiAiXjIuMTAuNSIsCiAgICAiaHlwZXJjb3JlIjogIl4xMC45LjIiLAogICAgInJhbmRvbS1hY2Nlc3MtbWVtb3J5IjogIl42LjIuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaW5kZXgtZW5jb2Rlci5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaW5kZXgtZW5jb2Rlci9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2luZGV4LWVuY29kZXIiCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gaXNPcHRpb25zIChvcHRzKSB7CiAgcmV0dXJuIHR5cGVvZiBvcHRzID09PSAnb2JqZWN0JyAmJiBvcHRzICYmICFiNGEuaXNCdWZmZXIob3B0cykKfQp7CiAgIm5hbWUiOiAiaXMtb3B0aW9ucyIsCiAgInZlcnNpb24iOiAiMS4wLjIiLAogICJkZXNjcmlwdGlvbiI6ICJFYXNpbHkgY2hlY2sgaWYgaW5wdXQgaXMgYW4gb3B0aW9ucyBtYXAiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS4xLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xMS4wLjEiLAogICAgInRhcGUiOiAiXjQuOS4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiB0YXBlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvaXMtb3B0aW9ucy5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvaXMtb3B0aW9ucy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9pcy1vcHRpb25zIgp9CmNvbnN0IHsgRXZlbnRFbWl0dGVyIH0gPSByZXF1aXJlKCdldmVudHMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSb3V0aW5nVGFibGUgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yIChpZCwgb3B0cykgewogICAgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgICBzdXBlcigpCgogICAgdGhpcy5pZCA9IGlkCiAgICB0aGlzLmsgPSBvcHRzLmsgfHwgMjAKICAgIHRoaXMuc2l6ZSA9IDAKICAgIHRoaXMucm93cyA9IG5ldyBBcnJheShpZC5sZW5ndGggKiA4KQogIH0KCiAgYWRkIChub2RlKSB7CiAgICBjb25zdCBpID0gdGhpcy5fZGlmZihub2RlLmlkKQoKICAgIGxldCByb3cgPSB0aGlzLnJvd3NbaV0KCiAgICBpZiAoIXJvdykgewogICAgICByb3cgPSB0aGlzLnJvd3NbaV0gPSBuZXcgUm93KHRoaXMsIGkpCiAgICAgIHRoaXMuZW1pdCgncm93Jywgcm93KQogICAgfQoKICAgIGNvbnN0IGxlbiA9IHJvdy5ub2Rlcy5sZW5ndGgKICAgIGlmICghcm93LmFkZChub2RlLCB0aGlzLmspKSByZXR1cm4gZmFsc2UKCiAgICB0aGlzLnNpemUgKz0gcm93Lm5vZGVzLmxlbmd0aCAtIGxlbgogICAgcmV0dXJuIHRydWUKICB9CgogIHJlbW92ZSAoaWQpIHsKICAgIGNvbnN0IGkgPSB0aGlzLl9kaWZmKGlkKQogICAgY29uc3Qgcm93ID0gdGhpcy5yb3dzW2ldCiAgICBpZiAoIXJvdykgcmV0dXJuIGZhbHNlCiAgICBpZiAoIXJvdy5yZW1vdmUoaWQpKSByZXR1cm4gZmFsc2UKICAgIHRoaXMuc2l6ZS0tCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgZ2V0IChpZCkgewogICAgY29uc3QgaSA9IHRoaXMuX2RpZmYoaWQpCiAgICBjb25zdCByb3cgPSB0aGlzLnJvd3NbaV0KICAgIGlmICghcm93KSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHJvdy5nZXQoaWQpCiAgfQoKICBoYXMgKGlkKSB7CiAgICByZXR1cm4gdGhpcy5nZXQoaWQpICE9PSBudWxsCiAgfQoKICByYW5kb20gKCkgewogICAgbGV0IG4gPSAoTWF0aC5yYW5kb20oKSAqIHRoaXMuc2l6ZSkgfCAwCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnJvd3MubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgciA9IHRoaXMucm93c1tpXQogICAgICBpZiAoIXIpIGNvbnRpbnVlCiAgICAgIGlmIChuIDwgci5ub2Rlcy5sZW5ndGgpIHJldHVybiByLm5vZGVzW25dCiAgICAgIG4gLT0gci5ub2Rlcy5sZW5ndGgKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgY2xvc2VzdCAoaWQsIGspIHsKICAgIGlmICghaykgayA9IHRoaXMuawoKICAgIGNvbnN0IHJlc3VsdCA9IFtdCiAgICBjb25zdCBkID0gdGhpcy5fZGlmZihpZCkKCiAgICAvLyBwdXNoIGNsb3NlIG5vZGVzCiAgICBmb3IgKGxldCBpID0gZDsgaSA+PSAwICYmIHJlc3VsdC5sZW5ndGggPCBrOyBpLS0pIHRoaXMuX3B1c2hOb2RlcyhpLCBrLCByZXN1bHQpCgogICAgLy8gaWYgd2UgZG9uJ3QgaGF2ZSBlbm91Z2ggY2xvc2Ugbm9kZXMsIHBvcHVsYXRlIGZyb20gb3RoZXIgcm93cywgcmUgdGhlIHBhcGVyCiAgICBmb3IgKGxldCBpID0gZCArIDE7IGkgPCB0aGlzLnJvd3MubGVuZ3RoICYmIHJlc3VsdC5sZW5ndGggPCBrOyBpKyspIHRoaXMuX3B1c2hOb2RlcyhpLCBrLCByZXN1bHQpCgogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgX3B1c2hOb2RlcyAoaSwgaywgcmVzdWx0KSB7CiAgICBjb25zdCByb3cgPSB0aGlzLnJvd3NbaV0KICAgIGlmICghcm93KSByZXR1cm4KCiAgICBjb25zdCBtaXNzaW5nID0gTWF0aC5taW4oayAtIHJlc3VsdC5sZW5ndGgsIHJvdy5ub2Rlcy5sZW5ndGgpCiAgICBmb3IgKGxldCBqID0gMDsgaiA8IG1pc3Npbmc7IGorKykgcmVzdWx0LnB1c2gocm93Lm5vZGVzW2pdKQogIH0KCiAgdG9BcnJheSAoKSB7CiAgICByZXR1cm4gdGhpcy5jbG9zZXN0KHRoaXMuaWQsIEluZmluaXR5KQogIH0KCiAgX2RpZmYgKGlkKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGlkLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGEgPSBpZFtpXQogICAgICBjb25zdCBiID0gdGhpcy5pZFtpXQoKICAgICAgaWYgKGEgIT09IGIpIHJldHVybiBpICogOCArIE1hdGguY2x6MzIoYSBeIGIpIC0gMjQKICAgIH0KCiAgICByZXR1cm4gdGhpcy5yb3dzLmxlbmd0aCAtIDEKICB9Cn0KCmNsYXNzIFJvdyBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IgKHRhYmxlLCBpbmRleCkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuZGF0YSA9IG51bGwgLy8gY2FuIGJlIHVzZWQgYmUgdXBzdHJlYW0gZm9yIHdoYXRldnMKICAgIHRoaXMuYnl0ZU9mZnNldCA9IGluZGV4ID4+IDMKICAgIHRoaXMuaW5kZXggPSBpbmRleAogICAgdGhpcy50YWJsZSA9IHRhYmxlCiAgICB0aGlzLm5vZGVzID0gW10KICB9CgogIGFkZCAobm9kZSkgewogICAgY29uc3QgaWQgPSBub2RlLmlkCgogICAgbGV0IGwgPSAwCiAgICBsZXQgciA9IHRoaXMubm9kZXMubGVuZ3RoIC0gMQoKICAgIHdoaWxlIChsIDw9IHIpIHsKICAgICAgY29uc3QgbSA9IChsICsgcikgPj4gMQogICAgICBjb25zdCBjID0gdGhpcy5jb21wYXJlKGlkLCB0aGlzLm5vZGVzW21dLmlkKQoKICAgICAgaWYgKGMgPT09IDApIHsKICAgICAgICB0aGlzLm5vZGVzW21dID0gbm9kZQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KCiAgICAgIGlmIChjIDwgMCkgciA9IG0gLSAxCiAgICAgIGVsc2UgbCA9IG0gKyAxCiAgICB9CgogICAgaWYgKHRoaXMubm9kZXMubGVuZ3RoID49IHRoaXMudGFibGUuaykgewogICAgICB0aGlzLmVtaXQoJ2Z1bGwnLCBub2RlKQogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICB0aGlzLmluc2VydChsLCBub2RlKQogICAgcmV0dXJuIHRydWUKICB9CgogIHJlbW92ZSAoaWQpIHsKICAgIGxldCBsID0gMAogICAgbGV0IHIgPSB0aGlzLm5vZGVzLmxlbmd0aCAtIDEKCiAgICB3aGlsZSAobCA8PSByKSB7CiAgICAgIGNvbnN0IG0gPSAobCArIHIpID4+IDEKICAgICAgY29uc3QgYyA9IHRoaXMuY29tcGFyZShpZCwgdGhpcy5ub2Rlc1ttXS5pZCkKCiAgICAgIGlmIChjID09PSAwKSB7CiAgICAgICAgdGhpcy5zcGxpY2UobSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CgogICAgICBpZiAoYyA8IDApIHIgPSBtIC0gMQogICAgICBlbHNlIGwgPSBtICsgMQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgZ2V0IChpZCkgewogICAgbGV0IGwgPSAwCiAgICBsZXQgciA9IHRoaXMubm9kZXMubGVuZ3RoIC0gMQoKICAgIHdoaWxlIChsIDw9IHIpIHsKICAgICAgY29uc3QgbSA9IChsICsgcikgPj4gMQogICAgICBjb25zdCBub2RlID0gdGhpcy5ub2Rlc1ttXQogICAgICBjb25zdCBjID0gdGhpcy5jb21wYXJlKGlkLCBub2RlLmlkKQoKICAgICAgaWYgKGMgPT09IDApIHJldHVybiBub2RlCiAgICAgIGlmIChjIDwgMCkgciA9IG0gLSAxCiAgICAgIGVsc2UgbCA9IG0gKyAxCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIGluc2VydCAoaSwgbm9kZSkgewogICAgdGhpcy5ub2Rlcy5wdXNoKG5vZGUpIC8vIHB1c2ggbm9kZSBvciBudWxsIG9yIHdoYXRldnMsIGp1c3QgdHJ5aW5nIHRvIG5vdCBiZSBwb2x5bW9ycGhpYwogICAgZm9yIChsZXQgaiA9IHRoaXMubm9kZXMubGVuZ3RoIC0gMTsgaiA+IGk7IGotLSkgdGhpcy5ub2Rlc1tqXSA9IHRoaXMubm9kZXNbaiAtIDFdCiAgICB0aGlzLm5vZGVzW2ldID0gbm9kZQogICAgdGhpcy5lbWl0KCdhZGQnLCBub2RlKQogIH0KCiAgc3BsaWNlIChpKSB7CiAgICBmb3IgKDsgaSA8IHRoaXMubm9kZXMubGVuZ3RoIC0gMTsgaSsrKSB0aGlzLm5vZGVzW2ldID0gdGhpcy5ub2Rlc1tpICsgMV0KICAgIHRoaXMuZW1pdCgncmVtb3ZlJywgdGhpcy5ub2Rlcy5wb3AoKSkKICB9CgogIC8vIHZlcnkgbGlrZWx5IHRoZXkgZGl2ZXJnZSBhZnRlciBhIGNvdXBsZSBvZiBieXRlcyBzbyBhIHNpbXBsZSBpbXBsLCBsaWtlIHRoaXMgaXMgcHJvcCBmYXN0ZXN0IHZzIEJ1ZmZlci5jb21wYXJlCiAgY29tcGFyZSAoYSwgYikgewogICAgZm9yIChsZXQgaSA9IHRoaXMuYnl0ZU9mZnNldDsgaSA8IGEubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYWkgPSBhW2ldCiAgICAgIGNvbnN0IGJpID0gYltpXQogICAgICBpZiAoYWkgPT09IGJpKSBjb250aW51ZQogICAgICByZXR1cm4gYWkgPCBiaSA/IC0xIDogMQogICAgfQogICAgcmV0dXJuIDAKICB9Cn0KewogICJuYW1lIjogImthZGVtbGlhLXJvdXRpbmctdGFibGUiLAogICJ2ZXJzaW9uIjogIjEuMC42IiwKICAiZGVzY3JpcHRpb24iOiAiWE9SIGJhc2VkIHJvdXRpbmcgdGFibGUgdXNlZCBmb3IgUDJQIG5ldHdvcmtzIHN1Y2ggYXMgYSBLYWRlbWxpYSBESFQuIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImltcG9ydHMiOiB7CiAgICAiZXZlbnRzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWV2ZW50cyIsCiAgICAgICJkZWZhdWx0IjogImV2ZW50cyIKICAgIH0KICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1ldmVudHMiOiAiXjIuMi4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjMuMiIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgImtleXdvcmRzIjogWwogICAgImthZGVtbGlhIiwKICAgICJwMnAiLAogICAgImstYnVja2V0IiwKICAgICJrLWJ1Y2tldHMiLAogICAgInhvciIsCiAgICAicm91dGluZyIsCiAgICAiZGlzdHJpYnV0ZWQiLAogICAgInN5c3RlbXMiCiAgXSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gva2FkZW1saWEtcm91dGluZy10YWJsZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gva2FkZW1saWEtcm91dGluZy10YWJsZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlIgp9CnZhciBxdWV1ZVRpY2sgPSByZXF1aXJlKCdxdWV1ZS10aWNrJykKCnZhciBtdXRleGlmeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgcXVldWUgPSBbXQogIHZhciB1c2VkID0gbnVsbAoKICB2YXIgY2FsbCA9IGZ1bmN0aW9uICgpIHsKICAgIHVzZWQocmVsZWFzZSkKICB9CgogIHZhciBhY3F1aXJlID0gZnVuY3Rpb24gKGZuKSB7CiAgICBpZiAodXNlZCkgcmV0dXJuIHF1ZXVlLnB1c2goZm4pCiAgICB1c2VkID0gZm4KICAgIGFjcXVpcmUubG9ja2VkID0gdHJ1ZQogICAgcXVldWVUaWNrKGNhbGwpCiAgICByZXR1cm4gMAogIH0KCiAgYWNxdWlyZS5sb2NrZWQgPSBmYWxzZQoKICB2YXIgcmVsZWFzZSA9IGZ1bmN0aW9uIChmbiwgZXJyLCB2YWx1ZSkgewogICAgdXNlZCA9IG51bGwKICAgIGFjcXVpcmUubG9ja2VkID0gZmFsc2UKICAgIGlmIChxdWV1ZS5sZW5ndGgpIGFjcXVpcmUocXVldWUuc2hpZnQoKSkKICAgIGlmIChmbikgZm4oZXJyLCB2YWx1ZSkKICB9CgogIHJldHVybiBhY3F1aXJlCn0KCm1vZHVsZS5leHBvcnRzID0gbXV0ZXhpZnkKewogICJuYW1lIjogIm11dGV4aWZ5IiwKICAidmVyc2lvbiI6ICIxLjQuMCIsCiAgImRlc2NyaXB0aW9uIjogIm11dGV4IGxvY2sgZm9yIGphdmFzY3JpcHQiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgInF1ZXVlLXRpY2siOiAiXjEuMC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTQuMy4zIiwKICAgICJ0YXBlIjogIl4zLjAuMiIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAidGFwZSB0ZXN0LmpzIiwKICAgICJwb3N0dGVzdCI6ICJucG0gcnVuIGxpbnQiLAogICAgImxpbnQiOiAic3RhbmRhcmQiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvbXV0ZXhpZnkuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL211dGV4aWZ5L2lzc3VlcyIKICB9LAogICJrZXl3b3JkcyI6IFsKICAgICJtdXRleCIsCiAgICAibG9jayIKICBdLAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL211dGV4aWZ5Igp9CnZhciBtdXRleGlmeSA9IHJlcXVpcmUoJy4nKQoKdmFyIG11dGV4aWZ5UHJvbWlzZSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgbG9jayA9IG11dGV4aWZ5KCkKCiAgdmFyIGFjcXVpcmUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UobG9jaykKICB9CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShhY3F1aXJlLCAnbG9ja2VkJywgewogICAgZ2V0OiBmdW5jdGlvbiAoKSB7IHJldHVybiBsb2NrLmxvY2tlZCB9LAogICAgZW51bWVyYWJsZTogdHJ1ZQogIH0pCgogIHJldHVybiBhY3F1aXJlCn0KCm1vZHVsZS5leHBvcnRzID0gbXV0ZXhpZnlQcm9taXNlCm1vZHVsZS5leHBvcnRzID0gYXNzZXJ0CgpjbGFzcyBBc3NlcnRpb25FcnJvciBleHRlbmRzIEVycm9yIHt9CkFzc2VydGlvbkVycm9yLnByb3RvdHlwZS5uYW1lID0gJ0Fzc2VydGlvbkVycm9yJwoKLyoqCiAqIE1pbmltYWwgYXNzZXJ0IGZ1bmN0aW9uCiAqIEBwYXJhbSAge2FueX0gdCBWYWx1ZSB0byBjaGVjayBpZiBmYWxzeQogKiBAcGFyYW0gIHtzdHJpbmc9fSBtIE9wdGlvbmFsIGFzc2VydGlvbiBlcnJvciBtZXNzYWdlCiAqIEB0aHJvd3Mge0Fzc2VydGlvbkVycm9yfQogKi8KZnVuY3Rpb24gYXNzZXJ0ICh0LCBtKSB7CiAgaWYgKCF0KSB7CiAgICB2YXIgZXJyID0gbmV3IEFzc2VydGlvbkVycm9yKG0pCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKGVyciwgYXNzZXJ0KQogICAgdGhyb3cgZXJyCiAgfQp9CnsKICAibmFtZSI6ICJuYW5vYXNzZXJ0IiwKICAidmVyc2lvbiI6ICIyLjAuMCIsCiAgImRlc2NyaXB0aW9uIjogIk5hbm9zY2FsZSBhc3NlcnRpb24gbW9kdWxlIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAidGFwZSI6ICJeNC45LjEiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInRhcGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9lbWlsYmF5ZXMvbmFub2Fzc2VydC5naXQiCiAgfSwKICAia2V5d29yZHMiOiBbCiAgICAiYXNzZXJ0IiwKICAgICJ1bmFzc2VydCIsCiAgICAicG93ZXItYXNzZXJ0IiwKICAgICJ0aW55IiwKICAgICJuYW5vIiwKICAgICJwaWNvIgogIF0sCiAgImF1dGhvciI6ICJFbWlsIEJheSA8Z2l0aHViQHRpeHouZGs+IiwKICAibGljZW5zZSI6ICJJU0MiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vZW1pbGJheWVzL25hbm9hc3NlcnQvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9lbWlsYmF5ZXMvbmFub2Fzc2VydCNyZWFkbWUiCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBOYXRTYW1wbGVyIHsKICBjb25zdHJ1Y3RvciAoKSB7CiAgICB0aGlzLmhvc3QgPSBudWxsCiAgICB0aGlzLnBvcnQgPSAwCiAgICB0aGlzLnNpemUgPSAwCgogICAgdGhpcy5fYSA9IG51bGwKICAgIHRoaXMuX2IgPSBudWxsCiAgICB0aGlzLl90aHJlc2hvbGQgPSAwCiAgICB0aGlzLl90b3AgPSAwCiAgICB0aGlzLl9zYW1wbGVzID0gW10KICB9CgogIGFkZCAoaG9zdCwgcG9ydCkgewogICAgY29uc3QgYSA9IHRoaXMuX2J1bXAoaG9zdCwgcG9ydCwgMikKICAgIGNvbnN0IGIgPSB0aGlzLl9idW1wKGhvc3QsIDAsIDEpCgogICAgaWYgKHRoaXMuX3NhbXBsZXMubGVuZ3RoIDwgMzIpIHsKICAgICAgdGhpcy5zaXplKysKICAgICAgdGhpcy5fdGhyZXNob2xkID0gdGhpcy5zaXplIC0gKHRoaXMuc2l6ZSA8IDQgPyAwIDogdGhpcy5zaXplIDwgOCA/IDEgOiB0aGlzLnNpemUgPCAxMiA/IDIgOiAzKQogICAgICB0aGlzLl9zYW1wbGVzLnB1c2goYSwgYikKICAgICAgdGhpcy5fdG9wICs9IDIKICAgIH0gZWxzZSB7CiAgICAgIGlmICh0aGlzLl90b3AgPT09IDMyKSB0aGlzLl90b3AgPSAwCgogICAgICBjb25zdCBvYSA9IHRoaXMuX3NhbXBsZXNbdGhpcy5fdG9wXQogICAgICB0aGlzLl9zYW1wbGVzW3RoaXMuX3RvcCsrXSA9IGEKICAgICAgb2EuaGl0cy0tCgogICAgICBjb25zdCBvYiA9IHRoaXMuX3NhbXBsZXNbdGhpcy5fdG9wXQogICAgICB0aGlzLl9zYW1wbGVzW3RoaXMuX3RvcCsrXSA9IGIKICAgICAgb2IuaGl0cy0tCiAgICB9CgogICAgaWYgKHRoaXMuX2EgPT09IG51bGwgfHwgdGhpcy5fYS5oaXRzIDwgYS5oaXRzKSB0aGlzLl9hID0gYQogICAgaWYgKHRoaXMuX2IgPT09IG51bGwgfHwgdGhpcy5fYi5oaXRzIDwgYi5oaXRzKSB0aGlzLl9iID0gYgoKICAgIGlmICh0aGlzLl9hLmhpdHMgPj0gdGhpcy5fdGhyZXNob2xkKSB7CiAgICAgIHRoaXMuaG9zdCA9IHRoaXMuX2EuaG9zdAogICAgICB0aGlzLnBvcnQgPSB0aGlzLl9hLnBvcnQKICAgIH0gZWxzZSBpZiAodGhpcy5fYi5oaXRzID49IHRoaXMuX3RocmVzaG9sZCkgewogICAgICB0aGlzLmhvc3QgPSB0aGlzLl9iLmhvc3QKICAgICAgdGhpcy5wb3J0ID0gMAogICAgfSBlbHNlIHsKICAgICAgdGhpcy5ob3N0ID0gbnVsbAogICAgICB0aGlzLnBvcnQgPSAwCiAgICB9CgogICAgcmV0dXJuIGEuaGl0cwogIH0KCiAgX2J1bXAgKGhvc3QsIHBvcnQsIGluYykgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHsKICAgICAgY29uc3QgaiA9ICh0aGlzLl90b3AgLSBpbmMgLSAoMiAqIGkpKSAmIDMxCiAgICAgIGlmIChqID49IHRoaXMuX3NhbXBsZXMubGVuZ3RoKSByZXR1cm4geyBob3N0LCBwb3J0LCBoaXRzOiAxIH0KICAgICAgY29uc3QgcyA9IHRoaXMuX3NhbXBsZXNbal0KICAgICAgaWYgKHMucG9ydCA9PT0gcG9ydCAmJiBzLmhvc3QgPT09IGhvc3QpIHsKICAgICAgICBzLmhpdHMrKwogICAgICAgIHJldHVybiBzCiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7IGhvc3QsIHBvcnQsIGhpdHM6IDEgfQogIH0KfQp7CiAgIm5hbWUiOiAibmF0LXNhbXBsZXIiLAogICJ2ZXJzaW9uIjogIjEuMC4xIiwKICAiZGVzY3JpcHRpb24iOiAiU2FtcGxlIGFkZHJlc3NlcyB0byBmaWd1cmUgb3V0IGlmIGEgaG9zdCArIHBvcnQgaXMgY29uc2lzdGVudCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xNi4wLjMiLAogICAgInRhcGUiOiAiXjUuMi4yIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL25hdC1zYW1wbGVyLmdpdCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgdGFwZSB0ZXN0LmpzIgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL25hdC1zYW1wbGVyL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL25hdC1zYW1wbGVyIgp9Ci8qIGVzbGludC1kaXNhYmxlIGNhbWVsY2FzZSAqLwpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnbmFub2Fzc2VydCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBESExFTiA9IHNvZGl1bS5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X0JZVEVTCmNvbnN0IFBLTEVOID0gc29kaXVtLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfQllURVMKY29uc3QgU0NBTEFSTEVOID0gc29kaXVtLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfQllURVMKY29uc3QgU0tMRU4gPSBzb2RpdW0uY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMKY29uc3QgQUxHID0gJ0VkMjU1MTknCgptb2R1bGUuZXhwb3J0cyA9IHsKICBESExFTiwKICBQS0xFTiwKICBTQ0FMQVJMRU4sCiAgU0tMRU4sCiAgQUxHLAogIG5hbWU6IEFMRywKICBnZW5lcmF0ZUtleVBhaXIsCiAgZGgKfQoKZnVuY3Rpb24gZ2VuZXJhdGVLZXlQYWlyIChwcml2S2V5KSB7CiAgaWYgKHByaXZLZXkpIHJldHVybiBnZW5lcmF0ZVNlZWRLZXlQYWlyKHByaXZLZXkuc3ViYXJyYXkoMCwgMzIpKQoKICBjb25zdCBrZXlQYWlyID0ge30KICBrZXlQYWlyLnNlY3JldEtleSA9IGI0YS5hbGxvYyhTS0xFTikKICBrZXlQYWlyLnB1YmxpY0tleSA9IGI0YS5hbGxvYyhQS0xFTikKCiAgc29kaXVtLmNyeXB0b19zaWduX2tleXBhaXIoa2V5UGFpci5wdWJsaWNLZXksIGtleVBhaXIuc2VjcmV0S2V5KQogIHJldHVybiBrZXlQYWlyCn0KCmZ1bmN0aW9uIGdlbmVyYXRlU2VlZEtleVBhaXIgKHNlZWQpIHsKICBjb25zdCBrZXlQYWlyID0ge30KICBrZXlQYWlyLnNlY3JldEtleSA9IGI0YS5hbGxvYyhTS0xFTikKICBrZXlQYWlyLnB1YmxpY0tleSA9IGI0YS5hbGxvYyhQS0xFTikKCiAgc29kaXVtLmNyeXB0b19zaWduX3NlZWRfa2V5cGFpcihrZXlQYWlyLnB1YmxpY0tleSwga2V5UGFpci5zZWNyZXRLZXksIHNlZWQpCiAgcmV0dXJuIGtleVBhaXIKfQoKZnVuY3Rpb24gZGggKHB1YmxpY0tleSwgeyBzY2FsYXIsIHNlY3JldEtleSB9KSB7CiAgLy8gdHdlYWtlZCBrZXlzIGV4cG9zZSBzY2FsYXIgZGlyZWN0bHkKICBpZiAoIXNjYWxhcikgewogICAgYXNzZXJ0KHNlY3JldEtleS5ieXRlTGVuZ3RoID09PSBTS0xFTikKCiAgICAvLyBsaWJzb2RpdW0gc3RvcmVzIHNlZWQgbm90IGFjdHVhbCBzY2FsYXIKICAgIGNvbnN0IHNrID0gYjRhLmFsbG9jKDY0KQogICAgc29kaXVtLmNyeXB0b19oYXNoX3NoYTUxMihzaywgc2VjcmV0S2V5LnN1YmFycmF5KDAsIDMyKSkKICAgIHNrWzBdICY9IDI0OAogICAgc2tbMzFdICY9IDEyNwogICAgc2tbMzFdIHw9IDY0CgogICAgc2NhbGFyID0gc2suc3ViYXJyYXkoMCwgMzIpCiAgfQoKICBhc3NlcnQoc2NhbGFyLmJ5dGVMZW5ndGggPT09IFNDQUxBUkxFTikKICBhc3NlcnQocHVibGljS2V5LmJ5dGVMZW5ndGggPT09IFBLTEVOKQoKICBjb25zdCBvdXRwdXQgPSBiNGEuYWxsb2MoREhMRU4pCgogIC8vIHdlIGNsYW1wIGlmIG5lY2Vzc2FyeSBhYm92ZQogIHNvZGl1bS5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X25vY2xhbXAoCiAgICBvdXRwdXQsCiAgICBzY2FsYXIsCiAgICBwdWJsaWNLZXkKICApCgogIHJldHVybiBvdXRwdXQKfQp7CiAgIm5hbWUiOiAibm9pc2UtY3VydmUtZWQiLAogICJ2ZXJzaW9uIjogIjIuMS4wIiwKICAiZGVzY3JpcHRpb24iOiAiRWQyNTUxOSBlbGxpcHRpYyBjdXJ2ZSBvcGVyYXRpb25zIGZvciBbYG5vaXNlLWhhbmRzaGFrZWBdKGh0dHBzOi8vZ2l0aHViLmNvbS9jaG0tZGllZGVyaWNocy9ub2lzZS1oYW5kc2hha2UpIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJucHggc3RhbmRhcmQgJiYgdGFwZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2NobS1kaWVkZXJpY2hzL25vaXNlLWN1cnZlLWVkLmdpdCIKICB9LAogICJrZXl3b3JkcyI6IFtdLAogICJhdXRob3IiOiAiIiwKICAibGljZW5zZSI6ICJJU0MiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vY2htLWRpZWRlcmljaHMvbm9pc2UtY3VydmUtZWQvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9jaG0tZGllZGVyaWNocy9ub2lzZS1jdXJ2ZS1lZCNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjEuMCIsCiAgICAibmFub2Fzc2VydCI6ICJeMi4wLjAiLAogICAgInNvZGl1bS11bml2ZXJzYWwiOiAiXjUuMC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJub2lzZS1oYW5kc2hha2UiOiAiXjMuMC4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTYuMC4zIiwKICAgICJ0YXBlIjogIl41LjIuMiIKICB9Cn0KY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENpcGhlclN0YXRlIHsKICBjb25zdHJ1Y3RvciAoa2V5KSB7CiAgICB0aGlzLmtleSA9IGtleSB8fCBudWxsCiAgICB0aGlzLm5vbmNlID0gMAogICAgdGhpcy5DSVBIRVJfQUxHID0gJ0NoYUNoYVBvbHknCiAgfQoKICBpbml0aWFsaXNlS2V5IChrZXkpIHsKICAgIHRoaXMua2V5ID0ga2V5CiAgICB0aGlzLm5vbmNlID0gMAogIH0KCiAgc2V0Tm9uY2UgKG5vbmNlKSB7CiAgICB0aGlzLm5vbmNlID0gbm9uY2UKICB9CgogIGVuY3J5cHQgKHBsYWludGV4dCwgYWQpIHsKICAgIGlmICghdGhpcy5oYXNLZXkpIHJldHVybiBwbGFpbnRleHQKICAgIGlmICghYWQpIGFkID0gYjRhLmFsbG9jKDApCgogICAgY29uc3QgY2lwaGVydGV4dCA9IGVuY3J5cHRXaXRoQUQodGhpcy5rZXksIHRoaXMubm9uY2UsIGFkLCBwbGFpbnRleHQpCiAgICBpZiAoY2lwaGVydGV4dC5sZW5ndGggPiA2NTUzNSkgdGhyb3cgbmV3IEVycm9yKGBjaXBoZXJ0ZXh0IGxlbmd0aCBvZiAke2NpcGhlcnRleHQubGVuZ3RofSBleGNlZWRzIG1heGltdW0gTm9pc2UgbWVzc2FnZSBsZW5ndGggb2YgNjU1MzVgKQogICAgdGhpcy5ub25jZSsrCgogICAgcmV0dXJuIGNpcGhlcnRleHQKICB9CgogIGRlY3J5cHQgKGNpcGhlcnRleHQsIGFkKSB7CiAgICBpZiAoIXRoaXMuaGFzS2V5KSByZXR1cm4gY2lwaGVydGV4dAogICAgaWYgKCFhZCkgYWQgPSBiNGEuYWxsb2MoMCkKICAgIGlmIChjaXBoZXJ0ZXh0Lmxlbmd0aCA+IDY1NTM1KSB0aHJvdyBuZXcgRXJyb3IoYGNpcGhlcnRleHQgbGVuZ3RoIG9mICR7Y2lwaGVydGV4dC5sZW5ndGh9IGV4Y2VlZHMgbWF4aW11bSBOb2lzZSBtZXNzYWdlIGxlbmd0aCBvZiA2NTUzNWApCgogICAgY29uc3QgcGxhaW50ZXh0ID0gZGVjcnlwdFdpdGhBRCh0aGlzLmtleSwgdGhpcy5ub25jZSwgYWQsIGNpcGhlcnRleHQpCiAgICB0aGlzLm5vbmNlKysKCiAgICByZXR1cm4gcGxhaW50ZXh0CiAgfQoKICBnZXQgaGFzS2V5ICgpIHsKICAgIHJldHVybiB0aGlzLmtleSAhPT0gbnVsbAogIH0KCiAgX2NsZWFyICgpIHsKICAgIHNvZGl1bS5zb2RpdW1fbWVtemVybyh0aGlzLmtleSkKICAgIHRoaXMua2V5ID0gbnVsbAogICAgdGhpcy5ub25jZSA9IG51bGwKICB9CgogIHN0YXRpYyBnZXQgTUFDQllURVMgKCkgewogICAgcmV0dXJuIDE2CiAgfQoKICBzdGF0aWMgZ2V0IE5PTkNFQllURVMgKCkgewogICAgcmV0dXJuIDgKICB9CgogIHN0YXRpYyBnZXQgS0VZQllURVMgKCkgewogICAgcmV0dXJuIDMyCiAgfQp9CgpmdW5jdGlvbiBlbmNyeXB0V2l0aEFEIChrZXksIGNvdW50ZXIsIGFkZGl0aW9uYWxEYXRhLCBwbGFpbnRleHQpIHsKICAvLyBmb3Igb3VyIHB1cnBvc2VzLCBhZGRpdGlvbmFsRGF0YSB3aWxsIGFsd2F5cyBiZSBhIHB1YmtleSBzbyB3ZSBlbmNvZGUgZnJvbSBoZXgKICBpZiAoIWI0YS5pc0J1ZmZlcihhZGRpdGlvbmFsRGF0YSkpIGFkZGl0aW9uYWxEYXRhID0gYjRhLmZyb20oYWRkaXRpb25hbERhdGEsICdoZXgnKQogIGlmICghYjRhLmlzQnVmZmVyKHBsYWludGV4dCkpIHBsYWludGV4dCA9IGI0YS5mcm9tKHBsYWludGV4dCwgJ2hleCcpCgogIGNvbnN0IG5vbmNlID0gYjRhLmFsbG9jKHNvZGl1bS5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfTlBVQkJZVEVTKQogIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcobm9uY2UuYnVmZmVyLCBub25jZS5ieXRlT2Zmc2V0LCBub25jZS5ieXRlTGVuZ3RoKQogIHZpZXcuc2V0VWludDMyKDQsIGNvdW50ZXIsIHRydWUpCgogIGNvbnN0IGNpcGhlcnRleHQgPSBiNGEuYWxsb2MocGxhaW50ZXh0LmJ5dGVMZW5ndGggKyBzb2RpdW0uY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUykKCiAgc29kaXVtLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0KGNpcGhlcnRleHQsIHBsYWludGV4dCwgYWRkaXRpb25hbERhdGEsIG51bGwsIG5vbmNlLCBrZXkpCiAgcmV0dXJuIGNpcGhlcnRleHQKfQoKZnVuY3Rpb24gZGVjcnlwdFdpdGhBRCAoa2V5LCBjb3VudGVyLCBhZGRpdGlvbmFsRGF0YSwgY2lwaGVydGV4dCkgewogIC8vIGZvciBvdXIgcHVycG9zZXMsIGFkZGl0aW9uYWxEYXRhIHdpbGwgYWx3YXlzIGJlIGEgcHVia2V5IHNvIHdlIGVuY29kZSBmcm9tIGhleAogIGlmICghYjRhLmlzQnVmZmVyKGFkZGl0aW9uYWxEYXRhKSkgYWRkaXRpb25hbERhdGEgPSBiNGEuZnJvbShhZGRpdGlvbmFsRGF0YSwgJ2hleCcpCiAgaWYgKCFiNGEuaXNCdWZmZXIoY2lwaGVydGV4dCkpIGNpcGhlcnRleHQgPSBiNGEuZnJvbShjaXBoZXJ0ZXh0LCAnaGV4JykKCiAgY29uc3Qgbm9uY2UgPSBiNGEuYWxsb2Moc29kaXVtLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhub25jZS5idWZmZXIsIG5vbmNlLmJ5dGVPZmZzZXQsIG5vbmNlLmJ5dGVMZW5ndGgpCiAgdmlldy5zZXRVaW50MzIoNCwgY291bnRlciwgdHJ1ZSkKCiAgY29uc3QgcGxhaW50ZXh0ID0gYjRhLmFsbG9jKGNpcGhlcnRleHQuYnl0ZUxlbmd0aCAtIHNvZGl1bS5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTKQoKICBzb2RpdW0uY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHQocGxhaW50ZXh0LCBudWxsLCBjaXBoZXJ0ZXh0LCBhZGRpdGlvbmFsRGF0YSwgbm9uY2UsIGtleSkKICByZXR1cm4gcGxhaW50ZXh0Cn0KLyogZXNsaW50LWRpc2FibGUgY2FtZWxjYXNlICovCmNvbnN0IHsKICBjcnlwdG9fa3hfU0VFREJZVEVTLAogIGNyeXB0b19reF9rZXlwYWlyLAogIGNyeXB0b19reF9zZWVkX2tleXBhaXIsCiAgY3J5cHRvX3NjYWxhcm11bHRfQllURVMsCiAgY3J5cHRvX3NjYWxhcm11bHRfU0NBTEFSQllURVMsCiAgY3J5cHRvX3NjYWxhcm11bHQsCiAgY3J5cHRvX3NjYWxhcm11bHRfYmFzZQp9ID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCgpjb25zdCBhc3NlcnQgPSByZXF1aXJlKCduYW5vYXNzZXJ0JykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IERITEVOID0gY3J5cHRvX3NjYWxhcm11bHRfQllURVMKY29uc3QgUEtMRU4gPSBjcnlwdG9fc2NhbGFybXVsdF9CWVRFUwpjb25zdCBTS0xFTiA9IGNyeXB0b19zY2FsYXJtdWx0X1NDQUxBUkJZVEVTCmNvbnN0IFNFRURMRU4gPSBjcnlwdG9fa3hfU0VFREJZVEVTCmNvbnN0IEFMRyA9ICcyNTUxOScKCm1vZHVsZS5leHBvcnRzID0gewogIERITEVOLAogIFBLTEVOLAogIFNLTEVOLAogIFNFRURMRU4sCiAgQUxHLAogIGdlbmVyYXRlS2V5UGFpciwKICBnZW5lcmF0ZVNlZWRLZXlQYWlyLAogIGRoCn0KCmZ1bmN0aW9uIGdlbmVyYXRlS2V5UGFpciAocHJpdktleSkgewogIGNvbnN0IGtleVBhaXIgPSB7fQoKICBrZXlQYWlyLnNlY3JldEtleSA9IHByaXZLZXkgfHwgYjRhLmFsbG9jKFNLTEVOKQogIGtleVBhaXIucHVibGljS2V5ID0gYjRhLmFsbG9jKFBLTEVOKQoKICBpZiAocHJpdktleSkgewogICAgY3J5cHRvX3NjYWxhcm11bHRfYmFzZShrZXlQYWlyLnB1YmxpY0tleSwga2V5UGFpci5zZWNyZXRLZXkpCiAgfSBlbHNlIHsKICAgIGNyeXB0b19reF9rZXlwYWlyKGtleVBhaXIucHVibGljS2V5LCBrZXlQYWlyLnNlY3JldEtleSkKICB9CgogIHJldHVybiBrZXlQYWlyCn0KCmZ1bmN0aW9uIGdlbmVyYXRlU2VlZEtleVBhaXIgKHNlZWQpIHsKICBhc3NlcnQoc2VlZC5ieXRlTGVuZ3RoID09PSBTS0xFTikKCiAgY29uc3Qga2V5UGFpciA9IHt9CiAga2V5UGFpci5zZWNyZXRLZXkgPSBiNGEuYWxsb2MoU0tMRU4pCiAga2V5UGFpci5wdWJsaWNLZXkgPSBiNGEuYWxsb2MoUEtMRU4pCgogIGNyeXB0b19reF9zZWVkX2tleXBhaXIoa2V5UGFpci5wdWJsaWNLZXksIGtleVBhaXIuc2VjcmV0S2V5LCBzZWVkKQogIHJldHVybiBrZXlQYWlyCn0KCmZ1bmN0aW9uIGRoIChwdWJsaWNLZXksIHsgc2VjcmV0S2V5IH0pIHsKICBhc3NlcnQoc2VjcmV0S2V5LmJ5dGVMZW5ndGggPT09IFNLTEVOKQogIGFzc2VydChwdWJsaWNLZXkuYnl0ZUxlbmd0aCA9PT0gUEtMRU4pCgogIGNvbnN0IG91dHB1dCA9IGI0YS5hbGxvYyhESExFTikKCiAgY3J5cHRvX3NjYWxhcm11bHQoCiAgICBvdXRwdXQsCiAgICBzZWNyZXRLZXksCiAgICBwdWJsaWNLZXkKICApCgogIHJldHVybiBvdXRwdXQKfQpjb25zdCBobWFjQmxha2UyYiA9IHJlcXVpcmUoJy4vaG1hYycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBIQVNITEVOID0gNjQKCm1vZHVsZS5leHBvcnRzID0gewogIGhrZGYsCiAgSEFTSExFTgp9CgovLyBITUFDLWJhc2VkIEV4dHJhY3QtYW5kLUV4cGFuZCBLREYKLy8gaHR0cHM6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzU4NjkudHh0CgpmdW5jdGlvbiBoa2RmIChzYWx0LCBpbnB1dEtleU1hdGVyaWFsLCBpbmZvID0gJycsIGxlbmd0aCA9IDIgKiBIQVNITEVOKSB7CiAgY29uc3QgcHNldWRvUmFuZG9tS2V5ID0gaGtkZkV4dHJhY3Qoc2FsdCwgaW5wdXRLZXlNYXRlcmlhbCkKICByZXR1cm4gaGtkZkV4cGFuZChwc2V1ZG9SYW5kb21LZXksIGluZm8sIGxlbmd0aCkKfQoKZnVuY3Rpb24gaGtkZkV4dHJhY3QgKHNhbHQsIGlucHV0S2V5TWF0ZXJpYWwpIHsKICBjb25zdCBobWFjID0gYjRhLmFsbG9jKEhBU0hMRU4pCiAgcmV0dXJuIGhtYWNEaWdlc3QoaG1hYywgc2FsdCwgaW5wdXRLZXlNYXRlcmlhbCkKfQoKZnVuY3Rpb24gaGtkZkV4cGFuZCAoa2V5LCBpbmZvLCBsZW5ndGgpIHsKICAvLyBQdXQgaW4gZGVkaWNhdGVkIHNsYWIgdG8gYXZvaWQga2VlcGluZyBzaGFyZWQgc2xhYiBmcm9tIGJlaW5nIGdjJ2VkCiAgY29uc3QgYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlU2xvdyhsZW5ndGgpCgogIGNvbnN0IGluZm9CdWYgPSBiNGEuZnJvbShpbmZvKQogIGxldCBwcmV2ID0gaW5mb0J1ZgoKICBjb25zdCByZXN1bHQgPSBbXQogIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IEhBU0hMRU4pIHsKICAgIGNvbnN0IHBvcyA9IGI0YS5mcm9tKFsoaSAvIEhBU0hMRU4pICsgMV0pCgogICAgY29uc3Qgb3V0ID0gYnVmZmVyLnN1YmFycmF5KGksIGkgKyBIQVNITEVOKQogICAgcmVzdWx0LnB1c2gob3V0KQoKICAgIHByZXYgPSBobWFjRGlnZXN0KG91dCwga2V5LCBbcHJldiwgaW5mb0J1ZiwgcG9zXSkKICB9CgogIHJldHVybiByZXN1bHQKfQoKZnVuY3Rpb24gaG1hY0RpZ2VzdCAob3V0LCBrZXksIGlucHV0KSB7CiAgaG1hY0JsYWtlMmIob3V0LCBpbnB1dCwga2V5KQogIHJldHVybiBvdXQKfQovKiBlc2xpbnQtZGlzYWJsZSBjYW1lbGNhc2UgKi8KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgeyBzb2RpdW1fbWVtemVybywgY3J5cHRvX2dlbmVyaWNoYXNoLCBjcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2ggfSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQoKY29uc3QgSEFTSExFTiA9IDY0CmNvbnN0IEJMT0NLTEVOID0gMTI4CmNvbnN0IHNjcmF0Y2ggPSBiNGEuYWxsb2MoQkxPQ0tMRU4gKiAzKQpjb25zdCBITUFDS2V5ID0gc2NyYXRjaC5zdWJhcnJheShCTE9DS0xFTiAqIDAsIEJMT0NLTEVOICogMSkKY29uc3QgT3V0ZXJLZXlQYWQgPSBzY3JhdGNoLnN1YmFycmF5KEJMT0NLTEVOICogMSwgQkxPQ0tMRU4gKiAyKQpjb25zdCBJbm5lcktleVBhZCA9IHNjcmF0Y2guc3ViYXJyYXkoQkxPQ0tMRU4gKiAyLCBCTE9DS0xFTiAqIDMpCgovLyBQb3N0LWZpbGwgaXMgZG9uZSBpbiB0aGUgY2FzZXMgd2hlcmUgc29tZW9uZSBjYXVnaHQgYW4gZXhjZXB0aW9uIHRoYXQKLy8gaGFwcGVuZWQgYmVmb3JlIHdlIHdlcmUgYWJsZSB0byBjbGVhciBkYXRhIGF0IHRoZSBlbmQKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gaG1hYyAob3V0LCBiYXRjaCwga2V5KSB7CiAgaWYgKGtleS5ieXRlTGVuZ3RoID4gQkxPQ0tMRU4pIHsKICAgIGNyeXB0b19nZW5lcmljaGFzaChITUFDS2V5LnN1YmFycmF5KDAsIEhBU0hMRU4pLCBrZXkpCiAgICBzb2RpdW1fbWVtemVybyhITUFDS2V5LnN1YmFycmF5KEhBU0hMRU4pKQogIH0gZWxzZSB7CiAgICAvLyBDb3ZlcnMga2V5IDw9IEJMT0NLTEVOCiAgICBITUFDS2V5LnNldChrZXkpCiAgICBzb2RpdW1fbWVtemVybyhITUFDS2V5LnN1YmFycmF5KGtleS5ieXRlTGVuZ3RoKSkKICB9CgogIGZvciAobGV0IGkgPSAwOyBpIDwgSE1BQ0tleS5ieXRlTGVuZ3RoOyBpKyspIHsKICAgIE91dGVyS2V5UGFkW2ldID0gMHg1YyBeIEhNQUNLZXlbaV0KICAgIElubmVyS2V5UGFkW2ldID0gMHgzNiBeIEhNQUNLZXlbaV0KICB9CiAgc29kaXVtX21lbXplcm8oSE1BQ0tleSkKCiAgY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKG91dCwgW0lubmVyS2V5UGFkXS5jb25jYXQoYmF0Y2gpKQogIHNvZGl1bV9tZW16ZXJvKElubmVyS2V5UGFkKQogIGNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChvdXQsIFtPdXRlcktleVBhZCwgb3V0XSkKICBzb2RpdW1fbWVtemVybyhPdXRlcktleVBhZCkKfQoKbW9kdWxlLmV4cG9ydHMuQllURVMgPSBIQVNITEVOCm1vZHVsZS5leHBvcnRzLktFWUJZVEVTID0gQkxPQ0tMRU4KY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnbmFub2Fzc2VydCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBTeW1tZXRyaWNTdGF0ZSA9IHJlcXVpcmUoJy4vc3ltbWV0cmljLXN0YXRlJykKY29uc3QgeyBIQVNITEVOIH0gPSByZXF1aXJlKCcuL2hrZGYnKQoKY29uc3QgUFJFU0hBUkVfSVMgPSBTeW1ib2woJ2luaXRpYXRvciBzdGF0aWMga2V5IHByZXNoYXJlZCcpCmNvbnN0IFBSRVNIQVJFX1JTID0gU3ltYm9sKCdyZXNwb25kZXIgc3RhdGljIGtleSBwcmVzaGFyZWQnKQoKY29uc3QgVE9LX1BTSyA9IFN5bWJvbCgncHNrJykKCmNvbnN0IFRPS19TID0gU3ltYm9sKCdzJykKY29uc3QgVE9LX0UgPSBTeW1ib2woJ2UnKQoKY29uc3QgVE9LX0VTID0gU3ltYm9sKCdlcycpCmNvbnN0IFRPS19TRSA9IFN5bWJvbCgnc2UnKQpjb25zdCBUT0tfRUUgPSBTeW1ib2woJ2VlJykKY29uc3QgVE9LX1NTID0gU3ltYm9sKCdzcycpCgpjb25zdCBIQU5EU0hBS0VTID0gT2JqZWN0LmZyZWV6ZSh7CiAgTk46IFsKICAgIFtUT0tfRV0sCiAgICBbVE9LX0UsIFRPS19FRV0KICBdLAogIE5OcHNrMDogWwogICAgW1RPS19QU0ssIFRPS19FXSwKICAgIFtUT0tfRSwgVE9LX0VFXQogIF0sCiAgWFg6IFsKICAgIFtUT0tfRV0sCiAgICBbVE9LX0UsIFRPS19FRSwgVE9LX1MsIFRPS19FU10sCiAgICBbVE9LX1MsIFRPS19TRV0KICBdLAogIFhYcHNrMDogWwogICAgW1RPS19QU0ssIFRPS19FXSwKICAgIFtUT0tfRSwgVE9LX0VFLCBUT0tfUywgVE9LX0VTXSwKICAgIFtUT0tfUywgVE9LX1NFXQogIF0sCiAgSUs6IFsKICAgIFBSRVNIQVJFX1JTLAogICAgW1RPS19FLCBUT0tfRVMsIFRPS19TLCBUT0tfU1NdLAogICAgW1RPS19FLCBUT0tfRUUsIFRPS19TRV0KICBdLAogIFhLOiBbCiAgICBQUkVTSEFSRV9SUywKICAgIFtUT0tfRSwgVE9LX0VTXSwKICAgIFtUT0tfRSwgVE9LX0VFXSwKICAgIFtUT0tfUywgVE9LX1NFXQogIF0KfSkKCmNsYXNzIFdyaXRlciB7CiAgY29uc3RydWN0b3IgKCkgewogICAgdGhpcy5zaXplID0gMAogICAgdGhpcy5idWZmZXJzID0gW10KICB9CgogIHB1c2ggKGIpIHsKICAgIHRoaXMuc2l6ZSArPSBiLmJ5dGVMZW5ndGgKICAgIHRoaXMuYnVmZmVycy5wdXNoKGIpCiAgfQoKICBlbmQgKCkgewogICAgY29uc3QgYWxsID0gYjRhLmFsbG9jKHRoaXMuc2l6ZSkKICAgIGxldCBvZmZzZXQgPSAwCiAgICBmb3IgKGNvbnN0IGIgb2YgdGhpcy5idWZmZXJzKSB7CiAgICAgIGFsbC5zZXQoYiwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gYi5ieXRlTGVuZ3RoCiAgICB9CiAgICByZXR1cm4gYWxsCiAgfQp9CgpjbGFzcyBSZWFkZXIgewogIGNvbnN0cnVjdG9yIChidWYpIHsKICAgIHRoaXMub2Zmc2V0ID0gMAogICAgdGhpcy5idWZmZXIgPSBidWYKICB9CgogIHNoaWZ0IChuKSB7CiAgICBjb25zdCBzdGFydCA9IHRoaXMub2Zmc2V0CiAgICBjb25zdCBlbmQgPSB0aGlzLm9mZnNldCArPSBuCiAgICBpZiAoZW5kID4gdGhpcy5idWZmZXIuYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdJbnN1ZmZpY2llbnQgYnl0ZXMnKQogICAgcmV0dXJuIHRoaXMuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBlbmQpCiAgfQoKICBlbmQgKCkgewogICAgcmV0dXJuIHRoaXMuc2hpZnQodGhpcy5idWZmZXIuYnl0ZUxlbmd0aCAtIHRoaXMub2Zmc2V0KQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBOb2lzZVN0YXRlIGV4dGVuZHMgU3ltbWV0cmljU3RhdGUgewogIGNvbnN0cnVjdG9yIChwYXR0ZXJuLCBpbml0aWF0b3IsIHN0YXRpY0tleXBhaXIsIG9wdHMgPSB7fSkgewogICAgc3VwZXIob3B0cykKCiAgICB0aGlzLnMgPSBzdGF0aWNLZXlwYWlyIHx8IHRoaXMuY3VydmUuZ2VuZXJhdGVLZXlQYWlyKCkKICAgIHRoaXMuZSA9IG51bGwKCiAgICB0aGlzLnBzayA9IG51bGwKICAgIGlmIChvcHRzICYmIG9wdHMucHNrKSB0aGlzLnBzayA9IG9wdHMucHNrCgogICAgdGhpcy5yZSA9IG51bGwKICAgIHRoaXMucnMgPSBudWxsCgogICAgdGhpcy5wYXR0ZXJuID0gcGF0dGVybgogICAgdGhpcy5oYW5kc2hha2UgPSBIQU5EU0hBS0VTW3RoaXMucGF0dGVybl0uc2xpY2UoKQoKICAgIHRoaXMuaXNQc2tIYW5kc2hha2UgPSAhIXRoaXMucHNrICYmIGhhc1Bza1Rva2VuKHRoaXMuaGFuZHNoYWtlKQoKICAgIHRoaXMucHJvdG9jb2wgPSBiNGEuZnJvbShbCiAgICAgICdOb2lzZScsCiAgICAgIHRoaXMucGF0dGVybiwKICAgICAgdGhpcy5ESF9BTEcsCiAgICAgIHRoaXMuQ0lQSEVSX0FMRywKICAgICAgJ0JMQUtFMmInCiAgICBdLmpvaW4oJ18nKSkKCiAgICB0aGlzLmluaXRpYXRvciA9IGluaXRpYXRvcgogICAgdGhpcy5jb21wbGV0ZSA9IGZhbHNlCgogICAgdGhpcy5yeCA9IG51bGwKICAgIHRoaXMudHggPSBudWxsCiAgICB0aGlzLmhhc2ggPSBudWxsCiAgfQoKICBpbml0aWFsaXNlIChwcm9sb2d1ZSwgcmVtb3RlU3RhdGljKSB7CiAgICBpZiAodGhpcy5wcm90b2NvbC5ieXRlTGVuZ3RoIDw9IEhBU0hMRU4pIHRoaXMuZGlnZXN0LnNldCh0aGlzLnByb3RvY29sKQogICAgZWxzZSB0aGlzLm1peEhhc2godGhpcy5wcm90b2NvbCkKCiAgICB0aGlzLmNoYWluaW5nS2V5ID0gYjRhLmZyb20odGhpcy5kaWdlc3QpCgogICAgdGhpcy5taXhIYXNoKHByb2xvZ3VlKQoKICAgIHdoaWxlICghQXJyYXkuaXNBcnJheSh0aGlzLmhhbmRzaGFrZVswXSkpIHsKICAgICAgY29uc3QgbWVzc2FnZSA9IHRoaXMuaGFuZHNoYWtlLnNoaWZ0KCkKCiAgICAgIC8vIGhhbmRzaGFrZSBzdGVwcyBzaG91bGQgYmUgYXMgYXJyYXlzLCBvbmx5CiAgICAgIC8vIHByZXNoYXJlIHRva2VucyBhcmUgcHJvdmlkZWQgb3RoZXJ3aXNlCiAgICAgIGFzc2VydChtZXNzYWdlID09PSBQUkVTSEFSRV9SUyB8fCBtZXNzYWdlID09PSBQUkVTSEFSRV9JUywKICAgICAgICAnVW5leHBlY3RlZCBwYXR0ZXJuJykKCiAgICAgIGNvbnN0IHRha2VSZW1vdGVLZXkgPSB0aGlzLmluaXRpYXRvcgogICAgICAgID8gbWVzc2FnZSA9PT0gUFJFU0hBUkVfUlMKICAgICAgICA6IG1lc3NhZ2UgPT09IFBSRVNIQVJFX0lTCgogICAgICBpZiAodGFrZVJlbW90ZUtleSkgdGhpcy5ycyA9IHJlbW90ZVN0YXRpYwoKICAgICAgY29uc3Qga2V5ID0gdGFrZVJlbW90ZUtleSA/IHRoaXMucnMgOiB0aGlzLnMucHVibGljS2V5CiAgICAgIGFzc2VydChrZXkgIT0gbnVsbCwgJ1JlbW90ZSBwdWJrZXkgcmVxdWlyZWQnKQoKICAgICAgdGhpcy5taXhIYXNoKGtleSkKICAgIH0KICB9CgogIGZpbmFsICgpIHsKICAgIGNvbnN0IFtrMSwgazJdID0gdGhpcy5zcGxpdCgpCgogICAgdGhpcy50eCA9IHRoaXMuaW5pdGlhdG9yID8gazEgOiBrMgogICAgdGhpcy5yeCA9IHRoaXMuaW5pdGlhdG9yID8gazIgOiBrMQoKICAgIHRoaXMuY29tcGxldGUgPSB0cnVlCiAgICB0aGlzLmhhc2ggPSB0aGlzLmdldEhhbmRzaGFrZUhhc2goKQoKICAgIHRoaXMuX2NsZWFyKCkKICB9CgogIHJlY3YgKGJ1ZikgewogICAgY29uc3QgciA9IG5ldyBSZWFkZXIoYnVmKQoKICAgIGZvciAoY29uc3QgcGF0dGVybiBvZiB0aGlzLmhhbmRzaGFrZS5zaGlmdCgpKSB7CiAgICAgIHN3aXRjaCAocGF0dGVybikgewogICAgICAgIGNhc2UgVE9LX1BTSyA6CiAgICAgICAgICB0aGlzLm1peEtleUFuZEhhc2godGhpcy5wc2spCiAgICAgICAgICBicmVhawoKICAgICAgICBjYXNlIFRPS19FIDoKICAgICAgICAgIHRoaXMucmUgPSByLnNoaWZ0KHRoaXMuY3VydmUuUEtMRU4pCiAgICAgICAgICB0aGlzLm1peEhhc2godGhpcy5yZSkKICAgICAgICAgIGlmICh0aGlzLmlzUHNrSGFuZHNoYWtlKSB0aGlzLm1peEtleU5vcm1hbCh0aGlzLnJlKQogICAgICAgICAgYnJlYWsKCiAgICAgICAgY2FzZSBUT0tfUyA6IHsKICAgICAgICAgIGNvbnN0IGtsZW4gPSB0aGlzLmhhc0tleSA/IHRoaXMuY3VydmUuUEtMRU4gKyAxNiA6IHRoaXMuY3VydmUuUEtMRU4KICAgICAgICAgIHRoaXMucnMgPSB0aGlzLmRlY3J5cHRBbmRIYXNoKHIuc2hpZnQoa2xlbikpCiAgICAgICAgICBicmVhawogICAgICAgIH0KCiAgICAgICAgY2FzZSBUT0tfRUUgOgogICAgICAgIGNhc2UgVE9LX0VTIDoKICAgICAgICBjYXNlIFRPS19TRSA6CiAgICAgICAgY2FzZSBUT0tfU1MgOiB7CiAgICAgICAgICBjb25zdCB1c2VTdGF0aWMgPSBrZXlQYXR0ZXJuKHBhdHRlcm4sIHRoaXMuaW5pdGlhdG9yKQoKICAgICAgICAgIGNvbnN0IGxvY2FsS2V5ID0gdXNlU3RhdGljLmxvY2FsID8gdGhpcy5zIDogdGhpcy5lCiAgICAgICAgICBjb25zdCByZW1vdGVLZXkgPSB1c2VTdGF0aWMucmVtb3RlID8gdGhpcy5ycyA6IHRoaXMucmUKCiAgICAgICAgICB0aGlzLm1peEtleShyZW1vdGVLZXksIGxvY2FsS2V5KQogICAgICAgICAgYnJlYWsKICAgICAgICB9CgogICAgICAgIGRlZmF1bHQgOgogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmV4cGVjdGVkIG1lc3NhZ2UnKQogICAgICB9CiAgICB9CgogICAgY29uc3QgcGF5bG9hZCA9IHRoaXMuZGVjcnlwdEFuZEhhc2goci5lbmQoKSkKCiAgICBpZiAoIXRoaXMuaGFuZHNoYWtlLmxlbmd0aCkgdGhpcy5maW5hbCgpCiAgICByZXR1cm4gcGF5bG9hZAogIH0KCiAgc2VuZCAocGF5bG9hZCA9IGI0YS5hbGxvYygwKSkgewogICAgY29uc3QgdyA9IG5ldyBXcml0ZXIoKQoKICAgIGZvciAoY29uc3QgcGF0dGVybiBvZiB0aGlzLmhhbmRzaGFrZS5zaGlmdCgpKSB7CiAgICAgIHN3aXRjaCAocGF0dGVybikgewogICAgICAgIGNhc2UgVE9LX1BTSyA6CiAgICAgICAgICB0aGlzLm1peEtleUFuZEhhc2godGhpcy5wc2spCiAgICAgICAgICBicmVhawoKICAgICAgICBjYXNlIFRPS19FIDoKICAgICAgICAgIGlmICh0aGlzLmUgPT09IG51bGwpIHRoaXMuZSA9IHRoaXMuY3VydmUuZ2VuZXJhdGVLZXlQYWlyKCkKICAgICAgICAgIHRoaXMubWl4SGFzaCh0aGlzLmUucHVibGljS2V5KQogICAgICAgICAgaWYgKHRoaXMuaXNQc2tIYW5kc2hha2UpIHRoaXMubWl4S2V5Tm9ybWFsKHRoaXMuZS5wdWJsaWNLZXkpCiAgICAgICAgICB3LnB1c2godGhpcy5lLnB1YmxpY0tleSkKICAgICAgICAgIGJyZWFrCgogICAgICAgIGNhc2UgVE9LX1MgOgogICAgICAgICAgdy5wdXNoKHRoaXMuZW5jcnlwdEFuZEhhc2godGhpcy5zLnB1YmxpY0tleSkpCiAgICAgICAgICBicmVhawoKICAgICAgICBjYXNlIFRPS19FUyA6CiAgICAgICAgY2FzZSBUT0tfU0UgOgogICAgICAgIGNhc2UgVE9LX0VFIDoKICAgICAgICBjYXNlIFRPS19TUyA6IHsKICAgICAgICAgIGNvbnN0IHVzZVN0YXRpYyA9IGtleVBhdHRlcm4ocGF0dGVybiwgdGhpcy5pbml0aWF0b3IpCgogICAgICAgICAgY29uc3QgbG9jYWxLZXkgPSB1c2VTdGF0aWMubG9jYWwgPyB0aGlzLnMgOiB0aGlzLmUKICAgICAgICAgIGNvbnN0IHJlbW90ZUtleSA9IHVzZVN0YXRpYy5yZW1vdGUgPyB0aGlzLnJzIDogdGhpcy5yZQoKICAgICAgICAgIHRoaXMubWl4S2V5KHJlbW90ZUtleSwgbG9jYWxLZXkpCiAgICAgICAgICBicmVhawogICAgICAgIH0KCiAgICAgICAgZGVmYXVsdCA6CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuZXhwZWN0ZWQgbWVzc2FnZScpCiAgICAgIH0KICAgIH0KCiAgICB3LnB1c2godGhpcy5lbmNyeXB0QW5kSGFzaChwYXlsb2FkKSkKICAgIGNvbnN0IHJlc3BvbnNlID0gdy5lbmQoKQoKICAgIGlmICghdGhpcy5oYW5kc2hha2UubGVuZ3RoKSB0aGlzLmZpbmFsKCkKICAgIHJldHVybiByZXNwb25zZQogIH0KCiAgX2NsZWFyICgpIHsKICAgIHN1cGVyLl9jbGVhcigpCgogICAgdGhpcy5lLnNlY3JldEtleS5maWxsKDApCiAgICB0aGlzLmUucHVibGljS2V5LmZpbGwoMCkKCiAgICB0aGlzLnJlLmZpbGwoMCkKCiAgICB0aGlzLmUgPSBudWxsCiAgICB0aGlzLnJlID0gbnVsbAogIH0KfQoKZnVuY3Rpb24ga2V5UGF0dGVybiAocGF0dGVybiwgaW5pdGlhdG9yKSB7CiAgY29uc3QgcmV0ID0gewogICAgbG9jYWw6IGZhbHNlLAogICAgcmVtb3RlOiBmYWxzZQogIH0KCiAgc3dpdGNoIChwYXR0ZXJuKSB7CiAgICBjYXNlIFRPS19FRToKICAgICAgcmV0dXJuIHJldAoKICAgIGNhc2UgVE9LX0VTOgogICAgICByZXQubG9jYWwgXj0gIWluaXRpYXRvcgogICAgICByZXQucmVtb3RlIF49IGluaXRpYXRvcgogICAgICByZXR1cm4gcmV0CgogICAgY2FzZSBUT0tfU0U6CiAgICAgIHJldC5sb2NhbCBePSBpbml0aWF0b3IKICAgICAgcmV0LnJlbW90ZSBePSAhaW5pdGlhdG9yCiAgICAgIHJldHVybiByZXQKCiAgICBjYXNlIFRPS19TUzoKICAgICAgcmV0LmxvY2FsIF49IDEKICAgICAgcmV0LnJlbW90ZSBePSAxCiAgICAgIHJldHVybiByZXQKICB9Cn0KCmZ1bmN0aW9uIGhhc1Bza1Rva2VuIChoYW5kc2hha2UpIHsKICByZXR1cm4gaGFuZHNoYWtlLnNvbWUoeCA9PiB7CiAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh4KSAmJiB4LmluZGV4T2YoVE9LX1BTSykgIT09IC0xCiAgfSkKfQp7CiAgIm5hbWUiOiAibm9pc2UtaGFuZHNoYWtlIiwKICAidmVyc2lvbiI6ICI0LjIuMCIsCiAgImRlc2NyaXB0aW9uIjogIk5vaXNlIHByb3RvY29sIGhhbmRzaGFrZSIsCiAgIm1haW4iOiAibm9pc2UuanMiLAogICJmaWxlcyI6IFsKICAgICIqLmpzIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QvKi5qcyIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vbm9pc2UtaGFuZHNoYWtlLmdpdCIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjEuMCIsCiAgICAibmFub2Fzc2VydCI6ICJeMi4wLjAiLAogICAgInNvZGl1bS11bml2ZXJzYWwiOiAiXjUuMC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjMuMiIsCiAgICAibm9pc2UtcHJvdG9jb2wiOiAiY2htLWRpZWRlcmljaHMvbm9pc2UtcHJvdG9jb2wuZ2l0I3h4LWVwaGVtZXJhbC1rZXkiLAogICAgInN0YW5kYXJkIjogIl4xNi4wLjMiCiAgfQp9CmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBhc3NlcnQgPSByZXF1aXJlKCduYW5vYXNzZXJ0JykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgQ2lwaGVyU3RhdGUgPSByZXF1aXJlKCcuL2NpcGhlcicpCmNvbnN0IGN1cnZlID0gcmVxdWlyZSgnLi9kaCcpCmNvbnN0IHsgSEFTSExFTiwgaGtkZiB9ID0gcmVxdWlyZSgnLi9oa2RmJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU3ltbWV0cmljU3RhdGUgZXh0ZW5kcyBDaXBoZXJTdGF0ZSB7CiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuY3VydmUgPSBvcHRzLmN1cnZlIHx8IGN1cnZlCiAgICB0aGlzLmRpZ2VzdCA9IGI0YS5hbGxvYyhIQVNITEVOKQogICAgdGhpcy5jaGFpbmluZ0tleSA9IG51bGwKICAgIHRoaXMub2Zmc2V0ID0gMAoKICAgIHRoaXMuREhfQUxHID0gdGhpcy5jdXJ2ZS5BTEcKICB9CgogIG1peEhhc2ggKGRhdGEpIHsKICAgIGFjY3VtdWxhdGVEaWdlc3QodGhpcy5kaWdlc3QsIGRhdGEpCiAgfQoKICBtaXhLZXlBbmRIYXNoIChrZXkpIHsKICAgIGNvbnN0IFtjaywgdGVtcEgsIHRlbXBLXSA9IGhrZGYodGhpcy5jaGFpbmluZ0tleSwga2V5LCAnJywgMyAqIEhBU0hMRU4pCiAgICB0aGlzLmNoYWluaW5nS2V5ID0gY2sKICAgIHRoaXMubWl4SGFzaCh0ZW1wSCkKICAgIHRoaXMuaW5pdGlhbGlzZUtleSh0ZW1wSy5zdWJhcnJheSgwLCAzMikpCiAgfQoKICBtaXhLZXlOb3JtYWwgKGtleSkgewogICAgY29uc3QgW2NrLCB0ZW1wS10gPSBoa2RmKHRoaXMuY2hhaW5pbmdLZXksIGtleSkKICAgIHRoaXMuY2hhaW5pbmdLZXkgPSBjawogICAgdGhpcy5pbml0aWFsaXNlS2V5KHRlbXBLLnN1YmFycmF5KDAsIDMyKSkKICB9CgogIG1peEtleSAocmVtb3RlS2V5LCBsb2NhbEtleSkgewogICAgY29uc3QgZGggPSB0aGlzLmN1cnZlLmRoKHJlbW90ZUtleSwgbG9jYWxLZXkpCiAgICBjb25zdCBoa2RmUmVzdWx0ID0gaGtkZih0aGlzLmNoYWluaW5nS2V5LCBkaCkKICAgIHRoaXMuY2hhaW5pbmdLZXkgPSBoa2RmUmVzdWx0WzBdCiAgICB0aGlzLmluaXRpYWxpc2VLZXkoaGtkZlJlc3VsdFsxXS5zdWJhcnJheSgwLCAzMikpCiAgfQoKICBlbmNyeXB0QW5kSGFzaCAocGxhaW50ZXh0KSB7CiAgICBjb25zdCBjaXBoZXJ0ZXh0ID0gdGhpcy5lbmNyeXB0KHBsYWludGV4dCwgdGhpcy5kaWdlc3QpCiAgICBhY2N1bXVsYXRlRGlnZXN0KHRoaXMuZGlnZXN0LCBjaXBoZXJ0ZXh0KQogICAgcmV0dXJuIGNpcGhlcnRleHQKICB9CgogIGRlY3J5cHRBbmRIYXNoIChjaXBoZXJ0ZXh0KSB7CiAgICBjb25zdCBwbGFpbnRleHQgPSB0aGlzLmRlY3J5cHQoY2lwaGVydGV4dCwgdGhpcy5kaWdlc3QpCiAgICBhY2N1bXVsYXRlRGlnZXN0KHRoaXMuZGlnZXN0LCBjaXBoZXJ0ZXh0KQogICAgcmV0dXJuIHBsYWludGV4dAogIH0KCiAgZ2V0SGFuZHNoYWtlSGFzaCAob3V0KSB7CiAgICBpZiAoIW91dCkgcmV0dXJuIHRoaXMuZ2V0SGFuZHNoYWtlSGFzaChiNGEuYWxsb2MoSEFTSExFTikpCiAgICBhc3NlcnQob3V0LmJ5dGVMZW5ndGggPT09IEhBU0hMRU4sIGBvdXRwdXQgbXVzdCBiZSAke0hBU0hMRU59IGJ5dGVzYCkKCiAgICBvdXQuc2V0KHRoaXMuZGlnZXN0KQogICAgcmV0dXJuIG91dAogIH0KCiAgc3BsaXQgKCkgewogICAgY29uc3QgcmVzID0gaGtkZih0aGlzLmNoYWluaW5nS2V5LCBiNGEuYWxsb2MoMCkpCiAgICByZXR1cm4gcmVzLm1hcChrID0+IGsuc3ViYXJyYXkoMCwgMzIpKQogIH0KCiAgX2NsZWFyICgpIHsKICAgIHN1cGVyLl9jbGVhcigpCgogICAgc29kaXVtLnNvZGl1bV9tZW16ZXJvKHRoaXMuZGlnZXN0KQogICAgc29kaXVtLnNvZGl1bV9tZW16ZXJvKHRoaXMuY2hhaW5pbmdLZXkpCgogICAgdGhpcy5kaWdlc3QgPSBudWxsCiAgICB0aGlzLmNoYWluaW5nS2V5ID0gbnVsbAogICAgdGhpcy5vZmZzZXQgPSBudWxsCgogICAgdGhpcy5jdXJ2ZSA9IG51bGwKICB9CgogIHN0YXRpYyBnZXQgYWxnICgpIHsKICAgIHJldHVybiBDaXBoZXJTdGF0ZS5hbGcgKyAnX0JMQUtFMmInCiAgfQp9CgpmdW5jdGlvbiBhY2N1bXVsYXRlRGlnZXN0IChkaWdlc3QsIGlucHV0KSB7CiAgY29uc3QgdG9IYXNoID0gYjRhLmNvbmNhdChbZGlnZXN0LCBpbnB1dF0pCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChkaWdlc3QsIHRvSGFzaCkKfQp2YXIgdmFyaW50ID0gcmVxdWlyZSgndmFyaW50JykKdmFyIHN2YXJpbnQgPSByZXF1aXJlKCdzaWduZWQtdmFyaW50JykKdmFyIGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpleHBvcnRzLm1ha2UgPSBlbmNvZGVyCgpleHBvcnRzLm5hbWUgPSBmdW5jdGlvbiAoZW5jKSB7CiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhleHBvcnRzKQogIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgaWYgKGV4cG9ydHNba2V5c1tpXV0gPT09IGVuYykgcmV0dXJuIGtleXNbaV0KICB9CiAgcmV0dXJuIG51bGwKfQoKZXhwb3J0cy5za2lwID0gZnVuY3Rpb24gKHR5cGUsIGJ1ZmZlciwgb2Zmc2V0KSB7CiAgc3dpdGNoICh0eXBlKSB7CiAgICBjYXNlIDA6CiAgICAgIHZhcmludC5kZWNvZGUoYnVmZmVyLCBvZmZzZXQpCiAgICAgIHJldHVybiBvZmZzZXQgKyB2YXJpbnQuZGVjb2RlLmJ5dGVzCgogICAgY2FzZSAxOgogICAgICByZXR1cm4gb2Zmc2V0ICsgOAoKICAgIGNhc2UgMjoKICAgICAgdmFyIGxlbiA9IHZhcmludC5kZWNvZGUoYnVmZmVyLCBvZmZzZXQpCiAgICAgIHJldHVybiBvZmZzZXQgKyB2YXJpbnQuZGVjb2RlLmJ5dGVzICsgbGVuCgogICAgY2FzZSAzOgogICAgY2FzZSA0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dyb3VwcyBhcmUgbm90IHN1cHBvcnRlZCcpCgogICAgY2FzZSA1OgogICAgICByZXR1cm4gb2Zmc2V0ICsgNAogIH0KCiAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHdpcmUgdHlwZTogJyArIHR5cGUpCn0KCmV4cG9ydHMuYnl0ZXMgPSBlbmNvZGVyKDIsCiAgZnVuY3Rpb24gZW5jb2RlICh2YWwsIGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICB2YXIgbGVuID0gYnVmZmVyTGVuZ3RoKHZhbCkKCiAgICB2YXJpbnQuZW5jb2RlKGxlbiwgYnVmZmVyLCBvZmZzZXQpCiAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcwoKICAgIGlmIChiNGEuaXNCdWZmZXIodmFsKSkgYjRhLmNvcHkodmFsLCBidWZmZXIsIG9mZnNldCkKICAgIGVsc2UgYjRhLndyaXRlKGJ1ZmZlciwgdmFsLCBvZmZzZXQsIGxlbikKICAgIG9mZnNldCArPSBsZW4KCiAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgIHJldHVybiBidWZmZXIKICB9LAogIGZ1bmN0aW9uIGRlY29kZSAoYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKCiAgICB2YXIgbGVuID0gdmFyaW50LmRlY29kZShidWZmZXIsIG9mZnNldCkKICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCgogICAgdmFyIHZhbCA9IGJ1ZmZlci5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIGxlbikKICAgIG9mZnNldCArPSB2YWwubGVuZ3RoCgogICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICByZXR1cm4gdmFsCiAgfSwKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAodmFsKSB7CiAgICB2YXIgbGVuID0gYnVmZmVyTGVuZ3RoKHZhbCkKICAgIHJldHVybiB2YXJpbnQuZW5jb2RpbmdMZW5ndGgobGVuKSArIGxlbgogIH0KKQoKZXhwb3J0cy5zdHJpbmcgPSBlbmNvZGVyKDIsCiAgZnVuY3Rpb24gZW5jb2RlICh2YWwsIGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICB2YXIgbGVuID0gYjRhLmJ5dGVMZW5ndGgodmFsKQoKICAgIHZhcmludC5lbmNvZGUobGVuLCBidWZmZXIsIG9mZnNldCwgJ3V0Zi04JykKICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCgogICAgYjRhLndyaXRlKGJ1ZmZlciwgdmFsLCBvZmZzZXQsIGxlbikKICAgIG9mZnNldCArPSBsZW4KCiAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgIHJldHVybiBidWZmZXIKICB9LAogIGZ1bmN0aW9uIGRlY29kZSAoYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKCiAgICB2YXIgbGVuID0gdmFyaW50LmRlY29kZShidWZmZXIsIG9mZnNldCkKICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCgogICAgdmFyIHZhbCA9IGI0YS50b1N0cmluZyhidWZmZXIsICd1dGYtOCcsIG9mZnNldCwgb2Zmc2V0ICsgbGVuKQogICAgb2Zmc2V0ICs9IGxlbgoKICAgIGRlY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgcmV0dXJuIHZhbAogIH0sCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKHZhbCkgewogICAgdmFyIGxlbiA9IGI0YS5ieXRlTGVuZ3RoKHZhbCkKICAgIHJldHVybiB2YXJpbnQuZW5jb2RpbmdMZW5ndGgobGVuKSArIGxlbgogIH0KKQoKZXhwb3J0cy5ib29sID0gZW5jb2RlcigwLAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgYnVmZmVyW29mZnNldF0gPSB2YWwgPyAxIDogMAogICAgZW5jb2RlLmJ5dGVzID0gMQogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIGJvb2wgPSBidWZmZXJbb2Zmc2V0XSA+IDAKICAgIGRlY29kZS5ieXRlcyA9IDEKICAgIHJldHVybiBib29sCiAgfSwKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAoKSB7CiAgICByZXR1cm4gMQogIH0KKQoKZXhwb3J0cy5pbnQzMiA9IGVuY29kZXIoMCwKICBmdW5jdGlvbiBlbmNvZGUgKHZhbCwgYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhcmludC5lbmNvZGUodmFsIDwgMCA/IHZhbCArIDQyOTQ5NjcyOTYgOiB2YWwsIGJ1ZmZlciwgb2Zmc2V0KQogICAgZW5jb2RlLmJ5dGVzID0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIHZhbCA9IHZhcmludC5kZWNvZGUoYnVmZmVyLCBvZmZzZXQpCiAgICBkZWNvZGUuYnl0ZXMgPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICByZXR1cm4gdmFsID4gMjE0NzQ4MzY0NyA/IHZhbCAtIDQyOTQ5NjcyOTYgOiB2YWwKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICh2YWwpIHsKICAgIHJldHVybiB2YXJpbnQuZW5jb2RpbmdMZW5ndGgodmFsIDwgMCA/IHZhbCArIDQyOTQ5NjcyOTYgOiB2YWwpCiAgfQopCgpleHBvcnRzLmludDY0ID0gZW5jb2RlcigwLAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgaWYgKHZhbCA8IDApIHsKICAgICAgdmFyIGxhc3QgPSBvZmZzZXQgKyA5CiAgICAgIHZhcmludC5lbmNvZGUodmFsICogLTEsIGJ1ZmZlciwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcyAtIDEKICAgICAgYnVmZmVyW29mZnNldF0gPSBidWZmZXJbb2Zmc2V0XSB8IDB4ODAKICAgICAgd2hpbGUgKG9mZnNldCA8IGxhc3QgLSAxKSB7CiAgICAgICAgb2Zmc2V0KysKICAgICAgICBidWZmZXJbb2Zmc2V0XSA9IDB4ZmYKICAgICAgfQogICAgICBidWZmZXJbbGFzdF0gPSAweDAxCiAgICAgIGVuY29kZS5ieXRlcyA9IDEwCiAgICB9IGVsc2UgewogICAgICB2YXJpbnQuZW5jb2RlKHZhbCwgYnVmZmVyLCBvZmZzZXQpCiAgICAgIGVuY29kZS5ieXRlcyA9IHZhcmludC5lbmNvZGUuYnl0ZXMKICAgIH0KICAgIHJldHVybiBidWZmZXIKICB9LAogIGZ1bmN0aW9uIGRlY29kZSAoYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciB2YWwgPSB2YXJpbnQuZGVjb2RlKGJ1ZmZlciwgb2Zmc2V0KQogICAgaWYgKHZhbCA+PSBNYXRoLnBvdygyLCA2MykpIHsKICAgICAgdmFyIGxpbWl0ID0gOQogICAgICB3aGlsZSAoYnVmZmVyW29mZnNldCArIGxpbWl0IC0gMV0gPT09IDB4ZmYpIGxpbWl0LS0KICAgICAgbGltaXQgPSBsaW1pdCB8fCA5CiAgICAgIHZhciBzdWJzZXQgPSBiNGEuYWxsb2NVbnNhZmUobGltaXQpCiAgICAgIGI0YS5jb3B5KGJ1ZmZlciwgc3Vic2V0LCAwLCBvZmZzZXQsIG9mZnNldCArIGxpbWl0KQogICAgICBzdWJzZXRbbGltaXQgLSAxXSA9IHN1YnNldFtsaW1pdCAtIDFdICYgMHg3ZgogICAgICB2YWwgPSAtMSAqIHZhcmludC5kZWNvZGUoc3Vic2V0LCAwKQogICAgICBkZWNvZGUuYnl0ZXMgPSAxMAogICAgfSBlbHNlIHsKICAgICAgZGVjb2RlLmJ5dGVzID0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgfQogICAgcmV0dXJuIHZhbAogIH0sCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKHZhbCkgewogICAgcmV0dXJuIHZhbCA8IDAgPyAxMCA6IHZhcmludC5lbmNvZGluZ0xlbmd0aCh2YWwpCiAgfQopCgpleHBvcnRzLnNpbnQzMiA9CmV4cG9ydHMuc2ludDY0ID0gZW5jb2RlcigwLAogIHN2YXJpbnQuZW5jb2RlLAogIHN2YXJpbnQuZGVjb2RlLAogIHN2YXJpbnQuZW5jb2RpbmdMZW5ndGgKKQoKZXhwb3J0cy51aW50MzIgPQpleHBvcnRzLnVpbnQ2NCA9CmV4cG9ydHMuZW51bSA9CmV4cG9ydHMudmFyaW50ID0gZW5jb2RlcigwLAogIHZhcmludC5lbmNvZGUsCiAgdmFyaW50LmRlY29kZSwKICB2YXJpbnQuZW5jb2RpbmdMZW5ndGgKKQoKLy8gd2UgY2Fubm90IHJlcHJlc2VudCB0aGVzZSBpbiBqYXZhc2NyaXB0IHNvIHdlIGp1c3QgdXNlIGJ1ZmZlcnMKZXhwb3J0cy5maXhlZDY0ID0KZXhwb3J0cy5zZml4ZWQ2NCA9IGVuY29kZXIoMSwKICBmdW5jdGlvbiBlbmNvZGUgKHZhbCwgYnVmZmVyLCBvZmZzZXQpIHsKICAgIGI0YS5jb3B5KHZhbCwgYnVmZmVyLCBvZmZzZXQpCiAgICBlbmNvZGUuYnl0ZXMgPSA4CiAgICByZXR1cm4gYnVmZmVyCiAgfSwKICBmdW5jdGlvbiBkZWNvZGUgKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgdmFsID0gYnVmZmVyLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgOCkKICAgIGRlY29kZS5ieXRlcyA9IDgKICAgIHJldHVybiB2YWwKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICgpIHsKICAgIHJldHVybiA4CiAgfQopCgpleHBvcnRzLmRvdWJsZSA9IGVuY29kZXIoMSwKICBmdW5jdGlvbiBlbmNvZGUgKHZhbCwgYnVmZmVyLCBvZmZzZXQpIHsKICAgIGI0YS53cml0ZURvdWJsZUxFKGJ1ZmZlciwgdmFsLCBvZmZzZXQpCiAgICBlbmNvZGUuYnl0ZXMgPSA4CiAgICByZXR1cm4gYnVmZmVyCiAgfSwKICBmdW5jdGlvbiBkZWNvZGUgKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgdmFsID0gYjRhLnJlYWREb3VibGVMRShidWZmZXIsIG9mZnNldCkKICAgIGRlY29kZS5ieXRlcyA9IDgKICAgIHJldHVybiB2YWwKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICgpIHsKICAgIHJldHVybiA4CiAgfQopCgpleHBvcnRzLmZpeGVkMzIgPSBlbmNvZGVyKDUsCiAgZnVuY3Rpb24gZW5jb2RlICh2YWwsIGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICBiNGEud3JpdGVVSW50MzJMRShidWZmZXIsIHZhbCwgb2Zmc2V0KQogICAgZW5jb2RlLmJ5dGVzID0gNAogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIHZhbCA9IGI0YS5yZWFkVUludDMyTEUoYnVmZmVyLCBvZmZzZXQpCiAgICBkZWNvZGUuYnl0ZXMgPSA0CiAgICByZXR1cm4gdmFsCiAgfSwKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAoKSB7CiAgICByZXR1cm4gNAogIH0KKQoKZXhwb3J0cy5zZml4ZWQzMiA9IGVuY29kZXIoNSwKICBmdW5jdGlvbiBlbmNvZGUgKHZhbCwgYnVmZmVyLCBvZmZzZXQpIHsKICAgIGI0YS53cml0ZUludDMyTEUoYnVmZmVyLCB2YWwsIG9mZnNldCkKICAgIGVuY29kZS5ieXRlcyA9IDQKICAgIHJldHVybiBidWZmZXIKICB9LAogIGZ1bmN0aW9uIGRlY29kZSAoYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciB2YWwgPSBiNGEucmVhZEludDMyTEUoYnVmZmVyLCBvZmZzZXQpCiAgICBkZWNvZGUuYnl0ZXMgPSA0CiAgICByZXR1cm4gdmFsCiAgfSwKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAoKSB7CiAgICByZXR1cm4gNAogIH0KKQoKZXhwb3J0cy5mbG9hdCA9IGVuY29kZXIoNSwKICBmdW5jdGlvbiBlbmNvZGUgKHZhbCwgYnVmZmVyLCBvZmZzZXQpIHsKICAgIGI0YS53cml0ZUZsb2F0TEUoYnVmZmVyLCB2YWwsIG9mZnNldCkKICAgIGVuY29kZS5ieXRlcyA9IDQKICAgIHJldHVybiBidWZmZXIKICB9LAogIGZ1bmN0aW9uIGRlY29kZSAoYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciB2YWwgPSBiNGEucmVhZEZsb2F0TEUoYnVmZmVyLCBvZmZzZXQpCiAgICBkZWNvZGUuYnl0ZXMgPSA0CiAgICByZXR1cm4gdmFsCiAgfSwKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAoKSB7CiAgICByZXR1cm4gNAogIH0KKQoKZnVuY3Rpb24gZW5jb2RlciAodHlwZSwgZW5jb2RlLCBkZWNvZGUsIGVuY29kaW5nTGVuZ3RoKSB7CiAgZW5jb2RlLmJ5dGVzID0gZGVjb2RlLmJ5dGVzID0gMAoKICByZXR1cm4gewogICAgdHlwZTogdHlwZSwKICAgIGVuY29kZTogZW5jb2RlLAogICAgZGVjb2RlOiBkZWNvZGUsCiAgICBlbmNvZGluZ0xlbmd0aDogZW5jb2RpbmdMZW5ndGgKICB9Cn0KCmZ1bmN0aW9uIGJ1ZmZlckxlbmd0aCAodmFsKSB7CiAgcmV0dXJuIGI0YS5pc0J1ZmZlcih2YWwpID8gdmFsLmxlbmd0aCA6IGI0YS5ieXRlTGVuZ3RoKHZhbCkKfQp7CiAgIm5hbWUiOiAicHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MiLAogICJ2ZXJzaW9uIjogIjEuMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiQmFzZSBlbmNvZGluZ3MgZm9yIHByb3RvY29sLWJ1ZmZlcnMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjAiLAogICAgInNpZ25lZC12YXJpbnQiOiAiXjIuMC4xIiwKICAgICJ2YXJpbnQiOiAiNS4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xNC4zLjQiLAogICAgInRhcGUiOiAiXjUuMC4xIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiB0YXBlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3Byb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3Byb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzIgp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBQcm90b211eCA9IHJlcXVpcmUoJ3Byb3RvbXV4JykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3Qgc2NoZW1hID0gcmVxdWlyZSgnLi9zcGVjL2h5cGVyc2NoZW1hJykKCmNvbnN0IFtOU19JTklUQVRPUiwgTlNfUkVTUE9OREVSXSA9IGNyeXB0by5uYW1lc3BhY2UoJ3dha2V1cCcsIDIpCgpjb25zdCBIYW5kc2hha2UgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0B3YWtldXAvaGFuZHNoYWtlJykKY29uc3QgQW5ub3VuY2UgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0B3YWtldXAvYW5ub3VuY2UnKQpjb25zdCBMb29rdXAgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0B3YWtldXAvbG9va3VwJykKY29uc3QgSW5mbyA9IHNjaGVtYS5nZXRFbmNvZGluZygnQHdha2V1cC9pbmZvJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgV2FrZXVwU3dhcm0gewogIGNvbnN0cnVjdG9yKG9ud2FrZXVwID0gbm9vcCwgeyBnY1RpY2tUaW1lID0gMjAwMCB9ID0ge30pIHsKICAgIHRoaXMuZ2NUaWNrVGltZSA9IGdjVGlja1RpbWUKCiAgICB0aGlzLnRvcGljcyA9IG5ldyBNYXAoKQogICAgdGhpcy50b3BpY3NHQyA9IG5ldyBTZXQoKQogICAgdGhpcy5tdXhlcnMgPSBuZXcgU2V0KCkKICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgIHNlc3Npb25zT3BlbmVkOiAwLAogICAgICBzZXNzaW9uc0Nsb3NlZDogMCwKICAgICAgdG9waWNzQWRkZWQ6IDAsCiAgICAgIHRvcGljc0djZDogMCwKICAgICAgcGVlcnNBZGRlZDogMCwKICAgICAgcGVlcnNSZW1vdmVkOiAwLAogICAgICB3aXJlQW5ub3VuY2U6IHsgcng6IDAsIHR4OiAwIH0sCiAgICAgIHdpcmVMb29rdXA6IHsgcng6IDAsIHR4OiAwIH0sCiAgICAgIHdpcmVJbmZvOiB7IHJ4OiAwLCB0eDogMCB9CiAgICB9CgogICAgdGhpcy5vbndha2V1cCA9IG9ud2FrZXVwCgogICAgdGhpcy5fZ2NJbnRlcnZhbCA9IG51bGwKICAgIHRoaXMuX2djQm91bmQgPSB0aGlzLl9nYy5iaW5kKHRoaXMpCiAgfQoKICBzZXNzaW9uKGNhcGFiaWxpdHksIGhhbmRsZXJzID0ge30pIHsKICAgIGNvbnN0IGlkID0gaGFuZGxlcnMuZGlzY292ZXJ5S2V5IHx8IGNyeXB0by5kaXNjb3ZlcnlLZXkoY2FwYWJpbGl0eSkKICAgIGNvbnN0IGFjdGl2ZSA9IGhhbmRsZXJzLmFjdGl2ZSAhPT0gZmFsc2UKICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhpZCwgJ2hleCcpCgogICAgbGV0IHcgPSB0aGlzLnRvcGljcy5nZXQoaGV4KQoKICAgIGlmICh3KSByZXR1cm4gdy5hZGRTZXNzaW9uKGhhbmRsZXJzKQoKICAgIHcgPSBuZXcgV2FrZXVwVG9waWModGhpcywgaWQsIGNhcGFiaWxpdHksIGFjdGl2ZSkKCiAgICB0aGlzLnRvcGljcy5zZXQoaGV4LCB3KQoKICAgIGZvciAoY29uc3QgbXV4ZXIgb2YgdGhpcy5tdXhlcnMpIHsKICAgICAgdy5fb25vcGVuKG11eGVyLCB0cnVlKQogICAgfQoKICAgIHJldHVybiB3LmFkZFNlc3Npb24oaGFuZGxlcnMpCiAgfQoKICBnZXRTZXNzaW9ucyhjYXBhYmlsaXR5LCBoYW5kbGVycyA9IHt9KSB7CiAgICBjb25zdCBpZCA9IGhhbmRsZXJzLmRpc2NvdmVyeUtleSB8fCBjcnlwdG8uZGlzY292ZXJ5S2V5KGNhcGFiaWxpdHkpCiAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcoaWQsICdoZXgnKQogICAgY29uc3QgdyA9IHRoaXMudG9waWNzLmdldChoZXgpCiAgICByZXR1cm4gdyA/IHcuc2Vzc2lvbnMgOiBbXQogIH0KCiAgaGFzU3RyZWFtKHN0cmVhbSwgY2FwYWJpbGl0eSwgaGFuZGxlcnMgPSB7fSkgewogICAgaWYgKCFjYXBhYmlsaXR5KSB7CiAgICAgIGNvbnN0IG5vaXNlU3RyZWFtID0gc3RyZWFtLm5vaXNlU3RyZWFtIHx8IHN0cmVhbQogICAgICByZXR1cm4gdGhpcy5tdXhlcnMuaGFzKGdldE11eGVyKG5vaXNlU3RyZWFtKSkKICAgIH0KCiAgICBjb25zdCBpZCA9IGhhbmRsZXJzLmRpc2NvdmVyeUtleSB8fCBjcnlwdG8uZGlzY292ZXJ5S2V5KGNhcGFiaWxpdHkpCiAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcoaWQsICdoZXgnKQogICAgY29uc3QgdCA9IHRoaXMudG9waWNzLmdldChoZXgpCgogICAgcmV0dXJuIHQgPyB0LnBlZXJzQnlTdHJlYW0uaGFzKHN0cmVhbSkgOiBmYWxzZQogIH0KCiAgYWRkU3RyZWFtKHN0cmVhbSkgewogICAgY29uc3Qgbm9pc2VTdHJlYW0gPSBzdHJlYW0ubm9pc2VTdHJlYW0gfHwgc3RyZWFtCgogICAgaWYgKCFub2lzZVN0cmVhbS5jb25uZWN0ZWQpIHsKICAgICAgbm9pc2VTdHJlYW0ub25jZSgnb3BlbicsIHRoaXMuYWRkU3RyZWFtLmJpbmQodGhpcywgbm9pc2VTdHJlYW0pKQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBtdXhlciA9IGdldE11eGVyKG5vaXNlU3RyZWFtKQogICAgbXV4ZXIucGFpcih7IHByb3RvY29sOiAnd2FrZXVwJyB9LCAoaWQpID0+IHRoaXMuX29ucGFpcihpZCwgbXV4ZXIpKQoKICAgIHRoaXMubXV4ZXJzLmFkZChtdXhlcikKICAgIG5vaXNlU3RyZWFtLm9uKCdjbG9zZScsICgpID0+IHRoaXMubXV4ZXJzLmRlbGV0ZShtdXhlcikpCgogICAgZm9yIChjb25zdCB3IG9mIHRoaXMudG9waWNzLnZhbHVlcygpKSB7CiAgICAgIGlmICghdy5pc0FjdGl2ZSkgY29udGludWUKICAgICAgdy5fb25vcGVuKG11eGVyLCB0cnVlKQogICAgfQogIH0KCiAgX29uQWN0aXZlKHcpIHsKICAgIGZvciAoY29uc3QgbSBvZiB0aGlzLm11eGVycykgewogICAgICB3Ll9vbm9wZW4obSwgZmFsc2UpCiAgICB9CiAgfQoKICBfYWRkR0ModG9waWMpIHsKICAgIGlmICh0b3BpYy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy50b3BpY3NHQy5hZGQodG9waWMpCiAgICBpZiAodGhpcy5fZ2NJbnRlcnZhbCA9PT0gbnVsbCkgewogICAgICB0aGlzLl9nY0ludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5fZ2NCb3VuZCwgdGhpcy5nY1RpY2tUaW1lKQogICAgfQogIH0KCiAgX3JlbW92ZUdDKHRvcGljKSB7CiAgICB0aGlzLnRvcGljc0dDLmRlbGV0ZSh0b3BpYykKICAgIGlmICh0aGlzLnRvcGljc0dDLnNpemUgPT09IDAgJiYgdGhpcy5fZ2NJbnRlcnZhbCkgewogICAgICBjbGVhckludGVydmFsKHRoaXMuX2djSW50ZXJ2YWwpCiAgICAgIHRoaXMuX2djSW50ZXJ2YWwgPSBudWxsCiAgICB9CiAgfQoKICBfZ2MoKSB7CiAgICBjb25zdCBkZXN0cm95ID0gW10KICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLnRvcGljc0dDKSB7CiAgICAgIHcuaWRsZVRpY2tzKysKICAgICAgaWYgKHcuaWRsZVRpY2tzID49IDUpIGRlc3Ryb3kucHVzaCh3KQogICAgfQogICAgZm9yIChjb25zdCB3IG9mIGRlc3Ryb3kpIHcudGVhcmRvd24oKQogIH0KCiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLl9nY0ludGVydmFsKSBjbGVhckludGVydmFsKHRoaXMuX2djSW50ZXJ2YWwpCiAgICB0aGlzLl9nY0ludGVydmFsID0gbnVsbAoKICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLnRvcGljcy52YWx1ZXMoKSkgdy50ZWFyZG93bigpCiAgfQoKICBhc3luYyBfb25wYWlyKGlkLCBzdHJlYW0pIHsKICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhpZCwgJ2hleCcpCiAgICBjb25zdCB3ID0gdGhpcy50b3BpY3MuZ2V0KGhleCkKICAgIGlmICghdyB8fCAhdy5zZXNzaW9ucy5sZW5ndGgpIHJldHVybiB0aGlzLm9ud2FrZXVwKGlkLCBzdHJlYW0pCiAgICB3Ll9vbm9wZW4oZ2V0TXV4ZXIoc3RyZWFtKSwgZmFsc2UpCiAgfQoKICByZWdpc3Rlck1ldHJpY3MocHJvbUNsaWVudCkgewogICAgY29uc3Qgc2VsZiA9IHRoaXMKICAgIG5ldyBwcm9tQ2xpZW50LkdhdWdlKHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1uZXcKICAgICAgbmFtZTogJ3Byb3RvbXV4X3dha2V1cF9zZXNzaW9uc19vcGVuZWQnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiBzZXNzaW9ucyBvcGVuZWQgYnkgcHJvdG9tdXggd2FrZXVwJywKICAgICAgY29sbGVjdCgpIHsKICAgICAgICB0aGlzLnNldChzZWxmLnN0YXRzLnNlc3Npb25zT3BlbmVkKQogICAgICB9CiAgICB9KQoKICAgIG5ldyBwcm9tQ2xpZW50LkdhdWdlKHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1uZXcKICAgICAgbmFtZTogJ3Byb3RvbXV4X3dha2V1cF9zZXNzaW9uc19jbG9zZWQnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiBzZXNzaW9ucyBjbG9zZWQgYnkgcHJvdG9tdXggd2FrZXVwJywKICAgICAgY29sbGVjdCgpIHsKICAgICAgICB0aGlzLnNldChzZWxmLnN0YXRzLnNlc3Npb25zQ2xvc2VkKQogICAgICB9CiAgICB9KQoKICAgIG5ldyBwcm9tQ2xpZW50LkdhdWdlKHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1uZXcKICAgICAgbmFtZTogJ3Byb3RvbXV4X3dha2V1cF90b3BpY3NfYWRkZWQnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiB0b3BpY3MgYWRkZWQgdG8gcHJvdG9tdXggd2FrZXVwJywKICAgICAgY29sbGVjdCgpIHsKICAgICAgICB0aGlzLnNldChzZWxmLnN0YXRzLnRvcGljc0FkZGVkKQogICAgICB9CiAgICB9KQoKICAgIG5ldyBwcm9tQ2xpZW50LkdhdWdlKHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1uZXcKICAgICAgbmFtZTogJ3Byb3RvbXV4X3dha2V1cF90b3BpY3NfZ2NkJywKICAgICAgaGVscDogJ1RoZSBhbW91bnQgb2YgdG9waWNzIHRoYXQgZ290IGdhcmJhZ2UgY29sbGVjdGVkIGJ5IHByb3RvbXV4IHdha2V1cCcsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy50b3BpY3NHY2QpCiAgICAgIH0KICAgIH0pCgogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3BlZXJzX2FkZGVkJywKICAgICAgaGVscDogJ1RoZSBhbW91bnQgb2YgcGVlcnMgYWRkZWQgYnkgcHJvdG9tdXggd2FrZXVwLCBhY3Jvc3MgYWxsIHRvcGljcycsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy5wZWVyc0FkZGVkKQogICAgICB9CiAgICB9KQoKICAgIG5ldyBwcm9tQ2xpZW50LkdhdWdlKHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1uZXcKICAgICAgbmFtZTogJ3Byb3RvbXV4X3dha2V1cF9wZWVyc19yZW1vdmVkJywKICAgICAgaGVscDogJ1RoZSBhbW91bnQgb2YgcGVlcnMgcmVtb3ZlZCBieSBwcm90b211eCB3YWtldXAsIGFjcm9zcyBhbGwgdG9waWNzJywKICAgICAgY29sbGVjdCgpIHsKICAgICAgICB0aGlzLnNldChzZWxmLnN0YXRzLnBlZXJzUmVtb3ZlZCkKICAgICAgfQogICAgfSkKCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfd2lyZV9hbm5vdW5jZV9yeCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHdpcmUgYW5ub3VuY2UgbWVzc2FnZXMgcmVjZWl2ZWQgYnkgcHJvdG9tdXggd2FrZXVwJywKICAgICAgY29sbGVjdCgpIHsKICAgICAgICB0aGlzLnNldChzZWxmLnN0YXRzLndpcmVBbm5vdW5jZS5yeCkKICAgICAgfQogICAgfSkKICAgIG5ldyBwcm9tQ2xpZW50LkdhdWdlKHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1uZXcKICAgICAgbmFtZTogJ3Byb3RvbXV4X3dha2V1cF93aXJlX2Fubm91bmNlX3R4JywKICAgICAgaGVscDogJ1RoZSBhbW91bnQgb2Ygd2lyZSBhbm5vdW5jZSBtZXNzYWdlcyB0cmFuc21pdHRlZCBieSBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMud2lyZUFubm91bmNlLnR4KQogICAgICB9CiAgICB9KQogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3dpcmVfbG9va3VwX3J4JywKICAgICAgaGVscDogJ1RoZSBhbW91bnQgb2Ygd2lyZSBsb29rdXAgbWVzc2FnZXMgcmVjZWl2ZWQgYnkgcHJvdG9tdXggd2FrZXVwJywKICAgICAgY29sbGVjdCgpIHsKICAgICAgICB0aGlzLnNldChzZWxmLnN0YXRzLndpcmVMb29rdXAucngpCiAgICAgIH0KICAgIH0pCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfd2lyZV9sb29rdXBfdHgnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiB3aXJlIGxvb2t1cCBtZXNzYWdlcyB0cmFuc21pdHRlZCBieSBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMud2lyZUxvb2t1cC50eCkKICAgICAgfQogICAgfSkKICAgIG5ldyBwcm9tQ2xpZW50LkdhdWdlKHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1uZXcKICAgICAgbmFtZTogJ3Byb3RvbXV4X3dha2V1cF93aXJlX2luZm9fcngnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiB3aXJlIGluZm8gbWVzc2FnZXMgcmVjZWl2ZWQgYnkgcHJvdG9tdXggd2FrZXVwJywKICAgICAgY29sbGVjdCgpIHsKICAgICAgICB0aGlzLnNldChzZWxmLnN0YXRzLndpcmVJbmZvLnJ4KQogICAgICB9CiAgICB9KQogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3dpcmVfaW5mb190eCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHdpcmUgaW5mbyBtZXNzYWdlcyB0cmFuc21pdHRlZCBieSBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMud2lyZUluZm8ucngpCiAgICAgIH0KICAgIH0pCiAgfQp9CgpjbGFzcyBXYWtldXBQZWVyIHsKICBjb25zdHJ1Y3Rvcih0b3BpYykgewogICAgdGhpcy5pbmRleCA9IDAKICAgIHRoaXMudXNlckRhdGEgPSBudWxsIC8vIGZvciB0aGUgdXNlcgogICAgdGhpcy5jbG9jayA9IDAgLy8gZm9yIHRoZSB1c2VyLCB2IHVzZWZ1bCB0byByZWR1Y2UgdHJhZmZpYwogICAgdGhpcy5wZW5kaW5nID0gdHJ1ZQogICAgdGhpcy5yZW1vdmVkID0gZmFsc2UKICAgIHRoaXMudG9waWMgPSB0b3BpYwogICAgdGhpcy5jaGFubmVsID0gbnVsbAogICAgdGhpcy5zdHJlYW0gPSBudWxsCiAgICB0aGlzLndpcmVMb29rdXAgPSBudWxsCiAgICB0aGlzLndpcmVBbm5vdW5jZSA9IG51bGwKICAgIHRoaXMud2lyZUluZm8gPSBudWxsCiAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlCiAgfQoKICB1bmxpbmsobGlzdCkgewogICAgLy8gbm90ZSB0aGF0IHNpbmNlIHdlIHBvcCBoZXJlIHdlIGNhbiBpdGVyYXRlIGluIHJldmVyc2Ugc2FmZWx5IGluIGNhc2UgYSBwZWVyIGlzIHJlbW92ZWQgaW4gdGhlIHNhbWUgdGljawogICAgY29uc3QgaGVhZCA9IGxpc3QucG9wKCkKICAgIGlmIChoZWFkID09PSB0aGlzKSByZXR1cm4KICAgIGhlYWQuaW5kZXggPSB0aGlzLmluZGV4CiAgICBsaXN0W2hlYWQuaW5kZXhdID0gaGVhZAogIH0KfQoKY2xhc3MgV2FrZXVwU2Vzc2lvbiB7CiAgY29uc3RydWN0b3IodG9waWMsIGhhbmRsZXJzKSB7CiAgICB0aGlzLmluZGV4ID0gMAogICAgdGhpcy50b3BpYyA9IHRvcGljCiAgICB0aGlzLmhhbmRsZXJzID0gaGFuZGxlcnMKICAgIHRoaXMuaXNBY3RpdmUgPSBoYW5kbGVycy5hY3RpdmUgIT09IGZhbHNlCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCiAgfQoKICBnZXQgcGVlcnMoKSB7CiAgICByZXR1cm4gdGhpcy50b3BpYy5wZWVycwogIH0KCiAgaGFzU3RyZWFtKHN0cmVhbSkgewogICAgcmV0dXJuICEhdGhpcy5nZXRQZWVyKHN0cmVhbSkKICB9CgogIGFkZFN0cmVhbShzdHJlYW0pIHsKICAgIHRoaXMudG9waWMuYWRkU3RyZWFtKHN0cmVhbSkKICB9CgogIGdldFBlZXIoc3RyZWFtKSB7CiAgICByZXR1cm4gdGhpcy50b3BpYy5wZWVyc0J5U3RyZWFtLmdldChzdHJlYW0pIHx8IG51bGwKICB9CgogIGJyb2FkY2FzdExvb2t1cChyZXEpIHsKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnRvcGljLnBlbmRpbmdQZWVycykgewogICAgICB0aGlzLmxvb2t1cChwZWVyLCByZXEpCiAgICB9CiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy50b3BpYy5wZWVycykgewogICAgICB0aGlzLmxvb2t1cChwZWVyLCByZXEpCiAgICB9CiAgfQoKICBsb29rdXBCeVN0cmVhbShzdHJlYW0sIHJlcSkgewogICAgY29uc3QgcGVlciA9IHRoaXMudG9waWMucGVlcnNCeVN0cmVhbS5nZXQoc3RyZWFtKQogICAgaWYgKHBlZXIpIHRoaXMubG9va3VwKHBlZXIsIHJlcSkKICB9CgogIGxvb2t1cChwZWVyLCByZXEpIHsKICAgIHBlZXIudG9waWMuc3RhdGUuc3RhdHMud2lyZUxvb2t1cC50eCsrCiAgICBwZWVyLndpcmVMb29rdXAuc2VuZChyZXEgfHwgeyBoYXNoOiBudWxsIH0pCiAgfQoKICBhbm5vdW5jZUJ5U3RyZWFtKHN0cmVhbSwgd2FrZXVwKSB7CiAgICBjb25zdCBwZWVyID0gdGhpcy50b3BpYy5wZWVyc0J5U3RyZWFtLmdldChzdHJlYW0pCiAgICBpZiAocGVlciAmJiAhcGVlci5wZW5kaW5nKSB0aGlzLmFubm91bmNlKHBlZXIsIHdha2V1cCkKICB9CgogIGFubm91bmNlKHBlZXIsIHdha2V1cCkgewogICAgcGVlci50b3BpYy5zdGF0ZS5zdGF0cy53aXJlQW5ub3VuY2UudHgrKwogICAgcGVlci53aXJlQW5ub3VuY2Uuc2VuZCh3YWtldXApCiAgfQoKICBhY3RpdmUoKSB7CiAgICB0aGlzLmlzQWN0aXZlID0gdHJ1ZQogICAgdGhpcy50b3BpYy5fYnVtcEFjdGl2aXR5KCkKICB9CgogIGluYWN0aXZlKCkgewogICAgdGhpcy5pc0FjdGl2ZSA9IGZhbHNlCiAgICB0aGlzLnRvcGljLl9idW1wQWN0aXZpdHkoKQogIH0KCiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICAgIHRoaXMudG9waWMucmVtb3ZlU2Vzc2lvbih0aGlzKQogIH0KfQoKY2xhc3MgV2FrZXVwVG9waWMgewogIGNvbnN0cnVjdG9yKHN0YXRlLCBpZCwgY2FwYWJpbGl0eSwgYWN0aXZlKSB7CiAgICB0aGlzLnN0YXRlID0gc3RhdGUKICAgIHRoaXMuc2Vzc2lvbnMgPSBbXQogICAgdGhpcy5pZCA9IGlkCiAgICB0aGlzLmNhcGFiaWxpdHkgPSBjYXBhYmlsaXR5CiAgICB0aGlzLnBlZXJzID0gW10KICAgIHRoaXMucGVuZGluZ1BlZXJzID0gW10KICAgIHRoaXMucGVlcnNCeVN0cmVhbSA9IG5ldyBNYXAoKQogICAgdGhpcy5hY3RpdmVQZWVycyA9IDAKICAgIHRoaXMuaXNBY3RpdmUgPSBhY3RpdmUKICAgIHRoaXMuaWRsZVRpY2tzID0gMAogICAgdGhpcy5nY2luZyA9IGZhbHNlCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCgogICAgdGhpcy5zdGF0ZS5zdGF0cy50b3BpY3NBZGRlZCsrCiAgfQoKICBhZGRTZXNzaW9uKGhhbmRsZXJzKSB7CiAgICB0aGlzLnN0YXRlLnN0YXRzLnNlc3Npb25zT3BlbmVkKysKICAgIGNvbnN0IHNlc3Npb24gPSBuZXcgV2FrZXVwU2Vzc2lvbih0aGlzLCBoYW5kbGVycykKICAgIHNlc3Npb24uaW5kZXggPSB0aGlzLnNlc3Npb25zLmxlbmd0aAogICAgdGhpcy5zZXNzaW9ucy5wdXNoKHNlc3Npb24pCiAgICB0aGlzLl9idW1wQWN0aXZpdHkoKQogICAgdGhpcy5fY2hlY2tHQygpCiAgICByZXR1cm4gc2Vzc2lvbgogIH0KCiAgcmVtb3ZlU2Vzc2lvbihzZXNzaW9uKSB7CiAgICBpZiAodGhpcy5zZXNzaW9ucy5sZW5ndGggPD0gc2Vzc2lvbi5pbmRleCkgcmV0dXJuCiAgICBpZiAodGhpcy5zZXNzaW9uc1tzZXNzaW9uLmluZGV4XSAhPT0gc2Vzc2lvbikgcmV0dXJuCgogICAgdGhpcy5zdGF0ZS5zdGF0cy5zZXNzaW9uc0Nsb3NlZCsrCgogICAgLy8gc2FtZSBhcyB3aXRoIHRoZSBwZWVyLCB0aGlzIGFsbG93cyB1cyB0byBpdGVyYXRlIHdoaWxlIHJlbW92aW5nIGlmIGl0ZXJhdGluZyBiYWNrd2FyZHMKICAgIGNvbnN0IGhlYWQgPSB0aGlzLnNlc3Npb25zLnBvcCgpCiAgICBpZiAoaGVhZCAhPT0gc2Vzc2lvbikgewogICAgICBoZWFkLmluZGV4ID0gc2Vzc2lvbi5pbmRleAogICAgICB0aGlzLnNlc3Npb25zW2hlYWQuaW5kZXhdID0gaGVhZAogICAgfQoKICAgIHRoaXMuX2J1bXBBY3Rpdml0eSgpCiAgICB0aGlzLl9jaGVja0dDKCkKICB9CgogIF9idW1wQWN0aXZpdHkoKSB7CiAgICBsZXQgaXNBY3RpdmUgPSBmYWxzZQoKICAgIGZvciAobGV0IGkgPSB0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGlmICh0aGlzLnNlc3Npb25zW2ldLmlzQWN0aXZlKSB7CiAgICAgICAgaXNBY3RpdmUgPSB0cnVlCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIGlmIChpc0FjdGl2ZSkgdGhpcy5hY3RpdmUoKQogICAgZWxzZSB0aGlzLmluYWN0aXZlKCkKICB9CgogIGFjdGl2ZSgpIHsKICAgIGlmICh0aGlzLmlzQWN0aXZlKSByZXR1cm4KICAgIHRoaXMuaWRsZVRpY2tzID0gMAogICAgdGhpcy5pc0FjdGl2ZSA9IHRydWUKICAgIHRoaXMuX3VwZGF0ZUFjdGl2ZSh0cnVlKQogIH0KCiAgaW5hY3RpdmUoKSB7CiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHJldHVybgogICAgdGhpcy5pc0FjdGl2ZSA9IGZhbHNlCiAgICB0aGlzLl91cGRhdGVBY3RpdmUoZmFsc2UpCiAgfQoKICBfdXBkYXRlQWN0aXZlKGFjdGl2ZSkgewogICAgY29uc3QgaW5mbyA9IHsgYWN0aXZlIH0KCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZW5kaW5nUGVlcnMpIHsKICAgICAgcGVlci50b3BpYy5zdGF0ZS5zdGF0cy53aXJlSW5mby50eCsrCiAgICAgIHBlZXIud2lyZUluZm8uc2VuZChpbmZvKQogICAgfQogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHsKICAgICAgcGVlci50b3BpYy5zdGF0ZS5zdGF0cy53aXJlSW5mby50eCsrCiAgICAgIHBlZXIud2lyZUluZm8uc2VuZChpbmZvKQogICAgfQoKICAgIHRoaXMuX2NoZWNrR0MoKQoKICAgIGlmIChhY3RpdmUpIHRoaXMuc3RhdGUuX29uQWN0aXZlKHRoaXMpCiAgfQoKICB0ZWFyZG93bigpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKCiAgICB0aGlzLnN0YXRlLnN0YXRzLnRvcGljc0djZCsrCgogICAgZm9yIChsZXQgaSA9IHRoaXMucGVlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgdGhpcy5wZWVyc1tpXS5jaGFubmVsLmNsb3NlKCkKICAgIH0KCiAgICBmb3IgKGxldCBpID0gdGhpcy5wZW5kaW5nUGVlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgdGhpcy5wZW5kaW5nUGVlcnNbaV0uY2hhbm5lbC5jbG9zZSgpCiAgICB9CgogICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKHRoaXMuaWQsICdoZXgnKQoKICAgIHRoaXMuZ2NpbmcgPSBmYWxzZQogICAgdGhpcy5zdGF0ZS50b3BpY3MuZGVsZXRlKGhleCkKICAgIHRoaXMuc3RhdGUuX3JlbW92ZUdDKHRoaXMpCgogICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgdGhpcy5zdGF0ZS5zdGF0cy5zZXNzaW9uc0Nsb3NlZCsrCiAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zW2ldCiAgICAgIGlmIChzZXNzaW9uLmhhbmRsZXJzLm9uZGVzdHJveSkgc2Vzc2lvbi5oYW5kbGVycy5vbmRlc3Ryb3koc2Vzc2lvbikKICAgIH0KICB9CgogIGFkZFN0cmVhbShzdHJlYW0pIHsKICAgIHRoaXMuX29ub3BlbihnZXRNdXhlcihzdHJlYW0pLCBmYWxzZSkKICB9CgogIF9wcm92ZUNhcGFiaWxpdHlUbyhzdHJlYW0pIHsKICAgIHJldHVybiB0aGlzLl9tYWtlQ2FwYWJpbGl0eShzdHJlYW0uaXNJbml0aWF0b3IsIHN0cmVhbS5oYW5kc2hha2VIYXNoKQogIH0KCiAgX21ha2VDYXBhYmlsaXR5KGlzSW5pdGlhdG9yLCBoYW5kc2hha2VIYXNoKSB7CiAgICByZXR1cm4gY3J5cHRvLmhhc2goW2lzSW5pdGlhdG9yID8gTlNfSU5JVEFUT1IgOiBOU19SRVNQT05ERVIsIHRoaXMuY2FwYWJpbGl0eSwgaGFuZHNoYWtlSGFzaF0pCiAgfQoKICBfYWRkUGVlcihwZWVyLCBvcGVuKSB7CiAgICBpZiAoCiAgICAgICFiNGEuZXF1YWxzKAogICAgICAgIG9wZW4uY2FwYWJpbGl0eSwKICAgICAgICB0aGlzLl9tYWtlQ2FwYWJpbGl0eSghcGVlci5zdHJlYW0uaXNJbml0aWF0b3IsIHBlZXIuc3RyZWFtLmhhbmRzaGFrZUhhc2gpCiAgICAgICkKICAgICkgewogICAgICBwZWVyLmNoYW5uZWwuY2xvc2UoKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAocGVlci5wZW5kaW5nKSB7CiAgICAgIHBlZXIudW5saW5rKHRoaXMucGVuZGluZ1BlZXJzKQogICAgfQoKICAgIHBlZXIuYWN0aXZlID0gb3Blbi5hY3RpdmUKICAgIHBlZXIucGVuZGluZyA9IGZhbHNlCiAgICBwZWVyLmluZGV4ID0gdGhpcy5wZWVycy5wdXNoKHBlZXIpIC0gMQoKICAgIGlmIChwZWVyLmFjdGl2ZSkgewogICAgICB0aGlzLmFjdGl2ZVBlZXJzKysKICAgICAgdGhpcy5fY2hlY2tHQygpCiAgICB9CgogICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbaV0KICAgICAgY29uc3QgaGFuZGxlcnMgPSBzZXNzaW9uLmhhbmRsZXJzCgogICAgICBpZiAoaGFuZGxlcnMub25wZWVyYWRkKSBoYW5kbGVycy5vbnBlZXJhZGQocGVlciwgc2Vzc2lvbikKICAgICAgaWYgKHBlZXIuYWN0aXZlICYmIGhhbmRsZXJzLm9ucGVlcmFjdGl2ZSkgaGFuZGxlcnMub25wZWVyYWN0aXZlKHBlZXIsIHNlc3Npb24pCiAgICB9CiAgfQoKICBfY2hlY2tHQygpIHsKICAgIGNvbnN0IHNob3VsZEdDID0gdGhpcy5hY3RpdmVQZWVycyA9PT0gMCAmJiB0aGlzLnNlc3Npb25zLmxlbmd0aCA9PT0gMAoKICAgIGlmIChzaG91bGRHQykgewogICAgICBpZiAoIXRoaXMuZ2NpbmcpIHsKICAgICAgICB0aGlzLmdjaW5nID0gdHJ1ZQogICAgICAgIHRoaXMuc3RhdGUuX2FkZEdDKHRoaXMpCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmICh0aGlzLmdjaW5nKSB7CiAgICAgICAgdGhpcy5nY2luZyA9IGZhbHNlCiAgICAgICAgdGhpcy5zdGF0ZS5fcmVtb3ZlR0ModGhpcykKICAgICAgfQogICAgfQogIH0KCiAgX3JlbW92ZVBlZXIocGVlcikgewogICAgdGhpcy5zdGF0ZS5zdGF0cy5wZWVyc1JlbW92ZWQrKwogICAgcGVlci5yZW1vdmVkID0gdHJ1ZQogICAgdGhpcy5wZWVyc0J5U3RyZWFtLmRlbGV0ZShwZWVyLnN0cmVhbSkKCiAgICBpZiAocGVlci5wZW5kaW5nKSB7CiAgICAgIHBlZXIudW5saW5rKHRoaXMucGVuZGluZ1BlZXJzKQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBhY3RpdmUgPSBwZWVyLmFjdGl2ZQoKICAgIGlmIChhY3RpdmUpIHsKICAgICAgcGVlci5hY3RpdmUgPSBmYWxzZQogICAgICB0aGlzLmFjdGl2ZVBlZXJzLS0KICAgICAgdGhpcy5fY2hlY2tHQygpCiAgICB9CgogICAgcGVlci51bmxpbmsodGhpcy5wZWVycykKCiAgICBmb3IgKGxldCBpID0gdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5zZXNzaW9uc1tpXQogICAgICBjb25zdCBoYW5kbGVycyA9IHNlc3Npb24uaGFuZGxlcnMKCiAgICAgIGlmIChhY3RpdmUgJiYgaGFuZGxlcnMub25wZWVyaW5hY3RpdmUpIGhhbmRsZXJzLm9ucGVlcmluYWN0aXZlKHBlZXIsIHNlc3Npb24pCiAgICAgIGlmIChoYW5kbGVycy5vbnBlZXJyZW1vdmUpIGhhbmRsZXJzLm9ucGVlcnJlbW92ZShwZWVyLCBzZXNzaW9uKQogICAgfQogIH0KCiAgX29uYW5ub3VuY2Uod2FrZXVwLCBwZWVyKSB7CiAgICBmb3IgKGxldCBpID0gdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5zZXNzaW9uc1tpXQogICAgICBjb25zdCBoYW5kbGVycyA9IHNlc3Npb24uaGFuZGxlcnMKCiAgICAgIGlmIChoYW5kbGVycy5vbmFubm91bmNlKSBoYW5kbGVycy5vbmFubm91bmNlKHdha2V1cCwgcGVlciwgc2Vzc2lvbikKICAgIH0KICB9CgogIF9vbmxvb2t1cChyZXEsIHBlZXIpIHsKICAgIGZvciAobGV0IGkgPSB0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zW2ldCiAgICAgIGNvbnN0IGhhbmRsZXJzID0gc2Vzc2lvbi5oYW5kbGVycwoKICAgICAgaWYgKGhhbmRsZXJzLm9ubG9va3VwKSBoYW5kbGVycy5vbmxvb2t1cChyZXEsIHBlZXIsIHNlc3Npb24pCiAgICB9CiAgfQoKICBfb25pbmZvKGluZm8sIHBlZXIpIHsKICAgIGlmIChpbmZvLmFjdGl2ZSkgewogICAgICBpZiAoIXBlZXIuYWN0aXZlKSB7CiAgICAgICAgcGVlci5hY3RpdmUgPSB0cnVlCiAgICAgICAgdGhpcy5hY3RpdmVQZWVycysrCiAgICAgICAgdGhpcy5fY2hlY2tHQygpCgogICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5zZXNzaW9uc1tpXQogICAgICAgICAgY29uc3QgaGFuZGxlcnMgPSBzZXNzaW9uLmhhbmRsZXJzCgogICAgICAgICAgaWYgKGhhbmRsZXJzLm9ucGVlcmFjdGl2ZSkgaGFuZGxlcnMub25wZWVyYWN0aXZlKHBlZXIsIHNlc3Npb24pCiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAocGVlci5hY3RpdmUpIHsKICAgICAgICBwZWVyLmFjdGl2ZSA9IGZhbHNlCiAgICAgICAgdGhpcy5hY3RpdmVQZWVycy0tCiAgICAgICAgdGhpcy5fY2hlY2tHQygpCgogICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5zZXNzaW9uc1tpXQogICAgICAgICAgY29uc3QgaGFuZGxlcnMgPSBzZXNzaW9uLmhhbmRsZXJzCgogICAgICAgICAgaWYgKGhhbmRsZXJzLm9ucGVlcmluYWN0aXZlKSBoYW5kbGVycy5vbnBlZXJpbmFjdGl2ZShwZWVyLCBzZXNzaW9uKQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgX29ub3BlbihtdXhlciwgdW5pcXVlKSB7CiAgICBpZiAoIXVuaXF1ZSAmJiB0aGlzLnBlZXJzQnlTdHJlYW0uaGFzKG11eGVyLnN0cmVhbSkpIHJldHVybgoKICAgIGNvbnN0IHBlZXIgPSBuZXcgV2FrZXVwUGVlcih0aGlzKQogICAgY29uc3QgY2ggPSBtdXhlci5jcmVhdGVDaGFubmVsKHsKICAgICAgdXNlckRhdGE6IHBlZXIsCiAgICAgIHByb3RvY29sOiAnd2FrZXVwJywKICAgICAgaWQ6IHRoaXMuaWQsCiAgICAgIGhhbmRzaGFrZTogSGFuZHNoYWtlLAogICAgICBtZXNzYWdlczogWwogICAgICAgIHsgZW5jb2Rpbmc6IExvb2t1cCwgb25tZXNzYWdlOiBvbmxvb2t1cCB9LAogICAgICAgIHsgZW5jb2Rpbmc6IEFubm91bmNlLCBvbm1lc3NhZ2U6IG9uYW5ub3VuY2UgfSwKICAgICAgICB7IGVuY29kaW5nOiBJbmZvLCBvbm1lc3NhZ2U6IG9uY2hhbm5lbGluZm8gfQogICAgICBdLAogICAgICBvbm9wZW46IG9uY2hhbm5lbG9wZW4sCiAgICAgIG9uY2xvc2U6IG9uY2hhbm5lbGNsb3NlCiAgICB9KQoKICAgIGlmICghY2gpIHJldHVybgoKICAgIHRoaXMuc3RhdGUuc3RhdHMucGVlcnNBZGRlZCsrCgogICAgcGVlci5jaGFubmVsID0gY2gKICAgIHBlZXIuc3RyZWFtID0gbXV4ZXIuc3RyZWFtCgogICAgcGVlci53aXJlTG9va3VwID0gY2gubWVzc2FnZXNbMF0KICAgIHBlZXIud2lyZUFubm91bmNlID0gY2gubWVzc2FnZXNbMV0KICAgIHBlZXIud2lyZUluZm8gPSBjaC5tZXNzYWdlc1syXQoKICAgIHBlZXIuaW5kZXggPSB0aGlzLnBlbmRpbmdQZWVycy5wdXNoKHBlZXIpIC0gMQogICAgdGhpcy5wZWVyc0J5U3RyZWFtLnNldChtdXhlci5zdHJlYW0sIHBlZXIpCgogICAgY2gub3Blbih7CiAgICAgIHZlcnNpb246IDAsCiAgICAgIGNhcGFiaWxpdHk6IHRoaXMuX3Byb3ZlQ2FwYWJpbGl0eVRvKG11eGVyLnN0cmVhbSksCiAgICAgIGFjdGl2ZTogdGhpcy5pc0FjdGl2ZQogICAgfSkKICB9Cn0KCmZ1bmN0aW9uIG9uY2hhbm5lbG9wZW4ob3BlbiwgY2hhbm5lbCkgewogIGNvbnN0IHBlZXIgPSBjaGFubmVsLnVzZXJEYXRhCiAgcGVlci50b3BpYy5fYWRkUGVlcihwZWVyLCBvcGVuKQp9CgpmdW5jdGlvbiBvbmNoYW5uZWxjbG9zZShjbG9zZSwgY2hhbm5lbCkgewogIGNvbnN0IHBlZXIgPSBjaGFubmVsLnVzZXJEYXRhCiAgcGVlci50b3BpYy5fcmVtb3ZlUGVlcihwZWVyKQp9CgpmdW5jdGlvbiBvbmxvb2t1cChyZXEsIGNoYW5uZWwpIHsKICBjb25zdCBwZWVyID0gY2hhbm5lbC51c2VyRGF0YQogIHBlZXIudG9waWMuc3RhdGUuc3RhdHMud2lyZUxvb2t1cC5yeCsrCiAgcGVlci50b3BpYy5fb25sb29rdXAocmVxLCBwZWVyKQp9CgpmdW5jdGlvbiBvbmFubm91bmNlKHdha2V1cCwgY2hhbm5lbCkgewogIGNvbnN0IHBlZXIgPSBjaGFubmVsLnVzZXJEYXRhCiAgcGVlci50b3BpYy5zdGF0ZS5zdGF0cy53aXJlQW5ub3VuY2UucngrKwogIHBlZXIudG9waWMuX29uYW5ub3VuY2Uod2FrZXVwLCBwZWVyKQp9CgpmdW5jdGlvbiBvbmNoYW5uZWxpbmZvKGluZm8sIGNoYW5uZWwpIHsKICBjb25zdCBwZWVyID0gY2hhbm5lbC51c2VyRGF0YQogIHBlZXIudG9waWMuc3RhdGUuc3RhdHMud2lyZUluZm8ucngrKwogIHBlZXIudG9waWMuX29uaW5mbyhpbmZvLCBwZWVyKQp9CgpmdW5jdGlvbiBnZXRNdXhlcihzdHJlYW0pIHsKICBpZiAoUHJvdG9tdXguaXNQcm90b211eChzdHJlYW0pKSByZXR1cm4gc3RyZWFtCiAgaWYgKHN0cmVhbS5ub2lzZVN0cmVhbS51c2VyRGF0YSkgcmV0dXJuIHN0cmVhbS5ub2lzZVN0cmVhbS51c2VyRGF0YQogIGNvbnN0IG11eCA9IFByb3RvbXV4LmZyb20oc3RyZWFtLm5vaXNlU3RyZWFtKQogIHN0cmVhbS5ub2lzZVN0cmVhbS51c2VyRGF0YSA9IG11eAogIHJldHVybiBtdXgKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CnsKICAibmFtZSI6ICJwcm90b211eC13YWtldXAiLAogICJ2ZXJzaW9uIjogIjIuOS4wIiwKICAiZGVzY3JpcHRpb24iOiAiV2FrZXVwIHByb3RvY29sIG92ZXIgcHJvdG9tdXgiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjciLAogICAgImh5cGVyY29yZS1jcnlwdG8iOiAiXjMuNS4wIiwKICAgICJoeXBlcnNjaGVtYSI6ICJeMS4xMC40IiwKICAgICJwcm90b211eCI6ICJeMy4xMC4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtIjogIl42LjguMSIsCiAgICAiYnJpdHRsZSI6ICJeMy4xNy4xIiwKICAgICJsdW50ZSI6ICJeMS4wLjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiLAogICAgInByb20tY2xpZW50IjogIl4xNS4xLjMiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgInNwZWMvaHlwZXJzY2hlbWEvKi5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgInRlc3QiOiAicHJldHRpZXIgLS1jaGVjayAuICYmIGx1bnRlICYmIGJyaXR0bGUgdGVzdC8qLmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcHJvdG9tdXgtd2FrZXVwLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYy4iLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcHJvdG9tdXgtd2FrZXVwL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcHJvdG9tdXgtd2FrZXVwIgp9Ci8vIFRoaXMgZmlsZSBpcyBhdXRvZ2VuZXJhdGVkIGJ5IHRoZSBoeXBlcnNjaGVtYSBjb21waWxlcgovLyBTY2hlbWEgVmVyc2lvbjogMQovKiBlc2xpbnQtZGlzYWJsZSBjYW1lbGNhc2UgKi8KLyogZXNsaW50LWRpc2FibGUgcXVvdGVzICovCgpjb25zdCBWRVJTSU9OID0gMQpjb25zdCB7IGMgfSA9IHJlcXVpcmUoJ2h5cGVyc2NoZW1hL3J1bnRpbWUnKQoKLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC12YXJzCmxldCB2ZXJzaW9uID0gVkVSU0lPTgoKLy8gQHdha2V1cC9pbmZvCmNvbnN0IGVuY29kaW5nMCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDEgc28gYWx3YXlzIG9uZSBieXRlCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gbS5hY3RpdmUgPyAxIDogMAoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgYWN0aXZlOiAoZmxhZ3MgJiAxKSAhPT0gMAogICAgfQogIH0KfQoKLy8gQHdha2V1cC9oYW5kc2hha2UKY29uc3QgZW5jb2RpbmcxID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5jYXBhYmlsaXR5KQogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMSBzbyBhbHdheXMgb25lIGJ5dGUKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSBtLmFjdGl2ZSA/IDEgOiAwCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5jYXBhYmlsaXR5KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiByMCwKICAgICAgY2FwYWJpbGl0eTogcjEsCiAgICAgIGFjdGl2ZTogKGZsYWdzICYgMSkgIT09IDAKICAgIH0KICB9Cn0KCi8vIEB3YWtldXAvd3JpdGVyCmNvbnN0IGVuY29kaW5nMiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBrZXk6IHIwLAogICAgICBsZW5ndGg6IHIxCiAgICB9CiAgfQp9CgovLyBAd2FrZXVwL2Fubm91bmNlCmNvbnN0IGVuY29kaW5nMyA9IGMuYXJyYXkoZW5jb2RpbmcyKQoKLy8gQHdha2V1cC9sb29rdXAKY29uc3QgZW5jb2Rpbmc0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMSBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5oYXNoKSBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gbS5oYXNoID8gMSA6IDAKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5oYXNoKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBoYXNoOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKZnVuY3Rpb24gc2V0VmVyc2lvbih2KSB7CiAgdmVyc2lvbiA9IHYKfQoKZnVuY3Rpb24gZW5jb2RlKG5hbWUsIHZhbHVlLCB2ID0gVkVSU0lPTikgewogIHZlcnNpb24gPSB2CiAgcmV0dXJuIGMuZW5jb2RlKGdldEVuY29kaW5nKG5hbWUpLCB2YWx1ZSkKfQoKZnVuY3Rpb24gZGVjb2RlKG5hbWUsIGJ1ZmZlciwgdiA9IFZFUlNJT04pIHsKICB2ZXJzaW9uID0gdgogIHJldHVybiBjLmRlY29kZShnZXRFbmNvZGluZyhuYW1lKSwgYnVmZmVyKQp9CgpmdW5jdGlvbiBnZXRFbnVtKG5hbWUpIHsKICBzd2l0Y2ggKG5hbWUpIHsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcignRW51bSBub3QgZm91bmQgJyArIG5hbWUpCiAgfQp9CgpmdW5jdGlvbiBnZXRFbmNvZGluZyhuYW1lKSB7CiAgc3dpdGNoIChuYW1lKSB7CiAgICBjYXNlICdAd2FrZXVwL2luZm8nOgogICAgICByZXR1cm4gZW5jb2RpbmcwCiAgICBjYXNlICdAd2FrZXVwL2hhbmRzaGFrZSc6CiAgICAgIHJldHVybiBlbmNvZGluZzEKICAgIGNhc2UgJ0B3YWtldXAvd3JpdGVyJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMgogICAgY2FzZSAnQHdha2V1cC9hbm5vdW5jZSc6CiAgICAgIHJldHVybiBlbmNvZGluZzMKICAgIGNhc2UgJ0B3YWtldXAvbG9va3VwJzoKICAgICAgcmV0dXJuIGVuY29kaW5nNAogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbmNvZGVyIG5vdCBmb3VuZCAnICsgbmFtZSkKICB9Cn0KCmZ1bmN0aW9uIGdldFN0cnVjdChuYW1lLCB2ID0gVkVSU0lPTikgewogIGNvbnN0IGVuYyA9IGdldEVuY29kaW5nKG5hbWUpCiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgICB2ZXJzaW9uID0gdgogICAgICBlbmMucHJlZW5jb2RlKHN0YXRlLCBtKQogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgbSkgewogICAgICB2ZXJzaW9uID0gdgogICAgICBlbmMuZW5jb2RlKHN0YXRlLCBtKQogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICB2ZXJzaW9uID0gdgogICAgICByZXR1cm4gZW5jLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlc29sdmVTdHJ1Y3QgPSBnZXRTdHJ1Y3QgLy8gY29tcGF0Cgptb2R1bGUuZXhwb3J0cyA9IHsKICByZXNvbHZlU3RydWN0LAogIGdldFN0cnVjdCwKICBnZXRFbnVtLAogIGdldEVuY29kaW5nLAogIGVuY29kZSwKICBkZWNvZGUsCiAgc2V0VmVyc2lvbiwKICB2ZXJzaW9uCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBxdWV1ZVRpY2sgPSByZXF1aXJlKCdxdWV1ZS10aWNrJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCB1bnNsYWIgPSByZXF1aXJlKCd1bnNsYWInKQoKY29uc3QgTUFYX0JVRkZFUkVEID0gMzI3NjgKY29uc3QgTUFYX0JBQ0tMT0cgPSBJbmZpbml0eSAvLyBUT0RPOiBpbXBsICJvcGVuIiBiYWNrcHJlc3N1cmUKY29uc3QgTUFYX0JBVENIID0gOCAqIDEwMjQgKiAxMDI0CgpjbGFzcyBDaGFubmVsIHsKICBjb25zdHJ1Y3RvciAobXV4LCBpbmZvLCB1c2VyRGF0YSwgcHJvdG9jb2wsIGFsaWFzZXMsIGlkLCBoYW5kc2hha2UsIG1lc3NhZ2VzLCBvbm9wZW4sIG9uY2xvc2UsIG9uZGVzdHJveSwgb25kcmFpbikgewogICAgdGhpcy51c2VyRGF0YSA9IHVzZXJEYXRhCiAgICB0aGlzLnByb3RvY29sID0gcHJvdG9jb2wKICAgIHRoaXMuYWxpYXNlcyA9IGFsaWFzZXMKICAgIHRoaXMuaWQgPSBpZAogICAgdGhpcy5oYW5kc2hha2UgPSBudWxsCiAgICB0aGlzLm1lc3NhZ2VzID0gW10KCiAgICB0aGlzLm9wZW5lZCA9IGZhbHNlCiAgICB0aGlzLmNsb3NlZCA9IGZhbHNlCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCgogICAgdGhpcy5vbm9wZW4gPSBvbm9wZW4KICAgIHRoaXMub25jbG9zZSA9IG9uY2xvc2UKICAgIHRoaXMub25kZXN0cm95ID0gb25kZXN0cm95CiAgICB0aGlzLm9uZHJhaW4gPSBvbmRyYWluCgogICAgdGhpcy5faGFuZHNoYWtlID0gaGFuZHNoYWtlCiAgICB0aGlzLl9tdXggPSBtdXgKICAgIHRoaXMuX2luZm8gPSBpbmZvCiAgICB0aGlzLl9sb2NhbElkID0gMAogICAgdGhpcy5fcmVtb3RlSWQgPSAwCiAgICB0aGlzLl9hY3RpdmUgPSAwCiAgICB0aGlzLl9leHRlbnNpb25zID0gbnVsbAoKICAgIHRoaXMuX2RlY0JvdW5kID0gdGhpcy5fZGVjLmJpbmQodGhpcykKICAgIHRoaXMuX2RlY0FuZERlc3Ryb3lCb3VuZCA9IHRoaXMuX2RlY0FuZERlc3Ryb3kuYmluZCh0aGlzKQoKICAgIHRoaXMuX29wZW5lZFByb21pc2UgPSBudWxsCiAgICB0aGlzLl9vcGVuZWRSZXNvbHZlID0gbnVsbAoKICAgIHRoaXMuX2Rlc3Ryb3llZFByb21pc2UgPSBudWxsCiAgICB0aGlzLl9kZXN0cm95ZWRSZXNvbHZlID0gbnVsbAoKICAgIGZvciAoY29uc3QgbSBvZiBtZXNzYWdlcykgdGhpcy5hZGRNZXNzYWdlKG0pCiAgfQoKICBnZXQgZHJhaW5lZCAoKSB7CiAgICByZXR1cm4gdGhpcy5fbXV4LmRyYWluZWQKICB9CgogIGZ1bGx5T3BlbmVkICgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKQogICAgaWYgKHRoaXMuY2xvc2VkKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKQogICAgaWYgKHRoaXMuX29wZW5lZFByb21pc2UpIHJldHVybiB0aGlzLl9vcGVuZWRQcm9taXNlCgogICAgdGhpcy5fb3BlbmVkUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7IHRoaXMuX29wZW5lZFJlc29sdmUgPSByZXNvbHZlIH0pCiAgICByZXR1cm4gdGhpcy5fb3BlbmVkUHJvbWlzZQogIH0KCiAgZnVsbHlDbG9zZWQgKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKICAgIGlmICh0aGlzLl9kZXN0cm95ZWRQcm9taXNlKSByZXR1cm4gdGhpcy5fZGVzdHJveWVkUHJvbWlzZQoKICAgIHRoaXMuX2Rlc3Ryb3llZFByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4geyB0aGlzLl9kZXN0cm95ZWRSZXNvbHZlID0gcmVzb2x2ZSB9KQogICAgcmV0dXJuIHRoaXMuX2Rlc3Ryb3llZFByb21pc2UKICB9CgogIG9wZW4gKGhhbmRzaGFrZSkgewogICAgY29uc3QgaWQgPSB0aGlzLl9tdXguX2ZyZWUubGVuZ3RoID4gMAogICAgICA/IHRoaXMuX211eC5fZnJlZS5wb3AoKQogICAgICA6IHRoaXMuX211eC5fbG9jYWwucHVzaChudWxsKSAtIDEKCiAgICB0aGlzLl9pbmZvLm9wZW5lZCsrCiAgICB0aGlzLl9pbmZvLmxhc3RDaGFubmVsID0gdGhpcwogICAgdGhpcy5fbG9jYWxJZCA9IGlkICsgMQogICAgdGhpcy5fbXV4Ll9sb2NhbFtpZF0gPSB0aGlzCgogICAgaWYgKHRoaXMuX3JlbW90ZUlkID09PSAwKSB7CiAgICAgIHRoaXMuX2luZm8ub3V0Z29pbmcucHVzaCh0aGlzLl9sb2NhbElkKQogICAgfQoKICAgIGNvbnN0IHN0YXRlID0geyBidWZmZXI6IG51bGwsIHN0YXJ0OiAyLCBlbmQ6IDIgfQoKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHRoaXMuX2xvY2FsSWQpCiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIHRoaXMucHJvdG9jb2wpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHRoaXMuaWQpCiAgICBpZiAodGhpcy5faGFuZHNoYWtlKSB0aGlzLl9oYW5kc2hha2UucHJlZW5jb2RlKHN0YXRlLCBoYW5kc2hha2UpCgogICAgc3RhdGUuYnVmZmVyID0gdGhpcy5fbXV4Ll9hbGxvYyhzdGF0ZS5lbmQpCgogICAgc3RhdGUuYnVmZmVyWzBdID0gMAogICAgc3RhdGUuYnVmZmVyWzFdID0gMQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdGhpcy5fbG9jYWxJZCkKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgdGhpcy5wcm90b2NvbCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgdGhpcy5pZCkKICAgIGlmICh0aGlzLl9oYW5kc2hha2UpIHRoaXMuX2hhbmRzaGFrZS5lbmNvZGUoc3RhdGUsIGhhbmRzaGFrZSkKCiAgICB0aGlzLl9tdXguX3dyaXRlMChzdGF0ZS5idWZmZXIpCiAgfQoKICBfZGVjICgpIHsKICAgIGlmICgtLXRoaXMuX2FjdGl2ZSA9PT0gMCAmJiB0aGlzLmNsb3NlZCA9PT0gdHJ1ZSkgdGhpcy5fZGVzdHJveSgpCiAgfQoKICBfZGVjQW5kRGVzdHJveSAoZXJyKSB7CiAgICB0aGlzLl9kZWMoKQogICAgdGhpcy5fbXV4Ll9zYWZlRGVzdHJveShlcnIpCiAgfQoKICBfZnVsbHlPcGVuU29vbiAoKSB7CiAgICB0aGlzLl9tdXguX3JlbW90ZVt0aGlzLl9yZW1vdGVJZCAtIDFdLnNlc3Npb24gPSB0aGlzCiAgICBxdWV1ZVRpY2sodGhpcy5fZnVsbHlPcGVuLmJpbmQodGhpcykpCiAgfQoKICBfZnVsbHlPcGVuICgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gdHJ1ZSB8fCB0aGlzLmNsb3NlZCA9PT0gdHJ1ZSkgcmV0dXJuCgogICAgY29uc3QgcmVtb3RlID0gdGhpcy5fbXV4Ll9yZW1vdGVbdGhpcy5fcmVtb3RlSWQgLSAxXQoKICAgIHRoaXMub3BlbmVkID0gdHJ1ZQogICAgdGhpcy5oYW5kc2hha2UgPSB0aGlzLl9oYW5kc2hha2UgPyB0aGlzLl9oYW5kc2hha2UuZGVjb2RlKHJlbW90ZS5zdGF0ZSkgOiBudWxsCiAgICB0aGlzLl90cmFjayh0aGlzLm9ub3Blbih0aGlzLmhhbmRzaGFrZSwgdGhpcykpCgogICAgcmVtb3RlLnNlc3Npb24gPSB0aGlzCiAgICByZW1vdGUuc3RhdGUgPSBudWxsCiAgICBpZiAocmVtb3RlLnBlbmRpbmcgIT09IG51bGwpIHRoaXMuX2RyYWluKHJlbW90ZSkKCiAgICB0aGlzLl9yZXNvbHZlT3Blbih0cnVlKQogIH0KCiAgX3Jlc29sdmVPcGVuIChvcGVuZWQpIHsKICAgIGlmICh0aGlzLl9vcGVuZWRSZXNvbHZlICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX29wZW5lZFJlc29sdmUob3BlbmVkKQogICAgICB0aGlzLl9vcGVuZWRSZXNvbHZlID0gdGhpcy5fb3BlbmVkUHJvbWlzZSA9IG51bGwKICAgIH0KICB9CgogIF9yZXNvbHZlRGVzdHJveWVkICgpIHsKICAgIGlmICh0aGlzLl9kZXN0cm95ZWRSZXNvbHZlICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX2Rlc3Ryb3llZFJlc29sdmUoKQogICAgICB0aGlzLl9kZXN0cm95ZWRSZXNvbHZlID0gdGhpcy5fZGVzdHJveWVkUHJvbWlzZSA9IG51bGwKICAgIH0KICB9CgogIF9kcmFpbiAocmVtb3RlKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlbW90ZS5wZW5kaW5nLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHAgPSByZW1vdGUucGVuZGluZ1tpXQogICAgICB0aGlzLl9tdXguX2J1ZmZlcmVkIC09IGJ5dGVTaXplKHAuc3RhdGUpCiAgICAgIHRoaXMuX3JlY3YocC50eXBlLCBwLnN0YXRlKQogICAgfQoKICAgIHJlbW90ZS5wZW5kaW5nID0gbnVsbAogICAgdGhpcy5fbXV4Ll9yZXN1bWVNYXliZSgpCiAgfQoKICBfdHJhY2sgKHApIHsKICAgIGlmIChpc1Byb21pc2UocCkgPT09IHRydWUpIHsKICAgICAgdGhpcy5fYWN0aXZlKysKICAgICAgcmV0dXJuIHAudGhlbih0aGlzLl9kZWNCb3VuZCwgdGhpcy5fZGVjQW5kRGVzdHJveUJvdW5kKQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBfY2xvc2UgKGlzUmVtb3RlKSB7CiAgICBpZiAodGhpcy5jbG9zZWQgPT09IHRydWUpIHJldHVybgogICAgdGhpcy5jbG9zZWQgPSB0cnVlCgogICAgdGhpcy5faW5mby5vcGVuZWQtLQogICAgaWYgKHRoaXMuX2luZm8ubGFzdENoYW5uZWwgPT09IHRoaXMpIHRoaXMuX2luZm8ubGFzdENoYW5uZWwgPSBudWxsCgogICAgaWYgKHRoaXMuX3JlbW90ZUlkID4gMCkgewogICAgICB0aGlzLl9tdXguX3JlbW90ZVt0aGlzLl9yZW1vdGVJZCAtIDFdID0gbnVsbAogICAgICB0aGlzLl9yZW1vdGVJZCA9IDAKICAgICAgLy8gSWYgcmVtb3RlIGhhcyBhY2tlZCwgd2UgY2FuIHJldXNlIHRoZSBsb2NhbCBpZCBub3cKICAgICAgLy8gb3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHdhaXQgZm9yIHRoZSAiYWNrIiB0byBhcnJpdmUKICAgICAgdGhpcy5fbXV4Ll9mcmVlLnB1c2godGhpcy5fbG9jYWxJZCAtIDEpCiAgICB9CgogICAgdGhpcy5fbXV4Ll9sb2NhbFt0aGlzLl9sb2NhbElkIC0gMV0gPSBudWxsCiAgICB0aGlzLl9sb2NhbElkID0gMAoKICAgIHRoaXMuX211eC5fZ2ModGhpcy5faW5mbykKICAgIHRoaXMuX3RyYWNrKHRoaXMub25jbG9zZShpc1JlbW90ZSwgdGhpcykpCgogICAgaWYgKHRoaXMuX2FjdGl2ZSA9PT0gMCkgdGhpcy5fZGVzdHJveSgpCgogICAgdGhpcy5fcmVzb2x2ZU9wZW4oZmFsc2UpCiAgfQoKICBfZGVzdHJveSAoKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQgPT09IHRydWUpIHJldHVybgogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCiAgICB0aGlzLl90cmFjayh0aGlzLm9uZGVzdHJveSh0aGlzKSkKICAgIHRoaXMuX3Jlc29sdmVEZXN0cm95ZWQoKQogIH0KCiAgX3JlY3YgKHR5cGUsIHN0YXRlKSB7CiAgICBpZiAodHlwZSA8IHRoaXMubWVzc2FnZXMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IG0gPSB0aGlzLm1lc3NhZ2VzW3R5cGVdCiAgICAgIGNvbnN0IHAgPSBtLnJlY3Yoc3RhdGUsIHRoaXMpCiAgICAgIGlmIChtLmF1dG9CYXRjaCA9PT0gdHJ1ZSkgcmV0dXJuIHAKICAgIH0KICAgIHJldHVybiBudWxsCiAgfQoKICBjb3JrICgpIHsKICAgIHRoaXMuX211eC5jb3JrKCkKICB9CgogIHVuY29yayAoKSB7CiAgICB0aGlzLl9tdXgudW5jb3JrKCkKICB9CgogIGNsb3NlICgpIHsKICAgIGlmICh0aGlzLmNsb3NlZCA9PT0gdHJ1ZSkgcmV0dXJuCgogICAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlcjogbnVsbCwgc3RhcnQ6IDIsIGVuZDogMiB9CgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdGhpcy5fbG9jYWxJZCkKCiAgICBzdGF0ZS5idWZmZXIgPSB0aGlzLl9tdXguX2FsbG9jKHN0YXRlLmVuZCkKCiAgICBzdGF0ZS5idWZmZXJbMF0gPSAwCiAgICBzdGF0ZS5idWZmZXJbMV0gPSAzCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB0aGlzLl9sb2NhbElkKQoKICAgIHRoaXMuX2Nsb3NlKGZhbHNlKQogICAgdGhpcy5fbXV4Ll93cml0ZTAoc3RhdGUuYnVmZmVyKQogIH0KCiAgYWRkTWVzc2FnZSAob3B0cykgewogICAgaWYgKCFvcHRzKSByZXR1cm4gdGhpcy5fc2tpcE1lc3NhZ2UoKQoKICAgIGNvbnN0IHR5cGUgPSB0aGlzLm1lc3NhZ2VzLmxlbmd0aAogICAgY29uc3QgYXV0b0JhdGNoID0gb3B0cy5hdXRvQmF0Y2ggIT09IGZhbHNlCiAgICBjb25zdCBlbmNvZGluZyA9IG9wdHMuZW5jb2RpbmcgfHwgYy5yYXcKICAgIGNvbnN0IG9ubWVzc2FnZSA9IG9wdHMub25tZXNzYWdlIHx8IG5vb3AKCiAgICBjb25zdCBzID0gdGhpcwogICAgY29uc3QgdHlwZUxlbiA9IGVuY29kaW5nTGVuZ3RoKGMudWludCwgdHlwZSkKCiAgICBjb25zdCBtID0gewogICAgICB0eXBlLAogICAgICBhdXRvQmF0Y2gsCiAgICAgIGVuY29kaW5nLAogICAgICBvbm1lc3NhZ2UsCiAgICAgIHJlY3YgKHN0YXRlLCBzZXNzaW9uKSB7CiAgICAgICAgcmV0dXJuIHNlc3Npb24uX3RyYWNrKG0ub25tZXNzYWdlKGVuY29kaW5nLmRlY29kZShzdGF0ZSksIHNlc3Npb24pKQogICAgICB9LAogICAgICBzZW5kIChtLCBzZXNzaW9uID0gcykgewogICAgICAgIGlmIChzZXNzaW9uLmNsb3NlZCA9PT0gdHJ1ZSkgcmV0dXJuIGZhbHNlCgogICAgICAgIGNvbnN0IG11eCA9IHNlc3Npb24uX211eAogICAgICAgIGNvbnN0IHN0YXRlID0geyBidWZmZXI6IG51bGwsIHN0YXJ0OiAwLCBlbmQ6IHR5cGVMZW4gfQoKICAgICAgICBpZiAobXV4Ll9iYXRjaCAhPT0gbnVsbCkgewogICAgICAgICAgZW5jb2RpbmcucHJlZW5jb2RlKHN0YXRlLCBtKQogICAgICAgICAgc3RhdGUuYnVmZmVyID0gbXV4Ll9hbGxvYyhzdGF0ZS5lbmQpCgogICAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgdHlwZSkKICAgICAgICAgIGVuY29kaW5nLmVuY29kZShzdGF0ZSwgbSkKCiAgICAgICAgICBtdXguX3B1c2hCYXRjaChzZXNzaW9uLl9sb2NhbElkLCBzdGF0ZS5idWZmZXIpCiAgICAgICAgICByZXR1cm4gdHJ1ZQogICAgICAgIH0KCiAgICAgICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgc2Vzc2lvbi5fbG9jYWxJZCkKICAgICAgICBlbmNvZGluZy5wcmVlbmNvZGUoc3RhdGUsIG0pCgogICAgICAgIHN0YXRlLmJ1ZmZlciA9IG11eC5fYWxsb2Moc3RhdGUuZW5kKQoKICAgICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBzZXNzaW9uLl9sb2NhbElkKQogICAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHR5cGUpCiAgICAgICAgZW5jb2RpbmcuZW5jb2RlKHN0YXRlLCBtKQoKICAgICAgICBtdXguZHJhaW5lZCA9IG11eC5zdHJlYW0ud3JpdGUoc3RhdGUuYnVmZmVyKQoKICAgICAgICByZXR1cm4gbXV4LmRyYWluZWQKICAgICAgfQogICAgfQoKICAgIHRoaXMubWVzc2FnZXMucHVzaChtKQoKICAgIHJldHVybiBtCiAgfQoKICBfc2tpcE1lc3NhZ2UgKCkgewogICAgY29uc3QgdHlwZSA9IHRoaXMubWVzc2FnZXMubGVuZ3RoCiAgICBjb25zdCBtID0gewogICAgICB0eXBlLAogICAgICBlbmNvZGluZzogYy5yYXcsCiAgICAgIG9ubWVzc2FnZTogbm9vcCwKICAgICAgcmVjdiAoc3RhdGUsIHNlc3Npb24pIHt9LAogICAgICBzZW5kIChtLCBzZXNzaW9uKSB7fQogICAgfQoKICAgIHRoaXMubWVzc2FnZXMucHVzaChtKQogICAgcmV0dXJuIG0KICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUHJvdG9tdXggewogIGNvbnN0cnVjdG9yIChzdHJlYW0sIHsgYWxsb2MgfSA9IHt9KSB7CiAgICBpZiAoc3RyZWFtLnVzZXJEYXRhID09PSBudWxsKSBzdHJlYW0udXNlckRhdGEgPSB0aGlzCgogICAgdGhpcy5pc1Byb3RvbXV4ID0gdHJ1ZQogICAgdGhpcy5zdHJlYW0gPSBzdHJlYW0KICAgIHRoaXMuY29ya2VkID0gMAogICAgdGhpcy5kcmFpbmVkID0gdHJ1ZQoKICAgIHRoaXMuX2FsbG9jID0gYWxsb2MgfHwgKHR5cGVvZiBzdHJlYW0uYWxsb2MgPT09ICdmdW5jdGlvbicgPyBzdHJlYW0uYWxsb2MuYmluZChzdHJlYW0pIDogYjRhLmFsbG9jVW5zYWZlKQogICAgdGhpcy5fc2FmZURlc3Ryb3lCb3VuZCA9IHRoaXMuX3NhZmVEZXN0cm95LmJpbmQodGhpcykKICAgIHRoaXMuX3VuY29ya0JvdW5kID0gdGhpcy51bmNvcmsuYmluZCh0aGlzKQoKICAgIHRoaXMuX3JlbW90ZUJhY2tsb2cgPSAwCiAgICB0aGlzLl9idWZmZXJlZCA9IDAKICAgIHRoaXMuX3BhdXNlZCA9IGZhbHNlCiAgICB0aGlzLl9yZW1vdGUgPSBbXQogICAgdGhpcy5fbG9jYWwgPSBbXQogICAgdGhpcy5fZnJlZSA9IFtdCiAgICB0aGlzLl9iYXRjaCA9IG51bGwKICAgIHRoaXMuX2JhdGNoU3RhdGUgPSBudWxsCgogICAgdGhpcy5faW5mb3MgPSBuZXcgTWFwKCkKICAgIHRoaXMuX25vdGlmeSA9IG5ldyBNYXAoKQoKICAgIHRoaXMuc3RyZWFtLm9uKCdkYXRhJywgdGhpcy5fb25kYXRhLmJpbmQodGhpcykpCiAgICB0aGlzLnN0cmVhbS5vbignZHJhaW4nLCB0aGlzLl9vbmRyYWluLmJpbmQodGhpcykpCiAgICB0aGlzLnN0cmVhbS5vbignZW5kJywgdGhpcy5fb25lbmQuYmluZCh0aGlzKSkKICAgIHRoaXMuc3RyZWFtLm9uKCdlcnJvcicsIG5vb3ApIC8vIHdlIGhhbmRsZSB0aGlzIGluICJjbG9zZSIKICAgIHRoaXMuc3RyZWFtLm9uKCdjbG9zZScsIHRoaXMuX3NodXRkb3duLmJpbmQodGhpcykpCiAgfQoKICBzdGF0aWMgZnJvbSAoc3RyZWFtLCBvcHRzKSB7CiAgICBpZiAoc3RyZWFtLnVzZXJEYXRhICYmIHN0cmVhbS51c2VyRGF0YS5pc1Byb3RvbXV4KSByZXR1cm4gc3RyZWFtLnVzZXJEYXRhCiAgICBpZiAoc3RyZWFtLmlzUHJvdG9tdXgpIHJldHVybiBzdHJlYW0KICAgIHJldHVybiBuZXcgdGhpcyhzdHJlYW0sIG9wdHMpCiAgfQoKICBzdGF0aWMgaXNQcm90b211eCAobXV4KSB7CiAgICByZXR1cm4gdHlwZW9mIG11eCA9PT0gJ29iamVjdCcgJiYgbXV4LmlzUHJvdG9tdXggPT09IHRydWUKICB9CgogICogW1N5bWJvbC5pdGVyYXRvcl0gKCkgewogICAgZm9yIChjb25zdCBzZXNzaW9uIG9mIHRoaXMuX2xvY2FsKSB7CiAgICAgIGlmIChzZXNzaW9uICE9PSBudWxsKSB5aWVsZCBzZXNzaW9uCiAgICB9CiAgfQoKICBpc0lkbGUgKCkgewogICAgcmV0dXJuIHRoaXMuX2xvY2FsLmxlbmd0aCA9PT0gdGhpcy5fZnJlZS5sZW5ndGgKICB9CgogIGNvcmsgKCkgewogICAgaWYgKCsrdGhpcy5jb3JrZWQgPT09IDEpIHsKICAgICAgdGhpcy5fYmF0Y2ggPSBbXQogICAgICB0aGlzLl9iYXRjaFN0YXRlID0geyBidWZmZXI6IG51bGwsIHN0YXJ0OiAwLCBlbmQ6IDEgfQogICAgfQogIH0KCiAgdW5jb3JrICgpIHsKICAgIGlmICgtLXRoaXMuY29ya2VkID09PSAwKSB7CiAgICAgIHRoaXMuX3NlbmRCYXRjaCh0aGlzLl9iYXRjaCwgdGhpcy5fYmF0Y2hTdGF0ZSkKICAgICAgdGhpcy5fYmF0Y2ggPSBudWxsCiAgICAgIHRoaXMuX2JhdGNoU3RhdGUgPSBudWxsCiAgICB9CiAgfQoKICBnZXRMYXN0Q2hhbm5lbCAoeyBwcm90b2NvbCwgaWQgPSBudWxsIH0pIHsKICAgIGNvbnN0IGtleSA9IHRvS2V5KHByb3RvY29sLCBpZCkKICAgIGNvbnN0IGluZm8gPSB0aGlzLl9pbmZvcy5nZXQoa2V5KQogICAgaWYgKGluZm8pIHJldHVybiBpbmZvLmxhc3RDaGFubmVsCiAgICByZXR1cm4gbnVsbAogIH0KCiAgcGFpciAoeyBwcm90b2NvbCwgaWQgPSBudWxsIH0sIG5vdGlmeSkgewogICAgdGhpcy5fbm90aWZ5LnNldCh0b0tleShwcm90b2NvbCwgaWQpLCBub3RpZnkpCiAgfQoKICB1bnBhaXIgKHsgcHJvdG9jb2wsIGlkID0gbnVsbCB9KSB7CiAgICB0aGlzLl9ub3RpZnkuZGVsZXRlKHRvS2V5KHByb3RvY29sLCBpZCkpCiAgfQoKICBvcGVuZWQgKHsgcHJvdG9jb2wsIGlkID0gbnVsbCB9KSB7CiAgICBjb25zdCBrZXkgPSB0b0tleShwcm90b2NvbCwgaWQpCiAgICBjb25zdCBpbmZvID0gdGhpcy5faW5mb3MuZ2V0KGtleSkKICAgIHJldHVybiBpbmZvID8gaW5mby5vcGVuZWQgPiAwIDogZmFsc2UKICB9CgogIGNyZWF0ZUNoYW5uZWwgKHsgdXNlckRhdGEgPSBudWxsLCBwcm90b2NvbCwgYWxpYXNlcyA9IFtdLCBpZCA9IG51bGwsIHVuaXF1ZSA9IHRydWUsIGhhbmRzaGFrZSA9IG51bGwsIG1lc3NhZ2VzID0gW10sIG9ub3BlbiA9IG5vb3AsIG9uY2xvc2UgPSBub29wLCBvbmRlc3Ryb3kgPSBub29wLCBvbmRyYWluID0gbm9vcCB9KSB7CiAgICBpZiAodGhpcy5zdHJlYW0uZGVzdHJveWVkKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IGluZm8gPSB0aGlzLl9nZXQocHJvdG9jb2wsIGlkLCBhbGlhc2VzKQogICAgaWYgKHVuaXF1ZSAmJiBpbmZvLm9wZW5lZCA+IDApIHJldHVybiBudWxsCgogICAgaWYgKGluZm8uaW5jb21pbmcubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBuZXcgQ2hhbm5lbCh0aGlzLCBpbmZvLCB1c2VyRGF0YSwgcHJvdG9jb2wsIGFsaWFzZXMsIGlkLCBoYW5kc2hha2UsIG1lc3NhZ2VzLCBvbm9wZW4sIG9uY2xvc2UsIG9uZGVzdHJveSwgb25kcmFpbikKICAgIH0KCiAgICB0aGlzLl9yZW1vdGVCYWNrbG9nLS0KCiAgICBjb25zdCByZW1vdGVJZCA9IGluZm8uaW5jb21pbmcuc2hpZnQoKQogICAgY29uc3QgciA9IHRoaXMuX3JlbW90ZVtyZW1vdGVJZCAtIDFdCiAgICBpZiAociA9PT0gbnVsbCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBzZXNzaW9uID0gbmV3IENoYW5uZWwodGhpcywgaW5mbywgdXNlckRhdGEsIHByb3RvY29sLCBhbGlhc2VzLCBpZCwgaGFuZHNoYWtlLCBtZXNzYWdlcywgb25vcGVuLCBvbmNsb3NlLCBvbmRlc3Ryb3ksIG9uZHJhaW4pCgogICAgc2Vzc2lvbi5fcmVtb3RlSWQgPSByZW1vdGVJZAogICAgc2Vzc2lvbi5fZnVsbHlPcGVuU29vbigpCgogICAgcmV0dXJuIHNlc3Npb24KICB9CgogIF9wdXNoQmF0Y2ggKGxvY2FsSWQsIGJ1ZmZlcikgewogICAgaWYgKHRoaXMuX2JhdGNoU3RhdGUuZW5kID49IE1BWF9CQVRDSCkgewogICAgICB0aGlzLl9zZW5kQmF0Y2godGhpcy5fYmF0Y2gsIHRoaXMuX2JhdGNoU3RhdGUpCiAgICAgIHRoaXMuX2JhdGNoID0gW10KICAgICAgdGhpcy5fYmF0Y2hTdGF0ZSA9IHsgYnVmZmVyOiBudWxsLCBzdGFydDogMCwgZW5kOiAxIH0KICAgIH0KCiAgICBpZiAodGhpcy5fYmF0Y2gubGVuZ3RoID09PSAwIHx8IHRoaXMuX2JhdGNoW3RoaXMuX2JhdGNoLmxlbmd0aCAtIDFdLmxvY2FsSWQgIT09IGxvY2FsSWQpIHsKICAgICAgdGhpcy5fYmF0Y2hTdGF0ZS5lbmQrKwogICAgICBjLnVpbnQucHJlZW5jb2RlKHRoaXMuX2JhdGNoU3RhdGUsIGxvY2FsSWQpCiAgICB9CiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUodGhpcy5fYmF0Y2hTdGF0ZSwgYnVmZmVyKQogICAgdGhpcy5fYmF0Y2gucHVzaCh7IGxvY2FsSWQsIGJ1ZmZlciB9KQogIH0KCiAgX3NlbmRCYXRjaCAoYmF0Y2gsIHN0YXRlKSB7CiAgICBpZiAoYmF0Y2gubGVuZ3RoID09PSAwKSByZXR1cm4KCiAgICBsZXQgcHJldiA9IGJhdGNoWzBdLmxvY2FsSWQKCiAgICBzdGF0ZS5idWZmZXIgPSB0aGlzLl9hbGxvYyhzdGF0ZS5lbmQpCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAwCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAwCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgcHJldikKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJhdGNoLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGIgPSBiYXRjaFtpXQogICAgICBpZiAocHJldiAhPT0gYi5sb2NhbElkKSB7CiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMAogICAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIChwcmV2ID0gYi5sb2NhbElkKSkKICAgICAgfQogICAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIGIuYnVmZmVyKQogICAgfQoKICAgIHRoaXMuZHJhaW5lZCA9IHRoaXMuc3RyZWFtLndyaXRlKHN0YXRlLmJ1ZmZlcikKICB9CgogIF9nZXQgKHByb3RvY29sLCBpZCwgYWxpYXNlcyA9IFtdKSB7CiAgICBjb25zdCBrZXkgPSB0b0tleShwcm90b2NvbCwgaWQpCgogICAgbGV0IGluZm8gPSB0aGlzLl9pbmZvcy5nZXQoa2V5KQogICAgaWYgKGluZm8pIHJldHVybiBpbmZvCgogICAgaW5mbyA9IHsga2V5LCBwcm90b2NvbCwgYWxpYXNlczogW10sIGlkLCBwYWlyaW5nOiAwLCBvcGVuZWQ6IDAsIGluY29taW5nOiBbXSwgb3V0Z29pbmc6IFtdLCBsYXN0Q2hhbm5lbDogbnVsbCB9CiAgICB0aGlzLl9pbmZvcy5zZXQoa2V5LCBpbmZvKQoKICAgIGZvciAoY29uc3QgYWxpYXMgb2YgYWxpYXNlcykgewogICAgICBjb25zdCBrZXkgPSB0b0tleShhbGlhcywgaWQpCiAgICAgIGluZm8uYWxpYXNlcy5wdXNoKGtleSkKCiAgICAgIHRoaXMuX2luZm9zLnNldChrZXksIGluZm8pCiAgICB9CgogICAgcmV0dXJuIGluZm8KICB9CgogIF9nYyAoaW5mbykgewogICAgaWYgKGluZm8ub3BlbmVkID09PSAwICYmIGluZm8ub3V0Z29pbmcubGVuZ3RoID09PSAwICYmIGluZm8uaW5jb21pbmcubGVuZ3RoID09PSAwKSB7CiAgICAgIHRoaXMuX2luZm9zLmRlbGV0ZShpbmZvLmtleSkKCiAgICAgIGZvciAoY29uc3QgYWxpYXMgb2YgaW5mby5hbGlhc2VzKSB0aGlzLl9pbmZvcy5kZWxldGUoYWxpYXMpCiAgICB9CiAgfQoKICBfb25kYXRhIChidWZmZXIpIHsKICAgIGlmIChidWZmZXIuYnl0ZUxlbmd0aCA9PT0gMCkgcmV0dXJuIC8vIGlnbm9yZSBlbXB0eSBmcmFtZXMuLi4KICAgIHRyeSB7CiAgICAgIGNvbnN0IHN0YXRlID0geyBidWZmZXIsIHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoIH0KICAgICAgdGhpcy5fZGVjb2RlKGMudWludC5kZWNvZGUoc3RhdGUpLCBzdGF0ZSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLl9zYWZlRGVzdHJveShlcnIpCiAgICB9CiAgfQoKICBfb25kcmFpbiAoKSB7CiAgICB0aGlzLmRyYWluZWQgPSB0cnVlCgogICAgZm9yIChjb25zdCBzIG9mIHRoaXMuX2xvY2FsKSB7CiAgICAgIGlmIChzICE9PSBudWxsKSBzLl90cmFjayhzLm9uZHJhaW4ocykpCiAgICB9CiAgfQoKICBfb25lbmQgKCkgeyAvLyBUT0RPOiBzdXBwb3J0IGhhbGYgb3BlbiBtb2RlIGZvciB0aGUgdXNlcnMgd2hvIHdhbnRzIHRoYXQgaGVyZQogICAgdGhpcy5zdHJlYW0uZW5kKCkKICB9CgogIF9kZWNvZGUgKHJlbW90ZUlkLCBzdGF0ZSkgewogICAgY29uc3QgdHlwZSA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgaWYgKHJlbW90ZUlkID09PSAwKSB7CiAgICAgIHJldHVybiB0aGlzLl9vbmNvbnRyb2xzZXNzaW9uKHR5cGUsIHN0YXRlKQogICAgfQoKICAgIGNvbnN0IHIgPSByZW1vdGVJZCA8PSB0aGlzLl9yZW1vdGUubGVuZ3RoID8gdGhpcy5fcmVtb3RlW3JlbW90ZUlkIC0gMV0gOiBudWxsCgogICAgLy8gaWYgdGhlIGNoYW5uZWwgaXMgY2xvc2VkIGlnbm9yZSAtIGNvdWxkIGp1c3QgYmUgYSBwaXBlbGluZSBtZXNzYWdlLi4uCiAgICBpZiAociA9PT0gbnVsbCkgcmV0dXJuIG51bGwKCiAgICBpZiAoci5wZW5kaW5nICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX2J1ZmZlck1lc3NhZ2UociwgdHlwZSwgc3RhdGUpCiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgcmV0dXJuIHIuc2Vzc2lvbi5fcmVjdih0eXBlLCBzdGF0ZSkKICB9CgogIF9vbmNvbnRyb2xzZXNzaW9uICh0eXBlLCBzdGF0ZSkgewogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLl9vbmJhdGNoKHN0YXRlKQogICAgICAgIGJyZWFrCgogICAgICBjYXNlIDE6CiAgICAgICAgLy8gcmV0dXJuIHRoZSBwcm9taXNlIGJhY2sgdXAgYXMgdGhpcyBoYXMgc2lkZWVmZmVjdHMgc28gd2UgY2FuIGJhdGNoIHJlcGx5CiAgICAgICAgcmV0dXJuIHRoaXMuX29ub3BlbnNlc3Npb24oc3RhdGUpCgogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy5fb25yZWplY3RzZXNzaW9uKHN0YXRlKQogICAgICAgIGJyZWFrCgogICAgICBjYXNlIDM6CiAgICAgICAgdGhpcy5fb25jbG9zZXNlc3Npb24oc3RhdGUpCiAgICAgICAgYnJlYWsKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgX2J1ZmZlck1lc3NhZ2UgKHIsIHR5cGUsIHsgYnVmZmVyLCBzdGFydCwgZW5kIH0pIHsKICAgIGNvbnN0IHN0YXRlID0geyBidWZmZXIsIHN0YXJ0LCBlbmQgfSAvLyBjb3B5CiAgICByLnBlbmRpbmcucHVzaCh7IHR5cGUsIHN0YXRlIH0pCiAgICB0aGlzLl9idWZmZXJlZCArPSBieXRlU2l6ZShzdGF0ZSkKICAgIHRoaXMuX3BhdXNlTWF5YmUoKQogIH0KCiAgX3BhdXNlTWF5YmUgKCkgewogICAgaWYgKHRoaXMuX3BhdXNlZCA9PT0gdHJ1ZSB8fCB0aGlzLl9idWZmZXJlZCA8PSBNQVhfQlVGRkVSRUQpIHJldHVybgogICAgdGhpcy5fcGF1c2VkID0gdHJ1ZQogICAgdGhpcy5zdHJlYW0ucGF1c2UoKQogIH0KCiAgX3Jlc3VtZU1heWJlICgpIHsKICAgIGlmICh0aGlzLl9wYXVzZWQgPT09IGZhbHNlIHx8IHRoaXMuX2J1ZmZlcmVkID4gTUFYX0JVRkZFUkVEKSByZXR1cm4KICAgIHRoaXMuX3BhdXNlZCA9IGZhbHNlCiAgICB0aGlzLnN0cmVhbS5yZXN1bWUoKQogIH0KCiAgX29uYmF0Y2ggKHN0YXRlKSB7CiAgICBjb25zdCBlbmQgPSBzdGF0ZS5lbmQKICAgIGxldCByZW1vdGVJZCA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgbGV0IHdhaXRpbmcgPSBudWxsCgogICAgd2hpbGUgKHN0YXRlLmVuZCA+IHN0YXRlLnN0YXJ0KSB7CiAgICAgIGNvbnN0IGxlbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICAgIGlmIChsZW4gPT09IDApIHsKICAgICAgICByZW1vdGVJZCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICAgICAgY29udGludWUKICAgICAgfQogICAgICBzdGF0ZS5lbmQgPSBzdGF0ZS5zdGFydCArIGxlbgogICAgICAvLyBpZiBiYXRjaCBjb250YWlucyBtb3JlIHRoYW4gb25lIG1lc3NhZ2UsIGNvcmsgaXQgc28gd2UgcmVwbHkgYmFjayB3aXRoIGEgYmF0Y2gKICAgICAgaWYgKGVuZCAhPT0gc3RhdGUuZW5kICYmIHdhaXRpbmcgPT09IG51bGwpIHsKICAgICAgICB3YWl0aW5nID0gW10KICAgICAgICB0aGlzLmNvcmsoKQogICAgICB9CiAgICAgIGNvbnN0IHAgPSB0aGlzLl9kZWNvZGUocmVtb3RlSWQsIHN0YXRlKQogICAgICBpZiAod2FpdGluZyAhPT0gbnVsbCAmJiBwICE9PSBudWxsKSB3YWl0aW5nLnB1c2gocCkKICAgICAgc3RhdGUuc3RhcnQgPSBzdGF0ZS5lbmQKICAgICAgc3RhdGUuZW5kID0gZW5kCiAgICB9CgogICAgaWYgKHdhaXRpbmcgIT09IG51bGwpIHsKICAgICAgLy8gdGhlIHdhaXRpbmcgcHJvbWlzZXMgYXJlIG5vdCBhbGxvd2VkIHRvIHRocm93IGJ1dCB3ZSBkZXN0cm95IHRoZSBzdHJlYW0gaW4gY2FzZSB3ZSBhcmUgd3JvbmcKICAgICAgUHJvbWlzZS5hbGwod2FpdGluZykudGhlbih0aGlzLl91bmNvcmtCb3VuZCwgdGhpcy5fc2FmZURlc3Ryb3lCb3VuZCkKICAgIH0KICB9CgogIF9vbm9wZW5zZXNzaW9uIChzdGF0ZSkgewogICAgY29uc3QgcmVtb3RlSWQgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcHJvdG9jb2wgPSBjLnN0cmluZy5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBpZCA9IHVuc2xhYihjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpKQoKICAgIC8vIHJlbW90ZSB0cmllZCB0byBvcGVuIHRoZSBjb250cm9sIHNlc3Npb24gLSBhdXRvIHJlamVjdCBmb3Igbm93CiAgICAvLyBhcyB3ZSBjYW4gdXNlIGFzIGFuIGV4cGxpY2l0IGNvbnRyb2wgcHJvdG9jb2wgZGVjbGFyYXRpb24gaWYgd2UgbmVlZCB0bwogICAgaWYgKHJlbW90ZUlkID09PSAwKSB7CiAgICAgIHRoaXMuX3JlamVjdFNlc3Npb24oMCkKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBjb25zdCByaWQgPSByZW1vdGVJZCAtIDEKICAgIGNvbnN0IGluZm8gPSB0aGlzLl9nZXQocHJvdG9jb2wsIGlkKQoKICAgIC8vIGFsbG93IHRoZSByZW1vdGUgdG8gZ3JvdyB0aGUgaWRzIGJ5IG9uZQogICAgaWYgKHRoaXMuX3JlbW90ZS5sZW5ndGggPT09IHJpZCkgewogICAgICB0aGlzLl9yZW1vdGUucHVzaChudWxsKQogICAgfQoKICAgIGlmIChyaWQgPj0gdGhpcy5fcmVtb3RlLmxlbmd0aCB8fCB0aGlzLl9yZW1vdGVbcmlkXSAhPT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgb3BlbiBtZXNzYWdlJykKICAgIH0KCiAgICBpZiAoaW5mby5vdXRnb2luZy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IGxvY2FsSWQgPSBpbmZvLm91dGdvaW5nLnNoaWZ0KCkKICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuX2xvY2FsW2xvY2FsSWQgLSAxXQoKICAgICAgaWYgKHNlc3Npb24gPT09IG51bGwpIHsgLy8gd2UgYWxyZWFkeSBjbG9zZWQgdGhlIGNoYW5uZWwgLSBpZ25vcmUKICAgICAgICB0aGlzLl9mcmVlLnB1c2gobG9jYWxJZCAtIDEpCiAgICAgICAgcmV0dXJuIG51bGwKICAgICAgfQoKICAgICAgdGhpcy5fcmVtb3RlW3JpZF0gPSB7IHN0YXRlLCBwZW5kaW5nOiBudWxsLCBzZXNzaW9uOiBudWxsIH0KCiAgICAgIHNlc3Npb24uX3JlbW90ZUlkID0gcmVtb3RlSWQKICAgICAgc2Vzc2lvbi5fZnVsbHlPcGVuKCkKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBjb25zdCBjb3B5U3RhdGUgPSB7IGJ1ZmZlcjogc3RhdGUuYnVmZmVyLCBzdGFydDogc3RhdGUuc3RhcnQsIGVuZDogc3RhdGUuZW5kIH0KICAgIHRoaXMuX3JlbW90ZVtyaWRdID0geyBzdGF0ZTogY29weVN0YXRlLCBwZW5kaW5nOiBbXSwgc2Vzc2lvbjogbnVsbCB9CgogICAgaWYgKCsrdGhpcy5fcmVtb3RlQmFja2xvZyA+IE1BWF9CQUNLTE9HKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignUmVtb3RlIGV4Y2VlZGVkIGJhY2tsb2cnKQogICAgfQoKICAgIGluZm8ucGFpcmluZysrCiAgICBpbmZvLmluY29taW5nLnB1c2gocmVtb3RlSWQpCgogICAgcmV0dXJuIHRoaXMuX3JlcXVlc3RTZXNzaW9uKHByb3RvY29sLCBpZCwgaW5mbykuY2F0Y2godGhpcy5fc2FmZURlc3Ryb3lCb3VuZCkKICB9CgogIF9vbnJlamVjdHNlc3Npb24gKHN0YXRlKSB7CiAgICBjb25zdCBsb2NhbElkID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICAvLyBUT0RPOiBjYW4gYmUgZG9uZSBzbWFydGVyLi4uCiAgICBmb3IgKGNvbnN0IGluZm8gb2YgdGhpcy5faW5mb3MudmFsdWVzKCkpIHsKICAgICAgY29uc3QgaSA9IGluZm8ub3V0Z29pbmcuaW5kZXhPZihsb2NhbElkKQogICAgICBpZiAoaSA9PT0gLTEpIGNvbnRpbnVlCgogICAgICBpbmZvLm91dGdvaW5nLnNwbGljZShpLCAxKQoKICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuX2xvY2FsW2xvY2FsSWQgLSAxXQoKICAgICAgdGhpcy5fZnJlZS5wdXNoKGxvY2FsSWQgLSAxKQogICAgICBpZiAoc2Vzc2lvbiAhPT0gbnVsbCkgc2Vzc2lvbi5fY2xvc2UodHJ1ZSkKCiAgICAgIHRoaXMuX2djKGluZm8pCiAgICAgIHJldHVybgogICAgfQoKICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCByZWplY3QgbWVzc2FnZScpCiAgfQoKICBfb25jbG9zZXNlc3Npb24gKHN0YXRlKSB7CiAgICBjb25zdCByZW1vdGVJZCA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgaWYgKHJlbW90ZUlkID09PSAwKSByZXR1cm4gLy8gaWdub3JlCgogICAgY29uc3QgcmlkID0gcmVtb3RlSWQgLSAxCiAgICBjb25zdCByID0gcmlkIDwgdGhpcy5fcmVtb3RlLmxlbmd0aCA/IHRoaXMuX3JlbW90ZVtyaWRdIDogbnVsbAoKICAgIGlmIChyID09PSBudWxsKSByZXR1cm4KCiAgICBpZiAoci5zZXNzaW9uICE9PSBudWxsKSByLnNlc3Npb24uX2Nsb3NlKHRydWUpCiAgfQoKICBhc3luYyBfcmVxdWVzdFNlc3Npb24gKHByb3RvY29sLCBpZCwgaW5mbykgewogICAgY29uc3Qgbm90aWZ5ID0gdGhpcy5fbm90aWZ5LmdldCh0b0tleShwcm90b2NvbCwgaWQpKSB8fCB0aGlzLl9ub3RpZnkuZ2V0KHRvS2V5KHByb3RvY29sLCBudWxsKSkKCiAgICBpZiAobm90aWZ5KSBhd2FpdCBub3RpZnkoaWQpCgogICAgaWYgKC0taW5mby5wYWlyaW5nID4gMCkgcmV0dXJuCgogICAgd2hpbGUgKGluZm8uaW5jb21pbmcubGVuZ3RoID4gMCkgewogICAgICB0aGlzLl9yZWplY3RTZXNzaW9uKGluZm8sIGluZm8uaW5jb21pbmcuc2hpZnQoKSkKICAgIH0KCiAgICB0aGlzLl9nYyhpbmZvKQogIH0KCiAgX3JlamVjdFNlc3Npb24gKGluZm8sIHJlbW90ZUlkKSB7CiAgICBpZiAocmVtb3RlSWQgPiAwKSB7CiAgICAgIGNvbnN0IHIgPSB0aGlzLl9yZW1vdGVbcmVtb3RlSWQgLSAxXQoKICAgICAgaWYgKHIucGVuZGluZyAhPT0gbnVsbCkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgci5wZW5kaW5nLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB0aGlzLl9idWZmZXJlZCAtPSBieXRlU2l6ZShyLnBlbmRpbmdbaV0uc3RhdGUpCiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLl9yZW1vdGVbcmVtb3RlSWQgLSAxXSA9IG51bGwKICAgICAgdGhpcy5fcmVzdW1lTWF5YmUoKQogICAgfQoKICAgIGNvbnN0IHN0YXRlID0geyBidWZmZXI6IG51bGwsIHN0YXJ0OiAyLCBlbmQ6IDIgfQoKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHJlbW90ZUlkKQoKICAgIHN0YXRlLmJ1ZmZlciA9IHRoaXMuX2FsbG9jKHN0YXRlLmVuZCkKCiAgICBzdGF0ZS5idWZmZXJbMF0gPSAwCiAgICBzdGF0ZS5idWZmZXJbMV0gPSAyCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCByZW1vdGVJZCkKCiAgICB0aGlzLl93cml0ZTAoc3RhdGUuYnVmZmVyKQogIH0KCiAgX3dyaXRlMCAoYnVmZmVyKSB7CiAgICBpZiAodGhpcy5fYmF0Y2ggIT09IG51bGwpIHsKICAgICAgdGhpcy5fcHVzaEJhdGNoKDAsIGJ1ZmZlci5zdWJhcnJheSgxKSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5kcmFpbmVkID0gdGhpcy5zdHJlYW0ud3JpdGUoYnVmZmVyKQogIH0KCiAgZGVzdHJveSAoZXJyKSB7CiAgICB0aGlzLnN0cmVhbS5kZXN0cm95KGVycikKICB9CgogIF9zYWZlRGVzdHJveSAoZXJyKSB7CiAgICBzYWZldHlDYXRjaChlcnIpCiAgICB0aGlzLnN0cmVhbS5kZXN0cm95KGVycikKICB9CgogIF9zaHV0ZG93biAoKSB7CiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5fbG9jYWwpIHsKICAgICAgaWYgKHMgIT09IG51bGwpIHMuX2Nsb3NlKHRydWUpCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBub29wICgpIHt9CgpmdW5jdGlvbiB0b0tleSAocHJvdG9jb2wsIGlkKSB7CiAgcmV0dXJuIHByb3RvY29sICsgJyMjJyArIChpZCA/IGI0YS50b1N0cmluZyhpZCwgJ2hleCcpIDogJycpCn0KCmZ1bmN0aW9uIGJ5dGVTaXplIChzdGF0ZSkgewogIHJldHVybiA1MTIgKyAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQpCn0KCmZ1bmN0aW9uIGlzUHJvbWlzZSAocCkgewogIHJldHVybiAhIShwICYmIHR5cGVvZiBwLnRoZW4gPT09ICdmdW5jdGlvbicpCn0KCmZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChlbmMsIHZhbCkgewogIGNvbnN0IHN0YXRlID0geyBidWZmZXI6IG51bGwsIHN0YXJ0OiAwLCBlbmQ6IDAgfQogIGVuYy5wcmVlbmNvZGUoc3RhdGUsIHZhbCkKICByZXR1cm4gc3RhdGUuZW5kCn0KewogICJuYW1lIjogInByb3RvbXV4IiwKICAidmVyc2lvbiI6ICIzLjEwLjEiLAogICJkZXNjcmlwdGlvbiI6ICJNdWx0aXBsZXggbXVsdGlwbGUgbWVzc2FnZSBvcmllbnRlZCBwcm90b2NvbHMgb3ZlciBhIHN0cmVhbSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjMuMSIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi41LjEiLAogICAgInF1ZXVlLXRpY2siOiAiXjEuMC4wIiwKICAgICJzYWZldHktY2F0Y2giOiAiXjEuMC4xIiwKICAgICJ1bnNsYWIiOiAiXjEuMy4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtIjogIl42LjAuMCIsCiAgICAiYnJpdHRsZSI6ICJeMy4wLjAiLAogICAgInN0YW5kYXJkIjogIl4xNi4wLjQiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9wcm90b211eC5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcHJvdG9tdXgvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcHJvdG9tdXgiCn0KewogICJuYW1lIjogInF1ZXVlLXRpY2siLAogICJ2ZXJzaW9uIjogIjEuMC4xIiwKICAiZGVzY3JpcHRpb24iOiAiTmV4dCB0aWNrIHNoaW0gdGhhdCBwcmVmZXJzIHByb2Nlc3MubmV4dFRpY2sgb3ZlciBxdWV1ZU1pY3JvdGFzayBmb3IgY29tcGF0IiwKICAibWFpbiI6ICIuL3Byb2Nlc3MtbmV4dC10aWNrLmpzIiwKICAiYnJvd3NlciI6ICIuL3F1ZXVlLW1pY3JvdGFzay5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE2LjAuMyIsCiAgICAidGFwZSI6ICJeNS4zLjEiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9xdWV1ZS10aWNrLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9xdWV1ZS10aWNrL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3F1ZXVlLXRpY2siCn0KbW9kdWxlLmV4cG9ydHMgPSAodHlwZW9mIHByb2Nlc3MgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBwcm9jZXNzLm5leHRUaWNrID09PSAnZnVuY3Rpb24nKQogID8gcHJvY2Vzcy5uZXh0VGljay5iaW5kKHByb2Nlc3MpCiAgOiByZXF1aXJlKCcuL3F1ZXVlLW1pY3JvdGFzaycpCm1vZHVsZS5leHBvcnRzID0gdHlwZW9mIHF1ZXVlTWljcm90YXNrID09PSAnZnVuY3Rpb24nID8gcXVldWVNaWNyb3Rhc2sgOiAoZm4pID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oZm4pCnJlcXVpcmUuYWRkb24gPSByZXF1aXJlKCdyZXF1aXJlLWFkZG9uJykKCm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZS5hZGRvbignLicsIF9fZmlsZW5hbWUpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuL2JpbmRpbmcnKQoKZXhwb3J0cy5nZXQgPSBmdW5jdGlvbiBnZXQoZmllbGQsIGJpdCkgewogIGNvbnN0IG4gPSBmaWVsZC5ieXRlTGVuZ3RoICogOAoKICBpZiAoYml0IDwgMCkgYml0ICs9IG4KICBpZiAoYml0IDwgMCB8fCBiaXQgPj0gbikgcmV0dXJuIGZhbHNlCgogIHJldHVybiBiaW5kaW5nLnF1aWNrYml0X25hcGlfZ2V0KHRvQnVmZmVyKGZpZWxkKSwgYml0KSAhPT0gMAp9CgpleHBvcnRzLnNldCA9IGZ1bmN0aW9uIHNldChmaWVsZCwgYml0LCB2YWx1ZSA9IHRydWUpIHsKICBjb25zdCBuID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgaWYgKGJpdCA8IDApIGJpdCArPSBuCiAgaWYgKGJpdCA8IDAgfHwgYml0ID49IG4pIHJldHVybiBmYWxzZQoKICByZXR1cm4gYmluZGluZy5xdWlja2JpdF9uYXBpX3NldCh0b0J1ZmZlcihmaWVsZCksIGJpdCwgdmFsdWUgPyAxIDogMCkgIT09IDAKfQoKZXhwb3J0cy5maWxsID0gZnVuY3Rpb24gZmlsbCgKICBmaWVsZCwKICB2YWx1ZSwKICBzdGFydCA9IDAsCiAgZW5kID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgKKSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogIGlmIChzdGFydCA8IDApIHN0YXJ0ICs9IG4KICBpZiAoZW5kIDwgMCkgZW5kICs9IG4KICBpZiAoc3RhcnQgPCAwIHx8IHN0YXJ0ID49IGZpZWxkLmJ5dGVMZW5ndGggKiA4IHx8IHN0YXJ0ID49IGVuZCkgcmV0dXJuIGZpZWxkCgogIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9maWxsKHRvQnVmZmVyKGZpZWxkKSwgdmFsdWUgPyAxIDogMCwgc3RhcnQsIGVuZCkKICByZXR1cm4gZmllbGQKfQoKZXhwb3J0cy5jbGVhciA9IGZ1bmN0aW9uIGNsZWFyKGZpZWxkLCAuLi5jaHVua3MpIHsKICBiaW5kaW5nLnF1aWNrYml0X25hcGlfY2xlYXIodG9CdWZmZXIoZmllbGQpLCBjaHVua3MubWFwKHRvQnVmZmVyQ2h1bmspKQp9CgpleHBvcnRzLmZpbmRGaXJzdCA9IGZ1bmN0aW9uIGZpbmRGaXJzdChmaWVsZCwgdmFsdWUsIHBvc2l0aW9uID0gMCkgewogIGNvbnN0IG4gPSBmaWVsZC5ieXRlTGVuZ3RoICogOAoKICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiArPSBuCiAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gPSAwCiAgaWYgKHBvc2l0aW9uID49IG4pIHJldHVybiAtMQoKICByZXR1cm4gYmluZGluZy5xdWlja2JpdF9uYXBpX2ZpbmRfZmlyc3QoCiAgICB0b0J1ZmZlcihmaWVsZCksCiAgICB2YWx1ZSA/IDEgOiAwLAogICAgcG9zaXRpb24KICApCn0KCmV4cG9ydHMuZmluZExhc3QgPSBmdW5jdGlvbiBmaW5kTGFzdCgKICBmaWVsZCwKICB2YWx1ZSwKICBwb3NpdGlvbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4IC0gMQopIHsKICBjb25zdCBuID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gKz0gbgogIGlmIChwb3NpdGlvbiA8IDApIHJldHVybiAtMQogIGlmIChwb3NpdGlvbiA+PSBuKSBwb3NpdGlvbiA9IG4gLSAxCgogIHJldHVybiBiaW5kaW5nLnF1aWNrYml0X25hcGlfZmluZF9sYXN0KAogICAgdG9CdWZmZXIoZmllbGQpLAogICAgdmFsdWUgPyAxIDogMCwKICAgIHBvc2l0aW9uCiAgKQp9CgpmdW5jdGlvbiB0b0J1ZmZlcihmaWVsZCkgewogIGlmIChmaWVsZC5CWVRFU19QRVJfRUxFTUVOVCA9PT0gMSkgcmV0dXJuIGZpZWxkCiAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGZpZWxkLmJ1ZmZlciwgZmllbGQuYnl0ZU9mZnNldCwgZmllbGQuYnl0ZUxlbmd0aCkKfQoKZnVuY3Rpb24gdG9CdWZmZXJDaHVuayhjaHVuaykgewogIHJldHVybiB7IGZpZWxkOiB0b0J1ZmZlcihjaHVuay5maWVsZCksIG9mZnNldDogY2h1bmsub2Zmc2V0IH0KfQoKY2xhc3MgSW5kZXggewogIHN0YXRpYyBmcm9tKGZpZWxkT3JDaHVua3MsIGJ5dGVMZW5ndGggPSAtMSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkoZmllbGRPckNodW5rcykpIHsKICAgICAgcmV0dXJuIG5ldyBTcGFyc2VJbmRleChmaWVsZE9yQ2h1bmtzLCBieXRlTGVuZ3RoKQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5ldyBEZW5zZUluZGV4KGZpZWxkT3JDaHVua3MsIGJ5dGVMZW5ndGgpCiAgICB9CiAgfQoKICBjb25zdHJ1Y3RvcihieXRlTGVuZ3RoKSB7CiAgICB0aGlzLl9ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aAogICAgdGhpcy5oYW5kbGUgPSBCdWZmZXIuYWxsb2NVbnNhZmUoYmluZGluZy5zaXplb2ZfcXVpY2tiaXRfaW5kZXhfdCkKICB9CgogIGdldCBieXRlTGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuX2J5dGVMZW5ndGgKICB9CgogIHNraXBGaXJzdCh2YWx1ZSwgcG9zaXRpb24gPSAwKSB7CiAgICBjb25zdCBuID0gdGhpcy5ieXRlTGVuZ3RoICogOAoKICAgIGlmIChwb3NpdGlvbiA8IDApIHBvc2l0aW9uICs9IG4KICAgIGlmIChwb3NpdGlvbiA8IDApIHBvc2l0aW9uID0gMAogICAgaWYgKHBvc2l0aW9uID49IG4pIHJldHVybiBuIC0gMQoKICAgIHJldHVybiBiaW5kaW5nLnF1aWNrYml0X25hcGlfc2tpcF9maXJzdCgKICAgICAgdGhpcy5oYW5kbGUsCiAgICAgIHRoaXMuYnl0ZUxlbmd0aCwKICAgICAgdmFsdWUgPyAxIDogMCwKICAgICAgcG9zaXRpb24KICAgICkKICB9CgogIHNraXBMYXN0KHZhbHVlLCBwb3NpdGlvbiA9IHRoaXMuYnl0ZUxlbmd0aCAqIDggLSAxKSB7CiAgICBjb25zdCBuID0gdGhpcy5ieXRlTGVuZ3RoICogOAoKICAgIGlmIChwb3NpdGlvbiA8IDApIHBvc2l0aW9uICs9IG4KICAgIGlmIChwb3NpdGlvbiA8IDApIHJldHVybiAwCiAgICBpZiAocG9zaXRpb24gPj0gbikgcG9zaXRpb24gPSBuIC0gMQoKICAgIHJldHVybiBiaW5kaW5nLnF1aWNrYml0X25hcGlfc2tpcF9sYXN0KAogICAgICB0aGlzLmhhbmRsZSwKICAgICAgdGhpcy5ieXRlTGVuZ3RoLAogICAgICB2YWx1ZSA/IDEgOiAwLAogICAgICBwb3NpdGlvbgogICAgKQogIH0KfQoKZXhwb3J0cy5JbmRleCA9IEluZGV4CgpjbGFzcyBEZW5zZUluZGV4IGV4dGVuZHMgSW5kZXggewogIGNvbnN0cnVjdG9yKGZpZWxkLCBieXRlTGVuZ3RoKSB7CiAgICBzdXBlcihieXRlTGVuZ3RoKQogICAgdGhpcy5maWVsZCA9IGZpZWxkCgogICAgYmluZGluZy5xdWlja2JpdF9uYXBpX2luZGV4X2luaXQodGhpcy5oYW5kbGUsIHRvQnVmZmVyKHRoaXMuZmllbGQpKQogIH0KCiAgZ2V0IGJ5dGVMZW5ndGgoKSB7CiAgICBpZiAodGhpcy5fYnl0ZUxlbmd0aCAhPT0gLTEpIHJldHVybiB0aGlzLl9ieXRlTGVuZ3RoCiAgICByZXR1cm4gdGhpcy5maWVsZC5ieXRlTGVuZ3RoCiAgfQoKICB1cGRhdGUoYml0KSB7CiAgICBjb25zdCBuID0gdGhpcy5ieXRlTGVuZ3RoICogOAoKICAgIGlmIChiaXQgPCAwKSBiaXQgKz0gbgogICAgaWYgKGJpdCA8IDAgfHwgYml0ID49IG4pIHJldHVybiBmYWxzZQoKICAgIHJldHVybiAoCiAgICAgIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9pbmRleF91cGRhdGUoCiAgICAgICAgdGhpcy5oYW5kbGUsCiAgICAgICAgdG9CdWZmZXIodGhpcy5maWVsZCksCiAgICAgICAgYml0CiAgICAgICkgIT09IDAKICAgICkKICB9Cn0KCmZ1bmN0aW9uIHNlbGVjdENodW5rKGNodW5rcywgb2Zmc2V0KSB7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaHVua3MubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IG5leHQgPSBjaHVua3NbaV0KCiAgICBjb25zdCBzdGFydCA9IG5leHQub2Zmc2V0CiAgICBjb25zdCBlbmQgPSBuZXh0Lm9mZnNldCArIG5leHQuZmllbGQuYnl0ZUxlbmd0aAoKICAgIGlmIChvZmZzZXQgPj0gc3RhcnQgJiYgb2Zmc2V0ICsgMTYgPD0gZW5kKSB7CiAgICAgIHJldHVybiBuZXh0CiAgICB9CiAgfQoKICByZXR1cm4gbnVsbAp9CgpjbGFzcyBTcGFyc2VJbmRleCBleHRlbmRzIEluZGV4IHsKICBjb25zdHJ1Y3RvcihjaHVua3MsIGJ5dGVMZW5ndGgpIHsKICAgIHN1cGVyKGJ5dGVMZW5ndGgpCiAgICB0aGlzLmNodW5rcyA9IGNodW5rcwoKICAgIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9pbmRleF9pbml0X3NwYXJzZSgKICAgICAgdGhpcy5oYW5kbGUsCiAgICAgIHRoaXMuY2h1bmtzLm1hcCh0b0J1ZmZlckNodW5rKQogICAgKQogIH0KCiAgZ2V0IGJ5dGVMZW5ndGgoKSB7CiAgICBpZiAodGhpcy5fYnl0ZUxlbmd0aCAhPT0gLTEpIHJldHVybiB0aGlzLl9ieXRlTGVuZ3RoCiAgICBjb25zdCBsYXN0ID0gdGhpcy5jaHVua3NbdGhpcy5jaHVua3MubGVuZ3RoIC0gMV0KICAgIHJldHVybiBsYXN0ID8gbGFzdC5vZmZzZXQgKyBsYXN0LmZpZWxkLmJ5dGVMZW5ndGggOiAwCiAgfQoKICB1cGRhdGUoYml0KSB7CiAgICBjb25zdCBuID0gdGhpcy5ieXRlTGVuZ3RoICogOAoKICAgIGlmIChiaXQgPCAwKSBiaXQgKz0gbgogICAgaWYgKGJpdCA8IDAgfHwgYml0ID49IG4pIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGogPSBNYXRoLmZsb29yKGJpdCAvIDEyOCkKCiAgICBjb25zdCBvZmZzZXQgPSBqICogMTYKCiAgICBjb25zdCBjaHVuayA9IHNlbGVjdENodW5rKHRoaXMuY2h1bmtzLCBvZmZzZXQpCgogICAgaWYgKGNodW5rID09PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgICByZXR1cm4gKAogICAgICBiaW5kaW5nLnF1aWNrYml0X25hcGlfaW5kZXhfdXBkYXRlX3NwYXJzZSgKICAgICAgICB0aGlzLmhhbmRsZSwKICAgICAgICB0b0J1ZmZlcihjaHVuay5maWVsZCksCiAgICAgICAgY2h1bmsub2Zmc2V0LAogICAgICAgIGJpdAogICAgICApICE9PSAwCiAgICApCiAgfQp9CnsKICAibmFtZSI6ICJxdWlja2JpdC1uYXRpdmUiLAogICJ2ZXJzaW9uIjogIjIuNC44IiwKICAiZGVzY3JpcHRpb24iOiAibGlicXVpY2tiaXQgSmF2YVNjcmlwdCBiaW5kaW5ncyBmb3IgTm9kZS5qcyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibWFjcm9zLmgiLAogICAgImJpbmRpbmcuY2MiLAogICAgImJpbmRpbmcuanMiLAogICAgIkNNYWtlTGlzdHMudHh0IiwKICAgICJwcmVidWlsZHMiCiAgXSwKICAiYWRkb24iOiB0cnVlLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAibnBtIHJ1biBsaW50ICYmIG5wbSBydW4gdGVzdDpiYXJlICYmIG5wbSBydW4gdGVzdDpub2RlIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0Lm1qcyIsCiAgICAidGVzdDpub2RlIjogIm5vZGUgdGVzdC5tanMiLAogICAgImxpbnQiOiAicHJldHRpZXIgLiAtLWNoZWNrIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3F1aWNrYml0LW5hdGl2ZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9xdWlja2JpdC1uYXRpdmUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9xdWlja2JpdC1uYXRpdmUjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgInJlcXVpcmUtYWRkb24iOiAiXjEuMS4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi43IiwKICAgICJiYXJlLWNvbXBhdC1uYXBpIjogIl4xLjMuMiIsCiAgICAiYnJpdHRsZSI6ICJeMy4xLjAiLAogICAgImNtYWtlLWJhcmUiOiAiXjEuMS43IiwKICAgICJjbWFrZS1mZXRjaCI6ICJeMS4xLjAiLAogICAgImNtYWtlLW5hcGkiOiAiXjEuMC4yIiwKICAgICJwcmV0dGllciI6ICJeMy41LjMiLAogICAgInByZXR0aWVyLWNvbmZpZy1zdGFuZGFyZCI6ICJeNy4wLjAiCiAgfQp9CmNvbnN0IHNpbWRsZSA9IHJlcXVpcmUoJ3NpbWRsZS11bml2ZXJzYWwnKQoKY29uc3QgSU5ERVhfTEVOID0gKDE2IC8qIHJvb3QgKi8gKyAxMjggKiAxNiAvKiBjaGlsZHJlbiAqLykgKiAyCgpjb25zdCBnZXQgPSBleHBvcnRzLmdldCA9IGZ1bmN0aW9uIGdldCAoZmllbGQsIGJpdCkgewogIGNvbnN0IG4gPSBmaWVsZC5ieXRlTGVuZ3RoICogOAoKICBpZiAoYml0IDwgMCkgYml0ICs9IG4KICBpZiAoYml0IDwgMCB8fCBiaXQgPj0gbikgcmV0dXJuIGZhbHNlCgogIGNvbnN0IG0gPSBmaWVsZC5CWVRFU19QRVJfRUxFTUVOVCAqIDgKCiAgY29uc3Qgb2Zmc2V0ID0gYml0ICYgKG0gLSAxKQogIGNvbnN0IGkgPSAoYml0IC0gb2Zmc2V0KSAvIG0KCiAgcmV0dXJuIChmaWVsZFtpXSAmICgxIDw8IG9mZnNldCkpICE9PSAwCn0KCmNvbnN0IHNldCA9IGV4cG9ydHMuc2V0ID0gZnVuY3Rpb24gc2V0IChmaWVsZCwgYml0LCB2YWx1ZSA9IHRydWUpIHsKICBjb25zdCBuID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgaWYgKGJpdCA8IDApIGJpdCArPSBuCiAgaWYgKGJpdCA8IDAgfHwgYml0ID49IG4pIHJldHVybiBmYWxzZQoKICBjb25zdCBtID0gZmllbGQuQllURVNfUEVSX0VMRU1FTlQgKiA4CgogIGNvbnN0IG9mZnNldCA9IGJpdCAmIChtIC0gMSkKICBjb25zdCBpID0gKGJpdCAtIG9mZnNldCkgLyBtCiAgY29uc3QgbWFzayA9IDEgPDwgb2Zmc2V0CgogIGlmICh2YWx1ZSkgewogICAgaWYgKChmaWVsZFtpXSAmIG1hc2spICE9PSAwKSByZXR1cm4gZmFsc2UKICB9IGVsc2UgewogICAgaWYgKChmaWVsZFtpXSAmIG1hc2spID09PSAwKSByZXR1cm4gZmFsc2UKICB9CgogIGZpZWxkW2ldIF49IG1hc2sKCiAgcmV0dXJuIHRydWUKfQoKZXhwb3J0cy5maWxsID0gZnVuY3Rpb24gZmlsbCAoZmllbGQsIHZhbHVlLCBzdGFydCA9IDAsIGVuZCA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4KSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogIGlmIChzdGFydCA8IDApIHN0YXJ0ICs9IG4KICBpZiAoZW5kIDwgMCkgZW5kICs9IG4KICBpZiAoc3RhcnQgPCAwIHx8IHN0YXJ0ID49IGZpZWxkLmJ5dGVMZW5ndGggKiA4IHx8IHN0YXJ0ID49IGVuZCkgcmV0dXJuIGZpZWxkCgogIGNvbnN0IG0gPSBmaWVsZC5CWVRFU19QRVJfRUxFTUVOVCAqIDgKCiAgbGV0IGksIGoKCiAgewogICAgY29uc3Qgb2Zmc2V0ID0gc3RhcnQgJiAobSAtIDEpCiAgICBpID0gKHN0YXJ0IC0gb2Zmc2V0KSAvIG0KCiAgICBpZiAob2Zmc2V0ICE9PSAwKSB7CiAgICAgIGxldCBzaGlmdCA9IG0gLSBvZmZzZXQKICAgICAgaWYgKGVuZCAtIHN0YXJ0IDwgc2hpZnQpIHNoaWZ0ID0gZW5kIC0gc3RhcnQKCiAgICAgIGNvbnN0IG1hc2sgPSAoKDEgPDwgc2hpZnQpIC0gMSkgPDwgb2Zmc2V0CgogICAgICBpZiAodmFsdWUpIGZpZWxkW2ldIHw9IG1hc2sKICAgICAgZWxzZSBmaWVsZFtpXSAmPSB+bWFzawoKICAgICAgaSsrCiAgICB9CiAgfQoKICB7CiAgICBjb25zdCBvZmZzZXQgPSBlbmQgJiAobSAtIDEpCiAgICBqID0gKGVuZCAtIG9mZnNldCkgLyBtCgogICAgaWYgKG9mZnNldCAhPT0gMCAmJiBqID49IGkpIHsKICAgICAgY29uc3QgbWFzayA9ICgxIDw8IG9mZnNldCkgLSAxCgogICAgICBpZiAodmFsdWUpIGZpZWxkW2pdIHw9IG1hc2sKICAgICAgZWxzZSBmaWVsZFtqXSAmPSB+bWFzawogICAgfQogIH0KCiAgaWYgKGkgPCBqKSBmaWVsZC5maWxsKHZhbHVlID8gKDIgKiogbSkgLSAxIDogMCwgaSwgaikKCiAgcmV0dXJuIGZpZWxkCn0KCmV4cG9ydHMuY2xlYXIgPSBmdW5jdGlvbiBjbGVhciAoZmllbGQsIC4uLmNodW5rcykgewogIGNvbnN0IG4gPSBmaWVsZC5ieXRlTGVuZ3RoCgogIGZvciAoY29uc3QgY2h1bmsgb2YgY2h1bmtzKSB7CiAgICBpZiAoY2h1bmsub2Zmc2V0ID49IG4pIGNvbnRpbnVlCgogICAgY29uc3QgbSA9IGNodW5rLmZpZWxkLmJ5dGVMZW5ndGgKCiAgICBsZXQgaSA9IGNodW5rLm9mZnNldAogICAgbGV0IGogPSAwCgogICAgd2hpbGUgKCgoaSAmIDE1KSAhPT0gMCB8fCAoaiAmIDE1KSAhPT0gMCkgJiYgaSA8IG4gJiYgaiA8IG0pIHsKICAgICAgZmllbGRbaV0gPSBmaWVsZFtpXSAmIH5jaHVuay5maWVsZFtqXQogICAgICBpKysKICAgICAgaisrCiAgICB9CgogICAgaWYgKGkgKyAxNSA8IG4gJiYgaiArIDE1IDwgbSkgewogICAgICBjb25zdCBsZW4gPSBNYXRoLm1pbihuIC0gKG4gJiAxNSkgLSBpLCBtIC0gKG0gJiAxNSkgLSBqKQoKICAgICAgc2ltZGxlLmNsZWFyKGZpZWxkLnN1YmFycmF5KGksIGkgKyBsZW4pLCBjaHVuay5maWVsZC5zdWJhcnJheShqLCBqICsgbGVuKSwgZmllbGQuc3ViYXJyYXkoaSwgaSArIGxlbikpCiAgICB9CgogICAgd2hpbGUgKGkgPCBuICYmIGogPCBtKSB7CiAgICAgIGZpZWxkW2ldID0gZmllbGRbaV0gJiB+Y2h1bmsuZmllbGRbal0KICAgICAgaSsrCiAgICAgIGorKwogICAgfQogIH0KfQoKZnVuY3Rpb24gYml0T2Zmc2V0IChiaXQsIG9mZnNldCkgewogIHJldHVybiAhYml0ID8gb2Zmc2V0IDogKElOREVYX0xFTiAqIDggLyAyKSArIG9mZnNldAp9CgpmdW5jdGlvbiBieXRlT2Zmc2V0IChiaXQsIG9mZnNldCkgewogIHJldHVybiAhYml0ID8gb2Zmc2V0IDogKElOREVYX0xFTiAvIDIpICsgb2Zmc2V0Cn0KCmV4cG9ydHMuZmluZEZpcnN0ID0gZnVuY3Rpb24gZmluZEZpcnN0IChmaWVsZCwgdmFsdWUsIHBvc2l0aW9uID0gMCkgewogIGNvbnN0IG4gPSBmaWVsZC5ieXRlTGVuZ3RoICogOAoKICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiArPSBuCiAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gPSAwCiAgaWYgKHBvc2l0aW9uID49IG4pIHJldHVybiAtMQoKICB2YWx1ZSA9ICEhdmFsdWUKCiAgZm9yIChsZXQgaSA9IHBvc2l0aW9uOyBpIDwgbjsgaSsrKSB7CiAgICBpZiAoZ2V0KGZpZWxkLCBpKSA9PT0gdmFsdWUpIHJldHVybiBpCiAgfQoKICByZXR1cm4gLTEKfQoKZXhwb3J0cy5maW5kTGFzdCA9IGZ1bmN0aW9uIGZpbmRMYXN0IChmaWVsZCwgdmFsdWUsIHBvc2l0aW9uID0gZmllbGQuYnl0ZUxlbmd0aCAqIDggLSAxKSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogIGlmIChwb3NpdGlvbiA8IDApIHBvc2l0aW9uICs9IG4KICBpZiAocG9zaXRpb24gPCAwKSByZXR1cm4gLTEKICBpZiAocG9zaXRpb24gPj0gbikgcG9zaXRpb24gPSBuIC0gMQoKICB2YWx1ZSA9ICEhdmFsdWUKCiAgZm9yIChsZXQgaSA9IHBvc2l0aW9uOyBpID49IDA7IGktLSkgewogICAgaWYgKGdldChmaWVsZCwgaSkgPT09IHZhbHVlKSByZXR1cm4gaQogIH0KCiAgcmV0dXJuIC0xCn0KCmNvbnN0IEluZGV4ID0gZXhwb3J0cy5JbmRleCA9IGNsYXNzIEluZGV4IHsKICBzdGF0aWMgZnJvbSAoZmllbGRPckNodW5rcywgYnl0ZUxlbmd0aCA9IC0xKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShmaWVsZE9yQ2h1bmtzKSkgewogICAgICByZXR1cm4gbmV3IFNwYXJzZUluZGV4KGZpZWxkT3JDaHVua3MsIGJ5dGVMZW5ndGgpCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmV3IERlbnNlSW5kZXgoZmllbGRPckNodW5rcywgYnl0ZUxlbmd0aCkKICAgIH0KICB9CgogIGNvbnN0cnVjdG9yIChieXRlTGVuZ3RoKSB7CiAgICB0aGlzLl9ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aAogICAgdGhpcy5oYW5kbGUgPSBuZXcgVWludDMyQXJyYXkoSU5ERVhfTEVOIC8gNCkKICB9CgogIGdldCBieXRlTGVuZ3RoICgpIHsKICAgIHJldHVybiB0aGlzLl9ieXRlTGVuZ3RoCiAgfQoKICBza2lwRmlyc3QgKHZhbHVlLCBwb3NpdGlvbiA9IDApIHsKICAgIGNvbnN0IG4gPSB0aGlzLmJ5dGVMZW5ndGggKiA4CgogICAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gKz0gbgogICAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gPSAwCiAgICBpZiAocG9zaXRpb24gPj0gbikgcmV0dXJuIG4gLSAxCgogICAgbGV0IGkgPSBNYXRoLmZsb29yKHBvc2l0aW9uIC8gMTYzODQpCgogICAgaWYgKGkgPiAxMjcpIHJldHVybiBwb3NpdGlvbgoKICAgIHdoaWxlIChpIDw9IDEyNyAmJiBnZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh2YWx1ZSwgaSkpKSB7CiAgICAgIGkrKwogICAgfQoKICAgIGlmIChpID09PSAxMjgpIHJldHVybiBuIC0gMQoKICAgIGxldCBrID0gaSAqIDE2Mzg0CiAgICBsZXQgaiA9IDAKCiAgICBpZiAocG9zaXRpb24gPiBrKSBqID0gTWF0aC5mbG9vcigocG9zaXRpb24gLSBrKSAvIDEyOCkKCiAgICB3aGlsZSAoaiA8PSAxMjcgJiYgZ2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodmFsdWUsIGkgKiAxMjggKyBqICsgMTI4KSkpIHsKICAgICAgaisrCiAgICAgIGsgKz0gMTI4CiAgICB9CgogICAgaWYgKGogPT09IDEyOCAmJiBpICE9PSAxMjcpIHJldHVybiB0aGlzLnNraXBGaXJzdCh2YWx1ZSwgKGkgKyAxKSAqIDE2Mzg0KQoKICAgIGlmIChrID4gcG9zaXRpb24pIHBvc2l0aW9uID0gawoKICAgIHJldHVybiBwb3NpdGlvbiA8IG4gPyBwb3NpdGlvbiA6IG4gLSAxCiAgfQoKICBza2lwTGFzdCAodmFsdWUsIHBvc2l0aW9uID0gdGhpcy5ieXRlTGVuZ3RoICogOCAtIDEpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmJ5dGVMZW5ndGggKiA4CgogICAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gKz0gbgogICAgaWYgKHBvc2l0aW9uIDwgMCkgcmV0dXJuIDAKICAgIGlmIChwb3NpdGlvbiA+PSBuKSBwb3NpdGlvbiA9IG4gLSAxCgogICAgbGV0IGkgPSBNYXRoLmZsb29yKHBvc2l0aW9uIC8gMTYzODQpCgogICAgaWYgKGkgPiAxMjcpIHJldHVybiBwb3NpdGlvbgoKICAgIHdoaWxlIChpID49IDAgJiYgZ2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodmFsdWUsIGkpKSkgewogICAgICBpLS0KICAgIH0KCiAgICBpZiAoaSA9PT0gLTEpIHJldHVybiAwCgogICAgbGV0IGsgPSAoKGkgKyAxKSAqIDE2Mzg0KSAtIDEKICAgIGxldCBqID0gMTI3CgogICAgaWYgKHBvc2l0aW9uIDwgaykgaiA9IDEyOCAtIE1hdGguY2VpbCgoayAtIHBvc2l0aW9uKSAvIDEyOCkKCiAgICB3aGlsZSAoaiA+PSAwICYmIGdldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHZhbHVlLCBpICogMTI4ICsgaiArIDEyOCkpKSB7CiAgICAgIGotLQogICAgICBrIC09IDEyOAogICAgfQoKICAgIGlmIChqID09PSAtMSAmJiBpICE9PSAwKSByZXR1cm4gdGhpcy5za2lwTGFzdCh2YWx1ZSwgaSAqIDE2Mzg0IC0gMSkKCiAgICBpZiAoayA8IHBvc2l0aW9uKSBwb3NpdGlvbiA9IGsKCiAgICByZXR1cm4gcG9zaXRpb24KICB9Cn0KCmNsYXNzIERlbnNlSW5kZXggZXh0ZW5kcyBJbmRleCB7CiAgY29uc3RydWN0b3IgKGZpZWxkLCBieXRlTGVuZ3RoKSB7CiAgICBzdXBlcihieXRlTGVuZ3RoKQogICAgdGhpcy5maWVsZCA9IGZpZWxkCgogICAgY29uc3QgbSA9IGZpZWxkLkJZVEVTX1BFUl9FTEVNRU5UCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMjg7IGkrKykgewogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDEyODsgaisrKSB7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gKGkgKiAxMjggKyBqKSAqIDE2CiAgICAgICAgbGV0IGFsbHogPSB0cnVlCiAgICAgICAgbGV0IGFsbG8gPSBmYWxzZQoKICAgICAgICBpZiAob2Zmc2V0ICsgMTYgPD0gdGhpcy5maWVsZC5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICBjb25zdCB2ZWMgPSB0aGlzLmZpZWxkLnN1YmFycmF5KG9mZnNldCAvIG0sIChvZmZzZXQgKyAxNikgLyBtKQoKICAgICAgICAgIGFsbHogPSBzaW1kbGUuYWxseih2ZWMpCiAgICAgICAgICBhbGxvID0gc2ltZGxlLmFsbG8odmVjKQogICAgICAgIH0KCiAgICAgICAgY29uc3QgayA9IGkgKiAxMjggKyAxMjggKyBqCgogICAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KGZhbHNlLCBrKSwgYWxseikKICAgICAgICBzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh0cnVlLCBrKSwgYWxsbykKICAgICAgfQoKICAgICAgewogICAgICAgIGNvbnN0IG9mZnNldCA9IGJ5dGVPZmZzZXQoZmFsc2UsIGkgKiAxNiArIDE2KSAvIDQKICAgICAgICBjb25zdCBhbGxvID0gc2ltZGxlLmFsbG8odGhpcy5oYW5kbGUuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyA0KSkKCiAgICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQoZmFsc2UsIGkpLCBhbGxvKQogICAgICB9CgogICAgICB7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYnl0ZU9mZnNldCh0cnVlLCBpICogMTYgKyAxNikgLyA0CiAgICAgICAgY29uc3QgYWxsbyA9IHNpbWRsZS5hbGxvKHRoaXMuaGFuZGxlLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgNCkpCgogICAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHRydWUsIGkpLCBhbGxvKQogICAgICB9CiAgICB9CiAgfQoKICBnZXQgYnl0ZUxlbmd0aCAoKSB7CiAgICBpZiAodGhpcy5fYnl0ZUxlbmd0aCAhPT0gLTEpIHJldHVybiB0aGlzLl9ieXRlTGVuZ3RoCiAgICByZXR1cm4gdGhpcy5maWVsZC5ieXRlTGVuZ3RoCiAgfQoKICB1cGRhdGUgKGJpdCkgewogICAgY29uc3QgbiA9IHRoaXMuYnl0ZUxlbmd0aCAqIDgKCiAgICBpZiAoYml0IDwgMCkgYml0ICs9IG4KICAgIGlmIChiaXQgPCAwIHx8IGJpdCA+PSBuKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBtID0gdGhpcy5maWVsZC5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGNvbnN0IGkgPSBNYXRoLmZsb29yKGJpdCAvIDE2Mzg0KQogICAgY29uc3QgaiA9IE1hdGguZmxvb3IoYml0IC8gMTI4KQoKICAgIGNvbnN0IG9mZnNldCA9IChqICogMTYpIC8gbQogICAgY29uc3QgdmVjID0gdGhpcy5maWVsZC5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArICgxNiAvIG0pKQoKICAgIGNvbnN0IGFsbHogPSBzaW1kbGUuYWxseih2ZWMpCiAgICBjb25zdCBhbGxvID0gc2ltZGxlLmFsbG8odmVjKQoKICAgIGxldCBjaGFuZ2VkID0gZmFsc2UKCiAgICBpZiAoc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQoZmFsc2UsIDEyOCArIGopLCBhbGx6KSkgewogICAgICBjaGFuZ2VkID0gdHJ1ZQoKICAgICAgY29uc3Qgb2Zmc2V0ID0gYnl0ZU9mZnNldChmYWxzZSwgaSAqIDE2ICsgMTYpIC8gNAogICAgICBjb25zdCBhbGxvID0gc2ltZGxlLmFsbG8odGhpcy5oYW5kbGUuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyA0KSkKCiAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KGZhbHNlLCBpKSwgYWxsbykKICAgIH0KCiAgICBpZiAoc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodHJ1ZSwgMTI4ICsgaiksIGFsbG8pKSB7CiAgICAgIGNoYW5nZWQgPSB0cnVlCgogICAgICBjb25zdCBvZmZzZXQgPSBieXRlT2Zmc2V0KHRydWUsIGkgKiAxNiArIDE2KSAvIDQKICAgICAgY29uc3QgYWxsbyA9IHNpbWRsZS5hbGxvKHRoaXMuaGFuZGxlLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgNCkpCgogICAgICBzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh0cnVlLCBpKSwgYWxsbykKICAgIH0KCiAgICByZXR1cm4gY2hhbmdlZAogIH0KfQoKZnVuY3Rpb24gc2VsZWN0Q2h1bmsgKGNodW5rcywgb2Zmc2V0KSB7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaHVua3MubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IG5leHQgPSBjaHVua3NbaV0KCiAgICBjb25zdCBzdGFydCA9IG5leHQub2Zmc2V0CiAgICBjb25zdCBlbmQgPSBuZXh0Lm9mZnNldCArIG5leHQuZmllbGQuYnl0ZUxlbmd0aAoKICAgIGlmIChvZmZzZXQgPj0gc3RhcnQgJiYgb2Zmc2V0ICsgMTYgPD0gZW5kKSB7CiAgICAgIHJldHVybiBuZXh0CiAgICB9CiAgfQoKICByZXR1cm4gbnVsbAp9CgpjbGFzcyBTcGFyc2VJbmRleCBleHRlbmRzIEluZGV4IHsKICBjb25zdHJ1Y3RvciAoY2h1bmtzLCBieXRlTGVuZ3RoKSB7CiAgICBzdXBlcihieXRlTGVuZ3RoKQogICAgdGhpcy5jaHVua3MgPSBjaHVua3MKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEyODsgaSsrKSB7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMTI4OyBqKyspIHsKICAgICAgICBjb25zdCBvZmZzZXQgPSAoaSAqIDEyOCArIGopICogMTYKICAgICAgICBsZXQgYWxseiA9IHRydWUKICAgICAgICBsZXQgYWxsbyA9IGZhbHNlCgogICAgICAgIGNvbnN0IGNodW5rID0gc2VsZWN0Q2h1bmsodGhpcy5jaHVua3MsIG9mZnNldCkKCiAgICAgICAgaWYgKGNodW5rICE9PSBudWxsKSB7CiAgICAgICAgICBjb25zdCBtID0gY2h1bmsuZmllbGQuQllURVNfUEVSX0VMRU1FTlQKCiAgICAgICAgICBjb25zdCB2ZWMgPSBjaHVuay5maWVsZC5zdWJhcnJheSgob2Zmc2V0IC0gY2h1bmsub2Zmc2V0KSAvIG0sIChvZmZzZXQgLSBjaHVuay5vZmZzZXQgKyAxNikgLyBtKQoKICAgICAgICAgIGFsbHogPSBzaW1kbGUuYWxseih2ZWMpCiAgICAgICAgICBhbGxvID0gc2ltZGxlLmFsbG8odmVjKQogICAgICAgIH0KCiAgICAgICAgY29uc3QgayA9IGkgKiAxMjggKyAxMjggKyBqCgogICAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KGZhbHNlLCBrKSwgYWxseikKICAgICAgICBzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh0cnVlLCBrKSwgYWxsbykKICAgICAgfQoKICAgICAgewogICAgICAgIGNvbnN0IG9mZnNldCA9IGJ5dGVPZmZzZXQoZmFsc2UsIGkgKiAxNiArIDE2KSAvIDQKICAgICAgICBjb25zdCBhbGxvID0gc2ltZGxlLmFsbG8odGhpcy5oYW5kbGUuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyA0KSkKCiAgICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQoZmFsc2UsIGkpLCBhbGxvKQogICAgICB9CgogICAgICB7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYnl0ZU9mZnNldCh0cnVlLCBpICogMTYgKyAxNikgLyA0CiAgICAgICAgY29uc3QgYWxsbyA9IHNpbWRsZS5hbGxvKHRoaXMuaGFuZGxlLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgNCkpCgogICAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHRydWUsIGkpLCBhbGxvKQogICAgICB9CiAgICB9CiAgfQoKICBnZXQgYnl0ZUxlbmd0aCAoKSB7CiAgICBpZiAodGhpcy5fYnl0ZUxlbmd0aCAhPT0gLTEpIHJldHVybiB0aGlzLl9ieXRlTGVuZ3RoCiAgICBjb25zdCBsYXN0ID0gdGhpcy5jaHVua3NbdGhpcy5jaHVua3MubGVuZ3RoIC0gMV0KICAgIHJldHVybiBsYXN0ID8gbGFzdC5vZmZzZXQgKyBsYXN0LmZpZWxkLmJ5dGVMZW5ndGggOiAwCiAgfQoKICB1cGRhdGUgKGJpdCkgewogICAgY29uc3QgbiA9IHRoaXMuYnl0ZUxlbmd0aCAqIDgKCiAgICBpZiAoYml0IDwgMCkgYml0ICs9IG4KICAgIGlmIChiaXQgPCAwIHx8IGJpdCA+PSBuKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBpID0gTWF0aC5mbG9vcihiaXQgLyAxNjM4NCkKICAgIGNvbnN0IGogPSBNYXRoLmZsb29yKGJpdCAvIDEyOCkKCiAgICBjb25zdCBvZmZzZXQgPSBqICogMTYKCiAgICBjb25zdCBjaHVuayA9IHNlbGVjdENodW5rKHRoaXMuY2h1bmtzLCBvZmZzZXQpCgogICAgaWYgKGNodW5rID09PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBtID0gY2h1bmsuZmllbGQuQllURVNfUEVSX0VMRU1FTlQKCiAgICBjb25zdCB2ZWMgPSBjaHVuay5maWVsZC5zdWJhcnJheSgob2Zmc2V0IC0gY2h1bmsub2Zmc2V0KSAvIG0sIChvZmZzZXQgLSBjaHVuay5vZmZzZXQgKyAxNikgLyBtKQoKICAgIGNvbnN0IGFsbHogPSBzaW1kbGUuYWxseih2ZWMpCiAgICBjb25zdCBhbGxvID0gc2ltZGxlLmFsbG8odmVjKQoKICAgIGxldCBjaGFuZ2VkID0gZmFsc2UKCiAgICBpZiAoc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQoZmFsc2UsIDEyOCArIGopLCBhbGx6KSkgewogICAgICBjaGFuZ2VkID0gdHJ1ZQoKICAgICAgY29uc3Qgb2Zmc2V0ID0gYnl0ZU9mZnNldChmYWxzZSwgaSAqIDE2ICsgMTYpIC8gNAogICAgICBjb25zdCBhbGxvID0gc2ltZGxlLmFsbG8odGhpcy5oYW5kbGUuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyA0KSkKCiAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KGZhbHNlLCBpKSwgYWxsbykKICAgIH0KCiAgICBpZiAoc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodHJ1ZSwgMTI4ICsgaiksIGFsbG8pKSB7CiAgICAgIGNoYW5nZWQgPSB0cnVlCgogICAgICBjb25zdCBvZmZzZXQgPSBieXRlT2Zmc2V0KHRydWUsIGkgKiAxNiArIDE2KSAvIDQKICAgICAgY29uc3QgYWxsbyA9IHNpbWRsZS5hbGxvKHRoaXMuaGFuZGxlLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgNCkpCgogICAgICBzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh0cnVlLCBpKSwgYWxsbykKICAgIH0KCiAgICByZXR1cm4gY2hhbmdlZAogIH0KfQpjb25zdCBmYWxsYmFjayA9IHJlcXVpcmUoJy4vZmFsbGJhY2snKQoKdHJ5IHsKICBjb25zdCBuYXRpdmUgPSByZXF1aXJlKCdxdWlja2JpdC1uYXRpdmUnKQoKICAvLyBUaGVzZSBmdW5jdGlvbnMgYXJlIGZhc3RlciBpbiBKYXZhU2NyaXB0CiAgZXhwb3J0cy5nZXQgPSBmYWxsYmFjay5nZXQKICBleHBvcnRzLnNldCA9IGZhbGxiYWNrLnNldAogIGV4cG9ydHMuZmlsbCA9IGZhbGxiYWNrLmZpbGwKCiAgLy8gVGhlc2UgZnVuY3Rpb25zIGFyZSBmYXN0ZXIgaW4gQwogIGV4cG9ydHMuY2xlYXIgPSBuYXRpdmUuY2xlYXIKICBleHBvcnRzLmZpbmRGaXJzdCA9IG5hdGl2ZS5maW5kRmlyc3QKICBleHBvcnRzLmZpbmRMYXN0ID0gbmF0aXZlLmZpbmRMYXN0CiAgZXhwb3J0cy5JbmRleCA9IG5hdGl2ZS5JbmRleAp9IGNhdGNoIHsKICBtb2R1bGUuZXhwb3J0cyA9IGZhbGxiYWNrCn0KewogICJuYW1lIjogInF1aWNrYml0LXVuaXZlcnNhbCIsCiAgInZlcnNpb24iOiAiMi4yLjAiLAogICJkZXNjcmlwdGlvbiI6ICJVbml2ZXJzYWwgd3JhcHBlciBmb3IgbGlicXVpY2tiaXQgd2l0aCBhIEphdmFTY3JpcHQgZmFsbGJhY2siLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiZmFsbGJhY2suanMiLAogICAgImluZGV4LmpzIgogIF0sCiAgImJyb3dzZXIiOiB7CiAgICAiLi9pbmRleC5qcyI6ICIuL2ZhbGxiYWNrLmpzIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QubWpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3F1aWNrYml0LXVuaXZlcnNhbC5naXQiCiAgfSwKICAiYXV0aG9yIjogIkthc3BlciBJc2FnZXIgRGFsc2dhcsOwIDxrYXNwZXJAZnVua3Rpb25lbC5jbz4iLAogICJsaWNlbnNlIjogIklTQyIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9xdWlja2JpdC11bml2ZXJzYWwvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9xdWlja2JpdC11bml2ZXJzYWwjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjAiLAogICAgInNpbWRsZS11bml2ZXJzYWwiOiAiXjEuMS4wIgogIH0sCiAgIm9wdGlvbmFsRGVwZW5kZW5jaWVzIjogewogICAgInF1aWNrYml0LW5hdGl2ZSI6ICJeMi4yLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMS4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0KfQpjbGFzcyBDYWNoZUVudHJ5IHsKICBjb25zdHJ1Y3RvciAoa2V5LCBpbmRleCwgbWFwKSB7CiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy5pbmRleCA9IGluZGV4CiAgICB0aGlzLm1hcCA9IG1hcAogIH0KfQoKY2xhc3MgQ2FjaGVWYWx1ZSB7CiAgY29uc3RydWN0b3IgKGVudHJ5LCB2YWx1ZSkgewogICAgdGhpcy5lbnRyeSA9IGVudHJ5CiAgICB0aGlzLnZhbHVlID0gdmFsdWUKICB9Cn0KCmNsYXNzIFJhY2hlIHsKICBjb25zdHJ1Y3RvciAoeyBtYXhTaXplID0gNjU1MzYsIHBhcmVudCA9IG51bGwgfSA9IHt9KSB7CiAgICB0aGlzLm1heFNpemUgPSBwYXJlbnQ/Lm1heFNpemUgfHwgbWF4U2l6ZQoKICAgIHRoaXMuX2FycmF5ID0gcGFyZW50Py5fYXJyYXkgfHwgW10KICAgIHRoaXMuX21hcCA9IG5ldyBNYXAoKQogIH0KCiAgc3RhdGljIGZyb20gKGNhY2hlKSB7CiAgICByZXR1cm4gY2FjaGUgPyBuZXcgdGhpcyh7IHBhcmVudDogY2FjaGUgfSkgOiBuZXcgdGhpcygpCiAgfQoKICBnZXQgZ2xvYmFsU2l6ZSAoKSB7CiAgICByZXR1cm4gdGhpcy5fYXJyYXkubGVuZ3RoCiAgfQoKICBnZXQgc2l6ZSAoKSB7CiAgICByZXR1cm4gdGhpcy5fbWFwLnNpemUKICB9CgogIHN1YiAoKSB7CiAgICByZXR1cm4gbmV3IFJhY2hlKHsgcGFyZW50OiB0aGlzIH0pCiAgfQoKICBzZXQgKGtleSwgdmFsdWUpIHsgLy8gfmNvbnN0YW50IHRpbWUKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5fbWFwLmdldChrZXkpCiAgICBpZiAoZXhpc3RpbmcgIT09IHVuZGVmaW5lZCkgewogICAgICBleGlzdGluZy52YWx1ZSA9IHZhbHVlCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLl9hcnJheS5sZW5ndGggPj0gdGhpcy5tYXhTaXplKSB0aGlzLl9nYygpCgogICAgY29uc3QgZW50cnkgPSBuZXcgQ2FjaGVFbnRyeShrZXksIHRoaXMuX2FycmF5Lmxlbmd0aCwgdGhpcy5fbWFwKQogICAgdGhpcy5fYXJyYXkucHVzaChlbnRyeSkKICAgIGNvbnN0IGNhY2hlVmFsdWUgPSBuZXcgQ2FjaGVWYWx1ZShlbnRyeSwgdmFsdWUpCiAgICB0aGlzLl9tYXAuc2V0KGtleSwgY2FjaGVWYWx1ZSkKICB9CgogIGRlbGV0ZSAoa2V5KSB7CiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuX21hcC5nZXQoa2V5KQogICAgaWYgKGV4aXN0aW5nID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZQoKICAgIHRoaXMuX2RlbGV0ZShleGlzdGluZy5lbnRyeS5pbmRleCkKICAgIHJldHVybiB0cnVlCiAgfQoKICBnZXQgKGtleSkgewogICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLl9tYXAuZ2V0KGtleSkKICAgIHJldHVybiBleGlzdGluZyA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogZXhpc3RpbmcudmFsdWUKICB9CgogICogW1N5bWJvbC5pdGVyYXRvcl0gKCkgewogICAgZm9yIChjb25zdCBba2V5LCB7IHZhbHVlIH1dIG9mIHRoaXMuX21hcCkgewogICAgICB5aWVsZCBba2V5LCB2YWx1ZV0KICAgIH0KICB9CgogIGtleXMgKCkgewogICAgcmV0dXJuIHRoaXMuX21hcC5rZXlzKCkKICB9CgogICogdmFsdWVzICgpIHsKICAgIGZvciAoY29uc3QgeyB2YWx1ZSB9IG9mIHRoaXMuX21hcC52YWx1ZXMoKSkgewogICAgICB5aWVsZCB2YWx1ZQogICAgfQogIH0KCiAgY2xlYXIgKCkgewogICAgLy8gVGhlIGVudHJpZXMgaW4gbWFwIGxpbmdlciBvbiBpbiBfYXJyYXksCiAgICAvLyBzbyBvbiB0b3Agb2YgY2xlYXJpbmcgdGhlIG1hcCwgd2UgYWxzbyBraWxsIHRoZSByZWYsCiAgICAvLyBzbyB0aGF0IGFueSBnYyBydW5uaW5nIGxhdGVyIG9uIHRoZSBvbGQgbWFwIHdvbid0IGludGVyZmVyZQogICAgLy8gKGluIGNhc2UgYSBuZXcgZW50cnkgd2FzIGFkZGVkIHdpdGggdGhlIHNhbWUga2V5IGFzIGEgY2xlYXJlZCBlbnRyeSkKCiAgICB0aGlzLl9tYXAuY2xlYXIoKQogICAgdGhpcy5fbWFwID0gbmV3IE1hcCgpCiAgfQoKICBkZXN0cm95ICgpIHsKICAgIHRoaXMuX21hcCA9IG51bGwKICAgIHRoaXMuX2FycmF5ID0gbnVsbAogIH0KCiAgX2djICgpIHsKICAgIHRoaXMuX2RlbGV0ZShNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB0aGlzLl9hcnJheS5sZW5ndGgpKQogIH0KCiAgX2RlbGV0ZSAoaW5kZXgpIHsgLy8gfmNvbnN0YW50IHRpbWUKICAgIGlmIChpbmRleCA+PSB0aGlzLl9hcnJheS5sZW5ndGgpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGRlbGV0ZSB1bnVzZWQgaW5kZXggKGxvZ2ljIGJ1Zz8pJykKCiAgICBjb25zdCBoZWFkID0gdGhpcy5fYXJyYXkucG9wKCkKICAgIGxldCByZW1vdmVkID0gaGVhZAoKICAgIGlmIChpbmRleCA8IHRoaXMuX2FycmF5Lmxlbmd0aCkgewogICAgICByZW1vdmVkID0gdGhpcy5fYXJyYXlbaW5kZXhdCiAgICAgIGhlYWQuaW5kZXggPSBpbmRleAogICAgICB0aGlzLl9hcnJheVtpbmRleF0gPSBoZWFkCiAgICB9CgogICAgcmVtb3ZlZC5tYXAuZGVsZXRlKHJlbW92ZWQua2V5KQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBSYWNoZQp7CiAgIm5hbWUiOiAicmFjaGUiLAogICJ2ZXJzaW9uIjogIjEuMC4wIiwKICAiZGVzY3JpcHRpb24iOiAiUmFuZG9tLWV2aWN0aW9uIGNhY2hlIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMgLS1jb3ZlcmFnZSIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yYWNoZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yYWNoZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JhY2hlI3JlYWRtZSIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy41LjIiLAogICAgInN0YW5kYXJkIjogIl4xNy4xLjAiCiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUmFuZG9tQXJyYXlJdGVyYXRvciB7CiAgY29uc3RydWN0b3IgKHZhbHVlcykgewogICAgdGhpcy52YWx1ZXMgPSB2YWx1ZXMKICAgIHRoaXMuc3RhcnQgPSAwCiAgICB0aGlzLmxlbmd0aCA9IHRoaXMudmFsdWVzLmxlbmd0aAogIH0KCiAgbmV4dCAoKSB7CiAgICBpZiAodGhpcy5sZW5ndGggPT09IDApIHsKICAgICAgaWYgKHRoaXMuc3RhcnQgPT09IDApIHJldHVybiB7IGRvbmU6IHRydWUsIHZhbHVlOiB1bmRlZmluZWQgfQogICAgICB0aGlzLmxlbmd0aCA9IHRoaXMuc3RhcnQKICAgICAgdGhpcy5zdGFydCA9IDAKICAgIH0KCiAgICBjb25zdCBpID0gdGhpcy5zdGFydCArICgoTWF0aC5yYW5kb20oKSAqIHRoaXMubGVuZ3RoKSB8IDApCiAgICBjb25zdCBqID0gdGhpcy5zdGFydCArIC0tdGhpcy5sZW5ndGgKICAgIGNvbnN0IHZhbHVlID0gdGhpcy52YWx1ZXNbaV0KCiAgICB0aGlzLnZhbHVlc1tpXSA9IHRoaXMudmFsdWVzW2pdCiAgICB0aGlzLnZhbHVlc1tqXSA9IHZhbHVlCgogICAgcmV0dXJuIHsgZG9uZTogZmFsc2UsIHZhbHVlIH0KICB9CgogIGRlcXVldWUgKCkgewogICAgdGhpcy52YWx1ZXNbdGhpcy5zdGFydCArIHRoaXMubGVuZ3RoXSA9IHRoaXMudmFsdWVzW3RoaXMudmFsdWVzLmxlbmd0aCAtIDFdCiAgICB0aGlzLnZhbHVlcy5wb3AoKQogIH0KCiAgcmVxdWV1ZSAoKSB7CiAgICBjb25zdCBpID0gdGhpcy5zdGFydCArIHRoaXMubGVuZ3RoCiAgICBjb25zdCB2YWx1ZSA9IHRoaXMudmFsdWVzW2ldCiAgICB0aGlzLnZhbHVlc1tpXSA9IHRoaXMudmFsdWVzW3RoaXMuc3RhcnRdCiAgICB0aGlzLnZhbHVlc1t0aGlzLnN0YXJ0KytdID0gdmFsdWUKICB9CgogIHJlc3RhcnQgKCkgewogICAgdGhpcy5zdGFydCA9IDAKICAgIHRoaXMubGVuZ3RoID0gdGhpcy52YWx1ZXMubGVuZ3RoCiAgICByZXR1cm4gdGhpcwogIH0KCiAgW1N5bWJvbC5pdGVyYXRvcl0gKCkgewogICAgcmV0dXJuIHRoaXMKICB9Cn0KewogICJuYW1lIjogInJhbmRvbS1hcnJheS1pdGVyYXRvciIsCiAgInZlcnNpb24iOiAiMS4wLjAiLAogICJkZXNjcmlwdGlvbiI6ICJBbiBpdGVyYXRvciB0byBpdGVyYXRlIGFuIGFycmF5IGluIHJhbmRvbSBvcmRlciB3aXRoIGNvbnRyb2xzIHRvIHJlcXVldWUgb3IgZGVxdWV1ZSBlbGVtZW50cyBkdXJpbmcgdGhlIGl0ZXJhdGlvbiIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xNi4wLjMiLAogICAgInRhcGUiOiAiXjUuMC4xIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiB0YXBlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcmFuZG9tLWFycmF5LWl0ZXJhdG9yLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9yYW5kb20tYXJyYXktaXRlcmF0b3IvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcmFuZG9tLWFycmF5LWl0ZXJhdG9yIgp9CmNvbnN0IEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJlYWR5UmVzb3VyY2UgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yICgpIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLm9wZW5pbmcgPSBudWxsCiAgICB0aGlzLmNsb3NpbmcgPSBudWxsCgogICAgdGhpcy5vcGVuZWQgPSBmYWxzZQogICAgdGhpcy5jbG9zZWQgPSBmYWxzZQogIH0KCiAgcmVhZHkgKCkgewogICAgaWYgKHRoaXMub3BlbmluZyAhPT0gbnVsbCkgcmV0dXJuIHRoaXMub3BlbmluZwogICAgdGhpcy5vcGVuaW5nID0gb3Blbih0aGlzKQogICAgcmV0dXJuIHRoaXMub3BlbmluZwogIH0KCiAgY2xvc2UgKCkgewogICAgaWYgKHRoaXMuY2xvc2luZyAhPT0gbnVsbCkgcmV0dXJuIHRoaXMuY2xvc2luZwogICAgdGhpcy5jbG9zaW5nID0gY2xvc2UodGhpcykKICAgIHJldHVybiB0aGlzLmNsb3NpbmcKICB9CgogIGFzeW5jIF9vcGVuICgpIHsKICAgIC8vIGFkZCBpbXBsIGhlcmUKICB9CgogIGFzeW5jIF9jbG9zZSAoKSB7CiAgICAvLyBhZGQgaW1wbCBoZXJlCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBvcGVuIChzZWxmKSB7CiAgLy8gb3BlbiBhZnRlciBjbG9zZQogIGlmIChzZWxmLmNsb3NpbmcgIT09IG51bGwpIHJldHVybgoKICB0cnkgewogICAgYXdhaXQgc2VsZi5fb3BlbigpCiAgfSBjYXRjaCAoZXJyKSB7CiAgICBzZWxmLmNsb3NlKCkgLy8gc2FmZSB0byBydW4gaW4gYmcKICAgIHRocm93IGVycgogIH0KCiAgc2VsZi5vcGVuZWQgPSB0cnVlCiAgc2VsZi5lbWl0KCdyZWFkeScpCn0KCmFzeW5jIGZ1bmN0aW9uIGNsb3NlIChzZWxmKSB7CiAgdHJ5IHsKICAgIGlmIChzZWxmLm9wZW5lZCA9PT0gZmFsc2UgJiYgc2VsZi5vcGVuaW5nICE9PSBudWxsKSBhd2FpdCBzZWxmLm9wZW5pbmcKICB9IGNhdGNoIHsKICAgIC8vIGlnbm9yZSBlcnJvcnMgb24gY2xvc2luZwogIH0KICBpZiAoc2VsZi5vcGVuZWQgPT09IHRydWUgfHwgc2VsZi5vcGVuaW5nID09PSBudWxsKSBhd2FpdCBzZWxmLl9jbG9zZSgpCiAgc2VsZi5jbG9zZWQgPSB0cnVlCiAgc2VsZi5lbWl0KCdjbG9zZScpCn0KewogICJuYW1lIjogInJlYWR5LXJlc291cmNlIiwKICAidmVyc2lvbiI6ICIxLjIuMCIsCiAgImRlc2NyaXB0aW9uIjogIk1vZGVybiBzaW5nbGUgcmVzb3VyY2UgbWFuYWdlbWVudCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJpbXBvcnRzIjogewogICAgImV2ZW50cyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1ldmVudHMiLAogICAgICAiZGVmYXVsdCI6ICJldmVudHMiCiAgICB9CiAgfSwKICAidHlwZXMiOiAiaW5kZXguZC50cyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJpbmRleC5kLnRzIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMS4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JlYWR5LXJlc291cmNlLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JlYWR5LXJlc291cmNlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVhZHktcmVzb3VyY2UiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1ldmVudHMiOiAiXjIuMi4wIgogIH0KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKdmFyIEVNUFRZID0gW10KCm1vZHVsZS5leHBvcnRzID0gUmVjb3JkQ2FjaGUKCmZ1bmN0aW9uIFJlY29yZFNldCAoKSB7CiAgdGhpcy5saXN0ID0gW10KICB0aGlzLm1hcCA9IG5ldyBNYXAoKQp9CgpSZWNvcmRTZXQucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIChyZWNvcmQsIHZhbHVlKSB7CiAgdmFyIGsgPSB0b1N0cmluZyhyZWNvcmQpCiAgdmFyIHIgPSB0aGlzLm1hcC5nZXQoaykKICBpZiAocikgcmV0dXJuIGZhbHNlCgogIHIgPSB7aW5kZXg6IHRoaXMubGlzdC5sZW5ndGgsIHJlY29yZDogdmFsdWUgfHwgcmVjb3JkfQogIHRoaXMubGlzdC5wdXNoKHIpCiAgdGhpcy5tYXAuc2V0KGssIHIpCiAgcmV0dXJuIHRydWUKfQoKUmVjb3JkU2V0LnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiAocmVjb3JkKSB7CiAgdmFyIGsgPSB0b1N0cmluZyhyZWNvcmQpCiAgdmFyIHIgPSB0aGlzLm1hcC5nZXQoaykKICBpZiAoIXIpIHJldHVybiBmYWxzZQoKICBzd2FwKHRoaXMubGlzdCwgci5pbmRleCwgdGhpcy5saXN0Lmxlbmd0aCAtIDEpCiAgdGhpcy5saXN0LnBvcCgpCiAgdGhpcy5tYXAuZGVsZXRlKGspCiAgcmV0dXJuIHRydWUKfQoKZnVuY3Rpb24gUmVjb3JkU3RvcmUgKCkgewogIHRoaXMucmVjb3JkcyA9IG5ldyBNYXAoKQogIHRoaXMuc2l6ZSA9IDAKfQoKUmVjb3JkU3RvcmUucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIChuYW1lLCByZWNvcmQsIHZhbHVlKSB7CiAgdmFyIHIgPSB0aGlzLnJlY29yZHMuZ2V0KG5hbWUpCgogIGlmICghcikgewogICAgciA9IG5ldyBSZWNvcmRTZXQoKQogICAgdGhpcy5yZWNvcmRzLnNldChuYW1lLCByKQogIH0KCiAgaWYgKHIuYWRkKHJlY29yZCwgdmFsdWUpKSB7CiAgICB0aGlzLnNpemUrKwogICAgcmV0dXJuIHRydWUKICB9CgogIHJldHVybiBmYWxzZQp9CgpSZWNvcmRTdG9yZS5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24gKG5hbWUsIHJlY29yZCwgdmFsdWUpIHsKICB2YXIgciA9IHRoaXMucmVjb3Jkcy5nZXQobmFtZSkKICBpZiAoIXIpIHJldHVybiBmYWxzZQoKICBpZiAoci5yZW1vdmUocmVjb3JkLCB2YWx1ZSkpIHsKICAgIHRoaXMuc2l6ZS0tCiAgICBpZiAoIXIubWFwLnNpemUpIHRoaXMucmVjb3Jkcy5kZWxldGUobmFtZSkKICAgIHJldHVybiB0cnVlCiAgfQoKICByZXR1cm4gZmFsc2UKfQoKUmVjb3JkU3RvcmUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgdmFyIHIgPSB0aGlzLnJlY29yZHMuZ2V0KG5hbWUpCiAgcmV0dXJuIHIgPyByLmxpc3QgOiBFTVBUWQp9CgpmdW5jdGlvbiBSZWNvcmRDYWNoZSAob3B0cykgewogIGlmICghKHRoaXMgaW5zdGFuY2VvZiBSZWNvcmRDYWNoZSkpIHJldHVybiBuZXcgUmVjb3JkQ2FjaGUob3B0cykKICBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICB0aGlzLm1heFNpemUgPSBvcHRzLm1heFNpemUgfHwgSW5maW5pdHkKICB0aGlzLm1heEFnZSA9IG9wdHMubWF4QWdlIHx8IDAKCiAgdGhpcy5fb25zdGFsZSA9IG9wdHMub25TdGFsZSB8fCBvcHRzLm9uc3RhbGUgfHwgbnVsbAogIHRoaXMuX2ZyZXNoID0gbmV3IFJlY29yZFN0b3JlKCkKICB0aGlzLl9zdGFsZSA9IG5ldyBSZWNvcmRTdG9yZSgpCiAgdGhpcy5faW50ZXJ2YWwgPSBudWxsCiAgdGhpcy5fZ2NlZCA9IGZhbHNlCgogIGlmICh0aGlzLm1heEFnZSAmJiB0aGlzLm1heEFnZSA8IEluZmluaXR5KSB7CiAgICAvLyAyLzMgZ2l2ZXMgdXMgYSBzcGFuIG9mIDAuNjYtMS4zMyBtYXhBZ2Ugb3IgYXZnIG1heEFnZQogICAgdmFyIHRpY2sgPSBNYXRoLmNlaWwoMiAvIDMgKiB0aGlzLm1heEFnZSkKICAgIHRoaXMuX2ludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5fZ2NBdXRvLmJpbmQodGhpcyksIHRpY2spCiAgICBpZiAodGhpcy5faW50ZXJ2YWwudW5yZWYpIHRoaXMuX2ludGVydmFsLnVucmVmKCkKICB9Cn0KCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShSZWNvcmRDYWNoZS5wcm90b3R5cGUsICdzaXplJywgewogIGdldDogZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2ZyZXNoLnNpemUgKyB0aGlzLl9zdGFsZS5zaXplCiAgfQp9KQoKUmVjb3JkQ2FjaGUucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIChuYW1lLCByZWNvcmQsIHZhbHVlKSB7CiAgdGhpcy5fc3RhbGUucmVtb3ZlKG5hbWUsIHJlY29yZCwgdmFsdWUpCiAgaWYgKHRoaXMuX2ZyZXNoLmFkZChuYW1lLCByZWNvcmQsIHZhbHVlKSAmJiB0aGlzLl9mcmVzaC5zaXplID4gdGhpcy5tYXhTaXplKSB7CiAgICB0aGlzLl9nYygpCiAgfQp9CgpSZWNvcmRDYWNoZS5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24gKG5hbWUsIHJlY29yZCwgdmFsdWUpIHsKICB0aGlzLl9mcmVzaC5yZW1vdmUobmFtZSwgcmVjb3JkLCB2YWx1ZSkKICB0aGlzLl9zdGFsZS5yZW1vdmUobmFtZSwgcmVjb3JkLCB2YWx1ZSkKfQoKUmVjb3JkQ2FjaGUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIChuYW1lLCBuKSB7CiAgdmFyIGEgPSB0aGlzLl9mcmVzaC5nZXQobmFtZSkKICB2YXIgYiA9IHRoaXMuX3N0YWxlLmdldChuYW1lKQogIHZhciBhTGVuID0gYS5sZW5ndGgKICB2YXIgYkxlbiA9IGIubGVuZ3RoCiAgdmFyIGxlbiA9IGFMZW4gKyBiTGVuCgogIGlmIChuID4gbGVuIHx8ICFuKSBuID0gbGVuCiAgdmFyIHJlc3VsdCA9IG5ldyBBcnJheShuKQoKICBmb3IgKHZhciBpID0gMDsgaSA8IG47IGkrKykgewogICAgdmFyIGogPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAoYUxlbiArIGJMZW4pKQogICAgaWYgKGogPCBhTGVuKSB7CiAgICAgIHJlc3VsdFtpXSA9IGFbal0ucmVjb3JkCiAgICAgIHN3YXAoYSwgaiwgLS1hTGVuKQogICAgfSBlbHNlIHsKICAgICAgaiAtPSBhTGVuCiAgICAgIHJlc3VsdFtpXSA9IGJbal0ucmVjb3JkCiAgICAgIHN3YXAoYiwgaiwgLS1iTGVuKQogICAgfQogIH0KCiAgcmV0dXJuIHJlc3VsdAp9CgpSZWNvcmRDYWNoZS5wcm90b3R5cGUuX2djQXV0byA9IGZ1bmN0aW9uICgpIHsKICBpZiAoIXRoaXMuX2djZWQpIHRoaXMuX2djKCkKICB0aGlzLl9nY2VkID0gZmFsc2UKfQoKUmVjb3JkQ2FjaGUucHJvdG90eXBlLl9nYyA9IGZ1bmN0aW9uICgpIHsKICBpZiAodGhpcy5fb25zdGFsZSAmJiB0aGlzLl9zdGFsZS5zaXplID4gMCkgdGhpcy5fb25zdGFsZSh0aGlzLl9zdGFsZSkKICB0aGlzLl9zdGFsZSA9IHRoaXMuX2ZyZXNoCiAgdGhpcy5fZnJlc2ggPSBuZXcgUmVjb3JkU3RvcmUoKQogIHRoaXMuX2djZWQgPSB0cnVlCn0KClJlY29yZENhY2hlLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uICgpIHsKICB0aGlzLl9nYygpCiAgdGhpcy5fZ2MoKQp9CgpSZWNvcmRDYWNoZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKICB0aGlzLmNsZWFyKCkKICBjbGVhckludGVydmFsKHRoaXMuX2ludGVydmFsKQogIHRoaXMuX2ludGVydmFsID0gbnVsbAp9CgpmdW5jdGlvbiB0b1N0cmluZyAocmVjb3JkKSB7CiAgcmV0dXJuIGI0YS5pc0J1ZmZlcihyZWNvcmQpID8gYjRhLnRvU3RyaW5nKHJlY29yZCwgJ2hleCcpIDogcmVjb3JkCn0KCmZ1bmN0aW9uIHN3YXAgKGxpc3QsIGEsIGIpIHsKICB2YXIgdG1wID0gbGlzdFthXQogIHRtcC5pbmRleCA9IGIKICBsaXN0W2JdLmluZGV4ID0gYQogIGxpc3RbYV0gPSBsaXN0W2JdCiAgbGlzdFtiXSA9IHRtcAp9CnsKICAibmFtZSI6ICJyZWNvcmQtY2FjaGUiLAogICJ2ZXJzaW9uIjogIjEuMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiQ2FjaGUgb3B0aW1pc2VkIGZvciByZWNvcmQgbGlrZSB0aGluZ3MiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS4zLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xMC4wLjMiLAogICAgInRhcGUiOiAiXjQuOC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiB0YXBlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcmVjb3JkLWNhY2hlLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9yZWNvcmQtY2FjaGUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcmVjb3JkLWNhY2hlIgp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUmVmQ291bnRlciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLmNvdW50ID0gMAoKICAgIHRoaXMuX29uaWRsZSA9IG51bGwKICAgIHRoaXMuX2lkbGUgPSBudWxsCiAgfQoKICBpc0lkbGUoKSB7CiAgICByZXR1cm4gdGhpcy5jb3VudCA9PT0gMAogIH0KCiAgaWRsZSgpIHsKICAgIGlmICh0aGlzLmNvdW50ID09PSAwKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKICAgIGlmICh0aGlzLl9pZGxlICE9PSBudWxsKSByZXR1cm4gdGhpcy5faWRsZQoKICAgIHRoaXMuX2lkbGUgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICB0aGlzLl9vbmlkbGUgPSByZXNvbHZlCiAgICB9KQoKICAgIHJldHVybiB0aGlzLl9pZGxlCiAgfQoKICBpbmMoKSB7CiAgICB0aGlzLmNvdW50KysKICB9CgogIGRlYygpIHsKICAgIGlmICgtLXRoaXMuY291bnQgPiAwKSByZXR1cm4KCiAgICBpZiAodGhpcy5fb25pZGxlICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IHJlc29sdmUgPSB0aGlzLl9vbmlkbGUKICAgICAgdGhpcy5faWRsZSA9IG51bGwKICAgICAgdGhpcy5fb25pZGxlID0gbnVsbAogICAgICByZXNvbHZlKCkKICAgIH0KICB9Cn0KewogICJuYW1lIjogInJlZmNvdW50ZXIiLAogICJ2ZXJzaW9uIjogIjEuMC4wIiwKICAiZGVzY3JpcHRpb24iOiAiU2ltcGxlIHJlZmNvdW50ZXIiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHt9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JlZmNvdW50ZXIuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2ggSW5jIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JlZmNvdW50ZXIvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yZWZjb3VudGVyIgp9Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZS5hZGRvbi5iaW5kKHJlcXVpcmUpCnsKICAibmFtZSI6ICJyZXF1aXJlLWFkZG9uIiwKICAidmVyc2lvbiI6ICIxLjIuMCIsCiAgImRlc2NyaXB0aW9uIjogIkltcG9ydCBuYXRpdmUgYWRkb25zIGFjcm9zcyBKYXZhU2NyaXB0IHJ1bnRpbWVzIiwKICAiZXhwb3J0cyI6IHsKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4iOiB7CiAgICAgICJiYXJlIjogIi4vbGliL2JhcmUuanMiLAogICAgICAibm9kZSI6ICIuL2xpYi9ub2RlLmpzIiwKICAgICAgImRlZmF1bHQiOiAiLi9saWIvZGVmYXVsdC5qcyIKICAgIH0KICB9LAogICJpbXBvcnRzIjogewogICAgImZzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWZzIiwKICAgICAgImRlZmF1bHQiOiAiZnMiCiAgICB9LAogICAgInBhdGgiOiB7CiAgICAgICJiYXJlIjogImJhcmUtcGF0aCIsCiAgICAgICJkZWZhdWx0IjogInBhdGgiCiAgICB9LAogICAgInVybCI6IHsKICAgICAgImJhcmUiOiAiYmFyZS11cmwiLAogICAgICAiZGVmYXVsdCI6ICJ1cmwiCiAgICB9CiAgfSwKICAiZmlsZXMiOiBbCiAgICAibGliIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJucG0gcnVuIGxpbnQgJiYgbnBtIHJ1biB0ZXN0OmJhcmUgJiYgbnBtIHJ1biB0ZXN0Om5vZGUiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QuanMiLAogICAgInRlc3Q6bm9kZSI6ICJub2RlIHRlc3QuanMiLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuIiwKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JlcXVpcmUtYWRkb24uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVxdWlyZS1hZGRvbi9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JlcXVpcmUtYWRkb24jcmVhZG1lIiwKICAiZW5naW5lcyI6IHsKICAgICJiYXJlIjogIj49MS4xMC4wIgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWFkZG9uLXJlc29sdmUiOiAiXjEuMy4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWJ1bmRsZSI6ICJeMS44LjEiLAogICAgImJhcmUtYnVuZGxlLWV2YWx1YXRlIjogIl4xLjEuMCIsCiAgICAiYmFyZS1mcyI6ICJeNC4wLjAiLAogICAgImJhcmUtcGF0aCI6ICJeMy4wLjAiLAogICAgImJhcmUtdXJsIjogIl4yLjEuMCIsCiAgICAiYnJpdHRsZSI6ICJeMy43LjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiCiAgfQp9CmxldCB0bXBSZXNvbHZlID0gbnVsbApsZXQgdG1wUmVqZWN0ID0gbnVsbAoKaWYgKFByb21pc2Uud2l0aFJlc29sdmVycykgewogIG1vZHVsZS5leHBvcnRzID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzLmJpbmQoUHJvbWlzZSkKfSBlbHNlIHsKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIHJlc29sdmVSZWplY3RQcm9taXNlICgpIHsKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZShzZXRUbXApCiAgICBjb25zdCByZXN1bHQgPSB7IHByb21pc2UsIHJlc29sdmU6IHRtcFJlc29sdmUsIHJlamVjdDogdG1wUmVqZWN0IH0KICAgIHRtcFJlc29sdmUgPSB0bXBSZWplY3QgPSBudWxsCiAgICByZXR1cm4gcmVzdWx0CiAgfQp9CgpmdW5jdGlvbiBzZXRUbXAgKHJlc29sdmUsIHJlamVjdCkgewogIHRtcFJlc29sdmUgPSByZXNvbHZlCiAgdG1wUmVqZWN0ID0gcmVqZWN0Cn0KewogICJuYW1lIjogInJlc29sdmUtcmVqZWN0LXByb21pc2UiLAogICJ2ZXJzaW9uIjogIjEuMS4wIiwKICAiZGVzY3JpcHRpb24iOiAiQ3JlYXRlIGFuIGludmVydGVkIHByb21pc2Ugd2l0aCBubyBmdW5jdGlvbiBhbGxvY3MiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4yIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3Jlc29sdmUtcmVqZWN0LXByb21pc2UuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZSIKfQpjb25zdCByZXNvdXJjZXMgPSBuZXcgTWFwKCkKCmV4cG9ydHMuYWRkID0gZnVuY3Rpb24ocmVzb3VyY2UsIHRlYXJkb3duKSB7CiAgcmVzb3VyY2VzLnNldChyZXNvdXJjZSwgdGVhcmRvd24pCn0KCmV4cG9ydHMucmVtb3ZlID0gZnVuY3Rpb24ocmVzb3VyY2UpIHsKICByZXNvdXJjZXMuZGVsZXRlKHJlc291cmNlKQp9CgppZiAoZ2xvYmFsLkJhcmUpIGdsb2JhbC5CYXJlLm9uKCdleGl0JywgcnVuKQplbHNlIGdsb2JhbC5wcm9jZXNzLm9uKCdleGl0JywgcnVuKQoKZnVuY3Rpb24gcnVuKCkgewogIGZvciAoY29uc3QgW3Jlc291cmNlLCB0ZWFyZG93bl0gb2YgcmVzb3VyY2VzKSB7CiAgICB0ZWFyZG93bihyZXNvdXJjZSkKICB9Cn0KewogICJuYW1lIjogInJlc291cmNlLW9uLWV4aXQiLAogICJ2ZXJzaW9uIjogIjEuMC4wIiwKICAiZGVzY3JpcHRpb24iOiAiUmVnaXN0ZXIgc3luYyB0ZWFyZG93biBoYW5kbGVycyBmb3IgYSByZXNvdXJjZSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjoge30sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS10ZWFyZG93bi5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMuIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtdGVhcmRvd24vaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXRlYXJkb3duIgp9CnJlcXVpcmUuYWRkb24gPSByZXF1aXJlKCdyZXF1aXJlLWFkZG9uJykKCm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZS5hZGRvbignLicsIF9fZmlsZW5hbWUpCmNvbnN0IENvbHVtbkZhbWlseSA9IHJlcXVpcmUoJy4vbGliL2NvbHVtbi1mYW1pbHknKQpjb25zdCBJdGVyYXRvciA9IHJlcXVpcmUoJy4vbGliL2l0ZXJhdG9yJykKY29uc3QgU25hcHNob3QgPSByZXF1aXJlKCcuL2xpYi9zbmFwc2hvdCcpCmNvbnN0IFN0YXRlID0gcmVxdWlyZSgnLi9saWIvc3RhdGUnKQpjb25zdCB7IEJsb29tRmlsdGVyUG9saWN5LCBSaWJib25GaWx0ZXJQb2xpY3kgfSA9IHJlcXVpcmUoJy4vbGliL2ZpbHRlci1wb2xpY3knKQpjb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2xpYi9jb25zdGFudHMnKQoKY2xhc3MgUm9ja3NEQiB7CiAgY29uc3RydWN0b3IocGF0aCwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7CiAgICAgIGNvbHVtbkZhbWlseSwKICAgICAgc3RhdGUgPSBuZXcgU3RhdGUodGhpcywgcGF0aCwgb3B0cyksCiAgICAgIHNuYXBzaG90ID0gbnVsbCwKICAgICAga2V5RW5jb2RpbmcgPSBudWxsLAogICAgICB2YWx1ZUVuY29kaW5nID0gbnVsbAogICAgfSA9IG9wdHMKCiAgICB0aGlzLl9zdGF0ZSA9IHN0YXRlCiAgICB0aGlzLl9zbmFwc2hvdCA9IHNuYXBzaG90CiAgICB0aGlzLl9jb2x1bW5GYW1pbHkgPSBzdGF0ZS5nZXRDb2x1bW5GYW1pbHkoY29sdW1uRmFtaWx5KQogICAgdGhpcy5fa2V5RW5jb2RpbmcgPSBrZXlFbmNvZGluZwogICAgdGhpcy5fdmFsdWVFbmNvZGluZyA9IHZhbHVlRW5jb2RpbmcKICAgIHRoaXMuX2luZGV4ID0gLTEKCiAgICB0aGlzLl9zdGF0ZS5hZGRTZXNzaW9uKHRoaXMpCiAgfQoKICBnZXQgb3BlbmVkKCkgewogICAgcmV0dXJuIHRoaXMuX3N0YXRlLm9wZW5lZAogIH0KCiAgZ2V0IGNsb3NlZCgpIHsKICAgIHJldHVybiB0aGlzLmlzUm9vdCgpID8gdGhpcy5fc3RhdGUuY2xvc2VkIDogdGhpcy5faW5kZXggPT09IC0xCiAgfQoKICBnZXQgcGF0aCgpIHsKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5wYXRoCiAgfQoKICBnZXQgc25hcHNob3R0ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5fc25hcHNob3QgIT09IG51bGwKICB9CgogIGdldCBkZWZhdWx0Q29sdW1uRmFtaWx5KCkgewogICAgcmV0dXJuIHRoaXMuX2NvbHVtbkZhbWlseQogIH0KCiAgc2Vzc2lvbih7CiAgICBjb2x1bW5GYW1pbHkgPSB0aGlzLl9jb2x1bW5GYW1pbHksCiAgICBzbmFwc2hvdCA9IHRoaXMuX3NuYXBzaG90ICE9PSBudWxsLAogICAga2V5RW5jb2RpbmcgPSB0aGlzLl9rZXlFbmNvZGluZywKICAgIHZhbHVlRW5jb2RpbmcgPSB0aGlzLl92YWx1ZUVuY29kaW5nCiAgfSA9IHt9KSB7CiAgICBtYXliZUNsb3NlZCh0aGlzKQoKICAgIHJldHVybiBuZXcgUm9ja3NEQihudWxsLCB7CiAgICAgIHN0YXRlOiB0aGlzLl9zdGF0ZSwKICAgICAgY29sdW1uRmFtaWx5LAogICAgICBzbmFwc2hvdDogc25hcHNob3QgPyB0aGlzLl9zbmFwc2hvdCB8fCBuZXcgU25hcHNob3QodGhpcy5fc3RhdGUpIDogbnVsbCwKICAgICAga2V5RW5jb2RpbmcsCiAgICAgIHZhbHVlRW5jb2RpbmcKICAgIH0pCiAgfQoKICBjb2x1bW5GYW1pbHkobmFtZSwgb3B0cykgewogICAgcmV0dXJuIHRoaXMuc2Vzc2lvbih7IC4uLm9wdHMsIGNvbHVtbkZhbWlseTogbmFtZSB9KQogIH0KCiAgc25hcHNob3QoKSB7CiAgICByZXR1cm4gdGhpcy5zZXNzaW9uKHsgc25hcHNob3Q6IHRydWUgfSkKICB9CgogIGlzUm9vdCgpIHsKICAgIHJldHVybiB0aGlzID09PSB0aGlzLl9zdGF0ZS5kYgogIH0KCiAgcmVhZHkoKSB7CiAgICByZXR1cm4gdGhpcy5fc3RhdGUucmVhZHkoKQogIH0KCiAgYXN5bmMgY2xvc2UoeyBmb3JjZSB9ID0ge30pIHsKICAgIGlmICghdGhpcy5fc3RhdGUub3BlbmVkKSBhd2FpdCB0aGlzLl9zdGF0ZS5yZWFkeSgpCgogICAgaWYgKHRoaXMuX2luZGV4ICE9PSAtMSkgdGhpcy5fc3RhdGUucmVtb3ZlU2Vzc2lvbih0aGlzKQoKICAgIGlmIChmb3JjZSkgewogICAgICB3aGlsZSAodGhpcy5fc3RhdGUuc2Vzc2lvbnMubGVuZ3RoID4gMCkgewogICAgICAgIGF3YWl0IHRoaXMuX3N0YXRlLnNlc3Npb25zW3RoaXMuX3N0YXRlLnNlc3Npb25zLmxlbmd0aCAtIDFdLmNsb3NlKCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzLmlzUm9vdCgpID8gdGhpcy5fc3RhdGUuY2xvc2UoKSA6IFByb21pc2UucmVzb2x2ZSgpCiAgfQoKICBzdXNwZW5kKCkgewogICAgbWF5YmVDbG9zZWQodGhpcykKCiAgICByZXR1cm4gdGhpcy5fc3RhdGUuc3VzcGVuZCgpCiAgfQoKICByZXN1bWUoKSB7CiAgICBtYXliZUNsb3NlZCh0aGlzKQoKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5yZXN1bWUoKQogIH0KCiAgaXNJZGxlKCkgewogICAgcmV0dXJuIHRoaXMuX3N0YXRlLmhhbmRsZXMuaXNJZGxlKCkKICB9CgogIGlkbGUoKSB7CiAgICByZXR1cm4gdGhpcy5fc3RhdGUuaGFuZGxlcy5pZGxlKCkKICB9CgogIGl0ZXJhdG9yKHJhbmdlLCBvcHRzKSB7CiAgICBtYXliZUNsb3NlZCh0aGlzKQoKICAgIHJldHVybiBuZXcgSXRlcmF0b3IodGhpcywgeyAuLi5yYW5nZSwgLi4ub3B0cyB9KQogIH0KCiAgYXN5bmMgKmtleXMocmFuZ2UsIG9wdHMpIHsKICAgIGZvciBhd2FpdCAoY29uc3QgeyBrZXkgfSBvZiB0aGlzLml0ZXJhdG9yKHJhbmdlLCB7CiAgICAgIC4uLm9wdHMsCiAgICAgIHZhbHVlczogZmFsc2UKICAgIH0pKSB7CiAgICAgIHlpZWxkIGtleQogICAgfQogIH0KCiAgYXN5bmMgcGVlayhyYW5nZSwgb3B0cykgewogICAgZm9yIGF3YWl0IChjb25zdCB2YWx1ZSBvZiB0aGlzLml0ZXJhdG9yKHsgLi4ucmFuZ2UsIC4uLm9wdHMsIGxpbWl0OiAxIH0pKSB7CiAgICAgIHJldHVybiB2YWx1ZQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICByZWFkKG9wdHMpIHsKICAgIG1heWJlQ2xvc2VkKHRoaXMpCgogICAgcmV0dXJuIHRoaXMuX3N0YXRlLmNyZWF0ZVJlYWRCYXRjaCh0aGlzLCBvcHRzKQogIH0KCiAgd3JpdGUob3B0cykgewogICAgbWF5YmVDbG9zZWQodGhpcykKCiAgICByZXR1cm4gdGhpcy5fc3RhdGUuY3JlYXRlV3JpdGVCYXRjaCh0aGlzLCBvcHRzKQogIH0KCiAgZmx1c2gob3B0cykgewogICAgbWF5YmVDbG9zZWQodGhpcykKCiAgICByZXR1cm4gdGhpcy5fc3RhdGUuZmx1c2godGhpcywgb3B0cykKICB9CgogIGFzeW5jIGdldChrZXksIG9wdHMpIHsKICAgIGNvbnN0IGJhdGNoID0gdGhpcy5yZWFkKHsgLi4ub3B0cywgY2FwYWNpdHk6IDEsIGF1dG9EZXN0cm95OiB0cnVlIH0pCiAgICBjb25zdCB2YWx1ZSA9IGJhdGNoLmdldChrZXkpCiAgICBiYXRjaC50cnlGbHVzaCgpCiAgICByZXR1cm4gdmFsdWUKICB9CgogIGFzeW5jIHB1dChrZXksIHZhbHVlLCBvcHRzKSB7CiAgICBjb25zdCBiYXRjaCA9IHRoaXMud3JpdGUoeyAuLi5vcHRzLCBjYXBhY2l0eTogMSwgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKICAgIGJhdGNoLnRyeVB1dChrZXksIHZhbHVlKQogICAgYXdhaXQgYmF0Y2guZmx1c2goKQogIH0KCiAgYXN5bmMgZGVsZXRlKGtleSwgb3B0cykgewogICAgY29uc3QgYmF0Y2ggPSB0aGlzLndyaXRlKHsgLi4ub3B0cywgY2FwYWNpdHk6IDEsIGF1dG9EZXN0cm95OiB0cnVlIH0pCiAgICBiYXRjaC50cnlEZWxldGUoa2V5KQogICAgYXdhaXQgYmF0Y2guZmx1c2goKQogIH0KCiAgYXN5bmMgZGVsZXRlUmFuZ2Uoc3RhcnQsIGVuZCwgb3B0cykgewogICAgY29uc3QgYmF0Y2ggPSB0aGlzLndyaXRlKHsgLi4ub3B0cywgY2FwYWNpdHk6IDEsIGF1dG9EZXN0cm95OiB0cnVlIH0pCiAgICBiYXRjaC50cnlEZWxldGVSYW5nZShzdGFydCwgZW5kKQogICAgYXdhaXQgYmF0Y2guZmx1c2goKQogIH0KCiAgYXN5bmMgY29tcGFjdFJhbmdlKHN0YXJ0ID0gbnVsbCwgZW5kID0gbnVsbCwgb3B0cyA9IHt9KSB7CiAgICBpZiAodHlwZW9mIGVuZCA9PT0gJ29iamVjdCcgJiYgZW5kICE9PSBudWxsKSB7CiAgICAgIG9wdHMgPSBlbmQKICAgICAgZW5kID0gbnVsbAogICAgfSBlbHNlIGlmICh0eXBlb2Ygc3RhcnQgPT09ICdvYmplY3QnICYmIHN0YXJ0ICE9PSBudWxsKSB7CiAgICAgIG9wdHMgPSBzdGFydAogICAgICBzdGFydCA9IG51bGwKICAgICAgZW5kID0gbnVsbAogICAgfQoKICAgIGF3YWl0IHRoaXMuX3N0YXRlLmNvbXBhY3RSYW5nZSh0aGlzLCBzdGFydCwgZW5kLCBvcHRzKQogIH0KCiAgYXN5bmMgYXBwcm94aW1hdGVTaXplKHN0YXJ0LCBlbmQsIG9wdHMgPSB7fSkgewogICAgcmV0dXJuIHRoaXMuX3N0YXRlLmFwcHJveGltYXRlU2l6ZSh0aGlzLCBzdGFydCwgZW5kLCBvcHRzKQogIH0KCiAgX3JlZigpIHsKICAgIGlmICh0aGlzLl9zbmFwc2hvdCkgdGhpcy5fc25hcHNob3QucmVmKCkKICAgIHRoaXMuX3N0YXRlLmhhbmRsZXMuaW5jKCkKICB9CgogIF91bnJlZigpIHsKICAgIGlmICh0aGlzLl9zbmFwc2hvdCkgdGhpcy5fc25hcHNob3QudW5yZWYoKQogICAgdGhpcy5fc3RhdGUuaGFuZGxlcy5kZWMoKQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gUm9ja3NEQgoKZXhwb3J0cy5jb25zdGFudHMgPSBjb25zdGFudHMKCmV4cG9ydHMuQ29sdW1uRmFtaWx5ID0gQ29sdW1uRmFtaWx5CmV4cG9ydHMuQmxvb21GaWx0ZXJQb2xpY3kgPSBCbG9vbUZpbHRlclBvbGljeQpleHBvcnRzLlJpYmJvbkZpbHRlclBvbGljeSA9IFJpYmJvbkZpbHRlclBvbGljeQoKZnVuY3Rpb24gbWF5YmVDbG9zZWQoZGIpIHsKICBpZiAoZGIuX3N0YXRlLmNsb3NpbmcgfHwgZGIuX2luZGV4ID09PSAtMSkgdGhyb3cgbmV3IEVycm9yKCdSb2Nrc0RCIHNlc3Npb24gaXMgY2xvc2VkJykKfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKCmNvbnN0IGVtcHR5ID0gQnVmZmVyLmFsbG9jKDApCmNvbnN0IHJlc29sdmVkID0gUHJvbWlzZS5yZXNvbHZlKCkKCmNsYXNzIFJvY2tzREJCYXRjaCB7CiAgY29uc3RydWN0b3IoZGIsIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyBjYXBhY2l0eSA9IDgsIGF1dG9EZXN0cm95ID0gZmFsc2UgfSA9IG9wdHMKCiAgICBkYi5fcmVmKCkKCiAgICB0aGlzLl9kYiA9IGRiCiAgICB0aGlzLl9kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5fY2FwYWNpdHkgPSBjYXBhY2l0eQogICAgdGhpcy5fb3BlcmF0aW9ucyA9IFtdCiAgICB0aGlzLl9wcm9taXNlcyA9IFtdCgogICAgdGhpcy5fZW5xdWV1ZVByb21pc2UgPSB0aGlzLl9lbnF1ZXVlUHJvbWlzZS5iaW5kKHRoaXMpCgogICAgdGhpcy5fcmVxdWVzdCA9IG51bGwKICAgIHRoaXMuX3Jlc29sdmUgPSBudWxsCiAgICB0aGlzLl9yZWplY3QgPSBudWxsCgogICAgdGhpcy5faGFuZGxlID0gbnVsbAogICAgdGhpcy5fYnVmZmVyID0gbnVsbAogICAgdGhpcy5fYXV0b0Rlc3Ryb3kgPSBhdXRvRGVzdHJveQoKICAgIGlmIChk","Yi5fc3RhdGUub3BlbmVkID09PSB0cnVlKSB0aGlzLnJlYWR5KCkKICB9CgogIF9yZXVzZShkYiwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IGF1dG9EZXN0cm95ID0gZmFsc2UgfSA9IG9wdHMKCiAgICBkYi5fcmVmKCkKCiAgICB0aGlzLl9kYiA9IGRiCiAgICB0aGlzLl9kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5fYXV0b0Rlc3Ryb3kgPSBhdXRvRGVzdHJveQogIH0KCiAgX29uZmluaXNoZWQoZXJyKSB7CiAgICBjb25zdCByZXNvbHZlID0gdGhpcy5fcmVzb2x2ZQogICAgY29uc3QgcmVqZWN0ID0gdGhpcy5fcmVqZWN0CgogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQoKICAgIHRoaXMuX29wZXJhdGlvbnMgPSBbXQogICAgdGhpcy5fcHJvbWlzZXMgPSBbXQogICAgdGhpcy5fcmVxdWVzdCA9IG51bGwKICAgIHRoaXMuX3Jlc29sdmUgPSBudWxsCiAgICB0aGlzLl9yZWplY3QgPSBudWxsCgogICAgaWYgKHRoaXMuX2F1dG9EZXN0cm95ID09PSB0cnVlKSB0aGlzLmRlc3Ryb3koKQoKICAgIGlmIChyZWplY3QgIT09IG51bGwgJiYgZXJyKSByZWplY3QoZXJyKQogICAgZWxzZSBpZiAocmVzb2x2ZSAhPT0gbnVsbCkgcmVzb2x2ZSgpCiAgfQoKICBfcmVzaXplKCkgewogICAgaWYgKHRoaXMuX29wZXJhdGlvbnMubGVuZ3RoIDw9IHRoaXMuX2NhcGFjaXR5KSByZXR1cm4gZmFsc2UKCiAgICB3aGlsZSAodGhpcy5fb3BlcmF0aW9ucy5sZW5ndGggPiB0aGlzLl9jYXBhY2l0eSkgewogICAgICB0aGlzLl9jYXBhY2l0eSAqPSAyCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIHJlYWR5KCkgewogICAgaWYgKHRoaXMuX2hhbmRsZSAhPT0gbnVsbCkgcmV0dXJuCgogICAgaWYgKHRoaXMuX2RiLl9zdGF0ZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLl9kYi5fc3RhdGUucmVhZHkoKQoKICAgIHRoaXMuX2luaXQoKQogIH0KCiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLl9yZXF1ZXN0KSB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgaW4gcHJvZ3Jlc3MnKQogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgcmV0dXJuCgogICAgdGhpcy5fZGVzdHJveWVkID0gdHJ1ZQoKICAgIGlmICh0aGlzLl9wcm9taXNlcy5sZW5ndGgpIHRoaXMuX2Fib3J0KCkKCiAgICB0aGlzLl9kYi5fdW5yZWYoKQogICAgdGhpcy5fb25mcmVlKCkKICB9CgogIF9vbmZyZWUoKSB7CiAgICB0aGlzLl9kYi5fc3RhdGUuZnJlZUJhdGNoKHRoaXMsIGZhbHNlKQogICAgdGhpcy5fZGIgPSBudWxsCiAgfQoKICBfYWJvcnQoKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3Byb21pc2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHByb21pc2UgPSB0aGlzLl9wcm9taXNlc1tpXQogICAgICBpZiAocHJvbWlzZSAhPT0gbnVsbCkgcHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdCYXRjaCBpcyBkZXN0cm95ZWQnKSkKICAgIH0KCiAgICB0aGlzLl9vbmZpbmlzaGVkKG5ldyBFcnJvcignQmF0Y2ggaXMgZGVzdHJveWVkJykpCiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGlmICh0aGlzLl9yZXF1ZXN0KSB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgaW4gcHJvZ3Jlc3MnKQogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdCYXRjaCBpcyBkZXN0cm95ZWQnKQoKICAgIHRoaXMuX3JlcXVlc3QgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIHRoaXMuX3Jlc29sdmUgPSByZXNvbHZlCiAgICAgIHRoaXMuX3JlamVjdCA9IHJlamVjdAogICAgfSkKCiAgICB0aGlzLl9mbHVzaCgpCgogICAgcmV0dXJuIHRoaXMuX3JlcXVlc3QKICB9CgogIHRyeUZsdXNoKCkgewogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBpbiBwcm9ncmVzcycpCiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSB0aHJvdyBuZXcgRXJyb3IoJ0JhdGNoIGlzIGRlc3Ryb3llZCcpCgogICAgdGhpcy5fcmVxdWVzdCA9IHJlc29sdmVkCgogICAgdGhpcy5fZmx1c2goKQogIH0KCiAgYXN5bmMgX2ZsdXNoKCkgewogICAgaWYgKHRoaXMuX2hhbmRsZSA9PT0gbnVsbCkgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgdGhpcy5fZGIuX3N0YXRlLmlvLmluYygpCgogICAgaWYgKHRoaXMuX2RiLl9zdGF0ZS5yZXN1bWVkICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IHJlc3VtZWQgPSBhd2FpdCB0aGlzLl9kYi5fc3RhdGUucmVzdW1lZC5wcm9taXNlCgogICAgICBpZiAoIXJlc3VtZWQpIHsKICAgICAgICBpZiAodGhpcy5fZGVzdHJveWVkKSB7CiAgICAgICAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fZGVzdHJveWVkID0gdHJ1ZQogICAgICAgICAgdGhpcy5fYWJvcnQoKQogICAgICAgICAgdGhpcy5fZGIuX3VucmVmKCkKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIF9lbnF1ZXVlUHJvbWlzZShyZXNvbHZlLCByZWplY3QpIHsKICAgIHRoaXMuX3Byb21pc2VzLnB1c2goeyByZXNvbHZlLCByZWplY3QgfSkKICB9CgogIF9lbmNvZGVLZXkoaykgewogICAgaWYgKHRoaXMuX2RiLl9rZXlFbmNvZGluZykgcmV0dXJuIGMuZW5jb2RlKHRoaXMuX2RiLl9rZXlFbmNvZGluZywgaykKICAgIGlmICh0eXBlb2YgayA9PT0gJ3N0cmluZycpIHJldHVybiBCdWZmZXIuZnJvbShrKQogICAgcmV0dXJuIGsKICB9CgogIF9lbmNvZGVWYWx1ZSh2KSB7CiAgICBpZiAodGhpcy5fZGIuX3ZhbHVlRW5jb2RpbmcpIHJldHVybiBjLmVuY29kZSh0aGlzLl9kYi5fdmFsdWVFbmNvZGluZywgdikKICAgIGlmICh2ID09PSBudWxsKSByZXR1cm4gZW1wdHkKICAgIGlmICh0eXBlb2YgdiA9PT0gJ3N0cmluZycpIHJldHVybiBCdWZmZXIuZnJvbSh2KQogICAgcmV0dXJuIHYKICB9CgogIF9kZWNvZGVWYWx1ZShiKSB7CiAgICBpZiAodGhpcy5fZGIuX3ZhbHVlRW5jb2RpbmcpIHJldHVybiBjLmRlY29kZSh0aGlzLl9kYi5fdmFsdWVFbmNvZGluZywgYikKICAgIHJldHVybiBiCiAgfQp9CgpleHBvcnRzLlJlYWRCYXRjaCA9IGNsYXNzIFJvY2tzREJSZWFkQmF0Y2ggZXh0ZW5kcyBSb2Nrc0RCQmF0Y2ggewogIGNvbnN0cnVjdG9yKGRiLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKGRiLCBvcHRzKQoKICAgIGNvbnN0IHsgYXN5bmNJTyA9IGZhbHNlLCBmaWxsQ2FjaGUgPSB0cnVlIH0gPSBvcHRzCgogICAgdGhpcy5fYXN5bmNJTyA9IGFzeW5jSU8KICAgIHRoaXMuX2ZpbGxDYWNoZSA9IGZpbGxDYWNoZQogIH0KCiAgX2luaXQoKSB7CiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLnJlYWRJbml0KCkKICAgIHRoaXMuX2J1ZmZlciA9IGJpbmRpbmcucmVhZEJ1ZmZlcih0aGlzLl9oYW5kbGUsIHRoaXMuX2NhcGFjaXR5KQogIH0KCiAgX3Jlc2l6ZSgpIHsKICAgIGlmIChzdXBlci5fcmVzaXplKCkgJiYgdGhpcy5faGFuZGxlICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX2J1ZmZlciA9IGJpbmRpbmcucmVhZEJ1ZmZlcih0aGlzLl9oYW5kbGUsIHRoaXMuX2NhcGFjaXR5KQogICAgfQogIH0KCiAgYXN5bmMgX2ZsdXNoKCkgewogICAgYXdhaXQgc3VwZXIuX2ZsdXNoKCkKCiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSByZXR1cm4KCiAgICB0cnkgewogICAgICBiaW5kaW5nLnJlYWQoCiAgICAgICAgdGhpcy5fZGIuX3N0YXRlLl9oYW5kbGUsCiAgICAgICAgdGhpcy5faGFuZGxlLAogICAgICAgIHRoaXMuX29wZXJhdGlvbnMsCiAgICAgICAgdGhpcy5fZGIuX3NuYXBzaG90ID8gdGhpcy5fZGIuX3NuYXBzaG90Ll9oYW5kbGUgOiB1bmRlZmluZWQsCiAgICAgICAgdGhpcy5fYXN5bmNJTywKICAgICAgICB0aGlzLl9maWxsQ2FjaGUsCiAgICAgICAgdGhpcywKICAgICAgICB0aGlzLl9vbnJlYWQKICAgICAgKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIF9vbnJlYWQoZXJycywgdmFsdWVzKSB7CiAgICBsZXQgYXBwbGllZCA9IHRydWUKCiAgICBmb3IgKGxldCBpID0gMCwgbiA9IHRoaXMuX3Byb21pc2VzLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCBlcnIgPSBlcnJzW2ldCiAgICAgIGlmIChlcnIpIGFwcGxpZWQgPSBmYWxzZQoKICAgICAgY29uc3QgcHJvbWlzZSA9IHRoaXMuX3Byb21pc2VzW2ldCiAgICAgIGlmIChwcm9taXNlID09PSBudWxsKSBjb250aW51ZQoKICAgICAgaWYgKGVycikgcHJvbWlzZS5yZWplY3QobmV3IEVycm9yKGVycikpCiAgICAgIGVsc2UgcHJvbWlzZS5yZXNvbHZlKHZhbHVlc1tpXSA/IHRoaXMuX2RlY29kZVZhbHVlKEJ1ZmZlci5mcm9tKHZhbHVlc1tpXSkpIDogbnVsbCkKICAgIH0KCiAgICB0aGlzLl9vbmZpbmlzaGVkKGFwcGxpZWQgPyBudWxsIDogbmV3IEVycm9yKCdCYXRjaCB3YXMgbm90IGFwcGxpZWQnKSkKICB9CgogIGdldChrZXkpIHsKICAgIGlmICh0aGlzLl9yZXF1ZXN0KSB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWxyZWFkeSBpbiBwcm9ncmVzcycpCgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHRoaXMuX2VucXVldWVQcm9taXNlKQoKICAgIHRoaXMuX29wZXJhdGlvbnMucHVzaChuZXcgUm9ja3NEQkdldCh0aGlzLl9lbmNvZGVLZXkoa2V5KSwgdGhpcy5fZGIuX2NvbHVtbkZhbWlseSkpCgogICAgdGhpcy5fcmVzaXplKCkKCiAgICByZXR1cm4gcHJvbWlzZQogIH0KfQoKZXhwb3J0cy5Xcml0ZUJhdGNoID0gY2xhc3MgUm9ja3NEQldyaXRlQmF0Y2ggZXh0ZW5kcyBSb2Nrc0RCQmF0Y2ggewogIF9pbml0KCkgewogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy53cml0ZUluaXQoKQogICAgdGhpcy5fYnVmZmVyID0gYmluZGluZy53cml0ZUJ1ZmZlcih0aGlzLl9oYW5kbGUsIHRoaXMuX2NhcGFjaXR5KQogIH0KCiAgX3Jlc2l6ZSgpIHsKICAgIGlmIChzdXBlci5fcmVzaXplKCkgJiYgdGhpcy5faGFuZGxlICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX2J1ZmZlciA9IGJpbmRpbmcud3JpdGVCdWZmZXIodGhpcy5faGFuZGxlLCB0aGlzLl9jYXBhY2l0eSkKICAgIH0KICB9CgogIF9vbmZyZWUoKSB7CiAgICB0aGlzLl9kYi5fc3RhdGUuZnJlZUJhdGNoKHRoaXMsIHRydWUpCiAgfQoKICBhc3luYyBfZmx1c2goKSB7CiAgICBhd2FpdCBzdXBlci5fZmx1c2goKQoKICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHJldHVybgoKICAgIHRyeSB7CiAgICAgIGJpbmRpbmcud3JpdGUodGhpcy5fZGIuX3N0YXRlLl9oYW5kbGUsIHRoaXMuX2hhbmRsZSwgdGhpcy5fb3BlcmF0aW9ucywgdGhpcywgdGhpcy5fb253cml0ZSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKICAgICAgdGhyb3cgZXJyCiAgICB9CiAgfQoKICBfb253cml0ZShlcnIpIHsKICAgIGNvbnN0IGFwcGxpZWQgPSAhZXJyCgogICAgZm9yIChsZXQgaSA9IDAsIG4gPSB0aGlzLl9wcm9taXNlcy5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgY29uc3QgcHJvbWlzZSA9IHRoaXMuX3Byb21pc2VzW2ldCiAgICAgIGlmIChwcm9taXNlID09PSBudWxsKSBjb250aW51ZQoKICAgICAgaWYgKGVycikgcHJvbWlzZS5yZWplY3QobmV3IEVycm9yKGVycikpCiAgICAgIGVsc2UgcHJvbWlzZS5yZXNvbHZlKCkKICAgIH0KCiAgICB0aGlzLl9vbmZpbmlzaGVkKGFwcGxpZWQgPyBudWxsIDogbmV3IEVycm9yKCdCYXRjaCB3YXMgbm90IGFwcGxpZWQnKSkKICB9CgogIHB1dChrZXksIHZhbHVlKSB7CiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGFscmVhZHkgaW4gcHJvZ3Jlc3MnKQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSh0aGlzLl9lbnF1ZXVlUHJvbWlzZSkKCiAgICB0aGlzLl9vcGVyYXRpb25zLnB1c2goCiAgICAgIG5ldyBSb2Nrc0RCUHV0KHRoaXMuX2VuY29kZUtleShrZXkpLCB0aGlzLl9lbmNvZGVWYWx1ZSh2YWx1ZSksIHRoaXMuX2RiLl9jb2x1bW5GYW1pbHkpCiAgICApCgogICAgdGhpcy5fcmVzaXplKCkKCiAgICByZXR1cm4gcHJvbWlzZQogIH0KCiAgdHJ5UHV0KGtleSwgdmFsdWUpIHsKICAgIGlmICh0aGlzLl9yZXF1ZXN0KSB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWxyZWFkeSBpbiBwcm9ncmVzcycpCgogICAgdGhpcy5fb3BlcmF0aW9ucy5wdXNoKAogICAgICBuZXcgUm9ja3NEQlB1dCh0aGlzLl9lbmNvZGVLZXkoa2V5KSwgdGhpcy5fZW5jb2RlVmFsdWUodmFsdWUpLCB0aGlzLl9kYi5fY29sdW1uRmFtaWx5KQogICAgKQoKICAgIHRoaXMuX3Byb21pc2VzLnB1c2gobnVsbCkKCiAgICB0aGlzLl9yZXNpemUoKQogIH0KCiAgZGVsZXRlKGtleSkgewogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBhbHJlYWR5IGluIHByb2dyZXNzJykKCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UodGhpcy5fZW5xdWV1ZVByb21pc2UpCgogICAgdGhpcy5fb3BlcmF0aW9ucy5wdXNoKG5ldyBSb2Nrc0RCRGVsZXRlKHRoaXMuX2VuY29kZUtleShrZXkpLCB0aGlzLl9kYi5fY29sdW1uRmFtaWx5KSkKCiAgICB0aGlzLl9yZXNpemUoKQoKICAgIHJldHVybiBwcm9taXNlCiAgfQoKICB0cnlEZWxldGUoa2V5KSB7CiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGFscmVhZHkgaW4gcHJvZ3Jlc3MnKQoKICAgIHRoaXMuX29wZXJhdGlvbnMucHVzaChuZXcgUm9ja3NEQkRlbGV0ZSh0aGlzLl9lbmNvZGVLZXkoa2V5KSwgdGhpcy5fZGIuX2NvbHVtbkZhbWlseSkpCgogICAgdGhpcy5fcHJvbWlzZXMucHVzaChudWxsKQoKICAgIHRoaXMuX3Jlc2l6ZSgpCiAgfQoKICBkZWxldGVSYW5nZShzdGFydCwgZW5kKSB7CiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGFscmVhZHkgaW4gcHJvZ3Jlc3MnKQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSh0aGlzLl9lbnF1ZXVlUHJvbWlzZSkKCiAgICB0aGlzLl9vcGVyYXRpb25zLnB1c2goCiAgICAgIG5ldyBSb2Nrc0RCRGVsZXRlUmFuZ2UodGhpcy5fZW5jb2RlS2V5KHN0YXJ0KSwgdGhpcy5fZW5jb2RlS2V5KGVuZCksIHRoaXMuX2RiLl9jb2x1bW5GYW1pbHkpCiAgICApCgogICAgdGhpcy5fcmVzaXplKCkKCiAgICByZXR1cm4gcHJvbWlzZQogIH0KCiAgdHJ5RGVsZXRlUmFuZ2Uoc3RhcnQsIGVuZCkgewogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBhbHJlYWR5IGluIHByb2dyZXNzJykKCiAgICB0aGlzLl9vcGVyYXRpb25zLnB1c2goCiAgICAgIG5ldyBSb2Nrc0RCRGVsZXRlUmFuZ2UodGhpcy5fZW5jb2RlS2V5KHN0YXJ0KSwgdGhpcy5fZW5jb2RlS2V5KGVuZCksIHRoaXMuX2RiLl9jb2x1bW5GYW1pbHkpCiAgICApCgogICAgdGhpcy5fcHJvbWlzZXMucHVzaChudWxsKQoKICAgIHRoaXMuX3Jlc2l6ZSgpCiAgfQp9CgpjbGFzcyBSb2Nrc0RCR2V0IHsKICBjb25zdHJ1Y3RvcihrZXksIGNvbHVtbkZhbWlseSkgewogICAgdGhpcy5rZXkgPSBrZXkKICAgIHRoaXMuY29sdW1uRmFtaWx5ID0gY29sdW1uRmFtaWx5Ll9oYW5kbGUKICB9CgogIGdldCB0eXBlKCkgewogICAgcmV0dXJuIGJpbmRpbmcuR0VUCiAgfQp9CgpjbGFzcyBSb2Nrc0RCUHV0IHsKICBjb25zdHJ1Y3RvcihrZXksIHZhbHVlLCBjb2x1bW5GYW1pbHkpIHsKICAgIHRoaXMua2V5ID0ga2V5CiAgICB0aGlzLnZhbHVlID0gdmFsdWUKICAgIHRoaXMuY29sdW1uRmFtaWx5ID0gY29sdW1uRmFtaWx5Ll9oYW5kbGUKICB9CgogIGdldCB0eXBlKCkgewogICAgcmV0dXJuIGJpbmRpbmcuUFVUCiAgfQp9CgpjbGFzcyBSb2Nrc0RCRGVsZXRlIHsKICBjb25zdHJ1Y3RvcihrZXksIGNvbHVtbkZhbWlseSkgewogICAgdGhpcy5rZXkgPSBrZXkKICAgIHRoaXMuY29sdW1uRmFtaWx5ID0gY29sdW1uRmFtaWx5Ll9oYW5kbGUKICB9CgogIGdldCB0eXBlKCkgewogICAgcmV0dXJuIGJpbmRpbmcuREVMRVRFCiAgfQp9CgpjbGFzcyBSb2Nrc0RCRGVsZXRlUmFuZ2UgewogIGNvbnN0cnVjdG9yKHN0YXJ0LCBlbmQsIGNvbHVtbkZhbWlseSkgewogICAgdGhpcy5zdGFydCA9IHN0YXJ0CiAgICB0aGlzLmVuZCA9IGVuZAogICAgdGhpcy5jb2x1bW5GYW1pbHkgPSBjb2x1bW5GYW1pbHkuX2hhbmRsZQogIH0KCiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gYmluZGluZy5ERUxFVEVfUkFOR0UKICB9Cn0KY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQpjb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCmNvbnN0IHsgQmxvb21GaWx0ZXJQb2xpY3kgfSA9IHJlcXVpcmUoJy4vZmlsdGVyLXBvbGljeScpCgpjbGFzcyBSb2Nrc0RCQ29sdW1uRmFtaWx5IHsKICBjb25zdHJ1Y3RvcihuYW1lLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsKICAgICAgLy8gQmxvYiBvcHRpb25zCiAgICAgIGVuYWJsZUJsb2JGaWxlcyA9IGZhbHNlLAogICAgICBtaW5CbG9iU2l6ZSA9IDAsCiAgICAgIGJsb2JGaWxlU2l6ZSA9IDAsCiAgICAgIGVuYWJsZUJsb2JHYXJiYWdlQ29sbGVjdGlvbiA9IHRydWUsCiAgICAgIC8vIEJsb2NrIHRhYmxlIG9wdGlvbnMKICAgICAgdGFibGVCbG9ja1NpemUgPSA4MTkyLAogICAgICB0YWJsZUNhY2hlSW5kZXhBbmRGaWx0ZXJCbG9ja3MgPSB0cnVlLAogICAgICB0YWJsZUZvcm1hdFZlcnNpb24gPSA2LAogICAgICBvcHRpbWl6ZUZpbHRlcnNGb3JNZW1vcnkgPSBmYWxzZSwKICAgICAgYmxvY2tDYWNoZSA9IHRydWUsCiAgICAgIGZpbHRlclBvbGljeSA9IG5ldyBCbG9vbUZpbHRlclBvbGljeSgxMCksCiAgICAgIHRvcExldmVsSW5kZXhQaW5uaW5nVGllciA9IGNvbnN0YW50cy5waW5uaW5nVGllci5BTEwsCiAgICAgIHBhcnRpdGlvblBpbm5pbmdUaWVyID0gY29uc3RhbnRzLnBpbm5pbmdUaWVyLkFMTCwKICAgICAgdW5wYXJ0aXRpb25lZFBpbm5pbmdUaWVyID0gY29uc3RhbnRzLnBpbm5pbmdUaWVyLkFMTCwKICAgICAgb3B0aW1pemVGaWx0ZXJzRm9ySGl0cyA9IGZhbHNlLAogICAgICBudW1MZXZlbHMgPSA3LAogICAgICBtYXhXcml0ZUJ1ZmZlck51bWJlciA9IDIKICAgIH0gPSBvcHRzCgogICAgdGhpcy5fbmFtZSA9IG5hbWUKICAgIHRoaXMuX2ZsdXNoaW5nID0gbnVsbAogICAgdGhpcy5fb3B0aW9ucyA9IHsKICAgICAgZW5hYmxlQmxvYkZpbGVzLAogICAgICBtaW5CbG9iU2l6ZSwKICAgICAgYmxvYkZpbGVTaXplLAogICAgICBlbmFibGVCbG9iR2FyYmFnZUNvbGxlY3Rpb24sCiAgICAgIHRhYmxlQmxvY2tTaXplLAogICAgICB0YWJsZUNhY2hlSW5kZXhBbmRGaWx0ZXJCbG9ja3MsCiAgICAgIHRhYmxlRm9ybWF0VmVyc2lvbiwKICAgICAgb3B0aW1pemVGaWx0ZXJzRm9yTWVtb3J5LAogICAgICBibG9ja0NhY2hlLAogICAgICBmaWx0ZXJQb2xpY3ksCiAgICAgIHRvcExldmVsSW5kZXhQaW5uaW5nVGllciwKICAgICAgcGFydGl0aW9uUGlubmluZ1RpZXIsCiAgICAgIHVucGFydGl0aW9uZWRQaW5uaW5nVGllciwKICAgICAgb3B0aW1pemVGaWx0ZXJzRm9ySGl0cywKICAgICAgbnVtTGV2ZWxzLAogICAgICBtYXhXcml0ZUJ1ZmZlck51bWJlcgogICAgfQoKICAgIGNvbnN0IGZpbHRlclBvbGljeUFyZ3VtZW50cyA9IFswLCAwLCAwXQoKICAgIGlmIChmaWx0ZXJQb2xpY3kgIT09IG51bGwpIHsKICAgICAgZmlsdGVyUG9saWN5QXJndW1lbnRzWzBdID0gZmlsdGVyUG9saWN5LnR5cGUKCiAgICAgIHN3aXRjaCAoZmlsdGVyUG9saWN5LnR5cGUpIHsKICAgICAgICBjYXNlIDE6IC8vIEJsb29tIGZpbHRlciBwb2xpY3kKICAgICAgICAgIGZpbHRlclBvbGljeUFyZ3VtZW50c1sxXSA9IGZpbHRlclBvbGljeS5iaXRzUGVyS2V5CiAgICAgICAgICBicmVhawogICAgICAgIGNhc2UgMjogLy8gUmliYm9uIGZpbHRlciBwb2xpY3kKICAgICAgICAgIGZpbHRlclBvbGljeUFyZ3VtZW50c1sxXSA9IGZpbHRlclBvbGljeS5ibG9vbUVxdWl2YWxlbnRCaXRzUGVyS2V5CiAgICAgICAgICBmaWx0ZXJQb2xpY3lBcmd1bWVudHNbMl0gPSBmaWx0ZXJQb2xpY3kuYmxvb21CZWZvcmVMZXZlbAoKICAgICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLmNvbHVtbkZhbWlseUluaXQoCiAgICAgIG5hbWUsCiAgICAgIGVuYWJsZUJsb2JGaWxlcywKICAgICAgbWluQmxvYlNpemUsCiAgICAgIGJsb2JGaWxlU2l6ZSwKICAgICAgZW5hYmxlQmxvYkdhcmJhZ2VDb2xsZWN0aW9uLAogICAgICB0YWJsZUJsb2NrU2l6ZSwKICAgICAgdGFibGVDYWNoZUluZGV4QW5kRmlsdGVyQmxvY2tzLAogICAgICB0YWJsZUZvcm1hdFZlcnNpb24sCiAgICAgIG9wdGltaXplRmlsdGVyc0Zvck1lbW9yeSwKICAgICAgYmxvY2tDYWNoZSA9PT0gZmFsc2UsCiAgICAgIC4uLmZpbHRlclBvbGljeUFyZ3VtZW50cywKICAgICAgdG9wTGV2ZWxJbmRleFBpbm5pbmdUaWVyLAogICAgICBwYXJ0aXRpb25QaW5uaW5nVGllciwKICAgICAgdW5wYXJ0aXRpb25lZFBpbm5pbmdUaWVyLAogICAgICBvcHRpbWl6ZUZpbHRlcnNGb3JIaXRzLAogICAgICBudW1MZXZlbHMsCiAgICAgIG1heFdyaXRlQnVmZmVyTnVtYmVyCiAgICApCiAgfQoKICBjbG9uZVNldHRpbmdzKG5hbWUpIHsKICAgIHJldHVybiBuZXcgUm9ja3NEQkNvbHVtbkZhbWlseShuYW1lLCB0aGlzLl9vcHRpb25zKQogIH0KCiAgZ2V0IG5hbWUoKSB7CiAgICByZXR1cm4gdGhpcy5fbmFtZQogIH0KCiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLl9oYW5kbGUgPT09IG51bGwpIHJldHVybgoKICAgIGJpbmRpbmcuY29sdW1uRmFtaWx5RGVzdHJveSh0aGlzLl9oYW5kbGUpCgogICAgdGhpcy5faGFuZGxlID0gbnVsbAogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBSb2Nrc0RCQ29sdW1uRmFtaWx5Cm1vZHVsZS5leHBvcnRzID0gewogIHBpbm5pbmdUaWVyOiB7CiAgICBOT05FOiAwLAogICAgRkxVU0hFRF9BTkRfU0lNSUxBUjogMSwKICAgIEFMTDogMgogIH0KfQpleHBvcnRzLkJsb29tRmlsdGVyUG9saWN5ID0gY2xhc3MgUm9ja3NEQkJsb29tRmlsdGVyUG9saWN5IHsKICBnZXQgdHlwZSgpIHsKICAgIHJldHVybiAxCiAgfQoKICBjb25zdHJ1Y3RvcihiaXRzUGVyS2V5KSB7CiAgICB0aGlzLmJpdHNQZXJLZXkgPSBiaXRzUGVyS2V5CiAgfQp9CgpleHBvcnRzLlJpYmJvbkZpbHRlclBvbGljeSA9IGNsYXNzIFJvY2tzREJSaWJib25GaWx0ZXJQb2xpY3kgewogIGdldCB0eXBlKCkgewogICAgcmV0dXJuIDIKICB9CgogIGNvbnN0cnVjdG9yKGJsb29tRXF1aXZhbGVudEJpdHNQZXJLZXksIGJsb29tQmVmb3JlTGV2ZWwgPSAwKSB7CiAgICB0aGlzLmJsb29tRXF1aXZhbGVudEJpdHNQZXJLZXkgPSBibG9vbUVxdWl2YWxlbnRCaXRzUGVyS2V5CiAgICB0aGlzLmJsb29tQmVmb3JlTGV2ZWwgPSBibG9vbUJlZm9yZUxldmVsCiAgfQp9CmNvbnN0IHsgUmVhZGFibGUgfSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKCmNvbnN0IGVtcHR5ID0gQnVmZmVyLmFsbG9jKDApCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJvY2tzREJJdGVyYXRvciBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3RvcihkYiwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7CiAgICAgIGd0ID0gbnVsbCwKICAgICAgZ3RlID0gbnVsbCwKICAgICAgbHQgPSBudWxsLAogICAgICBsdGUgPSBudWxsLAogICAgICByZXZlcnNlID0gZmFsc2UsCiAgICAgIHZhbHVlcyA9IHRydWUsCiAgICAgIGxpbWl0ID0gSW5maW5pdHksCiAgICAgIGNhcGFjaXR5ID0gOAogICAgfSA9IG9wdHMKCiAgICBzdXBlcigpCgogICAgZGIuX3JlZigpCgogICAgdGhpcy5fZGIgPSBkYgoKICAgIHRoaXMuX2d0ID0gZ3QgPyB0aGlzLl9lbmNvZGVLZXkoZ3QpIDogZW1wdHkKICAgIHRoaXMuX2d0ZSA9IGd0ZSA/IHRoaXMuX2VuY29kZUtleShndGUpIDogZW1wdHkKICAgIHRoaXMuX2x0ID0gbHQgPyB0aGlzLl9lbmNvZGVLZXkobHQpIDogZW1wdHkKICAgIHRoaXMuX2x0ZSA9IGx0ZSA/IHRoaXMuX2VuY29kZUtleShsdGUpIDogZW1wdHkKCiAgICB0aGlzLl9yZXZlcnNlID0gcmV2ZXJzZQogICAgdGhpcy5fdmFsdWVzID0gdmFsdWVzCiAgICB0aGlzLl9saW1pdCA9IGxpbWl0IDwgMCA/IEluZmluaXR5IDogbGltaXQKICAgIHRoaXMuX2NhcGFjaXR5ID0gY2FwYWNpdHkKICAgIHRoaXMuX29wZW5lZCA9IGZhbHNlCgogICAgdGhpcy5fcGVuZGluZ09wZW4gPSBudWxsCiAgICB0aGlzLl9wZW5kaW5nUmVhZCA9IG51bGwKICAgIHRoaXMuX3BlbmRpbmdEZXN0cm95ID0gbnVsbAoKICAgIHRoaXMuX2J1ZmZlciA9IG51bGwKICAgIHRoaXMuX2hhbmRsZSA9IG51bGwKCiAgICBpZiAodGhpcy5fZGIuX3N0YXRlLm9wZW5lZCA9PT0gdHJ1ZSkgdGhpcy5yZWFkeSgpCiAgfQoKICBfb25vcGVuKGVycikgewogICAgY29uc3QgY2IgPSB0aGlzLl9wZW5kaW5nT3BlbgogICAgdGhpcy5fcGVuZGluZ09wZW4gPSBudWxsCiAgICB0aGlzLl9vcGVuZWQgPSB0cnVlCiAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKICAgIGNiKGVycikKICB9CgogIF9vbnJlYWQoZXJyLCBrZXlzLCB2YWx1ZXMpIHsKICAgIGNvbnN0IGNiID0gdGhpcy5fcGVuZGluZ1JlYWQKICAgIHRoaXMuX3BlbmRpbmdSZWFkID0gbnVsbAogICAgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCiAgICBpZiAoZXJyKSByZXR1cm4gY2IoZXJyKQoKICAgIGNvbnN0IG4gPSBrZXlzLmxlbmd0aAoKICAgIHRoaXMuX2xpbWl0IC09IG4KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG47IGkrKykgewogICAgICB0aGlzLnB1c2goewogICAgICAgIGtleTogdGhpcy5fZGVjb2RlS2V5KEJ1ZmZlci5mcm9tKGtleXNbaV0pKSwKICAgICAgICB2YWx1ZTogdGhpcy5fdmFsdWVzID8gdGhpcy5fZGVjb2RlVmFsdWUoQnVmZmVyLmZyb20odmFsdWVzW2ldKSkgOiBudWxsCiAgICAgIH0pCiAgICB9CgogICAgaWYgKG4gPCB0aGlzLl9jYXBhY2l0eSkgdGhpcy5wdXNoKG51bGwpCgogICAgY2IobnVsbCkKICB9CgogIF9vbmNsb3NlKGVycikgewogICAgY29uc3QgY2IgPSB0aGlzLl9wZW5kaW5nRGVzdHJveQogICAgdGhpcy5fcGVuZGluZ0Rlc3Ryb3kgPSBudWxsCiAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKICAgIHRoaXMuX2RiLl91bnJlZigpCiAgICBjYihlcnIpCiAgfQoKICBfcmVzaXplKCkgewogICAgaWYgKHRoaXMuX2hhbmRsZSAhPT0gbnVsbCkgewogICAgICB0aGlzLl9idWZmZXIgPSBiaW5kaW5nLml0ZXJhdG9yQnVmZmVyKHRoaXMuX2hhbmRsZSwgdGhpcy5fY2FwYWNpdHkpCiAgICB9CiAgfQoKICBhc3luYyByZWFkeSgpIHsKICAgIGlmICh0aGlzLl9oYW5kbGUgIT09IG51bGwpIHJldHVybgoKICAgIGlmICh0aGlzLl9kYi5fc3RhdGUub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5fZGIuX3N0YXRlLnJlYWR5KCkKCiAgICB0aGlzLl9pbml0KCkKICB9CgogIF9pbml0KCkgewogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5pdGVyYXRvckluaXQoKQogICAgdGhpcy5fYnVmZmVyID0gYmluZGluZy5pdGVyYXRvckJ1ZmZlcih0aGlzLl9oYW5kbGUsIHRoaXMuX2NhcGFjaXR5KQogIH0KCiAgYXN5bmMgX29wZW4oY2IpIHsKICAgIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5pbmMoKQoKICAgIGlmICh0aGlzLl9kYi5fc3RhdGUucmVzdW1lZCAhPT0gbnVsbCkgewogICAgICBjb25zdCByZXN1bWVkID0gYXdhaXQgdGhpcy5fZGIuX3N0YXRlLnJlc3VtZWQucHJvbWlzZQoKICAgICAgaWYgKCFyZXN1bWVkKSB7CiAgICAgICAgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCgogICAgICAgIHJldHVybiBjYihuZXcgRXJyb3IoJ1JvY2tzREIgc2Vzc2lvbiBpcyBjbG9zZWQnKSkKICAgICAgfQogICAgfQoKICAgIHRoaXMuX3BlbmRpbmdPcGVuID0gY2IKCiAgICB0cnkgewogICAgICBiaW5kaW5nLml0ZXJhdG9yT3BlbigKICAgICAgICB0aGlzLl9kYi5fc3RhdGUuX2hhbmRsZSwKICAgICAgICB0aGlzLl9oYW5kbGUsCiAgICAgICAgdGhpcy5fZGIuX2NvbHVtbkZhbWlseS5faGFuZGxlLAogICAgICAgIHRoaXMuX2d0LAogICAgICAgIHRoaXMuX2d0ZSwKICAgICAgICB0aGlzLl9sdCwKICAgICAgICB0aGlzLl9sdGUsCiAgICAgICAgdGhpcy5fcmV2ZXJzZSwKICAgICAgICAhdGhpcy5fdmFsdWVzLCAvLyBLZXlzIG9ubHkKICAgICAgICB0aGlzLl9kYi5fc25hcHNob3QgPyB0aGlzLl9kYi5fc25hcHNob3QuX2hhbmRsZSA6IHVuZGVmaW5lZCwKICAgICAgICB0aGlzLAogICAgICAgIHRoaXMuX29ub3BlbiwKICAgICAgICB0aGlzLl9vbmNsb3NlLAogICAgICAgIHRoaXMuX29ucmVhZAogICAgICApCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCgogICAgICBjYihlcnIpCiAgICB9CiAgfQoKICBhc3luYyBfcmVhZChjYikgewogICAgdGhpcy5fZGIuX3N0YXRlLmlvLmluYygpCgogICAgaWYgKHRoaXMuX2RiLl9zdGF0ZS5yZXN1bWVkICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IHJlc3VtZWQgPSBhd2FpdCB0aGlzLl9kYi5fc3RhdGUucmVzdW1lZC5wcm9taXNlCgogICAgICBpZiAoIXJlc3VtZWQpIHsKICAgICAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKCiAgICAgICAgcmV0dXJuIGNiKG5ldyBFcnJvcignUm9ja3NEQiBzZXNzaW9uIGlzIGNsb3NlZCcpKQogICAgICB9CiAgICB9CgogICAgdGhpcy5fcGVuZGluZ1JlYWQgPSBjYgoKICAgIHRyeSB7CiAgICAgIGJpbmRpbmcuaXRlcmF0b3JSZWFkKHRoaXMuX2hhbmRsZSwgTWF0aC5taW4odGhpcy5fY2FwYWNpdHksIHRoaXMuX2xpbWl0KSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKCiAgICAgIGNiKGVycikKICAgIH0KICB9CgogIGFzeW5jIF9kZXN0cm95KGNiKSB7CiAgICBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICB0aGlzLl9kYi5fc3RhdGUuaW8uaW5jKCkKCiAgICBpZiAodGhpcy5fb3BlbmVkID09PSBmYWxzZSkgewogICAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKICAgICAgdGhpcy5fZGIuX3VucmVmKCkKCiAgICAgIHJldHVybiBjYihudWxsKQogICAgfQoKICAgIHRoaXMuX3BlbmRpbmdEZXN0cm95ID0gY2IKCiAgICB0cnkgewogICAgICBiaW5kaW5nLml0ZXJhdG9yQ2xvc2UodGhpcy5faGFuZGxlKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQogICAgICB0aGlzLl9kYi5fdW5yZWYoKQoKICAgICAgY2IoZXJyKQogICAgfQogIH0KCiAgX2VuY29kZUtleShrKSB7CiAgICBpZiAodGhpcy5fZGIuX2tleUVuY29kaW5nICE9PSBudWxsKSByZXR1cm4gYy5lbmNvZGUodGhpcy5fZGIuX2tleUVuY29kaW5nLCBrKQogICAgaWYgKHR5cGVvZiBrID09PSAnc3RyaW5nJykgcmV0dXJuIEJ1ZmZlci5mcm9tKGspCiAgICByZXR1cm4gawogIH0KCiAgX2RlY29kZUtleShiKSB7CiAgICBpZiAodGhpcy5fZGIuX2tleUVuY29kaW5nICE9PSBudWxsKSByZXR1cm4gYy5kZWNvZGUodGhpcy5fZGIuX2tleUVuY29kaW5nLCBiKQogICAgcmV0dXJuIGIKICB9CgogIF9kZWNvZGVWYWx1ZShiKSB7CiAgICBpZiAodGhpcy5fZGIuX3ZhbHVlRW5jb2RpbmcgIT09IG51bGwpIHJldHVybiBjLmRlY29kZSh0aGlzLl9kYi5fdmFsdWVFbmNvZGluZywgYikKICAgIHJldHVybiBiCiAgfQp9CmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUm9ja3NEQlNuYXBzaG90IHsKICBjb25zdHJ1Y3RvcihzdGF0ZSkgewogICAgdGhpcy5fc3RhdGUgPSBzdGF0ZQoKICAgIHRoaXMuX2hhbmRsZSA9IG51bGwKICAgIHRoaXMuX3JlZnMgPSAwCgogICAgaWYgKHN0YXRlLmRlZmVyU25hcHNob3RJbml0ID09PSBmYWxzZSkgdGhpcy5faW5pdCgpCiAgfQoKICBfaW5pdCgpIHsKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcuc25hcHNob3RDcmVhdGUodGhpcy5fc3RhdGUuX2hhbmRsZSkKICB9CgogIHJlZigpIHsKICAgIHRoaXMuX3JlZnMrKwogIH0KCiAgdW5yZWYoKSB7CiAgICBpZiAoLS10aGlzLl9yZWZzID4gMCkgcmV0dXJuCgogICAgaWYgKHRoaXMuX2hhbmRsZSA9PT0gbnVsbCkgcmV0dXJuCgogICAgYmluZGluZy5zbmFwc2hvdERlc3Ryb3kodGhpcy5faGFuZGxlKQoKICAgIHRoaXMuX2hhbmRsZSA9IG51bGwKICB9Cn0KY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKY29uc3QgUmVmQ291bnRlciA9IHJlcXVpcmUoJ3JlZmNvdW50ZXInKQpjb25zdCBycnAgPSByZXF1aXJlKCdyZXNvbHZlLXJlamVjdC1wcm9taXNlJykKY29uc3QgU2lnbmFsUHJvbWlzZSA9IHJlcXVpcmUoJ3NpZ25hbC1wcm9taXNlJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCB7IFJlYWRCYXRjaCwgV3JpdGVCYXRjaCB9ID0gcmVxdWlyZSgnLi9iYXRjaCcpCmNvbnN0IENvbHVtbkZhbWlseSA9IHJlcXVpcmUoJy4vY29sdW1uLWZhbWlseScpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKCmNvbnN0IE1BWF9CQVRDSF9SRVVTRSA9IDY0CmNvbnN0IGVtcHR5ID0gQnVmZmVyLmFsbG9jKDApCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJvY2tzREJTdGF0ZSBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yKGRiLCBwYXRoLCBvcHRzKSB7CiAgICBzdXBlcigpCgogICAgY29uc3QgewogICAgICBjb2x1bW5GYW1pbHkgPSBuZXcgQ29sdW1uRmFtaWx5KCdkZWZhdWx0Jywgb3B0cyksCiAgICAgIGNvbHVtbkZhbWlsaWVzID0gW10sCiAgICAgIHJlYWRPbmx5ID0gZmFsc2UsCiAgICAgIGNyZWF0ZUlmTWlzc2luZyA9IHRydWUsCiAgICAgIGNyZWF0ZU1pc3NpbmdDb2x1bW5GYW1pbGllcyA9IHRydWUsCiAgICAgIG1heEJhY2tncm91bmRKb2JzID0gNiwKICAgICAgYnl0ZXNQZXJTeW5jID0gMTA0ODU3NiwKICAgICAgbWF4T3BlbkZpbGVzID0gLTEsCiAgICAgIHVzZURpcmVjdFJlYWRzID0gZmFsc2UsCiAgICAgIGF2b2lkVW5uZWNlc3NhcnlCbG9ja2luZ0lPID0gZmFsc2UsCiAgICAgIHNraXBTdGF0c1VwZGF0ZU9uT3BlbiA9IGZhbHNlLAogICAgICB1c2VEaXJlY3RJT0ZvckZsdXNoQW5kQ29tcGFjdGlvbiA9IGZhbHNlLAogICAgICBtYXhGaWxlT3BlbmluZ1RocmVhZHMgPSAxNiwKICAgICAgbG9jayA9IG51bGwKICAgIH0gPSBvcHRzCgogICAgdGhpcy5wYXRoID0gcGF0aAogICAgdGhpcy5kYiA9IGRiCiAgICB0aGlzLmhhbmRsZXMgPSBuZXcgUmVmQ291bnRlcigpCiAgICB0aGlzLmlvID0gbmV3IFJlZkNvdW50ZXIoKQogICAgdGhpcy5zZXNzaW9ucyA9IFtdCiAgICB0aGlzLmNvbHVtbkZhbWlsaWVzID0gW2NvbHVtbkZhbWlseV0KICAgIHRoaXMuZGVmZXJTbmFwc2hvdEluaXQgPSB0cnVlCiAgICB0aGlzLnJlc3VtZWQgPSBudWxsCgogICAgdGhpcy5fc3VzcGVuZGVkID0gZmFsc2UKICAgIHRoaXMuX3N1c3BlbmRpbmcgPSBmYWxzZQogICAgdGhpcy5fdXBkYXRpbmcgPSBmYWxzZQogICAgdGhpcy5fdXBkYXRpbmdTaWduYWwgPSBuZXcgU2lnbmFsUHJvbWlzZSgpCiAgICB0aGlzLl9jb2x1bW5zRmx1c2hlZCA9IGZhbHNlCiAgICB0aGlzLl9sb2NrID0gbG9jawogICAgdGhpcy5fcmVhZEJhdGNoZXMgPSBbXQogICAgdGhpcy5fd3JpdGVCYXRjaGVzID0gW10KCiAgICBmb3IgKGNvbnN0IGNvbHVtbkZhbWlseSBvZiBjb2x1bW5GYW1pbGllcykgewogICAgICB0aGlzLmNvbHVtbkZhbWlsaWVzLnB1c2goCiAgICAgICAgdHlwZW9mIGNvbHVtbkZhbWlseSA9PT0gJ3N0cmluZycgPyBuZXcgQ29sdW1uRmFtaWx5KGNvbHVtbkZhbWlseSwgb3B0cykgOiBjb2x1bW5GYW1pbHkKICAgICAgKQogICAgfQoKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcuaW5pdCgKICAgICAgcmVhZE9ubHksCiAgICAgIGNyZWF0ZUlmTWlzc2luZywKICAgICAgY3JlYXRlTWlzc2luZ0NvbHVtbkZhbWlsaWVzLAogICAgICBtYXhCYWNrZ3JvdW5kSm9icywKICAgICAgYnl0ZXNQZXJTeW5jLAogICAgICBtYXhPcGVuRmlsZXMsCiAgICAgIHVzZURpcmVjdFJlYWRzLAogICAgICBhdm9pZFVubmVjZXNzYXJ5QmxvY2tpbmdJTywKICAgICAgc2tpcFN0YXRzVXBkYXRlT25PcGVuLAogICAgICB1c2VEaXJlY3RJT0ZvckZsdXNoQW5kQ29tcGFjdGlvbiwKICAgICAgbWF4RmlsZU9wZW5pbmdUaHJlYWRzCiAgICApCiAgfQoKICBjcmVhdGVSZWFkQmF0Y2goZGIsIG9wdHMpIHsKICAgIGlmICh0aGlzLl9yZWFkQmF0Y2hlcy5sZW5ndGggPT09IDApIHJldHVybiBuZXcgUmVhZEJhdGNoKGRiLCBvcHRzKQogICAgY29uc3QgYmF0Y2ggPSB0aGlzLl9yZWFkQmF0Y2hlcy5wb3AoKQogICAgYmF0Y2guX3JldXNlKGRiLCBvcHRzKQogICAgcmV0dXJuIGJhdGNoCiAgfQoKICBjcmVhdGVXcml0ZUJhdGNoKGRiLCBvcHRzKSB7CiAgICBpZiAodGhpcy5fd3JpdGVCYXRjaGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG5ldyBXcml0ZUJhdGNoKGRiLCBvcHRzKQogICAgY29uc3QgYmF0Y2ggPSB0aGlzLl93cml0ZUJhdGNoZXMucG9wKCkKICAgIGJhdGNoLl9yZXVzZShkYiwgb3B0cykKICAgIHJldHVybiBiYXRjaAogIH0KCiAgZnJlZUJhdGNoKGJhdGNoLCB3cml0YWJsZSkgewogICAgaWYgKGJhdGNoLl9jYXBhY2l0eSA+IDE2KSByZXR1cm4KICAgIGNvbnN0IHF1ZXVlID0gd3JpdGFibGUgPyB0aGlzLl93cml0ZUJhdGNoZXMgOiB0aGlzLl9yZWFkQmF0Y2hlcwogICAgaWYgKHF1ZXVlLmxlbmd0aCA+PSBNQVhfQkFUQ0hfUkVVU0UpIHJldHVybgogICAgcXVldWUucHVzaChiYXRjaCkKICB9CgogIGFkZFNlc3Npb24oZGIpIHsKICAgIGRiLl9pbmRleCA9IHRoaXMuc2Vzc2lvbnMucHVzaChkYikgLSAxCiAgICBpZiAoZGIuX3NuYXBzaG90KSBkYi5fc25hcHNob3QucmVmKCkKICB9CgogIHJlbW92ZVNlc3Npb24oZGIpIHsKICAgIGNvbnN0IGhlYWQgPSB0aGlzLnNlc3Npb25zLnBvcCgpCiAgICBpZiAoaGVhZCAhPT0gZGIpIHRoaXMuc2Vzc2lvbnNbKGhlYWQuX2luZGV4ID0gZGIuX2luZGV4KV0gPSBoZWFkCiAgICBkYi5faW5kZXggPSAtMQogICAgaWYgKGRiLl9zbmFwc2hvdCkgZGIuX3NuYXBzaG90LnVucmVmKCkKICB9CgogIHVwc2VydENvbHVtbkZhbWlseShjKSB7CiAgICBpZiAodHlwZW9mIGMgPT09ICdzdHJpbmcnKSB7CiAgICAgIGxldCBjb2wgPSB0aGlzLmdldENvbHVtbkZhbWlseUJ5TmFtZShjKQogICAgICBpZiAoY29sKSByZXR1cm4gY29sCiAgICAgIGNvbCA9IHRoaXMuY29sdW1uRmFtaWxpZXNbMF0uY2xvbmVTZXR0aW5ncyhjKQogICAgICB0aGlzLmNvbHVtbkZhbWlsaWVzLnB1c2goY29sKQogICAgICByZXR1cm4gY29sCiAgICB9CgogICAgaWYgKHRoaXMuY29sdW1uRmFtaWxpZXMuaW5jbHVkZXMoYykpIHJldHVybiBjCiAgICB0aGlzLmNvbHVtbkZhbWlsaWVzLnB1c2goYykKICAgIHJldHVybiBjCiAgfQoKICBnZXRDb2x1bW5GYW1pbHkoYykgewogICAgaWYgKCFjKSByZXR1cm4gdGhpcy5jb2x1bW5GYW1pbGllc1swXQogICAgaWYgKCF0aGlzLl9jb2x1bW5zRmx1c2hlZCkgcmV0dXJuIHRoaXMudXBzZXJ0Q29sdW1uRmFtaWx5KGMpCgogICAgaWYgKHR5cGVvZiBjICE9PSAnc3RyaW5nJykgcmV0dXJuIGMKCiAgICBjb25zdCBjb2wgPSB0aGlzLmdldENvbHVtbkZhbWlseUJ5TmFtZShjKQogICAgaWYgKGNvbCA9PT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGNvbHVtbiBmYW1pbHknKQogICAgcmV0dXJuIGNvbAogIH0KCiAgZ2V0Q29sdW1uRmFtaWx5QnlOYW1lKG5hbWUpIHsKICAgIGZvciAoY29uc3QgY29sIG9mIHRoaXMuY29sdW1uRmFtaWxpZXMpIHsKICAgICAgaWYgKGNvbC5uYW1lID09PSBuYW1lKSByZXR1cm4gY29sCiAgICB9CiAgICByZXR1cm4gbnVsbAogIH0KCiAgYXN5bmMgX29wZW4oKSB7CiAgICBhd2FpdCBQcm9taXNlLnJlc29sdmUoKSAvLyBBbGxvdyBjb2x1bW4gZmFtaWxpZXMgdG8gcG9wdWxhdGUgaWYgb24tZGVtYW5kCgogICAgaWYgKHRoaXMuX2xvY2spIGF3YWl0IHRoaXMuX2xvY2sucmVhZHkoKQoKICAgIGNvbnN0IHJlcSA9IHsgcmVzb2x2ZTogbnVsbCwgcmVqZWN0OiBudWxsLCBoYW5kbGU6IG51bGwgfQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIHRoaXMuX2NvbHVtbnNGbHVzaGVkID0gdHJ1ZQoKICAgIGNvbnN0IGxvY2sgPSB0aGlzLl9sb2NrID09PSBudWxsID8gLTEgOiB0aGlzLl9sb2NrLnRyYW5zZmVyKCkKCiAgICByZXEuaGFuZGxlID0gYmluZGluZy5vcGVuKAogICAgICB0aGlzLl9oYW5kbGUsCiAgICAgIHRoaXMsCiAgICAgIHRoaXMucGF0aCwKICAgICAgdGhpcy5jb2x1bW5GYW1pbGllcy5tYXAoKGMpID0+IGMuX2hhbmRsZSksCiAgICAgIGxvY2ssCiAgICAgIHJlcSwKICAgICAgb25vcGVuCiAgICApCgogICAgYXdhaXQgcHJvbWlzZQoKICAgIHRoaXMuZGVmZXJTbmFwc2hvdEluaXQgPSBmYWxzZQoKICAgIGZvciAoY29uc3Qgc2Vzc2lvbiBvZiB0aGlzLnNlc3Npb25zKSB7CiAgICAgIGlmIChzZXNzaW9uLl9zbmFwc2hvdCkgc2Vzc2lvbi5fc25hcHNob3QuX2luaXQoKQogICAgfQoKICAgIGZ1bmN0aW9uIG9ub3BlbihlcnIpIHsKICAgICAgaWYgKGVycikgcmVxLnJlamVjdChuZXcgRXJyb3IoZXJyKSkKICAgICAgZWxzZSByZXEucmVzb2x2ZSgpCiAgICB9CiAgfQoKICBhc3luYyBfY2xvc2UoKSB7CiAgICB3aGlsZSAodGhpcy5fdXBkYXRpbmcpIGF3YWl0IHRoaXMuX3VwZGF0aW5nU2lnbmFsLndhaXQoKQogICAgaWYgKHRoaXMucmVzdW1lZCkgdGhpcy5yZXN1bWVkLnJlc29sdmUoZmFsc2UpCgogICAgd2hpbGUgKCF0aGlzLmlvLmlzSWRsZSgpKSBhd2FpdCB0aGlzLmlvLmlkbGUoKQogICAgd2hpbGUgKCF0aGlzLmhhbmRsZXMuaXNJZGxlKCkpIGF3YWl0IHRoaXMuaGFuZGxlcy5pZGxlKCkKCiAgICB3aGlsZSAodGhpcy5zZXNzaW9ucy5sZW5ndGggPiAwKSB7CiAgICAgIGF3YWl0IHRoaXMuc2Vzc2lvbnNbdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxXS5jbG9zZSgpCiAgICB9CgogICAgZm9yIChjb25zdCBjb2x1bW5GYW1pbHkgb2YgdGhpcy5jb2x1bW5GYW1pbGllcykgY29sdW1uRmFtaWx5LmRlc3Ryb3koKQoKICAgIGNvbnN0IHJlcSA9IHsgcmVzb2x2ZTogbnVsbCwgcmVqZWN0OiBudWxsLCBoYW5kbGU6IG51bGwgfQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLmNsb3NlKHRoaXMuX2hhbmRsZSwgcmVxLCBvbmNsb3NlKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHByb21pc2UKICAgIH0gZmluYWxseSB7CiAgICAgIGlmICh0aGlzLl9sb2NrKSBhd2FpdCB0aGlzLl9sb2NrLmNsb3NlKCkKICAgIH0KCiAgICBmdW5jdGlvbiBvbmNsb3NlKGVycikgewogICAgICBpZiAoZXJyKSByZXEucmVqZWN0KG5ldyBFcnJvcihlcnIpKQogICAgICBlbHNlIHJlcS5yZXNvbHZlKCkKICAgIH0KICB9CgogIGFzeW5jIGZsdXNoKGRiLCBvcHRzKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICB0aGlzLmlvLmluYygpCgogICAgaWYgKHRoaXMucmVzdW1lZCAhPT0gbnVsbCkgewogICAgICBjb25zdCByZXN1bWVkID0gYXdhaXQgdGhpcy5yZXN1bWVkLnByb21pc2UKCiAgICAgIGlmICghcmVzdW1lZCkgewogICAgICAgIHRoaXMuaW8uZGVjKCkKCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSb2Nrc0RCIHNlc3Npb24gaXMgY2xvc2VkJykKICAgICAgfQogICAgfQoKICAgIGNvbnN0IHJlcSA9IHsgcmVzb2x2ZTogbnVsbCwgcmVqZWN0OiBudWxsLCBoYW5kbGU6IG51bGwgfQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIHRyeSB7CiAgICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLmZsdXNoKHRoaXMuX2hhbmRsZSwgZGIuX2NvbHVtbkZhbWlseS5faGFuZGxlLCByZXEsIG9uZmx1c2gpCgogICAgICBhd2FpdCBwcm9taXNlCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLmlvLmRlYygpCiAgICB9CgogICAgZnVuY3Rpb24gb25mbHVzaChlcnIpIHsKICAgICAgaWYgKGVycikgcmVxLnJlamVjdChuZXcgRXJyb3IoZXJyKSkKICAgICAgZWxzZSByZXEucmVzb2x2ZSgpCiAgICB9CiAgfQoKICBzdXNwZW5kKCkgewogICAgdGhpcy5fc3VzcGVuZGluZyA9IHRydWUKICAgIHJldHVybiB0aGlzLnVwZGF0ZSgpCiAgfQoKICByZXN1bWUoKSB7CiAgICB0aGlzLl9zdXNwZW5kaW5nID0gZmFsc2UKICAgIHJldHVybiB0aGlzLnVwZGF0ZSgpCiAgfQoKICBhc3luYyB1cGRhdGUoKSB7CiAgICB3aGlsZSAodGhpcy5fdXBkYXRpbmcpIGF3YWl0IHRoaXMuX3VwZGF0aW5nU2lnbmFsLndhaXQoKQogICAgaWYgKHRoaXMuX3N1c3BlbmRpbmcgPT09IHRoaXMuX3N1c3BlbmRlZCB8fCB0aGlzLmNsb3NpbmcpIHJldHVybgogICAgdGhpcy5fdXBkYXRpbmcgPSB0cnVlCiAgICB0cnkgewogICAgICBpZiAodGhpcy5fc3VzcGVuZGluZykgYXdhaXQgdGhpcy5fc3VzcGVuZCgpCiAgICAgIGVsc2UgYXdhaXQgdGhpcy5fcmVzdW1lKCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX3VwZGF0aW5nID0gZmFsc2UKICAgICAgdGhpcy5fdXBkYXRpbmdTaWduYWwubm90aWZ5KCkKICAgIH0KICB9CgogIGFzeW5jIF9zdXNwZW5kKCkgewogICAgaWYgKHRoaXMuX3N1c3BlbmRlZCA9PT0gdHJ1ZSkgcmV0dXJuCgogICAgd2hpbGUgKCF0aGlzLmlvLmlzSWRsZSgpKSBhd2FpdCB0aGlzLmlvLmlkbGUoKQoKICAgIHRoaXMuaW8uaW5jKCkKICAgIHRoaXMucmVzdW1lZCA9IHJycCgpCgogICAgY29uc3QgcmVxID0geyByZXNvbHZlOiBudWxsLCByZWplY3Q6IG51bGwsIGhhbmRsZTogbnVsbCB9CgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICAgIHJlcS5yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgdHJ5IHsKICAgICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcuc3VzcGVuZCh0aGlzLl9oYW5kbGUsIHJlcSwgb25zdXNwZW5kKQoKICAgICAgYXdhaXQgcHJvbWlzZQoKICAgICAgdGhpcy5fc3VzcGVuZGVkID0gdHJ1ZQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5pby5kZWMoKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uc3VzcGVuZChlcnIpIHsKICAgICAgaWYgKGVycikgcmVxLnJlamVjdChuZXcgRXJyb3IoZXJyKSkKICAgICAgZWxzZSByZXEucmVzb2x2ZSgpCiAgICB9CiAgfQoKICBhc3luYyBfcmVzdW1lKCkgewogICAgaWYgKHRoaXMuX3N1c3BlbmRlZCA9PT0gZmFsc2UpIHJldHVybgoKICAgIGNvbnN0IHJlcSA9IHsgcmVzb2x2ZTogbnVsbCwgcmVqZWN0OiBudWxsLCBoYW5kbGU6IG51bGwgfQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLnJlc3VtZSh0aGlzLl9oYW5kbGUsIHJlcSwgb25yZXN1bWUpCgogICAgYXdhaXQgcHJvbWlzZQoKICAgIHRoaXMuX3N1c3BlbmRlZCA9IGZhbHNlCgogICAgY29uc3QgcmVzdW1lZCA9IHRoaXMucmVzdW1lZAogICAgdGhpcy5yZXN1bWVkID0gbnVsbAogICAgcmVzdW1lZC5yZXNvbHZlKHRydWUpCgogICAgZnVuY3Rpb24gb25yZXN1bWUoZXJyKSB7CiAgICAgIGlmIChlcnIpIHJlcS5yZWplY3QobmV3IEVycm9yKGVycikpCiAgICAgIGVsc2UgcmVxLnJlc29sdmUoKQogICAgfQogIH0KCiAgYXN5bmMgY29tcGFjdFJhbmdlKGRiLCBzdGFydCwgZW5kLCBvcHRzKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICB0aGlzLmlvLmluYygpCgogICAgY29uc3QgeyBleGNsdXNpdmUgPSBmYWxzZSB9ID0gb3B0cwoKICAgIHN0YXJ0ID0gdGhpcy5fZW5jb2RlS2V5KHN0YXJ0KQogICAgZW5kID0gdGhpcy5fZW5jb2RlS2V5KGVuZCkKCiAgICBjb25zdCByZXEgPSB7IHJlc29sdmU6IG51bGwsIHJlamVjdDogbnVsbCwgaGFuZGxlOiBudWxsLCBzdGFydCwgZW5kIH0KCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgICAgcmVxLnJlamVjdCA9IHJlamVjdAogICAgfSkKCiAgICB0cnkgewogICAgICByZXEuaGFuZGxlID0gYmluZGluZy5jb21wYWN0UmFuZ2UoCiAgICAgICAgdGhpcy5faGFuZGxlLAogICAgICAgIGRiLl9jb2x1bW5GYW1pbHkuX2hhbmRsZSwKICAgICAgICBzdGFydCwKICAgICAgICBlbmQsCiAgICAgICAgZXhjbHVzaXZlLAogICAgICAgIHJlcSwKICAgICAgICBvbmNvbXBhY3RyYW5nZQogICAgICApCgogICAgICBhd2FpdCBwcm9taXNlCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLmlvLmRlYygpCiAgICB9CgogICAgZnVuY3Rpb24gb25jb21wYWN0cmFuZ2UoZXJyKSB7CiAgICAgIGlmIChlcnIpIHJlcS5yZWplY3QobmV3IEVycm9yKGVycikpCiAgICAgIGVsc2UgcmVxLnJlc29sdmUoKQogICAgfQogIH0KCiAgYXN5bmMgYXBwcm94aW1hdGVTaXplKGRiLCBzdGFydCwgZW5kLCBvcHRzKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICB0aGlzLmlvLmluYygpCgogICAgY29uc3QgeyBpbmNsdWRlTWVtdGFibGVzID0gZmFsc2UsIGluY2x1ZGVGaWxlcyA9IHRydWUsIGZpbGVzU2l6ZUVycm9yTWFyZ2luID0gLTEgfSA9IG9wdHMKCiAgICBzdGFydCA9IHRoaXMuX2VuY29kZUtleShzdGFydCkKICAgIGVuZCA9IHRoaXMuX2VuY29kZUtleShlbmQpCgogICAgY29uc3QgcmVxID0geyByZXNvbHZlOiBudWxsLCByZWplY3Q6IG51bGwsIGhhbmRsZTogbnVsbCwgc3RhcnQsIGVuZCB9CgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICAgIHJlcS5yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgdHJ5IHsKICAgICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcuYXBwcm94aW1hdGVTaXplKAogICAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgICBkYi5fY29sdW1uRmFtaWx5Ll9oYW5kbGUsCiAgICAgICAgc3RhcnQsCiAgICAgICAgZW5kLAogICAgICAgIGluY2x1ZGVNZW10YWJsZXMsCiAgICAgICAgaW5jbHVkZUZpbGVzLAogICAgICAgIGZpbGVzU2l6ZUVycm9yTWFyZ2luLAogICAgICAgIHJlcSwKICAgICAgICBvbmFwcHJveGltYXRlc2l6ZQogICAgICApCgogICAgICByZXR1cm4gYXdhaXQgcHJvbWlzZQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5pby5kZWMoKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uYXBwcm94aW1hdGVzaXplKGVyciwgcmVzdWx0KSB7CiAgICAgIGlmIChlcnIpIHJlcS5yZWplY3QobmV3IEVycm9yKGVycikpCiAgICAgIGVsc2UgcmVxLnJlc29sdmUocmVzdWx0KQogICAgfQogIH0KCiAgX2VuY29kZUtleShrKSB7CiAgICBpZiAodGhpcy5kYi5fa2V5RW5jb2RpbmcpIHJldHVybiBjLmVuY29kZSh0aGlzLmRiLl9rZXlFbmNvZGluZywgaykKICAgIGlmICh0eXBlb2YgayA9PT0gJ3N0cmluZycpIHJldHVybiBCdWZmZXIuZnJvbShrKQogICAgaWYgKGsgPT09IG51bGwpIHJldHVybiBlbXB0eQogICAgcmV0dXJuIGsKICB9Cn0KewogICJuYW1lIjogInJvY2tzZGItbmF0aXZlIiwKICAidmVyc2lvbiI6ICIzLjExLjQiLAogICJkZXNjcmlwdGlvbiI6ICJsaWJyb2Nrc2RiIGJpbmRpbmdzIGZvciBKYXZhU2NyaXB0IiwKICAiZXhwb3J0cyI6IHsKICAgICIuIjogIi4vaW5kZXguanMiLAogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIKICB9LAogICJpbXBvcnRzIjogewogICAgImZzIjogImJhcmUtZnMiLAogICAgImRlZmF1bHQiOiAiZnMiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImJpbmRpbmcuY2MiLAogICAgImJpbmRpbmcuanMiLAogICAgIkNNYWtlTGlzdHMudHh0IiwKICAgICJsaWIiLAogICAgInByZWJ1aWxkcyIsCiAgICAiIXByZWJ1aWxkcy9hbmRyb2lkLSovKiovKi5ub2RlIgogIF0sCiAgImFkZG9uIjogdHJ1ZSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIiwKICAgICJsaW50IjogInByZXR0aWVyIC0tY2hlY2sgLiIsCiAgICAidGVzdCI6ICJucG0gcnVuIGxpbnQgJiYgbnBtIHJ1biB0ZXN0OmJhcmUgJiYgbnBtIHJ1biB0ZXN0Om5vZGUiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QuanMiLAogICAgInRlc3Q6bm9kZSI6ICJub2RlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcm9ja3NkYi1uYXRpdmUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2ggSW5jIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JvY2tzZGItbmF0aXZlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcm9ja3NkYi1uYXRpdmUiLAogICJlbmdpbmVzIjogewogICAgImJhcmUiOiAiPj0xLjE2LjAiCiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuMTUuMCIsCiAgICAicmVhZHktcmVzb3VyY2UiOiAiXjEuMC4wIiwKICAgICJyZWZjb3VudGVyIjogIl4xLjAuMCIsCiAgICAicmVxdWlyZS1hZGRvbiI6ICJeMS4wLjIiLAogICAgInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiAiXjEuMS4wIiwKICAgICJzaWduYWwtcHJvbWlzZSI6ICJeMS4wLjMiLAogICAgInN0cmVhbXgiOiAiXjIuMTYuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1jb21wYXQtbmFwaSI6ICJeMS4zLjAiLAogICAgImJhcmUtZnMiOiAiXjQuNS4wIiwKICAgICJicml0dGxlIjogIl4zLjUuMCIsCiAgICAiY21ha2UtYmFyZSI6ICJeMS4xLjE0IiwKICAgICJjbWFrZS1mZXRjaCI6ICJeMS4wLjEiLAogICAgImNtYWtlLW5hcGkiOiAiXjEuMC42IiwKICAgICJmZC1sb2NrIjogIl4yLjAuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSBzYWZldHlDYXRjaAoKZnVuY3Rpb24gaXNBY3R1YWxseVVuY2F1Z2h0IChlcnIpIHsKICBpZiAoIWVycikgcmV0dXJuIGZhbHNlCiAgcmV0dXJuIGVyciBpbnN0YW5jZW9mIFR5cGVFcnJvciB8fAogICAgZXJyIGluc3RhbmNlb2YgU3ludGF4RXJyb3IgfHwKICAgIGVyciBpbnN0YW5jZW9mIFJlZmVyZW5jZUVycm9yIHx8CiAgICBlcnIgaW5zdGFuY2VvZiBFdmFsRXJyb3IgfHwKICAgIGVyciBpbnN0YW5jZW9mIFJhbmdlRXJyb3IgfHwKICAgIGVyciBpbnN0YW5jZW9mIFVSSUVycm9yIHx8CiAgICBlcnIuY29kZSA9PT0gJ0VSUl9BU1NFUlRJT04nCn0KCmZ1bmN0aW9uIHRocm93RXJyb3JOVCAoZXJyKSB7CiAgcXVldWVNaWNyb3Rhc2soKCkgPT4geyB0aHJvdyBlcnIgfSkKfQoKZnVuY3Rpb24gc2FmZXR5Q2F0Y2ggKGVycikgewogIGlmIChpc0FjdHVhbGx5VW5jYXVnaHQoZXJyKSkgewogICAgdGhyb3dFcnJvck5UKGVycikKICAgIHRocm93IGVycgogIH0KfQp7CiAgIm5hbWUiOiAic2FmZXR5LWNhdGNoIiwKICAidmVyc2lvbiI6ICIxLjAuMiIsCiAgImRlc2NyaXB0aW9uIjogIlNtYWxsIG1vZHVsZSB0aGF0IG1ha2VzIHN1cmUgeW91ciBjYXRjaCwgY2F1Z2h0IGFuIGFjdHVhbCBlcnJvciBhbmQgbm90IGEgcHJvZ3JhbW1pbmcgbWlzdGFrZSBvciBhc3NlcnRpb24iLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHt9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zYWZldHktY2F0Y2guZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NhZmV0eS1jYXRjaC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zYWZldHktY2F0Y2giCn0KbGV0IHRtcFJlc29sdmUgPSBudWxsCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFNjb3BlTG9jayB7CiAgY29uc3RydWN0b3IgKHsgZGVib3VuY2UgPSBmYWxzZSB9ID0ge30pIHsKICAgIHRoaXMuZGVib3VuY2UgPSBkZWJvdW5jZQogICAgdGhpcy53YWl0aW5nID0gW10KICAgIHRoaXMubG9ja2VkID0gZmFsc2UKICAgIHRoaXMuc2tpcCA9IDAKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICB9CgogIGZsdXNoICgpIHsKICAgIGlmICh0aGlzLmxvY2tlZCA9PT0gZmFsc2UgJiYgdGhpcy53YWl0aW5nLmxlbmd0aCA9PT0gMCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLmRlc3Ryb3llZCA9PT0gZmFsc2UpCgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHNldFRtcFJlc29sdmUpCiAgICBjb25zdCByZXNvbHZlID0gdG1wUmVzb2x2ZQoKICAgIHRtcFJlc29sdmUgPSBudWxsCiAgICB0aGlzLndhaXRpbmcucHVzaCh7IGxvY2s6IGZhbHNlLCByZXNvbHZlIH0pCgogICAgcmV0dXJuIHByb21pc2UKICB9CgogIGRlc3Ryb3kgKCkgewogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCiAgfQoKICBsb2NrICgpIHsKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZShzZXRUbXBSZXNvbHZlKQogICAgY29uc3QgcmVzb2x2ZSA9IHRtcFJlc29sdmUKCiAgICB0bXBSZXNvbHZlID0gbnVsbAoKICAgIGlmICh0aGlzLmxvY2tlZCA9PT0gdHJ1ZSkgewogICAgICB0aGlzLndhaXRpbmcucHVzaCh7IGxvY2s6IHRydWUsIHJlc29sdmUgfSkKICAgICAgcmV0dXJuIHByb21pc2UKICAgIH0KCiAgICBpZiAodGhpcy5kZXN0cm95ZWQgPT09IHRydWUpIHsKICAgICAgcmVzb2x2ZShmYWxzZSkKICAgICAgcmV0dXJuIHByb21pc2UKICAgIH0KCiAgICB0aGlzLmxvY2tlZCA9IHRydWUKICAgIHJlc29sdmUodHJ1ZSkKCiAgICByZXR1cm4gcHJvbWlzZQogIH0KCiAgdW5sb2NrICgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCA9PT0gdHJ1ZSkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMud2FpdGluZy5sZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMud2FpdGluZ1tpXS5yZXNvbHZlKGZhbHNlKQogICAgICB9CiAgICAgIHRoaXMud2FpdGluZyA9IFtdCiAgICAgIHRoaXMuc2tpcCA9IDAKICAgICAgdGhpcy5sb2NrZWQgPSBmYWxzZQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5za2lwICE9PSAwKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5za2lwOyBpKyspIHsKICAgICAgICBjb25zdCB7IGxvY2ssIHJlc29sdmUgfSA9IHRoaXMud2FpdGluZ1tpXQogICAgICAgIHJlc29sdmUobG9jayA9PT0gZmFsc2UpCiAgICAgIH0KCiAgICAgIHRoaXMud2FpdGluZyA9IHRoaXMud2FpdGluZy5zbGljZSh0aGlzLnNraXApCiAgICAgIHRoaXMuc2tpcCA9IDAKICAgIH0KCiAgICB3aGlsZSAodGhpcy53YWl0aW5nLmxlbmd0aCA+IDAgJiYgdGhpcy53YWl0aW5nWzBdLmxvY2sgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMud2FpdGluZy5zaGlmdCgpLnJlc29sdmUodHJ1ZSkKICAgIH0KCiAgICBpZiAodGhpcy53YWl0aW5nLmxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLmxvY2tlZCA9IGZhbHNlCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IHsgcmVzb2x2ZSB9ID0gdGhpcy53YWl0aW5nLnNoaWZ0KCkKICAgIGlmICh0aGlzLmRlYm91bmNlID09PSB0cnVlKSB0aGlzLnNraXAgPSB0aGlzLndhaXRpbmcubGVuZ3RoCgogICAgcmVzb2x2ZSh0cnVlKQogIH0KfQoKZnVuY3Rpb24gc2V0VG1wUmVzb2x2ZSAocmVzb2x2ZSkgewogIHRtcFJlc29sdmUgPSByZXNvbHZlCn0KewogICJuYW1lIjogInNjb3BlLWxvY2siLAogICJ2ZXJzaW9uIjogIjEuMi40IiwKICAiZGVzY3JpcHRpb24iOiAiU29tZSBjb25jdXJyZW5jeSBzZW1hbnRpY3MgYXJvdW5kIGVudGVyaW5nIHNjb3BlcyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy43LjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4xLjIiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3Njb3BlLWxvY2suZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2ggSW5jLiIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zY29wZS1sb2NrL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc2NvcGUtbG9jayIKfQpjb25zdCBzZXQgPSByZXF1aXJlKCd1bm9yZGVyZWQtc2V0JykKCm1vZHVsZS5leHBvcnRzID0gb3B0cyA9PiBuZXcgU2h1ZmZsZWRQcmlvcml0eVF1ZXVlKG9wdHMpCgpjbGFzcyBTaHVmZmxlZFByaW9yaXR5UXVldWUgewogIGNvbnN0cnVjdG9yIChvcHRzKSB7CiAgICB0aGlzLnByaW9yaXRpZXMgPSBbXQogICAgdGhpcy5lcXVhbHMgPSAob3B0cyAmJiBvcHRzLmVxdWFscykgfHwgbnVsbAogIH0KCiAgZ2V0IGxlbmd0aCAoKSB7CiAgICByZXR1cm4gdGhpcy5wcmlvcml0aWVzLnJlZHVjZShhZGQsIDApCiAgfQoKICBbU3ltYm9sLml0ZXJhdG9yXSAoKSB7CiAgICByZXR1cm4gbmV3IEl0ZXJhdG9yKHRoaXMpCiAgfQoKICBoZWFkICgpIHsKICAgIGZvciAobGV0IGkgPSB0aGlzLnByaW9yaXRpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgcSA9IHRoaXMucHJpb3JpdGllc1tpXQogICAgICBpZiAocS5sZW5ndGgpIHJldHVybiBzaHVmZmxlKHEsIDApCiAgICB9CiAgICByZXR1cm4gbnVsbAogIH0KCiAgdGFpbCAoKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucHJpb3JpdGllcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBxID0gdGhpcy5wcmlvcml0aWVzW2ldCiAgICAgIGlmIChxLmxlbmd0aCkgcmV0dXJuIHNodWZmbGUocSwgMCkKICAgIH0KICAgIHJldHVybiBudWxsCiAgfQoKICBwcmV2IChwcmV2KSB7CiAgICBpZiAoIXByZXYpIHJldHVybiB0aGlzLnRhaWwoKQogICAgcmV0dXJuIG5leHQodGhpcy5wcmlvcml0aWVzLCBwcmV2LCAxKQogIH0KCiAgbmV4dCAocHJldikgewogICAgaWYgKCFwcmV2KSByZXR1cm4gdGhpcy5oZWFkKCkKICAgIHJldHVybiBuZXh0KHRoaXMucHJpb3JpdGllcywgcHJldiwgLTEpCiAgfQoKICBzaGlmdCAoKSB7CiAgICByZXR1cm4gdGhpcy5yZW1vdmUodGhpcy5oZWFkKCkpCiAgfQoKICBwb3AgKCkgewogICAgcmV0dXJuIHRoaXMucmVtb3ZlKHRoaXMudGFpbCgpKQogIH0KCiAgYWRkICh2YWwpIHsKICAgIGNvbnN0IHByaW8gPSB2YWwucHJpb3JpdHkgfHwgMAogICAgd2hpbGUgKHByaW8gPj0gdGhpcy5wcmlvcml0aWVzLmxlbmd0aCkgdGhpcy5wcmlvcml0aWVzLnB1c2goW10pCiAgICBzZXQuYWRkKHRoaXMucHJpb3JpdGllc1twcmlvXSwgdmFsKQogICAgcmV0dXJuIHZhbAogIH0KCiAgcmVtb3ZlICh2YWwpIHsKICAgIGlmICghdmFsKSByZXR1cm4gbnVsbAoKICAgIGlmICh2YWwuX2luZGV4ID09PSB1bmRlZmluZWQpIHsKICAgICAgdmFsID0gdGhpcy5maW5kKHZhbCkKICAgICAgaWYgKCF2YWwpIHJldHVybiBudWxsCiAgICB9CgogICAgcmV0dXJuIHNldC5yZW1vdmUodGhpcy5wcmlvcml0aWVzW3ZhbC5wcmlvcml0eSB8fCAwXSwgdmFsKQogIH0KCiAgaGFzICh2YWwpIHsKICAgIGlmICh2YWwuX2luZGV4ID09PSB1bmRlZmluZWQpIHJldHVybiB0aGlzLmZpbmQodmFsKQogICAgY29uc3QgcHJpb3JpdHkgPSB2YWwucHJpb3JpdHkgfHwgMAogICAgaWYgKHByaW9yaXR5ID49IHRoaXMucHJpb3JpdGllcy5sZW5ndGgpIHJldHVybiBmYWxzZQogICAgcmV0dXJuIHNldC5oYXModGhpcy5wcmlvcml0aWVzW3ByaW9yaXR5XSwgdmFsKQogIH0KCiAgZmluZCAodmFsKSB7CiAgICBpZiAodmFsLl9pbmRleCAhPT0gdW5kZWZpbmVkKSByZXR1cm4gdmFsCgogICAgY29uc3QgcHJpbyA9IHZhbC5wcmlvcml0eSB8fCAwCiAgICBjb25zdCBxcyA9IHRoaXMucHJpb3JpdGllcwogICAgaWYgKHByaW8gPj0gcXMubGVuZ3RoKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHEgPSBxc1twcmlvXQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcS5sZW5ndGg7IGkrKykgewogICAgICBpZiAodGhpcy5lcXVhbHMocVtpXSwgdmFsKSkgcmV0dXJuIHFbaV0KICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KfQoKY2xhc3MgSXRlcmF0b3IgewogIGNvbnN0cnVjdG9yIChxdWV1ZSkgewogICAgdGhpcy5wcmV2ID0gbnVsbAogICAgdGhpcy5xdWV1ZSA9IHF1ZXVlCiAgfQoKICBuZXh0ICgpIHsKICAgIGNvbnN0IG5leHQgPSB0aGlzLnF1ZXVlLm5leHQodGhpcy5wcmV2KQogICAgdGhpcy5wcmV2ID0gbmV4dAogICAgcmV0dXJuIHsgZG9uZTogIW5leHQsIHZhbHVlOiBuZXh0IH0KICB9Cn0KCmZ1bmN0aW9uIHNodWZmbGUgKHEsIGkpIHsKICBjb25zdCByYW4gPSBpICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKHEubGVuZ3RoIC0gaSkpCiAgc2V0LnN3YXAocSwgcVtyYW5dLCBxW2ldKQogIHJldHVybiBxW2ldCn0KCmZ1bmN0aW9uIG5leHQgKHF1ZXVlcywgcHJldiwgaW5jKSB7CiAgbGV0IGkgPSBwcmV2LnByaW9yaXR5IHx8IDAKICBsZXQgaiA9IChwcmV2Ll9pbmRleCB8fCAwKSArIDEKCiAgd2hpbGUgKHRydWUpIHsKICAgIGlmIChpIDwgMCB8fCBpID49IHF1ZXVlcy5sZW5ndGgpIHJldHVybiBudWxsCiAgICBjb25zdCBxID0gcXVldWVzW2ldCgogICAgaWYgKGogPj0gcS5sZW5ndGgpIHsKICAgICAgaSArPSBpbmMKICAgICAgaiA9IDAKICAgICAgY29udGludWUKICAgIH0KCiAgICByZXR1cm4gc2h1ZmZsZShxLCBqKQogIH0KfQoKZnVuY3Rpb24gYWRkIChsZW4sIGIpIHsKICByZXR1cm4gbGVuICsgYi5sZW5ndGgKfQp7CiAgIm5hbWUiOiAic2h1ZmZsZWQtcHJpb3JpdHktcXVldWUiLAogICJ2ZXJzaW9uIjogIjIuMS4wIiwKICAiZGVzY3JpcHRpb24iOiAiQSBwcmlvcml0eSBxdWV1ZSB0aGF0IHNodWZmbGVzIGVsZW1lbnRzIHdpdGggdGhlIHNhbWUgcHJpb3JpdHkuIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiB0YXBlIHRlc3QuanMiCiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgInVub3JkZXJlZC1zZXQiOiAiXjIuMC4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTIuMC4xIiwKICAgICJ0YXBlIjogIl40LjkuMSIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zaHVmZmxlZC1wcmlvcml0eS1xdWV1ZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc2h1ZmZsZWQtcHJpb3JpdHktcXVldWUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc2h1ZmZsZWQtcHJpb3JpdHktcXVldWUiCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBTaWduYWwgewogIGNvbnN0cnVjdG9yICgpIHsKICAgIHRoaXMuX3Jlc29sdmUgPSBudWxsCiAgICB0aGlzLl9yZWplY3QgPSBudWxsCiAgICB0aGlzLl9wcm9taXNlID0gbnVsbAogICAgdGhpcy5fYmluZCA9IGJpbmQuYmluZCh0aGlzKQogICAgdGhpcy5fb25lcnJvciA9IGNsZWFyLmJpbmQodGhpcykKICAgIHRoaXMuX29uc3VjY2VzcyA9IGNsZWFyLmJpbmQodGhpcywgbnVsbCkKICAgIHRoaXMuX3RpbWVycyA9IG5ldyBTZXQoKQogIH0KCiAgd2FpdCAobWF4KSB7CiAgICBpZiAoIXRoaXMuX3Byb21pc2UpIHsKICAgICAgdGhpcy5fcHJvbWlzZSA9IG5ldyBQcm9taXNlKHRoaXMuX2JpbmQpCiAgICAgIHRoaXMuX3Byb21pc2UudGhlbih0aGlzLl9vbnN1Y2Nlc3MpLmNhdGNoKHRoaXMuX29uZXJyb3IpCiAgICB9CiAgICBpZiAobWF4KSByZXR1cm4gdGhpcy5fc2xlZXAobWF4KQogICAgcmV0dXJuIHRoaXMuX3Byb21pc2UKICB9CgogIF9zbGVlcCAobWF4KSB7CiAgICBjb25zdCBzID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICBjb25zdCBkb25lID0gKCkgPT4gewogICAgICAgIHRoaXMuX3RpbWVycy5kZWxldGUoc3RhdGUpCiAgICAgICAgcmVzb2x2ZSh0cnVlKQogICAgICB9CiAgICAgIGNvbnN0IGlkID0gc2V0VGltZW91dChkb25lLCBtYXgpCiAgICAgIGNvbnN0IHN0YXRlID0geyBpZCwgcmVzb2x2ZSwgcmVqZWN0IH0KICAgICAgdGhpcy5fdGltZXJzLmFkZChzdGF0ZSkKICAgIH0pCgogICAgcmV0dXJuIHMKICB9CgogIG5vdGlmeSAoZXJyKSB7CiAgICBpZiAoIXRoaXMuX3Byb21pc2UpIHJldHVybgogICAgY29uc3QgcmVzb2x2ZSA9IHRoaXMuX3Jlc29sdmUKICAgIGNvbnN0IHJlamVjdCA9IHRoaXMuX3JlamVjdAogICAgdGhpcy5fcHJvbWlzZSA9IG51bGwKICAgIGlmIChlcnIpIHJlamVjdChlcnIpCiAgICBlbHNlIHJlc29sdmUodHJ1ZSkKICB9Cn0KCmZ1bmN0aW9uIGNsZWFyIChlcnIpIHsKICBmb3IgKGNvbnN0IHsgaWQsIHJlc29sdmUsIHJlamVjdCB9IG9mIHRoaXMuX3RpbWVycykgewogICAgY2xlYXJUaW1lb3V0KGlkKQogICAgaWYgKGVycikgcmVqZWN0KGVycikKICAgIGVsc2UgcmVzb2x2ZSh0cnVlKQogIH0KICB0aGlzLl90aW1lcnMuY2xlYXIoKQp9CgpmdW5jdGlvbiBiaW5kIChyZXNvbHZlLCByZWplY3QpIHsKICB0aGlzLl9yZXNvbHZlID0gcmVzb2x2ZQogIHRoaXMuX3JlamVjdCA9IHJlamVjdAp9CnsKICAibmFtZSI6ICJzaWduYWwtcHJvbWlzZSIsCiAgInZlcnNpb24iOiAiMS4wLjMiLAogICJkZXNjcmlwdGlvbiI6ICJTaW1wbGUgd2FpdC9ub3RpZnkgcHJvbWlzZSB3aXRoIG9wdGlvbmFsIG1heCB3YWl0IHRpbWUiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHt9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zaWduYWwtcHJvbWlzZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc2lnbmFsLXByb21pc2UvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc2lnbmFsLXByb21pc2UiCn0KdmFyIHZhcmludCA9IHJlcXVpcmUoJ3ZhcmludCcpCmV4cG9ydHMuZW5jb2RlID0gZnVuY3Rpb24gZW5jb2RlICh2LCBiLCBvKSB7CiAgdiA9IHYgPj0gMCA/IHYqMiA6IHYqLTIgLSAxCiAgdmFyIHIgPSB2YXJpbnQuZW5jb2RlKHYsIGIsIG8pCiAgZW5jb2RlLmJ5dGVzID0gdmFyaW50LmVuY29kZS5ieXRlcwogIHJldHVybiByCn0KZXhwb3J0cy5kZWNvZGUgPSBmdW5jdGlvbiBkZWNvZGUgKGIsIG8pIHsKICB2YXIgdiA9IHZhcmludC5kZWNvZGUoYiwgbykKICBkZWNvZGUuYnl0ZXMgPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgcmV0dXJuIHYgJiAxID8gKHYrMSkgLyAtMiA6IHYgLyAyCn0KCmV4cG9ydHMuZW5jb2RpbmdMZW5ndGggPSBmdW5jdGlvbiAodikgewogIHJldHVybiB2YXJpbnQuZW5jb2RpbmdMZW5ndGgodiA+PSAwID8gdioyIDogdiotMiAtIDEpCn0KewogICJuYW1lIjogInNpZ25lZC12YXJpbnQiLAogICJkZXNjcmlwdGlvbiI6ICJlZmZpY2llbnRseSBzdG9yZSBzaWduZWQgaW50ZWdlcnMgaW4gdmFyaW50IiwKICAidmVyc2lvbiI6ICIyLjAuMSIsCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9kb21pbmljdGFyci9zaWduZWQtdmFyaW50IiwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdDovL2dpdGh1Yi5jb20vZG9taW5pY3RhcnIvc2lnbmVkLXZhcmludC5naXQiCiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgInZhcmludCI6ICJ+NS4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInRhcGUiOiAifjIuMTIuMyIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAibm9kZSB0ZXN0LmpzIgogIH0sCiAgImF1dGhvciI6ICJEb21pbmljIFRhcnIgPGRvbWluaWMudGFyckBnbWFpbC5jb20+IChodHRwOi8vZG9taW5pY3RhcnIuY29tKSIsCiAgImxpY2Vuc2UiOiAiTUlUIgp9CnJlcXVpcmUuYWRkb24gPSByZXF1aXJlKCdyZXF1aXJlLWFkZG9uJykKCm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZS5hZGRvbignLicsIF9fZmlsZW5hbWUpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuL2JpbmRpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKZnVuY3Rpb24gcHJlZGljYXRlKHU4LCB1MTYsIHUzMikgewogIHJldHVybiBmdW5jdGlvbiBwcmVkaWNhdGUoYnVmKSB7CiAgICBpZiAoYnVmLmJ5dGVMZW5ndGggJSAxNiAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0J1ZmZlciBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2JykKICAgIH0KCiAgICBjb25zdCBuID0gYnVmLkJZVEVTX1BFUl9FTEVNRU5UCgogICAgaWYgKG4gPT09IDEpIHJldHVybiB1OChidWYpCiAgICBpZiAobiA9PT0gMikgcmV0dXJuIHUxNihidWYpCiAgICByZXR1cm4gdTMyKGJ1ZikKICB9Cn0KCmZ1bmN0aW9uIHVuYXJ5KHU4LCB1MTYsIHUzMikgewogIHJldHVybiBmdW5jdGlvbiB1bmFyeShidWYsIHJlc3VsdCA9IGI0YS5hbGxvY1Vuc2FmZShidWYuYnl0ZUxlbmd0aCkpIHsKICAgIGlmIChidWYuYnl0ZUxlbmd0aCAlIDE2ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQnVmZmVyIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYnKQogICAgfQoKICAgIGlmIChidWYuYnl0ZUxlbmd0aCAhPT0gcmVzdWx0LmJ5dGVMZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdMZW5ndGggb2YgcmVzdWx0IGJ1ZmZlciBpcyBpbnN1ZmZpY2llbnQnKQogICAgfQoKICAgIGNvbnN0IG4gPSBidWYuQllURVNfUEVSX0VMRU1FTlQKCiAgICBpZiAobiA9PT0gMSkgdTgoYnVmLCByZXN1bHQpCiAgICBlbHNlIGlmIChuID09PSAyKSB1MTYoYnVmLCByZXN1bHQpCiAgICBlbHNlIHUzMihidWYsIHJlc3VsdCkKCiAgICByZXR1cm4gcmVzdWx0CiAgfQp9CgpmdW5jdGlvbiBiaW5hcnkodTgsIHUxNiwgdTMyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIGJpbmFyeShhLCBiLCByZXN1bHQgPSBiNGEuYWxsb2NVbnNhZmUoYS5ieXRlTGVuZ3RoKSkgewogICAgaWYgKGEuYnl0ZUxlbmd0aCAlIDE2ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQnVmZmVyIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYnKQogICAgfQoKICAgIGlmIChhLmJ5dGVMZW5ndGggIT09IGIuYnl0ZUxlbmd0aCB8fCBhLmJ5dGVMZW5ndGggIT09IHJlc3VsdC5ieXRlTGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQnVmZmVycyBtdXN0IGJlIHRoZSBzYW1lIGxlbmd0aCcpCiAgICB9CgogICAgY29uc3QgbiA9IGEuQllURVNfUEVSX0VMRU1FTlQKCiAgICBpZiAobiA9PT0gMSkgdTgoYSwgYiwgcmVzdWx0KQogICAgZWxzZSBpZiAobiA9PT0gMikgdTE2KGEsIGIsIHJlc3VsdCkKICAgIGVsc2UgdTMyKGEsIGIsIHJlc3VsdCkKCiAgICByZXR1cm4gcmVzdWx0CiAgfQp9CgpmdW5jdGlvbiByZWR1Y2UodTgsIHUxNiwgdTMyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIHJlZHVjZShidWYpIHsKICAgIGlmIChidWYuYnl0ZUxlbmd0aCAlIDE2ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQnVmZmVyIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYnKQogICAgfQoKICAgIGNvbnN0IG4gPSBidWYuQllURVNfUEVSX0VMRU1FTlQKCiAgICBpZiAobiA9PT0gMSkgcmV0dXJuIHU4KGJ1ZikKICAgIGlmIChuID09PSAyKSByZXR1cm4gdTE2KGJ1ZikKICAgIHJldHVybiB1MzIoYnVmKQogIH0KfQoKZXhwb3J0cy5hbGxvID0gcHJlZGljYXRlKAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9hbGxvX3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2FsbG9fdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2FsbG9fdjEyOF91MzIKKQoKZXhwb3J0cy5hbGx6ID0gcHJlZGljYXRlKAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9hbGx6X3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2FsbHpfdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2FsbHpfdjEyOF91MzIKKQoKZXhwb3J0cy5hbmQgPSBiaW5hcnkoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2FuZF92MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9hbmRfdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2FuZF92MTI4X3UzMgopCgpleHBvcnRzLmNsZWFyID0gYmluYXJ5KAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbGVhcl92MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbGVhcl92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY2xlYXJfdjEyOF91MzIKKQoKZXhwb3J0cy5jbG8gPSB1bmFyeSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY2xvX3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2Nsb192MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY2xvX3YxMjhfdTMyCikKCmV4cG9ydHMuY2x6ID0gdW5hcnkoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2Nsel92MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbHpfdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2Nsel92MTI4X3UzMgopCgpleHBvcnRzLmNudCA9IHVuYXJ5KAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbnRfdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY250X3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbnRfdjEyOF91MzIKKQoKZXhwb3J0cy5jdG8gPSB1bmFyeSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY3RvX3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2N0b192MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY3RvX3YxMjhfdTMyCikKCmV4cG9ydHMuY3R6ID0gdW5hcnkoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2N0el92MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jdHpfdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2N0el92MTI4X3UzMgopCgpleHBvcnRzLm5vdCA9IHVuYXJ5KAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9ub3RfdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfbm90X3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9ub3RfdjEyOF91MzIKKQoKZXhwb3J0cy5vciA9IGJpbmFyeSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfb3JfdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfb3JfdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX29yX3YxMjhfdTMyCikKCmV4cG9ydHMuc3VtID0gcmVkdWNlKAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9zdW1fdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfc3VtX3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9zdW1fdjEyOF91MzIKKQoKZXhwb3J0cy54b3IgPSBiaW5hcnkoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX3hvcl92MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV94b3JfdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX3hvcl92MTI4X3UzMgopCnsKICAibmFtZSI6ICJzaW1kbGUtbmF0aXZlIiwKICAidmVyc2lvbiI6ICIxLjMuOSIsCiAgImRlc2NyaXB0aW9uIjogImxpYnNpbWRsZSBKYXZhU2NyaXB0IGJpbmRpbmdzIGZvciBOb2RlLmpzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJiaW5kaW5nLmNjIiwKICAgICJiaW5kaW5nLmpzIiwKICAgICJDTWFrZUxpc3RzLnR4dCIsCiAgICAicHJlYnVpbGRzIgogIF0sCiAgImFkZG9uIjogdHJ1ZSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIiwKICAgICJsaW50IjogInByZXR0aWVyIC0tY2hlY2sgLiIsCiAgICAidGVzdCI6ICJucG0gcnVuIGxpbnQgJiYgbnBtIHJ1biB0ZXN0OmJhcmUgJiYgbnBtIHJ1biB0ZXN0Om5vZGUiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QubWpzIiwKICAgICJ0ZXN0Om5vZGUiOiAibm9kZSB0ZXN0Lm1qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zaW1kbGUtbmF0aXZlLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NpbWRsZS1uYXRpdmUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zaW1kbGUtbmF0aXZlI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi4wIiwKICAgICJyZXF1aXJlLWFkZG9uIjogIl4xLjEuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1jb21wYXQtbmFwaSI6ICJeMS4zLjIiLAogICAgImJyaXR0bGUiOiAiXjMuMS4wIiwKICAgICJjbWFrZS1iYXJlIjogIl4xLjEuNyIsCiAgICAiY21ha2UtZmV0Y2giOiAiXjEuMS4wIiwKICAgICJjbWFrZS1uYXBpIjogIl4xLjAuMiIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4xLjAuMCIKICB9Cn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3Qgc2NhbGFyID0gcmVxdWlyZSgnLi9zY2FsYXInKQoKZnVuY3Rpb24gdmlldyAoYnVmLCBuKSB7CiAgaWYgKG4gPT09IGJ1Zi5CWVRFU19QRVJfRUxFTUVOVCkgcmV0dXJuIGJ1ZgoKICBsZXQgVHlwZWRBcnJheQoKICBpZiAobiA9PT0gMSkgVHlwZWRBcnJheSA9IFVpbnQ4QXJyYXkKICBlbHNlIGlmIChuID09PSAyKSBUeXBlZEFycmF5ID0gVWludDE2QXJyYXkKICBlbHNlIFR5cGVkQXJyYXkgPSBVaW50MzJBcnJheQoKICByZXR1cm4gbmV3IFR5cGVkQXJyYXkoYnVmLmJ1ZmZlciwgYnVmLmJ5dGVPZmZzZXQsIGJ1Zi5ieXRlTGVuZ3RoIC8gbikKfQoKZnVuY3Rpb24gdW5hcnkgKHU4LCB1MTYgPSB1OCwgdTMyID0gdTE2KSB7CiAgcmV0dXJuIGZ1bmN0aW9uIHVuYXJ5IChidWYsIHJlc3VsdCA9IGI0YS5hbGxvY1Vuc2FmZShidWYuYnl0ZUxlbmd0aCkpIHsKICAgIGlmIChidWYuYnl0ZUxlbmd0aCAlIDE2ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQnVmZmVyIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYnKQogICAgfQoKICAgIGlmIChidWYuYnl0ZUxlbmd0aCAhPT0gcmVzdWx0LmJ5dGVMZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdMZW5ndGggb2YgcmVzdWx0IGJ1ZmZlciBpcyBpbnN1ZmZpY2llbnQnKQogICAgfQoKICAgIGNvbnN0IG4gPSBidWYuQllURVNfUEVSX0VMRU1FTlQKCiAgICBpZiAobiA9PT0gMSkgdTgoYnVmLCB2aWV3KHJlc3VsdCwgbikpCiAgICBlbHNlIGlmIChuID09PSAyKSB1MTYoYnVmLCB2aWV3KHJlc3VsdCwgbikpCiAgICBlbHNlIHUzMihidWYsIHZpZXcocmVzdWx0LCBuKSkKCiAgICByZXR1cm4gcmVzdWx0CiAgfQp9CgpmdW5jdGlvbiBiaW5hcnkgKHU4LCB1MTYgPSB1OCwgdTMyID0gdTE2KSB7CiAgcmV0dXJuIGZ1bmN0aW9uIGJpbmFyeSAoYSwgYiwgcmVzdWx0ID0gYjRhLmFsbG9jVW5zYWZlKGEuYnl0ZUxlbmd0aCkpIHsKICAgIGlmIChhLmJ5dGVMZW5ndGggJSAxNiAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0J1ZmZlciBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2JykKICAgIH0KCiAgICBpZiAoYS5ieXRlTGVuZ3RoICE9PSBiLmJ5dGVMZW5ndGggfHwgYS5ieXRlTGVuZ3RoICE9PSByZXN1bHQuYnl0ZUxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0J1ZmZlcnMgbXVzdCBiZSB0aGUgc2FtZSBsZW5ndGgnKQogICAgfQoKICAgIGNvbnN0IG4gPSBhLkJZVEVTX1BFUl9FTEVNRU5UCgogICAgaWYgKG4gPT09IDEpIHU4KGEsIGIsIHZpZXcocmVzdWx0LCBuKSkKICAgIGVsc2UgaWYgKG4gPT09IDIpIHUxNihhLCBiLCB2aWV3KHJlc3VsdCwgbikpCiAgICBlbHNlIHUzMihhLCBiLCB2aWV3KHJlc3VsdCwgbikpCgogICAgcmV0dXJuIHJlc3VsdAogIH0KfQoKZnVuY3Rpb24gcmVkdWNlICh1OCwgdTE2ID0gdTgsIHUzMiA9IHUxNikgewogIHJldHVybiBmdW5jdGlvbiByZWR1Y2UgKGJ1ZikgewogICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoICUgMTYgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXIgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNicpCiAgICB9CgogICAgY29uc3QgbiA9IGJ1Zi5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGlmIChuID09PSAxKSByZXR1cm4gdTgoYnVmKQogICAgaWYgKG4gPT09IDIpIHJldHVybiB1MTYoYnVmKQogICAgcmV0dXJuIHUzMihidWYpCiAgfQp9CgpleHBvcnRzLmFsbG8gPSBmdW5jdGlvbiBhbGxvIChidWYpIHsKICBpZiAoYnVmLmJ5dGVMZW5ndGggJSAxNiAhPT0gMCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXIgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNicpCiAgfQoKICBjb25zdCBtID0gMiAqKiAoYnVmLkJZVEVTX1BFUl9FTEVNRU5UICogOCkgLSAxCgogIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgaWYgKGJ1ZltpXSAhPT0gbSkgcmV0dXJuIGZhbHNlCiAgfQoKICByZXR1cm4gdHJ1ZQp9CgpleHBvcnRzLmFsbHogPSBmdW5jdGlvbiBhbGx6IChidWYpIHsKICBpZiAoYnVmLmJ5dGVMZW5ndGggJSAxNiAhPT0gMCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXIgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNicpCiAgfQoKICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgIGlmIChidWZbaV0gIT09IDApIHJldHVybiBmYWxzZQogIH0KCiAgcmV0dXJuIHRydWUKfQoKZXhwb3J0cy5hbmQgPSBiaW5hcnkoCiAgKGEsIGIsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSByZXN1bHQubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IGFbaV0gJiBiW2ldCiAgICB9CiAgfQopCgpleHBvcnRzLmNsZWFyID0gYmluYXJ5KAogIChhLCBiLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gcmVzdWx0Lmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBhW2ldICYgfmJbaV0KICAgIH0KICB9CikKCmV4cG9ydHMuY2xvID0gdW5hcnkoCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gMjQgLSBzY2FsYXIuY2xvKGJ1ZltpXSkKICAgIH0KICB9LAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IDE2IC0gc2NhbGFyLmNsbyhidWZbaV0pCiAgICB9CiAgfSwKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBzY2FsYXIuY2xvKGJ1ZltpXSkKICAgIH0KICB9CikKCmV4cG9ydHMuY2x6ID0gdW5hcnkoCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gMjQgLSBzY2FsYXIuY2x6KGJ1ZltpXSkKICAgIH0KICB9LAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IDE2IC0gc2NhbGFyLmNseihidWZbaV0pCiAgICB9CiAgfSwKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBzY2FsYXIuY2x6KGJ1ZltpXSkKICAgIH0KICB9CikKCmV4cG9ydHMuY250ID0gdW5hcnkoCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gc2NhbGFyLmNudChidWZbaV0pICYgMHhmZgogICAgfQogIH0sCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gc2NhbGFyLmNudChidWZbaV0pICYgMHhmZmZmCiAgICB9CiAgfSwKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBzY2FsYXIuY250KGJ1ZltpXSkKICAgIH0KICB9CikKCmV4cG9ydHMuY3RvID0gdW5hcnkoCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gTWF0aC5taW4oc2NhbGFyLmN0byhidWZbaV0pLCA4KQogICAgfQogIH0sCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gTWF0aC5taW4oc2NhbGFyLmN0byhidWZbaV0pLCAxNikKICAgIH0KICB9LAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IHNjYWxhci5jdG8oYnVmW2ldKQogICAgfQogIH0KKQoKZXhwb3J0cy5jdHogPSB1bmFyeSgKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBNYXRoLm1pbihzY2FsYXIuY3R6KGJ1ZltpXSksIDgpCiAgICB9CiAgfSwKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBNYXRoLm1pbihzY2FsYXIuY3R6KGJ1ZltpXSksIDE2KQogICAgfQogIH0sCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gc2NhbGFyLmN0eihidWZbaV0pCiAgICB9CiAgfQopCgpleHBvcnRzLm5vdCA9IHVuYXJ5KAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IH5idWZbaV0KICAgIH0KICB9CikKCmV4cG9ydHMub3IgPSBiaW5hcnkoCiAgKGEsIGIsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSByZXN1bHQubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IGFbaV0gfCBiW2ldCiAgICB9CiAgfQopCgpleHBvcnRzLnN1bSA9IHJlZHVjZSgKICAoYnVmKSA9PiB7CiAgICBsZXQgcmVzdWx0ID0gMG4KCiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0ICs9IEJpZ0ludChidWZbaV0pCiAgICB9CgogICAgcmV0dXJuIHJlc3VsdAogIH0KKQoKZXhwb3J0cy54b3IgPSBiaW5hcnkoCiAgKGEsIGIsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSByZXN1bHQubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IGFbaV0gXiBiW2ldCiAgICB9CiAgfQopCnRyeSB7CiAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCdzaW1kbGUtbmF0aXZlJykKfSBjYXRjaCB7CiAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCcuL2ZhbGxiYWNrJykKfQp7CiAgIm5hbWUiOiAic2ltZGxlLXVuaXZlcnNhbCIsCiAgInZlcnNpb24iOiAiMS4xLjIiLAogICJkZXNjcmlwdGlvbiI6ICJVbml2ZXJzYWwgd3JhcHBlciBmb3IgbGlic2ltZGxlIHdpdGggYSBKYXZhU2NyaXB0IGZhbGxiYWNrIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImZhbGxiYWNrLmpzIiwKICAgICJpbmRleC5qcyIsCiAgICAic2NhbGFyLmpzIgogIF0sCiAgImJyb3dzZXIiOiB7CiAgICAiLi9pbmRleC5qcyI6ICIuL2ZhbGxiYWNrLmpzIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QubWpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NpbWRsZS11bml2ZXJzYWwuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJLYXNwZXIgSXNhZ2VyIERhbHNnYXLDsCA8a2FzcGVyQGZ1bmt0aW9uZWwuY28+IiwKICAibGljZW5zZSI6ICJJU0MiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc2ltZGxlLXVuaXZlcnNhbC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NpbWRsZS11bml2ZXJzYWwjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjAiCiAgfSwKICAib3B0aW9uYWxEZXBlbmRlbmNpZXMiOiB7CiAgICAic2ltZGxlLW5hdGl2ZSI6ICJeMS4xLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMS4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0KfQpjb25zdCBjbHogPSBleHBvcnRzLmNseiA9IGZ1bmN0aW9uIGNseiAobikgewogIHJldHVybiBNYXRoLmNsejMyKG4pCn0KCmV4cG9ydHMuY2xvID0gZnVuY3Rpb24gY2xvIChuKSB7CiAgcmV0dXJuIGNseih+bikKfQoKY29uc3QgY3R6ID0gZXhwb3J0cy5jdHogPSBmdW5jdGlvbiBjdHogKG4pIHsKICByZXR1cm4gMzIgLSAobiA9PT0gMCA/IDAgOiAoY2x6KG4gJiAtbikgKyAxKSkKfQoKZXhwb3J0cy5jdG8gPSBmdW5jdGlvbiBjdG8gKG4pIHsKICByZXR1cm4gY3R6KH5uKQp9CgpleHBvcnRzLmNudCA9IGZ1bmN0aW9uIGNudCAobikgewogIG4gPSBuIC0gKChuID4+PiAxKSAmIDB4NTU1NTU1NTUpCiAgbiA9IChuICYgMHgzMzMzMzMzMykgKyAoKG4gPj4+IDIpICYgMHgzMzMzMzMzMykKICBuID0gKG4gKyAobiA+Pj4gNCkpICYgMHgwZjBmMGYwZgogIG4gPSAobiAqIDB4MDEwMTAxMDEpID4+PiAyNAogIHJldHVybiBuCn0KcmVxdWlyZS5hZGRvbiA9IHJlcXVpcmUoJ3JlcXVpcmUtYWRkb24nKQptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUuYWRkb24oJy4nLCBfX2ZpbGVuYW1lKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi9iaW5kaW5nJykKY29uc3QgeyBpc05vZGUgfSA9IHJlcXVpcmUoJ3doaWNoLXJ1bnRpbWUnKQoKY29uc3QgT1BUSU9OQUwgPSBCdWZmZXIuZnJvbShuZXcgQXJyYXlCdWZmZXIoMCkpCgptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSB7IC4uLmJpbmRpbmcgfQoKLy8gbWVtb3J5CgpleHBvcnRzLnNvZGl1bV9tZW16ZXJvID0gZnVuY3Rpb24gKGJ1ZikgewogIGJpbmRpbmcuc29kaXVtX21lbXplcm8oYnVmKQp9CgpleHBvcnRzLnNvZGl1bV9tbG9jayA9IGZ1bmN0aW9uIChidWYpIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLnNvZGl1bV9tbG9jayhidWYpCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdtZW1vcnkgbG9jayBmYWlsZWQnKQp9CgpleHBvcnRzLnNvZGl1bV9tdW5sb2NrID0gZnVuY3Rpb24gKGJ1ZikgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuc29kaXVtX211bmxvY2soYnVmKQogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignbWVtb3J5IHVubG9jayBmYWlsZWQnKQp9CgpleHBvcnRzLnNvZGl1bV9tYWxsb2MgPSBmdW5jdGlvbiAoc2l6ZSkgewogIGlmIChzaXplIDwgMCkgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIHNpemUnKQogIGNvbnN0IGJ1ZiA9IEJ1ZmZlci5mcm9tKGJpbmRpbmcuc29kaXVtX21hbGxvYyhzaXplKSkKICBidWYuc2VjdXJlID0gdHJ1ZQoKICByZXR1cm4gYnVmCn0KCmV4cG9ydHMuc29kaXVtX2ZyZWUgPSBmdW5jdGlvbiAoYnVmKSB7CiAgaWYgKCFidWY/LnNlY3VyZSkgcmV0dXJuCgogIGJpbmRpbmcuc29kaXVtX2ZyZWUoYnVmLmJ1ZmZlcikKfQoKZXhwb3J0cy5zb2RpdW1fbXByb3RlY3Rfbm9hY2Nlc3MgPSBmdW5jdGlvbiAoYnVmKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5zb2RpdW1fbXByb3RlY3Rfbm9hY2Nlc3MoYnVmLmJ1ZmZlcikKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdmYWlsZWQgdG8gbG9jayBidWZmZXInKQp9CgpleHBvcnRzLnNvZGl1bV9tcHJvdGVjdF9yZWFkb25seSA9IGZ1bmN0aW9uIChidWYpIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLnNvZGl1bV9tcHJvdGVjdF9yZWFkb25seShidWYuYnVmZmVyKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ2ZhaWxlZCB0byB1bmxvY2sgYnVmZmVyJykKfQoKZXhwb3J0cy5zb2RpdW1fbXByb3RlY3RfcmVhZHdyaXRlID0gZnVuY3Rpb24gKGJ1ZikgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuc29kaXVtX21wcm90ZWN0X3JlYWR3cml0ZShidWYuYnVmZmVyKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ2ZhaWxlZCB0byB1bmxvY2sgYnVmZmVyJykKfQoKLy8gY3J5cHRvX3JhbmRvbWJ5dGVzCgpleHBvcnRzLnJhbmRvbWJ5dGVzX2J1ZiA9IGZ1bmN0aW9uIChidWZmZXIpIHsKICBiaW5kaW5nLnJhbmRvbWJ5dGVzX2J1ZihidWZmZXIuYnVmZmVyLCBidWZmZXIuYnl0ZU9mZnNldCwgYnVmZmVyLmJ5dGVMZW5ndGgpCn0KCmV4cG9ydHMucmFuZG9tYnl0ZXNfYnVmX2RldGVybWluaXN0aWMgPSBmdW5jdGlvbiAoYnVmZmVyLCBzZWVkKSB7CiAgYmluZGluZy5yYW5kb21ieXRlc19idWZfZGV0ZXJtaW5pc3RpYygKICAgIGJ1ZmZlci5idWZmZXIsCiAgICBidWZmZXIuYnl0ZU9mZnNldCwKICAgIGJ1ZmZlci5ieXRlTGVuZ3RoLAoKICAgIHNlZWQuYnVmZmVyLAogICAgc2VlZC5ieXRlT2Zmc2V0LAogICAgc2VlZC5ieXRlTGVuZ3RoCiAgKQp9CgovLyBzb2RpdW1faGVscGVycwoKZXhwb3J0cy5zb2RpdW1fbWVtY21wID0gZnVuY3Rpb24gKGEsIGIpIHsKICBpZiAoYT8uYnl0ZUxlbmd0aCAhPT0gYj8uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYnVmZmVycyBtdXN0IGJlIG9mIHNhbWUgbGVuZ3RoIicpCiAgcmV0dXJuIGJpbmRpbmcuc29kaXVtX21lbWNtcChhLCBiKQp9CgpleHBvcnRzLnNvZGl1bV9hZGQgPSBmdW5jdGlvbiAoYSwgYikgewogIGlmIChhPy5ieXRlTGVuZ3RoICE9PSBiPy5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdidWZmZXJzIG11c3QgYmUgb2Ygc2FtZSBsZW5ndGgiJykKICBiaW5kaW5nLnNvZGl1bV9hZGQoYSwgYikKfQoKZXhwb3J0cy5zb2RpdW1fc3ViID0gZnVuY3Rpb24gKGEsIGIpIHsKICBpZiAoYT8uYnl0ZUxlbmd0aCAhPT0gYj8uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYnVmZmVycyBtdXN0IGJlIG9mIHNhbWUgbGVuZ3RoIicpCiAgYmluZGluZy5zb2RpdW1fc3ViKGEsIGIpCn0KCmV4cG9ydHMuc29kaXVtX2NvbXBhcmUgPSBmdW5jdGlvbiAoYSwgYikgewogIGlmIChhPy5ieXRlTGVuZ3RoICE9PSBiPy5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdidWZmZXJzIG11c3QgYmUgb2Ygc2FtZSBsZW5ndGgiJykKICByZXR1cm4gYmluZGluZy5zb2RpdW1fY29tcGFyZShhLCBiKQp9CgpleHBvcnRzLnNvZGl1bV9pc196ZXJvID0gZnVuY3Rpb24gKGJ1ZmZlciwgbGVuZ3RoKSB7CiAgaWYgKCFidWZmZXIpIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBidWZmZXInKQogIGxlbmd0aCA/Pz0gYnVmZmVyLmJ5dGVMZW5ndGgKICBpZiAobGVuZ3RoID4gYnVmZmVyLmJ5dGVMZW5ndGggfHwgbGVuZ3RoIDwgMCkKICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBsZW5ndGgnKQoKICByZXR1cm4gYmluZGluZy5zb2RpdW1faXNfemVybyhidWZmZXIsIGxlbmd0aCkKfQoKZXhwb3J0cy5zb2RpdW1fcGFkID0gZnVuY3Rpb24gKGJ1ZmZlciwgdW5wYWRkZWRCdWZsZW4sIGJsb2NrU2l6ZSkgewogIGlmICh1bnBhZGRlZEJ1ZmxlbiA+IGJ1ZmZlci5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCd1bnBhZGRlZCBsZW5ndGggY2Fubm90IGV4Y2VlZCBidWZmZXIgbGVuZ3RoJykKICBpZiAoYmxvY2tTaXplID4gYnVmZmVyLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2Jsb2NrIHNpemUgY2Fubm90IGV4Y2VlZCBidWZmZXIgbGVuZ3RoJykKICBpZiAoYmxvY2tTaXplIDwgMSkgdGhyb3cgbmV3IEVycm9yKCdibG9jayBzaXplbXVzdCBiZSBhdCBsZWFzdCAxIGJ5dGUnKQogIGlmICgKICAgIGJ1ZmZlcj8uYnl0ZUxlbmd0aCA8CiAgICB1bnBhZGRlZEJ1ZmxlbiArIChibG9ja1NpemUgLSAodW5wYWRkZWRCdWZsZW4gJSBibG9ja1NpemUpKQogICkKICAgIHRocm93IG5ldyBFcnJvcignYnVmIG5vdCBsb25nIGVub3VnaCcpCgogIHJldHVybiBiaW5kaW5nLnNvZGl1bV9wYWQoYnVmZmVyLCB1bnBhZGRlZEJ1ZmxlbiwgYmxvY2tTaXplKQp9CgpleHBvcnRzLnNvZGl1bV91bnBhZCA9IGZ1bmN0aW9uIChidWZmZXIsIHBhZGRlZEJ1ZmxlbiwgYmxvY2tTaXplKSB7CiAgaWYgKHBhZGRlZEJ1ZmxlbiA+IGJ1ZmZlci5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCd1bnBhZGRlZCBsZW5ndGggY2Fubm90IGV4Y2VlZCBidWZmZXIgbGVuZ3RoJykKICBpZiAoYmxvY2tTaXplID4gYnVmZmVyLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2Jsb2NrIHNpemUgY2Fubm90IGV4Y2VlZCBidWZmZXIgbGVuZ3RoJykKICBpZiAoYmxvY2tTaXplIDwgMSkgdGhyb3cgbmV3IEVycm9yKCdibG9jayBzaXplIG11c3QgYmUgYXQgbGVhc3QgMSBieXRlJykKCiAgcmV0dXJuIGJpbmRpbmcuc29kaXVtX3VucGFkKGJ1ZmZlciwgcGFkZGVkQnVmbGVuLCBibG9ja1NpemUpCn0KCi8vIGNyeXB0b19zaWduCgpleHBvcnRzLmNyeXB0b19zaWduX2tleXBhaXIgPSBmdW5jdGlvbiAocGssIHNrKSB7CiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NpZ25fa2V5cGFpcihwaywgc2spCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zaWduX3NlZWRfa2V5cGFpciA9IGZ1bmN0aW9uIChwaywgc2ssIHNlZWQpIHsKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2lnbl9zZWVkX2tleXBhaXIocGssIHNrLCBzZWVkKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2lnbiA9IGZ1bmN0aW9uIChzbSwgbSwgc2spIHsKICBpZiAoc20/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fQllURVMgKyBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NtIG11c3QgYmUgIm0uYnl0ZUxlbmd0aCArIGNyeXB0b19zaWduX0JZVEVTIiBieXRlcycpCiAgaWYgKHNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1NFQ1JFVEtFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NpZ24oc20sIG0sIHNrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2lnbl9vcGVuID0gZnVuY3Rpb24gKG0sIHNtLCBwaykgewogIGlmIChzbT8uYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY3J5cHRvX3NpZ25fQllURVMpIHRocm93IG5ldyBFcnJvcignc20nKQogIGlmIChtPy5ieXRlTGVuZ3RoICE9PSBzbS5ieXRlTGVuZ3RoIC0gYmluZGluZy5jcnlwdG9fc2lnbl9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJzbS5ieXRlTGVuZ3RoIC0gY3J5cHRvX3NpZ25fQllURVMiIGJ5dGVzJykKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2lnbl9vcGVuKG0sIHNtLCBwaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NpZ25fb3BlbiA9IGZ1bmN0aW9uIChtLCBzbSwgcGspIHsKICBpZiAoc20/LmJ5dGVMZW5ndGggPCBiaW5kaW5nLmNyeXB0b19zaWduX0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3NtJykKICBpZiAobT8uYnl0ZUxlbmd0aCAhPT0gc20uYnl0ZUxlbmd0aCAtIGJpbmRpbmcuY3J5cHRvX3NpZ25fQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAic20uYnl0ZUxlbmd0aCAtIGNyeXB0b19zaWduX0JZVEVTIiBieXRlcycpCiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwaycpCgogIHJldHVybiBiaW5kaW5nLmNyeXB0b19zaWduX29wZW4obSwgc20sIHBrKQp9CgpleHBvcnRzLmNyeXB0b19zaWduX2RldGFjaGVkID0gZnVuY3Rpb24gKHNpZywgbSwgc2spIHsKICBpZiAoc2lnPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3NpZycpCiAgaWYgKHNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1NFQ1JFVEtFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NpZ25fZGV0YWNoZWQoc2lnLCBtLCBzaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NpZ25fdmVyaWZ5X2RldGFjaGVkID0gZnVuY3Rpb24gKHNpZywgbSwgcGspIHsKICByZXR1cm4gYmluZGluZy5jcnlwdG9fc2lnbl92ZXJpZnlfZGV0YWNoZWQoCiAgICBzaWcuYnVmZmVyLAogICAgc2lnLmJ5dGVPZmZzZXQsCiAgICBzaWcuYnl0ZUxlbmd0aCwKCiAgICBtLmJ1ZmZlciwKICAgIG0uYnl0ZU9mZnNldCwKICAgIG0uYnl0ZUxlbmd0aCwKCiAgICBway5idWZmZXIsCiAgICBway5ieXRlT2Zmc2V0LAogICAgcGsuYnl0ZUxlbmd0aAogICkKfQoKZXhwb3J0cy5jcnlwdG9fc2lnbl9lZDI1NTE5X3NrX3RvX3BrID0gZnVuY3Rpb24gKHBrLCBzaykgewogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQogIGlmIChzaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9TRUNSRVRLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zaWduX2VkMjU1MTlfc2tfdG9fcGsocGssIHNrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2lnbl9lZDI1NTE5X3BrX3RvX2N1cnZlMjU1MTkgPSBmdW5jdGlvbiAoeDI1NTE5cGssIGVkMjU1MTlwaykgewogIGlmICh4MjU1MTlwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYm94X1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd4MjU1MTlfcGsnKQogIGlmIChlZDI1NTE5cGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2VkMjU1MTlfcGsnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zaWduX2VkMjU1MTlfcGtfdG9fY3VydmUyNTUxOSh4MjU1MTlwaywgZWQyNTUxOXBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2lnbl9lZDI1NTE5X3NrX3RvX2N1cnZlMjU1MTkgPSBmdW5jdGlvbiAoeDI1NTE5c2ssIGVkMjU1MTlzaykgewogIGlmICh4MjU1MTlzaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYm94X1NFQ1JFVEtFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd4MjU1MTlfc2snKQoKICBjb25zdCBlZExlbiA9IGVkMjU1MTlzay5ieXRlTGVuZ3RoCgogIGlmICgKICAgIGVkTGVuICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1NFQ1JFVEtFWUJZVEVTICYmCiAgICBlZExlbiAhPT0gYmluZGluZy5jcnlwdG9fYm94X1NFQ1JFVEtFWUJZVEVTCiAgKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJlZDI1NTE5X3NrIHNob3VsZCBlaXRoZXIgYmUgJ2NyeXB0b19zaWduX1NFQ1JFVEtFWUJZVEVTJyBieXRlcyBvciAnY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMgLSBjcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUycgYnl0ZXMiCiAgICApCiAgfQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zaWduX2VkMjU1MTlfc2tfdG9fY3VydmUyNTUxOSh4MjU1MTlzaywgZWQyNTUxOXNrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKLy8gY3J5cHRvX2JveAoKZXhwb3J0cy5jcnlwdG9fYm94X2tleXBhaXIgPSBmdW5jdGlvbiAocGssIHNrKSB7CiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19ib3hfUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKICBpZiAoc2s/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2JveF9TRUNSRVRLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19ib3hfa2V5cGFpcihwaywgc2spCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19ib3hfc2VlZF9rZXlwYWlyID0gZnVuY3Rpb24gKHBrLCBzaywgc2VlZCkgewogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYm94X1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwaycpCiAgaWYgKHNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19ib3hfU0VDUkVUS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYm94X3NlZWRfa2V5cGFpcihwaywgc2ssIHNlZWQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19ib3hfZWFzeSA9IGZ1bmN0aW9uIChjLCBtLCBuLCBwaywgc2spIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19ib3hfZWFzeShjLCBtLCBuLCBwaywgc2spCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19ib3hfZGV0YWNoZWQgPSBmdW5jdGlvbiAoYywgbWFjLCBtLCBuLCBwaywgc2spIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19ib3hfZGV0YWNoZWQoYywgbWFjLCBtLCBuLCBwaywgc2spCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19ib3hfc2VhbCA9IGZ1bmN0aW9uIChjLCBtLCBwaykgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2JveF9zZWFsKGMsIG0sIHBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fYm94X3NlYWxfb3BlbiA9IGZ1bmN0aW9uIChtLCBjLCBwaywgc2spIHsKICByZXR1cm4gYmluZGluZy5jcnlwdG9fYm94X3NlYWxfb3BlbigKICAgIG0uYnVmZmVyLAogICAgbS5ieXRlT2Zmc2V0LAogICAgbS5ieXRlTGVuZ3RoLAoKICAgIGMuYnVmZmVyLAogICAgYy5ieXRlT2Zmc2V0LAogICAgYy5ieXRlTGVuZ3RoLAoKICAgIHBrLmJ1ZmZlciwKICAgIHBrLmJ5dGVPZmZzZXQsCiAgICBway5ieXRlTGVuZ3RoLAoKICAgIHNrLmJ1ZmZlciwKICAgIHNrLmJ5dGVPZmZzZXQsCiAgICBzay5ieXRlTGVuZ3RoCiAgKQp9CgovLyBjcnlwdG9fc2VjcmV0Ym94CgpleHBvcnRzLmNyeXB0b19zZWNyZXRib3hfZWFzeSA9IGZ1bmN0aW9uIChjLCBtLCBuLCBrKSB7CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCArIGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9NQUNCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgJ2MgbXVzdCBiZSAibS5ieXRlTGVuZ3RoICsgY3J5cHRvX3NlY3JldGJveF9NQUNCWVRFUyIgYnl0ZXMnCiAgICApCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfZWFzeShjLCBtLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2VjcmV0Ym94X29wZW5fZWFzeSA9IGZ1bmN0aW9uIChtLCBjLCBuLCBrKSB7CiAgaWYgKG0/LmJ5dGVMZW5ndGggIT09IGMuYnl0ZUxlbmd0aCAtIGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9NQUNCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjIC0gY3J5cHRvX3NlY3JldGJveF9NQUNCWVRFUyIgYnl0ZXMnKQogIGlmIChjPy5ieXRlTGVuZ3RoIDwgYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X01BQ0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2MnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9LRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9vcGVuX2Vhc3kobSwgYywgbiwgaykKfQoKZXhwb3J0cy5jcnlwdG9fc2VjcmV0Ym94X2RldGFjaGVkID0gZnVuY3Rpb24gKGMsIG1hYywgbSwgbiwgaykgewogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2MgbXVzdCAibS5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG1hYz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X01BQ0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdtYWMnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9LRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X2RldGFjaGVkKGMsIG1hYywgbSwgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NlY3JldGJveF9vcGVuX2RldGFjaGVkID0gZnVuY3Rpb24gKG0sIGMsIG1hYywgbiwgaykgewogIGlmIChtPy5ieXRlTGVuZ3RoICE9PSBjLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG1hYz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X01BQ0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdtYWMnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9LRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9vcGVuX2RldGFjaGVkKG0sIGMsIG1hYywgbiwgaykKfQoKLy8gY3J5cHRvX2dlbmVyaWNoYXNoCgpleHBvcnRzLmNyeXB0b19nZW5lcmljaGFzaCA9IGZ1bmN0aW9uIChvdXRwdXQsIGlucHV0LCBrZXkgPSBPUFRJT05BTCkgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2dlbmVyaWNoYXNoKAogICAgb3V0cHV0LmJ1ZmZlciwKICAgIG91dHB1dC5ieXRlT2Zmc2V0LAogICAgb3V0cHV0LmJ5dGVMZW5ndGgsCgogICAgaW5wdXQuYnVmZmVyLAogICAgaW5wdXQuYnl0ZU9mZnNldCwKICAgIGlucHV0LmJ5dGVMZW5ndGgsCgogICAga2V5LmJ1ZmZlciwKICAgIGtleS5ieXRlT2Zmc2V0LAogICAga2V5LmJ5dGVMZW5ndGgKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaCA9IGZ1bmN0aW9uIChvdXRwdXQsIGJhdGNoLCBrZXkpIHsKICBpZiAoaXNOb2RlIHx8IGJhdGNoLmxlbmd0aCA8IDQpIHsKICAgIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKAogICAgICBvdXRwdXQsCiAgICAgIGJhdGNoLAogICAgICAhIWtleSwKICAgICAga2V5IHx8IE9QVElPTkFMCiAgICApCiAgICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKICB9IGVsc2UgewogICAgY29uc3Qgc3RhdGUgPSBCdWZmZXIuYWxsb2MoYmluZGluZy5jcnlwdG9fZ2VuZXJpY2hhc2hfU1RBVEVCWVRFUykKCiAgICBleHBvcnRzLmNyeXB0b19nZW5lcmljaGFzaF9pbml0KHN0YXRlLCBrZXksIG91dHB1dC5ieXRlTGVuZ3RoKQoKICAgIGZvciAoY29uc3QgYnVmIG9mIGJhdGNoKSB7CiAgICAgIGV4cG9ydHMuY3J5cHRvX2dlbmVyaWNoYXNoX3VwZGF0ZShzdGF0ZSwgYnVmKQogICAgfQoKICAgIGV4cG9ydHMuY3J5cHRvX2dlbmVyaWNoYXNoX2ZpbmFsKHN0YXRlLCBvdXRwdXQpCiAgfQp9CgpleHBvcnRzLmNyeXB0b19nZW5lcmljaGFzaF9rZXlnZW4gPSBmdW5jdGlvbiAoa2V5KSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fZ2VuZXJpY2hhc2hfa2V5Z2VuKAogICAga2V5LmJ1ZmZlciwKICAgIGtleS5ieXRlT2Zmc2V0LAogICAga2V5LmJ5dGVMZW5ndGgKICApCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2dlbmVyaWNoYXNoX2luaXQgPSBmdW5jdGlvbiAoc3RhdGUsIGtleSwgb3V0cHV0TGVuZ3RoKSB7CiAga2V5IHx8PSBPUFRJT05BTAoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19nZW5lcmljaGFzaF9pbml0KAogICAgc3RhdGUuYnVmZmVyLAogICAgc3RhdGUuYnl0ZU9mZnNldCwKICAgIHN0YXRlLmJ5dGVMZW5ndGgsCgogICAga2V5LmJ1ZmZlciwKICAgIGtleS5ieXRlT2Zmc2V0LAogICAga2V5LmJ5dGVMZW5ndGgsCgogICAgb3V0cHV0TGVuZ3RoCiAgKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fZ2VuZXJpY2hhc2hfdXBkYXRlID0gZnVuY3Rpb24gKHN0YXRlLCBpbnB1dCkgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2dlbmVyaWNoYXNoX3VwZGF0ZSgKICAgIHN0YXRlLmJ1ZmZlciwKICAgIHN0YXRlLmJ5dGVPZmZzZXQsCiAgICBzdGF0ZS5ieXRlTGVuZ3RoLAoKICAgIGlucHV0LmJ1ZmZlciwKICAgIGlucHV0LmJ5dGVPZmZzZXQsCiAgICBpbnB1dC5ieXRlTGVuZ3RoCiAgKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fZ2VuZXJpY2hhc2hfZmluYWwgPSBmdW5jdGlvbiAoc3RhdGUsIG91dHB1dCkgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2dlbmVyaWNoYXNoX2ZpbmFsKAogICAgc3RhdGUuYnVmZmVyLAogICAgc3RhdGUuYnl0ZU9mZnNldCwKICAgIHN0YXRlLmJ5dGVMZW5ndGgsCgogICAgb3V0cHV0LmJ1ZmZlciwKICAgIG91dHB1dC5ieXRlT2Zmc2V0LAogICAgb3V0cHV0LmJ5dGVMZW5ndGgKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgovLyBzZWNyZXRzdHJlYW0KCmV4cG9ydHMuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9rZXlnZW4gPSBmdW5jdGlvbiAoaykgewogIGJpbmRpbmcuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9rZXlnZW4oCiAgICBrLmJ1ZmZlciwKICAgIGsuYnl0ZU9mZnNldCwKICAgIGsuYnl0ZUxlbmd0aAogICkKfQoKZXhwb3J0cy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X2luaXRfcHVzaCA9IGZ1bmN0aW9uICgKICBzdGF0ZSwKICBoZWFkZXIsCiAgawopIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfaW5pdF9wdXNoKAogICAgc3RhdGUuYnVmZmVyLAogICAgc3RhdGUuYnl0ZU9mZnNldCwKICAgIHN0YXRlLmJ5dGVMZW5ndGgsCgogICAgaGVhZGVyLmJ1ZmZlciwKICAgIGhlYWRlci5ieXRlT2Zmc2V0LAogICAgaGVhZGVyLmJ5dGVMZW5ndGgsCgogICAgay5idWZmZXIsCiAgICBrLmJ5dGVPZmZzZXQsCiAgICBrLmJ5dGVMZW5ndGgKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfaW5pdF9wdWxsID0gZnVuY3Rpb24gKAogIHN0YXRlLAogIGhlYWRlciwKICBrCikgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9pbml0X3B1bGwoCiAgICBzdGF0ZS5idWZmZXIsCiAgICBzdGF0ZS5ieXRlT2Zmc2V0LAogICAgc3RhdGUuYnl0ZUxlbmd0aCwKCiAgICBoZWFkZXIuYnVmZmVyLAogICAgaGVhZGVyLmJ5dGVPZmZzZXQsCiAgICBoZWFkZXIuYnl0ZUxlbmd0aCwKCiAgICBrLmJ1ZmZlciwKICAgIGsuYnl0ZU9mZnNldCwKICAgIGsuYnl0ZUxlbmd0aAogICkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9wdXNoID0gZnVuY3Rpb24gKAogIHN0YXRlLAogIGMsCiAgbSwKICBhZCwKICB0YWcKKSB7CiAgYWQgfHw9IE9QVElPTkFMCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9wdXNoKAogICAgc3RhdGUuYnVmZmVyLAogICAgc3RhdGUuYnl0ZU9mZnNldCwKICAgIHN0YXRlLmJ5dGVMZW5ndGgsCgogICAgYy5idWZmZXIsCiAgICBjLmJ5dGVPZmZzZXQsCiAgICBjLmJ5dGVMZW5ndGgsCgogICAgbS5idWZmZXIsCiAgICBtLmJ5dGVPZmZzZXQsCiAgICBtLmJ5dGVMZW5ndGgsCgogICAgYWQuYnVmZmVyLAogICAgYWQuYnl0ZU9mZnNldCwKICAgIGFkLmJ5dGVMZW5ndGgsCgogICAgdGFnCiAgKQoKICBpZiAocmVzIDwgMCkgdGhyb3cgbmV3IEVycm9yKCdwdXNoIGZhaWxlZCcpCgogIHJldHVybiByZXMKfQoKZXhwb3J0cy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3B1bGwgPSBmdW5jdGlvbiAoCiAgc3RhdGUsCiAgbSwKICB0YWcsCiAgYywKICBhZAopIHsKICBhZCB8fD0gT1BUSU9OQUwKCiAgaWYgKGM/LmJ5dGVMZW5ndGggPCBiaW5kaW5nLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfQUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGNpcGhlciBsZW5ndGgnKQogIGlmICgKICAgIG0/LmJ5dGVMZW5ndGggIT09CiAgICBjLmJ5dGVMZW5ndGggLSBiaW5kaW5nLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfQUJZVEVTCiAgKQogICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIG1lc3NhZ2UgbGVuZ3RoJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3B1bGwoCiAgICBzdGF0ZS5idWZmZXIsCiAgICBzdGF0ZS5ieXRlT2Zmc2V0LAogICAgc3RhdGUuYnl0ZUxlbmd0aCwKCiAgICBtLmJ1ZmZlciwKICAgIG0uYnl0ZU9mZnNldCwKICAgIG0uYnl0ZUxlbmd0aCwKCiAgICB0YWcuYnVmZmVyLAogICAgdGFnLmJ5dGVPZmZzZXQsCiAgICB0YWcuYnl0ZUxlbmd0aCwKCiAgICBjLmJ1ZmZlciwKICAgIGMuYnl0ZU9mZnNldCwKICAgIGMuYnl0ZUxlbmd0aCwKCiAgICBhZC5idWZmZXIsCiAgICBhZC5ieXRlT2Zmc2V0LAogICAgYWQuYnl0ZUxlbmd0aAogICkKCiAgaWYgKHJlcyA8IDApIHRocm93IG5ldyBFcnJvcigncHVsbCBmYWlsZWQnKQoKICByZXR1cm4gcmVzCn0KCmV4cG9ydHMuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9yZWtleSA9IGZ1bmN0aW9uIChzdGF0ZSkgewogIGJpbmRpbmcuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9yZWtleSgKICAgIHN0YXRlLmJ1ZmZlciwKICAgIHN0YXRlLmJ5dGVPZmZzZXQsCiAgICBzdGF0ZS5ieXRlTGVuZ3RoCiAgKQp9CgovLyBjcnlwdG9fc3RyZWFtCgpleHBvcnRzLmNyeXB0b19zdHJlYW0gPSBmdW5jdGlvbiAoYywgbiwgaykgewogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fTk9OQ0VCWVRFUykgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW0oYywgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV94b3IgPSBmdW5jdGlvbiAoYywgbSwgbiwgaykgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94b3IoCiAgICBjLmJ1ZmZlciwKICAgIGMuYnl0ZU9mZnNldCwKICAgIGMuYnl0ZUxlbmd0aCwKCiAgICBtLmJ1ZmZlciwKICAgIG0uYnl0ZU9mZnNldCwKICAgIG0uYnl0ZUxlbmd0aCwKCiAgICBuLmJ1ZmZlciwKICAgIG4uYnl0ZU9mZnNldCwKICAgIG4uYnl0ZUxlbmd0aCwKCiAgICBrLmJ1ZmZlciwKICAgIGsuYnl0ZU9mZnNldCwKICAgIGsuYnl0ZUxlbmd0aAogICkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMCA9IGZ1bmN0aW9uIChjLCBuLCBrKSB7CiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwKGMsIG4sIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yID0gZnVuY3Rpb24gKGMsIG0sIG4sIGspIHsKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMuYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3IoYywgbSwgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3JfaWMgPSBmdW5jdGlvbiAoYywgbSwgbiwgaWMsIGspIHsKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMuYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3JfaWMoYywgbSwgbiwgaWMsIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0ZiA9IGZ1bmN0aW9uIChjLCBuLCBrKSB7CiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmKGMsIG4sIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3IgPSBmdW5jdGlvbiAoYywgbSwgbiwgaykgewogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcihjLCBtLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX2ljID0gZnVuY3Rpb24gKGMsIG0sIG4sIGljLCBrKSB7CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX2ljKGMsIG0sIG4sIGljLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMCA9IGZ1bmN0aW9uIChjLCBuLCBrKSB7CiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwKGMsIG4sIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvciA9IGZ1bmN0aW9uIChjLCBtLCBuLCBrKSB7CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yKGMsIG0sIG4sIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl9pYyA9IGZ1bmN0aW9uIChjLCBtLCBuLCBpYywgaykgewogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl9pYyhjLCBtLCBuLCBpYywgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9zYWxzYTIwID0gZnVuY3Rpb24gKGMsIG4sIGspIHsKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjAoYywgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvciA9IGZ1bmN0aW9uIChjLCBtLCBuLCBrKSB7CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yKGMsIG0sIG4sIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3JfaWMgPSBmdW5jdGlvbiAoYywgbSwgbiwgaWMsIGspIHsKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMuYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3JfaWMoYywgbSwgbiwgaWMsIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgovLyBjcnlwdG9fYXV0aAoKZXhwb3J0cy5jcnlwdG9fYXV0aCA9IGZ1bmN0aW9uIChvdXQsIGlucHV0LCBrKSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYXV0aF9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hdXRoX0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19hdXRoKG91dCwgaW5wdXQsIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19hdXRoX3ZlcmlmeSA9IGZ1bmN0aW9uIChoLCBpbnB1dCwgaykgewogIGlmIChoPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hdXRoX0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2gnKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hdXRoX0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICByZXR1cm4gYmluZGluZy5jcnlwdG9fYXV0aF92ZXJpZnkoaCwgaW5wdXQsIGspCn0KCi8vIGNyeXB0b19vbmV0aW1lYXV0aAoKZXhwb3J0cy5jcnlwdG9fb25ldGltZWF1dGggPSBmdW5jdGlvbiAob3V0LCBpbnB1dCwgaykgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoKG91dCwgaW5wdXQsIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19vbmV0aW1lYXV0aF9pbml0ID0gZnVuY3Rpb24gKHN0YXRlLCBrKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF9TVEFURUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fb25ldGltZWF1dGhfU1RBVEVCWVRFUycgYnl0ZXMiKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX2luaXQoc3RhdGUsIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19vbmV0aW1lYXV0aF91cGRhdGUgPSBmdW5jdGlvbiAoc3RhdGUsIGlucHV0KSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF9TVEFURUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fb25ldGltZWF1dGhfU1RBVEVCWVRFUycgYnl0ZXMiKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF91cGRhdGUoc3RhdGUsIGlucHV0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fb25ldGltZWF1dGhfZmluYWwgPSBmdW5jdGlvbiAoc3RhdGUsIG91dCkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfU1RBVEVCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnY3J5cHRvX29uZXRpbWVhdXRoX1NUQVRFQllURVMnIGJ5dGVzIikKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignb3V0JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfZmluYWwoc3RhdGUsIG91dCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX29uZXRpbWVhdXRoX3ZlcmlmeSA9IGZ1bmN0aW9uIChoLCBpbnB1dCwgaykgewogIGlmIChoPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdoJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICByZXR1cm4gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfdmVyaWZ5KGgsIGlucHV0LCBrKQp9CgovLyBjcnlwdG9fcHdoYXNoCgpleHBvcnRzLmNyeXB0b19wd2hhc2ggPSBmdW5jdGlvbiAob3V0LCBwYXNzd2QsIHNhbHQsIG9wc2xpbWl0LCBtZW1saW1pdCwgYWxnKSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9CWVRFU19NSU4pIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAob3V0Py5ieXRlTGVuZ3RoID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX0JZVEVTX01BWCkgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmIChzYWx0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfU0FMVEJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzYWx0JykKICBpZiAob3BzbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfT1BTTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfT1BTTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAobWVtbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAoYWxnIDwgMSB8fCBhbGcgPiAyKQogICAgdGhyb3cgbmV3IEVycm9yKCdhbGcgbXVzdCBiZSBlaXRoZXIgQXJnb24yaSAxLjMgb3IgQXJnb24yaWQgMS4zJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fcHdoYXNoKG91dCwgcGFzc3dkLCBzYWx0LCBvcHNsaW1pdCwgbWVtbGltaXQsIGFsZykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9hc3luYyA9IGZ1bmN0aW9uICgKICBvdXQsCiAgcGFzc3dkLAogIHNhbHQsCiAgb3BzbGltaXQsCiAgbWVtbGltaXQsCiAgYWxnLAogIGNhbGxiYWNrID0gdW5kZWZpbmVkCikgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfQllURVNfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKG91dD8uYnl0ZUxlbmd0aCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9CWVRFU19NQVgpIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoc2FsdD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX1NBTFRCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2FsdCcpCiAgaWYgKG9wc2xpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX09QU0xJTUlUX01JTikgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG9wc2xpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX09QU0xJTUlUX01BWCkgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG1lbWxpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX01FTUxJTUlUX01JTikgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCiAgaWYgKG1lbWxpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX01FTUxJTUlUX01BWCkgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCiAgaWYgKGFsZyA8IDEgfHwgYWxnID4gMikKICAgIHRocm93IG5ldyBFcnJvcignYWxnIG11c3QgYmUgZWl0aGVyIEFyZ29uMmkgMS4zIG9yIEFyZ29uMmlkIDEuMycpCgogIGNvbnN0IFtkb25lLCBwcm9taXNlXSA9IGNoZWNrU3RhdHVzKGNhbGxiYWNrKQoKICBiaW5kaW5nLmNyeXB0b19wd2hhc2hfYXN5bmMoCiAgICBvdXQuYnVmZmVyLAogICAgb3V0LmJ5dGVPZmZzZXQsCiAgICBvdXQuYnl0ZUxlbmd0aCwKCiAgICBwYXNzd2QuYnVmZmVyLAogICAgcGFzc3dkLmJ5dGVPZmZzZXQsCiAgICBwYXNzd2QuYnl0ZUxlbmd0aCwKCiAgICBzYWx0LmJ1ZmZlciwKICAgIHNhbHQuYnl0ZU9mZnNldCwKICAgIHNhbHQuYnl0ZUxlbmd0aCwKCiAgICBvcHNsaW1pdCwKICAgIG1lbWxpbWl0LAogICAgYWxnLAoKICAgIGRvbmUKICApCgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zdHIgPSBmdW5jdGlvbiAob3V0LCBwYXNzd2QsIG9wc2xpbWl0LCBtZW1saW1pdCkgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9TVFJCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmICh0eXBlb2Ygb3BzbGltaXQgIT09ICdudW1iZXInKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfT1BTTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfT1BTTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAodHlwZW9mIG1lbWxpbWl0ICE9PSAnbnVtYmVyJykgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCiAgaWYgKG1lbWxpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX01FTUxJTUlUX01JTikgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCiAgaWYgKG1lbWxpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX01FTUxJTUlUX01BWCkgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zdHIob3V0LCBwYXNzd2QsIG9wc2xpbWl0LCBtZW1saW1pdCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zdHJfYXN5bmMgPSBmdW5jdGlvbiAoCiAgb3V0LAogIHBhc3N3ZCwKICBvcHNsaW1pdCwKICBtZW1saW1pdCwKICBjYWxsYmFjayA9IHVuZGVmaW5lZAopIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfU1RSQllURVMpIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoIXBhc3N3ZD8uYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdwYXNzd2QnKQogIGlmICh0eXBlb2Ygb3BzbGltaXQgIT09ICdudW1iZXInKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfT1BTTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfT1BTTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAodHlwZW9mIG1lbWxpbWl0ICE9PSAnbnVtYmVyJykgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCiAgaWYgKG1lbWxpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX01FTUxJTUlUX01JTikgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCiAgaWYgKG1lbWxpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX01FTUxJTUlUX01BWCkgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCgogIGNvbnN0IFtkb25lLCBwcm9taXNlXSA9IGNoZWNrU3RhdHVzKGNhbGxiYWNrKQoKICBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc3RyX2FzeW5jKAogICAgb3V0LmJ1ZmZlciwKICAgIG91dC5ieXRlT2Zmc2V0LAogICAgb3V0LmJ5dGVMZW5ndGgsCgogICAgcGFzc3dkLmJ1ZmZlciwKICAgIHBhc3N3ZC5ieXRlT2Zmc2V0LAogICAgcGFzc3dkLmJ5dGVMZW5ndGgsCgogICAgb3BzbGltaXQsCiAgICBtZW1saW1pdCwKCiAgICBkb25lCiAgKQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc3RyX3ZlcmlmeSA9IGZ1bmN0aW9uIChzdHIsIHBhc3N3ZCkgewogIGlmIChzdHI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9TVFJCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdzdHInKQoKICByZXR1cm4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3N0cl92ZXJpZnkoc3RyLCBwYXNzd2QpCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zdHJfdmVyaWZ5X2FzeW5jID0gZnVuY3Rpb24gKAogIHN0ciwKICBwYXNzd2QsCiAgY2FsbGJhY2sgPSB1bmRlZmluZWQKKSB7CiAgaWYgKHN0cj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX1NUUkJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3N0cicpCiAgaWYgKCFwYXNzd2Q/LmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcigncGFzc3dkJykKCiAgY29uc3QgW2RvbmUsIHByb21pc2VdID0gY2hlY2tTdGF0dXMoY2FsbGJhY2ssIHRydWUpCgogIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zdHJfdmVyaWZ5X2FzeW5jKAogICAgc3RyLmJ1ZmZlciwKICAgIHN0ci5ieXRlT2Zmc2V0LAogICAgc3RyLmJ5dGVMZW5ndGgsCgogICAgcGFzc3dkLmJ1ZmZlciwKICAgIHBhc3N3ZC5ieXRlT2Zmc2V0LAogICAgcGFzc3dkLmJ5dGVMZW5ndGgsCgogICAgZG9uZQogICkKCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3N0cl9uZWVkc19yZWhhc2ggPSBmdW5jdGlvbiAoc3RyLCBvcHNsaW1pdCwgbWVtbGltaXQpIHsKICBpZiAoc3RyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfU1RSQllURVMpIHRocm93IG5ldyBFcnJvcignc3RyJykKICBpZiAob3BzbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfT1BTTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfT1BTTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAobWVtbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKCiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zdHJfbmVlZHNfcmVoYXNoKHN0ciwgb3BzbGltaXQsIG1lbWxpbWl0KQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTYgPSBmdW5jdGlvbiAoCiAgb3V0LAogIHBhc3N3ZCwKICBzYWx0LAogIG9wc2xpbWl0LAogIG1lbWxpbWl0CikgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfQllURVNfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmIChvdXQ/LmJ5dGVMZW5ndGggPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfQllURVNfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmIChzYWx0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfU0FMVEJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzYWx0JykKICBpZiAob3BzbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfT1BTTElNSVRfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG9wc2xpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X09QU0xJTUlUX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChtZW1saW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9NRU1MSU1JVF9NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfTUVNTElNSVRfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1NigKICAgIG91dCwKICAgIHBhc3N3ZCwKICAgIHNhbHQsCiAgICBvcHNsaW1pdCwKICAgIG1lbWxpbWl0CiAgKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X2FzeW5jID0gZnVuY3Rpb24gKAogIG91dCwKICBwYXNzd2QsCiAgc2FsdCwKICBvcHNsaW1pdCwKICBtZW1saW1pdCwKICBjYWxsYmFjayA9IHVuZGVmaW5lZAopIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoIDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X0JZVEVTX01JTikKICAgIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAob3V0Py5ieXRlTGVuZ3RoID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X0JZVEVTX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoIXBhc3N3ZD8uYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdwYXNzd2QnKQogIGlmIChzYWx0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfU0FMVEJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzYWx0JykKICBpZiAob3BzbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfT1BTTElNSVRfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG9wc2xpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X09QU0xJTUlUX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChtZW1saW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9NRU1MSU1JVF9NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfTUVNTElNSVRfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCgogIGNvbnN0IFtkb25lLCBwcm9taXNlXSA9IGNoZWNrU3RhdHVzKGNhbGxiYWNrKQoKICBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfYXN5bmMoCiAgICBvdXQuYnVmZmVyLAogICAgb3V0LmJ5dGVPZmZzZXQsCiAgICBvdXQuYnl0ZUxlbmd0aCwKCiAgICBwYXNzd2QuYnVmZmVyLAogICAgcGFzc3dkLmJ5dGVPZmZzZXQsCiAgICBwYXNzd2QuYnl0ZUxlbmd0aCwKCiAgICBzYWx0LmJ1ZmZlciwKICAgIHNhbHQuYnl0ZU9mZnNldCwKICAgIHNhbHQuYnl0ZUxlbmd0aCwKCiAgICBvcHNsaW1pdCwKICAgIG1lbWxpbWl0LAoKICAgIGRvbmUKICApCgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHJfYXN5bmMgPSBmdW5jdGlvbiAoCiAgb3V0LAogIHBhc3N3ZCwKICBvcHNsaW1pdCwKICBtZW1saW1pdCwKICBjYWxsYmFjayA9IHVuZGVmaW5lZAopIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfU1RSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKCFwYXNzd2Q/LmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcigncGFzc3dkJykKICBpZiAob3BzbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfT1BTTElNSVRfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG9wc2xpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X09QU0xJTUlUX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChtZW1saW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9NRU1MSU1JVF9NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfTUVNTElNSVRfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCgogIGNvbnN0IFtkb25lLCBwcm9taXNlXSA9IGNoZWNrU3RhdHVzKGNhbGxiYWNrKQoKICBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfc3RyX2FzeW5jKAogICAgb3V0LmJ1ZmZlciwKICAgIG91dC5ieXRlT2Zmc2V0LAogICAgb3V0LmJ5dGVMZW5ndGgsCgogICAgcGFzc3dkLmJ1ZmZlciwKICAgIHBhc3N3ZC5ieXRlT2Zmc2V0LAogICAgcGFzc3dkLmJ5dGVMZW5ndGgsCgogICAgb3BzbGltaXQsCiAgICBtZW1saW1pdCwKCiAgICBkb25lCiAgKQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfc3RyID0gZnVuY3Rpb24gKAogIG91dCwKICBwYXNzd2QsCiAgb3BzbGltaXQsCiAgbWVtbGltaXQKKSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X1NUUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmICghcGFzc3dkPy5ieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ3Bhc3N3ZCcpCiAgaWYgKG9wc2xpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X09QU0xJTUlUX01JTikKICAgIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9PUFNMSU1JVF9NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAobWVtbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfTUVNTElNSVRfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCiAgaWYgKG1lbWxpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X01FTUxJTUlUX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfc3RyKAogICAgb3V0LAogICAgcGFzc3dkLAogICAgb3BzbGltaXQsCiAgICBtZW1saW1pdAogICkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHJfdmVyaWZ5X2FzeW5jID0gZnVuY3Rpb24gKAogIHN0ciwKICBwYXNzd2QsCiAgY2FsbGJhY2sgPSB1bmRlZmluZWQKKSB7CiAgaWYgKHN0cj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X1NUUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzdHInKQogIGlmICghcGFzc3dkPy5ieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ3Bhc3N3ZCcpCgogIGNvbnN0IFtkb25lLCBwcm9taXNlXSA9IGNoZWNrU3RhdHVzKGNhbGxiYWNrLCB0cnVlKQoKICBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfc3RyX3ZlcmlmeV9hc3luYygKICAgIHN0ci5idWZmZXIsCiAgICBzdHIuYnl0ZU9mZnNldCwKICAgIHN0ci5ieXRlTGVuZ3RoLAoKICAgIHBhc3N3ZC5idWZmZXIsCiAgICBwYXNzd2QuYnl0ZU9mZnNldCwKICAgIHBhc3N3ZC5ieXRlTGVuZ3RoLAoKICAgIGRvbmUKICApCgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHJfdmVyaWZ5ID0gZnVuY3Rpb24gKHN0ciwgcGFzc3dkKSB7CiAgaWYgKHN0cj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X1NUUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzdHInKQogIGlmICghcGFzc3dkPy5ieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ3Bhc3N3ZCcpCgogIHJldHVybiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfc3RyX3ZlcmlmeShzdHIsIHBhc3N3ZCkKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X3N0cl9uZWVkc19yZWhhc2ggPSBmdW5jdGlvbiAoCiAgc3RyLAogIG9wc2xpbWl0LAogIG1lbWxpbWl0CikgewogIGlmIChzdHI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9TVFJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc3RyJykKICBpZiAob3BzbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfT1BTTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfT1BTTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAobWVtbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKCiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHJfbmVlZHNfcmVoYXNoKAogICAgc3RyLAogICAgb3BzbGltaXQsCiAgICBtZW1saW1pdAogICkKfQoKLy8gY3J5cHRvX2t4CgpleHBvcnRzLmNyeXB0b19reF9rZXlwYWlyID0gZnVuY3Rpb24gKHBrLCBzaykgewogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfUFVCTElDS0VZQllURVMpIHRocm93IG5ldyBFcnJvcigncGsnKQogIGlmIChzaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfU0VDUkVUS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignc2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19reF9rZXlwYWlyKHBrLCBzaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2t4X3NlZWRfa2V5cGFpciA9IGZ1bmN0aW9uIChwaywgc2ssIHNlZWQpIHsKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1BVQkxJQ0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKICBpZiAoc2s/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1NFQ1JFVEtFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3NrJykKICBpZiAoc2VlZD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfU0VFREJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3NlZWQnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19reF9zZWVkX2tleXBhaXIocGssIHNrLCBzZWVkKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fa3hfY2xpZW50X3Nlc3Npb25fa2V5cyA9IGZ1bmN0aW9uICgKICByeCwKICB0eCwKICBjbGllbnRQaywKICBjbGllbnRTaywKICBzZXJ2ZXJQawopIHsKICAvLyBtYXRjaCBgc3RkOjpvcHRpb25hbGAgYnkgY29lcmNpbmcgbnVsbCB0byB1bmRlZmluZWQKICByeCA/Pz0gdW5kZWZpbmVkCiAgdHggPz89IHVuZGVmaW5lZAoKICBpZiAoIXJ4ICYmICF0eCkgdGhyb3cgbmV3IEVycm9yKCdhdCBsZWFzdCBvbmUgc2Vzc2lvbiBrZXkgbXVzdCBiZSBzcGVjaWZpZWQnKQoKICBpZiAocngpIHsKICAgIGlmIChyeD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfU0VTU0lPTktFWUJZVEVTKQogICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgJ3JlY2VpdmluZyBrZXkgYnVmZmVyIG11c3QgYmUgImNyeXB0b19reF9TRVNTSU9OS0VZQllURVMiIGJ5dGVzIG9yIG51bGwnCiAgICAgICkKICB9IGVsc2UgewogICAgaWYgKHR4Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9TRVNTSU9OS0VZQllURVMpCiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAndHJhbnNtaXR0aW5nIGtleSBidWZmZXIgbXVzdCBiZSAiY3J5cHRvX2t4X1NFU1NJT05LRVlCWVRFUyIgYnl0ZXMgb3IgbnVsbCcKICAgICAgKQogIH0KCiAgaWYgKGNsaWVudFBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignY2xpZW50X3BrJykKICBpZiAoY2xpZW50U2s/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1NFQ1JFVEtFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdjbGllbnRfc2snKQogIGlmIChzZXJ2ZXJQaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NlcnZlcl9waycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2t4X2NsaWVudF9zZXNzaW9uX2tleXMoCiAgICByeCwKICAgIHR4LAogICAgY2xpZW50UGssCiAgICBjbGllbnRTaywKICAgIHNlcnZlclBrCiAgKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fa3hfc2VydmVyX3Nlc3Npb25fa2V5cyA9IGZ1bmN0aW9uICgKICByeCwKICB0eCwKICBzZXJ2ZXJQaywKICBzZXJ2ZXJTaywKICBjbGllbnRQawopIHsKICByeCA/Pz0gdW5kZWZpbmVkCiAgdHggPz89IHVuZGVmaW5lZAoKICBpZiAoIXJ4ICYmICF0eCkgdGhyb3cgbmV3IEVycm9yKCdhdCBsZWFzdCBvbmUgc2Vzc2lvbiBrZXkgbXVzdCBiZSBzcGVjaWZpZWQnKQoKICBpZiAocngpIHsKICAgIGlmIChyeD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfU0VTU0lPTktFWUJZVEVTKQogICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgJ3JlY2VpdmluZyBrZXkgYnVmZmVyIG11c3QgYmUgImNyeXB0b19reF9TRVNTSU9OS0VZQllURVMiIGJ5dGVzIG9yIG51bGwnCiAgICAgICkKICB9IGVsc2UgewogICAgaWYgKHR4Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9TRVNTSU9OS0VZQllURVMpCiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAndHJhbnNtaXR0aW5nIGtleSBidWZmZXIgbXVzdCBiZSAiY3J5cHRvX2t4X1NFU1NJT05LRVlCWVRFUyIgYnl0ZXMgb3IgbnVsbCcKICAgICAgKQogIH0KCiAgaWYgKHNlcnZlclBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2VydmVyX3BrJykKICBpZiAoc2VydmVyU2s/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1NFQ1JFVEtFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzZXJ2ZXJfc2snKQogIGlmIChjbGllbnRQaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NsaWVudF9waycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2t4X3NlcnZlcl9zZXNzaW9uX2tleXMoCiAgICByeCwKICAgIHR4LAogICAgc2VydmVyUGssCiAgICBzZXJ2ZXJTaywKICAgIGNsaWVudFBrCiAgKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKLy8gY3J5cHRvX3NjYWxhcm11bHQKCmV4cG9ydHMuY3J5cHRvX3NjYWxhcm11bHRfYmFzZSA9IGZ1bmN0aW9uIChxLCBuKSB7CiAgaWYgKHE/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfQllURVMpIHRocm93IG5ldyBFcnJvcigncScpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2Jhc2UocSwgbikKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NjYWxhcm11bHQgPSBmdW5jdGlvbiAocSwgbiwgcCkgewogIGlmIChxPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3EnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAocD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdwJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdChxLCBuLCBwKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X2Jhc2UgPSBmdW5jdGlvbiAocSwgbikgewogIGlmIChxPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3EnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfYmFzZShxLCBuKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5ID0gZnVuY3Rpb24gKHEsIG4sIHApIHsKICBpZiAocT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdxJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAocD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5KHEsIG4sIHApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19jb3JlX2VkMjU1MTlfaXNfdmFsaWRfcG9pbnQgPSBmdW5jdGlvbiAocCkgewogIGlmIChwPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfQllURVMpIHRocm93IG5ldyBFcnJvcigncCcpCgogIHJldHVybiBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfaXNfdmFsaWRfcG9pbnQocCkKfQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X2Zyb21fdW5pZm9ybSA9IGZ1bmN0aW9uIChwLCByKSB7CiAgaWYgKHA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdwJykKICBpZiAocj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1VOSUZPUk1CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncicpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9mcm9tX3VuaWZvcm0ocCwgcikKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9iYXNlX25vY2xhbXAgPSBmdW5jdGlvbiAocSwgbikgewogIGlmIChxPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3EnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfYmFzZV9ub2NsYW1wKHEsIG4pCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfbm9jbGFtcCA9IGZ1bmN0aW9uIChxLCBuLCBwKSB7CiAgaWYgKHE/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncScpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKHA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9ub2NsYW1wKHEsIG4sIHApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgovLyBjcnlwdG9fY29yZQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X2FkZCA9IGZ1bmN0aW9uIChyLCBwLCBxKSB7CiAgaWYgKHI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdyJykKICBpZiAocD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3AnKQogIGlmIChxPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfQllURVMpIHRocm93IG5ldyBFcnJvcigncScpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9hZGQociwgcCwgcSkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9zdWIgPSBmdW5jdGlvbiAociwgcCwgcSkgewogIGlmIChyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfQllURVMpIHRocm93IG5ldyBFcnJvcigncicpCiAgaWYgKHA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdwJykKICBpZiAocT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3EnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfc3ViKHIsIHAsIHEpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX3JhbmRvbSA9IGZ1bmN0aW9uIChyKSB7CiAgaWYgKHI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncicpCgogIGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfcmFuZG9tKHIpCn0KCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfcmVkdWNlID0gZnVuY3Rpb24gKHIsIHMpIHsKICBpZiAocj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdyJykKICBpZiAocz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X05PTlJFRFVDRURTQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncycpCgogIGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfcmVkdWNlKHIsIHMpCn0KCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfaW52ZXJ0ID0gZnVuY3Rpb24gKHJlY2lwLCBzKSB7CiAgaWYgKHJlY2lwPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3JlY2lwJykKICBpZiAocz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzJykKCiAgYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9pbnZlcnQocmVjaXAsIHMpCn0KCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfbmVnYXRlID0gZnVuY3Rpb24gKG5lZywgcykgewogIGlmIChuZWc/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbmVnJykKICBpZiAocz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzJykKCiAgYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9uZWdhdGUobmVnLCBzKQp9CgpleHBvcnRzLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX2NvbXBsZW1lbnQgPSBmdW5jdGlvbiAoY29tcCwgcykgewogIGlmIChjb21wPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvbXAnKQogIGlmIChzPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3MnKQoKICBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX2NvbXBsZW1lbnQoY29tcCwgcykKfQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9hZGQgPSBmdW5jdGlvbiAoeiwgeCwgeSkgewogIGlmICh6Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3onKQogIGlmICh4Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3gnKQogIGlmICh5Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3knKQoKICBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX2FkZCh6LCB4LCB5KQp9CgpleHBvcnRzLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX3N1YiA9IGZ1bmN0aW9uICh6LCB4LCB5KSB7CiAgaWYgKHo/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigneicpCiAgaWYgKHg/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigneCcpCiAgaWYgKHk/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigneScpCgogIGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfc3ViKHosIHgsIHkpCn0KCi8vIGNyeXB0b19zaG9ydGhhc2gKCmV4cG9ydHMuY3J5cHRvX3Nob3J0aGFzaCA9IGZ1bmN0aW9uIChvdXQsIGlucHV0LCBrKSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2hvcnRoYXNoX0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3Nob3J0aGFzaF9LRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2hvcnRoYXNoKG91dCwgaW5wdXQsIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgovLyBjcnlwdG9fa2RmCgpleHBvcnRzLmNyeXB0b19rZGZfa2V5Z2VuID0gZnVuY3Rpb24gKGtleSkgewogIGlmIChrZXk/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2tkZl9LRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdrZXknKQoKICBiaW5kaW5nLmNyeXB0b19rZGZfa2V5Z2VuKGtleSkKfQoKZXhwb3J0cy5jcnlwdG9fa2RmX2Rlcml2ZV9mcm9tX2tleSA9IGZ1bmN0aW9uIChzdWJrZXksIHN1YmtleUlkLCBjdHgsIGtleSkgewogIGlmIChzdWJrZXk/LmJ5dGVMZW5ndGggPCBiaW5kaW5nLmNyeXB0b19rZGZfQllURVNfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdzdWJrZXknKQogIGlmIChzdWJrZXk/LmJ5dGVMZW5ndGggPiBiaW5kaW5nLmNyeXB0b19rZGZfQllURVNfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdzdWJrZXknKQogIGlmIChjdHg/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2tkZl9DT05URVhUQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2N0eCcpCiAgaWYgKGtleT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa2RmX0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2tleScpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2tkZl9kZXJpdmVfZnJvbV9rZXkoc3Via2V5LCBzdWJrZXlJZCwgY3R4LCBrZXkpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgovLyBjcnlwdG9faGFzaAoKZXhwb3J0cy5jcnlwdG9faGFzaCA9IGZ1bmN0aW9uIChvdXQsIGlucHV0KSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9faGFzaF9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19oYXNoKG91dCwgaW5wdXQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19oYXNoX3NoYTI1NiA9IGZ1bmN0aW9uIChvdXQsIGlucHV0KSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9faGFzaF9zaGEyNTZfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhMjU2KG91dCwgaW5wdXQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19oYXNoX3NoYTI1Nl9pbml0ID0gZnVuY3Rpb24gKHN0YXRlKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTI1Nl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ2NyeXB0b19oYXNoX3NoYTI1Nl9TVEFURUJZVEVTJyBieXRlcyIpCiAgfQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTI1Nl9pbml0KHN0YXRlKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9faGFzaF9zaGEyNTZfdXBkYXRlID0gZnVuY3Rpb24gKHN0YXRlLCBpbnB1dCkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9faGFzaF9zaGEyNTZfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdjcnlwdG9faGFzaF9zaGEyNTZfU1RBVEVCWVRFUycgYnl0ZXMiKQogIH0KCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9faGFzaF9zaGEyNTZfdXBkYXRlKHN0YXRlLCBpbnB1dCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2hhc2hfc2hhMjU2X2ZpbmFsID0gZnVuY3Rpb24gKHN0YXRlLCBvdXQpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhMjU2X1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnY3J5cHRvX2hhc2hfc2hhMjU2X1NUQVRFQllURVMnIGJ5dGVzIikKICB9CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9faGFzaF9zaGEyNTZfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3N0YXRlJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9faGFzaF9zaGEyNTZfZmluYWwoc3RhdGUsIG91dCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2hhc2hfc2hhNTEyID0gZnVuY3Rpb24gKG91dCwgaW5wdXQpIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTUxMl9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignb3V0JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9faGFzaF9zaGE1MTIob3V0LCBpbnB1dCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2hhc2hfc2hhNTEyX2luaXQgPSBmdW5jdGlvbiAoc3RhdGUpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhNTEyX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnY3J5cHRvX2hhc2hfc2hhNTEyX1NUQVRFQllURVMnIGJ5dGVzIikKICB9CgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhNTEyX2luaXQoc3RhdGUpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19oYXNoX3NoYTUxMl91cGRhdGUgPSBmdW5jdGlvbiAoc3RhdGUsIGlucHV0KSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTUxMl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ2NyeXB0b19oYXNoX3NoYTUxMl9TVEFURUJZVEVTJyBieXRlcyIpCiAgfQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTUxMl91cGRhdGUoc3RhdGUsIGlucHV0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9faGFzaF9zaGE1MTJfZmluYWwgPSBmdW5jdGlvbiAoc3RhdGUsIG91dCkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9faGFzaF9zaGE1MTJfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdjcnlwdG9faGFzaF9zaGE1MTJfU1RBVEVCWVRFUycgYnl0ZXMiKQogIH0KICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTUxMl9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignb3V0JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9faGFzaF9zaGE1MTJfZmluYWwoc3RhdGUsIG91dCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCi8vIGNyeXB0b19hZWFkCgpleHBvcnRzLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfa2V5Z2VuID0gZnVuY3Rpb24gKGspIHsKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX2tleWdlbihrKQp9CgpleHBvcnRzLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfZW5jcnlwdCA9IGZ1bmN0aW9uICgKICBjLAogIG0sCiAgYWQsCiAgbnNlYyA9IG51bGwsCiAgbnB1YiwKICBrCikgewogIGFkID8/PSB1bmRlZmluZWQKICBpZiAobnNlYyAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCduc2VjIG11c3QgYWx3YXlzIGJlIHNldCB0byBudWxsJykKICBpZiAoCiAgICBjPy5ieXRlTGVuZ3RoICE9PQogICAgbS5ieXRlTGVuZ3RoICsgYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUwogICkKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgJ2MgbXVzdCAibS5ieXRlTGVuZ3RoICsgY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMiIGJ5dGVzJwogICAgKQogIGlmIChjPy5ieXRlTGVuZ3RoID4gMHhmZmZmZmZmZikKICAgIHRocm93IG5ldyBFcnJvcignYy5ieXRlTGVuZ3RoIG11c3QgYmUgYSAzMmJpdCBpbnRlZ2VyJykKICBpZiAobnB1Yj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX05QVUJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbnB1YicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0KAogICAgYywKICAgIG0sCiAgICBhZCwKICAgIG5wdWIsCiAgICBrCiAgKQogIGlmIChyZXMgPCAwKSB0aHJvdyBuZXcgRXJyb3IoJ2NvdWxkIG5vdCBlbmNyeXB0IGRhdGEnKQoKICByZXR1cm4gcmVzCn0KCmV4cG9ydHMuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9kZWNyeXB0ID0gZnVuY3Rpb24gKAogIG0sCiAgbnNlYyA9IG51bGwsCiAgYywKICBhZCwKICBucHViLAogIGsKKSB7CiAgYWQgPz89IHVuZGVmaW5lZAogIGlmIChuc2VjICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ25zZWMgbXVzdCBhbHdheXMgYmUgc2V0IHRvIG51bGwnKQogIGlmICgKICAgIG0/LmJ5dGVMZW5ndGggIT09CiAgICBjLmJ5dGVMZW5ndGggLSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTCiAgKQogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAnbSBtdXN0ICJjLmJ5dGVMZW5ndGggLSBjcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUyIgYnl0ZXMnCiAgICApCiAgaWYgKG0/LmJ5dGVMZW5ndGggPiAweGZmZmZmZmZmKQogICAgdGhyb3cgbmV3IEVycm9yKCdtLmJ5dGVMZW5ndGggbXVzdCBiZSBhIDMyYml0IGludGVnZXInKQogIGlmIChucHViPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfTlBVQkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCducHViJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHQoCiAgICBtLAogICAgYywKICAgIGFkLAogICAgbnB1YiwKICAgIGsKICApCiAgaWYgKHJlcyA8IDApIHRocm93IG5ldyBFcnJvcignY291bGQgbm90IHZlcmlmeSBkYXRhJykKCiAgcmV0dXJuIHJlcwp9CgpleHBvcnRzLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfZW5jcnlwdF9kZXRhY2hlZCA9IGZ1bmN0aW9uICgKICBjLAogIG1hYywKICBtLAogIGFkLAogIG5zZWMgPSBudWxsLAogIG5wdWIsCiAgawopIHsKICBhZCA/Pz0gdW5kZWZpbmVkCiAgaWYgKG5zZWMgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignbnNlYyBtdXN0IGFsd2F5cyBiZSBzZXQgdG8gbnVsbCcpCiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYyBtdXN0IGJlICJtLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobWFjPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdtYWMnKQogIGlmIChucHViPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfTlBVQkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCducHViJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX2VuY3J5cHRfZGV0YWNoZWQoCiAgICBjLAogICAgbWFjLAogICAgbSwKICAgIGFkLAogICAgbnB1YiwKICAgIGsKICApCiAgaWYgKHJlcyA8IDApIHRocm93IG5ldyBFcnJvcignY291bGQgbm90IGVuY3J5cHQgZGF0YScpCgogIHJldHVybiByZXMKfQoKZXhwb3J0cy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHRfZGV0YWNoZWQgPSBmdW5jdGlvbiAoCiAgbSwKICBuc2VjID0gbnVsbCwKICBjLAogIG1hYywKICBhZCwKICBucHViLAogIGsKKSB7CiAgYWQgPz89IHVuZGVmaW5lZAogIGlmIChuc2VjICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ25zZWMgbXVzdCBhbHdheXMgYmUgc2V0IHRvIG51bGwnKQogIGlmIChtPy5ieXRlTGVuZ3RoICE9PSBjLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG1hYz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbWFjJykKICBpZiAobnB1Yj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX05QVUJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbnB1YicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9kZWNyeXB0X2RldGFjaGVkKAogICAgbSwKICAgIGMsCiAgICBtYWMsCiAgICBhZCwKICAgIG5wdWIsCiAgICBrCiAgKQogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignY291bGQgbm90IHZlcmlmeSBkYXRhJykKfQoKZXhwb3J0cy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfa2V5Z2VuID0gZnVuY3Rpb24gKGspIHsKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9rZXlnZW4oaykKfQoKZXhwb3J0cy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfZW5jcnlwdCA9IGZ1bmN0aW9uICgKICBjLAogIG0sCiAgYWQsCiAgbnNlYyA9IG51bGwsCiAgbnB1YiwKICBrCikgewogIGFkID8/PSB1bmRlZmluZWQKICBpZiAobnNlYyAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCduc2VjIG11c3QgYWx3YXlzIGJlIHNldCB0byBudWxsJykKICBpZiAoCiAgICBjPy5ieXRlTGVuZ3RoICE9PQogICAgbS5ieXRlTGVuZ3RoICsgYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTCiAgKQogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAnYyBtdXN0ICJtLmJ5dGVMZW5ndGggKyBjcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTIiBieXRlcycKICAgICkKICBpZiAoYz8uYnl0ZUxlbmd0aCA+IDB4ZmZmZmZmZmYpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2MuYnl0ZUxlbmd0aCBtdXN0IGJlIGEgMzJiaXQgaW50ZWdlcicpCiAgaWYgKG5wdWI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX05QVUJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbnB1YicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfZW5jcnlwdCgKICAgIGMsCiAgICBtLAogICAgYWQsCiAgICBucHViLAogICAgawogICkKICBpZiAocmVzIDwgMCkgdGhyb3cgbmV3IEVycm9yKCdjb3VsZCBub3QgZW5jcnlwdCBkYXRhJykKCiAgcmV0dXJuIHJlcwp9CgpleHBvcnRzLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9kZWNyeXB0ID0gZnVuY3Rpb24gKAogIG0sCiAgbnNlYyA9IG51bGwsCiAgYywKICBhZCwKICBucHViLAogIGsKKSB7CiAgYWQgPz89IHVuZGVmaW5lZAogIGlmIChuc2VjICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ25zZWMgbXVzdCBhbHdheXMgYmUgc2V0IHRvIG51bGwnKQogIGlmICgKICAgIG0/LmJ5dGVMZW5ndGggIT09CiAgICBjLmJ5dGVMZW5ndGggLSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMKICApCiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICdtIG11c3QgImMuYnl0ZUxlbmd0aCAtIGNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMiIGJ5dGVzJwogICAgKQogIGlmIChtPy5ieXRlTGVuZ3RoID4gMHhmZmZmZmZmZikKICAgIHRocm93IG5ldyBFcnJvcignbS5ieXRlTGVuZ3RoIG11c3QgYmUgYSAzMmJpdCBpbnRlZ2VyJykKICBpZiAobnB1Yj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfTlBVQkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCducHViJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9kZWNyeXB0KAogICAgbSwKICAgIGMsCiAgICBhZCwKICAgIG5wdWIsCiAgICBrCiAgKQogIGlmIChyZXMgPCAwKSB0aHJvdyBuZXcgRXJyb3IoJ2NvdWxkIG5vdCB2ZXJpZnkgZGF0YScpCgogIHJldHVybiByZXMKfQoKZXhwb3J0cy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfZW5jcnlwdF9kZXRhY2hlZCA9IGZ1bmN0aW9uICgKICBjLAogIG1hYywKICBtLAogIGFkLAogIG5zZWMgPSBudWxsLAogIG5wdWIsCiAgawopIHsKICBhZCA/Pz0gdW5kZWZpbmVkCiAgaWYgKG5zZWMgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignbnNlYyBtdXN0IGFsd2F5cyBiZSBzZXQgdG8gbnVsbCcpCiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYyBtdXN0IGJlICJtLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobWFjPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21hYycpCiAgaWYgKG5wdWI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX05QVUJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbnB1YicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfZW5jcnlwdF9kZXRhY2hlZCgKICAgIGMsCiAgICBtYWMsCiAgICBtLAogICAgYWQsCiAgICBucHViLAogICAgawogICkKICBpZiAocmVzIDwgMCkgdGhyb3cgbmV3IEVycm9yKCdjb3VsZCBub3QgZW5jcnlwdCBkYXRhJykKCiAgcmV0dXJuIHJlcwp9CgpleHBvcnRzLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9kZWNyeXB0X2RldGFjaGVkID0gZnVuY3Rpb24gKAogIG0sCiAgbnNlYyA9IG51bGwsCiAgYywKICBtYWMsCiAgYWQsCiAgbnB1YiwKICBrCikgewogIGFkID8/PSB1bmRlZmluZWQKICBpZiAobnNlYyAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCduc2VjIG11c3QgYWx3YXlzIGJlIHNldCB0byBudWxsJykKICBpZiAobT8uYnl0ZUxlbmd0aCAhPT0gYy5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMuYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChtYWM/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbWFjJykKICBpZiAobnB1Yj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfTlBVQkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCducHViJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9kZWNyeXB0X2RldGFjaGVkKAogICAgbSwKICAgIGMsCiAgICBtYWMsCiAgICBhZCwKICAgIG5wdWIsCiAgICBrCiAgKQogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignY291bGQgbm90IHZlcmlmeSBkYXRhJykKfQoKLy8gY3J5cHRvX3N0cmVhbQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3hvcl93cmFwX2luaXQgPSBmdW5jdGlvbiAoc3RhdGUsIG4sIGspIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuc25fY3J5cHRvX3N0cmVhbV94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdzbl9jcnlwdG9fc3RyZWFtX3hvcl9TVEFURUJZVEVTJyBieXRlcyIpCiAgfQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fTk9OQ0VCWVRFUykgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1feG9yX3dyYXBfaW5pdChzdGF0ZSwgbiwgaykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3hvcl93cmFwX3VwZGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgYywgbSkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5zbl9jcnlwdG9fc3RyZWFtX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ3NuX2NyeXB0b19zdHJlYW1feG9yX1NUQVRFQllURVMnIGJ5dGVzIikKICB9CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYyBtdXN0IGJlICJtLmJ5dGVMZW5ndGgiIGJ5dGVzJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX3hvcl93cmFwX3VwZGF0ZShzdGF0ZSwgYywgbSkKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3hvcl93cmFwX2ZpbmFsID0gZnVuY3Rpb24gKHN0YXRlKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLnNuX2NyeXB0b19zdHJlYW1feG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnc25fY3J5cHRvX3N0cmVhbV94b3JfU1RBVEVCWVRFUycgYnl0ZXMiKQogIH0KCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX3hvcl93cmFwX2ZpbmFsKHN0YXRlKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX3dyYXBfaW5pdCA9IGZ1bmN0aW9uIChzdGF0ZSwgbiwgaykgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl93cmFwX2luaXQoc3RhdGUsIG4sIGspCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3Jfd3JhcF91cGRhdGUgPSBmdW5jdGlvbiAoc3RhdGUsIGMsIG0pIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAic3RhdGUgbXVzdCBiZSAnY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3JfU1RBVEVCWVRFUycgYnl0ZXMiCiAgICApCiAgfQogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2MgbXVzdCBiZSAibS5ieXRlTGVuZ3RoIiBieXRlcycpCgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3Jfd3JhcF91cGRhdGUoc3RhdGUsIGMsIG0pCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3Jfd3JhcF9maW5hbCA9IGZ1bmN0aW9uIChzdGF0ZSkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3Jfd3JhcF9maW5hbChzdGF0ZSkKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX3dyYXBfaW5pdCA9IGZ1bmN0aW9uIChzdGF0ZSwgbiwgaykgewogIGlmICgKICAgIHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3JfU1RBVEVCWVRFUwogICkgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAic3RhdGUgbXVzdCBiZSAnY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl93cmFwX2luaXQoc3RhdGUsIG4sIGspCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl93cmFwX3VwZGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgYywgbSkgewogIGlmICgKICAgIHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3JfU1RBVEVCWVRFUwogICkgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAic3RhdGUgbXVzdCBiZSAnY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYyBtdXN0IGJlICJtLmJ5dGVMZW5ndGgiIGJ5dGVzJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX3dyYXBfdXBkYXRlKHN0YXRlLCBjLCBtKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3Jfd3JhcF9maW5hbCA9IGZ1bmN0aW9uIChzdGF0ZSkgewogIGlmICgKICAgIHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3JfU1RBVEVCWVRFUwogICkgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAic3RhdGUgbXVzdCBiZSAnY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl93cmFwX2ZpbmFsKHN0YXRlKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl93cmFwX2luaXQgPSBmdW5jdGlvbiAoc3RhdGUsIG4sIGspIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl93cmFwX2luaXQoc3RhdGUsIG4sIGspCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX3dyYXBfdXBkYXRlID0gZnVuY3Rpb24gKHN0YXRlLCBjLCBtKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3JfU1RBVEVCWVRFUycgYnl0ZXMiCiAgICApCiAgfQogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2MgbXVzdCBiZSAibS5ieXRlTGVuZ3RoIiBieXRlcycpCgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX3dyYXBfdXBkYXRlKHN0YXRlLCBjLCBtKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl93cmFwX2ZpbmFsID0gZnVuY3Rpb24gKHN0YXRlKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3JfU1RBVEVCWVRFUycgYnl0ZXMiCiAgICApCiAgfQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl93cmFwX2ZpbmFsKHN0YXRlKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3Jfd3JhcF9pbml0ID0gZnVuY3Rpb24gKHN0YXRlLCBuLCBrKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAic3RhdGUgbXVzdCBiZSAnY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl93cmFwX2luaXQoc3RhdGUsIG4sIGspCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl93cmFwX3VwZGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgYywgbSkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3JfU1RBVEVCWVRFUycgYnl0ZXMiCiAgICApCiAgfQogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2MgbXVzdCBiZSAibS5ieXRlTGVuZ3RoIiBieXRlcycpCgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl93cmFwX3VwZGF0ZShzdGF0ZSwgYywgbSkKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX3dyYXBfZmluYWwgPSBmdW5jdGlvbiAoc3RhdGUpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX3dyYXBfZmluYWwoc3RhdGUpCn0KCi8vIGV4cGVyaW1lbnRhbAoKZXhwb3J0cy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9iYXNlID0gZnVuY3Rpb24gKG4sIHAsIG5zKSB7CiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChwPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwJykKCiAgYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9iYXNlKG4sIHAsIG5zKQp9CgpleHBvcnRzLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3NpZ25fZGV0YWNoZWQgPSBmdW5jdGlvbiAoc2lnLCBtLCBzY2FsYXIsIHBrKSB7CiAgaWYgKHNpZz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdzaWcnKQogIGlmIChzY2FsYXI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NjYWxhcicpCiAgaWYgKHBrICYmIHBrLmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9zaWduX2RldGFjaGVkKHNpZywgbSwgc2NhbGFyLCBwaykKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ2ZhaWxlZCB0byBjb21wdXRlIHNpZ25hdHVyZScpCn0KCmV4cG9ydHMuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfc2tfdG9fc2NhbGFyID0gZnVuY3Rpb24gKG4sIHNrKSB7CiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChzaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9TRUNSRVRLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2snKQoKICBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3NrX3RvX3NjYWxhcihuLCBzaykKfQoKZXhwb3J0cy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9zY2FsYXIgPSBmdW5jdGlvbiAoc2NhbGFyT3V0LCBzY2FsYXIsIG5zKSB7CiAgaWYgKHNjYWxhck91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2NhbGFyX291dCcpCiAgaWYgKHNjYWxhcj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2NhbGFyJykKCiAgYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9zY2FsYXIoc2NhbGFyT3V0LCBzY2FsYXIsIG5zKQp9CgpleHBvcnRzLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3BrID0gZnVuY3Rpb24gKHRwaywgcGssIG5zKSB7CiAgaWYgKHRwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigndHBrJykKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9wayh0cGssIHBrLCBucykKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ2ZhaWxlZCB0byB0d2VhayBwdWJsaWMga2V5JykKfQoKZXhwb3J0cy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9rZXlwYWlyID0gZnVuY3Rpb24gKAogIHBrLAogIHNjYWxhck91dCwKICBzY2FsYXJJbiwKICBucwopIHsKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKICBpZiAoc2NhbGFyT3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzY2FsYXJfb3V0JykKICBpZiAoc2NhbGFySW4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NjYWxhcl9pbicpCgogIGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfa2V5cGFpcihwaywgc2NhbGFyT3V0LCBzY2FsYXJJbiwgbnMpCn0KCmV4cG9ydHMuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfc2NhbGFyX2FkZCA9IGZ1bmN0aW9uIChzY2FsYXJPdXQsIHNjYWxhciwgbikgewogIGlmIChzY2FsYXJPdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NjYWxhcl9vdXQnKQogIGlmIChzY2FsYXI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NjYWxhcicpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQoKICBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3NjYWxhcl9hZGQoc2NhbGFyT3V0LCBzY2FsYXIsIG4pCn0KCmV4cG9ydHMuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfcGtfYWRkID0gZnVuY3Rpb24gKHRwaywgcGssIHApIHsKICBpZiAodHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd0cGsnKQogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQogIGlmIChwPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3AnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3BrX2FkZCh0cGssIHBrLCBwKQogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIGFkZCB0d2VhayB0byBwdWJsaWMga2V5JykKfQoKZXhwb3J0cy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9rZXlwYWlyX2FkZCA9IGZ1bmN0aW9uICgKICBwaywKICBzY2FsYXJPdXQsCiAgc2NhbGFySW4sCiAgdHdlYWsKKSB7CiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwaycpCiAgaWYgKHNjYWxhck91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2NhbGFyX291dCcpCiAgaWYgKHNjYWxhckluPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzY2FsYXJfaW4nKQogIGlmICh0d2Vhaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigndHdlYWsnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X2tleXBhaXJfYWRkKAogICAgcGssCiAgICBzY2FsYXJPdXQsCiAgICBzY2FsYXJJbiwKICAgIHR3ZWFrCiAgKQogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIGFkZCB0d2VhayB0byBrZXlwYWlyJykKfQoKZXhwb3J0cy5leHRlbnNpb25fcGJrZGYyX3NoYTUxMl9hc3luYyA9IGZ1bmN0aW9uICgKICBvdXQsCiAgcGFzc3dkLAogIHNhbHQsCiAgaXRlciwKICBvdXRsZW4sCiAgY2FsbGJhY2sgPSB1bmRlZmluZWQKKSB7CiAgaWYgKGl0ZXIgPCBiaW5kaW5nLmV4dGVuc2lvbl9wYmtkZjJfc2hhNTEyX0lURVJBVElPTlNfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdpdGVyYXRpb25zJykKICBpZiAob3V0bGVuID4gYmluZGluZy5leHRlbnNpb25fcGJrZGYyX3NoYTUxMl9CWVRFU19NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dGxlbicpCiAgaWYgKG91dD8uYnl0ZUxlbmd0aCA8IG91dGxlbikgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmICghb3V0Py5ieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKCFwYXNzd2Q/LmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcigncGFzc3dkJykKICBpZiAoIXNhbHQ/LmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcignc2FsdCcpCgogIGNvbnN0IFtkb25lLCBwcm9taXNlXSA9IGNoZWNrU3RhdHVzKGNhbGxiYWNrKQoKICBiaW5kaW5nLmV4dGVuc2lvbl9wYmtkZjJfc2hhNTEyX2FzeW5jKAogICAgb3V0LmJ1ZmZlciwKICAgIG91dC5ieXRlT2Zmc2V0LAogICAgb3V0LmJ5dGVMZW5ndGgsCgogICAgcGFzc3dkLmJ1ZmZlciwKICAgIHBhc3N3ZC5ieXRlT2Zmc2V0LAogICAgcGFzc3dkLmJ5dGVMZW5ndGgsCgogICAgc2FsdC5idWZmZXIsCiAgICBzYWx0LmJ5dGVPZmZzZXQsCiAgICBzYWx0LmJ5dGVMZW5ndGgsCgogICAgaXRlciwKICAgIG91dGxlbiwKCiAgICBkb25lCiAgKQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLmV4dGVuc2lvbl9wYmtkZjJfc2hhNTEyID0gZnVuY3Rpb24gKG91dCwgcGFzc3dkLCBzYWx0LCBpdGVyLCBvdXRsZW4pIHsKICBpZiAoaXRlciA8IGJpbmRpbmcuZXh0ZW5zaW9uX3Bia2RmMl9zaGE1MTJfSVRFUkFUSU9OU19NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2l0ZXJhdGlvbnMnKQogIGlmIChvdXRsZW4gPiBiaW5kaW5nLmV4dGVuc2lvbl9wYmtkZjJfc2hhNTEyX0JZVEVTX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignb3V0bGVuJykKICBpZiAob3V0Py5ieXRlTGVuZ3RoIDwgb3V0bGVuKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuZXh0ZW5zaW9uX3Bia2RmMl9zaGE1MTIob3V0LCBwYXNzd2QsIHNhbHQsIGl0ZXIsIG91dGxlbikKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdmYWlsZWQgdG8gYWRkIHR3ZWFrIHRvIHB1YmxpYyBrZXknKQp9CgpmdW5jdGlvbiBjaGVja1N0YXR1cyhjYWxsYmFjaywgYm9vbGVhblJlc3VsdCA9IGZhbHNlKSB7CiAgbGV0IGRvbmUsIHByb21pc2UKCiAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgewogICAgZG9uZSA9IGZ1bmN0aW9uIChzdGF0dXMpIHsKICAgICAgaWYgKGJvb2xlYW5SZXN1bHQpIGNhbGxiYWNrKG51bGwsIHN0YXR1cyA9PT0gMCkKICAgICAgZWxzZSBpZiAoc3RhdHVzID09PSAwKSBjYWxsYmFjayhudWxsKQogICAgICBlbHNlIGNhbGxiYWNrKG5ldyBFcnJvcignc3RhdHVzOiAnICsgc3RhdHVzKSkKICAgIH0KICB9IGVsc2UgewogICAgcHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgZG9uZSA9IGZ1bmN0aW9uIChzdGF0dXMpIHsKICAgICAgICBpZiAoYm9vbGVhblJlc3VsdCkgcmVzb2x2ZShzdGF0dXMgPT09IDApCiAgICAgICAgZWxzZSBpZiAoc3RhdHVzID09PSAwKSByZXNvbHZlKCkKICAgICAgICBlbHNlIHJlamVjdChuZXcgRXJyb3IoJ3N0YXR1czogJyArIHN0YXR1cykpCiAgICAgIH0KICAgIH0pCiAgfQoKICByZXR1cm4gW2RvbmUsIHByb21pc2VdCn0KewogICJuYW1lIjogInNvZGl1bS1uYXRpdmUiLAogICJ2ZXJzaW9uIjogIjUuMC4xMCIsCiAgImRlc2NyaXB0aW9uIjogIkxvdyBsZXZlbCBiaW5kaW5ncyBmb3IgbGlic29kaXVtIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJiaW5kaW5nLmNjIiwKICAgICJiaW5kaW5nLmpzIiwKICAgICJleHRlbnNpb25zIiwKICAgICJwcmVidWlsZHMiLAogICAgIkNNYWtlTGlzdHMudHh0IgogIF0sCiAgImFkZG9uIjogdHJ1ZSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgInJlcXVpcmUtYWRkb24iOiAiXjEuMS4wIiwKICAgICJ3aGljaC1ydW50aW1lIjogIl4xLjIuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1jb21wYXQtbmFwaSI6ICJeMS4zLjUiLAogICAgImJyaXR0bGUiOiAiXjMuMTYuMiIsCiAgICAiY21ha2UtYmFyZSI6ICJeMS42LjEiLAogICAgImNtYWtlLWZldGNoIjogIl4xLjQuMyIsCiAgICAiY21ha2UtbmFwaSI6ICJeMS4yLjEiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMS4wLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBucG0gcnVuIHRlc3Q6bm9kZSAmJiBucG0gcnVuIHRlc3Q6YmFyZSIsCiAgICAidGVzdDpub2RlIjogIm5vZGUgdGVzdC9hbGwuanMiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QvYWxsLmpzIgogIH0sCiAgInN0YW5kYXJkIjogewogICAgImlnbm9yZSI6IFsKICAgICAgIi90ZXN0L2ZpeHR1cmVzLyouanMiCiAgICBdCiAgfSwKICAiZW5naW5lcyI6IHsKICAgICJiYXJlIjogIj49MS4xNi4wIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NvZGl1bS1uYXRpdmUuZ2l0IgogIH0sCiAgImNvbnRyaWJ1dG9ycyI6IFsKICAgICJFbWlsIEJheSA8Z2l0aHViQHRpeHouZGs+IChodHRwOi8vYmF5ZXMuZGspIiwKICAgICJNYXRoaWFzIEJ1dXMgPG1hdGhpYXNidXVzQGdtYWlsLmNvbT4gKGh0dHBzOi8vbWFmaW50by5zaCkiLAogICAgIkNocmlzdG9waGUgRGllZGVyaWNocyA8Y2htLWRpZWRlcmljaHNAaHlwZXJkaXZpc2lvbi5kaz4iCiAgXSwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc29kaXVtLW5hdGl2ZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NvZGl1bS1uYXRpdmUiCn0KY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBBQllURVMgPSBzb2RpdW0uY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9BQllURVMKY29uc3QgVEFHX01FU1NBR0UgPSBzb2RpdW0uY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9UQUdfTUVTU0FHRQpjb25zdCBUQUdfRklOQUwgPSBzb2RpdW0uY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9UQUdfRklOQUwKY29uc3QgU1RBVEVCWVRFUyA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X1NUQVRFQllURVMKY29uc3QgSEVBREVSQllURVMgPSBzb2RpdW0uY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9IRUFERVJCWVRFUwpjb25zdCBLRVlCWVRFUyA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X0tFWUJZVEVTCmNvbnN0IFRBR19GSU5BTF9CWVRFID0gYjRhLmlzQnVmZmVyKFRBR19GSU5BTCkgPyBUQUdfRklOQUxbMF0gOiBUQUdfRklOQUwKCmNvbnN0IEVNUFRZID0gYjRhLmFsbG9jKDApCmNvbnN0IFRBRyA9IGI0YS5hbGxvYygxKQoKY2xhc3MgUHVzaCB7CiAgY29uc3RydWN0b3IgKGtleSwgc3RhdGUgPSBiNGEuYWxsb2NVbnNhZmVTbG93KFNUQVRFQllURVMpLCBoZWFkZXIgPSBiNGEuYWxsb2NVbnNhZmVTbG93KEhFQURFUkJZVEVTKSkgewogICAgaWYgKCFUQUdfRklOQUwpIHRocm93IG5ldyBFcnJvcignSmF2YVNjcmlwdCBzb2RpdW0gdmVyc2lvbiBuZWVkcyB0byBzdXBwb3J0IGNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seScpCgogICAgdGhpcy5rZXkgPSBrZXkKICAgIHRoaXMuc3RhdGUgPSBzdGF0ZQogICAgdGhpcy5oZWFkZXIgPSBoZWFkZXIKCiAgICBzb2RpdW0uY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9pbml0X3B1c2godGhpcy5zdGF0ZSwgdGhpcy5oZWFkZXIsIHRoaXMua2V5KQogIH0KCiAgbmV4dCAobWVzc2FnZSwgY2lwaGVyID0gYjRhLmFsbG9jVW5zYWZlKG1lc3NhZ2UuYnl0ZUxlbmd0aCArIEFCWVRFUykpIHsKICAgIHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3B1c2godGhpcy5zdGF0ZSwgY2lwaGVyLCBtZXNzYWdlLCBudWxsLCBUQUdfTUVTU0FHRSkKICAgIHJldHVybiBjaXBoZXIKICB9CgogIGZpbmFsIChtZXNzYWdlID0gRU1QVFksIGNpcGhlciA9IGI0YS5hbGxvY1Vuc2FmZShBQllURVMpKSB7CiAgICBzb2RpdW0uY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9wdXNoKHRoaXMuc3RhdGUsIGNpcGhlciwgbWVzc2FnZSwgbnVsbCwgVEFHX0ZJTkFMKQogICAgcmV0dXJuIGNpcGhlcgogIH0KfQoKY2xhc3MgUHVsbCB7CiAgY29uc3RydWN0b3IgKGtleSwgc3RhdGUgPSBiNGEuYWxsb2NVbnNhZmVTbG93KFNUQVRFQllURVMpKSB7CiAgICBpZiAoIVRBR19GSU5BTCkgdGhyb3cgbmV3IEVycm9yKCdKYXZhU2NyaXB0IHNvZGl1bSB2ZXJzaW9uIG5lZWRzIHRvIHN1cHBvcnQgY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5JykKCiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy5zdGF0ZSA9IHN0YXRlCiAgICB0aGlzLmZpbmFsID0gZmFsc2UKICB9CgogIGluaXQgKGhlYWRlcikgewogICAgc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfaW5pdF9wdWxsKHRoaXMuc3RhdGUsIGhlYWRlciwgdGhpcy5rZXkpCiAgfQoKICBuZXh0IChjaXBoZXIsIG1lc3NhZ2UgPSBiNGEuYWxsb2NVbnNhZmUoY2lwaGVyLmJ5dGVMZW5ndGggLSBBQllURVMpKSB7CiAgICBzb2RpdW0uY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9wdWxsKHRoaXMuc3RhdGUsIG1lc3NhZ2UsIFRBRywgY2lwaGVyLCBudWxsKQogICAgdGhpcy5maW5hbCA9IFRBR1swXSA9PT0gVEFHX0ZJTkFMX0JZVEUKICAgIHJldHVybiBtZXNzYWdlCiAgfQp9CgpmdW5jdGlvbiBrZXlnZW4gKGJ1ZiA9IGI0YS5hbGxvYyhLRVlCWVRFUykpIHsKICBzb2RpdW0uY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9rZXlnZW4oYnVmKQogIHJldHVybiBidWYKfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAga2V5Z2VuLAogIEtFWUJZVEVTLAogIEFCWVRFUywKICBTVEFURUJZVEVTLAogIEhFQURFUkJZVEVTLAogIFB1c2gsCiAgUHVsbAp9CnsKICAibmFtZSI6ICJzb2RpdW0tc2VjcmV0c3RyZWFtIiwKICAidmVyc2lvbiI6ICIxLjIuMCIsCiAgImRlc2NyaXB0aW9uIjogIldyYXBzIGxpYnNvZGl1bXMgc2VjcmV0c3RyZWFtIGluIGEgaGlnaGVyIGxldmVsIGFic3RyYWN0aW9uIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuMS4xIiwKICAgICJzb2RpdW0tdW5pdmVyc2FsIjogIl41LjAuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc29kaXVtLXNlY3JldHN0cmVhbS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc29kaXVtLXNlY3JldHN0cmVhbS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zb2RpdW0tc2VjcmV0c3RyZWFtIgp9Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnc29kaXVtLW5hdGl2ZScpCnsKICAibmFtZSI6ICJzb2RpdW0tdW5pdmVyc2FsIiwKICAidmVyc2lvbiI6ICI1LjAuMSIsCiAgImRlc2NyaXB0aW9uIjogIlVuaXZlcnNhbCB3cmFwcGVyIGZvciBzb2RpdW0tamF2YXNjcmlwdCBhbmQgc29kaXVtLW5hdGl2ZSB3b3JraW5nIGluIE5vZGUuanMgYW5kIHRoZSBCcm93c2VyIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJzb2RpdW0tbmF0aXZlIjogIl41LjAuMSIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzIjogewogICAgInNvZGl1bS1qYXZhc2NyaXB0IjogIn4wLjguMCIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzTWV0YSI6IHsKICAgICJzb2RpdW0tamF2YXNjcmlwdCI6IHsKICAgICAgIm9wdGlvbmFsIjogdHJ1ZQogICAgfQogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAicHJlcHVibGlzaCI6ICIuL2J1aWxkLXNjcmlwdHMvZ2VuZXJhdGUuanMiCiAgfSwKICAiYnJvd3NlciI6IHsKICAgICJzb2RpdW0tbmF0aXZlIjogInNvZGl1bS1qYXZhc2NyaXB0IgogIH0sCiAgImJyb3dzZXJpZnkiOiB7CiAgICAidHJhbnNmb3JtIjogWwogICAgICAiLi9idWlsZC1zY3JpcHRzL3RyYW5zZm9ybS5qcyIKICAgIF0KICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zb2RpdW0tdW5pdmVyc2FsLmdpdCIKICB9LAogICJrZXl3b3JkcyI6IFsKICAgICJsaWJzb2RpdW0iLAogICAgInNvZGl1bSIsCiAgICAic29kaXVtLW5hdGl2ZSIsCiAgICAic29kaXVtLWphdmFzY3JpcHQiLAogICAgImJyb3dzZXJpZnkiCiAgXSwKICAiY29udHJpYnV0b3JzIjogWwogICAgIkVtaWwgQmF5IDxnaXRodWJAdGl4ei5kaz4gKGh0dHA6Ly9iYXllcy5kaykiLAogICAgIk1hdGhpYXMgQnV1cyA8bWF0aGlhc2J1dXNAZ21haWwuY29tPiAoaHR0cHM6Ly9tYWZpbnRvLnNoKSIsCiAgICAiQ2hyaXN0b3BoZSBEaWVkZXJpY2hzIDxjaG0tZGllZGVyaWNoc0BoeXBlcmRpdmlzaW9uLmRrPiIKICBdLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zb2RpdW0tdW5pdmVyc2FsL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc29kaXVtLXVuaXZlcnNhbCNyZWFkbWUiCn0KY29uc3QgeyBFdmVudEVtaXR0ZXIgfSA9IHJlcXVpcmUoJ2V2ZW50cy11bml2ZXJzYWwnKQpjb25zdCBTVFJFQU1fREVTVFJPWUVEID0gbmV3IEVycm9yKCdTdHJlYW0gd2FzIGRlc3Ryb3llZCcpCmNvbnN0IFBSRU1BVFVSRV9DTE9TRSA9IG5ldyBFcnJvcignUHJlbWF0dXJlIGNsb3NlJykKCmNvbnN0IEZJRk8gPSByZXF1aXJlKCdmYXN0LWZpZm8nKQpjb25zdCBUZXh0RGVjb2RlciA9IHJlcXVpcmUoJ3RleHQtZGVjb2RlcicpCgovLyBpZiB3ZSBkbyBhIGZ1dHVyZSBtYWpvciwgZXhwZWN0IHF1ZXVlIG1pY3JvdGFzayB0byBiZSB0aGVyZSBhbHdheXMsIGZvciBub3cgYSBiaXQgZGVmZW5zaXZlCmNvbnN0IHFtdCA9IHR5cGVvZiBxdWV1ZU1pY3JvdGFzayA9PT0gJ3VuZGVmaW5lZCcgPyBmbiA9PiBnbG9iYWwucHJvY2Vzcy5uZXh0VGljayhmbikgOiBxdWV1ZU1pY3JvdGFzawoKLyogZXNsaW50LWRpc2FibGUgbm8tbXVsdGktc3BhY2VzICovCgovLyAyOSBiaXRzIHVzZWQgdG90YWwgKDQgZnJvbSBzaGFyZWQsIDE0IGZyb20gcmVhZCwgYW5kIDExIGZyb20gd3JpdGUpCmNvbnN0IE1BWCA9ICgoMSA8PCAyOSkgLSAxKQoKLy8gU2hhcmVkIHN0YXRlCmNvbnN0IE9QRU5JTkcgICAgICAgPSAwYjAwMDEKY29uc3QgUFJFREVTVFJPWUlORyA9IDBiMDAxMApjb25zdCBERVNUUk9ZSU5HICAgID0gMGIwMTAwCmNvbnN0IERFU1RST1lFRCAgICAgPSAwYjEwMDAKCmNvbnN0IE5PVF9PUEVOSU5HID0gTUFYIF4gT1BFTklORwpjb25zdCBOT1RfUFJFREVTVFJPWUlORyA9IE1BWCBeIFBSRURFU1RST1lJTkcKCi8vIFJlYWQgc3RhdGUgKDQgYml0IG9mZnNldCBmcm9tIHNoYXJlZCBzdGF0ZSkKY29uc3QgUkVBRF9BQ1RJVkUgICAgICAgICAgID0gMGIwMDAwMDAwMDAwMDAwMSA8PCA0CmNvbnN0IFJFQURfVVBEQVRJTkcgICAgICAgICA9IDBiMDAwMDAwMDAwMDAwMTAgPDwgNApjb25zdCBSRUFEX1BSSU1BUlkgICAgICAgICAgPSAwYjAwMDAwMDAwMDAwMTAwIDw8IDQKY29uc3QgUkVBRF9RVUVVRUQgICAgICAgICAgID0gMGIwMDAwMDAwMDAwMTAwMCA8PCA0CmNvbnN0IFJFQURfUkVTVU1FRCAgICAgICAgICA9IDBiMDAwMDAwMDAwMTAwMDAgPDwgNApjb25zdCBSRUFEX1BJUEVfRFJBSU5FRCAgICAgPSAwYjAwMDAwMDAwMTAwMDAwIDw8IDQKY29uc3QgUkVBRF9FTkRJTkcgICAgICAgICAgID0gMGIwMDAwMDAwMTAwMDAwMCA8PCA0CmNvbnN0IFJFQURfRU1JVF9EQVRBICAgICAgICA9IDBiMDAwMDAwMTAwMDAwMDAgPDwgNApjb25zdCBSRUFEX0VNSVRfUkVBREFCTEUgICAgPSAwYjAwMDAwMTAwMDAwMDAwIDw8IDQKY29uc3QgUkVBRF9FTUlUVEVEX1JFQURBQkxFID0gMGIwMDAwMTAwMDAwMDAwMCA8PCA0CmNvbnN0IFJFQURfRE9ORSAgICAgICAgICAgICA9IDBiMDAwMTAwMDAwMDAwMDAgPDwgNApjb25zdCBSRUFEX05FWFRfVElDSyAgICAgICAgPSAwYjAwMTAwMDAwMDAwMDAwIDw8IDQKY29uc3QgUkVBRF9ORUVEU19QVVNIICAgICAgID0gMGIwMTAwMDAwMDAwMDAwMCA8PCA0CmNvbnN0IFJFQURfUkVBRF9BSEVBRCAgICAgICA9IDBiMTAwMDAwMDAwMDAwMDAgPDwgNAoKLy8gQ29tYmluZWQgcmVhZCBzdGF0ZQpjb25zdCBSRUFEX0ZMT1dJTkcgPSBSRUFEX1JFU1VNRUQgfCBSRUFEX1BJUEVfRFJBSU5FRApjb25zdCBSRUFEX0FDVElWRV9BTkRfTkVFRFNfUFVTSCA9IFJFQURfQUNUSVZFIHwgUkVBRF9ORUVEU19QVVNICmNvbnN0IFJFQURfUFJJTUFSWV9BTkRfQUNUSVZFID0gUkVBRF9QUklNQVJZIHwgUkVBRF9BQ1RJVkUKY29uc3QgUkVBRF9FTUlUX1JFQURBQkxFX0FORF9RVUVVRUQgPSBSRUFEX0VNSVRfUkVBREFCTEUgfCBSRUFEX1FVRVVFRApjb25zdCBSRUFEX1JFU1VNRURfUkVBRF9BSEVBRCA9IFJFQURfUkVTVU1FRCB8IFJFQURfUkVBRF9BSEVBRAoKY29uc3QgUkVBRF9OT1RfQUNUSVZFICAgICAgICAgICAgID0gTUFYIF4gUkVBRF9BQ1RJVkUKY29uc3QgUkVBRF9OT05fUFJJTUFSWSAgICAgICAgICAgID0gTUFYIF4gUkVBRF9QUklNQVJZCmNvbnN0IFJFQURfTk9OX1BSSU1BUllfQU5EX1BVU0hFRCA9IE1BWCBeIChSRUFEX1BSSU1BUlkgfCBSRUFEX05FRURTX1BVU0gpCmNvbnN0IFJFQURfUFVTSEVEICAgICAgICAgICAgICAgICA9IE1BWCBeIFJFQURfTkVFRFNfUFVTSApjb25zdCBSRUFEX1BBVVNFRCAgICAgICAgICAgICAgICAgPSBNQVggXiBSRUFEX1JFU1VNRUQKY29uc3QgUkVBRF9OT1RfUVVFVUVEICAgICAgICAgICAgID0gTUFYIF4gKFJFQURfUVVFVUVEIHwgUkVBRF9FTUlUVEVEX1JFQURBQkxFKQpjb25zdCBSRUFEX05PVF9FTkRJTkcgICAgICAgICAgICAgPSBNQVggXiBSRUFEX0VORElORwpjb25zdCBSRUFEX1BJUEVfTk9UX0RSQUlORUQgICAgICAgPSBNQVggXiBSRUFEX0ZMT1dJTkcKY29uc3QgUkVBRF9OT1RfTkVYVF9USUNLICAgICAgICAgID0gTUFYIF4gUkVBRF9ORVhUX1RJQ0sKY29uc3QgUkVBRF9OT1RfVVBEQVRJTkcgICAgICAgICAgID0gTUFYIF4gUkVBRF9VUERBVElORwpjb25zdCBSRUFEX05PX1JFQURfQUhFQUQgICAgICAgICAgPSBNQVggXiBSRUFEX1JFQURfQUhFQUQKY29uc3QgUkVBRF9QQVVTRURfTk9fUkVBRF9BSEVBRCAgID0gTUFYIF4gUkVBRF9SRVNVTUVEX1JFQURfQUhFQUQKCi8vIFdyaXRlIHN0YXRlICgxOCBiaXQgb2Zmc2V0LCA0IGJpdCBvZmZzZXQgZnJvbSBzaGFyZWQgc3RhdGUgYW5kIDE0IGZyb20gcmVhZCBzdGF0ZSkKY29uc3QgV1JJVEVfQUNUSVZFICAgICA9IDBiMDAwMDAwMDAwMDEgPDwgMTgKY29uc3QgV1JJVEVfVVBEQVRJTkcgICA9IDBiMDAwMDAwMDAwMTAgPDwgMTgKY29uc3QgV1JJVEVfUFJJTUFSWSAgICA9IDBiMDAwMDAwMDAxMDAgPDwgMTgKY29uc3QgV1JJVEVfUVVFVUVEICAgICA9IDBiMDAwMDAwMDEwMDAgPDwgMTgKY29uc3QgV1JJVEVfVU5EUkFJTkVEICA9IDBiMDAwMDAwMTAwMDAgPDwgMTgKY29uc3QgV1JJVEVfRE9ORSAgICAgICA9IDBiMDAwMDAxMDAwMDAgPDwgMTgKY29uc3QgV1JJVEVfRU1JVF9EUkFJTiA9IDBiMDAwMDEwMDAwMDAgPDwgMTgKY29uc3QgV1JJVEVfTkVYVF9USUNLICA9IDBiMDAwMTAwMDAwMDAgPDwgMTgKY29uc3QgV1JJVEVfV1JJVElORyAgICA9IDBiMDAxMDAwMDAwMDAgPDwgMTgKY29uc3QgV1JJVEVfRklOSVNISU5HICA9IDBiMDEwMDAwMDAwMDAgPDwgMTgKY29uc3QgV1JJVEVfQ09SS0VEICAgICA9IDBiMTAwMDAwMDAwMDAgPDwgMTgKCmNvbnN0IFdSSVRFX05PVF9BQ1RJVkUgICAgPSBNQVggXiAoV1JJVEVfQUNUSVZFIHwgV1JJVEVfV1JJVElORykKY29uc3QgV1JJVEVfTk9OX1BSSU1BUlkgICA9IE1BWCBeIFdSSVRFX1BSSU1BUlkKY29uc3QgV1JJVEVfTk9UX0ZJTklTSElORyA9IE1BWCBeIChXUklURV9BQ1RJVkUgfCBXUklURV9GSU5JU0hJTkcpCmNvbnN0IFdSSVRFX0RSQUlORUQgICAgICAgPSBNQVggXiBXUklURV9VTkRSQUlORUQKY29uc3QgV1JJVEVfTk9UX1FVRVVFRCAgICA9IE1BWCBeIFdSSVRFX1FVRVVFRApjb25zdCBXUklURV9OT1RfTkVYVF9USUNLID0gTUFYIF4gV1JJVEVfTkVYVF9USUNLCmNvbnN0IFdSSVRFX05PVF9VUERBVElORyAgPSBNQVggXiBXUklURV9VUERBVElORwpjb25zdCBXUklURV9OT1RfQ09SS0VEICAgID0gTUFYIF4gV1JJVEVfQ09SS0VECgovLyBDb21iaW5lZCBzaGFyZWQgc3RhdGUKY29uc3QgQUNUSVZFID0gUkVBRF9BQ1RJVkUgfCBXUklURV9BQ1RJVkUKY29uc3QgTk9UX0FDVElWRSA9IE1BWCBeIEFDVElWRQpjb25zdCBET05FID0gUkVBRF9ET05FIHwgV1JJVEVfRE9ORQpjb25zdCBERVNUUk9ZX1NUQVRVUyA9IERFU1RST1lJTkcgfCBERVNUUk9ZRUQgfCBQUkVERVNUUk9ZSU5HCmNvbnN0IE9QRU5fU1RBVFVTID0gREVTVFJPWV9TVEFUVVMgfCBPUEVOSU5HCmNvbnN0IEFVVE9fREVTVFJPWSA9IERFU1RST1lfU1RBVFVTIHwgRE9ORQpjb25zdCBOT05fUFJJTUFSWSA9IFdSSVRFX05PTl9QUklNQVJZICYgUkVBRF9OT05fUFJJTUFSWQpjb25zdCBBQ1RJVkVfT1JfVElDS0lORyA9IFdSSVRFX05FWFRfVElDSyB8IFJFQURfTkVYVF9USUNLCmNvbnN0IFRJQ0tJTkcgPSBBQ1RJVkVfT1JfVElDS0lORyAmIE5PVF9BQ1RJVkUKY29uc3QgSVNfT1BFTklORyA9IE9QRU5fU1RBVFVTIHwgVElDS0lORwoKLy8gQ29tYmluZWQgc2hhcmVkIHN0YXRlIGFuZCByZWFkIHN0YXRlCmNvbnN0IFJFQURfUFJJTUFSWV9TVEFUVVMgPSBPUEVOX1NUQVRVUyB8IFJFQURfRU5ESU5HIHwgUkVBRF9ET05FCmNvbnN0IFJFQURfU1RBVFVTID0gT1BFTl9TVEFUVVMgfCBSRUFEX0RPTkUgfCBSRUFEX1FVRVVFRApjb25zdCBSRUFEX0VORElOR19TVEFUVVMgPSBPUEVOX1NUQVRVUyB8IFJFQURfRU5ESU5HIHwgUkVBRF9RVUVVRUQKY29uc3QgUkVBRF9SRUFEQUJMRV9TVEFUVVMgPSBPUEVOX1NUQVRVUyB8IFJFQURfRU1JVF9SRUFEQUJMRSB8IFJFQURfUVVFVUVEIHwgUkVBRF9FTUlUVEVEX1JFQURBQkxFCmNvbnN0IFNIT1VMRF9OT1RfUkVBRCA9IE9QRU5fU1RBVFVTIHwgUkVBRF9BQ1RJVkUgfCBSRUFEX0VORElORyB8IFJFQURfRE9ORSB8IFJFQURfTkVFRFNfUFVTSCB8IFJFQURfUkVBRF9BSEVBRApjb25zdCBSRUFEX0JBQ0tQUkVTU1VSRV9TVEFUVVMgPSBERVNUUk9ZX1NUQVRVUyB8IFJFQURfRU5ESU5HIHwgUkVBRF9ET05FCmNvbnN0IFJFQURfVVBEQVRFX1NZTkNfU1RBVFVTID0gUkVBRF9VUERBVElORyB8IE9QRU5fU1RBVFVTIHwgUkVBRF9ORVhUX1RJQ0sgfCBSRUFEX1BSSU1BUlkKY29uc3QgUkVBRF9ORVhUX1RJQ0tfT1JfT1BFTklORyA9IFJFQURfTkVYVF9USUNLIHwgT1BFTklORwoKLy8gQ29tYmluZWQgd3JpdGUgc3RhdGUKY29uc3QgV1JJVEVfUFJJTUFSWV9TVEFUVVMgPSBPUEVOX1NUQVRVUyB8IFdSSVRFX0ZJTklTSElORyB8IFdSSVRFX0RPTkUKY29uc3QgV1JJVEVfUVVFVUVEX0FORF9VTkRSQUlORUQgPSBXUklURV9RVUVVRUQgfCBXUklURV9VTkRSQUlORUQKY29uc3QgV1JJVEVfUVVFVUVEX0FORF9BQ1RJVkUgPSBXUklURV9RVUVVRUQgfCBXUklURV9BQ1RJVkUKY29uc3QgV1JJVEVfRFJBSU5fU1RBVFVTID0gV1JJVEVfUVVFVUVEIHwgV1JJVEVfVU5EUkFJTkVEIHwgT1BFTl9TVEFUVVMgfCBXUklURV9BQ1RJVkUKY29uc3QgV1JJVEVfU1RBVFVTID0gT1BFTl9TVEFUVVMgfCBXUklURV9BQ1RJVkUgfCBXUklURV9RVUVVRUQgfCBXUklURV9DT1JLRUQKY29uc3QgV1JJVEVfUFJJTUFSWV9BTkRfQUNUSVZFID0gV1JJVEVfUFJJTUFSWSB8IFdSSVRFX0FDVElWRQpjb25zdCBXUklURV9BQ1RJVkVfQU5EX1dSSVRJTkcgPSBXUklURV9BQ1RJVkUgfCBXUklURV9XUklUSU5HCmNvbnN0IFdSSVRFX0ZJTklTSElOR19TVEFUVVMgPSBPUEVOX1NUQVRVUyB8IFdSSVRFX0ZJTklTSElORyB8IFdSSVRFX1FVRVVFRF9BTkRfQUNUSVZFIHwgV1JJVEVfRE9ORQpjb25zdCBXUklURV9CQUNLUFJFU1NVUkVfU1RBVFVTID0gV1JJVEVfVU5EUkFJTkVEIHwgREVTVFJPWV9TVEFUVVMgfCBXUklURV9GSU5JU0hJTkcgfCBXUklURV9ET05FCmNvbnN0IFdSSVRFX1VQREFURV9TWU5DX1NUQVRVUyA9IFdSSVRFX1VQREFUSU5HIHwgT1BFTl9TVEFUVVMgfCBXUklURV9ORVhUX1RJQ0sgfCBXUklURV9QUklNQVJZCmNvbnN0IFdSSVRFX0RST1BfREFUQSA9IFdSSVRFX0ZJTklTSElORyB8IFdSSVRFX0RPTkUgfCBERVNUUk9ZX1NUQVRVUwoKY29uc3QgYXN5bmNJdGVyYXRvciA9IFN5bWJvbC5hc3luY0l0ZXJhdG9yIHx8IFN5bWJvbCgnYXN5bmNJdGVyYXRvcicpCgpjbGFzcyBXcml0YWJsZVN0YXRlIHsKICBjb25zdHJ1Y3RvciAoc3RyZWFtLCB7IGhpZ2hXYXRlck1hcmsgPSAxNjM4NCwgbWFwID0gbnVsbCwgbWFwV3JpdGFibGUsIGJ5dGVMZW5ndGgsIGJ5dGVMZW5ndGhXcml0YWJsZSB9ID0ge30pIHsKICAgIHRoaXMuc3RyZWFtID0gc3RyZWFtCiAgICB0aGlzLnF1ZXVlID0gbmV3IEZJRk8oKQogICAgdGhpcy5oaWdoV2F0ZXJNYXJrID0gaGlnaFdhdGVyTWFyawogICAgdGhpcy5idWZmZXJlZCA9IDAKICAgIHRoaXMuZXJyb3IgPSBudWxsCiAgICB0aGlzLnBpcGVsaW5lID0gbnVsbAogICAgdGhpcy5kcmFpbnMgPSBudWxsIC8vIGlmIHdlIGFkZCBtb3JlIHNlbGRvbWx5IHVzZWQgaGVscGVycyB3ZSBtaWdodCB0aGVtIGludG8gYSBzdWJvYmplY3Qgc28gaXRzIGEgc2luZ2xlIHB0cgogICAgdGhpcy5ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aFdyaXRhYmxlIHx8IGJ5dGVMZW5ndGggfHwgZGVmYXVsdEJ5dGVMZW5ndGgKICAgIHRoaXMubWFwID0gbWFwV3JpdGFibGUgfHwgbWFwCiAgICB0aGlzLmFmdGVyV3JpdGUgPSBhZnRlcldyaXRlLmJpbmQodGhpcykKICAgIHRoaXMuYWZ0ZXJVcGRhdGVOZXh0VGljayA9IHVwZGF0ZVdyaXRlTlQuYmluZCh0aGlzKQogIH0KCiAgZ2V0IGVuZGVkICgpIHsKICAgIHJldHVybiAodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfRE9ORSkgIT09IDAKICB9CgogIHB1c2ggKGRhdGEpIHsKICAgIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfRFJPUF9EQVRBKSAhPT0gMCkgcmV0dXJuIGZhbHNlCiAgICBpZiAodGhpcy5tYXAgIT09IG51bGwpIGRhdGEgPSB0aGlzLm1hcChkYXRhKQoKICAgIHRoaXMuYnVmZmVyZWQgKz0gdGhpcy5ieXRlTGVuZ3RoKGRhdGEpCiAgICB0aGlzLnF1ZXVlLnB1c2goZGF0YSkKCiAgICBpZiAodGhpcy5idWZmZXJlZCA8IHRoaXMuaGlnaFdhdGVyTWFyaykgewogICAgICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gV1JJVEVfUVVFVUVECiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlIHw9IFdSSVRFX1FVRVVFRF9BTkRfVU5EUkFJTkVECiAgICByZXR1cm4gZmFsc2UKICB9CgogIHNoaWZ0ICgpIHsKICAgIGNvbnN0IGRhdGEgPSB0aGlzLnF1ZXVlLnNoaWZ0KCkKCiAgICB0aGlzLmJ1ZmZlcmVkIC09IHRoaXMuYnl0ZUxlbmd0aChkYXRhKQogICAgaWYgKHRoaXMuYnVmZmVyZWQgPT09IDApIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBXUklURV9OT1RfUVVFVUVECgogICAgcmV0dXJuIGRhdGEKICB9CgogIGVuZCAoZGF0YSkgewogICAgaWYgKHR5cGVvZiBkYXRhID09PSAnZnVuY3Rpb24nKSB0aGlzLnN0cmVhbS5vbmNlKCdmaW5pc2gnLCBkYXRhKQogICAgZWxzZSBpZiAoZGF0YSAhPT0gdW5kZWZpbmVkICYmIGRhdGEgIT09IG51bGwpIHRoaXMucHVzaChkYXRhKQogICAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlID0gKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSB8IFdSSVRFX0ZJTklTSElORykgJiBXUklURV9OT05fUFJJTUFSWQogIH0KCiAgYXV0b0JhdGNoIChkYXRhLCBjYikgewogICAgY29uc3QgYnVmZmVyID0gW10KICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCgogICAgYnVmZmVyLnB1c2goZGF0YSkKICAgIHdoaWxlICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX1NUQVRVUykgPT09IFdSSVRFX1FVRVVFRF9BTkRfQUNUSVZFKSB7CiAgICAgIGJ1ZmZlci5wdXNoKHN0cmVhbS5fd3JpdGFibGVTdGF0ZS5zaGlmdCgpKQogICAgfQoKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIE9QRU5fU1RBVFVTKSAhPT0gMCkgcmV0dXJuIGNiKG51bGwpCiAgICBzdHJlYW0uX3dyaXRldihidWZmZXIsIGNiKQogIH0KCiAgdXBkYXRlICgpIHsKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCgogICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9VUERBVElORwoKICAgIGRvIHsKICAgICAgd2hpbGUgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfU1RBVFVTKSA9PT0gV1JJVEVfUVVFVUVEKSB7CiAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuc2hpZnQoKQogICAgICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gV1JJVEVfQUNUSVZFX0FORF9XUklUSU5HCiAgICAgICAgc3RyZWFtLl93cml0ZShkYXRhLCB0aGlzLmFmdGVyV3JpdGUpCiAgICAgIH0KCiAgICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX1BSSU1BUllfQU5EX0FDVElWRSkgPT09IDApIHRoaXMudXBkYXRlTm9uUHJpbWFyeSgpCiAgICB9IHdoaWxlICh0aGlzLmNvbnRpbnVlVXBkYXRlKCkgPT09IHRydWUpCgogICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBXUklURV9OT1RfVVBEQVRJTkcKICB9CgogIHVwZGF0ZU5vblByaW1hcnkgKCkgewogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9GSU5JU0hJTkdfU1RBVFVTKSA9PT0gV1JJVEVfRklOSVNISU5HKSB7CiAgICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgPSBzdHJlYW0uX2R1cGxleFN0YXRlIHwgV1JJVEVfQUNUSVZFCiAgICAgIHN0cmVhbS5fZmluYWwoYWZ0ZXJGaW5hbC5iaW5kKHRoaXMpKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBERVNUUk9ZX1NUQVRVUykgPT09IERFU1RST1lJTkcpIHsKICAgICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgQUNUSVZFX09SX1RJQ0tJTkcpID09PSAwKSB7CiAgICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBBQ1RJVkUKICAgICAgICBzdHJlYW0uX2Rlc3Ryb3koYWZ0ZXJEZXN0cm95LmJpbmQodGhpcykpCiAgICAgIH0KICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgSVNfT1BFTklORykgPT09IE9QRU5JTkcpIHsKICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSA9IChzdHJlYW0uX2R1cGxleFN0YXRlIHwgQUNUSVZFKSAmIE5PVF9PUEVOSU5HCiAgICAgIHN0cmVhbS5fb3BlbihhZnRlck9wZW4uYmluZCh0aGlzKSkKICAgIH0KICB9CgogIGNvbnRpbnVlVXBkYXRlICgpIHsKICAgIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfTkVYVF9USUNLKSA9PT0gMCkgcmV0dXJuIGZhbHNlCiAgICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gV1JJVEVfTk9UX05FWFRfVElDSwogICAgcmV0dXJuIHRydWUKICB9CgogIHVwZGF0ZUNhbGxiYWNrICgpIHsKICAgIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfVVBEQVRFX1NZTkNfU1RBVFVTKSA9PT0gV1JJVEVfUFJJTUFSWSkgdGhpcy51cGRhdGUoKQogICAgZWxzZSB0aGlzLnVwZGF0ZU5leHRUaWNrKCkKICB9CgogIHVwZGF0ZU5leHRUaWNrICgpIHsKICAgIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfTkVYVF9USUNLKSAhPT0gMCkgcmV0dXJuCiAgICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gV1JJVEVfTkVYVF9USUNLCiAgICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX1VQREFUSU5HKSA9PT0gMCkgcW10KHRoaXMuYWZ0ZXJVcGRhdGVOZXh0VGljaykKICB9Cn0KCmNsYXNzIFJlYWRhYmxlU3RhdGUgewogIGNvbnN0cnVjdG9yIChzdHJlYW0sIHsgaGlnaFdhdGVyTWFyayA9IDE2Mzg0LCBtYXAgPSBudWxsLCBtYXBSZWFkYWJsZSwgYnl0ZUxlbmd0aCwgYnl0ZUxlbmd0aFJlYWRhYmxlIH0gPSB7fSkgewogICAgdGhpcy5zdHJlYW0gPSBzdHJlYW0KICAgIHRoaXMucXVldWUgPSBuZXcgRklGTygpCiAgICB0aGlzLmhpZ2hXYXRlck1hcmsgPSBoaWdoV2F0ZXJNYXJrID09PSAwID8gMSA6IGhpZ2hXYXRlck1hcmsKICAgIHRoaXMuYnVmZmVyZWQgPSAwCiAgICB0aGlzLnJlYWRBaGVhZCA9IGhpZ2hXYXRlck1hcmsgPiAwCiAgICB0aGlzLmVycm9yID0gbnVsbAogICAgdGhpcy5waXBlbGluZSA9IG51bGwKICAgIHRoaXMuYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGhSZWFkYWJsZSB8fCBieXRlTGVuZ3RoIHx8IGRlZmF1bHRCeXRlTGVuZ3RoCiAgICB0aGlzLm1hcCA9IG1hcFJlYWRhYmxlIHx8IG1hcAogICAgdGhpcy5waXBlVG8gPSBudWxsCiAgICB0aGlzLmFmdGVyUmVhZCA9IGFmdGVyUmVhZC5iaW5kKHRoaXMpCiAgICB0aGlzLmFmdGVyVXBkYXRlTmV4dFRpY2sgPSB1cGRhdGVSZWFkTlQuYmluZCh0aGlzKQogIH0KCiAgZ2V0IGVuZGVkICgpIHsKICAgIHJldHVybiAodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9ET05FKSAhPT0gMAogIH0KCiAgcGlwZSAocGlwZVRvLCBjYikgewogICAgaWYgKHRoaXMucGlwZVRvICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ0NhbiBvbmx5IHBpcGUgdG8gb25lIGRlc3RpbmF0aW9uJykKICAgIGlmICh0eXBlb2YgY2IgIT09ICdmdW5jdGlvbicpIGNiID0gbnVsbAoKICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX1BJUEVfRFJBSU5FRAogICAgdGhpcy5waXBlVG8gPSBwaXBlVG8KICAgIHRoaXMucGlwZWxpbmUgPSBuZXcgUGlwZWxpbmUodGhpcy5zdHJlYW0sIHBpcGVUbywgY2IpCgogICAgaWYgKGNiKSB0aGlzLnN0cmVhbS5vbignZXJyb3InLCBub29wKSAvLyBXZSBhbHJlYWR5IGVycm9yIGhhbmRsZSB0aGlzIHNvIHN1cHJlc3MgY3Jhc2hlcwoKICAgIGlmIChpc1N0cmVhbXgocGlwZVRvKSkgewogICAgICBwaXBlVG8uX3dyaXRhYmxlU3RhdGUucGlwZWxpbmUgPSB0aGlzLnBpcGVsaW5lCiAgICAgIGlmIChjYikgcGlwZVRvLm9uKCdlcnJvcicsIG5vb3ApIC8vIFdlIGFscmVhZHkgZXJyb3IgaGFuZGxlIHRoaXMgc28gc3VwcmVzcyBjcmFzaGVzCiAgICAgIHBpcGVUby5vbignZmluaXNoJywgdGhpcy5waXBlbGluZS5maW5pc2hlZC5iaW5kKHRoaXMucGlwZWxpbmUpKSAvLyBUT0RPOiBqdXN0IGNhbGwgZmluaXNoZWQgZnJvbSBwaXBlVG8gaXRzZWxmCiAgICB9IGVsc2UgewogICAgICBjb25zdCBvbmVycm9yID0gdGhpcy5waXBlbGluZS5kb25lLmJpbmQodGhpcy5waXBlbGluZSwgcGlwZVRvKQogICAgICBjb25zdCBvbmNsb3NlID0gdGhpcy5waXBlbGluZS5kb25lLmJpbmQodGhpcy5waXBlbGluZSwgcGlwZVRvLCBudWxsKSAvLyBvbmNsb3NlIGhhcyBhIHdlaXJkIGJvb2wgYXJnCiAgICAgIHBpcGVUby5vbignZXJyb3InLCBvbmVycm9yKQogICAgICBwaXBlVG8ub24oJ2Nsb3NlJywgb25jbG9zZSkKICAgICAgcGlwZVRvLm9uKCdmaW5pc2gnLCB0aGlzLnBpcGVsaW5lLmZpbmlzaGVkLmJpbmQodGhpcy5waXBlbGluZSkpCiAgICB9CgogICAgcGlwZVRvLm9uKCdkcmFpbicsIGFmdGVyRHJhaW4uYmluZCh0aGlzKSkKICAgIHRoaXMuc3RyZWFtLmVtaXQoJ3BpcGluZycsIHBpcGVUbykKICAgIHBpcGVUby5lbWl0KCdwaXBlJywgdGhpcy5zdHJlYW0pCiAgfQoKICBwdXNoIChkYXRhKSB7CiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQoKICAgIGlmIChkYXRhID09PSBudWxsKSB7CiAgICAgIHRoaXMuaGlnaFdhdGVyTWFyayA9IDAKICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSA9IChzdHJlYW0uX2R1cGxleFN0YXRlIHwgUkVBRF9FTkRJTkcpICYgUkVBRF9OT05fUFJJTUFSWV9BTkRfUFVTSEVECiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmICh0aGlzLm1hcCAhPT0gbnVsbCkgewogICAgICBkYXRhID0gdGhpcy5tYXAoZGF0YSkKICAgICAgaWYgKGRhdGEgPT09IG51bGwpIHsKICAgICAgICBzdHJlYW0uX2R1cGxleFN0YXRlICY9IFJFQURfUFVTSEVECiAgICAgICAgcmV0dXJuIHRoaXMuYnVmZmVyZWQgPCB0aGlzLmhpZ2hXYXRlck1hcmsKICAgICAgfQogICAgfQoKICAgIHRoaXMuYnVmZmVyZWQgKz0gdGhpcy5ieXRlTGVuZ3RoKGRhdGEpCiAgICB0aGlzLnF1ZXVlLnB1c2goZGF0YSkKCiAgICBzdHJlYW0uX2R1cGxleFN0YXRlID0gKHN0cmVhbS5fZHVwbGV4U3RhdGUgfCBSRUFEX1FVRVVFRCkgJiBSRUFEX1BVU0hFRAoKICAgIHJldHVybiB0aGlzLmJ1ZmZlcmVkIDwgdGhpcy5oaWdoV2F0ZXJNYXJrCiAgfQoKICBzaGlmdCAoKSB7CiAgICBjb25zdCBkYXRhID0gdGhpcy5xdWV1ZS5zaGlmdCgpCgogICAgdGhpcy5idWZmZXJlZCAtPSB0aGlzLmJ5dGVMZW5ndGgoZGF0YSkKICAgIGlmICh0aGlzLmJ1ZmZlcmVkID09PSAwKSB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gUkVBRF9OT1RfUVVFVUVECiAgICByZXR1cm4gZGF0YQogIH0KCiAgdW5zaGlmdCAoZGF0YSkgewogICAgY29uc3QgcGVuZGluZyA9IFt0aGlzLm1hcCAhPT0gbnVsbCA/IHRoaXMubWFwKGRhdGEpIDogZGF0YV0KICAgIHdoaWxlICh0aGlzLmJ1ZmZlcmVkID4gMCkgcGVuZGluZy5wdXNoKHRoaXMuc2hpZnQoKSkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBlbmRpbmcubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgIGNvbnN0IGRhdGEgPSBwZW5kaW5nW2ldCiAgICAgIHRoaXMuYnVmZmVyZWQgKz0gdGhpcy5ieXRlTGVuZ3RoKGRhdGEpCiAgICAgIHRoaXMucXVldWUucHVzaChkYXRhKQogICAgfQoKICAgIHRoaXMucHVzaChwZW5kaW5nW3BlbmRpbmcubGVuZ3RoIC0gMV0pCiAgfQoKICByZWFkICgpIHsKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCgogICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9TVEFUVVMpID09PSBSRUFEX1FVRVVFRCkgewogICAgICBjb25zdCBkYXRhID0gdGhpcy5zaGlmdCgpCiAgICAgIGlmICh0aGlzLnBpcGVUbyAhPT0gbnVsbCAmJiB0aGlzLnBpcGVUby53cml0ZShkYXRhKSA9PT0gZmFsc2UpIHN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gUkVBRF9QSVBFX05PVF9EUkFJTkVECiAgICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfRU1JVF9EQVRBKSAhPT0gMCkgc3RyZWFtLmVtaXQoJ2RhdGEnLCBkYXRhKQogICAgICByZXR1cm4gZGF0YQogICAgfQoKICAgIGlmICh0aGlzLnJlYWRBaGVhZCA9PT0gZmFsc2UpIHsKICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX1JFQURfQUhFQUQKICAgICAgdGhpcy51cGRhdGVOZXh0VGljaygpCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIGRyYWluICgpIHsKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCgogICAgd2hpbGUgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9TVEFUVVMpID09PSBSRUFEX1FVRVVFRCAmJiAoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfRkxPV0lORykgIT09IDApIHsKICAgICAgY29uc3QgZGF0YSA9IHRoaXMuc2hpZnQoKQogICAgICBpZiAodGhpcy5waXBlVG8gIT09IG51bGwgJiYgdGhpcy5waXBlVG8ud3JpdGUoZGF0YSkgPT09IGZhbHNlKSBzdHJlYW0uX2R1cGxleFN0YXRlICY9IFJFQURfUElQRV9OT1RfRFJBSU5FRAogICAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX0VNSVRfREFUQSkgIT09IDApIHN0cmVhbS5lbWl0KCdkYXRhJywgZGF0YSkKICAgIH0KICB9CgogIHVwZGF0ZSAoKSB7CiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQoKICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gUkVBRF9VUERBVElORwoKICAgIGRvIHsKICAgICAgdGhpcy5kcmFpbigpCgogICAgICB3aGlsZSAodGhpcy5idWZmZXJlZCA8IHRoaXMuaGlnaFdhdGVyTWFyayAmJiAoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFNIT1VMRF9OT1RfUkVBRCkgPT09IFJFQURfUkVBRF9BSEVBRCkgewogICAgICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gUkVBRF9BQ1RJVkVfQU5EX05FRURTX1BVU0gKICAgICAgICBzdHJlYW0uX3JlYWQodGhpcy5hZnRlclJlYWQpCiAgICAgICAgdGhpcy5kcmFpbigpCiAgICAgIH0KCiAgICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfUkVBREFCTEVfU1RBVFVTKSA9PT0gUkVBRF9FTUlUX1JFQURBQkxFX0FORF9RVUVVRUQpIHsKICAgICAgICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IFJFQURfRU1JVFRFRF9SRUFEQUJMRQogICAgICAgIHN0cmVhbS5lbWl0KCdyZWFkYWJsZScpCiAgICAgIH0KCiAgICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfUFJJTUFSWV9BTkRfQUNUSVZFKSA9PT0gMCkgdGhpcy51cGRhdGVOb25QcmltYXJ5KCkKICAgIH0gd2hpbGUgKHRoaXMuY29udGludWVVcGRhdGUoKSA9PT0gdHJ1ZSkKCiAgICBzdHJlYW0uX2R1cGxleFN0YXRlICY9IFJFQURfTk9UX1VQREFUSU5HCiAgfQoKICB1cGRhdGVOb25QcmltYXJ5ICgpIHsKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCgogICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9FTkRJTkdfU1RBVFVTKSA9PT0gUkVBRF9FTkRJTkcpIHsKICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSA9IChzdHJlYW0uX2R1cGxleFN0YXRlIHwgUkVBRF9ET05FKSAmIFJFQURfTk9UX0VORElORwogICAgICBzdHJlYW0uZW1pdCgnZW5kJykKICAgICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgQVVUT19ERVNUUk9ZKSA9PT0gRE9ORSkgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBERVNUUk9ZSU5HCiAgICAgIGlmICh0aGlzLnBpcGVUbyAhPT0gbnVsbCkgdGhpcy5waXBlVG8uZW5kKCkKICAgIH0KCiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBERVNUUk9ZX1NUQVRVUykgPT09IERFU1RST1lJTkcpIHsKICAgICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgQUNUSVZFX09SX1RJQ0tJTkcpID09PSAwKSB7CiAgICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBBQ1RJVkUKICAgICAgICBzdHJlYW0uX2Rlc3Ryb3koYWZ0ZXJEZXN0cm95LmJpbmQodGhpcykpCiAgICAgIH0KICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgSVNfT1BFTklORykgPT09IE9QRU5JTkcpIHsKICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSA9IChzdHJlYW0uX2R1cGxleFN0YXRlIHwgQUNUSVZFKSAmIE5PVF9PUEVOSU5HCiAgICAgIHN0cmVhbS5fb3BlbihhZnRlck9wZW4uYmluZCh0aGlzKSkKICAgIH0KICB9CgogIGNvbnRpbnVlVXBkYXRlICgpIHsKICAgIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9ORVhUX1RJQ0spID09PSAwKSByZXR1cm4gZmFsc2UKICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBSRUFEX05PVF9ORVhUX1RJQ0sKICAgIHJldHVybiB0cnVlCiAgfQoKICB1cGRhdGVDYWxsYmFjayAoKSB7CiAgICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfVVBEQVRFX1NZTkNfU1RBVFVTKSA9PT0gUkVBRF9QUklNQVJZKSB0aGlzLnVwZGF0ZSgpCiAgICBlbHNlIHRoaXMudXBkYXRlTmV4dFRpY2soKQogIH0KCiAgdXBkYXRlTmV4dFRpY2tJZk9wZW4gKCkgewogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX05FWFRfVElDS19PUl9PUEVOSU5HKSAhPT0gMCkgcmV0dXJuCiAgICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gUkVBRF9ORVhUX1RJQ0sKICAgIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9VUERBVElORykgPT09IDApIHFtdCh0aGlzLmFmdGVyVXBkYXRlTmV4dFRpY2spCiAgfQoKICB1cGRhdGVOZXh0VGljayAoKSB7CiAgICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfTkVYVF9USUNLKSAhPT0gMCkgcmV0dXJuCiAgICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gUkVBRF9ORVhUX1RJQ0sKICAgIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9VUERBVElORykgPT09IDApIHFtdCh0aGlzLmFmdGVyVXBkYXRlTmV4dFRpY2spCiAgfQp9CgpjbGFzcyBUcmFuc2Zvcm1TdGF0ZSB7CiAgY29uc3RydWN0b3IgKHN0cmVhbSkgewogICAgdGhpcy5kYXRhID0gbnVsbAogICAgdGhpcy5hZnRlclRyYW5zZm9ybSA9IGFmdGVyVHJhbnNmb3JtLmJpbmQoc3RyZWFtKQogICAgdGhpcy5hZnRlckZpbmFsID0gbnVsbAogIH0KfQoKY2xhc3MgUGlwZWxpbmUgewogIGNvbnN0cnVjdG9yIChzcmMsIGRzdCwgY2IpIHsKICAgIHRoaXMuZnJvbSA9IHNyYwogICAgdGhpcy50byA9IGRzdAogICAgdGhpcy5hZnRlclBpcGUgPSBjYgogICAgdGhpcy5lcnJvciA9IG51bGwKICAgIHRoaXMucGlwZVRvRmluaXNoZWQgPSBmYWxzZQogIH0KCiAgZmluaXNoZWQgKCkgewogICAgdGhpcy5waXBlVG9GaW5pc2hlZCA9IHRydWUKICB9CgogIGRvbmUgKHN0cmVhbSwgZXJyKSB7CiAgICBpZiAoZXJyKSB0aGlzLmVycm9yID0gZXJyCgogICAgaWYgKHN0cmVhbSA9PT0gdGhpcy50bykgewogICAgICB0aGlzLnRvID0gbnVsbAoKICAgICAgaWYgKHRoaXMuZnJvbSAhPT0gbnVsbCkgewogICAgICAgIGlmICgodGhpcy5mcm9tLl9kdXBsZXhTdGF0ZSAmIFJFQURfRE9ORSkgPT09IDAgfHwgIXRoaXMucGlwZVRvRmluaXNoZWQpIHsKICAgICAgICAgIHRoaXMuZnJvbS5kZXN0cm95KHRoaXMuZXJyb3IgfHwgbmV3IEVycm9yKCdXcml0YWJsZSBzdHJlYW0gY2xvc2VkIHByZW1hdHVyZWx5JykpCiAgICAgICAgfQogICAgICAgIHJldHVybgogICAgICB9CiAgICB9CgogICAgaWYgKHN0cmVhbSA9PT0gdGhpcy5mcm9tKSB7CiAgICAgIHRoaXMuZnJvbSA9IG51bGwKCiAgICAgIGlmICh0aGlzLnRvICE9PSBudWxsKSB7CiAgICAgICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9ET05FKSA9PT0gMCkgewogICAgICAgICAgdGhpcy50by5kZXN0cm95KHRoaXMuZXJyb3IgfHwgbmV3IEVycm9yKCdSZWFkYWJsZSBzdHJlYW0gY2xvc2VkIGJlZm9yZSBlbmRpbmcnKSkKICAgICAgICB9CiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5hZnRlclBpcGUgIT09IG51bGwpIHRoaXMuYWZ0ZXJQaXBlKHRoaXMuZXJyb3IpCiAgICB0aGlzLnRvID0gdGhpcy5mcm9tID0gdGhpcy5hZnRlclBpcGUgPSBudWxsCiAgfQp9CgpmdW5jdGlvbiBhZnRlckRyYWluICgpIHsKICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gUkVBRF9QSVBFX0RSQUlORUQKICB0aGlzLnVwZGF0ZUNhbGxiYWNrKCkKfQoKZnVuY3Rpb24gYWZ0ZXJGaW5hbCAoZXJyKSB7CiAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KICBpZiAoZXJyKSBzdHJlYW0uZGVzdHJveShlcnIpCiAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgREVTVFJPWV9TVEFUVVMpID09PSAwKSB7CiAgICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IFdSSVRFX0RPTkUKICAgIHN0cmVhbS5lbWl0KCdmaW5pc2gnKQogIH0KICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBBVVRPX0RFU1RST1kpID09PSBET05FKSB7CiAgICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IERFU1RST1lJTkcKICB9CgogIHN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gV1JJVEVfTk9UX0ZJTklTSElORwoKICAvLyBubyBuZWVkIHRvIHdhaXQgdGhlIGV4dHJhIHRpY2sgaGVyZSwgc28gd2Ugc2hvcnQgY2lyY3VpdCB0aGF0CiAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfVVBEQVRJTkcpID09PSAwKSB0aGlzLnVwZGF0ZSgpCiAgZWxzZSB0aGlzLnVwZGF0ZU5leHRUaWNrKCkKfQoKZnVuY3Rpb24gYWZ0ZXJEZXN0cm95IChlcnIpIHsKICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQoKICBpZiAoIWVyciAmJiB0aGlzLmVycm9yICE9PSBTVFJFQU1fREVTVFJPWUVEKSBlcnIgPSB0aGlzLmVycm9yCiAgaWYgKGVycikgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXJyKQogIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gREVTVFJPWUVECiAgc3RyZWFtLmVtaXQoJ2Nsb3NlJykKCiAgY29uc3QgcnMgPSBzdHJlYW0uX3JlYWRhYmxlU3RhdGUKICBjb25zdCB3cyA9IHN0cmVhbS5fd3JpdGFibGVTdGF0ZQoKICBpZiAocnMgIT09IG51bGwgJiYgcnMucGlwZWxpbmUgIT09IG51bGwpIHJzLnBpcGVsaW5lLmRvbmUoc3RyZWFtLCBlcnIpCgogIGlmICh3cyAhPT0gbnVsbCkgewogICAgd2hpbGUgKHdzLmRyYWlucyAhPT0gbnVsbCAmJiB3cy5kcmFpbnMubGVuZ3RoID4gMCkgd3MuZHJhaW5zLnNoaWZ0KCkucmVzb2x2ZShmYWxzZSkKICAgIGlmICh3cy5waXBlbGluZSAhPT0gbnVsbCkgd3MucGlwZWxpbmUuZG9uZShzdHJlYW0sIGVycikKICB9Cn0KCmZ1bmN0aW9uIGFmdGVyV3JpdGUgKGVycikgewogIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCgogIGlmIChlcnIpIHN0cmVhbS5kZXN0cm95KGVycikKICBzdHJlYW0uX2R1cGxleFN0YXRlICY9IFdSSVRFX05PVF9BQ1RJVkUKCiAgaWYgKHRoaXMuZHJhaW5zICE9PSBudWxsKSB0aWNrRHJhaW5zKHRoaXMuZHJhaW5zKQoKICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9EUkFJTl9TVEFUVVMpID09PSBXUklURV9VTkRSQUlORUQpIHsKICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gV1JJVEVfRFJBSU5FRAogICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfRU1JVF9EUkFJTikgPT09IFdSSVRFX0VNSVRfRFJBSU4pIHsKICAgICAgc3RyZWFtLmVtaXQoJ2RyYWluJykKICAgIH0KICB9CgogIHRoaXMudXBkYXRlQ2FsbGJhY2soKQp9CgpmdW5jdGlvbiBhZnRlclJlYWQgKGVycikgewogIGlmIChlcnIpIHRoaXMuc3RyZWFtLmRlc3Ryb3koZXJyKQogIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBSRUFEX05PVF9BQ1RJVkUKICBpZiAodGhpcy5yZWFkQWhlYWQgPT09IGZhbHNlICYmICh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1JFU1VNRUQpID09PSAwKSB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gUkVBRF9OT19SRUFEX0FIRUFECiAgdGhpcy51cGRhdGVDYWxsYmFjaygpCn0KCmZ1bmN0aW9uIHVwZGF0ZVJlYWROVCAoKSB7CiAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1VQREFUSU5HKSA9PT0gMCkgewogICAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICY9IFJFQURfTk9UX05FWFRfVElDSwogICAgdGhpcy51cGRhdGUoKQogIH0KfQoKZnVuY3Rpb24gdXBkYXRlV3JpdGVOVCAoKSB7CiAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9VUERBVElORykgPT09IDApIHsKICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBXUklURV9OT1RfTkVYVF9USUNLCiAgICB0aGlzLnVwZGF0ZSgpCiAgfQp9CgpmdW5jdGlvbiB0aWNrRHJhaW5zIChkcmFpbnMpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IGRyYWlucy5sZW5ndGg7IGkrKykgewogICAgLy8gZHJhaW5zLndyaXRlcyBhcmUgbW9ub3RvbmljLCBzbyBpZiBvbmUgaXMgMCBpdHMgYWx3YXlzIHRoZSBmaXJzdCBvbmUKICAgIGlmICgtLWRyYWluc1tpXS53cml0ZXMgPT09IDApIHsKICAgICAgZHJhaW5zLnNoaWZ0KCkucmVzb2x2ZSh0cnVlKQogICAgICBpLS0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGFmdGVyT3BlbiAoZXJyKSB7CiAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgaWYgKGVycikgc3RyZWFtLmRlc3Ryb3koZXJyKQoKICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBERVNUUk9ZSU5HKSA9PT0gMCkgewogICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9QUklNQVJZX1NUQVRVUykgPT09IDApIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gUkVBRF9QUklNQVJZCiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9QUklNQVJZX1NUQVRVUykgPT09IDApIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gV1JJVEVfUFJJTUFSWQogICAgc3RyZWFtLmVtaXQoJ29wZW4nKQogIH0KCiAgc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBOT1RfQUNUSVZFCgogIGlmIChzdHJlYW0uX3dyaXRhYmxlU3RhdGUgIT09IG51bGwpIHsKICAgIHN0cmVhbS5fd3JpdGFibGVTdGF0ZS51cGRhdGVDYWxsYmFjaygpCiAgfQoKICBpZiAoc3RyZWFtLl9yZWFkYWJsZVN0YXRlICE9PSBudWxsKSB7CiAgICBzdHJlYW0uX3JlYWRhYmxlU3RhdGUudXBkYXRlQ2FsbGJhY2soKQogIH0KfQoKZnVuY3Rpb24gYWZ0ZXJUcmFuc2Zvcm0gKGVyciwgZGF0YSkgewogIGlmIChkYXRhICE9PSB1bmRlZmluZWQgJiYgZGF0YSAhPT0gbnVsbCkgdGhpcy5wdXNoKGRhdGEpCiAgdGhpcy5fd3JpdGFibGVTdGF0ZS5hZnRlcldyaXRlKGVycikKfQoKZnVuY3Rpb24gbmV3TGlzdGVuZXIgKG5hbWUpIHsKICBpZiAodGhpcy5fcmVhZGFibGVTdGF0ZSAhPT0gbnVsbCkgewogICAgaWYgKG5hbWUgPT09ICdkYXRhJykgewogICAgICB0aGlzLl9kdXBsZXhTdGF0ZSB8PSAoUkVBRF9FTUlUX0RBVEEgfCBSRUFEX1JFU1VNRURfUkVBRF9BSEVBRCkKICAgICAgdGhpcy5fcmVhZGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICB9CiAgICBpZiAobmFtZSA9PT0gJ3JlYWRhYmxlJykgewogICAgICB0aGlzLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX0VNSVRfUkVBREFCTEUKICAgICAgdGhpcy5fcmVhZGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICB9CiAgfQoKICBpZiAodGhpcy5fd3JpdGFibGVTdGF0ZSAhPT0gbnVsbCkgewogICAgaWYgKG5hbWUgPT09ICdkcmFpbicpIHsKICAgICAgdGhpcy5fZHVwbGV4U3RhdGUgfD0gV1JJVEVfRU1JVF9EUkFJTgogICAgICB0aGlzLl93cml0YWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIH0KICB9Cn0KCmNsYXNzIFN0cmVhbSBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IgKG9wdHMpIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLl9kdXBsZXhTdGF0ZSA9IDAKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUgPSBudWxsCiAgICB0aGlzLl93cml0YWJsZVN0YXRlID0gbnVsbAoKICAgIGlmIChvcHRzKSB7CiAgICAgIGlmIChvcHRzLm9wZW4pIHRoaXMuX29wZW4gPSBvcHRzLm9wZW4KICAgICAgaWYgKG9wdHMuZGVzdHJveSkgdGhpcy5fZGVzdHJveSA9IG9wdHMuZGVzdHJveQogICAgICBpZiAob3B0cy5wcmVkZXN0cm95KSB0aGlzLl9wcmVkZXN0cm95ID0gb3B0cy5wcmVkZXN0cm95CiAgICAgIGlmIChvcHRzLnNpZ25hbCkgewogICAgICAgIG9wdHMuc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoJ2Fib3J0JywgYWJvcnQuYmluZCh0aGlzKSkKICAgICAgfQogICAgfQoKICAgIHRoaXMub24oJ25ld0xpc3RlbmVyJywgbmV3TGlzdGVuZXIpCiAgfQoKICBfb3BlbiAoY2IpIHsKICAgIGNiKG51bGwpCiAgfQoKICBfZGVzdHJveSAoY2IpIHsKICAgIGNiKG51bGwpCiAgfQoKICBfcHJlZGVzdHJveSAoKSB7CiAgICAvLyBkb2VzIG5vdGhpbmcKICB9CgogIGdldCByZWFkYWJsZSAoKSB7CiAgICByZXR1cm4gdGhpcy5fcmVhZGFibGVTdGF0ZSAhPT0gbnVsbCA/IHRydWUgOiB1bmRlZmluZWQKICB9CgogIGdldCB3cml0YWJsZSAoKSB7CiAgICByZXR1cm4gdGhpcy5fd3JpdGFibGVTdGF0ZSAhPT0gbnVsbCA/IHRydWUgOiB1bmRlZmluZWQKICB9CgogIGdldCBkZXN0cm95ZWQgKCkgewogICAgcmV0dXJuICh0aGlzLl9kdXBsZXhTdGF0ZSAmIERFU1RST1lFRCkgIT09IDAKICB9CgogIGdldCBkZXN0cm95aW5nICgpIHsKICAgIHJldHVybiAodGhpcy5fZHVwbGV4U3RhdGUgJiBERVNUUk9ZX1NUQVRVUykgIT09IDAKICB9CgogIGRlc3Ryb3kgKGVycikgewogICAgaWYgKCh0aGlzLl9kdXBsZXhTdGF0ZSAmIERFU1RST1lfU1RBVFVTKSA9PT0gMCkgewogICAgICBpZiAoIWVycikgZXJyID0gU1RSRUFNX0RFU1RST1lFRAogICAgICB0aGlzLl9kdXBsZXhTdGF0ZSA9ICh0aGlzLl9kdXBsZXhTdGF0ZSB8IERFU1RST1lJTkcpICYgTk9OX1BSSU1BUlkKCiAgICAgIGlmICh0aGlzLl9yZWFkYWJsZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy5fcmVhZGFibGVTdGF0ZS5oaWdoV2F0ZXJNYXJrID0gMAogICAgICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUuZXJyb3IgPSBlcnIKICAgICAgfQogICAgICBpZiAodGhpcy5fd3JpdGFibGVTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUuaGlnaFdhdGVyTWFyayA9IDAKICAgICAgICB0aGlzLl93cml0YWJsZVN0YXRlLmVycm9yID0gZXJyCiAgICAgIH0KCiAgICAgIHRoaXMuX2R1cGxleFN0YXRlIHw9IFBSRURFU1RST1lJTkcKICAgICAgdGhpcy5fcHJlZGVzdHJveSgpCiAgICAgIHRoaXMuX2R1cGxleFN0YXRlICY9IE5PVF9QUkVERVNUUk9ZSU5HCgogICAgICBpZiAodGhpcy5fcmVhZGFibGVTdGF0ZSAhPT0gbnVsbCkgdGhpcy5fcmVhZGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICAgIGlmICh0aGlzLl93cml0YWJsZVN0YXRlICE9PSBudWxsKSB0aGlzLl93cml0YWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIH0KICB9Cn0KCmNsYXNzIFJlYWRhYmxlIGV4dGVuZHMgU3RyZWFtIHsKICBjb25zdHJ1Y3RvciAob3B0cykgewogICAgc3VwZXIob3B0cykKCiAgICB0aGlzLl9kdXBsZXhTdGF0ZSB8PSBPUEVOSU5HIHwgV1JJVEVfRE9ORSB8IFJFQURfUkVBRF9BSEVBRAogICAgdGhpcy5fcmVhZGFibGVTdGF0ZSA9IG5ldyBSZWFkYWJsZVN0YXRlKHRoaXMsIG9wdHMpCgogICAgaWYgKG9wdHMpIHsKICAgICAgaWYgKHRoaXMuX3JlYWRhYmxlU3RhdGUucmVhZEFoZWFkID09PSBmYWxzZSkgdGhpcy5fZHVwbGV4U3RhdGUgJj0gUkVBRF9OT19SRUFEX0FIRUFECiAgICAgIGlmIChvcHRzLnJlYWQpIHRoaXMuX3JlYWQgPSBvcHRzLnJlYWQKICAgICAgaWYgKG9wdHMuZWFnZXJPcGVuKSB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgICAgaWYgKG9wdHMuZW5jb2RpbmcpIHRoaXMuc2V0RW5jb2Rpbmcob3B0cy5lbmNvZGluZykKICAgIH0KICB9CgogIHNldEVuY29kaW5nIChlbmNvZGluZykgewogICAgY29uc3QgZGVjID0gbmV3IFRleHREZWNvZGVyKGVuY29kaW5nKQogICAgY29uc3QgbWFwID0gdGhpcy5fcmVhZGFibGVTdGF0ZS5tYXAgfHwgZWNobwogICAgdGhpcy5fcmVhZGFibGVTdGF0ZS5tYXAgPSBtYXBPclNraXAKICAgIHJldHVybiB0aGlzCgogICAgZnVuY3Rpb24gbWFwT3JTa2lwIChkYXRhKSB7CiAgICAgIGNvbnN0IG5leHQgPSBkZWMucHVzaChkYXRhKQogICAgICByZXR1cm4gbmV4dCA9PT0gJycgJiYgKGRhdGEuYnl0ZUxlbmd0aCAhPT0gMCB8fCBkZWMucmVtYWluaW5nID4gMCkgPyBudWxsIDogbWFwKG5leHQpCiAgICB9CiAgfQoKICBfcmVhZCAoY2IpIHsKICAgIGNiKG51bGwpCiAgfQoKICBwaXBlIChkZXN0LCBjYikgewogICAgdGhpcy5fcmVhZGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnBpcGUoZGVzdCwgY2IpCiAgICByZXR1cm4gZGVzdAogIH0KCiAgcmVhZCAoKSB7CiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIHJldHVybiB0aGlzLl9yZWFkYWJsZVN0YXRlLnJlYWQoKQogIH0KCiAgcHVzaCAoZGF0YSkgewogICAgdGhpcy5fcmVhZGFibGVTdGF0ZS51cGRhdGVOZXh0VGlja0lmT3BlbigpCiAgICByZXR1cm4gdGhpcy5fcmVhZGFibGVTdGF0ZS5wdXNoKGRhdGEpCiAgfQoKICB1bnNoaWZ0IChkYXRhKSB7CiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrSWZPcGVuKCkKICAgIHJldHVybiB0aGlzLl9yZWFkYWJsZVN0YXRlLnVuc2hpZnQoZGF0YSkKICB9CgogIHJlc3VtZSAoKSB7CiAgICB0aGlzLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX1JFU1VNRURfUkVBRF9BSEVBRAogICAgdGhpcy5fcmVhZGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICByZXR1cm4gdGhpcwogIH0KCiAgcGF1c2UgKCkgewogICAgdGhpcy5fZHVwbGV4U3RhdGUgJj0gKHRoaXMuX3JlYWRhYmxlU3RhdGUucmVhZEFoZWFkID09PSBmYWxzZSA/IFJFQURfUEFVU0VEX05PX1JFQURfQUhFQUQgOiBSRUFEX1BBVVNFRCkKICAgIHJldHVybiB0aGlzCiAgfQoKICBzdGF0aWMgX2Zyb21Bc3luY0l0ZXJhdG9yIChpdGUsIG9wdHMpIHsKICAgIGxldCBkZXN0cm95CgogICAgY29uc3QgcnMgPSBuZXcgUmVhZGFibGUoewogICAgICAuLi5vcHRzLAogICAgICByZWFkIChjYikgewogICAgICAgIGl0ZS5uZXh0KCkudGhlbihwdXNoKS50aGVuKGNiLmJpbmQobnVsbCwgbnVsbCkpLmNhdGNoKGNiKQogICAgICB9LAogICAgICBwcmVkZXN0cm95ICgpIHsKICAgICAgICBkZXN0cm95ID0gaXRlLnJldHVybigpCiAgICAgIH0sCiAgICAgIGRlc3Ryb3kgKGNiKSB7CiAgICAgICAgaWYgKCFkZXN0cm95KSByZXR1cm4gY2IobnVsbCkKICAgICAgICBkZXN0cm95LnRoZW4oY2IuYmluZChudWxsLCBudWxsKSkuY2F0Y2goY2IpCiAgICAgIH0KICAgIH0pCgogICAgcmV0dXJuIHJzCgogICAgZnVuY3Rpb24gcHVzaCAoZGF0YSkgewogICAgICBpZiAoZGF0YS5kb25lKSBycy5wdXNoKG51bGwpCiAgICAgIGVsc2UgcnMucHVzaChkYXRhLnZhbHVlKQogICAgfQogIH0KCiAgc3RhdGljIGZyb20gKGRhdGEsIG9wdHMpIHsKICAgIGlmIChpc1JlYWRTdHJlYW14KGRhdGEpKSByZXR1cm4gZGF0YQogICAgaWYgKGRhdGFbYXN5bmNJdGVyYXRvcl0pIHJldHVybiB0aGlzLl9mcm9tQXN5bmNJdGVyYXRvcihkYXRhW2FzeW5jSXRlcmF0b3JdKCksIG9wdHMpCiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZGF0YSkpIGRhdGEgPSBkYXRhID09PSB1bmRlZmluZWQgPyBbXSA6IFtkYXRhXQoKICAgIGxldCBpID0gMAogICAgcmV0dXJuIG5ldyBSZWFkYWJsZSh7CiAgICAgIC4uLm9wdHMsCiAgICAgIHJlYWQgKGNiKSB7CiAgICAgICAgdGhpcy5wdXNoKGkgPT09IGRhdGEubGVuZ3RoID8gbnVsbCA6IGRhdGFbaSsrXSkKICAgICAgICBjYihudWxsKQogICAgICB9CiAgICB9KQogIH0KCiAgc3RhdGljIGlzQmFja3ByZXNzdXJlZCAocnMpIHsKICAgIHJldHVybiAocnMuX2R1cGxleFN0YXRlICYgUkVBRF9CQUNLUFJFU1NVUkVfU1RBVFVTKSAhPT0gMCB8fCBycy5fcmVhZGFibGVTdGF0ZS5idWZmZXJlZCA+PSBycy5fcmVhZGFibGVTdGF0ZS5oaWdoV2F0ZXJNYXJrCiAgfQoKICBzdGF0aWMgaXNQYXVzZWQgKHJzKSB7CiAgICByZXR1cm4gKHJzLl9kdXBsZXhTdGF0ZSAmIFJFQURfUkVTVU1FRCkgPT09IDAKICB9CgogIFthc3luY0l0ZXJhdG9yXSAoKSB7CiAgICBjb25zdCBzdHJlYW0gPSB0aGlzCgogICAgbGV0IGVycm9yID0gbnVsbAogICAgbGV0IHByb21pc2VSZXNvbHZlID0gbnVsbAogICAgbGV0IHByb21pc2VSZWplY3QgPSBudWxsCgogICAgdGhpcy5vbignZXJyb3InLCAoZXJyKSA9PiB7IGVycm9yID0gZXJyIH0pCiAgICB0aGlzLm9uKCdyZWFkYWJsZScsIG9ucmVhZGFibGUpCiAgICB0aGlzLm9uKCdjbG9zZScsIG9uY2xvc2UpCgogICAgcmV0dXJuIHsKICAgICAgW2FzeW5jSXRlcmF0b3JdICgpIHsKICAgICAgICByZXR1cm4gdGhpcwogICAgICB9LAogICAgICBuZXh0ICgpIHsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgcHJvbWlzZVJlc29sdmUgPSByZXNvbHZlCiAgICAgICAgICBwcm9taXNlUmVqZWN0ID0gcmVqZWN0CiAgICAgICAgICBjb25zdCBkYXRhID0gc3RyZWFtLnJlYWQoKQogICAgICAgICAgaWYgKGRhdGEgIT09IG51bGwpIG9uZGF0YShkYXRhKQogICAgICAgICAgZWxzZSBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBERVNUUk9ZRUQpICE9PSAwKSBvbmRhdGEobnVsbCkKICAgICAgICB9KQogICAgICB9LAogICAgICByZXR1cm4gKCkgewogICAgICAgIHJldHVybiBkZXN0cm95KG51bGwpCiAgICAgIH0sCiAgICAgIHRocm93IChlcnIpIHsKICAgICAgICByZXR1cm4gZGVzdHJveShlcnIpCiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBvbnJlYWRhYmxlICgpIHsKICAgICAgaWYgKHByb21pc2VSZXNvbHZlICE9PSBudWxsKSBvbmRhdGEoc3RyZWFtLnJlYWQoKSkKICAgIH0KCiAgICBmdW5jdGlvbiBvbmNsb3NlICgpIHsKICAgICAgaWYgKHByb21pc2VSZXNvbHZlICE9PSBudWxsKSBvbmRhdGEobnVsbCkKICAgIH0KCiAgICBmdW5jdGlvbiBvbmRhdGEgKGRhdGEpIHsKICAgICAgaWYgKHByb21pc2VSZWplY3QgPT09IG51bGwpIHJldHVybgogICAgICBpZiAoZXJyb3IpIHByb21pc2VSZWplY3QoZXJyb3IpCiAgICAgIGVsc2UgaWYgKGRhdGEgPT09IG51bGwgJiYgKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX0RPTkUpID09PSAwKSBwcm9taXNlUmVqZWN0KFNUUkVBTV9ERVNUUk9ZRUQpCiAgICAgIGVsc2UgcHJvbWlzZVJlc29sdmUoeyB2YWx1ZTogZGF0YSwgZG9uZTogZGF0YSA9PT0gbnVsbCB9KQogICAgICBwcm9taXNlUmVqZWN0ID0gcHJvbWlzZVJlc29sdmUgPSBudWxsCiAgICB9CgogICAgZnVuY3Rpb24gZGVzdHJveSAoZXJyKSB7CiAgICAgIHN0cmVhbS5kZXN0cm95KGVycikKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICBpZiAoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIERFU1RST1lFRCkgcmV0dXJuIHJlc29sdmUoeyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH0pCiAgICAgICAgc3RyZWFtLm9uY2UoJ2Nsb3NlJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKGVycikgcmVqZWN0KGVycikKICAgICAgICAgIGVsc2UgcmVzb2x2ZSh7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfSkKICAgICAgICB9KQogICAgICB9KQogICAgfQogIH0KfQoKY2xhc3MgV3JpdGFibGUgZXh0ZW5kcyBTdHJlYW0gewogIGNvbnN0cnVjdG9yIChvcHRzKSB7CiAgICBzdXBlcihvcHRzKQoKICAgIHRoaXMuX2R1cGxleFN0YXRlIHw9IE9QRU5JTkcgfCBSRUFEX0RPTkUKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUgPSBuZXcgV3JpdGFibGVTdGF0ZSh0aGlzLCBvcHRzKQoKICAgIGlmIChvcHRzKSB7CiAgICAgIGlmIChvcHRzLndyaXRldikgdGhpcy5fd3JpdGV2ID0gb3B0cy53cml0ZXYKICAgICAgaWYgKG9wdHMud3JpdGUpIHRoaXMuX3dyaXRlID0gb3B0cy53cml0ZQogICAgICBpZiAob3B0cy5maW5hbCkgdGhpcy5fZmluYWwgPSBvcHRzLmZpbmFsCiAgICAgIGlmIChvcHRzLmVhZ2VyT3BlbikgdGhpcy5fd3JpdGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICB9CiAgfQoKICBjb3JrICgpIHsKICAgIHRoaXMuX2R1cGxleFN0YXRlIHw9IFdSSVRFX0NPUktFRAogIH0KCiAgdW5jb3JrICgpIHsKICAgIHRoaXMuX2R1cGxleFN0YXRlICY9IFdSSVRFX05PVF9DT1JLRUQKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogIH0KCiAgX3dyaXRldiAoYmF0Y2gsIGNiKSB7CiAgICBjYihudWxsKQogIH0KCiAgX3dyaXRlIChkYXRhLCBjYikgewogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS5hdXRvQmF0Y2goZGF0YSwgY2IpCiAgfQoKICBfZmluYWwgKGNiKSB7CiAgICBjYihudWxsKQogIH0KCiAgc3RhdGljIGlzQmFja3ByZXNzdXJlZCAod3MpIHsKICAgIHJldHVybiAod3MuX2R1cGxleFN0YXRlICYgV1JJVEVfQkFDS1BSRVNTVVJFX1NUQVRVUykgIT09IDAKICB9CgogIHN0YXRpYyBkcmFpbmVkICh3cykgewogICAgaWYgKHdzLmRlc3Ryb3llZCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxzZSkKICAgIGNvbnN0IHN0YXRlID0gd3MuX3dyaXRhYmxlU3RhdGUKICAgIGNvbnN0IHBlbmRpbmcgPSAoaXNXcml0ZXYod3MpID8gTWF0aC5taW4oMSwgc3RhdGUucXVldWUubGVuZ3RoKSA6IHN0YXRlLnF1ZXVlLmxlbmd0aCkKICAgIGNvbnN0IHdyaXRlcyA9IHBlbmRpbmcgKyAoKHdzLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX1dSSVRJTkcpID8gMSA6IDApCiAgICBpZiAod3JpdGVzID09PSAwKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRydWUpCiAgICBpZiAoc3RhdGUuZHJhaW5zID09PSBudWxsKSBzdGF0ZS5kcmFpbnMgPSBbXQogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgIHN0YXRlLmRyYWlucy5wdXNoKHsgd3JpdGVzLCByZXNvbHZlIH0pCiAgICB9KQogIH0KCiAgd3JpdGUgKGRhdGEpIHsKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgcmV0dXJuIHRoaXMuX3dyaXRhYmxlU3RhdGUucHVzaChkYXRhKQogIH0KCiAgZW5kIChkYXRhKSB7CiAgICB0aGlzLl93cml0YWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUuZW5kKGRhdGEpCiAgICByZXR1cm4gdGhpcwogIH0KfQoKY2xhc3MgRHVwbGV4IGV4dGVuZHMgUmVhZGFibGUgeyAvLyBhbmQgV3JpdGFibGUKICBjb25zdHJ1Y3RvciAob3B0cykgewogICAgc3VwZXIob3B0cykKCiAgICB0aGlzLl9kdXBsZXhTdGF0ZSA9IE9QRU5JTkcgfCAodGhpcy5fZHVwbGV4U3RhdGUgJiBSRUFEX1JFQURfQUhFQUQpCiAgICB0aGlzLl93cml0YWJsZVN0YXRlID0gbmV3IFdyaXRhYmxlU3RhdGUodGhpcywgb3B0cykKCiAgICBpZiAob3B0cykgewogICAgICBpZiAob3B0cy53cml0ZXYpIHRoaXMuX3dyaXRldiA9IG9wdHMud3JpdGV2CiAgICAgIGlmIChvcHRzLndyaXRlKSB0aGlzLl93cml0ZSA9IG9wdHMud3JpdGUKICAgICAgaWYgKG9wdHMuZmluYWwpIHRoaXMuX2ZpbmFsID0gb3B0cy5maW5hbAogICAgfQogIH0KCiAgY29yayAoKSB7CiAgICB0aGlzLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9DT1JLRUQKICB9CgogIHVuY29yayAoKSB7CiAgICB0aGlzLl9kdXBsZXhTdGF0ZSAmPSBXUklURV9OT1RfQ09SS0VECiAgICB0aGlzLl93cml0YWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICB9CgogIF93cml0ZXYgKGJhdGNoLCBjYikgewogICAgY2IobnVsbCkKICB9CgogIF93cml0ZSAoZGF0YSwgY2IpIHsKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUuYXV0b0JhdGNoKGRhdGEsIGNiKQogIH0KCiAgX2ZpbmFsIChjYikgewogICAgY2IobnVsbCkKICB9CgogIHdyaXRlIChkYXRhKSB7CiAgICB0aGlzLl93cml0YWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIHJldHVybiB0aGlzLl93cml0YWJsZVN0YXRlLnB1c2goZGF0YSkKICB9CgogIGVuZCAoZGF0YSkgewogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICB0aGlzLl93cml0YWJsZVN0YXRlLmVuZChkYXRhKQogICAgcmV0dXJuIHRoaXMKICB9Cn0KCmNsYXNzIFRyYW5zZm9ybSBleHRlbmRzIER1cGxleCB7CiAgY29uc3RydWN0b3IgKG9wdHMpIHsKICAgIHN1cGVyKG9wdHMpCiAgICB0aGlzLl90cmFuc2Zvcm1TdGF0ZSA9IG5ldyBUcmFuc2Zvcm1TdGF0ZSh0aGlzKQoKICAgIGlmIChvcHRzKSB7CiAgICAgIGlmIChvcHRzLnRyYW5zZm9ybSkgdGhpcy5fdHJhbnNmb3JtID0gb3B0cy50cmFuc2Zvcm0KICAgICAgaWYgKG9wdHMuZmx1c2gpIHRoaXMuX2ZsdXNoID0gb3B0cy5mbHVzaAogICAgfQogIH0KCiAgX3dyaXRlIChkYXRhLCBjYikgewogICAgaWYgKHRoaXMuX3JlYWRhYmxlU3RhdGUuYnVmZmVyZWQgPj0gdGhpcy5fcmVhZGFibGVTdGF0ZS5oaWdoV2F0ZXJNYXJrKSB7CiAgICAgIHRoaXMuX3RyYW5zZm9ybVN0YXRlLmRhdGEgPSBkYXRhCiAgICB9IGVsc2UgewogICAgICB0aGlzLl90cmFuc2Zvcm0oZGF0YSwgdGhpcy5fdHJhbnNmb3JtU3RhdGUuYWZ0ZXJUcmFuc2Zvcm0pCiAgICB9CiAgfQoKICBfcmVhZCAoY2IpIHsKICAgIGlmICh0aGlzLl90cmFuc2Zvcm1TdGF0ZS5kYXRhICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5kYXRhCiAgICAgIHRoaXMuX3RyYW5zZm9ybVN0YXRlLmRhdGEgPSBudWxsCiAgICAgIGNiKG51bGwpCiAgICAgIHRoaXMuX3RyYW5zZm9ybShkYXRhLCB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5hZnRlclRyYW5zZm9ybSkKICAgIH0gZWxzZSB7CiAgICAgIGNiKG51bGwpCiAgICB9CiAgfQoKICBkZXN0cm95IChlcnIpIHsKICAgIHN1cGVyLmRlc3Ryb3koZXJyKQogICAgaWYgKHRoaXMuX3RyYW5zZm9ybVN0YXRlLmRhdGEgIT09IG51bGwpIHsKICAgICAgdGhpcy5fdHJhbnNmb3JtU3RhdGUuZGF0YSA9IG51bGwKICAgICAgdGhpcy5fdHJhbnNmb3JtU3RhdGUuYWZ0ZXJUcmFuc2Zvcm0oKQogICAgfQogIH0KCiAgX3RyYW5zZm9ybSAoZGF0YSwgY2IpIHsKICAgIGNiKG51bGwsIGRhdGEpCiAgfQoKICBfZmx1c2ggKGNiKSB7CiAgICBjYihudWxsKQogIH0KCiAgX2ZpbmFsIChjYikgewogICAgdGhpcy5fdHJhbnNmb3JtU3RhdGUuYWZ0ZXJGaW5hbCA9IGNiCiAgICB0aGlzLl9mbHVzaCh0cmFuc2Zvcm1BZnRlckZsdXNoLmJpbmQodGhpcykpCiAgfQp9CgpjbGFzcyBQYXNzVGhyb3VnaCBleHRlbmRzIFRyYW5zZm9ybSB7fQoKZnVuY3Rpb24gdHJhbnNmb3JtQWZ0ZXJGbHVzaCAoZXJyLCBkYXRhKSB7CiAgY29uc3QgY2IgPSB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5hZnRlckZpbmFsCiAgaWYgKGVycikgcmV0dXJuIGNiKGVycikKICBpZiAoZGF0YSAhPT0gbnVsbCAmJiBkYXRhICE9PSB1bmRlZmluZWQpIHRoaXMucHVzaChkYXRhKQogIHRoaXMucHVzaChudWxsKQogIGNiKG51bGwpCn0KCmZ1bmN0aW9uIHBpcGVsaW5lUHJvbWlzZSAoLi4uc3RyZWFtcykgewogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXR1cm4gcGlwZWxpbmUoLi4uc3RyZWFtcywgKGVycikgPT4gewogICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycikKICAgICAgcmVzb2x2ZSgpCiAgICB9KQogIH0pCn0KCmZ1bmN0aW9uIHBpcGVsaW5lIChzdHJlYW0sIC4uLnN0cmVhbXMpIHsKICBjb25zdCBhbGwgPSBBcnJheS5pc0FycmF5KHN0cmVhbSkgPyBbLi4uc3RyZWFtLCAuLi5zdHJlYW1zXSA6IFtzdHJlYW0sIC4uLnN0cmVhbXNdCiAgY29uc3QgZG9uZSA9IChhbGwubGVuZ3RoICYmIHR5cGVvZiBhbGxbYWxsLmxlbmd0aCAtIDFdID09PSAnZnVuY3Rpb24nKSA/IGFsbC5wb3AoKSA6IG51bGwKCiAgaWYgKGFsbC5sZW5ndGggPCAyKSB0aHJvdyBuZXcgRXJyb3IoJ1BpcGVsaW5lIHJlcXVpcmVzIGF0IGxlYXN0IDIgc3RyZWFtcycpCgogIGxldCBzcmMgPSBhbGxbMF0KICBsZXQgZGVzdCA9IG51bGwKICBsZXQgZXJyb3IgPSBudWxsCgogIGZvciAobGV0IGkgPSAxOyBpIDwgYWxsLmxlbmd0aDsgaSsrKSB7CiAgICBkZXN0ID0gYWxsW2ldCgogICAgaWYgKGlzU3RyZWFteChzcmMpKSB7CiAgICAgIHNyYy5waXBlKGRlc3QsIG9uZXJyb3IpCiAgICB9IGVsc2UgewogICAgICBlcnJvckhhbmRsZShzcmMsIHRydWUsIGkgPiAxLCBvbmVycm9yKQogICAgICBzcmMucGlwZShkZXN0KQogICAgfQoKICAgIHNyYyA9IGRlc3QKICB9CgogIGlmIChkb25lKSB7CiAgICBsZXQgZmluID0gZmFsc2UKCiAgICBjb25zdCBhdXRvRGVzdHJveSA9IGlzU3RyZWFteChkZXN0KSB8fCAhIShkZXN0Ll93cml0YWJsZVN0YXRlICYmIGRlc3QuX3dyaXRhYmxlU3RhdGUuYXV0b0Rlc3Ryb3kpCgogICAgZGVzdC5vbignZXJyb3InLCAoZXJyKSA9PiB7CiAgICAgIGlmIChlcnJvciA9PT0gbnVsbCkgZXJyb3IgPSBlcnIKICAgIH0pCgogICAgZGVzdC5vbignZmluaXNoJywgKCkgPT4gewogICAgICBmaW4gPSB0cnVlCiAgICAgIGlmICghYXV0b0Rlc3Ryb3kpIGRvbmUoZXJyb3IpCiAgICB9KQoKICAgIGlmIChhdXRvRGVzdHJveSkgewogICAgICBkZXN0Lm9uKCdjbG9zZScsICgpID0+IGRvbmUoZXJyb3IgfHwgKGZpbiA/IG51bGwgOiBQUkVNQVRVUkVfQ0xPU0UpKSkKICAgIH0KICB9CgogIHJldHVybiBkZXN0CgogIGZ1bmN0aW9uIGVycm9ySGFuZGxlIChzLCByZCwgd3IsIG9uZXJyb3IpIHsKICAgIHMub24oJ2Vycm9yJywgb25lcnJvcikKICAgIHMub24oJ2Nsb3NlJywgb25jbG9zZSkKCiAgICBmdW5jdGlvbiBvbmNsb3NlICgpIHsKICAgICAgaWYgKHJkICYmIHMuX3JlYWRhYmxlU3RhdGUgJiYgIXMuX3JlYWRhYmxlU3RhdGUuZW5kZWQpIHJldHVybiBvbmVycm9yKFBSRU1BVFVSRV9DTE9TRSkKICAgICAgaWYgKHdyICYmIHMuX3dyaXRhYmxlU3RhdGUgJiYgIXMuX3dyaXRhYmxlU3RhdGUuZW5kZWQpIHJldHVybiBvbmVycm9yKFBSRU1BVFVSRV9DTE9TRSkKICAgIH0KICB9CgogIGZ1bmN0aW9uIG9uZXJyb3IgKGVycikgewogICAgaWYgKCFlcnIgfHwgZXJyb3IpIHJldHVybgogICAgZXJyb3IgPSBlcnIKCiAgICBmb3IgKGNvbnN0IHMgb2YgYWxsKSB7CiAgICAgIHMuZGVzdHJveShlcnIpCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBlY2hvIChzKSB7CiAgcmV0dXJuIHMKfQoKZnVuY3Rpb24gaXNTdHJlYW0gKHN0cmVhbSkgewogIHJldHVybiAhIXN0cmVhbS5fcmVhZGFibGVTdGF0ZSB8fCAhIXN0cmVhbS5fd3JpdGFibGVTdGF0ZQp9CgpmdW5jdGlvbiBpc1N0cmVhbXggKHN0cmVhbSkgewogIHJldHVybiB0eXBlb2Ygc3RyZWFtLl9kdXBsZXhTdGF0ZSA9PT0gJ251bWJlcicgJiYgaXNTdHJlYW0oc3RyZWFtKQp9CgpmdW5jdGlvbiBpc0VuZGVkIChzdHJlYW0pIHsKICByZXR1cm4gISFzdHJlYW0uX3JlYWRhYmxlU3RhdGUgJiYgc3RyZWFtLl9yZWFkYWJsZVN0YXRlLmVuZGVkCn0KCmZ1bmN0aW9uIGlzRmluaXNoZWQgKHN0cmVhbSkgewogIHJldHVybiAhIXN0cmVhbS5fd3JpdGFibGVTdGF0ZSAmJiBzdHJlYW0uX3dyaXRhYmxlU3RhdGUuZW5kZWQKfQoKZnVuY3Rpb24gZ2V0U3RyZWFtRXJyb3IgKHN0cmVhbSwgb3B0cyA9IHt9KSB7CiAgY29uc3QgZXJyID0gKHN0cmVhbS5fcmVhZGFibGVTdGF0ZSAmJiBzdHJlYW0uX3JlYWRhYmxlU3RhdGUuZXJyb3IpIHx8IChzdHJlYW0uX3dyaXRhYmxlU3RhdGUgJiYgc3RyZWFtLl93cml0YWJsZVN0YXRlLmVycm9yKQoKICAvLyBhdm9pZCBpbXBsaWNpdCBlcnJvcnMgYnkgZGVmYXVsdAogIHJldHVybiAoIW9wdHMuYWxsICYmIGVyciA9PT0gU1RSRUFNX0RFU1RST1lFRCkgPyBudWxsIDogZXJyCn0KCmZ1bmN0aW9uIGlzUmVhZFN0cmVhbXggKHN0cmVhbSkgewogIHJldHVybiBpc1N0cmVhbXgoc3RyZWFtKSAmJiBzdHJlYW0ucmVhZGFibGUKfQoKZnVuY3Rpb24gaXNEaXN0dXJiZWQgKHN0cmVhbSkgewogIHJldHVybiAoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIE9QRU5JTkcpICE9PSBPUEVOSU5HIHx8IChzdHJlYW0uX2R1cGxleFN0YXRlICYgQUNUSVZFX09SX1RJQ0tJTkcpICE9PSAwCn0KCmZ1bmN0aW9uIGlzVHlwZWRBcnJheSAoZGF0YSkgewogIHJldHVybiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcgJiYgZGF0YSAhPT0gbnVsbCAmJiB0eXBlb2YgZGF0YS5ieXRlTGVuZ3RoID09PSAnbnVtYmVyJwp9CgpmdW5jdGlvbiBkZWZhdWx0Qnl0ZUxlbmd0aCAoZGF0YSkgewogIHJldHVybiBpc1R5cGVkQXJyYXkoZGF0YSkgPyBkYXRhLmJ5dGVMZW5ndGggOiAxMDI0Cn0KCmZ1bmN0aW9uIG5vb3AgKCkge30KCmZ1bmN0aW9uIGFib3J0ICgpIHsKICB0aGlzLmRlc3Ryb3kobmV3IEVycm9yKCdTdHJlYW0gYWJvcnRlZC4nKSkKfQoKZnVuY3Rpb24gaXNXcml0ZXYgKHMpIHsKICByZXR1cm4gcy5fd3JpdGV2ICE9PSBXcml0YWJsZS5wcm90b3R5cGUuX3dyaXRldiAmJiBzLl93cml0ZXYgIT09IER1cGxleC5wcm90b3R5cGUuX3dyaXRldgp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBwaXBlbGluZSwKICBwaXBlbGluZVByb21pc2UsCiAgaXNTdHJlYW0sCiAgaXNTdHJlYW14LAogIGlzRW5kZWQsCiAgaXNGaW5pc2hlZCwKICBpc0Rpc3R1cmJlZCwKICBnZXRTdHJlYW1FcnJvciwKICBTdHJlYW0sCiAgV3JpdGFibGUsCiAgUmVhZGFibGUsCiAgRHVwbGV4LAogIFRyYW5zZm9ybSwKICAvLyBFeHBvcnQgUGFzc1Rocm91Z2ggZm9yIGNvbXBhdGliaWxpdHkgd2l0aCBOb2RlLmpzIGNvcmUncyBzdHJlYW0gbW9kdWxlCiAgUGFzc1Rocm91Z2gKfQp7CiAgIm5hbWUiOiAic3RyZWFteCIsCiAgInZlcnNpb24iOiAiMi4yMy4wIiwKICAiZGVzY3JpcHRpb24iOiAiQW4gaXRlcmF0aW9uIG9mIHRoZSBOb2RlLmpzIGNvcmUgc3RyZWFtcyB3aXRoIGEgc2VyaWVzIG9mIGltcHJvdmVtZW50cyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiZXZlbnRzLXVuaXZlcnNhbCI6ICJeMS4wLjAiLAogICAgImZhc3QtZmlmbyI6ICJeMS4zLjIiLAogICAgInRleHQtZGVjb2RlciI6ICJeMS4xLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjYiLAogICAgImJyaXR0bGUiOiAiXjMuMS4xIiwKICAgICJlbmQtb2Ytc3RyZWFtIjogIl4xLjQuNCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgbm9kZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDpiYXJlIjogInN0YW5kYXJkICYmIGJhcmUgdGVzdC9hbGwuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc3RyZWFteC5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc3RyZWFteC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zdHJlYW14Igp9CmNvbnN0IGNvZGVjcyA9IHJlcXVpcmUoJ2NvZGVjcycpCmNvbnN0IGIgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgU0VQID0gYi5hbGxvYygxKQpjb25zdCBTRVBfQlVNUEVEID0gYi5mcm9tKFsweDFdKQpjb25zdCBFTVBUWSA9IGIuYWxsb2MoMCkKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU3ViRW5jb2RlciB7CiAgY29uc3RydWN0b3IgKHByZWZpeCwgZW5jb2RpbmcsIHBhcmVudCA9IG51bGwpIHsKICAgIHRoaXMudXNlckVuY29kaW5nID0gY29kZWNzKGVuY29kaW5nKQogICAgdGhpcy5wcmVmaXggPSBwcmVmaXggIT0gbnVsbCA/IGNyZWF0ZVByZWZpeChwcmVmaXgsIHBhcmVudCkgOiBudWxsCiAgICB0aGlzLmx0ID0gdGhpcy5wcmVmaXggJiYgYi5jb25jYXQoW3RoaXMucHJlZml4LnN1YmFycmF5KDAsIHRoaXMucHJlZml4LmJ5dGVMZW5ndGggLSAxKSwgU0VQX0JVTVBFRF0pCiAgfQoKICBfZW5jb2RlUmFuZ2VVc2VyIChyKSB7CiAgICBpZiAodGhpcy51c2VyRW5jb2RpbmcuZW5jb2RlUmFuZ2UpIHJldHVybiB0aGlzLnVzZXJFbmNvZGluZy5lbmNvZGVSYW5nZShyKQoKICAgIGNvbnN0IHJlcyA9IHt9CiAgICBpZiAoci5ndCAhPSBudWxsKSByZXMuZ3QgPSB0aGlzLnVzZXJFbmNvZGluZy5lbmNvZGUoci5ndCkKICAgIGlmIChyLmd0ZSAhPSBudWxsKSByZXMuZ3RlID0gdGhpcy51c2VyRW5jb2RpbmcuZW5jb2RlKHIuZ3RlKQogICAgaWYgKHIubHRlICE9IG51bGwpIHJlcy5sdGUgPSB0aGlzLnVzZXJFbmNvZGluZy5lbmNvZGUoci5sdGUpCiAgICBpZiAoci5sdCAhPSBudWxsKSByZXMubHQgPSB0aGlzLnVzZXJFbmNvZGluZy5lbmNvZGUoci5sdCkKCiAgICByZXR1cm4gcmVzCiAgfQoKICBfYWRkUHJlZml4IChrZXkpIHsKICAgIHJldHVybiB0aGlzLnByZWZpeCA/IGIuY29uY2F0KFt0aGlzLnByZWZpeCwga2V5XSkgOiBrZXkKICB9CgogIGVuY29kZSAoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5fYWRkUHJlZml4KHRoaXMudXNlckVuY29kaW5nLmVuY29kZShrZXkpKQogIH0KCiAgZW5jb2RlUmFuZ2UgKHJhbmdlKSB7CiAgICBjb25zdCByID0gdGhpcy5fZW5jb2RlUmFuZ2VVc2VyKHJhbmdlKQoKICAgIGlmIChyLmd0KSByLmd0ID0gdGhpcy5fYWRkUHJlZml4KHIuZ3QpCiAgICBlbHNlIGlmIChyLmd0ZSkgci5ndGUgPSB0aGlzLl9hZGRQcmVmaXgoci5ndGUpCiAgICBlbHNlIGlmICh0aGlzLnByZWZpeCkgci5ndGUgPSB0aGlzLnByZWZpeAoKICAgIGlmIChyLmx0KSByLmx0ID0gdGhpcy5fYWRkUHJlZml4KHIubHQpCiAgICBlbHNlIGlmIChyLmx0ZSkgci5sdGUgPSB0aGlzLl9hZGRQcmVmaXgoci5sdGUpCiAgICBlbHNlIGlmICh0aGlzLnByZWZpeCkgci5sdCA9IHRoaXMubHQKCiAgICByZXR1cm4gcgogIH0KCiAgZGVjb2RlIChrZXkpIHsKICAgIHJldHVybiB0aGlzLnVzZXJFbmNvZGluZy5kZWNvZGUodGhpcy5wcmVmaXggPyBrZXkuc3ViYXJyYXkodGhpcy5wcmVmaXguYnl0ZUxlbmd0aCkgOiBrZXkpCiAgfQoKICBzdWIgKHByZWZpeCwgZW5jb2RpbmcpIHsKICAgIHJldHVybiBuZXcgU3ViRW5jb2RlcihwcmVmaXggfHwgRU1QVFksIGNvbXBhdChlbmNvZGluZyksIHRoaXMucHJlZml4KQogIH0KfQoKZnVuY3Rpb24gY3JlYXRlUHJlZml4IChwcmVmaXgsIHBhcmVudCkgewogIHByZWZpeCA9IHR5cGVvZiBwcmVmaXggPT09ICdzdHJpbmcnID8gYi5mcm9tKHByZWZpeCkgOiBwcmVmaXgKCiAgaWYgKHByZWZpeCAmJiBwYXJlbnQpIHJldHVybiBiLmNvbmNhdChbcGFyZW50LCBwcmVmaXgsIFNFUF0pCiAgaWYgKHByZWZpeCkgcmV0dXJuIGIuY29uY2F0KFtwcmVmaXgsIFNFUF0pCiAgaWYgKHBhcmVudCkgcmV0dXJuIGIuY29uY2F0KFtwYXJlbnQsIFNFUF0pCiAgcmV0dXJuIFNFUAp9CgpmdW5jdGlvbiBjb21wYXQgKGVuYykgewogIGlmIChlbmMgJiYgZW5jLmtleUVuY29kaW5nKSByZXR1cm4gZW5jLmtleUVuY29kaW5nCiAgcmV0dXJuIGVuYwp9CnsKICAibmFtZSI6ICJzdWItZW5jb2RlciIsCiAgInZlcnNpb24iOiAiMi4xLjMiLAogICJkZXNjcmlwdGlvbiI6ICJHZW5lcmF0ZSBzdWIgZW5jb2RpbmdzIGZvciBrZXkvdmFsdWUgc3RvcmVzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QvKi5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zdWItZW5jb2Rlci5naXQiCiAgfSwKICAia2V5d29yZHMiOiBbCiAgICAia3Ytc3RvcmUiLAogICAgImVuY29kaW5nIiwKICAgICJoeXBlcmJlZSIKICBdLAogICJhdXRob3IiOiAiQW5kcmV3IE9zaGVyb2ZmIDxhbmRyZXdvc2hAZ21haWwuY29tPiIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zdWItZW5jb2Rlci9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3N1Yi1lbmNvZGVyI3JlYWRtZSIsCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjEuMSIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xMi4wIiwKICAgICJoeXBlcmJlZSI6ICJeMi4xMS4wIiwKICAgICJoeXBlcmNvcmUiOiAiXjEwLjMuMiIsCiAgICAiaW5kZXgtZW5jb2RlciI6ICJeMy4wLjAiLAogICAgInJhbmRvbS1hY2Nlc3MtbWVtb3J5IjogIl42LjAuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMCIsCiAgICAiY29kZWNzIjogIl4zLjEuMCIKICB9Cn0KY29uc3QgUGFzc1Rocm91Z2hEZWNvZGVyID0gcmVxdWlyZSgnLi9saWIvcGFzcy10aHJvdWdoLWRlY29kZXInKQpjb25zdCBVVEY4RGVjb2RlciA9IHJlcXVpcmUoJy4vbGliL3V0ZjgtZGVjb2RlcicpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFRleHREZWNvZGVyIHsKICBjb25zdHJ1Y3RvciAoZW5jb2RpbmcgPSAndXRmOCcpIHsKICAgIHRoaXMuZW5jb2RpbmcgPSBub3JtYWxpemVFbmNvZGluZyhlbmNvZGluZykKCiAgICBzd2l0Y2ggKHRoaXMuZW5jb2RpbmcpIHsKICAgICAgY2FzZSAndXRmOCc6CiAgICAgICAgdGhpcy5kZWNvZGVyID0gbmV3IFVURjhEZWNvZGVyKCkKICAgICAgICBicmVhawogICAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIGVuY29kaW5nOiAnICsgdGhpcy5lbmNvZGluZykKICAgICAgZGVmYXVsdDoKICAgICAgICB0aGlzLmRlY29kZXIgPSBuZXcgUGFzc1Rocm91Z2hEZWNvZGVyKHRoaXMuZW5jb2RpbmcpCiAgICB9CiAgfQoKICBnZXQgcmVtYWluaW5nICgpIHsKICAgIHJldHVybiB0aGlzLmRlY29kZXIucmVtYWluaW5nCiAgfQoKICBwdXNoIChkYXRhKSB7CiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSByZXR1cm4gZGF0YQogICAgcmV0dXJuIHRoaXMuZGVjb2Rlci5kZWNvZGUoZGF0YSkKICB9CgogIC8vIEZvciBOb2RlLmpzIGNvbXBhdGliaWxpdHkKICB3cml0ZSAoZGF0YSkgewogICAgcmV0dXJuIHRoaXMucHVzaChkYXRhKQogIH0KCiAgZW5kIChkYXRhKSB7CiAgICBsZXQgcmVzdWx0ID0gJycKICAgIGlmIChkYXRhKSByZXN1bHQgPSB0aGlzLnB1c2goZGF0YSkKICAgIHJlc3VsdCArPSB0aGlzLmRlY29kZXIuZmx1c2goKQogICAgcmV0dXJuIHJlc3VsdAogIH0KfQoKZnVuY3Rpb24gbm9ybWFsaXplRW5jb2RpbmcgKGVuY29kaW5nKSB7CiAgZW5jb2RpbmcgPSBlbmNvZGluZy50b0xvd2VyQ2FzZSgpCgogIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgIGNhc2UgJ3V0ZjgnOgogICAgY2FzZSAndXRmLTgnOgogICAgICByZXR1cm4gJ3V0ZjgnCiAgICBjYXNlICd1Y3MyJzoKICAgIGNhc2UgJ3Vjcy0yJzoKICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgY2FzZSAndXRmLTE2bGUnOgogICAgICByZXR1cm4gJ3V0ZjE2bGUnCiAgICBjYXNlICdsYXRpbjEnOgogICAgY2FzZSAnYmluYXJ5JzoKICAgICAgcmV0dXJuICdsYXRpbjEnCiAgICBjYXNlICdiYXNlNjQnOgogICAgY2FzZSAnYXNjaWknOgogICAgY2FzZSAnaGV4JzoKICAgICAgcmV0dXJuIGVuY29kaW5nCiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBlbmNvZGluZykKICB9Cn07CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFBhc3NUaHJvdWdoRGVjb2RlciB7CiAgY29uc3RydWN0b3IgKGVuY29kaW5nKSB7CiAgICB0aGlzLmVuY29kaW5nID0gZW5jb2RpbmcKICB9CgogIGdldCByZW1haW5pbmcgKCkgewogICAgcmV0dXJuIDAKICB9CgogIGRlY29kZSAodGFpbCkgewogICAgcmV0dXJuIGI0YS50b1N0cmluZyh0YWlsLCB0aGlzLmVuY29kaW5nKQogIH0KCiAgZmx1c2ggKCkgewogICAgcmV0dXJuICcnCiAgfQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgovKioKICogaHR0cHM6Ly9lbmNvZGluZy5zcGVjLndoYXR3Zy5vcmcvI3V0Zi04LWRlY29kZXIKICovCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVVRGOERlY29kZXIgewogIGNvbnN0cnVjdG9yICgpIHsKICAgIHRoaXMuY29kZVBvaW50ID0gMAogICAgdGhpcy5ieXRlc1NlZW4gPSAwCiAgICB0aGlzLmJ5dGVzTmVlZGVkID0gMAogICAgdGhpcy5sb3dlckJvdW5kYXJ5ID0gMHg4MAogICAgdGhpcy51cHBlckJvdW5kYXJ5ID0gMHhiZgogIH0KCiAgZ2V0IHJlbWFpbmluZyAoKSB7CiAgICByZXR1cm4gdGhpcy5ieXRlc1NlZW4KICB9CgogIGRlY29kZSAoZGF0YSkgewogICAgLy8gSWYgd2UgaGF2ZSBhIGZhc3QgcGF0aCwganVzdCBzbmlmZiBpZiB0aGUgbGFzdCBwYXJ0IGlzIGEgYm91bmRhcnkKICAgIGlmICh0aGlzLmJ5dGVzTmVlZGVkID09PSAwKSB7CiAgICAgIGxldCBpc0JvdW5kYXJ5ID0gdHJ1ZQoKICAgICAgZm9yIChsZXQgaSA9IE1hdGgubWF4KDAsIGRhdGEuYnl0ZUxlbmd0aCAtIDQpLCBuID0gZGF0YS5ieXRlTGVuZ3RoOyBpIDwgbiAmJiBpc0JvdW5kYXJ5OyBpKyspIHsKICAgICAgICBpc0JvdW5kYXJ5ID0gZGF0YVtpXSA8PSAweDdmCiAgICAgIH0KCiAgICAgIGlmIChpc0JvdW5kYXJ5KSByZXR1cm4gYjRhLnRvU3RyaW5nKGRhdGEsICd1dGY4JykKICAgIH0KCiAgICBsZXQgcmVzdWx0ID0gJycKCiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGRhdGEuYnl0ZUxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCBieXRlID0gZGF0YVtpXQoKICAgICAgaWYgKHRoaXMuYnl0ZXNOZWVkZWQgPT09IDApIHsKICAgICAgICBpZiAoYnl0ZSA8PSAweDdmKSB7CiAgICAgICAgICByZXN1bHQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShieXRlKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmJ5dGVzU2VlbiA9IDEKCiAgICAgICAgICBpZiAoYnl0ZSA+PSAweGMyICYmIGJ5dGUgPD0gMHhkZikgewogICAgICAgICAgICB0aGlzLmJ5dGVzTmVlZGVkID0gMgogICAgICAgICAgICB0aGlzLmNvZGVQb2ludCA9IGJ5dGUgJiAweDFmCiAgICAgICAgICB9IGVsc2UgaWYgKGJ5dGUgPj0gMHhlMCAmJiBieXRlIDw9IDB4ZWYpIHsKICAgICAgICAgICAgaWYgKGJ5dGUgPT09IDB4ZTApIHRoaXMubG93ZXJCb3VuZGFyeSA9IDB4YTAKICAgICAgICAgICAgZWxzZSBpZiAoYnl0ZSA9PT0gMHhlZCkgdGhpcy51cHBlckJvdW5kYXJ5ID0gMHg5ZgogICAgICAgICAgICB0aGlzLmJ5dGVzTmVlZGVkID0gMwogICAgICAgICAgICB0aGlzLmNvZGVQb2ludCA9IGJ5dGUgJiAweGYKICAgICAgICAgIH0gZWxzZSBpZiAoYnl0ZSA+PSAweGYwICYmIGJ5dGUgPD0gMHhmNCkgewogICAgICAgICAgICBpZiAoYnl0ZSA9PT0gMHhmMCkgdGhpcy5sb3dlckJvdW5kYXJ5ID0gMHg5MAogICAgICAgICAgICBpZiAoYnl0ZSA9PT0gMHhmNCkgdGhpcy51cHBlckJvdW5kYXJ5ID0gMHg4ZgogICAgICAgICAgICB0aGlzLmJ5dGVzTmVlZGVkID0gNAogICAgICAgICAgICB0aGlzLmNvZGVQb2ludCA9IGJ5dGUgJiAweDcKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdCArPSAnXHVmZmZkJwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgaWYgKGJ5dGUgPCB0aGlzLmxvd2VyQm91bmRhcnkgfHwgYnl0ZSA+IHRoaXMudXBwZXJCb3VuZGFyeSkgewogICAgICAgIHRoaXMuY29kZVBvaW50ID0gMAogICAgICAgIHRoaXMuYnl0ZXNOZWVkZWQgPSAwCiAgICAgICAgdGhpcy5ieXRlc1NlZW4gPSAwCiAgICAgICAgdGhpcy5sb3dlckJvdW5kYXJ5ID0gMHg4MAogICAgICAgIHRoaXMudXBwZXJCb3VuZGFyeSA9IDB4YmYKCiAgICAgICAgcmVzdWx0ICs9ICdcdWZmZmQnCgogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIHRoaXMubG93ZXJCb3VuZGFyeSA9IDB4ODAKICAgICAgdGhpcy51cHBlckJvdW5kYXJ5ID0gMHhiZgoKICAgICAgdGhpcy5jb2RlUG9pbnQgPSAodGhpcy5jb2RlUG9pbnQgPDwgNikgfCAoYnl0ZSAmIDB4M2YpCiAgICAgIHRoaXMuYnl0ZXNTZWVuKysKCiAgICAgIGlmICh0aGlzLmJ5dGVzU2VlbiAhPT0gdGhpcy5ieXRlc05lZWRlZCkgY29udGludWUKCiAgICAgIHJlc3VsdCArPSBTdHJpbmcuZnJvbUNvZGVQb2ludCh0aGlzLmNvZGVQb2ludCkKCiAgICAgIHRoaXMuY29kZVBvaW50ID0gMAogICAgICB0aGlzLmJ5dGVzTmVlZGVkID0gMAogICAgICB0aGlzLmJ5dGVzU2VlbiA9IDAKICAgIH0KCiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICBmbHVzaCAoKSB7CiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmJ5dGVzTmVlZGVkID4gMCA/ICdcdWZmZmQnIDogJycKCiAgICB0aGlzLmNvZGVQb2ludCA9IDAKICAgIHRoaXMuYnl0ZXNOZWVkZWQgPSAwCiAgICB0aGlzLmJ5dGVzU2VlbiA9IDAKICAgIHRoaXMubG93ZXJCb3VuZGFyeSA9IDB4ODAKICAgIHRoaXMudXBwZXJCb3VuZGFyeSA9IDB4YmYKCiAgICByZXR1cm4gcmVzdWx0CiAgfQp9CnsKICAibmFtZSI6ICJ0ZXh0LWRlY29kZXIiLAogICJ2ZXJzaW9uIjogIjEuMi4zIiwKICAiZGVzY3JpcHRpb24iOiAiU3RyZWFtaW5nIHRleHQgZGVjb2RlciB0aGF0IHByZXNlcnZlcyBtdWx0aWJ5dGUgVW5pY29kZSBjaGFyYWN0ZXJzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJsaWIiCiAgXSwKICAiYnJvd3NlciI6IHsKICAgICIuL2xpYi9wYXNzLXRocm91Z2gtZGVjb2Rlci5qcyI6ICIuL2xpYi9icm93c2VyLWRlY29kZXIuanMiLAogICAgIi4vbGliL3V0ZjgtZGVjb2Rlci5qcyI6ICIuL2xpYi9icm93c2VyLWRlY29kZXIuanMiCiAgfSwKICAicmVhY3QtbmF0aXZlIjogewogICAgIi4vbGliL3Bhc3MtdGhyb3VnaC1kZWNvZGVyLmpzIjogIi4vbGliL3Bhc3MtdGhyb3VnaC1kZWNvZGVyLmpzIiwKICAgICIuL2xpYi91dGY4LWRlY29kZXIuanMiOiAiLi9saWIvdXRmOC1kZWNvZGVyLmpzIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vdGV4dC1kZWNvZGVyLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3RleHQtZGVjb2Rlci9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3RleHQtZGVjb2RlciNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4zLjIiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVGltZU9yZGVyZWRTZXQgewogIGNvbnN0cnVjdG9yICgpIHsKICAgIHRoaXMub2xkZXN0ID0gbnVsbAogICAgdGhpcy5sYXRlc3QgPSBudWxsCiAgICB0aGlzLmxlbmd0aCA9IDAKICB9CgogIGhhcyAobm9kZSkgewogICAgcmV0dXJuICEhKG5vZGUubmV4dCB8fCBub2RlLnByZXYpIHx8IG5vZGUgPT09IHRoaXMub2xkZXN0CiAgfQoKICBhZGQgKG5vZGUpIHsKICAgIGlmICh0aGlzLmhhcyhub2RlKSkgdGhpcy5yZW1vdmUobm9kZSkKCiAgICBpZiAoIXRoaXMubGF0ZXN0ICYmICF0aGlzLm9sZGVzdCkgewogICAgICB0aGlzLmxhdGVzdCA9IHRoaXMub2xkZXN0ID0gbm9kZQogICAgICBub2RlLnByZXYgPSBub2RlLm5leHQgPSBudWxsCiAgICB9IGVsc2UgewogICAgICB0aGlzLmxhdGVzdC5uZXh0ID0gbm9kZQogICAgICBub2RlLnByZXYgPSB0aGlzLmxhdGVzdAogICAgICBub2RlLm5leHQgPSBudWxsCiAgICAgIHRoaXMubGF0ZXN0ID0gbm9kZQogICAgfQoKICAgIHRoaXMubGVuZ3RoKysKCiAgICByZXR1cm4gbm9kZQogIH0KCiAgcmVtb3ZlIChub2RlKSB7CiAgICBpZiAoIXRoaXMuaGFzKG5vZGUpKSByZXR1cm4gbm9kZQoKICAgIGlmICh0aGlzLm9sZGVzdCAhPT0gbm9kZSAmJiB0aGlzLmxhdGVzdCAhPT0gbm9kZSkgewogICAgICBub2RlLnByZXYubmV4dCA9IG5vZGUubmV4dAogICAgICBub2RlLm5leHQucHJldiA9IG5vZGUucHJldgogICAgfSBlbHNlIHsKICAgICAgaWYgKHRoaXMub2xkZXN0ID09PSBub2RlKSB7CiAgICAgICAgdGhpcy5vbGRlc3QgPSBub2RlLm5leHQKICAgICAgICBpZiAodGhpcy5vbGRlc3QpIHRoaXMub2xkZXN0LnByZXYgPSBudWxsCiAgICAgIH0KICAgICAgaWYgKHRoaXMubGF0ZXN0ID09PSBub2RlKSB7CiAgICAgICAgdGhpcy5sYXRlc3QgPSBub2RlLnByZXYKICAgICAgICBpZiAodGhpcy5sYXRlc3QpIHRoaXMubGF0ZXN0Lm5leHQgPSBudWxsCiAgICAgIH0KICAgIH0KCiAgICBub2RlLm5leHQgPSBub2RlLnByZXYgPSBudWxsCiAgICB0aGlzLmxlbmd0aC0tCgogICAgcmV0dXJuIG5vZGUKICB9CgogIHRvQXJyYXkgKHsgbGltaXQgPSBJbmZpbml0eSwgcmV2ZXJzZSA9IGZhbHNlIH0gPSB7fSkgewogICAgY29uc3QgbGlzdCA9IFtdCgogICAgaWYgKHJldmVyc2UpIHsKICAgICAgbGV0IG5vZGUgPSB0aGlzLmxhdGVzdAogICAgICB3aGlsZSAobm9kZSAmJiBsaW1pdC0tKSB7CiAgICAgICAgbGlzdC5wdXNoKG5vZGUpCiAgICAgICAgbm9kZSA9IG5vZGUucHJldgogICAgICB9CiAgICB9IGVsc2UgewogICAgICBsZXQgbm9kZSA9IHRoaXMub2xkZXN0CiAgICAgIHdoaWxlIChub2RlICYmIGxpbWl0LS0pIHsKICAgICAgICBsaXN0LnB1c2gobm9kZSkKICAgICAgICBub2RlID0gbm9kZS5uZXh0CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbGlzdAogIH0KfQp7CiAgIm5hbWUiOiAidGltZS1vcmRlcmVkLXNldCIsCiAgInZlcnNpb24iOiAiMi4wLjEiLAogICJkZXNjcmlwdGlvbiI6ICJFZmZpY2llbnRseSBtYWludGFpbiBhIHNldCBvZiBub2RlcyBvcmRlcmVkIGJ5IHRoZSB0aW1lIHRoZXkgd2VyZSBhZGRlZCB0byB0aGUgc2V0IiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjAuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMiIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3RpbWUtb3JkZXJlZC1zZXQuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3RpbWUtb3JkZXJlZC1zZXQvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvdGltZS1vcmRlcmVkLXNldCIKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFRpbWVyQnJvd3NlciB7CiAgY29uc3RydWN0b3IgKG1zLCBmbiwgY3R4ID0gbnVsbCwgaW50ZXJ2YWwgPSBmYWxzZSkgewogICAgdGhpcy5tcyA9IG1zCiAgICB0aGlzLm9udGltZW91dCA9IGZuCiAgICB0aGlzLmNvbnRleHQgPSBjdHggfHwgbnVsbAogICAgdGhpcy5pbnRlcnZhbCA9IGludGVydmFsCiAgICB0aGlzLmRvbmUgPSBmYWxzZQoKICAgIHRoaXMuX3RpbWVyID0gaW50ZXJ2YWwKICAgICAgPyBzZXRJbnRlcnZhbChjYWxsSW50ZXJ2YWwsIG1zLCB0aGlzKQogICAgICA6IHNldFRpbWVvdXQoY2FsbFRpbWVvdXQsIG1zLCB0aGlzKQogIH0KCiAgdW5yZWYgKCkge30KCiAgcmVmICgpIHt9CgogIHJlZnJlc2ggKCkgewogICAgaWYgKHRoaXMuZG9uZSkgcmV0dXJuCgogICAgaWYgKHRoaXMuaW50ZXJ2YWwpIHsKICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl90aW1lcikKICAgICAgdGhpcy5fdGltZXIgPSBzZXRJbnRlcnZhbChjYWxsSW50ZXJ2YWwsIHRoaXMubXMsIHRoaXMpCiAgICB9IGVsc2UgewogICAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZXIpCiAgICAgIHRoaXMuX3RpbWVyID0gc2V0VGltZW91dChjYWxsVGltZW91dCwgdGhpcy5tcywgdGhpcykKICAgIH0KICB9CgogIGRlc3Ryb3kgKCkgewogICAgdGhpcy5kb25lID0gdHJ1ZQogICAgdGhpcy5vbnRpbWVvdXQgPSBudWxsCgogICAgaWYgKHRoaXMuaW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwodGhpcy5fdGltZXIpCiAgICBlbHNlIGNsZWFyVGltZW91dCh0aGlzLl90aW1lcikKICB9CgogIHN0YXRpYyBvbmNlIChtcywgZm4sIGN0eCkgewogICAgcmV0dXJuIG5ldyB0aGlzKG1zLCBmbiwgY3R4LCBmYWxzZSkKICB9CgogIHN0YXRpYyBvbiAobXMsIGZuLCBjdHgpIHsKICAgIHJldHVybiBuZXcgdGhpcyhtcywgZm4sIGN0eCwgdHJ1ZSkKICB9Cn0KCmZ1bmN0aW9uIGNhbGxUaW1lb3V0IChzZWxmKSB7CiAgc2VsZi5kb25lID0gdHJ1ZQogIHNlbGYub250aW1lb3V0LmNhbGwoc2VsZi5jb250ZXh0KQp9CgpmdW5jdGlvbiBjYWxsSW50ZXJ2YWwgKHNlbGYpIHsKICBzZWxmLm9udGltZW91dC5jYWxsKHNlbGYuY29udGV4dCkKfQptb2R1bGUuZXhwb3J0cyA9IGlzTm9kZSgpCiAgPyByZXF1aXJlKCcuL25vZGUnKQogIDogcmVxdWlyZSgnLi9icm93c2VyJykKCmZ1bmN0aW9uIGlzTm9kZSAoKSB7CiAgY29uc3QgdG8gPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHt9LCAxMDAwKQogIGNsZWFyVGltZW91dCh0bykKICByZXR1cm4gISF0by5yZWZyZXNoCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBUaW1lciB7CiAgY29uc3RydWN0b3IgKG1zLCBmbiwgY3R4ID0gbnVsbCwgaW50ZXJ2YWwgPSBmYWxzZSkgewogICAgdGhpcy5tcyA9IG1zCiAgICB0aGlzLm9udGltZW91dCA9IGZuCiAgICB0aGlzLmNvbnRleHQgPSBjdHgKICAgIHRoaXMuaW50ZXJ2YWwgPSBpbnRlcnZhbAogICAgdGhpcy5kb25lID0gZmFsc2UKCiAgICB0aGlzLl90aW1lciA9IGludGVydmFsCiAgICAgID8gc2V0SW50ZXJ2YWwoY2FsbEludGVydmFsLCBtcywgdGhpcykKICAgICAgOiBzZXRUaW1lb3V0KGNhbGxUaW1lb3V0LCBtcywgdGhpcykKICB9CgogIHVucmVmICgpIHsKICAgIHRoaXMuX3RpbWVyLnVucmVmKCkKICB9CgogIHJlZiAoKSB7CiAgICB0aGlzLl90aW1lci5yZWYoKQogIH0KCiAgcmVmcmVzaCAoKSB7CiAgICBpZiAodGhpcy5kb25lICE9PSB0cnVlKSB0aGlzLl90aW1lci5yZWZyZXNoKCkKICB9CgogIGRlc3Ryb3kgKCkgewogICAgdGhpcy5kb25lID0gdHJ1ZQogICAgdGhpcy5vbnRpbWVvdXQgPSBudWxsCiAgICBpZiAodGhpcy5pbnRlcnZhbCkgY2xlYXJJbnRlcnZhbCh0aGlzLl90aW1lcikKICAgIGVsc2UgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVyKQogIH0KCiAgc3RhdGljIG9uY2UgKG1zLCBmbiwgY3R4KSB7CiAgICByZXR1cm4gbmV3IHRoaXMobXMsIGZuLCBjdHgsIGZhbHNlKQogIH0KCiAgc3RhdGljIG9uIChtcywgZm4sIGN0eCkgewogICAgcmV0dXJuIG5ldyB0aGlzKG1zLCBmbiwgY3R4LCB0cnVlKQogIH0KfQoKZnVuY3Rpb24gY2FsbFRpbWVvdXQgKHNlbGYpIHsKICBzZWxmLmRvbmUgPSB0cnVlCiAgc2VsZi5vbnRpbWVvdXQuY2FsbChzZWxmLmNvbnRleHQpCn0KCmZ1bmN0aW9uIGNhbGxJbnRlcnZhbCAoc2VsZikgewogIHNlbGYub250aW1lb3V0LmNhbGwoc2VsZi5jb250ZXh0KQp9CnsKICAibmFtZSI6ICJ0aW1lb3V0LXJlZnJlc2giLAogICJ2ZXJzaW9uIjogIjIuMC4xIiwKICAiZGVzY3JpcHRpb24iOiAiRWZmaWNpZW50bHkgcmVmcmVzaCBhIHRpbWVyIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE2LjAuNCIsCiAgICAidGFwZSI6ICJeNS41LjIiCiAgfSwKICAiYnJvd3NlciI6ICIuL2Jyb3dzZXIuanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgdGFwZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3RpbWVvdXQtcmVmcmVzaC5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvdGltZW91dC1yZWZyZXNoL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3RpbWVvdXQtcmVmcmVzaCIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBCdWZmZXJNYXAgewogIGNvbnN0cnVjdG9yIChvdGhlcikgewogICAgdGhpcy5tID0gb3RoZXIgPyBuZXcgTWFwKFsuLi5vdGhlci5tXSkgOiBuZXcgTWFwKCkKICB9CgogIGdldCBzaXplICgpIHsKICAgIHJldHVybiB0aGlzLm0uc2l6ZQogIH0KCiAgZ2V0IChrZXkpIHsKICAgIGlmIChiNGEuaXNCdWZmZXIoa2V5KSkga2V5ID0gYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpCiAgICByZXR1cm4gdGhpcy5tLmdldChrZXkpCiAgfQoKICBzZXQgKGtleSwgdmFsdWUpIHsKICAgIGlmIChiNGEuaXNCdWZmZXIoa2V5KSkga2V5ID0gYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpCiAgICByZXR1cm4gdGhpcy5tLnNldChrZXksIHZhbHVlKQogIH0KCiAgZGVsZXRlIChrZXkpIHsKICAgIGlmIChiNGEuaXNCdWZmZXIoa2V5KSkga2V5ID0gYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpCiAgICByZXR1cm4gdGhpcy5tLmRlbGV0ZShrZXkpCiAgfQoKICBoYXMgKGtleSkgewogICAgaWYgKGI0YS5pc0J1ZmZlcihrZXkpKSBrZXkgPSBiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykKICAgIHJldHVybiB0aGlzLm0uaGFzKGtleSkKICB9CgogICogW1N5bWJvbC5pdGVyYXRvcl0gKCkgewogICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgdGhpcy5tKSB7CiAgICAgIHlpZWxkIFtiNGEuZnJvbShrZXksICdoZXgnKSwgdmFsdWVdCiAgICB9CiAgfQoKICAqIGtleXMgKCkgewogICAgZm9yIChjb25zdCBrZXkgb2YgdGhpcy5tLmtleXMoKSkgewogICAgICB5aWVsZCBiNGEuZnJvbShrZXksICdoZXgnKQogICAgfQogIH0KCiAgdmFsdWVzICgpIHsKICAgIHJldHVybiB0aGlzLm0udmFsdWVzKCkKICB9CgogIGNsZWFyICgpIHsKICAgIHJldHVybiB0aGlzLm0uY2xlYXIoKQogIH0KfQp7CiAgIm5hbWUiOiAidGlueS1idWZmZXItbWFwIiwKICAidmVyc2lvbiI6ICIxLjEuMSIsCiAgImRlc2NyaXB0aW9uIjogIkEgdmVyeSBzaW1wbGUgbWFwIGZvciBCdWZmZXJzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vYW5kcmV3b3NoL3RpbnktYnVmZmVyLW1hcC5naXQiCiAgfSwKICAia2V5d29yZHMiOiBbCiAgICAiYnVmZmVyIiwKICAgICJtYXAiCiAgXSwKICAiYXV0aG9yIjogIkFuZHJldyBPc2hlcm9mZiA8YW5kcmV3b3NoQGdtYWlsLmNvbT4iLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9hbmRyZXdvc2gvdGlueS1idWZmZXItbWFwL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vYW5kcmV3b3NoL3RpbnktYnVmZmVyLW1hcCNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4wLjQiCiAgfQp9CnJlcXVpcmUuYWRkb24gPSByZXF1aXJlKCdyZXF1aXJlLWFkZG9uJykKCm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZS5hZGRvbignLicsIF9fZmlsZW5hbWUpCi8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCmNvbnN0IHY0U2VnID0gJyg/OlswLTldfFsxLTldWzAtOV18MVswLTldWzAtOV18MlswLTRdWzAtOV18MjVbMC01XSknCmNvbnN0IHY0U3RyID0gYCgke3Y0U2VnfVsuXSl7M30ke3Y0U2VnfWAKY29uc3QgSVB2NFBhdHRlcm4gPSBuZXcgUmVnRXhwKGBeJHt2NFN0cn0kYCkKCmNvbnN0IHY2U2VnID0gJyg/OlswLTlhLWZBLUZdezEsNH0pJwpjb25zdCBJUHY2UGF0dGVybiA9IG5ldyBSZWdFeHAoCiAgJ14oJyArCiAgICBgKD86JHt2NlNlZ306KXs3fSg/OiR7djZTZWd9fDopfGAgKwogICAgYCg/OiR7djZTZWd9Oil7Nn0oPzoke3Y0U3RyfXw6JHt2NlNlZ318Oil8YCArCiAgICBgKD86JHt2NlNlZ306KXs1fSg/Ojoke3Y0U3RyfXwoOiR7djZTZWd9KXsxLDJ9fDopfGAgKwogICAgYCg/OiR7djZTZWd9Oil7NH0oPzooOiR7djZTZWd9KXswLDF9OiR7djRTdHJ9fCg6JHt2NlNlZ30pezEsM318Oil8YCArCiAgICBgKD86JHt2NlNlZ306KXszfSg/Oig6JHt2NlNlZ30pezAsMn06JHt2NFN0cn18KDoke3Y2U2VnfSl7MSw0fXw6KXxgICsKICAgIGAoPzoke3Y2U2VnfTopezJ9KD86KDoke3Y2U2VnfSl7MCwzfToke3Y0U3RyfXwoOiR7djZTZWd9KXsxLDV9fDopfGAgKwogICAgYCg/OiR7djZTZWd9Oil7MX0oPzooOiR7djZTZWd9KXswLDR9OiR7djRTdHJ9fCg6JHt2NlNlZ30pezEsNn18Oil8YCArCiAgICBgKD86OigoPzo6JHt2NlNlZ30pezAsNX06JHt2NFN0cn18KD86OiR7djZTZWd9KXsxLDd9fDopKWAgKwogICAgJykoJVswLTlhLXpBLVotLjpdezEsfSk/JCcKKQoKY29uc3QgaXNJUHY0ID0gKGV4cG9ydHMuaXNJUHY0ID0gZnVuY3Rpb24gaXNJUHY0KGhvc3QpIHsKICByZXR1cm4gSVB2NFBhdHRlcm4udGVzdChob3N0KQp9KQoKY29uc3QgaXNJUHY2ID0gKGV4cG9ydHMuaXNJUHY2ID0gZnVuY3Rpb24gaXNJUHY2KGhvc3QpIHsKICByZXR1cm4gSVB2NlBhdHRlcm4udGVzdChob3N0KQp9KQoKZXhwb3J0cy5pc0lQID0gZnVuY3Rpb24gaXNJUChob3N0KSB7CiAgaWYgKGlzSVB2NChob3N0KSkgcmV0dXJuIDQKICBpZiAoaXNJUHY2KGhvc3QpKSByZXR1cm4gNgogIHJldHVybiAwCn0KY29uc3QgZXZlbnRzID0gcmVxdWlyZSgnZXZlbnRzJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBOZXR3b3JrSW50ZXJmYWNlcyBleHRlbmRzIGV2ZW50cy5FdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKHVkeCkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuX2hhbmRsZSA9IGI0YS5hbGxvYyhiaW5kaW5nLnNpemVvZl91ZHhfbmFwaV9pbnRlcmZhY2VfZXZlbnRfdCkKICAgIHRoaXMuX3dhdGNoaW5nID0gZmFsc2UKICAgIHRoaXMuX2Rlc3Ryb3lpbmcgPSBudWxsCgogICAgYmluZGluZy51ZHhfbmFwaV9pbnRlcmZhY2VfZXZlbnRfaW5pdCgKICAgICAgdWR4Ll9oYW5kbGUsCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgdGhpcywKICAgICAgdGhpcy5fb25ldmVudCwKICAgICAgdGhpcy5fb25jbG9zZQogICAgKQoKICAgIHRoaXMuaW50ZXJmYWNlcyA9IGJpbmRpbmcudWR4X25hcGlfaW50ZXJmYWNlX2V2ZW50X2dldF9hZGRycyh0aGlzLl9oYW5kbGUpCiAgfQoKICBfb25jbG9zZSgpIHsKICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogIH0KCiAgX29uZXZlbnQoKSB7CiAgICB0aGlzLmludGVyZmFjZXMgPSBiaW5kaW5nLnVkeF9uYXBpX2ludGVyZmFjZV9ldmVudF9nZXRfYWRkcnModGhpcy5faGFuZGxlKQoKICAgIHRoaXMuZW1pdCgnY2hhbmdlJywgdGhpcy5pbnRlcmZhY2VzKQogIH0KCiAgd2F0Y2goKSB7CiAgICBpZiAodGhpcy5fd2F0Y2hpbmcpIHJldHVybiB0aGlzCiAgICB0aGlzLl93YXRjaGluZyA9IHRydWUKCiAgICBiaW5kaW5nLnVkeF9uYXBpX2ludGVyZmFjZV9ldmVudF9zdGFydCh0aGlzLl9oYW5kbGUpCgogICAgcmV0dXJuIHRoaXMKICB9CgogIHVud2F0Y2goKSB7CiAgICBpZiAoIXRoaXMuX3dhdGNoaW5nKSByZXR1cm4gdGhpcwogICAgdGhpcy5fd2F0Y2hpbmcgPSBmYWxzZQoKICAgIGJpbmRpbmcudWR4X25hcGlfaW50ZXJmYWNlX2V2ZW50X3N0b3AodGhpcy5faGFuZGxlKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBhc3luYyBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3lpbmcpIHJldHVybiB0aGlzLl9kZXN0cm95aW5nCiAgICB0aGlzLl9kZXN0cm95aW5nID0gZXZlbnRzLm9uY2UodGhpcywgJ2Nsb3NlJykKCiAgICBiaW5kaW5nLnVkeF9uYXBpX2ludGVyZmFjZV9ldmVudF9jbG9zZSh0aGlzLl9oYW5kbGUpCgogICAgcmV0dXJuIHRoaXMuX2Rlc3Ryb3lpbmcKICB9CgogIFtTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgcmV0dXJuIHRoaXMuaW50ZXJmYWNlc1tTeW1ib2wuaXRlcmF0b3JdKCkKICB9Cn0KY29uc3QgZXZlbnRzID0gcmVxdWlyZSgnZXZlbnRzJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQpjb25zdCBpcCA9IHJlcXVpcmUoJy4vaXAnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBVRFhTb2NrZXQgZXh0ZW5kcyBldmVudHMuRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3Rvcih1ZHgsIG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMudWR4ID0gdWR4CgogICAgdGhpcy5faGFuZGxlID0gYjRhLmFsbG9jKGJpbmRpbmcuc2l6ZW9mX3VkeF9uYXBpX3NvY2tldF90KQogICAgdGhpcy5faW5pdGVkID0gZmFsc2UKICAgIHRoaXMuX2hvc3QgPSBudWxsCiAgICB0aGlzLl9mYW1pbHkgPSAwCiAgICB0aGlzLl9pcHY2T25seSA9IG9wdHMuaXB2Nk9ubHkgPT09IHRydWUKICAgIHRoaXMuX3JldXNlQWRkcmVzcyA9IG9wdHMucmV1c2VBZGRyZXNzID09PSB0cnVlCiAgICB0aGlzLl9wb3J0ID0gMAogICAgdGhpcy5fcmVxcyA9IFtdCiAgICB0aGlzLl9mcmVlID0gW10KICAgIHRoaXMuX2Nsb3NpbmcgPSBudWxsCiAgICB0aGlzLl9jbG9zZWQgPSBmYWxzZQoKICAgIHRoaXMuX3ZpZXc2NCA9IG5ldyBCaWdVaW50NjRBcnJheSgKICAgICAgdGhpcy5faGFuZGxlLmJ1ZmZlciwKICAgICAgdGhpcy5faGFuZGxlLmJ5dGVPZmZzZXQsCiAgICAgIHRoaXMuX2hhbmRsZS5ieXRlTGVuZ3RoID4+IDMKICAgICkKCiAgICB0aGlzLnN0cmVhbXMgPSBuZXcgU2V0KCkKCiAgICB0aGlzLnVzZXJEYXRhID0gbnVsbAogIH0KCiAgZ2V0IGJvdW5kKCkgewogICAgcmV0dXJuIHRoaXMuX3BvcnQgIT09IDAKICB9CgogIGdldCBjbG9zaW5nKCkgewogICAgcmV0dXJuIHRoaXMuX2Nsb3NpbmcgIT09IG51bGwKICB9CgogIGdldCBpZGxlKCkgewogICAgcmV0dXJuIHRoaXMuc3RyZWFtcy5zaXplID09PSAwCiAgfQoKICBnZXQgYnVzeSgpIHsKICAgIHJldHVybiB0aGlzLnN0cmVhbXMuc2l6ZSA+IDAKICB9CgogIGdldCBieXRlc1RyYW5zbWl0dGVkKCkgewogICAgaWYgKHRoaXMuX2luaXRlZCAhPT0gdHJ1ZSkgcmV0dXJuIDAKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3NvY2tldF90X2J5dGVzX3R4ID4+IDNdKQogIH0KCiAgZ2V0IHBhY2tldHNUcmFuc21pdHRlZCgpIHsKICAgIGlmICh0aGlzLl9pbml0ZWQgIT09IHRydWUpIHJldHVybiAwCiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF9zb2NrZXRfdF9wYWNrZXRzX3R4ID4+IDNdKQogIH0KCiAgZ2V0IGJ5dGVzUmVjZWl2ZWQoKSB7CiAgICBpZiAodGhpcy5faW5pdGVkICE9PSB0cnVlKSByZXR1cm4gMAogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfc29ja2V0X3RfYnl0ZXNfcnggPj4gM10pCiAgfQoKICBnZXQgcGFja2V0c1JlY2VpdmVkKCkgewogICAgaWYgKHRoaXMuX2luaXRlZCAhPT0gdHJ1ZSkgcmV0dXJuIDAKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3NvY2tldF90X3BhY2tldHNfcnggPj4gM10pCiAgfQoKICBnZXQgcGFja2V0c0Ryb3BwZWRCeUtlcm5lbCgpIHsKICAgIGlmICh0aGlzLl9pbml0ZWQgIT09IHRydWUpIHJldHVybiAwCiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF9zb2NrZXRfdF9wYWNrZXRzX2Ryb3BwZWRfYnlfa2VybmVsID4+IDNdKQogIH0KCiAgdG9KU09OKCkgewogICAgcmV0dXJuIHsKICAgICAgYm91bmQ6IHRoaXMuYm91bmQsCiAgICAgIGNsb3Npbmc6IHRoaXMuY2xvc2luZywKICAgICAgc3RyZWFtczogdGhpcy5zdHJlYW1zLnNpemUsCiAgICAgIGFkZHJlc3M6IHRoaXMuYWRkcmVzcygpLAogICAgICBpcHY2T25seTogdGhpcy5faXB2Nk9ubHksCiAgICAgIHJldXNlQWRkcmVzczogdGhpcy5fcmV1c2VBZGRyZXNzLAogICAgICBpZGxlOiB0aGlzLmlkbGUsCiAgICAgIGJ1c3k6IHRoaXMuYnVzeQogICAgfQogIH0KCiAgX2luaXQoKSB7CiAgICBpZiAodGhpcy5faW5pdGVkKSByZXR1cm4KCiAgICBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9pbml0KAogICAgICB0aGlzLnVkeC5faGFuZGxlLAogICAgICB0aGlzLl9oYW5kbGUsCiAgICAgIHRoaXMsCiAgICAgIHRoaXMuX29uc2VuZCwKICAgICAgdGhpcy5fb25tZXNzYWdlLAogICAgICB0aGlzLl9vbmNsb3NlLAogICAgICB0aGlzLl9yZWFsbG9jTWVzc2FnZQogICAgKQoKICAgIHRoaXMuX2luaXRlZCA9IHRydWUKICB9CgogIF9vbnNlbmQoaWQsIGVycikgewogICAgY29uc3QgcmVxID0gdGhpcy5fcmVxc1tpZF0KCiAgICBjb25zdCBvbmZsdXNoID0gcmVxLm9uZmx1c2gKCiAgICByZXEuYnVmZmVyID0gbnVsbAogICAgcmVxLm9uZmx1c2ggPSBudWxsCgogICAgdGhpcy5fZnJlZS5wdXNoKGlkKQoKICAgIG9uZmx1c2goZXJyID49IDApCgogICAgLy8gZ2MgdGhlIGZyZWUgbGlzdAogICAgaWYgKHRoaXMuX2ZyZWUubGVuZ3RoID49IDE2ICYmIHRoaXMuX2ZyZWUubGVuZ3RoID09PSB0aGlzLl9yZXFzLmxlbmd0aCkgewogICAgICB0aGlzLl9mcmVlID0gW10KICAgICAgdGhpcy5fcmVxcyA9IFtdCiAgICB9CiAgfQoKICBfb25tZXNzYWdlKGxlbiwgcG9ydCwgaG9zdCwgZmFtaWx5KSB7CiAgICB0aGlzLmVtaXQoJ21lc3NhZ2UnLCB0aGlzLnVkeC5fY29uc3VtZU1lc3NhZ2UobGVuKSwgeyBob3N0LCBmYW1pbHksIHBvcnQgfSkKICAgIHJldHVybiB0aGlzLnVkeC5fYnVmZmVyCiAgfQoKICBfb25jbG9zZSgpIHsKICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogIH0KCiAgX3JlYWxsb2NNZXNzYWdlKCkgewogICAgcmV0dXJuIHRoaXMudWR4Ll9yZWFsbG9jTWVzc2FnZSgpCiAgfQoKICBfb25pZGxlKCkgewogICAgdGhpcy5lbWl0KCdpZGxlJykKICB9CgogIF9vbmJ1c3koKSB7CiAgICB0aGlzLmVtaXQoJ2J1c3knKQogIH0KCiAgX2FkZFN0cmVhbShzdHJlYW0pIHsKICAgIGlmICh0aGlzLnN0cmVhbXMuaGFzKHN0cmVhbSkpIHJldHVybiBmYWxzZQogICAgdGhpcy5zdHJlYW1zLmFkZChzdHJlYW0pCiAgICBpZiAodGhpcy5zdHJlYW1zLnNpemUgPT09IDEpIHRoaXMuX29uYnVzeSgpCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3JlbW92ZVN0cmVhbShzdHJlYW0pIHsKICAgIGlmICghdGhpcy5zdHJlYW1zLmhhcyhzdHJlYW0pKSByZXR1cm4gZmFsc2UKICAgIHRoaXMuc3RyZWFtcy5kZWxldGUoc3RyZWFtKQogICAgY29uc3QgY2xvc2VkID0gdGhpcy5fY2xvc2VNYXliZSgpCiAgICBpZiAodGhpcy5pZGxlICYmICFjbG9zZWQpIHRoaXMuX29uaWRsZSgpCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYWRkcmVzcygpIHsKICAgIGlmICghdGhpcy5ib3VuZCkgcmV0dXJuIG51bGwKICAgIHJldHVybiB7IGhvc3Q6IHRoaXMuX2hvc3QsIGZhbWlseTogdGhpcy5fZmFtaWx5LCBwb3J0OiB0aGlzLl9wb3J0IH0KICB9CgogIGJpbmQocG9ydCwgaG9zdCkgewogICAgaWYgKHRoaXMuYm91bmQpIHRocm93IG5ldyBFcnJvcignQWxyZWFkeSBib3VuZCcpCiAgICBpZiAodGhpcy5jbG9zaW5nKSB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCBpcyBjbG9zZWQnKQoKICAgIGlmICghcG9ydCkgcG9ydCA9IDAKCiAgICBsZXQgZmxhZ3MgPSAwCiAgICBpZiAodGhpcy5faXB2Nk9ubHkpIGZsYWdzIHw9IGJpbmRpbmcuVVZfVURQX0lQVjZPTkxZCiAgICBpZiAodGhpcy5fcmV1c2VBZGRyZXNzKSBmbGFncyB8PSBiaW5kaW5nLlVWX1VEUF9SRVVTRUFERFIKCiAgICBsZXQgZmFtaWx5CgogICAgaWYgKGhvc3QpIHsKICAgICAgZmFtaWx5ID0gaXAuaXNJUChob3N0KQogICAgICBpZiAoIWZhbWlseSkgdGhyb3cgbmV3IEVycm9yKGAke2hvc3R9IGlzIG5vdCBhIHZhbGlkIElQIGFkZHJlc3NgKQoKICAgICAgaWYgKCF0aGlzLl9pbml0ZWQpIHRoaXMuX2luaXQoKQoKICAgICAgdGhpcy5fcG9ydCA9IGJpbmRpbmcudWR4X25hcGlfc29ja2V0X2JpbmQodGhpcy5faGFuZGxlLCBwb3J0LCBob3N0LCBmYW1pbHksIGZsYWdzKQogICAgfSBlbHNlIHsKICAgICAgaWYgKCF0aGlzLl9pbml0ZWQpIHRoaXMuX2luaXQoKQoKICAgICAgdHJ5IHsKICAgICAgICBob3N0ID0gJzo6JwogICAgICAgIGZhbWlseSA9IDYKICAgICAgICB0aGlzLl9wb3J0ID0gYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfYmluZCh0aGlzLl9oYW5kbGUsIHBvcnQsIGhvc3QsIGZhbWlseSwgZmxhZ3MpCiAgICAgIH0gY2F0Y2ggewogICAgICAgIGhvc3QgPSAnMC4wLjAuMCcKICAgICAgICBmYW1pbHkgPSA0CiAgICAgICAgdGhpcy5fcG9ydCA9IGJpbmRpbmcudWR4X25hcGlfc29ja2V0X2JpbmQodGhpcy5faGFuZGxlLCBwb3J0LCBob3N0LCBmYW1pbHksIGZsYWdzKQogICAgICB9CiAgICB9CgogICAgdGhpcy5faG9zdCA9IGhvc3QKICAgIHRoaXMuX2ZhbWlseSA9IGZhbWlseQoKICAgIHRoaXMuZW1pdCgnbGlzdGVuaW5nJykKICB9CgogIGFzeW5jIGNsb3NlKCkgewogICAgaWYgKHRoaXMuX2Nsb3NpbmcpIHJldHVybiB0aGlzLl9jbG9zaW5nCiAgICB0aGlzLl9jbG9zaW5nID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHRoaXMub25jZSgnY2xvc2UnLCByZXNvbHZlKSkKICAgIHRoaXMuX2Nsb3NlTWF5YmUoKQogICAgcmV0dXJuIHRoaXMuX2Nsb3NpbmcKICB9CgogIF9jbG9zZU1heWJlKCkgewogICAgaWYgKHRoaXMuX2Nsb3NlZCB8fCB0aGlzLl9jbG9zaW5nID09PSBudWxsKSByZXR1cm4gdGhpcy5fY2xvc2VkCgogICAgaWYgKCF0aGlzLl9pbml0ZWQpIHsKICAgICAgdGhpcy5fY2xvc2VkID0gdHJ1ZQogICAgICB0aGlzLmVtaXQoJ2Nsb3NlJykKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBpZiAodGhpcy5pZGxlKSB7CiAgICAgIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X2Nsb3NlKHRoaXMuX2hhbmRsZSkKICAgICAgdGhpcy5fY2xvc2VkID0gdHJ1ZQogICAgfQoKICAgIHJldHVybiB0aGlzLl9jbG9zZWQKICB9CgogIHNldFRUTCh0dGwpIHsKICAgIGlmICghdGhpcy5faW5pdGVkKSB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCBub3QgYWN0aXZlJykKICAgIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X3NldF90dGwodGhpcy5faGFuZGxlLCB0dGwpCiAgfQoKICBnZXRSZWN2QnVmZmVyU2l6ZSgpIHsKICAgIGlmICghdGhpcy5faW5pdGVkKSB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCBub3QgYWN0aXZlJykKICAgIHJldHVybiBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9nZXRfcmVjdl9idWZmZXJfc2l6ZSh0aGlzLl9oYW5kbGUpCiAgfQoKICBzZXRSZWN2QnVmZmVyU2l6ZShzaXplKSB7CiAgICBpZiAoIXRoaXMuX2luaXRlZCkgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgbm90IGFjdGl2ZScpCiAgICByZXR1cm4gYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfc2V0X3JlY3ZfYnVmZmVyX3NpemUodGhpcy5faGFuZGxlLCBzaXplKQogIH0KCiAgZ2V0U2VuZEJ1ZmZlclNpemUoKSB7CiAgICBpZiAoIXRoaXMuX2luaXRlZCkgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgbm90IGFjdGl2ZScpCiAgICByZXR1cm4gYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfZ2V0X3NlbmRfYnVmZmVyX3NpemUodGhpcy5faGFuZGxlKQogIH0KCiAgc2V0U2VuZEJ1ZmZlclNpemUoc2l6ZSkgewogICAgaWYgKCF0aGlzLl9pbml0ZWQpIHRocm93IG5ldyBFcnJvcignU29ja2V0IG5vdCBhY3RpdmUnKQogICAgcmV0dXJuIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X3NldF9zZW5kX2J1ZmZlcl9zaXplKHRoaXMuX2hhbmRsZSwgc2l6ZSkKICB9CgogIGFkZE1lbWJlcnNoaXAoZ3JvdXAsIGlmYWNlQWRkcmVzcykgewogICAgaWYgKCF0aGlzLl9pbml0ZWQpIHRocm93IG5ldyBFcnJvcignU29ja2V0IG5vdCBhY3RpdmUnKQogICAgcmV0dXJuIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X3NldF9tZW1iZXJzaGlwKHRoaXMuX2hhbmRsZSwgZ3JvdXAsIGlmYWNlQWRkcmVzcyB8fCAnJywgdHJ1ZSkKICB9CgogIGRyb3BNZW1iZXJzaGlwKGdyb3VwLCBpZmFjZUFkZHJlc3MpIHsKICAgIGlmICghdGhpcy5faW5pdGVkKSB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCBub3QgYWN0aXZlJykKICAgIHJldHVybiBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9zZXRfbWVtYmVyc2hpcCh0aGlzLl9oYW5kbGUsIGdyb3VwLCBpZmFjZUFkZHJlc3MgfHwgJycsIGZhbHNlKQogIH0KCiAgYXN5bmMgc2VuZChidWZmZXIsIHBvcnQsIGhvc3QsIHR0bCkgewogICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuIGZhbHNlCgogICAgaWYgKCFob3N0KSBob3N0ID0gJzEyNy4wLjAuMScKCiAgICBjb25zdCBmYW1pbHkgPSBpcC5pc0lQKGhvc3QpCiAgICBpZiAoIWZhbWlseSkgdGhyb3cgbmV3IEVycm9yKGAke2hvc3R9IGlzIG5vdCBhIHZhbGlkIElQIGFkZHJlc3NgKQoKICAgIGlmICghdGhpcy5ib3VuZCkgdGhpcy5iaW5kKDApCgogICAgY29uc3QgaWQgPSB0aGlzLl9hbGxvY1NlbmQoKQogICAgY29uc3QgcmVxID0gdGhpcy5fcmVxc1tpZF0KCiAgICByZXEuYnVmZmVyID0gYnVmZmVyCgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgIHJlcS5vbmZsdXNoID0gcmVzb2x2ZQogICAgfSkKCiAgICBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9zZW5kX3R0bCgKICAgICAgdGhpcy5faGFuZGxlLAogICAgICByZXEuaGFuZGxlLAogICAgICBpZCwKICAgICAgYnVmZmVyLAogICAgICBwb3J0LAogICAgICBob3N0LAogICAgICBmYW1pbHksCiAgICAgIHR0bCB8fCAwCiAgICApCgogICAgcmV0dXJuIHByb21pc2UKICB9CgogIHRyeVNlbmQoYnVmZmVyLCBwb3J0LCBob3N0LCB0dGwpIHsKICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybgoKICAgIGlmICghaG9zdCkgaG9zdCA9ICcxMjcuMC4wLjEnCgogICAgY29uc3QgZmFtaWx5ID0gaXAuaXNJUChob3N0KQogICAgaWYgKCFmYW1pbHkpIHRocm93IG5ldyBFcnJvcihgJHtob3N0fSBpcyBub3QgYSB2YWxpZCBJUCBhZGRyZXNzYCkKCiAgICBpZiAoIXRoaXMuYm91bmQpIHRoaXMuYmluZCgwKQoKICAgIGNvbnN0IGlkID0gdGhpcy5fYWxsb2NTZW5kKCkKICAgIGNvbnN0IHJlcSA9IHRoaXMuX3JlcXNbaWRdCgogICAgcmVxLmJ1ZmZlciA9IGJ1ZmZlcgogICAgcmVxLm9uZmx1c2ggPSBub29wCgogICAgYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfc2VuZF90dGwoCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgcmVxLmhhbmRsZSwKICAgICAgaWQsCiAgICAgIGJ1ZmZlciwKICAgICAgcG9ydCwKICAgICAgaG9zdCwKICAgICAgZmFtaWx5LAogICAgICB0dGwgfHwgMAogICAgKQogIH0KCiAgX2FsbG9jU2VuZCgpIHsKICAgIGlmICh0aGlzLl9mcmVlLmxlbmd0aCA+IDApIHJldHVybiB0aGlzLl9mcmVlLnBvcCgpCiAgICBjb25zdCBoYW5kbGUgPSBiNGEuYWxsb2NVbnNhZmUoYmluZGluZy5zaXplb2ZfdWR4X3NvY2tldF9zZW5kX3QpCiAgICByZXR1cm4gdGhpcy5fcmVxcy5wdXNoKHsgaGFuZGxlLCBidWZmZXI6IG51bGwsIG9uZmx1c2g6IG51bGwgfSkgLSAxCiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KY29uc3Qgc3RyZWFteCA9IHJlcXVpcmUoJ3N0cmVhbXgnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGlwID0gcmVxdWlyZSgnLi9pcCcpCgpjb25zdCBNQVhfUEFDS0VUID0gMjA0OApjb25zdCBCVUZGRVJfU0laRSA9IDY1NTM2ICsgTUFYX1BBQ0tFVAoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBVRFhTdHJlYW0gZXh0ZW5kcyBzdHJlYW14LkR1cGxleCB7CiAgY29uc3RydWN0b3IodWR4LCBpZCwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcih7IG1hcFdyaXRhYmxlOiB0b0J1ZmZlciwgZWFnZXJPcGVuOiB0cnVlIH0pCgogICAgdGhpcy51ZHggPSB1ZHgKICAgIHRoaXMuc29ja2V0ID0gbnVsbAoKICAgIHRoaXMuX2hhbmRsZSA9IGI0YS5hbGxvYyhiaW5kaW5nLnNpemVvZl91ZHhfbmFwaV9zdHJlYW1fdCkKICAgIHRoaXMuX3ZpZXcgPSBuZXcgVWludDMyQXJyYXkoCiAgICAgIHRoaXMuX2hhbmRsZS5idWZmZXIsCiAgICAgIHRoaXMuX2hhbmRsZS5ieXRlT2Zmc2V0LAogICAgICB0aGlzLl9oYW5kbGUuYnl0ZUxlbmd0aCA+PiAyCiAgICApCiAgICB0aGlzLl92aWV3MTYgPSBuZXcgVWludDE2QXJyYXkoCiAgICAgIHRoaXMuX2hhbmRsZS5idWZmZXIsCiAgICAgIHRoaXMuX2hhbmRsZS5ieXRlT2Zmc2V0LAogICAgICB0aGlzLl9oYW5kbGUuYnl0ZUxlbmd0aCA+PiAxCiAgICApCiAgICB0aGlzLl92aWV3NjQgPSBuZXcgQmlnVWludDY0QXJyYXkoCiAgICAgIHRoaXMuX2hhbmRsZS5idWZmZXIsCiAgICAgIHRoaXMuX2hhbmRsZS5ieXRlT2Zmc2V0LAogICAgICB0aGlzLl9oYW5kbGUuYnl0ZUxlbmd0aCA+PiAzCiAgICApCgogICAgdGhpcy5fd3JlcXMgPSBbXQogICAgdGhpcy5fd2ZyZWUgPSBbXQoKICAgIHRoaXMuX3NyZXFzID0gW10KICAgIHRoaXMuX3NmcmVlID0gW10KICAgIHRoaXMuX2Nsb3NlZCA9IGZhbHNlCgogICAgdGhpcy5fZmx1c2hpbmcgPSAwCiAgICB0aGlzLl9mbHVzaGVzID0gW10KCiAgICB0aGlzLl9idWZmZXIgPSBudWxsCiAgICB0aGlzLl9yZWFsbG9jRGF0YSgpCgogICAgdGhpcy5fb253cml0ZSA9IG51bGwKICAgIHRoaXMuX29uZGVzdHJveSA9IG51bGwKICAgIHRoaXMuX2ZpcmV3YWxsID0gb3B0cy5maXJld2FsbCB8fCBmaXJld2FsbEFsbAoKICAgIHRoaXMuX3JlbW90ZUNoYW5naW5nID0gbnVsbAogICAgdGhpcy5fcHJldmlvdXNTb2NrZXQgPSBudWxsCgogICAgdGhpcy5pZCA9IGlkCiAgICB0aGlzLnJlbW90ZUlkID0gMAogICAgdGhpcy5yZW1vdGVIb3N0ID0gbnVsbAogICAgdGhpcy5yZW1vdGVGYW1pbHkgPSAwCiAgICB0aGlzLnJlbW90ZVBvcnQgPSAwCgogICAgdGhpcy51c2VyRGF0YSA9IG51bGwKCiAgICBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV9pbml0KAogICAgICB0aGlzLnVkeC5faGFuZGxlLAogICAgICB0aGlzLl9oYW5kbGUsCiAgICAgIGlkLAogICAgICBvcHRzLmZyYW1lZCA/IDEgOiAwLAogICAgICB0aGlzLAogICAgICB0aGlzLl9vbmRhdGEsCiAgICAgIHRoaXMuX29uZW5kLAogICAgICB0aGlzLl9vbmRyYWluLAogICAgICB0aGlzLl9vbmFjaywKICAgICAgdGhpcy5fb25zZW5kLAogICAgICB0aGlzLl9vbm1lc3NhZ2UsCiAgICAgIHRoaXMuX29uY2xvc2UsCiAgICAgIHRoaXMuX29uZmlyZXdhbGwsCiAgICAgIHRoaXMuX29ucmVtb3RlY2hhbmdlZCwKICAgICAgdGhpcy5fcmVhbGxvY0RhdGEsCiAgICAgIHRoaXMuX3JlYWxsb2NNZXNzYWdlCiAgICApCgogICAgaWYgKG9wdHMuc2VxKSBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV9zZXRfc2VxKHRoaXMuX2hhbmRsZSwgb3B0cy5zZXEpCgogICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fcmVjdl9zdGFydCh0aGlzLl9oYW5kbGUsIHRoaXMuX2J1ZmZlcikKICB9CgogIGdldCBjb25uZWN0ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5zb2NrZXQgIT09IG51bGwKICB9CgogIGdldCBtdHUoKSB7CiAgICByZXR1cm4gdGhpcy5fdmlldzE2W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X210dSA+PiAxXQogIH0KCiAgZ2V0IHJ0dCgpIHsKICAgIHJldHVybiB0aGlzLl92aWV3W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X3NydHQgPj4gMl0KICB9CgogIGdldCBjd25kKCkgewogICAgcmV0dXJuIHRoaXMuX3ZpZXdbYmluZGluZy5vZmZzZXRvZl91ZHhfc3RyZWFtX3RfY3duZCA+PiAyXQogIH0KCiAgZ2V0IHJ0b0NvdW50KCkgewogICAgcmV0dXJuIHRoaXMuX3ZpZXcxNltiaW5kaW5nLm9mZnNldG9mX3VkeF9zdHJlYW1fdF9ydG9fY291bnQgPj4gMV0KICB9CgogIGdldCByZXRyYW5zbWl0cygpIHsKICAgIHJldHVybiB0aGlzLl92aWV3MTZbYmluZGluZy5vZmZzZXRvZl91ZHhfc3RyZWFtX3RfcmV0cmFuc21pdF9jb3VudCA+PiAxXQogIH0KCiAgZ2V0IGZhc3RSZWNvdmVyaWVzKCkgewogICAgcmV0dXJuIHRoaXMuX3ZpZXcxNltiaW5kaW5nLm9mZnNldG9mX3VkeF9zdHJlYW1fdF9mYXN0X3JlY292ZXJ5X2NvdW50ID4+IDFdCiAgfQoKICBnZXQgaW5mbGlnaHQoKSB7CiAgICByZXR1cm4gdGhpcy5fdmlld1tiaW5kaW5nLm9mZnNldG9mX3VkeF9zdHJlYW1fdF9pbmZsaWdodCA+PiAyXQogIH0KCiAgZ2V0IGJ5dGVzVHJhbnNtaXR0ZWQoKSB7CiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF9zdHJlYW1fdF9ieXRlc190eCA+PiAzXSkKICB9CgogIGdldCBwYWNrZXRzVHJhbnNtaXR0ZWQoKSB7CiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF9zdHJlYW1fdF9wYWNrZXRzX3R4ID4+IDNdKQogIH0KCiAgZ2V0IGJ5dGVzUmVjZWl2ZWQoKSB7CiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF9zdHJlYW1fdF9ieXRlc19yeCA+PiAzXSkKICB9CgogIGdldCBwYWNrZXRzUmVjZWl2ZWQoKSB7CiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF9zdHJlYW1fdF9wYWNrZXRzX3J4ID4+IDNdKQogIH0KCiAgZ2V0IGxvY2FsSG9zdCgpIHsKICAgIHJldHVybiB0aGlzLnNvY2tldCA/IHRoaXMuc29ja2V0LmFkZHJlc3MoKS5ob3N0IDogbnVsbAogIH0KCiAgZ2V0IGxvY2FsRmFtaWx5KCkgewogICAgcmV0dXJuIHRoaXMuc29ja2V0ID8gdGhpcy5zb2NrZXQuYWRkcmVzcygpLmZhbWlseSA6IDAKICB9CgogIGdldCBsb2NhbFBvcnQoKSB7CiAgICByZXR1cm4gdGhpcy5zb2NrZXQgPyB0aGlzLnNvY2tldC5hZGRyZXNzKCkucG9ydCA6IDAKICB9CgogIHNldEludGVyYWN0aXZlKGJvb2wpIHsKICAgIGlmICghdGhpcy5fY2xvc2VkKSByZXR1cm4KICAgIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX3NldF9tb2RlKHRoaXMuX2hhbmRsZSwgYm9vbCA/IDAgOiAxKQogIH0KCiAgY29ubmVjdChzb2NrZXQsIHJlbW90ZUlkLCBwb3J0LCBob3N0LCBvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLl9jbG9zZWQpIHJldHVybgoKICAgIGlmICh0aGlzLmNvbm5lY3RlZCkgdGhyb3cgbmV3IEVycm9yKCdBbHJlYWR5IGNvbm5lY3RlZCcpCiAgICBpZiAoc29ja2V0LmNsb3NpbmcpIHRocm93IG5ldyBFcnJvcignU29ja2V0IGlzIGNsb3NlZCcpCgogICAgaWYgKHR5cGVvZiBob3N0ID09PSAnb2JqZWN0JykgewogICAgICBvcHRzID0gaG9zdAogICAgICBob3N0ID0gbnVsbAogICAgfQoKICAgIGlmICghaG9zdCkgaG9zdCA9ICcxMjcuMC4wLjEnCgogICAgY29uc3QgZmFtaWx5ID0gaXAuaXNJUChob3N0KQogICAgaWYgKCFmYW1pbHkpIHRocm93IG5ldyBFcnJvcihgJHtob3N0fSBpcyBub3QgYSB2YWxpZCBJUCBhZGRyZXNzYCkKICAgIGlmICghKHBvcnQgPiAwICYmIHBvcnQgPCA2NTUzNikpIHRocm93IG5ldyBFcnJvcihgJHtwb3J0fSBpcyBub3QgYSB2YWxpZCBwb3J0YCkKCiAgICBpZiAoIXNvY2tldC5ib3VuZCkgc29ja2V0LmJpbmQoMCkKCiAgICB0aGlzLnJlbW90ZUlkID0gcmVtb3RlSWQKICAgIHRoaXMucmVtb3RlUG9ydCA9IHBvcnQKICAgIHRoaXMucmVtb3RlSG9zdCA9IGhvc3QKICAgIHRoaXMucmVtb3RlRmFtaWx5ID0gZmFtaWx5CiAgICB0aGlzLnNvY2tldCA9IHNvY2tldAoKICAgIGlmIChvcHRzLmFjaykgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fc2V0X2Fjayh0aGlzLl9oYW5kbGUsIG9wdHMuYWNrKQoKICAgIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX2Nvbm5lY3QodGhpcy5faGFuZGxlLCBzb2NrZXQuX2hhbmRsZSwgcmVtb3RlSWQsIHBvcnQsIGhvc3QsIGZhbWlseSkKCiAgICB0aGlzLnNvY2tldC5fYWRkU3RyZWFtKHRoaXMpCgogICAgdGhpcy5lbWl0KCdjb25uZWN0JykKICB9CgogIGNoYW5nZVJlbW90ZShzb2NrZXQsIHJlbW90ZUlkLCBwb3J0LCBob3N0KSB7CiAgICBpZiAodGhpcy5fcmVtb3RlQ2hhbmdpbmcpIHRocm93IG5ldyBFcnJvcignUmVtb3RlIGFscmVhZHkgY2hhbmdpbmcnKQoKICAgIGlmICghdGhpcy5jb25uZWN0ZWQpIHRocm93IG5ldyBFcnJvcignTm90IHlldCBjb25uZWN0ZWQnKQogICAgaWYgKHNvY2tldC5jbG9zaW5nKSB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCBpcyBjbG9zZWQnKQoKICAgIGlmICh0aGlzLnNvY2tldC51ZHggIT09IHNvY2tldC51ZHgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgY2hhbmdlIHRvIGEgc29ja2V0IG9uIGFub3RoZXIgVURYIGluc3RhbmNlJykKICAgIH0KCiAgICBpZiAoIWhvc3QpIGhvc3QgPSAnMTI3LjAuMC4xJwoKICAgIGNvbnN0IGZhbWlseSA9IGlwLmlzSVAoaG9zdCkKICAgIGlmICghZmFtaWx5KSB0aHJvdyBuZXcgRXJyb3IoYCR7aG9zdH0gaXMgbm90IGEgdmFsaWQgSVAgYWRkcmVzc2ApCiAgICBpZiAoIShwb3J0ID4gMCAmJiBwb3J0IDwgNjU1MzYpKSB0aHJvdyBuZXcgRXJyb3IoYCR7cG9ydH0gaXMgbm90IGEgdmFsaWQgcG9ydGApCgogICAgaWYgKHRoaXMuc29ja2V0ICE9PSBzb2NrZXQpIHRoaXMuX3ByZXZpb3VzU29ja2V0ID0gdGhpcy5zb2NrZXQKCiAgICB0aGlzLnJlbW90ZUlkID0gcmVtb3RlSWQKICAgIHRoaXMucmVtb3RlUG9ydCA9IHBvcnQKICAgIHRoaXMucmVtb3RlSG9zdCA9IGhvc3QKICAgIHRoaXMucmVtb3RlRmFtaWx5ID0gZmFtaWx5CiAgICB0aGlzLnNvY2tldCA9IHNvY2tldAoKICAgIHRoaXMuX3JlbW90ZUNoYW5naW5nID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICBjb25zdCBvbmNoYW5nZWQgPSAoKSA9PiB7CiAgICAgICAgdGhpcy5vZmYoJ2Nsb3NlJywgb25jbG9zZSkKICAgICAgICByZXNvbHZlKCkKICAgICAgfQoKICAgICAgY29uc3Qgb25jbG9zZSA9ICgpID0+IHsKICAgICAgICB0aGlzLm9mZigncmVtb3RlLWNoYW5nZWQnLCBvbmNoYW5nZWQpCiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignU3RyZWFtIGlzIGNsb3NlZCcpKQogICAgICB9CgogICAgICB0aGlzLm9uY2UoJ3JlbW90ZS1jaGFuZ2VkJywgb25jaGFuZ2VkKS5vbmNlKCdjbG9zZScsIG9uY2xvc2UpCiAgICB9KQoKICAgIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX2NoYW5nZV9yZW1vdGUoCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgc29ja2V0Ll9oYW5kbGUsCiAgICAgIHJlbW90ZUlkLAogICAgICBwb3J0LAogICAgICBob3N0LAogICAgICBmYW1pbHkKICAgICkKCiAgICB0aGlzLnNvY2tldC5fYWRkU3RyZWFtKHRoaXMpCgogICAgcmV0dXJuIHRoaXMuX3JlbW90ZUNoYW5naW5nCiAgfQoKICByZWxheVRvKGRlc3RpbmF0aW9uKSB7CiAgICBpZiAodGhpcy5fY2xvc2VkKSByZXR1cm4KCiAgICBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV9yZWxheV90byh0aGlzLl9oYW5kbGUsIGRlc3RpbmF0aW9uLl9oYW5kbGUpCiAgfQoKICBhc3luYyBzZW5kKGJ1ZmZlcikgewogICAgaWYgKCF0aGlzLmNvbm5lY3RlZCB8fCB0aGlzLl9jbG9zZWQpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGlkID0gdGhpcy5fYWxsb2NTZW5kKCkKICAgIGNvbnN0IHJlcSA9IHRoaXMuX3NyZXFzW2lkXQoKICAgIHJlcS5idWZmZXIgPSBidWZmZXIKCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgcmVxLm9uZmx1c2ggPSByZXNvbHZlCiAgICB9KQoKICAgIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX3NlbmQodGhpcy5faGFuZGxlLCByZXEuaGFuZGxlLCBpZCwgYnVmZmVyKQoKICAgIHJldHVybiBwcm9taXNlCiAgfQoKICB0cnlTZW5kKGJ1ZmZlcikgewogICAgaWYgKCF0aGlzLmNvbm5lY3RlZCB8fCB0aGlzLl9jbG9zZWQpIHJldHVybgoKICAgIGNvbnN0IGlkID0gdGhpcy5fYWxsb2NTZW5kKCkKICAgIGNvbnN0IHJlcSA9IHRoaXMuX3NyZXFzW2lkXQoKICAgIHJlcS5idWZmZXIgPSBidWZmZXIKICAgIHJlcS5vbmZsdXNoID0gbm9vcAoKICAgIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX3NlbmQodGhpcy5faGFuZGxlLCByZXEuaGFuZGxlLCBpZCwgYnVmZmVyKQogIH0KCiAgYXN5bmMgZmx1c2goKSB7CiAgICBpZiAoKGF3YWl0IHN0cmVhbXguV3JpdGFibGUuZHJhaW5lZCh0aGlzKSkgPT09IGZhbHNlKSByZXR1cm4gZmFsc2UKICAgIGlmICh0aGlzLmRlc3Ryb3lpbmcpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IG1pc3NpbmcgPSB0aGlzLl93cmVxcy5sZW5ndGggLSB0aGlzLl93ZnJlZS5sZW5ndGgKICAgIGlmIChtaXNzaW5nID09PSAwKSByZXR1cm4gdHJ1ZQoKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICB0aGlzLl9mbHVzaGVzLnB1c2goeyBmbHVzaDogdGhpcy5fZmx1c2hpbmcrKywgbWlzc2luZywgcmVzb2x2ZSB9KQogICAgfSkKICB9CgogIHRvSlNPTigpIHsKICAgIHJldHVybiB7CiAgICAgIGlkOiB0aGlzLmlkLAogICAgICBjb25uZWN0ZWQ6IHRoaXMuY29ubmVjdGVkLAogICAgICBkZXN0cm95aW5nOiB0aGlzLmRlc3Ryb3lpbmcsCiAgICAgIGRlc3Ryb3llZDogdGhpcy5kZXN0cm95ZWQsCiAgICAgIHJlbW90ZUlkOiB0aGlzLnJlbW90ZUlkLAogICAgICByZW1vdGVIb3N0OiB0aGlzLnJlbW90ZUhvc3QsCiAgICAgIHJlbW90ZUZhbWlseTogdGhpcy5yZW1vdGVGYW1pbHksCiAgICAgIHJlbW90ZVBvcnQ6IHRoaXMucmVtb3RlUG9ydCwKICAgICAgbXR1OiB0aGlzLm10dSwKICAgICAgcnR0OiB0aGlzLnJ0dCwKICAgICAgY3duZDogdGhpcy5jd25kLAogICAgICBpbmZsaWdodDogdGhpcy5pbmZsaWdodCwKICAgICAgc29ja2V0OiB0aGlzLnNvY2tldCA/IHRoaXMuc29ja2V0LnRvSlNPTigpIDogbnVsbAogICAgfQogIH0KCiAgX3JlYWQoY2IpIHsKICAgIGNiKG51bGwpCiAgfQoKICBfd3JpdGVDb250aW51ZShlcnIpIHsKICAgIGlmICh0aGlzLl9vbndyaXRlID09PSBudWxsKSByZXR1cm4KICAgIGNvbnN0IGNiID0gdGhpcy5fb253cml0ZQogICAgdGhpcy5fb253cml0ZSA9IG51bGwKICAgIGNiKGVycikKICB9CgogIF9kZXN0cm95Q29udGludWUoZXJyKSB7CiAgICBpZiAodGhpcy5fb25kZXN0cm95ID09PSBudWxsKSByZXR1cm4KICAgIGNvbnN0IGNiID0gdGhpcy5fb25kZXN0cm95CiAgICB0aGlzLl9vbmRlc3Ryb3kgPSBudWxsCiAgICBjYihlcnIpCiAgfQoKICBfd3JpdGV2KGJ1ZmZlcnMsIGNiKSB7CiAgICBpZiAoIXRoaXMuY29ubmVjdGVkKQogICAgICB0aHJvdyBjdXN0b21FcnJvcignV3JpdGluZyB3aGlsZSBub3QgY29ubmVjdGVkIG5vdCBjdXJyZW50bHkgc3VwcG9ydGVkJywgJ0VSUl9BU1NFUlRJT04nKQoKICAgIGxldCBkcmFpbmVkID0gdHJ1ZQoKICAgIGlmIChidWZmZXJzLmxlbmd0aCA9PT0gMSkgewogICAgICBjb25zdCBpZCA9IHRoaXMuX2FsbG9jV3JpdGUoMSkKICAgICAgY29uc3QgcmVxID0gdGhpcy5fd3JlcXNbaWRdCgogICAgICByZXEuZmx1c2ggPSB0aGlzLl9mbHVzaGluZwogICAgICByZXEuYnVmZmVyID0gYnVmZmVyc1swXQoKICAgICAgZHJhaW5lZCA9IGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX3dyaXRlKHRoaXMuX2hhbmRsZSwgcmVxLmhhbmRsZSwgaWQsIHJlcS5idWZmZXIpICE9PSAwCiAgICB9IGVsc2UgewogICAgICBjb25zdCBpZCA9IHRoaXMuX2FsbG9jV3JpdGUobmV4dEJhdGNoU2l6ZShidWZmZXJzLmxlbmd0aCkpCiAgICAgIGNvbnN0IHJlcSA9IHRoaXMuX3dyZXFzW2lkXQoKICAgICAgcmVxLmZsdXNoID0gdGhpcy5fZmx1c2hpbmcKICAgICAgcmVxLmJ1ZmZlcnMgPSBidWZmZXJzCgogICAgICBkcmFpbmVkID0gYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fd3JpdGV2KHRoaXMuX2hhbmRsZSwgcmVxLmhhbmRsZSwgaWQsIHJlcS5idWZmZXJzKSAhPT0gMAogICAgfQoKICAgIGlmIChkcmFpbmVkKSBjYihudWxsKQogICAgZWxzZSB0aGlzLl9vbndyaXRlID0gY2IKICB9CgogIF9maW5hbChjYikgewogICAgY29uc3QgaWQgPSB0aGlzLl9hbGxvY1dyaXRlKDEpCiAgICBjb25zdCByZXEgPSB0aGlzLl93cmVxc1tpZF0KCiAgICByZXEuZmx1c2ggPSB0aGlzLl9mbHVzaGVzCiAgICByZXEuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKDApCgogICAgY29uc3QgZHJhaW5lZCA9CiAgICAgIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX3dyaXRlX2VuZCh0aGlzLl9oYW5kbGUsIHJlcS5oYW5kbGUsIGlkLCByZXEuYnVmZmVyKSAhPT0gMAoKICAgIGlmIChkcmFpbmVkKSBjYihudWxsKQogICAgZWxzZSB0aGlzLl9vbndyaXRlID0gY2IKICB9CgogIF9wcmVkZXN0cm95KCkgewogICAgaWYgKCF0aGlzLl9jbG9zZWQpIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX2Rlc3Ryb3kodGhpcy5faGFuZGxlKQogICAgdGhpcy5fY2xvc2VkID0gdHJ1ZQogICAgdGhpcy5fd3JpdGVDb250aW51ZShudWxsKQogIH0KCiAgX2Rlc3Ryb3koY2IpIHsKICAgIGlmICh0aGlzLmNvbm5lY3RlZCkgdGhpcy5fb25kZXN0cm95ID0gY2IKICAgIGVsc2UgY2IobnVsbCkKICB9CgogIF9vbmRhdGEocmVhZCkgewogICAgdGhpcy5wdXNoKHRoaXMuX2NvbnN1bWVEYXRhKHJlYWQpKQogICAgcmV0dXJuIHRoaXMuX2J1ZmZlcgogIH0KCiAgX29uZW5kKHJlYWQpIHsKICAgIGlmIChyZWFkID4gMCkgdGhpcy5wdXNoKHRoaXMuX2NvbnN1bWVEYXRhKHJlYWQpKQogICAgdGhpcy5wdXNoKG51bGwpCiAgfQoKICBfb25kcmFpbigpIHsKICAgIHRoaXMuX3dyaXRlQ29udGludWUobnVsbCkKICB9CgogIF9mbHVzaEFjayhmbHVzaCkgewogICAgZm9yIChsZXQgaSA9IHRoaXMuX2ZsdXNoZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgZiA9IHRoaXMuX2ZsdXNoZXNbaV0KICAgICAgaWYgKGYuZmx1c2ggPCBmbHVzaCkgYnJlYWsKICAgICAgZi5taXNzaW5nLS0KICAgIH0KCiAgICB3aGlsZSAodGhpcy5fZmx1c2hlcy5sZW5ndGggPiAwICYmIHRoaXMuX2ZsdXNoZXNbMF0ubWlzc2luZyA9PT0gMCkgewogICAgICB0aGlzLl9mbHVzaGVzLnNoaWZ0KCkucmVzb2x2ZSh0cnVlKQogICAgfQogIH0KCiAgX29uYWNrKGlkKSB7CiAgICBjb25zdCByZXEgPSB0aGlzLl93cmVxc1tpZF0KCiAgICByZXEuYnVmZmVycyA9IHJlcS5idWZmZXIgPSBudWxsCiAgICB0aGlzLl93ZnJlZS5wdXNoKGlkKQoKICAgIGlmICh0aGlzLl9mbHVzaGVzLmxlbmd0aCA+IDApIHRoaXMuX2ZsdXNoQWNrKHJlcS5mbHVzaCkKCiAgICAvLyBnYyB0aGUgZnJlZSBsaXN0CiAgICBpZiAodGhpcy5fd2ZyZWUubGVuZ3RoID49IDY0ICYmIHRoaXMuX3dmcmVlLmxlbmd0aCA9PT0gdGhpcy5fd3JlcXMubGVuZ3RoKSB7CiAgICAgIHRoaXMuX3dmcmVlID0gW10KICAgICAgdGhpcy5fd3JlcXMgPSBbXQogICAgfQogIH0KCiAgX29uc2VuZChpZCwgZXJyKSB7CiAgICBjb25zdCByZXEgPSB0aGlzLl9zcmVxc1tpZF0KCiAgICBjb25zdCBvbmZsdXNoID0gcmVxLm9uZmx1c2gKCiAgICByZXEuYnVmZmVyID0gbnVsbAogICAgcmVxLm9uZmx1c2ggPSBudWxsCgogICAgdGhpcy5fc2ZyZWUucHVzaChpZCkKCiAgICBvbmZsdXNoKGVyciA+PSAwKQoKICAgIC8vIGdjIHRoZSBmcmVlIGxpc3QKICAgIGlmICh0aGlzLl9zZnJlZS5sZW5ndGggPj0gMTYgJiYgdGhpcy5fc2ZyZWUubGVuZ3RoID09PSB0aGlzLl9zcmVxcy5sZW5ndGgpIHsKICAgICAgdGhpcy5fc2ZyZWUgPSBbXQogICAgICB0aGlzLl9zcmVxcyA9IFtdCiAgICB9CiAgfQoKICBfb25tZXNzYWdlKGxlbikgewogICAgdGhpcy5lbWl0KCdtZXNzYWdlJywgdGhpcy51ZHguX2NvbnN1bWVNZXNzYWdlKGxlbikpCiAgICByZXR1cm4gdGhpcy51ZHguX2J1ZmZlcgogIH0KCiAgX29uY2xvc2UoZXJyKSB7CiAgICB0aGlzLl9jbG9zZWQgPSB0cnVlCgogICAgaWYgKHRoaXMuc29ja2V0KSB7CiAgICAgIHRoaXMuc29ja2V0Ll9yZW1vdmVTdHJlYW0odGhpcykKICAgICAgdGhpcy5zb2NrZXQgPSBudWxsCiAgICB9CgogICAgaWYgKHRoaXMuX3ByZXZpb3VzU29ja2V0KSB7CiAgICAgIHRoaXMuX3ByZXZpb3VzU29ja2V0Ll9yZW1vdmVTdHJlYW0odGhpcykKICAgICAgdGhpcy5fcHJldmlvdXNTb2NrZXQgPSBudWxsCiAgICB9CgogICAgLy8gbm8gZXJyb3IsIHdlIGRvbid0IG5lZWQgdG8gZG8gYW55dGhpbmcKICAgIGlmICghZXJyKSByZXR1cm4gdGhpcy5fZGVzdHJveUNvbnRpbnVlKG51bGwpCgogICAgaWYgKHRoaXMuX29uZGVzdHJveSA9PT0gbnVsbCkgdGhpcy5kZXN0cm95KGVycikKICAgIGVsc2UgdGhpcy5fZGVzdHJveUNvbnRpbnVlKGVycikKICB9CgogIF9vbmZpcmV3YWxsKHNvY2tldCwgcG9ydCwgaG9zdCwgZmFtaWx5KSB7CiAgICByZXR1cm4gdGhpcy5fZmlyZXdhbGwoc29ja2V0LCBwb3J0LCBob3N0LCBmYW1pbHkpID8gMSA6IDAKICB9CgogIF9vbnJlbW90ZWNoYW5nZWQoKSB7CiAgICBpZiAodGhpcy5fcHJldmlvdXNTb2NrZXQpIHsKICAgICAgdGhpcy5fcHJldmlvdXNTb2NrZXQuX3JlbW92ZVN0cmVhbSh0aGlzKQogICAgICB0aGlzLl9wcmV2aW91c1NvY2tldCA9IG51bGwKICAgIH0KCiAgICB0aGlzLl9yZW1vdGVDaGFuZ2luZyA9IG51bGwKICAgIHRoaXMuZW1pdCgncmVtb3RlLWNoYW5nZWQnKQogIH0KCiAgX2NvbnN1bWVEYXRhKGxlbikgewogICAgY29uc3QgbmV4dCA9IHRoaXMuX2J1ZmZlci5zdWJhcnJheSgwLCBsZW4pCiAgICB0aGlzLl9idWZmZXIgPSB0aGlzLl9idWZmZXIuc3ViYXJyYXkobGVuKQogICAgaWYgKHRoaXMuX2J1ZmZlci5ieXRlTGVuZ3RoIDwgTUFYX1BBQ0tFVCkgdGhpcy5fcmVhbGxvY0RhdGEoKQogICAgcmV0dXJuIG5leHQKICB9CgogIF9yZWFsbG9jRGF0YSgpIHsKICAgIHRoaXMuX2J1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShCVUZGRVJfU0laRSkKICAgIHJldHVybiB0aGlzLl9idWZmZXIKICB9CgogIF9yZWFsbG9jTWVzc2FnZSgpIHsKICAgIHJldHVybiB0aGlzLnVkeC5fcmVhbGxvY01lc3NhZ2UoKQogIH0KCiAgX2FsbG9jV3JpdGUoc2l6ZSkgewogICAgaWYgKHRoaXMuX3dmcmVlLmxlbmd0aCA9PT0gMCkgewogICAgICBjb25zdCBoYW5kbGUgPSBiNGEuYWxsb2NVbnNhZmUoYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fd3JpdGVfc2l6ZW9mKHNpemUpKQogICAgICByZXR1cm4gKAogICAgICAgIHRoaXMuX3dyZXFzLnB1c2goewogICAgICAgICAgaGFuZGxlLAogICAgICAgICAgc2l6ZSwKICAgICAgICAgIGJ1ZmZlcnM6IG51bGwsCiAgICAgICAgICBidWZmZXI6IG51bGwsCiAgICAgICAgICBmbHVzaDogMAogICAgICAgIH0pIC0gMQogICAgICApCiAgICB9CgogICAgY29uc3QgZnJlZSA9IHRoaXMuX3dmcmVlLnBvcCgpCiAgICBpZiAoc2l6ZSA9PT0gMSkgcmV0dXJuIGZyZWUKCiAgICBjb25zdCBuZXh0ID0gdGhpcy5fd3JlcXNbZnJlZV0KICAgIGlmIChuZXh0LnNpemUgPCBzaXplKSB7CiAgICAgIG5leHQuaGFuZGxlID0gYjRhLmFsbG9jVW5zYWZlKGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX3dyaXRlX3NpemVvZihzaXplKSkKICAgICAgbmV4dC5zaXplID0gc2l6ZQogICAgfQoKICAgIHJldHVybiBmcmVlCiAgfQoKICBfYWxsb2NTZW5kKCkgewogICAgaWYgKHRoaXMuX3NmcmVlLmxlbmd0aCA+IDApIHJldHVybiB0aGlzLl9zZnJlZS5wb3AoKQogICAgY29uc3QgaGFuZGxlID0gYjRhLmFsbG9jVW5zYWZlKGJpbmRpbmcuc2l6ZW9mX3VkeF9zdHJlYW1fc2VuZF90KQogICAgcmV0dXJuIHRoaXMuX3NyZXFzLnB1c2goeyBoYW5kbGUsIGJ1ZmZlcjogbnVsbCwgcmVzb2x2ZTogbnVsbCwgcmVqZWN0OiBudWxsIH0pIC0gMQogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CgpmdW5jdGlvbiB0b0J1ZmZlcihkYXRhKSB7CiAgcmV0dXJuIHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJyA/IGI0YS5mcm9tKGRhdGEpIDogZGF0YQp9CgpmdW5jdGlvbiBmaXJld2FsbEFsbChzb2NrZXQsIHBvcnQsIGhvc3QpIHsKICByZXR1cm4gdHJ1ZQp9CgpmdW5jdGlvbiBjdXN0b21FcnJvcihtZXNzYWdlLCBjb2RlKSB7CiAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IobWVzc2FnZSkKICBlcnJvci5jb2RlID0gY29kZQogIHJldHVybiBlcnJvcgp9CgpmdW5jdGlvbiBuZXh0QmF0Y2hTaXplKG4pIHsKICAvLyB0cnkgdG8gY29lcmNlIHRoZSB0aGUgd3JpdGV2cyBpbnRvIHNhbWVpc2ggc2l6ZQogIGlmIChuID09PSAxKSByZXR1cm4gMQogIC8vIGdyb3VwIGFsbCA8IDggdG8gdGhlIHNhbWUgc2l6ZSwgbG93IG1lbSBvdmVyaGVhZCBidXQgc2F2ZSBzb21lIHNtYWxsIGFsbG9jcwogIGlmIChuIDwgOCkgcmV0dXJuIDgKICBpZiAobiA8IDE2KSByZXR1cm4gMTYKICBpZiAobiA8IDMyKSByZXR1cm4gMzIKICBpZiAobiA8IDY0KSByZXR1cm4gNjQKICByZXR1cm4gbgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKY29uc3QgaXAgPSByZXF1aXJlKCcuL2lwJykKY29uc3QgU29ja2V0ID0gcmVxdWlyZSgnLi9zb2NrZXQnKQpjb25zdCBTdHJlYW0gPSByZXF1aXJlKCcuL3N0cmVhbScpCmNvbnN0IE5ldHdvcmtJbnRlcmZhY2VzID0gcmVxdWlyZSgnLi9uZXR3b3JrLWludGVyZmFjZXMnKQoKY29uc3QgTUFYX01FU1NBR0UgPSA0MDk2CmNvbnN0IEJVRkZFUl9TSVpFID0gNjU1MzYgKyBNQVhfTUVTU0FHRQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBVRFggewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5faGFuZGxlID0gYjRhLmFsbG9jKGJpbmRpbmcuc2l6ZW9mX3VkeF9uYXBpX3QpCiAgICB0aGlzLl93YXRjaGVycyA9IG5ldyBTZXQoKQogICAgdGhpcy5fdmlldzY0ID0gbmV3IEJpZ1VpbnQ2NEFycmF5KAogICAgICB0aGlzLl9oYW5kbGUuYnVmZmVyLAogICAgICB0aGlzLl9oYW5kbGUuYnl0ZU9mZnNldCwKICAgICAgdGhpcy5faGFuZGxlLmJ5dGVMZW5ndGggPj4gMwogICAgKQoKICAgIHRoaXMuX2J1ZmZlciA9IG51bGwKICAgIHRoaXMuX3JlYWxsb2NNZXNzYWdlKCkKCiAgICBiaW5kaW5nLnVkeF9uYXBpX2luaXQodGhpcy5faGFuZGxlLCB0aGlzLl9idWZmZXIpCiAgfQoKICBzdGF0aWMgaXNJUHY0KGhvc3QpIHsKICAgIHJldHVybiBpcC5pc0lQdjQoaG9zdCkKICB9CgogIHN0YXRpYyBpc0lQdjYoaG9zdCkgewogICAgcmV0dXJuIGlwLmlzSVB2Nihob3N0KQogIH0KCiAgc3RhdGljIGlzSVAoaG9zdCkgewogICAgcmV0dXJuIGlwLmlzSVAoaG9zdCkKICB9CgogIGdldCBieXRlc1RyYW5zbWl0dGVkKCkgewogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfdF9ieXRlc190eCA+PiAzXSkKICB9CgogIGdldCBwYWNrZXRzVHJhbnNtaXR0ZWQoKSB7CiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF90X3BhY2tldHNfdHggPj4gM10pCiAgfQoKICBnZXQgYnl0ZXNSZWNlaXZlZCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3RfYnl0ZXNfcnggPj4gM10pCiAgfQoKICBnZXQgcGFja2V0c1JlY2VpdmVkKCkgewogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfdF9wYWNrZXRzX3J4ID4+IDNdKQogIH0KCiAgZ2V0IHBhY2tldHNEcm9wcGVkQnlLZXJuZWwoKSB7CiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF90X3BhY2tldHNfZHJvcHBlZF9ieV9rZXJuZWwgPj4gM10pCiAgfQoKICBfY29uc3VtZU1lc3NhZ2UobGVuKSB7CiAgICBjb25zdCBuZXh0ID0gdGhpcy5fYnVmZmVyLnN1YmFycmF5KDAsIGxlbikKICAgIHRoaXMuX2J1ZmZlciA9IHRoaXMuX2J1ZmZlci5zdWJhcnJheShsZW4pCiAgICBpZiAodGhpcy5fYnVmZmVyLmJ5dGVMZW5ndGggPCBNQVhfTUVTU0FHRSkgdGhpcy5fcmVhbGxvY01lc3NhZ2UoKQogICAgcmV0dXJuIG5leHQKICB9CgogIF9yZWFsbG9jTWVzc2FnZSgpIHsKICAgIC8vIFRPRE86IG1vdmUgcmVhbGxvY2F0aW9uIHRvIG5hdGl2ZQogICAgdGhpcy5fYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKEJVRkZFUl9TSVpFKQogICAgcmV0dXJuIHRoaXMuX2J1ZmZlcgogIH0KCiAgY3JlYXRlU29ja2V0KG9wdHMpIHsKICAgIHJldHVybiBuZXcgU29ja2V0KHRoaXMsIG9wdHMpCiAgfQoKICBjcmVhdGVTdHJlYW0oaWQsIG9wdHMpIHsKICAgIHJldHVybiBuZXcgU3RyZWFtKHRoaXMsIGlkLCBvcHRzKQogIH0KCiAgbmV0d29ya0ludGVyZmFjZXMoKSB7CiAgICBsZXQgW3dhdGNoZXIgPSBudWxsXSA9IHRoaXMuX3dhdGNoZXJzCiAgICBpZiAod2F0Y2hlcikgcmV0dXJuIHdhdGNoZXIuaW50ZXJmYWNlcwoKICAgIHdhdGNoZXIgPSBuZXcgTmV0d29ya0ludGVyZmFjZXModGhpcykKICAgIHdhdGNoZXIuZGVzdHJveSgpCgogICAgcmV0dXJuIHdhdGNoZXIuaW50ZXJmYWNlcwogIH0KCiAgd2F0Y2hOZXR3b3JrSW50ZXJmYWNlcyhvbmNoYW5nZSkgewogICAgY29uc3Qgd2F0Y2hlciA9IG5ldyBOZXR3b3JrSW50ZXJmYWNlcyh0aGlzKQoKICAgIHRoaXMuX3dhdGNoZXJzLmFkZCh3YXRjaGVyKQogICAgd2F0Y2hlci5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgIHRoaXMuX3dhdGNoZXJzLmRlbGV0ZSh3YXRjaGVyKQogICAgfSkKCiAgICBpZiAob25jaGFuZ2UpIHdhdGNoZXIub24oJ2NoYW5nZScsIG9uY2hhbmdlKQoKICAgIHJldHVybiB3YXRjaGVyLndhdGNoKCkKICB9CgogIGFzeW5jIGxvb2t1cChob3N0LCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgZmFtaWx5ID0gMCB9ID0gb3B0cwoKICAgIGNvbnN0IHJlcSA9IGI0YS5hbGxvYyhiaW5kaW5nLnNpemVvZl91ZHhfbmFwaV9sb29rdXBfdCkKICAgIGNvbnN0IGN0eCA9IHsKICAgICAgcmVxLAogICAgICByZXNvbHZlOiBudWxsLAogICAgICByZWplY3Q6IG51bGwKICAgIH0KCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICBjdHgucmVzb2x2ZSA9IHJlc29sdmUKICAgICAgY3R4LnJlamVjdCA9IHJlamVjdAogICAgfSkKCiAgICBiaW5kaW5nLnVkeF9uYXBpX2xvb2t1cCh0aGlzLl9oYW5kbGUsIHJlcSwgaG9zdCwgZmFtaWx5LCBjdHgsIG9ubG9va3VwKQoKICAgIHJldHVybiBwcm9taXNlCiAgfQp9CgpmdW5jdGlvbiBvbmxvb2t1cChlcnIsIGhvc3QsIGZhbWlseSkgewogIGlmIChlcnIpIHRoaXMucmVqZWN0KGVycikKICBlbHNlIHRoaXMucmVzb2x2ZSh7IGhvc3QsIGZhbWlseSB9KQp9CnsKICAibmFtZSI6ICJ1ZHgtbmF0aXZlIiwKICAidmVyc2lvbiI6ICIxLjE5LjIiLAogICJkZXNjcmlwdGlvbiI6ICJ1ZHggaXMgcmVsaWFibGUsIG11bHRpcGxleGVkLCBhbmQgY29uZ2VzdGlvbi1jb250cm9sbGVkIHN0cmVhbXMgb3ZlciB1ZHAiLAogICJtYWluIjogImxpYi91ZHguanMiLAogICJmaWxlcyI6IFsKICAgICJsaWIiLAogICAgInByZWJ1aWxkcyIsCiAgICAiYmluZGluZy5jYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiCiAgXSwKICAiaW1wb3J0cyI6IHsKICAgICJldmVudHMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZXZlbnRzIiwKICAgICAgImRlZmF1bHQiOiAiZXZlbnRzIgogICAgfQogIH0sCiAgImFkZG9uIjogdHJ1ZSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIiwKICAgICJsaW50IjogInByZXR0aWVyIC0tY2hlY2sgLiIsCiAgICAidGVzdCI6ICJucG0gcnVuIGxpbnQgJiYgbnBtIHJ1biB0ZXN0OmJhcmUgJiYgbnBtIHJ1biB0ZXN0Om5vZGUiLAogICAgInRlc3Q6bm9kZSI6ICJub2RlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDphbGwiOiAiYnJpdHRsZSB0ZXN0LyouanMgdGVzdC9zbG93LyouanMiLAogICAgInRlc3Q6Z2VuZXJhdGUiOiAiYnJpdHRsZSAtciB0ZXN0L2FsbC5qcyB0ZXN0LyouanMiLAogICAgImJlbmNoIjogImJyaXR0bGUgdGVzdC9iZW5jaC8qLmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3VkeC1uYXRpdmUuZ2l0IgogIH0sCiAgImtleXdvcmRzIjogWwogICAgInRjcCIsCiAgICAidWRwIiwKICAgICJzdHJlYW0iLAogICAgInJlbGlhYmxlIgogIF0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2ggSW5jLiIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by91ZHgtbmF0aXZlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vdWR4LW5hdGl2ZSNyZWFkbWUiLAogICJlbmdpbmVzIjogewogICAgImJhcmUiOiAiPj0xLjE3LjQiCiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS41LjAiLAogICAgImJhcmUtZXZlbnRzIjogIl4yLjIuMCIsCiAgICAicmVxdWlyZS1hZGRvbiI6ICJeMS4xLjAiLAogICAgInN0cmVhbXgiOiAiXjIuMjIuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1jb21wYXQtbmFwaSI6ICJeMS4zLjAiLAogICAgImJyaXR0bGUiOiAiXjMuMS4wIiwKICAgICJjbWFrZS1iYXJlIjogIl4xLjEuMTAiLAogICAgImNtYWtlLWZldGNoIjogIl4xLjAuMSIsCiAgICAiY21ha2UtbmFwaSI6ICJeMS4wLjUiLAogICAgImlzLWNpIjogIl4zLjAuMSIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIsCiAgICAidGlueS1ieXRlLXNpemUiOiAiXjEuMS4wIgogIH0KfQpleHBvcnRzLmFkZCA9IGFkZApleHBvcnRzLmhhcyA9IGhhcwpleHBvcnRzLnJlbW92ZSA9IHJlbW92ZQpleHBvcnRzLnN3YXAgPSBzd2FwCgpmdW5jdGlvbiBhZGQgKGxpc3QsIGl0ZW0pIHsKICBpZiAoaGFzKGxpc3QsIGl0ZW0pKSByZXR1cm4gaXRlbQogIGl0ZW0uX2luZGV4ID0gbGlzdC5sZW5ndGgKICBsaXN0LnB1c2goaXRlbSkKICByZXR1cm4gaXRlbQp9CgpmdW5jdGlvbiBoYXMgKGxpc3QsIGl0ZW0pIHsKICByZXR1cm4gaXRlbS5faW5kZXggPCBsaXN0Lmxlbmd0aCAmJiBsaXN0W2l0ZW0uX2luZGV4XSA9PT0gaXRlbQp9CgpmdW5jdGlvbiByZW1vdmUgKGxpc3QsIGl0ZW0pIHsKICBpZiAoIWhhcyhsaXN0LCBpdGVtKSkgcmV0dXJuIG51bGwKCiAgdmFyIGxhc3QgPSBsaXN0LnBvcCgpCiAgaWYgKGxhc3QgIT09IGl0ZW0pIHsKICAgIGxpc3RbaXRlbS5faW5kZXhdID0gbGFzdAogICAgbGFzdC5faW5kZXggPSBpdGVtLl9pbmRleAogIH0KCiAgcmV0dXJuIGl0ZW0KfQoKZnVuY3Rpb24gc3dhcCAobGlzdCwgYSwgYikgewogIGlmICghaGFzKGxpc3QsIGEpIHx8ICFoYXMobGlzdCwgYikpIHJldHVybgogIHZhciB0bXAgPSBhLl9pbmRleAogIGEuX2luZGV4ID0gYi5faW5kZXgKICBsaXN0W2EuX2luZGV4XSA9IGEKICBiLl9pbmRleCA9IHRtcAogIGxpc3RbYi5faW5kZXhdID0gYgp9CnsKICAibmFtZSI6ICJ1bm9yZGVyZWQtc2V0IiwKICAidmVyc2lvbiI6ICIyLjAuMSIsCiAgImRlc2NyaXB0aW9uIjogIkEgY291cGxlIG9mIGZ1bmN0aW9ucyB0aGF0IG1ha2UgaXQgZWFzeSB0byBtYWludGFpbiBhbiB1bm9yZGVyZWQgc2V0IGFzIGFuIGFycmF5IGluIGFuIGVmZmljaWVudCB3YXkiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeNi4wLjQiLAogICAgInRhcGUiOiAiXjQuNC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiB0YXBlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvdW5vcmRlcmVkLXNldC5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvdW5vcmRlcmVkLXNldC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC91bm9yZGVyZWQtc2V0Igp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgp1bnNsYWIuYWxsID0gYWxsCnVuc2xhYi5pcyA9IGlzCgptb2R1bGUuZXhwb3J0cyA9IHVuc2xhYgoKZnVuY3Rpb24gdW5zbGFiIChidWYpIHsKICBpZiAoYnVmID09PSBudWxsIHx8IGJ1Zi5idWZmZXIuYnl0ZUxlbmd0aCA9PT0gYnVmLmJ5dGVMZW5ndGgpIHJldHVybiBidWYKICBjb25zdCBjb3B5ID0gYjRhLmFsbG9jVW5zYWZlU2xvdyhidWYuYnl0ZUxlbmd0aCkKICBjb3B5LnNldChidWYsIDApCiAgcmV0dXJuIGNvcHkKfQoKZnVuY3Rpb24gaXMgKGJ1ZikgewogIHJldHVybiBidWYuYnVmZmVyLmJ5dGVMZW5ndGggIT09IGJ1Zi5ieXRlTGVuZ3RoCn0KCmZ1bmN0aW9uIGFsbCAobGlzdCkgewogIGxldCBzaXplID0gMAogIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgY29uc3QgYnVmID0gbGlzdFtpXQogICAgc2l6ZSArPSBidWYgPT09IG51bGwgfHwgYnVmLmJ1ZmZlci5ieXRlTGVuZ3RoID09PSBidWYuYnl0ZUxlbmd0aCA/IDAgOiBidWYuYnl0ZUxlbmd0aAogIH0KCiAgY29uc3QgY29weSA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coc2l6ZSkKICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkobGlzdC5sZW5ndGgpCgogIGxldCBvZmZzZXQgPSAwCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICBsZXQgYnVmID0gbGlzdFtpXQoKICAgIGlmIChidWYgIT09IG51bGwgJiYgYnVmLmJ1ZmZlci5ieXRlTGVuZ3RoICE9PSBidWYuYnl0ZUxlbmd0aCkgewogICAgICBjb3B5LnNldChidWYsIG9mZnNldCkKICAgICAgYnVmID0gY29weS5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArPSBidWYuYnl0ZUxlbmd0aCkKICAgIH0KCiAgICByZXN1bHRbaV0gPSBidWYKICB9CgogIHJldHVybiByZXN1bHQKfQp7CiAgIm5hbWUiOiAidW5zbGFiIiwKICAidmVyc2lvbiI6ICIxLjMuMCIsCiAgImRlc2NyaXB0aW9uIjogIlVuc2xhYiBzb21lIHNsYWInZWQgYnVmZmVycyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNiIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy41LjIiLAogICAgInN0YW5kYXJkIjogIl4xNy4xLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3Vuc2xhYi5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by91bnNsYWIvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by91bnNsYWIiCn0KbW9kdWxlLmV4cG9ydHMgPSByZWFkCgp2YXIgTVNCID0gMHg4MAogICwgUkVTVCA9IDB4N0YKCmZ1bmN0aW9uIHJlYWQoYnVmLCBvZmZzZXQpIHsKICB2YXIgcmVzICAgID0gMAogICAgLCBvZmZzZXQgPSBvZmZzZXQgfHwgMAogICAgLCBzaGlmdCAgPSAwCiAgICAsIGNvdW50ZXIgPSBvZmZzZXQKICAgICwgYgogICAgLCBsID0gYnVmLmxlbmd0aAoKICBkbyB7CiAgICBpZiAoY291bnRlciA+PSBsKSB7CiAgICAgIHJlYWQuYnl0ZXMgPSAwCiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdDb3VsZCBub3QgZGVjb2RlIHZhcmludCcpCiAgICB9CiAgICBiID0gYnVmW2NvdW50ZXIrK10KICAgIHJlcyArPSBzaGlmdCA8IDI4CiAgICAgID8gKGIgJiBSRVNUKSA8PCBzaGlmdAogICAgICA6IChiICYgUkVTVCkgKiBNYXRoLnBvdygyLCBzaGlmdCkKICAgIHNoaWZ0ICs9IDcKICB9IHdoaWxlIChiID49IE1TQikKCiAgcmVhZC5ieXRlcyA9IGNvdW50ZXIgLSBvZmZzZXQKCiAgcmV0dXJuIHJlcwp9Cm1vZHVsZS5leHBvcnRzID0gZW5jb2RlCgp2YXIgTVNCID0gMHg4MAogICwgUkVTVCA9IDB4N0YKICAsIE1TQkFMTCA9IH5SRVNUCiAgLCBJTlQgPSBNYXRoLnBvdygyLCAzMSkKCmZ1bmN0aW9uIGVuY29kZShudW0sIG91dCwgb2Zmc2V0KSB7CiAgb3V0ID0gb3V0IHx8IFtdCiAgb2Zmc2V0ID0gb2Zmc2V0IHx8IDAKICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CgogIHdoaWxlKG51bSA+PSBJTlQpIHsKICAgIG91dFtvZmZzZXQrK10gPSAobnVtICYgMHhGRikgfCBNU0IKICAgIG51bSAvPSAxMjgKICB9CiAgd2hpbGUobnVtICYgTVNCQUxMKSB7CiAgICBvdXRbb2Zmc2V0KytdID0gKG51bSAmIDB4RkYpIHwgTVNCCiAgICBudW0gPj4+PSA3CiAgfQogIG91dFtvZmZzZXRdID0gbnVtIHwgMAogIAogIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldCArIDEKICAKICByZXR1cm4gb3V0Cn0KbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBlbmNvZGU6IHJlcXVpcmUoJy4vZW5jb2RlLmpzJykKICAsIGRlY29kZTogcmVxdWlyZSgnLi9kZWNvZGUuanMnKQogICwgZW5jb2RpbmdMZW5ndGg6IHJlcXVpcmUoJy4vbGVuZ3RoLmpzJykKfQoKdmFyIE4xID0gTWF0aC5wb3coMiwgIDcpCnZhciBOMiA9IE1hdGgucG93KDIsIDE0KQp2YXIgTjMgPSBNYXRoLnBvdygyLCAyMSkKdmFyIE40ID0gTWF0aC5wb3coMiwgMjgpCnZhciBONSA9IE1hdGgucG93KDIsIDM1KQp2YXIgTjYgPSBNYXRoLnBvdygyLCA0MikKdmFyIE43ID0gTWF0aC5wb3coMiwgNDkpCnZhciBOOCA9IE1hdGgucG93KDIsIDU2KQp2YXIgTjkgPSBNYXRoLnBvdygyLCA2MykKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuICgKICAgIHZhbHVlIDwgTjEgPyAxCiAgOiB2YWx1ZSA8IE4yID8gMgogIDogdmFsdWUgPCBOMyA/IDMKICA6IHZhbHVlIDwgTjQgPyA0CiAgOiB2YWx1ZSA8IE41ID8gNQogIDogdmFsdWUgPCBONiA/IDYKICA6IHZhbHVlIDwgTjcgPyA3CiAgOiB2YWx1ZSA8IE44ID8gOAogIDogdmFsdWUgPCBOOSA/IDkKICA6ICAgICAgICAgICAgICAxMAogICkKfQp7CiAgIm5hbWUiOiAidmFyaW50IiwKICAidmVyc2lvbiI6ICI1LjAuMCIsCiAgImRlc2NyaXB0aW9uIjogInByb3RvYnVmLXN0eWxlIHZhcmludCBieXRlcyAtIHVzZSBtc2IgdG8gY3JlYXRlIGludGVnZXIgdmFsdWVzIG9mIHZhcnlpbmcgc2l6ZXMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogIm5vZGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0Oi8vZ2l0aHViLmNvbS9jaHJpc2RpY2tpbnNvbi92YXJpbnQuZ2l0IgogIH0sCiAgImtleXdvcmRzIjogWwogICAgInZhcmludCIsCiAgICAicHJvdG9idWYiLAogICAgImVuY29kZSIsCiAgICAiZGVjb2RlIgogIF0sCiAgImF1dGhvciI6ICJDaHJpcyBEaWNraW5zb24gPGNocmlzQG5ldmVyc2F3LnVzPiIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInRhcGUiOiAifjIuMTIuMyIKICB9Cn0KY29uc3QgeyBydW50aW1lLCBwbGF0Zm9ybSwgYXJjaCB9ID0gdHlwZW9mIEJhcmUgIT09ICd1bmRlZmluZWQnCiAgPyB7IHJ1bnRpbWU6ICdiYXJlJywgcGxhdGZvcm06IGdsb2JhbC5CYXJlLnBsYXRmb3JtLCBhcmNoOiBnbG9iYWwuQmFyZS5hcmNoIH0KICA6IHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJwogICAgPyB7IHJ1bnRpbWU6ICdub2RlJywgcGxhdGZvcm06IGdsb2JhbC5wcm9jZXNzLnBsYXRmb3JtLCBhcmNoOiBnbG9iYWwucHJvY2Vzcy5hcmNoIH0KICAgIDogdHlwZW9mIFdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcKICAgICAgPyB7IHJ1bnRpbWU6ICdicm93c2VyJywgcGxhdGZvcm06ICd1bmtub3duJywgYXJjaDogJ3Vua25vd24nIH0KICAgICAgOiB7IHJ1bnRpbWU6ICd1bmtub3duJywgcGxhdGZvcm06ICd1bmtub3duJywgYXJjaDogJ3Vua25vd24nIH0KCmV4cG9ydHMucnVudGltZSA9IHJ1bnRpbWUKZXhwb3J0cy5wbGF0Zm9ybSA9IHBsYXRmb3JtCmV4cG9ydHMuYXJjaCA9IGFyY2gKZXhwb3J0cy5pc0JhcmUgPSBydW50aW1lID09PSAnYmFyZScKZXhwb3J0cy5pc0JhcmVLaXQgPSBleHBvcnRzLmlzQmFyZSAmJiB0eXBlb2YgQmFyZUtpdCAhPT0gJ3VuZGVmaW5lZCcKZXhwb3J0cy5pc1BlYXIgPSB0eXBlb2YgUGVhciAhPT0gJ3VuZGVmaW5lZCcKZXhwb3J0cy5pc05vZGUgPSBydW50aW1lID09PSAnbm9kZScKZXhwb3J0cy5pc0Jyb3dzZXIgPSBydW50aW1lID09PSAnYnJvd3NlcicKZXhwb3J0cy5pc1dpbmRvd3MgPSBwbGF0Zm9ybSA9PT0gJ3dpbjMyJwpleHBvcnRzLmlzTGludXggPSBwbGF0Zm9ybSA9PT0gJ2xpbnV4JwpleHBvcnRzLmlzTWFjID0gcGxhdGZvcm0gPT09ICdkYXJ3aW4nCmV4cG9ydHMuaXNJT1MgPSBwbGF0Zm9ybSA9PT0gJ2lvcycgfHwgcGxhdGZvcm0gPT09ICdpb3Mtc2ltdWxhdG9yJwpleHBvcnRzLmlzQW5kcm9pZCA9IHBsYXRmb3JtID09PSAnYW5kcm9pZCcKZXhwb3J0cy5pc0VsZWN0cm9uID0gdHlwZW9mIHByb2Nlc3MgIT09ICd1bmRlZmluZWQnICYmICEhZ2xvYmFsLnByb2Nlc3MudmVyc2lvbnM/LmVsZWN0cm9uCmV4cG9ydHMuaXNFbGVjdHJvblJlbmRlcmVyID0gZXhwb3J0cy5pc0VsZWN0cm9uICYmIGdsb2JhbC5wcm9jZXNzLnR5cGUgPT09ICdyZW5kZXJlcicKZXhwb3J0cy5pc0VsZWN0cm9uV29ya2VyID0gZXhwb3J0cy5pc0VsZWN0cm9uICYmIGdsb2JhbC5wcm9jZXNzLnR5cGUgPT09ICd3b3JrZXInCnsKICAibmFtZSI6ICJ3aGljaC1ydW50aW1lIiwKICAidmVyc2lvbiI6ICIxLjMuMiIsCiAgImRlc2NyaXB0aW9uIjogIkRldGVjdCBpZiB5b3UgYXJlIGluIEJhcmUgb3IgTm9kZSBhbmQgd2hpY2ggb3MgZXRjIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by93aGljaC1ydW50aW1lLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYy4iLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vd2hpY2gtcnVudGltZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3doaWNoLXJ1bnRpbWUiCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBNYXhDYWNoZSB7CiAgY29uc3RydWN0b3IgKHsgbWF4U2l6ZSwgbWF4QWdlLCBjcmVhdGVNYXAsIG9uZ2MgfSkgewogICAgdGhpcy5tYXhTaXplID0gbWF4U2l6ZQogICAgdGhpcy5tYXhBZ2UgPSBtYXhBZ2UKICAgIHRoaXMub25nYyA9IG9uZ2MgfHwgbnVsbAoKICAgIHRoaXMuX2NyZWF0ZU1hcCA9IGNyZWF0ZU1hcCB8fCBkZWZhdWx0Q3JlYXRlTWFwCiAgICB0aGlzLl9sYXRlc3QgPSB0aGlzLl9jcmVhdGVNYXAoKQogICAgdGhpcy5fb2xkZXN0ID0gdGhpcy5fY3JlYXRlTWFwKCkKICAgIHRoaXMuX3JldGFpbmVkID0gdGhpcy5fY3JlYXRlTWFwKCkKICAgIHRoaXMuX2djZWQgPSBmYWxzZQogICAgdGhpcy5faW50ZXJ2YWwgPSBudWxsCgogICAgaWYgKHRoaXMubWF4QWdlID4gMCAmJiB0aGlzLm1heEFnZSA8IEluZmluaXR5KSB7CiAgICAgIGNvbnN0IHRpY2sgPSBNYXRoLmNlaWwoMiAvIDMgKiB0aGlzLm1heEFnZSkKICAgICAgdGhpcy5faW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLl9nY0F1dG8uYmluZCh0aGlzKSwgdGljaykKICAgICAgaWYgKHRoaXMuX2ludGVydmFsLnVucmVmKSB0aGlzLl9pbnRlcnZhbC51bnJlZigpCiAgICB9CiAgfQoKICAqIFtTeW1ib2wuaXRlcmF0b3JdICgpIHsKICAgIGZvciAoY29uc3QgaXQgb2YgW3RoaXMuX2xhdGVzdCwgdGhpcy5fb2xkZXN0LCB0aGlzLl9yZXRhaW5lZF0pIHsKICAgICAgeWllbGQgKiBpdAogICAgfQogIH0KCiAgKiBrZXlzICgpIHsKICAgIGZvciAoY29uc3QgaXQgb2YgW3RoaXMuX2xhdGVzdCwgdGhpcy5fb2xkZXN0LCB0aGlzLl9yZXRhaW5lZF0pIHsKICAgICAgeWllbGQgKiBpdC5rZXlzKCkKICAgIH0KICB9CgogICogdmFsdWVzICgpIHsKICAgIGZvciAoY29uc3QgaXQgb2YgW3RoaXMuX2xhdGVzdCwgdGhpcy5fb2xkZXN0LCB0aGlzLl9yZXRhaW5lZF0pIHsKICAgICAgeWllbGQgKiBpdC52YWx1ZXMoKQogICAgfQogIH0KCiAgZGVzdHJveSAoKSB7CiAgICB0aGlzLmNsZWFyKCkKICAgIGNsZWFySW50ZXJ2YWwodGhpcy5faW50ZXJ2YWwpCiAgICB0aGlzLl9pbnRlcnZhbCA9IG51bGwKICB9CgogIGNsZWFyICgpIHsKICAgIHRoaXMuX2djZWQgPSB0cnVlCiAgICB0aGlzLl9sYXRlc3QuY2xlYXIoKQogICAgdGhpcy5fb2xkZXN0LmNsZWFyKCkKICAgIHRoaXMuX3JldGFpbmVkLmNsZWFyKCkKICB9CgogIHNldCAoaywgdikgewogICAgaWYgKHRoaXMuX3JldGFpbmVkLmhhcyhrKSkgcmV0dXJuIHRoaXMKICAgIHRoaXMuX2xhdGVzdC5zZXQoaywgdikKICAgIHRoaXMuX29sZGVzdC5kZWxldGUoaykgfHwgdGhpcy5fcmV0YWluZWQuZGVsZXRlKGspCiAgICBpZiAodGhpcy5fbGF0ZXN0LnNpemUgPj0gdGhpcy5tYXhTaXplKSB0aGlzLl9nYygpCiAgICByZXR1cm4gdGhpcwogIH0KCiAgcmV0YWluIChrLCB2KSB7CiAgICB0aGlzLl9yZXRhaW5lZC5zZXQoaywgdikKICAgIHRoaXMuX2xhdGVzdC5kZWxldGUoaykgfHwgdGhpcy5fb2xkZXN0LmRlbGV0ZShrKQogICAgcmV0dXJuIHRoaXMKICB9CgogIGRlbGV0ZSAoaykgewogICAgcmV0dXJuIHRoaXMuX2xhdGVzdC5kZWxldGUoaykgfHwgdGhpcy5fb2xkZXN0LmRlbGV0ZShrKSB8fCB0aGlzLl9yZXRhaW5lZC5kZWxldGUoaykKICB9CgogIGhhcyAoaykgewogICAgcmV0dXJuIHRoaXMuX2xhdGVzdC5oYXMoaykgfHwgdGhpcy5fb2xkZXN0LmhhcyhrKSB8fCB0aGlzLl9yZXRhaW5lZC5oYXMoaykKICB9CgogIGdldCAoaykgewogICAgaWYgKHRoaXMuX2xhdGVzdC5oYXMoaykpIHsKICAgICAgcmV0dXJuIHRoaXMuX2xhdGVzdC5nZXQoaykKICAgIH0KCiAgICBpZiAodGhpcy5fb2xkZXN0LmhhcyhrKSkgewogICAgICBjb25zdCB2ID0gdGhpcy5fb2xkZXN0LmdldChrKQogICAgICB0aGlzLl9sYXRlc3Quc2V0KGssIHYpCiAgICAgIHRoaXMuX29sZGVzdC5kZWxldGUoaykKICAgICAgcmV0dXJuIHYKICAgIH0KCiAgICBpZiAodGhpcy5fcmV0YWluZWQuaGFzKGspKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZXRhaW5lZC5nZXQoaykKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgX2djQXV0byAoKSB7CiAgICBpZiAoIXRoaXMuX2djZWQpIHRoaXMuX2djKCkKICAgIHRoaXMuX2djZWQgPSBmYWxzZQogIH0KCiAgX2djICgpIHsKICAgIHRoaXMuX2djZWQgPSB0cnVlCiAgICBpZiAodGhpcy5vbmdjICE9PSBudWxsICYmIHRoaXMuX29sZGVzdC5zaXplID4gMCkgdGhpcy5vbmdjKHRoaXMuX29sZGVzdCkKICAgIHRoaXMuX29sZGVzdCA9IHRoaXMuX2xhdGVzdAogICAgdGhpcy5fbGF0ZXN0ID0gdGhpcy5fY3JlYXRlTWFwKCkKICB9Cn0KCmZ1bmN0aW9uIGRlZmF1bHRDcmVhdGVNYXAgKCkgewogIHJldHVybiBuZXcgTWFwKCkKfQp7CiAgIm5hbWUiOiAieGFjaGUiLAogICJ2ZXJzaW9uIjogIjEuMi4xIiwKICAiZGVzY3JpcHRpb24iOiAiWWV0IGFub3RoZXIgYXV0byBleHBpcmluZywgbWF4IHNpemFibGUgY2FjaGUiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMy4yIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gveGFjaGUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3hhY2hlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3hhY2hlIgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBBTFBIQUJFVCA9ICd5Ym5kcmZnOGVqa21jcHF4b3QxdXdpc3phMzQ1aDc2OScKY29uc3QgTUlOID0gMHgzMSAvLyAxCmNvbnN0IE1BWCA9IDB4N2EgLy8gegpjb25zdCBSRVZFUlNFID0gbmV3IEludDhBcnJheSgxICsgTUFYIC0gTUlOKQoKUkVWRVJTRS5maWxsKC0xKQoKZm9yIChsZXQgaSA9IDA7IGkgPCBBTFBIQUJFVC5sZW5ndGg7IGkrKykgewogIGNvbnN0IHYgPSBBTFBIQUJFVC5jaGFyQ29kZUF0KGkpIC0gTUlOCiAgUkVWRVJTRVt2XSA9IGkKfQoKZXhwb3J0cy5lbmNvZGUgPSBlbmNvZGUKZXhwb3J0cy5kZWNvZGUgPSBkZWNvZGUKZXhwb3J0cy5BTFBIQUJFVCA9IEFMUEhBQkVUCgpmdW5jdGlvbiBkZWNvZGUgKHMsIG91dCkgewogIGxldCBwYiA9IDAKICBsZXQgcHMgPSAwCgogIGNvbnN0IHIgPSBzLmxlbmd0aCAmIDcKICBjb25zdCBxID0gKHMubGVuZ3RoIC0gcikgLyA4CgogIGlmICghb3V0KSBvdXQgPSBiNGEuYWxsb2NVbnNhZmUoTWF0aC5jZWlsKHMubGVuZ3RoICogNSAvIDgpKQoKICAvLyAwIDUgMiA3IDQgMSA2IDMgKCs1IG1vZCA4KQogIGZvciAobGV0IGkgPSAwOyBpIDwgcTsgaSsrKSB7CiAgICBjb25zdCBhID0gcXVpbnRldChzLCBwcysrKQogICAgY29uc3QgYiA9IHF1aW50ZXQocywgcHMrKykKICAgIGNvbnN0IGMgPSBxdWludGV0KHMsIHBzKyspCiAgICBjb25zdCBkID0gcXVpbnRldChzLCBwcysrKQogICAgY29uc3QgZSA9IHF1aW50ZXQocywgcHMrKykKICAgIGNvbnN0IGYgPSBxdWludGV0KHMsIHBzKyspCiAgICBjb25zdCBnID0gcXVpbnRldChzLCBwcysrKQogICAgY29uc3QgaCA9IHF1aW50ZXQocywgcHMrKykKCiAgICBvdXRbcGIrK10gPSAoYSA8PCAzKSB8IChiID4+PiAyKQogICAgb3V0W3BiKytdID0gKChiICYgMGIxMSkgPDwgNikgfCAoYyA8PCAxKSB8IChkID4+PiA0KQogICAgb3V0W3BiKytdID0gKChkICYgMGIxMTExKSA8PCA0KSB8IChlID4+PiAxKQogICAgb3V0W3BiKytdID0gKChlICYgMGIxKSA8PCA3KSB8IChmIDw8IDIpIHwgKGcgPj4+IDMpCiAgICBvdXRbcGIrK10gPSAoKGcgJiAwYjExMSkgPDwgNSkgfCBoCiAgfQoKICBpZiAociA9PT0gMCkgcmV0dXJuIG91dC5zdWJhcnJheSgwLCBwYikKCiAgY29uc3QgYSA9IHF1aW50ZXQocywgcHMrKykKICBjb25zdCBiID0gcXVpbnRldChzLCBwcysrKQoKICBvdXRbcGIrK10gPSAoYSA8PCAzKSB8IChiID4+PiAyKQoKICBpZiAociA8PSAyKSByZXR1cm4gb3V0LnN1YmFycmF5KDAsIHBiKQoKICBjb25zdCBjID0gcXVpbnRldChzLCBwcysrKQogIGNvbnN0IGQgPSBxdWludGV0KHMsIHBzKyspCgogIG91dFtwYisrXSA9ICgoYiAmIDBiMTEpIDw8IDYpIHwgKGMgPDwgMSkgfCAoZCA+Pj4gNCkKCiAgaWYgKHIgPD0gNCkgcmV0dXJuIG91dC5zdWJhcnJheSgwLCBwYikKCiAgY29uc3QgZSA9IHF1aW50ZXQocywgcHMrKykKCiAgb3V0W3BiKytdID0gKChkICYgMGIxMTExKSA8PCA0KSB8IChlID4+PiAxKQoKICBpZiAociA8PSA1KSByZXR1cm4gb3V0LnN1YmFycmF5KDAsIHBiKQoKICBjb25zdCBmID0gcXVpbnRldChzLCBwcysrKQogIGNvbnN0IGcgPSBxdWludGV0KHMsIHBzKyspCgogIG91dFtwYisrXSA9ICgoZSAmIDBiMSkgPDwgNykgfCAoZiA8PCAyKSB8IChnID4+PiAzKQoKICBpZiAociA8PSA3KSByZXR1cm4gb3V0LnN1YmFycmF5KDAsIHBiKQoKICBjb25zdCBoID0gcXVpbnRldChzLCBwcysrKQoKICBvdXRbcGIrK10gPSAoKGcgJiAwYjExMSkgPDwgNSkgfCBoCgogIHJldHVybiBvdXQuc3ViYXJyYXkoMCwgcGIpCn0KCmZ1bmN0aW9uIGVuY29kZSAoYnVmKSB7CiAgaWYgKHR5cGVvZiBidWYgPT09ICdzdHJpbmcnKSBidWYgPSBiNGEuZnJvbShidWYpCgogIGNvbnN0IG1heCA9IGJ1Zi5ieXRlTGVuZ3RoICogOAoKICBsZXQgcyA9ICcnCgogIGZvciAobGV0IHAgPSAwOyBwIDwgbWF4OyBwICs9IDUpIHsKICAgIGNvbnN0IGkgPSBwID4+PiAzCiAgICBjb25zdCBqID0gcCAmIDcKCiAgICBpZiAoaiA8PSAzKSB7CiAgICAgIHMgKz0gQUxQSEFCRVRbKGJ1ZltpXSA+Pj4gKDMgLSBqKSkgJiAwYjExMTExXQogICAgICBjb250aW51ZQogICAgfQoKICAgIGNvbnN0IG9mID0gaiAtIDMKICAgIGNvbnN0IGggPSAoYnVmW2ldIDw8IG9mKSAmIDBiMTExMTEKICAgIGNvbnN0IGwgPSAoaSA+PSBidWYuYnl0ZUxlbmd0aCA/IDAgOiBidWZbaSArIDFdKSA+Pj4gKDggLSBvZikKCiAgICBzICs9IEFMUEhBQkVUW2ggfCBsXQogIH0KCiAgcmV0dXJuIHMKfQoKZnVuY3Rpb24gcXVpbnRldCAocywgaSkgewogIGlmIChpID4gcy5sZW5ndGgpIHsKICAgIHJldHVybiAwCiAgfQoKICBjb25zdCB2ID0gcy5jaGFyQ29kZUF0KGkpCgogIGlmICh2IDwgTUlOIHx8IHYgPiBNQVgpIHsKICAgIHRocm93IEVycm9yKCdJbnZhbGlkIGNoYXJhY3RlciBpbiBiYXNlMzIgaW5wdXQ6ICInICsgc1tpXSArICciIGF0IHBvc2l0aW9uICcgKyBpKQogIH0KCiAgY29uc3QgYml0cyA9IFJFVkVSU0VbdiAtIE1JTl0KCiAgaWYgKGJpdHMgPT09IC0xKSB7CiAgICB0aHJvdyBFcnJvcignSW52YWxpZCBjaGFyYWN0ZXIgaW4gYmFzZTMyIGlucHV0OiAiJyArIHNbaV0gKyAnIiBhdCBwb3NpdGlvbiAnICsgaSkKICB9CgogIHJldHVybiBiaXRzCn0KewogICJuYW1lIjogInozMiIsCiAgInZlcnNpb24iOiAiMS4xLjAiLAogICJkZXNjcmlwdGlvbiI6ICJFbmNvZGUgJiBkZWNvZGUgei1iYXNlMzIiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS41LjMiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhc2UteCI6ICJeNC4wLjAiLAogICAgImJhc2UzMiI6ICIwLjAuNyIsCiAgICAiYnJpdHRsZSI6ICJeMy4xLjMiLAogICAgIm5hbm9iZW5jaCI6ICJeMy4wLjAiLAogICAgInJmYzQ2NDgiOiAiXjEuNS4yIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3ozMi5naXQiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIsCiAgICAiYmVuY2giOiAibm9kZSBiZW5jaG1hcmsuanMiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvejMyL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3ozMiIKfQp7CiAgInByaXZhdGUiOiB0cnVlLAogICJuYW1lIjogImxpc3RhbSIsCiAgImRlc2NyaXB0aW9uIjogIkEgbWluaW1hbGlzdGljIHAycCBsaXN0IGFwcCIsCiAgIm1haW4iOiAiZXhwby1yb3V0ZXIvZW50cnkiLAogICJzY3JpcHRzIjogewogICAgInN0YXJ0IjogImV4cG8gc3RhcnQiLAogICAgImFuZHJvaWQiOiAibnBtIHJ1biBidW5kbGU6YmFja2VuZDphbmRyb2lkICYmIGV4cG8gcnVuOmFuZHJvaWQiLAogICAgImFuZHJvaWQ6cmVsZWFzZSI6ICJjZCBhbmRyb2lkICYmIC4vZ3JhZGxldyBidW5kbGVSZWxlYXNlIiwKICAgICJpb3MiOiAibnBtIHJ1biBidW5kbGU6YmFja2VuZDppb3MgJiYgZXhwbyBydW46aW9zIC0tZGV2aWNlIiwKICAgICJidW5kbGU6YmFja2VuZDppb3MiOiAibnB4IGJhcmUtcGFjayAtLXRhcmdldCBpb3MgLS1saW5rZWQgYmFja2VuZC9iYWNrZW5kLm1qcyAtLWVuY29kaW5nIGJhc2U2NCAtLW91dCBhcHAvYXBwLmlvcy5idW5kbGUgJiYgbm9kZSBzY3JpcHRzL3dyYXAtYmFyZS1idW5kbGUubWpzIGFwcC9hcHAuaW9zLmJ1bmRsZSBhcHAvYXBwLmlvcy5idW5kbGUubWpzIiwKICAgICJidW5kbGU6YmFja2VuZDphbmRyb2lkIjogIm5weCBiYXJlLXBhY2sgLS10YXJnZXQgYW5kcm9pZCAtLWxpbmtlZCBiYWNrZW5kL2JhY2tlbmQubWpzIC0tZW5jb2RpbmcgYmFzZTY0IC0tb3V0IGFwcC9hc3NldHMvYmFja2VuZC5hbmRyb2lkLmJ1bmRsZSAmJiBub2RlIHNjcmlwdHMvd3JhcC1iYXJlLWJ1bmRsZS5tanMgYXBwL2Fzc2V0cy9iYWNrZW5kLmFuZHJvaWQuYnVuZGxlIGFwcC9hc3NldHMvYmFja2VuZC5hbmRyb2lkLmJ1bmRsZS5tanMiCiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgIkBpbnF1aXJlci9wcm9tcHRzIjogIl43LjguMSIsCiAgICAiQHJlYWN0LW5hdGl2ZS1jbGlwYm9hcmQvY2xpcGJvYXJkIjogIjEuMTYuMyIsCiAgICAiYXV0b2Jhc2UiOiAiXjcuMjAuMCIsCiAgICAiYXV0b3Bhc3MiOiAiXjIuMi4xIiwKICAgICJiNGEiOiAiXjEuNy4xIiwKICAgICJiYXJlLWNyeXB0byI6ICJeMS4xMi4wIiwKICAgICJiYXJlLWZzIjogIl40LjQuNCIsCiAgICAiYmFyZS1ycGMiOiAiXjAuMi4xMiIsCiAgICAiYmFzZTY0LWpzIjogIl4xLjUuMSIsCiAgICAiYmxpbmQtcGVlcmluZyI6ICJeMS4xMy4wIiwKICAgICJjb3Jlc3RvcmUiOiAiXjcuNS4wIiwKICAgICJleHBvIjogIn41NC4wLjMxIiwKICAgICJleHBvLWJ1aWxkLXByb3BlcnRpZXMiOiAiMS4wLjEwIiwKICAgICJleHBvLWNvbnN0YW50cyI6ICJ+MTguMC4xMyIsCiAgICAiZXhwby1maWxlLXN5c3RlbSI6ICJ+MTkuMC4yMSIsCiAgICAiZXhwby1saW5raW5nIjogIjguMC4xMSIsCiAgICAiZXhwby1yb3V0ZXIiOiAiNi4wLjIxIiwKICAgICJleHBvLXN5c3RlbS11aSI6ICI2LjAuOSIsCiAgICAiaHlwZXJjb3JlLWNyeXB0byI6ICJeMy42LjEiLAogICAgImh5cGVyZGIiOiAiXjQuMTkuMCIsCiAgICAiaHlwZXJkaXNwYXRjaCI6ICJeMS40LjQiLAogICAgImh5cGVyc2NoZW1hIjogIl4xLjE3LjAiLAogICAgImh5cGVyc3dhcm0iOiAiXjQuMTIuMSIsCiAgICAibHVjaWRlLXJlYWN0LW5hdGl2ZSI6ICJeMC41NTMuMCIsCiAgICAibWFrZS1kaXIiOiAiXjUuMS4wIiwKICAgICJwcm90b211eC13YWtldXAiOiAiXjIuNi4xIiwKICAgICJyZWFjdCI6ICIxOS4xLjAiLAogICAgInJlYWN0LWRvbSI6ICIxOS4xLjAiLAogICAgInJlYWN0LW5hdGl2ZSI6ICIwLjgxLjUiLAogICAgInJlYWN0LW5hdGl2ZS1iNGEiOiAiMC4wLjQiLAogICAgInJlYWN0LW5hdGl2ZS1iYXJlLWtpdCI6ICIwLjExLjUiLAogICAgInJlYWN0LW5hdGl2ZS1yZWFuaW1hdGVkIjogIn40LjEuMSIsCiAgICAicmVhY3QtbmF0aXZlLXNhZmUtYXJlYS1jb250ZXh0IjogIjUuNi4yIiwKICAgICJyZWFjdC1uYXRpdmUtd29ya2xldHMiOiAiMC41LjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgIkByZWFjdC1uYXRpdmUtY29tbXVuaXR5L2NsaSI6ICJsYXRlc3QiLAogICAgIkB0eXBlcy9iNGEiOiAiMS42LjUiLAogICAgIkB0eXBlcy9yZWFjdCI6ICIxOS4yLjciLAogICAgImJhYmVsLXBsdWdpbi1tb2R1bGUtcmVzb2x2ZXIiOiAiXjUuMC4yIiwKICAgICJiYXJlLXBhY2siOiAiMS41LjEiLAogICAgInByZXR0aWVyIjogIjMuNy40IiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIjIuMC4wIiwKICAgICJ0eXBlc2NyaXB0IjogIjUuOS4zIgogIH0KfQpleHBvcnQgY29uc3QgUlBDX1JFU0VUID0gMApleHBvcnQgY29uc3QgUlBDX01FU1NBR0UgPSAxCmV4cG9ydCBjb25zdCBSUENfQUREID0gMgpleHBvcnQgY29uc3QgUlBDX1VQREFURSA9IDMKZXhwb3J0IGNvbnN0IFJQQ19ERUxFVEUgPSA0CmV4cG9ydCBjb25zdCBSUENfR0VUX0tFWSA9IDUKZXhwb3J0IGNvbnN0IFNZTkNfTElTVCA9IDYKZXhwb3J0IGNvbnN0IFJQQ19KT0lOX0tFWSA9IDcKZXhwb3J0IGNvbnN0IFJQQ19BRERfRlJPTV9CQUNLRU5EID0gOApleHBvcnQgY29uc3QgUlBDX1VQREFURV9GUk9NX0JBQ0tFTkQgPSA5CmV4cG9ydCBjb25zdCBSUENfREVMRVRFX0ZST01fQkFDS0VORCA9IDEwCmV4cG9ydCBjb25zdCBSUENfUkVRVUVTVF9TWU5DID0gMTEK"];
export default chunks.join('');
